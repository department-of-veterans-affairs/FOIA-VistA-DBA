Released ECX*3*107 SEQ #95
Extracted from mail message
**KIDS**:ECX*3.0*107^

**INSTALL NAME**
ECX*3.0*107
"BLD",7155,0)
ECX*3.0*107^DSS EXTRACTS^0^3070502^y
"BLD",7155,4,0)
^9.64PA^727.832^11
"BLD",7155,4,727.802,0)
727.802
"BLD",7155,4,727.802,2,0)
^9.641^727.802^1
"BLD",7155,4,727.802,2,727.802,0)
ADMISSION EXTRACT  (File-top level)
"BLD",7155,4,727.802,2,727.802,1,0)
^9.6411^28^1
"BLD",7155,4,727.802,2,727.802,1,28,0)
TREATING SPECIALTY
"BLD",7155,4,727.802,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.802,224)
 
"BLD",7155,4,727.805,0)
727.805
"BLD",7155,4,727.805,2,0)
^9.641^727.805^1
"BLD",7155,4,727.805,2,727.805,0)
NURSING EXTRACT  (File-top level)
"BLD",7155,4,727.805,2,727.805,1,0)
^9.6411^15^1
"BLD",7155,4,727.805,2,727.805,1,15,0)
TREATING SPECIALTY
"BLD",7155,4,727.805,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.805,224)
 
"BLD",7155,4,727.808,0)
727.808
"BLD",7155,4,727.808,2,0)
^9.641^727.808^1
"BLD",7155,4,727.808,2,727.808,0)
PHYSICAL MOVEMENT EXTRACT  (File-top level)
"BLD",7155,4,727.808,2,727.808,1,0)
^9.6411^15^1
"BLD",7155,4,727.808,2,727.808,1,15,0)
TREATING SPECIALTY
"BLD",7155,4,727.808,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.808,224)
 
"BLD",7155,4,727.809,0)
727.809
"BLD",7155,4,727.809,2,0)
^9.641^727.809^1
"BLD",7155,4,727.809,2,727.809,0)
UNIT DOSE LOCAL EXTRACT  (File-top level)
"BLD",7155,4,727.809,2,727.809,1,0)
^9.6411^15^1
"BLD",7155,4,727.809,2,727.809,1,15,0)
TREATING SPECIALTY
"BLD",7155,4,727.809,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.809,224)
 
"BLD",7155,4,727.81,0)
727.81
"BLD",7155,4,727.81,2,0)
^9.641^727.81^1
"BLD",7155,4,727.81,2,727.81,0)
PRESCRIPTION EXTRACT  (File-top level)
"BLD",7155,4,727.81,2,727.81,1,0)
^9.6411^20^1
"BLD",7155,4,727.81,2,727.81,1,20,0)
TREATING SPECIALTY
"BLD",7155,4,727.81,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.81,224)
 
"BLD",7155,4,727.813,0)
727.813
"BLD",7155,4,727.813,2,0)
^9.641^727.813^1
"BLD",7155,4,727.813,2,727.813,0)
LABORATORY EXTRACT  (File-top level)
"BLD",7155,4,727.813,2,727.813,1,0)
^9.6411^13^1
"BLD",7155,4,727.813,2,727.813,1,13,0)
TREATING SPECIALTY
"BLD",7155,4,727.813,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.813,224)
 
"BLD",7155,4,727.817,0)
727.817
"BLD",7155,4,727.817,2,0)
^9.641^727.817^1
"BLD",7155,4,727.817,2,727.817,0)
TREATING SPECIALTY CHANGE EXTRACT  (File-top level)
"BLD",7155,4,727.817,2,727.817,1,0)
^9.6411^15^2
"BLD",7155,4,727.817,2,727.817,1,14,0)
NEW TREATING SPECIALTY
"BLD",7155,4,727.817,2,727.817,1,15,0)
LOSING TREATING SPECIALTY
"BLD",7155,4,727.817,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.817,224)
 
"BLD",7155,4,727.819,0)
727.819
"BLD",7155,4,727.819,2,0)
^9.641^727.819^1
"BLD",7155,4,727.819,2,727.819,0)
IV DETAIL EXTRACT  (File-top level)
"BLD",7155,4,727.819,2,727.819,1,0)
^9.6411^15^1
"BLD",7155,4,727.819,2,727.819,1,15,0)
TREATING SPECIALTY
"BLD",7155,4,727.819,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.819,224)
 
"BLD",7155,4,727.824,0)
727.824
"BLD",7155,4,727.824,2,0)
^9.641^727.824^1
"BLD",7155,4,727.824,2,727.824,0)
LAB RESULTS EXTRACT  (File-top level)
"BLD",7155,4,727.824,2,727.824,1,0)
^9.6411^18^1
"BLD",7155,4,727.824,2,727.824,1,18,0)
TREATING SPECIALTY
"BLD",7155,4,727.824,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.824,224)
 
"BLD",7155,4,727.827,0)
727.827
"BLD",7155,4,727.827,2,0)
^9.641^727.827^1
"BLD",7155,4,727.827,2,727.827,0)
CLINIC EXTRACT  (File-top level)
"BLD",7155,4,727.827,2,727.827,1,0)
^9.6411^12^1
"BLD",7155,4,727.827,2,727.827,1,12,0)
TREATING SPECIALITY
"BLD",7155,4,727.827,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.827,224)
 
"BLD",7155,4,727.832,0)
727.832
"BLD",7155,4,727.832,2,0)
^9.641^727.832^1
"BLD",7155,4,727.832,2,727.832,0)
NUTRITION EXTRACT  (File-top level)
"BLD",7155,4,727.832,2,727.832,1,0)
^9.6411^10^1
"BLD",7155,4,727.832,2,727.832,1,10,0)
TREATING SPECIALTY
"BLD",7155,4,727.832,222)
y^y^p^^^^n^^n
"BLD",7155,4,727.832,224)
 
"BLD",7155,4,"APDD",727.802,727.802)
 
"BLD",7155,4,"APDD",727.802,727.802,28)
 
"BLD",7155,4,"APDD",727.805,727.805)
 
"BLD",7155,4,"APDD",727.805,727.805,15)
 
"BLD",7155,4,"APDD",727.808,727.808)
 
"BLD",7155,4,"APDD",727.808,727.808,15)
 
"BLD",7155,4,"APDD",727.809,727.809)
 
"BLD",7155,4,"APDD",727.809,727.809,15)
 
"BLD",7155,4,"APDD",727.81,727.81)
 
"BLD",7155,4,"APDD",727.81,727.81,20)
 
"BLD",7155,4,"APDD",727.813,727.813)
 
"BLD",7155,4,"APDD",727.813,727.813,13)
 
"BLD",7155,4,"APDD",727.817,727.817)
 
"BLD",7155,4,"APDD",727.817,727.817,14)
 
"BLD",7155,4,"APDD",727.817,727.817,15)
 
"BLD",7155,4,"APDD",727.819,727.819)
 
"BLD",7155,4,"APDD",727.819,727.819,15)
 
"BLD",7155,4,"APDD",727.824,727.824)
 
"BLD",7155,4,"APDD",727.824,727.824,18)
 
"BLD",7155,4,"APDD",727.827,727.827)
 
"BLD",7155,4,"APDD",727.827,727.827,12)
 
"BLD",7155,4,"APDD",727.832,727.832)
 
"BLD",7155,4,"APDD",727.832,727.832,10)
 
"BLD",7155,4,"B",727.802,727.802)
 
"BLD",7155,4,"B",727.805,727.805)
 
"BLD",7155,4,"B",727.808,727.808)
 
"BLD",7155,4,"B",727.809,727.809)
 
"BLD",7155,4,"B",727.81,727.81)
 
"BLD",7155,4,"B",727.813,727.813)
 
"BLD",7155,4,"B",727.817,727.817)
 
"BLD",7155,4,"B",727.819,727.819)
 
"BLD",7155,4,"B",727.824,727.824)
 
"BLD",7155,4,"B",727.827,727.827)
 
"BLD",7155,4,"B",727.832,727.832)
 
"BLD",7155,6.3)
9
"BLD",7155,"KRN",0)
^9.67PA^8989.52^19
"BLD",7155,"KRN",.4,0)
.4
"BLD",7155,"KRN",.401,0)
.401
"BLD",7155,"KRN",.402,0)
.402
"BLD",7155,"KRN",.403,0)
.403
"BLD",7155,"KRN",.5,0)
.5
"BLD",7155,"KRN",.84,0)
.84
"BLD",7155,"KRN",3.6,0)
3.6
"BLD",7155,"KRN",3.8,0)
3.8
"BLD",7155,"KRN",9.2,0)
9.2
"BLD",7155,"KRN",9.8,0)
9.8
"BLD",7155,"KRN",9.8,"NM",0)
^9.68A^11^11
"BLD",7155,"KRN",9.8,"NM",1,0)
ECXTRT^^0^B58970453
"BLD",7155,"KRN",9.8,"NM",2,0)
ECXATRT^^0^B50969112
"BLD",7155,"KRN",9.8,"NM",3,0)
ECXADM^^0^B36453744
"BLD",7155,"KRN",9.8,"NM",4,0)
ECXNURS^^0^B43358486
"BLD",7155,"KRN",9.8,"NM",5,0)
ECXUD^^0^B48739438
"BLD",7155,"KRN",9.8,"NM",6,0)
ECXOPRX1^^0^B7720497
"BLD",7155,"KRN",9.8,"NM",7,0)
ECXLABN^^0^B28026471
"BLD",7155,"KRN",9.8,"NM",8,0)
ECXPIVDN^^0^B64275296
"BLD",7155,"KRN",9.8,"NM",9,0)
ECXLABR^^0^B21149464
"BLD",7155,"KRN",9.8,"NM",10,0)
ECXSCXN^^0^B55157995
"BLD",7155,"KRN",9.8,"NM",11,0)
ECXNUT^^0^B28055134
"BLD",7155,"KRN",9.8,"NM","B","ECXADM",3)
 
"BLD",7155,"KRN",9.8,"NM","B","ECXATRT",2)
 
"BLD",7155,"KRN",9.8,"NM","B","ECXLABN",7)
 
"BLD",7155,"KRN",9.8,"NM","B","ECXLABR",9)
 
"BLD",7155,"KRN",9.8,"NM","B","ECXNURS",4)
 
"BLD",7155,"KRN",9.8,"NM","B","ECXNUT",11)
 
"BLD",7155,"KRN",9.8,"NM","B","ECXOPRX1",6)
 
"BLD",7155,"KRN",9.8,"NM","B","ECXPIVDN",8)
 
"BLD",7155,"KRN",9.8,"NM","B","ECXSCXN",10)
 
"BLD",7155,"KRN",9.8,"NM","B","ECXTRT",1)
 
"BLD",7155,"KRN",9.8,"NM","B","ECXUD",5)
 
"BLD",7155,"KRN",19,0)
19
"BLD",7155,"KRN",19,"NM",0)
^9.68A^^
"BLD",7155,"KRN",19.1,0)
19.1
"BLD",7155,"KRN",101,0)
101
"BLD",7155,"KRN",409.61,0)
409.61
"BLD",7155,"KRN",771,0)
771
"BLD",7155,"KRN",870,0)
870
"BLD",7155,"KRN",8989.51,0)
8989.51
"BLD",7155,"KRN",8989.52,0)
8989.52
"BLD",7155,"KRN",8994,0)
8994
"BLD",7155,"KRN","B",.4,.4)
 
"BLD",7155,"KRN","B",.401,.401)
 
"BLD",7155,"KRN","B",.402,.402)
 
"BLD",7155,"KRN","B",.403,.403)
 
"BLD",7155,"KRN","B",.5,.5)
 
"BLD",7155,"KRN","B",.84,.84)
 
"BLD",7155,"KRN","B",3.6,3.6)
 
"BLD",7155,"KRN","B",3.8,3.8)
 
"BLD",7155,"KRN","B",9.2,9.2)
 
"BLD",7155,"KRN","B",9.8,9.8)
 
"BLD",7155,"KRN","B",19,19)
 
"BLD",7155,"KRN","B",19.1,19.1)
 
"BLD",7155,"KRN","B",101,101)
 
"BLD",7155,"KRN","B",409.61,409.61)
 
"BLD",7155,"KRN","B",771,771)
 
"BLD",7155,"KRN","B",870,870)
 
"BLD",7155,"KRN","B",8989.51,8989.51)
 
"BLD",7155,"KRN","B",8989.52,8989.52)
 
"BLD",7155,"KRN","B",8994,8994)
 
"BLD",7155,"QUES",0)
^9.62^^
"BLD",7155,"REQB",0)
^9.611^3^3
"BLD",7155,"REQB",1,0)
ECX*3.0*92^1
"BLD",7155,"REQB",2,0)
ECX*3.0*8^1
"BLD",7155,"REQB",3,0)
DG*5.3*729^1
"BLD",7155,"REQB","B","DG*5.3*729",3)
 
"BLD",7155,"REQB","B","ECX*3.0*8",2)
 
"BLD",7155,"REQB","B","ECX*3.0*92",1)
 
"FIA",727.802)
ADMISSION EXTRACT
"FIA",727.802,0)
^ECX(727.802,
"FIA",727.802,0,0)
727.802
"FIA",727.802,0,1)
y^y^p^^^^n^^n
"FIA",727.802,0,10)
 
"FIA",727.802,0,11)
 
"FIA",727.802,0,"RLRO")
 
"FIA",727.802,0,"VR")
3.0^ECX
"FIA",727.802,727.802)
1
"FIA",727.802,727.802,28)
 
"FIA",727.805)
NURSING EXTRACT
"FIA",727.805,0)
^ECX(727.805,
"FIA",727.805,0,0)
727.805
"FIA",727.805,0,1)
y^y^p^^^^n^^n
"FIA",727.805,0,10)
 
"FIA",727.805,0,11)
 
"FIA",727.805,0,"RLRO")
 
"FIA",727.805,0,"VR")
3.0^ECX
"FIA",727.805,727.805)
1
"FIA",727.805,727.805,15)
 
"FIA",727.808)
PHYSICAL MOVEMENT EXTRACT
"FIA",727.808,0)
^ECX(727.808,
"FIA",727.808,0,0)
727.808
"FIA",727.808,0,1)
y^y^p^^^^n^^n
"FIA",727.808,0,10)
 
"FIA",727.808,0,11)
 
"FIA",727.808,0,"RLRO")
 
"FIA",727.808,0,"VR")
3.0^ECX
"FIA",727.808,727.808)
1
"FIA",727.808,727.808,15)
 
"FIA",727.809)
UNIT DOSE LOCAL EXTRACT
"FIA",727.809,0)
^ECX(727.809,
"FIA",727.809,0,0)
727.809
"FIA",727.809,0,1)
y^y^p^^^^n^^n
"FIA",727.809,0,10)
 
"FIA",727.809,0,11)
 
"FIA",727.809,0,"RLRO")
 
"FIA",727.809,0,"VR")
3.0^ECX
"FIA",727.809,727.809)
1
"FIA",727.809,727.809,15)
 
"FIA",727.81)
PRESCRIPTION EXTRACT
"FIA",727.81,0)
^ECX(727.81,
"FIA",727.81,0,0)
727.81
"FIA",727.81,0,1)
y^y^p^^^^n^^n
"FIA",727.81,0,10)
 
"FIA",727.81,0,11)
 
"FIA",727.81,0,"RLRO")
 
"FIA",727.81,0,"VR")
3.0^ECX
"FIA",727.81,727.81)
1
"FIA",727.81,727.81,20)
 
"FIA",727.813)
LABORATORY EXTRACT
"FIA",727.813,0)
^ECX(727.813,
"FIA",727.813,0,0)
727.813
"FIA",727.813,0,1)
y^y^p^^^^n^^n
"FIA",727.813,0,10)
 
"FIA",727.813,0,11)
 
"FIA",727.813,0,"RLRO")
 
"FIA",727.813,0,"VR")
3.0^ECX
"FIA",727.813,727.813)
1
"FIA",727.813,727.813,13)
 
"FIA",727.817)
TREATING SPECIALTY CHANGE EXTRACT
"FIA",727.817,0)
^ECX(727.817,
"FIA",727.817,0,0)
727.817
"FIA",727.817,0,1)
y^y^p^^^^n^^n
"FIA",727.817,0,10)
 
"FIA",727.817,0,11)
 
"FIA",727.817,0,"RLRO")
 
"FIA",727.817,0,"VR")
3.0^ECX
"FIA",727.817,727.817)
1
"FIA",727.817,727.817,14)
 
"FIA",727.817,727.817,15)
 
"FIA",727.819)
IV DETAIL EXTRACT
"FIA",727.819,0)
^ECX(727.819,
"FIA",727.819,0,0)
727.819
"FIA",727.819,0,1)
y^y^p^^^^n^^n
"FIA",727.819,0,10)
 
"FIA",727.819,0,11)
 
"FIA",727.819,0,"RLRO")
 
"FIA",727.819,0,"VR")
3.0^ECX
"FIA",727.819,727.819)
1
"FIA",727.819,727.819,15)
 
"FIA",727.824)
LAB RESULTS EXTRACT
"FIA",727.824,0)
^ECX(727.824,
"FIA",727.824,0,0)
727.824
"FIA",727.824,0,1)
y^y^p^^^^n^^n
"FIA",727.824,0,10)
 
"FIA",727.824,0,11)
 
"FIA",727.824,0,"RLRO")
 
"FIA",727.824,0,"VR")
3.0^ECX
"FIA",727.824,727.824)
1
"FIA",727.824,727.824,18)
 
"FIA",727.827)
CLINIC EXTRACT
"FIA",727.827,0)
^ECX(727.827,
"FIA",727.827,0,0)
727.827
"FIA",727.827,0,1)
y^y^p^^^^n^^n
"FIA",727.827,0,10)
 
"FIA",727.827,0,11)
 
"FIA",727.827,0,"RLRO")
 
"FIA",727.827,0,"VR")
3.0^ECX
"FIA",727.827,727.827)
1
"FIA",727.827,727.827,12)
 
"FIA",727.832)
NUTRITION EXTRACT
"FIA",727.832,0)
^ECX(727.832,
"FIA",727.832,0,0)
727.832
"FIA",727.832,0,1)
y^y^p^^^^n^^n
"FIA",727.832,0,10)
 
"FIA",727.832,0,11)
 
"FIA",727.832,0,"RLRO")
 
"FIA",727.832,0,"VR")
3.0^ECX
"FIA",727.832,727.832)
1
"FIA",727.832,727.832,10)
 
"MBREQ")
0
"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^3010618^2980112^11714
"PKG",513,22,1,"PAH",1,0)
107^3070502
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
11
"RTN","ECXADM")
0^3^B36453744^B34859559
"RTN","ECXADM",1,0)
ECXADM ;ALB/JAP,BIR/DMA,CML,PTD-Admissions Extract ; 04/12/2007
"RTN","ECXADM",2,0)
 ;;3.0;DSS EXTRACTS;**1,4,11,8,13,24,33,39,46,71,84,92,107**;Dec 22, 1997;Build 9
"RTN","ECXADM",3,0)
BEG ;entry point from option
"RTN","ECXADM",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXADM",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXADM",6,0)
 Q
"RTN","ECXADM",7,0)
 ;
"RTN","ECXADM",8,0)
START ; start package specific extract
"RTN","ECXADM",9,0)
 S QFLG=0
"RTN","ECXADM",10,0)
 S ECED=ECED+.3,ECD=ECSD1
"RTN","ECXADM",11,0)
 F  S ECD=$O(^DGPM("ATT1",ECD)),ECDA=0 Q:('ECD)!(ECD>ECED)  D
"RTN","ECXADM",12,0)
 .F  S ECDA=$O(^DGPM("ATT1",ECD,ECDA)) Q:ECDA=""  D
"RTN","ECXADM",13,0)
 ..I $D(^DGPM(ECDA,0)) D
"RTN","ECXADM",14,0)
 ...S EC=^DGPM(ECDA,0),ECXDFN=$P(EC,U,3) D GET
"RTN","ECXADM",15,0)
 Q
"RTN","ECXADM",16,0)
 ;
"RTN","ECXADM",17,0)
GET ;gather extract data
"RTN","ECXADM",18,0)
 N ADM,W,X,ECXNPRFI,ECXATTPC,ECXPRVPC,ECXEST
"RTN","ECXADM",19,0)
 ;patient demographics
"RTN","ECXADM",20,0)
 S ECXERR=0 D PAT(ECXDFN,ECD,.ECXERR)
"RTN","ECXADM",21,0)
 Q:ECXERR
"RTN","ECXADM",22,0)
 I $$ENROLLM^ECXUTL2(ECXDFN)
"RTN","ECXADM",23,0)
 S ECXFAC=$P($G(^DIC(42,+$P(EC,U,6),0)),U,11)
"RTN","ECXADM",24,0)
 S ECXPDIV=$$GETDIV^ECXDEPT(ECXFAC)  ;Get production division
"RTN","ECXADM",25,0)
 ;admission data
"RTN","ECXADM",26,0)
 S ELGA=$P($G(^DIC(8,+$P(EC,U,20),0)),U,9)
"RTN","ECXADM",27,0)
 I ELGA S ELGA=$$ELIG^ECXUTL3(ELGA,ECXSVC)
"RTN","ECXADM",28,0)
 S (ECDRG,ECDIA,ECXSADM)="",ECPTF=+$P(EC,U,16) I ECPTF,$D(^DGPT(ECPTF,"M")) D PTF
"RTN","ECXADM",29,0)
 ;get encounter classification
"RTN","ECXADM",30,0)
 S (ECXAO,ECXECE,ECXIR,ECXMIL,ECXHNC)="",ECXVISIT=$P(EC,U,27)
"RTN","ECXADM",31,0)
 I ECXVISIT'="" D
"RTN","ECXADM",32,0)
 .D VISIT^ECXSCX1(ECXDFN,ECXVISIT,.ECXVIST,.ECXERR) I ECXERR K ECXERR Q
"RTN","ECXADM",33,0)
 .S ECXAO=$G(ECXVIST("AO")),ECXIR=$G(ECXVIST("IR"))
"RTN","ECXADM",34,0)
 .S ECXMIL=$G(ECXVIST("MST")),ECXHNC=$G(ECXVIST("HNC"))
"RTN","ECXADM",35,0)
 .S ECXECE=$G(ECXVIST("PGE"))
"RTN","ECXADM",36,0)
 ;use movement record date & time
"RTN","ECXADM",37,0)
 S ADM=$$INP^ECXUTL2(ECXDFN,ECD)
"RTN","ECXADM",38,0)
 S ECXA=$P(ADM,U),ECXMN=$P(ADM,U,2),ECXSPC=$P(ADM,U,3)
"RTN","ECXADM",39,0)
 S (ECXADMDT,ECXDATE)=$P(ADM,U,4)
"RTN","ECXADM",40,0)
 ;if movement# doesn't match cross-ref ien, then quit
"RTN","ECXADM",41,0)
 Q:ECXMN'=ECDA
"RTN","ECXADM",42,0)
 S ECTM=$$ECXTIME^ECXUTL(ECXDATE)
"RTN","ECXADM",43,0)
 S ECXDATE=$$ECXDATE^ECXUTL(ECXDATE,ECXYM)
"RTN","ECXADM",44,0)
 S W=$P(ADM,U,9)
"RTN","ECXADM",45,0)
 S ECXWRD=$P(W,";",1),ECXFAC=$P(W,";",2),ECXDSSD=$P(W,";",3)
"RTN","ECXADM",46,0)
 S ECXPRV=$P(ADM,U,7),ECXPRNPI="",ECXATT=$P(ADM,U,8),ECXATNPI=""
"RTN","ECXADM",47,0)
 S ECXDOM=$P(ADM,U,10),ECXATTPC=$P(ADM,U,12),ECXPRVPC=$P(ADM,U,11)
"RTN","ECXADM",48,0)
 ;
"RTN","ECXADM",49,0)
 ;- Observation patient indicator (YES/NO)
"RTN","ECXADM",50,0)
 S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXSPC)
"RTN","ECXADM",51,0)
 ;
"RTN","ECXADM",52,0)
 ;- Patient Type
"RTN","ECXADM",53,0)
 S ECXPTYPE=$$TYPE^ECXUTL5(ECXDFN)
"RTN","ECXADM",54,0)
 ;
"RTN","ECXADM",55,0)
 ;- If null encounter number, don't file record
"RTN","ECXADM",56,0)
 S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,,ECXSPC,ECXOBS,ECHEAD,,)
"RTN","ECXADM",57,0)
 D:ECXENC'="" FILE
"RTN","ECXADM",58,0)
 Q
"RTN","ECXADM",59,0)
 ;
"RTN","ECXADM",60,0)
PAT(ECXDFN,ECXDATE,ECXERR) ;get patient demographic data
"RTN","ECXADM",61,0)
 N OK,X
"RTN","ECXADM",62,0)
 K ECXPAT
"RTN","ECXADM",63,0)
 S ECXDATE=$P(ECXDATE,".")
"RTN","ECXADM",64,0)
 S OK=$$PAT^ECXUTL3(ECXDFN,ECXDATE,"1;2;3;4;5",.ECXPAT)
"RTN","ECXADM",65,0)
 I 'OK S ECXERR=1 K ECXPAT Q
"RTN","ECXADM",66,0)
 S ECXSSN=ECXPAT("SSN")
"RTN","ECXADM",67,0)
 S ECXPNM=ECXPAT("NAME")
"RTN","ECXADM",68,0)
 S ECXMPI=ECXPAT("MPI")
"RTN","ECXADM",69,0)
 S ECXSEX=ECXPAT("SEX")
"RTN","ECXADM",70,0)
 S ECXDOB=ECXPAT("DOB")
"RTN","ECXADM",71,0)
 S ECXELIG=ECXPAT("ELIG")
"RTN","ECXADM",72,0)
 S ECXVET=ECXPAT("VET")
"RTN","ECXADM",73,0)
 S ECXVNS=ECXPAT("VIETNAM")
"RTN","ECXADM",74,0)
 S ECXPOS=ECXPAT("POS")
"RTN","ECXADM",75,0)
 S ECXMNS=ECXPAT("MEANS")
"RTN","ECXADM",76,0)
 S ECXRACE=ECXPAT("RACE")
"RTN","ECXADM",77,0)
 S ECXRELG=ECXPAT("RELIGION")
"RTN","ECXADM",78,0)
 S ECXEMP=ECXPAT("EMPLOY")
"RTN","ECXADM",79,0)
 S ECXMAR=ECXPAT("MARITAL")
"RTN","ECXADM",80,0)
 S ECXPST=ECXPAT("POW STAT")
"RTN","ECXADM",81,0)
 S ECXPLOC=ECXPAT("POW LOC")
"RTN","ECXADM",82,0)
 S ECXRST=ECXPAT("IR STAT")
"RTN","ECXADM",83,0)
 S ECXAST=ECXPAT("AO STAT")
"RTN","ECXADM",84,0)
 S ECXMST=ECXPAT("MST STAT")
"RTN","ECXADM",85,0)
 S ECXSTATE=ECXPAT("STATE")
"RTN","ECXADM",86,0)
 S ECXCNTY=ECXPAT("COUNTY")
"RTN","ECXADM",87,0)
 S ECXZIP=ECXPAT("ZIP")
"RTN","ECXADM",88,0)
 S ECXENRL=ECXPAT("ENROLL LOC")
"RTN","ECXADM",89,0)
 S ECXSVC=ECXPAT("SC%")
"RTN","ECXADM",90,0)
 S ECXPHI=ECXPAT("PHI")
"RTN","ECXADM",91,0)
 S ECXHI=+$$INSUR^IBBAPI(ECXDFN,ECXDATE)
"RTN","ECXADM",92,0)
 S ECXEST=ECXPAT("EC STAT")
"RTN","ECXADM",93,0)
 ;
"RTN","ECXADM",94,0)
 ;- Agent Orange location
"RTN","ECXADM",95,0)
 S ECXAOL=ECXPAT("AOL")
"RTN","ECXADM",96,0)
 ;
"RTN","ECXADM",97,0)
 ; - Head and Neck Cancer Indicator
"RTN","ECXADM",98,0)
 S ECXHNCI=$$HNCI^ECXUTL4(ECXDFN)
"RTN","ECXADM",99,0)
 ; - Race and Ethnicity
"RTN","ECXADM",100,0)
 S ECXETH=ECXPAT("ETHNIC")
"RTN","ECXADM",101,0)
 S ECXRC1=ECXPAT("RACE1")
"RTN","ECXADM",102,0)
 ;
"RTN","ECXADM",103,0)
 ;get primary care data
"RTN","ECXADM",104,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,ECXDATE)
"RTN","ECXADM",105,0)
 S ECPTTM=$P(X,U),ECPTPR=$P(X,U,2),ECCLAS=$P(X,U,3),ECPTNPI=$P(X,U,4)
"RTN","ECXADM",106,0)
 S ECASPR=$P(X,U,5),ECCLAS2=$P(X,U,6),ECASNPI=$P(X,U,7)
"RTN","ECXADM",107,0)
 ;get combat veteran data
"RTN","ECXADM",108,0)
 I $$CVEDT^ECXUTL5(ECXDFN,ECD)
"RTN","ECXADM",109,0)
 ;get national patient record flag if exist
"RTN","ECXADM",110,0)
 D NPRF^ECXUTL5
"RTN","ECXADM",111,0)
 ;get emergency response indicator (FEMA)
"RTN","ECXADM",112,0)
 S ECXERI=ECXPAT("ERI")
"RTN","ECXADM",113,0)
 Q
"RTN","ECXADM",114,0)
 ;
"RTN","ECXADM",115,0)
PTF ; get admitting DRG, diagnosis, source of admission from PTF
"RTN","ECXADM",116,0)
 ;use number for DRG and .01 for diagnosis
"RTN","ECXADM",117,0)
 N EC,EC1,ECX
"RTN","ECXADM",118,0)
 S EC=1 I $D(^DGPT(ECPTF,"M",2,0)) S EC=2
"RTN","ECXADM",119,0)
 S EC1=+$P(^DGPT(ECPTF,"M",EC,0),U,5)
"RTN","ECXADM",120,0)
 S ECDRG=$P($G(^DGPT(ECPTF,"M",EC,"P")),U)
"RTN","ECXADM",121,0)
 S ECDIA=$P($G(^ICD9(EC1,0)),U)
"RTN","ECXADM",122,0)
 S ECX=+$P($G(^DGPT(ECPTF,101)),U),ECXSADM=$P($G(^DIC(45.1,ECX,0)),U,11)
"RTN","ECXADM",123,0)
 Q
"RTN","ECXADM",124,0)
 ;
"RTN","ECXADM",125,0)
FILE ;file the extract record
"RTN","ECXADM",126,0)
 ;node0
"RTN","ECXADM",127,0)
 ;facility^dfn^ssn^name^in/out^day^primary care team^sex^dob^
"RTN","ECXADM",128,0)
 ;religion^employment status^health ins^state^county^zip^
"RTN","ECXADM",129,0)
 ;eligibility^vet^vietnam^agent orange^radiation^pow^
"RTN","ECXADM",130,0)
 ;period of service^means test^marital status^
"RTN","ECXADM",131,0)
 ;ward^treating specialty^attending physician^mov #^DRG^diagnosis^
"RTN","ECXADM",132,0)
 ;time^primary care provider^race^primary ward provider
"RTN","ECXADM",133,0)
 ;node1
"RTN","ECXADM",134,0)
 ;mpi^dss dept^attending npi^pc provider npi^ward provider npi^
"RTN","ECXADM",135,0)
 ;admission elig^mst status^^sharing payor^
"RTN","ECXADM",136,0)
 ;sharing insurance^enrollment location^
"RTN","ECXADM",137,0)
 ;pc prov person class^assoc pc provider^assoc pc prov person class^
"RTN","ECXADM",138,0)
 ;assoc pc prov npi^dom^enrollment cat^enrollment stat^enrollment
"RTN","ECXADM",139,0)
 ;priority^purple heart ind.^obs pat ind^encounter num^agent orange
"RTN","ECXADM",140,0)
 ;loc^production div^pow loc^source of admission^head & neck canc. ind
"RTN","ECXADM",141,0)
 ;^ethnicity^race1^enrollment priority_sub group^user enrollee^patient
"RTN","ECXADM",142,0)
 ;type^combat vet elig^combat vet elig end date^enc cv eligible^
"RTN","ECXADM",143,0)
 ;national patient record flag ECXNPRFI^att phy person class ECXATTPC
"RTN","ECXADM",144,0)
 ;^primary ward provider person class ECXPRVPC^environ contamin ECXEST
"RTN","ECXADM",145,0)
 ;^emergency response indicator(FEMA) ECXERI^agent orange indic ECXAO
"RTN","ECXADM",146,0)
 ;^environ contam ECXECE^encoun head/neck ECXHNC^encoun MST ECXMIL^rad
"RTN","ECXADM",147,0)
 ;encoun ECXIR
"RTN","ECXADM",148,0)
 ;
"RTN","ECXADM",149,0)
 ;Convert specialty to PTF Code
"RTN","ECXADM",150,0)
 ;
"RTN","ECXADM",151,0)
 N ECXDATA
"RTN","ECXADM",152,0)
 S ECXDATA=$$TSDATA^DGACT(42.4,+ECXSPC,.ECXDATA)
"RTN","ECXADM",153,0)
 S ECXSPC=$G(ECXDATA(7))
"RTN","ECXADM",154,0)
 ;
"RTN","ECXADM",155,0)
 N DA,DIK
"RTN","ECXADM",156,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXADM",157,0)
 S ECODE=EC7_U_EC23_U_ECXFAC_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U_ECXDATE_U
"RTN","ECXADM",158,0)
 S ECODE=ECODE_ECPTTM_U_ECXSEX_U_ECXDOB_U_ECXRELG_U
"RTN","ECXADM",159,0)
 S ECODE=ECODE_ECXEMP_U_ECXHI_U_ECXSTATE_U_ECXCNTY_U_ECXZIP_U
"RTN","ECXADM",160,0)
 S ECODE=ECODE_ECXELIG_U_ECXVET_U_ECXVNS_U_ECXAST_U_ECXRST_U_ECXPST_U
"RTN","ECXADM",161,0)
 S ECODE=ECODE_ECXPOS_U_ECXMNS_U_ECXMAR_U
"RTN","ECXADM",162,0)
 S ECODE=ECODE_ECXWRD_U_ECXSPC_U_ECXATT_U_ECDA_U_ECDRG_U_ECDIA_U
"RTN","ECXADM",163,0)
 S ECODE=ECODE_ECTM_U_ECPTPR_U_ECXRACE_U_ECXPRV_U
"RTN","ECXADM",164,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECXATNPI_U_ECPTNPI_U_ECXPRNPI_U_ELGA_U
"RTN","ECXADM",165,0)
 S ECODE1=ECODE1_ECXMST_U_U_U_U_ECXENRL_U_ECCLAS_U
"RTN","ECXADM",166,0)
 S ECODE1=ECODE1_ECASPR_U_ECCLAS2_U_ECASNPI_U_ECXDOM_U_ECXCAT_U
"RTN","ECXADM",167,0)
 S ECODE1=ECODE1_ECXSTAT_U_$S(ECXLOGIC<2005:ECXPRIOR,1:"")_U_ECXPHI_U_ECXOBS_U_ECXENC_U_ECXAOL_U
"RTN","ECXADM",168,0)
 S ECODE1=ECODE1_ECXPDIV_U_ECXPLOC_U_ECXSADM_U_ECXHNCI_U_ECXETH_U
"RTN","ECXADM",169,0)
 S ECODE1=ECODE1_ECXRC1
"RTN","ECXADM",170,0)
 I ECXLOGIC>2004 S ECODE1=ECODE1_U_ECXPRIOR_ECXSBGRP_U_ECXUESTA_U_ECXPTYPE_U_ECXCVE_U_ECXCVEDT_U_ECXCVENC_U_ECXNPRFI
"RTN","ECXADM",171,0)
 I ECXLOGIC>2005 S ECODE1=ECODE1_U_ECXATTPC_U_ECXPRVPC_U_ECXEST
"RTN","ECXADM",172,0)
 I ECXLOGIC>2006 S ECODE1=ECODE1_U_ECXERI_U_ECXAO_U_ECXECE_U_ECXHNC_U_ECXMIL_U_ECXIR
"RTN","ECXADM",173,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1
"RTN","ECXADM",174,0)
 S ECRN=ECRN+1
"RTN","ECXADM",175,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXADM",176,0)
 Q
"RTN","ECXADM",177,0)
 ;
"RTN","ECXADM",178,0)
SETUP ;Set required input for ECXTRAC.
"RTN","ECXADM",179,0)
 S ECHEAD="ADM"
"RTN","ECXADM",180,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXADM",181,0)
 Q
"RTN","ECXADM",182,0)
 ;
"RTN","ECXADM",183,0)
LOCAL ; to extract nightly for local use not to be transmitted to TSI
"RTN","ECXADM",184,0)
 ; should be queued with a 1D frequency
"RTN","ECXADM",185,0)
 D SETUP,^ECXTLOCL,^ECXKILL Q
"RTN","ECXADM",186,0)
 ;
"RTN","ECXADM",187,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXADM",188,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXADM",189,0)
 ;
"RTN","ECXATRT")
0^2^B50969112^B47325400
"RTN","ECXATRT",1,0)
ECXATRT ;ALB/JAP - TRT Extract Audit Report ;O4/12/2007
"RTN","ECXATRT",2,0)
 ;;3.0;DSS EXTRACTS;**1,6,8,107**;Dec 22, 1997;Build 9
"RTN","ECXATRT",3,0)
 ;
"RTN","ECXATRT",4,0)
EN ;entry point for TRT extract audit report
"RTN","ECXATRT",5,0)
 N %X,%Y,X,Y,DIC,DA,DR,DIQ,DIR
"RTN","ECXATRT",6,0)
 S ECXERR=0
"RTN","ECXATRT",7,0)
 ;ecxaud=0 for 'extract' audit
"RTN","ECXATRT",8,0)
 S ECXHEAD="TRT",ECXAUD=0
"RTN","ECXATRT",9,0)
 W !!,"Setup for ",ECXHEAD," Extract Audit Report --",!!
"RTN","ECXATRT",10,0)
 ;select extract
"RTN","ECXATRT",11,0)
 D AUDIT^ECXUTLA(ECXHEAD,.ECXERR,.ECXARRAY,ECXAUD)
"RTN","ECXATRT",12,0)
 Q:ECXERR
"RTN","ECXATRT",13,0)
 ;currently, this extract does not capture divisional data
"RTN","ECXATRT",14,0)
 S ECXALL=1
"RTN","ECXATRT",15,0)
 D TRT^ECXDVSN(.ECXDIV,ECXALL,.ECXERR)
"RTN","ECXATRT",16,0)
 I ECXERR=1 D  Q
"RTN","ECXATRT",17,0)
 .W !!,?5,"Try again later... exiting.",!
"RTN","ECXATRT",18,0)
 .D AUDIT^ECXKILL
"RTN","ECXATRT",19,0)
 ;determine output device and queue if requested
"RTN","ECXATRT",20,0)
 W !
"RTN","ECXATRT",21,0)
 S ECXPGM="PROCESS^ECXATRT",ECXDESC="TRT Extract Audit Report"
"RTN","ECXATRT",22,0)
 S ECXSAVE("ECXHEAD")="",ECXSAVE("ECXALL")="",ECXSAVE("ECXDIV(")="",ECXSAVE("ECXARRAY(")=""
"RTN","ECXATRT",23,0)
 W !
"RTN","ECXATRT",24,0)
 D DEVICE^ECXUTLA(ECXPGM,ECXDESC,.ECXSAVE)
"RTN","ECXATRT",25,0)
 I ECXSAVE("POP")=1 D  Q
"RTN","ECXATRT",26,0)
 .W !!,?5,"Try again later... exiting.",!
"RTN","ECXATRT",27,0)
 .D AUDIT^ECXKILL
"RTN","ECXATRT",28,0)
 I ECXSAVE("ZTSK")=0 D
"RTN","ECXATRT",29,0)
 .K ECXSAVE,ECXPGM,ECXDESC
"RTN","ECXATRT",30,0)
 .D PROCESS^ECXATRT
"RTN","ECXATRT",31,0)
 I IO'=IO(0) D ^%ZISC
"RTN","ECXATRT",32,0)
 D HOME^%ZIS
"RTN","ECXATRT",33,0)
 D AUDIT^ECXKILL
"RTN","ECXATRT",34,0)
 Q
"RTN","ECXATRT",35,0)
 ;
"RTN","ECXATRT",36,0)
PROCESS ;process data in file #727.817
"RTN","ECXATRT",37,0)
 N X,Y,W,DATA,DATE,DIV,IEN,TS,SPEC,FTS,FTSNM,SERV,ECX,QQFLG,CNT,A1,A2,NUM,MN,NEWFTS,NEWSPEC
"RTN","ECXATRT",38,0)
 K ^TMP($J,"ECXAUD"),^TMP($J,"ECXSPEC")
"RTN","ECXATRT",39,0)
 S (QQFLG,CNT)=0
"RTN","ECXATRT",40,0)
 S ECXEXT=ECXARRAY("EXTRACT"),ECXDEF=ECXARRAY("DEF")
"RTN","ECXATRT",41,0)
 S X=ECXARRAY("START") D ^%DT S ECXSTART=Y S X=ECXARRAY("END") D ^%DT S ECXEND=Y
"RTN","ECXATRT",42,0)
 ;get run date in external format
"RTN","ECXATRT",43,0)
 D NOW^%DTC S Y=$E(%,1,12) D DD^%DT S ECXRUN=Y
"RTN","ECXATRT",44,0)
 ;set up the specialty array for site/division
"RTN","ECXATRT",45,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXATRT",46,0)
 S DIV="" F  S DIV=$O(ECXDIV(DIV)) Q:DIV=""  D
"RTN","ECXATRT",47,0)
 .S DIC="^DIC(42.4,",DR=".01;3",DIQ(0)="E",DIQ="ECX"
"RTN","ECXATRT",48,0)
 .S SPEC="" F  S SPEC=$O(^DIC(42.4,"B",SPEC)) Q:SPEC=""  S TS=$O(^(SPEC,0)) D
"RTN","ECXATRT",49,0)
 ..K ECX S DA=TS D EN^DIQ1
"RTN","ECXATRT",50,0)
 ..S SPEC=$G(ECX(42.4,TS,.01,"E")),SERV=$G(ECX(42.4,TS,3,"E")) S:SERV="" SERV="Unknown"
"RTN","ECXATRT",51,0)
 ..S ^TMP($J,"ECXSPEC",DIV,TS)=0_U_SERV_U_SPEC,NUM(TS)=0
"RTN","ECXATRT",52,0)
 ;set up the specialty to facility treating specialty conversion array;
"RTN","ECXATRT",53,0)
 ;determine if active between ecxstart and ecxend;
"RTN","ECXATRT",54,0)
 ;ignore if facility treating specialty not active within date range of report;
"RTN","ECXATRT",55,0)
 S DIC="^DIC(45.7,",DR=".01;1",DIQ(0)="I",DIQ="ECX"
"RTN","ECXATRT",56,0)
 S FTSNM="" F  S FTSNM=$O(^DIC(45.7,"B",FTSNM)) Q:FTSNM=""  S FTS=$O(^(FTSNM,0)) D
"RTN","ECXATRT",57,0)
 .K ECX S DA=FTS D EN^DIQ1
"RTN","ECXATRT",58,0)
 .S FTSNM=$G(ECX(45.7,FTS,.01,"I")),TS=$G(ECX(45.7,FTS,1,"I"))
"RTN","ECXATRT",59,0)
 .Q:TS=""
"RTN","ECXATRT",60,0)
 .S A1=$$ACTIVE^DGACT(45.7,FTS,ECXSTART),A2=$$ACTIVE^DGACT(45.7,FTS,ECXEND)
"RTN","ECXATRT",61,0)
 .Q:A1=0&(A2=0)
"RTN","ECXATRT",62,0)
 .;num(ts) will hold the number of active facility treat. specialties (file #45.7) associated 
"RTN","ECXATRT",63,0)
 .;with this national specialty (file #42.4).
"RTN","ECXATRT",64,0)
 .I '$D(NUM(TS)) S NUM(TS)=0
"RTN","ECXATRT",65,0)
 .S ^TMP($J,"ECXTS",TS,FTS)=FTSNM,^TMP($J,"ECXREVTS",FTS)=TS,NUM(TS)=NUM(TS)+1
"RTN","ECXATRT",66,0)
 ;get extract records in date range
"RTN","ECXATRT",67,0)
 S IEN="" F  S IEN=$O(^ECX(727.817,"AC",ECXEXT,IEN)) Q:IEN=""  D  Q:QQFLG
"RTN","ECXATRT",68,0)
 .S DATA=^ECX(727.817,IEN,0),DATE=$P(DATA,U,9),DIV=$P(DATA,U,4)
"RTN","ECXATRT",69,0)
 .;currently the 4th piece of extract record is always null for trt
"RTN","ECXATRT",70,0)
 .S:DIV="" DIV=1
"RTN","ECXATRT",71,0)
 .;convert free text date to fm internal format date
"RTN","ECXATRT",72,0)
 .S $E(DATE,1,2)=$E(DATE,1,2)-17
"RTN","ECXATRT",73,0)
 .Q:$L(DATE)<7  Q:(DATE<ECXSTART)  Q:(DATE>ECXEND)
"RTN","ECXATRT",74,0)
 .I $D(ECXDIV(DIV)) D
"RTN","ECXATRT",75,0)
 ..;ts is the old specialty, newfts is the new facility treat. spec. for the movement date;
"RTN","ECXATRT",76,0)
 ..;after patch #1 'losing treating specialty los' field (#17) is non-null only for actual specialty changes;
"RTN","ECXATRT",77,0)
 ..;so should be able to distinguish true ts changes from provider-only changes;
"RTN","ECXATRT",78,0)
 ..;although it will still be possible that old and new specialty are the same, but facility
"RTN","ECXATRT",79,0)
 ..;treat. spec. was changed, but we've lost that info in the extract.
"RTN","ECXATRT",80,0)
 ..;
"RTN","ECXATRT",81,0)
 ..;filter out those records which are definitely provider-only changes;
"RTN","ECXATRT",82,0)
 ..;these are the records that have 'losing treating specialty los' which is null;
"RTN","ECXATRT",83,0)
 ..;but for extracts done prior to patch #1, still need to compare old & new specialty.
"RTN","ECXATRT",84,0)
 ..;
"RTN","ECXATRT",85,0)
 ..;convert 15th and 16th piece from PTF code back to Specialty
"RTN","ECXATRT",86,0)
 ..;ECX*3.0*107
"RTN","ECXATRT",87,0)
 ..;
"RTN","ECXATRT",88,0)
 ..N ECXTS
"RTN","ECXATRT",89,0)
 ..S ECXTS=$P(DATA,U,15),ECXTS=$O(^DIC(42.4,$G(ECXTS),"C",$P(DATA,U,15),0)),$P(DATA,U,15)=ECXTS
"RTN","ECXATRT",90,0)
 ..S ECXTS=$P(DATA,U,16),ECXTS=$O(^DIC(42.4,$G(ECXTS),"C",$P(DATA,U,16),0)),$P(DATA,U,16)=ECXTS
"RTN","ECXATRT",91,0)
 ..S NEWTS=$P(DATA,U,15),TS=$P(DATA,U,16),LOS=$P(DATA,U,17)
"RTN","ECXATRT",92,0)
 ..;leaving this next line in here for v3.0 extracts done prior to patch #1
"RTN","ECXATRT",93,0)
 ..Q:(NUM(TS)=1)&(NEWTS=TS)
"RTN","ECXATRT",94,0)
 ..Q:LOS=""
"RTN","ECXATRT",95,0)
 ..S $P(^(TS),U,1)=$P(^TMP($J,"ECXSPEC",DIV,TS),U,1)+1,CNT=CNT+1
"RTN","ECXATRT",96,0)
 ..I $D(ZTQUEUED),(CNT>499),'(CNT#500),$$S^%ZTLOAD S QQFLG=1,ZTSTOP=1 K ZTREQ
"RTN","ECXATRT",97,0)
 ;after all extract records processed, arrange by service and specialty;
"RTN","ECXATRT",98,0)
 ;total can only be associated with specialty, not facility treating specialty;
"RTN","ECXATRT",99,0)
 ;include specialty only if total loss is non-zero
"RTN","ECXATRT",100,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXATRT",101,0)
 S DIV="" F  S DIV=$O(ECXDIV(DIV)) Q:DIV=""  I $D(^TMP($J,"ECXSPEC",DIV)) D
"RTN","ECXATRT",102,0)
 .S TS="" F  S TS=$O(^TMP($J,"ECXSPEC",DIV,TS)) Q:TS=""  D
"RTN","ECXATRT",103,0)
 ..S TOT=+$P(^TMP($J,"ECXSPEC",DIV,TS),U,1) I TOT>0 D
"RTN","ECXATRT",104,0)
 ...S SERV=$P(^(TS),U,2),SPEC=$P(^(TS),U,3)
"RTN","ECXATRT",105,0)
 ...S ^TMP($J,"ECXAUD",DIV,SERV,SPEC)=TOT_U_TS
"RTN","ECXATRT",106,0)
 ;print the report
"RTN","ECXATRT",107,0)
 D PRINT
"RTN","ECXATRT",108,0)
 D AUDIT^ECXKILL
"RTN","ECXATRT",109,0)
 Q
"RTN","ECXATRT",110,0)
 ;
"RTN","ECXATRT",111,0)
PRINT ;print trt data by site, by service, by specialty
"RTN","ECXATRT",112,0)
 N JJ,SS,LN,P,DIV,DIVNM,GTOT,SVCTOT,PG,QFLG,DIR,DIRUT,DTOUT,DUOUT
"RTN","ECXATRT",113,0)
 U IO
"RTN","ECXATRT",114,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXATRT",115,0)
 S (QFLG,PG)=0,$P(LN,"-",80)=""
"RTN","ECXATRT",116,0)
 ;division associated with the treat. spec. change is not actually known; division is dss site
"RTN","ECXATRT",117,0)
 S DIV="" S DIV=$O(ECXDIV(DIV)) Q:DIV=""  S GTOT=0
"RTN","ECXATRT",118,0)
 D HEADER
"RTN","ECXATRT",119,0)
 I '$D(^TMP($J,"ECXAUD",DIV)) D  Q
"RTN","ECXATRT",120,0)
 .W !!,?5,"No data available for this DSS Site.",!!
"RTN","ECXATRT",121,0)
 I $D(^TMP($J,"ECXAUD",DIV)) S SERV="" F  S SERV=$O(^TMP($J,"ECXAUD",DIV,SERV)) Q:SERV=""  D  Q:QFLG
"RTN","ECXATRT",122,0)
 .S SVCTOT=0
"RTN","ECXATRT",123,0)
 .;write the service name
"RTN","ECXATRT",124,0)
 .D:($Y+3>IOSL) HEADER Q:QFLG  W !,SERV
"RTN","ECXATRT",125,0)
 .S SPEC="" F  S SPEC=$O(^TMP($J,"ECXAUD",DIV,SERV,SPEC)) Q:SPEC=""  D  Q:QFLG
"RTN","ECXATRT",126,0)
 ..;write the specialty name and total
"RTN","ECXATRT",127,0)
 ..S TOT=$P(^TMP($J,"ECXAUD",DIV,SERV,SPEC),U,1),TS=$P(^(SPEC),U,2)
"RTN","ECXATRT",128,0)
 ..W ?22,$E(SPEC,1,30)_" ("_TS_")",?68,$$RJ^XLFSTR(TOT,5," "),!
"RTN","ECXATRT",129,0)
 ..S SVCTOT=SVCTOT+TOT,GTOT=GTOT+TOT
"RTN","ECXATRT",130,0)
 ..S FTS="" F  S FTS=$O(^TMP($J,"ECXTS",TS,FTS)) Q:FTS=""  D  Q:QFLG
"RTN","ECXATRT",131,0)
 ...S FTSNM=^TMP($J,"ECXTS",TS,FTS)
"RTN","ECXATRT",132,0)
 ...D:($Y+3>IOSL) HEADER Q:QFLG  W ?25,$E(FTSNM,1,30),!
"RTN","ECXATRT",133,0)
 .;write the service subtotal
"RTN","ECXATRT",134,0)
 .Q:QFLG
"RTN","ECXATRT",135,0)
 .W ?22,$E(LN,1,54),!
"RTN","ECXATRT",136,0)
 .D:($Y+3>IOSL) HEADER Q:QFLG  W "Total for "_SERV_":",?68,$$RJ^XLFSTR(SVCTOT,5," "),!
"RTN","ECXATRT",137,0)
 ;write the grandtotal for all services at facility
"RTN","ECXATRT",138,0)
 D:($Y+3>IOSL) HEADER Q:QFLG  W !!,"Grand Total for all Services:",?68,$$RJ^XLFSTR(GTOT,5," ")
"RTN","ECXATRT",139,0)
 ;print the audit descriptive narrative
"RTN","ECXATRT",140,0)
 I $E(IOST)'="C" D
"RTN","ECXATRT",141,0)
 .W @IOF S PG=PG+1
"RTN","ECXATRT",142,0)
 .W !,ECXARRAY("TYPE")_" ("_ECXHEAD_") Extract Audit Report"
"RTN","ECXATRT",143,0)
 .W !,"DSS Extract Log #:    "_ECXEXT
"RTN","ECXATRT",144,0)
 .W !,"Date Range of Audit:  "_ECXARRAY("START")_" to "_ECXARRAY("END")
"RTN","ECXATRT",145,0)
 .W !,"Report Run Date/Time: "_ECXRUN,?68,"Page: ",PG
"RTN","ECXATRT",146,0)
 .W !!,LN,!!
"RTN","ECXATRT",147,0)
 .S DIC="^ECX(727.1,",DA=ECXARRAY("DEF"),DR="1" D EN^DIQ
"RTN","ECXATRT",148,0)
 I $E(IOST)="C",'QFLG D
"RTN","ECXATRT",149,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXATRT",150,0)
 .S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECXATRT",151,0)
 Q
"RTN","ECXATRT",152,0)
 ;
"RTN","ECXATRT",153,0)
HEADER ;header and page control
"RTN","ECXATRT",154,0)
 N JJ,SS
"RTN","ECXATRT",155,0)
 I $E(IOST)="C" D
"RTN","ECXATRT",156,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXATRT",157,0)
 .I PG>0 S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXATRT",158,0)
 Q:QFLG
"RTN","ECXATRT",159,0)
 W:$Y!($E(IOST)="C") @IOF S PG=PG+1
"RTN","ECXATRT",160,0)
 ;W !,ECXARRAY("TYPE")_" ("_ECXHEAD_") Extract Audit Report"
"RTN","ECXATRT",161,0)
 W !,"Treating Specialty Change"_" ("_ECXHEAD_") Extract Audit Report"
"RTN","ECXATRT",162,0)
 W !,"DSS Extract Log #:    "_ECXARRAY("EXTRACT")
"RTN","ECXATRT",163,0)
 W !,"Date Range of Audit:  "_ECXARRAY("START")_" to "_ECXARRAY("END")
"RTN","ECXATRT",164,0)
 W !,"Report Run Date/Time: "_ECXRUN
"RTN","ECXATRT",165,0)
 W !,"DSS Site:             "_$P(ECXDIV(DIV),U,2)_" ("_$P(ECXDIV(DIV),U,3)_")",?68,"Page: "_PG
"RTN","ECXATRT",166,0)
 W !!,"Service",?22,"Specialty (DSS Code)",?68,"# of Losses"
"RTN","ECXATRT",167,0)
 W !,?25,"Facility Treating Specialty"
"RTN","ECXATRT",168,0)
 W !,LN,!
"RTN","ECXATRT",169,0)
 Q
"RTN","ECXLABN")
0^7^B28026471^B27015743
"RTN","ECXLABN",1,0)
ECXLABN ;ALB/JAP,BIR/CML-Lab Extract for DSS (New Format - With LMIP Codes) ; 4/25/07 8:52am
"RTN","ECXLABN",2,0)
 ;;3.0;DSS EXTRACTS;**1,11,8,13,28,24,30,31,32,33,39,42,46,70,71,80,92,107**;Dec 22, 1997;Build 9
"RTN","ECXLABN",3,0)
BEG ;entry point
"RTN","ECXLABN",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXLABN",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXLABN",6,0)
 Q
"RTN","ECXLABN",7,0)
 ;
"RTN","ECXLABN",8,0)
START ; entry when queued
"RTN","ECXLABN",9,0)
 K ^LRO(64.03),^TMP($J,"ECXP")
"RTN","ECXLABN",10,0)
 N ECDOCPC
"RTN","ECXLABN",11,0)
 S LRSDT=ECSD,LREDT=ECED,QFLG=0
"RTN","ECXLABN",12,0)
 D ^LRCAPDSS
"RTN","ECXLABN",13,0)
 ;quit if no completion date for API compile
"RTN","ECXLABN",14,0)
 I '$P($G(^LRO(64.03,1,1,1,0)),U,4) Q
"RTN","ECXLABN",15,0)
 ;quit if tasked and user sends stop request
"RTN","ECXLABN",16,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD D  Q
"RTN","ECXLABN",17,0)
 .S QFLG=1
"RTN","ECXLABN",18,0)
 .K ^LRO(64.03) S ^LRO(64.03,0)="WKLD LOG FILE^64.03^"
"RTN","ECXLABN",19,0)
 ;otherwise, continue
"RTN","ECXLABN",20,0)
 K ECXDD D FIELD^DID(64.03,1,,"SPECIFIER","ECXDD")
"RTN","ECXLABN",21,0)
 S ECPROF=$E(+$P(ECXDD("SPECIFIER"),"P",2)),ECLRN=1 K ECXDD
"RTN","ECXLABN",22,0)
 F  S ECLRN=$O(^LRO(64.03,ECLRN)) Q:'ECLRN  D  Q:QFLG
"RTN","ECXLABN",23,0)
 .Q:'$D(^LRO(64.03,ECLRN,0))
"RTN","ECXLABN",24,0)
 .S EC1=^LRO(64.03,ECLRN,0),ECDOC=ECPROF_$P(EC1,U,2),ECDOCNPI=""
"RTN","ECXLABN",25,0)
 .S ECLOC=$P(EC1,U,15),EC=$P(EC1,U,3),ECDOCPC=$$PRVCLASS^ECXUTL($P(EC1,U,2),$P(EC1,U,4))
"RTN","ECXLABN",26,0)
 .I EC]"" D GET
"RTN","ECXLABN",27,0)
 K ^LRO(64.03),^TMP($J,"ECXP") S ^LRO(64.03,0)="WKLD LOG FILE^64.03^"
"RTN","ECXLABN",28,0)
 K ECDOCNPI,ECXAGC,ECXL1,ECXL2
"RTN","ECXLABN",29,0)
 Q
"RTN","ECXLABN",30,0)
 ;
"RTN","ECXLABN",31,0)
GET ;get data
"RTN","ECXLABN",32,0)
 N X,ECXSTN
"RTN","ECXLABN",33,0)
 S ECF=$S($P(EC,";",2)="DPT(":2,$P(EC,";",2)="LRT(67,":67,1:0) Q:'ECF
"RTN","ECXLABN",34,0)
 S ECIFN=$P(EC,";")
"RTN","ECXLABN",35,0)
 ;resolve ecloc
"RTN","ECXLABN",36,0)
 S ECXL1=+$P(ECLOC,";",1),ECXL2=$P(ECLOC,";",2)
"RTN","ECXLABN",37,0)
 I ECF=2 S ECLOC=$S(ECXL1>0:ECXL1,1:"") I ECXL2]"",ECXL2'="SC(" S ECLOC=""
"RTN","ECXLABN",38,0)
 I ECF=67 D  S ECLOC=ECXSTN
"RTN","ECXLABN",39,0)
 .S (ECXSTN,ECXAGC)=""
"RTN","ECXLABN",40,0)
 .I (ECXL2'="DIC(4,")!('$D(^DIC(4,ECXL1))) S ECXSTN="XXXXX",ECXAGC="XX" Q
"RTN","ECXLABN",41,0)
 .S ECXSTN=$P(^DIC(4,ECXL1,"99"),U,1),ECXAGC=$E($P(^(99),U,5),1,2)
"RTN","ECXLABN",42,0)
 .S:ECXSTN="" ECXSTN="ZZZZZ" S:ECXAGC="" ECXAGC="ZZ"
"RTN","ECXLABN",43,0)
 S ECDT=$P(EC1,U,13),ECD=$P(ECDT,"."),ECTM=$$ECXTIME^ECXUTL(ECDT)
"RTN","ECXLABN",44,0)
 S ECWKLD=$P(EC1,U,11),ECWK="" I $D(^LAM(ECWKLD,0)) S ECWK=$P(^(0),U,2)
"RTN","ECXLABN",45,0)
 S (ECXADMDT,ECTREAT,ECNA,ECSN,ECMN,ECPTTM,ECPTPR,ECCLAS)="",ECA="O",ECXERR=0
"RTN","ECXLABN",46,0)
 S (ECPTNPI,ECASPR,ECCLAS2,ECASNPI)=""
"RTN","ECXLABN",47,0)
 ;get the patient data if record is in file #2
"RTN","ECXLABN",48,0)
 I ECF=2 D PAT(ECIFN,ECDT,.ECXERR)
"RTN","ECXLABN",49,0)
 Q:ECXERR
"RTN","ECXLABN",50,0)
 ;get patient data if record is in file #67
"RTN","ECXLABN",51,0)
 I ECF=67 S ECSN="000123456",ECNA="RFRL" I $D(^LRT(67,ECIFN,0)) D
"RTN","ECXLABN",52,0)
 .S ECXMPI="",EC0=^LRT(67,ECIFN,0),ECNA=$E($P($P(EC0,U),",")_"    ",1,4)
"RTN","ECXLABN",53,0)
 .S ECSN=$P(EC0,U,9),ECXERI="" D
"RTN","ECXLABN",54,0)
 ..S ECNA=$TR(ECNA,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","ECXLABN",55,0)
 ..I ECSN="" S ECSN="000123456" Q
"RTN","ECXLABN",56,0)
 ..S ECSN=$TR(ECSN," "),ECSN=$TR(ECSN,"-")
"RTN","ECXLABN",57,0)
 ..I ($L(ECSN)<9)!($L(ECSN)>10) S ECSN="000123456" Q
"RTN","ECXLABN",58,0)
 ..I $L(ECSN)=9,ECSN'?9N S ECSN="000123456" Q
"RTN","ECXLABN",59,0)
 ..I $L(ECSN)=10,ECSN'?9N1"P" S ECSN="000123456"
"RTN","ECXLABN",60,0)
 ;
"RTN","ECXLABN",61,0)
 ;- Only set treating spec (TS) to TS in file #64.03 if it does not exist
"RTN","ECXLABN",62,0)
 I ECA="I",ECTREAT="" S ECTREAT=$P($G(^DIC(45.7,+$P(EC1,U,10),0)),U,2)
"RTN","ECXLABN",63,0)
 S (ECXDOM,ECXDSSD)=""
"RTN","ECXLABN",64,0)
 S X=$G(^ECX(727.831,+ECTREAT,0)) S:X'="" ECXDOM=$P(X,U,2)
"RTN","ECXLABN",65,0)
 ;
"RTN","ECXLABN",66,0)
 ;- Get ordering stop code and ordering date
"RTN","ECXLABN",67,0)
 S ECXORDST=+$P(EC1,U,15),ECXORDST=$S(ECXORDST:$P($G(^ECX(728.44,ECXORDST,0)),U,2),1:"")
"RTN","ECXLABN",68,0)
 S ECXORDDT=$S($P(EC1,U,14):$$ECXDATE^ECXUTL($P(EC1,U,14),ECXYM),1:"")
"RTN","ECXLABN",69,0)
 ;
"RTN","ECXLABN",70,0)
 ;- Get Production Division - ECXDIEN added p-80
"RTN","ECXLABN",71,0)
 N ECXPDIV,ECXDIEN S ECXDIEN=$O(^DIC(4,"D",ECINST,"")),ECXPDIV=$$RADDIV^ECXDEPT(ECXDIEN)  ;P-46
"RTN","ECXLABN",72,0)
 K ECXDIEN
"RTN","ECXLABN",73,0)
 ;
"RTN","ECXLABN",74,0)
 ;- Observation patient indicator (YES/NO)
"RTN","ECXLABN",75,0)
 S ECXOBS=$$OBSPAT^ECXUTL4(ECA,ECTREAT)
"RTN","ECXLABN",76,0)
 ;
"RTN","ECXLABN",77,0)
 ;- If no encounter number don't file record
"RTN","ECXLABN",78,0)
 S ECXENC=$$ENCNUM^ECXUTL4(ECA,ECSN,ECXADMDT,ECD,ECTREAT,ECXOBS,ECHEAD,,) Q:ECXENC=""
"RTN","ECXLABN",79,0)
 ;create extract record only if patient name and accession area exist
"RTN","ECXLABN",80,0)
 I ECNA]"" S ECT=$P(EC1,U,8),ECURG=$P(EC1,U,9),EC=+$P(EC1,U,7) I EC D
"RTN","ECXLABN",81,0)
 .S:ECF=2 ECACA=EC_U_$P($G(^LRO(68,EC,0)),U,11)
"RTN","ECXLABN",82,0)
 .S:ECF=67 ECACA=ECXAGC_U_$P($G(^LRO(68,EC,0)),U,11)
"RTN","ECXLABN",83,0)
 .D FILE
"RTN","ECXLABN",84,0)
 Q
"RTN","ECXLABN",85,0)
 ;
"RTN","ECXLABN",86,0)
PAT(ECXDFN,ECXDATE,ECXERR) ;get/set patient data
"RTN","ECXLABN",87,0)
 N X,OK,PT
"RTN","ECXLABN",88,0)
 ;get data
"RTN","ECXLABN",89,0)
 I $D(^TMP($J,"ECXP",ECXDFN)) D
"RTN","ECXLABN",90,0)
 .S PT=^TMP($J,"ECXP",ECXDFN),ECNA=$P(PT,U)
"RTN","ECXLABN",91,0)
 .S ECSN=$P(PT,U,2),ECXMPI=$P(PT,U,3),ECXERI=$P(PT,U,4)
"RTN","ECXLABN",92,0)
 ;set data and save for later
"RTN","ECXLABN",93,0)
 I '$D(^TMP($J,"ECXP",ECXDFN)) D  Q:'OK
"RTN","ECXLABN",94,0)
 .K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,$P(ECSD,"."),"1;3",.ECXPAT)
"RTN","ECXLABN",95,0)
 .I 'OK S ECXERR=1 Q
"RTN","ECXLABN",96,0)
 .S ECNA=ECXPAT("NAME"),ECSN=ECXPAT("SSN"),ECXMPI=ECXPAT("MPI")
"RTN","ECXLABN",97,0)
 .S ECXERI=ECXPAT("ERI")
"RTN","ECXLABN",98,0)
 .S ^TMP($J,"ECXP",ECXDFN)=ECNA_U_ECSN_U_ECXMPI_U_ECXERI
"RTN","ECXLABN",99,0)
 ;get date specific data
"RTN","ECXLABN",100,0)
 S X=$$INP^ECXUTL2(ECXDFN,ECXDATE),ECA=$P(X,U),ECMN=$P(X,U,2),ECTREAT=$P(X,U,3),ECXADMDT=$P(X,U,4)
"RTN","ECXLABN",101,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,$P(ECXDATE,"."),ECPROF)
"RTN","ECXLABN",102,0)
 S ECPTTM=$P(X,U,1),ECPTPR=$P(X,U,2),ECCLAS=$P(X,U,3),ECPTNPI=$P(X,U,4)
"RTN","ECXLABN",103,0)
 S ECASPR=$P(X,U,5),ECCLAS2=$P(X,U,6),ECASNPI=$P(X,U,7)
"RTN","ECXLABN",104,0)
 Q
"RTN","ECXLABN",105,0)
 ;
"RTN","ECXLABN",106,0)
FILE ;file record
"RTN","ECXLABN",107,0)
 ;node0
"RTN","ECXLABN",108,0)
 ;facility^patient number^SSN (or equivalent)^name^in/out ECA^
"RTN","ECXLABN",109,0)
 ;day^accession area^abbreviation^test^urgency^treating spec^
"RTN","ECXLABN",110,0)
 ;location^provider and file^
"RTN","ECXLABN",111,0)
 ;movement number^file^time^workload code^primary care team^
"RTN","ECXLABN",112,0)
 ;primary care provider
"RTN","ECXLABN",113,0)
 ;node1
"RTN","ECXLABN",114,0)
 ;mpi^dss dept^provider npi^pc provider npi^pc prov person class^
"RTN","ECXLABN",115,0)
 ;assoc pc prov^assoc pc prov person class^assoc pc prov npi^
"RTN","ECXLABN",116,0)
 ;dom ECXDOM^observ pat ind ECXOBS^encounter num ECXENC^
"RTN","ECXLABN",117,0)
 ;ord stop code ECXORDST^ord date ECXORDDT^production division
"RTN","ECXLABN",118,0)
 ;ECXPDIV^^ordering provider person class^emergency response indicator
"RTN","ECXLABN",119,0)
 ;(FEMA) ECXERI
"RTN","ECXLABN",120,0)
 ;ECDOCPC
"RTN","ECXLABN",121,0)
 N DA,DIK
"RTN","ECXLABN",122,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXLABN",123,0)
 S ECODE=EC7_U_EC23_U_ECINST_U_ECIFN_U_ECSN_U_ECNA_U_ECA_U
"RTN","ECXLABN",124,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECD,ECXYM)_U_ECACA_U_ECT_U_ECURG_U
"RTN","ECXLABN",125,0)
 ;convert specialty to PTF Code for transmission
"RTN","ECXLABN",126,0)
 N ECXDATA
"RTN","ECXLABN",127,0)
 S ECXDATA=$$TSDATA^DGACT(42.4,+ECTREAT,.ECXDATA)
"RTN","ECXLABN",128,0)
 S ECTREAT=$G(ECXDATA(7))
"RTN","ECXLABN",129,0)
 ;done
"RTN","ECXLABN",130,0)
 S ECODE=ECODE_ECTREAT_U_ECLOC_U_ECDOC_U_ECMN_U_ECF_U_ECTM_U_ECWK_U
"RTN","ECXLABN",131,0)
 S ECODE=ECODE_ECPTTM_U_ECPTPR_U
"RTN","ECXLABN",132,0)
 ;(ECACA=acc area^abbreviation)
"RTN","ECXLABN",133,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECDOCNPI_U_ECPTNPI_U_ECCLAS_U_ECASPR_U
"RTN","ECXLABN",134,0)
 S ECODE1=ECODE1_ECCLAS2_U_ECASNPI_U_ECXDOM_U_ECXOBS_U_ECXENC_U
"RTN","ECXLABN",135,0)
 S ECODE1=ECODE1_ECXORDST_U_ECXORDDT_U_ECXPDIV_U
"RTN","ECXLABN",136,0)
 I ECXLOGIC>2004 S ECODE1=ECODE1_U_ECDOCPC
"RTN","ECXLABN",137,0)
 I ECXLOGIC>2006 S ECODE1=ECODE1_U_ECXERI
"RTN","ECXLABN",138,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXLABN",139,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXLABN",140,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXLABN",141,0)
 Q
"RTN","ECXLABN",142,0)
 ;
"RTN","ECXLABN",143,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXLABN",144,0)
 S ECHEAD="LAB"
"RTN","ECXLABN",145,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXLABN",146,0)
 Q
"RTN","ECXLABN",147,0)
 ;
"RTN","ECXLABN",148,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXLABN",149,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXLABR")
0^9^B21149464^B20369624
"RTN","ECXLABR",1,0)
ECXLABR ;ALB/JAP,BIR/CML-LAR Extract for DSS (New Format - With LMIP Codes) ; 4/12/07 8:43am
"RTN","ECXLABR",2,0)
 ;;3.0;DSS EXTRACTS;**8,24,33,37,39,46,71,80,107**;Dec 22, 1997;Build 9
"RTN","ECXLABR",3,0)
BEG ;entry point from option
"RTN","ECXLABR",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXLABR",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXLABR",6,0)
 Q
"RTN","ECXLABR",7,0)
 ;
"RTN","ECXLABR",8,0)
START ; entry when queued
"RTN","ECXLABR",9,0)
 N X,OK,ECTRS,ECTRANS,ECTRIEN,ECDOC,ECDOCPC
"RTN","ECXLABR",10,0)
 K ^LAR(64.036) S LRSDT=ECSD,LREDT=ECED
"RTN","ECXLABR",11,0)
 D ^LRCAPDAR
"RTN","ECXLABR",12,0)
 ;quit if no completion date for API compile
"RTN","ECXLABR",13,0)
 I '$P($G(^LAR(64.036,1,2,1,0)),U,4) Q
"RTN","ECXLABR",14,0)
 ;build local array of workload codes for local lab tests linked to
"RTN","ECXLABR",15,0)
 ;DSS tests
"RTN","ECXLABR",16,0)
 K ECLOC S ECDTST=0
"RTN","ECXLABR",17,0)
 F  S ECDTST=$O(^ECX(727.2,1,1,ECDTST)) Q:('ECDTST)  S ECLTST=0 D
"RTN","ECXLABR",18,0)
 .F  S ECLTST=$O(^ECX(727.2,1,1,ECDTST,"LOC",ECLTST)) Q:'ECLTST  D
"RTN","ECXLABR",19,0)
 ..S ECLTIEN=+^ECX(727.2,1,1,ECDTST,"LOC",ECLTST,0)
"RTN","ECXLABR",20,0)
 ..S ECWCDA=+$G(^LAB(60,ECLTIEN,64))
"RTN","ECXLABR",21,0)
 ..I ECWCDA S ECWC=$P(^LAM(ECWCDA,0),U,2),ECLOC(ECWCDA)=ECWC
"RTN","ECXLABR",22,0)
 K ECLTIEN
"RTN","ECXLABR",23,0)
 ;process temporary lab file #64.036
"RTN","ECXLABR",24,0)
 S QFLG=0,ECLRN=1
"RTN","ECXLABR",25,0)
 F  S ECLRN=$O(^LAR(64.036,ECLRN)) Q:('ECLRN)!(QFLG)  D
"RTN","ECXLABR",26,0)
 .I $D(^LAR(64.036,ECLRN,0))  D
"RTN","ECXLABR",27,0)
 ..S EC1=^LAR(64.036,ECLRN,0),ECF=$P(EC1,U,2)
"RTN","ECXLABR",28,0)
 ..Q:ECF=""
"RTN","ECXLABR",29,0)
 ..S ECXDFN=$P(EC1,U,3),ECPTPR=$P($G(EC1),U,11),ECCLASS=""
"RTN","ECXLABR",30,0)
 ..S ECXTIME=$S($P(EC1,U,10)="":"000300",1:$P(EC1,U,10))
"RTN","ECXLABR",31,0)
 ..S ECXDATE=$P(EC1,U,9)_"."_$P(EC1,U,10)
"RTN","ECXLABR",32,0)
 ..I ECPTPR S ECCLASS=$$PRVCLASS^ECXUTL(ECPTPR,ECXDATE)
"RTN","ECXLABR",33,0)
 ..S ECORDT=$$ECXDATE^ECXUTL($P(EC1,U,4),ECXYM)
"RTN","ECXLABR",34,0)
 ..S ECORTM=$$ECXTIME^ECXUTL($P(EC1,U,4)_"."_$P(EC1,U,5))
"RTN","ECXLABR",35,0)
 ..S ECREDT=$$ECXDATE^ECXUTL($P(EC1,U,6),ECXYM)
"RTN","ECXLABR",36,0)
 ..S ECRETM=$$ECXTIME^ECXUTL($P(EC1,U,6)_"."_$P(EC1,U,7))
"RTN","ECXLABR",37,0)
 ..S ECSCDT=$$ECXDATE^ECXUTL($P(EC1,U,9),ECXYM)
"RTN","ECXLABR",38,0)
 ..S ECSCTM=$$ECXTIME^ECXUTL($P(EC1,U,9)_"."_$P(EC1,U,10))
"RTN","ECXLABR",39,0)
 ..S (ECXADMDT,ECXDOM,ECXDSSD,ECXPNM,ECXSSN,ECXA,ECXMN,ECXTS)=""
"RTN","ECXLABR",40,0)
 ..I ECF=2 D  Q:'OK
"RTN","ECXLABR",41,0)
 ...K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,ECXDATE,"1;",.ECXPAT)
"RTN","ECXLABR",42,0)
 ...Q:'OK
"RTN","ECXLABR",43,0)
 ...S ECXPNM=ECXPAT("NAME"),ECXSSN=ECXPAT("SSN"),ECXMPI=ECXPAT("MPI")
"RTN","ECXLABR",44,0)
 ...S X=$$INP^ECXUTL2(ECXDFN,ECXDATE),ECXA=$P(X,U),ECXADMDT=$P(X,U,4)
"RTN","ECXLABR",45,0)
 ...S ECXMN=$P(X,U,2),ECXTS=$P(X,U,3),ECXDOM=$P(X,U,10)
"RTN","ECXLABR",46,0)
 ..;allow for referral patients in future??
"RTN","ECXLABR",47,0)
 ..;I ECF=67 S ECSN="000123456",ECNA="RFRL"
"RTN","ECXLABR",48,0)
 ..;loop on results multiple
"RTN","ECXLABR",49,0)
 ..;
"RTN","ECXLABR",50,0)
 ..;Get production division ECXDIEN added p-80
"RTN","ECXLABR",51,0)
 ..N ECXPDIV,ECXDIEN S ECXDIEN=$O(^DIC(4,"D",ECINST,"")),ECXPDIV=$$RADDIV^ECXDEPT(ECXDIEN) ;p-46
"RTN","ECXLABR",52,0)
 ..K ECXDIEN
"RTN","ECXLABR",53,0)
 ..;- Observation patient indicator (y/n)
"RTN","ECXLABR",54,0)
 ..S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS)
"RTN","ECXLABR",55,0)
 ..;
"RTN","ECXLABR",56,0)
 ..;- If no encounter number don't file record
"RTN","ECXLABR",57,0)
 ..S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,$P(EC1,U,9),ECXTS,ECXOBS,ECHEAD,,) Q:ECXENC=""
"RTN","ECXLABR",58,0)
 ..S ECRES=0
"RTN","ECXLABR",59,0)
 ..F  S ECRES=$O(^LAR(64.036,ECLRN,1,ECRES)) Q:('ECRES)!(QFLG)  D
"RTN","ECXLABR",60,0)
 ...I $D(^LAR(64.036,ECLRN,1,ECRES,0)) D  Q:QFLG
"RTN","ECXLABR",61,0)
 ....S EC2=^LAR(64.036,ECLRN,1,ECRES,0),ECN=$P(EC2,U),ECRS=$P(EC2,U,2)
"RTN","ECXLABR",62,0)
 ....S ECHL=$E($P(EC2,U,3)),ECWC=+$P(EC2,U,4)
"RTN","ECXLABR",63,0)
 ....S ECWC=$S($D(ECLOC(ECWC)):ECLOC(ECWC),1:"")
"RTN","ECXLABR",64,0)
 ....;
"RTN","ECXLABR",65,0)
 ....; - Free text results translation
"RTN","ECXLABR",66,0)
 ....S ECTRANS="",ECTRS=ECRS
"RTN","ECXLABR",67,0)
 ....I +ECTRS S ECTRS=$TR(ECTRS,",","") D
"RTN","ECXLABR",68,0)
 .....I (ECTRS?.N)!(ECTRS?.N1".".N) S ECRS=ECTRS
"RTN","ECXLABR",69,0)
 ....F  Q:$E(ECTRS,1)'=" "  S ECTRS=$E(ECTRS,2,$L(ECTRS))
"RTN","ECXLABR",70,0)
 ....F  Q:$E(ECTRS,$L(ECTRS))'=" "  S ECTRS=$E(ECTRS,1,($L(ECTRS)-1))
"RTN","ECXLABR",71,0)
 ....I ECTRS]"" I ECTRS'?.N I ECTRS'?.N1".".N D  ;translate
"RTN","ECXLABR",72,0)
 .....S ECTRS=$TR(ECRS,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","ECXLABR",73,0)
 .....S ECTRIEN="",ECTRIEN=$O(^ECX(727.7,"B",ECTRS,ECTRIEN))
"RTN","ECXLABR",74,0)
 .....S ECTRANS=$S(ECTRIEN:$P(^ECX(727.7,ECTRIEN,0),U,2),1:5)
"RTN","ECXLABR",75,0)
 ....;
"RTN","ECXLABR",76,0)
 ....I ECWC]"" D FILE
"RTN","ECXLABR",77,0)
 K ^LAR(64.036) S ^LAR(64.036,0)="LAB DSS LAR EXTRACT^64.036^"
"RTN","ECXLABR",78,0)
 Q
"RTN","ECXLABR",79,0)
 ;
"RTN","ECXLABR",80,0)
FILE ;file record
"RTN","ECXLABR",81,0)
 ;node0
"RTN","ECXLABR",82,0)
 ;facility (ECINST)^dfn (ECXDFN)^ssn (ECXSSN)^name(ECXPNM)^in/out (ECXA)^
"RTN","ECXLABR",83,0)
 ;day(ECSCDT)^
"RTN","ECXLABR",84,0)
 ;lab test code (ECN)^results (ECRS)^hi/lo indicator (ECHL)^
"RTN","ECXLABR",85,0)
 ;date ordered (ECORDT)^time ordered (ECORTM)^date ready (ECREDT)^
"RTN","ECXLABR",86,0)
 ;time ready (ECRETM)^
"RTN","ECXLABR",87,0)
 ;movement file # (ECXMN)^treating specialty (ECXTS)^
"RTN","ECXLABR",88,0)
 ;workload code(ECWC)^
"RTN","ECXLABR",89,0)
 ;node1
"RTN","ECXLABR",90,0)
 ;mpi (ECXMPI)^dss dept (ECXDSSD)^dom (ECXDOM)^time (ECSCTM)^
"RTN","ECXLABR",91,0)
 ;observ pat ind (ECXOBS)^encounter num (ECXENC)^prod div ECXPDIV^
"RTN","ECXLABR",92,0)
 ;lab results translation ECXTRANS^ordering provider (ECPTPR)^
"RTN","ECXLABR",93,0)
 ;ordering provider person class (ECCLASS)
"RTN","ECXLABR",94,0)
 N DA,DIK
"RTN","ECXLABR",95,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXLABR",96,0)
 S ECODE=EC7_U_EC23_U_ECINST_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXLABR",97,0)
 S ECODE=ECODE_ECSCDT_U_$$RJ^XLFSTR(ECN,4,0)_U_ECRS_U_ECHL_U_ECORDT_U
"RTN","ECXLABR",98,0)
 S ECODE=ECODE_$$LJ^XLFSTR(ECORTM,6,0)_U
"RTN","ECXLABR",99,0)
 ;convert specialty to PTF Code for transmission
"RTN","ECXLABR",100,0)
 N ECXDATA
"RTN","ECXLABR",101,0)
 S ECXDATA=$$TSDATA^DGACT(42.4,+ECXTS,.ECXDATA)
"RTN","ECXLABR",102,0)
 S ECXTS=$G(ECXDATA(7))
"RTN","ECXLABR",103,0)
 ;done
"RTN","ECXLABR",104,0)
 S ECODE=ECODE_ECREDT_U_$$LJ^XLFSTR(ECRETM,6,0)_U_ECXMN_U_ECXTS_U_ECWC_U
"RTN","ECXLABR",105,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECXDOM_U_ECSCTM_U_ECXOBS_U_ECXENC_U_ECXPDIV_U_ECTRANS
"RTN","ECXLABR",106,0)
 I ECXLOGIC>2004 S ECODE1=ECODE1_U_2_ECPTPR_U_ECCLASS
"RTN","ECXLABR",107,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXLABR",108,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXLABR",109,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXLABR",110,0)
 Q
"RTN","ECXLABR",111,0)
 ;
"RTN","ECXLABR",112,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXLABR",113,0)
 S ECHEAD="LAR"
"RTN","ECXLABR",114,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXLABR",115,0)
 Q
"RTN","ECXLABR",116,0)
 ;
"RTN","ECXLABR",117,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXLABR",118,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXNURS")
0^4^B43358486^B41257332
"RTN","ECXNURS",1,0)
ECXNURS ;ALB/JAP,BIR/DMA,PTD-Nursing Extract for DSS ;4/19/2007
"RTN","ECXNURS",2,0)
 ;;3.0;DSS EXTRACTS;**8,14,22,24,33,39,46,71,107**;Dec 22, 1997;Build 9
"RTN","ECXNURS",3,0)
BEG ;entry point from option
"RTN","ECXNURS",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXNURS",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXNURS",6,0)
 Q
"RTN","ECXNURS",7,0)
 ;
"RTN","ECXNURS",8,0)
START ;entry when queued
"RTN","ECXNURS",9,0)
 ;store in ^tmp by patient and date/time
"RTN","ECXNURS",10,0)
 N CNT,INP,FIRSTDAY,LASTDAY
"RTN","ECXNURS",11,0)
 S QFLG=0,CNT=0
"RTN","ECXNURS",12,0)
 K ^TMP("ECX",$J)
"RTN","ECXNURS",13,0)
 S FIRSTDAY=$P(ECSD1,".")+1,LASTDAY=$P(ECED,".")
"RTN","ECXNURS",14,0)
 S ECED=ECED+.3,ECD=ECSD1
"RTN","ECXNURS",15,0)
 F  S ECD=$O(^NURSA(214.6,"B",ECD)),ECDA=0 Q:'ECD  Q:ECD>ECED  D  Q:QFLG
"RTN","ECXNURS",16,0)
 .F  S ECDA=$O(^NURSA(214.6,"B",ECD,ECDA)) Q:'ECDA  D  Q:QFLG
"RTN","ECXNURS",17,0)
 ..K LOC S DIC=214.6,DIQ(0)="I",DA=ECDA,DIQ="LOC",DR=".01;.02;1;3;4;6;7;8"
"RTN","ECXNURS",18,0)
 ..D EN^DIQ1 K DIQ,DIC,DA,DR
"RTN","ECXNURS",19,0)
 ..F J=.01,.02,1,3,4,6,7,8 S EC(J)=LOC(214.6,ECDA,J,"I")
"RTN","ECXNURS",20,0)
 ..Q:EC(8)'=""
"RTN","ECXNURS",21,0)
 ..S INP=$$INP^ECXUTL2(EC(.02),EC(.01))
"RTN","ECXNURS",22,0)
 ..;
"RTN","ECXNURS",23,0)
 ..;- Don't create ^TMP record if outpatient and no treat spec
"RTN","ECXNURS",24,0)
 ..Q:$P(INP,U)="O"&($P(INP,U,3)="")
"RTN","ECXNURS",25,0)
 ..; retain latest classification per day per patient
"RTN","ECXNURS",26,0)
 ..S ^TMP("ECX",$J,EC(.02),$P(EC(.01),"."))=EC(1)_U_EC(3)_U_EC(4)_U_EC(6)_U_EC(7)_U_$P(INP,U,1,6)_U_EC(.01)_U_$P(INP,U,10)
"RTN","ECXNURS",27,0)
 ..K LOC(214.6,ECDA),EC,INP
"RTN","ECXNURS",28,0)
 ..S CNT=CNT+1
"RTN","ECXNURS",29,0)
 ..I $D(ZTQUEUED),(CNT>499),'(CNT#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXNURS",30,0)
 I QFLG K ^TMP("ECX",$J) Q
"RTN","ECXNURS",31,0)
 D RESOLVE
"RTN","ECXNURS",32,0)
 D FILE
"RTN","ECXNURS",33,0)
 K ^TMP("ECX",$J)
"RTN","ECXNURS",34,0)
 ;
"RTN","ECXNURS",35,0)
RESOLVE ;process ^tmp by patient
"RTN","ECXNURS",36,0)
 N DFN,TM,ECD,ECDPREV,ECDNEW,OLDWARD,NEWWARD,NEWDT
"RTN","ECXNURS",37,0)
 S DFN=0
"RTN","ECXNURS",38,0)
 F  S DFN=$O(^TMP("ECX",$J,DFN)) S ECD=0 Q:'DFN  D
"RTN","ECXNURS",39,0)
 .;remove any classifications for day of discharge
"RTN","ECXNURS",40,0)
 .F  S ECD=$O(^TMP("ECX",$J,DFN,ECD)) Q:'ECD  D
"RTN","ECXNURS",41,0)
 ..I ECD=$P($P(^TMP("ECX",$J,DFN,ECD),U,11),".") K ^TMP("ECX",$J,DFN,ECD)
"RTN","ECXNURS",42,0)
 .;proceed only if ^tmp remains
"RTN","ECXNURS",43,0)
 .Q:'$D(^TMP("ECX",$J,DFN))
"RTN","ECXNURS",44,0)
 .;proceed with fill-in only if processing more than 3 days' data
"RTN","ECXNURS",45,0)
 .Q:LASTDAY<(FIRSTDAY+2)
"RTN","ECXNURS",46,0)
 .;fill-in records for any missing days per inpatient episode
"RTN","ECXNURS",47,0)
 .K TM S ECD=0
"RTN","ECXNURS",48,0)
 .F  S ECD=$O(^TMP("ECX",$J,DFN,ECD)) Q:'ECD   D
"RTN","ECXNURS",49,0)
 ..S TM(ECD)=$P(^TMP("ECX",$J,DFN,ECD),U,9)
"RTN","ECXNURS",50,0)
 .S (ECD,ECDPREV)=0
"RTN","ECXNURS",51,0)
 .F  S ECD=$O(TM(ECD)) Q:'ECD  D
"RTN","ECXNURS",52,0)
 ..I ECDPREV=0 S ECDPREV=ECD Q
"RTN","ECXNURS",53,0)
 ..I (ECD-ECDPREV)>1,+TM(ECD)=+TM(ECDPREV) D
"RTN","ECXNURS",54,0)
 ...F ECDNEW=ECDPREV+1:1:ECD-1 S ^TMP("ECX",$J,DFN,ECDNEW)=^TMP("ECX",$J,DFN,ECDPREV) D
"RTN","ECXNURS",55,0)
 ....S NEWWARD="",OLDWARD=$P(^TMP("ECX",$J,DFN,ECDPREV),U,10)
"RTN","ECXNURS",56,0)
 ....D NEWWARD(ECDNEW,OLDWARD,.NEWWARD)
"RTN","ECXNURS",57,0)
 ....Q:'NEWWARD
"RTN","ECXNURS",58,0)
 ....S $P(^TMP("ECX",$J,DFN,ECDNEW),U,4)=$P(NEWWARD,U,1)
"RTN","ECXNURS",59,0)
 ....S $P(^TMP("ECX",$J,DFN,ECDNEW),U,5)=$P(NEWWARD,U,2)
"RTN","ECXNURS",60,0)
 ..S ECDPREV=ECD
"RTN","ECXNURS",61,0)
 .;fill-in to end of extract date range
"RTN","ECXNURS",62,0)
 .K TM S ECD=0
"RTN","ECXNURS",63,0)
 .F  S ECD=$O(^TMP("ECX",$J,DFN,ECD)) Q:'ECD   D
"RTN","ECXNURS",64,0)
 ..S TM(ECD)=$P(^TMP("ECX",$J,DFN,ECD),U,11)
"RTN","ECXNURS",65,0)
 .S ECD=$O(TM(""),-1),DCDT=+TM(ECD)
"RTN","ECXNURS",66,0)
 .;if last day in date range is after last classification date
"RTN","ECXNURS",67,0)
 .I LASTDAY>ECD D
"RTN","ECXNURS",68,0)
 ..;if there is no d/c date
"RTN","ECXNURS",69,0)
 ..I DCDT=0 F ECDNEW=ECD+1:1:LASTDAY D  Q
"RTN","ECXNURS",70,0)
 ...I '$D(^TMP("ECX",$J,DFN,ECDNEW)) S ^TMP("ECX",$J,DFN,ECDNEW)=^TMP("ECX",$J,DFN,ECD)
"RTN","ECXNURS",71,0)
 ...S NEWWARD="",OLDWARD=$P(^TMP("ECX",$J,DFN,ECD),U,10)
"RTN","ECXNURS",72,0)
 ...D NEWWARD(ECDNEW,OLDWARD,.NEWWARD)
"RTN","ECXNURS",73,0)
 ...Q:'NEWWARD
"RTN","ECXNURS",74,0)
 ...S $P(^TMP("ECX",$J,DFN,ECDNEW),U,4)=$P(NEWWARD,U,1)
"RTN","ECXNURS",75,0)
 ...S $P(^TMP("ECX",$J,DFN,ECDNEW),U,5)=$P(NEWWARD,U,2)
"RTN","ECXNURS",76,0)
 ..;if d/c date is after last classification date
"RTN","ECXNURS",77,0)
 ..I $P(DCDT,".")>ECD S NEWDT=$S($P(DCDT,".")>LASTDAY:LASTDAY,1:($P(DCDT,".")-1)) F ECDNEW=ECD+1:1:NEWDT D  Q
"RTN","ECXNURS",78,0)
 ...I '$D(^TMP("ECX",$J,DFN,ECDNEW)) S ^TMP("ECX",$J,DFN,ECDNEW)=^TMP("ECX",$J,DFN,ECD)
"RTN","ECXNURS",79,0)
 ...S NEWWARD="",OLDWARD=$P(^TMP("ECX",$J,DFN,ECD),U,10)
"RTN","ECXNURS",80,0)
 ...D NEWWARD(ECDNEW,OLDWARD,.NEWWARD)
"RTN","ECXNURS",81,0)
 ...Q:'NEWWARD
"RTN","ECXNURS",82,0)
 ...S $P(^TMP("ECX",$J,DFN,ECDNEW),U,4)=$P(NEWWARD,U,1)
"RTN","ECXNURS",83,0)
 ...S $P(^TMP("ECX",$J,DFN,ECDNEW),U,5)=$P(NEWWARD,U,2)
"RTN","ECXNURS",84,0)
 Q
"RTN","ECXNURS",85,0)
 ;
"RTN","ECXNURS",86,0)
NEWWARD(ECDNEW,OLDWARD,NEWWARD) ;get new nursing location
"RTN","ECXNURS",87,0)
 ; input  ECDNEW  = date of care
"RTN","ECXNURS",88,0)
 ;        OLDWARD = pointer to file #42, previous mas ward
"RTN","ECXNURS",89,0)
 ;        NEWWARD = null
"RTN","ECXNURS",90,0)
 ; output NEWWARD = new nursing location^new nursing bedsection
"RTN","ECXNURS",91,0)
 ;                  OR "^", if new ward same as previous ward or
"RTN","ECXNURS",92,0)
 ;could not be resolved
"RTN","ECXNURS",93,0)
 ;if the new ward is mapped to multiple nursing locations, get the
"RTN","ECXNURS",94,0)
 ;first active location
"RTN","ECXNURS",95,0)
 N NEWW,NEWLOC,NEWSEC,OUT,DA,DR,DIC,DIQ,LOC,INP
"RTN","ECXNURS",96,0)
 S INP=$$INP^ECXUTL2(DFN,ECDNEW)
"RTN","ECXNURS",97,0)
 S NEWWARD=$P(INP,U,5)
"RTN","ECXNURS",98,0)
 I NEWWARD=OLDWARD S NEWWARD=""
"RTN","ECXNURS",99,0)
 Q:'NEWWARD
"RTN","ECXNURS",100,0)
 S (NEWW,NEWW2,NEWLOC,NEWSEC)="",OUT=0
"RTN","ECXNURS",101,0)
 F  S NEWW=$O(^NURSF(211.4,"C",NEWWARD,NEWW)) Q:OUT  Q:+NEWW<1  D
"RTN","ECXNURS",102,0)
 .S DIC=211.4,DIQ(0)="I",DIQ="LOC",DA=NEWW,DR="1;1.5"
"RTN","ECXNURS",103,0)
 .D EN^DIQ1 K DIQ,DIC,DA,DR
"RTN","ECXNURS",104,0)
 .Q:LOC(211.4,NEWW,1,"I")="I"
"RTN","ECXNURS",105,0)
 .Q:LOC(211.4,NEWW,1.5,"I")="I"
"RTN","ECXNURS",106,0)
 .S JJ=$O(^NURSF(211.4,"C",NEWWARD,NEWW,""))
"RTN","ECXNURS",107,0)
 .S DIC=211.4,DIQ(0)="I",DIQ="LOC",DA=NEWW,DA(211.41)=JJ,DR="2",DR(211.41)=".01;1"
"RTN","ECXNURS",108,0)
 .D EN^DIQ1 K DIQ,DIC,DA,DR
"RTN","ECXNURS",109,0)
 .Q:NEWWARD'=LOC(211.41,JJ,.01,"I")
"RTN","ECXNURS",110,0)
 .S NEWLOC=NEWW,NEWSEC=LOC(211.41,JJ,1,"I"),OUT=1
"RTN","ECXNURS",111,0)
 I (NEWLOC="")!(NEWSEC="") S NEWWARD="" Q
"RTN","ECXNURS",112,0)
 S NEWWARD=NEWLOC_U_NEWSEC
"RTN","ECXNURS",113,0)
 Q
"RTN","ECXNURS",114,0)
 ;
"RTN","ECXNURS",115,0)
FILE ;file extract records
"RTN","ECXNURS",116,0)
 ;node0
"RTN","ECXNURS",117,0)
 ;inst^dfn^ssn^name^in/out (ECXA)^date^acuity level(category)^entered by^
"RTN","ECXNURS",118,0)
 ;classifier^nurs location^nursing bed section^mov #^treat spec^adm date^
"RTN","ECXNURS",119,0)
 ;adm time
"RTN","ECXNURS",120,0)
 ;node1
"RTN","ECXNURS",121,0)
 ;mpi^dss dept ECXDSSD^dom (ECXDOM)^observ pat ind (ECXOBS)^dss
"RTN","ECXNURS",122,0)
 ;product ECXDSSP
"RTN","ECXNURS",123,0)
 N DA,DIK
"RTN","ECXNURS",124,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1)
"RTN","ECXNURS",125,0)
 S DFN=0,QFLG=0
"RTN","ECXNURS",126,0)
 F  S DFN=$O(^TMP("ECX",$J,DFN)) Q:'DFN  D  Q:QFLG
"RTN","ECXNURS",127,0)
 .K ECXPAT S OK=$$PAT^ECXUTL3(DFN,DT,"1;",.ECXPAT)
"RTN","ECXNURS",128,0)
 .Q:'OK
"RTN","ECXNURS",129,0)
 .S ECXDFN=DFN,ECXPNM=ECXPAT("NAME"),ECXSSN=ECXPAT("SSN")
"RTN","ECXNURS",130,0)
 .S ECXMPI=ECXPAT("MPI"),ECD=0
"RTN","ECXNURS",131,0)
 .;file patient's classification data
"RTN","ECXNURS",132,0)
 .F  S ECD=$O(^TMP("ECX",$J,DFN,ECD)) Q:'ECD   D
"RTN","ECXNURS",133,0)
 ..S ECC=$P(^TMP("ECX",$J,DFN,ECD),U,1,5),ECMN=$P(^(ECD),U,7),ECXA=$P(^(ECD),U,6)
"RTN","ECXNURS",134,0)
 ..S ECTS=$P(^(ECD),U,8),ECA=$P(^(ECD),U,9),ECXDOM=$P(^(ECD),U,13)
"RTN","ECXNURS",135,0)
 ..S ECXACU=$P(ECC,U,1),ECXEB=$P(ECC,U,2),ECXCLS=$P(ECC,U,3)
"RTN","ECXNURS",136,0)
 ..S ECXNLOC=$P(ECC,U,4),ECXNBED=$P(ECC,U,5)
"RTN","ECXNURS",137,0)
 ..;
"RTN","ECXNURS",138,0)
 ..;Get DSS Department and Product
"RTN","ECXNURS",139,0)
 ..S (ECXDSSD,ECXDSSP)=""
"RTN","ECXNURS",140,0)
 ..;I ECXLOGIC>2004 S X=$$NUR^ECXDEPT(ECD)
"RTN","ECXNURS",141,0)
 ..;
"RTN","ECXNURS",142,0)
 ..;- Observation patient indicator (YES/NO)
"RTN","ECXNURS",143,0)
 ..S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECTS)
"RTN","ECXNURS",144,0)
 ..;
"RTN","ECXNURS",145,0)
 ..;- Don't file record if outpatient and NOT an observation patient
"RTN","ECXNURS",146,0)
 ..Q:ECXA="O"&(ECXOBS="NO")
"RTN","ECXNURS",147,0)
 ..;
"RTN","ECXNURS",148,0)
 ..;- If no encounter number don't file record
"RTN","ECXNURS",149,0)
 ..S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECA,ECD,ECTS,ECXOBS,ECHEAD,,) Q:ECXENC=""
"RTN","ECXNURS",150,0)
 ..S EC7=EC7+1
"RTN","ECXNURS",151,0)
 ..S ECODE=EC7_U_EC23_U_ECINST_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXNURS",152,0)
 ..S ECODE=ECODE_$$ECXDATE^ECXUTL(ECD,ECXYM)_U
"RTN","ECXNURS",153,0)
 ..S ECODE=ECODE_ECXACU_U_ECXEB_U_ECXCLS_U_ECXNLOC_U_ECXNBED_U
"RTN","ECXNURS",154,0)
 ..;convert specialties to PTF Codes for transmission
"RTN","ECXNURS",155,0)
 .. N ECXDATA
"RTN","ECXNURS",156,0)
 .. S ECXDATA=$$TSDATA^DGACT(42.4,+ECTS,.ECXDATA)
"RTN","ECXNURS",157,0)
 .. S ECTS=$G(ECXDATA(7))
"RTN","ECXNURS",158,0)
 ..;done
"RTN","ECXNURS",159,0)
 ..S ECODE=ECODE_ECMN_U_ECTS_U_$$ECXDATE^ECXUTL(ECA,ECXYM)_U
"RTN","ECXNURS",160,0)
 ..S ECODE=ECODE_$$ECXTIME^ECXUTL(ECA)_U
"RTN","ECXNURS",161,0)
 ..S ECODE1=ECXMPI_U_ECXDSSD_U_ECXDOM_U_ECXOBS_U_ECXENC_U
"RTN","ECXNURS",162,0)
 ..S ECODE1=ECODE1_ECINST_U
"RTN","ECXNURS",163,0)
 ..I ECXLOGIC>2004 S ECODE1=ECODE1_ECXDSSP
"RTN","ECXNURS",164,0)
 ..S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXNURS",165,0)
 ..S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXNURS",166,0)
 ..I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXNURS",167,0)
 Q
"RTN","ECXNURS",168,0)
 ;
"RTN","ECXNURS",169,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXNURS",170,0)
 S ECHEAD="NUR"
"RTN","ECXNURS",171,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXNURS",172,0)
 Q
"RTN","ECXNURS",173,0)
 ;
"RTN","ECXNURS",174,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXNURS",175,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXNUT")
0^11^B28055134^B26867365
"RTN","ECXNUT",1,0)
ECXNUT ;ALB/JRC Nutrition DSS Extract ; 4/2/2007
"RTN","ECXNUT",2,0)
 ;;3.0;DSS EXTRACTS;**92,107**;Dec 22, 1997;Build 9
"RTN","ECXNUT",3,0)
BEG ;entry point from option
"RTN","ECXNUT",4,0)
 N EC23,EC7,ECED,ECFILE,ECGRP,ECHEAD,ECINST,ECPACK,ECPIECE,ECRN,ECRTN,ECSD1,ECVER,ECXYM
"RTN","ECXNUT",5,0)
 D SETUP I ECFILE="" Q
"RTN","ECXNUT",6,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXNUT",7,0)
 Q
"RTN","ECXNUT",8,0)
 ;
"RTN","ECXNUT",9,0)
START ; start package specific extract
"RTN","ECXNUT",10,0)
 ;Init variables
"RTN","ECXNUT",11,0)
 N ECSD
"RTN","ECXNUT",12,0)
 S ECED=ECED+.3,ECSD=ECSD1
"RTN","ECXNUT",13,0)
 K ^TMP($J,"FH")
"RTN","ECXNUT",14,0)
 ;
"RTN","ECXNUT",15,0)
 ;Call n&fs api and store in ^TMP($J,"FH" global
"RTN","ECXNUT",16,0)
 D DATA^FHDSSAPI(ECSD,ECED)
"RTN","ECXNUT",17,0)
 ;
"RTN","ECXNUT",18,0)
 ;Get n&fs records from ^TMP($J,"FH" global and file
"RTN","ECXNUT",19,0)
 D GETMEALS^ECXNUT1
"RTN","ECXNUT",20,0)
 ;
"RTN","ECXNUT",21,0)
 ;kill ^tmp global
"RTN","ECXNUT",22,0)
 K ^TMP($J,"FH")
"RTN","ECXNUT",23,0)
 ;
"RTN","ECXNUT",24,0)
 Q
"RTN","ECXNUT",25,0)
 ;
"RTN","ECXNUT",26,0)
GET ;gather extract data
"RTN","ECXNUT",27,0)
 ;Init variables
"RTN","ECXNUT",28,0)
 N ECXORDPC,ECXSSN,ECXPNM,ECXSEX,ECXDOB,ECXMPI,ECXRC1,ECXETH,ECXVET,ECXENRL,ECXELIG,ECXMST,ECXPST,ECXPLOC,ECXPHI,ECXMNS,ECXSTATE,ECXCNTY,ECXZIP,ECXPOS,ECXAST,ECXAOL,ECXRST,ECXEST,ECXTM,ECXDATE,ECXMN,ECXSPC
"RTN","ECXNUT",29,0)
 N ECXADMDT,ECXWRD,ECXFAC,ECXPRV,ECXPRNPI,ECXATT,ECXATNPI,ECXDOM,ECXATTPC,ECXPRVPC,ECXPDIV,ECXCBOC,ECPTPR,ECCLASS,ECPTTM,ECXOBS,ECXHNCI,ECXNPRFI,ECXERI,ECXENC,ECPAT,ECXERR,ADM,W,X,ECXCAT,ECXCVE,ECXPRIOR,ECXPTYPE,ECXSTAT,ECXUESTA,ECXA
"RTN","ECXNUT",30,0)
 ;
"RTN","ECXNUT",31,0)
 ;- Prefix ordering pro with a 2 and get person class
"RTN","ECXNUT",32,0)
 S ECXORDPC=$$PRVCLASS^ECXUTL(+ECXORDPH,DATE)
"RTN","ECXNUT",33,0)
 S ECXORDPH=$S(ECXORDPH:2_ECXORDPH,1:"")
"RTN","ECXNUT",34,0)
 ;
"RTN","ECXNUT",35,0)
 ;set patient file (#2) dfn and get patient demographics
"RTN","ECXNUT",36,0)
 S ECXDFN=$P($G(^TMP($J,"FH","ZN",FHDFN)),U,3)
"RTN","ECXNUT",37,0)
 S ECXERR=0 D PAT(ECXDFN)
"RTN","ECXNUT",38,0)
 Q:ECXERR
"RTN","ECXNUT",39,0)
 ;Set demographic variables
"RTN","ECXNUT",40,0)
 S ECXSSN=ECPAT("SSN"),ECXPNM=ECPAT("NAME"),ECXSEX=ECPAT("SEX"),ECXDOB=ECPAT("DOB"),ECXMPI=ECPAT("MPI"),ECXRC1=ECPAT("RACE1"),ECXETH=ECPAT("ETHNIC"),ECXVET=ECPAT("VET"),ECXENRL=ECPAT("ENROLL LOC"),ECXELIG=ECPAT("ELIG")
"RTN","ECXNUT",41,0)
 S ECXMST=ECPAT("MST STAT"),ECXPST=ECPAT("POW STAT"),ECXPLOC=ECPAT("POW LOC"),ECXPHI=ECPAT("PHI"),ECXMNS=ECPAT("MEANS"),ECXSTATE=ECPAT("STATE"),ECXCNTY=ECPAT("COUNTY"),ECXZIP=ECPAT("ZIP")
"RTN","ECXNUT",42,0)
 S ECXPOS=ECPAT("POS"),ECXAST=ECPAT("AO STAT"),ECXAOL=ECPAT("AOL"),ECXRST=ECPAT("IR STAT"),ECXEST=ECPAT("EC STAT")
"RTN","ECXNUT",43,0)
 ;
"RTN","ECXNUT",44,0)
 ;Get enrollment status
"RTN","ECXNUT",45,0)
 I $$ENROLLM^ECXUTL2(ECXDFN)
"RTN","ECXNUT",46,0)
 ;
"RTN","ECXNUT",47,0)
 S ECXTM=$$ECXTIME^ECXUTL(DATE)
"RTN","ECXNUT",48,0)
 S ECXDATE=DATE
"RTN","ECXNUT",49,0)
 ;
"RTN","ECXNUT",50,0)
 ;- Use movement record date & time
"RTN","ECXNUT",51,0)
 S ADM=$$INP^ECXUTL2(ECXDFN,DATE),ECXA=$P(ADM,U)
"RTN","ECXNUT",52,0)
 S ECXMN=$P(ADM,U,2),ECXSPC=$P(ADM,U,3),ECXADMDT=$P(ADM,U,4)
"RTN","ECXNUT",53,0)
 S W=$P(ADM,U,9),ECXWRD=$P(W,";",1),ECXFAC=$P(W,";",2)
"RTN","ECXNUT",54,0)
 S ECXPRV=$P(ADM,U,7),ECXPRNPI="",ECXATT=$P(ADM,U,8),ECXATNPI=""
"RTN","ECXNUT",55,0)
 S ECXDOM=$P(ADM,U,10),ECXATTPC=$P(ADM,U,12),ECXPRVPC=$P(ADM,U,11)
"RTN","ECXNUT",56,0)
 ;
"RTN","ECXNUT",57,0)
 S ECXPDIV=$$GETDIV^ECXDEPT(ECXFAC)  ;Get production division
"RTN","ECXNUT",58,0)
 S ECXCBOC=$$CBOC^ECXSCX2(+ECXFAC) ;Get cboc facility
"RTN","ECXNUT",59,0)
 ;
"RTN","ECXNUT",60,0)
 ;- Get primary care data
"RTN","ECXNUT",61,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,DATE)
"RTN","ECXNUT",62,0)
 S ECPTPR=$P(X,U,2),ECCLASS=$P(X,U,3),ECPTTM=$P(X,U)
"RTN","ECXNUT",63,0)
 ;
"RTN","ECXNUT",64,0)
 ;- Observation patient indicator (YES/NO)
"RTN","ECXNUT",65,0)
 S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXSPC)
"RTN","ECXNUT",66,0)
 ;
"RTN","ECXNUT",67,0)
 ;- Get head and neck cancer indicator
"RTN","ECXNUT",68,0)
 S ECXHNCI=$$HNCI^ECXUTL4(ECXDFN)
"RTN","ECXNUT",69,0)
 ;
"RTN","ECXNUT",70,0)
 ;- Get national patient record flag indicator
"RTN","ECXNUT",71,0)
 N ECXNPRFI D NPRF^ECXUTL5
"RTN","ECXNUT",72,0)
 ;
"RTN","ECXNUT",73,0)
 ;- National response indicator
"RTN","ECXNUT",74,0)
 S ECXERI=$$EMGRES^DGUTL(ECXDFN)
"RTN","ECXNUT",75,0)
 ;
"RTN","ECXNUT",76,0)
 ;- If null encounter number, don't file record
"RTN","ECXNUT",77,0)
 S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,DATE,ECXSPC,ECXOBS,ECHEAD,,)
"RTN","ECXNUT",78,0)
 D:ECXENC'="" FILE
"RTN","ECXNUT",79,0)
 Q
"RTN","ECXNUT",80,0)
 ;
"RTN","ECXNUT",81,0)
PAT(ECXDFN) ;get/set patient data
"RTN","ECXNUT",82,0)
 ; INPUT - ECXDFN = patient ien (DFN)
"RTN","ECXNUT",83,0)
 ; OUTPUT - ECPAT array:
"RTN","ECXNUT",84,0)
 ;          ECPAT("SSN")
"RTN","ECXNUT",85,0)
 ;          ECPAT("NAME")
"RTN","ECXNUT",86,0)
 ; returns 0 or 1 in ECXERR - 0=successful
"RTN","ECXNUT",87,0)
 ;                            1=error condition
"RTN","ECXNUT",88,0)
 N X,OK
"RTN","ECXNUT",89,0)
 ;get data
"RTN","ECXNUT",90,0)
 S ECXERR=0
"RTN","ECXNUT",91,0)
 K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,"","1;2;3;5",.ECPAT)
"RTN","ECXNUT",92,0)
 I 'OK S ECXERR=1
"RTN","ECXNUT",93,0)
 Q ECXERR
"RTN","ECXNUT",94,0)
 ;
"RTN","ECXNUT",95,0)
FILE ;file the n&fs extract record
"RTN","ECXNUT",96,0)
 ;node
"RTN","ECXNUT",97,0)
 ;facility^dfn^ssn^name^in/out^day^time^treating specialty^
"RTN","ECXNUT",98,0)
 ;ordering provider^ordering provider person class^primary 
"RTN","ECXNUT",99,0)
 ;care provider^primary person class^primary care team^mpi^dob^sex^
"RTN","ECXNUT",100,0)
 ;race 1^ethnicity^veteran^enrollment status^enrollment location^
"RTN","ECXNUT",101,0)
 ;enrollment category^enrollment priority^eligibility^period of
"RTN","ECXNUT",102,0)
 ;service^agent orange status^agent orange location^radiation status
"RTN","ECXNUT",103,0)
 ;^environmental contaminants^mst status^head & neck cancer indicator
"RTN","ECXNUT",104,0)
 ;pow status^pow location^purple heart indicator^means test^state code
"RTN","ECXNUT",105,0)
 ;^county code^zip+4^observation patient indicator^rrtp,prrtp and
"RTN","ECXNUT",106,0)
 ;saartp indicator^encounter number^patient division^food production
"RTN","ECXNUT",107,0)
 ;division^delivery division^product feeder key^food production
"RTN","ECXNUT",108,0)
 ;facility^delivery location type^delivery feeder location^quantity^
"RTN","ECXNUT",109,0)
 ;cboc^status^user enrollee^patient type^cv status eligibility^
"RTN","ECXNUT",110,0)
 ;national^patient record flag^emergency response indicator^admission
"RTN","ECXNUT",111,0)
 ;date
"RTN","ECXNUT",112,0)
 ;
"RTN","ECXNUT",113,0)
 N DA,DIK,ECODE,ECODE1
"RTN","ECXNUT",114,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXNUT",115,0)
 S ECODE=EC7_U_EC23_U_ECINST_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXNUT",116,0)
 ;
"RTN","ECXNUT",117,0)
 ;convert specialty to PTF Code
"RTN","ECXNUT",118,0)
 ;
"RTN","ECXNUT",119,0)
 N ECXDATA
"RTN","ECXNUT",120,0)
 S ECXDATA=$$TSDATA^DGACT(42.4,+ECXSPC,.ECXDATA)
"RTN","ECXNUT",121,0)
 S ECXSPC=$G(ECXDATA(7))
"RTN","ECXNUT",122,0)
 ;
"RTN","ECXNUT",123,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(DATE,ECXYM)_U_ECXTM_U_ECXSPC_U_ECXORDPH_U_ECXORDPC_U
"RTN","ECXNUT",124,0)
 S ECODE=ECODE_ECPTPR_U_ECCLASS_U_ECPTTM_U_ECXMPI_U_ECXDOB_U_ECXSEX_U
"RTN","ECXNUT",125,0)
 S ECODE=ECODE_ECXRC1_U_ECXETH_U_ECXVET_U_ECXSTAT_U_ECXENRL_U_ECXCAT_U
"RTN","ECXNUT",126,0)
 S ECODE=ECODE_ECXPRIOR_U_ECXELIG_U_ECXPOS_U_ECXAST_U_ECXAOL_U_ECXRST
"RTN","ECXNUT",127,0)
 S ECODE=ECODE_U_ECXEST_U_ECXMST_U_ECXHNCI_U_ECXPST_U_ECXPLOC_U_ECXPHI
"RTN","ECXNUT",128,0)
 S ECODE=ECODE_U_ECXMNS_U_ECXSTATE_U_ECXCNTY_U
"RTN","ECXNUT",129,0)
 S ECODE1=ECXZIP_U_ECXOBS_U_ECXDOM_U_ECXENC_U_ECXPDIV_U_ECXFPD_U
"RTN","ECXNUT",130,0)
 S ECODE1=ECODE1_ECXFDD_U_ECXKEY_U_ECXFPF_U_ECXDLT_U_ECXDFL_U_ECXQTY_U
"RTN","ECXNUT",131,0)
 S ECODE1=ECODE1_ECXCBOC_U_ECXUESTA_U_ECXPTYPE_U_ECXCVE_U_ECXNPRFI_U
"RTN","ECXNUT",132,0)
 S ECODE1=ECODE1_ECXERI_U_$S(ECXADMDT:$$ECXDATE^ECXUTL(ECXADMDT,ECXYM),1:"")
"RTN","ECXNUT",133,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1
"RTN","ECXNUT",134,0)
 S ECRN=ECRN+1
"RTN","ECXNUT",135,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXNUT",136,0)
 Q
"RTN","ECXNUT",137,0)
 ;
"RTN","ECXNUT",138,0)
SETUP ;Set required input for ECXTRAC.
"RTN","ECXNUT",139,0)
 S ECHEAD="NUT"
"RTN","ECXNUT",140,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXNUT",141,0)
 Q
"RTN","ECXOPRX1")
0^6^B7720497^B7057662
"RTN","ECXOPRX1",1,0)
ECXOPRX1 ;ALB/JAP,BIR/DMA,CML,PTD-Prescription Extract for DSS ; 4/19/2007
"RTN","ECXOPRX1",2,0)
 ;;3.0;DSS EXTRACTS;**92,107**;Dec 22, 1997;Build 9
"RTN","ECXOPRX1",3,0)
 ;
"RTN","ECXOPRX1",4,0)
FILE ;file record
"RTN","ECXOPRX1",5,0)
 ;node0
"RTN","ECXOPRX1",6,0)
 ;inst^dfn^ssn^name^in/out ECXA^day^division^provider^drug category^mail^
"RTN","ECXOPRX1",7,0)
 ;placeholder1^new^placeholder2^qty^cost^placeholder3^mov #^treat spec^placeholder4^unit of issue^dob^elig^vet^copay^
"RTN","ECXOPRX1",8,0)
 ;feeder key^investigational^days supply^primary care team^primary care provider^time^race
"RTN","ECXOPRX1",9,0)
 ;node1
"RTN","ECXOPRX1",10,0)
 ;mpi^dss dept ECXDSSD^sex^zip+4^provider npi^pc provider npi^state^county^pc prov person class^pow status^pow location^
"RTN","ECXOPRX1",11,0)
 ;ir status^ao status^sharing agree. payor^sharing agree. ins.^mst status^enroll loc^assoc pc provider^assoc pc prov person class^
"RTN","ECXOPRX1",12,0)
 ;assoc pc prov npi^dom ECXDOM^purple heart ECXPHI^enrollment category ECXCAT^enrollment status ECXSTST^
"RTN","ECXOPRX1",13,0)
 ;enrollment priority ECXPRIOR^cnhu status ECXCNHU^period of service ECXPOS^observ pat ind ECXOBS^encounter num ECXENC^
"RTN","ECXOPRX1",14,0)
 ;ao loc ECXAOL^ord physician ECXORDPH^ord stop code ECXORDST^ord date ECXORDDT^CNH status ECXCNH^national division ECXPDIV^
"RTN","ECXOPRX1",15,0)
 ;MT Stat ECXMTST^head & neck cancer ind. ECXHNCI^ethnicity ECXETH^race ECXRC1^^enrollment priority ECXPRIOR_
"RTN","ECXOPRX1",16,0)
 ;enrollment subgroup ECXSBGRP^user enrollee ECXUESTA^patient type ECXPTYPE^combat vet elig ECXCVE^combat vet elig end date ECXCVEDT^
"RTN","ECXOPRX1",17,0)
 ;enc cv eligible ECXCVENC^national patient record flag ECXNPRFI^rx patient status ECRXPTST^non-va prescriber ECNONVAP^rx # ECRXNUM
"RTN","ECXOPRX1",18,0)
 ;^emergency response indicator(FEMA) ECXERI^agent orange enc ECXAO^environ cont PGE ECXECE^head/neck ECXHNC^enc mst ECXMIL^environ contamin ECXEST^ion radiat ECXIR
"RTN","ECXOPRX1",19,0)
 N DA,DIK
"RTN","ECXOPRX1",20,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXOPRX1",21,0)
 S ECODE=EC7_U_EC23_U_ECINST_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXOPRX1",22,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECXDATE,ECXYM)_U_ECXDIV_U
"RTN","ECXOPRX1",23,0)
 S ECODE=ECODE_ECXPROV_U_ECCAT_U_ECMW_U_ECXPROVP_U_ECXNEW_U_U_ECQTY_U
"RTN","ECXOPRX1",24,0)
 ;convert specialty to PTF Code for transmission
"RTN","ECXOPRX1",25,0)
 N ECXDATA
"RTN","ECXOPRX1",26,0)
 S ECXDATA=$$TSDATA^DGACT(42.4,+ECXTS,.ECXDATA)
"RTN","ECXOPRX1",27,0)
 S ECXTS=$G(ECXDATA(7))
"RTN","ECXOPRX1",28,0)
 ;done
"RTN","ECXOPRX1",29,0)
 S ECODE=ECODE_ECXCOST_U_U_ECXMN_U_ECXTS_U_U_ECUI_U_ECXDOB_U
"RTN","ECXOPRX1",30,0)
 S ECODE=ECODE_ECXELIG_U_ECXVET_U_ECOPAY_U_ECNFC_U_ECINV_U_ECDS_U
"RTN","ECXOPRX1",31,0)
 S ECODE=ECODE_ECPTTM_U_ECPTPR_U_$$ECXTIME^ECXUTL(ECXDATE)_U_ECXRACE_U
"RTN","ECXOPRX1",32,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECXSEX_U_ECXZIP_U_ECXPROVN_U_ECPTNPI_U
"RTN","ECXOPRX1",33,0)
 S ECODE1=ECODE1_ECXSTATE_U_ECXCNTY_U_ECCLAS_U_ECXPST_U_ECXPLOC_U
"RTN","ECXOPRX1",34,0)
 S ECODE1=ECODE1_ECXRST_U_ECXAST_U_U_U_ECXMST_U_ECXENRL_U
"RTN","ECXOPRX1",35,0)
 S ECODE1=ECODE1_ECASPR_U_ECCLAS2_U_ECASNPI_U_ECXDOM_U_ECXPHI_U_ECXCAT_U
"RTN","ECXOPRX1",36,0)
 S ECODE1=ECODE1_ECXSTAT_U_$S(ECXLOGIC<2005:ECXPRIOR,1:"")_U_ECXCNHU_U_ECXPOS_U_ECXOBS_U
"RTN","ECXOPRX1",37,0)
 S ECODE1=ECODE1_ECXENC_U_ECXAOL_U_ECXORDPH_U_ECXORDST_U_ECXORDDT_U
"RTN","ECXOPRX1",38,0)
 S ECODE1=ECODE1_ECXCNH_U_ECXPDIV_U_ECXMTST_U_ECXHNCI_U_ECXETH_U
"RTN","ECXOPRX1",39,0)
 S ECODE1=ECODE1_ECXRC1_U
"RTN","ECXOPRX1",40,0)
 I ECXLOGIC>2004 S ECODE1=ECODE1_U_ECXPRIOR_ECXSBGRP_U_ECXUESTA_U
"RTN","ECXOPRX1",41,0)
 I ECXLOGIC>2004 S ECODE2=ECXPTYPE_U_ECXCVE_U_ECXCVEDT_U_ECXCVENC_U_ECXNPRFI_U_ECRXPTST_U_ECNONVAP
"RTN","ECXOPRX1",42,0)
 I ECXLOGIC>2005 S ECODE2=ECODE2_U_ECRXNUM
"RTN","ECXOPRX1",43,0)
 I ECXLOGIC>2006 S ECODE2=ECODE2_U_ECXERI_U_ECXAO_U_ECXECE_U_ECXHNC_U_ECXMIL_U_ECXEST_U_ECXIR_U_ECXSCRX
"RTN","ECXOPRX1",44,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,^ECX(ECFILE,EC7,2)=$G(ECODE2),ECRN=ECRN+1
"RTN","ECXOPRX1",45,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXOPRX1",46,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXOPRX1",47,0)
 Q
"RTN","ECXPIVDN")
0^8^B64275296^B62997730
"RTN","ECXPIVDN",1,0)
ECXPIVDN ;ALB/JAP,BIR/DMA,CML,PTD-Extract from IV EXTRACT DATA File (#728.113) ; 4/19/2007
"RTN","ECXPIVDN",2,0)
 ;;3.0;DSS EXTRACTS;**10,11,8,13,24,33,39,46,49,71,84,96,92,107**;Dec 22, 1997;Build 9
"RTN","ECXPIVDN",3,0)
START ; start package specific extract
"RTN","ECXPIVDN",4,0)
 N DIC,DA,DR,DIQ,DFN,ECXNPRFI,ECXPHA
"RTN","ECXPIVDN",5,0)
 S QFLG=0
"RTN","ECXPIVDN",6,0)
 I '$D(ECINST) D
"RTN","ECXPIVDN",7,0)
 .S ECINST=+$P(^ECX(728,1,0),U) K ECXDIC S DA=ECINST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXPIVDN",8,0)
 .D EN^DIQ1 S ECINST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXPIVDN",9,0)
 S ECED=ECED+.3
"RTN","ECXPIVDN",10,0)
 K ^TMP($J,"A"),^TMP($J,"S")
"RTN","ECXPIVDN",11,0)
 S ECD=ECSD1
"RTN","ECXPIVDN",12,0)
 F  S ECD=$O(^ECX(728.113,"A",ECD)),DFN=0 Q:'ECD  Q:ECD>ECED  Q:QFLG  F  S DFN=$O(^ECX(728.113,"A",ECD,DFN)),ON=0  Q:'DFN  F  S ON=$O(^ECX(728.113,"A",ECD,DFN,ON)),DA=0 Q:'ON  K ^TMP($J,"A"),^TMP($J,"S") S ECVOL=0 D  Q:QFLG
"RTN","ECXPIVDN",13,0)
 .S ECXERR=0 D PAT(DFN,ECD,.ECXERR)
"RTN","ECXPIVDN",14,0)
 .Q:ECXERR
"RTN","ECXPIVDN",15,0)
 .F  S DA=$O(^ECX(728.113,"A",ECD,DFN,ON,DA)) Q:'DA  Q:QFLG  I $D(^ECX(728.113,DA,0)) S EC=^(0) D  Q:QFLG
"RTN","ECXPIVDN",16,0)
 ..S DRG=$P(EC,U,4) I $P(EC,U,8)]"" D
"RTN","ECXPIVDN",17,0)
 ...I '$D(^TMP($J,"A",DRG)) S ^(DRG)=$P(EC,U,7,8),^(DRG,1)=0,^(2)=$P(EC,U,12)
"RTN","ECXPIVDN",18,0)
 ...S ^(1)=^TMP($J,"A",DRG,1)+$S($P(EC,U,6)=1:1,$P(EC,U,6)=4:0,1:-1)
"RTN","ECXPIVDN",19,0)
 ..I $P(EC,U,9) D
"RTN","ECXPIVDN",20,0)
 ...I '$D(^TMP($J,"S",DRG)) S ^(DRG)=$P(EC,U,9)_"^ML",^(DRG,1)=0,^(2)=$P(EC,U,12),ECVOL=$P(EC,U,9)+ECVOL
"RTN","ECXPIVDN",21,0)
 ...S ^(1)=^TMP($J,"S",DRG,1)+$S($P(EC,U,6)=1:1,$P(EC,U,6)=4:0,1:-1)
"RTN","ECXPIVDN",22,0)
 ..S ECTYP=$P(EC,U,11),ECTOTC=0,ECDTTM=$$ECXTIME^ECXUTL($P(EC,U,5))
"RTN","ECXPIVDN",23,0)
 .;looped thru all DAs for this order - now put it together
"RTN","ECXPIVDN",24,0)
 .;leave the next line in case the decision is made to send volume designations
"RTN","ECXPIVDN",25,0)
 .;I ECTYP="H" S ECTYP=ECTYP_$S(ECVOL'>1000:1,ECVOL'>2000:2,1:3)
"RTN","ECXPIVDN",26,0)
 .S ECXDSSI=""
"RTN","ECXPIVDN",27,0)
 .;loop thru tmp global and call pharmacy drug file (#50) api
"RTN","ECXPIVDN",28,0)
 .F SA="S","A" S DRG="" F  S DRG=$O(^TMP($J,SA,DRG)) Q:DRG=""  S ECXPHA="",ECXPHA=$$PHAAPI^ECXUTL5(DRG) I $P(ECXPHA,U)'="" D STUFF Q:QFLG
"RTN","ECXPIVDN",29,0)
 K ^TMP($J),CLIN,DA,DFN,DIC,DIK,DRG,ON,SA,X,Y,P1,P3
"RTN","ECXPIVDN",30,0)
 Q
"RTN","ECXPIVDN",31,0)
STUFF ;get data
"RTN","ECXPIVDN",32,0)
 N ECORDST
"RTN","ECXPIVDN",33,0)
 S ECST=^TMP($J,SA,DRG),ECXCNT=^(DRG,1),ECXCOST=^(2),ECXCOST=ECXCOST*ECXCNT,ECVACL=$P(ECXPHA,U,2),ECORDST=""
"RTN","ECXPIVDN",34,0)
 ;if outpatient get division from iv rm; get dss identifier for clinic
"RTN","ECXPIVDN",35,0)
 I ECXA="O" D
"RTN","ECXPIVDN",36,0)
 .;- Only set ward to .5 if outpatient (but NOT observation patient)
"RTN","ECXPIVDN",37,0)
 .I $G(ECXW)="" S ECXW=.5
"RTN","ECXPIVDN",38,0)
 .I $P(EC,U,15) S ECIVRM=$P(EC,U,15),ECXDIV=$$PSJ59P5^ECXUTL5(ECIVRM)
"RTN","ECXPIVDN",39,0)
 .S CLIN=+$P(EC,U,13),(ECXP1,ECXP2)="000",ECXCL=$G(^ECX(728.44,CLIN,0)) Q:ECXCL=""
"RTN","ECXPIVDN",40,0)
 .S ECSC=$P(ECXCL,U,4),ECCSC=$P(ECXCL,U,5)
"RTN","ECXPIVDN",41,0)
 .I ECSC="" S ECSC=$P(ECXCL,U,2),ECCSC=$P(ECXCL,U,3)
"RTN","ECXPIVDN",42,0)
 .I ECSC S ECXP1=$$RJ^XLFSTR(ECSC,3,0),ECXP2=$$RJ^XLFSTR(ECCSC,3,0)
"RTN","ECXPIVDN",43,0)
 .I ECSC="" S ECSC=$P($G(^SC(ECXCL,0)),U,7),ECCSC=$P($G(^SC(ECXCL,0)),U,18) I ECSC D
"RTN","ECXPIVDN",44,0)
 ..S ECXP1=$P($G(^DIC(40.7,ECSC,0)),U,2) S:ECCSC]"" ECXP2=$P($G(^DIC(40.7,ECCSC,0)),U,2)
"RTN","ECXPIVDN",45,0)
 ..S ECXP1=$$RJ^XLFSTR(ECXP1,3,0),ECXP2=$$RJ^XLFSTR(ECXP2,3,0)
"RTN","ECXPIVDN",46,0)
 .S ECXDSSI=ECXP1_ECXP2
"RTN","ECXPIVDN",47,0)
 .I ECXLOGIC>2003 D
"RTN","ECXPIVDN",48,0)
 ..I "^18^23^24^36^41^65^94^"[("^"_ECXTS_"^") S ECXDSSI=$$TSMAP^ECXUTL4(ECXTS)
"RTN","ECXPIVDN",49,0)
 S ECINV=$P(ECXPHA,U,4),ECINV=$S(ECINV["I":"I",1:""),ECST=ECXCNT*ECST_" "_$P(ECST,U,2)
"RTN","ECXPIVDN",50,0)
 S ECNDC=$P(ECXPHA,U,3),ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXPIVDN",51,0)
 S P1=$P(ECXPHA,U,5),P3=$P(ECXPHA,U,6)
"RTN","ECXPIVDN",52,0)
 S X="PSNAPIS" X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXPIVDN",53,0)
 I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXPIVDN",54,0)
 ;- Ordering provider ("2"_provider)
"RTN","ECXPIVDN",55,0)
 S ECXORDPR=$S(+$P(EC,U,10):"2"_$P(EC,U,10),1:""),ECXOPNPI=""
"RTN","ECXPIVDN",56,0)
 S ECXORDDT=$P(EC,U,16) ;- Ordering date
"RTN","ECXPIVDN",57,0)
 ;- Requesting physician (null for FY2002)
"RTN","ECXPIVDN",58,0)
 S ECXRPHY=""
"RTN","ECXPIVDN",59,0)
 ;- Department and National Prod Division
"RTN","ECXPIVDN",60,0)
 S ECXDSSD="" ;dss department use postponed $$IVP^ECXDEPT(ECXDIV)
"RTN","ECXPIVDN",61,0)
 N ECXPDIV S ECXPDIV=$$GETDIV^ECXDEPT(ECXDIV)
"RTN","ECXPIVDN",62,0)
 ;- Observation patient indicator (yes/no)
"RTN","ECXPIVDN",63,0)
 S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS,ECXDSSI)
"RTN","ECXPIVDN",64,0)
 ; - Ordering Date, Ordering Stop Code
"RTN","ECXPIVDN",65,0)
 S ECXORDST="" I ECXA="O" D
"RTN","ECXPIVDN",66,0)
 .S ECXORDST=$$DOIVPO^ECXUTL5(DFN,ON)
"RTN","ECXPIVDN",67,0)
 .I ECXOBS="NO" S ECORDST="160"
"RTN","ECXPIVDN",68,0)
 .I ECXOBS="YES" S ECORDST=$P($G(^ECX(727.831,+ECXTS,0)),U,6)
"RTN","ECXPIVDN",69,0)
 ;- If no encounter number don't file record
"RTN","ECXPIVDN",70,0)
 S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADM,ECD,ECXTS,ECXOBS,ECHEAD,ECORDST,)
"RTN","ECXPIVDN",71,0)
 ;get BCMA data
"RTN","ECXPIVDN",72,0)
 S (ECXBCDD,ECXBCDG,ECXBCUA,ECXBCIF)=""
"RTN","ECXPIVDN",73,0)
 ;get ordering provider person class
"RTN","ECXPIVDN",74,0)
 S ECXOPPC=$$PRVCLASS^ECXUTL($E(ECXORDPR,2,999),ECXORDDT)
"RTN","ECXPIVDN",75,0)
 ;set national patient record flag if exist
"RTN","ECXPIVDN",76,0)
 S ECXDFN=DFN D NPRF^ECXUTL5 K ECXDFN
"RTN","ECXPIVDN",77,0)
 D:ECXENC'="" FILE K P1,P3
"RTN","ECXPIVDN",78,0)
 Q
"RTN","ECXPIVDN",79,0)
PAT(ECXDFN,ECXDATE,ECXERR) ;get patient demographics, primary care, and inpatient data
"RTN","ECXPIVDN",80,0)
 N X
"RTN","ECXPIVDN",81,0)
 S (ECXCAT,ECXSTAT,ECXPRIOR,ECXSBGRP)=""
"RTN","ECXPIVDN",82,0)
 ;get patient data if saved
"RTN","ECXPIVDN",83,0)
 I $D(^TMP($J,"ECXP",ECXDFN)) D
"RTN","ECXPIVDN",84,0)
 .S PT=^TMP($J,"ECXP",ECXDFN),ECXPNM=$P(PT,U),ECXSSN=$P(PT,U,2),ECXMPI=$P(PT,U,3)
"RTN","ECXPIVDN",85,0)
 .S ECXDOB=$P(PT,U,4),ECXELIG=$P(PT,U,5),ECXSEX=$P(PT,U,6),ECXSTATE=$P(PT,U,7),ECXCNTY=$P(PT,U,8),ECXZIP=$P(PT,U,9)
"RTN","ECXPIVDN",86,0)
 .S ECXVET=$P(PT,U,10),ECXPOS=$P(PT,U,11),ECXPST=$P(PT,U,12),ECXPLOC=$P(PT,U,13),ECXRST=$P(PT,U,14),ECXAST=$P(PT,U,15)
"RTN","ECXPIVDN",87,0)
 .S ECXAOL=$P(PT,U,16),ECXPHI=$P(PT,U,17),ECXMST=$P(PT,U,18),ECXENRL=$P(PT,U,19),ECXCNHU=$P(PT,U,20),ECXCAT=$P(PT,U,21)
"RTN","ECXPIVDN",88,0)
 .S ECXSTAT=$P(PT,U,22),ECXPRIOR=$P(PT,U,23),ECXHNCI=$P(PT,U,24),ECXETH=$P(PT,U,25),ECXRC1=$P(PT,U,26),ECXMTST=$P(PT,U,27)
"RTN","ECXPIVDN",89,0)
 .S PT1=$G(^TMP($J,"ECXP",ECXDFN,1)),ECXERI=$P(PT1,U),ECXEST=$P(PT1,U,2)
"RTN","ECXPIVDN",90,0)
 .I $$ENROLLM^ECXUTL2(ECXDFN)
"RTN","ECXPIVDN",91,0)
 ;set patient data
"RTN","ECXPIVDN",92,0)
 I '$D(^TMP($J,"ECXP",ECXDFN)) D  Q:'OK
"RTN","ECXPIVDN",93,0)
 .K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,$P(ECXDATE,"."),"1;2;3;5",.ECXPAT)
"RTN","ECXPIVDN",94,0)
 .I 'OK K ECXPAT S ECXERR=1 Q
"RTN","ECXPIVDN",95,0)
 .S ECXPNM=ECXPAT("NAME"),ECXSSN=ECXPAT("SSN"),ECXMPI=ECXPAT("MPI"),ECXDOB=ECXPAT("DOB"),ECXELIG=ECXPAT("ELIG"),ECXSEX=ECXPAT("SEX")
"RTN","ECXPIVDN",96,0)
 .S ECXSTATE=ECXPAT("STATE"),ECXCNTY=ECXPAT("COUNTY"),ECXZIP=ECXPAT("ZIP"),ECXVET=ECXPAT("VET")
"RTN","ECXPIVDN",97,0)
 .S ECXPOS=ECXPAT("POS"),ECXPST=ECXPAT("POW STAT"),ECXPLOC=ECXPAT("POW LOC"),ECXRST=ECXPAT("IR STAT")
"RTN","ECXPIVDN",98,0)
 .S ECXAST=ECXPAT("AO STAT"),ECXAOL=ECXPAT("AOL"),ECXPHI=ECXPAT("PHI"),ECXMST=ECXPAT("MST STAT")
"RTN","ECXPIVDN",99,0)
 .S ECXENRL=ECXPAT("ENROLL LOC"),ECXMTST=ECXPAT("MEANS"),ECXEST=ECXPAT("EC STAT")
"RTN","ECXPIVDN",100,0)
 .S ECXCNHU=$$CNHSTAT^ECXUTL4(ECXDFN) ;get CNHU status
"RTN","ECXPIVDN",101,0)
 .;get enrollment data (category, status and priority)
"RTN","ECXPIVDN",102,0)
 .I $$ENROLLM^ECXUTL2(ECXDFN)
"RTN","ECXPIVDN",103,0)
 .S ECXHNCI=$$HNCI^ECXUTL4(ECXDFN) ;Head and Neck Cancer Indicator
"RTN","ECXPIVDN",104,0)
 .; - Race and Ethnicity
"RTN","ECXPIVDN",105,0)
 .S ECXETH=ECXPAT("ETHNIC"),ECXRC1=ECXPAT("RACE1")
"RTN","ECXPIVDN",106,0)
 .S ECXERI=ECXPAT("ERI") ;emergency response indicator (FEMA)
"RTN","ECXPIVDN",107,0)
 .;save for later
"RTN","ECXPIVDN",108,0)
 .S ^TMP($J,"ECXP",ECXDFN)=ECXPNM_U_ECXSSN_U_ECXMPI_U_ECXDOB_U_ECXELIG_U_ECXSEX_U_ECXSTATE_U_ECXCNTY_U_ECXZIP_U_ECXVET_U_ECXPOS_U_ECXPST_U_ECXPLOC_U_ECXRST_U_ECXAST
"RTN","ECXPIVDN",109,0)
 .S ^TMP($J,"ECXP",ECXDFN)=^TMP($J,"ECXP",ECXDFN)_U_ECXAOL_U_ECXPHI_U_ECXMST_U_ECXENRL_U_ECXCNHU_U_ECXCAT_U_ECXSTAT_U_ECXPRIOR_U_ECXHNCI_U_ECXETH_U_ECXRC1_U_ECXMTST
"RTN","ECXPIVDN",110,0)
 .S ^TMP($J,"ECXP",ECXDFN,1)=ECXERI_U_ECXEST
"RTN","ECXPIVDN",111,0)
 ;get primary care data
"RTN","ECXPIVDN",112,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,$P(ECXDATE,"."))
"RTN","ECXPIVDN",113,0)
 S ECPTTM=$P(X,U,1),ECPTPR=$P(X,U,2),ECCLAS=$P(X,U,3),ECPTNPI=$P(X,U,4),ECASPR=$P(X,U,5),ECCLAS2=$P(X,U,6),ECASNPI=$P(X,U,7)
"RTN","ECXPIVDN",114,0)
 ;get inpatient data
"RTN","ECXPIVDN",115,0)
 S (ECXA,ECXMN,ECXADM,ECXTS,ECXW,ECXDIV)="",X=$$INP^ECXUTL2(ECXDFN,ECXDATE)
"RTN","ECXPIVDN",116,0)
 S ECXA=$P(X,U),ECXMN=$P(X,U,2),ECXTS=$P(X,U,3),ECXADM=$P(X,U,4),W=$P(X,U,9),ECXDOM=$P(X,U,10),ECXW=$P(W,";"),ECXDIV=$P(W,";",2)
"RTN","ECXPIVDN",117,0)
 Q
"RTN","ECXPIVDN",118,0)
FILE ;file record
"RTN","ECXPIVDN",119,0)
 ;node0
"RTN","ECXPIVDN",120,0)
 ;fac^dfn^ssn^name^i/o^day^va class^qty^ward^cost^movement #^treat spec^ndc^investigational^iv dispensing fee^new feeder key^total doses^
"RTN","ECXPIVDN",121,0)
 ;primary care team^primary care provider^ivp time^adm date^adm time^dss identifier
"RTN","ECXPIVDN",122,0)
 ;node1
"RTN","ECXPIVDN",123,0)
 ;mpi^dss dept^pc provider npi^pc prov person class^assoc pc provider^assoc pc prov person class^assoc pc prov npi^dom^obs pat ind^enc num^
"RTN","ECXPIVDN",124,0)
 ;ord pr^ordering stop code^ord dt^req phys^nat prod division^means tst^elig^dob^sex^state^county^zip+4^vet^period of svc^pow stat^pow loc^ir stat^ao stat^
"RTN","ECXPIVDN",125,0)
 ;ao loc^purple heart ind.^mst stat^enrollment loc^enrollment cat^enrollment stat^enrollment prior^cnh/sh stat^ord pr npi
"RTN","ECXPIVDN",126,0)
 ;node2
"RTN","ECXPIVDN",127,0)
 ;head & neck cancer ind.^ethnicity^race1^bcma drug dispensed^bcma dose given^bcma unit of administration^bcma ICU flag^
"RTN","ECXPIVDN",128,0)
 ;ordering provider person class^^user enrollee ECXUESTA^patient type ECXPTYPE^combat vet elig ECXCVE^
"RTN","ECXPIVDN",129,0)
 ;combat vet elig end date ECXCVEDT^enc cv eligible ECXCVENC^national patient record flag ECXNPRFI^emerg resp indic(FEMA) ECXERI^
"RTN","ECXPIVDN",130,0)
 ;environ contamin ECXEST
"RTN","ECXPIVDN",131,0)
 N DA,DIK
"RTN","ECXPIVDN",132,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXPIVDN",133,0)
 S ECODE=EC7_U_EC23_U_ECXDIV_U_DFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXPIVDN",134,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECD,ECXYM)_U_ECVACL_U_ECXCNT_U_ECXW_U
"RTN","ECXPIVDN",135,0)
 ;convert specialty to PTF Code for transmission
"RTN","ECXPIVDN",136,0)
 N ECXDATA
"RTN","ECXPIVDN",137,0)
 S ECXDATA=$$TSDATA^DGACT(42.4,+ECXTS,.ECXDATA)
"RTN","ECXPIVDN",138,0)
 S ECXTS=$G(ECXDATA(7))
"RTN","ECXPIVDN",139,0)
 ;done
"RTN","ECXPIVDN",140,0)
 S ECODE=ECODE_ECXCOST_U_ECXMN_U_ECXTS_U_ECNDC_U_ECINV_U_ECTYP_U_ECNFC_U
"RTN","ECXPIVDN",141,0)
 S ECODE=ECODE_ECST_U_ECPTTM_U_ECPTPR_U_ECDTTM_U_$$ECXDATE^ECXUTL(ECXADM,ECXYM)_U_$$ECXTIME^ECXUTL(ECXADM)_U_ECXDSSI_U
"RTN","ECXPIVDN",142,0)
 ;if outpat and not observ patient, admit date="" and admit time="000000"
"RTN","ECXPIVDN",143,0)
 I ECXA="O",(ECXOBS="NO") S $P(ECODE,U,24)="",$P(ECODE,U,25)="000000"
"RTN","ECXPIVDN",144,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECPTNPI_U_ECCLAS_U_ECASPR_U_ECCLAS2_U_ECASNPI_U_ECXDOM_U_ECXOBS_U_ECXENC_U_ECXORDPR_U
"RTN","ECXPIVDN",145,0)
 S ECODE1=ECODE1_ECXORDST_U_$$ECXDATE^ECXUTL(ECXORDDT,ECXYM)_U_ECXRPHY_U_ECXPDIV_U_ECXMTST_U_ECXELIG_U_ECXDOB_U
"RTN","ECXPIVDN",146,0)
 S ECODE1=ECODE1_ECXSEX_U_ECXSTATE_U_ECXCNTY_U_ECXZIP_U_ECXVET_U_ECXPOS_U_ECXPST_U_ECXPLOC_U_ECXRST_U_ECXAST_U
"RTN","ECXPIVDN",147,0)
 S ECODE1=ECODE1_ECXAOL_U_ECXPHI_U_ECXMST_U_ECXENRL_U_ECXCAT_U
"RTN","ECXPIVDN",148,0)
 S ECODE1=ECODE1_ECXSTAT_U_$S(ECXLOGIC<2005:ECXPRIOR,1:"")_U_ECXCNHU_U_ECXOPNPI_U
"RTN","ECXPIVDN",149,0)
 S ECODE2=ECXHNCI_U_ECXETH_U_ECXRC1
"RTN","ECXPIVDN",150,0)
 I ECXLOGIC>2003 D
"RTN","ECXPIVDN",151,0)
 .S ECODE2=ECODE2_U_ECXBCDD_U_ECXBCDG_U_ECXBCUA_U_ECXBCIF_U_ECXOPPC
"RTN","ECXPIVDN",152,0)
 I ECXLOGIC>2004 S ECODE2=ECODE2_U_U_ECXPRIOR_ECXSBGRP_U_ECXUESTA_U_ECXPTYPE_U_ECXCVE_U_ECXCVEDT_U_ECXCVENC_U_ECXNPRFI
"RTN","ECXPIVDN",153,0)
 I ECXLOGIC>2006 S ECODE2=ECODE2_U_ECXERI_U_ECXEST
"RTN","ECXPIVDN",154,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1
"RTN","ECXPIVDN",155,0)
 S ^ECX(ECFILE,EC7,2)=ECODE2,ECRN=ECRN+1
"RTN","ECXPIVDN",156,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXPIVDN",157,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXPIVDN",158,0)
 Q
"RTN","ECXPIVDN",159,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXPIVDN",160,0)
 S ECHEAD="IVP"
"RTN","ECXPIVDN",161,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXPIVDN",162,0)
 ;variables ecver and ecrtn will be reset in routine ecxtrac if appropriate
"RTN","ECXPIVDN",163,0)
 S ECVER=7
"RTN","ECXPIVDN",164,0)
 Q
"RTN","ECXPIVDN",165,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXPIVDN",166,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXSCXN")
0^10^B55157995^B53946151
"RTN","ECXSCXN",1,0)
ECXSCXN ;ALB/JAP  Clinic Extract ; 4/19/2007
"RTN","ECXSCXN",2,0)
 ;;3.0;DSS EXTRACTS;**24,27,29,30,31,32,33,39,46,49,52,71,84,92,107**;Dec 22, 1997;Build 9
"RTN","ECXSCXN",3,0)
 ;
"RTN","ECXSCXN",4,0)
BEG ;entry point from option
"RTN","ECXSCXN",5,0)
 D SETUP Q:ECFILE=""  D ^ECXTRAC,^ECXKILL
"RTN","ECXSCXN",6,0)
 Q
"RTN","ECXSCXN",7,0)
 ;
"RTN","ECXSCXN",8,0)
START ;entry point from taskmgr
"RTN","ECXSCXN",9,0)
 N DIC,EXNUM,I,LOCARR,OUT,P1,P2,P3,PROCESS,SOURCE,STOP,STAT,TOSEND
"RTN","ECXSCXN",10,0)
 N TIU,X,Y,ECXNPRFI
"RTN","ECXSCXN",11,0)
 F I=1:1:8 S @("ECXCPT"_I)=""
"RTN","ECXSCXN",12,0)
 F I=1:1:4 S @("ECXICD9"_I)=""
"RTN","ECXSCXN",13,0)
 S (OUT,QFLG,ECRN)=0,(ECXICD9P,ECXOBI)=""
"RTN","ECXSCXN",14,0)
 K ^TMP($J,"ECXS"),^TMP($J,"ECXCL")
"RTN","ECXSCXN",15,0)
 ;get ien for tiu in file #839.7
"RTN","ECXSCXN",16,0)
 S DIC="^PX(839.7,",DIC(0)="X",X="TEXT INTEGRATION UTILITIES"
"RTN","ECXSCXN",17,0)
 D ^DIC S TIU=+Y,ECED=ECED+.3,ECXCLIN=0 K DIC,Y
"RTN","ECXSCXN",18,0)
 ;get clinic default appt length, type, division
"RTN","ECXSCXN",19,0)
 F  S ECXCLIN=$O(^SC(ECXCLIN)) Q:'ECXCLIN  D
"RTN","ECXSCXN",20,0)
 .K LOCARR S DIC=44,DA=ECXCLIN,DR="2;3.5;1912",DIQ(0)="I",DIQ="LOCARR"
"RTN","ECXSCXN",21,0)
 .D EN^DIQ1
"RTN","ECXSCXN",22,0)
 .Q:$G(LOCARR(44,ECXCLIN,2,"I"))'="C"
"RTN","ECXSCXN",23,0)
 .S ALEN=+$G(LOCARR(44,ECXCLIN,1912,"I"))
"RTN","ECXSCXN",24,0)
 .S ^TMP($J,"ECXCL",ECXCLIN)=ALEN,ALEN=$$RJ^XLFSTR(ALEN,3,0)
"RTN","ECXSCXN",25,0)
 .S ^TMP($J,"ECXCL",ECXCLIN)=^TMP($J,"ECXCL",ECXCLIN)_"^"_ALEN_"^"_$G(LOCARR(44,ECXCLIN,2,"I"))_"^"_+$G(LOCARR(44,ECXCLIN,3.5,"I"))
"RTN","ECXSCXN",26,0)
 .D FEEDER^ECXSCX1(ECXCLIN,ECSD1,.P1,.P2,.P3,.TOSEND,.ECXDIV)
"RTN","ECXSCXN",27,0)
 .K P1,P2,P3,TOSEND,ECXDIV
"RTN","ECXSCXN",28,0)
 ;get from file #44 any no-shows & get encounters from #409.68
"RTN","ECXSCXN",29,0)
 D NOSHOW^ECXSCXN1(ECSD1,ECED),ENCNTR(ECSD1,ECED)
"RTN","ECXSCXN",30,0)
 ;send missing clinic msg
"RTN","ECXSCXN",31,0)
 D:$D(^TMP($J,"ECXS")) EN^ECXSCX1
"RTN","ECXSCXN",32,0)
 K ^TMP($J,"ECXS"),^TMP($J,"ECXCL")
"RTN","ECXSCXN",33,0)
 Q
"RTN","ECXSCXN",34,0)
 ;
"RTN","ECXSCXN",35,0)
ENCNTR(ECSD1,ECED) ;search file #409.68 for encounter data
"RTN","ECXSCXN",36,0)
 N CHKOUT,ECD,JJ,K,OUT,PNODE,PP,STAT,STOP,MDIV
"RTN","ECXSCXN",37,0)
 S ECD=ECSD1
"RTN","ECXSCXN",38,0)
 F  S ECD=$O(^SCE("B",ECD)) Q:('ECD!(ECD>ECED))!(QFLG)  S ECXIEN=0 D
"RTN","ECXSCXN",39,0)
 .F  S ECXIEN=$O(^SCE("B",ECD,ECXIEN)) Q:'ECXIEN  D  Q:QFLG
"RTN","ECXSCXN",40,0)
 ..Q:'$D(^SCE(ECXIEN,0))
"RTN","ECXSCXN",41,0)
 ..D INTPAT^ECXSCX2 K LOCARR S DIC=409.68,DA=ECXIEN
"RTN","ECXSCXN",42,0)
 ..S DR=".01;.02;.03;.04;.05;.06;.07;.08;.11;.12;.13",DIQ(0)="I",DIQ="LOCARR"
"RTN","ECXSCXN",43,0)
 ..D EN^DIQ1
"RTN","ECXSCXN",44,0)
 ..S ECXTI=$P($$FMTE^XLFDT(+$G(LOCARR(409.68,ECXIEN,.01,"I")),1),"@",2)
"RTN","ECXSCXN",45,0)
 ..S ECXTI=$E(($TR(ECXTI,":","")_"000000"),1,6)
"RTN","ECXSCXN",46,0)
 ..S:ECXTI="000000" ECXTI="000300" S MDIV=+$G(LOCARR(409.68,ECXIEN,.11,"I"))
"RTN","ECXSCXN",47,0)
 ..S STOP=+$G(LOCARR(409.68,ECXIEN,.03,"I"))
"RTN","ECXSCXN",48,0)
 ..S CHKOUT=+$G(LOCARR(409.68,ECXIEN,.07,"I"))
"RTN","ECXSCXN",49,0)
 ..S PROCESS=+$G(LOCARR(409.68,ECXIEN,.08,"I"))
"RTN","ECXSCXN",50,0)
 ..S STAT=$G(LOCARR(409.68,ECXIEN,.12,"I"))
"RTN","ECXSCXN",51,0)
 ..S ECXDFN=+$G(LOCARR(409.68,ECXIEN,.02,"I"))
"RTN","ECXSCXN",52,0)
 ..Q:(ECXDFN=0)!('CHKOUT)
"RTN","ECXSCXN",53,0)
 ..S:STAT="" STAT="ZZ" S STAT=";"_STAT_";"
"RTN","ECXSCXN",54,0)
 ..Q:";3;4;5;6;7;9;10;13;"[STAT
"RTN","ECXSCXN",55,0)
 ..Q:('STOP)!(PROCESS=4)!(+$G(LOCARR(409.68,ECXIEN,.06,"I")))
"RTN","ECXSCXN",56,0)
 ..S ECXDATE=+$G(LOCARR(409.68,ECXIEN,.01,"I"))
"RTN","ECXSCXN",57,0)
 ..S ECXCLIN=+$G(LOCARR(409.68,ECXIEN,.04,"I"))
"RTN","ECXSCXN",58,0)
 ..Q:$P($G(^TMP($J,"ECXCL",ECXCLIN)),U,3)'="C"
"RTN","ECXSCXN",59,0)
 ..S ECXVISIT=+$G(LOCARR(409.68,ECXIEN,.05,"I"))
"RTN","ECXSCXN",60,0)
 ..S ECXENEL=+$G(LOCARR(409.68,ECXIEN,.13,"I"))
"RTN","ECXSCXN",61,0)
 ..Q:'ECXVISIT
"RTN","ECXSCXN",62,0)
 ..S ECXERR=0
"RTN","ECXSCXN",63,0)
 ..D PAT1^ECXSCX2(ECXDFN,ECXDATE,.ECXERR) Q:ECXERR
"RTN","ECXSCXN",64,0)
 ..D FEEDER^ECXSCX1(ECXCLIN,ECSD1,.P1,.P2,.P3,.TOSEND,.ECXDIV)
"RTN","ECXSCXN",65,0)
 ..Q:TOSEND=6
"RTN","ECXSCXN",66,0)
 ..K LOCARR S DIC=40.7,DA=STOP,DR="1",DIQ(0)="I",DIQ="LOCARR" D EN^DIQ1
"RTN","ECXSCXN",67,0)
 ..S ECXSTOP=$$RJ^XLFSTR($G(LOCARR(40.7,STOP,1,"I")),3,0)
"RTN","ECXSCXN",68,0)
 ..;get date specific patient data
"RTN","ECXSCXN",69,0)
 ..D PAT2^ECXSCX2(ECXDFN,ECXDATE)
"RTN","ECXSCXN",70,0)
 ..;get national patient record flag if exist
"RTN","ECXSCXN",71,0)
 ..D NPRF^ECXUTL5
"RTN","ECXSCXN",72,0)
 ..;get visit specific data
"RTN","ECXSCXN",73,0)
 ..S ECXERR=0 D VISIT^ECXSCX1(ECXDFN,ECXVISIT,.ECXVIST,.ECXERR) Q:ECXERR
"RTN","ECXSCXN",74,0)
 ..F I=1:1:8 S @("ECXCPT"_I)=$G(ECXVIST("CPT"_I))
"RTN","ECXSCXN",75,0)
 ..S ECXICD9P=$G(ECXVIST("ICD9P"))
"RTN","ECXSCXN",76,0)
 ..F I=1:1:4 S @("ECXICD9"_I)=$G(ECXVIST("ICD9"_I))
"RTN","ECXSCXN",77,0)
 ..S SOURCE=ECXVIST("SOURCE"),ECXAO=ECXVIST("AO"),ECXIR=ECXVIST("IR")
"RTN","ECXSCXN",78,0)
 ..S ECXMIL=ECXVIST("MST"),ECXPROV=ECXVIST("PROV")
"RTN","ECXSCXN",79,0)
 ..S ECXPROVP=ECXVIST("PROV CLASS"),ECXPROVN=ECXVIST("PROV NPI")
"RTN","ECXSCXN",80,0)
 ..S ECXECE=ECXVIST("PGE"),ECXHNC=ECXVIST("HNC")
"RTN","ECXSCXN",81,0)
 ..K LOCARR S DIC=8,DA=ECXENEL,DR="8",DIQ(0)="I",DIQ="LOCARR" D EN^DIQ1
"RTN","ECXSCXN",82,0)
 ..S ECXENEL=+$G(LOCARR(8,ECXENEL,8,"I"))
"RTN","ECXSCXN",83,0)
 ..S:ECXENEL ECXENEL=$$ELIG^ECXUTL3(ECXENEL,ECXSVC)
"RTN","ECXSCXN",84,0)
 ..S ECXCBOC=$S(MDIV'="":$$CBOC^ECXSCX2(.MDIV),1:"")  ;is cboc facility?
"RTN","ECXSCXN",85,0)
 ..;setup feeder key and file in extract records
"RTN","ECXSCXN",86,0)
 ..S (ECXKEY,ECXDSSD)=""
"RTN","ECXSCXN",87,0)
 ..;xray (105) or lab (108)
"RTN","ECXSCXN",88,0)
 ..I (ECXSTOP=105)!(ECXSTOP=108) D  Q
"RTN","ECXSCXN",89,0)
 ...S ECXKEY=ECXSTOP_"00003000000",ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS,ECXKEY)
"RTN","ECXSCXN",90,0)
 ...S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,ECXDATE,ECXTS,ECXOBS,ECHEAD,ECXKEY,) D:ECXENC'="" FILE       ;- Don't file rec if no encounter num
"RTN","ECXSCXN",91,0)
 ..;appointments
"RTN","ECXSCXN",92,0)
 ..I PROCESS=1 D  Q     ;get appt length
"RTN","ECXSCXN",93,0)
 ...S (ALEN,JJ,OUT)=0
"RTN","ECXSCXN",94,0)
 ...F  S JJ=$O(^SC(ECXCLIN,"S",ECXDATE,JJ)) Q:('JJ)!(OUT)  S K=0 D
"RTN","ECXSCXN",95,0)
 ....F  S K=$O(^SC(ECXCLIN,"S",ECXDATE,JJ,K)) Q:('K)!(OUT)  D
"RTN","ECXSCXN",96,0)
 .....S ECXOBI=$G(^SC(ECXCLIN,"S",ECXDATE,JJ,K,"OB")),PP=$P($G(^SC(ECXCLIN,"S",ECXDATE,JJ,K,0)),U)
"RTN","ECXSCXN",97,0)
 .....S:PP=ECXDFN OUT=1,ALEN=$P(^(0),U,2),ALEN=$$RJ^XLFSTR(ALEN,3,0)
"RTN","ECXSCXN",98,0)
 .....S:+ALEN=0 ALEN=$P($G(^TMP($J,"ECXCL",ECXCLIN)),U,2)
"RTN","ECXSCXN",99,0)
 ....S ECXSTOP=P1
"RTN","ECXSCXN",100,0)
 ....S PNODE=$G(^DPT(ECXDFN,"S",ECXDATE,0)),ECXPVST=$P(PNODE,U,7),ECXATYP=$P(PNODE,U,16)  ;Get purpose of visit & appt type
"RTN","ECXSCXN",101,0)
 ....I TOSEND'=3 D
"RTN","ECXSCXN",102,0)
 .....S ECXKEY=P1_P2_ALEN_P3_"0",ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS,ECXKEY)
"RTN","ECXSCXN",103,0)
 .....S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,ECXDATE,ECXTS,ECXOBS,ECHEAD,ECXKEY,) D:ECXENC'="" FILE
"RTN","ECXSCXN",104,0)
 ....I TOSEND=3 D
"RTN","ECXSCXN",105,0)
 .....S ECXKEY=P1_"000"_ALEN_P3_"0",ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS,ECXKEY)
"RTN","ECXSCXN",106,0)
 .....S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,ECXDATE,ECXTS,ECXOBS,ECHEAD,ECXKEY,) D:ECXENC'="" FILE
"RTN","ECXSCXN",107,0)
 ....I TOSEND=3 D
"RTN","ECXSCXN",108,0)
 .....S ECXKEY=P2_"000"_ALEN_P3_"0",ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS,ECXKEY)
"RTN","ECXSCXN",109,0)
 .....S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,ECXDATE,ECXTS,ECXOBS,ECHEAD,ECXKEY,) D:ECXENC'="" FILE
"RTN","ECXSCXN",110,0)
 ..I PROCESS=2 D  Q
"RTN","ECXSCXN",111,0)
 ...S ALEN=0
"RTN","ECXSCXN",112,0)
 ...I SOURCE=TIU S ALEN=$P($G(^TMP($J,"ECXCL",ECXCLIN)),U,2)
"RTN","ECXSCXN",113,0)
 ...S:+ALEN=0 ALEN="030" S ECXKEY=P1_P2_ALEN_P3_"0",ECXSTOP=P1
"RTN","ECXSCXN",114,0)
 ...S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS,ECXKEY)
"RTN","ECXSCXN",115,0)
 ...S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,ECXDATE,ECXTS,ECXOBS,ECHEAD,ECXKEY,) D:ECXENC'="" FILE
"RTN","ECXSCXN",116,0)
 ..;dispositions
"RTN","ECXSCXN",117,0)
 ..I PROCESS=3 D  Q
"RTN","ECXSCXN",118,0)
 ...S ECXKEY=ECXSTOP_"47906000000",ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS,ECXKEY)
"RTN","ECXSCXN",119,0)
 ...S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,ECXDATE,ECXTS,ECXOBS,ECHEAD,ECXKEY,) D:ECXENC'="" FILE
"RTN","ECXSCXN",120,0)
 Q
"RTN","ECXSCXN",121,0)
 ;
"RTN","ECXSCXN",122,0)
FILE ;record setup for file #727.827
"RTN","ECXSCXN",123,0)
 N STR
"RTN","ECXSCXN",124,0)
 S ECXPDIV=$$GETDIV^ECXDEPT(ECXDIV)  ; Get production division
"RTN","ECXSCXN",125,0)
 S EC7=$O(^ECX(727.827,999999999),-1),EC7=EC7+1
"RTN","ECXSCXN",126,0)
 S STR(0)=EC7_U_EC23_U_ECXDIV_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXSCXN",127,0)
 S STR(0)=STR(0)_$$ECXDATE^ECXUTL(ECXDATE,ECXYM)_U_ECXKEY_U_ECXOBI_U
"RTN","ECXSCXN",128,0)
 ;convert specialty to PTF Code for transmission
"RTN","ECXSCXN",129,0)
 N ECXDATA
"RTN","ECXSCXN",130,0)
 S ECXDATA=$$TSDATA^DGACT(42.4,+ECXTS,.ECXDATA)
"RTN","ECXSCXN",131,0)
 S ECXTS=$G(ECXDATA(7))
"RTN","ECXSCXN",132,0)
 ;done
"RTN","ECXSCXN",133,0)
 S STR(0)=STR(0)_ECXCLIN_U_ECXTS_U_ECXTI_U_ECPTTM_U_ECPTPR_U_ECCLAS_U
"RTN","ECXSCXN",134,0)
 S STR(0)=STR(0)_ECXPROV_U_ECXPROVP_U_ECXCPT1_U_ECXCPT2_U_ECXCPT3_U
"RTN","ECXSCXN",135,0)
 S STR(0)=STR(0)_ECXCPT4_U_ECXCPT5_U
"RTN","ECXSCXN",136,0)
 S STR(1)=ECXCPT6_U_ECXCPT7_U_ECXCPT8_U_ECXICD9P_U_ECXICD91_U_ECXICD92_U
"RTN","ECXSCXN",137,0)
 S STR(1)=STR(1)_ECXICD93_U_ECXICD94_U_ECXDOB_U_ECXELIG_U_ECXVET_U
"RTN","ECXSCXN",138,0)
 S STR(1)=STR(1)_ECXRACE_U_ECXPST_U_ECXPLOC_U_ECXRST_U_ECXIR_U_ECXAST_U
"RTN","ECXSCXN",139,0)
 S STR(1)=STR(1)_ECXAO_U_ECXMPI_U_ECXDSSD_U_ECXSEX_U_ECXZIP_U
"RTN","ECXSCXN",140,0)
 S STR(1)=STR(1)_$G(ECXPCPNP)_U_$G(ECXNPIPR)_U_ECXENEL_U_ECXMST_U
"RTN","ECXSCXN",141,0)
 S STR(1)=STR(1)_ECXMIL_U_U_U_ECXENRL_U_ECXSTATE_U
"RTN","ECXSCXN",142,0)
 S STR(1)=STR(1)_ECXCNTY_U_ECASPR_U_ECCLAS2_U_ECASNPI_U_ECXDOM_U_ECXCAT_U
"RTN","ECXSCXN",143,0)
 S STR(2)=ECXSTAT_U_$S(ECXLOGIC<2005:ECXPRIOR,1:"")_U_ECXPHI_U_ECXPOS_U_ECXOBS_U_ECXENC_U
"RTN","ECXSCXN",144,0)
 S STR(2)=STR(2)_ECXAOL_U_ECXPDIV_U_ECXATYP_U_ECXPVST_U_ECXMTST_U
"RTN","ECXSCXN",145,0)
 S STR(2)=STR(2)_ECXHNCI_U_ECXETH_U_ECXRC1
"RTN","ECXSCXN",146,0)
 I ECXLOGIC>2003 S STR(2)=STR(2)_U_ECXCBOC
"RTN","ECXSCXN",147,0)
 I ECXLOGIC>2004 S STR(2)=STR(2)_U_U_ECXPRIOR_ECXSBGRP_U_ECXUESTA_U_ECXPTYPE_U_ECXCVE_U_ECXCVEDT_U_ECXCVENC_U_ECXNPRFI
"RTN","ECXSCXN",148,0)
 I ECXLOGIC>2005 S STR(2)=STR(2)_U_ECXEST_U_ECXECE
"RTN","ECXSCXN",149,0)
 I ECXLOGIC>2006 S STR(2)=STR(2)_U_ECXERI_U_ECXHNC
"RTN","ECXSCXN",150,0)
 D FILE2^ECXSCX2(727.827,EC7,.STR)
"RTN","ECXSCXN",151,0)
 S ECRN=ECRN+1,$P(^ECX(727.827,0),U,3)=EC7
"RTN","ECXSCXN",152,0)
 Q
"RTN","ECXSCXN",153,0)
 ;
"RTN","ECXSCXN",154,0)
SETUP ;set required input for ECXTRAC
"RTN","ECXSCXN",155,0)
 S ECHEAD="CLI"
"RTN","ECXSCXN",156,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXSCXN",157,0)
 Q
"RTN","ECXTRT")
0^1^B58970453^B56480766
"RTN","ECXTRT",1,0)
ECXTRT ;ALB/JAP,BIR/DMA,CML,PTD-Treating Specialty Change Extract ; 04/12/2007
"RTN","ECXTRT",2,0)
 ;;3.0;DSS EXTRACTS;**1,8,17,24,33,35,39,46,49,84,107**;Dec 22, 1997;Build 9
"RTN","ECXTRT",3,0)
BEG ;entry point from option
"RTN","ECXTRT",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXTRT",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXTRT",6,0)
 Q
"RTN","ECXTRT",7,0)
 ;
"RTN","ECXTRT",8,0)
START ; start package specific extract
"RTN","ECXTRT",9,0)
 N LOC,SPC,TRT,WRD
"RTN","ECXTRT",10,0)
 S QFLG=0
"RTN","ECXTRT",11,0)
 K ECXDD D FIELD^DID(405,.19,,"SPECIFIER","ECXDD")
"RTN","ECXTRT",12,0)
 S ECPRO=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD
"RTN","ECXTRT",13,0)
 K ^TMP($J,"ECXTMP") S TRT=0
"RTN","ECXTRT",14,0)
 F  S TRT=$O(^DIC(45.7,TRT)) Q:+TRT=0  S SPC=$P(^DIC(45.7,TRT,0),U,2),^TMP($J,"ECXTMP",TRT)=SPC
"RTN","ECXTRT",15,0)
 S ECED=ECED+.3,ECD=ECSD1
"RTN","ECXTRT",16,0)
 ;loop through type 6 movements to get treating specialty and provider changes
"RTN","ECXTRT",17,0)
 F  S ECD=$O(^DGPM("ATT6",ECD)),ECDA=0 Q:('ECD)!(ECD>ECED)!(QFLG)  F  S ECDA=$O(^DGPM("ATT6",ECD,ECDA)) Q:'ECDA  D  Q:QFLG
"RTN","ECXTRT",18,0)
 .I $D(^DGPM(ECDA,0)) S EC=^(0),ECXDFN=+$P(EC,U,3) D  Q:QFLG
"RTN","ECXTRT",19,0)
 ..S ECXMVD1=$P(EC,U),WRD=$P(EC,U,6)
"RTN","ECXTRT",20,0)
 ..;
"RTN","ECXTRT",21,0)
 ..;- Call sets ECXA (In/Out indicator)
"RTN","ECXTRT",22,0)
 ..Q:'$$PATDEM^ECXUTL2(ECXDFN,ECXMVD1,"1;",13)
"RTN","ECXTRT",23,0)
 ..S ECMT=$P(EC,U,18),ECXADM=$P(EC,U,14),ECXADT=$P($G(^DGPM(ECXADM,0)),U)
"RTN","ECXTRT",24,0)
 ..;skip the record if its the admission treat. spec. change for this episode of care
"RTN","ECXTRT",25,0)
 ..Q:ECXADM=$P(EC,U,24)
"RTN","ECXTRT",26,0)
 ..S (ECXLOS,ECXLOSA,ECXLOSP)="" S ECXDSSD=""
"RTN","ECXTRT",27,0)
 ..K LOC D SETLOC(ECXDFN,ECXADM,ECPRO,.LOC)
"RTN","ECXTRT",28,0)
 ..;get data for current (new) ts movement
"RTN","ECXTRT",29,0)
 ..S ECD1=9999999.9999999-ECXMVD1
"RTN","ECXTRT",30,0)
 ..D FINDLOC(ECD1,.LOC,.ECXSPCN,.ECXPRVN,.ECXATTN,.ECXMOVN,.ECXTRTN)
"RTN","ECXTRT",31,0)
 ..Q:ECXSPCN=""
"RTN","ECXTRT",32,0)
 ..S ECD2=$O(LOC(ECD1)) Q:ECD2=""
"RTN","ECXTRT",33,0)
 ..S ECXMVD2=9999999.9999999-ECD2
"RTN","ECXTRT",34,0)
 ..;get data for previous (losing) ts movement
"RTN","ECXTRT",35,0)
 ..D FINDLOC(ECD2,.LOC,.ECXSPCL,.ECXPRVL,.ECXATTL,.ECXMOVL,.ECXTRTL)
"RTN","ECXTRT",36,0)
 ..;if ts has changed, find los on losing ts
"RTN","ECXTRT",37,0)
 ..D:ECXTRTL'=ECXTRTN PREVTRT^ECXTRT1(.LOC,ECD1,ECD2,ECXTRTL,.ECXLOS)
"RTN","ECXTRT",38,0)
 ..;whether ts has changed or not, see if primary provider has changed
"RTN","ECXTRT",39,0)
 ..;dont bother if there's no data on current primary provider or no change in provider
"RTN","ECXTRT",40,0)
 ..D:(ECXPRVN'="")&(ECXPRVN'=ECXPRVL) PREVPRV^ECXTRT1(.LOC,ECD1,ECXPRVN,ECD2,.ECXPRVL,.ECXLOSP)
"RTN","ECXTRT",41,0)
 ..;whether ts has changed or not, see if attending physician has changed
"RTN","ECXTRT",42,0)
 ..;dont bother if theres no data on current attending physician or no change in attending
"RTN","ECXTRT",43,0)
 ..D:(ECXATTN'="")&(ECXATTN'=ECXATTL) PREVATT^ECXTRT1(.LOC,ECD1,ECXATTN,ECD2,.ECXATTL,.ECXLOSA)
"RTN","ECXTRT",44,0)
 ..S ECXDATE=$$ECXDATE^ECXUTL(ECXMVD1,ECXYM),ECXTIME=$$ECXTIME^ECXUTL(ECXMVD1)
"RTN","ECXTRT",45,0)
 ..S ECXADMDT=$$ECXDATE^ECXUTL(ECXADT,ECXYM),ECXADMTM=$$ECXTIME^ECXUTL(ECXADT),ECXDCDT=""
"RTN","ECXTRT",46,0)
 ..;- Production Division
"RTN","ECXTRT",47,0)
 ..S ECXPDIV=""
"RTN","ECXTRT",48,0)
 ..I ECXLOGIC>2003 S ECXPDIV=$S(WRD="":"",1:$$NPDIV(WRD))
"RTN","ECXTRT",49,0)
 ..S (ECXALNPI,ECXANNPI,ECXPLNPI,ECXPNNPI)=""
"RTN","ECXTRT",50,0)
 ..;
"RTN","ECXTRT",51,0)
 ..;- Observation patient indicator (YES/NO)
"RTN","ECXTRT",52,0)
 ..S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS)
"RTN","ECXTRT",53,0)
 ..;
"RTN","ECXTRT",54,0)
 ..;- Chg outpat with movemnt/discharge to inpat (to comply w/existing business rule)
"RTN","ECXTRT",55,0)
 ..I ECXA="O"&(ECXOBS="NO")&(ECXMVD1) S ECXA="I"
"RTN","ECXTRT",56,0)
 ..;
"RTN","ECXTRT",57,0)
 ..;- Get providers person classes
"RTN","ECXTRT",58,0)
 .. S ECXATLPC=$$PRVCLASS^ECXUTL($E(ECXATTL,2,999),ECXADT)
"RTN","ECXTRT",59,0)
 .. S ECXPRNPC=$$PRVCLASS^ECXUTL($E(ECXPRVN,2,999),ECXADT)
"RTN","ECXTRT",60,0)
 .. S ECXATNPC=$$PRVCLASS^ECXUTL($E(ECXATTN,2,999),ECXADT)
"RTN","ECXTRT",61,0)
 .. S ECXPRLPC=$$PRVCLASS^ECXUTL($E(ECXPRVL,2,999),ECXADT)
"RTN","ECXTRT",62,0)
 ..;
"RTN","ECXTRT",63,0)
 ..;- If no encounter number, don't file record
"RTN","ECXTRT",64,0)
 ..S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADT,,ECXTS,ECXOBS,ECHEAD,,)
"RTN","ECXTRT",65,0)
 ..D:ECXENC'="" FILE
"RTN","ECXTRT",66,0)
 ;for nhcu episodes with intervening asih stays, the los calculated here is not accurate,
"RTN","ECXTRT",67,0)
 ;but it never has been; this is best solution within current extract framework;
"RTN","ECXTRT",68,0)
 ;at discharge the los calculated for nhcu apisodes will be the los since admission w/o asih los subtracted;
"RTN","ECXTRT",69,0)
 ;
"RTN","ECXTRT",70,0)
 ;loop through discharges to get last treating specialty
"RTN","ECXTRT",71,0)
 S ECD=ECSD1
"RTN","ECXTRT",72,0)
 F  S ECD=$O(^DGPM("ATT3",ECD)),ECDA=0 Q:'ECD  Q:ECD>ECED  F  S ECDA=$O(^DGPM("ATT3",ECD,ECDA)) Q:'ECDA  D  Q:QFLG
"RTN","ECXTRT",73,0)
 .I $D(^DGPM(ECDA,0)) S EC=^(0),ECXDFN=+$P(EC,U,3) D  Q:QFLG
"RTN","ECXTRT",74,0)
 ..S ECXMVD1=$P(EC,U),WRD=$P(EC,U,6)
"RTN","ECXTRT",75,0)
 ..S (ECXDATE,ECXDCDT)=$$ECXDATE^ECXUTL(ECXMVD1,ECXYM),ECXTIME=$$ECXTIME^ECXUTL(ECXMVD1)
"RTN","ECXTRT",76,0)
 ..I ECXDCDT'>0 S ECXDCDT=""
"RTN","ECXTRT",77,0)
 ..S ECMT=$P(EC,U,18),ECXADM=$P(EC,U,14),ECXADT=$P($G(^DGPM(ECXADM,0)),U,1)
"RTN","ECXTRT",78,0)
 ..S (ECXTRTN,ECXSPCN,ECXPRVN,ECXATTN)="" S (ECXLOS,ECXLOSA,ECXLOSP)="" S ECXDSSD=""
"RTN","ECXTRT",79,0)
 ..K LOC D SETLOC(ECXDFN,ECXADM,ECPRO,.LOC)
"RTN","ECXTRT",80,0)
 ..S ECD1=9999999.9999999-ECXMVD1
"RTN","ECXTRT",81,0)
 ..;get ts change just before d/c
"RTN","ECXTRT",82,0)
 ..S ECD2=$O(LOC(ECD1)),ECXMVD2=9999999.9999999-ECD2
"RTN","ECXTRT",83,0)
 ..D FINDLOC(ECD2,.LOC,.ECXSPCL,.ECXPRVL,.ECXATTL,.ECXMOVL,.ECXTRTL)
"RTN","ECXTRT",84,0)
 ..;
"RTN","ECXTRT",85,0)
 ..;- Call sets ECXA (In/Out indicator) using date before discharge
"RTN","ECXTRT",86,0)
 ..Q:'$$PATDEM^ECXUTL2(ECXDFN,ECXMVD2,"1;",13)
"RTN","ECXTRT",87,0)
 ..S ECXADMDT=$$ECXDATE^ECXUTL(ECXADT,ECXYM),ECXADMTM=$$ECXTIME^ECXUTL(ECXADT)
"RTN","ECXTRT",88,0)
 ..;if closest ts change is admission ts, cant go back any further
"RTN","ECXTRT",89,0)
 ..S TRT=$O(LOC(ECD2,0)),REC=$O(LOC(ECD2,TRT,0))
"RTN","ECXTRT",90,0)
 ..I REC=ECXADM D
"RTN","ECXTRT",91,0)
 ...S X1=ECXMVD1,X2=ECXMVD2 D ^%DTC S ECXLOS=X
"RTN","ECXTRT",92,0)
 ...I ECXPRVL'="" S X1=ECXMVD1,X2=ECXMVD2 D ^%DTC S ECXLOSP=X
"RTN","ECXTRT",93,0)
 ...I ECXATTL'="" S X1=ECXMVD1,X2=ECXMVD2 D ^%DTC S ECXLOSA=X
"RTN","ECXTRT",94,0)
 ..;otherwise, need to find when change to last ts occurred
"RTN","ECXTRT",95,0)
 ..I REC'=ECXADM D
"RTN","ECXTRT",96,0)
 ...D PREVTRT^ECXTRT1(.LOC,ECD1,ECD2,ECXTRTL,.ECXLOS)
"RTN","ECXTRT",97,0)
 ...D PREVPRV^ECXTRT1(.LOC,ECD1,ECXPRVN,ECD2,.ECXPRVL,.ECXLOSP)
"RTN","ECXTRT",98,0)
 ...D PREVATT^ECXTRT1(.LOC,ECD1,ECXATTN,ECD2,.ECXATTL,.ECXLOSA)
"RTN","ECXTRT",99,0)
 ..S:ECXLOS>9999 ECXLOS=9999 S:ECXLOSA>9999 ECXLOSA=9999
"RTN","ECXTRT",100,0)
 ..S:ECXLOSP>9999 ECXLOSP=9999
"RTN","ECXTRT",101,0)
 ..;- Production Division
"RTN","ECXTRT",102,0)
 ..S ECXPDIV=""
"RTN","ECXTRT",103,0)
 ..I ECXLOGIC>2003 S ECXPDIV=$S(WRD="":"",1:$$NPDIV(WRD))
"RTN","ECXTRT",104,0)
 ..S (ECXALNPI,ECXANNPI,ECXPLNPI,ECXPNNPI)=""
"RTN","ECXTRT",105,0)
 ..;
"RTN","ECXTRT",106,0)
 ..;- Observation patient indicator (YES/NO)
"RTN","ECXTRT",107,0)
 ..S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS)
"RTN","ECXTRT",108,0)
 ..;
"RTN","ECXTRT",109,0)
 ..;- Chg outpat with movemnt/discharge to inpat (to comply w/existing business rule)
"RTN","ECXTRT",110,0)
 ..I ECXA="O"&(ECXOBS="NO")&(ECXMVD1) S ECXA="I"
"RTN","ECXTRT",111,0)
 ..;
"RTN","ECXTRT",112,0)
 ..;- Get providers person classes
"RTN","ECXTRT",113,0)
 .. S ECXATLPC=$$PRVCLASS^ECXUTL($E(ECXATTL,2,999),ECXADT)
"RTN","ECXTRT",114,0)
 .. S ECXPRNPC=$$PRVCLASS^ECXUTL($E(ECXPRVN,2,999),ECXADT)
"RTN","ECXTRT",115,0)
 .. S ECXATNPC=$$PRVCLASS^ECXUTL($E(ECXATTN,2,999),ECXADT)
"RTN","ECXTRT",116,0)
 .. S ECXPRLPC=$$PRVCLASS^ECXUTL($E(ECXPRVL,2,999),ECXADT)
"RTN","ECXTRT",117,0)
 ..;
"RTN","ECXTRT",118,0)
 ..;- If no encounter number don't file record
"RTN","ECXTRT",119,0)
 ..S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADT,,ECXTS,ECXOBS,ECHEAD,,)
"RTN","ECXTRT",120,0)
 ..D:ECXENC'="" FILE
"RTN","ECXTRT",121,0)
 D KPATDEM^ECXUTL2
"RTN","ECXTRT",122,0)
 Q
"RTN","ECXTRT",123,0)
 ;
"RTN","ECXTRT",124,0)
NPDIV(WRD) ;National Production Division
"RTN","ECXTRT",125,0)
 N DIV
"RTN","ECXTRT",126,0)
 S DIV=$$GET1^DIQ(42,WRD,.015,"I")
"RTN","ECXTRT",127,0)
 Q $S(DIV="":"",1:$$GETDIV^ECXDEPT(DIV))
"RTN","ECXTRT",128,0)
 ;
"RTN","ECXTRT",129,0)
SETLOC(ECXDFN,ECXADM,ECXPRO,ECXLOC) ;setup the local array from the ATS index
"RTN","ECXTRT",130,0)
 ; output
"RTN","ECXTRT",131,0)
 ; ECXLOC = local array (passed by reference)
"RTN","ECXTRT",132,0)
 ;
"RTN","ECXTRT",133,0)
 N SUB3,SUB4,SUB5,SPC,PRV,ATT,MOV
"RTN","ECXTRT",134,0)
 S SUB3=0
"RTN","ECXTRT",135,0)
 F  S SUB3=$O(^DGPM("ATS",ECXDFN,ECXADM,SUB3)) Q:SUB3=""  D
"RTN","ECXTRT",136,0)
 .S (SUB4,SUB5)=0
"RTN","ECXTRT",137,0)
 .S SUB4=$O(^DGPM("ATS",ECXDFN,ECXADM,SUB3,SUB4))
"RTN","ECXTRT",138,0)
 .S SUB5=$O(^DGPM("ATS",ECXDFN,ECXADM,SUB3,SUB4,SUB5))
"RTN","ECXTRT",139,0)
 .S ECXLOC(SUB3,SUB4,SUB5)="",SPC=$G(^TMP($J,"ECXTMP",SUB4))
"RTN","ECXTRT",140,0)
 .S DATA=$G(^DGPM(SUB5,0)),PRV=$P(DATA,U,8),ATT=$P(DATA,U,19)
"RTN","ECXTRT",141,0)
 .S MOV=$P(DATA,U,14)
"RTN","ECXTRT",142,0)
 .S:PRV]"" PRV=ECXPRO_PRV S:ATT]"" ATT=ECXPRO_ATT
"RTN","ECXTRT",143,0)
 .S ECXLOC(SUB3,SUB4,SUB5)=SPC_U_PRV_U_ATT_U_MOV
"RTN","ECXTRT",144,0)
 Q
"RTN","ECXTRT",145,0)
 ;
"RTN","ECXTRT",146,0)
FINDLOC(ECXTSD,ECXLOC,ECXSPC,ECXPRV,ECXATT,ECXMOV,ECXTRT) ;find local array node for current ts movement
"RTN","ECXTRT",147,0)
 ;   input
"RTN","ECXTRT",148,0)
 ;   ECXTSD = inverse date/time for current ts movement; required
"RTN","ECXTRT",149,0)
 ;   ECXLOC = local array; passed by reference; required
"RTN","ECXTRT",150,0)
 ;   output; data from record contained in MOVE
"RTN","ECXTRT",151,0)
 ;   ECXSPC = piece 1 of LOC (passed by reference)
"RTN","ECXTRT",152,0)
 ;   ECXPRV = piece 2 of LOC concatenated to PRO (passed by reference)
"RTN","ECXTRT",153,0)
 ;   ECXATT = piece 3 of LOC concatenated to PRO (passed by reference)
"RTN","ECXTRT",154,0)
 ;   ECXMOV = piece 4 of LOC (passed by reference)
"RTN","ECXTRT",155,0)
 ;   ECXTRT = pointer to file #45.7
"RTN","ECXTRT",156,0)
 ;
"RTN","ECXTRT",157,0)
 N SUB3,SUB4,SUB5,LOC
"RTN","ECXTRT",158,0)
 S (ECXSPC,ECXPRV,ECXATT,ECXMOV)=""
"RTN","ECXTRT",159,0)
 S SUB3=ECXTSD
"RTN","ECXTRT",160,0)
 I $D(ECXLOC(SUB3)) D
"RTN","ECXTRT",161,0)
 .S SUB4=$O(ECXLOC(SUB3,0)),SUB5=$O(ECXLOC(SUB3,SUB4,0))
"RTN","ECXTRT",162,0)
 .S LOC=ECXLOC(SUB3,SUB4,SUB5),ECXTRT=SUB4,ECXSPC=$P(LOC,U)
"RTN","ECXTRT",163,0)
 .S ECXPRV=$P(LOC,U,2),ECXATT=$P(LOC,U,3),ECXMOV=$P(LOC,U,4)
"RTN","ECXTRT",164,0)
 Q
"RTN","ECXTRT",165,0)
 ;
"RTN","ECXTRT",166,0)
FILE ;file the extract record
"RTN","ECXTRT",167,0)
 ;node0
"RTN","ECXTRT",168,0)
 ;^dfn^ssn^name^i/o (ECXA)^date^product^adm date^d/c date^
"RTN","ECXTRT",169,0)
 ;mov#^type^new ts^losing ts^losing ts los^
"RTN","ECXTRT",170,0)
 ;losing attending^movement type^time^adm time^new provider^
"RTN","ECXTRT",171,0)
 ;new attending^losing provider
"RTN","ECXTRT",172,0)
 ;node1
"RTN","ECXTRT",173,0)
 ;mpi^dss dept^losing attending npi^new provider npi^new attending npi^
"RTN","ECXTRT",174,0)
 ;losing provider npi^losing attending los^losing provider los^dom^
"RTN","ECXTRT",175,0)
 ;observ pat ind^encounter num
"RTN","ECXTRT",176,0)
 ;
"RTN","ECXTRT",177,0)
 ;convert specialties to PTF Codes for transmission
"RTN","ECXTRT",178,0)
 ;
"RTN","ECXTRT",179,0)
 N ECXDATA
"RTN","ECXTRT",180,0)
 S ECXDATA=$$TSDATA^DGACT(42.4,+ECXSPCN,.ECXDATA)
"RTN","ECXTRT",181,0)
 S ECXSPCN=$G(ECXDATA(7))
"RTN","ECXTRT",182,0)
 S ECXDATA=$$TSDATA^DGACT(42.4,+ECXSPCL,.ECXDATA)
"RTN","ECXTRT",183,0)
 S ECXSPCL=$G(ECXDATA(7))
"RTN","ECXTRT",184,0)
 ;done
"RTN","ECXTRT",185,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXTRT",186,0)
 S ECODE=EC7_U_EC23_U_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U_ECXDATE_U_U
"RTN","ECXTRT",187,0)
 S ECODE=ECODE_ECXADMDT_U_ECXDCDT_U_ECDA_U_6_U_ECXSPCN_U_ECXSPCL_U
"RTN","ECXTRT",188,0)
 S ECODE=ECODE_ECXLOS_U_ECXATTL_U_ECMT_U_ECXTIME_U_ECXADMTM_U_ECXPRVN_U
"RTN","ECXTRT",189,0)
 S ECODE=ECODE_ECXATTN_U_ECXPRVL_U
"RTN","ECXTRT",190,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECXALNPI_U_ECXPNNPI_U_ECXANNPI_U_ECXPLNPI_U
"RTN","ECXTRT",191,0)
 S ECODE1=ECODE1_ECXLOSA_U_ECXLOSP_U_ECXDOM_U_ECXOBS_U_ECXENC_U_ECXPDIV
"RTN","ECXTRT",192,0)
 I ECXLOGIC>2005 S ECODE1=ECODE1_U_ECXATLPC_U_ECXPRNPC_U_ECXATNPC_U_ECXPRLPC
"RTN","ECXTRT",193,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXTRT",194,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXTRT",195,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXTRT",196,0)
 Q
"RTN","ECXTRT",197,0)
 ;
"RTN","ECXTRT",198,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXTRT",199,0)
 S ECHEAD="TRT"
"RTN","ECXTRT",200,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXTRT",201,0)
 Q
"RTN","ECXTRT",202,0)
 ;
"RTN","ECXTRT",203,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXTRT",204,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL
"RTN","ECXTRT",205,0)
 Q
"RTN","ECXUD")
0^5^B48739438^B47464345
"RTN","ECXUD",1,0)
ECXUD ;ALB/JAP,BIR/DMA,PTD-Extract from UNIT DOSE EXTRACT DATA File (#728.904) ;4/19/2007
"RTN","ECXUD",2,0)
 ;;3.0;DSS EXTRACTS;**10,8,24,33,39,46,49,71,84,92,107**;Dec 22, 1997;Build 9
"RTN","ECXUD",3,0)
BEG ;entry point from option
"RTN","ECXUD",4,0)
 I '$O(^ECX(728.904,"A",0)) W !,"There are no unit dose orders to extract",!! R X:5 K X Q
"RTN","ECXUD",5,0)
 D SETUP I ECFILE="" Q
"RTN","ECXUD",6,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXUD",7,0)
 Q
"RTN","ECXUD",8,0)
 ;
"RTN","ECXUD",9,0)
START ;start package specific extract
"RTN","ECXUD",10,0)
 S QFLG=0
"RTN","ECXUD",11,0)
 S ECED=ECED+.3
"RTN","ECXUD",12,0)
 F ECD=ECSD1:0 S ECD=$O(^ECX(728.904,"A",ECD)) Q:'ECD  Q:ECD>ECED  Q:QFLG  D
"RTN","ECXUD",13,0)
 .S ECXJ=0 F  S ECXJ=$O(^ECX(728.904,"A",ECD,ECXJ)) Q:'ECXJ  Q:QFLG  I $D(^ECX(728.904,ECXJ,0)) D
"RTN","ECXUD",14,0)
 ..S DATA=^ECX(728.904,ECXJ,0),^(1)=$P(EC23,U,2),^ECX(728.904,"AC",$P(EC23,U,2),ECXJ)="" D STUFF
"RTN","ECXUD",15,0)
 K ^TMP($J,"ECXP")
"RTN","ECXUD",16,0)
 Q
"RTN","ECXUD",17,0)
 ;
"RTN","ECXUD",18,0)
STUFF ;get data
"RTN","ECXUD",19,0)
 N X,W,OK,P1,P3,PSTAT,PT,ECXPHA,ON,ECDRG
"RTN","ECXUD",20,0)
 S ECXDFN=$P(DATA,U,2),ECDRG=$P(DATA,U,4)
"RTN","ECXUD",21,0)
 ;
"RTN","ECXUD",22,0)
 ;get patient specific data
"RTN","ECXUD",23,0)
 S ECXERR="" D PAT(ECXDFN,ECD,.ECXERR)
"RTN","ECXUD",24,0)
 Q:ECXERR
"RTN","ECXUD",25,0)
 ;
"RTN","ECXUD",26,0)
 S ECXPRO=$P(DATA,U,7),ECXPRO=$E($P(ECXPRO,";",2))_$P(ECXPRO,";")
"RTN","ECXUD",27,0)
 S ECXPRNPI="",W=$P(DATA,U,6)
"RTN","ECXUD",28,0)
 S ECXDIV=$P($G(^DIC(42,+W,0)),U,11),ECXW=$P($G(^DIC(42,+W,44)),U)
"RTN","ECXUD",29,0)
 S ECXUDDT=$$ECXDATE^ECXUTL($P(DATA,U,3),ECXYM)
"RTN","ECXUD",30,0)
 S ECXUDTM=$E($P($P(DATA,U,3),".",2)_"000000",1,6)
"RTN","ECXUD",31,0)
 S ECXQTY=$P(DATA,U,5),ECXCOST=$P(DATA,U,8),ON=$P(DATA,U,10)
"RTN","ECXUD",32,0)
 ;call pharmacy drug file (#50) api via ecxutl5
"RTN","ECXUD",33,0)
 S ECXPHA=$$PHAAPI^ECXUTL5(ECDRG)
"RTN","ECXUD",34,0)
 S ECCAT=$P(ECXPHA,U,2),ECINV=$P(ECXPHA,U,4)
"RTN","ECXUD",35,0)
 S ECINV=$S(ECINV["I":"I",1:"")
"RTN","ECXUD",36,0)
 S ECNDC=$P(ECXPHA,U,3)
"RTN","ECXUD",37,0)
 S ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXUD",38,0)
 S P1=$P(ECXPHA,U,5),P3=$P(ECXPHA,U,6),X="PSNAPIS"
"RTN","ECXUD",39,0)
 X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXUD",40,0)
 I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXUD",41,0)
 ; - Department and National Production Division
"RTN","ECXUD",42,0)
 ;- Use of DSS Department postponed [S ECXDSSD=$$UDP^ECXDEPT(ECXDIV)]
"RTN","ECXUD",43,0)
 S ECXDSSD=""
"RTN","ECXUD",44,0)
 S ECXPDIV=$$GETDIV^ECXDEPT(ECXDIV)
"RTN","ECXUD",45,0)
 ;- Observation patient indicator (YES/NO)
"RTN","ECXUD",46,0)
 S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS)
"RTN","ECXUD",47,0)
 ;- Ordering Date, Ordering Stop Code
"RTN","ECXUD",48,0)
 S ECXORDDT=$TR($$FMTE^XLFDT($P(DATA,U,9),"7DF")," /","0")
"RTN","ECXUD",49,0)
 S ECXORDST="" I ECXA="O" D
"RTN","ECXUD",50,0)
 .;Get ordering stop code based on FY 2006 logic for outpatient
"RTN","ECXUD",51,0)
 .S ECXORDST=$$DOUDO^ECXUTL5(ECXDFN,ON)
"RTN","ECXUD",52,0)
 ;Ordering Provider Person Class
"RTN","ECXUD",53,0)
 S ECXOPPC=$$PRVCLASS^ECXUTL($E(ECXPRO,2,999),$P(DATA,U,9))
"RTN","ECXUD",54,0)
 ;BCMA data (place holder)
"RTN","ECXUD",55,0)
 S (ECXBCDD,ECXBCDG,ECXBCUA,ECXBCIF)=""
"RTN","ECXUD",56,0)
 ;- Set national patient record flag if exist
"RTN","ECXUD",57,0)
 D NPRF^ECXUTL5
"RTN","ECXUD",58,0)
 ;- If no encounter number don't file record
"RTN","ECXUD",59,0)
 S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADM,$P(DATA,U,3),ECXTS,ECXOBS,ECHEAD,,)
"RTN","ECXUD",60,0)
 D:ECXENC'="" FILE
"RTN","ECXUD",61,0)
 Q
"RTN","ECXUD",62,0)
 ;
"RTN","ECXUD",63,0)
PAT(ECXDFN,ECXDATE,ECXERR) ;get demographics from patient file
"RTN","ECXUD",64,0)
 ;init variables
"RTN","ECXUD",65,0)
 S (ECXCAT,ECXSTAT,ECXPRIOR,ECXSBGRP)=""
"RTN","ECXUD",66,0)
 ;get patient data if saved
"RTN","ECXUD",67,0)
 I $D(^TMP($J,"ECXP",ECXDFN)) D
"RTN","ECXUD",68,0)
 .S PT=^TMP($J,"ECXP",ECXDFN),ECXPNM=$P(PT,U),ECXSSN=$P(PT,U,2)
"RTN","ECXUD",69,0)
 .S ECXMPI=$P(PT,U,3),ECXDOB=$P(PT,U,4)
"RTN","ECXUD",70,0)
 .S ECXELIG=$P(PT,U,5),ECXSEX=$P(PT,U,6)
"RTN","ECXUD",71,0)
 .S ECXSTATE=$P(PT,U,7),ECXCNTY=$P(PT,U,8),ECXZIP=$P(PT,U,9)
"RTN","ECXUD",72,0)
 .S ECXVET=$P(PT,U,10),ECXPOS=$P(PT,U,11),ECXPST=$P(PT,U,12)
"RTN","ECXUD",73,0)
 .S ECXPLOC=$P(PT,U,13),ECXRST=$P(PT,U,14),ECXAST=$P(PT,U,15)
"RTN","ECXUD",74,0)
 .S ECXAOL=$P(PT,U,16),ECXPHI=$P(PT,U,17),ECXMST=$P(PT,U,18)
"RTN","ECXUD",75,0)
 .S ECXENRL=$P(PT,U,19),ECXCNHU=$P(PT,U,20),ECXCAT=$P(PT,U,21)
"RTN","ECXUD",76,0)
 .S ECXSTAT=$P(PT,U,22),ECXPRIOR=$P(PT,U,23),ECXHNCI=$P(PT,U,24)
"RTN","ECXUD",77,0)
 .S ECXETH=$P(PT,U,25),ECXRC1=$P(PT,U,26),ECXMTST=$P(PT,U,27)
"RTN","ECXUD",78,0)
 .S PT1=$G(^TMP($J,"ECXP",ECXDFN,1)),ECXERI=$P(PT1,U),ECXEST=$P(PT1,U,2)
"RTN","ECXUD",79,0)
 .I $$ENROLLM^ECXUTL2(ECXDFN)
"RTN","ECXUD",80,0)
 ;set patient data
"RTN","ECXUD",81,0)
 I '$D(^TMP($J,"ECXP",ECXDFN)) D  Q:'OK
"RTN","ECXUD",82,0)
 .K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,$P(ECXDATE,"."),"1;2;3;5",.ECXPAT)
"RTN","ECXUD",83,0)
 .I 'OK K ECXPAT S ECXERR=1 Q
"RTN","ECXUD",84,0)
 .S ECXPNM=ECXPAT("NAME"),ECXSSN=ECXPAT("SSN"),ECXMPI=ECXPAT("MPI")
"RTN","ECXUD",85,0)
 .S ECXDOB=ECXPAT("DOB"),ECXELIG=ECXPAT("ELIG"),ECXSEX=ECXPAT("SEX")
"RTN","ECXUD",86,0)
 .S ECXSTATE=ECXPAT("STATE"),ECXCNTY=ECXPAT("COUNTY")
"RTN","ECXUD",87,0)
 .S ECXZIP=ECXPAT("ZIP"),ECXVET=ECXPAT("VET")
"RTN","ECXUD",88,0)
 .S ECXPOS=ECXPAT("POS"),ECXPST=ECXPAT("POW STAT")
"RTN","ECXUD",89,0)
 .S ECXPLOC=ECXPAT("POW LOC"),ECXRST=ECXPAT("IR STAT")
"RTN","ECXUD",90,0)
 .S ECXAST=ECXPAT("AO STAT"),ECXAOL=ECXPAT("AOL")
"RTN","ECXUD",91,0)
 .S ECXPHI=ECXPAT("PHI"),ECXMST=ECXPAT("MST STAT")
"RTN","ECXUD",92,0)
 .S ECXENRL=ECXPAT("ENROLL LOC"),ECXMTST=ECXPAT("MEANS")
"RTN","ECXUD",93,0)
 .;get CNHU status
"RTN","ECXUD",94,0)
 .S ECXCNHU=$$CNHSTAT^ECXUTL4(ECXDFN)
"RTN","ECXUD",95,0)
 .;get enrollment data (category, status and priority)
"RTN","ECXUD",96,0)
 .I $$ENROLLM^ECXUTL2(ECXDFN)
"RTN","ECXUD",97,0)
 .; - Head and Neck Cancer Indicator
"RTN","ECXUD",98,0)
 .S ECXHNCI=$$HNCI^ECXUTL4(ECXDFN)
"RTN","ECXUD",99,0)
 .; - Race and Ethnicity
"RTN","ECXUD",100,0)
 .S ECXETH=ECXPAT("ETHNIC")
"RTN","ECXUD",101,0)
 .S ECXRC1=ECXPAT("RACE1")
"RTN","ECXUD",102,0)
 .;get emergency response indicator (FEMA)
"RTN","ECXUD",103,0)
 .S ECXERI=ECXPAT("ERI")
"RTN","ECXUD",104,0)
 .S ECXEST=ECXPAT("EC STAT")
"RTN","ECXUD",105,0)
 .;save for later
"RTN","ECXUD",106,0)
 .S ^TMP($J,"ECXP",ECXDFN)=ECXPNM_U_ECXSSN_U_ECXMPI_U_ECXDOB_U_ECXELIG_U_ECXSEX_U_ECXSTATE_U_ECXCNTY_U_ECXZIP_U_ECXVET_U_ECXPOS_U_ECXPST_U_ECXPLOC_U_ECXRST_U_ECXAST
"RTN","ECXUD",107,0)
 .S ^TMP($J,"ECXP",ECXDFN)=^TMP($J,"ECXP",ECXDFN)_U_ECXAOL_U_ECXPHI_U_ECXMST_U_ECXENRL_U_ECXCNHU_U_ECXCAT_U_ECXSTAT_U_ECXPRIOR_U_ECXHNCI_U_ECXETH_U_ECXRC1_U_ECXMTST
"RTN","ECXUD",108,0)
 .S ^TMP($J,"ECXP",ECXDFN,1)=ECXERI_U_ECXEST
"RTN","ECXUD",109,0)
 ;
"RTN","ECXUD",110,0)
 ;get inpatient data
"RTN","ECXUD",111,0)
 S X=$$INP^ECXUTL2(ECXDFN,ECXDATE),ECXA=$P(X,U),ECXMN=$P(X,U,2)
"RTN","ECXUD",112,0)
 S ECXTS=$P(X,U,3),ECXADM=$P(X,U,4),ECXDOM=$P(X,U,10)
"RTN","ECXUD",113,0)
 ;
"RTN","ECXUD",114,0)
 ;get primary care data
"RTN","ECXUD",115,0)
 S X=$$PRIMARY^ECXUTL2(ECXDFN,$P(ECXDATE,"."))
"RTN","ECXUD",116,0)
 S ECPTTM=$P(X,U),ECPTPR=$P(X,U,2),ECCLAS=$P(X,U,3),ECPTNPI=$P(X,U,4)
"RTN","ECXUD",117,0)
 S ECASPR=$P(X,U,5),ECCLAS2=$P(X,U,6),ECASNPI=$P(X,U,7)
"RTN","ECXUD",118,0)
 Q
"RTN","ECXUD",119,0)
 ;
"RTN","ECXUD",120,0)
FILE ;file record
"RTN","ECXUD",121,0)
 ;node0
"RTN","ECXUD",122,0)
 ;facility^dfn^ssn^name^in/out^day^drug category^quantity^ward^
"RTN","ECXUD",123,0)
 ;provider^cost^mov #^treat spec^ndc^new feeder key^investigational^
"RTN","ECXUD",124,0)
 ;udp time^adm date^adm time
"RTN","ECXUD",125,0)
 ;node1
"RTN","ECXUD",126,0)
 ;mpi^dss dept^provider npi^dom^observ pat ind^encounter num^
"RTN","ECXUD",127,0)
 ;prod div code^means tst^elig^dob^sex^state^county^zip+4^vet^
"RTN","ECXUD",128,0)
 ;period of svc^pow stat^pow loc^ir status^ao status^ao loc^
"RTN","ECXUD",129,0)
 ;purple heart ind.^mst status^cnh/sh status^enrollment loc^
"RTN","ECXUD",130,0)
 ;enrollment cat^enrollment status^enrollment priority^pc team^
"RTN","ECXUD",131,0)
 ;pc provider^pc provider npi^pc provider p.class^assoc. pc provider^
"RTN","ECXUD",132,0)
 ;assoc. pc provider npi^assoc. pc provider p.class
"RTN","ECXUD",133,0)
 ;node2
"RTN","ECXUD",134,0)
 ;ordering date^ordering stop code^head & neck cancer ind.^ethnicity^
"RTN","ECXUD",135,0)
 ;race1^bcma drug dispensed^bcma dose given^bcma unit of
"RTN","ECXUD",136,0)
 ;administration^bcma icu flag^ordering provider person class^
"RTN","ECXUD",137,0)
 ;^enrollment priority ECXPRIOR_enrollment subgroup
"RTN","ECXUD",138,0)
 ;ECXSBGRP^user enrollee ECXUESTA^patient type ECXPTYPE^combat vet
"RTN","ECXUD",139,0)
 ;elig ECXCVE^combat vet elig end date ECXCVEDT^enc cv eligible
"RTN","ECXUD",140,0)
 ;ECXCVENC^national patient record flag ECXNPRFI^emerg resp indic(FEMA) 
"RTN","ECXUD",141,0)
 ;ECXERI^environ contamin ECXEST
"RTN","ECXUD",142,0)
 N DA,DIK
"RTN","ECXUD",143,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXUD",144,0)
 S ECODE=EC7_U_EC23_U_ECXDIV_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXUD",145,0)
 S ECODE=ECODE_ECXUDDT_U_ECCAT_U_ECXQTY_U_ECXW_U_ECXPRO_U_ECXCOST_U
"RTN","ECXUD",146,0)
 S ECODE=ECODE_ECXMN_U_ECXTS_U_ECNDC_U_ECNFC_U_ECINV_U_ECXUDTM_U
"RTN","ECXUD",147,0)
 ;convert specialty to PTF Code for transmission
"RTN","ECXUD",148,0)
 N ECXDATA
"RTN","ECXUD",149,0)
 S ECXDATA=$$TSDATA^DGACT(42.4,+ECXTS,.ECXDATA)
"RTN","ECXUD",150,0)
 S ECXTS=$G(ECXDATA(7))
"RTN","ECXUD",151,0)
 ;done
"RTN","ECXUD",152,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECXADM,ECXYM)_U
"RTN","ECXUD",153,0)
 S ECODE=ECODE_$$ECXTIME^ECXUTL(ECXADM)_U
"RTN","ECXUD",154,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECXPRNPI_U_ECXDOM_U_ECXOBS_U_ECXENC_U
"RTN","ECXUD",155,0)
 S ECODE1=ECODE1_ECXPDIV_U_ECXMTST_U_ECXELIG_U_ECXDOB_U_ECXSEX_U
"RTN","ECXUD",156,0)
 S ECODE1=ECODE1_ECXSTATE_U_ECXCNTY_U_ECXZIP_U_ECXVET_U_ECXPOS_U
"RTN","ECXUD",157,0)
 S ECODE1=ECODE1_ECXPST_U_ECXPLOC_U_ECXRST_U_ECXAST_U
"RTN","ECXUD",158,0)
 S ECODE1=ECODE1_ECXAOL_U_ECXPHI_U_ECXMST_U_ECXCNHU_U_ECXENRL_U
"RTN","ECXUD",159,0)
 S ECODE1=ECODE1_ECXCAT_U_ECXSTAT_U_$S(ECXLOGIC<2005:ECXPRIOR,1:"")_U_ECPTTM_U_ECPTPR_U
"RTN","ECXUD",160,0)
 S ECODE1=ECODE1_ECPTNPI_U_ECCLAS_U_ECASPR_U_ECASNPI_U_ECCLAS2_U
"RTN","ECXUD",161,0)
 S ECODE2=ECXORDDT_U_ECXORDST_U_ECXHNCI_U_ECXETH_U_ECXRC1
"RTN","ECXUD",162,0)
 I ECXLOGIC>2003 S ECODE2=ECODE2_U_ECXBCDD_U_ECXBCDG_U_ECXBCUA_U_ECXBCIF_U_ECXOPPC
"RTN","ECXUD",163,0)
 I ECXLOGIC>2004 S ECODE2=ECODE2_U_U_ECXPRIOR_ECXSBGRP_U_ECXUESTA_U_ECXPTYPE_U_ECXCVE_U_ECXCVEDT_U_ECXCVENC_U_ECXNPRFI
"RTN","ECXUD",164,0)
 I ECXLOGIC>2006 S ECODE2=ECODE2_U_ECXERI_U_ECXEST
"RTN","ECXUD",165,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1
"RTN","ECXUD",166,0)
 S ^ECX(ECFILE,EC7,2)=ECODE2,ECRN=ECRN+1
"RTN","ECXUD",167,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXUD",168,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXUD",169,0)
 Q
"RTN","ECXUD",170,0)
 ;
"RTN","ECXUD",171,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXUD",172,0)
 S ECHEAD="UDP"
"RTN","ECXUD",173,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXUD",174,0)
 Q
"RTN","ECXUD",175,0)
 ;
"RTN","ECXUD",176,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXUD",177,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL
"RTN","ECXUD",178,0)
 Q
"VER")
8.0^22.0
"^DD",727.802,727.802,28,0)
TREATING SPECIALTY^F^^0;29^K:$L(X)>3!($L(X)<2) X
"^DD",727.802,727.802,28,.1)
Treating Specialty
"^DD",727.802,727.802,28,3)
PTF Code from Specialty File (42.4)
"^DD",727.802,727.802,28,21,0)
^^2^2^3070502^
"^DD",727.802,727.802,28,21,1,0)
The PTF CODE of the treating specialty associated with this extract
"^DD",727.802,727.802,28,21,2,0)
record.
"^DD",727.802,727.802,28,23,0)
^.001^9^9^3070502^^
"^DD",727.802,727.802,28,23,1,0)
Using the "ATT1" cross reference on the PATIENT MOVEMENT file (#405) and 
"^DD",727.802,727.802,28,23,2,0)
the patient pointer (DFN) stored in the PATIENT NO. - DFN field (#4) in the
"^DD",727.802,727.802,28,23,3,0)
ADMISSION EXTRACT file (#727.802), TREATING SPECIALTY data is derived from
"^DD",727.802,727.802,28,23,4,0)
the FACILITY TREATING SPECIALTY field (#.09) in the PATIENT MOVEMENT file
"^DD",727.802,727.802,28,23,5,0)
(#405). This facility treating specialty data is a pointer to the FACILITY
"^DD",727.802,727.802,28,23,6,0)
TREATING SPECIALTY file (#45.7). Using the SPECIALTY field (#1) in the
"^DD",727.802,727.802,28,23,7,0)
FACILITY TREATING SPECIALTY file (#45.7), the pointer to the SPECIALTY
"^DD",727.802,727.802,28,23,8,0)
file (#42.4) is obtained.  Then, the PTF Code is obtained and stored 
"^DD",727.802,727.802,28,23,9,0)
instead of the actual specialty code.
"^DD",727.802,727.802,28,"DT")
3070413
"^DD",727.805,727.805,15,0)
TREATING SPECIALTY^F^^0;16^K:$L(X)>3!($L(X)<2) X
"^DD",727.805,727.805,15,.1)
Treating Specialty
"^DD",727.805,727.805,15,3)
Answer must be 2-3 characters in length
"^DD",727.805,727.805,15,21,0)
^^2^2^3070502^
"^DD",727.805,727.805,15,21,1,0)
The PTF CODE of the treating specialty associated with this extract
"^DD",727.805,727.805,15,21,2,0)
record.
"^DD",727.805,727.805,15,23,0)
^.001^7^7^3070502^^
"^DD",727.805,727.805,15,23,1,0)
This field is initialized to a null, indicating an outpatient status. If 
"^DD",727.805,727.805,15,23,2,0)
a call to IN5^VADPT (using the patient IEN and the event date) returns a 
"^DD",727.805,727.805,15,23,3,0)
patient movement number (indicating inpatient status), then the value of 
"^DD",727.805,727.805,15,23,4,0)
VAIP(8), which is the pointer to the FACILITY TREATING SPECIALTY file 
"^DD",727.805,727.805,15,23,5,0)
(#45.7), is used to get the SPECIALTY field (1) which points to the 
"^DD",727.805,727.805,15,23,6,0)
SPECIALTY file (#42.4).  Then, the PTF Code is obtained and stored 
"^DD",727.805,727.805,15,23,7,0)
instead of the actual specialty code.
"^DD",727.805,727.805,15,"DT")
3070420
"^DD",727.808,727.808,15,0)
TREATING SPECIALTY^F^^0;16^K:$L(X)>3!($L(X)<2) X
"^DD",727.808,727.808,15,.1)
Treating Specialty
"^DD",727.808,727.808,15,3)
PTF Code from Specialty File (42.4)
"^DD",727.808,727.808,15,21,0)
^^2^2^3070502^
"^DD",727.808,727.808,15,21,1,0)
The PTF CODE of the treating specialty associated with this extract
"^DD",727.808,727.808,15,21,2,0)
record.
"^DD",727.808,727.808,15,23,0)
^.001^1^1^3070502^^
"^DD",727.808,727.808,15,23,1,0)
For the Physical Movement extract, the TREATING SPECIALTY field is null.
"^DD",727.808,727.808,15,"DT")
3070413
"^DD",727.809,727.809,15,0)
TREATING SPECIALTY^F^^0;16^K:$L(X)>3!($L(X)<2) X
"^DD",727.809,727.809,15,.1)
Treating Specialty
"^DD",727.809,727.809,15,3)
Answer must be 2-3 characters in length
"^DD",727.809,727.809,15,21,0)
^^2^2^3070502^
"^DD",727.809,727.809,15,21,1,0)
The PTF CODE of the treating specialty associated with this extract
"^DD",727.809,727.809,15,21,2,0)
record.
"^DD",727.809,727.809,15,23,0)
^.001^7^7^3070502^^
"^DD",727.809,727.809,15,23,1,0)
This field is initialized to a null, indicating an outpatient status. If 
"^DD",727.809,727.809,15,23,2,0)
a call to IN5^VADPT (using the patient IEN and the event date) returns a 
"^DD",727.809,727.809,15,23,3,0)
patient movement number (indicating inpatient status), then the value of 
"^DD",727.809,727.809,15,23,4,0)
VAIP(8), which is the pointer to the FACILITY TREATING SPECIALTY file 
"^DD",727.809,727.809,15,23,5,0)
(#45.7), is used to get the SPECIALTY field (1) which points to the 
"^DD",727.809,727.809,15,23,6,0)
SPECIALTY file (#42.4). Then, the PTF Code is obtained and stored 
"^DD",727.809,727.809,15,23,7,0)
instead of the actual specialty code.
"^DD",727.809,727.809,15,"DT")
3070420
"^DD",727.81,727.81,20,0)
TREATING SPECIALTY^F^^0;21^K:$L(X)>3!($L(X)<2) X
"^DD",727.81,727.81,20,.1)
Treating Specialty
"^DD",727.81,727.81,20,3)
Answer must be 2-3 characters in length
"^DD",727.81,727.81,20,21,0)
^^3^3^3070502^
"^DD",727.81,727.81,20,21,1,0)
The treating specialty PTF CODE assigned to this patient when the
"^DD",727.81,727.81,20,21,2,0)
prescription was issued, if the patient was an inpatient at that time.
"^DD",727.81,727.81,20,21,3,0)
Otherwise, this field is null.
"^DD",727.81,727.81,20,23,0)
^.001^7^7^3070502^^^
"^DD",727.81,727.81,20,23,1,0)
This field is initialized to a null, indicating an outpatient status. If 
"^DD",727.81,727.81,20,23,2,0)
a call to IN5^VADPT (using the patient IEN and the event date) returns a 
"^DD",727.81,727.81,20,23,3,0)
patient movement number (indicating inpatient status), then the value of 
"^DD",727.81,727.81,20,23,4,0)
VAIP(8), which is the pointer to the FACILITY TREATING SPECIALTY file 
"^DD",727.81,727.81,20,23,5,0)
(#45.7), is used to get the SPECIALTY field (1) which points to the 
"^DD",727.81,727.81,20,23,6,0)
SPECIALTY file (#42.4).  Then, the PTF Code is obtained and stored 
"^DD",727.81,727.81,20,23,7,0)
instead of the actual specialty code.
"^DD",727.81,727.81,20,"DT")
3070420
"^DD",727.813,727.813,13,0)
TREATING SPECIALTY^F^^0;14^K:$L(X)>3!($L(X)<2) X
"^DD",727.813,727.813,13,.1)
Treating Specialty
"^DD",727.813,727.813,13,3)
Answer must be 2-3 characters in length
"^DD",727.813,727.813,13,21,0)
^^2^2^3070502^
"^DD",727.813,727.813,13,21,1,0)
Indicates treating specialty PTF CODE for this patient or entity.  Will be
"^DD",727.813,727.813,13,21,2,0)
set to null for outpatients.
"^DD",727.813,727.813,13,23,0)
^.001^17^17^3070502^^
"^DD",727.813,727.813,13,23,1,0)
1. For Lab Extract without LMIP Codes:
"^DD",727.813,727.813,13,23,2,0)
   This field is initialized to a null, indicating an outpatient 
"^DD",727.813,727.813,13,23,3,0)
   status. If a call to IN5^VADPT (using the patient IEN and the event 
"^DD",727.813,727.813,13,23,4,0)
   date) returns a patient movement number (indicating inpatient 
"^DD",727.813,727.813,13,23,5,0)
   status), then the value of VAIP(8), which is the pointer to the 
"^DD",727.813,727.813,13,23,6,0)
   FACILITY TREATING SPECIALTY file (#45.7), is used to get the 
"^DD",727.813,727.813,13,23,7,0)
   SPECIALTY field (1) which points to the SPECIALTY file (#42.4). 
"^DD",727.813,727.813,13,23,8,0)
 
"^DD",727.813,727.813,13,23,9,0)
2. For Lab Extract with LMIP Codes:
"^DD",727.813,727.813,13,23,10,0)
   NAME field (.01) in the SPECIALTY file (#42.4), as pointed to by the 
"^DD",727.813,727.813,13,23,11,0)
   NAME field (.01) in the FACILITY TREATING SPECIALTY file (#45.7), as 
"^DD",727.813,727.813,13,23,12,0)
   pointed to by the TREATING SPECIALTY field (16) of the ACCESSION WKLD 
"^DD",727.813,727.813,13,23,13,0)
   CODE TIME field (1) multiple within the WKLD CODE field (1) multiple 
"^DD",727.813,727.813,13,23,14,0)
   within the DATE field (.03) multiple of the WKLD DATA file (#64.1).
"^DD",727.813,727.813,13,23,15,0)
 
"^DD",727.813,727.813,13,23,16,0)
Then, the PTF Code is obtained and stored instead of the actual specialty
"^DD",727.813,727.813,13,23,17,0)
code.
"^DD",727.813,727.813,13,"DT")
3070420
"^DD",727.817,727.817,14,0)
NEW TREATING SPECIALTY^F^^0;15^K:$L(X)>3!($L(X)<2) X
"^DD",727.817,727.817,14,.1)
New Treating Specialty
"^DD",727.817,727.817,14,3)
PTF Code from Specialty File (42.4)
"^DD",727.817,727.817,14,21,0)
^^2^2^3070502^
"^DD",727.817,727.817,14,21,1,0)
The Specialty PTF CODE associated with the Facility Treating Specialty to
"^DD",727.817,727.817,14,21,2,0)
which patient is being moved.
"^DD",727.817,727.817,14,23,0)
^.001^10^10^3070502^^^
"^DD",727.817,727.817,14,23,1,0)
Source:
"^DD",727.817,727.817,14,23,2,0)
Field #.09; file #405
"^DD",727.817,727.817,14,23,3,0)
Field #7; file #45.7
"^DD",727.817,727.817,14,23,4,0)
 
"^DD",727.817,727.817,14,23,5,0)
PTF Code of SPECIALTY file (#42.4) derived from SPECIALTY
"^DD",727.817,727.817,14,23,6,0)
field (#1) and PTF CODE (#7) of FACILITY TREATING SPECIALTY file (#45.7)
"^DD",727.817,727.817,14,23,7,0)
record pointed to by FACILITY TREATING SPECIALTY field (#.09) of PATIENT
"^DD",727.817,727.817,14,23,8,0)
MOVEMENT file (#405) record.  The movement record is the current treating
"^DD",727.817,727.817,14,23,9,0)
specialty movement.  Then, the PTF Code is obtained and stored instead of
"^DD",727.817,727.817,14,23,10,0)
the actual specialty code.
"^DD",727.817,727.817,14,"DT")
3070413
"^DD",727.817,727.817,15,0)
LOSING TREATING SPECIALTY^F^^0;16^K:$L(X)>3!($L(X)<2) X
"^DD",727.817,727.817,15,.1)
Losing Treating Specialty
"^DD",727.817,727.817,15,3)
Answer must be 2-3 characters in length.
"^DD",727.817,727.817,15,21,0)
^^4^4^3070502^
"^DD",727.817,727.817,15,21,1,0)
The Specialty PTF CODE associated with the losing Facility Treating
"^DD",727.817,727.817,15,21,2,0)
Specialty for this patient movement.  If this movement is not an actual
"^DD",727.817,727.817,15,21,3,0)
treating specialty change, then it is possible for this field to be the
"^DD",727.817,727.817,15,21,4,0)
same as NEW TREATING SPECIALTY field (#14).
"^DD",727.817,727.817,15,23,0)
^.001^15^15^3070502^^
"^DD",727.817,727.817,15,23,1,0)
Using the "ATT3" or "ATT6" cross reference on the PATIENT MOVEMENT file 
"^DD",727.817,727.817,15,23,2,0)
(#405) and the patient pointer (DFN) stored in the PATIENT NO. - DFN 
"^DD",727.817,727.817,15,23,3,0)
field (4) in the TREATING SPECIALTY CHANGE EXTRACT file (#727.817), 
"^DD",727.817,727.817,15,23,4,0)
NEW TREATING SPECIALTY data is derived from the FACILITY TREATING 
"^DD",727.817,727.817,15,23,5,0)
SPECIALTY field (.09) in the PATIENT MOVEMENT file (#405). This facility 
"^DD",727.817,727.817,15,23,6,0)
treating specialty data is a pointer to the FACILITY TREATING SPECIALTY 
"^DD",727.817,727.817,15,23,7,0)
file (#45.7). Using the SPECIALTY field (1) in the FACILITY TREATING 
"^DD",727.817,727.817,15,23,8,0)
SPECIALTY file (#45.7), the pointer to the SPECIALTY file (#42.4) is 
"^DD",727.817,727.817,15,23,9,0)
obtained.
"^DD",727.817,727.817,15,23,10,0)
 
"^DD",727.817,727.817,15,23,11,0)
This Specialty is then the LOSING Specialty for the Treating Specialty
"^DD",727.817,727.817,15,23,12,0)
change occurring on the date in the TRT extract record.  
"^DD",727.817,727.817,15,23,13,0)
 
"^DD",727.817,727.817,15,23,14,0)
Then, the PTF Code is obtained and stored instead of the actual specialty
"^DD",727.817,727.817,15,23,15,0)
code.
"^DD",727.817,727.817,15,"DT")
3070502
"^DD",727.819,727.819,15,0)
TREATING SPECIALTY^F^^0;15^K:$L(X)>3!($L(X)<2) X
"^DD",727.819,727.819,15,.1)
Treating Specialty
"^DD",727.819,727.819,15,3)
Answer must be 2-3 characters in length
"^DD",727.819,727.819,15,21,0)
^^2^2^3070502^
"^DD",727.819,727.819,15,21,1,0)
The PTF CODE of the treating specialty associated with this extract
"^DD",727.819,727.819,15,21,2,0)
record.
"^DD",727.819,727.819,15,23,0)
^.001^9^9^3070502^^
"^DD",727.819,727.819,15,23,1,0)
This field is initialized to a null, indicating an outpatient status. If 
"^DD",727.819,727.819,15,23,2,0)
a call to IN5^VADPT (using the patient IEN and the event date) returns a 
"^DD",727.819,727.819,15,23,3,0)
patient movement number (indicating inpatient status), then the value of 
"^DD",727.819,727.819,15,23,4,0)
VAIP(8), which is the pointer to the FACILITY TREATING SPECIALTY file 
"^DD",727.819,727.819,15,23,5,0)
(#45.7), is used to get the SPECIALTY field (1) which points to the 
"^DD",727.819,727.819,15,23,6,0)
SPECIALTY file (#42.4).
"^DD",727.819,727.819,15,23,7,0)
 
"^DD",727.819,727.819,15,23,8,0)
Then, the PTF Code is obtained and stored instead of the actual specialty
"^DD",727.819,727.819,15,23,9,0)
code.
"^DD",727.819,727.819,15,"DT")
3070420
"^DD",727.824,727.824,18,0)
TREATING SPECIALTY^F^^0;18^K:$L(X)>3!($L(X)<2) X
"^DD",727.824,727.824,18,.1)
Treating Specialty
"^DD",727.824,727.824,18,3)
Answer must be 2-3 characters in length
"^DD",727.824,727.824,18,21,0)
^^2^2^3070502^
"^DD",727.824,727.824,18,21,1,0)
The PTF CODE of the treating specialty associated with this extract
"^DD",727.824,727.824,18,21,2,0)
record.
"^DD",727.824,727.824,18,23,0)
^.001^9^9^3070502^^
"^DD",727.824,727.824,18,23,1,0)
This field is initialized to a null, indicating an outpatient status. If 
"^DD",727.824,727.824,18,23,2,0)
a call to IN5^VADPT (using the patient IEN and the event date) returns a 
"^DD",727.824,727.824,18,23,3,0)
patient movement number (indicating inpatient status), then the value of 
"^DD",727.824,727.824,18,23,4,0)
VAIP(8), which is the pointer to the FACILITY TREATING SPECIALTY file 
"^DD",727.824,727.824,18,23,5,0)
(#45.7), is used to get the SPECIALTY field (1) which points to the 
"^DD",727.824,727.824,18,23,6,0)
SPECIALTY file (#42.4).
"^DD",727.824,727.824,18,23,7,0)
 
"^DD",727.824,727.824,18,23,8,0)
Then, the PTF Code is obtained and stored instead of the actual specialty
"^DD",727.824,727.824,18,23,9,0)
code.
"^DD",727.824,727.824,18,"DT")
3070420
"^DD",727.827,727.827,12,0)
TREATING SPECIALITY^F^^0;13^K:$L(X)>3!($L(X)<2) X
"^DD",727.827,727.827,12,3)
Answer must be 2-3 characters in length
"^DD",727.827,727.827,12,21,0)
^^2^2^3070502^
"^DD",727.827,727.827,12,21,1,0)
The PTF CODE of the treating specialty associated with this extract 
"^DD",727.827,727.827,12,21,2,0)
record.
"^DD",727.827,727.827,12,"DT")
3070420
"^DD",727.832,727.832,10,0)
TREATING SPECIALTY^F^^0;11^K:$L(X)>3!($L(X)<2) X
"^DD",727.832,727.832,10,3)
Answer must be 2-3 characters in length
"^DD",727.832,727.832,10,21,0)
^.001^2^2^3070502^^
"^DD",727.832,727.832,10,21,1,0)
The PTF CODE of the treating specialty associated with this extract record
"^DD",727.832,727.832,10,21,2,0)
form the SPECIALTY file (#42.4).
"^DD",727.832,727.832,10,23,0)
^.001^9^9^3070502^^
"^DD",727.832,727.832,10,23,1,0)
This field is initialized to a null, indicating an outpatient status. If a
"^DD",727.832,727.832,10,23,2,0)
call to IN5^VADPT (using the patient IEN and the event date) returns a
"^DD",727.832,727.832,10,23,3,0)
patient movement number (indicating inpatient status), then the value of
"^DD",727.832,727.832,10,23,4,0)
VAIP(8), which is the pointer to the FACILITY TREATING SPECIALTY file
"^DD",727.832,727.832,10,23,5,0)
(#45.7), is used to get the SPECIALTY field (1) which points to the
"^DD",727.832,727.832,10,23,6,0)
SPECIALTY file (#42.4). 
"^DD",727.832,727.832,10,23,7,0)
 
"^DD",727.832,727.832,10,23,8,0)
Then, the PTF Code is obtained and stored instead of the actual specialty
"^DD",727.832,727.832,10,23,9,0)
code.
"^DD",727.832,727.832,10,"DT")
3070420
"BLD",7155,6)
^95
**END**
**END**
