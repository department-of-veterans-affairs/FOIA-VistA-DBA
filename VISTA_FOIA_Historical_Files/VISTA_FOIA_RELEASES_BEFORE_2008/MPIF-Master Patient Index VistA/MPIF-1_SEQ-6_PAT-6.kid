Released MPIF*1*6 SEQ #6
Extracted from mail message
**KIDS**:MPIF*1.0*6^

**INSTALL NAME**
MPIF*1.0*6
"BLD",1688,0)
MPIF*1.0*6^MASTER PATIENT INDEX VISTA^0^3000629^y
"BLD",1688,4,0)
^9.64PA^^
"BLD",1688,"ABNS",0)
^9.66A^^
"BLD",1688,"ABPKG")
n^y^G.CIRN EXCEPTION MGT@FORUM.VA.GOV
"BLD",1688,"KRN",0)
^9.67PA^19^17
"BLD",1688,"KRN",.4,0)
.4
"BLD",1688,"KRN",.401,0)
.401
"BLD",1688,"KRN",.402,0)
.402
"BLD",1688,"KRN",.402,"NM",0)
^9.68A^2^2
"BLD",1688,"KRN",.402,"NM",1,0)
MPIF RESULT INCOMING    FILE #984.9^984.9^0
"BLD",1688,"KRN",.402,"NM",2,0)
MPIF REQUEST EDIT    FILE #984.9^984.9^0
"BLD",1688,"KRN",.402,"NM","B","MPIF REQUEST EDIT    FILE #984.9",2)

"BLD",1688,"KRN",.402,"NM","B","MPIF RESULT INCOMING    FILE #984.9",1)

"BLD",1688,"KRN",.403,0)
.403
"BLD",1688,"KRN",.5,0)
.5
"BLD",1688,"KRN",.84,0)
.84
"BLD",1688,"KRN",3.6,0)
3.6
"BLD",1688,"KRN",3.8,0)
3.8
"BLD",1688,"KRN",9.2,0)
9.2
"BLD",1688,"KRN",9.8,0)
9.8
"BLD",1688,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",1688,"KRN",9.8,"NM",1,0)
MPIFHL7^^0^B3714625
"BLD",1688,"KRN",9.8,"NM",2,0)
MPIFRESS^^0^B13652452
"BLD",1688,"KRN",9.8,"NM",3,0)
MPIFQUE5^^0^B10171215
"BLD",1688,"KRN",9.8,"NM",4,0)
MPIFCMOR^^0^B6453328
"BLD",1688,"KRN",9.8,"NM",5,0)
MPIFREV^^0^B11498409
"BLD",1688,"KRN",9.8,"NM",6,0)
MPIFREQ^^0^B20475156
"BLD",1688,"KRN",9.8,"NM","B","MPIFCMOR",4)

"BLD",1688,"KRN",9.8,"NM","B","MPIFHL7",1)

"BLD",1688,"KRN",9.8,"NM","B","MPIFQUE5",3)

"BLD",1688,"KRN",9.8,"NM","B","MPIFREQ",6)

"BLD",1688,"KRN",9.8,"NM","B","MPIFRESS",2)

"BLD",1688,"KRN",9.8,"NM","B","MPIFREV",5)

"BLD",1688,"KRN",19,0)
19
"BLD",1688,"KRN",19,"NM",0)
^9.68A^^
"BLD",1688,"KRN",19.1,0)
19.1
"BLD",1688,"KRN",101,0)
101
"BLD",1688,"KRN",101,"NM",0)
^9.68A^2^2
"BLD",1688,"KRN",101,"NM",1,0)
MPIF CMOR APPROVE/DISAPPROVE^^0
"BLD",1688,"KRN",101,"NM",2,0)
MPIF CMOR APP/DIS^^0
"BLD",1688,"KRN",101,"NM","B","MPIF CMOR APP/DIS",2)

"BLD",1688,"KRN",101,"NM","B","MPIF CMOR APPROVE/DISAPPROVE",1)

"BLD",1688,"KRN",409.61,0)
409.61
"BLD",1688,"KRN",771,0)
771
"BLD",1688,"KRN",771,"NM",0)
^9.68A^1^1
"BLD",1688,"KRN",771,"NM",1,0)
MPIF CMOR CHNG^^0
"BLD",1688,"KRN",771,"NM","B","MPIF CMOR CHNG",1)

"BLD",1688,"KRN",870,0)
870
"BLD",1688,"KRN",8994,0)
8994
"BLD",1688,"KRN","B",.4,.4)

"BLD",1688,"KRN","B",.401,.401)

"BLD",1688,"KRN","B",.402,.402)

"BLD",1688,"KRN","B",.403,.403)

"BLD",1688,"KRN","B",.5,.5)

"BLD",1688,"KRN","B",.84,.84)

"BLD",1688,"KRN","B",3.6,3.6)

"BLD",1688,"KRN","B",3.8,3.8)

"BLD",1688,"KRN","B",9.2,9.2)

"BLD",1688,"KRN","B",9.8,9.8)

"BLD",1688,"KRN","B",19,19)

"BLD",1688,"KRN","B",19.1,19.1)

"BLD",1688,"KRN","B",101,101)

"BLD",1688,"KRN","B",409.61,409.61)

"BLD",1688,"KRN","B",771,771)

"BLD",1688,"KRN","B",870,870)

"BLD",1688,"KRN","B",8994,8994)

"BLD",1688,"QUES",0)
^9.62^^
"BLD",1688,"REQB",0)
^9.611^1^1
"BLD",1688,"REQB",1,0)
MPIF*1.0*1^1
"BLD",1688,"REQB","B","MPIF*1.0*1",1)

"KRN",.402,1904,-1)
0^2
"KRN",.402,1904,0)
MPIF REQUEST EDIT^3000616.1127^@^984.9^^@^3000619
"KRN",.402,1904,"DIAB",3,0,984.9,3)
.07;"SEND REQUEST TO"
"KRN",.402,1904,"DR",1,984.9)
1.03////^S X=2;.02////^S X=DUZ;S DIE("NO^")="OUTOK";W !,"REQUEST NUMBER: ",$P(^MPIF(984.9,D0,0),"^");.04;S:$$CHK1^MPIFUTL(D0) Y="@3";
"KRN",.402,1904,"DR",1,984.9,1)
N IEN S IEN=$P(^MPIF(984.9,D0,0),"^",4) W !,"*** Current CMOR: ",$$CMOR2^MPIF001(IEN)," (",$$GETVCCI^MPIF001(IEN),") ***";1.02;.05//^S X=PHONE;S:$P(^MPIF(984.9,D0,0),"^",4)="" Y="";
"KRN",.402,1904,"DR",1,984.9,2)
.07////^S X=$S($P($$SITE^VASITE(),"^",3)'=$$PAT^MPIFNQ($P(^MPIF(984.9,D0,0),"^",4)):$$LKUP^XUAF4($$PAT^MPIFNQ($P(^MPIF(984.9,D0,0),"^",4))),1:"");S:$P($$SITE^VASITE(),"^",1)'=$$PAT^MPIFNQ($P(^MPIF(984.9,D0,0),"^",4)) Y="";
"KRN",.402,1904,"DR",1,984.9,3)
W !,"-",!,"Since this patient belongs to your site,";W !,"select the site you wish to transfer this patient to.",!,"-";.07SEND REQUEST TO~;S:$$CHK2^MPIFUTL(D0) Y="@4";S:$$CHK2^MPIFUTL(D0) Y="@4";1.03///^S X=1;S Y="";@3;
"KRN",.402,1904,"DR",1,984.9,4)
.04////^S X="@";S Y=.04;@4;.07////@;S Y=.07;
"KRN",.402,1908,-1)
0^1
"KRN",.402,1908,0)
MPIF RESULT INCOMING^3000614.0731^@^984.9^^@^3000619
"KRN",.402,1908,"DR",1,984.9)
.06////^S X=RESULT;2.02////^S X=NDATE;2.03////^S X=PHONE;3.01////^S X=REVIEWER;3.02////^S X=COMMENTS;
"KRN",101,2352,-1)
0^1
"KRN",101,2352,0)
MPIF CMOR APPROVE/DISAPPROVE^MPIF CMOR APPROVE/DISAPPROVE^^E^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,2352,1,0)
^101.06^1^1^3000613^^^
"KRN",101,2352,1,1,0)
Updating Request to change CMOR to approved or not approved.
"KRN",101,2352,99)
58238,39733
"KRN",101,2352,770)
MPIF CMOR CHNG^^ADT^A31^^^^NE^NE^2.3^
"KRN",101,2352,772)
Q
"KRN",101,2352,775,0)
^101.0775PA^1^1
"KRN",101,2352,775,1,0)
2353
"KRN",101,2352,775,1,"^")
MPIF CMOR APP/DIS
"KRN",101,2353,-1)
0^2
"KRN",101,2353,0)
MPIF CMOR APP/DIS^MPIF CMOR APP/DIS^^S^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,2353,1,0)
^101.06^2^2^3000614^^^
"KRN",101,2353,1,1,0)
Subscriber protocol for updating the status of the CMOR Request - approved
"KRN",101,2353,1,2,0)
or not approved.
"KRN",101,2353,99)
58238,39357
"KRN",101,2353,770)
^MPIF CMOR CHNG^ADT^A31^^^^NE^NE^2.3^
"KRN",101,2353,771)
D IN^MPIFRESS
"KRN",101,2353,773)
0^0^0^0
"KRN",101,2353,774)
Q
"KRN",771,72,-1)
0^1
"KRN",771,72,0)
MPIF CMOR CHNG^a^662
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"ORD",14,771)
771;14;;;HLAP^XPDTA1;HLAPF1^XPDIA1;HLAPE1^XPDIA1;HLAPF2^XPDIA1;;
"ORD",14,771,0)
HL7 APPLICATION PARAMETER
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",474,-1)
1^1
"PKG",474,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",474,20,0)
^9.402P^^
"PKG",474,22,0)
^9.49I^1^1
"PKG",474,22,1,0)
1.0^2990428^2990603^9139
"PKG",474,22,1,"PAH",1,0)
6^3000629
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","MPIFCMOR")
0^4^B6453328
"RTN","MPIFCMOR",1,0)
MPIFCMOR ;BHM/RGY-Set and broadcast CMOR changes ;FEB 20, 1998
"RTN","MPIFCMOR",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,6**;30 Apr 99
"RTN","MPIFCMOR",3,0)
 ;
"RTN","MPIFCMOR",4,0)
BROAD(REQNO,ER) ;Broadcase CMOR change to everyone
"RTN","MPIFCMOR",5,0)
 N CN,RGL,HL,CNT,HLA,PDX,ICN,HOME,RGLINK,RGL,TMP,II,CLIENT,HLA,USER,N0,NDATE,RLST,SERVER,ERR
"RTN","MPIFCMOR",6,0)
 S ER=0
"RTN","MPIFCMOR",7,0)
 S SERVER="MPIF CMOR RESULT SERVER"
"RTN","MPIFCMOR",8,0)
 S CLIENT="MPIF CMOR RESULT CLIENT" K ERROR
"RTN","MPIFCMOR",9,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFCMOR",10,0)
 S DFN=$P(N0,"^",4)
"RTN","MPIFCMOR",11,0)
 S NDATE=$P(N0,"^",3)
"RTN","MPIFCMOR",12,0)
 N X,Y,DIC
"RTN","MPIFCMOR",13,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(N0,"^",2)
"RTN","MPIFCMOR",14,0)
 D ^DIC
"RTN","MPIFCMOR",15,0)
 I $G(Y)<1 S USER=""
"RTN","MPIFCMOR",16,0)
 I $G(Y)>0 S USER=$G(Y(0,0))
"RTN","MPIFCMOR",17,0)
 S SITE=+$P($$SITE^VASITE,"^",3)
"RTN","MPIFCMOR",18,0)
 S ICN=$$ICN^MPIFNQ(DFN)
"RTN","MPIFCMOR",19,0)
 S HOME=$P($$MPINODE^MPIFAPI(DFN),"^",3)
"RTN","MPIFCMOR",20,0)
 S CN=+$P($$MPINODE^MPIFAPI(DFN),"^",5)
"RTN","MPIFCMOR",21,0)
 S HL=0,CNT=0
"RTN","MPIFCMOR",22,0)
 K ^XTMP("MPIFCMOR","ERR")
"RTN","MPIFCMOR",23,0)
 D INIT^HLFNC2(SERVER,.HL)
"RTN","MPIFCMOR",24,0)
 I HL S ERROR=HL D  Q
"RTN","MPIFCMOR",25,0)
 .D START^RGHLLOG()
"RTN","MPIFCMOR",26,0)
 .D EXC^RGHLLOG(220,"Unable to setup HL7 for Change CMOR Request # "_REQNO)
"RTN","MPIFCMOR",27,0)
 .D STOP^RGHLLOG()
"RTN","MPIFCMOR",28,0)
 .D RESET(DFN,REQNO)
"RTN","MPIFCMOR",29,0)
 K HLL("LINKS")
"RTN","MPIFCMOR",30,0)
 D LINK^MPIFQUE4
"RTN","MPIFCMOR",31,0)
 I '$D(HLL("LINKS")) D  Q
"RTN","MPIFCMOR",32,0)
 .D START^RGHLLOG()
"RTN","MPIFCMOR",33,0)
 .D EXC^RGHLLOG(224,"No Links found for Change CMOR Request # "_REQNO)
"RTN","MPIFCMOR",34,0)
 .D STOP^RGHLLOG()
"RTN","MPIFCMOR",35,0)
 .D RESET(DFN,REQNO)
"RTN","MPIFCMOR",36,0)
 .S ER="-1^No Links found"
"RTN","MPIFCMOR",37,0)
 ;Broadcase new CMOR to other sites
"RTN","MPIFCMOR",38,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_USER
"RTN","MPIFCMOR",39,0)
 S CNT=CNT+1,PDX=$$EN^VAFCPID(DFN,"1,2,3,5,6,7,8,11,12,13,14,16,17,19")
"RTN","MPIFCMOR",40,0)
 S HLA("HLS",CNT)=PDX
"RTN","MPIFCMOR",41,0)
 S CNT=CNT+1,HLA("HLS",CNT)="PV1"_HL("FS")_HL("FS")_HL("FS")_$P($$NNT^XUAF4(+$P(N0,"^",7)),"^",2)_HL("FS")_HL("FS")_HL("FS")_$P($$SITE^VASITE,"^",3)
"RTN","MPIFCMOR",42,0)
 D GENERATE^HLMA(SERVER,"LM",1,.RLST,"",.HL)
"RTN","MPIFCMOR",43,0)
 I 'RLST S ERROR=RLST,ER=1 D
"RTN","MPIFCMOR",44,0)
 .D START^RGHLLOG()
"RTN","MPIFCMOR",45,0)
 .D EXC^RGHLLOG(220,"Unable to Generate HL7 msg for Change CMOR Request # "_REQNO)
"RTN","MPIFCMOR",46,0)
 .D STOP^RGHLLOG()
"RTN","MPIFCMOR",47,0)
 .D RESET(DFN,REQNO)
"RTN","MPIFCMOR",48,0)
 .S ER="-1^error in HL7 sending msg"
"RTN","MPIFCMOR",49,0)
 Q
"RTN","MPIFCMOR",50,0)
RESET(DFN,REQNO) ;
"RTN","MPIFCMOR",51,0)
 ; reset status to pending approval and change CMOR to this site
"RTN","MPIFCMOR",52,0)
 N ERR
"RTN","MPIFCMOR",53,0)
 D RESET2^MPIFREQ(REQNO)
"RTN","MPIFCMOR",54,0)
 S ERR=$$CHANGE^MPIF001(DFN,+$$SITE^VASITE)
"RTN","MPIFCMOR",55,0)
 Q
"RTN","MPIFCMOR",56,0)
 ;
"RTN","MPIFCMOR",57,0)
SET(DFN,SITE) ;Set CMOR for patient to site
"RTN","MPIFCMOR",58,0)
 NEW RESULT
"RTN","MPIFCMOR",59,0)
 S RESULT=$$CHANGE^MPIF001(DFN,SITE)
"RTN","MPIFCMOR",60,0)
 Q
"RTN","MPIFHL7")
0^1^B3714625
"RTN","MPIFHL7",1,0)
MPIFHL7 ;BHM/RGY-Processing incoming hl7 message ;FEB 20, 1998
"RTN","MPIFHL7",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,6**;30 Apr 99
"RTN","MPIFHL7",3,0)
IN ;
"RTN","MPIFHL7",4,0)
 ;Entry point used for MPIF CMOR RESPONSE protocol
"RTN","MPIFHL7",5,0)
 ; It process the inbound HL7 message to update CMOR
"RTN","MPIFHL7",6,0)
 N I,PHONE,COMMENTS,STATUS,ID,SITE,NDATE,USER,INST,ICN,HLNODE,HLQUIT,RES,CMOR
"RTN","MPIFHL7",7,0)
 S HLQUIT="",ID=""
"RTN","MPIFHL7",8,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFHL7",9,0)
 .I $P(HLNODE,HL("FS"),1)="NTE" D
"RTN","MPIFHL7",10,0)
 ..S PHONE=$P(HLNODE,HL("FS"),4)
"RTN","MPIFHL7",11,0)
 ..S COMMENTS=$P(HLNODE,HL("FS"),5)
"RTN","MPIFHL7",12,0)
 ..S STATUS=$P(HLNODE,HL("FS"),6)
"RTN","MPIFHL7",13,0)
 ..S ID=$P(HLNODE,HL("FS"),7)
"RTN","MPIFHL7",14,0)
 ..S SITE=$P(HLNODE,HL("FS"),8)
"RTN","MPIFHL7",15,0)
 .I $P(HLNODE,HL("FS"),1)="EVN" D
"RTN","MPIFHL7",16,0)
 ..S NDATE=$P(HLNODE,HL("FS"),3)
"RTN","MPIFHL7",17,0)
 ..S USER=$P(HLNODE,HL("FS"),6)
"RTN","MPIFHL7",18,0)
 .I $P(HLNODE,HL("FS"),1)="PID" S ICN=+$P(HLNODE,HL("FS"),3)
"RTN","MPIFHL7",19,0)
 .I $P(HLNODE,HL("FS"),1)="PV1" S SITE=+$P(HLNODE,HL("FS"),4)
"RTN","MPIFHL7",20,0)
 I $G(SITE) S SITE=$$LKUP^XUAF4(SITE)
"RTN","MPIFHL7",21,0)
 N DFN
"RTN","MPIFHL7",22,0)
 S RES=1,DFN=$$GETDFN^MPIF001(ICN)
"RTN","MPIFHL7",23,0)
 S CMOR=$$GETVCCI^MPIF001(DFN)
"RTN","MPIFHL7",24,0)
 I SITE'=CMOR D  Q
"RTN","MPIFHL7",25,0)
 .;PROCESSING CMOR CHANGE REQUEST
"RTN","MPIFHL7",26,0)
 .D IN^MPIFREQ(SITE,USER,COMMENTS,NDATE,ICN,PHONE,ID)
"RTN","MPIFHL7",27,0)
 I ID="" D  Q
"RTN","MPIFHL7",28,0)
 .I SITE'="" S SITE=$$CMORNAME^MPIF001(SITE),RES=$$CHANGE^MPIF001(DFN,SITE)
"RTN","MPIFHL7",29,0)
 I +RES<1 D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to Change CMOR to "_SITE_" in a CMOR Change Message for patient DFN= "_DFN_" Request # "_ID,DFN),STOP^RGHLLOG(),RESET^MPIFREQ(ID)
"RTN","MPIFHL7",30,0)
 Q
"RTN","MPIFQUE5")
0^3^B10171215
"RTN","MPIFQUE5",1,0)
MPIFQUE5 ;SF/TNV-Process the RESULT from CMOR COMPARISON request ;FEB 20, 1998
"RTN","MPIFQUE5",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,6**;30 Apr 99
"RTN","MPIFQUE5",3,0)
 ; 
"RTN","MPIFQUE5",4,0)
 ; This routine will process the message from the CMOR site to change
"RTN","MPIFQUE5",5,0)
 ; the CMOR as a result of a change cmor request
"RTN","MPIFQUE5",6,0)
 ;
"RTN","MPIFQUE5",7,0)
EN ; Entry point for process the update of CMOR
"RTN","MPIFQUE5",8,0)
 N U,LINE,IKI,ERROR,RGL,RGLOG
"RTN","MPIFQUE5",9,0)
 S U="^"
"RTN","MPIFQUE5",10,0)
 D START^RGHLLOG()
"RTN","MPIFQUE5",11,0)
 ;
"RTN","MPIFQUE5",12,0)
 N MPII,U,LINE,ERROR,PARENT,COUNT,NDATE,IKI,MPIFFS,MPIFSFS,MPIFREAP,RGLOG
"RTN","MPIFQUE5",13,0)
 F MPII=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFQUE5",14,0)
 . S LINE=HLNODE
"RTN","MPIFQUE5",15,0)
 . I $P(LINE,HL("FS"))["MSH" D MSH
"RTN","MPIFQUE5",16,0)
 . I $P(LINE,HL("FS"))["PV1" D PV1
"RTN","MPIFQUE5",17,0)
 . I $P(LINE,HL("FS"))["PID" D PID
"RTN","MPIFQUE5",18,0)
 I $G(ERROR)]"" D ACK Q          ; Any problems before changing the CMOR
"RTN","MPIFQUE5",19,0)
 I ($G(SITE)]"")&($G(DFN)]"") D CHANGE
"RTN","MPIFQUE5",20,0)
 I $G(SITE)=""!($G(DFN)="") D
"RTN","MPIFQUE5",21,0)
 .S ERROR="Missing new CMOR or Patient to be changed"
"RTN","MPIFQUE5",22,0)
 .D EXC^RGHLLOG(219,ERROR_" for change CMOR request HL7 msg "_HLMTIEN)
"RTN","MPIFQUE5",23,0)
 D ACK
"RTN","MPIFQUE5",24,0)
 Q
"RTN","MPIFQUE5",25,0)
 ;
"RTN","MPIFQUE5",26,0)
MSH ; Process MSH segment
"RTN","MPIFQUE5",27,0)
 I $P(LINE,HL("FS"),16)="AL" S ACK="YES"
"RTN","MPIFQUE5",28,0)
 I $P(LINE,HL("FS"),16)="ER" S ACK="ERROR"
"RTN","MPIFQUE5",29,0)
 Q
"RTN","MPIFQUE5",30,0)
 ;
"RTN","MPIFQUE5",31,0)
PV1 ; Process PV1 segment
"RTN","MPIFQUE5",32,0)
 S SITE=$P(LINE,HL("FS"),4)
"RTN","MPIFQUE5",33,0)
 I SITE="" S ERROR="Missing CMOR site number in Change CMOR message for ICN "_ICN_" HL7 msg# "_HLMTIEN D EXC^RGHLLOG(221,ERROR)
"RTN","MPIFQUE5",34,0)
 Q
"RTN","MPIFQUE5",35,0)
NTE ; Process NTE segment
"RTN","MPIFQUE5",36,0)
 S SITE=$P(LINE,HL("FS"),8)
"RTN","MPIFQUE5",37,0)
 I SITE="" S ERROR="Missing CMOR site number in Change CMOR message for ICN "_ICN_" HL7 msg# "_HLMTIEN D EXC^RGHLLOG(221,ERROR)
"RTN","MPIFQUE5",38,0)
 Q
"RTN","MPIFQUE5",39,0)
 ;
"RTN","MPIFQUE5",40,0)
PID ; Process PID segment
"RTN","MPIFQUE5",41,0)
 S ICN=+$P(LINE,HL("FS"),3)                  ; get ICN out.
"RTN","MPIFQUE5",42,0)
 I ICN<1 S ERROR="Missing Patient ICN in Change CMOR message HL7 msg# "_HLMTIEN D EXC^RGHLLOG(219,ERROR) Q
"RTN","MPIFQUE5",43,0)
 S DFN=$$IEN^MPIFNQ(ICN)                  ; get DFN of this patient
"RTN","MPIFQUE5",44,0)
 I DFN="" S ERROR="ICN "_ICN_" not found from Change CMOR message HL7 msg# "_HLMTIEN D EXC^RGHLLOG(219,ERROR) Q
"RTN","MPIFQUE5",45,0)
 Q
"RTN","MPIFQUE5",46,0)
 ;
"RTN","MPIFQUE5",47,0)
CHANGE ; Process the change CMOR to the new CMOR site (YOUR SITE NOW)
"RTN","MPIFQUE5",48,0)
 S DIC="^DIC(4,",DIC(0)="QMOZX",X=SITE D ^DIC K DIC          ; Figure out
"RTN","MPIFQUE5",49,0)
 I Y=-1 S ERROR="CMOR Site name is not on file for Station Number "_SITE_" processing Change CMOR msg for ICN "_ICN D EXC^RGHLLOG(211,ERROR) Q            ; the CMOR site
"RTN","MPIFQUE5",50,0)
 S CHANGE=$$CHANGE^MPIF001(+DFN,+Y)              ; name and change
"RTN","MPIFQUE5",51,0)
 I +CHANGE=-1 S ERROR="Unable to update CMOR for site "_SITE_". For DFN "_DFN_" Processing CHANGE CMOR message "_HLMTIEN D EXC^RGHLLOG(211,ERROR,DFN)
"RTN","MPIFQUE5",52,0)
 Q
"RTN","MPIFQUE5",53,0)
 ;
"RTN","MPIFQUE5",54,0)
ACK ; Clean up the partition.
"RTN","MPIFQUE5",55,0)
 ;
"RTN","MPIFQUE5",56,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE5",57,0)
 K X,Y,DFN,ICN,SITE,MPIFREAP,ACK,PARENT,CHANGE
"RTN","MPIFQUE5",58,0)
 Q
"RTN","MPIFREQ")
0^6^B20475156
"RTN","MPIFREQ",1,0)
MPIFREQ ;SF/TN/CMC; CMOR CHANGE REQUEST ;FEB 20, 1998
"RTN","MPIFREQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,6**;30 Apr 99
"RTN","MPIFREQ",3,0)
 ;
"RTN","MPIFREQ",4,0)
EN(TYPE,REQNO,ERROR,HL7) ;
"RTN","MPIFREQ",5,0)
 ; Create HL7 message for Change of CMOR Request
"RTN","MPIFREQ",6,0)
 N RGL,INST,USER,REASON,NDATE,ICN,PHONE,N0,CNT,HLA,HL,ID,XX,PID
"RTN","MPIFREQ",7,0)
 S CNT=0,HL=0
"RTN","MPIFREQ",8,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFREQ",9,0)
 I N0="" S ERROR="Node for request #"_REQNO_" is not defined" Q
"RTN","MPIFREQ",10,0)
 S INST=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFREQ",11,0)
 N X,Y,DIC
"RTN","MPIFREQ",12,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(N0,"^",2)
"RTN","MPIFREQ",13,0)
 D ^DIC
"RTN","MPIFREQ",14,0)
 I $G(Y)<1 S USER=""
"RTN","MPIFREQ",15,0)
 I $G(Y)>0 S USER=$G(Y(0,0))
"RTN","MPIFREQ",16,0)
 S REASON=$P($G(^MPIF(984.9,REQNO,1)),"^",2)
"RTN","MPIFREQ",17,0)
 S NDATE=$P(N0,"^",3)
"RTN","MPIFREQ",18,0)
 S ICN=$$ICN^MPIFNQ(+$P(N0,"^",4))
"RTN","MPIFREQ",19,0)
 S PHONE=$P(N0,"^",5)
"RTN","MPIFREQ",20,0)
 S ID=$P(N0,"^")
"RTN","MPIFREQ",21,0)
 D INIT^HLFNC2("MPIF CMOR REQUEST",.HL)
"RTN","MPIFREQ",22,0)
 I HL D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQNO),STOP^RGHLLOG() D RESET(REQNO) Q
"RTN","MPIFREQ",23,0)
 K HLL("LINKS")
"RTN","MPIFREQ",24,0)
 D LINK^HLUTIL3($P(N0,"^",7),.RGL)
"RTN","MPIFREQ",25,0)
 S XX=$O(RGL(0))
"RTN","MPIFREQ",26,0)
 I XX>0,$E($G(RGL(XX)),1,2)'="VA" D START^RGHLLOG(),EXC^RGHLLOG(224,"Unable to send Request to change CMOR request#"_REQNO_"  No CIRN logical link for site "_XX),STOP^RGHLLOG() D RESET(REQNO) Q
"RTN","MPIFREQ",27,0)
 I XX>0 S HLL("LINKS",1)="MPIF CMOR RESPONSE^"_RGL(XX)
"RTN","MPIFREQ",28,0)
 S CNT=CNT+1,PID=$$EN^VAFCPID(+$P(N0,"^",4),"1,2,4,5,6,7,8,11,12,13,14,16,17,19")
"RTN","MPIFREQ",29,0)
 S HLA("HLS",CNT)=PID
"RTN","MPIFREQ",30,0)
 S CNT=CNT+1
"RTN","MPIFREQ",31,0)
 S HLA("HLS",CNT)="NTE"_HL("FS")_HL("FS")_"P"_HL("FS")_PHONE_HL("FS")_REASON_HL("FS")_HL("FS")_ID_HL("FS")_INST
"RTN","MPIFREQ",32,0)
 S CNT=CNT+1
"RTN","MPIFREQ",33,0)
 S HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_USER
"RTN","MPIFREQ",34,0)
 N RLST
"RTN","MPIFREQ",35,0)
 D GENERATE^HLMA("MPIF CMOR REQUEST","LM",1,.RLST,"",.HL)
"RTN","MPIFREQ",36,0)
 I 'RLST D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQNO),STOP^RGHLLOG(),RESET(REQNO)
"RTN","MPIFREQ",37,0)
 Q
"RTN","MPIFREQ",38,0)
 ;
"RTN","MPIFREQ",39,0)
RESET(REQNO) ; reset status to Open
"RTN","MPIFREQ",40,0)
 S DIE="^MPIF(984.9,",DA=REQNO,DR=".06///1" D ^DIE
"RTN","MPIFREQ",41,0)
 K DIE,DA,DR
"RTN","MPIFREQ",42,0)
 Q
"RTN","MPIFREQ",43,0)
 ;
"RTN","MPIFREQ",44,0)
IN(INST,USER,REASON,NDATE,ICN,PHONE,ID) ;Process an incoming CMOR request
"RTN","MPIFREQ",45,0)
 N PATIEN,MAIL,MPIF,TYPE,N0,IEN,XMCHAN,XMDUZ,XMTEXT,XMSUB,XMY,TEXT,X
"RTN","MPIFREQ",46,0)
 S PATIEN=$$GETDFN^MPIF001(ICN)
"RTN","MPIFREQ",47,0)
 I PATIEN<1 D  Q
"RTN","MPIFREQ",48,0)
 . D START^RGHLLOG()
"RTN","MPIFREQ",49,0)
 . D EXC^RGHLLOG(210,"Received CMOR Change Request for ICN "_ICN_" ICN not Found. Request # "_ID)
"RTN","MPIFREQ",50,0)
 . D STOP^RGHLLOG()
"RTN","MPIFREQ",51,0)
 S IEN=$$ADD^MPIFNEW(ID) ;add request to request file
"RTN","MPIFREQ",52,0)
 S TYPE=$S(+$P($$SITE^VASITE(),"^",3)=$$PAT^MPIFNQ(PATIEN):1,1:3)
"RTN","MPIFREQ",53,0)
 S DIE="^MPIF(984.9,",DA=IEN,DR="[MPIF REQUEST INCOMING]" D ^DIE
"RTN","MPIFREQ",54,0)
 I $$AUTO^MPIFNQ() D AUTO(IEN) Q
"RTN","MPIFREQ",55,0)
 S MAIL=$$MAIL^MPIFUTL()
"RTN","MPIFREQ",56,0)
 I MAIL="" S MAIL="MPIF EXCEPTIONS"
"RTN","MPIFREQ",57,0)
 S XMDUZ="MPI VISTA Package",XMTEXT="MPIF(1,",MPIF(1,1)="New CIRN Master Of Record (CMOR) request received for patient "_$S($P($G(^DPT(+PATIEN,0)),U)]"":$P(^DPT(PATIEN,0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",1:"UNKNOWN")
"RTN","MPIFREQ",58,0)
 I MAIL="MPIF EXCEPTIONS" S XMTEXT=XMTEXT_" no mail group defined for CMOR requests"
"RTN","MPIFREQ",59,0)
 S XMSUB="CMOR Change Request #"_$P(^MPIF(984.9,IEN,0),"^"),XMY("G."_MAIL)="" D ^XMD
"RTN","MPIFREQ",60,0)
 Q
"RTN","MPIFREQ",61,0)
 ;
"RTN","MPIFREQ",62,0)
AUTO(REQNO) ;Process a request automatically
"RTN","MPIFREQ",63,0)
 N DFN,ERROR,DIE,DR,DA,CMOR,RES
"RTN","MPIFREQ",64,0)
 S DIE="^MPIF(984.9,",DR="[MPIF REVIEW AUTO]",DA=REQNO D ^DIE
"RTN","MPIFREQ",65,0)
 S DFN=$P($G(^MPIF(984.9,REQNO,0)),"^",4)
"RTN","MPIFREQ",66,0)
 S CMOR=$$CMORNAME^MPIF001($P(^MPIF(984.9,REQNO,0),"^",7))
"RTN","MPIFREQ",67,0)
 I +CMOR=-1 D START^RGHLLOG(),EXC^RGHLLOG(220,"CMOR not sent in Change CMOR message for patient DFN= "_DFN_" Request # "_REQNO,DFN),STOP^RGHLLOG(),RESET2(REQNO)
"RTN","MPIFREQ",68,0)
 Q:+CMOR=-1      ;No CMOR defined
"RTN","MPIFREQ",69,0)
 I $P($G(^MPIF(984.9,REQNO,1)),"^",3)=1 D
"RTN","MPIFREQ",70,0)
 .S RES=1,RES=$$CHANGE^MPIF001(DFN,CMOR)
"RTN","MPIFREQ",71,0)
 .I +RES<1 I +RES<1 D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to Change CMOR to "_CMOR_" in a CMOR Change Message for Patient DFN= "_DFN_" Request # "+REQNO,DFN),STOP^RGHLLOG(),RESET2(REQNO)
"RTN","MPIFREQ",72,0)
 .Q:+RES<1
"RTN","MPIFREQ",73,0)
 .D BROAD^MPIFCMOR(REQNO)
"RTN","MPIFREQ",74,0)
 Q
"RTN","MPIFREQ",75,0)
 ;
"RTN","MPIFREQ",76,0)
RESET2(REQNO) ; reset status to Pending Approval
"RTN","MPIFREQ",77,0)
 S DIE="^MPIF(984.9,",DA=REQNO,DR=".06///3" D ^DIE
"RTN","MPIFREQ",78,0)
 K DIE,DA,DR
"RTN","MPIFREQ",79,0)
 Q
"RTN","MPIFRESS")
0^2^B13652452
"RTN","MPIFRESS",1,0)
MPIFRESS ;BHM/RGY-Process a CMOR result ;FEB 27, 1998
"RTN","MPIFRESS",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,6**;30 Apr 99
"RTN","MPIFRESS",3,0)
 ;
"RTN","MPIFRESS",4,0)
EN(REQNO) ;
"RTN","MPIFRESS",5,0)
 N RGL,ID,COMMENTS,STATUS,NDATE,PHONE,REVIEWER,N0,CNT,HL,HLA,XX,ERROR
"RTN","MPIFRESS",6,0)
 S CNT=0,HL=0
"RTN","MPIFRESS",7,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFRESS",8,0)
 I N0="" D  Q
"RTN","MPIFRESS",9,0)
 .D START^RGHLLOG()
"RTN","MPIFRESS",10,0)
 .D EXC^RGHLLOG(210,"CMOR Request # "_REQNO_" Does Not Exist attemptingto generate approved/not approved msg")
"RTN","MPIFRESS",11,0)
 .D STOP^RGHLLOG()
"RTN","MPIFRESS",12,0)
 S ID=$P(N0,"^")
"RTN","MPIFRESS",13,0)
 S STATUS=$P(N0,"^",6)
"RTN","MPIFRESS",14,0)
 S COMMENTS=$P($G(^MPIF(984.9,REQNO,3)),"^",2)
"RTN","MPIFRESS",15,0)
 I $P($G(^MPIF(984.9,REQNO,3)),"^")]"" S REVIEWER=$P(^(3),"^")
"RTN","MPIFRESS",16,0)
 I $P($G(^MPIF(984.9,REQNO,3)),"^")']"" D
"RTN","MPIFRESS",17,0)
 .N DIC,X,Y
"RTN","MPIFRESS",18,0)
 .S DIC="^VA(200,",DIC(0)="ZMO",X="`"_+$P(^MPIF(984.9,REQNO,2),"^")
"RTN","MPIFRESS",19,0)
 .I $G(Y)>1 S REVIEWER=$G(Y(0,0))
"RTN","MPIFRESS",20,0)
 .I $G(Y)<1 S REVIEWER=""
"RTN","MPIFRESS",21,0)
 S NDATE=$P($G(^MPIF(984.9,REQNO,2)),"^",2)
"RTN","MPIFRESS",22,0)
 S PHONE=$P($G(^MPIF(984.9,REQNO,2)),"^",3)
"RTN","MPIFRESS",23,0)
 S COMMENTS=$P($G(^MPIF(984.9,REQNO,3)),"^",2)
"RTN","MPIFRESS",24,0)
 D INIT^HLFNC2("MPIF CMOR APPROVE/DISAPPROVE",.HL)
"RTN","MPIFRESS",25,0)
 I HL S ERROR=HL D  Q
"RTN","MPIFRESS",26,0)
 .D START^RGHLLOG()
"RTN","MPIFRESS",27,0)
 .D EXC^RGHLLOG(220,"Unable to setup HL7 for Change CMOR Request # "_REQNO_" for Approved/Not Approved msg HL Error"_HL)
"RTN","MPIFRESS",28,0)
 .D STOP^RGHLLOG()
"RTN","MPIFRESS",29,0)
 K HLL("LINKS")
"RTN","MPIFRESS",30,0)
 D LINK^HLUTIL3($P(N0,"^",7),.RGL) ;get link for site
"RTN","MPIFRESS",31,0)
 S XX=$O(RGL(0))
"RTN","MPIFRESS",32,0)
 I XX>0,$E($G(RGL(XX)),1,2)'="VA" D START^RGHLLOG(),EXC^RGHLLOG(224,"Unable to send approve/not approved msg for CMOR request# "_REQNO_"  No a CIRN logical link for site "_XX),STOP^RGHLLOG() Q
"RTN","MPIFRESS",33,0)
 I XX>0 S HLL("LINKS",1)="MPIF CMOR APP/DIS^"_RGL(XX)
"RTN","MPIFRESS",34,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_REVIEWER
"RTN","MPIFRESS",35,0)
 S CNT=CNT+1,HLA("HLS",CNT)="NTE"_HL("FS")_HL("FS")_"P"_HL("FS")_PHONE_HL("FS")_COMMENTS_HL("FS")_STATUS_HL("FS")_ID
"RTN","MPIFRESS",36,0)
 N RLST
"RTN","MPIFRESS",37,0)
 D GENERATE^HLMA("MPIF CMOR APPROVE/DISAPPROVE","LM",1,.RLST,"",.HL)
"RTN","MPIFRESS",38,0)
 I 'RLST S ERROR=RLST D START^RGHLLOG(),EXC^RGHLLOG(220,"Error Generating HL7 msg for Approve/Not Approved CMOR Request # "_REQNO)
"RTN","MPIFRESS",39,0)
 Q
"RTN","MPIFRESS",40,0)
 ;
"RTN","MPIFRESS",41,0)
IN ;
"RTN","MPIFRESS",42,0)
 ; Processing approve/not approve msg to update Request in 984.9 file
"RTN","MPIFRESS",43,0)
 N DFN,ENT,XMY,XMDUZ,XMTEXT,MPIF,XMSUB,FSITE,CMOR,PHONE,RESULT,REVIEWER,COMMENTS,NDATE,II
"RTN","MPIFRESS",44,0)
 S HLQUIT="",ID=""
"RTN","MPIFRESS",45,0)
 F II=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFRESS",46,0)
 .I $P(HLNODE,HL("FS"),1)="NTE" D
"RTN","MPIFRESS",47,0)
 ..S ID=$P(HLNODE,HL("FS"),7),RESULT=$P(HLNODE,HL("FS"),6)
"RTN","MPIFRESS",48,0)
 ..S PHONE=$P(HLNODE,HL("FS"),4)
"RTN","MPIFRESS",49,0)
 ..S COMMENTS=$P(HLNODE,HL("FS"),5)
"RTN","MPIFRESS",50,0)
 .I $P(HLNODE,HL("FS"),1)="EVN" D
"RTN","MPIFRESS",51,0)
 ..S NDATE=$P(HLNODE,HL("FS"),3)
"RTN","MPIFRESS",52,0)
 ..S REVIEWER=$P(HLNODE,HL("FS"),6)
"RTN","MPIFRESS",53,0)
 S ENT=$O(^MPIF(984.9,"B",ID,0))
"RTN","MPIFRESS",54,0)
 Q:'$D(^MPIF(984.9,ENT,0))
"RTN","MPIFRESS",55,0)
 S DFN=$P($G(^MPIF(984.9,ENT,0)),"^",4),FSITE=$P($G(^(0)),"^",7)
"RTN","MPIFRESS",56,0)
 S DIC="^DIC(4,",DIC(0)="MXNZ",X=FSITE D ^DIC
"RTN","MPIFRESS",57,0)
 I $G(Y)>0 S FSITE=$P(Y,"^",2)
"RTN","MPIFRESS",58,0)
 K Y,X,DIC
"RTN","MPIFRESS",59,0)
 S DIE="^MPIF(984.9,",DA=ENT,DR="[MPIF RESULT INCOMING]" D ^DIE K DIE,DA,DR
"RTN","MPIFRESS",60,0)
 S XMDUZ="MPI VISTA Package"
"RTN","MPIFRESS",61,0)
 S XMSUB="Request "_ID_" is "_$S(RESULT=4:"approved",1:"disapproved")
"RTN","MPIFRESS",62,0)
 S XMY($P(^MPIF(984.9,ENT,0),"^",2))="",XMTEXT="MPIF(1,"
"RTN","MPIFRESS",63,0)
 S MPIF(1,1)=FSITE_" received CMOR request for "_$P($G(^DPT(+$P(^MPIF(984.9,ENT,0),"^",4),0)),"^")_" ("_$E($P(^(0),"^",9),6,9)_")."
"RTN","MPIFRESS",64,0)
 S MPIF(1,2)=XMSUB_"."
"RTN","MPIFRESS",65,0)
 D ^XMD
"RTN","MPIFRESS",66,0)
 Q
"RTN","MPIFREV")
0^5^B11498409
"RTN","MPIFREV",1,0)
MPIFREV ;BHM/RGY-Review CMOR request ;FEB 26, 1998
"RTN","MPIFREV",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**6**;30 Apr 99
"RTN","MPIFREV",3,0)
EN ;
"RTN","MPIFREV",4,0)
 ; Entry point for option MPIF REVIEW REQUEST.  This option allows the
"RTN","MPIFREV",5,0)
 ; user to review CMOR Change requests and approve or deny them
"RTN","MPIFREV",6,0)
 ; No input or output variables.
"RTN","MPIFREV",7,0)
 N DIC
"RTN","MPIFREV",8,0)
ASK S DIC="^MPIF(984.9,",DIC("A")="Select CMOR request to review: ",DIC(0)="QEAM" D ^DIC Q:+Y<0
"RTN","MPIFREV",9,0)
 D EN1(+Y)
"RTN","MPIFREV",10,0)
 G ASK
"RTN","MPIFREV",11,0)
EN1(REQ,MSTOP) ;Review a CMOR request
"RTN","MPIFREV",12,0)
 N DFN,PHONE,RESULT,DIE,DA,DR,ENT,DIC,FR,BY,TO,FLDS,L,DIR,DUTOUT,X,Y,ERR,ER
"RTN","MPIFREV",13,0)
 S MSTOP=0,ER=0
"RTN","MPIFREV",14,0)
 I $P($G(^MPIF(984.9,+REQ,0)),"^",6)'=3 W !,"*** Request is not pending review ***" Q
"RTN","MPIFREV",15,0)
 S L=0,ENT=+REQ,DIC="^MPIF(984.9,",FR=+REQ,TO=+REQ,BY="@NUMBER",FLDS="[MPIF REQUEST VIEW]" D EN1^DIP
"RTN","MPIFREV",16,0)
APP S DIR("A")="Select Review Action ("_$S($P(^MPIF(984.9,ENT,0),"^",4)]"":"APPROVE/",1:"")_"DISAPPROVE, OR '^' to Exit)? "
"RTN","MPIFREV",17,0)
 S DIR(0)="SAO^"_$S($P(^MPIF(984.9,ENT,0),"^",4)]"":"A:APPROVE;",1:"")_"D:DISAPPROVE"
"RTN","MPIFREV",18,0)
 N DIRUT,DTOUT
"RTN","MPIFREV",19,0)
 D ^DIR K DIR
"RTN","MPIFREV",20,0)
 I $D(DIRUT) S:X="^"!$D(DTOUT) MSTOP=1 W " ... No Action!" Q
"RTN","MPIFREV",21,0)
 S RESULT=Y
"RTN","MPIFREV",22,0)
 S PHONE=$P($G(^MPIF(984.9,+$O(^MPIF(984.9,"AE",DUZ,""),-1),2)),"^",3)
"RTN","MPIFREV",23,0)
 S DIE="^MPIF(984.9,",DR="[MPIF REVIEW RESULT]",DA=ENT D ^DIE
"RTN","MPIFREV",24,0)
 I $D(Y)!$D(DTOUT) S:$D(DTOUT) MSTOP=1 S DIE="^MPIF(984.9,",DR="[MPIF REVIEW RESET]",DA=ENT D ^DIE W " ... No Action!" Q
"RTN","MPIFREV",25,0)
 W !!," Processing.....",!
"RTN","MPIFREV",26,0)
 S DFN=$P($G(^MPIF(984.9,ENT,0)),"^",4)
"RTN","MPIFREV",27,0)
 I $E(RESULT)="A" D
"RTN","MPIFREV",28,0)
 .S ERR=$$CHANGE^MPIF001(DFN,+$P($G(^MPIF(984.9,ENT,0)),"^",7))
"RTN","MPIFREV",29,0)
 .;log exception if problem with updating CMOR
"RTN","MPIFREV",30,0)
 .I +ERR<0 D  Q
"RTN","MPIFREV",31,0)
 ..D START^RGHLLOG()
"RTN","MPIFREV",32,0)
 ..D EXC^RGHLLOG(220,"Unable to change CMOR for Change CMOR Request for patient DFN= "_DFN_" Request # "_ENT,DFN)
"RTN","MPIFREV",33,0)
 ..D STOP^RGHLLOG(),RESET2^MPIFREQ(ENT)
"RTN","MPIFREV",34,0)
 ..W !!,"  Problem Changing CMOR, resetting status to pending approval.  May be duplicates in Institution file for new CMOR or Patient file entry was already being edited.",!!
"RTN","MPIFREV",35,0)
 .I +ERR>0 D BROAD^MPIFCMOR(ENT,.ER)
"RTN","MPIFREV",36,0)
 I +ER=0 D EN^MPIFRESS(ENT)
"RTN","MPIFREV",37,0)
 I +ER=-1 W !!," Problem during Broadcast - "_$P(ER,"^",2) Q
"RTN","MPIFREV",38,0)
 W !!," ... Done!",!!
"RTN","MPIFREV",39,0)
 Q
"RTN","MPIFREV",40,0)
 ;
"RTN","MPIFREV",41,0)
BATCH ;Approve in batch mode
"RTN","MPIFREV",42,0)
 NEW SITE,DIR,DIRUT,IOP,MSTOP,IEN
"RTN","MPIFREV",43,0)
 I $O(^MPIF(984.9,"AC",3,0))="" W !!,"*** No request to approve ***",! Q
"RTN","MPIFREV",44,0)
 S MSTOP=0,SITE=0
"RTN","MPIFREV",45,0)
 S DIR("A")="Do you want to approve by SITE",DIR(0)="Y"
"RTN","MPIFREV",46,0)
 D ^DIR K DIR
"RTN","MPIFREV",47,0)
 Q:$D(DIRUT)
"RTN","MPIFREV",48,0)
 W !
"RTN","MPIFREV",49,0)
 I Y=0 D  Q
"RTN","MPIFREV",50,0)
 .F IEN=0:0 S IEN=$O(^MPIF(984.9,"AC",3,IEN)) Q:'IEN  S IOP=ION D EN1(IEN,.MSTOP) Q:MSTOP
"RTN","MPIFREV",51,0)
 .Q
"RTN","MPIFREV",52,0)
SITE S DIC("A")="Select Site: ",DIC="^DIC(4,",DIC(0)="QEAM",DIC("S")="I $D(MPIF(984.0,""AS"",Y))" D ^DIC Q:Y<0  S SITE=+Y
"RTN","MPIFREV",53,0)
 I $O(^MPIF(984.9,"AS",SITE,3,0))="" W !!,"*** No requests to approve for this site ***",! G SITE
"RTN","MPIFREV",54,0)
 W !
"RTN","MPIFREV",55,0)
 F IEN=0:0 S IEN=$O(^MPIF(984.9,"AS",SITE,3,IEN)) Q:'IEN  S IOP=ION D EN1(IEN,.MSTOP) Q:MSTOP
"RTN","MPIFREV",56,0)
 Q
"VER")
8.0^22.0
**END**
**END**
