Released RG*1*8 SEQ #7
Extracted from mail message
**KIDS**:RG*1.0*8^

**INSTALL NAME**
RG*1.0*8
"BLD",1056,0)
RG*1.0*8^CLINICAL INFO RESOURCE NETWORK^0^3000929^y
"BLD",1056,1,0)
^^3^3^3000811^
"BLD",1056,1,1,0)
SENDING FACILITY FORMAT / EXCEPTION MESSAGES
"BLD",1056,1,2,0)
Refer to patch RG*1*8 in the FORUM Patch Module for a complete
"BLD",1056,1,3,0)
description.
"BLD",1056,4,0)
^9.64PA^^
"BLD",1056,"ABNS",0)
^9.66A^^
"BLD",1056,"ABPKG")
^^
"BLD",1056,"KRN",0)
^9.67PA^19^17
"BLD",1056,"KRN",.4,0)
.4
"BLD",1056,"KRN",.401,0)
.401
"BLD",1056,"KRN",.402,0)
.402
"BLD",1056,"KRN",.403,0)
.403
"BLD",1056,"KRN",.5,0)
.5
"BLD",1056,"KRN",.84,0)
.84
"BLD",1056,"KRN",3.6,0)
3.6
"BLD",1056,"KRN",3.8,0)
3.8
"BLD",1056,"KRN",9.2,0)
9.2
"BLD",1056,"KRN",9.8,0)
9.8
"BLD",1056,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",1056,"KRN",9.8,"NM",1,0)
RGADT^^0^B10112572
"BLD",1056,"KRN",9.8,"NM",2,0)
RGRSMSH^^0^B1170626
"BLD",1056,"KRN",9.8,"NM",3,0)
RGJCREC^^0^B36395410
"BLD",1056,"KRN",9.8,"NM",4,0)
RGRSDYN^^0^B5259834
"BLD",1056,"KRN",9.8,"NM",5,0)
RGRSDYN1^^0^B14998307
"BLD",1056,"KRN",9.8,"NM",6,0)
RGRSDYN2^^0^B3838572
"BLD",1056,"KRN",9.8,"NM",7,0)
RGRSPT^^0^B14853714
"BLD",1056,"KRN",9.8,"NM","B","RGADT",1)

"BLD",1056,"KRN",9.8,"NM","B","RGJCREC",3)

"BLD",1056,"KRN",9.8,"NM","B","RGRSDYN",4)

"BLD",1056,"KRN",9.8,"NM","B","RGRSDYN1",5)

"BLD",1056,"KRN",9.8,"NM","B","RGRSDYN2",6)

"BLD",1056,"KRN",9.8,"NM","B","RGRSMSH",2)

"BLD",1056,"KRN",9.8,"NM","B","RGRSPT",7)

"BLD",1056,"KRN",19,0)
19
"BLD",1056,"KRN",19.1,0)
19.1
"BLD",1056,"KRN",101,0)
101
"BLD",1056,"KRN",409.61,0)
409.61
"BLD",1056,"KRN",771,0)
771
"BLD",1056,"KRN",870,0)
870
"BLD",1056,"KRN",8994,0)
8994
"BLD",1056,"KRN","B",.4,.4)

"BLD",1056,"KRN","B",.401,.401)

"BLD",1056,"KRN","B",.402,.402)

"BLD",1056,"KRN","B",.403,.403)

"BLD",1056,"KRN","B",.5,.5)

"BLD",1056,"KRN","B",.84,.84)

"BLD",1056,"KRN","B",3.6,3.6)

"BLD",1056,"KRN","B",3.8,3.8)

"BLD",1056,"KRN","B",9.2,9.2)

"BLD",1056,"KRN","B",9.8,9.8)

"BLD",1056,"KRN","B",19,19)

"BLD",1056,"KRN","B",19.1,19.1)

"BLD",1056,"KRN","B",101,101)

"BLD",1056,"KRN","B",409.61,409.61)

"BLD",1056,"KRN","B",771,771)

"BLD",1056,"KRN","B",870,870)

"BLD",1056,"KRN","B",8994,8994)

"BLD",1056,"QUES",0)
^9.62^^
"BLD",1056,"REQB",0)
^9.611^5^3
"BLD",1056,"REQB",3,0)
RG*1.0*4^2
"BLD",1056,"REQB",4,0)
DG*5.3*307^2
"BLD",1056,"REQB",5,0)
RG*1.0*7^2
"BLD",1056,"REQB","B","DG*5.3*307",4)

"BLD",1056,"REQB","B","RG*1.0*4",3)

"BLD",1056,"REQB","B","RG*1.0*7",5)

"MBREQ")
0
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^^0
"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
8^3000929^12596
"PKG",272,22,1,"PAH",1,1,0)
^^3^3^3000929
"PKG",272,22,1,"PAH",1,1,1,0)
SENDING FACILITY FORMAT / EXCEPTION MESSAGES
"PKG",272,22,1,"PAH",1,1,2,0)
Refer to patch RG*1*8 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","RGADT")
0^1^B10112572
"RTN","RGADT",1,0)
RGADT ;HIRMFO/GJC-ADT MESSAGE PROCESSING/ROUTING ;09/21/99
"RTN","RGADT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4,8**;30 Apr 99
"RTN","RGADT",3,0)
 Q  ; quit if called from the top
"RTN","RGADT",4,0)
 ;
"RTN","RGADT",5,0)
EN ;entry point to process local ADT messages.
"RTN","RGADT",6,0)
 ;
"RTN","RGADT",7,0)
 ;This is call by the following clients:
"RTN","RGADT",8,0)
 ; RG ADT-A01 CLIENT & RG ADT-A03 CLIENT (Generate/Process
"RTN","RGADT",9,0)
 ; Routine(771) & Routing Logic(774) field definitions
"RTN","RGADT",10,0)
 ;
"RTN","RGADT",11,0)
 K RGDC,RGDCDFN,RGDCERR,RGDCEVN,RGDCEVN1,RGDCPID,RGDCSFN,RGDCV
"RTN","RGADT",12,0)
 S U="^" D INITIZE^RGRSUTIL ; copy HL7 message into local RGDC array
"RTN","RGADT",13,0)
 S RGDCV=$$EN^RGRSMSH() ;return: dt rec'd^event dt^sending fac.(xternal)
"RTN","RGADT",14,0)
 ; note: the above dates are in FileMan internal format
"RTN","RGADT",15,0)
 S RGDCPID=$$SEG1^RGRSUTIL("PID",1,"PID")
"RTN","RGADT",16,0)
 S RGDCSFN=$$LKUP^XUAF4(+$P(RGDCV,U,3)) ; obtain TF ien from station #
"RTN","RGADT",17,0)
 S RGDCEVN=$P($$SEG1^RGRSUTIL("EVN",1,"EVN"),U,5) ; event reason code
"RTN","RGADT",18,0)
 S RGDCEVN=$$FIND1^DIC(391.72,"","AXM",RGDCEVN) ; event reason(internal)
"RTN","RGADT",19,0)
 S RGDCEVN1=$P($$SEG1^RGRSUTIL("EVN",1,"EVN"),U,2) ; event type
"RTN","RGADT",20,0)
 S RGDCDFN=$$GETDFN^MPIF001(+$P(RGDCPID,HL("FS"),3))
"RTN","RGADT",21,0)
 ; Note: $P(RGDCPID,HL("FS"),3) is: ICN_"V"_ICN checksum
"RTN","RGADT",22,0)
 S RGDCERR=$$ERR()
"RTN","RGADT",23,0)
 ;
"RTN","RGADT",24,0)
 ; input variables to FILE^VAFCTFU
"RTN","RGADT",25,0)
 ; RGDCDFN - patient ien ; RGDCSFN - treating facility
"RTN","RGADT",26,0)
 ; $P(RGDCV,U,2) - date last treated ; RGDCEVN - event reason
"RTN","RGADT",27,0)
 D FILE^VAFCTFU(RGDCDFN,RGDCSFN_U_$P(RGDCV,U,2)_U_RGDCEVN,1)
"RTN","RGADT",28,0)
 ; call to the TFL utility routine VAFCTFU.  Centrally located code
"RTN","RGADT",29,0)
 ; to add or edit to the TFL file.
"RTN","RGADT",30,0)
 ;
"RTN","RGADT",31,0)
 D GENACK ; generate the 'ack' message
"RTN","RGADT",32,0)
KILL ; kill and exit
"RTN","RGADT",33,0)
 K HLINKP,HLINKX,HLL,RGDC,RGDCDFN,RGDCERR,RGDCEVN,RGDCEVN1,RGDCPID,RGDCSFN,RGDCV
"RTN","RGADT",34,0)
 Q
"RTN","RGADT",35,0)
ERR() ; return the error string (if applicable)
"RTN","RGADT",36,0)
 S:$$FIND1^DIC(391.72,"","AXM",RGDCEVN)="" RGDCERR="could not resolve ADT/HL7 EVENT REASON file pointer"
"RTN","RGADT",37,0)
 S:$$GET1^DIQ(2,RGDCDFN,.01)="" RGDCERR="could not resolve PATIENT file pointer"
"RTN","RGADT",38,0)
 S:$$GET1^DIQ(4,+RGDCSFN_",",.01)="" RGDCERR="could not resolve INSTITUTION file pointer"
"RTN","RGADT",39,0)
 I $G(RGDCERR)="" D
"RTN","RGADT",40,0)
 .D DT^DILF("EXT",$P(RGDCV,"^",2),.RGDCERR)
"RTN","RGADT",41,0)
 .S:RGDCERR=-1 RGDCERR="invalid DATE LAST TREATED date/time value"
"RTN","RGADT",42,0)
 .S:RGDCERR'=-1 RGDCERR="" ; no date/time error
"RTN","RGADT",43,0)
 .Q
"RTN","RGADT",44,0)
 Q $G(RGDCERR)
"RTN","RGADT",45,0)
 ;
"RTN","RGADT",46,0)
DYNROU(RGDCEVT) ; dynamic message routing, but first need to update the
"RTN","RGADT",47,0)
 ; TREATING FACILITY LIST (TFL-391.91) file at the local site
"RTN","RGADT",48,0)
 ; input-{RGDCEVT=event type
"RTN","RGADT",49,0)
 K RGDCEDT,RGDCEVTR,RGDCSITE
"RTN","RGADT",50,0)
 S RGDCSITE=$$KSP^XUPARAM("INST"),U="^"
"RTN","RGADT",51,0)
 S RGDCEDT=$$FMDATE^HLFNC($P($$EVN(),U,3)) ; determine event date/time
"RTN","RGADT",52,0)
 S RGDCEVTR=$$FIND1^DIC(391.72,"","AXM",$P($$EVN(),U,5)) ; event reason
"RTN","RGADT",53,0)
 ;
"RTN","RGADT",54,0)
 ; input variables to FILE^VAFCTFU
"RTN","RGADT",55,0)
 ; DFN - patient ien ; RGDCSITE - treating facility
"RTN","RGADT",56,0)
 ; RGDCEDT - date last treated ; RGDCEVTR - event reason
"RTN","RGADT",57,0)
 D FILE^VAFCTFU(DFN,RGDCSITE_U_RGDCEDT_U_RGDCEVTR,1)
"RTN","RGADT",58,0)
 ; call to the TFL utility routine VAFCTFU.  Centrally located code
"RTN","RGADT",59,0)
 ; to add or edit to the TFL file.
"RTN","RGADT",60,0)
 ;
"RTN","RGADT",61,0)
 ; route the message
"RTN","RGADT",62,0)
 D EN^RGRSDYN("RG ADT-"_RGDCEVT_" CLIENT",0)
"RTN","RGADT",63,0)
 K RGDCEDT,RGDCEVTR,RGDCSITE
"RTN","RGADT",64,0)
 Q
"RTN","RGADT",65,0)
EVN() ; pass back the EVN segment.
"RTN","RGADT",66,0)
 N I,X S I=0
"RTN","RGADT",67,0)
 F  S I=$O(HLA("HLS",I)) Q:I'>0  D  Q:$D(X)
"RTN","RGADT",68,0)
 . S:$P(HLA("HLS",I),U)="EVN" X=$G(HLA("HLS",I))
"RTN","RGADT",69,0)
 . Q
"RTN","RGADT",70,0)
 Q $G(X)
"RTN","RGADT",71,0)
GENACK ; Compile the 'ACK' segment, generate the 'ACK' message.
"RTN","RGADT",72,0)
 S HLA("HLA",1)="MSA"_HL("FS")_$S($G(RGDCERR)]"":"AE",1:"AA")_HL("FS")_HL("MID")_$S($G(RGDCERR)]"":HL("FS")_$G(RGDCERR),1:"")
"RTN","RGADT",73,0)
 S HLEID=HL("EID"),HLEIDS=HL("EIDS"),HLARYTYP="LM",HLFORMAT=1
"RTN","RGADT",74,0)
 D GENACK^HLMA1(HLEID,HLMTIENS,HLEIDS,HLARYTYP,HLFORMAT,.HLRESTLA)
"RTN","RGADT",75,0)
 Q
"RTN","RGJCREC")
0^3^B36395410
"RTN","RGJCREC",1,0)
RGJCREC ;SF/JC,LTL-CIRN SUBSCRIPTION PROCESSOR ;05/12/98
"RTN","RGJCREC",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**1,8**;30 Apr 99
"RTN","RGJCREC",3,0)
REC ;Receive inbound CIRN Subscription request
"RTN","RGJCREC",4,0)
 ;Read in message for file 774 Master File Update
"RTN","RGJCREC",5,0)
 ;
"RTN","RGJCREC",6,0)
 Q:($G(HL("MTN"))'="MFN")!($G(HL("ETN"))'="Z15")  ;only process CIRN MFN/Z15 messages
"RTN","RGJCREC",7,0)
 K RGS,RGSEG,RGFS,RGCS,RGEC,RGSS,RGFILE,RGACT,RGCD,RGID,RGICN,RGSSN,RGPN,RGLL,RGTP,RGAD,RGTD,RGRAP,RGCMOR,RGDFN,RGPPFI,RGSCN,RGCURI,RGFROM,RGTO,RGSTUB,RGAD1,RGL,RGRC,HLER
"RTN","RGJCREC",8,0)
 N RGLOG,RGMTXT,X D START^RGHLLOG(HLMTIEN,"SCN_REQ","")
"RTN","RGJCREC",9,0)
 ;
"RTN","RGJCREC",10,0)
 S RGS="",U="^"
"RTN","RGJCREC",11,0)
 S RGFS=HL("FS") ;Field
"RTN","RGJCREC",12,0)
 S RGCS=$E(HL("ECH"),1) ;Component
"RTN","RGJCREC",13,0)
 S RGRC=$E(HL("ECH"),2) ;Repitition
"RTN","RGJCREC",14,0)
 S RGEC=$E(HL("ECH"),3) ;Escape
"RTN","RGJCREC",15,0)
 S RGSS=$E(HL("ECH"),4) ;Sub-component separator
"RTN","RGJCREC",16,0)
 F RGI=1:1 X HLNEXT Q:HLQUIT'>0  S (RGSEG,RGS(RGI))=HLNODE D
"RTN","RGJCREC",17,0)
 .S J=0 F  S J=$O(HLNODE(J)) Q:'J  S RGS(RGI,J)=HLNODE(J)
"RTN","RGJCREC",18,0)
 .D PARS
"RTN","RGJCREC",19,0)
 ;K RGLL ;TS 3-27-98
"RTN","RGJCREC",20,0)
 ;D PARS add this to hl7 processing logic above
"RTN","RGJCREC",21,0)
 I $D(RGFILE) Q:RGFILE'=774
"RTN","RGJCREC",22,0)
 ;Pt DFN
"RTN","RGJCREC",23,0)
 S RGDFN=$$GETDFN^MPIF001(+RGICN)
"RTN","RGJCREC",24,0)
 I +$$SEND2^VAFCUTL1(RGDFN,"T") D CLEAN Q  ;don't process test patients
"RTN","RGJCREC",25,0)
 ;Validate DFN/ICN/SSN on receiving system
"RTN","RGJCREC",26,0)
 I RGDFN'>0 D  D CLEAN Q
"RTN","RGJCREC",27,0)
 . S RGMTXT=""
"RTN","RGJCREC",28,0)
 . D EXC^RGHLLOG(210,"Msg#"_$G(HL("MID"))_" Bad DFN, "_$G(RGDFN)_", for "_$G(RGPN)_" (ICN#"_$G(RGICN)_")"_RGMTXT,RGDFN) D STOP^RGHLLOG(1) Q
"RTN","RGJCREC",29,0)
 I $P(^DPT(RGDFN,0),U,9)'=RGSSN D  D CLEAN Q
"RTN","RGJCREC",30,0)
 . S RGMTXT=" See Appendix B of the Clinical Information Resource Network (CIRN) Patient Administration User Manual."
"RTN","RGJCREC",31,0)
 . D EXC^RGHLLOG(213,"Msg#"_$G(HL("MID"))_" Mismatched SSN,"_$P(^DPT(RGDFN,0),U,9)_"/"_$G(RGSSN)_" for "_$G(RGPN)_" (ICN#"_$G(RGICN)_")"_RGMTXT,RGDFN) D STOP^RGHLLOG(1) Q
"RTN","RGJCREC",32,0)
 ;Pt CMOR/Subscription Control Number
"RTN","RGJCREC",33,0)
 S RGPPFI=$$GETVCCI^MPIF001(RGDFN)
"RTN","RGJCREC",34,0)
 I +RGPPFI<1 D  D CLEAN Q
"RTN","RGJCREC",35,0)
 . S RGMTXT=""
"RTN","RGJCREC",36,0)
 . D EXC^RGHLLOG(211,"Msg#"_$G(HL("MID"))_" Bad CMOR "_$G(RGPPFI)_" for DFN#"_$G(RGDFN)_RGMTXT,RGDFN) D STOP^RGHLLOG(1) Q
"RTN","RGJCREC",37,0)
 ;Verify that sender and receiver agree on CMOR
"RTN","RGJCREC",38,0)
 I RGCMOR'=RGPPFI D  D CLEAN Q
"RTN","RGJCREC",39,0)
 . S RGMTXT=""
"RTN","RGJCREC",40,0)
 . D EXC^RGHLLOG(211,"Msg#"_$G(HL("MID"))_" Mismatched CMOR, "_$G(RGCMOR)_"/"_$G(RGPPFI)_" for "_$G(RGPN)_" (ICN#"_$G(RGICN)_")"_RGMTXT,RGDFN) D STOP^RGHLLOG(1) Q
"RTN","RGJCREC",41,0)
 S RGSCN=$$GETSCN(RGDFN)
"RTN","RGJCREC",42,0)
 I RGSCN="" D  D CLEAN Q
"RTN","RGJCREC",43,0)
 . S RGMTXT=""
"RTN","RGJCREC",44,0)
 . D EXC^RGHLLOG(228,"Msg#"_$G(HL("MPI"))_" "_$G(RGPN)_" Does not exist in patient database. "_RGMTXT,RGDFN) D STOP^RGHLLOG(1) Q
"RTN","RGJCREC",45,0)
 ;Current Site ien
"RTN","RGJCREC",46,0)
 S RGCURI=+$$SITE^VASITE()
"RTN","RGJCREC",47,0)
 ;If not CMOR, don't update anyone else
"RTN","RGJCREC",48,0)
 I $$IFVCCI^MPIF001(RGDFN)'=1 D FIL K RGLL Q  ;TS 3-27-98
"RTN","RGJCREC",49,0)
 ;If filing data at owner site, que update to CLINICAL SUBSCRIBERS
"RTN","RGJCREC",50,0)
 D REC1
"RTN","RGJCREC",51,0)
 ;Add new clinical subscriber to local registry
"RTN","RGJCREC",52,0)
 D FIL
"RTN","RGJCREC",53,0)
 D REC2
"RTN","RGJCREC",54,0)
CLEAN K RGSTUB,RGLL ;TS 3-27-98
"RTN","RGJCREC",55,0)
 D STOP^RGHLLOG(0)
"RTN","RGJCREC",56,0)
 K RGS,RGSEG,RGFS,RGCS,RGEC,RGSS,RGFILE,RGACT,RGCD,RGID,RGICN,RGSSN,RGPN,RGLL,RGTP,RGAD,RGTD,RGRAP,RGCMOR,RGDFN,RGPPFI,RGSCN,RGCURI,RGFROM,RGTO,RGSTUB,RGAD1,RGL,RGRC,RGI
"RTN","RGJCREC",57,0)
 Q
"RTN","RGJCREC",58,0)
REC1 ;Update clinical subscribers with newest one
"RTN","RGJCREC",59,0)
 D GET^RGRSDYN1(RGDFN,RGSCN,0,"",.RGLL)
"RTN","RGJCREC",60,0)
 N I S I=0 F  S I=$O(RGLL("LINKS",I)) Q:I<1  D
"RTN","RGJCREC",61,0)
 .S RGFROM=RGLL ;New Subscriber
"RTN","RGJCREC",62,0)
 .I $E(RGFROM,1,2)'="VA" D START^RGHLLOG(HLMTIEN,"SCN_REQ","") D EXC^RGHLLOG(224,"MSG#"_$G(HL("MID"))_" Unable to send Subscription Request from "_RGFROM_".  This is not a CIRN site.",RGDFN) D CLEAN Q
"RTN","RGJCREC",63,0)
 .S RGTO=$P(RGLL("LINKS",I),U,2) ;Destination (Clinical Subscriber)
"RTN","RGJCREC",64,0)
 .I $E(RGTO,1,2)'="VA" D START^RGHLLOG(HLMTIEN,"SCN_REQ","") D EXC^RGHLLOG(224,"MSG#"_$G(HL("MID"))_" Unable to send Subscription Request to "_RGTO_".  This is not a CIRN site.",RGDFN) D CLEAN Q
"RTN","RGJCREC",65,0)
 .S RGSTUB=RGFROM_U_RGTO_U_RGICN_U_RGPN_U_RGTP_U_RGAD_U_$G(RGTD)
"RTN","RGJCREC",66,0)
 .D:RGFROM'=RGTO EN^RGEQ("SCN_REQ",RGSTUB) ;put on Event Queue
"RTN","RGJCREC",67,0)
 Q
"RTN","RGJCREC",68,0)
REC2 ;Update newest subscriber with previous subscribers and CMOR
"RTN","RGJCREC",69,0)
 ;change 4/10/98 CMC to get links
"RTN","RGJCREC",70,0)
 K RGLL("LINKS")
"RTN","RGJCREC",71,0)
 D GET^RGRSDYN1(RGDFN,RGSCN,0,"",.RGLL)
"RTN","RGJCREC",72,0)
 S I=0 F  S I=$O(RGLL("LINKS",I)) Q:I<1  D
"RTN","RGJCREC",73,0)
 .S RGTO=RGLL
"RTN","RGJCREC",74,0)
 .I $E(RGTO,1,2)'="VA" D START^RGHLLOG(HLMTIEN,"SCN_REQ","") D EXC^RGHLLOG(224,"MSG#"_$G(HL("MID"))_" Unable to send Subscription Request to "_RGTO_".  This is not a CIRN site.",RGDFN) D CLEAN Q
"RTN","RGJCREC",75,0)
 .S RGFROM=$P(RGLL("LINKS",I),U,2)
"RTN","RGJCREC",76,0)
 .I $E(RGFROM,1,2)'="VA" D START^RGHLLOG(HLMTIEN,"SCN_REQ","") D EXC^RGHLLOG(224,"MSG#"_$G(HL("MID"))_" Unable to send Subscription Request from "_RGFROM_".  This is not a CIRN site.",RGDFN) D CLEAN Q
"RTN","RGJCREC",77,0)
 .S RGSTUB=RGFROM_U_RGTO_U_RGICN_U_RGPN_U_RGTP_U_RGAD_U_$G(RGTD)
"RTN","RGJCREC",78,0)
 .I RGTO'=RGFROM D EN^RGEQ("SCN_REQ",RGSTUB)
"RTN","RGJCREC",79,0)
 ;Now send current institution (CMOR)
"RTN","RGJCREC",80,0)
 K RGL
"RTN","RGJCREC",81,0)
 D LINK^HLUTIL3(RGCURI,.RGL) S RGL=$O(RGL(0)) Q:RGL<1
"RTN","RGJCREC",82,0)
 ;changed cmc 5/9/98
"RTN","RGJCREC",83,0)
 S RGSTUB=RGL(RGL)_U_RGLL_U_RGICN_U_RGPN_U_RGTP_U_RGAD_U_$G(RGTD)
"RTN","RGJCREC",84,0)
 D:RGL(RGL)'=RGLL EN^RGEQ("SCN_REQ",RGSTUB)
"RTN","RGJCREC",85,0)
 K RGSTUB
"RTN","RGJCREC",86,0)
 Q
"RTN","RGJCREC",87,0)
PARS ;Parse it
"RTN","RGJCREC",88,0)
 I $E(RGSEG,1,3)="MFI" D
"RTN","RGJCREC",89,0)
 .S RGFILE=+$P(RGSEG,RGFS,2) ;File number
"RTN","RGJCREC",90,0)
 I $E(RGSEG,1,3)="MFE" D
"RTN","RGJCREC",91,0)
 .S RGACT=$P(RGSEG,RGFS,2) ;Action
"RTN","RGJCREC",92,0)
 .S RGCD=$P(RGSEG,RGFS,4) ;creation date
"RTN","RGJCREC",93,0)
 .S RGID=$P(RGSEG,RGFS,5) D  ;Primary Key
"RTN","RGJCREC",94,0)
 ..S RGICN=+RGID,RGSSN=$P(RGID,RGSS,2),RGPN=$P(RGID,RGCS,2) ;ICN,Patient Name
"RTN","RGJCREC",95,0)
 I $E(RGSEG,1,3)="ZSD" D
"RTN","RGJCREC",96,0)
 .S RGLL=$P(RGSEG,RGFS,2) ;LLink
"RTN","RGJCREC",97,0)
 .S RGTP=$P(RGSEG,RGFS,3) ;Type
"RTN","RGJCREC",98,0)
 .S RGAD=$P(RGSEG,RGFS,4) ;Activation Date
"RTN","RGJCREC",99,0)
 .S RGTD=$P(RGSEG,RGFS,5) ;Termination Date
"RTN","RGJCREC",100,0)
 .S RGRAP=$P(RGSEG,RGFS,6) ;Receiving Application
"RTN","RGJCREC",101,0)
 .S RGCMOR=$P(RGSEG,RGFS,7) ;CIRN Master of Record
"RTN","RGJCREC",102,0)
 Q
"RTN","RGJCREC",103,0)
GETSCN(RGDPT) ;Return existing SCN or Activate a new subscription for this patient
"RTN","RGJCREC",104,0)
 ;RGDPT=PATIENT DFN
"RTN","RGJCREC",105,0)
 N RGAR,RGAN
"RTN","RGJCREC",106,0)
 ;get subscription control #
"RTN","RGJCREC",107,0)
 S RGSCN=+$P($$MPINODE^MPIFAPI(RGDPT),"^",5)
"RTN","RGJCREC",108,0)
 ;if no SCN, create new and update 991.05, then return result
"RTN","RGJCREC",109,0)
 I 'RGSCN S RGSCN=$$ACT^HLSUB S RGAR(991.05)=RGSCN S RGAN=$$UPDATE^MPIFAPI(RGDPT,"RGAR") I RGAN=-1 S RGSCN=""
"RTN","RGJCREC",110,0)
 Q RGSCN
"RTN","RGJCREC",111,0)
FIL ;File message
"RTN","RGJCREC",112,0)
 ;Normalize dates
"RTN","RGJCREC",113,0)
 N RGCHK,RGTD1
"RTN","RGJCREC",114,0)
 S RGAD1=$$DTHF^RGHLUT(RGAD)
"RTN","RGJCREC",115,0)
 I $G(RGTD)]"" S RGTD1=$$DTHF^RGHLUT(RGTD)
"RTN","RGJCREC",116,0)
 ;check to see if this subscriber is yourself
"RTN","RGJCREC",117,0)
 D LINK^HLUTIL3(+$$SITE^VASITE,.RGCHK) Q:$O(RGCHK(0))=""  S RGCHK=RGCHK($O(RGCHK(0)))
"RTN","RGJCREC",118,0)
 I $G(RGCHK)'=RGLL D UPD^HLSUB(RGSCN,RGLL,RGTP,RGAD1,$G(RGTD1),$G(RGRAP),.HLER)
"RTN","RGJCREC",119,0)
 Q
"RTN","RGJCREC",120,0)
GETINST(LINK) ;returns institution ien from logical link
"RTN","RGJCREC",121,0)
 I $G(LINK)="" Q 0
"RTN","RGJCREC",122,0)
 S DIC=870,DIC(0)="EMQZ",X=LINK D ^DIC
"RTN","RGJCREC",123,0)
 I Y=-1 Q Y
"RTN","RGJCREC",124,0)
 Q $P(Y(0),"^",2)
"RTN","RGRSDYN")
0^4^B5259834
"RTN","RGRSDYN",1,0)
RGRSDYN ;ALB/RJS-BUILD DYNAMIC LINK LIST FOR A PATIENT ;03/21/97
"RTN","RGRSDYN",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4,8**;30 Apr 99
"RTN","RGRSDYN",3,0)
EN(CLIENT,CLASS) ;
"RTN","RGRSDYN",4,0)
 ;CLIENT=HL7 CLIENT PROTOCOL AT TARGET SYSTEM
"RTN","RGRSDYN",5,0)
 ;DATA CLASS (Opt.) = Pull from Subs. Registry ONLY
"RTN","RGRSDYN",6,0)
 ;For now, anything else is both DESCRIPTIVE AND CLINICAL
"RTN","RGRSDYN",7,0)
 S CLASS=$G(CLASS),CLIENT=$G(CLIENT)
"RTN","RGRSDYN",8,0)
 Q:CLIENT=""  ;No receiver
"RTN","RGRSDYN",9,0)
 N PPF,DFN,HERE,RGRS,PPFIEN
"RTN","RGRSDYN",10,0)
PARS ;Parse local outbound message
"RTN","RGRSDYN",11,0)
 N RGDC
"RTN","RGRSDYN",12,0)
 D INITIZE^RGRSUTIL,EN^RGRSPARS("RGRS")
"RTN","RGRSDYN",13,0)
 ;Get patients owner site
"RTN","RGRSDYN",14,0)
 S PPF=$G(RGRS("SITENUM"))\1 Q:PPF'>0
"RTN","RGRSDYN",15,0)
 S PPFIEN=$$LKUP^XUAF4(PPF)
"RTN","RGRSDYN",16,0)
 ;Get DFN
"RTN","RGRSDYN",17,0)
 S DFN=$G(RGRS("DFN")) Q:$G(DFN)']""
"RTN","RGRSDYN",18,0)
 Q:+$$SEND2^VAFCUTL1(DFN,"T")  ;quit if test patient
"RTN","RGRSDYN",19,0)
 Q:$$IFLOCAL^MPIF001(DFN)
"RTN","RGRSDYN",20,0)
 ;Where we're at
"RTN","RGRSDYN",21,0)
 S HERE=$P($$SITE^VASITE,"^",3)\1
"RTN","RGRSDYN",22,0)
NOTPPF ; if not ppf send only to ppf
"RTN","RGRSDYN",23,0)
 I PPF'=HERE D  Q
"RTN","RGRSDYN",24,0)
 . N PPFLINK,INDEX
"RTN","RGRSDYN",25,0)
 . D LINK^HLUTIL3(PPFIEN,.PPFLINK)
"RTN","RGRSDYN",26,0)
 . S INDEX=$O(PPFLINK(0))
"RTN","RGRSDYN",27,0)
 . I INDEX]"" S HLL("LINKS",1)=CLIENT_"^"_PPFLINK(INDEX)
"RTN","RGRSDYN",28,0)
ISPPF ;
"RTN","RGRSDYN",29,0)
 I PPF=HERE D  Q
"RTN","RGRSDYN",30,0)
 . N PARENT,INDEX,SUBCONTL,CHILDREN,INDEX1,NODE
"RTN","RGRSDYN",31,0)
 . S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","RGRSDYN",32,0)
 . S SUBCONTL=$P($G(NODE),"^",5)
"RTN","RGRSDYN",33,0)
 . ;Get subscribers, return updated HLL array
"RTN","RGRSDYN",34,0)
 . I SUBCONTL]"" D GET^HLSUB(SUBCONTL,+CLASS,CLIENT,.HLL)
"RTN","RGRSDYN",35,0)
 . ;LAST MINUTE CHANGE MARILYN REQUESTED
"RTN","RGRSDYN",36,0)
 . ;Get MPI link from SITE PARAMETER (when non A01/A03 event, ADT
"RTN","RGRSDYN",37,0)
 . ;message) part of the DG*5.3*261/RG*1.0*4 bundle gjc@2/4/99
"RTN","RGRSDYN",38,0)
 . I '$$ADT0103() D
"RTN","RGRSDYN",39,0)
 . . N MPI S MPI=$$MPILINK^MPIFAPI() D
"RTN","RGRSDYN",40,0)
 . . . I $P($G(MPI),U)'=-1 S HLL("LINKS",9999999999)=CLIENT_"^"_MPI
"RTN","RGRSDYN",41,0)
 . . . I $P($G(MPI),U)=-1 D
"RTN","RGRSDYN",42,0)
 . . . . N RGLOG,RGMTXT
"RTN","RGRSDYN",43,0)
 . . . . D START^RGHLLOG(HLMTIEN,"","")
"RTN","RGRSDYN",44,0)
 . . . . S RGMTXT=""
"RTN","RGRSDYN",45,0)
 . . . . D EXC^RGHLLOG(224,"No MPI link identified in CIRN SITE PARAMETER file (#991.8)"_RGMTXT)
"RTN","RGRSDYN",46,0)
 . . . . D STOP^RGHLLOG(0)
"RTN","RGRSDYN",47,0)
 ;
"RTN","RGRSDYN",48,0)
 ;the following was commented out because we're not updating all sites
"RTN","RGRSDYN",49,0)
 ;in the VISN anymore
"RTN","RGRSDYN",50,0)
 ;
"RTN","RGRSDYN",51,0)
 ;. ;Get owners PARENT
"RTN","RGRSDYN",52,0)
 ;. D PARENT^XUAF4("PARENT",PPF)
"RTN","RGRSDYN",53,0)
 ;. S INDEX=""
"RTN","RGRSDYN",54,0)
 ;. S INDEX=$O(PARENT("P",INDEX))
"RTN","RGRSDYN",55,0)
 ;. Q:INDEX']""
"RTN","RGRSDYN",56,0)
 ;. D LINK^HLUTIL3(INDEX,.CHILDREN)
"RTN","RGRSDYN",57,0)
 ;. S INDEX=$O(HLL("LINKS",9999999999999),-1)
"RTN","RGRSDYN",58,0)
 ;. Q:INDEX']""
"RTN","RGRSDYN",59,0)
 ;. S INDEX1=0
"RTN","RGRSDYN",60,0)
 ;. F  S INDEX1=$O(CHILDREN(INDEX1)) Q:INDEX1'>0  D
"RTN","RGRSDYN",61,0)
 ;. . S INDEX=INDEX+1
"RTN","RGRSDYN",62,0)
 ;. . S HLL("LINKS",INDEX)=CLIENT_"^"_CHILDREN(INDEX1)
"RTN","RGRSDYN",63,0)
 ;
"RTN","RGRSDYN",64,0)
ADT0103() ; check to see if this is an ADT message type with an
"RTN","RGRSDYN",65,0)
 ; event of A01 -or- A03.  If true, do not broadcast the message
"RTN","RGRSDYN",66,0)
 ; to the MPI.  Part of the DG*5.3*261/RG*1.0*4 bundle.  gjc@2/4/99
"RTN","RGRSDYN",67,0)
 S HL("MTN")=$G(HL("MTN")),HL("ETN")=$G(HL("ETN")) ; just in case
"RTN","RGRSDYN",68,0)
 Q $S(HL("MTN")="ADT"&(HL("ETN")="A01"!(HL("ETN")="A03")):1,1:0)
"RTN","RGRSDYN1")
0^5^B14998307
"RTN","RGRSDYN1",1,0)
RGRSDYN1 ;ALB/RJS-BUILD DYNAMIC LINK LIST FOR A TFU ;06/09/97
"RTN","RGRSDYN1",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**1,3,8**;30 Apr 99
"RTN","RGRSDYN1",3,0)
EN(CLIENT,CLASS) ;
"RTN","RGRSDYN1",4,0)
 ;CLIENT=HL7 CLIENT PROTOCOL AT TARGET SYSTEM
"RTN","RGRSDYN1",5,0)
 ;DATA CLASS (Opt.) = Pull from Subs. Registry ONLY
"RTN","RGRSDYN1",6,0)
 ;For now, anything else is both DESCRIPTIVE AND CLINICAL
"RTN","RGRSDYN1",7,0)
 S CLASS=$G(CLASS),CLIENT=$G(CLIENT)
"RTN","RGRSDYN1",8,0)
 Q:CLIENT=""  ;No receiver
"RTN","RGRSDYN1",9,0)
 N PPF,DFN,HERE,RGRS,PPFIEN,ICN,MPI
"RTN","RGRSDYN1",10,0)
PARS ;Parse local outbound message
"RTN","RGRSDYN1",11,0)
 N RGDC
"RTN","RGRSDYN1",12,0)
 D INITIZE^RGRSUTIL,EN^RGRSPAR1("RGRS")
"RTN","RGRSDYN1",13,0)
 ;Get DFN
"RTN","RGRSDYN1",14,0)
 S ICN=$G(RGRS("ICN")) Q:$G(ICN)']""
"RTN","RGRSDYN1",15,0)
 S DFN=$$GETDFN^MPIF001(ICN) Q:+DFN'>0
"RTN","RGRSDYN1",16,0)
 Q:+$$SEND2^VAFCUTL1(DFN,"T")  ;don't broadcast test patients
"RTN","RGRSDYN1",17,0)
 Q:$$IFLOCAL^MPIF001(DFN)
"RTN","RGRSDYN1",18,0)
 S PPF=$$GETVCCI^MPIF001(DFN)\1 Q:+PPF'>0
"RTN","RGRSDYN1",19,0)
 S PPFIEN=$$LKUP^XUAF4(PPF)
"RTN","RGRSDYN1",20,0)
 ;Where we're at            Changed to 3rd piece CMC 5/9/98
"RTN","RGRSDYN1",21,0)
 S HERE=$P($$SITE^VASITE,"^",3)\1
"RTN","RGRSDYN1",22,0)
NOTPPF ; if not ppf send only to ppf
"RTN","RGRSDYN1",23,0)
 I PPF'=HERE D  Q
"RTN","RGRSDYN1",24,0)
 . N PPFLINK,INDEX
"RTN","RGRSDYN1",25,0)
 . D LINK^HLUTIL3(PPFIEN,.PPFLINK)
"RTN","RGRSDYN1",26,0)
 . S INDEX=$O(PPFLINK(0))
"RTN","RGRSDYN1",27,0)
 . I INDEX]"" S HLL("LINKS",1)=CLIENT_"^"_PPFLINK(INDEX)
"RTN","RGRSDYN1",28,0)
ISPPF ;
"RTN","RGRSDYN1",29,0)
 I PPF=HERE D  Q
"RTN","RGRSDYN1",30,0)
 . N PARENT,INDEX,SUBCONTL,CHILDREN,INDEX1,NODE
"RTN","RGRSDYN1",31,0)
 . S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","RGRSDYN1",32,0)
 . S SUBCONTL=$P($G(NODE),"^",5)
"RTN","RGRSDYN1",33,0)
 . ;Get subscribers, return updated HLL array
"RTN","RGRSDYN1",34,0)
 . ;replaced with GET line tag: I SUBCONTL]"" D GET^HLSUB(SUBCONTL,+CLASS,CLIENT,.HLL)
"RTN","RGRSDYN1",35,0)
 . D GET(DFN,SUBCONTL,+CLASS,CLIENT,.HLL)
"RTN","RGRSDYN1",36,0)
 . ;Get MPI link from SITE PARAMETER
"RTN","RGRSDYN1",37,0)
 . S MPI=$$MPILINK^MPIFAPI() D
"RTN","RGRSDYN1",38,0)
 . . I $P($G(MPI),U)'=-1 S HLL("LINKS",9999999999)=CLIENT_"^"_MPI
"RTN","RGRSDYN1",39,0)
 . . I $P($G(MPI),U)=-1 D
"RTN","RGRSDYN1",40,0)
 . . . N RGLOG,RGMTXT
"RTN","RGRSDYN1",41,0)
 . . . S RGMTXT=""
"RTN","RGRSDYN1",42,0)
 . . . D START^RGHLLOG(HLMTIEN,"","") D EXC^RGHLLOG(224,"No MPI link identified in CIRN SITE PARAMETER file (#991.8)"_RGMTXT) D STOP^RGHLLOG(0)
"RTN","RGRSDYN1",43,0)
 ;
"RTN","RGRSDYN1",44,0)
GET(RGDFN,RGSCN,RGTP,RGCLP,RGLL) ;GET Subscribers
"RTN","RGRSDYN1",45,0)
 ;RGDFN - Patient IEN from FILE (#2)
"RTN","RGRSDYN1",46,0)
 ;RGSCN - Subcription Control Number
"RTN","RGRSDYN1",47,0)
 ;RGTP  - SUBSCRIBER TYPE (0,1,2)/Null=all
"RTN","RGRSDYN1",48,0)
 ;RGCLP - HL7 CLIENT PROTOCOL (required)
"RTN","RGRSDYN1",49,0)
 ;RGLL  - HLL("LINKS",x)=CLIENT PROTOCOL^LOGICAL LINK (passed by reference)
"RTN","RGRSDYN1",50,0)
 N RG,RGI,RGLLIEN,RGLLI,RGLLS,RGLLN,RGLLZ,RGTF,RGTFF,RGTFI,RGX,HLER
"RTN","RGRSDYN1",51,0)
 S U="^"
"RTN","RGRSDYN1",52,0)
 ;get subscribers
"RTN","RGRSDYN1",53,0)
 I RGSCN'="" D GET^HLSUB(RGSCN,RGTP,RGCLP,.RGLL)
"RTN","RGRSDYN1",54,0)
 ;check for a treating facility that is not a subscriber
"RTN","RGRSDYN1",55,0)
 S RGI=0 F  S RGI=$O(^DGCN(391.91,"B",RGDFN,RGI)) Q:'RGI  I $D(^DGCN(391.91,RGI,0)) S RGTF=$G(^DGCN(391.91,RGI,0)),RGTFI=$P(RGTF,U,2) D:RGTFI'=+$$SITE^VASITE
"RTN","RGRSDYN1",56,0)
 .;checking INSTITUTION of links to the TREATING FACILITY INSTITUTION
"RTN","RGRSDYN1",57,0)
 .;RGTFF=1 - Flag for adding Treating Facility to Subcription Control
"RTN","RGRSDYN1",58,0)
 .S RGTFF=1
"RTN","RGRSDYN1",59,0)
 .S RGX=0 F  S RGX=$O(RGLL("LINKS",RGX)) Q:'RGX!(RGTFF=0)  D
"RTN","RGRSDYN1",60,0)
 ..S RGLLIEN=$P(RGLL("LINKS",RGX),U,6)
"RTN","RGRSDYN1",61,0)
 ..I $G(RGLL)="" S RGLL("ERR",RGX)="No logical link defined for "_$P(RGLL("LINKS",RGX),U)_"." Q
"RTN","RGRSDYN1",62,0)
 ..S RGLLI=RGTFI,RGLLN=$P(RGLL("LINKS",RGX),U,2)
"RTN","RGRSDYN1",63,0)
 ..I '$L(RGLLI),'$D(RGLL("ERR",RGX)) S RGLL("ERR",RGX)="Link "_$P(RGLL("LINKS",RGX),U,2)_" does not contain a link to the INSTUTUTION (#4) file." Q
"RTN","RGRSDYN1",64,0)
 ..I $L(RGLLI) S:RGLLI'=RGTFI RGTFF=1 I RGLLI=RGTFI S RGTFF=0 Q
"RTN","RGRSDYN1",65,0)
 .;If TF not in Subscriber list, kill list, add to subscription control file then get new list 
"RTN","RGRSDYN1",66,0)
 .I RGTFF=1 D LINK^HLUTIL3("`"_RGTFI,.RG,"I") S RGLLI=$O(RG(0)) D
"RTN","RGRSDYN1",67,0)
 ..I +$G(RGLLI)>0 S RGLLN=$P(RG(RGLLI),U),RGLLI=RGTFI
"RTN","RGRSDYN1",68,0)
 ..I +$G(RGLLI)>0 S:RGSCN="" RGSCN=$$GETSCN^RGJCREC(RGDFN) D UPD^HLSUB(RGSCN,RGLLN,RGTP,$$NOW^XLFDT,,,.HLER) K RGLL("LINKS") D GET^HLSUB(RGSCN,RGTP,RGCLP,.RGLL)
"RTN","RGRSDYN1",69,0)
 ..I +$G(RGLLI)'>0 W !,"Unable to find Logical link for "_$$GET1^DIQ(4,+RGTFI_",",.01)
"RTN","RGRSDYN1",70,0)
 Q
"RTN","RGRSDYN2")
0^6^B3838572
"RTN","RGRSDYN2",1,0)
RGRSDYN2 ;ALB/RJS-BUILD DYNAMIC LINK LIST FOR SENSITIVITY ;3-21-97
"RTN","RGRSDYN2",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**8**;30 Apr 99
"RTN","RGRSDYN2",3,0)
EN(CLIENT,CLASS) ;
"RTN","RGRSDYN2",4,0)
 ;CLIENT=HL7 CLIENT PROTOCOL AT TARGET SYSTEM
"RTN","RGRSDYN2",5,0)
 ;DATA CLASS (Opt.) = Pull from Subs. Registry ONLY
"RTN","RGRSDYN2",6,0)
 ;For now, anything else is both DESCRIPTIVE AND CLINICAL
"RTN","RGRSDYN2",7,0)
 S CLASS=$G(CLASS),CLIENT=$G(CLIENT)
"RTN","RGRSDYN2",8,0)
 Q:CLIENT=""  ;No receiver
"RTN","RGRSDYN2",9,0)
 N PPF,DFN,HERE,RGRS,PPFIEN
"RTN","RGRSDYN2",10,0)
PARS ;Parse local outbound message
"RTN","RGRSDYN2",11,0)
 N RGDC
"RTN","RGRSDYN2",12,0)
 D INITIZE^RGRSUTIL,EN^RGRSPARS("RGRS")
"RTN","RGRSDYN2",13,0)
 ;Get patients owner site
"RTN","RGRSDYN2",14,0)
 S PPF=$G(RGRS("SITENUM"))\1 Q:PPF'>0
"RTN","RGRSDYN2",15,0)
 S PPFIEN=$$LKUP^XUAF4(PPF)
"RTN","RGRSDYN2",16,0)
 ;Get DFN
"RTN","RGRSDYN2",17,0)
 S DFN=$G(RGRS("DFN")) Q:$G(DFN)']""
"RTN","RGRSDYN2",18,0)
 Q:$$IFLOCAL^MPIF001(DFN)
"RTN","RGRSDYN2",19,0)
 ;Where we're at
"RTN","RGRSDYN2",20,0)
 S HERE=$P($$SITE^VASITE,"^",3)\1
"RTN","RGRSDYN2",21,0)
NOTPPF ; if not ppf send only to ppf
"RTN","RGRSDYN2",22,0)
 I PPF'=HERE D  Q
"RTN","RGRSDYN2",23,0)
 . N PPFLINK,INDEX
"RTN","RGRSDYN2",24,0)
 . D LINK^HLUTIL3(PPFIEN,.PPFLINK)
"RTN","RGRSDYN2",25,0)
 . S INDEX=$O(PPFLINK(0))
"RTN","RGRSDYN2",26,0)
 . I INDEX]"" S HLL("LINKS",1)=CLIENT_"^"_PPFLINK(INDEX)
"RTN","RGRSDYN2",27,0)
ISPPF ;
"RTN","RGRSDYN2",28,0)
 I PPF=HERE D  Q
"RTN","RGRSDYN2",29,0)
 . N PARENT,INDEX,SUBCONTL,CHILDREN,INDEX1,NODE
"RTN","RGRSDYN2",30,0)
 . S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","RGRSDYN2",31,0)
 . S SUBCONTL=$P($G(NODE),"^",5)
"RTN","RGRSDYN2",32,0)
 . ;Get subscribers, return updated HLL array
"RTN","RGRSDYN2",33,0)
 . I SUBCONTL]"" D GET^HLSUB(SUBCONTL,+CLASS,CLIENT,.HLL)
"RTN","RGRSDYN2",34,0)
 . ;LAST MINUTE CHANGE MARILYN REQUESTED, COMMENTED OUT HERE
"RTN","RGRSDYN2",35,0)
 . ;BECAUSE WE'RE NOT SURE THE MPI WANTS Z12'S
"RTN","RGRSDYN2",36,0)
 . ;S MPI=$$MPILINK^MPIFAPI() D
"RTN","RGRSDYN2",37,0)
 . ;. I $P($G(MPI),U)'=-1 S HLL("LINKS",9999999999)=CLIENT_"^"_MPI
"RTN","RGRSDYN2",38,0)
 . ;. I $P($G(MPI),U)=-1 D
"RTN","RGRSDYN2",39,0)
 . ;. . N RGLOG,RGMTXT
"RTN","RGRSDYN2",40,0)
 . ;. . D START^RGHLLOG(HLMTIEN,"","")
"RTN","RGRSDYN2",41,0)
 . ;. . S RGMTXT=""
"RTN","RGRSDYN2",42,0)
 . ;. . D EXC^RGHLLOG(224,"No MPI link identified in CIRN SITE PARAMETER file (#991.8)"_RGMTXT) D STOP^RGHLLOG(0)
"RTN","RGRSDYN2",43,0)
 ;
"RTN","RGRSDYN2",44,0)
 ;the following was commented out because we're not updating all sites
"RTN","RGRSDYN2",45,0)
 ;in the VISN anymore
"RTN","RGRSDYN2",46,0)
 ;
"RTN","RGRSDYN2",47,0)
 ;. ;Get owners PARENT
"RTN","RGRSDYN2",48,0)
 ;. D PARENT^XUAF4("PARENT",PPF)
"RTN","RGRSDYN2",49,0)
 ;. S INDEX=""
"RTN","RGRSDYN2",50,0)
 ;. S INDEX=$O(PARENT("P",INDEX))
"RTN","RGRSDYN2",51,0)
 ;. Q:INDEX']""
"RTN","RGRSDYN2",52,0)
 ;. D LINK^HLUTIL3(INDEX,.CHILDREN)
"RTN","RGRSDYN2",53,0)
 ;. S INDEX=$O(HLL("LINKS",9999999999999),-1)
"RTN","RGRSDYN2",54,0)
 ;. Q:INDEX']""
"RTN","RGRSDYN2",55,0)
 ;. S INDEX1=0
"RTN","RGRSDYN2",56,0)
 ;. F  S INDEX1=$O(CHILDREN(INDEX1)) Q:INDEX1'>0  D
"RTN","RGRSDYN2",57,0)
 ;. . S INDEX=INDEX+1
"RTN","RGRSDYN2",58,0)
 ;. . S HLL("LINKS",INDEX)=CLIENT_"^"_CHILDREN(INDEX1)
"RTN","RGRSMSH")
0^2^B1170626
"RTN","RGRSMSH",1,0)
RGRSMSH ;ALB/RJS-REGISTRATION MESSAGE PARSER FOR CIRN ;03/8/96
"RTN","RGRSMSH",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4,8**;30 Apr 99
"RTN","RGRSMSH",3,0)
EN() ;
"RTN","RGRSMSH",4,0)
 ;This function call returns information from the MSH and EVN segments
"RTN","RGRSMSH",5,0)
 ;
"RTN","RGRSMSH",6,0)
 ; Output:
"RTN","RGRSMSH",7,0)
 ;    date received^event date from EVN segment^sending facility
"RTN","RGRSMSH",8,0)
 ;    (station # -or- station#~domain)
"RTN","RGRSMSH",9,0)
 ;
"RTN","RGRSMSH",10,0)
 N RGRSMSH,RGC,RGRSEVN,RECDATE,EVDATE,%,INSTNUM
"RTN","RGRSMSH",11,0)
 S RGC=$E(HL("ECH"))
"RTN","RGRSMSH",12,0)
 S RGRSMSH=$$SEG1^RGRSUTIL("MSH",1,"MSH")
"RTN","RGRSMSH",13,0)
 S RGRSEVN=$$SEG1^RGRSUTIL("EVN",1,"EVN")
"RTN","RGRSMSH",14,0)
 ;;S INSTNUM=$P(RGRSMSH,HL("FS"),4)
"RTN","RGRSMSH",15,0)
 ;; ^ changed 11/20/98 by cmc - MSH segment read into 2 array entries
"RTN","RGRSMSH",16,0)
 ;; need to use new supported variable HL("SFN")
"RTN","RGRSMSH",17,0)
 D NOW^%DTC
"RTN","RGRSMSH",18,0)
 S (RECDATE)=$G(%)
"RTN","RGRSMSH",19,0)
 S EVDATE=$P(RGRSEVN,HL("FS"),3)
"RTN","RGRSMSH",20,0)
 S EVDATE=$$FMDATE^HLFNC(EVDATE)
"RTN","RGRSMSH",21,0)
 ;
"RTN","RGRSMSH",22,0)
 ; HL("SFN") expected in one of the following formats:
"RTN","RGRSMSH",23,0)
 ; station # -or- station #~domain
"RTN","RGRSMSH",24,0)
 ;
"RTN","RGRSMSH",25,0)
 Q $G(RECDATE)_"^"_$G(EVDATE)_"^"_$G(HL("SFN"))
"RTN","RGRSPT")
0^7^B14853714
"RTN","RGRSPT",1,0)
RGRSPT ;ALB/RJS,CML-HIGH LEVEL ROUTINE FOR PARSING AND FILING ;06/25/98
"RTN","RGRSPT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**1,3,7,8**;30 Apr 99
"RTN","RGRSPT",3,0)
 ;
"RTN","RGRSPT",4,0)
 ;Parse Incoming Message, and file.
"RTN","RGRSPT",5,0)
 ;
"RTN","RGRSPT",6,0)
 ;
"RTN","RGRSPT",7,0)
 Q:($G(HL("MTN"))'="ADT")
"RTN","RGRSPT",8,0)
 N RGRSDFN,VAFCA,RGRS,VAFCA08,RGRSARAY,BOGUS,RGDC,SENSTVTY,CMORDISP
"RTN","RGRSPT",9,0)
 N NAME,LASTNAME,SSN,ICN,CMOR,CMORIEN,OTHSITE,RGRSDATA,HERE,BULSUB,NODE
"RTN","RGRSPT",10,0)
 S RGRSARAY="RGRS(2)"
"RTN","RGRSPT",11,0)
 D INITIZE^RGRSUTIL ;copy HL7 message into local RGDC array
"RTN","RGRSPT",12,0)
 S VAFCA=$$EN^RGRSMSH() ;parse MSH for filer
"RTN","RGRSPT",13,0)
 D EN^RGRSPARS(RGRSARAY) ;parse HL7 message into local array RGRS
"RTN","RGRSPT",14,0)
 I $$SKIP^RGRSZZPT(1,RGRSARAY) D  G EXIT ;skip if certain data is not there
"RTN","RGRSPT",15,0)
 . D SKIPBULL^RGRSBULL(RGRSARAY)
"RTN","RGRSPT",16,0)
 S RGRSDFN=$$GETDFN^MPIF001(@RGRSARAY@(991.01)) ;Get DFN from ICN
"RTN","RGRSPT",17,0)
 Q:+$$SEND2^VAFCUTL1(RGRSDFN,"T")  ;safeguard to prevent the processing of test patients
"RTN","RGRSPT",18,0)
 S OTHSITE=@RGRSARAY@("SITENUM")\1
"RTN","RGRSPT",19,0)
 S HERE=$P($$SITE^VASITE,"^",3)\1
"RTN","RGRSPT",20,0)
 ;
"RTN","RGRSPT",21,0)
 ;If patient not known in site, send bulletin, go exit
"RTN","RGRSPT",22,0)
 ;
"RTN","RGRSPT",23,0)
 I +RGRSDFN=-1 D EXC^RGHLLOG(210,"Msg#"_$G(HL("MID"))_" Bad DFN#"_$G(RGRSDFN)_" for "_$G(@RGRSARAY@(.01))_" (ICN#"_$G(@RGRSARAY@(991.01))_")") D STOP^RGHLLOG(1) Q
"RTN","RGRSPT",24,0)
 ;
"RTN","RGRSPT",25,0)
 S NAME=$$GET1^DIQ(2,+RGRSDFN_",",.01)
"RTN","RGRSPT",26,0)
 S LASTNAME=$P(NAME,",",1)
"RTN","RGRSPT",27,0)
 S SSN=$$GET1^DIQ(2,+RGRSDFN_",",.09)
"RTN","RGRSPT",28,0)
 S NODE=$$MPINODE^MPIFAPI(RGRSDFN)
"RTN","RGRSPT",29,0)
 S ICN=$P(NODE,"^")
"RTN","RGRSPT",30,0)
 S CMORIEN=$P(NODE,"^",3)
"RTN","RGRSPT",31,0)
 S CMOR=$$NS^XUAF4(CMORIEN)
"RTN","RGRSPT",32,0)
 S CMORDISP=$P(CMOR,"^",1)
"RTN","RGRSPT",33,0)
 S CMOR=$P(CMOR,"^",2)
"RTN","RGRSPT",34,0)
 ;
"RTN","RGRSPT",35,0)
 S @RGRSARAY@("NAME")=@RGRSARAY@(.01)
"RTN","RGRSPT",36,0)
 S @RGRSARAY@("SSN")=@RGRSARAY@(.09)
"RTN","RGRSPT",37,0)
 S @RGRSARAY@("ICN")=@RGRSARAY@(991.01)
"RTN","RGRSPT",38,0)
 S @RGRSARAY@("CMOR")=$P($$NS^XUAF4($$LKUP^XUAF4(OTHSITE)),"^")
"RTN","RGRSPT",39,0)
 ;
"RTN","RGRSPT",40,0)
 ;If ICN or CMOR don't match, send bulletin and go exit
"RTN","RGRSPT",41,0)
 I '$$MATCH(RGRSDFN,RGRSARAY,,,ICN,CMOR,.BULSUB) D  G EXIT
"RTN","RGRSPT",42,0)
 . D MTCHBULL^RGRSBULL(RGRSDFN,RGRSARAY,NAME,SSN,ICN,CMORDISP,BULSUB)
"RTN","RGRSPT",43,0)
 ;
"RTN","RGRSPT",44,0)
 ;if ICN and CMOR match, check for SSN edit from CMOR
"RTN","RGRSPT",45,0)
 I @RGRSARAY@("SENDING SITE")=CMOR,(SSN'=@RGRSARAY@(.09)) D
"RTN","RGRSPT",46,0)
 .D SSNBULL^RGRSBUL1(RGRSDFN,RGRSARAY,NAME,SSN,ICN,CMORDISP)
"RTN","RGRSPT",47,0)
 ;
"RTN","RGRSPT",48,0)
 ;If patient is Sensitive at other site but not here send bulletin
"RTN","RGRSPT",49,0)
 S SENSTVTY=$G(@RGRSARAY@("SENSITIVITY"))
"RTN","RGRSPT",50,0)
 I '$$SENSTIVE^RGRSENS(RGRSDFN),SENSTVTY D SENSTIVE^RGRSBUL1(RGRSDFN,RGRSARAY,NAME)
"RTN","RGRSPT",51,0)
 ;
"RTN","RGRSPT",52,0)
 ;If patient has DATE OF DEATH (DOD) at remote site send bulletin
"RTN","RGRSPT",53,0)
 ;Ignore time if present with date.
"RTN","RGRSPT",54,0)
 S RMTDOD=@RGRSARAY@(.351),RMTDOD=$P(RMTDOD,".")
"RTN","RGRSPT",55,0)
 S DFN=RGRSDFN D DEM^VADPT
"RTN","RGRSPT",56,0)
 S LOCDOD=$P($P(VADM(6),"^"),".")
"RTN","RGRSPT",57,0)
 ;If there is a remote DOD but no local DOD  OR
"RTN","RGRSPT",58,0)
 ;if remote DOD is different from local DOD, send bulletin
"RTN","RGRSPT",59,0)
 I RMTDOD D RMTDOD^RGRSBUL1(RGRSDFN,RGRSARAY,NAME,RMTDOD,LOCDOD)
"RTN","RGRSPT",60,0)
 K LOCDOD,RMTDOD,VADM
"RTN","RGRSPT",61,0)
 ;
"RTN","RGRSPT",62,0)
 D  G EXIT ;**7
"RTN","RGRSPT",63,0)
 . ;
"RTN","RGRSPT",64,0)
 . ;IF it's the CMOR - review file
"RTN","RGRSPT",65,0)
 . ;
"RTN","RGRSPT",66,0)
 . I (OTHSITE)=(HERE) D  Q
"RTN","RGRSPT",67,0)
 . . S VAFCA=VAFCA_"^"_RGRSDFN
"RTN","RGRSPT",68,0)
 . . S VAFCA08=1 S BOGUS=$$ADD^VAFCEHU1(VAFCA,"RGRS")
"RTN","RGRSPT",69,0)
 . ;
"RTN","RGRSPT",70,0)
 . ;IF it's not the CMOR - Don't Rebroadcast
"RTN","RGRSPT",71,0)
 . ;
"RTN","RGRSPT",72,0)
 . I (OTHSITE)'=(HERE) D  Q
"RTN","RGRSPT",73,0)
 . . S VAFCA08=1
"RTN","RGRSPT",74,0)
 . . D EDIT^VAFCPTED(RGRSDFN,RGRSARAY,".01;.03;.09;.02;.2403") ;**7 broadcasted fields - removed .05,.08,.111;.112;.113;.114;.115;.1112;.117;.131;.132;.211;.219;.31115
"RTN","RGRSPT",75,0)
EXIT ;
"RTN","RGRSPT",76,0)
 Q
"RTN","RGRSPT",77,0)
 ;
"RTN","RGRSPT",78,0)
MATCH(DFN,RGRSARAY,LASTNAME,SSN,ICN,CMOR,BULSUB) ;
"RTN","RGRSPT",79,0)
 Q:$G(DFN)=""!($G(RGRSARAY)="") 0
"RTN","RGRSPT",80,0)
 N COUNT,TRUE S (COUNT,TRUE)=0
"RTN","RGRSPT",81,0)
 S BULSUB=""
"RTN","RGRSPT",82,0)
 I $D(LASTNAME) D
"RTN","RGRSPT",83,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",84,0)
 . I (LASTNAME'=""),(LASTNAME=$P(@RGRSARAY@(.01),",",1)) S TRUE=TRUE+1
"RTN","RGRSPT",85,0)
 I $D(SSN) D
"RTN","RGRSPT",86,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",87,0)
 . I (SSN'=""),(SSN=$G(@RGRSARAY@(.09))) S TRUE=TRUE+1
"RTN","RGRSPT",88,0)
 I $D(ICN) D
"RTN","RGRSPT",89,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",90,0)
 . I (ICN'=""),(ICN=$G(@RGRSARAY@(991.01))) S TRUE=TRUE+1 Q
"RTN","RGRSPT",91,0)
 . S BULSUB=BULSUB_"ICN"
"RTN","RGRSPT",92,0)
 I $D(CMOR) D
"RTN","RGRSPT",93,0)
 . S COUNT=COUNT+1
"RTN","RGRSPT",94,0)
 . I (CMOR'=""),(CMOR=$G(@RGRSARAY@("SITENUM"))) S TRUE=TRUE+1 Q
"RTN","RGRSPT",95,0)
 . I BULSUB]"" S BULSUB=BULSUB_" & "
"RTN","RGRSPT",96,0)
 . S BULSUB=BULSUB_"CMOR"
"RTN","RGRSPT",97,0)
 I COUNT=TRUE Q 1
"RTN","RGRSPT",98,0)
 Q 0
"VER")
8.0^22.0
**END**
**END**
