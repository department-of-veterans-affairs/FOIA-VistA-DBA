Released PSJ*5*195 SEQ #173
Extracted from mail message
**KIDS**:PSJ*5.0*195^

**INSTALL NAME**
PSJ*5.0*195
"BLD",6379,0)
PSJ*5.0*195^INPATIENT MEDICATIONS^0^3070608^y
"BLD",6379,1,0)
^^13^13^3070530^
"BLD",6379,1,1,0)
This patch will provide a temporary fix as detailed in Patient safety 
"BLD",6379,1,2,0)
issue PSI-07-075 for BCMA.  
"BLD",6379,1,3,0)
 
"BLD",6379,1,4,0)
When using the CPRS Med Order Button (MOB), it was discovered that certain
"BLD",6379,1,5,0)
hardware configurations allow a "virtual" IP address.  This causes a
"BLD",6379,1,6,0)
single user to be logged into two physical nodes simultaneously.  When
"BLD",6379,1,7,0)
this happens, the order placed in CPRS MOB cannot be filed.  The user
"BLD",6379,1,8,0)
receives an error box which states "Missing data, unable to file."  The
"BLD",6379,1,9,0)
order does not show up on the VDL. It was determined that there is risk of
"BLD",6379,1,10,0)
duplication when the order does not file.
"BLD",6379,1,11,0)
 
"BLD",6379,1,12,0)
This patch will modify the error message to make it more noticeable and 
"BLD",6379,1,13,0)
robust.
"BLD",6379,4,0)
^9.64PA^^
"BLD",6379,6)
1^
"BLD",6379,6.3)
3
"BLD",6379,"KRN",0)
^9.67PA^8989.52^19
"BLD",6379,"KRN",.4,0)
.4
"BLD",6379,"KRN",.401,0)
.401
"BLD",6379,"KRN",.402,0)
.402
"BLD",6379,"KRN",.403,0)
.403
"BLD",6379,"KRN",.5,0)
.5
"BLD",6379,"KRN",.84,0)
.84
"BLD",6379,"KRN",3.6,0)
3.6
"BLD",6379,"KRN",3.8,0)
3.8
"BLD",6379,"KRN",9.2,0)
9.2
"BLD",6379,"KRN",9.8,0)
9.8
"BLD",6379,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",6379,"KRN",9.8,"NM",1,0)
PSJHL10^^0^B74404096
"BLD",6379,"KRN",9.8,"NM","B","PSJHL10",1)

"BLD",6379,"KRN",19,0)
19
"BLD",6379,"KRN",19.1,0)
19.1
"BLD",6379,"KRN",101,0)
101
"BLD",6379,"KRN",409.61,0)
409.61
"BLD",6379,"KRN",771,0)
771
"BLD",6379,"KRN",870,0)
870
"BLD",6379,"KRN",8989.51,0)
8989.51
"BLD",6379,"KRN",8989.52,0)
8989.52
"BLD",6379,"KRN",8994,0)
8994
"BLD",6379,"KRN","B",.4,.4)

"BLD",6379,"KRN","B",.401,.401)

"BLD",6379,"KRN","B",.402,.402)

"BLD",6379,"KRN","B",.403,.403)

"BLD",6379,"KRN","B",.5,.5)

"BLD",6379,"KRN","B",.84,.84)

"BLD",6379,"KRN","B",3.6,3.6)

"BLD",6379,"KRN","B",3.8,3.8)

"BLD",6379,"KRN","B",9.2,9.2)

"BLD",6379,"KRN","B",9.8,9.8)

"BLD",6379,"KRN","B",19,19)

"BLD",6379,"KRN","B",19.1,19.1)

"BLD",6379,"KRN","B",101,101)

"BLD",6379,"KRN","B",409.61,409.61)

"BLD",6379,"KRN","B",771,771)

"BLD",6379,"KRN","B",870,870)

"BLD",6379,"KRN","B",8989.51,8989.51)

"BLD",6379,"KRN","B",8989.52,8989.52)

"BLD",6379,"KRN","B",8994,8994)

"BLD",6379,"QUES",0)
^9.62^^
"BLD",6379,"REQB",0)
^9.611^1^1
"BLD",6379,"REQB",1,0)
PSJ*5.0*110^2
"BLD",6379,"REQB","B","PSJ*5.0*110",1)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
195^3070608^10000000076
"PKG",197,22,1,"PAH",1,1,0)
^^13^13^3070608
"PKG",197,22,1,"PAH",1,1,1,0)
This patch will provide a temporary fix as detailed in Patient safety 
"PKG",197,22,1,"PAH",1,1,2,0)
issue PSI-07-075 for BCMA.  
"PKG",197,22,1,"PAH",1,1,3,0)
 
"PKG",197,22,1,"PAH",1,1,4,0)
When using the CPRS Med Order Button (MOB), it was discovered that certain
"PKG",197,22,1,"PAH",1,1,5,0)
hardware configurations allow a "virtual" IP address.  This causes a
"PKG",197,22,1,"PAH",1,1,6,0)
single user to be logged into two physical nodes simultaneously.  When
"PKG",197,22,1,"PAH",1,1,7,0)
this happens, the order placed in CPRS MOB cannot be filed.  The user
"PKG",197,22,1,"PAH",1,1,8,0)
receives an error box which states "Missing data, unable to file."  The
"PKG",197,22,1,"PAH",1,1,9,0)
order does not show up on the VDL. It was determined that there is risk of
"PKG",197,22,1,"PAH",1,1,10,0)
duplication when the order does not file.
"PKG",197,22,1,"PAH",1,1,11,0)
 
"PKG",197,22,1,"PAH",1,1,12,0)
This patch will modify the error message to make it more noticeable and 
"PKG",197,22,1,"PAH",1,1,13,0)
robust.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","PSJHL10")
0^1^B74404096^B74133422
"RTN","PSJHL10",1,0)
PSJHL10  ;BIR/LDT,BSJ-VALIDATE INCOMING HL7 DATA/CREATE NEW ORDER ;30 MAY 07
"RTN","PSJHL10",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**58,78,91,109,110,195**;16 DEC 97;Build 3
"RTN","PSJHL10",3,0)
 ;
"RTN","PSJHL10",4,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSJHL10",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA# 2178.
"RTN","PSJHL10",6,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL10",7,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSJHL10",8,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSJHL10",9,0)
 ; Reference to ^PSBAPIPM is supported by DBIA# 3564.
"RTN","PSJHL10",10,0)
 ; Reference to ^ORERR is supported by DBIA# 2187.
"RTN","PSJHL10",11,0)
 ;
"RTN","PSJHL10",12,0)
VALID ;
"RTN","PSJHL10",13,0)
 ;Call BCMA for rest of data
"RTN","PSJHL10",14,0)
 D MOB^PSBAPIPM(PSJHLDFN,+PSJORDER)
"RTN","PSJHL10",15,0)
 N DATA0,CHK S DATA0=$G(^TMP("PSB",$J,0)) I DATA0=-1 S PSREASON="""YOUR ORDER WAS NOT SAVED. EXIT BCMA, SIGN BACK IN, THEN TRY AGAIN.""" D ERROR Q
"RTN","PSJHL10",16,0)
 I $P(DATA0,"^")'=PSJHLDFN S PSREASON="Patient does not match" D ERROR Q
"RTN","PSJHL10",17,0)
 I $P(DATA0,"^",2)'=+PSJORDER S PSREASON="Order number does not match" D ERROR Q
"RTN","PSJHL10",18,0)
 N VAIP S DFN=PSJHLDFN,VAIP("D")=$G(LOGIN) D IN5^VADPT
"RTN","PSJHL10",19,0)
 ;If UD do UD set/validate.
"RTN","PSJHL10",20,0)
 I $P(DATA0,"^",3)="" D UDSET
"RTN","PSJHL10",21,0)
 ;If IV do IV set/validate.
"RTN","PSJHL10",22,0)
 I $P(DATA0,"^",3)]"" D IVSET
"RTN","PSJHL10",23,0)
 D:'CHK EN1^PSJHL2(PSJHLDFN,"OK",PSGORD),EN1^PSJHL2(PSJHLDFN,"SC",PSGORD),EN1^PSJHL2(PSJHLDFN,"ZV",PSGORD),MOBR^PSBAPIPM(PSJHLDFN,+PSJORDER,PSGORD)
"RTN","PSJHL10",24,0)
 Q
"RTN","PSJHL10",25,0)
 ;
"RTN","PSJHL10",26,0)
ERROR ;Sends error msg to CPRS, logs error in OE/RR Errors file
"RTN","PSJHL10",27,0)
 S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(PSREASON,.PSJMSG),MOBR^PSBAPIPM(PSJHLDFN,+PSJORDER)
"RTN","PSJHL10",28,0)
 D EN1^PSJHLERR(PSJHLDFN,"OC",PSJORDER,PSREASON) S QFLG=1 K ^TMP("PSJNVO",$J),^TMP("PSB",$J)
"RTN","PSJHL10",29,0)
 Q
"RTN","PSJHL10",30,0)
 ;
"RTN","PSJHL10",31,0)
UDSET ;Set up UD variables
"RTN","PSJHL10",32,0)
 N PSGPR,PSGMR,PSGSM,PSGHSM,PSGST,PSGP,PSGSCH,PSGPDRG,PSGDO,PSGNESD,PSGNEFD,PSGOEAV,PSJSYSU,PSGS0XT,PSGS0Y
"RTN","PSJHL10",33,0)
 S PSGPR=PROVIDER,PSGMR=ROUTE,PSGSM=0,PSGHSM="",PSGST="O",PSGP=PSJHLDFN,PSGSCH=SCHEDULE,PSGPDRG=PSITEM
"RTN","PSJHL10",34,0)
 S (PSGNESD,PSGNEFD)=+$P(DATA0,"^",5),PSGOEAV=1,PSJSYSU=1,PSGS0XT="O",PSGS0Y=""
"RTN","PSJHL10",35,0)
 I $G(DOSE)]"",$G(UNIT)]"" S PSGDO=DOSE_UNIT
"RTN","PSJHL10",36,0)
 I $G(PSGDO)']"",$G(INSTR)]"" S PSGDO=$$TRIM^XLFSTR(INSTR,"R"," ")
"RTN","PSJHL10",37,0)
 S CHK=""
"RTN","PSJHL10",38,0)
 S ND=U_PSGPR_U_PSGMR_"^U^"_PSGSM_U_PSGHSM_U_PSGST_"^^"_"E"_"^^^^^"_LOGIN_U_PSGP_U_LOGIN
"RTN","PSJHL10",39,0)
 D CHK("^^"_PSGMR_"^^^^"_PSGST,PSGPDRG_U_PSGDO,PSGSCH_U_PSGNESD_"^^"_PSGNEFD)
"RTN","PSJHL10",40,0)
 I CHK D ERROR Q
"RTN","PSJHL10",41,0)
 I PSGSCH'="STAT",PSGSCH'="NOW" S PSREASON="Invalid Schedule" S CHK=1 D ERROR Q
"RTN","PSJHL10",42,0)
 I ORDCON'="V",ORDCON'="P" S PSREASON="Invalid Nature of Order" S CHK=1 D ERROR Q
"RTN","PSJHL10",43,0)
 D:'$D(^PS(55,PSGP,0)) ENSET0^PSGNE3(PSGP) S $P(^PS(55,PSGP,5.1),U,2)=PSGPR,PSGOEPR=PSGPR
"RTN","PSJHL10",44,0)
 S ND0=ND D ENGNA^PSGOETO
"RTN","PSJHL10",45,0)
 I $D(^PS(51.2,+PSGMR,0)),$P(^(0),U,3)]"" S PSGMRN=$P(^(0),U,3)
"RTN","PSJHL10",46,0)
 S ND0=DA_ND0
"RTN","PSJHL10",47,0)
 S $P(ND0,"^",21)=PSJORDER
"RTN","PSJHL10",48,0)
 S ND2=PSGSCH_U_PSGNESD_"^^"_PSGNEFD_U_PSGS0Y_U_PSGS0XT_"^^^^"_+VAIP(5)
"RTN","PSJHL10",49,0)
 S $P(ND4,U,7)=DUZ I PSGOEAV,PSJSYSU D
"RTN","PSJHL10",50,0)
 .S $P(ND4,U,PSJSYSU,PSJSYSU+1)=DUZ_U_+$P(DATA0,"^",5),$P(ND4,U,+PSJSYSU=1+9)=1,$P(ND4,U,+PSJSYSU=3+9)=0
"RTN","PSJHL10",51,0)
 .S $P(ND4,U,9,10)=+$P(ND4,U,9)_U_+$P(ND4,U,10)
"RTN","PSJHL10",52,0)
 .I '$P(ND4,U,9) S ^PS(55,"APV",PSGP,DA)=""
"RTN","PSJHL10",53,0)
 .I '$P(ND4,U,10) S ^PS(55,"NPV",PSGP,DA)=""
"RTN","PSJHL10",54,0)
 .I $P(ND4,U,9) K ^PS(55,"APV",PSGP,DA)
"RTN","PSJHL10",55,0)
 .I $P(ND4,U,10) K ^PS(55,"NPV",PSGP,DA)
"RTN","PSJHL10",56,0)
 S F="^PS(55,"_PSGP_",5,"_DA_",",@(F_"0)")=ND0
"RTN","PSJHL10",57,0)
 ;naked reference on the four (4) lines below refer to the full ref to ^PS(55,PSGP,5,DA created by indirection using variable F
"RTN","PSJHL10",58,0)
 I $G(INSTR)]"" S @(F_".3)")=INSTR
"RTN","PSJHL10",59,0)
 S @(F_".2)")=PSGPDRG_U_PSGDO S $P(^(.2),U,3,6)=$G(ORDCON)_"^"_$E(PRIORITY,2)_"^"_$G(DOSE)_"^"_$G(UNIT)
"RTN","PSJHL10",60,0)
 S @(F_"2)")=ND2,^(4)=ND4
"RTN","PSJHL10",61,0)
 S (C,X)=0 F  S X=$O(^TMP("PSB",$J,700,X)) Q:'X  S D=$G(^(X,0)) I D S C=C+1,@(F_"1,"_C_",0)")=$P(D,U,1,2),@(F_"1,""B"","_+D_","_C_")")=""
"RTN","PSJHL10",62,0)
 S:C @(F_"1,0)")=U_"55.07P^"_C_U_C
"RTN","PSJHL10",63,0)
 I $D(PROCOM) D
"RTN","PSJHL10",64,0)
 .;naked refs on the three lines below refer to the full ref to ^PS(55,PSGP,5,DA created by indrection using variable F
"RTN","PSJHL10",65,0)
 .I '$D(@(F_"12,0)")) S ^(0)=U_55.0612_U_0_U_0
"RTN","PSJHL10",66,0)
 .S JJ=0 F  S JJ=$O(PROCOM(JJ)) Q:'JJ  S $P(@(F_"12,0)"),"^",3,4)=JJ_"^"_JJ,@(F_"12,"_JJ_",0)")=PROCOM(JJ)
"RTN","PSJHL10",67,0)
 S @(F_"6)")=$$ENPC^PSJHL11("U",180)
"RTN","PSJHL10",68,0)
 D CRA^PSGOETO
"RTN","PSJHL10",69,0)
 L -^PS(55,DFN,5,DA)
"RTN","PSJHL10",70,0)
 S PSGORD=DA_"U"
"RTN","PSJHL10",71,0)
OUT ;
"RTN","PSJHL10",72,0)
 Q
"RTN","PSJHL10",73,0)
 ;
"RTN","PSJHL10",74,0)
CHK(X,Y,Z)      ;Check for required fields
"RTN","PSJHL10",75,0)
 ; Input: X="^^"_MED ROUTE_"^^^^"_SCH TYPE
"RTN","PSJHL10",76,0)
 ;        Y=ORDERABLE ITEM_"^"_DOSAGE ORDERED
"RTN","PSJHL10",77,0)
 ;        Z=SCHEDULE_"^"_START DATE/TIME_"^^"_STOP DATE/TIME
"RTN","PSJHL10",78,0)
 D CHK^PSJHL7(X,Y,Z)
"RTN","PSJHL10",79,0)
 Q
"RTN","PSJHL10",80,0)
 ;
"RTN","PSJHL10",81,0)
DDOK(PSJF,OI) ;Check to be sure all dispense drugs that are active in the
"RTN","PSJHL10",82,0)
 ;order are valid.
"RTN","PSJHL10",83,0)
 ; Input: PSJF - File root of the order including all but the IEN of 
"RTN","PSJHL10",84,0)
 ;               the drug. (EX "^PS(53.45,X,2,")
"RTN","PSJHL10",85,0)
 ;        OI   - IEN of the order's orderable item
"RTN","PSJHL10",86,0)
 ; Output: 1 - all active DD's in the order are valid
"RTN","PSJHL10",87,0)
 ;         0 - no DD's active DD's or at least one active is invalid
"RTN","PSJHL10",88,0)
 N DDCNT,ND,PSJ,PSJ1 S (PSJ1,DDCNT)=0
"RTN","PSJHL10",89,0)
 I '$D(PSGDT) D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSJHL10",90,0)
 I '$O(@(PSJF_"0)")) Q 1
"RTN","PSJHL10",91,0)
 ; Naked reference below refers to ^PS(53.45, created using indirection in variable PSJF
"RTN","PSJHL10",92,0)
 F PSJ=0:0 S PSJ=$O(@(PSJF_PSJ_")")) Q:'PSJ  S ND=$G(@(PSJF_PSJ_",0)"))  D
"RTN","PSJHL10",93,0)
 .S DDCNT=DDCNT+1
"RTN","PSJHL10",94,0)
 .S PSJ1=$S('$D(^PSDRUG(+ND,0)):1,$P($G(^(2)),U,3)'["U":1,+$G(^(2))'=+OI:1,$G(^("I"))="":0,1:^("I")'>PSGDT)
"RTN","PSJHL10",95,0)
 Q $S('DDCNT:0,PSJ1=1:0,1:1)
"RTN","PSJHL10",96,0)
 ;
"RTN","PSJHL10",97,0)
IVSET ;
"RTN","PSJHL10",98,0)
 N P,DFN S DFN=PSJHLDFN,CHK=""
"RTN","PSJHL10",99,0)
 F X=1:1:23 S P(X)=""
"RTN","PSJHL10",100,0)
 S (P(2),P(3),P("NINITDT"))=+$P(DATA0,"^",5),P("LOG")=LOGIN,P(4)=$P(DATA0,"^",3),P(5)=$S(P(4)="S":$P(DATA0,"^",4),1:""),P(6)=PROVIDER,P(8)=$G(INFRT),P(9)=$G(SCHEDULE),P(17)="E",P(21)=PSJORDER,P(22)=LOC
"RTN","PSJHL10",101,0)
 S:P(4)="P" P(9)=$P(DATA0,"^",6)
"RTN","PSJHL10",102,0)
 I P(4)="S",P(5)=1 S P(9)=$P(DATA0,"^",6)
"RTN","PSJHL10",103,0)
 S P("MR")=$S(P(4)="P":$O(^PS(51.2,"B","IV PIGGYBACK",0)),1:$O(^PS(51.2,"B","INTRAVENOUS",0)))
"RTN","PSJHL10",104,0)
 S (P("CLRK"),P("NINIT"))=CLERK,P("PD")=PSITEM,(P("IVRM"),P("SYRS"),P("CLIN"),P("FRES"),P("OPI"))="",P("RES")=ROC,P("PRY")=$E(PRIORITY,2),P("REM")=""
"RTN","PSJHL10",105,0)
 I $$SCHREQ^PSJLIVFD(.P),P(15)'>0 N P15 S P15=$$INTERVAL^PSIVUTL(.P)
"RTN","PSJHL10",106,0)
 D CHKIV I CHK D ERROR Q
"RTN","PSJHL10",107,0)
 D SETN
"RTN","PSJHL10",108,0)
 D NEW55^PSIVORFB
"RTN","PSJHL10",109,0)
 N DA,DIK,ND,PSIVACT
"RTN","PSJHL10",110,0)
 S ND(0)=+ON55 F X=2:1:23 I $D(P(X)) S $P(ND(0),U,X)=P(X)
"RTN","PSJHL10",111,0)
 S ND(.3)=$G(P("INS"))
"RTN","PSJHL10",112,0)
 S $P(ND(0),U,17)="E",ND(1)=P("REM"),ND(3)=P("OPI"),ND(.2)=$P($G(P("PD")),U)_U_$G(P("DO"))_U_+P("MR")_U_$G(P("PRY"))_U_$G(ORDCON) F X=0,1,3,.2,.3 S ^PS(55,DFN,"IV",+ON55,X)=ND(X)
"RTN","PSJHL10",113,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,1,4)=P("LOG")_U_P("IVRM")_U_U_P("SYRS"),$P(^(2),U,8,10)=P("RES")_U_$G(P("FRES"))_U_$S($G(VAIN(4)):+VAIN(4),1:"")
"RTN","PSJHL10",114,0)
 S $P(^PS(55,DFN,"IV",+ON55,2),U,11)=+P("CLRK")
"RTN","PSJHL10",115,0)
 S:+$G(P("CLIN")) $P(^PS(55,DFN,"IV",+ON55,"DSS"),"^")=P("CLIN")
"RTN","PSJHL10",116,0)
 S:+$G(P("NINIT")) ^PS(55,DFN,"IV",+ON55,4)=P("NINIT")_U_P("NINITDT")_"^^^^^^^^"_"1"
"RTN","PSJHL10",117,0)
 S ^PS(55,"APIV",DFN,+ON55)=""
"RTN","PSJHL10",118,0)
 I $D(PROCOM) D
"RTN","PSJHL10",119,0)
 .I '$D(^PS(55,DFN,"IV",+ON55,5,0)) S ^(0)=U_55.1115_U_0_U_0
"RTN","PSJHL10",120,0)
 .S JJ=0 F  S JJ=$O(PROCOM(JJ)) Q:'JJ  S $P(^PS(55,DFN,"IV",+ON55,5,0),"^",3,4)=JJ_"^"_JJ,^PS(55,DFN,"IV",+ON55,5,JJ,0)=PROCOM(JJ)
"RTN","PSJHL10",121,0)
 S ^PS(55,DFN,"IV",+ON55,3)=$$ENPC^PSJHL11("V",60)
"RTN","PSJHL10",122,0)
 F DRGT="AD","SOL" D PUTD55
"RTN","PSJHL10",123,0)
 K DA,DIK S DA(1)=DFN,DA=+ON55,DIK="^PS(55,"_DA(1)_",""IV"",",PSIVACT=1 D IX^DIK
"RTN","PSJHL10",124,0)
 L -^PS(55,DFN,"IV",DA)
"RTN","PSJHL10",125,0)
 S PSGORD=ON55
"RTN","PSJHL10",126,0)
 Q
"RTN","PSJHL10",127,0)
 ;
"RTN","PSJHL10",128,0)
PUTD55 ; Move drug data from local array into 55
"RTN","PSJHL10",129,0)
 K ^PS(55,DFN,"IV",+ON55,DRGT) S ^PS(55,DFN,"IV",+ON55,DRGT,0)=$S(DRGT="AD":"^55.02PA",1:"^55.11IPA")
"RTN","PSJHL10",130,0)
 F X=0:0 S X=$O(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),X)) Q:'X  D
"RTN","PSJHL10",131,0)
 .S Y=^PS(55,DFN,"IV",+ON55,DRGT,0),$P(Y,U,3)=$P(Y,U,3)+1,DRG=$P(Y,U,3),$P(Y,U,4)=$P(Y,U,4)+1
"RTN","PSJHL10",132,0)
 .S ^PS(55,DFN,"IV",+ON55,DRGT,0)=Y,^PS(55,DFN,"IV",+ON55,DRGT,+DRG,0)=$P(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),X,0),"^")_"^"_$P(^TMP("PSJNVO",$J,DRGT,+DRG,0),"^",2)
"RTN","PSJHL10",133,0)
 Q
"RTN","PSJHL10",134,0)
 ;
"RTN","PSJHL10",135,0)
SETN ;Set up patient 0 node if needed.
"RTN","PSJHL10",136,0)
 I '$D(^PS(55,DFN,0)) K DO,DA,DD,DIC,PSIVFN S:$D(^(5.1)) PSIVFN=^(5.1) K:$D(PSIVFN) ^(5.1) S (DINUM,X)=DFN,DIC(0)="L",DIC="^PS(55," D FILE^DICN S:$D(PSIVFN) ^PS(55,DFN,5.1)=PSIVFN D  K DIC,PSIVFN,DO,DA,DD
"RTN","PSJHL10",137,0)
 .; Mark PSJ and PSO as converted
"RTN","PSJHL10",138,0)
 .S $P(^PS(55,DFN,5.1),"^",11)=2
"RTN","PSJHL10",139,0)
 Q
"RTN","PSJHL10",140,0)
 ;
"RTN","PSJHL10",141,0)
CHKIV ;Validate IV data
"RTN","PSJHL10",142,0)
 N OK S OK=0
"RTN","PSJHL10",143,0)
 I "APS"'[P(4) S CHK=1,PSREASON="Invalid IV Type" Q
"RTN","PSJHL10",144,0)
 I P(9)="",P(4)="P" S CHK=1,PSREASON="Piggyback IV Type requires a schedule" Q
"RTN","PSJHL10",145,0)
 I P(4)="S",P(5)=1,P(9)="" S CHK=1,PSREASON="Intermittent Syringe IV Type requires a schedule" Q
"RTN","PSJHL10",146,0)
 I P(9)'="STAT",(P(9)'="NOW"),P(9)'="" S CHK=1,PSREASON="Invalid Schedule" Q
"RTN","PSJHL10",147,0)
 I ORDCON'="V",ORDCON'="P" S CHK=1,PSREASON="Invalid Nature of Order" Q
"RTN","PSJHL10",148,0)
 I +$G(^TMP("PSB",$J,800,0))=0,+$G(^TMP("PSB",$J,900,0))=0 S CHK=1,PSREASON="IV orders must have at least one additive or solution" Q
"RTN","PSJHL10",149,0)
 I +$G(^TMP("PSB",$J,900,0))=0,P(4)'="P" S CHK=1,PSREASON="You must have at least one solution for this order." Q
"RTN","PSJHL10",150,0)
 I +$G(^TMP("PSB",$J,800,0))'=+$G(^TMP("PSJNVO",$J,"AD",0)) S CHK=1,PSREASON="Number of additives in BCMA & CPRS do not match." Q
"RTN","PSJHL10",151,0)
 I +$G(^TMP("PSB",$J,900,0))'=+$G(^TMP("PSJNVO",$J,"SOL",0)) S CHK=1,PSREASON="Number of solutions in BCMA & CPRS do not match." Q
"RTN","PSJHL10",152,0)
 F DRGT="AD","SOL" S FIL=$S(DRGT="AD":52.6,1:52.7) F DRGI=0:0 S DRGI=$O(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),DRGI)) Q:'DRGI  S DRG=$G(^TMP("PSB",$J,$S(DRGT="AD":800,1:900),DRGI,0)) D DRG,@DRGT Q:CHK=1
"RTN","PSJHL10",153,0)
 I 'OK,'CHK S CHK=1,PSREASON="The Orderable Item does not match any of the additives or solutions in this order" Q
"RTN","PSJHL10",154,0)
 Q
"RTN","PSJHL10",155,0)
 ;
"RTN","PSJHL10",156,0)
AD ;Check additives
"RTN","PSJHL10",157,0)
 I '$D(^PS(FIL,+DRG,0)) S CHK=1,PSREASON="Additive "_+DRG_" does not exist in the additive file" Q
"RTN","PSJHL10",158,0)
 ;Naked reference below refers to ^PS(52.6,+DRG,0)
"RTN","PSJHL10",159,0)
 I $P(^(0),"^",11)=PSITEM S OK=1
"RTN","PSJHL10",160,0)
 I $$ENU^PSIVUTL(+DRG)'=$P($P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)," ",2,99)!(+$P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)'>0) S CHK=1,PSREASON="Invalid strength entered for additive "_+DRG Q
"RTN","PSJHL10",161,0)
 Q
"RTN","PSJHL10",162,0)
SOL ;Check solutions
"RTN","PSJHL10",163,0)
 I '$D(^PS(FIL,+DRG,0)) S CHK=1,PSREASON="Solution "_+DRG_" does not exist in the solution file" Q
"RTN","PSJHL10",164,0)
 ;Naked reference below refers to ^PS(52.7,+DRG,0)
"RTN","PSJHL10",165,0)
 I $P(^(0),"^",11)=PSITEM S OK=1
"RTN","PSJHL10",166,0)
 I +$P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)>9999!(+$P(^TMP("PSJNVO",$J,DRGT,+DRGI,0),"^",2)'>0) S CHK=1,PSREASON="Volume on "_+DRG_" is an invalid strength" Q
"RTN","PSJHL10",167,0)
 Q
"RTN","PSJHL10",168,0)
DRG ;Check to be sure additive/solutions are active
"RTN","PSJHL10",169,0)
 I $S('$G(^PS(FIL,+DRG,"I")):0,^("I")>DT:0,1:1) S CHK=1,PSREASON="An additive or solution is inactive" Q
"RTN","PSJHL10",170,0)
 Q
"VER")
8.0^22.0
"BLD",6379,6)
^173
**END**
**END**
