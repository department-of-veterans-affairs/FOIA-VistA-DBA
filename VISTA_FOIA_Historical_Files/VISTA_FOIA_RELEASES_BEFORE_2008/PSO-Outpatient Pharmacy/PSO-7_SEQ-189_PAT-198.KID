Released PSO*7*198 SEQ #189
Extracted from mail message
**KIDS**:PSO*7.0*198^

**INSTALL NAME**
PSO*7.0*198
"BLD",1096,0)
PSO*7.0*198^OUTPATIENT PHARMACY^0^3050517^y
"BLD",1096,1,0)
^^3^3^3050418^
"BLD",1096,1,1,0)
Correct partially built NTE6 segment sent via OPAI, correct run-on words 
"BLD",1096,1,2,0)
in the PMI segment in HL7 messages sent via OPAI, and correct PSO 
"BLD",1096,1,3,0)
Management Reports from skipping Released RX's with date and no times.
"BLD",1096,4,0)
^9.64PA^^
"BLD",1096,"ABPKG")
n
"BLD",1096,"KRN",0)
^9.67PA^8989.52^19
"BLD",1096,"KRN",.4,0)
.4
"BLD",1096,"KRN",.401,0)
.401
"BLD",1096,"KRN",.402,0)
.402
"BLD",1096,"KRN",.403,0)
.403
"BLD",1096,"KRN",.5,0)
.5
"BLD",1096,"KRN",.84,0)
.84
"BLD",1096,"KRN",3.6,0)
3.6
"BLD",1096,"KRN",3.8,0)
3.8
"BLD",1096,"KRN",9.2,0)
9.2
"BLD",1096,"KRN",9.8,0)
9.8
"BLD",1096,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",1096,"KRN",9.8,"NM",1,0)
PSOHLDS2^^0^B75435444
"BLD",1096,"KRN",9.8,"NM",2,0)
PSOHLDS3^^0^B43031009
"BLD",1096,"KRN",9.8,"NM",3,0)
PSOCSTD^^0^B33388128
"BLD",1096,"KRN",9.8,"NM",4,0)
PSOMGCM1^^0^B39573969
"BLD",1096,"KRN",9.8,"NM","B","PSOCSTD",3)

"BLD",1096,"KRN",9.8,"NM","B","PSOHLDS2",1)

"BLD",1096,"KRN",9.8,"NM","B","PSOHLDS3",2)

"BLD",1096,"KRN",9.8,"NM","B","PSOMGCM1",4)

"BLD",1096,"KRN",19,0)
19
"BLD",1096,"KRN",19,"NM",0)
^9.68A^^
"BLD",1096,"KRN",19.1,0)
19.1
"BLD",1096,"KRN",101,0)
101
"BLD",1096,"KRN",409.61,0)
409.61
"BLD",1096,"KRN",771,0)
771
"BLD",1096,"KRN",870,0)
870
"BLD",1096,"KRN",8989.51,0)
8989.51
"BLD",1096,"KRN",8989.52,0)
8989.52
"BLD",1096,"KRN",8994,0)
8994
"BLD",1096,"KRN","B",.4,.4)

"BLD",1096,"KRN","B",.401,.401)

"BLD",1096,"KRN","B",.402,.402)

"BLD",1096,"KRN","B",.403,.403)

"BLD",1096,"KRN","B",.5,.5)

"BLD",1096,"KRN","B",.84,.84)

"BLD",1096,"KRN","B",3.6,3.6)

"BLD",1096,"KRN","B",3.8,3.8)

"BLD",1096,"KRN","B",9.2,9.2)

"BLD",1096,"KRN","B",9.8,9.8)

"BLD",1096,"KRN","B",19,19)

"BLD",1096,"KRN","B",19.1,19.1)

"BLD",1096,"KRN","B",101,101)

"BLD",1096,"KRN","B",409.61,409.61)

"BLD",1096,"KRN","B",771,771)

"BLD",1096,"KRN","B",870,870)

"BLD",1096,"KRN","B",8989.51,8989.51)

"BLD",1096,"KRN","B",8989.52,8989.52)

"BLD",1096,"KRN","B",8994,8994)

"BLD",1096,"QUES",0)
^9.62^^
"BLD",1096,"REQB",0)
^9.611^3^3
"BLD",1096,"REQB",1,0)
PSO*7.0*156^2
"BLD",1096,"REQB",2,0)
PSO*7.0*89^2
"BLD",1096,"REQB",3,0)
PSO*7.0*185^2
"BLD",1096,"REQB","B","PSO*7.0*156",1)

"BLD",1096,"REQB","B","PSO*7.0*185",3)

"BLD",1096,"REQB","B","PSO*7.0*89",2)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
7.0^3011218^2980805^5
"PKG",16,22,1,"PAH",1,0)
198^3050517
"PKG",16,22,1,"PAH",1,1,0)
^^3^3^3050517
"PKG",16,22,1,"PAH",1,1,1,0)
Correct partially built NTE6 segment sent via OPAI, correct run-on words 
"PKG",16,22,1,"PAH",1,1,2,0)
in the PMI segment in HL7 messages sent via OPAI, and correct PSO 
"PKG",16,22,1,"PAH",1,1,3,0)
Management Reports from skipping Released RX's with date and no times.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSOCSTD")
0^3^B33388128
"RTN","PSOCSTD",1,0)
PSOCSTD ;BHAM ISC/SAB - daily rx cost compilation ;4/15/05 10:50am
"RTN","PSOCSTD",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**4,17,28,89,198**;DEC 1997
"RTN","PSOCSTD",3,0)
 ;External Ref to ^DPT DBIA# 10035
"RTN","PSOCSTD",4,0)
 ;External Ref to ^PS(55 DBIA# 2228
"RTN","PSOCSTD",5,0)
 ;External Ref to ^PSDRUG DBIA# 221
"RTN","PSOCSTD",6,0)
 ;
"RTN","PSOCSTD",7,0)
 ;PSO*198 correct For loops to begin on the previous day @ time 999999
"RTN","PSOCSTD",8,0)
 ;
"RTN","PSOCSTD",9,0)
 K BEGDATE,ENDDATE S %DT(0)=$E(DT,1,5)_"00"
"RTN","PSOCSTD",10,0)
 W !!,"**** Date Range Selection ****" I '$O(^PS(59,0)) W $C(7),!,"PLEASE ENTER SITE PARAMETERS !!",!,$C(7) G EX
"RTN","PSOCSTD",11,0)
BEG W ! S %DT="APE",%DT("A")="   Beginning DATE : " D ^%DT G:"^"[X EX G:Y<0 BEG S (%DT(0),BEGDATE)=Y
"RTN","PSOCSTD",12,0)
EN W ! S %DT="APE",%DT("A")="   Ending    DATE : " D ^%DT K %DT G:"^"[X EX G:Y<0 EN W ! S ENDDATE=Y
"RTN","PSOCSTD",13,0)
 S ZTIO="",ZTRTN="START^PSOCSTD",ZTDESC="Rx Daily Cost Compile" F G="BEGDATE","ENDDATE" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOCSTD",14,0)
 D ^%ZTLOAD W:$D(ZTSK) !,"Task Queued !" K G,BEGDATE,ENDDATE,ZTSAVE,ZTIO,ZTSK,ZTRTN,ZTDESC Q
"RTN","PSOCSTD",15,0)
START K ^TMP($J) G:$E(DT,6,7)="01" MTH
"RTN","PSOCSTD",16,0)
 I '$D(BEGDATE)!('$D(ENDDATE)) S X1=DT,X2=-1 D C^%DTC S (BEGDATE,ENDDATE)=X
"RTN","PSOCSTD",17,0)
 K BDT S PSG=0 F I=1:1 S X=$T(G+I) Q:$P(X,";",3)=""  S PSOA(I)=$P(X,";",3),PSOB(I)=$P(X,";",4),PSG=PSG+1,PSOA1(I)=$P(X,";",5),PSOB1(I)=$P(X,";",6)
"RTN","PSOCSTD",18,0)
 S PSD=0 F I=1:1 S X=$T(D+I) Q:X=""  S PSOC(I)=$P(X,";",3),PSOD(I)=$P(X,";",4),PSD=PSD+1,PSOC1(I)=$P(X,";",5),PSOD1(I)=$P(X,";",6)
"RTN","PSOCSTD",19,0)
 F PSDT=BEGDATE:1:ENDDATE K ^PSCST(PSDT),^PSCST("B",PSDT)
"RTN","PSOCSTD",20,0)
 S (TNR,TNO,TNP)=0
"RTN","PSOCSTD",21,0)
 ;PSO*198 fix begin value of $O loops
"RTN","PSOCSTD",22,0)
SRCH S PSDT=BEGDATE-1+.999999 F  S PSDT=$O(^PSRX("AL",PSDT)) Q:'PSDT!($E(PSDT,1,7)>ENDDATE)  S (OR,RF)=0 D SRCH1 S:'$D(BDT) BDT=PSDT
"RTN","PSOCSTD",23,0)
 S PSDT=BEGDATE-1+.999999 F  S PSDT=$O(^PSRX("AM",PSDT)) Q:'PSDT!($E(PSDT,1,7)>ENDDATE)  D SRCH2 S:'$D(BDT) BDT=PSDT
"RTN","PSOCSTD",24,0)
 S PSOCNT=0 F PSDT=0:0 S PSDT=$O(^PSCST("B",PSDT)) Q:'PSDT  S PSD=PSDT,PSOCNT=PSOCNT+1
"RTN","PSOCSTD",25,0)
 S ^PSCST(0)="DRUG COST^50.9D^"_PSD_"^"_PSOCNT,EDT=ENDDATE
"RTN","PSOCSTD",26,0)
 F PSDT=BEGDATE:1:ENDDATE F II=2:1:7 S:$D(^PSCST(PSDT,0)) $P(^PSCST(PSDT,0),"^",II)=0
"RTN","PSOCSTD",27,0)
 S PSDT=BEGDATE-1 F  S PSDT=$O(^PSCST(PSDT)) Q:'PSDT!(PSDT>ENDDATE)  D
"RTN","PSOCSTD",28,0)
 .S DRG=0  F  S DRG=$O(^PSCST(PSDT,"D",DRG)) Q:'DRG  S DRC=^PSCST(PSDT,"D",DRG,0) D
"RTN","PSOCSTD",29,0)
 ..F II=2:1:7 S $P(^PSCST(PSDT,0),"^",II)=$P(^PSCST(PSDT,0),"^",II)+$P(DRC,"^",II)
"RTN","PSOCSTD",30,0)
 S PSDT=0 F  S PSDT=$O(^TMP($J,"PAT",PSDT)) Q:'PSDT  D SDFN
"RTN","PSOCSTD",31,0)
 D:$D(BDT) ZNODE^PSOCSTM
"RTN","PSOCSTD",32,0)
EX K ^TMP($J),FL,%DT,A,B,BEGDATE,COST,DATA,DATA1,DATA2,DRUG,DFN,ENDDATE,I,II,ML,OR,PAST,PHYS,PSOCNT,DIV,PSD,PSDT,PSFILL,PSG,QTY,RF,RX0
"RTN","PSOCSTD",33,0)
 K RXF,PAR,NDZ1,NDZ2,BDT,D,CLINIC,RX1,RX2,RXN,C,VALUE,VISITS,WD,X,X1,X2,Y,BDT,EDT,PSOA1,PSOB1,PSOC1,PSOD1,PSOC
"RTN","PSOCSTD",34,0)
 K TDFN,TDIV S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOCSTD",35,0)
SDFN S (TDFN,DIV)=0 F  S DIV=$O(^TMP($J,"PAT",PSDT,DIV)) Q:'DIV  D SDFN1
"RTN","PSOCSTD",36,0)
 S ^PSCST(PSDT,1)=DT_"^"_TDFN Q
"RTN","PSOCSTD",37,0)
SDFN1 S (DFN,TDIV)=0 F  S DFN=$O(^TMP($J,"PAT",PSDT,DIV,DFN)) Q:'DFN  S TDIV=TDIV+1,TDFN=TDFN+1
"RTN","PSOCSTD",38,0)
 S $P(^PSCST(PSDT,"V",DIV,0),"^",8)=TDIV Q
"RTN","PSOCSTD",39,0)
SRCH1 S RXF="" F RXN=0:0 S RXN=$O(^PSRX("AL",PSDT,RXN)) Q:'RXN  F  S RXF=$O(^PSRX("AL",PSDT,RXN,RXF)) Q:RXF=""  S PAR=0 D CHK S (OR,RF)=0
"RTN","PSOCSTD",40,0)
 Q
"RTN","PSOCSTD",41,0)
SRCH2 S (RXN,RXF)=0 F  S RXN=$O(^PSRX("AM",PSDT,RXN)) Q:'RXN  F  S RXF=$O(^PSRX("AM",PSDT,RXN,RXF)) Q:'RXF  S PAR=1 D CHK S (OR,RF)=0
"RTN","PSOCSTD",42,0)
 Q
"RTN","PSOCSTD",43,0)
CHK Q:'$D(^PSRX(RXN,0))  I '$D(^PSRX(RXN,2)) Q
"RTN","PSOCSTD",44,0)
 S RX0=^PSRX(RXN,0) S RX2=^PSRX(RXN,2)
"RTN","PSOCSTD",45,0)
 S DFN=+$P(RX0,"^",2) Q:'$D(^DPT(DFN,0))  D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN)
"RTN","PSOCSTD",46,0)
 S DRUG=+$P(RX0,"^",6) Q:'$D(^PSDRUG(DRUG,0))
"RTN","PSOCSTD",47,0)
 ;S CLASS=+$P(^(0),"^",2) Q:'$D(^PS(50.605,CLASS,0))
"RTN","PSOCSTD",48,0)
 S DIV=+$P(RX2,"^",9) Q:'$D(^PS(59,DIV,0))
"RTN","PSOCSTD",49,0)
 S PHYS=+$P(RX0,"^",4) Q:'$D(^VA(200,PHYS,0))  S PAST=+$P(RX0,"^",3) Q:'$D(^PS(53,PAST,0))
"RTN","PSOCSTD",50,0)
 S CLINIC=+$P(RX0,"^",5) K:'$D(^SC(CLINIC,0)) CLINIC
"RTN","PSOCSTD",51,0)
 S COST=$S(+$P(RX0,"^",17):+$P(RX0,"^",17),$D(^PSDRUG(DRUG,660)):+$P(^(660),"^",6),1:0)
"RTN","PSOCSTD",52,0)
 S QTY=+$P(RX0,"^",7),ML=$S($P(RX0,"^",11)="M":1,1:0),WD=$S($P(RX0,"^",11)="W":1,1:0)
"RTN","PSOCSTD",53,0)
 I $G(PAR) D  S PR=0 Q
"RTN","PSOCSTD",54,0)
 .I '$D(^PSRX(RXN,"P",RXF,0)) K ^PSRX("AM",PSDT,RXN,RXF) Q
"RTN","PSOCSTD",55,0)
 .I $P(^PSRX(RXN,"P",RXF,0),"^",19) S RF=0,RX1=^PSRX(RXN,"P",RXF,0),DIV=$S($P(RX1,"^",9):$P(RX1,"^",9),1:$P(RX2,"^",9)) D SET,REF S TNP=TNP+1
"RTN","PSOCSTD",56,0)
 I $P(RX2,"^",13),'RXF S OR=OR+1,COST=QTY*COST D SET,SF S TNO=TNO+1 Q
"RTN","PSOCSTD",57,0)
 D:RXF
"RTN","PSOCSTD",58,0)
 .I '$D(^PSRX(RXN,1,RXF,0)) K ^PSRX("AL",PSDT,RXN,RXF) Q
"RTN","PSOCSTD",59,0)
 .I $P(^PSRX(RXN,1,RXF,0),"^",18) S RF=0,RX1=^PSRX(RXN,1,RXF,0),DIV=$S($P(RX1,"^",9):$P(RX1,"^",9),1:$P(RX2,"^",9)) D SET,REF S TNR=TNR+1
"RTN","PSOCSTD",60,0)
 Q
"RTN","PSOCSTD",61,0)
SF S DATA="^"_OR_"^"_RF_"^"_COST_"^"_QTY_"^"_ML_"^"_WD
"RTN","PSOCSTD",62,0)
 S:'$D(^TMP($J,"PAT",$P(PSDT,"."),DIV,DFN)) ^TMP($J,"PAT",$P(PSDT,"."),DIV,DFN)=""
"RTN","PSOCSTD",63,0)
 F I=1:1:PSG Q:('$D(CLINIC))&(I=PSG)  S DATA1=$S(($D(@(PSOA(I)))#2):^(0),1:@(PSOB(I))_"^0^0^0^0") S DATA2=+$P(DATA1,"^") D
"RTN","PSOCSTD",64,0)
 .F II=2:1:7 S VALUE=$P(DATA,"^",II)+$P(DATA1,"^",II),DATA2=DATA2_"^"_VALUE S:II=7 @PSOA(I)=DATA2
"RTN","PSOCSTD",65,0)
 .S:'$D(@PSOA1(I)) @PSOA1(I)=PSOB1(I) S $P(@PSOA1(I),"^",4)=+$P(@PSOA1(I),"^",4)+1,$P(@PSOA1(I),"^",3)=@PSOB(I)
"RTN","PSOCSTD",66,0)
 F I=1:1:PSD S DATA1=$S(($D(@(PSOC(I)))#2):$G(^(0)),1:@(PSOD(I))_"^0^0^0^0") S DATA2=+$P(DATA1,"^") D
"RTN","PSOCSTD",67,0)
 .F II=2:1:7 S VALUE=$P(DATA,"^",II)+$P(DATA1,"^",II),DATA2=DATA2_"^"_VALUE S:II=7 @PSOC(I)=DATA2 D
"RTN","PSOCSTD",68,0)
 .S:'$D(@PSOC1(I)) @PSOC1(I)=PSOD1(I) S $P(@PSOC1(I),"^",4)=+$P(@PSOC1(I),"^",4)+1,$P(@PSOC1(I),"^",3)=@PSOD(I)
"RTN","PSOCSTD",69,0)
 Q
"RTN","PSOCSTD",70,0)
SET S ^PSCST($P(PSDT,"."),0)=$P(PSDT,"."),^PSCST("B",$P(PSDT,"."),$P(PSDT,"."))="" Q
"RTN","PSOCSTD",71,0)
 ;
"RTN","PSOCSTD",72,0)
MTH S X1=DT,X2=-1 D C^%DTC S (BDT,EDT)=$E(X,1,5)_"00"
"RTN","PSOCSTD",73,0)
 F PSDT=(BDT+1):1:X K ^PSCST(PSDT),^PSCST("B",PSDT)
"RTN","PSOCSTD",74,0)
 D START^PSOCSTM G EX
"RTN","PSOCSTD",75,0)
 Q
"RTN","PSOCSTD",76,0)
REF S OR=0,COST=$S(+$P(RX1,"^",11):+$P(RX1,"^",11),$D(^PSDRUG(DRUG,660)):+$P(^(660),"^",6),1:0)
"RTN","PSOCSTD",77,0)
 S RF=RF+1,QTY=+$P(RX1,"^",4),ML=$S($P(RX1,"^",2)="M":1,1:0),WD=$S($P(RX1,"^",2)="W":1,1:0) S COST=QTY*COST
"RTN","PSOCSTD",78,0)
 S PHYS=$S($P(RX1,"^",17):$P(RX1,"^",17),1:$P(RX0,"^",4)) D SF
"RTN","PSOCSTD",79,0)
 Q
"RTN","PSOCSTD",80,0)
 ;
"RTN","PSOCSTD",81,0)
G ;;
"RTN","PSOCSTD",82,0)
 ;;^PSCST($P(PSDT,"."),0);PSDT;^TMP($J,"A1");1
"RTN","PSOCSTD",83,0)
 ;;^PSCST($P(PSDT,"."),"P",PHYS,0);PHYS;^PSCST($P(PSDT,"."),"P",0);^50.9001PA^^
"RTN","PSOCSTD",84,0)
 ;;^PSCST($P(PSDT,"."),"P",PHYS,"D",DRUG,0);DRUG;^PSCST($P(PSDT,"."),"P",PHYS,"D",0);^50.9002PA^^
"RTN","PSOCSTD",85,0)
 ;;^PSCST($P(PSDT,"."),"D",DRUG,0);DRUG;^PSCST($P(PSDT,"."),"D",0);^50.9003PA^^
"RTN","PSOCSTD",86,0)
 ;;^PSCST($P(PSDT,"."),"D",DRUG,"P",PHYS,0);PHYS;^PSCST($P(PSDT,"."),"D",DRUG,"P",0);^50.9004PA^^
"RTN","PSOCSTD",87,0)
 ;;^PSCST($P(PSDT,"."),"PS",PAST,0);PAST;^PSCST($P(PSDT,"."),"PS",0);^50.9005PA^^
"RTN","PSOCSTD",88,0)
 ;;^PSCST($P(PSDT,"."),"S",CLINIC,0);CLINIC;^PSCST($P(PSDT,"."),"S",0);^50.9008PA^^
"RTN","PSOCSTD",89,0)
 ;;
"RTN","PSOCSTD",90,0)
D ;;
"RTN","PSOCSTD",91,0)
 ;;^PSCST($P(PSDT,"."),"V",DIV,0);DIV;^PSCST($P(PSDT,"."),"V",0);^50.9006PA^^
"RTN","PSOCSTD",92,0)
 ;;^PSCST($P(PSDT,"."),"V",DIV,"D",DRUG,0);DRUG;^PSCST($P(PSDT,"."),"V",DIV,"D",0);^50.9007PA^^
"RTN","PSOCSTD",93,0)
 ;;^PSCST($P(PSDT,"."),"V",DIV,"P",PHYS,0);PHYS;^PSCST($P(PSDT,"."),"V",DIV,"P",0);^50.901PA^^
"RTN","PSOHLDS2")
0^1^B75435444
"RTN","PSOHLDS2",1,0)
PSOHLDS2 ;BHAM ISC/PWC,SAB-Build HL7 Segments for automated interface ;4/18/05 12:55pm
"RTN","PSOHLDS2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,198**;DEC 1997
"RTN","PSOHLDS2",3,0)
 ;DIWP supported by DBIA 10011
"RTN","PSOHLDS2",4,0)
 ;HLFNC supported by DBIA 10106
"RTN","PSOHLDS2",5,0)
 ;^PS(50.606 supported by DBIA 2174
"RTN","PSOHLDS2",6,0)
 ;^PS(50.7 supported by DBIA #2223
"RTN","PSOHLDS2",7,0)
 ;^PS(51 supported by DBIA 2224
"RTN","PSOHLDS2",8,0)
 ;^PS(51.2 supported by DBIA 2226
"RTN","PSOHLDS2",9,0)
 ;^PS(55 supported by DBIA 2228
"RTN","PSOHLDS2",10,0)
 ;^PSDRUG supported by DBIA 221
"RTN","PSOHLDS2",11,0)
 ;^PS(54 supported by DBIA 2227
"RTN","PSOHLDS2",12,0)
 ;EN1^GMRAOR2 supported by DBIA 2422
"RTN","PSOHLDS2",13,0)
 ;^DPT supported by DBIA 3097
"RTN","PSOHLDS2",14,0)
 ;EN1^GMRADPT supported by DBIA 10099
"RTN","PSOHLDS2",15,0)
 ;PSNPPIO supported by DBIA 3794
"RTN","PSOHLDS2",16,0)
 ;Cont'd build HL7 segments
"RTN","PSOHLDS2",17,0)
 ;
"RTN","PSOHLDS2",18,0)
 ;PSO*198 add check to insert spaces into PMI segments
"RTN","PSOHLDS2",19,0)
 ;
"RTN","PSOHLDS2",20,0)
RXE(PSI) ;pharmacy encoded order segment
"RTN","PSOHLDS2",21,0)
 Q:'$D(DFN)  N RXE S RXE="" S $P(RXE,"|",1)=""""""
"RTN","PSOHLDS2",22,0)
 S $P(RXE,"|",2)=$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_$G(PSND2)_CS_"99PSNDF"_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",23,0)
 S $P(RXE,"|",3)="" I $G(PSOXN)="" S PSOXN=""""""
"RTN","PSOHLDS2",24,0)
 S $P(RXE,"|",5)=PSOXN_CS_$S($G(UNIT)'="":$G(UNIT),1:"""""")_CS_"99PSU"
"RTN","PSOHLDS2",25,0)
 S POIPTR=$P($G(^PSRX(IRXN,"OR1")),"^") I POIPTR S PODOSE=$P($G(^PS(50.7,POIPTR,0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",26,0)
 I '$G(POIPTR) S PODOSE=$P($G(^PS(50.7,$P($G(^PSDRUG(IDGN,2)),"^"),0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",27,0)
 S TRADENM=$G(^PSRX(IRXN,"TN")),$P(RXE,"|",6)=PODOSE_CS_PODOSENM_CS_"99PSF"
"RTN","PSOHLDS2",28,0)
 S $P(RXE,"|",8)=MP,$P(RXE,"|",9)=TRADENM,$P(RXE,"|",10)=QTY
"RTN","PSOHLDS2",29,0)
 S $P(RXE,"|",11)=CS_$P($G(^PSDRUG(IDGN,660)),"^",8),$P(RXE,"|",12)=NRFL
"RTN","PSOHLDS2",30,0)
 S $P(RXE,"|",13)=DEAID,$P(RXE,"|",14)=VPHARMID_CS_$P(VPHARM,",",1)_CS_$P(VPHARM,",",2)
"RTN","PSOHLDS2",31,0)
 S $P(RXE,"|",15)=$P(^PSRX(IRXN,0),"^"),$P(RXE,"|",16)=RFRM,$P(RXE,"|",17)=NFLD
"RTN","PSOHLDS2",32,0)
 S $P(RXE,"|",18)=PRIORDT,$P(RXE,"|",31)=CSUB_RS_SCTALK_RS_OTLAN
"RTN","PSOHLDS2",33,0)
 S ^TMP("PSO",$J,PSI)="RXE|"_RXE,PSI=PSI+1
"RTN","PSOHLDS2",34,0)
 K PODOSE,PODOSENM,POIPTR,TRADENM,UU
"RTN","PSOHLDS2",35,0)
 Q
"RTN","PSOHLDS2",36,0)
RXD(PSI) ;pharmacy dispense segment
"RTN","PSOHLDS2",37,0)
 Q:'$D(DFN)  N RXD
"RTN","PSOHLDS2",38,0)
 S WNS="" I $G(WARN) F I=1:1 S WW=$P(WARN,",",I) Q:WW=""  S WNS=WNS_WW_CS_^PS(54,WW,0)_RS
"RTN","PSOHLDS2",39,0)
 S RXD="RXD"_FS_$S($G(NFLD):NFLD,1:0)_FS_$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_PSND2_CS_"99PSNDF"
"RTN","PSOHLDS2",40,0)
 S RXD=RXD_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",41,0)
 S RXD=RXD_FS_DISPDT_FS_FS_FS_FS_$P(^PSRX(IRXN,0),"^")_FS_NRFL
"RTN","PSOHLDS2",42,0)
 S RXD=RXD_FS_DEA_RS_PSONDC_FS_$S(FIN'="":FIN_CS_FIN1,1:"")_FS
"RTN","PSOHLDS2",43,0)
 S RXD=RXD_FS_DASPLY_FS_MW_FS_FS_CS_$S($G(CAP):"NON-SAFETY",1:"SAFETY")
"RTN","PSOHLDS2",44,0)
 S RXD=RXD_FS_FS_FS_FS_EXDT_FS_FS_FS_FS_FS_FS_WNS_FS_FS
"RTN","PSOHLDS2",45,0)
 S ^TMP("PSO",$J,PSI)=RXD,PSI=PSI+1
"RTN","PSOHLDS2",46,0)
 Q
"RTN","PSOHLDS2",47,0)
RXR(PSI) ;pharmacy route segment
"RTN","PSOHLDS2",48,0)
 Q:'$D(DFN)  N RXR S (PSROUTE,RTNAME)=""""""
"RTN","PSOHLDS2",49,0)
 F PSRTLP=0:0 S PSRTLP=$O(^PSRX(IRXN,6,PSRTLP)) Q:'PSRTLP  D
"RTN","PSOHLDS2",50,0)
 .S PSROUTE=$P($G(^PSRX(IRXN,6,PSRTLP,0)),"^",7)
"RTN","PSOHLDS2",51,0)
 .I PSROUTE,$D(^PS(51.2,PSROUTE,0))  S RTNAME=$P(^PS(51.2,PSROUTE,0),"^")
"RTN","PSOHLDS2",52,0)
 I RTNAME="" K PSROUTE,RTNAME,PSRTLP Q
"RTN","PSOHLDS2",53,0)
 S RXR="RXR"_FS_$G(PSROUTE)_CS_$G(RTNAME)_CS_"99PSR"_FS_FS_FS_FS
"RTN","PSOHLDS2",54,0)
 S ^TMP("PSO",$J,PSI)=RXR,PSI=PSI+1
"RTN","PSOHLDS2",55,0)
 K PSROUTE,RTNAME,PSRTLP
"RTN","PSOHLDS2",56,0)
 Q
"RTN","PSOHLDS2",57,0)
SIG K OT S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""
"RTN","PSOHLDS2",58,0)
 .I $D(^PS(51,"A",X)) D
"RTN","PSOHLDS2",59,0)
 ..I $P($G(^PS(55,DFN,"LAN")),"^") S OT=$O(^PS(51,"B",X,0)) I OT,$P($G(^PS(51,OT,4)),"^")]"" S X=$P(^PS(51,OT,4),"^") K OT Q
"RTN","PSOHLDS2",60,0)
 ..;S %=^PS(51,"A",X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG," ",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOHLDS2",61,0)
 .S SGY=SGY_X_" "
"RTN","PSOHLDS2",62,0)
 S X="",SGC=1 F J=1:1 S Z=$P(SGY," ",J) S:Z="" SGY(SGC)=X Q:Z=""  S:$L(X)+$L(Z)'<$S($P(PSOPAR,"^",28):46,1:34) SGY(SGC)=X,SGC=SGC+1,X="" S X=X_Z_" "
"RTN","PSOHLDS2",63,0)
SIGOLD I '$P(PSOPAR,"^",28) D  K NHC
"RTN","PSOHLDS2",64,0)
 .K DIC,DR,DIQ,NHC S DIC=2,DA=DFN,DR=148,DIQ="NHC",DIQ(0)="I"
"RTN","PSOHLDS2",65,0)
 .D EN^DIQ1 K DIC,DR,DIQ
"RTN","PSOHLDS2",66,0)
 .I NHC(2,DFN,148,"I")="Y"!($P($G(^PS(55,DFN,40)),"^")) S SGC=SGC+1,SGY(SGC)="Expiration:________ Mfg:_________"
"RTN","PSOHLDS2",67,0)
 Q
"RTN","PSOHLDS2",68,0)
 ;
"RTN","PSOHLDS2",69,0)
PSOLBL3 ;RX must be defined (Internal), Check already done for OERR SIG
"RTN","PSOHLDS2",70,0)
 ;Format OERR Sig for New and Old label stock
"RTN","PSOHLDS2",71,0)
 N CTCT,FFFF,LLIM,LLLL,LVAR,LVAR1,PPP,PPPP,SGCT,SIG9,ZZZZ,PSLONG,PPPP
"RTN","PSOHLDS2",72,0)
 S RX=IRXN
"RTN","PSOHLDS2",73,0)
 I $P($G(^PS(55,DFN,"LAN")),"^") N II D OTHL^PSOLBL3 G:$G(FND) FMSIG
"RTN","PSOHLDS2",74,0)
 S PSLONG=$S($P(PSOPAR,"^",28):46,1:34)
"RTN","PSOHLDS2",75,0)
 ; NEXT LINE IF SIG IS MOVED BACK TO MULTIPLE
"RTN","PSOHLDS2",76,0)
 S PPPP=1 F PPP=0:0 S PPP=$O(^PSRX(RX,"SIG1",PPP)) Q:'PPP  I $G(^PSRX(RX,"SIG1",PPP,0))'="" S SIG9(PPPP)=^(0) S PPPP=PPPP+1
"RTN","PSOHLDS2",77,0)
 ;NEXT LINE IF 1ST FRONT DOOR SIG LINE LIVES IN BACK DOOR SPOT
"RTN","PSOHLDS2",78,0)
FMSIG S (LVAR,LVAR1)="",LLLL=1
"RTN","PSOHLDS2",79,0)
 F FFFF=0:0 S FFFF=$O(SIG9(FFFF)) Q:'FFFF  S SGCT=0 F ZZZZ=1:1:$L(SIG9(FFFF)) I $E(SIG9(FFFF),ZZZZ)=" "!($L(SIG9(FFFF))=ZZZZ) S SGCT=SGCT+1 D  I $L(LVAR)>PSLONG S SGY(LLLL)=LLIM_" ",LLLL=LLLL+1,LVAR=LVAR1
"RTN","PSOHLDS2",80,0)
 .S LVAR1=$P(SIG9(FFFF)," ",(SGCT)),LLIM=LVAR,LVAR=$S(LVAR="":LVAR1,1:LVAR_" "_LVAR1)
"RTN","PSOHLDS2",81,0)
 I $G(LVAR)'="" S SGY(LLLL)=LVAR
"RTN","PSOHLDS2",82,0)
 I '$P(PSOPAR,"^",28) S SGC=0 F CTCT=0:0 S CTCT=$O(SGY(CTCT)) Q:'CTCT  S SGC=SGC+1
"RTN","PSOHLDS2",83,0)
 I $O(OSGY(0)) D
"RTN","PSOHLDS2",84,0)
 .F I=0:0 S I=$O(SGY(I)) Q:'I  I $G(OSGY(I))']"" S OSGY(I)=" "
"RTN","PSOHLDS2",85,0)
 .F I=0:0 S I=$O(OSGY(I)) Q:'I  I $G(SGY(I))']"" S SGY(I)=" "
"RTN","PSOHLDS2",86,0)
 Q
"RTN","PSOHLDS2",87,0)
NTE ;build NTE segment for SIG
"RTN","PSOHLDS2",88,0)
 ;
"RTN","PSOHLDS2",89,0)
 Q:'$D(DFN)
"RTN","PSOHLDS2",90,0)
 ; 1 = SIG
"RTN","PSOHLDS2",91,0)
 ; 2 = PI Narrative
"RTN","PSOHLDS2",92,0)
 ; 3 = Drug Warning
"RTN","PSOHLDS2",93,0)
 ; 4 = Profile
"RTN","PSOHLDS2",94,0)
 ; 5 = Drug Interaction
"RTN","PSOHLDS2",95,0)
 ; 6 = Drug Allergy
"RTN","PSOHLDS2",96,0)
 ;
"RTN","PSOHLDS2",97,0)
 K FLDX
"RTN","PSOHLDS2",98,0)
 D NTE1(.PSI) K FLDX D NTE2(.PSI) K FLDX D NTE3(.PSI) K FLDX
"RTN","PSOHLDS2",99,0)
 D NTE4(.PSI) K FLDX D NTE5(.PSI) K FLDX D NTE6(.PSI) K FLDX
"RTN","PSOHLDS2",100,0)
 Q
"RTN","PSOHLDS2",101,0)
 ;
"RTN","PSOHLDS2",102,0)
NTE1(PSI) ;SIG
"RTN","PSOHLDS2",103,0)
 S SIG=$P($G(^PSRX(IRXN,"SIG")),"^")
"RTN","PSOHLDS2",104,0)
 I $P($G(^PSRX(IRXN,"SIG")),"^",2) D PSOLBL3,SIGOLD
"RTN","PSOHLDS2",105,0)
 I '$P($G(^PSRX(IRXN,"SIG")),"^",2) D SIG
"RTN","PSOHLDS2",106,0)
 I $O(OSGY(0)) D  G KNTE
"RTN","PSOHLDS2",107,0)
 .K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",108,0)
 .S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions (LANGUAGE PREFERENCE)"
"RTN","PSOHLDS2",109,0)
 .K DRR F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",110,0)
 .S DRR=DRR+1,OSGY(DRR)=FS_"Medication Instructions (ENGLISH)"
"RTN","PSOHLDS2",111,0)
 .K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",112,0)
 .S CLD=1 F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",113,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR)
"RTN","PSOHLDS2",114,0)
 .S PSI=PSI+1,^TMP("PSO",$J,PSI)="NTE"_FS_8_FS_FS
"RTN","PSOHLDS2",115,0)
 .S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",116,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",117,0)
 K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",118,0)
 S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions"
"RTN","PSOHLDS2",119,0)
 K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",120,0)
 S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",121,0)
 .S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",122,0)
KNTE S PSI=PSI+1 K DR,CLD,DRR,SIG,E,F,S,FLD1,X,Y,SGY,SGC,Z,DR,%,J,P,NT1,ST,EN,LTH
"RTN","PSOHLDS2",123,0)
 Q
"RTN","PSOHLDS2",124,0)
LENGTH(NT1) ; compensate for length > 245
"RTN","PSOHLDS2",125,0)
 I $L(NT1)>245 S LTH=$E($L(NT1)/245,1) S:$L(NT1)#245>0 LTH=LTH+1 F WW=1:1:LTH D
"RTN","PSOHLDS2",126,0)
 . S:WW=1 ST=1,EN=245 S:WW>1 ST=(ST+245),EN=(EN+245) S NT11=$E(NT1,ST,EN)
"RTN","PSOHLDS2",127,0)
 . S:WW=1 ^TMP("PSO",$J,PSI)=NT11 S:WW>1 ^TMP("PSO",$J,PSI,WW-1)=NT11
"RTN","PSOHLDS2",128,0)
 S:'$D(LTH) ^TMP("PSO",$J,PSI)=NT1 S PSI=PSI+1
"RTN","PSOHLDS2",129,0)
 Q
"RTN","PSOHLDS2",130,0)
NTE2(PSI) ; Patient Narrative
"RTN","PSOHLDS2",131,0)
 K ^UTILITY($J,"W") S (DIWL,PSNACNT)=1,DIWR=45,DIWF="",(PSSIXFL,PSSEVFL)=0 F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,6,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",132,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSIXFL=1
"RTN","PSOHLDS2",133,0)
 I PSSIXFL S ^TMP("PSO",$J,PSI)="NTE"_FS_2_FS_FS,^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1,FLDX=1
"RTN","PSOHLDS2",134,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,7,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",135,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSEVFL=1
"RTN","PSOHLDS2",136,0)
 I PSSEVFL S ^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",137,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,4,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",138,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",139,0)
 S:$D(FLDX) ^TMP("PSO",$J,PSI,PSNACNT-1)=^TMP("PSO",$J,PSI,PSNACNT-1)_FS_"Patient Narrative",PSI=PSI+1
"RTN","PSOHLDS2",140,0)
 K DIWF,DIWL,DIWR,LLL,PSNACNT,PSSEVFL,PSSIXFL,ZZ
"RTN","PSOHLDS2",141,0)
 Q
"RTN","PSOHLDS2",142,0)
NTE3(PSI) ;Drug Warning Narrative
"RTN","PSOHLDS2",143,0)
 N NTE3 S WARN=$P($G(^PSDRUG(IDGN,0)),"^",8)
"RTN","PSOHLDS2",144,0)
 S:WARN'="" NTE3="NTE"_FS_3_FS_FS,^TMP("PSO",$J,PSI)=NTE3,CNT=1
"RTN","PSOHLDS2",145,0)
 F WWW=1:1 Q:$P(WARN,",",WWW,99)=""  S PSOWARN=$P(WARN,",",WWW) D:$D(^PS(54,PSOWARN,0))
"RTN","PSOHLDS2",146,0)
 .S FLDX=1 F JJJ=1:1 Q:'$D(^PS(54,PSOWARN,1,JJJ,0))  S ^TMP("PSO",$J,PSI,CNT)=^PS(54,PSOWARN,1,JJJ,0),CNT=CNT+1
"RTN","PSOHLDS2",147,0)
 S:$D(FLDX) ^TMP("PSO",$J,PSI,CNT-1)=$G(^TMP("PSO",$J,PSI,CNT-1))_FS_"Drug Warning Narrative",PSI=PSI+1
"RTN","PSOHLDS2",148,0)
 K CNT,WW,JJJ,PSOWARN,RX,WWW
"RTN","PSOHLDS2",149,0)
 Q
"RTN","PSOHLDS2",150,0)
NTE4(PSI) ;Profile information
"RTN","PSOHLDS2",151,0)
 S PSODFN=DFN N NTE4
"RTN","PSOHLDS2",152,0)
 I $P(PSOPAR,"^",8) D START^PSOHLDS3
"RTN","PSOHLDS2",153,0)
 S:$D(NTE4) PSI=PSI+1
"RTN","PSOHLDS2",154,0)
 Q
"RTN","PSOHLDS2",155,0)
NTE5(PSI) ;Drug Interactions
"RTN","PSOHLDS2",156,0)
 N NTE5 D:$D(DRI) START2^PSOHLDS3
"RTN","PSOHLDS2",157,0)
 S:$D(NTE5) ^TMP("PSO",$J,PSI)=NTE5_FS_"Drug Interactions",PSI=PSI+1
"RTN","PSOHLDS2",158,0)
 Q
"RTN","PSOHLDS2",159,0)
NTE6(PSI) ;Drug Allergy Indications
"RTN","PSOHLDS2",160,0)
 N NTE6
"RTN","PSOHLDS2",161,0)
 Q:'$G(DAW)
"RTN","PSOHLDS2",162,0)
 D START3^PSOHLDS3
"RTN","PSOHLDS2",163,0)
 Q:NTE6=""
"RTN","PSOHLDS2",164,0)
 S ^TMP("PSO",$J,PSI)=NTE6_FS_"Drug Allergy Indications",PSI=PSI+1
"RTN","PSOHLDS2",165,0)
 Q
"RTN","PSOHLDS2",166,0)
NTEPMI(PSI) ;build NTE segment for PMI sheets
"RTN","PSOHLDS2",167,0)
 Q:'$D(DFN)  N A,I,PREVLN,CURRLN
"RTN","PSOHLDS2",168,0)
 S PSDRUG=+$P(^PSRX(IRXN,0),"^",6),PMI=$$EN^PSNPPIO(PSDRUG,.PSNMSG)
"RTN","PSOHLDS2",169,0)
 Q:'$D(^TMP($J,"PSNPMI"))
"RTN","PSOHLDS2",170,0)
 S ^TMP("PSO",$J,PSI)="NTE"_FS_^TMP($J,"PSNPMI",0)_FS
"RTN","PSOHLDS2",171,0)
 K A S CNT1=1,CNT=0
"RTN","PSOHLDS2",172,0)
 F A="W","U","H","S","M","P","I","O","N","D","R" S CNT=CNT+1,A(CNT)=A
"RTN","PSOHLDS2",173,0)
 F I=1:1:11 I $D(^TMP($J,"PSNPMI",A(I))) D
"RTN","PSOHLDS2",174,0)
 .S CNT=$P(^TMP($J,"PSNPMI",A(I),0),"^",3)
"RTN","PSOHLDS2",175,0)
 .S (PREVLN,CURRLN)=""
"RTN","PSOHLDS2",176,0)
 .F J=1:1:CNT D
"RTN","PSOHLDS2",177,0)
 .. S ^TMP("PSO",$J,PSI,CNT1)=^TMP($J,"PSNPMI",A(I),J,0)
"RTN","PSOHLDS2",178,0)
 .. ;PSO*198 check if " " should be inserted
"RTN","PSOHLDS2",179,0)
 .. S CURRLN=^TMP("PSO",$J,PSI,CNT1)
"RTN","PSOHLDS2",180,0)
 .. S:CNT1>1 PREVLN=$S(CNT>1:^TMP("PSO",$J,PSI,CNT1-1),1:"")
"RTN","PSOHLDS2",181,0)
 .. I CNT1>1,$$SPACE^PSOHLDS3(PREVLN,CURRLN) D
"RTN","PSOHLDS2",182,0)
 ... S ^TMP("PSO",$J,PSI,CNT1)=" "_^TMP("PSO",$J,PSI,CNT1)
"RTN","PSOHLDS2",183,0)
 .. I J=1 S $P(^TMP("PSO",$J,PSI,CNT1),":",1)="\H\"_$P(^TMP("PSO",$J,PSI,CNT1),":",1)_"\N\"
"RTN","PSOHLDS2",184,0)
 .. S CNT1=CNT1+1
"RTN","PSOHLDS2",185,0)
 S ^TMP("PSO",$J,PSI,CNT1-1)=^TMP("PSO",$J,PSI,CNT1-1)_FS_"Patient Medication Instructions"
"RTN","PSOHLDS2",186,0)
 S PSI=PSI+1 K A,I,J,CNT,CNT1,^TMP($J,"PSNPMI")
"RTN","PSOHLDS2",187,0)
 Q
"RTN","PSOHLDS3")
0^2^B43031009
"RTN","PSOHLDS3",1,0)
PSOHLDS3 ;BHAM ISC/SAB,LC,PWC - BUILD PROFILE FOR AUTOMATED INTERFACE ;4/13/05 1:53pm
"RTN","PSOHLDS3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,198**;DEC 1997
"RTN","PSOHLDS3",3,0)
 ;reference to PSDRUG suppoprted by DBIA # 221
"RTN","PSOHLDS3",4,0)
 ;reference to PS(50.606 supported by DBIA # 2174
"RTN","PSOHLDS3",5,0)
 ;reference to PS(50.7 supported by DBIA #2223
"RTN","PSOHLDS3",6,0)
 ;reference to PS(55 supported by DBIA # 2228
"RTN","PSOHLDS3",7,0)
 ;reference to PS(56 supported by DBIA # 2229
"RTN","PSOHLDS3",8,0)
 ;
"RTN","PSOHLDS3",9,0)
 ;PSO*198 add check to insert spaces into PMI segments, also add
"RTN","PSOHLDS3",10,0)
 ;        "NTE|6||" to beginning of NTE6 segment
"RTN","PSOHLDS3",11,0)
 ;
"RTN","PSOHLDS3",12,0)
START ;build profile for the NTE4 segment
"RTN","PSOHLDS3",13,0)
 Q:'$D(DFN)
"RTN","PSOHLDS3",14,0)
 N II K ^TMP($J,"PRF")
"RTN","PSOHLDS3",15,0)
 S PSODFN=DFN I '$D(PSODTCUT) D CUTDATE^PSOFUNC
"RTN","PSOHLDS3",16,0)
 S:'$D(Z) Z=1 S:'$D(NEW1) (NEW1,NEW11)="^" S %DT="",X="T" D ^%DT S DT1=Y S X1=DT1,X2=-365 D C^%DTC S EXPS=X S X1=DT1,X2=-182 D C^%DTC S EXP=X
"RTN","PSOHLDS3",17,0)
 F RXX=0:0 S RXX=$O(^PS(55,DFN,"P",RXX)) Q:'RXX  S RXNN=+^(RXX,0) I $D(^PSRX(RXNN,0)),$P($G(^("STA")),"^")'=13 S RXPX=^PSRX(RXNN,0),$P(RXPX,"^",15)=$P($G(^("STA")),"^"),RXPX2=^(2) D CHK
"RTN","PSOHLDS3",18,0)
 I '$D(^TMP($J,"PRF")) G PPP
"RTN","PSOHLDS3",19,0)
 ;
"RTN","PSOHLDS3",20,0)
SD S CNT=1 F SD="A","C","S" I $D(^TMP($J,"PRF",SD)) S DRNME="" D DRNME
"RTN","PSOHLDS3",21,0)
PPP D PEND
"RTN","PSOHLDS3",22,0)
 K ^TMP($J,"PRF")
"RTN","PSOHLDS3",23,0)
 K A,B,DRNME,DRP,EXP,EXPS,I,II,ISSD,J,LINE,LN,MESS,MJK,NEW1,NEW11,PHYS,POP,PQTY,TTTT,RFL,RFS,RXF,RXNN,RXPX,RXPX2,RXPNO,RXX
"RTN","PSOHLDS3",24,0)
 K SD,SIG,STA,X,X1,X2,Y,Z,CNT,PEND,PSODTCUT,PSOPRPAS,PZZODRUG,RFDATE
"RTN","PSOHLDS3",25,0)
 Q
"RTN","PSOHLDS3",26,0)
DRNME S DRNME=$O(^TMP($J,"PRF",SD,DRNME)) Q:DRNME=""  D ISSD G DRNME
"RTN","PSOHLDS3",27,0)
 ;
"RTN","PSOHLDS3",28,0)
ISSD F ISSD=0:0 S ISSD=$O(^TMP($J,"PRF",SD,DRNME,ISSD)) Q:'ISSD  S RXPNO="" D RXPNO
"RTN","PSOHLDS3",29,0)
 Q
"RTN","PSOHLDS3",30,0)
RXPNO S RXPNO=$O(^TMP($J,"PRF",SD,DRNME,ISSD,RXPNO)) Q:RXPNO=""  S RXNN=^(RXPNO) I $D(^PSRX(RXNN,0)) S RXPX=^(0),RXPX2=^(2) D PRT G RXPNO
"RTN","PSOHLDS3",31,0)
 ;
"RTN","PSOHLDS3",32,0)
CHK Q:PSODTCUT>$P(RXPX2,"^",6)
"RTN","PSOHLDS3",33,0)
 I $P(^PSRX(RXNN,"STA"),"^")=12 S II=RXNN D LAST^PSORFL Q:PSODTCUT>RFDATE
"RTN","PSOHLDS3",34,0)
 I $P(RXPX,"^",3)=7!($P(RXPX,"^",3)=8)&('PSOPRPAS) Q
"RTN","PSOHLDS3",35,0)
 S J="^"_RXNN_"^" Q:(NEW1[J)!(NEW11[J)  Q:$P(RXPX,"^",13)<EXPS  S RXPNO=$P(RXPX,"^"),ISSD=$P(RXPX,"^",13)
"RTN","PSOHLDS3",36,0)
 Q:'$D(^PSDRUG($P(RXPX,"^",6),0))  S DRP=^(0),SD=$S($P(DRP,"^",3)["S":"S",$P(RXPX,"^",15)=12:"C",1:"A"),DRNME=$P(DRP,"^"),^TMP($J,"PRF",SD,DRNME,ISSD,RXPNO)=RXNN
"RTN","PSOHLDS3",37,0)
 Q
"RTN","PSOHLDS3",38,0)
PRT S RFS=$P(RXPX,"^",9),PQTY=$P(RXPX,"^",7)
"RTN","PSOHLDS3",39,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(RXPX,"^",4) D ^DIC
"RTN","PSOHLDS3",40,0)
 S PHYS=$S(+Y:$P(Y,"^",2),1:"UNKNOWN"),II=RXNN D LAST^PSORFL S RXF=0 F MJK=0:0 S MJK=$O(^PSRX(RXNN,1,MJK)) Q:'MJK  S RXF=RXF+1
"RTN","PSOHLDS3",41,0)
 S STA=$S($P(^PSRX(RXNN,"STA"),"^")=14:"DC",$P(^PSRX(RXNN,"STA"),"^")=15:"DE",$P(^PSRX(RXNN,"STA"),"^")=16:"PH",1:$E("ANRHPS     ECD",(1+$P(^PSRX(RXNN,"STA"),"^")))),STA=$S(DT1>$P(RXPX2,"^",6):"E",1:STA)
"RTN","PSOHLDS3",42,0)
 D SIG S FSIG=$O(FSIG(""),-1)
"RTN","PSOHLDS3",43,0)
 S ^TMP("PSO",$J,PSI)="NTE"_FS_4_FS_FS,NTE4=1
"RTN","PSOHLDS3",44,0)
 S ^TMP("PSO",$J,PSI,CNT)=SD_CS_RXPNO_CS_DRNME_CS_$E(ISSD,4,5)_"/"_$E(ISSD,6,7)
"RTN","PSOHLDS3",45,0)
 S ^TMP("PSO",$J,PSI,CNT)=^TMP("PSO",$J,PSI,CNT)_CS_$E(RFL,1,5)_CS_RFS_CS_RXF_CS_PQTY_CS_STA_CS_$E(PHYS,1,20)_CS_$S($G(FSIG)'="":FSIG,1:"""""")_FS_"Profile Information"
"RTN","PSOHLDS3",46,0)
 S CNT=CNT+1
"RTN","PSOHLDS3",47,0)
 Q
"RTN","PSOHLDS3",48,0)
SIG ;Format Sig
"RTN","PSOHLDS3",49,0)
 S PSPROSIG=$P($G(^PSRX(RXNN,"SIG")),"^",2) K FSIG,BSIG D
"RTN","PSOHLDS3",50,0)
 .I PSPROSIG D FSIG^PSOUTLA("R",RXNN,80) Q
"RTN","PSOHLDS3",51,0)
 .D EN2^PSOUTLA1(RXNN,80) F GGGGG=0:0 S GGGGG=$O(BSIG(GGGGG)) Q:'GGGGG  S FSIG(GGGGG)=BSIG(GGGGG)
"RTN","PSOHLDS3",52,0)
 K PSPROSIG,GGGGG,BSIG Q
"RTN","PSOHLDS3",53,0)
PEND ;include pending orders in profile
"RTN","PSOHLDS3",54,0)
 N PSPCOUNT,PSPPEND,ZXXX,PSPSTAT,FSIGZZ,PZZDRUG,PSSODRUG,PZXZERO,PPPPP,GGGGG
"RTN","PSOHLDS3",55,0)
 S PSPCOUNT=1,PSPPEND="" F PPPPP=0:0 S PPPPP=$O(^PS(52.41,"P",DFN,PPPPP)) Q:'PPPPP  S PSPSTAT=$P($G(^PS(52.41,PPPPP,0)),"^",3) I PSPSTAT="NW"!(PSPSTAT="HD")!(PSPSTAT="RNW") S PSPPEND(PSPCOUNT)=PPPPP,PSPCOUNT=PSPCOUNT+1
"RTN","PSOHLDS3",56,0)
 Q:'$O(PSPPEND(0))
"RTN","PSOHLDS3",57,0)
 F ZXXX=0:0 S ZXXX=$O(PSPPEND(ZXXX)) Q:'ZXXX  S PZXZERO=$G(^PS(52.41,PSPPEND(ZXXX),0)) D:$P(PZXZERO,"^")
"RTN","PSOHLDS3",58,0)
 .S PZZDRUG=$P(PZXZERO,"^",9),PZZODRUG=$P(PZXZERO,"^",8) Q:'PZZDRUG  Q:'PZZODRUG
"RTN","PSOHLDS3",59,0)
 .S PEND="P"_CS_$S(PZZDRUG:$P($G(^PSDRUG(+PZZDRUG,0)),"^"),1:$P($G(^PS(50.7,+PZZODRUG,0)),"^")_" "_$P($G(^PS(50.606,+$P($G(^(0)),"^",2),0)),"^"))
"RTN","PSOHLDS3",60,0)
 .S PEND=PEND_CS_$E($P(PZXZERO,"^",6),4,5)_"/"_$E($P(PZXZERO,"^",6),6,7)_"/"_$E($P(PZXZERO,"^",6),2,3)
"RTN","PSOHLDS3",61,0)
 . K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+$P(PZXZERO,"^",5) D ^DIC
"RTN","PSOHLDS3",62,0)
 .S PEND=PEND_CS_$P(PZXZERO,"^",10)_CS_$P(PZXZERO,"^",11)_CS_$S(+Y:$P(Y,"^",2),1:"")
"RTN","PSOHLDS3",63,0)
 .D FSIG^PSOUTLA("P",PSPPEND(ZXXX),100) S PEND=PEND_CS_$G(FSIG(1)) F FSIGZZ=1:0 S FSIGZZ=$O(FSIG(FSIGZZ)) Q:'FSIGZZ  S PEND=PEND_CS_$G(FSIG(FSIGZZ))
"RTN","PSOHLDS3",64,0)
 S:$D(PEND) ^TMP("PSO",$J,PSI,CNT)=PEND
"RTN","PSOHLDS3",65,0)
 S CNT=CNT+1
"RTN","PSOHLDS3",66,0)
 Q
"RTN","PSOHLDS3",67,0)
 ;
"RTN","PSOHLDS3",68,0)
START2 ;build NTE for drug interactions
"RTN","PSOHLDS3",69,0)
 K PSOSERV
"RTN","PSOHLDS3",70,0)
 S RX=IRXN,RXY=^PSRX(RX,0)
"RTN","PSOHLDS3",71,0)
 I $D(^PS(52.4,RX,0)) S SCRIPT=$P(^PS(52.4,RX,0),"^",10),SEV=$P(^PS(52.4,RX,0),"^",9) F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOHLDS3",72,0)
 .S SER=$P(^PS(56,SEV(X),0),"^",4) S:$G(SER)=1 PSOSERV=1
"RTN","PSOHLDS3",73,0)
 .S DIRX=$P($G(^PSRX(RXX(X),0)),"^"),TYP=$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")
"RTN","PSOHLDS3",74,0)
 .S DRG=$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOHLDS3",75,0)
 .S:X=1 NTE5=DIRX_CS_TYP_CS_DRG
"RTN","PSOHLDS3",76,0)
 .S:X>1 NTE5=RS_DIRX_CS_TYP_CS_DRG
"RTN","PSOHLDS3",77,0)
 I '$D(^PS(52.4,RX,0)),$D(^PSRX(RX,"DRI")) S SCRIPT=$P(^PSRX(RX,"DRI"),"^",2),SEV=$P(^PSRX(RX,"DRI"),"^") F X=1:1 S RXX(X)=$P(SCRIPT,",",X),SEV(X)=$P(SEV,",",X) Q:RXX(X)=""  D
"RTN","PSOHLDS3",78,0)
 .S SER=$P(^PS(56,SEV(X),0),"^",4)
"RTN","PSOHLDS3",79,0)
 .S DIRX=$P($G(^PSRX(RXX(X),0)),"^"),TYP=$S(SER=1:"CRITICAL",SER=2:"SIGNIFICANT",1:"UNKNOWN")
"RTN","PSOHLDS3",80,0)
 .S DRG=$P(^PSDRUG($P(^PSRX(RXX(X),0),"^",6),0),"^")
"RTN","PSOHLDS3",81,0)
 .S:X=1 NTE5=DIRX_CS_TYP_CS_DRG
"RTN","PSOHLDS3",82,0)
 .S:X>1 NTE5=RS_DIRX_CS_TYP_CS_DRG
"RTN","PSOHLDS3",83,0)
 S NTE5=NTE5_CS_$S('$G(PSOSERV):"MAY REQUIRE",1:"REQUIRES")_$S('$G(PSOSERV):" REVIEWING BY A PHARMACIST",1:" INTERVENTION BY A PHARMACIST")
"RTN","PSOHLDS3",84,0)
 K SER,SCRIPT,DIRX,TYP,DRG,SEV,RXX,RX,RXY
"RTN","PSOHLDS3",85,0)
 Q
"RTN","PSOHLDS3",86,0)
START3 ;build NTE for drug allergy warning label                    ;PSO*198
"RTN","PSOHLDS3",87,0)
 Q:'$G(DAW)
"RTN","PSOHLDS3",88,0)
 S NTE6="NTE"_FS_6_FS_FS
"RTN","PSOHLDS3",89,0)
 I '$G(DIN) D
"RTN","PSOHLDS3",90,0)
 . S DARX=$P(^PSRX(IRXN,0),"^"),DRG=$P(^PSDRUG(IDGN,0),"^")
"RTN","PSOHLDS3",91,0)
 . S NTE6=NTE6_DARX_CS_DRG
"RTN","PSOHLDS3",92,0)
 I $G(DIN) D
"RTN","PSOHLDS3",93,0)
 . S DARX=$P(^PSRX(IRXN,0),"^"),DRG=$P(^PSDRUG(IDGN,0),"^") D
"RTN","PSOHLDS3",94,0)
 . . S NTE6=NTE6_DARX_CS_DRG
"RTN","PSOHLDS3",95,0)
 . . F XY=1:1 S INGRE=ING(XY) S:XY=1 NTE6=NTE6_CS_INGRE S:XY>1 NTE6=NTE6_RS_INGRE Q:'INGRE
"RTN","PSOHLDS3",96,0)
 K DARX,DRG,XY,INGRE
"RTN","PSOHLDS3",97,0)
 Q
"RTN","PSOHLDS3",98,0)
 ;PSO*198
"RTN","PSOHLDS3",99,0)
SPACE(PLN,CLN) ;check if a space should be inserted between lines of text
"RTN","PSOHLDS3",100,0)
 ;  Input:   PLN - previous line of text
"RTN","PSOHLDS3",101,0)
 ;           CLN - current line of text to be appended to previous
"RTN","PSOHLDS3",102,0)
 ;  function return:  0 - do not insert space
"RTN","PSOHLDS3",103,0)
 ;                    1 - insert space
"RTN","PSOHLDS3",104,0)
 ;
"RTN","PSOHLDS3",105,0)
 ;quit 0, on cases where a space should NOT be inserted else assume 1
"RTN","PSOHLDS3",106,0)
 ;
"RTN","PSOHLDS3",107,0)
 N TSTP,TSTC,PCHR2,CCHR2                   ;  QUIT 0 CASES BELOW
"RTN","PSOHLDS3",108,0)
 Q:PLN="" 0                                ;no previous line, ignore
"RTN","PSOHLDS3",109,0)
 Q:$E(PLN,$L(PLN))=" " 0                   ;prev line ends in " "
"RTN","PSOHLDS3",110,0)
 Q:$E(CLN,1)=" " 0                         ;curr line begins in " "
"RTN","PSOHLDS3",111,0)
 S PCHR2=$E(PLN,$L(PLN)-1,$L(PLN))         ;last 2 char of prev line
"RTN","PSOHLDS3",112,0)
 S CCHR2=$E(CLN,1,2)                       ;first 2 char of curr line
"RTN","PSOHLDS3",113,0)
 Q:PCHR2?1A1"/" 0                          ;the prev & curr lines
"RTN","PSOHLDS3",114,0)
 Q:CCHR2?1"/"1A 0                          ; split, ex: "and/or"
"RTN","PSOHLDS3",115,0)
 Q:PCHR2?1A1"-" 0                          ;the prev & curr lines
"RTN","PSOHLDS3",116,0)
 Q:CCHR2?1"-"1A 0                          ; split ex: "15-25 degrees"
"RTN","PSOHLDS3",117,0)
 S TSTP=$TR(PCHR2,"abcdefghijklmnoqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOHLDS3",118,0)
 S TSTC=$TR(CCHR2,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","PSOHLDS3",119,0)
 S TSTP=TSTP_TSTC
"RTN","PSOHLDS3",120,0)
 Q:TSTP="E.G." 0                           ;lines are splitting "e.g."
"RTN","PSOHLDS3",121,0)
 Q:TSTP="I.E." 0                           ;lines are splitting "i.e."
"RTN","PSOHLDS3",122,0)
 ;
"RTN","PSOHLDS3",123,0)
 Q 1
"RTN","PSOMGCM1")
0^4^B39573969
"RTN","PSOMGCM1",1,0)
PSOMGCM1 ;BHAM ISC/JMB,SAB - management data compile/recompile ;4/15/05 3:10pm
"RTN","PSOMGCM1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,28,175,185,198**;DEC 1997
"RTN","PSOMGCM1",3,0)
 ;Ref. to $$RXSUM^FBRXUTL supp. by IA# 4395
"RTN","PSOMGCM1",4,0)
 ;Ref. to ^PSDRUG(, supp. by IA# 221
"RTN","PSOMGCM1",5,0)
 ;PSO*198 correct begin date to previous day @ time 999999
"RTN","PSOMGCM1",6,0)
 ;
"RTN","PSOMGCM1",7,0)
END K ^TMP($J),%DT,AVGCAT,AVGEQFL,AVGFEE,AVGST,CAT,CATA,CATC,CATCOST,COST,DA,DATE,DIC,DINUM,DFN,DIRUT,DIV,DV,EQCOST,EQFL,EQPREQ,DRUG,EDT,FEE,FCOST,INV,MAIL,METH,NEW,METH,METHAD,OTH,PCAT,PHYS,PP,PPCOST,PREQ,PDATE,RECOM
"RTN","PSOMGCM1",8,0)
 K QTY30,QTY60,QTY90,QTY90P,QTY120,QTY179,QTY180,REC,R,REF,RX0,RXF,RXPREQ,SDT,ST,STAFF,STCOST,SUB,VAEL,WIND,AVGMETH,COSTPST,METHCOST,PCPP,NODE1,X,Y,ZTDESC,ZTDTH,ZTRTN,ZTSAVE
"RTN","PSOMGCM1",9,0)
 K TFIL,TFTY,TFCT,TY,NDT,DAYS,COM,STN S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOMGCM1",10,0)
 Q
"RTN","PSOMGCM1",11,0)
PURG ;purge data for a date range
"RTN","PSOMGCM1",12,0)
 W !,"Purge Management Statistics",!! S SDT=$O(^PS(59.12,0)) I $D(SDT) S Y=SDT D DD^%DT S %DT("B")=Y
"RTN","PSOMGCM1",13,0)
 S %DT(0)=-DT,%DT("A")="Starting date: " S %DT="EPXA" D ^%DT G:"^"[X END G RECOM:'Y S SDT=Y K %DT(0) S Y=SDT D DD^%DT S SY=Y K %DT("B"),Y
"RTN","PSOMGCM1",14,0)
PDT W ! S %DT(0)=SDT,%DT("A")="  Ending date: " D ^%DT G:"^"[X END G:Y<0 PDT S EDT=Y W !
"RTN","PSOMGCM1",15,0)
 W !,$C(7),$C(7) S Y=EDT D DD^%DT W !!!,"Purge from "_SY_" to "_Y,!
"RTN","PSOMGCM1",16,0)
 S DIR("A")="Are you sure",DIR(0)="Y",DIR("B")="N" D ^DIR K DIR I $G(DIRUT)!('Y) K EDT,SDT,SY,Y W !,$C(7),"No data has been purged." Q
"RTN","PSOMGCM1",17,0)
 S ZTDTH="",ZTRTN="P^PSOMGCM1",ZTDESC="Outpatient Pharmacy Management Data Purge",ZTIO="" F G="SDT","EDT" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOMGCM1",18,0)
 D ^%ZTLOAD W:$D(ZTSK) !!,"Task Queued !",! K SDT,EDT,G,ZTSK,ZTIO S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOMGCM1",19,0)
 Q
"RTN","PSOMGCM1",20,0)
P S DIK="^PS(59.12," F DA=SDT-1:0 S DA=$O(^PS(59.12,DA)) Q:'DA!(DA>EDT)  D ^DIK
"RTN","PSOMGCM1",21,0)
 K DIK Q
"RTN","PSOMGCM1",22,0)
TSK ;initialize nightly mgmt. compile job
"RTN","PSOMGCM1",23,0)
 D SETUP1^PSOAUTOC
"RTN","PSOMGCM1",24,0)
 W ! K DIR S DIR("B")="NO",DIR(0)="Y",DIR("A")="Do you want to compile data prior to yesterday" D ^DIR I 'Y!($D(DIRUT)) G EX
"RTN","PSOMGCM1",25,0)
 D RECOM
"RTN","PSOMGCM1",26,0)
EX K DIR,X,Y
"RTN","PSOMGCM1",27,0)
 Q
"RTN","PSOMGCM1",28,0)
TASK ;compile every night
"RTN","PSOMGCM1",29,0)
 S X1=DT,X2=-1 D C^%DTC S (EDT,SDT)=X K X1,X2 D BEG
"RTN","PSOMGCM1",30,0)
 Q
"RTN","PSOMGCM1",31,0)
QUE S ZTDTH=$H+1_",3600",ZTIO="",ZTRTN="TASK^PSOMGCM1",ZTDESC="Outpatient Pharmacy Daily Compile of Management Data",ZTIO=""
"RTN","PSOMGCM1",32,0)
 D ^%ZTLOAD W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",! K DAY,SDT,EDT,G,ZTSK,ZTIO S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOMGCM1",33,0)
 Q
"RTN","PSOMGCM1",34,0)
DAY ;recompile by day
"RTN","PSOMGCM1",35,0)
 W ! S %DT(0)=-DT,%DT("A")="Date: " S %DT="EPXA" D ^%DT G:"^"[X END G DAY:'Y S (SDT,EDT)=Y K %DT(0) S COM=1 W !
"RTN","PSOMGCM1",36,0)
 G Q
"RTN","PSOMGCM1",37,0)
RECOM ;recompile data for a date range
"RTN","PSOMGCM1",38,0)
 W ! S %DT(0)=-DT,%DT("A")="Starting date: " S %DT="EPXA" D ^%DT G:"^"[X END G RECOM:'Y S SDT=Y K %DT(0)
"RTN","PSOMGCM1",39,0)
REDT W ! S %DT(0)=SDT,%DT("A")="  Ending date: " D ^%DT G:"^"[X END I Y<0!(Y>DT) W " ??" G REDT
"RTN","PSOMGCM1",40,0)
 S EDT=Y S COM="R" W !
"RTN","PSOMGCM1",41,0)
Q S ZTDTH="",ZTRTN="BEG^PSOMGCM1",ZTDESC="Outpatient Pharmacy Management Data Recompile "_$S(COM:"One Day",1:"Range of Days"),ZTIO="" F G="SDT","EDT" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOMGCM1",42,0)
 D ^%ZTLOAD W:$D(ZTSK) !!,"Task Queued !",! K SDT,EDT,G,ZTSK,ZTIO S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOMGCM1",43,0)
 Q
"RTN","PSOMGCM1",44,0)
BEG S DIK="^PS(59.12,",DA=SDT-1 F  S DA=$O(^PS(59.12,DA)) Q:'DA!(DA>EDT)  D ^DIK
"RTN","PSOMGCM1",45,0)
 K DA,DIK F NDT=SDT:1:EDT D BEG1
"RTN","PSOMGCM1",46,0)
 D FBA G END
"RTN","PSOMGCM1",47,0)
 Q
"RTN","PSOMGCM1",48,0)
 ;PSO*198 seed loop to previous day @ time 999999
"RTN","PSOMGCM1",49,0)
BEG1 K ^TMP($J) D CLE^PSOMGCOM F TY="AL","AM" S PDATE=NDT-1+.999999 F  S PDATE=$O(^PSRX(TY,PDATE)) Q:'PDATE!(PDATE>(NDT_".999999"))  D BEG2
"RTN","PSOMGCM1",50,0)
 S PDATE=NDT D:TFIL ADD,BUILD^PSOMGCOM
"RTN","PSOMGCM1",51,0)
 Q 
"RTN","PSOMGCM1",52,0)
BEG2 S REC=0 F  S REC=$O(^PSRX(TY,PDATE,REC)) Q:'REC  D BEG3
"RTN","PSOMGCM1",53,0)
 Q
"RTN","PSOMGCM1",54,0)
BEG3 Q:'$D(^PSRX(REC,0))  S DA="" F  S DA=$O(^PSRX(TY,PDATE,REC,DA)) Q:DA=""  D
"RTN","PSOMGCM1",55,0)
 .S RX0=^PSRX(REC,0),DFN=$P(RX0,"^",2),ST=$P(RX0,"^",3),PHYS=$P(RX0,"^",4),DRUG=$P(RX0,"^",6),DAYS=$P(RX0,"^",8)
"RTN","PSOMGCM1",56,0)
 .Q:'DFN!('DRUG)  D:TY="AL" COM1^PSOMGCOM D:TY="AM" COM2
"RTN","PSOMGCM1",57,0)
 Q
"RTN","PSOMGCM1",58,0)
COM2 Q:'$P($G(^PSRX(REC,"P",DA,0)),"^",19)
"RTN","PSOMGCM1",59,0)
 S RXF=^PSRX(REC,"P",DA,0),DV=$S($P(RXF,"^",9):$P(RXF,"^",9),1:$O(^PS(59,0))),REF(DV)=REF(DV)+1 S:$P(RXF,"^",2)="W" WIND(DV)=WIND(DV)+1 S:$P(RXF,"^",2)="M" MAIL(DV)=MAIL(DV)+1 S DATE=$P(^PSRX(REC,"P",0),"^")-.01
"RTN","PSOMGCM1",60,0)
 S COST=$P(RXF,"^",4)*$S($P(RXF,"^",11):$P(RXF,"^",11),1:+$P($G(^PSDRUG(+$P(^PSRX(REC,0),"^",6),660)),"^",6))
"RTN","PSOMGCM1",61,0)
 D DAYS^PSOMGCOM,STA^PSOMGCOM
"RTN","PSOMGCM1",62,0)
 Q
"RTN","PSOMGCM1",63,0)
FBA S (STN,DV)=0 S:'$G(DT) DT=$$DT^XLFDT
"RTN","PSOMGCM1",64,0)
 F  S DV=$O(^PS(59,DV)) Q:'DV  D  Q:STN
"RTN","PSOMGCM1",65,0)
 .I '$G(^PS(59,DV,"I"))!(DT'>$G(^PS(59,DV,"I"))) S STN=$P(^("INI"),"^"),STN=+$$GET1^DIQ(4,STN,99)
"RTN","PSOMGCM1",66,0)
 I 'STN S PP="Invalid Related Institution in File #59" G MAIL
"RTN","PSOMGCM1",67,0)
 F PDATE=SDT:1:EDT S PP=$$RXSUM^FBRXUTL(PDATE,STN) Q:+PP<0  D:+PP>0
"RTN","PSOMGCM1",68,0)
 .S PPCOST=$P(PP,"^",2),PP=+PP D SET
"RTN","PSOMGCM1",69,0)
 I +PP<0 S PP=$P(PP,"^",3) G MAIL
"RTN","PSOMGCM1",70,0)
 Q
"RTN","PSOMGCM1",71,0)
MAIL F PSO1=0:0 S PSO1=$O(^XUSEC("PSORPH",PSO1)) Q:'PSO1  S XMY(PSO1)=""
"RTN","PSOMGCM1",72,0)
 Q:$O(XMY(""))=""
"RTN","PSOMGCM1",73,0)
 S XMDUZ="Outpatient Pharmacy Package"
"RTN","PSOMGCM1",74,0)
 S XMSUB="FEE Basis Cost Data - Incomplete Nightly Job"
"RTN","PSOMGCM1",75,0)
 S PP=$E(PP_".                              ",1,42)
"RTN","PSOMGCM1",76,0)
 S PSO(1)="**************************************************"
"RTN","PSOMGCM1",77,0)
 S PSO(2)="*** FEE Basis Cost data was not collected for  ***"
"RTN","PSOMGCM1",78,0)
 S PSO(3)="*** the period "_$E(SDT,4,5)_"/"_$E(SDT,6,7)_"/"_$E(SDT,2,3)_" to "_$E(EDT,4,5)_"/"_$E(EDT,6,7)_"/"_$E(EDT,2,3)_".           ***"
"RTN","PSOMGCM1",79,0)
 S PSO(4)="***                                            ***"
"RTN","PSOMGCM1",80,0)
 S PSO(5)="*** The reason reported was:                   ***"
"RTN","PSOMGCM1",81,0)
 S PSO(6)="*** "_PP_" ***"
"RTN","PSOMGCM1",82,0)
 S PSO(7)="***                                            ***"
"RTN","PSOMGCM1",83,0)
 S PSO(8)="*** You may have to manually recompile this    ***"
"RTN","PSOMGCM1",84,0)
 S PSO(9)="*** data at a later date.                      ***"
"RTN","PSOMGCM1",85,0)
 S PSO(10)="**************************************************"
"RTN","PSOMGCM1",86,0)
 S XMTEXT="PSO(" N DIFROM D ^XMD K XMSUB,XMDUZ,XMTEXT,PSO,PSO1
"RTN","PSOMGCM1",87,0)
 Q
"RTN","PSOMGCM1",88,0)
SET I '$D(^PS(59.12,PDATE,0)) D ADD S DV=0 F  S DV=$O(^PS(59,DV)) Q:'+DV  D
"RTN","PSOMGCM1",89,0)
 .S ^PS(59.12,PDATE,1,DV,0)=DV_"^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0^0",^PS(59.12,PDATE,2,DV,0)=DV_"^0^0^0^0^0^0^0^0^0^0^0^0^0.0",^PS(59.12,PDATE,3,DV,0)=DV_"^0.00^0.00^0.00^0.00^0.00^0.00^0.00^0.00^0.00"
"RTN","PSOMGCM1",90,0)
 S DV=0,DV=$O(^PS(59,DV)),$P(^PS(59.12,PDATE,2,DV,0),"^",13)=PP,FEE=0
"RTN","PSOMGCM1",91,0)
 F DIV=0:0 S DIV=$O(^PS(59.12,PDATE,2,DIV)) Q:'+DIV  S FEE=FEE+$P(^PS(59.12,PDATE,2,DIV,0),"^",3)
"RTN","PSOMGCM1",92,0)
 S $P(^PS(59.12,PDATE,2,DV,0),"^",14)=$FN($S(FEE=0:100.0,$P(^PS(59.12,PDATE,2,DV,0),"^",13)=0:0,1:(FEE/(FEE+$P(^PS(59.12,$P(PDATE,"."),2,DV,0),"^",13)))*100),"",1)
"RTN","PSOMGCM1",93,0)
 S $P(^PS(59.12,PDATE,3,DV,0),"^",9)=$FN(PPCOST,"",2),$P(^PS(59.12,PDATE,3,DV,0),"^",10)=$FN($S(PPCOST=0!(PP=0):0,1:PPCOST/PP),"",2)
"RTN","PSOMGCM1",94,0)
 Q
"RTN","PSOMGCM1",95,0)
ADD S (X,DINUM)=PDATE,DIC="^PS(59.12,",DIC(0)="L" K DD,DO D FILE^DICN F DV=0:0 S DV=$O(^PS(59,DV)) Q:'+DV  D ADDEM
"RTN","PSOMGCM1",96,0)
 Q
"RTN","PSOMGCM1",97,0)
ADDEM S ^PS(59.12,PDATE,1,0)="^59.121A^"_DV_"^"_TFIL,^PS(59.12,PDATE,1,DV,0)=DV,^PS(59.12,PDATE,1,"B",DV,DV)=""
"RTN","PSOMGCM1",98,0)
 S ^PS(59.12,PDATE,2,0)="^59.122A^"_DV_"^"_TFTY,^PS(59.12,PDATE,2,DV,0)=DV,^PS(59.12,PDATE,2,"B",DV,DV)=""
"RTN","PSOMGCM1",99,0)
 S ^PS(59.12,PDATE,3,0)="^59.123A^"_DV_"^"_TFCT,^PS(59.12,PDATE,3,DV,0)=DV,^PS(59.12,PDATE,3,"B",DV,DV)=""
"RTN","PSOMGCM1",100,0)
 Q
"VER")
8.0^22.0
"BLD",1096,6)
^SEQ #189
**END**
**END**
