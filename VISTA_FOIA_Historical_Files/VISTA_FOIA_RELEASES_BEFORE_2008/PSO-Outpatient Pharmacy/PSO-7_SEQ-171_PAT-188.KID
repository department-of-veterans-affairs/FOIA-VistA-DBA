EMERGENCY Released PSO*7*188 SEQ #171
Extracted from mail message
**KIDS**:PSO*7.0*188^

**INSTALL NAME**
PSO*7.0*188
"BLD",1058,0)
PSO*7.0*188^OUTPATIENT PHARMACY^0^3041015^y
"BLD",1058,1,0)
^^10^10^3041012^
"BLD",1058,1,1,0)
 During order entry in backdoor Outpatient Pharmacy, Order checks are
"BLD",1058,1,2,0)
 not being performed on Non-VA medications if other medications exist.
"BLD",1058,1,3,0)
 The possibility also exists that when a 'critical interaction'
"BLD",1058,1,4,0)
 exists and is displayed, this critical interaction could be displayed
"BLD",1058,1,5,0)
 for subsequent orders even though a 'critical interaction' does not
"BLD",1058,1,6,0)
 exist on the order currently being entered.
"BLD",1058,1,7,0)
 
"BLD",1058,1,8,0)
 When entering an order via backdoor Outpatient Pharmacy or CPRS, a
"BLD",1058,1,9,0)
 critical interaction could be skipped if a significant interaction
"BLD",1058,1,10,0)
 exists for the same drugs.
"BLD",1058,4,0)
^9.64PA^^
"BLD",1058,"ABPKG")
n
"BLD",1058,"KRN",0)
^9.67PA^8989.52^19
"BLD",1058,"KRN",.4,0)
.4
"BLD",1058,"KRN",.401,0)
.401
"BLD",1058,"KRN",.402,0)
.402
"BLD",1058,"KRN",.403,0)
.403
"BLD",1058,"KRN",.5,0)
.5
"BLD",1058,"KRN",.84,0)
.84
"BLD",1058,"KRN",3.6,0)
3.6
"BLD",1058,"KRN",3.8,0)
3.8
"BLD",1058,"KRN",9.2,0)
9.2
"BLD",1058,"KRN",9.8,0)
9.8
"BLD",1058,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",1058,"KRN",9.8,"NM",1,0)
PSODGDGI^^0^B48760476
"BLD",1058,"KRN",9.8,"NM",2,0)
PSOORDRG^^0^B39186292
"BLD",1058,"KRN",9.8,"NM","B","PSODGDGI",1)

"BLD",1058,"KRN",9.8,"NM","B","PSOORDRG",2)

"BLD",1058,"KRN",19,0)
19
"BLD",1058,"KRN",19.1,0)
19.1
"BLD",1058,"KRN",101,0)
101
"BLD",1058,"KRN",409.61,0)
409.61
"BLD",1058,"KRN",771,0)
771
"BLD",1058,"KRN",870,0)
870
"BLD",1058,"KRN",8989.51,0)
8989.51
"BLD",1058,"KRN",8989.52,0)
8989.52
"BLD",1058,"KRN",8994,0)
8994
"BLD",1058,"KRN","B",.4,.4)

"BLD",1058,"KRN","B",.401,.401)

"BLD",1058,"KRN","B",.402,.402)

"BLD",1058,"KRN","B",.403,.403)

"BLD",1058,"KRN","B",.5,.5)

"BLD",1058,"KRN","B",.84,.84)

"BLD",1058,"KRN","B",3.6,3.6)

"BLD",1058,"KRN","B",3.8,3.8)

"BLD",1058,"KRN","B",9.2,9.2)

"BLD",1058,"KRN","B",9.8,9.8)

"BLD",1058,"KRN","B",19,19)

"BLD",1058,"KRN","B",19.1,19.1)

"BLD",1058,"KRN","B",101,101)

"BLD",1058,"KRN","B",409.61,409.61)

"BLD",1058,"KRN","B",771,771)

"BLD",1058,"KRN","B",870,870)

"BLD",1058,"KRN","B",8989.51,8989.51)

"BLD",1058,"KRN","B",8989.52,8989.52)

"BLD",1058,"KRN","B",8994,8994)

"BLD",1058,"QUES",0)
^9.62^^
"BLD",1058,"REQB",0)
^9.611^1^1
"BLD",1058,"REQB",1,0)
PSO*7.0*132^2
"BLD",1058,"REQB","B","PSO*7.0*132",1)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
7.0^3011218^2980805^5
"PKG",16,22,1,"PAH",1,0)
188^3041015
"PKG",16,22,1,"PAH",1,1,0)
^^10^10^3041015
"PKG",16,22,1,"PAH",1,1,1,0)
 During order entry in backdoor Outpatient Pharmacy, Order checks are
"PKG",16,22,1,"PAH",1,1,2,0)
 not being performed on Non-VA medications if other medications exist.
"PKG",16,22,1,"PAH",1,1,3,0)
 The possibility also exists that when a 'critical interaction'
"PKG",16,22,1,"PAH",1,1,4,0)
 exists and is displayed, this critical interaction could be displayed
"PKG",16,22,1,"PAH",1,1,5,0)
 for subsequent orders even though a 'critical interaction' does not
"PKG",16,22,1,"PAH",1,1,6,0)
 exist on the order currently being entered.
"PKG",16,22,1,"PAH",1,1,7,0)
 
"PKG",16,22,1,"PAH",1,1,8,0)
 When entering an order via backdoor Outpatient Pharmacy or CPRS, a
"PKG",16,22,1,"PAH",1,1,9,0)
 critical interaction could be skipped if a significant interaction
"PKG",16,22,1,"PAH",1,1,10,0)
 exists for the same drugs.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSODGDGI")
0^1^B48760476
"RTN","PSODGDGI",1,0)
PSODGDGI ;BIR/SAB - drug drug interaction checker ;4/14/93
"RTN","PSODGDGI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,27,48,130,144,132,188**;DEC 1997
"RTN","PSODGDGI",3,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSODGDGI",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODGDGI",5,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODGDGI",6,0)
 ;External reference to DDIEX^PSNAPIS supported by DBIA 2574
"RTN","PSODGDGI",7,0)
 Q:$$DDIEX^PSNAPIS($P(PSODRUG("NDF"),"A"),$P(PSODRUG("NDF"),"A",2))
"RTN","PSODGDGI",8,0)
 N PSOICT S (CRIT,DRG,LSI,DGI,DGS,SER,SERS,STA,PSOICT)=""
"RTN","PSODGDGI",9,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""!($G(PSORX("DFLG")))  F  S DRG=$O(PSOSD(STA,DRG)) Q:DRG=""!($G(PSORX("DFLG")))  I $P(PSOSD(STA,DRG),"^",2)<10 D
"RTN","PSODGDGI",10,0)
 .Q:$P(PSOSD(STA,DRG),"^",7)']""
"RTN","PSODGDGI",11,0)
 .S NDF=$P(PSOSD(STA,DRG),"^",7)
"RTN","PSODGDGI",12,0)
 .;New logic to Loop All interactions and filter-up a critical if it exists
"RTN","PSODGDGI",13,0)
 .S IT=0,PSOICT=""
"RTN","PSODGDGI",14,0)
 .F  S IT=$O(^PS(56,"APD",NDF,PSODRUG("NDF"),IT)) Q:'IT  D
"RTN","PSODGDGI",15,0)
 ..Q:$$DDIEX^PSNAPIS($P(NDF,"A"),$P(NDF,"A",2))
"RTN","PSODGDGI",16,0)
 ..Q:$P(^PS(56,IT,0),"^",7)&($P(^PS(56,IT,0),"^",7)<DT)
"RTN","PSODGDGI",17,0)
 ..I 'PSOICT S PSOICT=IT Q
"RTN","PSODGDGI",18,0)
 ..I $P($G(^PS(56,IT,0)),"^",4)=1 S PSOICT=IT Q
"RTN","PSODGDGI",19,0)
 ..Q
"RTN","PSODGDGI",20,0)
 .I 'PSOICT Q
"RTN","PSODGDGI",21,0)
 .S IT=PSOICT
"RTN","PSODGDGI",22,0)
 .I STA="ZNONVA" S DNM=DRG D NVA^PSODRDU1 K DNM,IT,PSOICT Q
"RTN","PSODGDGI",23,0)
 .D BLD Q:+$G(PSORX("DFLG"))
"RTN","PSODGDGI",24,0)
 .Q
"RTN","PSODGDGI",25,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(DGI)]"" S:+CRIT PSONEW("STATUS")=4 W $C(7),!,"DRUG INTERACTON WITH RX #s: "_LSI,! K LSI,DRG,IT,NDF,PSOICT
"RTN","PSODGDGI",26,0)
 Q
"RTN","PSODGDGI",27,0)
TECH ;add tech entry to RX VERIFY file (#52.4)
"RTN","PSODGDGI",28,0)
 I +CRIT S PSODI=1,DIC="^PS(52.4,",DLAYGO=52.4,DIC(0)="L",(DINUM,X)=PSOX("IRXN"),DIC("DR")="1////"_PSODFN_";2////"_DUZ_";4///"_DT_";7///"_1_";7.1///"_SER_";7.2///"_DGI K DD,DO D FILE^DICN K DD,DO
"RTN","PSODGDGI",29,0)
 S:$G(DGS)'="" $P(^PSRX(PSOX("IRXN"),"DRI"),"^")=SERS,$P(^PSRX(PSOX("IRXN"),"DRI"),"^",2)=DGS  K PSODI,CRIT,DIC,DLAYGO,DINUM,DGI,DGS,SER,SERS Q
"RTN","PSODGDGI",30,0)
BLD I $D(^XUSEC("PSORPH",DUZ)) S PSORX("PHARM")=DUZ D PHARM Q
"RTN","PSODGDGI",31,0)
 S LSI=$P(^PSRX(+PSOSD(STA,DRG),0),"^")_"/"_$P(^PSDRUG($P(^(0),"^",6),0),"^")_","_LSI,DGI=$P(PSOSD(STA,DRG),"^")_","_DGI,SER=IT_","_SER I $P(PSOSD(STA,DRG),"^",9),$P(^PS(56,IT,0),"^",4)=1 S $P(^PSRX(+PSOSD(STA,DRG),"STA"),"^")=4
"RTN","PSODGDGI",32,0)
 I $P(^PS(56,IT,0),"^",4)=2 S SERS=IT_","_SERS,DGS=$P(PSOSD(STA,DRG),"^")_","_DGS
"RTN","PSODGDGI",33,0)
 S:$P(^PS(56,IT,0),"^",4)=1 CRIT=1 Q
"RTN","PSODGDGI",34,0)
PHARM ;pharmacist verification of drug interaction
"RTN","PSODGDGI",35,0)
 D PSOL^PSSLOCK($P(PSOSD(STA,DRG),"^")) I '$G(PSOMSG) D  K PSOMSG S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODGDGI",36,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2) D  Q
"RTN","PSODGDGI",37,0)
 ..W !,"Rx: "_$P($G(^PSRX($P(PSOSD(STA,DRG),"^"),0)),"^")_"    Drug: "_$P($G(^PSDRUG(+$P($G(^(0)),"^",6),0)),"^")
"RTN","PSODGDGI",38,0)
 ..W !,"which interacts with the drug you are entering!",!
"RTN","PSODGDGI",39,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX($P(PSOSD(STA,DRG),"^"),0)),"^")_",",!,"which interacts with the drug you are entering!",!
"RTN","PSODGDGI",40,0)
 S PSODGRLX=$P(PSOSD(STA,DRG),"^")
"RTN","PSODGDGI",41,0)
 S SER=^PS(56,IT,0),DIR("?",1)="Answer 'YES' if you DO want to "_$S($P(SER,"^",4)=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGI",42,0)
 S DIR("?")="       'NO' if you DON'T want to "_$S($P(SER,"^",4)=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGI",43,0)
 W $C(7),$C(7) S DIR("A",1)="***"_$S($P(SER,"^",4)=1:"CRITICAL",1:"SIGNIFICANT")_"*** "_"Drug Interaction with RX #"_$P(^PSRX($P(PSOSD(STA,DRG),"^"),0),"^"),DIR("A",2)="DRUG: "_$P(DRG,"^")
"RTN","PSODGDGI",44,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to "_$S($P(SER,"^",4)=1:"Continue? ",1:"Intervene? "),DIR("B")="Y" D ^DIR
"RTN","PSODGDGI",45,0)
 I 'Y,$P(SER,"^",4)=1 S PSORX("DFLG")=1,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODGDGI",46,0)
 I Y,$P(SER,"^",4)=1 S PSORX("INTERVENE")=1,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT G CRI Q
"RTN","PSODGDGI",47,0)
 I 'Y,$P(SER,"^",4)=2 K DIR,DTOUT,DIRUT,DIROUT,DUOUT D ULRX Q
"RTN","PSODGDGI",48,0)
 I Y,$P(SER,"^",4)=2 S PSORX("INTERVENE")=2,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODGDGI",49,0)
 D ULRX
"RTN","PSODGDGI",50,0)
 Q
"RTN","PSODGDGI",51,0)
CRI ;process new drug interactions entered by pharmacist
"RTN","PSODGDGI",52,0)
 K DIR G:$P(PSOSD(STA,DRG),"^",9) CRITN S DIR("A",1)="",DIR("A",2)="Do you want to Process medication",DIR("A")=PSODRUG("NAME")_": ",DIR(0)="SA^1:PROCESS;0:ABORT ORDER ENTRY",DIR("B")="P"
"RTN","PSODGDGI",53,0)
 S DIR("?",1)="Enter '1' or 'P' to Activate medication",DIR("?")="      '0' or 'A' to Abort Order Entry process" D ^DIR K X1,DIR I 'Y S PSORX("DFLG")=1,DGI="" K DTOUT,DIRUT,DIROUT,DUOUT,PSORX("INTERVENE") D ULRX Q
"RTN","PSODGDGI",54,0)
 I $P(SER,"^",4)=1 D
"RTN","PSODGDGI",55,0)
 .D SIG^XUSESIG I X1="" K PSORX("INTERVENE") S PSORX("DFLG")=1 Q
"RTN","PSODGDGI",56,0)
 .S PSORX("INTERVENE")=$P(SER,"^",4)
"RTN","PSODGDGI",57,0)
 K DUOUT,DTOUT,DIRUT,DIROUT D ULRX Q
"RTN","PSODGDGI",58,0)
CRITN ;process multiple new drug interactions
"RTN","PSODGDGI",59,0)
 K X1,DIR S DIR("A",1)="",DIR("A",2)="Do you want to: ",DIR("A",3)=" 1.  Delete NEW medication "_PSODRUG("NAME"),DIR("A",4)=" 2.  Cancel ACTIVE New Rx #"_$P(^PSRX($P(PSOSD(STA,DRG),"^"),0),"^")_" DRUG: "_$P(DRG,"^")
"RTN","PSODGDGI",60,0)
 S DIR("A",5)=" 3.  Delete 1 and Cancel 2",DIR("A")=" 4.  Continue ?: ",DIR(0)="SA^1:NEW MEDICATION;2:ACTIVE New Rx "_$P(DRG,"^")_";3:BOTH;4:CONTINUE"
"RTN","PSODGDGI",61,0)
 S DIR("?",1)="Enter '1' or 'N' to Delete New Medication and Dispense Rx #"_$P(^PSRX(+PSOSD(STA,DRG),0),"^")
"RTN","PSODGDGI",62,0)
 S DIR("?",2)="      '2' or 'A' to Cancel Active Rx #"_$P(^PSRX(+PSOSD(STA,DRG),0),"^")_" and Dispense New Rx"
"RTN","PSODGDGI",63,0)
 S DIR("?",3)="      '3' or 'B' to Delete 1 and Cancel 2",DIR("?")="      '4' or 'C' to do nothing to either Rx" D ^DIR K DIR
"RTN","PSODGDGI",64,0)
 I Y=1 S PSORX("DFLG")=1,DGI="",PSHLDDRG=PSODRUG("IEN") D  D ULRX Q
"RTN","PSODGDGI",65,0)
 .I $G(PSORXED) D  Q
"RTN","PSODGDGI",66,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) W $C(7)," ACTION NOT TAKEN!",! S PSORX("DFLG")=1 K PSORX("INTERVENE") Q
"RTN","PSODGDGI",67,0)
 ..S DA=$P(PSOLST(ORN),"^",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGI",68,0)
 ..K PSOSD($P(PSOLST(ORN),"^",3),PSODRUG("NAME")),DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGI",69,0)
 .S PSODRUG("IEN")=$P(^PSRX($P(PSOSD(STA,DRG),"^"),0),"^",6) D FULL^VALM1,^PSORXI
"RTN","PSODGDGI",70,0)
 .S PSODRUG("IEN")=PSHLDDRG,VALMBCK="R"
"RTN","PSODGDGI",71,0)
 .K DTOUT,DIRUT,DIROUT,DUOUT,PSHLDDRG
"RTN","PSODGDGI",72,0)
 .I $G(OR0) D
"RTN","PSODGDGI",73,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGI",74,0)
 ...W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGI",75,0)
 ..D DC^PSOORFI2
"RTN","PSODGDGI",76,0)
 I Y=2 S (DA,PSOHOLDA)=+PSOSD(STA,DRG) D  D ULRX Q
"RTN","PSODGDGI",77,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGI",78,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGI",79,0)
 .D MESS,ENQ^PSORXDL
"RTN","PSODGDGI",80,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL
"RTN","PSODGDGI",81,0)
 .K PSOSD(STA,DRG),DTOUT,DIROUT,DIRUT,DUOUT,PSOHOLDA
"RTN","PSODGDGI",82,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S VALMBCK="R"
"RTN","PSODGDGI",83,0)
 I Y=3 S (DA,PSOHOLDA)=+PSOSD(STA,DRG) D  S VALMBCK="R"
"RTN","PSODGDGI",84,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGI",85,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGI",86,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S PSORX("DFLG")=1 D MESS,ENQ^PSORXDL
"RTN","PSODGDGI",87,0)
 .I $G(OR0) D DC^PSOORFI2
"RTN","PSODGDGI",88,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL K PSOSD(STA,DRG),PSOHOLDA
"RTN","PSODGDGI",89,0)
 .I $G(PSORXED) D
"RTN","PSODGDGI",90,0)
 ..S DA=$P(PSOLST(ORN),"^",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGI",91,0)
 ..K PSOSD($P(PSOLST(ORN),"^",3),PSODRUG("NAME")),DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGI",92,0)
 K DTOUT,DIROUT,DIRUT,DUOUT
"RTN","PSODGDGI",93,0)
 D ULRX
"RTN","PSODGDGI",94,0)
 Q
"RTN","PSODGDGI",95,0)
MESS W !!,"Canceling Rx: "_$P($G(^PSRX(DA,0)),"^")_"   "_"Drug: "_$P($G(^PSDRUG($P(^PSRX(DA,0),"^",6),0)),"^"),! Q
"RTN","PSODGDGI",96,0)
PPL F PSOSL=0:0 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  S PSOX2=PSOSL
"RTN","PSODGDGI",97,0)
 I $G(PSOX2) D
"RTN","PSODGDGI",98,0)
 .F PSOSL=0:1:PSOX2 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  F ENT=1:1:$L(PSORX("PSOL",PSOSL),",") I $P(PSORX("PSOL",PSOSL),",",ENT)=$P(PSOSD(STA,DRG),"^") S PSOL(PSOSL,ENT)=""
"RTN","PSODGDGI",99,0)
 .F PSOL=0:0 S PSOL=$O(PSOL(PSOL)) Q:'PSOL  F ENT=0:0 S ENT=$O(PSOL(PSOL,ENT)) Q:'ENT  D
"RTN","PSODGDGI",100,0)
 ..I ENT=1,'$P(PSORX("PSOL",PSOL),",",2) K PSORX("PSOL",PSOL) Q
"RTN","PSODGDGI",101,0)
 ..I ENT=1,$P(PSORX("PSOL",PSOL),",",2) S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",2,99) Q
"RTN","PSODGDGI",102,0)
 ..S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",1,ENT-1)_","_$P(PSORX("PSOL",PSOL),",",ENT+1,99)
"RTN","PSODGDGI",103,0)
 K PSOX2,PSOSL,PSOL,ENT Q
"RTN","PSODGDGI",104,0)
ULRX ;
"RTN","PSODGDGI",105,0)
 I '$G(PSODGRLX) Q
"RTN","PSODGDGI",106,0)
 D PSOUL^PSSLOCK(PSODGRLX) K PSODGRLX
"RTN","PSODGDGI",107,0)
 Q
"RTN","PSOORDRG")
0^2^B39186292
"RTN","PSOORDRG",1,0)
PSOORDRG ;BIR/SAB - order entry drug selection ;11/13/97
"RTN","PSOORDRG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,29,49,46,81,105,134,144,132,188**;DEC 1997
"RTN","PSOORDRG",3,0)
 ;External references to ^PSJORUT2 supported by DBIA 2376
"RTN","PSOORDRG",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORDRG",5,0)
 ;External reference to ^PS(50.605 supported by DBIA 696
"RTN","PSOORDRG",6,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORDRG",7,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORDRG",8,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOORDRG",9,0)
 ;External reference to ^PS(50.416 supported by DBIA 692
"RTN","PSOORDRG",10,0)
 ;External reference to DDIEX^PSNAPIS supported by DBIA 2574
"RTN","PSOORDRG",11,0)
EN(PSODFN,DREN) ;
"RTN","PSOORDRG",12,0)
 K ^TMP($J,"DI"),^TMP($J,"DD"),^TMP($J,"DC"),PSOPHI S INDX=0
"RTN","PSOORDRG",13,0)
 ;build patient's drug profile outpat/inpat/non-va
"RTN","PSOORDRG",14,0)
 D BLD,ENCHK^PSJORUT2(PSODFN,.INDX),NVA
"RTN","PSOORDRG",15,0)
 ;collect drug info
"RTN","PSOORDRG",16,0)
DRG ;S X=DREN,DIC="^PSDRUG(",DIC(0)="MQNZO" D ^DIC K DIC,PSOY Q:Y<1  S PSOY=Y,PSOY(0)=Y(0) K X,Y
"RTN","PSOORDRG",17,0)
 N PSOICT S PSOICT=""
"RTN","PSOORDRG",18,0)
 S PSOY=DREN_"^"_$P($G(^PSDRUG(DREN,0)),"^"),PSOY(0)=$G(^PSDRUG(DREN,0)) K X,Y
"RTN","PSOORDRG",19,0)
 S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2),PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSOORDRG",20,0)
 S:+$G(^PSDRUG(+PSOY,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSOORDRG",21,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORDRG",22,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOORDRG",23,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5),PSODRUG("NDC")=$P($G(^PSDRUG(+PSOY,2)),"^",4)
"RTN","PSOORDRG",24,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660)),PSODRUG("COST")=$P($G(PSOX1),"^",6),PSODRUG("UNIT")=$P($G(PSOX1),"^",8),PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSOORDRG",25,0)
 K PSOX1,PSOY Q:$G(POERR)
"RTN","PSOORDRG",26,0)
 ;dup drug/class check
"RTN","PSOORDRG",27,0)
 S DNM=0 F  S DNM=$O(^TMP($J,"ORDERS",DNM)) Q:'DNM  D
"RTN","PSOORDRG",28,0)
 .S DRNM=$P(^TMP($J,"ORDERS",DNM),"^",3)
"RTN","PSOORDRG",29,0)
 .I PSODRUG("NAME")=DRNM S DD=$G(DD)+1,^TMP($J,"DD",DD,0)=PSODRUG("IEN")_"^"_PSODRUG("NAME")_"^"_$P(^TMP($J,"ORDERS",DNM),"^",4)_"^"_$P(^(DNM),"^",5) Q:'$G(PSOPHI)
"RTN","PSOORDRG",30,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(^TMP($J,"ORDERS",DNM),"^"),1,4),DRNM'=PSODRUG("NAME") D
"RTN","PSOORDRG",31,0)
 ..I $E(PSODRUG("VA CLASS"),1,2)="HA",$E($P(^TMP($J,"ORDERS",DNM),"^"),1,2)="HA" Q
"RTN","PSOORDRG",32,0)
 ..S PSODC=$O(^PS(50.605,"B",PSODRUG("VA CLASS"),0)) Q:'PSODC
"RTN","PSOORDRG",33,0)
 ..S DC=$G(DC)+1,^TMP($J,"DC",DC,0)=PSODRUG("VA CLASS")
"RTN","PSOORDRG",34,0)
 ..S PSODC=$P(^PS(50.605,PSODC,0),"^",2),^TMP($J,"DC",DC,0)=^TMP($J,"DC",DC,0)_"^"_PSODC_"^"_$O(^PSDRUG("B",DRNM,0))_"^"_DRNM_"^"_$P(^TMP($J,"ORDERS",DNM),"^",4)_"^"_$P(^(DNM),"^",5)
"RTN","PSOORDRG",35,0)
 ;drug interaction check
"RTN","PSOORDRG",36,0)
 S DRG=0
"RTN","PSOORDRG",37,0)
 F  S DRG=$O(^TMP($J,"ORDERS",DRG)) Q:'DRG  S NDF=$P(^TMP($J,"ORDERS",DRG),"^",2) D
"RTN","PSOORDRG",38,0)
 .S IT=0,PSOICT=""
"RTN","PSOORDRG",39,0)
 .F  S IT=$O(^PS(56,"APD",NDF,PSODRUG("NDF"),IT)) Q:'IT  D
"RTN","PSOORDRG",40,0)
 ..Q:$$DDIEX^PSNAPIS($P(NDF,"A"),$P(NDF,"A",2))
"RTN","PSOORDRG",41,0)
 ..Q:$$DDIEX^PSNAPIS($P(PSODRUG("NDF"),"A"),$P(PSODRUG("NDF"),"A",2))
"RTN","PSOORDRG",42,0)
 ..Q:$P(^PS(56,IT,0),"^",7)&($P(^PS(56,IT,0),"^",7)<DT)
"RTN","PSOORDRG",43,0)
 ..I 'PSOICT S PSOICT=IT Q
"RTN","PSOORDRG",44,0)
 ..I $P($G(^PS(56,IT,0)),"^",4)=1 S PSOICT=IT Q
"RTN","PSOORDRG",45,0)
 ..Q
"RTN","PSOORDRG",46,0)
 .I 'PSOICT Q
"RTN","PSOORDRG",47,0)
 .S IT=PSOICT
"RTN","PSOORDRG",48,0)
 .S DRNM=$P(^TMP($J,"ORDERS",DRG),"^",3),ORN=$P(^(DRG),"^",4),RXN=$P(^(DRG),"^",5)
"RTN","PSOORDRG",49,0)
 .S DI=$G(DI)+1,^TMP($J,"DI",DI,0)=$O(^PSDRUG("B",DRNM,0))_"^"_DRNM_"^"_IT_"^"_$S($P(^PS(56,IT,0),"^",4)=1:"CRITICAL",1:"SIGNIFICANT")_"^"
"RTN","PSOORDRG",50,0)
 .S ^TMP($J,"DI",DI,0)=^TMP($J,"DI",DI,0)_$P(^PS(50.416,$P(^PS(56,IT,0),"^",2),0),"^")_"^"_$P(^PS(50.416,$P(^PS(56,IT,0),"^",3),0),"^")_"^"_ORN_"^"_RXN
"RTN","PSOORDRG",51,0)
 Q:$G(PSOPHI)
"RTN","PSOORDRG",52,0)
EXIT K ^TMP($J,"ORDERS"),DFN,DA,DNM,DUPRX0,RX,Y,ZZ,PSOCLOZ,PSOY,DRG,DNM,DD,DI,DC,IT,PSODRUG,PSOY,ORN,DRNM
"RTN","PSOORDRG",53,0)
 K PSOX,EXPDT,PSODRUG0,PSORX0,PSORX2,PSORX3,PSOST0,PSOVACL,X,Y,X1,X2,RXN
"RTN","PSOORDRG",54,0)
 Q
"RTN","PSOORDRG",55,0)
BLD K ^TMP($J,"ORDERS") I '$D(PSODFN)!('$D(DT)) G EXIT
"RTN","PSOORDRG",56,0)
 S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X D BUILD G GETX
"RTN","PSOORDRG",57,0)
 Q
"RTN","PSOORDRG",58,0)
BUILD ;build profiles
"RTN","PSOORDRG",59,0)
 S EXPDT=PSODTCUT-1,RX=0
"RTN","PSOORDRG",60,0)
 F  S EXPDT=$O(^PS(55,PSODFN,"P","A",EXPDT)) Q:'EXPDT  F  S RX=$O(^PS(55,PSODFN,"P","A",EXPDT,RX)) Q:'RX  I $D(^PSRX(RX,0)) D GET
"RTN","PSOORDRG",61,0)
 S EN=0
"RTN","PSOORDRG",62,0)
 F PSOEN=0:0 S PSOEN=$O(^PS(52.41,"AOR",PSODFN,PSOEN)) Q:'PSOEN  D
"RTN","PSOORDRG",63,0)
 .F  S EN=$O(^PS(52.41,"AOR",PSODFN,PSOEN,EN)) Q:'EN  D
"RTN","PSOORDRG",64,0)
 ..S PSOOI=^PS(52.41,EN,0) I $P(PSOOI,"^",3)'="DC"&($P(PSOOI,"^",3)'="DE") D:'$P(^PS(52.41,EN,0),"^",9) BLDOI I $P(^PS(52.41,EN,0),"^",9) S PSODD=+$P(PSOOI,"^",9) D SETTMP
"RTN","PSOORDRG",65,0)
 D BUILDX
"RTN","PSOORDRG",66,0)
 Q
"RTN","PSOORDRG",67,0)
 ;
"RTN","PSOORDRG",68,0)
BLDOI ;If no DD/non-standard dose, get all drugs for OI
"RTN","PSOORDRG",69,0)
 N PSOI S PSOI=$P(PSOOI,"^",8) Q:'PSOOI
"RTN","PSOORDRG",70,0)
 S PSODD="" F  S PSODD=$O(^PSDRUG("ASP",PSOI,PSODD)) Q:'PSODD  D SETTMP
"RTN","PSOORDRG",71,0)
 Q
"RTN","PSOORDRG",72,0)
 ;
"RTN","PSOORDRG",73,0)
SETTMP ;Create ^TMP($J,"ORDERS"
"RTN","PSOORDRG",74,0)
 Q:$P(PSOOI,"^",3)="RF"
"RTN","PSOORDRG",75,0)
 S DRG=$S(PSODD:$P($G(^PSDRUG(PSODD,0)),"^"),1:"") Q:DRG']""
"RTN","PSOORDRG",76,0)
 S INDX=$G(INDX)+1,^TMP($J,"ORDERS",INDX)=$S(PSODD:$P(^PSDRUG(PSODD,0),"^",2),1:"")_"^"_$S($G(^PSDRUG(PSODD,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)_"^"_DRG_"^"_$P(^PS(52.41,EN,0),"^")_"^"_EN_"P;O"
"RTN","PSOORDRG",77,0)
 Q
"RTN","PSOORDRG",78,0)
 ;
"RTN","PSOORDRG",79,0)
BUILDX K EN,PSOOI,PSODD,PSOEN Q
"RTN","PSOORDRG",80,0)
 ;
"RTN","PSOORDRG",81,0)
GET ;data for profiles
"RTN","PSOORDRG",82,0)
 S PSORX0=^PSRX(RX,0),PSOST0=+^("STA") Q:PSOST0>5&(PSOST0'=16)
"RTN","PSOORDRG",83,0)
 S PSORX2=$G(^PSRX(RX,2)),PSORX3=$G(^(3)),ORN=$P($G(^("OR1")),"^",2) S:PSORX3="" PSORX3=$P(PSORX2,"^",2)
"RTN","PSOORDRG",84,0)
 S PSODRUG=+$P(PSORX0,"^",6) Q:'$D(^PSDRUG(PSODRUG,0))
"RTN","PSOORDRG",85,0)
 S PSODRUG0=^PSDRUG(PSODRUG,0),PSOVACL=$P(PSODRUG0,"^",2)
"RTN","PSOORDRG",86,0)
 ;
"RTN","PSOORDRG",87,0)
 I EXPDT<DT D
"RTN","PSOORDRG",88,0)
 .N DIE,DIC,DR,DA S STAT="SC",DIE=52,DA=RX,DR="100////11" D ^DIE K DIE,DIC,DR,DA
"RTN","PSOORDRG",89,0)
 .D ECAN^PSOUTL(RX) S DA=RX
"RTN","PSOORDRG",90,0)
 .S COMM="Prescription Expired",PHARMST="ZE" D EN^PSOHLSN1(DA,STAT,PHARMST,COMM)
"RTN","PSOORDRG",91,0)
 S INDX=$G(INDX)+1
"RTN","PSOORDRG",92,0)
 S ^TMP($J,"ORDERS",INDX)=PSOVACL_"^"_$S($G(^PSDRUG(PSODRUG,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)_"^"_$P(^PSDRUG(PSODRUG,0),"^")_"^"_ORN_"^"_RX_"R;O"
"RTN","PSOORDRG",93,0)
 Q
"RTN","PSOORDRG",94,0)
GETX ;
"RTN","PSOORDRG",95,0)
 K PSOX,EXPDT,PSODRUG,PSODRUG0,PSORX0,PSORX2,PSORX3,PSOST0,PSOVACL,X,Y,X1,X2,ORN
"RTN","PSOORDRG",96,0)
 Q
"RTN","PSOORDRG",97,0)
CLOZ ;
"RTN","PSOORDRG",98,0)
 S ANQRTN=$P(^PSDRUG(PSODRUG("IEN"),"CLOZ1"),"^"),ANQX=0,P(5)=PSODRUG("IEN"),DFN=PSODFN,X=ANQRTN
"RTN","PSOORDRG",99,0)
 X ^%ZOSF("TEST") I  D @("^"_ANQRTN) S:$G(ANQX) PSORX("DFLG")=1
"RTN","PSOORDRG",100,0)
 K P(5),ANQRTN,ANQX,X
"RTN","PSOORDRG",101,0)
 Q
"RTN","PSOORDRG",102,0)
DRGCHK(PSODFN,DREN,DDRUG)    ;Only check DREN against drug in DDRG()
"RTN","PSOORDRG",103,0)
 ;* PSODFN = Patient's DFN
"RTN","PSOORDRG",104,0)
 ;* DREN   = Dispendse drug to be checked against the drug in the array
"RTN","PSOORDRG",105,0)
 ;* DDRUG  = The array of dispendse drug in the buffer.
"RTN","PSOORDRG",106,0)
 ;*
"RTN","PSOORDRG",107,0)
 K ^TMP($J,"DI"),^TMP($J,"DD"),^TMP($J,"DC")
"RTN","PSOORDRG",108,0)
 NEW DDRUG0,DDRUGND,COD,PSJINX S COD="",PSJINX=0
"RTN","PSOORDRG",109,0)
 S DDRUG=0 F  S DDRUG=$O(DDRUG(DDRUG)) Q:'DDRUG  D DDRUG^PSJORUT2
"RTN","PSOORDRG",110,0)
 D DRG
"RTN","PSOORDRG",111,0)
 Q
"RTN","PSOORDRG",112,0)
OIDRG(PSODFN,PSOI) ;checks every drug tied to orderable item passed by package use
"RTN","PSOORDRG",113,0)
 K ^TMP($J,"DI"),^TMP($J,"DD"),^TMP($J,"DC"),DD,DC,DI N DREN S INDX=0,PSOPHI=1
"RTN","PSOORDRG",114,0)
 ;build patient's drug profile inpat/outpat/non-va
"RTN","PSOORDRG",115,0)
 D BLD,ENCHK^PSJORUT2(PSODFN,.INDX),NVA
"RTN","PSOORDRG",116,0)
 F DREN=0:0 S DREN=$O(^PSDRUG("ASP",PSOI,DREN)) Q:'DREN  I $D(^PSDRUG(DREN,O)) D DRG
"RTN","PSOORDRG",117,0)
 K PSOPHI D EXIT
"RTN","PSOORDRG",118,0)
 Q
"RTN","PSOORDRG",119,0)
NVA ;checks existing nva
"RTN","PSOORDRG",120,0)
 F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",I)) Q:'I  D:$D(^PS(55,PSODFN,"NVA",I,0))
"RTN","PSOORDRG",121,0)
 .Q:$P(^PS(55,PSODFN,"NVA",I,0),"^",7)
"RTN","PSOORDRG",122,0)
 .S PSOI=$P(^PS(55,PSODFN,"NVA",I,0),"^"),DRG=$P(^(0),"^",2),ORN=$P(^(0),"^",8)
"RTN","PSOORDRG",123,0)
 .I DRG,$G(^PSDRUG(DRG,0))]"" D NVA1 K DRG Q
"RTN","PSOORDRG",124,0)
 .K DRG F DRG=0:0 S DRG=$O(^PSDRUG("ASP",PSOI,DRG)) Q:'DRG  D:$D(^PSDRUG(DRG,0)) NVA1
"RTN","PSOORDRG",125,0)
 K I,PSOOTC,ORN,PSOI,DRG,DRGN,PSOY,VACL,NDF
"RTN","PSOORDRG",126,0)
 Q
"RTN","PSOORDRG",127,0)
NVA1 S PSOY=$G(^PSDRUG(DRG,0)),DRGN=$P(PSOY,"^"),VACL=$P(PSOY,"^",2)
"RTN","PSOORDRG",128,0)
 S NDF=$S($G(^PSDRUG(DRG,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORDRG",129,0)
 S INDX=$G(INDX)+1,^TMP($J,"ORDERS",INDX)=VACL_"^"_NDF_"^"_DRGN_"^"_ORN_"^"_I_"N;O"
"RTN","PSOORDRG",130,0)
 Q
"VER")
8.0^22.0
**END**
**END**
