Released PSD*3*66 SEQ #53
Extracted from mail message
**KIDS**:PSD*3.0*66^

**INSTALL NAME**
PSD*3.0*66
"BLD",6354,0)
PSD*3.0*66^CONTROLLED SUBSTANCES^0^3070607^y
"BLD",6354,1,0)
^^13^13^3070607^^
"BLD",6354,1,1,0)
With the deployment of Cache version 5, it was discovered that the short
"BLD",6354,1,2,0)
lock timeout values could generate a lock failure. Patch DI*22*147, which
"BLD",6354,1,3,0)
has already been released, provided a solution to resolve this issue and
"BLD",6354,1,4,0)
future lock issues.
"BLD",6354,1,5,0)
 
"BLD",6354,1,6,0)
This patch instituted a new default lock timeout of three seconds based on
"BLD",6354,1,7,0)
a global node setting of ^DD("DILOCKTM")=3.
"BLD",6354,1,8,0)
 
"BLD",6354,1,9,0)
In order to avoid the lock issue in Controlled Substances, this patch
"BLD",6354,1,10,0)
modifies all routines that currently use a lock timeout value of less than
"BLD",6354,1,11,0)
3 seconds to check for the node ^DD("DILOCKTM") and to use the value
"BLD",6354,1,12,0)
defined there, otherwise the lock timeout value is set to a default value
"BLD",6354,1,13,0)
of 3 seconds.
"BLD",6354,4,0)
^9.64PA^^
"BLD",6354,6.3)
3
"BLD",6354,"KRN",0)
^9.67PA^8989.52^19
"BLD",6354,"KRN",.4,0)
.4
"BLD",6354,"KRN",.401,0)
.401
"BLD",6354,"KRN",.402,0)
.402
"BLD",6354,"KRN",.403,0)
.403
"BLD",6354,"KRN",.5,0)
.5
"BLD",6354,"KRN",.84,0)
.84
"BLD",6354,"KRN",3.6,0)
3.6
"BLD",6354,"KRN",3.8,0)
3.8
"BLD",6354,"KRN",9.2,0)
9.2
"BLD",6354,"KRN",9.8,0)
9.8
"BLD",6354,"KRN",9.8,"NM",0)
^9.68A^46^43
"BLD",6354,"KRN",9.8,"NM",1,0)
PSDADJ^^0^B21920413
"BLD",6354,"KRN",9.8,"NM",2,0)
PSDADJC^^0^B21145884
"BLD",6354,"KRN",9.8,"NM",3,0)
PSDADJI^^0^B13315143
"BLD",6354,"KRN",9.8,"NM",4,0)
PSDADJIN^^0^B16106458
"BLD",6354,"KRN",9.8,"NM",5,0)
PSDADJN^^0^B17335349
"BLD",6354,"KRN",9.8,"NM",7,0)
PSDCOR^^0^B19184722
"BLD",6354,"KRN",9.8,"NM",8,0)
PSDCOR1^^0^B18935274
"BLD",6354,"KRN",9.8,"NM",9,0)
PSDCOR2^^0^B19219239
"BLD",6354,"KRN",9.8,"NM",10,0)
PSDCOR3^^0^B2318115
"BLD",6354,"KRN",9.8,"NM",11,0)
PSDDFP^^0^B21804424
"BLD",6354,"KRN",9.8,"NM",12,0)
PSDDFP1^^0^B6658082
"BLD",6354,"KRN",9.8,"NM",13,0)
PSDDWK2^^0^B11959671
"BLD",6354,"KRN",9.8,"NM",14,0)
PSDDWK3^^0^B11893594
"BLD",6354,"KRN",9.8,"NM",15,0)
PSDDWK4^^0^B6269312
"BLD",6354,"KRN",9.8,"NM",16,0)
PSDESTF^^0^B19562723
"BLD",6354,"KRN",9.8,"NM",17,0)
PSDESTO^^0^B22602014
"BLD",6354,"KRN",9.8,"NM",18,0)
PSDEVO^^0^B20846990
"BLD",6354,"KRN",9.8,"NM",19,0)
PSDEVO1^^0^B15175785
"BLD",6354,"KRN",9.8,"NM",20,0)
PSDEXGS1^^0^B8308810
"BLD",6354,"KRN",9.8,"NM",21,0)
PSDFIL2^^0^B21945086
"BLD",6354,"KRN",9.8,"NM",22,0)
PSDFIL3^^0^B21323903
"BLD",6354,"KRN",9.8,"NM",23,0)
PSDFT^^0^B24748762
"BLD",6354,"KRN",9.8,"NM",24,0)
PSDFT1^^0^B30957426
"BLD",6354,"KRN",9.8,"NM",27,0)
PSDNRGO^^0^B14945935
"BLD",6354,"KRN",9.8,"NM",28,0)
PSDNRGS^^0^B21669448
"BLD",6354,"KRN",9.8,"NM",29,0)
PSDNTF^^0^B32655045
"BLD",6354,"KRN",9.8,"NM",30,0)
PSDNTT1^^0^B16173482
"BLD",6354,"KRN",9.8,"NM",31,0)
PSDOPT0^^0^B72940281
"BLD",6354,"KRN",9.8,"NM",32,0)
PSDOPT1^^0^B22714104
"BLD",6354,"KRN",9.8,"NM",33,0)
PSDOR21^^0^B14294849
"BLD",6354,"KRN",9.8,"NM",34,0)
PSDORD2^^0^B14321615
"BLD",6354,"KRN",9.8,"NM",35,0)
PSDORN1^^0^B17431994
"BLD",6354,"KRN",9.8,"NM",36,0)
PSDORN2^^0^B15528357
"BLD",6354,"KRN",9.8,"NM",37,0)
PSDORP1^^0^B15402116
"BLD",6354,"KRN",9.8,"NM",38,0)
PSDORV1^^0^B13438648
"BLD",6354,"KRN",9.8,"NM",39,0)
PSDREC1^^0^B22137008
"BLD",6354,"KRN",9.8,"NM",40,0)
PSDREC2^^0^B21780916
"BLD",6354,"KRN",9.8,"NM",41,0)
PSDREC3^^0^B24878051
"BLD",6354,"KRN",9.8,"NM",42,0)
PSDREC4^^0^B28290989
"BLD",6354,"KRN",9.8,"NM",43,0)
PSDRF1^^0^B6890208
"BLD",6354,"KRN",9.8,"NM",44,0)
PSDRFT^^0^B8906513
"BLD",6354,"KRN",9.8,"NM",45,0)
PSDRFX^^0^B7927778
"BLD",6354,"KRN",9.8,"NM",46,0)
PSDTRV1^^0^B13150808
"BLD",6354,"KRN",9.8,"NM","B","PSDADJ",1)

"BLD",6354,"KRN",9.8,"NM","B","PSDADJC",2)

"BLD",6354,"KRN",9.8,"NM","B","PSDADJI",3)

"BLD",6354,"KRN",9.8,"NM","B","PSDADJIN",4)

"BLD",6354,"KRN",9.8,"NM","B","PSDADJN",5)

"BLD",6354,"KRN",9.8,"NM","B","PSDCOR",7)

"BLD",6354,"KRN",9.8,"NM","B","PSDCOR1",8)

"BLD",6354,"KRN",9.8,"NM","B","PSDCOR2",9)

"BLD",6354,"KRN",9.8,"NM","B","PSDCOR3",10)

"BLD",6354,"KRN",9.8,"NM","B","PSDDFP",11)

"BLD",6354,"KRN",9.8,"NM","B","PSDDFP1",12)

"BLD",6354,"KRN",9.8,"NM","B","PSDDWK2",13)

"BLD",6354,"KRN",9.8,"NM","B","PSDDWK3",14)

"BLD",6354,"KRN",9.8,"NM","B","PSDDWK4",15)

"BLD",6354,"KRN",9.8,"NM","B","PSDESTF",16)

"BLD",6354,"KRN",9.8,"NM","B","PSDESTO",17)

"BLD",6354,"KRN",9.8,"NM","B","PSDEVO",18)

"BLD",6354,"KRN",9.8,"NM","B","PSDEVO1",19)

"BLD",6354,"KRN",9.8,"NM","B","PSDEXGS1",20)

"BLD",6354,"KRN",9.8,"NM","B","PSDFIL2",21)

"BLD",6354,"KRN",9.8,"NM","B","PSDFIL3",22)

"BLD",6354,"KRN",9.8,"NM","B","PSDFT",23)

"BLD",6354,"KRN",9.8,"NM","B","PSDFT1",24)

"BLD",6354,"KRN",9.8,"NM","B","PSDNRGO",27)

"BLD",6354,"KRN",9.8,"NM","B","PSDNRGS",28)

"BLD",6354,"KRN",9.8,"NM","B","PSDNTF",29)

"BLD",6354,"KRN",9.8,"NM","B","PSDNTT1",30)

"BLD",6354,"KRN",9.8,"NM","B","PSDOPT0",31)

"BLD",6354,"KRN",9.8,"NM","B","PSDOPT1",32)

"BLD",6354,"KRN",9.8,"NM","B","PSDOR21",33)

"BLD",6354,"KRN",9.8,"NM","B","PSDORD2",34)

"BLD",6354,"KRN",9.8,"NM","B","PSDORN1",35)

"BLD",6354,"KRN",9.8,"NM","B","PSDORN2",36)

"BLD",6354,"KRN",9.8,"NM","B","PSDORP1",37)

"BLD",6354,"KRN",9.8,"NM","B","PSDORV1",38)

"BLD",6354,"KRN",9.8,"NM","B","PSDREC1",39)

"BLD",6354,"KRN",9.8,"NM","B","PSDREC2",40)

"BLD",6354,"KRN",9.8,"NM","B","PSDREC3",41)

"BLD",6354,"KRN",9.8,"NM","B","PSDREC4",42)

"BLD",6354,"KRN",9.8,"NM","B","PSDRF1",43)

"BLD",6354,"KRN",9.8,"NM","B","PSDRFT",44)

"BLD",6354,"KRN",9.8,"NM","B","PSDRFX",45)

"BLD",6354,"KRN",9.8,"NM","B","PSDTRV1",46)

"BLD",6354,"KRN",19,0)
19
"BLD",6354,"KRN",19.1,0)
19.1
"BLD",6354,"KRN",101,0)
101
"BLD",6354,"KRN",409.61,0)
409.61
"BLD",6354,"KRN",771,0)
771
"BLD",6354,"KRN",870,0)
870
"BLD",6354,"KRN",8989.51,0)
8989.51
"BLD",6354,"KRN",8989.52,0)
8989.52
"BLD",6354,"KRN",8994,0)
8994
"BLD",6354,"KRN","B",.4,.4)

"BLD",6354,"KRN","B",.401,.401)

"BLD",6354,"KRN","B",.402,.402)

"BLD",6354,"KRN","B",.403,.403)

"BLD",6354,"KRN","B",.5,.5)

"BLD",6354,"KRN","B",.84,.84)

"BLD",6354,"KRN","B",3.6,3.6)

"BLD",6354,"KRN","B",3.8,3.8)

"BLD",6354,"KRN","B",9.2,9.2)

"BLD",6354,"KRN","B",9.8,9.8)

"BLD",6354,"KRN","B",19,19)

"BLD",6354,"KRN","B",19.1,19.1)

"BLD",6354,"KRN","B",101,101)

"BLD",6354,"KRN","B",409.61,409.61)

"BLD",6354,"KRN","B",771,771)

"BLD",6354,"KRN","B",870,870)

"BLD",6354,"KRN","B",8989.51,8989.51)

"BLD",6354,"KRN","B",8989.52,8989.52)

"BLD",6354,"KRN","B",8994,8994)

"BLD",6354,"QUES",0)
^9.62^^
"BLD",6354,"REQB",0)
^9.611^8^7
"BLD",6354,"REQB",2,0)
PSD*3.0*63^2
"BLD",6354,"REQB",3,0)
PSD*3.0*53^2
"BLD",6354,"REQB",4,0)
PSD*3.0*48^2
"BLD",6354,"REQB",5,0)
PSD*3.0*33^2
"BLD",6354,"REQB",6,0)
PSD*3.0*20^2
"BLD",6354,"REQB",7,0)
PSD*3.0*16^2
"BLD",6354,"REQB",8,0)
PSD*3.0*19^2
"BLD",6354,"REQB","B","PSD*3.0*16",7)

"BLD",6354,"REQB","B","PSD*3.0*19",8)

"BLD",6354,"REQB","B","PSD*3.0*20",6)

"BLD",6354,"REQB","B","PSD*3.0*33",5)

"BLD",6354,"REQB","B","PSD*3.0*48",4)

"BLD",6354,"REQB","B","PSD*3.0*53",3)

"BLD",6354,"REQB","B","PSD*3.0*63",2)

"MBREQ")
0
"PKG",276,-1)
1^1
"PKG",276,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",276,20,0)
^9.402P^^
"PKG",276,22,0)
^9.49I^1^1
"PKG",276,22,1,0)
3.0^2970213^2970430^11595
"PKG",276,22,1,"PAH",1,0)
66^3070607
"PKG",276,22,1,"PAH",1,1,0)
^^13^13^3070607
"PKG",276,22,1,"PAH",1,1,1,0)
With the deployment of Cache version 5, it was discovered that the short
"PKG",276,22,1,"PAH",1,1,2,0)
lock timeout values could generate a lock failure. Patch DI*22*147, which
"PKG",276,22,1,"PAH",1,1,3,0)
has already been released, provided a solution to resolve this issue and
"PKG",276,22,1,"PAH",1,1,4,0)
future lock issues.
"PKG",276,22,1,"PAH",1,1,5,0)
 
"PKG",276,22,1,"PAH",1,1,6,0)
This patch instituted a new default lock timeout of three seconds based on
"PKG",276,22,1,"PAH",1,1,7,0)
a global node setting of ^DD("DILOCKTM")=3.
"PKG",276,22,1,"PAH",1,1,8,0)
 
"PKG",276,22,1,"PAH",1,1,9,0)
In order to avoid the lock issue in Controlled Substances, this patch
"PKG",276,22,1,"PAH",1,1,10,0)
modifies all routines that currently use a lock timeout value of less than
"PKG",276,22,1,"PAH",1,1,11,0)
3 seconds to check for the node ^DD("DILOCKTM") and to use the value
"PKG",276,22,1,"PAH",1,1,12,0)
defined there, otherwise the lock timeout value is set to a default value
"PKG",276,22,1,"PAH",1,1,13,0)
of 3 seconds.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
43
"RTN","PSDADJ")
0^1^B21920413^B21586955
"RTN","PSDADJ",1,0)
PSDADJ ;BIR/LTL-Adjustments ; 8 Aug 94
"RTN","PSDADJ",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**16,66**;13 Feb 97;Build 3
"RTN","PSDADJ",3,0)
 ;
"RTN","PSDADJ",4,0)
 ;References to ^PSD(58.8, supported by DBIA2711
"RTN","PSDADJ",5,0)
 ;References to ^PSD(58.81 are supported by DBIA2808
"RTN","PSDADJ",6,0)
 ;References to ^PSDRUG( supported by DBIA #221
"RTN","PSDADJ",7,0)
 ;
"RTN","PSDADJ",8,0)
 I '$D(PSDSITE) D ^PSDSET G:'$D(PSDSITE) QUIT
"RTN","PSDADJ",9,0)
 I '$D(^XUSEC("PSDMGR",DUZ)) W !!,"Sorry, you need the PSDMGR Security key to do adjustments.",!! G QUIT
"RTN","PSDADJ",10,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G QUIT
"RTN","PSDADJ",11,0)
 N DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSDAT,PSDB,PSDEX,PSDLOC,PSDLOCN,DA,PSDRUG,PSDRUGN,PSDOK,PSDS,PSAQ,PSDR,PSDREC,PSDT,X,Y,%,%H,%I
"RTN","PSDADJ",12,0)
 S DIR(0)="Y",DIR("A")="Review",DIR("B")="No",DIR("?")="If you answer yes, you will be shown all adjustments performed within               a selected time range." D ^DIR K DIR G:$D(DIRUT) QUIT G:Y=1 ^PSDADJR
"RTN","PSDADJ",13,0)
 S PSDLOC=$P(PSDSITE,U,3),PSDLOCN=$P(PSDSITE,U,4)
"RTN","PSDADJ",14,0)
 G:$P(PSDSITE,U,5) CHKD
"RTN","PSDADJ",15,0)
LOOK S DIC="^PSD(58.8,",DIC(0)="AEQ",DIC("A")="Select Dispensing Site: "
"RTN","PSDADJ",16,0)
 S DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$S($P($G(^(0)),U,2)[""M"":1,$P($G(^(0)),U,2)[""S"":1,1:0),$S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0)"
"RTN","PSDADJ",17,0)
 S DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDADJ",18,0)
 D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<1) QUIT
"RTN","PSDADJ",19,0)
 S PSDLOC=+Y,PSDLOCN=$P(Y,U,2)
"RTN","PSDADJ",20,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=$P(Y,U,2)
"RTN","PSDADJ",21,0)
CHKD I '$O(^PSD(58.8,PSDLOC,1,0)) W !!,"There are no drugs in ",PSDLOCN G QUIT
"RTN","PSDADJ",22,0)
 N X,X1 D SIG^XUSESIG I X1="" G QUIT
"RTN","PSDADJ",23,0)
 F  S DIC="^PSD(58.8,PSDLOC,1,",DIC(0)="AEMQZ",DIC("A")="Select "_PSDLOCN_" drug: ",DIC("S")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)>DT,1:1)",DA(1)=PSDLOC W ! D ^DIC K DIC G:Y<1 QUIT D  G:$D(DIRUT) QUIT D:$D(PSDEX) DEST^PSDGSRV1 K PSDEX
"RTN","PSDADJ",24,0)
 .S PSDRUG=+Y,PSDRUGN=$P($G(^PSDRUG(+Y,0)),U)
"RTN","PSDADJ",25,0)
 .;DAVE B (28APR99) Moving lock of PSD(58.8,LOC,1,DRUG) up.
"RTN","PSDADJ",26,0)
 .F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDADJ",27,0)
 .S PSAQ=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDADJ",28,0)
 .W !!,"Current Balance: ",PSAQ,?40
"RTN","PSDADJ",29,0)
 .W "Breakdown Unit: ",$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,8),!
"RTN","PSDADJ",30,0)
 .S DIR(0)="N^"_-PSAQ_":999999:2" S DIR("A")="Enter adjustment quantity (with '-' if negative)" D ^DIR K DIR Q:$D(DIRUT)
"RTN","PSDADJ",31,0)
 .S PSDREC=Y
"RTN","PSDADJ",32,0)
 .S DIR(0)="F^1:45",DIR("A")="Please enter reason for adjustment" W ! D ^DIR K DIR Q:$D(DIRUT)  S PSDR=Y
"RTN","PSDADJ",33,0)
POST .S DIR(0)="Y",DIR("A")="OK to post",DIR("B")="Yes",DIR("?")="Answer 'YES' to adjust your inventory balance, 'NO' or '^' to quit." W ! D ^DIR K DIR D:Y=1  L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0) K PSDRUG Q
"RTN","PSDADJ",34,0)
 ..W !!,"There were ",$S($P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4):$P($G(^(0)),U,4),1:0)," on hand.",?40,"There are now ",$P($G(^(0)),U,4)+PSDREC," on hand.",!
"RTN","PSDADJ",35,0)
 ..;F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):0 I  Q
"RTN","PSDADJ",36,0)
 ..D NOW^%DTC S PSDAT=+%
"RTN","PSDADJ",37,0)
 ..S PSAQ=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDADJ",38,0)
 ..S $P(^PSD(58.8,+PSDLOC,1,+PSDRUG,0),U,4)=PSDREC+PSAQ
"RTN","PSDADJ",39,0)
 ..L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0)
"RTN","PSDADJ",40,0)
MON ..S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSDADJ",41,0)
 ..I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DLAYGO
"RTN","PSDADJ",42,0)
 ..S DIE="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DA(2)=PSDLOC,DA(1)=PSDRUG,DA=$E(DT,1,5)*100,DR="7////^S X=$P($G(^(0)),U,5)+PSDREC" D ^DIE
"RTN","PSDADJ",43,0)
 ..W !,"Updating monthly adjustments and transaction history.",!
"RTN","PSDADJ",44,0)
TR ..F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDADJ",45,0)
FIND ..S PSDT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSDT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSDADJ",46,0)
 ..S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSDT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSDADJ",47,0)
 ..S DIE="^PSD(58.81,",DA=PSDT,DR="1////9;2////^S X=PSDLOC;3////^S X=PSDAT;4////^S X=PSDRUG;5////^S X=PSDREC;6////^S X=DUZ;9////^S X=PSAQ;15////^S X=PSDR;100////1" D ^DIE K DIE
"RTN","PSDADJ",48,0)
 ..S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDADJ",49,0)
 ..S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSDADJ",50,0)
 ..S (X,DINUM)=PSDT
"RTN","PSDADJ",51,0)
 ..S DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DA,DLAYGO S Y=1
"RTN","PSDADJ",52,0)
 ..I PSDREC<0 S DIR(0)="Y",DIR("A")="To be destroyed",DIR("B")="No" D ^DIR K DIR I Y=1 S PSDEX=1,PSDA=PSDT,PSDOK=1
"RTN","PSDADJ",53,0)
QUIT Q
"RTN","PSDADJC")
0^2^B21145884^B20793346
"RTN","PSDADJC",1,0)
PSDADJC ;B'ham ISC/LTL,JPW - Balance Shift Checker for NAOU ; 16 Feb 94
"RTN","PSDADJC",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**53,66**;13 Feb 97;Build 3
"RTN","PSDADJC",3,0)
 I '$D(PSDSITE) D ^PSDSET G:'$D(PSDSITE) QUIT
"RTN","PSDADJC",4,0)
 N D1,D2,DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,NODE,PSAC,PSDAT,PSDLOC,PSDOUT,PSDLOCN,DA,PSDRUG,PSDRUGN,PSDS,PSDPKG,PSDBKU,PSAQ,PSDR,PSDREC,PSDT,X,Y,%,%H,%I
"RTN","PSDADJC",5,0)
LOOK S DIC="^PSD(58.8,",DIC(0)="AEMQZ",DIC("A")="Select NAOU: ",DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$P($G(^(0)),U,2)[""N"",'$P(^(0),""^"",7),$S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0)"
"RTN","PSDADJC",6,0)
 W ! D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<1) QUIT
"RTN","PSDADJC",7,0)
 ;VMP OIFO BAY PINES;VGF;PSD*3.0*53;ADDED SET OF VARIABLE NAOU
"RTN","PSDADJC",8,0)
 S (NAOU,PSDLOC)=+Y,(NAOUN,PSDLOCN)=$P(Y,U,2),PSDS=+$P(Y(0),"^",4)
"RTN","PSDADJC",9,0)
 I '+$P($G(^PSD(58.8,PSDLOC,2)),"^",5) W !!,"This NAOU does not maintain a perpetual inventory balance to check.",!! K PSDLOC,PSDLOCN,PSDS G LOOK
"RTN","PSDADJC",10,0)
CHKD I '$O(^PSD(58.8,PSDLOC,1,0)) W !!,"There are no drugs in ",PSDLOCN G QUIT
"RTN","PSDADJC",11,0)
WIT W ! S NUR2=$$WITNESS^XUVERIFY("WITNESS")
"RTN","PSDADJC",12,0)
 I NUR2=DUZ W !!,"Wait a second, you can't witness yourself!",$C(7) G WIT
"RTN","PSDADJC",13,0)
 G:NUR2'>0 QUIT
"RTN","PSDADJC",14,0)
 W !!,"Thank you, ",$S($P($G(^VA(200,NUR2,.1)),U,4)]"":$P($G(^(.1)),U,4),1:$P($G(^VA(200,NUR2,0)),U))
"RTN","PSDADJC",15,0)
 W !!,"Give me a second to alphabetize.",!
"RTN","PSDADJC",16,0)
 S PSDRUG=0,PSDRUGN=""
"RTN","PSDADJC",17,0)
 F  S PSDRUG=$O(^PSD(58.8,PSDLOC,1,PSDRUG)) Q:'PSDRUG  D
"RTN","PSDADJC",18,0)
 .Q:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,0))!($P($G(^PSDRUG(+PSDRUG,0)),"^")']"")!('$P($G(^PSD(58.8,+PSDLOC,1,PSDRUG,0)),U,4))
"RTN","PSDADJC",19,0)
 .S PSDPKG=$P($G(^PSD(58.8,+PSDS,1,+PSDRUG,0)),"^",9),PSDBKU=$P($G(^(0)),"^",8)
"RTN","PSDADJC",20,0)
 .S ^TMP("PSDB",$J,$P($G(^PSDRUG(+PSDRUG,0)),U),PSDRUG)=PSDPKG_"^"_PSDBKU K Y
"RTN","PSDADJC",21,0)
 W @IOF S (PSDRUG,PSDRUGN)=0
"RTN","PSDADJC",22,0)
 F  S PSDRUGN=$O(^TMP("PSDB",$J,PSDRUGN)) Q:PSDRUGN']""  F  S PSDRUG=$O(^TMP("PSDB",$J,PSDRUGN,PSDRUG)) Q:'PSDRUG  D  G:$D(DIRUT)!($G(PSDOUT)) QUIT
"RTN","PSDADJC",23,0)
 .Q:'$G(^PSD(58.8,PSDLOC,1,PSDRUG,0))
"RTN","PSDADJC",24,0)
 .S NODE=$G(^TMP("PSDB",$J,PSDRUGN,PSDRUG))
"RTN","PSDADJC",25,0)
BAL .W !!,PSDRUGN,!!,"Balance:  "
"RTN","PSDADJC",26,0)
 .S (PSDREC,PSDREC(1),PSDREC(2))=$P($G(^PSD(58.8,PSDLOC,1,PSDRUG,0)),U,4)
"RTN","PSDADJC",27,0)
 .W PSDREC," ",$P(NODE,U,2)
"RTN","PSDADJC",28,0)
 .S DIR(0)="Y",DIR("A")="Count Correct",DIR("B")="Yes"
"RTN","PSDADJC",29,0)
 .W ! D ^DIR K DIR Q:$D(DIRUT)
"RTN","PSDADJC",30,0)
 .G:Y=1 INV
"RTN","PSDADJC",31,0)
 .F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDADJC",32,0)
 .S PSDREC(1)=$P($G(^PSD(58.8,PSDLOC,1,PSDRUG,0)),U,4)
"RTN","PSDADJC",33,0)
 .D NOW^%DTC S PSDAT=+%
"RTN","PSDADJC",34,0)
 .W !!,"Package Size: ",$P($G(NODE),"^"),"  Breakdown Unit: ",$P($G(NODE),"^",2),!
"RTN","PSDADJC",35,0)
 .S DIR(0)="NA^0:999999:2",DIR("A")="Correct Count: "
"RTN","PSDADJC",36,0)
 .S DIR("B")=PSDREC D ^DIR K DIR Q:$D(DIRUT)  S PSDREC(1)=Y
"RTN","PSDADJC",37,0)
 .I Y=PSDREC W !!,"That's no change." G INV
"RTN","PSDADJC",38,0)
 .I Y>PSDREC S NAOU(1)=0 D ^PSDORSU G:$G(NAOU(1)) BAL I $G(PSDOUT) L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0) Q
"RTN","PSDADJC",39,0)
 .S DIR(0)="58.81,15" W ! D ^DIR K DIR Q:$D(DIRUT)  S PSDRE=Y
"RTN","PSDADJC",40,0)
 .S DIE="^PSD(58.8,+PSDLOC,1,",DA(1)=PSDLOC,DA=PSDRUG
"RTN","PSDADJC",41,0)
 .S DR="3////"_$G(PSDREC(1)) D ^DIE
"RTN","PSDADJC",42,0)
 .S $P(^PSD(58.8,PSDLOC,1,PSDRUG,0),"^",17)=1
"RTN","PSDADJC",43,0)
 .L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0)
"RTN","PSDADJC",44,0)
INV .I '$G(PSDAT) D NOW^%DTC S PSDAT=%
"RTN","PSDADJC",45,0)
 .S PSDREC=$G(PSDREC(1))-PSDREC G:'PSDREC TRA
"RTN","PSDADJC",46,0)
MON .S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSDADJC",47,0)
 .I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DLAYGO
"RTN","PSDADJC",48,0)
 .S DIE="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DA(2)=PSDLOC,DA(1)=PSDRUG,DA=$E(DT,1,5)*100,DR="1////0;7////^S X=PSDREC" D ^DIE
"RTN","PSDADJC",49,0)
TRA .W !!,"Recording ",$S(PSDREC:"adjustment",1:"inventory")," in transaction history.",!
"RTN","PSDADJC",50,0)
TR .F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDADJC",51,0)
FIND .S PSDT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSDT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSDADJC",52,0)
 .S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSDT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSDADJC",53,0)
 .S DIE="^PSD(58.81,",DA=PSDT,DR="1////"_$S(PSDREC:9,1:23)_";2////"_PSDLOC_";3////"_PSDAT_";4////"_PSDRUG_";5////"_PSDREC_";6////"_DUZ_";9////"_PSDREC(2)_";15////"_$G(PSDRE)_";74////"_DUZ_";78////"_NUR2_";100////1" D ^DIE K DIE
"RTN","PSDADJC",54,0)
 .S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDADJC",55,0)
 .S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSDADJC",56,0)
 .S (X,DINUM)=PSDT,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DA,DLAYGO,Y
"RTN","PSDADJC",57,0)
 .S NAOU=PSDLOC,NAOUN=PSDLOCN
"RTN","PSDADJC",58,0)
MM .I PSDREC S PHARM1=DUZ,PSDT=PSDAT,PSDR=PSDRUG,PSDRE=$G(PSDRE),QTY=-PSDREC D ^PSDRFM
"RTN","PSDADJC",59,0)
REP S DIR(0)="Y",DIR("A")="Would you like a report of current balances"
"RTN","PSDADJC",60,0)
 S DIR("B")="No" D ^DIR K DIR D:Y=1 DEV^PSDBAN
"RTN","PSDADJC",61,0)
QUIT K ^TMP("PSDB",$J) Q
"RTN","PSDADJI")
0^3^B13315143^B13021753
"RTN","PSDADJI",1,0)
PSDADJI ;B'ham ISC/LTL - Balance Initializer ; 3 June 92
"RTN","PSDADJI",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDADJI",3,0)
 I '$D(PSDSITE) D ^PSDSET G:'$D(PSDSITE) QUIT
"RTN","PSDADJI",4,0)
 N D1,D2,DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSAC,PSDAT,PSDLOC,PSDLOCN,DA,PSDRUG,PSDRUGN,PSDS,PSAQ,PSDR,PSDREC,PSDT,X,Y,%,%H,%I
"RTN","PSDADJI",5,0)
 D ^PSDSP I $D(PSDS),$D(^PSD(58.8,+PSDS,0)) S PSDLOC=PSDS,PSDLOCN=$P($G(^PSD(58.8,+PSDS,0)),U) G CHKD
"RTN","PSDADJI",6,0)
LOOK S DIC="^PSD(58.8,",DIC(0)="AEMQ",DIC("A")="Select Dispensing Site: ",DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$S($P($G(^(0)),U,2)[""M"":1,$P($G(^(0)),U,2)[""S"":1,1:0),$S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0)"
"RTN","PSDADJI",7,0)
 D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<1) QUIT S PSDLOC=+Y,PSDLOCN=$P(Y,U,2)
"RTN","PSDADJI",8,0)
CHKD I '$O(^PSD(58.8,PSDLOC,1,0)) W !!,"There are no drugs in ",PSDLOCN G QUIT
"RTN","PSDADJI",9,0)
 W !!,"Give me a second to alphabetize.",!
"RTN","PSDADJI",10,0)
 S PSDRUG=0,PSDRUGN=""
"RTN","PSDADJI",11,0)
 F  S PSDRUG=$O(^PSD(58.8,PSDLOC,1,PSDRUG)) Q:'PSDRUG!($P($G(^PSDRUG(+PSDRUG,0)),U)']"")  D
"RTN","PSDADJI",12,0)
 .S ^TMP("PSDB",$J,$P($G(^PSDRUG(+PSDRUG,0)),U),PSDRUG)="" K Y
"RTN","PSDADJI",13,0)
 W @IOF
"RTN","PSDADJI",14,0)
 F PSAC=1:1 S PSDRUGN=$O(^TMP("PSDB",$J,PSDRUGN)) Q:PSDRUGN']""  S PSDRUG=$O(^TMP("PSDB",$J,PSDRUGN,0)) D  G:$D(Y) QUIT
"RTN","PSDADJI",15,0)
 .I $P($G(^PSD(58.8,PSDLOC,1,PSDRUG,0)),U,4)]"" D:$Y+9>IOSL  Q:$D(DUOUT)!($D(DTOUT))  W !!,PSDRUGN," may have to be adjusted.",!!,"There's already ",$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)," on hand." Q
"RTN","PSDADJI",16,0)
 ..S DIR(0)="E" D ^DIR K DIR K:Y Y W @IOF
"RTN","PSDADJI",17,0)
 .W !!,PSDRUGN,!!,"Package Size: "
"RTN","PSDADJI",18,0)
 .W $P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,9),"  Breakdown Unit: ",$P($G(^(0)),U,8),!
"RTN","PSDADJI",19,0)
 .F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDADJI",20,0)
 .S DIR(0)="N^0:999999:0",DIR("A")="Initial Balance" D ^DIR K DIR
"RTN","PSDADJI",21,0)
 .I $D(DIRUT) L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0) S Y=1 Q
"RTN","PSDADJI",22,0)
 .S PSDREC=Y D NOW^%DTC S PSDAT=+%
"RTN","PSDADJI",23,0)
 .S DIE="^PSD(58.8,+PSDLOC,1,",DA(1)=PSDLOC,DA=PSDRUG,DR="3////"_PSDREC
"RTN","PSDADJI",24,0)
 .D ^DIE
"RTN","PSDADJI",25,0)
 .L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0)
"RTN","PSDADJI",26,0)
 .Q:$G(PSDREC)']""
"RTN","PSDADJI",27,0)
MON .S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSDADJI",28,0)
 .I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DLAYGO
"RTN","PSDADJI",29,0)
 .S DIE="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DA(2)=PSDLOC,DA(1)=PSDRUG,DA=$E(DT,1,5)*100,DR="1////0;7////^S X=PSDREC" D ^DIE
"RTN","PSDADJI",30,0)
 .W !!,"Updating beginning balance and transaction history.",!
"RTN","PSDADJI",31,0)
TR .F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDADJI",32,0)
FIND .S PSDT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSDT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSDADJI",33,0)
 .S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSDT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSDADJI",34,0)
 .S DIE="^PSD(58.81,",DA=PSDT,DR="1////11;2////^S X=PSDLOC;3////^S X=PSDAT;4////^S X=PSDRUG;5////^S X=PSDREC;6////^S X=DUZ;9////0;100////1" D ^DIE K DIE
"RTN","PSDADJI",35,0)
 .S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDADJI",36,0)
 .S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSDADJI",37,0)
 .S (X,DINUM)=PSDT,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DA,DLAYGO,Y
"RTN","PSDADJI",38,0)
QUIT K ^TMP("PSDB",$J) Q
"RTN","PSDADJIN")
0^4^B16106458^B15788264
"RTN","PSDADJIN",1,0)
PSDADJIN ;B'ham ISC/LTL,JPW - Balance Initializer for NAOU ; 16 Feb 94
"RTN","PSDADJIN",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDADJIN",3,0)
 I '$D(PSDSITE) D ^PSDSET G:'$D(PSDSITE) QUIT
"RTN","PSDADJIN",4,0)
 N D1,D2,DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,NODE,PSAC,PSDAT,PSDLOC,PSDLOCN,DA,PSDRUG,PSDRUGN,PSDS,PSDPKG,PSDBKU,PSAQ,PSDR,PSDREC,PSDT,X,Y,%,%H,%I
"RTN","PSDADJIN",5,0)
LOOK S DIC="^PSD(58.8,",DIC(0)="AEMQZ",DIC("A")="Select NAOU: ",DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$P($G(^(0)),U,2)[""N"",'$P(^(0),""^"",7),$S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0)"
"RTN","PSDADJIN",6,0)
 D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<1) QUIT S PSDLOC=+Y,PSDLOCN=$P(Y,U,2),PSDS=+$P(Y(0),"^",4)
"RTN","PSDADJIN",7,0)
 I '+$P($G(^PSD(58.8,PSDLOC,2)),"^",5) W !!,"This NAOU does not maintain a perpetual inventory balance to initialize.",!! K PSDLOC,PSDLOCN,PSDS G LOOK
"RTN","PSDADJIN",8,0)
CHKD I '$O(^PSD(58.8,PSDLOC,1,0)) W !!,"There are no drugs in ",PSDLOCN G QUIT
"RTN","PSDADJIN",9,0)
 S DIR(0)="Y",DIR("A",1)="This option will set all balances to zero before initializing.",DIR("A")="Are you sure you want to proceed"
"RTN","PSDADJIN",10,0)
 D ^DIR K DIR G:Y'=1 QUIT
"RTN","PSDADJIN",11,0)
 W !!,"Give me a second to alphabetize.",!
"RTN","PSDADJIN",12,0)
 S PSDRUG=0,PSDRUGN=""
"RTN","PSDADJIN",13,0)
 F  S PSDRUG=$O(^PSD(58.8,PSDLOC,1,PSDRUG)) Q:'PSDRUG  D
"RTN","PSDADJIN",14,0)
 .Q:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,0))!($P($G(^PSDRUG(+PSDRUG,0)),"^")']"")
"RTN","PSDADJIN",15,0)
 .S PSDPKG=$P($G(^PSD(58.8,+PSDS,1,+PSDRUG,0)),"^",9),PSDBKU=$P($G(^(0)),"^",8)
"RTN","PSDADJIN",16,0)
 .S ^TMP("PSDB",$J,$P($G(^PSDRUG(+PSDRUG,0)),U),PSDRUG)=PSDPKG_"^"_PSDBKU,$P(^PSD(58.8,+PSDLOC,1,+PSDRUG,0),U,4)=0 K Y
"RTN","PSDADJIN",17,0)
 W @IOF
"RTN","PSDADJIN",18,0)
 F PSAC=1:1 S PSDRUGN=$O(^TMP("PSDB",$J,PSDRUGN)) Q:PSDRUGN']""  S PSDRUG=$O(^TMP("PSDB",$J,PSDRUGN,0)) D  G:$D(DIRUT) QUIT
"RTN","PSDADJIN",19,0)
 .Q:'$G(^PSD(58.8,PSDLOC,1,PSDRUG,0))
"RTN","PSDADJIN",20,0)
 .;S (PSD,PSD(1))=0
"RTN","PSDADJIN",21,0)
 .;F  S PSD=$O(^PSD(58.81,"AD",4,+PSDLOC,PSD)) S:$P($G(^PSD(58.81,+PSD,0)),U,5)=PSDRUG PSD(1)=1 Q:$G(PSD(1))!('PSD)
"RTN","PSDADJIN",22,0)
 .;Q:'$G(PSD(1))
"RTN","PSDADJIN",23,0)
 .S NODE=$G(^TMP("PSDB",$J,PSDRUGN,PSDRUG))
"RTN","PSDADJIN",24,0)
 .S DIE="^PSD(58.8,+PSDLOC,1,",DA(1)=PSDLOC,DA=PSDRUG
"RTN","PSDADJIN",25,0)
 .F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDADJIN",26,0)
 .D NOW^%DTC S PSDAT=+%
"RTN","PSDADJIN",27,0)
 .W !!,PSDRUGN,!!,"Package Size: ",$P($G(NODE),"^"),"  Breakdown Unit: ",$P($G(NODE),"^",2),!
"RTN","PSDADJIN",28,0)
 .S DIR(0)="NA^0:999999:2",DIR("A")="Initial Balance: " D ^DIR K DIR
"RTN","PSDADJIN",29,0)
 .Q:$D(DIRUT)  S PSDREC=Y
"RTN","PSDADJIN",30,0)
 .S DR="3////"_PSDREC D ^DIE
"RTN","PSDADJIN",31,0)
 .S $P(^PSD(58.8,PSDLOC,1,PSDRUG,0),"^",17)=1
"RTN","PSDADJIN",32,0)
 .L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0)
"RTN","PSDADJIN",33,0)
 .Q:$G(PSDREC)']""
"RTN","PSDADJIN",34,0)
MON .S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSDADJIN",35,0)
 .I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DLAYGO
"RTN","PSDADJIN",36,0)
 .S DIE="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DA(2)=PSDLOC,DA(1)=PSDRUG,DA=$E(DT,1,5)*100,DR="1////0;7////^S X=PSDREC" D ^DIE
"RTN","PSDADJIN",37,0)
 .W !!,"Updating beginning balance and transaction history.",!
"RTN","PSDADJIN",38,0)
TR .F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDADJIN",39,0)
FIND .S PSDT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSDT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSDADJIN",40,0)
 .S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSDT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSDADJIN",41,0)
 .S DIE="^PSD(58.81,",DA=PSDT,DR="1////11;2////^S X=PSDLOC;3////^S X=PSDAT;4////^S X=PSDRUG;5////^S X=PSDREC;6////^S X=DUZ;9////0;100////1" D ^DIE K DIE
"RTN","PSDADJIN",42,0)
 .S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDADJIN",43,0)
 .S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSDADJIN",44,0)
 .S (X,DINUM)=PSDT,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DA,DLAYGO,Y
"RTN","PSDADJIN",45,0)
REP S DIR(0)="Y",DIR("A")="Would you like a report of current balances"
"RTN","PSDADJIN",46,0)
 S DIR("B")="Yes" D ^DIR K DIR D:Y=1
"RTN","PSDADJIN",47,0)
 .S NAOU=PSDLOC,NAOUN=PSDLOCN D DEV^PSDBAN
"RTN","PSDADJIN",48,0)
QUIT K ^TMP("PSDB",$J) Q
"RTN","PSDADJN")
0^5^B17335349^B17013339
"RTN","PSDADJN",1,0)
PSDADJN ;B'ham ISC/LTL,JPW - Adjustments for NAOU ; 16 Feb 94
"RTN","PSDADJN",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDADJN",3,0)
 I '$D(PSDSITE) D ^PSDSET G:'$D(PSDSITE) QUIT
"RTN","PSDADJN",4,0)
 ;I '$D(^XUSEC("PSD ERROR",DUZ)) W !!,"Sorry, you need the PSD ERROR Security key to do adjustments.",!! G QUIT
"RTN","PSDADJN",5,0)
 N DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSDAT,PSDB,PSDEX,PSDLOC,PSDLOCN,DA,PSDOUT,PSDRUG,PSDRUGN,PSDS,PSAQ,PSDR,PSDREC,PSDT,X,Y,%,%H,%I
"RTN","PSDADJN",6,0)
 G LOOK
"RTN","PSDADJN",7,0)
REV S DIR(0)="Y",DIR("A")="Review",DIR("B")="No",DIR("?")="If you answer yes, I'll show you all adjustments performed within               a selected time range." D ^DIR K DIR G:$D(DIRUT) QUIT G:Y=1 ^PSDADJN1
"RTN","PSDADJN",8,0)
 Q
"RTN","PSDADJN",9,0)
LOOK S DIC="^PSD(58.8,",DIC(0)="AEMQ",DIC("A")="Select NAOU: ",DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$P($G(^(0)),U,2)[""N"",'$P(^(0),""^"",7),$S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0)"
"RTN","PSDADJN",10,0)
 D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<1) QUIT S PSDLOC=+Y,PSDLOCN=$P(Y,U,2)
"RTN","PSDADJN",11,0)
 I '+$P($G(^PSD(58.8,PSDLOC,2)),"^",5) W !!,"This NAOU does not maintain a perpetual inventory balance to be adjusted.",!! K PSDLOC,PSDLOCN G LOOK
"RTN","PSDADJN",12,0)
CHKD I '$O(^PSD(58.8,PSDLOC,1,0)) W !!,"There are no drugs in ",PSDLOCN G QUIT
"RTN","PSDADJN",13,0)
 S PSDOUT=0
"RTN","PSDADJN",14,0)
 F  S DIC="^PSD(58.8,PSDLOC,1,",DIC(0)="AEMQZ",DIC("A")="Select "_PSDLOCN_" drug: ",DA(1)=PSDLOC D  G:$D(DTOUT)!($D(DUOUT))!(PSDOUT) QUIT
"RTN","PSDADJN",15,0)
 .W ! D ^DIC K DIC I $D(DTOUT)!($D(DUOUT))!(Y<1) S PSDOUT=1 Q
"RTN","PSDADJN",16,0)
 .S PSDRUG=+Y,PSDRUGN=$P($G(^PSDRUG(+Y,0)),U)
"RTN","PSDADJN",17,0)
 .S PSAQ=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDADJN",18,0)
 .W !!,"Current Balance: ",PSAQ,?40
"RTN","PSDADJN",19,0)
 .W "Breakdown Unit: ",$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,8),!
"RTN","PSDADJN",20,0)
 .S DIR(0)="NOA^"_-PSAQ_":999999:2" S DIR("A")="Enter adjustment quantity (with '-' if negative):" D ^DIR K DIR
"RTN","PSDADJN",21,0)
 .I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDADJN",22,0)
 .Q:$D(DIRUT)
"RTN","PSDADJN",23,0)
 .S PSDREC=Y
"RTN","PSDADJN",24,0)
 .S DIR(0)="F^1:45",DIR("A")="Please enter reason for adjustment" W ! D ^DIR K DIR Q:$D(DIRUT)  S PSDR=Y
"RTN","PSDADJN",25,0)
POST .S DIR(0)="Y",DIR("A")="OK to post",DIR("B")="Yes" W ! D ^DIR K DIR D:Y=1  K PSDRUG Q
"RTN","PSDADJN",26,0)
 ..W !!,"There were ",$S($P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4):$P($G(^(0)),U,4),1:0)," on hand.",?40,"There are now ",$P($G(^(0)),U,4)+PSDREC," on hand.",!
"RTN","PSDADJN",27,0)
 ..F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDADJN",28,0)
 ..D NOW^%DTC S PSDAT=+%
"RTN","PSDADJN",29,0)
 ..S PSAQ=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDADJN",30,0)
 ..S $P(^PSD(58.8,+PSDLOC,1,+PSDRUG,0),U,4)=PSDREC+PSAQ
"RTN","PSDADJN",31,0)
 ..L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0)
"RTN","PSDADJN",32,0)
MON ..S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSDADJN",33,0)
 ..I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DLAYGO
"RTN","PSDADJN",34,0)
 ..S DIE="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DA(2)=PSDLOC,DA(1)=PSDRUG,DA=$E(DT,1,5)*100,DR="7////^S X=$P($G(^(0)),U,5)+PSDREC" D ^DIE
"RTN","PSDADJN",35,0)
 ..W !,"Updating monthly adjustments and transaction history.",!
"RTN","PSDADJN",36,0)
TR ..F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDADJN",37,0)
FIND ..S PSDT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSDT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSDADJN",38,0)
 ..S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSDT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSDADJN",39,0)
 ..S DIE="^PSD(58.81,",DA=PSDT,DR="1////9;2////^S X=PSDLOC;3////^S X=PSDAT;4////^S X=PSDRUG;5////^S X=PSDREC;6////^S X=DUZ;9////^S X=PSAQ;15////^S X=PSDR;17////^S X=PSDLOC;100////1" D ^DIE K DIE
"RTN","PSDADJN",40,0)
 ..S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDADJN",41,0)
 ..S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSDADJN",42,0)
 ..S (X,DINUM)=PSDT
"RTN","PSDADJN",43,0)
 ..S DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DA,DLAYGO,PSDRUG S Y=1
"RTN","PSDADJN",44,0)
QUIT D:'$G(PSDOUT)!('$D(DIRUT)) REV Q
"RTN","PSDCOR")
0^7^B19184722^B19035165
"RTN","PSDCOR",1,0)
PSDCOR ;BIR/JPW-CS Correction Action ; 6 July 94
"RTN","PSDCOR",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDCOR",3,0)
EN1 ;sets type=1
"RTN","PSDCOR",4,0)
 S TYPE=1 G START
"RTN","PSDCOR",5,0)
EN2 ;sets type=2
"RTN","PSDCOR",6,0)
 S TYPE=2 G START
"RTN","PSDCOR",7,0)
EN3 ;sets type=3
"RTN","PSDCOR",8,0)
 S TYPE=3
"RTN","PSDCOR",9,0)
START ;start proc
"RTN","PSDCOR",10,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDCOR",11,0)
 I '$D(^XUSEC("PSDMGR",DUZ)) W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to correct",!,?12,"narcotic orders.",!!,"PSDMGR security key required.",! K TYPE Q
"RTN","PSDCOR",12,0)
 W !!,"Controlled Substances Correction Action" S PSDUZ=DUZ
"RTN","PSDCOR",13,0)
 G:TYPE=2 ^PSDCOR1 G:TYPE=3 ^PSDCOR2
"RTN","PSDCOR",14,0)
ASKN ;ask naou
"RTN","PSDCOR",15,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select NAOU: "
"RTN","PSDCOR",16,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDCOR",17,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDCOR",18,0)
GS ;select green sheet #
"RTN","PSDCOR",19,0)
 W $C(7),!!,?15,"** NOTE **",!,"Your Green Sheet selection is limited to those Green Sheets flagged as",!,"'COMPLETED - GREEN SHEET READY FOR PICKUP' on the selected NAOU.",!
"RTN","PSDCOR",20,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDCOR",21,0)
 S DIC("S")="I $P(^(0),""^"",11)=5,$P(^(0),""^"",18)=AOU"
"RTN","PSDCOR",22,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDCOR",23,0)
 S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDCOR",24,0)
 S PSDS=+$P(Y(0),"^",3)
"RTN","PSDCOR",25,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5)
"RTN","PSDCOR",26,0)
 S NURS=$P($G(^PSD(58.81,PSDA,1)),"^",10)
"RTN","PSDCOR",27,0)
 I AOU'=NAOU W $C(7),!!,"The Green Sheet # ",PSDPN," is assigned to ",NAOUN,".",!,"Please select another Green Sheet.",! G GS
"RTN","PSDCOR",28,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDCOR",29,0)
 I STAT'=5 W $C(7),!!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please select another Green Sheet.",! G GS
"RTN","PSDCOR",30,0)
ASK W !!,"This action will update Green Sheet #",PSDPN," as ",!,?5,"** DELIVERED - ACTIVELY ON NAOU **",!
"RTN","PSDCOR",31,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Are you sure",DIR("B")="NO"
"RTN","PSDCOR",32,0)
 S DIR("?",1)="Answer 'YES' to update the status to 'DELIVERED - ACTIVELY ON NAOU' or",DIR("?")="answer 'NO' to quit and the status will remain 'COMPLETED - GREEN SHEET READY FOR PICKUP'."
"RTN","PSDCOR",33,0)
 D ^DIR K DIR I 'Y W !!,"No action taken.",!! G END
"RTN","PSDCOR",34,0)
COM ;complete correction
"RTN","PSDCOR",35,0)
 D NOW^%DTC S RECDT=+$E(%,1,12)
"RTN","PSDCOR",36,0)
 W !!,"Accessing Green Sheet #",PSDPN," information...",!!
"RTN","PSDCOR",37,0)
 F  L +^PSD(58.87,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDCOR",38,0)
FIND S PSDCOR=$P(^PSD(58.87,0),"^",3)+1 I $D(^PSD(58.87,PSDCOR)) S $P(^PSD(58.87,0),"^",3)=PSDCOR G FIND
"RTN","PSDCOR",39,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.87,DIC(0)="L",X=PSDCOR D ^DIC K DIC,DLAYGO
"RTN","PSDCOR",40,0)
 L -^PSD(58.87,0)
"RTN","PSDCOR",41,0)
 K DA,DIE,DR S DIE=58.87,DA=PSDCOR,DR="1////"_RECDT_";2////"_PSDUZ_";3////"_PSDPN_";4////"_PSDR_";5////"_NAOU_";6////"_NURS_";8////"_ORD_";11////"_TYPE_";12////"_PSDS
"RTN","PSDCOR",42,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDCOR",43,0)
 W !!,"Updating your records now..."
"RTN","PSDCOR",44,0)
 ;update transaction file (58.81)
"RTN","PSDCOR",45,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81,DR="10////4" D ^DIE K DA,DIE,DR
"RTN","PSDCOR",46,0)
 I $D(Y)!$D(DTOUT) W $C(7),!!,"** THIS GREEN SHEET HAS NOT BEEN CORRECTED **",!!,"The status remains "_STATN,! G END
"RTN","PSDCOR",47,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////4" D ^DIE K DA,DIE,DR
"RTN","PSDCOR",48,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11) W ?2,!,"*** Your Green Sheet #"_PSDPN_" is now "_$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDCOR",49,0)
END K %,%DT,%H,%I,AOU,AOUN,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT
"RTN","PSDCOR",50,0)
 K NAOU,NAOUN,NURS,OK,ORD,PSDA,PSDCOR,PSDPN,PSDR,PSDS,PSDUZ,RECDT,STAT,STATN,TYPE,X,Y
"RTN","PSDCOR",51,0)
 Q
"RTN","PSDCOR1")
0^8^B18935274^B18800981
"RTN","PSDCOR1",1,0)
PSDCOR1 ;BIR/JPW-CS Correction Action (cont'd) ; 6 July 94
"RTN","PSDCOR1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDCOR1",3,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4) G:$P(PSDSITE,U,5) GS
"RTN","PSDCOR1",4,0)
ASKD ;ask disp site
"RTN","PSDCOR1",5,0)
 K DA,DIC W ! S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Dispensing Site: ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)=""M"":1,$P(^(0),""^"",2)=""S"":1,1:0)"
"RTN","PSDCOR1",6,0)
 S DIC("B")=PSDSN
"RTN","PSDCOR1",7,0)
 D ^DIC K DIC G:Y<0 END S PSDS=+Y,PSDSN=$P(Y,"^",2)
"RTN","PSDCOR1",8,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDCOR1",9,0)
GS ;select green sheet #
"RTN","PSDCOR1",10,0)
 W $C(7),!!,?15,"** NOTE **"
"RTN","PSDCOR1",11,0)
 W !,"Your Green Sheet selection is limited to those Green Sheets added using the"
"RTN","PSDCOR1",12,0)
 W !,"Add Existing Green Sheets option.  The Green Sheet status must still be",!,"DELIVERED - ACTIVELY ON NAOU for you to make this correction.",!!
"RTN","PSDCOR1",13,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDCOR1",14,0)
 S DIC("S")="I $P(^(0),""^"",2)=12,$P(^(0),""^"",3)=+PSDS,$P(^(0),""^"",11)=4"
"RTN","PSDCOR1",15,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDCOR1",16,0)
 I $D(^PSD(58.81,PSDA,7)) W $C(7),!!,"This Green Sheet has been transferred between NAOUs.",!,"You may not delete this Green Sheet.",! G END
"RTN","PSDCOR1",17,0)
 S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDCOR1",18,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5)
"RTN","PSDCOR1",19,0)
 S PHARM=$P($G(^PSD(58.81,PSDA,1)),"^"),PSDT=$P(Y(0),"^",4),QTY=$P(Y(0),"^",6) I $D(^PSD(58.81,PSDA,4)),$P(^(4),"^",3) S QTY=$P(^(4),"^",3)
"RTN","PSDCOR1",20,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDCOR1",21,0)
 I STAT'=4 W $C(7),!!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please select another Green Sheet.",! G GS
"RTN","PSDCOR1",22,0)
ASK W !!,"This action will delete Green Sheet #",PSDPN,"."
"RTN","PSDCOR1",23,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Are you sure",DIR("B")="NO"
"RTN","PSDCOR1",24,0)
 S DIR("?",1)="Answer 'YES' to delete the Green Sheet or",DIR("?")="answer 'NO' to quit and the Green Sheet data will not be deleted."
"RTN","PSDCOR1",25,0)
 D ^DIR K DIR I 'Y W !!,"No action taken.  The Green Sheet data still exists.",!! G END
"RTN","PSDCOR1",26,0)
COM ;complete correction
"RTN","PSDCOR1",27,0)
 D NOW^%DTC S RECDT=+$E(%,1,12)
"RTN","PSDCOR1",28,0)
 W !!,"Accessing Green Sheet #",PSDPN," information...",!!
"RTN","PSDCOR1",29,0)
 F  L +^PSD(58.87,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDCOR1",30,0)
FIND S PSDCOR=$P(^PSD(58.87,0),"^",3)+1 I $D(^PSD(58.87,PSDCOR)) S $P(^PSD(58.87,0),"^",3)=PSDCOR G FIND
"RTN","PSDCOR1",31,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.87,DIC(0)="L",X=PSDCOR D ^DIC K DIC,DLAYGO
"RTN","PSDCOR1",32,0)
 L -^PSD(58.87,0)
"RTN","PSDCOR1",33,0)
 K DA,DIE,DR S DIE=58.87,DA=PSDCOR,DR="1////"_RECDT_";2////"_PSDUZ_";3////"_PSDPN_";4////"_PSDR_";5////"_NAOU_";7////"_PSDT_";8////"_ORD_";9////"_PHARM_";10////"_QTY_";11////"_TYPE_";12////"_PSDS
"RTN","PSDCOR1",34,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDCOR1",35,0)
 W !!,"Updating your records now..."
"RTN","PSDCOR1",36,0)
 ;update transaction file (58.81)
"RTN","PSDCOR1",37,0)
 K DA,DIE,DR S DIDEL=58.81,DA=PSDA,DIE=58.81,DR=".01////@" D ^DIE K DA,DIE,DR,DIDEL
"RTN","PSDCOR1",38,0)
 I $D(Y)!$D(DTOUT) W $C(7),!!,"** THIS GREEN SHEET HAS NOT BEEN CORRECTED **",!!,"The status remains "_STATN,! G END
"RTN","PSDCOR1",39,0)
 K DA,DIE,DR S DIDEL=58.800119,DA=PSDA,DA(1)=PSDR,DA(2)=+PSDS,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",4,",DR=".01////@" D ^DIE K DA,DIE,DR,DIDEL
"RTN","PSDCOR1",40,0)
 K DA,DIE,DR S DIDEL=58.800118,DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR=".01////@" D ^DIE K DA,DIE,DR,DIDEL
"RTN","PSDCOR1",41,0)
 W ?2,!,"*** Your Green Sheet #"_PSDPN_" has been deleted. ***",!,"If you wish to add this Green Sheet again,",!,"please use the 'Add Existing Green Sheets' option.",!
"RTN","PSDCOR1",42,0)
END K %,%DT,%H,%I,D,DA,DIC,DIDEL,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT
"RTN","PSDCOR1",43,0)
 K NAOU,NAOUN,OK,ORD,PHARM,PSDA,PSDCOR,PSDPN,PSDR,PSDS,PSDSN,PSDT,PSDUZ,QTY,RECDT,STAT,STATN,TYPE,X,Y
"RTN","PSDCOR1",44,0)
 Q
"RTN","PSDCOR2")
0^9^B19219239^B19079222
"RTN","PSDCOR2",1,0)
PSDCOR2 ;BIR/JPW-CS Correction Action (cont'd) ; 6 July 94
"RTN","PSDCOR2",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDCOR2",3,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4) G:$P(PSDSITE,U,5) GS
"RTN","PSDCOR2",4,0)
ASKD ;ask disp site
"RTN","PSDCOR2",5,0)
 K DA,DIC W ! S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Dispensing Site: ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)=""M"":1,$P(^(0),""^"",2)=""S"":1,1:0)",DIC("B")=PSDSN
"RTN","PSDCOR2",6,0)
 D ^DIC K DIC G:Y<0 END S PSDS=+Y,PSDSN=$P(Y,"^",2)
"RTN","PSDCOR2",7,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDCOR2",8,0)
GS ;select green sheet #
"RTN","PSDCOR2",9,0)
 W $C(7),!!,?15,"** NOTE **",!,"Your Green Sheet selection is limited to those Green Sheets marked as",!,"COMPLETED - REVIEWED NO DISCREPANCY.",!
"RTN","PSDCOR2",10,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDCOR2",11,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDS,$P(^(0),""^"",11)=7,$P(^(0),""^"",12)=1"
"RTN","PSDCOR2",12,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDCOR2",13,0)
 S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDCOR2",14,0)
 S COMP=+$P(Y(0),"^",12),COMPN=$P($G(^PSD(58.83,COMP,0)),"^")
"RTN","PSDCOR2",15,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5)
"RTN","PSDCOR2",16,0)
 S CPBY=+$P($G(^PSD(58.81,PSDA,1)),"^",14),CPBYD=+$P(Y(0),"^",19)
"RTN","PSDCOR2",17,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDCOR2",18,0)
 I STAT'=7 W $C(7),!!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please select another Green Sheet.",! G GS
"RTN","PSDCOR2",19,0)
ASKS ;ask new stat
"RTN","PSDCOR2",20,0)
 K DA,DIC S DIC=58.83,DIC(0)="QEA",DIC("A")="Select Completion Status: ",DIC("S")="I $S(Y<4:0,1:1)"
"RTN","PSDCOR2",21,0)
 D ^DIC K DIC I Y<0 G END
"RTN","PSDCOR2",22,0)
 S NCOMP=+Y,NCOMPN=$P($G(^PSD(58.83,NCOMP,0)),"^")
"RTN","PSDCOR2",23,0)
 K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Is this OK",DIR("?",1)="Answer 'YES' to update the status",DIR("?")="or 'NO' to select another status."
"RTN","PSDCOR2",24,0)
 S DIR("B")="YES" D ^DIR K DIR G:$D(DIRUT) END I 'Y G ASKS
"RTN","PSDCOR2",25,0)
ASK W !!,"This action will update Green Sheet #",PSDPN," as ",!,?5,"** COMPLETED - PENDING PROBLEM RESOLUTION",!,?8,NCOMPN," **",!
"RTN","PSDCOR2",26,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Are you sure",DIR("B")="NO"
"RTN","PSDCOR2",27,0)
 S DIR("?",1)="Answer 'YES' to update the status to COMPLETED - PENDING PROBLEM",DIR("?",2)="RESOLUTION "_NCOMPN_" or answer 'NO' to quit",DIR("?")="and the status will remain COMPLETED - REVIEWED NO DISCREPANCY."
"RTN","PSDCOR2",28,0)
 D ^DIR K DIR I 'Y W !!,"No action taken.",!! G END
"RTN","PSDCOR2",29,0)
COM ;complete correction
"RTN","PSDCOR2",30,0)
 D NOW^%DTC S RECDT=+$E(%,1,12)
"RTN","PSDCOR2",31,0)
 W !!,"Accessing Green Sheet #",PSDPN," information...",!!
"RTN","PSDCOR2",32,0)
 F  L +^PSD(58.87,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDCOR2",33,0)
FIND S PSDCOR=$P(^PSD(58.87,0),"^",3)+1 I $D(^PSD(58.87,PSDCOR)) S $P(^PSD(58.87,0),"^",3)=PSDCOR G FIND
"RTN","PSDCOR2",34,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.87,DIC(0)="L",X=PSDCOR D ^DIC K DIC,DLAYGO
"RTN","PSDCOR2",35,0)
 L -^PSD(58.87,0)
"RTN","PSDCOR2",36,0)
 K DA,DIE,DR S DIE=58.87,DA=PSDCOR,DR="1////"_RECDT_";2////"_PSDUZ_";3////"_PSDPN_";4////"_PSDR_";5////"_NAOU_";7////"_CPBYD_";8////"_ORD_";9////"_CPBY_";11////"_TYPE_";12////"_PSDS_";13////"_COMP_";14////"_NCOMP
"RTN","PSDCOR2",37,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDCOR2",38,0)
 W !!,"Updating your records now..."
"RTN","PSDCOR2",39,0)
 ;update transaction file (58.81)
"RTN","PSDCOR2",40,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81,DR="10////8;11////"_NCOMP D ^DIE K DA,DIE,DR
"RTN","PSDCOR2",41,0)
 I $D(Y)!$D(DTOUT) W $C(7),!!,"** THIS GREEN SHEET HAS NOT BEEN CORRECTED **",!!,"The status remains "_STATN,! G END
"RTN","PSDCOR2",42,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////8;11////"_NCOMP D ^DIE K DA,DIE,DR
"RTN","PSDCOR2",43,0)
 S STAT=+$P($G(^PSD(58.81,PSDA,0)),"^",11) W ?2,!,"*** Your Green Sheet #"_PSDPN_" is now ",!
"RTN","PSDCOR2",44,0)
 S COMP=+$P($G(^PSD(58.81,PSDA,0)),"^",12) W ?2,$S($P($G(^PSD(58.83,COMP,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDCOR2",45,0)
END K %,%DT,%H,%I,COMP,COMPN,CPBY,CPBYD,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT
"RTN","PSDCOR2",46,0)
 K NAOU,NAOUN,NCOMP,NCOMPN,OK,ORD,PSDA,PSDCOR,PSDPN,PSDR,PSDS,PSDSN,PSDUZ,RECDT,STAT,STATN,TYPE,X,Y
"RTN","PSDCOR2",47,0)
 Q
"RTN","PSDCOR3")
0^10^B2318115^B2229614
"RTN","PSDCOR3",1,0)
PSDCOR3 ;BIR/JPW-CS Correction Action (cont'd) ; 22 May 93
"RTN","PSDCOR3",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDCOR3",3,0)
COM ;complete correction
"RTN","PSDCOR3",4,0)
 S CPBYD=+$P(NODE,"^",19)
"RTN","PSDCOR3",5,0)
 F  L +^PSD(58.87,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDCOR3",6,0)
FIND S PSDCOR=$P(^PSD(58.87,0),"^",3)+1 I $D(^PSD(58.87,PSDCOR)) S $P(^PSD(58.87,0),"^",3)=PSDCOR G FIND
"RTN","PSDCOR3",7,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.87,DIC(0)="L",X=PSDCOR D ^DIC K DIC,DLAYGO
"RTN","PSDCOR3",8,0)
 L -^PSD(58.87,0)
"RTN","PSDCOR3",9,0)
 K DA,DIE,DR S DIE=58.87,DA=PSDCOR,DR="1////"_RECDT_";2////"_PSDUZ_";3////"_PSDPN_";4////"_PSDR_";5////"_NAOU_";7////"_CPBYD_";8////"_ORD_";9////"_CPBY_";11////"_TYPE_";12////"_PSDS_";13////"_OCOMP_";14////"_COMP
"RTN","PSDCOR3",10,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDCOR3",11,0)
END K CPBY,CPBYD,PSDCOR
"RTN","PSDCOR3",12,0)
 Q
"RTN","PSDDFP")
0^11^B21804424^B21641511
"RTN","PSDDFP",1,0)
PSDDFP ;BIR/JPW-Dispense from Pharmacy w/o Green Sheet ; 8 Aug 94
"RTN","PSDDFP",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**16,66**;13 Feb 97;Build 3
"RTN","PSDDFP",3,0)
 ;
"RTN","PSDDFP",4,0)
 ;References to ^PSD(58.8, supported by DBIA2711
"RTN","PSDDFP",5,0)
 ;References to ^PSDRUG( supported by DBIA #221
"RTN","PSDDFP",6,0)
 ;References to ^XUSEC("PSJ RPHARM" supported by DBIA #1095
"RTN","PSDDFP",7,0)
 ;
"RTN","PSDDFP",8,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDDFP",9,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)) W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"dispense narcotic supplies.",!!,"PSJ RPHARM security key required.",! Q
"RTN","PSDDFP",10,0)
 S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDDFP",11,0)
ASKD ;ask disp loc
"RTN","PSDDFP",12,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDDFP",13,0)
 I $P(PSDSITE,U,5) S ASK=$P($G(^PSD(58.8,+PSDS,0)),U,5) G CHKD
"RTN","PSDDFP",14,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDDFP",15,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDDFP",16,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDDFP",17,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),ASK=$P(Y(0),"^",5)
"RTN","PSDDFP",18,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDDFP",19,0)
CHKD I '$O(^PSD(58.8,PSDS,1,0)) W !!,"There are no stocked drugs for this Pharmacy Vault!!",!! G END
"RTN","PSDDFP",20,0)
DRUG ;select drug
"RTN","PSDDFP",21,0)
 S PSDOUT=0 W !
"RTN","PSDDFP",22,0)
 K DA,DIC S DIC("W")="W:$P(^PSDRUG(Y,0),""^"",9) ""   N/F"" I $P(^PSD(58.8,PSDS,1,Y,0),""^"",14)]"""",$P(^(0),""^"",14)'>DT W $C(7),""   *** INACTIVE ***"""
"RTN","PSDDFP",23,0)
 S DIC("S")="I '$P($G(^(7)),U,2)"
"RTN","PSDDFP",24,0)
 S DA(1)=+PSDS,DIC(0)="QEAMZ",DIC="^PSD(58.8,"_PSDS_",1," D ^DIC K DIC G:Y<0 END S PSDR=+Y,PSDRN=$P($G(^PSDRUG(+PSDR,0)),"^")
"RTN","PSDDFP",25,0)
 I '$D(^PSD(58.8,+PSDS,1,+PSDR,0)) W $C(7),!!,?10,"** Your Dispensing Site is missing stock drug data.",!,"Please contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDDFP",26,0)
 S (MFG,LOT,EXP,EXPD,NBKU,NPKG)="",MFG=$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",10),LOT=$P(^(0),"^",11),EXP=$P(^(0),"^",12),NBKU=$P(^(0),"^",8),NPKG=$P(^(0),"^",9)
"RTN","PSDDFP",27,0)
 I 'NPKG!(NBKU']"") W $C(7),!!,PSDRN," is missing breakdown unit or",!,"package size data in ",PSDSN,"." D MSG G END
"RTN","PSDDFP",28,0)
 I EXP S Y=EXP X ^DD("DD") S EXPD=Y
"RTN","PSDDFP",29,0)
 ;
"RTN","PSDDFP",30,0)
 ;DAVE B (PSD*3*16 - 28APR99) Move lock of 58.8,loc,1,drg up.
"RTN","PSDDFP",31,0)
 F  L +^PSD(58.8,+PSDS,1,+PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDDFP",32,0)
 S NBKU=$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",8),NPKG=+$P(^(0),"^",9)
"RTN","PSDDFP",33,0)
 I NBKU']"" W !!,PSDSN,"is missing narcotic breakdown unit",!,"for ",PSDRN,"." G END
"RTN","PSDDFP",34,0)
 I 'NPKG W !!,PSDSN,"is missing narcotic package size",!,"for ",PSDRN,"." G END
"RTN","PSDDFP",35,0)
NAOU ;select NAOU
"RTN","PSDDFP",36,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select NAOU: "
"RTN","PSDDFP",37,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"""
"RTN","PSDDFP",38,0)
 D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDDFP",39,0)
QTY K DA,DIR,DIRUT S DIR(0)="58.85,18O",DIR("B")=NPKG,DIR("A")="QUANTITY DISPENSED ("_NBKU_"/"_NPKG_")" D ^DIR K DIR I 'Y!$D(DIRUT) D MSG G END
"RTN","PSDDFP",40,0)
 S QTY=+Y I QTY>+$P(^PSD(58.8,PSDS,1,PSDR,0),"^",4) W !!,"The drug balance for this drug is ",+$P(^PSD(58.8,PSDS,1,PSDR,0),"^",4),".",!,"You cannot dispense ",QTY," for this drug.",!! G END
"RTN","PSDDFP",41,0)
ASKM I ASK D MFG I PSDOUT D MSG G END
"RTN","PSDDFP",42,0)
OK W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this OK? ",DIR("?",1)="Answer 'YES' to record dispensing this drug,"
"RTN","PSDDFP",43,0)
 S DIR("?")="NO to select another drug or '^' to quit." D ^DIR K DIR
"RTN","PSDDFP",44,0)
 I $D(DIRUT) D MSG G END
"RTN","PSDDFP",45,0)
 I 'Y D MSG G DRUG
"RTN","PSDDFP",46,0)
 D ^PSDDFP1 G:'PSDOUT DRUG
"RTN","PSDDFP",47,0)
END K %,%DT,%H,%I,ASK,BAL,DA,DIC,DIE,DIK,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT,EDIT,EXP,EXPD,LOT,MFG,NAOU,NAOUN,NBKU,NPKG,OK
"RTN","PSDDFP",48,0)
 K PSDDT,PSDLES,PSDOUT,PSDREC,PSDRN,PSDSN,PSDUZ,PSDUZN,QTY,TEXP,TLOT,TMFG,X,Y
"RTN","PSDDFP",49,0)
 I $D(PSDS),$D(PSDR) L -^PSD(58.8,+PSDS,1,+PSDR)
"RTN","PSDDFP",50,0)
 K PSDS,PSDR
"RTN","PSDDFP",51,0)
 Q
"RTN","PSDDFP",52,0)
MFG K DA,DIR,DTOUT,DUOUT S DIR(0)="58.81,12O",DIR("B")=MFG D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDDFP",53,0)
 I Y]"",Y'=MFG S MFG=Y S $P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",10)=MFG
"RTN","PSDDFP",54,0)
 K DA,DIR,DTOUT,DUOUT S DIR(0)="58.81,13O",DIR("B")=LOT D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDDFP",55,0)
 I Y]"",Y'=LOT S LOT=Y S $P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",11)=LOT
"RTN","PSDDFP",56,0)
 K DA,DIR,DTOUT,DUOUT S DIR(0)="58.81,14O",DIR("B")=EXPD D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDDFP",57,0)
 I Y,Y'=EXP S EXP=Y W !!,"Updating Expiration Date data..." K DA,DIE,DR S DA=+PSDR,DA(1)=+PSDS,DIE="^PSD(58.8,"_DA(1)_",1,",DR="11///"_EXP D ^DIE K DA,DIE,DR W "done.",!!
"RTN","PSDDFP",58,0)
 Q
"RTN","PSDDFP",59,0)
MSG W !!,"** No action taken. **",!!
"RTN","PSDDFP",60,0)
 Q
"RTN","PSDDFP1")
0^12^B6658082^B6563857
"RTN","PSDDFP1",1,0)
PSDDFP1 ;BIR/JPW-Disp from Pharm w/o Green Sheet (cont'd) ; 2 Aug 93
"RTN","PSDDFP1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**16,66**;13 Feb 97;Build 3
"RTN","PSDDFP1",3,0)
 ;
"RTN","PSDDFP1",4,0)
 ;References to ^PSD(58.8, supported by DBIA2711
"RTN","PSDDFP1",5,0)
 ;References to ^PSD(58.81 are supported by DBIA2808
"RTN","PSDDFP1",6,0)
TRANS ;create a disp transaction
"RTN","PSDDFP1",7,0)
 W !!,"Creating a dispensing transaction..."
"RTN","PSDDFP1",8,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDDFP1",9,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDDFP1",10,0)
 K DA,DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDDFP1",11,0)
 L -^PSD(58.81,0)
"RTN","PSDDFP1",12,0)
ADD ;add info to your vault (58.8)
"RTN","PSDDFP1",13,0)
 W "vault activity" S:'$D(^PSD(58.8,PSDS,1,PSDR,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDDFP1",14,0)
 K DA,DIC,DD,DO S DIC(0)="L",DIC="^PSD(58.8,"_PSDS_",1,"_PSDR_",4,",DA(2)=PSDS,DA(1)=PSDR,(X,DINUM)=PSDREC D FILE^DICN K DIC,DD,DO
"RTN","PSDDFP1",15,0)
 ;monthly activity
"RTN","PSDDFP1",16,0)
 I '$D(^PSD(58.8,PSDS,1,PSDR,5,0)) S ^(0)="^58.801A^^"
"RTN","PSDDFP1",17,0)
 I '$D(^PSD(58.8,PSDS,1,PSDR,5,$E(DT,1,5)*100,0)) K DIC S DIC="^PSD(58.8,"_PSDS_",1,"_PSDR_",5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSDS,DA(1)=PSDR D ^DIC K DIC,DA,DINUM,DLAYGO
"RTN","PSDDFP1",18,0)
 K DA,DIE,DR S DIE="^PSD(58.8,"_PSDS_",1,"_PSDR_",5,",DA(2)=PSDS,DA(1)=PSDR,DA=$E(DT,1,5)*100,DR="9////^S X=$P($G(^(0)),""^"",6)+QTY" D ^DIE K DA,DIE,DR
"RTN","PSDDFP1",19,0)
UPDATE ;update transaction with activity # from 58.8
"RTN","PSDDFP1",20,0)
 W !!,?5,"Updating on-hand quantity..."
"RTN","PSDDFP1",21,0)
 ;
"RTN","PSDDFP1",22,0)
 ;DAVE B (PSD*3*16 -28APR99) Removed lock, because it is now
"RTN","PSDDFP1",23,0)
 ;in routine PSDDFP where the user selects the drug.
"RTN","PSDDFP1",24,0)
 ;F  L +^PSD(58.8,PSDS,1,PSDR,0):0 I  Q
"RTN","PSDDFP1",25,0)
 D NOW^%DTC S PSDDT=+%
"RTN","PSDDFP1",26,0)
 S BAL=$P(^PSD(58.8,PSDS,1,PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)-QTY
"RTN","PSDDFP1",27,0)
 L -^PSD(58.8,PSDS,1,PSDR,0) S $P(^PSD(58.81,PSDREC,0),"^",10)=BAL W "done.",!
"RTN","PSDDFP1",28,0)
 W !!,"Old Balance : ",BAL,?35,"New Balance: ",BAL-QTY
"RTN","PSDDFP1",29,0)
 W !!,"Updating your transaction history..."
"RTN","PSDDFP1",30,0)
 K DA,DIE,DR S DA=PSDREC,DIE=58.81
"RTN","PSDDFP1",31,0)
 S DR="1////2;2////"_PSDS_";4////"_PSDR_";3////"_PSDDT_";5////"_QTY_";9////"_BAL_";6////"_PSDUZ_";17////"_NAOU_";100////1" D ^DIE
"RTN","PSDDFP1",32,0)
 I ASK W "still updating..." K DR S DR="12///"_MFG_";13///"_LOT_";14///"_EXP D ^DIE
"RTN","PSDDFP1",33,0)
 K DA,DIE,DR W "done.",!!
"RTN","PSDDFP1",34,0)
END Q
"RTN","PSDDWK2")
0^13^B11959671^B11518632
"RTN","PSDDWK2",1,0)
PSDDWK2 ;BIR/JPW-Pharm Dispensing Worksheet (cont'd) ; 21 Jun 93
"RTN","PSDDWK2",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDDWK2",3,0)
PROC ;ver/proc req ord
"RTN","PSDDWK2",4,0)
 D CHK Q:PSDLES
"RTN","PSDDWK2",5,0)
 S TECH=$S($P($G(^PSD(58.85,PSDN,0)),"^",16):$P(^(0),"^",16),ACT="P":DUZ,1:"") I PSDT="" D NOW^%DTC S PSDT=+%
"RTN","PSDDWK2",6,0)
DISPN ;assign dsp #s
"RTN","PSDDWK2",7,0)
 G:$P($G(^PSD(58.85,PSDN,0)),"^",15) EDIT S FLAG=0,ORDS=$S(NEW:ORDS,1:PSDS),PSDAGN=$S(NEW:PSDAGN,1:PSDAG)
"RTN","PSDDWK2",8,0)
 I PSDAGN W !!,"Assigning Pharmacy Dispensing #...",! D AUTO Q:PSDOUT  G EDIT
"RTN","PSDDWK2",9,0)
ASKN K DIR,DIRUT S DIR(0)="N^1:999999999:0",DIR("A")="PHARMACY DISPENSING #",DIR("?")="Enter your narcotic control number for this order." D ^DIR K DIR
"RTN","PSDDWK2",10,0)
 I $D(DIRUT) W !!,"This order cannot be processed without a dispensing number.",!!,"Press <RET> to continue" R X:DTIME Q
"RTN","PSDDWK2",11,0)
 I +$O(^PSD(58.81,"D",Y,0)) W !!,"The number "_Y_" has previously been used as a dispensing number.",!,"Please select another number.",!! G ASKN
"RTN","PSDDWK2",12,0)
 S PSDPN=Y
"RTN","PSDDWK2",13,0)
EDIT ;edit/add ord
"RTN","PSDDWK2",14,0)
 S BAL=0 W !!,"PHARMACY DISPENSING # ",PSDPN,!
"RTN","PSDDWK2",15,0)
 K PSDREC I +$P($G(^PSD(58.85,PSDN,0)),"^",8) S PSDREC=$P(^(0),"^",8)
"RTN","PSDDWK2",16,0)
 W !!,"Accessing the order...",! D:'$D(PSDREC) ADD D:ACT="V" SUB
"RTN","PSDDWK2",17,0)
 W !,"Updating the transaction..."
"RTN","PSDDWK2",18,0)
 D UPDATE^PSDDWK3,MSG1
"RTN","PSDDWK2",19,0)
 Q
"RTN","PSDDWK2",20,0)
ADD ;find entry number
"RTN","PSDDWK2",21,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDDWK2",22,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDDWK2",23,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSDDWK2",24,0)
 L -^PSD(58.81,0)
"RTN","PSDDWK2",25,0)
 Q
"RTN","PSDDWK2",26,0)
AUTO ;select next available disp #
"RTN","PSDDWK2",27,0)
 K MSG I '$P($G(^PSD(58.8,+ORDS,2)),"^",4) S MSG=1 D MSG Q
"RTN","PSDDWK2",28,0)
 I $P($G(^PSD(58.8,+ORDS,2)),"^",3)'>$P($G(^PSD(58.8,+ORDS,2)),"^",4) S MSG=0 D MSG Q
"RTN","PSDDWK2",29,0)
 F  L +^PSD(58.8,+ORDS,2):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDDWK2",30,0)
ADDN S PSDPN=$P($G(^PSD(58.8,+ORDS,2)),"^",4)
"RTN","PSDDWK2",31,0)
 I +$O(^PSD(58.81,"D",PSDPN,0)) S $P(^PSD(58.8,+ORDS,2),"^",4)=PSDPN+1 G ADDN
"RTN","PSDDWK2",32,0)
 S $P(^PSD(58.8,+ORDS,2),"^",4)=PSDPN+1
"RTN","PSDDWK2",33,0)
 L -^PSD(58.8,+ORDS,2)
"RTN","PSDDWK2",34,0)
 Q
"RTN","PSDDWK2",35,0)
MSG ;prints message
"RTN","PSDDWK2",36,0)
 W $C(7),!!,"  Contact your Pharmacy Co-ordinator.",!,"  Your ""Dispensing #'s"" range has "_$S(MSG:"not been defined.",1:"been exceeded.") S PSDOUT=1
"RTN","PSDDWK2",37,0)
MSG1 W !!,"Press <RET> to continue" R X:DTIME
"RTN","PSDDWK2",38,0)
 I '$T!(X["^") S PSDOUT=1
"RTN","PSDDWK2",39,0)
 Q
"RTN","PSDDWK2",40,0)
SUB ;sub qty from dsp site
"RTN","PSDDWK2",41,0)
 F  L +^PSD(58.8,ORDS,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDDWK2",42,0)
 D NOW^%DTC S PSDT=+%
"RTN","PSDDWK2",43,0)
 S BAL=$P(^PSD(58.8,ORDS,1,PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)-QTY
"RTN","PSDDWK2",44,0)
 L -^PSD(58.8,ORDS,1,PSDR,0)
"RTN","PSDDWK2",45,0)
 W !!,"Old Balance : ",BAL,?35,"New Balance :",BAL-QTY,!!
"RTN","PSDDWK2",46,0)
 Q
"RTN","PSDDWK2",47,0)
CHK ;check for valid bal
"RTN","PSDDWK2",48,0)
 S PSDLES=0 D:QTY>$P(^PSD(58.8,ORDS,1,PSDR,0),"^",4)  Q:PSDLES
"RTN","PSDDWK2",49,0)
 .W $C(7),!!,"=>   The drug balance is "_+$P(^PSD(58.8,ORDS,1,PSDR,0),"^",4)_".  You cannot dispense "_QTY_" for this drug.",!,?5,"This order remains "_$P($G(^PSD(58.82,STAT,0)),"^")_".",! S PSDLES=1
"RTN","PSDDWK2",50,0)
 .D MSG1
"RTN","PSDDWK3")
0^14^B11893594^B11657444
"RTN","PSDDWK3",1,0)
PSDDWK3 ;BIR/JPW-Pharm Dispensing Worksheet (cont'd) ; 24 Aug 93
"RTN","PSDDWK3",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**16,66**;13 Feb 97;Build 3
"RTN","PSDDWK3",3,0)
 ;
"RTN","PSDDWK3",4,0)
 ;References to ^PSD(58.8, supported by DBIA2711
"RTN","PSDDWK3",5,0)
 ;References to ^PSD(58.81 are supported by DBIA2808
"RTN","PSDDWK3",6,0)
 ;
"RTN","PSDDWK3",7,0)
UPDATE ;set zero node in 58.81 - ien^type^disp^disp date^drug^qty^^^^bal.fwd^stat^^mfg^lot#^exp.date^^disp#^naou^^req#
"RTN","PSDDWK3",8,0)
 I $D(XRTL) D T0^%ZOSV
"RTN","PSDDWK3",9,0)
 S STAT=$S(ACT="V":3,1:2) I DUZ'=PSDBY,$D(^XUSEC("PSJ RPHARM",DUZ)),ACT="V" S TECH=PSDBY,PSDBY=DUZ
"RTN","PSDDWK3",10,0)
 ;
"RTN","PSDDWK3",11,0)
 ;DAVE B (PSD*3*16) Locking more nodes
"RTN","PSDDWK3",12,0)
 F  L +^PSD(58.81,PSDREC,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDDWK3",13,0)
 F  L +^PSD(58.8,ORDS,1,PSDR):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDDWK3",14,0)
 S ^PSD(58.81,PSDREC,0)=PSDREC_"^2^"_ORDS_"^"_$S(ACT="V":PSDT,1:"")_"^"_PSDR_"^"_QTY_"^^^^"_BAL_"^"_STAT_"^^"_MFG_"^"_LOT_"^"_EXP_"^^"_PSDPN_"^"_NAOU_"^^"_REQ
"RTN","PSDDWK3",15,0)
 ;set the 1, 2 and CS nodes in 58.81 and update xrefs - (1) proc.by^disp.date^^^tech^req.date^ordered by, (1.5) ordered by pharm, (2) comments, (CS) cs.trans
"RTN","PSDDWK3",16,0)
 S ^PSD(58.81,PSDREC,1)=PSDBY_"^^^^"_TECH_"^"_REQDT_"^"_ORD
"RTN","PSDDWK3",17,0)
 S $P(^PSD(58.81,PSDREC,"CS"),"^",1)=1
"RTN","PSDDWK3",18,0)
 S:$P($G(^PSD(58.85,PSDN,2)),U,2) $P(^PSD(58.81,PSDREC,"CS"),U,6)=1
"RTN","PSDDWK3",19,0)
 S:ACT="P" $P(^PSD(58.81,PSDREC,1),"^",2)=PSDT
"RTN","PSDDWK3",20,0)
 S:PSDUZA ^PSD(58.81,PSDREC,1.5)=PSDUZA
"RTN","PSDDWK3",21,0)
 S $P(^PSD(58.81,PSDREC,9),U)=$P($G(^PSD(58.85,PSDN,2)),U,3)
"RTN","PSDDWK3",22,0)
 I $D(^PSD(58.85,PSDN,1,0)) S ^PSD(58.81,PSDREC,2,0)=^PSD(58.85,PSDN,1,0) D
"RTN","PSDDWK3",23,0)
 .F WORD=0:0 S WORD=$O(^PSD(58.85,PSDN,1,WORD)) Q:'WORD  S ^PSD(58.81,PSDREC,2,WORD,0)=^PSD(58.85,PSDN,1,WORD,0)
"RTN","PSDDWK3",24,0)
 K DA,DIK S DA=PSDREC,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDDWK3",25,0)
 ;update vault
"RTN","PSDDWK3",26,0)
 W "vault activity..."
"RTN","PSDDWK3",27,0)
 I '$D(^PSD(58.8,ORDS,1,PSDR,4,0)) S ^(0)="^58.800119PA^^"
"RTN","PSDDWK3",28,0)
 I '$D(^PSD(58.8,ORDS,1,PSDR,4,PSDREC,0)) K DA,DIC,DD,DO S DIC(0)="L",DLAYGO=58.8,DIC="^PSD(58.8,"_ORDS_",1,"_PSDR_",4,",DA(2)=ORDS,DA(1)=PSDR,(X,DINUM)=PSDREC D FILE^DICN K DA,DIC,DINUM,DD,DO
"RTN","PSDDWK3",29,0)
MON ;monthly summary data
"RTN","PSDDWK3",30,0)
 I '$D(^PSD(58.8,ORDS,1,PSDR,5,0)) S ^(0)="^58.801A^^"
"RTN","PSDDWK3",31,0)
 I '$D(^PSD(58.8,ORDS,1,PSDR,5,$E(DT,1,5)*100,0)) K DIC S DIC="^PSD(58.8,"_ORDS_",1,"_PSDR_",5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=ORDS,DA(1)=PSDR D ^DIC K DIC,DA,DINUM,DLAYGO
"RTN","PSDDWK3",32,0)
 K DA,DIE,DR S DIE="^PSD(58.8,"_ORDS_",1,"_PSDR_",5,",DA(2)=ORDS,DA(1)=PSDR,DA=$E(DT,1,5)*100,DR="9////^S X=$P($G(^(0)),""^"",6)+QTY" D ^DIE K DA,DIE,DR
"RTN","PSDDWK3",33,0)
 ;update the entry in 58.85
"RTN","PSDDWK3",34,0)
 W "worksheet..."
"RTN","PSDDWK3",35,0)
 K DA,DIE,DR S DA=PSDN,DIE=58.85,DR="18////"_QTY_";16////"_PSDPN_";6////"_STAT_";Q;I X'=3 S Y=7;15////"_PSDT_";7////"_PSDREC_";17////"_TECH D ^DIE K DA,DIE,DR
"RTN","PSDDWK3",36,0)
 ;update the order in 58.8
"RTN","PSDDWK3",37,0)
 W "order..."
"RTN","PSDDWK3",38,0)
 K DA,DIE,DR S DA=REQ,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,"
"RTN","PSDDWK3",39,0)
 S DR="2////"_ORDS_";4////"_PSDBY_";10////"_STAT_";Q;I X'=3 S Y=7;14////"_PSDT_";7////"_MFG_";8////"_LOT_";9////"_EXP_";16////"_PSDPN_";17////"_PSDREC_";19////"_QTY D ^DIE K DA,DIE,DR
"RTN","PSDDWK3",40,0)
 W "done.",!!,"This order is now "_$P($G(^PSD(58.82,+STAT,0)),"^")_".",!
"RTN","PSDDWK3",41,0)
 I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV
"RTN","PSDDWK3",42,0)
 ;
"RTN","PSDDWK3",43,0)
 ;DAVE B (PSD*3*16) unlock locked nodes
"RTN","PSDDWK3",44,0)
 L -^PSD(58.81,PSDREC,0)
"RTN","PSDDWK3",45,0)
 L -^PSD(58.8,ORDS,1,PSDR)
"RTN","PSDDWK3",46,0)
 Q
"RTN","PSDDWK4")
0^15^B6269312^B6150283
"RTN","PSDDWK4",1,0)
PSDDWK4 ;BIR/JPW-Pharm Dispensing Worksheet (cont'd) ; 24 Aug 93
"RTN","PSDDWK4",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDDWK4",3,0)
CANC ;canc req ord
"RTN","PSDDWK4",4,0)
 I STAT>2 W !!,"This order is ",$P($G(^PSD(58.82,+STAT,0)),"^"),!,"and should be cancelled using the 'Edit Verified Order' option.",!!
"RTN","PSDDWK4",5,0)
 W ! S PSDOUT=0 K DIR,DIRUT,DUOUT S DIR(0)="YO",DIR("A")="Do you want to cancel this request order",DIR("B")="NO"
"RTN","PSDDWK4",6,0)
 S DIR("?",1)="Answer 'YES' to cancel this request order,",DIR("?")="answer 'NO' to leave this request active or '^' to quit." D ^DIR K DIR I $D(DUOUT) S PSDOUT=1 Q
"RTN","PSDDWK4",7,0)
 Q:PSDOUT  I 'Y W $C(7),!!,"No action taken.  This request order remains active.",!!,"Press <RET> to continue.",! R X:DTIME Q
"RTN","PSDDWK4",8,0)
 W !!,"Accessing your order information..."
"RTN","PSDDWK4",9,0)
 F  L +^PSD(58.8,+PSDS,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDDWK4",10,0)
 D NOW^%DTC S PSDT=+%
"RTN","PSDDWK4",11,0)
 S BAL=$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)
"RTN","PSDDWK4",12,0)
 L -^PSD(58.8,+PSDS,1,PSDR,0)
"RTN","PSDDWK4",13,0)
 K DA,DIE,DR S DIE=58.85,DA=PSDN,DR="6////9" D ^DIE K DA,DIE,DR
"RTN","PSDDWK4",14,0)
 K DA,DIE,DR S DA=+$P($G(^PSD(58.85,PSDN,0)),"^",5),DA(1)=+$P($G(^(0)),"^",4),DA(2)=+$P($G(^(0)),"^",3),DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////9;19////@" D ^DIE K DA,DIE,DR
"RTN","PSDDWK4",15,0)
 I +$P($G(^PSD(58.85,PSDN,0)),"^",8) K DA,DIE,DR S DA=$P(^(0),"^",8),DIE=58.81,DR="1////7;3////"_PSDT_";10////9;9////"_BAL D ^DIE K DA,DIE,DR W !!,?10,"Balance: ",BAL,!!
"RTN","PSDDWK4",16,0)
 S STAT=9 W !!,?10,"CANCELLED...",! I ANS="W" W !!,"Press <RET> to continue" R X:DTIME I '$T!(X["^") S PSDOUT=1
"RTN","PSDDWK4",17,0)
 Q
"RTN","PSDESTF")
0^16^B19562723^B19405534
"RTN","PSDESTF",1,0)
PSDESTF ;BIR/BJW-Add Non-CS Drug to Holding file ; 26 Feb 98
"RTN","PSDESTF",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,66**;13 Feb 97;Build 3
"RTN","PSDESTF",3,0)
 ;**Y2K compliance**;display 4 digit year on va forms
"RTN","PSDESTF",4,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDESTF",5,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)) W !!,"Please contact your Pharmacy Coordinator for access to",!,"destroy Controlled Substances.",!!,"PSJ RPHARM security key required.",! G END
"RTN","PSDESTF",6,0)
 S PSDUZ=DUZ,PSDOUT=0 D NOW^%DTC S PSDT=+$E(%,1,12)
"RTN","PSDESTF",7,0)
 W !!,?5,"NOTE: This Holding for Destruction transaction WILL NOT update your",!,?5,"Controlled Substances inventory balance.",!!
"RTN","PSDESTF",8,0)
ASKD ;ask disp location
"RTN","PSDESTF",9,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4) G:$P(PSDSITE,U,5) DEST
"RTN","PSDESTF",10,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDESTF",11,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDESTF",12,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDESTF",13,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDESTF",14,0)
DEST ;set up file 58.86
"RTN","PSDESTF",15,0)
 S PSDOUT=0,PSDCT=1
"RTN","PSDESTF",16,0)
 S (MFG,LOT,EXP)=""
"RTN","PSDESTF",17,0)
DIR ;ask free-text drug name
"RTN","PSDESTF",18,0)
 W !!,"You may create a free-text CS drug to place on hold for destruction.",!,"Your Dispensing Site inventory balance WILL NOT be updated.",!!
"RTN","PSDESTF",19,0)
 K DA,DIR,DIRUT S DIR(0)="58.86,13" D ^DIR K DA,DIR
"RTN","PSDESTF",20,0)
 I $D(DIRUT) D MSG G END
"RTN","PSDESTF",21,0)
 I Y']"" D MSG G END
"RTN","PSDESTF",22,0)
 S PSDRN=Y
"RTN","PSDESTF",23,0)
DIR2 K DA,DIR,DIRUT,DTOUT,DUOUT F PSDANS=2,4,11,12,18 S DIR(0)="58.86,"_PSDANS D ^DIR K DA,DIR D  I PSDOUT D MSG G END
"RTN","PSDESTF",24,0)
 .I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDESTF",25,0)
 .I PSDANS'=4,PSDANS'=18,Y']"" S PSDOUT=1 Q
"RTN","PSDESTF",26,0)
 .S PSD(PSDANS)=Y
"RTN","PSDESTF",27,0)
 .K DIRUT,DTOUT,DUOUT
"RTN","PSDESTF",28,0)
 ;DIR3 added 5/7/95 to add comments field
"RTN","PSDESTF",29,0)
DIR3 ;enter free-text information(comments)
"RTN","PSDESTF",30,0)
 W !!,"You may enter free-text info regarding drug placed on hold for destruction."
"RTN","PSDESTF",31,0)
 K DA,DIR,DIRUT S DIR(0)="58.86,14" D ^DIR K DA,DIR
"RTN","PSDESTF",32,0)
 I $D(DTOUT)!($D(DUOUT)) D MSG G END
"RTN","PSDESTF",33,0)
 S PSDCOMS=Y
"RTN","PSDESTF",34,0)
ASKY ;ask ok to continue
"RTN","PSDESTF",35,0)
 W !!,PSDRN," has been selected.",!
"RTN","PSDESTF",36,0)
 K DA,DIR,DIRUT S DIR(0)="YA",DIR("B")="NO",DIR("A")="Is this OK to create Holding for Destructions number? "
"RTN","PSDESTF",37,0)
 S DIR("?",1)="Answer 'YES' to create a Holding for Destruction number for this drug,",DIR("?")="answer 'NO' to create a different free-text CS drug, or '^' to quit."
"RTN","PSDESTF",38,0)
 D ^DIR K DIR I $D(DIRUT) D MSG G END
"RTN","PSDESTF",39,0)
 I 'Y G DIR
"RTN","PSDESTF",40,0)
 W !!,"Creating an entry in the Destructions file..."
"RTN","PSDESTF",41,0)
 F  L +^PSD(58.86,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDESTF",42,0)
 ;5/7/95 Fld 14 added, 7/28/95 Fld 18 added
"RTN","PSDESTF",43,0)
FIND S PSDHLD=$P(^PSD(58.86,0),"^",3)+1 I $D(^PSD(58.86,PSDHLD)) S $P(^PSD(58.86,0),"^",3)=PSDHLD G FIND
"RTN","PSDESTF",44,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.86,DIC(0)="L",(X,DINUM)=PSDHLD D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSDESTF",45,0)
 L -^PSD(58.86,0)
"RTN","PSDESTF",46,0)
 W !!,"Your Destructions Holding number is ",PSDHLD
"RTN","PSDESTF",47,0)
 K DA,DIE,DR S DIE=58.86,DA=PSDHLD,DR="13////"_PSDRN_";2////"_PSD(2)_";3////"_PSDUZ_";5////"_PSDT_";6////"_PSDS_";4////"_$S(+PSD(4):+PSD(4),1:"")_";11////"_+PSD(11)_";12////"_PSD(12)_";14////"_PSDCOMS_";18////"_+PSD(18)
"RTN","PSDESTF",48,0)
 D ^DIE K DIE,DA,DR
"RTN","PSDESTF",49,0)
 S RQTY=$P($G(^PSD(58.86,PSDHLD,0)),"^",3),PSDRN=$P($G(^(1)),"^")
"RTN","PSDESTF",50,0)
 S PSDOK=1
"RTN","PSDESTF",51,0)
PRINT ;print 2321
"RTN","PSDESTF",52,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! Q
"RTN","PSDESTF",53,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G PRINT
"RTN","PSDESTF",54,0)
 S Y=PSDT X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDESTF",55,0)
 S PG=0,RECDT=$E(PSDT,4,5)_"/"_$E(PSDT,6,7)_"/"_PSDYR I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3)
"RTN","PSDESTF",56,0)
 D ^PSDGSRV2
"RTN","PSDESTF",57,0)
END ;kill variables
"RTN","PSDESTF",58,0)
 K %,%DT,%H,%I,ALL,CNT,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT,EXP,EXP1,EXPD,LN,LOT,MFG,NUM
"RTN","PSDESTF",59,0)
 K PG,PSD,PSDANS,PSDCT,PSDCOMS,PSDHLD,PSDOK,PSDOUT,PSDRN,PSDS,PSDSN,PSDT,PSDUZ,PSDYR,RECDT,RPDT,RQTY,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDESTF",60,0)
 Q
"RTN","PSDESTF",61,0)
MSG W $C(7),!!,"WARNING: Holding for Destructions entry HAS NOT been created.",!!
"RTN","PSDESTF",62,0)
 Q
"RTN","PSDESTO")
0^17^B22602014^B22444825
"RTN","PSDESTO",1,0)
PSDESTO ;BIR/BJW-Add CS Non-Inv Drug to Holding file ; 28 Feb 98
"RTN","PSDESTO",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,32,66**;13 Feb 97;Build 3
"RTN","PSDESTO",3,0)
 ;**Y2K compliance**;display 4 digit year on va forms
"RTN","PSDESTO",4,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDESTO",5,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)) W !!,"Please contact your Pharmacy Coordinator for access to",!,"destroy Controlled Substances.",!!,"PSJ RPHARM security key required.",! G END
"RTN","PSDESTO",6,0)
 S PSDUZ=DUZ D NOW^%DTC S PSDT=+$E(%,1,12)
"RTN","PSDESTO",7,0)
 W !!,?5,"NOTE: This Holding for Destruction transaction WILL NOT update your",!,?5,"Controlled Substances inventory balance.",!!
"RTN","PSDESTO",8,0)
ASKD ;ask disp location
"RTN","PSDESTO",9,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4) G:$P(PSDSITE,U,5) DRUG
"RTN","PSDESTO",10,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0)"
"RTN","PSDESTO",11,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDESTO",12,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDESTO",13,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDESTO",14,0)
DRUG ;ask non-inv CS drug
"RTN","PSDESTO",15,0)
 W !!,"You may select a Controlled Substances drug to place on hold for destruction.",!,"Your Dispensing Site inventory balance WILL NOT be updated.",!!
"RTN","PSDESTO",16,0)
 K DA,DIC S DIC("A")="Select DRUG: ",DIC=50,DIC(0)="QEAM",DIC("S")="I $S('$D(^(""I"")):1,+^(""I"")>DT:1,1:0),$P($G(^(2)),""^"",3)[""N""" D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT)) END I Y<0 G RPTCPY
"RTN","PSDESTO",17,0)
 S PSDR=+Y,PSDRN=$P(Y,"^",2)
"RTN","PSDESTO",18,0)
DEST ;set up file 58.86
"RTN","PSDESTO",19,0)
 S PSDOUT=0,PSDCT=1
"RTN","PSDESTO",20,0)
 S (MFG,LOT,EXP)=""
"RTN","PSDESTO",21,0)
 ;7/27/95 Field 18 added, to prompt for patient name returning drugs.
"RTN","PSDESTO",22,0)
DIR2 K DA,DIR,DIRUT,DTOUT,DUOUT,PSD,PSDANS F PSDANS=2,4,11,12,18 S DIR(0)="58.86,"_PSDANS D ^DIR K DA,DIR D  I PSDOUT D MSG G END
"RTN","PSDESTO",23,0)
 .I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 Q
"RTN","PSDESTO",24,0)
 .I PSDANS'=4,PSDANS'=18,Y']"" S PSDOUT=1 Q
"RTN","PSDESTO",25,0)
 .S PSD(PSDANS)=Y
"RTN","PSDESTO",26,0)
 .K DIRUT,DTOUT,DUOUT
"RTN","PSDESTO",27,0)
 ;DIR was added for E3R# 3771
"RTN","PSDESTO",28,0)
DIR ;enter free-text information 
"RTN","PSDESTO",29,0)
 W !!,"You may enter free-text info regarding drug placed on hold for destruction."
"RTN","PSDESTO",30,0)
COM K DA,DIR,DIRUT S DIR(0)="58.86,14" D ^DIR K DA,DIR
"RTN","PSDESTO",31,0)
 I $D(DTOUT)!($D(DUOUT)) D MSG G END
"RTN","PSDESTO",32,0)
 S PSDCOMS=Y
"RTN","PSDESTO",33,0)
 I PSDCOMS[";" W !,"A semicolon is not allowed in the COMMENTS field. Please edit your entry.",! G COM
"RTN","PSDESTO",34,0)
ASKY ;ask ok to continue
"RTN","PSDESTO",35,0)
 W !!,PSDRN," has been selected.",!
"RTN","PSDESTO",36,0)
 K DA,DIR,DIRUT S DIR(0)="YA",DIR("B")="NO",DIR("A")="Is this OK to create Holding for Destructions number? "
"RTN","PSDESTO",37,0)
 S DIR("?",1)="Answer 'YES' to create a Holding for Destruction number for this drug,",DIR("?")="answer 'NO' to select a different CS drug or '^' to quit."
"RTN","PSDESTO",38,0)
 D ^DIR K DIR I $D(DIRUT) D MSG G END
"RTN","PSDESTO",39,0)
 I 'Y W !!,"Select a new CS drug to place on hold for destruction",!! G DRUG
"RTN","PSDESTO",40,0)
 W !!,"Creating an entry in the Destructions file..."
"RTN","PSDESTO",41,0)
 F  L +^PSD(58.86,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDESTO",42,0)
 ;Field 14 added for E3R# 3771,Fld 18 added 7/27/95
"RTN","PSDESTO",43,0)
FIND S PSDHLD=$P(^PSD(58.86,0),"^",3)+1 I $D(^PSD(58.86,PSDHLD)) S $P(^PSD(58.86,0),"^",3)=PSDHLD G FIND
"RTN","PSDESTO",44,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.86,DIC(0)="L",(X,DINUM)=PSDHLD D ^DIC K DIC,DLAYGO
"RTN","PSDESTO",45,0)
 L -^PSD(58.86,0)
"RTN","PSDESTO",46,0)
 W !!,"Your Destructions Holding number is ",PSDHLD
"RTN","PSDESTO",47,0)
 K DA,DIE,DR S DIE=58.86,DA=PSDHLD,DR="1////"_PSDR_";2////"_PSD(2)_";3////"_PSDUZ_";5////"_PSDT_";6////"_PSDS_";4////"_$S(+PSD(4):+PSD(4),1:"")_";11////"_+PSD(11)_";12////"_PSD(12)_";14////"_PSDCOMS_";18////"_+PSD(18)
"RTN","PSDESTO",48,0)
 D ^DIE K DIE,DA,DR
"RTN","PSDESTO",49,0)
 S RQTY=+$P($G(^PSD(58.86,PSDHLD,0)),"^",3)
"RTN","PSDESTO",50,0)
 S PSDOK=1
"RTN","PSDESTO",51,0)
TEMPX ;build temp file added june 96
"RTN","PSDESTO",52,0)
 S Y=PSDT X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDESTO",53,0)
 S PG=0,RECDT=$E(PSDT,4,5)_"/"_$E(PSDT,6,7)_"/"_PSDYR I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3)
"RTN","PSDESTO",54,0)
 S ^TMP("PSDESTO",$J,PSDHLD)=PSDHLD_"^"_RECDT_"^"_PSDRN_"^"_RQTY_"^"_PSDCOMS G DRUG
"RTN","PSDESTO",55,0)
RPTCPY ;ask # of report copies
"RTN","PSDESTO",56,0)
 I '$G(PSDHLD) G END
"RTN","PSDESTO",57,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! G END
"RTN","PSDESTO",58,0)
 I $G(NUM) D ^PSDGSRV2 G END
"RTN","PSDESTO",59,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G RPTCPY
"RTN","PSDESTO",60,0)
END ;kill variables
"RTN","PSDESTO",61,0)
 K %,%DT,%H,%I,ALL,CNT,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT,EXP,EXP1,EXPD,LN,LOT,MFG,NUM
"RTN","PSDESTO",62,0)
 K PG,PSD,PSDANS,PSDCOMS,PSDCT,PSDHLD,PSDOK,PSDOUT,PSDR,PSDRN,PSDS,PSDSN,PSDT,PSDUZ,PSDYR,RECDT,RPDT,RQTY,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDESTO",63,0)
 K ^TMP("PSDESTO",$J)
"RTN","PSDESTO",64,0)
 Q
"RTN","PSDESTO",65,0)
MSG W $C(7),!!,"WARNING: Holding for Destructions entry HAS NOT been created.",!!
"RTN","PSDESTO",66,0)
 Q
"RTN","PSDEVO")
0^18^B20846990^B20664997
"RTN","PSDEVO",1,0)
PSDEVO ;BIR/JPW,BJW-Edit/Cancel a Verified Order ; 20 Aug 98
"RTN","PSDEVO",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**10,66**;13 Feb 97;Build 3
"RTN","PSDEVO",3,0)
 ;nois:mar-1297-21575
"RTN","PSDEVO",4,0)
EN ;entry for edit/cancel verified order
"RTN","PSDEVO",5,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDEVO",6,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)) W !!,"Contact your Pharmacy Coordinator for access to edit or cancel",!,"a verified Controlled Substances order.",!!,"PSJ RPHARM security key required.",! G END
"RTN","PSDEVO",7,0)
 S PSDUZ=DUZ
"RTN","PSDEVO",8,0)
 W $C(7),!!,?18,"*** NOTE ***",!,?5,"Only Verified Orders with a status of FILLED - NOT DELIVERED",!,?5,"may be edited or cancelled.",!!
"RTN","PSDEVO",9,0)
ASKD ;ask disp site
"RTN","PSDEVO",10,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDEVO",11,0)
 G:$P(PSDSITE,U,5) GS
"RTN","PSDEVO",12,0)
 K DA,DIC S DIC=58.8,DIC("A")="Select Dispensing Site: ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)=""M"":1,$P(^(0),""^"",2)=""S"":1,1:0)"
"RTN","PSDEVO",13,0)
 S DIC(0)="QEA",DIC("B")=PSDSN
"RTN","PSDEVO",14,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDEVO",15,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDEVO",16,0)
GS ;ask gs #
"RTN","PSDEVO",17,0)
 K DA,DIC,NQTY S DIC=58.81,DIC("A")="Select Green Sheet #: ",DIC(0)="QEASZ",D="D"
"RTN","PSDEVO",18,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDS,$P(^(0),""^"",11)=3"
"RTN","PSDEVO",19,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y,QTY=$P(Y(0),"^",6),PSDPN=$P(Y(0),"^",17),PSDR=$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^"),ORD=$P(Y(0),"^",20),NAOU=$P(Y(0),"^",18)
"RTN","PSDEVO",20,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,0)) W !!,PSDRN," is not stocked in ",PSDSN,!! D MSG G END
"RTN","PSDEVO",21,0)
 S NBKU=$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",8),NPKG=$P(^(0),"^",9)
"RTN","PSDEVO",22,0)
 I 'NPKG!(NBKU']"") W !!,PSDRN," is missing breakdown unit or ",!,"package size data in ",PSDSN,".",!! D MSG G END
"RTN","PSDEVO",23,0)
 I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S NQTY=$P(^(4),"^",3)
"RTN","PSDEVO",24,0)
 W !!,"Drug: ",PSDRN,!,"     Quantity: ",$S($D(NQTY):NQTY,1:QTY),"    Breakdown Unit: ",NBKU,!!
"RTN","PSDEVO",25,0)
ASK ;edit or cancel
"RTN","PSDEVO",26,0)
 K DA,DIR,DIRUT S DIR("A")="ACTION (DC E): ",DIR(0)="SOBA^E:EDIT;DC:CANCEL"
"RTN","PSDEVO",27,0)
 S DIR("?",1)="Select 'E' to Edit this verified order, 'DC' to cancel",DIR("?")="or '^' to quit."
"RTN","PSDEVO",28,0)
 D ^DIR K DIR I $D(DIRUT) D MSG G END
"RTN","PSDEVO",29,0)
 S ANS=Y I ANS="DC" D CANC G END
"RTN","PSDEVO",30,0)
 I ANS="E" D ^PSDEVO1
"RTN","PSDEVO",31,0)
END K %,%DT,%H,%I,ANS,AQTY,BAL,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,FIELD,LOT,MFG,NAOU,NAOUN,NBKU,NPKG,NQTY,OK,ORD,OREC
"RTN","PSDEVO",32,0)
 K PSDA,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDSN,PSDT,PSDUZ,QTY,RECD,RECDT,RQTY,STAT,STATN,SUB,WK,X,Y
"RTN","PSDEVO",33,0)
 Q
"RTN","PSDEVO",34,0)
CANC ;canc ver ord
"RTN","PSDEVO",35,0)
 W !!,"Green Sheet # ",PSDPN,"  Quantity Dispensed: ",$S($D(NQTY):NQTY,1:QTY),"   Breakdown Unit: ",NBKU,!
"RTN","PSDEVO",36,0)
 K DA,DIR,DIRUT S DIR(0)="YOA",DIR("?",1)="Answer 'YES' to cancel this order and add the quantity",DIR("?")="back to your vault balance or '^' to quit."
"RTN","PSDEVO",37,0)
 S DIR("A")="Are you sure? " D ^DIR K DIR I $D(DIRUT) D MSG S PSDOUT=1 Q
"RTN","PSDEVO",38,0)
 I 'Y D MSG S PSDOUT=1 Q
"RTN","PSDEVO",39,0)
 S AQTY=$S($D(NQTY):NQTY,1:QTY)
"RTN","PSDEVO",40,0)
 W !!,"Accessing your transaction history..."
"RTN","PSDEVO",41,0)
 F  L +^PSD(58.8,+PSDS,1,+PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDEVO",42,0)
 D NOW^%DTC S PSDT=+%
"RTN","PSDEVO",43,0)
 S BAL=$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)+AQTY
"RTN","PSDEVO",44,0)
 L -^PSD(58.8,+PSDS,1,+PSDR,0) W !!,"Old Balance: ",BAL,?35,"New Balance :",BAL+AQTY,!!
"RTN","PSDEVO",45,0)
 W !!,"Updating your transaction history now..."
"RTN","PSDEVO",46,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81,DR="10////9;55////"_PSDT_";56////"_PSDUZ_";57///"_AQTY_";59////"_BAL_";58" D ^DIE K DA,DIE,DR
"RTN","PSDEVO",47,0)
 W !!,"Order record..." K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////9;19////@" D ^DIE K DA,DIE,DR
"RTN","PSDEVO",48,0)
 I +$O(^PSD(58.85,"AD",NAOU,PSDR,ORD,0)) W "worksheet..." S DA=+$O(^PSD(58.85,"AD",NAOU,PSDR,ORD,0)),DIE=58.85,DR="6////9" D ^DIE K DIE,DA,DR
"RTN","PSDEVO",49,0)
 ;Betty I'm commenting out the following line like we discussed
"RTN","PSDEVO",50,0)
 ;I $D(^PSD(58.8,NAOU,1,PSDR,0)) S $P(^(0),"^",4)=$P(^(0),"^",4)-AQTY
"RTN","PSDEVO",51,0)
MON ;monthly activity
"RTN","PSDEVO",52,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,0)) S ^(0)="^58.801A^^"
"RTN","PSDEVO",53,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,$E(DT,1,5)*100,0)) K DIC S DIC="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=+PSDS,DA(1)=PSDR D ^DIC K DIC,DA,DINUM,DLAYGO
"RTN","PSDEVO",54,0)
 K DA,DIE,DR S DIE="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DA(2)=+PSDS,DA(1)=PSDR,DA=$E(DT,1,5)*100,DR="11////^S X=$P($G(^(0)),""^"",7)+QTY" D ^DIE K DA,DIE,DR
"RTN","PSDEVO",55,0)
 W !!,"Finished.  Your Green Sheet # ",PSDPN," has been cancelled.",!!
"RTN","PSDEVO",56,0)
 Q
"RTN","PSDEVO",57,0)
MSG W !!,"** No action taken. **",!!
"RTN","PSDEVO",58,0)
 Q
"RTN","PSDEVO1")
0^19^B15175785^B15030044
"RTN","PSDEVO1",1,0)
PSDEVO1 ;BIR/JPW-Edit/Cancel a Verified Order (cont'd) ; 22 Jun 93
"RTN","PSDEVO1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDEVO1",3,0)
EN ;entry for edit verified order
"RTN","PSDEVO1",4,0)
 W !!,?5,"You may edit quantity, manufacturer, lot # and expiration date.",!,?5,"If you wish to edit drug or NAOU, you must cancel this order",!,?5,"and enter a new order.",!!
"RTN","PSDEVO1",5,0)
 I $D(NQTY) W !!,"This verified order has been previously edited.",!,"You must cancel this order and re-enter a new one.",!! D MSG S PSDOUT=1 Q
"RTN","PSDEVO1",6,0)
 K DA,DIR,DIRUT S DIR(0)="SO^Q:QUANTITY ONLY;M:MFG/LOT#/EXP.DATE ONLY;B:BOTH SETS OF FIELDS"
"RTN","PSDEVO1",7,0)
 S DIR("?",1)="Enter 'Q' to edit quantity only,",DIR("?",2)="Enter 'M' to edit mfg/lot #/exp.date only"
"RTN","PSDEVO1",8,0)
 S DIR("?")="Enter 'B' to edit both sets of fields or '^' to quit.",DIR("A")="Select fields to edit" D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 D MSG Q
"RTN","PSDEVO1",9,0)
 S FIELD=Y
"RTN","PSDEVO1",10,0)
UPDATE ;
"RTN","PSDEVO1",11,0)
 I FIELD="M" D NOW^%DTC S PSDT=+%,NQTY=QTY,AQTY=0,BAL=+$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",4) G DIE
"RTN","PSDEVO1",12,0)
NQ K DA,DIR,DTOUT,DUOUT S DIR(0)="58.81,50O",DIR("A")="NEW QUANTITY DISPENSED ("_NBKU_"/"_NPKG_")"
"RTN","PSDEVO1",13,0)
 S DIR("?",1)="Enter new quantity being dispensed or",DIR("?")="or '^' to quit" D ^DIR K DIR
"RTN","PSDEVO1",14,0)
 I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 D MSG Q
"RTN","PSDEVO1",15,0)
 S NQTY=+Y I +Y=0 W !!,"Sorry.  You've selected ZERO as the new dispensing balance.",!,"If the new balance is ZERO, please CANCEL this order." S PSDOUT=1 D MSG Q
"RTN","PSDEVO1",16,0)
 W !!,"Old Dispensed Quantity: ",QTY,"     New Dispensed Quantity: ",NQTY,! S AQTY=QTY-NQTY
"RTN","PSDEVO1",17,0)
 I ($P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",4)+AQTY)<0 W !!,"This transaction cannot be processed.",!,"Your vault balance is ",$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",4),"." D MSG Q
"RTN","PSDEVO1",18,0)
 K DA,DIR,DIRUT S DIR(0)="YOA",DIR("?",1)="Answer 'YES' to edit this order and adjust",DIR("?")="your vault balance, answer 'NO' or '^' to quit."
"RTN","PSDEVO1",19,0)
 S DIR("A")="Are you sure? ",DIR("B")="NO"
"RTN","PSDEVO1",20,0)
 D ^DIR K DIR I 'Y!$D(DIRUT) D MSG Q
"RTN","PSDEVO1",21,0)
 W !!,"Accessing your transaction information..."
"RTN","PSDEVO1",22,0)
 F  L +^PSD(58.8,+PSDS,1,+PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDEVO1",23,0)
 D NOW^%DTC S PSDT=+%
"RTN","PSDEVO1",24,0)
 S BAL=+$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)+AQTY
"RTN","PSDEVO1",25,0)
 L -^PSD(58.8,+PSDS,1,+PSDR,0)
"RTN","PSDEVO1",26,0)
 W !!,"Old Balance: ",BAL,?35,"New Balance: ",BAL+AQTY,!!
"RTN","PSDEVO1",27,0)
DIE W !,"Updating transaction history..."
"RTN","PSDEVO1",28,0)
 ;K DA,DIE,DR S DA=+PSDA,DIE=58.81,DR="48////"_PSDT_";49////"_PSDUZ_";50///"_NQTY_";51///"_AQTY_";54///"_BAL_";53;I FIELD=""Q"" S Y=""@1"";52////1;12;13;14;@1"
"RTN","PSDEVO1",29,0)
 K DA,DIE,DR S DA=+PSDA,DIE=58.81,DR="53;I FIELD=""Q"" S Y=48;52////1;12;13;14;48////"_PSDT_";49////"_PSDUZ_";50////"_NQTY_";51////"_AQTY_";54////"_BAL
"RTN","PSDEVO1",30,0)
 D ^DIE K DA,DIE,DR I $D(Y) S PSDOUT=1 D MSG Q
"RTN","PSDEVO1",31,0)
 S MFG=$P($G(^PSD(58.81,PSDA,0)),"^",13),LOT=$P($G(^(0)),"^",14),EXP=$P($G(^(0)),"^",15)
"RTN","PSDEVO1",32,0)
 W !,"Updating Order..."
"RTN","PSDEVO1",33,0)
ORDER K DA,DIE,DR S DA(1)=PSDR,DA(2)=NAOU,DA=ORD,DIE="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,"
"RTN","PSDEVO1",34,0)
 S DR="7///"_MFG_";8///"_LOT_";9///"_EXP_";19////"_NQTY D ^DIE K DA,DIE,DR
"RTN","PSDEVO1",35,0)
 I +$O(^PSD(58.85,"AC",3,NAOU,PSDR,ORD,0)) S WK=+$O(^PSD(58.85,"AC",3,NAOU,PSDR,ORD,0)) I $D(^PSD(58.85,WK,0)) S $P(^(0),"^",17)=NQTY
"RTN","PSDEVO1",36,0)
 W "done."
"RTN","PSDEVO1",37,0)
REPRT ;
"RTN","PSDEVO1",38,0)
 I $D(^PSD(58.81,PSDA,"CS")),+$P(^("CS"),"^",3) W !!,"The VA FORM 10-2321 has been previously printed for this order.",!,"Please use the 'Reprint VA FORM 10-2321' .",!!
"RTN","PSDEVO1",39,0)
 Q
"RTN","PSDEVO1",40,0)
MSG W !!,"** No action taken. **",!!
"RTN","PSDEVO1",41,0)
 Q
"RTN","PSDEXGS1")
0^20^B8308810^B8199321
"RTN","PSDEXGS1",1,0)
PSDEXGS1 ;BIR/JPW-Enter Existing GS (cont'd) ; 22 Jun 93
"RTN","PSDEXGS1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**33,66**;13 Feb 97;Build 3
"RTN","PSDEXGS1",3,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDEXGS1",4,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDEXGS1",5,0)
EN ;create order,transaction
"RTN","PSDEXGS1",6,0)
 W !!,"Creating entries in the CS files..."
"RTN","PSDEXGS1",7,0)
DIE ;create the order request
"RTN","PSDEXGS1",8,0)
 S:'$D(^PSD(58.8,NAOU,1,PSDRG,3,0)) ^(0)="^58.800118A^^"
"RTN","PSDEXGS1",9,0)
 S PSDRN=$P(^PSD(58.8,NAOU,1,PSDRG,3,0),"^",3)+1 I $D(^PSD(58.8,NAOU,1,PSDRG,3,PSDRN)) S $P(^PSD(58.8,NAOU,1,PSDRG,3,0),"^",3)=$P(^PSD(58.8,NAOU,1,PSDRG,3,0),"^",3)+1 G DIE
"RTN","PSDEXGS1",10,0)
 K DA,DIC,DIE,DD,DR,DO S DIC(0)="L",(DIC,DIE)="^PSD(58.8,"_NAOU_",1,"_PSDRG_",3,",DA(2)=NAOU,DA(1)=PSDRG,(X,DINUM)=PSDRN D FILE^DICN K DIC
"RTN","PSDEXGS1",11,0)
 D NOW^%DTC S PSDT=+$E(%,1,12) W "processing now..."
"RTN","PSDEXGS1",12,0)
 S DA=PSDRN,DA(1)=PSDRG,DA(2)=NAOU
"RTN","PSDEXGS1",13,0)
 S DR="2////"_+PSDS_";4////"_PHARM_";5///"_QTY_";6////"_NURS_";7///"_MFG_";8///"_LOT_";9///"_EXP_";14///"_RDATE_";16///"_PSDPN_";19///"_QTY_";20///"_QTY_";10////4" D ^DIE K DIE,DR
"RTN","PSDEXGS1",14,0)
 W "transaction history..."
"RTN","PSDEXGS1",15,0)
ADD ;find entry number
"RTN","PSDEXGS1",16,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDEXGS1",17,0)
FIND S PSDA=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDA)) S $P(^PSD(58.81,0),"^",3)=PSDA G FIND
"RTN","PSDEXGS1",18,0)
 K DA,DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDA D ^DIC K DIC,DLAYGO
"RTN","PSDEXGS1",19,0)
 L -^PSD(58.81,0)
"RTN","PSDEXGS1",20,0)
TRANS ;add trans fields
"RTN","PSDEXGS1",21,0)
 W !!,"Still updating..."
"RTN","PSDEXGS1",22,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81
"RTN","PSDEXGS1",23,0)
 S DR="1////12;2////"_+PSDS_";4////"_PSDRG_";3///"_PSDT_";Q;5////"_QTY_";12///"_MFG_";13///"_LOT_";14///"_EXP_";16///"_PSDPN_";17////"_NAOU_";18////"_PHARM_";20////"_NURS_";19///"_RDATE_";27////"_QTY_";40////"_PSDRN_";10////4;100////1"
"RTN","PSDEXGS1",24,0)
 ;DAVE B (PSD*3*33) Add field 103 to DIE call
"RTN","PSDEXGS1",25,0)
 S DR=DR_";103////"_PNT10
"RTN","PSDEXGS1",26,0)
 D ^DIE K DA,DIE,DR W "vault activity..."
"RTN","PSDEXGS1",27,0)
VAULT ;
"RTN","PSDEXGS1",28,0)
 S:'$D(^PSD(58.8,+PSDS,1,PSDRG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDEXGS1",29,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDRG,4,PSDA,0)) K DA,DIC,DD,DO S DIC(0)="L",DIC="^PSD(58.8,"_+PSDS_",1,"_PSDRG_",4,",DA(2)=+PSDS,DA(1)=PSDRG,(X,DINUM)=PSDA D FILE^DICN K DA,DIC
"RTN","PSDEXGS1",30,0)
 W "done.",!!
"RTN","PSDEXGS1",31,0)
 S $P(^PSD(58.8,NAOU,1,PSDRG,3,PSDRN,0),"^",17)=PSDA
"RTN","PSDEXGS1",32,0)
 W !!,"Press <RET> to continue" R X:DTIME W @IOF
"RTN","PSDEXGS1",33,0)
 Q
"RTN","PSDFIL2")
0^21^B21945086^B21401015
"RTN","PSDFIL2",1,0)
PSDFIL2 ;BIR/JPW,BJW-File TRAKKER Info - Vault Inv Adj ; 04 FEB 99
"RTN","PSDFIL2",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,3,19,66**;13 Feb 97;Build 3
"RTN","PSDFIL2",3,0)
 ;nois#:cla-0199-20993; no reference to DBIAS's needed
"RTN","PSDFIL2",4,0)
 ;**Y2K compliance**after FM patch DI*21*44 installed
"RTN","PSDFIL2",5,0)
EN1 ;entry for filing vault inventory adjustments trakker info
"RTN","PSDFIL2",6,0)
 K CNT,DA,DATA,DIC,DIR,DIROUT,DIRUT,DTOUT,DUOUT,PSDS,PSDSN,X,X1,Y
"RTN","PSDFIL2",7,0)
LOOP ;loop thru ^tmp
"RTN","PSDFIL2",8,0)
 K CNT S CNT=1
"RTN","PSDFIL2",9,0)
 W !!,"Updating DHCP now..."
"RTN","PSDFIL2",10,0)
 F PSD=0:0 S PSD=$O(^TMP("PSDWN2",$J,PSD)) Q:'PSD  S NODE=^TMP("PSDWN2",$J,PSD,0) D
"RTN","PSDFIL2",11,0)
 .;DAVE B (PSD*3*19 12MAY99) Added length check
"RTN","PSDFIL2",12,0)
 .I NODE'["*",$L(NODE,"^")=2 S PHARM=$P(NODE,"^") S:$E(PHARM)="P" PHARM=$P(PHARM,"P",2) S PHARM=$P(PHARM,"-")_$P(PHARM,"-",2)_$P(PHARM,"-",3) D  Q
"RTN","PSDFIL2",13,0)
 ..S PHARM=$S(PHARM]"":+$O(^VA(200,"SSN",PHARM,0)),1:"")
"RTN","PSDFIL2",14,0)
 ..S PSDTS=$P(NODE,">",2),X=$E(PSDTS,1,2) D ^%DT S PSDTS=$E(Y,1,3)_$E(PSDTS,4,5)_$E(PSDTS,7,8)_"."_$E(PSDTS,10,11)_$E(PSDTS,13,14)_$E(PSDTS,16,17),PSDTS=+PSDTS
"RTN","PSDFIL2",15,0)
 .I $L(NODE)<32,NODE["*" S PSDS=+$P(NODE,"*",2),PSDSN=$S($P($G(^PSD(58.8,PSDS,0)),"^")]"":$P($G(^(0)),"^"),1:"UNKNOWN") Q
"RTN","PSDFIL2",16,0)
 .S PHARM1=$P(NODE,"^"),PSDRN=$P(NODE,"^",3),OQTY=+$P(NODE,"^",4),QTY=+$P(NODE,"^",6),PHARM2=$P(NODE,"^",7)
"RTN","PSDFIL2",17,0)
 .S CQTY=+$P(NODE,"^",8),PSDTA=$P(NODE,"^",12)
"RTN","PSDFIL2",18,0)
 .S:$E(PHARM1)="P" PHARM1=$P(PHARM1,"P",2) S PHARM1=$P(PHARM1,"-")_$P(PHARM1,"-",2)_$P(PHARM1,"-",3),PHARM1=$S(PHARM1]"":+$O(^VA(200,"SSN",PHARM1,0)),1:"")
"RTN","PSDFIL2",19,0)
 .I PHARM2]"" S:$E(PHARM2)="P" PHARM2=$P(PHARM2,"P",2) S PHARM2=$P(PHARM2,"-")_$P(PHARM2,"-",2)_$P(PHARM2,"-",3),PHARM2=$S(PHARM2]"":+$O(^VA(200,"SSN",PHARM2,0)),1:"")
"RTN","PSDFIL2",20,0)
 .S PSDR=+$P(NODE,"^",2)
"RTN","PSDFIL2",21,0)
 .S X=$E(PSDTA,2,3) D ^%DT S PSDTA=$E(Y,1,3)_$E(PSDTA,5,6)_$E(PSDTA,8,9)_"."_$E(PSDTA,11,12)_$E(PSDTA,14,15)_$E(PSDTA,17,18),PSDTA=+PSDTA
"RTN","PSDFIL2",22,0)
 .S PSDTYP=$S('CQTY:20,1:9)
"RTN","PSDFIL2",23,0)
 .;I PSDTYP=9,CQTY=OQTY Q
"RTN","PSDFIL2",24,0)
 .I '$D(^TMP("PSDOK2",$J,19,+PSDR)) S ^TMP("PSDOK2",$J,19,+PSDR,+PSDTS,1)=19_"^"_PHARM_"^^^"
"RTN","PSDFIL2",25,0)
 .S ^TMP("PSDOK2",$J,+PSDTYP,+PSDR,+PSDTA,CNT)=PSDTYP_"^"_PHARM1_"^"_PHARM2_"^"_OQTY_"^"_CQTY
"RTN","PSDFIL2",26,0)
 .S CNT=CNT+1
"RTN","PSDFIL2",27,0)
FIL ;file data
"RTN","PSDFIL2",28,0)
 S PSD="" F PSD=19,9,20 D
"RTN","PSDFIL2",29,0)
 .S PSDR="" F  S PSDR=$O(^TMP("PSDOK2",$J,PSD,PSDR)) Q:PSDR=""  S PSDTA="" F  S PSDTA=$O(^TMP("PSDOK2",$J,PSD,PSDR,PSDTA)) Q:PSDTA=""  S CNT="" F  S CNT=$O(^TMP("PSDOK2",$J,PSD,PSDR,PSDTA,CNT)) Q:CNT=""  D
"RTN","PSDFIL2",30,0)
 ..S NODE=^TMP("PSDOK2",$J,PSD,+PSDR,+PSDTA,CNT),PSDTYP=+$P(NODE,"^"),PHARM1=$P(NODE,"^",2),PHARM2=$P(NODE,"^",3),OQTY=$P(NODE,"^",4),CQTY=$P(NODE,"^",5),QTY=$S(PSDTYP=9:CQTY-OQTY,1:0)
"RTN","PSDFIL2",31,0)
 ..S PHARMN1=$S($P($G(^VA(200,+PHARM1,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDFIL2",32,0)
 ..D UPDATE
"RTN","PSDFIL2",33,0)
 W "done.",!
"RTN","PSDFIL2",34,0)
END ;kill variables
"RTN","PSDFIL2",35,0)
 K %,%DT,%H,%I,BAL,CQTY,DA,DIC,DIE,DIK,DINUM,DLAYGO,DR,JJ,NAOU,NODE,OK,OQTY
"RTN","PSDFIL2",36,0)
 K PHARM,PHARM1,PHARM2,PHARMN1,PAT,PSD,PSDER,PSDR,PSDREC,PSDRN,PSDS,PSDSN,PSDT,PSDTA,PSDTS,PSDTYP,QTY,X,Y
"RTN","PSDFIL2",37,0)
 K ^TMP("PSDWN2",$J)
"RTN","PSDFIL2",38,0)
 K ^TMP("PSDOK2",$J)
"RTN","PSDFIL2",39,0)
 Q
"RTN","PSDFIL2",40,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDFIL2",41,0)
 ;vault balance
"RTN","PSDFIL2",42,0)
 F  L +^PSD(58.8,+PSDS,1,+PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFIL2",43,0)
 D NOW^%DTC S PSDT=+%
"RTN","PSDFIL2",44,0)
 S BAL=$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)+QTY
"RTN","PSDFIL2",45,0)
 L -^PSD(58.8,+PSDS,1,+PSDR,0)
"RTN","PSDFIL2",46,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFIL2",47,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDFIL2",48,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDFIL2",49,0)
 L -^PSD(58.81,0)
"RTN","PSDFIL2",50,0)
EDIT ;edit new transaction in 58.81
"RTN","PSDFIL2",51,0)
 S ^PSD(58.81,PSDREC,0)=PSDREC_"^"_PSDTYP_"^"_+PSDS_"^"_$S(PSDTYP=19:PSDTS,1:PSDT)_"^"_PSDR_"^"_QTY_"^"_$S(PSDTYP=9:PHARM1,1:PHARM)_"^^^"_BAL_"^^^^^^"_$S(PSDTYP=9:"TRAKKER ADJUSTMENT",1:"TRAKKER INVENTORY")
"RTN","PSDFIL2",52,0)
 S:PSDTYP=9 ^PSD(58.81,PSDREC,9)="^^"_$S(PSDTYP=19:BAL,1:OQTY)_"^^^^"_CQTY_"^"_PHARM1_"^"_PHARM2_"^"_PSDTA
"RTN","PSDFIL2",53,0)
 S ^PSD(58.81,PSDREC,"CS")=1
"RTN","PSDFIL2",54,0)
 K DA,DIK S DA=PSDREC,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDFIL2",55,0)
 ;update vault
"RTN","PSDFIL2",56,0)
 I '$D(^PSD(58.8,+PSDS,1,+PSDR,4,0)) S ^(0)="^58.800119PA^^"
"RTN","PSDFIL2",57,0)
 I '$D(^PSD(58.8,+PSDS,1,+PSDR,4,+PSDREC,0)) K DA,DIC,DD,DO S DIC(0)="L",DIC="^PSD(58.8,"_+PSDS_",1,"_+PSDR_",4,",DA(2)=+PSDS,DA(1)=+PSDR,(X,DINUM)=PSDREC D FILE^DICN K DA,DIC,DD,D0
"RTN","PSDFIL2",58,0)
 I PSDTYP'=9 W "." Q
"RTN","PSDFIL2",59,0)
ERR ;err log update
"RTN","PSDFIL2",60,0)
 F  L +^PSD(58.89,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFIL2",61,0)
FIND9 S PSDER=$P(^PSD(58.89,0),"^",3)+1 I $D(^PSD(58.89,PSDER)) S $P(^PSD(58.89,0),"^",3)=PSDER G FIND9
"RTN","PSDFIL2",62,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.89,(X,DINUM)=PSDER D ^DIC K DIC,DLAYGO
"RTN","PSDFIL2",63,0)
 L -^PSD(58.89,0)
"RTN","PSDFIL2",64,0)
EDIT9 ;edit error log
"RTN","PSDFIL2",65,0)
 K DA,DIE,DR S DA=PSDER,DIE=58.89,DR="1////"_PSDREC_";2////"_PSDT_";6////"_+PSDS D ^DIE K DA,DIE,DR
"RTN","PSDFIL2",66,0)
 D ^PSDFILM
"RTN","PSDFIL2",67,0)
 W "."
"RTN","PSDFIL2",68,0)
 Q
"RTN","PSDFIL3")
0^22^B21323903^B20791280
"RTN","PSDFIL3",1,0)
PSDFIL3 ;BIR/JPW,BJW-File TRAKKER Info - Insp Inv Adj ; 24 Mar 98
"RTN","PSDFIL3",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,3,66**;13 Feb 97;Build 3
"RTN","PSDFIL3",3,0)
 ;Y2K compliance**after FM patch DI*21*44 installed
"RTN","PSDFIL3",4,0)
EN1 ;entry for filing vault inventory adjustments trakker info
"RTN","PSDFIL3",5,0)
 K CNT,DA,DATA,DIC,DIR,DIROUT,DIRUT,DTOUT,DUOUT,PSDS,PSDSN,X,X1,Y
"RTN","PSDFIL3",6,0)
LOOP ;loop thru ^tmp
"RTN","PSDFIL3",7,0)
 K CNT S CNT=1
"RTN","PSDFIL3",8,0)
 W !!,"Updating DHCP now..."
"RTN","PSDFIL3",9,0)
 F PSD=0:0 S PSD=$O(^TMP("PSDWN3",$J,PSD)) Q:'PSD  S NODE=^TMP("PSDWN3",$J,PSD,0) D
"RTN","PSDFIL3",10,0)
 .I $L(NODE)<32,NODE'["*" S PHARM=$P(NODE,"^") S:$E(PHARM)="I" PHARM=$P(PHARM,"I",2) S PHARM=$P(PHARM,"-")_$P(PHARM,"-",2)_$P(PHARM,"-",3) D  Q
"RTN","PSDFIL3",11,0)
 ..S PHARM=$S(PHARM]"":+$O(^VA(200,"SSN",PHARM,0)),1:"")
"RTN","PSDFIL3",12,0)
 ..S PSDTS=$P(NODE,"^",2),X=$E(PSDTS,2,3) D ^%DT S PSDTS=$E(Y,1,3)_$E(PSDTS,5,6)_$E(PSDTS,8,9)_"."_$E(PSDTS,11,12)_$E(PSDTS,14,15)_$E(PSDTS,17,18),PSDTS=+PSDTS
"RTN","PSDFIL3",13,0)
 .I $L(NODE)<32,NODE["*" S PSDS=+$P(NODE,"*",2),PSDSN=$S($P($G(^PSD(58.8,PSDS,0)),"^")]"":$P($G(^(0)),"^"),1:"UNKNOWN") Q
"RTN","PSDFIL3",14,0)
 .S PHARM1=$P(NODE,"^"),PSDRN=$P(NODE,"^",3),OQTY=+$P(NODE,"^",4),QTY=+$P(NODE,"^",6),PHARM2=$P(NODE,"^",7)
"RTN","PSDFIL3",15,0)
 .S CQTY=+$P(NODE,"^",8),PSDTA=$P(NODE,"^",12)
"RTN","PSDFIL3",16,0)
 .S:$E(PHARM1)="I" PHARM1=$P(PHARM1,"I",2) S PHARM1=$P(PHARM1,"-")_$P(PHARM1,"-",2)_$P(PHARM1,"-",3),PHARM1=$S(PHARM1]"":+$O(^VA(200,"SSN",PHARM1,0)),1:"")
"RTN","PSDFIL3",17,0)
 .I PHARM2]"" S:$E(PHARM2)="P" PHARM2=$P(PHARM2,"P",2) S PHARM2=$P(PHARM2,"-")_$P(PHARM2,"-",2)_$P(PHARM2,"-",3),PHARM2=$S(PHARM2]"":+$O(^VA(200,"SSN",PHARM2,0)),1:"")
"RTN","PSDFIL3",18,0)
 .S PSDR=+$P(NODE,"^",2)
"RTN","PSDFIL3",19,0)
 .S X=$E(PSDTA,2,3) D ^%DT S PSDTA=$E(Y,1,3)_$E(PSDTA,5,6)_$E(PSDTA,8,9)_"."_$E(PSDTA,11,12)_$E(PSDTA,14,15)_$E(PSDTA,17,18),PSDTA=+PSDTA
"RTN","PSDFIL3",20,0)
 .S PSDTYP=$S('CQTY:22,1:9)
"RTN","PSDFIL3",21,0)
 .;I PSDTYP=9,CQTY=OQTY Q
"RTN","PSDFIL3",22,0)
 .I '$D(^TMP("PSDOK3",$J,21,+PSDR)) S ^TMP("PSDOK3",$J,21,+PSDR,+PSDTS,1)=21_"^"_PHARM_"^^^"
"RTN","PSDFIL3",23,0)
 .S ^TMP("PSDOK3",$J,+PSDTYP,+PSDR,+PSDTA,CNT)=PSDTYP_"^"_PHARM1_"^"_PHARM2_"^"_OQTY_"^"_CQTY
"RTN","PSDFIL3",24,0)
 .S CNT=CNT+1
"RTN","PSDFIL3",25,0)
FIL ;file data
"RTN","PSDFIL3",26,0)
 S PSD="" F PSD=21,9,22 D
"RTN","PSDFIL3",27,0)
 .S PSDR="" F  S PSDR=$O(^TMP("PSDOK3",$J,PSD,PSDR)) Q:PSDR=""  S PSDTA="" F  S PSDTA=$O(^TMP("PSDOK3",$J,PSD,PSDR,PSDTA)) Q:PSDTA=""  S CNT="" F  S CNT=$O(^TMP("PSDOK3",$J,PSD,PSDR,PSDTA,CNT)) Q:CNT=""  D
"RTN","PSDFIL3",28,0)
 ..S NODE=^TMP("PSDOK3",$J,PSD,+PSDR,+PSDTA,CNT),PSDTYP=+$P(NODE,"^"),PHARM1=$P(NODE,"^",2),PHARM2=$P(NODE,"^",3),OQTY=$P(NODE,"^",4),CQTY=$P(NODE,"^",5),QTY=$S(PSDTYP=9:CQTY-OQTY,1:0)
"RTN","PSDFIL3",29,0)
 ..S PHARMN1=$S($P($G(^VA(200,+PHARM1,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDFIL3",30,0)
 ..D UPDATE
"RTN","PSDFIL3",31,0)
 W "done.",!
"RTN","PSDFIL3",32,0)
END ;kill variables
"RTN","PSDFIL3",33,0)
 K %,%DT,%H,%I,BAL,CQTY,DA,DIC,DIE,DIK,DINUM,DLAYGO,DR,JJ,NAOU,NODE,OK,OQTY
"RTN","PSDFIL3",34,0)
 K PHARM,PHARM1,PHARM2,PHARMN1,PAT,PSD,PSDER,PSDR,PSDREC,PSDRN,PSDS,PSDSN,PSDT,PSDTA,PSDTS,PSDTYP,QTY,X,Y
"RTN","PSDFIL3",35,0)
 K ^TMP("PSDWN3",$J)
"RTN","PSDFIL3",36,0)
 K ^TMP("PSDOK3",$J)
"RTN","PSDFIL3",37,0)
 Q
"RTN","PSDFIL3",38,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDFIL3",39,0)
 ;vault balance
"RTN","PSDFIL3",40,0)
 F  L +^PSD(58.8,+PSDS,1,+PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFIL3",41,0)
 D NOW^%DTC S PSDT=+%
"RTN","PSDFIL3",42,0)
 S BAL=$P(^PSD(58.8,+PSDS,1,+PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)+QTY
"RTN","PSDFIL3",43,0)
 L -^PSD(58.8,+PSDS,1,+PSDR,0)
"RTN","PSDFIL3",44,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFIL3",45,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDFIL3",46,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDFIL3",47,0)
 L -^PSD(58.81,0)
"RTN","PSDFIL3",48,0)
EDIT ;edit new transaction in 58.81
"RTN","PSDFIL3",49,0)
 S ^PSD(58.81,PSDREC,0)=PSDREC_"^"_PSDTYP_"^"_+PSDS_"^"_$S(PSDTYP=21:PSDTS,1:PSDT)_"^"_PSDR_"^"_QTY_"^"_$S(PSDTYP=9:PHARM1,1:PHARM)_"^^^"_BAL_"^^^^^^"_$S(PSDTYP=9:"TRAKKER ADJUSTMENT",1:"TRAKKER INVENTORY")
"RTN","PSDFIL3",50,0)
 S:PSDTYP=9 ^PSD(58.81,PSDREC,9)="^^"_$S(PSDTYP=21:BAL,1:OQTY)_"^^^^"_CQTY_"^^^"_"^"_PSDTA_"^"_PHARM1_"^"_PHARM2
"RTN","PSDFIL3",51,0)
 S ^PSD(58.81,PSDREC,"CS")=1
"RTN","PSDFIL3",52,0)
 K DA,DIK S DA=PSDREC,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDFIL3",53,0)
 ;update vault
"RTN","PSDFIL3",54,0)
 I '$D(^PSD(58.8,+PSDS,1,+PSDR,4,0)) S ^(0)="^58.800119PA^^"
"RTN","PSDFIL3",55,0)
 I '$D(^PSD(58.8,+PSDS,1,+PSDR,4,+PSDREC,0)) K DA,DIC,DD,DO S DIC(0)="L",DIC="^PSD(58.8,"_+PSDS_",1,"_+PSDR_",4,",DA(2)=+PSDS,DA(1)=+PSDR,(X,DINUM)=PSDREC D FILE^DICN K DA,DIC
"RTN","PSDFIL3",56,0)
 I PSDTYP'=9 W "." Q
"RTN","PSDFIL3",57,0)
ERR ;err log update
"RTN","PSDFIL3",58,0)
 F  L +^PSD(58.89,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFIL3",59,0)
FIND9 S PSDER=$P(^PSD(58.89,0),"^",3)+1 I $D(^PSD(58.89,PSDER)) S $P(^PSD(58.89,0),"^",3)=PSDER G FIND9
"RTN","PSDFIL3",60,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.89,(X,DINUM)=PSDER D ^DIC K DIC,DLAYGO
"RTN","PSDFIL3",61,0)
 L -^PSD(58.89,0)
"RTN","PSDFIL3",62,0)
EDIT9 ;edit error log
"RTN","PSDFIL3",63,0)
 K DA,DIE,DR S DA=PSDER,DIE=58.89,DR="1////"_PSDREC_";2////"_PSDT_";6////"_+PSDS D ^DIE K DA,DIE,DR
"RTN","PSDFIL3",64,0)
 D ^PSDFILM
"RTN","PSDFIL3",65,0)
 W "."
"RTN","PSDFIL3",66,0)
 Q
"RTN","PSDFT")
0^23^B24748762^B24149359
"RTN","PSDFT",1,0)
PSDFT ;B'ham ISC/JPW,LTL - File NDES Info ; 26 June 95
"RTN","PSDFT",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDFT",3,0)
LOOP ;loop thru data from DFT message
"RTN","PSDFT",4,0)
 N NAOU,PSD,PSDPID,PSDPV1,PSDFT1,PSDZPM,PSDM,PSDTYP,NUR1,NUR2,PAT
"RTN","PSDFT",5,0)
 S PSDPID=$G(^HL(772,HLDA,"IN",3,0)),PSDPV1=$G(^HL(772,HLDA,"IN",4,0))
"RTN","PSDFT",6,0)
 S PSDFT1=$G(^HL(772,HLDA,"IN",5,0)),PSDZPM=$G(^HL(772,HLDA,"IN",6,0))
"RTN","PSDFT",7,0)
 S NAOU=$P($P(PSDPV1,HLFS,4),$E(HLECH))
"RTN","PSDFT",8,0)
 S NAOU(1)=0 F  S NAOU(1)=$O(^PSD(58.8,"AB",+NAOU,NAOU(1)))  Q:$P($G(^PSD(58.8,+NAOU(1),0)),U,2)="N"!('NAOU(1))
"RTN","PSDFT",9,0)
 S:'NAOU(1) PSDM(1)="* "_$S(NAOU']"":"No Ward Location",'$D(^DIC(42,+NAOU)):NAOU_" is not a valid Ward Location (IEN).",1:$P($G(^DIC(42,+NAOU,0)),U)_" is not linked to an NAOU.")
"RTN","PSDFT",10,0)
 S PSDTYP=$E($P(PSDFT1,HLFS,7)),PSDTYP(1)=$S(PSDTYP="D":17,PSDTYP="W":18,PSDTYP="R":3,PSDTYP="V":17,1:"")
"RTN","PSDFT",11,0)
 S:'PSDTYP(1) PSDM(2)="* "_$S(PSDTYP']"":"No type",1:PSDTYP_" is not a valid action,")_" must be (D)ispensed, (W)asted, or (R)eturned."
"RTN","PSDFT",12,0)
 S NUR1=$P(PSDFT1,HLFS,21),NUR1(1)=+NUR1
"RTN","PSDFT",13,0)
 S:'$D(^VA(200,NUR1(1),0)) PSDM(3)="* "_$S(NUR1(1):NUR1(1)_" is invalid ID",1:"No Nurse ID")_" for "_$S($P(NUR1,$E(HLECH),2)]"":$P(NUR1,$E(HLECH),2),1:"Unknown Nurse")
"RTN","PSDFT",14,0)
 S NUR2=$P(PSDZPM,HLFS,15),NUR2(1)=+NUR2
"RTN","PSDFT",15,0)
 S:PSDTYP="W"&('$D(^VA(200,NUR2(1),0))) PSDM(3.5)="* "_$S(NUR2(1):NUR2(1)_" is invalid witness ID",1:"No witness ID")_" for "_$S($P(NUR2,$E(HLECH),2)]"":$P(NUR2,$E(HLECH),2),1:"Unknown Witness")
"RTN","PSDFT",16,0)
 S PAT=+$P(PSDPID,HLFS,4)
"RTN","PSDFT",17,0)
 S:'$D(^DPT(PAT)) PSDM(4)="* "_$S(PAT:PAT_" is an invalid ID",1:"NO ID")_" for "_$S($P(PSDPID,HLFS,6)]"":$$FMNAME^HLFNC($P(PSDPID,HLFS,6)),1:"UNKNOWN PATIENT")
"RTN","PSDFT",18,0)
 S PSDR=$P(PSDFT1,HLFS,8)
"RTN","PSDFT",19,0)
 S:'$D(^PSD(58.8,+NAOU(1),1,+PSDR)) PSDM(5)="* Drug #"_$S($P(PSDR,$E(HLECH))]"":$P(PSDR,$E(HLECH))_" is not stocked,",1:"No drug ID")_" drug:  "_$S($P(PSDR,$E(HLECH),2)]"":$P(PSDR,$E(HLECH),2),1:"UNKNOWN DRUG")
"RTN","PSDFT",20,0)
 S QTY=+$P(PSDFT1,HLFS,11),NUR2="" S:PSDTYP(1)="R" QTY=-QTY
"RTN","PSDFT",21,0)
 S PSDT=$$FMDATE^HLFNC($P($G(^HL(772,HLDA,"IN",1,0)),HLFS,7))
"RTN","PSDFT",22,0)
 S Y=PSDT X ^DD("DD") S %DT="RX",(X,PSDT(1))=Y D ^%DT
"RTN","PSDFT",23,0)
 S:Y<1 PSDM(6)="* "_PSDT(1)_" is an not a valid date, exact date/time are required."
"RTN","PSDFT",24,0)
 D:$O(PSDM(0))
"RTN","PSDFT",25,0)
 .N PSD D KILL^XM
"RTN","PSDFT",26,0)
 .S XMSUB="Narcotic Dispensing Equipment System Error"
"RTN","PSDFT",27,0)
 .S XMDUZ="Interface Monitor"
"RTN","PSDFT",28,0)
 .D XMZ^XMA2 I XMZ<1 D KILL^XM Q
"RTN","PSDFT",29,0)
 .S XMY(DUZ)="",PSD=0
"RTN","PSDFT",30,0)
 .F  S PSD=$O(^XUSEC("PSD ERROR",PSD)) Q:'PSD  S XMY(PSD)=""
"RTN","PSDFT",31,0)
 .S PSDM(.1)="The following transmission did NOT update the Controlled Substances package:",PSDM(.2)=""
"RTN","PSDFT",32,0)
 .S:NAOU(1) PSDM(.3)="NAOU:  "_$P($G(^PSD(58.8,+NAOU(1),0)),U)
"RTN","PSDFT",33,0)
 .S:PSDTYP(1) PSDM(.4)="Transaction type:  "_$S("DV"[PSDTYP:"Dispensed",PSDTYP="R":"Returned",1:"Wasted")
"RTN","PSDFT",34,0)
 .S:'$D(PSDM(3)) PSDM(.5)="Nurse:  "_$P($G(^VA(200,+NUR1,0)),U)
"RTN","PSDFT",35,0)
 .S:PSDTYP="W"&('$D(PSDM(3.5))) PSDM(.51)="Witness:  "_$P($G(^VA(200,+NUR2,0)),U)
"RTN","PSDFT",36,0)
 .S:'$D(PSDM(4)) PSDM(.6)="Patient:  "_$P($G(^DPT(PAT,0)),U)
"RTN","PSDFT",37,0)
 .S:'$D(PSDM(5)) PSDM(.7)="Drug:  "_$P($G(^PSDRUG(+PSDR,0)),U)_"  QTY:  "_QTY
"RTN","PSDFT",38,0)
 .S:'$D(PSDM(6)) PSDM(.8)="Date/Time:  "_PSDT(1)
"RTN","PSDFT",39,0)
 .S PSDM(.9)="",PSDM(.91)="No update occurred to Controlled Substances",PSDM(.92)="because of the following discrepancy:",PSDM(.93)=""
"RTN","PSDFT",40,0)
 .S XMTEXT="PSDM(" D ^XMD,KILL^XM
"RTN","PSDFT",41,0)
 S QTY=-QTY
"RTN","PSDFT",42,0)
 D:QTY&('$D(PSDM)) UPDATE
"RTN","PSDFT",43,0)
 ;Send ack back
"RTN","PSDFT",44,0)
 S HLSDATA(2)="MSA"_HLFS_"AA"_HLFS_$P(HLSDATA(1),HLFS,10)_HLFS_"MESSAGE PROCESSED",HLEVN=1 D EN1^HLTRANS
"RTN","PSDFT",45,0)
END K %,%DT,%H,%I,BAL,CQTY,DA,DIC,DIE,DIK,DINUM,DLAYGO,DR,JJ,LQTY,NAOUN,NODE,OK,OQTY,ORD
"RTN","PSDFT",46,0)
 K PAT,PATL,PSD,PSDER,PSDPN,PSDR,PSDREC,PSDRN,PSDT,PSDTN,QTY,WQTY,X,Y
"RTN","PSDFT",47,0)
OP Q
"RTN","PSDFT",48,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDFT",49,0)
 ;updating drug balance in 58.8
"RTN","PSDFT",50,0)
 F  L +^PSD(58.8,+NAOU(1),1,+PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFT",51,0)
 D NOW^%DTC S PSDTN=+%
"RTN","PSDFT",52,0)
 S BAL=$P(^PSD(58.8,+NAOU(1),1,+PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)+QTY
"RTN","PSDFT",53,0)
 L -^PSD(58.8,+NAOU(1),1,+PSDR,0)
"RTN","PSDFT",54,0)
ADD ;find entry number in 58.81
"RTN","PSDFT",55,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFT",56,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDFT",57,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDFT",58,0)
 L -^PSD(58.81,0)
"RTN","PSDFT",59,0)
EDIT ;edit new transaction in 58.81
"RTN","PSDFT",60,0)
 S ^PSD(58.81,PSDREC,0)=PSDREC_"^"_PSDTYP(1)_"^"_+NAOU(1)_"^"_PSDT_"^"_+PSDR_"^"_QTY_"^^^^"_BAL_"^^^^^^^^"_+NAOU(1)_"^^"
"RTN","PSDFT",61,0)
 ;get specialty for patient
"RTN","PSDFT",62,0)
 S DFN=PAT,VAROOT="PSD" D INP^VADPT
"RTN","PSDFT",63,0)
 S ^PSD(58.81,PSDREC,9)=PAT_"^"_+NUR1_"^^"_$S(PSDTYP(1)=18:-QTY,1:"")_"^^"_NUR2_"^^^^^^^"_$P($G(^DIC(45.7,+PSD(3),0)),U,2)
"RTN","PSDFT",64,0)
 S ^PSD(58.81,PSDREC,"CS")=1
"RTN","PSDFT",65,0)
 K DA,DIK,PSD,VAERR S DA=PSDREC,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDFT",66,0)
 W "."
"RTN","PSDFT",67,0)
 Q
"RTN","PSDFT",68,0)
ERR ;err log update
"RTN","PSDFT",69,0)
 F  L +^PSD(58.89,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFT",70,0)
FIND9 S PSDER=$P(^PSD(58.89,0),"^",3)+1 I $D(^PSD(58.89,PSDER)) S $P(^PSD(58.89,0),"^",3)=PSDER G FIND9
"RTN","PSDFT",71,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.89,(X,DINUM)=PSDER D ^DIC K DIC,DLAYGO
"RTN","PSDFT",72,0)
 L -^PSD(58.89,0)
"RTN","PSDFT",73,0)
EDIT9 ;edit error log
"RTN","PSDFT",74,0)
 K DA,DIE,DR S DA=PSDER,DIE=58.89,DR="1////"_PSDREC_";2////"_PSDT_";6////"_NAOU D ^DIE K DA,DIE,DR
"RTN","PSDFT",75,0)
 D ^PSDFILM
"RTN","PSDFT",76,0)
 Q
"RTN","PSDFT1")
0^24^B30957426^B30254991
"RTN","PSDFT1",1,0)
PSDFT1 ;B'ham ISC/JPW,LTL - File NDES Info ; 26 June 95
"RTN","PSDFT1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDFT1",3,0)
DFT ;process the incoming message
"RTN","PSDFT1",4,0)
 N PSD,PSD1
"RTN","PSDFT1",5,0)
 F PSD=1:1 X HLNEXT Q:HLQUIT'>0  S PSD(PSD)=HLNODE,PSD1=0 F  S PSD1=$O(HLNODE(PSD1)) Q:'PSD1  S PSD1(PSD1)=HLNODE(PSD1)
"RTN","PSDFT1",6,0)
LOOP ;loop thru data from DFT message
"RTN","PSDFT1",7,0)
 N NAOU,PSDPID,PSDPV1,PSDFT1,PSDZPM,PSDM,PSDTYP,NUR1,NUR2,PAT
"RTN","PSDFT1",8,0)
 S PSDPID=$G(PSD(3)),PSDPV1=$G(PSD(4))
"RTN","PSDFT1",9,0)
 S PSDFT1=$G(PSD(5)),PSDZPM=$G(PSD(6))
"RTN","PSDFT1",10,0)
 I '$D(^PSDRUG(+$P(PSDFT1,HL("FS"),8),0)) G ACK
"RTN","PSDFT1",11,0)
 I $D(^PSDRUG(+$P(PSDFT1,HL("FS"),8),0)),$P($G(^PSDRUG(+$P(PSDFT1,HL("FS"),8),2)),U,3)'["N" G ACK
"RTN","PSDFT1",12,0)
 S (NAOU,NAOU(2))=$P($P(PSDPV1,HL("FS"),4),$E(HL("ECH")))
"RTN","PSDFT1",13,0)
 S:NAOU]"" NAOU=$O(^DIC(42,"B",NAOU,0))
"RTN","PSDFT1",14,0)
 I 'NAOU S DFN=+$P(PSDPID,HL("FS"),4) D INP^VADPT S NAOU=+VAIN(4) D KVA^VADPT
"RTN","PSDFT1",15,0)
 S NAOU(1)=0 F  S NAOU(1)=$O(^PSD(58.8,"AB",+NAOU,NAOU(1)))  Q:$P($G(^PSD(58.8,+NAOU(1),0)),U,2)="N"!('NAOU(1))
"RTN","PSDFT1",16,0)
 S:'NAOU(1) PSDM(1)="* "_$S(NAOU(2)']"":"No Ward Location",'NAOU!('$D(^DIC(42,+NAOU))):NAOU(2)_" is not a valid Ward Location.",1:$P($G(^DIC(42,+NAOU,0)),U)_" is not linked to an NAOU.")
"RTN","PSDFT1",17,0)
 S PSDTYP=$E($P(PSDFT1,HL("FS"),7)),PSDTYP(1)=$S(PSDTYP="D"!(PSDTYP="CHARGE"):17,PSDTYP="W":18,PSDTYP="R"!(PSDTYP="CREDIT"):3,PSDTYP="V":17,1:"")
"RTN","PSDFT1",18,0)
 S:'PSDTYP(1) PSDM(2)="* "_$S(PSDTYP']"":"No type",1:PSDTYP_" is not a valid action,")_" must be (D)ispensed, (W)asted, or (R)eturned."
"RTN","PSDFT1",19,0)
 S (X,NUR1)=$P($P(PSDFT1,HL("FS"),21),$E(HL("ECH")),2)
"RTN","PSDFT1",20,0)
NUR S DIC="^VA(200,",DIC(0)="M" D ^DIC S NUR1(1)=+Y
"RTN","PSDFT1",21,0)
 I Y<1 S X=$P(X,",") D ^DIC S NUR1(1)=+Y
"RTN","PSDFT1",22,0)
 K DIC
"RTN","PSDFT1",23,0)
 S:'$D(^VA(200,NUR1(1),0)) PSDM(3)="* No VA Nurse match for "_$S(NUR1]"":NUR1,1:"Unknown Nurse")
"RTN","PSDFT1",24,0)
 S (X,NUR2)=$P(PSDZPM,HL("FS"),16)
"RTN","PSDFT1",25,0)
 S DIC="^VA(200,",DIC(0)="M" D ^DIC S NUR2(1)=+Y
"RTN","PSDFT1",26,0)
 I Y<1 S X=$P(X,",") D ^DIC S NUR2(1)=+Y
"RTN","PSDFT1",27,0)
 K DIC
"RTN","PSDFT1",28,0)
 S:PSDTYP="W"&('$D(^VA(200,NUR2(1),0))) PSDM(3.5)="* No Va Witness match for "_$S(NUR2]"":NUR2,1:"Unknown Witness")
"RTN","PSDFT1",29,0)
 S PAT=+$P(PSDPID,HL("FS"),4)
"RTN","PSDFT1",30,0)
 S:'PAT!('$D(^DPT(PAT))) PSDM(4)="* "_$S(PAT:PAT_" is NOT a valid PATIENT ID",1:"NO PATIENT ID")_" for "_$S($P(PSDPID,HL("FS"),6)]"":$P(PSDPID,HL("FS"),6),1:"UNKNOWN PATIENT")
"RTN","PSDFT1",31,0)
 S:'$D(PSDM(4))&($P($G(^DPT(PAT,0)),U)'[$P($P(PSDPID,HL("FS"),6),U)) PSDM(4)="VA patient name: "_$P($G(^(0)),U)_" System name: "_$P(PSDPID,HL("FS"),6)
"RTN","PSDFT1",32,0)
 S PSDR=$P(PSDFT1,HL("FS"),8)
"RTN","PSDFT1",33,0)
 D:'+PSDR!('$D(^PSD(58.8,+NAOU(1),1,+PSDR)))&($G(PSDM(1))']"")
"RTN","PSDFT1",34,0)
 .S PSDM(5)="* Drug #"_$S($P(PSDR,$E(HL("ECH")))]"":$P(PSDR,$E(HL("ECH")))_" is not stocked,",1:"No drug ID")_" drug:  "_$S($P(PSDR,$E(HL("ECH")),2)]"":$P(PSDR,$E(HL("ECH")),2),1:"UNKNOWN DRUG")
"RTN","PSDFT1",35,0)
 S QTY=+$P(PSDFT1,HL("FS"),11),NUR2="" S:PSDTYP(1)="R" QTY=-QTY
"RTN","PSDFT1",36,0)
 S PSDT=$$FMDATE^HLFNC($G(HL("DTM")))
"RTN","PSDFT1",37,0)
 S Y=PSDT X ^DD("DD") S %DT="RX",(X,PSDT(1))=$P(Y,":",1,2) D ^%DT
"RTN","PSDFT1",38,0)
 S:Y=-1 PSDM(6)="* "_PSDT(1)_" is not a valid date, exact date/time are required."
"RTN","PSDFT1",39,0)
 D:$O(PSDM(0))
"RTN","PSDFT1",40,0)
 .N PSD D KILL^XM
"RTN","PSDFT1",41,0)
 .S XMSUB="Narcotic Dispensing Equipment System Error"
"RTN","PSDFT1",42,0)
 .S XMDUZ="Interface Monitor"
"RTN","PSDFT1",43,0)
 .D XMZ^XMA2 I XMZ<1 D KILL^XM Q
"RTN","PSDFT1",44,0)
 .S XMY(DUZ)="",PSD=0
"RTN","PSDFT1",45,0)
 .F  S PSD=$O(^XUSEC("PSD ERROR",PSD)) Q:'PSD  S XMY(PSD)=""
"RTN","PSDFT1",46,0)
 .S PSDM(.1)="The following transmission did NOT update the Controlled Substances package:",PSDM(.2)=""
"RTN","PSDFT1",47,0)
 .S:NAOU(1) PSDM(.3)="NAOU:  "_$P($G(^PSD(58.8,+NAOU(1),0)),U)
"RTN","PSDFT1",48,0)
 .S:PSDTYP(1) PSDM(.4)="Transaction type:  "_$S("DV"[PSDTYP:"Dispensed",PSDTYP="R":"Returned",1:"Wasted")
"RTN","PSDFT1",49,0)
 .S:'$D(PSDM(3)) PSDM(.5)="Nurse:  "_$P($G(^VA(200,+NUR1(1),0)),U)
"RTN","PSDFT1",50,0)
 .S:PSDTYP="W"&('$D(PSDM(3.5))) PSDM(.51)="Witness:  "_$P($G(^VA(200,+NUR2,0)),U)
"RTN","PSDFT1",51,0)
 .S:'$D(PSDM(4)) PSDM(.6)="Patient:  "_$P($G(^DPT(PAT,0)),U)
"RTN","PSDFT1",52,0)
 .S:'$D(PSDM(5)) PSDM(.7)="Drug:  "_$P($G(^PSDRUG(+PSDR,0)),U)_"  QTY:  "_QTY
"RTN","PSDFT1",53,0)
 .S:'$D(PSDM(6)) PSDM(.8)="Date/Time:  "_PSDT(1)
"RTN","PSDFT1",54,0)
 .S PSDM(.9)="",PSDM(.91)="No update occurred to Controlled Substances",PSDM(.92)="because of the following discrepancy:",PSDM(.93)=""
"RTN","PSDFT1",55,0)
 .S XMTEXT="PSDM(" D ^XMD,KILL^XM
"RTN","PSDFT1",56,0)
 S QTY=-QTY
"RTN","PSDFT1",57,0)
 ;D:QTY&('$D(PSDM)) UPDATE
"RTN","PSDFT1",58,0)
ACK ;Send ack back
"RTN","PSDFT1",59,0)
 S HLEID=HL("EID"),HLEIDS=HL("EIDS"),HLARYTYP="LM",HLFORMAT=1
"RTN","PSDFT1",60,0)
 S (HLRESLTA,HLMTIENA,HLP)=""
"RTN","PSDFT1",61,0)
 S HLA("HLA",1)="MSA"_HL("FS")_"AA"_HL("FS")_HL("MID")_HL("FS")_"MESSAGE PROCESSED"
"RTN","PSDFT1",62,0)
 D GENACK^HLMA1(HLEID,HLMTIENS,HLEIDS,HLARYTYP,HLFORMAT,.HLRESLTA,HLMTIENA,.HLP)
"RTN","PSDFT1",63,0)
END K %,%DT,%H,%I,BAL,CQTY,DA,DIC,DIE,DIK,DINUM,DLAYGO,DR,JJ,LQTY,NAOUN,NODE,OK,OQTY,ORD
"RTN","PSDFT1",64,0)
 K PAT,PATL,PSD,PSDER,PSDPN,PSDR,PSDREC,PSDRN,PSDT,PSDTN,QTY,WQTY,X,Y
"RTN","PSDFT1",65,0)
OP Q
"RTN","PSDFT1",66,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDFT1",67,0)
 ;updating drug balance in 58.8
"RTN","PSDFT1",68,0)
 F  L +^PSD(58.8,+NAOU(1),1,+PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFT1",69,0)
 D NOW^%DTC S PSDTN=+%
"RTN","PSDFT1",70,0)
 S BAL=$P(^PSD(58.8,+NAOU(1),1,+PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)+QTY
"RTN","PSDFT1",71,0)
 L -^PSD(58.8,+NAOU(1),1,+PSDR,0)
"RTN","PSDFT1",72,0)
ADD ;find entry number in 58.81
"RTN","PSDFT1",73,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFT1",74,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDFT1",75,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDFT1",76,0)
 L -^PSD(58.81,0)
"RTN","PSDFT1",77,0)
EDIT ;edit new transaction in 58.81
"RTN","PSDFT1",78,0)
 S ^PSD(58.81,PSDREC,0)=PSDREC_"^"_PSDTYP(1)_"^"_+NAOU(1)_"^"_PSDT_"^"_+PSDR_"^"_QTY_"^^^^"_BAL_"^^^^^^^^"_+NAOU(1)_"^^"
"RTN","PSDFT1",79,0)
 ;get specialty for patient
"RTN","PSDFT1",80,0)
 S DFN=PAT,VAROOT="PSD" D INP^VADPT
"RTN","PSDFT1",81,0)
 S ^PSD(58.81,PSDREC,9)=PAT_"^"_+NUR1_"^^"_$S(PSDTYP(1)=18:-QTY,1:"")_"^^"_NUR2_"^^^^^^^"_$P($G(^DIC(45.7,+PSD(3),0)),U,2)
"RTN","PSDFT1",82,0)
 S ^PSD(58.81,PSDREC,"CS")=1
"RTN","PSDFT1",83,0)
 K DA,DIK,PSD,VAERR S DA=PSDREC,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDFT1",84,0)
 W "."
"RTN","PSDFT1",85,0)
 Q
"RTN","PSDFT1",86,0)
ERR ;err log update
"RTN","PSDFT1",87,0)
 F  L +^PSD(58.89,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDFT1",88,0)
FIND9 S PSDER=$P(^PSD(58.89,0),"^",3)+1 I $D(^PSD(58.89,PSDER)) S $P(^PSD(58.89,0),"^",3)=PSDER G FIND9
"RTN","PSDFT1",89,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.89,(X,DINUM)=PSDER D ^DIC K DIC,DLAYGO
"RTN","PSDFT1",90,0)
 L -^PSD(58.89,0)
"RTN","PSDFT1",91,0)
EDIT9 ;edit error log
"RTN","PSDFT1",92,0)
 K DA,DIE,DR S DA=PSDER,DIE=58.89,DR="1////"_PSDREC_";2////"_PSDT_";6////"_NAOU D ^DIE K DA,DIE,DR
"RTN","PSDFT1",93,0)
 D ^PSDFILM
"RTN","PSDFT1",94,0)
 Q
"RTN","PSDNRGO")
0^27^B14945935^B14945935
"RTN","PSDNRGO",1,0)
PSDNRGO ;BIR/JPW-Receive Green Sheet for NAOU ; 6 Jan 94
"RTN","PSDNRGO",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDNRGO",3,0)
ORD S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNRGO",4,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^"),QTY=+$P(Y(0),"^",6),OK=1,PSDUZ=DUZ
"RTN","PSDNRGO",5,0)
 I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=$P(^(4),"^",3)
"RTN","PSDNRGO",6,0)
 I AOU'=NAOU W $C(7),!!,"The Green Sheet # ",PSDPN," is assigned to ",NAOUN,".",!,"Please select another Green Sheet.",! S PSDOUT=1 G END
"RTN","PSDNRGO",7,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! S PSDOUT=1 G END
"RTN","PSDNRGO",8,0)
 I STAT'=3 W $C(7),!!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please select another Green Sheet.",! S PSDOUT=1 G END
"RTN","PSDNRGO",9,0)
 D NOW^%DTC S (RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNRGO",10,0)
REC ;receive at order level in 58.8
"RTN","PSDNRGO",11,0)
 W !!,"Accessing ",PSDRN," information...",!!
"RTN","PSDNRGO",12,0)
 K DA,DIR,DIRUT S DIR(0)="58.81,27",DIR("B")=QTY D ^DIR K DIR I $D(DIRUT) W !!,"Quantity not entered.  No action taken.",!,"This order remains ",STATN,!! S PSDOUT=1 G END
"RTN","PSDNRGO",13,0)
 S RQTY=Y I RQTY'=QTY W $C(7),!!,"The quantity received does not match the quantity dispensed.",!,"This order must be returned to pharmacy for investigation.",!! S PSDOUT=1 G END
"RTN","PSDNRGO",14,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU
"RTN","PSDNRGO",15,0)
 S DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,"
"RTN","PSDNRGO",16,0)
 S DR=$S(OK=1:"6////"_PSDUZ,1:"6RECEIVED BY NURSE")_";20////"_QTY_";15////"_RECD_";10////4;22////"_$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)_";25////"_$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4) D ^DIE K DA,DIE,DR
"RTN","PSDNRGO",17,0)
 I ($D(Y))!($D(DTOUT)) W $C(7),!!,"*** THIS ORDER HAS NOT BEEN RECEIVED ***",!,"Receiving nurses name must be entered.",!!,"The status remains "_STATN,! S PSDOUT=1 G END
"RTN","PSDNRGO",18,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDNRGO",19,0)
 ;updating drug balance in 58.8
"RTN","PSDNRGO",20,0)
 ;F  L +^PSD(58.8,NAOU,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDNRGO",21,0)
 S:'$P($G(^PSD(58.81,PSDA,9)),U) $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)+QTY
"RTN","PSDNRGO",22,0)
 ;L -^PSD(58.8,NAOU,1,PSDR,0)
"RTN","PSDNRGO",23,0)
 ;update transaction file (58.81)
"RTN","PSDNRGO",24,0)
 S OREC=$P($G(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),"^",7)
"RTN","PSDNRGO",25,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81
"RTN","PSDNRGO",26,0)
 S DR="10////"_$S('$P($G(^PSD(58.8,NAOU,2)),U,5):4,$P($G(^PSD(58.81,PSDA,9)),U):4,1:13)_";20////"_OREC_";21////"_RECD_";27////"_QTY_";I OK=1 S Y=""@1"";15COMMENTS;@1"
"RTN","PSDNRGO",27,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDNRGO",28,0)
 I OK=2 S $P(^PSD(58.81,PSDA,1),"^",11)=PSDUZ
"RTN","PSDNRGO",29,0)
 W !!,"Updating your records now..."
"RTN","PSDNRGO",30,0)
 ;update worksheet file (58.85) to be purged
"RTN","PSDNRGO",31,0)
 S DA=+$O(^PSD(58.85,"AD",NAOU,PSDR,ORD,0)) I DA,$D(^PSD(58.85,DA,0)) K DIE,DR S DIE=58.85,DR="6////4" D ^DIE K DA,DIE,DR
"RTN","PSDNRGO",32,0)
 W "done.",!!
"RTN","PSDNRGO",33,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11) W ?5,"*** Your Green Sheet #"_PSDPN_" is now "_$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",! S NAOU(1)=1
"RTN","PSDNRGO",34,0)
END K %,%DT,%H,%I,AOUN,D,DA,DIC,DIE,DR,DTOUT,DUOUT
"RTN","PSDNRGO",35,0)
 K NAOUN,OK,OREC,PSDPN,PSDRN,PSDUZ,PSDUZN,QTY,RECD,RECDT,RQTY,STATN,SUB,PSDA,X,Y
"RTN","PSDNRGO",36,0)
 Q
"RTN","PSDNRGS")
0^28^B21669448^B21502719
"RTN","PSDNRGS",1,0)
PSDNRGS ;BIR/JPW-Receive Green Sheet for NAOU ; 6 Jan 94
"RTN","PSDNRGS",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**56,66**;13 Feb 97;Build 3
"RTN","PSDNRGS",3,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNRGS",4,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):2,$D(^XUSEC("PSJ PHARM TECH",DUZ)):2,1:0)
"RTN","PSDNRGS",5,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to complete",!,?12,"narcotic orders.",!!,"PSJ RNURSE, PSD NURSE, PSJ RPHARM, or PSJ PHARM TECH security key required.",! K OK Q
"RTN","PSDNRGS",6,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH Q
"RTN","PSDNRGS",7,0)
 W !!,"Receive Controlled Substances Orders and Green Sheet" S PSDUZ=DUZ,PSDUZN=$S($P($G(^VA(200,PSDUZ,0)),"^")]"":$P(^(0),"^"),1:"")
"RTN","PSDNRGS",8,0)
 N X,X1 D SIG^XUSESIG Q:X1=""
"RTN","PSDNRGS",9,0)
ASKN ;ask naou
"RTN","PSDNRGS",10,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select NAOU: "
"RTN","PSDNRGS",11,0)
 S:OK=1 DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNRGS",12,0)
 S:OK=2 DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"""
"RTN","PSDNRGS",13,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNRGS",14,0)
GS ;select green sheet #
"RTN","PSDNRGS",15,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNRGS",16,0)
 S DIC("S")="I $P(^(0),""^"",11),$P(^(0),""^"",11)<12"
"RTN","PSDNRGS",17,0)
 D IX^DIC K DIC G:Y<0 ASKN S PSDA=+Y
"RTN","PSDNRGS",18,0)
ORD S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNRGS",19,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^"),QTY=+$P(Y(0),"^",6)
"RTN","PSDNRGS",20,0)
 I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=$P(^(4),"^",3)
"RTN","PSDNRGS",21,0)
 I AOU'=NAOU W $C(7),!!,"The Green Sheet # ",PSDPN," is assigned to ",NAOUN,".",!,"Please select another Green Sheet.",! G GS
"RTN","PSDNRGS",22,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNRGS",23,0)
 I STAT'=3 W $C(7),!!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please select another Green Sheet.",! G GS
"RTN","PSDNRGS",24,0)
 D NOW^%DTC S (RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNRGS",25,0)
REC ;receive at order level in 58.8
"RTN","PSDNRGS",26,0)
 W !!,"Accessing ",PSDRN," information...",!!
"RTN","PSDNRGS",27,0)
 K DA,DIR,DIRUT S DIR(0)="58.81,27",DIR("B")=QTY D ^DIR K DIR I $D(DIRUT) W !!,"Quantity not entered.  No action taken.",!,"This order remains ",STATN,!! G END
"RTN","PSDNRGS",28,0)
 S RQTY=Y I RQTY'=QTY W $C(7),!!,"The quantity received does not match the quantity dispensed.",!,"This order must be returned to pharmacy for investigation.",!! G GS
"RTN","PSDNRGS",29,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU
"RTN","PSDNRGS",30,0)
 S DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,"
"RTN","PSDNRGS",31,0)
 S DR=$S(OK=1:"6////"_PSDUZ,1:"6RECEIVED BY NURSE")_";20////"_QTY_";15////"_RECD_";10////4;22////"_$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)_";25////"_$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4) D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",32,0)
 I ($D(Y))!($D(DTOUT)) W $C(7),!!,"*** THIS ORDER HAS NOT BEEN RECEIVED ***",!,"Receiving nurses name must be entered.",!!,"The status remains "_STATN,! G END
"RTN","PSDNRGS",33,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDNRGS",34,0)
 ;updating drug balance in 58.8
"RTN","PSDNRGS",35,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDNRGS",36,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDNRGS",37,0)
 S $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)+QTY
"RTN","PSDNRGS",38,0)
 L -^PSD(58.8,NAOU,1,PSDR,0)
"RTN","PSDNRGS",39,0)
 ;update transaction file (58.81)
"RTN","PSDNRGS",40,0)
 S OREC=$P($G(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),"^",7)
"RTN","PSDNRGS",41,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81
"RTN","PSDNRGS",42,0)
 S DR="10////"_$S('$P($G(^PSD(58.8,NAOU,2)),U,5):4,$P($G(^PSD(58.81,PSDA,9)),U):4,1:13)_";20////"_OREC_";21////"_RECD_";27////"_QTY_";I OK=1 S Y=""@1"";15COMMENTS;@1"
"RTN","PSDNRGS",43,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",44,0)
 I OK=2 S $P(^PSD(58.81,PSDA,1),"^",11)=PSDUZ
"RTN","PSDNRGS",45,0)
 W !!,"Updating your records now..."
"RTN","PSDNRGS",46,0)
 ;update worksheet file (58.85) to be purged
"RTN","PSDNRGS",47,0)
 S DA=+$O(^PSD(58.85,"AD",NAOU,PSDR,ORD,0)) I DA,$D(^PSD(58.85,DA,0)) K DIE,DR S DIE=58.85,DR="6////4" D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",48,0)
 W "done.",!!
"RTN","PSDNRGS",49,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11) W ?5,"*** Your Green Sheet #"_PSDPN_" is now "_$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNRGS",50,0)
 G GS
"RTN","PSDNRGS",51,0)
END K %,%DT,%H,%I,AOU,AOUN,D,DA,DIC,DIE,DR,DTOUT,DUOUT
"RTN","PSDNRGS",52,0)
 K NAOU,NAOUN,OK,ORD,OREC,PSDPN,PSDR,PSDRN,PSDUZ,PSDUZN,QTY,RECD,RECDT,RQTY,STAT,STATN,SUB,PSDA,X,Y
"RTN","PSDNRGS",53,0)
 Q
"RTN","PSDNTF")
0^29^B32655045^B32429867
"RTN","PSDNTF",1,0)
PSDNTF ;BIR/JPW-Transfer Green Sheet - From this NAOU ; 1 Mar 98
"RTN","PSDNTF",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,56,63,66**;13 Feb 97;Build 3
"RTN","PSDNTF",3,0)
 ;**Y2K compliance**;display 4 digit year on va forms
"RTN","PSDNTF",4,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNTF",5,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):1,1:0)
"RTN","PSDNTF",6,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to",!,?12,"transfer narcotic orders.",!!,"PSJ RNURSE, PSD NURSE, or PSJ RPHARM security key required.",! K OK Q
"RTN","PSDNTF",7,0)
 W !!,"Transfer a Green Sheet from this NAOU" S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDNTF",8,0)
ASKN ;ask transfer from naou
"RTN","PSDNTF",9,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer from NAOU: "
"RTN","PSDNTF",10,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTF",11,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNTF",12,0)
GS ;select green sheet #
"RTN","PSDNTF",13,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNTF",14,0)
 S DIC("S")="I $P(^(0),""^"",11)=4!($P(^(0),U,11)=13),$P(^(0),""^"",18)=AOU",DIC("W")="W "" "",$P($G(^PSDRUG($P(^(0),U,5),0)),U),"" => "",$P($G(^DPT(+$P($G(^PSD(58.81,Y,9)),U),0)),U)"
"RTN","PSDNTF",15,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDNTF",16,0)
 S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNTF",17,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^")
"RTN","PSDNTF",18,0)
 S MFG=$P(Y(0),"^",13),LOT=$P(Y(0),"^",14),EXP=$P(Y(0),"^",15),QTY=+$P(Y(0),"^",6),PSDS=+$P(Y(0),"^",3)
"RTN","PSDNTF",19,0)
 S NBKU=$P($G(^PSD(58.8,+PSDS,1,+PSDR,0)),"^",8)
"RTN","PSDNTF",20,0)
 I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=+$P(^(4),"^",3)
"RTN","PSDNTF",21,0)
 I AOU'=NAOU W !!,"The Green Sheet # ",PSDPN," does not reside on ",AOUN,".",!,"Please select another Green Sheet.",! G ASKN
"RTN","PSDNTF",22,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTF",23,0)
 I STAT'=4,STAT'=13 W !!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTF",24,0)
ASKT ;ask transfer to naou
"RTN","PSDNTF",25,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer To NAOU: "
"RTN","PSDNTF",26,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTF",27,0)
 D ^DIC K DIC G:Y<0 END S NAOUT=+Y,NAOUTN=$P(Y,"^",2)
"RTN","PSDNTF",28,0)
 I NAOUT=AOU W !!,"You may not transfer a Green Sheet to your NAOU!",!,"Please select another NAOU.",!! G ASKT
"RTN","PSDNTF",29,0)
 I QTY=1 S RQTY=1 W !,"Quantity to Transfer (",NBKU,"/1)",! G OK
"RTN","PSDNTF",30,0)
QTY ;
"RTN","PSDNTF",31,0)
 W !,"Quantity to Transfer ("_NBKU_"/"_QTY_"): " R X:DTIME I '$T!(X="^")!(X="") S PSDOUT=1 W !!,"**** No action taken. ****",!! G END
"RTN","PSDNTF",32,0)
 ;I X'?1.6N!(X=0) W !!,"Enter a whole number between 1 and ",QTY,! G QTY
"RTN","PSDNTF",33,0)
 I +X'=X!(X>999999)!(X'>0)!(X?.E1"."4N.N) D  G QTY
"RTN","PSDNTF",34,0)
 . W !!,"Enter a number between .01 and ",QTY,!
"RTN","PSDNTF",35,0)
 I X>QTY W $C(7),!!,"The quantity returned must not exceed "_QTY_"!",! G QTY
"RTN","PSDNTF",36,0)
 S RQTY=X
"RTN","PSDNTF",37,0)
OK ;if perpetual NAOU and not ordered for patient
"RTN","PSDNTF",38,0)
 D:QTY=1&('$P($G(^PSD(58.81,PSDA,9)),U))  G:$G(PSDOUT) END
"RTN","PSDNTF",39,0)
 .W !,PSDRN," Current Balance:  ",$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)," ",NBKU,!
"RTN","PSDNTF",40,0)
 .S DIR(0)="Y",DIR("A")="Is this a PCA syringe that has already been signed out for a patient",DIR("B")="Y",DIR("?")="If you answer no, your balance will be subtracted by one" D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDNTF",41,0)
 .Q:Y'=1
"RTN","PSDNTF",42,0)
 .S RQTY(1)=1
"RTN","PSDNTF",43,0)
 .S DIC="^DPT(",DIC(0)="AEMQ",DIC("A")="Scan/Enter Patient: "
"RTN","PSDNTF",44,0)
 .W ! D ^DIC K DIC I Y<1 S PSDOUT=1 W !!,"No action taken.",!! Q
"RTN","PSDNTF",45,0)
 .S PAT=+Y
"RTN","PSDNTF",46,0)
 ;ask ok to transfer
"RTN","PSDNTF",47,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Are you sure",DIR("B")="NO"
"RTN","PSDNTF",48,0)
 S DIR("?",1)="Answer 'YES' to transfer this Green Sheet to another NAOU or",DIR("?")="answer 'NO' to leave the Green Sheet status active on your NAOU."
"RTN","PSDNTF",49,0)
 D ^DIR K DIR G:$D(DIRUT) END G:'Y GS
"RTN","PSDNTF",50,0)
 D NOW^%DTC S (RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNTF",51,0)
COM ;complete at order level in 58.8
"RTN","PSDNTF",52,0)
 W !!,"Accessing ",PSDRN," information...",!!
"RTN","PSDNTF",53,0)
 S BQTY=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),"^",22):$P(^(0),"^",22)-RQTY,1:QTY-RQTY)
"RTN","PSDNTF",54,0)
 W !!,"Updating your records now..."
"RTN","PSDNTF",55,0)
 ;update transaction file (58.81)
"RTN","PSDNTF",56,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81,DR="64////"_RECD_";65////"_PSDUZ_";66////"_NAOUT_";70////"_RQTY_";10////10;73////"_$G(PAT) D ^DIE K DA,DIE,DR
"RTN","PSDNTF",57,0)
 I $D(Y)!$D(DTOUT) W $C(7),!!,"** THIS GREEN SHEET HAS NOT BEEN TRANSFERRED **",!!,"The status remains "_STATN,! G END
"RTN","PSDNTF",58,0)
 ;update order
"RTN","PSDNTF",59,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////10;22////"_BQTY D ^DIE K DA,DIE,DR
"RTN","PSDNTF",60,0)
 ;update naou bal
"RTN","PSDNTF",61,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDNTF",62,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDNTF",63,0)
 S:'$G(RQTY(1)) $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)-RQTY
"RTN","PSDNTF",64,0)
 W:$P($G(^PSD(58.8,NAOU,2)),U,5) !,PSDRN," Remaining Balance:  ",$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)," ",NBKU,!
"RTN","PSDNTF",65,0)
 L -^PSD(58.8,NAOU,1,PSDR,0)
"RTN","PSDNTF",66,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11)
"RTN","PSDNTF",67,0)
 W ?2,!,"*** The status of your Green Sheet #"_PSDPN_" is now",!,$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNTF",68,0)
PRINT ;print 2321
"RTN","PSDNTF",69,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! Q
"RTN","PSDNTF",70,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G PRINT
"RTN","PSDNTF",71,0)
 S Y=RECD X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDNTF",72,0)
 S (PG,PSDOUT)=0,REAS="",COMP=999,RECDT=$E(RECD,4,5)_"/"_$E(RECD,6,7)_"/"_PSDYR
"RTN","PSDNTF",73,0)
 I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3) S EXP=EXPD
"RTN","PSDNTF",74,0)
 D ^PSDGSRV2
"RTN","PSDNTF",75,0)
END K %,%DT,%H,%I,AOU,AOUN,BQTY,COMP,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXP1,EXPD,LOT,MFG
"RTN","PSDNTF",76,0)
 K NAOU,NAOUN,NAOUT,NAOUTN,NBKU,NUM,OK,ORD,PG,PSDA,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDUZ,PSDUZN,PSDYR,QTY,REAS,RECD,RECDT,RQTY,STAT,STATN,X,Y
"RTN","PSDNTF",77,0)
 Q
"RTN","PSDNTT1")
0^30^B16173482^B15874368
"RTN","PSDNTT1",1,0)
PSDNTT1 ;BIR/BJW-Transfer Green Sheet - Receive this NAOU ; 17 JUL 97
"RTN","PSDNTT1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**1,56,66**;13 Feb 97;Build 3
"RTN","PSDNTT1",3,0)
 ;rtn chg for nois#:pal-0697-60605,pth-0697-20147,sux-0597-42235
"RTN","PSDNTT1",4,0)
COM ;complete order and transaction
"RTN","PSDNTT1",5,0)
 S FLAG=0 D NOW^%DTC S PSDT=X,(RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNTT1",6,0)
 W !!,"Accessing ",PSDRGN," information...",!!
"RTN","PSDNTT1",7,0)
 I '$D(^PSD(58.8,+AOU,1,+PSDRG,0)) D DRUG
"RTN","PSDNTT1",8,0)
 W !!,"Updating your records now..."
"RTN","PSDNTT1",9,0)
DIE ;create the order request in 58.8
"RTN","PSDNTT1",10,0)
 ;7/25/97 inserted line 6 to update order status to "4" or "13"
"RTN","PSDNTT1",11,0)
 ;chged line 7 fr 10////4 to 10////_stat 
"RTN","PSDNTT1",12,0)
 S:'$D(^PSD(58.8,AOU,1,PSDRG,3,0)) ^(0)="^58.800118A^^"
"RTN","PSDNTT1",13,0)
 S PSDRN=$P(^PSD(58.8,AOU,1,PSDRG,3,0),"^",3)+1 I $D(^PSD(58.8,AOU,1,PSDRG,3,PSDRN)) S $P(^PSD(58.8,AOU,1,PSDRG,3,0),"^",3)=$P(^PSD(58.8,AOU,1,PSDRG,3,0),"^",3)+1 G DIE
"RTN","PSDNTT1",14,0)
 W "order..."
"RTN","PSDNTT1",15,0)
 K DA,DIC,DIE,DD,DR,DO S DIC(0)="L",(DIC,DIE)="^PSD(58.8,"_AOU_",1,"_PSDRG_",3,",DA(2)=AOU,DA(1)=PSDRG,(X,DINUM)=PSDRN D FILE^DICN K DIC
"RTN","PSDNTT1",16,0)
 S DA=PSDRN,DA(1)=PSDRG,DA(2)=AOU
"RTN","PSDNTT1",17,0)
 S STAT=$S(+$P($G(^PSD(58.8,AOU,2)),U,5):13,1:4)
"RTN","PSDNTT1",18,0)
 S DR="16////"_PSDPN_";14////"_PSDSP_";15////"_RECD_";2////"_+PSDS_";6////"_PSDUZ_";7////"_MFG_";8////"_LOT_";9////"_EXP_";10////"_STAT_";19////"_QTY_";20////"_RQTY_";22////"_RQTY
"RTN","PSDNTT1",19,0)
 D ^DIE K DIE,DR
"RTN","PSDNTT1",20,0)
 W "transaction..."
"RTN","PSDNTT1",21,0)
ADD ;find entry number in 58.81
"RTN","PSDNTT1",22,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDNTT1",23,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDNTT1",24,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDNTT1",25,0)
 L -^PSD(58.81,0)
"RTN","PSDNTT1",26,0)
EDIT ;edit new transaction in 58.81
"RTN","PSDNTT1",27,0)
 ;7/21/97 on line 1 deleted "4" in 11th piece,added stat
"RTN","PSDNTT1",28,0)
 ; added lines 1-2 to update order status to a "4" or "13"
"RTN","PSDNTT1",29,0)
 ; also added to line 4 to enter a 1 in "CS";4
"RTN","PSDNTT1",30,0)
 I $P($G(^PSD(58.81,PSDREC,0)),"^")
"RTN","PSDNTT1",31,0)
 S STAT=$S(+$P($G(^PSD(58.8,AOU,2)),U,5):13,1:4)
"RTN","PSDNTT1",32,0)
 S ^PSD(58.81,PSDREC,0)=PSDREC_"^5^"_PSDS_"^"_RECD_"^"_PSDRG_"^"_RQTY_"^^^^^"_STAT_"^^"_MFG_"^"_LOT_"^"_EXP_"^^"_PSDPN_"^"_AOU_"^^"_PSDRN
"RTN","PSDNTT1",33,0)
 S ^PSD(58.81,PSDREC,1)="^^"_PSDUZ_"^"_RECD_"^^^^"_RQTY
"RTN","PSDNTT1",34,0)
 S ^PSD(58.81,PSDREC,7)="^^^^^"_PSDA,^PSD(58.81,PSDREC,9)=PAT
"RTN","PSDNTT1",35,0)
 S ^PSD(58.81,PSDREC,"CS")=1,$P(^PSD(58.81,PSDREC,"CS"),"^",4)=1
"RTN","PSDNTT1",36,0)
 K DA,DIK S DA=PSDREC,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDNTT1",37,0)
 ;update new order and prev trans #
"RTN","PSDNTT1",38,0)
 S $P(^PSD(58.8,AOU,1,PSDRG,3,PSDRN,0),"^",17)=PSDREC
"RTN","PSDNTT1",39,0)
 S $P(^PSD(58.81,PSDA,7),"^",4)=RECD,$P(^(7),"^",5)=PSDUZ,$P(^(7),"^",3)=AOU
"RTN","PSDNTT1",40,0)
BAL ;update naou to balance
"RTN","PSDNTT1",41,0)
 F  L +^PSD(58.8,AOU,1,PSDRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDNTT1",42,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDNTT1",43,0)
 S $P(^PSD(58.8,AOU,1,PSDRG,0),"^",4)=$P(^PSD(58.8,AOU,1,PSDRG,0),"^",4)+RQTY
"RTN","PSDNTT1",44,0)
 L -^PSD(58.8,AOU,1,PSDRG,0)
"RTN","PSDNTT1",45,0)
COMP ;completed msg
"RTN","PSDNTT1",46,0)
 W "done.",!!
"RTN","PSDNTT1",47,0)
 S STAT=$P($G(^PSD(58.81,PSDREC,0)),"^",11)
"RTN","PSDNTT1",48,0)
 W ?2,!,"*** The status of your Green Sheet #"_PSDPN_" is now",!,?2,$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNTT1",49,0)
 G:'FLAG END
"RTN","PSDNTT1",50,0)
MSG ;send mail message
"RTN","PSDNTT1",51,0)
 K XMY,^TMP("PSDNTMSG",$J) S ^TMP("PSDNTMSG",$J,1,0)="CS PHARM Transfer Green Sheet between NAOUs",^TMP("PSDNTMSG",$J,2,0)="Transfer In Date: "_RECDT
"RTN","PSDNTT1",52,0)
 S ^TMP("PSDNTMSG",$J,3,0)=""
"RTN","PSDNTT1",53,0)
 S ^TMP("PSDNTMSG",$J,4,0)="Drug: "_PSDRGN_"      Green Sheet #"_PSDPN
"RTN","PSDNTT1",54,0)
 S ^TMP("PSDNTMSG",$J,5,0)="Transfer to: "_AOUN
"RTN","PSDNTT1",55,0)
 S ^TMP("PSDNTMSG",$J,6,0)="",^TMP("PSDNTMSG",$J,7,0)="This drug has been inactivated."
"RTN","PSDNTT1",56,0)
 S XMSUB="CS PHARM TRANSFER GREEN SHEET INACTIVATE DRUG",XMTEXT="^TMP(""PSDNTMSG"",$J,",XMDUZ="CONTROLLED SUBSTANCES PHARMACY"
"RTN","PSDNTT1",57,0)
 F JJ=0:0 S JJ=$O(^XUSEC("PSDMGR",JJ)) Q:'JJ  S XMY(JJ)=""
"RTN","PSDNTT1",58,0)
 S:'$D(XMY) XMY(.5)="" D ^XMD K XMY,^TMP("PSDNTMSG",$J)
"RTN","PSDNTT1",59,0)
END Q
"RTN","PSDNTT1",60,0)
DRUG ;add drug and inactivate it
"RTN","PSDNTT1",61,0)
 S:'$D(^PSD(58.8,AOU,1,0)) ^(0)="^58.8001IP^^"
"RTN","PSDNTT1",62,0)
 K DA,DIC,DIE,DD,DO S (DIC,DIE)="^PSD(58.8,"_AOU_",1,",(X,DINUM)=+PSDRG,DA(1)=AOU,DIC(0)="L" D FILE^DICN K DIC I Y<0 S PSDOUT=1 Q
"RTN","PSDNTT1",63,0)
 K DA,DR S DA=PSDRG,DA(1)=AOU,DR="13////"_PSDT_";14////O;14.5////TRANSFER FROM ANOTHER NAOU" D ^DIE K DA,DIE,DR
"RTN","PSDNTT1",64,0)
 S FLAG=1
"RTN","PSDNTT1",65,0)
 Q
"RTN","PSDOPT0")
0^31^B72940281^B74025382
"RTN","PSDOPT0",1,0)
PSDOPT0 ;BIR/JPW,LTL,BJW - Outpatient Rx Entry (cont'd) ; 22 Jun 98
"RTN","PSDOPT0",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**10,30,37,39,45,48,66**;13 Feb 97;Build 3
"RTN","PSDOPT0",3,0)
 ;Reference to PS(52.5 supported by DBIA #786
"RTN","PSDOPT0",4,0)
 ;Reference to PS(59.7 supported by DBIA #1930
"RTN","PSDOPT0",5,0)
 ;References to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDOPT0",6,0)
 ;References to file 58.81 are covered by DBIA #2808
"RTN","PSDOPT0",7,0)
 ;Reference to ^PSDRUG( supported by DBIA #221
"RTN","PSDOPT0",8,0)
 ;Reference to PSRX( supported by DBIA #986
"RTN","PSDOPT0",9,0)
 ;called by ^PSDOPT,mod.for nois#:tua-0498-32173
"RTN","PSDOPT0",10,0)
 ;08/02/2004 KAM PSD*3*45 Modification to stop posting of the same 
"RTN","PSDOPT0",11,0)
 ;                        partial multiple times
"RTN","PSDOPT0",12,0)
LOOP ;loop to find new, refills and partials
"RTN","PSDOPT0",13,0)
 W !!,"Accessing the prescription history..."
"RTN","PSDOPT0",14,0)
 N PSDOIN,PSDRXFD,PSDSUPN,PSDLBL S PSDOIN=+$P($G(^PS(59.7,1,49.99)),U,2)
"RTN","PSDOPT0",15,0)
 ;check for unposted refills not returned to stock and not in suspense
"RTN","PSDOPT0",16,0)
 S (RF,DAT)=0 F JJ=0:0 S JJ=$O(^PSRX(PSDRX,1,JJ)) Q:'JJ  I $D(^PSRX(PSDRX,1,JJ,0)),'$P(^(0),U,16),$P($G(^(0)),U)'<PSDOIN D
"RTN","PSDOPT0",17,0)
 .;checking for suspense
"RTN","PSDOPT0",18,0)
 .S PSDRXFD=$E($P(^PSRX(PSDRX,1,JJ,0),U),1,7)
"RTN","PSDOPT0",19,0)
 .S PSDSUPN=$O(^PS(52.5,"B",PSDRX,0))
"RTN","PSDOPT0",20,0)
 .I PSDSUPN,$D(^PS(52.5,"C",PSDRXFD,PSDSUPN)),$G(^PS(52.5,PSDSUPN,"P"))'=1 W !!,"Refill #",JJ," suspended." Q
"RTN","PSDOPT0",21,0)
 .S RXNUM("RF",JJ)=+^PSRX(PSDRX,1,JJ,0)_U_$P(^(0),U,4),$P(PSDSEL("RF",JJ),"^",1)=$P(RXNUM("RF",JJ),"^",1),$P(PSDSEL("RF",JJ),"^",2)=$P(RXNUM("RF",JJ),"^",2),$P(PSDSEL("RF",JJ),"^",3)=$P($G(PSDRX("RF",JJ)),"^",3) K PSDLBLP
"RTN","PSDOPT0",22,0)
 ;
"RTN","PSDOPT0",23,0)
 ;check for unposted partials not returned to stock or suspended
"RTN","PSDOPT0",24,0)
 ;
"RTN","PSDOPT0",25,0)
 S PRF=0 F JJ=0:0 S JJ=$O(^PSRX(PSDRX,"P",JJ)) Q:'JJ  I $D(^PSRX(PSDRX,"P",JJ,0)),'$P(^(0),U,16),$P($G(^(0)),U)'<PSDOIN D
"RTN","PSDOPT0",26,0)
 .;check for suspense
"RTN","PSDOPT0",27,0)
 .S PSDRXFD=$E($P(^PSRX(PSDRX,"P",JJ,0),U),1,7)
"RTN","PSDOPT0",28,0)
 .S PSDSUPN=$O(^PS(52.5,"B",PSDRX,0))
"RTN","PSDOPT0",29,0)
 .I PSDSUPN,$D(^PS(52.5,"C",PSDRXFD,PSDSUPN)),$G(^PS(52.5,PSDSUPN,"P"))'=1,($G(JJ)=$P(^PS(52.5,PSDSUPN,0),U,5)) W !!,"Partial #",JJ," suspended." Q
"RTN","PSDOPT0",30,0)
 .S RXNUM("PR",JJ)=+^PSRX(PSDRX,"P",JJ,0)_U_$P(^(0),U,4),$P(PSDSEL("PR",JJ),"^",1)=$P(RXNUM("PR",JJ),"^",1),$P(PSDSEL("PR",JJ),"^",2)=$P(RXNUM("PR",JJ),"^",2) K PSDLBL
"RTN","PSDOPT0",31,0)
 ;
"RTN","PSDOPT0",32,0)
 ;original returned to stock
"RTN","PSDOPT0",33,0)
 ;
"RTN","PSDOPT0",34,0)
 S:$P($G(^PSRX(+PSDRX,2)),U,15) PSDRX(1)=""
"RTN","PSDOPT0",35,0)
 ;Check for suspense
"RTN","PSDOPT0",36,0)
 I +$P($G(^PSRX(PSDRX,2)),U,2)'<PSDOIN S PSDRXFD=$P(^(2),U,2) D
"RTN","PSDOPT0",37,0)
 .S PSDSUPN=$O(^PS(52.5,"B",PSDRX,0))
"RTN","PSDOPT0",38,0)
 .I PSDSUPN,$D(^PS(52.5,"C",PSDRXFD,PSDSUPN)),$G(^PS(52.5,PSDSUPN,"P"))'=1 W !!,"Original suspended." S PSDRX(1)="" Q
"RTN","PSDOPT0",39,0)
PSDDAVE ;PSD*3*30 (Major overhaul, Dave B)
"RTN","PSDOPT0",40,0)
 ;PSDSEL("RF",#)=refill Date ^ QTY ^ posted (y/n) ^ released date
"RTN","PSDOPT0",41,0)
 ;PSDSEL("PR"  ''
"RTN","PSDOPT0",42,0)
 ;PSDSEL("OR"  same thing
"RTN","PSDOPT0",43,0)
 ;
"RTN","PSDOPT0",44,0)
 I '$D(PSDRX(1)) S $P(PSDSEL("OR"),"^",2)=$P(^PSRX(+PSDRX,0),"^",7) ;Quantity
"RTN","PSDOPT0",45,0)
 I $D(PSDRX("OR")) S $P(PSDSEL("OR"),"^",3)=1 ;Posted
"RTN","PSDOPT0",46,0)
 I $P($G(^PSRX(+PSDRX,2)),"^",13)'="" S Y=$P(^PSRX(+PSDRX,2),"^",13) X ^DD("DD") S $P(PSDSEL("OR"),"^",4)=Y ;released date
"RTN","PSDOPT0",47,0)
 I $D(PSDSEL("OR")),$P(PSDSEL("OR"),"^",3)'="",$P(PSDSEL("OR"),"^",4)'="" K PSDSEL("OR"),RXNUM("OR")
"RTN","PSDOPT0",48,0)
 S (PSDRF1,PSDPR1)=0
"RTN","PSDOPT0",49,0)
RFLCHK ;
"RTN","PSDOPT0",50,0)
 S PSDRF1=$O(PSDSEL("RF",PSDRF1)) G PRTLCHK:PSDRF1'>0 S DATA=PSDSEL("RF",PSDRF1)
"RTN","PSDOPT0",51,0)
 I $P($G(^PSRX(+PSDRX,1,PSDRF1,0)),"^",18)'="" S Y=$P(^(0),"^",18) X ^DD("DD") S $P(PSDSEL("RF",PSDRF1),"^",4)=Y ;Already released
"RTN","PSDOPT0",52,0)
 I $P(PSDSEL("RF",PSDRF1),"^",3)>0,$P(PSDSEL("RF",PSDRF1),"^",4)'="" K PSDSEL("RF",PSDRF1),RXNUM("RF",PSDRF1)
"RTN","PSDOPT0",53,0)
 G RFLCHK
"RTN","PSDOPT0",54,0)
 ;
"RTN","PSDOPT0",55,0)
PRTLCHK S PSDPR1=$O(PSDSEL("PR",PSDPR1)) G CHKALL:PSDPR1'>0
"RTN","PSDOPT0",56,0)
 ; 08/02/2004 PSD*3*45 Added next line
"RTN","PSDOPT0",57,0)
 I $D(PSDRX("PR",PSDPR1)) S $P(PSDSEL("PR",PSDPR1),"^",3)=1 ;Posted 
"RTN","PSDOPT0",58,0)
 I $P($G(^PSRX(+PSDRX,"P",PSDPR1,0)),"^",19)'="" S Y=$P(^(0),"^",19) X ^DD("DD") S $P(PSDSEL("PR",PSDPR1),"^",4)=Y
"RTN","PSDOPT0",59,0)
 I $P(PSDSEL("PR",PSDPR1),"^",3)>0,$P(PSDSEL("PR",PSDPR1),"^",4)'="" K PSDSEL("PR",PSDPR1),RXNUM("PR",PSDPR1)
"RTN","PSDOPT0",60,0)
 G PRTLCHK
"RTN","PSDOPT0",61,0)
 ;
"RTN","PSDOPT0",62,0)
CHKALL ;Check to see if any left to post or release
"RTN","PSDOPT0",63,0)
 I $G(PSDERR)=1 G ASKP^PSDOPT
"RTN","PSDOPT0",64,0)
 I $O(PSDSEL(0))="" W !!,"ALL FILLS FOR THIS PRESCRIPTION HAVE BEEN POSTED AND RELEASED." G ASKP^PSDOPT
"RTN","PSDOPT0",65,0)
 ;
"RTN","PSDOPT0",66,0)
 ;Check for DIR call
"RTN","PSDOPT0",67,0)
 S CNT=0 K DIR
"RTN","PSDOPT0",68,0)
 G CHK^PSDOPT
"RTN","PSDOPT0",69,0)
 ;
"RTN","PSDOPT0",70,0)
PSDRTS(PSDRX,PSDNUM,PSDSITE,PSDQTY) ; API for Outpatient Pharmacy; Patch PSD*3*30
"RTN","PSDOPT0",71,0)
 ; This subroutine is called each time an Rx is returned to stock
"RTN","PSDOPT0",72,0)
 ; in Outpatient Pharmacy. The code does the following:
"RTN","PSDOPT0",73,0)
 ; 1.Check Rx, quit if not a controlled substance.
"RTN","PSDOPT0",74,0)
 ; 2.Give the user the option to update the transaction and
"RTN","PSDOPT0",75,0)
 ;   balance details
"RTN","PSDOPT0",76,0)
 ;PSDCS = 1 is controlled subs/0 for not CS
"RTN","PSDOPT0",77,0)
 ;PSDRS = 1 they have key, ok to return to stock, 0 - no key
"RTN","PSDOPT0",78,0)
 ;Variables:
"RTN","PSDOPT0",79,0)
 ;PSDRX   = Prescription Number IEN
"RTN","PSDOPT0",80,0)
 ;PSDNUM  = O^0 = The letter O for original fill and the number0
"RTN","PSDOPT0",81,0)
 ;          R^# = The letter R for refill and # equal to refill #
"RTN","PSDOPT0",82,0)
 ;          P^# = The letter P for partial and # equal to partial #
"RTN","PSDOPT0",83,0)
 ;PSDSITE = Division
"RTN","PSDOPT0",84,0)
 ;PSDQTY  = Quantity being returned to stock
"RTN","PSDOPT0",85,0)
 ;
"RTN","PSDOPT0",86,0)
 ;PSD*3*30 Check for PSDMGR key
"RTN","PSDOPT0",87,0)
 S PSDRS=0 I $D(^XUSEC("PSDMGR",DUZ)) S PSDRS=1 ;possess key
"RTN","PSDOPT0",88,0)
1 ;begin process
"RTN","PSDOPT0",89,0)
 I $D(^PSD(58.81,"AOP",PSDRX)) D RTSCHK G RETERR:$G(PSDERR)>0
"RTN","PSDOPT0",90,0)
 S PSDOUT=0,RXNUM=$P($G(^PSRX(+PSDRX,0)),"^") ;Prescription Number
"RTN","PSDOPT0",91,0)
 S (RPDT,DAT)=$P($G(^PSRX(+PSDRX,2)),"^",2)
"RTN","PSDOPT0",92,0)
 S DFN=+$P($G(^PSRX(+PSDRX,0)),"^",2)
"RTN","PSDOPT0",93,0)
 S PSDS=$S($G(PSDSITE)["^":$P(PSDSITE,"^",3),1:PSDSITE)
"RTN","PSDOPT0",94,0)
 S PSDR=$P($G(^PSRX(+PSDRX,0)),"^",6) I $G(PSDR)'="" S PSDRN=$P($G(^PSDRUG(PSDR,0)),"^")
"RTN","PSDOPT0",95,0)
 ;Setup like balance adjustment
"RTN","PSDOPT0",96,0)
 S PSDRN=$S($G(PSDRN)="":"Unknown Drug "_PSDR,1:PSDRN)
"RTN","PSDOPT0",97,0)
 I $P($G(^PSDRUG(PSDR,2)),"^",3)'["N" S PSDCS=0 Q
"RTN","PSDOPT0",98,0)
 S PSDCS=1
"RTN","PSDOPT0",99,0)
 I $G(PSDRS)'>0 W !,"Sorry you do not possess the PSDMGR key" G RETERR
"RTN","PSDOPT0",100,0)
 ;
"RTN","PSDOPT0",101,0)
POSTED ;check to see if posted
"RTN","PSDOPT0",102,0)
 S (JJ,PSDPOST)=0
"RTN","PSDOPT0",103,0)
 F  S JJ=$O(^PSD(58.81,"AOP",+PSDRX,JJ)) Q:'JJ  I $D(^PSD(58.81,JJ,6)) D
"RTN","PSDOPT0",104,0)
 .S NODE6=$G(^PSD(58.81,JJ,6))
"RTN","PSDOPT0",105,0)
 .I $P(PSDNUM,"^",1)="R",$P(NODE6,"^",2)'="",$P(NODE6,"^",2)=$P(PSDNUM,"^",2) S PSDPOST=1 Q
"RTN","PSDOPT0",106,0)
 .I $P(PSDNUM,"^",1)="P",$P(NODE6,"^",4)'="",$P(NODE6,"^",4)=$P(PSDNUM,"^",2) S PSDPOST=1 Q
"RTN","PSDOPT0",107,0)
 .I $P(PSDNUM,"^",1)="O",$P(NODE6,"^",4)="",$P(NODE6,"^",2)="" S PSDPOST=1 Q
"RTN","PSDOPT0",108,0)
 ;
"RTN","PSDOPT0",109,0)
 ;now check to see if CMOP
"RTN","PSDOPT0",110,0)
 S X1=0 F  S X1=$O(^PSRX(+PSDRX,4,X1)) Q:X1=""  S DATA=$G(^PSRX(+PSDRX,4,X1,0)) D
"RTN","PSDOPT0",111,0)
 .I $P(PSDNUM,"^",1)="R",$P(DATA,"^",3)=$P(PSDNUM,"^",2) S PSDPOST=1 Q
"RTN","PSDOPT0",112,0)
 .I $P(PSDNUM,"^",1)="P",$P(DATA,"^",3)=$P(PSDNUM,"^",2) S PSDPOST=1 Q
"RTN","PSDOPT0",113,0)
 .I $P(PSDNUM,"^",1)="O",$P(DATA,"^",3)=$P(PSDNUM,"^",2) S PSDPOST=1 Q
"RTN","PSDOPT0",114,0)
 I $G(PSDPOST)'=1 W !!,"Could not find any posting information in the Controlled Substance package,",!,"balance cannot be updated",!
"RTN","PSDOPT0",115,0)
 ;
"RTN","PSDOPT0",116,0)
ESIG K X D SIG^XUSESIG I X["^" W !,"No signature code entered, RX not returned to stock." S RETSK=1 Q
"RTN","PSDOPT0",117,0)
 I X1="" W !,"An Electronic Signature Code is required to return a Controlled Substance RX to stock.",! G ESIG
"RTN","PSDOPT0",118,0)
ASK S DIR(0)="Y",DIR("A")="Do you want "_$G(PSDQTY)_" added to balance in the Narcotic vault",DIR("B")="Yes",DIR("?")="Answer Yes and the amount being returned to stock will be placed in inventory" D ^DIR K DIR I $D(DIRUT) G RETERR
"RTN","PSDOPT0",119,0)
 I +Y'>0 W !,"Nothing updated" G RETERR
"RTN","PSDOPT0",120,0)
LOCATION S DIC(0)="QEA",DIC="^PSD(58.8,",DIC("A")="Return Drug to which vault: "
"RTN","PSDOPT0",121,0)
 S DIC("S")="I ""MSN""[$P($G(^PSD(58.8,Y,0)),U,2)"
"RTN","PSDOPT0",122,0)
 D ^DIC K DIC
"RTN","PSDOPT0",123,0)
 I "MSN"'[$P($G(^PSD(58.8,+Y,0)),"^",2) W !,"Sorry, the location type must be a Master Vault, satellite or narcotic location." K Y G LOCATION
"RTN","PSDOPT0",124,0)
 I +Y'>0 W !,"No selection made, no balance adjusted." G RETERR
"RTN","PSDOPT0",125,0)
 S PSDS=+Y I '$D(^PSD(58.8,+PSDS,1,PSDR,0)) W !,"Sorry, the drug is not stocked in this vault." K PSDS G LOCATION
"RTN","PSDOPT0",126,0)
 S PSDBAL=$P($G(^PSD(58.8,+PSDS,1,PSDR,0)),"^",4) W !,"Previous Balance: ",$G(PSDBAL)_"    New Balance: "_($G(PSDBAL)+PSDQTY)
"RTN","PSDOPT0",127,0)
 W !,"Updating balances"
"RTN","PSDOPT0",128,0)
 F  L +^PSD(58.8,+PSDS,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDOPT0",129,0)
 D NOW^%DTC S PSDT=+%,BAL=+$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4),$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)=$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)+PSDQTY
"RTN","PSDOPT0",130,0)
 L -^PSD(58.8,+PSDS,1,PSDR,0) W "."
"RTN","PSDOPT0",131,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDOPT0",132,0)
FIND1 S PSDA=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDA)) S $P(^PSD(58.81,0),"^",3)=PSDA G FIND1
"RTN","PSDOPT0",133,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.81,DIC(0)="L",(X,DINUM)=PSDA D ^DIC K DIC,DLAYGO
"RTN","PSDOPT0",134,0)
 L -^PSD(58.81,0)
"RTN","PSDOPT0",135,0)
 S PSDNUM1=$P($G(PSDNUM),"^",2)
"RTN","PSDOPT0",136,0)
 S ^PSD(58.81,PSDA,0)=PSDA_"^3^"_+PSDS_"^"_PSDT_"^"_PSDR_"^"_PSDQTY_"^"_DUZ_"^^^"_BAL
"RTN","PSDOPT0",137,0)
 S ^PSD(58.81,PSDA,3)=PSDT_"^"_PSDQTY_"^"_"RX RETURNED TO STOCK"
"RTN","PSDOPT0",138,0)
 S ^PSD(58.81,PSDA,"CS")=1
"RTN","PSDOPT0",139,0)
 S ^PSD(58.81,PSDA,6)=PSDRX_"^"_$S($P(PSDNUM,"^")="R":PSDNUM1,1:"")_"^"_DAT_"^"_$S($P(PSDNUM,"^")="P":PSDNUM1,1:"")_"^"_RXNUM
"RTN","PSDOPT0",140,0)
 S DIK="^PSD(58.81,",DA=PSDA D IX^DIK K DA,DIC,DIK
"RTN","PSDOPT0",141,0)
DIE I '$D(^PSD(58.8,+PSDS,1,PSDR,4,0)) S ^(0)="^58.800119PA^^"
"RTN","PSDOPT0",142,0)
 K DA,DIC,DD,DO S DA(1)=PSDR,DA(2)=+PSDS,(X,DINUM)=PSDA,DIC(0)="L",DIC="^PSD(58.8,"_+PSDS_",1,"_PSDR_",4," D FILE^DICN K DIC,DINUM
"RTN","PSDOPT0",143,0)
 ;monthly activity
"RTN","PSDOPT0",144,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,0)) S ^(0)="^58.801A^^"
"RTN","PSDOPT0",145,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,$E(DT,1,5)*100,0)) K DA,DIC S DIC="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=+PSDS,DA(1)=PSDR D ^DIC K DA,DIC,DINUM,DLAYGO
"RTN","PSDOPT0",146,0)
 K DA,DIE,DR S DIE="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DA(2)=+PSDS,DA(1)=PSDR,DA=$E(DT,1,5)*100,DR="9////^S X=$P($G(^(0)),""^"",6)+PSDQTY" D ^DIE K DA,DIE,DR
"RTN","PSDOPT0",147,0)
RETERR Q
"RTN","PSDOPT0",148,0)
RTSCHK ;Check to see if already returned to stock.
"RTN","PSDOPT0",149,0)
 D RTSMUL
"RTN","PSDOPT0",150,0)
 S PSD1=0
"RTN","PSDOPT0",151,0)
 S:$D(PSDXXX) PSD1=PSDXXX-.1
"RTN","PSDOPT0",152,0)
 K PSD1MUL,PSDMUL,PSDXXX
"RTN","PSDOPT0",153,0)
 S PSDERR=0
"RTN","PSDOPT0",154,0)
 F  S PSD1=$O(^PSD(58.81,"AOP",PSDRX,PSD1)) Q:PSD1'>0  S DATA=$G(^PSD(58.81,PSD1,0)),DATA6=$G(^PSD(58.81,PSD1,6)) D
"RTN","PSDOPT0",155,0)
 .S PSDFLL=$P(PSDNUM,"^",2)
"RTN","PSDOPT0",156,0)
 .I PSDFLL>0,$D(^PSD(58.81,PSD1,6)),$P(^PSD(58.81,PSD1,6),"^",2)=PSDFLL,$D(^PSD(58.81,PSD1,3)) D ERRMSG
"RTN","PSDOPT0",157,0)
 .I $D(^PSD(58.81,PSD1,3)),PSDFLL=0,'$D(^PSD(58.81,PSD1,6)) D ERRMSG
"RTN","PSDOPT0",158,0)
 Q
"RTN","PSDOPT0",159,0)
ERRMSG S Y=$P(^PSD(58.81,PSD1,3),"^") X ^DD("DD") S PSDRTS(1)=Y,PSDUSER=$P(^PSD(58.81,PSD1,0),"^",7),PSDUSER=$P(^VA(200,PSDUSER,0),"^")
"RTN","PSDOPT0",160,0)
 W !!?8,"According to the Controlled Substances package, this fill/refill",!?8,"was returned to stock on "_PSDRTS(1)_" by "_$G(PSDUSER)_".",!?16,"Nothing updated in the Controlled Substances package."
"RTN","PSDOPT0",161,0)
 S PSDERR=1 Q
"RTN","PSDOPT0",162,0)
RTSMUL D RTSMUL^PSDOPT1
"RTN","PSDOPT0",163,0)
 Q
"RTN","PSDOPT1")
0^32^B22714104^B21039640
"RTN","PSDOPT1",1,0)
PSDOPT1 ;BIR/JPW,LTL-Outpatient Rx Entry (cont'd) ; 20 July 94
"RTN","PSDOPT1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**30,66**;13 Feb 97;Build 3
"RTN","PSDOPT1",3,0)
 ;Reference to PS(52.5 supported by DBIA #786
"RTN","PSDOPT1",4,0)
 ;References to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDOPT1",5,0)
 ;References to file 58.81 are covered by DBIA #2808
"RTN","PSDOPT1",6,0)
 ;Reference to PSRX( supported by DBIA #986
"RTN","PSDOPT1",7,0)
 ;Reference to routine PSOCSRL supported by DBIA #983
"RTN","PSDOPT1",8,0)
UPDATE W !!,"Creating an Outpatient Transaction..."
"RTN","PSDOPT1",9,0)
 F  L +^PSD(58.8,+PSDS,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDOPT1",10,0)
 D NOW^%DTC S PSDT=+% S BAL=+$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)-QTY
"RTN","PSDOPT1",11,0)
 L -^PSD(58.8,+PSDS,1,PSDR,0)
"RTN","PSDOPT1",12,0)
 W "updating..."
"RTN","PSDOPT1",13,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDOPT1",14,0)
FIND S PSDA=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDA)) S $P(^PSD(58.81,0),"^",3)=PSDA G FIND
"RTN","PSDOPT1",15,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.81,DIC(0)="L",(X,DINUM)=PSDA D ^DIC K DIC,DLAYGO
"RTN","PSDOPT1",16,0)
 L -^PSD(58.81,0)
"RTN","PSDOPT1",17,0)
ADD ;set trans
"RTN","PSDOPT1",18,0)
 S ^PSD(58.81,PSDA,0)=PSDA_"^6^"_+PSDS_"^"_PSDT_"^"_PSDR_"^"_QTY_"^"_PSDUZ_"^^^"_BAL
"RTN","PSDOPT1",19,0)
 S ^PSD(58.81,PSDA,6)=PSDRX_"^"_$S($G(NEW(1)):NEW(1),1:"")_"^"_DAT_"^"_$S($G(NEW(2)):NEW(2),1:"")_"^"_RXNUM_"^"_PSDRPH
"RTN","PSDOPT1",20,0)
 S ^PSD(58.81,PSDA,"CS")=1
"RTN","PSDOPT1",21,0)
 S DIK="^PSD(58.81,",DA=PSDA D IX^DIK K DA,DIK
"RTN","PSDOPT1",22,0)
 W "vault activity..."
"RTN","PSDOPT1",23,0)
DIE I '$D(^PSD(58.8,+PSDS,1,PSDR,4,0)) S ^(0)="^58.800119PA^^"
"RTN","PSDOPT1",24,0)
 K DA,DIC,DD,DO S DA(1)=PSDR,DA(2)=+PSDS,(X,DINUM)=PSDA,DIC(0)="L",DIC="^PSD(58.8,"_+PSDS_",1,"_PSDR_",4," D FILE^DICN K DIC,DINUM
"RTN","PSDOPT1",25,0)
 ;monthly activity
"RTN","PSDOPT1",26,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,0)) S ^(0)="^58.801A^^"
"RTN","PSDOPT1",27,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,$E(DT,1,5)*100,0)) K DA,DIC S DIC="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=+PSDS,DA(1)=PSDR D ^DIC K DA,DIC,DINUM,DLAYGO
"RTN","PSDOPT1",28,0)
 K DA,DIE,DR S DIE="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DA(2)=+PSDS,DA(1)=PSDR,DA=$E(DT,1,5)*100,DR="9////^S X=$P($G(^(0)),""^"",6)+QTY" D ^DIE K DA,DIE,DR
"RTN","PSDOPT1",29,0)
 W "done."
"RTN","PSDOPT1",30,0)
 ;PSD*3*30 (Dave B) Check for already released
"RTN","PSDOPT1",31,0)
 I $G(PSDREL)'="" Q
"RTN","PSDOPT1",32,0)
 I $G(PSDRTS)=1 K PSDRTS Q
"RTN","PSDOPT1",33,0)
PSDREL S X="PSOCSRL" X ^%ZOSF("TEST") I $T S XTYPE=$S($G(NEW(2)):"P"_U_NEW(2),$G(NEW(1)):1_U_NEW(1),1:"") D EN^PSOCSRL(PSDRX,XTYPE,PSDRPH)
"RTN","PSDOPT1",34,0)
 Q
"RTN","PSDOPT1",35,0)
 ;
"RTN","PSDOPT1",36,0)
PSDRTS ;Returned to stock continued
"RTN","PSDOPT1",37,0)
 W !,"Updating balances"
"RTN","PSDOPT1",38,0)
 F  L +^PSD(58.8,+PSDS,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDOPT1",39,0)
 D NOW^%DTC S PSDT=+%,BAL=+$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4),$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)=$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)+PSDQTY
"RTN","PSDOPT1",40,0)
 L -^PSD(58.8,+PSDS,1,PSDR,0) W "."
"RTN","PSDOPT1",41,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDOPT1",42,0)
FIND1 S PSDA=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDA)) S $P(^PSD(58.81,0),"^",3)=PSDA G FIND1
"RTN","PSDOPT1",43,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.81,DIC(0)="L",(X,DINUM)=PSDA D ^DIC K DIC,DLAYGO
"RTN","PSDOPT1",44,0)
 L -^PSD(58.81,0)
"RTN","PSDOPT1",45,0)
 S ^PSD(58.81,PSDA,0)=PSDA_"^3^"_+PSDS_"^"_PSDT_"^"_PSDR_"^"_PSDQTY_"^"_PSDUZ_"^^^"_BAL
"RTN","PSDOPT1",46,0)
 S ^PSD(58.81,PSDA,3)=PSDT_"^"_PSDQTY_"^"_"Returned by Outpatient"
"RTN","PSDOPT1",47,0)
 S ^PSD(58.81,PSDA,"CS")=1
"RTN","PSDOPT1",48,0)
 S ^PSD(58.81,PSDA,6)=PSDRX_"^"_$S($G(PSDFILL)="R":PSDNUM1,1:"")_"^"_DAT_"^"_$S($G(PSDFILL)="P":PSDNUM1,1:"")_"^"_RXNUM_"^"_PSDRPH
"RTN","PSDOPT1",49,0)
 S PSDRTS=1,QTY=-PSDQTY D DIE
"RTN","PSDOPT1",50,0)
 Q
"RTN","PSDOPT1",51,0)
 ;
"RTN","PSDOPT1",52,0)
PSDORIG ;Check original labels
"RTN","PSDOPT1",53,0)
 ;Check for suspense
"RTN","PSDOPT1",54,0)
 I +$P($G(^PSRX(PSDRX,2)),U,2)'<PSDOIN S PSDRXFD=$P(^(2),U,2) D
"RTN","PSDOPT1",55,0)
 .S PSDSUPN=$O(^PS(52.5,"B",PSDRX,0))
"RTN","PSDOPT1",56,0)
 .I PSDSUPN,$D(^PS(52.5,"C",PSDRXFD,PSDSUPN)),$G(^PS(52.5,PSDSUPN,"P"))'=1 W !!,"Original suspended." S PSDRX(1)="" Q
"RTN","PSDOPT1",57,0)
 .K PSDLBL D VER^PSDOPT
"RTN","PSDOPT1",58,0)
 .I $G(PSOVR) F PSDLBL=0:0 S PSDLBL=$O(^PSRX(PSDRX,"L",PSDLBL)) Q:'PSDLBL  I '+$P($G(^PSRX(PSDRX,"L",PSDLBL,0)),"^",2),'$P($G(^(0)),"^",5) S PSDLBL(1)=1
"RTN","PSDOPT1",59,0)
 .I '$G(PSOVR) F PSDLBL=0:0 S PSDLBL=$O(^PSRX(PSDRX,"L",PSDLBL)) Q:'PSDLBL  I '+$P($G(^PSRX(PSDRX,"L",PSDLBL,0)),"^",2),$P($G(^(0)),"^",5)'["INTERACTION" S PSDLBL(1)=1
"RTN","PSDOPT1",60,0)
 .K PSOVR,PSDERR,PSDSTA,PSDRXIN I '$G(PSDLBL(1)) S PSDRX(1)="",PSDOUT=1 W !!,"Original label not printed." Q
"RTN","PSDOPT1",61,0)
 Q
"RTN","PSDOPT1",62,0)
PSDRFL ;Check refill labels
"RTN","PSDOPT1",63,0)
 I $D(^PSRX(PSDRX,1,PSDFLNO,0)),'$P(^(0),U,16),$P($G(^(0)),U)'<PSDOIN D
"RTN","PSDOPT1",64,0)
 .F PSDLBL=0:0 S PSDLBL=$O(^PSRX(PSDRX,"L",PSDLBL)) Q:'PSDLBL  I $P(^PSRX(PSDRX,"L",PSDLBL,0),U,2)=PSDFLNO S PSDLBL(1)=1
"RTN","PSDOPT1",65,0)
 .I '$G(PSDLBL(1)) W !!,"Refill #",PSDFLNO," label not printed." S PSDOUT=1,PSDRX(1)="" Q
"RTN","PSDOPT1",66,0)
 Q
"RTN","PSDOPT1",67,0)
PSDPRTL ;Chec partial labels
"RTN","PSDOPT1",68,0)
 I $D(^PSRX(PSDRX,"P",PSDFLNO,0)),'$P(^(0),U,16),$P($G(^(0)),U)'<PSDOIN D
"RTN","PSDOPT1",69,0)
 .F PSDLBL=0:0 S PSDLBL=$O(^PSRX(PSDRX,"L",PSDLBL)) Q:'PSDLBL  I $P(^PSRX(PSDRX,"L",0),U,2)=99-PSDFLNO S PSDLBL(1)=1
"RTN","PSDOPT1",70,0)
 .I '$G(PSDLBL(1)) W !!,"Partial #",PSDFLNO," label not printed." S PSDOUT=1,PSDRX(1)="" Q
"RTN","PSDOPT1",71,0)
 Q
"RTN","PSDOPT1",72,0)
RTSMUL ; Setup local array of refills in reverse order
"RTN","PSDOPT1",73,0)
 S PSD1=0 F  S PSD1=$O(^PSD(58.81,"AOP",PSDRX,PSD1)) Q:PSD1'>0  S DATA6=$G(^PSD(58.81,PSD1,6)) D
"RTN","PSDOPT1",74,0)
 .S PSDXXX=PSD1
"RTN","PSDOPT1",75,0)
 .S PSD1MUL=PSD1*-1
"RTN","PSDOPT1",76,0)
 .S PSDMUL(PSD1MUL)=$P(DATA6,"^",2)
"RTN","PSDOPT1",77,0)
 Q
"RTN","PSDOR21")
0^33^B14294849^B14070880
"RTN","PSDOR21",1,0)
PSDOR21 ;BIR/JPW,LTL-Reg 2 Nurse CS Order Entry (cont'd) ; 2 Aug 94
"RTN","PSDOR21",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDOR21",3,0)
 ;Multiple orders
"RTN","PSDOR21",4,0)
 I $D(ORD) F CNT1=1:1:CNT S PSDA=+ORD(CNT1) S:$G(PSDR(2))&(CNT1=1) PSDQTY=PSDR(2) D ASK
"RTN","PSDOR21",5,0)
 Q
"RTN","PSDOR21",6,0)
ASK ;displays order for review
"RTN","PSDOR21",7,0)
 D DISPLAY
"RTN","PSDOR21",8,0)
 W !! K DA,DIR,DIRUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this OK",DIR("?",1)="Answer 'YES' to send this request to pharmacy for processing,"
"RTN","PSDOR21",9,0)
 S DIR("?",2)="or 'NO' to edit or delete this request",DIR("?")="or '^' to quit and DELETE this CS order request." D ^DIR K DIR
"RTN","PSDOR21",10,0)
 I $D(DIRUT) S PSDOUT=1 D DEL Q
"RTN","PSDOR21",11,0)
 I 'Y D EDIT Q:PSDOUT  G ASK
"RTN","PSDOR21",12,0)
 I Y D PHARM W !! W:$D(ORD) "Your order request #"_CNT1_" of "_CNT W ?32,"Sent to Pharmacy...",!! R:$D(ORD) "Press <RET> to continue",X:DTIME,!!
"RTN","PSDOR21",13,0)
 Q
"RTN","PSDOR21",14,0)
DISPLAY ;displays order request to screen
"RTN","PSDOR21",15,0)
 K LN S $P(LN,"-",80)=""
"RTN","PSDOR21",16,0)
 W @IOF,!,?23,"Controlled Substance Order Request" I $D(ORD) W " # "_CNT1_" of "_CNT
"RTN","PSDOR21",17,0)
 W !!,"Pharmacy Dispensing #: ",!,"Requested by",?16,": ",$P($G(^VA(200,PSDUZ,0)),"^"),?52,"Request Date: ",REQD,!,LN,!
"RTN","PSDOR21",18,0)
 W !,"Drug",?16,": ",PSDRN,?56,"Quantity: ",?66,PSDQTY,!,"Dispensed by",?16,": N/A",?50,"Dispensed Date: N/A"
"RTN","PSDOR21",19,0)
 W !,"Disp. Location",?16,": " W:+PSDS $P($G(^PSD(58.8,+PSDS,0)),"^") W !,"Exp. Date",?16,": ",!,"Manufacturer",?16,": ",!,"Lot #",?16,": "
"RTN","PSDOR21",20,0)
 W !,"Ord. Location",?16,": ",NAOUN,!,"Order Status",?16,": ",$P($G(^PSD(58.82,1,0)),"^"),!,"Comments:"
"RTN","PSDOR21",21,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) K ^UTILITY($J,"W") F TEXT=0:0 S TEXT=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT)) Q:'TEXT  D
"RTN","PSDOR21",22,0)
 .S X=$G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT,0)),DIWL=5,DIWR=75,DIWF="W" D ^DIWP
"RTN","PSDOR21",23,0)
 I  D ^DIWW
"RTN","PSDOR21",24,0)
 Q
"RTN","PSDOR21",25,0)
EDIT ;edit or delete order request
"RTN","PSDOR21",26,0)
 W !!,"Edit or Delete this Order Request:  EDIT//  " R X:DTIME I '$T S PSDOUT=1 D DEL Q
"RTN","PSDOR21",27,0)
 Q:X["^"  S X=$E(X) S:X="" X="E" I "EeDd"'[X W !!,"Press <RET> to edit this order request, or enter 'D' to delete the request.",! G EDIT
"RTN","PSDOR21",28,0)
 I "Dd"[X D DEL Q
"RTN","PSDOR21",29,0)
 K DA,DIE,DR S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,",DR="13" D ^DIE K DIE,DR
"RTN","PSDOR21",30,0)
 Q
"RTN","PSDOR21",31,0)
DEL ;deletes order request
"RTN","PSDOR21",32,0)
 S PSDOUT=1 W !!,?25,"Request being deleted...",! K DIK S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIK="^PSD(58.8,"_NAOU_",1,"_PSDR_",3," D ^DIK K DIK
"RTN","PSDOR21",33,0)
 Q
"RTN","PSDOR21",34,0)
PHARM ;create worksheet entry in file 58.85
"RTN","PSDOR21",35,0)
 W ?5,!!,"Processing your request now..." F  L +^PSD(58.85,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDOR21",36,0)
ADD S PSDREC=$P(^PSD(58.85,0),"^",3)+1 I $D(^PSD(58.85,PSDREC)) S $P(^PSD(58.85,0),"^",3)=PSDREC G ADD
"RTN","PSDOR21",37,0)
 K DA,DIC,DIE,DLAYGO,DR S (DIC,DIE,DLAYGO)=58.85,DIC(0)="L",X=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDOR21",38,0)
 L -^PSD(58.85,0)
"RTN","PSDOR21",39,0)
 S PSDRD=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,0)),"^",2):$P(^(0),"^",2),1:DT)
"RTN","PSDOR21",40,0)
 S DA=PSDREC,DR="1////"_+PSDS_";2////"_NAOU_";3////"_PSDR_";4////"_PSDA_";5////"_PSDQTY_";6////1;12////"_PSDUZ_";19////"_PSDRD D ^DIE K DIE
"RTN","PSDOR21",41,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) S ^PSD(58.85,PSDREC,1,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0) D
"RTN","PSDOR21",42,0)
 .F WORD=0:0 S WORD=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD)) Q:'WORD  S ^PSD(58.85,PSDREC,1,WORD,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD,0)
"RTN","PSDOR21",43,0)
 K DA,DIC,DIE,DLAYGO,DR,PSDREC,WORD S PSDQTY=PSDR(1)
"RTN","PSDOR21",44,0)
 Q
"RTN","PSDORD2")
0^34^B14321615^B14074750
"RTN","PSDORD2",1,0)
PSDORD2 ;BIR/JPW,LTL-Nurse CS Order Entry (cont'd) ; 21 Dec 94
"RTN","PSDORD2",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDORD2",3,0)
 I $D(ORD) F CNT1=1:1:CNT S PSDA=+ORD(CNT1) D ASK
"RTN","PSDORD2",4,0)
 Q
"RTN","PSDORD2",5,0)
ASK ;displays order for review
"RTN","PSDORD2",6,0)
 D DISPLAY
"RTN","PSDORD2",7,0)
 W !! K DA,DIR,DIRUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this OK",DIR("?",1)="Answer 'YES' to send this request to pharmacy for processing,"
"RTN","PSDORD2",8,0)
 S DIR("?",2)="or 'NO' to edit or delete this request",DIR("?")="or '^' to quit and DELETE this CS order request." D ^DIR K DIR
"RTN","PSDORD2",9,0)
 I $D(DIRUT) S PSDOUT=1 D DEL Q
"RTN","PSDORD2",10,0)
 I 'Y D EDIT Q:PSDOUT  G ASK
"RTN","PSDORD2",11,0)
 I Y D PHARM W !! W:$D(ORD) "Your order request #"_CNT1_" of "_CNT W ?32,"Sent to Pharmacy...",!! R:$D(ORD) "Press <RET> to continue",X:DTIME,!!
"RTN","PSDORD2",12,0)
 Q
"RTN","PSDORD2",13,0)
DISPLAY ;displays order request to screen
"RTN","PSDORD2",14,0)
 K LN S $P(LN,"-",80)=""
"RTN","PSDORD2",15,0)
 W @IOF,!,?23,"Controlled Substance Order Request" I $D(ORD) W " # "_CNT1_" of "_CNT
"RTN","PSDORD2",16,0)
 W !!,"Pharmacy Dispensing #: ",!,"Requested by",?16,": ",$P($G(^VA(200,PSDUZ,0)),"^"),?52,"Request Date: ",REQD,!,LN,!
"RTN","PSDORD2",17,0)
 W !,"Drug",?16,": ",PSDRN,?56,"Quantity: ",?66,PSDQTY,!,"Dispensed by",?16,": N/A",?50,"Dispensed Date: N/A"
"RTN","PSDORD2",18,0)
 W !,"Disp. Location",?16,": " W:+PSDS $P($G(^PSD(58.8,+PSDS,0)),"^") W !,"Exp. Date",?16,": ",!,"Manufacturer",?16,": ",!,"Lot #",?16,": "
"RTN","PSDORD2",19,0)
 W !,"Ord. Location",?16,": ",NAOUN,!,"Order Status",?16,": ",$P($G(^PSD(58.82,1,0)),"^"),!,"Comments:"
"RTN","PSDORD2",20,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) K ^UTILITY($J,"W") F TEXT=0:0 S TEXT=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT)) Q:'TEXT  D
"RTN","PSDORD2",21,0)
 .S X=$G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT,0)),DIWL=5,DIWR=75,DIWF="W" D ^DIWP
"RTN","PSDORD2",22,0)
 I  D ^DIWW
"RTN","PSDORD2",23,0)
 Q
"RTN","PSDORD2",24,0)
EDIT ;edit or delete order request
"RTN","PSDORD2",25,0)
 W !!,"Edit or Delete this Order Request:  EDIT//  " R X:DTIME I '$T S PSDOUT=1 D DEL Q
"RTN","PSDORD2",26,0)
 Q:X["^"  S X=$E(X) S:X="" X="E" I "EeDd"'[X W !!,"Press <RET> to edit this order request, or enter 'D' to delete the request.",! G EDIT
"RTN","PSDORD2",27,0)
 I "Dd"[X D DEL Q
"RTN","PSDORD2",28,0)
 K DA,DIE,DR S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,",DR="13" D ^DIE K DIE,DR
"RTN","PSDORD2",29,0)
 Q
"RTN","PSDORD2",30,0)
DEL ;deletes order request
"RTN","PSDORD2",31,0)
 S PSDOUT=1 W !,?25,"Request #",PSDD(2)," being deleted...",! K DIK S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIK="^PSD(58.8,"_NAOU_",1,"_PSDR_",3," D ^DIK K DIK
"RTN","PSDORD2",32,0)
 Q
"RTN","PSDORD2",33,0)
PHARM ;create worksheet entry in file 58.85
"RTN","PSDORD2",34,0)
 I $D(XRTL) D T0^%ZOSV
"RTN","PSDORD2",35,0)
 W ?5,!,"Processing your request #",PSDD(2)," now..." F  L +^PSD(58.85,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDORD2",36,0)
ADD S PSDREC=$P(^PSD(58.85,0),"^",3)+1 I $D(^PSD(58.85,PSDREC)) S $P(^PSD(58.85,0),"^",3)=PSDREC G ADD
"RTN","PSDORD2",37,0)
 K DA,DIC,DIE,DLAYGO,DR S (DIC,DIE,DLAYGO)=58.85,DIC(0)="L",X=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDORD2",38,0)
 L -^PSD(58.85,0)
"RTN","PSDORD2",39,0)
 S PSDRD=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,0)),"^",2):$P(^(0),"^",2),1:DT)
"RTN","PSDORD2",40,0)
 S DA=PSDREC,DR="1////"_+PSDS_";2////"_NAOU_";3////"_PSDR_";4////"_PSDA_";5////"_PSDQTY_";6////1;12////"_PSDUZ_";19////"_PSDRD D ^DIE K DIE
"RTN","PSDORD2",41,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) S ^PSD(58.85,PSDREC,1,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0) D
"RTN","PSDORD2",42,0)
 .F WORD=0:0 S WORD=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD)) Q:'WORD  S ^PSD(58.85,PSDREC,1,WORD,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD,0)
"RTN","PSDORD2",43,0)
 K DA,DIC,DIE,DLAYGO,DR,PSDREC,WORD
"RTN","PSDORD2",44,0)
 I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV
"RTN","PSDORD2",45,0)
 Q
"RTN","PSDORN1")
0^35^B17431994^B17181313
"RTN","PSDORN1",1,0)
PSDORN1 ;BIR/JPW,LTL-Nurse CS Order Entry (cont'd) ;12/14/99  16:09
"RTN","PSDORN1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**20,66**;13 Feb 97;Build 3
"RTN","PSDORN1",3,0)
 ;
"RTN","PSDORN1",4,0)
 ; Reference to DPT( supported by DBIA # 10035
"RTN","PSDORN1",5,0)
 ; Reference to PSD(58.8 supported by DBIA # 2711
"RTN","PSDORN1",6,0)
 ; Reference to VA(200 supported by DBIA # 10060
"RTN","PSDORN1",7,0)
 ; Line tag SIG^XUSESIG supported by DBIA # 10050
"RTN","PSDORN1",8,0)
 ;
"RTN","PSDORN1",9,0)
 I $D(ORD) F CNT1=1:1:CNT S PSDA=+ORD(CNT1) D ASK
"RTN","PSDORN1",10,0)
 Q
"RTN","PSDORN1",11,0)
ASK ;displays order for review
"RTN","PSDORN1",12,0)
 D DISPLAY
"RTN","PSDORN1",13,0)
 W !! K DA,DIR,DIRUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this OK",DIR("?",1)="Answer 'YES' to send this request to pharmacy for processing,"
"RTN","PSDORN1",14,0)
 S DIR("?",2)="or 'NO' to edit or delete this request",DIR("?")="or '^' to quit and DELETE this CS order request." D ^DIR K DIR
"RTN","PSDORN1",15,0)
 I $D(DIRUT) S PSDOUT=1 D DEL Q
"RTN","PSDORN1",16,0)
 I 'Y D EDIT Q:PSDOUT  G ASK
"RTN","PSDORN1",17,0)
 I Y N X,X1 D SIG^XUSESIG S:X1="" PSDOUT=1 D:X1="" DEL Q:X1=""  D
"RTN","PSDORN1",18,0)
 .D PHARM W !! W:$D(ORD) "Your order request #"_CNT1_" of "_CNT
"RTN","PSDORN1",19,0)
 .W ?32,"Sent to Pharmacy...",!!
"RTN","PSDORN1",20,0)
 .R:$D(ORD) "Press <RET> to continue",X:DTIME,!!
"RTN","PSDORN1",21,0)
 Q
"RTN","PSDORN1",22,0)
DISPLAY ;displays order request to screen
"RTN","PSDORN1",23,0)
 K LN S $P(LN,"-",80)=""
"RTN","PSDORN1",24,0)
 W @IOF,!,?17,"Controlled Substance "
"RTN","PSDORN1",25,0)
 W:$G(PSDEM) "*PRIORITY PICK UP* "
"RTN","PSDORN1",26,0)
 W "Order Request" I $D(ORD) W " # "_CNT1_" of "_CNT
"RTN","PSDORN1",27,0)
 W:$G(PAT) !!,"Patient:  ",$P($G(^DPT(PAT,0)),U),!!
"RTN","PSDORN1",28,0)
 W !!,"Pharmacy Dispensing #: ",!
"RTN","PSDORN1",29,0)
 W "Requested by",?16,": ",$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDORN1",30,0)
 W ?51,$S($G(PSDT(9))]"":"Needed by: "_PSDT(9),1:"Request Date: "_REQD),!,LN,!
"RTN","PSDORN1",31,0)
 W !,"Drug",?16,": ",PSDRN,?56,"Quantity: ",?66,PSDQTY,!,"Dispensed by",?16,": N/A",?50,"Dispensed Date: N/A"
"RTN","PSDORN1",32,0)
 W !,"Disp. Location",?16,": " W:+PSDS $P($G(^PSD(58.8,+PSDS,0)),"^") W !,"Exp. Date",?16,": ",!,"Manufacturer",?16,": ",!,"Lot #",?16,": "
"RTN","PSDORN1",33,0)
 W !,"Ord. Location",?16,": ",NAOUN,!,"Order Status",?16,": ",$P($G(^PSD(58.82,1,0)),"^"),!,"Comments:"
"RTN","PSDORN1",34,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) K ^UTILITY($J,"W") F TEXT=0:0 S TEXT=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT)) Q:'TEXT  D
"RTN","PSDORN1",35,0)
 .S X=$G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT,0)),DIWL=5,DIWR=75,DIWF="W" D ^DIWP
"RTN","PSDORN1",36,0)
 I  D ^DIWW
"RTN","PSDORN1",37,0)
 Q
"RTN","PSDORN1",38,0)
EDIT ;edit or delete order request
"RTN","PSDORN1",39,0)
 W !!,"Edit or Delete this Order Request:  EDIT//  " R X:DTIME I '$T S PSDOUT=1 D DEL Q
"RTN","PSDORN1",40,0)
 Q:X["^"  S X=$E(X) S:X="" X="E" I "EeDd"'[X W !!,"Press <RET> to edit this order request, or enter 'D' to delete the request.",! G EDIT
"RTN","PSDORN1",41,0)
 I "Dd"[X D DEL Q
"RTN","PSDORN1",42,0)
 K DA,DIE,DR S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,",DR="13" D ^DIE K DIE,DR
"RTN","PSDORN1",43,0)
 Q
"RTN","PSDORN1",44,0)
DEL ;deletes order request
"RTN","PSDORN1",45,0)
 S PSDOUT=1 W !!,?25,"Request being deleted...",! K DIK S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIK="^PSD(58.8,"_NAOU_",1,"_PSDR_",3," D ^DIK K DIK
"RTN","PSDORN1",46,0)
 Q
"RTN","PSDORN1",47,0)
PHARM ;create worksheet entry in file 58.85
"RTN","PSDORN1",48,0)
 I $D(XRTL) D T0^%ZOSV
"RTN","PSDORN1",49,0)
 W ?5,!!,"Processing your request now..." F  L +^PSD(58.85,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDORN1",50,0)
ADD S PSDREC=$P(^PSD(58.85,0),"^",3)+1 I $D(^PSD(58.85,PSDREC)) S $P(^PSD(58.85,0),"^",3)=PSDREC G ADD
"RTN","PSDORN1",51,0)
 K DA,DIC,DIE,DLAYGO,DR S (DIC,DIE,DLAYGO)=58.85,DIC(0)="L",X=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDORN1",52,0)
 L -^PSD(58.85,0)
"RTN","PSDORN1",53,0)
 S PSDRD=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,0)),"^",2):$P(^(0),"^",2),1:DT)
"RTN","PSDORN1",54,0)
 S DA=PSDREC,DR="1////"_+PSDS_";2////"_NAOU_";3////"_PSDR_";4////"_PSDA_";5////"_PSDQTY_";6////1;12////"_PSDUZ_";19////"_PSDRD_";21////"_$P($G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,2)),U,2)_";22////"_$G(PAT) D ^DIE K DIE
"RTN","PSDORN1",55,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) S ^PSD(58.85,PSDREC,1,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0) D
"RTN","PSDORN1",56,0)
 .F WORD=0:0 S WORD=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD)) Q:'WORD  S ^PSD(58.85,PSDREC,1,WORD,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD,0)
"RTN","PSDORN1",57,0)
 K DA,DIC,DIE,DLAYGO,DR,WORD
"RTN","PSDORN1",58,0)
 I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV
"RTN","PSDORN1",59,0)
 D:$P($G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,2)),U,2) ^PSDORNP K PSDREC,PSDT(9)
"RTN","PSDORN1",60,0)
 Q
"RTN","PSDORN2")
0^36^B15528357^B14389778
"RTN","PSDORN2",1,0)
PSDORN2 ;BIR/JPW,LTL-Nurse CS Infusion Order Entry (cont'd) ; 16 Feb 95
"RTN","PSDORN2",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDORN2",3,0)
 ;
"RTN","PSDORN2",4,0)
 ; Reference to DPT( supported by DBIA # 1035
"RTN","PSDORN2",5,0)
 ; Reference to VA(200 supported  by DBIA # 10060
"RTN","PSDORN2",6,0)
 ; Line tag SIG^XUSESIG supported by DBIA # 10050
"RTN","PSDORN2",7,0)
 ;
"RTN","PSDORN2",8,0)
ASK ;displays order for review
"RTN","PSDORN2",9,0)
 D DISPLAY
"RTN","PSDORN2",10,0)
 W !! K DA,DIR,DIRUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this OK",DIR("?",1)="Answer 'YES' to send this request to pharmacy for processing,"
"RTN","PSDORN2",11,0)
 S DIR("?",2)="or 'NO' to edit or delete this request",DIR("?")="or '^' to quit and DELETE this CS order request." D ^DIR K DIR
"RTN","PSDORN2",12,0)
 I $D(DIRUT) S PSDOUT=1 D DEL Q
"RTN","PSDORN2",13,0)
 I 'Y D EDIT Q:PSDOUT  G ASK
"RTN","PSDORN2",14,0)
 I Y N X,X1 D SIG^XUSESIG S:X1="" PSDOUT=1 D:X1="" DEL Q:X1=""  D
"RTN","PSDORN2",15,0)
 .D PHARM W !! W:$D(ORD) "Your order request #"_CNT1_" of "_CNT
"RTN","PSDORN2",16,0)
 .W ?32,"Sent to Pharmacy...",!!
"RTN","PSDORN2",17,0)
 .R:$D(ORD) "Press <RET> to continue",X:DTIME,!!
"RTN","PSDORN2",18,0)
 Q
"RTN","PSDORN2",19,0)
DISPLAY ;displays order request to screen
"RTN","PSDORN2",20,0)
 K LN S $P(LN,"-",80)=""
"RTN","PSDORN2",21,0)
 W @IOF,!,?17,"Controlled Substance "
"RTN","PSDORN2",22,0)
 W:$G(PSDEM) "*INFUSION* Order Request"
"RTN","PSDORN2",23,0)
 W !!,"Patient:  ",$P($G(^DPT(PAT,0)),U),!!
"RTN","PSDORN2",24,0)
 W "Requested by",?16,": ",$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDORN2",25,0)
 W ?51,$S($G(PSDT(9))]"":"Needed by: "_PSDT(9),1:"Request Date: "_REQD),!,LN,!
"RTN","PSDORN2",26,0)
 W !,"Drug",?16,": ",PSDRN
"RTN","PSDORN2",27,0)
 ;W ?56,"Quantity: ",?66,PSDQTY
"RTN","PSDORN2",28,0)
 W !,"Dispensed by",?16,": N/A",?50,"Dispensed Date: N/A"
"RTN","PSDORN2",29,0)
 W !,"Disp. Location",?16,": " W:+PSDS $P($G(^PSD(58.8,+PSDS,0)),"^") W !,"Exp. Date",?16,": ",!,"Manufacturer",?16,": ",!,"Lot #",?16,": "
"RTN","PSDORN2",30,0)
 W !,"Ord. Location",?16,": ",NAOUN,!,"Order Status",?16,": ",$P($G(^PSD(58.82,1,0)),"^"),!,"Comments:"
"RTN","PSDORN2",31,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) K ^UTILITY($J,"W") F TEXT=0:0 S TEXT=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT)) Q:'TEXT  D
"RTN","PSDORN2",32,0)
 .S X=$G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT,0)),DIWL=5,DIWR=75,DIWF="W" D ^DIWP
"RTN","PSDORN2",33,0)
 I  D ^DIWW
"RTN","PSDORN2",34,0)
 Q
"RTN","PSDORN2",35,0)
EDIT ;edit or delete order request
"RTN","PSDORN2",36,0)
 W !!,"Edit or Delete this Order Request:  EDIT//  " R X:DTIME I '$T S PSDOUT=1 D DEL Q
"RTN","PSDORN2",37,0)
 Q:X["^"  S X=$E(X) S:X="" X="E" I "EeDd"'[X W !!,"Press <RET> to edit this order request, or enter 'D' to delete the request.",! G EDIT
"RTN","PSDORN2",38,0)
 I "Dd"[X D DEL Q
"RTN","PSDORN2",39,0)
 K DA,DIE,DR S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,",DR="13" D ^DIE K DIE,DR
"RTN","PSDORN2",40,0)
 Q
"RTN","PSDORN2",41,0)
DEL ;deletes order request
"RTN","PSDORN2",42,0)
 S PSDOUT=1 W !!,?25,"Request being deleted...",! K DIK S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIK="^PSD(58.8,"_NAOU_",1,"_PSDR_",3," D ^DIK K DIK
"RTN","PSDORN2",43,0)
 Q
"RTN","PSDORN2",44,0)
PHARM ;create worksheet entry in file 58.85
"RTN","PSDORN2",45,0)
 W ?5,!!,"Processing your request now..." F  L +^PSD(58.85,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDORN2",46,0)
ADD S PSDREC=$P(^PSD(58.85,0),"^",3)+1 I $D(^PSD(58.85,PSDREC)) S $P(^PSD(58.85,0),"^",3)=PSDREC G ADD
"RTN","PSDORN2",47,0)
 K DA,DIC,DIE,DLAYGO,DR S (DIC,DIE,DLAYGO)=58.85,DIC(0)="L",X=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDORN2",48,0)
 L -^PSD(58.85,0)
"RTN","PSDORN2",49,0)
 S PSDRD=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,0)),"^",2):$P(^(0),"^",2),1:DT)
"RTN","PSDORN2",50,0)
 S DA=PSDREC,DR="1////"_+PSDS_";2////"_NAOU_";3////"_PSDR_";4////"_PSDA_";5////"_PSDQTY_";6////1;12////"_PSDUZ_";19////"_PSDRD_";21////"_$P($G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,2)),U,2)_";22////"_$G(PAT) D ^DIE K DIE
"RTN","PSDORN2",51,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) S ^PSD(58.85,PSDREC,1,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0) D
"RTN","PSDORN2",52,0)
 .F WORD=0:0 S WORD=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD)) Q:'WORD  S ^PSD(58.85,PSDREC,1,WORD,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD,0)
"RTN","PSDORN2",53,0)
 K DA,DIC,DIE,DLAYGO,DR,WORD
"RTN","PSDORN2",54,0)
 D ^PSDORN3 K PSDREC,PSDT(9)
"RTN","PSDORN2",55,0)
 Q
"RTN","PSDORP1")
0^37^B15402116^B15178147
"RTN","PSDORP1",1,0)
PSDORP1 ;BIR/JPW-Pharm CS Order Entry (cont'd) ; 2 Aug 94
"RTN","PSDORP1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDORP1",3,0)
 ;MULTIPLE ORDERS
"RTN","PSDORP1",4,0)
 I $D(ORD) F CNT1=1:1:CNT S PSDA=+ORD(CNT1) S:$G(PSDR(2))&(CNT1=1) PSDQTY=PSDR(2) D ASK
"RTN","PSDORP1",5,0)
 Q
"RTN","PSDORP1",6,0)
ASK ;displays order for review
"RTN","PSDORP1",7,0)
 D DISPLAY
"RTN","PSDORP1",8,0)
 W !! K DA,DIR,DIRUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this OK",DIR("?",1)="Answer 'YES' to send this request to pharmacy for processing,"
"RTN","PSDORP1",9,0)
 S DIR("?",2)="or 'NO' to edit or delete this request",DIR("?")="or '^' to quit and DELETE this CS order request." D ^DIR K DIR
"RTN","PSDORP1",10,0)
 I $D(DIRUT) S PSDOUT=1 D DEL Q
"RTN","PSDORP1",11,0)
 I 'Y D EDIT Q:PSDOUT  G ASK
"RTN","PSDORP1",12,0)
 I Y N X,X1 D SIG^XUSESIG S:X1="" PSDOUT=1 D:X1="" DEL Q:X1=""  D PHARM W !! W:$D(ORD) "Your order request #"_CNT1_" of "_CNT W ?32,"Sent to Pharmacy...",!! R:$D(ORD) "Press <RET> to continue",X:DTIME,!!
"RTN","PSDORP1",13,0)
 Q
"RTN","PSDORP1",14,0)
DISPLAY ;displays order request to screen
"RTN","PSDORP1",15,0)
 K LN S $P(LN,"-",80)=""
"RTN","PSDORP1",16,0)
 W @IOF,!,?23,"Controlled Substance Order Request" I $D(ORD) W " # "_CNT1_" of "_CNT
"RTN","PSDORP1",17,0)
 W !!,"Pharmacy Dispensing #: ",!,"Requested by",?16,": ",$P($G(^VA(200,PSDUZ,0)),"^"),?52,"Request Date: ",REQD,!,LN,!
"RTN","PSDORP1",18,0)
 W !,"Drug",?16,": ",PSDRN,?56,"Quantity: ",?66,PSDQTY,!,"Dispensed by",?16,": N/A",?50,"Dispensed Date: N/A"
"RTN","PSDORP1",19,0)
 W !,"Disp. Location",?16,": " W:+PSDS $P($G(^PSD(58.8,+PSDS,0)),"^") W !,"Exp. Date",?16,": ",!,"Manufacturer",?16,": ",!,"Lot #",?16,": "
"RTN","PSDORP1",20,0)
 W !,"Ord. Location",?16,": ",NAOUN,!,"Order Status",?16,": ",$P($G(^PSD(58.82,1,0)),"^"),!,"Comments:"
"RTN","PSDORP1",21,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) K ^UTILITY($J,"W") F TEXT=0:0 S TEXT=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT)) Q:'TEXT  D
"RTN","PSDORP1",22,0)
 .S X=$G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT,0)),DIWL=5,DIWR=75,DIWF="W" D ^DIWP
"RTN","PSDORP1",23,0)
 I  D ^DIWW
"RTN","PSDORP1",24,0)
 Q
"RTN","PSDORP1",25,0)
EDIT ;edit or delete order request
"RTN","PSDORP1",26,0)
 W !!,"Edit or Delete this Order Request:  EDIT//  " R X:DTIME I '$T S PSDOUT=1 D DEL Q
"RTN","PSDORP1",27,0)
 Q:X["^"  S X=$E(X) S:X="" X="E" I "EeDd"'[X W !!,"Press <RET> to edit this order request, or enter 'D' to delete the request.",! G EDIT
"RTN","PSDORP1",28,0)
 I "Dd"[X D DEL Q
"RTN","PSDORP1",29,0)
 K DA,DIE,DR S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,",DR="3;13" D ^DIE K DIE,DR
"RTN","PSDORP1",30,0)
 Q
"RTN","PSDORP1",31,0)
DEL ;deletes order request
"RTN","PSDORP1",32,0)
 S PSDOUT=1 W !!,?25,"Request being deleted...",! K DIK S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIK="^PSD(58.8,"_NAOU_",1,"_PSDR_",3," D ^DIK K DIK
"RTN","PSDORP1",33,0)
 Q
"RTN","PSDORP1",34,0)
PHARM ;create worksheet entry in file 58.85
"RTN","PSDORP1",35,0)
 W ?5,!!,"Processing your request now..." F  L +^PSD(58.85,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDORP1",36,0)
ADD S PSDREC=$P(^PSD(58.85,0),"^",3)+1 I $D(^PSD(58.85,PSDREC)) S $P(^PSD(58.85,0),"^",3)=PSDREC G ADD
"RTN","PSDORP1",37,0)
 K DA,DIC,DIE,DR,DLAYGO S (DIC,DIE,DLAYGO)=58.85,DIC(0)="L",X=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDORP1",38,0)
 L -^PSD(58.85,0)
"RTN","PSDORP1",39,0)
 S PSDRD=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,0)),"^",2):$P(^(0),"^",2),1:DT)
"RTN","PSDORP1",40,0)
 S DA=PSDREC,DR="1////"_PSDS_";2////"_NAOU_";3////"_PSDR_";4////"_PSDA_";5////"_PSDQTY_";6////1;12////"_PSDUZA_";19////"_PSDRD_";20////"_PSDUZ D ^DIE K DIE
"RTN","PSDORP1",41,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) S ^PSD(58.85,PSDREC,1,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0) D
"RTN","PSDORP1",42,0)
 .F WORD=0:0 S WORD=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD)) Q:'WORD  S ^PSD(58.85,PSDREC,1,WORD,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD,0)
"RTN","PSDORP1",43,0)
 K DA,DIC,DIE,DLAYGO,DR,PSDREC,WORD S PSDQTY=$S($G(PSDR(1)):PSDR(1),1:NPKG)
"RTN","PSDORP1",44,0)
 Q
"RTN","PSDORV1")
0^38^B13438648^B13220403
"RTN","PSDORV1",1,0)
PSDORV1 ;BIR/JPW-IV Pharm CS Order Entry (cont'd) ; 2 Aug 94
"RTN","PSDORV1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDORV1",3,0)
ASK ;displays order for review
"RTN","PSDORV1",4,0)
 D DISPLAY
"RTN","PSDORV1",5,0)
 W !! K DA,DIR,DIRUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is this OK",DIR("?",1)="Answer 'YES' to send this request to pharmacy for processing,"
"RTN","PSDORV1",6,0)
 S DIR("?",2)="or 'NO' to edit or delete this request,",DIR("?")="or '^' to quit and DELETE this CS order request." D ^DIR K DIR
"RTN","PSDORV1",7,0)
 I $D(DIRUT) S PSDOUT=1 D DEL Q
"RTN","PSDORV1",8,0)
 I 'Y D EDIT Q:PSDOUT  G ASK
"RTN","PSDORV1",9,0)
 I Y D PHARM W !! W:$D(ORD) "Your order request #"_CNT1_" of "_CNT W ?32,"Sent to Pharmacy...",!! R:$D(ORD) "Press <RET> to continue",X:DTIME,!!
"RTN","PSDORV1",10,0)
 Q
"RTN","PSDORV1",11,0)
DISPLAY ;displays order request to screen
"RTN","PSDORV1",12,0)
 K LN S $P(LN,"-",80)=""
"RTN","PSDORV1",13,0)
 W @IOF,!,?23,"Controlled Substance Order Request" I $D(ORD) W " # "_CNT1_" of "_CNT
"RTN","PSDORV1",14,0)
 W !!,"Pharmacy Dispensing #: ",!,"Requested by",?16,": ",$P($G(^VA(200,PSDUZ,0)),"^"),?52,"Request Date: ",REQD,!,LN,!
"RTN","PSDORV1",15,0)
 W !,"Drug",?16,": ",PSDRN,?56,"Quantity: ",?66,PSDQTY,!,"Dispensed by",?16,": N/A",?50,"Dispensed Date: N/A"
"RTN","PSDORV1",16,0)
 W !,"Disp. Location",?16,": " W:+PSDS $P($G(^PSD(58.8,+PSDS,0)),"^") W !,"Exp. Date",?16,": ",!,"Manufacturer",?16,": ",!,"Lot #",?16,": "
"RTN","PSDORV1",17,0)
 W !,"Ord. Location",?16,": ",NAOUN,!,"Order Status",?16,": ",$P($G(^PSD(58.82,1,0)),"^"),!,"Comments:"
"RTN","PSDORV1",18,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) K ^UTILITY($J,"W") F TEXT=0:0 S TEXT=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT)) Q:'TEXT  D
"RTN","PSDORV1",19,0)
 .S X=$G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,TEXT,0)),DIWL=5,DIWR=75,DIWF="W" D ^DIWP
"RTN","PSDORV1",20,0)
 I  D ^DIWW
"RTN","PSDORV1",21,0)
 Q
"RTN","PSDORV1",22,0)
EDIT ;edit or delete order request
"RTN","PSDORV1",23,0)
 W !!,"Edit or Delete this Order Request:  EDIT//  " R X:DTIME I '$T S PSDOUT=1 D DEL Q
"RTN","PSDORV1",24,0)
 Q:X["^"  S X=$E(X) S:X="" X="E" I "EeDd"'[X W !!,"Press <RET> to edit this order request, or enter 'D' to delete the request.",! G EDIT
"RTN","PSDORV1",25,0)
 I "Dd"[X D DEL Q
"RTN","PSDORV1",26,0)
 K DA,DIE,DR S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,",DR="3;13" D ^DIE K DIE,DR
"RTN","PSDORV1",27,0)
 Q
"RTN","PSDORV1",28,0)
DEL ;deletes order request
"RTN","PSDORV1",29,0)
 S PSDOUT=1 W !!,?25,"Request being deleted...",! K DIK S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DIK="^PSD(58.8,"_NAOU_",1,"_PSDR_",3," D ^DIK K DIK
"RTN","PSDORV1",30,0)
 Q
"RTN","PSDORV1",31,0)
PHARM ;create worksheet entry in file 58.85
"RTN","PSDORV1",32,0)
 W ?5,!!,"Processing your request now..." F  L +^PSD(58.85,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDORV1",33,0)
ADD S PSDREC=$P(^PSD(58.85,0),"^",3)+1 I $D(^PSD(58.85,PSDREC)) S $P(^PSD(58.85,0),"^",3)=PSDREC G ADD
"RTN","PSDORV1",34,0)
 K DA,DIC,DIE,DR,DLAYGO S (DIC,DIE,DLAYGO)=58.85,DIC(0)="L",X=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDORV1",35,0)
 L -^PSD(58.85,0)
"RTN","PSDORV1",36,0)
 S PSDRD=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,0)),"^",2):$P(^(0),"^",2),1:DT)
"RTN","PSDORV1",37,0)
 S DA=PSDREC,DR="1////"_PSDS_";2////"_NAOU_";3////"_PSDR_";4////"_PSDA_";5////"_PSDQTY_";6////1;12////"_PSDUZ_";19////"_PSDRD D ^DIE K DIE
"RTN","PSDORV1",38,0)
 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0)) S ^PSD(58.85,PSDREC,1,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,0) D
"RTN","PSDORV1",39,0)
 .F WORD=0:0 S WORD=$O(^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD)) Q:'WORD  S ^PSD(58.85,PSDREC,1,WORD,0)=^PSD(58.8,NAOU,1,PSDR,3,PSDA,1,WORD,0)
"RTN","PSDORV1",40,0)
 K DA,DIC,DIE,DLAYGO,DR,PSDREC,WORD
"RTN","PSDORV1",41,0)
 Q
"RTN","PSDREC1")
0^39^B22137008^B21769206
"RTN","PSDREC1",1,0)
PSDREC1 ;BIR/LTL-CS Receiving (cont'd) ; 8 Aug 94
"RTN","PSDREC1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**30,66**;13 Feb 97;Build 3
"RTN","PSDREC1",3,0)
 ;Reference to ^PRC(441 supported by IA #682
"RTN","PSDREC1",4,0)
 ;Reference to ^PRC(442 supported by IA #682
"RTN","PSDREC1",5,0)
 ;References to $$UNITCODE^PRCPUX1 are covered by IA #259
"RTN","PSDREC1",6,0)
 ;References to ^PSDRUG( are covered by IA #221
"RTN","PSDREC1",7,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDREC1",8,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDREC1",9,0)
 N X,X1 D SIG^XUSESIG Q:X1=""
"RTN","PSDREC1",10,0)
LOOP F  S PSDI=$O(^PRC(442,+PSDPO,2,"AB",PSDP,PSDI)) Q:'PSDI  S PSDREC=$P($G(^PRC(442,+PSDPO,2,+PSDI,3,+$O(^PRC(442,+PSDPO,2,"AB",+PSDP,+PSDI,0)),0)),U,2) D:PSDREC  G:$D(DTOUT)!($D(DUOUT)) QUIT
"RTN","PSDREC1",11,0)
 .S PSDIT=$G(^PRC(442,+PSDPO,2,+PSDI,0))
"RTN","PSDREC1",12,0)
 .W !!,$P(PSDIT,U)
"RTN","PSDREC1",13,0)
 .S PSDW=0 F  S PSDW=$O(^PRC(442,+PSDPO,2,+PSDI,1,PSDW)) Q:'PSDW  W ?5,$E($P($G(^PRC(442,+PSDPO,2,+PSDI,1,PSDW,0)),U),1,75),!
"RTN","PSDREC1",14,0)
 .W !,"Packaging: ",$S($P(PSDIT,U,12):$P(PSDIT,U,12)_"/",1:"")
"RTN","PSDREC1",15,0)
 .;PSD*3*29 changed direct 420.5 lookup to supported IA #259
"RTN","PSDREC1",16,0)
 .W $$UNITCODE^PRCPUX1(+$P(PSDIT,U,3))
"RTN","PSDREC1",17,0)
 .W ?20,"Price: $",$P(PSDIT,U,9)
"RTN","PSDREC1",18,0)
 .W ?35,"Item #: ",$P(PSDIT,U,5),?48,"Vendor Stock #: ",$P(PSDIT,U,6),!
"RTN","PSDREC1",19,0)
NON .I '$P(PSDIT,U,5)!('$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")))!('$G(^PSD(58.8,+PSDLOC,1,+$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")),0))) D  Q:$D(DTOUT)!($D(DUOUT))!(Y<1)
"RTN","PSDREC1",20,0)
 ..S DIC="^PSD(58.8,PSDLOC,1,",DIC(0)="AEMQZ",DIC("A")="Select "_PSDLOCN_" drug: ",DIC("S")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)>DT,1:1)",DA(1)=PSDLOC
"RTN","PSDREC1",21,0)
 ..D ^DIC K DIC Q:$D(DTOUT)!($D(DUOUT))!(Y<1)
"RTN","PSDREC1",22,0)
 ..S PSDRUG=+Y,PSDRUGN=$P($G(^PSDRUG(+Y,0)),U)
"RTN","PSDREC1",23,0)
 ..I $P(PSDIT,U,5),$E($G(^PRC(441,+$P(PSDIT,U,5),3)),1)'=1,'$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")) D
"RTN","PSDREC1",24,0)
 ...S DIR(0)="Y",DIR("A",1)="Are you sure that you want to link ITEM MASTER file entry,"
"RTN","PSDREC1",25,0)
 ...S DIR("A",2)="",DIR("A",3)=$P($G(^PRC(441,+$P(PSDIT,U,5),0)),U,2)_" to DRUG file entry,"
"RTN","PSDREC1",26,0)
 ...S DIR("A",4)="",DIR("A",5)=PSDRUGN,DIR("A")="Y/N",DIR("B")="Yes"
"RTN","PSDREC1",27,0)
 ...S DIR("?")="Once linked, future receipts for this item will be posted to this drug.",DIR("A",6)=""
"RTN","PSDREC1",28,0)
 ...W ! D ^DIR K DIR Q:Y<1
"RTN","PSDREC1",29,0)
 ...S DIE=50,DA=PSDRUG,DR="441///^S X=$P(PSDIT,U,5)" D ^DIE K DIE W:'$D(Y) !!,"Now, ",PSDRUGN," is linked to Item # ",$P(PSDIT,U,5),"." S Y=1
"RTN","PSDREC1",30,0)
IT .S:'$D(PSDRUG) PSDRUG=$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")),PSDRUGN=$P($G(^PSDRUG(+PSDRUG,0)),U)
"RTN","PSDREC1",31,0)
 .W !!,PSDRUGN,!!
"RTN","PSDREC1",32,0)
 .S DIE="^PSDRUG(",DA=PSDRUG,DR="15Dispense units per order unit;13Price per order unit" D ^DIE K DIE I $D(Y) K PSDRUG Q
"RTN","PSDREC1",33,0)
DISP .W !!,"Quantity rec'd: ",PSDREC
"RTN","PSDREC1",34,0)
 .W ?40,"Converted quantity: " S PSDREC=PSDREC*$P($G(^PSDRUG(+PSDRUG,660)),U,5) W PSDREC,!
"RTN","PSDREC1",35,0)
 .;PSD*3*29 (Dave B) Check to see if drug actually stocked
"RTN","PSDREC1",36,0)
 .I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)) W !,"Sorry, but this drug is not stocked in this location.",! Q
"RTN","PSDREC1",37,0)
POST .S DIR(0)="Y",DIR("A")="OK to post",DIR("B")="Yes",DIR("?")="If yes, the balance will be updated and a transaction stored." D ^DIR K DIR D:Y=1  K PSDRUG Q
"RTN","PSDREC1",38,0)
 ..W !!,"There were ",$S($P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4):$P($G(^(0)),U,4),1:0)," on hand.",?40,"There are now ",$P($G(^(0)),U,4)+PSDREC," on hand.",!
"RTN","PSDREC1",39,0)
 ..F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDREC1",40,0)
 ..D NOW^%DTC S PSDAT=+%
"RTN","PSDREC1",41,0)
 ..S PSDB=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDREC1",42,0)
 ..S $P(^PSD(58.8,+PSDLOC,1,+PSDRUG,0),U,4)=PSDREC+PSDB
"RTN","PSDREC1",43,0)
 ..L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0)
"RTN","PSDREC1",44,0)
MON ..S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSDREC1",45,0)
 ..I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DLAYGO="58.8",DIC(0)="LM",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC
"RTN","PSDREC1",46,0)
 ..S DIE="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DA(2)=PSDLOC,DA(1)=PSDRUG,DA=$E(DT,1,5)*100,DR="5////^S X=$P($G(^(0)),U,3)+PSDREC" D ^DIE
"RTN","PSDREC1",47,0)
 ..W !,"Updating monthly receipts and transaction history.",!
"RTN","PSDREC1",48,0)
TR ..F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDREC1",49,0)
FIND ..S PSDT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSDT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSDREC1",50,0)
 ..S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSDT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSDREC1",51,0)
 ..S DIE="^PSD(58.81,",DA=PSDT,DR="1////1;2////^S X=PSDLOC;3////^S X=PSDAT;4////^S X=PSDRUG;5////^S X=PSDREC;6////^S X=DUZ;7////^S X=PSDCON;8////^S X=PSDPO;9////^S X=PSDB;100////1" D ^DIE K DIE
"RTN","PSDREC1",52,0)
 ..S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDREC1",53,0)
 ..S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,4,",DLAYGO="58.8",DIC(0)="L",(X,DINUM)=PSDT
"RTN","PSDREC1",54,0)
 ..S DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DA,PSDRUG
"RTN","PSDREC1",55,0)
 G:'PSDPO ^PSDREC2
"RTN","PSDREC1",56,0)
QUIT Q
"RTN","PSDREC2")
0^40^B21780916^B21458906
"RTN","PSDREC2",1,0)
PSDREC2 ;BIR/LTL-CS Receiving (cont'd) ; 8 Aug 94
"RTN","PSDREC2",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**30,66**;13 Feb 97;Build 3
"RTN","PSDREC2",3,0)
 ;Reference to ^DIC(51.5 supported by IA # 1931
"RTN","PSDREC2",4,0)
 ;Reference to ^PRCS(410 supported by IA #214
"RTN","PSDREC2",5,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDREC2",6,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDREC2",7,0)
 ;References to ^PSDRUG( are covered by IA #221
"RTN","PSDREC2",8,0)
CON S DIC="^PRCS(410,",DIC(0)="AEMQZ",DIC("A")="Select Pharmacy Transaction number: ",DIC("B")=$S($D(PSDCON):$P($G(^PRCS(410,+PSDCON,0)),U),1:""),DIC("S")="I $P($G(^(0)),U,2)=""O"",$P($G(^(3)),U,3)[822400"
"RTN","PSDREC2",9,0)
 D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT)) QUIT S PSDCON=$S(Y>0:+Y,1:"")
"RTN","PSDREC2",10,0)
 I $G(PSDPO)+$G(PSDCON)<1 W !!,"Sorry, we really can't allow receiving without a P.O. or CP transaction.",!! G QUIT
"RTN","PSDREC2",11,0)
 I '$O(^PRCS(410,+PSDCON,"IT",1)),'$P($G(^PRCS(410,+PSDCON,"IT",1,0)),U,5) G INV
"RTN","PSDREC2",12,0)
 G:$D(PSDPO(1))&($O(^PRCS(410,+PSDCON,"IT",0))) ^PSDREC4
"RTN","PSDREC2",13,0)
INV I $G(PSAPV) S DIR(0)="58.81,71O",DIR("A")="Please enter the Prime Vendor Invoice number" D ^DIR K DIR G:Y'=""&($D(DIRUT)) QUIT S PSAPV=Y
"RTN","PSDREC2",14,0)
 I $G(PSAPV)=" " S PSAPV=1 W $C(7),!!,"Sorry, the space bar won't work here.",! G INV
"RTN","PSDREC2",15,0)
 I $G(PSAPV)]"",$O(^PSD(58.81,"PV",Y,"")) S PSD(2)=PSAPV W !!,"Previous receipts have been processed for this invoice.",!! S DIR(0)="Y",DIR("A")="Would you like to review",DIR("B")="Yes" D ^DIR K DIR G:$D(DIRUT) QUIT G:Y=1 DEV^PSDREPV
"RTN","PSDREC2",16,0)
 N X,X1 D SIG^XUSESIG I X1="" S PSDOUT=1 G QUIT
"RTN","PSDREC2",17,0)
DRUG F  S DIC="^PSD(58.8,PSDLOC,1,",DIC(0)="AEMQ",DIC("A")="Select "_PSDLOCN_" drug: ",DIC("S")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)>DT,1:1)",DA(1)=PSDLOC D  Q:$G(PSDOUT)
"RTN","PSDREC2",18,0)
 .W ! D ^DIC I Y<0 S PSDOUT=1 Q
"RTN","PSDREC2",19,0)
 .K DIC S PSDRUG=+Y,PSDRUGN=$P($G(^PSDRUG(+Y,0)),U),PSDB=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDREC2",20,0)
PRIC .W ! S DIE="^PSDRUG(",DA=PSDRUG,DR="15Dispense units per order unit: ;13Price per order unit: " D ^DIE K DIE I $D(Y) S PSDOUT=1 Q
"RTN","PSDREC2",21,0)
QTY .W ! S DIR(0)="NA^0:999999:0",DIR("A")="Number of "_$P($G(^DIC(51.5,+$P($G(^PSDRUG(+PSDRUG,660)),U,2),0)),U)_"(S) to receive: " D ^DIR K DIR S (PSDREC,PSDREC(1))=Y I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDREC2",22,0)
DISP .W ?50,"Converted quantity: ",PSDREC*$P($G(^PSDRUG(+PSDRUG,660)),U,5) S PSDREC=$P($G(^(660)),U,5)*PSDREC
"RTN","PSDREC2",23,0)
 .;PSD*3*29 (Dave B) Check to see if drug actually stocked
"RTN","PSDREC2",24,0)
 .I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)) W !,"Sorry, but this drug is not stocked in this pharmacy location.",! Q
"RTN","PSDREC2",25,0)
PQ .S DIR(0)="Y",DIR("A")="OK to post",DIR("B")="Yes",DIR("?")="If yes, the balance will be updated and a transaction stored." D ^DIR K DIR D:Y=1  I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDREC2",26,0)
 ..W !!,"There were ",$S($P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4):$P($G(^(0)),U,4),1:0)," on hand.",?40,"There are now ",$P($G(^(0)),U,4)+PSDREC," on hand.",!
"RTN","PSDREC2",27,0)
 ..F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDREC2",28,0)
 ..D NOW^%DTC S PSDAT=+%
"RTN","PSDREC2",29,0)
 ..S PSDB=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDREC2",30,0)
 ..S $P(^PSD(58.8,+PSDLOC,1,+PSDRUG,0),U,4)=PSDREC+PSDB
"RTN","PSDREC2",31,0)
 ..L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0)
"RTN","PSDREC2",32,0)
 ..S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSDREC2",33,0)
 ..I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DIC(0)="L",DLAYGO=58.8,X=$E(DT,1,5)*100,DINUM=X,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DLAYGO
"RTN","PSDREC2",34,0)
 ..S DIE="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DA(2)=PSDLOC,DA(1)=PSDRUG,DA=$E(DT,1,5)*100,DR="5////^S X=$P($G(^(0)),U,3)+PSDREC" D ^DIE
"RTN","PSDREC2",35,0)
 ..W !,"Updating monthly receipts and transaction history.",!
"RTN","PSDREC2",36,0)
TR ..F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDREC2",37,0)
FIND ..S PSDT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSDT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSDREC2",38,0)
 ..S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSDT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSDREC2",39,0)
 ..S DIE="^PSD(58.81,",DA=PSDT,DR="1////1;2////^S X=PSDLOC;3////^S X=PSDAT;4////^S X=PSDRUG;5////^S X=PSDREC;6////^S X=DUZ;7////^S X=PSDCON;8////^S X=PSDPO;9////^S X=PSDB;100////1;71////^S X=$G(PSAPV)" D ^DIE
"RTN","PSDREC2",40,0)
 ..S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDREC2",41,0)
 ..S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSDREC2",42,0)
 ..S (X,DINUM)=PSDT
"RTN","PSDREC2",43,0)
 ..S DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DA,DLAYGO,PSDRUG
"RTN","PSDREC2",44,0)
QUIT Q
"RTN","PSDREC3")
0^41^B24878051^B24510249
"RTN","PSDREC3",1,0)
PSDREC3 ;BIR/LTL-CS Receiving (cont'd) ; 8 Aug 94
"RTN","PSDREC3",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**30,66**;13 Feb 97;Build 3
"RTN","PSDREC3",3,0)
 ;Reference to ^PRC(441 supported by IA #682
"RTN","PSDREC3",4,0)
 ;Reference to ^PRC(442 supported by IA #682
"RTN","PSDREC3",5,0)
 ;References to $$UNITCODE^PRCPUX1 are covered by IA #259
"RTN","PSDREC3",6,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDREC3",7,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDREC3",8,0)
 ;References to ^PSDRUG( are covered by IA #221
"RTN","PSDREC3",9,0)
 N X,X1 D SIG^XUSESIG Q:X1=""
"RTN","PSDREC3",10,0)
SEL F  S D0=+PSDPO,DIC="^PRC(442,"_+D0_",2,",DIC(0)="AEMQZ",DIC("A")="Select Line Item Number: ",D="B",DZ="??" D DQ^DICQ W ! D ^DIC K DIC Q:$D(DTOUT)!($D(DUOUT))!(Y<1)  S PSDI=+Y,PSDIT=Y(0) D  Q:$D(DTOUT)!($D(DUOUT))!(Y>1)
"RTN","PSDREC3",11,0)
 .S PSDPI=$O(^PRC(442,+PSDPO,2,+PSDIT,3,0)) D:$O(^PRC(442,+PSDPO,2,+PSDIT,3,PSDPI))  Q:Y<1
"RTN","PSDREC3",12,0)
PART ..S DIC="^PRC(442,+PSDPO,2,+PSDIT,3,",DIC(0)="AEMQZ",DIC("A")="Select Warehouse Receipt date: ",DA(2)=PSDPO,DA(1)=PSDIT,D="B",DZ="??" D DQ^DICQ W ! D ^DIC K DIC S PSDPI=+Y
"RTN","PSDREC3",13,0)
 .W !!,$P(PSDIT,U)
"RTN","PSDREC3",14,0)
 .S PSDW=0 F  S PSDW=$O(^PRC(442,+PSDPO,2,+PSDI,1,PSDW)) Q:'PSDW  W ?5,$E($P($G(^PRC(442,+PSDPO,2,+PSDI,1,PSDW,0)),U),1,75),!
"RTN","PSDREC3",15,0)
 .W !,"Packaging: ",$S($P(PSDIT,U,12):$P(PSDIT,U,12)_"/",1:"")
"RTN","PSDREC3",16,0)
 .;PSD*3*29 changed direct 420.5 lookup to supported IA #259
"RTN","PSDREC3",17,0)
 .W $$UNITCODE^PRCPUX1(+$P(PSDIT,U,3))
"RTN","PSDREC3",18,0)
 .W ?20,"Price :$",$P(PSDIT,U,9)
"RTN","PSDREC3",19,0)
 .W ?35,"Item #: ",$P(PSDIT,U,5),?50,"Vendor Stock #: ",$P(PSDIT,U,6),!
"RTN","PSDREC3",20,0)
NON .I '$P(PSDIT,U,5)!('$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")))!('$G(^PSD(58.8,+PSDLOC,1,+$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")),0))) D  Q:$D(DTOUT)!($D(DUOUT))!(Y<1)
"RTN","PSDREC3",21,0)
 ..S DIC="^PSD(58.8,PSDLOC,1,",DIC(0)="AEMQZ",DIC("A")="Select "_PSDLOCN_" drug: ",DIC("S")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)>DT,1:1)",DA(1)=PSDLOC D ^DIC K DIC Q:$D(DTOUT)!($D(DUOUT))!(Y<1)
"RTN","PSDREC3",22,0)
 ..S PSDRUG=+Y,PSDRUGN=$P($G(^PSDRUG(+Y,0)),U),PSDB=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDREC3",23,0)
 ..I $P(PSDIT,U,5),$E($G(^PRC(441,+$P(PSDIT,U,5),3)),1)'=1,'$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")) D
"RTN","PSDREC3",24,0)
 ...S DIR(0)="Y",DIR("A",1)="Are you sure that you want to link ITEM MASTER file entry,"
"RTN","PSDREC3",25,0)
 ...S DIR("A",2)="",DIR("A",3)=$P($G(^PRC(441,+$P(PSDIT,U,5),0)),U,2)_" to DRUG file entry,"
"RTN","PSDREC3",26,0)
 ...S DIR("A",4)="",DIR("A",5)=PSDRUGN,DIR("A")="Y/N",DIR("B")="Yes"
"RTN","PSDREC3",27,0)
 ...S DIR("?")="Once linked, future receipts for this item will be posted to this drug.",DIR("A",6)=""
"RTN","PSDREC3",28,0)
 ...W ! D ^DIR K DIR Q:Y<1
"RTN","PSDREC3",29,0)
 ...S DIE=50,DA=PSDRUG,DR="441///^S X=$P(PSDIT,U,5)" D ^DIE K DIE W:'$D(Y) !!,"Now, ",PSDRUGN," is linked to Item # ",$P(PSDIT,U,5),"." S Y=1
"RTN","PSDREC3",30,0)
IT .S:'$D(PSDRUG) PSDRUG=$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")),PSDRUGN=$P($G(^PSDRUG(+PSDRUG,0)),U)
"RTN","PSDREC3",31,0)
 .W !!,PSDRUGN,!!
"RTN","PSDREC3",32,0)
 .S DIE="^PSDRUG(",DA=PSDRUG,DR="15Dispense units per order unit;13Price per order unit" D ^DIE K DIE I $D(Y) K PSDRUG Q
"RTN","PSDREC3",33,0)
DISP .W !!,"Quantity rec'd: ",$P($G(^PRC(442,+PSDPO,2,+PSDI,3,+PSDPI,0)),U,2) S PSDREC=$P($G(^(0)),U,2)
"RTN","PSDREC3",34,0)
 .W ?40,"Converted quantity: ",PSDREC*$P($G(^PSDRUG(+PSDRUG,660)),U,5),! S PSDREC=$P($G(^(660)),U,5)*PSDREC
"RTN","PSDREC3",35,0)
 .;PSD*3*29 (Dave B) Check to see if drug actually stocked
"RTN","PSDREC3",36,0)
 .I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)) W !,"Sorry, but this drug is not stocked in this pharmacy location.",! Q
"RTN","PSDREC3",37,0)
POST .S DIR(0)="Y",DIR("A")="OK to post",DIR("B")="Yes",DIR("?")="If yes, the balance will be updated and a transaction stored." D ^DIR K DIR D:Y=1  K PSDRUG Q
"RTN","PSDREC3",38,0)
 ..W !!,"There were ",$S($P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4):$P($G(^(0)),U,4),1:0)," on hand.",?40,"There are now ",$P($G(^(0)),U,4)+PSDREC," on hand.",!
"RTN","PSDREC3",39,0)
 ..F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDREC3",40,0)
 ..D NOW^%DTC S PSDAT=+%
"RTN","PSDREC3",41,0)
 ..S PSDB=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDREC3",42,0)
 ..S $P(^PSD(58.8,+PSDLOC,1,+PSDRUG,0),U,4)=PSDREC+PSDB
"RTN","PSDREC3",43,0)
 ..L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0)
"RTN","PSDREC3",44,0)
MON ..S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSDREC3",45,0)
 ..I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DIC(0)="",X=$E(DT,1,5)*100,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC
"RTN","PSDREC3",46,0)
 ..S DIE="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DA(2)=PSDLOC,DA(1)=PSDRUG,DA=$E(DT,1,5)*100,DR="5////^S X=$P($G(^(0)),U,3)+PSDREC" D ^DIE
"RTN","PSDREC3",47,0)
 ..W !,"Updating monthly receipts and transaction history.",!
"RTN","PSDREC3",48,0)
TR ..F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDREC3",49,0)
FIND ..S PSDT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSDT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSDREC3",50,0)
 ..S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSDT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSDREC3",51,0)
 ..S DIE="^PSD(58.81,",DA=PSDT,DR="1////1;2////^S X=PSDLOC;3////^S X=PSDAT;4////^S X=PSDRUG;5////^S X=PSDREC;6////^S X=DUZ;7////^S X=PSDCON;8////^S X=PSDPO;9////^S X=PSDB;100////1" D ^DIE K DIE
"RTN","PSDREC3",52,0)
 ..S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDREC3",53,0)
 ..S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSDREC3",54,0)
 ..S (X,DINUM)=PSDT
"RTN","PSDREC3",55,0)
 ..S DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DA,DLAYGO,PSDRUG
"RTN","PSDREC3",56,0)
QUIT Q
"RTN","PSDREC4")
0^42^B28290989^B27923187
"RTN","PSDREC4",1,0)
PSDREC4 ;BIR/LTL-Issues Receiving ; 8 Aug 94
"RTN","PSDREC4",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**30,66**;13 Feb 97;Build 3
"RTN","PSDREC4",3,0)
 ;Reference to ^PRC(441 supported by IA #682
"RTN","PSDREC4",4,0)
 ;References to $$UNITCODE^PRCPUX1 are covered by IA #259
"RTN","PSDREC4",5,0)
 ;Reference to ^PRCS(410 supported by IA #214
"RTN","PSDREC4",6,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDREC4",7,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDREC4",8,0)
 ;References to ^PSDRUG( are covered by IA #221
"RTN","PSDREC4",9,0)
PRE I $O(^PSD(58.81,"E",+PSDCON,"")) W !!,"Previous receipts have been processed for this transaction.",! S DIR(0)="Y",DIR("A")="Would you like to review them before proceeding",DIR("B")="Yes" D ^DIR K DIR G:$D(DIRUT) QUIT G:Y=1 DEV^PSDREVC
"RTN","PSDREC4",10,0)
CHO S PSDI=0,DIR(0)="Y",DIR("A")="Loop through all items",DIR("B")="Yes",DIR("?")="If not, I will ask you to select the item(s) to receive." W ! D ^DIR K DIR G:$D(DIRUT) QUIT G:'Y SEL
"RTN","PSDREC4",11,0)
 F  S PSDI=$O(^PRCS(410,+PSDCON,"IT",PSDI)) G:'PSDI!($D(DTOUT))!($D(DUOUT)) QUIT S PSDIT=$G(^PRCS(410,+PSDCON,"IT",PSDI,0)) D ITEM G:$D(DTOUT)!($D(DUOUT))!($D(Y)) QUIT
"RTN","PSDREC4",12,0)
SEL F  S DIC="^PRCS(410,+PSDCON,""IT"",",DIC(0)="AEMQZ",DA(1)=PSDCON D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<1) QUIT S PSDI=+Y,PSDIT=Y(0) D ITEM G:$D(DTOUT)!($D(DUOUT)) QUIT
"RTN","PSDREC4",13,0)
ITEM W !!,$P(PSDIT,U)
"RTN","PSDREC4",14,0)
 S PSDW=0 F  S PSDW=$O(^PRCS(410,+PSDCON,"IT",+PSDI,1,PSDW)) Q:'PSDW  W ?5,$E($P($G(^PRCS(410,+PSDCON,"IT",+PSDI,1,PSDW,0)),U),1,75),!
"RTN","PSDREC4",15,0)
 W !,"Packaging: "
"RTN","PSDREC4",16,0)
 W $$UNITCODE^PRCPUX1(+$P(PSDIT,U,3))
"RTN","PSDREC4",17,0)
 W ?18,"Price :$",$P(PSDIT,U,7)
"RTN","PSDREC4",18,0)
 W ?33,"Item #: ",$P(PSDIT,U,5),?48,"Vendor Stock #: ",$P(PSDIT,U,6),!
"RTN","PSDREC4",19,0)
NON I $S('$P(PSDIT,U,5):1,'$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")):1,'$O(^PSD(58.8,PSDLOC,1,$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")),""))=0:1,1:0) D  Q:$D(DTOUT)!($D(DUOUT))!(Y<1)
"RTN","PSDREC4",20,0)
 .S DIC="^PSD(58.8,PSDLOC,1,",DIC(0)="AEMQZ",DIC("A")="Select "_PSDLOCN_" drug: ",DIC("S")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)>DT,1:1)",DA(1)=PSDLOC D ^DIC K DIC Q:$D(DTOUT)!($D(DUOUT))!(Y<1)
"RTN","PSDREC4",21,0)
 .S PSDRUG=+Y,PSDRUGN=$P($G(^PSDRUG(+Y,0)),U),PSDB=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDREC4",22,0)
 .I $P(PSDIT,U,5),$E($G(^PRC(441,+$P(PSDIT,U,5),3)),1)'=1,'$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")) D
"RTN","PSDREC4",23,0)
 ..S DIR(0)="Y",DIR("A",1)="Are you sure that you want to link ITEM MASTER file entry,"
"RTN","PSDREC4",24,0)
 ..S DIR("A",2)="",DIR("A",3)=$P($G(^PRC(441,+$P(PSDIT,U,5),0)),U,2)_" to DRUG file entry,"
"RTN","PSDREC4",25,0)
 ..S DIR("A",4)="",DIR("A",5)=PSDRUGN,DIR("A")="Y/N",DIR("B")="Yes"
"RTN","PSDREC4",26,0)
 ..S DIR("?")="Onced linked, future receipts for this item will be posted to this drug.",DIR("A",6)=""
"RTN","PSDREC4",27,0)
 ..W ! D ^DIR K DIR Q:Y<1
"RTN","PSDREC4",28,0)
 ..S DIE=50,DA=PSDRUG,DR="441///^S X=$P(PSDIT,U,5)" D ^DIE K DIE W:'$D(Y) !!,"Now, ",PSDRUGN," is linked to Item # ",$P(PSDIT,U,5),"." S Y=1
"RTN","PSDREC4",29,0)
IT S:'$D(PSDRUG) PSDRUG=$O(^PSDRUG("AB",+$P(PSDIT,U,5),"")),PSDRUGN=$P($G(^PSDRUG(+PSDRUG,0)),U)
"RTN","PSDREC4",30,0)
 W !!,PSDRUGN,!!
"RTN","PSDREC4",31,0)
 S DIE="^PSDRUG(",DA=PSDRUG,DR="15Dispense units per order unit;13Price per order unit" D ^DIE K DIE I $D(Y) K PSDRUG Q
"RTN","PSDREC4",32,0)
DISP W !!,"Quantity ordered: ",$P($G(^PRCS(410,+PSDCON,"IT",+PSDI,0)),U,2) S PSDREC=$P($G(^(0)),U,2)
"RTN","PSDREC4",33,0)
 I $P($G(^PRCS(410,+PSDCON,"IT",+PSDI,0)),U,12) W ?40,"Quantity warehouse posted: ",$P($G(^(0)),U,12) S PSDREC=$P($G(^(0)),U,12)
"RTN","PSDREC4",34,0)
 I $P($G(^PRCS(410,+PSDCON,"IT",+PSDI,0)),U,13) W !!,"Quantity received by Primary: ",$P($G(^(0)),U,13) S PSDREC=$P($G(^(0)),U,13)
"RTN","PSDREC4",35,0)
 W ?40,"Converted quantity: ",PSDREC*$P($G(^PSDRUG(+PSDRUG,660)),U,5),! S PSDREC=$P($G(^(660)),U,5)*PSDREC
"RTN","PSDREC4",36,0)
 ;PSD*3*29 (Dave B) Check to see if drug actually stocked
"RTN","PSDREC4",37,0)
 I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)) W !,"Sorry, but this drug is not stocked in this pharmacy location.",! Q
"RTN","PSDREC4",38,0)
POST S DIR(0)="Y",DIR("A")="OK to post",DIR("B")="Yes",DIR("?")="If yes, the balance will be updated and a transaction stored." D ^DIR K DIR D:Y=1  K PSDRUG Q
"RTN","PSDREC4",39,0)
 .W !!,"There were ",$S($P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4):$P($G(^(0)),U,4),1:0)," on hand.",?40,"There are now ",$P($G(^(0)),U,4)+PSDREC," on hand.",!
"RTN","PSDREC4",40,0)
 .F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDREC4",41,0)
 .D NOW^%DTC S PSDAT=+%
"RTN","PSDREC4",42,0)
 .S PSDB=$P($G(^PSD(58.8,+PSDLOC,1,+PSDRUG,0)),U,4)
"RTN","PSDREC4",43,0)
 .S $P(^PSD(58.8,+PSDLOC,1,+PSDRUG,0),U,4)=PSDREC+PSDB
"RTN","PSDREC4",44,0)
 .L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0)
"RTN","PSDREC4",45,0)
MON .S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSDREC4",46,0)
 .I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DIC(0)="",X=$E(DT,1,5)*100,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC
"RTN","PSDREC4",47,0)
 .S DIE="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DA(2)=PSDLOC,DA(1)=PSDRUG,DA=$E(DT,1,5)*100,DR="5////^S X=$P($G(^(0)),U,3)+PSDREC" D ^DIE
"RTN","PSDREC4",48,0)
 .W !,"Updating monthly receipts and transaction history.",!
"RTN","PSDREC4",49,0)
TR .F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDREC4",50,0)
FIND .S PSDT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSDT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSDREC4",51,0)
 .S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSDT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSDREC4",52,0)
 .S DIE="^PSD(58.81,",DA=PSDT,DR="1////1;2////^S X=PSDLOC;3////^S X=PSDAT;4////^S X=PSDRUG;5////^S X=PSDREC;6////^S X=DUZ;7////^S X=PSDCON;8////^S X=PSDPO;9////^S X=PSDB;100////1" D ^DIE K DIE
"RTN","PSDREC4",53,0)
 .S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDREC4",54,0)
 .S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSDREC4",55,0)
 .S (X,DINUM)=PSDT,DA(2)=PSDLOC,DA(1)=PSDRUG
"RTN","PSDREC4",56,0)
 .D ^DIC K DIC,DA,DLAYGO,PSDRUG
"RTN","PSDREC4",57,0)
QUIT Q
"RTN","PSDRF1")
0^43^B6890208^B6498777
"RTN","PSDRF1",1,0)
PSDRF1 ;B'ham ISC/JPW,LTL - File Dispensing Info ; 13 Dec 93
"RTN","PSDRF1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDRF1",3,0)
UPDAT I $G(PSDPN) F JJ=0:0 S JJ=$O(^PSD(58.8,"F",PSDPN,NAOU,PSDR,JJ)) Q:'JJ  S ORD=+JJ
"RTN","PSDRF1",4,0)
 ;$S(WQTY:18,CQTY:9,1:17) S:PSDTYP=9 QTY=CQTY-OQTY
"RTN","PSDRF1",5,0)
 W ?40,"Recording transaction...  "
"RTN","PSDRF1",6,0)
 D UPDATE W "done."
"RTN","PSDRF1",7,0)
END ;kill variables
"RTN","PSDRF1",8,0)
 K %,%DT,%H,%I,BAL,CQTY,DA,DIC,DIE,DIK,DINUM,DLAYGO,DR,JJ,LQTY,NAOUN,NODE,NUR2,OK,ORD
"RTN","PSDRF1",9,0)
 K PSD,PSDER,PSDREC,PSDRN,PSDT,PSDTN,QTY,WQTY,X,Y
"RTN","PSDRF1",10,0)
 Q
"RTN","PSDRF1",11,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDRF1",12,0)
 ;updating drug balance in 58.8
"RTN","PSDRF1",13,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDRF1",14,0)
 D NOW^%DTC S (PSDTN,PSDT)=+%
"RTN","PSDRF1",15,0)
 S BAL=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)-PSDQ
"RTN","PSDRF1",16,0)
 L -^PSD(58.8,NAOU,1,PSDR,0)
"RTN","PSDRF1",17,0)
 ;update order balance
"RTN","PSDRF1",18,0)
 ;I $G(ORD),$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),PSDTYP'=9 S $P(^(0),"^",22)=$P(^(0),"^",22)-PSDQ,DA=+$P(^(0),"^",17) D:$P(^(0),"^",22)=0  K DA,DIE,DR
"RTN","PSDRF1",19,0)
 ;.K DIE,DR S DIE="^PSD(58.81,",DR="10////12;11////1" D ^DIE K DA,DIE,DR
"RTN","PSDRF1",20,0)
 ;.K DA,DIE,DR S DIE="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,",DA=+ORD,DA(1)=+PSDR,DA(2)=+NAOU,DR="10////12;11////1" D ^DIE K DA,DIE,DR
"RTN","PSDRF1",21,0)
ADD ;find entry number in 58.81
"RTN","PSDRF1",22,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDRF1",23,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDRF1",24,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDRF1",25,0)
 L -^PSD(58.81,0)
"RTN","PSDRF1",26,0)
EDIT ;edit new transaction in 58.81
"RTN","PSDRF1",27,0)
 S ^PSD(58.81,PSDREC,0)=PSDREC_"^"_PSDTYP_"^"_NAOU_"^"_PSDT_"^"_PSDR_"^"_$S(PSDTYP=9:-PSDQ,1:PSDQ)_"^"_$G(NUR1)_"^^^"_BAL_"^^^^^^"_$S(PSDTYP=9:$G(PSDRE),1:"")_"^"_$G(PSDPN)_"^"_NAOU_"^^"_$G(ORD)
"RTN","PSDRF1",28,0)
 S ^PSD(58.81,PSDREC,9)=$G(PAT)_"^"_NUR1_"^"_OQTY_"^"_$G(WQTY)_"^"_$G(LQTY)_"^"_$G(NUR2)_"^"_BAL
"RTN","PSDRF1",29,0)
 ;S:PATL ^PSD(58.81,PSDREC,9.5)=PATL
"RTN","PSDRF1",30,0)
 S ^PSD(58.81,PSDREC,"CS")=1
"RTN","PSDRF1",31,0)
 K DA,DIK S DA=PSDREC,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDRF1",32,0)
 I PSDTYP'=17 D ERR
"RTN","PSDRF1",33,0)
 Q
"RTN","PSDRF1",34,0)
ERR ;err log update
"RTN","PSDRF1",35,0)
 F  L +^PSD(58.89,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDRF1",36,0)
FIND9 S PSDER=$P(^PSD(58.89,0),"^",3)+1 I $D(^PSD(58.89,PSDER)) S $P(^PSD(58.89,0),"^",3)=PSDER G FIND9
"RTN","PSDRF1",37,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.89,(X,DINUM)=PSDER D ^DIC K DIC,DLAYGO
"RTN","PSDRF1",38,0)
 L -^PSD(58.89,0)
"RTN","PSDRF1",39,0)
EDIT9 ;edit error log
"RTN","PSDRF1",40,0)
 K DA,DIE,DR S DA=PSDER,DIE=58.89,DR="1////"_PSDREC_";2////"_PSDT_";6////"_NAOU D ^DIE K DA,DIE,DR
"RTN","PSDRF1",41,0)
 S PHARM1=NUR1,QTY=PSDQ
"RTN","PSDRF1",42,0)
 S:$G(NAOUN)']"" NAOUN=$P($G(^PSD(58.8,NAOU,0)),U) D ^PSDRFM
"RTN","PSDRF1",43,0)
 Q
"RTN","PSDRFT")
0^44^B8906513^B8515082
"RTN","PSDRFT",1,0)
PSDRFT ;B'ham ISC/JPW,LTL - File Delayed Dispensing Info ; 13 Dec 93
"RTN","PSDRFT",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDRFT",3,0)
UPDAT I $G(PSDPN) F JJ=0:0 S JJ=$O(^PSD(58.8,"F",PSDPN,NAOU,PSDR,JJ)) Q:'JJ  S ORD=+JJ
"RTN","PSDRFT",4,0)
 ;$S(WQTY:18,CQTY:9,1:17) S:PSDTYP=9 QTY=CQTY-OQTY
"RTN","PSDRFT",5,0)
 W ?40,"Recording transaction...  "
"RTN","PSDRFT",6,0)
 D UPDATE W "done."
"RTN","PSDRFT",7,0)
END ;kill variables
"RTN","PSDRFT",8,0)
 K %,%DT,%H,%I,BAL,CQTY,DA,DIC,DIE,DIK,DINUM,DLAYGO,DR,JJ,LQTY,NAOUN,NODE,NUR2,OK,ORD
"RTN","PSDRFT",9,0)
 K PSD,PSDER,PSDREC,PSDRN,PSDT,PSDTN,QTY,WQTY,X,Y
"RTN","PSDRFT",10,0)
 Q
"RTN","PSDRFT",11,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDRFT",12,0)
 ;updating drug balance in 58.8
"RTN","PSDRFT",13,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDRFT",14,0)
 D NOW^%DTC S PSDTN=+%
"RTN","PSDRFT",15,0)
 S BAL=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)-PSDQ
"RTN","PSDRFT",16,0)
 L -^PSD(58.8,NAOU,1,PSDR,0)
"RTN","PSDRFT",17,0)
 ;update order balance
"RTN","PSDRFT",18,0)
 I $G(ORD),$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),PSDTYP'=9 S $P(^(0),"^",22)=$P(^(0),"^",22)-PSDQ,DA=+$P(^(0),"^",17) D:$P(^(0),"^",22)=0  K DA,DIE,DR
"RTN","PSDRFT",19,0)
 .K DIE,DR S DIE="^PSD(58.81,",DR="10////12;11////1" D ^DIE K DA,DIE,DR
"RTN","PSDRFT",20,0)
 .K DA,DIE,DR S DIE="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,",DA=+ORD,DA(1)=+PSDR,DA(2)=+NAOU,DR="10////12;11////1" D ^DIE K DA,DIE,DR
"RTN","PSDRFT",21,0)
ADD ;find entry number in 58.81
"RTN","PSDRFT",22,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDRFT",23,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDRFT",24,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDRFT",25,0)
 L -^PSD(58.81,0)
"RTN","PSDRFT",26,0)
EDIT ;edit new transaction in 58.81
"RTN","PSDRFT",27,0)
 S ^PSD(58.81,PSDREC,0)=PSDREC_"^"_PSDTYP_"^"_NAOU_"^"_PSDT_"^"_PSDR_"^"_$S(PSDTYP=9:-PSDQ,1:PSDQ)_"^"_$G(NUR1(1))_"^^^"_BAL_"^^^^^^Dose signed out during computer down time^"_$G(PSDPN)_"^"_NAOU_"^^"_$G(ORD)
"RTN","PSDRFT",28,0)
 S ^PSD(58.81,PSDREC,9)=$G(PAT)_"^"_NUR1_"^"_OQTY_"^"_$G(WQTY)_"^"_$G(LQTY)_"^"_$G(NUR2)_"^"_BAL
"RTN","PSDRFT",29,0)
 ;S:PATL ^PSD(58.81,PSDREC,9.5)=PATL
"RTN","PSDRFT",30,0)
 S ^PSD(58.81,PSDREC,"CS")=1
"RTN","PSDRFT",31,0)
 K DA,DIK S DA=PSDREC,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDRFT",32,0)
 I PSDTYP'=17 D ERR
"RTN","PSDRFT",33,0)
 Q
"RTN","PSDRFT",34,0)
ERR ;err log update
"RTN","PSDRFT",35,0)
 F  L +^PSD(58.89,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDRFT",36,0)
FIND9 S PSDER=$P(^PSD(58.89,0),"^",3)+1 I $D(^PSD(58.89,PSDER)) S $P(^PSD(58.89,0),"^",3)=PSDER G FIND9
"RTN","PSDRFT",37,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.89,(X,DINUM)=PSDER D ^DIC K DIC,DLAYGO
"RTN","PSDRFT",38,0)
 L -^PSD(58.89,0)
"RTN","PSDRFT",39,0)
EDIT9 ;edit error log
"RTN","PSDRFT",40,0)
 K DA,DIE,DR S DA=PSDER,DIE=58.89,DR="1////"_PSDREC_";2////"_PSDT_";6////"_NAOU D ^DIE K DA,DIE,DR
"RTN","PSDRFT",41,0)
 S PHARM1=NUR1,QTY=PSDQ
"RTN","PSDRFT",42,0)
 S:$G(NAOUN)']"" NAOUN=$P($G(^PSD(58.8,NAOU,0)),U) D ^PSDRFM
"RTN","PSDRFT",43,0)
 Q
"RTN","PSDRFX")
0^45^B7927778^B7519175
"RTN","PSDRFX",1,0)
PSDRFX ;B'ham ISC/JPW,LTL,BJW - File Dispensing Info ; 14 May 98
"RTN","PSDRFX",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**7,66**;13 Feb 97;Build 3
"RTN","PSDRFX",3,0)
 ;inserted line 15 to save date return for activity rpt
"RTN","PSDRFX",4,0)
UPDAT I $G(PSDPN) F JJ=0:0 S JJ=$O(^PSD(58.8,"F",PSDPN,NAOU,PSDR,JJ)) Q:'JJ  S ORD=+JJ
"RTN","PSDRFX",5,0)
 ;$S(WQTY:18,CQTY:9,1:17) S:PSDTYP=9 QTY=CQTY-OQTY
"RTN","PSDRFX",6,0)
 W ?40,"Recording transaction...  "
"RTN","PSDRFX",7,0)
 D UPDATE W "done."
"RTN","PSDRFX",8,0)
END ;kill variables
"RTN","PSDRFX",9,0)
 K %,%DT,%H,%I,BAL,CQTY,DA,DIC,DIE,DIK,DINUM,DLAYGO,DR,JJ,LQTY,NAOUN,NODE,NUR2,OK,ORD
"RTN","PSDRFX",10,0)
 K PSD,PSDER,PSDREC,PSDRN,PSDT,PSDTN,QTY,WQTY,X,Y
"RTN","PSDRFX",11,0)
 Q
"RTN","PSDRFX",12,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDRFX",13,0)
 ;updating drug balance in 58.8
"RTN","PSDRFX",14,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDRFX",15,0)
 D NOW^%DTC S (PSDTN,PSDT)=+%
"RTN","PSDRFX",16,0)
 S BAL=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)+WQTY
"RTN","PSDRFX",17,0)
 L -^PSD(58.8,NAOU,1,PSDR,0)
"RTN","PSDRFX",18,0)
 S $P(^PSD(58.81,+PSDA(1),3),"^")=$G(PSDRET)
"RTN","PSDRFX",19,0)
 S $P(^PSD(58.81,+PSDA(1),3),U,2)=$P($G(^(3)),U,2)+WQTY K WQTY
"RTN","PSDRFX",20,0)
 S $P(^PSD(58.81,+PSDA(1),3),U,3)=$G(PSDRE(1)) G EDIT
"RTN","PSDRFX",21,0)
 ;update order balance
"RTN","PSDRFX",22,0)
 I $G(ORD),$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),PSDTYP'=9 S $P(^(0),"^",22)=$P(^(0),"^",22)-PSDQ,DA=+$P(^(0),"^",17) D:$P(^(0),"^",22)=0  K DA,DIE,DR
"RTN","PSDRFX",23,0)
 .K DIE,DR S DIE="^PSD(58.81,",DR="10////12;11////1" D ^DIE K DA,DIE,DR
"RTN","PSDRFX",24,0)
 .K DA,DIE,DR S DIE="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,",DA=+ORD,DA(1)=+PSDR,DA(2)=+NAOU,DR="10////12;11////1" D ^DIE K DA,DIE,DR
"RTN","PSDRFX",25,0)
ADD ;find entry number in 58.81
"RTN","PSDRFX",26,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDRFX",27,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDRFX",28,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDRFX",29,0)
 L -^PSD(58.81,0)
"RTN","PSDRFX",30,0)
EDIT ;edit transaction in 58.81
"RTN","PSDRFX",31,0)
 S $P(^PSD(58.81,PSDA(1),0),U,16)=$G(PSDRE)
"RTN","PSDRFX",32,0)
 S $P(^PSD(58.81,PSDA(1),0),U,6)=$S($G(WQTY)&('$G(PSDQ(1))):PSDQ+WQTY,'$G(PSDQ(2)):PSDQ,1:OQTY-$G(PSDQ(2)))
"RTN","PSDRFX",33,0)
 S:$G(WQTY) $P(^PSD(58.81,PSDA(1),9),U,4)=WQTY
"RTN","PSDRFX",34,0)
 S $P(^PSD(58.81,PSDA(1),9),U,6)=$G(NUR2)
"RTN","PSDRFX",35,0)
 K DA,DIK S DA=PSDA(1),DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDRFX",36,0)
 ;I PSDTYP'=17 D ERR
"RTN","PSDRFX",37,0)
 Q
"RTN","PSDRFX",38,0)
ERR ;err log update
"RTN","PSDRFX",39,0)
 F  L +^PSD(58.89,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDRFX",40,0)
FIND9 S PSDER=$P(^PSD(58.89,0),"^",3)+1 I $D(^PSD(58.89,PSDER)) S $P(^PSD(58.89,0),"^",3)=PSDER G FIND9
"RTN","PSDRFX",41,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.89,(X,DINUM)=PSDER D ^DIC K DIC,DLAYGO
"RTN","PSDRFX",42,0)
 L -^PSD(58.89,0)
"RTN","PSDRFX",43,0)
EDIT9 ;edit error log
"RTN","PSDRFX",44,0)
 K DA,DIE,DR S DA=PSDER,DIE=58.89,DR="1////"_PSDREC_";2////"_PSDT_";6////"_NAOU D ^DIE K DA,DIE,DR
"RTN","PSDRFX",45,0)
 S PHARM1=NUR1,QTY=PSDQ
"RTN","PSDRFX",46,0)
 S:$G(NAOUN)']"" NAOUN=$P($G(^PSD(58.8,NAOU,0)),U) D ^PSDRFM
"RTN","PSDRFX",47,0)
 Q
"RTN","PSDTRV1")
0^46^B13150808^B12908934
"RTN","PSDTRV1",1,0)
PSDTRV1 ;BIR/JPW-Transfer CS Drugs between Vaults (cont'd) ; 17 Nov 93
"RTN","PSDTRV1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**66**;13 Feb 97;Build 3
"RTN","PSDTRV1",3,0)
UPDATE ;update vault balances
"RTN","PSDTRV1",4,0)
 D CHK G:PSDLES END
"RTN","PSDTRV1",5,0)
 W !!,"Updating vault on-hand balances now..." F CNT=1:1:2 D CALC
"RTN","PSDTRV1",6,0)
 W "done!",!! D:ADD MSG
"RTN","PSDTRV1",7,0)
 S (ADD,PSDOUT)=0
"RTN","PSDTRV1",8,0)
END K %,%H,%I,BAL,CNT,DA,DD,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DO,DR,DTOUT,DUOUT,EXP,JJ,LOT,MFG,NBKU,NPKG,PSDT,PSDLES,PSDR,PSDREC,PSDRN
"RTN","PSDTRV1",9,0)
 K QTY,RDT,TEMP,TQTY,VAULT,VAULTN,X,XMDUZ,XMSUB,XMTEXT,XMY,Y
"RTN","PSDTRV1",10,0)
 Q
"RTN","PSDTRV1",11,0)
CALC ;sub/add qty from dsp sites
"RTN","PSDTRV1",12,0)
 W $S(CNT=2:VAULTN,1:PSDSN)_"..."
"RTN","PSDTRV1",13,0)
 S TEMP=$S(CNT=2:VAULT,1:PSDS),TQTY=-TQTY
"RTN","PSDTRV1",14,0)
 F  L +^PSD(58.8,TEMP,1,PSDR,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDTRV1",15,0)
 D NOW^%DTC S PSDT=+%
"RTN","PSDTRV1",16,0)
 S BAL(CNT)=$P(^PSD(58.8,TEMP,1,PSDR,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)+TQTY,$P(BAL(CNT),"^",2)=+BAL(CNT)+TQTY
"RTN","PSDTRV1",17,0)
 L -^PSD(58.8,TEMP,1,PSDR,0)
"RTN","PSDTRV1",18,0)
ADD ;find entry number
"RTN","PSDTRV1",19,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSDTRV1",20,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDTRV1",21,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDTRV1",22,0)
 L -^PSD(58.81,0)
"RTN","PSDTRV1",23,0)
DIE ;update transaction data
"RTN","PSDTRV1",24,0)
 K DA,DIE,DR S DA=PSDREC,DIE=58.81
"RTN","PSDTRV1",25,0)
 S DR="1////16;2////"_+TEMP_";4////"_PSDR_";3////"_PSDT_";Q;5////"_TQTY_";6////"_PSDUZ_";9////"_$P(BAL(CNT),"^")_";100////1"
"RTN","PSDTRV1",26,0)
 D ^DIE K DA,DIE,DR W !,"Still updating..."
"RTN","PSDTRV1",27,0)
 ;update vault drug info
"RTN","PSDTRV1",28,0)
 I CNT=2 K DA,DIE,DR S DIE="^PSD(58.8,"_+TEMP_",1,",DA(1)=+TEMP,DA=+PSDR,DR="I 'ADD S Y=9;7////"_NBKU_";8////"_NPKG_";9////"_MFG_";10////"_LOT_";11////"_EXP D ^DIE K DA,DIE,DR
"RTN","PSDTRV1",29,0)
 S:'$D(^PSD(58.8,+TEMP,1,+PSDR,4,0)) ^PSD(58.8,+TEMP,1,+PSDR,4,0)="^58.800119PA^^"
"RTN","PSDTRV1",30,0)
 I '$D(^PSD(58.8,+TEMP,1,+PSDR,4,PSDREC,0)) K DA,DIC,DD,DO S DIC(0)="L",DIC="^PSD(58.8,"_+TEMP_",1,"_+PSDR_",4,",DA(2)=+TEMP,DA(1)=+PSDR,(X,DINUM)=PSDREC D FILE^DICN K DA,DIC
"RTN","PSDTRV1",31,0)
 Q
"RTN","PSDTRV1",32,0)
CHK ;check for valid bal
"RTN","PSDTRV1",33,0)
 S PSDLES=0 D:TQTY>$P(^PSD(58.8,PSDS,1,PSDR,0),"^",4)
"RTN","PSDTRV1",34,0)
 .W $C(7),!!,"=>   The drug balance is "_+$P(^PSD(58.8,PSDS,1,PSDR,0),"^",4)_".  You cannot transfer "_TQTY_" for this drug.",! S PSDLES=1
"RTN","PSDTRV1",35,0)
 .W "No action taken.",!
"RTN","PSDTRV1",36,0)
 Q
"RTN","PSDTRV1",37,0)
MSG ;send mailman message with transfer info
"RTN","PSDTRV1",38,0)
 K XMY,^TMP("PSDTRV",$J) D NOW^%DTC S Y=X X ^DD("DD") S RDT=Y S ^TMP("PSDTRV",$J,1,0)="Controlled Substances have been transferred between Dispensing Sites."
"RTN","PSDTRV1",39,0)
 S ^TMP("PSDTRV",$J,2,0)="Run Date: "_RDT,^TMP("PSDTRV",$J,3,0)=""
"RTN","PSDTRV1",40,0)
 S ^TMP("PSDTRV",$J,4,0)="Drug: "_PSDRN
"RTN","PSDTRV1",41,0)
 S ^TMP("PSDTRV",$J,5,0)="Transferred from: "_PSDSN,^TMP("PSDTRV",$J,6,0)="Transferred and Added to: "_VAULTN
"RTN","PSDTRV1",42,0)
 S ^TMP("PSDTRV",$J,7,0)="Quantity ("_NBKU_"): "_TQTY,^TMP("PSDTRV",$J,8,0)="Pharmacist: "_PSDUZN
"RTN","PSDTRV1",43,0)
 S XMSUB="CS DRUG TRANSFER BETWEEN VAULTS",XMTEXT="^TMP(""PSDTRV"",$J,",XMDUZ="CONTROLLED SUBSTANCES PHARMACY" F JJ=0:0 S JJ=$O(^XUSEC("PSDMGR",JJ)) Q:'JJ  S XMY(JJ)=""
"RTN","PSDTRV1",44,0)
 S:'$D(XMY) XMY(.5)="" D ^XMD K XMY,^TMP("PSDTRV",$J)
"RTN","PSDTRV1",45,0)
 Q
"VER")
8.0^22.0
"BLD",6354,6)
^53
**END**
**END**
