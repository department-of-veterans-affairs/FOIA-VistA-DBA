Released GMRC*3*17 SEQ #21
Extracted from mail message
**KIDS**:GMRC*3.0*17^

**INSTALL NAME**
GMRC*3.0*17
"BLD",2527,0)
GMRC*3.0*17^CONSULT/REQUEST TRACKING^0^3011015^y
"BLD",2527,1,0)
^^2^2^3010817^
"BLD",2527,1,1,0)
See the National Patch Module for complete details of enhancements
"BLD",2527,1,2,0)
included in this patch.
"BLD",2527,4,0)
^9.64PA^123^2
"BLD",2527,4,123,0)
123
"BLD",2527,4,123,2,0)
^9.641^123^1
"BLD",2527,4,123,2,123,0)
REQUEST/CONSULTATION  (File-top level)
"BLD",2527,4,123,2,123,1,0)
^9.6411^.02^2
"BLD",2527,4,123,2,123,1,.02,0)
PATIENT NAME
"BLD",2527,4,123,2,123,1,1.01,0)
CLINICAL PROCEDURE
"BLD",2527,4,123,222)
y^y^p^^^^n
"BLD",2527,4,123.3,0)
123.3
"BLD",2527,4,123.3,2,0)
^9.641^123.3^1
"BLD",2527,4,123.3,2,123.3,0)
GMRC PROCEDURE  (File-top level)
"BLD",2527,4,123.3,2,123.3,1,0)
^9.6411^.04^1
"BLD",2527,4,123.3,2,123.3,1,.04,0)
CLINICAL PROCEDURE
"BLD",2527,4,123.3,222)
y^n^p^^^^n
"BLD",2527,4,"APDD",123,123)

"BLD",2527,4,"APDD",123,123,.02)

"BLD",2527,4,"APDD",123,123,1.01)

"BLD",2527,4,"APDD",123.3,123.3)

"BLD",2527,4,"APDD",123.3,123.3,.04)

"BLD",2527,4,"B",123,123)

"BLD",2527,4,"B",123.3,123.3)

"BLD",2527,"ABPKG")
n
"BLD",2527,"INI")

"BLD",2527,"INID")
^^
"BLD",2527,"KRN",0)
^9.67PA^19^17
"BLD",2527,"KRN",.4,0)
.4
"BLD",2527,"KRN",.401,0)
.401
"BLD",2527,"KRN",.402,0)
.402
"BLD",2527,"KRN",.402,"NM",0)
^9.68A^1^1
"BLD",2527,"KRN",.402,"NM",1,0)
GMRC PROCEDURE SETUP    FILE #123.3^123.3^0
"BLD",2527,"KRN",.402,"NM","B","GMRC PROCEDURE SETUP    FILE #123.3",1)

"BLD",2527,"KRN",.403,0)
.403
"BLD",2527,"KRN",.5,0)
.5
"BLD",2527,"KRN",.84,0)
.84
"BLD",2527,"KRN",3.6,0)
3.6
"BLD",2527,"KRN",3.8,0)
3.8
"BLD",2527,"KRN",9.2,0)
9.2
"BLD",2527,"KRN",9.8,0)
9.8
"BLD",2527,"KRN",9.8,"NM",0)
^9.68A^16^16
"BLD",2527,"KRN",9.8,"NM",1,0)
GMRCACTM^^0^B5430495
"BLD",2527,"KRN",9.8,"NM",2,0)
GMRCTIUE^^0^B57975134
"BLD",2527,"KRN",9.8,"NM",3,0)
GMRCTIU^^0^B16136277
"BLD",2527,"KRN",9.8,"NM",4,0)
GMRCP^^0^B10719046
"BLD",2527,"KRN",9.8,"NM",5,0)
GMRCSLM1^^0^B47319589
"BLD",2527,"KRN",9.8,"NM",6,0)
GMRCGUIU^^0^B28332520
"BLD",2527,"KRN",9.8,"NM",7,0)
GMRCHL7B^^0^B17883968
"BLD",2527,"KRN",9.8,"NM",8,0)
GMRCCP^^0^B21540282
"BLD",2527,"KRN",9.8,"NM",9,0)
GMRCSLM2^^0^B32804894
"BLD",2527,"KRN",9.8,"NM",10,0)
GMRCTIUP^^0^B17215428
"BLD",2527,"KRN",9.8,"NM",11,0)
GMRCGUIB^^0^B37448368
"BLD",2527,"KRN",9.8,"NM",12,0)
GMRCUTL1^^0^B13566722
"BLD",2527,"KRN",9.8,"NM",13,0)
GMRCART^^0^B38192228
"BLD",2527,"KRN",9.8,"NM",14,0)
GMRCAU^^0^B64054664
"BLD",2527,"KRN",9.8,"NM",15,0)
GMRCTIU1^^0^B25703402
"BLD",2527,"KRN",9.8,"NM",16,0)
GMRCALOR^^0^B3703473
"BLD",2527,"KRN",9.8,"NM","B","GMRCACTM",1)

"BLD",2527,"KRN",9.8,"NM","B","GMRCALOR",16)

"BLD",2527,"KRN",9.8,"NM","B","GMRCART",13)

"BLD",2527,"KRN",9.8,"NM","B","GMRCAU",14)

"BLD",2527,"KRN",9.8,"NM","B","GMRCCP",8)

"BLD",2527,"KRN",9.8,"NM","B","GMRCGUIB",11)

"BLD",2527,"KRN",9.8,"NM","B","GMRCGUIU",6)

"BLD",2527,"KRN",9.8,"NM","B","GMRCHL7B",7)

"BLD",2527,"KRN",9.8,"NM","B","GMRCP",4)

"BLD",2527,"KRN",9.8,"NM","B","GMRCSLM1",5)

"BLD",2527,"KRN",9.8,"NM","B","GMRCSLM2",9)

"BLD",2527,"KRN",9.8,"NM","B","GMRCTIU",3)

"BLD",2527,"KRN",9.8,"NM","B","GMRCTIU1",15)

"BLD",2527,"KRN",9.8,"NM","B","GMRCTIUE",2)

"BLD",2527,"KRN",9.8,"NM","B","GMRCTIUP",10)

"BLD",2527,"KRN",9.8,"NM","B","GMRCUTL1",12)

"BLD",2527,"KRN",19,0)
19
"BLD",2527,"KRN",19.1,0)
19.1
"BLD",2527,"KRN",101,0)
101
"BLD",2527,"KRN",409.61,0)
409.61
"BLD",2527,"KRN",771,0)
771
"BLD",2527,"KRN",870,0)
870
"BLD",2527,"KRN",8994,0)
8994
"BLD",2527,"KRN","B",.4,.4)

"BLD",2527,"KRN","B",.401,.401)

"BLD",2527,"KRN","B",.402,.402)

"BLD",2527,"KRN","B",.403,.403)

"BLD",2527,"KRN","B",.5,.5)

"BLD",2527,"KRN","B",.84,.84)

"BLD",2527,"KRN","B",3.6,3.6)

"BLD",2527,"KRN","B",3.8,3.8)

"BLD",2527,"KRN","B",9.2,9.2)

"BLD",2527,"KRN","B",9.8,9.8)

"BLD",2527,"KRN","B",19,19)

"BLD",2527,"KRN","B",19.1,19.1)

"BLD",2527,"KRN","B",101,101)

"BLD",2527,"KRN","B",409.61,409.61)

"BLD",2527,"KRN","B",771,771)

"BLD",2527,"KRN","B",870,870)

"BLD",2527,"KRN","B",8994,8994)

"BLD",2527,"QUES",0)
^9.62^^
"BLD",2527,"REQB",0)
^9.611^8^8
"BLD",2527,"REQB",1,0)
GMRC*3.0*15^2
"BLD",2527,"REQB",2,0)
OR*3.0*102^2
"BLD",2527,"REQB",3,0)
TIU*1.0*100^2
"BLD",2527,"REQB",4,0)
OR*3.0*85^2
"BLD",2527,"REQB",5,0)
GMRC*3.0*4^2
"BLD",2527,"REQB",6,0)
GMRC*3.0*20^2
"BLD",2527,"REQB",7,0)
GMRC*3.0*21^2
"BLD",2527,"REQB",8,0)
GMRC*3.0*1^2
"BLD",2527,"REQB","B","GMRC*3.0*1",8)

"BLD",2527,"REQB","B","GMRC*3.0*15",1)

"BLD",2527,"REQB","B","GMRC*3.0*20",6)

"BLD",2527,"REQB","B","GMRC*3.0*21",7)

"BLD",2527,"REQB","B","GMRC*3.0*4",5)

"BLD",2527,"REQB","B","OR*3.0*102",2)

"BLD",2527,"REQB","B","OR*3.0*85",4)

"BLD",2527,"REQB","B","TIU*1.0*100",3)

"FIA",123)
REQUEST/CONSULTATION
"FIA",123,0)
^GMR(123,
"FIA",123,0,0)
123DI
"FIA",123,0,1)
y^y^p^^^^n
"FIA",123,0,10)

"FIA",123,0,11)

"FIA",123,0,"RLRO")

"FIA",123,0,"VR")
3.0^GMRC
"FIA",123,123)
1
"FIA",123,123,.02)

"FIA",123,123,1.01)

"FIA",123.3)
GMRC PROCEDURE
"FIA",123.3,0)
^GMR(123.3,
"FIA",123.3,0,0)
123.3O
"FIA",123.3,0,1)
y^n^p^^^^n
"FIA",123.3,0,10)

"FIA",123.3,0,11)

"FIA",123.3,0,"RLRO")

"FIA",123.3,0,"VR")
3.0^GMRC
"FIA",123.3,123.3)
1
"FIA",123.3,123.3,.04)

"IX",123,123,"ACP",0)
123^ACP^Index on the PATIENT NAME and CLINICAL PROCEDURE fields^R^^R^IR^I^123^^^^^S
"IX",123,123,"ACP",.1,0)
^^1^1^3011008^
"IX",123,123,"ACP",.1,1,0)
This INDEX is used to list all Clinical Procedure requests for a patient.
"IX",123,123,"ACP",1)
S ^GMR(123,"ACP",X(1),X(2),DA)=""
"IX",123,123,"ACP",2)
K ^GMR(123,"ACP",X(1),X(2),DA)
"IX",123,123,"ACP",2.5)
K ^GMR(123,"ACP")
"IX",123,123,"ACP",11.1,0)
^.114IA^2^2
"IX",123,123,"ACP",11.1,1,0)
1^F^123^1.01^^1^F
"IX",123,123,"ACP",11.1,2,0)
2^F^123^.02^^2^F
"KRN",.402,1391,-1)
0^1
"KRN",.402,1391,0)
GMRC PROCEDURE SETUP^3010816.1055^@^123.3^^@^3011004
"KRN",.402,1391,"DIAB",1,1,123.31,0)
ALL
"KRN",.402,1391,"DIAB",1,1,123.32,0)
ALL
"KRN",.402,1391,"DIAB",5,0,123.3,0)
.02//"YES"
"KRN",.402,1391,"DR",1,123.3)
.01;I '$G(GMRCNEW) S Y="@99";D EN^DDIOL("The new procedure will not be orderable unless the INACTIVE flag is deleted.");Q;.02//^S X="YES";S Y="@999";@99;.02;@999;1;2;.05;I '$$VERSION^XPDUTL("MD") S Y="@9999";.04;@9999;
"KRN",.402,1391,"DR",1,123.3,1)
D EN^DDIOL(" ");125;.07;.08;124;.09;S Y="^";
"KRN",.402,1391,"DR",2,123.31)
.01
"KRN",.402,1391,"DR",2,123.32)
.01
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"PKG",128,-1)
1^1
"PKG",128,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",128,20,0)
^9.402P^^
"PKG",128,22,0)
^9.49I^1^1
"PKG",128,22,1,0)
3.0^2980101
"PKG",128,22,1,"PAH",1,0)
17^3011015^1322
"PKG",128,22,1,"PAH",1,1,0)
^^2^2^3011015
"PKG",128,22,1,"PAH",1,1,1,0)
See the National Patch Module for complete details of enhancements
"PKG",128,22,1,"PAH",1,1,2,0)
included in this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
16
"RTN","GMRCACTM")
0^1^B5430495
"RTN","GMRCACTM",1,0)
GMRCACTM ; SLC/DLT,DCM,JFR - Set action menus  ;2/21/01 22:41
"RTN","GMRCACTM",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,11,18,15,17**;DEC 27, 1997
"RTN","GMRCACTM",3,0)
 ;
"RTN","GMRCACTM",4,0)
 ; This routine invokes IA #2425
"RTN","GMRCACTM",5,0)
 ;
"RTN","GMRCACTM",6,0)
CPRS(GMRCPM,GUI) ;Entry point for setting menu actions for CPRS user
"RTN","GMRCACTM",7,0)
 ;Input:
"RTN","GMRCACTM",8,0)
 ;  GMRCPM=a list of File 123 IEN's to check for menu actions.
"RTN","GMRCACTM",9,0)
 ;       Passed in as '300;303;295;309;313'
"RTN","GMRCACTM",10,0)
 ;  GUI =1 if coming from the GUI; return field name in ORFLG also
"RTN","GMRCACTM",11,0)
 ;Output:
"RTN","GMRCACTM",12,0)
 ;  ORFLG(ien)= A^B^C^D^E^F^G^H where:
"RTN","GMRCACTM",13,0)
 ;    Ien = internal entry of record in file 123
"RTN","GMRCACTM",14,0)
 ;    A = a number representing one of the following:
"RTN","GMRCACTM",15,0)
 ;       1 - user has only review capabilities
"RTN","GMRCACTM",16,0)
 ;       2 - user has full update capabilities
"RTN","GMRCACTM",17,0)
 ;       3 - user has administrative update capabilities
"RTN","GMRCACTM",18,0)
 ;       4 - user has full update and admin user capabilities
"RTN","GMRCACTM",19,0)
 ;    B = field in file 123.5 (REQUEST SERVICES) that gave the user 
"RTN","GMRCACTM",20,0)
 ;        update authority (ex.  Update user w/o Notification)
"RTN","GMRCACTM",21,0)
 ;    C = Service in file 123.5 (REQUEST SERVICES) that gave the user
"RTN","GMRCACTM",22,0)
 ;        update authority (ex. CARDIOLOGY,NEUROLOGY)
"RTN","GMRCACTM",23,0)
 ;    D = contains a 1 if user is allowed to associate medicine results
"RTN","GMRCACTM",24,0)
 ;        with a consult procedure request
"RTN","GMRCACTM",25,0)
 ;    F = contain a 1 if user can disassociate a medicine result that was
"RTN","GMRCACTM",26,0)
 ;        incorrectly associated with a consult procedure request
"RTN","GMRCACTM",27,0)
 ;    G = contains a 1 if user is allowed to EDIT and RESUBMIT a canceled
"RTN","GMRCACTM",28,0)
 ;        request
"RTN","GMRCACTM",29,0)
 ;    H = 0-4 depending on actions allowed on a Clin. Proc. request
"RTN","GMRCACTM",30,0)
 ;
"RTN","GMRCACTM",31,0)
 I '$L(GMRCPM) S ORFLG=1 Q
"RTN","GMRCACTM",32,0)
 K ORFLG
"RTN","GMRCACTM",33,0)
 N I,GMRCSS,GMRCIEN
"RTN","GMRCACTM",34,0)
 F I=1:1 S ORFLG=1,GMRCIEN=$P(GMRCPM,";",I) Q:GMRCIEN=""  D
"RTN","GMRCACTM",35,0)
 .S ORFLG(GMRCIEN)=1 ;set default answer to read only
"RTN","GMRCACTM",36,0)
 .S GMRCSS=+$P($G(^GMR(123,+GMRCIEN,0)),"^",5)
"RTN","GMRCACTM",37,0)
 .Q:'+$G(GMRCSS)
"RTN","GMRCACTM",38,0)
 .;when service is defined, check for service user 
"RTN","GMRCACTM",39,0)
 .D EN
"RTN","GMRCACTM",40,0)
 .S ORFLG(GMRCIEN)=ORFLG
"RTN","GMRCACTM",41,0)
 . ;what actions to allow if a Clincial Procedure
"RTN","GMRCACTM",42,0)
 . S $P(ORFLG(GMRCIEN),U,7)=$$CPACTM^GMRCCP(GMRCIEN)
"RTN","GMRCACTM",43,0)
 .I ORFLG>1 D
"RTN","GMRCACTM",44,0)
 .. ;can DUZ associate med results?  only if not a CP!
"RTN","GMRCACTM",45,0)
 .. N P4
"RTN","GMRCACTM",46,0)
 .. S P4=$S(+$P(ORFLG(GMRCIEN),U,7):0,1:$$CANDOMED^GMRCGUIU(GMRCIEN))
"RTN","GMRCACTM",47,0)
 .. S $P(ORFLG(GMRCIEN),U,4)=P4
"RTN","GMRCACTM",48,0)
 . ;can DUZ disassociate a med result?
"RTN","GMRCACTM",49,0)
 . S $P(ORFLG(GMRCIEN),U,5)=+$$REMUSR^GMRCDIS(GMRCIEN)
"RTN","GMRCACTM",50,0)
 . ;can user edit/resubmit
"RTN","GMRCACTM",51,0)
 . I $$VALPROV^GMRCEDIT(GMRCIEN) S $P(ORFLG(GMRCIEN),U,6)=1
"RTN","GMRCACTM",52,0)
 . Q
"RTN","GMRCACTM",53,0)
 Q
"RTN","GMRCACTM",54,0)
 ;
"RTN","GMRCACTM",55,0)
EN ;Set GMRCACTM with appropriate menu of actions based on user
"RTN","GMRCACTM",56,0)
 ;If ORFLG is DEFINED then GMRCACTM is returned as a set of codes:
"RTN","GMRCACTM",57,0)
 ;    1 = GMRCACTM USER REVIEW SCREEN - simple actions
"RTN","GMRCACTM",58,0)
 ;    2 = GMRCACTM SERVICE ACTION menu  - all actions possible for
"RTN","GMRCACTM",59,0)
 ;        clinical user in service
"RTN","GMRCACTM",60,0)
 ;    3 =  administrative user
"RTN","GMRCACTM",61,0)
 ; initialize GMRCACTM for read only
"RTN","GMRCACTM",62,0)
 S GMRCACTM="GMRCACTM USER REVIEW SCREEN"
"RTN","GMRCACTM",63,0)
 ; if service and entry aren't defined, assume read only access
"RTN","GMRCACTM",64,0)
 I '$D(XQADATA),$S('+$G(GMRCSS):1,1:0) D  Q
"RTN","GMRCACTM",65,0)
 .I $D(ORFLG) S ORFLG(GMRCIEN)=1 K GMRCACTM
"RTN","GMRCACTM",66,0)
 .Q
"RTN","GMRCACTM",67,0)
 ;
"RTN","GMRCACTM",68,0)
 ;Get the users service update level
"RTN","GMRCACTM",69,0)
 N GMRCFLG
"RTN","GMRCACTM",70,0)
 S GMRCFLG=$$VALID^GMRCAU(+GMRCSS,"",,$G(GUI))
"RTN","GMRCACTM",71,0)
 ;
"RTN","GMRCACTM",72,0)
 ;If ORFLG is all that should be returned, than set and exit
"RTN","GMRCACTM",73,0)
 I $D(ORFLG) D  Q
"RTN","GMRCACTM",74,0)
 . K GMRCACTM
"RTN","GMRCACTM",75,0)
 . I GMRCFLG=0 S ORFLG=1 Q
"RTN","GMRCACTM",76,0)
 . S ORFLG=GMRCFLG Q
"RTN","GMRCACTM",77,0)
 ;Process the GMRCFLG value to get the GMRCACTM defined.
"RTN","GMRCACTM",78,0)
 I GMRCFLG>0 D  Q
"RTN","GMRCACTM",79,0)
 . S GMRCACTM="GMRCACTM SERVICE ACTION MENU"
"RTN","GMRCACTM",80,0)
 Q
"RTN","GMRCALOR")
0^16^B3703473
"RTN","GMRCALOR",1,0)
GMRCALOR ;SLC/DCM - Process a consult from an alert notification ;10/9/01 23:11
"RTN","GMRCALOR",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,17**;DEC 27, 1997
"RTN","GMRCALOR",3,0)
EN(XQDFN,XQCON) ;process alert from notification screen - entry point to main routine
"RTN","GMRCALOR",4,0)
 ;XQDFN=XQAID       XQCON=XQADATA from CPRS alerts
"RTN","GMRCALOR",5,0)
 I +$G(XQCON)<1 S GMRCQIT=1 Q
"RTN","GMRCALOR",6,0)
 K XQAKILL,^TMP("GMRCR",$J,"CS"),^TMP("GMRCS",$J),^TMP("GMRCSLIST",$J)
"RTN","GMRCALOR",7,0)
 S DFN=$P(XQDFN,",",2)
"RTN","GMRCALOR",8,0)
 S (GMRCO,GMRCDA)=$S(XQCON=+XQCON:XQCON,$P(XQCON,";",3)?.N1",GMRC".E:+$P(XQCON,";",3),XQCON?1N.N1",GMRC".E:+XQCON,$P(XQCON,"|",2)["TIU(8925":+XQCON,$P(XQCON,"|",2)]"":+$P(XQCON,"|",2),1:$P($P(XQCON,";",3),",",1))
"RTN","GMRCALOR",9,0)
 S GMRCSS=$S($P(^GMR(123,GMRCDA,0),"^",5)]"":$P(^(0),"^",5),1:"")
"RTN","GMRCALOR",10,0)
 I $L(GMRCSS) S ^TMP("GMRCS",$J,GMRCSS)=$S(+GMRCSS:$P(^GMR(123.5,GMRCSS,0),"^",1),1:$O(^GMR(123.5,"B",GMRCSS,0)))
"RTN","GMRCALOR",11,0)
 I $S('$L(GMRCSS):1,^TMP("GMRCS",$J,GMRCSS)="":1,1:0) S ^TMP("GMRCS",$J,1)="Unknown"
"RTN","GMRCALOR",12,0)
 S TAB="",$P(TAB," ",30)="",BLK=0,LNCT=1,GMRCD=0,GMRCDT1="ALL",GMRCDT2=DT S:'$D(GMRCOER) GMRCOER=0
"RTN","GMRCALOR",13,0)
 K ^TMP("GMRCR",$J,"CS")
"RTN","GMRCALOR",14,0)
 D SET^GMRCSLM1,END^GMRCSLM1
"RTN","GMRCALOR",15,0)
 K GMRCWARD,GMRCAD,GMRCSSNM
"RTN","GMRCALOR",16,0)
 Q
"RTN","GMRCALOR",17,0)
 ;
"RTN","GMRCALOR",18,0)
GUI(XQDFN,XQCON) ;entry point for getting consult info for GUI interface
"RTN","GMRCALOR",19,0)
 K ^TMP("GMRCR",$J,"CS")
"RTN","GMRCALOR",20,0)
 S DFN=$P(XQDFN,",",2),GMRCDA=$P($P(XQCON,";",2),",")
"RTN","GMRCALOR",21,0)
 S TAB="",$P(TAB," ",30)="",BLK=0,LNCT=1,GMRCD=0,GMRCDT1="ALL",GMRCDT2=0,GMRCOER=1
"RTN","GMRCALOR",22,0)
 D SET^GMRCSLM1,END^GMRCSLM1
"RTN","GMRCALOR",23,0)
 Q
"RTN","GMRCART")
0^13^B38192228
"RTN","GMRCART",1,0)
GMRCART ;SLC/DCM,DLT - Result display logic ;8/28/01 09:58
"RTN","GMRCART",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,15,17**;DEC 27, 1997
"RTN","GMRCART",3,0)
 ;
"RTN","GMRCART",4,0)
 ; This routine invokes IA #2638
"RTN","GMRCART",5,0)
 ;
"RTN","GMRCART",6,0)
RT(GMRCO) ;Result Display logic - called from GMRCA1
"RTN","GMRCART",7,0)
 N GMRCCT,GMRCTMP,GMRCSR,GMRCTUFN,GMRCSTS,GMRCMSG
"RTN","GMRCART",8,0)
 ;
"RTN","GMRCART",9,0)
 S GMRCSR=$P($G(^GMR(123,+GMRCO,0)),"^",15),GMRCTUFN=$P(^(0),"^",20)
"RTN","GMRCART",10,0)
 S GMRCSTS=$P($G(^GMR(123,+GMRCO,0)),"^",12)
"RTN","GMRCART",11,0)
 I '$$RESOLUS^GMRCAU(GMRCSTS),('+GMRCSR&('GMRCTUFN)) S GMRCMSG="No results available for review." D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCART",12,0)
 ;
"RTN","GMRCART",13,0)
 W !,"Compiling Result Display..."
"RTN","GMRCART",14,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCART",15,0)
 K ^TMP("GMRCR",$J,"DT") S GMRCCT=1
"RTN","GMRCART",16,0)
 S XQORM("A")="Select Action: "
"RTN","GMRCART",17,0)
 S:$D(VALMAR) GMRCVAL=VALMAR
"RTN","GMRCART",18,0)
 S GMRCTMP="^TMP(""GMRCR"",$J,""DT"")"
"RTN","GMRCART",19,0)
 S GMRCDVL="",$P(GMRCDVL,"-",41)=""
"RTN","GMRCART",20,0)
 ;
"RTN","GMRCART",21,0)
 D GETRSLT(GMRCTMP)
"RTN","GMRCART",22,0)
 ;
"RTN","GMRCART",23,0)
 D EN^VALM("GMRC RESULTS DISPLAY")
"RTN","GMRCART",24,0)
 S:$D(GMRCVAL) VALMAR=GMRCVAL S:$D(LNCT) VALMCNT=LNCT
"RTN","GMRCART",25,0)
 D KILL^VALM10()
"RTN","GMRCART",26,0)
 K OREND,ORAGE,ORIO,ORDOB,ORFT,ORHI,ORIFN,ORNP,ORL,ORPD,ORPNM,ORPV,ORSEQ,ORSEX,ORWARD,ORDG
"RTN","GMRCART",27,0)
 K GMRCDVL,GMRCLCT,GMRCRPT,GMRCTUFN,GMRCVAL,MCFILE,MCPROC,GMRCX,GMRCTO,GMRCPRNM
"RTN","GMRCART",28,0)
 D END
"RTN","GMRCART",29,0)
 Q
"RTN","GMRCART",30,0)
 ;
"RTN","GMRCART",31,0)
GETRSLT(TMPGLOB) ;load the results into global defined in TMPGLOB
"RTN","GMRCART",32,0)
 ;used for GUI formated results and list manager
"RTN","GMRCART",33,0)
 N GMRCCT,GMRCCTS,SF,TAB
"RTN","GMRCART",34,0)
 S TAB="",$P(TAB," ",31)=""
"RTN","GMRCART",35,0)
 S GMRCDVL="",$P(GMRCDVL,"-",41)=""
"RTN","GMRCART",36,0)
 K @TMPGLOB
"RTN","GMRCART",37,0)
 S GMRCCT=1
"RTN","GMRCART",38,0)
 I $L($P(^GMR(123,GMRCO,0),"^",19)) S SF=$P(^(0),"^",19),@TMPGLOB@(GMRCCT,0)="Significant Findings: "_$S(SF="Y":"**Yes**",SF="N":"No",1:"Unknown"),GMRCCT=GMRCCT+1
"RTN","GMRCART",39,0)
 ;S @TMPGLOB@(GMRCCT,0)=GMRCDVL_GMRCDVL,GMRCCT=GMRCCT+1 ;GMRCDVL_GMRCDVL
"RTN","GMRCART",40,0)
 D PRINT^GMRCTIUP(GMRCO,GMRCCT,1)
"RTN","GMRCART",41,0)
 S GMRCCTS=GMRCCT ;save the line count before printing med and TIU notes
"RTN","GMRCART",42,0)
 D GETMCAR
"RTN","GMRCART",43,0)
 D GETCP
"RTN","GMRCART",44,0)
 D GETRES
"RTN","GMRCART",45,0)
 I GMRCCT=GMRCCTS D  ;check if count changed for notes or med results
"RTN","GMRCART",46,0)
 . S:+$L($G(SF)) @TMPGLOB@(GMRCCT,0)=GMRCDVL_GMRCDVL,GMRCCT=GMRCCT+1 ;GMRCDVL_GMRCDVL
"RTN","GMRCART",47,0)
 . S @TMPGLOB@(GMRCCT,0)="No TIU results or Medicine results available for this consult"
"RTN","GMRCART",48,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCART",49,0)
 ;
"RTN","GMRCART",50,0)
 D GETCOM
"RTN","GMRCART",51,0)
 I GMRCCT>2 S @TMPGLOB@(GMRCCT,0)="",$P(@TMPGLOB@(GMRCCT,0),"=",81)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",52,0)
 Q
"RTN","GMRCART",53,0)
 ;
"RTN","GMRCART",54,0)
GETMCAR ;load the medicine results into TMPGLOB
"RTN","GMRCART",55,0)
 Q:'$O(^TMP("GMRCR",$J,"MCAR",0))
"RTN","GMRCART",56,0)
 N ND,ND1
"RTN","GMRCART",57,0)
 S ND=0 F  S ND=$O(^TMP("GMRCR",$J,"MCAR",ND)) Q:ND=""!(ND?1A.E)  D
"RTN","GMRCART",58,0)
 .S @TMPGLOB@(GMRCCT,0)="",$P(^(0),"-",80)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",59,0)
 .S @TMPGLOB@(GMRCCT,0)=TAB_"Medicine Package Report",GMRCCT=GMRCCT+1
"RTN","GMRCART",60,0)
 .S ND1=0 F  S ND1=$O(^TMP("GMRCR",$J,"MCAR",ND,ND1)) Q:ND1=""  S @TMPGLOB@(GMRCCT,0)=^TMP("GMRCR",$J,"MCAR",ND,ND1,0),GMRCCT=GMRCCT+1
"RTN","GMRCART",61,0)
 .Q
"RTN","GMRCART",62,0)
 K ^TMP("GMRCR",$J,"MCAR")
"RTN","GMRCART",63,0)
 Q
"RTN","GMRCART",64,0)
 ;
"RTN","GMRCART",65,0)
GETCP ; Load up any Clin. Proc. results
"RTN","GMRCART",66,0)
 Q:'$O(^TMP("GMRCR",$J,"CP",0))
"RTN","GMRCART",67,0)
 N ND,ND1
"RTN","GMRCART",68,0)
 S ND=0 F  S ND=$O(^TMP("GMRCR",$J,"CP",ND)) Q:ND=""!(ND?1A.E)  D
"RTN","GMRCART",69,0)
 .S @TMPGLOB@(GMRCCT,0)="",$P(^(0),"-",80)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",70,0)
 .S @TMPGLOB@(GMRCCT,0)=TAB_"Clinical Procedure Report",GMRCCT=GMRCCT+1
"RTN","GMRCART",71,0)
 .S ND1=0 F  S ND1=$O(^TMP("GMRCR",$J,"CP",ND,ND1)) Q:ND1=""  D
"RTN","GMRCART",72,0)
 .. S @TMPGLOB@(GMRCCT,0)=^TMP("GMRCR",$J,"CP",ND,ND1,0),GMRCCT=GMRCCT+1
"RTN","GMRCART",73,0)
 .Q
"RTN","GMRCART",74,0)
 K ^TMP("GMRCR",$J,"CP")
"RTN","GMRCART",75,0)
 Q
"RTN","GMRCART",76,0)
 ;
"RTN","GMRCART",77,0)
GETRES ;load the TIU notes into TMPGLOB
"RTN","GMRCART",78,0)
 Q:'+$O(^TMP("GMRCR",$J,"RES",0))
"RTN","GMRCART",79,0)
 ;
"RTN","GMRCART",80,0)
 N ND,ND1
"RTN","GMRCART",81,0)
 S ND=0 F  S ND=$O(^TMP("GMRCR",$J,"RES",ND)) Q:(ND="")!(ND?1A.E)  D
"RTN","GMRCART",82,0)
 . I $D(^TMP("GMRCR",$J,"RES",ND,"TEXT","GMRCRPT")) D
"RTN","GMRCART",83,0)
 . . S @TMPGLOB@(GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",84,0)
 . . S @TMPGLOB@(GMRCCT,0)=$E(GMRCDVL,1,80-$L(^TMP("GMRCR",$J,"RES",ND,"TEXT","GMRCRPT"))\2)_^("GMRCRPT")_$E(GMRCDVL,1,80-$L(^("GMRCRPT"))\2)
"RTN","GMRCART",85,0)
 . . S GMRCCT=GMRCCT+1
"RTN","GMRCART",86,0)
 . S:'$D(^TMP("GMRCR",$J,"RES",ND,"TEXT","GMRCRPT")) @TMPGLOB@(GMRCCT,0)=GMRCDVL_GMRCDVL,GMRCCT=GMRCCT+1
"RTN","GMRCART",87,0)
 . S:$O(^TMP("GMRCR",$J,"RES",ND,"TEXT",0)) @TMPGLOB@(GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",88,0)
 . S ND1=0 F  S ND1=$O(^TMP("GMRCR",$J,"RES",ND,"TEXT",ND1)) Q:ND1?1A.E!(ND1="")  S @TMPGLOB@(GMRCCT,0)=^TMP("GMRCR",$J,"RES",ND,"TEXT",ND1,0),GMRCCT=GMRCCT+1
"RTN","GMRCART",89,0)
 . I $O(^TMP("GMRCR",$J,"RES",ND,"ADD",0)) S ND1=0 F  S ND1=$O(^TMP("GMRCR",$J,"RES",ND,"ADD",ND1)) Q:ND1=""   D
"RTN","GMRCART",90,0)
 . . S @TMPGLOB@(GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",91,0)
 . . S @TMPGLOB@(GMRCCT,0)=TAB_"ADDENDUM TO REPORT",GMRCCT=GMRCCT+1
"RTN","GMRCART",92,0)
 . . S ND2=0 F  S ND2=$O(^TMP("GMRCR",$J,"RES",ND,"ADD",ND1,ND2)) Q:ND2=""!(ND2?1A.E)  S @TMPGLOB@(GMRCCT,0)=^TMP("GMRCR",$J,"RES",ND,"ADD",ND1,ND2,0),GMRCCT=GMRCCT+1
"RTN","GMRCART",93,0)
 . . Q
"RTN","GMRCART",94,0)
 . Q
"RTN","GMRCART",95,0)
 K ^TMP("GMRCR",$J,"RES")
"RTN","GMRCART",96,0)
 Q
"RTN","GMRCART",97,0)
 ;
"RTN","GMRCART",98,0)
GETCOM ;Get the comments for resolution actions
"RTN","GMRCART",99,0)
 S GMRCSTS=$P($G(^GMR(123,+GMRCO,0)),"^",12)
"RTN","GMRCART",100,0)
 Q:'$$RESOLUS^GMRCAU(+GMRCSTS) 
"RTN","GMRCART",101,0)
 ;
"RTN","GMRCART",102,0)
 ;Loop thru actions to find the resolution type actions
"RTN","GMRCART",103,0)
 N ND,ND1,ND2
"RTN","GMRCART",104,0)
 S ND="" F  S ND=$O(^GMR(123,+GMRCO,40,"B",ND)) Q:ND=""  S ND1=$O(^GMR(123,+GMRCO,40,"B",ND,"")) D
"RTN","GMRCART",105,0)
 . ;
"RTN","GMRCART",106,0)
 . ;Check for resulting action types:complete,sig finding,dc,cancel
"RTN","GMRCART",107,0)
 . N GMRCAIEN
"RTN","GMRCART",108,0)
 . S GMRCAIEN=$P($G(^GMR(123,+GMRCO,40,ND1,0)),"^",2)
"RTN","GMRCART",109,0)
 . I '$$RESOLUA^GMRCAU(GMRCAIEN) Q
"RTN","GMRCART",110,0)
 . ;
"RTN","GMRCART",111,0)
 . ;save the action header info in case there are comments
"RTN","GMRCART",112,0)
 . N GMRCAHDR,GMRCPROV,GMRCENBY,GMRCENDT
"RTN","GMRCART",113,0)
 . D SAVEHDR
"RTN","GMRCART",114,0)
 . ;
"RTN","GMRCART",115,0)
 . ;check for comments, print header on first pass
"RTN","GMRCART",116,0)
 . S ND2=0
"RTN","GMRCART",117,0)
 . F  S ND2=$O(^GMR(123,GMRCO,40,ND1,1,ND2)) Q:ND2=""  D
"RTN","GMRCART",118,0)
 . . I +$G(GMRCAHDR) D GETHDR ;GMRCAHDR will =1 on first pass
"RTN","GMRCART",119,0)
 . . S @TMPGLOB@(GMRCCT,0)=^GMR(123,GMRCO,40,ND1,1,ND2,0),GMRCCT=GMRCCT+1
"RTN","GMRCART",120,0)
 . . Q
"RTN","GMRCART",121,0)
 . Q
"RTN","GMRCART",122,0)
 Q
"RTN","GMRCART",123,0)
 ;
"RTN","GMRCART",124,0)
SAVEHDR ;Save the action header info to print later if there are comments
"RTN","GMRCART",125,0)
 S GMRCAHDR=1 ;flag to print action header on first pass of comments
"RTN","GMRCART",126,0)
 ;save the provider, entered by and date
"RTN","GMRCART",127,0)
 S GMRCPROV=$P(^GMR(123,GMRCO,40,ND1,0),"^",4),GMRCENBY=$P(^(0),"^",5)
"RTN","GMRCART",128,0)
 S GMRCENDT=$$FMTE^XLFDT($P($G(^GMR(123,GMRCO,40,ND1,0)),"^",3))
"RTN","GMRCART",129,0)
 Q
"RTN","GMRCART",130,0)
 ;
"RTN","GMRCART",131,0)
GETHDR ;Print the comment header if the action had a comment
"RTN","GMRCART",132,0)
 S @TMPGLOB@(GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",133,0)
 S @TMPGLOB@(GMRCCT,0)=$$CENTER^GMRCP5D("("_$P($G(^GMR(123.1,GMRCAIEN,0)),"^",8)_" Comment)"),GMRCCT=GMRCCT+1
"RTN","GMRCART",134,0)
 S @TMPGLOB@(GMRCCT,0)="      Entered by: "_$S($L(GMRCENBY):$P(^VA(200,GMRCENBY,0),"^",1),1:"")_" - "_GMRCENDT,GMRCCT=GMRCCT+1
"RTN","GMRCART",135,0)
 I +GMRCPROV S @TMPGLOB@(GMRCCT,0)="      Responsible Clinician: "_$P($G(^VA(200,GMRCPROV,0)),"^",1),GMRCCT=GMRCCT+1
"RTN","GMRCART",136,0)
 K GMRCAHDR
"RTN","GMRCART",137,0)
 Q
"RTN","GMRCART",138,0)
 ; 
"RTN","GMRCART",139,0)
END ;kill off variables and exit
"RTN","GMRCART",140,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCART",141,0)
 K DTOUT,DIROUT,DUOUT
"RTN","GMRCART",142,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCART",143,0)
 Q
"RTN","GMRCAU")
0^14^B64054664
"RTN","GMRCAU",1,0)
GMRCAU ;SLC/DLT,JFR - Action Utilities  ;10/9/01 23:12
"RTN","GMRCAU",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,11,14,12,15,17**;DEC 27, 1997
"RTN","GMRCAU",3,0)
 ;
"RTN","GMRCAU",4,0)
 ; This routine invokes IA #2324,#2692
"RTN","GMRCAU",5,0)
 ;
"RTN","GMRCAU",6,0)
GETPROV K GMRCORNP N DIR S DIR(0)="123.02,3"
"RTN","GMRCAU",7,0)
 S DIR("A")=$S($D(GETPROV):GETPROV,1:"Responsible Clinician")
"RTN","GMRCAU",8,0)
 D ^DIR K DIR I $D(DTOUT)!$D(DIROUT)!(X="^") S GMRCQIT="Q" Q
"RTN","GMRCAU",9,0)
 G:Y<1 GETPROV S GMRCORNP=+Y
"RTN","GMRCAU",10,0)
 Q
"RTN","GMRCAU",11,0)
GETDT ;Get actual activity date
"RTN","GMRCAU",12,0)
 K GMRCQIT,%
"RTN","GMRCAU",13,0)
 D NOW^%DTC S (X,GMRCDT)=% D REGDTM^GMRCU S GMRCAD=X
"RTN","GMRCAU",14,0)
 S DIR(0)="123.02,2",DIR("A")=$S($D(GETDT):GETDT,1:"Date/Time of Actual Activity"),DIR("B")="NOW" D ^DIR K DIR I $D(DIRUT) S GMRCQIT="Q" Q
"RTN","GMRCAU",15,0)
 I X="NOW" K GMRCAD,Y Q
"RTN","GMRCAU",16,0)
 S GMRCAD=Y K X,Y,DIRUT,DUOUT
"RTN","GMRCAU",17,0)
 Q
"RTN","GMRCAU",18,0)
ORTX(GMRCO) ;Get the abbreviated text for alert displays
"RTN","GMRCAU",19,0)
 ;GMRCO is the consult entry from 123
"RTN","GMRCAU",20,0)
 N GMRCSVC,GMRCSSNM,GMRCPROC,GMRCORTX
"RTN","GMRCAU",21,0)
 S GMRCSSNM=$$SVC(GMRCO)
"RTN","GMRCAU",22,0)
 S GMRCPROC=$$PROC(GMRCO)
"RTN","GMRCAU",23,0)
 S GMRCORTX=$S($L(GMRCPROC):($E(GMRCSSNM,1,10)_" "_$E(GMRCPROC,1,10)),1:$E(GMRCSSNM,1,20))
"RTN","GMRCAU",24,0)
 Q GMRCORTX
"RTN","GMRCAU",25,0)
 ;
"RTN","GMRCAU",26,0)
SVC(GMRCO) ;Get abbreviated service text
"RTN","GMRCAU",27,0)
 N GMRCSSNM,GMRCSVC
"RTN","GMRCAU",28,0)
 S GMRCSVC=$P(^GMR(123,+GMRCO,0),"^",5),GMRCSSNM=""
"RTN","GMRCAU",29,0)
 I +GMRCSVC S GMRCSSNM=$S($L($G(^GMR(123.5,+GMRCSVC,.1))):^(.1),1:$P($G(^GMR(123.5,+GMRCSVC,0)),U,1))
"RTN","GMRCAU",30,0)
 Q GMRCSSNM
"RTN","GMRCAU",31,0)
PROC(GMRCO) ;Get abbreviated procedure text
"RTN","GMRCAU",32,0)
 N GMRCPROC
"RTN","GMRCAU",33,0)
 S GMRCPROC=$P(^GMR(123,+GMRCO,0),"^",8)
"RTN","GMRCAU",34,0)
 I +GMRCPROC S GMRCPROC=$$GET1^DIQ(123.3,+GMRCPROC,.01)
"RTN","GMRCAU",35,0)
 Q GMRCPROC
"RTN","GMRCAU",36,0)
 ;
"RTN","GMRCAU",37,0)
LMTX(GMRCO) ;Get the text for list manager displays
"RTN","GMRCAU",38,0)
 ;GMRCO is the consult entry from 123
"RTN","GMRCAU",39,0)
 N GMRCSVC,GMRCSSNM,GMRCREQ,GMRCORTX
"RTN","GMRCAU",40,0)
 S GMRCSSNM=$$SVC(GMRCO)
"RTN","GMRCAU",41,0)
 S GMRCREQ=$$PROC(GMRCO)
"RTN","GMRCAU",42,0)
 S GMRCORTX=$S($L(GMRCREQ):($E(GMRCSSNM,1,10)_" "_$E(GMRCREQ,1,10)),1:$E(GMRCSSNM,1,20))
"RTN","GMRCAU",43,0)
 Q GMRCORTX
"RTN","GMRCAU",44,0)
 ;
"RTN","GMRCAU",45,0)
 ;
"RTN","GMRCAU",46,0)
VALID(GMRCSER,GMRCO,GMRCUSER,GMRCTST) ;Get users update authority
"RTN","GMRCAU",47,0)
 ; check GMRCSS and all parents for authority
"RTN","GMRCAU",48,0)
 ; codes returned are same as $$VALIDU
"RTN","GMRCAU",49,0)
 N GMRCUPDL,GMRCLIS,GMRCHKD,GMRCNT,GMRCLP,GMRCQUIT
"RTN","GMRCAU",50,0)
 I '$G(GMRCUSER) S GMRCUSER=DUZ
"RTN","GMRCAU",51,0)
 ; check initial service first
"RTN","GMRCAU",52,0)
 S GMRCUPDL=$$VALIDU(GMRCSER,GMRCUSER) I +GMRCUPDL D  G VALEX
"RTN","GMRCAU",53,0)
 . I $G(GMRCTST) S $P(GMRCUPDL,U,3)=$P($G(^GMR(123.5,+GMRCSER,0)),U)
"RTN","GMRCAU",54,0)
 S GMRCHKD(GMRCSER)="",GMRCNT=1
"RTN","GMRCAU",55,0)
 ; find parents if set to process, quit if none
"RTN","GMRCAU",56,0)
 I '$P($G(^GMR(123.5,+GMRCSER,0)),U,7) G VALEX ;process parents = 0
"RTN","GMRCAU",57,0)
 D FINDPAR(GMRCSER,.GMRCNT) I '$D(GMRCLIS) S GMRCUPDL=0 G VALEX
"RTN","GMRCAU",58,0)
 S GMRCLP=0
"RTN","GMRCAU",59,0)
 F  S GMRCLP=$O(GMRCLIS(GMRCLP)) Q:'GMRCLP!($D(GMRCQUIT))  D  I +GMRCUPDL G VALEX
"RTN","GMRCAU",60,0)
 . I +$P(GMRCLIS(GMRCLP),U,2) K GMRCLIS(GMRCLP) Q  ;been checked
"RTN","GMRCAU",61,0)
 . I '$D(GMRCHKD(+GMRCLIS(GMRCLP))) D
"RTN","GMRCAU",62,0)
 .. ; check parent 
"RTN","GMRCAU",63,0)
 .. S GMRCUPDL=$$VALIDU(+GMRCLIS(GMRCLP),GMRCUSER)
"RTN","GMRCAU",64,0)
 .. S GMRCHKD(+GMRCLIS(GMRCLP))=""
"RTN","GMRCAU",65,0)
 . S $P(GMRCLIS(GMRCLP),U,2)=1
"RTN","GMRCAU",66,0)
 . I +GMRCUPDL D  Q  ;got one
"RTN","GMRCAU",67,0)
 .. S:$G(GMRCTST) $P(GMRCUPDL,U,3)=$P($G(^GMR(123.5,+GMRCLIS(GMRCLP),0)),U)
"RTN","GMRCAU",68,0)
 . I $P(^GMR(123.5,+GMRCLIS(GMRCLP),0),U,7) D  ;process parents
"RTN","GMRCAU",69,0)
 .. D FINDPAR(+GMRCLIS(GMRCLP),.GMRCNT)
"RTN","GMRCAU",70,0)
 . S GMRCLP=0 ;start back at top and don't miss any
"RTN","GMRCAU",71,0)
VALEX Q GMRCUPDL
"RTN","GMRCAU",72,0)
FINDPAR(SERV,ARCNT)     ;find parents of SERV
"RTN","GMRCAU",73,0)
 ; SERV = service to find parents of
"RTN","GMRCAU",74,0)
 ; ARCNT = next array element
"RTN","GMRCAU",75,0)
 N PARENT
"RTN","GMRCAU",76,0)
 S PARENT=0
"RTN","GMRCAU",77,0)
 F  S PARENT=$O(^GMR(123.5,"APC",SERV,PARENT)) Q:'PARENT  D
"RTN","GMRCAU",78,0)
 . S GMRCLIS(ARCNT)=PARENT
"RTN","GMRCAU",79,0)
 . S ARCNT=ARCNT+1
"RTN","GMRCAU",80,0)
 Q
"RTN","GMRCAU",81,0)
 ;
"RTN","GMRCAU",82,0)
VALIDU(GMRCSS,GMRCUSR) ;Check to see if user is an update user
"RTN","GMRCAU",83,0)
 ;The value returned is the equivalent of this set of codes:
"RTN","GMRCAU",84,0)
 ;    0 = not an update user
"RTN","GMRCAU",85,0)
 ;    2 = update user
"RTN","GMRCAU",86,0)
 ;    3 = administrative update user
"RTN","GMRCAU",87,0)
 ;    4 = admin AND update user
"RTN","GMRCAU",88,0)
 ;
"RTN","GMRCAU",89,0)
 N GMRCUPD,GMRCAD,GMRCUP
"RTN","GMRCAU",90,0)
 I '$G(GMRCUSR) S GMRCUSR=DUZ
"RTN","GMRCAU",91,0)
 I '+$G(GMRCSS) Q 0
"RTN","GMRCAU",92,0)
 S GMRCAD=0,GMRCUP=0
"RTN","GMRCAU",93,0)
 I +$P($G(^GMR(123.5,GMRCSS,0)),U,6) S GMRCUP=2_$$FIELD(.06)
"RTN","GMRCAU",94,0)
 I 'GMRCUP,$D(^GMR(123.5,+GMRCSS,123.3,"B",GMRCUSR)) D
"RTN","GMRCAU",95,0)
 . S GMRCUP=2_$$FIELD(123.3)
"RTN","GMRCAU",96,0)
 I 'GMRCUP,GMRCUSR=$P($G(^GMR(123.5,+GMRCSS,123)),"^",8) D
"RTN","GMRCAU",97,0)
 . S GMRCUP=2_$$FIELD(123.08)
"RTN","GMRCAU",98,0)
 I $D(^GMR(123.5,+GMRCSS,123.33,"B",GMRCUSR)) S GMRCAD=3_$$FIELD(123.33)
"RTN","GMRCAU",99,0)
 ;
"RTN","GMRCAU",100,0)
 I GMRCAD,GMRCUP Q $$BOTH(GMRCAD,GMRCUP) ;admin and upd user
"RTN","GMRCAU",101,0)
 ;
"RTN","GMRCAU",102,0)
 S GMRCUPD=0
"RTN","GMRCAU",103,0)
 ; check service teams to notify, update teams w/o
"RTN","GMRCAU",104,0)
 I 'GMRCUP N NODE F NODE=123.1,123.31 D  I +GMRCUP Q
"RTN","GMRCAU",105,0)
 . I '$D(^GMR(123.5,+GMRCSS,NODE)) Q
"RTN","GMRCAU",106,0)
 . D TEAM(.GMRCUP,NODE,GMRCUSR)
"RTN","GMRCAU",107,0)
 ;
"RTN","GMRCAU",108,0)
 I GMRCAD,GMRCUP Q $$BOTH(GMRCUP,GMRCAD) ;admin and upd user
"RTN","GMRCAU",109,0)
 ;
"RTN","GMRCAU",110,0)
 I 'GMRCAD D  ;check adm teams w/o
"RTN","GMRCAU",111,0)
 . I '$D(^GMR(123.5,+GMRCSS,123.34)) Q
"RTN","GMRCAU",112,0)
 . D TEAM(.GMRCAD,123.34,GMRCUSR)
"RTN","GMRCAU",113,0)
 ; 
"RTN","GMRCAU",114,0)
 I GMRCAD,GMRCUP Q $$BOTH(GMRCUP,GMRCAD) ;admin and upd user
"RTN","GMRCAU",115,0)
 ;
"RTN","GMRCAU",116,0)
 ; check ASU user classes in field 123.35
"RTN","GMRCAU",117,0)
 I 'GMRCUP S GMRCUP=$$USR(GMRCSS,GMRCUSR)
"RTN","GMRCAU",118,0)
 ;
"RTN","GMRCAU",119,0)
 I GMRCAD,GMRCUP Q $$BOTH(GMRCUP,GMRCAD) ;admin and upd
"RTN","GMRCAU",120,0)
 ;
"RTN","GMRCAU",121,0)
 I 'GMRCUP I $D(^GMR(123.5,+GMRCSS,123.2)) D LOC(.GMRCUP)
"RTN","GMRCAU",122,0)
 ;
"RTN","GMRCAU",123,0)
 I GMRCAD,GMRCUP Q $$BOTH(GMRCUP,GMRCAD) ;admin and upd
"RTN","GMRCAU",124,0)
 I GMRCUP,'GMRCAD Q GMRCUP ;update user only
"RTN","GMRCAU",125,0)
 I GMRCAD,'GMRCUP Q GMRCAD ;admin user only
"RTN","GMRCAU",126,0)
 Q 0
"RTN","GMRCAU",127,0)
 ;
"RTN","GMRCAU",128,0)
BOTH(ADMN,UPD) ;return string with fields if testing
"RTN","GMRCAU",129,0)
 I $G(GMRCTST) Q "4^"_$P(ADMN,U,2)_" and "_$P(UPD,U,2)
"RTN","GMRCAU",130,0)
 Q 4
"RTN","GMRCAU",131,0)
 ;
"RTN","GMRCAU",132,0)
LOC(GMRCUPD) ;Check for the DUZ in the NOTIFICATION BY PT LOCATION multiple
"RTN","GMRCAU",133,0)
 N GMRCL,GMRCTM
"RTN","GMRCAU",134,0)
 S GMRCL=0 ;Check if DUZ is associated with any location/ward
"RTN","GMRCAU",135,0)
 F  S GMRCL=$O(^GMR(123.5,+GMRCSS,123.2,GMRCL))  Q:'GMRCL!+GMRCUPD  D  Q:+GMRCUPD
"RTN","GMRCAU",136,0)
 . ;Get user and/or team assigned to location
"RTN","GMRCAU",137,0)
 . S GMRCL(0)=$G(^GMR(123.5,+GMRCSS,123.2,+GMRCL,0))
"RTN","GMRCAU",138,0)
 . I $P(GMRCL(0),"^",2)=DUZ S GMRCUPD=2 Q
"RTN","GMRCAU",139,0)
 . I $P(GMRCL(0),"^",3) S GMRCTM=$P(GMRCL(0),"^",3) ;D CHKTM
"RTN","GMRCAU",140,0)
 Q
"RTN","GMRCAU",141,0)
 ;
"RTN","GMRCAU",142,0)
TEAM(TYPE,SUBSC,USER) ;Check for the DUZ in the multiple of SUBSC
"RTN","GMRCAU",143,0)
 N GMRCTM,GMRCHIT
"RTN","GMRCAU",144,0)
 S GMRCTM=""
"RTN","GMRCAU",145,0)
 I '$G(USER) S USER=DUZ
"RTN","GMRCAU",146,0)
 F  S GMRCTM=$O(^GMR(123.5,GMRCSS,SUBSC,"B",GMRCTM)) Q:'GMRCTM!+TYPE  D
"RTN","GMRCAU",147,0)
 . S GMRCHIT=$$CHKTM(GMRCTM,USER) Q:'GMRCHIT
"RTN","GMRCAU",148,0)
 . S TYPE=$S(SUBSC=123.34:3,1:2)_$$FIELD(SUBSC)
"RTN","GMRCAU",149,0)
 Q
"RTN","GMRCAU",150,0)
 ;
"RTN","GMRCAU",151,0)
CHKTM(TEAM,PERS) ;checks for PERS in list of users on TEAM
"RTN","GMRCAU",152,0)
 ;Input:  TEAM must be set to the Order Team entry number
"RTN","GMRCAU",153,0)
 ;Output: 1 will be returned PERS is on TEAM
"RTN","GMRCAU",154,0)
 N ND,GMRCLST,FOUND
"RTN","GMRCAU",155,0)
 S GMRCLST=""
"RTN","GMRCAU",156,0)
 D TEAMPROV^ORQPTQ1(.GMRCLST,TEAM)
"RTN","GMRCAU",157,0)
 I $P(GMRCLST(1),"^",2)="No providers found." Q 0
"RTN","GMRCAU",158,0)
 S ND=0
"RTN","GMRCAU",159,0)
 F  S ND=$O(GMRCLST(ND)) Q:ND=""  I +GMRCLST(ND)=PERS S FOUND=1 Q
"RTN","GMRCAU",160,0)
 Q $S($G(FOUND):1,1:0)
"RTN","GMRCAU",161,0)
 ;
"RTN","GMRCAU",162,0)
USR(SERV,USER) ; check USR classes for user
"RTN","GMRCAU",163,0)
 N UCLS,UPD
"RTN","GMRCAU",164,0)
 I '$O(^GMR(123.5,+SERV,123.35,0)) Q 0
"RTN","GMRCAU",165,0)
 S UCLS=0,UPD=0
"RTN","GMRCAU",166,0)
 F  S UCLS=$O(^GMR(123.5,+SERV,123.35,"B",UCLS)) Q:'UCLS!(+UPD)  D
"RTN","GMRCAU",167,0)
 . Q:'UCLS
"RTN","GMRCAU",168,0)
 . S UPD=$$ISA^USRLM(USER,UCLS)
"RTN","GMRCAU",169,0)
 . I +UPD S UPD=2_$$FIELD(123.35)
"RTN","GMRCAU",170,0)
 . Q
"RTN","GMRCAU",171,0)
 Q UPD
"RTN","GMRCAU",172,0)
FIELD(GMRCFLD) ;return field name where became update user
"RTN","GMRCAU",173,0)
 I '$G(GMRCTST) Q ""
"RTN","GMRCAU",174,0)
 D FIELD^DID(123.5,GMRCFLD,,"LABEL","GMRCFLD")
"RTN","GMRCAU",175,0)
 Q "^"_$G(GMRCFLD("LABEL"))
"RTN","GMRCAU",176,0)
COMPLETE(GMRCA) ;Determine if the action is a complete action (10,13,14)
"RTN","GMRCAU",177,0)
 S GMRCA=$G(GMRCA)
"RTN","GMRCAU",178,0)
 Q $S(GMRCA=13:1,GMRCA=14:1,GMRCA=10:1,1:0)
"RTN","GMRCAU",179,0)
 ;   10=administrative complete, 13=ADDENDUM ADDED, 14=New Note
"RTN","GMRCAU",180,0)
 ;
"RTN","GMRCAU",181,0)
RESOLUA(GMRCA) ;Determine if action has resolution info for clinician
"RTN","GMRCAU",182,0)
 ;Action value is based on value in ^ORD(100.01,"
"RTN","GMRCAU",183,0)
 ;Returns 1 for consult resolution, 0 for pending resolution
"RTN","GMRCAU",184,0)
 S GMRCA=$G(GMRCA)
"RTN","GMRCAU",185,0)
 Q $S(GMRCA=4:1,GMRCA=6:1,GMRCA=10:1,GMRCA=11:1,GMRCA=12:1,GMRCA=13:1,GMRCA=14:1,GMRCA=19:1,1:0)
"RTN","GMRCAU",186,0)
 ;    4=Sig Findings, 6=discontinued, 10=administrative complete
"RTN","GMRCAU",187,0)
 ;    11=Edit/resubmit
"RTN","GMRCAU",188,0)
 ;    12=Disassociate result, 13=Addendum Added, 14=New Note
"RTN","GMRCAU",189,0)
 ;    19=cancelled
"RTN","GMRCAU",190,0)
 ;
"RTN","GMRCAU",191,0)
RESOLUS(GMRCSTS) ;Determine status indicates the consult has a resolution
"RTN","GMRCAU",192,0)
 ;Status value is based on values in ^ORD(100.01,"
"RTN","GMRCAU",193,0)
 ;Returns 1 for consult resolution, 0 for pending resolution
"RTN","GMRCAU",194,0)
 S GMRCSTS=$G(GMRCSTS)
"RTN","GMRCAU",195,0)
 Q $S(GMRCSTS:1,GMRCSTS=2:1,GMRCSTS=13:1,1:0)
"RTN","GMRCAU",196,0)
 ;    1=dc,2=comp,13=canc
"RTN","GMRCAU",197,0)
 ;
"RTN","GMRCAU",198,0)
TEST ;called from GMRC UPDATE AUTHORITY
"RTN","GMRCAU",199,0)
 ; determines how a user gets update authority for a service 
"RTN","GMRCAU",200,0)
 W !
"RTN","GMRCAU",201,0)
 N GMRCSRV,GMRCUSR,UPD,GMRCDG,GMRC1
"RTN","GMRCAU",202,0)
 N DIR,DIROUT,DIRUT,DUOUT,DTOUT,X,Y
"RTN","GMRCAU",203,0)
 S DIR(0)="PO^123.5:EM",DIR("A")="Select Consult Service"
"RTN","GMRCAU",204,0)
 S DIR("?")="Choose the consult service to check update status of user"
"RTN","GMRCAU",205,0)
 S DIR("??")="^D TESTHELP^GMRCAU(""ALL SERVICES"")" D ^DIR
"RTN","GMRCAU",206,0)
 I $D(DIRUT) Q
"RTN","GMRCAU",207,0)
 S GMRCSRV=+Y
"RTN","GMRCAU",208,0)
 N DIR
"RTN","GMRCAU",209,0)
 S DIR(0)="PO^200:EM",DIR("A")="Choose user to check for update status"
"RTN","GMRCAU",210,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCAU",211,0)
 S GMRCUSR=+Y
"RTN","GMRCAU",212,0)
 S UPD=$$VALID(GMRCSRV,,GMRCUSR,1)
"RTN","GMRCAU",213,0)
 I +UPD=0 W !!,"This user has no update authority"
"RTN","GMRCAU",214,0)
 I +UPD D
"RTN","GMRCAU",215,0)
 . I +UPD=2 W !!,"This user is an update user for: ",$P(UPD,U,3)
"RTN","GMRCAU",216,0)
 . I +UPD=3 W !!,"This user is an administrative user for: ",$P(UPD,U,3)
"RTN","GMRCAU",217,0)
 . I +UPD=4 D
"RTN","GMRCAU",218,0)
 .. W !!,"This user is both and administrative and update user"
"RTN","GMRCAU",219,0)
 .. W " for: ",!,$P(UPD,U,3)
"RTN","GMRCAU",220,0)
 . W !,"via the ",$P(UPD,U,2)," field",$S(+UPD=4:"(s).",1:".")
"RTN","GMRCAU",221,0)
 . W ! I $L($P(UPD,U,3)) D
"RTN","GMRCAU",222,0)
 .. I $P(UPD,U,3)'=$P(^GMR(123.5,+GMRCSRV,0),U) D HIER^GMRCT($P(UPD,U,3))
"RTN","GMRCAU",223,0)
 W !!
"RTN","GMRCAU",224,0)
 K GMRCSRV,GMRCUSR,UPD
"RTN","GMRCAU",225,0)
 K DIR,DIROUT,DIRUT,DUOUT,DTOUT,X,Y
"RTN","GMRCAU",226,0)
 G TEST
"RTN","GMRCAU",227,0)
TESTHELP(GMRCSVNM) ;wrapper for LISTSRV^GMRCASV
"RTN","GMRCAU",228,0)
 N DIR,GMRC1,GMRCDG
"RTN","GMRCAU",229,0)
 D LISTSRV^GMRCASV
"RTN","GMRCAU",230,0)
 Q
"RTN","GMRCAU",231,0)
TSTINTRO ;entry action of GMRC UPDATE AUTHORITY option
"RTN","GMRCAU",232,0)
 W !!,"This option will allow you to check a user's update authority for any given"
"RTN","GMRCAU",233,0)
 W !,"service in the consults hierarchy.  If the PROCESS PARENTS FOR UPDATES field"
"RTN","GMRCAU",234,0)
 W !,"is set to YES, all ancestors of the selected service will be checked."
"RTN","GMRCAU",235,0)
 W !,"The type of update authority and the service to which they are assigned will"
"RTN","GMRCAU",236,0)
 W !,"be displayed.",!!
"RTN","GMRCAU",237,0)
 Q
"RTN","GMRCCP")
0^8^B21540282
"RTN","GMRCCP",1,0)
GMRCCP ;SLC/JFR - utilities for clinical procedures; 10/11/01 10:15
"RTN","GMRCCP",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**17**;DEC 27, 1997
"RTN","GMRCCP",3,0)
 ; 
"RTN","GMRCCP",4,0)
 ; This routine invokes IA #3378,#3468
"RTN","GMRCCP",5,0)
 ;
"RTN","GMRCCP",6,0)
 Q
"RTN","GMRCCP",7,0)
CPLIST(GMRCPT,GMRCPR,GMRCRET) ;return list of patient CP requests
"RTN","GMRCCP",8,0)
 ; Input:
"RTN","GMRCCP",9,0)
 ;   GMRCPT = patient DFN              (required)
"RTN","GMRCCP",10,0)
 ;   GMRCPR = ien from file 702.01     (optional)
"RTN","GMRCCP",11,0)
 ;            if just one procedure
"RTN","GMRCCP",12,0)
 ;            desired; defaults to all
"RTN","GMRCCP",13,0)
 ;   GMRCRET= global array in which to (required)
"RTN","GMRCCP",14,0)
 ;            return results
"RTN","GMRCCP",15,0)
 ;
"RTN","GMRCCP",16,0)
 ; Output:
"RTN","GMRCCP",17,0)
 ;   ^global(array)=
"RTN","GMRCCP",18,0)
 ;          date of request^CP DEF nam^urgency^status^cons #^CP DEF ien
"RTN","GMRCCP",19,0)
 ;
"RTN","GMRCCP",20,0)
 N GMRCDA,COUNT
"RTN","GMRCCP",21,0)
 S COUNT=1
"RTN","GMRCCP",22,0)
 I '$G(GMRCPT)!('$D(GMRCRET)) Q
"RTN","GMRCCP",23,0)
 I $G(GMRCPR) D
"RTN","GMRCCP",24,0)
 . S GMRCDA=0
"RTN","GMRCCP",25,0)
 . F  S GMRCDA=$O(^GMR(123,"ACP",GMRCPR,GMRCPT,GMRCDA)) Q:'GMRCDA  D
"RTN","GMRCCP",26,0)
 .. D LOADAR(GMRCDA,GMRCRET,COUNT) S COUNT=COUNT+1
"RTN","GMRCCP",27,0)
 . Q
"RTN","GMRCCP",28,0)
 I '$G(GMRCPR) S GMRCPR=0 D
"RTN","GMRCCP",29,0)
 . F  S GMRCPR=$O(^GMR(123,"ACP",GMRCPR)) Q:'GMRCPR  D
"RTN","GMRCCP",30,0)
 .. S GMRCDA=0
"RTN","GMRCCP",31,0)
 .. F  S GMRCDA=$O(^GMR(123,"ACP",GMRCPR,GMRCPT,GMRCDA)) Q:'GMRCDA  D
"RTN","GMRCCP",32,0)
 ... D LOADAR(GMRCDA,GMRCRET,COUNT) S COUNT=COUNT+1
"RTN","GMRCCP",33,0)
 .. Q
"RTN","GMRCCP",34,0)
 . Q
"RTN","GMRCCP",35,0)
 Q
"RTN","GMRCCP",36,0)
 ;
"RTN","GMRCCP",37,0)
LOADAR(IEN,GMRCAR,CNT) ;set up array and return data for given file 123 ien
"RTN","GMRCCP",38,0)
 N GMRCDT,GMRCCP,GMRCUR,STS,GMRC,GMRCCPI
"RTN","GMRCCP",39,0)
 Q:'$D(^GMR(123,IEN,0))
"RTN","GMRCCP",40,0)
 Q:'+$G(^GMR(123,IEN,1))
"RTN","GMRCCP",41,0)
 S GMRC(0)=^GMR(123,IEN,0)
"RTN","GMRCCP",42,0)
 S GMRCDT=$P(GMRC(0),U,7)
"RTN","GMRCCP",43,0)
 S GMRCCPI=+^GMR(123,IEN,1)
"RTN","GMRCCP",44,0)
 S GMRCCP=$$GET1^DIQ(702.01,GMRCCPI,.01)
"RTN","GMRCCP",45,0)
 S GMRCUR=$$GET1^DIQ(101,+$P(GMRC(0),U,9),1)
"RTN","GMRCCP",46,0)
 S STS=$$GET1^DIQ(100.01,+$P(GMRC(0),U,12),.1)
"RTN","GMRCCP",47,0)
 S @(GMRCAR)@(CNT)=GMRCDT_U_GMRCCP_U_GMRCUR_U_STS_U_IEN_U_GMRCCPI
"RTN","GMRCCP",48,0)
 Q
"RTN","GMRCCP",49,0)
 ;
"RTN","GMRCCP",50,0)
CPROC(PROC) ;is orderable procedure mapped to Clinical Procedures
"RTN","GMRCCP",51,0)
 Q +$P($G(^GMR(123.3,PROC,0)),U,4)
"RTN","GMRCCP",52,0)
CPLINK(PROC) ;check "AC" x-ref to see if PROC is linked to entry in 123.3
"RTN","GMRCCP",53,0)
 ; PROC - ien from 702.01
"RTN","GMRCCP",54,0)
 Q $E($D(^GMR(123.3,"AC",+PROC)),1)
"RTN","GMRCCP",55,0)
CPLINKS(NAMES,PROC) ;return list of procedure names linked to a CP
"RTN","GMRCCP",56,0)
 ; Input
"RTN","GMRCCP",57,0)
 ;   PROC - ien from PROCEDURE DEFINITION (#702.01)   - (required)
"RTN","GMRCCP",58,0)
 ; Output:
"RTN","GMRCCP",59,0)
 ;   NAMES - passed by reference 
"RTN","GMRCCP",60,0)
 ;           returned as array of GMRC PROCEDUREs linked to PROC 
"RTN","GMRCCP",61,0)
 ;           in format;
"RTN","GMRCCP",62,0)
 ;             NAMES(x)=GMRC PROCEDURE name^GMRC PROCEDURE ien
"RTN","GMRCCP",63,0)
 ;               NAMES(1)="EKG^21"
"RTN","GMRCCP",64,0)
 ;               NAMES(2)="EKG PORTABLE^32"
"RTN","GMRCCP",65,0)
 ;           if not currently linked, returned as:
"RTN","GMRCCP",66,0)
 ;             NAMES(1)="-1^not currently linked"
"RTN","GMRCCP",67,0)
 N GMRCPR,I
"RTN","GMRCCP",68,0)
 S I=1,GMRCPR=0
"RTN","GMRCCP",69,0)
 F  S GMRCPR=$O(^GMR(123.3,"AC",PROC,GMRCPR)) Q:'GMRCPR  D
"RTN","GMRCCP",70,0)
 . S NAMES(I)=$P($G(^GMR(123.3,GMRCPR,0)),U)_U_GMRCPR
"RTN","GMRCCP",71,0)
 . S I=I+1
"RTN","GMRCCP",72,0)
 I '$D(NAMES(1)) S NAMES(1)="-1^not currently linked"
"RTN","GMRCCP",73,0)
 Q
"RTN","GMRCCP",74,0)
CPDOC(GMRCDA,TIUDA,ACTION) ;update file 123 entry with CLIN PROC DOC
"RTN","GMRCCP",75,0)
 ; Input:
"RTN","GMRCCP",76,0)
 ;   GMRCDA = ien from file 123
"RTN","GMRCCP",77,0)
 ;   TIUDA  = ien from file 8925
"RTN","GMRCCP",78,0)
 ;   ACTION = 1   - associate stub record
"RTN","GMRCCP",79,0)
 ;          = 2   - partial results ready
"RTN","GMRCCP",80,0)
 ;          = 3   - retract record
"RTN","GMRCCP",81,0)
 ;
"RTN","GMRCCP",82,0)
 ; Output: 
"RTN","GMRCCP",83,0)
 ;   1       = successful
"RTN","GMRCCP",84,0)
 ;   0^error = unsuccessful^problem 
"RTN","GMRCCP",85,0)
 ;
"RTN","GMRCCP",86,0)
 ;
"RTN","GMRCCP",87,0)
 I '$D(^GMR(123,+GMRCDA,0)) Q "0^Invalid procedure record"
"RTN","GMRCCP",88,0)
 I '$G(ACTION) Q "0^Invalid action code"
"RTN","GMRCCP",89,0)
 I '$G(TIUDA) Q "0^No document to associate"
"RTN","GMRCCP",90,0)
 N QVAL S QVAL=""
"RTN","GMRCCP",91,0)
 I ACTION=1 D  Q QVAL
"RTN","GMRCCP",92,0)
 . S QVAL="0^Not a current API implementation"
"RTN","GMRCCP",93,0)
 . Q
"RTN","GMRCCP",94,0)
 I ACTION=2 D  Q QVAL
"RTN","GMRCCP",95,0)
 . I $D(^GMR(123,+GMRCDA,50,"B",TIUDA_";TIU(8925")) Q
"RTN","GMRCCP",96,0)
 . D GET^GMRCTIU(+GMRCDA,TIUDA,"INCOMPLETE") ;update to pr
"RTN","GMRCCP",97,0)
 . D EN^GMRCT(+$P(^GMR(123,+GMRCDA,0),U,5)) ;get svc notif recips
"RTN","GMRCCP",98,0)
 . I $D(GMRCADUZ) D
"RTN","GMRCCP",99,0)
 .. N MSG,GMRCDFN,GMRCREF
"RTN","GMRCCP",100,0)
 .. S MSG="Procedure ready for interpretation"
"RTN","GMRCCP",101,0)
 .. S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCCP",102,0)
 .. S GMRCREF=+GMRCDA_"|"_+TIUDA_";TIU(8925,"
"RTN","GMRCCP",103,0)
 .. D MSG^GMRCP(GMRCDFN,MSG,GMRCREF,66,.GMRCADUZ,0) ;send #66 alert
"RTN","GMRCCP",104,0)
 . S QVAL="1"
"RTN","GMRCCP",105,0)
 . Q
"RTN","GMRCCP",106,0)
 I ACTION=3 D  Q QVAL
"RTN","GMRCCP",107,0)
 . I '$D(^GMR(123,+GMRCDA,50,"B",TIUDA_";TIU(8925")) D  Q
"RTN","GMRCCP",108,0)
 .. S QVAL="0^Not an associated document"
"RTN","GMRCCP",109,0)
 . D ROLLBACK^GMRCTIU1(+GMRCDA,+TIUDA)
"RTN","GMRCCP",110,0)
 . S QVAL=1
"RTN","GMRCCP",111,0)
 . ;S QVAL="0^Not ready yet"
"RTN","GMRCCP",112,0)
 . Q
"RTN","GMRCCP",113,0)
 Q
"RTN","GMRCCP",114,0)
CPACTM(GMRCDA) ;return actions available for a CP request
"RTN","GMRCCP",115,0)
 ;Input:
"RTN","GMRCCP",116,0)
 ;  GMRCDA = file 123 ien
"RTN","GMRCCP",117,0)
 ;Output:
"RTN","GMRCCP",118,0)
 ;  0 = not a CP request or TIU*1*109 not present
"RTN","GMRCCP",119,0)
 ;  1 = CP request but no instrument report expected
"RTN","GMRCCP",120,0)
 ;  2 = CP and still waiting on instr. or images
"RTN","GMRCCP",121,0)
 ;  3 = CP and incomplete CP doc attached
"RTN","GMRCCP",122,0)
 ;  4 = CP and complete CP doc attached
"RTN","GMRCCP",123,0)
 ;
"RTN","GMRCCP",124,0)
 N EXTDTA,CPDOC
"RTN","GMRCCP",125,0)
 I '$$PATCH^XPDUTL("TIU*1.0*109") Q 0
"RTN","GMRCCP",126,0)
 I '$G(^GMR(123,GMRCDA,1)) Q 0
"RTN","GMRCCP",127,0)
 S EXTDTA=$$EXTDATA^MDAPI(+^GMR(123,GMRCDA,1))
"RTN","GMRCCP",128,0)
 S CPDOC=$G(^GMR(123,GMRCDA,50,+$O(^GMR(123,GMRCDA,50,0)),0))
"RTN","GMRCCP",129,0)
 I 'EXTDTA,'+CPDOC Q 1 ;no ext & no stub
"RTN","GMRCCP",130,0)
 I EXTDTA,'+CPDOC Q 2 ;ext data & no data
"RTN","GMRCCP",131,0)
 I $$GET1^DIQ(8925,+CPDOC,.05)'="COMPLETED" Q 3 ;partial results
"RTN","GMRCCP",132,0)
 Q 4 ;CP is done, allow additional CP titles
"RTN","GMRCCP",133,0)
 ;
"RTN","GMRCCP",134,0)
CPINTERP(GMRCTIU,GMRCUSER) ;is user an interpreter for TIU doc GMRCTIU
"RTN","GMRCCP",135,0)
 ;
"RTN","GMRCCP",136,0)
 ; Input:
"RTN","GMRCCP",137,0)
 ;   GMRCTIU   = ien from file 8925
"RTN","GMRCCP",138,0)
 ;   GMRCUSER  = DUZ of person to evaluate
"RTN","GMRCCP",139,0)
 ;
"RTN","GMRCCP",140,0)
 ; Output:
"RTN","GMRCCP",141,0)
 ;   1 = GMRCUSER is an interpreter
"RTN","GMRCCP",142,0)
 ;   0 = GMRCUSER is NOT an interpreter
"RTN","GMRCCP",143,0)
 ;
"RTN","GMRCCP",144,0)
 N GMRCSRV,GMRCDA,GMRCINT
"RTN","GMRCCP",145,0)
 S GMRCDA=$O(^GMR(123,"R",GMRCTIU_";TIU(8925,",0))
"RTN","GMRCCP",146,0)
 I 'GMRCDA Q 0 ;TIU doc not attached
"RTN","GMRCCP",147,0)
 S GMRCSRV=$P(^GMR(123,+GMRCDA,0),U,5)
"RTN","GMRCCP",148,0)
 I 'GMRCSRV Q 0 ;no service, can't tell if interpreter
"RTN","GMRCCP",149,0)
 S GMRCINT=+$$VALID^GMRCAU(GMRCSRV,,GMRCUSER) ;get upd authority
"RTN","GMRCCP",150,0)
 Q $S(GMRCINT=2:1,GMRCINT=4:1,1:0) ;2=upd user, 4=adm & upd user
"RTN","GMRCCP",151,0)
 ;
"RTN","GMRCCP",152,0)
CPPAT(GMRCDA,GMRCDFN) ;is patient object of given request?
"RTN","GMRCCP",153,0)
 ; Input:
"RTN","GMRCCP",154,0)
 ;  GMRCDA   = ien from file 123
"RTN","GMRCCP",155,0)
 ;  GMRCDFN  = patient DFN
"RTN","GMRCCP",156,0)
 ;
"RTN","GMRCCP",157,0)
 ; Output:
"RTN","GMRCCP",158,0)
 ;  1 = patient is object of request GMRCDA
"RTN","GMRCCP",159,0)
 ;  0 = patient is NOT object of request in GMRCDA
"RTN","GMRCCP",160,0)
 I $P($G(^GMR(123,GMRCDA,0)),U,2)'=GMRCDFN Q 0
"RTN","GMRCCP",161,0)
 Q 1
"RTN","GMRCGUIB")
0^11^B37448368
"RTN","GMRCGUIB",1,0)
GMRCGUIB ;SLC/DCM,JFR,MA - GUI actions for consults ;1/11/01  12:53
"RTN","GMRCGUIB",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,18,20,17**;DEC 27, 1997
"RTN","GMRCGUIB",3,0)
 ; This routine invokes IA #2980
"RTN","GMRCGUIB",4,0)
 ;
"RTN","GMRCGUIB",5,0)
SETDA() ;set DA of where audit actions are to be filed
"RTN","GMRCGUIB",6,0)
 S:'$D(^GMR(123,+GMRCO,40,0)) ^GMR(123,GMRCO,40,0)="^123.02DA^^"
"RTN","GMRCGUIB",7,0)
 S DA=$S($P(^GMR(123,+GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCGUIB",8,0)
 S $P(^GMR(123,+GMRCO,40,0),"^",3,4)=DA_"^"_DA
"RTN","GMRCGUIB",9,0)
 Q DA
"RTN","GMRCGUIB",10,0)
REASON(GMRCFN,GMRCRQ,GMRCDT) ;Load the reason for the request into ^GMR(123,GMRCO,20
"RTN","GMRCGUIB",11,0)
 ;GMRCFN=File 123 IFN; GMRCRQ=Array containing Reason For Request
"RTN","GMRCGUIB",12,0)
 ;GMRCDT=Date time of entry
"RTN","GMRCGUIB",13,0)
 S ^GMR(123,GMRCFN,20,0)="^^^"_GMRCDT_"^"
"RTN","GMRCGUIB",14,0)
 S L=0,LN=1 F  S L=$O(GMRCRQ(L)) Q:L=""  S ^GMR(123,GMRCFN,20,LN,0)=GMRCRQ(L),LN=LN+1
"RTN","GMRCGUIB",15,0)
 S LN=LN-1,$P(^GMR(123,GMRCFN,20,0),"^",3)=LN
"RTN","GMRCGUIB",16,0)
 K LN,L
"RTN","GMRCGUIB",17,0)
 Q
"RTN","GMRCGUIB",18,0)
SETCOM(COMMENT,WHO) ;Set comment array into tracking actions
"RTN","GMRCGUIB",19,0)
 N GMRCNOW,DR,DIE
"RTN","GMRCGUIB",20,0)
 S GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIB",21,0)
 S DIE="^GMR(123,GMRCO,40,",DA(1)=GMRCO,DR=".01////^S X=GMRCNOW;1////^S X=GMRCA;2////^S X=GMRCAD;3////^S X=$G(GMRCORNP);4////^S X=$S($G(WHO):WHO,1:DUZ);6////^S X=$G(GMRCFR);8////^S X=$G(GMRCFF)"
"RTN","GMRCGUIB",22,0)
 D ^DIE
"RTN","GMRCGUIB",23,0)
 S ^GMR(123,GMRCO,40,DA,1,0)="^^^^"_GMRCAD_"^"
"RTN","GMRCGUIB",24,0)
 S (GMRCND,GMRCND1)=0 F  S GMRCND1=$O(COMMENT(GMRCND1)) Q:GMRCND1=""  S GMRCND=GMRCND+1,^GMR(123,GMRCO,40,DA,1,GMRCND,0)=COMMENT(GMRCND)
"RTN","GMRCGUIB",25,0)
 S $P(^GMR(123,GMRCO,40,DA,1,0),"^",3)=GMRCND,$P(^(0),"^",4)=GMRCND,^GMR(123,GMRCO,40,"B",GMRCNOW,DA)=""
"RTN","GMRCGUIB",26,0)
 K GMRCND,GMRCND1
"RTN","GMRCGUIB",27,0)
 Q
"RTN","GMRCGUIB",28,0)
CMT(GMRCO,GMRCOM,GMRCADUZ,GMRCWHN,GMRCWHO) ;add comment to consult record
"RTN","GMRCGUIB",29,0)
 ; GMRCO = IEN from file 123
"RTN","GMRCGUIB",30,0)
 ; GMRCOM = array of comments in format GMRCOM(1)="xxxx", GMRCOM(2)="xxx"
"RTN","GMRCGUIB",31,0)
 ; GMRCADUZ= array of alert recipients as GMRCADUZ(DUZ)="" (optional)
"RTN","GMRCGUIB",32,0)
 ; GMRCWHO= IEN from file 200 who's responsible activity (optional)
"RTN","GMRCGUIB",33,0)
 ; GMRCWHN= date time of activity in FM format
"RTN","GMRCGUIB",34,0)
 ;
"RTN","GMRCGUIB",35,0)
 N DA,GMRCA,GMRCAD,GMRCORTX,GMRCDFN
"RTN","GMRCGUIB",36,0)
 S DA=$$SETDA ; get next activity tracking entry
"RTN","GMRCGUIB",37,0)
 S GMRCA=20,GMRCAD=GMRCWHN S:$G(GMRCWHO) GMRCORNP=GMRCWHO
"RTN","GMRCGUIB",38,0)
 D SETCOM(.GMRCOM,$G(GMRCWHO))
"RTN","GMRCGUIB",39,0)
 Q:'$D(GMRCADUZ)
"RTN","GMRCGUIB",40,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCGUIB",41,0)
 S GMRCORTX="Comment Added to Consult "
"RTN","GMRCGUIB",42,0)
 S GMRCORTX=GMRCORTX_$$GET1^DIQ(123.5,$P(^GMR(123,+GMRCO,0),U,5),.01)
"RTN","GMRCGUIB",43,0)
 ;
"RTN","GMRCGUIB",44,0)
 ; Patch 18 changed MSG 27 to 63 "Consult/request update"
"RTN","GMRCGUIB",45,0)
 ; Patch 20 checks to see if GUI v15 is installed to use new
"RTN","GMRCGUIB",46,0)
 ; alert code #63
"RTN","GMRCGUIB",47,0)
 N GMRCALT
"RTN","GMRCGUIB",48,0)
 S GMRCALT=$S($$PATCH^XPDUTL("OR*3.0*85"):63,1:27)
"RTN","GMRCGUIB",49,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,GMRCALT,.GMRCADUZ,0)
"RTN","GMRCGUIB",50,0)
 Q
"RTN","GMRCGUIB",51,0)
SFILE(GMRCO,GMRCA,GMRCSF,GMRCORNP,GMRCDUZ,GMRCOM,GMRCALF,GMRCATO,GMRCAD) ;Process various file update functions from the GUI for a consult
"RTN","GMRCGUIB",52,0)
 ; ADMIN COMPLETE or SIGNIFICANT FINDINGS
"RTN","GMRCGUIB",53,0)
 ;Input variables:
"RTN","GMRCGUIB",54,0)
 ;GMRCO=File 123 IEN of the consult record
"RTN","GMRCGUIB",55,0)
 ;GMRCA=pointer to REQUEST ACTION TYPES (#123.1) 10=complete, 4=Sig find.
"RTN","GMRCGUIB",56,0)
 ;GMRCSF=Significant Findings flag: 'Y'= significant finding
"RTN","GMRCGUIB",57,0)
 ;                                : 'N'= no significant finding
"RTN","GMRCGUIB",58,0)
 ;                                : 'U'=unknown significant finding
"RTN","GMRCGUIB",59,0)
 ;GMRCORNP=Provider Responsible for action
"RTN","GMRCGUIB",60,0)
 ;GMRCDUZ=Person actually doing the action
"RTN","GMRCGUIB",61,0)
 ;GMRCOM=An array of comments by reference ARRAY(1)="xxx",ARRAY(2)="xxx"
"RTN","GMRCGUIB",62,0)
 ;GMRCALF=Flag to signal that alerts are to be sent; 'N'=NO, 'Y'=YES
"RTN","GMRCGUIB",63,0)
 ;GMRCATO=Who alerts are to be sent to; a comma delimited string of DUZ's
"RTN","GMRCGUIB",64,0)
 ;GMRCAD =FM date/time of activity
"RTN","GMRCGUIB",65,0)
 ;
"RTN","GMRCGUIB",66,0)
 ;Output:
"RTN","GMRCGUIB",67,0)
 ; GMRCERR=Error Flag: 0 if no error, 1 if error occurred 
"RTN","GMRCGUIB",68,0)
 ; GMRCERMS - Error message or null
"RTN","GMRCGUIB",69,0)
 ;    returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIB",70,0)
 ;
"RTN","GMRCGUIB",71,0)
 N GMRCERR,GMRCERMS
"RTN","GMRCGUIB",72,0)
 L +^GMR(123,GMRCO):5 I '$T S GMRCERR=1,GMRCERMS="Record Locked. File Update Not Accomplished." Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",73,0)
 S GMRCERR=0,GMRCERMS="",DR="",GMRCORTX=""
"RTN","GMRCGUIB",74,0)
 N GMRCADUZ S GMRCADUZ=""
"RTN","GMRCGUIB",75,0)
 S GMRCNOW=$$NOW^XLFDT,GMRCSTS=$P(^GMR(123,+GMRCO,0),"^",12),GMRCDFN=$P(^(0),"^",2)
"RTN","GMRCGUIB",76,0)
 I '$G(GMRCDUZ) S GMRCDUZ=DUZ
"RTN","GMRCGUIB",77,0)
 I '$G(GMRCAD) S GMRCAD=GMRCNOW
"RTN","GMRCGUIB",78,0)
 I +$G(GMRCA),GMRCA=10 D
"RTN","GMRCGUIB",79,0)
 .S GMRCSF=$G(GMRCSF,"")
"RTN","GMRCGUIB",80,0)
 .S GMRCSTS=2
"RTN","GMRCGUIB",81,0)
 .S DR="8////^S X=GMRCSTS;9////^S X=GMRCA"
"RTN","GMRCGUIB",82,0)
 .S GMRCORTX="Completed Consult "_$$ORTX^GMRCAU(+GMRCO)_$S(GMRCSF="Y":" with Sig Findings",GMRCSF="N":" with no Sig Findings",1:"")
"RTN","GMRCGUIB",83,0)
 .I $P($G(^GMR(123,+GMRCO,0)),U,14) S GMRCADUZ($P($G(^(0)),U,14))=""
"RTN","GMRCGUIB",84,0)
 .Q
"RTN","GMRCGUIB",85,0)
 I $G(GMRCALF)=1 D
"RTN","GMRCGUIB",86,0)
 .N I
"RTN","GMRCGUIB",87,0)
 .F I=1:1  S X=$P(GMRCATO,";",I) Q:X=""  S GMRCADUZ(X)=""
"RTN","GMRCGUIB",88,0)
 .Q
"RTN","GMRCGUIB",89,0)
 I $L(GMRCA),GMRCA=4 S DR=DR_$S($L(DR):";",1:"")_"9////^S X=GMRCA;15////^S X=GMRCSF" D
"RTN","GMRCGUIB",90,0)
 .S GMRCORTX=$S(GMRCSF="Y":"Sig Findings ",GMRCSF="N":"No Sig Findings ",1:"Unknown Sig Findings ")_"for consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCGUIB",91,0)
 .I $P($G(^GMR(123,+GMRCO,0)),U,14) S GMRCADUZ($P($G(^(0)),U,14))=""
"RTN","GMRCGUIB",92,0)
 .Q
"RTN","GMRCGUIB",93,0)
 I $L(DR) S DIE="^GMR(123,",DA=GMRCO D ^DIE K DIE,DR
"RTN","GMRCGUIB",94,0)
 I '$O(GMRCOM(0)) D AUDIT^GMRCP
"RTN","GMRCGUIB",95,0)
 I $D(GMRCOM),$O(GMRCOM(0)) D
"RTN","GMRCGUIB",96,0)
 .N DA
"RTN","GMRCGUIB",97,0)
 .S DA=$$SETDA()
"RTN","GMRCGUIB",98,0)
 .D SETCOM(.GMRCOM,GMRCDUZ)
"RTN","GMRCGUIB",99,0)
 .Q
"RTN","GMRCGUIB",100,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCGUIB",101,0)
 ;
"RTN","GMRCGUIB",102,0)
 ; Patch #18 changed GMRCA=20:27 TO 20:63
"RTN","GMRCGUIB",103,0)
 ; Patch 20 checks to see if GUI v15 is installed to use new
"RTN","GMRCGUIB",104,0)
 ; alert code #63
"RTN","GMRCGUIB",105,0)
 N GMRCALT
"RTN","GMRCGUIB",106,0)
 S GMRCALT=$S($$PATCH^XPDUTL("OR*3.0*85"):63,1:27)
"RTN","GMRCGUIB",107,0)
 I +$G(GMRCALF) D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,$S(GMRCA=20:GMRCALT,1:23),.GMRCADUZ,0)
"RTN","GMRCGUIB",108,0)
 I $S(GMRCA=10:1,1:0) D EN^GMRCHL7($P(^GMR(123,GMRCO,0),"^",2),GMRCO,$G(GMRCTYPE),$G(GMRCRB),"RE",GMRCORNP,$G(GMRCVSIT),.GMRCOM,,GMRCAD)
"RTN","GMRCGUIB",109,0)
 K DIE,DR,DA,GMRCDT,GMRCNOW,GMRCAD,GMRCORNP,GMRCDUZ,GMRCRSLT,GMRCSTS,GMRCADUZ,GMRCORTX,GMRCDFN
"RTN","GMRCGUIB",110,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",111,0)
 ;
"RTN","GMRCGUIB",112,0)
SCH(GMRCO,GMRCORNP,GMRCAD,GMRCADUZ,GMRCMT) ;schedule a consult API
"RTN","GMRCGUIB",113,0)
 ; Input variables:
"RTN","GMRCGUIB",114,0)
 ;GMRCO - The internal file number of the consult from File 123
"RTN","GMRCGUIB",115,0)
 ;GMRCORNP - Name of the person who actually 'Received' the consult 
"RTN","GMRCGUIB",116,0)
 ;GMRCAD - Actual date time that consult was received into the service.
"RTN","GMRCGUIB",117,0)
 ;GMRCADUZ - array of alert recipients as chosen by user (by reference)
"RTN","GMRCGUIB",118,0)
 ;   ARRAY(DUZ)="" 
"RTN","GMRCGUIB",119,0)
 ;GMRCMT - array of comments if entered (by reference)
"RTN","GMRCGUIB",120,0)
 ;   ARRAY(1)="FIRST LINE OF COMMENT"
"RTN","GMRCGUIB",121,0)
 ;   ARRAY(2)="SECOND LINE OF COMMENT"
"RTN","GMRCGUIB",122,0)
 ;
"RTN","GMRCGUIB",123,0)
 ;Output:
"RTN","GMRCGUIB",124,0)
 ;GMRCERR - Error Condition Code: 0 = NO error, 1=error
"RTN","GMRCGUIB",125,0)
 ;GMRCERMS - Error message or null
"RTN","GMRCGUIB",126,0)
 ;  returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIB",127,0)
        ;
"RTN","GMRCGUIB",128,0)
 N DFN,GMRCSTS,GMRCNOW,GMRCERR,GMRCERMS
"RTN","GMRCGUIB",129,0)
 S GMRCERR=0,GMRCERMS="",GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIB",130,0)
 S:$G(GMRCAD)="" GMRCAD=GMRCNOW
"RTN","GMRCGUIB",131,0)
 S:'$G(GMRCDUZ) GMRCDUZ=DUZ
"RTN","GMRCGUIB",132,0)
 S DFN=$P($G(^GMR(123,GMRCO,0)),"^",2) I DFN="" D  Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",133,0)
 . S GMRCERR="1",GMRCERMS="Not A Valid Consult - File Not Found."
"RTN","GMRCGUIB",134,0)
 . D EXIT^GMRCGUIA
"RTN","GMRCGUIB",135,0)
 S GMRCSTS=8,GMRCA=8
"RTN","GMRCGUIB",136,0)
 D STATUS^GMRCP I $D(GMRCQUT) D EXIT^GMRCGUIA Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",137,0)
 I '$O(GMRCMT(0)) D AUDIT^GMRCP
"RTN","GMRCGUIB",138,0)
 I $O(GMRCMT(0)) D
"RTN","GMRCGUIB",139,0)
 . S DA=$$SETDA
"RTN","GMRCGUIB",140,0)
 . D SETCOM(.GMRCMT,GMRCDUZ)
"RTN","GMRCGUIB",141,0)
 D EN^GMRCHL7(DFN,GMRCO,"","","SC",GMRCORNP,"","","",GMRCAD)
"RTN","GMRCGUIB",142,0)
 I $D(GMRCADUZ),$O(GMRCMT(0)) D
"RTN","GMRCGUIB",143,0)
 . N TXT S TXT="Scheduled Consult: "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCGUIB",144,0)
 . ; Patch 18 changed alert 27 to 63 "Consult/request update"
"RTN","GMRCGUIB",145,0)
 . ; Patch 20 checks to see if GUI v15 is installed to use new
"RTN","GMRCGUIB",146,0)
 . ; alert code #63
"RTN","GMRCGUIB",147,0)
 . N GMRALERT
"RTN","GMRCGUIB",148,0)
 . S GMRALERT=$S($$PATCH^XPDUTL("OR*3.0*85"):63,1:27)
"RTN","GMRCGUIB",149,0)
 . D MSG^GMRCP(DFN,TXT,GMRCO,GMRALERT,.GMRCADUZ,0)
"RTN","GMRCGUIB",150,0)
 D EXIT^GMRCGUIA
"RTN","GMRCGUIB",151,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",152,0)
DOCLIST(GMRCAR,GMRCDA,GMRCMED)  ;return list of linked results
"RTN","GMRCGUIB",153,0)
 ; Input:
"RTN","GMRCGUIB",154,0)
 ;  GMRCAR - array to return list, passed by reference
"RTN","GMRCGUIB",155,0)
 ;  GMRCDA - ien from file 123
"RTN","GMRCGUIB",156,0)
 ;  GMRCMED- 1 = include med results; 0 = only TIU docs
"RTN","GMRCGUIB",157,0)
 ;
"RTN","GMRCGUIB",158,0)
 ; Output:
"RTN","GMRCGUIB",159,0)
 ;  GMRCAR - array in format
"RTN","GMRCGUIB",160,0)
 ;       GMRCAR(0)=zero node of record
"RTN","GMRCGUIB",161,0)
 ;       GMRCAR(50,1)="ien;global ref," e.g. 5;TIU(8925, or 3;MCAR(691,
"RTN","GMRCGUIB",162,0)
 ;       GMRCAR(50,2)="ien;global ref,"
"RTN","GMRCGUIB",163,0)
 ;
"RTN","GMRCGUIB",164,0)
 I '$D(^GMR(123,GMRCDA,0)) Q
"RTN","GMRCGUIB",165,0)
 S GMRCAR(0)=^GMR(123,GMRCDA,0),$P(GMRCAR(0),U,20)=""
"RTN","GMRCGUIB",166,0)
 N RES,CNT S RES="",CNT=1
"RTN","GMRCGUIB",167,0)
 F  S RES=$O(^GMR(123,GMRCDA,50,"B",RES)) Q:RES=""  D
"RTN","GMRCGUIB",168,0)
 . I '$G(GMRCMED) Q:RES'["TIU(8925"
"RTN","GMRCGUIB",169,0)
 . S GMRCAR(50,CNT)=RES
"RTN","GMRCGUIB",170,0)
 . I RES["MCAR" D
"RTN","GMRCGUIB",171,0)
 .. N ARR,STR
"RTN","GMRCGUIB",172,0)
 .. D MEDLKUP^MCARUTL3(.ARR,+$P(RES,"MCAR(",2),+RES)
"RTN","GMRCGUIB",173,0)
 .. I '+ARR K GMRCAR(50,CNT) Q
"RTN","GMRCGUIB",174,0)
 .. S STR=$P(ARR,U,9)_U_$P(ARR,U,6)_$S($P(ARR,U,10):"^^^^^^^^1",1:"")
"RTN","GMRCGUIB",175,0)
 .. S GMRCAR(50,CNT)=GMRCAR(50,CNT)_U_STR
"RTN","GMRCGUIB",176,0)
 . S CNT=CNT+1
"RTN","GMRCGUIB",177,0)
 Q
"RTN","GMRCGUIU")
0^6^B28332520
"RTN","GMRCGUIU",1,0)
GMRCGUIU ;SLC/DCM,JFR - Utilities for CPRS GUI ;2/23/01 15:15
"RTN","GMRCGUIU",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,15,17**;DEC 27, 1997
"RTN","GMRCGUIU",3,0)
 ;
"RTN","GMRCGUIU",4,0)
 ; This routine invokes IA #2757,#3042,#3122,#3171
"RTN","GMRCGUIU",5,0)
 ;
"RTN","GMRCGUIU",6,0)
GUIC ;Kill variables from GMRCGUIC
"RTN","GMRCGUIU",7,0)
 K GMRC(0),GMRCA,GMRCATN,GMRCD,GMRCDD,GMRCDIAG,GMRCDT,GMRCED,GMRCEDCM
"RTN","GMRCGUIU",8,0)
 K GMRCFL,GMRCFLD,GMRCION,GMRCLNO,GMRCNATO,GMRCNT,GMRCORTX,GMRCPL
"RTN","GMRCGUIU",9,0)
 K GMRCPROC,GMRCRQT,GMRCS38,GMRCSS,GMRCSVC,GMRCTRLC,GMRCTYPE,GMRCURG
"RTN","GMRCGUIU",10,0)
 K GMRCX,LN,GMRCADUZ,ORDG,RMBED,VISIT
"RTN","GMRCGUIU",11,0)
 K GMRCITM,GMRCMSG,GMRCND1,GMRCNOD,GMRCPROV,GMRCOUNT,GMRCGUIF,GMRCREQ
"RTN","GMRCGUIU",12,0)
 K GMRCSS,GMRCPROC,GMRCURG,GMRCURGY,GMRCPL,GMRCATN,GMRCINO,GMRCREQ
"RTN","GMRCGUIU",13,0)
 K GMRCDIAG,GMRCDXCD,GMRCPROV,ND,NDX
"RTN","GMRCGUIU",14,0)
 K XQAKILL
"RTN","GMRCGUIU",15,0)
 Q
"RTN","GMRCGUIU",16,0)
SETDA(GMRCSS,GMRCPROC,GMRCURG,GMRCPL,GMRCATN,GMRCRQT,GMRCION,GMRCDIAG,GMRCDXCD)  ;Set DA in ^GMR(123,GMRCO,40
"RTN","GMRCGUIU",17,0)
 N X
"RTN","GMRCGUIU",18,0)
 S X=""
"RTN","GMRCGUIU",19,0)
 I +GMRCSS S X="1////^S X=+GMRCSS;.1///@;"
"RTN","GMRCGUIU",20,0)
 I +GMRCPROC S X=X_"4////^S X=GMRCPROC;.1///@;"
"RTN","GMRCGUIU",21,0)
 I +GMRCURG S X=X_"5////^S X=GMRCURG;"
"RTN","GMRCGUIU",22,0)
 I +GMRCPL S X=X_"6////^S X=GMRCPL;"
"RTN","GMRCGUIU",23,0)
 I +GMRCATN S X=X_"7////^S X=GMRCATN;"
"RTN","GMRCGUIU",24,0)
 I $G(GMRCATN)="@" S X=X_"7///@;"
"RTN","GMRCGUIU",25,0)
 I $L(GMRCION) S X=X_"14///^S X=GMRCION;"
"RTN","GMRCGUIU",26,0)
 I $L(GMRCDIAG) D 
"RTN","GMRCGUIU",27,0)
 . I GMRCDIAG="@" S X=X_"30///@;30.1///@;" Q
"RTN","GMRCGUIU",28,0)
 . S X=X_"30////^S X=GMRCDIAG;"
"RTN","GMRCGUIU",29,0)
 I $L(GMRCDXCD) S X=X_"30.1////^S X=GMRCDXCD;"
"RTN","GMRCGUIU",30,0)
 I $L(X) S X=$E(X,1,$L(X)-1)
"RTN","GMRCGUIU",31,0)
 Q X
"RTN","GMRCGUIU",32,0)
 ;
"RTN","GMRCGUIU",33,0)
COMMENT(GMRCO,MSG,ND,GMRCDA)    ;File comments from GUI edits
"RTN","GMRCGUIU",34,0)
 N Y,GMRCND
"RTN","GMRCGUIU",35,0)
 S GMRCDA=$$ADDCM^GMRCEDT4(GMRCO),GMRCA=20
"RTN","GMRCGUIU",36,0)
 D AUDIT0^GMRCEDT4(GMRCDA,GMRCO)
"RTN","GMRCGUIU",37,0)
 S Y=$$FMTE^XLFDT(DT,"1D"),GMRCFLD(40)="COMMENT ADDED: "_Y_"^"_GMRCDA
"RTN","GMRCGUIU",38,0)
 S GMRCND="",GMRCNT=1 F  S GMRCND=$O(@MSG@(ND,GMRCND)) Q:GMRCND=""  S ^GMR(123,GMRCO,40,GMRCDA,1,GMRCNT,0)=@MSG@(ND,GMRCND),GMRCNT=GMRCNT+1
"RTN","GMRCGUIU",39,0)
 S ^GMR(123,GMRCO,40,GMRCDA,1,0)="^^"_(GMRCNT-1)_"^"_(GMRCNT-1)_"^"_GMRCDT_"^"
"RTN","GMRCGUIU",40,0)
 Q
"RTN","GMRCGUIU",41,0)
 ;
"RTN","GMRCGUIU",42,0)
SENDCOMT(GMRCO,ND1)     ;Get comments
"RTN","GMRCGUIU",43,0)
 N NDX,NDY,CMTDT,SENDR,TYPE
"RTN","GMRCGUIU",44,0)
 S NDX=0,CMTDT="",SENDR=""
"RTN","GMRCGUIU",45,0)
 S NDX=0 F  S NDX=$O(^GMR(123,GMRCO,40,NDX)) Q:NDX?1A.E!(NDX="")  S TYPE=$P(^GMR(123,GMRCO,40,NDX,0),"^",2) I $S(TYPE=19:1,TYPE=20:1,1:0) S TYPE(TYPE,NDX)=""
"RTN","GMRCGUIU",46,0)
 I $O(TYPE(19,0)) S @GLOBAL@(ND1,0)="~DENY COMMENT",ND1=ND1+1 D
"RTN","GMRCGUIU",47,0)
 .S NDX=0 F  S NDX=$O(TYPE(19,NDX)) Q:NDX=""   D
"RTN","GMRCGUIU",48,0)
 ..S CMTDT=$$FMTE^XLFDT($P(^GMR(123,GMRCO,40,NDX,0),"^",1)),SENDR=$S($L($P(^GMR(123,GMRCO,40,NDX,0),"^",4)):$P(^VA(200,$P(^(0),"^",4),0),"^",1),1:"Missing Data")
"RTN","GMRCGUIU",49,0)
 ..S @GLOBAL@(ND1,0)="t"_"CANCELLED: "_CMTDT_" BY: "_SENDR,ND1=ND1+1,NDY=0
"RTN","GMRCGUIU",50,0)
 ..S NDY=0 F  S NDY=$O(^GMR(123,GMRCO,40,NDX,1,NDY)) Q:NDY=""  S @GLOBAL@(ND1,0)="t"_^GMR(123,GMRCO,40,NDX,1,NDY,0),ND1=ND1+1
"RTN","GMRCGUIU",51,0)
 ..S @GLOBAL@(ND1,0)="t",$P(@GLOBAL@(ND1,0),"-",81)="",ND1=ND1+1
"RTN","GMRCGUIU",52,0)
 ..Q
"RTN","GMRCGUIU",53,0)
 .Q
"RTN","GMRCGUIU",54,0)
 S NDX=0 F  S NDX=$O(TYPE(20,NDX)) Q:NDX=""  S @GLOBAL@(ND1,0)="~ADDED COMMENT",ND1=ND1+1 D
"RTN","GMRCGUIU",55,0)
 .S CMTDT=$$FMTE^XLFDT($P(^GMR(123,GMRCO,40,NDX,0),"^",1)),SENDR=$S($L($P(^GMR(123,GMRCO,40,NDX,0),"^",4)):$P(^VA(200,$P(^GMR(123,GMRCO,40,NDX,0),"^",4),0),"^",1),1:"UNKNOWN")
"RTN","GMRCGUIU",56,0)
 .S @GLOBAL@(ND1,0)="t"_"COMMENT on "_CMTDT_" BY: "_SENDR,ND1=ND1+1
"RTN","GMRCGUIU",57,0)
 .S NDY=0 F  S NDY=$O(^GMR(123,GMRCO,40,NDX,1,NDY)) Q:NDY=""  S @GLOBAL@(ND,0)="t"_^GMR(123,GMRCO,40,NDX,1,NDY,0),ND1=ND1+1
"RTN","GMRCGUIU",58,0)
 .S @GLOBAL@(ND1,0)="t",$P(@GLOBAL@(ND1,0),"-",81)="",ND1=ND1+1
"RTN","GMRCGUIU",59,0)
 .Q
"RTN","GMRCGUIU",60,0)
 Q
"RTN","GMRCGUIU",61,0)
GETMED(GMRCIFN,GMRCRES) ;return available med results for proc request
"RTN","GMRCGUIU",62,0)
 ; input: 
"RTN","GMRCGUIU",63,0)
 ;    GMRCIFN - ien from file 123
"RTN","GMRCGUIU",64,0)
 ;    GMRCRES - variable passed in by reference used for output
"RTN","GMRCGUIU",65,0)
 ; output: 
"RTN","GMRCGUIU",66,0)
 ;     GMRCRES(x) = result_name^date^summary^result_ref
"RTN","GMRCGUIU",67,0)
 ;      example:
"RTN","GMRCGUIU",68,0)
 ;       GMRCRES(1)="19;MCAR(691.5,^EKG^JUN 30,1999@15:52^ABNORMAL"
"RTN","GMRCGUIU",69,0)
 N CNT,ROOT,PROC,S5,DFN,I
"RTN","GMRCGUIU",70,0)
 N MCARCODE,MCARDT,MCESKEY,MCKEYCAR,MCFILE
"RTN","GMRCGUIU",71,0)
 S PROC=+$P($G(^GMR(123,GMRCIFN,0)),U,8)
"RTN","GMRCGUIU",72,0)
 I 'PROC Q  ;no procedure there
"RTN","GMRCGUIU",73,0)
 S ROOT=$$GET1^DIQ(697.2,+$P(^GMR(123.3,PROC,0),U,5),1)
"RTN","GMRCGUIU",74,0)
 I '$L(ROOT) Q  ;proc not set up for med resulting
"RTN","GMRCGUIU",75,0)
 S S5=ROOT D EN^MCARPS2(+$P(^GMR(123,GMRCIFN,0),U,2))
"RTN","GMRCGUIU",76,0)
 I '$D(^TMP("OR",$J,"MCAR","OT")) Q  ;no results available
"RTN","GMRCGUIU",77,0)
 S CNT=0,I=0
"RTN","GMRCGUIU",78,0)
 F  S CNT=$O(^TMP("OR",$J,"MCAR","OT",CNT)) Q:'CNT  D
"RTN","GMRCGUIU",79,0)
 . N DATA S DATA=^TMP("OR",$J,"MCAR","OT",CNT)
"RTN","GMRCGUIU",80,0)
 . Q:$D(^GMR(123,"R",$P(DATA,U,2)_";"_ROOT_","))
"RTN","GMRCGUIU",81,0)
 . Q:$$SCRNDRFT^GMRCMED($P(DATA,U,2),$P(ROOT,"(",2))  ;screen draft rpts
"RTN","GMRCGUIU",82,0)
 . S I=I+1
"RTN","GMRCGUIU",83,0)
 . S GMRCRES(I)=$P(DATA,U,2)_";"_ROOT_","_U_$P(DATA,U)_U_$P(DATA,U,6,7)
"RTN","GMRCGUIU",84,0)
 . Q
"RTN","GMRCGUIU",85,0)
 K MCARCODE,MCARDT,MCESKEY,MCKEYCAR,MCFILE
"RTN","GMRCGUIU",86,0)
 K ^TMP("OR",$J,"MCAR")
"RTN","GMRCGUIU",87,0)
 Q
"RTN","GMRCGUIU",88,0)
GETRES(GMRCO,GMRCAR) ;return array of associated med rslts
"RTN","GMRCGUIU",89,0)
 ; DBIA #: ?
"RTN","GMRCGUIU",90,0)
 ; Input:
"RTN","GMRCGUIU",91,0)
 ;   GMRCO - ien from file 123
"RTN","GMRCGUIU",92,0)
 ;   GMRCAR - variable passed by ref to return array in
"RTN","GMRCGUIU",93,0)
 ; Output:
"RTN","GMRCGUIU",94,0)
 ;   GMRCAR(x)=result_ref^result_name^date^impression
"RTN","GMRCGUIU",95,0)
 ;    Example:
"RTN","GMRCGUIU",96,0)
 ;      GMRCAR(1)="19;MCAR(691.5,^EKG^JUN 30,1999@15:52^ABNORMAL"
"RTN","GMRCGUIU",97,0)
 N RES,CNT,DATA
"RTN","GMRCGUIU",98,0)
 S RES=0,CNT=1
"RTN","GMRCGUIU",99,0)
 F  S RES=$O(^GMR(123,GMRCO,50,RES)) Q:'RES  D
"RTN","GMRCGUIU",100,0)
 . N GMRCMCR,GMRCMCAR,RES0
"RTN","GMRCGUIU",101,0)
 . S RES0=$G(^GMR(123,GMRCO,50,RES,0))
"RTN","GMRCGUIU",102,0)
 . I RES0'["MCAR" Q
"RTN","GMRCGUIU",103,0)
 . S GMRCMCR=$$SINGLE^MCAPI(RES0)
"RTN","GMRCGUIU",104,0)
 . Q:'$L(GMRCMCR)
"RTN","GMRCGUIU",105,0)
 . D MEDLKUP^MCARUTL3(.GMRCMCAR,+$P(RES0,"MCAR(",2),+RES0)
"RTN","GMRCGUIU",106,0)
 . S GMRCAR(CNT)=^GMR(123,GMRCO,50,RES,0)_U
"RTN","GMRCGUIU",107,0)
 . S GMRCAR(CNT)=GMRCAR(CNT)_$P(GMRCMCR,U)_U_$P(GMRCMCR,U,6,7)
"RTN","GMRCGUIU",108,0)
 . I $P(GMRCMCAR,U,10) S GMRCAR(CNT)=GMRCAR(CNT)_"^1"
"RTN","GMRCGUIU",109,0)
 . S CNT=CNT+1
"RTN","GMRCGUIU",110,0)
 . Q
"RTN","GMRCGUIU",111,0)
 Q
"RTN","GMRCGUIU",112,0)
DISPMED(GMRCRES,GMRCAR) ; display a med result
"RTN","GMRCGUIU",113,0)
 ; Input:
"RTN","GMRCGUIU",114,0)
 ;  GMRCRES - med result var ptr  (e.g. "19;MCAR(691.5")
"RTN","GMRCGUIU",115,0)
 ;  GMRCAR  - array to return output from medicine API
"RTN","GMRCGUIU",116,0)
 ; Output:
"RTN","GMRCGUIU",117,0)
 ;  GMRCAR 
"RTN","GMRCGUIU",118,0)
 ;    - var passed by ref or as global ref to return text of 
"RTN","GMRCGUIU",119,0)
 ;      medicine pkg report
"RTN","GMRCGUIU",120,0)
 ;    Example:  GMRCAR(1)="      PROCEDURE DATE/TIME: 06/30/99 15:52"
"RTN","GMRCGUIU",121,0)
 ;              GMRCAR(2)="        CONFIDENTIAL ECG REPORT"
"RTN","GMRCGUIU",122,0)
 ;              GMRCAR(3...)=
"RTN","GMRCGUIU",123,0)
 D START^ORWRP(80,"EN^MCAPI(GMRCRES)")
"RTN","GMRCGUIU",124,0)
 I '$D(^TMP("ORDATA",$J,1)) D  Q
"RTN","GMRCGUIU",125,0)
 . I $D(GMRCAR) S @GMRCAR@(1)="Unable to locate result." Q
"RTN","GMRCGUIU",126,0)
 . I '$D(GMRCAR) S GMRCAR(1)="Unable to locate result."
"RTN","GMRCGUIU",127,0)
 I $D(GMRCAR) M @GMRCAR=^TMP("ORDATA",$J,1)
"RTN","GMRCGUIU",128,0)
 I '$D(GMRCAR) M GMRCAR=^TMP("ORDATA",$J,1)
"RTN","GMRCGUIU",129,0)
 K ^TMP("ORDATA",$J,1)
"RTN","GMRCGUIU",130,0)
 Q
"RTN","GMRCGUIU",131,0)
CANDOMED(GMRCIEN,USER) ;can person associate med results?
"RTN","GMRCGUIU",132,0)
 ; GMRCIEN - ien from file 123
"RTN","GMRCGUIU",133,0)
 N PROC
"RTN","GMRCGUIU",134,0)
 I '$D(^GMR(123,GMRCIEN,0)) Q 0  ;bad record
"RTN","GMRCGUIU",135,0)
 S PROC=+$P(^GMR(123,GMRCIEN,0),U,8) I 'PROC Q 0  ;no procedure
"RTN","GMRCGUIU",136,0)
 I +$G(^GMR(123,GMRCIEN,1)) Q 0  ;med rslts not allowed on CP
"RTN","GMRCGUIU",137,0)
 I '+$P(^GMR(123.3,PROC,0),U,5) Q 0  ;proc not set up
"RTN","GMRCGUIU",138,0)
 Q 1
"RTN","GMRCHL7B")
0^7^B17883968
"RTN","GMRCHL7B",1,0)
GMRCHL7B ;SLC/DCM,MA - Process order parameters from ^GMRCHL7A and place data into ^GMR(123 global ;4/18/01  10:28
"RTN","GMRCHL7B",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,21,17**;DEC 27, 1997
"RTN","GMRCHL7B",3,0)
 ; Patch #21 changed Activity title on Consult detail display
"RTN","GMRCHL7B",4,0)
 ; from "ENTERED IN CPRS" to "CPRS RELEASED ORDER".
"RTN","GMRCHL7B",5,0)
NEW ;Add new order
"RTN","GMRCHL7B",6,0)
 ;GMRCO=^GMR(123,IFN, the new file number in file ^GMR(123,
"RTN","GMRCHL7B",7,0)
 ;GMRCORFN=OE/RR file number       GMRCWARD=ward patient is on
"RTN","GMRCHL7B",8,0)
 ;GMRCSS=service consult sent to   GMRCAD=date/time of request
"RTN","GMRCHL7B",9,0)
 ;GMRCPRI=procedure/request        GMRCURGI=urgency
"RTN","GMRCHL7B",10,0)
 ;GMRCATN=attention                GMRCSTS=OE/RR order status
"RTN","GMRCHL7B",11,0)
 ;GMRCORNP=patient's provider      GMRCTYPE=request type (request or consult)
"RTN","GMRCHL7B",12,0)
 ;GMRCSBR=service rendered on what basis (Inpatient, or Outpatient)
"RTN","GMRCHL7B",13,0)
 ;GMRCRFQ=reason for request array - word processing fields
"RTN","GMRCHL7B",14,0)
 ;GMRCOTXT=order display text from dialog or orderable item
"RTN","GMRCHL7B",15,0)
 ;GMRCPRDG=provisional DX
"RTN","GMRCHL7B",16,0)
 ;GMRCPRCD=provisional DX code 
"RTN","GMRCHL7B",17,0)
 N DIC,DLAYGO,X,DR,DIE,GMRCADUZ,GMRCCP
"RTN","GMRCHL7B",18,0)
 S DIC="^GMR(123,",DIC(0)="L",X="""N""",DLAYGO=123 D ^DIC K DLAYGO Q:Y<1
"RTN","GMRCHL7B",19,0)
 ; Patch #21 changed GMRCA=1 to GMRCA=2
"RTN","GMRCHL7B",20,0)
 S (DA,GMRCO)=+Y,GMRCSTS=5,GMRCA=2,DIE=DIC
"RTN","GMRCHL7B",21,0)
 L +^GMR(123,GMRCO)
"RTN","GMRCHL7B",22,0)
 S DR=".02////^S X=DFN;.03////^S X=GMRCORFN;.04////^S X=GMRCWARD;.05////^S X=GMRCFAC;.06////^S X=$G(GMRCOFN);1////^S X=GMRCSS;2////^S X=$G(GMRCWARD);3////^S X=GMRCAD;4////^S X=GMRCPRI;5////^S X=GMRCURGI;7////^S X=$G(GMRCATN)"
"RTN","GMRCHL7B",23,0)
 D ^DIE
"RTN","GMRCHL7B",24,0)
 I GMRCOTXT=$$GET1^DIQ(123.5,+GMRCSS,.01) S GMRCOTXT=""
"RTN","GMRCHL7B",25,0)
 ;Added new field .1 to DR on 7/11/98 to save the order text
"RTN","GMRCHL7B",26,0)
 S DR="6////^S X=GMRCPLI;8////^S X=GMRCSTS;9////^S X=GMRCA;10////^S X=GMRCORNP;13////^S X=GMRCTYPE;14////^S X=$G(GMRCSBR);30////^S X=$G(GMRCPRDG);.1////^S X=$G(GMRCOTXT)"
"RTN","GMRCHL7B",27,0)
 I $D(GMRCPRCD) S DR=DR_";30.1///^S X=GMRCPRCD"
"RTN","GMRCHL7B",28,0)
 S GMRCCP=$P($G(^GMR(123.3,+GMRCPRI,0)),U,4) I GMRCCP D
"RTN","GMRCHL7B",29,0)
        . S DR=DR_";1.01///^S X=GMRCCP"
"RTN","GMRCHL7B",30,0)
 D ^DIE
"RTN","GMRCHL7B",31,0)
 I $O(GMRCRFQ(0)) D REASON
"RTN","GMRCHL7B",32,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCHL7B",33,0)
 S GMRCA=1 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",34,0)
 I $D(GMRCXMF),$D(GMRCOFN) S $P(^GMR(123,GMRCO,0),"^",21)=GMRCOFN
"RTN","GMRCHL7B",35,0)
 I $D(GMRCACTN) S GMRCADUZ(GMRCACTN)=""
"RTN","GMRCHL7B",36,0)
 D ALERT^GMRCHL7U(DFN,GMRCSS,GMRCPRI,GMRCO,GMRCURGI,"")
"RTN","GMRCHL7B",37,0)
 D PRNT^GMRCUTL1(GMRCSS,GMRCO) ;contains print audit update
"RTN","GMRCHL7B",38,0)
 D EXIT
"RTN","GMRCHL7B",39,0)
 Q
"RTN","GMRCHL7B",40,0)
DC(GMRCO,ACTRL) ;Discontinue request from OERR
"RTN","GMRCHL7B",41,0)
 ;Denied request also gets this action. Deny request updates status to dc
"RTN","GMRCHL7B",42,0)
 ;GMRCO=IEN of record in file ^GMR(123, i.e., ^GMR(123,DA,
"RTN","GMRCHL7B",43,0)
 ;ACTRL=GMRCCTRL=control code defining action -
"RTN","GMRCHL7B",44,0)
 ;         DC control code = action DC for discontinued 
"RTN","GMRCHL7B",45,0)
 ;         CA control code = action DY for denied
"RTN","GMRCHL7B",46,0)
 ;Update the last action taken, order status, and processing activity
"RTN","GMRCHL7B",47,0)
 Q:'$L(GMRCO)
"RTN","GMRCHL7B",48,0)
 N GMRCACT,GMRCSVC,GMRCDFN,GMRCFL,GMRCADUZ,GMRCRQR,DA
"RTN","GMRCHL7B",49,0)
 S GMRCACT=$O(^GMR(123.1,"D",ACTRL,0))
"RTN","GMRCHL7B",50,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",51,0)
 S DIE="^GMR(123,",DA=GMRCO
"RTN","GMRCHL7B",52,0)
 S DR="8////^S X=GMRCSTS;9////^S X=GMRCACT" ; upd status + last action
"RTN","GMRCHL7B",53,0)
 D ^DIE
"RTN","GMRCHL7B",54,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",55,0)
 ; send 513 back through service printer if order DC'd
"RTN","GMRCHL7B",56,0)
 I $G(ACTRL)="DC",$$DCPRNT^GMRCUTL1(GMRCO,DUZ) D
"RTN","GMRCHL7B",57,0)
 . D PRNT^GMRCUTL1(+$P(^GMR(123,GMRCO,0),U,5),GMRCO)
"RTN","GMRCHL7B",58,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCHL7B",59,0)
 S GMRCFL=$$DCNOTE^GMRCADC(GMRCO,DUZ),GMRCADUZ=""
"RTN","GMRCHL7B",60,0)
 S GMRCRQR=+$P($G(^GMR(123,+GMRCO,0)),"^",14)
"RTN","GMRCHL7B",61,0)
 I +GMRCRQR,GMRCRQR'=DUZ S GMRCADUZ(GMRCRQR)=""
"RTN","GMRCHL7B",62,0)
 S GMRCSVC=$P($G(^GMR(123,+GMRCO,0)),"^",5)
"RTN","GMRCHL7B",63,0)
 I +GMRCSVC S GMRCSVC=$S($D(^GMR(123.5,GMRCSVC,.1)):^(.1),1:$P(^GMR(123.5,GMRCSVC,0),"^",1))
"RTN","GMRCHL7B",64,0)
 E  S GMRCSVC="Unknown Service: Consult # "_GMRCO
"RTN","GMRCHL7B",65,0)
 S GMRCORTX=$S(ACTRL="DC":"Discontinued",1:"Cancelled")
"RTN","GMRCHL7B",66,0)
 S GMRCORTX=GMRCORTX_" Consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCHL7B",67,0)
 N NOTYPE S NOTYPE=$S(ACTRL="DC":23,1:30)
"RTN","GMRCHL7B",68,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,NOTYPE,.GMRCADUZ,GMRCFL)
"RTN","GMRCHL7B",69,0)
 D EXIT
"RTN","GMRCHL7B",70,0)
 Q
"RTN","GMRCHL7B",71,0)
MODIFY ;Change an order/request when an HL7 'XX' code is received
"RTN","GMRCHL7B",72,0)
 ;This is currently not used.
"RTN","GMRCHL7B",73,0)
 ;    When Consults sends an XX, CPRS returns NA with a new order ien.
"RTN","GMRCHL7B",74,0)
 ;GMRCACT=processing activity - from file ^GMR(123.1,
"RTN","GMRCHL7B",75,0)
 S DIE="^GMR(123,",DA=+GMRCO
"RTN","GMRCHL7B",76,0)
 S GMRCWARD=$G(GMRCWARD),GMRCPRI=$G(GMRCPRI),GMRCURGI=$G(GMRCURGI),GMRCSTS=$G(GMRCSTS),GMRCTYPE=$G(GMRCTYPE),GMRCSS=$G(GMRCSS)
"RTN","GMRCHL7B",77,0)
 S GMRCACT=$O(^GMR(123.1,"D",GMRCTRLC,0))
"RTN","GMRCHL7B",78,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",79,0)
 S DIE=123,DR=".04////^S X=$G(GMRCWARD);1////^S X=$G(GMRCSS);4////^S X=$G(GMRCPRI);5////^S X=$G(GMRCURGI);8////^S X=$G(GMRCSTS);9////^S X=GMRCACT"
"RTN","GMRCHL7B",80,0)
 D ^DIE
"RTN","GMRCHL7B",81,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",82,0)
 D EXIT Q
"RTN","GMRCHL7B",83,0)
REASON ;load the reason for request into ^GMR(123,IFN,20
"RTN","GMRCHL7B",84,0)
 S ^GMR(123,GMRCO,20,0)="^^^"_$S($D(GMRCDA):GMRCDA,1:DT)_"^"
"RTN","GMRCHL7B",85,0)
 S L=0,LN=1 F  S L=$O(GMRCRFQ(L)) Q:L=""  S ^GMR(123,GMRCO,20,LN,0)=GMRCRFQ(L),LN=LN+1
"RTN","GMRCHL7B",86,0)
 S LN=LN-1,$P(^GMR(123,GMRCO,20,0),"^",3)=LN
"RTN","GMRCHL7B",87,0)
 K L,LN
"RTN","GMRCHL7B",88,0)
 Q
"RTN","GMRCHL7B",89,0)
COMMENT(GMRCARY) ;add comments to the record.  Add the comment header, then the comment lines, and lastly, the number of comment lines to the header
"RTN","GMRCHL7B",90,0)
 ;GMRCARY= GMRCNTC array
"RTN","GMRCHL7B",91,0)
 S LN=0,^GMR(123,GMRCO,40,DA,1,0)="^^^^"_$P(GMRCDA,".",1)_"^"
"RTN","GMRCHL7B",92,0)
 F  S LN=$O(GMRCARY(LN)) Q:LN=""  S ^GMR(123,+GMRCO,40,DA,1,LN,0)=GMRCARY(LN),LN1=LN
"RTN","GMRCHL7B",93,0)
 S $P(^GMR(123,+GMRCO,40,DA,1,0),"^",3,4)=LN1_"^"_LN1
"RTN","GMRCHL7B",94,0)
 K LN,LN1 Q
"RTN","GMRCHL7B",95,0)
 Q
"RTN","GMRCHL7B",96,0)
EXIT ;kill off all variables
"RTN","GMRCHL7B",97,0)
 K DA,DIC,DIE,DR,GMRCORTX,GMRCADUZ
"RTN","GMRCHL7B",98,0)
 Q
"RTN","GMRCP")
0^4^B10719046
"RTN","GMRCP",1,0)
GMRCP ;SLC/DLT,DCM - Message audit and status process ;4/19/01  11:52
"RTN","GMRCP",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,17**;DEC 27, 1997
"RTN","GMRCP",3,0)
 ;Processing action on Generic Requests/Consults from OE/RR
"RTN","GMRCP",4,0)
MSG(GMRCDFN,GMRCALRM,GMRCIFN,ORN,GMRCADUZ,FLG) ;send alert notification information to OERR for notification or update
"RTN","GMRCP",5,0)
 ;GMRCDFN=patient's DFN           GMRCORFN=OR file # ^OR(100,GMRCORFN
"RTN","GMRCP",6,0)
 ;GMRCALRM=alert message to be displayed with alert
"RTN","GMRCP",7,0)
 ;GMRCIFN=internal file number of consult in file 123
"RTN","GMRCP",8,0)
 ;GMRCADUZ=set in call to EN^GMRCT=array of providers who will be alerted
"RTN","GMRCP",9,0)
 ;FLG=1 if need to get list of service's providers, 0 if service dc'd.
"RTN","GMRCP",10,0)
 ;ORN=IFN from file ^ORD(100.9, for consult notification action
"RTN","GMRCP",11,0)
 N GMRCSS,GMRCORFN
"RTN","GMRCP",12,0)
 S GMRCORFN=$P(^GMR(123,+GMRCIFN,0),"^",3)
"RTN","GMRCP",13,0)
 S GMRCSS=$P($G(^GMR(123,+GMRCIFN,0)),"^",5) I FLG,GMRCSS D EN^GMRCT(GMRCSS)
"RTN","GMRCP",14,0)
 I FLG,$P(^GMR(123,+GMRCIFN,0),"^",11) S GMRCADUZ($P(^(0),"^",11))=""
"RTN","GMRCP",15,0)
 S:'$D(GMRCADUZ) GMRCADUZ=""
"RTN","GMRCP",16,0)
 D EN^ORB3(ORN,GMRCDFN,GMRCORFN,.GMRCADUZ,GMRCALRM,GMRCIFN)
"RTN","GMRCP",17,0)
 Q
"RTN","GMRCP",18,0)
AUDIT ;Build processing activity audit trail multiple.
"RTN","GMRCP",19,0)
 S GMRCDT=$$NOW^XLFDT
"RTN","GMRCP",20,0)
AUDIT0 ;alternate entry with date already defined
"RTN","GMRCP",21,0)
 L +^GMR(123,+GMRCO,40):5 I '$T S GMRCUT=1,GMRCERR=1,GMRCERMS="Activity Trail Not filed - Consult In Use By Another User." L -^GMR(123,+GMRCO,40)  Q
"RTN","GMRCP",22,0)
 S:'$D(^GMR(123,+GMRCO,40,0)) ^(0)="^123.02DA^^"
"RTN","GMRCP",23,0)
 S DA=$S($P(^GMR(123,+GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCP",24,0)
 S $P(^GMR(123,+GMRCO,40,0),"^",3,4)=DA_"^"_DA
"RTN","GMRCP",25,0)
AUDIT1 ;entry when the DA is not incremented (INCOMPLETE RPT writeovers)
"RTN","GMRCP",26,0)
 S GMRCORNP=$G(GMRCORNP) S:'$D(GMRCOM) GMRCOM=0
"RTN","GMRCP",27,0)
 S GMRCDEV=$G(GMRCDEV),GMRCFF=$G(GMRCFF),GMRCPA=$G(GMRCPA)
"RTN","GMRCP",28,0)
 S GMRCAD=$S('$D(GMRCAD):GMRCDT,1:GMRCAD)
"RTN","GMRCP",29,0)
 S GMRCRSLT=$G(GMRCRSLT) ;Added result with GMRC*3.0*4
"RTN","GMRCP",30,0)
 S DIE="^GMR(123,"_+GMRCO_",40,",DA(1)=+GMRCO
"RTN","GMRCP",31,0)
 I '$D(^GMR(123,DA(1),40,DA,0)) D
"RTN","GMRCP",32,0)
 . S DR=".01////^S X=GMRCDT;1////^S X=GMRCA;2////^S X=GMRCAD;3////^S X=GMRCORNP;4////^S X=DUZ;6////^S X=GMRCFF;7////^S X=GMRCPA;8////^S X=GMRCDEV;9////^S X=GMRCRSLT"
"RTN","GMRCP",33,0)
 E  D
"RTN","GMRCP",34,0)
 . ;DR string on .01 allows write over, rather than forced new entry
"RTN","GMRCP",35,0)
 . S DR=".01///^S X=GMRCDT;1////^S X=GMRCA;2////^S X=GMRCAD;3////^S X=GMRCORNP;4////^S X=DUZ;6////^S X=GMRCFF;7////^S X=GMRCPA;8////^S X=GMRCDEV;9////^S X=GMRCRSLT"
"RTN","GMRCP",36,0)
 ;Added result to the DR string
"RTN","GMRCP",37,0)
 D ^DIE
"RTN","GMRCP",38,0)
 ;Enter comment
"RTN","GMRCP",39,0)
 I +$G(GMRCOM) S GMRCOM(0)=DA D
"RTN","GMRCP",40,0)
 . W !,"Enter COMMENT..."
"RTN","GMRCP",41,0)
 . N DIC,DWPK,DWLW,DIWESUB
"RTN","GMRCP",42,0)
 . S DIC=DIE_DA_",1,",DWPK=1,DWLW=74
"RTN","GMRCP",43,0)
 . S DIWESUB="COMMENTS" D EN^DIWE
"RTN","GMRCP",44,0)
 . I $P($G(^GMR(123.1,+$P(^GMR(123,+GMRCO,40,DA,0),U,2),0)),U)="ADDED COMMENT",'$O(^GMR(123,+GMRCO,40,DA,0)) D  Q
"RTN","GMRCP",45,0)
 .. S DA(1)=+GMRCO,DIK="^GMR(123,"_DA(1)_",40," D ^DIK K DIK
"RTN","GMRCP",46,0)
 .. Q
"RTN","GMRCP",47,0)
 . I $D(^GMR(123,+GMRCO,40,DA,0)),$O(^GMR(123,+GMRCO,40,DA,0)) S $P(GMRCOM,"^",2)=1
"RTN","GMRCP",48,0)
 . Q
"RTN","GMRCP",49,0)
 L -^GMR(123,+GMRCO,40)
"RTN","GMRCP",50,0)
 K DIE,DA,DR,GMRCDEV,GMRCFF,GMRCPA,X,% Q
"RTN","GMRCP",51,0)
 ;
"RTN","GMRCP",52,0)
STATUS ;Update the status for the Request/Consultation File
"RTN","GMRCP",53,0)
 K GMRCQUT
"RTN","GMRCP",54,0)
 Q:'$D(GMRCSTS)!('$D(GMRCA))
"RTN","GMRCP",55,0)
 S DIE=123,DA=+GMRCO
"RTN","GMRCP",56,0)
 I $D(GMRCDR),$L(GMRCDR) S DR=GMRCDR
"RTN","GMRCP",57,0)
 E  S DR="8////^S X=GMRCSTS;9////^S X=GMRCA"
"RTN","GMRCP",58,0)
 L +^GMR(123,GMRCO):2 I '$T S GMRCQUT=1,GMRCERR=1,GMRCERMS="Unable to update status and last action - Consult In Use By Another User." Q
"RTN","GMRCP",59,0)
 D ^DIE
"RTN","GMRCP",60,0)
 L -^GMR(123,+GMRCO)
"RTN","GMRCP",61,0)
 K DIE,DA,DR,GMRCDR
"RTN","GMRCP",62,0)
 Q
"RTN","GMRCSLM1")
0^5^B47319589
"RTN","GMRCSLM1",1,0)
GMRCSLM1 ;SLC/DCM - Gather data and format ^TMP global for consult tracking Silent call for use by List Manager and GUI ;10/9/01 23:12
"RTN","GMRCSLM1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,10,12,15,17**;DEC 27, 1997
"RTN","GMRCSLM1",3,0)
 ;
"RTN","GMRCSLM1",4,0)
 ; This routine invokes IA #2638,#2740
"RTN","GMRCSLM1",5,0)
 ;
"RTN","GMRCSLM1",6,0)
 G AD
"RTN","GMRCSLM1",7,0)
SVC(NODE) ;Check for a valid service
"RTN","GMRCSLM1",8,0)
 K GMRCDEAV
"RTN","GMRCSLM1",9,0)
 I '$D(^GMR(123,NODE,0)) Q 0
"RTN","GMRCSLM1",10,0)
 I '+$P(^GMR(123,NODE,0),"^",5) Q 0
"RTN","GMRCSLM1",11,0)
 I '$D(^TMP("GMRCS",$J,$P(^GMR(123,NODE,0),"^",5))) Q 0
"RTN","GMRCSLM1",12,0)
 Q 1
"RTN","GMRCSLM1",13,0)
AD ;Main entry point. Loop through AD x-ref in file 123; Find consults that have been released to requested service
"RTN","GMRCSLM1",14,0)
 ;;DFN and GMRCSSNM must be defined when this entry point is called
"RTN","GMRCSLM1",15,0)
 ;;DFN=Internal File Number of Patient in ^DPT
"RTN","GMRCSLM1",16,0)
 ;;GMRCSSNM=Service Name of a Hospital Service from file ^GMR(123.5
"RTN","GMRCSLM1",17,0)
 ;;If GMRCSSNM is not defined or is null, then no records will be found.
"RTN","GMRCSLM1",18,0)
 ;;GMRCOER must be passed so that proper formatting for GUI or List Manager can be performed.  GMRCOER is passed as 0 for List Manager, 1 for GUI.
"RTN","GMRCSLM1",19,0)
 ;;GMRCDT1 and GMRCDT2 are passed in as start and stop dates for the lookup. If GMRCDT1="" or GMRCDT1="ALL", then all dates are searched.
"RTN","GMRCSLM1",20,0)
 ;;  ***********************************************************
"RTN","GMRCSLM1",21,0)
 K ^TMP("GMRCR",$J,"CS"),GMRCNUL
"RTN","GMRCSLM1",22,0)
 I $D(GMRCSSS) S (GMRCDG,GMRCSS)=GMRCSSS,GMRCSSNM=($P($G(^GMR(123.5,+GMRCSS,0)),"^",1)) D SERV1^GMRCASV K GMRCSSS ;reset after forward
"RTN","GMRCSLM1",23,0)
 S TAB="",$P(TAB," ",41)="",BLK=0,LNCT=1 S:'$D(GMRCOER) GMRCOER=0
"RTN","GMRCSLM1",24,0)
 S GMRCD=0 F  S GMRCD=$O(^GMR(123,"AD",DFN,GMRCD)) Q:'GMRCD  S GMRCDA=0 F  S GMRCDA=$O(^GMR(123,"AD",DFN,GMRCD,GMRCDA)) Q:'GMRCDA  I $$SVC(GMRCDA) D SET
"RTN","GMRCSLM1",25,0)
 D END Q
"RTN","GMRCSLM1",26,0)
SET ;;Format entries into a word processing 'TMP("GMRCR",$J,"CS",' global that List Manager can display
"RTN","GMRCSLM1",27,0)
 ;;GMRCOER is a variable that signals that data is being formatted for the OE/RR GUI; this data is formatted differently than the data for List Manager.
"RTN","GMRCSLM1",28,0)
 ;;GMRCOER=0 : Data is List Manager formatted.
"RTN","GMRCSLM1",29,0)
 ;;GMRCOER=1 : Data is OE/RR GUI formatted.
"RTN","GMRCSLM1",30,0)
 S:'$D(TAB) TAB="",$P(TAB," ",30)=""
"RTN","GMRCSLM1",31,0)
 S GMRCIFN=$G(GMRCDA) I '$L(GMRCIFN),$D(XQADATA) S (GMRCDA,GMRCIFN)=+XQADATA
"RTN","GMRCSLM1",32,0)
 S GMRCSEX=$S($P(^DPT(DFN,0),"^",2)="M":"MALE",1:"FEMALE")
"RTN","GMRCSLM1",33,0)
 I '$D(^GMR(123,+GMRCIFN,0)) S GMRCQUT=1 Q
"RTN","GMRCSLM1",34,0)
 S PROC="",GMRC(0)=^GMR(123,GMRCIFN,0)
"RTN","GMRCSLM1",35,0)
 I $D(GMRCSTCK),GMRCSTCK'="" N STATUS,TITLE D  Q:'STATUS
"RTN","GMRCSLM1",36,0)
 . N I
"RTN","GMRCSLM1",37,0)
 . F I=1:1 S STATUS=$P(GMRCSTCK,",",I) Q:STATUS=$P(GMRC(0),"^",12)  Q:'STATUS
"RTN","GMRCSLM1",38,0)
 . Q
"RTN","GMRCSLM1",39,0)
 I $D(GMRCVP),GMRCVP'=$P(GMRC(0),"^",8) Q
"RTN","GMRCSLM1",40,0)
 S (GMRCFMDT,X)=$P(GMRC(0),"^",7) I GMRCDT1'="ALL",$P(X,".",1)<GMRCDT1!($P(X,".",1)>GMRCDT2) Q
"RTN","GMRCSLM1",41,0)
 I GMRCOER'=2 D
"RTN","GMRCSLM1",42,0)
 . S BLK=BLK+1
"RTN","GMRCSLM1",43,0)
 . S ^TMP("GMRCR",$J,"CS","AD",BLK,LNCT,GMRCDA)=""
"RTN","GMRCSLM1",44,0)
 D REGDTM^GMRCU S CDT=$P(X," ")
"RTN","GMRCSLM1",45,0)
 S PROC=$S($P(GMRC(0),U,17)="P":"Procedure",1:"Consult")
"RTN","GMRCSLM1",46,0)
 I PROC'="Consult" S PROC=$$GET1^DIQ(123.3,+$P(GMRC(0),"^",8),.01)
"RTN","GMRCSLM1",47,0)
 S:PROC="" PROC="Consult"
"RTN","GMRCSLM1",48,0)
 S TO=+$P(GMRC(0),"^",5)
"RTN","GMRCSLM1",49,0)
 I +TO S TOD=$S($P($G(^GMR(123.5,+TO,0)),"^",2)=9:1,1:0)
"RTN","GMRCSLM1",50,0)
 I '$D(TOD) S TOD=0
"RTN","GMRCSLM1",51,0)
 S TO=$S(+TO:$P($G(^GMR(123.5,+TO,0)),"^",1),1:"")
"RTN","GMRCSLM1",52,0)
 S TO=$S(TOD:"<",1:"")_TO
"RTN","GMRCSLM1",53,0)
 S TO=$S(GMRCOER:TO,1:$E(TO,1,40))_$S(TOD:">",1:"")
"RTN","GMRCSLM1",54,0)
 I '$L(TO) S TO="**Unknown Service**"
"RTN","GMRCSLM1",55,0)
 S STS=$P(GMRC(0),"^",12) D
"RTN","GMRCSLM1",56,0)
 . I '+STS,'$D(^ORD(100.01,+STS,0)) Q
"RTN","GMRCSLM1",57,0)
 . I '+GMRCOER S STS=$P(^ORD(100.01,+STS,.1),"^",1) Q
"RTN","GMRCSLM1",58,0)
 . I GMRCOER=1 S STS=$P(^ORD(100.01,+STS,0),"^") Q
"RTN","GMRCSLM1",59,0)
 . S STS=$P(^ORD(100.01,+STS,.1),"^")
"RTN","GMRCSLM1",60,0)
 I $S(STS="":1,'$D(^ORD(100.01,+$P(GMRC(0),"^",12),0)):1,1:0) S STS=99,$P(GMRC(0),"^",12)=STS,STS=$S(GMRCOER=1:$P(^ORD(100.01,5,0),"^",1),1:$P(^ORD(100.01,+STS,.1),"^",1))
"RTN","GMRCSLM1",61,0)
 D SERVPROC
"RTN","GMRCSLM1",62,0)
 I 'GMRCOER D  Q
"RTN","GMRCSLM1",63,0)
 . S ^TMP("GMRCR",$J,"CS",LNCT,0)=BLK_$E(TAB,1,(4-$L(BLK)))_CDT_"  "_$E(STS,1,3)_$S(STS?1A:"  ",STS?2A:" ",1:"")_" "_$J(GMRCDA,7)_" "_$S($P(GMRC(0),"^",19)="Y":"*",1:" ")_TITLE
"RTN","GMRCSLM1",64,0)
 . S LNCT=LNCT+1
"RTN","GMRCSLM1",65,0)
 I GMRCOER D
"RTN","GMRCSLM1",66,0)
 . N DATA
"RTN","GMRCSLM1",67,0)
 . S DATA=GMRCDA_U_GMRCFMDT_U_STS_U_TO_U_PROC_U
"RTN","GMRCSLM1",68,0)
 . S DATA=DATA_$S($P(GMRC(0),U,19)="Y":"*",1:"")_U
"RTN","GMRCSLM1",69,0)
 . S DATA=DATA_TITLE_U_$P(GMRC(0),U,3)
"RTN","GMRCSLM1",70,0)
 . S $P(DATA,U,9)=$S(+$G(^GMR(123,GMRCDA,1)):"M",1:$P(GMRC(0),U,17))
"RTN","GMRCSLM1",71,0)
 . S ^TMP("GMRCR",$J,"CS",LNCT,0)=DATA
"RTN","GMRCSLM1",72,0)
 . S LNCT=LNCT+1
"RTN","GMRCSLM1",73,0)
 . K STSOER Q
"RTN","GMRCSLM1",74,0)
 Q
"RTN","GMRCSLM1",75,0)
END I LNCT<2 S (BLK,LNCT,GMRCNUL)=1,GMRCNPM="< PATIENT DOES NOT HAVE ANY CONSULTS/REQUESTS "_$S($D(GMRCPRNM):"FOR "_GMRCPRNM,1:"")_" ON FILE. >",GMRCNPM=$E(TAB,1,(80-$L(GMRCNPM))\80)_GMRCNPM,^TMP("GMRCR",$J,"CS",LNCT,0)=GMRCNPM D
"RTN","GMRCSLM1",76,0)
 .I GMRCDT1'="ALL",$D(GMRCDT1)&($D(GMRCDT2)) S LNCT=LNCT+1,^TMP("GMRCR",$J,"CS",LNCT,0)="Between Dates: "_$$FMTE^XLFDT(GMRCDT1)_" and "_$$FMTE^XLFDT(GMRCDT2)
"RTN","GMRCSLM1",77,0)
 .I $D(GMRCSTCK),$L(GMRCSTCK) S LNCT=LNCT+1,^TMP("GMRCR",$J,"CS",LNCT,0)="With Status: " S STS="" F I=1:1 S STS=$P(GMRCSTCK,",",I) Q:STS=""  S ^TMP("GMRCR",$J,"CS",LNCT,0)=^(0)_$P($G(^ORD(100.01,+STS,0)),"^",1)_" "
"RTN","GMRCSLM1",78,0)
 .Q
"RTN","GMRCSLM1",79,0)
 E  S (BLK,LNCT)=LNCT-1,^TMP("GMRCR",$J,"CS",0)="^^^"_LNCT
"RTN","GMRCSLM1",80,0)
 I $D(GMRCALFL) S (BLK,LNCT)=1
"RTN","GMRCSLM1",81,0)
 K TO,TOD,END,FLG,GMRC(0),GMRCD,GMRCDG,GMRCIFN,GMRCFMDT,GMRCNPM,GMRCWARD
"RTN","GMRCSLM1",82,0)
 K I,PROC,STS,URG
"RTN","GMRCSLM1",83,0)
 Q
"RTN","GMRCSLM1",84,0)
OER(DFN,GMRCDG,GMRCDT1,GMRCDT2,GMRCSTCK,GMRCOER) ;;GUI interface for CPRS
"RTN","GMRCSLM1",85,0)
 ;;DFN=Patient internal file number
"RTN","GMRCSLM1",86,0)
 ;;GMRCDG:  Internal file number of consult service from file 123.5
"RTN","GMRCSLM1",87,0)
 ;;GMRCDT1:  Beginning date for lookup
"RTN","GMRCSLM1",88,0)
 ;;GMRCDT2:  Ending date for lookup
"RTN","GMRCSLM1",89,0)
 ;;GMRCSTCK: IEN from OER Status File [^OER(100.01)] to screen results
"RTN","GMRCSLM1",90,0)
 ;;     so that only consults with a desired status are displayed
"RTN","GMRCSLM1",91,0)
 ;;     Can be sent as a set of statuses: i.e., 6,5,2
"RTN","GMRCSLM1",92,0)
 ;;      (GMRCSTCK=GMRC STATUS CHECK)
"RTN","GMRCSLM1",93,0)
 ;;GMRCOER=0 if request is from CONSULTS
"RTN","GMRCSLM1",94,0)
 ;;       =1 if request is for CPRS List Manager
"RTN","GMRCSLM1",95,0)
 ;;       =2 if for CPRS GUI
"RTN","GMRCSLM1",96,0)
 I GMRCDT1="" S GMRCDT1="ALL"
"RTN","GMRCSLM1",97,0)
 I GMRCDG="" S GMRCDG=$O(^GMR(123.5,"B","ALL SERVICES",0))
"RTN","GMRCSLM1",98,0)
 S:'$D(GMRCOER) GMRCOER=1
"RTN","GMRCSLM1",99,0)
 D SERV1^GMRCASV,AD
"RTN","GMRCSLM1",100,0)
 K ^TMP("GMRCS",$J),^TMP("GMRCSLIST",$J)
"RTN","GMRCSLM1",101,0)
 Q
"RTN","GMRCSLM1",102,0)
SERVPROC ; Build contents of SERV/PROC field for List Manager
"RTN","GMRCSLM1",103,0)
 N TYPE,OTXT
"RTN","GMRCSLM1",104,0)
 S TITLE=""
"RTN","GMRCSLM1",105,0)
 S TYPE=""
"RTN","GMRCSLM1",106,0)
 S OTXT=$P($G(^GMR(123,GMRCDA,1.11)),"^")
"RTN","GMRCSLM1",107,0)
 I OTXT="" D BUILD2
"RTN","GMRCSLM1",108,0)
 I OTXT'="" D BUILD1
"RTN","GMRCSLM1",109,0)
 Q
"RTN","GMRCSLM1",110,0)
BUILD1 ;OTXT does contain information
"RTN","GMRCSLM1",111,0)
 N FLG,BADFLG,TPROC,TTO,LEN,ABBRS,ABBRP
"RTN","GMRCSLM1",112,0)
 S TPROC=$$UP^XLFSTR(PROC),TTO=$$UP^XLFSTR(TO)
"RTN","GMRCSLM1",113,0)
 S TITLE=OTXT,OTXT=$$UP^XLFSTR(OTXT)
"RTN","GMRCSLM1",114,0)
 S BADFLG=0
"RTN","GMRCSLM1",115,0)
 I PROC="Consult" S FLG=1,TYPE="Cons"
"RTN","GMRCSLM1",116,0)
 I PROC'="Consult" S FLG=0,TYPE="Proc"
"RTN","GMRCSLM1",117,0)
 S LEN=$L(TITLE)
"RTN","GMRCSLM1",118,0)
 I TO="" S TO="No Service"
"RTN","GMRCSLM1",119,0)
 I LEN<30,FLG=1,OTXT'=TTO S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",120,0)
 I LEN<30,FLG=1,OTXT=TTO S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",121,0)
 I TO["<" S BADFLG=1
"RTN","GMRCSLM1",122,0)
 S ABBRS=$$SVC^GMRCAU(GMRCDA),ABBRP=$$PROC^GMRCAU(GMRCDA)
"RTN","GMRCSLM1",123,0)
 I LEN<30,FLG=0,TPROC'=OTXT,TTO'=TPROC S TITLE=TITLE_" "_PROC_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",124,0)
 I LEN<30,FLG=0,TPROC=OTXT,TTO'=TPROC S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",125,0)
 I LEN<30,FLG=0,TPROC=OTXT,TTO=TPROC S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",126,0)
 I LEN>30,FLG=1,TTO'=OTXT S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",127,0)
 I LEN>30,FLG=1,TTO=OTXT S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",128,0)
 I LEN>30,FLG=0,TPROC'=OTXT,TTO'=TPROC S TITLE=TITLE_" "_ABBRP_" "_TYPE Q
"RTN","GMRCSLM1",129,0)
 I LEN>30,FLG=0,TTO'=OTXT,BADFLG=0 S TITLE=TITLE_" "_ABBRS_" "_TYPE Q
"RTN","GMRCSLM1",130,0)
 I LEN>30,FLG=0,TTO'=OTXT,BADFLG=1 S TITLE=TITLE_" "_"<"_ABBRS_">"_TYPE Q
"RTN","GMRCSLM1",131,0)
 Q
"RTN","GMRCSLM1",132,0)
BUILD2 ;OTXT contains no information
"RTN","GMRCSLM1",133,0)
 N FLG,TPROC,TTO,LEN
"RTN","GMRCSLM1",134,0)
 S TPROC=$$UP^XLFSTR(PROC),TTO=$$UP^XLFSTR(TO)
"RTN","GMRCSLM1",135,0)
 I PROC="Consult" S TITLE=TO,LEN=$L(TITLE),FLG=1,TYPE="Cons"
"RTN","GMRCSLM1",136,0)
 I PROC'="Consult" S TITLE=PROC,LEN=$L(TITLE),FLG=0,TYPE="Proc"
"RTN","GMRCSLM1",137,0)
 I FLG=1 S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",138,0)
 I FLG=0,TTO=TPROC S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",139,0)
 I FLG=0,TTO'=TPROC S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",140,0)
 Q
"RTN","GMRCSLM2")
0^9^B32804894
"RTN","GMRCSLM2",1,0)
GMRCSLM2 ;SLC/DCM - LM Detailed  display and printing ;4/4/01 14:55
"RTN","GMRCSLM2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,18,15,17**;DEC 27,1997
"RTN","GMRCSLM2",3,0)
 ;
"RTN","GMRCSLM2",4,0)
 ; This routine invokes IA #616,#872,#875,#2467,#2638,#2693,#2925,#3138
"RTN","GMRCSLM2",5,0)
 ;
"RTN","GMRCSLM2",6,0)
DT(GMRCO) ;;Entry point to set-up detailed display.
"RTN","GMRCSLM2",7,0)
 ;;Pass in GMRCO as +GMRCO - a number only. GMRCO=IEN from of consult from file 123
"RTN","GMRCSLM2",8,0)
 ;;Results are placed in ^TMP("GMRCR",$J,"DT",
"RTN","GMRCSLM2",9,0)
 ;;Pass in variable GMRCOER=2 if calling from the GUI, GMRCOER=1 if call is from CPRS consults tab
"RTN","GMRCSLM2",10,0)
 ;;Pass in variable GMRCOER=0 (or as <UNDEFINED>) if call is from consults routines
"RTN","GMRCSLM2",11,0)
 K GMRCQUT
"RTN","GMRCSLM2",12,0)
 N DFN,GMRCD,GMRCDA,ORIFN,GMRCSF S GMRCDVDL="",$P(GMRCDVDL,"-",80)=""
"RTN","GMRCSLM2",13,0)
 I $S('GMRCO:1,'$D(^GMR(123,+GMRCO,0)):1,1:0) D:$S('$D(GMRCOER):1,'GMRCOER:1,1:0)  S GMRCQUT=1 Q
"RTN","GMRCSLM2",14,0)
 .S GMRCMSG="The consult entry selected for the Detailed Display is unknown." D EXAC^GMRCADC(GMRCMSG) K GMRCMSG
"RTN","GMRCSLM2",15,0)
 .Q
"RTN","GMRCSLM2",16,0)
 K ^TMP("GMRCR",$J,"DT") S TAB="",$P(TAB," ",30)="",GMRCCT=1
"RTN","GMRCSLM2",17,0)
 S GMRCO(0)=^GMR(123,+GMRCO,0),ORIFN=$P(GMRCO(0),"^",3),DFN=$P(GMRCO(0),"^",2)
"RTN","GMRCSLM2",18,0)
 S X="SDUTL3" X ^%ZOSF("TEST") I  D
"RTN","GMRCSLM2",19,0)
 .N PR S PR=$$OUTPTPR^SDUTL3(DFN) I $L(PR) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Current PC Provider:   "_$P(PR,"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",20,0)
 .S PR=$$OUTPTTM^SDUTL3(DFN) I $L(PR) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Current PC Team:       "_$P(PR,"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",21,0)
 .Q
"RTN","GMRCSLM2",22,0)
 N VAIN,VAEL
"RTN","GMRCSLM2",23,0)
 D INP^VADPT S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Current Pat. Status:   "_$S(+VAIN(8):"Inpatient",1:"Outpatient"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",24,0)
 I $D(VAIN(4)),$L($P(VAIN(4),"^",2)) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Ward:"_$E(TAB,1,18)_$P(VAIN(4),"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",25,0)
 D ELIG^VADPT
"RTN","GMRCSLM2",26,0)
 I $L($P(VAEL(1),"^",2)) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Primary Eligibility:"_$E(TAB,1,11)_$P(VAEL(1),"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",27,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",28,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Order Information",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",29,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="To Service:"_$E(TAB,1,12)_$P($G(^GMR(123.5,+$P(GMRCO(0),"^",5),0)),"^"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",30,0)
 I $P(GMRCO(0),"^",11) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Attention:"_$E(TAB,1,13)_$P($G(^VA(200,$P(GMRCO(0),"^",11),0)),"^"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",31,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="From Service:"_$E(TAB,1,10)_$P($G(^SC(+$P(GMRCO(0),"^",6),0)),"^"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",32,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Requesting Provider: "_$E(TAB,1,2)_$S($P(GMRCO(0),"^",14)]"":$P($G(^VA(200,$P(GMRCO(0),"^",14),0)),"^",1),1:""),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",33,0)
 I $L($P(GMRCO(0),"^",18)) D
"RTN","GMRCSLM2",34,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Service is to be rendered on an "_$S($P(GMRCO(0),"^",18)="I":"INPATIENT",1:"OUTPATIENT")_" basis",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",35,0)
 .Q
"RTN","GMRCSLM2",36,0)
 I $P(GMRCO(0),"^",10) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Place:"_$E(TAB,1,17)_$P($G(^ORD(101,+$P(GMRCO(0),"^",10),0)),"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",37,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Urgency:"_$E(TAB,1,15)_$S($L($P(GMRCO(0),"^",9)):$P($G(^ORD(101,+$P(GMRCO(0),"^",9),0)),"^",2),1:""),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",38,0)
 S X="ORX8" X ^%ZOSF("TEST") I  D
"RTN","GMRCSLM2",39,0)
 .N GMRCOITM S GMRCOITM=$$OI^ORX8(ORIFN)
"RTN","GMRCSLM2",40,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Orderable Item:"_$E(TAB,1,8)_$P(GMRCOITM,U,2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",41,0)
 .Q
"RTN","GMRCSLM2",42,0)
 S GMRCPRNM=$P(GMRCO(0),"^",8),GMRCPROC=$S(+GMRCPRNM:$P($G(^GMR(123.3,+GMRCPRNM,0)),"^"),1:"Consult Request")
"RTN","GMRCSLM2",43,0)
 I $L(GMRCPROC) D
"RTN","GMRCSLM2",44,0)
 .N GMRCLN
"RTN","GMRCSLM2",45,0)
 .S GMRCTYPE=$S($P(GMRCO(0),U,17)="P":"Procedure",1:"Consult")
"RTN","GMRCSLM2",46,0)
 .S GMRCLN=GMRCTYPE_":"_$E(TAB,1,22-$L(GMRCTYPE))_GMRCPROC
"RTN","GMRCSLM2",47,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCLN
"RTN","GMRCSLM2",48,0)
 .S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",49,0)
 .I $G(^GMR(123,+GMRCO,1)) D
"RTN","GMRCSLM2",50,0)
 .. S GMRCLN=""
"RTN","GMRCSLM2",51,0)
 .. S GMRCLN="Clinical Procedure:"_$E(TAB,1,4)
"RTN","GMRCSLM2",52,0)
 .. S GMRCLN=GMRCLN_$$GET1^DIQ(123,+GMRCO,1.01,"E")
"RTN","GMRCSLM2",53,0)
 .. S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCLN
"RTN","GMRCSLM2",54,0)
 .. S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",55,0)
 .Q
"RTN","GMRCSLM2",56,0)
 S GMRCD=$G(^GMR(123,+GMRCO,30)) I $L(GMRCD) D
"RTN","GMRCSLM2",57,0)
 . I $L(GMRCD)>54 D
"RTN","GMRCSLM2",58,0)
 .. N SEG,I S I=2
"RTN","GMRCSLM2",59,0)
 .. F  S SEG=$P(GMRCD," ",1,I) Q:$L(SEG)>54  S I=I+1
"RTN","GMRCSLM2",60,0)
 .. S SEG=$P(GMRCD," ",1,(I-1))
"RTN","GMRCSLM2",61,0)
 .. S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Provisional Diagnosis: "_SEG
"RTN","GMRCSLM2",62,0)
 .. S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",63,0)
 .. S SEG=$$REPEAT^XLFSTR(" ",22)_$E(GMRCD,$L(SEG)+1,80)
"RTN","GMRCSLM2",64,0)
 .. S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=SEG S GMRCD=""
"RTN","GMRCSLM2",65,0)
 .. S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",66,0)
 I GMRCD'="" D
"RTN","GMRCSLM2",67,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Provisional Diagnosis: "_GMRCD
"RTN","GMRCSLM2",68,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",69,0)
 I $D(^GMR(123,+GMRCO,20,0)) D
"RTN","GMRCSLM2",70,0)
 .I $O(^GMR(123,+GMRCO,20,0)) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Reason For Request:",GMRCCT=GMRCCT+1 D  Q
"RTN","GMRCSLM2",71,0)
 ..S LN=0 F  S LN=$O(^GMR(123,+GMRCO,20,LN)) Q:LN=""  S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=^(LN,0),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",72,0)
 ..Q
"RTN","GMRCSLM2",73,0)
 .Q
"RTN","GMRCSLM2",74,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=" ",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",75,0)
 ;get status, last action, and significant findings
"RTN","GMRCSLM2",76,0)
 S STS=$P(GMRCO(0),"^",12),^TMP("GMRCR",$J,"DT",GMRCCT,0)="Status:  "_$E(TAB,1,14)_$S($D(^ORD(100.01,+STS,0)):$P(^(0),"^",1),1:$P(^ORD(100.01,6,0),"^",1)),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",77,0)
 S GMRCA=$P(^GMR(123,+GMRCO,0),"^",13),^TMP("GMRCR",$J,"DT",GMRCCT,0)="Last Action:"_$E(TAB,1,11)_$S(+GMRCA:$P($G(^GMR(123.1,GMRCA,0)),"^",1),1:""),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",78,0)
 I $L($P(GMRCO(0),"^",19)) D
"RTN","GMRCSLM2",79,0)
 .S GMRCSF=$P(GMRCO(0),"^",19)
"RTN","GMRCSLM2",80,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Significant Findings:  "_$S(GMRCSF="Y":"YES",GMRCSF="N":"NO",1:"Unknown")
"RTN","GMRCSLM2",81,0)
 .S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",82,0)
 .Q
"RTN","GMRCSLM2",83,0)
 D ACTLOG^GMRCSLM4(+GMRCO)
"RTN","GMRCSLM2",84,0)
 ;get results
"RTN","GMRCSLM2",85,0)
 D GETRSLT^GMRCART($NA(^TMP("GMRCRT",$J)))
"RTN","GMRCSLM2",86,0)
 N NXT S NXT=0
"RTN","GMRCSLM2",87,0)
 F  S NXT=$O(^TMP("GMRCRT",$J,NXT)) Q:'NXT  D
"RTN","GMRCSLM2",88,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$G(^TMP("GMRCRT",$J,NXT,0))
"RTN","GMRCSLM2",89,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",90,0)
 . Q
"RTN","GMRCSLM2",91,0)
 K ^TMP("GMRCRT",$J)
"RTN","GMRCSLM2",92,0)
 I $S('$D(GMRCOER):1,'GMRCOER:1,1:0),$D(VALMAR) D CLEAN^VALM10
"RTN","GMRCSLM2",93,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",$P(^(0),"=",80)="",^(0)=$E(^(0),1,36)_" END "_$E(^(0),43,80)
"RTN","GMRCSLM2",94,0)
DTQ K X,LN,PL,TO,WP,FLG,SEX,STS,URG,WRD,BKLN,DATA,WRD,PROC,LINE,GMRC(0),GMRC(40),GMRCD,GMRCDVDL,GMRCO,GMRCAR,GMRCRB,GMRCLA,GMRCSR,GMRCTO,MCFILE,MCPROC,DSPLINE,GMRCLA1,GMRCPRNM,GMRCPROC,GMRCTYPE,GMRCWARD
"RTN","GMRCSLM2",95,0)
 I $D(GMRCOER),'GMRCOER D:$D(VALMEVL) KILL^VALM10() D:$D(VALMAR) CLEAN^VALM10
"RTN","GMRCSLM2",96,0)
 Q
"RTN","GMRCTIU")
0^3^B16136277
"RTN","GMRCTIU",1,0)
GMRCTIU ;SLC/DCM - Consults - TIU utilities ;3/14/01 22:30
"RTN","GMRCTIU",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,12,18,15,17**;DEC 27, 1997
"RTN","GMRCTIU",3,0)
 ;
"RTN","GMRCTIU",4,0)
 ; This routine invokes IA #2427,#2638,#2832,#3161
"RTN","GMRCTIU",5,0)
 ;
"RTN","GMRCTIU",6,0)
GET(GMRCO,GMRCTUFN,GMRCTUST,GMRCAUTH) ;update Consult from TIU 
"RTN","GMRCTIU",7,0)
 ;GMRCO=IFN from file 123
"RTN","GMRCTIU",8,0)
 ;GMRCTUFN=TIU IFN
"RTN","GMRCTIU",9,0)
 ;GMRCTUST=TIU status of report
"RTN","GMRCTIU",10,0)
 ;GMRCAUTH=Author of Document
"RTN","GMRCTIU",11,0)
 N GMRCA,GMRCSTS,GMRCDFN,GMRCAD
"RTN","GMRCTIU",12,0)
 S GMRCA=$S($G(GMRCTUST)["INCOMPLETE":9,1:10),GMRCSTS=$S(GMRCA=10:2,1:9)
"RTN","GMRCTIU",13,0)
 I '+$G(GMRCA) S GMRCA=99,GMRCSTS=99
"RTN","GMRCTIU",14,0)
 D:+$G(GMRCA) STATUS^GMRCTIU1
"RTN","GMRCTIU",15,0)
 K GMRCOM,GMRCND,GMRCORNP,GMRCORTX,GMRCSA,GMRCSTS
"RTN","GMRCTIU",16,0)
 Q
"RTN","GMRCTIU",17,0)
 ;
"RTN","GMRCTIU",18,0)
DSPLAY(GMRCTUFN,LINECT) ;Get TIU results narrative and get it ready for display
"RTN","GMRCTIU",19,0)
 ;GMRCTUFN=TIU IEN of results record
"RTN","GMRCTIU",20,0)
 ;LINECT=line count for list manager
"RTN","GMRCTIU",21,0)
 N ND,GMRCARR
"RTN","GMRCTIU",22,0)
 D RPC^TIUSRV(.GMRCARR,GMRCTUFN)
"RTN","GMRCTIU",23,0)
 S ND=0
"RTN","GMRCTIU",24,0)
 F  S ND=$O(@GMRCARR@(ND)) Q:ND=""  S ^TMP("GMRCR",$J,"DT",LINECT,0)=@GMRCARR@(ND,0),LINECT=LINECT+1
"RTN","GMRCTIU",25,0)
 ;D CLEAN^VALM10
"RTN","GMRCTIU",26,0)
 K @GMRCARR,RESFL,GMRCTIUY
"RTN","GMRCTIU",27,0)
 S:LINECT>1 LINECT=LINECT-1
"RTN","GMRCTIU",28,0)
 Q
"RTN","GMRCTIU",29,0)
ENTER(GMRCO) ; Complete a consult with TIU note
"RTN","GMRCTIU",30,0)
 N XQADATA,XQA,XQAID,XQAROU,XQFLG,XQAKILL
"RTN","GMRCTIU",31,0)
 D ENTER^GMRCTIUE(GMRCO)
"RTN","GMRCTIU",32,0)
 Q
"RTN","GMRCTIU",33,0)
 ;
"RTN","GMRCTIU",34,0)
ADDEND(GMRCO) ; Make an addendum to a consult result
"RTN","GMRCTIU",35,0)
 N XQADATA,XQA,XQAID,XQAROU,XQFLG,XQAKILL
"RTN","GMRCTIU",36,0)
 D ADDEND^GMRCTIUE(GMRCO)
"RTN","GMRCTIU",37,0)
 Q
"RTN","GMRCTIU",38,0)
 ;
"RTN","GMRCTIU",39,0)
SEND(DFN,OVRRIDE,CP) ;Get consult list and return in ^TMP for TIU
"RTN","GMRCTIU",40,0)
 ;DFN=Patient's Internal file number from file 2
"RTN","GMRCTIU",41,0)
 ;OVRRIDE=BOOLEAN flag to override user validation
"RTN","GMRCTIU",42,0)
 ;CP=2 if only return entries that may have CP docs attached
"RTN","GMRCTIU",43,0)
 ;
"RTN","GMRCTIU",44,0)
 N GMRCI,TAB
"RTN","GMRCTIU",45,0)
 Q:DFN=""!(DFN<1)
"RTN","GMRCTIU",46,0)
 S TAB="",$P(TAB," ",30)=""
"RTN","GMRCTIU",47,0)
 K ^TMP("GMRCR",$J,"TIU")
"RTN","GMRCTIU",48,0)
 D GETCONSL(DFN,2,$G(OVRRIDE),$G(CP)) ;2=returns TIU format in ^TMP
"RTN","GMRCTIU",49,0)
 Q
"RTN","GMRCTIU",50,0)
 ;
"RTN","GMRCTIU",51,0)
RPCLIST(GMRCY,DFN) ;Get consult list and return in GMRCY for GUI
"RTN","GMRCTIU",52,0)
 N GMRCI
"RTN","GMRCTIU",53,0)
 I '+$G(DFN) S GMRCY(0)=0
"RTN","GMRCTIU",54,0)
 D GETCONSL(DFN,1) ;1=returns GUI format in GMRCY array
"RTN","GMRCTIU",55,0)
 ; The consults will be returned from GETCONSL in the GMRCY array.
"RTN","GMRCTIU",56,0)
 S GMRCY(0)=+$G(GMRCI)
"RTN","GMRCTIU",57,0)
 Q
"RTN","GMRCTIU",58,0)
GETCONSL(DFN,ORIGIN,OVRRIDE,GMRCCP) ;Get the patients consults
"RTN","GMRCTIU",59,0)
 ;ORIGIN is whether the request is for GUI=1 or LM=2.
"RTN","GMRCTIU",60,0)
 ;The logic loops through the "AD" cross-reference to find consults
"RTN","GMRCTIU",61,0)
 ;The output will be formatted in GMRCY for the GUI if ORIGIN is 1.
"RTN","GMRCTIU",62,0)
 ;The output will be formatted in ^TMP("GMRCR",$J,"TIU" if ORIGIN is 2.
"RTN","GMRCTIU",63,0)
 ;GMRCCP = 1 = return only CP entries that can have CP doc attached
"RTN","GMRCTIU",64,0)
 ;
"RTN","GMRCTIU",65,0)
 N GMRCQIT,GMRC,GMRCDA,GMRCDT,GMRCEDT,GMRCYR,GMRCSP,GMRCST,GMRCSTS
"RTN","GMRCTIU",66,0)
 N GMRCTIU,GMRCTIUC,GMRCSS,GMRCSVC,GMRCPROC,GMRCNOTE,Y,GMRCDAT,GMRAU
"RTN","GMRCTIU",67,0)
 ;
"RTN","GMRCTIU",68,0)
 ; Aug 2000 - MA changed routine to use Parameter global to set the
"RTN","GMRCTIU",69,0)
 ; number of days to look backward when getting a list of consults.
"RTN","GMRCTIU",70,0)
 S GMRCYR=$$FMADD^XLFDT(DT,-$$GET^XPAR("ALL","GMRC CONSULT LIST DAYS"))
"RTN","GMRCTIU",71,0)
 S GMRCYR=9999999-GMRCYR,GMRCDAT=0
"RTN","GMRCTIU",72,0)
 F  S GMRCDAT=$O(^GMR(123,"AD",DFN,GMRCDAT)) Q:'GMRCDAT!(GMRCDAT>GMRCYR)  D
"RTN","GMRCTIU",73,0)
 . S GMRCDA=0
"RTN","GMRCTIU",74,0)
 . F  S GMRCDA=$O(^GMR(123,"AD",DFN,GMRCDAT,GMRCDA)) Q:'GMRCDA  D
"RTN","GMRCTIU",75,0)
 .. S GMRC(0)=$G(^GMR(123,GMRCDA,0))
"RTN","GMRCTIU",76,0)
 .. S GMRCST=$P(GMRC(0),U,12)
"RTN","GMRCTIU",77,0)
 .. I "25689"'[GMRCST Q  ;only return statuses c,p,a,s,pr
"RTN","GMRCTIU",78,0)
 .. S GMRCDT=+GMRC(0)
"RTN","GMRCTIU",79,0)
 .. S GMRCSS=$P(GMRC(0),U,5)
"RTN","GMRCTIU",80,0)
 .. I '+$G(OVRRIDE) D  Q:'GMRCAU
"RTN","GMRCTIU",81,0)
 ... S GMRCAU=$$VALID^GMRCAU(GMRCSS,GMRCDA)
"RTN","GMRCTIU",82,0)
 ... I GMRCAU=3 S GMRCAU=0 ;exclude admin users
"RTN","GMRCTIU",83,0)
 .. I '$G(GMRCCP),+$G(^GMR(123,GMRCDA,1)) Q  ;no CP requests for CPRS
"RTN","GMRCTIU",84,0)
 .. I $G(GMRCCP),'+$G(^GMR(123,GMRCDA,1)) Q  ;only return CP requests 
"RTN","GMRCTIU",85,0)
 .. S GMRCTIUC=0
"RTN","GMRCTIU",86,0)
 .. D GETLIST^GMRCTIUL(GMRCDA,0,1,.GMRCTIUC)
"RTN","GMRCTIU",87,0)
 .. I ORIGIN=1 D BLDGMRCY Q
"RTN","GMRCTIU",88,0)
 .. I ORIGIN=2 D BLDTMP Q
"RTN","GMRCTIU",89,0)
 .. Q
"RTN","GMRCTIU",90,0)
 . Q
"RTN","GMRCTIU",91,0)
 Q
"RTN","GMRCTIU",92,0)
 ;
"RTN","GMRCTIU",93,0)
BLDGMRCY ;Build the GMRCY array of existing consults
"RTN","GMRCTIU",94,0)
 S GMRCSTS=$P($G(^ORD(100.01,+GMRCST,0)),"^",1)
"RTN","GMRCTIU",95,0)
 S GMRCSS=$P(GMRC(0),U,5),GMRCSVC=$P($G(^GMR(123.5,GMRCSS,0)),U)
"RTN","GMRCTIU",96,0)
 S GMRCPROC=$P($G(^GMR(123.3,+$P(GMRC(0),U,8),0)),U)
"RTN","GMRCTIU",97,0)
 S GMRCI=+$G(GMRCI)+1
"RTN","GMRCTIU",98,0)
 S GMRCY(GMRCI)=GMRCDA_U_GMRCDT_U_GMRCSVC_U_GMRCPROC_U_GMRCSTS_U_+GMRCTIUC(0)
"RTN","GMRCTIU",99,0)
 Q
"RTN","GMRCTIU",100,0)
BLDTMP ;Build TMP global for TIU
"RTN","GMRCTIU",101,0)
 S GMRCSTS=$G(^ORD(100.01,+GMRCST,.1))
"RTN","GMRCTIU",102,0)
 S GMRCSP=$$ORTX^GMRCAU(GMRCDA)
"RTN","GMRCTIU",103,0)
 S GMRCNOTE=$S(GMRCTIUC(0)=1:" note",1:" notes")
"RTN","GMRCTIU",104,0)
 S GMRCEDT=$$FMTE^XLFDT(GMRCDT,"D")
"RTN","GMRCTIU",105,0)
 S GMRCI=+$G(GMRCI)+1
"RTN","GMRCTIU",106,0)
 S ^TMP("GMRCR",$J,"TIU",GMRCI,0)=$J(GMRCI,3)_"> "_$E(GMRCEDT_TAB,1,12)_" C#"_$E(GMRCDA_TAB,1,9)_$E(GMRCSP_TAB,1,21)_$E(GMRCSTS_TAB,1,4)_$E(+GMRCTIUC(0)_GMRCNOTE_TAB,1,10)
"RTN","GMRCTIU",107,0)
 S ^TMP("GMRCR",$J,"TIU","B",GMRCI,GMRCDA)=""
"RTN","GMRCTIU",108,0)
 Q
"RTN","GMRCTIU1")
0^15^B25703402
"RTN","GMRCTIU1",1,0)
GMRCTIU1 ;SLC/JER - More CT/TIU interface modules ;9/18/01  14:32
"RTN","GMRCTIU1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,21,17**;DEC 27, 1997
"RTN","GMRCTIU1",3,0)
ROLLBACK(DA,TIUDA) ; Roll-back a CT record when result is deleted or
"RTN","GMRCTIU1",4,0)
 ;reassigned
"RTN","GMRCTIU1",5,0)
 ;Disassociate Note logic
"RTN","GMRCTIU1",6,0)
 ;The action removes the association of a TIU note with a consult.
"RTN","GMRCTIU1",7,0)
 ;The new CPRS status will change to "ACTIVE", unless one of the
"RTN","GMRCTIU1",8,0)
 ;remaining notes has a completed status. 
"RTN","GMRCTIU1",9,0)
 ;This action should send an alert to the service notification users.
"RTN","GMRCTIU1",10,0)
 N DIE,DR,GMRCSTS,GMRCA,GMRCO,GMRCOM,GMRCORNP,GMRCDFN,GMRCNODE,GMRCLIST,GMRCD0,GMRCD1,GMRCSF,GMRCADUZ,MSGTOSRV,GMRCATX,GMRCORTX
"RTN","GMRCTIU1",11,0)
 S GMRCNODE=$G(^GMR(123,+DA,0))
"RTN","GMRCTIU1",12,0)
 ; If current result has never been posted, no need to roll back
"RTN","GMRCTIU1",13,0)
 ; Patch GMRC*1*21
"RTN","GMRCTIU1",14,0)
 I '+$O(^GMR(123,+DA,50,"B",+TIUDA_";TIU(8925,",0)) Q
"RTN","GMRCTIU1",15,0)
 I ($P(GMRCNODE,U,20)=TIUDA) S DIE="^GMR(123,",DR="16///@" D ^DIE
"RTN","GMRCTIU1",16,0)
 S GMRCD0=DA,GMRCD1=0 F  S GMRCD1=$O(^GMR(123,GMRCD0,50,GMRCD1)) Q:'GMRCD1  D
"RTN","GMRCTIU1",17,0)
 .N DA,DIK
"RTN","GMRCTIU1",18,0)
 .Q:'(TIUDA=+$G(^GMR(123,GMRCD0,50,GMRCD1,0)))
"RTN","GMRCTIU1",19,0)
 .S DA(1)=GMRCD0,DA=GMRCD1
"RTN","GMRCTIU1",20,0)
 .S DIK="^GMR(123,"_DA(1)_",50,"
"RTN","GMRCTIU1",21,0)
 .D ^DIK
"RTN","GMRCTIU1",22,0)
 ;
"RTN","GMRCTIU1",23,0)
 S GMRCA=12,GMRCO=DA
"RTN","GMRCTIU1",24,0)
 D GETLIST^GMRCTIUL(DA,2,1,.GMRCLIST)
"RTN","GMRCTIU1",25,0)
 S GMRCSTS=9
"RTN","GMRCTIU1",26,0)
 I '$G(GMRCLIST(0)) S GMRCSTS=6
"RTN","GMRCTIU1",27,0)
 E  S GMRCD0="" F  S GMRCD0=$O(^TMP("GMRC50",$J,GMRCD0)) Q:'$L(GMRCD0)  D
"RTN","GMRCTIU1",28,0)
 .Q:(+GMRCD0=TIUDA)
"RTN","GMRCTIU1",29,0)
 .S GMRCD1=0 F  S GMRCD1=$O(^TMP("GMRC50",$J,GMRCD0,GMRCD1)) Q:'GMRCD1  D
"RTN","GMRCTIU1",30,0)
 ..S:($P($G(^TMP("GMRC50",$J,GMRCD0,GMRCD1)),U,6)="completed") GMRCSTS=2
"RTN","GMRCTIU1",31,0)
 Q:$G(NOSAVE)
"RTN","GMRCTIU1",32,0)
 D STATUS^GMRCP
"RTN","GMRCTIU1",33,0)
 K ^TMP("GMRC50",$J),^TMP("GMRC50R",$J)
"RTN","GMRCTIU1",34,0)
 ;
"RTN","GMRCTIU1",35,0)
 S GMRCOM=0,MSGTOSRV=0,GMRCRSLT=TIUDA_";TIU(8925," D AUDIT^GMRCP
"RTN","GMRCTIU1",36,0)
 ;
"RTN","GMRCTIU1",37,0)
 ;Build message information if status has changed or sig finding="Y"
"RTN","GMRCTIU1",38,0)
 S GMRCSF=$P(GMRCNODE,U,19)
"RTN","GMRCTIU1",39,0)
 I ($P(GMRCNODE,U,12)=$P($G(^GMR(123,GMRCO,0)),U,12)) D  Q:GMRCATX=""
"RTN","GMRCTIU1",40,0)
 . S GMRCATX="" Q:GMRCSF'="Y"
"RTN","GMRCTIU1",41,0)
 . S GMRCATX="*Removed consult note for "
"RTN","GMRCTIU1",42,0)
 E  S GMRCATX=$S((GMRCSF="Y"):"*",1:"")_"Reactivated consult, removed note for ",MSGTOSRV=1
"RTN","GMRCTIU1",43,0)
 S GMRCORNP=$P(GMRCNODE,U,14),GMRCDFN=$P(GMRCNODE,U,2)
"RTN","GMRCTIU1",44,0)
 S GMRCORTX=$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCTIU1",45,0)
 S GMRCORTX=GMRCATX_GMRCORTX
"RTN","GMRCTIU1",46,0)
 S:GMRCORNP GMRCADUZ(GMRCORNP)=""
"RTN","GMRCTIU1",47,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,23,.GMRCADUZ,MSGTOSRV)
"RTN","GMRCTIU1",48,0)
 Q:($P(GMRCNODE,U,12)=$P($G(^GMR(123,+GMRCO,0)),U,12))
"RTN","GMRCTIU1",49,0)
 ;
"RTN","GMRCTIU1",50,0)
 ;On status change, send "SC" (status change) HL7 msg to update order
"RTN","GMRCTIU1",51,0)
 D EN^GMRCHL7(GMRCDFN,+GMRCO,$G(GMRCTYPE),$G(GMRCRB),"SC",GMRCORNP,$G(GMRCVSIT),.GMRCOM)
"RTN","GMRCTIU1",52,0)
 Q
"RTN","GMRCTIU1",53,0)
 ;
"RTN","GMRCTIU1",54,0)
STATUS ;Update the status of a consult that has a TIU result
"RTN","GMRCTIU1",55,0)
 N GMRCAD,GMRCATX,GMRCOA,GMRCOSTS,GMRCOTFN,GMRC,GMRCSF,GMRCLAE,GMRCRSLT,GMRCADUZ,GMRCOADT
"RTN","GMRCTIU1",56,0)
 D GETOLD
"RTN","GMRCTIU1",57,0)
 S GMRCORNP=$G(GMRCAUTH) ;author
"RTN","GMRCTIU1",58,0)
 S GMRCRSLT=GMRCTUFN_";TIU(8925,"
"RTN","GMRCTIU1",59,0)
 ;
"RTN","GMRCTIU1",60,0)
 ;Evaluate whether a complete action is actually an addendum or New note
"RTN","GMRCTIU1",61,0)
 I GMRCA=10 S GMRCA=$$EVALACT(GMRCOSTS,+GMRCO,GMRCRSLT)
"RTN","GMRCTIU1",62,0)
 ;
"RTN","GMRCTIU1",63,0)
 ;Update the status and last activity field
"RTN","GMRCTIU1",64,0)
 ;Do not change the status if already completed
"RTN","GMRCTIU1",65,0)
 I GMRCOSTS=2,GMRCSTS=9 S GMRCSTS=2
"RTN","GMRCTIU1",66,0)
 D STATUS^GMRCP
"RTN","GMRCTIU1",67,0)
 ;
"RTN","GMRCTIU1",68,0)
 ;Update activity log
"RTN","GMRCTIU1",69,0)
 D AUDIT
"RTN","GMRCTIU1",70,0)
 ;
"RTN","GMRCTIU1",71,0)
 ;Update the last TIU entry modified and add result to result multiple
"RTN","GMRCTIU1",72,0)
 D ADD^GMRCTIUA(GMRCTUFN,GMRCO)
"RTN","GMRCTIU1",73,0)
 ;
"RTN","GMRCTIU1",74,0)
 ;Update order
"RTN","GMRCTIU1",75,0)
 S GMRCORNP=$P(^GMR(123,+GMRCO,0),"^",14)
"RTN","GMRCTIU1",76,0)
 D EN^GMRCHL7(GMRCDFN,+GMRCO,$G(GMRCTYPE),$G(GMRCRB),"RE",GMRCORNP,$G(GMRCVSIT),.GMRCOM)
"RTN","GMRCTIU1",77,0)
 ;
"RTN","GMRCTIU1",78,0)
 ;Send a message
"RTN","GMRCTIU1",79,0)
 I $$COMPLETE(GMRCA) D
"RTN","GMRCTIU1",80,0)
 . N GMRCDATA
"RTN","GMRCTIU1",81,0)
 . S GMRCATX=""
"RTN","GMRCTIU1",82,0)
 . I GMRCA=14 S GMRCATX="New Note for "
"RTN","GMRCTIU1",83,0)
 . I GMRCA=13 S GMRCATX="Addendum Added for "
"RTN","GMRCTIU1",84,0)
 . S GMRCATX=$S((GMRCSF="Y"):"*",1:"")_GMRCATX
"RTN","GMRCTIU1",85,0)
 . S GMRCORTX=GMRCATX_"Completed Consult "_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCTIU1",86,0)
 . S GMRCDATA=+GMRCO
"RTN","GMRCTIU1",87,0)
 . I $$PATCH^XPDUTL("OR*3.0*116") D  ;GUI v17 present
"RTN","GMRCTIU1",88,0)
 .. S GMRCDATA=GMRCDATA_"|"_$G(GMRCRSLT)
"RTN","GMRCTIU1",89,0)
 . I $P(GMRC(0),"^",14) S GMRCADUZ($P(GMRC(0),"^",14))=""
"RTN","GMRCTIU1",90,0)
 . D MSG^GMRCP(GMRCDFN,GMRCORTX,GMRCDATA,23,.GMRCADUZ,0)
"RTN","GMRCTIU1",91,0)
 . Q
"RTN","GMRCTIU1",92,0)
 Q
"RTN","GMRCTIU1",93,0)
 ;
"RTN","GMRCTIU1",94,0)
GETOLD ;save the old values of status, and the last activity data
"RTN","GMRCTIU1",95,0)
 ;to determine how to update status and TIU activity log
"RTN","GMRCTIU1",96,0)
 S GMRC(0)=$G(^GMR(123,+GMRCO,0))
"RTN","GMRCTIU1",97,0)
 S GMRCDFN=$P(GMRC(0),"^",2)
"RTN","GMRCTIU1",98,0)
 S GMRCSF=$P(GMRC(0),U,19)
"RTN","GMRCTIU1",99,0)
 S GMRCOSTS=$P(GMRC(0),"^",12) ;status before activity
"RTN","GMRCTIU1",100,0)
 S GMRCLAE=+$P($G(^GMR(123,+GMRCO,40,0)),U,3) ;last activity entry
"RTN","GMRCTIU1",101,0)
 S GMRC(40)=$G(^GMR(123,+GMRCO,40,+GMRCLAE,0))
"RTN","GMRCTIU1",102,0)
 S GMRCOADT=+$P(GMRC(40),U,1) ;last activity entry date
"RTN","GMRCTIU1",103,0)
 S GMRCOA=$P(GMRC(40),"^",2) ;last activity
"RTN","GMRCTIU1",104,0)
 S GMRCOTFN=$P(GMRC(40),"^",9) ;last result
"RTN","GMRCTIU1",105,0)
 Q
"RTN","GMRCTIU1",106,0)
 ;
"RTN","GMRCTIU1",107,0)
AUDIT ;Determine appropriate update activity.
"RTN","GMRCTIU1",108,0)
 ;Quit if new activity is same as previous "Incomplete Rpt" activity
"RTN","GMRCTIU1",109,0)
 I GMRCOTFN=GMRCRSLT,GMRCOA=9,GMRCOA=GMRCA,GMRCOSTS=GMRCSTS Q
"RTN","GMRCTIU1",110,0)
 ;
"RTN","GMRCTIU1",111,0)
 S GMRCOM=0
"RTN","GMRCTIU1",112,0)
 S GMRCDT=$$NOW^XLFDT
"RTN","GMRCTIU1",113,0)
 ;Check for overwrite of incomplete rpt activity if the new
"RTN","GMRCTIU1",114,0)
 ;activity occurs within 15 minutes of the last.
"RTN","GMRCTIU1",115,0)
 S GMRCOADT=$$FMADD^XLFDT(GMRCOADT,0,0,15)
"RTN","GMRCTIU1",116,0)
 I GMRCOTFN=GMRCRSLT,GMRCOA=9,$$COMPLETE(GMRCA),GMRCDT<GMRCOADT D AUDIT1 Q
"RTN","GMRCTIU1",117,0)
 D AUDIT^GMRCP Q
"RTN","GMRCTIU1",118,0)
 Q
"RTN","GMRCTIU1",119,0)
 ;
"RTN","GMRCTIU1",120,0)
AUDIT1 ;overwrite last activity
"RTN","GMRCTIU1",121,0)
 L +^GMR(123,+GMRCO,40):5 I '$T S GMRCUT=1,GMRCERR=1,GMRCERMS="Activity Trail Not filed - Consult In Use By Another User." L -^GMR(123,+GMRCO,40)  Q
"RTN","GMRCTIU1",122,0)
 S DA=$P(^GMR(123,+GMRCO,40,0),"^",3)
"RTN","GMRCTIU1",123,0)
 D AUDIT1^GMRCP
"RTN","GMRCTIU1",124,0)
 Q
"RTN","GMRCTIU1",125,0)
 ;
"RTN","GMRCTIU1",126,0)
COMPLETE(GMRCA) ;Determine if the action is a complete action (10,13,14)
"RTN","GMRCTIU1",127,0)
 Q $S(GMRCA=13:1,GMRCA=14:1,GMRCA=10:1,1:0)
"RTN","GMRCTIU1",128,0)
 ;
"RTN","GMRCTIU1",129,0)
EVALACT(GMRCOSTS,GMRCO,GMRCRSLT) ;Evaluate complete action based on prev results and sts
"RTN","GMRCTIU1",130,0)
 N EVALA,GMRCLAE
"RTN","GMRCTIU1",131,0)
 I '$D(^GMR(123,+GMRCO,50)) Q 10
"RTN","GMRCTIU1",132,0)
 I GMRCOSTS'=2 Q 10
"RTN","GMRCTIU1",133,0)
 I '$D(^GMR(123,+GMRCO,50,"B",GMRCRSLT)) Q 14
"RTN","GMRCTIU1",134,0)
 S EVALA=0,GMRCLAE=+$P($G(^GMR(123,+GMRCO,40,0)),U,3)+1
"RTN","GMRCTIU1",135,0)
 F  S GMRCLAE=$O(^GMR(123,+GMRCO,40,GMRCLAE),-1) Q:'GMRCLAE  D  Q:+EVALA
"RTN","GMRCTIU1",136,0)
 . S GMRCLAE(40)=^GMR(123,+GMRCO,40,GMRCLAE,0)
"RTN","GMRCTIU1",137,0)
 . I $P(GMRCLAE(40),U,9)=GMRCRSLT D
"RTN","GMRCTIU1",138,0)
 .. I $P(GMRCLAE(40),U,2)=9 S EVALA=14 Q
"RTN","GMRCTIU1",139,0)
 .. I $$COMPLETE($P(GMRCLAE(40),U,2)) S EVALA=13 Q
"RTN","GMRCTIU1",140,0)
 I +EVALA Q EVALA
"RTN","GMRCTIU1",141,0)
 Q 10
"RTN","GMRCTIU1",142,0)
 ;
"RTN","GMRCTIUE")
0^2^B57975134
"RTN","GMRCTIUE",1,0)
GMRCTIUE ;SLC/DCM,DLT,JFR - Complete/Update TIU notes ;10/09/01  23:10
"RTN","GMRCTIUE",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,10,14,12,15,17**;DEC 27, 1997
"RTN","GMRCTIUE",3,0)
 ;
"RTN","GMRCTIUE",4,0)
 ; This routine invokes IA #2410,#2694,#2833,#2699,#2700
"RTN","GMRCTIUE",5,0)
 ;
"RTN","GMRCTIUE",6,0)
 Q
"RTN","GMRCTIUE",7,0)
ENTER(GMRCO) ; Enter a note in TIU for the consult result
"RTN","GMRCTIUE",8,0)
 ;If consult from list is defined in GMRCO, then use it.
"RTN","GMRCTIUE",9,0)
 K GMRCQUT N TIUDA,TIUCLASS,GMRCLCK
"RTN","GMRCTIUE",10,0)
 N GMRCMC
"RTN","GMRCTIUE",11,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)
"RTN","GMRCTIUE",12,0)
 Q:$D(GMRCQUT)!'$L($G(GMRCO))
"RTN","GMRCTIUE",13,0)
 I '$$LOCK^GMRCA1(GMRCO) D EDEX Q
"RTN","GMRCTIUE",14,0)
 S GMRCLCK=1
"RTN","GMRCTIUE",15,0)
 D CHKSTS I $G(GMRCQUT) D EDEX Q
"RTN","GMRCTIUE",16,0)
 I $D(VALM) D FULL^VALM1
"RTN","GMRCTIUE",17,0)
 ;
"RTN","GMRCTIUE",18,0)
 ; ***Insert logic for being admin and update user****
"RTN","GMRCTIUE",19,0)
 ;
"RTN","GMRCTIUE",20,0)
 ;Find out access if a Clinical Procedure request
"RTN","GMRCTIUE",21,0)
 N GMRCCP
"RTN","GMRCTIUE",22,0)
 S GMRCCP=$$CPACTM^GMRCCP(+GMRCO)
"RTN","GMRCTIUE",23,0)
 ;
"RTN","GMRCTIUE",24,0)
 ;If service administrative user, then use administrative complete logic
"RTN","GMRCTIUE",25,0)
 N GMRCAU
"RTN","GMRCTIUE",26,0)
 S GMRCAU=$$VALID^GMRCAU($P(^GMR(123,GMRCO,0),U,5))
"RTN","GMRCTIUE",27,0)
 I GMRCAU=3 D  Q
"RTN","GMRCTIUE",28,0)
 . I $P(^GMR(123,+GMRCO,0),U,12)'=2,'GMRCCP S GMRCMC=$$MED(GMRCO)
"RTN","GMRCTIUE",29,0)
 . I $G(GMRCMC),$P(^GMR(123,+GMRCO,0),U,12)=2 D EDEX Q
"RTN","GMRCTIUE",30,0)
 . W !,$$CJ^XLFSTR("- Proceeding with Administrative Complete -",80)
"RTN","GMRCTIUE",31,0)
 . D COMP^GMRCAAC(+GMRCO)
"RTN","GMRCTIUE",32,0)
 . D EDEX
"RTN","GMRCTIUE",33,0)
 ;
"RTN","GMRCTIUE",34,0)
 I GMRCAU=4 D  I $G(GMRCQIT)=1 D EDEX Q
"RTN","GMRCTIUE",35,0)
 . I $P(^GMR(123,+GMRCO,0),U,12)'=2,'GMRCCP S GMRCMC=$$MED(GMRCO)
"RTN","GMRCTIUE",36,0)
 . I $G(GMRCMC),$P(^GMR(123,+GMRCO,0),U,12)=2 Q
"RTN","GMRCTIUE",37,0)
 . S DIR(0)="YA",DIR("A")="Administratively complete this request? "
"RTN","GMRCTIUE",38,0)
 . D ^DIR I $D(DIRUT) S GMRCQIT=1 Q
"RTN","GMRCTIUE",39,0)
 . I Y<1 Q
"RTN","GMRCTIUE",40,0)
 . W !,$$CJ^XLFSTR("- Proceeding with Administrative Complete -",80)
"RTN","GMRCTIUE",41,0)
        . D COMP^GMRCAAC(+GMRCO) S GMRCQIT=1
"RTN","GMRCTIUE",42,0)
 . Q 
"RTN","GMRCTIUE",43,0)
 ;
"RTN","GMRCTIUE",44,0)
 ;Assume the user is a clinical user
"RTN","GMRCTIUE",45,0)
 I GMRCCP=0 S GMRCMC=$$MED(GMRCO) ;only go med if not a CP
"RTN","GMRCTIUE",46,0)
 ;If a Procedure, allow Medicine or fall through to a note
"RTN","GMRCTIUE",47,0)
 I $G(GMRCMC) D  I $G(GMRCQIT)=1 D EDEX Q
"RTN","GMRCTIUE",48,0)
 . N DUOUT,DTOUT,X,Y,DIR
"RTN","GMRCTIUE",49,0)
 . W !
"RTN","GMRCTIUE",50,0)
 . S DIR(0)="YA",DIR("B")="Y",DIR("A")="Continue with Note Entry? "
"RTN","GMRCTIUE",51,0)
 . D ^DIR I Y<1 S GMRCQIT=1
"RTN","GMRCTIUE",52,0)
 . W !
"RTN","GMRCTIUE",53,0)
 . Q
"RTN","GMRCTIUE",54,0)
 ;
"RTN","GMRCTIUE",55,0)
 ;Get list of notes If no new notes, add new then quit
"RTN","GMRCTIUE",56,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCTIUE",57,0)
 I $D(VALM) D FULL^VALM1
"RTN","GMRCTIUE",58,0)
 I '$$GETLIST(GMRCDFN,GMRCO,.GMRCTIUC) D  D EDEX Q
"RTN","GMRCTIUE",59,0)
 . I GMRCCP>1,GMRCCP'=4 D CPGUI Q
"RTN","GMRCTIUE",60,0)
 . D NEW
"RTN","GMRCTIUE",61,0)
 ;
"RTN","GMRCTIUE",62,0)
 ;If TIU Document already exists, use single record edit, and quit
"RTN","GMRCTIUE",63,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",64,0)
 I GMRCTIUC(GMRCVF)=1 D  Q
"RTN","GMRCTIUE",65,0)
 . I GMRCCP=3 D CPGUI Q  ;incomplete CP document, must go to GUI
"RTN","GMRCTIUE",66,0)
 . N DIR,X,Y,DTOUT,DUOUT
"RTN","GMRCTIUE",67,0)
 . D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",68,0)
 . S DIR(0)="YA",DIR("B")="Yes",DIR("A")="Edit/Review this note? "
"RTN","GMRCTIUE",69,0)
 . D ^DIR I Y>0 D
"RTN","GMRCTIUE",70,0)
 .. S GMRCTUFN=$$SINGLE(GMRCVF)
"RTN","GMRCTIUE",71,0)
 .. I +GMRCTUFN D EDITNOTE(GMRCTUFN)
"RTN","GMRCTIUE",72,0)
 . S DIR(0)="YA"
"RTN","GMRCTIUE",73,0)
 . S DIR("B")="No",DIR("A")="Would you like to enter a new note? "
"RTN","GMRCTIUE",74,0)
 . W ! D ^DIR I Y>0 D NEW
"RTN","GMRCTIUE",75,0)
 . D EDEX
"RTN","GMRCTIUE",76,0)
 . Q
"RTN","GMRCTIUE",77,0)
 ;
"RTN","GMRCTIUE",78,0)
 ;Show the list of multiple tiu results for selection
"RTN","GMRCTIUE",79,0)
 D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",80,0)
 ;
"RTN","GMRCTIUE",81,0)
 ;Select a note from the list and then get the TIU internal entry
"RTN","GMRCTIUE",82,0)
 S GMRCSELR=$$SELR^GMRCTIUL(.GMRCTIUC)
"RTN","GMRCTIUE",83,0)
 I $D(GMRCQUT) D EDEX Q
"RTN","GMRCTIUE",84,0)
 I '+(GMRCSELR) D  D EDEX Q
"RTN","GMRCTIUE",85,0)
 . ;didn't select existing note, allow a new entry
"RTN","GMRCTIUE",86,0)
 . N DIR,X,Y
"RTN","GMRCTIUE",87,0)
 . S DIR(0)="Y",DIR("A")="Would you like to enter a new note"
"RTN","GMRCTIUE",88,0)
 . S DIR("B")="N" D ^DIR
"RTN","GMRCTIUE",89,0)
 . I Y<1 K DTOUT,DUOUT,X,Y Q
"RTN","GMRCTIUE",90,0)
 . D NEW
"RTN","GMRCTIUE",91,0)
 S GMRCTUFN=$$GETTUFN(GMRCSELR)
"RTN","GMRCTIUE",92,0)
 ;
"RTN","GMRCTIUE",93,0)
 I +GMRCTUFN D EDITNOTE(GMRCTUFN)
"RTN","GMRCTIUE",94,0)
 ;
"RTN","GMRCTIUE",95,0)
 D EDEX
"RTN","GMRCTIUE",96,0)
 Q
"RTN","GMRCTIUE",97,0)
 ;
"RTN","GMRCTIUE",98,0)
MED(GMRCO) ;allow med results if appropriate
"RTN","GMRCTIUE",99,0)
 ;If a Procedure and setu properly, allow Medicine
"RTN","GMRCTIUE",100,0)
 N GMRCMED,GMRCQIT S GMRCMED=0
"RTN","GMRCTIUE",101,0)
 I $P(^GMR(123,+GMRCO,0),U,17)="P" D
"RTN","GMRCTIUE",102,0)
 . Q:'$P(^GMR(123.3,+$P(^GMR(123,+GMRCO,0),U,8),0),U,5)
"RTN","GMRCTIUE",103,0)
 . D FULL^VALM1
"RTN","GMRCTIUE",104,0)
 . N DIR,DIROUT,DTOUT,DUOUT,X,Y
"RTN","GMRCTIUE",105,0)
 . S DIR(0)="YA",DIR("B")="Y"
"RTN","GMRCTIUE",106,0)
 . S DIR("A",1)="  ",DIR("A")="Attach Medicine Results? "
"RTN","GMRCTIUE",107,0)
 . D ^DIR Q:Y<1
"RTN","GMRCTIUE",108,0)
 . K DIR
"RTN","GMRCTIUE",109,0)
 . S GMRCMED=1
"RTN","GMRCTIUE",110,0)
 . D ARMED^GMRCAR
"RTN","GMRCTIUE",111,0)
 Q GMRCMED
"RTN","GMRCTIUE",112,0)
 ;
"RTN","GMRCTIUE",113,0)
SAUSER() ; admin user?
"RTN","GMRCTIUE",114,0)
 N GMRCSS,GMRCADUS
"RTN","GMRCTIUE",115,0)
 S GMRCSS=+$P($G(^GMR(123,+GMRCO,0)),"^",5) Q:'+GMRCSS 0
"RTN","GMRCTIUE",116,0)
 I $D(^GMR(123.5,+$P($G(^GMR(123,+GMRCO,0)),"^",5),123.33,"B",DUZ)) Q 1
"RTN","GMRCTIUE",117,0)
 I '$L($TEXT(VALIDU^GMRCAU)) Q 0
"RTN","GMRCTIUE",118,0)
 S GMRCADUS=0
"RTN","GMRCTIUE",119,0)
 I $L($TEXT(VALIDU^GMRCAU)) D TEAM^GMRCAU(.GMRCADUS,123.34,DUZ)
"RTN","GMRCTIUE",120,0)
 Q +GMRCADUS
"RTN","GMRCTIUE",121,0)
 ;
"RTN","GMRCTIUE",122,0)
CHKSTS ;Check the order status before allowing entry of a note
"RTN","GMRCTIUE",123,0)
 N STATUS S STATUS=$P($G(^GMR(123,+GMRCO,0)),"^",12)
"RTN","GMRCTIUE",124,0)
 I $S(STATUS=1:1,STATUS=13:1,1:0) D
"RTN","GMRCTIUE",125,0)
 . W !,"This order has been "
"RTN","GMRCTIUE",126,0)
 . W $S(STATUS=1:"DISCONTINUED",1:"CANCELLED")
"RTN","GMRCTIUE",127,0)
 . W ".  A note cannot be entered."
"RTN","GMRCTIUE",128,0)
 . D PAUSE S GMRCQUT=1
"RTN","GMRCTIUE",129,0)
 Q
"RTN","GMRCTIUE",130,0)
 ;
"RTN","GMRCTIUE",131,0)
EDITNOTE(GMRCTUFN) ;use TIU LM for an existing note
"RTN","GMRCTIUE",132,0)
 I +$D(^TIU(8925,+GMRCTUFN,0)) D  Q
"RTN","GMRCTIUE",133,0)
 . D EXSTNOTE^TIUBR1(+GMRCDFN,+GMRCTUFN)
"RTN","GMRCTIUE",134,0)
 ;
"RTN","GMRCTIUE",135,0)
 ; link is missing
"RTN","GMRCTIUE",136,0)
 W !,"A note #"_+GMRCTUFN_" is linked to the consult,"
"RTN","GMRCTIUE",137,0)
 W !,"  but the note is no longer in TIU!"
"RTN","GMRCTIUE",138,0)
 D PAUSE
"RTN","GMRCTIUE",139,0)
 Q
"RTN","GMRCTIUE",140,0)
 ;
"RTN","GMRCTIUE",141,0)
SINGLE(GMRCVF) ;Get the single result entry from the list for the file type
"RTN","GMRCTIUE",142,0)
 N RSLT,GMRCVP
"RTN","GMRCTIUE",143,0)
 S RSLT="",GMRCVP=0
"RTN","GMRCTIUE",144,0)
 F  S RSLT=$O(^TMP("GMRC50",$J,RSLT)) Q:RSLT=""  D  Q:+GMRCVP
"RTN","GMRCTIUE",145,0)
 . I $P(RSLT,";",2)=GMRCVF S GMRCVP=RSLT
"RTN","GMRCTIUE",146,0)
 Q +GMRCVP
"RTN","GMRCTIUE",147,0)
 ;
"RTN","GMRCTIUE",148,0)
GETTUFN(GMRCSELR) ;Get the result entry from the selected entry
"RTN","GMRCTIUE",149,0)
 N RSLT
"RTN","GMRCTIUE",150,0)
 S RSLT=$O(^TMP("GMRC50R",$J,GMRCSELR,""))
"RTN","GMRCTIUE",151,0)
 Q RSLT
"RTN","GMRCTIUE",152,0)
 ;
"RTN","GMRCTIUE",153,0)
NEW ;Enter a new result through TIU if implemented or old Completion logic
"RTN","GMRCTIUE",154,0)
 S TIUCLASS=+$$CLASS(+$$CPACTM^GMRCCP(+GMRCO))
"RTN","GMRCTIUE",155,0)
 I TIUCLASS'>0 D  Q
"RTN","GMRCTIUE",156,0)
 . W !!,$C(7),"Consult Resulting through TIU is not yet implemented."
"RTN","GMRCTIUE",157,0)
 . W !,"Proceeding with Administrative Complete."
"RTN","GMRCTIUE",158,0)
 . D COMP^GMRCAAC(+GMRCO)
"RTN","GMRCTIUE",159,0)
 ;
"RTN","GMRCTIUE",160,0)
 N GMRCTIDA
"RTN","GMRCTIUE",161,0)
 D MAIN^TIUEDIT(TIUCLASS,.GMRCTIDA,GMRCDFN,"","","","",1)
"RTN","GMRCTIUE",162,0)
 ;
"RTN","GMRCTIUE",163,0)
 Q
"RTN","GMRCTIUE",164,0)
 ;
"RTN","GMRCTIUE",165,0)
CLASS(CPSTAT) ; Get TIU doc def for CONSULTS OR clinical procedures
"RTN","GMRCTIUE",166,0)
 N GMRCY,GMRCDTYP,ERR
"RTN","GMRCTIUE",167,0)
 I 'CPSTAT D
"RTN","GMRCTIUE",168,0)
 . S GMRCY=$$FIND1^DIC(8925.1,,"X","CONSULTS","B",,"ERR")
"RTN","GMRCTIUE",169,0)
 I '$D(GMRCY) D
"RTN","GMRCTIUE",170,0)
 . S GMRCY=$$FIND1^DIC(8925.1,,"X","CLINICAL PROCEDURES","B",,"ERR")
"RTN","GMRCTIUE",171,0)
 S GMRCDTYP=$$GET1^DIQ(8925.1,+GMRCY,.04,"I")
"RTN","GMRCTIUE",172,0)
 I +GMRCY>0,$S(GMRCDTYP="CL":0,GMRCDTYP="DC":0,1:1) S GMRCY=0
"RTN","GMRCTIUE",173,0)
 Q GMRCY
"RTN","GMRCTIUE",174,0)
 ;
"RTN","GMRCTIUE",175,0)
GETLIST(GMRCDFN,GMRCO,GMRCLIST) ;
"RTN","GMRCTIUE",176,0)
 ;
"RTN","GMRCTIUE",177,0)
 N GMRCVF
"RTN","GMRCTIUE",178,0)
 ;
"RTN","GMRCTIUE",179,0)
 D GETLIST^GMRCTIUL(GMRCO,2,1,.GMRCTIUC)
"RTN","GMRCTIUE",180,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",181,0)
 Q +$G(GMRCTIUC(GMRCVF))
"RTN","GMRCTIUE",182,0)
 ;
"RTN","GMRCTIUE",183,0)
ADDEND(GMRCO) ; Make an addendum action for a selected consult
"RTN","GMRCTIUE",184,0)
 N TIUDA,GMRCTX,GMRCDFN,GMRCADUZ,RSLTINFO,GMRCACT,GMRCTIUC
"RTN","GMRCTIUE",185,0)
 N GMRCLCK,RSLTIEN
"RTN","GMRCTIUE",186,0)
 K GMRCQUT
"RTN","GMRCTIUE",187,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)
"RTN","GMRCTIUE",188,0)
 Q:$D(GMRCQUT)!'+($G(GMRCO))
"RTN","GMRCTIUE",189,0)
 ;
"RTN","GMRCTIUE",190,0)
 ;If service administrative user, then QUIT.
"RTN","GMRCTIUE",191,0)
 I $$VALID^GMRCAU($P(^GMR(123,+GMRCO,0),U,5))=3 D  Q
"RTN","GMRCTIUE",192,0)
 . D EXAC^GMRCADC("You do not have the ability to edit this note.")
"RTN","GMRCTIUE",193,0)
 ;
"RTN","GMRCTIUE",194,0)
 ;Assume the user is a clinical user
"RTN","GMRCTIUE",195,0)
 ;
"RTN","GMRCTIUE",196,0)
 ;Get list of notes for this consult. if no notes, then quit.
"RTN","GMRCTIUE",197,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCTIUE",198,0)
 I '$$GETLIST(GMRCDFN,+GMRCO,.GMRCTIUC) D  Q
"RTN","GMRCTIUE",199,0)
 . W !,"This consult does not yet have an associated note."
"RTN","GMRCTIUE",200,0)
 . W !,"  Use the Complete action to enter a new note."
"RTN","GMRCTIUE",201,0)
 . D PAUSE,EDEX
"RTN","GMRCTIUE",202,0)
 ;
"RTN","GMRCTIUE",203,0)
 I '$$LOCK^GMRCA1(GMRCO) D EDEX Q
"RTN","GMRCTIUE",204,0)
 S GMRCLCK=1
"RTN","GMRCTIUE",205,0)
 ;If TIU Document already exists, use single record edit, and quit
"RTN","GMRCTIUE",206,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",207,0)
 I GMRCTIUC(GMRCVF)=1 D  D EDEX Q
"RTN","GMRCTIUE",208,0)
 . S GMRCTUFN=$$SINGLE(GMRCVF)
"RTN","GMRCTIUE",209,0)
 . Q:'+GMRCTUFN
"RTN","GMRCTIUE",210,0)
 . D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",211,0)
 . N GMRCVP,RSLTINFO,AUTHOR
"RTN","GMRCTIUE",212,0)
 . S GMRCVP=+GMRCTUFN_";"_GMRCVF
"RTN","GMRCTIUE",213,0)
 . S RSLTIEN=$O(^TMP("GMRC50",$J,GMRCVP,0))
"RTN","GMRCTIUE",214,0)
 . S RSLTINFO=$G(^TMP("GMRC50",$J,GMRCVP,RSLTIEN))
"RTN","GMRCTIUE",215,0)
 . I $P(RSLTINFO,"^",6)="completed" D ADDEND1(+GMRCTUFN) Q
"RTN","GMRCTIUE",216,0)
 . I (DUZ=+$P(RSLTINFO,"^",4)) D EDITNOTE(+GMRCTUFN) Q
"RTN","GMRCTIUE",217,0)
 . W !,"You may not addend to the incomplete associated note."
"RTN","GMRCTIUE",218,0)
 . W !,"You are not the author of the existing note."
"RTN","GMRCTIUE",219,0)
 . I $$READ^GMRCACMT("Y","Do you want to add a new note ","YES") D NEW
"RTN","GMRCTIUE",220,0)
 . Q
"RTN","GMRCTIUE",221,0)
 ;
"RTN","GMRCTIUE",222,0)
 ;Show the list of multiple tiu results for selection
"RTN","GMRCTIUE",223,0)
 D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",224,0)
 ;
"RTN","GMRCTIUE",225,0)
 ;Select a note from the list and then get the TIU internal entry
"RTN","GMRCTIUE",226,0)
 S GMRCSELR=$$SELR^GMRCTIUL(.GMRCTIUC)
"RTN","GMRCTIUE",227,0)
 I $D(GMRCQUT)!'+(GMRCSELR) D EDEX Q
"RTN","GMRCTIUE",228,0)
 S GMRCTUFN=$$GETTUFN(GMRCSELR)
"RTN","GMRCTIUE",229,0)
 ;
"RTN","GMRCTIUE",230,0)
 I +GMRCTUFN D ADDEND1(+GMRCTUFN),EDEX Q
"RTN","GMRCTIUE",231,0)
 ;
"RTN","GMRCTIUE",232,0)
 D EDEX
"RTN","GMRCTIUE",233,0)
 Q
"RTN","GMRCTIUE",234,0)
ADDEND1(TIUDA) ;Add an addendum
"RTN","GMRCTIUE",235,0)
 ;
"RTN","GMRCTIUE",236,0)
 D FULL^VALM1,ADDEND1^TIURA1
"RTN","GMRCTIUE",237,0)
 Q
"RTN","GMRCTIUE",238,0)
 ;
"RTN","GMRCTIUE",239,0)
EDEX ;
"RTN","GMRCTIUE",240,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO)
"RTN","GMRCTIUE",241,0)
 K GMRCDFN,GMRCO,GMRCQUT,GMRCTUFN,GMRCSEL,GMRCQIT
"RTN","GMRCTIUE",242,0)
 Q
"RTN","GMRCTIUE",243,0)
 ;
"RTN","GMRCTIUE",244,0)
PAUSE ; Pause for user
"RTN","GMRCTIUE",245,0)
 ;
"RTN","GMRCTIUE",246,0)
 N X W !,"Press <RETURN> to continue: " R X:DTIME E  W " (timeout)"
"RTN","GMRCTIUE",247,0)
 Q
"RTN","GMRCTIUE",248,0)
 ;
"RTN","GMRCTIUE",249,0)
CPGUI ;it's GUI way or no way
"RTN","GMRCTIUE",250,0)
 N MSG
"RTN","GMRCTIUE",251,0)
 S MSG="You must use the CPRS GUI to complete this Clinical Procedure"
"RTN","GMRCTIUE",252,0)
 D EXAC^GMRCADC(MSG)
"RTN","GMRCTIUE",253,0)
 Q
"RTN","GMRCTIUP")
0^10^B17215428
"RTN","GMRCTIUP",1,0)
GMRCTIUP ;SLC/DCM,JFR - TIU/Consults UTILITIES; 4/4/01 15:01
"RTN","GMRCTIUP",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,13,15,17**;DEC 27, 1997
"RTN","GMRCTIUP",3,0)
 ;
"RTN","GMRCTIUP",4,0)
 ; This routine invokes IA #616,#2693
"RTN","GMRCTIUP",5,0)
 ;
"RTN","GMRCTIUP",6,0)
HDR(GMRCTUPR,GMRCGLB,COUNT,FROM) ;Get Source info for header of display
"RTN","GMRCTIUP",7,0)
 ;and place data in ^TMP( global. Do Not Show Any Results
"RTN","GMRCTIUP",8,0)
 ;GMRCTUPR=TIU record being sought
"RTN","GMRCTIUP",9,0)
 ;GMRCGLOB=Global where data goes - i.e., ^TMP("GMRCR",$J,"RES",GMRCPTR,"ADD",GMRCADD,LINECT,0)
"RTN","GMRCTIUP",10,0)
 ;COUNT=Count of where current line is to go in ^TMP( global
"RTN","GMRCTIUP",11,0)
 ;FROM=flag to tell whether to add Addendum TIU # or not 0=NO, Otherwise addendum number
"RTN","GMRCTIUP",12,0)
 N DR,GMRCTMP
"RTN","GMRCTIUP",13,0)
 S:'$D(FROM) FROM=""
"RTN","GMRCTIUP",14,0)
 S DR=".01;.05;.07;.09;1201;1202;1204;1205;1208;1301;1302",GMRCERR=""
"RTN","GMRCTIUP",15,0)
 D EXTRACT^TIULQ(GMRCPTR,"LOCAL",.GMRCERR,DR)
"RTN","GMRCTIUP",16,0)
 S @GMRCGLB@(COUNT,0)="",COUNT=COUNT+1
"RTN","GMRCTIUP",17,0)
 S @GMRCGLB@(COUNT,0)="Source Information",COUNT=COUNT+1,@GMRCGLB@(COUNT,0)=""
"RTN","GMRCTIUP",18,0)
 S @GMRCGLB@(COUNT,0)="  Document Status: "_LOCAL(GMRCPTR,.05,"E"),COUNT=COUNT+1
"RTN","GMRCTIUP",19,0)
 S @GMRCGLB@(COUNT,0)="       Entry Date: "_$P($G(LOCAL(GMRCPTR,1201,"E")),":",1,2),COUNT=COUNT+1
"RTN","GMRCTIUP",20,0)
 S @GMRCGLB@(COUNT,0)="            Visit: "_$G(LOCAL(GMRCPTR,.07,"E"))_"  "_$G(LOCAL(GMRCPTR,1205,"E"))
"RTN","GMRCTIUP",21,0)
 S COUNT=COUNT+1
"RTN","GMRCTIUP",22,0)
 S @GMRCGLB@(COUNT,0)="           Author: "_LOCAL(GMRCPTR,1202,"E")
"RTN","GMRCTIUP",23,0)
 S COUNT=COUNT+1
"RTN","GMRCTIUP",24,0)
 S @GMRCGLB@(COUNT,0)="  Expected Signer: "_$E(LOCAL(GMRCPTR,1204,"E")_TAB,1,22)_$E(TAB,1,5)_"Expected Cosigner: "_$S($L($G(LOCAL(GMRCPTR,1208,"E"))):LOCAL(GMRCPTR,1208,"E"),1:"None"),COUNT=COUNT+1
"RTN","GMRCTIUP",25,0)
 S @GMRCGLB@(COUNT,0)="       Entered By: "_$E(LOCAL(GMRCPTR,1302,"E")_TAB,1,30)_"TIU Document #: "_GMRCTUPR,COUNT=COUNT+1
"RTN","GMRCTIUP",26,0)
 S @GMRCGLB@(COUNT,0)=$S(+FROM:"  TIU Addendum Document #: "_FROM,1:"")_$S(+FROM:$E(TAB,1,10),1:"     ")_"     Urgency: "_$S($L($G(LOCAL(GMRCPTR,.09,"E"))):LOCAL(GMRCPTR,.09,"E"),1:"None"),COUNT=COUNT+1
"RTN","GMRCTIUP",27,0)
 S @GMRCGLB@(COUNT,0)="",COUNT=COUNT+1
"RTN","GMRCTIUP",28,0)
 K LOCAL
"RTN","GMRCTIUP",29,0)
 Q
"RTN","GMRCTIUP",30,0)
PRINT(GMRCO,LINECT,GMRCRT) ;get TIU results and prepare for the SF-513
"RTN","GMRCTIUP",31,0)
 ;GMRCRT=Flag from RT^GMRCA1 indicating that result request is from there
"RTN","GMRCTIUP",32,0)
 ; GMRCRT=0 means 'NO', 
"RTN","GMRCTIUP",33,0)
 ; GMRCRT=1 means 'YES" (and ES is appended to TIU main result); also, 
"RTN","GMRCTIUP",34,0)
 ;    No result is passed back to print on the 513 if GMRCRT=0.
"RTN","GMRCTIUP",35,0)
 ;GMRCTUFN=IEN of the TIU result from file 8925
"RTN","GMRCTIUP",36,0)
 ;GMRCSIG=signature block name of signer : GMRCSDT=date result was signed
"RTN","GMRCTIUP",37,0)
 ;GMRCSIGT=signers block title : GMRCTUFN=TIU IEN of the result record
"RTN","GMRCTIUP",38,0)
 ;GMRCCSIG=cosigners block name : GMRCCSDT=date cosigner signed
"RTN","GMRCTIUP",39,0)
 ;GMRCCTIT=cosigners block title : GMRCSIGM=Signature mode (E:ELECTRONIC/C:CHART)
"RTN","GMRCTIUP",40,0)
 N GMRCTUFN,TAB,GLOBAL
"RTN","GMRCTIUP",41,0)
 S:'$D(GMRCRT) GMRCRT=0
"RTN","GMRCTIUP",42,0)
 D GETRSLTS(GMRCO,.GMRCAR) ;I $D(GMRCQUT) D:$D(GMRCMSG) EXAC^GMRCADC(GMRCMSG) K GMRCMSG,GMRCRT Q
"RTN","GMRCTIUP",43,0)
 S GLOBAL="^TMP(""GMRCR"",$J,""GMRCTIU"")",TAB="",$P(TAB," ",31)=""
"RTN","GMRCTIUP",44,0)
 K ^TMP("GMRCR",$J,"RES"),^TMP("GMRCR",$J,"MCAR")
"RTN","GMRCTIUP",45,0)
 S (GMRCND,GMRCPTR)="" F  K @GLOBAL S GMRCND=$O(GMRCAR(GMRCND)) Q:GMRCND=""  S GMRCPKG=$P(GMRCND,";",2),GMRCPTR=$P(GMRCND,";",1) D
"RTN","GMRCTIUP",46,0)
 .I $E(GMRCPKG,1,3)="TIU" D
"RTN","GMRCTIUP",47,0)
 .. N GMRCTXT,GMRCPAR,GMRCACTN
"RTN","GMRCTIUP",48,0)
 .. D EXTRACT^TIULQ(GMRCPTR,"GMRCPAR",.GMRCERR,.06,"I")
"RTN","GMRCTIUP",49,0)
 .. I $D(GMRCAR(+$G(GMRCPAR(GMRCPTR,.06,"I"))_";TIU(8925,")) Q
"RTN","GMRCTIUP",50,0)
 .. S GMRCACTN=$S($G(GMRCRT):"VIEW",1:"PRINT RECORD")
"RTN","GMRCTIUP",51,0)
 .. D TGET^TIUSRVR1(.GMRCTXT,+GMRCPTR,GMRCACTN)
"RTN","GMRCTIUP",52,0)
 .. I $D(@(GMRCTXT)) M @GLOBAL@(GMRCPTR,"TEXT")=@GMRCTXT
"RTN","GMRCTIUP",53,0)
 .. K @GMRCTXT
"RTN","GMRCTIUP",54,0)
 .. I $O(@GLOBAL@(GMRCPTR,"TEXT",0)) D
"RTN","GMRCTIUP",55,0)
 ...S ND=0 F  S ND=$O(@GLOBAL@(GMRCPTR,"TEXT",ND)) Q:ND=""  D
"RTN","GMRCTIUP",56,0)
 ....S ^TMP("GMRCR",$J,"RES",GMRCPTR,"TEXT",LINECT,0)=@GLOBAL@(GMRCPTR,"TEXT",ND)
"RTN","GMRCTIUP",57,0)
 ....S LINECT=LINECT+1
"RTN","GMRCTIUP",58,0)
 ..Q
"RTN","GMRCTIUP",59,0)
 .I $E(GMRCPKG,1,4)="MCAR" S GMRCSR=GMRCND,MCFILE=$P(GMRCSR,";",2),MCFILE=$P(MCFILE,","),MCPROC=$O(^MCAR(697.2,"C",MCFILE,"")) Q:'MCPROC  D
"RTN","GMRCTIUP",60,0)
 ..S GMRCPRNM=$P(^MCAR(697.2,MCPROC,0),"^",8),ORIFN=$P(^GMR(123,GMRCO,0),"^",3),ORACTION=8,MCGLOBAL="^TMP(""GMRCR"",$J,""MCAR"","_GMRCPTR_")"
"RTN","GMRCTIUP",61,0)
 ..D EN^GMRCTIU3(GMRCO,ORIFN,MCGLOBAL,LINECT) K ^TMP("MC",$J)
"RTN","GMRCTIUP",62,0)
 ..Q
"RTN","GMRCTIUP",63,0)
 .Q
"RTN","GMRCTIUP",64,0)
 K DR,GLOBAL,GMRCSR,GMRCAR,GMRCPKG,GMRCPRNM,MCFILE,MCPROC,ORACTION,ORIFN,MCGLOBAL,ND,ND1
"RTN","GMRCTIUP",65,0)
 Q
"RTN","GMRCTIUP",66,0)
GETNOTE(GMRCO,FILE) ;Get the last result added to the record - this is found in $P(^(0),"^",20)
"RTN","GMRCTIUP",67,0)
 ;Function returns last note added to record.
"RTN","GMRCTIUP",68,0)
 ;If it does not contain the file pointer, it is assumed that
"RTN","GMRCTIUP",69,0)
 ;it pointed to the TIU file 8925
"RTN","GMRCTIUP",70,0)
 ;GMRCO=file 123 IEN
"RTN","GMRCTIUP",71,0)
 ;FILE='MCAR' to get last medicine result pointer
"RTN","GMRCTIUP",72,0)
 ;FILE='TIU' to get last TIU result pointer
"RTN","GMRCTIUP",73,0)
 N X,RSLT
"RTN","GMRCTIUP",74,0)
 S RSLT=999999,X=""
"RTN","GMRCTIUP",75,0)
 F  S RSLT=$O(^GMR(123,+GMRCO,50,RSLT),-1) Q:'RSLT  D  Q:+X
"RTN","GMRCTIUP",76,0)
 . I $G(^GMR(123,+GMRCO,50,RSLT,0))[FILE S X=^GMR(123,+GMRCO,50,RSLT,0)
"RTN","GMRCTIUP",77,0)
 Q X
"RTN","GMRCTIUP",78,0)
GETRSLTS(GMRCO,ARRAY) ;Get the results from record and return it in array 'ARRAY')
"RTN","GMRCTIUP",79,0)
 ;Looks for results in $P(^(0),"^",20),$P(^(0),"^",15) and Field 50 multiple
"RTN","GMRCTIUP",80,0)
 ;GMRCO=File 123 IEN
"RTN","GMRCTIUP",81,0)
 ;ARRAY=array to return results pointers in
"RTN","GMRCTIUP",82,0)
 ;ARRAY will be returned as ARRAY("IEN;FILE"), as e.g., "1289;^TIU(8925,"
"RTN","GMRCTIUP",83,0)
 N X
"RTN","GMRCTIUP",84,0)
 S X=$$GETNOTE(GMRCO,"TIU") I $L(X) S:$P(X,";",2)="" X=X_";TIU(8925," S ARRAY(X)=""
"RTN","GMRCTIUP",85,0)
 S X=$$GETNOTE(GMRCO,"MCAR") I $L(X) S ARRAY(X)=""
"RTN","GMRCTIUP",86,0)
 S X="" F  S X=$O(^GMR(123,GMRCO,50,"B",X)) Q:X?1A.E!(X="")  S ARRAY(X)=""
"RTN","GMRCUTL1")
0^12^B13566722
"RTN","GMRCUTL1",1,0)
GMRCUTL1 ;SLC/DCM,JFR,MA - General Utilities ;8/15/01  11:49
"RTN","GMRCUTL1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,12,15,21,17**;DEC 27, 1997
"RTN","GMRCUTL1",3,0)
 ;
"RTN","GMRCUTL1",4,0)
 ; This routine invokes IA #2876,3121
"RTN","GMRCUTL1",5,0)
 ; Patch #21 added variable GMRCAUDT and moved line tag PRNTAUDT
"RTN","GMRCUTL1",6,0)
 ; to GMRCP5A.
"RTN","GMRCUTL1",7,0)
 ;
"RTN","GMRCUTL1",8,0)
ACTM ;;Set correct variables to complete, discontinue, etc. a consult
"RTN","GMRCUTL1",9,0)
 K GMRCQUT
"RTN","GMRCUTL1",10,0)
 S:'+$G(GMRCA) GMRCA=$O(^GMR(123.1,"B",GMRCACTM,""))
"RTN","GMRCUTL1",11,0)
 S GMRCACTM=$P($G(^GMR(123.1,+GMRCA,0)),"^")
"RTN","GMRCUTL1",12,0)
 S ORSTS=$S(GMRCA:$P(^GMR(123.1,GMRCA,0),"^",2),1:0)
"RTN","GMRCUTL1",13,0)
 I 'GMRCA S GMRCQUT=1
"RTN","GMRCUTL1",14,0)
 Q
"RTN","GMRCUTL1",15,0)
PRNT(SRVCIFN,GMRCO) ;print form 513 to a printer when new consult is entered
"RTN","GMRCUTL1",16,0)
 N ORVP,GMRCDEV,GMRCQUED,IOP,%ZIS,POP,ZTDTH,ZTDESC,ZTIO,ZTRTN,ZTSK,GMRCAUDT
"RTN","GMRCUTL1",17,0)
 I '$G(SRVCIFN) S SRVCIFN=+$P(^GMR(123,GMRCO,0),U,5)
"RTN","GMRCUTL1",18,0)
 Q:'$D(^GMR(123.5,SRVCIFN,123))  Q:'$P(^GMR(123.5,SRVCIFN,123),"^",9)
"RTN","GMRCUTL1",19,0)
 S IOP="`"_$P(^GMR(123.5,SRVCIFN,123),"^",9)
"RTN","GMRCUTL1",20,0)
 S %ZIS="N" D ^%ZIS I POP D HOME^%ZIS Q
"RTN","GMRCUTL1",21,0)
 S GMRCDEV=ION,GMRCQUED=1,GMRCAUDT=1
"RTN","GMRCUTL1",22,0)
 S ZTRTN="PRNT^GMRCP5A("_(+GMRCO)_","_(+$G(TIUFLG))_",1,"""_$G(GMRCCPY,"W")_""",0,"_(GMRCAUDT)_")"
"RTN","GMRCUTL1",23,0)
 S ZTDESC="CONSULT/REQUEST PACKAGE PRINT FORM 513 FOR NEW CONSULT"
"RTN","GMRCUTL1",24,0)
 S ZTIO=GMRCDEV,ZTDTH=$H
"RTN","GMRCUTL1",25,0)
 D ^%ZTLOAD
"RTN","GMRCUTL1",26,0)
 D HOME^%ZIS
"RTN","GMRCUTL1",27,0)
 K GMRCQUED,GMRCDEV1
"RTN","GMRCUTL1",28,0)
 Q
"RTN","GMRCUTL1",29,0)
END K GMRCDEV,GMRCDEV1,GMRCOREC,GMRCFMT
"RTN","GMRCUTL1",30,0)
 Q
"RTN","GMRCUTL1",31,0)
PROVDX(OI) ;return PROV DX prompting info from 123.5
"RTN","GMRCUTL1",32,0)
 ;    Input:
"RTN","GMRCUTL1",33,0)
 ;       OI = ref to file 123.5("#;99CON") or file 123.3 (#;99PRC)
"RTN","GMRCUTL1",34,0)
 ;
"RTN","GMRCUTL1",35,0)
 ;    Returns:  string  A^B
"RTN","GMRCUTL1",36,0)
 ;       A = O (optional), R (required) or S (suppress)
"RTN","GMRCUTL1",37,0)
 ;       B = F (free-text) or L (lexicon)
"RTN","GMRCUTL1",38,0)
 ;
"RTN","GMRCUTL1",39,0)
 N GMRCFIL
"RTN","GMRCUTL1",40,0)
 Q:'+$G(OI) "^"
"RTN","GMRCUTL1",41,0)
 S GMRCFIL=$S(OI["99PRC":123.3,1:123.5)
"RTN","GMRCUTL1",42,0)
 Q:'$D(^GMR(GMRCFIL,+OI)) "^"
"RTN","GMRCUTL1",43,0)
 N STRING,NODE
"RTN","GMRCUTL1",44,0)
 I GMRCFIL=123.3 S NODE=$P(^GMR(123.3,+OI,0),U,7,8)
"RTN","GMRCUTL1",45,0)
 I GMRCFIL=123.5 S NODE=$P($G(^GMR(123.5,+OI,1)),U,1,2)
"RTN","GMRCUTL1",46,0)
 I NODE="" Q "O^F" ;values not set
"RTN","GMRCUTL1",47,0)
 S $P(STRING,U)=$S($L($P(NODE,U)):$P(NODE,U),1:"O")
"RTN","GMRCUTL1",48,0)
 S $P(STRING,U,2)=$S($L($P(NODE,U,2)):$P(NODE,U,2),1:"F")
"RTN","GMRCUTL1",49,0)
 Q STRING
"RTN","GMRCUTL1",50,0)
ORIFN(GMRC123) ;return ORIFN associated with give record in ^GMR(123,
"RTN","GMRCUTL1",51,0)
 ; GMRC123 = ien of consult record in file 123
"RTN","GMRCUTL1",52,0)
 Q $P($G(^GMR(123,GMRC123,0)),U,3)
"RTN","GMRCUTL1",53,0)
GETDT(PROMPT,DEFAULT) ;prompt and return FM date
"RTN","GMRCUTL1",54,0)
 ;Input:
"RTN","GMRCUTL1",55,0)
 ;  PROMPT  = text of prompt - DIR("A")          (optional)
"RTN","GMRCUTL1",56,0)
 ;  DEFAULT = default date to prompt - DIR("B")  (optional)
"RTN","GMRCUTL1",57,0)
 ; 
"RTN","GMRCUTL1",58,0)
 ;Output:
"RTN","GMRCUTL1",59,0)
 ; FM date/time if successfully answered, "^" if exit or timeout
"RTN","GMRCUTL1",60,0)
 N DIR,DIRUT,DIROUT,DTOUT,DUOUT,X,Y
"RTN","GMRCUTL1",61,0)
 S DIR(0)="DA^::EPT"
"RTN","GMRCUTL1",62,0)
 S DIR("?")="Enter the date/time the activity took place."
"RTN","GMRCUTL1",63,0)
 S DIR("A")=$S($D(PROMPT):PROMPT_" ",1:"Actual Date/Time of Activity: ")
"RTN","GMRCUTL1",64,0)
 S DIR("B")=$S($D(DEFAULT):DEFAULT,1:"NOW")
"RTN","GMRCUTL1",65,0)
 D ^DIR
"RTN","GMRCUTL1",66,0)
 I $D(DUOUT)!($D(DTOUT)) S Y="^"
"RTN","GMRCUTL1",67,0)
 Q Y
"RTN","GMRCUTL1",68,0)
 ;
"RTN","GMRCUTL1",69,0)
DCPRNT(IEN,USER) ;reprint SF-513 on DC?
"RTN","GMRCUTL1",70,0)
 N SERV,REPR
"RTN","GMRCUTL1",71,0)
 S SERV=$P(^GMR(123,IEN,0),U,5) I 'SERV Q 0
"RTN","GMRCUTL1",72,0)
 S REPR=$P($G(^GMR(123.5,SERV,1)),U,5)
"RTN","GMRCUTL1",73,0)
 I 'REPR Q 1
"RTN","GMRCUTL1",74,0)
 I REPR=2 Q 0
"RTN","GMRCUTL1",75,0)
 I REPR=1,'$$VALID^GMRCAU(SERV,IEN,USER) Q 1
"RTN","GMRCUTL1",76,0)
 Q 0
"RTN","GMRCUTL1",77,0)
 ;
"RTN","GMRCUTL1",78,0)
PREREQ(GMRCARR,GMRCSRV,GMRCDFN,UNRESOLV) ; return service pre-requisite
"RTN","GMRCUTL1",79,0)
 ; pre-requisite stored in 125 nodes in file 123.5 or 123.3
"RTN","GMRCUTL1",80,0)
 ; GMRCARR = array to return containing pre-requisite
"RTN","GMRCUTL1",81,0)
 ; GMRCSRV = ref to file 123.5 (ien;99CON) or 123.3 (ien;99PRC)
"RTN","GMRCUTL1",82,0)
 ; GMRCDFN = patient identifier if to return resolved
"RTN","GMRCUTL1",83,0)
 ; UNRESOLV = 1 or 0 ; if UNRESOLV=1 GMRCARR will be returned unresolved
"RTN","GMRCUTL1",84,0)
 Q:'+GMRCSRV
"RTN","GMRCUTL1",85,0)
 N GMRCFIL
"RTN","GMRCUTL1",86,0)
 S GMRCFIL=$S(GMRCSRV["99PRC":123.3,1:123.5)
"RTN","GMRCUTL1",87,0)
 Q:'$D(^GMR(GMRCFIL,+GMRCSRV,125))
"RTN","GMRCUTL1",88,0)
 I '$D(GMRCDFN)!($G(UNRESOLV)) D  Q
"RTN","GMRCUTL1",89,0)
 . M @GMRCARR=^GMR(GMRCFIL,+GMRCSRV,125)
"RTN","GMRCUTL1",90,0)
 D BLRPLT^TIUSRVD(,,GMRCDFN,,$NA(^GMR(GMRCFIL,+GMRCSRV,125)))
"RTN","GMRCUTL1",91,0)
 I $D(^TMP("TIUBOIL",$J)) M @GMRCARR=^TMP("TIUBOIL",$J)
"RTN","GMRCUTL1",92,0)
 K ^TMP("TIUBOIL",$J)
"RTN","GMRCUTL1",93,0)
 Q
"RTN","GMRCUTL1",94,0)
 ;
"RTN","GMRCUTL1",95,0)
LOCKREC(GMRCDA) ;attempt to lock a consult record using order or record
"RTN","GMRCUTL1",96,0)
 ; Input:
"RTN","GMRCUTL1",97,0)
 ;   GMRCDA  = ien of consult record from file 123
"RTN","GMRCUTL1",98,0)
 ;
"RTN","GMRCUTL1",99,0)
 ; Output: 
"RTN","GMRCUTL1",100,0)
 ;     1 or 0^reason can't be locked  
"RTN","GMRCUTL1",101,0)
 ;          1 = successfully locked
"RTN","GMRCUTL1",102,0)
 ;          0 = couldn't be locked
"RTN","GMRCUTL1",103,0)
 N GMRCORD,GMRCMSG
"RTN","GMRCUTL1",104,0)
 S GMRCORD=$P($G(^GMR(123,GMRCDA,0)),U,3)
"RTN","GMRCUTL1",105,0)
 I $G(GMRCORD) D  ;an order associated
"RTN","GMRCUTL1",106,0)
 . S GMRCMSG=$$LOCK1^ORX2(GMRCORD)
"RTN","GMRCUTL1",107,0)
 . ; GMRCMSG=1 if locked  or 0 if couldn't be locked
"RTN","GMRCUTL1",108,0)
 I $L($G(GMRCMSG)) Q GMRCMSG
"RTN","GMRCUTL1",109,0)
 ; no order = Inter-facility Consult so lock consult record
"RTN","GMRCUTL1",110,0)
 L +^GMR(123,GMRCDA):5
"RTN","GMRCUTL1",111,0)
 I '$T Q "0^Another user is editing this record" ; couldn't lock it
"RTN","GMRCUTL1",112,0)
 Q 1
"RTN","GMRCUTL1",113,0)
 ;
"RTN","GMRCUTL1",114,0)
UNLKREC(GMRCDA) ;unlock a consult record
"RTN","GMRCUTL1",115,0)
 ; Input:
"RTN","GMRCUTL1",116,0)
 ;   GMRCDA  = ien of consult record from file 123
"RTN","GMRCUTL1",117,0)
 ;
"RTN","GMRCUTL1",118,0)
 N GMRCORD
"RTN","GMRCUTL1",119,0)
 S GMRCORD=$P($G(^GMR(123,GMRCDA,0)),U,3)
"RTN","GMRCUTL1",120,0)
 I $G(GMRCORD) D  Q
"RTN","GMRCUTL1",121,0)
 . D UNLK1^ORX2(GMRCORD)
"RTN","GMRCUTL1",122,0)
 L -^GMR(123,GMRCDA)
"RTN","GMRCUTL1",123,0)
 Q
"VER")
8.0^22.0
"^DD",123,123,.02,0)
PATIENT NAME^RP2'^DPT(^0;2^Q
"^DD",123,123,.02,1,0)
^.1^^-1
"^DD",123,123,.02,1,1,0)
123^AD^MUMPS
"^DD",123,123,.02,1,1,1)
I $P(^GMR(123,DA,0),"^",7) S GMRCD=9999999-$P(^GMR(123,DA,0),"^",7),^GMR(123,"AD",X,GMRCD,DA)="" K GMRCD
"^DD",123,123,.02,1,1,2)
I $P(^GMR(123,DA,0),"^",7) S GMRCD=9999999-$P(^GMR(123,DA,0),"^",7) K ^GMR(123,"AD",X,GMRCD,DA),GMRCD
"^DD",123,123,.02,1,1,"%D",0)
^^2^2^2910715^^
"^DD",123,123,.02,1,1,"%D",1,0)
The "AD" cross-reference allows look up of patient consults in reverse
"^DD",123,123,.02,1,1,"%D",2,0)
chronological "DATE OF REQUEST" order.
"^DD",123,123,.02,1,1,"DT")
2910715
"^DD",123,123,.02,1,3,0)
123^F
"^DD",123,123,.02,1,3,1)
S ^GMR(123,"F",$E(X,1,30),DA)=""
"^DD",123,123,.02,1,3,2)
K ^GMR(123,"F",$E(X,1,30),DA)
"^DD",123,123,.02,1,3,"DT")
2920204
"^DD",123,123,.02,3)
Enter the name of a patient or the last 4 digits of the SSN.
"^DD",123,123,.02,21,0)
^^2^2^2981103^^^^
"^DD",123,123,.02,21,1,0)
This is the Patient who the consult or request was ordered for.
"^DD",123,123,.02,21,2,0)
Enter the patient's name, or the last four digits of the SSN.
"^DD",123,123,.02,"DT")
3011008
"^DD",123,123,1.01,0)
CLINICAL PROCEDURE^P702.01'^MDS(702.01,^1;1^Q
"^DD",123,123,1.01,1,0)
^.1^^0
"^DD",123,123,1.01,3)
Enter a CP DEFINITION
"^DD",123,123,1.01,21,0)
^^2^2^3011004^
"^DD",123,123,1.01,21,1,0)
This field contains the CP DEFINITION that is associated with this 
"^DD",123,123,1.01,21,2,0)
request.
"^DD",123,123,1.01,"DT")
3011008
"^DD",123.3,123.3,.04,0)
CLINICAL PROCEDURE^*P702.01'^MDS(702.01,^0;4^S DIC("S")="I $P(^MDS(702.01,+Y,0),U,9)" D ^DIC K DIC S DIC=$G(DIE),X=+Y K:Y<0 X
"^DD",123.3,123.3,.04,1,0)
^.1
"^DD",123.3,123.3,.04,1,1,0)
123.3^AC
"^DD",123.3,123.3,.04,1,1,1)
S ^GMR(123.3,"AC",$E(X,1,30),DA)=""
"^DD",123.3,123.3,.04,1,1,2)
K ^GMR(123.3,"AC",$E(X,1,30),DA)
"^DD",123.3,123.3,.04,1,1,"%D",0)
^^2^2^3011004^
"^DD",123.3,123.3,.04,1,1,"%D",1,0)
This field allows the sorting of all procedures linked to a given CP 
"^DD",123.3,123.3,.04,1,1,"%D",2,0)
DEFINITION
"^DD",123.3,123.3,.04,1,1,"DT")
3000620
"^DD",123.3,123.3,.04,3)
Enter the Clinical Procedure to associate with this item
"^DD",123.3,123.3,.04,12)
Only active procedures may be selected.
"^DD",123.3,123.3,.04,12.1)
S DIC("S")="I $P(^MDS(702.01,+Y,0),U,9)"
"^DD",123.3,123.3,.04,21,0)
^^4^4^3011004^
"^DD",123.3,123.3,.04,21,1,0)
This field provides a mapping between the CP DEFINITIONS (#702.01) file
"^DD",123.3,123.3,.04,21,2,0)
and the GMRC PROCEDURES file.   Orders placed for a procedure having a
"^DD",123.3,123.3,.04,21,3,0)
valid entry in this field will be processed and resulted via the Clinical
"^DD",123.3,123.3,.04,21,4,0)
Procedures package.
"^DD",123.3,123.3,.04,"DT")
3011004
**END**
**END**
