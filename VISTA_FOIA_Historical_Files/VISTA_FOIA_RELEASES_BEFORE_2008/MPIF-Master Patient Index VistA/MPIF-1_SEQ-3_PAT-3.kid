Released MPIF*1*3 SEQ #3
Extracted from mail message
**KIDS**:MPIF*1.0*3^

**INSTALL NAME**
MPIF*1.0*3
"BLD",1646,0)
MPIF*1.0*3^MASTER PATIENT INDEX VISTA^0^3000707^y
"BLD",1646,4,0)
^9.64PA^^
"BLD",1646,"ABNS",0)
^9.66A^^
"BLD",1646,"ABPKG")
n^y^G.CIRN DEV@DEVCRN.ISC-ALBANY.VA.GOV
"BLD",1646,"INID")
^y
"BLD",1646,"INIT")
MPIFPST3
"BLD",1646,"KRN",0)
^9.67PA^19^17
"BLD",1646,"KRN",.4,0)
.4
"BLD",1646,"KRN",.401,0)
.401
"BLD",1646,"KRN",.402,0)
.402
"BLD",1646,"KRN",.403,0)
.403
"BLD",1646,"KRN",.5,0)
.5
"BLD",1646,"KRN",.84,0)
.84
"BLD",1646,"KRN",3.6,0)
3.6
"BLD",1646,"KRN",3.8,0)
3.8
"BLD",1646,"KRN",9.2,0)
9.2
"BLD",1646,"KRN",9.8,0)
9.8
"BLD",1646,"KRN",9.8,"NM",0)
^9.68A^14^10
"BLD",1646,"KRN",9.8,"NM",2,0)
MPIFAPI^^0^B11723412
"BLD",1646,"KRN",9.8,"NM",6,0)
MPIFDEL^^0^B9042448
"BLD",1646,"KRN",9.8,"NM",7,0)
MPIFQ0^^0^B82876325
"BLD",1646,"KRN",9.8,"NM",8,0)
MPIFQUE3^^0^B51466593
"BLD",1646,"KRN",9.8,"NM",9,0)
MPIFSAQ^^0^B72806558
"BLD",1646,"KRN",9.8,"NM",10,0)
MPIFQUE4^^0^B52636193
"BLD",1646,"KRN",9.8,"NM",11,0)
MPIFBT3^^0^B21856303
"BLD",1646,"KRN",9.8,"NM",12,0)
MPIFPST3^^0^B2235510
"BLD",1646,"KRN",9.8,"NM",13,0)
MPIFBT2^^0^B41055656
"BLD",1646,"KRN",9.8,"NM",14,0)
MPIF001^^0^B43157202
"BLD",1646,"KRN",9.8,"NM","B","MPIF001",14)

"BLD",1646,"KRN",9.8,"NM","B","MPIFAPI",2)

"BLD",1646,"KRN",9.8,"NM","B","MPIFBT2",13)

"BLD",1646,"KRN",9.8,"NM","B","MPIFBT3",11)

"BLD",1646,"KRN",9.8,"NM","B","MPIFDEL",6)

"BLD",1646,"KRN",9.8,"NM","B","MPIFPST3",12)

"BLD",1646,"KRN",9.8,"NM","B","MPIFQ0",7)

"BLD",1646,"KRN",9.8,"NM","B","MPIFQUE3",8)

"BLD",1646,"KRN",9.8,"NM","B","MPIFQUE4",10)

"BLD",1646,"KRN",9.8,"NM","B","MPIFSAQ",9)

"BLD",1646,"KRN",19,0)
19
"BLD",1646,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",1646,"KRN",19,"NM",1,0)
MPIF PAT INACT^^0
"BLD",1646,"KRN",19,"NM","B","MPIF PAT INACT",1)

"BLD",1646,"KRN",19.1,0)
19.1
"BLD",1646,"KRN",101,0)
101
"BLD",1646,"KRN",409.61,0)
409.61
"BLD",1646,"KRN",771,0)
771
"BLD",1646,"KRN",870,0)
870
"BLD",1646,"KRN",870,"NM",0)
^9.68A^^0
"BLD",1646,"KRN",8994,0)
8994
"BLD",1646,"KRN",8994,"NM",0)
^9.68A^^
"BLD",1646,"KRN","B",.4,.4)

"BLD",1646,"KRN","B",.401,.401)

"BLD",1646,"KRN","B",.402,.402)

"BLD",1646,"KRN","B",.403,.403)

"BLD",1646,"KRN","B",.5,.5)

"BLD",1646,"KRN","B",.84,.84)

"BLD",1646,"KRN","B",3.6,3.6)

"BLD",1646,"KRN","B",3.8,3.8)

"BLD",1646,"KRN","B",9.2,9.2)

"BLD",1646,"KRN","B",9.8,9.8)

"BLD",1646,"KRN","B",19,19)

"BLD",1646,"KRN","B",19.1,19.1)

"BLD",1646,"KRN","B",101,101)

"BLD",1646,"KRN","B",409.61,409.61)

"BLD",1646,"KRN","B",771,771)

"BLD",1646,"KRN","B",870,870)

"BLD",1646,"KRN","B",8994,8994)

"BLD",1646,"QUES",0)
^9.62^^
"BLD",1646,"REQB",0)
^9.611^2^2
"BLD",1646,"REQB",1,0)
MPIF*1.0*1^2
"BLD",1646,"REQB",2,0)
HL*1.6*64^2
"BLD",1646,"REQB","B","HL*1.6*64",2)

"BLD",1646,"REQB","B","MPIF*1.0*1",1)

"INIT")
MPIFPST3
"KRN",19,9897,-1)
0^1
"KRN",19,9897,0)
MPIF PAT INACT^Inactivate Patient from MPI^^R^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",19,9897,1,0)
^^6^6^3000607^
"KRN",19,9897,1,1,0)
This option is to be used very cautiously.  It should be used to
"KRN",19,9897,1,2,0)
remove "test patients" that went to the MPI by mistake. OR When a
"KRN",19,9897,1,3,0)
duplicate entry is found on the MPI and you have been directed to
"KRN",19,9897,1,4,0)
inactivate your patient and re-associate with the remaining "correct"
"KRN",19,9897,1,5,0)
entry.  These patients must not have any subscribers and your site must be
"KRN",19,9897,1,6,0)
the CMOR.  
"KRN",19,9897,25)
INTER^MPIFDEL
"KRN",19,9897,"U")
INACTIVATE PATIENT FROM MPI
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",474,-1)
1^1
"PKG",474,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",474,20,0)
^9.402P^^
"PKG",474,22,0)
^9.49I^1^1
"PKG",474,22,1,0)
1.0^2990428^2990603^9139
"PKG",474,22,1,"PAH",1,0)
3^3000707^9139
"PKG",474,22,1,"PAH",1,1,0)
^^3^3^3000619
"PKG",474,22,1,"PAH",1,1,1,0)
CMOR COMPARE, DIRECT CONNECT, INACTIVATE ICN, LOAD TO MPI
"PKG",474,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1*3 in the FORUM Patch Module for a complete
"PKG",474,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","MPIF001")
0^14^B43157202
"RTN","MPIF001",1,0)
MPIF001 ;ALB/RJS-UTILITY ROUTINE TO SUPPORT VCCI STUFF ;JUL 12, 1996
"RTN","MPIF001",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3**;30 Apr 99
"RTN","MPIF001",3,0)
GETICN(DFN) ;
"RTN","MPIF001",4,0)
 ; This function returns the ICN, including checksum for a given DFN
"RTN","MPIF001",5,0)
 ; or -1^error message
"RTN","MPIF001",6,0)
 ; DFN - ien in Patient file
"RTN","MPIF001",7,0)
 ;
"RTN","MPIF001",8,0)
 N RETURN,NODE
"RTN","MPIF001",9,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT1
"RTN","MPIF001",10,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT1
"RTN","MPIF001",11,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT1
"RTN","MPIF001",12,0)
 S NODE=^DPT(DFN,"MPI")
"RTN","MPIF001",13,0)
 I $P(NODE,"^",1)'>0 S RETURN="-1^NO ICN" G EXIT1
"RTN","MPIF001",14,0)
 S RETURN=$P(NODE,"^",1)_"V"_$P(NODE,"^",2)
"RTN","MPIF001",15,0)
EXIT1 ;
"RTN","MPIF001",16,0)
 Q RETURN
"RTN","MPIF001",17,0)
 ;
"RTN","MPIF001",18,0)
GETDFN(ICN) ;
"RTN","MPIF001",19,0)
 ; Returns DFN (ien Patient file) or -1^error message for a given ICN
"RTN","MPIF001",20,0)
 ; ICN - ICN for a given Patient in the Patient file
"RTN","MPIF001",21,0)
 N RETURN,DFN
"RTN","MPIF001",22,0)
 I $G(ICN)'>0 S RETURN="-1^NO ICN" G EXIT2
"RTN","MPIF001",23,0)
 I '$D(^DPT("AICN",ICN)) S RETURN="-1^ICN NOT IN DATABASE" G EXIT2
"RTN","MPIF001",24,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIF001",25,0)
 I $G(DFN)'>0 S RETURN="-1^BAD ICN CROSS-REFERENCE" G EXIT2
"RTN","MPIF001",26,0)
 S RETURN=DFN
"RTN","MPIF001",27,0)
EXIT2 ;
"RTN","MPIF001",28,0)
 Q RETURN
"RTN","MPIF001",29,0)
 ;
"RTN","MPIF001",30,0)
ICNLC(DFN) ;This API will return an ICN if one exists or create and return
"RTN","MPIF001",31,0)
 ; a Local ICN and updating the appropriate fileds if a Local was created
"RTN","MPIF001",32,0)
 ; DFN= Patient IEN
"RTN","MPIF001",33,0)
 ; Returns ICN (local or National including checksum)
"RTN","MPIF001",34,0)
 N ICN,TMP,CHKSUM,ICNX
"RTN","MPIF001",35,0)
 F  L +^DPT(DFN,"MPI"):10 Q:$T
"RTN","MPIF001",36,0)
 I '$D(ICN) S ICN=$$GETICN(DFN)
"RTN","MPIF001",37,0)
 I +ICN=-1 D
"RTN","MPIF001",38,0)
 .;no icn create a Local ICN
"RTN","MPIF001",39,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIF001",40,0)
 .S CHKSUM=$P(ICN,"V",2),ICNX=$P(ICN,"V")
"RTN","MPIF001",41,0)
 .S NOLOCK=""
"RTN","MPIF001",42,0)
 .I ICNX="" K NOLOCK S ICN="-1^PROBLEM CREATING LOCAL ICN" Q
"RTN","MPIF001",43,0)
 .S TMP=$$SETICN(DFN,ICNX,CHKSUM)
"RTN","MPIF001",44,0)
 .S TMP=$$SETLOC(DFN,1)
"RTN","MPIF001",45,0)
 .S TMP=$$CHANGE(DFN,$P($$SITE^VASITE(),"^"))
"RTN","MPIF001",46,0)
 .K NOLOCK
"RTN","MPIF001",47,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",48,0)
 Q ICN
"RTN","MPIF001",49,0)
 ;
"RTN","MPIF001",50,0)
CMOR2(DFN) ;
"RTN","MPIF001",51,0)
 ; Returns CMOR Site Name or -1^error message
"RTN","MPIF001",52,0)
 ; DFN = Patient IEN
"RTN","MPIF001",53,0)
 N NODE
"RTN","MPIF001",54,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",55,0)
 Q:$P(NODE,"^",3)="" "-1^No CMOR"
"RTN","MPIF001",56,0)
 Q $$CMORNAME($P(NODE,"^",3))
"RTN","MPIF001",57,0)
 ;
"RTN","MPIF001",58,0)
CMORNAME(CIEN) ;
"RTN","MPIF001",59,0)
 ; Returns CMOR site name or -1^error message
"RTN","MPIF001",60,0)
 ; CIEN - ien from Institution file
"RTN","MPIF001",61,0)
 ;
"RTN","MPIF001",62,0)
 Q:CIEN="" "-1^No Institution parameter"
"RTN","MPIF001",63,0)
 N INST
"RTN","MPIF001",64,0)
 S INST=$$NNT^XUAF4(CIEN)
"RTN","MPIF001",65,0)
 Q:INST="" "-1^No Institution for that IEN"
"RTN","MPIF001",66,0)
 Q:$P(INST,"^")="" "-1^No Name for this Institution"
"RTN","MPIF001",67,0)
 Q $P(INST,"^")
"RTN","MPIF001",68,0)
 ;
"RTN","MPIF001",69,0)
GETVCCI(DFN) ;
"RTN","MPIF001",70,0)
 ; Returns CMOR or -1^error message for a given patient
"RTN","MPIF001",71,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",72,0)
 N RETURN,NODE,PTR,STANUM
"RTN","MPIF001",73,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT3
"RTN","MPIF001",74,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT3
"RTN","MPIF001",75,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT3
"RTN","MPIF001",76,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",77,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",78,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT3
"RTN","MPIF001",79,0)
 S STANUM=$P($$NNT^XUAF4(PTR),"^",2)
"RTN","MPIF001",80,0)
 I STANUM'>0 S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT3
"RTN","MPIF001",81,0)
 S RETURN=STANUM
"RTN","MPIF001",82,0)
EXIT3 ;
"RTN","MPIF001",83,0)
 Q RETURN
"RTN","MPIF001",84,0)
 ;
"RTN","MPIF001",85,0)
CHANGE(DFN,VCCI) ;
"RTN","MPIF001",86,0)
 ; ** This function is only to be used by approved packages **
"RTN","MPIF001",87,0)
 ;
"RTN","MPIF001",88,0)
 ; This function updates the CMOR field in the Patient file
"RTN","MPIF001",89,0)
 ; DFN = ien in Patient file
"RTN","MPIF001",90,0)
 ; VCCI = CMOR ien from the institution file or CMOR site name
"RTN","MPIF001",91,0)
 ; returned:  -1^error message - problem
"RTN","MPIF001",92,0)
 ;             1 - successful
"RTN","MPIF001",93,0)
 N RETURN,DIQUIET,DIE,DA,DR,IEN,Y,X,DIC
"RTN","MPIF001",94,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",95,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT4
"RTN","MPIF001",96,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT4
"RTN","MPIF001",97,0)
 I $G(VCCI)="" S RETURN="-1^NO CMOR PASSED" G EXIT4
"RTN","MPIF001",98,0)
 I VCCI'?.N S IEN=$$LKUP^XUAF4(VCCI)
"RTN","MPIF001",99,0)
 ; ^ passed name, get ien from Institution file
"RTN","MPIF001",100,0)
 I $G(IEN)=0 S RETURN="-1^NO INSTITUTION BY THAT NAME" G EXIT4
"RTN","MPIF001",101,0)
 I $D(IEN) S VCCI=IEN
"RTN","MPIF001",102,0)
 I $E($$GETICN(DFN),1,3)=$P($$SITE^VASITE(),"^",3) S VCCI=$P($$SITE^VASITE(),"^")
"RTN","MPIF001",103,0)
 ; ^ to be sure site is self for a local icn
"RTN","MPIF001",104,0)
 S VCCI="`"_VCCI
"RTN","MPIF001",105,0)
 ; ^ Have ien stuff added to use ien instead of station number
"RTN","MPIF001",106,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",107,0)
 S DIQUIET=1
"RTN","MPIF001",108,0)
 S DIE="^DPT(",DA=DFN,DR="991.03///^S X=VCCI"
"RTN","MPIF001",109,0)
 D ^DIE
"RTN","MPIF001",110,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",111,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",112,0)
EXIT4 ;
"RTN","MPIF001",113,0)
 Q RETURN
"RTN","MPIF001",114,0)
 ;
"RTN","MPIF001",115,0)
SETICN(DFN,ICN,CHKSUM) ;
"RTN","MPIF001",116,0)
 ; ** this function is to only be used by approved packages **
"RTN","MPIF001",117,0)
 ;
"RTN","MPIF001",118,0)
 ; This function updates the ICN and ICN Checksum fields in the Patient 
"RTN","MPIF001",119,0)
 ; file for a given patient.
"RTN","MPIF001",120,0)
 ; DFN - ien in the Patient file to be updated
"RTN","MPIF001",121,0)
 ; ICN - ICN (without checksum) to be updated
"RTN","MPIF001",122,0)
 ; CHKSUM - ICN checksum
"RTN","MPIF001",123,0)
 ; return:  -1^error message - problem
"RTN","MPIF001",124,0)
 ;          1 - successful
"RTN","MPIF001",125,0)
 N RETURN,DIQUIET,DIE,DA,DR,RGRSICN,Y,ERR
"RTN","MPIF001",126,0)
 S (RETURN,DIQUIET,RGRSICN)=1
"RTN","MPIF001",127,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT5
"RTN","MPIF001",128,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT5
"RTN","MPIF001",129,0)
 I $G(ICN)="" S RETURN="-1^NO ICN PASSED" G EXIT5
"RTN","MPIF001",130,0)
 I $G(CHKSUM)="" S RETURN="-1^NO CHKSUM PASSED" G EXIT5
"RTN","MPIF001",131,0)
 I +$$GETICN(DFN)>0 I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3),$E($$GETICN(DFN),1,3)'=$E(ICN,1,3) G EXIT5
"RTN","MPIF001",132,0)
 ; ^ stop local from overwriting a national ICN
"RTN","MPIF001",133,0)
 I $D(^DPT("AICN",ICN)) D
"RTN","MPIF001",134,0)
 .Q:DFN=$O(^DPT("AICN",ICN,""))
"RTN","MPIF001",135,0)
 .N RGLOG D START^RGHLLOG(0)
"RTN","MPIF001",136,0)
 .I DFN'=($O(^DPT("AICN",ICN,""))) D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_ICN_" that is already in use for Patient dfn "_$O(^DPT("AICN",ICN,""))_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIF001",137,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIF001",138,0)
 .S RETURN="-1^ICN ALREADY IN USE"
"RTN","MPIF001",139,0)
 G:+RETURN=-1 EXIT5
"RTN","MPIF001",140,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",141,0)
 S DIQUIET=1
"RTN","MPIF001",142,0)
 S DIE="^DPT(",DA=DFN,DR="991.01///^S X=ICN;991.02///^S X=CHKSUM"
"RTN","MPIF001",143,0)
 D ^DIE
"RTN","MPIF001",144,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",145,0)
 I +RETURN>0 D
"RTN","MPIF001",146,0)
 .K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",147,0)
 .I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,1)
"RTN","MPIF001",148,0)
 .I $E(ICN,1,3)'=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,0)
"RTN","MPIF001",149,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",150,0)
EXIT5 ;
"RTN","MPIF001",151,0)
 Q RETURN
"RTN","MPIF001",152,0)
 ;
"RTN","MPIF001",153,0)
SETLOC(DFN,DELFLAG) ;
"RTN","MPIF001",154,0)
 ; ** This function should be only used by approved packages **
"RTN","MPIF001",155,0)
 ;
"RTN","MPIF001",156,0)
 ; This function updates the LOCALLY ASSIGNED ICN field in the Patient
"RTN","MPIF001",157,0)
 ; for the given patient
"RTN","MPIF001",158,0)
 ;DFN - ien from Patient file of patient to be updated
"RTN","MPIF001",159,0)
 ;DELFLAG - 1 is to turn the flag on
"RTN","MPIF001",160,0)
 ;        - 0 is to turn off the flag
"RTN","MPIF001",161,0)
 ;
"RTN","MPIF001",162,0)
 N RETURN,DIQUIET,DIE,DA,DR,VALUE,Y
"RTN","MPIF001",163,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",164,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT6
"RTN","MPIF001",165,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT6
"RTN","MPIF001",166,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",167,0)
 S DIQUIET=1,VALUE=$S($G(DELFLAG)=0:"@",1:1)
"RTN","MPIF001",168,0)
 S DIE="^DPT(",DA=DFN,DR="991.04///^S X=VALUE"
"RTN","MPIF001",169,0)
 D ^DIE
"RTN","MPIF001",170,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",171,0)
 I +RETURN>0 K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",172,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",173,0)
EXIT6 ;
"RTN","MPIF001",174,0)
 Q RETURN
"RTN","MPIF001",175,0)
 ;
"RTN","MPIF001",176,0)
IFLOCAL(DFN) ;
"RTN","MPIF001",177,0)
 ; This function is used to see if a patient has a local ICN
"RTN","MPIF001",178,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",179,0)
 ; returned:  0 = patient does not exist, dfn is not defined or no MPI node OR Patient does not have a local ICN
"RTN","MPIF001",180,0)
 ;            1 = patient has a Local ICN assigned
"RTN","MPIF001",181,0)
 Q:$G(DFN)="" 0
"RTN","MPIF001",182,0)
 Q:$G(^DPT(DFN,0))="" 0
"RTN","MPIF001",183,0)
 Q:'$D(^DPT(DFN,"MPI")) 0
"RTN","MPIF001",184,0)
 Q:$E($$GETICN(DFN),1,3)=$P($$SITE^VASITE,"^",3) 1
"RTN","MPIF001",185,0)
 Q 0
"RTN","MPIF001",186,0)
 ;
"RTN","MPIF001",187,0)
IFVCCI(DFN) ;
"RTN","MPIF001",188,0)
 ; this function returns 1 if your facility is the CMOR for the given pt
"RTN","MPIF001",189,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",190,0)
 ; returns: 1 = your site in the CMOR for this patient
"RTN","MPIF001",191,0)
 ;          -1 = your site is not the CMOR for this patient
"RTN","MPIF001",192,0)
 N VCCI,SITE
"RTN","MPIF001",193,0)
 S VCCI=$P($$GETVCCI(DFN),"^",1)
"RTN","MPIF001",194,0)
 S SITE=$P($$SITE^VASITE,"^",3)\1
"RTN","MPIF001",195,0)
 I $P(VCCI,"^",1)=-1 Q -1
"RTN","MPIF001",196,0)
 I VCCI'=SITE Q -1
"RTN","MPIF001",197,0)
 Q 1
"RTN","MPIF001",198,0)
 ;
"RTN","MPIF001",199,0)
HL7CMOR(DFN,SEP) ;
"RTN","MPIF001",200,0)
 ; This function returns the CMOR station number and institution name for
"RTN","MPIF001",201,0)
 ; the given patient.
"RTN","MPIF001",202,0)
 ; DFN = ien for patient in Patient file
"RTN","MPIF001",203,0)
 ; SEP = delimeter to separate station number and name
"RTN","MPIF001",204,0)
 ; returned:  Station Number <sep> Institution name
"RTN","MPIF001",205,0)
 ;            -1^error message
"RTN","MPIF001",206,0)
 N RETURN,NODE,PTR,STAT
"RTN","MPIF001",207,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT7
"RTN","MPIF001",208,0)
 I $G(SEP)="" S RETURN="-1^NO FIELD SEPERATOR" G EXIT7
"RTN","MPIF001",209,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT7
"RTN","MPIF001",210,0)
 I $$MPINODE^MPIFAPI(DFN)<1 S RETURN="-1^NO MPI NODE" G EXIT7
"RTN","MPIF001",211,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",212,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",213,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT7
"RTN","MPIF001",214,0)
 S STAT=$$NNT^XUAF4(PTR)
"RTN","MPIF001",215,0)
 I STAT="" S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT7
"RTN","MPIF001",216,0)
 I $P(STAT,"^")="" S RETURN="-1^NO INSTITUTION NAME" G EXIT7
"RTN","MPIF001",217,0)
 S RETURN=$P(STAT,"^",2)_SEP_$P(STAT,"^")
"RTN","MPIF001",218,0)
EXIT7 ;
"RTN","MPIF001",219,0)
 Q RETURN
"RTN","MPIF001",220,0)
 ;
"RTN","MPIF001",221,0)
LOCK ;
"RTN","MPIF001",222,0)
 L +^DPT(DFN,"MPI"):10 I '$T G LOCK
"RTN","MPIF001",223,0)
 Q
"RTN","MPIF001",224,0)
 ;
"RTN","MPIF001",225,0)
UNLOCK ;
"RTN","MPIF001",226,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",227,0)
 Q
"RTN","MPIFAPI")
0^2^B11723412
"RTN","MPIFAPI",1,0)
MPIFAPI ;CMC/BP-APIS FOR MPI ;DEC 21, 1998
"RTN","MPIFAPI",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3**;30 Apr 99
"RTN","MPIFAPI",3,0)
 ;original 1st line ARS/SLC - API for local ICNs ;04-FEB-97
"RTN","MPIFAPI",4,0)
 ;
"RTN","MPIFAPI",5,0)
EN2() ;NEW ENTRY POINT FOR LOCALS
"RTN","MPIFAPI",6,0)
 N MPIOUT,DIC,MPICHK,MPINCK,MPINNM,MPINUM1,DA,MPINUM
"RTN","MPIFAPI",7,0)
 I $O(^MPIF(984.1,0))="" G SETUP
"RTN","MPIFAPI",8,0)
AGN2 L +^MPIF(984.1):1 E  H 3 G AGN2
"RTN","MPIFAPI",9,0)
 S MPINUM=0
"RTN","MPIFAPI",10,0)
 S X=$$SITE^VASITE,X=$P(X,"^",3),X=X\1
"RTN","MPIFAPI",11,0)
 S DIC="^MPIF(984.1,",DIC(0)="XZ" D ^DIC
"RTN","MPIFAPI",12,0)
 S MPINUM1=$P(Y(0),"^",4),MPICHK=$P(Y(0),"^",5),MPINNM=MPINUM1+1
"RTN","MPIFAPI",13,0)
 S MPINUM=MPINUM1_"V"_MPICHK
"RTN","MPIFAPI",14,0)
 S MPINCK=$$CHECKDG^MPIFSPC(MPINNM)
"RTN","MPIFAPI",15,0)
 S DA=1,DIE="^MPIF(984.1,",DR="1////^S X=MPINUM1;2////^S X=MPICHK;3////^S X=MPINNM;5////"_MPINCK
"RTN","MPIFAPI",16,0)
 D ^DIE
"RTN","MPIFAPI",17,0)
 K DIE,DR,X,Y
"RTN","MPIFAPI",18,0)
 L -^MPIF(984.1)
"RTN","MPIFAPI",19,0)
 Q MPINUM
"RTN","MPIFAPI",20,0)
SETUP ;
"RTN","MPIFAPI",21,0)
 N CHK,NUM,NXTCHK,NXTNUM,SITE,DA
"RTN","MPIFAPI",22,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFAPI",23,0)
 S DIC="^MPIF(984.1,",DA=1,DIC(0)="",X=SITE
"RTN","MPIFAPI",24,0)
 S NUM=SITE_"0000000"
"RTN","MPIFAPI",25,0)
 S CHK=$$CHECKDG^MPIFSPC(NUM)
"RTN","MPIFAPI",26,0)
 S MPINUM=NUM_"V"_CHK
"RTN","MPIFAPI",27,0)
 S NXTNUM=NUM+1,NXTCHK=$$CHECKDG^MPIFSPC(NXTNUM)
"RTN","MPIFAPI",28,0)
 S DIC("DR")="1////^S X=NUM;2////^S X=CHK;3////^S X=NXTNUM;5////"_NXTCHK
"RTN","MPIFAPI",29,0)
 K DD,D0
"RTN","MPIFAPI",30,0)
 D FILE^DICN
"RTN","MPIFAPI",31,0)
 K DIC,X,Y
"RTN","MPIFAPI",32,0)
 Q MPINUM
"RTN","MPIFAPI",33,0)
 ;
"RTN","MPIFAPI",34,0)
MPILINK() ;returns MPI logical LInk
"RTN","MPIFAPI",35,0)
 N MPIL,MPILINK
"RTN","MPIFAPI",36,0)
 D LINK^HLUTIL3("MPI",.MPIL)
"RTN","MPIFAPI",37,0)
 I '$D(MPIL) S MPIL(0)="-1^NOT DEFINED"
"RTN","MPIFAPI",38,0)
 S MPILINK=$O(MPIL(0)),MPILINK=$G(MPIL(MPILINK))
"RTN","MPIFAPI",39,0)
 Q MPILINK
"RTN","MPIFAPI",40,0)
 ;
"RTN","MPIFAPI",41,0)
SUBNUM(DFN) ; returns Subscription Control Number from MPI node for given DFN
"RTN","MPIFAPI",42,0)
 ; DFN - ien of patient file
"RTN","MPIFAPI",43,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",44,0)
 ;           Subscription Control Number
"RTN","MPIFAPI",45,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",46,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",47,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",48,0)
 N NODE,SUB
"RTN","MPIFAPI",49,0)
 S NODE=$$MPINODE(DFN)
"RTN","MPIFAPI",50,0)
 S SUB=$P(NODE,"^",5)
"RTN","MPIFAPI",51,0)
 I SUB="" S SUB="-1^No Subscription Control Number for DFN "_DFN
"RTN","MPIFAPI",52,0)
 Q SUB
"RTN","MPIFAPI",53,0)
 ;
"RTN","MPIFAPI",54,0)
MPINODE(DFN) ; returns MPI node for given DFN
"RTN","MPIFAPI",55,0)
 ; DFN - patient file ien
"RTN","MPIFAPI",56,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",57,0)
 ;           MPI node from patient file
"RTN","MPIFAPI",58,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",59,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",60,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",61,0)
 N NODE
"RTN","MPIFAPI",62,0)
 S NODE=$G(^DPT(DFN,"MPI"))
"RTN","MPIFAPI",63,0)
 I NODE=""!(NODE?."^") S NODE="-1^No MPI data for DFN "_DFN
"RTN","MPIFAPI",64,0)
 Q NODE
"RTN","MPIFAPI",65,0)
 ;
"RTN","MPIFAPI",66,0)
UPDATE(DFN,ARR) ; updates fields on MPI node passed in ARR(field number) for
"RTN","MPIFAPI",67,0)
 ;patient DFN.  Fields 991.01-991.05 only
"RTN","MPIFAPI",68,0)
 ;ARR - array of values for each field to be updated where subscript
"RTN","MPIFAPI",69,0)
 ; is the field number to be updated
"RTN","MPIFAPI",70,0)
 ;DFN - patient IEN
"RTN","MPIFAPI",71,0)
 ;Returns : -1^error message if unable to update fields
"RTN","MPIFAPI",72,0)
 ;          0 if sucessfully updated fields
"RTN","MPIFAPI",73,0)
 ;
"RTN","MPIFAPI",74,0)
 N FLD,DR,DIE,DA,LOC,SCN
"RTN","MPIFAPI",75,0)
 Q:'$D(^DPT(DFN,0)) "-1^No Entry in Patient file"
"RTN","MPIFAPI",76,0)
 S DIE="^DPT(",DA=DFN,RGRSICN=""
"RTN","MPIFAPI",77,0)
 L +^DPT(DFN,"MPI"):10
"RTN","MPIFAPI",78,0)
 F FLD=991.01,991.02,991.03,991.04,991.05 D
"RTN","MPIFAPI",79,0)
 .I (FLD=991.05)&($G(@ARR@(FLD))="@") D
"RTN","MPIFAPI",80,0)
 ..S SCN=$$SUBNUM(DFN)
"RTN","MPIFAPI",81,0)
 ..S DA=SCN,DIK="^HLS(774," D ^DIK K DIK,DA
"RTN","MPIFAPI",82,0)
 ..S $P(^DPT(DFN,"MPI"),"^",5)=""
"RTN","MPIFAPI",83,0)
 ..K ^DPT("ASCN2",SCN,DFN)
"RTN","MPIFAPI",84,0)
 ..S @ARR@(FLD)=""
"RTN","MPIFAPI",85,0)
 .I $G(@ARR@(FLD))'="" S DR=FLD_"///^S X=$G(@ARR@(FLD))" D ^DIE
"RTN","MPIFAPI",86,0)
 I '$$IFLOCAL^MPIF001(DFN) S LOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFAPI",87,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIFAPI",88,0)
 K ^DPT("AMPIMIS",DFN)
"RTN","MPIFAPI",89,0)
 K RGRSICN
"RTN","MPIFAPI",90,0)
 Q 0
"RTN","MPIFAPI",91,0)
 ;
"RTN","MPIFAPI",92,0)
MPIQ(MDFN) ;
"RTN","MPIFAPI",93,0)
 ;MPI QUERY
"RTN","MPIFAPI",94,0)
 K MPIFRTN D VTQ^MPIFQ0
"RTN","MPIFAPI",95,0)
 I $G(MPIFRTN)="" D
"RTN","MPIFAPI",96,0)
 .; ^ Quit at LM screen when presented with a list of possible matches
"RTN","MPIFAPI",97,0)
 .; \/ setup Local ICN and proceed
"RTN","MPIFAPI",98,0)
 .N ICN,ERR
"RTN","MPIFAPI",99,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIFAPI",100,0)
 .Q:ICN=""!(+ICN=-1)
"RTN","MPIFAPI",101,0)
 .S ERR=$$SETICN^MPIF001(MDFN,+ICN,$P(ICN,"V",2))
"RTN","MPIFAPI",102,0)
 .S ERR=$$SETLOC^MPIF001(MDFN,1)
"RTN","MPIFAPI",103,0)
 .S ERR=$$CHANGE^MPIF001(MDFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFAPI",104,0)
 K MPIFRTN
"RTN","MPIFAPI",105,0)
 Q
"RTN","MPIFBT2")
0^13^B41055656
"RTN","MPIFBT2",1,0)
MPIFBT2 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT2",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3**;30 Apr 99
"RTN","MPIFBT2",3,0)
ADDPAT ;Called when response from MPI is received for messages sent.
"RTN","MPIFBT2",4,0)
 K ^XTMP($J,"MPIF") D NOW^%DTC S ST=%,X1=ST,X2=20 D C^%DTC
"RTN","MPIFBT2",5,0)
 S STP=X,^XTMP($J,"MPIF","MPIIN",0)=STP_"^"_ST_"^"_"MPI BATCH JOB"
"RTN","MPIFBT2",6,0)
 K %,X,Y,X1,X2,ST,STP N RGLOG,MPIMSG S MPIMSG=HLMTIEN
"RTN","MPIFBT2",7,0)
 D START^RGHLLOG(HLMTIEN,"","ADDPAT^MPIFBT2")
"RTN","MPIFBT2",8,0)
 D PREPMSG,PROCESS(MPIMSG),STOP^RGHLLOG(0)
"RTN","MPIFBT2",9,0)
 K ACK1,ACK2,ACK3,ACK4,HDR,MPICKG,MPIIN,MPIIPPF,MPIIT,MPINUM,MPIPPF,DA
"RTN","MPIFBT2",10,0)
 K CNTR,COM,ENC,ESC,LOCAL,MSHDR,PATID,REP,SCOM,SEP,SITE,MPIDTH,VISTDTH,MPITMP,MPICNTR,MPIFOK,^XTMP($J,"MPIF")
"RTN","MPIFBT2",11,0)
 Q
"RTN","MPIFBT2",12,0)
PREPMSG ;prepare for response
"RTN","MPIFBT2",13,0)
 N I,J,X F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFBT2",14,0)
 .S ^XTMP($J,"MPIF","MPIIN",I)=HLNODE,J=0
"RTN","MPIFBT2",15,0)
 .F  S J=$O(HLNODE(J))  Q:'J  S ^XTMP($J,"MPIF","MPIIN",I,J)=HLNODE(J)
"RTN","MPIFBT2",16,0)
 Q
"RTN","MPIFBT2",17,0)
PROCESS(MPIMSG) ;Process mesage out of array
"RTN","MPIFBT2",18,0)
 N HDR,MPICNTR S MPICNTR=1,HDR=^XTMP($J,"MPIF","MPIIN",1) ;check hdr here
"RTN","MPIFBT2",19,0)
 D CHDR(HDR,.SEP,MPICNTR,MPIMSG)
"RTN","MPIFBT2",20,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",21,0)
 F  S MPICNTR=$O(^XTMP($J,"MPIF","MPIIN",MPICNTR)) Q:'MPICNTR  D LOOPS(.MPICNTR,SEP,MPIMSG)
"RTN","MPIFBT2",22,0)
 Q
"RTN","MPIFBT2",23,0)
LOOPS(CNTR,SEP,MPIMSG) ;Loop in the batch
"RTN","MPIFBT2",24,0)
 K ^XTMP($J,"MPIF","MSHERR") N MSHDR,ACK1,ACK2,ACK3,ACK4,ACK5,PATID,LOCAL,MPITMP
"RTN","MPIFBT2",25,0)
 S MSHDR=^XTMP($J,"MPIF","MPIIN",+CNTR)
"RTN","MPIFBT2",26,0)
 D CHKMSH(MSHDR,.SITE,SEP,MPIMSG)
"RTN","MPIFBT2",27,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",28,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",29,0)
 S ACK1=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",30,0)
 I $P(ACK1,SEP)'="MSA" S ^XTMP($J,"MPIF","MSHERR")="NOT AN MSA SEGMENT" D EXC^RGHLLOG(203,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",31,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",32,0)
 I ACK1["AR" S ^XTMP($J,"MPIF","MSHERR")="APP REJECT ERROR" D EXC^RGHLLOG(207,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",33,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",34,0)
 I ACK1["AE" S ^XTMP($J,"MPIF","MSHERR")="APP ERROR" D EXC^RGHLLOG(208,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",35,0)
 ;ACK1 must be an AA
"RTN","MPIFBT2",36,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",37,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",38,0)
 S ACK2=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",39,0)
 I $P(ACK2,SEP)'="QAK" S ^XTMP($J,"MPIF","MSHERR")="NOT A QAK SEGMENT" D EXC^RGHLLOG(202,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",40,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",41,0)
 I ACK2["NO DATA" D
"RTN","MPIFBT2",42,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NO DATA in MPI "
"RTN","MPIFBT2",43,0)
 .I ACK2["POTENTIAL MATCHES" D EXC^RGHLLOG(218,"For Patient DFN="_$P(ACK2,SEP,2)_".  Use Single Patient Initialization to MPI option to manually process.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",44,0)
 .I ACK2'["POTENTIAL MATCHES" D EXC^RGHLLOG(209,"For Patient DFN="_$P(ACK2,SEP,2)_".  Need required fields before patient can be processed again the MPI.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",45,0)
 .N TACK,TCNTR S TCNTR=CNTR,CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),TACK=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",46,0)
 .I $P(TACK,SEP)="MSH" S CNTR=TCNTR
"RTN","MPIFBT2",47,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",48,0)
 S PATID=$P(ACK2,SEP,2),LOCAL=$G(^DPT(PATID,0)) ;Verify patient is in database
"RTN","MPIFBT2",49,0)
 I LOCAL']"" S ^XTMP($J,"MPIF","MSHERR")="PATIENT DFN NOT IN DATABASE- BAD " D EXC^RGHLLOG(210,"Around line number "_(CNTR*2)_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT2",50,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",51,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",52,0)
 S ACK3=^XTMP($J,"MPIF","MPIIN",CNTR) ;RDF DEFINITION SEGMENT NO-OP
"RTN","MPIFBT2",53,0)
 I $P(ACK3,SEP)'="RDF" S ^XTMP($J,"MPIF","MSHERR")="NOT RDF SEGMENT" D EXC^RGHLLOG(204,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",54,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",55,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",56,0)
 S ACK4=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",57,0)
 I $P(ACK4,SEP)'="RDT" S ^XTMP($J,"MPIF","MSHERR")="NOT RDT SEGMENT" D EXC^RGHLLOG(205,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",58,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",59,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",60,0)
 I MPITMP'>0 S:$E($G(^XTMP($J,"MPIF","MPIIN",MPITMP)),1,3)="BTS" CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",61,0)
 Q:CNTR'>0
"RTN","MPIFBT2",62,0)
 D VFYRDT^MPIFBT3(ACK4,SEP,CNTR,PATID,SITE,MPIMSG)
"RTN","MPIFBT2",63,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",64,0)
 Q:MPITMP'>0
"RTN","MPIFBT2",65,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP)
"RTN","MPIFBT2",66,0)
 I $P(ACK5,SEP)="RDT" D MULT^MPIFBT3(.CNTR,ACK5,SEP,MPIMSG,PATID)
"RTN","MPIFBT2",67,0)
 Q
"RTN","MPIFBT2",68,0)
TFLIST(TFSITE,PATID) ;adding TFSITE site for patient to Treating Facility List (#391.91)
"RTN","MPIFBT2",69,0)
 I $G(TFSITE)="" S ^XTMP($J,"MPIF","MSHERR")="Treating Facility = null" D EXC^RGHLLOG(212,"DFN = "_PATID_" Treating Facility = Null",PATID) Q
"RTN","MPIFBT2",70,0)
 S TFSITE=$$LKUP^XUAF4(TFSITE)
"RTN","MPIFBT2",71,0)
 Q:+TFSITE'>0
"RTN","MPIFBT2",72,0)
 Q:$D(^DGCN(391.91,"APAT",PATID,TFSITE))
"RTN","MPIFBT2",73,0)
 K DD,DO N DIC,X,Y L +^DGCN(391.91,0):60
"RTN","MPIFBT2",74,0)
 I '$T D EXC^RGHLLOG(212,"Unable to Lock Treating Facility file to add patient DFN="_PATID_" Facility= "_TFSITE,PATID) Q
"RTN","MPIFBT2",75,0)
 S DIC="^DGCN(391.91,",DIC("DR")=".02///`"_TFSITE,X=PATID,DIC(0)="LQZ"
"RTN","MPIFBT2",76,0)
 I $D(^DGCN(391.91,"APAT",PATID,TFSITE)) L -^DGCN(391.91,0) Q
"RTN","MPIFBT2",77,0)
 D FILE^DICN L -^DGCN(391.91,0)
"RTN","MPIFBT2",78,0)
 I +Y=-1,'$D(^DGCN(391.91,"APAT",PATID,TFSITE)) S ^XTMP($J,"MPIF","MSHERR")="Treating Facility Add Failed" D EXC^RGHLLOG(212,"DFN= "_PATID_"  Treating Facility= "_TFSITE_"  failed when adding an entry to the Treating Facility file.",DFN)
"RTN","MPIFBT2",79,0)
 K DD,DO,DIC,X,Y
"RTN","MPIFBT2",80,0)
 Q
"RTN","MPIFBT2",81,0)
TFUPDT(PATID,MPIMSG,CNTR) ;treating facility update message to pivot file
"RTN","MPIFBT2",82,0)
 N ERR,TRANS,EVDT,X,Y,%
"RTN","MPIFBT2",83,0)
 D NOW^%DTC S EVDT=% K %,X,Y
"RTN","MPIFBT2",84,0)
 S ERR=$$PIVNW^VAFHPIVT(PATID,EVDT,5,PATID_";DPT(")
"RTN","MPIFBT2",85,0)
 I +ERR<1 D EXC^RGHLLOG(212,"When trying to add Patient (DFN)"_PATID_"   message# "_MPIMSG_" around line number "_(CNTR*2),DFN)
"RTN","MPIFBT2",86,0)
 Q:+ERR<1
"RTN","MPIFBT2",87,0)
 D XMITFLAG^VAFCDD01("",+ERR)
"RTN","MPIFBT2",88,0)
 Q
"RTN","MPIFBT2",89,0)
CHDR(HDR,SEP,CNTR,MPIMSG) ;Only process Batch message responses
"RTN","MPIFBT2",90,0)
 I $P(HDR,"^")'="BHS" S ^XTMP($J,"MPIF","MSHERR")="BHS SEGMENT MISSING" D EXC^RGHLLOG(200,"for message "_MPIMSG_".  The segment contains "_HDR)
"RTN","MPIFBT2",91,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",92,0)
 S SEP=$G(HL("FS")) ;get field sep, and encoding characters
"RTN","MPIFBT2",93,0)
 I SEP="" S ^XTMP($J,"MPIF","MSHERR")="Missing field seperator" D EXC^RGHLLOG(200,"Missing field seperator")
"RTN","MPIFBT2",94,0)
 Q
"RTN","MPIFBT2",95,0)
CHKMSH(MSHDR,SITE,SEP,MPIMSG) ;VERIFY MSH
"RTN","MPIFBT2",96,0)
 I $P(MSHDR,SEP)="BTS" S ^XTMP($J,"MPIF","MSHERR")="BTS FOUND" Q
"RTN","MPIFBT2",97,0)
 S:$P(MSHDR,SEP)'="MSH" ^XTMP($J,"MPIF","MSHERR")="NOT MSH HEADER   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",98,0)
 S:$E(MSHDR,4)'=SEP ^XTMP($J,"MPIF","MSHERR")="FIELD SEPARATOR MISMATCH   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",99,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(201,$G(^XTMP($J,"MPIF","MSHERR")))
"RTN","MPIFBT2",100,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",101,0)
 S SITE=$P(MSHDR,SEP,6)
"RTN","MPIFBT2",102,0)
 I SITE="" S ^XTMP($J,"MPIF","MSHERR")="SITE NOT IN MSH"
"RTN","MPIFBT2",103,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(8,"MSH Doesn't Have SITE as 6th piece.   MESSAGE# "_MPIMSG)
"RTN","MPIFBT2",104,0)
 Q
"RTN","MPIFBT3")
0^11^B21856303
"RTN","MPIFBT3",1,0)
MPIFBT3 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3**;30 Apr 99
"RTN","MPIFBT3",3,0)
 ;
"RTN","MPIFBT3",4,0)
MULT(CNTR,ACK5,SEP,MPIMSG,PATID) ;multiple RDT segments
"RTN","MPIFBT3",5,0)
 N NEXTTF,MPITMP S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),NEXTTF=$P(ACK5,SEP,8)
"RTN","MPIFBT3",6,0)
 ;D TFLIST^MPIFBT2(NEXTTF,PATID) stop updating TF list with data from MPI
"RTN","MPIFBT3",7,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:MPITMP'>0
"RTN","MPIFBT3",8,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP) K NEXTTF,MPITMP
"RTN","MPIFBT3",9,0)
 I $P(ACK5,SEP)="RDT" D MULT(.CNTR,ACK5,SEP,MPIMSG,PATID) ; ^ add to treating facility list.  If not RDT continue on processing next msh
"RTN","MPIFBT3",10,0)
 Q
"RTN","MPIFBT3",11,0)
VFYRDT(ACK4,SEP,CNTR,PATID,SITE,MPIMSG) ;Here is the meat
"RTN","MPIFBT3",12,0)
 N MPIY,IEN,MPICMOR S DGSENFLG=""
"RTN","MPIFBT3",13,0)
 D FINDHM(PATID,ACK4,SEP,.MPIY,MPIMSG,CNTR)
"RTN","MPIFBT3",14,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",15,0)
 N MPINUM,MPICKG,MPIIT,DR,DIE,X,MPIIPPF,MPIPPF
"RTN","MPIFBT3",16,0)
 S MPINUM=$P(ACK4,SEP,6),MPICKG=$P(MPINUM,"V",2),MPINUM=$P(MPINUM,"V",1)
"RTN","MPIFBT3",17,0)
 ;check if ICN already in use in Patient file
"RTN","MPIFBT3",18,0)
 I $D(^DPT("AICN",MPINUM)) D
"RTN","MPIFBT3",19,0)
 .Q:PATID=$O(^DPT("AICN",MPINUM,""))   ; same patient
"RTN","MPIFBT3",20,0)
 .S ^XTMP($J,"MPIF","MSHERR")="ICN already in use"
"RTN","MPIFBT3",21,0)
 .D EXC^RGHLLOG(227,"Patient dfn "_PATID_" returned ICN "_MPINUM_" that is already in use for Patient dfn "_$O(^DPT("AICN",MPINUM,""))_" Checkout pair to determine if a Duplicate.",PATID)
"RTN","MPIFBT3",22,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",23,0)
 S DIE="^DPT(",DA=$P(MPIY,"^",1),MPIIT=$P(MPIY,"^",1),DR="991.01////^S X=MPINUM;991.02////^S X=MPICKG" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",24,0)
 S IEN=$P(MPIY,"^") ; check if need to kill Local/MISSING ICN field
"RTN","MPIFBT3",25,0)
 I $D(^DPT("AMPIMIS",IEN)) K ^DPT("AMPIMIS",IEN)
"RTN","MPIFBT3",26,0)
 I $D(^DPT("AICNL",1,IEN)) D
"RTN","MPIFBT3",27,0)
 .S DIE="^DPT(",DA=IEN,DR="991.04///@" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",28,0)
 S MPIIPPF=""
"RTN","MPIFBT3",29,0)
 S MPIPPF=$P(ACK4,SEP,5),MPICMOR=$$LKUP^XUAF4(MPIPPF)
"RTN","MPIFBT3",30,0)
 I MPICMOR'="" S MPIIPPF=$$CHANGE^MPIF001(MPIIT,MPICMOR)
"RTN","MPIFBT3",31,0)
 I +MPIIPPF<0 D EXC^RGHLLOG(211,"Around line number "_(CNTR*2)_"  CMOR= "_MPIPPF_" DFN= "_MPIIT_"  MESSAGE# "_MPIMSG,MPIIT)
"RTN","MPIFBT3",32,0)
 Q:+MPIIPPF<0
"RTN","MPIFBT3",33,0)
 I '$$PATCH^XPDUTL("DG*5.3*261") D
"RTN","MPIFBT3",34,0)
 .D TFLIST^MPIFBT2(SITE,PATID)
"RTN","MPIFBT3",35,0)
 .I MPIPPF'=SITE D TFUPDT^MPIFBT2(PATID,MPIMSG,CNTR),INSERT^RGJCTS01(PATID)
"RTN","MPIFBT3",36,0)
 I $$PATCH^XPDUTL("DG*5.3*261") D FILE^VAFCTFU(PATID,+$$SITE^VASITE)
"RTN","MPIFBT3",37,0)
 Q
"RTN","MPIFBT3",38,0)
FINDHM(PATID,ACK4,SEP,MPIY,MPIMSG,CNTR) ;LOOKUP
"RTN","MPIFBT3",39,0)
 N DIC,X,Y,NM,YTMP
"RTN","MPIFBT3",40,0)
 ;added I to DIC(0) allow processing of sensative patients when DUZ=0
"RTN","MPIFBT3",41,0)
 S DGSENFLG="",DIC="^DPT(",DIC(0)="OISZ",X="`"_PATID D ^DIC K DIC,DGSENFLG
"RTN","MPIFBT3",42,0)
 S YTMP=Y
"RTN","MPIFBT3",43,0)
 I YTMP=-1 S ^XTMP($J,"MPIF","MSHERR")="LOOKUP FAILED" D EXC^RGHLLOG(210,"SSN = "_$P(ACK4,SEP,3)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),$P(ACK4,SEP,3))
"RTN","MPIFBT3",44,0)
 Q:YTMP=-1
"RTN","MPIFBT3",45,0)
 S NM=$P(Y(0),"^"),YTMP=$G(Y(0)),MPIY=Y ; check if ICN already populated
"RTN","MPIFBT3",46,0)
 N ICN S ICN=$$GETICN^MPIF001(PATID)
"RTN","MPIFBT3",47,0)
 I +ICN'=-1,$E(+ICN,1,3)'=$P($$SITE^VASITE,"^",3) S ^XTMP($J,"MPIF","MSHERR")="Patient "_PATID_" Already has an ICN"
"RTN","MPIFBT3",48,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",49,0)
 S Y(0)=$G(YTMP)
"RTN","MPIFBT3",50,0)
 Q:$P(Y(0),"^",9)["P"&($P(ACK4,SEP,3)="")
"RTN","MPIFBT3",51,0)
 I $P(Y(0),"^",9)'=$P(ACK4,SEP,3) S ^XTMP($J,"MPIF","MSHERR")="SSN MISMATCH" D EXC^RGHLLOG(213,"SSN on File = "_$P(Y(0),"^",9)_" SSN in Message = "_$P(ACK4,SEP,3)_"    MESSAGE # "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",52,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",53,0)
 I NM'[$P(ACK4,SEP,2) S ^XTMP($J,"MPIF","MSHERR")="NAME MISMATCH" D EXC^RGHLLOG(214,"Name on File = "_$P(Y(0),"^")_"  Name in Message = "_$P(ACK4,SEP,2)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",54,0)
 ;check to see if MPI has Date of Death or if VistA has DOD
"RTN","MPIFBT3",55,0)
 N MPIDTH,VISTDTH
"RTN","MPIFBT3",56,0)
 I $P(ACK4,SEP,9)'="" S MPIDTH=$P(ACK4,SEP,9),MPIDTH=$$FMDATE^HLFNC(MPIDTH)\1
"RTN","MPIFBT3",57,0)
 I $D(^DPT(PATID,.35)),$P($G(^DPT(PATID,.35)),"^")'="" S VISTDTH=$P($G(^DPT(PATID,.35)),"^")\1
"RTN","MPIFBT3",58,0)
 I $D(MPIDTH)&$D(VISTDTH),MPIDTH'=VISTDTH D
"RTN","MPIFBT3",59,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y,Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",60,0)
 .D EXC^RGHLLOG(217,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",61,0)
 ; ^ BOTH HAVE DOD BUT THEY DON'T MATCH
"RTN","MPIFBT3",62,0)
 I '$D(MPIDTH)&($D(VISTDTH)) D
"RTN","MPIFBT3",63,0)
 .N Y S Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",64,0)
 .D EXC^RGHLLOG(216,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",65,0)
 ; ^ VISTA HAS DOD BUT MPI DOESN'T
"RTN","MPIFBT3",66,0)
 I $D(MPIDTH)&('$D(VISTDTH)) D
"RTN","MPIFBT3",67,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y
"RTN","MPIFBT3",68,0)
 .D EXC^RGHLLOG(215,"Around line "_(CNTR*2)_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",69,0)
 ; ^ MPI HAS DOD BUT VISTA DOESN'T
"RTN","MPIFBT3",70,0)
 Q
"RTN","MPIFDEL")
0^6^B9042448
"RTN","MPIFDEL",1,0)
MPIFDEL ;SF/MJM,CMC-DELETE PATIENT FROM MPI ;JUL 14, 1998
"RTN","MPIFDEL",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3**;30 Apr 99
"RTN","MPIFDEL",3,0)
 ;
"RTN","MPIFDEL",4,0)
INTER ;
"RTN","MPIFDEL",5,0)
 ;Entry point for Inactivate Patient from MPI option [MPIF PAT INACT]
"RTN","MPIFDEL",6,0)
 ;No input or output variables ^DPT
"RTN","MPIFDEL",7,0)
 N DIC,DA,DFN,HL,ERROR,CNT,HLRST,ICN,DATE,MPIFCMOR
"RTN","MPIFDEL",8,0)
 S ERROR=""
"RTN","MPIFDEL",9,0)
 S DIC=2,DIC(0)="QEAM" D ^DIC Q:+Y<0  S DFN=+Y
"RTN","MPIFDEL",10,0)
 S MPIFCMOR=+$$LKUP^XUAF4(+$$GETVCCI^MPIF001(DFN))
"RTN","MPIFDEL",11,0)
 I MPIFCMOR=0 W !,"*** Could NOT Inactivate Patient from MPI: CIRN Master of Record is Not Defined ***" Q
"RTN","MPIFDEL",12,0)
 I $$PAT^MPIFNQ(DFN)'=+$P($$SITE^VASITE,"^",3) W !,"*** Could NOT Inactivate Patient from MPI: CIRN Master of record site is '"_$$CMOR2^MPIF001(DFN)_"'. You MUST be the CMOR ***" Q
"RTN","MPIFDEL",13,0)
 S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFDEL",14,0)
 D HL7(DFN,.ERROR)
"RTN","MPIFDEL",15,0)
 I ERROR="" D DELETE(DFN) S ERROR=$$DELALLTF^VAFCTFU(+ICN),ERROR=""
"RTN","MPIFDEL",16,0)
 I ERROR=""!(ERROR=0) W !,"*** Done ***"
"RTN","MPIFDEL",17,0)
 I ERROR'="" W !,"Error Occurred - "_ERROR
"RTN","MPIFDEL",18,0)
 Q
"RTN","MPIFDEL",19,0)
 ;
"RTN","MPIFDEL",20,0)
HL7(DFN,ERROR) ; create HL7 message
"RTN","MPIFDEL",21,0)
 ; check if no subscribers
"RTN","MPIFDEL",22,0)
 N SUB,HL,CNT,ICN,%,HLDATE
"RTN","MPIFDEL",23,0)
 K HLL
"RTN","MPIFDEL",24,0)
 S SUB=$P($G(^DPT(DFN,"MPI")),"^",5)
"RTN","MPIFDEL",25,0)
 I SUB'="" D GET^HLSUB(SUB,"","MPIF A29 SERVER",.HLL) I $D(HLL) S ERROR="Attempted to Inactivate an ICN and Patient is Shared.  Can't Inactivate patient DFN= "_DFN Q
"RTN","MPIFDEL",26,0)
 S ICN=+$$ICN^MPIFNQ(DFN)
"RTN","MPIFDEL",27,0)
 D NOW^%DTC S HLDATE=$$HLDATE^HLFNC(%,"DT")
"RTN","MPIFDEL",28,0)
 S HL=0,CNT=0
"RTN","MPIFDEL",29,0)
 D INIT^HLFNC2("MPIF A29 SERVER",.HL)
"RTN","MPIFDEL",30,0)
 I HL S ERROR="ERROR = "_HL_" During INIT^HLFNC2 for MPIF A29 Server for Patient DFN= "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",31,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A29"_HL("FS")_HLDATE_HL("FS")_HL("FS")_""_HL("FS")
"RTN","MPIFDEL",32,0)
 S CNT=CNT+1,HLA("HLS",CNT)=$$EN^VAFCPID(DFN,"2,3,5")
"RTN","MPIFDEL",33,0)
 ; message only goes to MPI Link
"RTN","MPIFDEL",34,0)
 D GENERATE^HLMA("MPIF A29 SERVER","LM",1,.HLRST,"",.HL)
"RTN","MPIFDEL",35,0)
 I 'HLRST S ERROR="Error During Generate for MPIF A29 Server Error= "_HLRST_" for dfn "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",36,0)
 Q
"RTN","MPIFDEL",37,0)
 ;
"RTN","MPIFDEL",38,0)
PAT(DFN,ERROR) ;Programmer API to Delete MPI entry and remove ICN data from DPT
"RTN","MPIFDEL",39,0)
 S ERROR=""
"RTN","MPIFDEL",40,0)
 I $G(DFN)="" S ERROR="DFN not defined" Q
"RTN","MPIFDEL",41,0)
 I +$$PAT^MPIFNQ(DFN)'=+$$SITE^VASITE S ERROR="This site is not the CMOR for this patient" Q
"RTN","MPIFDEL",42,0)
 D HL7(DFN,ERROR)
"RTN","MPIFDEL",43,0)
 I ERROR="" D DELETE(DFN) S ERROR=$$DELALLTF^VAFCTFU(+ICN),ERROR=""
"RTN","MPIFDEL",44,0)
 Q
"RTN","MPIFDEL",45,0)
DELETE(DFN) ;
"RTN","MPIFDEL",46,0)
 N DA,DIE,X,Y,DR
"RTN","MPIFDEL",47,0)
 Q:DFN=""
"RTN","MPIFDEL",48,0)
 S DA=DFN,DIE="^DPT(",DR="991.01///@;991.02///@;991.03///@;991.04///@"
"RTN","MPIFDEL",49,0)
 D ^DIE
"RTN","MPIFDEL",50,0)
 Q
"RTN","MPIFDEL",51,0)
 ;
"RTN","MPIFDEL",52,0)
EXC(DFN,ERROR,TYPE) ; subscribers, log exception
"RTN","MPIFDEL",53,0)
 D START^RGHLLOG(0)
"RTN","MPIFDEL",54,0)
 D EXC^RGHLLOG(TYPE,ERROR)
"RTN","MPIFDEL",55,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFDEL",56,0)
 Q
"RTN","MPIFPST3")
0^12^B2235510
"RTN","MPIFPST3",1,0)
MPIFPST3 ;CMC/SF-MPI VISTA build post-init ;JAN 13, 2000
"RTN","MPIFPST3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**3**;30 Apr 99
"RTN","MPIFPST3",3,0)
 ;
"RTN","MPIFPST3",4,0)
EN ;This post init will correct any exiting problems with the setting of
"RTN","MPIFPST3",5,0)
 ; the ^DPT("AICNL" cross reference for local ICNs or the field Locally
"RTN","MPIFPST3",6,0)
 ; assigned ICN in the patient file for local ICNs.
"RTN","MPIFPST3",7,0)
 ;
"RTN","MPIFPST3",8,0)
 D BMES^XPDUTL("Updating Mail Group Associated with CIRN HL7 Excecption Type file entries 219, 223, 226 and 229")
"RTN","MPIFPST3",9,0)
 D MAIL
"RTN","MPIFPST3",10,0)
 D BMES^XPDUTL("Updating 'AICNL' Cross Reference.  This may take some time")
"RTN","MPIFPST3",11,0)
 N EN,LOCAL,ICN,SITE
"RTN","MPIFPST3",12,0)
 S ICN=0,SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFPST3",13,0)
 F  S ICN=$O(^DPT("AICN",ICN)) Q:ICN=""  D
"RTN","MPIFPST3",14,0)
 .S EN=""
"RTN","MPIFPST3",15,0)
 .F  S EN=$O(^DPT("AICN",ICN,EN)) Q:EN=""  D
"RTN","MPIFPST3",16,0)
 ..I $E(ICN,1,3)=SITE D
"RTN","MPIFPST3",17,0)
 ...I $P($G(^DPT(EN,"MPI")),"^")=ICN S LOCAL=$$SETLOC^MPIF001(EN,1),^DPT("AICNL",1,EN)=""
"RTN","MPIFPST3",18,0)
 Q
"RTN","MPIFPST3",19,0)
 ;
"RTN","MPIFPST3",20,0)
MAIL ;
"RTN","MPIFPST3",21,0)
 N DIC,GROUP,DIC,DA,DIE,X,Y,DR,ENT
"RTN","MPIFPST3",22,0)
 S DIC="^XMB(3.8,",DIC(0)="XQZ",X="MPIF EXCEPTIONS"
"RTN","MPIFPST3",23,0)
 D ^DIC
"RTN","MPIFPST3",24,0)
 Q:+Y<0
"RTN","MPIFPST3",25,0)
 S GROUP=+Y
"RTN","MPIFPST3",26,0)
 F ENT=219,223,226,229 D
"RTN","MPIFPST3",27,0)
 .S DIC="^RGHL7(991.11,",DIC(0)="XQZ",X=ENT
"RTN","MPIFPST3",28,0)
 .D ^DIC
"RTN","MPIFPST3",29,0)
 .Q:+Y<0
"RTN","MPIFPST3",30,0)
 .S DA=+Y,DIE="^RGHL7(991.11,",DR="6///^S X=GROUP"
"RTN","MPIFPST3",31,0)
 .D ^DIE
"RTN","MPIFPST3",32,0)
 Q
"RTN","MPIFQ0")
0^7^B82876325
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-CIRN QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",5,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",6,0)
 S MPIFRES="",MPIFINT=""
"RTN","MPIFQ0",7,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",8,0)
 S DIC="^DPT(",DIC(0)="AEMQ" D ^DIC
"RTN","MPIFQ0",9,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",10,0)
 S DFN=+Y
"RTN","MPIFQ0",11,0)
 S HLP("ACKTIME")=300
"RTN","MPIFQ0",12,0)
 W !
"RTN","MPIFQ0",13,0)
CIRNEXC ; CIRN Exception Entry Point
"RTN","MPIFQ0",14,0)
 I $$SEND^RGJUSITE'>0 W !,"CIRN Messaging Parameter Not Enabled" G END
"RTN","MPIFQ0",15,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",16,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",17,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",18,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFQ0",19,0)
 S TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",20,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S TDOB=""
"RTN","MPIFQ0",21,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",22,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",23,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 W !,"Patient has Test SSN" G END
"RTN","MPIFQ0",24,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",25,0)
 G JUMP
"RTN","MPIFQ0",26,0)
VTQ ;
"RTN","MPIFQ0",27,0)
 G:$G(DFN)']"" END
"RTN","MPIFQ0",28,0)
 I $$SEND^RGJUSITE'>0 S MPIFRTN="STOP/SUSPEND" G END
"RTN","MPIFQ0",29,0)
 ;
"RTN","MPIFQ0",30,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",31,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",32,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFQ0",33,0)
 S TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",34,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S TDOB=""
"RTN","MPIFQ0",35,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",36,0)
 ;
"RTN","MPIFQ0",37,0)
 ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",38,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END
"RTN","MPIFQ0",39,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S MPIFRTN="TEST" G END
"RTN","MPIFQ0",40,0)
JUMP ;
"RTN","MPIFQ0",41,0)
 N TIME,%
"RTN","MPIFQ0",42,0)
 D NOW^%DTC S TIME=%
"RTN","MPIFQ0",43,0)
 ;Initialization for call to MPIVTQ
"RTN","MPIFQ0",44,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,RGDC
"RTN","MPIFQ0",45,0)
 ;If the HLP("ACKTIME") is not already set for the 
"RTN","MPIFQ0",46,0)
 I $G(HLP("ACKTIME"))="" S HLP("ACKTIME")=30
"RTN","MPIFQ0",47,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",48,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",49,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1
"RTN","MPIFQ0",50,0)
 S MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",51,0)
 ;
"RTN","MPIFQ0",52,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM,"00108.1;00108.2;00110;00122")
"RTN","MPIFQ0",53,0)
 ;If call to VTQ1^MPIFVTQ returns '-1^error code', log error and exit
"RTN","MPIFQ0",54,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",55,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0))
"RTN","MPIFQ0",56,0)
 . S MPIFRTN="CONTINUE"
"RTN","MPIFQ0",57,0)
 . W !!,"Patient should NOT be sent to the MPI for ICN assignment"
"RTN","MPIFQ0",58,0)
 ;
"RTN","MPIFQ0",59,0)
 ;Create MSH
"RTN","MPIFQ0",60,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFQ0",61,0)
 S HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",62,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",63,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",64,0)
 ;
"RTN","MPIFQ0",65,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFQ0",66,0)
 W !!,"Attempting to connect to the Master Patient Index in Austin..."
"RTN","MPIFQ0",67,0)
 W !,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFQ0",68,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","RGDC")
"RTN","MPIFQ0",69,0)
 ;kill the HLP array set for the ack timeout
"RTN","MPIFQ0",70,0)
 K HLP("ACKTIME")
"RTN","MPIFQ0",71,0)
 ;
"RTN","MPIFQ0",72,0)
 ;Can't connect to MPI, assign a local ICN, this site as CMOR, and
"RTN","MPIFQ0",73,0)
 ;continue with Registration
"RTN","MPIFQ0",74,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",75,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",76,0)
 . W !!,"Could not connect to MPI or Timed Out, assigning local ICN (if not already assigned)..."
"RTN","MPIFQ0",77,0)
 . D LOCAL(DFN)
"RTN","MPIFQ0",78,0)
 . S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",79,0)
 ;
"RTN","MPIFQ0",80,0)
 ;this is the array the data is parsed into for display in list manager
"RTN","MPIFQ0",81,0)
 K ^TMP("MPIFQ0",$J)
"RTN","MPIFQ0",82,0)
INIPARS ;
"RTN","MPIFQ0",83,0)
 N SEG,INDEX,COUNTER,LASTSSN,FIRST
"RTN","MPIFQ0",84,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFQ0",85,0)
PARSE ;
"RTN","MPIFQ0",86,0)
 S SEG=$$SEG^RGRSUTIL("RDT",1,"RDT")
"RTN","MPIFQ0",87,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFQ0",88,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,STRING,NAME,TF,ICN
"RTN","MPIFQ0",89,0)
 . N HEREICN,HERESSN,MIDDLE,IEN
"RTN","MPIFQ0",90,0)
 . S STRING=""
"RTN","MPIFQ0",91,0)
 . S FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2)
"RTN","MPIFQ0",92,0)
 . S MIDDLE=$P(SEG,HL("FS"),10)
"RTN","MPIFQ0",93,0)
 . S (LASTSSN,SSN)=$P(SEG,HL("FS"),3)
"RTN","MPIFQ0",94,0)
 . S NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFQ0",95,0)
 . I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFQ0",96,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFQ0",97,0)
 . I FIRST=1 S FICN=ICN
"RTN","MPIFQ0",98,0)
 . S FIRST=FIRST+1
"RTN","MPIFQ0",99,0)
 . S CMOR=$P(SEG,HL("FS"),5),CCMOR=CMOR
"RTN","MPIFQ0",100,0)
 . I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",101,0)
 . S TF=$P(SEG,HL("FS"),8),TF2=TF
"RTN","MPIFQ0",102,0)
 . I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",103,0)
 . ;
"RTN","MPIFQ0",104,0)
 . ;Same patient just adding TF's
"RTN","MPIFQ0",105,0)
 . I TF'="",ICN=FICN,FIRST'=2 D
"RTN","MPIFQ0",106,0)
 . . S SKIP="Y"
"RTN","MPIFQ0",107,0)
 . . S COUNTER=COUNTER+1
"RTN","MPIFQ0",108,0)
 . . S ^TMP("MPIFQ0",$J,INDEX,COUNTER)=TF
"RTN","MPIFQ0",109,0)
 . ;
"RTN","MPIFQ0",110,0)
 . Q:(ICN=FICN)&(FIRST>2)
"RTN","MPIFQ0",111,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFQ0",112,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFQ0",113,0)
 . I $G(BIRTHDAY)]"" D
"RTN","MPIFQ0",114,0)
 . . S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY)
"RTN","MPIFQ0",115,0)
 . . S BIRTHDAY=$$IN2EXDT^VAFCMGU0(BIRTHDAY,0)
"RTN","MPIFQ0",116,0)
 . ;
"RTN","MPIFQ0",117,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFQ0",118,0)
 . S INDEX=INDEX+1,COUNTER=1
"RTN","MPIFQ0",119,0)
 . S HEREICN=$$HEREICN($P(ICN,"V",1))
"RTN","MPIFQ0",120,0)
 . I HEREICN D
"RTN","MPIFQ0",121,0)
 . . S STRING=$$SETSTR^VALM1("*",STRING,1,1)
"RTN","MPIFQ0",122,0)
 . . S ^TMP("MPIFQ0",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",123,0)
 . S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4)
"RTN","MPIFQ0",124,0)
 . S STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",125,0)
 . S STRING=$$SETSTR^VALM1(SSN,STRING,30,9)
"RTN","MPIFQ0",126,0)
 . S STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",127,0)
 . S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",128,0)
 . S ^TMP("MPIFQ0",$J,INDEX,0)=STRING
"RTN","MPIFQ0",129,0)
 . S ^TMP("MPIFQ0",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",130,0)
 . S ^TMP("MPIFQ0",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF
"RTN","MPIFQ0",131,0)
 . S (VALMCNT,VALMLST)=INDEX
"RTN","MPIFQ0",132,0)
DECIDE ;
"RTN","MPIFQ0",133,0)
 ;I no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFQ0",134,0)
 ;with the VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",135,0)
 I '$D(^TMP("MPIFQ0",$J)) D  G EXIT
"RTN","MPIFQ0",136,0)
 . W !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",137,0)
 . D A28(DFN)
"RTN","MPIFQ0",138,0)
 . S MPIFRTN="DID A28"
"RTN","MPIFQ0",139,0)
 ;
"RTN","MPIFQ0",140,0)
 ;If INDEX=1 it means we got 1 match. So we check the SSN to
"RTN","MPIFQ0",141,0)
 ;see if it's definitely the same patient.
"RTN","MPIFQ0",142,0)
 I (INDEX=1)&(TSSN=LASTSSN) D  G EXIT
"RTN","MPIFQ0",143,0)
 . N CMOR,ICN,DATA,TICN
"RTN","MPIFQ0",144,0)
 . S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ0",145,0)
 . S CMOR=CCMOR
"RTN","MPIFQ0",146,0)
 . S ICN=$P(DATA,"^",4)
"RTN","MPIFQ0",147,0)
 . D START^RGHLLOG(0)
"RTN","MPIFQ0",148,0)
 . S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",149,0)
 . I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ0",150,0)
 . I TICN>0&(DFN'=TICN)
"RTN","MPIFQ0",151,0)
 . ; CHECK IF NAME IS SAME - IF NOT POTENTIAL MATCH EXCEPTION
"RTN","MPIFQ0",152,0)
 . I $P(DATA,"^")'=LOCDATA(2,DFN,.01) D  Q
"RTN","MPIFQ0",153,0)
 ..I $D(MPIFINT) D START^MPIFQ1(INDEX) Q
"RTN","MPIFQ0",154,0)
 ..I '$D(MPIFINIT) D LOC2(DFN) Q
"RTN","MPIFQ0",155,0)
 . W !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" in MPI, updating ICN and CMOR..."
"RTN","MPIFQ0",156,0)
 . D STOP^RGHLLOG(0)
"RTN","MPIFQ0",157,0)
 . D UPDATE(DFN,ICN,CMOR)
"RTN","MPIFQ0",158,0)
 . S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",159,0)
 ;
"RTN","MPIFQ0",160,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",161,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",162,0)
 .W !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",163,0)
 .D START^RGHLLOG(0)
"RTN","MPIFQ0",164,0)
 .D EXC^RGHLLOG(218,"For Patient DFN="_DFN_".  Use Single Patient Initialization to MPI option to manually process.",DFN)
"RTN","MPIFQ0",165,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIFQ0",166,0)
 .D LOCAL(DFN)
"RTN","MPIFQ0",167,0)
 .S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",168,0)
 ;
"RTN","MPIFQ0",169,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",170,0)
EXIT ;
"RTN","MPIFQ0",171,0)
 I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",172,0)
 K CCMOR
"RTN","MPIFQ0",173,0)
 H 3
"RTN","MPIFQ0",174,0)
 W !!
"RTN","MPIFQ0",175,0)
END ;
"RTN","MPIFQ0",176,0)
 Q
"RTN","MPIFQ0",177,0)
A28(DFN) ;
"RTN","MPIFQ0",178,0)
 S ICN=$$GETICN^MPIFRTC(DFN)
"RTN","MPIFQ0",179,0)
 I +ICN>0 W !!,"Adding Patient to Master Patient Index..." Q
"RTN","MPIFQ0",180,0)
 ;ASSIGN LOCAL ICN
"RTN","MPIFQ0",181,0)
 W !!,"Could not connect to MPI, Assigning Local ICN..."
"RTN","MPIFQ0",182,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",183,0)
 Q
"RTN","MPIFQ0",184,0)
 ;
"RTN","MPIFQ0",185,0)
UPDATE(DFN,ICN,CMOR) ;
"RTN","MPIFQ0",186,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG,LOCAL
"RTN","MPIFQ0",187,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",188,0)
 S CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ0",189,0)
 S ICN=$P(ICN,"V",1)
"RTN","MPIFQ0",190,0)
 S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",191,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",192,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",193,0)
 I +SETICN'>0 D  Q
"RTN","MPIFQ0",194,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0"
"RTN","MPIFQ0",195,0)
 S SETLOC=1,LOCAL="N"
"RTN","MPIFQ0",196,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",197,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",198,0)
 I +SETLOC'>0 D  Q
"RTN","MPIFQ0",199,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0"
"RTN","MPIFQ0",200,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",201,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",202,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",203,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFQ0",204,0)
 I +CHANGE'>0 D  Q
"RTN","MPIFQ0",205,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0"
"RTN","MPIFQ0",206,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",207,0)
 N HERE
"RTN","MPIFQ0",208,0)
 S HERE=+$P($$SITE^VASITE,"^",3)
"RTN","MPIFQ0",209,0)
 I '$$PATCH^XPDUTL("DG*5.3*261") D
"RTN","MPIFQ0",210,0)
 .I CMOR=HERE D TFLIST^MPIFBT2(CMOR,DFN)
"RTN","MPIFQ0",211,0)
 .; ^ add CMOR to treating facility list
"RTN","MPIFQ0",212,0)
 .I CMOR'=HERE D TFLIST^MPIFBT2(HERE,DFN),TFUPDT^MPIFBT2(DFN,0,0),INSERT^RGJCTS01(DFN)
"RTN","MPIFQ0",213,0)
 .; ^ not CMOR add site to Treating Facility list, add pivot file treating facility message and add subscription control message to event queue.
"RTN","MPIFQ0",214,0)
 I $$PATCH^XPDUTL("DG*5.3*261") D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ0",215,0)
 Q
"RTN","MPIFQ0",216,0)
 ;
"RTN","MPIFQ0",217,0)
LOCAL(DFN) ;
"RTN","MPIFQ0",218,0)
 N ICN
"RTN","MPIFQ0",219,0)
 Q:+$$GETICN^MPIF001(DFN)>0
"RTN","MPIFQ0",220,0)
 ;don't assign local if one already exists
"RTN","MPIFQ0",221,0)
 S ICN=$$ICNLC^MPIF001(DFN)
"RTN","MPIFQ0",222,0)
 Q
"RTN","MPIFQ0",223,0)
HEREICN(ICN) ;
"RTN","MPIFQ0",224,0)
 N DFN
"RTN","MPIFQ0",225,0)
 I $G(ICN)="" Q 0
"RTN","MPIFQ0",226,0)
 S DFN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",227,0)
 Q:$G(DFN)'>0 0
"RTN","MPIFQ0",228,0)
 Q DFN
"RTN","MPIFQ0",229,0)
TEST(SSN) ;
"RTN","MPIFQ0",230,0)
 N DFN
"RTN","MPIFQ0",231,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ0",232,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ0",233,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ0",234,0)
 Q DFN
"RTN","MPIFQ0",235,0)
HERESSN(X) ;
"RTN","MPIFQ0",236,0)
 N DFN,X,Y,DIC,D
"RTN","MPIFQ0",237,0)
 I $G(X)="" Q 0
"RTN","MPIFQ0",238,0)
 S DIC="^DPT(",D="SSN",DIC(0)="X"
"RTN","MPIFQ0",239,0)
 D MIX^DIC1
"RTN","MPIFQ0",240,0)
 Q:$G(Y)=-1 0
"RTN","MPIFQ0",241,0)
 Q $P(Y,"^",1)
"RTN","MPIFQ0",242,0)
 ;
"RTN","MPIFQ0",243,0)
GETDATA(DIC,DA,ARRAY,DR,EI) ;
"RTN","MPIFQ0",244,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",245,0)
 ;DIC is the file reference
"RTN","MPIFQ0",246,0)
 ;DA is the file entry IEN
"RTN","MPIFQ0",247,0)
 ;ARRAY is the storage array for the values to be stored in
"RTN","MPIFQ0",248,0)
 ;DR are the fields requested
"RTN","MPIFQ0",249,0)
 ;EI is external/internal values of the fields or dont return null values
"RTN","MPIFQ0",250,0)
 N DIQ
"RTN","MPIFQ0",251,0)
 S DIQ=ARRAY
"RTN","MPIFQ0",252,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",253,0)
 D EN^DIQ1
"RTN","MPIFQ0",254,0)
 Q
"RTN","MPIFQ0",255,0)
LOC2(DFN) ;
"RTN","MPIFQ0",256,0)
 W !!,"Potential Match Found Assigning Local ICN"
"RTN","MPIFQ0",257,0)
 D START^RGHLLOG()
"RTN","MPIFQ0",258,0)
 D EXC^RGHLLOG(218,"For Patient DFN="_DFN_" Use Single Patient Initialization to MPI option to manually process",DFN)
"RTN","MPIFQ0",259,0)
 D STOP^RGHLLOG()
"RTN","MPIFQ0",260,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",261,0)
 Q
"RTN","MPIFQUE3")
0^8^B51466593
"RTN","MPIFQUE3",1,0)
MPIFQUE3 ;SF/TNV-Generate Batch message for comparison of CMOR score ;FEB 27, 1998
"RTN","MPIFQUE3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3**;30 Apr 99
"RTN","MPIFQUE3",3,0)
 ;
"RTN","MPIFQUE3",4,0)
COMP ; Create a batch CMOR request for comparing the CMOR score with the owner
"RTN","MPIFQUE3",5,0)
 ; of this patient. This will be for ALL CMOR SITES. (NOT ONE SITE)
"RTN","MPIFQUE3",6,0)
 ;
"RTN","MPIFQUE3",7,0)
 N DIRUT
"RTN","MPIFQUE3",8,0)
 S DIR("A")="This process will take a while to complete. Are you sure? "
"RTN","MPIFQUE3",9,0)
 S DIR("B")="NO",DIR(0)="YAO" D ^DIR K DIR Q:$D(DIRUT)
"RTN","MPIFQUE3",10,0)
 I Y=0 K DIR Q                           ; no go
"RTN","MPIFQUE3",11,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),"^")'="" S $P(^("COMP"),"^")=""
"RTN","MPIFQUE3",12,0)
TASK ; Task this job to run
"RTN","MPIFQUE3",13,0)
 S ZTIO="",ZTRTN="EN^MPIFQUE3",ZTSAVE("DUZ")=""
"RTN","MPIFQUE3",14,0)
 S ZTDESC="GENERATE CMOR COMPARISON PROCESS"
"RTN","MPIFQUE3",15,0)
 D ^%ZTLOAD
"RTN","MPIFQUE3",16,0)
 I $D(ZTSK) W "   Task#, ",ZTSK," queued" S $P(^RGSITE(991.8,1,"COMP"),U,5)=ZTSK
"RTN","MPIFQUE3",17,0)
 ;
"RTN","MPIFQUE3",18,0)
KILL ; Clean up the partition
"RTN","MPIFQUE3",19,0)
 K DIR,ZTSK,Y,ZTIO,ZTRTN,ZTDESC,ZTSAVE
"RTN","MPIFQUE3",20,0)
 Q
"RTN","MPIFQUE3",21,0)
 ;
"RTN","MPIFQUE3",22,0)
EN ; Entry point for CMOR Batch comparison.  This should only be run after
"RTN","MPIFQUE3",23,0)
 ; the initialization to the MPI has been completed.
"RTN","MPIFQUE3",24,0)
 N U,SITE,NODE,MPI,MTIEN,MPILOOP,DTNOW,MSGCOUNT,LINCOUNT,RGLOG
"RTN","MPIFQUE3",25,0)
 S U="^",(MPILOOP,SITE)="",MPISTOP=0
"RTN","MPIFQUE3",26,0)
 D START^RGHLLOG()
"RTN","MPIFQUE3",27,0)
 N X,Y,DIC
"RTN","MPIFQUE3",28,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+DUZ
"RTN","MPIFQUE3",29,0)
 D ^DIC
"RTN","MPIFQUE3",30,0)
 I $G(Y)<1 S MPINAME=""
"RTN","MPIFQUE3",31,0)
 I $G(Y)>0 S MPINAME=$G(Y(0,0))
"RTN","MPIFQUE3",32,0)
 ; If the job has manually stopped status it should restart at where
"RTN","MPIFQUE3",33,0)
 ; it left off
"RTN","MPIFQUE3",34,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),U,4)="MS" D
"RTN","MPIFQUE3",35,0)
 . I $P($G(^RGSITE(991.8,1,"COMP")),U)="" S $P(^("COMP"),U,4)="C" Q  ; Not logical restart from the top
"RTN","MPIFQUE3",36,0)
 . S NODE=$$MPINODE^MPIFAPI(+$P(^RGSITE(991.8,1,"COMP"),U))
"RTN","MPIFQUE3",37,0)
 . S CMOR=$P(NODE,U,3)   ; CMOR of the last patient
"RTN","MPIFQUE3",38,0)
 . I +CMOR>0 S SITE=$O(^DPT("ACMOR",CMOR),-1)                        ; Back up one level
"RTN","MPIFQUE3",39,0)
 . I +CMOR>0 S MPILOOP=+$P(^RGSITE(991.8,1,"COMP"),U)                ; Marked the last patient
"RTN","MPIFQUE3",40,0)
 . I +CMOR<1 S (SITE,MPILOOP)=0
"RTN","MPIFQUE3",41,0)
 . K CMOR
"RTN","MPIFQUE3",42,0)
 ; If the job has completed status it should restart at the top
"RTN","MPIFQUE3",43,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),U,4)="C" S $P(^("COMP"),U)=""
"RTN","MPIFQUE3",44,0)
 ; Start the job
"RTN","MPIFQUE3",45,0)
 S ^XTMP("RGVCCMR","@@@@","DFNCOUNT")=0          ; set for counter in CALC^RGVCCMR2
"RTN","MPIFQUE3",46,0)
 D NOW^%DTC S Y=X X ^DD("DD") S DTNOW=Y          ; get current date and time
"RTN","MPIFQUE3",47,0)
 S $P(^RGSITE(991.8,1,"COMP"),U,2)=%             ; timestamp the job
"RTN","MPIFQUE3",48,0)
 S $P(^RGSITE(991.8,1,"COMP"),U,4)="R"           ; mark the status as running
"RTN","MPIFQUE3",49,0)
 S $P(^RGSITE(991.8,1,"COMP"),U,6)="N"           ; reset the flag
"RTN","MPIFQUE3",50,0)
 N RGDFN,CALDT,NODE
"RTN","MPIFQUE3",51,0)
 F  S SITE=$O(^DPT("ACMOR",SITE)) Q:SITE=""  D   ; Get the site CMOR on file
"RTN","MPIFQUE3",52,0)
 . Q:MPISTOP=1                                   ; Trouble occured, user wanted to stop
"RTN","MPIFQUE3",53,0)
 . I +SITE=+$$SITE^VASITE() Q                    ; Don't process your own
"RTN","MPIFQUE3",54,0)
 . D HDR                                         ; Create batch for each site
"RTN","MPIFQUE3",55,0)
 . F  S MPILOOP=$O(^DPT("ACMOR",+SITE,MPILOOP)) Q:MPILOOP=""  D  Q:MPISTOP=1  ; Start with DFN and go
"RTN","MPIFQUE3",56,0)
 . . S DFN=+MPILOOP Q:DFN<0
"RTN","MPIFQUE3",57,0)
 . . S NODE=$$MPINODE^MPIFAPI(DFN) Q:+NODE<1    ; Was not CIRN'ed
"RTN","MPIFQUE3",58,0)
 . . I $G(^DPT(DFN,.35)),$P($G(^DPT(DFN,.35)),"^")'="" Q  ; Death patient
"RTN","MPIFQUE3",59,0)
 . . I $P(NODE,"^")="" D LOG Q     ; Log exception if no ICN
"RTN","MPIFQUE3",60,0)
 . . S CALDT=$P(NODE,"^",7)   ; current calc date
"RTN","MPIFQUE3",61,0)
 . . I CALDT="" S CALDT=0
"RTN","MPIFQUE3",62,0)
 . . S X="T-90" D ^%DT
"RTN","MPIFQUE3",63,0)
 . . I CALDT<Y S RGDFN=DFN D CALC^RGVCCMR2   ; score is older than 90 days
"RTN","MPIFQUE3",64,0)
 . . S $P(^RGSITE(991.8,1,"COMP"),U)=+DFN        ; mark that patient as done
"RTN","MPIFQUE3",65,0)
 . . D INDV
"RTN","MPIFQUE3",66,0)
 . . I MSGCOUNT>99 D SEND D HDR                   ; send out if over 100 messages
"RTN","MPIFQUE3",67,0)
 . . I $P($G(^RGSITE(991.8,1,"COMP")),U,6)="Y" S MPISTOP=1 D SEND Q
"RTN","MPIFQUE3",68,0)
 . I $O(^TMP("HLS",$J,0)) D SEND ;**3
"RTN","MPIFQUE3",69,0)
 ;
"RTN","MPIFQUE3",70,0)
 ; if user asked to stop set flag = yes and status to MS
"RTN","MPIFQUE3",71,0)
 ; if naturally stop set status to SN
"RTN","MPIFQUE3",72,0)
 I MPISTOP=1 S $P(^RGSITE(991.8,1,"COMP"),U,6)="Y",$P(^("COMP"),U,4)="MS"
"RTN","MPIFQUE3",73,0)
 E  S $P(^RGSITE(991.8,1,"COMP"),U,4)="C"
"RTN","MPIFQUE3",74,0)
 D NOW^%DTC S $P(^RGSITE(991.8,1,"COMP"),U,3)=%  ; timestamp when it stop
"RTN","MPIFQUE3",75,0)
 D CLEAN
"RTN","MPIFQUE3",76,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE3",77,0)
 Q
"RTN","MPIFQUE3",78,0)
 ;
"RTN","MPIFQUE3",79,0)
HDR ; Create HL7 batch HEADER message to each of the CMOR site
"RTN","MPIFQUE3",80,0)
 K ^TMP("HLS",$J)
"RTN","MPIFQUE3",81,0)
 D INIT^HLFNC2("MPIF CMOR COMPARISON SERVER",.HL)
"RTN","MPIFQUE3",82,0)
 I $D(HL)=1 D EXC^RGHLLOG(220,"Error Returned in INIT^HLFNC2") K HL S MPISTOP=1 Q
"RTN","MPIFQUE3",83,0)
 D CREATE^HLTF(.HLMID,.MTIEN,.HLDT,.HLDT1)
"RTN","MPIFQUE3",84,0)
 I $D(MTIEN)="" D EXC^RGHLLOG(220,"Error Returned in CREATE^HLTF") K HLMID,HLDT,HLDT1 S MPISTOP=1 Q
"RTN","MPIFQUE3",85,0)
 S LINCOUNT=0                            ; Set line counter
"RTN","MPIFQUE3",86,0)
 S MSGCOUNT=1                            ; Set counter for 100 message per batch
"RTN","MPIFQUE3",87,0)
 Q
"RTN","MPIFQUE3",88,0)
 ;
"RTN","MPIFQUE3",89,0)
INDV ; Create individual message of the HL7 ADT-A31 batch message
"RTN","MPIFQUE3",90,0)
 ; EVN segment = event, date, CMOR score, requestor name
"RTN","MPIFQUE3",91,0)
 ; PID segment = standard call
"RTN","MPIFQUE3",92,0)
 ; NTE segment = Reason CMOR COMPARISON, site requested
"RTN","MPIFQUE3",93,0)
 D INIT^HLFNC2("MPIF CMOR COMPARISON SERVER",.HL)  ; Because HL7 did not know
"RTN","MPIFQUE3",94,0)
 S HL("SAF")=$P($$SITE^VASITE,"^",3)       ; the facility # when dynamic
"RTN","MPIFQUE3",95,0)
 ;                                              address of batch. This needs
"RTN","MPIFQUE3",96,0)
 ;                                              to be set. Until HL7 fixs it
"RTN","MPIFQUE3",97,0)
 S MPIID=HLMID_"-"_MSGCOUNT
"RTN","MPIFQUE3",98,0)
 D MSH^HLFNC2(.HL,MPIID,.MPI)
"RTN","MPIFQUE3",99,0)
 N NODE
"RTN","MPIFQUE3",100,0)
 S LINCOUNT=LINCOUNT+1
"RTN","MPIFQUE3",101,0)
 S ^TMP("HLS",$J,LINCOUNT)=MPI
"RTN","MPIFQUE3",102,0)
 S LINCOUNT=LINCOUNT+1
"RTN","MPIFQUE3",103,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIFQUE3",104,0)
 Q:+NODE<1
"RTN","MPIFQUE3",105,0)
 S ^TMP("HLS",$J,LINCOUNT)="EVN"_HL("FS")_"A31"_HL("FS")_$P(NODE,"^",7)_HL("FS")_$P(NODE,U,6)_HL("FS")_MPINAME
"RTN","MPIFQUE3",106,0)
 S LINCOUNT=LINCOUNT+1
"RTN","MPIFQUE3",107,0)
 S ^TMP("HLS",$J,LINCOUNT)=$$EN^VAFCPID(DFN,"2,3,5")
"RTN","MPIFQUE3",108,0)
 S LINCOUNT=LINCOUNT+1
"RTN","MPIFQUE3",109,0)
 ;this is the request to the site for a comparison
"RTN","MPIFQUE3",110,0)
 S ^TMP("HLS",$J,LINCOUNT)="NTE"_HL("FS")_"COMPARISON"_HL("FS")_$P($$SITE^VASITE(),U,3)
"RTN","MPIFQUE3",111,0)
 S MSGCOUNT=MSGCOUNT+1
"RTN","MPIFQUE3",112,0)
 Q
"RTN","MPIFQUE3",113,0)
 ;
"RTN","MPIFQUE3",114,0)
SEND ; Send out the batch message
"RTN","MPIFQUE3",115,0)
 N RESLT
"RTN","MPIFQUE3",116,0)
 D GENERATE^HLMA("MPIF CMOR COMPARISON SERVER","GB",1,.RESLT,MTIEN)
"RTN","MPIFQUE3",117,0)
 I $P(RESLT,U,2)'="" D EXC^RGHLLOG(220,"Error Returned in GENERATE^HLMA "_$P(RESLT,U,2)) S MPISTOP=1
"RTN","MPIFQUE3",118,0)
 Q
"RTN","MPIFQUE3",119,0)
 ;
"RTN","MPIFQUE3",120,0)
LOGIC ; This is where the dynamic address located. 
"RTN","MPIFQUE3",121,0)
 ; ** Routing logic field in Protocol file is being used
"RTN","MPIFQUE3",122,0)
 ; instead of GET^HLSUB.
"RTN","MPIFQUE3",123,0)
 ; For now, I have to hard set the receiving logical link, intercept
"RTN","MPIFQUE3",124,0)
 ; the message before it send out, figure out the receiving Logical
"RTN","MPIFQUE3",125,0)
 ; link from the MSH segment and let the Routing logic create the
"RTN","MPIFQUE3",126,0)
 ; HLL("LINKS") array.
"RTN","MPIFQUE3",127,0)
 N RESLT
"RTN","MPIFQUE3",128,0)
 K RGL,RESLT
"RTN","MPIFQUE3",129,0)
 D LINK^HLUTIL3(SITE,.RGL)               ; get the logical link to that institution
"RTN","MPIFQUE3",130,0)
 S INSTITU=$O(RGL(0))
"RTN","MPIFQUE3",131,0)
 I INSTITU<1 Q                           ; if there is no logical link
"RTN","MPIFQUE3",132,0)
 I $E($G(RGL(INSTITU)),1,2)'="VA" D
"RTN","MPIFQUE3",133,0)
 .D START^RGHLLOG()
"RTN","MPIFQUE3",134,0)
 .D EXC^RGHLLOG(224,"Can't send CMOR Comparison message to site, due to non-CIRN logical link for site "_INSTITU)
"RTN","MPIFQUE3",135,0)
 .D STOP^RGHLLOG()
"RTN","MPIFQUE3",136,0)
 .S RESLT=1
"RTN","MPIFQUE3",137,0)
 Q:$D(RESLT)
"RTN","MPIFQUE3",138,0)
 S HLL("LINKS",1)="MPIF CMOR COMPARISON CLIENT"_HL("FS")_RGL(INSTITU)
"RTN","MPIFQUE3",139,0)
 K INSTITU,RGL
"RTN","MPIFQUE3",140,0)
 Q
"RTN","MPIFQUE3",141,0)
 ;
"RTN","MPIFQUE3",142,0)
CLEAN ; Clean up the partition
"RTN","MPIFQUE3",143,0)
 K %,X,Y,MPISTOP,MPINAME,DFN,MPIID
"RTN","MPIFQUE3",144,0)
 K ^XTMP("HLS",$J)
"RTN","MPIFQUE3",145,0)
 Q
"RTN","MPIFQUE3",146,0)
 ;
"RTN","MPIFQUE3",147,0)
LOG ; Log exception for non ICN but CMOR belong to someone else
"RTN","MPIFQUE3",148,0)
 N NAME,SSN,RGLOG,TEXT
"RTN","MPIFQUE3",149,0)
 S XMCHAN=1,NAME=$P(^DPT(DFN,0),"^",1),SSN=$P(^(0),"^",9)
"RTN","MPIFQUE3",150,0)
 S TEXT="This patient "_NAME_" ssn# "_SSN_" is missing the ICN. Log a NOIS regarding this missing ICN."
"RTN","MPIFQUE3",151,0)
 D EXC^RGHLLOG(219,TEXT,DFN)
"RTN","MPIFQUE3",152,0)
 K XMCHAN
"RTN","MPIFQUE3",153,0)
 Q
"RTN","MPIFQUE3",154,0)
 ;
"RTN","MPIFQUE3",155,0)
STOP ; Stop/Restart the CMOR Comparison process
"RTN","MPIFQUE3",156,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),"^",4)'="R" D  Q
"RTN","MPIFQUE3",157,0)
 . S DIR("A")="Do you want to RESTART this CMOR Comparison process"
"RTN","MPIFQUE3",158,0)
 . S DIR("B")="N",DIR(0)="Y" D ^DIR
"RTN","MPIFQUE3",159,0)
 . I $G(Y)=1 D TASK
"RTN","MPIFQUE3",160,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),"^",4)="R" D  Q
"RTN","MPIFQUE3",161,0)
 . W !
"RTN","MPIFQUE3",162,0)
 . S DIR("A")="Do you want to stop CMOR Comparison process after the current patient"
"RTN","MPIFQUE3",163,0)
 . S DIR("B")="N",DIR(0)="Y" D ^DIR
"RTN","MPIFQUE3",164,0)
 . I $G(Y)=1 S $P(^RGSITE(991.8,1,"COMP"),"^",6)="Y"
"RTN","MPIFQUE3",165,0)
 Q
"RTN","MPIFQUE3",166,0)
 ;
"RTN","MPIFQUE3",167,0)
STATUS ; Where is the process right now?
"RTN","MPIFQUE3",168,0)
 N IEN,NAME,SSN,STATUS,Y
"RTN","MPIFQUE3",169,0)
 I $P($G(^RGSITE(991.8,1,"COMP")),"^",5)="" W !,"The CMOR Comparison process HAS NEVER been tasked" Q
"RTN","MPIFQUE3",170,0)
 W !,"The CMOR Comparison process has been tasked with task # ",$P($G(^RGSITE(991.8,1,"COMP")),"^",5),". The"
"RTN","MPIFQUE3",171,0)
 S STATUS=$P($G(^RGSITE(991.8,1,"COMP")),"^",4)
"RTN","MPIFQUE3",172,0)
 W !,"process ",$S(STATUS="R":"is currently running",STATUS="MS":"was manually stopped",STATUS="C":"has completed",1:"")
"RTN","MPIFQUE3",173,0)
 I (STATUS="C")!(STATUS="MS") S Y=$P($G(^RGSITE(991.8,1,"COMP")),"^",3) X ^DD("DD") W " on ",Y
"RTN","MPIFQUE3",174,0)
 S IEN=$P($G(^RGSITE(991.8,1,"COMP")),"^")
"RTN","MPIFQUE3",175,0)
 I IEN'="" D
"RTN","MPIFQUE3",176,0)
 .S NAME=$P($G(^DPT(+IEN,0)),"^"),SSN=$P($G(^(0)),"^",9)
"RTN","MPIFQUE3",177,0)
 .S CMOR=$P($G(^DPT(+IEN,"MPI")),"^",3)
"RTN","MPIFQUE3",178,0)
 .S CMOR=$P($$NNT^XUAF4(CMOR),"^")
"RTN","MPIFQUE3",179,0)
 .W " and the last patient",!,"was ",NAME," ssn # ",SSN," CMOR= ",CMOR
"RTN","MPIFQUE3",180,0)
 Q
"RTN","MPIFQUE3",181,0)
 ;
"RTN","MPIFQUE4")
0^10^B52636193
"RTN","MPIFQUE4",1,0)
MPIFQUE4 ;SF/TNV-Process the CMOR COMPARISON request ;FEB 25, 1998
"RTN","MPIFQUE4",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3**;30 Apr 99
"RTN","MPIFQUE4",3,0)
 ; 
"RTN","MPIFQUE4",4,0)
 ; This routine will process the batch message from the sending CMOR
"RTN","MPIFQUE4",5,0)
 ; who wished to change the patient CMOR from you to their own.
"RTN","MPIFQUE4",6,0)
 ; PLEASE NOTE THAT THIS PROCESS WILL NOT BE TRACKED AS CMOR REQUEST
"RTN","MPIFQUE4",7,0)
 ; EVENT. SO NOTHING WILL BE RECORDED IN THAT FILE. (PER SRS 9-18-97)
"RTN","MPIFQUE4",8,0)
 ; Approving process:
"RTN","MPIFQUE4",9,0)
 ; The sender will give the CMOR score and the date for a patient
"RTN","MPIFQUE4",10,0)
 ; The receiver will look into the CMOR score on the system and compare
"RTN","MPIFQUE4",11,0)
 ; the date if the date is less than 90 days. Go and use the Current
"RTN","MPIFQUE4",12,0)
 ; CMOR score and compare. If the incoming CMOR score is 80% or more than
"RTN","MPIFQUE4",13,0)
 ; the system CMOR score. CMOR site will be changed to the requesting CMOR
"RTN","MPIFQUE4",14,0)
 ; site. An approved HL7 message will be send to ALL SITES in the
"RTN","MPIFQUE4",15,0)
 ; subscriber list and notify them the new CMOR site. MPI is included.
"RTN","MPIFQUE4",16,0)
 ; If the score is equal or greater than 90 days. CMOR score will be
"RTN","MPIFQUE4",17,0)
 ; recalulated for this patient and compare. Same process as above.
"RTN","MPIFQUE4",18,0)
 ; If the incoming CMOR score is not higher than 80% nothing will happen.
"RTN","MPIFQUE4",19,0)
BEGIN ; Entry point for CMOR COMPARISON request to process.
"RTN","MPIFQUE4",20,0)
 ; NO input or output variables
"RTN","MPIFQUE4",21,0)
 N IEN,RGLOG
"RTN","MPIFQUE4",22,0)
 K RGL
"RTN","MPIFQUE4",23,0)
 D NOW^%DTC
"RTN","MPIFQUE4",24,0)
 S ZTIO="",ZTDTH=%,ZTRTN="EN^MPIFQUE4"
"RTN","MPIFQUE4",25,0)
 S ZTDESC="BACKGROUND CMOR COMPARISON"
"RTN","MPIFQUE4",26,0)
 S ZTSAVE("HL*")=""
"RTN","MPIFQUE4",27,0)
 D ^%ZTLOAD,CLEAN
"RTN","MPIFQUE4",28,0)
 K COUNT,RGL,%,ZTIO,ZTDTH,ZTRTN,ZTDESC,ZTSAVE
"RTN","MPIFQUE4",29,0)
 Q
"RTN","MPIFQUE4",30,0)
 ;
"RTN","MPIFQUE4",31,0)
EN ; Background job to run for cmor comparison
"RTN","MPIFQUE4",32,0)
 K ERROR,MPICNT
"RTN","MPIFQUE4",33,0)
 N MPII,U,LINE,PARENT,COUNT,NDATE,IKI,MPIFFS,MPIFSFS,MPIFREAP,RGLOG
"RTN","MPIFQUE4",34,0)
 S MPIFFS=HL("FS"),MPIFSFS=$E(HL("ECH"),1),MPIFREAP=$E(HL("ECH"),2)
"RTN","MPIFQUE4",35,0)
 D START^RGHLLOG()
"RTN","MPIFQUE4",36,0)
 S U="^",(COUNT,MPICNT)=0
"RTN","MPIFQUE4",37,0)
 F MPII=1:1 X HLNEXT Q:HLQUIT'>0!($D(ERROR))  G:$$S^%ZTLOAD CLEAN D
"RTN","MPIFQUE4",38,0)
 . S LINE=HLNODE
"RTN","MPIFQUE4",39,0)
 . I $P(LINE,MPIFFS)["MSH" D MSH
"RTN","MPIFQUE4",40,0)
 . I $P(LINE,MPIFFS)["NTE" D NTE
"RTN","MPIFQUE4",41,0)
 . I $P(LINE,MPIFFS)["PID" D PID
"RTN","MPIFQUE4",42,0)
 . I $P(LINE,MPIFFS)["EVN" D EVN
"RTN","MPIFQUE4",43,0)
 . I COUNT=4,'$D(ERROR) D PROCES
"RTN","MPIFQUE4",44,0)
 K SERVER,CLIENT,ERROR
"RTN","MPIFQUE4",45,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE4",46,0)
 Q
"RTN","MPIFQUE4",47,0)
 ;
"RTN","MPIFQUE4",48,0)
MSH ; Process MSH segment
"RTN","MPIFQUE4",49,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",50,0)
 Q
"RTN","MPIFQUE4",51,0)
 ;
"RTN","MPIFQUE4",52,0)
NTE ; Process NTE segment
"RTN","MPIFQUE4",53,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",54,0)
 S SITE=$P(LINE,MPIFFS,3)
"RTN","MPIFQUE4",55,0)
 I SITE="" S ERROR="HL7 Msg# "_$G(HL("MID"))_" is missing CMOR for ICN# "_$G(ICN) D EXC^RGHLLOG(221,ERROR) Q
"RTN","MPIFQUE4",56,0)
 S REASON=$P(LINE,MPIFFS,2)
"RTN","MPIFQUE4",57,0)
 I REASON'="COMPARISON" S ERROR="HL7 Msg# "_$G(HL("MID"))_" contained a unknown request reason for ICN# "_$G(ICN) D EXC^RGHLLOG(222,ERROR)
"RTN","MPIFQUE4",58,0)
 Q
"RTN","MPIFQUE4",59,0)
 ;
"RTN","MPIFQUE4",60,0)
PID ; Process PID segment
"RTN","MPIFQUE4",61,0)
 N NODE
"RTN","MPIFQUE4",62,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",63,0)
 S ICN=+$P(LINE,MPIFFS,3)   ; get ICN out.
"RTN","MPIFQUE4",64,0)
 I ICN="" S ERROR="HL7 Msg# "_$G(HL("MID"))_" contains a null ICN in a PID segment." D EXC^RGHLLOG(219,ERROR) Q
"RTN","MPIFQUE4",65,0)
 S DFN=$$IEN^MPIFNQ(ICN)                  ; get DFN of this patient
"RTN","MPIFQUE4",66,0)
 I DFN="" S ERROR="Can't Process CMOR Compare for Patient with ICN "_ICN_". ICN not at this site. HL7 Message#: "_HLMTIEN D EXC^RGHLLOG(219,ERROR) Q
"RTN","MPIFQUE4",67,0)
 S NODE=$$MPINODE^MPIFAPI(+DFN)
"RTN","MPIFQUE4",68,0)
 S CMOR=$P(NODE,"^",3)               ; get the CMOR of this patient
"RTN","MPIFQUE4",69,0)
 S SCORE=$P(NODE,"^",6),NDATE=$P(NODE,"^",7)
"RTN","MPIFQUE4",70,0)
 ; if no score or score date recalc score and reset variables
"RTN","MPIFQUE4",71,0)
 I SCORE=""!(NDATE="") N RGDFN S RGDFN=DFN D CALC^RGVCCMR2
"RTN","MPIFQUE4",72,0)
 S NODE=$$MPINODE^MPIFAPI(+DFN),SCORE=$P(NODE,"^",6),NDATE=$P(NODE,"^",7)
"RTN","MPIFQUE4",73,0)
 Q
"RTN","MPIFQUE4",74,0)
 ;
"RTN","MPIFQUE4",75,0)
EVN ; Process EVN segment
"RTN","MPIFQUE4",76,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",77,0)
 S X=$P(LINE,MPIFFS,3) D ^%DT S INDATE=Y
"RTN","MPIFQUE4",78,0)
 I INDATE=-1 S ERROR="CMOR score Date was missing for DFN "_DFN_" in CMOR Compare Inbound Message" Q
"RTN","MPIFQUE4",79,0)
 S INSCORE=$P($G(LINE),MPIFFS,4)
"RTN","MPIFQUE4",80,0)
 I INSCORE="" S INSCORE=0
"RTN","MPIFQUE4",81,0)
 Q
"RTN","MPIFQUE4",82,0)
 ;
"RTN","MPIFQUE4",83,0)
PROCES ; Process one complete message (MSH,PID,EVN,NTE)
"RTN","MPIFQUE4",84,0)
 N LIMIT
"RTN","MPIFQUE4",85,0)
 I $G(ERROR)]"" D CLEAN Q                ; Don't do anything if there is an error
"RTN","MPIFQUE4",86,0)
 S X="T-90" D ^%DT                       ; get the target date
"RTN","MPIFQUE4",87,0)
 I NDATE>Y D  Q                           ; RECORDED DATE is less than 90 days
"RTN","MPIFQUE4",88,0)
 . S LIMIT=$$PERCENT(INSCORE,SCORE)      ; Incoming CMOR score is above 80%
"RTN","MPIFQUE4",89,0)
 . I (LIMIT>80.5)&(INSCORE>SCORE) D CHANGE                 ; Incoming CMOR score is greater
"RTN","MPIFQUE4",90,0)
 . D CLEAN                               ; Incoming CMOR score is LESS
"RTN","MPIFQUE4",91,0)
 N RGDFN S RGDFN=DFN D CALC^RGVCCMR2                         ; Last calculation was greater than 90 days
"RTN","MPIFQUE4",92,0)
 S SCORE=$P($$MPINODE^MPIFAPI(DFN),"^",6)    ; Get the latest score
"RTN","MPIFQUE4",93,0)
 S LIMIT=$$PERCENT(INSCORE,SCORE)        ; Incoming CMOR score is above 80%
"RTN","MPIFQUE4",94,0)
 I (LIMIT>80.5)&(INSCORE>SCORE) D CHANGE                   ; Incoming CMOR score is greater
"RTN","MPIFQUE4",95,0)
 D CLEAN                                 ; Incoming CMOR score is LESS than the latest score
"RTN","MPIFQUE4",96,0)
 Q
"RTN","MPIFQUE4",97,0)
 ;
"RTN","MPIFQUE4",98,0)
PERCENT(NUM1,NUM2) ; Calculate the percent difference 80% or more need for change
"RTN","MPIFQUE4",99,0)
 ; of CMOR number
"RTN","MPIFQUE4",100,0)
 N DIF
"RTN","MPIFQUE4",101,0)
 I NUM1="" S NUM1=0
"RTN","MPIFQUE4",102,0)
 I NUM2="" S NUM2=0
"RTN","MPIFQUE4",103,0)
 Q:$$MAX^XLFMTH(NUM1,NUM2)=0 0
"RTN","MPIFQUE4",104,0)
 S DIF=(100-(($$MIN^XLFMTH(NUM1,NUM2))/($$MAX^XLFMTH(NUM1,NUM2))*100))
"RTN","MPIFQUE4",105,0)
 Q DIF
"RTN","MPIFQUE4",106,0)
 ;
"RTN","MPIFQUE4",107,0)
CHANGE ; Process the change CMOR request to the new CMOR site and Send out 
"RTN","MPIFQUE4",108,0)
 ; notification to the Subscriber list and MPI.
"RTN","MPIFQUE4",109,0)
 N CHANGE,MPIFSITE S MPIFSITE=$$LKUP^XUAF4(SITE)  ;get INSTITUTION (#4) IEN
"RTN","MPIFQUE4",110,0)
 I MPIFSITE=-1 S ERROR="HL7 Msg#"_$G(HL("MID"))_" contained an invalid STATION#"_$G(SITE)_" for ICN#"_$G(ICN) D EXC^RGHLLOG(211,ERROR,+DFN) Q
"RTN","MPIFQUE4",111,0)
 S CHANGE=$$CHANGE^MPIF001(+DFN,MPIFSITE)
"RTN","MPIFQUE4",112,0)
 I +CHANGE<1 S ERROR="Unable to change CMOR in HL7 Msg#"_$G(HL("MID"))_" from "_$P($$SITE^VASITE,"^",3)_" To "_$G(SITE)_" due to "_$P(CHANGE,"^",2) D EXC^RGHLLOG(211,ERROR,DFN) Q
"RTN","MPIFQUE4",113,0)
 S SERVER="MPIF CMOR RESULT SERVER",CLIENT="MPIF CMOR RESULT CLIENT"
"RTN","MPIFQUE4",114,0)
 D INIT^HLFNC2(SERVER,.HL)
"RTN","MPIFQUE4",115,0)
 I $G(HL) S ERROR=HL D EXC^RGHLLOG(220,ERROR) Q
"RTN","MPIFQUE4",116,0)
 D LINK
"RTN","MPIFQUE4",117,0)
 I $G(RESULT)=0 K RESULT Q
"RTN","MPIFQUE4",118,0)
 S HLA("HLS",1)=$$EN^VAFCPID(+DFN,"2,3,4,5,6,7,8,9,10")
"RTN","MPIFQUE4",119,0)
 S HLA("HLS",2)="EVN"_HL("FS")_"A31"_HL("FS")_INDATE_HL("FS")_INSCORE_HL("FS")_"POSTMASTER"
"RTN","MPIFQUE4",120,0)
 ;actually change the cmor
"RTN","MPIFQUE4",121,0)
 S HLA("HLS",3)="PV1"_HL("FS")_HL("FS")_HL("FS")_SITE_HL("FS")_HL("FS")_HL("FS")_$P($$NNT^XUAF4(CMOR),"^",2)
"RTN","MPIFQUE4",122,0)
 N RESLT
"RTN","MPIFQUE4",123,0)
 D GENERATE^HLMA(SERVER,"LM",1,.RESLT)
"RTN","MPIFQUE4",124,0)
 I $P(RESLT,U,2)'="" D EXC^RGHLLOG(220,"Error returned in GENERATE^HLMA  "_$P(RESLT,U,2))
"RTN","MPIFQUE4",125,0)
 K RESULT
"RTN","MPIFQUE4",126,0)
 S MPICNT=MPICNT+1 ;counting changes in CMOR
"RTN","MPIFQUE4",127,0)
 Q
"RTN","MPIFQUE4",128,0)
 ;
"RTN","MPIFQUE4",129,0)
LINK ; Give back the subscriber list in HLL(LINKS") array for this patient
"RTN","MPIFQUE4",130,0)
 N SUB,IEN,MPILINK,MPITF
"RTN","MPIFQUE4",131,0)
 K RGL
"RTN","MPIFQUE4",132,0)
 S RGL(0)=""
"RTN","MPIFQUE4",133,0)
 S RESULT=0
"RTN","MPIFQUE4",134,0)
 ;first make sure the sending site has a subscription
"RTN","MPIFQUE4",135,0)
 D CHKSUB($G(DFN),$$LKUP^XUAF4(SITE))
"RTN","MPIFQUE4",136,0)
 ;get all TF's before sending response  dbia# 2990
"RTN","MPIFQUE4",137,0)
 I '$$PATCH^XPDUTL("DG*5.3*261") S X=$$QUERYTF^VAFCTFU($G(ICN),"MPITF")
"RTN","MPIFQUE4",138,0)
 I $$PATCH^XPDUTL("DG*5.3*261") S X=$$QUERYTF^VAFCTFU1($G(ICN),"MPITF")
"RTN","MPIFQUE4",139,0)
 ;loop through checking TF's for subscriptions
"RTN","MPIFQUE4",140,0)
 S X=0 F  S X=$O(MPITF(X)) Q:'X  I +MPITF(X)'=+$$SITE^VASITE D CHKSUB($G(DFN),+MPITF(X))
"RTN","MPIFQUE4",141,0)
 S SUB=$P($$MPINODE^MPIFAPI(+DFN),U,5)    ; Subscriber list
"RTN","MPIFQUE4",142,0)
 I SUB="" D EXC^RGHLLOG(224,"No Subscription list") Q
"RTN","MPIFQUE4",143,0)
 S MPILINK=$$MPILINK^MPIFAPI()
"RTN","MPIFQUE4",144,0)
 I MPILINK="" D EXC^RGHLLOG(224,"No MPI Link defined") Q
"RTN","MPIFQUE4",145,0)
 D GET^HLSUB(SUB,"",CLIENT,.HLL)
"RTN","MPIFQUE4",146,0)
 S RESULT=1,HLL("LINKS",9999)=CLIENT_U_MPILINK
"RTN","MPIFQUE4",147,0)
 Q
"RTN","MPIFQUE4",148,0)
CLEAN ; Clean up the partition and ready for the next message
"RTN","MPIFQUE4",149,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE4",150,0)
 K RGL,EVENT,SITE,REASON,ICN,DFN,CMOR,SCORE,X,Y,INDATE,INSCORE
"RTN","MPIFQUE4",151,0)
 S COUNT=0
"RTN","MPIFQUE4",152,0)
 Q
"RTN","MPIFQUE4",153,0)
CHKSUB(DFN,FAC) ;check for an existing subscription if one does not exist add it
"RTN","MPIFQUE4",154,0)
 N MPIFSCN,MPIF,MPIFLL,MPIFLLI,MPIFLLN,FLAG,LOOP,HLER
"RTN","MPIFQUE4",155,0)
 Q:FAC=""
"RTN","MPIFQUE4",156,0)
 Q:DFN=""
"RTN","MPIFQUE4",157,0)
 Q:FAC=+$$SITE^VASITE  ;don't add subscription for yourself
"RTN","MPIFQUE4",158,0)
 S MPIFSCN=$$GETSCN(DFN)
"RTN","MPIFQUE4",159,0)
 D GET^HLSUB(MPIFSCN,0,"MPIF CMOR RESULT CLIENT",.MPIFLL)
"RTN","MPIFQUE4",160,0)
 D LINK^HLUTIL3("`"_FAC,.MPIF,"I") S MPIFLLI=$O(MPIF(0)) S MPIFLLN=MPIF(MPIFLLI)
"RTN","MPIFQUE4",161,0)
 S FLAG=0,LOOP=0 F  S LOOP=$O(MPIFLL("LINKS",LOOP)) Q:'LOOP  I $P(MPIFLL("LINKS",LOOP),"^",2)=MPIFLLN S FLAG=1
"RTN","MPIFQUE4",162,0)
 I FLAG=0 D UPD^HLSUB(MPIFSCN,MPIFLLN,0,$$NOW^XLFDT,,,.HLER)
"RTN","MPIFQUE4",163,0)
 I $D(HLER) D EXC^RGHLLOG(224,"Msg#"_$G(HL("MID"))_" Unable to add/update SC for facility IEN "_FAC_", Link "_$G(MPIFLLN)_", ICN#"_$G(MPIFSCN),DFN) D STOP^RGHLLOG(1) Q  ; log exception
"RTN","MPIFQUE4",164,0)
 Q
"RTN","MPIFQUE4",165,0)
GETSCN(DFN) ;Return existing SCN or Activate a new subscription
"RTN","MPIFQUE4",166,0)
 ;DFN - PATIENT (#2) file ien
"RTN","MPIFQUE4",167,0)
 N MPIFAR,MPIFAN
"RTN","MPIFQUE4",168,0)
 ;get subscription control #
"RTN","MPIFQUE4",169,0)
 S MPIFSCN=+$P($$MPINODE^MPIFAPI(DFN),"^",5)
"RTN","MPIFQUE4",170,0)
 ;if no SCN, create new and update 991.05, then return result
"RTN","MPIFQUE4",171,0)
 I 'MPIFSCN S MPIFSCN=$$ACT^HLSUB S MPIFAR(991.05)=MPIFSCN S MPIFAN=$$UPDATE^MPIFAPI(DFN,"MPIFAR") I MPIFAN=-1 S MPIFSCN=""
"RTN","MPIFQUE4",172,0)
 Q MPIFSCN
"RTN","MPIFSAQ")
0^9^B72806558
"RTN","MPIFSAQ",1,0)
MPIFSAQ ;SF/CMC-STAND ALONE QUERY ;JAN 12, 1998
"RTN","MPIFSAQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3**;30 Apr 99
"RTN","MPIFSAQ",3,0)
 ;
"RTN","MPIFSAQ",4,0)
INTACTV ;Interactive standalone query - Display Only!
"RTN","MPIFSAQ",5,0)
 ;patient doesn't have to be in Patient file
"RTN","MPIFSAQ",6,0)
 ;
"RTN","MPIFSAQ",7,0)
 K DIR,X,Y
"RTN","MPIFSAQ",8,0)
 S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is Patient in the PATIENT file? "
"RTN","MPIFSAQ",9,0)
 D ^DIR
"RTN","MPIFSAQ",10,0)
 G:(Y'=1)&(Y'=0) END
"RTN","MPIFSAQ",11,0)
 I Y=1 D PAT(.MPIVAR)
"RTN","MPIFSAQ",12,0)
 I Y'=1,'$D(MPIVAR) D NOPAT(.MPIVAR)
"RTN","MPIFSAQ",13,0)
 G:+$G(MPIVAR("DOB"))'>0 END
"RTN","MPIFSAQ",14,0)
 D VTQ(.MPIVAR)
"RTN","MPIFSAQ",15,0)
 K DIR,X,Y,MPIVAR
"RTN","MPIFSAQ",16,0)
 Q
"RTN","MPIFSAQ",17,0)
END ;
"RTN","MPIFSAQ",18,0)
 K DIR,X,Y,MPIVAR,DIRUT,DTOUT,DUOUT
"RTN","MPIFSAQ",19,0)
 Q
"RTN","MPIFSAQ",20,0)
 ;
"RTN","MPIFSAQ",21,0)
CLEAN(NAM) ;
"RTN","MPIFSAQ",22,0)
 ;NAM is the name to be cleaned up
"RTN","MPIFSAQ",23,0)
 ; Returned from this function is a clean name
"RTN","MPIFSAQ",24,0)
 N YY,I
"RTN","MPIFSAQ",25,0)
 ; -- only uppercase
"RTN","MPIFSAQ",26,0)
 I NAM?.E1L.E F I=1:1:$L(NAM) S:$E(NAM,I)?1L NAM=$E(NAM,0,I-1)_$C($A(NAM,I)-32)_$E(NAM,I+1,$L(NAM))
"RTN","MPIFSAQ",27,0)
 ; -- no space after comma and no double spaces
"RTN","MPIFSAQ",28,0)
 F YY=", ","  " F  Q:'$F(NAM,YY)  S NAM=$E(NAM,1,($F(NAM,YY)-2))_$E(NAM,$F(NAM,YY),$L(NAM))
"RTN","MPIFSAQ",29,0)
 ; -- no space at the end
"RTN","MPIFSAQ",30,0)
 F  Q:$E(NAM,$L(NAM))'=" "  S NAM=$E(NAM,1,$L(NAM)-1)
"RTN","MPIFSAQ",31,0)
 Q NAM
"RTN","MPIFSAQ",32,0)
 ;
"RTN","MPIFSAQ",33,0)
PAT(MPIVAR) ;
"RTN","MPIFSAQ",34,0)
 ;patient is in local Patient file
"RTN","MPIFSAQ",35,0)
PATA N DIC,X,Y,DIQ,DR,DA,ARRAY,DFN,DTOUT,DUOUT
"RTN","MPIFSAQ",36,0)
 S DIC="^DPT(",DIC(0)="AEQZM",DIC("A")="Patient Name: "
"RTN","MPIFSAQ",37,0)
 D ^DIC
"RTN","MPIFSAQ",38,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",39,0)
 I +Y=-1 W !,"Patient not found.  Try Again" G PATA
"RTN","MPIFSAQ",40,0)
 S (DFN,MPIVAR("DFN"))=+Y,MPIVAR("NM")=$P(Y(0),"^")
"RTN","MPIFSAQ",41,0)
 S DIQ="ARRAY",DR=".09;.03",DIC="^DPT(",DA=+Y,DIQ(0)="I"
"RTN","MPIFSAQ",42,0)
 D EN^DIQ1
"RTN","MPIFSAQ",43,0)
 S MPIVAR("DOB")=$G(ARRAY(2,DFN,.03,"I"))
"RTN","MPIFSAQ",44,0)
 S MPIVAR("SSN")=$G(ARRAY(2,DFN,.09,"I")) I MPIVAR("SSN")["P" S MPIVAR("SSN")=""
"RTN","MPIFSAQ",45,0)
 Q
"RTN","MPIFSAQ",46,0)
 ;
"RTN","MPIFSAQ",47,0)
NOPAT(MPIVAR) ;
"RTN","MPIFSAQ",48,0)
 ; patient is not in the local Patient file
"RTN","MPIFSAQ",49,0)
NAME N DTOUT,DUOUT,DIR,X,Y
"RTN","MPIFSAQ",50,0)
 S DIR(0)="FU^::",DIR("A")="PATIENT NAME (last,first middle)"
"RTN","MPIFSAQ",51,0)
 D ^DIR
"RTN","MPIFSAQ",52,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",53,0)
 I (Y="")!($L(Y)>45)!($L(Y)<3) W !,"Name should be Last,first middle and at least 3 characters and no more than 30" G NAME
"RTN","MPIFSAQ",54,0)
 I (Y?1P.E)!(Y'?1U.ANP)!(Y'[",")!(Y[":")!(Y[";") W !,"Name should be Last,first middle and at least 3 characters and no more than 30" G NAME
"RTN","MPIFSAQ",55,0)
 I Y'?.UNP F %=1:1:$L(Y) I $E(Y,%)?1L S Y=$E(Y,0,%-1)_$C($A(Y,%)-32)_$E(Y,%+1,999)
"RTN","MPIFSAQ",56,0)
 S MPIVAR("NM")=$$CLEAN(Y)
"RTN","MPIFSAQ",57,0)
 ;
"RTN","MPIFSAQ",58,0)
DOB K DIR,X,Y
"RTN","MPIFSAQ",59,0)
 S DIR(0)="DU^::AE",DIR("A")="Date of Birth"
"RTN","MPIFSAQ",60,0)
 D ^DIR
"RTN","MPIFSAQ",61,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",62,0)
 S MPIVAR("DOB")=Y
"RTN","MPIFSAQ",63,0)
SSN ; ssn is optional
"RTN","MPIFSAQ",64,0)
 K DIR,X,Y
"RTN","MPIFSAQ",65,0)
 S DIR(0)="FUO^9:9:",DIR("A")="9 Digit SSN (No Dashes)"
"RTN","MPIFSAQ",66,0)
 D ^DIR
"RTN","MPIFSAQ",67,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",68,0)
 I Y'="",Y'?9N W !,"SSN should be 9 numbers" G SSN
"RTN","MPIFSAQ",69,0)
 S MPIVAR("SSN")=Y
"RTN","MPIFSAQ",70,0)
 Q
"RTN","MPIFSAQ",71,0)
 ;
"RTN","MPIFSAQ",72,0)
VTQ(MPIVAR) ;
"RTN","MPIFSAQ",73,0)
 I $$SEND^RGJUSITE'>0 W !,"Not in SEND or SUSPEND mode, Try Again Later" G END
"RTN","MPIFSAQ",74,0)
 N TIME,%
"RTN","MPIFSAQ",75,0)
 D NOW^%DTC S TIME=%
"RTN","MPIFSAQ",76,0)
 ;
"RTN","MPIFSAQ",77,0)
 W !!,"Attempting to connect to the Master Patient Index in Austin..."
"RTN","MPIFSAQ",78,0)
 W !,"If DOB is inexact or if SSN is not passed or if common name,",!,"this could take sometime - please be patient...."
"RTN","MPIFSAQ",79,0)
 ;
"RTN","MPIFSAQ",80,0)
 N HL,MPIQRYNM,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER
"RTN","MPIFSAQ",81,0)
 N TEST,SITE,RGDC,MPINM,MPI1NM,MPI2NM,MPIESC,MPIHDOB,MPIRS,MPISCS
"RTN","MPIFSAQ",82,0)
 N QUEDDOB,QUERY,RDF
"RTN","MPIFSAQ",83,0)
 S HLP("ACKTIME")=300,HL("ECH")="^~\&",HL("FS")="|",MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFSAQ",84,0)
 S MPIIN="",MPICNT=1
"RTN","MPIFSAQ",85,0)
 S MPICS=$E(HL("ECH"),1)
"RTN","MPIFSAQ",86,0)
 I '$D(MPIVAR("DFN")) S MPIVAR("DFN")=235
"RTN","MPIFSAQ",87,0)
 S MPIMCNT=MPIVAR("DFN")
"RTN","MPIFSAQ",88,0)
 ;
"RTN","MPIFSAQ",89,0)
 ;SETUP VTQ
"RTN","MPIFSAQ",90,0)
 ;
"RTN","MPIFSAQ",91,0)
 S MPICS=$E(HL("ECH"),1),MPIRS=$E(HL("ECH"),2),MPISCS=$E(HL("ECH"),4),MPIESC=$E(HL("ECH"),3)
"RTN","MPIFSAQ",92,0)
 ;
"RTN","MPIFSAQ",93,0)
 S RDF="RDF"_HL("FS")_"15"_HL("FS")_"@00108.1"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00122"_MPICS_"ST"_MPICS_"9"_MPIRS_"@00110"_MPICS_"TS"_MPICS_8_MPIRS_"@00756"_MPICS_"ST"_MPICS_30
"RTN","MPIFSAQ",94,0)
 S RDF=RDF_MPIRS_"@00105"_MPICS_"ST"_MPICS_19_MPIRS_"@00108.2"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00169"_MPICS_"ST"_MPICS_30_MPIRS_"@00740"_MPICS_"TS"_MPICS_8
"RTN","MPIFSAQ",95,0)
 S RDF=RDF_MPIRS_"@00108.3"_MPICS_"ST"_MPICS_16_MPIRS_"@00111"_MPICS_"ST"_MPICS_1_MPIRS_"@00126.1"_MPICS_"ST"_MPICS_30_MPIRS_"@00126.2"_MPICS_"ST"_MPICS_3
"RTN","MPIFSAQ",96,0)
 S RDF=RDF_MPIRS_"@00108.5"_MPICS_"ST"_MPICS_20_MPIRS_"@00108.4"_MPICS_"ST"_MPICS_20_MPIRS_"@00109.1"_MPICS_"ST"_MPICS_30
"RTN","MPIFSAQ",97,0)
 ; ^ fields to be returned in query response
"RTN","MPIFSAQ",98,0)
 S QUERY="VTQ"_HL("FS")_$G(MPIVAR("DFN"))_HL("FS")_"T"_HL("FS")_MPIQRYNM_HL("FS")_"ICN"_HL("FS")
"RTN","MPIFSAQ",99,0)
 S MPI2NM=$P($G(MPIVAR("NM")),",",1),QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFSAQ",100,0)
 ; ^ sending last name
"RTN","MPIFSAQ",101,0)
 I MPIVAR("SSN")'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_$G(MPIVAR("SSN"))
"RTN","MPIFSAQ",102,0)
 ; ^ sending SSN
"RTN","MPIFSAQ",103,0)
 S MPI1NM=$P($G(MPIVAR("NM")),",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFSAQ",104,0)
 ; ^ sending first name
"RTN","MPIFSAQ",105,0)
 I $G(MPIVAR("DOB"))>0 D
"RTN","MPIFSAQ",106,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIVAR("DOB"))
"RTN","MPIFSAQ",107,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFSAQ",108,0)
 .S QUEDDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFSAQ",109,0)
 .S QUERY=QUERY_QUEDDOB
"RTN","MPIFSAQ",110,0)
 .; ^ sending date of birth
"RTN","MPIFSAQ",111,0)
 ;
"RTN","MPIFSAQ",112,0)
 ;Create MSH
"RTN","MPIFSAQ",113,0)
 ;
"RTN","MPIFSAQ",114,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFSAQ",115,0)
 S HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFSAQ",116,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFSAQ",117,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFSAQ",118,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFSAQ",119,0)
 S MPIOUT(3)=RDF
"RTN","MPIFSAQ",120,0)
 ;
"RTN","MPIFSAQ",121,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFSAQ",122,0)
 ;Message is returned in RGDC array
"RTN","MPIFSAQ",123,0)
 ;
"RTN","MPIFSAQ",124,0)
 K RGDC
"RTN","MPIFSAQ",125,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","RGDC")
"RTN","MPIFSAQ",126,0)
 ;Clean up the ack timeout HLP array variable
"RTN","MPIFSAQ",127,0)
 K HLP("ACKTIME")
"RTN","MPIFSAQ",128,0)
 I +TEST=-1 W !!,"Could not connect to MPI or Time-out occured, try again later." G EXIT
"RTN","MPIFSAQ",129,0)
 ;
"RTN","MPIFSAQ",130,0)
 ;Kill ^TMP("MPIFSAQ",$J) this is the array the data is parsed into
"RTN","MPIFSAQ",131,0)
 K ^TMP("MPIFSAQ",$J)
"RTN","MPIFSAQ",132,0)
 ;
"RTN","MPIFSAQ",133,0)
INIPARS ;
"RTN","MPIFSAQ",134,0)
 N SEG,INDEX,COUNTER,LASTSSN,SKIP,CHECK,FIRST
"RTN","MPIFSAQ",135,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFSAQ",136,0)
 K CHECK
"RTN","MPIFSAQ",137,0)
PARSE ;
"RTN","MPIFSAQ",138,0)
 S SEG=$$SEG^RGRSUTIL("RDT",1,"RDT")
"RTN","MPIFSAQ",139,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFSAQ",140,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,NAME,TF,ICN,POBC,POBS,PAST
"RTN","MPIFSAQ",141,0)
 . N HEREICN,HERESSN,MIDDLE,MNAME,SUFFIX,PREFIX,SEX,IEN,CMOR2,TF2
"RTN","MPIFSAQ",142,0)
 . S FRSTNAME=$P(SEG,HL("FS"),7)
"RTN","MPIFSAQ",143,0)
 . S LASTNAME=$P(SEG,HL("FS"),2)
"RTN","MPIFSAQ",144,0)
 . S MIDDLE=$P(SEG,HL("FS"),10)
"RTN","MPIFSAQ",145,0)
 . S (LASTSSN,SSN)=$P(SEG,HL("FS"),3)
"RTN","MPIFSAQ",146,0)
 . S NAME=LASTNAME_","_FRSTNAME_" "_MIDDLE
"RTN","MPIFSAQ",147,0)
 . S CMOR=$P(SEG,HL("FS"),5),CMOR2=CMOR
"RTN","MPIFSAQ",148,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFSAQ",149,0)
 . I FIRST=1 S FICN=ICN
"RTN","MPIFSAQ",150,0)
 . S FIRST=FIRST+1
"RTN","MPIFSAQ",151,0)
 . I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^"),CMOR2=CMOR
"RTN","MPIFSAQ",152,0)
 . S TF=$P(SEG,HL("FS"),8),TF2=TF
"RTN","MPIFSAQ",153,0)
 . I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFSAQ",154,0)
 . ;
"RTN","MPIFSAQ",155,0)
 . ;Same patient just adding TF's
"RTN","MPIFSAQ",156,0)
 . I TF'="",FICN=ICN,FIRST'=2 D
"RTN","MPIFSAQ",157,0)
 . . S SKIP="Y"
"RTN","MPIFSAQ",158,0)
 . . Q:CMOR2=TF2!($D(CHECK(TF2)))
"RTN","MPIFSAQ",159,0)
 . . S COUNTER=COUNTER+1
"RTN","MPIFSAQ",160,0)
 . . S ^TMP("MPIFSAQ",$J,INDEX,COUNTER)=TF,CHECK(TF2)=""
"RTN","MPIFSAQ",161,0)
 . ;
"RTN","MPIFSAQ",162,0)
 . I $G(SKIP)="Y" K SKIP Q
"RTN","MPIFSAQ",163,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFSAQ",164,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFSAQ",165,0)
 . I $G(BIRTHDAY)]"" D
"RTN","MPIFSAQ",166,0)
 . . S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY)
"RTN","MPIFSAQ",167,0)
 . . S BIRTHDAY=$$IN2EXDT^VAFCMGU0(BIRTHDAY,0)
"RTN","MPIFSAQ",168,0)
 . S SEX=$P(SEG,HL("FS"),11)
"RTN","MPIFSAQ",169,0)
 . S SUFFIX=$P(SEG,HL("FS"),15)
"RTN","MPIFSAQ",170,0)
 . S PREFIX=$P(SEG,HL("FS"),14)
"RTN","MPIFSAQ",171,0)
 . S MNAME=$P(SEG,HL("FS"),16)
"RTN","MPIFSAQ",172,0)
 . S POBC=$P(SEG,HL("FS"),12)
"RTN","MPIFSAQ",173,0)
 . S POBS=$P(SEG,HL("FS"),13)
"RTN","MPIFSAQ",174,0)
 . S PAST=$P(SEG,HL("FS"),9)
"RTN","MPIFSAQ",175,0)
 . ;
"RTN","MPIFSAQ",176,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFSAQ",177,0)
 . ;
"RTN","MPIFSAQ",178,0)
 . S INDEX=INDEX+1
"RTN","MPIFSAQ",179,0)
 . S COUNTER=1
"RTN","MPIFSAQ",180,0)
 . I CMOR2=TF2 S TF=""
"RTN","MPIFSAQ",181,0)
 . S ^TMP("MPIFSAQ",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_SEX_"^"_SUFFIX_"^"_PREFIX_"^"_MNAME_"^"_POBC_"^"_POBS_"^"_PAST
"RTN","MPIFSAQ",182,0)
 ;
"RTN","MPIFSAQ",183,0)
 ; If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFSAQ",184,0)
 I '$D(^TMP("MPIFSAQ",$J)) W !!,"Patient was not found in the MPI." G EXIT
"RTN","MPIFSAQ",185,0)
 ;
"RTN","MPIFSAQ",186,0)
DISPLAY ;
"RTN","MPIFSAQ",187,0)
 I INDEX>1 W !!,"Found potential matches"
"RTN","MPIFSAQ",188,0)
 I INDEX=1 W !!,"Found One Match"
"RTN","MPIFSAQ",189,0)
 ; display data returned
"RTN","MPIFSAQ",190,0)
 N CNT1,CNT2,STOP,CNTR2,TTF,CNT3,DIR,X,Y,DATA
"RTN","MPIFSAQ",191,0)
 S (CNT1)=0
"RTN","MPIFSAQ",192,0)
 F  S CNT1=$O(^TMP("MPIFSAQ",$J,CNT1)) Q:CNT1'>0!($D(STOP))  D
"RTN","MPIFSAQ",193,0)
 . S CNTR2=0
"RTN","MPIFSAQ",194,0)
 . I CNT1>1 D
"RTN","MPIFSAQ",195,0)
 . . K DIR,X,Y
"RTN","MPIFSAQ",196,0)
 . . S DIR(0)="Y",DIR("B")="YES",DIR("A")="Continue to next Patient? "
"RTN","MPIFSAQ",197,0)
 . . D ^DIR
"RTN","MPIFSAQ",198,0)
 . . I Y'=1 S STOP=""
"RTN","MPIFSAQ",199,0)
 . Q:$D(STOP)
"RTN","MPIFSAQ",200,0)
 . S CNTR2=CNTR2+1
"RTN","MPIFSAQ",201,0)
 . S DATA=$G(^TMP("MPIFSAQ",$J,CNT1,"DATA"))
"RTN","MPIFSAQ",202,0)
 . Q:DATA=""
"RTN","MPIFSAQ",203,0)
 . K TF,CHECK
"RTN","MPIFSAQ",204,0)
 . S NAME=$P(DATA,"^"),SSN=$P(DATA,"^",2),BIRTHDAY=$P(DATA,"^",3)
"RTN","MPIFSAQ",205,0)
 . S ICN=$P(DATA,"^",4),CMOR=$P(DATA,"^",5)
"RTN","MPIFSAQ",206,0)
 . S TTF=$P(DATA,"^",6)
"RTN","MPIFSAQ",207,0)
 . I TTF'="",CMOR'=TTF S TF(CNTR2)=TTF
"RTN","MPIFSAQ",208,0)
 . S SEX=$P(DATA,"^",7),SUFFIX=$P(DATA,"^",8),PREFIX=$P(DATA,"^",9)
"RTN","MPIFSAQ",209,0)
 . S MNAME=$P(DATA,"^",10),POBC=$P(DATA,"^",11),POBS=$P(DATA,"^",12)
"RTN","MPIFSAQ",210,0)
 . S PAST=$P(DATA,"^",13)
"RTN","MPIFSAQ",211,0)
 . S CNT3=""
"RTN","MPIFSAQ",212,0)
 . F  S CNT3=$O(^TMP("MPIFSAQ",$J,CNT1,CNT3)) Q:CNT3<0!(CNT3'?.N)  D
"RTN","MPIFSAQ",213,0)
 . . S TTF=$G(^TMP("MPIFSAQ",$J,CNT1,CNT3))
"RTN","MPIFSAQ",214,0)
 . . I TTF'=CMOR S CNTR2=CNTR2+1,TF(CNTR2)=TTF
"RTN","MPIFSAQ",215,0)
 . W !!!,"Name: ",NAME," ",SUFFIX," ",PREFIX
"RTN","MPIFSAQ",216,0)
 . W !,"SSN: ",SSN,?25,"Gender: ",SEX
"RTN","MPIFSAQ",217,0)
 . W !,"Integration Control Number (ICN): ",$P(ICN,"V")
"RTN","MPIFSAQ",218,0)
 . W !,"Date of Birth: ",BIRTHDAY,?30,"Date of Death: ",PAST
"RTN","MPIFSAQ",219,0)
 . W:$G(POBC)'="" !,"Place of Birth: ",POBC,", ",POBS
"RTN","MPIFSAQ",220,0)
 . W !,"CMOR: ",CMOR
"RTN","MPIFSAQ",221,0)
 . S CNT2=""
"RTN","MPIFSAQ",222,0)
 . F  S CNT2=$O(TF(CNT2)) Q:CNT2=""  D
"RTN","MPIFSAQ",223,0)
 . . W !?10,"Treating Facility: ",TF(CNT2)
"RTN","MPIFSAQ",224,0)
 .W !!
"RTN","MPIFSAQ",225,0)
 Q
"RTN","MPIFSAQ",226,0)
EXIT ;
"RTN","MPIFSAQ",227,0)
 H 3
"RTN","MPIFSAQ",228,0)
 K FICN
"RTN","MPIFSAQ",229,0)
 W !!
"VER")
8.0^22.0
**END**
**END**
