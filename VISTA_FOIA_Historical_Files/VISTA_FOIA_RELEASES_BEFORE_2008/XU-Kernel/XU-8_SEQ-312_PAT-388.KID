Released XU*8*388 SEQ #312
Extracted from mail message
**KIDS**:XU*8.0*388^

**INSTALL NAME**
XU*8.0*388
"BLD",875,0)
XU*8.0*388^KERNEL^0^3050622^y
"BLD",875,1,0)
^^2^2^3050620^
"BLD",875,1,1,0)
See patch XU*8*388 in the National Patch Module on FORUM for complete
"BLD",875,1,2,0)
information on this patch.
"BLD",875,4,0)
^9.64PA^^
"BLD",875,"ABPKG")
n
"BLD",875,"KRN",0)
^9.67PA^8989.52^19
"BLD",875,"KRN",.4,0)
.4
"BLD",875,"KRN",.401,0)
.401
"BLD",875,"KRN",.402,0)
.402
"BLD",875,"KRN",.403,0)
.403
"BLD",875,"KRN",.5,0)
.5
"BLD",875,"KRN",.84,0)
.84
"BLD",875,"KRN",3.6,0)
3.6
"BLD",875,"KRN",3.8,0)
3.8
"BLD",875,"KRN",9.2,0)
9.2
"BLD",875,"KRN",9.8,0)
9.8
"BLD",875,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",875,"KRN",9.8,"NM",1,0)
ZISTCPS^^0^11967735
"BLD",875,"KRN",9.8,"NM","B","ZISTCPS",1)

"BLD",875,"KRN",19,0)
19
"BLD",875,"KRN",19.1,0)
19.1
"BLD",875,"KRN",101,0)
101
"BLD",875,"KRN",409.61,0)
409.61
"BLD",875,"KRN",771,0)
771
"BLD",875,"KRN",870,0)
870
"BLD",875,"KRN",8989.51,0)
8989.51
"BLD",875,"KRN",8989.52,0)
8989.52
"BLD",875,"KRN",8994,0)
8994
"BLD",875,"KRN","B",.4,.4)

"BLD",875,"KRN","B",.401,.401)

"BLD",875,"KRN","B",.402,.402)

"BLD",875,"KRN","B",.403,.403)

"BLD",875,"KRN","B",.5,.5)

"BLD",875,"KRN","B",.84,.84)

"BLD",875,"KRN","B",3.6,3.6)

"BLD",875,"KRN","B",3.8,3.8)

"BLD",875,"KRN","B",9.2,9.2)

"BLD",875,"KRN","B",9.8,9.8)

"BLD",875,"KRN","B",19,19)

"BLD",875,"KRN","B",19.1,19.1)

"BLD",875,"KRN","B",101,101)

"BLD",875,"KRN","B",409.61,409.61)

"BLD",875,"KRN","B",771,771)

"BLD",875,"KRN","B",870,870)

"BLD",875,"KRN","B",8989.51,8989.51)

"BLD",875,"KRN","B",8989.52,8989.52)

"BLD",875,"KRN","B",8994,8994)

"BLD",875,"QUES",0)
^9.62^^
"BLD",875,"REQB",0)
^9.611^^
"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
388^3050622
"PKG",3,22,1,"PAH",1,1,0)
^^2^2^3050622
"PKG",3,22,1,"PAH",1,1,1,0)
See patch XU*8*388 in the National Patch Module on FORUM for complete
"PKG",3,22,1,"PAH",1,1,2,0)
information on this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","ZISTCPS")
0^1^B11967735
"RTN","ZISTCPS",1,0)
%ZISTCPS ;ISF/RWF - DEVICE HANDLER TCP/IP SERVER CALLS ;06/20/2005  09:11
"RTN","ZISTCPS",2,0)
 ;;8.0;KERNEL;**78,118,127,225,275,388**;Jul 10, 1995
"RTN","ZISTCPS",3,0)
 Q
"RTN","ZISTCPS",4,0)
 ;
"RTN","ZISTCPS",5,0)
CLOSE ;Close and reset
"RTN","ZISTCPS",6,0)
 G CLOSE^%ZISTCP
"RTN","ZISTCPS",7,0)
 Q
"RTN","ZISTCPS",8,0)
 ;
"RTN","ZISTCPS",9,0)
 ;In ZRULE, set ZISQUIT=1 to quit
"RTN","ZISTCPS",10,0)
LISTEN(SOCK,RTN,ZRULE) ;Listen on socket, start routine
"RTN","ZISTCPS",11,0)
 N %A,ZISOS,X,NIO,EXIT
"RTN","ZISTCPS",12,0)
 N $ES,$ET S $ETRAP="D OPNERR^%ZISTCPS"
"RTN","ZISTCPS",13,0)
 S ZISOS=^%ZOSF("OS"),ZRULE=$G(ZRULE)
"RTN","ZISTCPS",14,0)
 S POP=1
"RTN","ZISTCPS",15,0)
 D GETENV^%ZOSV S U="^",XUENV=Y,XQVOL=$P(Y,U,2)
"RTN","ZISTCPS",16,0)
 S POP=1 D LONT:ZISOS["OpenM",LGTM:ZISOS["GT.M"
"RTN","ZISTCPS",17,0)
 I 'POP C NIO ;Close port
"RTN","ZISTCPS",18,0)
 Q
"RTN","ZISTCPS",19,0)
 ;
"RTN","ZISTCPS",20,0)
 ;
"RTN","ZISTCPS",21,0)
LONT ;Open port in Accept mode with standard terminators.
"RTN","ZISTCPS",22,0)
 N %ZA,NEWCHAR
"RTN","ZISTCPS",23,0)
 S NIO="|TCP|"_SOCK,EXIT=0
"RTN","ZISTCPS",24,0)
 ;(adr:sock:term:ibuf:obuf:queue)
"RTN","ZISTCPS",25,0)
 O NIO:(:SOCK:"AT"::512:512:10):30 Q:'$T  S POP=0 U NIO
"RTN","ZISTCPS",26,0)
 ;Wait on read for a connect
"RTN","ZISTCPS",27,0)
LONT2 F  U NIO R *NEWCHAR:30 S EXIT=$$EXIT Q:$T!EXIT
"RTN","ZISTCPS",28,0)
 I EXIT C NIO Q
"RTN","ZISTCPS",29,0)
 ;JOB params (:Concurrent Server bit:principal input:principal output)
"RTN","ZISTCPS",30,0)
 J CHILDONT^%ZISTCPS(NIO,RTN):(:16::):10 S %ZA=$ZA
"RTN","ZISTCPS",31,0)
 I %ZA\8196#2=1 W *-2 ;Job failed to clear bit
"RTN","ZISTCPS",32,0)
 G LONT2
"RTN","ZISTCPS",33,0)
 ;
"RTN","ZISTCPS",34,0)
CHILDONT(IO,RTN) ;Child process for OpenM
"RTN","ZISTCPS",35,0)
 S $ETRAP="D ^%ZTER L  HALT",IO=$ZU(53)
"RTN","ZISTCPS",36,0)
 U IO:(::"-M") ;Work like DSM
"RTN","ZISTCPS",37,0)
 S NEWJOB=$$NEWOK
"RTN","ZISTCPS",38,0)
 I 'NEWJOB W "421 Service temporarily down.",$C(13,10),!
"RTN","ZISTCPS",39,0)
 I NEWJOB K NEWJOB D VAR,@RTN
"RTN","ZISTCPS",40,0)
 HALT
"RTN","ZISTCPS",41,0)
 ;
"RTN","ZISTCPS",42,0)
VAR ;Setup IO variables
"RTN","ZISTCPS",43,0)
 S IO(0)=IO,IO(1,IO)="",POP=0
"RTN","ZISTCPS",44,0)
 S IOT="TCP",IOST="P-TCP",IOST(0)=0
"RTN","ZISTCPS",45,0)
 S IOF=$$FLUSHCHR^%ZISTCP
"RTN","ZISTCPS",46,0)
 S ^XUTL("XQ",$J,0)=$$DT^XLFDT
"RTN","ZISTCPS",47,0)
 Q
"RTN","ZISTCPS",48,0)
NEWOK() ;Is it OK to start a new process
"RTN","ZISTCPS",49,0)
 I $G(^%ZIS(14.5,"LOGON",^%ZOSF("VOL"))) Q 0
"RTN","ZISTCPS",50,0)
 I $$AVJ^%ZOSV()<3 Q 0
"RTN","ZISTCPS",51,0)
 Q 1
"RTN","ZISTCPS",52,0)
OPNERR ;
"RTN","ZISTCPS",53,0)
 S POP=1,EXIT=1,IO("ERROR")=$ECODE,$ECODE=""
"RTN","ZISTCPS",54,0)
 Q
"RTN","ZISTCPS",55,0)
EXIT() ;See if time to exit
"RTN","ZISTCPS",56,0)
 I $$S^%ZTLOAD Q 1
"RTN","ZISTCPS",57,0)
 N ZISQUIT S ZISQUIT=0
"RTN","ZISTCPS",58,0)
 I $L(ZRULE) X ZRULE I $G(ZISQUIT) Q 1
"RTN","ZISTCPS",59,0)
 Q 0
"RTN","ZISTCPS",60,0)
 ;
"RTN","ZISTCPS",61,0)
LGTM ;GT.M multi thread server
"RTN","ZISTCPS",62,0)
 N %A K ^TMP("ZISTCP",$J)
"RTN","ZISTCPS",63,0)
 S $ZINTERRUPT="I $$JOBEXAM^ZU($ZPOSITION)"
"RTN","ZISTCPS",64,0)
 S NIO="SCK$"_$S($J>86400:$J,1:84600+$J) ;Construct a dummy, but "unique" devicename for job
"RTN","ZISTCPS",65,0)
 D LOG("Open for Listen "_NIO)
"RTN","ZISTCPS",66,0)
 ;Open the device
"RTN","ZISTCPS",67,0)
 O NIO:(ZLISTEN=SOCK_":TCP":ATTACH="listener"):30:"SOCKET"
"RTN","ZISTCPS",68,0)
 I '$T D LOG("Can't Open Socket: "_SOCK) Q
"RTN","ZISTCPS",69,0)
 U NIO S NIO("ZISTCP",0)=$KEY D LOG("Have port.")
"RTN","ZISTCPS",70,0)
 ;Start Listening
"RTN","ZISTCPS",71,0)
 W /LISTEN(1) S NIO("ZISTCP",1)=$KEY D LOG("Start Listening. "_NIO("ZISTCP",1))
"RTN","ZISTCPS",72,0)
 ;Wait for connection
"RTN","ZISTCPS",73,0)
LG2 S %A=0,EXIT=0 F  D  Q:%A!EXIT
"RTN","ZISTCPS",74,0)
 . W /WAIT(30) ;Wait for connect
"RTN","ZISTCPS",75,0)
 . I $P($KEY,"|",1)="CONNECT" S NIO("ZISTCP",2)=$KEY,%A=1
"RTN","ZISTCPS",76,0)
 . S EXIT=$$EXIT
"RTN","ZISTCPS",77,0)
 . Q
"RTN","ZISTCPS",78,0)
 I EXIT C NIO Q
"RTN","ZISTCPS",79,0)
 ;
"RTN","ZISTCPS",80,0)
 S NIO("SOCK")=$P($G(NIO("ZISTCP",2)),"|",2)
"RTN","ZISTCPS",81,0)
 D LOG("Got connection on "_NIO("SOCK"))
"RTN","ZISTCPS",82,0)
 I '$$NEWOK D  G LG2
"RTN","ZISTCPS",83,0)
 . U NIO:(SOCKET=NIO("SOCK")) W "421 Service temporarily down.",$C(13,10),#
"RTN","ZISTCPS",84,0)
 . C NIO:(SOCKET=NIO("SOCK")) K NIO("ZISTCP",2)
"RTN","ZISTCPS",85,0)
 . Q
"RTN","ZISTCPS",86,0)
 ;Close the main socket
"RTN","ZISTCPS",87,0)
 C NIO:(SOCKET="listener")
"RTN","ZISTCPS",88,0)
 ;Start a new listener
"RTN","ZISTCPS",89,0)
 J LISTEN^%ZISTCPS(SOCK,RTN,ZRULE)
"RTN","ZISTCPS",90,0)
 ;Use the new socket
"RTN","ZISTCPS",91,0)
 ;U NIO:(SOCKET=NIO("SOCK"):WIDTH=512:NOWRAP:IOERROR="TRAP")
"RTN","ZISTCPS",92,0)
 U NIO:(SOCKET=NIO("SOCK"):WIDTH=512:NOWRAP)
"RTN","ZISTCPS",93,0)
 ;Run the job
"RTN","ZISTCPS",94,0)
 D GTMLNCH(NIO,RTN)
"RTN","ZISTCPS",95,0)
 S POP=0
"RTN","ZISTCPS",96,0)
 Q
"RTN","ZISTCPS",97,0)
 ;
"RTN","ZISTCPS",98,0)
GTMLNCH(IO,RTN) ;Run gt.m job for this conncetion.
"RTN","ZISTCPS",99,0)
 N NIO,SOCK,ZISOS,EXIT,XQVOL,$ETRAP
"RTN","ZISTCPS",100,0)
 S U="^",$ETRAP="D ^%ZTER L  HALT"
"RTN","ZISTCPS",101,0)
 S IO(0)=IO,IO(1,IO)=""
"RTN","ZISTCPS",102,0)
 D VAR,@RTN
"RTN","ZISTCPS",103,0)
 Q $D(IO("C")) ;Use IO("C") to quit server
"RTN","ZISTCPS",104,0)
 ;
"RTN","ZISTCPS",105,0)
LOG(MSG) ;LOG STATUS
"RTN","ZISTCPS",106,0)
 N CNT
"RTN","ZISTCPS",107,0)
 S CNT=$G(^TMP("ZISTCP",$J))+1,^TMP("ZISTCP",$J)=CNT,^($J,CNT)=MSG
"RTN","ZISTCPS",108,0)
 Q
"RTN","ZISTCPS",109,0)
 ;
"VER")
8.0^22.0
"BLD",875,6)
^SEQ #312
**END**
**END**
