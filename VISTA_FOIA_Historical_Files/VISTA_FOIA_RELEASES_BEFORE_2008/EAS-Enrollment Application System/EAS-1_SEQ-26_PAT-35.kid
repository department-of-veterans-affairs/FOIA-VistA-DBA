Released EAS*1*35 SEQ #26
Extracted from mail message
**KIDS**:EAS*1.0*35^

**INSTALL NAME**
EAS*1.0*35
"BLD",4278,0)
EAS*1.0*35^ENROLLMENT APPLICATION SYSTEM^0^3030618^y
"BLD",4278,1,0)
^^2^2^3030528^
"BLD",4278,1,1,0)
CORRECTLY DISPLAY THE NEW MT STATUS ON BULLETINS SENT TO THE SITE AFTER A
"BLD",4278,1,2,0)
MT EDB Z06 HAS BEEN RECEIVED.
"BLD",4278,4,0)
^9.64PA^^
"BLD",4278,"ABPKG")
n
"BLD",4278,"KRN",0)
^9.67PA^8989.52^19
"BLD",4278,"KRN",.4,0)
.4
"BLD",4278,"KRN",.401,0)
.401
"BLD",4278,"KRN",.402,0)
.402
"BLD",4278,"KRN",.403,0)
.403
"BLD",4278,"KRN",.5,0)
.5
"BLD",4278,"KRN",.84,0)
.84
"BLD",4278,"KRN",3.6,0)
3.6
"BLD",4278,"KRN",3.8,0)
3.8
"BLD",4278,"KRN",9.2,0)
9.2
"BLD",4278,"KRN",9.8,0)
9.8
"BLD",4278,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",4278,"KRN",9.8,"NM",1,0)
EASUM1^^0^B24411423
"BLD",4278,"KRN",9.8,"NM",2,0)
EASPREC7^^0^B64910199
"BLD",4278,"KRN",9.8,"NM","B","EASPREC7",2)

"BLD",4278,"KRN",9.8,"NM","B","EASUM1",1)

"BLD",4278,"KRN",19,0)
19
"BLD",4278,"KRN",19.1,0)
19.1
"BLD",4278,"KRN",101,0)
101
"BLD",4278,"KRN",409.61,0)
409.61
"BLD",4278,"KRN",771,0)
771
"BLD",4278,"KRN",870,0)
870
"BLD",4278,"KRN",8989.51,0)
8989.51
"BLD",4278,"KRN",8989.52,0)
8989.52
"BLD",4278,"KRN",8994,0)
8994
"BLD",4278,"KRN","B",.4,.4)

"BLD",4278,"KRN","B",.401,.401)

"BLD",4278,"KRN","B",.402,.402)

"BLD",4278,"KRN","B",.403,.403)

"BLD",4278,"KRN","B",.5,.5)

"BLD",4278,"KRN","B",.84,.84)

"BLD",4278,"KRN","B",3.6,3.6)

"BLD",4278,"KRN","B",3.8,3.8)

"BLD",4278,"KRN","B",9.2,9.2)

"BLD",4278,"KRN","B",9.8,9.8)

"BLD",4278,"KRN","B",19,19)

"BLD",4278,"KRN","B",19.1,19.1)

"BLD",4278,"KRN","B",101,101)

"BLD",4278,"KRN","B",409.61,409.61)

"BLD",4278,"KRN","B",771,771)

"BLD",4278,"KRN","B",870,870)

"BLD",4278,"KRN","B",8989.51,8989.51)

"BLD",4278,"KRN","B",8989.52,8989.52)

"BLD",4278,"KRN","B",8994,8994)

"BLD",4278,"QUES",0)
^9.62^^
"BLD",4278,"REQB",0)
^9.611^1^1
"BLD",4278,"REQB",1,0)
EAS*1.0*33^2
"BLD",4278,"REQB","B","EAS*1.0*33",1)

"MBREQ")
0
"PKG",552,-1)
1^1
"PKG",552,0)
ENROLLMENT APPLICATION SYSTEM^EAS^ENROLLMENT
"PKG",552,20,0)
^9.402P^1^1
"PKG",552,20,1,0)
2^^EASXDR
"PKG",552,20,1,1)
 
"PKG",552,20,"B",2,1)

"PKG",552,22,0)
^9.49I^1^1
"PKG",552,22,1,0)
1.0^3010315^3010410^66481
"PKG",552,22,1,"PAH",1,0)
35^3030618
"PKG",552,22,1,"PAH",1,1,0)
^^2^2^3030618
"PKG",552,22,1,"PAH",1,1,1,0)
CORRECTLY DISPLAY THE NEW MT STATUS ON BULLETINS SENT TO THE SITE AFTER A
"PKG",552,22,1,"PAH",1,1,2,0)
MT EDB Z06 HAS BEEN RECEIVED.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","EASPREC7")
0^2^B64910199
"RTN","EASPREC7",1,0)
EASPREC7 ;ALB/SEK,RTK - ROUTINE TO PROCESS INCOMING (Z06 EVENT TYPE) HL7 MESSAGES ; 31 May 94
"RTN","EASPREC7",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**23,30,35**;21-OCT-94
"RTN","EASPREC7",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","EASPREC7",4,0)
 ;
"RTN","EASPREC7",5,0)
 ; This routine will process (validate) batch ORU Means Test(event type
"RTN","EASPREC7",6,0)
 ; Z06) HL7 messages received from the IVM center.  Format of batch:
"RTN","EASPREC7",7,0)
 ;       BHS
"RTN","EASPREC7",8,0)
 ;       {MSH
"RTN","EASPREC7",9,0)
 ;        PID
"RTN","EASPREC7",10,0)
 ;        ZIC
"RTN","EASPREC7",11,0)
 ;        ZIR
"RTN","EASPREC7",12,0)
 ;        {ZDP
"RTN","EASPREC7",13,0)
 ;         ZIC
"RTN","EASPREC7",14,0)
 ;         ZIR
"RTN","EASPREC7",15,0)
 ;        }
"RTN","EASPREC7",16,0)
 ;        ZMT
"RTN","EASPREC7",17,0)
 ;        ZIV
"RTN","EASPREC7",18,0)
 ;       }
"RTN","EASPREC7",19,0)
 ;       BTS
"RTN","EASPREC7",20,0)
 ;
"RTN","EASPREC7",21,0)
EN ; entry point to validate Means Test messages 
"RTN","EASPREC7",22,0)
 ;
"RTN","EASPREC7",23,0)
 N DEPFLG,EDB,CANCFLG,CASEFLG,SEGSTR,SEGMENTS,MISSING,ERRFLG,Z06COM
"RTN","EASPREC7",24,0)
 N IVM2,IVM3,IVM7,IVM8,IVM10,IVM12,IVM17,IVM18,IVM20,IVM25,IVM26,IVMIY
"RTN","EASPREC7",25,0)
 N IVMDA,IVMPAT,IVMMTSTS,MTFND,UPMTS,MTDATE,TYPE,EASMTDT,EASZ06,EXPIRED
"RTN","EASPREC7",26,0)
 S SEGSTR="00000000000"      ;One byte for each segment in message
"RTN","EASPREC7",27,0)
 S SEGMENTS="BHS,MSH,PID,ZIC,ZIR,ZDP,ZIC,ZIR,ZMT,ZIV,BTS"
"RTN","EASPREC7",28,0)
 S EDB="EDB-EAS"
"RTN","EASPREC7",29,0)
 S Z06COM="Z06 MT via Edb"
"RTN","EASPREC7",30,0)
 S (CASEFLG,DEPFLG,ERRFLG,HLERR,IVMDA,IVMFLGC,MTFND,UPMTS)=0
"RTN","EASPREC7",31,0)
EN1 F  S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)) Q:'IVMDA  D  I $D(HLERR) D ACK^IVMPREC S ERRFLG=1 Q 
"RTN","EASPREC7",32,0)
 .K HLERR
"RTN","EASPREC7",33,0)
 .D GET
"RTN","EASPREC7",34,0)
 .D @IVMSEG1
"RTN","EASPREC7",35,0)
 Q:ERRFLG                               ;Error detected do not continue
"RTN","EASPREC7",36,0)
 S MISSING=$F(SEGSTR,0)                 ;Ensure all required segments
"RTN","EASPREC7",37,0)
 I MISSING D  I $D(HLERR) D ACK^IVMPREC,CLEANUP Q
"RTN","EASPREC7",38,0)
 . S TYPE=$S(MISSING=3!(MISSING=4):"Veteran's",MISSING>4&(MISSING<8):"Spouse's",1:"")
"RTN","EASPREC7",39,0)
 . S HLERR="Missing "_TYPE_" "_$P(SEGMENTS,",",(MISSING-1))_" Segment"
"RTN","EASPREC7",40,0)
 D PROCESS
"RTN","EASPREC7",41,0)
 I $D(HLERR) D ACK^IVMPREC
"RTN","EASPREC7",42,0)
 ;
"RTN","EASPREC7",43,0)
 ; cleanup
"RTN","EASPREC7",44,0)
CLEANUP K DGLY,DGMTP,IVMDAP,IVMDAS,IVMDAZ,IVMDGLY,CANCFLG,IVMFLGC,IVMMT31
"RTN","EASPREC7",45,0)
 K IVMMTDT,IVMMTIEN,IVMSEG,IVMSEG1,IVMSTAT,IVMTEXT,XMSUB,HLERR,CLOSFLG
"RTN","EASPREC7",46,0)
 K IVMZ10,IVMDAV,ZIVSEG,ZMTSEG
"RTN","EASPREC7",47,0)
 Q
"RTN","EASPREC7",48,0)
 ;
"RTN","EASPREC7",49,0)
 ;Dependent upon type of Z06 sent perform the following;
"RTN","EASPREC7",50,0)
 ;IVM Case Status:
"RTN","EASPREC7",51,0)
 ;  Value of 1 = Create/Update Z06 MT, Close Case and Mark REASON CODE 
"RTN","EASPREC7",52,0)
 ;               as 'Converted'
"RTN","EASPREC7",53,0)
 ;  Value of 0 = Cancel Z06 MT and Mark REASON CODE as 'Not Convert'
"RTN","EASPREC7",54,0)
 ;
"RTN","EASPREC7",55,0)
 ; If Z06 MT and IVM Case Status is 1 and Z06 MT does not exist Then 
"RTN","EASPREC7",56,0)
 ;   Create new Z06 MT (new Z06 MT becomes primary and existing MT
"RTN","EASPREC7",57,0)
 ;   becomes non-primary)
"RTN","EASPREC7",58,0)
 ;   Assign REASON CODE of 'Converted' in #301.5
"RTN","EASPREC7",59,0)
 ; If Z06 MT already exists Then 
"RTN","EASPREC7",60,0)
 ;   If IVM Case Status is 0 Then 
"RTN","EASPREC7",61,0)
 ;     Delete Z06 MT for income year and return old MT to primary
"RTN","EASPREC7",62,0)
 ;     Change REASON CODE from 'Converted' to 'Not Converted' in #301.5
"RTN","EASPREC7",63,0)
 ;   If IVM Case Status is 1 Then
"RTN","EASPREC7",64,0)
 ;     Update MT Z06 and Close/Convert Case
"RTN","EASPREC7",65,0)
 ; Else  (Z06 MT, IVM Case Status=0 and Z06 MT does not exist)
"RTN","EASPREC7",66,0)
 ;   Send back 'AE' to Edb indicating MT Z06 not available for 
"RTN","EASPREC7",67,0)
 ;   cancellation
"RTN","EASPREC7",68,0)
 ;
"RTN","EASPREC7",69,0)
PROCESS N DIC,%,%H,%I,IVMDATE
"RTN","EASPREC7",70,0)
 D NOW^%DTC
"RTN","EASPREC7",71,0)
 S IVMDATE=%
"RTN","EASPREC7",72,0)
 S (EASZ06,EXPIRED)=0
"RTN","EASPREC7",73,0)
 I $G(IVMMTIEN)="" D
"RTN","EASPREC7",74,0)
 . S CURMT=$$LST^DGMTU(DFN)        ;Retrieve current means test on file
"RTN","EASPREC7",75,0)
 . S IVMMTIEN=$P(CURMT,"^",1)      ; for the appropriate income year
"RTN","EASPREC7",76,0)
 . S IVMMTDT=$P(CURMT,"^",2)
"RTN","EASPREC7",77,0)
 . S IVMMTSTS=$P(CURMT,"^",3)
"RTN","EASPREC7",78,0)
 I $G(IVMMTIEN)="" D  Q                         ;No Means Test in #408.31
"RTN","EASPREC7",79,0)
 . S EASZ06=1,IVMMTDT=EASMTDT
"RTN","EASPREC7",80,0)
 . D ^EASUM1                                    ;Create New Z06 MT
"RTN","EASPREC7",81,0)
 . I $G(IVMMTDT)="" S IVMMTDT=EASMTDT
"RTN","EASPREC7",82,0)
 . I $$EXPIRED^EASPTRN1(DFN,$G(IVMMTDT)) S EXPIRED=1,IVMZ10="UPLOAD IN PROGRESS"
"RTN","EASPREC7",83,0)
 . D CLOSE^EASPTRN1(IVMIY,DFN,1,6)              ;Close Case/Converted
"RTN","EASPREC7",84,0)
 S (IVMMT31,DGMTP)=$G(^DGMT(408.31,IVMMTIEN,0)) ;dgmtp is event driver variable
"RTN","EASPREC7",85,0)
 I 'MTFND,CASEFLG D  Q
"RTN","EASPREC7",86,0)
 . S DA=IVMMTIEN,DIE="^DGMT(408.31,",DR="2////0;"   ;Change old MT to
"RTN","EASPREC7",87,0)
 . D ^DIE K DA,DIE,DR                           ; non-primary
"RTN","EASPREC7",88,0)
 . D ^EASUM1                                    ;Create New Z06 MT
"RTN","EASPREC7",89,0)
 . I $G(IVMMTDT)="" S IVMMTDT=EASMTDT
"RTN","EASPREC7",90,0)
 . I $$EXPIRED^EASPTRN1(DFN,$G(IVMMTDT)) S EXPIRED=1,IVMZ10="UPLOAD IN PROGRESS"
"RTN","EASPREC7",91,0)
 . D CLOSE^EASPTRN1(IVMIY,DFN,1,6)              ;Close Case/Converted
"RTN","EASPREC7",92,0)
 I 'MTFND,'CASEFLG S HLERR="Existing Z06 MT not found" Q
"RTN","EASPREC7",93,0)
 I MTFND D
"RTN","EASPREC7",94,0)
 . I 'CASEFLG D  Q                              ;Delete means test
"RTN","EASPREC7",95,0)
 . .;Check to see if MT Z06 exists prior to trying to delete
"RTN","EASPREC7",96,0)
 . .; If NOT defined then send an AE back to Edb
"RTN","EASPREC7",97,0)
 . . I 'UPMTS D  Q                           ;Existing Z06 MT not found
"RTN","EASPREC7",98,0)
 . . . S HLERR="Existing Z06 MT not found"
"RTN","EASPREC7",99,0)
 . . I UPMTS D  Q
"RTN","EASPREC7",100,0)
 . . . N CURMT,IVMMTI,IVMDFN,DGCAT
"RTN","EASPREC7",101,0)
 . . . S IVMDFN=DFN                             ;Save off DFN
"RTN","EASPREC7",102,0)
 . . . I $$EXPIRED^EASPTRN1(DFN,$G(IVMMTDT)) S EXPIRED=1,IVMZ10="UPLOAD IN PROGRESS"
"RTN","EASPREC7",103,0)
 . . . D ^IVMUM7                                ;Delete Z06 MT
"RTN","EASPREC7",104,0)
 . . . S DFN=IVMDFN
"RTN","EASPREC7",105,0)
 . . . I $G(IVMMTDT)="" S IVMMTDT=EASMTDT
"RTN","EASPREC7",106,0)
 . . . D CLOSE^EASPTRN1(IVMIY,DFN,1,7)          ;Close Case/Not Converted
"RTN","EASPREC7",107,0)
 . . . S DGCAT=$P($G(^DG(408.32,IVM3,0)),"^",1),IVM5=""
"RTN","EASPREC7",108,0)
 . . . D MTBULL,MAIL^IVMUFNC()                  ;Send Bulletin
"RTN","EASPREC7",109,0)
 . I CASEFLG D                                  ;Update existing Z06 MT
"RTN","EASPREC7",110,0)
 . . I '$D(ZMTSEG) S HLERR="ZMT Segment is Missing" Q
"RTN","EASPREC7",111,0)
 . . D PARSEZMT(ZMTSEG)                         ;Retrieve ZMT Values
"RTN","EASPREC7",112,0)
 . . S DA=IVMMTIEN,DIE="^DGMT(408.31,"
"RTN","EASPREC7",113,0)
 . . S DR=".03////^S X=IVM3;.12////^S X=IVM8;.07////^S X=IVM10;.09////^S X=IVM25;.11////^S X=IVM7;.18////^S X=IVM12;.23////^S X=IVM18;.25////^S X=IVM20;2.02////^S X=IVMDATE;2.03////^S X=IVM26"
"RTN","EASPREC7",114,0)
 . . D ^DIE K DA,DIE,DR                         ;Update Current Z06 MT
"RTN","EASPREC7",115,0)
 . . I $G(IVMMTDT)="" S IVMMTDT=EASMTDT
"RTN","EASPREC7",116,0)
 . . I $$EXPIRED^EASPTRN1(DFN,$G(IVMMTDT)) S EXPIRED=1,IVMZ10="UPLOAD IN PROGRESS"
"RTN","EASPREC7",117,0)
 . . D CLOSE^EASPTRN1(IVMIY,DFN,1,6)            ;Close Case/Converted
"RTN","EASPREC7",118,0)
 . . S DGCAT=$P($G(^DG(408.32,IVM3,0)),"^",1),IVM5=""
"RTN","EASPREC7",119,0)
 . . D MTBULL,MAIL^IVMUFNC()                    ;Send Bulletin
"RTN","EASPREC7",120,0)
 Q
"RTN","EASPREC7",121,0)
 ;
"RTN","EASPREC7",122,0)
MSH S (HLMID,MSGID)=$P(IVMSEG,HLFS,10)         ;Message control id from MSH
"RTN","EASPREC7",123,0)
 Q
"RTN","EASPREC7",124,0)
PID S DFN=$P($P(IVMSEG,HLFS,4),$E(HLECH))
"RTN","EASPREC7",125,0)
 I ('DFN!(DFN'=+DFN)!('$D(^DPT(+DFN,0)))) D  Q
"RTN","EASPREC7",126,0)
 . S HLERR="Invalid DFN"
"RTN","EASPREC7",127,0)
 I $P(IVMSEG,HLFS,20)'=$P(^DPT(DFN,0),"^",9) D  Q
"RTN","EASPREC7",128,0)
 . S HLERR="Couldn't match IVM SSN with DHCP SSN"
"RTN","EASPREC7",129,0)
 S IVMDAP=IVMDA                  ;Save IVMDA for veteran PID segment
"RTN","EASPREC7",130,0)
 Q
"RTN","EASPREC7",131,0)
ZIC I 'DEPFLG S IVMDGLY=$P(IVMSEG,"^",3)           ;Income year
"RTN","EASPREC7",132,0)
 Q
"RTN","EASPREC7",133,0)
ZIR Q
"RTN","EASPREC7",134,0)
ZDP S DEPFLG=1
"RTN","EASPREC7",135,0)
 Q
"RTN","EASPREC7",136,0)
 ;Get primary means test
"RTN","EASPREC7",137,0)
 ; IVMMTDT - means test date
"RTN","EASPREC7",138,0)
 ; DGLY - income year
"RTN","EASPREC7",139,0)
 ; If Means Test not in DHCP, don't upload IVM Means Test 
"RTN","EASPREC7",140,0)
 ;
"RTN","EASPREC7",141,0)
ZMT N IVMIEN
"RTN","EASPREC7",142,0)
 S IVMDAZ=IVMDA,ZMTSEG=IVMSEG                      ;ZMT segment ivmda
"RTN","EASPREC7",143,0)
 ;Means test date from ZMT segment
"RTN","EASPREC7",144,0)
 S (EASMTDT,IVMMTDT)=$$FMDATE^HLFNC($P(IVMSEG,HLFS,3))
"RTN","EASPREC7",145,0)
 S DGLY=$$LYR^DGMTSCU1(IVMMTDT)           ;Get means test to be updated
"RTN","EASPREC7",146,0)
 S MTDATE=-IVMMTDT
"RTN","EASPREC7",147,0)
 S IVMIEN=""
"RTN","EASPREC7",148,0)
 S MTFND=0
"RTN","EASPREC7",149,0)
 F  S IVMIEN=$O(^DGMT(408.31,"AID",1,DFN,MTDATE,IVMIEN)) Q:MTFND!(IVMIEN="")  S IVMMTIEN=IVMIEN D
"RTN","EASPREC7",150,0)
 . ; match to MT Z06 from Edb
"RTN","EASPREC7",151,0)
 . I $P($G(^DGMT(408.31,IVMIEN,0)),"^",3)=6!($P($G(^DGMT(408.31,IVMIEN,0)),"^",3)=16) D    ;Previous Converted?
"RTN","EASPREC7",152,0)
 . . S UPMTS=IVMIEN
"RTN","EASPREC7",153,0)
 . . S MTFND=1
"RTN","EASPREC7",154,0)
 Q
"RTN","EASPREC7",155,0)
ZIV S IVMDAV=IVMDA,ZIVSEG=IVMSEG
"RTN","EASPREC7",156,0)
 S IVMIY=$P(IVMSEG,HLFS,3)
"RTN","EASPREC7",157,0)
 S IVMIY=$$FMDATE^HLFNC(IVMIY)
"RTN","EASPREC7",158,0)
 I $E(IVMIY,4,7)'="0000"!($E(IVMIY,1,3)<292) D  Q
"RTN","EASPREC7",159,0)
 . S HLERR="Invalid Income Year"
"RTN","EASPREC7",160,0)
 I "01"'[$P(IVMSEG,HLFS,9) D  Q
"RTN","EASPREC7",161,0)
 . S HLERR="Case Status not 0 or 1"
"RTN","EASPREC7",162,0)
 I $P(IVMSEG,HLFS,9)=1 S CASEFLG=1         ;Close/Convert Case Flag
"RTN","EASPREC7",163,0)
 I $P(IVMSEG,HLFS,9)=0 S CASEFLG=0         ;Delete/Not Converted MT Flag
"RTN","EASPREC7",164,0)
BHS Q
"RTN","EASPREC7",165,0)
BTS Q
"RTN","EASPREC7",166,0)
 ;
"RTN","EASPREC7",167,0)
GET ; get HL7 segment from ^TMP
"RTN","EASPREC7",168,0)
 ;S IVMDA=$O(^TMP($J,IVMRTN,+IVMDA))
"RTN","EASPREC7",169,0)
 S IVMSEG=$G(^TMP($J,IVMRTN,+IVMDA,0))
"RTN","EASPREC7",170,0)
 S IVMSEG1=$E(IVMSEG,1,3)
"RTN","EASPREC7",171,0)
 S $E(SEGSTR,IVMDA)=1
"RTN","EASPREC7",172,0)
 Q
"RTN","EASPREC7",173,0)
 ;
"RTN","EASPREC7",174,0)
 ;Parse ZMT Segment for MT Data
"RTN","EASPREC7",175,0)
 ;
"RTN","EASPREC7",176,0)
PARSEZMT(ZSEG) S IVM2=$$FMDATE^HLFNC($P(ZMTSEG,"^",3))  ;Means Test Date
"RTN","EASPREC7",177,0)
 S IVM3=$O(^DG(408.32,"C",$P(ZMTSEG,"^",4),""))   ;Means Test Status 
"RTN","EASPREC7",178,0)
 S IVM7=$S($P(ZMTSEG,"^",8)="Y":1,1:0)            ;Agrees To Deductible
"RTN","EASPREC7",179,0)
 S IVM8=$P(ZMTSEG,"^",9)                          ;Threshold A
"RTN","EASPREC7",180,0)
 S IVM10=$$FMDATE^HLFNC($P(ZMTSEG,"^",11))        ;Date/Time Completed
"RTN","EASPREC7",181,0)
 S IVM12=$P(ZMTSEG,"^",13)                        ;Number of Dependents
"RTN","EASPREC7",182,0)
 S IVM17=$P(ZMTSEG,"^",18)                        ;Type of Test
"RTN","EASPREC7",183,0)
 S IVM18=$P(ZMTSEG,"^",19)                        ;Source of Test
"RTN","EASPREC7",184,0)
 S IVM20=$$FMDATE^HLFNC($P(ZMTSEG,"^",21))        ;IVM Verified MT
"RTN","EASPREC7",185,0)
 S IVM25=$$FMDATE^HLFNC($P(ZMTSEG,"^",26))        ;D/T Last Changed
"RTN","EASPREC7",186,0)
 S IVM26=$O(^DG(408.32,"C",$P(ZMTSEG,"^",27),"")) ;Test Determined Status
"RTN","EASPREC7",187,0)
 Q
"RTN","EASPREC7",188,0)
 ;
"RTN","EASPREC7",189,0)
MTBULL ; build mail message for transmission to IVM mail group notifying them
"RTN","EASPREC7",190,0)
 ; an IVM verified means test has been uploaded into DHCP for a patient.
"RTN","EASPREC7",191,0)
 ;
"RTN","EASPREC7",192,0)
 S IVMPAT=$$PT^IVMUFNC4(DFN)
"RTN","EASPREC7",193,0)
 S XMSUB="IVM - MEANS TEST UPLOAD for "_$P($P(IVMPAT,"^"),",")_" ("_$P(IVMPAT,"^",3)_")"
"RTN","EASPREC7",194,0)
 S IVMTEXT(1)="An Income Verification Match verified Means Test has been uploaded"
"RTN","EASPREC7",195,0)
 S IVMTEXT(2)="for the following patient:"
"RTN","EASPREC7",196,0)
 S IVMTEXT(3)=" "
"RTN","EASPREC7",197,0)
 S IVMTEXT(4)="  NAME:           "_$P(IVMPAT,"^")
"RTN","EASPREC7",198,0)
 S IVMTEXT(5)="  ID:             "_$P(IVMPAT,"^",2)
"RTN","EASPREC7",199,0)
 S Y=IVMMTDT X ^DD("DD")
"RTN","EASPREC7",200,0)
 S IVMTEXT(6)="  DATE OF TEST:   "_Y
"RTN","EASPREC7",201,0)
 S IVMTEXT(7)="  PREV CATEGORY:  "_$P($G(^DG(408.32,+$P(IVMMT31,"^",3),0)),"^",1)
"RTN","EASPREC7",202,0)
 S IVMTEXT(8)="  NEW CATEGORY:   "_DGCAT
"RTN","EASPREC7",203,0)
 I IVM5 S Y=IVM5 X ^DD("DD") S IVMTEXT(9)="  DATE/TIME OF ADJUDICATION:  "_Y
"RTN","EASPREC7",204,0)
 Q
"RTN","EASUM1")
0^1^B24411423
"RTN","EASUM1",1,0)
EASUM1 ;ALB/SEK - MEANS TEST UPLOAD DRIVER ; 3/6/01 5:13pm
"RTN","EASUM1",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**23,30,35**;21-OCT-94
"RTN","EASUM1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","EASUM1",4,0)
 ;
"RTN","EASUM1",5,0)
EN ; this routine will call routines to upload means tests sent by the IVM
"RTN","EASUM1",6,0)
 ; Center in HL7 segments.  the required sequence of these segments were
"RTN","EASUM1",7,0)
 ; validated in the calling routine IVMPREC7.  this routine will call
"RTN","EASUM1",8,0)
 ; IVMUCHK to ensure that the data is consistent with DHCP means test
"RTN","EASUM1",9,0)
 ; file and software requirements.
"RTN","EASUM1",10,0)
 ;
"RTN","EASUM1",11,0)
 ; entries will be added/modified in the following means test and
"RTN","EASUM1",12,0)
 ; patient files:
"RTN","EASUM1",13,0)
 ;
"RTN","EASUM1",14,0)
 ;       PATIENT RELATION (#408.12)
"RTN","EASUM1",15,0)
 ;       INCOME PERSON (#408.13)
"RTN","EASUM1",16,0)
 ;       INDIVIDUAL ANNUAL INCOME (#408.21)
"RTN","EASUM1",17,0)
 ;       INCOME RELATION (#408.22)
"RTN","EASUM1",18,0)
 ;       ANNUAL MEANS TEST (#408.31)
"RTN","EASUM1",19,0)
 ;       MEANS TEST CHANGES (#408.41)
"RTN","EASUM1",20,0)
 ;       PATIENT (#2)
"RTN","EASUM1",21,0)
 ;
"RTN","EASUM1",22,0)
 ; current year is date of means test.
"RTN","EASUM1",23,0)
 ; income year is calendar year before date of means test.
"RTN","EASUM1",24,0)
 ; meant test status is based on income year data.
"RTN","EASUM1",25,0)
 ;
"RTN","EASUM1",26,0)
 ; IVMDAP is pointer to the PID HL7 segment in file #772
"RTN","EASUM1",27,0)
 ; IVMDAZ is pointer to the ZMT segment
"RTN","EASUM1",28,0)
 ;
"RTN","EASUM1",29,0)
 S:'$D(DUZ) DUZ=.5 ; if no DUZ set to postmaster
"RTN","EASUM1",30,0)
 ;
"RTN","EASUM1",31,0)
 ; get copay exemption status (IVMCEB) and means test status (IVMMTB)
"RTN","EASUM1",32,0)
 ; before upload
"RTN","EASUM1",33,0)
 S IVMCEB=$P($$RXST^IBARXEU(DFN),"^",2)
"RTN","EASUM1",34,0)
 S IVMMTB=$P($$LST^DGMTU(DFN),"^",3)
"RTN","EASUM1",35,0)
 ;
"RTN","EASUM1",36,0)
 ; subscript of array IVMAR is ien of 408.12 transmitted by IVM Center
"RTN","EASUM1",37,0)
 ; or created by upload.
"RTN","EASUM1",38,0)
 ;K IVMAR
"RTN","EASUM1",39,0)
 ;S IVMX=$$EN^IVMUCHK() I IVMX]"" S HLERR=IVMX K IVMX Q  ; error found in MT data
"RTN","EASUM1",40,0)
 ;
"RTN","EASUM1",41,0)
ADD ; add new annual means test file (408.31) stub
"RTN","EASUM1",42,0)
 ; input   DGMTDT (.01) dt of test
"RTN","EASUM1",43,0)
 ;         DFN (.02) Patient IEN
"RTN","EASUM1",44,0)
 ;         DGMTYPT (.19) type of test (1-means test)
"RTN","EASUM1",45,0)
 ; output  DGMTI annual means test IEN
"RTN","EASUM1",46,0)
 S DGMTDT=IVMMTDT,DGMTYPT=1
"RTN","EASUM1",47,0)
 D ADD^DGMTA
"RTN","EASUM1",48,0)
 I $G(IVMMTIEN)="" S IVMMTIEN=+Y    ;Set IEN if only MT on file is Z06 MT
"RTN","EASUM1",49,0)
 ;
"RTN","EASUM1",50,0)
 ;Create new Z06 IVM Means Test
"RTN","EASUM1",51,0)
 ; Make STUB MT primary, add comment that it was created by Edb
"RTN","EASUM1",52,0)
 S DGCOM="Z06 MT via Edb"
"RTN","EASUM1",53,0)
 D PARSEZMT^EASPREC7(ZMTSEG)              ;Parse ZMT Segment for MT Data
"RTN","EASUM1",54,0)
 I $$EXPIRED^EASPTRN1(DFN,$G(IVM2)) S DGENUPLD="ENROLLMENT/ELIGIBILITY UPLOAD IN PROGRESS"    ;If MT expired then do not update Enrollment record
"RTN","EASUM1",55,0)
 S DA=DGMTI,DIE="^DGMT(408.31,"
"RTN","EASUM1",56,0)
 S DR=".03////^S X=IVM3;.12////^S X=IVM8;.07////^S X=IVM10;.09////^S X=IVM25;.11////^S X=IVM7;.18////^S X=IVM12;.23////^S X=IVM18;.25////^S X=IVM20;2////1;2.02////^S X=IVMDATE;2.03////^S X=IVM26;50///^S X=DGCOM"
"RTN","EASUM1",57,0)
 D ^DIE K DA,DIE,DR
"RTN","EASUM1",58,0)
 ;
"RTN","EASUM1",59,0)
 ;Variables needed for Bulletins
"RTN","EASUM1",60,0)
 ;
"RTN","EASUM1",61,0)
 S DGCAT=$P($G(^DG(408.32,IVM3,0)),"^",1)
"RTN","EASUM1",62,0)
 I '$D(IVM5) S IVM5=""
"RTN","EASUM1",63,0)
 ;
"RTN","EASUM1",64,0)
 D GETREL^DGMTU11(DFN,"V",DGLY,IVMMTIEN)
"RTN","EASUM1",65,0)
 I EASZ06 S (IVMMT31,DGMTP)=$G(^DGMT(408.31,IVMMTIEN,0)) ;dgmtp is event driver variable
"RTN","EASUM1",66,0)
 D COMPLETE
"RTN","EASUM1",67,0)
 Q
"RTN","EASUM1",68,0)
 ;
"RTN","EASUM1",69,0)
 ; add dependent(s) to income person file (408.13)
"RTN","EASUM1",70,0)
 ;
"RTN","EASUM1",71,0)
 ; add spouse if not in 408.13
"RTN","EASUM1",72,0)
 S IVMSPCHV="S" ; spouse/child/vet indicator
"RTN","EASUM1",73,0)
 S IVMDA1=IVMDAP+3 D GET ; spouse ZDP segment
"RTN","EASUM1",74,0)
 D INPIEN^IVMUM2
"RTN","EASUM1",75,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",76,0)
 ;
"RTN","EASUM1",77,0)
 I IVMFLG5 G ADDCHILD ; entry not added - goto add children
"RTN","EASUM1",78,0)
 ;
"RTN","EASUM1",79,0)
 ; add entry to patient relation file (408.12)
"RTN","EASUM1",80,0)
 D EN^IVMUM3
"RTN","EASUM1",81,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",82,0)
 ;
"RTN","EASUM1",83,0)
ADDS21 ; add spouse entry to individual annual income file (408.21)
"RTN","EASUM1",84,0)
 S IVMDA1=IVMDAP+4 D GET ; spouse ZIC segment
"RTN","EASUM1",85,0)
 D EN^IVMUM4
"RTN","EASUM1",86,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",87,0)
 ;
"RTN","EASUM1",88,0)
 ; add spouse entry to income relation file (408.22)
"RTN","EASUM1",89,0)
 S IVMDA1=IVMDAP+5 D GET ; spouse ZIR segment
"RTN","EASUM1",90,0)
 D EN^IVMUM5
"RTN","EASUM1",91,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",92,0)
 ;
"RTN","EASUM1",93,0)
ADDCHILD ; add children if not in 408.13
"RTN","EASUM1",94,0)
 S IVMSPCHV="C" ; spouse/child/vet indicator
"RTN","EASUM1",95,0)
 I 'IVMFLGC G ADDV21 ; no dependent children 
"RTN","EASUM1",96,0)
 S IVMCTR2=5
"RTN","EASUM1",97,0)
 F IVMCTR3=1:1:IVMFLGC D  Q:$D(IVMFERR)
"RTN","EASUM1",98,0)
 .S IVMCTR2=IVMCTR2+1
"RTN","EASUM1",99,0)
 .S IVMDA1=IVMDAP+IVMCTR2 D GET ; child ZDP segment
"RTN","EASUM1",100,0)
 .D INPIEN^IVMUM2
"RTN","EASUM1",101,0)
 .Q:$D(IVMFERR)
"RTN","EASUM1",102,0)
 .;
"RTN","EASUM1",103,0)
 .; add child entry to patient relation file (408.12)
"RTN","EASUM1",104,0)
 .D EN^IVMUM3
"RTN","EASUM1",105,0)
 .Q:$D(IVMFERR)
"RTN","EASUM1",106,0)
 .;
"RTN","EASUM1",107,0)
ADDC21 .; add child entry to individual annual income file (408.21)
"RTN","EASUM1",108,0)
 .S IVMCTR2=IVMCTR2+1
"RTN","EASUM1",109,0)
 .S IVMDA1=IVMDAP+IVMCTR2 D GET ; child ZIC segment
"RTN","EASUM1",110,0)
 .D EN^IVMUM4
"RTN","EASUM1",111,0)
 .Q:$D(IVMFERR)
"RTN","EASUM1",112,0)
 .;
"RTN","EASUM1",113,0)
 .; add entry to income relation file (408.22)
"RTN","EASUM1",114,0)
 .S IVMCTR2=IVMCTR2+1
"RTN","EASUM1",115,0)
 .S IVMDA1=IVMDAP+IVMCTR2 D GET ; child ZIR segment
"RTN","EASUM1",116,0)
 .D EN^IVMUM5
"RTN","EASUM1",117,0)
 .Q:$D(IVMFERR)
"RTN","EASUM1",118,0)
 .Q
"RTN","EASUM1",119,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",120,0)
 ;
"RTN","EASUM1",121,0)
ADDV21 ; add vet entry to individual annual income file (408.21)
"RTN","EASUM1",122,0)
 ; get vet patient relation ien
"RTN","EASUM1",123,0)
 S DGPRI=+$G(DGREL("V"))
"RTN","EASUM1",124,0)
 S IVMDA1=IVMDAP+1 D GET ; vet ZIC segment
"RTN","EASUM1",125,0)
 S IVMSPCHV="V" ; spouse/child/vet indicator
"RTN","EASUM1",126,0)
 D EN^IVMUM4
"RTN","EASUM1",127,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",128,0)
 S DGVINI=DGINI ; vet individual annual income ien
"RTN","EASUM1",129,0)
 ;
"RTN","EASUM1",130,0)
 ; add vet entry to income relation file (408.22)
"RTN","EASUM1",131,0)
 S IVMDA1=IVMDAP+2 D GET ; vet ZIR segment
"RTN","EASUM1",132,0)
 D EN^IVMUM5
"RTN","EASUM1",133,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",134,0)
 S DGVIRI=DGIRI ; vet income relation ien
"RTN","EASUM1",135,0)
 ;
"RTN","EASUM1",136,0)
COMPLETE ; complete means test
"RTN","EASUM1",137,0)
 ;
"RTN","EASUM1",138,0)
 ;D EN^IVMUM6
"RTN","EASUM1",139,0)
 ;Call Means Test Event Driver to complete processing
"RTN","EASUM1",140,0)
 ;
"RTN","EASUM1",141,0)
 S DGMTACT="UPL"
"RTN","EASUM1",142,0)
 D AFTER^DGMTEVT
"RTN","EASUM1",143,0)
 S DGMTINF=1                                    ;Non-Interactive Flag
"RTN","EASUM1",144,0)
 D EN^DGMTEVT
"RTN","EASUM1",145,0)
 D MTBULL^EASPREC7,MAIL^IVMUFNC()               ;Build Mail Message
"RTN","EASUM1",146,0)
 ;
"RTN","EASUM1",147,0)
 ; cleanup
"RTN","EASUM1",148,0)
 K DGINI,DGIRI,DGLY,DGMTDT,DGMTYPT,DGPRI,DGREL,DGVINI,DGVIRI,DGENUPLD
"RTN","EASUM1",149,0)
 K DGCAT,IVMAR,IVMCEB,IVMCTR2,IVMCTR3,IVMDA1,IVMDAP,IVMFERR
"RTN","EASUM1",150,0)
 K IVMFLG2,IVMFLG5,IVMFLGC,IVMMTB,IVMPRN
"RTN","EASUM1",151,0)
 K IVMRELN,IVMRELO,IVMSEG,IVMSPCHV,IVMX
"RTN","EASUM1",152,0)
 Q
"RTN","EASUM1",153,0)
 ; 
"RTN","EASUM1",154,0)
GET ; get HL7 segment from ^HL
"RTN","EASUM1",155,0)
 S IVMSEG=$P($G(^TMP($J,IVMRTN,IVMDA1,0)),"^",2,999)
"RTN","EASUM1",156,0)
 Q
"VER")
8.0^22
**END**
**END**
