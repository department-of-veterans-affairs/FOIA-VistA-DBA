Released PSJ*5*160 SEQ #164
Extracted from mail message
**KIDS**:PSJ*5.0*160^

**INSTALL NAME**
PSJ*5.0*160
"BLD",6055,0)
PSJ*5.0*160^INPATIENT MEDICATIONS^0^3070207^y
"BLD",6055,1,0)
^^21^21^3070206^
"BLD",6055,1,1,0)
1. During testing of Remote Data Interoperability (RDI), a problem was 
"BLD",6055,1,2,0)
discovered with the order checks involving remote allergies. Not all of 
"BLD",6055,1,3,0)
the remote allergies were being included when doing order checks using VA 
"BLD",6055,1,4,0)
Drug Class. This patch corrects this problem.
"BLD",6055,1,5,0)
 
"BLD",6055,1,6,0)
2. An issue with too many false positive order checks was discovered when 
"BLD",6055,1,7,0)
doing order checks on certain drug classes. Analgesics, as a class, were 
"BLD",6055,1,8,0)
performing order checks across all members. For example: class CN101 was 
"BLD",6055,1,9,0)
generating an order check for class CN102. This patch corrects this 
"BLD",6055,1,10,0)
problem by ensuring that Analgesic order checks only match against the 
"BLD",6055,1,11,0)
specific class: CN101 to CN101. HD0000000161499
"BLD",6055,1,12,0)
 
"BLD",6055,1,13,0)
3. One feature of RDI is the notification to the user when processing 
"BLD",6055,1,14,0)
orders that only local data is being used - if the remote data is 
"BLD",6055,1,15,0)
unavailable. Several sites reported issues with this mechanism. This 
"BLD",6055,1,16,0)
patch corrects this problem by performing the check for remote data 
"BLD",6055,1,17,0)
availability upon entering the patient's chart, rather than on each order.
"BLD",6055,1,18,0)
 
"BLD",6055,1,19,0)
4. The list of remote allergies has been added to Patient Information 
"BLD",6055,1,20,0)
screen. If a patient has the same allergy information from several remote
"BLD",6055,1,21,0)
sites, it will only be listed once.
"BLD",6055,4,0)
^9.64PA^^
"BLD",6055,6)
2^
"BLD",6055,6.3)
12
"BLD",6055,"ABPKG")
n
"BLD",6055,"KRN",0)
^9.67PA^8989.52^19
"BLD",6055,"KRN",.4,0)
.4
"BLD",6055,"KRN",.401,0)
.401
"BLD",6055,"KRN",.402,0)
.402
"BLD",6055,"KRN",.403,0)
.403
"BLD",6055,"KRN",.5,0)
.5
"BLD",6055,"KRN",.84,0)
.84
"BLD",6055,"KRN",3.6,0)
3.6
"BLD",6055,"KRN",3.8,0)
3.8
"BLD",6055,"KRN",9.2,0)
9.2
"BLD",6055,"KRN",9.8,0)
9.8
"BLD",6055,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",6055,"KRN",9.8,"NM",1,0)
PSGSICHK^^0^B64473968
"BLD",6055,"KRN",9.8,"NM",2,0)
PSJDPT^^0^B6283782
"BLD",6055,"KRN",9.8,"NM",3,0)
PSJLMUTL^^0^B55033114
"BLD",6055,"KRN",9.8,"NM",4,0)
PSJMUTL^^0^B37412252
"BLD",6055,"KRN",9.8,"NM","B","PSGSICHK",1)

"BLD",6055,"KRN",9.8,"NM","B","PSJDPT",2)

"BLD",6055,"KRN",9.8,"NM","B","PSJLMUTL",3)

"BLD",6055,"KRN",9.8,"NM","B","PSJMUTL",4)

"BLD",6055,"KRN",19,0)
19
"BLD",6055,"KRN",19.1,0)
19.1
"BLD",6055,"KRN",101,0)
101
"BLD",6055,"KRN",409.61,0)
409.61
"BLD",6055,"KRN",771,0)
771
"BLD",6055,"KRN",870,0)
870
"BLD",6055,"KRN",8989.51,0)
8989.51
"BLD",6055,"KRN",8989.52,0)
8989.52
"BLD",6055,"KRN",8994,0)
8994
"BLD",6055,"KRN","B",.4,.4)

"BLD",6055,"KRN","B",.401,.401)

"BLD",6055,"KRN","B",.402,.402)

"BLD",6055,"KRN","B",.403,.403)

"BLD",6055,"KRN","B",.5,.5)

"BLD",6055,"KRN","B",.84,.84)

"BLD",6055,"KRN","B",3.6,3.6)

"BLD",6055,"KRN","B",3.8,3.8)

"BLD",6055,"KRN","B",9.2,9.2)

"BLD",6055,"KRN","B",9.8,9.8)

"BLD",6055,"KRN","B",19,19)

"BLD",6055,"KRN","B",19.1,19.1)

"BLD",6055,"KRN","B",101,101)

"BLD",6055,"KRN","B",409.61,409.61)

"BLD",6055,"KRN","B",771,771)

"BLD",6055,"KRN","B",870,870)

"BLD",6055,"KRN","B",8989.51,8989.51)

"BLD",6055,"KRN","B",8989.52,8989.52)

"BLD",6055,"KRN","B",8994,8994)

"BLD",6055,"QUES",0)
^9.62^^
"BLD",6055,"REQB",0)
^9.611^2^2
"BLD",6055,"REQB",1,0)
PSJ*5.0*146^2
"BLD",6055,"REQB",2,0)
PSJ*5.0*166^2
"BLD",6055,"REQB","B","PSJ*5.0*146",1)

"BLD",6055,"REQB","B","PSJ*5.0*166",2)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
160^3070207^11881
"PKG",197,22,1,"PAH",1,1,0)
^^21^21^3070207
"PKG",197,22,1,"PAH",1,1,1,0)
1. During testing of Remote Data Interoperability (RDI), a problem was 
"PKG",197,22,1,"PAH",1,1,2,0)
discovered with the order checks involving remote allergies. Not all of 
"PKG",197,22,1,"PAH",1,1,3,0)
the remote allergies were being included when doing order checks using VA 
"PKG",197,22,1,"PAH",1,1,4,0)
Drug Class. This patch corrects this problem.
"PKG",197,22,1,"PAH",1,1,5,0)
 
"PKG",197,22,1,"PAH",1,1,6,0)
2. An issue with too many false positive order checks was discovered when 
"PKG",197,22,1,"PAH",1,1,7,0)
doing order checks on certain drug classes. Analgesics, as a class, were 
"PKG",197,22,1,"PAH",1,1,8,0)
performing order checks across all members. For example: class CN101 was 
"PKG",197,22,1,"PAH",1,1,9,0)
generating an order check for class CN102. This patch corrects this 
"PKG",197,22,1,"PAH",1,1,10,0)
problem by ensuring that Analgesic order checks only match against the 
"PKG",197,22,1,"PAH",1,1,11,0)
specific class: CN101 to CN101. HD0000000161499
"PKG",197,22,1,"PAH",1,1,12,0)
 
"PKG",197,22,1,"PAH",1,1,13,0)
3. One feature of RDI is the notification to the user when processing 
"PKG",197,22,1,"PAH",1,1,14,0)
orders that only local data is being used - if the remote data is 
"PKG",197,22,1,"PAH",1,1,15,0)
unavailable. Several sites reported issues with this mechanism. This 
"PKG",197,22,1,"PAH",1,1,16,0)
patch corrects this problem by performing the check for remote data 
"PKG",197,22,1,"PAH",1,1,17,0)
availability upon entering the patient's chart, rather than on each order.
"PKG",197,22,1,"PAH",1,1,18,0)
 
"PKG",197,22,1,"PAH",1,1,19,0)
4. The list of remote allergies has been added to Patient Information 
"PKG",197,22,1,"PAH",1,1,20,0)
screen. If a patient has the same allergy information from several remote
"PKG",197,22,1,"PAH",1,1,21,0)
sites, it will only be listed once.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSGSICHK")
0^1^B64473968^B48075149
"RTN","PSGSICHK",1,0)
PSGSICHK ;BIR/CML3-CHECKS SPECIAL INSTRUCTIONS ;17 Aug 98 / 8:33 AM
"RTN","PSGSICHK",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**3,9,26,29,44,49,59,110,139,146,160**;16 DEC 97;Build 12
"RTN","PSGSICHK",3,0)
 ;
"RTN","PSGSICHK",4,0)
 ; Reference to ^PS(50.605 is supported by DBIA 696.
"RTN","PSGSICHK",5,0)
 ; Reference to EN^PSOORDRG is supported by DBIA 2190.
"RTN","PSGSICHK",6,0)
 ; Reference to ^PSI(58.1 is supported by DBIA 2284.
"RTN","PSGSICHK",7,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSGSICHK",8,0)
 ; Reference to ^PSD(58.8 is supported by DBIA 2283.
"RTN","PSGSICHK",9,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSGSICHK",10,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSGSICHK",11,0)
 ; Reference to ^PS(51 is supported by DBIA 2176.
"RTN","PSGSICHK",12,0)
 ; Reference to ^ORRDI1 is supported by DBIA 4659.
"RTN","PSGSICHK",13,0)
 ; Reference to ^XTMP("ORRDI" is supported by DBIA 4660.
"RTN","PSGSICHK",14,0)
 ; Reference to GETDATA^GMRAOR supported by DBIA 4847.
"RTN","PSGSICHK",15,0)
 ; Reference to ^TMP("GMRAOC" supported by DBIA 4848.
"RTN","PSGSICHK",16,0)
 ;
"RTN","PSGSICHK",17,0)
START ;
"RTN","PSGSICHK",18,0)
 I $S(X'?.ANP:1,X["^":1,1:$L(X)>180) K X Q
"RTN","PSGSICHK",19,0)
 S Y="" F Y(1)=1:1:$L(X," ") S Y(2)=$P(X," ",Y(1)) I Y(2)]"" D CHK Q:'$D(X)
"RTN","PSGSICHK",20,0)
 I $D(X),Y]"",X'=$E(Y,1,$L(Y)-1) D EN^DDIOL("EXPANDS TO: ") W Y F Y(1)=1:1 S Y(2)=$P(Y," ",Y(1)) Q:Y(2)=""  D:$L(Y(2))+$X>78 EN^DDIOL(Y(2)_" ")
"RTN","PSGSICHK",21,0)
 Q
"RTN","PSGSICHK",22,0)
 ;
"RTN","PSGSICHK",23,0)
CHK ;
"RTN","PSGSICHK",24,0)
 I $L(Y(2))<31,$D(^PS(51,+$O(^PS(51,"B",Y(2),0)),0)),$P(^(0),"^",2)]"",$P(^(0),"^",4) S Y(2)=$P(^(0),"^",2)
"RTN","PSGSICHK",25,0)
 I $L(Y)+$L(Y(2))>180 K X Q
"RTN","PSGSICHK",26,0)
 S Y=Y_Y(2)_" " Q
"RTN","PSGSICHK",27,0)
 ;
"RTN","PSGSICHK",28,0)
ENSET(X) ; expands the SPECIAL INSTRUCTIONS field contained in X into Y
"RTN","PSGSICHK",29,0)
 N X1,X2,Y S Y=""
"RTN","PSGSICHK",30,0)
 F X1=1:1:$L(X," ") S X2=$P(X," ",X1) I X2]"" S Y=Y_$S($L(X2)>30:X2,'$D(^PS(51,+$O(^PS(51,"B",X2,0)),0)):X2,$P(^(0),"^",2)]""&$P(^(0),"^",4):$P(^(0),"^",2),1:X2)_" "
"RTN","PSGSICHK",31,0)
 S Y=$E(Y,1,$L(Y)-1) Q Y
"RTN","PSGSICHK",32,0)
 ;
"RTN","PSGSICHK",33,0)
END ; used by DRUG (55.06,101 & 53.1,101) x-refs to warn user if patient is receiving or about to receive the drug just ordered
"RTN","PSGSICHK",34,0)
 Q:$D(PSJHLSKP)
"RTN","PSGSICHK",35,0)
 N Z,ZZ,STATUSNP I $G(PSJPWD)&($P($G(PSJSYSU),";")=3)&($G(PSGDRG)) I ($D(^PSI(58.1,"D",PSGDRG,PSJPWD)))!($D(^PSD(58.8,"D",PSGDRG,PSJPWD))) D EN^DDIOL("                         *** A WARD STOCK ITEM ***")
"RTN","PSGSICHK",36,0)
 D NOW^%DTC
"RTN","PSGSICHK",37,0)
 N PSJDCHK F Z=%:0 S Z=$O(^PS(55,+PSGP,5,"AUS",Z)) Q:'Z!$D(DUOUT)  F ZZ=0:0 S ZZ=$O(^PS(55,+PSGP,5,"AUS",Z,ZZ)) Q:'ZZ!$D(DUOUT)  I +$G(^PS(55,+PSGP,5,ZZ,.2))=PSGX D PDWCHK(+PSGP,ZZ_"U") S PSJDCHK=1
"RTN","PSGSICHK",38,0)
 F STATUSNP="N","P" F Z=0:0 S Z=$O(^PS(53.1,"AS",STATUSNP,+PSGP,Z)) Q:'Z!$D(DUOUT)  I +$G(^PS(53.1,+Z,.2))=PSGX D PDWCHK(+PSGP,Z_"P") S PSJDCHK=1
"RTN","PSGSICHK",39,0)
 I $D(PSJDCHK) N DIR D
"RTN","PSGSICHK",40,0)
 .S DIR(0)="Y",DIR("A")="Do you wish to continue entering this order",DIR("?",1)="Enter ""N"" if you wish to exit without creating a new order,"
"RTN","PSGSICHK",41,0)
 .S DIR("?")="or ""Y"" to continue with the order entry process." D ^DIR S:'Y Y=-1,X="^"
"RTN","PSGSICHK",42,0)
 K Z,ZZ
"RTN","PSGSICHK",43,0)
 Q
"RTN","PSGSICHK",44,0)
 ;
"RTN","PSGSICHK",45,0)
ENDDC(PSGP,PSJDD) ; Perform Duplicate Drug, Duplicate Class,
"RTN","PSGSICHK",46,0)
 ; Drug-Drug interaction check, Drug-Allergy interaction check.
"RTN","PSGSICHK",47,0)
 N PSJLINE,Z,ZZ,PSJFST
"RTN","PSGSICHK",48,0)
 S (PSJLINE,PSJFST)=0
"RTN","PSGSICHK",49,0)
 I $G(PSJPWD)&($P($G(PSJSYSU),";")=3)&($G(PSJDD)) I ($D(^PSI(58.1,"D",PSJDD,PSJPWD)))!($D(^PSD(58.8,"D",PSJDD,PSJPWD))) W !?25,"*** A WARD STOCK ITEM ***"
"RTN","PSGSICHK",50,0)
 D EN^PSOORDRG(PSGP,PSJDD) K PSJPDRG N INTERVEN,PSJIREQ,PSJRXREQ S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)="" S DFN=PSGP
"RTN","PSGSICHK",51,0)
 I $T(HAVEHDR^ORRDI1)]"",$$HAVEHDR^ORRDI1,'$D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D
"RTN","PSGSICHK",52,0)
 . I $P($G(^XTMP("ORRDI","PSOO",PSGP,0)),"^",3)<0 W !,"Remote data not available - Only local order checks processed." D PAUSE^PSJLMUT1
"RTN","PSGSICHK",53,0)
 I $D(^TMP($J,"DD")) D ORDCHK^PSJLMUT1(PSGP,"DD",4)
"RTN","PSGSICHK",54,0)
 I $D(^TMP($J,"DC")) D ORDCHK^PSJLMUT1(PSGP,"DC",6)
"RTN","PSGSICHK",55,0)
IVSOL ;*** Start order check for IV solution at this point.
"RTN","PSGSICHK",56,0)
 I '$D(PSJFST) N PSJFST S PSJFST=0
"RTN","PSGSICHK",57,0)
 I $D(^TMP($J,"DI")) S INTERVEN=1 D ORDCHK^PSJLMUT1(PSGP,"DI",8)
"RTN","PSGSICHK",58,0)
 ;*** Allergy/adverse reaction check.
"RTN","PSGSICHK",59,0)
 N PTR,X
"RTN","PSGSICHK",60,0)
 S PTR=$P($G(^PSDRUG(PSJDD,"ND")),U)_"."_$P($G(^PSDRUG(PSJDD,"ND")),U,3)
"RTN","PSGSICHK",61,0)
 K ^TMP("PSJDAI",$J) S PSJACK=$$ORCHK^GMRAOR(DFN,"DR",PTR) D:$G(PSJACK)=1
"RTN","PSGSICHK",62,0)
 .S ^TMP("PSJDAI",$J,0)=1
"RTN","PSGSICHK",63,0)
 .S I=0 F  S I=$O(GMRAING(I)) Q:'I  S ^TMP("PSJDAI",$J,I,0)=GMRAING(I)
"RTN","PSGSICHK",64,0)
 I $D(^TMP("PSJDAI",$J)) S PSJPDRG=1 D
"RTN","PSGSICHK",65,0)
 .W $C(7),!!,"A Drug-Allergy Reaction exists for this medication!",!!
"RTN","PSGSICHK",66,0)
 .W !?7,"Drug: "_$P($G(^PSDRUG(PSJDD,0)),"^") I $O(^TMP("PSJDAI",$J)) W !,"Ingredients: " D
"RTN","PSGSICHK",67,0)
 ..S I=0 F  S I=$O(^TMP("PSJDAI",$J,I)) Q:'I  W:$X+$L($G(^(I,0)))+2>IOM !?19 W:I=1 $G(^TMP("PSJDAI",$J,I,0)) W:I>1 ", ",$G(^TMP("PSJDAI",$J,I,0))
"RTN","PSGSICHK",68,0)
 .W !!
"RTN","PSGSICHK",69,0)
 K PSJACK,GMRAING,I,^TMP($J)
"RTN","PSGSICHK",70,0)
 D ALGCLASS
"RTN","PSGSICHK",71,0)
CONT ; Ask user if they wish to continue in spite of an order check.
"RTN","PSGSICHK",72,0)
 Q:'$D(PSJPDRG)  N DIR S DIR(0)="Y",DIR("A")="Do you wish to continue entering this order",DIR("?",1)="Enter ""N"" if you wish to exit without creating a new order,"
"RTN","PSGSICHK",73,0)
 S DIR("?")="or ""Y"" to continue with the order entry process.",DIR("B")="NO" D ^DIR I 'Y S PSGORQF=1,X="^",COMQUIT=1 Q
"RTN","PSGSICHK",74,0)
 I 'INTERVEN!($P(PSJSYSU,";")'=3) Q
"RTN","PSGSICHK",75,0)
 NEW PSJY
"RTN","PSGSICHK",76,0)
 W:PSJIREQ !!,"This is a CRITICAL interaction, you must enter an intervention log to continue"
"RTN","PSGSICHK",77,0)
 S DIR(0)="Y",DIR("A")="Do you wish to log an intervention",DIR("?",1)="Enter ""N"" if you do not wish to log an intervention,",DIR("?")="or ""Y"" to log an intervention." D ^DIR S PSJY=Y D:Y ^PSJRXI
"RTN","PSGSICHK",78,0)
 I 'PSJY,PSJIREQ S PSGORQF=1,COMQUIT=1
"RTN","PSGSICHK",79,0)
 Q
"RTN","PSGSICHK",80,0)
 ;
"RTN","PSGSICHK",81,0)
ENDL ; used by PSGTRAIN DRUG LOOK-UP option
"RTN","PSGSICHK",82,0)
 D ENCV^PSGSETU Q:$D(XQUIT)
"RTN","PSGSICHK",83,0)
 F  S DIC="^PSDRUG(",DIC(0)="AEIMOQZ",DIC("A")="Select DRUG: " W ! D ^DIC K DIC Q:+Y'>0  D SF
"RTN","PSGSICHK",84,0)
 D ENKV^PSGSETU K N5,ND,Q,Y Q
"RTN","PSGSICHK",85,0)
 ;
"RTN","PSGSICHK",86,0)
SF ;
"RTN","PSGSICHK",87,0)
 S Y=+Y,ND=$G(^PSDRUG(Y,0)),PSGID=+$G(^("I")) I PSGID W !!,"THIS DRUG IS INACTIVE AS OF ",$E($$ENDTC^PSGMI(PSGID),1,8)
"RTN","PSGSICHK",88,0)
 W !!,$S($P(ND,"^",9):"NON-",1:""),"FORMULARY ITEM" W:$P(ND,"^",10)]"" !,$P(ND,"^",10)
"RTN","PSGSICHK",89,0)
 S ND=$P($G(^PSDRUG(Y,2)),"^",3)["U" W !,$P("NOT^","^",ND+1)," A UNIT DOSE DRUG" W ! S ND=$G(^(8)),N5=$G(^(8.5)) W !?2,"DAY (nD) or DOSE (nL) LIMIT: " I ND W $P(ND,"^")
"RTN","PSGSICHK",90,0)
 W !?10,"UNIT DOSE MED ROUTE: " I $P(ND,"^",2) W $S($D(^PS(51.2,$P(ND,"^",2),0)):$P(^(0),"^"),1:$P(ND,"^",2))
"RTN","PSGSICHK",91,0)
 ; NAKED REF below refers to ^PS(51.2, on line above.
"RTN","PSGSICHK",92,0)
 W !?6,"UNIT DOSE SCHEDULE TYPE: " I $P(ND,"^",3)]"" W $P($P(";"_$P(^(0),"^",3),";"_$P(ND,"^",3)_":",2),";")
"RTN","PSGSICHK",93,0)
 W !?11,"UNIT DOSE SCHEDULE: " I $P(ND,"^",4)]"" W $P(ND,"^",4)
"RTN","PSGSICHK",94,0)
 W !,"CORRESPONDING OUTPATIENT DRUG: " I $P(ND,"^",5) W $S('$D(^PSDRUG(+$P(ND,"^",5),0)):$P(ND,"^",5),$P(^(0),"^")]"":$P(^(0),"^"),1:$P(ND,"^",5))
"RTN","PSGSICHK",95,0)
 W !?17,"ATC MNEMONIC: " I $P(N5,"^",2)]"" W $P(N5,"^",2)
"RTN","PSGSICHK",96,0)
 W !?17,"ATC CANISTER: " F Q=0:0 S Q=$O(^PSDRUG(Y,212,Q)) Q:'Q  S ND=$G(^(Q,0)) I ND,$P(ND,"^",2) W ?31,$S('$D(^PS(57.5,+ND,0)):+ND_";PS(57.5,",$P(^(0),"^")]"":$P(^(0),"^"),1:+ND_";PS(57.5,"),?56,$P(ND,"^",2),!
"RTN","PSGSICHK",97,0)
 Q
"RTN","PSGSICHK",98,0)
 ;
"RTN","PSGSICHK",99,0)
OCHK ; Add drugs in current order to ^TMP("ORDERS" and call order checker.
"RTN","PSGSICHK",100,0)
 ; Set PSJOCHK=1 so OP order check doesn't Kill array.
"RTN","PSGSICHK",101,0)
 ;
"RTN","PSGSICHK",102,0)
 K ^TMP($J,"ORDERS")
"RTN","PSGSICHK",103,0)
 N PSJOCHK S PSJOCHK=1
"RTN","PSGSICHK",104,0)
PDWCHK(DFN,ON) ; Print Dup Drug order.
"RTN","PSGSICHK",105,0)
 N ND,ND0,ND2,X
"RTN","PSGSICHK",106,0)
 W:'$D(PSJDCHK) $C(7),$C(7),!!,"WARNING! THIS PATIENT HAS THE FOLLOWING ORDER(S) FOR THIS MEDICATION:",!!
"RTN","PSGSICHK",107,0)
 S ND=$$DRUGNAME^PSJLMUTL(DFN,ON)
"RTN","PSGSICHK",108,0)
 S F=$S(ON["P":"^PS(53.1,",1:"^PS(55,"_DFN_",5,"),ND0=$G(@(F_+ON_",0)")),ND2=$G(^(2)),X=$P(ND,U,2),X=$S(X=.2:$P($G(^(.2)),U,2),1:$G(^(.3)))
"RTN","PSGSICHK",109,0)
 W ?10,$P(ND,U),!,?13,"Give: ",X," ",$$ENMRN^PSGMI(+$P(ND0,U,3))," ",$P(ND2,U),!!
"RTN","PSGSICHK",110,0)
 Q
"RTN","PSGSICHK",111,0)
ALGCLASS ; checks any Drug allergies or reactions to see if
"RTN","PSGSICHK",112,0)
 ;         the new drug is the same class
"RTN","PSGSICHK",113,0)
 ; this call can be removed by commenting out the call on IVSOL+16
"RTN","PSGSICHK",114,0)
 N PSJLIST,CT,CLS,CLCHK,CNT,PSJL,LIST,DCCNT,PSCLASS,LEN
"RTN","PSGSICHK",115,0)
 S PSCLASS=$P($G(^PSDRUG(PSJDD,0)),"^",2),LEN=4 I $E(PSCLASS,1,4)="CN10" S LEN=5 ;look at 5 chars if ANALGESICS
"RTN","PSGSICHK",116,0)
 I $T(GETDATA^GMRAOR)]"" G ALGC2
"RTN","PSGSICHK",117,0)
 S GMRA="0^0^111" D EN1^GMRADPT
"RTN","PSGSICHK",118,0)
 F PSJLIST=0:0 S PSJLIST=$O(GMRAL(PSJLIST)) Q:'PSJLIST  D
"RTN","PSGSICHK",119,0)
 .K PSJAGL D EN1^GMRAOR2(PSJLIST,"PSJAGL")
"RTN","PSGSICHK",120,0)
 .; is the allergy/reaction drug class first four digits the same as the
"RTN","PSGSICHK",121,0)
 .; the class for the drug being entered?
"RTN","PSGSICHK",122,0)
 .S (CT,CLS)="",DCCNT=0
"RTN","PSGSICHK",123,0)
 .I $D(PSJAGL("V")) D
"RTN","PSGSICHK",124,0)
 ..F  S DCCNT=$O(PSJAGL("V",DCCNT)) Q:'DCCNT  S:$E($P($G(PSJAGL("V",DCCNT)),"^"),1,LEN)=$E(PSCLASS,1,LEN) (PSJPDRG,CLCHK)=1,CNT=$S('$D(CNT):1,1:CNT+1),LIST(CNT)=$P($G(PSJAGL),"^")_"^"_$P($G(PSJAGL("V",DCCNT)),"^",2)
"RTN","PSGSICHK",125,0)
 D:$G(CLCHK)
"RTN","PSGSICHK",126,0)
 .W !!,$C(7),"A Drug-Allergy Reaction exists for this medication and/or class!"
"RTN","PSGSICHK",127,0)
 .F PSJL=0:0 S PSJL=$O(LIST(PSJL)) Q:'PSJL  D
"RTN","PSGSICHK",128,0)
 ..W !?6,"Drug: "_$P(LIST(PSJL),"^"),!,"Drug Class: "_$P(LIST(PSJL),"^",2),!
"RTN","PSGSICHK",129,0)
 Q
"RTN","PSGSICHK",130,0)
ALGC2 ;
"RTN","PSGSICHK",131,0)
 K GMRADRCL
"RTN","PSGSICHK",132,0)
 D GETDATA^GMRAOR(DFN) Q:'$D(^TMP("GMRAOC",$J,"APC"))
"RTN","PSGSICHK",133,0)
 N GMRACL,RET
"RTN","PSGSICHK",134,0)
 S RET=0,GMRACL="" F  S GMRACL=$O(^TMP("GMRAOC",$J,"APC",GMRACL)) Q:'$L(GMRACL)  D
"RTN","PSGSICHK",135,0)
 .N GMRANM,GMRALOC
"RTN","PSGSICHK",136,0)
 .S GMRALOC=^TMP("GMRAOC",$J,"APC",GMRACL)
"RTN","PSGSICHK",137,0)
 .S GMRANM=$P(^PS(50.605,+$O(^PS(50.605,"B",GMRACL,0)),0),U,2)
"RTN","PSGSICHK",138,0)
 .S GMRADRCL(GMRACL)=GMRACL_U_GMRANM_" ("_GMRALOC_")"
"RTN","PSGSICHK",139,0)
 .S RET=RET+1
"RTN","PSGSICHK",140,0)
 Q:'RET  K ^TMP("GMRAOC",$J)
"RTN","PSGSICHK",141,0)
 S CLCHK="",CT="" F  S CT=$O(GMRADRCL(CT)) Q:CT=""  D
"RTN","PSGSICHK",142,0)
 .I $E(PSCLASS,1,LEN)=$E(CT,1,LEN) S CLCHK=$G(CLCHK)+1,^TMP($J,"PSJDRCLS",CLCHK)=CT_" "_$P(GMRADRCL(CT),"^",2)
"RTN","PSGSICHK",143,0)
CLASSDSP ;
"RTN","PSGSICHK",144,0)
 I '$D(^TMP($J,"PSJDRCLS")) Q
"RTN","PSGSICHK",145,0)
 W $C(7),!,"A Drug-Allergy Reaction exists for this medication and/or class!",!
"RTN","PSGSICHK",146,0)
 W !,"Drug: "_$P($G(^PSDRUG(PSJDD,0)),"^")
"RTN","PSGSICHK",147,0)
 S CT="" F  S CT=$O(^TMP($J,"PSJDRCLS",CT)) Q:CT=""  W !,"Drug Class: "_^TMP($J,"PSJDRCLS",CT)
"RTN","PSGSICHK",148,0)
 K ^TMP($J,"PSJDRCLS")
"RTN","PSGSICHK",149,0)
 S DIR("?",1)="Answer 'YES' if you DO want to enter a reaction for this medication,"
"RTN","PSGSICHK",150,0)
 S DIR("?")="       'NO' if you DON'T want to enter a reaction for this medication,"
"RTN","PSGSICHK",151,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")="Y" W ! D ^DIR
"RTN","PSGSICHK",152,0)
 I Y D ^PSJRXI
"RTN","PSGSICHK",153,0)
 I '$G(Y) K DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y Q
"RTN","PSGSICHK",154,0)
 Q
"RTN","PSJDPT")
0^2^B6283782^B4403319
"RTN","PSJDPT",1,0)
PSJDPT ;BIR/JLC - CENTRALIZED PATIENT LOOKUP FOR IPM ; 07 Nov 00
"RTN","PSJDPT",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**53,124,166,160**;16 DEC 97;Build 12
"RTN","PSJDPT",3,0)
 ;
"RTN","PSJDPT",4,0)
 ; Reference to ^DPT is supported by DBIA 10035
"RTN","PSJDPT",5,0)
 ; Reference to ^DGSEC4 is supported by DBIA 3027
"RTN","PSJDPT",6,0)
 ; Reference to ^DIC is supported by DBIA 10006
"RTN","PSJDPT",7,0)
 ; Reference to ^DICN is supported by DBIA 10009
"RTN","PSJDPT",8,0)
 ; Reference to ^DPTLK is supported by DBIA 3787
"RTN","PSJDPT",9,0)
 ; Reference to ^DPTLK1 is supported by DBIA 3266
"RTN","PSJDPT",10,0)
 ; Reference to DISPPRF^DGPFAPI is supported by DBIA 4563
"RTN","PSJDPT",11,0)
 ; Reference to GETACT^DGPFAPI is supported by DBIA 3860
"RTN","PSJDPT",12,0)
 ; Reference to ^ORRDI1 is supported by DBIA 4659.
"RTN","PSJDPT",13,0)
 ; Reference to ^XTMP("ORRDI" is supported by DBIA 4660.
"RTN","PSJDPT",14,0)
 ;
"RTN","PSJDPT",15,0)
EN ; MAIN ENTRY POINT FOR PATIENT LOOKUP
"RTN","PSJDPT",16,0)
 K DIC S DIC="^DPT(",DIC("W")="D DPT^PSJDPT",DIC(0)="QEMZ" D ^DPTLK K DIC
"RTN","PSJDPT",17,0)
 I $$BADADR^DGUTL3(+Y) H 2
"RTN","PSJDPT",18,0)
 N Y
"RTN","PSJDPT",19,0)
 D
"RTN","PSJDPT",20,0)
 . I $T(HAVEHDR^ORRDI1)]"",$$HAVEHDR^ORRDI1,$D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) W !,"Remote data not available - Only local order checks processed." D PAUSE^PSJLMUT1
"RTN","PSJDPT",21,0)
 Q
"RTN","PSJDPT",22,0)
CHK(Y,DISP,PAUSE) N RESULT,RES,CHKY,PSGTEMP
"RTN","PSJDPT",23,0)
 S DISP=$G(DISP),PAUSE=$G(PAUSE)
"RTN","PSJDPT",24,0)
 I $G(XQY0)["PSJI COMPLETE",$$GETACT^DGPFAPI(+Y,"PSGTEMP") K PSGTEMP W @IOF,"PATIENT: ",$P(Y,U,2)
"RTN","PSJDPT",25,0)
 S CHKY=Y D DISPPRF^DGPFAPI(Y) S Y=CHKY K CHKY
"RTN","PSJDPT",26,0)
 D PTSEC^DGSEC4(.RESULT,$P(Y,"^"),1)
"RTN","PSJDPT",27,0)
 I RESULT(1)'=0 D
"RTN","PSJDPT",28,0)
 . W !! I DISP W ?(80-$L($P(Y,"^",2)))\2,$P(Y,"^",2),!
"RTN","PSJDPT",29,0)
 . F I=2:1:9 I $D(RESULT(I)) W ?(80-$L(RESULT(I)))\2,RESULT(I),!
"RTN","PSJDPT",30,0)
 . I RESULT(1)'=0,RESULT(1)'=2,PAUSE H 2
"RTN","PSJDPT",31,0)
 . Q:RESULT(1)=1
"RTN","PSJDPT",32,0)
 . I RESULT(1)=-1!(RESULT(1)=3)!(RESULT(1)=4) S Y=-1 Q
"RTN","PSJDPT",33,0)
 . I RESULT(1)=2 D ENCONT I Y=-1 Q
"RTN","PSJDPT",34,0)
 . D NOTICE^DGSEC4(.RES,Y,XQY0,$S(RESULT(1)=1:1,1:3)) I RES=0 S Y=-1 Q
"RTN","PSJDPT",35,0)
 Q
"RTN","PSJDPT",36,0)
ENCONT W !,"Do you want to continue processing this patient record"
"RTN","PSJDPT",37,0)
 S %=2 D YN^DICN I %<0!(%=2) S Y=-1
"RTN","PSJDPT",38,0)
 I '% W !!,"Enter 'YES' to continue processing, or 'NO' to quit processing this record." G ENCONT
"RTN","PSJDPT",39,0)
 Q
"RTN","PSJDPT",40,0)
DPT I $$DOB^DPTLK1(Y)["*SENSITIVE" G SENS
"RTN","PSJDPT",41,0)
 S ND=$S($D(^DPT(Y,0)):^(0),1:""),NB=$P(ND,"^",3),NS=$P(ND,"^",9)
"RTN","PSJDPT",42,0)
 I NS W ?42,$E(NS,1,3),"-",$E(NS,4,5),"-",$E(NS,6,10)," "
"RTN","PSJDPT",43,0)
 I NB W ?55,$E(NB,4,5),"/",$E(NB,6,7),"/",$E(NB,2,3)," "
"RTN","PSJDPT",44,0)
 I $D(^DPT(Y,.1)) W ?67,$P(^(.1),"^")
"RTN","PSJDPT",45,0)
 Q
"RTN","PSJDPT",46,0)
SENS W ?42,"*SENSITIVE* ",?55,"*SENSITIVE* ",?67,"*SENSITIVE*" Q
"RTN","PSJLMUTL")
0^3^B55033114^B55430088
"RTN","PSJLMUTL",1,0)
PSJLMUTL ;BIR/MLM-INPATIENT LISTMAN UTILITIES ;29 May 98 / 8:35 AM
"RTN","PSJLMUTL",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**7,67,58,85,111,160**;16 DEC 97;Build 12
"RTN","PSJLMUTL",3,0)
 ;
"RTN","PSJLMUTL",4,0)
 ; Reference to ^ORD(101 is supported by DBIA #872.
"RTN","PSJLMUTL",5,0)
 ; Reference to ^PS(50.606 is supported by DBIA #2174.
"RTN","PSJLMUTL",6,0)
 ; Reference to ^PS(50.7 is supported by DBIA #2180.
"RTN","PSJLMUTL",7,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJLMUTL",8,0)
 ; Reference to ^PSDRUG is supported by DBIA #2192.
"RTN","PSJLMUTL",9,0)
 ; Reference to ^GMRAPEM0 is supported by DBIA #190.
"RTN","PSJLMUTL",10,0)
 ; Reference to ^SDAMA203 is supported by DBIA #4133.
"RTN","PSJLMUTL",11,0)
 ; Reference to ^VSIT is supported by DBIA #1905.
"RTN","PSJLMUTL",12,0)
 ;
"RTN","PSJLMUTL",13,0)
NEWALL(DFN) ; Enter Allergy info.
"RTN","PSJLMUTL",14,0)
 ;
"RTN","PSJLMUTL",15,0)
 D FULL^VALM1,EN2^GMRAPEM0
"RTN","PSJLMUTL",16,0)
 Q
"RTN","PSJLMUTL",17,0)
DISALL(DFN) ; Display brief patient info list.
"RTN","PSJLMUTL",18,0)
 K ^TMP("PSJALL",$J) N PSJLN,X,Y,PSGALG,PSGRALG,PSGLDR,PSJGMRAL,PSJWHERE S PSJWHERE="PSJLMUTL"
"RTN","PSJLMUTL",19,0)
 D ATS^PSJMUTL(57,57,2)
"RTN","PSJLMUTL",20,0)
 I (PSJGMRAL=0) S ^TMP("PSJALL",$J,1,0)=" Allergies/Reactions: "_"NKA",PSJLN=2 G NARRATIV
"RTN","PSJLMUTL",21,0)
 I (PSJGMRAL="") S ^TMP("PSJALL",$J,1,0)=" Allergies/Reactions: No Allergy Assessment",PSJLN=2 G NARRATIV
"RTN","PSJLMUTL",22,0)
 I ($G(PSGVALG(1))="NKA")!((PSGVALG=0)&(PSGALG=0)) D
"RTN","PSJLMUTL",23,0)
 .S ^TMP("PSJALL",$J,1,0)="           Allergies: "_$G(PSGVALG(1)),PSJLN=2,X=1
"RTN","PSJLMUTL",24,0)
 I ($G(PSGVALG(1))'="NKA")&((PSGVALG>0)!(PSGALG>0)) D
"RTN","PSJLMUTL",25,0)
 .S ^TMP("PSJALL",$J,1,0)="Allergies - Verified: "_$G(PSGVALG(1)),PSJLN=2,X=1
"RTN","PSJLMUTL",26,0)
 .F  S X=$O(PSGVALG(X)) Q:'X  S ^TMP("PSJALL",$J,PSJLN,0)="                        "_PSGVALG(X),PSJLN=PSJLN+1
"RTN","PSJLMUTL",27,0)
 .S ^TMP("PSJALL",$J,PSJLN,0)="        Non-Verified: "_$S($G(PSGALG(1))=0:"",1:$G(PSGALG(1))),PSJLN=PSJLN+1,X=1
"RTN","PSJLMUTL",28,0)
 .F  S X=$O(PSGALG(X)) Q:'X  S ^TMP("PSJALL",$J,PSJLN,0)="                        "_PSGALG(X),PSJLN=PSJLN+1
"RTN","PSJLMUTL",29,0)
 D RAD^PSJMUTL
"RTN","PSJLMUTL",30,0)
 I ($G(PSGVADR(1))="NKA")!((PSGVADR=0)&(PSGADR=0)) D
"RTN","PSJLMUTL",31,0)
 .S ^TMP("PSJALL",$J,PSJLN,0)="",^TMP("PSJALL",$J,PSJLN+1,0)="   Adverse Reactions: "_$G(PSGADR(1)),PSJLN=PSJLN+2,X=1
"RTN","PSJLMUTL",32,0)
 I ($G(PSGVADR(1))'="NKA")&((PSGVADR>0)!(PSGADR>0)) D
"RTN","PSJLMUTL",33,0)
 .S ^TMP("PSJALL",$J,PSJLN,0)="",^TMP("PSJALL",$J,PSJLN+1,0)="Reactions - Verified: "_$G(PSGVADR(1)),PSJLN=PSJLN+2,X=1
"RTN","PSJLMUTL",34,0)
 .F  S X=$O(PSGVADR(X)) Q:'X  S ^TMP("PSJALL",$J,PSJLN,0)="              "_PSGVADR(X),PSJLN=PSJLN+1
"RTN","PSJLMUTL",35,0)
 .S ^TMP("PSJALL",$J,PSJLN,0)="        Non-Verified: "_$G(PSGADR(1)),PSJLN=PSJLN+2,X=1
"RTN","PSJLMUTL",36,0)
 .F  S X=$O(PSGADR(X)) Q:'X  S ^TMP("PSJALL",$J,PSJLN,0)="              "_PSGADR(X),PSJLN=PSJLN+1
"RTN","PSJLMUTL",37,0)
 ;
"RTN","PSJLMUTL",38,0)
NARRATIV ; print inpatient/outpatient narratives
"RTN","PSJLMUTL",39,0)
 N PSJCLHD
"RTN","PSJLMUTL",40,0)
 S ^TMP("PSJALL",$J,PSJLN,0)="" D SETNAR("PSJALL",$G(^PS(55,DFN,5.3)),"In")
"RTN","PSJLMUTL",41,0)
 S ^TMP("PSJALL",$J,PSJLN+1,0)="" D SETNAR("PSJALL",$G(^PS(55,DFN,1)),"Out")
"RTN","PSJLMUTL",42,0)
 D SDA S PSJLN=0 F X=0:0 S X=$O(^TMP("PSJALL",$J,X)) Q:'X  S PSJLN=PSJLN+1
"RTN","PSJLMUTL",43,0)
 I '$G(PSJCLHD)!'$G(VALMCNT) S VALMCNT=PSJLN
"RTN","PSJLMUTL",44,0)
 Q
"RTN","PSJLMUTL",45,0)
 ;
"RTN","PSJLMUTL",46,0)
SDA N PSJPAD,PSJCLIN,PSJCLINO,PSJAPD,PSJSCI,PSJCLOK,VAERR K ^TMP("PSJVSIT"),PSJDBUN S $P(PSJPAD," ",26)=" "
"RTN","PSJLMUTL",47,0)
 Q:'$$PATCH^XPDUTL("SD*5.3*285")
"RTN","PSJLMUTL",48,0)
 D NOW^%DTC S VASD("F")=$P(%,".")-1
"RTN","PSJLMUTL",49,0)
 D SDA^VADPT S:$G(VAERR)=2 (PSJCLHD,PSJDBUN)=2 I $O(^UTILITY("VASD",$J,"")) M PSJUTL=^UTILITY("VASD",$J) D
"RTN","PSJLMUTL",50,0)
 . S PSJSCDT0=0
"RTN","PSJLMUTL",51,0)
 . F  S PSJSCDT0=$O(PSJUTL(PSJSCDT0)) Q:'PSJSCDT0  D
"RTN","PSJLMUTL",52,0)
 .. S PSJCLINO=$P($G(PSJUTL(PSJSCDT0,"E")),U,2),PSJCLIN=$P($G(PSJUTL(PSJSCDT0,"I")),U,2)
"RTN","PSJLMUTL",53,0)
 .. S PSJSCI=$G(PSJUTL(PSJSCDT0,"I")),PSJAPD=$$FMTE^XLFDT(+PSJSCI) Q:(PSJCLIN="")!(PSJAPD="")
"RTN","PSJLMUTL",54,0)
 .. S PSJCLOK=1 D SDAUTHCL^SDAMA203(PSJCLIN,.PSJCLOK) Q:(PSJCLOK<1)
"RTN","PSJLMUTL",55,0)
 .. S ^TMP("PSJVSIT",$J,+PSJSCI,PSJCLIN,"V")=$E(PSJCLINO_PSJPAD,1,25)_"  "_$TR(PSJAPD,"@","/"),PSJCLHD=1
"RTN","PSJLMUTL",56,0)
 .. D ENC(DFN,PSJCLIN)
"RTN","PSJLMUTL",57,0)
 I $G(PSJCLHD) S PSJLN=PSJLN+1 S ^TMP("PSJALL",$J,PSJLN,0)="Clinic:"_$E(PSJPAD,1,20)_"Date/Time of Appointment:",PSJLN=PSJLN+1 I $G(PSJCLHD)=2 D
"RTN","PSJLMUTL",58,0)
 . S ^TMP("PSJALL",$J,PSJLN,0)=" Scheduling database is unavailable",PSJLN=PSJLN+1
"RTN","PSJLMUTL",59,0)
 N VDAT S VDAT=0 F  S VDAT=$O(^TMP("PSJVSIT",$J,VDAT)) Q:'VDAT  S VCLIN=0 F  S VCLIN=$O(^TMP("PSJVSIT",$J,VDAT,VCLIN)) Q:'VCLIN  D
"RTN","PSJLMUTL",60,0)
 . F VTYP="E","V" S VDATA=$G(^TMP("PSJVSIT",$J,VDAT,VCLIN,VTYP)) I VDATA]"" S ^TMP("PSJALL",$J,PSJLN,0)=VDATA,PSJLN=PSJLN+1
"RTN","PSJLMUTL",61,0)
 I $G(PSJCLHD) S VALMCNT=((PSJLN+11\11)*11),PSJX=$O(^TMP("PSJALL",$J,9999),-1) ; F I=PSJX:1:VALMCNT S ^TMP("PSJALL",$J,I,0)=""
"RTN","PSJLMUTL",62,0)
 K PSJUTL,PSJCLHD
"RTN","PSJLMUTL",63,0)
 Q
"RTN","PSJLMUTL",64,0)
 ;
"RTN","PSJLMUTL",65,0)
ENC(SDPATDFN,SDCLIEN) ;
"RTN","PSJLMUTL",66,0)
 N SDFROM,DT,SUBVIS,VIS S SDSTART=$$FMADD^XLFDT($P(PSGDT,"."),-1),SDEND=$$FMADD^XLFDT($P(PSGDT,"."),+365) K ^TMP("VSIT",$J)
"RTN","PSJLMUTL",67,0)
 D SELECTED^VSIT(SDPATDFN,SDSTART,SDEND,SDCLIEN) N VIS S VIS=0 F  S VIS=$O(^TMP("VSIT",$J,VIS)) Q:'VIS  D
"RTN","PSJLMUTL",68,0)
 . S SUBVIS=0 F  S SUBVIS=$O(^TMP("VSIT",$J,VIS,SUBVIS)) Q:'SUBVIS  D
"RTN","PSJLMUTL",69,0)
 .. S PSJSCI=$P(^TMP("VSIT",$J,VIS,SUBVIS),U),PSJAPD=$$FMTE^XLFDT(PSJSCI,1) Q:PSJSCI<1!(PSJAPD="")
"RTN","PSJLMUTL",70,0)
 .. S ^TMP("PSJVSIT",$J,PSJSCI,PSJCLIN,"E")=$E(PSJCLINO_PSJPAD,1,25)_"  "_$TR(PSJAPD,"@","/")_" *Encounter",PSJCLHD=1
"RTN","PSJLMUTL",71,0)
 Q
"RTN","PSJLMUTL",72,0)
 ;
"RTN","PSJLMUTL",73,0)
SETNAR(SUB,NARR,TYPE) ; Set up Narrative info.
"RTN","PSJLMUTL",74,0)
 S NARR=TYPE_"patient Narrative: "_NARR,Y="" S:TYPE="In" NARR=" "_NARR
"RTN","PSJLMUTL",75,0)
 S START=1 F  D  Q:NARR=""
"RTN","PSJLMUTL",76,0)
 .I $L($P(NARR," "))>79 S PSJ=$E(NARR,START,START+79),NARR=$E(NARR,START+80,$L(NARR)) Q
"RTN","PSJLMUTL",77,0)
 .I $L(NARR)>79 S PSJ=$P(NARR," ",1,$L($E(NARR,1,80)," ")-1),NARR=$E($P(NARR,PSJ,2),2,$L(NARR)) D SET Q
"RTN","PSJLMUTL",78,0)
 .S PSJ=NARR,NARR="" D SET
"RTN","PSJLMUTL",79,0)
 Q
"RTN","PSJLMUTL",80,0)
 ;
"RTN","PSJLMUTL",81,0)
SET ; Set ^TMP for narratives.
"RTN","PSJLMUTL",82,0)
 S ^TMP(SUB,$J,PSJLN,0)=PSJ,PSJLN=PSJLN+1
"RTN","PSJLMUTL",83,0)
 Q
"RTN","PSJLMUTL",84,0)
 ;
"RTN","PSJLMUTL",85,0)
ACTIONS() ;
"RTN","PSJLMUTL",86,0)
 N DIC,X,Y
"RTN","PSJLMUTL",87,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSJLMUTL",88,0)
 I Y="PSJ LM DC" Q $S(PSGACT["D":1,1:0)
"RTN","PSJLMUTL",89,0)
 I Y="PSJU LM EDIT" Q $S(PSGACT["E":1,1:0)
"RTN","PSJLMUTL",90,0)
 I Y="PSJU LM RENEW" Q $S(PSGACT["R":1,1:0)
"RTN","PSJLMUTL",91,0)
 I Y="PSJ LM HOLD" Q $S(PSGACT["H":1,1:0)
"RTN","PSJLMUTL",92,0)
 I Y="PSJU LM VERIFY" Q $S(PSGACT["V":1,1:0)
"RTN","PSJLMUTL",93,0)
 I Y="PSJ LM EDIT NEW" Q $S(PSGACT["E":1,1:0)
"RTN","PSJLMUTL",94,0)
 I Y="PSJ LM FLAG" Q $S(PSGACT["G":1,1:0)
"RTN","PSJLMUTL",95,0)
 Q 1
"RTN","PSJLMUTL",96,0)
RNACT() ;
"RTN","PSJLMUTL",97,0)
 I '$G(PSJRNF),'$G(PSJIRNF) Q 0
"RTN","PSJLMUTL",98,0)
 NEW X S X=$G(^PS(53.1,+PSJORD,0))
"RTN","PSJLMUTL",99,0)
 S PSGACT=""
"RTN","PSJLMUTL",100,0)
 I $S(+$P(X,U,13):1,$G(PSJRNF)&($P(X,U,4)="U"):1,$G(PSJIRNF)&($P(X,U,4)'="U"):1,1:0) S PSGACT="BFDE"
"RTN","PSJLMUTL",101,0)
 NEW X,Y
"RTN","PSJLMUTL",102,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSJLMUTL",103,0)
 I Y="PSJ LM DC" Q $S(PSGACT["D":1,1:0)
"RTN","PSJLMUTL",104,0)
 I Y="PSJ LM BYPASS" Q $S(PSGACT["B":1,1:0)
"RTN","PSJLMUTL",105,0)
 I Y="PSJ LM FINISH" Q $S(PSGACT["F":1,1:0)
"RTN","PSJLMUTL",106,0)
 I Y="PSJI LM DISCONTINUE" Q $S(PSGACT["D":1,1:0)
"RTN","PSJLMUTL",107,0)
 I Y="PSJI LM EDIT" Q $S(PSGACT["E":1,1:0)
"RTN","PSJLMUTL",108,0)
 I Y="PSJI LM FINISH" Q $S(PSGACT["F":1,1:0)
"RTN","PSJLMUTL",109,0)
 I Y="PSJ LM FLAG" Q 0
"RTN","PSJLMUTL",110,0)
 Q 1
"RTN","PSJLMUTL",111,0)
 ;
"RTN","PSJLMUTL",112,0)
TECHACT() ; Allowable actions for IV technician (PSJI PHARM TECH)
"RTN","PSJLMUTL",113,0)
 Q:'$G(PSJITECH) 0
"RTN","PSJLMUTL",114,0)
 NEW X S X=$G(^PS(53.1,+PSJORD,0))
"RTN","PSJLMUTL",115,0)
 I $S(+$P(X,U,13):1,$P(X,U,4)'="U":1,1:0) S PSGACT="F"
"RTN","PSJLMUTL",116,0)
 N DIC,X,Y
"RTN","PSJLMUTL",117,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSJLMUTL",118,0)
 I Y="PSJ LM DC" Q $S(PSGACT["D":1,1:0)
"RTN","PSJLMUTL",119,0)
 I Y="PSJ LM BYPASS" Q $S(PSGACT["B":1,1:0)
"RTN","PSJLMUTL",120,0)
 I Y="PSJ LM FINISH" Q $S(PSGACT["F":1,1:0)
"RTN","PSJLMUTL",121,0)
 I Y="PSJI LM DISCONTINUE" Q $S(PSGACT["D":1,1:0)
"RTN","PSJLMUTL",122,0)
 I Y="PSJI LM EDIT" Q $S(PSGACT["E":1,1:0)
"RTN","PSJLMUTL",123,0)
 I Y="PSJI LM FINISH" Q $S(PSGACT["F":1,1:0)
"RTN","PSJLMUTL",124,0)
 I Y="PSJ LM FLAG" Q 0
"RTN","PSJLMUTL",125,0)
 Q 1
"RTN","PSJLMUTL",126,0)
PATINFO()         ; Determines if detailed allergy info can be displayed.
"RTN","PSJLMUTL",127,0)
 S Y=$P($G(^ORD(101,+$G(^ORD(101,DA(1),10,DA,0)),0)),U) I Y="" Q 0
"RTN","PSJLMUTL",128,0)
 I Y="PSJ LM SHOW PROFILE",$D(PSJLMPRO) Q 0
"RTN","PSJLMUTL",129,0)
 Q 1
"RTN","PSJLMUTL",130,0)
HIDDEN(CHK) ; Determines if certain Hidden actions are to be available.
"RTN","PSJLMUTL",131,0)
 I CHK="JUMP",'$G(PSJPNV) D NA("Jump is only available through Non-Verified/Pending Orders option.") Q 0
"RTN","PSJLMUTL",132,0)
 I CHK="SPEED",'$D(PSJUDPRF) D NA("Speed options are only available from the Unit Dose Order Entry Profile.") Q 0
"RTN","PSJLMUTL",133,0)
 Q 1
"RTN","PSJLMUTL",134,0)
 ;
"RTN","PSJLMUTL",135,0)
NA(TXT) ;
"RTN","PSJLMUTL",136,0)
 D FULL^VALM1 W !!,TXT,!! N DIR S DIR(0)="E" D ^DIR
"RTN","PSJLMUTL",137,0)
 Q
"RTN","PSJLMUTL",138,0)
 ;
"RTN","PSJLMUTL",139,0)
UPR(DFN)         ; UPDATE PATIENT SPECIFIC DATA IN 55
"RTN","PSJLMUTL",140,0)
 N DIE,DR S PSJC10=VALMCNT
"RTN","PSJLMUTL",141,0)
 S DA=DFN,DIE="^PS(55,",DR="62.2;62.01" D ^DIE,DISALL^PSJLMUTL(DFN)
"RTN","PSJLMUTL",142,0)
 S VALMCNT=PSJC10 K PSJC10
"RTN","PSJLMUTL",143,0)
 Q
"RTN","PSJLMUTL",144,0)
 ;
"RTN","PSJLMUTL",145,0)
DETALL(DFN)        ; Enter Detailed Allergy Display list.
"RTN","PSJLMUTL",146,0)
 D EN^VALM("PSJ LM ALLERGY DISPLAY")
"RTN","PSJLMUTL",147,0)
 Q
"RTN","PSJLMUTL",148,0)
BRFALL(DFN)        ;
"RTN","PSJLMUTL",149,0)
 D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJLMUTL",150,0)
 Q
"RTN","PSJLMUTL",151,0)
PAUSE ;
"RTN","PSJLMUTL",152,0)
 N DIR S DIR(0)="E" D ^DIR
"RTN","PSJLMUTL",153,0)
 Q
"RTN","PSJLMUTL",154,0)
DRUGNAME(DFN,ON) ; Find drug name to display
"RTN","PSJLMUTL",155,0)
 ;If order is in 55:
"RTN","PSJLMUTL",156,0)
 ;.If Dosage Ordered is found, returns OI_U_Dosage Ordered.
"RTN","PSJLMUTL",157,0)
 ;.If no Dosage Ordered, returns Dispense Drug only.
"RTN","PSJLMUTL",158,0)
 ;If order in 53.1:
"RTN","PSJLMUTL",159,0)
 ;.If Dosage Ordered, returns OI_U_Dosage Ordered.
"RTN","PSJLMUTL",160,0)
 ;.If Dispense Drug is found, returns Dispense Drug name_U_Instructions.
"RTN","PSJLMUTL",161,0)
 ;.If no dispense drug, returns OI_U_Instructions.
"RTN","PSJLMUTL",162,0)
 I ON["U" D  Q DN
"RTN","PSJLMUTL",163,0)
 .S OIND=$G(^PS(55,DFN,5,+ON,.2))
"RTN","PSJLMUTL",164,0)
 .I $P(OIND,U,2)]"",($G(^PS(50.7,+OIND,0))]"") S DN=$$OINAME(OIND)_U_.2 Q
"RTN","PSJLMUTL",165,0)
 .S X=+$O(^PS(55,DFN,5,+ON,1,0)),X=$G(^PS(55,DFN,5,+ON,1,X,0)) I $P(X,U)]"" S DN=$$DDNAME(+X)_"^^"_$P(X,"^",2) Q  ;$S($P(OIND,U,2)]"":.2,1:.3) Q
"RTN","PSJLMUTL",166,0)
 .S DN=$$OINAME(+OIND)_U_.3 Q
"RTN","PSJLMUTL",167,0)
 S OIND=$G(^PS(53.1,+ON,.2)) Q:$P(OIND,U,2)]"" $$OINAME(OIND)_U_.2
"RTN","PSJLMUTL",168,0)
 S X=+$O(^PS(53.1,+ON,1,0)) I X,'$O(^PS(53.1,+ON,1,X)) S X=$G(^PS(53.1,+ON,1,X,0)) I $P(X,U)]"" Q $$DDNAME(+X)_U_.3_$P(X,"^",2)
"RTN","PSJLMUTL",169,0)
 Q $$OINAME(OIND)_U_.3
"RTN","PSJLMUTL",170,0)
 ;
"RTN","PSJLMUTL",171,0)
DDNAME(X) ; 
"RTN","PSJLMUTL",172,0)
 Q $$FOUND($P($G(^PSDRUG(+X,0)),U),X,"PSDRUG(,")
"RTN","PSJLMUTL",173,0)
 ;
"RTN","PSJLMUTL",174,0)
OINAME(ND) ; Return Orderable Item Name_" "_Dose Form_U_Dosage Ordered
"RTN","PSJLMUTL",175,0)
 N DF,DNME,X
"RTN","PSJLMUTL",176,0)
 S X=$G(^PS(50.7,+ND,0)),DNME="" S:X]"" DF=$P($G(^PS(50.606,+$P(X,U,2),0)),U),DNME=$P(X,U)_" "_DF
"RTN","PSJLMUTL",177,0)
 Q $$FOUND(DNME,+ND,"PS(50.7")
"RTN","PSJLMUTL",178,0)
 ;
"RTN","PSJLMUTL",179,0)
FOUND(DNME,DN,FN) ;
"RTN","PSJLMUTL",180,0)
 Q $S(DNME]"":DNME,1:"NOT FOUND "_DN_";"_FN)
"RTN","PSJMUTL")
0^4^B37412252^B27638575
"RTN","PSJMUTL",1,0)
PSJMUTL ;BIR/MV-UTLILITY USE FOR QUEUING...  ;25 Nov 98 / 9:13 AM
"RTN","PSJMUTL",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**8,21,31,160**;16 DEC 97;Build 12
"RTN","PSJMUTL",3,0)
 ; References to ^PS(52.7 supported by DBIA #2173
"RTN","PSJMUTL",4,0)
 ; Reference to ^ORRDI1 is supported by DBIA 4659
"RTN","PSJMUTL",5,0)
 ; Reference to ^XTMP("ORRDI" is supported by DBIA 4660
"RTN","PSJMUTL",6,0)
 ; Reference to ^GMRADPT supported by DBIA #10099
"RTN","PSJMUTL",7,0)
SELDEV() ;*** Ask for device type for report to output to ***
"RTN","PSJMUTL",8,0)
 K IOP,%ZIS,POP,IO("Q")
"RTN","PSJMUTL",9,0)
 S %ZIS("A")="Select output device: ",%ZIS("B")="",%ZIS="Q"
"RTN","PSJMUTL",10,0)
 D ^%ZIS S PSJSTOP=$S(POP:1,1:0) I POP W !,"** No device selected or Report printed **" D EXIT
"RTN","PSJMUTL",11,0)
 Q $G(PSJSTOP)
"RTN","PSJMUTL",12,0)
 ;
"RTN","PSJMUTL",13,0)
SETSORTQ(XDESC,XSAVE,ZTRTN)     ;Queue to sort.  D SETDEV^PSJMUTL(X,Y)
"RTN","PSJMUTL",14,0)
 N I,X
"RTN","PSJMUTL",15,0)
 K IO("Q"),ZTSAVE,ZTDTH,ZTSK
"RTN","PSJMUTL",16,0)
 S ZTDESC=XDESC,PSGIO=ION,ZTIO=""
"RTN","PSJMUTL",17,0)
 S PSGIODOC="" I $G(IO("DOC"))]"" S PSGIODOC=IO("DOC")
"RTN","PSJMUTL",18,0)
 F I=1:1  S X=$P(XSAVE,";",I) Q:X=""  S ZTSAVE(X)=""
"RTN","PSJMUTL",19,0)
 D ^%ZTLOAD
"RTN","PSJMUTL",20,0)
 Q
"RTN","PSJMUTL",21,0)
 ;
"RTN","PSJMUTL",22,0)
SETPRTQ(XDESC,XSAVE,ZTRTN)         ;Queue to printer.  D SETPRTQ^PSJMUTL(X,Y)
"RTN","PSJMUTL",23,0)
 N I,X
"RTN","PSJMUTL",24,0)
 S ZTIO=PSGIO,ZTDESC=XDESC,ZTDTH=$H,%ZIS="QN",IOP=PSGIO
"RTN","PSJMUTL",25,0)
 I $G(PSGIODOC)]"" S ZTIO=ZTIO_";"_PSGIODOC
"RTN","PSJMUTL",26,0)
 F I=1:1  S X=$P(XSAVE,";",I) Q:X=""  S ZTSAVE(X)=""
"RTN","PSJMUTL",27,0)
 D ^%ZIS,^%ZTLOAD
"RTN","PSJMUTL",28,0)
 Q
"RTN","PSJMUTL",29,0)
 ;
"RTN","PSJMUTL",30,0)
EXITDEV ;
"RTN","PSJMUTL",31,0)
 I $E(IOST)="C",('$G(PSJSTOP)) K DIR W ! S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR
"RTN","PSJMUTL",32,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSJMUTL",33,0)
 S IOP="HOME" D ^%ZISC
"RTN","PSJMUTL",34,0)
 Q
"RTN","PSJMUTL",35,0)
 ;
"RTN","PSJMUTL",36,0)
PRTCHK(PGCT) ;
"RTN","PSJMUTL",37,0)
 I $E(IOST)="C",PGCT K DIR W ! S DIR(0)="E" D ^DIR S:'Y PSJSTOP=1
"RTN","PSJMUTL",38,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S (ZSTOP,PSJSTOP)=1
"RTN","PSJMUTL",39,0)
 I $G(PSJSTOP) W !!?20,"...Report stopped at user request..." K DIR S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR
"RTN","PSJMUTL",40,0)
 Q $G(PSJSTOP)
"RTN","PSJMUTL",41,0)
 ;
"RTN","PSJMUTL",42,0)
EXIT ;
"RTN","PSJMUTL",43,0)
 K %,%H,%I,%ZIS,ZTDESC,ZTDTH,ZTIO,ZTSAVE,ZTRTN
"RTN","PSJMUTL",44,0)
 W:$E(IOST)="C"&($Y) @IOF
"RTN","PSJMUTL",45,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSJMUTL",46,0)
 S IOP="HOME" D ^%ZISC
"RTN","PSJMUTL",47,0)
 Q
"RTN","PSJMUTL",48,0)
ATS(REG,EXP,LN) ;
"RTN","PSJMUTL",49,0)
 ;*** Split allergies and adverse reactions from the allergy package.
"RTN","PSJMUTL",50,0)
 ;*** INPUT ***
"RTN","PSJMUTL",51,0)
 ;*** REG - the length the allergies and adv. reactions display on 1 pg.
"RTN","PSJMUTL",52,0)
 ;*** EXP - the length that will display on extra page.
"RTN","PSJMUTL",53,0)
 ;*** LN  - for MAR, allergies and reations are display on 1 line.
"RTN","PSJMUTL",54,0)
 ;        - for Profile, display allergies and reactions on separate ln.
"RTN","PSJMUTL",55,0)
 ;*** OUTPUT ***
"RTN","PSJMUTL",56,0)
 ;*** PSGALG - Allergies array.
"RTN","PSJMUTL",57,0)
 ;*** PSGADR - Adverse Reactions array.
"RTN","PSJMUTL",58,0)
 ;***** rlw - 1/16/96 added PSGVALG for verified allergies and PSGVADR for verified adverse reactions.
"RTN","PSJMUTL",59,0)
GETGMRA ;
"RTN","PSJMUTL",60,0)
 N GMRA,GMRAL,GMRANKA,GMRAOTH,LEN,X,Y,TYPE,NAME,SORT,ALG,VALG,ADR,VADR,ALGCT,VALGCT,ADRCT,VADRCT,VERIFIED
"RTN","PSJMUTL",61,0)
 K PSGADR,PSGALG,PSGVADR,PSGVALG
"RTN","PSJMUTL",62,0)
 S (VALGCT,ALGCT,VADRCT,ADRCT,PSGVALG,PSGALG,PSGVADR,PSGADR)=0,(PSGVALG(1),PSGALG(1),PSGVADR(1),PSGADR(1))=""
"RTN","PSJMUTL",63,0)
 S:'$G(DFN)&$G(PSGP) DFN=PSGP
"RTN","PSJMUTL",64,0)
 S:'$G(PSGP)&$G(DFN) PSGP=DFN
"RTN","PSJMUTL",65,0)
 S GMRA="0^0^111",DFN=PSGP D ^GMRADPT
"RTN","PSJMUTL",66,0)
 I $G(PSJWHERE)="PSJLMUTL" S PSJGMRAL=GMRAL Q:(GMRAL="")!(GMRAL=0)
"RTN","PSJMUTL",67,0)
 I GMRAL="" S:$E(IOST)="P" (PSGVALG,PSGALG,PSGVADR,PSGADR)=20,$P(PSGALG(1),"_",20)=" ",(PSGVALG(1),PSGADR(1),PSGVADR(1))=PSGALG(1) Q
"RTN","PSJMUTL",68,0)
 I GMRAL=0 S (PSGVALG,PSGALG)=3,(PSGALG(1),PSGVALG(1))="NKA" S:$E(IOST)="P" PSGADR=20,$P(PSGADR(1),"_",20)=" ",PSGVADR=20,PSGVADR(1)=PSGADR(1) Q
"RTN","PSJMUTL",69,0)
 ;
"RTN","PSJMUTL",70,0)
SORT ;*** Set up the allergies and adv. reactions arrays.
"RTN","PSJMUTL",71,0)
 F X=0:0 S X=$O(GMRAL(X)) Q:'X  S TYPE=$P(GMRAL(X),U,5),NAME=$P(GMRAL(X),U,2),VERIFIED=$P(GMRAL(X),U,4) D
"RTN","PSJMUTL",72,0)
 .S SORT=$P(GMRAL(X),U,7),SORT=$S(SORT="D":1,SORT="DF":2,SORT="DFO":3,SORT="DO":4,SORT="F":5,SORT="FO":6,1:7)
"RTN","PSJMUTL",73,0)
 .S:(TYPE=0)&(VERIFIED=1) PSGVALG=PSGVALG+$L(NAME),VALGCT=VALGCT+1,VALG(SORT_NAME)=""
"RTN","PSJMUTL",74,0)
 .S:(TYPE=0)&(VERIFIED=0) PSGALG=PSGALG+$L(NAME),ALGCT=ALGCT+1,ALG(SORT_NAME)=""
"RTN","PSJMUTL",75,0)
 .S:(TYPE>0)&(VERIFIED=0) PSGADR=PSGADR+$L(NAME),ADRCT=ADRCT+1,ADR(SORT_NAME)=""
"RTN","PSJMUTL",76,0)
 .S:(TYPE>0)&(VERIFIED=1) PSGVADR=PSGVADR+$L(NAME),VADRCT=VADRCT+1,VADR(SORT_NAME)=""
"RTN","PSJMUTL",77,0)
 ;
"RTN","PSJMUTL",78,0)
CALLEN ;*** Calculate the total length for allergy and adv.reaction arrays.
"RTN","PSJMUTL",79,0)
 S:VALGCT>1 PSGVALG=PSGVALG+((VALGCT-1)*2) S:$E(IOST)="P"&'PSGVALG PSGVALG=20,$P(PSGVALG(1),"_",20)=" "
"RTN","PSJMUTL",80,0)
 S:ALGCT>1 PSGALG=PSGALG+((ALGCT-1)*2) S:$E(IOST)="P"&'PSGALG PSGALG=20,$P(PSGALG(1),"_",20)=" "
"RTN","PSJMUTL",81,0)
 S:VADRCT>1 PSGVADR=PSGVADR+((VADRCT-1)*2) S:$E(IOST)="P"&'PSGVADR PSGVADR=20,$P(PSGVADR(1),"_",20)=" "
"RTN","PSJMUTL",82,0)
 S:ADRCT>1 PSGADR=PSGADR+((ADRCT-1)*2) S:$E(IOST)="P"&'PSGADR PSGADR=20,$P(PSGADR(1),"_",20)=" "
"RTN","PSJMUTL",83,0)
 S (VALGCT,ALGCT,VADRCT,ADRCT)=1
"RTN","PSJMUTL",84,0)
 S:LN=1 LEN=$S((PSGALG+PSGVALG+PSGADR+PSGVADR)>REG:EXP,1:REG)
"RTN","PSJMUTL",85,0)
 S:LN>1 LEN=$S($S(PSGALG>REG:1,PSGADR>REG:1,PSGVALG>REG:1,PSGVADR>REG:1,1:0):EXP,1:REG)
"RTN","PSJMUTL",86,0)
 ;
"RTN","PSJMUTL",87,0)
SETARRAY ;*** Concatenate allergies and adv. reaction together into display len.
"RTN","PSJMUTL",88,0)
 S (X,Y)="" F  S X=$O(VALG(X)) Q:X=""  S:LEN'>($L(Y)+$L(X)+1) PSGVALG(VALGCT)=Y_",",Y="",VALGCT=VALGCT+1 S:Y]"" Y=Y_", " S Y=Y_$E(X,2,$L(X))
"RTN","PSJMUTL",89,0)
 S:$G(PSGVALG(VALGCT))="" PSGVALG(VALGCT)=Y
"RTN","PSJMUTL",90,0)
 S (X,Y)="" F  S X=$O(ALG(X)) Q:X=""  S:LEN'>($L(Y)+$L(X)+1) PSGALG(ALGCT)=Y_",",Y="",ALGCT=ALGCT+1 S:Y]"" Y=Y_", " S Y=Y_$E(X,2,$L(X))
"RTN","PSJMUTL",91,0)
 S:$G(PSGALG(ALGCT))="" PSGALG(ALGCT)=Y
"RTN","PSJMUTL",92,0)
 S (X,Y)="" F  S X=$O(ADR(X)) Q:X=""  S:LEN'>($L(Y)+$L(X)+1) PSGADR(ADRCT)=Y_",",Y="",ADRCT=ADRCT+1 S:Y]"" Y=Y_", " S Y=Y_$E(X,2,$L(X))
"RTN","PSJMUTL",93,0)
 S:$G(PSGADR(ADRCT))="" PSGADR(ADRCT)=Y
"RTN","PSJMUTL",94,0)
 S (X,Y)="" F  S X=$O(VADR(X)) Q:X=""  S:LEN'>($L(Y)+$L(X)+1) PSGVADR(VADRCT)=Y_",",Y="",VADRCT=VADRCT+1 S:Y]"" Y=Y_", " S Y=Y_$E(X,2,$L(X))
"RTN","PSJMUTL",95,0)
 S:$G(PSGVADR(VADRCT))="" PSGVADR(VADRCT)=Y
"RTN","PSJMUTL",96,0)
 Q
"RTN","PSJMUTL",97,0)
 ;
"RTN","PSJMUTL",98,0)
NAMENEED(DRGX,LEN,NEED)  ;*** Return the number of lines needed.
"RTN","PSJMUTL",99,0)
 ;*
"RTN","PSJMUTL",100,0)
 ;* DRG - AD/SOL     LEN - Drug name length   NEED - line needed
"RTN","PSJMUTL",101,0)
 ;*
"RTN","PSJMUTL",102,0)
 S NEED=0
"RTN","PSJMUTL",103,0)
 F X=0:0 S X=$O(DRG(DRGX,X)) Q:'X  D NAME^PSIVUTL(DRG(DRGX,X),LEN,.NAME,1) S NEED=NEED+$S($G(NAME(2))]"":2,1:1) I DRGX="SOL",$P(^PS(52.7,+DRG(DRGX,X),0),U,4)]"" S NEED=NEED+1
"RTN","PSJMUTL",104,0)
 Q
"RTN","PSJMUTL",105,0)
RAD ;
"RTN","PSJMUTL",106,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSJMUTL",107,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSJMUTL",108,0)
 S PSGRALG=1,PSGRALG(1)="No remote data available"
"RTN","PSJMUTL",109,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) G REMOTE2
"RTN","PSJMUTL",110,0)
 I $T(GET^ORRDI1)]"" D GET^ORRDI1(DFN,"ART") D
"RTN","PSJMUTL",111,0)
 . N S1,REAC,A,FILE,LEN K ^TMP($J,"PSJART")
"RTN","PSJMUTL",112,0)
 . S S1=0,LEN=57,PSGRALG=1,PSGRALG(1)="" F  S S1=$O(^XTMP("ORRDI","ART",DFN,S1)) Q:'S1  D
"RTN","PSJMUTL",113,0)
 .. S A=$G(^XTMP("ORRDI","ART",DFN,S1,"REACTANT",0)),REAC=$P(A,"^",2),FILE=$P($P(A,"^",3),"99VA",2)
"RTN","PSJMUTL",114,0)
 .. I FILE'=50.6,FILE'=120.82,FILE'=50.605,FILE'=50.416 Q
"RTN","PSJMUTL",115,0)
 .. S ^TMP($J,"PSJART",REAC)=""
"RTN","PSJMUTL",116,0)
 . S REAC="" F  S REAC=$O(^TMP($J,"PSJART",REAC)) Q:REAC=""  D
"RTN","PSJMUTL",117,0)
 .. I $L(PSGRALG(PSGRALG))+$L(REAC)<LEN S PSGRALG(PSGRALG)=PSGRALG(PSGRALG)_REAC_", " Q
"RTN","PSJMUTL",118,0)
 .. S PSGRALG=PSGRALG+1,PSGRALG(PSGRALG)="                "_REAC_", ",LEN=77
"RTN","PSJMUTL",119,0)
 . S A=$L(PSGRALG(PSGRALG)) I $E(PSGRALG(PSGRALG),A-1,A)=", " S PSGRALG(PSGRALG)=$E(PSGRALG(PSGRALG),1,A-2)
"RTN","PSJMUTL",120,0)
REMOTE2 ;
"RTN","PSJMUTL",121,0)
 S ^TMP("PSJALL",$J,PSJLN,0)="              Remote: "_$G(PSGRALG(1)),PSJLN=PSJLN+1
"RTN","PSJMUTL",122,0)
 F I=2:1:PSGRALG S ^TMP("PSJALL",$J,PSJLN,0)=PSGRALG(I),PSJLN=PSJLN+1
"RTN","PSJMUTL",123,0)
 Q 
"VER")
8.0^22.0
"BLD",6055,6)
^164
**END**
**END**
