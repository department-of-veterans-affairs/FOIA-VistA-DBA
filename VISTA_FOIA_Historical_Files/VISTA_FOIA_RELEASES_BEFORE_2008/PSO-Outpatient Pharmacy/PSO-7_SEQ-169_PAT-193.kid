Released PSO*7*193 SEQ #169
Extracted from mail message
**KIDS**:PSO*7.0*193^

**INSTALL NAME**
PSO*7.0*193
"BLD",5079,0)
PSO*7.0*193^OUTPATIENT PHARMACY^0^3041201^y
"BLD",5079,1,0)
^^18^18^3041201^^^^
"BLD",5079,1,1,0)
1. PSO*7*156 provided a two-way interface that returns dispensing
"BLD",5079,1,2,0)
information to VistA from the dispensing machine that updates the 
"BLD",5079,1,3,0)
PRESCRIPTION file (#52) when dispensing of medication is completed.
"BLD",5079,1,4,0)
When developing this new two-way interface the Label/Profile Monitor
"BLD",5079,1,5,0)
Reprint [PSO B] option was not enhanced to send label reprints to the
"BLD",5079,1,6,0)
external interface.  BRX-0803-10283
"BLD",5079,1,7,0)
 
"BLD",5079,1,8,0)
 
"BLD",5079,1,9,0)
2. PSO*7*156 provided a two-way interface that returns dispensing
"BLD",5079,1,10,0)
information to VistA from the dispensing machine that updates the 
"BLD",5079,1,11,0)
PRESCRIPTION file (#52) when dispensing of medication is completed.
"BLD",5079,1,12,0)
Since being released to the field, it has been determined that additional
"BLD",5079,1,13,0)
data validation checks were needed on the data being returned.
"BLD",5079,1,14,0)
This patch includes those additional data validation checks.
"BLD",5079,1,15,0)
 
"BLD",5079,1,16,0)
3. When viewing a prescription using the View Prescriptions [PSO VIEW]
"BLD",5079,1,17,0)
option, the initiator of activity does not display, however, if viewing from
"BLD",5079,1,18,0)
the profile, it does display. NOIS: MAC-1104-61559
"BLD",5079,4,0)
^9.64PA^^
"BLD",5079,"ABPKG")
n
"BLD",5079,"KRN",0)
^9.67PA^8989.52^19
"BLD",5079,"KRN",.4,0)
.4
"BLD",5079,"KRN",.401,0)
.401
"BLD",5079,"KRN",.402,0)
.402
"BLD",5079,"KRN",.403,0)
.403
"BLD",5079,"KRN",.5,0)
.5
"BLD",5079,"KRN",.84,0)
.84
"BLD",5079,"KRN",3.6,0)
3.6
"BLD",5079,"KRN",3.8,0)
3.8
"BLD",5079,"KRN",9.2,0)
9.2
"BLD",5079,"KRN",9.8,0)
9.8
"BLD",5079,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",5079,"KRN",9.8,"NM",1,0)
PSOHLDIS^^0^B53862506
"BLD",5079,"KRN",9.8,"NM",2,0)
PSOB^^0^B19570340
"BLD",5079,"KRN",9.8,"NM",3,0)
PSOBMST^^0^B15703875
"BLD",5079,"KRN",9.8,"NM",4,0)
PSORXVW1^^0^B64009831
"BLD",5079,"KRN",9.8,"NM","B","PSOB",2)

"BLD",5079,"KRN",9.8,"NM","B","PSOBMST",3)

"BLD",5079,"KRN",9.8,"NM","B","PSOHLDIS",1)

"BLD",5079,"KRN",9.8,"NM","B","PSORXVW1",4)

"BLD",5079,"KRN",19,0)
19
"BLD",5079,"KRN",19.1,0)
19.1
"BLD",5079,"KRN",101,0)
101
"BLD",5079,"KRN",409.61,0)
409.61
"BLD",5079,"KRN",771,0)
771
"BLD",5079,"KRN",870,0)
870
"BLD",5079,"KRN",8989.51,0)
8989.51
"BLD",5079,"KRN",8989.52,0)
8989.52
"BLD",5079,"KRN",8994,0)
8994
"BLD",5079,"KRN","B",.4,.4)

"BLD",5079,"KRN","B",.401,.401)

"BLD",5079,"KRN","B",.402,.402)

"BLD",5079,"KRN","B",.403,.403)

"BLD",5079,"KRN","B",.5,.5)

"BLD",5079,"KRN","B",.84,.84)

"BLD",5079,"KRN","B",3.6,3.6)

"BLD",5079,"KRN","B",3.8,3.8)

"BLD",5079,"KRN","B",9.2,9.2)

"BLD",5079,"KRN","B",9.8,9.8)

"BLD",5079,"KRN","B",19,19)

"BLD",5079,"KRN","B",19.1,19.1)

"BLD",5079,"KRN","B",101,101)

"BLD",5079,"KRN","B",409.61,409.61)

"BLD",5079,"KRN","B",771,771)

"BLD",5079,"KRN","B",870,870)

"BLD",5079,"KRN","B",8989.51,8989.51)

"BLD",5079,"KRN","B",8989.52,8989.52)

"BLD",5079,"KRN","B",8994,8994)

"BLD",5079,"QUES",0)
^9.62^^
"BLD",5079,"REQB",0)
^9.611^2^2
"BLD",5079,"REQB",1,0)
PSO*7.0*189^2
"BLD",5079,"REQB",2,0)
PSO*7.0*60^2
"BLD",5079,"REQB","B","PSO*7.0*189",1)

"BLD",5079,"REQB","B","PSO*7.0*60",2)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
193^3041201
"PKG",141,22,1,"PAH",1,1,0)
^^18^18^3041201
"PKG",141,22,1,"PAH",1,1,1,0)
1. PSO*7*156 provided a two-way interface that returns dispensing
"PKG",141,22,1,"PAH",1,1,2,0)
information to VistA from the dispensing machine that updates the 
"PKG",141,22,1,"PAH",1,1,3,0)
PRESCRIPTION file (#52) when dispensing of medication is completed.
"PKG",141,22,1,"PAH",1,1,4,0)
When developing this new two-way interface the Label/Profile Monitor
"PKG",141,22,1,"PAH",1,1,5,0)
Reprint [PSO B] option was not enhanced to send label reprints to the
"PKG",141,22,1,"PAH",1,1,6,0)
external interface.  BRX-0803-10283
"PKG",141,22,1,"PAH",1,1,7,0)
 
"PKG",141,22,1,"PAH",1,1,8,0)
 
"PKG",141,22,1,"PAH",1,1,9,0)
2. PSO*7*156 provided a two-way interface that returns dispensing
"PKG",141,22,1,"PAH",1,1,10,0)
information to VistA from the dispensing machine that updates the 
"PKG",141,22,1,"PAH",1,1,11,0)
PRESCRIPTION file (#52) when dispensing of medication is completed.
"PKG",141,22,1,"PAH",1,1,12,0)
Since being released to the field, it has been determined that additional
"PKG",141,22,1,"PAH",1,1,13,0)
data validation checks were needed on the data being returned.
"PKG",141,22,1,"PAH",1,1,14,0)
This patch includes those additional data validation checks.
"PKG",141,22,1,"PAH",1,1,15,0)
 
"PKG",141,22,1,"PAH",1,1,16,0)
3. When viewing a prescription using the View Prescriptions [PSO VIEW]
"PKG",141,22,1,"PAH",1,1,17,0)
option, the initiator of activity does not display, however, if viewing from
"PKG",141,22,1,"PAH",1,1,18,0)
the profile, it does display. NOIS: MAC-1104-61559
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSOB")
0^2^B19570340
"RTN","PSOB",1,0)
PSOB ;BHAM ISC/CCG - black line resolver ; 07/18/96  8:49 am
"RTN","PSOB",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,60,193**;DEC 1997
"RTN","PSOB",3,0)
 I '$D(PSOPAR) D ^PSOLSET Q:'$G(PSOPAR)
"RTN","PSOB",4,0)
 S (CC,PSOCLC,PDUZ)=DUZ,PSOBOUT=0
"RTN","PSOB",5,0)
 N PSODISP
"RTN","PSOB",6,0)
 I '$O(^PS(52.9,0)) W !!,"THE LABEL/PROFILE MONITOR LIST IS EMPTY.",!! Q
"RTN","PSOB",7,0)
 I $P(PSOPAR,"^",30),$$GET1^DIQ(59,PSOSITE_",",105,"I")=2.4 D
"RTN","PSOB",8,0)
 .K DIR,DIRUT S DIR("A")="Do you want to resend to Dispensing System Device",DIR(0)="Y",DIR("B")="No"
"RTN","PSOB",9,0)
 .D ^DIR K DIR I $D(DIRUT) K DIRUT Q
"RTN","PSOB",10,0)
 .S PSODISP=Y
"RTN","PSOB",11,0)
PT S DIC="^PS(52.9,",DIC("A")="ENTER FAILED OUTPUT DEVICE NUMBER OR NAME: ",DIC(0)="QEAZM" D ^DIC K DIC G END:Y=-1 S PSOBIO=+Y,PSOBPT=Y(0)
"RTN","PSOB",12,0)
RX1 S DIC("A")="ENTER LAST USABLE LABEL/PROFILE : ",DIC="^PS(52.9,PSOBIO,1,",DIC(0)="EQAMZ" D ^DIC G:"^"[X END G:Y=-1 RX1 S PSOBY=Y,PSODPT=Y(0,0),PSODPT(0)=Y(0) K DIC
"RTN","PSOB",13,0)
 I 'X S DA(1)=+Y,DIC("A")="ENTER LAST USABLE Rx: ",DIC="^PS(52.9,PSOBIO,1,DA(1),2,",DIC(0)="EQAMZ" D ^DIC G:"^"[X END G:Y=-1 RX1 D  G:$G(PSOBOUT) END
"RTN","PSOB",14,0)
 .S PSOBR=+PSOBPT,Y(0)=PSODPT(0),Y(0,0)=PSODPT,Y=+PSOBY_"^"_$P(Y,"^",2) D RX08 S PSOBR1=PSOBR K DIC
"RTN","PSOB",15,0)
 S PSOBR=+Y D RX08 G:$G(PSOBOUT) END S PSOBR1=PSOBR
"RTN","PSOB",16,0)
RX2 S DIC="^PS(52.9,PSOBIO,1,",DIC(0)="EQAMZ",DIC("A")="ENTER NEXT USABLE LABEL/PROFILE ('RETURN' FOR REMAINDER OF THE QUEUE):",DIC("S")="I +PSOBR1'>Y" D ^DIC K DIC("S") G:X="^" END
"RTN","PSOB",17,0)
 I X="" S PSOBR2=$P(^PS(52.9,PSOBIO,1,0),"^",3) S:$D(^PS(52.9,PSOBIO,1,PSOBR2,2)) PSOBR2=PSOBR2_"^"_($P(^PS(52.9,PSOBIO,1,PSOBR2,2,0),"^",3)+1) G SET
"RTN","PSOB",18,0)
 G:Y=-1 RX2 S PSOBR=$P(Y,"^") D RX08 S PSOBR2=PSOBR I +PSOBR1=+PSOBR2,$P(PSOBR1,"^",2)>$P(PSOBR2,"^",2) W !!,"THE ENDING RX# DOES NOT FOLLOW THE BEGINNING RX#.  PLEASE TRY AGAIN.",!!! G RX1
"RTN","PSOB",19,0)
SET N PSOBAR1,PSOBAR0,PSOBARS,IOS
"RTN","PSOB",20,0)
 K ZTSK,%ZIS S DIC="^%ZIS(1,",(PSOIOS,DA)=PSOBPT,DR=".01;3",DIQ="DPTR",DIQ(0)="I" D EN^DIQ1
"RTN","PSOB",21,0)
 S DPTRS=$G(DPTR(3.5,DA,3,DIQ(0))),PSOIS=PSOIOS,%ZIS("A")="PRINT ON DEVICE:  ",%ZIS("B")=$S($G(DPTR(3.5,DA,.01,DIQ(0)))'="":$G(DPTR(3.5,DA,.01,DIQ(0))),1:""),%ZIS="QMN" D ^%ZIS
"RTN","PSOB",22,0)
 K %ZIS G:POP END
"RTN","PSOB",23,0)
 I $E(IOST,1,2)="C-" W $C(7),!,"Output MUST be sent to a printer !!",! G SET
"RTN","PSOB",24,0)
 S ZTIO=ION,PSOIOS=IOS,DA=IOST(0)
"RTN","PSOB",25,0)
 S DIC="^%ZIS(2,",DR="61;60",DIQ="DPTRS1",DIQ(0)="I" D EN^DIQ1
"RTN","PSOB",26,0)
 S PSOBAR0="" I $G(DPTRS1(3.2,DA,61,DIQ(0)))'="" S PSOBAR0=$G(DPTRS1(3.2,DA,61,DIQ(0)))
"RTN","PSOB",27,0)
 S PSOBAR1="" I $G(DPTRS1(3.2,DA,60,DIQ(0)))'="" S PSOBAR1=$G(DPTRS1(3.2,DA,60,DIQ(0)))
"RTN","PSOB",28,0)
 S PSOBARS=PSOBAR1]""&(PSOBAR0]"")&$P(PSOPAR,"^",19) S PSOBFLAG=1 D LASK^PSOLSET K PSOBFLAG
"RTN","PSOB",29,0)
 S ZTRTN="PSOBMST",ZTDTH=$H,ZTDESC="BLACK LINE RESOLVER",(ZTSAVE("PSOBR1"),ZTSAVE("PSOBR2"),ZTSAVE("PSOBIO"),ZTSAVE("CC"),ZTSAVE("PDUZ"),ZTSAVE("PSOPAR"),ZTSAVE("PSOSITE"),ZTSAVE("PSODIV"))=""
"RTN","PSOB",30,0)
 S (ZTSAVE("PSOIOS"),ZTSAVE("PSOBAR0"),ZTSAVE("PSOBAR1"),ZTSAVE("PSOBARS"),ZTSAVE("PSOSYS"))="",ZTSAVE("PSODISP")=""
"RTN","PSOB",31,0)
 D ^%ZTLOAD I $G(ZTSK) W !,"Task Queued #"_ZTSK_" !!",!
"RTN","PSOB",32,0)
END D ^%ZISC K PSOIS,ZTSK,%ZIS,CC,DIC,IOP,I,POP,PSOB,PSOBIO,PSOBPT,PSOBR,PSOBR1,PSOBR2,PSOBRX,PSODPT,X,Y,PSOBOUT,DPTR,DPTRS,DPTRS1,DIQ,DIQ(0),DA,DR Q
"RTN","PSOB",33,0)
RX08 I $P(Y(0),"^",2)="L" S:(X'=$P(Y,"^",2))&($O(^PSRX("B",X,0))) Y=+Y_"^"_$O(^PSRX("B",X,0)) S PSOBR=PSOBR_"^"_$O(^PS(52.9,PSOBIO,1,"C",$P(Y,"^",2),PSOBR,0)),PSOBRX=$P(Y,"^",2)
"RTN","PSOB",34,0)
 E  S PSOBR=PSOBR_"^",PSOBRX="" S:$D(^PS(52.9,PSOBIO,1,PSOBR,2,0)) PSOBR=PSOBR_$P(^(0),"^",3),PSOBRX=^($P(PSOBR2,"^",2),0)
"RTN","PSOB",35,0)
 Q:($P(PSOBR,"^",2))!('$D(^PS(52.9,PSOBIO,1,+PSOBR,2,0)))
"RTN","PSOB",36,0)
 S PSOB="^" F I=0:0 S I=$O(^PS(52.9,PSOBIO,1,+PSOBR,2,I)) Q:'I  S PSOB=PSOB_$P(^PSRX($P(^(I,0),"^"),0),"^")_"^"
"RTN","PSOB",37,0)
 I $P(PSOB,"^",3)="" S PSOBR=+PSOBR_"^"_$P(^PS(52.9,PSOBIO,1,+PSOBR,2,0),"^",3) Q
"RTN","PSOB",38,0)
 I $P(Y(0),"^",2)="P" S PSOBR=+PSOBR_"^" Q
"RTN","PSOB",39,0)
RX05 W !,"ENTER RX# OF LAST USABLE SCRIPT FOR "_$P(^DPT(+Y(0),0),"^")_": " R X:DTIME I '$T!(X["^") S PSOBOUT=1 Q
"RTN","PSOB",40,0)
 D:X="?" LIST G:"^"[X RX05 I PSOB'[(U_X_"^") W !!,"???" G RX05
"RTN","PSOB",41,0)
 S PSOBR=+PSOBR_"^"_($O(^PS(52.9,PSOBIO,1,"C",$O(^PSRX("B",X,0)),+PSOBR,0))) Q
"RTN","PSOB",42,0)
LIST W !! F I=2:1 Q:$P(PSOB,"^",I)=""  W !,?5,I-1,"              ",$P(PSOB,"^",I)
"RTN","PSOB",43,0)
RL W !,"CHOOSE 1-",I-2," : " R X:DTIME G:(X<1)!(X>(I-2)) RL S X=$P(PSOB,"^",X+1) Q
"RTN","PSOBMST")
0^3^B15703875
"RTN","PSOBMST",1,0)
PSOBMST ;BIR/LAW-black line resolver ;03/6/98
"RTN","PSOBMST",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,71,193**;DEC 1997
"RTN","PSOBMST",3,0)
 ;master program launched by psob
"RTN","PSOBMST",4,0)
 S PSOBMST="",PSOBP1=+PSOBR1,PSOBR1=+$P(PSOBR1,"^",2),PSOBP2=+PSOBR2,PSOBR2=+$P(PSOBR2,"^",2),(NEW1,NEW11)="",PSOBRX=PSOBR1
"RTN","PSOBMST",5,0)
 F ZI=PSOBP1-1:0 S ZI=$O(^PS(52.9,PSOBIO,1,ZI)) Q:('ZI)!(PSOBP2<ZI)  S (PSOBX,PSOBX1)="",P=$S($P(^(ZI,0),"^",2)="P":U,1:",") D J D PRF:(P=U)&(ZI'=PSOBP1),LBL:(P'=U)&(PSOBX'="") S PSOBRX=0
"RTN","PSOBMST",6,0)
 D ^%ZISC K CC,EXDT,I,II,IOP,J,JJ,K,L,LBL,NEW1,NEW11,P,PI,POP,PPL,PSCAP,PSOSITE,PSOBIO,PSOBMST,PSOBP1,PSOBP2,PSOBR1,PSOBR2,PSOBRX,PSOBX,PSOBLALL,PSOBX1,REF,RX,WARN,X,Y,ZI,ZY,%ZIS,PSODIV,PDUZ,PSOBXPRT,BBB,BBBB,PBXRF S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOBMST",7,0)
J Q:'$D(^PS(52.9,PSOBIO,1,ZI,2))  F J=PSOBRX:0 S J=$O(^PS(52.9,PSOBIO,1,ZI,2,J)) Q:('J)!((ZI=PSOBP2)&(J=PSOBR2))  D SET
"RTN","PSOBMST",8,0)
 Q
"RTN","PSOBMST",9,0)
SET I ($L(PSOBX)+$L(^PS(52.9,PSOBIO,1,ZI,2,J,0))+1)<245 S PSOBX=PSOBX_+^(0)_P S:$P(^(0),"^",2) PSOBXPRT($P(^(0),"^"))=$P(^(0),"^",2) S:$P(^(0),"^",3)'="" PBXRF($P(^(0),"^"))=$P(^(0),"^",3)
"RTN","PSOBMST",10,0)
 E  S PSOBX1=PSOBX1_+^PS(52.9,PSOBIO,1,ZI,2,J,0)_P S:$P(^(0),"^",2) PSOBXPRT($P(^(0),"^"))=$P(^(0),"^",2) S:$P(^(0),"^",3)'="" PBXRF($P(^(0),"^"))=$P(^(0),"^",3)
"RTN","PSOBMST",11,0)
 Q
"RTN","PSOBMST",12,0)
PRF Q:(ZI=PSOBP2)&((PSOBR2=0)!($D(^PS(52.9,PSOBIO,1,ZI,2,PSOBR2,0))))  S:PSOBX'="" NEW1="^"_PSOBX S:PSOBX1'="" NEW11="^"_PSOBX1
"RTN","PSOBMST",13,0)
 S DFN=$P(^PS(52.9,PSOBIO,1,ZI,0),"^"),PSODTCUT=$P(^(0),"^",4),PSOPRPAS=$P(^(0),"^",6),PFIO=IO,%ZIS="",IOP=PFIO D ^%ZIS D START^PSOPRF S (NEW1,NEW11)="" K DFN,PSODTCUT,PSOPRPAS,IOP Q
"RTN","PSOBMST",14,0)
LBL S PPL=PSOBX,PSOSITE=$P(^PS(52.9,PSOBIO,1,ZI,0),"^",7),REPRINT=1 S:$P(^(0),"^",5)'="" COPIES=$P(^(0),"^",5) S:$P(^(0),"^",6)'="" SIDE=$P(^(0),"^",6) I $D(^(1)),^(1)'="" S RXY=^(1)
"RTN","PSOBMST",15,0)
 S IOP=IO,%ZIS="" D ^%ZIS K IOP D EN01
"RTN","PSOBMST",16,0)
 F L=1:1 S LBL=$P(PPL,",",L) Q:(LBL="")&(L'<$L(PPL,","))  D UPDT
"RTN","PSOBMST",17,0)
 I $G(PSOBX1)'="" S PSOBX=PSOBX1 S PSOBX1="" G LBL
"RTN","PSOBMST",18,0)
 K PPL,PSOSITE,REPRINT,RXP,RXY,COPIES,SIDE Q
"RTN","PSOBMST",19,0)
UPDT ;
"RTN","PSOBMST",20,0)
 S BBB=0 F BBBB=0:0 S BBBB=$O(^PSRX(LBL,1,BBBB)) Q:'BBBB  S BBB=BBBB S:BBBB>5 BBB=BBBB+1
"RTN","PSOBMST",21,0)
 S K=1,II=0 F JJ=0:0 S JJ=$O(^PSRX(LBL,"A",JJ)) Q:'JJ  S II=JJ,K=K+1
"RTN","PSOBMST",22,0)
 S II=II+1 S:'($D(^PSRX(LBL,"A",0))#2) ^(0)="^52.3DA^^^" S ^(0)=$P(^(0),"^",1,2)_"^"_II_"^"_K,^PSRX(LBL,"A",II,0)=DT_"^W^"_PDUZ_"^"_$S($G(PSOBXPRT(LBL)):6,$D(PBXRF(LBL)):PBXRF(LBL),1:BBB)_"^"_"GROUP REPRINT" D  Q
"RTN","PSOBMST",23,0)
 .I $G(PBXRF(LBL))>5,'$G(PSOBXPRT(LBL)) S $P(^PSRX(LBL,"A",II,0),"^",4)=($G(PBXRF(LBL))+1)
"RTN","PSOBMST",24,0)
EN01 I $D(PSOIOS),PSOIOS]"" D DEVBAR
"RTN","PSOBMST",25,0)
 I $G(PSOBAR0)]"",$G(PSOBAR1)]"",$D(^PS(59,PSOSITE,1)) S PSOBARS=1
"RTN","PSOBMST",26,0)
 K PSOCPN,PSOLBLCP
"RTN","PSOBMST",27,0)
 I $G(PSODISP) D ^PSOLBL4
"RTN","PSOBMST",28,0)
 G:'$D(PPL)!($P(PSOPAR,"^",30)=2) OUT
"RTN","PSOBMST",29,0)
 F PI=1:1 Q:$P(PPL,",",PI)=""  S RX=$P(PPL,",",PI) D
"RTN","PSOBMST",30,0)
 .S PSOBLALL=1,RXRP(RX)=1_"^"_$G(COPIES)_"^"_$S($G(SIDE):1,1:0)
"RTN","PSOBMST",31,0)
 .S:$G(PSOBXPRT(RX)) RXPR(RX)=PSOBXPRT(RX)
"RTN","PSOBMST",32,0)
 .S:$D(PBXRF(RX)) RXFL(RX)=PBXRF(RX) D C^PSOLBL
"RTN","PSOBMST",33,0)
 .K RXRP(+$G(PSOBLRX)),RXPR(+$G(PSOBLRX)),RXFL(+$G(PSOBLRX))
"RTN","PSOBMST",34,0)
 .K PSOBLRX,RXP
"RTN","PSOBMST",35,0)
OUT K PSOCPN,PSOLBLCP,RXRP,RXPR,RXFL,PSOBLRX,RXP,RX
"RTN","PSOBMST",36,0)
 Q
"RTN","PSOBMST",37,0)
DEVBAR ;get the barcode parameters
"RTN","PSOBMST",38,0)
 N DA,DR,DPTR,DPTRS,DPTRS1,DIQ,DIC
"RTN","PSOBMST",39,0)
 S DIC="^%ZIS(1,",DA=PSOIOS,DR="3",DIQ="DPTR",DIQ(0)="I" D EN^DIQ1
"RTN","PSOBMST",40,0)
 S DPTRS=$G(DPTR(3.5,DA,3,DIQ(0)))
"RTN","PSOBMST",41,0)
 S DIC="^%ZIS(2,",DA=DPTRS,DR="61;60",DIQ="DPTRS1",DIQ(0)="I" D EN^DIQ1
"RTN","PSOBMST",42,0)
 S PSOBAR0="" I $G(DPTRS1(3.2,DA,61,DIQ(0)))'="" S PSOBAR0=$G(DPTRS1(3.2,DA,61,DIQ(0)))
"RTN","PSOBMST",43,0)
 S PSOBAR1="" I $G(DPTRS1(3.2,DA,60,DIQ(0)))'="" S PSOBAR1=$G(DPTRS1(3.2,DA,60,DIQ(0)))
"RTN","PSOBMST",44,0)
 Q
"RTN","PSOHLDIS")
0^1^B53862506
"RTN","PSOHLDIS",1,0)
PSOHLDIS ;BIR/PWC,SAB - Automated Dispense Completion HL7 v.2.4 ;01/05/04
"RTN","PSOHLDIS",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,189,193**;DEC 1997
"RTN","PSOHLDIS",3,0)
 ;Reference to ^PSDRUG supported by DBIA #221
"RTN","PSOHLDIS",4,0)
 ;This routine is called by FACK1^PSOHLDS
"RTN","PSOHLDIS",5,0)
 K OK
"RTN","PSOHLDIS",6,0)
 F I=0:0 S I=$O(PSOMSG(I)) Q:'I  D
"RTN","PSOHLDIS",7,0)
 .I $P(PSOMSG(I),"|")="MSH" S NODE1=PSOMSG(I) Q
"RTN","PSOHLDIS",8,0)
 .I $P(PSOMSG(I),"|")="MSA" S NODE2=PSOMSG(I) Q
"RTN","PSOHLDIS",9,0)
 .I $P(PSOMSG(I),"|")="PID" S NODE3=PSOMSG(I) Q
"RTN","PSOHLDIS",10,0)
 .I $P(PSOMSG(I),"|")="ORC" S NODE4=PSOMSG(I) Q
"RTN","PSOHLDIS",11,0)
 .I $P(PSOMSG(I),"|")="RXD" S NODE5=PSOMSG(I) Q
"RTN","PSOHLDIS",12,0)
 ;PID segment
"RTN","PSOHLDIS",13,0)
 S PID=$P($G(NODE3),"|",4)   ;this contains all the patient id numbers
"RTN","PSOHLDIS",14,0)
 F XX=1:1 S PIDD=$P(PID,"^",XX) Q:PIDD=""  D
"RTN","PSOHLDIS",15,0)
 . S PIDID=$P(PIDD,"~",5)
"RTN","PSOHLDIS",16,0)
 . I PIDID="NI" S PICN=$P(PIDD,"~",1)   ;ICN #
"RTN","PSOHLDIS",17,0)
 . I PIDID="SS" S PSSN=$P(PIDD,"~",1)   ;SSN #
"RTN","PSOHLDIS",18,0)
 . I PIDID="PI" S PPID=$P(PIDD,"~",1)   ;patient ID
"RTN","PSOHLDIS",19,0)
 . I PIDID="PN" S PCLM=$P(PIDD,"~",1)   ;claim #
"RTN","PSOHLDIS",20,0)
 ;ORC segment
"RTN","PSOHLDIS",21,0)
 S RXID=$P($P($G(NODE4),"|",3),"^")    ;RX #
"RTN","PSOHLDIS",22,0)
 S DFN=$P(^PSRX(RXID,0),"^",2) D DEM^VADPT
"RTN","PSOHLDIS",23,0)
 S NAME=VADM(1),DOB=$P(VADM(3),"^"),SEX=$P(VADM(5),"^") K VADM
"RTN","PSOHLDIS",24,0)
 S FPER=$P($P($G(NODE4),"|",11),"~")   ;filling person
"RTN","PSOHLDIS",25,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+FPER D
"RTN","PSOHLDIS",26,0)
 .D ^DIC I +Y>0 S FPER=+Y,FPERN=$P(Y,"^",2) Q
"RTN","PSOHLDIS",27,0)
 .S FPER="",FPERN="UNKNOWN"
"RTN","PSOHLDIS",28,0)
 S CPHARM=$P($P($G(NODE4),"|",12),"~") ;checking pharmacist
"RTN","PSOHLDIS",29,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+CPHARM D  K DIC,X,Y
"RTN","PSOHLDIS",30,0)
 .D ^DIC I +Y>0 S CPHARM=+Y,CPHARMN=$P(Y,"^",2) Q
"RTN","PSOHLDIS",31,0)
 .S CPHARM="",CPHARMN="UNKNOWN"
"RTN","PSOHLDIS",32,0)
 ;RXD segment
"RTN","PSOHLDIS",33,0)
 S FILL=$P($P($G(NODE5),"|",2),"^")         ;fill #
"RTN","PSOHLDIS",34,0)
 S GIVECOD=$P($P($G(NODE5),"|",3),"^")      ;give code
"RTN","PSOHLDIS",35,0)
 S X=$P($P($G(NODE5),"|",4),"^"),DISPDT=$$FMDATE^HLFNC(X) K X  ;dispense date
"RTN","PSOHLDIS",36,0)
 S PSORX=$P($P($G(NODE5),"|",8),"^")        ;prescription #
"RTN","PSOHLDIS",37,0)
 S NDC=$P($P($G(NODE5),"|",10),"^")  ;NDC #
"RTN","PSOHLDIS",38,0)
 K F I NDC]"" D  K L,F
"RTN","PSOHLDIS",39,0)
 .F L=1:1:$L(NDC) Q:$P(NDC,"^",L)=""  S F=$G(F)_$P(NDC,"^",L)_$S($P(NDC,"^",(L+1))]"":",",1:"")
"RTN","PSOHLDIS",40,0)
 .S NDC=F
"RTN","PSOHLDIS",41,0)
 S X=$P($P($G(NODE5),"|",10),"^",2),RELDT=$S($$FMDATE^HLFNC(X)>0:$$FMDATE^HLFNC(X),1:"") K X  ;release dt
"RTN","PSOHLDIS",42,0)
 S PRT=$S($P($P($G(NODE5),"|",10),"^",3)=1:1,$P($P($G(NODE5),"|",10),"^",3)=2:1,1:0)  ;label printed by vendor
"RTN","PSOHLDIS",43,0)
 S MEDDISP=$S($P($P($G(NODE5),"|",10),"^",3)=1:1,$P($P($G(NODE5),"|",10),"^",3)=4:1,1:0)  ;med dispensed by vendor
"RTN","PSOHLDIS",44,0)
 S RPHARM=$P($P($G(NODE5),"|",11),"~",1)      ;releasing pharmacist
"RTN","PSOHLDIS",45,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+RPHARM D
"RTN","PSOHLDIS",46,0)
 .D ^DIC I +Y>0 S RPHARM=+Y Q
"RTN","PSOHLDIS",47,0)
 .S RPHARM=""
"RTN","PSOHLDIS",48,0)
 ;S LOT=$P($P($G(NODE5),"|",19),"^")         ;lot #
"RTN","PSOHLDIS",49,0)
 S LOT=$P($G(NODE5),"|",19)
"RTN","PSOHLDIS",50,0)
 I LOT]"" D  K L,F
"RTN","PSOHLDIS",51,0)
 .F L=1:1:$L(LOT) Q:$P(LOT,"^",L)=""  S F=$G(F)_$P(LOT,"^",L)_$S($P(LOT,"^",(L+1))]"":",",1:"")
"RTN","PSOHLDIS",52,0)
 .S LOT=F
"RTN","PSOHLDIS",53,0)
 S X=$P($P($G(NODE5),"|",20),"^"),EXPDT=$S($$FMDATE^HLFNC(X)>0:$$FMDATE^HLFNC(X),1:"") K X   ;expiration date
"RTN","PSOHLDIS",54,0)
 S MFG=$P($P($G(NODE5),"|",21),"^")         ;manufacturer
"RTN","PSOHLDIS",55,0)
 K F I MFG]"" D  K L,F
"RTN","PSOHLDIS",56,0)
 .F L=1:1:$L(MFG) Q:$P(MFG,"^",L)=""  S F=$G(F)_$P(MFG,"^",L)_$S($P(MFG,"^",(L+1))]"":",",1:"")
"RTN","PSOHLDIS",57,0)
 .S MFG=F
"RTN","PSOHLDIS",58,0)
 S EXRX=^PS(52.51,EIN,0)
"RTN","PSOHLDIS",59,0)
 S IRX=$P(EXRX,"^"),FLL=$P(EXRX,"^",8),FLLN=$P(EXRX,"^",9),RPT=$P(EXRX,"^",5),(DIV,PSOSITE)=$P(EXRX,"^",11),PSOPAR=$G(^PS(59,DIV,0))
"RTN","PSOHLDIS",60,0)
 S PSOPAR7=$G(^PS(59,PSOSITE,"IB")),PSOSYS=$G(^PS(59.7,1,40.1))
"RTN","PSOHLDIS",61,0)
 S RXN=$P(^PSRX(IRX,0),"^"),DRG=$P(^(0),"^",6),QTY=$P(^(0),"^",7)
"RTN","PSOHLDIS",62,0)
 I FLL="F" D
"RTN","PSOHLDIS",63,0)
 .I 'FLLN D  Q
"RTN","PSOHLDIS",64,0)
 ..S $P(^PSRX(IRX,2),"^",4)=LOT,$P(^(2),"^",7)=NDC,$P(^(2),"^",8)=MFG,$P(^(2),"^",11)=EXPDT,$P(^PSRX(IRX,"OR1"),"^",6)=FPER,$P(^("OR1"),"^",7)=CPHARM
"RTN","PSOHLDIS",65,0)
 ..S:$G(^PSDRUG(DRG,660.1))]"" ^PSDRUG(DRG,660.1)=^PSDRUG(DRG,660.1)-QTY
"RTN","PSOHLDIS",66,0)
 ..I $P($G(^PS(59,DIV,"DISP")),"^",2),$G(RELDT) D
"RTN","PSOHLDIS",67,0)
 ...S DIE="^PSRX(",DA=IRX,DR="31///"_RELDT_";23////"_RPHARM_";32.1///@;32.2///@" D ^DIE K DIE,DR,DA
"RTN","PSOHLDIS",68,0)
 ...I $P(^PSRX(IRX,0),"^",11)["W" S BRT="W",BNAM=$P(^PSRX(IRX,0),"^",2),BDIV=$P(^(2),"^",9) S:BDIV'="" BGRP=$P($G(^PS(59,BDIV,1)),"^",20)
"RTN","PSOHLDIS",69,0)
 ...S PSOCPRX=$P(^PSRX(IRX,0),"^"),RXP=IRX D CP^PSOCP
"RTN","PSOHLDIS",70,0)
 ...D EN^PSOHLSN1(IRX,"ZD")
"RTN","PSOHLDIS",71,0)
 .I FLLN D
"RTN","PSOHLDIS",72,0)
 ..S $P(^PSRX(IRX,1,FLLN,0),"^",6)=LOT,$P(^(0),"^",14)=MFG,$P(^(0),"^",15)=EXPDT,$P(^PSRX(IRX,1,FLLN,1),"^",3)=NDC,$P(^(1),"^",4)=FPER,$P(^(1),"^",5)=CPHARM
"RTN","PSOHLDIS",73,0)
 ..S:$G(^PSDRUG(DRG,660.1))]"" ^PSDRUG(DRG,660.1)=^PSDRUG(DRG,660.1)-$P(^PSRX(IRX,1,FLLN,0),"^",4)
"RTN","PSOHLDIS",74,0)
 ..I $P($G(^PS(59,DIV,"DISP")),"^",2),$G(RELDT) D
"RTN","PSOHLDIS",75,0)
 ...S DIE="^PSRX("_IRX_","""_1_""",",DA(1)=IRX,DA=FLLN
"RTN","PSOHLDIS",76,0)
 ...S DR="17///"_RELDT_";4////"_RPHARM D ^DIE K DIE,DR,DA
"RTN","PSOHLDIS",77,0)
 ...I $P(^PSRX(IRX,1,FLLN,0),"^",2)["W" S BRT="W",BDIV=$P(^PSRX(IRX,1,FLLN,0),"^",9),BNAM=$P(^PSRX(IRX,0),"^",2) S:BDIV'="" BGRP=$P($G(^PS(59,BDIV,1)),"^",20)
"RTN","PSOHLDIS",78,0)
 ...S PSOCPRX=$P(^PSRX(IRX,0),"^"),RXP=IRX D CP^PSOCP
"RTN","PSOHLDIS",79,0)
 ...D EN^PSOHLSN1(IRX,"ZD")
"RTN","PSOHLDIS",80,0)
 ;partial
"RTN","PSOHLDIS",81,0)
 I FLL="P" D
"RTN","PSOHLDIS",82,0)
 .S $P(^PSRX(IRX,"P",FLLN,0),"^",6)=LOT,$P(^(0),"^",12)=NDC,$P(^PSRX(IRX,"P",FLLN,1),"^")=MFG,$P(^(1),"^",3)=FPER,$P(^(1),"^",4)=CPHARM
"RTN","PSOHLDIS",83,0)
 .S:$G(^PSDRUG(DRG,660.1))]"" ^PSDRUG(DRG,660.1)=^PSDRUG(DRG,660.1)-$P(^PSRX(IRX,"P",FLLN,0),"^",4)
"RTN","PSOHLDIS",84,0)
 .I $P($G(^PS(59,DIV,"DISP")),"^",2),$G(RELDT) D
"RTN","PSOHLDIS",85,0)
 ..S DIE="^PSRX("_IRX_","""_"P"_""",",DA(1)=IRX,DA=FLLN
"RTN","PSOHLDIS",86,0)
 ..S DR="8///"_RELDT_";.05////"_RPHARM D ^DIE K DIE,DR,DA
"RTN","PSOHLDIS",87,0)
 ..I $P(^PSRX(IRX,"P",FLLN,0),"^",2)["W" S BRT="W",BDIV=$P(^PSRX(IRX,"P",FLLN,0),"^",9),BNAM=$P(^PSRX(IRX,0),"^",2) S:BDIV'="" BGRP=$P($G(^PS(59,BDIV,1)),"^",20)
"RTN","PSOHLDIS",88,0)
 S RXF=0 F I=0:0 S I=$O(^PSRX(RXID,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSOHLDIS",89,0)
 S ACL=0 F I=0:0 S I=$O(^PSRX(RXID,"A",I)) Q:'I  S ACL=(ACL+1)
"RTN","PSOHLDIS",90,0)
 D NOW^%DTC S NOW=%,ACL=ACL+1,^PSRX(RXID,"A",0)="^52.3DA^"_ACL_"^"_ACL
"RTN","PSOHLDIS",91,0)
 S ^PSRX(RXID,"A",ACL,0)=NOW_"^N^"_RPHARM_"^"_RXF_"^"_$S(MEDDISP:"External Interface Dispensing is Complete.",1:"Medication WAS NOT Dispensed through Interface!")
"RTN","PSOHLDIS",92,0)
 I MEDDISP D
"RTN","PSOHLDIS",93,0)
 .S ^PSRX(RXID,"A",ACL,2,0)="^52.34A^2^2"
"RTN","PSOHLDIS",94,0)
 .S ^PSRX(RXID,"A",ACL,2,1,0)="Filled By: "_FPERN
"RTN","PSOHLDIS",95,0)
 .S ^PSRX(RXID,"A",ACL,2,2,0)="Checking Pharmacist: "_CPHARMN
"RTN","PSOHLDIS",96,0)
 I PRT D
"RTN","PSOHLDIS",97,0)
 .S LBI=0 F LB=0:0 S LB=$O(^PSRX(RXID,"L",LB)) Q:'LB  S LBI=LBI+1
"RTN","PSOHLDIS",98,0)
 .S LBI=LBI+1,^PSRX(RXID,"L",0)="^52.032DA^"_LBI_"^"_LBI
"RTN","PSOHLDIS",99,0)
 .S ^PSRX(RXID,"L",LBI,0)=NOW_"^"_$S(FLL="F":FLLN,1:(99-FLLN))_"^"_"From Rx # "_$P(^PSRX(RXID,0),"^")_$S(FLL="P":" (Partial)",1:"")_$S($G(HLRPT):" (Reprint)",1:"")_" (External Interface)"_"^"_HLUSER
"RTN","PSOHLDIS",100,0)
 K ACL,I,NOW,LBI,LB,PRT,MEDDISP
"RTN","PSOHLDIS",101,0)
 I $D(BGRP),$D(BNAM),$D(BDIV) D REL
"RTN","PSOHLDIS",102,0)
 ;
"RTN","PSOHLDIS",103,0)
END K ADA,BDA,BDIV,BNGRXP,BNGSUS,BNAME,BRX,CNT1,CT,DA,DD,DIC,DIE,DIK,DIR,DO,DR,DTOUT,DUOUT,GRP,GRTP,JOES
"RTN","PSOHLDIS",104,0)
 K NAM,NDA,NFLAG,NME,ODA,PSZ,RXO,SSN,TDFN,TFLAG,TIC,TICK,TIEN,TM,TM1,TSSN,X,Y,XX,BNAM,BRT,BGRP
"RTN","PSOHLDIS",105,0)
 K Y,OK,XQADATA,SITEN,RDOM,CMOP,REQT,RTDTM,SITENUM,XQSOP,XQMSG,SITEN,NAME,XQAMSG,SITEN
"RTN","PSOHLDIS",106,0)
 K XQAROU,XQAID,RDTM,NODE1,NODE2,NODE3,NODE4,NODE5,PIDID,PIDD,PICN,PSSN,PPID,PCLM
"RTN","PSOHLDIS",107,0)
 K CPHARM,CPHARMN,FPER,FPERN,RPHARM
"RTN","PSOHLDIS",108,0)
 Q
"RTN","PSOHLDIS",109,0)
REL ;displays to bingo board
"RTN","PSOHLDIS",110,0)
 N NAM,NAME,RXO,SSN S ADA="",BRXP=RXID
"RTN","PSOHLDIS",111,0)
 F XX=0:0 S XX=$O(^PS(52.11,"B",BNAM,XX)) Q:'XX  D
"RTN","PSOHLDIS",112,0)
 .F BRX=0:0 S BRX=$O(^PS(52.11,XX,2,"B",BRX)) Q:'BRX  I BRX=BRXP S (DA,ODA)=XX
"RTN","PSOHLDIS",113,0)
 Q:'$D(DA)
"RTN","PSOHLDIS",114,0)
 I $P($G(^PS(52.11,DA,0)),"^",7)]"" Q
"RTN","PSOHLDIS",115,0)
 I $P($P($G(^PS(52.11,DA,0)),"^",5),".")'=DT S DIK="^PS(52.11," D ^DIK K DIK Q
"RTN","PSOHLDIS",116,0)
 N TM,TM1 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2)
"RTN","PSOHLDIS",117,0)
 S NM=$P(^DPT($P(^PS(52.11,DA,0),"^"),0),"^"),DR="6////"_$E(TM1_"0000",1,4)_";8////"_NM_"",DIE="^PS(52.11,"
"RTN","PSOHLDIS",118,0)
 L +^PS(52.11,DA):2 E  Q
"RTN","PSOHLDIS",119,0)
 D ^DIE L -^PS(52.11,DA) I $G(X)="" S DIK="^PS(52.11," D ^DIK K DIK Q
"RTN","PSOHLDIS",120,0)
 S RX0=^PS(52.11,DA,0),JOES=$P(RX0,"^",4),TICK=+$P($G(RX0),"^",2),GRP=$P($G(^PS(59.3,$P($G(^PS(52.11,DA,0)),"^",3),0)),"^",2)
"RTN","PSOHLDIS",121,0)
 I GRP="T",'$G(TICK) S DIK="^PS(52.11," D ^DIK K DIK
"RTN","PSOHLDIS",122,0)
 Q:'$G(DA)
"RTN","PSOHLDIS",123,0)
 S PSZ=0 I '$D(^PS(59.2,DT,0)) K DD,DIC,DO,DA S X=DT,DIC="^PS(59.2,",DIC(0)="",DINUM=X D FILE^DICN S PSZ=1 Q:Y'>0 
"RTN","PSOHLDIS",124,0)
 I PSZ=1 S DA(1)=+Y,DIC=DIC_DA(1)_",1,",(DINUM,X)=JOES,DIC(0)="",DIC("P")=$P(^DD(59.2,1,0),"^",2) K DD,DO D FILE^DICN K DIC,DA Q:Y'>0
"RTN","PSOHLDIS",125,0)
 I PSZ=0 K DD,DIC,DO,DA S DA(1)=DT,(DINUM,X)=JOES,DIC="^PS(59.2,"_DT_",1,",DIC(0)="LZ" D FILE^DICN K DIC,DA,DO
"RTN","PSOHLDIS",126,0)
 S DA=ODA D STATS1^PSOBRPRT,WTIME^PSOBING1
"RTN","PSOHLDIS",127,0)
 Q
"RTN","PSOHLDIS",128,0)
ERROR ;sends the error message back to the sending station
"RTN","PSOHLDIS",129,0)
 ;parse the data from the msh segment in order to send back the error message
"RTN","PSOHLDIS",130,0)
 ;OK=1 - segment missing
"RTN","PSOHLDIS",131,0)
 ;OK=2 - Rx does not exists
"RTN","PSOHLDIS",132,0)
 D NOW^%DTC
"RTN","PSOHLDIS",133,0)
 S REJ=$S(OK=1:"MISSING SEGMENT(S)",OK=2:"PRESCRIPTION "_$S($G(PSORX):"#: "_PSORX,1:"")_" DOES NOT EXISTS",1:"")
"RTN","PSOHLDIS",134,0)
 S ACKDATE=$P($$FMTHL7^XLFDT(%),"-",1)
"RTN","PSOHLDIS",135,0)
 S ^TMP("PSO2",$J,1)="MSH|^~\&|PSO VISTA||PSO DISPENSE||"_$G(ACKDATE)_"||RDS^013|10001|P|2.4|||NE|NE"
"RTN","PSOHLDIS",136,0)
 ;S ^TMP("PSO2",$J,2)="MFE|MUP|"_$G(J)_"|"_$G(ACKDATE)_"|"_$G(SITE)_"|CE"
"RTN","PSOHLDIS",137,0)
 ;S ^TMP("PSO2",$J,3)="ZLF|4|^"_$G(USER)_"||"_$G(REJ)
"RTN","PSOHLDIS",138,0)
 K %,ACKDATE,USER,Y,REJ,OK
"RTN","PSOHLDIS",139,0)
 Q
"RTN","PSORXVW1")
0^4^B64009831
"RTN","PSORXVW1",1,0)
PSORXVW1 ;BIR/SAB-view prescription con't ;09/11/96
"RTN","PSORXVW1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**35,47,46,71,99,117,156,193**;DEC 1997
"RTN","PSORXVW1",3,0)
 ;External reference to ^DD(52 supported by DBIA 999
"RTN","PSORXVW1",4,0)
 ;External reference to ^VA(200 supported by DBIA 10060
"RTN","PSORXVW1",5,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",6) D
"RTN","PSORXVW1",6,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(^PSRX(RXN,"OR1"),"^",6) D ^DIC
"RTN","PSORXVW1",7,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="           Filled By: "_$P(Y,"^",2) K DIC,X,Y
"RTN","PSORXVW1",8,0)
 I $P($G(^PSRX(RXN,"OR1")),"^",7) D
"RTN","PSORXVW1",9,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(^PSRX(RXN,"OR1"),"^",7) D ^DIC
"RTN","PSORXVW1",10,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="          Checked By: "_$P(Y,"^",2) K DIC,X,Y
"RTN","PSORXVW1",11,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(RX0,"^",16) D ^DIC
"RTN","PSORXVW1",12,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="   Entry By: "_$P(Y,"^",2)_$E(RN,$L($P(Y,"^",2))+1,35)
"RTN","PSORXVW1",13,0)
 S Y=$P(RX2,"^") X ^DD("DD")
"RTN","PSORXVW1",14,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"Entry Date: "_$E($P(RX2,"^"),4,5)_"/"_$E($P(RX2,"^"),6,7)_"/"_$E($P(RX2,"^"),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSORXVW1",15,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" " ;,IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSORXVW1",16,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Original Fill Released: " I $P(RX2,"^",13) S DTT=$P(RX2,"^",13) D DAT S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_DAT K DAT,DTT
"RTN","PSORXVW1",17,0)
 I $P(RX2,"^",15) S DTT=$P(RX2,"^",15) D DAT S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"(Returned to Stock "_DAT_")" K DAT,DTT
"RTN","PSORXVW1",18,0)
 S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"      Routing: "_$S($P(RX0,"^",11)="W":"Window",1:"Mail")
"RTN","PSORXVW1",19,0)
 I $G(^PSRX(DA,"H"))]"",$P(^("STA"),"^")=3 D HLD
"RTN","PSORXVW1",20,0)
 D RF,PAR,ACT,COPAY^PSORXVW2,LBL,^PSORXVW2:$O(^PSRX(DA,4,0))
"RTN","PSORXVW1",21,0)
 Q
"RTN","PSORXVW1",22,0)
ACT ;activity log
"RTN","PSORXVW1",23,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Activity Log:"
"RTN","PSORXVW1",24,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date        Reason         Rx Ref         Initiator Of Activity",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSORXVW1",25,0)
 I '$O(^PSRX(DA,"A",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There's NO Activity to report" Q
"RTN","PSORXVW1",26,0)
 F N=0:0 S N=$O(^PSRX(DA,"A",N)) Q:'N  S P1=^(N,0),DTT=P1\1 D DAT D
"RTN","PSORXVW1",27,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=N_"   "_DAT_"    ",$P(RN," ",15)=" ",REA=$P(P1,"^",2),REA=$F("HUCELPRWSIVDABXGKN",REA)-1
"RTN","PSORXVW1",28,0)
 .I REA D
"RTN","PSORXVW1",29,0)
 ..S STA=$P("HOLD^UNHOLD^DISCONTINUED^EDIT^RENEWED^PARTIAL^REINSTATE^REPRINT^SUSPENSE^RETURNED^INTERVENTION^DELETED^DRUG INTERACTION^PROCESSED^X-INTERFACE^PATIENT INSTR.^PKI/DEA^DISP COMPLETED^","^",REA)
"RTN","PSORXVW1",30,0)
 ..S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA_$E(RN,$L(STA)+1,15)
"RTN","PSORXVW1",31,0)
 .E  S $P(STA," ",15)=" ",^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_STA
"RTN","PSORXVW1",32,0)
 .K STA,RN S $P(RN," ",15)=" ",RF=+$P(P1,"^",4)
"RTN","PSORXVW1",33,0)
 .S RFT=$S(RF>0&(RF<6):"REFILL "_RF,RF=6:"PARTIAL",RF>6:"REFILL "_(RF-1),1:"ORIGINAL")
"RTN","PSORXVW1",34,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(P1,"^",3) D ^DIC
"RTN","PSORXVW1",35,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RFT_$E(RN,$L(RFT)+1,15)_$S(+Y:$P(Y,"^",2),1:$P(P1,"^",3))
"RTN","PSORXVW1",36,0)
 .;S:$P(P1,"^",5)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_$P(P1,"^",5)
"RTN","PSORXVW1",37,0)
 .I $P(P1,"^",5)]"" N PSOACBRK,PSOACBRV D
"RTN","PSORXVW1",38,0)
 ..S PSOACBRV=$P(P1,"^",5)
"RTN","PSORXVW1",39,0)
 ..I $L(PSOACBRV)<71 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_PSOACBRV Q
"RTN","PSORXVW1",40,0)
 ..I $E(PSOACBRV,1,70)'[" " S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_$E(PSOACBRV,1,70),IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$E(PSOACBRV,71,245) Q
"RTN","PSORXVW1",41,0)
 ..F PSOACBRK=245:-1 Q:PSOACBRK=0  I $E(PSOACBRV,PSOACBRK)=" ",PSOACBRK<71 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_$E(PSOACBRV,1,PSOACBRK),IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=$E(PSOACBRV,PSOACBRK,245) Q
"RTN","PSORXVW1",42,0)
 .I $G(^PSRX(DA,"A",N,1))]"" S IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",5)=$P(^PSRX(DA,"A",N,1),"^") I $P(^PSRX(DA,"A",N,1),"^",2)]"" S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_":"_$P(^PSRX(DA,"A",N,1),"^",2)
"RTN","PSORXVW1",43,0)
 .I $O(^PSRX(DA,"A",N,2,0)) F I=0:0 S I=$O(^PSRX(RXN,"A",N,2,I)) Q:'I  S MIG=^PSRX(RXN,"A",N,2,I,0) D
"RTN","PSORXVW1",44,0)
 ..F SG=1:1:$L(MIG) S:$L(^TMP("PSOAL",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",9)=" " S:$P(MIG," ",SG)'="" ^TMP("PSOAL",$J,IEN,0)=$G(^TMP("PSOAL",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSORXVW1",45,0)
 K MIG,SG,I Q
"RTN","PSORXVW1",46,0)
LBL ;label log
"RTN","PSORXVW1",47,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Label Log:"
"RTN","PSORXVW1",48,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Date        Rx Ref                    Printed By",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSORXVW1",49,0)
 I '$O(^PSRX(DA,"L",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There are NO Labels printed." Q
"RTN","PSORXVW1",50,0)
 F L1=0:0 S L1=$O(^PSRX(DA,"L",L1)) Q:'L1  S LBL=^PSRX(DA,"L",L1,0),DTT=$P(^(0),"^") D DAT D
"RTN","PSORXVW1",51,0)
 .S $P(RN," ",26)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=L1_"   "_DAT_"    ",RFT=$S($P(LBL,"^",2):"REFILL "_$P(LBL,"^",2),1:"ORIGINAL"),RFT=RFT_$E(RN,$L(RFT)+1,26)
"RTN","PSORXVW1",52,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(LBL,"^",4) D ^DIC
"RTN","PSORXVW1",53,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RFT_$P(Y,"^",2),IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Comments: "_$P(LBL,"^",3)
"RTN","PSORXVW1",54,0)
 K DIC,X,Y Q
"RTN","PSORXVW1",55,0)
RF ;refill log
"RTN","PSORXVW1",56,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Refill Log:"
"RTN","PSORXVW1",57,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#  Log Date   Refill Date  Qty               Routing  Lot #       Pharmacist",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSORXVW1",58,0)
 S (RF,PL)=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S PL=PL+1
"RTN","PSORXVW1",59,0)
 I 'PL S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There are NO Refills For this  Prescription" Q
"RTN","PSORXVW1",60,0)
 F N=0:0 S N=$O(^PSRX(DA,1,N)) Q:'N  S P1=^(N,0) D
"RTN","PSORXVW1",61,0)
 .S DTT=$P(P1,"^",8)\1 D DAT S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=N_"   "_DAT_"   "
"RTN","PSORXVW1",62,0)
 .S DTT=$P(P1,"^"),$P(RN," ",10)=" " D DAT
"RTN","PSORXVW1",63,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_DAT_"     "_$P(P1,"^",4)_$E("               ",$L($P(P1,"^",4))+1,15)_"  "_$S($P(P1,"^",2)="M":"Mail",1:"Window")_" "_$P(P1,"^",6)_$E(RN,$L($P(P1,"^",6))+1,12)
"RTN","PSORXVW1",64,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+$P(P1,"^",5) D ^DIC
"RTN","PSORXVW1",65,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_$E($S(+Y:$P(Y,"^",2),1:""),1,16) K DIC,X,Y
"RTN","PSORXVW1",66,0)
 .S PSDIV=$S($D(^PS(59,+$P(P1,"^",9),0)):$P(^(0),"^",6),1:"Unknown"),IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Division: "_PSDIV_$E("        ",$L(PSDIV)+1,8)_"  "
"RTN","PSORXVW1",67,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_"Dispensed: "_$S($P(P1,"^",19):$E($P(P1,"^",19),4,5)_"/"_$E($P(P1,"^",19),6,7)_"/"_$E($P(P1,"^",19),2,3),1:"")_"  "
"RTN","PSORXVW1",68,0)
 .S RTS=$S($P(P1,"^",16):" Returned to Stock: "_$E($P(P1,"^",16),4,5)_"/"_$E($P(P1,"^",16),6,7)_"/"_$E($P(P1,"^",16),2,3),1:" Released: "_$S($P(P1,"^",18):$E($P(P1,"^",18),4,5)_"/"_$E($P(P1,"^",18),6,7)_"/"_$E($P(P1,"^",18),2,3),1:""))
"RTN","PSORXVW1",69,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_RTS S:$P(P1,"^",3)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="   Remarks: "_$P(P1,"^",3)
"RTN","PSORXVW1",70,0)
 K RTS Q
"RTN","PSORXVW1",71,0)
PAR ;partial log
"RTN","PSORXVW1",72,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Partial Fills:"
"RTN","PSORXVW1",73,0)
 S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="#   Log Date   Date     Qty              Routing    Lot #        Pharmacist",IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0),"=",79)="="
"RTN","PSORXVW1",74,0)
 I '$O(^PSRX(DA,"P",0)) S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="There are NO Partials for this Prescription" Q
"RTN","PSORXVW1",75,0)
 S N=0 F  S N=$O(^PSRX(DA,"P",N)) Q:'N  S P1=^(N,0),DTT=$P(P1,"^",8)\1 D DAT D
"RTN","PSORXVW1",76,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)=N_"   "_DAT_"  ",QTY=$P(P1,"^",4)_$E("               ",$L($P(P1,"^",4))+1,15)
"RTN","PSORXVW1",77,0)
 .S DTT=$P(P1,"^") D DAT S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_DAT_"  "_QTY_"  "
"RTN","PSORXVW1",78,0)
 .S PSDIV=$S($D(^PS(59,+$P(P1,"^",9),0)):$P(^(0),"^",6),1:"UNKNOWN"),PSDIV=PSDIV_$E("        ",$L(PSDIV)+1,8)
"RTN","PSORXVW1",79,0)
 .S MW=$S($P(P1,"^",2)="M":"Mail",1:"Window"),MW=MW_$E("          ",$L(MW)+1,10)
"RTN","PSORXVW1",80,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+$P(P1,"^",16) D ^DIC
"RTN","PSORXVW1",81,0)
 .S ^TMP("PSOAL",$J,IEN,0)=^TMP("PSOAL",$J,IEN,0)_MW_"  "_$P(P1,"^",6)_$E("            ",$L($P(P1,"^",6))+1,10)_$E($S(+Y:$P(Y,"^",2),1:""),1,16)
"RTN","PSORXVW1",82,0)
 .S RTS=$S($P(P1,"^",16):" RETURNED TO STOCK: "_$E($P(P1,"^",16),4,5)_"/"_$E($P(P1,"^",16),6,7)_"/"_$E($P(P1,"^",16),2,3),1:" RELEASED: "_$S($P(P1,"^",19):$E($P(P1,"^",19),4,5)_"/"_$E($P(P1,"^",19),6,7)_"/"_$E($P(P1,"^",19),2,3),1:""))
"RTN","PSORXVW1",83,0)
 .K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=$P(P1,"^",7) D ^DIC
"RTN","PSORXVW1",84,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Division: "_PSDIV_" "_RTS ;_"      Entry By: "_$P(Y,"^",2) K DIC,X,Y
"RTN","PSORXVW1",85,0)
 .S:$P(P1,"^",3)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="  REMARKS: "_$P(P1,"^",3) K RTS
"RTN","PSORXVW1",86,0)
 Q
"RTN","PSORXVW1",87,0)
HLD ;hold info
"RTN","PSORXVW1",88,0)
 S DTT=$P(^PSRX(DA,"H"),"^",3) D DAT S HLDR=$P(^DD(52,99,0),"^",3),HLDR=$S($P(^PSRX(DA,"H"),"^")'>6:$P(HLDR,";",$P(^PSRX(DA,"H"),"^")),1:$P(HLDR,";",7)),HLDR=$P(HLDR,":",2)
"RTN","PSORXVW1",89,0)
 S $P(RN," ",60)=" ",IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Hold Reason: "_HLDR_$E(RN,$L("Hold Reason: "_HLDR)+1,60)_"Hold Date: "_DAT S:$P(^PSRX(DA,"H"),"^",2)]"" IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="Hold Comments: "_$P(^PSRX(DA,"H"),"^",2)
"RTN","PSORXVW1",90,0)
 K RN,DAT,DTT,HLDR
"RTN","PSORXVW1",91,0)
 Q
"RTN","PSORXVW1",92,0)
DAT S DAT="",DTT=DTT\1 Q:DTT'?7N  S DAT=$E(DTT,4,5)_"/"_$E(DTT,6,7)_"/"_$E(DTT,2,3)
"RTN","PSORXVW1",93,0)
 Q
"RTN","PSORXVW1",94,0)
INST ;formats instruction from front door
"RTN","PSORXVW1",95,0)
 I $O(^PSRX(DA,"PI",0)) D
"RTN","PSORXVW1",96,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="        Instructions:"
"RTN","PSORXVW1",97,0)
 .S T=0 F  S T=$O(^PSRX(DA,"PI",T)) Q:'T  S MIG=^PSRX(DA,"PI",T,0) D
"RTN","PSORXVW1",98,0)
 ..F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOAL",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",21)=" " S ^TMP("PSOAL",$J,IEN,0)=$G(^TMP("PSOAL",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSORXVW1",99,0)
 K T,TY,MIG,SG
"RTN","PSORXVW1",100,0)
 Q
"RTN","PSORXVW1",101,0)
PC ;displays provider comments
"RTN","PSORXVW1",102,0)
 I $O(^PSRX(DA,"PRC",0)) D
"RTN","PSORXVW1",103,0)
 .S IEN=IEN+1,^TMP("PSOAL",$J,IEN,0)="   Provider Comments:"
"RTN","PSORXVW1",104,0)
 .S T=0 F  S T=$O(^PSRX(DA,"PRC",T)) Q:'T  S MIG=^PSRX(DA,"PRC",T,0) D
"RTN","PSORXVW1",105,0)
 ..F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOAL",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOAL",$J,IEN,0)," ",21)=" " S ^TMP("PSOAL",$J,IEN,0)=$G(^TMP("PSOAL",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSORXVW1",106,0)
 K T,TY,MIG,SG
"RTN","PSORXVW1",107,0)
 Q
"RTN","PSORXVW1",108,0)
DOSE ;displays dosing instruction for both simple and complex Rxs.
"RTN","PSORXVW1",109,0)
 D DOSE^PSORXVW2
"RTN","PSORXVW1",110,0)
 Q
"VER")
8.0^22.0
**END**
**END**
