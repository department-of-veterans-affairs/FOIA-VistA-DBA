Released ECX*3*10 SEQ #8
Extracted from mail message
**KIDS**:ECX*3.0*10^

**INSTALL NAME**
ECX*3.0*10
"BLD",1380,0)
ECX*3.0*10^DSS EXTRACTS^0^2980804^y
"BLD",1380,1,0)
^^1^1^2980804^
"BLD",1380,1,1,0)
Use API distributed with NDF v4.0 for Pharmacy Feeder Keys.
"BLD",1380,4,0)
^9.64PA^^
"BLD",1380,"ABPKG")
n
"BLD",1380,"KRN",0)
^9.67PA^19^18
"BLD",1380,"KRN",.4,0)
.4
"BLD",1380,"KRN",.401,0)
.401
"BLD",1380,"KRN",.402,0)
.402
"BLD",1380,"KRN",.403,0)
.403
"BLD",1380,"KRN",.5,0)
.5
"BLD",1380,"KRN",.84,0)
.84
"BLD",1380,"KRN",3.6,0)
3.6
"BLD",1380,"KRN",3.8,0)
3.8
"BLD",1380,"KRN",9.2,0)
9.2
"BLD",1380,"KRN",9.8,0)
9.8
"BLD",1380,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",1380,"KRN",9.8,"NM",1,0)
ECXFEKEY^^0^B47242689
"BLD",1380,"KRN",9.8,"NM",2,0)
ECXNDC^^0^B7426307
"BLD",1380,"KRN",9.8,"NM",3,0)
ECXOPRX^^0^B22530203
"BLD",1380,"KRN",9.8,"NM",4,0)
ECXPIVD^^0^B18153698
"BLD",1380,"KRN",9.8,"NM",5,0)
ECXPIVDN^^0^B23956017
"BLD",1380,"KRN",9.8,"NM",6,0)
ECXUD^^0^B10012094
"BLD",1380,"KRN",9.8,"NM","B","ECXFEKEY",1)

"BLD",1380,"KRN",9.8,"NM","B","ECXNDC",2)

"BLD",1380,"KRN",9.8,"NM","B","ECXOPRX",3)

"BLD",1380,"KRN",9.8,"NM","B","ECXPIVD",4)

"BLD",1380,"KRN",9.8,"NM","B","ECXPIVDN",5)

"BLD",1380,"KRN",9.8,"NM","B","ECXUD",6)

"BLD",1380,"KRN",19,0)
19
"BLD",1380,"KRN",19.1,0)
19.1
"BLD",1380,"KRN",101,0)
101
"BLD",1380,"KRN",409.61,0)
409.61
"BLD",1380,"KRN",771,0)
771
"BLD",1380,"KRN",869.2,0)
869.2
"BLD",1380,"KRN",870,0)
870
"BLD",1380,"KRN",8994,0)
8994
"BLD",1380,"KRN","B",.4,.4)

"BLD",1380,"KRN","B",.401,.401)

"BLD",1380,"KRN","B",.402,.402)

"BLD",1380,"KRN","B",.403,.403)

"BLD",1380,"KRN","B",.5,.5)

"BLD",1380,"KRN","B",.84,.84)

"BLD",1380,"KRN","B",3.6,3.6)

"BLD",1380,"KRN","B",3.8,3.8)

"BLD",1380,"KRN","B",9.2,9.2)

"BLD",1380,"KRN","B",9.8,9.8)

"BLD",1380,"KRN","B",19,19)

"BLD",1380,"KRN","B",19.1,19.1)

"BLD",1380,"KRN","B",101,101)

"BLD",1380,"KRN","B",409.61,409.61)

"BLD",1380,"KRN","B",771,771)

"BLD",1380,"KRN","B",869.2,869.2)

"BLD",1380,"KRN","B",870,870)

"BLD",1380,"KRN","B",8994,8994)

"BLD",1380,"QUES",0)
^9.62^^
"BLD",1380,"REQB",0)
^9.611^^
"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^2971222^2980112^11714
"PKG",513,22,1,"PAH",1,0)
10^2980804^11714
"PKG",513,22,1,"PAH",1,1,0)
^^1^1^2980914
"PKG",513,22,1,"PAH",1,1,1,0)
Use API distributed with NDF v4.0 for Pharmacy Feeder Keys.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","ECXFEKEY")
0^1^B47242689
"RTN","ECXFEKEY",1,0)
ECXFEKEY ;BIR/DMA,CML-Print Feeder Keys; [ 05/15/96  9:44 AM ]
"RTN","ECXFEKEY",2,0)
 ;;3.0;DSS EXTRACTS;**10**;Dec 22, 1997
"RTN","ECXFEKEY",3,0)
EN ;entry point from option
"RTN","ECXFEKEY",4,0)
 W !!,"Print list of Feeder Keys:",! K ECPHA
"RTN","ECXFEKEY",5,0)
 W !,"Select : 1. CLI",!,?9,"2. DEN",!,?9,"3. ECS",!,?9,"4. LAB",!,?9,"5. NUR",!,?9,"6. PHA",!,?9,"7. RAD",!,?9,"8. SUR",! S DIR(0)="L^1:8" D ^DIR Q:$D(DIRUT)
"RTN","ECXFEKEY",6,0)
 S ECY=Y I Y["6" D
"RTN","ECXFEKEY",7,0)
 .W !!,"The Feeder Key List for the Feeder System PHA can be printed by:",!?5,"(O)ld Feeder Key sort by VA Class",!?5,"(N)ew Feeder Key sort by NDF Match"
"RTN","ECXFEKEY",8,0)
 .S DIR(0)="S^O:OLD;N:NEW",DIR("B")="NEW" D ^DIR K DIR Q:$D(DIRUT)  S ECPHA=Y
"RTN","ECXFEKEY",9,0)
 G:$D(DIRUT) QUIT
"RTN","ECXFEKEY",10,0)
 I ECY["3" D
"RTN","ECXFEKEY",11,0)
 .W !!,"The Feeder Key List for the Feeder System ECS can be printed by:",!?5,"(O)ld Feeder Key sort by Category-Procedure",!?5,"(N)ew Feeder Key sort by Procedure-CPT Code"
"RTN","ECXFEKEY",12,0)
 .S DIR(0)="S^O:OLD;N:NEW",DIR("B")="NEW" D ^DIR K DIR Q:$D(DIRUT)  S ECECS=Y
"RTN","ECXFEKEY",13,0)
 S:ECY["4" ECLAB=$$SELLABKE^ECXFEKE1() ;**Prompt to select Lab Feeder key
"RTN","ECXFEKEY",14,0)
 G:($G(ECLAB)=-1) QUIT ;**GOTO Exit point
"RTN","ECXFEKEY",15,0)
 G:$D(DIRUT) QUIT
"RTN","ECXFEKEY",16,0)
 K %ZIS,IOP S %ZIS="QM",%ZIS("B")="" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!!" G QUIT
"RTN","ECXFEKEY",17,0)
 I $D(IO("Q")) K IO("Q") S ZTRTN="START^ECXFEKEY",ZTDESC="Feeder Key List (DSS)" S ZTSAVE("ECY")="",ZTSAVE("ECPHA")="",ZTSAVE("ECECS")="",ZTSAVE("ECLAB")=""
"RTN","ECXFEKEY",18,0)
 I  D ^%ZTLOAD D HOME^%ZIS K ZTSK G QUIT
"RTN","ECXFEKEY",19,0)
 U IO
"RTN","ECXFEKEY",20,0)
 ;
"RTN","ECXFEKEY",21,0)
START ;queued entry point
"RTN","ECXFEKEY",22,0)
 I '$D(DT) S DT=$$HTFM^XLFDT(+$H)
"RTN","ECXFEKEY",23,0)
 K ^TMP($J)
"RTN","ECXFEKEY",24,0)
 F ECLIST=1:1 S EC=$P(ECY,",",ECLIST) Q:EC=""  D:EC=1 CLI D:EC=2 DEN^ECXFEKE1 D:EC=3 ECS D:EC=4 LAB D:EC=5 NUR D:EC=6 PHA D:EC=7 RAD D:EC=8 SUR^ECXFEKE1
"RTN","ECXFEKEY",25,0)
 G PRINT^ECXFEKE1
"RTN","ECXFEKEY",26,0)
LAB S EC=0
"RTN","ECXFEKEY",27,0)
 ;
"RTN","ECXFEKEY",28,0)
 ;** OLD Feeder Key format
"RTN","ECXFEKEY",29,0)
 I $G(ECLAB)="O" DO
"RTN","ECXFEKEY",30,0)
 .F  S EC=$O(^LAB(60,EC)) Q:'EC  I $D(^(EC,0)) S EC1=$P(^(0),"^"),^TMP($J,"LAB",EC,EC)=EC1
"RTN","ECXFEKEY",31,0)
 ;
"RTN","ECXFEKEY",32,0)
 ;** NEW Feeder key format (LMIP Code)
"RTN","ECXFEKEY",33,0)
 I $G(ECLAB)="N" DO
"RTN","ECXFEKEY",34,0)
 .N EC2
"RTN","ECXFEKEY",35,0)
 .F  S EC=$O(^LAM(EC)) Q:'EC  DO
"RTN","ECXFEKEY",36,0)
 ..I $D(^LAM(EC,0)) DO
"RTN","ECXFEKEY",37,0)
 ...S EC1=$P(^LAM(EC,0),"^",1),EC1=$P(EC1,"~",1)
"RTN","ECXFEKEY",38,0)
 ...S EC2=$P(^LAM(EC,0),"^",2)
"RTN","ECXFEKEY",39,0)
 ...I EC2'[".9999",(EC2'[".8") S EC2=EC2\1
"RTN","ECXFEKEY",40,0)
 ...S ^TMP($J,"LAB",+EC2,+EC2)=EC1
"RTN","ECXFEKEY",41,0)
 Q
"RTN","ECXFEKEY",42,0)
ECS ;old ECS feeder key list for pre-FY97 data
"RTN","ECXFEKEY",43,0)
 G:$G(ECECS)="N" ECS2
"RTN","ECXFEKEY",44,0)
 S EC=0 I $P($G(^EC(720.1,1,0)),"^",2) D  G ECQ
"RTN","ECXFEKEY",45,0)
 .F  S EC=$O(^ECJ(EC)) Q:'EC  I $D(^(EC,0)) D
"RTN","ECXFEKEY",46,0)
 ..S EC1=$P($P(^(0),"^"),"-",3,4),EC2=$P(EC1,"-"),EC2=$S(+EC2:EC2,1:"***"),EC4=$S($P($G(^EC(726,+EC2,0)),"^")]"":$P(^(0),"^"),1:"***")
"RTN","ECXFEKEY",47,0)
 ..S EC3=$P(EC1,"-",2) Q:'+EC3  S EC3=$S(EC3["ICPT":$P($G(^ICPT(+EC3,0)),"^"),+EC3<90000:$P($G(^EC(725,+EC3,0)),"^",2)_"N",1:$P($G(^EC(725,+EC3,0)),"^",2)_"L")
"RTN","ECXFEKEY",48,0)
 ..S EC5=$P(EC1,"-",2),EC5=$S(EC5["ICPT":$E($P($G(^ICPT(+EC5,0)),"^",2),1,25),EC5["EC":$E($P($G(^EC(725,+EC5,0)),"^"),1,25),1:"UNKNOWN")
"RTN","ECXFEKEY",49,0)
 ..S ^TMP($J,"ECS",EC2_" - "_EC3,EC3)=EC4_" - "_EC5
"RTN","ECXFEKEY",50,0)
 F  S EC=$O(^ECK(EC)) Q:'EC  I $D(^(EC,0)) S EC1=$P($P(^(0),"^"),"-",3,4),EC2=$E($P($G(^ECP(+EC1,0)),"^"),1,25),EC3=$E($P($G(^ECP(+$P(EC1,"-",2),0)),"^"),1,25),^TMP($J,"ECS",EC1,EC1)=EC2_" - "_EC3
"RTN","ECXFEKEY",51,0)
ECQ K EC1,EC2,EC3,EC4,EC5,EC6,EC7,EC8,EC9,EC10 Q
"RTN","ECXFEKEY",52,0)
ECS2 ;new ECS feeder key list for FY97 data
"RTN","ECXFEKEY",53,0)
 ;feeder key is <Procedure> if PCE CPT code is same or null;
"RTN","ECXFEKEY",54,0)
 ;feeder is <Procedure-PCE CPT> otherwise;
"RTN","ECXFEKEY",55,0)
 ;the description column of list shows procedure (EC5) in lowercase and CPT code (EC8) in uppercase;
"RTN","ECXFEKEY",56,0)
 ;but if procedure (EC3) is itself a CPT Code, convert EC5 to uppercase
"RTN","ECXFEKEY",57,0)
 ;concatenation of "A;" and "B;" are for proper sorting - CPT codes 1st, then other procedures
"RTN","ECXFEKEY",58,0)
 S EC=0 I $P($G(^EC(720.1,1,0)),"^",2) D  G ECQ
"RTN","ECXFEKEY",59,0)
 .F  S EC=$O(^ECJ(EC)) Q:'EC  I $D(^ECJ(EC,0)) D
"RTN","ECXFEKEY",60,0)
 ..S EC1=$P($P(^ECJ(EC,0),"^"),"-",3,4)
"RTN","ECXFEKEY",61,0)
 ..S EC3=$P(EC1,"-",2) Q:'+EC3  S EC3=$S(EC3["ICPT":$P($G(^ICPT(+EC3,0)),"^"),+EC3<90000:$P($G(^EC(725,+EC3,0)),"^",2)_"N",1:$P($G(^EC(725,+EC3,0)),"^",2)_"L")
"RTN","ECXFEKEY",62,0)
 ..S EC5=$P(EC1,"-",2),EC5=$S(EC5["ICPT":$E($P($G(^ICPT(+EC5,0)),"^",2),1,25),EC5["EC":$E($P($G(^EC(725,+EC5,0)),"^"),1,25),1:"UNKNOWN")
"RTN","ECXFEKEY",63,0)
 ..S EC5=$$LOW(EC5)
"RTN","ECXFEKEY",64,0)
 ..I EC1["ICPT" S EC5=$$UPP(EC5),EC3="A;"_EC3
"RTN","ECXFEKEY",65,0)
 ..S EC6=$P(EC1,"-",2),EC7="",EC8=""
"RTN","ECXFEKEY",66,0)
 ..I EC6["EC(725," D
"RTN","ECXFEKEY",67,0)
 ...S EC6=$S(+EC6>0:$P($G(^EC(725,+EC6,0)),"^",5),1:"") S EC7=$S(+EC6>0:$P($G(^ICPT(+EC6,0)),"^"),1:"")
"RTN","ECXFEKEY",68,0)
 ...S EC8=$S(+EC6>0:$E($P($G(^ICPT(+EC6,0)),"^",2),1,25),1:"")
"RTN","ECXFEKEY",69,0)
 ...S EC8=$$UPP(EC8),EC3="B;"_EC3
"RTN","ECXFEKEY",70,0)
 ..S EC9=$S(EC7'="":EC3_"-"_EC7,1:EC3),EC10=$S(EC8'="":EC5_" - "_EC8,1:EC5)
"RTN","ECXFEKEY",71,0)
 ..S ^TMP($J,"ECS",EC9,EC3)=EC10
"RTN","ECXFEKEY",72,0)
 G ECQ
"RTN","ECXFEKEY",73,0)
LOW(X) ;convert string to lowercase
"RTN","ECXFEKEY",74,0)
 F %=2:1:$L(X) I $E(X,%)?1U,$E(X,%-1)?1A S X=$E(X,0,%-1)_$C($A(X,%)+32)_$E(X,%+1,999)
"RTN","ECXFEKEY",75,0)
 Q X
"RTN","ECXFEKEY",76,0)
UPP(X) ;convert string to uppercase
"RTN","ECXFEKEY",77,0)
 F %=1:1:$L(X) S:$E(X,%)?1L X=$E(X,0,%-1)_$C($A(X,%)-32)_$E(X,%+1,999)
"RTN","ECXFEKEY",78,0)
 Q X
"RTN","ECXFEKEY",79,0)
 ;
"RTN","ECXFEKEY",80,0)
PHA ; feeder system for all pharmacy extracts is PHA
"RTN","ECXFEKEY",81,0)
 G:$G(ECPHA)="N" PHA2
"RTN","ECXFEKEY",82,0)
 S EC=0 F  S EC=$O(^PSDRUG(EC)) Q:'EC  I $D(^(EC,0)) S ECD=$P(^(0),"^"),EC1=$P(^(0),"^",2),EC2=$P($G(^(2)),"^",4),EC3=$$RJ^XLFSTR($P(EC2,"-"),6,0)_$$RJ^XLFSTR($P(EC2,"-",2),4,0)_$$RJ^XLFSTR($P(EC2,"-",3),2,0),EC3=$TR(EC3,"*","0") D
"RTN","ECXFEKEY",83,0)
 .S:EC1="" EC1="ZZ999" S:EC3="000000000000" EC3="999999999999"
"RTN","ECXFEKEY",84,0)
 .S ^TMP($J,"PHA",EC1_EC3,EC)=ECD
"RTN","ECXFEKEY",85,0)
 Q
"RTN","ECXFEKEY",86,0)
PHA2 ;NEW PHA Feeder Key List sorted by NDF Match
"RTN","ECXFEKEY",87,0)
 S ECXYM=$$ECXYM^ECXUTL(DT)
"RTN","ECXFEKEY",88,0)
 S EC=0 F  S EC=$O(^PSDRUG(EC)) Q:'EC  I $D(^PSDRUG(EC,0)) D
"RTN","ECXFEKEY",89,0)
 .S ECD=$P(^PSDRUG(EC,0),"^"),ECNDC=$P($G(^PSDRUG(EC,2)),"^",4),ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXFEKEY",90,0)
 .S ECNDF=$G(^PSDRUG(EC,"ND")),P1=$P(ECNDF,"^"),P3=$P(ECNDF,"^",3)
"RTN","ECXFEKEY",91,0)
 .S X="PSNAPIS" X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXFEKEY",92,0)
 .I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXFEKEY",93,0)
 .S ^TMP($J,"PHA",ECNFC,EC)=ECD
"RTN","ECXFEKEY",94,0)
 Q
"RTN","ECXFEKEY",95,0)
CLI S SC=0 F  S SC=$O(^SC(SC)) Q:'SC  I $D(^(SC,0)) S EC=^(0),ECD=$P(EC,"^") I $P(EC,"^",3)="C" D  S ^TMP($J,"CLI","A;"_P1_P2_ECLEN_P3_"0",SC)=ECD
"RTN","ECXFEKEY",96,0)
 .S ECSC=$P($G(^DIC(40.7,+$P(EC,"^",7),0)),"^",2),ECCSC=$P($G(^DIC(40.7,+$P(EC,"^",18),0)),"^",2)
"RTN","ECXFEKEY",97,0)
 .S ECLEN="NNN" I $D(^SC(SC,"SL")),$P(^("SL"),"^",2)'="V" S ECLEN=$S($P(^("SL"),"^"):$P(^("SL"),"^"),1:"NNN"),ECLEN=$E("000"_ECLEN,$L(ECLEN)+1,$L(ECLEN)+3)
"RTN","ECXFEKEY",98,0)
 .S (P1,P2)="000",P3="0000" I '$D(^ECX(728.44,SC,0)),ECCSC]"" S ECST=5,P1=$E("000"_ECSC,$L(ECSC)+1,$L(ECSC)+3),P2=$E("000"_ECCSC,$L(ECCSC)+1,$L(ECCSC)+3) Q
"RTN","ECXFEKEY",99,0)
 .I '$D(^ECX(728.44,SC,0)) S ECST=1,P1=$E("000"_ECSC,$L(ECSC)+1,$L(ECSC)+3) Q
"RTN","ECXFEKEY",100,0)
 .S EC=^ECX(728.44,SC,0),ECST=$P(EC,"^",6)
"RTN","ECXFEKEY",101,0)
 .I ECST=6 Q
"RTN","ECXFEKEY",102,0)
 .;action code 6 means ignore
"RTN","ECXFEKEY",103,0)
 .I $P(EC,"^",4)]"" S ECSC=$P(EC,"^",4)
"RTN","ECXFEKEY",104,0)
 .I $P(EC,"^",5)]"" S ECCSC=$P(EC,"^",5)
"RTN","ECXFEKEY",105,0)
 .I ECST="" S ECST=4,P1=$E("000"_ECSC,$L(ECSC)+1,$L(ECSC)+3),P3=$E("0000"_SC,$L(SC)+1,$L(SC)+4) S:ECCSC P2=$E("000"_ECCSC,$L(ECCSC)+1,$L(ECCSC)+3) Q
"RTN","ECXFEKEY",106,0)
 .I ECST<2 S P1=ECSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3) Q
"RTN","ECXFEKEY",107,0)
 .I ECST=2 S P1=ECCSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3) Q
"RTN","ECXFEKEY",108,0)
 .I ECST=3 S P1=ECSC,P11=ECCSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3),P11=$E("000"_P11,$L(P11)+1,$L(P11)+3) Q
"RTN","ECXFEKEY",109,0)
 .I ECST>3,ECST<7 S P1=ECSC,P2=ECCSC,P1=$E("000"_P1,$L(P1)+1,$L(P1)+3),P2=$E("000"_P2,$L(P2)+1,$L(P2)+3) S:ECST=4 P3=$P($G(^ECX(728.441,+$P(^ECX(728.44,SC,0),"^",8),0)),"^") I P3="" S P3=$E("0000"_SC,$L(SC)+1,$L(SC)+4)
"RTN","ECXFEKEY",110,0)
 K ECLEN Q
"RTN","ECXFEKEY",111,0)
RAD S EC=0 F  S EC=$O(^RAMIS(71,EC)) Q:'EC  I $D(^(EC,0)) S EC1=^(0),ECD=$P(EC1,"^"),EC2=$P($G(^ICPT(+$P(EC1,"^",9),0)),"^") S:EC2="" EC2="Unknown" S ^TMP($J,"RAD",EC2,EC)=ECD
"RTN","ECXFEKEY",112,0)
 S ^TMP($J,"RAD",88888,88888)="Portable procedure",^TMP($J,"RAD",99999,99999)="OR procedure"
"RTN","ECXFEKEY",113,0)
 Q
"RTN","ECXFEKEY",114,0)
NUR F EC=1:1:11 S EC1=$P($T(@EC),";",3) F EC2=0:1:5 S ^TMP($J,"NUR",$P(EC1,"^")_"-"_EC2,EC2)=$P(EC1,"^",2)_" LEVEL "_EC2
"RTN","ECXFEKEY",115,0)
1 ;;PSI^PSYCHIATRIC
"RTN","ECXFEKEY",116,0)
2 ;;SUR^SURGICAL
"RTN","ECXFEKEY",117,0)
3 ;;MED^MEDICAL (EXCLUDE SCI)
"RTN","ECXFEKEY",118,0)
4 ;;SCI^MEDICAL (SCI)
"RTN","ECXFEKEY",119,0)
5 ;;NUR^NURSING HOME CARE UNIT
"RTN","ECXFEKEY",120,0)
6 ;;REC^RECOVERY ROOM
"RTN","ECXFEKEY",121,0)
7 ;;ITN^INTENSIVE CARE
"RTN","ECXFEKEY",122,0)
8 ;;HEM^HEMODIALYSIS
"RTN","ECXFEKEY",123,0)
9 ;;INT^INTERMEDIATE CARE
"RTN","ECXFEKEY",124,0)
10 ;;DOM^DOMICILIARY
"RTN","ECXFEKEY",125,0)
11 ;;ALC^ALCOHOL AND DRUG TREATMENT
"RTN","ECXFEKEY",126,0)
 Q
"RTN","ECXFEKEY",127,0)
QUIT ;
"RTN","ECXFEKEY",128,0)
 K ECY,ECPHA,ECECS,ECLAB,DIR,DIRUT,DUOUT,X,Y
"RTN","ECXFEKEY",129,0)
 Q
"RTN","ECXNDC")
0^2^B7426307
"RTN","ECXNDC",1,0)
ECXNDC ;BIR/CML-Lookup Routine for NDC's ; [ 08/29/96  2:16 PM ]
"RTN","ECXNDC",2,0)
 ;;3.0;DSS EXTRACTS;**10**;Dec 22, 1997
"RTN","ECXNDC",3,0)
EN ;entry point from option
"RTN","ECXNDC",4,0)
 N F5068
"RTN","ECXNDC",5,0)
 S F5068=0
"RTN","ECXNDC",6,0)
 S X="PSNAPIS" X ^%ZOSF("TEST") I $T S F5068=1
"RTN","ECXNDC",7,0)
 W !!,"Pharmacy Feeder Keys for DSS are built in the following manner:"
"RTN","ECXNDC",8,0)
 I 'F5068 D
"RTN","ECXNDC",9,0)
 .W !!,"Ex. ""0016006000003073531""   where characters:"
"RTN","ECXNDC",10,0)
 .W !!,"1-4 (0016) = pointer to the NATIONAL DRUG file (#50.6)"
"RTN","ECXNDC",11,0)
 .W !,"5-7 (006) = pointer to VA PRODUCT NAME subfile (#50.68) of the NATIONAL DRUG file (#50.6)"
"RTN","ECXNDC",12,0)
 .W !,"8-19 (000003073531) = NDC from the local DRUG file (#50)"
"RTN","ECXNDC",13,0)
 I F5068 D
"RTN","ECXNDC",14,0)
 .W !!,"Ex. ""12006000003073531""   where characters:"
"RTN","ECXNDC",15,0)
 .W !,"1-5 (12006) = pointer to VA PRODUCT NAME file (#50.68)"
"RTN","ECXNDC",16,0)
 .W !,"6-17 (000003073531) = NDC from the local DRUG file (#50)"
"RTN","ECXNDC",17,0)
 W !!,"This option will allow lookups on the local DRUG file (#50) using NDCs",!,"from DSS Pharmacy Feeder Keys that have been rejected because the 1st"
"RTN","ECXNDC",18,0)
 W !,"seven characters are zeros (Ex. ""0000000000003073531"").  This would occur",!,"when a pharmacy item has not been matched to NDF.  To use this option,"
"RTN","ECXNDC",19,0)
 W !,"please enter the NDC (last twelve characters) from a rejected feeder key. ",!,"This will display the following information from the local DRUG file"
"RTN","ECXNDC",20,0)
 W !,"(#50): LOCAL GENERIC NAME, DISPENSE UNIT, and PRICE PER DISPENSE UNIT."
"RTN","ECXNDC",21,0)
ASK W ! S DIC=50,DIC(0)="QEA",D="NDC",DIC("A")="Select NDC: " D MIX^DIC1 K DIC G:Y<0 QUIT S DRG=+Y
"RTN","ECXNDC",22,0)
 K LN S DRGNM=$P(^PSDRUG(DRG,0),"^"),$P(LN,"-",$L(DRGNM)+1)="",ECD=$G(^PSDRUG(DRG,660))
"RTN","ECXNDC",23,0)
 W @IOF,!!,DRGNM,!,LN,!,"Dispense Unit          : ",$P(ECD,"^",8),!,"Price per Dispense Unit: ",$P(ECD,"^",6) G ASK
"RTN","ECXNDC",24,0)
QUIT K %,%H,%Y,DRG,DRGNM,ECD,LN,POP,X,Y
"RTN","ECXNDC",25,0)
 Q
"RTN","ECXOPRX")
0^3^B22530203
"RTN","ECXOPRX",1,0)
ECXOPRX ;BIR/DMA,CML,PTD-Prescription Extract for DSS ; [ 03/26/97  2:09 PM ]
"RTN","ECXOPRX",2,0)
 ;;3.0;DSS EXTRACTS;**10**;Dec 22, 1997
"RTN","ECXOPRX",3,0)
 ;
"RTN","ECXOPRX",4,0)
BEG ;entry point from option
"RTN","ECXOPRX",5,0)
 D SETUP,^ECXTRAC
"RTN","ECXOPRX",6,0)
 D ^ECXKILL
"RTN","ECXOPRX",7,0)
 Q
"RTN","ECXOPRX",8,0)
START ;entry when queued
"RTN","ECXOPRX",9,0)
 S QFLG=0
"RTN","ECXOPRX",10,0)
 I '$D(ECINST) D
"RTN","ECXOPRX",11,0)
 .S ECINST=+$P(^ECX(728,1,0),"^") K ECXDIC S DA=ECINST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXOPRX",12,0)
 .D EN^DIQ1 S ECINST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXOPRX",13,0)
 S ECPROF=6 ;before V6
"RTN","ECXOPRX",14,0)
 S ECD=$O(^PSRX("AL",0)) I ECD,ECD<ECSD1 G V6
"RTN","ECXOPRX",15,0)
 S ECED=ECED+.3,ECREF=1,ECD=ECSD1
"RTN","ECXOPRX",16,0)
 F  S ECD=$O(^PSRX("AD",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  F  S ECRX=$O(^PSRX("AD",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AD",ECD,ECRX,ECRFL)) Q:ECRFL=""  D STUFF Q:QFLG
"RTN","ECXOPRX",17,0)
 Q
"RTN","ECXOPRX",18,0)
 ;
"RTN","ECXOPRX",19,0)
V6 S ECPROF=2 ; version 6 or better
"RTN","ECXOPRX",20,0)
 S ECED=ECED+.3,ECREF=1,ECD=ECSD1 F  S ECD=$O(^PSRX("AL",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  F  S ECRX=$O(^PSRX("AL",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AL",ECD,ECRX,ECRFL)) Q:ECRFL=""  D STUFF Q:QFLG
"RTN","ECXOPRX",21,0)
 S ECREF="P",ECD=ECSD1 F  S ECD=$O(^PSRX("AM",ECD)),ECRX=0 Q:'ECD  Q:ECD>ECED  F  S ECRX=$O(^PSRX("AM",ECD,ECRX)),ECRFL="" Q:'ECRX  F  S ECRFL=$O(^PSRX("AM",ECD,ECRX,ECRFL)) Q:ECRFL=""  D STUFF Q:QFLG
"RTN","ECXOPRX",22,0)
 Q
"RTN","ECXOPRX",23,0)
 ;
"RTN","ECXOPRX",24,0)
STUFF ;
"RTN","ECXOPRX",25,0)
 S ECTM=$$ECXTIME^ECXUTL(ECD),ECDATA=^PSRX(ECRX,0) I ECRFL S ECDATA1=$G(^PSRX(ECRX,ECREF,ECRFL,0)) I ECDATA1="" Q
"RTN","ECXOPRX",26,0)
 ;ecref set to 1 in extract+5 and v6+1 and to "P" in v6+2
"RTN","ECXOPRX",27,0)
 ;refill nodes and partial nodes are identical in layout
"RTN","ECXOPRX",28,0)
 ;fills and refills from the "AL" cross-reference, partials from the "AM"
"RTN","ECXOPRX",29,0)
 S ECDFN=$P(ECDATA,"^",2),ECPRO=ECPROF_$P(ECDATA,"^",4),ECPRC=$P(ECDATA,"^",17),ECDRG=+$P(ECDATA,"^",6) Q:'$D(^DPT(+ECDFN,0))  S SSN=$P(^(0),"^",9),ECPT=$E($P($P(^(0),"^"),",")_"    ",1,4) D INP
"RTN","ECXOPRX",30,0)
 S DOB=$$ECXDOB^ECXUTL($P(^DPT(ECDFN,0),"^",3)),VET=$P($G(^("VET")),"^"),D1=$P($G(^DIC(8,+$G(^DPT(ECDFN,.36)),0)),"^",9) I D1 S D1=$C(D1+64)
"RTN","ECXOPRX",31,0)
 I $T(OUTPTPR^SDUTL3)[",SCDATE" D
"RTN","ECXOPRX",32,0)
 .S ECPTTM=+$$OUTPTTM^SDUTL3(ECDFN,ECD) S:ECPTTM=0 ECPTTM="" S ECPTPR=+$$OUTPTPR^SDUTL3(ECDFN,ECD) S:ECPTPR=0 ECPTPR=""
"RTN","ECXOPRX",33,0)
 I $T(OUTPTPR^SDUTL3)'[",SCDATE" D
"RTN","ECXOPRX",34,0)
 .S ECPTTM=+$$OUTPTTM^SDUTL3(ECDFN) S:ECPTTM=0 ECPTTM="" S ECPTPR=+$$OUTPTPR^SDUTL3(ECDFN) S:ECPTPR=0 ECPTPR=""
"RTN","ECXOPRX",35,0)
 I 'ECRFL S ECMW=$P(ECDATA,"^",11),ECQTY=+$P(ECDATA,"^",7),ECDIV=$S($D(^PSRX(ECRX,2)):$P(^(2),"^",9),1:1),ECOPAY=$P($G(^PSRX(ECRX,"IB")),"^",2)]""
"RTN","ECXOPRX",36,0)
 E  S ECMW=$P(ECDATA1,"^",2),ECQTY=+$P(ECDATA1,"^",4),ECDIV=$S(+$P(ECDATA1,"^",9):$P(ECDATA1,"^",9),1:1),ECPRC=+$P(ECDATA1,"^",11),ECOPAY=$P($G(^PSRX(ECRX,1,ECRFL,"IB")),"^")]"" D
"RTN","ECXOPRX",37,0)
 .S:$P(ECDATA1,"^",17)]"" ECPRO=ECPROF_$P(ECDATA1,"^",17)
"RTN","ECXOPRX",38,0)
 S ECDS=$S(ECRFL:$P(ECDATA1,"^",10),1:$P(ECDATA,"^",8))
"RTN","ECXOPRX",39,0)
 S ECCAT=$P(^PSDRUG(ECDRG,0),"^",2),ECINV=$P(^(0),"^",3)["I",ECINV=$S(ECINV:"I",1:"")
"RTN","ECXOPRX",40,0)
 S ECUI=$P($G(^PSDRUG(ECDRG,660)),"^",8)
"RTN","ECXOPRX",41,0)
 S ECNDC=$P($G(^PSDRUG(ECDRG,2)),"^",4),ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXOPRX",42,0)
 S ECNDF=$G(^PSDRUG(ECDRG,"ND")),P1=$P(ECNDF,"^"),P3=$P(ECNDF,"^",3)
"RTN","ECXOPRX",43,0)
 S X="PSNAPIS" X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXOPRX",44,0)
 I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXOPRX",45,0)
 S ECODE=ECINST_"^"_ECDFN_"^"_SSN_"^"_ECPT_"^"_ECA_"^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^"_ECDIV_"^"_ECPRO_"^"_ECCAT_"^^^^^"_ECQTY_"^"_(ECQTY*ECPRC)_"^^"_ECMN_"^"_ECTS_"^^"_ECUI_"^"_DOB_"^"_D1_"^"_VET_"^"_ECOPAY_"^"_ECNFC_"^"_ECINV_"^"_ECDS
"RTN","ECXOPRX",46,0)
 I ECMW="M" S $P(ECODE,"^",10)=1 I $D(^PSRX("AR",ECD,ECRX)) S $P(ECODE,"^",10)=2
"RTN","ECXOPRX",47,0)
 I ECRFL=0 S $P(ECODE,"^",12)=1
"RTN","ECXOPRX",48,0)
 S ECODE=ECODE_"^"_ECPTTM_"^"_ECPTPR_"^"_ECTM_"^"_$P($G(^DIC(10,+$P(^DPT(ECDFN,0),"^",6),0)),"^",2)_"^"
"RTN","ECXOPRX",49,0)
 ;inst^dfn^ssn^name^in/out^day^division^provider^drug category^mail^placeholder1^new^placeholder2^qty^cost^placeholder3^
"RTN","ECXOPRX",50,0)
 ;mov #^treat spec^placeholder4^unit of issue^dob^elig^vet^copay^feeder key^investigational^days supply^primary care team^primary care provider^time^race
"RTN","ECXOPRX",51,0)
 S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXOPRX",52,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX(ECFILE," D IX^DIK K DIK,DA
"RTN","ECXOPRX",53,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXOPRX",54,0)
 Q
"RTN","ECXOPRX",55,0)
 ;
"RTN","ECXOPRX",56,0)
SETUP S ECPACK="Prescription",ECPIECE=2,ECRTN="START^ECXOPRX",ECGRP="PRES",ECHEAD="PRE",ECFILE=727.81,ECVER=7
"RTN","ECXOPRX",57,0)
 Q
"RTN","ECXOPRX",58,0)
 ;
"RTN","ECXOPRX",59,0)
INP ; checks for in/outpatient status and gets movement number
"RTN","ECXOPRX",60,0)
 S ECA=1,ECTS="" K VAIP S VAIP("D")=ECD,DFN=+ECDFN D IN5^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXOPRX",61,0)
 K VAIP,VAERR
"RTN","ECXOPRX",62,0)
 Q
"RTN","ECXOPRX",63,0)
 ;
"RTN","ECXOPRX",64,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXOPRX",65,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXPIVD")
0^4^B18153698
"RTN","ECXPIVD",1,0)
ECXPIVD ;BIR/DMA,CML,PTD-Extract from IV STATS File (#50.8) ; [ 12/05/96  10:41 AM ]
"RTN","ECXPIVD",2,0)
 ;;3.0;DSS EXTRACTS;**10**;Dec 22, 1997
"RTN","ECXPIVD",3,0)
BEG ;entry point from option
"RTN","ECXPIVD",4,0)
 D SETUP,^ECXTRAC,^ECXKILL
"RTN","ECXPIVD",5,0)
 Q
"RTN","ECXPIVD",6,0)
 ;
"RTN","ECXPIVD",7,0)
START ; start package specific extract
"RTN","ECXPIVD",8,0)
 S QFLG=0
"RTN","ECXPIVD",9,0)
 S ECED=ECED+.3
"RTN","ECXPIVD",10,0)
 K ^TMP($J)
"RTN","ECXPIVD",11,0)
 S ECIV=0 F  S ECIV=$O(^PS(50.8,ECIV)),ECD=ECSD1 Q:'ECIV  F  S ECD=$O(^PS(50.8,ECIV,2,ECD)) Q:'ECD  Q:ECD>ECED  K ^TMP($J) D  Q:QFLG
"RTN","ECXPIVD",12,0)
 .;go thru AC crossreference to get pointers to 52.6 and 52.7
"RTN","ECXPIVD",13,0)
 .F ECJ=52.6,52.7 S ECK=0 F  S ECK=$O(^PS(50.8,ECIV,2,ECD,2,"AC",ECJ,ECK)),ECL=0 Q:'ECK  F   S ECL=$O(^PS(50.8,ECIV,2,ECD,2,"AC",ECJ,ECK,ECL)) Q:'ECL  S ^TMP($J,ECL,ECK)=""
"RTN","ECXPIVD",14,0)
 .S ECI=0 F  S ECI=$O(^PS(50.8,ECIV,2,ECD,2,ECI)) Q:'ECI  I $D(^(ECI,0)) S ECC=$P(^(0),"^",5),ECF=+$P(^(0),"^",7),ECDRG=+$O(^TMP($J,ECI,0)),EC50=+$P($G(^PS(ECF,ECDRG,0)),"^",2) D  Q:QFLG
"RTN","ECXPIVD",15,0)
 ..S ECCAT=$P($G(^PSDRUG(EC50,0)),"^",2),ECNDC=$P($G(^(2)),"^",4),ECNDF=$G(^("ND")),ECINV=$P(^(0),"^",3),ECINV=$S(ECINV["I":"I",1:"")
"RTN","ECXPIVD",16,0)
 ..S ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXPIVD",17,0)
 ..S P1=$P(ECNDF,"^"),P3=$P(ECNDF,"^",3)
"RTN","ECXPIVD",18,0)
 ..S X="PSNAPIS" X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXPIVD",19,0)
 ..I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXPIVD",20,0)
 ..S ECDFN=0 F  S ECDFN=$O(^PS(50.8,ECIV,2,ECD,2,ECI,1,ECDFN)) Q:'ECDFN  I $D(^(ECDFN,0)) S EC=^(0),ECQ=$P(EC,"^",2)-$P(EC,"^",3)-$P(EC,"^",6),ECCS=ECQ*ECC,ECW=$P(EC,"^",5) I ECQ D  Q:QFLG
"RTN","ECXPIVD",21,0)
 ...I $D(^DPT(ECDFN,0)) S EC1=^(0),ECODE=ECINST_"^"_ECDFN_"^"_$P(EC1,"^",9)_"^"_$E($P($P(EC1,"^"),",")_"    ",1,4)_"^"_$S(ECW=.5:1,1:3)_"^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^"_ECCAT_"^"_ECQ,(ECWD,ECMN,ECTS,ECADM)="" D
"RTN","ECXPIVD",22,0)
 ....I $T(OUTPTPR^SDUTL3)[",SCDATE" D
"RTN","ECXPIVD",23,0)
 .....S ECPTTM=+$$OUTPTTM^SDUTL3(ECDFN,ECD) S:ECPTTM=0 ECPTTM="" S ECPTPR=+$$OUTPTPR^SDUTL3(ECDFN,ECD) S:ECPTPR=0 ECPTPR=""
"RTN","ECXPIVD",24,0)
 ....I $T(OUTPTPR^SDUTL3)'[",SCDATE" D
"RTN","ECXPIVD",25,0)
 .....S ECPTTM=+$$OUTPTTM^SDUTL3(ECDFN) S:ECPTTM=0 ECPTTM="" S ECPTPR=+$$OUTPTPR^SDUTL3(ECDFN) S:ECPTPR=0 ECPTPR=""
"RTN","ECXPIVD",26,0)
 ....I ECW=.5 S ECWD="CLI"
"RTN","ECXPIVD",27,0)
 ....E  S ECWD=$P($G(^DIC(42,+ECW,44)),"^") K VAIP S VAIP("D")=ECD,DFN=ECDFN D IN5^VADPT S ECMN=VAIP(1),ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2) S:+VAIP(13) ECADM=$P(^DGPM(+VAIP(13),0),"^") K VAIP
"RTN","ECXPIVD",28,0)
 ....S ECODE=ECODE_"^"_ECWD_"^"_ECCS_"^"_ECMN_"^"_ECTS_"^"_ECNDC_"^"_ECINV_"^^^^"_ECPTTM_"^"_ECPTPR_"^000000^"_$$ECXDATE^ECXUTL(ECADM,ECXYM)_"^"_$$ECXTIME^ECXUTL(ECADM)_"^^"
"RTN","ECXPIVD",29,0)
 ....;if this is an outpatient, send null for admission date and "000000" for admission time
"RTN","ECXPIVD",30,0)
 ....I ECW=.5 S $P(ECODE,"^",21)="",$P(ECODE,"^",22)="000000"
"RTN","ECXPIVD",31,0)
 ....;fac^dfn^ssn^name^i/o^day^va class^qty^ward^cost^movement #^treat spec^ndc^investigational^iv dispensing fee^new feeder key^total doses^primary care team^primary care provider^IVP time^adm date^adm time^dss identifier
"RTN","ECXPIVD",32,0)
 ....S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXPIVD",33,0)
 ....S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXPIVD",34,0)
 ....I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXPIVD",35,0)
 Q
"RTN","ECXPIVD",36,0)
 ;
"RTN","ECXPIVD",37,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXPIVD",38,0)
 S ECPACK="IVs (detail)",ECPIECE=19,ECRTN="START^ECXPIVD",ECGRP="IV",ECHEAD="IVP",ECFILE=727.819,ECVER=3
"RTN","ECXPIVD",39,0)
 Q
"RTN","ECXPIVD",40,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXPIVD",41,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXPIVDN")
0^5^B23956017
"RTN","ECXPIVDN",1,0)
ECXPIVDN ;BIR/DMA,CML,PTD-Extract from IV EXTRACT DATA File (#728.113) ; [ 03/26/97  2:10 PM ]
"RTN","ECXPIVDN",2,0)
 ;;3.0;DSS EXTRACTS;**10**;Dec 22, 1997
"RTN","ECXPIVDN",3,0)
START ; start package specific extract
"RTN","ECXPIVDN",4,0)
 S QFLG=0
"RTN","ECXPIVDN",5,0)
 I '$D(ECINST) D
"RTN","ECXPIVDN",6,0)
 .S ECINST=+$P(^ECX(728,1,0),"^") K ECXDIC S DA=ECINST,DIC="^DIC(4,",DIQ(0)="I",DIQ="ECXDIC",DR=".01;99"
"RTN","ECXPIVDN",7,0)
 .D EN^DIQ1 S ECINST=$G(ECXDIC(4,DA,99,"I")) K DIC,DIQ,DA,DR,ECXDIC
"RTN","ECXPIVDN",8,0)
 S ECED=ECED+.3
"RTN","ECXPIVDN",9,0)
 K ^TMP($J)
"RTN","ECXPIVDN",10,0)
 S ECD=ECSD1
"RTN","ECXPIVDN",11,0)
 F  S ECD=$O(^ECX(728.113,"A",ECD)),DFN=0 Q:'ECD  Q:ECD>ECED  F  S DFN=$O(^ECX(728.113,"A",ECD,DFN)),ON=0  Q:'DFN  I $D(^DPT(DFN,0)) S EC=^(0) D DEMOG F  S ON=$O(^ECX(728.113,"A",ECD,DFN,ON)),DA=0 Q:'ON  K ^TMP($J) S ECVOL=0 D  Q:QFLG
"RTN","ECXPIVDN",12,0)
 .F  S DA=$O(^ECX(728.113,"A",ECD,DFN,ON,DA)) Q:'DA  I $D(^ECX(728.113,DA,0)) S EC=^(0) D  Q:QFLG
"RTN","ECXPIVDN",13,0)
 ..S DRG=$P(EC,"^",4) I $P(EC,"^",8)]"" D
"RTN","ECXPIVDN",14,0)
 ...I '$D(^TMP($J,"A",DRG)) S ^(DRG)=$P(EC,"^",7,8),^(DRG,1)=0,^(2)=$P(EC,"^",12)
"RTN","ECXPIVDN",15,0)
 ...S ^(1)=^TMP($J,"A",DRG,1)+$S($P(EC,"^",6)=1:1,$P(EC,"^",6)=4:0,1:-1)
"RTN","ECXPIVDN",16,0)
 ..I $P(EC,"^",9) D
"RTN","ECXPIVDN",17,0)
 ...I '$D(^TMP($J,"S",DRG)) S ^(DRG)=$P(EC,"^",9)_"^ML",^(DRG,1)=0,^(2)=$P(EC,"^",12),ECVOL=$P(EC,"^",9)+ECVOL
"RTN","ECXPIVDN",18,0)
 ...S ^(1)=^TMP($J,"S",DRG,1)+$S($P(EC,"^",6)=1:1,$P(EC,"^",6)=4:0,1:-1)
"RTN","ECXPIVDN",19,0)
 ..S ECPRO=$P(EC,"^",10),ECTYP=$P(EC,"^",11),ECTOTC=0,ECDTTM=$$ECXTIME^ECXUTL($P(EC,"^",5))
"RTN","ECXPIVDN",20,0)
 .;looped thru all DAs for this order - now put it together
"RTN","ECXPIVDN",21,0)
 .;leave the next line in case the decision is made to send volume designations
"RTN","ECXPIVDN",22,0)
 .;I ECTYP="H" S ECTYP=ECTYP_$S(ECVOL'>1000:1,ECVOL'>2000:2,1:3)
"RTN","ECXPIVDN",23,0)
 .F SA="S","A" S DRG="" F  S DRG=$O(^TMP($J,SA,DRG)) Q:DRG=""  S ECST=^(DRG),CNT=^(DRG,1),COST=^(2),ECTOTC=ECTOTC+COST,COST=COST*CNT I $D(^PSDRUG(DRG,0)) S EC0=^(0),EC2=$G(^(2)),ECND=$G(^("ND")) D  Q:QFLG
"RTN","ECXPIVDN",24,0)
 ..S ECDIV=""
"RTN","ECXPIVDN",25,0)
 ..I ECA=1,$D(^PS(55,DFN,"IV",ON,2)) S ECIVRM=$P(^(2),"^",2),ECDIV=$P(^PS(59.5,ECIVRM,0),"^",4)
"RTN","ECXPIVDN",26,0)
 ..I ECA=3 S ECDIV=$P(^SC(ECW,0),"^",15)
"RTN","ECXPIVDN",27,0)
 ..S ECODE=ECDIV_"^"_DFN_"^"_SSN_"^"_ECNA_"^"_ECA_"^"_$$ECXDATE^ECXUTL(ECD,ECXYM)_"^"_$P(EC0,"^",2)_"^"_CNT_"^"_ECW_"^"_COST_"^"_ECMN_"^"_ECTS_"^"
"RTN","ECXPIVDN",28,0)
 ..S ECINV=$P(EC0,"^",3),ECINV=$S(ECINV["I":"I",1:"")
"RTN","ECXPIVDN",29,0)
 ..S ECST=CNT*ECST_" "_$P(ECST,"^",2)
"RTN","ECXPIVDN",30,0)
 ..S ECNDC=$P(EC2,"^",4),ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXPIVDN",31,0)
 ..S P1=$P(ECND,"^"),P3=$P(ECND,"^",3)
"RTN","ECXPIVDN",32,0)
 ..S X="PSNAPIS" X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXPIVDN",33,0)
 ..I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXPIVDN",34,0)
 ..S ECODE=ECODE_ECNDC_"^"_ECINV_"^"_ECTYP_"^"_ECNFC_"^"_ECST_"^"_ECPTTM_"^"_ECPTPR_"^"_ECDTTM_"^"_$$ECXDATE^ECXUTL(ECADM,ECXYM)_"^"_$$ECXTIME^ECXUTL(ECADM)_"^^"
"RTN","ECXPIVDN",35,0)
 ..;if this is an outpatient, send null for admission date and "000000" for admission time
"RTN","ECXPIVDN",36,0)
 ..I ECA=1 S $P(ECODE,"^",21)="",$P(ECODE,"^",22)="000000"
"RTN","ECXPIVDN",37,0)
 ..;facility^dfn^ssn^name^in/out pat^day^VA class^qty^ward^cost^movement #^treating specialty^ndc^investigational^dispensing fee^new feeder key^total doses per day^primary care team^primary care provider^IVP time^adm date^adm time^dss identifier
"RTN","ECXPIVDN",38,0)
 ..S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXPIVDN",39,0)
 ..S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXPIVDN",40,0)
 ..I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXPIVDN",41,0)
 K ^TMP($J),CNT,COST,DA,DFN,DIC,DIK,DRG,EC,EC0,EC2,EC7,EC8,ECA,ECD,ECDA,ECINV,ECMN,ECNA,ECND,ECNDC,ECNFC,ECPRO,ECST,ECTOTC,ECTS,ECTSR,ECTYP,ECVOL,ECW,ECWR,ON,SA,SSN,X,Y
"RTN","ECXPIVDN",42,0)
 Q
"RTN","ECXPIVDN",43,0)
 ;
"RTN","ECXPIVDN",44,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXPIVDN",45,0)
 S ECPACK="IVs (detail)",ECPIECE=19,ECRTN="START^ECXPIVDN",ECGRP="IV",ECHEAD="IVP",ECFILE=727.819,ECVER=7
"RTN","ECXPIVDN",46,0)
 Q
"RTN","ECXPIVDN",47,0)
 ;
"RTN","ECXPIVDN",48,0)
DEMOG ;new patient - get primary care team and provider, name, SSN, and VAIP
"RTN","ECXPIVDN",49,0)
 I $T(OUTPTPR^SDUTL3)[",SCDATE" D
"RTN","ECXPIVDN",50,0)
 .S ECPTTM=+$$OUTPTTM^SDUTL3(DFN,ECD) S:ECPTTM=0 ECPTTM="" S ECPTPR=+$$OUTPTPR^SDUTL3(DFN,ECD) S:ECPTPR=0 ECPTPR=""
"RTN","ECXPIVDN",51,0)
 I $T(OUTPTPR^SDUTL3)'[",SCDATE" D
"RTN","ECXPIVDN",52,0)
 .S ECPTTM=+$$OUTPTTM^SDUTL3(DFN) S:ECPTTM=0 ECPTTM="" S ECPTPR=+$$OUTPTPR^SDUTL3(DFN) S:ECPTPR=0 ECPTPR=""
"RTN","ECXPIVDN",53,0)
 S SSN=$P(EC,"^",9),ECNA=$E($P($P(EC,"^"),",")_"    ",1,4)
"RTN","ECXPIVDN",54,0)
INP ; checks for in/outpatient status and gets movement number
"RTN","ECXPIVDN",55,0)
 S ECA=1,(ECTS,ECADM)="",ECW=.5,(ECWR,ECTSR)="OUTPATIENT" K VAIP S VAIP("D")=ECD D IN5^VADPT S ECMN=VAIP(1)
"RTN","ECXPIVDN",56,0)
 I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2),ECW=+$G(^DIC(42,+VAIP(5),44)),ECWR=$P(VAIP(5),"^",2),ECTSR=$P(VAIP(8),"^",2)
"RTN","ECXPIVDN",57,0)
 I +VAIP(13) S ECADM=$P(^DGPM(+VAIP(13),0),"^")
"RTN","ECXPIVDN",58,0)
 K VAIP,VAERR
"RTN","ECXPIVDN",59,0)
 Q
"RTN","ECXPIVDN",60,0)
 ;
"RTN","ECXPIVDN",61,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXPIVDN",62,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXUD")
0^6^B10012094
"RTN","ECXUD",1,0)
ECXUD ;BIR/DMA,PTD-Extract from UNIT DOSE EXTRACT DATA File (#728.904) ; 11/01/96 14:35
"RTN","ECXUD",2,0)
 ;;3.0;DSS EXTRACTS;**10**;Dec 22, 1997
"RTN","ECXUD",3,0)
BEG ;entry point from option
"RTN","ECXUD",4,0)
 I '$O(^ECX(728.904,"A",0)) W !,"There are no unit dose orders to extract",!! R X:5 K X Q
"RTN","ECXUD",5,0)
 D SETUP,^ECXTRAC,^ECXKILL
"RTN","ECXUD",6,0)
 Q
"RTN","ECXUD",7,0)
 ;
"RTN","ECXUD",8,0)
START ;start package specific extract
"RTN","ECXUD",9,0)
 S QFLG=0
"RTN","ECXUD",10,0)
 S ECED=ECED+.3
"RTN","ECXUD",11,0)
 F ECD=ECSD1:0 S ECD=$O(^ECX(728.904,"A",ECD)) Q:'ECD  Q:ECD>ECED  F J=0:0 S J=$O(^ECX(728.904,"A",ECD,J)) Q:'J  I $D(^ECX(728.904,J,0)) S DATA=^(0),^(1)=$P(EC23,"^",2),^ECX(728.904,"AC",$P(EC23,"^",2),J)="" D STUFF Q:QFLG
"RTN","ECXUD",12,0)
 Q
"RTN","ECXUD",13,0)
 ;
"RTN","ECXUD",14,0)
STUFF ;
"RTN","ECXUD",15,0)
 S DFN=$P(DATA,"^",2) Q:'$D(^DPT(DFN,0))  S SSN=$P(^(0),"^",9),ECNA=$E($P($P(^(0),"^"),",")_"    ",1,4)
"RTN","ECXUD",16,0)
 S ECPRO=$P(DATA,"^",7),ECPRO=$E($P(ECPRO,";",2))_$P(ECPRO,";")
"RTN","ECXUD",17,0)
 D INP S W=$P(DATA,"^",6),ECDIV=$P($G(^DIC(42,+W,0)),"^",11),W=$P($G(^DIC(42,+W,44)),"^")
"RTN","ECXUD",18,0)
 S ECCAT=$P(^PSDRUG(+$P(DATA,"^",4),0),"^",2),ECINV=$P(^(0),"^",3),ECINV=$S(ECINV["I":"I",1:"")
"RTN","ECXUD",19,0)
 S ECNDC=$P($G(^PSDRUG(+$P(DATA,"^",4),2)),"^",4),ECNDF=$G(^("ND"))
"RTN","ECXUD",20,0)
 S ECNFC=$$RJ^XLFSTR($P(ECNDC,"-"),6,0)_$$RJ^XLFSTR($P(ECNDC,"-",2),4,0)_$$RJ^XLFSTR($P(ECNDC,"-",3),2,0),ECNFC=$TR(ECNFC,"*",0)
"RTN","ECXUD",21,0)
 S P1=$P(ECNDF,"^"),P3=$P(ECNDF,"^",3)
"RTN","ECXUD",22,0)
 S X="PSNAPIS" X ^%ZOSF("TEST") I $T S ECNFC=$$DSS^PSNAPIS(P1,P3,ECXYM)_ECNFC
"RTN","ECXUD",23,0)
 I $L(ECNFC)=12 S ECNFC=$$RJ^XLFSTR(P1,4,0)_$$RJ^XLFSTR(P3,3,0)_ECNFC
"RTN","ECXUD",24,0)
 S ECODE=ECDIV_"^"_DFN_"^"_SSN_"^"_ECNA_"^3^"_$$ECXDATE^ECXUTL($P(DATA,"^",3),ECXYM)_"^"_ECCAT_"^"_$P(DATA,"^",5)_"^"_W_"^"_ECPRO_"^"_$P(DATA,"^",8)_"^"_ECMN_"^"_ECTS
"RTN","ECXUD",25,0)
 S ECODE=ECODE_"^"_ECNDC_"^"_ECNFC_"^"_ECINV_"^"_$E($P($P(DATA,"^",3),".",2)_"000000",1,6)_"^"_$$ECXDATE^ECXUTL(ECADM,ECXYM)_"^"_$$ECXTIME^ECXUTL(ECADM)_"^"
"RTN","ECXUD",26,0)
 ;facility^dfn^ssn^name^in/out^day^drug category^quantity^ward^provider^cost^mov #^treat spec^ndc^new feeder key^investigational^udp time^adm date^adm time
"RTN","ECXUD",27,0)
 S EC7=-$O(^ECX(ECFILE,"AINV","")) F  S EC7=EC7+1 Q:'$D(^ECX(ECFILE,EC7))
"RTN","ECXUD",28,0)
 S ^ECX(ECFILE,EC7,0)=EC7_"^"_EC23_"^"_ECODE,ECRN=ECRN+1 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX^DIK K DIK,DA
"RTN","ECXUD",29,0)
 I $D(ZTQUEUED),(ECRN>499),'(ECRN#500),$$S^%ZTLOAD S QFLG=1
"RTN","ECXUD",30,0)
 Q
"RTN","ECXUD",31,0)
 ;
"RTN","ECXUD",32,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXUD",33,0)
 S ECPACK="Unit Dose",ECPIECE=8,ECRTN="START^ECXUD",ECGRP="UD",ECHEAD="UDP",ECFILE=727.809,ECVER=7
"RTN","ECXUD",34,0)
 S ECSD=$O(^ECX(728.904,"A",0)),ECED=$$FMADD^XLFDT($E(ECSD,1,5)+1+($E(ECSD,4,5)=12*8800)_"01",-1)
"RTN","ECXUD",35,0)
 Q
"RTN","ECXUD",36,0)
INP ; checks for in/outpatient status and gets movement number
"RTN","ECXUD",37,0)
 S ECA=1,(ECTS,ECADM)="" K VAIP S VAIP("D")=ECD D IN5^VADPT S ECMN=VAIP(1) I ECMN S ECA=3,ECTS=$P($G(^DIC(45.7,+VAIP(8),0)),"^",2)
"RTN","ECXUD",38,0)
 I +VAIP(13) S ECADM=$P(^DGPM(+VAIP(13),0),"^")
"RTN","ECXUD",39,0)
 K VAIP,VAERR
"RTN","ECXUD",40,0)
 Q
"RTN","ECXUD",41,0)
 ;
"RTN","ECXUD",42,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXUD",43,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"VER")
8.0^21.0
**END**
**END**
