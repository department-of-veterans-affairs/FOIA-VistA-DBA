Released HL*1.6*103 SEQ #88
Extracted from mail message
**KIDS**:HL*1.6*103^

**INSTALL NAME**
HL*1.6*103
"BLD",672,0)
HL*1.6*103^HEALTH LEVEL SEVEN^0^3030530^y
"BLD",672,1,0)
^^2^2^3030320^
"BLD",672,1,1,0)
See patch HL*1.6*103 in the National Patch Module for complete information
"BLD",672,1,2,0)
on this patch.
"BLD",672,4,0)
^9.64PA^^
"BLD",672,"ABPKG")
n
"BLD",672,"KRN",0)
^9.67PA^8989.52^19
"BLD",672,"KRN",.4,0)
.4
"BLD",672,"KRN",.401,0)
.401
"BLD",672,"KRN",.402,0)
.402
"BLD",672,"KRN",.403,0)
.403
"BLD",672,"KRN",.5,0)
.5
"BLD",672,"KRN",.84,0)
.84
"BLD",672,"KRN",3.6,0)
3.6
"BLD",672,"KRN",3.8,0)
3.8
"BLD",672,"KRN",9.2,0)
9.2
"BLD",672,"KRN",9.8,0)
9.8
"BLD",672,"KRN",9.8,"NM",0)
^9.68A^14^12
"BLD",672,"KRN",9.8,"NM",1,0)
HLUCM^^0^B62888416
"BLD",672,"KRN",9.8,"NM",2,0)
HLUCM001^^0^B49070779
"BLD",672,"KRN",9.8,"NM",3,0)
HLUCM002^^0^B61338380
"BLD",672,"KRN",9.8,"NM",4,0)
HLUCM003^^0^B51926899
"BLD",672,"KRN",9.8,"NM",6,0)
HLUCM005^^1^
"BLD",672,"KRN",9.8,"NM",8,0)
HLUCM007^^1^
"BLD",672,"KRN",9.8,"NM",9,0)
HLUCM008^^1^
"BLD",672,"KRN",9.8,"NM",10,0)
HLUCM009^^0^B41420564
"BLD",672,"KRN",9.8,"NM",11,0)
HLUCM090^^0^B61258653
"BLD",672,"KRN",9.8,"NM",12,0)
HLUCM004^^0^B54148045
"BLD",672,"KRN",9.8,"NM",13,0)
HLUCM006^^1^
"BLD",672,"KRN",9.8,"NM",14,0)
HLUCM050^^0^B75933959
"BLD",672,"KRN",9.8,"NM","B","HLUCM",1)

"BLD",672,"KRN",9.8,"NM","B","HLUCM001",2)

"BLD",672,"KRN",9.8,"NM","B","HLUCM002",3)

"BLD",672,"KRN",9.8,"NM","B","HLUCM003",4)

"BLD",672,"KRN",9.8,"NM","B","HLUCM004",12)

"BLD",672,"KRN",9.8,"NM","B","HLUCM005",6)

"BLD",672,"KRN",9.8,"NM","B","HLUCM006",13)

"BLD",672,"KRN",9.8,"NM","B","HLUCM007",8)

"BLD",672,"KRN",9.8,"NM","B","HLUCM008",9)

"BLD",672,"KRN",9.8,"NM","B","HLUCM009",10)

"BLD",672,"KRN",9.8,"NM","B","HLUCM050",14)

"BLD",672,"KRN",9.8,"NM","B","HLUCM090",11)

"BLD",672,"KRN",19,0)
19
"BLD",672,"KRN",19.1,0)
19.1
"BLD",672,"KRN",101,0)
101
"BLD",672,"KRN",409.61,0)
409.61
"BLD",672,"KRN",771,0)
771
"BLD",672,"KRN",870,0)
870
"BLD",672,"KRN",8989.51,0)
8989.51
"BLD",672,"KRN",8989.52,0)
8989.52
"BLD",672,"KRN",8994,0)
8994
"BLD",672,"KRN","B",.4,.4)

"BLD",672,"KRN","B",.401,.401)

"BLD",672,"KRN","B",.402,.402)

"BLD",672,"KRN","B",.403,.403)

"BLD",672,"KRN","B",.5,.5)

"BLD",672,"KRN","B",.84,.84)

"BLD",672,"KRN","B",3.6,3.6)

"BLD",672,"KRN","B",3.8,3.8)

"BLD",672,"KRN","B",9.2,9.2)

"BLD",672,"KRN","B",9.8,9.8)

"BLD",672,"KRN","B",19,19)

"BLD",672,"KRN","B",19.1,19.1)

"BLD",672,"KRN","B",101,101)

"BLD",672,"KRN","B",409.61,409.61)

"BLD",672,"KRN","B",771,771)

"BLD",672,"KRN","B",870,870)

"BLD",672,"KRN","B",8989.51,8989.51)

"BLD",672,"KRN","B",8989.52,8989.52)

"BLD",672,"KRN","B",8994,8994)

"BLD",672,"QUES",0)
^9.62^^
"BLD",672,"REQB",0)
^9.611^2^2
"BLD",672,"REQB",1,0)
HL*1.6*79^2
"BLD",672,"REQB",2,0)
HL*1.6*88^2
"BLD",672,"REQB","B","HL*1.6*79",1)

"BLD",672,"REQB","B","HL*1.6*88",2)

"MBREQ")
0
"ORD",0,9.8)
9.8;;1;RTNF^XPDTA;RTNE^XPDTA
"ORD",0,9.8,0)
ROUTINE
"PKG",9,-1)
1^1
"PKG",9,0)
HEALTH LEVEL SEVEN^HL^DHCP IMPLEMENTATION OF HEALTH LEVEL SEVEN^
"PKG",9,20,0)
^9.402P^^
"PKG",9,22,0)
^9.49I^1^1
"PKG",9,22,1,0)
1.6^2980130^2980130^6
"PKG",9,22,1,"PAH",1,0)
103^3030530^73
"PKG",9,22,1,"PAH",1,1,0)
^^2^2^3030530
"PKG",9,22,1,"PAH",1,1,1,0)
See patch HL*1.6*103 in the National Patch Module for complete information
"PKG",9,22,1,"PAH",1,1,2,0)
on this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","HLUCM")
0^1^B62888416
"RTN","HLUCM",1,0)
HLUCM ;CIOFO-O/LJA - HL7/Capacity Mgt API ;2/27/01 10:15
"RTN","HLUCM",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**79,88,103**;Oct 13, 1995
"RTN","HLUCM",3,0)
 ;
"RTN","HLUCM",4,0)
 QUIT
"RTN","HLUCM",5,0)
 ;
"RTN","HLUCM",6,0)
CM(START,END,PNMSP,IEN101,TOTALS,COND,ERRINFO) ; Capacity management totals
"RTN","HLUCM",7,0)
 N NMSPTYPE,PROTYPE,RESULTS,SITENM
"RTN","HLUCM",8,0)
 I '$D(HLAPI) N HLAPI S HLAPI="CM"
"RTN","HLUCM",9,0)
 QUIT:'$$PREPARE^HLUCM001 "" ;->
"RTN","HLUCM",10,0)
 D KILLS^HLUCM009("START")
"RTN","HLUCM",11,0)
 S RESULTS=$P($$LOOP,U,1,3)
"RTN","HLUCM",12,0)
 D XTMP
"RTN","HLUCM",13,0)
 D KILLS^HLUCM009("END")
"RTN","HLUCM",14,0)
 KILL HLAPI
"RTN","HLUCM",15,0)
 Q RESULTS
"RTN","HLUCM",16,0)
 ;
"RTN","HLUCM",17,0)
CMF(START,END,PNMSP,IEN101,TOTALS,COND,ERRINFO) ; Collect Remote Facility data - SYNC
"RTN","HLUCM",18,0)
 N HLAPI
"RTN","HLUCM",19,0)
 S HLAPI="CMF"
"RTN","HLUCM",20,0)
 Q $$CM(START,END,.PNMSP,.IEN101,TOTALS,COND,.ERRINFO)
"RTN","HLUCM",21,0)
 ;
"RTN","HLUCM",22,0)
CM2(START,END,PNMSP,IEN101,TOTALS,COND,ERRINFO) ; Capacity management totals
"RTN","HLUCM",23,0)
 N NMSPTYPE,PROTYPE,RESULTS,SITENM
"RTN","HLUCM",24,0)
 I '$D(HLAPI) N HLAPI S HLAPI="CM2"
"RTN","HLUCM",25,0)
 QUIT:'$$PREPARE^HLUCM001 "" ;->
"RTN","HLUCM",26,0)
 D KILLS^HLUCM009("START")
"RTN","HLUCM",27,0)
 S RESULTS=$P($$LOOP,U,1,3) ; Counts are aggregate
"RTN","HLUCM",28,0)
 D XTMP
"RTN","HLUCM",29,0)
 D KILLS^HLUCM009("END")
"RTN","HLUCM",30,0)
 KILL HLAPI
"RTN","HLUCM",31,0)
 QUIT RESULTS
"RTN","HLUCM",32,0)
 ;
"RTN","HLUCM",33,0)
CM2F(START,END,PNMSP,IEN101,TOTALS,COND,ERRINFO) ; Collect Remote Facility data - SYNC
"RTN","HLUCM",34,0)
 N HLAPI
"RTN","HLUCM",35,0)
 S HLAPI="CM2F"
"RTN","HLUCM",36,0)
 Q $$CM2(START,END,.PNMSP,.IEN101,TOTALS,COND,.ERRINFO)
"RTN","HLUCM",37,0)
 ;
"RTN","HLUCM",38,0)
LOOP() ; Loop thru 772's .01... (Called from LOOP^HLUCM)
"RTN","HLUCM",39,0)
 N ANS,API,CHAR,COUNTED,CTDBG,CTPCKG,D0,DATA,DEF,ERR,FAC,FAIL,HL,HLASTNM
"RTN","HLUCM",40,0)
 N HLUCMADD,IEN772,IEN773,LEN,LOOP772,LOOPDT,NMSP,NUM,OK
"RTN","HLUCM",41,0)
 N ORIGETM,ORIGSTM,PCKG,PROT,PROTOCOL,QUES,SEC
"RTN","HLUCM",42,0)
 N SP,SUB,SVNO,TIMEP,TM772,TOT,V1,V2,VAL,VALUE,X,Y
"RTN","HLUCM",43,0)
 ;
"RTN","HLUCM",44,0)
 D LOAD
"RTN","HLUCM",45,0)
 D ADJTIME^HLUCM003
"RTN","HLUCM",46,0)
 D CMDBD
"RTN","HLUCM",47,0)
 D TOTALCM ; Already stored in X (no counted) or C (counted) subscripts...
"RTN","HLUCM",48,0)
 S RESULTS=$G(^TMP(TOTALS,$J))
"RTN","HLUCM",49,0)
 ;
"RTN","HLUCM",50,0)
 QUIT RESULTS
"RTN","HLUCM",51,0)
 ;
"RTN","HLUCM",52,0)
CMDBD ; Create $$CM debug data...
"RTN","HLUCM",53,0)
 ; HLAPI,START,END -- req
"RTN","HLUCM",54,0)
 N DATA,IENPAR,IEN772,OKPP,S1,S2,S3,SUB,TOT,VALNMSP,VALPROT
"RTN","HLUCM",55,0)
 ;
"RTN","HLUCM",56,0)
 S API=$S($G(API)["CM2":1,1:0) ; Async=1, Sync=0
"RTN","HLUCM",57,0)
 ;
"RTN","HLUCM",58,0)
 S IENPAR=0
"RTN","HLUCM",59,0)
 F  S IENPAR=$O(^TMP($J,"HLPARENT",IENPAR)) Q:'IENPAR  D
"RTN","HLUCM",60,0)
 .  S DATA=$G(^TMP($J,"HLPARENT",+IENPAR)) QUIT:DATA']""  ;->
"RTN","HLUCM",61,0)
 .  S VALPROT=$P(DATA,U,7),VALNMSP=$P(DATA,U,9)
"RTN","HLUCM",62,0)
 .  F S1="C","X" F S2="C","X" F S3="C","X" S TOT(S1_S2_S3)=0
"RTN","HLUCM",63,0)
 .  S ^TMP($J,"HLUCMSTORE","U",+IENPAR)=DATA
"RTN","HLUCM",64,0)
 .  S IEN772=0
"RTN","HLUCM",65,0)
 .  F  S IEN772=$O(^TMP($J,"HLPARENT",+IENPAR,IEN772)) Q:'IEN772  D
"RTN","HLUCM",66,0)
 .  .  S ^TMP($J,"HLUCMSTORE","X",+IEN772)=+IENPAR
"RTN","HLUCM",67,0)
 .  .  S (OKPP,OKPP(1))=$$PP(+IEN772)
"RTN","HLUCM",68,0)
 .  .  S OKPP=$S(OKPP=U:"X",1:"C")
"RTN","HLUCM",69,0)
 .  .  S OK=$$COLLSYNC(+IEN772,START,END) ; Outside time range?
"RTN","HLUCM",70,0)
 .  .  S SUB=$S(OK:"C",1:"X")
"RTN","HLUCM",71,0)
 .  .  S DATA=$P($G(^TMP($J,"HLCHILD",+IEN772)),"~",2,999) Q:DATA']""  ;->
"RTN","HLUCM",72,0)
 .  .  ; If # seconds exceeds 1799...
"RTN","HLUCM",73,0)
 .  .  S SUB=SUB_$S($P(DATA,U,3)>1799:"X",1:"C")_OKPP
"RTN","HLUCM",74,0)
 .  .  S:$P(DATA,U,7)']"" $P(DATA,U,7)=VALPROT
"RTN","HLUCM",75,0)
 .  .  S:$P(DATA,U,9)']"" $P(DATA,U,9)=VALNMSP
"RTN","HLUCM",76,0)
 .  .  S ^TMP($J,"HLUCMSTORE","U",+IENPAR,+IEN772,SUB)=DATA
"RTN","HLUCM",77,0)
 .  .  F I=1:1:3 S $P(TOT(SUB),U,I)=$P(TOT(SUB),U,I)+$P(DATA,U,I)
"RTN","HLUCM",78,0)
 .  .  S DATA=$G(^TMP($J,"HLPARENT",+IENPAR,+IEN772))
"RTN","HLUCM",79,0)
 .  .  S X=OKPP(1),$P(DATA,U,5)=$P(X,U),$P(DATA,U,6)=$P(X,U,2)
"RTN","HLUCM",80,0)
 .  .  S ^TMP($J,"HLUCMSTORE","U",+IENPAR,+IEN772,SUB,772)=DATA
"RTN","HLUCM",81,0)
 .
"RTN","HLUCM",82,0)
 .  ; Position #1  C=Count    (Message BEGIN is not before START)
"RTN","HLUCM",83,0)
 .  ;              X=Outside  (Msg BEGIN is before START)
"RTN","HLUCM",84,0)
 .  ;          #2  C=Count    (#Seconds<1800)
"RTN","HLUCM",85,0)
 .  ;              X=Greater  (#Seconds>1799)
"RTN","HLUCM",86,0)
 .  ;          #3  C=Count    (Protocol/Namespace match)
"RTN","HLUCM",87,0)
 .  ;              X=Mismatch (Protocol/Namespace mismatch)
"RTN","HLUCM",88,0)
 .  F S1="C","X" F S2="C","X" F S3="C","X" S SUB=S1_S2_S3 D
"RTN","HLUCM",89,0)
 .  .  QUIT:$TR(TOT(SUB),"0^","")']""  ;->
"RTN","HLUCM",90,0)
 .  .  S ^TMP($J,"HLUCMSTORE","U",+IENPAR,SUB)=TOT(SUB)
"RTN","HLUCM",91,0)
 .  .
"RTN","HLUCM",92,0)
 .  .  S TOT=$G(^TMP($J,"HLUCMSTORE","T",SUB))
"RTN","HLUCM",93,0)
 .  .  D UPTOT
"RTN","HLUCM",94,0)
 .  .  S ^TMP($J,"HLUCMSTORE","T",SUB)=TOT
"RTN","HLUCM",95,0)
 .  .
"RTN","HLUCM",96,0)
 .  .  S ^TMP($J,"HLUCMSTORE","T",SUB,IENPAR)=TOT(SUB)
"RTN","HLUCM",97,0)
 .  .
"RTN","HLUCM",98,0)
 .  .  S TOT=$G(^TMP($J,"HLUCMSTORE","T"))
"RTN","HLUCM",99,0)
 .  .  D UPTOT
"RTN","HLUCM",100,0)
 .  .  S ^TMP($J,"HLUCMSTORE","T")=TOT
"RTN","HLUCM",101,0)
 ;
"RTN","HLUCM",102,0)
 KILL ^TMP($J,"HLCHILD"),^TMP($J,"HLPARENT")
"RTN","HLUCM",103,0)
 ;
"RTN","HLUCM",104,0)
 Q
"RTN","HLUCM",105,0)
 ;
"RTN","HLUCM",106,0)
UPTOT ; Up the totals...
"RTN","HLUCM",107,0)
 ; TOT,TOT(SUB) -- req
"RTN","HLUCM",108,0)
 S $P(TOT,U)=$P(TOT,U)+$P(TOT(SUB),U)
"RTN","HLUCM",109,0)
 S $P(TOT,U,2)=$P(TOT,U,2)+$P(TOT(SUB),U,2)
"RTN","HLUCM",110,0)
 S $P(TOT,U,3)=$P(TOT,U,3)+$P(TOT(SUB),U,3)
"RTN","HLUCM",111,0)
 Q
"RTN","HLUCM",112,0)
 ;
"RTN","HLUCM",113,0)
PP(IEN772) ; Get store value for NMSP and PROT...
"RTN","HLUCM",114,0)
 N PCKG,PP,PROT,X
"RTN","HLUCM",115,0)
 S PP=$$PROTNMSP^HLUCM002(+IEN772)
"RTN","HLUCM",116,0)
 I $P(PP,U)']""!($P(PP,U,2)']"") QUIT U ;->
"RTN","HLUCM",117,0)
 S X=$P(PP,U),PROT=$S(X]"":X,1:"ZZZ")
"RTN","HLUCM",118,0)
 S X=$P(PP,U,2),PCKG=$S(X]"":X,1:"ZZZ")
"RTN","HLUCM",119,0)
 Q PROT_U_PCKG
"RTN","HLUCM",120,0)
 ;
"RTN","HLUCM",121,0)
LOAD ; Load data (Called by $$CM, $$CM2, and all other APIs)
"RTN","HLUCM",122,0)
 ; START,END -- req
"RTN","HLUCM",123,0)
 N IEN772,LOOPDT,X
"RTN","HLUCM",124,0)
 S LOOPDT=START-.000001
"RTN","HLUCM",125,0)
 F  S LOOPDT=$O(^HL(772,"B",LOOPDT)) Q:LOOPDT'>0!(LOOPDT>END)  D
"RTN","HLUCM",126,0)
 .  S IEN772=0
"RTN","HLUCM",127,0)
 .  F  S IEN772=$O(^HL(772,"B",LOOPDT,IEN772)) Q:IEN772'>0  D
"RTN","HLUCM",128,0)
 .  .  QUIT:'$$OK772(+IEN772)  ;->
"RTN","HLUCM",129,0)
 .  .  S X=$$LOAD772S^HLUCM009(IEN772)
"RTN","HLUCM",130,0)
 Q
"RTN","HLUCM",131,0)
 ;
"RTN","HLUCM",132,0)
TOTALCM ; Loop, total for $$CM...
"RTN","HLUCM",133,0)
 ; HLAPI -- req
"RTN","HLUCM",134,0)
 N IEN772,IENPAR
"RTN","HLUCM",135,0)
 S IENPAR=0
"RTN","HLUCM",136,0)
 F  S IENPAR=$O(^TMP($J,"HLUCMSTORE","U",IENPAR)) Q:'IENPAR  D
"RTN","HLUCM",137,0)
 .  ; Don't count anything unless the entire unit is OK...
"RTN","HLUCM",138,0)
 .  QUIT:$O(^TMP($J,"HLUCMSTORE","U",+IENPAR,"CCC"))]""  ;->
"RTN","HLUCM",139,0)
 .  S IEN772=0,HLUCMADD=""
"RTN","HLUCM",140,0)
 .  F  S IEN772=$O(^TMP($J,"HLUCMSTORE","U",IENPAR,IEN772)) Q:'IEN772  D
"RTN","HLUCM",141,0)
 .  .  ;QUIT:'$D(^TMP($J,"HLUCMSTORE","U",+IENPAR,+IEN772,"CCC"))  ;->
"RTN","HLUCM",142,0)
 .  .  D COLLECT(+IENPAR,+IEN772)
"RTN","HLUCM",143,0)
 .  .  I HLAPI["CM2" S HLUCMADD="DON'T ADD.  COLLECT3~HLUCM003"
"RTN","HLUCM",144,0)
 Q
"RTN","HLUCM",145,0)
 ;
"RTN","HLUCM",146,0)
COLLSYNC(IEN772,START,END) ; Does entry fall in START/END range?
"RTN","HLUCM",147,0)
 N DATA,X
"RTN","HLUCM",148,0)
 S DATA=$G(^TMP($J,"HLCHILD",+IEN772)) QUIT:DATA']"" "" ;->
"RTN","HLUCM",149,0)
 S X=$P($P(DATA,"~",2,999),U,4) Q:X'?7N.E!(X<START)!(X>END) "" ;->
"RTN","HLUCM",150,0)
 Q 1
"RTN","HLUCM",151,0)
 ;
"RTN","HLUCM",152,0)
OK772(IEN772) ; Valid entry?
"RTN","HLUCM",153,0)
 N D
"RTN","HLUCM",154,0)
 S D=$G(^HL(772,+IEN772,0))
"RTN","HLUCM",155,0)
 QUIT:$P(D,U)'?7N.E "" ;->
"RTN","HLUCM",156,0)
 I $P(D,U,2)']"",$P(D,U,3)']"",$P(D,U,4)']"",$P(D,U,5)']"" QUIT ""
"RTN","HLUCM",157,0)
 Q 1
"RTN","HLUCM",158,0)
 ;
"RTN","HLUCM",159,0)
COLLECT(PAR,IEN772) ; Collect 772 data and associated 773 data...
"RTN","HLUCM",160,0)
 N CT,CTPCKG,DATA,DBGBL,IEN773,PP,TOT772,TOT772T,TYPEHR,TYPEIO,TYPELR
"RTN","HLUCM",161,0)
 ;
"RTN","HLUCM",162,0)
 ; ^("U",PARENT-IEN,CHILD-IEN,"CCC")
"RTN","HLUCM",163,0)
 S DATA=$G(^TMP($J,"HLUCMSTORE","U",+PAR,+IEN772,"CCC"))
"RTN","HLUCM",164,0)
 S DATA("CHAR")=$P(DATA,U),DATA("DIFF")=$P(DATA,U,3)
"RTN","HLUCM",165,0)
 S DATA("START")=$P(DATA,U,4),DATA("END")=$P(DATA,U,5)
"RTN","HLUCM",166,0)
 S DATA("FAC")=$P(DATA,U,11)
"RTN","HLUCM",167,0)
 ;
"RTN","HLUCM",168,0)
 ; ^("U",PARENT-IEN,CHILD-IEN,"CCC",772)
"RTN","HLUCM",169,0)
 S DATA=$G(^TMP($J,"HLUCMSTORE","U",+PAR,+IEN772,"CCC",772))
"RTN","HLUCM",170,0)
 S DATA("HR")=$P(DATA,U),DATA("IO")=$P(DATA,U,2),DATA("LR")=$P(DATA,U,3)
"RTN","HLUCM",171,0)
 S (DATA("PROT"),PROT)=$P(DATA,U,5)
"RTN","HLUCM",172,0)
 S (DATA("PCKG"),PCKG)=$P(DATA,U,6)
"RTN","HLUCM",173,0)
 ;
"RTN","HLUCM",174,0)
 S DBGBL=1
"RTN","HLUCM",175,0)
 ;
"RTN","HLUCM",176,0)
 ; Store DATA() info in ^TMP(TOTALS,$J,...)
"RTN","HLUCM",177,0)
 D ADDTMP^HLUCM001
"RTN","HLUCM",178,0)
 ;
"RTN","HLUCM",179,0)
 QUIT
"RTN","HLUCM",180,0)
 ;
"RTN","HLUCM",181,0)
TOT772C(IEN772) ; Total number of characters in message...
"RTN","HLUCM",182,0)
 N LEN,LNO,TXT
"RTN","HLUCM",183,0)
 ;
"RTN","HLUCM",184,0)
 ; Use field if present.  (Not present about 25% of time)
"RTN","HLUCM",185,0)
 S LEN=$P($G(^HL(772,IEN772,"S")),U)
"RTN","HLUCM",186,0)
 I LEN D  QUIT  ;->
"RTN","HLUCM",187,0)
 .  S DATA("CHAR",772)=$G(DATA("CHAR",772))+LEN
"RTN","HLUCM",188,0)
 .  S DATA("CHAR")=$G(DATA("CHAR"))+LEN
"RTN","HLUCM",189,0)
 ;
"RTN","HLUCM",190,0)
 ; Total manually...
"RTN","HLUCM",191,0)
 S LNO=0
"RTN","HLUCM",192,0)
 F  S LNO=$O(^HL(772,IEN772,"IN",LNO)) Q:LNO'>0  D
"RTN","HLUCM",193,0)
 .  S TXT=$G(^HL(772,IEN772,"IN",+LNO,0)) QUIT:TXT']""  ;->
"RTN","HLUCM",194,0)
 .  S DATA("CHAR",772)=$G(DATA("CHAR",772))+$L(TXT)
"RTN","HLUCM",195,0)
 .  S DATA("CHAR")=$G(DATA("CHAR"))+$L(TXT)
"RTN","HLUCM",196,0)
 ;
"RTN","HLUCM",197,0)
 QUIT
"RTN","HLUCM",198,0)
 ;
"RTN","HLUCM",199,0)
TOT772T(IEN772) ; Processing time...
"RTN","HLUCM",200,0)
 ; No totals here.  Just set times in DATA() array for later use...
"RTN","HLUCM",201,0)
 N TIME
"RTN","HLUCM",202,0)
 ;
"RTN","HLUCM",203,0)
 ; Time of entry...
"RTN","HLUCM",204,0)
 S TIME=+$G(^HL(772,+IEN772,0))
"RTN","HLUCM",205,0)
 I TIME?7N.E S DATA("TIME",TIME,772,.01)=""
"RTN","HLUCM",206,0)
 ;
"RTN","HLUCM",207,0)
 ; Time processed...
"RTN","HLUCM",208,0)
 S TIME=$P($G(^HL(772,+IEN772,"P")),U,2)
"RTN","HLUCM",209,0)
 I TIME?7N.E S DATA("TIME",TIME,772,21)=""
"RTN","HLUCM",210,0)
 ;
"RTN","HLUCM",211,0)
 QUIT
"RTN","HLUCM",212,0)
 ;
"RTN","HLUCM",213,0)
TOT773C(IEN773) ; Total number of characters...
"RTN","HLUCM",214,0)
 ; DATA() -- passed in  (See COLLECT)
"RTN","HLUCM",215,0)
 N CHAR
"RTN","HLUCM",216,0)
 S CHAR=$$MSGSIZE(+IEN773) QUIT:CHAR'>0  ;->
"RTN","HLUCM",217,0)
 S DATA("CHAR",773,IEN773)=CHAR
"RTN","HLUCM",218,0)
 S DATA("CHAR")=$G(DATA("CHAR"))+CHAR
"RTN","HLUCM",219,0)
 S TOT773(IEN773)=CHAR
"RTN","HLUCM",220,0)
 QUIT
"RTN","HLUCM",221,0)
 ;
"RTN","HLUCM",222,0)
MSGSIZE(IEN773) ; Number characters in 773 entry...
"RTN","HLUCM",223,0)
 N NCH,NO
"RTN","HLUCM",224,0)
 S NCH=0,NO=0
"RTN","HLUCM",225,0)
 F  S NO=$O(^HLMA(+IEN773,"MSH",NO)) Q:NO'>0  D
"RTN","HLUCM",226,0)
 .  S NCH=NCH+$L(^HLMA(+IEN773,"MSH",+NO,0))
"RTN","HLUCM",227,0)
 QUIT NCH
"RTN","HLUCM",228,0)
 ;
"RTN","HLUCM",229,0)
TOT773T(IEN773) ; Set TIMEs...
"RTN","HLUCM",230,0)
 ; DATA() -- passed in  (See COLLECT)
"RTN","HLUCM",231,0)
 N TIME
"RTN","HLUCM",232,0)
 ;
"RTN","HLUCM",233,0)
 ; Creation time already taken from 772...
"RTN","HLUCM",234,0)
 ;
"RTN","HLUCM",235,0)
 ; Processed time...
"RTN","HLUCM",236,0)
 S TIME=+$G(^HLMA(+IEN773,"S")) QUIT:TIME'>0  ;->
"RTN","HLUCM",237,0)
 S DATA("TIME",TIME,773,100)=""
"RTN","HLUCM",238,0)
 ;
"RTN","HLUCM",239,0)
 QUIT
"RTN","HLUCM",240,0)
 ;
"RTN","HLUCM",241,0)
ERR(REA) ; Record error...
"RTN","HLUCM",242,0)
 S NOERR=NOERR+1
"RTN","HLUCM",243,0)
 S REA=$S($G(REA)]"":REA,1:"?")
"RTN","HLUCM",244,0)
 S ERRINFO(REA)=""
"RTN","HLUCM",245,0)
 QUIT
"RTN","HLUCM",246,0)
 ;
"RTN","HLUCM",247,0)
SEC(FMDT) ;
"RTN","HLUCM",248,0)
 S FMDT=$$FMTH^XLFDT(FMDT)
"RTN","HLUCM",249,0)
 QUIT $$SEC^XLFDT(FMDT)
"RTN","HLUCM",250,0)
 ;
"RTN","HLUCM",251,0)
TMDIFF ; DATA("TIME",...) -- req --> DATA("DIFF")
"RTN","HLUCM",252,0)
 S DATA("START")=$O(DATA("TIME",0)) QUIT:DATA("START")'>0  ;->
"RTN","HLUCM",253,0)
 S DATA("END")=$O(DATA("TIME",":"),-1)
"RTN","HLUCM",254,0)
 S DATA("DIFF")=$$SEC(DATA("END"))-$$SEC(DATA("START"))
"RTN","HLUCM",255,0)
 QUIT
"RTN","HLUCM",256,0)
 ;
"RTN","HLUCM",257,0)
XTMP ; Store in ^XTMP...
"RTN","HLUCM",258,0)
 ; API Parameters -- req
"RTN","HLUCM",259,0)
 N XTMP
"RTN","HLUCM",260,0)
 ;
"RTN","HLUCM",261,0)
 QUIT:PNMSP'=1!(IEN101'=1)  ;-> Must be ALL,ALL
"RTN","HLUCM",262,0)
 ;
"RTN","HLUCM",263,0)
 S XTMP="HLUCM "_$$DT^XLFDT
"RTN","HLUCM",264,0)
 S:'$D(^XTMP(XTMP,0)) ^XTMP(XTMP,0)=$$FMADD^XLFDT($$DT^XLFDT,7)_U_$$NOW^XLFDT_U_"HLUCM Data"
"RTN","HLUCM",265,0)
 ;
"RTN","HLUCM",266,0)
 S SVNO=$G(^XTMP(XTMP,"P",+START,+END,COND))
"RTN","HLUCM",267,0)
 I SVNO'>0 S SVNO=$O(^XTMP(XTMP,"N",":"),-1)+1
"RTN","HLUCM",268,0)
 S ^XTMP(XTMP,"P",+START,+END,COND)=SVNO_U_$$NOW^XLFDT
"RTN","HLUCM",269,0)
 S ^XTMP(XTMP,"N",+SVNO)=START_U_END_U_COND_U_HLAPI
"RTN","HLUCM",270,0)
 KILL ^XTMP(XTMP,"D",+SVNO)
"RTN","HLUCM",271,0)
 ;
"RTN","HLUCM",272,0)
 MERGE ^XTMP(XTMP,"D",+SVNO)=^TMP(TOTALS,$J)
"RTN","HLUCM",273,0)
 ;
"RTN","HLUCM",274,0)
 Q
"RTN","HLUCM",275,0)
 ;
"RTN","HLUCM",276,0)
EOR ; HLUCM - HL7/Capacity Mgt API ;2/27/01 10:15
"RTN","HLUCM001")
0^2^B49070779
"RTN","HLUCM001",1,0)
HLUCM001 ;CIOFO-O/LJA - HL7/Capacity Mgt API (continued) ;2/27/01 10:15
"RTN","HLUCM001",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**79,88,103**;Oct 13, 1995
"RTN","HLUCM001",3,0)
 ;
"RTN","HLUCM001",4,0)
ADDTMP ; Accumulate totals into ^TMP(TOTALS,$J,...)
"RTN","HLUCM001",5,0)
 ; FAC,ORIGETM,ORIGSTM,TYPEHR,TYPEIO,TYPELR -- req
"RTN","HLUCM001",6,0)
 ;
"RTN","HLUCM001",7,0)
 N CHAR,ERRFLAG,FAC,SEC,START,TOTCURR,TYPEHR,TYPEIO,TYPELR
"RTN","HLUCM001",8,0)
 ;
"RTN","HLUCM001",9,0)
 S CHAR=$G(DATA("CHAR")),SEC=$G(DATA("DIFF")),FAC=$G(DATA("FAC"))
"RTN","HLUCM001",10,0)
 S TYPEHR=$G(DATA("HR")),TYPEIO=$G(DATA("IO")),TYPELR=$G(DATA("LR"))
"RTN","HLUCM001",11,0)
 ;
"RTN","HLUCM001",12,0)
 S START=$$HR($G(DATA("START")))
"RTN","HLUCM001",13,0)
 ;I START<ORIGSTM S START=ORIGSTM
"RTN","HLUCM001",14,0)
 ;I START>ORIGETM S START=ORIGETM
"RTN","HLUCM001",15,0)
 ;
"RTN","HLUCM001",16,0)
 ; Back door way to total by day only. (Dropping HR).
"RTN","HLUCM001",17,0)
 I $D(^TMP($J,"HLUCMDT")) S START=START\1
"RTN","HLUCM001",18,0)
 ;
"RTN","HLUCM001",19,0)
 ; Is delta time greater than 30 minutes?
"RTN","HLUCM001",20,0)
 S ERRFLAG=0
"RTN","HLUCM001",21,0)
 I SEC>1799 D
"RTN","HLUCM001",22,0)
 .  S X=TOTALS N TOTALS S TOTALS=X_"ERRTIME",ERRFLAG=1
"RTN","HLUCM001",23,0)
 .  D ERRMOVE^HLUCM009(+IEN772) ; Move into ^TMP($J,"HLUCMSTORE","ERR")
"RTN","HLUCM001",24,0)
 ; Store under TOTALS_ERRTIME
"RTN","HLUCM001",25,0)
 ;
"RTN","HLUCM001",26,0)
 ; Maybe, this IEN772 has already been ERRd by ERRMOVE^HLUCM009?
"RTN","HLUCM001",27,0)
 I $D(^TMP($J,"HLUCMSTORE","ERR","X",+IEN772)) D  QUIT  ;->
"RTN","HLUCM001",28,0)
 .  D ERRMOVE^HLUCM009(+IEN772) ; Just to be sure
"RTN","HLUCM001",29,0)
 ;
"RTN","HLUCM001",30,0)
 ; Should this entry even be counted?
"RTN","HLUCM001",31,0)
 I (HLAPI="CMF"!(HLAPI="CM2F"))&(TYPELR'="R") QUIT  ;->
"RTN","HLUCM001",32,0)
 ;
"RTN","HLUCM001",33,0)
 ; Accumulating and totaling here...
"RTN","HLUCM001",34,0)
 I TYPELR="R" D ACCUMFAC^HLUCM090
"RTN","HLUCM001",35,0)
 D ACCUMHR
"RTN","HLUCM001",36,0)
 D ACCUMSP
"RTN","HLUCM001",37,0)
 D ACCUMPR
"RTN","HLUCM001",38,0)
 D TOTALING
"RTN","HLUCM001",39,0)
 ;
"RTN","HLUCM001",40,0)
 Q
"RTN","HLUCM001",41,0)
 ;
"RTN","HLUCM001",42,0)
TOTALING ; Grand totals
"RTN","HLUCM001",43,0)
 S TOTCURR=$G(^TMP(TOTALS,$J))
"RTN","HLUCM001",44,0)
 S $P(TOTCURR,U)=$P(TOTCURR,U)+DATA("CHAR")
"RTN","HLUCM001",45,0)
 I $G(HLUCMADD)'="DON'T ADD.  COLLECT3~HLUCM003" D
"RTN","HLUCM001",46,0)
 .  S $P(TOTCURR,U,2)=$P(TOTCURR,U,2)+1
"RTN","HLUCM001",47,0)
 S $P(TOTCURR,U,3)=$P(TOTCURR,U,3)+DATA("DIFF")
"RTN","HLUCM001",48,0)
 S $P(TOTCURR,U,4)=$P(TOTCURR,U,4)+1
"RTN","HLUCM001",49,0)
 S ^TMP(TOTALS,$J)=TOTCURR
"RTN","HLUCM001",50,0)
 Q
"RTN","HLUCM001",51,0)
 ;
"RTN","HLUCM001",52,0)
ACCUMHR ; Hour totaling
"RTN","HLUCM001",53,0)
 ; DATA(),FAC,START,TYPEHR -- req
"RTN","HLUCM001",54,0)
 ;
"RTN","HLUCM001",55,0)
 I HLAPI="CM"!(HLAPI="CM2") D ACCUMLAT^HLUCM009("HR","TM",TYPEHR,START,DATA("PCKG"),DATA("PROT"))
"RTN","HLUCM001",56,0)
 I HLAPI="CMF"!(HLAPI="CM2F") D ACCUMLAT^HLUCM009("HR","TM",TYPEHR,FAC,START,DATA("PCKG"),DATA("PROT"))
"RTN","HLUCM001",57,0)
 ;
"RTN","HLUCM001",58,0)
 ; Total level CATEGORY
"RTN","HLUCM001",59,0)
 S TOTCURR=$G(^TMP(TOTALS,$J,"HR"))
"RTN","HLUCM001",60,0)
 D INCR
"RTN","HLUCM001",61,0)
 S ^TMP(TOTALS,$J,"HR")=TOTCURR
"RTN","HLUCM001",62,0)
 ;
"RTN","HLUCM001",63,0)
 QUIT
"RTN","HLUCM001",64,0)
 ;
"RTN","HLUCM001",65,0)
ACCUMSP ; Namespace totaling
"RTN","HLUCM001",66,0)
 ; DATA(),FAC,TYPEIO,TYPELR -- req
"RTN","HLUCM001",67,0)
 ;
"RTN","HLUCM001",68,0)
 I HLAPI="CM"!(HLAPI="CM2") D
"RTN","HLUCM001",69,0)
 .  D ACCUMLAT^HLUCM009("NMSP","IO",TYPEIO,DATA("PCKG"),START,DATA("PROT"))
"RTN","HLUCM001",70,0)
 .  D ACCUMLAT^HLUCM009("NMSP","LR",TYPELR,DATA("PCKG"),START,DATA("PROT"))
"RTN","HLUCM001",71,0)
 I HLAPI="CMF"!(HLAPI="CM2F") D
"RTN","HLUCM001",72,0)
 .  D ACCUMLAT^HLUCM009("NMSP","IO",TYPEIO,FAC,DATA("PCKG"),START,DATA("PROT"))
"RTN","HLUCM001",73,0)
 .  D ACCUMLAT^HLUCM009("NMSP","LR",TYPELR,FAC,DATA("PCKG"),START,DATA("PROT"))
"RTN","HLUCM001",74,0)
 ;
"RTN","HLUCM001",75,0)
 ; Total level CATEGORY
"RTN","HLUCM001",76,0)
 S TOTCURR=$G(^TMP(TOTALS,$J,"NMSP"))
"RTN","HLUCM001",77,0)
 D INCR
"RTN","HLUCM001",78,0)
 S ^TMP(TOTALS,$J,"NMSP")=TOTCURR
"RTN","HLUCM001",79,0)
 ;
"RTN","HLUCM001",80,0)
 QUIT
"RTN","HLUCM001",81,0)
 ;
"RTN","HLUCM001",82,0)
ACCUMPR ; Protocol totaling...
"RTN","HLUCM001",83,0)
 ; DATA(),FAC,START -- req
"RTN","HLUCM001",84,0)
 ;
"RTN","HLUCM001",85,0)
 I HLAPI="CM"!(HLAPI="CM2") D ACCUMLAT^HLUCM009("PROT","PR","P",DATA("PROT"),DATA("PCKG"),START)
"RTN","HLUCM001",86,0)
 I HLAPI="CMF"!(HLAPI="CM2F") D ACCUMLAT^HLUCM009("PROT","PR","P",FAC,DATA("PROT"),DATA("PCKG"),START)
"RTN","HLUCM001",87,0)
 ;
"RTN","HLUCM001",88,0)
 ; Total level CATEGORY
"RTN","HLUCM001",89,0)
 S TOTCURR=$G(^TMP(TOTALS,$J,"PROT"))
"RTN","HLUCM001",90,0)
 D INCR
"RTN","HLUCM001",91,0)
 S ^TMP(TOTALS,$J,"PROT")=TOTCURR
"RTN","HLUCM001",92,0)
 ;
"RTN","HLUCM001",93,0)
 QUIT
"RTN","HLUCM001",94,0)
 ;
"RTN","HLUCM001",95,0)
INCR ; Increment totals in TOTCURR...
"RTN","HLUCM001",96,0)
 ; CHAR,SEC -- req
"RTN","HLUCM001",97,0)
 S $P(TOTCURR,U)=$P(TOTCURR,U)+CHAR ; Number characters
"RTN","HLUCM001",98,0)
 I $G(HLUCMADD)'="DON'T ADD.  COLLECT3~HLUCM003" D
"RTN","HLUCM001",99,0)
 .  S $P(TOTCURR,U,2)=$P(TOTCURR,U,2)+1
"RTN","HLUCM001",100,0)
 S $P(TOTCURR,U,3)=$P(TOTCURR,U,3)+SEC ; Processing seconds
"RTN","HLUCM001",101,0)
 S $P(TOTCURR,U,4)=$P(TOTCURR,U,4)+1
"RTN","HLUCM001",102,0)
 QUIT
"RTN","HLUCM001",103,0)
 ;
"RTN","HLUCM001",104,0)
HR(FMDT) ; Return FM DATE and HOUR only...
"RTN","HLUCM001",105,0)
 N HR
"RTN","HLUCM001",106,0)
 S FMDT=$G(FMDT)
"RTN","HLUCM001",107,0)
 I FMDT'?7N&(FMDT'?7N1"."1.N) QUIT "" ;->
"RTN","HLUCM001",108,0)
 S:FMDT'["." FMDT=FMDT_"."
"RTN","HLUCM001",109,0)
 S FMDT=$E(FMDT_"00",1,10) ; .00 thru .23 now...
"RTN","HLUCM001",110,0)
 S HR=+$P(FMDT,".",2)+1
"RTN","HLUCM001",111,0)
 S:HR<10 HR=0_HR S:HR>24 HR=24
"RTN","HLUCM001",112,0)
 QUIT (FMDT\1)_"."_HR
"RTN","HLUCM001",113,0)
 ;
"RTN","HLUCM001",114,0)
OKPAR101(PAR) ; PAR=IEN101...
"RTN","HLUCM001",115,0)
 N RET,VAL
"RTN","HLUCM001",116,0)
 ;
"RTN","HLUCM001",117,0)
 I PAR=1!(PAR=2) QUIT PAR ;->
"RTN","HLUCM001",118,0)
 I PAR="0^9999999" QUIT PAR ;->
"RTN","HLUCM001",119,0)
 ;
"RTN","HLUCM001",120,0)
 ; Passed as 0^IEN or 0^PROTOCOL NAME...
"RTN","HLUCM001",121,0)
 S VAL=$P(PAR,U,2)
"RTN","HLUCM001",122,0)
 ;
"RTN","HLUCM001",123,0)
 ; Was IEN passed?
"RTN","HLUCM001",124,0)
 I VAL=+VAL D  QUIT RET ;->
"RTN","HLUCM001",125,0)
 .  S RET=""
"RTN","HLUCM001",126,0)
 .  I $D(^ORD(101,+VAL,0)) S RET=PAR
"RTN","HLUCM001",127,0)
 .  I '$D(^ORD(101,+VAL,0)) QUIT  ;-> Leaving RET=""
"RTN","HLUCM001",128,0)
 ;
"RTN","HLUCM001",129,0)
 ; Name was passed... (Can be up to 63 characters long...)
"RTN","HLUCM001",130,0)
 ; Find IEN for name...
"RTN","HLUCM001",131,0)
 S VAL=$$FIND101(PAR)
"RTN","HLUCM001",132,0)
 ;
"RTN","HLUCM001",133,0)
 ; If VAL=IEN, reset IEN101 to 0^IEN format...
"RTN","HLUCM001",134,0)
 I VAL>0 QUIT "0^"_+VAL  ;->
"RTN","HLUCM001",135,0)
 ;
"RTN","HLUCM001",136,0)
 QUIT ""
"RTN","HLUCM001",137,0)
 ;
"RTN","HLUCM001",138,0)
TYPELR(IEN772,FACNM) ; Is this Local or Remote or Unknown?
"RTN","HLUCM001",139,0)
 ; SITENM -- req
"RTN","HLUCM001",140,0)
 N D772,I773,IEN,IEN870,IO,MIEN,NM,TXT,TYPE,X
"RTN","HLUCM001",141,0)
 ;
"RTN","HLUCM001",142,0)
 ; If SITENM=FACNM, then it isn't remote...
"RTN","HLUCM001",143,0)
 I $G(SITENM)]"",$G(FACNM)]"",SITENM=FACNM QUIT "L" ;->
"RTN","HLUCM001",144,0)
 ;
"RTN","HLUCM001",145,0)
 S D772=$G(^HL(772,+IEN772,0))
"RTN","HLUCM001",146,0)
 ;
"RTN","HLUCM001",147,0)
 ; Mailman check...
"RTN","HLUCM001",148,0)
 S MIEN=$P(D772,U,5) ; get Mailman IEN...
"RTN","HLUCM001",149,0)
 I MIEN S X=$$MAILTYPE^HLUCM009(MIEN) QUIT:X="R" $$SLR(IEN772,"R") ;-> Mailman, and remote...
"RTN","HLUCM001",150,0)
 ;
"RTN","HLUCM001",151,0)
 ; Additional mail check...
"RTN","HLUCM001",152,0)
 I $$MAIL870^HLUCM090(IEN772)="R" QUIT $$SLR(IEN772,"R") ;->
"RTN","HLUCM001",153,0)
 ;
"RTN","HLUCM001",154,0)
 ; Institution check...
"RTN","HLUCM001",155,0)
 I $$INST870^HLUCM090(+IEN772,+$P($$SITE^VASITE,U,3))="R" QUIT $$SLR(IEN772,"R") ;->
"RTN","HLUCM001",156,0)
 ;
"RTN","HLUCM001",157,0)
 ; MSH segment in 773 check...
"RTN","HLUCM001",158,0)
 S TYPE="L",I773=0
"RTN","HLUCM001",159,0)
 F  S I773=$O(^HLMA("B",IEN772,I773)) Q:'I773!(TYPE'="L")  D
"RTN","HLUCM001",160,0)
 .  N DIV,P4,P6
"RTN","HLUCM001",161,0)
 .  S TXT="",MIEN=0
"RTN","HLUCM001",162,0)
 .  F  S MIEN=$O(^HLMA(+I773,"MSH",MIEN)) Q:MIEN'>0  D
"RTN","HLUCM001",163,0)
 .  .  S TXT=TXT_$G(^HLMA(+I773,"MSH",+MIEN,0))
"RTN","HLUCM001",164,0)
 .  QUIT:TXT']""  ;->
"RTN","HLUCM001",165,0)
 .  S X=$$SITESMSH^HLUCM009(TXT),P4=$P(X,U),P6=$P(X,U,2)
"RTN","HLUCM001",166,0)
 .  S:P4'=P6 TYPE="R"
"RTN","HLUCM001",167,0)
 ;
"RTN","HLUCM001",168,0)
 ; Was anything found?
"RTN","HLUCM001",169,0)
 QUIT:TYPE'="L" $$SLR(IEN772,TYPE) ;->
"RTN","HLUCM001",170,0)
 ;
"RTN","HLUCM001",171,0)
 ; Logical links check...
"RTN","HLUCM001",172,0)
 S IEN870=$$IEN870^HLUCM009(+IEN772) I IEN870 D
"RTN","HLUCM001",173,0)
 .  N DATA,MGIEN
"RTN","HLUCM001",174,0)
 .  S DATA=$G(^HLCS(870,+IEN870,0))
"RTN","HLUCM001",175,0)
 .  QUIT:$P(DATA,U,3)'=1  ;-> Not MAIL...
"RTN","HLUCM001",176,0)
 .  S MGIEN=$P($G(^HLCS(870,+IEN870,100)),U) QUIT:MGIEN'>0  ;->
"RTN","HLUCM001",177,0)
 .  ; If a MAIL type link and there is an associated mail group,
"RTN","HLUCM001",178,0)
 ;  ; it is almost always REMOTE.  Enough so, that "R" will be assumed.
"RTN","HLUCM001",179,0)
 .  ; QUIT:$O(^XMB(3.8,+MGIEN,6,0))'>0  ;-> No remote groups
"RTN","HLUCM001",180,0)
 .  S TYPE="R"
"RTN","HLUCM001",181,0)
 .  ; Rare to hit this point.
"RTN","HLUCM001",182,0)
 ;
"RTN","HLUCM001",183,0)
 QUIT $$SLR(IEN772,TYPE)
"RTN","HLUCM001",184,0)
 ;
"RTN","HLUCM001",185,0)
SLR(IEN772,LR) ; Store the L/R type for use for FACILITY sorting
"RTN","HLUCM001",186,0)
 N FAC,HLDATA,PARENT,TYPE,X
"RTN","HLUCM001",187,0)
 Q LR
"RTN","HLUCM001",188,0)
 ;
"RTN","HLUCM001",189,0)
PREPARE() ; Called by $$CM & $$CM2 and other APIs...
"RTN","HLUCM001",190,0)
 ;
"RTN","HLUCM001",191,0)
 S ORIGSTM=$G(START),ORIGETM=$G(END)
"RTN","HLUCM001",192,0)
 S SITENM=$P($$SITE^VASITE,U,2)
"RTN","HLUCM001",193,0)
 ;
"RTN","HLUCM001",194,0)
 ; Summarize by DAY instead of hour?
"RTN","HLUCM001",195,0)
 I ORIGSTM?7N,ORIGETM']"" D
"RTN","HLUCM001",196,0)
 .  S ^TMP($J,"HLUCMDT")=""
"RTN","HLUCM001",197,0)
 .  S ORIGETM=ORIGSTM_".24"
"RTN","HLUCM001",198,0)
 ;
"RTN","HLUCM001",199,0)
 D ZEROUP
"RTN","HLUCM001",200,0)
 ;
"RTN","HLUCM001",201,0)
 ; Miscellaneous KILLs...
"RTN","HLUCM001",202,0)
 D KILLS^HLUCM009("START")
"RTN","HLUCM001",203,0)
 ;
"RTN","HLUCM001",204,0)
 ; Build namespace xref
"RTN","HLUCM001",205,0)
 D NMSPXRF^HLUCM009
"RTN","HLUCM001",206,0)
 ;
"RTN","HLUCM001",207,0)
 ; This is where results are returned to caller...
"RTN","HLUCM001",208,0)
 KILL ERRINFO
"RTN","HLUCM001",209,0)
 ;
"RTN","HLUCM001",210,0)
 ; Perform all setup chores.  If errors found, they will be placed
"RTN","HLUCM001",211,0)
 ; in ERRINFO(ERROR-REASON)="" array
"RTN","HLUCM001",212,0)
 QUIT:$$SETUP^HLUCM009 "" ;-> Some errors occurred...
"RTN","HLUCM001",213,0)
 ;
"RTN","HLUCM001",214,0)
 Q 1
"RTN","HLUCM001",215,0)
 ;
"RTN","HLUCM001",216,0)
ZEROUP ; If didn't add 0^...
"RTN","HLUCM001",217,0)
 I $G(IEN101)]"",IEN101'?1N,IEN101'?1"0^".E S IEN101="0^"_IEN101
"RTN","HLUCM001",218,0)
 I $G(PNMSP)]"",PNMSP'?1N,PNMSP'?1"0^".E S PNMSP="0^"_PNMSP
"RTN","HLUCM001",219,0)
 Q
"RTN","HLUCM001",220,0)
 ;
"RTN","HLUCM001",221,0)
FIND101(VAL) ; No checking for upp/lowercase.  Must be passed right!
"RTN","HLUCM001",222,0)
 ; VAL = Protocol name...
"RTN","HLUCM001",223,0)
 N FIEN,IEN,LNM,PNM
"RTN","HLUCM001",224,0)
 ;
"RTN","HLUCM001",225,0)
 S VAL=$P(VAL,"0^",2)
"RTN","HLUCM001",226,0)
 ;
"RTN","HLUCM001",227,0)
 ; Passed as IEN?
"RTN","HLUCM001",228,0)
 I VAL=+VAL,$D(^ORD(101,+VAL,0)) QUIT +VAL ;->
"RTN","HLUCM001",229,0)
 ;
"RTN","HLUCM001",230,0)
 ; Passed as NAME?
"RTN","HLUCM001",231,0)
 S FIEN=0
"RTN","HLUCM001",232,0)
 S LNM=$E(VAL,1,$S($L(VAL)>30:29,1:$L(VAL)-1))
"RTN","HLUCM001",233,0)
 F  S LNM=$O(^ORD(101,"B",LNM)) Q:LNM]VAL!(LNM']"")!(FIEN)  D
"RTN","HLUCM001",234,0)
 .  S IEN=0
"RTN","HLUCM001",235,0)
 .  F  S IEN=$O(^ORD(101,"B",LNM,IEN)) Q:IEN'>0!(FIEN)  D
"RTN","HLUCM001",236,0)
 .  .  QUIT:$P($G(^ORD(101,+IEN,0)),U)'=VAL  ;->
"RTN","HLUCM001",237,0)
 .  .  S FIEN=+IEN
"RTN","HLUCM001",238,0)
 QUIT $S(FIEN:FIEN,1:"")
"RTN","HLUCM001",239,0)
 ;
"RTN","HLUCM001",240,0)
REFPROT(PROT) ; If passed by reference, is PROT in array? 0=Don't count, 2=Count
"RTN","HLUCM001",241,0)
 ; PROTYPE -- req
"RTN","HLUCM001",242,0)
 N X
"RTN","HLUCM001",243,0)
 I PROTYPE'=1 QUIT 1 ;-> Not passed by reference...
"RTN","HLUCM001",244,0)
 S X=$P(PROT,"~") I X]"" I $D(IEN101(X)) QUIT 1 ;-> found by name in array
"RTN","HLUCM001",245,0)
 S X=$P(PROT,"~",2) I X]"" I $D(IEN101(+X)) QUIT 1 ;-> found by IEN in array
"RTN","HLUCM001",246,0)
 QUIT ""
"RTN","HLUCM001",247,0)
 ;
"RTN","HLUCM001",248,0)
REFPCKG(PCKG) ; If passed by reference, is PCKG in array? 0=Don't count,1=OK to count
"RTN","HLUCM001",249,0)
 ; NMSPTYPE -- req
"RTN","HLUCM001",250,0)
 I NMSPTYPE'=1 QUIT 1 ;-> Not passed by reference...
"RTN","HLUCM001",251,0)
 I PCKG]"" I $D(PNMSP(PCKG)) QUIT 1 ;-> found in array
"RTN","HLUCM001",252,0)
 QUIT ""
"RTN","HLUCM001",253,0)
 ;
"RTN","HLUCM001",254,0)
EOR ; HLUCM001 - HL7/Capacity Mgt API (continued) ;2/27/01 10:15
"RTN","HLUCM002")
0^3^B61338380
"RTN","HLUCM002",1,0)
HLUCM002 ;CIOFO-O/LJA - HL7/Capacity Mgt API ;2/27/01 10:15
"RTN","HLUCM002",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**79,88,103**;Oct 13, 1995
"RTN","HLUCM002",3,0)
 ;
"RTN","HLUCM002",4,0)
PRINTREG ; Print data in ^TMP(SUB,...) to screen
"RTN","HLUCM002",5,0)
 ; SUB,JOBN -- req
"RTN","HLUCM002",6,0)
 N DEB,GBL,IOINHI,IOINORM,JOBN,SUB,TOT,WAY,X,XTMPGBL
"RTN","HLUCM002",7,0)
 ;
"RTN","HLUCM002",8,0)
 S X="IOINHI;IOINORM" D ENDR^%ZISS
"RTN","HLUCM002",9,0)
 ;
"RTN","HLUCM002",10,0)
 W @IOF,$$CJ^XLFSTR("Print Totals Report & Debug Data to Screen",IOM)
"RTN","HLUCM002",11,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","HLUCM002",12,0)
 ;
"RTN","HLUCM002",13,0)
 S XTMPGBL=""
"RTN","HLUCM002",14,0)
 ;
"RTN","HLUCM002",15,0)
 ; What is the SUB for the Totals Report...
"RTN","HLUCM002",16,0)
 S SUB=$$SUB
"RTN","HLUCM002",17,0)
 I SUB']"" W !!,"OK! No ^TMP(TOTALS,$J) totals report will be printed..."
"RTN","HLUCM002",18,0)
 I SUB]"" D PTOT
"RTN","HLUCM002",19,0)
 ;
"RTN","HLUCM002",20,0)
 ; Debug data...
"RTN","HLUCM002",21,0)
 I '$D(^TMP($J,"HLUCMSTORE")) D
"RTN","HLUCM002",22,0)
 .  W !!,"No ^TMP($J,""HLUCMSTORE"") debug data exists..."
"RTN","HLUCM002",23,0)
 I $D(^TMP($J,"HLUCMSTORE")) D PSTORE
"RTN","HLUCM002",24,0)
 ;
"RTN","HLUCM002",25,0)
 I SUB']"",'$D(^TMP($J,"HLUCMSTORE")) D  QUIT  ;->
"RTN","HLUCM002",26,0)
 .  S X=$$BTE^HLCSMON("Press RETURN to exit... ",1)
"RTN","HLUCM002",27,0)
 ;
"RTN","HLUCM002",28,0)
 QUIT:$$BTE^HLCSMON("Press RETURN to restart, or '^' to exit... ",1)  ;->
"RTN","HLUCM002",29,0)
 ;
"RTN","HLUCM002",30,0)
 G PRINTREG ;->
"RTN","HLUCM002",31,0)
 ;
"RTN","HLUCM002",32,0)
PSTORE ;
"RTN","HLUCM002",33,0)
 W !!,$$CJ^XLFSTR("----------- "_IOINHI_"Debug Data from ^TMP($J,""HLUCMSTORE"")"_IOINORM_" -----------",IOM)
"RTN","HLUCM002",34,0)
 R !!,"Print raw DEBUG DATA (Y/N): Yes// ",X:999 S:X="" X="Y" S DEB=$$UP^XLFSTR($E(X_" ")) Q:'$T!(DEB[U)  ;->
"RTN","HLUCM002",35,0)
 I DEB="Y" D PRINTDBG^HLUCM090
"RTN","HLUCM002",36,0)
 ;
"RTN","HLUCM002",37,0)
 R !!,"Print filtered DEBUG DATA (Y/N): Yes// ",X:999 S:X="" X="Y" S DEB=$$UP^XLFSTR($E(X_" ")) Q:'$T!(DEB[U)  ;->
"RTN","HLUCM002",38,0)
 I DEB="Y" D LOOPU^HLUCM004
"RTN","HLUCM002",39,0)
 Q
"RTN","HLUCM002",40,0)
 ;
"RTN","HLUCM002",41,0)
PTOT ;
"RTN","HLUCM002",42,0)
 W !!,"You will be allowed to print report totals (from ^TMP(TOTALS,$J), and/or you"
"RTN","HLUCM002",43,0)
 W !,"may print the debug data (in ^TMP($J,""HLUCMSTORE"")."
"RTN","HLUCM002",44,0)
 W !!,$$CJ^XLFSTR("------------ "_IOINHI_"Report Totals from ^TMP("""_SUB_""",$J)"_IOINORM_" ------------",IOM)
"RTN","HLUCM002",45,0)
 R !!,"Print REPORT TOTALS (Y/N): Yes// ",X:999 S:X="" X="Y" S TOT=$$UP^XLFSTR($E(X_" ")) Q:'$T!(TOT[U)  ;->
"RTN","HLUCM002",46,0)
 I TOT="Y" D
"RTN","HLUCM002",47,0)
 .  S SUB="TOT",JOBN=$J
"RTN","HLUCM002",48,0)
 .  I '$D(^TMP(SUB,JOBN)) S SUB="KMPDH"
"RTN","HLUCM002",49,0)
 .  R !,"Include subtotals (Y/N): NO// ",WAY:999 QUIT:'$T!(WAY[U)  ;->
"RTN","HLUCM002",50,0)
 .  S:WAY']"" WAY="N"
"RTN","HLUCM002",51,0)
 .  S WAY=$$UP^XLFSTR($E(WAY_" ")),WAY=$S(WAY="N":0,1:1)
"RTN","HLUCM002",52,0)
 .  S X=$$XTMPGBL^HLUCM004(0) I X]"" S (GBL,XTMPGBL)=X W !!,"Printing from ",XTMPGBL,"..."
"RTN","HLUCM002",53,0)
 .  D PRINT1
"RTN","HLUCM002",54,0)
 Q
"RTN","HLUCM002",55,0)
 ;
"RTN","HLUCM002",56,0)
SUB() ; What subscript holds the ^TMP(SUB,$J) data?
"RTN","HLUCM002",57,0)
 N SUB
"RTN","HLUCM002",58,0)
 I $D(^TMP("KMPDH",$J)) QUIT "KMPDH" ;->
"RTN","HLUCM002",59,0)
 I $D(^TMP("TOT",$J)) QUIT "TOT" ;->
"RTN","HLUCM002",60,0)
 R !!,"Enter subscript holding the ^TMP(TOTALS,$J) data: ",SUB:999 Q:SUB[U!(SUB']"") "" ;->
"RTN","HLUCM002",61,0)
 Q SUB
"RTN","HLUCM002",62,0)
 ;
"RTN","HLUCM002",63,0)
PRINT(SUB,JOBN,WAY) ; Print data in ^TMP(SUB,...) to screen
"RTN","HLUCM002",64,0)
 ; WAY -- 0 = No totals
"RTN","HLUCM002",65,0)
 ;        1 = Totals for every section
"RTN","HLUCM002",66,0)
 N L1,L2,L3
"RTN","HLUCM002",67,0)
 ;
"RTN","HLUCM002",68,0)
 S WAY=$S($G(WAY)'>0:0,$G(WAY)=1:1,1:0)
"RTN","HLUCM002",69,0)
 ;
"RTN","HLUCM002",70,0)
 S:$G(JOBN)'>0 JOBN=$J
"RTN","HLUCM002",71,0)
 I $G(SUB)']"" D  QUIT  ;->
"RTN","HLUCM002",72,0)
 .  W !!,"You must pass in the initial subscript and $JOB number..."
"RTN","HLUCM002",73,0)
 .  W !
"RTN","HLUCM002",74,0)
PRINT1 D PRINT1^HLUCM090
"RTN","HLUCM002",75,0)
 ;
"RTN","HLUCM002",76,0)
 S GBL=$NA(^TMP($J,"HLUCMSTORE","T"))
"RTN","HLUCM002",77,0)
 S L1=0 F L2="CCX","CXC","CXX","XCC","XCX","XXC","XXX" I $D(@GBL@(L2)) S L1=1
"RTN","HLUCM002",78,0)
 QUIT:'L1  ;->
"RTN","HLUCM002",79,0)
 ;
"RTN","HLUCM002",80,0)
 W !!,"Some entries were not included in the totals.  There are 3 possible reasons"
"RTN","HLUCM002",81,0)
 W !,"for entries being excluded: (1) The beginning time of a message or unit is"
"RTN","HLUCM002",82,0)
 W !,"before the report's start time, (2) The number of seconds to transmit the"
"RTN","HLUCM002",83,0)
 W !,"message is over 1799 seconds, and (3) The protocol or namespace doesn't meet"
"RTN","HLUCM002",84,0)
 W !,"the search criteria."
"RTN","HLUCM002",85,0)
 W !!,"Failure Reason",?30,"#Characters",?42,"#Msg/Units",?54,"#Seconds"
"RTN","HLUCM002",86,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","HLUCM002",87,0)
 ;
"RTN","HLUCM002",88,0)
 F LAST="CCX","CXC","CXX","XCC","XCX","XXC","XXX" I $G(@GBL@(LAST))]"" Q
"RTN","HLUCM002",89,0)
 ;
"RTN","HLUCM002",90,0)
 S TYP="XXX",DATA=$G(@GBL@(TYP)) I DATA]"" D
"RTN","HLUCM002",91,0)
 .  D SHOW("Beginning time too early",DATA)
"RTN","HLUCM002",92,0)
 .  D SHOW("Excessive xmit time")
"RTN","HLUCM002",93,0)
 .  D SHOW("Prot/Nmsp mismatch","",1)
"RTN","HLUCM002",94,0)
 S TYP="XXC",DATA=$G(@GBL@("XXC")) I DATA]"" D
"RTN","HLUCM002",95,0)
 .  D SHOW("Beginning time too early",DATA)
"RTN","HLUCM002",96,0)
 .  D SHOW("Excessive xmit time","",1)
"RTN","HLUCM002",97,0)
 S TYP="XCX",DATA=$G(@GBL@("XCX")) I DATA]"" D
"RTN","HLUCM002",98,0)
 .  D SHOW("Beginning time too early",DATA)
"RTN","HLUCM002",99,0)
 .  D SHOW("Prot/Nmsp mismatch","",1)
"RTN","HLUCM002",100,0)
 S TYP="XCC",DATA=$G(@GBL@("XCC")) I DATA]"" D
"RTN","HLUCM002",101,0)
 .  D SHOW("Beginning time too early",DATA,1)
"RTN","HLUCM002",102,0)
 S TYP="CXX",DATA=$G(@GBL@("CXX")) I DATA]"" D
"RTN","HLUCM002",103,0)
 .  D SHOW("Excessive xmit time",DATA)
"RTN","HLUCM002",104,0)
 .  D SHOW("Prot/Nmsp mismatch","",1)
"RTN","HLUCM002",105,0)
 S TYP="CXC",DATA=$G(@GBL@("CXC")) I DATA]"" D
"RTN","HLUCM002",106,0)
 .  D SHOW("Excessive xmit time",DATA,1)
"RTN","HLUCM002",107,0)
 S TYP="CCX",DATA=$G(@GBL@("CCX")) I DATA]"" D
"RTN","HLUCM002",108,0)
 .  D SHOW("Prot/Nmsp mismatch",DATA,1)
"RTN","HLUCM002",109,0)
 I L1!L2!L3 W !,$$REPEAT^XLFSTR("=",IOM),!,"Totals:",?30,$J(L1,7),?42,$J(L2,7),?54,$J(L3,7)
"RTN","HLUCM002",110,0)
 ;
"RTN","HLUCM002",111,0)
 Q
"RTN","HLUCM002",112,0)
 ;
"RTN","HLUCM002",113,0)
SHOW(REA,DATA,LINE) ;
"RTN","HLUCM002",114,0)
 ; LAST,TYP -- req
"RTN","HLUCM002",115,0)
 S DATA=$G(DATA),LINE=$G(LINE)
"RTN","HLUCM002",116,0)
 W !,REA
"RTN","HLUCM002",117,0)
 I $G(DATA)]"" W ?30,$J($P(DATA,U),7),?42,$J($P(DATA,U,2),7),?54,$J($P(DATA,U,3),7)
"RTN","HLUCM002",118,0)
 I $G(LINE),TYP'=LAST W !,$$REPEAT^XLFSTR("-",IOM)
"RTN","HLUCM002",119,0)
 S L1=$G(L1)+$P(DATA,U),L2=$G(L2)+$P(DATA,U,2),L3=$G(L3)+$P(DATA,U,3)
"RTN","HLUCM002",120,0)
 QUIT
"RTN","HLUCM002",121,0)
 ;
"RTN","HLUCM002",122,0)
ADD(TL) ; Add to TOT...
"RTN","HLUCM002",123,0)
 S $P(TOT,U)=$P(TOT,U)+$P(TL,U)
"RTN","HLUCM002",124,0)
 S $P(TOT,U,2)=$P(TOT,U,2)+$P(TL,U,2)
"RTN","HLUCM002",125,0)
 S $P(TOT,U,3)=$P(TOT,U,3)+$P(TL,U,3)
"RTN","HLUCM002",126,0)
 Q
"RTN","HLUCM002",127,0)
 ;
"RTN","HLUCM002",128,0)
OKPAR(PAR) ; Is namespace or protocol OK?
"RTN","HLUCM002",129,0)
 S PAR=$G(PAR)
"RTN","HLUCM002",130,0)
 I PAR=1!(PAR=2) QUIT 1 ;->
"RTN","HLUCM002",131,0)
 I $$OK0CALL(PAR) QUIT 1 ;->
"RTN","HLUCM002",132,0)
 QUIT ""
"RTN","HLUCM002",133,0)
 ;
"RTN","HLUCM002",134,0)
OK0CALL(PAR) ; Correct 0^IEN or 0^NAME call format?
"RTN","HLUCM002",135,0)
 I $E(PAR,1,2)="0^"&($E(PAR,3)]"") QUIT 1 ;->
"RTN","HLUCM002",136,0)
 QUIT ""
"RTN","HLUCM002",137,0)
 ;
"RTN","HLUCM002",138,0)
TYPETMO(IEN772) ; Is this TCP, Mail (via TCP), or Other?
"RTN","HLUCM002",139,0)
 N D772,I773,MIEN
"RTN","HLUCM002",140,0)
 ;
"RTN","HLUCM002",141,0)
 ; RELATED MAILMAN MESSAGE field (0;5) in 772...
"RTN","HLUCM002",142,0)
 S D772=$G(^HL(772,+IEN772,0)) ; Get node
"RTN","HLUCM002",143,0)
 S MIEN=$P(D772,U,5) ; get Mailman IEN from field...
"RTN","HLUCM002",144,0)
 I MIEN QUIT "M" ;-> Mailman via TCP
"RTN","HLUCM002",145,0)
 ;
"RTN","HLUCM002",146,0)
 ; There are rare instances when RELATED MAILMAN MESSAGE field is
"RTN","HLUCM002",147,0)
 ; not filled in, but the LLP TYPE in 870 is Mailman.  So, the next
"RTN","HLUCM002",148,0)
 ; check is needed...
"RTN","HLUCM002",149,0)
 ;
"RTN","HLUCM002",150,0)
 ; Get related 870 and check it's LLP TYPE...
"RTN","HLUCM002",151,0)
 I $P($G(^HLCS(870,+$$IEN870^HLUCM009(+IEN772),0)),U,3)=1 QUIT "M" ;->
"RTN","HLUCM002",152,0)
 ;
"RTN","HLUCM002",153,0)
 ; OK.  Let's give up on proving this 772 entry a Mailman entry.
"RTN","HLUCM002",154,0)
 ; But, is it TCP?
"RTN","HLUCM002",155,0)
 ;
"RTN","HLUCM002",156,0)
 ; Check if TCP by 773 link...
"RTN","HLUCM002",157,0)
 S I773=$O(^HLMA("B",+IEN772,0))
"RTN","HLUCM002",158,0)
 I I773>0 QUIT "T" ;->
"RTN","HLUCM002",159,0)
 ;
"RTN","HLUCM002",160,0)
 QUIT "U" ; Other...
"RTN","HLUCM002",161,0)
 ;
"RTN","HLUCM002",162,0)
TYPEIO(IEN772) ; Is this Input or Output or Unknown?
"RTN","HLUCM002",163,0)
 N D772,HLIO
"RTN","HLUCM002",164,0)
 S D772=$G(^HL(772,+IEN772,0))
"RTN","HLUCM002",165,0)
 S HLIO=$E($P(D772,U,4)_" ")
"RTN","HLUCM002",166,0)
 QUIT $S("IO"[HLIO:HLIO,1:"U")
"RTN","HLUCM002",167,0)
 ;
"RTN","HLUCM002",168,0)
PROTNMSP(IEN772) ; Return PROT~NMSP value to store in ^TMP.  
"RTN","HLUCM002",169,0)
 ; COND,IEN101,PNMSP -- req
"RTN","HLUCM002",170,0)
 N CT,FAIL,PCKG,CTPROT,PCKG,PROT
"RTN","HLUCM002",171,0)
 ;
"RTN","HLUCM002",172,0)
 S IEN101=$G(IEN101),PNMSP=$G(PNMSP)
"RTN","HLUCM002",173,0)
 ;
"RTN","HLUCM002",174,0)
 ; ======================== PROTOCOL ============================
"RTN","HLUCM002",175,0)
 ; Get actual protocol in IEN772 if not supposed to "lump"...
"RTN","HLUCM002",176,0)
 S PROT=$S(IEN101'=2:$$GETPROT^HLUCM050(+IEN772),1:"ZZZ")
"RTN","HLUCM002",177,0)
 ;
"RTN","HLUCM002",178,0)
 ; Don't lose count if supposed to check everything...
"RTN","HLUCM002",179,0)
 I IEN101=1!(IEN101=2) D
"RTN","HLUCM002",180,0)
 .  I PROT']"" S PROT="ZZZ" QUIT  ;->
"RTN","HLUCM002",181,0)
 .  I IEN101=2 S PROT="ZZZ"
"RTN","HLUCM002",182,0)
 ;
"RTN","HLUCM002",183,0)
 ; Is the protocol countable?  (Must also check namespace)
"RTN","HLUCM002",184,0)
 S CTPROT=$$CTPROT^HLUCM003(PROT)
"RTN","HLUCM002",185,0)
 ;
"RTN","HLUCM002",186,0)
 ; ======================== NAMESPACE ============================
"RTN","HLUCM002",187,0)
 ; Set package here and now...
"RTN","HLUCM002",188,0)
 S PCKG=$S(PNMSP'=2:$$GETNMSP^HLUCM050(+IEN772),1:"ZZZ")
"RTN","HLUCM002",189,0)
 ;
"RTN","HLUCM002",190,0)
 I PNMSP=1!(PNMSP=2) D
"RTN","HLUCM002",191,0)
 .  I PCKG']"" S PCKG="ZZZ" QUIT  ;->
"RTN","HLUCM002",192,0)
 .  I PNMSP=2 S PCKG="ZZZ"
"RTN","HLUCM002",193,0)
 ;
"RTN","HLUCM002",194,0)
 S CTPCKG=$$CTPCKG^HLUCM003(PCKG)
"RTN","HLUCM002",195,0)
 ;
"RTN","HLUCM002",196,0)
 ;
"RTN","HLUCM002",197,0)
 ; Set up what should be returned...  
"RTN","HLUCM002",198,0)
 S PROT=$S(PROT=2:"ZZZ",1:PROT),PCKG=$S(PCKG=2:"ZZZ",1:PCKG)
"RTN","HLUCM002",199,0)
 ; If MIXED make sure the ALL side of things is set to something
"RTN","HLUCM002",200,0)
 ; so the ALL side doesn't squelch a SPECIFIC match...
"RTN","HLUCM002",201,0)
 I $$MIXED D
"RTN","HLUCM002",202,0)
 .  I $G(PNMSP)=1!($G(PNMSP)=2) D
"RTN","HLUCM002",203,0)
 .  .  QUIT:PROT]""  ;->
"RTN","HLUCM002",204,0)
 .  .  QUIT:'CTPROT  ;-> Not to be counted anyway...
"RTN","HLUCM002",205,0)
 .  .  S PROT="ZZZ~0"
"RTN","HLUCM002",206,0)
 .  I $G(IEN101)=1!($G(IEN101)=2) D
"RTN","HLUCM002",207,0)
 .  .  QUIT:PCKG]""  ;->
"RTN","HLUCM002",208,0)
 .  .  QUIT:'CTPCKG  ;-> Not to be counted anyway...
"RTN","HLUCM002",209,0)
 .  .  S PCKG="ZZZ"
"RTN","HLUCM002",210,0)
 I '$$MIXED,COND="EITHER" D
"RTN","HLUCM002",211,0)
 .  QUIT:$$ALL($G(PNMSP),$G(IEN101))  ;-> All 1s or 2s...
"RTN","HLUCM002",212,0)
 .  I NMSPTYPE'=1 D  ; Asked specifically...
"RTN","HLUCM002",213,0)
 .  .  QUIT:PROT]""  ;->
"RTN","HLUCM002",214,0)
 .  .  S PROT="ZZZ~0"
"RTN","HLUCM002",215,0)
 .  I PROTYPE'=1 D  ; Asked specifically...
"RTN","HLUCM002",216,0)
 .  .  QUIT:PCKG]""  ;->
"RTN","HLUCM002",217,0)
 .  .  S PCKG="ZZZ"
"RTN","HLUCM002",218,0)
 ;
"RTN","HLUCM002",219,0)
 ; If neither should be counted, don't...
"RTN","HLUCM002",220,0)
 I 'CTPROT&('CTPCKG) QUIT U ;->
"RTN","HLUCM002",221,0)
 ;
"RTN","HLUCM002",222,0)
 ; Either namespace or protocol matches, or both match...
"RTN","HLUCM002",223,0)
 ;
"RTN","HLUCM002",224,0)
 ; If BOTH namespace and protocol are required to match, don't count if one isn't a match...
"RTN","HLUCM002",225,0)
 I COND="BOTH" I 'CTPROT!('CTPCKG) QUIT U ;->
"RTN","HLUCM002",226,0)
 ;
"RTN","HLUCM002",227,0)
 ; If 1/2 & SPECIFIC (i.e., MIXED), then SPECIFIC trumps 1/2...
"RTN","HLUCM002",228,0)
 ; (If SPECIFIC not matched, it is not counted)
"RTN","HLUCM002",229,0)
 I $$MIXED D  QUIT:FAIL U ;->
"RTN","HLUCM002",230,0)
 .  S FAIL=1
"RTN","HLUCM002",231,0)
 .  ; If ALL NMSPs to be counted, but specific PROT fails... BAD!
"RTN","HLUCM002",232,0)
 .  I $G(PNMSP)=1!($G(PNMSP)=2) QUIT:'CTPROT  ;->
"RTN","HLUCM002",233,0)
 .  ; If ALL PROTs to be counted, but specific PCKG fails... BAD!
"RTN","HLUCM002",234,0)
 .  I $G(IEN101)=1!($G(IEN101)=2) QUIT:'CTPCKG  ;->
"RTN","HLUCM002",235,0)
 .  S FAIL=0
"RTN","HLUCM002",236,0)
 ;
"RTN","HLUCM002",237,0)
 QUIT PROT_U_PCKG
"RTN","HLUCM002",238,0)
 ;
"RTN","HLUCM002",239,0)
ALL(V1,V2) ; Are both 1 or 2?
"RTN","HLUCM002",240,0)
 S V1=$G(V1),V2=$G(V2)
"RTN","HLUCM002",241,0)
 QUIT:V1'=1&(V1'=2) "" ;->
"RTN","HLUCM002",242,0)
 QUIT:V2'=1&(V2'=2) "" ;->
"RTN","HLUCM002",243,0)
 QUIT 1
"RTN","HLUCM002",244,0)
 ;
"RTN","HLUCM002",245,0)
MIXED() ; Is one 1/2 and the other SPECIFIC?
"RTN","HLUCM002",246,0)
 N V3
"RTN","HLUCM002",247,0)
 S V1=$G(PNMSP),V1=$S(V1]"":$S(V1=1!(V1=2):1,1:0),1:0)
"RTN","HLUCM002",248,0)
 S V2=$G(IEN101),V2=$S(V2]"":$S(V2=1!(V2=2):1,1:0),1:0)
"RTN","HLUCM002",249,0)
 S V1=$S(V1=1!(V1=2):1,1:0)
"RTN","HLUCM002",250,0)
 S V2=$S(V2=1!(V2=2):1,1:0)
"RTN","HLUCM002",251,0)
 S V3=V1+V2
"RTN","HLUCM002",252,0)
 QUIT $S(V3=1:1,1:"")
"RTN","HLUCM002",253,0)
 ;
"RTN","HLUCM002",254,0)
PROT101(IEN772) ; Return 101 information...
"RTN","HLUCM002",255,0)
 N IEN,MIEN,NM
"RTN","HLUCM002",256,0)
 ;
"RTN","HLUCM002",257,0)
 ; Get normal protocol information
"RTN","HLUCM002",258,0)
 S IEN=$P($G(^HL(772,IEN772,0)),U,10)
"RTN","HLUCM002",259,0)
 S NM=$P($G(^ORD(101,+IEN,0)),U)
"RTN","HLUCM002",260,0)
 ;
"RTN","HLUCM002",261,0)
 ; Maybe this is a Mailman ptr only...
"RTN","HLUCM002",262,0)
 I NM']"",IEN'>0 D
"RTN","HLUCM002",263,0)
 .  S MIEN=$P($G(^HL(772,+IEN772,0)),U,5) QUIT:MIEN'>0  ;->
"RTN","HLUCM002",264,0)
 .  S NM="XMB",IEN=9999999
"RTN","HLUCM002",265,0)
 ;
"RTN","HLUCM002",266,0)
 QUIT $S(NM]""!(IEN>0):NM_"~"_IEN,1:"")
"RTN","HLUCM002",267,0)
 ;
"RTN","HLUCM002",268,0)
EOR ; HLUCM002 - HL7/Capacity Mgt API ;2/27/01 10:15
"RTN","HLUCM003")
0^4^B51926899
"RTN","HLUCM003",1,0)
HLUCM003 ;CIOFO-O/LJA - HL7/Capacity Mgt API-II ;10/23/01 12:01
"RTN","HLUCM003",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**88,103**;Oct 13, 1995
"RTN","HLUCM003",3,0)
 ;
"RTN","HLUCM003",4,0)
ADJTIME ; Adjust ^TMP times on basis of unit...
"RTN","HLUCM003",5,0)
 N IENPAR
"RTN","HLUCM003",6,0)
 S IENPAR=0
"RTN","HLUCM003",7,0)
 F  S IENPAR=$O(^TMP($J,"HLPARENT",IENPAR)) Q:'IENPAR  D
"RTN","HLUCM003",8,0)
 .  D ADJPAR(+IENPAR)
"RTN","HLUCM003",9,0)
 Q
"RTN","HLUCM003",10,0)
 ;
"RTN","HLUCM003",11,0)
ADJPAR(IENPAR) ; Adjust times for one unit...
"RTN","HLUCM003",12,0)
 N BEG,DATA,END,IEN772,NUM,PREVTM,TIME
"RTN","HLUCM003",13,0)
 ;
"RTN","HLUCM003",14,0)
 S NUM=0,IEN772=0
"RTN","HLUCM003",15,0)
 F  S IEN772=$O(^TMP($J,"HLPARENT",+IENPAR,IEN772)) Q:'IEN772  D
"RTN","HLUCM003",16,0)
 .  S NUM=NUM+1
"RTN","HLUCM003",17,0)
 ;
"RTN","HLUCM003",18,0)
 ; No adjustments necessary if only one message...
"RTN","HLUCM003",19,0)
 QUIT:NUM'>1  ;->
"RTN","HLUCM003",20,0)
 ;
"RTN","HLUCM003",21,0)
 ; Find all times...
"RTN","HLUCM003",22,0)
 S IEN772=0
"RTN","HLUCM003",23,0)
 F  S IEN772=$O(^TMP($J,"HLPARENT",+IENPAR,IEN772)) Q:IEN772'>0  D
"RTN","HLUCM003",24,0)
 .  S DATA=$P($G(^TMP($J,"HLCHILD",+IEN772)),"~",2,999) QUIT:DATA']""  ;->
"RTN","HLUCM003",25,0)
 .  S X=$P(DATA,U,4) I X?7N.E S TIME(X)=""
"RTN","HLUCM003",26,0)
 .  S X=$P(DATA,U,5) I X?7N.E S TIME(X)=""
"RTN","HLUCM003",27,0)
 ;
"RTN","HLUCM003",28,0)
 S BEG=$O(TIME(0)),END=$O(TIME(":"),-1)
"RTN","HLUCM003",29,0)
 ;
"RTN","HLUCM003",30,0)
 ; Set 1st time and last time...
"RTN","HLUCM003",31,0)
 S IEN772=$O(^TMP($J,"HLPARENT",+IENPAR,0)) Q:IEN772'>0  ;->
"RTN","HLUCM003",32,0)
 D CORRECT(+IENPAR,+IEN772,4,BEG)
"RTN","HLUCM003",33,0)
 S IEN772=$O(^TMP($J,"HLPARENT",+IENPAR,":"),-1) QUIT:IEN772'>0  ;->
"RTN","HLUCM003",34,0)
 D CORRECT(+IENPAR,+IEN772,5,END)
"RTN","HLUCM003",35,0)
 ;
"RTN","HLUCM003",36,0)
 ; Make other corrections...
"RTN","HLUCM003",37,0)
 S IEN772=0,PREVTM=""
"RTN","HLUCM003",38,0)
 F  S IEN772=$O(^TMP($J,"HLPARENT",+IENPAR,IEN772)) Q:IEN772'>0  D
"RTN","HLUCM003",39,0)
 .  S DATA=$P($G(^TMP($J,"HLCHILD",+IEN772)),"~",2,999) QUIT:DATA']""  ;->
"RTN","HLUCM003",40,0)
 .  S TIME(1)=$P(DATA,U,4),TIME(2)=$P(DATA,U,5)
"RTN","HLUCM003",41,0)
 .
"RTN","HLUCM003",42,0)
 .  ; If first time thru...
"RTN","HLUCM003",43,0)
 .  I PREVTM="" D  QUIT  ;->
"RTN","HLUCM003",44,0)
 .  .  I TIME(1)=TIME(2) S PREVTM=TIME(2) QUIT  ;->
"RTN","HLUCM003",45,0)
 .  .  ; Set 1st entry's time to START=START (0 seconds)
"RTN","HLUCM003",46,0)
 .  .  D CORRECT(+IENPAR,+IEN772,5,TIME(1))
"RTN","HLUCM003",47,0)
 .  .  S PREVTM=TIME(1)
"RTN","HLUCM003",48,0)
 .
"RTN","HLUCM003",49,0)
 .  I TIME(1)'=PREVTM D
"RTN","HLUCM003",50,0)
 .  .  D CORRECT(+IENPAR,+IEN772,4,PREVTM)
"RTN","HLUCM003",51,0)
 .  .  S TIME(1)=PREVTM
"RTN","HLUCM003",52,0)
 .
"RTN","HLUCM003",53,0)
 .  I TIME(1)>TIME(2) D
"RTN","HLUCM003",54,0)
 .  .  D CORRECT(+IENPAR,+IEN772,5,TIME(1))
"RTN","HLUCM003",55,0)
 .  .  S TIME(2)=TIME(1)
"RTN","HLUCM003",56,0)
 .
"RTN","HLUCM003",57,0)
 .  S PREVTM=TIME(2)
"RTN","HLUCM003",58,0)
 .  
"RTN","HLUCM003",59,0)
 Q
"RTN","HLUCM003",60,0)
 ;
"RTN","HLUCM003",61,0)
CORRECT(PAR,CHLDIEN,PCE,NEW) ; Change CHILD data...
"RTN","HLUCM003",62,0)
 N BEG,CHILD,DIFF,END,SEC,STORE
"RTN","HLUCM003",63,0)
 ;
"RTN","HLUCM003",64,0)
 ; Get CHILD and quit if no changes...
"RTN","HLUCM003",65,0)
 S HLCHILD=$G(^TMP($J,"HLCHILD",+CHLDIEN)) QUIT:$P(HLCHILD,U,PCE)=NEW  ;->
"RTN","HLUCM003",66,0)
 ;
"RTN","HLUCM003",67,0)
 ; Put new value into CHILD...
"RTN","HLUCM003",68,0)
 S $P(CHILD,U,PCE)=NEW
"RTN","HLUCM003",69,0)
 ;
"RTN","HLUCM003",70,0)
 ;Calculate SEC difference and set into CHILD...
"RTN","HLUCM003",71,0)
 S BEG=$P(CHILD,U,4),END=$P(CHILD,U,5)
"RTN","HLUCM003",72,0)
 S DIFF=$$FMDIFF^XLFDT(END,BEG,2)
"RTN","HLUCM003",73,0)
 S $P(CHILD,U,3)=DIFF
"RTN","HLUCM003",74,0)
 ;
"RTN","HLUCM003",75,0)
 ; Store data...
"RTN","HLUCM003",76,0)
 S ^TMP($J,"HLCHILD",+CHLDIEN)=HLCHILD
"RTN","HLUCM003",77,0)
 ;
"RTN","HLUCM003",78,0)
 Q
"RTN","HLUCM003",79,0)
 ;
"RTN","HLUCM003",80,0)
RECNM(PFX,IEN772,FULLNM,REPNM,SRCE) ; Record where name found...
"RTN","HLUCM003",81,0)
 ; PFX - [n] for namespace, and [p] for protocol
"RTN","HLUCM003",82,0)
 ; IEN772 - IEN of 772
"RTN","HLUCM003",83,0)
 ; FULLNM - What is in entry itself, uninferred...
"RTN","HLUCM003",84,0)
 ; REPNM - What is to be reported
"RTN","HLUCM003",85,0)
 ; SRCE - Where it was inferred from
"RTN","HLUCM003",86,0)
 ;
"RTN","HLUCM003",87,0)
 QUIT:$G(^TMP($J,"HLUCM"))'="DEBUG GLOBAL"  ;->
"RTN","HLUCM003",88,0)
 ;
"RTN","HLUCM003",89,0)
 S REPNM=$G(PFX)_REPNM
"RTN","HLUCM003",90,0)
 ;
"RTN","HLUCM003",91,0)
 S ^TMP($J,"HLRECNM")=$G(^TMP($J,"HLRECNM"))+1
"RTN","HLUCM003",92,0)
 S ^TMP($J,"HLRECNM",REPNM)=$G(^TMP($J,"HLRECNM",REPNM))+1
"RTN","HLUCM003",93,0)
 S ^TMP($J,"HLRECNM",REPNM,SRCE)=$G(^TMP($J,"HLRECNM",REPNM,SRCE))+1
"RTN","HLUCM003",94,0)
 S ^TMP($J,"HLRECNM",REPNM,SRCE,IEN772)=FULLNM
"RTN","HLUCM003",95,0)
 ;
"RTN","HLUCM003",96,0)
 QUIT
"RTN","HLUCM003",97,0)
 ;
"RTN","HLUCM003",98,0)
MSHMAIL(IEN772) ;
"RTN","HLUCM003",99,0)
 N CT,INOUT,MIEN,NIEN,PCKG,RECNM,TXT,X,XMER,XMPOS,XMRG,XMZ
"RTN","HLUCM003",100,0)
 S MIEN=$P($G(^HL(772,+IEN772,0)),U,5) QUIT:MIEN'>0 "" ;->
"RTN","HLUCM003",101,0)
 S INOUT=$P(^HL(772,+IEN772,0),U,4)
"RTN","HLUCM003",102,0)
 S INOUT=$S(INOUT="I":5,1:3)
"RTN","HLUCM003",103,0)
 S CT=0,PCKG="",XMZ=+MIEN,XMER=0
"RTN","HLUCM003",104,0)
 F  D  QUIT:CT>10!(PCKG]"")!($E(TXT,1,3)="MSH")!(XMER'=0)
"RTN","HLUCM003",105,0)
 .  S CT=CT+1
"RTN","HLUCM003",106,0)
 .  D REC^XMS3
"RTN","HLUCM003",107,0)
 .  S TXT=$G(XMRG) QUIT:$E(TXT,1,3)'="MSH"  ;->
"RTN","HLUCM003",108,0)
 .  S X=$E(TXT,4),RECNM=$P(TXT,X,INOUT)
"RTN","HLUCM003",109,0)
 .  S PCKG=$$PCKGMSH(TXT,INOUT)
"RTN","HLUCM003",110,0)
 .  D RECNM("[n]",IEN772,RECNM,PCKG,"MAIL")
"RTN","HLUCM003",111,0)
 QUIT PCKG
"RTN","HLUCM003",112,0)
 ;
"RTN","HLUCM003",113,0)
MSH772(IEN772) ; Get PCKG from MSH segment in 772...
"RTN","HLUCM003",114,0)
 ; Call here ONLY if can't get MSH segment from 773...
"RTN","HLUCM003",115,0)
 N CT,IN,INOUT,PCKG,RECNM,TXT,X
"RTN","HLUCM003",116,0)
 S IN=0,CT=0,PCKG=""
"RTN","HLUCM003",117,0)
 S INOUT=$$INOUT(+IEN772)
"RTN","HLUCM003",118,0)
 F  S IN=$O(^HL(772,+IEN772,"IN",IN)) Q:IN'>0!(CT>10)!(PCKG]"")  D
"RTN","HLUCM003",119,0)
 .  S CT=CT+1
"RTN","HLUCM003",120,0)
 .  S TXT=$G(^HL(772,+IEN772,"IN",+IN,0)) QUIT:TXT']""  ;->
"RTN","HLUCM003",121,0)
 .  QUIT:$E(TXT,1,3)'="MSH"  ;->
"RTN","HLUCM003",122,0)
 .  S X=$E(TXT,4),RECNM=$P(TXT,X,INOUT)
"RTN","HLUCM003",123,0)
 .  S PCKG=$$PCKGMSH(TXT,INOUT)
"RTN","HLUCM003",124,0)
 .  D RECNM("[n]",IEN772,RECNM,PCKG,772)
"RTN","HLUCM003",125,0)
 QUIT PCKG
"RTN","HLUCM003",126,0)
 ;
"RTN","HLUCM003",127,0)
MSH773(IEN772) ; Get PCKG from MSH segment in 773...
"RTN","HLUCM003",128,0)
 N IEN773,INOUT,MSH,PCKG,RECNM,X
"RTN","HLUCM003",129,0)
 S IEN773=$O(^HLMA("B",IEN772,0)) QUIT:IEN773'>0 "" ;->
"RTN","HLUCM003",130,0)
 S INOUT=$$INOUT(IEN772)
"RTN","HLUCM003",131,0)
 S MSH=$G(^HLMA(+IEN773,"MSH",1,0)) QUIT:MSH']"" "" ;->
"RTN","HLUCM003",132,0)
 S X=$E(MSH,4),RECNM=$P(MSH,X,INOUT)
"RTN","HLUCM003",133,0)
 S PCKG=$$PCKGMSH(MSH,INOUT)
"RTN","HLUCM003",134,0)
 I PCKG="VAMC" D
"RTN","HLUCM003",135,0)
 .  N NMSP
"RTN","HLUCM003",136,0)
 .  S NMSP=PCKG,INOUT=$S(INOUT=5:3,1:3)
"RTN","HLUCM003",137,0)
 .  S X=$E(MSH,4),RECNM=$P(MSH,X,INOUT)
"RTN","HLUCM003",138,0)
 .  S PCKG=$$PCKGMSH(MSH,INOUT) QUIT:$$PCKGMSH(MSH,INOUT)]""  ;->
"RTN","HLUCM003",139,0)
 .  S PCKG=NMSP ; Reset
"RTN","HLUCM003",140,0)
 D RECNM("[n]",IEN772,RECNM,PCKG,773)
"RTN","HLUCM003",141,0)
 QUIT PCKG
"RTN","HLUCM003",142,0)
 ;
"RTN","HLUCM003",143,0)
INOUT(IEN772) ;
"RTN","HLUCM003",144,0)
 N INOUT
"RTN","HLUCM003",145,0)
 S INOUT=$P($G(^HL(772,+IEN772,0)),U,4)
"RTN","HLUCM003",146,0)
 S INOUT=$S(INOUT="I":5,1:3) ; Default to O, which is case in HEC error
"RTN","HLUCM003",147,0)
 QUIT INOUT
"RTN","HLUCM003",148,0)
 ;
"RTN","HLUCM003",149,0)
PCKGMSH(MSH,INOUT) ; Extract PCKG namespace from MSH segment
"RTN","HLUCM003",150,0)
 N DEL,PFROM
"RTN","HLUCM003",151,0)
 S DEL=$E(MSH,4),INOUT=$S($G(INOUT):INOUT,1:3)
"RTN","HLUCM003",152,0)
 S PFROM=$P(MSH,DEL,INOUT) QUIT:PFROM']"" "" ;->
"RTN","HLUCM003",153,0)
 QUIT $$FIXNMSP^HLUCM003(PFROM)
"RTN","HLUCM003",154,0)
 ;
"RTN","HLUCM003",155,0)
ERRCHK ; Error checks...
"RTN","HLUCM003",156,0)
 ;
"RTN","HLUCM003",157,0)
 ; DATE checks...
"RTN","HLUCM003",158,0)
 S START=+$G(START),END=+$G(END)
"RTN","HLUCM003",159,0)
 I START'?7N&(START'?7N1"."1.N) D ERR^HLUCM("INVALID START TIME")
"RTN","HLUCM003",160,0)
 I END'?7N&(END'?7N1"."1.N) D ERR^HLUCM("INVALID END TIME")
"RTN","HLUCM003",161,0)
 I '$D(ERRINFO("INVALID START TIME")) D
"RTN","HLUCM003",162,0)
 .  I '$D(ERRINFO("INVALID END TIME")) D
"RTN","HLUCM003",163,0)
 .  .  I START=END!(START<END) QUIT  ;->
"RTN","HLUCM003",164,0)
 .  .  D ERR^HLUCM("END TIME PRECEDES START TIME")
"RTN","HLUCM003",165,0)
 ;
"RTN","HLUCM003",166,0)
 ; If condition=BOTH, can't be ALL(1/2) and ALL(1/2) or
"RTN","HLUCM003",167,0)
 ; ALL(1/2) and SPECIFIC. BOTH can only be SPECIFIC and SPECIFIC.
"RTN","HLUCM003",168,0)
 I COND="BOTH" D
"RTN","HLUCM003",169,0)
 .  N P1,P2,P3
"RTN","HLUCM003",170,0)
 .  S P1=$S($G(PNMSP)>0:1,1:0) ; namespace 0/1
"RTN","HLUCM003",171,0)
 .  S P2=$S($G(IEN101)>0:1,1:0) ; protocol 0/1
"RTN","HLUCM003",172,0)
 .  S P3=P1+P2 QUIT:P3'>0  ;->
"RTN","HLUCM003",173,0)
 .  D ERR^HLUCM("BOTH NAMESPACES(S) AND PROTOCOL(S) MUST BE PASSED SPECIFICALLY")
"RTN","HLUCM003",174,0)
 QUIT
"RTN","HLUCM003",175,0)
 ;
"RTN","HLUCM003",176,0)
SETMORE ; More defaults...
"RTN","HLUCM003",177,0)
 ; 
"RTN","HLUCM003",178,0)
 ; Check format of PNMSP...
"RTN","HLUCM003",179,0)
 ; If not passed by reference...
"RTN","HLUCM003",180,0)
 I 'NMSPTYPE D  ; Namespace(s) not passed as an array
"RTN","HLUCM003",181,0)
 .  ; Passed as 1 or 2 or O^NMSP, but is it valid?
"RTN","HLUCM003",182,0)
 .  I '$$OKPAR^HLUCM002(PNMSP) D
"RTN","HLUCM003",183,0)
 .  .  D ERR^HLUCM("INVALID NAMESPACE PARAMETER")
"RTN","HLUCM003",184,0)
 ;
"RTN","HLUCM003",185,0)
 ; Check format of IEN101...
"RTN","HLUCM003",186,0)
 ; If not passed by reference...
"RTN","HLUCM003",187,0)
 I 'PROTYPE D  ; Protocol(s) not passed as an array
"RTN","HLUCM003",188,0)
 .  ; Passed as 1 or 2 or 0^PROT or 0^IEN, but is it valid?
"RTN","HLUCM003",189,0)
 .  I '$$OKPAR^HLUCM002(IEN101) D  ; Check format...
"RTN","HLUCM003",190,0)
 .  .  D ERR^HLUCM("INVALID PROTOCOL PARAMETER")
"RTN","HLUCM003",191,0)
 .  S IEN101=$$OKPAR101^HLUCM001($G(IEN101)) I IEN101']"" D
"RTN","HLUCM003",192,0)
 .  .  I $D(ERRINFO("INVALID PROTOCOL PARAMETER")) QUIT  ;->
"RTN","HLUCM003",193,0)
 .  .  QUIT:IEN101["0^9999999"  ;->
"RTN","HLUCM003",194,0)
 .  .  D ERR^HLUCM("CAN'T FIND PROTOCOL")
"RTN","HLUCM003",195,0)
 QUIT
"RTN","HLUCM003",196,0)
 ;
"RTN","HLUCM003",197,0)
FIXNMSP(PCKG,I772) ; First space piece, strip _
"RTN","HLUCM003",198,0)
 N APPR,APPS,FACR,FACS,I773,MSH
"RTN","HLUCM003",199,0)
 ;
"RTN","HLUCM003",200,0)
 S I772=+$G(I772)
"RTN","HLUCM003",201,0)
 ;
"RTN","HLUCM003",202,0)
 ; Get 773 (or 772)-related information...
"RTN","HLUCM003",203,0)
 S I773=$O(^HLMA("B",+I772,0))
"RTN","HLUCM003",204,0)
 S MSH=$G(^HLMA(+I773,"MSH",1,0))
"RTN","HLUCM003",205,0)
 I MSH']"" S X=$G(^HL(772,+I772,"IN",1,0)) S:$E(X,1,3)=MSH MSH=X
"RTN","HLUCM003",206,0)
 S X=$E(MSH,4),APPS=$P(MSH,X,3),FACS=$P(MSH,X,4),APPR=$P(MSH,X,5),FACR=$P(MSH,X,6)
"RTN","HLUCM003",207,0)
 ;
"RTN","HLUCM003",208,0)
 S PCKG=$$NMSPCHG^HLUCM050(PCKG)
"RTN","HLUCM003",209,0)
 ;
"RTN","HLUCM003",210,0)
 QUIT $TR($E($P($P(PCKG," "),"-"),1,4),"_ ","") ;->
"RTN","HLUCM003",211,0)
 ;
"RTN","HLUCM003",212,0)
CTPCKG(PCKG) ; Should entry be counted on basis of package?
"RTN","HLUCM003",213,0)
 ; (Might be countable if protocol matches remember.)
"RTN","HLUCM003",214,0)
 ; If list of packages passed by reference, is PCKG in array?
"RTN","HLUCM003",215,0)
 ; IEN101,NMSPTYPE,PNMSP -- req
"RTN","HLUCM003",216,0)
 N CTPCKG
"RTN","HLUCM003",217,0)
 ;
"RTN","HLUCM003",218,0)
 ; Must count everything...
"RTN","HLUCM003",219,0)
 I $G(PNMSP)=1!($G(PNMSP)=2) QUIT 1 ;->
"RTN","HLUCM003",220,0)
 ;
"RTN","HLUCM003",221,0)
 ; If passed namspace by array, is PCKG in array?
"RTN","HLUCM003",222,0)
 I NMSPTYPE=1 QUIT $S($$REFPCKG^HLUCM001(PCKG):1,1:"") ;->
"RTN","HLUCM003",223,0)
 ;
"RTN","HLUCM003",224,0)
 ; If passed in "0^NAMESPACE" format...
"RTN","HLUCM003",225,0)
 I $$OK0CALL^HLUCM002(PNMSP) D  QUIT $S(PCKG]"":1,1:"") ;->
"RTN","HLUCM003",226,0)
 .  I $P(PNMSP,U,2)'=PCKG S PCKG=""
"RTN","HLUCM003",227,0)
 ;
"RTN","HLUCM003",228,0)
 QUIT ""
"RTN","HLUCM003",229,0)
 ;
"RTN","HLUCM003",230,0)
CTPROT(PROT) ; Should entry be counted on basis of protocol?
"RTN","HLUCM003",231,0)
 ; (Might be countable if package matches remember.)
"RTN","HLUCM003",232,0)
 ; IEN,PROTYPE -- req
"RTN","HLUCM003",233,0)
 ;
"RTN","HLUCM003",234,0)
 N CTPROT
"RTN","HLUCM003",235,0)
 ;
"RTN","HLUCM003",236,0)
 ; Must count everything...
"RTN","HLUCM003",237,0)
 I $G(IEN101)=1!($G(IEN101)=2) QUIT 1 ;->
"RTN","HLUCM003",238,0)
 ;
"RTN","HLUCM003",239,0)
 ; If passed protocols by array, is PROT in array?
"RTN","HLUCM003",240,0)
 I PROTYPE=1 QUIT $S($$REFPROT^HLUCM001(PROT):1,1:"") ;->
"RTN","HLUCM003",241,0)
 ;
"RTN","HLUCM003",242,0)
 ; If PROT not found, and passed 0^PROTNM or 0^PROTIEN, 
"RTN","HLUCM003",243,0)
 ; can't do anything more...
"RTN","HLUCM003",244,0)
 I $$OK0CALL^HLUCM002(IEN101) D  QUIT $S(PROT]"":1,1:"") ;->
"RTN","HLUCM003",245,0)
 .  N VAL
"RTN","HLUCM003",246,0)
 .  QUIT:PROT']""  ;->
"RTN","HLUCM003",247,0)
 .  S VAL=$P(IEN101,U,2)
"RTN","HLUCM003",248,0)
 .  I $P(PROT,"~")'=VAL&($P(PROT,"~",2)'=VAL) S PROT=""
"RTN","HLUCM003",249,0)
 ;
"RTN","HLUCM003",250,0)
 QUIT ""
"RTN","HLUCM003",251,0)
 ;
"RTN","HLUCM003",252,0)
EOR ; HLUCM003 - HL7/Capacity Mgt API-II ;10/23/01 12:01
"RTN","HLUCM004")
0^12^B54148045
"RTN","HLUCM004",1,0)
HLUCM004 ;CIOFO-O/LJA - HL7/Capacity Mgt API ;3/13/03 09:37
"RTN","HLUCM004",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;*88,103**;Oct 13, 1995
"RTN","HLUCM004",3,0)
 ;
"RTN","HLUCM004",4,0)
LOOPU ; Loop thru ^TMP($J,"HLUCMSTORE","U") data.  Full-screen view...
"RTN","HLUCM004",5,0)
 N CT,DATA,EXCL,IEN772,IENPAR,INCL,IOINHI,IOINORM,RNOMSG,STOP,TYPE,X
"RTN","HLUCM004",6,0)
 S X="IOINHI;IOINORM" D ENDR^%ZISS
"RTN","HLUCM004",7,0)
 ;
"RTN","HLUCM004",8,0)
LOOPU1 KILL DATA,EXCL,INCL,IEN772,IENPAR,INCL,RNOMSG,STOP,TYPE
"RTN","HLUCM004",9,0)
 W @IOF,$$CJ^XLFSTR("Display of ^TMP($J,""HLUCMSTORE"",""U"") Data",IOM)
"RTN","HLUCM004",10,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","HLUCM004",11,0)
 ;
"RTN","HLUCM004",12,0)
 W !!,$$CJ^XLFSTR("Type Totals",IOM)
"RTN","HLUCM004",13,0)
 W !,$$CJ^XLFSTR("--------------------------------",IOM)
"RTN","HLUCM004",14,0)
 S TYPE=""
"RTN","HLUCM004",15,0)
 F  S TYPE=$O(^TMP($J,"HLUCMSTORE","T",TYPE)) Q:TYPE']""  D
"RTN","HLUCM004",16,0)
 .  S DATA=$G(^TMP($J,"HLUCMSTORE","T",TYPE))
"RTN","HLUCM004",17,0)
 .  W !,$$CJ^XLFSTR(TYPE_"   "_DATA,IOM)
"RTN","HLUCM004",18,0)
 ;
"RTN","HLUCM004",19,0)
 W !!,"Enter text in messages to include and exclude..."
"RTN","HLUCM004",20,0)
 W !
"RTN","HLUCM004",21,0)
 D EXCL(.EXCL)
"RTN","HLUCM004",22,0)
 W !
"RTN","HLUCM004",23,0)
 D INCL(.INCL)
"RTN","HLUCM004",24,0)
 ;
"RTN","HLUCM004",25,0)
 R !!,"Restrict # messages: 999// ",RNOMSG:999
"RTN","HLUCM004",26,0)
 S:RNOMSG']"" RNOMSG=999
"RTN","HLUCM004",27,0)
 QUIT:RNOMSG'?1.N  ;->
"RTN","HLUCM004",28,0)
 ;
"RTN","HLUCM004",29,0)
 S (CT,CT(1))=0,IENPAR=0,STOP=0
"RTN","HLUCM004",30,0)
 F  S IENPAR=$O(^TMP($J,"HLUCMSTORE","U",IENPAR)) Q:'IENPAR!(STOP)  D
"RTN","HLUCM004",31,0)
 .  S CT(1)=CT(1)+1
"RTN","HLUCM004",32,0)
 .  QUIT:'$$OK(+IENPAR,RNOMSG,.EXCL,.INCL)  ;->
"RTN","HLUCM004",33,0)
 .  S CT=CT+1
"RTN","HLUCM004",34,0)
 .  D SHOWU(+IENPAR,"FULL")
"RTN","HLUCM004",35,0)
 .  R X:999 I X[U S STOP=1
"RTN","HLUCM004",36,0)
 ;
"RTN","HLUCM004",37,0)
 I CT(1)'>0 W !!,"No data exists..." H 2
"RTN","HLUCM004",38,0)
 ;
"RTN","HLUCM004",39,0)
 I CT(1)>0 D
"RTN","HLUCM004",40,0)
 .  W !!,$S('CT:"No matching entries found...",1:"#"_CT_" matching entries displayed...")
"RTN","HLUCM004",41,0)
 .  S CT=CT(1)-CT W !,"#"_CT_" entries skipped..."
"RTN","HLUCM004",42,0)
 ;
"RTN","HLUCM004",43,0)
 Q
"RTN","HLUCM004",44,0)
 ;
"RTN","HLUCM004",45,0)
OK(IENPAR,RNOMSG,EXCL,INCL) ; Exclude and INcludes..
"RTN","HLUCM004",46,0)
 N DATA,FAIL,HOLDEXCL,IEN772,NUM
"RTN","HLUCM004",47,0)
 ;
"RTN","HLUCM004",48,0)
 ; Count messages...
"RTN","HLUCM004",49,0)
 S NUM=0,IEN772=0
"RTN","HLUCM004",50,0)
 F  S IEN772=$O(^TMP($J,"HLUCMSTORE","U",+IENPAR,IEN772)) Q:'IEN772  D
"RTN","HLUCM004",51,0)
 .  S NUM=NUM+1
"RTN","HLUCM004",52,0)
 ;
"RTN","HLUCM004",53,0)
 ; Quit if number messages in unit isn't right...
"RTN","HLUCM004",54,0)
 I RNOMSG=999 QUIT:NUM>RNOMSG "" ;-> Should never happen!
"RTN","HLUCM004",55,0)
 I RNOMSG'=999 QUIT:NUM'=RNOMSG "" ;->
"RTN","HLUCM004",56,0)
 ;
"RTN","HLUCM004",57,0)
 ; Parent node check...
"RTN","HLUCM004",58,0)
 S DATA=$G(^TMP($J,"HLUCMSTORE","U",+IENPAR))
"RTN","HLUCM004",59,0)
 ;
"RTN","HLUCM004",60,0)
 ; Exclusions...
"RTN","HLUCM004",61,0)
 QUIT:$$HOLDEXCL(DATA,.EXCL) "" ;->
"RTN","HLUCM004",62,0)
 ;
"RTN","HLUCM004",63,0)
 ; Child nodes check...
"RTN","HLUCM004",64,0)
 I $O(EXCL(""))]"" D
"RTN","HLUCM004",65,0)
 .  S IEN772=0,HOLDEXCL=0
"RTN","HLUCM004",66,0)
 .  F  S IEN772=$O(^TMP($J,"HLUCMSTORE","U",+IENPAR,IEN772)) Q:'IEN772!(HOLDEXCL)  D
"RTN","HLUCM004",67,0)
 .  .  S DATA=$$DATA(+IEN772)
"RTN","HLUCM004",68,0)
 .  .  S HOLDEXCL=$$HOLDEXCL(DATA,.EXCL)
"RTN","HLUCM004",69,0)
 ;
"RTN","HLUCM004",70,0)
 QUIT:$G(HOLDEXCL) "" ;->
"RTN","HLUCM004",71,0)
 ;
"RTN","HLUCM004",72,0)
 ; Quit, if no INCLUDES...
"RTN","HLUCM004",73,0)
 QUIT:$O(INCL(""))']"" 1 ;->
"RTN","HLUCM004",74,0)
 ;
"RTN","HLUCM004",75,0)
 ; Inclusion check for parent node...
"RTN","HLUCM004",76,0)
 QUIT:$$HOLDINCL(DATA,.INCL) 1 ;->
"RTN","HLUCM004",77,0)
 ;
"RTN","HLUCM004",78,0)
 ; Child node inclusion checks...
"RTN","HLUCM004",79,0)
 S IEN772=0,HOLDINCL=0
"RTN","HLUCM004",80,0)
 F  S IEN772=$O(^TMP($J,"HLUCMSTORE","U",+IENPAR,IEN772)) Q:'IEN772!(HOLDINCL)  D
"RTN","HLUCM004",81,0)
 .  S DATA=$$DATA(+IEN772)
"RTN","HLUCM004",82,0)
 .  S HOLDINCL=$$HOLDINCL(DATA,.INCL)
"RTN","HLUCM004",83,0)
 ;
"RTN","HLUCM004",84,0)
 Q HOLDINCL
"RTN","HLUCM004",85,0)
 ;
"RTN","HLUCM004",86,0)
EXCL(EXCL) ; What entries to exclude? (Searches PARENT node)
"RTN","HLUCM004",87,0)
 W !!,"Every parent node that includes one of the EXCLUDE values that you enter now"
"RTN","HLUCM004",88,0)
 W !,"will not be included in the entries displayed."
"RTN","HLUCM004",89,0)
 W !
"RTN","HLUCM004",90,0)
 D ASK("EXCLUDE",.EXCL)
"RTN","HLUCM004",91,0)
 Q
"RTN","HLUCM004",92,0)
 ;
"RTN","HLUCM004",93,0)
HOLDEXCL(DATA,EXCL) ; Includes text that should be excluded?
"RTN","HLUCM004",94,0)
 N HOLD
"RTN","HLUCM004",95,0)
 S EXCL="",HOLD=0
"RTN","HLUCM004",96,0)
 F  S EXCL=$O(EXCL(EXCL)) Q:EXCL']""!(HOLD)  D
"RTN","HLUCM004",97,0)
 .  I DATA[EXCL S HOLD=1
"RTN","HLUCM004",98,0)
 Q HOLD
"RTN","HLUCM004",99,0)
 ;
"RTN","HLUCM004",100,0)
INCL(INCL) ; What entries to include? (Searches PARENT node)
"RTN","HLUCM004",101,0)
 W !!,"Every parent node that doesn't include one of the INCLUDE values that you"
"RTN","HLUCM004",102,0)
 W !,"enter now will not be included in the entries displayed."
"RTN","HLUCM004",103,0)
 W !
"RTN","HLUCM004",104,0)
 D ASK("INCLUDE",.INCL)
"RTN","HLUCM004",105,0)
 Q
"RTN","HLUCM004",106,0)
 ;
"RTN","HLUCM004",107,0)
HOLDINCL(DATA,INCL) ; Does DATA hold one of the INCLUDEs?
"RTN","HLUCM004",108,0)
 N HOLD
"RTN","HLUCM004",109,0)
 S INCL="",HOLD=0
"RTN","HLUCM004",110,0)
 F  S INCL=$O(INCL(INCL)) Q:INCL']""!(HOLD)  D
"RTN","HLUCM004",111,0)
 .  I DATA[INCL S HOLD=1
"RTN","HLUCM004",112,0)
 Q HOLD
"RTN","HLUCM004",113,0)
 ;
"RTN","HLUCM004",114,0)
ASK(TYPE,ENTRY) ; Repeatedly ask...
"RTN","HLUCM004",115,0)
 N ANS
"RTN","HLUCM004",116,0)
 F  D  QUIT:ANS']""
"RTN","HLUCM004",117,0)
 .  W !,TYPE,": "
"RTN","HLUCM004",118,0)
 .  R ANS:999 S:ANS=U ANS="" Q:ANS']""  ;->
"RTN","HLUCM004",119,0)
 .  S ENTRY(ANS)=""
"RTN","HLUCM004",120,0)
 Q
"RTN","HLUCM004",121,0)
 ;
"RTN","HLUCM004",122,0)
SHOWU(IENPAR,VIEW) ; Show one entry in VIEW format...
"RTN","HLUCM004",123,0)
 N HL,X
"RTN","HLUCM004",124,0)
 MERGE HL=^TMP($J,"HLUCMSTORE","U",+IENPAR)
"RTN","HLUCM004",125,0)
 S X="D "_VIEW_"(.HL)" X X
"RTN","HLUCM004",126,0)
 Q
"RTN","HLUCM004",127,0)
 ;
"RTN","HLUCM004",128,0)
FULL(HL) ; Display one entry in FULL format...
"RTN","HLUCM004",129,0)
 ; IOINHI,IOINORM -- req
"RTN","HLUCM004",130,0)
 N COUNT,DATA,DATA4,DATAN,DATAP,DATAR,IEN772,L,LEN
"RTN","HLUCM004",131,0)
 N PNO,PROTP,PROTC,RES,STOP
"RTN","HLUCM004",132,0)
 ;
"RTN","HLUCM004",133,0)
 ; Header...
"RTN","HLUCM004",134,0)
 W @IOF
"RTN","HLUCM004",135,0)
 S DATA=HL
"RTN","HLUCM004",136,0)
 F  D  Q:DATA']""
"RTN","HLUCM004",137,0)
 .  W !,$$CJ^XLFSTR($E(DATA,1,70),IOM)
"RTN","HLUCM004",138,0)
 .  S DATA=$E(DATA,71,999)
"RTN","HLUCM004",139,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","HLUCM004",140,0)
 ;
"RTN","HLUCM004",141,0)
 S PROTP=$P(HL,U,7)
"RTN","HLUCM004",142,0)
 ;
"RTN","HLUCM004",143,0)
 ; Body...
"RTN","HLUCM004",144,0)
 S COUNT=0,IEN772=0,STOP=0
"RTN","HLUCM004",145,0)
 F  S IEN772=$O(HL(IEN772)) Q:'IEN772!(STOP)  D
"RTN","HLUCM004",146,0)
 .  S COUNT=COUNT+1
"RTN","HLUCM004",147,0)
 .  S DATA=$$DATA(+IEN772)
"RTN","HLUCM004",148,0)
 .  S L=$L(DATA),X=$E(DATA,L-2,L) I X?3U,X'="CCC" S DATA=$E(DATA,1,L-3)_IOINHI_X_IOINORM
"RTN","HLUCM004",149,0)
 .  S PROTC=$P(DATA,U,7)
"RTN","HLUCM004",150,0)
 .  S $P(DATA,U,7)=$S(PROTP=PROTC:"...",1:"~hi~"_PROTC_"~hi~")
"RTN","HLUCM004",151,0)
 .  W !,IEN772,?12,"-",?14
"RTN","HLUCM004",152,0)
 .  F PNO=1:1:$L(DATA,U) D
"RTN","HLUCM004",153,0)
 .  .  S DATAP=$P(DATA,U,+PNO)
"RTN","HLUCM004",154,0)
 .  .  S DATAN=$P(DATA,U,+PNO+1)
"RTN","HLUCM004",155,0)
 .  .  I DATAP["~hi~" D
"RTN","HLUCM004",156,0)
 .  .  .  S DATAP=$P(DATAP,"~hi~",2),LEN=$L(DATAP)+1
"RTN","HLUCM004",157,0)
 .  .  .  S DATAP=IOINHI_DATAP_IOINORM
"RTN","HLUCM004",158,0)
 .  .  E  S LEN=$L(DATAP)+1
"RTN","HLUCM004",159,0)
 .  .  S DATAP=DATAP_$S(DATAN]"":U,1:"")
"RTN","HLUCM004",160,0)
 .  .  W:(IOM-$X-LEN)'>0 !,?14
"RTN","HLUCM004",161,0)
 .  .  W DATAP
"RTN","HLUCM004",162,0)
 .  I '(COUNT#4) W " ",IOINHI,"<",IOINORM R X:120 I X[U S STOP=1
"RTN","HLUCM004",163,0)
 .  W !,$$REPEAT^XLFSTR($S($O(HL(IEN772)):"-",1:"="),IOM)
"RTN","HLUCM004",164,0)
 ;
"RTN","HLUCM004",165,0)
 ; Trailer...
"RTN","HLUCM004",166,0)
 S RES="C"
"RTN","HLUCM004",167,0)
 F  S RES=$O(HL(RES)) Q:RES'?3U  D
"RTN","HLUCM004",168,0)
 .  S DATAR=HL(RES)
"RTN","HLUCM004",169,0)
 .  W $$CJ^XLFSTR(RES_" - "_DATAR,IOM)
"RTN","HLUCM004",170,0)
 ;
"RTN","HLUCM004",171,0)
 Q
"RTN","HLUCM004",172,0)
 ;
"RTN","HLUCM004",173,0)
DATA(IEN772) ; Return what is displayed...
"RTN","HLUCM004",174,0)
 N DATA,IENPAR,RES
"RTN","HLUCM004",175,0)
 S IENPAR=+$G(^TMP($J,"HLUCMSTORE","X",+IEN772)) QUIT:'IENPAR "" ;->
"RTN","HLUCM004",176,0)
 S RES=$O(^TMP($J,"HLUCMSTORE","U",+IENPAR,+IEN772,"")) ; CCC, CXC, etc
"RTN","HLUCM004",177,0)
 S DATA=$G(^TMP($J,"HLUCMSTORE","U",+IENPAR,+IEN772,RES))_"   <<>>  "_$G(^TMP($J,"HLUCMSTORE","U",+IENPAR,+IEN772,RES,772))_"   <<>>  "_RES
"RTN","HLUCM004",178,0)
 I $TR(DATA," <>","")']"" S DATA=""
"RTN","HLUCM004",179,0)
 Q DATA
"RTN","HLUCM004",180,0)
 ;
"RTN","HLUCM004",181,0)
XTMPGBL(SHOW) ; Display XTMP data totals?
"RTN","HLUCM004",182,0)
 N ANS,API,BEG,COND,DATA,END,HOLD,NO,RUN,SVNO,TIME,XTMP
"RTN","HLUCM004",183,0)
 ;
"RTN","HLUCM004",184,0)
 S XTMP="HLUCM ",SHOW=+$G(SHOW),HOLD=0
"RTN","HLUCM004",185,0)
 QUIT:$O(^XTMP(XTMP))'?1"HLUCM "7N  ;->
"RTN","HLUCM004",186,0)
 W !!,$$CJ^XLFSTR(" XTMP-stored Reports ",IOM),!,$$REPEAT^XLFSTR("=",IOM)
"RTN","HLUCM004",187,0)
 W !,"#",?4,"Run-time",?20,"API Call"
"RTN","HLUCM004",188,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","HLUCM004",189,0)
 F  S XTMP=$O(^XTMP(XTMP)) Q:XTMP'?1"HLUCM "7N  D
"RTN","HLUCM004",190,0)
 .  S BEG=0
"RTN","HLUCM004",191,0)
 .  F  S BEG=$O(^XTMP(XTMP,"P",BEG)) Q:'BEG  D
"RTN","HLUCM004",192,0)
 .  .  S END=0
"RTN","HLUCM004",193,0)
 .  .  F  S END=$O(^XTMP(XTMP,"P",BEG,END)) Q:'END  D
"RTN","HLUCM004",194,0)
 .  .  .  S COND=""
"RTN","HLUCM004",195,0)
 .  .  .  F  S COND=$O(^XTMP(XTMP,"P",BEG,END,COND)) Q:COND']""  D
"RTN","HLUCM004",196,0)
 .  .  .  .  S DATA=$G(^XTMP(XTMP,"P",BEG,END,COND)) QUIT:DATA']""  ;->
"RTN","HLUCM004",197,0)
 .  .  .  .  S SVNO=+DATA,TIME=$P(DATA,U,2) QUIT:TIME']""  ;->
"RTN","HLUCM004",198,0)
 .  .  .  .  S DATA=$G(^XTMP(XTMP,"N",+SVNO)),API=$P(DATA,U,4)
"RTN","HLUCM004",199,0)
 .  .  .  .  S HOLD=HOLD+1
"RTN","HLUCM004",200,0)
 .  .  .  .  S HOLD(TIME,HOLD)=XTMP_U_SVNO_"~"_$E(TIME_"                    ",1,16)_$E("$$"_API_"("_BEG_","_END_",1,1,"""_COND_""",TOTALS,.ERR)",1,60)
"RTN","HLUCM004",201,0)
 .  .  .  .  S RUN(+SVNO)=XTMP
"RTN","HLUCM004",202,0)
 S TIME=0,HOLD=0
"RTN","HLUCM004",203,0)
 F  S TIME=$O(HOLD(TIME)) Q:'TIME  D
"RTN","HLUCM004",204,0)
 .  S NO=0
"RTN","HLUCM004",205,0)
 .  F  S NO=$O(HOLD(TIME,NO)) Q:NO'>0  D
"RTN","HLUCM004",206,0)
 .  .  S DATA=HOLD(TIME,NO),XTMP=$P(DATA,U)
"RTN","HLUCM004",207,0)
 .  .  S SVNO=$P($P(DATA,"~"),U,2),DATA=$P(DATA,"~",2,999)
"RTN","HLUCM004",208,0)
 .  .  S HOLD=HOLD+1
"RTN","HLUCM004",209,0)
 .  .  S HOLD("N",HOLD)=XTMP_U_SVNO
"RTN","HLUCM004",210,0)
 .  .  W !,$E("#"_HOLD_"    ",1,4),DATA
"RTN","HLUCM004",211,0)
 ;
"RTN","HLUCM004",212,0)
 QUIT:HOLD'>0 "" ;->
"RTN","HLUCM004",213,0)
 ;
"RTN","HLUCM004",214,0)
 W !!,"You may choose to print the totals report from stored XTMP data if you like."
"RTN","HLUCM004",215,0)
 W !,"If so, enter the number of the XTMP report from above now.  (Otherwise,"
"RTN","HLUCM004",216,0)
 W !,"press RETURN.)"
"RTN","HLUCM004",217,0)
 ;
"RTN","HLUCM004",218,0)
 R !!,"Enter XTMP Report#: ",NO:999 Q:'$D(HOLD("N",+NO)) "" ;->
"RTN","HLUCM004",219,0)
 S XTMP=$P(HOLD("N",+NO),U),SVNO=$P(HOLD("N",+NO),U,2)
"RTN","HLUCM004",220,0)
 ;
"RTN","HLUCM004",221,0)
 Q $NA(^XTMP(XTMP,"D",SVNO))
"RTN","HLUCM004",222,0)
 ;
"RTN","HLUCM004",223,0)
EOR ; HLUCM004 - HL7/Capacity Mgt API ;3/13/03 09:37
"RTN","HLUCM005")
1^6
"RTN","HLUCM006")
1^13
"RTN","HLUCM007")
1^8
"RTN","HLUCM008")
1^9
"RTN","HLUCM009")
0^10^B41420564
"RTN","HLUCM009",1,0)
HLUCM009 ;CIOFO-O/LJA - HL7/Capacity Mgt API-II ;2/25/03-08:50
"RTN","HLUCM009",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**103**;Oct 13, 1995
"RTN","HLUCM009",3,0)
 ;
"RTN","HLUCM009",4,0)
IEN870(IEN772) ; Given 772 find 870...
"RTN","HLUCM009",5,0)
 N DATA,I773,I870,IEN
"RTN","HLUCM009",6,0)
 S DATA=$G(^HL(772,+IEN772,0))
"RTN","HLUCM009",7,0)
 ;
"RTN","HLUCM009",8,0)
 ; Logical Link field...
"RTN","HLUCM009",9,0)
 S IEN=$P(DATA,U,11) I IEN QUIT IEN ;->
"RTN","HLUCM009",10,0)
 ;
"RTN","HLUCM009",11,0)
 ; Related Event Protocol...
"RTN","HLUCM009",12,0)
 S IEN=$P(DATA,U,10),IEN=$P($G(^ORD(101,+IEN,770)),U,7) I IEN QUIT IEN ;->
"RTN","HLUCM009",13,0)
 ;
"RTN","HLUCM009",14,0)
 S I773=0
"RTN","HLUCM009",15,0)
 F  S I773=$O(^HLMA("B",IEN772,I773)) Q:I773'>0  D  QUIT:I870
"RTN","HLUCM009",16,0)
 .  S I870=$P($G(^HLMA(+I773,0)),U,7)
"RTN","HLUCM009",17,0)
 I $G(I870) QUIT +I870 ;->
"RTN","HLUCM009",18,0)
 ;
"RTN","HLUCM009",19,0)
 QUIT ""
"RTN","HLUCM009",20,0)
 ;
"RTN","HLUCM009",21,0)
MSGTYPE(IEN772) ; MSG or MSA's type...
"RTN","HLUCM009",22,0)
 N DEL,IN
"RTN","HLUCM009",23,0)
 S IN=$G(^HL(772,+IEN772,"IN",1,0)) QUIT:IN']"" "MSG" ;->
"RTN","HLUCM009",24,0)
 S DEL=$E(IN,4) QUIT:DEL']"" "MSG" ;->
"RTN","HLUCM009",25,0)
 S IN=$P(IN,DEL,2) QUIT:IN']"" "MSG" ;->
"RTN","HLUCM009",26,0)
 I $L(IN)=2,$E(IN)="C"!($E(IN)="A") QUIT IN ;->
"RTN","HLUCM009",27,0)
 QUIT "MSG"
"RTN","HLUCM009",28,0)
 ;
"RTN","HLUCM009",29,0)
KILLS(WHEN) ; Kills of ^TMP data WHEN (START or END or ALL)
"RTN","HLUCM009",30,0)
 N DATA
"RTN","HLUCM009",31,0)
 ;
"RTN","HLUCM009",32,0)
 ; If ALL, set WHEN to include START and END...
"RTN","HLUCM009",33,0)
 S:WHEN="ALL" WHEN="STARTandEND"
"RTN","HLUCM009",34,0)
 ;
"RTN","HLUCM009",35,0)
 ; Always KILLs...
"RTN","HLUCM009",36,0)
 F DATA="ACTUAL","HLCHILD",$G(TOTALS)_"ERRTIME","HLOAD772","N","HLNMSP94","HLNMSPXRF","HLPARENT","HLRECNM","U","X" D
"RTN","HLUCM009",37,0)
 .  KILL ^TMP(DATA,$J),^TMP($J,DATA)
"RTN","HLUCM009",38,0)
 ;
"RTN","HLUCM009",39,0)
 ; START-only KILLs...
"RTN","HLUCM009",40,0)
 I WHEN["START" D
"RTN","HLUCM009",41,0)
 .  F DATA="HLUCMSTORE","RFAC",$G(TOTALS) D
"RTN","HLUCM009",42,0)
 .  .  QUIT:DATA']""  ;-> Sometimes TOTALS might not be defined
"RTN","HLUCM009",43,0)
 .  .  KILL ^TMP(DATA,$J),^TMP($J,DATA)
"RTN","HLUCM009",44,0)
 ;
"RTN","HLUCM009",45,0)
 ; END-only KILLs...
"RTN","HLUCM009",46,0)
 I WHEN["END" D
"RTN","HLUCM009",47,0)
 .  KILL HLAPI
"RTN","HLUCM009",48,0)
 .  ; Don't store any debug global data...
"RTN","HLUCM009",49,0)
 .  I $G(^TMP($J,"HLUCM"))'="DEBUG GLOBAL" KILL ^TMP($J)
"RTN","HLUCM009",50,0)
 .  F DATA="HL4","HLUCM","HLUCMDT" D
"RTN","HLUCM009",51,0)
 .  .  KILL ^TMP($J,DATA),^TMP(DATA,$J)
"RTN","HLUCM009",52,0)
 ;
"RTN","HLUCM009",53,0)
 QUIT
"RTN","HLUCM009",54,0)
 ;
"RTN","HLUCM009",55,0)
SITESMSH(TXT) ; Return location pieces, slightly modified...
"RTN","HLUCM009",56,0)
 N DIV,P4,P6
"RTN","HLUCM009",57,0)
 S DIV=$E(TXT,4),P4=$P(TXT,DIV,4),P6=$P(TXT,DIV,6)
"RTN","HLUCM009",58,0)
 S P4=$S(P4?1.N1"~"!(P4?1.N):+P4,1:"")
"RTN","HLUCM009",59,0)
 S P6=$S(P6?1.N1"~"!(P6?1.N):+P6,1:"")
"RTN","HLUCM009",60,0)
 QUIT P4_U_P6
"RTN","HLUCM009",61,0)
 ;
"RTN","HLUCM009",62,0)
MAILTYPE(MIEN) ; Is MSH in Mailman message local or remote...
"RTN","HLUCM009",63,0)
 N IEN,RECNO,TO,TOID,TYPE
"RTN","HLUCM009",64,0)
 S TYPE="L"
"RTN","HLUCM009",65,0)
 KILL ^TMP($J,"HLMAILTYPE")
"RTN","HLUCM009",66,0)
 D QD^XMXUTIL3(+MIEN,,,,,"^TMP($J,""HLMAILTYPE"")")
"RTN","HLUCM009",67,0)
 S RECNO=0
"RTN","HLUCM009",68,0)
 F  S RECNO=$O(^TMP($J,"HLMAILTYPE","XMLIST",RECNO)) Q:RECNO'>0!(TYPE'="L")  D
"RTN","HLUCM009",69,0)
 .  S TO=$G(^TMP($J,"HLMAILTYPE","XMLIST",+RECNO,"TO"))
"RTN","HLUCM009",70,0)
 .  S TOID=$G(^TMP($J,"HLMAILTYPE","XMLIST",+RECNO,"TO ID"))
"RTN","HLUCM009",71,0)
 .  I TO["@"!(TOID="R") S TYPE="R"
"RTN","HLUCM009",72,0)
 KILL ^TMP($J,"HLMAILTYPE")
"RTN","HLUCM009",73,0)
 QUIT TYPE
"RTN","HLUCM009",74,0)
 ;
"RTN","HLUCM009",75,0)
NMSPXRF ; Xref of namespaces that can be inferred. (If start with DG change to DG)
"RTN","HLUCM009",76,0)
 N I,T KILL ^TMP($J,"HLNMSPXRF") F I=2:1 S T=$T(NMSPXRF+I) Q:T'[";;"  S T=$P(T,";;",2,99),^TMP($J,"HLNMSPXRF",$P(T,U))=$P(T,U,2)
"RTN","HLUCM009",77,0)
 ;;DG^DG
"RTN","HLUCM009",78,0)
 ;;GM^GM
"RTN","HLUCM009",79,0)
 ;;HEC^HEC
"RTN","HLUCM009",80,0)
 ;;IB^IB
"RTN","HLUCM009",81,0)
 ;;IVM^IVM
"RTN","HLUCM009",82,0)
 ;;LA^LA
"RTN","HLUCM009",83,0)
 ;;MPI^MPI
"RTN","HLUCM009",84,0)
 ;;OR^OR
"RTN","HLUCM009",85,0)
 ;;PR^PR
"RTN","HLUCM009",86,0)
 ;;PS^PS
"RTN","HLUCM009",87,0)
 ;;RG^RG
"RTN","HLUCM009",88,0)
 ;;ROR^ROR
"RTN","HLUCM009",89,0)
 ;;SC^SC
"RTN","HLUCM009",90,0)
 ;;VEI^VEIB
"RTN","HLUCM009",91,0)
 ;;XM^XMB
"RTN","HLUCM009",92,0)
 ;;XU^XU
"RTN","HLUCM009",93,0)
 ;;XW^XWB
"RTN","HLUCM009",94,0)
 Q
"RTN","HLUCM009",95,0)
 ;
"RTN","HLUCM009",96,0)
ACCUMLAT(CATEGORY,TYPE,SORT,SUB1,SUB2,SUB3,SUB4) ; Generic accumulator
"RTN","HLUCM009",97,0)
 ;
"RTN","HLUCM009",98,0)
 I $G(SUB4)]"" D
"RTN","HLUCM009",99,0)
 .  S TOTCURR=$G(^TMP(TOTALS,$J,CATEGORY,TYPE,SORT,SUB1,SUB2,SUB3,SUB4))
"RTN","HLUCM009",100,0)
 .  D INCR^HLUCM001
"RTN","HLUCM009",101,0)
 .  S ^TMP(TOTALS,$J,CATEGORY,TYPE,SORT,SUB1,SUB2,SUB3,SUB4)=TOTCURR
"RTN","HLUCM009",102,0)
 ;
"RTN","HLUCM009",103,0)
 S TOTCURR=$G(^TMP(TOTALS,$J,CATEGORY,TYPE,SORT,SUB1,SUB2,SUB3))
"RTN","HLUCM009",104,0)
 D INCR^HLUCM001
"RTN","HLUCM009",105,0)
 S ^TMP(TOTALS,$J,CATEGORY,TYPE,SORT,SUB1,SUB2,SUB3)=TOTCURR
"RTN","HLUCM009",106,0)
 ;
"RTN","HLUCM009",107,0)
 ; Totals level 2 for SUB...
"RTN","HLUCM009",108,0)
 S TOTCURR=$G(^TMP(TOTALS,$J,CATEGORY,TYPE,SORT,SUB1,SUB2))
"RTN","HLUCM009",109,0)
 D INCR^HLUCM001
"RTN","HLUCM009",110,0)
 S ^TMP(TOTALS,$J,CATEGORY,TYPE,SORT,SUB1,SUB2)=TOTCURR
"RTN","HLUCM009",111,0)
 ;
"RTN","HLUCM009",112,0)
 ; Totals level 1 for SUB...
"RTN","HLUCM009",113,0)
 S TOTCURR=$G(^TMP(TOTALS,$J,CATEGORY,TYPE,SORT,SUB1))
"RTN","HLUCM009",114,0)
 D INCR^HLUCM001
"RTN","HLUCM009",115,0)
 S ^TMP(TOTALS,$J,CATEGORY,TYPE,SORT,SUB1)=TOTCURR
"RTN","HLUCM009",116,0)
 ;
"RTN","HLUCM009",117,0)
 ; Total level TYPE/SORT...
"RTN","HLUCM009",118,0)
 S TOTCURR=$G(^TMP(TOTALS,$J,CATEGORY,TYPE,SORT))
"RTN","HLUCM009",119,0)
 D INCR^HLUCM001
"RTN","HLUCM009",120,0)
 S ^TMP(TOTALS,$J,CATEGORY,TYPE,SORT)=TOTCURR
"RTN","HLUCM009",121,0)
 ;
"RTN","HLUCM009",122,0)
 ; Total level TYPE
"RTN","HLUCM009",123,0)
 S TOTCURR=$G(^TMP(TOTALS,$J,CATEGORY,TYPE))
"RTN","HLUCM009",124,0)
 D INCR^HLUCM001
"RTN","HLUCM009",125,0)
 S ^TMP(TOTALS,$J,CATEGORY,TYPE)=TOTCURR
"RTN","HLUCM009",126,0)
 ;
"RTN","HLUCM009",127,0)
 ; Total level CATEGORY
"RTN","HLUCM009",128,0)
 ; [Don't subtotal here, for NMSP holds two different TYPEs, and
"RTN","HLUCM009",129,0)
 ; if totalled here, it would double count.]
"RTN","HLUCM009",130,0)
 ;
"RTN","HLUCM009",131,0)
 QUIT
"RTN","HLUCM009",132,0)
 ;
"RTN","HLUCM009",133,0)
LOAD772S(IEN772,HLNMSP) ; Load list of related 772s... [HL*1.6*91]
"RTN","HLUCM009",134,0)
 ;
"RTN","HLUCM009",135,0)
 ; Warning!!!  This call point will never load more than 20 entries...
"RTN","HLUCM009",136,0)
 ;             Any more than that, and probably an error condition
"RTN","HLUCM009",137,0)
 ;             exists.
"RTN","HLUCM009",138,0)
 ;
"RTN","HLUCM009",139,0)
 N ACKTO,CHILD,DATA,FAC,HL772,HLI,HLJ,HLK,HLN,HLPCKG,HLZZI,HOLDNMSP,I
"RTN","HLUCM009",140,0)
 N I772,I773,MSGID,NUM,PARENT,PCKG,PIEN,PROT,TOTNUM,VAL,X
"RTN","HLUCM009",141,0)
 ;
"RTN","HLUCM009",142,0)
 KILL HLNMSP
"RTN","HLUCM009",143,0)
 QUIT:$G(^HL(772,+$G(IEN772),0))']"" "" ;->
"RTN","HLUCM009",144,0)
 ;
"RTN","HLUCM009",145,0)
 S DATA=$G(^HL(772,+$G(IEN772),0)) QUIT:DATA']"" "" ;->
"RTN","HLUCM009",146,0)
 ;
"RTN","HLUCM009",147,0)
 ; Loop until no new entries found or more than 20 entries...
"RTN","HLUCM009",148,0)
 S NUM=$$LOADEM^HLUCM050(+IEN772,.HLNMSP)
"RTN","HLUCM009",149,0)
 ;
"RTN","HLUCM009",150,0)
 QUIT NUM
"RTN","HLUCM009",151,0)
 ;
"RTN","HLUCM009",152,0)
HOLDTOT(IEN) ; Accumulate...
"RTN","HLUCM009",153,0)
 QUIT:$D(HOLDNMSP(IEN))!(TOTNUM>19)  ;->
"RTN","HLUCM009",154,0)
 S HOLDNMSP(IEN)="",TOTNUM=TOTNUM+1
"RTN","HLUCM009",155,0)
 QUIT
"RTN","HLUCM009",156,0)
 ;
"RTN","HLUCM009",157,0)
SETUP() ; Perform checks, which can return error conditions, and
"RTN","HLUCM009",158,0)
 ; set up variables for $$LOOP.  This extrinsic function returns
"RTN","HLUCM009",159,0)
 ; "" if no errors, or the # errors found.  (Note that error
"RTN","HLUCM009",160,0)
 ; details placed in ERRINFO(ERROR-REASON)="")
"RTN","HLUCM009",161,0)
 N NOERR
"RTN","HLUCM009",162,0)
 S NOERR=""
"RTN","HLUCM009",163,0)
 D SETDEF ; Set defaults for parameters, if not passed
"RTN","HLUCM009",164,0)
 D FINDWAY ; Find way NMSP and PROT parameters passed
"RTN","HLUCM009",165,0)
 D SETMORE^HLUCM003 ; Additional var sets based on parameters & "way"...
"RTN","HLUCM009",166,0)
 D ERRCHK^HLUCM003 ; Check for errors...
"RTN","HLUCM009",167,0)
 KILL ^TMP(TOTALS,$J) ; Clear out storage location...
"RTN","HLUCM009",168,0)
 QUIT NOERR
"RTN","HLUCM009",169,0)
 ;
"RTN","HLUCM009",170,0)
SETDEF ; Set various defaults...
"RTN","HLUCM009",171,0)
 I '$D(PNMSP) S PNMSP=1
"RTN","HLUCM009",172,0)
 I '$D(IEN101) S IEN101=1
"RTN","HLUCM009",173,0)
 I $G(TOTALS)']"" S TOTALS="HLTOTALS"
"RTN","HLUCM009",174,0)
 S COND=$$UP^XLFSTR(COND)
"RTN","HLUCM009",175,0)
 S COND=$S($G(COND)="BOTH":COND,1:"EITHER") ; Default to EITHER matches, count it...
"RTN","HLUCM009",176,0)
 QUIT
"RTN","HLUCM009",177,0)
 ;
"RTN","HLUCM009",178,0)
FINDWAY ; How were NMSP and PROT passed?  By reference?  (If so, return 1)
"RTN","HLUCM009",179,0)
 ; Passed by reference?
"RTN","HLUCM009",180,0)
 S NMSPTYPE=$S($G(PNMSP)']""&($O(PNMSP(""))]""):1,1:0) ; 1=YES
"RTN","HLUCM009",181,0)
 S PROTYPE=$S($G(IEN101)']""&($O(IEN101(""))]""):1,1:0) ; 1=YES
"RTN","HLUCM009",182,0)
 QUIT
"RTN","HLUCM009",183,0)
 ;
"RTN","HLUCM009",184,0)
MSGID(MSGID) ; Search forward for MSA's to this MSGID...
"RTN","HLUCM009",185,0)
 N BIEN,CT,D,HOLD,I772,I773,MSA,X
"RTN","HLUCM009",186,0)
 ;
"RTN","HLUCM009",187,0)
 S X=$O(^HL(772,"C",MSGID,0)) I X S HOLD(X)=""
"RTN","HLUCM009",188,0)
 S X=$O(^HLMA("C",MSGID,0)) I X S X=+$G(^HLMA(+X,0)) I X S HOLD(X)=""
"RTN","HLUCM009",189,0)
 ;
"RTN","HLUCM009",190,0)
 Q
"RTN","HLUCM009",191,0)
 ;
"RTN","HLUCM009",192,0)
ERRMOVE(IEN772) ; Move all associated data out of ^TMP's totaling arrays
"RTN","HLUCM009",193,0)
 N IEN772C,IEN772P
"RTN","HLUCM009",194,0)
 ;
"RTN","HLUCM009",195,0)
 ; Find parent message (because have to move ALL associated messages out)
"RTN","HLUCM009",196,0)
 QUIT:$G(^TMP($J,"HLUCM"))'="DEBUG GLOBAL"  ;->
"RTN","HLUCM009",197,0)
 S IEN772P=$O(^TMP($J,"HLUCMSTORE","X",+IEN772,0))
"RTN","HLUCM009",198,0)
 I IEN772P'>0 S IEN772P=IEN772
"RTN","HLUCM009",199,0)
 ;
"RTN","HLUCM009",200,0)
 ; Loop thru all associated messages in unit...
"RTN","HLUCM009",201,0)
 S IEN772C=0
"RTN","HLUCM009",202,0)
 F  S IEN772C=$O(^TMP($J,"HLUCMSTORE","U",IEN772P,IEN772C)) Q:'IEN772C  D
"RTN","HLUCM009",203,0)
 .  F SUB="C","E","O","X" D
"RTN","HLUCM009",204,0)
 .  .  MERGE ^TMP($J,"HLUCMSTORE","ERR",SUB,IEN772C)=^TMP($J,"HLUCMSTORE",SUB,IEN772C)
"RTN","HLUCM009",205,0)
 .  .  KILL ^TMP($J,"HLUCMSTORE",SUB,IEN772C)
"RTN","HLUCM009",206,0)
 ;
"RTN","HLUCM009",207,0)
 ; Maybe there is no X xref...
"RTN","HLUCM009",208,0)
 MERGE ^TMP($J,"HLUCMSTORE","ERR","E",+IEN772P)=^TMP($J,"HLUCMSTORE","E",+IEN772P)
"RTN","HLUCM009",209,0)
 KILL ^TMP($J,"HLUCMSTORE","E",+IEN772P)
"RTN","HLUCM009",210,0)
 ;
"RTN","HLUCM009",211,0)
 ; Finally, move the unit's data...
"RTN","HLUCM009",212,0)
 MERGE ^TMP($J,"HLUCMSTORE","ERR","U",IEN772P)=^TMP($J,"HLUCMSTORE","U",IEN772P)
"RTN","HLUCM009",213,0)
 KILL ^TMP($J,"HLUCMSTORE","U",IEN772P)
"RTN","HLUCM009",214,0)
 ;
"RTN","HLUCM009",215,0)
 Q
"RTN","HLUCM009",216,0)
 ;
"RTN","HLUCM009",217,0)
EOR ;HLUCM009 - HL7/Capacity Mgt API-II ;2/25/03-08:50
"RTN","HLUCM050")
0^14^B75933959
"RTN","HLUCM050",1,0)
HLUCM050 ;CIOFO-O/LJA - HL7/Capacity Mgt API-II ;10/23/01 12:01
"RTN","HLUCM050",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**103**;Oct 13, 1995
"RTN","HLUCM050",3,0)
 ;
"RTN","HLUCM050",4,0)
LOADEM(IEN772,HLNMSP) ; Find all related entries, up to 20...
"RTN","HLUCM050",5,0)
 ; HLNMSP is passed by reference...
"RTN","HLUCM050",6,0)
 ;
"RTN","HLUCM050",7,0)
 ; Note!  If entry already loaded, it will not be reloaded.
"RTN","HLUCM050",8,0)
 ;        (Stored ^TMP($J) data will be used instead.)
"RTN","HLUCM050",9,0)
 ;
"RTN","HLUCM050",10,0)
 N ACKTO,CHARC,CHARP,CT,DATA,DATAC,DATAP,DEF,FAC,HL,HLZZI
"RTN","HLUCM050",11,0)
 N HOLDNMSP,I,I772,I773,IEN,IENPAR,LEN,MSGID,MTYPEC
"RTN","HLUCM050",12,0)
 N MTYPEP,NMSP,NMSPP,NUM,PIEN,PROT,PROTP,TIME,TIMEBEG
"RTN","HLUCM050",13,0)
 N TIMEEND,TMDIFF,TMP,TOT772,TOT773,TOTNUM,X,Y
"RTN","HLUCM050",14,0)
 ;
"RTN","HLUCM050",15,0)
 KILL HLNMSP
"RTN","HLUCM050",16,0)
 ;
"RTN","HLUCM050",17,0)
 ; Call already made here?
"RTN","HLUCM050",18,0)
 S IENPAR=+$G(^TMP($J,"HLCHILD",+IEN772)) ; Call already made here?
"RTN","HLUCM050",19,0)
 ;
"RTN","HLUCM050",20,0)
 ; If call already made, just return results...
"RTN","HLUCM050",21,0)
 I IENPAR D  QUIT $P(HLNMSP("HLPARENT",+IENPAR),U,2) ;->
"RTN","HLUCM050",22,0)
 .  S HLNMSP("HLPARENT",+IENPAR)=$G(^TMP($J,"HLPARENT",+IENPAR))
"RTN","HLUCM050",23,0)
 .  S IEN772=0
"RTN","HLUCM050",24,0)
 .  F  S IEN772=$O(^TMP($J,"HLPARENT",IENPAR,IEN772)) Q:'IEN772  D
"RTN","HLUCM050",25,0)
 .  .  S HLNMSP("HLPARENT",+IENPAR,IEN772)=$G(^TMP($J,"HLPARENT",IENPAR,IEN772))
"RTN","HLUCM050",26,0)
 .  .  S HLNMSP("HLCHILD",+IEN772)=$G(^TMP($J,"HLCHILD",+IEN772))
"RTN","HLUCM050",27,0)
 ;
"RTN","HLUCM050",28,0)
 S HLNMSP(+IEN772)="" ; Seed for engine...
"RTN","HLUCM050",29,0)
 ;
"RTN","HLUCM050",30,0)
 S (NUM,TOTNUM)=1
"RTN","HLUCM050",31,0)
 F  D  QUIT:NUM'>NUM(1)!(TOTNUM>19)
"RTN","HLUCM050",32,0)
 .  S NUM(1)=NUM ; Set NUM(1) = # entries found "now"...
"RTN","HLUCM050",33,0)
 .  KILL HOLDNMSP
"RTN","HLUCM050",34,0)
 .  S I772=0
"RTN","HLUCM050",35,0)
 .  F  S I772=$O(HLNMSP(I772)) Q:I772'>0!(TOTNUM>19)  D
"RTN","HLUCM050",36,0)
 .  .  S DATA=$G(^HL(772,+$G(I772),0)) QUIT:DATA']""  ;->
"RTN","HLUCM050",37,0)
 .  .
"RTN","HLUCM050",38,0)
 .  .  ; IEN Search...
"RTN","HLUCM050",39,0)
 .  .  S HLZZI=0 F  S HLZZI=$O(^HL(772,"AF",I772,HLZZI)) Q:'HLZZI!(TOTNUM>19)  I HLZZI'=IEN772 D HOLDTOT(HLZZI)
"RTN","HLUCM050",40,0)
 .  .  ; MSG ID search...
"RTN","HLUCM050",41,0)
 .  .  S MSGID=$P(DATA,U,6)
"RTN","HLUCM050",42,0)
 .  .  I MSGID]"" D
"RTN","HLUCM050",43,0)
 .  .  .  S HLZZI=0 F  S HLZZI=$O(^HL(772,"C",MSGID,HLZZI)) Q:'HLZZI!(TOTNUM>19)  I HLZZI'=IEN772 D HOLDTOT(HLZZI)
"RTN","HLUCM050",44,0)
 .  .  .  D MSGID(MSGID)
"RTN","HLUCM050",45,0)
 .  .  ; 773 MSG ID search...
"RTN","HLUCM050",46,0)
 .  .  S I773=+$O(^HLMA("B",I772,0)) I I773 D
"RTN","HLUCM050",47,0)
 .  .  .  S MSGID=$P($G(^HLMA(+I773,0)),U,2) QUIT:MSGID']""  ;->
"RTN","HLUCM050",48,0)
 .  .  .  S I773(1)=0
"RTN","HLUCM050",49,0)
 .  .  .  F  S I773(1)=$O(^HLMA("AF",I773,I773(1))) Q:I773(1)'>0!(TOTNUM>19)  D
"RTN","HLUCM050",50,0)
 .  .  .  .  S X=+$G(^HLMA(+I773(1),0)) I X D HOLDTOT(+X)
"RTN","HLUCM050",51,0)
 .  .  .  S I773(1)=0
"RTN","HLUCM050",52,0)
 .  .  .  F  S I773(1)=$O(^HLMA("C",MSGID,I773(1))) Q:I773(1)'>0!(TOTNUM>19)  D
"RTN","HLUCM050",53,0)
 .  .  .  .  S X=+$G(^HLMA(+I773(1),0)) I X D HOLDTOT(+X)
"RTN","HLUCM050",54,0)
 .  .  .  KILL I773(1)
"RTN","HLUCM050",55,0)
 .  .  .  D MSGID(MSGID)
"RTN","HLUCM050",56,0)
 .  .
"RTN","HLUCM050",57,0)
 .  .  ;
"RTN","HLUCM050",58,0)
 .  .  ; ACK TO search...
"RTN","HLUCM050",59,0)
 .  .  I $P(DATA,U,7)>0,$P(DATA,U,7)'=IEN772 D
"RTN","HLUCM050",60,0)
 .  .  .  D HOLDTOT(+$P(DATA,U,7))
"RTN","HLUCM050",61,0)
 .  .  I I773 D
"RTN","HLUCM050",62,0)
 .  .  .  S ACKTO=$P($G(^HLMA(+I773,0)),U,10) QUIT:ACKTO'>0  ;->
"RTN","HLUCM050",63,0)
 .  .  .  S X=+$G(^HLMA(+ACKTO,0)) I X D HOLDTOT(+X)
"RTN","HLUCM050",64,0)
 .  .  ;
"RTN","HLUCM050",65,0)
 .  .  ; HLPARENT search...
"RTN","HLUCM050",66,0)
 .  .  I $P(DATA,U,8)>0,$P(DATA,U,8)'=IEN772 D
"RTN","HLUCM050",67,0)
 .  .  .  D HOLDTOT(+$P(DATA,U,8))
"RTN","HLUCM050",68,0)
 .  .  I I773 D
"RTN","HLUCM050",69,0)
 .  .  .  S PIEN=$P($G(^HLMA(+I773,0)),U,6) QUIT:PIEN'>0  ;->
"RTN","HLUCM050",70,0)
 .  .  .  S X=+$G(^HLMA(+PIEN,0)) I X D HOLDTOT(+X)
"RTN","HLUCM050",71,0)
 .  .
"RTN","HLUCM050",72,0)
 .  .  MERGE HLNMSP=HOLDNMSP
"RTN","HLUCM050",73,0)
 .  .  KILL HOLDNMSP
"RTN","HLUCM050",74,0)
 .
"RTN","HLUCM050",75,0)
 .  S I=0,NUM=0 F  S I=$O(HLNMSP(I)) Q:'I  S NUM=NUM+1
"RTN","HLUCM050",76,0)
 ;
"RTN","HLUCM050",77,0)
 I '$$OKALL(.HLNMSP) D  QUIT "" ;->
"RTN","HLUCM050",78,0)
 .  KILL HLNMSP
"RTN","HLUCM050",79,0)
 ;
"RTN","HLUCM050",80,0)
 S FAC=$$FACILITY^HLUCM090(.HLNMSP) I FAC']"" S FAC="UNKNOWN"
"RTN","HLUCM050",81,0)
 S IENPAR=$O(HLNMSP(0))
"RTN","HLUCM050",82,0)
 ;
"RTN","HLUCM050",83,0)
 ; Find total number characters...
"RTN","HLUCM050",84,0)
 KILL TIMEP
"RTN","HLUCM050",85,0)
 S IEN772=0,CHARC=0,CHARP=0,CT=0,MTYPEP="",NMSPP="",PROTP="",NUM=0
"RTN","HLUCM050",86,0)
 F  S IEN772=$O(HLNMSP(IEN772)) Q:'IEN772  D
"RTN","HLUCM050",87,0)
 .  S CT=CT+1,NUM=NUM+1
"RTN","HLUCM050",88,0)
 .
"RTN","HLUCM050",89,0)
 .  S TMP($J,"HLPARENT",+IENPAR,+IEN772)=$$VAL3(+IEN772,FAC)_U_IENPAR
"RTN","HLUCM050",90,0)
 .
"RTN","HLUCM050",91,0)
 .  S CHARC=$$CHAR(+IEN772)
"RTN","HLUCM050",92,0)
 .  S DATAC(IEN772)=CHARC
"RTN","HLUCM050",93,0)
 .  S CHARP=CHARP+CHARC
"RTN","HLUCM050",94,0)
 .
"RTN","HLUCM050",95,0)
 .  S $P(DATAC(IEN772),U,2)=1
"RTN","HLUCM050",96,0)
 .
"RTN","HLUCM050",97,0)
 .  S TIME=$$TIME(+IEN772)
"RTN","HLUCM050",98,0)
 .  F I=1:1:3 S $P(DATAC(IEN772),U,2+I)=$P(TIME,U,I)
"RTN","HLUCM050",99,0)
 .  F I=2,3 S X=$P(TIME,U,I) I X?7N.E S TIMEP(X)=""
"RTN","HLUCM050",100,0)
 .
"RTN","HLUCM050",101,0)
 .  S MTYPEC=$$MSGTYPE^HLUCM009(IEN772)
"RTN","HLUCM050",102,0)
 .  S $P(DATAC(IEN772),U,6)=MTYPEC
"RTN","HLUCM050",103,0)
 .  S MTYPEP=MTYPEP_$S(MTYPEP]"":"~",1:"")_MTYPEC
"RTN","HLUCM050",104,0)
 .
"RTN","HLUCM050",105,0)
 .  S PROT=$$PROT101^HLUCM002(+IEN772)
"RTN","HLUCM050",106,0)
 .  S $P(DATAC(IEN772),U,7)=PROT
"RTN","HLUCM050",107,0)
 .  S:PROT]"" PROTP=PROT
"RTN","HLUCM050",108,0)
 .
"RTN","HLUCM050",109,0)
 .  S NMSP=$$NMSPALL(+IEN772)
"RTN","HLUCM050",110,0)
 .  S $P(DATAC(IEN772),U,9)=NMSP
"RTN","HLUCM050",111,0)
 .  I NMSP]"" D
"RTN","HLUCM050",112,0)
 .  .  I NMSPP]"",NMSP="XWB",NMSPP'="XWB" QUIT  ;->
"RTN","HLUCM050",113,0)
 .  .  S NMSPP=NMSP
"RTN","HLUCM050",114,0)
 .
"RTN","HLUCM050",115,0)
 .  S $P(DATAC(IEN772),U,11)=FAC
"RTN","HLUCM050",116,0)
 ;
"RTN","HLUCM050",117,0)
 S TIMEBEG=$O(TIMEP(0)),TIMEEND=$O(TIMEP(":"),-1)
"RTN","HLUCM050",118,0)
 S TMDIFF=$$FMDIFF^XLFDT(TIMEEND,TIMEBEG,2)
"RTN","HLUCM050",119,0)
 ;
"RTN","HLUCM050",120,0)
 S DATAP=CHARP_U_CT_U_TMDIFF_U_TIMEBEG_U_TIMEEND_U_MTYPEP_U_PROTP_U_U_NMSPP_U_U_FAC
"RTN","HLUCM050",121,0)
 ;
"RTN","HLUCM050",122,0)
 ; Set PARENT node...
"RTN","HLUCM050",123,0)
 S IENPAR=$O(HLNMSP(0))
"RTN","HLUCM050",124,0)
 S TMP($J,"HLPARENT",+IENPAR)=DATAP
"RTN","HLUCM050",125,0)
 ;
"RTN","HLUCM050",126,0)
 ; Set CHILD nodes...
"RTN","HLUCM050",127,0)
 S IEN772=0
"RTN","HLUCM050",128,0)
 F  S IEN772=$O(HLNMSP(IEN772)) Q:IEN772'>0  D
"RTN","HLUCM050",129,0)
 .  S TMP($J,"HLCHILD",+IEN772)=IENPAR_"~"_$G(DATAC(+IEN772))
"RTN","HLUCM050",130,0)
 ;
"RTN","HLUCM050",131,0)
 KILL HLNMSP
"RTN","HLUCM050",132,0)
 MERGE HLNMSP=TMP($J)
"RTN","HLUCM050",133,0)
 MERGE ^TMP($J)=TMP($J)
"RTN","HLUCM050",134,0)
 ;
"RTN","HLUCM050",135,0)
 Q NUM
"RTN","HLUCM050",136,0)
 ;
"RTN","HLUCM050",137,0)
OKALL(HLNMSP) ; Does every 772 entry have a valid .01 node?
"RTN","HLUCM050",138,0)
 N FAIL,I772
"RTN","HLUCM050",139,0)
 S FAIL=0,I772=0
"RTN","HLUCM050",140,0)
 F  S I772=$O(HLNMSP(I772)) Q:'I772!(FAIL)  D
"RTN","HLUCM050",141,0)
 .  QUIT:$P($G(^HL(772,+I772,0)),U)?7N1"."1.N  ;->
"RTN","HLUCM050",142,0)
 .  S FAIL=1
"RTN","HLUCM050",143,0)
 Q 'FAIL
"RTN","HLUCM050",144,0)
 ;
"RTN","HLUCM050",145,0)
VAL3(IEN772,FAC) ; Return sort values...
"RTN","HLUCM050",146,0)
 N TYPEHR,TYPEIO,TYPELR
"RTN","HLUCM050",147,0)
 S TYPEHR=$$TYPETMO^HLUCM002(+IEN772)
"RTN","HLUCM050",148,0)
 S TYPEIO=$$TYPEIO^HLUCM002(+IEN772)
"RTN","HLUCM050",149,0)
 ;S TYPELR=$$TYPELR^HLUCM001(+IEN772,FAC)
"RTN","HLUCM050",150,0)
 S TYPELR=$S(FAC["~DNS":"R",1:"L")
"RTN","HLUCM050",151,0)
 Q TYPEHR_U_TYPEIO_U_TYPELR
"RTN","HLUCM050",152,0)
 ;
"RTN","HLUCM050",153,0)
TIME(IEN772) ; Times...
"RTN","HLUCM050",154,0)
 N CT,DATA,IEN773,TMBEG,TMEND,TMDIFF
"RTN","HLUCM050",155,0)
 D TOT772T^HLUCM(+IEN772)
"RTN","HLUCM050",156,0)
 S IEN773=0,CT=0
"RTN","HLUCM050",157,0)
 F  S IEN773=$O(^HLMA("B",+IEN772,IEN773)) Q:'IEN773!(CT>20)  D
"RTN","HLUCM050",158,0)
 .  S CT=CT+1
"RTN","HLUCM050",159,0)
 .  D TOT773T^HLUCM(+IEN773)
"RTN","HLUCM050",160,0)
 D TMDIFF^HLUCM
"RTN","HLUCM050",161,0)
 Q DATA("DIFF")_U_DATA("START")_U_DATA("END")
"RTN","HLUCM050",162,0)
 ;
"RTN","HLUCM050",163,0)
 ;
"RTN","HLUCM050",164,0)
CHAR(IEN772) ; Number characters...
"RTN","HLUCM050",165,0)
 N CT,DATA,IEN773
"RTN","HLUCM050",166,0)
 D TOT772C^HLUCM(+IEN772)
"RTN","HLUCM050",167,0)
 S IEN773=0,CT=0
"RTN","HLUCM050",168,0)
 F  S IEN773=$O(^HLMA("B",+IEN772,IEN773)) Q:'IEN773!(CT>20)  D
"RTN","HLUCM050",169,0)
 .  S CT=CT+1
"RTN","HLUCM050",170,0)
 .  D TOT773C^HLUCM(+IEN773)
"RTN","HLUCM050",171,0)
 Q $G(DATA("CHAR"))
"RTN","HLUCM050",172,0)
 ;
"RTN","HLUCM050",173,0)
GETNMSP(IEN772) ; The one and only place to ask for NAMESPACE...
"RTN","HLUCM050",174,0)
 N HL,NMSP,NUM,PAR,VAL
"RTN","HLUCM050",175,0)
 S NUM=$$LOADEM^HLUCM050(+IEN772,.HL) QUIT:NUM'>0 "" ;->
"RTN","HLUCM050",176,0)
 S PAR=+$G(HL("HLCHILD",+IEN772))
"RTN","HLUCM050",177,0)
 S VAL=$G(HL("HLPARENT",+PAR))
"RTN","HLUCM050",178,0)
 Q $P(VAL,U,9)
"RTN","HLUCM050",179,0)
 ;
"RTN","HLUCM050",180,0)
GETPROT(IEN772) ; One & only place to ask for PROTOCOL...
"RTN","HLUCM050",181,0)
 N HL,NMSP,NUM,PAR,VAL
"RTN","HLUCM050",182,0)
 S NUM=$$LOADEM^HLUCM050(+IEN772,.HL) QUIT:NUM'>0 "" ;->
"RTN","HLUCM050",183,0)
 S PAR=+$G(HL("HLCHILD",+IEN772))
"RTN","HLUCM050",184,0)
 S VAL=$G(HL("HLPARENT",+PAR))
"RTN","HLUCM050",185,0)
 Q $P(VAL,U,7)
"RTN","HLUCM050",186,0)
 ;
"RTN","HLUCM050",187,0)
HOLDTOT(X) D HOLDTOT^HLUCM009(X) QUIT
"RTN","HLUCM050",188,0)
MSGID(X) D MSGID^HLUCM009(X) QUIT
"RTN","HLUCM050",189,0)
 ;
"RTN","HLUCM050",190,0)
NMSPALL(IEN772) ;Perform all attempts to find NMSP...
"RTN","HLUCM050",191,0)
 N IEN101,IEN94,NMSP
"RTN","HLUCM050",192,0)
 ;
"RTN","HLUCM050",193,0)
 ; If SPR...
"RTN","HLUCM050",194,0)
 S NMSP=$$SPR(+IEN772) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",195,0)
 ;
"RTN","HLUCM050",196,0)
 ; Check MSH segment...
"RTN","HLUCM050",197,0)
 S NMSP=$$MSH772^HLUCM003(+IEN772) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",198,0)
 S NMSP=$$MSHMAIL^HLUCM003(+IEN772) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",199,0)
 ;
"RTN","HLUCM050",200,0)
 ; Get Event Protocol
"RTN","HLUCM050",201,0)
 S IEN101=+$P($G(^HL(772,+IEN772,0)),U,10) QUIT:IEN101'>0 "" ;->
"RTN","HLUCM050",202,0)
 ;
"RTN","HLUCM050",203,0)
 ; Find XEC routines, and try NMSPXRFs...
"RTN","HLUCM050",204,0)
 S NMSP=$$NMSPXRF(+IEN101) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",205,0)
 ;
"RTN","HLUCM050",206,0)
 ; Try 9.4 link...
"RTN","HLUCM050",207,0)
 S IEN94=$P($G(^ORD(101,+IEN101,0)),U,12)
"RTN","HLUCM050",208,0)
 I IEN94 S NMSP=$P($$NMSP94(IEN94),U,2) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",209,0)
 ;
"RTN","HLUCM050",210,0)
 S NMSP=$$MSH773^HLUCM003(+IEN772) QUIT:NMSP]"" $$NMSPCHG(NMSP) ;->
"RTN","HLUCM050",211,0)
 ;
"RTN","HLUCM050",212,0)
 QUIT ""
"RTN","HLUCM050",213,0)
 ;
"RTN","HLUCM050",214,0)
NMSP94(IEN94) ; From 9.4 find it's namespace...
"RTN","HLUCM050",215,0)
 N D0,DA,DIC,DIQ,DR,NMSP,RET
"RTN","HLUCM050",216,0)
 S RET=$G(^TMP($J,"HLNMSP94",+IEN94)) I RET]"" QUIT RET ;->
"RTN","HLUCM050",217,0)
 S DIC=9.4,DR=".01;1",DA=IEN94,DIQ="NMSP(",DIQ(0)="E"
"RTN","HLUCM050",218,0)
 D EN^DIQ1
"RTN","HLUCM050",219,0)
 S RET=$G(NMSP(9.4,+IEN94,.01,"E"))_U_$G(NMSP(9.4,+IEN94,1,"E"))
"RTN","HLUCM050",220,0)
 S ^TMP($J,"HLNMSP94",+IEN94)=RET
"RTN","HLUCM050",221,0)
 QUIT RET
"RTN","HLUCM050",222,0)
 ;
"RTN","HLUCM050",223,0)
NMSPCHG(NMSP) ; Some miscellaneous special actions first...
"RTN","HLUCM050",224,0)
 N PCKG
"RTN","HLUCM050",225,0)
 ;
"RTN","HLUCM050",226,0)
 ; Check xref first...
"RTN","HLUCM050",227,0)
 D:'$D(^TMP($J,"HLNMSPXRF")) NMSPXRF^HLUCM009
"RTN","HLUCM050",228,0)
 S PCKG=$$NMSPFROM(NMSP) QUIT:PCKG]"" PCKG ;->
"RTN","HLUCM050",229,0)
 ;
"RTN","HLUCM050",230,0)
 S PCKG=NMSP
"RTN","HLUCM050",231,0)
 ;
"RTN","HLUCM050",232,0)
 ; Other conversions here...
"RTN","HLUCM050",233,0)
 I $E(PCKG,1,2)="DG",PCKG'="DG" S PCKG="DG"
"RTN","HLUCM050",234,0)
 I $E(PCKG,1,3)="VEI",PCKG'="VEIB" S PCKG="VEIB"
"RTN","HLUCM050",235,0)
 I $E(PCKG,1,2)="VA" D
"RTN","HLUCM050",236,0)
 .  I PCKG["PIMS" S PCKG="DG" QUIT  ;->
"RTN","HLUCM050",237,0)
 .  I $G(APPR)["HEC " S PCKG="HEC" QUIT  ;->
"RTN","HLUCM050",238,0)
 .  I $G(FACR)["HEC " S PCKG="HEC" QUIT  ;->
"RTN","HLUCM050",239,0)
 I $E(PCKG,1,2)="LA" S PCKG="LA"
"RTN","HLUCM050",240,0)
 I $E(PCKG,1,2)="VA",PCKG[" PIMS" S PCKG="DG"
"RTN","HLUCM050",241,0)
 I $E(PCKG,1,10)="VAFC ADMIT" S PCKG="DG"
"RTN","HLUCM050",242,0)
 I $E(PCKG,1,8)="VAFC ADT" S PCKG="DG"
"RTN","HLUCM050",243,0)
 I $E(PCKG,1,8)?1"VAFH A"2N S PCKG="DG"
"RTN","HLUCM050",244,0)
 I $E(PCKG,1,15)?1"VAFH CLIENT A"2N S PCKG="DG"
"RTN","HLUCM050",245,0)
 I $E(PCKG,1,2)="XM" S PCKG="XM"
"RTN","HLUCM050",246,0)
 I $E(PCKG,1,2)="XU" S PCKG="XU"
"RTN","HLUCM050",247,0)
 ;
"RTN","HLUCM050",248,0)
 QUIT PCKG
"RTN","HLUCM050",249,0)
 ;
"RTN","HLUCM050",250,0)
NMSPXRF(IEN101) ; Find NMSP from ^TMP($J,"NMSPXRF")
"RTN","HLUCM050",251,0)
 N LEN,NMSP,NODE,RTN
"RTN","HLUCM050",252,0)
 I '$D(^TMP($J,"HLNMSPXRF")) D NMSPXRF^HLUCM009 ; Build, if not there
"RTN","HLUCM050",253,0)
 S NMSP=""
"RTN","HLUCM050",254,0)
 F NODE=772,774,771 D  QUIT:NMSP]""
"RTN","HLUCM050",255,0)
 .  S RTN=$E($P($G(^ORD(101,+IEN101,NODE)),U,2),1,4) QUIT:RTN']""  ;->
"RTN","HLUCM050",256,0)
 .  S NMSP=$$NMSPFROM(RTN)
"RTN","HLUCM050",257,0)
 Q NMSP
"RTN","HLUCM050",258,0)
 ;
"RTN","HLUCM050",259,0)
NMSPFROM(TXT) ; From TXT try to find NMSP...
"RTN","HLUCM050",260,0)
 N NMSP
"RTN","HLUCM050",261,0)
 QUIT:$G(TXT)']"" "" ;->
"RTN","HLUCM050",262,0)
 S NMSP=""
"RTN","HLUCM050",263,0)
 F LEN=4:-1:2 D  QUIT:NMSP]""
"RTN","HLUCM050",264,0)
 .  S NMSP=$G(^TMP($J,"HLNMSPXRF",$E(TXT,1,LEN))) QUIT:NMSP]""  ;->
"RTN","HLUCM050",265,0)
 I NMSP']"" F LEN=4:-1:2 D  QUIT:NMSP]""
"RTN","HLUCM050",266,0)
 .  ; See Integration Agreement #10048
"RTN","HLUCM050",267,0)
 .  N D,DIC,X,Y
"RTN","HLUCM050",268,0)
 .  S DIC="^DIC(9.4,",DIC(0)="FO",D="C",X=$E(TXT,1,LEN)
"RTN","HLUCM050",269,0)
 .  D MIX^DIC1 QUIT:+Y'>0  ;->
"RTN","HLUCM050",270,0)
 .  ; Found!  So, set into ^TMP...
"RTN","HLUCM050",271,0)
 .  S NMSP=$E(TXT,1,LEN)
"RTN","HLUCM050",272,0)
 .  S ^TMP($J,"HLNMSPXRF",NMSP)=NMSP
"RTN","HLUCM050",273,0)
 Q NMSP
"RTN","HLUCM050",274,0)
 ;
"RTN","HLUCM050",275,0)
SPR(IEN772) ; Evaluate SPR segment for RPC for package, possible
"RTN","HLUCM050",276,0)
 ; resetting the PCKG variable...
"RTN","HLUCM050",277,0)
 ; PCKG -- req
"RTN","HLUCM050",278,0)
 N CHAR,DEL,IN,NMSP
"RTN","HLUCM050",279,0)
 S IN=$G(^HL(772,+IEN772,"IN",1,0))
"RTN","HLUCM050",280,0)
 QUIT:$E(IN,1,4)'="SPR^" "" ;->
"RTN","HLUCM050",281,0)
 QUIT:IN'["REMOTE RPC^" "" ;->
"RTN","HLUCM050",282,0)
 S DEL=$E(IN,4)
"RTN","HLUCM050",283,0)
 S IN=$P(IN,DEL,5) QUIT:IN']"" "" ;->
"RTN","HLUCM050",284,0)
 S IN=$P(IN,"003RPC",2) QUIT:IN']"" "" ;->
"RTN","HLUCM050",285,0)
 S CHAR=+IN,IN=$TR($E(IN,4,CHAR+4),"&","") QUIT:IN']"" "" ;->
"RTN","HLUCM050",286,0)
 I $E(IN,1,2)="IB" QUIT "IB" ;->
"RTN","HLUCM050",287,0)
 I $E(IN,1,2)="OR" QUIT "OR" ;->
"RTN","HLUCM050",288,0)
 I '$D(^TMP($J,"HLNMSPXRF")) D NMSPXRF^HLUCM009
"RTN","HLUCM050",289,0)
 S NMSP=$$NMSPFROM(IN)
"RTN","HLUCM050",290,0)
 QUIT NMSP
"RTN","HLUCM050",291,0)
 ;
"RTN","HLUCM050",292,0)
EOR ; HLUCM050 - HL7/Capacity Mgt API-II ;10/23/01 12:01
"RTN","HLUCM090")
0^11^B61258653
"RTN","HLUCM090",1,0)
HLUCM090 ;CIOFO-O/LJA - Facility Finder Software ;2/20/2003 - 12:35
"RTN","HLUCM090",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**103**;Oct 13, 1995
"RTN","HLUCM090",3,0)
 ;
"RTN","HLUCM090",4,0)
FACILITY(IEN772) ; Return facility name for REMOTE entries
"RTN","HLUCM090",5,0)
 ; IMPORTANT!!  Do not call here unless the entry is REMOTE
"RTN","HLUCM090",6,0)
 ;
"RTN","HLUCM090",7,0)
 N FACNM
"RTN","HLUCM090",8,0)
 N FACNM,IEN773,LOCAL,MSH,NO773
"RTN","HLUCM090",9,0)
 ;
"RTN","HLUCM090",10,0)
 ; Is FAC a local station number?
"RTN","HLUCM090",11,0)
 S LOCAL=$P($$SITE^VASITE,U,3)_"~"_$P($$SITE^VASITE,U,2)_"~LOCAL"
"RTN","HLUCM090",12,0)
 ;
"RTN","HLUCM090",13,0)
 S IEN772=0,FACNM=""
"RTN","HLUCM090",14,0)
 F  S IEN772=$O(IEN772(IEN772)) Q:'IEN772!(FACNM]"")  D
"RTN","HLUCM090",15,0)
 .  S FACNM=$$FACNM(+IEN772)
"RTN","HLUCM090",16,0)
 ;
"RTN","HLUCM090",17,0)
 Q $S(FACNM]"":FACNM,1:LOCAL)
"RTN","HLUCM090",18,0)
 ;
"RTN","HLUCM090",19,0)
FACNM(IEN772) ; Return FACILITY NAME for one 772 entry...
"RTN","HLUCM090",20,0)
 N CT,DATA,FACNM,MSH,NO,PROT
"RTN","HLUCM090",21,0)
 ;
"RTN","HLUCM090",22,0)
 ; Try to extract from MSH segment in file 773...
"RTN","HLUCM090",23,0)
 S FACNM=$$MSH773(+IEN772) QUIT:FACNM]"" $$FACDNS(FACNM) ;->
"RTN","HLUCM090",24,0)
 ;
"RTN","HLUCM090",25,0)
 ; Try to find MSH in 772...
"RTN","HLUCM090",26,0)
 S FACNM=$$SEG772(+IEN772) QUIT:FACNM]"" $$FACDNS(FACNM) ;->
"RTN","HLUCM090",27,0)
 ;
"RTN","HLUCM090",28,0)
 ; Try to find MSH in 870...
"RTN","HLUCM090",29,0)
 S FACNM=$$MSH870(+IEN772) QUIT:FACNM]"" $$FACDNS(FACNM) ;->
"RTN","HLUCM090",30,0)
 ;
"RTN","HLUCM090",31,0)
 Q ""
"RTN","HLUCM090",32,0)
 ;
"RTN","HLUCM090",33,0)
MSH870(IEN772) ; Find facility name from MSH in 870 OUT QUEUE...
"RTN","HLUCM090",34,0)
 N CT,DATA,IEN772N,LL,MSH,NO,PROT,PROTS
"RTN","HLUCM090",35,0)
 ;
"RTN","HLUCM090",36,0)
 ; Look at parent...
"RTN","HLUCM090",37,0)
 S IEN772N=+$G(^TMP($J,"HLOAD772","X",+IEN772))
"RTN","HLUCM090",38,0)
 I IEN772N'>0 S IEN772N=+IEN772
"RTN","HLUCM090",39,0)
 ;
"RTN","HLUCM090",40,0)
 S PROT=$P($G(^HL(772,+IEN772N,0)),U,10) QUIT:'PROT "" ;->
"RTN","HLUCM090",41,0)
 S FACNM="",PROTS=0
"RTN","HLUCM090",42,0)
 F  S PROTS=$O(^ORD(101,+PROT,775,"B",PROTS)) QUIT:'PROTS!(FACNM]"")  D
"RTN","HLUCM090",43,0)
 .  S LL=$P($G(^ORD(101,+PROTS,770)),U,7) QUIT:'LL  ;->
"RTN","HLUCM090",44,0)
 .  S MSH="",NO=0,CT=0
"RTN","HLUCM090",45,0)
 .  F  S NO=$O(^HLCS(870,+LL,2,NO)) Q:MSH]""!('NO)!(CT>10)!(FACNM]"")  D
"RTN","HLUCM090",46,0)
 .  .  S CT=CT+1
"RTN","HLUCM090",47,0)
 .  .  S DATA=$G(^HLCS(870,+LL,2,+NO,1,1,0)) QUIT:$E(DATA,1,3)'="MSH"  ;->
"RTN","HLUCM090",48,0)
 .  .  S MSH=DATA,FACNM=$$MSHXTRCT(MSH,"O")
"RTN","HLUCM090",49,0)
 Q FACNM
"RTN","HLUCM090",50,0)
 ;
"RTN","HLUCM090",51,0)
SEG772(IEN772) ; Try to find SEGment in 772, and extract facility...
"RTN","HLUCM090",52,0)
 N SEG,WAY
"RTN","HLUCM090",53,0)
 S WAY=$P($G(^HL(772,+IEN772,0)),U,4) QUIT:WAY']"" "" ;->
"RTN","HLUCM090",54,0)
 S SEG=$G(^HL(772,+IEN772,"IN",1,0))
"RTN","HLUCM090",55,0)
 I $E(SEG,1,3)="MSH" QUIT $$MSHXTRCT(SEG,WAY) ;->
"RTN","HLUCM090",56,0)
 I $E(SEG,1,3)="SPR" QUIT $$SPRXTRCT(IEN772,SEG) ;->
"RTN","HLUCM090",57,0)
 Q ""
"RTN","HLUCM090",58,0)
 ;
"RTN","HLUCM090",59,0)
MSH773(IEN772) ; Try to extract from MSH segment in file 773...
"RTN","HLUCM090",60,0)
 N FACNM,IEN773,NO773
"RTN","HLUCM090",61,0)
 S NO773=$$IEN773(IEN772,.IEN773)
"RTN","HLUCM090",62,0)
 I NO773 S FACNM=$O(IEN773("")) QUIT:FACNM]"" FACNM ;->
"RTN","HLUCM090",63,0)
 Q ""
"RTN","HLUCM090",64,0)
 ;
"RTN","HLUCM090",65,0)
IEN773(IEN772,IEN773) ; Find associated 773 entries...
"RTN","HLUCM090",66,0)
 N DEL,IEN,MSH,RFN,VAL,WAY
"RTN","HLUCM090",67,0)
 ;
"RTN","HLUCM090",68,0)
 KILL IEN773
"RTN","HLUCM090",69,0)
 S IEN773=0
"RTN","HLUCM090",70,0)
 ;
"RTN","HLUCM090",71,0)
 S IEN=0
"RTN","HLUCM090",72,0)
 F  S IEN=$O(^HLMA("B",+IEN772,IEN)) Q:'IEN  D
"RTN","HLUCM090",73,0)
 .  S VAL=$G(^HLMA(+IEN,0)) QUIT:VAL']""  ;->
"RTN","HLUCM090",74,0)
 .  S WAY=$P(VAL,U,3) QUIT:WAY']""  ;->
"RTN","HLUCM090",75,0)
 .  S MSH=$G(^HLMA(+IEN,"MSH",1,0)) QUIT:MSH']""  ;->
"RTN","HLUCM090",76,0)
 .  S RFN=$$MSHXTRCT(MSH,WAY) QUIT:RFN']""  ;->
"RTN","HLUCM090",77,0)
 .  S IEN773(RFN,+IEN)=WAY
"RTN","HLUCM090",78,0)
 .  S IEN773(RFN)=$G(IEN773(RFN))+1
"RTN","HLUCM090",79,0)
 .  S IEN773=$G(IEN773)+1
"RTN","HLUCM090",80,0)
 ;
"RTN","HLUCM090",81,0)
 Q +IEN773
"RTN","HLUCM090",82,0)
 ;
"RTN","HLUCM090",83,0)
MSHXTRCT(MSH,WAY) ; Given I/O WAY and MSH segment, return facility
"RTN","HLUCM090",84,0)
 N DEL,RFN,X
"RTN","HLUCM090",85,0)
 S DEL=$E(MSH,4)
"RTN","HLUCM090",86,0)
 S RFN=$P(MSH,DEL,$S(WAY="I":4,WAY="O":6,1:999)) QUIT:RFN']"" "" ;->
"RTN","HLUCM090",87,0)
 I RFN?3N!(RFN?3N1U.E) S X=$$FRSTANO(RFN) S:X]"" RFN=X
"RTN","HLUCM090",88,0)
 Q RFN
"RTN","HLUCM090",89,0)
 ;
"RTN","HLUCM090",90,0)
SPRXTRCT(IEN772,SPR) ; Given SPR segment, extract facility
"RTN","HLUCM090",91,0)
 N CHAR,DIV,I773,MSH
"RTN","HLUCM090",92,0)
 S I773=$O(^HLMA("B",+IEN772,0))
"RTN","HLUCM090",93,0)
 S MSH=$G(^HLMA(+I773,"MSH",1,0))
"RTN","HLUCM090",94,0)
 S DIV=$E(MSH,7)
"RTN","HLUCM090",95,0)
 S:DIV']"" DIV="\"
"RTN","HLUCM090",96,0)
 Q $P(SPR,DIV,5)
"RTN","HLUCM090",97,0)
 ;
"RTN","HLUCM090",98,0)
FRSTANO(STANO) ;
"RTN","HLUCM090",99,0)
 N IEN,NM
"RTN","HLUCM090",100,0)
 S IEN=$O(^DIC(4,"D",STANO,0)) QUIT:IEN'>0 "" ;->
"RTN","HLUCM090",101,0)
 S NM=$P($G(^DIC(4,+IEN,0)),U)
"RTN","HLUCM090",102,0)
 QUIT NM
"RTN","HLUCM090",103,0)
 ;
"RTN","HLUCM090",104,0)
ACCUMFAC ; Create ^TMP(TOTALS,$J,"RFAC") data...
"RTN","HLUCM090",105,0)
 N INFO,PARENT,TYPE
"RTN","HLUCM090",106,0)
 ;
"RTN","HLUCM090",107,0)
 D ACCUMLAT^HLUCM009("RFAC","LR","R",FAC,DATA("PCKG"),START,DATA("PROT"))
"RTN","HLUCM090",108,0)
 ;
"RTN","HLUCM090",109,0)
 S TOTCURR=$G(^TMP(TOTALS,$J,"RFAC"))
"RTN","HLUCM090",110,0)
 D INCR^HLUCM001
"RTN","HLUCM090",111,0)
 S ^TMP(TOTALS,$J,"RFAC")=TOTCURR
"RTN","HLUCM090",112,0)
 ;
"RTN","HLUCM090",113,0)
 Q
"RTN","HLUCM090",114,0)
 ;
"RTN","HLUCM090",115,0)
INST870(IEN772,INST) ;
"RTN","HLUCM090",116,0)
 N INST870,LINK
"RTN","HLUCM090",117,0)
 S LINK=$$LINK(IEN772) QUIT:LINK'>0 "" ;->
"RTN","HLUCM090",118,0)
 S INST870=+$P($G(^HLCS(870,+LINK,0)),U,2)
"RTN","HLUCM090",119,0)
 QUIT $S(INST870>0&(INST870'=INST):"R",1:"L")
"RTN","HLUCM090",120,0)
 ;
"RTN","HLUCM090",121,0)
MAIL870(IEN772) ;
"RTN","HLUCM090",122,0)
 N LINK,MAIL
"RTN","HLUCM090",123,0)
 S LINK=$$LINK(IEN772) QUIT:LINK'>0 "" ;->
"RTN","HLUCM090",124,0)
 S MAIL=$P($G(^HLCS(870,+LINK,0)),U,3)
"RTN","HLUCM090",125,0)
 QUIT $S(MAIL=1:"R",1:"L")
"RTN","HLUCM090",126,0)
 ;
"RTN","HLUCM090",127,0)
LINK(IEN772) ;
"RTN","HLUCM090",128,0)
 N IEN773,LINK
"RTN","HLUCM090",129,0)
 S LINK=$P($G(^HL(772,IEN772,0)),U,11)
"RTN","HLUCM090",130,0)
 I LINK'>0 D
"RTN","HLUCM090",131,0)
 .  S IEN773=$O(^HLMA("B",IEN772,0)) QUIT:IEN773'>0  ;->
"RTN","HLUCM090",132,0)
 .  S LINK=$P($G(^HLMA(+IEN773,0)),U,7)
"RTN","HLUCM090",133,0)
 QUIT LINK
"RTN","HLUCM090",134,0)
 ;
"RTN","HLUCM090",135,0)
PRINTDBG ; Print data in ^TMP($J,"HLUCMSTORE")
"RTN","HLUCM090",136,0)
 N CHAR,CT,IEN772,IEN773,IOINHI,IOINORM,LP,PAUSE,PRINT
"RTN","HLUCM090",137,0)
 N S1,S2,SKIP,ST,STOP,VAL
"RTN","HLUCM090",138,0)
 I $G(JOBN)']"" N JOBN S JOBN=$J
"RTN","HLUCM090",139,0)
 S X="IOINHI;IOINORM" D ENDR^%ZISS
"RTN","HLUCM090",140,0)
 S LP=$NA(^TMP(JOBN,"HLUCMSTORE")),ST=$P(LP,")")_","
"RTN","HLUCM090",141,0)
 ;
"RTN","HLUCM090",142,0)
 R !!,"Print T nodes(Y/N): No// ",ANS:999 Q:ANS[U  ;->
"RTN","HLUCM090",143,0)
 S SKIP=$S(ANS=""!(ANS="N"):"",1:"T")
"RTN","HLUCM090",144,0)
 ;
"RTN","HLUCM090",145,0)
 R !!,"Print X nodes(Y/N): No// ",ANS:999 Q:ANS[U  ;->
"RTN","HLUCM090",146,0)
 S SKIP=SKIP_$S(ANS=""!(ANS="N"):"",1:"X")
"RTN","HLUCM090",147,0)
 ;
"RTN","HLUCM090",148,0)
 R !!,"Print U nodes(Y/N): Yes// ",ANS:999 Q:ANS[U  ;->
"RTN","HLUCM090",149,0)
 S SKIP=SKIP_$S(ANS=""!(ANS="Y"):"U",1:"")
"RTN","HLUCM090",150,0)
 ;
"RTN","HLUCM090",151,0)
 S CT=0,PAUSE=1,STOP=0
"RTN","HLUCM090",152,0)
 F  S LP=$Q(@LP) Q:LP'[ST!(STOP)  D
"RTN","HLUCM090",153,0)
 .  S X=$E($TR($P(LP,",",3),"""","")_" ") I SKIP'[X QUIT  ;->
"RTN","HLUCM090",154,0)
 .  S DATA=$P(LP,ST,2,99)_"=",PX=$L(DATA),DATA=IOINHI_DATA_IOINORM_@LP
"RTN","HLUCM090",155,0)
 .  F  D  Q:DATA']""  Q:STOP
"RTN","HLUCM090",156,0)
 .  .  S PRINT=$E(DATA,1,77),DATA=$E(DATA,78,999)
"RTN","HLUCM090",157,0)
 .  .  I DATA]"" S DATA=$$REPEAT^XLFSTR(" ",PX)_DATA
"RTN","HLUCM090",158,0)
 .  .  W !,PRINT
"RTN","HLUCM090",159,0)
 .  QUIT:'PAUSE  ;->
"RTN","HLUCM090",160,0)
 .  S CT=CT+1 QUIT:CT<22  ;->
"RTN","HLUCM090",161,0)
 .  W " ",IOINHI,"<",IOINORM
"RTN","HLUCM090",162,0)
 .  R X:999 S:X[U STOP=1 S:X=" " PAUSE=0
"RTN","HLUCM090",163,0)
 .  S CT=0
"RTN","HLUCM090",164,0)
 QUIT
"RTN","HLUCM090",165,0)
 ;
"RTN","HLUCM090",166,0)
PRINT1 ;
"RTN","HLUCM090",167,0)
 N DATA,L1,L2,L3,L4,L5,LAST,TOT,TOT1,TOT2,TOT3,TYP
"RTN","HLUCM090",168,0)
PRINT2 I $G(GBL)']"" N GBL S GBL="^TMP("""_SUB_""","_JOBN_")"
"RTN","HLUCM090",169,0)
 S (TOT,TOT1,TOT2,TOT3)=0
"RTN","HLUCM090",170,0)
 I $O(@GBL@(""))']"" D  QUIT  ;->
"RTN","HLUCM090",171,0)
 .  S X=$$BTE^HLCSMON("No data found.  Press RETURN to continue...  ",1)
"RTN","HLUCM090",172,0)
 S X=$$BTE^HLCSMON("About to print ^TMP("""_$G(SUB)_""",$J) data report.  Press RETURN...",1)
"RTN","HLUCM090",173,0)
 W !!," Total   Total   Total  Main"
"RTN","HLUCM090",174,0)
 W !,"#Chars   #Msgs    #Sec  Sort Sub1 Sub2 Sub3"
"RTN","HLUCM090",175,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","HLUCM090",176,0)
 S L1=""
"RTN","HLUCM090",177,0)
 F  S L1=$O(@GBL@(L1)) Q:L1']""  D
"RTN","HLUCM090",178,0)
 .  S (TOT1,TOT2,TOT3)=0
"RTN","HLUCM090",179,0)
 .  S L2=""
"RTN","HLUCM090",180,0)
 .  F  S L2=$O(@GBL@(L1,L2)) Q:L2']""  D
"RTN","HLUCM090",181,0)
 .  .  S L3=""
"RTN","HLUCM090",182,0)
 .  .  F  S L3=$O(@GBL@(L1,L2,L3)) Q:L3']""  D
"RTN","HLUCM090",183,0)
 .  .  .  S L4=""
"RTN","HLUCM090",184,0)
 .  .  .  F  S L4=$O(@GBL@(L1,L2,L3,L4)) Q:L4']""  D
"RTN","HLUCM090",185,0)
 .  .  .  .  S TOT=$G(@GBL@(L1,L2,L3,L4))
"RTN","HLUCM090",186,0)
 .  .  .  .  W !,$J(+TOT,6),?8,$J($P(TOT,U,2),6),?16,$J($P(TOT,U,3),6)
"RTN","HLUCM090",187,0)
 .  .  .  .  W ?24,L1,?29,L2,?34,L3,?39,$S($L(L4)<42:L4,1:$E(L4,1,40)_"~")
"RTN","HLUCM090",188,0)
 .  .  .  .  I L1="NMSP",L2'="IO" QUIT  ;->
"RTN","HLUCM090",189,0)
 .  .  .  .  S TOT1=TOT1+$P(TOT,U),TOT2=TOT2+$P(TOT,U,2),TOT3=TOT3+$P(TOT,U,3)
"RTN","HLUCM090",190,0)
 .  .  .  I L1="NMSP" S X=$O(@GBL@(L1,L2,L3)) I X]"",L3'=X W:WAY=1 !
"RTN","HLUCM090",191,0)
 .  .  I L1="NMSP" S X=$O(@GBL@(L1,L2)) I X]"",L2'=X W:WAY=1 !
"RTN","HLUCM090",192,0)
 .  I WAY=1 W !,$$REPEAT^XLFSTR("-",IOM),!,$J(TOT1,6),?8,$J(TOT2,6),?16,$J(TOT3,6),!
"RTN","HLUCM090",193,0)
 Q
"RTN","HLUCM090",194,0)
 ;
"RTN","HLUCM090",195,0)
FACDNS(FAC) ; Return STA#~STA-NAME~DNS if remote...
"RTN","HLUCM090",196,0)
 N FACNM,LOCAL
"RTN","HLUCM090",197,0)
 ;
"RTN","HLUCM090",198,0)
 ; Is FAC a local station number?
"RTN","HLUCM090",199,0)
 S LOCAL=$P($$SITE^VASITE,U,3)_"~"_$P($$SITE^VASITE,U,2)_"~LOCAL"
"RTN","HLUCM090",200,0)
 I +FAC=+LOCAL QUIT LOCAL ;->
"RTN","HLUCM090",201,0)
 ;
"RTN","HLUCM090",202,0)
 ; FAC not a station number, or not local...
"RTN","HLUCM090",203,0)
 S FACNM=$$FACFROM(FAC)
"RTN","HLUCM090",204,0)
 ;
"RTN","HLUCM090",205,0)
 I +FACNM'>0 QUIT LOCAL ;-> No site number found...
"RTN","HLUCM090",206,0)
 I +FACNM=+LOCAL QUIT LOCAL ;-> Local site number...
"RTN","HLUCM090",207,0)
 ;
"RTN","HLUCM090",208,0)
 QUIT:FACNM]"" FACNM ;->
"RTN","HLUCM090",209,0)
 ;
"RTN","HLUCM090",210,0)
 Q LOCAL
"RTN","HLUCM090",211,0)
 ;
"RTN","HLUCM090",212,0)
FACFROM(FAC) ; Find STA#~STA-NAME~DNS if remote...
"RTN","HLUCM090",213,0)
 N D,DIC,FACNM,STANO,X,Y
"RTN","HLUCM090",214,0)
 ;
"RTN","HLUCM090",215,0)
 QUIT:$G(FAC)']"" "" ;-> If no station number...
"RTN","HLUCM090",216,0)
 ;
"RTN","HLUCM090",217,0)
 ; Initial build of facility conversions...
"RTN","HLUCM090",218,0)
 D:'$D(^TMP($J,"HL4")) BLDHL4
"RTN","HLUCM090",219,0)
 ;
"RTN","HLUCM090",220,0)
 ; If facility is in facility conversion in ^TMP($J,"HL4")...
"RTN","HLUCM090",221,0)
 S FACNM=$G(^TMP($J,"HL4",FAC)) QUIT:FACNM]"" FACNM ;->
"RTN","HLUCM090",222,0)
 ;
"RTN","HLUCM090",223,0)
 ; Try to look up.  (See Integration Agreement# 10090)
"RTN","HLUCM090",224,0)
 ;
"RTN","HLUCM090",225,0)
 ; Pure station number lookup if leading 3 station number digits...
"RTN","HLUCM090",226,0)
 ; Otherwise, use the FACility name...
"RTN","HLUCM090",227,0)
 S DIC="^DIC(4,",DIC(0)="FMO",D="B^D",X=$S(+FAC?3N:+FAC,1:FAC)
"RTN","HLUCM090",228,0)
 D MIX^DIC1
"RTN","HLUCM090",229,0)
 ;
"RTN","HLUCM090",230,0)
 D FACVAR
"RTN","HLUCM090",231,0)
 ;
"RTN","HLUCM090",232,0)
 ; Success...
"RTN","HLUCM090",233,0)
 I FACNM]"" D  QUIT FACNM ;->
"RTN","HLUCM090",234,0)
 .  S FACNM=STANO_"~"_FACNM_"~DNS"
"RTN","HLUCM090",235,0)
 .  S ^TMP($J,"HL4",FAC)=FACNM
"RTN","HLUCM090",236,0)
 ;
"RTN","HLUCM090",237,0)
 ; Failed lookup...
"RTN","HLUCM090",238,0)
 I FACNM']"",+FAC'?3N QUIT "" ;-> Lookup on alpha facility name
"RTN","HLUCM090",239,0)
 I FACNM']"",+FAC=FAC QUIT "" ;-> Lookup on pure 3 digit station #
"RTN","HLUCM090",240,0)
 ;
"RTN","HLUCM090",241,0)
 ; Failed on lookup on ###, so try ###A...
"RTN","HLUCM090",242,0)
 KILL D,DIC,X,Y
"RTN","HLUCM090",243,0)
 S DIC="^DIC(4,",DIC(0)="FMO",D="B^D",X=FAC
"RTN","HLUCM090",244,0)
 ;
"RTN","HLUCM090",245,0)
 D FACVAR
"RTN","HLUCM090",246,0)
 ;
"RTN","HLUCM090",247,0)
 ; Success...
"RTN","HLUCM090",248,0)
 I FACNM]"" D  QUIT FACNM ;->
"RTN","HLUCM090",249,0)
 .  S FACNM=STANO_"~"_FACNM_"~DNS"
"RTN","HLUCM090",250,0)
 .  S ^TMP($J,"HL4",FAC)=FACNM
"RTN","HLUCM090",251,0)
 ;
"RTN","HLUCM090",252,0)
 Q ""
"RTN","HLUCM090",253,0)
 ;
"RTN","HLUCM090",254,0)
FACVAR ; Set up variables...
"RTN","HLUCM090",255,0)
 N DIC,X
"RTN","HLUCM090",256,0)
 S FACNO=+Y,FACNM=$P(Y,U,2),STANO=""
"RTN","HLUCM090",257,0)
 QUIT:FACNO'>0  ;->
"RTN","HLUCM090",258,0)
 S DIC=4,DR="99",DA=+FACNO,DIQ="DATA(",DIQ(0)="E"
"RTN","HLUCM090",259,0)
 D EN^DIQ1
"RTN","HLUCM090",260,0)
 S STANO=$G(DATA(4,+FACNO,99,"E"))
"RTN","HLUCM090",261,0)
 Q
"RTN","HLUCM090",262,0)
 ;
"RTN","HLUCM090",263,0)
BLDHL4 ; Build facility conversions...
"RTN","HLUCM090",264,0)
 N I,T F I=2:1 S T=$T(BLDHL4+I) Q:T'[";;"  S T=$P(T,";;",2,99),^TMP($J,"HL4",$P(T,U))=$P(T,U,2)
"RTN","HLUCM090",265,0)
 ;;200M^200M~MPI~DNS
"RTN","HLUCM090",266,0)
 ;;AUSTIN^200~AUSTIN~DNS
"RTN","HLUCM090",267,0)
 Q
"RTN","HLUCM090",268,0)
 ;
"RTN","HLUCM090",269,0)
EOR ;HLUCM090 - Facility Finder Software ;2/20/2003 - 12:35
"VER")
8.0^22.0
**END**
**END**
