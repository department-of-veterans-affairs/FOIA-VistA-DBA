Released PSX*2*58 SEQ #55
Extracted from mail message
**KIDS**:PSX*2.0*58^

**INSTALL NAME**
PSX*2.0*58
"BLD",6464,0)
PSX*2.0*58^CMOP^0^3070828^y
"BLD",6464,1,0)
^^20^20^3070828^
"BLD",6464,1,1,0)
This patch checks for the BAD ADDRESS INDICATOR field (#.121) of the
"BLD",6464,1,2,0)
PATIENT file (#2) being set or for the patient having a foreign address
"BLD",6464,1,3,0)
when queueing transactions to Consolidated Mail Outpatient Pharmacy
"BLD",6464,1,4,0)
(CMOP). If found, the fill stays on suspense for CMOP, but only prints the
"BLD",6464,1,5,0)
reject MailMan message the first time for the fill. The reject MailMan
"BLD",6464,1,6,0)
message is sent to holders of the PSXMAIL key and the person who queued
"BLD",6464,1,7,0)
the CMOP transmission. An entry is made into the PRESCRIPTION file (#52) 
"BLD",6464,1,8,0)
activity log the first time the fill cannot be transmitted due to one of 
"BLD",6464,1,9,0)
these two conditions.
"BLD",6464,1,10,0)
 
"BLD",6464,1,11,0)
This patch corrects the numbering of refills in the RX REFERENCE field 
"BLD",6464,1,12,0)
(#.04) of the ACTIVITY LOG multiple (#52.3) of the PRESCRIPTION file
"BLD",6464,1,13,0)
(#52). A number 6 in the  field should mean a partial and any refills 
"BLD",6464,1,14,0)
greater than the 5th refill should be stored as 1 plus the actual refill 
"BLD",6464,1,15,0)
number. 
"BLD",6464,1,16,0)
 
"BLD",6464,1,17,0)
This patch also removes a call to a routine that is not used (related to 
"BLD",6464,1,18,0)
Outpatient Pharmacy V. 6.0 sending information to the CLINICAL INFO
"BLD",6464,1,19,0)
RESOURCE NETWORK (CIRN) package). Outpatient Pharmacy will be removed as a
"BLD",6464,1,20,0)
subscriber to Data Base Integration Agreement (DBIA) 2382.
"BLD",6464,4,0)
^9.64PA^^
"BLD",6464,6.3)
2
"BLD",6464,"KRN",0)
^9.67PA^8989.52^19
"BLD",6464,"KRN",.4,0)
.4
"BLD",6464,"KRN",.401,0)
.401
"BLD",6464,"KRN",.402,0)
.402
"BLD",6464,"KRN",.403,0)
.403
"BLD",6464,"KRN",.5,0)
.5
"BLD",6464,"KRN",.84,0)
.84
"BLD",6464,"KRN",3.6,0)
3.6
"BLD",6464,"KRN",3.8,0)
3.8
"BLD",6464,"KRN",9.2,0)
9.2
"BLD",6464,"KRN",9.8,0)
9.8
"BLD",6464,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",6464,"KRN",9.8,"NM",1,0)
PSXERR^^0^B36388542
"BLD",6464,"KRN",9.8,"NM",2,0)
PSXRPPL^^0^B64176259
"BLD",6464,"KRN",9.8,"NM",3,0)
PSXVND^^0^B36308347
"BLD",6464,"KRN",9.8,"NM",4,0)
PSXMISC1^^0^B46670471
"BLD",6464,"KRN",9.8,"NM","B","PSXERR",1)

"BLD",6464,"KRN",9.8,"NM","B","PSXMISC1",4)

"BLD",6464,"KRN",9.8,"NM","B","PSXRPPL",2)

"BLD",6464,"KRN",9.8,"NM","B","PSXVND",3)

"BLD",6464,"KRN",19,0)
19
"BLD",6464,"KRN",19.1,0)
19.1
"BLD",6464,"KRN",101,0)
101
"BLD",6464,"KRN",409.61,0)
409.61
"BLD",6464,"KRN",771,0)
771
"BLD",6464,"KRN",870,0)
870
"BLD",6464,"KRN",8989.51,0)
8989.51
"BLD",6464,"KRN",8989.52,0)
8989.52
"BLD",6464,"KRN",8994,0)
8994
"BLD",6464,"KRN","B",.4,.4)

"BLD",6464,"KRN","B",.401,.401)

"BLD",6464,"KRN","B",.402,.402)

"BLD",6464,"KRN","B",.403,.403)

"BLD",6464,"KRN","B",.5,.5)

"BLD",6464,"KRN","B",.84,.84)

"BLD",6464,"KRN","B",3.6,3.6)

"BLD",6464,"KRN","B",3.8,3.8)

"BLD",6464,"KRN","B",9.2,9.2)

"BLD",6464,"KRN","B",9.8,9.8)

"BLD",6464,"KRN","B",19,19)

"BLD",6464,"KRN","B",19.1,19.1)

"BLD",6464,"KRN","B",101,101)

"BLD",6464,"KRN","B",409.61,409.61)

"BLD",6464,"KRN","B",771,771)

"BLD",6464,"KRN","B",870,870)

"BLD",6464,"KRN","B",8989.51,8989.51)

"BLD",6464,"KRN","B",8989.52,8989.52)

"BLD",6464,"KRN","B",8994,8994)

"BLD",6464,"QUES",0)
^9.62^^
"BLD",6464,"REQB",0)
^9.611^2^2
"BLD",6464,"REQB",1,0)
PSX*2.0*62^2
"BLD",6464,"REQB",2,0)
PSX*2.0*54^2
"BLD",6464,"REQB","B","PSX*2.0*54",2)

"BLD",6464,"REQB","B","PSX*2.0*62",1)

"MBREQ")
0
"PKG",526,-1)
1^1
"PKG",526,0)
CMOP^PSX^CONSOLIDATED MAIL OUTPATIENT PHARMACY
"PKG",526,20,0)
^9.402P^^
"PKG",526,22,0)
^9.49I^1^1
"PKG",526,22,1,0)
2.0^3000210^3000217^11853
"PKG",526,22,1,"PAH",1,0)
58^3070828
"PKG",526,22,1,"PAH",1,1,0)
^^20^20^3070828
"PKG",526,22,1,"PAH",1,1,1,0)
This patch checks for the BAD ADDRESS INDICATOR field (#.121) of the
"PKG",526,22,1,"PAH",1,1,2,0)
PATIENT file (#2) being set or for the patient having a foreign address
"PKG",526,22,1,"PAH",1,1,3,0)
when queueing transactions to Consolidated Mail Outpatient Pharmacy
"PKG",526,22,1,"PAH",1,1,4,0)
(CMOP). If found, the fill stays on suspense for CMOP, but only prints the
"PKG",526,22,1,"PAH",1,1,5,0)
reject MailMan message the first time for the fill. The reject MailMan
"PKG",526,22,1,"PAH",1,1,6,0)
message is sent to holders of the PSXMAIL key and the person who queued
"PKG",526,22,1,"PAH",1,1,7,0)
the CMOP transmission. An entry is made into the PRESCRIPTION file (#52) 
"PKG",526,22,1,"PAH",1,1,8,0)
activity log the first time the fill cannot be transmitted due to one of 
"PKG",526,22,1,"PAH",1,1,9,0)
these two conditions.
"PKG",526,22,1,"PAH",1,1,10,0)
 
"PKG",526,22,1,"PAH",1,1,11,0)
This patch corrects the numbering of refills in the RX REFERENCE field 
"PKG",526,22,1,"PAH",1,1,12,0)
(#.04) of the ACTIVITY LOG multiple (#52.3) of the PRESCRIPTION file
"PKG",526,22,1,"PAH",1,1,13,0)
(#52). A number 6 in the  field should mean a partial and any refills 
"PKG",526,22,1,"PAH",1,1,14,0)
greater than the 5th refill should be stored as 1 plus the actual refill 
"PKG",526,22,1,"PAH",1,1,15,0)
number. 
"PKG",526,22,1,"PAH",1,1,16,0)
 
"PKG",526,22,1,"PAH",1,1,17,0)
This patch also removes a call to a routine that is not used (related to 
"PKG",526,22,1,"PAH",1,1,18,0)
Outpatient Pharmacy V. 6.0 sending information to the CLINICAL INFO
"PKG",526,22,1,"PAH",1,1,19,0)
RESOURCE NETWORK (CIRN) package). Outpatient Pharmacy will be removed as a
"PKG",526,22,1,"PAH",1,1,20,0)
subscriber to Data Base Integration Agreement (DBIA) 2382.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSXERR")
0^1^B36388542^B35308373
"RTN","PSXERR",1,0)
PSXERR ;BIR/BAB,WPB,HTW,PWC-Error Processing Utility ;MAR 1,2002@13:13:34
"RTN","PSXERR",2,0)
 ;;2.0;CMOP;**1,3,28,30,42,41,52,54,58**;11 Apr 97;Build 2
"RTN","PSXERR",3,0)
 ; Reference to ^PS(59,  supported by DBIA #1976
"RTN","PSXERR",4,0)
 ; Reference to file #52 supported by DBIA #1977
"RTN","PSXERR",5,0)
 ; This routine will be used to send mail messages when errors
"RTN","PSXERR",6,0)
 ; have occurred during the processing of prescription data for
"RTN","PSXERR",7,0)
 ; the Consolidated Mail Outpatient Pharmacy system.
"RTN","PSXERR",8,0)
EN S ERRTXT(1)="An error has been encountered while processing prescription data for the"
"RTN","PSXERR",9,0)
 S ERRTXT(2)="Consolidated Mail Outpatient Pharmacy system."
"RTN","PSXERR",10,0)
 S X=PSXJOB,XMSUB="CMOP Error Encountered"
"RTN","PSXERR",11,0)
 I $G(PSOSITE) S XMSUB=$$GET1^DIQ(59,PSOSITE,.06)_" "_XMSUB
"RTN","PSXERR",12,0)
 S XY=$S(X=1:"Transmission of Batch Data",X=2:"Re-Transmission of Batch Data",X=3:"Purge of CMOP RX QUEUE file",X=4:"Filing of CMOP Dispense Data",X=5:"Background Auto-transmission of Data",X=6:"Release Data",X=7:"Data Validation",1:"")
"RTN","PSXERR",13,0)
 D NOW^%DTC S Y=% X ^DD("DD") S DTTM=$P(Y,":",1,2) K Y
"RTN","PSXERR",14,0)
 S ERRTXT(3)=""
"RTN","PSXERR",15,0)
 S ERRTXT(4)="Date/Time    :  "_DTTM
"RTN","PSXERR",16,0)
 S ERRTXT(5)="Process      :  "_XY
"RTN","PSXERR",17,0)
 S ERRTXT(6)="Error Type   :  "_TYPE
"RTN","PSXERR",18,0)
 S ERRTXT(7)=""
"RTN","PSXERR",19,0)
 S ERRTXT(8)="Description  :  "_$G(DESCRTN)
"RTN","PSXERR",20,0)
 S ERRTXT(9)=""
"RTN","PSXERR",21,0)
 S ERRTXT(PSXCT+2)="Action Taken:  "_ACTION,ERRTXT(PSXCT+3)=""
"RTN","PSXERR",22,0)
 S ERRTXT(PSXCT+4)="Recommended action:  "_RECM
"RTN","PSXERR",23,0)
 D MAIL
"RTN","PSXERR",24,0)
EXIT K ERRTXT,PSXM,PSXCT,PSXGRP,XMSUB,XMY,XMTEXT,XMDUZ,%,XMDUN,XMZ,ACTION,DESCRTN,DTTM,ERROR,FILL,FLG,MSG,P1,P2,PSXCT,RECM,RXP,TYPE,X,PSXJOB,PSXREF,XY
"RTN","PSXERR",25,0)
 Q
"RTN","PSXERR",26,0)
ER1 ;errors encountered while building the mail message for transmission
"RTN","PSXERR",27,0)
 Q:$P($G(PSXER),"^",2)=""
"RTN","PSXERR",28,0)
 S ERRTXT(10)="The following data is missing in the OUTPATIENT SITE file (#59).",ERRTXT(11)=""
"RTN","PSXERR",29,0)
 S PSXCT=11,PSXCT=PSXCT+1,PSXJOB=1
"RTN","PSXERR",30,0)
 F XX=2:1 Q:$P(PSXER,"^",XX)=""  D
"RTN","PSXERR",31,0)
 .S ERR=$P(PSXER,"^",XX),PSXCT=PSXCT+1,MSG=$P($T(DERR+ERR),";;",2) S ERRTXT(PSXCT)=MSG
"RTN","PSXERR",32,0)
 S PSXCT=PSXCT+1,ERRTXT(PSXCT)=""
"RTN","PSXERR",33,0)
 S PSXERFLG=1,ACTION="No data transmission will occur without this information.",RECM="Correct invalid data.",TYPE="Invalid or missing data"
"RTN","PSXERR",34,0)
 D EN
"RTN","PSXERR",35,0)
 Q
"RTN","PSXERR",36,0)
ER2 ;errors encountered while building the mail message for retransmission
"RTN","PSXERR",37,0)
 S P1=$P($G(PSXERR),U,1),P2=$P($G(PSXERR),U,2)
"RTN","PSXERR",38,0)
 S ERROR=$P($T(DATAERR+10),";;",2)
"RTN","PSXERR",39,0)
 I P1=2 S PSXCT=PSXCT+1,ERRTXT(PSXCT)=$P($G(ERROR),"^",1)_$P($G(ERROR),"^",P2)
"RTN","PSXERR",40,0)
 S PSXCT=PSXCT+1,ERRTXT(PSXCT)=""
"RTN","PSXERR",41,0)
 S PSXCT=PSXCT+1,ERRTXT(PSXCT)=$S(P2=5:"The retransmitted batch will be placed in a hold status.  Please release the correct batch when ready.",P2'=5:"The retransmitted batch was not downloaded into the files.",1:"")
"RTN","PSXERR",42,0)
 K PSXERR
"RTN","PSXERR",43,0)
 Q
"RTN","PSXERR",44,0)
ER4 S PSXCT=11
"RTN","PSXERR",45,0)
 S RECM="Call IRM to check data and correct"
"RTN","PSXERR",46,0)
 S TYPE="Missing Data - No match found for return data."
"RTN","PSXERR",47,0)
 S ACTION="Return data not filed for Rx listed, background release not performed."
"RTN","PSXERR",48,0)
 S ERRTXT(PSXCT)=" RX#    FILL#    BATCH#   SEQUENCE#  "
"RTN","PSXERR",49,0)
 F I=1:1 S PSXCT=PSXCT+1 Q:$G(PSXER(I))']""  S ERRTXT(PSXCT)=PSXER(I)
"RTN","PSXERR",50,0)
 D EN
"RTN","PSXERR",51,0)
 K PSXER,I
"RTN","PSXERR",52,0)
 Q
"RTN","PSXERR",53,0)
ER6 S PSXCT=11
"RTN","PSXERR",54,0)
 S RECM="Call IRM to check data and correct"
"RTN","PSXERR",55,0)
 S TYPE="Invalid data "
"RTN","PSXERR",56,0)
 S DESCRTN="During processing of Vendor return data, CMOP attempted to release the following Rx.  This Rx has already been Released locally!.  This will invalidate your stock levels for this drug!"
"RTN","PSXERR",57,0)
 S ACTION="Rx was not released by CMOP."
"RTN","PSXERR",58,0)
 S ERRTXT(PSXCT)="RX#  "_$P(^PSRX(RXP,0),"^")_"     FILL#  "_$G(PSXREF)
"RTN","PSXERR",59,0)
 D EN
"RTN","PSXERR",60,0)
 Q
"RTN","PSXERR",61,0)
ER7 ;Set up prescription data for message.
"RTN","PSXERR",62,0)
 Q:$P($G(PSXRXERR),"^",3)=""
"RTN","PSXERR",63,0)
 N DFN,RX,VA
"RTN","PSXERR",64,0)
 S ERRTXT(10)="RX #       Fill       Data Field         SSN          NAME"
"RTN","PSXERR",65,0)
 S ERRTXT(11)=""
"RTN","PSXERR",66,0)
 S:PSXERFLG=0 PSXCT=11
"RTN","PSXERR",67,0)
 S RXNM=$P(PSXRXERR,"^",1),FILL=$P(PSXRXERR,"^",2)
"RTN","PSXERR",68,0)
 S RXF=$S(FILL=0:"Original ",FILL>0:"Refill #"_FILL,1:"")
"RTN","PSXERR",69,0)
 S PSXCT=PSXCT+1,FLG=0,BLANK=$J(" ",50)
"RTN","PSXERR",70,0)
 F XX=3:1 Q:$P(PSXRXERR,"^",XX)=""  D
"RTN","PSXERR",71,0)
 .S RX(2,"E")=$$GET1^DIQ(52,RXN,2)      ; patient name
"RTN","PSXERR",72,0)
 .S RX(2,"I")=$$GET1^DIQ(52,RXN,2,"I")  ; DFN
"RTN","PSXERR",73,0)
 .S DFN=RX(2,"I") D PID^VADPT
"RTN","PSXERR",74,0)
 .S ERR=$P(PSXRXERR,"^",XX),PSXCT=PSXCT+1,CNT=ERR-1
"RTN","PSXERR",75,0)
 .S MSG=$P($T(DATAERR+CNT),";;",2)
"RTN","PSXERR",76,0)
 .I FLG=0 S ERRTXT(PSXCT)=RXNM_"  "_RXF_"  "_$E(MSG_BLANK,1,17)_"  "_VA("PID")_" "_(RX(2,"E")),FLG=1 Q
"RTN","PSXERR",77,0)
 .I FLG=1 S ERRTXT(PSXCT)="                         "_MSG,FLG=1 Q
"RTN","PSXERR",78,0)
 S PSXCT=PSXCT+1,ERRTXT(PSXCT)=""
"RTN","PSXERR",79,0)
 K PSXRXERR,RXNM,RXF,DAYS,CNT,ERR,DRUG,FDATE,PHAR,PHY,PSTAT,QTY,REF,RXERR,SIG,XX,BLANK
"RTN","PSXERR",80,0)
 S PSXERFLG=1,ACTION="Rx's not sent to CMOP but still suspended for transmission.",RECM="Correct invalid data.",TYPE="Invalid or missing data"
"RTN","PSXERR",81,0)
 I '$G(PSXGOOD) S ACTION="Rx's not sent to CMOP. If Bad Address Indicator or foreign address, will remain on suspense for CMOP, but will only show on reject log once." K PSXGOOD
"RTN","PSXERR",82,0)
 Q
"RTN","PSXERR",83,0)
MAIL ;Transmit.
"RTN","PSXERR",84,0)
 S XMDUZ=.5,XMTEXT="ERRTXT("
"RTN","PSXERR",85,0)
 K XMY ; get mail group to notify and save in PSXGRP
"RTN","PSXERR",86,0)
 D GRP^PSXNOTE
"RTN","PSXERR",87,0)
 D ^XMD
"RTN","PSXERR",88,0)
 Q
"RTN","PSXERR",89,0)
 ;
"RTN","PSXERR",90,0)
DATAERR ;list of errrors that can occur while checking the rx prior to transmit
"RTN","PSXERR",91,0)
 ;;Quantity
"RTN","PSXERR",92,0)
 ;;Prescribing Physician
"RTN","PSXERR",93,0)
 ;;Days supply
"RTN","PSXERR",94,0)
 ;;Drug id
"RTN","PSXERR",95,0)
 ;;SIG
"RTN","PSXERR",96,0)
 ;;Patient status
"RTN","PSXERR",97,0)
 ;;Fill date
"RTN","PSXERR",98,0)
 ;;Clerk not entered
"RTN","PSXERR",99,0)
 ;;Patient Address
"RTN","PSXERR",100,0)
 ;;Original batch ^not on file.^is currently processing.^is closed.^is already on hold.
"RTN","PSXERR",101,0)
 ;;Fill has already been transmitted
"RTN","PSXERR",102,0)
 ;;Spaces in Rx number
"RTN","PSXERR",103,0)
 ;;Duplicate Rx
"RTN","PSXERR",104,0)
 ;;Patient Mail Status Change
"RTN","PSXERR",105,0)
 ;;Drug Warnings >11 Characters
"RTN","PSXERR",106,0)
 ;;Patient in the Merging Process
"RTN","PSXERR",107,0)
 ;;RX OERR/CPRS Locked
"RTN","PSXERR",108,0)
 ;;Test Patient
"RTN","PSXERR",109,0)
 ;;Bad Address Indicator no active temporary address
"RTN","PSXERR",110,0)
DERR ;list of errors for transmission
"RTN","PSXERR",111,0)
 ;;State
"RTN","PSXERR",112,0)
 ;;Site
"RTN","PSXERR",113,0)
 ;;Name
"RTN","PSXERR",114,0)
 ;;Street Address
"RTN","PSXERR",115,0)
 ;;City
"RTN","PSXERR",116,0)
 ;;Zip Code
"RTN","PSXERR",117,0)
 ;;Area Code
"RTN","PSXERR",118,0)
 ;;Phone Number
"RTN","PSXERR",119,0)
 ;;Refillable Instructions
"RTN","PSXERR",120,0)
 ;;Nonrefillable Instructions
"RTN","PSXERR",121,0)
 ;;Station number is missing in the Institution file
"RTN","PSXERR",122,0)
 ;;Package file entry for Outpatient Pharmacy is bad
"RTN","PSXERR",123,0)
 Q
"RTN","PSXMISC1")
0^4^B46670471^B38388550
"RTN","PSXMISC1",1,0)
PSXMISC1 ;BIR/WPB,BAB-Transmission Data Validation ;MAR 1,2002@13:13:34
"RTN","PSXMISC1",2,0)
 ;;2.0;CMOP;**3,18,23,28,30,42,41,52,54,58**;11 Apr 97;Build 2
"RTN","PSXMISC1",3,0)
 ;Reference to ^PSDRUG(  supported by DBIA #1983
"RTN","PSXMISC1",4,0)
 ;Reference to ^PS(52.5, supported by DBIA #1978
"RTN","PSXMISC1",5,0)
 ;Reference to ^PSRX(    supported by DBIA #1977
"RTN","PSXMISC1",6,0)
 ;Reference to ^PS(55,   supported by DBIA #2228
"RTN","PSXMISC1",7,0)
 ;Reference to PROD2^PSNAPIS supported by DBIA #2531
"RTN","PSXMISC1",8,0)
 ;Reference to ^PSSLOCK supported by DBIA #2789
"RTN","PSXMISC1",9,0)
 ;Reference to CHKRX^PSOBAI supported by DBIA #4910
"RTN","PSXMISC1",10,0)
CHKDATA ;checks the data elements in PSRX before putting the rx in 550.2
"RTN","PSXMISC1",11,0)
 Q:'$D(^PS(52.5,REC,0))
"RTN","PSXMISC1",12,0)
 K DRUGCHK,PSXRXERR,PSXDGST,WARNS
"RTN","PSXMISC1",13,0)
 S (RXN,PSXPTR)=$P($G(^PS(52.5,REC,0)),"^",1) I PSXPTR="" S PSXOK=8 Q
"RTN","PSXMISC1",14,0)
 D PSOL^PSSLOCK(RXN) S PSOMSG=+PSOMSG ; sets PSOMSG
"RTN","PSXMISC1",15,0)
 I ($P(^PS(52.5,REC,0),U,3)'=XDFN)!($P(^PSRX(PSXPTR,0),U,2)'=XDFN) S PSXOK=8 Q
"RTN","PSXMISC1",16,0)
 I '$D(^PSRX(PSXPTR,0)) S PSXOK=8 Q
"RTN","PSXMISC1",17,0)
 S RXNUM=$P($G(^PSRX(PSXPTR,0)),"^",6),RXEX=$P($G(^PSRX(PSXPTR,0)),"^",1)
"RTN","PSXMISC1",18,0)
 I $G(^PSDRUG(RXNUM,"ND"))'="" D
"RTN","PSXMISC1",19,0)
 .S PTRA=$P($G(^PSDRUG(RXNUM,"ND")),U,1),PTRB=$P($G(^PSDRUG(RXNUM,"ND")),U,3)
"RTN","PSXMISC1",20,0)
 .I $G(PTRA)'="" S ZX=$$PROD2^PSNAPIS(PTRA,PTRB),DRUGCHK=$P($G(ZX),"^",3)
"RTN","PSXMISC1",21,0)
 S:$G(DRUGCHK)'="" PSXDGST=$P(ZX,"^",2)_"^"_$P(ZX,"^")
"RTN","PSXMISC1",22,0)
 I '$D(DRUGCHK) S DRUGCHK=0
"RTN","PSXMISC1",23,0)
 S:'$D(^PSDRUG("AQ",RXNUM)) PSXOK=1
"RTN","PSXMISC1",24,0)
 S:$G(DRUGCHK)'=1 PSXOK=1
"RTN","PSXMISC1",25,0)
 I $P(^PSDRUG(RXNUM,2),"^",3)'["O" S PSXOK=1,PSXCK=RXNUM D UNMARK^PSXUTL
"RTN","PSXMISC1",26,0)
 S:$P($G(^PSRX(PSXPTR,"STA")),U,1)'=5 PSXOK=5
"RTN","PSXMISC1",27,0)
 ;gets the fill number by ordering thru the refill node for the last
"RTN","PSXMISC1",28,0)
 ;refill number
"RTN","PSXMISC1",29,0)
 S FILNUM=0 F REF=0:0 S REF=$O(^PSRX(PSXPTR,1,REF)) Q:REF'>0  S:REF>0 FILNUM=REF S:REF="" FILNUM=0
"RTN","PSXMISC1",30,0)
 ;I $G(PSXFLAG)=2 S PSXOK=0 Q
"RTN","PSXMISC1",31,0)
 S RXF=FILNUM
"RTN","PSXMISC1",32,0)
 S REL=$S(RXF>0:$P($G(^PSRX(RXN,1,RXF,0)),U,18),RXF=0:$P($G(^PSRX(RXN,2)),U,13),1:"") I $G(REL)'="" S PSXOK=6
"RTN","PSXMISC1",33,0)
 S:((PSXOK=0)&(FILNUM>0)&($P($G(^PSRX(PSXPTR,1,FILNUM,0)),"^",2)'="M")) PSXOK=3
"RTN","PSXMISC1",34,0)
 S:((PSXOK=0)&(FILNUM'>0)&($P($G(^PSRX(PSXPTR,0)),"^",11)'="M")) PSXOK=3
"RTN","PSXMISC1",35,0)
 I $G(^PS(52.5,REC,"P"))="1" S PSXOK=4
"RTN","PSXMISC1",36,0)
 S PSXDIV=$S(FILNUM=0:$P($G(^PSRX(PSXPTR,2)),U,9),FILNUM>0:$P($G(^PSRX(PSXPTR,1,FILNUM,0)),"^",9),1:"")
"RTN","PSXMISC1",37,0)
 ;If trans div does not match Rx div eliminate
"RTN","PSXMISC1",38,0)
 I PSXDIV'=PSOSITE S PSXOK=7 Q
"RTN","PSXMISC1",39,0)
 ; Changes for Controlled subs 
"RTN","PSXMISC1",40,0)
 N PSXCSC,PSXCSD S PSXCSRX=""
"RTN","PSXMISC1",41,0)
 S PSXCSC=$P($G(^PSDRUG(RXNUM,0)),"^",3)
"RTN","PSXMISC1",42,0)
 ;Can't trans DEA schedule 1 or 2
"RTN","PSXMISC1",43,0)
 I $G(PSXCSC)[1!$G(PSXCSC)[2 S PSXOK=10 Q
"RTN","PSXMISC1",44,0)
 ;If CS must be DEA 3-5 to qualify
"RTN","PSXMISC1",45,0)
 F PSXCSD=3:1:5 I PSXCSC[PSXCSD S PSXCSRX=1
"RTN","PSXMISC1",46,0)
 ;If not CS drug and CS trans eliminate
"RTN","PSXMISC1",47,0)
 I ($G(PSXCSRX)<1)&($G(PSXCS)=1) S PSXOK=9 Q
"RTN","PSXMISC1",48,0)
 ;If CS drug and not CS trans eliminate
"RTN","PSXMISC1",49,0)
 I ($G(PSXCSRX)=1)&($G(PSXCS)<1) S PSXOK=9 Q
"RTN","PSXMISC1",50,0)
 ; Checks for do not mail and expiration date thereof
"RTN","PSXMISC1",51,0)
 ; moved to under NOGO
"RTN","PSXMISC1",52,0)
 ;
"RTN","PSXMISC1",53,0)
 G:PSXOK'=0 STOP
"RTN","PSXMISC1",54,0)
NOGO ;any rx that does not pass the following checks will not be transmitted
"RTN","PSXMISC1",55,0)
 ;and an error message will be generated and sent to the user who
"RTN","PSXMISC1",56,0)
 ;initiated the transmission.  All that pass the checks will be sent.
"RTN","PSXMISC1",57,0)
 S RXERR=0,PSXRXERR=RXEX_"^"_RXF
"RTN","PSXMISC1",58,0)
 I RXEX[" " S RXERR=13,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",59,0)
 S QTY=$S(RXF>0:$P($G(^PSRX(RXN,1,RXF,0)),U,4),RXF=0:$P($G(^PSRX(RXN,0)),U,7),1:"") G:$G(QTY)'=""&($G(QTY)>0)&(QTY?.N)!(QTY?.N1".".N) NG1 S RXERR=2,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",60,0)
NG1 S PHY=$S(RXF>0:$P($G(^PSRX(RXN,1,RXF,0)),U,17),RXF=0:$P($G(^PSRX(RXN,0)),U,4),1:"") I PHY="" S RXERR=3,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",61,0)
 S DAYS=$S(RXF>0:$P($G(^PSRX(RXN,1,RXF,0)),U,10),RXF=0:$P($G(^PSRX(RXN,0)),U,8),1:"") I (DAYS'>0)!(DAYS="") S RXERR=4,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",62,0)
 S PHARCLK=$S(RXF>0:$P($G(^PSRX(RXN,1,RXF,0)),U,7),RXF=0:$P($G(^PSRX(RXN,0)),U,16),1:"") I PHARCLK="" S RXERR=9,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",63,0)
 S DRUG=$P($G(^PSRX(RXN,0)),U,6),PSTAT=$P($G(^(0)),U,3),FDATE=$P($G(^PSRX(RXN,2)),U,2)
"RTN","PSXMISC1",64,0)
 D TSTSIG
"RTN","PSXMISC1",65,0)
 S DFN=$P($G(^PSRX(RXN,0)),U,2) D ADD^VADPT I ($G(VAPA(1))="")!($G(VAPA(4))="")!($P($G(VAPA(5)),"^",2)="")!($G(VAPA(6))'>0)!($P($G(VAPA(11)),"^",2)'>0) S RXERR=10,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",66,0)
 D DEM^VADPT
"RTN","PSXMISC1",67,0)
 I VADM(1)["MERGING" S RXERR=17,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",68,0)
 ;MVP OIFO BAY PINES;ELR;PSX*2*52  CHANGED RXERR FROM 10 TO 19. ADDED NEW ERROR IN PSXERR
"RTN","PSXMISC1",69,0)
 I $G(VA("PID"))["000-00" S RXERR=19,PSXRXERR=PSXRXERR_"^"_RXERR ; SSN ["000-00" indicates test patient
"RTN","PSXMISC1",70,0)
 S (CNTR,XC,DUPFLG)=0,DUPRX="" F  S XC=$O(^PSRX("B",RXEX,XC)) Q:XC'>0  S CNTR=CNTR+1,DUPRX=DUPRX_"^"_XC
"RTN","PSXMISC1",71,0)
 I CNTR>1 D
"RTN","PSXMISC1",72,0)
 .Q:$P(DUPRX,"^",3)=""
"RTN","PSXMISC1",73,0)
 .F I2=2:1 S I1=$P(DUPRX,"^",I2) Q:I1=""  S PSREC=$O(^PS(52.5,"B",I1,"")) Q:$G(PSREC)'>0  S:($P(^PS(52.5,PSREC,0),"^",2)<PSXDTRG&($P(^PS(52.5,PSREC,0),"^",7)="Q")) DUPFLG=1
"RTN","PSXMISC1",74,0)
 S:$G(DUPFLG)>0 PSXRXERR=PSXRXERR_"^"_"14"
"RTN","PSXMISC1",75,0)
 K CNTR,XC,DUPRX,I2,I1,PSREC,DUPFLG
"RTN","PSXMISC1",76,0)
 I $D(^PSRX(PSXPTR,4,0)) D
"RTN","PSXMISC1",77,0)
 .S RXERR=""
"RTN","PSXMISC1",78,0)
 .S ZX=0 F  S ZX=$O(^PSRX(PSXPTR,4,ZX)) Q:ZX'>0  D
"RTN","PSXMISC1",79,0)
 ..I $P(^PSRX(PSXPTR,4,ZX,0),"^",3)=RXF&($P(^PSRX(PSXPTR,4,ZX,0),"^",4)'=3) S RXERR=12
"RTN","PSXMISC1",80,0)
 ..I $P(^PSRX(PSXPTR,4,ZX,0),"^",3)=RXF&($P(^PSRX(PSXPTR,4,ZX,0),"^",4)=3) S RXERR=""
"RTN","PSXMISC1",81,0)
 .I RXERR'="" S PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",82,0)
 I DRUG="" S RXERR=5,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",83,0)
 I DRUG S WARNS=$P(^PSDRUG(DRUG,0),"^",8) D
"RTN","PSXMISC1",84,0)
 .;IF USING NEW WARNING SOURCE, LENGTH OF OLD WARNINGS DOESN'T MATTER
"RTN","PSXMISC1",85,0)
 .I '$D(PSSWSITE) S PSSWSITE=+$O(^PS(59.7,0))
"RTN","PSXMISC1",86,0)
 .I $P($G(^PS(59.7,PSSWSITE,10)),"^",10)="N" Q
"RTN","PSXMISC1",87,0)
 .I $G(WARNS) S:$L(WARNS)>11 RXERR=16,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",88,0)
 I SIG="" S RXERR=6,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",89,0)
 I PSTAT="" S RXERR=7,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",90,0)
 I FDATE'?7N S RXERR=8,PSXRXERR=PSXRXERR_"^"_RXERR
"RTN","PSXMISC1",91,0)
 I '$$MAILOK(RXN) D
"RTN","PSXMISC1",92,0)
 . S COM="Removed from CMOP Suspense - Mail Status Change" D NOW^%DTC S DTTM=% K % D ACTLOG^PSXRPPL
"RTN","PSXMISC1",93,0)
 . D DELETE^PSXRPPL S PSXOK=1
"RTN","PSXMISC1",94,0)
 . ;MVP OIFO BAY PINES;ELR;PSX*2*5 DELETE MM MSG FOR DO NOT MAIL
"RTN","PSXMISC1",95,0)
 . ;S RXERR=15,PSXRXERR=PSXRXERR_"^"_RXERR ;mail message to users
"RTN","PSXMISC1",96,0)
 I $D(^TMP($J,"PSXBAI",DFN)),'$G(^TMP($J,"PSXBAI",DFN)) D
"RTN","PSXMISC1",97,0)
 . S PSXOK=8
"RTN","PSXMISC1",98,0)
 . D CHKACT(PSXPTR)
"RTN","PSXMISC1",99,0)
 . I '$G(PSXFIRST) K PSXRXERR Q
"RTN","PSXMISC1",100,0)
 . S COM="Bad Address Indicator or Foreign Address. Not removed from CMOP Suspense" D NOW^%DTC S DTTM=% K % D ACTLOG^PSXRPPL
"RTN","PSXMISC1",101,0)
 . S RXERR=20,PSXRXERR=PSXRXERR_"^"_RXERR ;mail message to users
"RTN","PSXMISC1",102,0)
PSOMSG I +PSOMSG=0 S RXERR=18,PSXRXERR=PSXRXERR_"^"_RXERR ; from PSSLOCK
"RTN","PSXMISC1",103,0)
 I $P($G(PSXRXERR),"^",3)'="" S PSXOK=8 D ER7^PSXERR
"RTN","PSXMISC1",104,0)
STOP K DAYS,DRUG,FDATE,PHARCLK,PHY,PSTAT,QTY,RXERR,RXEX,SIG,VAPA(1),DRUGCHK,PTRA,PTRB,REL,RXNUM,PHARCLK1,ZX,VAPA(4),VAPA(5),VAPA(6)
"RTN","PSXMISC1",105,0)
 Q
"RTN","PSXMISC1",106,0)
 ;
"RTN","PSXMISC1",107,0)
TSTSIG ; include testing for BAD characters in SIG
"RTN","PSXMISC1",108,0)
 I $P(^PSRX(RXN,"SIG"),"^",2)'>0 S SIG=$P(^PSRX(RXN,"SIG"),"^") D TSTCHAR
"RTN","PSXMISC1",109,0)
 I $P(^PSRX(RXN,"SIG"),"^",2)=1 N L S L=0 F  S L=$O(^PSRX(RXN,"SIG1",L)) Q:L'>0  S SIG=$G(^PSRX(RXN,"SIG1",L,0)) D TSTCHAR Q:SIG=""
"RTN","PSXMISC1",110,0)
 Q
"RTN","PSXMISC1",111,0)
TSTCHAR ; test each character of SIG for certain characters
"RTN","PSXMISC1",112,0)
 N I,C
"RTN","PSXMISC1",113,0)
 I '$D(^TMP($J,"PSXCHAR")) D
"RTN","PSXMISC1",114,0)
 . F I=0:1:31 S ^TMP($J,"PSXCHAR",I)=""
"RTN","PSXMISC1",115,0)
 . F I=92,94,124,127 S ^TMP($J,"PSXCHAR",I)=""
"RTN","PSXMISC1",116,0)
 F I=1:1:$L(SIG) S C=$A($E(SIG,I)) I $D(^TMP($J,"PSXCHAR",C)) S SIG="" Q
"RTN","PSXMISC1",117,0)
 Q
"RTN","PSXMISC1",118,0)
MAILOK(TRX) ; return 1 if patient still in mail status & ok to CMOP
"RTN","PSXMISC1",119,0)
 N PSOMDT,PSOMC,DFN
"RTN","PSXMISC1",120,0)
 S DFN=$P(^PSRX(TRX,0),"^",2),PSOMDT=$P($G(^PS(55,DFN,0)),"^",5),PSOMC=$P($G(^PS(55,DFN,0)),"^",3)
"RTN","PSXMISC1",121,0)
 I (PSOMC>1&(PSOMDT>DT))!(PSOMC>1&(PSOMDT<1)) Q 0
"RTN","PSXMISC1",122,0)
 Q 1
"RTN","PSXMISC1",123,0)
ADDROK(TRX) ; return 1 if not foreign and not bad address indicator 
"RTN","PSXMISC1",124,0)
 N DFN,PSOFORGN
"RTN","PSXMISC1",125,0)
 S DFN=$P($G(^PSRX(TRX,0)),"^",2) I DFN="" Q:0
"RTN","PSXMISC1",126,0)
 I $D(^TMP($J,"PSXBAI",DFN)) Q:+(^TMP($J,"PSXBAI",DFN))
"RTN","PSXMISC1",127,0)
 D ADD^VADPT
"RTN","PSXMISC1",128,0)
 S PSOFORGN=$P($G(VAPA(25)),"^",2) I PSOFORGN'="",PSOFORGN'["UNITED STATES" S PSOFORGN=1
"RTN","PSXMISC1",129,0)
 I PSOFORGN S ^TMP($J,"PSXBAI",DFN)=0 Q 0
"RTN","PSXMISC1",130,0)
 I $T(CHKRX^PSOBAI)']"" S ^TMP($J,"PSXBAI",DFN)=1 Q 1
"RTN","PSXMISC1",131,0)
 N PSORX,PSOBADR
"RTN","PSXMISC1",132,0)
 S PSORX=TRX
"RTN","PSXMISC1",133,0)
 S PSOBADR=$$CHKRX^PSOBAI(PSORX)
"RTN","PSXMISC1",134,0)
 I '$P(PSOBADR,"^") S ^TMP($J,"PSXBAI",DFN)=1 Q 1
"RTN","PSXMISC1",135,0)
 I $P(PSOBADR,"^",2)=1 S ^TMP($J,"PSXBAI",DFN)=1 Q 1
"RTN","PSXMISC1",136,0)
 S ^TMP($J,"PSXBAI",DFN)=0
"RTN","PSXMISC1",137,0)
 Q 0
"RTN","PSXMISC1",138,0)
 ;
"RTN","PSXMISC1",139,0)
CHKACT(RXN) ; SEE IF FILL IS ALREADY ON ACTIVITY LOG FOR FOREIGN OR BAD ADDRESS
"RTN","PSXMISC1",140,0)
 N JJ,RFCNT,XX,COM
"RTN","PSXMISC1",141,0)
 S PSXFIRST=1
"RTN","PSXMISC1",142,0)
 S COM="Bad Address Indicator or Foreign Address."
"RTN","PSXMISC1",143,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(RXN,1,RF)) Q:'RF  S RFCNT=$S(RF<6:RF,1:RF+1)
"RTN","PSXMISC1",144,0)
 S JJ=0 F  S JJ=$O(^PSRX(RXN,"A",JJ)) Q:'JJ  S XX=$G(^PSRX(RXN,"A",JJ,0)) I $P(XX,"^",4)=RFCNT,$P(XX,"^",5)[COM S PSXFIRST=0 Q
"RTN","PSXMISC1",145,0)
 Q
"RTN","PSXRPPL")
0^2^B64176259^B61160775
"RTN","PSXRPPL",1,0)
PSXRPPL ;BIR/WPB,BAB-Gathers data for the CMOP Transmission ;13 Mar 2002  10:31 AM
"RTN","PSXRPPL",2,0)
 ;;2.0;CMOP;**3,23,33,28,40,42,41,48,62,58**;11 Apr 97;Build 2
"RTN","PSXRPPL",3,0)
 ;Reference to ^PS(52.5,  supported by DBIA #1978
"RTN","PSXRPPL",4,0)
 ;Reference to ^PSRX(     supported by DBIA #1977
"RTN","PSXRPPL",5,0)
 ;Reference to ^PSOHLSN1  supported by DBIA #2385
"RTN","PSXRPPL",6,0)
 ;Reference to ^PSORXL    supported by DBIA #1969
"RTN","PSXRPPL",7,0)
 ;Reference to ^PSOLSET   supported by DBIA #1973
"RTN","PSXRPPL",8,0)
 ;Reference to %ZIS(1     supported by DBIA #290
"RTN","PSXRPPL",9,0)
 ;Reference to %ZIS(2     supported by DBIA #2247
"RTN","PSXRPPL",10,0)
 ;Reference to ^PSSLOCK   supported by DBIA #2789
"RTN","PSXRPPL",11,0)
 ;Reference to ^XTMP("ORLK-" supported by DBIA #4001
"RTN","PSXRPPL",12,0)
 ;Reference to ^PSOBPSUT supported by DBIA #4701
"RTN","PSXRPPL",13,0)
 ;Reference to ^PSOREJUT supported by DBIA #4706
"RTN","PSXRPPL",14,0)
 ;Reference to ^BPSUTIL supported by DBIA #4410
"RTN","PSXRPPL",15,0)
 ;Called from PSXRSUS -Builds ^PSX(550.2,,15,"C" , and returns to PSXRSUS or PSXRTRAN
"RTN","PSXRPPL",16,0)
 ;
"RTN","PSXRPPL",17,0)
SDT K ^TMP($J,"PSX"),^TMP($J,"PSXDFN"),ZCNT,PSXBAT D:$D(XRTL) T0^%ZOSV
"RTN","PSXRPPL",18,0)
 S PSXTDIV=PSOSITE,PSXTYP=$S(+$G(PSXCS):"C",1:"N")
"RTN","PSXRPPL",19,0)
 ;
"RTN","PSXRPPL",20,0)
 ; - Submitting prescriptions to ECME (Electronic Claims Mgmt Engine) - 3rd pary
"RTN","PSXRPPL",21,0)
 I $$ECMEON^BPSUTIL(PSXTDIV),$$CMOPON^BPSUTIL(PSXTDIV) D
"RTN","PSXRPPL",22,0)
 . N BPSCNT S BPSCNT=$$SBTECME^PSXRPPL1(PSXTYP,PSXTDIV,PRTDT,PSXDTRG)
"RTN","PSXRPPL",23,0)
 . ; - Wait 15 seconds per prescription sent to ECME (max of 2 hours)
"RTN","PSXRPPL",24,0)
 . I BPSCNT>0 H 60+$S((BPSCNT*15)>7200:7200,1:(BPSCNT*15))
"RTN","PSXRPPL",25,0)
 ;
"RTN","PSXRPPL",26,0)
 ; - Transmitting prescription to CMOP (up to THROUGH DATE)
"RTN","PSXRPPL",27,0)
 K ^TMP("PSXEPHIN",$J)
"RTN","PSXRPPL",28,0)
 S SDT=0 F  S SDT=$O(^PS(52.5,"CMP","Q",PSXTYP,PSXTDIV,SDT)) S XDFN=0 Q:(SDT>PRTDT)!(SDT'>0)  D
"RTN","PSXRPPL",29,0)
 . F  S XDFN=$O(^PS(52.5,"CMP","Q",PSXTYP,PSXTDIV,SDT,XDFN)) S REC=0 Q:(XDFN'>0)!(XDFN="")  D
"RTN","PSXRPPL",30,0)
 . . F  S REC=$O(^PS(52.5,"CMP","Q",PSXTYP,PSXTDIV,SDT,XDFN,REC)) Q:(REC'>0)!(REC="")  D
"RTN","PSXRPPL",31,0)
 . . . D GETDATA D:$G(RXN) PSOUL^PSSLOCK(RXN),OERRLOCK(RXN)
"RTN","PSXRPPL",32,0)
 ;
"RTN","PSXRPPL",33,0)
 ; - Pulling prescriptions ahead (parameter in OUTPATIENT SITE file #59)
"RTN","PSXRPPL",34,0)
 I $G(PSXBAT),'$G(PSXRTRAN) D CHKDFN
"RTN","PSXRPPL",35,0)
 ;
"RTN","PSXRPPL",36,0)
 ; - Sends a Mailman message if there were transmission problems with the 3rd Party Payer
"RTN","PSXRPPL",37,0)
 I $D(^TMP("PSXEPHIN",$J)) D ^PSXBPSMS K ^TMP("PSXEPHIN",$J)
"RTN","PSXRPPL",38,0)
 ;
"RTN","PSXRPPL",39,0)
EXIT ;   
"RTN","PSXRPPL",40,0)
 K SDT,DFN,REC,RXNUM,PSXOK,FILNUM,REF,PNAME,CNAME,DIE,DR,NDFN,%,CNT,COM,DTTM,FILL,JJ,PRTDT,PSXDIV,XDFN,NFLAG,CIND,XDFN
"RTN","PSXRPPL",41,0)
 K CHKDT,DAYS,DRUG,DRUGCHK,NM,OPDT,PHARCLK,PHY,PSTAT,PTRA,PTRB,QTY,REL,RXERR,RXF,SFN,PSXDGST,PSXMC,PSXMDT
"RTN","PSXRPPL",42,0)
 S:$D(XRT0) XRTN=$T(+0) D:$D(XRT0) T1^%ZOSV
"RTN","PSXRPPL",43,0)
 K ^TMP("PSXEPHIN",$J)
"RTN","PSXRPPL",44,0)
 Q
"RTN","PSXRPPL",45,0)
GETDATA ;Screens rxs and builds data
"RTN","PSXRPPL",46,0)
 ;PSXOK=1:NOT CMOP DRUG OR DO NOT MAIL,2:TRADENAME,3:WINDOW,4:PRINTED,5:NOT SUSPENDED
"RTN","PSXRPPL",47,0)
 ;PSXOK=6:ALREADY RELEASED,7:DIFFERENT DIVISION,8:BAD DATA IN 52.5
"RTN","PSXRPPL",48,0)
 ;9:CS Mismatch,10:DEA 1 or 2
"RTN","PSXRPPL",49,0)
 I '$D(^PS(52.5,REC,0)) K ^PS(52.5,"AQ",SDT,XDFN,REC),^PS(52.5,"CMP","Q",PSXTYP,PSXTDIV,SDT,XDFN,REC) Q
"RTN","PSXRPPL",50,0)
 I $P(^PS(52.5,REC,0),"^",7)="" K ^PS(52.5,"AQ",SDT,XDFN,REC),^PS(52.5,"CMP","Q",PSXTYP,PSXTDIV,SDT,XDFN,REC) Q
"RTN","PSXRPPL",51,0)
 I ($P(^PS(52.5,REC,0),"^",3)'=XDFN) K ^PS(52.5,"AQ",SDT,XDFN,REC),^PS(52.5,"CMP","Q",PSXTYP,PSXTDIV,SDT,XDFN,REC) Q
"RTN","PSXRPPL",52,0)
 N DFN S DFN=XDFN D DEM^VADPT
"RTN","PSXRPPL",53,0)
 I $G(VADM(6))'="" D DELETE K VADM Q
"RTN","PSXRPPL",54,0)
 S PSXOK=0,NFLAG=0
"RTN","PSXRPPL",55,0)
 S RXN=$P($G(^PS(52.5,REC,0)),"^",1) I RXN="" S PSXOK=8 Q
"RTN","PSXRPPL",56,0)
 S RFL=+$$GET1^DIQ(52.5,REC,9,"I")
"RTN","PSXRPPL",57,0)
 I '$D(^TMP($J,"PSXBAI",DFN)) D
"RTN","PSXRPPL",58,0)
 .S PSXGOOD=$$ADDROK^PSXMISC1(RXN)
"RTN","PSXRPPL",59,0)
 .I 'PSXGOOD S PSXFIRST=1 D  I 'PSXFIRST S PSXOK=8
"RTN","PSXRPPL",60,0)
 ..D CHKACT^PSXMISC1(RXN)
"RTN","PSXRPPL",61,0)
 I PSXOK=8 K RXN Q
"RTN","PSXRPPL",62,0)
 ;
"RTN","PSXRPPL",63,0)
 N EPHQT S EPHQT=0
"RTN","PSXRPPL",64,0)
 I $$PATCH^XPDUTL("PSO*7.0*148") D  I EPHQT Q
"RTN","PSXRPPL",65,0)
 . I $$DOUBLE^PSXRPPL1(RXN,RFL) S EPHQT=1 Q
"RTN","PSXRPPL",66,0)
 . I $$RETRX^PSOBPSUT(RXN,RFL),SDT>DT S EPHQT=1 Q
"RTN","PSXRPPL",67,0)
 . I $$FIND^PSOREJUT(RXN,RFL) S EPHQT=1 Q
"RTN","PSXRPPL",68,0)
 . I $$STATUS^PSOBPSUT(RXN,RFL)="IN PROGRESS" D  Q
"RTN","PSXRPPL",69,0)
 . . S ^TMP("PSXEPHIN",$J,$$RXSITE^PSOBPSUT(RXN),RXN)=RFL,EPHQT=1
"RTN","PSXRPPL",70,0)
 ;
"RTN","PSXRPPL",71,0)
 D CHKDATA^PSXMISC1
"RTN","PSXRPPL",72,0)
SET Q:(PSXOK=7)!(PSXOK=8)!(PSXOK=9)
"RTN","PSXRPPL",73,0)
 S PNAME=$G(VADM(1))
"RTN","PSXRPPL",74,0)
 I ($G(PSXCSRX)=1)&($G(PSXCS)=1) S ^XTMP("PSXCS",PSOSITE,DT,RXN)=""
"RTN","PSXRPPL",75,0)
 I (PSXOK=0)&(PSXFLAG=1) S ^TMP($J,"PSXDFN",XDFN)="",NFLAG=4 D DQUE,RX550215 Q
"RTN","PSXRPPL",76,0)
 I (PSXOK=0)&(PSXFLAG=2) D RX550215 Q
"RTN","PSXRPPL",77,0)
 I (PSXOK>0)&(PSXOK<7)!(PSXOK=10) D DELETE Q
"RTN","PSXRPPL",78,0)
 Q
"RTN","PSXRPPL",79,0)
DELETE ; deletes the CMOP STATUS field in PS(52.5, reindex 'AC' x-ref
"RTN","PSXRPPL",80,0)
 L +^PS(52.5,REC):600 Q:'$T
"RTN","PSXRPPL",81,0)
 N DR,DIE,DA S DIE="^PS(52.5,",DA=REC,DR="3///@" D ^DIE
"RTN","PSXRPPL",82,0)
 S ^PS(52.5,"AC",$P(^PS(52.5,REC,0),"^",3),$P(^PS(52.5,REC,0),"^",2),REC)=""
"RTN","PSXRPPL",83,0)
 L -^PS(52.5,REC)
"RTN","PSXRPPL",84,0)
 Q
"RTN","PSXRPPL",85,0)
 ;the rest of the sub-routines go through the ^PSX(550.2,,15,"C"
"RTN","PSXRPPL",86,0)
 ;global and checks for RXs within the days ahead range and
"RTN","PSXRPPL",87,0)
 ;builds the ^PSX(550.2,PSXBAT,
"RTN","PSXRPPL",88,0)
CHKDFN ; use the patient 'C' index under RX multiple in file 550.2 to GET dfn to gather Patients' future RXs
"RTN","PSXRPPL",89,0)
 I '$D(^PSX(550.2,PSXBAT,15,"C")) Q
"RTN","PSXRPPL",90,0)
 S PSXPTNM="" F  S PSXPTNM=$O(^PSX(550.2,PSXBAT,15,"C",PSXPTNM)) Q:PSXPTNM=""  D
"RTN","PSXRPPL",91,0)
 . S XDFN=0 F  S XDFN=$O(^PSX(550.2,PSXBAT,"15","C",PSXPTNM,XDFN)) Q:(XDFN'>0)  D
"RTN","PSXRPPL",92,0)
 . . S SDT=PRTDT F  S SDT=$O(^PS(52.5,"CMP","Q",PSXTYP,PSXTDIV,SDT)),NDFN=0 Q:(SDT>PSXDTRG)!(SDT="")  D
"RTN","PSXRPPL",93,0)
 . . . F  S NDFN=$O(^PS(52.5,"CMP","Q",PSXTYP,PSXTDIV,SDT,NDFN)),REC=0 Q:NDFN'>0  I NDFN=XDFN D
"RTN","PSXRPPL",94,0)
 . . . . F  S REC=$O(^PS(52.5,"CMP","Q",PSXTYP,PSXTDIV,SDT,NDFN,REC)) Q:REC'>0  D
"RTN","PSXRPPL",95,0)
 . . . . . D GETDATA D:$G(RXN) PSOUL^PSSLOCK(RXN),OERRLOCK(RXN)
"RTN","PSXRPPL",96,0)
 Q
"RTN","PSXRPPL",97,0)
BEGIN ; Select print device
"RTN","PSXRPPL",98,0)
 I '$D(PSOPAR) D ^PSOLSET
"RTN","PSXRPPL",99,0)
 I $D(PSOLAP),($G(PSOLAP)'=ION) S PSLION=PSOLAP G PROFILE
"RTN","PSXRPPL",100,0)
 W ! S %ZIS("A")="PRINTER 'LABEL' DEVICE:  ",%ZIS("B")="",%ZIS="MQN" D ^%ZIS S PSLION=ION G:POP EXIT
"RTN","PSXRPPL",101,0)
 I $G(IOST)["C-" W !,"You must select a printer!",! G BEGIN
"RTN","PSXRPPL",102,0)
 F J=0,1 S @("PSOBAR"_J)="" I $D(^%ZIS(2,^%ZIS(1,IOS,"SUBTYPE"),"BAR"_J)) S @("PSOBAR"_J)=^("BAR"_J)
"RTN","PSXRPPL",103,0)
 S PSOBARS=PSOBAR1]""&(PSOBAR0]"")&$P(PSOPAR,"^",19)
"RTN","PSXRPPL",104,0)
 K PSOION,J D ^%ZISC I $D(IO("Q")) K IO("Q")
"RTN","PSXRPPL",105,0)
PROFILE I $D(PSOPROP),($G(PSOPROP)'=ION) Q
"RTN","PSXRPPL",106,0)
 I $P(PSOPAR,"^",8) S %ZIS="MNQ",%ZIS("A")="Select PROFILE PRINTER: " D ^%ZIS K %ZIS,IO("Q"),IOP G:POP EXIT S PSOPROP=ION D ^%ZISC
"RTN","PSXRPPL",107,0)
 I $G(PSOPROP)=ION W !,"You must select a printer!",! G PROFILE
"RTN","PSXRPPL",108,0)
 Q
"RTN","PSXRPPL",109,0)
PRT ; w auto error trapping
"RTN","PSXRPPL",110,0)
 D NOW^%DTC S DTTM=% K %
"RTN","PSXRPPL",111,0)
 S NM="" F  S NM=$O(^PSX(550.2,PSXBAT,15,"C",NM)) Q:NM=""  D DFN,PPL ;gather patient RXs, print patient RXs
"RTN","PSXRPPL",112,0)
 S DIK="^PSX(550.2,",DA=PSXBAT D ^DIK K PSXBAT
"RTN","PSXRPPL",113,0)
 K CHKDT,CIND,DAYS,DRUG,DRUGCHK,NFLAG,NM,ORD,PDT,PHARCLK,PHY,PSTAT,PTRA,PTRB,QTY,REL,RXERR,RXF,SFN,SIG,SITE,SUS,SUSPT
"RTN","PSXRPPL",114,0)
 Q
"RTN","PSXRPPL",115,0)
DFN S DFN=0,NFLAG=2
"RTN","PSXRPPL",116,0)
 F  S DFN=$O(^PSX(550.2,PSXBAT,15,"C",NM,DFN)),RXN=0 Q:(DFN="")!(DFN'>0)  D
"RTN","PSXRPPL",117,0)
 .F  S RXN=$O(^PSX(550.2,PSXBAT,15,"C",NM,DFN,RXN)),RXF="" Q:(RXN="")!(RXN'>0)  D
"RTN","PSXRPPL",118,0)
 ..F  S RXF=$O(^PSX(550.2,PSXBAT,15,"C",NM,DFN,RXN,RXF)) Q:RXF=""  D BLD
"RTN","PSXRPPL",119,0)
 Q
"RTN","PSXRPPL",120,0)
BLD ;
"RTN","PSXRPPL",121,0)
 S BATRXDA=$O(^PSX(550.2,PSXBAT,15,"B",RXN,0)) D NOW^%DTC S DTTM=%
"RTN","PSXRPPL",122,0)
 S REC=$P(^PSX(550.2,PSXBAT,15,BATRXDA,0),U,5),SUS=$O(^PS(52.5,"B",RXN,0))
"RTN","PSXRPPL",123,0)
 I SUS=REC,+SUS'=0 I 1 ;rx still valid in suspense
"RTN","PSXRPPL",124,0)
 E  D  Q  ;rx gone
"RTN","PSXRPPL",125,0)
 . N DA,DIK S DIK=550.2,DA(1)=PSXBAT,DA=BATRXDA
"RTN","PSXRPPL",126,0)
 . D ^DIK
"RTN","PSXRPPL",127,0)
 S PSOSU(DFN,SUS)=RXN,RXCNTR=$G(RXCNTR)+1,NFLAG=2
"RTN","PSXRPPL",128,0)
 S $P(^PSRX(RXN,0),U,15)=0,$P(^PSRX(RXN,"STA"),U,1)=0
"RTN","PSXRPPL",129,0)
 K % S COM="CMOP Suspense Label "_$S($G(^PS(52.5,SUS,"P"))=0:"Printed",$G(^PS(52.5,SUS,"P"))="":"Printed",1:"Reprinted")_$S($G(^PSRX(RXN,"TYPE"))>0:" (PARTIAL)",1:"")
"RTN","PSXRPPL",130,0)
 D EN^PSOHLSN1(RXN,"SC","ZU",COM)
"RTN","PSXRPPL",131,0)
 S DA=SUS D DQUE K DA
"RTN","PSXRPPL",132,0)
ACTLOG F JJ=0:0 S JJ=$O(^PSRX(RXN,"A",JJ)) Q:'JJ  S CNT=JJ
"RTN","PSXRPPL",133,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(RXN,1,RF)) Q:'RF  S RFCNT=$S(RF<6:RF,1:RF+1)
"RTN","PSXRPPL",134,0)
 S CNT=CNT+1,^PSRX(RXN,"A",0)="^52.3DA^"_CNT_"^"_CNT
"RTN","PSXRPPL",135,0)
LOCK L +^PSRX(RXN):600 G:'$T LOCK
"RTN","PSXRPPL",136,0)
 S ^PSRX(RXN,"A",CNT,0)=DTTM_"^S^"_DUZ_"^"_RFCNT_"^"_COM L -^PSRX(RXN)
"RTN","PSXRPPL",137,0)
 K CNT,COM,RFCNT,%,JJ,RF,Y,RXCNTR
"RTN","PSXRPPL",138,0)
 Q
"RTN","PSXRPPL",139,0)
PPL K PPL,PPL1 S ORD="" F  S ORD=$O(PSOSU(ORD)) Q:(ORD="")!(ORD'>0)  D PPL1
"RTN","PSXRPPL",140,0)
 Q
"RTN","PSXRPPL",141,0)
PPL1 ; print patient labels
"RTN","PSXRPPL",142,0)
 F SFN=0:0 S SFN=$O(PSOSU(ORD,SFN)) Q:'SFN  D
"RTN","PSXRPPL",143,0)
 . S:$L($G(PPL))<240 PPL=$P(PSOSU(ORD,SFN),"^")_","_$G(PPL)
"RTN","PSXRPPL",144,0)
 . S:$L($G(PPL))>239 PPL1=$P(PSOSU(ORD,SFN),"^")_","_$G(PPL1)
"RTN","PSXRPPL",145,0)
 . S DFN=$P(^PS(52.5,SFN,0),"^",3)
"RTN","PSXRPPL",146,0)
 S SUSPT=1,PSNP=$S($P(PSOPAR,"^",8):1,1:0) S:$D(PSOPROP) PFIO=PSOPROP
"RTN","PSXRPPL",147,0)
 D QLBL^PSORXL
"RTN","PSXRPPL",148,0)
 I $D(PPL1) S PSNP=0,PPL=PPL1 D QLBL^PSORXL
"RTN","PSXRPPL",149,0)
 K PPL,PPL1,PSOSU(ORD)
"RTN","PSXRPPL",150,0)
 Q
"RTN","PSXRPPL",151,0)
DQUE ; sets the CMOP indicator field, and printed field in 52.5
"RTN","PSXRPPL",152,0)
 L +^PS(52.5,REC):600 G:'$T DQUE
"RTN","PSXRPPL",153,0)
 I NFLAG=4 D
"RTN","PSXRPPL",154,0)
 . S DA=REC,DIE="^PS(52.5,",DR="3////L;4////"_DT D ^DIE K DIE,DA,DR L -^PS(52.5,REC)  ; the rest moved into PSXRTR
"RTN","PSXRPPL",155,0)
 S CIND=$S(NFLAG=1:"X",NFLAG=2:"P",NFLAG=3:"@",1:0)
"RTN","PSXRPPL",156,0)
 I $G(NFLAG)'=2 D
"RTN","PSXRPPL",157,0)
 .S DA=REC,DIE="^PS(52.5,",DR="3////"_CIND_";4////"_DT
"RTN","PSXRPPL",158,0)
 .D ^DIE K DIE,DA,DR
"RTN","PSXRPPL",159,0)
 .S ^PS(52.5,REC,"P")=1,^PS(52.5,"ADL",DT,REC)=""
"RTN","PSXRPPL",160,0)
 I $G(NFLAG)=2 D  ;print label cycle
"RTN","PSXRPPL",161,0)
 . S DA=REC,DIE="^PS(52.5,",DR="3////"_CIND_";4////"_DTTM_";5////"_DUZ_";7////"_RXCNTR
"RTN","PSXRPPL",162,0)
 . D ^DIE K DIE,DA,DR
"RTN","PSXRPPL",163,0)
 . S ^PS(52.5,REC,"P")=1,^PS(52.5,"ADL",$E($P(^PS(52.5,REC,0),"^",8),1,7),REC)=""
"RTN","PSXRPPL",164,0)
 L -^PS(52.5,REC)
"RTN","PSXRPPL",165,0)
 I $G(NFLAG)=2 D EN^PSOHLSN1(RXN,"SC","ZU","CMOP Suspense Label Printed")
"RTN","PSXRPPL",166,0)
 Q
"RTN","PSXRPPL",167,0)
RX550215 ; put RX into RX multiple TRANS 550.215 for PSXBAT
"RTN","PSXRPPL",168,0)
 I '$G(PSXBAT) D BATCH^PSXRSYU ; first time through create batch, & return PSXBAT
"RTN","PSXRPPL",169,0)
 K DD,DO,DIC,DA,DR,D0
"RTN","PSXRPPL",170,0)
 S:'$D(^PSX(550.2,PSXBAT,15,0)) ^PSX(550.2,PSXBAT,15,0)="^550.215P^^"
"RTN","PSXRPPL",171,0)
 S X=RXN,DA(1)=PSXBAT
"RTN","PSXRPPL",172,0)
 S DIC="^PSX(550.2,"_PSXBAT_",15,",DIC("DR")=".02////^S X=RXF;.03////^S X=DFN;.05////^S X=REC",DIC(0)="ZF"
"RTN","PSXRPPL",173,0)
 D FILE^DICN
"RTN","PSXRPPL",174,0)
 S PSXRXTDA=+Y ;RX DA within PSXBAT 'T'ransmission
"RTN","PSXRPPL",175,0)
 K DD,DO,DIC,DA,DR,D0
"RTN","PSXRPPL",176,0)
 Q
"RTN","PSXRPPL",177,0)
OERRLOCK(RXN) ; set XTMP for OERR/CPRS order locking
"RTN","PSXRPPL",178,0)
 I $G(PSXBAT),$G(RXN),$G(PSXRXTDA) I 1
"RTN","PSXRPPL",179,0)
 E  Q
"RTN","PSXRPPL",180,0)
 I $P(^PSX(550.2,PSXBAT,15,PSXRXTDA,0),U,1)'=RXN Q
"RTN","PSXRPPL",181,0)
RXNSET ; set ^XTMP("ORLK-"_ORDER per IA 4001 needs RXN
"RTN","PSXRPPL",182,0)
 Q:'$G(RXN)
"RTN","PSXRPPL",183,0)
 N ORD,NOW,NOW1 S ORD=+$P($G(^PSRX(+$G(RXN),"OR1")),"^",2)
"RTN","PSXRPPL",184,0)
 Q:'ORD
"RTN","PSXRPPL",185,0)
 S NOW=$$NOW^XLFDT,NOW1=$$FMADD^XLFDT(NOW,1)
"RTN","PSXRPPL",186,0)
 S ^XTMP("ORLK-"_+ORD,0)=NOW1_U_NOW_"^CPRS/CMOP RX/Order Lock",^(1)=DUZ_U_$J
"RTN","PSXRPPL",187,0)
 Q
"RTN","PSXRPPL",188,0)
RXNCLEAR ; needs RXN
"RTN","PSXRPPL",189,0)
 Q:'$G(RXN)
"RTN","PSXRPPL",190,0)
 N ORD S ORD=+$P($G(^PSRX(+$G(RXN),"OR1")),"^",2) Q:'ORD
"RTN","PSXRPPL",191,0)
 I $D(^XTMP("ORLK-"_ORD,0)),^(0)["CPRS/CMOP" K ^XTMP("ORLK-"_ORD)
"RTN","PSXRPPL",192,0)
 Q
"RTN","PSXVND")
0^3^B36308347^B36289090
"RTN","PSXVND",1,0)
PSXVND ;BIR/WPB,HTW,PWC-File Release Data at the Remote Facility ;10/29/98  2:13 PM
"RTN","PSXVND",2,0)
 ;;2.0;CMOP;**1,2,4,5,14,18,19,15,24,23,27,35,39,36,48,62,58**;11 Apr 97;Build 2
"RTN","PSXVND",3,0)
 ;Reference to ^PSDRUG( supported by DBIA #1983
"RTN","PSXVND",4,0)
 ;Reference to ^PSRX( supported by DBIA #1977
"RTN","PSXVND",5,0)
 ;Reference to ^PS(59 supported by DBIA #1976
"RTN","PSXVND",6,0)
 ;Reference to routine CP^PSOCP supported by DBIA #1974
"RTN","PSXVND",7,0)
 ;Reference to routine EN^PSOHLSN1 supported by DBIA #2385
"RTN","PSXVND",8,0)
 ;Reference to routine EN^RGEQ supported by DBIA #2382
"RTN","PSXVND",9,0)
 ;Reference to routine AUTOREL^PSOBPSUT supported by DBIA #4701
"RTN","PSXVND",10,0)
 ;Called by Taskman to handle release data
"RTN","PSXVND",11,0)
EN H 5 S CNT=1,FROM=XMFROM,ZTREQ="@"
"RTN","PSXVND",12,0)
 S DOMAIN=$S($P(XMFROM,"@",2)'="":"@"_$P(FROM,"@",2),$P(XMFROM,"@",2)="":"",1:""),XMSER="S."_XQSOP,TXMZ=XQMSG
"RTN","PSXVND",13,0)
 S (X,SITE,DA)=$$KSP^XUPARAM("INST"),DIC="4",DIQ(0)="IE",DR=99,DIQ="PSXUTIL" D EN^DIQ1 S HERE=$G(PSXUTIL(4,SITE,99,"I")) K DA,DIC,DIQ(0),DR
"RTN","PSXVND",14,0)
 F  X XMREC I $G(XMRG)'="" S TXMRG=XMRG G:$G(XMER)<0 EXIT1 D:$E(XMRG,1,3)["$RX" GET G:$E(XMRG,1,5)["$$END" MAIL D:$E(XMRG,1,4)["$LOT" LOT S:$E(XMRG,1,5)["$$VND" MSNUM=$P(XMRG,"^",3)
"RTN","PSXVND",15,0)
 G EXIT
"RTN","PSXVND",16,0)
GET Q:$G(XMRG)=""!($E(XMRG,1,3)'["$RX")
"RTN","PSXVND",17,0)
 K FACBAT,BAT,NDC,RELDT,STAT,REASON,XFILL,P515A,P515B,%,RR,ALOT,RXP,RXN,FLAG,FILL,RELD,ZSTAT,RTN,CARRIER,PKGID,SHPDT
"RTN","PSXVND",18,0)
 S RX=$P(XMRG,U,2),FACBAT=$P(XMRG,U,3),BAT=$P(FACBAT,"-",2),NDC=$P(XMRG,U,4),RELDT=$P(XMRG,U,5),STAT=$P(XMRG,U,6),REASON=$P($G(XMRG),U,8),XFILL=$P($G(XMRG),U,7)
"RTN","PSXVND",19,0)
 S P515A=$P(XMRG,U,9),P515B=$P(XMRG,U,10),DRG=$P(XMRG,U,12),QTY=$P(XMRG,U,11),CARRIER=$P(XMRG,U,13),PKGID=$P(XMRG,U,14),SHPDT=$P(XMRG,U,15)
"RTN","PSXVND",20,0)
 S FAC=$P(FACBAT,"-",1)
"RTN","PSXVND",21,0)
 Q:FAC'=HERE
"RTN","PSXVND",22,0)
 I '$O(^PSRX("B",RX,0)) S FLAG=2 D TMP Q
"RTN","PSXVND",23,0)
 S XX=0 F  S XX=$O(^PSRX("B",RX,XX)) Q:XX'>0  S (RXP,RXN)=XX,FLAG=0 D
"RTN","PSXVND",24,0)
 .I '$G(BAT) Q
"RTN","PSXVND",25,0)
 .I '$D(^PSRX(RXN,0)) S FLAG=2 D TMP Q
"RTN","PSXVND",26,0)
 .L +^PSRX(RXN):DTIME I '$T S FLAG=2 D TMP Q
"RTN","PSXVND",27,0)
 .I XFILL>0,('$D(^PSRX(RXN,1,XFILL,0))) S FLAG=6 D TMP Q
"RTN","PSXVND",28,0)
 .I XFILL>0,($P(^PSRX(RXP,1,XFILL,0),"^",18)'="") S FLAG=1,RLDT=$P(^PSRX(RXP,1,XFILL,0),"^",18) S:STAT=1&(RLDT=RELDT) FLAG=0 D:FLAG=0 TMP1 Q:'$G(FLAG)  D:FLAG=1 TMP Q
"RTN","PSXVND",29,0)
 .I XFILL=0,($P(^PSRX(RXP,2),"^",13)'="") S FLAG=1,RLDT=$P(^PSRX(RXP,2),"^",13) S:STAT=1&(RELDT=RLDT) FLAG=0 D:FLAG=0 TMP1 Q:'$G(FLAG)  D:FLAG=1 TMP Q
"RTN","PSXVND",30,0)
 .I STAT=2 D
"RTN","PSXVND",31,0)
 ..S RXDRG=$P(^PSRX(RXN,0),"^",6),DFN=$P(^PSRX(RXN,0),"^",2)
"RTN","PSXVND",32,0)
 ..I $G(RXDRG)]"" S CMOPNM=$P($G(^PSDRUG(RXDRG,0)),"^")
"RTN","PSXVND",33,0)
 ..I '$D(^PSDRUG("AQ",RXDRG)) S CMOPYN=1
"RTN","PSXVND",34,0)
 ..I $D(^PSDRUG(RXDRG,"ND")) S CMOPID=$P($G(^PSDRUG(RXDRG,"ND")),"^",10)
"RTN","PSXVND",35,0)
 ..S DIV=$S(XFILL=0:$P(^PSRX(RXN,2),U,9),XFILL>0:$P(^PSRX(RXN,1,XFILL,0),U,9),1:"")
"RTN","PSXVND",36,0)
 ..S ^TMP("PSXCAN1",$J,DIV,DFN,RX)=$G(CMOPNM)_U_$G(CMOPID)_U_$G(QTY)_U_$G(DRG)_U_$G(CMOPYN)_U_REASON_U_$G(XFILL)_U_$G(BAT)
"RTN","PSXVND",37,0)
 ..K CMOPNM,CMOPID,DRG,RXDRG,MATCH,CMOPYN,NDF1,NDF2,P1,P2,PSDDA
"RTN","PSXVND",38,0)
 .I '$D(^PSRX(RXN,4,0)) S FLAG=5 D TMP Q
"RTN","PSXVND",39,0)
 .I '$D(^PSRX(RXN,4,"B",BAT)) S FLAG=4 D TMP Q
"RTN","PSXVND",40,0)
 .I $D(^PSRX(RXN,4,"B",BAT)) S RECD=$O(^PSRX(RXN,4,"B",BAT,"")),FILL=$P($G(^PSRX(RXN,4,RECD,0)),U,3),ZSTAT=$P(^PSRX(RXN,4,RECD,0),U,4)
"RTN","PSXVND",41,0)
 .I ZSTAT=2 S RTN=0 F  S RTN=$O(^PSRX(RXN,4,RTN)) Q:RTN'>0  I $P(^PSRX(RXN,4,RTN,0),U,3)=FILL&($P(^PSRX(RXN,4,RTN,0),U,1)'=BAT) S DA(1)=RXN,DA=RTN,DIE="^PSRX("_DA(1)_",4,",DR="3////2;8////FILLED IN TRANSMISSION "_BAT D ^DIE K DA,DR,DIE
"RTN","PSXVND",42,0)
 .I FILL'=XFILL S FLAG=3 D TMP Q
"RTN","PSXVND",43,0)
 .S PSXREF=FILL
"RTN","PSXVND",44,0)
 .Q:FLAG>0
"RTN","PSXVND",45,0)
 .S PSXXMZ=XMZ
"RTN","PSXVND",46,0)
 .D:$G(STAT)=1
"RTN","PSXVND",47,0)
 ..N PSOPAR,PSOSITE,X D NOW^%DTC
"RTN","PSXVND",48,0)
 ..I $G(PSXREF)>0 S PSOSITE=$P(^PSRX(RXP,1,PSXREF,0),"^",9) G:$G(PSOSITE) PAR
"RTN","PSXVND",49,0)
 ..S PSOSITE=$P(^PSRX(RXP,2),"^",9),PSQUIT=0
"RTN","PSXVND",50,0)
 ..I '$G(PSOSITE) S Z1=0 F  S Z1=$O(^PS(59,Z1)) Q:Z1=""!(Z1="B")  D  Q:PSQUIT
"RTN","PSXVND",51,0)
 ...I $D(^PS(59,Z1,"I"))&($P($G(^PS(59,Z1,"I")),"^")'="") Q:$P($G(^PS(59,Z1,"I")),"^")'>X
"RTN","PSXVND",52,0)
 ...S PSOSITE=Z1,PSQUIT=1
"RTN","PSXVND",53,0)
 ..Q:'$G(PSOSITE)
"RTN","PSXVND",54,0)
PAR ..S PSOPAR=$G(^PS(59,PSOSITE,1))
"RTN","PSXVND",55,0)
 ..I $G(PSXREF)>0 S YY=PSXREF
"RTN","PSXVND",56,0)
 ..I '$G(PSOSITE)!('$D(PSOPAR)) Q
"RTN","PSXVND",57,0)
 ..D CP^PSOCP K YY,X
"RTN","PSXVND",58,0)
 .S XMZ=PSXXMZ
"RTN","PSXVND",59,0)
 .I $G(FILL)="" Q
"RTN","PSXVND",60,0)
 .I $G(STAT)=1 D
"RTN","PSXVND",61,0)
 ..I FILL=0 S DA=RXN,DIE="^PSRX(",DR="31///"_RELDT D ^DIE K DIE,DA,DR
"RTN","PSXVND",62,0)
 ..I FILL>0 S DA(1)=RXN,DA=FILL,DIE="^PSRX("_RXN_",1,",DR="17///"_RELDT_";10.1///"_RELDT D ^DIE K DIE,DR,DA
"RTN","PSXVND",63,0)
 ..; I $$VERSION^XPDUTL("OUTPATIENT PHARMACY")<7 S X="RGEQ" X ^%ZOSF("TEST") I  D EN^RGEQ("RX",RXN)  ;CIRN
"RTN","PSXVND",64,0)
 ..I $$VERSION^XPDUTL("OUTPATIENT PHARMACY")>6 D EN^PSOHLSN1(RXN,"ZD")
"RTN","PSXVND",65,0)
 .S DA(1)=RXN,DA=RECD,DIE="^PSRX("_RXN_",4,"
"RTN","PSXVND",66,0)
 .S DR="3////"_$S(STAT=2:3,STAT=1:1,1:"")_";4////"_NDC_";5////"_$S(STAT=2:RELDT,STAT=1:"",1:"")_";8////"_$S(STAT=2:"^S X=$G(REASON)",STAT=1:"",1:"")_";10////"_$G(CARRIER)_";11////"_$G(PKGID)_";9////"_$G(SHPDT)
"RTN","PSXVND",67,0)
 .D ^DIE K DIE,DA,DR
"RTN","PSXVND",68,0)
 .I $$PATCH^XPDUTL("PSO*7.0*148") D AUTOREL^PSOBPSUT(RXN,FILL,RELDT,NDC,"C",$S(STAT=1:"S",1:"U"),60)
"RTN","PSXVND",69,0)
 I $D(^PSRX(RXN)) L -^PSRX(RXN):0
"RTN","PSXVND",70,0)
TMP1 Q:$G(FLAG)'=0!('$G(BAT))
"RTN","PSXVND",71,0)
 D NOW^%DTC S PSXTM=%
"RTN","PSXVND",72,0)
 S ^TMP($J,"PSXREL",CNT)=RX_"^"_PSXTM_"^"_P515A_"^"_P515B_"^"_XFILL_"^"_HERE
"RTN","PSXVND",73,0)
 S CNT=CNT+1
"RTN","PSXVND",74,0)
 Q
"RTN","PSXVND",75,0)
 ;
"RTN","PSXVND",76,0)
LOT S ALOT=$P(XMRG,"|",2)
"RTN","PSXVND",77,0)
 I $G(ALOT)'="" D
"RTN","PSXVND",78,0)
 .K DD,DO
"RTN","PSXVND",79,0)
 .S:'$D(^PSRX(RXN,5,0)) ^PSRX(RXN,5,0)="^52.0401A^^"
"RTN","PSXVND",80,0)
 .F RR=1:1 Q:$P(ALOT,"\",RR)=""  S LOT1=$P(ALOT,"\",RR),LOT=$P(LOT1,"^",1),EXDT=$P(LOT1,"^",2) D
"RTN","PSXVND",81,0)
 ..S DA(1)=RXN,X=LOT,DIC="^PSRX("_RXN_",5,",DIC("DR")="1////"_EXDT_";2////"_XFILL,DIC(0)="Z"
"RTN","PSXVND",82,0)
FF ..D FILE^DICN K DIC("DR"),DIC,DA,LOT,EXDT,DD,DO
"RTN","PSXVND",83,0)
 Q
"RTN","PSXVND",84,0)
TMP S ^TMP($J,"PSXVND",RX)=FLAG_"^"_XFILL_"^"_P515A_"^"_P515B_"^"_HERE_"^"_$S(FLAG=1:RLDT,1:"") Q
"RTN","PSXVND",85,0)
MAIL S XMSUB="CMOP Release Data Acknowledgement",LCNT=1,XMDUZ=.5
"RTN","PSXVND",86,0)
MM D XMZ^XMA2 G:XMZ<1 MM
"RTN","PSXVND",87,0)
 S ^XMB(3.9,XMZ,2,LCNT,0)="$$RTN^"_MSNUM_"^"_HERE,LCNT=LCNT+1
"RTN","PSXVND",88,0)
 F CC=0:0 S CC=$O(^TMP($J,"PSXREL",CC)) Q:CC'>0  D
"RTN","PSXVND",89,0)
 .S ^XMB(3.9,XMZ,2,LCNT,0)="$RX^"_$G(^TMP($J,"PSXREL",CC)),LCNT=LCNT+1
"RTN","PSXVND",90,0)
 S ^XMB(3.9,XMZ,2,LCNT,0)="$$INV"
"RTN","PSXVND",91,0)
 S CC="" F  S CC=$O(^TMP($J,"PSXVND",CC)) Q:CC=""  S RXN=CC D
"RTN","PSXVND",92,0)
 .S LCNT=LCNT+1 D NOW^%DTC S PSXTM=%   ;added for PSX*2*36
"RTN","PSXVND",93,0)
 .S ^XMB(3.9,XMZ,2,LCNT,0)="$RXN"_"^"_RXN_"^"_$G(^TMP($J,"PSXVND",CC))_"^"_PSXTM
"RTN","PSXVND",94,0)
 S ^XMB(3.9,XMZ,2,LCNT+1,0)="$$ENDINV"
"RTN","PSXVND",95,0)
 S ^XMB(3.9,XMZ,2,0)="^3.92A^"_LCNT_U_LCNT_U_DT,XMDUN="CMOP Manager"
"RTN","PSXVND",96,0)
 K XMY S XMY("S.PSXX CMOP SERVER"_DOMAIN)="" D ENT1^XMD
"RTN","PSXVND",97,0)
 ;D ER6^PSXERR Q
"RTN","PSXVND",98,0)
 D:$D(^TMP("PSXCAN1",$J)) CAN^PSXMSGS
"RTN","PSXVND",99,0)
EXIT S XMSER="S.PSXX CMOP SERVER",XMZ=TXMZ D REMSBMSG^XMA1C
"RTN","PSXVND",100,0)
EXIT1 K XMSUB,XMDUZ,XMDUN,XMY,LCNT,XMZ,CC,PSXREL,CNT,Y,X,RR,LOT,LOT1,EXDT,ALOT
"RTN","PSXVND",101,0)
 K RXN,RX,DLAYGO,FACBAT,FILL,FROM,NDC,P514,REASON,RELDT,STAT,XMREC,XMRG
"RTN","PSXVND",102,0)
 K ^TMP($J,"PSXVND"),^TMP($J,"PSXREL"),RLDT,FLAG,TXMRG,PSXXMZ,ZSTAT,PSXTM
"RTN","PSXVND",103,0)
 K XQMSG,XQSOP,XX,ZZZ,%,DAT,DOMAIN,PSXJOB,PSXREF,RECD,RXP,TXMZ,XMZ,XMER
"RTN","PSXVND",104,0)
 K XMFROM,XMSER,BAT,PSXREFL,XFILL,FAC,HERE,P515A,P515B,SITE,MSNUM
"RTN","PSXVND",105,0)
 K DIQ,DIV,QTY,PSXUTIL,SHPDT,Z1,PSQUIT
"RTN","PSXVND",106,0)
 Q
"VER")
8.0^22.0
"BLD",6464,6)
^55
**END**
**END**
