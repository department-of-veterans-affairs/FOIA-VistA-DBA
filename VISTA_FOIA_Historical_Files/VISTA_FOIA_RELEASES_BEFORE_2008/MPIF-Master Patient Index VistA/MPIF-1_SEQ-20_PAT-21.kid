Released MPIF*1*21 SEQ #20
Extracted from mail message
**KIDS**:MPIF*1.0*21^

**INSTALL NAME**
MPIF*1.0*21
"BLD",1478,0)
MPIF*1.0*21^MASTER PATIENT INDEX VISTA^0^3020610^y
"BLD",1478,1,0)
^^3^3^3020425^
"BLD",1478,1,1,0)
Enhancement Project Patch
"BLD",1478,1,2,0)
Refer to patch MPIF*1.0*21 in the FORUM Patch Module for a complete
"BLD",1478,1,3,0)
description.
"BLD",1478,4,0)
^9.64PA^^
"BLD",1478,"INID")
^y
"BLD",1478,"INIT")
MPIF121P
"BLD",1478,"KRN",0)
^9.67PA^8989.52^19
"BLD",1478,"KRN",.4,0)
.4
"BLD",1478,"KRN",.4,"NM",0)
^9.68A^^
"BLD",1478,"KRN",.401,0)
.401
"BLD",1478,"KRN",.402,0)
.402
"BLD",1478,"KRN",.403,0)
.403
"BLD",1478,"KRN",.5,0)
.5
"BLD",1478,"KRN",.84,0)
.84
"BLD",1478,"KRN",3.6,0)
3.6
"BLD",1478,"KRN",3.8,0)
3.8
"BLD",1478,"KRN",9.2,0)
9.2
"BLD",1478,"KRN",9.8,0)
9.8
"BLD",1478,"KRN",9.8,"NM",0)
^9.68A^14^13
"BLD",1478,"KRN",9.8,"NM",1,0)
MPIFSAQ^^0^B82064940
"BLD",1478,"KRN",9.8,"NM",2,0)
MPIFRES^^0^B13432619
"BLD",1478,"KRN",9.8,"NM",3,0)
MPIFQ1^^0^B93899325
"BLD",1478,"KRN",9.8,"NM",4,0)
MPIFQ0^^0^B73563972
"BLD",1478,"KRN",9.8,"NM",5,0)
MPIFVTQ^^0^B37128975
"BLD",1478,"KRN",9.8,"NM",6,0)
MPIFAPI^^0^B73829700
"BLD",1478,"KRN",9.8,"NM",7,0)
MPIFDEL^^0^B21518908
"BLD",1478,"KRN",9.8,"NM",8,0)
MPIFCMRP^^0^B20326076
"BLD",1478,"KRN",9.8,"NM",10,0)
MPIF001^^0^B53473223
"BLD",1478,"KRN",9.8,"NM",11,0)
MPIFMER^^0^B2698614
"BLD",1478,"KRN",9.8,"NM",12,0)
MPIFA31I^^0^B20970139
"BLD",1478,"KRN",9.8,"NM",13,0)
MPIFBT2^^0^B46043248
"BLD",1478,"KRN",9.8,"NM",14,0)
MPIFBT3^^0^B22612886
"BLD",1478,"KRN",9.8,"NM","B","MPIF001",10)

"BLD",1478,"KRN",9.8,"NM","B","MPIFA31I",12)

"BLD",1478,"KRN",9.8,"NM","B","MPIFAPI",6)

"BLD",1478,"KRN",9.8,"NM","B","MPIFBT2",13)

"BLD",1478,"KRN",9.8,"NM","B","MPIFBT3",14)

"BLD",1478,"KRN",9.8,"NM","B","MPIFCMRP",8)

"BLD",1478,"KRN",9.8,"NM","B","MPIFDEL",7)

"BLD",1478,"KRN",9.8,"NM","B","MPIFMER",11)

"BLD",1478,"KRN",9.8,"NM","B","MPIFQ0",4)

"BLD",1478,"KRN",9.8,"NM","B","MPIFQ1",3)

"BLD",1478,"KRN",9.8,"NM","B","MPIFRES",2)

"BLD",1478,"KRN",9.8,"NM","B","MPIFSAQ",1)

"BLD",1478,"KRN",9.8,"NM","B","MPIFVTQ",5)

"BLD",1478,"KRN",19,0)
19
"BLD",1478,"KRN",19.1,0)
19.1
"BLD",1478,"KRN",101,0)
101
"BLD",1478,"KRN",101,"NM",0)
^9.68A^6^6
"BLD",1478,"KRN",101,"NM",1,0)
MPIF REAL-TIME QUERY (MPI PDAT)^^0
"BLD",1478,"KRN",101,"NM",2,0)
MPIF REAL-TIME QUERY (CMOR PDAT)^^0
"BLD",1478,"KRN",101,"NM",3,0)
MPIF REAL-TIME QUERY MENU^^0
"BLD",1478,"KRN",101,"NM",4,0)
MPIF REAL-TIME QUERY (ADD PATIENT)^^0
"BLD",1478,"KRN",101,"NM",5,0)
MPIF REAL-TIME QUERY (SELECT PATIENT)^^0
"BLD",1478,"KRN",101,"NM",6,0)
MPIF REAL-TIME QUERY (HELP)^^0
"BLD",1478,"KRN",101,"NM","B","MPIF REAL-TIME QUERY (ADD PATIENT)",4)

"BLD",1478,"KRN",101,"NM","B","MPIF REAL-TIME QUERY (CMOR PDAT)",2)

"BLD",1478,"KRN",101,"NM","B","MPIF REAL-TIME QUERY (HELP)",6)

"BLD",1478,"KRN",101,"NM","B","MPIF REAL-TIME QUERY (MPI PDAT)",1)

"BLD",1478,"KRN",101,"NM","B","MPIF REAL-TIME QUERY (SELECT PATIENT)",5)

"BLD",1478,"KRN",101,"NM","B","MPIF REAL-TIME QUERY MENU",3)

"BLD",1478,"KRN",409.61,0)
409.61
"BLD",1478,"KRN",771,0)
771
"BLD",1478,"KRN",870,0)
870
"BLD",1478,"KRN",8989.51,0)
8989.51
"BLD",1478,"KRN",8989.52,0)
8989.52
"BLD",1478,"KRN",8994,0)
8994
"BLD",1478,"KRN","B",.4,.4)

"BLD",1478,"KRN","B",.401,.401)

"BLD",1478,"KRN","B",.402,.402)

"BLD",1478,"KRN","B",.403,.403)

"BLD",1478,"KRN","B",.5,.5)

"BLD",1478,"KRN","B",.84,.84)

"BLD",1478,"KRN","B",3.6,3.6)

"BLD",1478,"KRN","B",3.8,3.8)

"BLD",1478,"KRN","B",9.2,9.2)

"BLD",1478,"KRN","B",9.8,9.8)

"BLD",1478,"KRN","B",19,19)

"BLD",1478,"KRN","B",19.1,19.1)

"BLD",1478,"KRN","B",101,101)

"BLD",1478,"KRN","B",409.61,409.61)

"BLD",1478,"KRN","B",771,771)

"BLD",1478,"KRN","B",870,870)

"BLD",1478,"KRN","B",8989.51,8989.51)

"BLD",1478,"KRN","B",8989.52,8989.52)

"BLD",1478,"KRN","B",8994,8994)

"BLD",1478,"QUES",0)
^9.62^^
"BLD",1478,"REQB",0)
^9.611^7^7
"BLD",1478,"REQB",1,0)
RG*1.0*23^1
"BLD",1478,"REQB",2,0)
DG*5.3*440^1
"BLD",1478,"REQB",3,0)
MPIF*1.0*17^1
"BLD",1478,"REQB",4,0)
MPIF*1.0*11^1
"BLD",1478,"REQB",5,0)
MPIF*1.0*18^1
"BLD",1478,"REQB",6,0)
MPIF*1.0*9^1
"BLD",1478,"REQB",7,0)
RG*1.0*25^1
"BLD",1478,"REQB","B","DG*5.3*440",2)

"BLD",1478,"REQB","B","MPIF*1.0*11",4)

"BLD",1478,"REQB","B","MPIF*1.0*17",3)

"BLD",1478,"REQB","B","MPIF*1.0*18",5)

"BLD",1478,"REQB","B","MPIF*1.0*9",6)

"BLD",1478,"REQB","B","RG*1.0*23",1)

"BLD",1478,"REQB","B","RG*1.0*25",7)

"INIT")
MPIF121P
"KRN",101,1199,-1)
0^3
"KRN",101,1199,0)
MPIF REAL-TIME QUERY MENU^actions for real-time query screen^^M^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1199,4)
32^4
"KRN",101,1199,10,0)
^101.01PA^8^8
"KRN",101,1199,10,4,0)
1868^MPI^12^
"KRN",101,1199,10,4,"^")
MPIF REAL-TIME QUERY (MPI PDAT)
"KRN",101,1199,10,5,0)
1867^CMR^22^
"KRN",101,1199,10,5,"^")
MPIF REAL-TIME QUERY (CMOR PDAT)
"KRN",101,1199,10,6,0)
1202^ADD^11^
"KRN",101,1199,10,6,"^")
MPIF REAL-TIME QUERY (ADD PATIENT)
"KRN",101,1199,10,7,0)
1200^SP^21^
"KRN",101,1199,10,7,"^")
MPIF REAL-TIME QUERY (SELECT PATIENT)
"KRN",101,1199,10,8,0)
1205^HLP^13^
"KRN",101,1199,10,8,"^")
MPIF REAL-TIME QUERY (HELP)
"KRN",101,1199,20)

"KRN",101,1199,26)
D SHOW^VALM
"KRN",101,1199,28)
Select Action:
"KRN",101,1199,99)
58938,55189
"KRN",101,1199,770)
^^^^^^^^^^
"KRN",101,1200,-1)
0^5
"KRN",101,1200,0)
MPIF REAL-TIME QUERY (SELECT PATIENT)^Select a Patient from List^^A^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1200,20)
D SELECT^MPIFQ1
"KRN",101,1200,99)
57357,57410
"KRN",101,1200,770)
^^^^^^^^^^
"KRN",101,1202,-1)
0^4
"KRN",101,1202,0)
MPIF REAL-TIME QUERY (ADD PATIENT)^Add Patient to MPI^^A^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1202,20)
D ADD^MPIFQ1
"KRN",101,1202,99)
57357,57410
"KRN",101,1202,770)
^^^^^^^^^^
"KRN",101,1205,-1)
0^6
"KRN",101,1205,0)
MPIF REAL-TIME QUERY (HELP)^HELP^^A^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1205,1,0)
^^1^1^2970912^^^
"KRN",101,1205,1,1,0)
HELP FOR REAL-TIME CIRN QUERY
"KRN",101,1205,20)
D HELP^MPIFQ1
"KRN",101,1205,99)
57357,57410
"KRN",101,1205,770)
^^^^^^^^^^
"KRN",101,1867,-1)
0^2
"KRN",101,1867,0)
MPIF REAL-TIME QUERY (CMOR PDAT)^CMOR's Data View^^A^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1867,1,0)
^101.06^1^1^3011210^^
"KRN",101,1867,1,1,0)
This action will allow the user to request PDAT information from the CMOR.
"KRN",101,1867,4)
^^^CPDAT
"KRN",101,1867,20)
D CMOR^MPIFQ1
"KRN",101,1867,99)
58849,36667
"KRN",101,1868,-1)
0^1
"KRN",101,1868,0)
MPIF REAL-TIME QUERY (MPI PDAT)^MPI Data View^^A^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1868,1,0)
^^1^1^3011210^
"KRN",101,1868,1,1,0)
This action will allow the user to request PDAT information from the MPI.
"KRN",101,1868,4)
^^^MPDAT
"KRN",101,1868,20)
D MPIPD^MPIFQ1
"KRN",101,1868,99)
58849,36667
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
21^3020610^12564
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3020610
"PKG",282,22,1,"PAH",1,1,1,0)
Enhancement Project Patch
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1.0*21 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
14
"RTN","MPIF001")
0^10^B53473223
"RTN","MPIF001",1,0)
MPIF001 ;ALB/RJS/CMC-UTILITY ROUTINE OF APIS ;JUL 12, 1996
"RTN","MPIF001",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,9,16,18,21**;30 Apr 99
"RTN","MPIF001",3,0)
 ;
"RTN","MPIF001",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIF001",5,0)
 ;  ^DPT( - #2070
"RTN","MPIF001",6,0)
 ; ^DPT("AICN" - #2070
"RTN","MPIF001",7,0)
 ; ^DPT("AMPIMIS" - #2070
"RTN","MPIF001",8,0)
 ; EXC^RGHLLOG - #2796
"RTN","MPIF001",9,0)
 ; START^RGHLLOG - #2796
"RTN","MPIF001",10,0)
 ; STOP^RGHLLOG - #2796
"RTN","MPIF001",11,0)
 ; $$SEND2^VAFCUTL1 - #2779
"RTN","MPIF001",12,0)
 ;
"RTN","MPIF001",13,0)
GETICN(DFN) ; This function returns the ICN, including checksum for a given
"RTN","MPIF001",14,0)
 ; DFN or -1^error message
"RTN","MPIF001",15,0)
 ; INPUT: DFN - ien in Patient file
"RTN","MPIF001",16,0)
 ;
"RTN","MPIF001",17,0)
 N RETURN,NODE
"RTN","MPIF001",18,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT1
"RTN","MPIF001",19,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT1
"RTN","MPIF001",20,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT1
"RTN","MPIF001",21,0)
 S NODE=^DPT(DFN,"MPI")
"RTN","MPIF001",22,0)
 I $P(NODE,"^",1)'>0 S RETURN="-1^NO ICN" G EXIT1
"RTN","MPIF001",23,0)
 S RETURN=$P(NODE,"^",1)_"V"_$P(NODE,"^",2)
"RTN","MPIF001",24,0)
 I '$D(^DPT("AICN",$P(NODE,"^"),DFN)) S ^DPT("AICN",$P(NODE,"^"),DFN)=""
"RTN","MPIF001",25,0)
 ; ^ set AICN x-ref if missing one
"RTN","MPIF001",26,0)
EXIT1 ;
"RTN","MPIF001",27,0)
 Q RETURN
"RTN","MPIF001",28,0)
 ;
"RTN","MPIF001",29,0)
GETDFN(ICN) ; Returns DFN (ien Patient file) or -1^error message for a given ICN
"RTN","MPIF001",30,0)
 ; ICN - ICN for a given Patient in the Patient file
"RTN","MPIF001",31,0)
 N RETURN,DFN
"RTN","MPIF001",32,0)
 I $G(ICN)'>0 S RETURN="-1^NO ICN" G EXIT2
"RTN","MPIF001",33,0)
 I '$D(^DPT("AICN",ICN)) S RETURN="-1^ICN NOT IN DATABASE" G EXIT2
"RTN","MPIF001",34,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIF001",35,0)
 I $G(DFN)'>0 S RETURN="-1^BAD ICN CROSS-REFERENCE" G EXIT2
"RTN","MPIF001",36,0)
 S RETURN=DFN
"RTN","MPIF001",37,0)
EXIT2 ;
"RTN","MPIF001",38,0)
 Q RETURN
"RTN","MPIF001",39,0)
 ;
"RTN","MPIF001",40,0)
ICNLC(DFN) ;This API will return an ICN if one exists or create and return
"RTN","MPIF001",41,0)
 ; a Local ICN and update the appropriate fields if a Local was created
"RTN","MPIF001",42,0)
 ; DFN= Patient IEN
"RTN","MPIF001",43,0)
 ; Returns ICN (local or National including checksum) or -1^Problem creating Local ICN or -1^ZZd or 5 leading 0s
"RTN","MPIF001",44,0)
 N ICN,TMP,CHKSUM,ICNX
"RTN","MPIF001",45,0)
 I $G(DFN)'>0 Q "-1^No DFN Passed"
"RTN","MPIF001",46,0)
 D LOCK
"RTN","MPIF001",47,0)
 S ICN=$$GETICN(DFN)
"RTN","MPIF001",48,0)
 I +ICN=-1,(+$$SEND2^VAFCUTL1(DFN,"T")=0),$E($P($G(^DPT(DFN,0)),"^"),1,3)'="EEE" D
"RTN","MPIF001",49,0)
 .;no icn create a Local ICN, don't create Local if ZZ'd or 5 leading 0s
"RTN","MPIF001",50,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIF001",51,0)
 .S CHKSUM=$P(ICN,"V",2),ICNX=$P(ICN,"V")
"RTN","MPIF001",52,0)
 .S NOLOCK=""
"RTN","MPIF001",53,0)
 .I ICNX="" K NOLOCK S ICN="-1^PROBLEM CREATING LOCAL ICN" Q
"RTN","MPIF001",54,0)
 .S TMP=$$SETICN(DFN,ICNX,CHKSUM)
"RTN","MPIF001",55,0)
 .S TMP=$$SETLOC(DFN,1)
"RTN","MPIF001",56,0)
 .S TMP=$$CHANGE(DFN,$P($$SITE^VASITE(),"^"))
"RTN","MPIF001",57,0)
 .K NOLOCK
"RTN","MPIF001",58,0)
 D UNLOCK
"RTN","MPIF001",59,0)
 I +ICN=-1 S ICN="-1^ZZd or 5 leading 0s or EEE patient"
"RTN","MPIF001",60,0)
 Q ICN
"RTN","MPIF001",61,0)
 ;
"RTN","MPIF001",62,0)
CMOR2(DFN) ; Returns CMOR Site Name or -1^error message
"RTN","MPIF001",63,0)
 ; DFN = Patient IEN
"RTN","MPIF001",64,0)
 I $G(DFN)'>0 Q "-1^No DFN Passed"
"RTN","MPIF001",65,0)
 N NODE
"RTN","MPIF001",66,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",67,0)
 Q:$P(NODE,"^",3)="" "-1^No CMOR"
"RTN","MPIF001",68,0)
 Q $$CMORNAME($P(NODE,"^",3))
"RTN","MPIF001",69,0)
 ;
"RTN","MPIF001",70,0)
CMORNAME(CIEN) ; Returns CMOR site name or -1^error message
"RTN","MPIF001",71,0)
 ; CIEN - ien from Institution file
"RTN","MPIF001",72,0)
 ;
"RTN","MPIF001",73,0)
 Q:CIEN="" "-1^No Institution parameter"
"RTN","MPIF001",74,0)
 N INST
"RTN","MPIF001",75,0)
 S INST=$$NNT^XUAF4(CIEN)
"RTN","MPIF001",76,0)
 Q:INST="" "-1^No Institution for that IEN"
"RTN","MPIF001",77,0)
 Q:$P(INST,"^")="" "-1^No Name for this Institution"
"RTN","MPIF001",78,0)
 Q $P(INST,"^")
"RTN","MPIF001",79,0)
 ;
"RTN","MPIF001",80,0)
GETVCCI(DFN) ; Returns CMOR or -1^error message for a given patient
"RTN","MPIF001",81,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",82,0)
 N RETURN,NODE,PTR,STANUM
"RTN","MPIF001",83,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT3
"RTN","MPIF001",84,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT3
"RTN","MPIF001",85,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT3
"RTN","MPIF001",86,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",87,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",88,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT3
"RTN","MPIF001",89,0)
 S STANUM=$P($$NNT^XUAF4(PTR),"^",2)
"RTN","MPIF001",90,0)
 I STANUM'>0 S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT3
"RTN","MPIF001",91,0)
 S RETURN=STANUM
"RTN","MPIF001",92,0)
EXIT3 ;
"RTN","MPIF001",93,0)
 Q RETURN
"RTN","MPIF001",94,0)
 ;
"RTN","MPIF001",95,0)
CHANGE(DFN,VCCI) ;
"RTN","MPIF001",96,0)
 ; ** This function is only to be used by approved packages **
"RTN","MPIF001",97,0)
 ;
"RTN","MPIF001",98,0)
 ; This function updates the CMOR field in the Patient file
"RTN","MPIF001",99,0)
 ; DFN = ien in Patient file
"RTN","MPIF001",100,0)
 ; VCCI = CMOR ien from the institution file
"RTN","MPIF001",101,0)
 ; returned:  -1^error message - problem
"RTN","MPIF001",102,0)
 ;             1 - successful
"RTN","MPIF001",103,0)
 ; Exception will be generated if Update to File Fails only
"RTN","MPIF001",104,0)
 N RETURN,DIQUIET,DIE,DA,DR,Y,X,DIC
"RTN","MPIF001",105,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",106,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT4
"RTN","MPIF001",107,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT4
"RTN","MPIF001",108,0)
 I $G(VCCI)="" S RETURN="-1^NO CMOR PASSED" G EXIT4
"RTN","MPIF001",109,0)
 I $E($$GETICN(DFN),1,3)=$P($$SITE^VASITE(),"^",3) S VCCI=$P($$SITE^VASITE(),"^")
"RTN","MPIF001",110,0)
 ; ^ to be sure site is self for a local icn
"RTN","MPIF001",111,0)
 S VCCI="`"_VCCI
"RTN","MPIF001",112,0)
 ; ^ Have ien stuff added to use ien instead of station number
"RTN","MPIF001",113,0)
 N CNT,TIEN S DIQUIET=1,CNT=0
"RTN","MPIF001",114,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",115,0)
REP S DIE="^DPT(",DA=DFN,DR="991.03///^S X=VCCI"
"RTN","MPIF001",116,0)
 D ^DIE
"RTN","MPIF001",117,0)
 S CNT=CNT+1
"RTN","MPIF001",118,0)
 S TIEN=$P($$MPINODE^MPIFAPI(DFN),"^",3)
"RTN","MPIF001",119,0)
 I "`"_TIEN'=VCCI&(CNT<4) G REP
"RTN","MPIF001",120,0)
 I "`"_TIEN'=VCCI&(CNT>3) D
"RTN","MPIF001",121,0)
 .S RETURN="-1^Couldn't Update CMOR"
"RTN","MPIF001",122,0)
 .D START^RGHLLOG(0)
"RTN","MPIF001",123,0)
 .D EXC^RGHLLOG(221,"Unable to update CMOR to "_$$STA^XUAF4(TIEN)_" for patient DFN= "_DFN,DFN)
"RTN","MPIF001",124,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIF001",125,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",126,0)
EXIT4 ;
"RTN","MPIF001",127,0)
 Q RETURN
"RTN","MPIF001",128,0)
 ;
"RTN","MPIF001",129,0)
SETICN(DFN,ICN,CHKSUM) ;
"RTN","MPIF001",130,0)
 ; ** this function is to only be used by approved packages **
"RTN","MPIF001",131,0)
 ;
"RTN","MPIF001",132,0)
 ; This function updates the ICN and ICN Checksum fields in the Patient 
"RTN","MPIF001",133,0)
 ; file for a given patient.
"RTN","MPIF001",134,0)
 ; DFN - ien in the Patient file to be updated
"RTN","MPIF001",135,0)
 ; ICN - ICN (without checksum) to be updated
"RTN","MPIF001",136,0)
 ; CHKSUM - ICN checksum
"RTN","MPIF001",137,0)
 ; return:  -1^error message - problem
"RTN","MPIF001",138,0)
 ;          1 - successful
"RTN","MPIF001",139,0)
 N RETURN,DIQUIET,DIE,DA,DR,RGRSICN,Y,ERR
"RTN","MPIF001",140,0)
 S (RETURN,DIQUIET,RGRSICN)=1
"RTN","MPIF001",141,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT5
"RTN","MPIF001",142,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT5
"RTN","MPIF001",143,0)
 I $G(ICN)="" S RETURN="-1^NO ICN PASSED" G EXIT5
"RTN","MPIF001",144,0)
 I $G(CHKSUM)="" S RETURN="-1^NO CHKSUM PASSED" G EXIT5
"RTN","MPIF001",145,0)
 I +$$GETICN(DFN)>0 I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3),$E($$GETICN(DFN),1,3)'=$E(ICN,1,3) S RETURN="-1^Don't overwrite national with local" G EXIT5
"RTN","MPIF001",146,0)
 ; ^ stop local from overwriting a national ICN
"RTN","MPIF001",147,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S RETURN="-1^ZZ'd or 5 leading 0s" G EXIT5
"RTN","MPIF001",148,0)
 I $E($P($G(^DPT(DFN,0)),"^"),1,3)="EEE" S RETURN="-1^EEE patient" G EXIT5
"RTN","MPIF001",149,0)
 I $D(^DPT("AICN",ICN)) D
"RTN","MPIF001",150,0)
 .Q:DFN=$O(^DPT("AICN",ICN,""))
"RTN","MPIF001",151,0)
 .N RGLOG D START^RGHLLOG(0)
"RTN","MPIF001",152,0)
 .I DFN'=($O(^DPT("AICN",ICN,""))) D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_ICN_" that is already in use for Patient dfn "_$O(^DPT("AICN",ICN,""))_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIF001",153,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIF001",154,0)
 .S RETURN="-1^ICN ALREADY IN USE"
"RTN","MPIF001",155,0)
 G:+RETURN=-1 EXIT5
"RTN","MPIF001",156,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",157,0)
 S DIQUIET=1
"RTN","MPIF001",158,0)
 S DIE="^DPT(",DA=DFN,DR="991.01///^S X=ICN;991.02///^S X=CHKSUM"
"RTN","MPIF001",159,0)
 D ^DIE
"RTN","MPIF001",160,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",161,0)
 I +RETURN>0 D
"RTN","MPIF001",162,0)
 .K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",163,0)
 .I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,1)
"RTN","MPIF001",164,0)
 .I $E(ICN,1,3)'=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,0)
"RTN","MPIF001",165,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",166,0)
EXIT5 ;
"RTN","MPIF001",167,0)
 Q RETURN
"RTN","MPIF001",168,0)
 ;
"RTN","MPIF001",169,0)
SETLOC(DFN,DELFLAG) ;
"RTN","MPIF001",170,0)
 ; ** This function should be only used by approved packages **
"RTN","MPIF001",171,0)
 ;
"RTN","MPIF001",172,0)
 ; This function updates the LOCALLY ASSIGNED ICN field in the Patient
"RTN","MPIF001",173,0)
 ; for the given patient
"RTN","MPIF001",174,0)
 ;DFN - ien from Patient file of patient to be updated
"RTN","MPIF001",175,0)
 ;DELFLAG - 1 is to turn the flag on
"RTN","MPIF001",176,0)
 ;        - 0 is to turn off the flag
"RTN","MPIF001",177,0)
 ;
"RTN","MPIF001",178,0)
 N RETURN,DIQUIET,DIE,DA,DR,VALUE,Y
"RTN","MPIF001",179,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",180,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT6
"RTN","MPIF001",181,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT6
"RTN","MPIF001",182,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",183,0)
 S DIQUIET=1,VALUE=$S($G(DELFLAG)=0:"@",1:1)
"RTN","MPIF001",184,0)
 S DIE="^DPT(",DA=DFN,DR="991.04///^S X=VALUE"
"RTN","MPIF001",185,0)
 D ^DIE
"RTN","MPIF001",186,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",187,0)
 I +RETURN>0 K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",188,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",189,0)
EXIT6 ;
"RTN","MPIF001",190,0)
 Q RETURN
"RTN","MPIF001",191,0)
 ;
"RTN","MPIF001",192,0)
IFLOCAL(DFN) ; This function is used to see if a patient has a local ICN
"RTN","MPIF001",193,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",194,0)
 ; returned:  0 = patient does not exist, dfn is not defined or no MPI node OR Patient does not have a local ICN
"RTN","MPIF001",195,0)
 ;            1 = patient has a Local ICN assigned
"RTN","MPIF001",196,0)
 Q:$G(DFN)="" 0
"RTN","MPIF001",197,0)
 Q:$G(^DPT(DFN,0))="" 0
"RTN","MPIF001",198,0)
 Q:'$D(^DPT(DFN,"MPI")) 0
"RTN","MPIF001",199,0)
 Q:$E($$GETICN(DFN),1,3)=$P($$SITE^VASITE,"^",3) 1
"RTN","MPIF001",200,0)
 Q 0
"RTN","MPIF001",201,0)
 ;
"RTN","MPIF001",202,0)
IFVCCI(DFN) ; this function returns 1 if your facility is the CMOR for the given pt
"RTN","MPIF001",203,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",204,0)
 ; returns: 1 = your site in the CMOR for this patient
"RTN","MPIF001",205,0)
 ;          -1 = your site is not the CMOR for this patient
"RTN","MPIF001",206,0)
 ;          0^ERROR MSG
"RTN","MPIF001",207,0)
 N VCCI,SITE
"RTN","MPIF001",208,0)
 I $G(DFN)'>0 Q "0^No DFN Passed"
"RTN","MPIF001",209,0)
 S VCCI=$P($$GETVCCI(DFN),"^",1)
"RTN","MPIF001",210,0)
 S SITE=$P($$SITE^VASITE,"^",3)\1
"RTN","MPIF001",211,0)
 I $P(VCCI,"^",1)=-1 Q -1
"RTN","MPIF001",212,0)
 I VCCI'=SITE Q -1
"RTN","MPIF001",213,0)
 Q 1
"RTN","MPIF001",214,0)
 ;
"RTN","MPIF001",215,0)
HL7CMOR(DFN,SEP) ; This function returns the CMOR station number and institution name for
"RTN","MPIF001",216,0)
 ; the given patient.
"RTN","MPIF001",217,0)
 ; DFN = ien for patient in Patient file
"RTN","MPIF001",218,0)
 ; SEP = delimiter to separate station number and name
"RTN","MPIF001",219,0)
 ; returned:  Station Number <sep> Institution name
"RTN","MPIF001",220,0)
 ;            -1^error message
"RTN","MPIF001",221,0)
 N RETURN,NODE,PTR,STAT
"RTN","MPIF001",222,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT7
"RTN","MPIF001",223,0)
 I $G(SEP)="" S RETURN="-1^NO FIELD SEPERATOR" G EXIT7
"RTN","MPIF001",224,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT7
"RTN","MPIF001",225,0)
 I $$MPINODE^MPIFAPI(DFN)<1 S RETURN="-1^NO MPI NODE" G EXIT7
"RTN","MPIF001",226,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",227,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",228,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT7
"RTN","MPIF001",229,0)
 S STAT=$$NNT^XUAF4(PTR)
"RTN","MPIF001",230,0)
 I STAT="" S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT7
"RTN","MPIF001",231,0)
 I $P(STAT,"^")="" S RETURN="-1^NO INSTITUTION NAME" G EXIT7
"RTN","MPIF001",232,0)
 S RETURN=$P(STAT,"^",2)_SEP_$P(STAT,"^")
"RTN","MPIF001",233,0)
EXIT7 ;
"RTN","MPIF001",234,0)
 Q RETURN
"RTN","MPIF001",235,0)
 ;
"RTN","MPIF001",236,0)
LOCK ;
"RTN","MPIF001",237,0)
 F  L +^DPT(DFN,"MPI"):10 Q:$T
"RTN","MPIF001",238,0)
 Q
"RTN","MPIF001",239,0)
 ;
"RTN","MPIF001",240,0)
UNLOCK ;
"RTN","MPIF001",241,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",242,0)
 Q
"RTN","MPIF121P")
0^^B4709275
"RTN","MPIF121P",1,0)
MPIF121P ;BPCIO/CMC-Post Init for MPIF*1.0*21 ;11/15/00
"RTN","MPIF121P",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**21**;30 Apr 99
"RTN","MPIF121P",3,0)
 ;
"RTN","MPIF121P",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIF121P",5,0)
 ;
"RTN","MPIF121P",6,0)
 ; ^DPT("AICNL", ^DPT("AICN" - #2070
"RTN","MPIF121P",7,0)
 ;
"RTN","MPIF121P",8,0)
 ;This Post Init will loop through the Patient file "SSN" x-ref
"RTN","MPIF121P",9,0)
 ; looking for patients have have 5 leading zeros for the SSN
"RTN","MPIF121P",10,0)
 ; to inactivate these patients from the MPI, including retiring
"RTN","MPIF121P",11,0)
 ; Local ICNs
"RTN","MPIF121P",12,0)
 ;
"RTN","MPIF121P",13,0)
 ; It will also inactivate patients with a last name of EEE, including
"RTN","MPIF121P",14,0)
 ; retiring Local ICNs.
"RTN","MPIF121P",15,0)
 ;
"RTN","MPIF121P",16,0)
 ; It will also reset all the AICNL x-refs to equal 0, to allow them
"RTN","MPIF121P",17,0)
 ; all to be resent to the MPI for resolution.
"RTN","MPIF121P",18,0)
POST ;
"RTN","MPIF121P",19,0)
 D BMES^XPDUTL("Resettting 'AICNL' cross reference")
"RTN","MPIF121P",20,0)
 N IEN,CNTL
"RTN","MPIF121P",21,0)
 S (IEN,CNTL)=0
"RTN","MPIF121P",22,0)
 F  S IEN=$O(^DPT("AICNL",1,IEN)) Q:IEN=""  D
"RTN","MPIF121P",23,0)
 .S ^DPT("AICNL",1,IEN)=""
"RTN","MPIF121P",24,0)
 .S CNTL=CNTL+1
"RTN","MPIF121P",25,0)
 D BMES^XPDUTL("Reset "_CNTL_" 'AICNL' cross-references")
"RTN","MPIF121P",26,0)
 ;
"RTN","MPIF121P",27,0)
 D BMES^XPDUTL("Inactivating ICNs for Patients with 5 leading zeros for SSN (Local ICN and National)")
"RTN","MPIF121P",28,0)
 D BMES^XPDUTL("Please be patient this may take some time")
"RTN","MPIF121P",29,0)
 Q:'$D(^DPT("AICN"))
"RTN","MPIF121P",30,0)
 ; ^ NO ICNs
"RTN","MPIF121P",31,0)
 N SSN,CNT,DFN
"RTN","MPIF121P",32,0)
 S SSN="00000",CNT=0
"RTN","MPIF121P",33,0)
 F  S SSN=$O(^DPT("SSN",SSN)) Q:SSN'?5"0".E  D
"RTN","MPIF121P",34,0)
 .Q:SSN["P"  ; psuedo ssn
"RTN","MPIF121P",35,0)
 .S DFN=$O(^DPT("SSN",SSN,""))
"RTN","MPIF121P",36,0)
 .Q:DFN<1
"RTN","MPIF121P",37,0)
 .Q:$$GETICN^MPIF001(DFN)<0  ; no ICN
"RTN","MPIF121P",38,0)
 .D SSET^MPIFDEL(DFN,SSN)
"RTN","MPIF121P",39,0)
 .S CNT=CNT+1
"RTN","MPIF121P",40,0)
 D BMES^XPDUTL("Inactivated "_CNT_" Patients with 5 leading zeros for the SSN")
"RTN","MPIF121P",41,0)
 ;
"RTN","MPIF121P",42,0)
 S CNT=0
"RTN","MPIF121P",43,0)
 D BMES^XPDUTL("Inactivating EEE Patients (Local ICN and National)")
"RTN","MPIF121P",44,0)
 D BMES^XPDUTL("Please be patient this may take some time")
"RTN","MPIF121P",45,0)
 N NAME
"RTN","MPIF121P",46,0)
 Q:'$D(^DPT("AICN"))
"RTN","MPIF121P",47,0)
 ; ^ NO ICNs
"RTN","MPIF121P",48,0)
 S NAME="EED"
"RTN","MPIF121P",49,0)
 F  S NAME=$O(^DPT("B",NAME)) Q:$E(NAME,1,3)'="EEE"  D
"RTN","MPIF121P",50,0)
 .S DFN=$O(^DPT("B",NAME,""))
"RTN","MPIF121P",51,0)
 .D ZZKILL^MPIFDEL(DFN,NAME)
"RTN","MPIF121P",52,0)
 .S CNT=CNT+1
"RTN","MPIF121P",53,0)
 D BMES^XPDUTL("Processed "_CNT_" EEE Patients")
"RTN","MPIF121P",54,0)
 Q
"RTN","MPIFA31I")
0^12^B20970139
"RTN","MPIFA31I",1,0)
MPIFA31I ;ALB/JRP-PROCESS ADT-A31 MESSAGE FROM MPI ;03-JAN-97
"RTN","MPIFA31I",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,21**;30 Apr 99
"RTN","MPIFA31I",3,0)
 ;
"RTN","MPIFA31I",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA31I",5,0)
 ;  ^DGCN(391.91 - #2751
"RTN","MPIFA31I",6,0)
 ;  ^DPT("AICNL" - #2070
"RTN","MPIFA31I",7,0)
 ;  EXC^RGHLLOG - #2796
"RTN","MPIFA31I",8,0)
 ;
"RTN","MPIFA31I",9,0)
PROCESS(MSGARR) ;Process ADT-A31 message received from MPI when a new
"RTN","MPIFA31I",10,0)
 ; patient is assigned an Integration Control Number
"RTN","MPIFA31I",11,0)
 ;
"RTN","MPIFA31I",12,0)
 ;Input  : MSGARR - Array containing ADT-A31 message (full global ref)
"RTN","MPIFA31I",13,0)
 ;                - MSGARR must be in format compatible with interaction
"RTN","MPIFA31I",14,0)
 ;                  with DHCP HL7 package
"RTN","MPIFA31I",15,0)
 ;                    MSGARR(1) = First segment of message
"RTN","MPIFA31I",16,0)
 ;                    MSGARR(1,n) = Continuation node(s) for segment
"RTN","MPIFA31I",17,0)
 ;                    MSGARR(x) = Xth segment of message
"RTN","MPIFA31I",18,0)
 ;                    MSGARR(x,n) = Continuation node(s) for segment
"RTN","MPIFA31I",19,0)
 ;                - Defaults to ^TMP("MPIFA31",$J,"MPI-ADT-A31")
"RTN","MPIFA31I",20,0)
 ;Output : ICN = Successfully processed
"RTN","MPIFA31I",21,0)
 ;        -1^Reason = Failure
"RTN","MPIFA31I",22,0)
 ;Notes  : The MPI uses an ADT-A31 message to return the ICN of new
"RTN","MPIFA31I",23,0)
 ;         patients.  This value (seq # 2 of PID segment) is the only
"RTN","MPIFA31I",24,0)
 ;         information that will be stored.
"RTN","MPIFA31I",25,0)
 ;
"RTN","MPIFA31I",26,0)
 ;Check input
"RTN","MPIFA31I",27,0)
 S MSGARR=$G(MSGARR)
"RTN","MPIFA31I",28,0)
 S:(MSGARR="") MSGARR="^TMP(""MPIFA31"","_$J_",""MPI-ADT-A31"")"
"RTN","MPIFA31I",29,0)
 Q:(('$D(@MSGARR))!('$O(@MSGARR@(0)))) "-1^Array containing ADT-A31 message not valid"
"RTN","MPIFA31I",30,0)
 ;Declare variables
"RTN","MPIFA31I",31,0)
 N MSH,EVN,PID,SEND,RECEIVE,EVENT,REASON,SEGMENT,SEGNAME
"RTN","MPIFA31I",32,0)
 N ICN,ICNNUM,ICNCHECK,DFNCHECK,CHKSCHM,SSN,LOCAL,TMP,FLDSEP,HLECH
"RTN","MPIFA31I",33,0)
 N CMPSEP,REPSEP,ESC,SUBSEP,TMP1,TMP2
"RTN","MPIFA31I",34,0)
 ;Parse required segments out of message
"RTN","MPIFA31I",35,0)
 S (MSH,EVN,PID)=""
"RTN","MPIFA31I",36,0)
 S TMP=0
"RTN","MPIFA31I",37,0)
 F  S TMP=+$O(@MSGARR@(TMP)) Q:('TMP)  D
"RTN","MPIFA31I",38,0)
 .;Get segment and screen out unused segments
"RTN","MPIFA31I",39,0)
 .S SEGMENT=$G(@MSGARR@(TMP))
"RTN","MPIFA31I",40,0)
 .S SEGNAME=$E(SEGMENT,1,3)
"RTN","MPIFA31I",41,0)
 .S TMP1=","_SEGNAME_","
"RTN","MPIFA31I",42,0)
 .Q:('(",MSH,EVN,PID,"[TMP1))
"RTN","MPIFA31I",43,0)
 .;Use first occurrance of segment
"RTN","MPIFA31I",44,0)
 .Q:(@SEGNAME'="")
"RTN","MPIFA31I",45,0)
 .;Remember field separator if MSH segment
"RTN","MPIFA31I",46,0)
 .S:(SEGNAME="MSH") FLDSEP=$E(SEGMENT,4)
"RTN","MPIFA31I",47,0)
 .;Drop segment name and field separator for storage
"RTN","MPIFA31I",48,0)
 .S @SEGNAME=$E(SEGMENT,5,$L(SEGMENT))
"RTN","MPIFA31I",49,0)
 .;Account for rollover (begin rollover subscripting with 1)
"RTN","MPIFA31I",50,0)
 .S TMP1=0
"RTN","MPIFA31I",51,0)
 .S TMP2=1
"RTN","MPIFA31I",52,0)
 .F  S TMP1=+$O(@MSGARR@(TMP,TMP1)) Q:('TMP1)  D
"RTN","MPIFA31I",53,0)
 ..;Get/save rollover
"RTN","MPIFA31I",54,0)
 ..S @SEGNAME@(TMP2)=$G(@MSGARR@(TMP,TMP1))
"RTN","MPIFA31I",55,0)
 ..S TMP2=TMP2+1
"RTN","MPIFA31I",56,0)
 ;Make sure used segments were all found
"RTN","MPIFA31I",57,0)
 F SEGNAME="MSH","EVN","PID" Q:(@SEGNAME="")
"RTN","MPIFA31I",58,0)
 Q:(@SEGNAME="") "-1^Required segment ("_SEGNAME_") missing"
"RTN","MPIFA31I",59,0)
 ;Safety check on field separator (use DHCP default value)
"RTN","MPIFA31I",60,0)
 S:($G(FLDSEP)="") FLDSEP="^"
"RTN","MPIFA31I",61,0)
 ;Get encoding characters
"RTN","MPIFA31I",62,0)
 S HLECH=$P(MSH,FLDSEP,1)
"RTN","MPIFA31I",63,0)
 ;Component separator
"RTN","MPIFA31I",64,0)
 S CMPSEP=$E(HLECH,1)
"RTN","MPIFA31I",65,0)
 ;Repetion separator
"RTN","MPIFA31I",66,0)
 S REPSEP=$E(HLECH,2)
"RTN","MPIFA31I",67,0)
 ;Escape character
"RTN","MPIFA31I",68,0)
 S ESC=$E(HLECH,3)
"RTN","MPIFA31I",69,0)
 ;Subcomponent separator
"RTN","MPIFA31I",70,0)
 S SUBSEP=$E(HLECH,4)
"RTN","MPIFA31I",71,0)
 ;Process MSH segment
"RTN","MPIFA31I",72,0)
 ; - Get sending facility
"RTN","MPIFA31I",73,0)
 S SEND=$P(MSH,FLDSEP,3)
"RTN","MPIFA31I",74,0)
 ; - Get receiving facility
"RTN","MPIFA31I",75,0)
 S RECEIVE=$P(MSH,FLDSEP,5)
"RTN","MPIFA31I",76,0)
 ; - Get event type
"RTN","MPIFA31I",77,0)
 S EVENT=$P($P(MSH,FLDSEP,8),CMPSEP,2)
"RTN","MPIFA31I",78,0)
 ; - Validate information in MSH segment
"RTN","MPIFA31I",79,0)
 ;   - MPI is sending facility
"RTN","MPIFA31I",80,0)
 ;Q:(SEND'="200M") "-1^Sending facility not valid (must be '200M')"
"RTN","MPIFA31I",81,0)
 ;   - Receiving facility is local facility
"RTN","MPIFA31I",82,0)
 S TMP=+$P($$SITE^VASITE(),"^",3)
"RTN","MPIFA31I",83,0)
 Q:(RECEIVE'=TMP) "-1^Receiving facility not valid (must be "_TMP_")"
"RTN","MPIFA31I",84,0)
 ;   - Event type is A31
"RTN","MPIFA31I",85,0)
 Q:(EVENT'="A31") "-1^Event type not valid (must be 'A31')"
"RTN","MPIFA31I",86,0)
 ;Process EVN segment
"RTN","MPIFA31I",87,0)
 ; - Get event reason
"RTN","MPIFA31I",88,0)
 S REASON=$P(EVN,FLDSEP,4)
"RTN","MPIFA31I",89,0)
 ; - Validate information in EVN segment
"RTN","MPIFA31I",90,0)
 ;   - Event reason is 95
"RTN","MPIFA31I",91,0)
 Q:(REASON'="95") "-1^Event reason code not valid (must be '95')"
"RTN","MPIFA31I",92,0)
 ;Process PID segment
"RTN","MPIFA31I",93,0)
 ; - Get ICN & checksum & checksum scheme
"RTN","MPIFA31I",94,0)
 S TMP=$P(PID,FLDSEP,2)
"RTN","MPIFA31I",95,0)
 S ICN=$P(TMP,CMPSEP,1)
"RTN","MPIFA31I",96,0)
 Q:(ICN'?1.16N1"V"6N) "-1^ICN not in correct format"
"RTN","MPIFA31I",97,0)
 S ICNNUM=$P(ICN,"V",1)
"RTN","MPIFA31I",98,0)
 S ICNCHECK=$P(TMP,"V",2)
"RTN","MPIFA31I",99,0)
 Q:((ICNNUM="")!(ICNCHECK="")) "-1^Could not determine ICN"
"RTN","MPIFA31I",100,0)
 ; - Validate checksum
"RTN","MPIFA31I",101,0)
 Q:(ICNCHECK'=$$CHECKDG^MPIFSPC(ICNNUM)) "-1^ICN/checksum not valid"
"RTN","MPIFA31I",102,0)
 ; - Get DFN & checksum & checksum scheme
"RTN","MPIFA31I",103,0)
 S TMP=$P(PID,FLDSEP,3)
"RTN","MPIFA31I",104,0)
 ; - Get SSN (account for roll over)
"RTN","MPIFA31I",105,0)
 S SSN=""
"RTN","MPIFA31I",106,0)
 S TMP=$L(PID,FLDSEP)
"RTN","MPIFA31I",107,0)
 S TMP1=$P(PID,FLDSEP,TMP)
"RTN","MPIFA31I",108,0)
 S:(TMP=19) SSN=$P(PID,FLDSEP,19)_$P($G(PID(1)),FLDSEP,1)
"RTN","MPIFA31I",109,0)
 S:(TMP>19) SSN=$P(PID,FLDSEP,19)
"RTN","MPIFA31I",110,0)
 S:(TMP<19) SSN=$P($G(PID(1)),FLDSEP,((19-TMP)+1))
"RTN","MPIFA31I",111,0)
 ; - Validate information in PID
"RTN","MPIFA31I",112,0)
 ;   - Make sure DFN exists
"RTN","MPIFA31I",113,0)
 S LOCAL=$G(^DPT(DFN,0))
"RTN","MPIFA31I",114,0)
 Q:($P(LOCAL,"^",1)="") "-1^Could not locate patient (bad DFN)"
"RTN","MPIFA31I",115,0)
 ;   - Make sure SSNs match
"RTN","MPIFA31I",116,0)
 Q:($P(LOCAL,"^",9)'=SSN) "-1^DFN/SSN pairing not valid"
"RTN","MPIFA31I",117,0)
 ;Extra validation checks
"RTN","MPIFA31I",118,0)
 ; - Verify lack of national ICN
"RTN","MPIFA31I",119,0)
 I ($$GETICN^MPIF001(DFN)>0) Q:('$D(^DPT("AICNL",1,DFN))) "-1^National ICN already assigned to patient"
"RTN","MPIFA31I",120,0)
 ;Passed all validation checks - store ICN & checksum
"RTN","MPIFA31I",121,0)
 S TMP=$$SETICN^MPIF001(DFN,ICNNUM,ICNCHECK)
"RTN","MPIFA31I",122,0)
 Q:(TMP<0) "-1^Unable to store ICN and checksum"
"RTN","MPIFA31I",123,0)
 ;Delete local ICN flag
"RTN","MPIFA31I",124,0)
 S TMP=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFA31I",125,0)
 S TMP=$$CHANGE^MPIF001(DFN,+$$SITE^VASITE)
"RTN","MPIFA31I",126,0)
 N HERE,TFSITE
"RTN","MPIFA31I",127,0)
 S HERE=+$P($$SITE^VASITE,"^",3)
"RTN","MPIFA31I",128,0)
 S TFSITE=$$LKUP^XUAF4(HERE)
"RTN","MPIFA31I",129,0)
 Q:+TFSITE'>0 ICN
"RTN","MPIFA31I",130,0)
 Q:$D(^DGCN(391.91,"APAT",DFN,TFSITE)) ICN
"RTN","MPIFA31I",131,0)
 K DD,DO N DIC,X,Y
"RTN","MPIFA31I",132,0)
 S DIC="^DGCN(391.91,",DIC("DR")=".02///`"_TFSITE,X=DFN,DIC(0)="LQZ"
"RTN","MPIFA31I",133,0)
 D FILE^DICN
"RTN","MPIFA31I",134,0)
 I +Y=-1 S ^XTMP($J,"MPIF","MSHERR")="Treating Facility Add Failed" D
"RTN","MPIFA31I",135,0)
 .D EXC^RGHLLOG(212,"DFN= "_DFN_"  Treating Facility= "_TFSITE,DFN)
"RTN","MPIFA31I",136,0)
 K DD,DO,DIC,X,Y
"RTN","MPIFA31I",137,0)
 ;Done
"RTN","MPIFA31I",138,0)
 Q ICN
"RTN","MPIFAPI")
0^6^B73829700
"RTN","MPIFAPI",1,0)
MPIFAPI ;CMC/BP-APIS FOR MPI ;DEC 21, 1998
"RTN","MPIFAPI",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,14,16,17,21**;30 Apr 99
"RTN","MPIFAPI",3,0)
 ;original 1st line ARS/SLC - API for local ICNs ;04-FEB-97
"RTN","MPIFAPI",4,0)
 ;
"RTN","MPIFAPI",5,0)
 ; Intregration Agreement Utilized:
"RTN","MPIFAPI",6,0)
 ;   ^DPT( - #2070
"RTN","MPIFAPI",7,0)
 ;   ^%ZTLOAD - #10063
"RTN","MPIFAPI",8,0)
 ;   ^DIC - #10006
"RTN","MPIFAPI",9,0)
 ;   FILE^DICN - #10009
"RTN","MPIFAPI",10,0)
 ;   ^DIE - #10018
"RTN","MPIFAPI",11,0)
 ;   ^DIK - #10013
"RTN","MPIFAPI",12,0)
 ;   ^DPT("AICN", ^DPT("AMPIMIS", ^DPT("ASCN2" - #2070
"RTN","MPIFAPI",13,0)
 ;   LINK^HLUTIL3 - #2271
"RTN","MPIFAPI",14,0)
 ;   $$SITE^VASITE - #10112
"RTN","MPIFAPI",15,0)
 ;   $$FMADD and $$NOW^XLFDT - #10103
"RTN","MPIFAPI",16,0)
 ;   $$LKUP^XUAF4 - #2171
"RTN","MPIFAPI",17,0)
 ;   HOME^ZIS - #10086
"RTN","MPIFAPI",18,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFAPI",19,0)
 ;   $$SEND2^VAFCUTL1 - #2779
"RTN","MPIFAPI",20,0)
 ;
"RTN","MPIFAPI",21,0)
EN2() ;NEW ENTRY POINT FOR LOCALS
"RTN","MPIFAPI",22,0)
 N MPIOUT,DIC,MPICHK,MPINCK,MPINNM,MPINUM1,DA,MPINUM
"RTN","MPIFAPI",23,0)
 I $O(^MPIF(984.1,0))="" G SETUP
"RTN","MPIFAPI",24,0)
AGN2 L +^MPIF(984.1):1 E  H 3 G AGN2
"RTN","MPIFAPI",25,0)
 S MPINUM=0
"RTN","MPIFAPI",26,0)
 S X=$$SITE^VASITE,X=$P(X,"^",3),X=X\1
"RTN","MPIFAPI",27,0)
 S DIC="^MPIF(984.1,",DIC(0)="XZ" D ^DIC
"RTN","MPIFAPI",28,0)
 S MPINUM1=$P(Y(0),"^",4),MPICHK=$P(Y(0),"^",5),MPINNM=MPINUM1+1
"RTN","MPIFAPI",29,0)
 S MPINUM=MPINUM1_"V"_MPICHK
"RTN","MPIFAPI",30,0)
 S MPINCK=$$CHECKDG^MPIFSPC(MPINNM)
"RTN","MPIFAPI",31,0)
 S DA=1,DIE="^MPIF(984.1,",DR="1////^S X=MPINUM1;2////^S X=MPICHK;3////^S X=MPINNM;5////"_MPINCK
"RTN","MPIFAPI",32,0)
 D ^DIE
"RTN","MPIFAPI",33,0)
 K DIE,DR,X,Y
"RTN","MPIFAPI",34,0)
 L -^MPIF(984.1)
"RTN","MPIFAPI",35,0)
 Q MPINUM
"RTN","MPIFAPI",36,0)
SETUP ;
"RTN","MPIFAPI",37,0)
 N CHK,NUM,NXTCHK,NXTNUM,SITE,DA
"RTN","MPIFAPI",38,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFAPI",39,0)
 S DIC="^MPIF(984.1,",DA=1,DIC(0)="",X=SITE
"RTN","MPIFAPI",40,0)
 S NUM=SITE_"0000000"
"RTN","MPIFAPI",41,0)
 S CHK=$$CHECKDG^MPIFSPC(NUM)
"RTN","MPIFAPI",42,0)
 S MPINUM=NUM_"V"_CHK
"RTN","MPIFAPI",43,0)
 S NXTNUM=NUM+1,NXTCHK=$$CHECKDG^MPIFSPC(NXTNUM)
"RTN","MPIFAPI",44,0)
 S DIC("DR")="1////^S X=NUM;2////^S X=CHK;3////^S X=NXTNUM;5////"_NXTCHK
"RTN","MPIFAPI",45,0)
 K DD,D0
"RTN","MPIFAPI",46,0)
 D FILE^DICN
"RTN","MPIFAPI",47,0)
 K DIC,X,Y
"RTN","MPIFAPI",48,0)
 Q MPINUM
"RTN","MPIFAPI",49,0)
 ;
"RTN","MPIFAPI",50,0)
MPILINK() ;returns MPI logical Link
"RTN","MPIFAPI",51,0)
 N MPIL,MPILINK
"RTN","MPIFAPI",52,0)
 D LINK^HLUTIL3("MPI",.MPIL)
"RTN","MPIFAPI",53,0)
 I '$D(MPIL) Q "-1^NOT DEFINED"
"RTN","MPIFAPI",54,0)
 S MPILINK=$O(MPIL(0))
"RTN","MPIFAPI",55,0)
 I MPILINK="" Q "-1^NOT DEFINED"
"RTN","MPIFAPI",56,0)
 S MPILINK=$G(MPIL(MPILINK))
"RTN","MPIFAPI",57,0)
 Q MPILINK
"RTN","MPIFAPI",58,0)
 ;
"RTN","MPIFAPI",59,0)
SUBNUM(DFN) ; returns Subscription Control Number from MPI node for given DFN
"RTN","MPIFAPI",60,0)
 ; DFN - ien of patient file
"RTN","MPIFAPI",61,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",62,0)
 ;           Subscription Control Number
"RTN","MPIFAPI",63,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",64,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",65,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",66,0)
 N NODE,SUB
"RTN","MPIFAPI",67,0)
 S NODE=$$MPINODE(DFN)
"RTN","MPIFAPI",68,0)
 S SUB=$P(NODE,"^",5)
"RTN","MPIFAPI",69,0)
 I SUB="" S SUB="-1^No Subscription Control Number for DFN "_DFN
"RTN","MPIFAPI",70,0)
 Q SUB
"RTN","MPIFAPI",71,0)
 ;
"RTN","MPIFAPI",72,0)
MPINODE(DFN) ; returns MPI node for given DFN
"RTN","MPIFAPI",73,0)
 ; DFN - patient file ien
"RTN","MPIFAPI",74,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",75,0)
 ;           MPI node from patient file
"RTN","MPIFAPI",76,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",77,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",78,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",79,0)
 N NODE
"RTN","MPIFAPI",80,0)
 S NODE=$G(^DPT(DFN,"MPI"))
"RTN","MPIFAPI",81,0)
 I NODE=""!(NODE?."^") S NODE="-1^No MPI data for DFN "_DFN
"RTN","MPIFAPI",82,0)
 Q NODE
"RTN","MPIFAPI",83,0)
 ;
"RTN","MPIFAPI",84,0)
GETADFN(ICN) ; return DFN ONLY if ICN is the active ICN
"RTN","MPIFAPI",85,0)
 ; ICN - Integration Control Number for patient to be returned
"RTN","MPIFAPI",86,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",87,0)
 ;           DFN - IEN for the patient entry in the Patient file (#2)
"RTN","MPIFAPI",88,0)
 N RETURN,DFN
"RTN","MPIFAPI",89,0)
 I $G(ICN)'>0 Q "-1^NO ICN"
"RTN","MPIFAPI",90,0)
 I '$D(^DPT("AICN",ICN)) Q "-1^ICN NOT IN DATABASE"
"RTN","MPIFAPI",91,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIFAPI",92,0)
 I $G(DFN)'>0 Q "-1^BAD AICN CROSS-REFERENCE"
"RTN","MPIFAPI",93,0)
 I $P($G(^DPT(DFN,"MPI")),"^")'=ICN Q "-1^ICN is not Active one"
"RTN","MPIFAPI",94,0)
 Q DFN
"RTN","MPIFAPI",95,0)
 ;
"RTN","MPIFAPI",96,0)
UPDATE(DFN,ARR,MPISILNT) ;api to edit 'mpi','mpifhis' and 'mpicmor' nodes
"RTN","MPIFAPI",97,0)
 ;variables
"RTN","MPIFAPI",98,0)
 ;DFN - patient IEN
"RTN","MPIFAPI",99,0)
 ;ARR - array in the format listed below
"RTN","MPIFAPI",100,0)
 ; MPI node by passing in ARR(field#)=value
"RTN","MPIFAPI",101,0)
 ;   **note
"RTN","MPIFAPI",102,0)
 ;         991.04 is only edited based on the edit of 991.01
"RTN","MPIFAPI",103,0)
 ;         991.03 should be passed with either "@" or IEN in File 4
"RTN","MPIFAPI",104,0)
 ; MPIFHIS node by passing ARR(992)=old ICN to remove from multiple
"RTN","MPIFAPI",105,0)
 ; MPICMOR node by passing ARR(993)=old CMOR to remove from multiple
"RTN","MPIFAPI",106,0)
 ;MPISILNT(optional) - 0 to not suppress exceptions (default)
"RTN","MPIFAPI",107,0)
 ;                     1 to suppress exceptions
"RTN","MPIFAPI",108,0)
 ;Returns : -1^error message if unable to update fields
"RTN","MPIFAPI",109,0)
 ;          0 if successfully updated fields
"RTN","MPIFAPI",110,0)
 ;
"RTN","MPIFAPI",111,0)
 N MPIRETN,MPIX,VALUE,ICN,SCN,ICN2
"RTN","MPIFAPI",112,0)
 I DFN'>0 Q "-1^DFN passed into UPDATE^MPIFAPI not greater than 0"
"RTN","MPIFAPI",113,0)
 Q:'$D(^DPT(DFN,0)) "-1^DFN "_DFN_" does not exist"
"RTN","MPIFAPI",114,0)
 S MPIRETN=0,RGRSICN=""
"RTN","MPIFAPI",115,0)
 L +^DPT(DFN,"MPI"):10
"RTN","MPIFAPI",116,0)
 I $D(@ARR@(991.01)) D
"RTN","MPIFAPI",117,0)
 . I '$D(@ARR@(991.02)) S MPIRETN="-1^ICN "_ICN_", passed without checksum" Q
"RTN","MPIFAPI",118,0)
 . ;quit if local is going to overwrite national
"RTN","MPIFAPI",119,0)
 . S ICN=+$$GETICN^MPIF001(DFN) I ICN>0 I $E(@ARR@(991.01),1,3)=$P($$SITE^VASITE(),"^",3),$E(ICN,1,3)'=$E(@ARR@(991.01),1,3) S RETURN="-1^Overwriting the National ICN, "_ICN_", with a local, "_@ARR@(991.01)_", isn't allowed" Q
"RTN","MPIFAPI",120,0)
 .;quit if this is a test patient and not deleting ICN
"RTN","MPIFAPI",121,0)
 .I +$$SEND2^VAFCUTL1(DFN,"T")=1&(@ARR@(991.01)'="@") S RETURN="-1^Pt DFN "_DFN_" has been ZZ'd or has 5 leading 0s" Q
"RTN","MPIFAPI",122,0)
 .; quite it ICN has already been assigned to another patient in your data base
"RTN","MPIFAPI",123,0)
 .S ICN2=@ARR@(991.01)
"RTN","MPIFAPI",124,0)
 .I $D(^DPT("AICN",ICN2)),DFN'=$O(^DPT("AICN",ICN2,"")) D
"RTN","MPIFAPI",125,0)
 ..N RGLOG D START^RGHLLOG(0)
"RTN","MPIFAPI",126,0)
 ..I DFN'=($O(^DPT("AICN",ICN2,""))) D EXC^RGHLLOG(227,"Patient dfn "_DFN_"  returned ICN "_ICN2_" that is already in use for Patient dfn "_$O(^DPT("AICN",ICN2,""))_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFAPI",127,0)
 ..D STOP^RGHLLOG(0) S MPIRETN="-1^ICN "_ICN2_" is already in use for pt DFN "_DFN
"RTN","MPIFAPI",128,0)
 .Q:+MPIRETN=-1
"RTN","MPIFAPI",129,0)
 . K FDA S FDA(1,2,DFN_",",991.01)=@ARR@(991.01)
"RTN","MPIFAPI",130,0)
 . K MPIERR D FILE^DIE("E","FDA(1)","MPIERR") K FDA(1) I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to update pt's ICN (DFN="_DFN_") ICN to "_@ARR@(991.01)_" because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI",131,0)
 . I +MPIRETN'=0 Q
"RTN","MPIFAPI",132,0)
 . K FDA S FDA(1,2,DFN_",",991.02)=@ARR@(991.02)
"RTN","MPIFAPI",133,0)
 . K MPIERR D FILE^DIE("E","FDA(1)","MPIERR") K FDA(1) I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to update pt's ("_DFN_") ICN Checksum to "_@ARR@(991.02)_" because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI",134,0)
 . I +MPIRETN'=0 Q
"RTN","MPIFAPI",135,0)
 . K FDA S FDA(1,2,DFN_",",991.04)="@"
"RTN","MPIFAPI",136,0)
 . K MPIERR D FILE^DIE("E","FDA(1)","MPIERR") K FDA(1) I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to delete pt's ("_DFN_" LOCALLY ASSIGNED ICN field because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI",137,0)
 I MPIRETN=0 I $D(@ARR@(991.03)) D
"RTN","MPIFAPI",138,0)
 . I @ARR@(991.03)="@" K FDA S FDA(1,2,DFN_",",991.03)="@"
"RTN","MPIFAPI",139,0)
 . I @ARR@(991.03)'="@" I @ARR@(991.03)>0 I $$STA^XUAF4(@ARR@(991.03))'="" S FDA(1,2,DFN_",",991.03)="`"_@ARR@(991.03)
"RTN","MPIFAPI",140,0)
 . D FILE^DIE("E","FDA(1)","MPIERR") I $D(MPIERR("DIERR")) D
"RTN","MPIFAPI",141,0)
 .. S MPIRETN="-1^Unable to update pt's ("_DFN_") CMOR to "_@ARR@(991.03)_" because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI",142,0)
 .. I +$G(MPISILNT)=0 N RGLOG D START^RGHLLOG(0) D EXC^RGHLLOG(221,"Unable to update CMOR to "_@ARR@(991.03)_" for DFN="_DFN,DFN) D STOP^RGHLLOG(0)
"RTN","MPIFAPI",143,0)
 I MPIRETN=0 I $D(@ARR@(991.05)) D
"RTN","MPIFAPI",144,0)
 . I @ARR@(991.05)="@" D
"RTN","MPIFAPI",145,0)
 .. S SCN=$$SUBNUM(DFN)
"RTN","MPIFAPI",146,0)
 .. S DA=SCN,DIK="^HLS(774," D ^DIK K DIK,DA
"RTN","MPIFAPI",147,0)
 .. S $P(^DPT(DFN,"MPI"),"^",5)=""
"RTN","MPIFAPI",148,0)
 .. K ^DPT("ASCN2",SCN,DFN)
"RTN","MPIFAPI",149,0)
 . I @ARR@(991.05)'="@" D
"RTN","MPIFAPI",150,0)
 .. ;do edit and return result
"RTN","MPIFAPI",151,0)
 .. S DIE="^DPT(",DA=DFN,DR="991.05///^S X=@ARR@(991.05)" D ^DIE
"RTN","MPIFAPI",152,0)
 I MPIRETN=0 I $D(@ARR@(992)) D
"RTN","MPIFAPI",153,0)
 . ;delete old value from history multiple
"RTN","MPIFAPI",154,0)
 . S MPIX=0 F  S MPIX=$O(^DPT(DFN,"MPIFHIS",MPIX)) Q:'MPIX  S VALUE=^DPT(DFN,"MPIFHIS",MPIX,0) I $P(VALUE,"^")=@ARR@(992) D
"RTN","MPIFAPI",155,0)
 .. K ^DPT("AICN",@ARR@(992),DFN),MPIERR,FDA
"RTN","MPIFAPI",156,0)
 .. S FDA(1,2.0992,MPIX_","_DFN_",",.01)="@" D FILE^DIE("","FDA(1)","MPIERR")
"RTN","MPIFAPI",157,0)
 .. I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to delete pt's ("_DFN_")  ICN "_@ARR@(992)_" from ICN HISTORY because "_MPIERR("DIERR",1,"TEXT",1) K MPIERR,FDA
"RTN","MPIFAPI",158,0)
 I MPIRETN=0 I $D(@ARR@(993)) D
"RTN","MPIFAPI",159,0)
 . ;delete old value from history multiple
"RTN","MPIFAPI",160,0)
 . S MPIX=0 F  S MPIX=$O(^DPT(DFN,"MPICMOR",MPIX)) Q:'MPIX  S VALUE=^DPT(DFN,"MPICMOR",MPIX,0) I $P(VALUE,"^")=@ARR@(993) D
"RTN","MPIFAPI",161,0)
 .. K FDA,MPIERR S FDA(1,2.0993,MPIX_","_DFN_",",.01)="@" D FILE^DIE("","FDA(1)","MPIERR")
"RTN","MPIFAPI",162,0)
 .. I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to delete pt's ("_DFN_") CMOR "_@ARR@(993)_" from CMOR HISTORY because "_MPIERR("DIERR",1,"TEXT",1) K MPIERR,FDA
"RTN","MPIFAPI",163,0)
 K ^DPT("AMPIMIS",DFN)
"RTN","MPIFAPI",164,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIFAPI",165,0)
 K RGRSICN
"RTN","MPIFAPI",166,0)
 Q MPIRETN
"RTN","MPIFAPI",167,0)
 ;
"RTN","MPIFAPI",168,0)
MPIQ(DFN) ;
"RTN","MPIFAPI",169,0)
 ;MPI QUERY
"RTN","MPIFAPI",170,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFAPI",171,0)
 K MPIFRTN D VTQ^MPIFQ0
"RTN","MPIFAPI",172,0)
 I $G(MPIFRTN)="" D
"RTN","MPIFAPI",173,0)
 .; ^ Quit at LM screen when presented with a list of possible matches
"RTN","MPIFAPI",174,0)
 .; \/ setup Local ICN and proceed
"RTN","MPIFAPI",175,0)
 .N ICN,ERR
"RTN","MPIFAPI",176,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIFAPI",177,0)
 .Q:ICN=""!(+ICN=-1)
"RTN","MPIFAPI",178,0)
 .S ERR=$$SETICN^MPIF001(DFN,+ICN,$P(ICN,"V",2))
"RTN","MPIFAPI",179,0)
 .Q:+ERR=-1
"RTN","MPIFAPI",180,0)
 .; ^ couldn't set ICN don't set other fields
"RTN","MPIFAPI",181,0)
 .S ERR=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFAPI",182,0)
 .S ERR=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFAPI",183,0)
 K MPIFRTN,ZTREQ
"RTN","MPIFAPI",184,0)
 Q
"RTN","MPIFAPI",185,0)
 ;
"RTN","MPIFAPI",186,0)
MPIQQ(PDFN) ; Entry point for queuing d/c
"RTN","MPIFAPI",187,0)
 ; DFN should already exist before making this call
"RTN","MPIFAPI",188,0)
 ; Returned is -1^error message OR Task #
"RTN","MPIFAPI",189,0)
 Q:'$D(PDFN) "-1^No DFN passed"
"RTN","MPIFAPI",190,0)
 S ZTRTN="MPIQ^MPIFAPI(PDFN)"
"RTN","MPIFAPI",191,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFAPI",192,0)
 S ZTSAVE("PDFN")=PDFN
"RTN","MPIFAPI",193,0)
 S ZTSAVE("MPIFS")=1
"RTN","MPIFAPI",194,0)
 ; ^ silent flag
"RTN","MPIFAPI",195,0)
 S ZTIO=""
"RTN","MPIFAPI",196,0)
 S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFAPI",197,0)
 D ^%ZTLOAD
"RTN","MPIFAPI",198,0)
 D HOME^ZIS K IO("Q")
"RTN","MPIFAPI",199,0)
 N TSK
"RTN","MPIFAPI",200,0)
 S TSK=ZTSK
"RTN","MPIFAPI",201,0)
 K ZTSAVE,ZTRTN,ZTIO,ZTDTH,ZTSK
"RTN","MPIFAPI",202,0)
 Q TSK
"RTN","MPIFAPI",203,0)
 ;
"RTN","MPIFAPI",204,0)
SEG(SEGMENT,PIECE,CODE) ;Return segment from MPIDC array and kill node
"RTN","MPIFAPI",205,0)
 N MPINODE,MPIDATA,MPIDONE,MPIC K MPIDONE
"RTN","MPIFAPI",206,0)
 I '$D(MPIC) S MPIC=$E(HL("ECH"))
"RTN","MPIFAPI",207,0)
 S MPINODE=0
"RTN","MPIFAPI",208,0)
 F  S MPINODE=$O(MPIDC(MPINODE)) Q:MPINODE=""!($D(MPIDONE))  D
"RTN","MPIFAPI",209,0)
 .S MPIDATA=MPIDC(MPINODE)
"RTN","MPIFAPI",210,0)
 .I ($P(MPIDATA,HL("FS"),1)=SEGMENT)&($P($P(MPIDATA,HL("FS"),PIECE),MPIC,1)=CODE) S MPIDONE=1 K MPIDC(MPINODE)
"RTN","MPIFAPI",211,0)
 Q:$D(MPIDONE) $G(MPIDATA)
"RTN","MPIFAPI",212,0)
 Q ""
"RTN","MPIFBT2")
0^13^B46043248
"RTN","MPIFBT2",1,0)
MPIFBT2 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT2",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,10,17,21**;30 Apr 99
"RTN","MPIFBT2",3,0)
 ;
"RTN","MPIFBT2",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFBT2",5,0)
 ;   ^DGCN(391.91 - #2751
"RTN","MPIFBT2",6,0)
 ;   EXC, START, STOP ^RGHLLOG - #2796
"RTN","MPIFBT2",7,0)
 ;   XMITFLAG^VAFCDD01 - #3493
"RTN","MPIFBT2",8,0)
 ;   $$PIVNW^VAFHPIVT - #3494
"RTN","MPIFBT2",9,0)
 ;
"RTN","MPIFBT2",10,0)
ADDPAT ;Called when response from MPI is received for messages sent.
"RTN","MPIFBT2",11,0)
 K ^XTMP($J,"MPIF") D NOW^%DTC S ST=%,X1=ST,X2=20 D C^%DTC
"RTN","MPIFBT2",12,0)
 S STP=X,^XTMP($J,"MPIF","MPIIN",0)=STP_"^"_ST_"^"_"MPI BATCH JOB"
"RTN","MPIFBT2",13,0)
 K %,X,Y,X1,X2,ST,STP N RGLOG,MPIMSG S MPIMSG=HLMTIEN
"RTN","MPIFBT2",14,0)
 D START^RGHLLOG(HLMTIEN,"","ADDPAT^MPIFBT2")
"RTN","MPIFBT2",15,0)
 D PREPMSG,PROCESS(MPIMSG),STOP^RGHLLOG(0)
"RTN","MPIFBT2",16,0)
 K ACK1,ACK2,ACK3,ACK4,HDR,MPICKG,MPIIN,MPIIPPF,MPIIT,MPINUM,MPIPPF,DA
"RTN","MPIFBT2",17,0)
 K CNTR,COM,ENC,ESC,LOCAL,MSHDR,PATID,REP,SCOM,SEP,SITE,MPIDTH,VISTDTH,MPITMP,MPICNTR,MPIFOK,^XTMP($J,"MPIF"),DGSENFLG
"RTN","MPIFBT2",18,0)
 Q
"RTN","MPIFBT2",19,0)
PREPMSG ;prepare for response
"RTN","MPIFBT2",20,0)
 N I,J,X F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFBT2",21,0)
 .S ^XTMP($J,"MPIF","MPIIN",I)=HLNODE,J=0
"RTN","MPIFBT2",22,0)
 .F  S J=$O(HLNODE(J))  Q:'J  S ^XTMP($J,"MPIF","MPIIN",I,J)=HLNODE(J)
"RTN","MPIFBT2",23,0)
 Q
"RTN","MPIFBT2",24,0)
PROCESS(MPIMSG) ;Process mesage out of array
"RTN","MPIFBT2",25,0)
 N HDR,MPICNTR S MPICNTR=1,HDR=^XTMP($J,"MPIF","MPIIN",1) ;check hdr here
"RTN","MPIFBT2",26,0)
 D CHDR(HDR,.SEP,MPICNTR,MPIMSG)
"RTN","MPIFBT2",27,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",28,0)
 F  S MPICNTR=$O(^XTMP($J,"MPIF","MPIIN",MPICNTR)) Q:'MPICNTR  D LOOPS(.MPICNTR,SEP,MPIMSG)
"RTN","MPIFBT2",29,0)
 Q
"RTN","MPIFBT2",30,0)
LOOPS(CNTR,SEP,MPIMSG) ;Loop in the batch
"RTN","MPIFBT2",31,0)
 K ^XTMP($J,"MPIF","MSHERR") N MSHDR,ACK1,ACK2,ACK3,ACK4,ACK5,PATID,LOCAL,MPITMP,LICN
"RTN","MPIFBT2",32,0)
 S MSHDR=^XTMP($J,"MPIF","MPIIN",+CNTR)
"RTN","MPIFBT2",33,0)
 D CHKMSH(MSHDR,.SITE,SEP,MPIMSG)
"RTN","MPIFBT2",34,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",35,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",36,0)
 S ACK1=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",37,0)
 I $P(ACK1,SEP)'="MSA" S ^XTMP($J,"MPIF","MSHERR")="NOT AN MSA SEGMENT" D EXC^RGHLLOG(203,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",38,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",39,0)
 I ACK1["AR" S ^XTMP($J,"MPIF","MSHERR")="APP REJECT ERROR" D EXC^RGHLLOG(207,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",40,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",41,0)
 I ACK1["AE" S ^XTMP($J,"MPIF","MSHERR")="APP ERROR" D EXC^RGHLLOG(208,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",42,0)
 ;ACK1 must be an AA
"RTN","MPIFBT2",43,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",44,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",45,0)
 S ACK2=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",46,0)
 I $P(ACK2,SEP)'="QAK" S ^XTMP($J,"MPIF","MSHERR")="NOT A QAK SEGMENT" D EXC^RGHLLOG(202,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",47,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",48,0)
 I ACK2["NO DATA" D
"RTN","MPIFBT2",49,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NO DATA in MPI "
"RTN","MPIFBT2",50,0)
 .I ACK2["POTENTIAL MATCHES" D
"RTN","MPIFBT2",51,0)
 ..D EXC^RGHLLOG(218,"For Patient DFN="_$P(ACK2,SEP,2)_".  Use Single Patient Initialization to MPI option to manually process.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",52,0)
 ..I $D(^DPT($P(ACK2,SEP,2),0)) S LICN=$$ICNLC^MPIF001($P(ACK2,SEP,2))
"RTN","MPIFBT2",53,0)
 ..; ^ create a local ICN
"RTN","MPIFBT2",54,0)
 .I ACK2'["POTENTIAL MATCHES" D
"RTN","MPIFBT2",55,0)
 ..D EXC^RGHLLOG(209,"For Patient DFN="_$P(ACK2,SEP,2)_".  Need required fields before patient can be processed again the MPI.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",56,0)
 ..I $D(^DPT($P(ACK2,SEP,2),0)) S LICN=$$ICNLC^MPIF001($P(ACK2,SEP,2))
"RTN","MPIFBT2",57,0)
 ..; ^ create a local ICN
"RTN","MPIFBT2",58,0)
 .N TACK,TCNTR S TCNTR=CNTR,CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),TACK=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",59,0)
 .I $P(TACK,SEP)="MSH" S CNTR=TCNTR
"RTN","MPIFBT2",60,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",61,0)
 S PATID=$P(ACK2,SEP,2),LOCAL=$G(^DPT(PATID,0)) ;Verify patient is in database
"RTN","MPIFBT2",62,0)
 I LOCAL']"" S ^XTMP($J,"MPIF","MSHERR")="PATIENT DFN NOT IN DATABASE- BAD " D EXC^RGHLLOG(210,"Around line number "_(CNTR*2)_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT2",63,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",64,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",65,0)
 S ACK3=^XTMP($J,"MPIF","MPIIN",CNTR) ;RDF DEFINITION SEGMENT NO-OP
"RTN","MPIFBT2",66,0)
 I $P(ACK3,SEP)'="RDF" S ^XTMP($J,"MPIF","MSHERR")="NOT RDF SEGMENT" D EXC^RGHLLOG(204,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".",PATID)
"RTN","MPIFBT2",67,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",68,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",69,0)
 S ACK4=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",70,0)
 I $P(ACK4,SEP)'="RDT" S ^XTMP($J,"MPIF","MSHERR")="NOT RDT SEGMENT" D EXC^RGHLLOG(205,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".",PATID)
"RTN","MPIFBT2",71,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",72,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",73,0)
 I MPITMP'>0 S:$E($G(^XTMP($J,"MPIF","MPIIN",MPITMP)),1,3)="BTS" CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",74,0)
 Q:CNTR'>0
"RTN","MPIFBT2",75,0)
 D VFYRDT^MPIFBT3(ACK4,SEP,CNTR,PATID,SITE,MPIMSG)
"RTN","MPIFBT2",76,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",77,0)
 Q:MPITMP'>0
"RTN","MPIFBT2",78,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP)
"RTN","MPIFBT2",79,0)
 I $P(ACK5,SEP)="RDT" D MULT^MPIFBT3(.CNTR,ACK5,SEP,MPIMSG,PATID)
"RTN","MPIFBT2",80,0)
 Q
"RTN","MPIFBT2",81,0)
TFLIST(TFSITE,PATID) ;adding TFSITE site for patient to Treating Facility List (#391.91)
"RTN","MPIFBT2",82,0)
 I $G(TFSITE)="" S ^XTMP($J,"MPIF","MSHERR")="Treating Facility = null" D EXC^RGHLLOG(212,"DFN = "_PATID_" Treating Facility = Null",PATID) Q
"RTN","MPIFBT2",83,0)
 S TFSITE=$$LKUP^XUAF4(TFSITE)
"RTN","MPIFBT2",84,0)
 Q:+TFSITE'>0
"RTN","MPIFBT2",85,0)
 Q:$D(^DGCN(391.91,"APAT",PATID,TFSITE))
"RTN","MPIFBT2",86,0)
 K DD,DO N DIC,X,Y L +^DGCN(391.91,0):60
"RTN","MPIFBT2",87,0)
 I '$T D EXC^RGHLLOG(212,"Unable to Lock Treating Facility file to add patient DFN="_PATID_" Facility= "_TFSITE,PATID) Q
"RTN","MPIFBT2",88,0)
 S DIC="^DGCN(391.91,",DIC("DR")=".02///`"_TFSITE,X=PATID,DIC(0)="LQZ"
"RTN","MPIFBT2",89,0)
 I $D(^DGCN(391.91,"APAT",PATID,TFSITE)) L -^DGCN(391.91,0) Q
"RTN","MPIFBT2",90,0)
 D FILE^DICN L -^DGCN(391.91,0)
"RTN","MPIFBT2",91,0)
 I +Y=-1,'$D(^DGCN(391.91,"APAT",PATID,TFSITE)) S ^XTMP($J,"MPIF","MSHERR")="Treating Facility Add Failed" D EXC^RGHLLOG(212,"DFN= "_PATID_"  Treating Facility= "_TFSITE_"  failed when adding an entry to the Treating Facility file.",PATID)
"RTN","MPIFBT2",92,0)
 K DD,DO,DIC,X,Y
"RTN","MPIFBT2",93,0)
 Q
"RTN","MPIFBT2",94,0)
TFUPDT(PATID,MPIMSG,CNTR) ;treating facility update message to pivot file
"RTN","MPIFBT2",95,0)
 N ERR,TRANS,EVDT,X,Y,%
"RTN","MPIFBT2",96,0)
 D NOW^%DTC S EVDT=% K %,X,Y
"RTN","MPIFBT2",97,0)
 S ERR=$$PIVNW^VAFHPIVT(PATID,EVDT,5,PATID_";DPT(")
"RTN","MPIFBT2",98,0)
 I +ERR<1 D EXC^RGHLLOG(212,"When trying to add Patient (DFN)"_PATID_"   message# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT2",99,0)
 Q:+ERR<1
"RTN","MPIFBT2",100,0)
 D XMITFLAG^VAFCDD01("",+ERR)
"RTN","MPIFBT2",101,0)
 Q
"RTN","MPIFBT2",102,0)
CHDR(HDR,SEP,CNTR,MPIMSG) ;Only process Batch message responses
"RTN","MPIFBT2",103,0)
 I $P(HDR,"^")'="BHS" S ^XTMP($J,"MPIF","MSHERR")="BHS SEGMENT MISSING" D EXC^RGHLLOG(200,"for message "_MPIMSG_".  The segment contains "_HDR)
"RTN","MPIFBT2",104,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",105,0)
 S SEP=$G(HL("FS")) ;get field sep, and encoding characters
"RTN","MPIFBT2",106,0)
 I SEP="" S ^XTMP($J,"MPIF","MSHERR")="Missing field seperator" D EXC^RGHLLOG(200,"Missing field seperator")
"RTN","MPIFBT2",107,0)
 Q
"RTN","MPIFBT2",108,0)
CHKMSH(MSHDR,SITE,SEP,MPIMSG) ;VERIFY MSH
"RTN","MPIFBT2",109,0)
 I $P(MSHDR,SEP)="BTS" S ^XTMP($J,"MPIF","MSHERR")="BTS FOUND" Q
"RTN","MPIFBT2",110,0)
 S:$P(MSHDR,SEP)'="MSH" ^XTMP($J,"MPIF","MSHERR")="NOT MSH HEADER   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",111,0)
 S:$E(MSHDR,4)'=SEP ^XTMP($J,"MPIF","MSHERR")="FIELD SEPARATOR MISMATCH   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",112,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(201,$G(^XTMP($J,"MPIF","MSHERR")))
"RTN","MPIFBT2",113,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",114,0)
 S SITE=$P(MSHDR,SEP,6)
"RTN","MPIFBT2",115,0)
 I SITE="" S ^XTMP($J,"MPIF","MSHERR")="SITE NOT IN MSH"
"RTN","MPIFBT2",116,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(8,"MSH Doesn't Have SITE as 6th piece.   MESSAGE# "_MPIMSG)
"RTN","MPIFBT2",117,0)
 Q
"RTN","MPIFBT3")
0^14^B22612886
"RTN","MPIFBT3",1,0)
MPIFBT3 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,10,17,21**;30 Apr 99
"RTN","MPIFBT3",3,0)
 ;
"RTN","MPIFBT3",4,0)
 ; Intergration Agreements Utilized:
"RTN","MPIFBT3",5,0)
 ;  ^DPT("AICN", ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFBT3",6,0)
 ;  EXC^RGHLLOG - #2796
"RTN","MPIFBT3",7,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFBT3",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFBT3",9,0)
 ;
"RTN","MPIFBT3",10,0)
MULT(CNTR,ACK5,SEP,MPIMSG,PATID) ;multiple RDT segments
"RTN","MPIFBT3",11,0)
 N NEXTTF,MPITMP S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),NEXTTF=$P(ACK5,SEP,8)
"RTN","MPIFBT3",12,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:MPITMP'>0
"RTN","MPIFBT3",13,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP) K NEXTTF,MPITMP
"RTN","MPIFBT3",14,0)
 I $P(ACK5,SEP)="RDT" D MULT(.CNTR,ACK5,SEP,MPIMSG,PATID) ; ^ add to treating facility list.  If not RDT continue on processing next msh
"RTN","MPIFBT3",15,0)
 Q
"RTN","MPIFBT3",16,0)
VFYRDT(ACK4,SEP,CNTR,PATID,SITE,MPIMSG) ;Here is the meat
"RTN","MPIFBT3",17,0)
 N MPIY,IEN,MPICMOR S DGSENFLG=""
"RTN","MPIFBT3",18,0)
 D FINDHM(PATID,ACK4,SEP,.MPIY,MPIMSG,CNTR)
"RTN","MPIFBT3",19,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",20,0)
 N MPINUM,MPICKG,MPIIT,DR,DIE,X,MPIIPPF,MPIPPF
"RTN","MPIFBT3",21,0)
 S MPINUM=$P(ACK4,SEP,6),MPICKG=$P(MPINUM,"V",2),MPINUM=$P(MPINUM,"V",1)
"RTN","MPIFBT3",22,0)
 ;check if ICN already in use in Patient file
"RTN","MPIFBT3",23,0)
 I $D(^DPT("AICN",MPINUM)) D
"RTN","MPIFBT3",24,0)
 .Q:PATID=$O(^DPT("AICN",MPINUM,""))   ; same patient
"RTN","MPIFBT3",25,0)
 .S ^XTMP($J,"MPIF","MSHERR")="ICN already in use"
"RTN","MPIFBT3",26,0)
 .D EXC^RGHLLOG(227,"Patient dfn "_PATID_" returned ICN "_MPINUM_" that is already in use for Patient dfn "_$O(^DPT("AICN",MPINUM,""))_" Checkout pair to determine if a Duplicate.",PATID)
"RTN","MPIFBT3",27,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",28,0)
 S DIE="^DPT(",DA=$P(MPIY,"^",1),MPIIT=$P(MPIY,"^",1),DR="991.01////^S X=MPINUM;991.02////^S X=MPICKG" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",29,0)
 S IEN=$P(MPIY,"^") ; check if need to kill Local/MISSING ICN field
"RTN","MPIFBT3",30,0)
 I $D(^DPT("AMPIMIS",IEN)) K ^DPT("AMPIMIS",IEN)
"RTN","MPIFBT3",31,0)
 I $D(^DPT("AICNL",1,IEN)) D
"RTN","MPIFBT3",32,0)
 .S DIE="^DPT(",DA=IEN,DR="991.04///@" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",33,0)
 S MPIIPPF=""
"RTN","MPIFBT3",34,0)
 S MPIPPF=$P(ACK4,SEP,5),MPICMOR=$$LKUP^XUAF4(MPIPPF)
"RTN","MPIFBT3",35,0)
 I MPICMOR'="" S MPIIPPF=$$CHANGE^MPIF001(MPIIT,MPICMOR)
"RTN","MPIFBT3",36,0)
 I +MPIIPPF<0 D EXC^RGHLLOG(211,"Around line number "_(CNTR*2)_"  CMOR= "_MPIPPF_" DFN= "_MPIIT_"  MESSAGE# "_MPIMSG,MPIIT)
"RTN","MPIFBT3",37,0)
 Q:+MPIIPPF<0
"RTN","MPIFBT3",38,0)
 D FILE^VAFCTFU(PATID,+$$SITE^VASITE)
"RTN","MPIFBT3",39,0)
 Q
"RTN","MPIFBT3",40,0)
FINDHM(PATID,ACK4,SEP,MPIY,MPIMSG,CNTR) ;LOOKUP
"RTN","MPIFBT3",41,0)
 N DIC,X,Y,NM,YTMP,MPIN
"RTN","MPIFBT3",42,0)
 ;added I to DIC(0) allow processing of sensative patients when DUZ=0
"RTN","MPIFBT3",43,0)
 S DGSENFLG="",DIC="^DPT(",DIC(0)="OISZ",X="`"_PATID D ^DIC K DIC
"RTN","MPIFBT3",44,0)
 S YTMP=Y
"RTN","MPIFBT3",45,0)
 I YTMP=-1 S ^XTMP($J,"MPIF","MSHERR")="LOOKUP FAILED" D EXC^RGHLLOG(210,"SSN = "_$P(ACK4,SEP,3)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",46,0)
 Q:YTMP=-1
"RTN","MPIFBT3",47,0)
 S NM=$P(Y(0),"^"),YTMP=$G(Y(0)),MPIY=Y ; check if ICN already populated
"RTN","MPIFBT3",48,0)
 N ICN S ICN=$$GETICN^MPIF001(PATID)
"RTN","MPIFBT3",49,0)
 I +ICN'=-1,$E(+ICN,1,3)'=$P($$SITE^VASITE,"^",3) S ^XTMP($J,"MPIF","MSHERR")="Patient "_PATID_" Already has an ICN"
"RTN","MPIFBT3",50,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",51,0)
 S Y(0)=$G(YTMP)
"RTN","MPIFBT3",52,0)
 Q:$P(Y(0),"^",9)["P"&($P(ACK4,SEP,3)="")
"RTN","MPIFBT3",53,0)
 I $P(Y(0),"^",9)'=$P(ACK4,SEP,3) D
"RTN","MPIFBT3",54,0)
 .S ^XTMP($J,"MPIF","MSHERR")="SSN MISMATCH"
"RTN","MPIFBT3",55,0)
 .D EXC^RGHLLOG(213,"SSN on File = "_$P(Y(0),"^",9)_" SSN in Message = "_$P(ACK4,SEP,3)_"    MESSAGE # "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",56,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ; create local ICN
"RTN","MPIFBT3",57,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",58,0)
 D NAME^VAFCPID2(0,.NM,0) ; reformat name in DG 149 fashion for comparison
"RTN","MPIFBT3",59,0)
 S MPIN=$P(ACK4,SEP,2)_","_$P(ACK4,SEP,7)
"RTN","MPIFBT3",60,0)
 I $P(ACK4,SEP,10)'="" S MPIN=MPIN_" "_$P(ACK4,SEP,10)
"RTN","MPIFBT3",61,0)
 D NAME^VAFCPID2(0,.MPIN,0)
"RTN","MPIFBT3",62,0)
 I NM'=MPIN D
"RTN","MPIFBT3",63,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NAME MISMATCH"
"RTN","MPIFBT3",64,0)
 .D EXC^RGHLLOG(214,"Name on File = "_$P(Y(0),"^")_"  Name in Message = "_MPIN_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",65,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ;create local ICN
"RTN","MPIFBT3",66,0)
 ;check to see if MPI has Date of Death or if VistA has DOD
"RTN","MPIFBT3",67,0)
 N MPIDTH,VISTDTH
"RTN","MPIFBT3",68,0)
 I $P(ACK4,SEP,9)'="" S MPIDTH=$P(ACK4,SEP,9),MPIDTH=$$FMDATE^HLFNC(MPIDTH)\1
"RTN","MPIFBT3",69,0)
 I $D(^DPT(PATID,.35)),$P($G(^DPT(PATID,.35)),"^")'="" S VISTDTH=$P($G(^DPT(PATID,.35)),"^")\1
"RTN","MPIFBT3",70,0)
 I $D(MPIDTH)&$D(VISTDTH),MPIDTH'=VISTDTH D
"RTN","MPIFBT3",71,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y,Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",72,0)
 .D EXC^RGHLLOG(217,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",73,0)
 ; ^ BOTH HAVE DOD BUT THEY DON'T MATCH
"RTN","MPIFBT3",74,0)
 I '$D(MPIDTH)&($D(VISTDTH)) D
"RTN","MPIFBT3",75,0)
 .N Y S Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",76,0)
 .D EXC^RGHLLOG(216,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",77,0)
 ; ^ VISTA HAS DOD BUT MPI DOESN'T
"RTN","MPIFBT3",78,0)
 I $D(MPIDTH)&('$D(VISTDTH)) D
"RTN","MPIFBT3",79,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y
"RTN","MPIFBT3",80,0)
 .D EXC^RGHLLOG(215,"Around line "_(CNTR*2)_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",81,0)
 ; ^ MPI HAS DOD BUT VISTA DOESN'T
"RTN","MPIFBT3",82,0)
 Q
"RTN","MPIFCMRP")
0^8^B20326076
"RTN","MPIFCMRP",1,0)
MPIFCMRP ;BPCIO/CMC-PUSHING CMOR TO ANOTHER SITE ;NOV 15, 2000
"RTN","MPIFCMRP",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**11,21**;30 Apr 99
"RTN","MPIFCMRP",3,0)
 ;
"RTN","MPIFCMRP",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFCMRP",5,0)
 ;
"RTN","MPIFCMRP",6,0)
 ; ^DGCN(391.91   IA #2751
"RTN","MPIFCMRP",7,0)
 ;
"RTN","MPIFCMRP",8,0)
 ;Entry point for option: PUSH CMOR REQUEST - create a new request
"RTN","MPIFCMRP",9,0)
 ; to change CMOR when your site is the CMOR.
"RTN","MPIFCMRP",10,0)
 ; No input or output variables.
"RTN","MPIFCMRP",11,0)
 ;
"RTN","MPIFCMRP",12,0)
 ;Only if the site is the CMOR can this option be used
"RTN","MPIFCMRP",13,0)
 ; note: code here is very similar to MPIFEDIT
"RTN","MPIFCMRP",14,0)
NEW ;
"RTN","MPIFCMRP",15,0)
 N DIC,X,Y,DTOUT,DUOUT,PAT
"RTN","MPIFCMRP",16,0)
 S DIC="^DPT(",DIC(0)="QEAMZ",DIC("A")="Select PATIENT: "
"RTN","MPIFCMRP",17,0)
 D ^DIC
"RTN","MPIFCMRP",18,0)
 Q:$D(DTOUT)!$D(DUOUT)!(Y=-1)
"RTN","MPIFCMRP",19,0)
 S PAT=+Y
"RTN","MPIFCMRP",20,0)
 D LM(PAT)
"RTN","MPIFCMRP",21,0)
 Q
"RTN","MPIFCMRP",22,0)
LM(PAT) ; list manager entry point to push a change of CMOR with PAT set to the DFN
"RTN","MPIFCMRP",23,0)
 I +$$GETICN^MPIF001(PAT)<0 W !,"Patient doesn't have ICN, try again" G NEW
"RTN","MPIFCMRP",24,0)
 I $E($$GETICN^MPIF001(PAT),1,3)=$P($$SITE^VASITE(),"^",3) W !,"Patient has a Local ICN, try again" G NEW
"RTN","MPIFCMRP",25,0)
 I $$GETVCCI^MPIF001(PAT)<0 W !,"Patient doesn't have a CMOR, try again" G NEW
"RTN","MPIFCMRP",26,0)
 I $$GETVCCI^MPIF001(PAT)'=$P($$SITE^VASITE(),"^",3) W !,"You are NOT the CMOR, to request to be the CMOR, use option: Create a New CMOR Change Request" G NEW
"RTN","MPIFCMRP",27,0)
 N TMP S TMP=$O(^DGCN(391.91,"APAT",PAT,"")) I $O(^DGCN(391.91,"APAT",PAT,TMP))="" W !,"Patient isn't SHARED - CAN'T change CMOR" Q
"RTN","MPIFCMRP",28,0)
 ; CHECK IF ALREADY OPEN/PENDING REQUEST
"RTN","MPIFCMRP",29,0)
 N ENT,STOP,MPIFNM,REQNM
"RTN","MPIFCMRP",30,0)
 S ENT=0,STOP=0 F  S ENT=$O(^MPIF(984.9,"C",PAT,ENT)) Q:ENT=""!(STOP)  D
"RTN","MPIFCMRP",31,0)
 .I $P($G(^MPIF(984.9,ENT,0)),"^",6)<4 S STOP=1
"RTN","MPIFCMRP",32,0)
 I STOP W !!,"Already have request for this patient" G NEW
"RTN","MPIFCMRP",33,0)
 N N0,PHONE,DA,DIE,DR,DIR,ERROR,DIK,Y,DIRUT,REQ,TDA,PERS
"RTN","MPIFCMRP",34,0)
 S DA=$$ADD^MPIFNEW(),TDA=DA,PHONE=""
"RTN","MPIFCMRP",35,0)
 S DIE="^MPIF(984.9,",DR=".04///`"_PAT D ^DIE
"RTN","MPIFCMRP",36,0)
 S REQ=$P($G(^MPIF(984.9,DA,0)),"^")
"RTN","MPIFCMRP",37,0)
 W !,"REQUEST NUMBER:",REQ
"RTN","MPIFCMRP",38,0)
EDIT I $D(DUZ) D
"RTN","MPIFCMRP",39,0)
 .S PHONE=$P($G(^MPIF(984.9,+$O(^MPIF(984.9,"AD",DUZ,""),-1),0)),"^",5)
"RTN","MPIFCMRP",40,0)
 .N DA,DIC,DIQ S DIQ="MPIFNM",DR=".01;.132",DIQ(0)="E",DIC="^VA(200,",DA=DUZ
"RTN","MPIFCMRP",41,0)
 .D EN^DIQ1
"RTN","MPIFCMRP",42,0)
 .S REQNM=MPIFNM(200,DUZ,.01,"E")
"RTN","MPIFCMRP",43,0)
 I '$D(DUZ) S (PHONE,REQNM)=""
"RTN","MPIFCMRP",44,0)
 ;
"RTN","MPIFCMRP",45,0)
REASON S DIR("A")="Reason for Request",DIR("?")="Answer must be 3-60 characters in length.",DIR(0)="F^3:60" D ^DIR
"RTN","MPIFCMRP",46,0)
 I Y="" W !,"Answer must be 3-60 characters in length." G REASON
"RTN","MPIFCMRP",47,0)
 I X="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFCMRP",48,0)
 S DIE="^MPIF(984.9,",DR="1.02///"_X D ^DIE
"RTN","MPIFCMRP",49,0)
REQNM S DIR("A")="Requestor's Name",DIR("B")=REQNM,DIR("?")="Answer must be a valid user",DIR(0)="P^200:EQZ" D ^DIR K DIR("B")
"RTN","MPIFCMRP",50,0)
 I Y="" W !,"Must pick valid user" G REQNM
"RTN","MPIFCMRP",51,0)
 I X="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFCMRP",52,0)
 S PERS=+Y
"RTN","MPIFCMRP",53,0)
 S DIE="^MPIF(984.9,",DR=".02///`"_+Y D ^DIE
"RTN","MPIFCMRP",54,0)
PHONE S DIR("A")="Requestor's Phone",DIR("B")=PHONE,DIR("?")="Answer must be 4-20 charaters in length.",DIR(0)="F" D ^DIR K DIR("B")
"RTN","MPIFCMRP",55,0)
 I Y="" W !,"Answer must be 4-20 charaters in length."  G PHONE
"RTN","MPIFCMRP",56,0)
 I X="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFCMRP",57,0)
 S DIE="^MPIF(984.9,",DR=".05///"_X D ^DIE
"RTN","MPIFCMRP",58,0)
 ;
"RTN","MPIFCMRP",59,0)
CMOR S DIC("A")="Select Site to Be CMOR: ",DIC="^DIC(4,",DIC(0)="QEAM",DIC("S")="I $D(^DGCN(391.91,""APAT"",PAT,Y))"
"RTN","MPIFCMRP",60,0)
 D ^DIC
"RTN","MPIFCMRP",61,0)
 I X="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFCMRP",62,0)
 N TSITE S TSITE=+Y
"RTN","MPIFCMRP",63,0)
 S DIE="^MPIF(984.9,",DR=".07///`"_TSITE_";1.03///3;.09///`"_TSITE D ^DIE
"RTN","MPIFCMRP",64,0)
 ;update site, type of action and cmor after approval
"RTN","MPIFCMRP",65,0)
 ;
"RTN","MPIFCMRP",66,0)
 I $$CHK^MPIFEDIT(DA) W !,"This request is missing required data." G EDIT
"RTN","MPIFCMRP",67,0)
 ;
"RTN","MPIFCMRP",68,0)
APP S DIR("A")="Select Request Action (SEND/EDIT/DELETE)? ",DIR("B")="SEND",DIR(0)="SAO^SEND:SEND;EDIT:EDIT;DELETE:DELETE"
"RTN","MPIFCMRP",69,0)
 D ^DIR K DIR
"RTN","MPIFCMRP",70,0)
 S DA=TDA
"RTN","MPIFCMRP",71,0)
 I $E(Y)="D"!$D(DIRUT) D  Q
"RTN","MPIFCMRP",72,0)
 .S DIK="^MPIF(984.9," D ^DIK W "... Request deleted"
"RTN","MPIFCMRP",73,0)
 .Q
"RTN","MPIFCMRP",74,0)
 I $E(Y)="E" G REASON
"RTN","MPIFCMRP",75,0)
 S DR=".08////^S X=2;.06////^S X=2",DIE="^MPIF(984.9," D ^DIE W !,"... Request will be sent"
"RTN","MPIFCMRP",76,0)
 ; removed event queue due to delivery issues - this msg must be sent first followed by the actual change cmor msg.
"RTN","MPIFCMRP",77,0)
 N ERR,MPIFHL7 S ERR="ERRS",MPIFHL7=""
"RTN","MPIFCMRP",78,0)
 D EN^MPIFREQ("CMOR CHANGE REQUEST",DA,.ERR,MPIFHL7)
"RTN","MPIFCMRP",79,0)
 ;
"RTN","MPIFCMRP",80,0)
 ;NOW CHANGE CMOR AND SEND CHANGE CMOR MESSAGE
"RTN","MPIFCMRP",81,0)
 N TEXT,DIR,DR,CMOR,TMP,ERROR
"RTN","MPIFCMRP",82,0)
 S TEXT="Auto change - pushed CMOR",ERROR=0
"RTN","MPIFCMRP",83,0)
 S DIE="^MPIF(984.9,",DA=TDA,DR=".06///^S X=4;3.01///^S X=TEXT"
"RTN","MPIFCMRP",84,0)
 D ^DIE
"RTN","MPIFCMRP",85,0)
 S CMOR=$P($G(^MPIF(984.9,TDA,0)),"^",7)
"RTN","MPIFCMRP",86,0)
 I CMOR="" D  Q
"RTN","MPIFCMRP",87,0)
 .W !,"New CMOR Not Defined, edit request"
"RTN","MPIFCMRP",88,0)
 .S ^DIE="^MPIF(984.9,",DA=TDA,DR=".06///^S X=1" D ^DIE
"RTN","MPIFCMRP",89,0)
 S TMP=$$CHANGE^MPIF001(PAT,CMOR)
"RTN","MPIFCMRP",90,0)
 I +TMP<0 S ^DIE="^MPIF(984.9,",DA=TDA,DR=".06///^S X=1" D ^DIE Q
"RTN","MPIFCMRP",91,0)
 D BROAD^MPIFCMOR(DA,.ERROR)
"RTN","MPIFCMRP",92,0)
 Q
"RTN","MPIFDEL")
0^7^B21518908
"RTN","MPIFDEL",1,0)
MPIFDEL ;SF/MJM,CMC-DELETE PATIENT FROM MPI ;JUL 14, 1998
"RTN","MPIFDEL",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,9,19,17,21**;30 Apr 99
"RTN","MPIFDEL",3,0)
 ;
"RTN","MPIFDEL",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFDEL",5,0)
 ; ^DPT(         - IA #2070
"RTN","MPIFDEL",6,0)
 ; $$EN^VAFCPID  - IA #3015
"RTN","MPIFDEL",7,0)
 ; START^RGHLLOG - IA #2796
"RTN","MPIFDEL",8,0)
 ; EXC^RGHLLOG   - IA #2796
"RTN","MPIFDEL",9,0)
 ; STOP^RGHLLOG  - IA #2796
"RTN","MPIFDEL",10,0)
 ; $$DELALLTF^VAFCTFU  - IA #2988
"RTN","MPIFDEL",11,0)
 ; $$EN^VAFCPID  - IA #3015
"RTN","MPIFDEL",12,0)
 ;
"RTN","MPIFDEL",13,0)
INTER ;
"RTN","MPIFDEL",14,0)
 ;Entry point for Inactivate Patient from MPI option [MPIF PAT INACT]
"RTN","MPIFDEL",15,0)
 ;No input or output variables ^DPT
"RTN","MPIFDEL",16,0)
 N DIC,DA,DFN,HL,ERROR,CNT,HLRST,ICN,DATE,MPIFCMOR,DTOUT,DUTOUT
"RTN","MPIFDEL",17,0)
 S ERROR=""
"RTN","MPIFDEL",18,0)
 S DIC=2,DIC(0)="QEAM" D ^DIC Q:+Y<0  S DFN=+Y
"RTN","MPIFDEL",19,0)
 S ICN=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFDEL",20,0)
 I ICN=""!(ICN=-1) W !,"** Patient Does NOT have an ICN **" Q
"RTN","MPIFDEL",21,0)
 S MPIFCMOR=+$$LKUP^XUAF4(+$$GETVCCI^MPIF001(DFN))
"RTN","MPIFDEL",22,0)
 I MPIFCMOR=0 W !,"*** Could NOT Inactivate Patient from MPI: Coordinating Master of Record is Not Defined ***" Q
"RTN","MPIFDEL",23,0)
 I $$PAT^MPIFNQ(DFN)'=+$P($$SITE^VASITE,"^",3) W !,"*** Could NOT Inactivate Patient from MPI: Coordinating Master of record site is '"_$$CMOR2^MPIF001(DFN)_"'. You MUST be the CMOR ***" Q
"RTN","MPIFDEL",24,0)
 S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFDEL",25,0)
 ;ask user if they are sure
"RTN","MPIFDEL",26,0)
 N DIR,Y S DIR(0)="Y",DIR("B")="No"
"RTN","MPIFDEL",27,0)
 S DIR("A")="Are you sure you want to Inactivate this Patient?"
"RTN","MPIFDEL",28,0)
 D ^DIR
"RTN","MPIFDEL",29,0)
 K DIR
"RTN","MPIFDEL",30,0)
 Q:$D(DTOUT)!($D(DUTOUT))!('Y)
"RTN","MPIFDEL",31,0)
 D HL7(DFN,.ERROR)
"RTN","MPIFDEL",32,0)
 I ERROR="" D DELETE(DFN) S ERROR=$$DELALLTF^VAFCTFU(+ICN),ERROR=""
"RTN","MPIFDEL",33,0)
 I ERROR=""!(ERROR=0) W !,"*** Inactivated on YOUR system, message sent to MPI to Inactivate ***"
"RTN","MPIFDEL",34,0)
 I ERROR'="" W !,"Error Occurred - "_ERROR
"RTN","MPIFDEL",35,0)
 Q
"RTN","MPIFDEL",36,0)
 ;
"RTN","MPIFDEL",37,0)
HL7(DFN,ERROR) ; create HL7 message
"RTN","MPIFDEL",38,0)
 ; check if no subscribers
"RTN","MPIFDEL",39,0)
 N SUB,HL,CNT,ICN,%,HLDATE
"RTN","MPIFDEL",40,0)
 K HLL
"RTN","MPIFDEL",41,0)
 Q:$E($$GETICN^MPIF001(DFN),1,3)=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFDEL",42,0)
 ; ^ don't generate HL7 message if local ICN
"RTN","MPIFDEL",43,0)
 S SUB=$P($G(^DPT(DFN,"MPI")),"^",5)
"RTN","MPIFDEL",44,0)
 I SUB'="" D GET^HLSUB(SUB,"","MPIF A29 SERVER",.HLL) I $D(HLL) S ERROR="Attempted to Inactivate an ICN and Patient is Shared.  Can't Inactivate patient DFN= "_DFN Q
"RTN","MPIFDEL",45,0)
 S ICN=+$$ICN^MPIFNQ(DFN)
"RTN","MPIFDEL",46,0)
 D NOW^%DTC S HLDATE=$$HLDATE^HLFNC(%,"DT")
"RTN","MPIFDEL",47,0)
 S HL=0,CNT=0
"RTN","MPIFDEL",48,0)
 D INIT^HLFNC2("MPIF A29 SERVER",.HL)
"RTN","MPIFDEL",49,0)
 I HL S ERROR="ERROR = "_HL_" During INIT^HLFNC2 for MPIF A29 Server for Patient DFN= "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",50,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A29"_HL("FS")_HLDATE_HL("FS")_HL("FS")_""_HL("FS")
"RTN","MPIFDEL",51,0)
 S CNT=CNT+1,HLA("HLS",CNT)=$$EN^VAFCPID(DFN,"2,3,5")
"RTN","MPIFDEL",52,0)
 ; message only goes to MPI Link
"RTN","MPIFDEL",53,0)
 D GENERATE^HLMA("MPIF A29 SERVER","LM",1,.HLRST,"",.HL)
"RTN","MPIFDEL",54,0)
 I 'HLRST S ERROR="Error During Generate for MPIF A29 Server Error= "_HLRST_" for dfn "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",55,0)
 Q
"RTN","MPIFDEL",56,0)
 ;
"RTN","MPIFDEL",57,0)
PAT1 ;entry point for tasked job from .01 in Patient file for ZZ patients
"RTN","MPIFDEL",58,0)
 N ERR
"RTN","MPIFDEL",59,0)
 S ERR=""
"RTN","MPIFDEL",60,0)
 D PAT(DA,.ERR)
"RTN","MPIFDEL",61,0)
 S ZTREQ="@"
"RTN","MPIFDEL",62,0)
 Q
"RTN","MPIFDEL",63,0)
 ;
"RTN","MPIFDEL",64,0)
PAT(DFN,ERROR) ;Programmer API to Delete MPI entry and remove ICN data from DPT
"RTN","MPIFDEL",65,0)
 ; if CMOR not defined but is a local CMOR, inactivate and don't log exception
"RTN","MPIFDEL",66,0)
 S ERROR=""
"RTN","MPIFDEL",67,0)
 I $G(DFN)="" S ERROR="DFN not defined" Q
"RTN","MPIFDEL",68,0)
 I $E($P($$GETICN^MPIF001(DFN),"^"),1,3)'=+$P($$SITE^VASITE,"^",3),+$$PAT^MPIFNQ(DFN)'=+$P($$SITE^VASITE,"^",3) S ERROR="Attempt to Inactivate Patient, DFN= "_DFN_" this site is not the CMOR for this patient" D EXC(DFN,ERROR,226) Q
"RTN","MPIFDEL",69,0)
 D HL7(DFN,.ERROR)
"RTN","MPIFDEL",70,0)
 I ERROR="" S ERROR=$$DELALLTF^VAFCTFU(+$$GETICN^MPIF001(DFN)),ERROR="" D DELETE(DFN)
"RTN","MPIFDEL",71,0)
 Q
"RTN","MPIFDEL",72,0)
DELETE(DFN) ;
"RTN","MPIFDEL",73,0)
 N ARRAY,TMP
"RTN","MPIFDEL",74,0)
 S ARRAY(991.01)="@",ARRAY(991.02)="@",ARRAY(991.03)="@",ARRAY(991.04)="@",ARRAY(991.05)="@"
"RTN","MPIFDEL",75,0)
 S ARR="ARRAY"
"RTN","MPIFDEL",76,0)
 S TMP=$$UPDATE^MPIFAPI(DFN,ARR)
"RTN","MPIFDEL",77,0)
 K ARR
"RTN","MPIFDEL",78,0)
 Q
"RTN","MPIFDEL",79,0)
 ;
"RTN","MPIFDEL",80,0)
EXC(DFN,ERROR,TYPE) ; subscribers, log exception
"RTN","MPIFDEL",81,0)
 D START^RGHLLOG(0)
"RTN","MPIFDEL",82,0)
 D EXC^RGHLLOG(TYPE,ERROR,$G(DFN))
"RTN","MPIFDEL",83,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFDEL",84,0)
 Q
"RTN","MPIFDEL",85,0)
 ;
"RTN","MPIFDEL",86,0)
ZZSET(DA,NAME) ;this entry point checks to see if .01 of Patient file entry
"RTN","MPIFDEL",87,0)
 ;starts with at least two Zs
"RTN","MPIFDEL",88,0)
 ;if it does and an ICN is present, it will be inactivated
"RTN","MPIFDEL",89,0)
 ;
"RTN","MPIFDEL",90,0)
 Q:$E(NAME,1,2)'="ZZ"
"RTN","MPIFDEL",91,0)
 ;task inactivation off
"RTN","MPIFDEL",92,0)
 I +$$GETICN^MPIF001(DA)>0 D
"RTN","MPIFDEL",93,0)
 .S ZTRTN="PAT1^MPIFDEL",ZTDESC="Inactivate ICN for 'ZZ'd patient"
"RTN","MPIFDEL",94,0)
 .S ZTIO="",ZTSAVE("DA")=DA,ZTSAVE("NAME")=NAME
"RTN","MPIFDEL",95,0)
 .S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFDEL",96,0)
 .D ^%ZTLOAD
"RTN","MPIFDEL",97,0)
 .K ZTRTN,ZTDESC,ZTIO,ZTSAVE,ZTDTH,ZTREQ
"RTN","MPIFDEL",98,0)
 Q
"RTN","MPIFDEL",99,0)
ZZKILL(DA,NAME) ;This entry point checks if there is an ICN present, if so
"RTN","MPIFDEL",100,0)
 ;if will be inactivated, following the inactivate rules
"RTN","MPIFDEL",101,0)
 N ERR S ERR=""
"RTN","MPIFDEL",102,0)
 I +$$GETICN^MPIF001(DA)>0 D PAT(DA,.ERR)
"RTN","MPIFDEL",103,0)
 Q
"RTN","MPIFDEL",104,0)
SSET(DA,SSN) ; this entry point checks to see if the SSN has been changed
"RTN","MPIFDEL",105,0)
 ; to 5 leading zeros and if the ICN is present, if so, it will be
"RTN","MPIFDEL",106,0)
 ; inactivated.
"RTN","MPIFDEL",107,0)
 Q:$E(SSN,1,5)'="00000"
"RTN","MPIFDEL",108,0)
 I +$$GETICN^MPIF001(DA)>0 D
"RTN","MPIFDEL",109,0)
 .S ZTRTN="PAT1^MPIFDEL",ZTDESC="Inactivate ICN for 'ZZ'd patient"
"RTN","MPIFDEL",110,0)
 .S ZTIO="",ZTSAVE("DA")=DA,ZTSAVE("SSN")="SSN"
"RTN","MPIFDEL",111,0)
 .S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFDEL",112,0)
 .D ^%ZTLOAD
"RTN","MPIFDEL",113,0)
 .K ZTRTN,ZTDESC,ZTIO,ZTSAVE,ZTDTH,ZTREQ
"RTN","MPIFDEL",114,0)
 Q
"RTN","MPIFMER")
0^11^B2698614
"RTN","MPIFMER",1,0)
MPIFMER ;SF/MJM,CMC-Merge patient ICN ;JUL 14, 1998
"RTN","MPIFMER",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**9,21**;30 Apr 99
"RTN","MPIFMER",3,0)
 ;
"RTN","MPIFMER",4,0)
 ; *** THIS ROUTINE IS TO BE REPLACED BY THE LINK/UNLINK MESSAGES
"RTN","MPIFMER",5,0)
 ; *** SINCE MESSAGES ARE NOT BEING USED BY ANYONE, PLACING QUIT
"RTN","MPIFMER",6,0)
 ; **** AT ALL ENTRY POINTS.
"RTN","MPIFMER",7,0)
 ;
"RTN","MPIFMER",8,0)
 ;Notify MPI and other TF of change to patient's ICN
"RTN","MPIFMER",9,0)
 ;
"RTN","MPIFMER",10,0)
MER(PDFN,OLD,ERROR,FLG) ;
"RTN","MPIFMER",11,0)
 Q
"RTN","MPIFMER",12,0)
 ;Q:$D(MPIFMER)
"RTN","MPIFMER",13,0)
 ;Q:$E(OLD,1,3)=$E($P($$SITE^VASITE,"^",3),1,3)
"RTN","MPIFMER",14,0)
 ;; ^ LOCAL ICN being resolved don't send to CIRN sites OR MPI
"RTN","MPIFMER",15,0)
 ;; but others may want to know Local Resolved, 
"RTN","MPIFMER",16,0)
 ;;If other want to know resolved look at x-ref on 991.01 field in file 2
"RTN","MPIFMER",17,0)
 ;I '$G(PDFN) S ERROR="DFN VARIABLE UNDEFINED" Q
"RTN","MPIFMER",18,0)
 ;Q:OLD=""
"RTN","MPIFMER",19,0)
 ;I '$D(FLG) S FLG=""
"RTN","MPIFMER",20,0)
 ;I '$D(ERROR) S ERROR=""
"RTN","MPIFMER",21,0)
 ;S ZTRTN="MER2^MPIFMER",ZTDESC="MERGE ICN JOB",ZTIO=""
"RTN","MPIFMER",22,0)
 ;D NOW^%DTC S ZTDTH=% K %,X
"RTN","MPIFMER",23,0)
 ;I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFMER",24,0)
 ;S ZTSAVE("PDFN")=PDFN,ZTSAVE("OLD")=OLD,ZTSAVE("ERROR")=ERROR,ZTSAVE("FLG")=FLG
"RTN","MPIFMER",25,0)
 ;D ^%ZTLOAD
"RTN","MPIFMER",26,0)
 ;K ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","MPIFMER",27,0)
 ;Q
"RTN","MPIFMER",28,0)
MER2 ;
"RTN","MPIFMER",29,0)
 Q
"RTN","MPIFMER",30,0)
 ;N RGLOG,CNT,HLA,HL,RGLINK,HOME,SUB,ICN,TMP,PARENT,RGL,CLIENT,I,TD,X,CMOR,HERE,%
"RTN","MPIFMER",31,0)
 ;Q:$E(OLD,1,3)=$E($P($$SITE^VASITE,"^",3),1,3)
"RTN","MPIFMER",32,0)
 ;; ^ LOCAL ICN being resolved don't send to CIRN sites or MPI
"RTN","MPIFMER",33,0)
 ;; though others may want to know Local has been resolved.
"RTN","MPIFMER",34,0)
 ;;If other want to know resolved look at x-ref on 991.01 field in file 2
"RTN","MPIFMER",35,0)
 ;Q:'$G(PDFN)
"RTN","MPIFMER",36,0)
 ;Q:+$$GETICN^MPIF001(PDFN)<0
"RTN","MPIFMER",37,0)
 ;; ^ If no ICN currently don't send mesg
"RTN","MPIFMER",38,0)
 ;S CNT=0,HL=0,ERROR="",CLIENT="MPIF A30 SERVER"
"RTN","MPIFMER",39,0)
 ;D NOW^%DTC S TD=$$HLDATE^HLFNC(%,"DT")
"RTN","MPIFMER",40,0)
 ;S CMOR=+$$PAT^MPIFNQ(PDFN),HERE=+$$SITE^VASITE()
"RTN","MPIFMER",41,0)
 ;I CMOR'=HERE,FLG="" S ERROR="PATIENT'S CMOR MUST BE THIS FACILITY" D EXC^MPIFDEL(PDFN,ERROR,226) Q
"RTN","MPIFMER",42,0)
 ;D INIT^HLFNC2(CLIENT,.HL)
"RTN","MPIFMER",43,0)
 ;I HL S ERROR=HL D EXC^MPIFDEL(PDFN,ERROR,220) Q
"RTN","MPIFMER",44,0)
 ;S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A30"_HL("FS")_TD_HL("FS")_HL("FS")_HL("FS")
"RTN","MPIFMER",45,0)
 ;S CNT=CNT+1,HLA("HLS",CNT)=$$EN^VAFCPID(PDFN,"1,2,3,4,5,6,7,8,10,13,14,17,19,11")
"RTN","MPIFMER",46,0)
 ;S CNT=CNT+1,HLA("HLS",CNT)="MRG"_HL("FS")_OLD
"RTN","MPIFMER",47,0)
 ;D GENERATE^HLMA(CLIENT,"LM",1,.HLRST,"",.HL)
"RTN","MPIFMER",48,0)
 ;I 'HLRST S ERROR=HLRST D EXC^MPIFDEL(PDFN,ERROR,220)
"RTN","MPIFMER",49,0)
 ;Q
"RTN","MPIFMER",50,0)
LINKS ; gets links to send messages to, including mpi
"RTN","MPIFMER",51,0)
 ; Currently only the MPI will get Change ICN msgs.
"RTN","MPIFMER",52,0)
 Q
"RTN","MPIFMER",53,0)
 ;N SUB,MPI
"RTN","MPIFMER",54,0)
 ;Q:$P($$GETICN^MPIF001(PDFN),1,3)=$P($$SITE^VASITE(),3)
"RTN","MPIFMER",55,0)
 ;S SUB=$P($G(^DPT(PDFN,"MPI")),"^",5)
"RTN","MPIFMER",56,0)
 ;I SUB'="" D GET^HLSUB(SUB,0,"MPIF A30",.HLL)
"RTN","MPIFMER",57,0)
 ;S MPI=$$MPILINK^MPIFAPI() D
"RTN","MPIFMER",58,0)
 ;.I $P($G(MPI),U)'=-1 S HLL("LINKS",999)="MPIF A30"_"^"_MPI
"RTN","MPIFMER",59,0)
 ;.I $P($G(MPI),U)=-1 N RGLOG D START^RGHLLOG(HLMTIEN,"","") D EXC^RGHLLOG(224,"No MPI link defined in CIRN Site Parameter file") D STOP^RGHLLOG(0)
"RTN","MPIFMER",60,0)
 ;Q
"RTN","MPIFMER",61,0)
 ;
"RTN","MPIFMER",62,0)
IN ;process inbound Merge ICN Message - currently not used.
"RTN","MPIFMER",63,0)
 Q
"RTN","MPIFMER",64,0)
 ;N I,CNT,NODE,SENDER,NEWICN,OLDICN,PDFN,CMOR,ERR,DA,DIE,DR,SEP,CHK
"RTN","MPIFMER",65,0)
 ;K ^XTMP($J,"MPIFMER")
"RTN","MPIFMER",66,0)
 ;; get message
"RTN","MPIFMER",67,0)
 ;F I=1:1 X HLNEXT Q:HLQUIT'>0  S ^XTMP($J,"MPIFMER","IN",I)=HLNODE
"RTN","MPIFMER",68,0)
 ;; ^XTMP($J,"MPIFMER","IN",I look for data
"RTN","MPIFMER",69,0)
 ;S CNT=0
"RTN","MPIFMER",70,0)
 ;F  S CNT=$O(^XTMP($J,"MPIFMER","IN",CNT)) Q:CNT=""  D
"RTN","MPIFMER",71,0)
 ;.S NODE=$G(^XTMP($J,"MPIFMER","IN",CNT))
"RTN","MPIFMER",72,0)
 ;.I $E(NODE,1,3)="MSH" S SEP=$E(NODE,4),SENDER=$P(NODE,SEP,4) Q:'$D(SEP)
"RTN","MPIFMER",73,0)
 ;.I $P(NODE,SEP)="EVN" Q:$P(NODE,SEP,2)'="A30"
"RTN","MPIFMER",74,0)
 ;.I $P(NODE,SEP)="PID" S NEWICN=+$P(NODE,SEP,3),CHK=$P($P(NODE,SEP,3),"V",2) Q:NEWICN=""
"RTN","MPIFMER",75,0)
 ;.I $P(NODE,SEP)="MRG" S OLDICN=+$P(NODE,SEP,2) Q:OLDICN=""
"RTN","MPIFMER",76,0)
 ;;
"RTN","MPIFMER",77,0)
 ;Q:'$D(OLDICN)
"RTN","MPIFMER",78,0)
 ;Q:'$D(^DPT("AICN",OLDICN))
"RTN","MPIFMER",79,0)
 ;; ^ old icn not at site
"RTN","MPIFMER",80,0)
 ;S PDFN=""
"RTN","MPIFMER",81,0)
 ;F  S PDFN=$O(^DPT("AICN",OLDICN,PDFN)) Q:PDFN=""  D
"RTN","MPIFMER",82,0)
 ;.; incase have multiple OLD-ICNs
"RTN","MPIFMER",83,0)
 ;.S CMOR=$$PAT^MPIFNQ(PDFN)
"RTN","MPIFMER",84,0)
 ;.I CMOR'=SENDER S ERR="MERGE ICN MESSAGE DID NOT COME FROM CMOR for Patient dfn="_PDFN D EXC^MPIFDEL(PDFN,ERR,226) Q
"RTN","MPIFMER",85,0)
 ;.K DA,DIE,DR
"RTN","MPIFMER",86,0)
 ;.S DA=PDFN,DIE="^DPT(",DR="991.01////"_NEWICN_";991.02////"_CHK,MPIFMER=""
"RTN","MPIFMER",87,0)
 ;.D ^DIE K MPIFMER
"RTN","MPIFMER",88,0)
 ;Q
"RTN","MPIFQ0")
0^4^B73563972
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,14,13,16,17,21**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
 ; Integration Agreements utilized:
"RTN","MPIFQ0",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFQ0",6,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFQ0",7,0)
 ;  $$SEND2^VAFCUTL1- #2779
"RTN","MPIFQ0",8,0)
 ;  $$SEND^RGJUSITE - #3469
"RTN","MPIFQ0",9,0)
 ;  $$EN^HLCSAS - #3471
"RTN","MPIFQ0",10,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFQ0",11,0)
 ;
"RTN","MPIFQ0",12,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",13,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",14,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",15,0)
 S MPIFRES="",MPIFINT="",DIC="^DPT(",DIC(0)="AEMQ" D ^DIC
"RTN","MPIFQ0",16,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",17,0)
 S DFN=+Y,HLP("ACKTIME")=300
"RTN","MPIFQ0",18,0)
 W !
"RTN","MPIFQ0",19,0)
CIRNEXC ; Exception Entry Point
"RTN","MPIFQ0",20,0)
 I $$SEND^RGJUSITE'>0 W !,"MPI/PD Messaging Parameter Not Enabled" G END
"RTN","MPIFQ0",21,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",22,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",23,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",24,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",25,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N W !,"Patient is missing Date of Birth -- Required Field" D LOCAL(DFN) G END
"RTN","MPIFQ0",26,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",27,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",28,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 W !,"Patient should not be sent to the MPI -- SSN has 5 leading 0s or name has been ZZ'd" G END
"RTN","MPIFQ0",29,0)
 I $E(LOCDATA(2,DFN,.01),1,3)="EEE" W !,"Patient should not be sent to the MPI -- EEE patient -- update to actual Patient name" G END
"RTN","MPIFQ0",30,0)
 S HLP("ACKTIME")=300,MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",31,0)
 G JUMP
"RTN","MPIFQ0",32,0)
VTQ G:$G(DFN)']"" END
"RTN","MPIFQ0",33,0)
 I $$SEND^RGJUSITE'>0 S MPIFRTN="STOP/SUSPEND" G END
"RTN","MPIFQ0",34,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",35,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",36,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",37,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S MPIFRTN="MISSING DOB" D EXC^MPIFVTQ(DFN) G END
"RTN","MPIFQ0",38,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",39,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",40,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S MPIFRTN="TEST" G END
"RTN","MPIFQ0",41,0)
JUMP N TIME,% D NOW^%DTC S TIME=%
"RTN","MPIFQ0",42,0)
 ;Initialization for call to MPIVTQ
"RTN","MPIFQ0",43,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,MPIDC
"RTN","MPIFQ0",44,0)
 I $G(HLP("ACKTIME"))="" S HLP("ACKTIME")=30 ;If the HLP("ACKTIME") is not already set for the D/C
"RTN","MPIFQ0",45,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",46,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",47,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",48,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM,"00108.1;00108.2;00110;00122")
"RTN","MPIFQ0",49,0)
 ;If call to VTQ1^MPIFVTQ returns '-1^error code', log error and exit
"RTN","MPIFQ0",50,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",51,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0)),MPIFRTN="CONTINUE"
"RTN","MPIFQ0",52,0)
 . I '$D(MPIFS) W !!,"Patient should NOT be sent to the MPI for ICN assignment"
"RTN","MPIFQ0",53,0)
 ;Create MSH
"RTN","MPIFQ0",54,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1,HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",55,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",56,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",57,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFQ0",58,0)
 I '$D(MPIFS) W !!,"Attempting to connect to the Master Patient Index in Austin...",!,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFQ0",59,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFQ0",60,0)
 K HLP("ACKTIME") ;kill the HLP array set for the ack timeout
"RTN","MPIFQ0",61,0)
 ;Can't connect to MPI, assign a local ICN, this site as CMOR, and continue with Registration
"RTN","MPIFQ0",62,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",63,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",64,0)
 . I '$D(MPIFS) W !!,"Could not connect to MPI or Timed Out, assigning local ICN (if not already assigned)..."
"RTN","MPIFQ0",65,0)
 . D LOCAL(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",66,0)
 K ^TMP("MPIFQ0",$J) ;this is the array the data is parsed into for display in list manager
"RTN","MPIFQ0",67,0)
INIPARS N SEG,INDEX,COUNTER,LASTSSN,FIRST
"RTN","MPIFQ0",68,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFQ0",69,0)
PARSE S SEG=$$SEG^MPIFAPI("RDT",1,"RDT")
"RTN","MPIFQ0",70,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFQ0",71,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,STRING,NAME,TF,ICN,HEREICN,HERESSN,MIDDLE,IEN,F,SUFF,SEX
"RTN","MPIFQ0",72,0)
 . S STRING="",FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2),MIDDLE=$P(SEG,HL("FS"),10),SUFF=$P(SEG,HL("FS"),15)
"RTN","MPIFQ0",73,0)
 . S (LASTSSN,SSN)=$P(SEG,HL("FS"),3),NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFQ0",74,0)
 . I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFQ0",75,0)
 . I SUFF'="" S NAME=NAME_" "_SUFF
"RTN","MPIFQ0",76,0)
 . S SEX=$P(SEG,HL("FS"),11)
"RTN","MPIFQ0",77,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFQ0",78,0)
 . I $D(FICN) I FICN'=ICN S FIRST=1,FICN=ICN
"RTN","MPIFQ0",79,0)
 . I FIRST=1 S FICN=ICN
"RTN","MPIFQ0",80,0)
 . S FIRST=FIRST+1,CMOR=$P(SEG,HL("FS"),5),CCMOR=CMOR
"RTN","MPIFQ0",81,0)
 . I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",82,0)
 . S TF=$P(SEG,HL("FS"),8)
"RTN","MPIFQ0",83,0)
 . I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",84,0)
 . ;Same patient just adding TF's
"RTN","MPIFQ0",85,0)
 . I TF'="",ICN=FICN,FIRST'=2 S COUNTER=COUNTER+1,^TMP("MPIFQ0",$J,INDEX,COUNTER)=TF_"^"_IEN
"RTN","MPIFQ0",86,0)
 . Q:(ICN=FICN)&(FIRST>2)
"RTN","MPIFQ0",87,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFQ0",88,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFQ0",89,0)
 . I $G(BIRTHDAY)]"" S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY),BIRTHDAY=$TR($$FMTE^XLFDT(BIRTHDAY,"5D"),"/","-")
"RTN","MPIFQ0",90,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFQ0",91,0)
 . S INDEX=INDEX+1,COUNTER=1,HEREICN=$$HEREICN($P(ICN,"V",1))
"RTN","MPIFQ0",92,0)
 . I HEREICN S STRING=$$SETSTR^VALM1("*",STRING,1,1),^TMP("MPIFQ0",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",93,0)
 . S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4),STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",94,0)
 . S STRING=$$SETSTR^VALM1(SSN,STRING,30,9),STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",95,0)
 . S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",96,0)
 . S ^TMP("MPIFQ0",$J,INDEX,0)=STRING,^TMP("MPIFQ0",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",97,0)
 . S ^TMP("MPIFQ0",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_CCMOR_"^"_SEX
"RTN","MPIFQ0",98,0)
 . S (VALMCNT,VALMLST)=INDEX
"RTN","MPIFQ0",99,0)
 . S ^TMP("MPIFQ0",$J,INDEX,"HOLD")=SEG
"RTN","MPIFQ0",100,0)
DECIDE ;If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFQ0",101,0)
 ;with the VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",102,0)
 I '$D(^TMP("MPIFQ0",$J)) D  G EXIT
"RTN","MPIFQ0",103,0)
 . I '$D(MPIFS) W !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",104,0)
 . D A28(DFN) S MPIFRTN="DID A28"
"RTN","MPIFQ0",105,0)
 ;If INDEX=1 it means we got 1 match. So we check the SSN to see if it's definitely the same patient.
"RTN","MPIFQ0",106,0)
 I (INDEX=1)&(TSSN=LASTSSN) D  G EXIT
"RTN","MPIFQ0",107,0)
 . N CMOR,ICN,DATA,TICN,SNM,SNM2
"RTN","MPIFQ0",108,0)
 . S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA"),CMOR=CCMOR,ICN=$P(DATA,"^",4)
"RTN","MPIFQ0",109,0)
 . D START^RGHLLOG(0)
"RTN","MPIFQ0",110,0)
 . S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",111,0)
 . I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ0",112,0)
 . I TICN>0&(DFN'=TICN)
"RTN","MPIFQ0",113,0)
 . ; CHECK IF NAME IS SAME - IF NOT POTENTIAL MATCH EXCEPTION
"RTN","MPIFQ0",114,0)
 . S SNM=LOCDATA(2,DFN,.01) D NAME^VAFCPID2(DFN,.SNM,0) ;reformat name to DG 149 standard
"RTN","MPIFQ0",115,0)
 . S SNM2=$P(DATA,"^") D NAME^VAFCPID2(0,.SNM2,0) S $P(DATA,"^")=SNM2
"RTN","MPIFQ0",116,0)
 . I $P(DATA,"^")'=SNM D  Q
"RTN","MPIFQ0",117,0)
 ..I $D(MPIFINT) D START^MPIFQ1(INDEX) Q
"RTN","MPIFQ0",118,0)
 ..I '$D(MPIFINT) D LOC2(DFN) Q
"RTN","MPIFQ0",119,0)
 . I '$D(MPIFS) W !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" in MPI, updating ICN and CMOR..."
"RTN","MPIFQ0",120,0)
 . D STOP^RGHLLOG(0),UPDATE(DFN,ICN,CMOR)
"RTN","MPIFQ0",121,0)
 . S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",122,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",123,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",124,0)
 .I '$D(MPIFS) W !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",125,0)
 .D START^RGHLLOG(0),EXC^RGHLLOG(218,"For Patient DFN="_DFN_".  Use Single Patient Initialization to MPI option to manually process.",DFN),STOP^RGHLLOG(0)
"RTN","MPIFQ0",126,0)
 .D LOCAL(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",127,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",128,0)
EXIT ;
"RTN","MPIFQ0",129,0)
 I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",130,0)
 K VALMCNT,VALMLST
"RTN","MPIFQ0",131,0)
 K CCMOR,FICN H 3 W !!
"RTN","MPIFQ0",132,0)
END ;
"RTN","MPIFQ0",133,0)
 ;;;K VALMCNT,VALMLST
"RTN","MPIFQ0",134,0)
 Q
"RTN","MPIFQ0",135,0)
A28(DFN) ;
"RTN","MPIFQ0",136,0)
 S ICN=$$GETICN^MPIFRTC(DFN)
"RTN","MPIFQ0",137,0)
 I +ICN>0 I '$D(MPIFS) W !!,"Adding Patient to Master Patient Index..." Q
"RTN","MPIFQ0",138,0)
 I '$D(MPIFS) W !!,"Could not connect to MPI, Assigning Local ICN..."
"RTN","MPIFQ0",139,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",140,0)
 Q
"RTN","MPIFQ0",141,0)
UPDATE(DFN,ICN,CMOR) ;
"RTN","MPIFQ0",142,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG,LOCAL
"RTN","MPIFQ0",143,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",144,0)
 S CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",145,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",146,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",147,0)
 I +SETICN'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0" Q
"RTN","MPIFQ0",148,0)
 S SETLOC=1,LOCAL="N"
"RTN","MPIFQ0",149,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",150,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",151,0)
 I +SETLOC'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0" Q
"RTN","MPIFQ0",152,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",153,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",154,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",155,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFQ0",156,0)
 I +CHANGE'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0" Q
"RTN","MPIFQ0",157,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",158,0)
 N HERE S HERE=+$P($$SITE^VASITE,"^",3) D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ0",159,0)
 Q
"RTN","MPIFQ0",160,0)
LOCAL(DFN) ;
"RTN","MPIFQ0",161,0)
 N ICN
"RTN","MPIFQ0",162,0)
 Q:+$$GETICN^MPIF001(DFN)>0
"RTN","MPIFQ0",163,0)
 S ICN=$$ICNLC^MPIF001(DFN) ;don't assign local if one already exists
"RTN","MPIFQ0",164,0)
 Q
"RTN","MPIFQ0",165,0)
HEREICN(ICN) ;
"RTN","MPIFQ0",166,0)
 N DFN
"RTN","MPIFQ0",167,0)
 Q:$G(ICN)="" 0
"RTN","MPIFQ0",168,0)
 S DFN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",169,0)
 Q:$G(DFN)'>0 0
"RTN","MPIFQ0",170,0)
 Q DFN
"RTN","MPIFQ0",171,0)
GETDATA(DIC,DA,MPIFAR,DR,EI) ;
"RTN","MPIFQ0",172,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",173,0)
 ;DIC is the file reference, DA is the file entry IEN, ARRAY is the
"RTN","MPIFQ0",174,0)
 ;storage array for the values to be stored in, DR are the fields
"RTN","MPIFQ0",175,0)
 ;requested, EI is external/internal values of the fields or don't
"RTN","MPIFQ0",176,0)
 ;return null values
"RTN","MPIFQ0",177,0)
 N DIQ S DIQ=MPIFAR
"RTN","MPIFQ0",178,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",179,0)
 D EN^DIQ1
"RTN","MPIFQ0",180,0)
 Q
"RTN","MPIFQ0",181,0)
LOC2(DFN) ;
"RTN","MPIFQ0",182,0)
 W !!,"Potential Match Found Assigning Local ICN"
"RTN","MPIFQ0",183,0)
 D START^RGHLLOG(),EXC^RGHLLOG(218,"For Patient DFN="_DFN_" Use Single Patient Initialization to MPI option to manually process",DFN),STOP^RGHLLOG()
"RTN","MPIFQ0",184,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",185,0)
 Q
"RTN","MPIFQ1")
0^3^B93899325
"RTN","MPIFQ1",1,0)
MPIFQ1 ;ALB/RJS-CIRN QUERY HANDLER ;JUN 30, 1997
"RTN","MPIFQ1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,8,12,16,17,21**;30 Apr 99
"RTN","MPIFQ1",3,0)
 ;
"RTN","MPIFQ1",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFQ1",5,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFQ1",6,0)
 ;   FILE^VAFCTFU - #2988
"RTN","MPIFQ1",7,0)
 ;   ^DPT("AICN" - #2070
"RTN","MPIFQ1",8,0)
 ;   NAME^VAFCPID2 - #3492
"RTN","MPIFQ1",9,0)
 ;   EN1^XWB2HL7 - #3144
"RTN","MPIFQ1",10,0)
 ;   RTNDATA^XWBDRPC - #3149
"RTN","MPIFQ1",11,0)
 ;   VAFC REMOTE PDAT (RPC) - #3496
"RTN","MPIFQ1",12,0)
 ;
"RTN","MPIFQ1",13,0)
INIT ;Entry point for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",14,0)
 ; It is started from outside of the template.
"RTN","MPIFQ1",15,0)
 Q
"RTN","MPIFQ1",16,0)
HDR ;Header code for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",17,0)
 N SSN,DOB,MPIFQ1,NAME1,SEX
"RTN","MPIFQ1",18,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.03;.09;.02","EI")
"RTN","MPIFQ1",19,0)
 S NAME1=$G(MPIFQ1(2,DFN,.01,"E"))
"RTN","MPIFQ1",20,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E"))
"RTN","MPIFQ1",21,0)
 S DOB=$G(MPIFQ1(2,DFN,.03,"I"))
"RTN","MPIFQ1",22,0)
 S SEX=$G(MPIFQ1(2,DFN,.02,"E"))
"RTN","MPIFQ1",23,0)
 I DOB]"" S DOB=$TR($$FMTE^XLFDT(DOB,"5D"),"/","-")
"RTN","MPIFQ1",24,0)
 S VALMHDR(1)=" Possible MPI Matches for Patient: "_IOINHI_NAME1_IOINORM
"RTN","MPIFQ1",25,0)
 S VALMHDR(2)="                              SSN: "_IOINHI_SSN_IOINORM
"RTN","MPIFQ1",26,0)
 S VALMHDR(3)="                              DOB: "_IOINHI_DOB_IOINORM
"RTN","MPIFQ1",27,0)
 S VALMHDR(4)="                              SEX: "_IOINHI_SEX_IOINORM
"RTN","MPIFQ1",28,0)
 S VALMHDR(5)=" "
"RTN","MPIFQ1",29,0)
 Q
"RTN","MPIFQ1",30,0)
START(INDEX) ;
"RTN","MPIFQ1",31,0)
 ;Starting entry point for envoking the List Manager Template MPIF Real-time query
"RTN","MPIFQ1",32,0)
 S VALMCNT=INDEX
"RTN","MPIFQ1",33,0)
 D EN^VALM("MPIF REAL-TIME QUERY")
"RTN","MPIFQ1",34,0)
 Q
"RTN","MPIFQ1",35,0)
SELECT ;
"RTN","MPIFQ1",36,0)
 N VALMY
"RTN","MPIFQ1",37,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",38,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",39,0)
 N DATA,INDEX,ICN,CHKSUM,NODE2,HERESSN
"RTN","MPIFQ1",40,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",41,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ1",42,0)
 S NODE2=$G(^TMP("MPIFQ0",$J,INDEX,"INDICATOR"))
"RTN","MPIFQ1",43,0)
 S DATA(.01)=$P(DATA,"^",1) I $E(DATA(.01),$L(DATA(.01)))=" " S DATA(.01)=$E(DATA(.01),1,$L(DATA(.01))-1) ;NAME
"RTN","MPIFQ1",44,0)
 S DATA(.03)=$P(DATA,"^",3) ;DOB
"RTN","MPIFQ1",45,0)
 S DATA(.09)=$P(DATA,"^",2) ;SSN
"RTN","MPIFQ1",46,0)
 S DATA(.02)=$P(DATA,"^",8) ;SEX
"RTN","MPIFQ1",47,0)
 S ICN=$P(DATA,"^",4)
"RTN","MPIFQ1",48,0)
 S CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ1",49,0)
 S ICN=$P(ICN,"V",1) ;ICN
"RTN","MPIFQ1",50,0)
 S DATA(991.01)=ICN
"RTN","MPIFQ1",51,0)
 S DATA(991.02)=CHKSUM ;CHKSUM
"RTN","MPIFQ1",52,0)
 S DATA(991.03)=$$LKUP^XUAF4($P(DATA,"^",7)) ;CMOR
"RTN","MPIFQ1",53,0)
 ;
"RTN","MPIFQ1",54,0)
 ;If NODE2["*" it means we got a match on ICN for a patient in our
"RTN","MPIFQ1",55,0)
 ;list, with a patient in our local database. Since we don't allow more 
"RTN","MPIFQ1",56,0)
 ;than one patient to have the same ICN, we log an Exception and assign 
"RTN","MPIFQ1",57,0)
 ;a Local ICN for this patient.
"RTN","MPIFQ1",58,0)
 ;
"RTN","MPIFQ1",59,0)
 I NODE2["*",$O(^DPT("AICN",ICN,""))'=DFN D  Q
"RTN","MPIFQ1",60,0)
 . D CLEAR^VALM1
"RTN","MPIFQ1",61,0)
 . D MSG1
"RTN","MPIFQ1",62,0)
 . D START^RGHLLOG()
"RTN","MPIFQ1",63,0)
 . D EXC^RGHLLOG(227,"Attempted to assign same ICN to Patient DFN "_DFN_". ICN is already used for Name: "_DATA(.01)_" SSN: "_DATA(.09)_" DOB: "_DATA(.03)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ1",64,0)
 . D STOP^RGHLLOG(0)
"RTN","MPIFQ1",65,0)
 . W !!,"Assigning Local ICN"
"RTN","MPIFQ1",66,0)
 . D LOCAL^MPIFQ0(DFN)
"RTN","MPIFQ1",67,0)
 . D PROMPT
"RTN","MPIFQ1",68,0)
 . S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",69,0)
 ;
"RTN","MPIFQ1",70,0)
 ;User selected one from the list that doesn't exist already in this
"RTN","MPIFQ1",71,0)
 ; Patient file. 
"RTN","MPIFQ1",72,0)
 ;Does SSN and Name match?  If no - ask if they are sure before 
"RTN","MPIFQ1",73,0)
 ;updating ICN and CMOR fields
"RTN","MPIFQ1",74,0)
 ;
"RTN","MPIFQ1",75,0)
 N SSN,NAME,SEX
"RTN","MPIFQ1",76,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.09;.02","EI")
"RTN","MPIFQ1",77,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E")),NAME=$G(MPIFQ1(2,DFN,.01,"E"))
"RTN","MPIFQ1",78,0)
 S SEX=$G(MPIFQ1(2,DFN,.02,"I"))
"RTN","MPIFQ1",79,0)
 ; if sex doesn't match -- not allowed to update ICN
"RTN","MPIFQ1",80,0)
 I DATA(.02)'=SEX W !!,"Sex for these two patients doesn't match -- Can't select this patient until",!,"Sex matches between the MPI and your site.  No action will be taken." D PROMPT S VALMBCK="R" Q
"RTN","MPIFQ1",81,0)
 I SSN["P" S SSN=""
"RTN","MPIFQ1",82,0)
 I DATA(.09)'=SSN W !!,"SSN for these two patients doesn't match -- Can't select this patient until",!,"SSN matches between the MPI and your site.  No action will be taken." D PROMPT S VALMBCK="R" Q
"RTN","MPIFQ1",83,0)
 ;Name, SSN and Sex match on site and MPI -- Update ICN and CMOR
"RTN","MPIFQ1",84,0)
 D NAME^VAFCPID2(0,.NAME,0) ;reformat name into DG 149 format
"RTN","MPIFQ1",85,0)
 N NAME3 S NAME3=DATA(.01)
"RTN","MPIFQ1",86,0)
 D NAME^VAFCPID2(0,.NAME3,0) S DATA(.01)=NAME3 ;reformat name into DG 149 format
"RTN","MPIFQ1",87,0)
 I DATA(.01)=NAME K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") D MSG3,PROMPT,TF(DFN,.DATA) Q
"RTN","MPIFQ1",88,0)
 ;
"RTN","MPIFQ1",89,0)
 ;Name doesn't match exactly - ask if sure
"RTN","MPIFQ1",90,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",91,0)
 D MSG2
"RTN","MPIFQ1",92,0)
 D MSG(SSN,NAME,DATA(.09),DATA(.01))
"RTN","MPIFQ1",93,0)
 N ANS
"RTN","MPIFQ1",94,0)
 S ANS=$$PROMPT1()
"RTN","MPIFQ1",95,0)
 I ANS K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") S MPIFRTN="CONTINUE" W !!,"ICN and CMOR Updated" D PROMPT,TF(DFN,.DATA) Q
"RTN","MPIFQ1",96,0)
 D MSG5,PROMPT
"RTN","MPIFQ1",97,0)
 S VALMBCK="R"
"RTN","MPIFQ1",98,0)
 ;
"RTN","MPIFQ1",99,0)
 Q
"RTN","MPIFQ1",100,0)
 ;
"RTN","MPIFQ1",101,0)
 ;
"RTN","MPIFQ1",102,0)
ADD ;
"RTN","MPIFQ1",103,0)
 ;Add List Manager Action (MPIF REAL-TIME QUERY (ADD PATIENT)) to add
"RTN","MPIFQ1",104,0)
 ; patient to the MPI Austin.
"RTN","MPIFQ1",105,0)
 D A28^MPIFQ0(DFN)
"RTN","MPIFQ1",106,0)
 D MSG3,PROMPT
"RTN","MPIFQ1",107,0)
 S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",108,0)
 Q
"RTN","MPIFQ1",109,0)
 ;
"RTN","MPIFQ1",110,0)
MPIPD ; MPI PDAT CALL
"RTN","MPIFQ1",111,0)
 N VALMY
"RTN","MPIFQ1",112,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",113,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",114,0)
 N DATA,INDEX,ICN,CHKSUM,CMOR,CASE,CMOR3,TTF
"RTN","MPIFQ1",115,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",116,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",117,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"HOLD")
"RTN","MPIFQ1",118,0)
 S CMOR=$P(DATA,HL("FS"),5),CMOR3=CMOR,CMOR=$P($$NS^XUAF4($$LKUP^XUAF4(CMOR)),"^")
"RTN","MPIFQ1",119,0)
 W !,"MPI Data:",!!
"RTN","MPIFQ1",120,0)
 W !,?3,"ICN: ",+$P(DATA,HL("FS"),6),?30,"CMOR: ",CMOR," (",CMOR3,")"
"RTN","MPIFQ1",121,0)
 W !,?2,"NAME: ",$P(DATA,HL("FS"),2)_","_$P(DATA,HL("FS"),7)_" "
"RTN","MPIFQ1",122,0)
 I $P(DATA,HL("FS"),10)'="" W $P(DATA,HL("FS"),10)_" "
"RTN","MPIFQ1",123,0)
 I $P(DATA,HL("FS"),15)'="" W $P(DATA,HL("FS"),15)
"RTN","MPIFQ1",124,0)
 W !,?3,"SSN: ",$P(DATA,HL("FS"),3),?30,"SEX: ",$P(DATA,HL("FS"),11)
"RTN","MPIFQ1",125,0)
 N Y S Y=""
"RTN","MPIFQ1",126,0)
 I $P(DATA,HL("FS"),4)'="" S Y=$$HL7TFM^XLFDT($P(DATA,HL("FS"),4)) D DD^%DT
"RTN","MPIFQ1",127,0)
 W !,?3,"DOB: ",Y
"RTN","MPIFQ1",128,0)
 S Y="" I $P(DATA,HL("FS"),9)'="" S Y=$$HL7TFM^XLFDT($P(DATA,HL("FS"),9)) D DD^%DT
"RTN","MPIFQ1",129,0)
 W ?30,"DOD: ",Y
"RTN","MPIFQ1",130,0)
 I ($P(DATA,HL("FS"),12)='"")&($P(DATA,HL("FS"),13)'="") W !,?2,"PLACE OF BIRTH: ",$P(DATA,HL("FS"),12),", ",$P(DATA,HL("FS"),13)
"RTN","MPIFQ1",131,0)
 I $P(DATA,HL("FS"),12)=""!($P(DATA,HL("FS"),13)="") W !,?2,"PLACE OF BIRTH: ",$P(DATA,HL("FS"),12)," ",$P(DATA,HL("FS"),13)
"RTN","MPIFQ1",132,0)
 W !,?2,"MOTHER'S MAIDEN NAME: ",$P(DATA,HL("FS"),16)
"RTN","MPIFQ1",133,0)
 W !,?2,"CLAIM NUMBER: ",$P(DATA,HL("FS"),17)
"RTN","MPIFQ1",134,0)
 S CASE=$P(DATA,HL("FS"),18)
"RTN","MPIFQ1",135,0)
 I CASE'="" W !,?2,"Open Data Management Case",!,?5,"CASE#: ",$P(CASE,"/")_"   NOIS#: ",$P(CASE,"/",2),!,?5,"CASE WORKER: ",$P(CASE,"/",3)
"RTN","MPIFQ1",136,0)
 S TTF=$P(DATA,HL("FS"),8)
"RTN","MPIFQ1",137,0)
 I TTF'=""&($P(TTF,"~",2)'="") D
"RTN","MPIFQ1",138,0)
 .W !,?2,"TREATING FACILITY LIST:"
"RTN","MPIFQ1",139,0)
 .N XX,TMP F XX=1:1:128 S TMP=$P(TTF,"~",XX) Q:TMP=""  I TMP'=CMOR3 W !?10,"Treating Facility: ",$P($$NS^XUAF4($$LKUP^XUAF4(TMP)),"^")," (",TMP,")"
"RTN","MPIFQ1",140,0)
 ;
"RTN","MPIFQ1",141,0)
 D PROMPT
"RTN","MPIFQ1",142,0)
 S VALMBCK="R"
"RTN","MPIFQ1",143,0)
 Q
"RTN","MPIFQ1",144,0)
 ;
"RTN","MPIFQ1",145,0)
CMOR ; CMOR PDAT CALL
"RTN","MPIFQ1",146,0)
 N VALMY
"RTN","MPIFQ1",147,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",148,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",149,0)
 N DATA,INDEX,ICN,CHKSUM,CMOR
"RTN","MPIFQ1",150,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",151,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ1",152,0)
 S ICN=$P(DATA,"^",4)
"RTN","MPIFQ1",153,0)
 S CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ1",154,0)
 S ICN=$P(ICN,"V",1) ;ICN
"RTN","MPIFQ1",155,0)
 S CMOR=$P(DATA,"^",7) ;CMOR
"RTN","MPIFQ1",156,0)
 ;
"RTN","MPIFQ1",157,0)
 I CMOR=$P($$SITE^VASITE(),"^",3) W !!,"CMOR is your site" G END
"RTN","MPIFQ1",158,0)
 ;
"RTN","MPIFQ1",159,0)
 W !,"Please be patient while the data is being retrieved from the CMOR."
"RTN","MPIFQ1",160,0)
 D EN1^XWB2HL7(.RETURN,CMOR,"VAFC REMOTE PDAT",1,ICN,"")  ; Request 
"RTN","MPIFQ1",161,0)
 S ^XTMP("MPIFPDAT"_ICN,0)=$$FMADD^XLFDT(DT,2)_"^"_DT_"^"_"REMOTE PDAT QUERY"
"RTN","MPIFQ1",162,0)
 S ^XTMP("MPIFPDAT"_ICN,1)=RETURN(0)_"^"_$$NOW^XLFDT
"RTN","MPIFQ1",163,0)
 S CNT=0
"RTN","MPIFQ1",164,0)
AGAIN1 H 2 K RES1 D RTNDATA^XWBDRPC(.RES1,RETURN(0)) S CNT=CNT+1
"RTN","MPIFQ1",165,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT<11 G AGAIN1
"RTN","MPIFQ1",166,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT>10 W !,"Unable to get data" G END
"RTN","MPIFQ1",167,0)
 I RES1(0)="0^New" I CNT<11 G AGAIN1
"RTN","MPIFQ1",168,0)
 I RES1(0)="0^New" I CNT>10 W !,"Unable to get data" G END
"RTN","MPIFQ1",169,0)
 I +RES1(0)=-1 W !!,$P(RES1(0),"^",2) G END
"RTN","MPIFQ1",170,0)
 I RES1'="" I CNT<11 G AGAIN1
"RTN","MPIFQ1",171,0)
 I RES1'="" I CNT>10 W !,"Unable to get data" Q
"RTN","MPIFQ1",172,0)
 ;
"RTN","MPIFQ1",173,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",174,0)
 N NUM
"RTN","MPIFQ1",175,0)
 S NUM="",CNT=0
"RTN","MPIFQ1",176,0)
 F  S NUM=$O(RES1(NUM)) Q:NUM=""  D
"RTN","MPIFQ1",177,0)
 .I CNT>20 D PROMPT,CLEAR^VALM1 S CNT=0
"RTN","MPIFQ1",178,0)
 .I RES1(NUM)["Additional" W !! S CNT=CNT+2
"RTN","MPIFQ1",179,0)
 .I CNT<21 W !,RES1(NUM) S CNT=CNT+1
"RTN","MPIFQ1",180,0)
 ;
"RTN","MPIFQ1",181,0)
END D PROMPT
"RTN","MPIFQ1",182,0)
 S VALMBCK="R"
"RTN","MPIFQ1",183,0)
 K CNT,RETURN,RES1
"RTN","MPIFQ1",184,0)
 Q
"RTN","MPIFQ1",185,0)
 ;
"RTN","MPIFQ1",186,0)
HELP ; Help List Manager Action (MPIF REAL-TIME QUERY (HELP))
"RTN","MPIFQ1",187,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",188,0)
 D MSG4
"RTN","MPIFQ1",189,0)
 D PROMPT
"RTN","MPIFQ1",190,0)
 S VALMBCK="R"
"RTN","MPIFQ1",191,0)
 Q
"RTN","MPIFQ1",192,0)
 ;
"RTN","MPIFQ1",193,0)
MSG(LOCSSN,LOCNAME,MPISSN,MPINAME) ;
"RTN","MPIFQ1",194,0)
 ;
"RTN","MPIFQ1",195,0)
 W !!!,"Local SSN = "_LOCSSN,?35,"MPI SSN = "_MPISSN
"RTN","MPIFQ1",196,0)
 W !,"Local NAME = "_LOCNAME,?40,"MPI NAME = "_MPINAME
"RTN","MPIFQ1",197,0)
 Q
"RTN","MPIFQ1",198,0)
 ;
"RTN","MPIFQ1",199,0)
MSG3 ;
"RTN","MPIFQ1",200,0)
 W !!,"Updating ICN and CMOR"
"RTN","MPIFQ1",201,0)
 Q
"RTN","MPIFQ1",202,0)
MSG1 ;
"RTN","MPIFQ1",203,0)
 W !!,"You are attempting to assign an ICN that has already been assigned"
"RTN","MPIFQ1",204,0)
 W !,"to another patient in your Patient file."
"RTN","MPIFQ1",205,0)
 W !,"An exception will be recorded noting that these 2 patients "
"RTN","MPIFQ1",206,0)
 W !,"need to be reviewed to determine if they are duplicates."
"RTN","MPIFQ1",207,0)
 Q
"RTN","MPIFQ1",208,0)
MSG2 ;
"RTN","MPIFQ1",209,0)
 W !!,"You have selected a patient from the list of potential matches"
"RTN","MPIFQ1",210,0)
 W !," where the Name is different than what the MPI has."
"RTN","MPIFQ1",211,0)
 W !," Are you sure this is the correct patient?"
"RTN","MPIFQ1",212,0)
 Q
"RTN","MPIFQ1",213,0)
 ;
"RTN","MPIFQ1",214,0)
MSG5 ;
"RTN","MPIFQ1",215,0)
 W !!,"No Action Taken"
"RTN","MPIFQ1",216,0)
 Q
"RTN","MPIFQ1",217,0)
MSG4 ;
"RTN","MPIFQ1",218,0)
 W !!,"When you have reached MPI QUERY RESULTS screen, the software has"
"RTN","MPIFQ1",219,0)
 W !,"queried the Master Patient Index, for possible matches to the patient"
"RTN","MPIFQ1",220,0)
 W !,"you are adding, or selected (pre-existing record)."
"RTN","MPIFQ1",221,0)
 W !!,"The MPI has returned a list of possible matches for that patient"
"RTN","MPIFQ1",222,0)
 W !,"An '*' indicates the Integration Control Number of a patient"
"RTN","MPIFQ1",223,0)
 W !,"on the list, matches one in your Patient file already."
"RTN","MPIFQ1",224,0)
 W !,"To select a patient from the list, choose SP."
"RTN","MPIFQ1",225,0)
 W !,"If the patients listed as potential matches aren't the same patient"
"RTN","MPIFQ1",226,0)
 W !,"select ADD to create a new entry on the MPI for this patient."
"RTN","MPIFQ1",227,0)
 W !,"To view all data for a patient in the list of possible matches"
"RTN","MPIFQ1",228,0)
 W !,"from the MPI, select MPI."
"RTN","MPIFQ1",229,0)
 W !,"To view additional data for a patient in the list of possible"
"RTN","MPIFQ1",230,0)
 W !,"matches from the CMOR site, select CMR."
"RTN","MPIFQ1",231,0)
 Q
"RTN","MPIFQ1",232,0)
 ;
"RTN","MPIFQ1",233,0)
PROMPT ;
"RTN","MPIFQ1",234,0)
 W !!
"RTN","MPIFQ1",235,0)
 S DIR("A")="Hit the Enter key, to Continue "
"RTN","MPIFQ1",236,0)
 S DIR(0)="EA"
"RTN","MPIFQ1",237,0)
 D ^DIR
"RTN","MPIFQ1",238,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",239,0)
 Q
"RTN","MPIFQ1",240,0)
PROMPT1() ;
"RTN","MPIFQ1",241,0)
 N DIR,X,Y
"RTN","MPIFQ1",242,0)
 W !
"RTN","MPIFQ1",243,0)
 S DIR("A")="Are you sure this is the correct patient? Enter YES or NO "
"RTN","MPIFQ1",244,0)
 S DIR(0)="YA"
"RTN","MPIFQ1",245,0)
 D ^DIR
"RTN","MPIFQ1",246,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",247,0)
 Q Y
"RTN","MPIFQ1",248,0)
HERESSN(SSN) ;
"RTN","MPIFQ1",249,0)
 N DFN
"RTN","MPIFQ1",250,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ1",251,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ1",252,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ1",253,0)
 Q DFN
"RTN","MPIFQ1",254,0)
 ;
"RTN","MPIFQ1",255,0)
CHECK(DFN) ;
"RTN","MPIFQ1",256,0)
 N CHECK
"RTN","MPIFQ1",257,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"CHECK",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ1",258,0)
 I $G(CHECK(2,DFN,.01))']"" Q 0
"RTN","MPIFQ1",259,0)
 I $G(CHECK(2,DFN,.02))']"" Q 0
"RTN","MPIFQ1",260,0)
 I $G(CHECK(2,DFN,.03))']"" Q 0
"RTN","MPIFQ1",261,0)
 I $G(CHECK(2,DFN,.09))']"" Q 0
"RTN","MPIFQ1",262,0)
 I $G(CHECK(2,DFN,.301))']"" Q 0
"RTN","MPIFQ1",263,0)
 I $G(CHECK(2,DFN,391))']"" Q 0
"RTN","MPIFQ1",264,0)
 I $G(CHECK(2,DFN,1901))']"" Q 0
"RTN","MPIFQ1",265,0)
 Q 1
"RTN","MPIFQ1",266,0)
 ;
"RTN","MPIFQ1",267,0)
EXIT ;Exit for List Manager Template MPIF REAL-TIME QUERY
"RTN","MPIFQ1",268,0)
 K VALMBCK,VALMCNT,VALMHDR
"RTN","MPIFQ1",269,0)
 Q
"RTN","MPIFQ1",270,0)
 ;
"RTN","MPIFQ1",271,0)
TF(DFN,ARR) ;Add you to TF list and trigger TF and Sub msgs
"RTN","MPIFQ1",272,0)
 N SITE
"RTN","MPIFQ1",273,0)
 S SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFQ1",274,0)
 I $$PATCH^XPDUTL("DG*5.3*261") D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ1",275,0)
 Q
"RTN","MPIFRES")
0^2^B13432619
"RTN","MPIFRES",1,0)
MPIFRES ;SF/CMC-LOCAL AND MISSING ICN RESOLUTION ;JUL 13, 1998
"RTN","MPIFRES",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,7,10,15,17,21**;30 Apr 99
"RTN","MPIFRES",3,0)
 ;
"RTN","MPIFRES",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFRES",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFRES",6,0)
 ;  ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFRES",7,0)
 ;  ^RGHL7(991.1 - #3259
"RTN","MPIFRES",8,0)
 ;  ^RGSITE - #2746
"RTN","MPIFRES",9,0)
 ;
"RTN","MPIFRES",10,0)
BKG ;
"RTN","MPIFRES",11,0)
 S ZTRTN="GO^MPIFRES",ZTDESC="USE HL7 MSGS AND MAIL TO BUILD ICN"
"RTN","MPIFRES",12,0)
 D NOW^%DTC
"RTN","MPIFRES",13,0)
 S ZTIO="",ZTDTH=%
"RTN","MPIFRES",14,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFRES",15,0)
 D ^%ZTLOAD
"RTN","MPIFRES",16,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFRES",17,0)
 K ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,%
"RTN","MPIFRES",18,0)
 Q
"RTN","MPIFRES",19,0)
 ;
"RTN","MPIFRES",20,0)
GO ;ENTRY POINT
"RTN","MPIFRES",21,0)
 N MPIMORE,MPITOT
"RTN","MPIFRES",22,0)
 L +^XTMP("MPIF RESOLUTION"):3 E  Q
"RTN","MPIFRES",23,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFRES",24,0)
 ;
"RTN","MPIFRES",25,0)
 K ^TMP("HLS",$J),STOP
"RTN","MPIFRES",26,0)
 D START^RGHLLOG()
"RTN","MPIFRES",27,0)
 D HLRDF
"RTN","MPIFRES",28,0)
 I $D(STOP) K STOP Q  ;patch 7 added to quit if init returned an error
"RTN","MPIFRES",29,0)
 D LOOP
"RTN","MPIFRES",30,0)
 I $D(^TMP("HLS",$J)) D SEND
"RTN","MPIFRES",31,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFRES",32,0)
 K MPIIT,MPITOT,HLDT,HLDT1,MPICNT,MPIDNUM,MPIEROR,MPIHL,MPIMIDT,MPIMSH
"RTN","MPIFRES",33,0)
 K MPIOUT,MPIQRYNM,MPISEQ,QCNT,MPIMCNT,MPIMTX,ENDT,MPIFRES
"RTN","MPIFRES",34,0)
 L -^XTMP("MPIF RESOLUTION")
"RTN","MPIFRES",35,0)
 ; mark job completion date/time
"RTN","MPIFRES",36,0)
 S $P(^RGSITE(991.8,1,0),"^",4)=$$NOW^XLFDT
"RTN","MPIFRES",37,0)
 Q
"RTN","MPIFRES",38,0)
 ;
"RTN","MPIFRES",39,0)
HLRDF ;
"RTN","MPIFRES",40,0)
 S (MPIOUT,MPIMCNT)=""
"RTN","MPIFRES",41,0)
 S MPIHL("ECH")="^~\&"
"RTN","MPIFRES",42,0)
 S MPIHL("FS")="|"
"RTN","MPIFRES",43,0)
 D INIT^HLFNC2("MPIF ICN-Q02 SERVER",.MPIHL)
"RTN","MPIFRES",44,0)
 I $O(MPIHL("")) D EXC^RGHLLOG(220,"INIT^HLFNC2 call error returned") S STOP="" Q
"RTN","MPIFRES",45,0)
 D CREATE^HLTF(.MPIMCNT,.MPIMTX,.HLDT,.HLDT1)
"RTN","MPIFRES",46,0)
 Q
"RTN","MPIFRES",47,0)
LOOP ;
"RTN","MPIFRES",48,0)
 S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",49,0)
 D MAKE
"RTN","MPIFRES",50,0)
 Q
"RTN","MPIFRES",51,0)
SEND ;ready to send
"RTN","MPIFRES",52,0)
 D GENERATE^HLMA("MPIF ICN-Q02 SERVER","GB",1,.MPIMTX,.MPIEROR,.MPIMORE)
"RTN","MPIFRES",53,0)
 I +MPIEROR=0 D EXC^RGHLLOG(220,"GENERATE^HLMA call returned error") Q
"RTN","MPIFRES",54,0)
 K %,MPIMTX,MPIEROR,MPIMORE
"RTN","MPIFRES",55,0)
 K ^TMP("HLS",$J)
"RTN","MPIFRES",56,0)
 Q
"RTN","MPIFRES",57,0)
MAKE ;
"RTN","MPIFRES",58,0)
 N LOCAL,MPIIT,TICN,STOP,X,Y,%,%H,%I,TODAY
"RTN","MPIFRES",59,0)
 S LOCAL="",MPIIT=0,MPIFRES=""
"RTN","MPIFRES",60,0)
 D NOW^%DTC S TODAY=X
"RTN","MPIFRES",61,0)
 ;local ICNs
"RTN","MPIFRES",62,0)
 F  S MPIIT=$O(^DPT("AICNL",1,MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",63,0)
 .Q:+$G(^DPT("AICNL",1,MPIIT))=1
"RTN","MPIFRES",64,0)
 .; ^ only send patient to MPI for Local ICN resolution 1 time
"RTN","MPIFRES",65,0)
 .I $D(^RGHL7(991.1,"ADFN",218,MPIIT)) S ^DPT("AICNL",1,MPIIT)="1^"_TODAY Q
"RTN","MPIFRES",66,0)
 .; ^ checking if potential match exception
"RTN","MPIFRES",67,0)
 .D MAKE3
"RTN","MPIFRES",68,0)
 ;missing ICNs
"RTN","MPIFRES",69,0)
 S MPIIT=0
"RTN","MPIFRES",70,0)
 F  S MPIIT=$O(^DPT("AMPIMIS",MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",71,0)
 .K STOP
"RTN","MPIFRES",72,0)
 .S TICN=+$$GETICN^MPIF001(MPIIT)
"RTN","MPIFRES",73,0)
 .I TICN<0,'$D(STOP) D MAKE3
"RTN","MPIFRES",74,0)
 .I TICN>0 K ^DPT("AMPIMIS",MPIIT)
"RTN","MPIFRES",75,0)
 Q
"RTN","MPIFRES",76,0)
MAKE3 ;
"RTN","MPIFRES",77,0)
 K MPIOUT
"RTN","MPIFRES",78,0)
 S MPIFRES=""
"RTN","MPIFRES",79,0)
 S:$G(MPIQRYNM)="" MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFRES",80,0)
 D VTQ1^MPIFVTQ(MPIIT,.MPIOUT,.MPIHL,.MPIQRYNM)
"RTN","MPIFRES",81,0)
 I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="invalid DFN"!($P(MPIOUT(0),"^",2)="no encoding characters") D
"RTN","MPIFRES",82,0)
 .D EXC^RGHLLOG(206,"DFN = "_MPIIT_"  Problem with building VTQ was "_$P(MPIOUT(0),"^",2),MPIIT) Q
"RTN","MPIFRES",83,0)
 I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="Missing Required Field(s)" Q
"RTN","MPIFRES",84,0)
 Q:$P(MPIOUT(0),"^")<0
"RTN","MPIFRES",85,0)
 S ^DPT("AICNL",1,MPIIT)="1^"_TODAY
"RTN","MPIFRES",86,0)
 ; ^ mark Local ICN as having been sent to MPI for resolution
"RTN","MPIFRES",87,0)
 ;call for HL7 header
"RTN","MPIFRES",88,0)
 S MPIMIDT=MPIMCNT_"-"_MPIDNUM
"RTN","MPIFRES",89,0)
 D MSH^HLFNC2(.MPIHL,MPIMIDT,.MPIMSH)
"RTN","MPIFRES",90,0)
 S MPIOUT(1)=MPIMSH
"RTN","MPIFRES",91,0)
 ;MESSAGE BUILT
"RTN","MPIFRES",92,0)
 S MPISEQ=0
"RTN","MPIFRES",93,0)
 F  S MPISEQ=$O(MPIOUT(MPISEQ)) Q:MPISEQ'>0  D
"RTN","MPIFRES",94,0)
 .S ^TMP("HLS",$J,MPICNT)=MPIOUT(MPISEQ)
"RTN","MPIFRES",95,0)
 .S MPICNT=MPICNT+1
"RTN","MPIFRES",96,0)
 S MPIDNUM=MPIDNUM+1
"RTN","MPIFRES",97,0)
 I MPIDNUM>100 D
"RTN","MPIFRES",98,0)
 .D SEND
"RTN","MPIFRES",99,0)
 .S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",100,0)
 .D HLRDF
"RTN","MPIFRES",101,0)
 Q
"RTN","MPIFSAQ")
0^1^B82064940
"RTN","MPIFSAQ",1,0)
MPIFSAQ ;SF/CMC-STAND ALONE QUERY ;JAN 12, 1998
"RTN","MPIFSAQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,13,17,21**;30 Apr 99
"RTN","MPIFSAQ",3,0)
 ;
"RTN","MPIFSAQ",4,0)
 ;Integration Agreements:
"RTN","MPIFSAQ",5,0)
 ;  $$SEND^RGJUSITE - #3469
"RTN","MPIFSAQ",6,0)
 ;  $$EN^HLCSAC - #3471
"RTN","MPIFSAQ",7,0)
 ;
"RTN","MPIFSAQ",8,0)
INTACTV ;Interactive standalone query - Display Only!
"RTN","MPIFSAQ",9,0)
 ;patient doesn't have to be in Patient file
"RTN","MPIFSAQ",10,0)
 S FLG=0
"RTN","MPIFSAQ",11,0)
 K DIR,X,Y
"RTN","MPIFSAQ",12,0)
 S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is Patient in the PATIENT file "
"RTN","MPIFSAQ",13,0)
 D ^DIR
"RTN","MPIFSAQ",14,0)
 G:(Y'=1)&(Y'=0) END
"RTN","MPIFSAQ",15,0)
 I Y=1 S FLG=1 D PAT(.MPIVAR)
"RTN","MPIFSAQ",16,0)
 I Y'=1,'$D(MPIVAR) D NOPAT(.MPIVAR)
"RTN","MPIFSAQ",17,0)
 I '$D(MPIVAR("DFN"))&(FLG'=0) G END
"RTN","MPIFSAQ",18,0)
 I +$G(MPIVAR("DOB"))'>0 W !,"DOB is missing - Required field" G END
"RTN","MPIFSAQ",19,0)
 D VTQ(.MPIVAR)
"RTN","MPIFSAQ",20,0)
 K DIR,X,Y,MPIVAR,FLG
"RTN","MPIFSAQ",21,0)
 Q
"RTN","MPIFSAQ",22,0)
END K DIR,X,Y,MPIVAR,DIRUT,DTOUT,DUOUT
"RTN","MPIFSAQ",23,0)
 Q
"RTN","MPIFSAQ",24,0)
CLEAN(NAM) ;
"RTN","MPIFSAQ",25,0)
 ;NAM is the name to be cleaned up
"RTN","MPIFSAQ",26,0)
 ; Returned from this function is a clean name
"RTN","MPIFSAQ",27,0)
 N YY,I
"RTN","MPIFSAQ",28,0)
 ; -- only uppercase
"RTN","MPIFSAQ",29,0)
 I NAM?.E1L.E F I=1:1:$L(NAM) S:$E(NAM,I)?1L NAM=$E(NAM,0,I-1)_$C($A(NAM,I)-32)_$E(NAM,I+1,$L(NAM))
"RTN","MPIFSAQ",30,0)
 ; -- no space after comma and no double spaces
"RTN","MPIFSAQ",31,0)
 F YY=", ","  " F  Q:'$F(NAM,YY)  S NAM=$E(NAM,1,($F(NAM,YY)-2))_$E(NAM,$F(NAM,YY),$L(NAM))
"RTN","MPIFSAQ",32,0)
 ; -- no space at the end
"RTN","MPIFSAQ",33,0)
 F  Q:$E(NAM,$L(NAM))'=" "  S NAM=$E(NAM,1,$L(NAM)-1)
"RTN","MPIFSAQ",34,0)
 Q NAM
"RTN","MPIFSAQ",35,0)
PAT(MPIVAR) ;patient is in local Patient file
"RTN","MPIFSAQ",36,0)
PATA N DIC,X,Y,DIQ,DR,DA,MPIFAR,DFN,DTOUT,DUOUT
"RTN","MPIFSAQ",37,0)
 S DIC="^DPT(",DIC(0)="AEQZM",DIC("A")="Patient Name: "
"RTN","MPIFSAQ",38,0)
 D ^DIC
"RTN","MPIFSAQ",39,0)
 G:$D(DTOUT)!($D(DUOUT))!(Y="^")!(X="") END
"RTN","MPIFSAQ",40,0)
 I +Y=-1 W !,"Patient not found.  Try Again" G PATA
"RTN","MPIFSAQ",41,0)
 S (DFN,MPIVAR("DFN"))=+Y,MPIVAR("NM")=$P(Y(0),"^")
"RTN","MPIFSAQ",42,0)
 S DIQ="MPIFAR",DR=".09;.03",DIC="^DPT(",DA=+Y,DIQ(0)="I"
"RTN","MPIFSAQ",43,0)
 D EN^DIQ1
"RTN","MPIFSAQ",44,0)
 K DA
"RTN","MPIFSAQ",45,0)
 S MPIVAR("DOB")=$G(MPIFAR(2,DFN,.03,"I"))
"RTN","MPIFSAQ",46,0)
 S MPIVAR("SSN")=$G(MPIFAR(2,DFN,.09,"I")) I MPIVAR("SSN")["P" S MPIVAR("SSN")=""
"RTN","MPIFSAQ",47,0)
 Q
"RTN","MPIFSAQ",48,0)
 ;
"RTN","MPIFSAQ",49,0)
NOPAT(MPIVAR) ; patient is not in the local Patient file
"RTN","MPIFSAQ",50,0)
NAME N DTOUT,DUOUT,DIR,X,Y
"RTN","MPIFSAQ",51,0)
 S DIR(0)="FU^::",DIR("A")="PATIENT NAME (last,first middle)"
"RTN","MPIFSAQ",52,0)
 D ^DIR
"RTN","MPIFSAQ",53,0)
 G:$D(DTOUT)!($D(DUOUT))!(Y="^") END
"RTN","MPIFSAQ",54,0)
 I (Y="")!($L(Y)>45)!($L(Y)<3) W !,"Name should be Last,first middle and at least 3 characters and no more than 30" G NAME
"RTN","MPIFSAQ",55,0)
 I (Y?1P.E)!(Y'?1U.ANP)!(Y'[",")!(Y[":")!(Y[";") W !,"Name should be Last,first middle and at least 3 characters and no more than 30" G NAME
"RTN","MPIFSAQ",56,0)
 I Y'?.UNP F %=1:1:$L(Y) I $E(Y,%)?1L S Y=$E(Y,0,%-1)_$C($A(Y,%)-32)_$E(Y,%+1,999)
"RTN","MPIFSAQ",57,0)
 S MPIVAR("NM")=$$CLEAN(Y)
"RTN","MPIFSAQ",58,0)
DOB K DIR,X,Y
"RTN","MPIFSAQ",59,0)
 S DIR(0)="DU^::AE",DIR("A")="Date of Birth"
"RTN","MPIFSAQ",60,0)
 D ^DIR
"RTN","MPIFSAQ",61,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",62,0)
 S MPIVAR("DOB")=Y
"RTN","MPIFSAQ",63,0)
SSN ; ssn is optional
"RTN","MPIFSAQ",64,0)
 K DIR,X,Y
"RTN","MPIFSAQ",65,0)
 S DIR(0)="FUO^9:9:",DIR("A")="9 Digit SSN (No Dashes)"
"RTN","MPIFSAQ",66,0)
 D ^DIR
"RTN","MPIFSAQ",67,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",68,0)
 I Y'="",Y'?9N W !,"SSN should be 9 numbers" G SSN
"RTN","MPIFSAQ",69,0)
 S MPIVAR("SSN")=Y
"RTN","MPIFSAQ",70,0)
 Q
"RTN","MPIFSAQ",71,0)
 ;
"RTN","MPIFSAQ",72,0)
VTQ(MPIVAR) ;
"RTN","MPIFSAQ",73,0)
 I $$SEND^RGJUSITE'>0 W !,"Not in SEND or SUSPEND mode, Try Again Later" G END
"RTN","MPIFSAQ",74,0)
 N TIME,%
"RTN","MPIFSAQ",75,0)
 D NOW^%DTC S TIME=%
"RTN","MPIFSAQ",76,0)
 ;
"RTN","MPIFSAQ",77,0)
 W !!,"Attempting to connect to the Master Patient Index in Austin..."
"RTN","MPIFSAQ",78,0)
 W !,"If DOB is inexact or if SSN is not passed or if common name,",!,"this could take some time - please be patient...."
"RTN","MPIFSAQ",79,0)
 ;
"RTN","MPIFSAQ",80,0)
 N HL,MPIQRYNM,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER
"RTN","MPIFSAQ",81,0)
 N TEST,SITE,MPIDC,MPINM,MPI1NM,MPI2NM,MPIESC,MPIHDOB,MPIRS,MPISCS
"RTN","MPIFSAQ",82,0)
 N QUEDDOB,QUERY,RDF
"RTN","MPIFSAQ",83,0)
 S HLP("ACKTIME")=300,HL("ECH")="^~\&",HL("FS")="|",MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFSAQ",84,0)
 S MPIIN="",MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFSAQ",85,0)
 I '$D(MPIVAR("DFN")) S MPIVAR("DFN")=235
"RTN","MPIFSAQ",86,0)
 S MPIMCNT=MPIVAR("DFN")
"RTN","MPIFSAQ",87,0)
 ;
"RTN","MPIFSAQ",88,0)
 ;SETUP VTQ
"RTN","MPIFSAQ",89,0)
 ;
"RTN","MPIFSAQ",90,0)
 S MPICS=$E(HL("ECH"),1),MPIRS=$E(HL("ECH"),2),MPISCS=$E(HL("ECH"),4),MPIESC=$E(HL("ECH"),3)
"RTN","MPIFSAQ",91,0)
 ;
"RTN","MPIFSAQ",92,0)
 S RDF="RDF"_HL("FS")_16_HL("FS")_"@00108.1"_MPICS_"ST"_MPICS_30_MPIRS_"@00122"_MPICS_"ST"_MPICS_9_MPIRS_"@00110"_MPICS_"TS"_MPICS_8_MPIRS_"@00756"_MPICS_"ST"_MPICS_30
"RTN","MPIFSAQ",93,0)
 S RDF=RDF_MPIRS_"@00105"_MPICS_"ST"_MPICS_19_MPIRS_"@00108.2"_MPICS_"ST"_MPICS_30_MPIRS_"@00169"_MPICS_"ST"_MPICS_30_MPIRS_"@00740"_MPICS_"TS"_MPICS_12
"RTN","MPIFSAQ",94,0)
 S RDF=RDF_MPIRS_"@00108.3"_MPICS_"ST"_MPICS_16_MPIRS_"@00111"_MPICS_"ST"_MPICS_1_MPIRS_"@00126.1"_MPICS_"ST"_MPICS_30_MPIRS_"@00126.2"_MPICS_"ST"_MPICS_3
"RTN","MPIFSAQ",95,0)
 S RDF=RDF_MPIRS_"@00108.5"_MPICS_"ST"_MPICS_20_MPIRS_"@00108.4"_MPICS_"ST"_MPICS_20_MPIRS_"@00109.1"_MPICS_"ST"_MPICS_30_MPIRS_"@ZEL6"_MPICS_"ST"_MPICS_9
"RTN","MPIFSAQ",96,0)
 S RDF=RDF_MPIRS_"@CASE#"_MPICS_"ST"_MPICS_69
"RTN","MPIFSAQ",97,0)
 ; ^ fields to be returned in query response
"RTN","MPIFSAQ",98,0)
 S QUERY="VTQ"_HL("FS")_$G(MPIVAR("DFN"))_HL("FS")_"T"_HL("FS")_MPIQRYNM_HL("FS")_"ICN"_HL("FS")
"RTN","MPIFSAQ",99,0)
 S MPI2NM=$P($G(MPIVAR("NM")),",",1),QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFSAQ",100,0)
 ; ^ sending last name
"RTN","MPIFSAQ",101,0)
 I MPIVAR("SSN")'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_$G(MPIVAR("SSN"))
"RTN","MPIFSAQ",102,0)
 ; ^ sending SSN
"RTN","MPIFSAQ",103,0)
 S MPI1NM=$P($G(MPIVAR("NM")),",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFSAQ",104,0)
 ; ^ sending first name
"RTN","MPIFSAQ",105,0)
 I $G(MPIVAR("DOB"))>0 D
"RTN","MPIFSAQ",106,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIVAR("DOB"))
"RTN","MPIFSAQ",107,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFSAQ",108,0)
 .S QUEDDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFSAQ",109,0)
 .S QUERY=QUERY_QUEDDOB
"RTN","MPIFSAQ",110,0)
 .; ^ sending date of birth
"RTN","MPIFSAQ",111,0)
 ;
"RTN","MPIFSAQ",112,0)
 ;Create MSH
"RTN","MPIFSAQ",113,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFSAQ",114,0)
 S HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFSAQ",115,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFSAQ",116,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFSAQ",117,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFSAQ",118,0)
 S MPIOUT(3)=RDF
"RTN","MPIFSAQ",119,0)
 ;
"RTN","MPIFSAQ",120,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFSAQ",121,0)
 ;Message is returned in MPIDC array
"RTN","MPIFSAQ",122,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFSAQ",123,0)
 ;Clean up the ack timeout HLP array variable
"RTN","MPIFSAQ",124,0)
 K HLP("ACKTIME")
"RTN","MPIFSAQ",125,0)
 I +TEST<0 W !!,"Could not connect to MPI or Time-out occured, try again later." G EXIT
"RTN","MPIFSAQ",126,0)
 ;
"RTN","MPIFSAQ",127,0)
 ;Kill ^TMP("MPIFSAQ",$J) this is the array the data is parsed into
"RTN","MPIFSAQ",128,0)
 K ^TMP("MPIFSAQ",$J)
"RTN","MPIFSAQ",129,0)
 ;
"RTN","MPIFSAQ",130,0)
INIPARS ;
"RTN","MPIFSAQ",131,0)
 N SEG,INDEX,COUNTER,LASTSSN,SKIP,CHECK,FIRST,FICN
"RTN","MPIFSAQ",132,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFSAQ",133,0)
 K CHECK
"RTN","MPIFSAQ",134,0)
PARSE S SEG=$$SEG^MPIFAPI("RDT",1,"RDT")
"RTN","MPIFSAQ",135,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFSAQ",136,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,NAME,TF,ICN,POBC,POBS,PAST
"RTN","MPIFSAQ",137,0)
 . N HEREICN,HERESSN,MIDDLE,MNAME,SUFFIX,PREFIX,SEX,IEN,CMOR2,TF2,CLAIM
"RTN","MPIFSAQ",138,0)
 . N CASE,NOIS,CUSER,TFN,CMOR3
"RTN","MPIFSAQ",139,0)
 . S FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2)
"RTN","MPIFSAQ",140,0)
 . S MIDDLE=$P(SEG,HL("FS"),10),(LASTSSN,SSN)=$P(SEG,HL("FS"),3)
"RTN","MPIFSAQ",141,0)
 . S NAME=LASTNAME_","_FRSTNAME_" "_MIDDLE
"RTN","MPIFSAQ",142,0)
 . S CMOR=$P(SEG,HL("FS"),5),CMOR2=CMOR,CMOR3=CMOR
"RTN","MPIFSAQ",143,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFSAQ",144,0)
 . I $D(FICN) I FICN'=ICN S FIRST=1,FICN=ICN K CHECK
"RTN","MPIFSAQ",145,0)
 . I FIRST=1 S FICN=ICN
"RTN","MPIFSAQ",146,0)
 . S FIRST=FIRST+1
"RTN","MPIFSAQ",147,0)
 . I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^"),CMOR2=CMOR
"RTN","MPIFSAQ",148,0)
 . S TF=$P(SEG,HL("FS"),8),TF2=TF
"RTN","MPIFSAQ",149,0)
 . ;;Same patient just adding TF's
"RTN","MPIFSAQ",150,0)
 . I TF'="",FICN=ICN,FIRST'=2 S SKIP="Y" Q:CMOR2=TF2!($D(CHECK(TF2)))
"RTN","MPIFSAQ",151,0)
 . ;
"RTN","MPIFSAQ",152,0)
 . I $G(SKIP)="Y" K SKIP Q
"RTN","MPIFSAQ",153,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFSAQ",154,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFSAQ",155,0)
 . I $G(BIRTHDAY)]"" D
"RTN","MPIFSAQ",156,0)
 . . S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY)
"RTN","MPIFSAQ",157,0)
 . . S BIRTHDAY=$TR($$FMTE^XLFDT(BIRTHDAY,"5D"),"/","-")
"RTN","MPIFSAQ",158,0)
 . S SEX=$P(SEG,HL("FS"),11)
"RTN","MPIFSAQ",159,0)
 . S CLAIM=$P(SEG,HL("FS"),17)
"RTN","MPIFSAQ",160,0)
 . S SUFFIX=$P(SEG,HL("FS"),15)
"RTN","MPIFSAQ",161,0)
 . S PREFIX=$P(SEG,HL("FS"),14)
"RTN","MPIFSAQ",162,0)
 . S MNAME=$P(SEG,HL("FS"),16)
"RTN","MPIFSAQ",163,0)
 . S POBC=$P(SEG,HL("FS"),12)
"RTN","MPIFSAQ",164,0)
 . S POBS=$P(SEG,HL("FS"),13)
"RTN","MPIFSAQ",165,0)
 . S PAST=$P(SEG,HL("FS"),9)
"RTN","MPIFSAQ",166,0)
 . I $G(PAST)]"" D
"RTN","MPIFSAQ",167,0)
 . . S PAST=$$FMDATE^HLFNC(PAST)
"RTN","MPIFSAQ",168,0)
 . . S PAST=$TR($$FMTE^XLFDT(PAST,"5D"),"/","-")
"RTN","MPIFSAQ",169,0)
 . S CASE=$P(SEG,HL("FS"),18),NOIS=$P(CASE,"/",2),CUSER=$P(CASE,"/",3),CASE=$P(CASE,"/")
"RTN","MPIFSAQ",170,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFSAQ",171,0)
 . S INDEX=INDEX+1
"RTN","MPIFSAQ",172,0)
 . S COUNTER=1
"RTN","MPIFSAQ",173,0)
 . I CMOR2=TF2 S TF=""
"RTN","MPIFSAQ",174,0)
 . S ^TMP("MPIFSAQ",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_SEX_"^"_SUFFIX_"^"_PREFIX_"^"_MNAME_"^"_POBC_"^"_POBS_"^"_PAST_"^"_CLAIM_"^"_CASE_"^"_NOIS_"^"_CUSER_"^"_CMOR3
"RTN","MPIFSAQ",175,0)
 ;
"RTN","MPIFSAQ",176,0)
 ; If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFSAQ",177,0)
 I '$D(^TMP("MPIFSAQ",$J)) W !!,"Patient was not found in the MPI." G EXIT
"RTN","MPIFSAQ",178,0)
DISPLAY ;
"RTN","MPIFSAQ",179,0)
 I INDEX>1 W !!,"Found potential matches"
"RTN","MPIFSAQ",180,0)
 I INDEX=1 W !!,"Found One Match"
"RTN","MPIFSAQ",181,0)
 ; display data returned
"RTN","MPIFSAQ",182,0)
 N CNT1,CNT2,STOP,CNTR2,TTF,CNT3,DIR,X,Y,DATA,PREFIX
"RTN","MPIFSAQ",183,0)
 N NAME,SSN,BIRTHDAY,CMOR,TF,ICN,POBC,POBS,PAST
"RTN","MPIFSAQ",184,0)
 N MNAME,SUFFIX,SEX,IEN,CMOR2,TF2,CLAIM,CASE,NOIS,CUSER,TFN,CMOR3
"RTN","MPIFSAQ",185,0)
 S (CNT1)=0
"RTN","MPIFSAQ",186,0)
 F  S CNT1=$O(^TMP("MPIFSAQ",$J,CNT1)) Q:CNT1'>0!($D(STOP))  D
"RTN","MPIFSAQ",187,0)
 . S CNTR2=0
"RTN","MPIFSAQ",188,0)
 . I CNT1>1 D
"RTN","MPIFSAQ",189,0)
 . . K DIR,X,Y
"RTN","MPIFSAQ",190,0)
 . . S DIR(0)="Y",DIR("B")="YES",DIR("A")="Continue to next Patient? "
"RTN","MPIFSAQ",191,0)
 . . D ^DIR
"RTN","MPIFSAQ",192,0)
 . . I Y'=1 S STOP=""
"RTN","MPIFSAQ",193,0)
 . Q:$D(STOP)
"RTN","MPIFSAQ",194,0)
 . S CNTR2=CNTR2+1
"RTN","MPIFSAQ",195,0)
 . S DATA=$G(^TMP("MPIFSAQ",$J,CNT1,"DATA"))
"RTN","MPIFSAQ",196,0)
 . Q:DATA=""
"RTN","MPIFSAQ",197,0)
 . K TF,CHECK
"RTN","MPIFSAQ",198,0)
 . S NAME=$P(DATA,"^"),SSN=$P(DATA,"^",2),BIRTHDAY=$P(DATA,"^",3)
"RTN","MPIFSAQ",199,0)
 . S ICN=$P(DATA,"^",4),CMOR=$P(DATA,"^",5),TTF=$P(DATA,"^",6)
"RTN","MPIFSAQ",200,0)
 . I TTF'="",CMOR'=TTF S TF(CNTR2)=TTF
"RTN","MPIFSAQ",201,0)
 . S SEX=$P(DATA,"^",7),SUFFIX=$P(DATA,"^",9),PREFIX=$P(DATA,"^",8)
"RTN","MPIFSAQ",202,0)
 . S MNAME=$P(DATA,"^",10),POBC=$P(DATA,"^",11),POBS=$P(DATA,"^",12)
"RTN","MPIFSAQ",203,0)
 . S PAST=$P(DATA,"^",13),CLAIM=$P(DATA,"^",14)
"RTN","MPIFSAQ",204,0)
 . S CASE=$P(DATA,"^",15),NOIS=$P(DATA,"^",16),CUSER=$P(DATA,"^",17)
"RTN","MPIFSAQ",205,0)
 . S CMOR3=$P(DATA,"^",18)
"RTN","MPIFSAQ",206,0)
 . W !!
"RTN","MPIFSAQ",207,0)
 . W:$G(CASE)'="" !,"<<THIS ICN IS ACTIVELY BEING WORKED ON - CASE #",CASE
"RTN","MPIFSAQ",208,0)
 . W:$G(NOIS)'="" " NOIS: ",NOIS
"RTN","MPIFSAQ",209,0)
 . W:$G(CASE)'="" ">>"
"RTN","MPIFSAQ",210,0)
 . W:$G(CUSER)'="" !,?3,"Case Worker: ",CUSER
"RTN","MPIFSAQ",211,0)
 . W !!,"ICN      : ",$P(ICN,"V"),?30,"CMOR: ",CMOR," (",CMOR3,")"
"RTN","MPIFSAQ",212,0)
 . W !,"Name     : ",NAME," ",SUFFIX," ",PREFIX
"RTN","MPIFSAQ",213,0)
 . W !,"SSN      : ",SSN
"RTN","MPIFSAQ",214,0)
 . W !,"DOB      : ",BIRTHDAY,?30,"Date of Death: ",PAST
"RTN","MPIFSAQ",215,0)
 . W !,"Sex      : ",SEX
"RTN","MPIFSAQ",216,0)
 . W:$G(CLAIM)'="" !,"Claim #  : ",CLAIM
"RTN","MPIFSAQ",217,0)
 . W:$G(POBC)'="" !,"Place of Birth: ",POBC,", ",POBS
"RTN","MPIFSAQ",218,0)
 . W:$G(MNAME)'="" !,"Mother's Maiden Name: ",MNAME
"RTN","MPIFSAQ",219,0)
 . S CNT2=""
"RTN","MPIFSAQ",220,0)
 .N XX,TMP F XX=1:1:128 S TMP=$P(TTF,"~",XX) Q:TMP=""  I TMP'=CMOR3 W !?10,"Treating Facility: ",$P($$NS^XUAF4($$LKUP^XUAF4(TMP)),"^")," (",TMP,")"
"RTN","MPIFSAQ",221,0)
 .W !!
"RTN","MPIFSAQ",222,0)
EXIT K DA,FICN,X,Y W !! Q
"RTN","MPIFVTQ")
0^5^B37128975
"RTN","MPIFVTQ",1,0)
MPIFVTQ ;SLC/ARS-BUILD DATA TO QUERY MPI RESPONSE PROCESS (ADDPAT) ;JUL 16, 1997
"RTN","MPIFVTQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,9,17,21**;30 Apr 99
"RTN","MPIFVTQ",3,0)
 ;
"RTN","MPIFVTQ",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFVTQ",5,0)
 ;  ^DPT( -9 node check - #2762
"RTN","MPIFVTQ",6,0)
 ;  ^DPT( "MPI" node - #2070
"RTN","MPIFVTQ",7,0)
 ;  EXC, START, STOP ^RGHLLOG - #2796
"RTN","MPIFVTQ",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFVTQ",9,0)
 ;
"RTN","MPIFVTQ",10,0)
 Q  ;NOT an entry point
"RTN","MPIFVTQ",11,0)
 ;
"RTN","MPIFVTQ",12,0)
VTQ1(MPIIT,MPIOUT,MPIHL,MPIQRYNM,MPISND) ;
"RTN","MPIFVTQ",13,0)
 ;MPIIT=DFN in patient file.
"RTN","MPIFVTQ",14,0)
 ;MPIOUT=Array you want the VTQ/RDF put into.
"RTN","MPIFVTQ",15,0)
 ;MPIHL=Array of encoding characters and Field separator.
"RTN","MPIFVTQ",16,0)
 ;MPIQRYNM=Name of query to put into message.
"RTN","MPIFVTQ",17,0)
 ;MPISND (OPTIONAL) = item #'s separated by ; to be used to query.
"RTN","MPIFVTQ",18,0)
 ;  default is DOB;SSN;LAST NAME;FIRST NAME;SUFFIX OF NAME;SEX;DOD;
"RTN","MPIFVTQ",19,0)
 ;  POB-CITY;POB-STATE;MIDDLE NAME
"RTN","MPIFVTQ",20,0)
 ;
"RTN","MPIFVTQ",21,0)
 ;If invalid DFN, Patient Merged, if ICN already assigned, Test SSN, the VTQ query is not built and -1^'error message' returned in MPIOUT(0).
"RTN","MPIFVTQ",22,0)
 ;
"RTN","MPIFVTQ",23,0)
 ;If DOB does not contain a 7 digit date OR if name is not present, -1^Missing Required fields will be returned in MPIOUT(0).
"RTN","MPIFVTQ",24,0)
 ;
"RTN","MPIFVTQ",25,0)
 ;If patient has a date of death, the VTQ query is built with MPIOUT(0) returned with 0^Patient has date of death.  Programmer to decide if VTQ should be sent.
"RTN","MPIFVTQ",26,0)
 ;
"RTN","MPIFVTQ",27,0)
 N MPITEST,MPISSN,MPIDTH,MPINM,MPIDOB
"RTN","MPIFVTQ",28,0)
 S MPIOUT(0)=""
"RTN","MPIFVTQ",29,0)
 I '$D(MPISND) S MPISND="00122;00108.1;00108.2;00110;00740;00111;00108.4;00126.1;00126.2;00108.3"
"RTN","MPIFVTQ",30,0)
 ;validation check
"RTN","MPIFVTQ",31,0)
 I '$D(MPIHL) S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",32,0)
 I $G(MPIHL("FS"))=""!($G(MPIHL("ECH"))="") S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",33,0)
 I MPIIT="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",34,0)
 I $G(^DPT(MPIIT,-9))'="" S MPIOUT(0)="-1^Patient merged "_^DPT(MPIIT,-9) Q
"RTN","MPIFVTQ",35,0)
 I $P($G(^DPT(MPIIT,0)),"^")["MERGING" S MPIOUT(0)="-1^Patient being merged DFN= "_MPIIT Q
"RTN","MPIFVTQ",36,0)
 S MPIMPI=$G(^DPT(MPIIT,"MPI"))
"RTN","MPIFVTQ",37,0)
 S:MPIMPI'="" MPIZICN=$P(^DPT(MPIIT,"MPI"),"^",1)
"RTN","MPIFVTQ",38,0)
 I '$D(MPIFRES),$G(MPIZICN)'="" S MPIOUT(0)="-1^ICN already assigned "_MPIZICN Q
"RTN","MPIFVTQ",39,0)
 S MPITEST=$G(^DPT(MPIIT,0))
"RTN","MPIFVTQ",40,0)
 I MPITEST="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",41,0)
 S MPISSN=$P(MPITEST,"^",9)
"RTN","MPIFVTQ",42,0)
 I $E(MPISSN,1,5)="00000" S MPIOUT(0)="-1^5 zero SSN" Q
"RTN","MPIFVTQ",43,0)
 I $E($P(MPITEST,"^"),1,2)="ZZ" S MPIOUT(0)="-1^ZZ'd Patient" Q
"RTN","MPIFVTQ",44,0)
 I $E($P(MPITEST,"^"),1,3)="EEE" S MPIOUT(0)="-1^EEE Patient" Q
"RTN","MPIFVTQ",45,0)
 S MPINM=$P(MPITEST,"^") I MPINM=""!($L(MPINM)<3) S MPIOUT(0)="-1^Missing Required Field(s)" D EXC(MPIIT) Q
"RTN","MPIFVTQ",46,0)
 S MPIDOB=$P(MPITEST,"^",3) I MPIDOB'?7N S MPIOUT(0)="-1^Missing Required Field(s)" D EXC(MPIIT) Q
"RTN","MPIFVTQ",47,0)
 S MPIDTH=""
"RTN","MPIFVTQ",48,0)
 S:$G(^DPT(MPIIT,.35))'="" MPIDTH=$P(^DPT(MPIIT,.35),"^",1)
"RTN","MPIFVTQ",49,0)
 I $G(MPIDTH)'="" S MPIOUT(0)="0^Patient has Date of Death "_MPIDTH
"RTN","MPIFVTQ",50,0)
 D VTQC(MPISSN,MPIDTH,MPISND,.MPIHL,MPIQRYNM,.MPIOUT,MPIIT)
"RTN","MPIFVTQ",51,0)
 Q
"RTN","MPIFVTQ",52,0)
EXC(IEN) ;
"RTN","MPIFVTQ",53,0)
 Q:'$D(^DPT(IEN))
"RTN","MPIFVTQ",54,0)
 D LOCAL^MPIFQ0(IEN)
"RTN","MPIFVTQ",55,0)
 D START^RGHLLOG()
"RTN","MPIFVTQ",56,0)
 D EXC^RGHLLOG(209,"DFN= "_IEN_" is Missing Required Field(s)",IEN)
"RTN","MPIFVTQ",57,0)
 D STOP^RGHLLOG()
"RTN","MPIFVTQ",58,0)
 Q
"RTN","MPIFVTQ",59,0)
 ;
"RTN","MPIFVTQ",60,0)
VTQC(MPISSN,MPIDTH,MPISND,MPIHL,MPIQRYNM,MPIOUT,MPIIT) ;
"RTN","MPIFVTQ",61,0)
 N MPIPOB,MPIPOBS,MPINM,MPI2MN,MPI1NM,QUERY,MPIDOB,RDF,MPIMOD
"RTN","MPIFVTQ",62,0)
 N MPIHDTH,MPIZDOB,MPIXDOB,MPIMPI,MPIZICN,QUEDOB,MPI2NM,MPICS,MPIESC,MPIHDOB,MPIMNM,MPIMN
"RTN","MPIFVTQ",63,0)
 N MPINMSFX,MPIRS,MPISCS,MPISEX,MPIZLOC
"RTN","MPIFVTQ",64,0)
 I $G(MPIQRYNM)="" S MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFVTQ",65,0)
 S MPICS=$E(MPIHL("ECH"),1)
"RTN","MPIFVTQ",66,0)
 S MPIRS=$E(MPIHL("ECH"),2)
"RTN","MPIFVTQ",67,0)
 S MPISCS=$E(MPIHL("ECH"),4)
"RTN","MPIFVTQ",68,0)
 S MPIESC=$E(MPIHL("ECH"),3)
"RTN","MPIFVTQ",69,0)
 ;
"RTN","MPIFVTQ",70,0)
 S RDF="RDF"_MPIHL("FS")_"17"_MPIHL("FS")_"@00108.1"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00122"_MPICS_"ST"_MPICS_"9"_MPIRS_"@00110"_MPICS_"ST"_MPICS_8_MPIRS_"@00756"_MPICS_"ST"_MPICS_30
"RTN","MPIFVTQ",71,0)
 S RDF=RDF_MPIRS_"@00105"_MPICS_"ST"_MPICS_19_MPIRS_"@00108.2"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00169"_MPICS_"ST"_MPICS_30_MPIRS_"@00740"_MPICS_"ST"_MPICS_12
"RTN","MPIFVTQ",72,0)
 S RDF=RDF_MPIRS_"@00108.3"_MPICS_"ST"_MPICS_16_MPIRS_"@00111"_MPICS_"ST"_MPICS_1_MPIRS_"@00126.1"_MPICS_"ST"_MPICS_30_MPIRS_"@00126.2"_MPICS_"ST"_MPICS_3
"RTN","MPIFVTQ",73,0)
 S RDF=RDF_MPIRS_"@00108.5"_MPICS_"ST"_MPICS_20_MPIRS_"@00108.4"_MPICS_"ST"_MPICS_20_MPIRS_"@00109.1"_MPICS_"ST"_MPICS_30_MPIRS_"@ZEL6"_MPICS_"ST"_MPICS_9
"RTN","MPIFVTQ",74,0)
 S RDF=RDF_MPIRS_"@CASE#"_MPICS_"ST"_MPICS_69
"RTN","MPIFVTQ",75,0)
 ; ^ fields to be returned in query response
"RTN","MPIFVTQ",76,0)
 S QUERY="VTQ"_MPIHL("FS")_MPIIT_MPIHL("FS")_"T"_MPIHL("FS")_MPIQRYNM_MPIHL("FS")_"ICN"_MPIHL("FS")
"RTN","MPIFVTQ",77,0)
 ;
"RTN","MPIFVTQ",78,0)
 I MPISND["00108" S MPINM=$P(MPITEST,"^") D NAME^VAFCPID2(MPIIT,.MPINM) ;agressive name reformatting
"RTN","MPIFVTQ",79,0)
 ; ^ sending all or part of name
"RTN","MPIFVTQ",80,0)
 I MPISND["00108.1" S MPI2NM=$P(MPINM,",",1) I MPI2NM'="" S QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFVTQ",81,0)
 ; ^ sending last name
"RTN","MPIFVTQ",82,0)
 I MPISND["00122"&(MPISSN'="")&(MPISSN'["P") S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_MPISSN
"RTN","MPIFVTQ",83,0)
 ; ^ sending SSN
"RTN","MPIFVTQ",84,0)
 I MPISND["00108.2" S MPI1NM=$P(MPINM,",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFVTQ",85,0)
 ; ^ sending first name
"RTN","MPIFVTQ",86,0)
 I MPISND["00110" D
"RTN","MPIFVTQ",87,0)
 .S MPIDOB=$P(MPITEST,"^",3)
"RTN","MPIFVTQ",88,0)
 .Q:MPIDOB=""
"RTN","MPIFVTQ",89,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIDOB)
"RTN","MPIFVTQ",90,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFVTQ",91,0)
 .S MPIMOD=MPIDOB#100
"RTN","MPIFVTQ",92,0)
 .I MPIQRYNM'="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"GN"_MPICS_MPIHDOB
"RTN","MPIFVTQ",93,0)
 .I MPIQRYNM="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",94,0)
 .S MPIXDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",95,0)
 .S QUEDOB=$S(MPIMOD>0:MPIXDOB,1:MPIZDOB)
"RTN","MPIFVTQ",96,0)
 .S QUERY=QUERY_QUEDOB
"RTN","MPIFVTQ",97,0)
 ; ^ sending date of birth
"RTN","MPIFVTQ",98,0)
 I $D(MPIDTH),(MPISND["00740")&(MPIDTH'="") S MPIHDTH=$$HLDATE^HLFNC(MPIDTH),QUERY=QUERY_MPICS_"AND"_MPIRS_"@00740"_MPICS_"EQ"_MPICS_MPIHDTH
"RTN","MPIFVTQ",99,0)
 ; ^ sending date of death
"RTN","MPIFVTQ",100,0)
 I MPISND["00111" S:$G(^DPT(MPIIT,0))'="" MPISEX=$P(^DPT(MPIIT,0),"^",2) I MPISEX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00111"_MPICS_"EQ"_MPICS_MPISEX
"RTN","MPIFVTQ",101,0)
 ; ^ sending Sex
"RTN","MPIFVTQ",102,0)
 I MPISND["00108.4" S MPI1NM=$P(MPINM,",",2),MPINMSFX=$P(MPI1NM," ",3) I MPINMSFX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.4"_MPICS_"EQ"_MPICS_MPINMSFX
"RTN","MPIFVTQ",103,0)
 ; ^ sending suffix name
"RTN","MPIFVTQ",104,0)
 I MPISND["00126.1" S MPIPOB=$P(^DPT(MPIIT,0),"^",11) I MPIPOB'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.1"_MPICS_"EQ"_MPICS_MPIPOB
"RTN","MPIFVTQ",105,0)
 ; send place of birth - city
"RTN","MPIFVTQ",106,0)
 I MPISND["00126.2" S MPIPOBS=$P(^DPT(MPIIT,0),"^",12) I MPIPOBS'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.2"_MPICS_"EQ"_MPICS_MPIPOBS
"RTN","MPIFVTQ",107,0)
 ; send place of birth - state
"RTN","MPIFVTQ",108,0)
 I MPISND["00108.3" S MPIMN=$P($P(MPINM,",",2)," ",2) I MPIMN'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.3"_MPICS_"EQ"_MPICS_MPIMN
"RTN","MPIFVTQ",109,0)
 ; send middle name
"RTN","MPIFVTQ",110,0)
 ;
"RTN","MPIFVTQ",111,0)
 I $G(MPIOUT(0))="" S MPIOUT(0)="1^good data"
"RTN","MPIFVTQ",112,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFVTQ",113,0)
 S MPIOUT(3)=RDF
"RTN","MPIFVTQ",114,0)
 Q
"VER")
8.0^22.0
**END**
**END**
