Released PSD*3*59 SEQ #52
Extracted from mail message
**KIDS**:PSD*3.0*59^

**INSTALL NAME**
PSD*3.0*59
"BLD",6442,0)
PSD*3.0*59^CONTROLLED SUBSTANCES^0^3070503^y
"BLD",6442,1,0)
^^5^5^3060117^
"BLD",6442,1,1,0)
This patch will correct two problems.  The first problem deals with
"BLD",6442,1,2,0)
some PSD variables lingering after exiting the application 
"BLD",6442,1,3,0)
resulting in the wrong selection of the master or satellite vault.
"BLD",6442,1,4,0)
The second problem is a result of two users being able to process
"BLD",6442,1,5,0)
the same controlled substance request at the same time.
"BLD",6442,4,0)
^9.64PA^^
"BLD",6442,6.3)
1
"BLD",6442,"KRN",0)
^9.67PA^8989.52^19
"BLD",6442,"KRN",.4,0)
.4
"BLD",6442,"KRN",.401,0)
.401
"BLD",6442,"KRN",.402,0)
.402
"BLD",6442,"KRN",.403,0)
.403
"BLD",6442,"KRN",.5,0)
.5
"BLD",6442,"KRN",.84,0)
.84
"BLD",6442,"KRN",3.6,0)
3.6
"BLD",6442,"KRN",3.8,0)
3.8
"BLD",6442,"KRN",9.2,0)
9.2
"BLD",6442,"KRN",9.8,0)
9.8
"BLD",6442,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",6442,"KRN",9.8,"NM",1,0)
PSDDWK^^0^B25989170
"BLD",6442,"KRN",9.8,"NM",2,0)
PSDSET^^0^B7218792
"BLD",6442,"KRN",9.8,"NM","B","PSDDWK",1)

"BLD",6442,"KRN",9.8,"NM","B","PSDSET",2)

"BLD",6442,"KRN",19,0)
19
"BLD",6442,"KRN",19.1,0)
19.1
"BLD",6442,"KRN",101,0)
101
"BLD",6442,"KRN",409.61,0)
409.61
"BLD",6442,"KRN",771,0)
771
"BLD",6442,"KRN",870,0)
870
"BLD",6442,"KRN",8989.51,0)
8989.51
"BLD",6442,"KRN",8989.52,0)
8989.52
"BLD",6442,"KRN",8994,0)
8994
"BLD",6442,"KRN","B",.4,.4)

"BLD",6442,"KRN","B",.401,.401)

"BLD",6442,"KRN","B",.402,.402)

"BLD",6442,"KRN","B",.403,.403)

"BLD",6442,"KRN","B",.5,.5)

"BLD",6442,"KRN","B",.84,.84)

"BLD",6442,"KRN","B",3.6,3.6)

"BLD",6442,"KRN","B",3.8,3.8)

"BLD",6442,"KRN","B",9.2,9.2)

"BLD",6442,"KRN","B",9.8,9.8)

"BLD",6442,"KRN","B",19,19)

"BLD",6442,"KRN","B",19.1,19.1)

"BLD",6442,"KRN","B",101,101)

"BLD",6442,"KRN","B",409.61,409.61)

"BLD",6442,"KRN","B",771,771)

"BLD",6442,"KRN","B",870,870)

"BLD",6442,"KRN","B",8989.51,8989.51)

"BLD",6442,"KRN","B",8989.52,8989.52)

"BLD",6442,"KRN","B",8994,8994)

"BLD",6442,"QUES",0)
^9.62^^
"BLD",6442,"REQB",0)
^9.611^^
"MBREQ")
0
"PKG",499,-1)
1^1
"PKG",499,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",499,20,0)
^9.402P^^
"PKG",499,22,0)
^9.49I^1^1
"PKG",499,22,1,0)
3.0^2970213^2981028^66481
"PKG",499,22,1,"PAH",1,0)
59^3070503^100104
"PKG",499,22,1,"PAH",1,1,0)
^^5^5^3070503
"PKG",499,22,1,"PAH",1,1,1,0)
This patch will correct two problems.  The first problem deals with
"PKG",499,22,1,"PAH",1,1,2,0)
some PSD variables lingering after exiting the application 
"PKG",499,22,1,"PAH",1,1,3,0)
resulting in the wrong selection of the master or satellite vault.
"PKG",499,22,1,"PAH",1,1,4,0)
The second problem is a result of two users being able to process
"PKG",499,22,1,"PAH",1,1,5,0)
the same controlled substance request at the same time.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSDDWK")
0^1^B25989170^B22797507
"RTN","PSDDWK",1,0)
PSDDWK ;BIR/JPW-Pharm Dispensing Worksheet ;6 July 94
"RTN","PSDDWK",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**59**;13 Feb 97;Build 1
"RTN","PSDDWK",3,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDDWK",4,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,1:0)
"RTN","PSDDWK",5,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"process/dispense narcotic supplies.",!!,"PSJ RPHARM or PSJ PHARM TECH security key required.",! K OK Q
"RTN","PSDDWK",6,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH Q
"RTN","PSDDWK",7,0)
 I '$O(^PSD(58.85,0)) W $C(7),!!,"There are no pending request orders.",!! Q
"RTN","PSDDWK",8,0)
 S (PSDNO,NOFLAG)=0
"RTN","PSDDWK",9,0)
ASKD ;ask dispensing location
"RTN","PSDDWK",10,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDDWK",11,0)
 I $P(PSDSITE,U,5) S OKD=1,NODED=^PSD(58.8,+PSDS,0) G SETD
"RTN","PSDDWK",12,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)=""M"":1,$P(^(0),""^"",2)=""S"":1,1:0)"
"RTN","PSDDWK",13,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=PSDSN
"RTN","PSDDWK",14,0)
 D ^DIC K DIC G:Y<0 END
"RTN","PSDDWK",15,0)
 ;set PSDS=disp.site,PSDM=ask mfg/lot#/exp.date,SITE=inpat.site,PSDAG=auto gen.disp.#s,PSDRG=using form 10-179,PSDGS=print green sheet
"RTN","PSDDWK",16,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),NODED=Y(0)
"RTN","PSDDWK",17,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDDWK",18,0)
SETD S PSDM=+$P(NODED,"^",5),PSDAG=+$P($G(^PSD(58.8,+PSDS,2)),"^")
"RTN","PSDDWK",19,0)
 S PSDRG=+$P($G(^PSD(58.8,+PSDS,2)),"^",5),PSDGS=+$P($G(^PSD(58.8,+PSDS,2)),"^",6)
"RTN","PSDDWK",20,0)
 I '$D(^PSD(58.85,"AW",+PSDS)) D MSG G END
"RTN","PSDDWK",21,0)
ASKM ;ask method of dispensing - by worksheet or individual request
"RTN","PSDDWK",22,0)
 K DA,DIR,DIRUT S DIR(0)="SOB^W:Worksheet;R:Individual Request",DIR("A")="Dispensing Method"
"RTN","PSDDWK",23,0)
 S DIR("?",1)="Enter 'W' to dispense by last worksheet printed, enter 'R' to",DIR("?")="dispense by individual request, or '^' to quit"
"RTN","PSDDWK",24,0)
 D ^DIR K DIR G:$D(DIRUT) END S ANS=Y
"RTN","PSDDWK",25,0)
 S PSDOUT=0 N X,X1 D SIG^XUSESIG G:X1="" END D:ANS="R" REQ D:ANS="W" WK
"RTN","PSDDWK",26,0)
 I 'NOFLAG D MSG
"RTN","PSDDWK",27,0)
END K %,%H,%I,%ZIS,ACT,ALL,ANS,BAL,CNT,COMM,DA,DIC,DIE,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,EXP,EXPD,FLAG
"RTN","PSDDWK",28,0)
 K LN,LOOP,LOT,MFG,MSG,NAOU,NAOUN,NBKU,NEW,NODE,NODED,NOFLAG,NPKG,NSITE,OK,OKD,ORD,ORDN,ORDS,ORDSN,PAT,PSDLCK
"RTN","PSDDWK",29,0)
 K PRT,PSD,PSDAG,PSDAGN,PSDBY,PSDBYN,PSDDT,PSDG,PSDGS,PSDGSN,PSDIO,PSDLES,PSDM,PSDMN,PSDN,PSDNA,PSDNO,PSDOUT,PSDPN
"RTN","PSDDWK",30,0)
 K PSDR,PSDRN,PSDREC,PSDRG,PSDRGN,PSDRN,PSDS,PSDSN,PSDT,PSDUZA,QTY,REQ,REQD,REQDT,SITE,STAT,TECH,TEXT,WORD,X,Y
"RTN","PSDDWK",31,0)
 Q
"RTN","PSDDWK",32,0)
WK ;compile worksheet dispensing data
"RTN","PSDDWK",33,0)
 W !!,"Accessing worksheet information..."
"RTN","PSDDWK",34,0)
 F PSD=0:0 S PSD=$O(^PSD(58.85,"AW",+PSDS,PSD)) Q:('PSD)!(PSDOUT)  D
"RTN","PSDDWK",35,0)
 .F PSDN=0:0 S PSDN=$O(^PSD(58.85,"AW",+PSDS,PSD,PSDN)) Q:('PSDN)!(PSDOUT)  I $D(^PSD(58.85,PSDN,0)) D SET Q:PSDLCK  D:STAT<3&($D(^PSD(58.8,+$G(ORDS),1,+$G(PSDR)))) ^PSDDWK1,PSDLCK Q:PSDOUT  ;; PSD*3*59 ADDED PSDLCK
"RTN","PSDDWK",36,0)
 Q
"RTN","PSDDWK",37,0)
REQ ;dispense by individual request
"RTN","PSDDWK",38,0)
 W !!,"Accessing worksheet information..."
"RTN","PSDDWK",39,0)
 F PSD=0:0 S PSD=$O(^PSD(58.85,"AW",+PSDS,PSD)) Q:'PSD  F PSDN=0:0 S PSDN=$O(^PSD(58.85,"AW",+PSDS,PSD,PSDN)) Q:'PSDN  I $D(^PSD(58.85,PSDN,0)),$P(^(0),"^",7)<3 S NOFLAG=1
"RTN","PSDDWK",40,0)
 Q:'NOFLAG
"RTN","PSDDWK",41,0)
 K DA,DIC W ! S DIC=58.85,DIC(0)="QEA",DIC("A")="Select Request #: ",DIC("S")="I $P(^(0),""^"",2)=+PSDS,$P(^(0),""^"",7)<3" D ^DIC K DIC Q:Y<0  S PSDN=+Y D SET
"RTN","PSDDWK",42,0)
 I PSDLCK W !!,"This request is currently being processed by ",$P(^VA(200,$P(^XTMP("PSDLCK",PSDN,0),"^",3),0),"^") G REQ  ;; PSD*3*59 LOCK MESSAGE
"RTN","PSDDWK",43,0)
 I STAT>2 W !!,"The status of this request is "_$P($G(^PSD(58.82,STAT,0)),"^")_".",!,"You cannot edit this request using this option.",! G REQ
"RTN","PSDDWK",44,0)
 D ^PSDDWK1,PSDLCK Q:PSDOUT  ;; PSD*3*59 ADDED PSDLCK
"RTN","PSDDWK",45,0)
 G REQ
"RTN","PSDDWK",46,0)
SET ;sets data for display/editing
"RTN","PSDDWK",47,0)
 Q:'$D(^PSD(58.85,PSDN,0))  S NODE=^(0),(NSITE,PSDMN,PSDAGN,PSDRGN,PSDGSN)=0
"RTN","PSDDWK",48,0)
 ;; PSD*3*59  LOCK RECORD
"RTN","PSDDWK",49,0)
 S PSDLCK=0
"RTN","PSDDWK",50,0)
 S STAT=+$P(NODE,"^",7) Q:STAT>2  S PSDRN=+$P(NODE,"^",5)
"RTN","PSDDWK",51,0)
 L +^PSD(58.85,PSDN):0
"RTN","PSDDWK",52,0)
 S:'$T PSDLCK=1 Q:PSDLCK
"RTN","PSDDWK",53,0)
 S ^XTMP("PSDLCK",PSDN,0)=$$FMADD^XLFDT(DT,1,0,0,0)_"^"_DT_"^"_DUZ ;; END PSD*3*59
"RTN","PSDDWK",54,0)
 S NAOU=+$P(NODE,"^",3),NAOUN=$S($P($G(^PSD(58.8,NAOU,0)),"^")]"":$P(^(0),"^"),1:"ZZ/"_NAOU)
"RTN","PSDDWK",55,0)
 S PSDR=+$P(NODE,"^",4),PSDRN=$S($P($G(^PSDRUG(PSDR,0)),"^")]"":$P(^(0),"^"),1:"ZZ/"_PSDR)
"RTN","PSDDWK",56,0)
 S ORDS=+$P(NODE,"^",2),ORDSN=$P($G(^PSD(58.8,+ORDS,0)),"^")
"RTN","PSDDWK",57,0)
 S PSDUZA=+$P(NODE,"^",19)
"RTN","PSDDWK",58,0)
 S REQ=+$P(NODE,"^",5),REQDT=$P(NODE,"^",18) I REQDT S Y=$E(REQDT,1,7) X ^DD("DD") S REQD=Y
"RTN","PSDDWK",59,0)
 S QTY=$S($P(NODE,"^",17):$P(NODE,"^",17),1:$P(NODE,"^",6)),PSDPN=$P(NODE,"^",15),PSDT=$P(NODE,"^",14) I PSDT S Y=$E(PSDT,1,7) X ^DD("DD") S PSDDT=Y
"RTN","PSDDWK",60,0)
 S ORD=+$P(NODE,"^",12),ORDN=$P($G(^VA(200,+ORD,0)),"^"),PSDBY=+$P(NODE,"^",13),PSDBYN="" I PSDBY S PSDBYN=$P($G(^VA(200,PSDBY,0)),"^")
"RTN","PSDDWK",61,0)
 S PAT=$P($G(^PSD(58.85,PSDN,2)),U,3)
"RTN","PSDDWK",62,0)
 I $D(^XUSEC("PSJ RPHARM",DUZ)),'PSDBY S PSDBY=DUZ,PSDBYN=$P($G(^VA(200,PSDBY,0)),"^")
"RTN","PSDDWK",63,0)
 S (MFG,LOT,EXP,EXPD,NBKU,NPKG)=""
"RTN","PSDDWK",64,0)
 I $D(^PSD(58.8,+ORDS,1,PSDR,0)) S MFG=$P(^(0),"^",10),LOT=$P(^(0),"^",11),EXP=$P(^(0),"^",12),NBKU=$P(^(0),"^",8),NPKG=+$P(^(0),"^",9) I EXP S Y=EXP X ^DD("DD") S EXPD=Y
"RTN","PSDDWK",65,0)
 Q
"RTN","PSDDWK",66,0)
MSG W $C(7),!!,"There are no pending CS requests for ",PSDSN,".",!
"RTN","PSDDWK",67,0)
 W !,"Press <RET> to return to the menu" R X:DTIME W !!
"RTN","PSDDWK",68,0)
 Q
"RTN","PSDDWK",69,0)
PSDLCK ;; PSD*3*59 CLEAR LOCKS FOR THIS ORDER
"RTN","PSDDWK",70,0)
 L -^PSD(58.85,PSDN)
"RTN","PSDDWK",71,0)
 K ^XTMP("PSDLCK",PSDN),STAT
"RTN","PSDDWK",72,0)
 Q
"RTN","PSDSET")
0^2^B7218792^B7164276
"RTN","PSDSET",1,0)
PSDSET ;BIR/JPW-Check Inpatient Site for CS Use ;6 July 94
"RTN","PSDSET",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**59**;13 Feb 97;Build 1
"RTN","PSDSET",3,0)
SITE ;checks for valid cs inpatient site
"RTN","PSDSET",4,0)
 K XQUIT,X,PSDA,LOC I '$D(^PS(59.4,"B")) D  G:$G(XQUIT)="" END1 G END
"RTN","PSDSET",5,0)
 .W ! K DA,DIC,DIE,DLAYGO,DR S (DIC,DIE,DLAYGO)=59.4,DIC("A")="Enter Controlled Substances Inpatient Site Name: ",DIC(0)="QEAL" D ^DIC K DIC,DLAYGO I Y<0 S XQUIT="" Q
"RTN","PSDSET",6,0)
 .S (DA,PSDA)=+Y,DR="31///1" D ^DIE K DIE,DR S PSDSITE=PSDA
"RTN","PSDSET",7,0)
LOOP S (CNT,LOC,PSDA)=0 F PSDA=0:0 S PSDA=$O(^PS(59.4,PSDA)) Q:'PSDA  S CNT=CNT+1 S:$P(^PS(59.4,PSDA,0),"^",31) LOC=LOC+1,LOC(+PSDA)=""
"RTN","PSDSET",8,0)
CHK I LOC=1 S PSDSITE=+$O(LOC(0)) W !!,"Controlled Substances Inpatient Site Name: "_$P(^PS(59.4,PSDSITE,0),"^")
"RTN","PSDSET",9,0)
 I 'LOC,CNT=1 S PSDA=$O(^PS(59.4,0)),$P(^(PSDA,0),"^",31)=1,PSDSITE=+^(0) W !!,"Controlled Substances Inpatient Site Name: "_$P(^(0),"^")
"RTN","PSDSET",10,0)
 I CNT>1,LOC'=1 D  G:'$G(PSDSITE) END1
"RTN","PSDSET",11,0)
 .K DIC,DLAYGO S (DIC,DLAYGO)=59.4,DIC("A")="Enter Controlled Substances Inpatient Site Name: ",DIC(0)="QEA" S:LOC>1 DIC("S")="I $P(^(0),""^"",31)" S:LOC=0 DIC(0)="QEAL" D ^DIC K DIC,DLAYGO
"RTN","PSDSET",12,0)
 .S:Y<0 XQUIT="" Q:Y<0  S $P(^PS(59.4,+Y,0),"^",31)=1,PSDSITE=+Y_"^M"
"RTN","PSDSET",13,0)
END K LOC,PSDS,PSDSN,PSDCHO D EN^PSDSP
"RTN","PSDSET",14,0)
 I $G(PSDS) S $P(PSDSITE,U,3)=PSDS,$P(PSDSITE,U,4)=$P($G(^PSD(58.8,+PSDS,0)),U),$P(PSDSITE,U,5)=1 Q
"RTN","PSDSET",15,0)
 ;Set up Default Dispensing Site
"RTN","PSDSET",16,0)
 D:'$P(PSDSITE,U,3)&($P($G(XQY0),U)'["NUR")&($P($G(XQY0),U)'["INS")
"RTN","PSDSET",17,0)
 .;Make sure there's at least one Master Vault
"RTN","PSDSET",18,0)
 .Q:'$O(^PSD(58.8,"ASITE",+PSDSITE,"M",0))
"RTN","PSDSET",19,0)
 .S DIC="^PSD(58.8,",DIC(0)="AEQ"
"RTN","PSDSET",20,0)
 .S DIC("A")="Select Default Dispensing Site: "
"RTN","PSDSET",21,0)
 .S DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$S($P($G(^(0)),U,2)[""M"":1,$P($G(^(0)),U,2)[""S"":1,1:0),$S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0)"
"RTN","PSDSET",22,0)
 .W ! D ^DIC K DIC S:$D(DTOUT) XQUIT="" Q:Y<0
"RTN","PSDSET",23,0)
 .S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=$P(Y,U,2)
"RTN","PSDSET",24,0)
END1 K CNT,DA,DIC,DIE,DLAYGO,DR,DTOUT,DUOUT,LOC,PSDA,PSDS,PSDSN,X,Y
"VER")
8.0^22.0
"BLD",6442,6)
^52
**END**
**END**
