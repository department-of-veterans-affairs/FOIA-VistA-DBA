Released PSD*3*41 SEQ #33
Extracted from mail message
**KIDS**:PSD*3.0*41^

**INSTALL NAME**
PSD*3.0*41
"BLD",4351,0)
PSD*3.0*41^CONTROLLED SUBSTANCES^0^3030424^y
"BLD",4351,1,0)
^9.61A^26^26^3030422^^^^
"BLD",4351,1,1,0)
The Office of the Medical Inspector, in collaboration with the Narcotics 
"BLD",4351,1,2,0)
Diversion Advisory Group, requested development of tools to support and
"BLD",4351,1,3,0)
monitor Pharmacy Service Schedule II narcotics inventory management to be
"BLD",4351,1,4,0)
distributed to all medical centers.  This enhancement includes a new
"BLD",4351,1,5,0)
standalone CS Monitoring Menu [PSD NM MENU] option containing reports
"BLD",4351,1,6,0)
derived from VA FileMan templates used during site visits that were found
"BLD",4351,1,7,0)
to be valuable in assisting sites with the monitoring of Schedule II
"BLD",4351,1,8,0)
narcotics prescriptions.  These reports also allow for the monitoring of
"BLD",4351,1,9,0)
controlled substance schedules C-II through C-V.  
"BLD",4351,1,10,0)
  
"BLD",4351,1,11,0)
This patch includes a new standalone menu option entitled CS Monitoring
"BLD",4351,1,12,0)
Menu [PSD NM MENU] option that will not be attached to a menu. IRM
"BLD",4351,1,13,0)
support personnel will need to assign the menu to the Narcotics Inspectors
"BLD",4351,1,14,0)
and Pharmacy Managers at the site.  
"BLD",4351,1,15,0)
  
"BLD",4351,1,16,0)
Kernel's Option Access by user [XUOPTWHO] option will be attached to the CS
"BLD",4351,1,17,0)
Monitoring Menu [PSD NM MENU] option upon patch installation. The
"BLD",4351,1,18,0)
following new options are brought in with the menu: 
"BLD",4351,1,19,0)
    
"BLD",4351,1,20,0)
     CS Application Security Key Report [PSD NM SECURITY KEY] option
"BLD",4351,1,21,0)
     CS Balance Adjustments Report [PSD NM CS ADJ] option
"BLD",4351,1,22,0)
     CS RXs by Same Person Report [PSD NM RX SAME PERSON] option
"BLD",4351,1,23,0)
     Label Reprint for CS RXs Report [PSD NM RX REPRINT] option
"BLD",4351,1,24,0)
     Partial Request for CS RXs Report [PSD NM RX PARTIAL] option
"BLD",4351,1,25,0)
     Patients Without VA Visit Report [PSD NM RX WITHOUT VA] option
"BLD",4351,1,26,0)
   
"BLD",4351,4,0)
^9.64PA^^
"BLD",4351,"KRN",0)
^9.67PA^8989.52^20
"BLD",4351,"KRN",.4,0)
.4
"BLD",4351,"KRN",.4,"NM",0)
^9.68A^^0
"BLD",4351,"KRN",.401,0)
.401
"BLD",4351,"KRN",.401,"NM",0)
^9.68A^^0
"BLD",4351,"KRN",.402,0)
.402
"BLD",4351,"KRN",.402,"NM",0)
^9.68A^^0
"BLD",4351,"KRN",.403,0)
.403
"BLD",4351,"KRN",.5,0)
.5
"BLD",4351,"KRN",.84,0)
.84
"BLD",4351,"KRN",3.6,0)
3.6
"BLD",4351,"KRN",3.8,0)
3.8
"BLD",4351,"KRN",9.2,0)
9.2
"BLD",4351,"KRN",9.8,0)
9.8
"BLD",4351,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",4351,"KRN",9.8,"NM",1,0)
PSDNMKY^^0^B16659852
"BLD",4351,"KRN",9.8,"NM",2,0)
PSDNMU^^0^B21488680
"BLD",4351,"KRN",9.8,"NM",3,0)
PSDNMBA^^0^B19229977
"BLD",4351,"KRN",9.8,"NM",4,0)
PSDNMPR^^0^B20437425
"BLD",4351,"KRN",9.8,"NM",5,0)
PSDNMRP^^0^B20540701
"BLD",4351,"KRN",9.8,"NM",6,0)
PSDNMSP^^0^B18105679
"BLD",4351,"KRN",9.8,"NM",7,0)
PSDNMWE^^0^B36776333
"BLD",4351,"KRN",9.8,"NM","B","PSDNMBA",3)

"BLD",4351,"KRN",9.8,"NM","B","PSDNMKY",1)

"BLD",4351,"KRN",9.8,"NM","B","PSDNMPR",4)

"BLD",4351,"KRN",9.8,"NM","B","PSDNMRP",5)

"BLD",4351,"KRN",9.8,"NM","B","PSDNMSP",6)

"BLD",4351,"KRN",9.8,"NM","B","PSDNMU",2)

"BLD",4351,"KRN",9.8,"NM","B","PSDNMWE",7)

"BLD",4351,"KRN",19,0)
19
"BLD",4351,"KRN",19,"NM",0)
^9.68A^9^8
"BLD",4351,"KRN",19,"NM",1,0)
PSD NM MENU^^0
"BLD",4351,"KRN",19,"NM",2,0)
PSD NM CS ADJ^^0
"BLD",4351,"KRN",19,"NM",4,0)
PSD NM RX PARTIAL^^0
"BLD",4351,"KRN",19,"NM",5,0)
PSD NM RX REPRINT^^0
"BLD",4351,"KRN",19,"NM",6,0)
PSD NM RX SAME PERSON^^0
"BLD",4351,"KRN",19,"NM",7,0)
PSD NM RX WITHOUT VA^^0
"BLD",4351,"KRN",19,"NM",8,0)
PSD NM SECURITY KEY^^0
"BLD",4351,"KRN",19,"NM",9,0)
XUOPTWHO^^4^
"BLD",4351,"KRN",19,"NM","B","PSD NM CS ADJ",2)

"BLD",4351,"KRN",19,"NM","B","PSD NM MENU",1)

"BLD",4351,"KRN",19,"NM","B","PSD NM RX PARTIAL",4)

"BLD",4351,"KRN",19,"NM","B","PSD NM RX REPRINT",5)

"BLD",4351,"KRN",19,"NM","B","PSD NM RX SAME PERSON",6)

"BLD",4351,"KRN",19,"NM","B","PSD NM RX WITHOUT VA",7)

"BLD",4351,"KRN",19,"NM","B","PSD NM SECURITY KEY",8)

"BLD",4351,"KRN",19,"NM","B","XUOPTWHO",9)

"BLD",4351,"KRN",19.1,0)
19.1
"BLD",4351,"KRN",101,0)
101
"BLD",4351,"KRN",409.61,0)
409.61
"BLD",4351,"KRN",771,0)
771
"BLD",4351,"KRN",869.2,0)
869.2
"BLD",4351,"KRN",870,0)
870
"BLD",4351,"KRN",8989.51,0)
8989.51
"BLD",4351,"KRN",8989.52,0)
8989.52
"BLD",4351,"KRN",8994,0)
8994
"BLD",4351,"KRN","B",.4,.4)

"BLD",4351,"KRN","B",.401,.401)

"BLD",4351,"KRN","B",.402,.402)

"BLD",4351,"KRN","B",.403,.403)

"BLD",4351,"KRN","B",.5,.5)

"BLD",4351,"KRN","B",.84,.84)

"BLD",4351,"KRN","B",3.6,3.6)

"BLD",4351,"KRN","B",3.8,3.8)

"BLD",4351,"KRN","B",9.2,9.2)

"BLD",4351,"KRN","B",9.8,9.8)

"BLD",4351,"KRN","B",19,19)

"BLD",4351,"KRN","B",19.1,19.1)

"BLD",4351,"KRN","B",101,101)

"BLD",4351,"KRN","B",409.61,409.61)

"BLD",4351,"KRN","B",771,771)

"BLD",4351,"KRN","B",869.2,869.2)

"BLD",4351,"KRN","B",870,870)

"BLD",4351,"KRN","B",8989.51,8989.51)

"BLD",4351,"KRN","B",8989.52,8989.52)

"BLD",4351,"KRN","B",8994,8994)

"BLD",4351,"QUES",0)
^9.62^^
"BLD",4351,"REQB",0)
^9.611^^0
"BLD",4351,"REQG",0)
^9.611^^
"KRN",19,1392,-1)
4^9
"KRN",19,1392,0)
XUOPTWHO
"KRN",19,18805,-1)
0^1
"KRN",19,18805,0)
PSD NM MENU^CS Monitoring Menu^^M^^^^^^^^CONTROLLED SUBSTANCES
"KRN",19,18805,1,0)
^19.06^8^8^3030329^^^^
"KRN",19,18805,1,1,0)
This standalone menu contains CS Monitoring reports to help
"KRN",19,18805,1,2,0)
facilitate the monitoring of CS and Schedule II narcotics.  The menu 
"KRN",19,18805,1,3,0)
should be assigned to the appropriate Narcotic Inspectors and 
"KRN",19,18805,1,4,0)
Pharmacy Managers at the site. 
"KRN",19,18805,1,5,0)
 
"KRN",19,18805,1,6,0)
 
"KRN",19,18805,1,7,0)
IA 3882 - Gives permission for Kernel's Option Access by User [XUOPTWHO]
"KRN",19,18805,1,8,0)
           option to be included on this menu.
"KRN",19,18805,10,0)
^19.01IP^7^7
"KRN",19,18805,10,1,0)
18806
"KRN",19,18805,10,1,"^")
PSD NM RX REPRINT
"KRN",19,18805,10,2,0)
18807
"KRN",19,18805,10,2,"^")
PSD NM RX PARTIAL
"KRN",19,18805,10,3,0)
18808
"KRN",19,18805,10,3,"^")
PSD NM CS ADJ
"KRN",19,18805,10,4,0)
18809
"KRN",19,18805,10,4,"^")
PSD NM RX SAME PERSON
"KRN",19,18805,10,5,0)
18810
"KRN",19,18805,10,5,"^")
PSD NM RX WITHOUT VA
"KRN",19,18805,10,6,0)
18811
"KRN",19,18805,10,6,"^")
PSD NM SECURITY KEY
"KRN",19,18805,10,7,0)
1392
"KRN",19,18805,10,7,"^")
XUOPTWHO
"KRN",19,18805,99)
59249,44673
"KRN",19,18805,99.1)
59172,37813
"KRN",19,18805,"U")
CS MONITORING MENU
"KRN",19,18806,-1)
0^5
"KRN",19,18806,0)
PSD NM RX REPRINT^Label Reprint for CS RXs Report^^A^^^^^^^^CONTROLLED SUBSTANCES^^1
"KRN",19,18806,1,0)
^19.06^6^6^3030205^^^
"KRN",19,18806,1,1,0)
This option lists controlled substance prescriptions for which a prescription
"KRN",19,18806,1,2,0)
label reprint was requested.  An individual could fill the same prescription 
"KRN",19,18806,1,3,0)
more than once and be diverting prescription drugs.  Narcotic Inspectors and
"KRN",19,18806,1,4,0)
Pharmacy managers should monitor this activity. 
"KRN",19,18806,1,5,0)
 
"KRN",19,18806,1,6,0)
This report should be queued to run during non-peak hours.
"KRN",19,18806,20)
D ST^PSDNMRP
"KRN",19,18806,"U")
LABEL REPRINT FOR CS RXS REPOR
"KRN",19,18807,-1)
0^4
"KRN",19,18807,0)
PSD NM RX PARTIAL^Partial Request for CS RXs Report^^A^^^^^^^^CONTROLLED SUBSTANCES^^1
"KRN",19,18807,1,0)
^19.06^6^6^3030205^^
"KRN",19,18807,1,1,0)
This option lists controlled substance prescriptions for which a prescription
"KRN",19,18807,1,2,0)
partial fill was requested.  An individual could partially fill the same
"KRN",19,18807,1,3,0)
prescription more than once and be diverting prescription drugs.  Narcotic
"KRN",19,18807,1,4,0)
Inspectors and Pharmacy managers should monitor this activity. 
"KRN",19,18807,1,5,0)
 
"KRN",19,18807,1,6,0)
This report should be queued to run during non-peak hours.
"KRN",19,18807,20)
D ST^PSDNMPR
"KRN",19,18807,"U")
PARTIAL REQUEST FOR CS RXS REP
"KRN",19,18808,-1)
0^2
"KRN",19,18808,0)
PSD NM CS ADJ^CS Balance Adjustments Report^^A^^^^^^^^CONTROLLED SUBSTANCES^^1
"KRN",19,18808,1,0)
^19.06^5^5^3030204^^^^
"KRN",19,18808,1,1,0)
This option lists Drug Accountability Transactions in which the Controlled
"KRN",19,18808,1,2,0)
Substance vault inventory balance was adjusted manually during the date range
"KRN",19,18808,1,3,0)
entered.  The adjuster and reason will display on the report for the
"KRN",19,18808,1,4,0)
Narcotic Inspectors and Pharmacy Managers to review regularly for
"KRN",19,18808,1,5,0)
appropriateness and authorization. 
"KRN",19,18808,20)
D ST^PSDNMBA
"KRN",19,18808,"U")
CS BALANCE ADJUSTMENTS REPORT
"KRN",19,18809,-1)
0^6
"KRN",19,18809,0)
PSD NM RX SAME PERSON^CS RXs by Same Person Report^^A^^^^^^^^CONTROLLED SUBSTANCES^^1
"KRN",19,18809,1,0)
^19.06^7^7^3030204^^^^
"KRN",19,18809,1,1,0)
This option lists CS prescriptions that were entered, finished and
"KRN",19,18809,1,2,0)
released by the same person for the date range entered.  Different pharmacists
"KRN",19,18809,1,3,0)
in the prescription filling process normally perform these functions.  
"KRN",19,18809,1,4,0)
Although frequently necessary on off-shifts and weekends, inspectors and
"KRN",19,18809,1,5,0)
pharmacy managers should monitor this activity. 
"KRN",19,18809,1,6,0)
    
"KRN",19,18809,1,7,0)
This report should be queue to run during non-peak hours.
"KRN",19,18809,20)
D ST^PSDNMSP
"KRN",19,18809,"U")
CS RXS BY SAME PERSON REPORT
"KRN",19,18810,-1)
0^7
"KRN",19,18810,0)
PSD NM RX WITHOUT VA^Patients Without VA Visit Report^^A^^^^^^^^CONTROLLED SUBSTANCES^^1
"KRN",19,18810,1,0)
^19.06^11^11^3030211^^^^
"KRN",19,18810,1,1,0)
This option lists patients that receive prescriptions but have not had a
"KRN",19,18810,1,2,0)
VA clinic visit within one year of a RX release date for the date range
"KRN",19,18810,1,3,0)
entered.  Excluding RXs released on the same day as a discharge and within
"KRN",19,18810,1,4,0)
a user defined discharge date range.  Patients in Fee Basis and Aid and
"KRN",19,18810,1,5,0)
Attendance programs may be included on the list and should be reviewed.
"KRN",19,18810,1,6,0)
A message will display for RXs that meet the sort criteria and were
"KRN",19,18810,1,7,0)
released after the entered date of death for that patient. 
"KRN",19,18810,1,8,0)
This lists represents a potential diversion tactic that could be 
"KRN",19,18810,1,9,0)
employed to prevent detection and suspicion. 
"KRN",19,18810,1,10,0)
    
"KRN",19,18810,1,11,0)
This report should be queued to run during non-peak hours.
"KRN",19,18810,20)
D ST^PSDNMWE
"KRN",19,18810,"U")
PATIENTS WITHOUT VA VISIT REPO
"KRN",19,18811,-1)
0^8
"KRN",19,18811,0)
PSD NM SECURITY KEY^CS Application Security Key Report^^A^^^^^^^^CONTROLLED SUBSTANCES^^1
"KRN",19,18811,1,0)
^19.06^5^5^3030203^^^
"KRN",19,18811,1,1,0)
This option list holders of the PSJ RPHARM and/or PSDMGR security keys. 
"KRN",19,18811,1,2,0)
Holders of these keys have the ability to override discrepancies, make
"KRN",19,18811,1,3,0)
controlled substance vault inventory adjustments and transfer medications
"KRN",19,18811,1,4,0)
between vaults.  The list requires routine monitoring and validation for
"KRN",19,18811,1,5,0)
accuracy. 
"KRN",19,18811,20)
D ST^PSDNMKY
"KRN",19,18811,"U")
CS APPLICATION SECURITY KEY RE
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",312,-1)
1^1
"PKG",312,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",312,22,0)
^9.49I^1^1
"PKG",312,22,1,0)
3.0^2970213^2970628^64
"PKG",312,22,1,"PAH",1,0)
41^3030424
"PKG",312,22,1,"PAH",1,1,0)
^^26^26^3030424
"PKG",312,22,1,"PAH",1,1,1,0)
The Office of the Medical Inspector, in collaboration with the Narcotics 
"PKG",312,22,1,"PAH",1,1,2,0)
Diversion Advisory Group, requested development of tools to support and
"PKG",312,22,1,"PAH",1,1,3,0)
monitor Pharmacy Service Schedule II narcotics inventory management to be
"PKG",312,22,1,"PAH",1,1,4,0)
distributed to all medical centers.  This enhancement includes a new
"PKG",312,22,1,"PAH",1,1,5,0)
standalone CS Monitoring Menu [PSD NM MENU] option containing reports
"PKG",312,22,1,"PAH",1,1,6,0)
derived from VA FileMan templates used during site visits that were found
"PKG",312,22,1,"PAH",1,1,7,0)
to be valuable in assisting sites with the monitoring of Schedule II
"PKG",312,22,1,"PAH",1,1,8,0)
narcotics prescriptions.  These reports also allow for the monitoring of
"PKG",312,22,1,"PAH",1,1,9,0)
controlled substance schedules C-II through C-V.  
"PKG",312,22,1,"PAH",1,1,10,0)
  
"PKG",312,22,1,"PAH",1,1,11,0)
This patch includes a new standalone menu option entitled CS Monitoring
"PKG",312,22,1,"PAH",1,1,12,0)
Menu [PSD NM MENU] option that will not be attached to a menu. IRM
"PKG",312,22,1,"PAH",1,1,13,0)
support personnel will need to assign the menu to the Narcotics Inspectors
"PKG",312,22,1,"PAH",1,1,14,0)
and Pharmacy Managers at the site.  
"PKG",312,22,1,"PAH",1,1,15,0)
  
"PKG",312,22,1,"PAH",1,1,16,0)
Kernel's Option Access by user [XUOPTWHO] option will be attached to the CS
"PKG",312,22,1,"PAH",1,1,17,0)
Monitoring Menu [PSD NM MENU] option upon patch installation. The
"PKG",312,22,1,"PAH",1,1,18,0)
following new options are brought in with the menu: 
"PKG",312,22,1,"PAH",1,1,19,0)
    
"PKG",312,22,1,"PAH",1,1,20,0)
     CS Application Security Key Report [PSD NM SECURITY KEY] option
"PKG",312,22,1,"PAH",1,1,21,0)
     CS Balance Adjustments Report [PSD NM CS ADJ] option
"PKG",312,22,1,"PAH",1,1,22,0)
     CS RXs by Same Person Report [PSD NM RX SAME PERSON] option
"PKG",312,22,1,"PAH",1,1,23,0)
     Label Reprint for CS RXs Report [PSD NM RX REPRINT] option
"PKG",312,22,1,"PAH",1,1,24,0)
     Partial Request for CS RXs Report [PSD NM RX PARTIAL] option
"PKG",312,22,1,"PAH",1,1,25,0)
     Patients Without VA Visit Report [PSD NM RX WITHOUT VA] option
"PKG",312,22,1,"PAH",1,1,26,0)
   
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","PSDNMBA")
0^3^B19229977
"RTN","PSDNMBA",1,0)
PSDNMBA ;DOIFO/CMS - CSM Balance Adjustments ;18 Dec 02
"RTN","PSDNMBA",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;*41*;13 Feb 97
"RTN","PSDNMBA",3,0)
 ;Reference to ^PSD(58.81 supported by IA #2808
"RTN","PSDNMBA",4,0)
 ;Reference to ^PSDRUG( supported by IA #221
"RTN","PSDNMBA",5,0)
 ;Reference to ^PSD(58.84 supported by IA #3485
"RTN","PSDNMBA",6,0)
 Q
"RTN","PSDNMBA",7,0)
 ;
"RTN","PSDNMBA",8,0)
ST ;CS Monitoring OPTION ENTRY
"RTN","PSDNMBA",9,0)
 N PSDA,PSDIDIV,PSDPLOC,PSDCII,PSDED,PSDOUT,PSDDTN,PSDSD,PSDSITE,X,Y,%
"RTN","PSDNMBA",10,0)
 N DIC,DIR,DIRUT,DIROUT,DTOUT,DUOUT,POP,ZTIO,ZTSAVE,ZTSK,ZTRTN,ZTDESC,%ZIS
"RTN","PSDNMBA",11,0)
 W !!,?5,"This report lists Drug Accountability Balance Adjustments"
"RTN","PSDNMBA",12,0)
 W !,?5,"made for the Inpatient Site Pharmacy Location(s) entered.",!!
"RTN","PSDNMBA",13,0)
 S PSDA=$O(^PSD(58.84,"B","BALANCE ADJUSTMENT",0))
"RTN","PSDNMBA",14,0)
 I 'PSDA W !!,"<< Drug Accountability Transaction Type, Balance Adjustment, not defined! >>" G END
"RTN","PSDNMBA",15,0)
 D INPS^PSDNMU I '$G(PSDIDIV)!($G(PSDOUT)) G END
"RTN","PSDNMBA",16,0)
 W ! S DIR("A")="Select 'ALL' "_$P(PSDIDIV,U,2)_" Pharmacy locations"
"RTN","PSDNMBA",17,0)
 S DIR("B")="Yes",DIR(0)="Y" D ^DIR I X="^"!($D(DTOUT)) G END
"RTN","PSDNMBA",18,0)
 I Y'=1 W ! D PLOC^PSDNMU I '$O(PSDPLOC(0))!($G(PSDOUT)) G END
"RTN","PSDNMBA",19,0)
 I Y=1 D PLOCA^PSDNMU
"RTN","PSDNMBA",20,0)
 ;
"RTN","PSDNMBA",21,0)
 S PSDDTN="Balance Adjustment" D DATE^PSDNMU I '$G(PSDSD)!($G(PSDOUT)) G END
"RTN","PSDNMBA",22,0)
 W ! K DIR S DIR("A")="Okay to Continue",DIR("B")="No",DIR(0)="Y" D ^DIR
"RTN","PSDNMBA",23,0)
 I Y'=1 W "     <No report>",! G END
"RTN","PSDNMBA",24,0)
 W !!,?9,"This report should be queued to run during non-peak hours.",!
"RTN","PSDNMBA",25,0)
 K IO("Q") S %ZIS="MQ" D ^%ZIS I POP W "  <No device selected.>" G END
"RTN","PSDNMBA",26,0)
 I $D(IO("Q")) D
"RTN","PSDNMBA",27,0)
 .S ZTRTN="DQ^PSDNMBA",ZTDESC="CS Monitoring - PSDNMBA"
"RTN","PSDNMBA",28,0)
 .S ZTSAVE("PSDSD")="",ZTSAVE("PSDPLOC(")="",ZTSAVE("PSDED")="",ZTSAVE("PSDIDIV")=""
"RTN","PSDNMBA",29,0)
 .D ^%ZTLOAD W !!?5,"TASK #",$G(ZTSK)," QUEUED!",!
"RTN","PSDNMBA",30,0)
 I '$D(IO("Q")) U IO D DQ
"RTN","PSDNMBA",31,0)
 K IOP,IO("Q")
"RTN","PSDNMBA",32,0)
END Q
"RTN","PSDNMBA",33,0)
 ;
"RTN","PSDNMBA",34,0)
HD ;Report heading
"RTN","PSDNMBA",35,0)
 N PSDY,X,Y,%
"RTN","PSDNMBA",36,0)
 W @IOF,$$CJ^XLFSTR("CS Monitoring - Balance Adjustments Report",IOM)
"RTN","PSDNMBA",37,0)
 S PSDY="Inpatient site: "_$P(PSDIDIV,U,2)
"RTN","PSDNMBA",38,0)
 I $G(PSDPLOC)="^ALL" S PSDY=PSDY_" all Pharmacy Locations"
"RTN","PSDNMBA",39,0)
 W !,$$CJ^XLFSTR(PSDY,IOM)
"RTN","PSDNMBA",40,0)
 W !,$$CJ^XLFSTR("Balance Adjustments made: "_$P(PSDSD,U,2)_" thru "_$P(PSDED,U,2),IOM)
"RTN","PSDNMBA",41,0)
 S PSDPG=PSDPG+1
"RTN","PSDNMBA",42,0)
 D NOW^%DTC W !,"Report Run: "_$E($$FMTE^XLFDT(%),1,18),?70,"PAGE: ",PSDPG
"RTN","PSDNMBA",43,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","PSDNMBA",44,0)
 QUIT
"RTN","PSDNMBA",45,0)
 ;
"RTN","PSDNMBA",46,0)
DQ ;Report Run
"RTN","PSDNMBA",47,0)
 N DFN,PSDA,PSDFD,PSDI,PSDIDT,PSDIV,PSDOUT,PSDP,PSDPG,PSDS,PSDRG,PSDUZ
"RTN","PSDNMBA",48,0)
 N PSDX,PSDX0,PSDX2,PSDXOR1,PSDY,X,Y,%
"RTN","PSDNMBA",49,0)
 K ^TMP("PSDNMBA",$J)
"RTN","PSDNMBA",50,0)
 I IOST?1"C-".E W !!,?10,"Compiling report, please wait ..."
"RTN","PSDNMBA",51,0)
 S PSDA=$O(^PSD(58.84,"B","BALANCE ADJUSTMENT",0)) I 'PSDA G DQQ
"RTN","PSDNMBA",52,0)
 S PSDP=0
"RTN","PSDNMBA",53,0)
 F  S PSDP=$O(PSDPLOC(PSDP)) Q:'PSDP  S ^TMP("PSDNMBA",$J,PSDPLOC(PSDP))=""
"RTN","PSDNMBA",54,0)
 S PSDFD=+PSDSD
"RTN","PSDNMBA",55,0)
 F  S PSDFD=$O(^PSD(58.81,"AF",PSDFD)) Q:('PSDFD)!(PSDFD]+PSDED)  D
"RTN","PSDNMBA",56,0)
 . S PSDP=0
"RTN","PSDNMBA",57,0)
 . F  S PSDP=$O(PSDPLOC(PSDP)) Q:'PSDP  D
"RTN","PSDNMBA",58,0)
 . . S PSDX=0
"RTN","PSDNMBA",59,0)
 . . F  S PSDX=$O(^PSD(58.81,"AF",PSDFD,PSDP,PSDA,PSDX)) Q:'PSDX  D
"RTN","PSDNMBA",60,0)
 . . . S PSDX0=$G(^PSD(58.81,PSDX,0)) I PSDX0']"" Q
"RTN","PSDNMBA",61,0)
 . . . S PSDRG=$G(^PSDRUG(+$P(PSDX0,U,5),0))
"RTN","PSDNMBA",62,0)
 . . . S PSDUZ=+$P(PSDX0,U,7),PSDUZ=$P($G(^VA(200,+PSDUZ,0)),U,1)
"RTN","PSDNMBA",63,0)
 . . . S Y=PSDFD D D^DIQ S PSDS=Y
"RTN","PSDNMBA",64,0)
 . . . S ^TMP("PSDNMBA",$J,PSDPLOC(PSDP),PSDUZ,PSDX)=$P(PSDX0,U,1)_U_$E(PSDS,1,18)_U_$P(PSDX0,U,6)_U_$P(PSDRG,U,1)_U_$P(PSDX0,U,16)
"RTN","PSDNMBA",65,0)
 ;
"RTN","PSDNMBA",66,0)
PRT ;Report print
"RTN","PSDNMBA",67,0)
 S PSDPG=0,PSDOUT=0
"RTN","PSDNMBA",68,0)
 I '$D(^TMP("PSDNMBA",$J)) D  G DQQ
"RTN","PSDNMBA",69,0)
 . S PSDIV="",PSDPG=1 D HD,PHD
"RTN","PSDNMBA",70,0)
 . W !!,?10,"<<<< NO DATA FOUND >>>>",!
"RTN","PSDNMBA",71,0)
 S PSDIV=""
"RTN","PSDNMBA",72,0)
 D HD,PHD
"RTN","PSDNMBA",73,0)
 F  S PSDIV=$O(^TMP("PSDNMBA",$J,PSDIV)) Q:(PSDIV="")!(PSDOUT)  D
"RTN","PSDNMBA",74,0)
 .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMBA",75,0)
 .  W !!,"Pharmacy Location: ",PSDIV
"RTN","PSDNMBA",76,0)
 .  S PSDS=""
"RTN","PSDNMBA",77,0)
 .  I $O(^TMP("PSDNMBA",$J,PSDIV,PSDS))']"" W !,?19,"NO DATA FOUND" Q
"RTN","PSDNMBA",78,0)
 .  F  S PSDS=$O(^TMP("PSDNMBA",$J,PSDIV,PSDS)) Q:(PSDS="")!(PSDOUT)  D
"RTN","PSDNMBA",79,0)
 .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMBA",80,0)
 .  .  W !!,"TRANSACTOR: ",PSDS
"RTN","PSDNMBA",81,0)
 .  .  S PSDX=0
"RTN","PSDNMBA",82,0)
 .  .  F  S PSDX=$O(^TMP("PSDNMBA",$J,PSDIV,PSDS,PSDX)) Q:('PSDX)!(PSDOUT)  D
"RTN","PSDNMBA",83,0)
 .  .  .  S PSDY=$G(^TMP("PSDNMBA",$J,PSDIV,PSDS,PSDX))
"RTN","PSDNMBA",84,0)
 .  .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMBA",85,0)
 .  .  .  W !,$P(PSDY,U,1),?10,$P(PSDY,U,2),?33,$P(PSDY,U,3),?40,$P(PSDY,U,4)
"RTN","PSDNMBA",86,0)
 .  .  .  W !,?10,"Reason: ",$P(PSDY,U,5)
"RTN","PSDNMBA",87,0)
 ;
"RTN","PSDNMBA",88,0)
DQQ W ! K PSDCII,PSDIDIV,PSDPLOC,PSDSD,PSDED,^TMP("PSDNMBA",$J) D ^%ZISC Q
"RTN","PSDNMBA",89,0)
 ;
"RTN","PSDNMBA",90,0)
PHD ;
"RTN","PSDNMBA",91,0)
 W !,"Trans. #",?10,"Date",?28,"Quantity",?40,"Drug"
"RTN","PSDNMBA",92,0)
 W !,$$REPEAT^XLFSTR("_",IOM)
"RTN","PSDNMBA",93,0)
 Q
"RTN","PSDNMBA",94,0)
PAGE ;
"RTN","PSDNMBA",95,0)
 N DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSDNMBA",96,0)
 I IOST?1"C-".E S DIR(0)="E" D ^DIR W !
"RTN","PSDNMBA",97,0)
 I ($D(DTOUT))!($D(DIRUT)) S PSDOUT=1 Q:$G(PSDOUT)=1
"RTN","PSDNMBA",98,0)
 Q
"RTN","PSDNMBA",99,0)
 ;
"RTN","PSDNMBA",100,0)
EOR ;PSDNMBA - CSM Balance Adjustments; 18 DEC 02
"RTN","PSDNMKY")
0^1^B16659852
"RTN","PSDNMKY",1,0)
PSDNMKY ;DOIFO/CMS - CSM Security Key Print ;18 Dec 02
"RTN","PSDNMKY",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;*41*;13 Feb 97
"RTN","PSDNMKY",3,0)
 ;Reference to ^XUSEC( supported by IA #1095
"RTN","PSDNMKY",4,0)
 Q
"RTN","PSDNMKY",5,0)
 ;
"RTN","PSDNMKY",6,0)
ST ;CS Monitoring OPTION ENTRY
"RTN","PSDNMKY",7,0)
 N DIR,DIRUT,DIROUT,DTOUT,DUOUT,POP,X,Y,ZTIO,ZTSK,ZTRTN,ZTDESC,%,%ZIS
"RTN","PSDNMKY",8,0)
 W !!,?5,"This report lists current holders of the"
"RTN","PSDNMKY",9,0)
 W !,?5,"PSJ RPHARM and/or PSDMGR security keys.",!!
"RTN","PSDNMKY",10,0)
 S DIR("A")="Okay to Continue",DIR("B")="No",DIR(0)="Y" D ^DIR
"RTN","PSDNMKY",11,0)
 I Y'=1 W "     <No report>",! G END
"RTN","PSDNMKY",12,0)
 ;
"RTN","PSDNMKY",13,0)
 K IO("Q") S %ZIS="MQ" D ^%ZIS I POP W "  <No device selected.>" G END
"RTN","PSDNMKY",14,0)
 I $D(IO("Q")) D
"RTN","PSDNMKY",15,0)
 .S ZTRTN="DQ^PSDNMKY",ZTDESC="CS Monitoring - PSDNMKY"
"RTN","PSDNMKY",16,0)
 .D ^%ZTLOAD W !!?5,"TASK #",$G(ZTSK)," QUEUED!",!
"RTN","PSDNMKY",17,0)
 I '$D(IO("Q")) U IO D DQ
"RTN","PSDNMKY",18,0)
 K IOP,IO("Q")
"RTN","PSDNMKY",19,0)
END Q
"RTN","PSDNMKY",20,0)
 ;
"RTN","PSDNMKY",21,0)
 ;
"RTN","PSDNMKY",22,0)
HD ;Report heading
"RTN","PSDNMKY",23,0)
 N PSDH,X,Y,%
"RTN","PSDNMKY",24,0)
 W @IOF,$$CJ^XLFSTR("CS Monitoring - Security Key Report",IOM)
"RTN","PSDNMKY",25,0)
 S PSDH="SECURITY KEY: "_$S(PSDK="BOTH":"PSDMGR & PSJ RPHARM",1:PSDK)
"RTN","PSDNMKY",26,0)
 W !,$$CJ^XLFSTR(PSDH,IOM)
"RTN","PSDNMKY",27,0)
 W !,"Station: ",$G(PSDIV),?20,"Report Run Date: "
"RTN","PSDNMKY",28,0)
 S PSDPG=PSDPG+1
"RTN","PSDNMKY",29,0)
 D NOW^%DTC W $$FMTE^XLFDT(%),?65,"PAGE: ",PSDPG
"RTN","PSDNMKY",30,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","PSDNMKY",31,0)
 QUIT
"RTN","PSDNMKY",32,0)
 ;
"RTN","PSDNMKY",33,0)
DQ ;Report Run
"RTN","PSDNMKY",34,0)
 N D0,DA,DIC,DIQ,DR
"RTN","PSDNMKY",35,0)
 N PSDIV,PSDK,PSDN,PSDO,PSDOUT,PSDPG,PSDS,PSDT,PSDTI,PSDX,PSDY,X,Y,%
"RTN","PSDNMKY",36,0)
 K ^TMP("PSDNMKY",$J)
"RTN","PSDNMKY",37,0)
 I IOST?1"C-".E W !!,?10,"Compiling report, please wait ..."
"RTN","PSDNMKY",38,0)
 S PSDX=0
"RTN","PSDNMKY",39,0)
 F  S PSDX=$O(^XUSEC("PSDMGR",PSDX)) Q:'PSDX  D
"RTN","PSDNMKY",40,0)
 . S PSDN=$G(^VA(200,PSDX,0)) I PSDN']"" Q
"RTN","PSDNMKY",41,0)
 . S DA=PSDX,DR=".01;8;9.2;29",DIQ="PSDO",DIQ(0)="E",DIC="^VA(200,"
"RTN","PSDNMKY",42,0)
 . K PSDO D EN^DIQ1
"RTN","PSDNMKY",43,0)
 . S PSDN=$G(PSDO(200,PSDX,.01,"E"))
"RTN","PSDNMKY",44,0)
 . S PSDN=$S(PSDN]"":PSDN,1:"NO NAME (ien="_+PSDX_")")
"RTN","PSDNMKY",45,0)
 . S PSDTI=$G(PSDO(200,PSDX,8,"E"))
"RTN","PSDNMKY",46,0)
 . S PSDTI=$S(PSDTI]"":PSDTI,1:"UNKNOWN")
"RTN","PSDNMKY",47,0)
 . S PSDT=$G(PSDO(200,PSDX,9.2,"E"))
"RTN","PSDNMKY",48,0)
 . S PSDS=$G(PSDO(200,PSDX,29,"E"))
"RTN","PSDNMKY",49,0)
 . S PSDS=$S(PSDS]"":PSDS,1:"UNKNOWN")
"RTN","PSDNMKY",50,0)
 . I $D(^XUSEC("PSJ RPHARM",PSDX)) D  Q
"RTN","PSDNMKY",51,0)
 . . S ^TMP("PSDNMKY",$J,"BOTH",PSDS,$P(PSDN,U,1),PSDX)=PSDTI_U_PSDT
"RTN","PSDNMKY",52,0)
 . S ^TMP("PSDNMKY",$J,"PSDMGR",PSDS,$P(PSDN,U,1),PSDX)=PSDTI_U_PSDT
"RTN","PSDNMKY",53,0)
 ;
"RTN","PSDNMKY",54,0)
 S PSDX=0
"RTN","PSDNMKY",55,0)
 F  S PSDX=$O(^XUSEC("PSJ RPHARM",PSDX)) Q:'PSDX  D
"RTN","PSDNMKY",56,0)
 . S PSDN=$G(^VA(200,PSDX,0)) I PSDN']"" Q
"RTN","PSDNMKY",57,0)
 . S DA=PSDX,DR=".01;8;9.2;29",DIQ="PSDO",DIQ(0)="E",DIC="^VA(200,"
"RTN","PSDNMKY",58,0)
 . K PSDO D EN^DIQ1
"RTN","PSDNMKY",59,0)
 . S PSDN=$G(PSDO(200,PSDX,.01,"E"))
"RTN","PSDNMKY",60,0)
 . S PSDN=$S(PSDN]"":PSDN,1:"NO NAME (ien="_+PSDX_")")
"RTN","PSDNMKY",61,0)
 . S PSDTI=$G(PSDO(200,PSDX,8,"E"))
"RTN","PSDNMKY",62,0)
 . S PSDTI=$S(PSDTI]"":PSDTI,1:"UNKNOWN")
"RTN","PSDNMKY",63,0)
 . S PSDT=$G(PSDO(200,PSDX,9.2,"E"))
"RTN","PSDNMKY",64,0)
 . S PSDS=$G(PSDO(200,PSDX,29,"E"))
"RTN","PSDNMKY",65,0)
 . S PSDS=$S(PSDS]"":PSDS,1:"UNKNOWN")
"RTN","PSDNMKY",66,0)
 . I $D(^XUSEC("PSDMGR",PSDX)) D  Q
"RTN","PSDNMKY",67,0)
 . .  S ^TMP("PSDNMKY",$J,"BOTH",PSDS,$P(PSDN,U,1),PSDX)=PSDTI_U_PSDT
"RTN","PSDNMKY",68,0)
 . S ^TMP("PSDNMKY",$J,"PSJ RPHARM",PSDS,$P(PSDN,U,1),PSDX)=PSDTI_U_PSDT
"RTN","PSDNMKY",69,0)
 ;
"RTN","PSDNMKY",70,0)
 ;Report print
"RTN","PSDNMKY",71,0)
 S PSDPG=0,PSDOUT=0,PSDIV=+$$SITE^VASITE
"RTN","PSDNMKY",72,0)
 I '$D(^TMP("PSDNMKY",$J)) S PSDK="BOTH" D HD,PHD W !!,?10,"<<<< NO DATA FOUND >>>>",! G DQQ
"RTN","PSDNMKY",73,0)
 S PSDK=""
"RTN","PSDNMKY",74,0)
 F  S PSDK=$O(^TMP("PSDNMKY",$J,PSDK)) Q:(PSDK="")!(PSDOUT)  D
"RTN","PSDNMKY",75,0)
 .  S PSDPG=0 D HD,PHD
"RTN","PSDNMKY",76,0)
 .  S PSDS=""
"RTN","PSDNMKY",77,0)
 .  F  S PSDS=$O(^TMP("PSDNMKY",$J,PSDK,PSDS)) Q:(PSDS="")!(PSDOUT)  D
"RTN","PSDNMKY",78,0)
 . . I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMKY",79,0)
 . . W !!,"SERVICE/SECTION: ",PSDS
"RTN","PSDNMKY",80,0)
 .  .  S PSDN=""
"RTN","PSDNMKY",81,0)
 .  .  F  S PSDN=$O(^TMP("PSDNMKY",$J,PSDK,PSDS,PSDN)) Q:(PSDN="")!(PSDOUT)  D
"RTN","PSDNMKY",82,0)
 .  .  .  S PSDX=0
"RTN","PSDNMKY",83,0)
 .  .  .  F  S PSDX=$O(^TMP("PSDNMKY",$J,PSDK,PSDS,PSDN,PSDX)) Q:('PSDX)!(PSDOUT)  D
"RTN","PSDNMKY",84,0)
 .  .  .  .  S PSDY=$G(^TMP("PSDNMKY",$J,PSDK,PSDS,PSDN,PSDX))
"RTN","PSDNMKY",85,0)
 .  .  .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMKY",86,0)
 .  .  .  .  W !,?3,PSDN,?35,$P(PSDY,U,1),?65,$P(PSDY,U,2)
"RTN","PSDNMKY",87,0)
 .  I '$G(PSDOUT),$O(^TMP("PSDNMKY",$J,PSDK))]"" D PAGE
"RTN","PSDNMKY",88,0)
 ;
"RTN","PSDNMKY",89,0)
DQQ K ^TMP("PSDNMKY",$J) D ^%ZISC Q
"RTN","PSDNMKY",90,0)
 ;
"RTN","PSDNMKY",91,0)
PHD W !,?3,"Name",?35,"Title",?64,"Termination Date"
"RTN","PSDNMKY",92,0)
 W !,$$REPEAT^XLFSTR("_",IOM)
"RTN","PSDNMKY",93,0)
 Q
"RTN","PSDNMKY",94,0)
PAGE ;
"RTN","PSDNMKY",95,0)
 N DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSDNMKY",96,0)
 I IOST?1"C-".E S DIR(0)="E" D ^DIR W !
"RTN","PSDNMKY",97,0)
 I ($D(DTOUT))!($D(DIRUT)) S PSDOUT=1 Q:$G(PSDOUT)=1
"RTN","PSDNMKY",98,0)
 Q 
"RTN","PSDNMKY",99,0)
 ;
"RTN","PSDNMKY",100,0)
EOR ;PSDNMKY - CSM Security Key Print; 18 DEC 02
"RTN","PSDNMPR")
0^4^B20437425
"RTN","PSDNMPR",1,0)
PSDNMPR ;DOIFO/CMS - CSM Partial Request ;18 Dec 02
"RTN","PSDNMPR",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;*41*;13 Feb 97
"RTN","PSDNMPR",3,0)
 ;Reference to ^PSDRUG( supported by IA #221
"RTN","PSDNMPR",4,0)
 ;Reference to ^PS(59 supported by IA #2621
"RTN","PSDNMPR",5,0)
 ;Reference to ^PSRX( supported by IA #1977
"RTN","PSDNMPR",6,0)
 Q
"RTN","PSDNMPR",7,0)
 ;
"RTN","PSDNMPR",8,0)
ST ;CS Monitoring OPTION ENTRY
"RTN","PSDNMPR",9,0)
 N PSDODIV,PSDCII,PSDED,PSDFED,PSDFSD,PSDOUT,PSDDTN,PSDSD,X,Y,%
"RTN","PSDNMPR",10,0)
 N DIR,DIRUT,DIROUT,DTOUT,DUOUT,POP,ZTIO,ZTSAVE,ZTSK,ZTRTN,ZTDESC,%ZIS
"RTN","PSDNMPR",11,0)
 W !!,?5,"This report lists CS Prescriptions with Partial Fill"
"RTN","PSDNMPR",12,0)
 W !,?5,"request activity within the fill date range entered.",!!
"RTN","PSDNMPR",13,0)
 W ! D DIV^PSDNMU I '$O(PSDODIV(0))!($G(PSDOUT)) G END
"RTN","PSDNMPR",14,0)
 S PSDDTN="Fill" D DATE^PSDNMU I '$G(PSDSD)!($G(PSDOUT)) G END
"RTN","PSDNMPR",15,0)
 S PSDFSD=PSDSD,PSDFED=PSDED
"RTN","PSDNMPR",16,0)
 W ! D CII^PSDNMU I $G(PSDOUT) G END
"RTN","PSDNMPR",17,0)
 ;
"RTN","PSDNMPR",18,0)
 W ! S DIR("A")="Okay to Continue",DIR("B")="No",DIR(0)="Y" D ^DIR
"RTN","PSDNMPR",19,0)
 I Y'=1 W "     <No report>",! G END
"RTN","PSDNMPR",20,0)
 W !!,?9,"This report should be queued to run during non-peak hours.",!
"RTN","PSDNMPR",21,0)
 K IO("Q") S %ZIS="MQ" D ^%ZIS I POP W "  <No device selected.>" G END
"RTN","PSDNMPR",22,0)
 I $D(IO("Q")) D
"RTN","PSDNMPR",23,0)
 .S ZTRTN="DQ^PSDNMPR",ZTDESC="CS Monitoring - PSDNMPR"
"RTN","PSDNMPR",24,0)
 .S ZTSAVE("PSDODIV(")="",ZTSAVE("PSDCII")="",ZTSAVE("PSDFSD")="",ZTSAVE("PSDFED")=""
"RTN","PSDNMPR",25,0)
 .D ^%ZTLOAD W !!?5,"TASK #",$G(ZTSK)," QUEUED!",!
"RTN","PSDNMPR",26,0)
 I '$D(IO("Q")) U IO D DQ
"RTN","PSDNMPR",27,0)
 K IOP,IO("Q")
"RTN","PSDNMPR",28,0)
END Q
"RTN","PSDNMPR",29,0)
 ;
"RTN","PSDNMPR",30,0)
HD ;Report heading
"RTN","PSDNMPR",31,0)
 N PSDD,PSDL,X,Y,%
"RTN","PSDNMPR",32,0)
 W @IOF,$$CJ^XLFSTR("CS Monitoring - Partial Request Report",IOM)
"RTN","PSDNMPR",33,0)
 S PSDL="Outpatient Division(s): "
"RTN","PSDNMPR",34,0)
 S PSDD=0
"RTN","PSDNMPR",35,0)
 F  S PSDD=$O(PSDODIV(PSDD)) Q:'PSDD  S PSDL=PSDL_$P($G(PSDODIV(PSDD)),U,2) I $O(PSDODIV(PSDD)) S PSDL=PSDL_", "
"RTN","PSDNMPR",36,0)
 W !,$$CJ^XLFSTR(PSDL,IOM)
"RTN","PSDNMPR",37,0)
 W !,$$CJ^XLFSTR("Fill Date range: "_$P(PSDFSD,U,2)_" thru "_$P(PSDFED,U,2),IOM)
"RTN","PSDNMPR",38,0)
 S PSDL="Controlled Substance schedule(s): "
"RTN","PSDNMPR",39,0)
 F PSDD=1:1:4 I $P(PSDCII,",",PSDD) S PSDL=PSDL_$P(PSDCII,",",PSDD) I $P(PSDCII,",",(PSDD+1)) S PSDL=PSDL_", "
"RTN","PSDNMPR",40,0)
 I +PSDCII W !,$$CJ^XLFSTR(PSDL,IOM)
"RTN","PSDNMPR",41,0)
 W !,"Division: ",$E($G(PSDIV),1,13),?25,"Report Run Date: "
"RTN","PSDNMPR",42,0)
 S PSDPG=PSDPG+1
"RTN","PSDNMPR",43,0)
 D NOW^%DTC W $$FMTE^XLFDT(%),?70,"PAGE: ",PSDPG
"RTN","PSDNMPR",44,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","PSDNMPR",45,0)
 QUIT
"RTN","PSDNMPR",46,0)
 ;
"RTN","PSDNMPR",47,0)
DQ ;Report Run
"RTN","PSDNMPR",48,0)
 N PSDA,PSDFD,PSDI,PSDIDT,PSDIV,PSDOUT,PSDP,PSDPG,PSDRG,PSDUZ,PSDX,PSDX0,PSDX2,PSDXOR1,PSDY,X,Y,%
"RTN","PSDNMPR",49,0)
 K ^TMP("PSDNMPR",$J)
"RTN","PSDNMPR",50,0)
 I IOST?1"C-".E W !!,?10,"Compiling report, please wait ..."
"RTN","PSDNMPR",51,0)
 S PSDFD=+PSDFSD
"RTN","PSDNMPR",52,0)
 F  S PSDFD=$O(^PSRX("AD",PSDFD)) Q:('PSDFD)!(PSDFD]+PSDFED)  D
"RTN","PSDNMPR",53,0)
 . S PSDX=0
"RTN","PSDNMPR",54,0)
 . F  S PSDX=$O(^PSRX("AD",PSDFD,PSDX)) Q:'PSDX  D
"RTN","PSDNMPR",55,0)
 . . S PSDX0=$G(^PSRX(PSDX,0)) I PSDX0']"" Q
"RTN","PSDNMPR",56,0)
 . . S PSDX2=$G(^PSRX(PSDX,2))
"RTN","PSDNMPR",57,0)
 . . I '$D(PSDODIV(+$P(PSDX2,U,9))) Q
"RTN","PSDNMPR",58,0)
 . . S PSDRG=$G(^PSDRUG(+$P(PSDX0,U,6),0))
"RTN","PSDNMPR",59,0)
 . . S PSDP=0
"RTN","PSDNMPR",60,0)
 . . F PSDY=1:1:4 S PSDA=+$P(PSDCII,",",PSDY) I PSDA,$P(PSDRG,U,3)[PSDA S PSDP=1 Q
"RTN","PSDNMPR",61,0)
 . . I 'PSDP Q
"RTN","PSDNMPR",62,0)
 . . S PSDI=0
"RTN","PSDNMPR",63,0)
 . . F  S PSDI=$O(^PSRX(PSDX,"A",PSDI)) Q:'PSDI  D
"RTN","PSDNMPR",64,0)
 . . . S PSDA=$G(^PSRX(PSDX,"A",PSDI,0))
"RTN","PSDNMPR",65,0)
 . . . I $P(PSDA,U,2)'="P" Q
"RTN","PSDNMPR",66,0)
 . . . S Y=+PSDA D D^DIQ S $P(PSDA,U,1)=Y
"RTN","PSDNMPR",67,0)
 . . . S PSDUZ=$P($G(^VA(200,+$P(PSDA,U,3),0)),U,1)
"RTN","PSDNMPR",68,0)
 . . . S ^TMP("PSDNMPR",$J,$S(+$P(PSDX2,U,9):$P($G(^PS(59,+$P(PSDX2,U,9),0)),U,1),1:"UNKNOWN"),$P(PSDRG,U,1),PSDX,PSDI)=$P(PSDX0,U,1)_U_$P(PSDA,U,1)_U_PSDUZ_U_$P(PSDA,U,5)
"RTN","PSDNMPR",69,0)
 ;
"RTN","PSDNMPR",70,0)
PRT ;Report print
"RTN","PSDNMPR",71,0)
 S PSDPG=0,PSDOUT=0
"RTN","PSDNMPR",72,0)
 I '$D(^TMP("PSDNMPR",$J)) D  G DQQ
"RTN","PSDNMPR",73,0)
 . S PSDIV="" D HD,PHD
"RTN","PSDNMPR",74,0)
 . W !!,?10,"<<<< NO DATA FOUND >>>>",!
"RTN","PSDNMPR",75,0)
 S PSDIV=""
"RTN","PSDNMPR",76,0)
 F  S PSDIV=$O(^TMP("PSDNMPR",$J,PSDIV)) Q:(PSDIV="")!(PSDOUT)  D
"RTN","PSDNMPR",77,0)
 .  S PSDPG=0 D HD,PHD
"RTN","PSDNMPR",78,0)
 .  S PSDRG=""
"RTN","PSDNMPR",79,0)
 .  F  S PSDRG=$O(^TMP("PSDNMPR",$J,PSDIV,PSDRG)) Q:(PSDRG="")!(PSDOUT)  D
"RTN","PSDNMPR",80,0)
 .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMPR",81,0)
 .  .  W !!,PSDRG
"RTN","PSDNMPR",82,0)
 .  .  S PSDX=0
"RTN","PSDNMPR",83,0)
 .  .  F  S PSDX=$O(^TMP("PSDNMPR",$J,PSDIV,PSDRG,PSDX)) Q:('PSDX)!(PSDOUT)  D
"RTN","PSDNMPR",84,0)
 .  .  .  S PSDA=0
"RTN","PSDNMPR",85,0)
 .  .  .  F  S PSDA=$O(^TMP("PSDNMPR",$J,PSDIV,PSDRG,PSDX,PSDA)) Q:('PSDA)!(PSDOUT)  D
"RTN","PSDNMPR",86,0)
 .  .  .  .  S PSDY=$G(^TMP("PSDNMPR",$J,PSDIV,PSDRG,PSDX,PSDA))
"RTN","PSDNMPR",87,0)
 .  .  .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMPR",88,0)
 .  .  .  .  W !,$P(PSDY,U,1),?15,$P(PSDY,U,2),?40,$P(PSDY,U,3)
"RTN","PSDNMPR",89,0)
 .  .  .  .  W !,?15,$P(PSDY,U,4)
"RTN","PSDNMPR",90,0)
 .  I '$G(PSDOUT),$O(^TMP("PSDNMPR",$J,PSDIV))]"" D PAGE
"RTN","PSDNMPR",91,0)
 ;
"RTN","PSDNMPR",92,0)
DQQ W ! K PSDCII,PSDFED,PSDFSD,PSDODIV,^TMP("PSDNMPR",$J) D ^%ZISC Q
"RTN","PSDNMPR",93,0)
 ;
"RTN","PSDNMPR",94,0)
PHD ;
"RTN","PSDNMPR",95,0)
 W !,"RX#",?15,"Activity Log Date",?40,"Initiator of Activity"
"RTN","PSDNMPR",96,0)
 W !,?15,"Activity Log Comment"
"RTN","PSDNMPR",97,0)
 W !,$$REPEAT^XLFSTR("_",IOM)
"RTN","PSDNMPR",98,0)
 Q
"RTN","PSDNMPR",99,0)
PAGE ;
"RTN","PSDNMPR",100,0)
 N DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSDNMPR",101,0)
 I IOST?1"C-".E S DIR(0)="E" D ^DIR W !
"RTN","PSDNMPR",102,0)
 I ($D(DTOUT))!($D(DIRUT)) S PSDOUT=1 Q:$G(PSDOUT)=1
"RTN","PSDNMPR",103,0)
 Q
"RTN","PSDNMPR",104,0)
 ;
"RTN","PSDNMPR",105,0)
EOR ;PSDNMPR - CSM Partial Request; 18 DEC 02
"RTN","PSDNMRP")
0^5^B20540701
"RTN","PSDNMRP",1,0)
PSDNMRP ;DOIFO/CMS - CSM Label Reprint ;18 Dec 02
"RTN","PSDNMRP",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;*41*;13 Feb 97
"RTN","PSDNMRP",3,0)
 ;Reference to ^PS(59 supported by IA #2621
"RTN","PSDNMRP",4,0)
 ;Reference to ^PSDRUG( supported by IA #221
"RTN","PSDNMRP",5,0)
 ;Reference to ^PSRX( supported by IA #1977
"RTN","PSDNMRP",6,0)
 Q
"RTN","PSDNMRP",7,0)
 ;
"RTN","PSDNMRP",8,0)
ST ;CS Monitoring OPTION ENTRY
"RTN","PSDNMRP",9,0)
 N PSDODIV,PSDCII,PSDED,PSDIED,PSDISD,PSDOUT,PSDDTN,PSDSD,X,Y,%
"RTN","PSDNMRP",10,0)
 N DIR,DIRUT,DIROUT,DTOUT,DUOUT,POP,ZTIO,ZTSAVE,ZTSK,ZTRTN,ZTDESC,%ZIS
"RTN","PSDNMRP",11,0)
 W !!,?5,"This report lists CS Prescriptions with label reprint"
"RTN","PSDNMRP",12,0)
 W !,?5,"request activity within the issue date range entered.",!!
"RTN","PSDNMRP",13,0)
 W ! D DIV^PSDNMU I '$O(PSDODIV(0))!($G(PSDOUT)) G END
"RTN","PSDNMRP",14,0)
 S PSDDTN="Issue" D DATE^PSDNMU I '$G(PSDSD)!($G(PSDOUT)) G END
"RTN","PSDNMRP",15,0)
 S PSDISD=PSDSD,PSDIED=PSDED
"RTN","PSDNMRP",16,0)
 W ! D CII^PSDNMU I $G(PSDOUT) G END
"RTN","PSDNMRP",17,0)
 ;
"RTN","PSDNMRP",18,0)
 W ! S DIR("A")="Okay to Continue",DIR("B")="No",DIR(0)="Y" D ^DIR
"RTN","PSDNMRP",19,0)
 I Y'=1 W "     <No report>",! G END
"RTN","PSDNMRP",20,0)
 W !!,?9,"This report should be queued to run during non-peak hours.",!
"RTN","PSDNMRP",21,0)
 K IO("Q") S %ZIS="MQ" D ^%ZIS I POP W "  <No device selected.>" G END
"RTN","PSDNMRP",22,0)
 I $D(IO("Q")) D
"RTN","PSDNMRP",23,0)
 .S ZTRTN="DQ^PSDNMRP",ZTDESC="CS Monitoring - PSDNMRP"
"RTN","PSDNMRP",24,0)
 .S ZTSAVE("PSDODIV(")="",ZTSAVE("PSDCII")="",ZTSAVE("PSDISD")="",ZTSAVE("PSDIED")=""
"RTN","PSDNMRP",25,0)
 .D ^%ZTLOAD W !!?5,"TASK #",$G(ZTSK)," QUEUED!",!
"RTN","PSDNMRP",26,0)
 I '$D(IO("Q")) U IO D DQ
"RTN","PSDNMRP",27,0)
 K IOP,IO("Q")
"RTN","PSDNMRP",28,0)
END Q
"RTN","PSDNMRP",29,0)
 ;
"RTN","PSDNMRP",30,0)
HD ;Report heading
"RTN","PSDNMRP",31,0)
 N PSDD,PSDL,X,Y,%
"RTN","PSDNMRP",32,0)
 W @IOF,$$CJ^XLFSTR("CS Monitoring - Label Reprint Request Report",IOM)
"RTN","PSDNMRP",33,0)
 S PSDL="Outpatient Division(s): "
"RTN","PSDNMRP",34,0)
 S PSDD=0
"RTN","PSDNMRP",35,0)
 F  S PSDD=$O(PSDODIV(PSDD)) Q:'PSDD  S PSDL=PSDL_$P($G(PSDODIV(PSDD)),U,2)  I $O(PSDODIV(PSDD)) S PSDL=PSDL_", "
"RTN","PSDNMRP",36,0)
 W !,$$CJ^XLFSTR(PSDL,IOM)
"RTN","PSDNMRP",37,0)
 W !,$$CJ^XLFSTR("Issue Date range: "_$P(PSDISD,U,2)_" thru "_$P(PSDIED,U,2),IOM)
"RTN","PSDNMRP",38,0)
 S PSDL="Controlled Substance schedule(s): "
"RTN","PSDNMRP",39,0)
 F PSDD=1:1:4 I $P(PSDCII,",",PSDD) S PSDL=PSDL_$P(PSDCII,",",PSDD) I $P(PSDCII,",",(PSDD+1)) S PSDL=PSDL_", "
"RTN","PSDNMRP",40,0)
 I +PSDCII W !,$$CJ^XLFSTR(PSDL,IOM)
"RTN","PSDNMRP",41,0)
 W !,"Division: ",$E($G(PSDIV),1,13),?25,"Report Run Date: "
"RTN","PSDNMRP",42,0)
 S PSDPG=PSDPG+1
"RTN","PSDNMRP",43,0)
 D NOW^%DTC W $$FMTE^XLFDT(%),?70,"PAGE: ",PSDPG
"RTN","PSDNMRP",44,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","PSDNMRP",45,0)
 QUIT
"RTN","PSDNMRP",46,0)
 ;
"RTN","PSDNMRP",47,0)
DQ ;Report Run
"RTN","PSDNMRP",48,0)
 N PSDA,PSDFD,PSDI,PSDIDT,PSDIV,PSDOUT,PSDP,PSDPG,PSDRG,PSDUZ,PSDX,PSDX0,PSDX2,PSDXOR1,PSDY,X,Y,%
"RTN","PSDNMRP",49,0)
 K ^TMP("PSDNMRP",$J)
"RTN","PSDNMRP",50,0)
 I IOST?1"C-".E W !!,?10,"Compiling report, please wait ..."
"RTN","PSDNMRP",51,0)
 S PSDFD=+PSDISD
"RTN","PSDNMRP",52,0)
 F  S PSDFD=$O(^PSRX("AC",PSDFD)) Q:('PSDFD)!(PSDFD]+PSDIED)  D
"RTN","PSDNMRP",53,0)
 . S PSDX=0
"RTN","PSDNMRP",54,0)
 . F  S PSDX=$O(^PSRX("AC",PSDFD,PSDX)) Q:'PSDX  D
"RTN","PSDNMRP",55,0)
 . . S PSDX0=$G(^PSRX(PSDX,0)) I PSDX0']"" Q
"RTN","PSDNMRP",56,0)
 . . S PSDX2=$G(^PSRX(PSDX,2))
"RTN","PSDNMRP",57,0)
 . . I '$D(PSDODIV(+$P(PSDX2,U,9))) Q
"RTN","PSDNMRP",58,0)
 . . S PSDRG=$G(^PSDRUG(+$P(PSDX0,U,6),0))
"RTN","PSDNMRP",59,0)
 . . S PSDP=0
"RTN","PSDNMRP",60,0)
 . . F PSDY=1:1:4 S PSDA=+$P(PSDCII,",",PSDY) I PSDA,$P(PSDRG,U,3)[PSDA S PSDP=1 Q
"RTN","PSDNMRP",61,0)
 . . I 'PSDP Q
"RTN","PSDNMRP",62,0)
 . . S PSDI=0
"RTN","PSDNMRP",63,0)
 . . F  S PSDI=$O(^PSRX(PSDX,"A",PSDI)) Q:'PSDI  D
"RTN","PSDNMRP",64,0)
 . . . S PSDA=$G(^PSRX(PSDX,"A",PSDI,0))
"RTN","PSDNMRP",65,0)
 . . . I $P(PSDA,U,2)'="W" Q
"RTN","PSDNMRP",66,0)
 . . . S Y=+PSDA D D^DIQ S $P(PSDA,U,1)=Y
"RTN","PSDNMRP",67,0)
 . . . S PSDUZ=$P($G(^VA(200,+$P(PSDA,U,3),0)),U,1)
"RTN","PSDNMRP",68,0)
 . . . S ^TMP("PSDNMRP",$J,$S(+$P(PSDX2,U,9):$P($G(^PS(59,+$P(PSDX2,U,9),0)),U,1),1:"UNKNOWN"),$P(PSDRG,U,1),PSDX,PSDI)=$P(PSDX0,U,1)_U_$P(PSDA,U,1)_U_PSDUZ_U_$P(PSDA,U,5)
"RTN","PSDNMRP",69,0)
 ;
"RTN","PSDNMRP",70,0)
PRT ;Report print
"RTN","PSDNMRP",71,0)
 S PSDPG=0,PSDOUT=0
"RTN","PSDNMRP",72,0)
 I '$D(^TMP("PSDNMRP",$J)) D  G DQQ
"RTN","PSDNMRP",73,0)
 . S PSDIV="" D HD,PHD
"RTN","PSDNMRP",74,0)
 . W !!,?10,"<<<< NO DATA FOUND >>>>",!
"RTN","PSDNMRP",75,0)
 S PSDIV=""
"RTN","PSDNMRP",76,0)
 F  S PSDIV=$O(^TMP("PSDNMRP",$J,PSDIV)) Q:(PSDIV="")!(PSDOUT)  D
"RTN","PSDNMRP",77,0)
 .  S PSDPG=0 D HD,PHD
"RTN","PSDNMRP",78,0)
 .  S PSDRG=""
"RTN","PSDNMRP",79,0)
 .  F  S PSDRG=$O(^TMP("PSDNMRP",$J,PSDIV,PSDRG)) Q:(PSDRG="")!(PSDOUT)  D
"RTN","PSDNMRP",80,0)
 .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMRP",81,0)
 .  .  W !!,PSDRG
"RTN","PSDNMRP",82,0)
 .  .  S PSDX=0
"RTN","PSDNMRP",83,0)
 .  .  F  S PSDX=$O(^TMP("PSDNMRP",$J,PSDIV,PSDRG,PSDX)) Q:('PSDX)!(PSDOUT)  D
"RTN","PSDNMRP",84,0)
 .  .  .  S PSDA=0
"RTN","PSDNMRP",85,0)
 .  .  .  F  S PSDA=$O(^TMP("PSDNMRP",$J,PSDIV,PSDRG,PSDX,PSDA)) Q:('PSDA)!(PSDOUT)  D
"RTN","PSDNMRP",86,0)
 .  .  .  .  S PSDY=$G(^TMP("PSDNMRP",$J,PSDIV,PSDRG,PSDX,PSDA))
"RTN","PSDNMRP",87,0)
 .  .  .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMRP",88,0)
 .  .  .  .  W !,$P(PSDY,U,1),?15,$P(PSDY,U,2),?40,$P(PSDY,U,3)
"RTN","PSDNMRP",89,0)
 .  .  .  .  W !,?15,$P(PSDY,U,4)
"RTN","PSDNMRP",90,0)
 .  I '$G(PSDOUT),$O(^TMP("PSDNMRP",$J,PSDIV))]"" D PAGE
"RTN","PSDNMRP",91,0)
 ;
"RTN","PSDNMRP",92,0)
DQQ W ! K PSDCII,PSDIED,PSDISD,PSDODIV,^TMP("PSDNMRP",$J) D ^%ZISC Q
"RTN","PSDNMRP",93,0)
 ;
"RTN","PSDNMRP",94,0)
PHD ;
"RTN","PSDNMRP",95,0)
 W !,"RX#",?15,"Activity Log Date",?40,"Initiator of Activity"
"RTN","PSDNMRP",96,0)
 W !,?15,"Activity Log Comment"
"RTN","PSDNMRP",97,0)
 W !,$$REPEAT^XLFSTR("_",IOM)
"RTN","PSDNMRP",98,0)
 Q
"RTN","PSDNMRP",99,0)
PAGE ;
"RTN","PSDNMRP",100,0)
 N DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSDNMRP",101,0)
 I IOST?1"C-".E S DIR(0)="E" D ^DIR W !
"RTN","PSDNMRP",102,0)
 I ($D(DTOUT))!($D(DIRUT)) S PSDOUT=1 Q:$G(PSDOUT)=1
"RTN","PSDNMRP",103,0)
 Q
"RTN","PSDNMRP",104,0)
 ;
"RTN","PSDNMRP",105,0)
EOR ;PSDNMRP - CSM Label Reprint; 18 DEC 02
"RTN","PSDNMSP")
0^6^B18105679
"RTN","PSDNMSP",1,0)
PSDNMSP ;DOIFO/CMS - CSM RX Processed by Same Person ;18 Dec 02
"RTN","PSDNMSP",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;*41*;13 Feb 97
"RTN","PSDNMSP",3,0)
 ;Reference to ^PSDRUG( supported by IA #221
"RTN","PSDNMSP",4,0)
 ;Reference to ^PS(59 supported by IA #2621
"RTN","PSDNMSP",5,0)
 ;Reference to ^PSRX( supported by IA #1977
"RTN","PSDNMSP",6,0)
 Q
"RTN","PSDNMSP",7,0)
 ;
"RTN","PSDNMSP",8,0)
ST ;CS Monitoring OPTION ENTRY
"RTN","PSDNMSP",9,0)
 N PSDODIV,PSDCII,PSDED,PSDOUT,PSDDTN,PSDSD,X,Y,%
"RTN","PSDNMSP",10,0)
 N DIR,DIRUT,DIROUT,DTOUT,DUOUT,POP,ZTIO,ZTSAVE,ZTSK,ZTRTN,ZTDESC,%ZIS
"RTN","PSDNMSP",11,0)
 W !!,?5,"This report lists CS prescriptions that were entered,"
"RTN","PSDNMSP",12,0)
 W !,?5,"finished and released by the same person.",!!
"RTN","PSDNMSP",13,0)
 W ! D DIV^PSDNMU I '$O(PSDODIV(0))!($G(PSDOUT)) G END
"RTN","PSDNMSP",14,0)
 S PSDDTN="Fill" D DATE^PSDNMU I '$G(PSDSD)!($G(PSDOUT)) G END
"RTN","PSDNMSP",15,0)
 W ! D CII^PSDNMU I $G(PSDOUT)!($G(PSDCII)']"") G END
"RTN","PSDNMSP",16,0)
 ;
"RTN","PSDNMSP",17,0)
 W ! S DIR("A")="Okay to Continue",DIR("B")="No",DIR(0)="Y" D ^DIR
"RTN","PSDNMSP",18,0)
 I Y'=1 W "     <No report>",! G END
"RTN","PSDNMSP",19,0)
 W !!,?9,"This report should be queued to run during non-peak hours.",!
"RTN","PSDNMSP",20,0)
 K IO("Q") S %ZIS="MQ" D ^%ZIS I POP W "  <No device selected.>" G END
"RTN","PSDNMSP",21,0)
 I $D(IO("Q")) D
"RTN","PSDNMSP",22,0)
 .S ZTRTN="DQ^PSDNMSP",ZTDESC="CS Monitoring - PSDNMSP"
"RTN","PSDNMSP",23,0)
 .S ZTSAVE("PSDED")="",ZTSAVE("PSDSD")="",ZTSAVE("PSDODIV(")="",ZTSAVE("PSDCII")=""
"RTN","PSDNMSP",24,0)
 .D ^%ZTLOAD W !!?5,"TASK #",$G(ZTSK)," QUEUED!",!
"RTN","PSDNMSP",25,0)
 I '$D(IO("Q")) U IO D DQ
"RTN","PSDNMSP",26,0)
 K IOP,IO("Q")
"RTN","PSDNMSP",27,0)
END Q
"RTN","PSDNMSP",28,0)
 ;
"RTN","PSDNMSP",29,0)
HD ;Report heading
"RTN","PSDNMSP",30,0)
 N PSDD,PSDL,X,Y,%
"RTN","PSDNMSP",31,0)
 W @IOF,$$CJ^XLFSTR("CS Monitoring - RX by Same Person Report",IOM)
"RTN","PSDNMSP",32,0)
 S PSDL="Outpatient Division(s): "
"RTN","PSDNMSP",33,0)
 S PSDD=0
"RTN","PSDNMSP",34,0)
 F  S PSDD=$O(PSDODIV(PSDD)) Q:'PSDD  S PSDL=PSDL_$P($G(PSDODIV(PSDD)),U,2) I $O(PSDODIV(PSDD)) S PSDL=PSDL_", "
"RTN","PSDNMSP",35,0)
 W !,$$CJ^XLFSTR(PSDL,IOM)
"RTN","PSDNMSP",36,0)
 W !,$$CJ^XLFSTR("Fill Date range: "_$P(PSDSD,U,2)_" thru "_$P(PSDED,U,2),IOM)
"RTN","PSDNMSP",37,0)
 S PSDL="Controlled Substance schedule(s): "
"RTN","PSDNMSP",38,0)
 F PSDD=1:1:4 I $P(PSDCII,",",PSDD) S PSDL=PSDL_$P(PSDCII,",",PSDD) I $P(PSDCII,",",(PSDD+1)) S PSDL=PSDL_", "
"RTN","PSDNMSP",39,0)
 I +PSDCII W !,$$CJ^XLFSTR(PSDL,IOM)
"RTN","PSDNMSP",40,0)
 W !,"Station: ",$E($G(PSDIV),1,13),?25,"Report Run Date: "
"RTN","PSDNMSP",41,0)
 S PSDPG=PSDPG+1
"RTN","PSDNMSP",42,0)
 D NOW^%DTC W $$FMTE^XLFDT(%),?70,"PAGE: ",PSDPG
"RTN","PSDNMSP",43,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","PSDNMSP",44,0)
 QUIT
"RTN","PSDNMSP",45,0)
 ;
"RTN","PSDNMSP",46,0)
DQ ;Report Run
"RTN","PSDNMSP",47,0)
 N PSDA,PSDFD,PSDIDT,PSDIV,PSDOUT,PSDP,PSDPG,PSDRG,PSDUZ,PSDX,PSDX0,PSDX2,PSDXOR1,PSDY,X,Y,%
"RTN","PSDNMSP",48,0)
 K ^TMP("PSDNMSP",$J)
"RTN","PSDNMSP",49,0)
 I IOST?1"C-".E W !!,?10,"Compiling report, please wait ..."
"RTN","PSDNMSP",50,0)
 S PSDFD=+PSDSD
"RTN","PSDNMSP",51,0)
 F  S PSDFD=$O(^PSRX("AD",PSDFD)) Q:('PSDFD)!(PSDFD]+PSDED)  D
"RTN","PSDNMSP",52,0)
 . S PSDX=0
"RTN","PSDNMSP",53,0)
 . F  S PSDX=$O(^PSRX("AD",PSDFD,PSDX)) Q:'PSDX  D
"RTN","PSDNMSP",54,0)
 . . S PSDX0=$G(^PSRX(PSDX,0)) I PSDX0']"" Q
"RTN","PSDNMSP",55,0)
 . . S PSDX2=$G(^PSRX(PSDX,2))
"RTN","PSDNMSP",56,0)
 . . I '$D(PSDODIV(+$P(PSDX2,U,9))) Q
"RTN","PSDNMSP",57,0)
 . . S PSDRG=$G(^PSDRUG(+$P(PSDX0,U,6),0))
"RTN","PSDNMSP",58,0)
 . . S PSDP=0
"RTN","PSDNMSP",59,0)
 . . F PSDY=1:1:4 S PSDA=+$P(PSDCII,",",PSDY) I PSDA,$P(PSDRG,U,3)[PSDA S PSDP=1 Q
"RTN","PSDNMSP",60,0)
 . . I 'PSDP Q
"RTN","PSDNMSP",61,0)
 . . S PSDUZ=+$P(PSDX0,U,16) I 'PSDUZ Q
"RTN","PSDNMSP",62,0)
 . . I PSDUZ'=+$P(PSDX2,U,3) Q
"RTN","PSDNMSP",63,0)
 . . S PSDXOR1=$G(^PSRX(PSDX,"OR1"))
"RTN","PSDNMSP",64,0)
 . . I PSDUZ'=+$P(PSDXOR1,U,5) Q
"RTN","PSDNMSP",65,0)
 . . S Y=PSDFD D D^DIQ S PSDIDT=Y
"RTN","PSDNMSP",66,0)
 . . S ^TMP("PSDNMSP",$J,$S(+$P(PSDX2,U,9):$P($G(^PS(59,+$P(PSDX2,U,9),0)),U,1),1:"UNKNOWN"),$P($G(^VA(200,+PSDUZ,0)),U,1),PSDX)=$P(PSDX0,U,1)_U_PSDIDT_U_$P(PSDRG,U,1)
"RTN","PSDNMSP",67,0)
 ;
"RTN","PSDNMSP",68,0)
PRT ;Report print
"RTN","PSDNMSP",69,0)
 S PSDPG=0,PSDOUT=0
"RTN","PSDNMSP",70,0)
 I '$D(^TMP("PSDNMSP",$J)) D  G DQQ
"RTN","PSDNMSP",71,0)
 . S PSDIV="" S PSDPG=0 D HD,PHD
"RTN","PSDNMSP",72,0)
 . W !!,?10,"<<<< NO DATA FOUND >>>>",!
"RTN","PSDNMSP",73,0)
 S PSDIV=""
"RTN","PSDNMSP",74,0)
 F  S PSDIV=$O(^TMP("PSDNMSP",$J,PSDIV)) Q:(PSDIV="")!(PSDOUT)  D
"RTN","PSDNMSP",75,0)
 .  S PSDPG=0 D HD,PHD
"RTN","PSDNMSP",76,0)
 .  S PSDUZ=""
"RTN","PSDNMSP",77,0)
 .  F  S PSDUZ=$O(^TMP("PSDNMSP",$J,PSDIV,PSDUZ)) Q:(PSDUZ="")!(PSDOUT)  D
"RTN","PSDNMSP",78,0)
 .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMSP",79,0)
 .  .  W !!,PSDUZ
"RTN","PSDNMSP",80,0)
 .  .  S PSDX=0
"RTN","PSDNMSP",81,0)
 .  .  F  S PSDX=$O(^TMP("PSDNMSP",$J,PSDIV,PSDUZ,PSDX)) Q:('PSDX)!(PSDOUT)  D
"RTN","PSDNMSP",82,0)
 .  .  .  S PSDY=$G(^TMP("PSDNMSP",$J,PSDIV,PSDUZ,PSDX))
"RTN","PSDNMSP",83,0)
 .  .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMSP",84,0)
 .  .  .  W !,$P(PSDY,U,1),?25,$P(PSDY,U,2),?40,$P(PSDY,U,3)
"RTN","PSDNMSP",85,0)
 .  I '$G(PSDOUT),$O(^TMP("PSDNMSP",$J,PSDIV))]"" D PAGE
"RTN","PSDNMSP",86,0)
 ;
"RTN","PSDNMSP",87,0)
DQQ W ! K PSDCII,PSDED,PSDODIV,PSDSD,^TMP("PSDNMSP",$J) D ^%ZISC Q
"RTN","PSDNMSP",88,0)
 ;
"RTN","PSDNMSP",89,0)
PHD W !,"Pharmacy User"
"RTN","PSDNMSP",90,0)
 W !,"RX#",?25,"Fill Date",?40,"Drug Name"
"RTN","PSDNMSP",91,0)
 W !,$$REPEAT^XLFSTR("_",IOM)
"RTN","PSDNMSP",92,0)
 Q
"RTN","PSDNMSP",93,0)
PAGE ;
"RTN","PSDNMSP",94,0)
 N DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSDNMSP",95,0)
 I IOST?1"C-".E S DIR(0)="E" D ^DIR W !
"RTN","PSDNMSP",96,0)
 I ($D(DTOUT))!($D(DIRUT)) S PSDOUT=1 Q:$G(PSDOUT)=1
"RTN","PSDNMSP",97,0)
 Q
"RTN","PSDNMSP",98,0)
 ;
"RTN","PSDNMSP",99,0)
EOR ;PSDNMSP - CSM RX Processed by Same Person; 18 DEC 02
"RTN","PSDNMU")
0^2^B21488680
"RTN","PSDNMU",1,0)
PSDNMU ;DOIFO/CMS - CS Monitoring Utility routine ;17 Dec 02
"RTN","PSDNMU",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;*41*;13 Feb 97 
"RTN","PSDNMU",3,0)
 ;Reference to ^PSD(58.8 supported by IA #2711
"RTN","PSDNMU",4,0)
 ;Reference to ^PS(59 supported by IA #2621
"RTN","PSDNMU",5,0)
 Q
"RTN","PSDNMU",6,0)
 ;
"RTN","PSDNMU",7,0)
CII ;Select CS DEA Codes
"RTN","PSDNMU",8,0)
 ; Return PSDCII=2,3,4,5 or user selection
"RTN","PSDNMU",9,0)
 ; Return PSDOUT=1 if '^" entered
"RTN","PSDNMU",10,0)
 N X,Y K DIR,DTOUT,DUOUT,PSDOUT
"RTN","PSDNMU",11,0)
 S DIR(0)="L^2:5:0",DIR("A")="Include RXs with CS schedule(s)"
"RTN","PSDNMU",12,0)
 S DIR("B")="2"
"RTN","PSDNMU",13,0)
 S DIR("?")="Enter range or combination of DEA Codes (schedules) from 2 to 5.     Enter '^' to exit."
"RTN","PSDNMU",14,0)
 D ^DIR K DIR
"RTN","PSDNMU",15,0)
 S PSDCII=Y
"RTN","PSDNMU",16,0)
 I $D(DTOUT)!($D(DUOUT)) K PSDCII S PSDOUT=1
"RTN","PSDNMU",17,0)
CIIQ K DIR,DIRUT,DIROUT,DTOUT,DUOUT,PSDNO
"RTN","PSDNMU",18,0)
 Q
"RTN","PSDNMU",19,0)
 ;
"RTN","PSDNMU",20,0)
CIIO ;Optional Select CS DEA Codes
"RTN","PSDNMU",21,0)
 ; Return PSDCII=2,3,4,5 or user selection or null
"RTN","PSDNMU",22,0)
 ; Return PSDOUT=1 if '^" entered
"RTN","PSDNMU",23,0)
 N X,Y K DIR,DTOUT,DUOUT,PSDOUT
"RTN","PSDNMU",24,0)
 W !,"OPTIONAL"
"RTN","PSDNMU",25,0)
 S DIR(0)="LO^2:5:0",DIR("A")="Include RXs with CS schedule(s)"
"RTN","PSDNMU",26,0)
 S DIR("?")="Enter range or combination of DEA Codes (schedules) from 2 to 5.   Enter '^' to exit."
"RTN","PSDNMU",27,0)
 D ^DIR K DIR
"RTN","PSDNMU",28,0)
 S PSDCII=Y
"RTN","PSDNMU",29,0)
 I $D(DTOUT)!($D(DUOUT)) K PSDCII S PSDOUT=1
"RTN","PSDNMU",30,0)
CIIOQ K DIR,DIRUT,DIROUT,DTOUT,DUOUT,PSDNO
"RTN","PSDNMU",31,0)
 Q
"RTN","PSDNMU",32,0)
 ;
"RTN","PSDNMU",33,0)
INPS ;Select Inpatient Site file 59.4
"RTN","PSDNMU",34,0)
 ; Return PSDIDIV=ien^Name
"RTN","PSDNMU",35,0)
 ; Return PSDOUT=1  If '^' entered
"RTN","PSDNMU",36,0)
 N D,DIC,DTOUT,X,Y K PSDIDIV
"RTN","PSDNMU",37,0)
INPSC S DIC="^PS(59.4,",DIC(0)="QEAM",D="B"
"RTN","PSDNMU",38,0)
 S DIC("S")="I +$P(^(0),""^"",31)"
"RTN","PSDNMU",39,0)
 W ! D ^DIC K DIC
"RTN","PSDNMU",40,0)
 I X="^"!($D(DTOUT)) S PSDOUT=1 G INPSQ
"RTN","PSDNMU",41,0)
 I +Y<0 W !!,"A CS Inpatient Site must be selected!  Enter '^' to exit." G INPSC
"RTN","PSDNMU",42,0)
 I +Y S PSDIDIV=Y G INPSQ
"RTN","PSDNMU",43,0)
INPSQ Q
"RTN","PSDNMU",44,0)
 ;
"RTN","PSDNMU",45,0)
PLOC ;Ask Pharmacy Location
"RTN","PSDNMU",46,0)
 ; PSDIDIV must be defined to selected inpatient site
"RTN","PSDNMU",47,0)
 ; Return PSDPLOC array  ie. PSDPLOC(file58.8ien)=""
"RTN","PSDNMU",48,0)
 ; Return PSDOUT=1  If '^' entered
"RTN","PSDNMU",49,0)
 ;
"RTN","PSDNMU",50,0)
 N DIC,X,Y K PSDPLOC,PSDOUT
"RTN","PSDNMU",51,0)
 S DIC("A")="Select Pharmacy Location(s): "
"RTN","PSDNMU",52,0)
PLOCC S DIC=58.8,DIC(0)="AEMQ",DIC("S")="I $P(^(0),U,3)=+$G(PSDIDIV)" D ^DIC
"RTN","PSDNMU",53,0)
 I X="^ALL" D PLOCA G PLOCQ
"RTN","PSDNMU",54,0)
 I X["^"!($D(DTOUT)) K PSDPLOC S PSDOUT=1 G PLOCQ
"RTN","PSDNMU",55,0)
 I +Y<1,'$O(PSDPLOC(0)) W !!,"A 'Pharmacy Location' must be selected! Enter '^ALL' to select all locations.  Enter '^' to exit." G PLOCC
"RTN","PSDNMU",56,0)
 I +Y<0,$O(PSDPLOC(0)) G PLOCQ
"RTN","PSDNMU",57,0)
 S PSDPLOC(+Y)=$P(Y,U,2)
"RTN","PSDNMU",58,0)
 S DIC("A")="Select another Pharmacy Location: " G PLOCC
"RTN","PSDNMU",59,0)
PLOCQ K DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","PSDNMU",60,0)
 Q
"RTN","PSDNMU",61,0)
 ;
"RTN","PSDNMU",62,0)
PLOCA ;Get all Pharmacy Location for selected Inpatient Site
"RTN","PSDNMU",63,0)
 ; Return PSDPLOC(ien)=Name
"RTN","PSDNMU",64,0)
 N PSDY
"RTN","PSDNMU",65,0)
 S PSDY=0,PSDPLOC="^ALL"
"RTN","PSDNMU",66,0)
 F  S PSDY=$O(^PSD(58.8,PSDY)) Q:'PSDY  D
"RTN","PSDNMU",67,0)
 . I $P($G(^PSD(58.8,PSDY,0)),U,3)'=+PSDIDIV Q
"RTN","PSDNMU",68,0)
 . S PSDPLOC(PSDY)=$P(^PSD(58.8,PSDY,0),U,1)
"RTN","PSDNMU",69,0)
 Q
"RTN","PSDNMU",70,0)
 ;
"RTN","PSDNMU",71,0)
DISD ;Discharge Days Number
"RTN","PSDNMU",72,0)
 ;Return PSDISB - Number of Days to ignore before Discharge Date 
"RTN","PSDNMU",73,0)
 ;Return PSDISA - Number of Days to ignore after Discharge Date
"RTN","PSDNMU",74,0)
 ;Return PSDOUT=1  If '^' entered
"RTN","PSDNMU",75,0)
 ;
"RTN","PSDNMU",76,0)
 N %,%DT,X,Y K DIR,PSDISA,PSDISB
"RTN","PSDNMU",77,0)
 S DIR(0)="NO^0:3:0",DIR("B")=0
"RTN","PSDNMU",78,0)
 S DIR("A")="Number of days to ignore BEFORE discharge date"
"RTN","PSDNMU",79,0)
 S DIR("?")="Enter number of days (0-3) to ignore BEFORE discharge date.  Enter '^' to Exit."
"RTN","PSDNMU",80,0)
 D ^DIR K DIR
"RTN","PSDNMU",81,0)
 I +Y S PSDISB=+Y
"RTN","PSDNMU",82,0)
 I $D(DTOUT)!($D(DUOUT)) S PSDOUT=1 G DISDQ
"RTN","PSDNMU",83,0)
 S DIR(0)="NO^0:3:0",DIR("B")=0
"RTN","PSDNMU",84,0)
 S DIR("A")="Number of days to ignore AFTER  discharge date"
"RTN","PSDNMU",85,0)
 S DIR("?")="Enter number of days (0-3) to ignore AFTER discharge date.  Enter '^' to Exit."
"RTN","PSDNMU",86,0)
 D ^DIR
"RTN","PSDNMU",87,0)
 I +Y S PSDISA=+Y
"RTN","PSDNMU",88,0)
 I $D(DTOUT)!($D(DUOUT)) K PSDISB,PSDISA S PSDOUT=1
"RTN","PSDNMU",89,0)
DISDQ K DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","PSDNMU",90,0)
 Q
"RTN","PSDNMU",91,0)
 ;
"RTN","PSDNMU",92,0)
DATE ;Ask Date Range
"RTN","PSDNMU",93,0)
 ; Pass PSDDTN - Name of Date Range (Opt.)
"RTN","PSDNMU",94,0)
 ; Return PSDSD - Start Date Range ie. 3030109.9999^JAN 10, 2003
"RTN","PSDNMU",95,0)
 ; Return PSDED - End Date Range ie. 3030118.9999^JAN 19, 2003
"RTN","PSDNMU",96,0)
 ; Return PSDOUT=1  If '^' entered
"RTN","PSDNMU",97,0)
 ;
"RTN","PSDNMU",98,0)
 N %,%DT,X,Y K PSDSD,PSDED,PSDOUT
"RTN","PSDNMU",99,0)
DST W ! K %DT S %DT="AEP",%DT("A")="Start with "_$G(PSDDTN)_" Date: " D ^%DT
"RTN","PSDNMU",100,0)
 I X["^" K PSDSD,PSDED S PSDOUT=1 G DATEQ
"RTN","PSDNMU",101,0)
 I Y<0 W !,"Date Range is required!  Enter '^' to exit." G DST
"RTN","PSDNMU",102,0)
 S PSDSD=Y D D^DIQ S PSDSD=PSDSD-.0001,$P(PSDSD,"^",2)=Y
"RTN","PSDNMU",103,0)
 S %DT("A")="End with "_$G(PSDDTN)_" Date: " D ^%DT
"RTN","PSDNMU",104,0)
 I X["^" K PSDSD,PSDED S PSDOUT=1 G DATEQ
"RTN","PSDNMU",105,0)
 I Y<PSDSD W !!,"The ending date of the range must be later than the starting date." G DST
"RTN","PSDNMU",106,0)
 S PSDED=Y D D^DIQ S PSDED=PSDED+.9999,$P(PSDED,"^",2)=Y
"RTN","PSDNMU",107,0)
DATEQ Q
"RTN","PSDNMU",108,0)
 ;
"RTN","PSDNMU",109,0)
 ;
"RTN","PSDNMU",110,0)
DIV ;Ask Outpatient Division(s)
"RTN","PSDNMU",111,0)
 ; Return PSDODIV array  ie. PSDODIV(file59ien)=""
"RTN","PSDNMU",112,0)
 ; Return PSDOUT=1  If '^' entered
"RTN","PSDNMU",113,0)
 ;
"RTN","PSDNMU",114,0)
 N DIC,X,Y K PSDODIV,PSDOUT
"RTN","PSDNMU",115,0)
 S DIC("A")="Select Outpatient Division: "
"RTN","PSDNMU",116,0)
DIVC S DIC=59,DIC(0)="AEMQ" D ^DIC
"RTN","PSDNMU",117,0)
 I X["^"!($D(DTOUT)) K PSDODIV S PSDOUT=1 G DIVQ
"RTN","PSDNMU",118,0)
 I +Y<1,'$O(PSDODIV(0)) W !!,"A 'DIVISION' must be selected!  or Enter '^' to exit." G DIVC
"RTN","PSDNMU",119,0)
 I +Y<0,$O(PSDODIV(0)) G DIVQ
"RTN","PSDNMU",120,0)
 S PSDODIV(+Y)=$P(Y,U,2)_"^"_$P($G(^PS(59,+Y,0)),U,6)
"RTN","PSDNMU",121,0)
 S DIC("A")="Select another Outpatient Division: " G DIVC
"RTN","PSDNMU",122,0)
DIVQ K DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","PSDNMU",123,0)
 Q
"RTN","PSDNMWE")
0^7^B36776333
"RTN","PSDNMWE",1,0)
PSDNMWE ;DOIFO/CMS - CSM No Visits within 12 Months ;18 Dec 02
"RTN","PSDNMWE",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;*41*;13 Feb 97
"RTN","PSDNMWE",3,0)
 ;Reference to ^DPT( supported by IA #10035
"RTN","PSDNMWE",4,0)
 ;Reference to ^PSDRUG( supported by IA #221
"RTN","PSDNMWE",5,0)
 ;Reference to ^PSRX( supported by IA #1977
"RTN","PSDNMWE",6,0)
 Q
"RTN","PSDNMWE",7,0)
 ;
"RTN","PSDNMWE",8,0)
ST ;CS Monitoring OPTION ENTRY
"RTN","PSDNMWE",9,0)
 N PSDODIV,PSDCII,PSDDTN,PSDED,PSDISA,PSDISB,PSDOUT,PSDSD,X,Y,%,%ZIS
"RTN","PSDNMWE",10,0)
 N DIC,DIR,DIRUT,DIROUT,DTOUT,DUOUT,POP,ZTIO,ZTSAVE,ZTSK,ZTRTN,ZTDESC
"RTN","PSDNMWE",11,0)
 W !!,?5,"This report lists released RXs without a visit within 12 months of the"
"RTN","PSDNMWE",12,0)
 W !,?5,"RX Release date.  Excluding RXs released on the same day as a discharge"
"RTN","PSDNMWE",13,0)
 W !,?5,"and within a user defined discharge date range.",!!
"RTN","PSDNMWE",14,0)
 W ! D DIV^PSDNMU I '$O(PSDODIV(0))!($G(PSDOUT)) G END
"RTN","PSDNMWE",15,0)
 S PSDDTN="RX Release" D DATE^PSDNMU I '$G(PSDSD)!($G(PSDOUT)) G END
"RTN","PSDNMWE",16,0)
 W ! D DISD^PSDNMU I $G(PSDOUT) G END
"RTN","PSDNMWE",17,0)
 W ! S DIR("A")="Screen for controlled substance RXs"
"RTN","PSDNMWE",18,0)
 S DIR("B")="Yes",DIR(0)="Y" D ^DIR K DIR I X="^"!($D(DTOUT)) G END
"RTN","PSDNMWE",19,0)
 I Y=1 W ! D CII^PSDNMU I '+$G(PSDCII)!($G(PSDOUT)) G END
"RTN","PSDNMWE",20,0)
 I Y'=1 S PSDCII=""
"RTN","PSDNMWE",21,0)
 ;
"RTN","PSDNMWE",22,0)
 W ! S DIR("A")="Okay to Continue",DIR("B")="No",DIR(0)="Y" D ^DIR
"RTN","PSDNMWE",23,0)
 I Y'=1 W "     <No report>",! G END
"RTN","PSDNMWE",24,0)
 W !!,?9,"This report should be queued to run during non-peak hours.",!
"RTN","PSDNMWE",25,0)
 K IO("Q") S %ZIS="MQ" D ^%ZIS I POP W "  <No device selected.>" G END
"RTN","PSDNMWE",26,0)
 I $D(IO("Q")) D
"RTN","PSDNMWE",27,0)
 .S ZTRTN="DQ^PSDNMWE",ZTDESC="CS Monitoring - PSDNMWE"
"RTN","PSDNMWE",28,0)
 .S ZTSAVE("PSDSD")="",ZTSAVE("PSDODIV(")="",ZTSAVE("PSDCII")="",ZTSAVE("PSDED")="",ZTSAVE("PSDISA")="",ZTSAVE("PSDISB")=""
"RTN","PSDNMWE",29,0)
 .D ^%ZTLOAD W !!?5,"TASK #",$G(ZTSK)," QUEUED!",!
"RTN","PSDNMWE",30,0)
 I '$D(IO("Q")) U IO D DQ
"RTN","PSDNMWE",31,0)
 K IOP,IO("Q")
"RTN","PSDNMWE",32,0)
END Q
"RTN","PSDNMWE",33,0)
 ;
"RTN","PSDNMWE",34,0)
HD ;Report heading
"RTN","PSDNMWE",35,0)
 N PSDD,PSDL,X,Y,%
"RTN","PSDNMWE",36,0)
 W @IOF,$$CJ^XLFSTR("CS Monitoring - No Visits within 12 months of RX Release Report",IOM)
"RTN","PSDNMWE",37,0)
 S PSDL="Outpatient Division(s): "
"RTN","PSDNMWE",38,0)
 S PSDD=0
"RTN","PSDNMWE",39,0)
 F  S PSDD=$O(PSDODIV(PSDD)) Q:'PSDD  S PSDL=PSDL_$P($G(PSDODIV(PSDD)),U,2) I $O(PSDODIV(PSDD)) S PSDL=PSDL_", "
"RTN","PSDNMWE",40,0)
 W !,$$CJ^XLFSTR(PSDL,IOM)
"RTN","PSDNMWE",41,0)
 W !,$$CJ^XLFSTR("Prescriptions released: "_$P(PSDSD,U,2)_" thru "_$P(PSDED,U,2),IOM)
"RTN","PSDNMWE",42,0)
 I $G(PSDISA)!($G(PSDISB)) D
"RTN","PSDNMWE",43,0)
 . S PSDL="Exclude RXs released: "
"RTN","PSDNMWE",44,0)
 . I $G(PSDISB) S PSDL=PSDL_+PSDISB_" day(s) before "
"RTN","PSDNMWE",45,0)
 . I $G(PSDISA) S PSDL=PSDL_+PSDISA_" day(s) after "
"RTN","PSDNMWE",46,0)
 . S PSDL=PSDL_"a discharge date"
"RTN","PSDNMWE",47,0)
 . W !,$$CJ^XLFSTR(PSDL,IOM)
"RTN","PSDNMWE",48,0)
 S PSDL="Controlled Substance schedule(s): "
"RTN","PSDNMWE",49,0)
 F PSDD=1:1:4 I $P(PSDCII,",",PSDD) S PSDL=PSDL_$P(PSDCII,",",PSDD) I $P(PSDCII,",",(PSDD+1)) S PSDL=PSDL_", "
"RTN","PSDNMWE",50,0)
 I +PSDCII W !,$$CJ^XLFSTR(PSDL,IOM)
"RTN","PSDNMWE",51,0)
 W !,"Division: ",$E($G(PSDIV),1,13),?25,"Report Run Date: "
"RTN","PSDNMWE",52,0)
 S PSDPG=PSDPG+1
"RTN","PSDNMWE",53,0)
 D NOW^%DTC W $$FMTE^XLFDT(%),?70,"PAGE: ",PSDPG
"RTN","PSDNMWE",54,0)
 W !,$$REPEAT^XLFSTR("=",IOM)
"RTN","PSDNMWE",55,0)
 QUIT
"RTN","PSDNMWE",56,0)
 ;
"RTN","PSDNMWE",57,0)
DQ ;Report Run
"RTN","PSDNMWE",58,0)
 N D0,DA,DFN,DIC,DIQ,DR
"RTN","PSDNMWE",59,0)
 N PSDA,PSDD,PSDFD,PSDI,PSDIDT,PSDIV,PSDO,PSDOUT,PSDP,PSDPG,PSDS,PSDRG
"RTN","PSDNMWE",60,0)
 N PSDUZ,PSDY,PSDX,PSDX0,PSDX2,PSDXOR1,PSDY,X,X1,X2,Y,%,%DT
"RTN","PSDNMWE",61,0)
 K ^TMP("PSDNMWE",$J)
"RTN","PSDNMWE",62,0)
 I IOST?1"C-".E W !!,?10,"Compiling report, please wait ..."
"RTN","PSDNMWE",63,0)
 S PSDFD=+PSDSD
"RTN","PSDNMWE",64,0)
 F  S PSDFD=$O(^PSRX("AL",PSDFD)) Q:('PSDFD)!(PSDFD]+PSDED)  D
"RTN","PSDNMWE",65,0)
 . S PSDX=0
"RTN","PSDNMWE",66,0)
 . F  S PSDX=$O(^PSRX("AL",PSDFD,PSDX)) Q:'PSDX  D
"RTN","PSDNMWE",67,0)
 . . D KVA^VADPT
"RTN","PSDNMWE",68,0)
 . . S PSDX0=$G(^PSRX(PSDX,0)) I PSDX0']"" Q
"RTN","PSDNMWE",69,0)
 . . S PSDX2=$G(^PSRX(PSDX,2))
"RTN","PSDNMWE",70,0)
 . . I '$D(PSDODIV(+$P(PSDX2,U,9))) Q
"RTN","PSDNMWE",71,0)
 . . S PSDRG=$G(^PSDRUG(+$P(PSDX0,U,6),0))
"RTN","PSDNMWE",72,0)
 . . I +$G(PSDCII) S PSDP=0 D  I PSDP Q
"RTN","PSDNMWE",73,0)
 . . . F PSDY=1:1:4 S PSDA=$P(PSDCII,",",PSDY) I PSDA,$P(PSDRG,U,3)[PSDA S PSDP=1 Q
"RTN","PSDNMWE",74,0)
 . . I +$G(PSDCII),'PSDP Q
"RTN","PSDNMWE",75,0)
 . . ;Check Discharge Date
"RTN","PSDNMWE",76,0)
 . . S DFN=+$P(PSDX0,U,2) D DEM^VADPT
"RTN","PSDNMWE",77,0)
 . . S VAIP("D")=+$P(PSDFD,".",1),PSDP=0
"RTN","PSDNMWE",78,0)
 . . I $D(^TMP("PSDNMWE",$J,1,DFN,VAIP("D"))) Q
"RTN","PSDNMWE",79,0)
 . . D IN5^VADPT D  I $G(PSDP) Q
"RTN","PSDNMWE",80,0)
 . . . I +$G(VAIP(17,2))[VAIP("D") S ^TMP("PSDNMWE",$J,1,DFN,VAIP("D"))="" S PSDP=1 Q
"RTN","PSDNMWE",81,0)
 . . . I +$G(VAIP(17,2)),$G(PSDISA) D  I $G(PSDP) Q
"RTN","PSDNMWE",82,0)
 . . . . S X1=+$G(VAIP(17,2)),X2=+PSDISA D C^%DTC S PSDD=X
"RTN","PSDNMWE",83,0)
 . . . . I VAIP("D")'>PSDD S PSDP=1 Q
"RTN","PSDNMWE",84,0)
 . . . I +$G(VAIP(17,2)),$G(PSDISB) D  I $G(PSDP) Q
"RTN","PSDNMWE",85,0)
 . . . . S X1=+$G(VAIP(17,2)),X2=-PSDISB D C^%DTC S PSDD=X
"RTN","PSDNMWE",86,0)
 . . . . I VAIP("D")'<PSDD S PSDP=1 Q
"RTN","PSDNMWE",87,0)
 . . ;
"RTN","PSDNMWE",88,0)
 . . ;Check Visits within 12 months
"RTN","PSDNMWE",89,0)
 . . S PSDD="",X1=+PSDFD,X2=-365 D C^%DTC S PSDY=X
"RTN","PSDNMWE",90,0)
 . . K VASD S VASD("W")=1,VASD("F")=PSDY,VASD("T")=PSDFD
"RTN","PSDNMWE",91,0)
 . . D SDA^VADPT
"RTN","PSDNMWE",92,0)
 . . S PSDY=0
"RTN","PSDNMWE",93,0)
 . . F  S PSDY=$O(^UTILITY("VASD",$J,PSDY)) Q:'PSDY  D
"RTN","PSDNMWE",94,0)
 . . . S PSDI=$G(^UTILITY("VASD",$J,PSDY,"I"))
"RTN","PSDNMWE",95,0)
 . . . I $P(PSDI,U,3)="" K PSDP Q
"RTN","PSDNMWE",96,0)
 . . . S PSDP=1
"RTN","PSDNMWE",97,0)
 . . I $G(PSDP)=1!('$O(^UTILITY("VASD",$J,0))) D
"RTN","PSDNMWE",98,0)
 . . . I +$G(VADM(6)),+$G(VADM(6))']VAIP("D") S PSDD=$P($G(VADM(6)),U,2)
"RTN","PSDNMWE",99,0)
 . . . S Y=+PSDFD D D^DIQ S PSDA=Y
"RTN","PSDNMWE",100,0)
 . . . S PSDUZ=$P($G(^DPT(DFN,0)),U,1)_"  ("_$E(VA("PID"),5,12)_")"
"RTN","PSDNMWE",101,0)
 . . . S DIC="^PSRX(",DA=PSDX,DR="3;20",DIQ(0)="E",DIQ="PSDO"
"RTN","PSDNMWE",102,0)
 . . . K PSDO D EN^DIQ1
"RTN","PSDNMWE",103,0)
 . . . S ^TMP("PSDNMWE",$J,$S($G(PSDO(52,PSDX,20,"E"))]"":$G(PSDO(52,PSDX,20,"E")),1:"UNKNOWN"),$S($G(PSDO(52,PSDX,3,"E"))]"":$G(PSDO(52,PSDX,3,"E")),1:"UNKNOWN"),PSDUZ,PSDX)=$P(PSDX0,U,1)_U_PSDA_U_$P(PSDRG,U,1)_U_$G(PSDD)
"RTN","PSDNMWE",104,0)
 D KVA^VADPT
"RTN","PSDNMWE",105,0)
 ;
"RTN","PSDNMWE",106,0)
PRT ;Report print
"RTN","PSDNMWE",107,0)
 S PSDPG=0,PSDOUT=0
"RTN","PSDNMWE",108,0)
 I '$D(^TMP("PSDNMWE",$J)) D  G DQQ
"RTN","PSDNMWE",109,0)
 . S PSDIV="",PSDPG=0 D HD,PHD
"RTN","PSDNMWE",110,0)
 . W !!,?10,"<<<< NO DATA FOUND >>>>",!
"RTN","PSDNMWE",111,0)
 S PSDIV=""
"RTN","PSDNMWE",112,0)
 F  S PSDIV=$O(^TMP("PSDNMWE",$J,PSDIV)) Q:(PSDIV="")!(PSDOUT)  D
"RTN","PSDNMWE",113,0)
 .  S PSDPG=0 D HD,PHD
"RTN","PSDNMWE",114,0)
 .  S PSDS=""
"RTN","PSDNMWE",115,0)
 .  F  S PSDS=$O(^TMP("PSDNMWE",$J,PSDIV,PSDS)) Q:(PSDS="")!(PSDOUT)  D
"RTN","PSDNMWE",116,0)
 .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMWE",117,0)
 .  .  W !!,?12,"RX PATIENT STATUS: ",PSDS
"RTN","PSDNMWE",118,0)
 .  .  S PSDRG=""
"RTN","PSDNMWE",119,0)
 .  .  F  S PSDRG=$O(^TMP("PSDNMWE",$J,PSDIV,PSDS,PSDRG)) Q:(PSDRG="")!(PSDOUT)  D
"RTN","PSDNMWE",120,0)
 .  .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMWE",121,0)
 .  .  .  W !!,"PATIENT NAME: ",PSDRG
"RTN","PSDNMWE",122,0)
 .  .  .  S PSDX=0
"RTN","PSDNMWE",123,0)
 .  .  .  F  S PSDX=$O(^TMP("PSDNMWE",$J,PSDIV,PSDS,PSDRG,PSDX)) Q:('PSDX)!(PSDOUT)  D
"RTN","PSDNMWE",124,0)
 .  .  .  .  S PSDY=$G(^TMP("PSDNMWE",$J,PSDIV,PSDS,PSDRG,PSDX))
"RTN","PSDNMWE",125,0)
 .  .  .  .  I ($Y+3)>IOSL D PAGE Q:PSDOUT  D HD,PHD
"RTN","PSDNMWE",126,0)
 .  .  .  .  W !,$P(PSDY,U,1),?12,$P(PSDY,U,2),?40,$P(PSDY,U,3)
"RTN","PSDNMWE",127,0)
 .  .  .  .  I $P(PSDY,U,4)]"" W !,?12,"*Date of Death "_$P(PSDY,U,4)_" before RX Release Date!"
"RTN","PSDNMWE",128,0)
 .  I '$G(PSDOUT),$O(^TMP("PSDNMWE",$J,PSDIV))]"" D PAGE
"RTN","PSDNMWE",129,0)
 ;
"RTN","PSDNMWE",130,0)
DQQ W ! K PSDCII,PSDODIV,PSDSD,PSDED,PSDISA,PSDISB,^TMP("PSDNMWE",$J) D ^%ZISC Q
"RTN","PSDNMWE",131,0)
 ;
"RTN","PSDNMWE",132,0)
PHD ;
"RTN","PSDNMWE",133,0)
 W !,"RX#",?12,"Release Date",?40,"Drug"
"RTN","PSDNMWE",134,0)
 W !,$$REPEAT^XLFSTR("_",IOM)
"RTN","PSDNMWE",135,0)
 Q
"RTN","PSDNMWE",136,0)
PAGE ;
"RTN","PSDNMWE",137,0)
 N DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSDNMWE",138,0)
 I IOST?1"C-".E S DIR(0)="E" D ^DIR W !
"RTN","PSDNMWE",139,0)
 I ($D(DTOUT))!($D(DIRUT)) S PSDOUT=1 Q:$G(PSDOUT)=1
"RTN","PSDNMWE",140,0)
 Q
"RTN","PSDNMWE",141,0)
 ;
"RTN","PSDNMWE",142,0)
EOR ;PSDNMWE - CSM No Visits in 12 Months; 18 DEC 02
"VER")
8.0^22.0
**END**
**END**
