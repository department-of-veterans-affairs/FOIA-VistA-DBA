EMERGENCY Released PSO*7*235 SEQ #208
Extracted from mail message
**KIDS**:PSO*7.0*235^

**INSTALL NAME**
PSO*7.0*235
"BLD",6003,0)
PSO*7.0*235^OUTPATIENT PHARMACY^0^3060317^y
"BLD",6003,1,0)
^^16^16^3060220^
"BLD",6003,1,1,0)
This patch adds the proper escape sequences to the Outpatient Pharmacy
"BLD",6003,1,2,0)
VDEF (Vista Data Extraction Framework) message that sends prescription
"BLD",6003,1,3,0)
information to the HDR (Health Data Repository). This will help avoid 
"BLD",6003,1,4,0)
errors that can occur when special delimiting characters are found in 
"BLD",6003,1,5,0)
Vista fields.
"BLD",6003,1,6,0)
 
"BLD",6003,1,7,0)
This patch also makes modifications to the trigger events that send 
"BLD",6003,1,8,0)
prescription information to the HDR, using the VDEF. A problem was
"BLD",6003,1,9,0)
reported where the Clinical ID information was not being sent in some
"BLD",6003,1,10,0)
messages. This patch fixes that problem.
"BLD",6003,1,11,0)
 
"BLD",6003,1,12,0)
A request has also been made add two new trigger events, those being when
"BLD",6003,1,13,0)
the status of a prescription changes from Active to Suspended, and from
"BLD",6003,1,14,0)
Suspended to Active. This patch add those trigger events.
"BLD",6003,1,15,0)
 
"BLD",6003,1,16,0)
The name of the Institution has also been added to the message.
"BLD",6003,4,0)
^9.64PA^^
"BLD",6003,6)
8^
"BLD",6003,"KRN",0)
^9.67PA^8989.52^19
"BLD",6003,"KRN",.4,0)
.4
"BLD",6003,"KRN",.401,0)
.401
"BLD",6003,"KRN",.402,0)
.402
"BLD",6003,"KRN",.403,0)
.403
"BLD",6003,"KRN",.5,0)
.5
"BLD",6003,"KRN",.84,0)
.84
"BLD",6003,"KRN",3.6,0)
3.6
"BLD",6003,"KRN",3.8,0)
3.8
"BLD",6003,"KRN",9.2,0)
9.2
"BLD",6003,"KRN",9.8,0)
9.8
"BLD",6003,"KRN",9.8,"NM",0)
^9.68A^11^11
"BLD",6003,"KRN",9.8,"NM",1,0)
PSOVDF1^^0^B87117915
"BLD",6003,"KRN",9.8,"NM",2,0)
PSOVDF2^^0^B85283768
"BLD",6003,"KRN",9.8,"NM",3,0)
PSOVDF3^^0^B24142157
"BLD",6003,"KRN",9.8,"NM",4,0)
PSOHLSN1^^0^B86702182
"BLD",6003,"KRN",9.8,"NM",5,0)
PSOHLNEW^^0^B79208522
"BLD",6003,"KRN",9.8,"NM",6,0)
PSOSUTL^^0^B65085992
"BLD",6003,"KRN",9.8,"NM",7,0)
PSOBUILD^^0^B39272146
"BLD",6003,"KRN",9.8,"NM",8,0)
PSOSUCHG^^0^B75647503
"BLD",6003,"KRN",9.8,"NM",9,0)
PSOCAN2^^0^B60252602
"BLD",6003,"KRN",9.8,"NM",10,0)
PSOCAN3^^0^B73113946
"BLD",6003,"KRN",9.8,"NM",11,0)
PSOHLNE1^^0^B72765875
"BLD",6003,"KRN",9.8,"NM","B","PSOBUILD",7)

"BLD",6003,"KRN",9.8,"NM","B","PSOCAN2",9)

"BLD",6003,"KRN",9.8,"NM","B","PSOCAN3",10)

"BLD",6003,"KRN",9.8,"NM","B","PSOHLNE1",11)

"BLD",6003,"KRN",9.8,"NM","B","PSOHLNEW",5)

"BLD",6003,"KRN",9.8,"NM","B","PSOHLSN1",4)

"BLD",6003,"KRN",9.8,"NM","B","PSOSUCHG",8)

"BLD",6003,"KRN",9.8,"NM","B","PSOSUTL",6)

"BLD",6003,"KRN",9.8,"NM","B","PSOVDF1",1)

"BLD",6003,"KRN",9.8,"NM","B","PSOVDF2",2)

"BLD",6003,"KRN",9.8,"NM","B","PSOVDF3",3)

"BLD",6003,"KRN",19,0)
19
"BLD",6003,"KRN",19.1,0)
19.1
"BLD",6003,"KRN",101,0)
101
"BLD",6003,"KRN",409.61,0)
409.61
"BLD",6003,"KRN",771,0)
771
"BLD",6003,"KRN",870,0)
870
"BLD",6003,"KRN",8989.51,0)
8989.51
"BLD",6003,"KRN",8989.52,0)
8989.52
"BLD",6003,"KRN",8994,0)
8994
"BLD",6003,"KRN","B",.4,.4)

"BLD",6003,"KRN","B",.401,.401)

"BLD",6003,"KRN","B",.402,.402)

"BLD",6003,"KRN","B",.403,.403)

"BLD",6003,"KRN","B",.5,.5)

"BLD",6003,"KRN","B",.84,.84)

"BLD",6003,"KRN","B",3.6,3.6)

"BLD",6003,"KRN","B",3.8,3.8)

"BLD",6003,"KRN","B",9.2,9.2)

"BLD",6003,"KRN","B",9.8,9.8)

"BLD",6003,"KRN","B",19,19)

"BLD",6003,"KRN","B",19.1,19.1)

"BLD",6003,"KRN","B",101,101)

"BLD",6003,"KRN","B",409.61,409.61)

"BLD",6003,"KRN","B",771,771)

"BLD",6003,"KRN","B",870,870)

"BLD",6003,"KRN","B",8989.51,8989.51)

"BLD",6003,"KRN","B",8989.52,8989.52)

"BLD",6003,"KRN","B",8994,8994)

"BLD",6003,"QUES",0)
^9.62^^
"BLD",6003,"REQB",0)
^9.611^7^4
"BLD",6003,"REQB",1,0)
PSO*7.0*220^2
"BLD",6003,"REQB",3,0)
PSO*7.0*167^2
"BLD",6003,"REQB",6,0)
PSO*7.0*164^2
"BLD",6003,"REQB",7,0)
PSO*7.0*223^2
"BLD",6003,"REQB","B","PSO*7.0*164",6)

"BLD",6003,"REQB","B","PSO*7.0*167",3)

"BLD",6003,"REQB","B","PSO*7.0*220",1)

"BLD",6003,"REQB","B","PSO*7.0*223",7)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
235^3060317^11859
"PKG",141,22,1,"PAH",1,1,0)
^^16^16^3060317
"PKG",141,22,1,"PAH",1,1,1,0)
This patch adds the proper escape sequences to the Outpatient Pharmacy
"PKG",141,22,1,"PAH",1,1,2,0)
VDEF (Vista Data Extraction Framework) message that sends prescription
"PKG",141,22,1,"PAH",1,1,3,0)
information to the HDR (Health Data Repository). This will help avoid 
"PKG",141,22,1,"PAH",1,1,4,0)
errors that can occur when special delimiting characters are found in 
"PKG",141,22,1,"PAH",1,1,5,0)
Vista fields.
"PKG",141,22,1,"PAH",1,1,6,0)
 
"PKG",141,22,1,"PAH",1,1,7,0)
This patch also makes modifications to the trigger events that send 
"PKG",141,22,1,"PAH",1,1,8,0)
prescription information to the HDR, using the VDEF. A problem was
"PKG",141,22,1,"PAH",1,1,9,0)
reported where the Clinical ID information was not being sent in some
"PKG",141,22,1,"PAH",1,1,10,0)
messages. This patch fixes that problem.
"PKG",141,22,1,"PAH",1,1,11,0)
 
"PKG",141,22,1,"PAH",1,1,12,0)
A request has also been made add two new trigger events, those being when
"PKG",141,22,1,"PAH",1,1,13,0)
the status of a prescription changes from Active to Suspended, and from
"PKG",141,22,1,"PAH",1,1,14,0)
Suspended to Active. This patch add those trigger events.
"PKG",141,22,1,"PAH",1,1,15,0)
 
"PKG",141,22,1,"PAH",1,1,16,0)
The name of the Institution has also been added to the message.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
11
"RTN","PSOBUILD")
0^7^B39272146^B38788021
"RTN","PSOBUILD",1,0)
PSOBUILD ;IHS/DSD/JCM - BUILD ARRAY OF PATIENTS CURRENT MEDS  [ 07/15/96  5:25 PM ]
"RTN","PSOBUILD",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,82,119,132,235**;DEC 1997
"RTN","PSOBUILD",3,0)
 ;External reference ^PS(50.606 supported by DBIA 2174
"RTN","PSOBUILD",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOBUILD",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOBUILD",6,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOBUILD",7,0)
 ; Input variables: PSODFN,DT,PSODTCUT
"RTN","PSOBUILD",8,0)
START N ORD K PSOSD I '$D(PSODFN)!('$D(DT)) G END
"RTN","PSOBUILD",9,0)
 D EOJ,INIT G:PSOQFLG END D BUILD
"RTN","PSOBUILD",10,0)
 S STA="ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSOBUILD",11,0)
 S DRG="" F I=0:0 S DRG=$O(PSOSD(DRG)) Q:DRG=""  I $G(PSOSD(DRG))]"" S PSOSD($P(STA,"^",$P(PSOSD(DRG),"^",2)+1),DRG)=PSOSD(DRG) D  K PSOSD(DRG)
"RTN","PSOBUILD",12,0)
 .S $P(PSOSD($P(STA,"^",$P(PSOSD(DRG),"^",2)+1),DRG),"^",9)=$G(^TMP("PS",$J,$P(STA,"^",$P(PSOSD(DRG),"^",2)+1),DRG))
"RTN","PSOBUILD",13,0)
 F PEN=0:0 S PEN=$O(^PS(52.41,"P",PSODFN,PEN)) Q:'PEN  S ORD=^PS(52.41,PEN,0),PSOOI=$P(ORD,"^",8),PSODD=+$P(ORD,"^",9) D:$P(ORD,"^",3)'="DC"&($P(ORD,"^",3)'="DE")&($P(ORD,"^",3)'="HD")
"RTN","PSOBUILD",14,0)
 .S DRG=$S(PSODD:$P($G(^PSDRUG(PSODD,0)),"^"),+PSOOI&('PSODD):$P(^PS(50.7,+PSOOI,0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,+PSOOI,0),"^",2),0),"^"),1:"") Q:DRG']""
"RTN","PSOBUILD",15,0)
 .I $D(PSOSD("PENDING",DRG)) S DRG=DRG_"^"_PEN
"RTN","PSOBUILD",16,0)
 .S PSOSD("PENDING",DRG)="*****^17^Z^Z^"_$S(PSODD:$P(^PSDRUG(PSODD,0),"^",2),1:"")_"^"_$P(^PS(52.41,PEN,0),"^",11)_"^"_$S($G(^PSDRUG(PSODD,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:"")
"RTN","PSOBUILD",17,0)
 .S PSOSD("PENDING",DRG)=PSOSD("PENDING",DRG)_"^"_$P(ORD,"^",10)_"^"_$P(ORD,"^",6)_"^"_PEN_"^"_$S($G(PSODD):$G(PSODD),1:""),PSOSD=+$G(PSOSD)+1 K PSOOI,PSODD
"RTN","PSOBUILD",18,0)
 F NVA=0:0 S NVA=$O(^PS(55,PSODFN,"NVA",NVA)) Q:'NVA  S NON=^PS(55,PSODFN,"NVA",NVA,0) D:'$P(^PS(55,PSODFN,"NVA",NVA,0),"^",7)
"RTN","PSOBUILD",19,0)
 .S PSODD=$P(NON,"^",2),PSOOI=$P(NON,"^")
"RTN","PSOBUILD",20,0)
 .S DRG=$S(PSODD:$P($G(^PSDRUG(PSODD,0)),"^"),+PSOOI&('PSODD):$P(^PS(50.7,+PSOOI,0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,+PSOOI,0),"^",2),0),"^"),1:"")
"RTN","PSOBUILD",21,0)
 .I $D(PSOSD("ZNONVA",DRG)) S DRG=DRG_"^"_NVA
"RTN","PSOBUILD",22,0)
 .S PSOSD("ZNONVA",DRG)="****^9^Z^Z^"_$S($P(NON,"^",2):$P(^PSDRUG($P(NON,"^",2),0),"^",2),1:"")_"^"_$P(NON,"^",3)_"^^"_$P(NON,"^",5)_"^"_$P(NON,"^",10)_"^"_NVA_"^"_$P(NON,"^",2)
"RTN","PSOBUILD",23,0)
 .I $P(NON,"^",2) S $P(PSOSD("ZNONVA",DRG),"^",7)=$S($G(^PSDRUG(PSODD,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:"")
"RTN","PSOBUILD",24,0)
 .S PSOSD=+$G(PSOSD)+1
"RTN","PSOBUILD",25,0)
END D EOJ
"RTN","PSOBUILD",26,0)
 Q
"RTN","PSOBUILD",27,0)
INIT ;
"RTN","PSOBUILD",28,0)
 K PSOSD,PSOMED S PSOQFLG=0,U="^",PSOBUILD("COUNT")=0 G:$D(PSODTCUT) INITX
"RTN","PSOBUILD",29,0)
 I '$D(^PS(53,"B","OUTPATIENT")) S PSOQFLG=1 G INITX
"RTN","PSOBUILD",30,0)
 S PSOX=$O(^PS(53,"B","OUTPATIENT","")) I 'PSOX S PSOQFLG=1 G INITX
"RTN","PSOBUILD",31,0)
 ;S DAYS=$S($D(DAYS360):360,1:45),X2=-$S($P($G(^PS(53,PSOX,0)),"^",3)+15>DAYS:$P($G(^(0)),"^",3)+15,1:DAYS),X1=DT D C^%DTC S PSODTCUT=X
"RTN","PSOBUILD",32,0)
 S X2=-120,X1=DT D C^%DTC S PSODTCUT=X
"RTN","PSOBUILD",33,0)
INITX K X,X1,X2,PSOX
"RTN","PSOBUILD",34,0)
 Q
"RTN","PSOBUILD",35,0)
 ;
"RTN","PSOBUILD",36,0)
BUILD ;build profiles
"RTN","PSOBUILD",37,0)
 F PSOEXPDT=(PSODTCUT-1):0 S PSOEXPDT=$O(^PS(55,PSODFN,"P","A",PSOEXPDT)) Q:'PSOEXPDT  F PSOBUILD("RX")=0:0 S PSOBUILD("RX")=$O(^PS(55,PSODFN,"P","A",PSOEXPDT,PSOBUILD("RX"))) Q:'PSOBUILD("RX")  I $D(^PSRX(PSOBUILD("RX"),0)) D GET
"RTN","PSOBUILD",38,0)
BUILDX I PSOBUILD("COUNT")>0 S PSOSD=PSOBUILD("COUNT")
"RTN","PSOBUILD",39,0)
 Q
"RTN","PSOBUILD",40,0)
GET ;data for profiles
"RTN","PSOBUILD",41,0)
 Q:'$P(^PSRX(PSOBUILD("RX"),0),"^",2)
"RTN","PSOBUILD",42,0)
 S (PSOSTF,PSOSTN)="",PSORX0=^PSRX(PSOBUILD("RX"),0),PSOST0=+^PSRX(PSOBUILD("RX"),"STA"),$P(PSORX0,"^",15)=PSOST0
"RTN","PSOBUILD",43,0)
 G:PSOST0=13 GETX S PSORX2=$G(^PSRX(PSOBUILD("RX"),2))
"RTN","PSOBUILD",44,0)
 S PSORX3=$G(^PSRX(PSOBUILD("RX"),3)) S:PSORX3="" PSORX3=$P(PSORX2,"^",2)
"RTN","PSOBUILD",45,0)
 S PSODRG=+$P(PSORX0,"^",6) G:'$D(^PSDRUG(PSODRG,0)) GETX S PSODRUG0=^PSDRUG(PSODRG,0),PSOVACL=$P(PSODRUG0,"^",2),PSODYS=$P(PSORX0,"^",8)
"RTN","PSOBUILD",46,0)
 ;
"RTN","PSOBUILD",47,0)
 I PSOST0<12,PSOEXPDT<DT D:$P(PSORX0,"^",15)'=11
"RTN","PSOBUILD",48,0)
 .S PSOST0=11,$P(PSORX0,"^",15)=11 N DIE,DIC,DR,DA,PSOBEXDA S DIE=52,(DA,PSOBEXDA)=PSOBUILD("RX"),DR="100////11" D ^DIE K DIE,DIC,DR
"RTN","PSOBUILD",49,0)
 .D ECAN^PSOUTL(DA) K DA
"RTN","PSOBUILD",50,0)
 .S STAT="SC",PHARMST="ZE",COMM="Medication Expired on "_$E(PSOEXPDT,4,5)_"/"_$E(PSOEXPDT,6,7)_"/"_$E(PSOEXPDT,2,3) D EN^PSOHLSN1(PSOBEXDA,STAT,PHARMST,COMM) K COMM,STAT,PHARMST,PSOBEXDA
"RTN","PSOBUILD",51,0)
 I PSOST0=12,PSOEXPDT<DT S PSOST0=12
"RTN","PSOBUILD",52,0)
 I PSOST0=5 D  G GT1
"RTN","PSOBUILD",53,0)
 .I $O(^PS(52.5,"B",PSOBUILD("RX"),0)),'$D(^PS(52.5,+$O(^(0)),0)) D  Q
"RTN","PSOBUILD",54,0)
 ..S PSOST0=0 D FSTA
"RTN","PSOBUILD",55,0)
 ..K ^PS(52.5,"B",PSOBUILD("RX"),$O(^PS(52.5,"B",PSOBUILD("RX"),0)))
"RTN","PSOBUILD",56,0)
 .I '$O(^PS(52.5,"B",PSOBUILD("RX"),0)) S PSOST0=0 D FSTA
"RTN","PSOBUILD",57,0)
 I 'PSOST0 D STAT
"RTN","PSOBUILD",58,0)
GT1 G GETX:$D(NOEXP)&(PSOST0=11)
"RTN","PSOBUILD",59,0)
 I $D(^PSDRUG(PSODRG,"I")),^("I")]"",DT>^("I") S PSOSTN=PSOSTN_"A" I $P($G(PSOPAR),"^",11)']"" S PSOSTF=PSOSTF_"A"
"RTN","PSOBUILD",60,0)
 S PSONDF=$S($G(^PSDRUG(PSODRG,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOBUILD",61,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" S PSOSTN=PSOSTN_"M"
"RTN","PSOBUILD",62,0)
 S CLOZPT=$S($P($G(^PSDRUG(PSODRG,"CLOZ1")),"^")="PSOCLO1":1,1:0)
"RTN","PSOBUILD",63,0)
 I 'CLOZPT,$P(PSODRUG0,"^",3)["A",$P(PSODRUG0,"^",3)'["B" S PSOSTN=PSOSTN_"B",PSOSTF=PSOSTF_"B"
"RTN","PSOBUILD",64,0)
 K CLOZPT I $P(PSODRUG0,"^",3)["W" S PSOSTN=PSOSTN_"C"
"RTN","PSOBUILD",65,0)
 I $D(^PS(53,+$P(PSORX0,"^",3),0)),'$P(^(0),"^",5) S PSOSTN=PSOSTN_"D"
"RTN","PSOBUILD",66,0)
 I PSOST0=1 S PSOSTN=PSOSTN_"E"
"RTN","PSOBUILD",67,0)
 S PSOLC=$P(PSORX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)>90 S PSOSTN=PSOSTN_"F"
"RTN","PSOBUILD",68,0)
 I PSOST0,PSOST0'=2,PSOST0'=6 S PSOSTF=PSOSTF_"Z"
"RTN","PSOBUILD",69,0)
 I $G(PSORX("BAR CODE")),PSOST0,PSOST0'=2,PSOST0'=5,PSOST0'=6,PSOST0'=11,PSOST0'=12 S PSOSTN=PSOSTN_"Z" G BARC
"RTN","PSOBUILD",70,0)
 I PSOST0,PSOST0'=2,PSOST0'=5,PSOST0'=6,PSOST0'=11,PSOST0'=12,PSOST0'=14 S PSOSTN=PSOSTN_"Z"
"RTN","PSOBUILD",71,0)
BARC S PSORFRM=$P(PSORX0,"^",9) F PSOJ=0:0 S PSOJ=$O(^PSRX(PSOBUILD("RX"),1,PSOJ)) Q:'PSOJ  S PSORFRM=PSORFRM-1
"RTN","PSOBUILD",72,0)
 S:PSORFRM<0 PSORFRM=0 S:PSORFRM=0 PSOSTF=PSOSTF_"G"
"RTN","PSOBUILD",73,0)
 S PSODRUGN=$P(PSODRUG0,"^") I $D(PSOSD(PSODRUGN)),PSOST0>10 Q:$P(PSOSD(PSODRUGN),"^",2)<11  Q:$P(PSOSD(PSODRUGN),"^",2)>10&($P(PSORX0,"^",13)<$P(^PSRX(+$P(PSOSD(PSODRUGN),"^"),0),"^",13))
"RTN","PSOBUILD",74,0)
 S:'$D(PSOSD(PSODRUGN)) PSOBUILD("COUNT")=PSOBUILD("COUNT")+1
"RTN","PSOBUILD",75,0)
 I $D(PSOSD(PSODRUGN)),$P(PSOSD(PSODRUGN),"^",2)<10,PSOST0<10 S PSOSD(PSODRUGN_"^"_PSOBUILD("RX"))=PSOBUILD("RX")_"^"_PSOST0_"^"_PSOSTN_"^"_PSOSTF_"^"_PSOVACL_"^"_PSORFRM_"^"_PSONDF_"^"_PSODYS,PSOBUILD("COUNT")=PSOBUILD("COUNT")+1
"RTN","PSOBUILD",76,0)
 E  S PSOSD(PSODRUGN)=PSOBUILD("RX")_"^"_PSOST0_"^"_PSOSTN_"^"_PSOSTF_"^"_PSOVACL_"^"_PSORFRM_"^"_PSONDF_"^"_PSODYS
"RTN","PSOBUILD",77,0)
GETX Q
"RTN","PSOBUILD",78,0)
STAT N X S X=+$O(^PS(52.5,"B",PSOBUILD("RX"),0))
"RTN","PSOBUILD",79,0)
 I X,$D(^PS(52.5,X,0)),$P($G(^PS(52.5,X,0)),"^",7)'="X",'$G(^PS(52.5,X,"P")) S PSOST0=5
"RTN","PSOBUILD",80,0)
 I PSOST0 D FSTA
"RTN","PSOBUILD",81,0)
 Q
"RTN","PSOBUILD",82,0)
FSTA S $P(PSORX0,"^",15)=PSOST0
"RTN","PSOBUILD",83,0)
 N DIE,DR,DA S DIE=52,DA=PSOBUILD("RX"),DR="100////"_PSOST0 D ^DIE K DIE,DR,DA
"RTN","PSOBUILD",84,0)
 Q
"RTN","PSOBUILD",85,0)
 ;
"RTN","PSOBUILD",86,0)
EOJ K ORD,PSOX,PSOEXPDT,PSODRG,PSODRUG0,PSOLC,PSONDF,PSOQFLG,PSORFRM,PSORX0,PSORX2,PSORX3,PSOST0,PSOSTF,PSOSTN,PSOJ,PSODRUGN,PSOVACL,PSOBUILD,PSODYS,PEN,DRG,NON,NVA
"RTN","PSOBUILD",87,0)
 Q
"RTN","PSOBUILD",88,0)
INPAT(PSODFN) ;entry point for inpat meds to view patient's outpat. meds
"RTN","PSOBUILD",89,0)
 D FULL^VALM1
"RTN","PSOBUILD",90,0)
 S INPAT=1,X2=-120,X1=DT D C^%DTC S PSODTCUT=X D START,^PSODSPL
"RTN","PSOBUILD",91,0)
 K PSOSD,DDH,PSCNT,PSOCT,PSODD,PSOOI,PSOPAR,PSOSTA,STP,STR,PSODTCUT,PSODFN,INPAT,DRG
"RTN","PSOBUILD",92,0)
 Q
"RTN","PSOCAN2")
0^9^B60252602^B58658340
"RTN","PSOCAN2",1,0)
PSOCAN2 ;BHAM ISC/JMB - modular rx cancel with speed ability drug check ; 07/25/96  7:23 PM
"RTN","PSOCAN2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,18,62,46,88,164,235**;DEC 1997
"RTN","PSOCAN2",3,0)
 ;External reference to ^PSDRUG supported by dbia 221
"RTN","PSOCAN2",4,0)
REINS N DODR
"RTN","PSOCAN2",5,0)
 I $P(^PSRX(DA,2),"^",6)<DT D  Q
"RTN","PSOCAN2",6,0)
 .S Y=$P(^PSRX(DA,2),"^",6) X ^DD("DD")
"RTN","PSOCAN2",7,0)
 .W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" Drug: "_$S($D(^PSDRUG($P(^PSRX(DA,0),"^",6),0)):$P(^(0),"^"),1:""),!,"Expired "_Y_" and cannot be Reinstated!",!
"RTN","PSOCAN2",8,0)
 .D PAUSE^VALM1
"RTN","PSOCAN2",9,0)
 I $D(^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA)) S PSCAN($P(^PSRX(DA,0),"^"))=DA_"^R",DODR=1 D AUTOD G ACT
"RTN","PSOCAN2",10,0)
 I $P(PSOPAR,"^",2),'$D(^XUSEC("PSORPH",DUZ)) D VERIFY D  D AREC^PSOCAN1 Q
"RTN","PSOCAN2",11,0)
 .S RX1=$P(^PSRX(DA,0),"^") S:'$D(PSCAN(RX1)) PSCAN(RX1)=DA_"^R" K RX1
"RTN","PSOCAN2",12,0)
ACT W ! F I=1:1:80 W "="
"RTN","PSOCAN2",13,0)
 D ^PSOBUILD S DRG=+$P(^PSRX(DA,0),"^",6),DRG=$S($D(^PSDRUG(DRG,0)):$P(^(0),"^"),1:""),HOLDRX=RX
"RTN","PSOCAN2",14,0)
 W !!,RX_"  "_DRG D DRGDRG S RX=HOLDRX K HOLDRX Q:$P(^PSRX(+PSCAN(RX),"STA"),"^")'=12!($G(PSORX("DFLG")))  S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2) D CAN^PSOCAN W !
"RTN","PSOCAN2",15,0)
 ;Takes action on reinstated Rx's
"RTN","PSOCAN2",16,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN2",17,0)
 S (LPRT,LREF)="" F LL=0:0 S LL=$O(^PSRX(DA,"L",LL)) Q:'LL  S LPRT=$P($G(^PSRX(DA,"L",LL,0)),"."),LREF=$P($G(^(0)),"^",2)
"RTN","PSOCAN2",18,0)
 I 'RFCNT S FDT=$S($P($G(^PSRX(DA,2)),"^",2)'="":$P($G(^PSRX(DA,2)),"^",2),1:$P($G(^PSRX(DA,2)),"^")) S RELDT=$P(^(2),"^",13),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",19,0)
 I RFCNT S FDT=$P($G(^PSRX(DA,1,RFCNT,0)),"^"),RELDT=$P(^(0),"^",18),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",20,0)
 S Y=FDT D DD^%DT S XFDT=Y I RELDT'="" S Y=RELDT D DD^%DT S XRELDT=Y
"RTN","PSOCAN2",21,0)
 I LPRT'="" S Y=LPRT D DD^%DT S XLPDT=Y
"RTN","PSOCAN2",22,0)
 ;If Rx was released, do nothing
"RTN","PSOCAN2",23,0)
 I RELDT'="" W !,RX_" Reinstated -- ",!?3,$S('RFCNT:"Filled",1:"Refilled # "_LREF)_": "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:""),?56,"Released: "_$G(XRELDT) H 3 Q
"RTN","PSOCAN2",24,0)
 ;If Rx not released, check fill/refill date for action
"RTN","PSOCAN2",25,0)
 I $G(PSXSYS) D REINS^PSOCMOPA I $G(XFLAG) K XFLAG Q
"RTN","PSOCAN2",26,0)
 I FDT<DT D
"RTN","PSOCAN2",27,0)
 .W !,RX_" REINSTATED -- ",!?3,$S('RFCNT:"Filled",1:"Refilled # "_LREF)_":  "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:""),?56,"Released:"
"RTN","PSOCAN2",28,0)
 .S DIR("A")="     ** Do you want to print the label now",DIR("B")="N",DIR(0)="Y",DIR("?")="Enter 'Y' to print the label now.  If 'N' is entered, the label may be reprinted through reprint at a later date."
"RTN","PSOCAN2",29,0)
 .D ^DIR K DIR Q:$G(DIRUT)!('Y)  S PPL=DA D Q^PSORXL Q
"RTN","PSOCAN2",30,0)
 I FDT=DT W !,RX_" Reinstated -- ",!?3,$S('RFCNT:"Filled",1:"Refilled # "_LREF)_": "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:"")
"RTN","PSOCAN2",31,0)
 I  W ?56,"Released:",!?5,"Either print the label using the reprint option ",!?7,"or check later to see if the label has been printed." Q
"RTN","PSOCAN2",32,0)
 I FDT>DT W !,RX_" reinstated -- ",!?3,$S('RFCNT:"Filled",1:"Refilled # "_LREF)_": "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:"")
"RTN","PSOCAN2",33,0)
 I  W ?56,"Released:" I '$G(DODR) W !?5,"Placing Rx on suspense.  Please wait..." D SUS
"RTN","PSOCAN2",34,0)
 K DODR
"RTN","PSOCAN2",35,0)
 Q
"RTN","PSOCAN2",36,0)
SUS ;Adds rec to suspense
"RTN","PSOCAN2",37,0)
 S ACT=1,RXN=DA,RX0=^PSRX(DA,0),RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK S DA=RXN
"RTN","PSOCAN2",38,0)
 S RXP=$S($D(RXP):RXP,1:0),DIC="^PS(52.5,",DIC(0)="L",X=RXN,DIC("DR")=".02///"_FDT_";.03///"_$P(RX0,"^",2)_";.04///M;.05///"_RXP_";.06////"_$G(PSOSITE)_";2///0" K DD,DO D FILE^DICN
"RTN","PSOCAN2",39,0)
 I +$G(Y),$G(RFCNT)'="" S $P(^PS(52.5,+Y,0),"^",13)=$G(RFCNT)
"RTN","PSOCAN2",40,0)
 S DA=RXN,$P(^PSRX(DA,"STA"),"^")=5,LFD=$E($P(^PSRX(DA,3),"^"),4,5)_"-"_$E($P(^(3),"^"),6,7)_"-"_$E($P(^(3),"^"),2,3)
"RTN","PSOCAN2",41,0)
 S ACOM="RX Placed on Suspense until "_LFD D AREC^PSOCAN1 S ST="SC",PHST="ZS" D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST
"RTN","PSOCAN2",42,0)
 Q
"RTN","PSOCAN2",43,0)
DRGDRG ;Checks for drug/drug interaction, duplicate drug and class
"RTN","PSOCAN2",44,0)
 Q:$P(^PSRX(DA,2),"^",6)<DT
"RTN","PSOCAN2",45,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSOCAN2",46,0)
 S STAT=$P(STA,"^",$P(^PSRX(DA,"STA"),"^")+1)
"RTN","PSOCAN2",47,0)
 S X=$P(^PSRX(DA,0),"^",6),DIC="^PSDRUG(",DIC(0)="MZO" D ^DIC K DIC Q:$D(DTOUT)!(Y<0)
"RTN","PSOCAN2",48,0)
 K HOLD S NAME=$P(Y(0),"^") I +$G(PSOSD(STAT,NAME))=+PSCAN(RX) S HOLD(STAT,NAME)=$G(PSOSD(STAT,NAME)) K PSOSD(STAT,NAME)
"RTN","PSOCAN2",49,0)
 S:$G(PSONEW("OLD VAL"))=+Y PSODRG("QFLG")=1
"RTN","PSOCAN2",50,0)
 K PSOY S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSOCAN2",51,0)
 S PSORENW("OIRXN")=DA D SET^PSODRG,POST^PSODRG S REA=$P(PSCAN($P(^PSRX(PSORENW("OIRXN"),0),"^")),"^",2)
"RTN","PSOCAN2",52,0)
 W ! S:$G(HOLD(STAT,NAME))]"" PSOSD(STAT,NAME)=$G(HOLD(STAT,NAME)) K HOLD,STA,STAT,PSORENW("OIRXN")
"RTN","PSOCAN2",53,0)
 Q
"RTN","PSOCAN2",54,0)
VERIFY ;Put in non-verify file
"RTN","PSOCAN2",55,0)
 S PSRXDA=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXDA,DIC(0)="ML",DIC("DR")="1////"_PSODFN_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN2",56,0)
 K DD,DO D FILE^DICN K DIC,DLAYGO,DINUM
"RTN","PSOCAN2",57,0)
 S DA=PSRXDA S $P(^PSRX(DA,"STA"),"^")=1
"RTN","PSOCAN2",58,0)
 S ST="SC",PHST="IP",VCOM="Put in non-verified status" D EN^PSOHLSN1(DA,ST,PHST,VCOM) K ST,PHST,VCOM
"RTN","PSOCAN2",59,0)
 Q
"RTN","PSOCAN2",60,0)
HLD N PSDTEST,PDA,CMOP,SUSD I $P(^PSRX(DA,"STA"),"^")=3 D
"RTN","PSOCAN2",61,0)
 .S ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while on hold during Rx cancel. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA) S ^PSRX(DA,"H")=""
"RTN","PSOCAN2",62,0)
 .I $P(^PSRX(DA,0),"^",13),'$O(^PSRX(DA,1,0)) S DIE=52,DR="22///"_$E($P(^PSRX(DA,0),"^",13),1,7) D ^DIE K DIE,DR Q
"RTN","PSOCAN2",63,0)
 .S (IFN,SUSD)=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  S SUSD=IFN,RFDT=$P(^PSRX(DA,1,IFN,0),"^")
"RTN","PSOCAN2",64,0)
 .Q:'$G(SUSD)  I '$P(^PSRX(DA,1,SUSD,0),"^",18) S PSDTEST=0 D  I 'PSDTEST K ^PSRX(DA,1,SUSD),^PSRX("AD",RFDT,DA,SUSD),^PSRX(DA,1,"B",RFDT,SUSD),IFN,SUSD,RFDT
"RTN","PSOCAN2",65,0)
 ..F PDA=0:0 S PDA=$O(^PSRX(DA,"L",PDA)) Q:'PDA  I $P($G(^PSRX(DA,"L",PDA,0)),"^",2)=SUSD S PSDTEST=1
"RTN","PSOCAN2",66,0)
 ..K CMOP D ^PSOCMOPA I $G(CMOP(CMOP("L")))="",$G(CMOP("S"))'="L" Q
"RTN","PSOCAN2",67,0)
 ..S PSDTEST=1
"RTN","PSOCAN2",68,0)
 Q
"RTN","PSOCAN2",69,0)
REF S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I $P($G(^PSRX(DA,1,IFN,0)),"^")=SUSD,'$P(^(0),"^",18) D
"RTN","PSOCAN2",70,0)
 .D DELREF I $G(PSORFDEL) K PSORFDEL Q
"RTN","PSOCAN2",71,0)
 .K PSORFDEL K ^PSRX(DA,1,IFN),^PSRX("AD",SUSD,DA,IFN),^PSRX(DA,1,"B",SUSD,IFN)
"RTN","PSOCAN2",72,0)
 .S $P(^PSRX(DA,1,0),"^",4)=$P(^PSRX(DA,1,0),"^",4)-1,DA(1)=DA
"RTN","PSOCAN2",73,0)
 .S NODE=0 D SPR^PSOUTL K DA(1),RF,NODE
"RTN","PSOCAN2",74,0)
 S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I '$O(^PSRX(DA,1,IFN)) S $P(^PSRX(DA,3),"^")=+$P(^PSRX(DA,1,IFN,0),"^"),$P(^(3),"^",2)=SUSD
"RTN","PSOCAN2",75,0)
 I '$O(^PSRX(DA,1,0)) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,2),"^",2),$P(^PSRX(DA,3),"^",2)=SUSD
"RTN","PSOCAN2",76,0)
 K IFN,SUSD
"RTN","PSOCAN2",77,0)
 Q
"RTN","PSOCAN2",78,0)
KILL K %,ACNT,ACOM,ACT,ALL,BCNUM,CMOP,CNT,DA,DAYS360,DEAD,DRG,DIRUT,DR,DRUG,DTOUT,DUOUT,FDT,HOLD,I,II,IN,IT,JJ,LC,LFD,LINE,LL,LPRT,LREF,LSI,NAME,NDF,NOEXP,NSF,OUT,RXSP,EN,WARN K:'$G(POERR) INCOM
"RTN","PSOCAN2",79,0)
 K PSODRUG,PCNT,POP,PPL,PS,PSFROM,PSINV,PLINE,PSI,PSINV,PSOCAN,PSOCMOP,PSODFN,PSODRG,PSOOPT,PSOSD,PSPOP,PSRXDA,PSS,PSVC,PSONOOR
"RTN","PSOCAN2",80,0)
 K REA,RELDT,RF,RFDATE,RFCNT,RFL,RFL1,RFLL,RP,RX,RX0,RXCNT,RXDA,RXN,RXNUM,RXP,RXREC,RXREF,RXS,SDATE,SPCANC,SS,STAT,SUB,X,XFDT,XLPDT,XRELDT,Y D KVA^VADPT Q
"RTN","PSOCAN2",81,0)
DELREF ;
"RTN","PSOCAN2",82,0)
 N RDL,PSCNODE
"RTN","PSOCAN2",83,0)
 S PSORFDEL=0
"RTN","PSOCAN2",84,0)
 F RDL=0:0 S RDL=$O(^PSRX(DA,4,RDL)) Q:'RDL  I $G(IFN)=$P($G(^PSRX(DA,4,RDL,0)),"^",3) S PSCNODE=$G(^(0))
"RTN","PSOCAN2",85,0)
 I $G(PSCNODE)="" Q
"RTN","PSOCAN2",86,0)
 I +$P(PSCNODE,"^",4)<3 S PSORFDEL=1
"RTN","PSOCAN2",87,0)
 Q
"RTN","PSOCAN2",88,0)
AUTOD ;reinstates Rxs dc'd by date of death
"RTN","PSOCAN2",89,0)
 I $G(^PSRX(DA,"DDSTA"))']"" K ^PSRX("APSOD",+$P(^PSRX(DA,0),"^",2),DA),DODR Q
"RTN","PSOCAN2",90,0)
 S DODS=$P(^PSRX(DA,"DDSTA"),"^"),DODD=$P(^("DDSTA"),"^",2,245)
"RTN","PSOCAN2",91,0)
 S FILE=$P(DODS,";"),STA=$P(DODS,";",2)
"RTN","PSOCAN2",92,0)
 I FILE=52.4 D  Q
"RTN","PSOCAN2",93,0)
 .S RXN=DA,^PS(52.4,DA,0)=DODD,DIK="^PS(52.4," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",94,0)
 .S ST="SC",PHST="IP",ACOM="Date of Death Deleted. Returned to Non-Verified status."
"RTN","PSOCAN2",95,0)
 .K ^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",96,0)
 .S DA=RXN D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,RXN
"RTN","PSOCAN2",97,0)
 I FILE=52.5 D  Q
"RTN","PSOCAN2",98,0)
 .;Adds rec to suspense
"RTN","PSOCAN2",99,0)
 .S RXN=DA,RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK
"RTN","PSOCAN2",100,0)
 .S DIC="^PS(52.5,",DIC(0)="L",X=RXN K DD,DO D FILE^DICN S DA=+Y
"RTN","PSOCAN2",101,0)
 .S ^PS(52.5,DA,0)=DODD,^PS(52.5,DA,"P")=0,LFD=$E($P(^PS(52.5,DA,0),"^",2),4,5)_"-"_$E($P(^(0),"^",2),6,7)_"-"_$E($P(^(0),"^",2),2,3)
"RTN","PSOCAN2",102,0)
 .S DIK="^PS(52.5," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",103,0)
 .S ACOM="Date of Death Deleted. RX Placed on Suspense until "_LFD
"RTN","PSOCAN2",104,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",105,0)
 .I STA=5 S ST="SC",PHST="ZS" D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,LFD
"RTN","PSOCAN2",106,0)
 I FILE=52 S ^PSRX(DA,"STA")=STA I STA=3!(STA=16) D  Q
"RTN","PSOCAN2",107,0)
 .S ^PSRX(DA,"H")=DODD,^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)=""
"RTN","PSOCAN2",108,0)
 .S ACOM="Date of Death Deleted. Medication Returned to"_$S(STA=16:" Provider",1:"")_" Hold Status "_$E(DT,4,5)_"/"_$E(DT,6,7)_"/"_$E(DT,2,3)_"."
"RTN","PSOCAN2",109,0)
 .D LOG,EN^PSOHLSN1(DA,"OH","",ACOM) K ACOM
"RTN","PSOCAN2",110,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",111,0)
 S ACOM="Date of Death Deleted. Prescription Reinstated." D EN^PSOHLSN1(DA,"SC","CM",ACOM),LOG K ACOM
"RTN","PSOCAN2",112,0)
 Q
"RTN","PSOCAN2",113,0)
LOG K ACNT F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",114,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=$G(RFCNT)+1 S:RF>5 RFCNT=$G(RFCNT)+1
"RTN","PSOCAN2",115,0)
 S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",116,0)
 D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_ACNT_"^"_ACNT S ^PSRX(DA,"A",ACNT,0)=%_"^R^"_DUZ_"^"_RFCNT_"^"_ACOM
"RTN","PSOCAN2",117,0)
 K ^PSRX("APSOD",PSODFN,DA),ACNT,RFCNT,RF,%
"RTN","PSOCAN2",118,0)
 S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,3),"^",5),$P(^(3),"^",2)=$P(^(3),"^",8)
"RTN","PSOCAN2",119,0)
 S $P(^PSRX(DA,3),"^",5)="",$P(^(3),"^",8)=""
"RTN","PSOCAN2",120,0)
 Q
"RTN","PSOCAN2",121,0)
NVER ;Called from PSOCAN3, needs DA defined
"RTN","PSOCAN2",122,0)
 N PSONVC,PSONVCP,PSONVCC
"RTN","PSOCAN2",123,0)
 S PSONVC="SC",PSONVCP="IP",PSONVCC="Put in non-verified status" D EN^PSOHLSN1(DA,PSONVC,PSONVCP,PSONVCC)
"RTN","PSOCAN2",124,0)
 Q
"RTN","PSOCAN3")
0^10^B73113946^B72944769
"RTN","PSOCAN3",1,0)
PSOCAN3 ;BIR/RTR/SAB - auto dc rxs due to death ;2/5/97
"RTN","PSOCAN3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,24,27,32,36,94,88,117,131,146,139,132,223,235**;DEC 1997
"RTN","PSOCAN3",3,0)
 ;#55-DBIA 2228
"RTN","PSOCAN3",4,0)
 ;PSSLOCK-2789
"RTN","PSOCAN3",5,0)
 Q
"RTN","PSOCAN3",6,0)
APSOD(PSODFN) ;called from file #2 date of death xref 'APOSD'
"RTN","PSOCAN3",7,0)
 N D,DA,DB,DC,DE,DG,DH,DI,DIC,DIE,DIG,DIH,DIK,DIR,DIQ,DIU,DIV,DIW,DK,DL,DM,DP,DQ,DU,DV,DW,DR
"RTN","PSOCAN3",8,0)
 S PSODEATH=1 D CAN K PSODEATH
"RTN","PSOCAN3",9,0)
 Q
"RTN","PSOCAN3",10,0)
CAN ;discontinued rxs due to death
"RTN","PSOCAN3",11,0)
 I $G(PSODFN),$D(^PS(52.91,PSODFN,0)) D
"RTN","PSOCAN3",12,0)
 .I '$P($G(^PS(52.91,PSODFN,0)),"^",3)!($P($G(^(0)),"^",3)>DT) S $P(^PS(52.91,PSODFN,0),"^",3)=DT,$P(^PS(52.91,PSODFN,0),"^",4)=5,^PS(52.91,"AX",DT,PSODFN)="" D SET^PSOTPCAN(PSODFN)
"RTN","PSOCAN3",13,0)
 F PSORXJ=0:0 S PSORXJ=$O(^PS(55,PSODFN,"P",PSORXJ)) Q:'PSORXJ  I $D(^(PSORXJ,0)) S PSORX=^(0) S STA=$S($P($G(^PSRX(PSORX,"STA")),"^")<11:1,$P($G(^("STA")),"^")=16:1,1:0) D:STA
"RTN","PSOCAN3",14,0)
 .I $D(^PSRX(PSORX,0)),$P($G(^PSRX(PSORX,"STA")),"^")="" D SETC
"RTN","PSOCAN3",15,0)
 .I $D(^PSRX(PSORX,0)),$P($G(^PSRX(PSORX,2)),"^",6)'<DT S PSO0=^(0),PSO2=$G(^(2)) D
"RTN","PSOCAN3",16,0)
 ..S ^PSRX(PSORX,"DDSTA")="52;"_$P(^PSRX(PSORX,"STA"),"^")
"RTN","PSOCAN3",17,0)
 ..;remove from hold
"RTN","PSOCAN3",18,0)
 ..I $G(^PSRX(PSORX,"H"))]"" D
"RTN","PSOCAN3",19,0)
 ...S ^PSRX(PSORX,"DDSTA")="52;"_$P(^PSRX(PSORX,"STA"),"^")_"^"_^PSRX(PSORX,"H")
"RTN","PSOCAN3",20,0)
 ...K:$P(^PSRX(PSORX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSORX,"H"),"^"),PSORX) S ^PSRX(PSORX,"H")=""
"RTN","PSOCAN3",21,0)
 ...I '$P($G(^PSRX(PSORX,2)),"^",2),$P($G(^(3)),"^") S $P(^PSRX(PSORX,2),"^",2)=$P(^(3),"^")
"RTN","PSOCAN3",22,0)
 ...I $G(PSODEATH),$P(^PSRX(PSORX,0),"^",2) S ^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",23,0)
 ..;delete from non-verified file
"RTN","PSOCAN3",24,0)
 ..I $G(^PS(52.4,PSORX,0))]"" S ^PSRX(PSORX,"DDSTA")="52.4;"_$P(^PSRX(PSORX,"STA"),"^")_"^"_^PS(52.4,PSORX,0),DIK="^PS(52.4,",DA=PSORX D ^DIK K DIK
"RTN","PSOCAN3",25,0)
 ..I $G(PSODEATH),$P(^PSRX(PSORX,0),"^",2) S ^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",26,0)
 ..;delete from suspense
"RTN","PSOCAN3",27,0)
 ..D:$O(^PS(52.5,"B",PSORX,0))
"RTN","PSOCAN3",28,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)) I '$G(^PS(52.5,DA,"P")),$G(PSODEATH) S ^PSRX(PSORX,"DDSTA")="52.5;5^"_^PS(52.5,DA,0),^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",29,0)
 ...I $O(^PSRX(PSORX,1,0)),'$G(PSODEATH) S DA=PSORX,SUSD=$P($G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),0)),"^",2) D:'$G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),"P")) REF^PSOCAN2
"RTN","PSOCAN3",30,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)),DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOCAN3",31,0)
 ..D SETC
"RTN","PSOCAN3",32,0)
 ..;activity record
"RTN","PSOCAN3",33,0)
 ..S (COM,ACOM)=$S($G(PSODEATH):"Date of Death Entered by MAS",1:"Discontinued by Pharmacy")_"."
"RTN","PSOCAN3",34,0)
 ..S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(PSORX,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOCAN3",35,0)
 ..S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(PSORX,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN3",36,0)
 ..D NOW^%DTC S ACNT=ACNT+1,^PSRX(PSORX,"A",0)="^52.3DA^"_ACNT_"^"_ACNT
"RTN","PSOCAN3",37,0)
 ..S ^PSRX(PSORX,"A",ACNT,0)=%_"^"_"C"_"^^"_RFCNT_"^"_"Auto Discontinued Due to Death. "_ACOM
"RTN","PSOCAN3",38,0)
 ..;check for label/release/pending release
"RTN","PSOCAN3",39,0)
 ..D FIL
"RTN","PSOCAN3",40,0)
 ..S STAT="OD",PHARMST="" D EN^PSOHLSN1(PSORX,STAT,PHARMST,COM,"A") K COMM,PHARMST,STAT
"RTN","PSOCAN3",41,0)
 ;dc pending orders
"RTN","PSOCAN3",42,0)
 F PDA=0:0 S PDA=$O(^PS(52.41,"P",PSODFN,PDA)) Q:'PDA  I $P(^PS(52.41,PDA,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") D
"RTN","PSOCAN3",43,0)
 .I $G(PSODEATH) D
"RTN","PSOCAN3",44,0)
 ..S ^PS(52.41,PDA,"DDSTA")=$P(^PS(52.41,PDA,0),"^",3)_";"_+$P($G(^PS(52.41,PDA,"INI")),"^"),^PS(52.41,"APSOD",PSODFN,PDA)=""
"RTN","PSOCAN3",45,0)
 ..S $P(^PS(52.41,PDA,4),"^")="Date of Death Entered by MAS."
"RTN","PSOCAN3",46,0)
 .S $P(^PS(52.41,PDA,0),"^",3)="DC"
"RTN","PSOCAN3",47,0)
 .K ^PS(52.41,"AOR",PSODFN,+$P($G(^PS(52.41,PDA,"INI")),"^"),PDA)
"RTN","PSOCAN3",48,0)
 .S COM=$S($G(PSODEATH):"Date of Death Entered by MAS.",1:""),PL=$P(^PS(52.41,PDA,0),"^"),$P(^(0),"^",3)="DC"
"RTN","PSOCAN3",49,0)
 .D EN^PSOHLSN(PL,"OC",COM,"A") K COM,PL
"RTN","PSOCAN3",50,0)
 ;dc non-va meds
"RTN","PSOCAN3",51,0)
 D APSOD^PSONVNEW
"RTN","PSOCAN3",52,0)
KILL K %,%H,%T,ACNT,DA,PDA,DIRUT,DTOUT,PSO,PSO0,PSO2,PSOD,PSOD0,PSODFN,PSODL,PSORX,PSORXJ,PSOSD,RF,RFCNT,SUB,TM,TSKDT,X,X1,X2,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","PSOCAN3",53,0)
 D KVAR^VADPT S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCAN3",54,0)
 Q
"RTN","PSOCAN3",55,0)
CAN1 Q:$G(DODR)
"RTN","PSOCAN3",56,0)
 S PSOMGDFN=$G(PSODFN) ; SAVE IN CASE CANCELING RX THAT WAS MERGED TO ANOTHER DFN
"RTN","PSOCAN3",57,0)
 I $G(^PSRX(DA,"H"))]"" D HLD^PSOCAN2
"RTN","PSOCAN3",58,0)
 S PSCANVAR=0,RXDA=DA,DA=$O(^PS(52.5,"B",DA,0)) I DA,'$G(^PS(52.5,DA,"P")) S PSCANVAR=1 D
"RTN","PSOCAN3",59,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOCAN3",60,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while suspended. "_$G(COM)
"RTN","PSOCAN3",61,0)
 .S DIK="^PS(52.5," D ^DIK K DIK S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2)
"RTN","PSOCAN3",62,0)
 .D AREC^PSOCAN1 S DA=RXDA I $O(^PSRX(DA,1,0)) D REF^PSOCAN2
"RTN","PSOCAN3",63,0)
 I $G(REA)="C" S DA=$O(^PS(52.5,"B",RXDA,0)) I DA S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOCAN3",64,0)
 I 'PSCANVAR S:$D(SPCANC) ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" during Rx cancel.  "
"RTN","PSOCAN3",65,0)
ADD S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) S:$G(PSOOPT)=3 REA="L"
"RTN","PSOCAN3",66,0)
 D:'$G(PSCANVAR) AREC^PSOCAN1 S:REA="L" REA="C" S:REA'="C" $P(^PSRX(DA,"STA"),"^")=0
"RTN","PSOCAN3",67,0)
 N PSOTPCNZ S PSOTPCNZ=0 I $P(^PSRX(DA,"STA"),"^")'=12 S PSOTPCNZ=1
"RTN","PSOCAN3",68,0)
 S:REA="C"&($P(^PSRX(DA,"STA"),"^")<12)!($P(^("STA"),"^")=16) $P(^PSRX(DA,"STA"),"^")=12 I $P($G(^PSRX(DA,"STA")),"^")=12,$G(PSOTPCNZ) D CAN^PSOTPCAN(DA)
"RTN","PSOCAN3",69,0)
 K PSOTPCNZ
"RTN","PSOCAN3",70,0)
 I REA="R" D
"RTN","PSOCAN3",71,0)
 .I $P(^PSRX(DA,3),"^",8) S $P(^PSRX(DA,3),"^",2)=$P(^PSRX(DA,3),"^",8),$P(^(3),"^",8)=""
"RTN","PSOCAN3",72,0)
 .I $P(^PSRX(DA,3),"^",5) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,3),"^",5),$P(^(3),"^",5)=""
"RTN","PSOCAN3",73,0)
 I REA="C" D
"RTN","PSOCAN3",74,0)
 .S:'$P(^PSRX(DA,3),"^",5) $P(^PSRX(DA,3),"^",5)=$S($P($G(^PSRX(DA,3)),"^"):$P(^(3),"^"),1:DT)
"RTN","PSOCAN3",75,0)
 .I $O(^PS(52.41,"ARF",DA,0)),'$O(^PS(52.41,"APSOD",PSODFN,0)) S HLDDA=DA,DA=$O(^PS(52.41,"ARF",DA,0)),DIK="^PS(52.41," D ^DIK S DA=HLDDA K HLDDA
"RTN","PSOCAN3",76,0)
 .;check for label/release/pending release
"RTN","PSOCAN3",77,0)
 .I $G(PSOOPT)'=3 D FILX
"RTN","PSOCAN3",78,0)
 S PSONOOR=$S($D(PSONOOR):PSONOOR,1:"D"),STAT=$S(REA="C":"OD",1:"SC"),PHARMST=$S(REA="C":"",1:"CM")
"RTN","PSOCAN3",79,0)
 S COM=$S(REA="C":$S($G(PSOOPT)=3&('$G(DUP)):"Renewed",1:"Discontinued")_" by Pharmacy",1:"Reinstated by Pharmacy")
"RTN","PSOCAN3",80,0)
 D EN^PSOHLSN1(DA,STAT,PHARMST,COM,$S($G(PSOOPT)=3&('$G(DUP)):"",1:PSONOOR)) K COM,STAT,PHARMST,PSCANVAR
"RTN","PSOCAN3",81,0)
 I REA="C" D
"RTN","PSOCAN3",82,0)
 .I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOCAN3",83,0)
 I $G(PSOMGDFN)'="" S PSODFN=PSOMGDFN K PSOMGDFN
"RTN","PSOCAN3",84,0)
 Q:(REA="C")!('$P($G(PSOPAR),"^",2))!($P(^PSRX(DA,2),"^",10)]"")
"RTN","PSOCAN3",85,0)
 Q:$D(^XUSEC("PSORPH",DUZ))  S PSVC=$P(^PSRX(DA,0),"^",16) F JJ=0:0 S JJ=$O(^PS(55,PSODFN,"P",JJ)) Q:'JJ  I $D(^(JJ,0)),+^(0)=DA Q
"RTN","PSOCAN3",86,0)
 Q:'JJ  S PSRXIN=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXIN,DIC(0)="ML"
"RTN","PSOCAN3",87,0)
 S DIC("DR")="1////"_$G(PSODFN)_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN3",88,0)
 K DD,DO D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM
"RTN","PSOCAN3",89,0)
 K DA,DIK S DA=PSRXIN K PSRXIN S $P(^PSRX(DA,"STA"),"^")=1 D NVER^PSOCAN2
"RTN","PSOCAN3",90,0)
 W !,"Rx # "_$P(^PSRX(DA,0),"^")_" is still non-verified!"
"RTN","PSOCAN3",91,0)
 Q
"RTN","PSOCAN3",92,0)
OERR I '$D(^XUSEC("PSORPH",DUZ)),'$P($G(PSOPAR),"^",2) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOCAN3",93,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOCAN3",94,0)
 K PSOPLCK S PSOCANRD=+$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^",4),PSOCANRA=1
"RTN","PSOCAN3",95,0)
 I $P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^"),$P(^("STA"),"^")=1!($P(^("STA"),"^")=4) S:$G(SPEED) PSONOORS=$G(PSONOOR) D DEL^PSOCAN4 S:$G(PSONOORS)'="" PSONOOR=$G(PSONOORS) K PSONOORS D KCAN D ULP Q
"RTN","PSOCAN3",96,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D KCAN D ULP Q
"RTN","PSOCAN3",97,0)
 I '+^PSRX($P(PSOLST(ORN),"^",2),"OR1"),$P(^("STA"),"^")=12 S VALMSG="Rx Cannot be Reinstated.  No Orderable Item." D KCAN D ULP D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN3",98,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12,$P($G(^("PKI")),"^") S VALMSG="Cannot be Reinstated - Digitally Signed" D KCAN D ULP D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN3",99,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12 S PSOCANRZ=1
"RTN","PSOCAN3",100,0)
 D HLDHDR^PSOLMUTL S X=$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),PS=$S($P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^")=12:"Reinstate: ",1:"Discontinue: ")
"RTN","PSOCAN3",101,0)
 S POERR=1,DFNHLD=PSODFN,DA=$P(PSOLST(ORN),"^",2)
"RTN","PSOCAN3",102,0)
 D LMNO D:$P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12 RMP
"RTN","PSOCAN3",103,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOCAN3",104,0)
 K POERR,PSCAN,PSI,PSL S PSODFN=DFNHLD K DFNHLD D ULP
"RTN","PSOCAN3",105,0)
 D KCAN
"RTN","PSOCAN3",106,0)
 Q
"RTN","PSOCAN3",107,0)
 Q
"RTN","PSOCAN3",108,0)
ULP D UL^PSSLOCK(+$G(PSODFN))
"RTN","PSOCAN3",109,0)
 Q
"RTN","PSOCAN3",110,0)
 ;
"RTN","PSOCAN3",111,0)
LMNO ; Calls LMNO^PSOCAN
"RTN","PSOCAN3",112,0)
 N PSODFN,PSORX,RXN,RX0
"RTN","PSOCAN3",113,0)
 S PSPOP=0,RXNUM=X S PSODFN=+$P(^PSRX(DA,0),"^",2) D LMNO^PSOCAN
"RTN","PSOCAN3",114,0)
 Q
"RTN","PSOCAN3",115,0)
 ;
"RTN","PSOCAN3",116,0)
KCAN ;
"RTN","PSOCAN3",117,0)
 K PSOCANRA,PSOCANRC,PSOCANRD,PSOCANRN,PSOCANRP,PSOCANRZ,PSOMSG
"RTN","PSOCAN3",118,0)
 Q
"RTN","PSOCAN3",119,0)
 ;
"RTN","PSOCAN3",120,0)
KCAN1 ;
"RTN","PSOCAN3",121,0)
 K PSOCANRC,PSOCANRD,PSOCANRN,PSOCANRP,PSOCANRZ
"RTN","PSOCAN3",122,0)
 Q
"RTN","PSOCAN3",123,0)
 ;
"RTN","PSOCAN3",124,0)
RMP ;remove Rx if found in array PSORX("PSOL") (Label Queue)
"RTN","PSOCAN3",125,0)
 Q:'$D(PSORX("PSOL"))  S:'$G(DA) DA=$P(PSOLST(ORN),"^",2)
"RTN","PSOCAN3",126,0)
 N I,J,FND,ST1,ST2,ST3 S I=0
"RTN","PSOCAN3",127,0)
 F  S I=$O(PSORX("PSOL",I)) Q:'I  D
"RTN","PSOCAN3",128,0)
 . S ST1=PSORX("PSOL",I) Q:ST1'[(DA_",")
"RTN","PSOCAN3",129,0)
 . S ST3="",FND=0
"RTN","PSOCAN3",130,0)
 . F J=1:1 S ST2=$P(ST1,",",J) Q:'ST2  D
"RTN","PSOCAN3",131,0)
 . . I ST2=DA S FND=1 Q
"RTN","PSOCAN3",132,0)
 . . S ST3=ST3_$S('ST3:"",1:",")_ST2
"RTN","PSOCAN3",133,0)
 . I FND D
"RTN","PSOCAN3",134,0)
 . . S:ST3]"" PSORX("PSOL",I)=ST3_","
"RTN","PSOCAN3",135,0)
 . . K:ST3="" PSORX("PSOL",I)
"RTN","PSOCAN3",136,0)
 . . D:$D(BBRX(I)) RMB(I)
"RTN","PSOCAN3",137,0)
 Q
"RTN","PSOCAN3",138,0)
 ;
"RTN","PSOCAN3",139,0)
RMB(IDX) ;remove Rx if found in array BBRX() (Bingo Board)
"RTN","PSOCAN3",140,0)
 N ST4,ST5,ST6,K
"RTN","PSOCAN3",141,0)
 S ST4=BBRX(IDX) Q:ST4'[(DA_",")
"RTN","PSOCAN3",142,0)
 S ST6=""
"RTN","PSOCAN3",143,0)
 F K=1:1 S ST5=$P(ST4,",",K) Q:'ST5  D
"RTN","PSOCAN3",144,0)
 . S:ST5'=DA ST6=ST6_$S('ST6:"",1:",")_ST5
"RTN","PSOCAN3",145,0)
 . S:ST6]"" BBRX(IDX)=ST6_"," K:ST6="" BBRX(IDX)
"RTN","PSOCAN3",146,0)
 I '$D(BBRX) K BINGCRT
"RTN","PSOCAN3",147,0)
 Q
"RTN","PSOCAN3",148,0)
 ;
"RTN","PSOCAN3",149,0)
FIL Q:'$G(PSORX)
"RTN","PSOCAN3",150,0)
 S PSOFC=PSORX G FILC
"RTN","PSOCAN3",151,0)
FILX Q:'$G(DA)
"RTN","PSOCAN3",152,0)
 S PSOFC=DA
"RTN","PSOCAN3",153,0)
FILC ;
"RTN","PSOCAN3",154,0)
 N PFC,PSOFFLAG
"RTN","PSOCAN3",155,0)
 I $P($G(^PSRX(PSOFC,2)),"^",13) G FILQ
"RTN","PSOCAN3",156,0)
 S PSOFFLAG=0 F PFC=0:0 S PFC=$O(^PSRX(PSOFC,1,PFC)) Q:'PFC!(PSOFFLAG)  I $P($G(^PSRX(PSOFC,1,PFC,0)),"^",18) S PSOFFLAG=1
"RTN","PSOCAN3",157,0)
 I PSOFFLAG G FILQ
"RTN","PSOCAN3",158,0)
 F PFC=0:0 S PFC=$O(^PSRX(PSOFC,"L",PFC)) Q:'PFC!(PSOFFLAG)  I $D(^PSRX(PSOFC,"L",PFC,0)),'$P($G(^(0)),"^",5) S PSOFFLAG=1
"RTN","PSOCAN3",159,0)
 I PSOFFLAG G FILQ
"RTN","PSOCAN3",160,0)
 S PSOFCSUS=$O(^PS(52.5,"B",PSOFC,0))
"RTN","PSOCAN3",161,0)
 I $G(PSOFCSUS),$P($G(^PS(52.5,PSOFCSUS,0)),"^",7)="L"!($P($G(^(0)),"^",7)="X") G FILQ
"RTN","PSOCAN3",162,0)
 S $P(^PSRX(PSOFC,3),"^",8)=$P($G(^PSRX(PSOFC,3)),"^",2)
"RTN","PSOCAN3",163,0)
 S $P(^PSRX(PSOFC,3),"^",2)=$P($G(^PSRX(PSOFC,2)),"^",2)
"RTN","PSOCAN3",164,0)
 I $P($G(^PSRX(PSOFC,"OR1")),"^",3) S $P(^PSRX(PSOFC,3),"^")=$P($G(^PSRX($P(^PSRX(PSOFC,"OR1"),"^",3),3)),"^")
"RTN","PSOCAN3",165,0)
FILQ K PSOFC,PSOFCSUS
"RTN","PSOCAN3",166,0)
 Q
"RTN","PSOCAN3",167,0)
 ;
"RTN","PSOCAN3",168,0)
SETC ;Called from Date of Death
"RTN","PSOCAN3",169,0)
 S $P(^PSRX(PSORX,"STA"),"^")=12,$P(^PSRX(PSORX,3),"^",5)=$S($P($G(^PSRX(PSORX,3)),"^"):$P(^(3),"^"),1:DT) D CAN^PSOTPCAN(PSORX)
"RTN","PSOCAN3",170,0)
 Q
"RTN","PSOHLNE1")
0^11^B72765875^B71499142
"RTN","PSOHLNE1",1,0)
PSOHLNE1 ;BIR/RTR-Parsing out segments from OERR ;01/20/95
"RTN","PSOHLNE1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,9,46,71,98,111,117,131,157,181,143,235**;DEC 1997
"RTN","PSOHLNE1",3,0)
 ;External reference to EN^ORERR supported by DBIA 2187
"RTN","PSOHLNE1",4,0)
 ;External reference to PS(50.607 supported by DBIA 2221
"RTN","PSOHLNE1",5,0)
 ;External reference to OR(100 supported by DBIA 2219
"RTN","PSOHLNE1",6,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOHLNE1",7,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSOHLNE1",8,0)
 ;
"RTN","PSOHLNE1",9,0)
EN ;ORC segment
"RTN","PSOHLNE1",10,0)
 N Q1,Q2,Q3,Q4,Q5,Q6,Q7,PSOPOSSD
"RTN","PSOHLNE1",11,0)
 K PSOLQ1I,PSOLQ1II,PSOLQ1IX
"RTN","PSOHLNE1",12,0)
 I '$O(MSG(ZZ,0)) D
"RTN","PSOHLNE1",13,0)
 .S PSOOC="NW",PLACER=+$P(PSOSEG,"|",2),PLACERXX=+$P($P(PSOSEG,"|",2),";",2),ENTERED=$P(PSOSEG,"|",10),PROV=$P(PSOSEG,"|",12)
"RTN","PSOHLNE1",14,0)
 .S X=$P(PSOSEG,"|",15) S EFFECT=$$HL7TFM^XLFDT(X) K X
"RTN","PSOHLNE1",15,0)
 .D NOW^%DTC S PSOLOG=% K %
"RTN","PSOHLNE1",16,0)
 .;S RSN=$P(PSOSEG,"|",16)
"RTN","PSOHLNE1",17,0)
 .S ORCSEG=$P(PSOSEG,"|",7),QCOUNT=1 Q:$G(ORCSEG)'["~"
"RTN","PSOHLNE1",18,0)
 .F JJ=1:1:$L(ORCSEG) S:$E(ORCSEG,JJ)="~" QCOUNT=QCOUNT+1
"RTN","PSOHLNE1",19,0)
 I '$O(MSG(ZZ,0)) D  Q
"RTN","PSOHLNE1",20,0)
 .F JJJ=1:1:QCOUNT S QQQ=$P(ORCSEG,"~",JJJ) D:QQQ'=""
"RTN","PSOHLNE1",21,0)
 ..S PSOPOSSD=$S($P($P(QQQ,"^"),"&"):1,1:0) ;PSOPOSSD=1 if possible dose
"RTN","PSOHLNE1",22,0)
 ..S Q1I(JJJ)=$S(PSOPOSSD:$P(QQQ,"^"),1:$P(QQQ,"^",8)),PSOLQ1IX(JJJ)=$P($P(QQQ,"^"),"&",5) S PSOLQ1I(JJJ)=$P(QQQ,"^",8),PSOLQ1II(JJJ)=PSOPOSSD ;ORC piece 1 if Possible Dosage, ORC piece 8 if Local Possible Dosage
"RTN","PSOHLNE1",23,0)
 ..S Q1(JJJ)=$P(QQQ,"^",2) ;schedule
"RTN","PSOHLNE1",24,0)
 ..S Q2(JJJ)=$P(QQQ,"^",3) ;duration
"RTN","PSOHLNE1",25,0)
 ..S Q3(JJJ)=$P(QQQ,"^",4) I Q3(JJJ) S X=Q3(JJJ) S Q3(JJJ)=$$HL7TFM^XLFDT(X) K X ;start date
"RTN","PSOHLNE1",26,0)
 ..S Q4(JJJ)=$P(QQQ,"^",5) ;end date
"RTN","PSOHLNE1",27,0)
 ..S:$G(PRIOR)="" PRIOR=$P(QQQ,"^",6)
"RTN","PSOHLNE1",28,0)
 ..S Q6(JJJ)=$P(QQQ,"^",9) ;conjunction
"RTN","PSOHLNE1",29,0)
 ..S Q7(JJJ)=$P(QQQ,"^",10) ;sequencing
"RTN","PSOHLNE1",30,0)
 ..S QTARRAY(JJJ)=Q1(JJJ)_"^"_Q2(JJJ)_"^"_Q3(JJJ)_"^"_Q4(JJJ)_"^^"_Q6(JJJ)_"^"_Q7(JJJ)
"RTN","PSOHLNE1",31,0)
 ..S QTARRAY2(JJJ)=$S(PSOPOSSD:$P(Q1I(JJJ),"&"),1:Q1I(JJJ))_"^"_$S(PSOPOSSD:$P(Q1I(JJJ),"&",3),1:"")
"RTN","PSOHLNE1",32,0)
 ..I PSOPOSSD S $P(QTARRAY(JJJ),"^",5)=$P(Q1I(JJJ),"&",4)
"RTN","PSOHLNE1",33,0)
 ..I PSOPOSSD S PSOUNN=$P(Q1I(JJJ),"&",2) I PSOUNN'="" S PSOUNN=$O(^PS(50.607,"B",PSOUNN,0)) S $P(QTARRAY(JJJ),"^",9)=$G(PSOUNN)
"RTN","PSOHLNE1",34,0)
 ..K PSOUNN
"RTN","PSOHLNE1",35,0)
 ;For multiple ORC subscripts
"RTN","PSOHLNE1",36,0)
 S (POVAR,POVAR1)="",(NNCK,NNN,NNNN)=0,PSOIII=1,MSG(ZZ,0)=$E(MSG(ZZ),5,$L(MSG(ZZ)))
"RTN","PSOHLNE1",37,0)
 S AAA="" F  S AAA=$O(MSG(ZZ,AAA)) Q:AAA=""  S NNN=0 F OOO=1:1:$L(MSG(ZZ,AAA)) S NNN=NNN+1 D  D:$G(POVAR1)="~"&(NNNN=6) PARSE D:$G(POVAR1)="|" PARSE
"RTN","PSOHLNE1",38,0)
 .I $E(MSG(ZZ,AAA),OOO)="|" S NNNN=NNNN+1
"RTN","PSOHLNE1",39,0)
 .S POVAR1=$E(MSG(ZZ,AAA),OOO)
"RTN","PSOHLNE1",40,0)
 .S POLIM=POVAR
"RTN","PSOHLNE1",41,0)
 .S POVAR=$S(POVAR="":POVAR1,1:POVAR_POVAR1)
"RTN","PSOHLNE1",42,0)
 .;I NNNN=6 I $G(POVAR1)="~"!($G(POVAR1)="|")
"RTN","PSOHLNE1",43,0)
END ;16 OF ORC?
"RTN","PSOHLNE1",44,0)
 ;I $G(POVAR)'="" I NNNN=14!(NNNN=15) S EFFECT=$G(POVAR)
"RTN","PSOHLNE1",45,0)
 S QCOUNT=0 F JJJ=0:0 S JJJ=$O(QTVAR(JJJ)) Q:'JJJ  I $L($G(QTVAR(JJJ))) S QCOUNT=QCOUNT+1 D
"RTN","PSOHLNE1",46,0)
 .S PSOPOSSD=$S($P($P(QTVAR(JJJ),"^"),"&"):1,1:0) ;PSOPOSSD =1 if possible dose
"RTN","PSOHLNE1",47,0)
 .S Q1I(JJJ)=$S(PSOPOSSD:$P(QTVAR(JJJ),"^"),1:$P(QTVAR(JJJ),"^",8)),PSOLQ1IX(JJJ)=$P($P(QTVAR(JJJ),"^"),"&",5) S PSOLQ1I(JJJ)=$P(QTVAR(JJJ),"^",8),PSOLQ1II(JJJ)=PSOPOSSD ;piece 1 if possible dose, piece 8 if not
"RTN","PSOHLNE1",48,0)
 .S Q1(JJJ)=$P(QTVAR(JJJ),"^",2)
"RTN","PSOHLNE1",49,0)
 .S Q2(JJJ)=$P(QTVAR(JJJ),"^",3)
"RTN","PSOHLNE1",50,0)
 .;S Q2(JJJ)=$S($E($P(QTVAR(JJJ),"^",3)):"D"_$P(QTVAR(JJJ),"^",3),$E($P(QTVAR(JJJ),"^",3))=0:"D"_$P(QTVAR(JJJ),"^",3),1:$P(QTVAR(JJJ),"^",3))
"RTN","PSOHLNE1",51,0)
 .S Q3(JJJ)=$P(QTVAR(JJJ),"^",4) I Q3(JJJ) S X=Q3(JJJ) S Q3(JJJ)=$$HL7TFM^XLFDT(X) K X
"RTN","PSOHLNE1",52,0)
 .S Q4(JJJ)=$P(QTVAR(JJJ),"^",5)
"RTN","PSOHLNE1",53,0)
 .S:$G(PRIOR)="" PRIOR=$P(QTVAR(JJJ),"^",6)
"RTN","PSOHLNE1",54,0)
 .S Q6(JJJ)=$P(QTVAR(JJJ),"^",9)
"RTN","PSOHLNE1",55,0)
 .S Q7(JJJ)=$P(QTVAR(JJJ),"^",10)
"RTN","PSOHLNE1",56,0)
 .S QTARRAY(JJJ)=Q1(JJJ)_"^"_Q2(JJJ)_"^"_Q3(JJJ)_"^"_Q4(JJJ)_"^^"_Q6(JJJ)_"^"_Q7(JJJ)
"RTN","PSOHLNE1",57,0)
 .S QTARRAY2(JJJ)=$S(PSOPOSSD:$P(Q1I(JJJ),"&"),1:Q1I(JJJ))_"^"_$S(PSOPOSSD:$P(Q1I(JJJ),"&",3),1:"")
"RTN","PSOHLNE1",58,0)
 .I PSOPOSSD S $P(QTARRAY(JJJ),"^",5)=$P(Q1I(JJJ),"&",4)
"RTN","PSOHLNE1",59,0)
 .I PSOPOSSD S PSOUNN=$P(Q1I(JJJ),"&",2) I PSOUNN'="" S PSOUNN=$O(^PS(50.607,"B",PSOUNN,0)) S $P(QTARRAY(JJJ),"^",9)=$G(PSOUNN)
"RTN","PSOHLNE1",60,0)
 .K PSOUNN
"RTN","PSOHLNE1",61,0)
 I $G(EFFECT) S X=EFFECT S EFFECT=$$HL7TFM^XLFDT(X) K X
"RTN","PSOHLNE1",62,0)
 D NOW^%DTC S PSOLOG=% S:'$G(EFFECT) EFFECT=% K %
"RTN","PSOHLNE1",63,0)
 K MSG(ZZ,0)
"RTN","PSOHLNE1",64,0)
 Q
"RTN","PSOHLNE1",65,0)
PARSE I NNNN=1 S PSOOC="NW" G SET
"RTN","PSOHLNE1",66,0)
 I NNNN=2 S PLACER=+$G(POLIM),PLACERXX=+$P($G(POLIM),";",2) G SET
"RTN","PSOHLNE1",67,0)
 I NNNN=3!(NNNN=4)!(NNNN=5) G SET
"RTN","PSOHLNE1",68,0)
 I NNNN=6,$G(POVAR1)="~" S NNCK=NNCK+1,QTVAR(NNCK)=$G(POLIM) G SET
"RTN","PSOHLNE1",69,0)
 I NNNN=7 S NNCK=NNCK+1 S QTVAR(NNCK)=$G(POLIM) G SET
"RTN","PSOHLNE1",70,0)
 I NNNN=8!(NNNN=9) G SET
"RTN","PSOHLNE1",71,0)
 I NNNN=10 S ENTERED=$G(POLIM) G SET
"RTN","PSOHLNE1",72,0)
 I NNNN=11 G SET
"RTN","PSOHLNE1",73,0)
 I NNNN=12 S PROV=$G(POLIM) G SET
"RTN","PSOHLNE1",74,0)
 I NNNN=13!(NNNN=14) G SET
"RTN","PSOHLNE1",75,0)
 I NNNN=15 S EFFECT=$G(POLIM)
"RTN","PSOHLNE1",76,0)
SET S (POVAR,POLIM)="" Q
"RTN","PSOHLNE1",77,0)
 ;
"RTN","PSOHLNE1",78,0)
EXP ;
"RTN","PSOHLNE1",79,0)
 ;Q:'$G(OR("PLACE"))
"RTN","PSOHLNE1",80,0)
 Q:'$G(PSOFILNM)
"RTN","PSOHLNE1",81,0)
 S PSOMSORR=1
"RTN","PSOHLNE1",82,0)
 N PSOSSMES S PSOSSMES="CPRSUP"
"RTN","PSOHLNE1",83,0)
 I $G(PSOFILNM),$G(PSOFILNM)["S" S LL=+$G(PSOFILNM) I $D(^PS(52.41,LL,0)),$P($G(^(0)),"^",3)'="RF" G EXPEN
"RTN","PSOHLNE1",84,0)
 S LL=$G(PSOFILNM) I 'LL!('$D(^PSRX(+$G(LL),0))) S COMM="Order was not located by Pharmacy" D EN^ORERR(COMM,.MSG) D  G EXPQ
"RTN","PSOHLNE1",85,0)
 .F EER=0:0 S EER=$O(MSG(EER)) Q:'EER  S:$P(MSG(EER),"|")="PV1" PSERRPV1=MSG(EER) S:$P(MSG(EER),"|")="PID" PSERRPID=MSG(EER) S:$P(MSG(EER),"|")="ORC"&($G(PSERRORC)="") PSERRORC=MSG(EER)
"RTN","PSOHLNE1",86,0)
 .N MSG,PSOHINST D INIT^PSOHLSN S MSG(2)=$G(PSERRPID),MSG(3)=$G(PSERRPV1),MSG(4)="ORC|DE|"_$G(OR("PLACE"))_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"_"|"_$S($P($G(PSERRORC),"|",4)'="":$P(PSERRORC,"|",4),1:"") S:$G(COMM)'="" MSG(5)="NTE|16||"_COMM
"RTN","PSOHLNE1",87,0)
 .D SEND^PSOHLSN
"RTN","PSOHLNE1",88,0)
 Q:'$D(^PSRX(LL,0))
"RTN","PSOHLNE1",89,0)
 I +$P($G(^PSRX(LL,2)),"^",6)<DT D
"RTN","PSOHLNE1",90,0)
 .;Reset PSOSSMES if status changes, so HDR gets updated in PSOHLSN1
"RTN","PSOHLNE1",91,0)
 .I +$P($G(^PSRX(LL,"STA")),"^")<12!($P($G(^("STA")),"^")=16) S $P(^PSRX(LL,"STA"),"^")=11 D ECAN^PSOUTL(LL) S PSOSSMES="CPRSVDEF"
"RTN","PSOHLNE1",92,0)
 S GG=+$P($G(^PSRX(LL,"STA")),"^")
"RTN","PSOHLNE1",93,0)
 ;S AA=$S(GG=3:"OH",GG=12:"OD",GG=13:"OC",GG=14:"OD",GG=15:"OD",GG=16:"OH",1:"SC"),AAA=$S(GG=0:"CM",GG=1:"IP",GG=4:"IP",GG=5:"ZS",GG=11:"ZE",1:"")
"RTN","PSOHLNE1",94,0)
 S AA="SC",AAA=$S(GG=0:"CM",GG=2:"CM",GG=1:"IP",GG=4:"IP",GG=5:"ZS",GG=3:"HD",GG=16:"HD",GG=11:"ZE",1:"DC")
"RTN","PSOHLNE1",95,0)
 D EN^PSOHLSN1(LL,AA,AAA,"")
"RTN","PSOHLNE1",96,0)
 K PSOSSMES
"RTN","PSOHLNE1",97,0)
EXPQ K LL,GG,AA,AAA,PSOMSORR Q
"RTN","PSOHLNE1",98,0)
EXPEN ;SS on Pending orders
"RTN","PSOHLNE1",99,0)
 S AA=$P($G(^PS(52.41,LL,0)),"^",3)
"RTN","PSOHLNE1",100,0)
 S AAA=$S(AA="DC"!(AA="DE"):"DC",AA="HD":"HD",1:"IP")
"RTN","PSOHLNE1",101,0)
 D EN^PSOHLSN(OR("PLACE"),"SC",AAA)
"RTN","PSOHLNE1",102,0)
 G EXPQ
"RTN","PSOHLNE1",103,0)
 ;
"RTN","PSOHLNE1",104,0)
OID ;Check for 1 to 1 match from Dispense Drug to Orderable Item
"RTN","PSOHLNE1",105,0)
 N PSOCDD,PSOCDDI,PSOCDDIZ
"RTN","PSOHLNE1",106,0)
 Q:'$G(PSORDITE)
"RTN","PSOHLNE1",107,0)
 K PSOCDDIZ
"RTN","PSOHLNE1",108,0)
 S (PSOCDD,PSOCDDI)=0
"RTN","PSOHLNE1",109,0)
 F  S PSOCDD=$O(^PSDRUG("ASP",PSORDITE,PSOCDD)) Q:'PSOCDD  I $S('$P($G(^PSDRUG(PSOCDD,"I")),"^"):1,DT'>$P($G(^("I")),"^"):1,1:0),$P($G(^PSDRUG(PSOCDD,2)),"^",3)["O" S PSOCDDI=PSOCDDI+1,PSOCDDIZ=PSOCDD
"RTN","PSOHLNE1",110,0)
 I PSOCDDI'=1 Q
"RTN","PSOHLNE1",111,0)
 S PSOQWX=$G(PSOCDDIZ)
"RTN","PSOHLNE1",112,0)
 Q
"RTN","PSOHLNE1",113,0)
CP ;ZSC segment (replaced by ZCL segment)
"RTN","PSOHLNE1",114,0)
 S SERV=$S($P(PSOSEG,"|")=1:"SC",$P(PSOSEG,"|")=0:"NSC",1:$P(PSOSEG,"|"))
"RTN","PSOHLNE1",115,0)
 S PSOIBY=$P(PSOSEG,"|",2)_"^"_$P(PSOSEG,"|",3)_"^"_$P(PSOSEG,"|",4)_"^"_$P(PSOSEG,"|",5)_"^"_$P(PSOSEG,"|",6)_"^"_$P(PSOSEG,"|",7)
"RTN","PSOHLNE1",116,0)
 Q
"RTN","PSOHLNE1",117,0)
 ;
"RTN","PSOHLNE1",118,0)
ZCL ;ZCL segment - SC/EI related to ICDs
"RTN","PSOHLNE1",119,0)
 N SEQ,SEQ2,SEQ3 S SEQ3=$P(PSOSEG,"|",2),SEQ2=$P(PSOSEG,"|",1)
"RTN","PSOHLNE1",120,0)
 S:'$D(PSOICD(SEQ2)) PSOICD(SEQ2)=""
"RTN","PSOHLNE1",121,0)
 S $P(PSOICD(SEQ2),"^",(SEQ3+1))=$P(PSOSEG,"|",3)
"RTN","PSOHLNE1",122,0)
 D ELIG^VADPT S PSOSCP="",PSOSCP=$P(VAEL(3),U,2) K VAEL
"RTN","PSOHLNE1",123,0)
 S:'$D(PSOIBY) PSOIBY=""
"RTN","PSOHLNE1",124,0)
 I PSOSCP<50 D  ;set IBQ node variables if <50% SC
"RTN","PSOHLNE1",125,0)
 . Q:$P(PSOIBY,U,$S(SEQ3=1:2,SEQ3=2:3,SEQ3=4:4,SEQ3=5:1,SEQ3=6:5,SEQ3=7:6,1:""))>0
"RTN","PSOHLNE1",126,0)
 . S:SEQ3=1 $P(PSOIBY,U,2)=$P(PSOSEG,"|",3) ;AO
"RTN","PSOHLNE1",127,0)
 . S:SEQ3=2 $P(PSOIBY,U,3)=$P(PSOSEG,"|",3) ;IR
"RTN","PSOHLNE1",128,0)
 . S:SEQ3=3 SERV=$S($P(PSOSEG,"|",3)=1:"SC",$P(PSOSEG,"|",3)=0:"NSC",1:$P(PSOSEG,"|",3))           ;SC
"RTN","PSOHLNE1",129,0)
 . S:SEQ3=4 $P(PSOIBY,U,4)=$P(PSOSEG,"|",3) ;EC
"RTN","PSOHLNE1",130,0)
 . S:SEQ3=5 $P(PSOIBY,U,1)=$P(PSOSEG,"|",3) ;MST
"RTN","PSOHLNE1",131,0)
 . S:SEQ3=6 $P(PSOIBY,U,5)=$P(PSOSEG,"|",3) ;HNC
"RTN","PSOHLNE1",132,0)
 . S:SEQ3=7 $P(PSOIBY,U,6)=$P(PSOSEG,"|",3) ;CV
"RTN","PSOHLNE1",133,0)
 E  D
"RTN","PSOHLNE1",134,0)
 . S PSOIBY="^^^^^^",SERV=""
"RTN","PSOHLNE1",135,0)
 Q
"RTN","PSOHLNE1",136,0)
MISX ;Mismatch patient on CPRS New Order
"RTN","PSOHLNE1",137,0)
 S RCOMM="Patient mismatch on New Order from CPRS." D EN^ORERR(RCOMM,.MSG) S NWFLAG=1 D RERROR^PSOHLSN D KL^PSOHLSIH
"RTN","PSOHLNE1",138,0)
 Q
"RTN","PSOHLNE1",139,0)
MISRN ;Mismatch on CPRS renewal
"RTN","PSOHLNE1",140,0)
 N PSOCINV
"RTN","PSOHLNE1",141,0)
 I $G(PDFN)'=$P($G(^PSRX(+$G(PREV),0)),"^",2) D  S PSOMO=1 Q
"RTN","PSOHLNE1",142,0)
 .S RCOMM="Patient mismatch on CPRS Renewal." D EN^ORERR(RCOMM,.MSG) S PSOXRP=1 D RERROR^PSOHLSN D KL^PSOHLSIH
"RTN","PSOHLNE1",143,0)
 S PSOCINV=+$P($G(^OR(100,+$G(PLACER),3)),"^",5)
"RTN","PSOHLNE1",144,0)
 I PSOCINV'=$P($G(^PSRX(+$G(PREV),"OR1")),"^",2) D  S PSOMO=1 Q
"RTN","PSOHLNE1",145,0)
 .S RCOMM="Order mismatch on CPRS Renewal." D EN^ORERR(RCOMM,.MSG) S PSOCVI=1 D RERROR^PSOHLSN D KL^PSOHLSIH
"RTN","PSOHLNE1",146,0)
 Q
"RTN","PSOHLNE1",147,0)
ZRX ;Process ZRX segment
"RTN","PSOHLNE1",148,0)
 I $P(PSOSEG,"|",3)="R" S PSOOC="RNW",PSRNFLAG=1
"RTN","PSOHLNE1",149,0)
 S PREV=$S(+$P(PSOSEG,"|"):+$P(PSOSEG,"|"),1:"")
"RTN","PSOHLNE1",150,0)
 I $P(PSOSEG,"|")["P"!($P(PSOSEG,"|")["S") S PFLAG=1
"RTN","PSOHLNE1",151,0)
 S NATURE=$P(PSOSEG,"|",2)
"RTN","PSOHLNE1",152,0)
 S PSORSO=$P(PSOSEG,"|",3)
"RTN","PSOHLNE1",153,0)
 S ROUTING=$P(PSOSEG,"|",4)
"RTN","PSOHLNE1",154,0)
 I ROUTING="" S ROUTING="M"
"RTN","PSOHLNE1",155,0)
 I $P(PSOSEG,"|",7) S DSIG=1
"RTN","PSOHLNE1",156,0)
 Q
"RTN","PSOHLNE1",157,0)
CHCS ;Replace CHCS number with CPRS number in .01 field
"RTN","PSOHLNE1",158,0)
 N PSOHTMP
"RTN","PSOHLNE1",159,0)
 I $G(PDFN),PDFN'=+$P($G(^PS(52.41,+$G(PSOCHFFL),0)),"^",2) S COMM="Patient does not match" D EN^ORERR(COMM,.MSG) K PSOPLC,PSOFFL,PSOSND Q
"RTN","PSOHLNE1",160,0)
 I '$D(^PS(52.41,+$G(PSOCHFFL),0)) S COMM="Order was not located by Pharmacy" D EN^ORERR(COMM,.MSG) K PSOPLC,PSOFFL,PSOSND Q
"RTN","PSOHLNE1",161,0)
 S PSOHTMP=$P($G(^PS(52.41,+$G(PSOCHFFL),0)),"^")
"RTN","PSOHLNE1",162,0)
 I PSOHTMP'="" K ^PS(52.41,"B",PSOHTMP,+$G(PSOCHFFL))
"RTN","PSOHLNE1",163,0)
 S $P(^PS(52.41,+$G(PSOCHFFL),0),"^")=PSOPLC,^PS(52.41,"B",PSOPLC,+$G(PSOCHFFL))=""
"RTN","PSOHLNE1",164,0)
 S $P(^PS(52.41,+$G(PSOCHFFL),"EXT"),"^",2)=1
"RTN","PSOHLNE1",165,0)
 Q
"RTN","PSOHLNE1",166,0)
CNT ;
"RTN","PSOHLNE1",167,0)
 S TAC=0 F TACA=0:0 S TACA=$O(^PSRX(PREV,"A",TACA)) Q:'TACA  S TAC=TACA
"RTN","PSOHLNE1",168,0)
 S PAC=0 F PACA=0:0 S PACA=$O(^PSRX(PREV,1,PACA)) Q:'PACA  S PAC=PACA
"RTN","PSOHLNE1",169,0)
 D NOW^%DTC S TAC=TAC+1,^PSRX(PREV,"A",0)="^52.3DA^"_TAC_"^"_TAC,^PSRX(PREV,"A",TAC,0)=%_"^"_"C"_"^"_$S(+$G(PROV):$G(PROV),1:+$G(ENTERED))_"^"_PAC_"^"_"Discontinued due to CPRS edit"
"RTN","PSOHLNE1",170,0)
 K TAC,PAC,TACA,PACA
"RTN","PSOHLNE1",171,0)
 Q
"RTN","PSOHLNE1",172,0)
NTE ;
"RTN","PSOHLNE1",173,0)
 S WPCT=1,WORDP=$S($P(MSG(LL),"|",2):$P(MSG(LL),"|",2),1:$P(MSG(LL),"|",3)) S:$P(MSG(LL),"|",4)'="" WPARRAY(WORDP,WPCT)=$P(MSG(LL),"|",4) S:$P(MSG(LL),"|",4)'="" WPCT=WPCT+1 F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNE1",174,0)
 .I $G(MSG(LL,LLL))'="" S WPARRAY(WORDP,WPCT)=$G(MSG(LL,LLL)),WPCT=WPCT+1
"RTN","PSOHLNE1",175,0)
 Q
"RTN","PSOHLNEW")
0^5^B79208522^B78115354
"RTN","PSOHLNEW",1,0)
PSOHLNEW ;BIR/RTR - CPRS orders ;07/21/96
"RTN","PSOHLNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,7,15,46,71,98,111,124,117,131,146,132,143,223,235**;DEC 1997
"RTN","PSOHLNEW",3,0)
 ;40.8-728,50-221,SC-2675,100-2219,50.7-2223,ORERR-2187
"RTN","PSOHLNEW",4,0)
EN(MSG) ;
"RTN","PSOHLNEW",5,0)
 N PSODDRUG,ENTERED,LOCATION,PLACER,PSOOC,ROUTE,NATURE,PREV,ROUTING,OO,OR,STAT,ZZ,DFN,COMM,QCOUNT,OCOUNT,Q1I,QTARRAY,QTARRAY2,EE,PP,XOFLAG,PSODYSPL,PSOFILNM
"RTN","PSOHLNEW",6,0)
 N ONEFLAG,SERV,WPCT,EFFECT,PROV,PENDING,RRX,PSOLQ1I,PSOLQ1II,PSOQWX,PSOLQ1IX,PSONVA,PSOICD,PSOSCP,EEE
"RTN","PSOHLNEW",7,0)
 N OBXAR,AA,II,SIG1,FILLER,COMM,GG,FF,JJ,JJJ,CT,LIM,VAR,VAR1,QQQ,PSRNFLAG,PSRNQFLG,RCOMM,XOFLAGZ,NWFLAG,PFLAG,PSINPTR,INPTRX,PSOIBN,PSOIBY
"RTN","PSOHLNEW",8,0)
 N DSIG,PSOCHFFL,PSOCVI,PSOMO,PSOXRP,NN,LL,LLL,WPARRAY,QTVAR,POVAR,POVAR1,ORCSEG,NNN,OOO,AAA,NNNN,POLIM,NNCK,PRIOR,IPPLACER,PLACERXX,EER,PSERRPID,PSERRPV1,PSERRORC,PSOEXFLG,PSOMSORR,PDFN
"RTN","PSOHLNEW",9,0)
 S (SEND,PSOSND,OCOUNT)=0 K PSOPLC,PSOFFL,PSORSO,PSOSUSZ
"RTN","PSOHLNEW",10,0)
 F OO=0:0 S OO=$O(MSG(OO)) Q:'OO!(SEND)!(PSOSND)  D:$P(MSG(OO),"|")="PID" SPDFN I $P(MSG(OO),"|")="ORC",$P(MSG(OO),"|",2)'="NW",$P(MSG(OO),"|",2)'="XO" D
"RTN","PSOHLNEW",11,0)
 .S OR("STAT")=$P(MSG(OO),"|",2),OR("PLACE")=+$P(MSG(OO),"|",3),PLACERXX=+$P($P(MSG(OO),"|",3),";",2),OR("COMM")=$P(MSG(OO),"|",17),OR("USER")=$P(MSG(OO),"|",11) I $P(MSG(OO),"|",2)'="DE",$P(MSG(OO),"|",2)'="NA" S SEND=1 D FILL Q
"RTN","PSOHLNEW",12,0)
 .S PSOPLC=+$P(MSG(OO),"|",3),PSOFFL=+$P(MSG(OO),"|",4),PSOSND=1,PSOCHFFL=$P($P(MSG(OO),"|",4),"^")
"RTN","PSOHLNEW",13,0)
 I $G(OR("COMM"))["^" S OR("COMM")=$P(OR("COMM"),"^",5)
"RTN","PSOHLNEW",14,0)
 I PSOSND,$G(PSOCHFFL)["S",$G(OR("STAT"))="NA" D CHCS^PSOHLNE1 Q
"RTN","PSOHLNEW",15,0)
 I PSOSND,'$D(^PSRX(+$G(PSOFFL),0)) S COMM="Order was not located by Pharmacy" D EN^ORERR(COMM,.MSG) D KL Q
"RTN","PSOHLNEW",16,0)
 I PSOSND,$G(PDFN),PDFN'=+$P($G(^PSRX(+$G(PSOFFL),0)),"^",2) S COMM="Patient does not match" D EN^ORERR(COMM,.MSG) D KL Q
"RTN","PSOHLNEW",17,0)
 I PSOSND,$G(OR("STAT"))'="DE" N PSONAS S PSONAS=$S($P($G(^PSRX(PSOFFL,"OR1")),"^",2)="":1,1:0) S $P(^PSRX(PSOFFL,"OR1"),"^",2)=PSOPLC,^PSRX("APL",PSOPLC,PSOFFL)="" D:PSONAS EN^PSOHDR("PRES",PSOFFL) D KL Q
"RTN","PSOHLNEW",18,0)
 D KL
"RTN","PSOHLNEW",19,0)
 I SEND,$G(OR("STAT"))="Z@" G PURGE^PSOHLNE2
"RTN","PSOHLNEW",20,0)
 I SEND,$G(OR("STAT"))="ZF" G REF^PSOHLNE2
"RTN","PSOHLNEW",21,0)
 I SEND,$G(OR("STAT"))'="CA",$G(OR("STAT"))'="DC",$G(OR("STAT"))'="HD",$G(OR("STAT"))'="RL",$G(OR("STAT"))'="SS" S RCOMM="Invalid Order Control Code" D EN^ORERR(RCOMM,.MSG) Q
"RTN","PSOHLNEW",22,0)
 I SEND K SEND G:$G(OR("STAT"))="SS" ESTAT D EN^PSOORUTL(.OR) S PLACER=OR("PLACE"),STAT=OR("STAT"),COMM=OR("COMM") S PSOMSORR=1 D  K PSOMSORR Q
"RTN","PSOHLNEW",23,0)
 .I $G(OR("FILLER"))="" D  D ERROR^PSOHLSN Q
"RTN","PSOHLNEW",24,0)
 ..F EER=0:0 S EER=$O(MSG(EER)) Q:'EER  S:$P(MSG(EER),"|")="PV1" PSERRPV1=MSG(EER) S:$P(MSG(EER),"|")="PID" PSERRPID=MSG(EER) S:$P(MSG(EER),"|")="ORC"&($G(PSERRORC)="") PSERRORC=MSG(EER)
"RTN","PSOHLNEW",25,0)
 .I $P(OR("FILLER"),"^",2)="R" S FILLER=$P(OR("FILLER"),"^") D EN^PSOHLSN1(FILLER,STAT,$G(OR("PHARMST")),COMM) K:$G(PSOEXFLG) PSOMSORR,PLACERXX D:$G(PSOEXFLG) EN^PSOHLSN1(FILLER,"SC","ZE","") D:$G(PSOSUSZ) SUS^PSOORUT1 K PSOSUSZ Q
"RTN","PSOHLNEW",26,0)
 .D EN^PSOHLSN(PLACER,STAT,COMM) Q
"RTN","PSOHLNEW",27,0)
 D KL^PSOHLSIH S RRX=1 F ZZ=0:0 S ZZ=$O(MSG(ZZ)) Q:'ZZ  S PSOSEG=$G(MSG(ZZ)),PSOTYPE=$P(PSOSEG,"|") S PSOSEG=$E(PSOSEG,5,$L(PSOSEG)) I PSOTYPE'="NTE" D @PSOTYPE
"RTN","PSOHLNEW",28,0)
 I $G(PSRNFLAG) S PSOMO=0 D MISRN^PSOHLNE1 I $G(PSOMO) Q
"RTN","PSOHLNEW",29,0)
 S PSRNQFLG=0 I $G(PSRNFLAG),$G(PREV) D  I $G(PSRNQFLG) S RCOMM="Duplicate Renewal Request. Order rejected by Pharmacy." D EN^ORERR(RCOMM,.MSG) D RERROR^PSOHLSN D KL^PSOHLSIH Q
"RTN","PSOHLNEW",30,0)
 .I $P($G(^PSRX(PREV,"OR1")),"^",4) S PSRNQFLG=1 Q
"RTN","PSOHLNEW",31,0)
 .I $O(^PS(52.41,"AQ",PREV,0)) S PSRNQFLG=1
"RTN","PSOHLNEW",32,0)
 .I $G(XOFLAG),$G(DFN)'=$S($G(PFLAG):$P($G(^PS(52.41,+$G(PREV),0)),"^",2),1:$P($G(^PSRX(+$G(PREV),0)),"^",2)) S RCOMM="Patient mismatch on previous order." D EN^ORERR(RCOMM,.MSG) S XOFLAGZ=1 D RERROR^PSOHLSN D KL^PSOHLSIH Q
"RTN","PSOHLNEW",33,0)
 I $G(DFN)'=+$P($G(^OR(100,+$G(PLACER),0)),"^",2) G MISX^PSOHLNE1
"RTN","PSOHLNEW",34,0)
 I $G(PLACER) D NFILE
"RTN","PSOHLNEW",35,0)
 D KL^PSOHLSIH
"RTN","PSOHLNEW",36,0)
 Q
"RTN","PSOHLNEW",37,0)
ESTAT ;
"RTN","PSOHLNEW",38,0)
 D EXP^PSOHLNE1
"RTN","PSOHLNEW",39,0)
 Q
"RTN","PSOHLNEW",40,0)
MSH Q
"RTN","PSOHLNEW",41,0)
PID S DFN=+$P(PSOSEG,"|",3)
"RTN","PSOHLNEW",42,0)
 Q
"RTN","PSOHLNEW",43,0)
PV1 S LOCATION=+$P(+$P(PSOSEG,"|",3),"^")
"RTN","PSOHLNEW",44,0)
 S:'$D(^SC(LOCATION,0)) LOCATION=""
"RTN","PSOHLNEW",45,0)
 S INPTRX=0 I $G(LOCATION) S PSINPTR=$P($G(^SC(LOCATION,0)),"^",4) I PSINPTR Q
"RTN","PSOHLNEW",46,0)
 I $G(LOCATION) S INPTRX=$P($G(^SC(LOCATION,0)),"^",15)
"RTN","PSOHLNEW",47,0)
 I '$G(INPTRX) S INPTRX=$O(^DG(40.8,0))
"RTN","PSOHLNEW",48,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLNEW",49,0)
 S PSINPTR=+$$SITE^VASITE(DT,INPTRX)
"RTN","PSOHLNEW",50,0)
 Q
"RTN","PSOHLNEW",51,0)
DG1 S $P(PSOICD($P(PSOSEG,"|",1)),"^")=$P($P(PSOSEG,"|",3),"^")
"RTN","PSOHLNEW",52,0)
 Q
"RTN","PSOHLNEW",53,0)
ORC ;
"RTN","PSOHLNEW",54,0)
 Q:$P(PSOSEG,"|")="DE"
"RTN","PSOHLNEW",55,0)
 S:$P(PSOSEG,"|")="XO" XOFLAG=1 D ^PSOHLNE1 S:$G(PRIOR)="A" PRIOR="E" S:$G(PRIOR)="" PRIOR="R"
"RTN","PSOHLNEW",56,0)
 Q
"RTN","PSOHLNEW",57,0)
 ;
"RTN","PSOHLNEW",58,0)
RXO I $O(MSG(ZZ,0)) D ^PSOHLNE2 G RXOPS
"RTN","PSOHLNEW",59,0)
 S PSORDITE=$P($P(PSOSEG,"|"),"^",4)
"RTN","PSOHLNEW",60,0)
 S PSODDRUG=$P($P(PSOSEG,"|",10),"^",4) I $G(PSODDRUG) S:'$D(^PSDRUG(PSODDRUG,0)) PSODDRUG=""
"RTN","PSOHLNEW",61,0)
 S PSOXQTY=$P(PSOSEG,"|",11)
"RTN","PSOHLNEW",62,0)
 S PSOREFIL=$P(PSOSEG,"|",13)
"RTN","PSOHLNEW",63,0)
 S PSODYSPL=$P(PSOSEG,"|",17)
"RTN","PSOHLNEW",64,0)
RXOPS S ONEFLAG=0,WPCT=1,LL=ZZ+1
"RTN","PSOHLNEW",65,0)
 I $P($G(MSG(LL)),"|")="NTE" D
"RTN","PSOHLNEW",66,0)
 .S ONEFLAG=1,WORDP=$S($P(MSG(LL),"|",2):$P(MSG(LL),"|",2),1:$P(MSG(LL),"|",3)) S:$P(MSG(LL),"|",4)'="" WPARRAY(WORDP,WPCT)=$P(MSG(LL),"|",4) S:$P(MSG(LL),"|",4)'="" WPCT=WPCT+1 F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNEW",67,0)
 ..I $G(MSG(LL,LLL))'="" S WPARRAY(WORDP,WPCT)=$G(MSG(LL,LLL)),WPCT=WPCT+1
"RTN","PSOHLNEW",68,0)
 I ONEFLAG S LL=LL+1 I $P($G(MSG(LL)),"|")="NTE" D NTE^PSOHLNE1
"RTN","PSOHLNEW",69,0)
 K WORDP
"RTN","PSOHLNEW",70,0)
 Q
"RTN","PSOHLNEW",71,0)
RXR I $P($P(PSOSEG,"|"),"^",4) S ROUTE(RRX)=$P($P(PSOSEG,"|"),"^",4) S RRX=RRX+1
"RTN","PSOHLNEW",72,0)
 Q
"RTN","PSOHLNEW",73,0)
OBX I $O(MSG(ZZ,0)) D OBXX^PSOHLNE2 G OBXNTE
"RTN","PSOHLNEW",74,0)
 S OCOUNT=OCOUNT+1
"RTN","PSOHLNEW",75,0)
 S OBXAR(OCOUNT,1)=$P(PSOSEG,"|",5)
"RTN","PSOHLNEW",76,0)
OBXNTE ;
"RTN","PSOHLNEW",77,0)
 S LL=ZZ+1,PSOBCT=2
"RTN","PSOHLNEW",78,0)
 I $P($G(MSG(LL)),"|")="NTE" D
"RTN","PSOHLNEW",79,0)
 .I $P(MSG(LL),"|",4)'="" S PSOBCT=3,OBXAR(OCOUNT,2)=$P(MSG(LL),"|",4)
"RTN","PSOHLNEW",80,0)
 .F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNEW",81,0)
 ..I $P($G(MSG(LL,LLL)),"|",4)'="" S OBXAR(OCOUNT,PSOBCT)=$P(MSG(LL,LLL),"|",4),PSOBCT=PSOBCT+1
"RTN","PSOHLNEW",82,0)
 Q
"RTN","PSOHLNEW",83,0)
ZRN S PSODSC=1_"^"_$P(PSOSEG,"|",2)
"RTN","PSOHLNEW",84,0)
 I $O(MSG(ZZ,0)) F T=0:0 S T=$O(MSG(ZZ,T)) Q:'T  S PSODSC(T)=MSG(ZZ,T)
"RTN","PSOHLNEW",85,0)
 K T
"RTN","PSOHLNEW",86,0)
 Q
"RTN","PSOHLNEW",87,0)
 ;
"RTN","PSOHLNEW",88,0)
ZRX D ZRX^PSOHLNE1
"RTN","PSOHLNEW",89,0)
 Q
"RTN","PSOHLNEW",90,0)
 ;
"RTN","PSOHLNEW",91,0)
ZCL D ZCL^PSOHLNE1
"RTN","PSOHLNEW",92,0)
 Q
"RTN","PSOHLNEW",93,0)
ZSC D CP^PSOHLNE1
"RTN","PSOHLNEW",94,0)
 Q
"RTN","PSOHLNEW",95,0)
NFILE ;
"RTN","PSOHLNEW",96,0)
 I $G(PSODSC) D ^PSONVNEW Q  ;adds non-va med to #55
"RTN","PSOHLNEW",97,0)
 ;
"RTN","PSOHLNEW",98,0)
 K DD,DO,DIC S DLAYGO="52.41",DIC="^PS(52.41,",DIC(0)="L",X=PLACER,DIC("DR")="1////"_DFN_";2////"_PSOOC_";6////"_$G(EFFECT)_";12////"_$G(PSOXQTY)_";25////"_$G(PRIOR)
"RTN","PSOHLNEW",99,0)
 S DIC("DR")=DIC("DR")_";22////"_$G(PSORSO)_";22.1////"_$G(PREV)_";19////"_$G(ROUTING)_";17////"_$G(SERV)_";7////"_$G(NATURE)_";13////"_$G(PSOREFIL)_";1.1////"_$G(LOCATION)_";117////"_$G(DSIG)
"RTN","PSOHLNEW",100,0)
 D FILE^DICN K DIC,DR I Y<0 Q
"RTN","PSOHLNEW",101,0)
 S PENDING=+Y
"RTN","PSOHLNEW",102,0)
 S $P(^PS(52.41,PENDING,0),"^",4)=$S($G(ENTERED):+$G(ENTERED),1:""),$P(^(0),"^",5)=$S($G(PROV):+$G(PROV),1:""),$P(^(0),"^",8)=$S($G(PSORDITE):+$G(PSORDITE),1:""),$P(^(0),"^",9)=$S($G(PSODDRUG):+$G(PSODDRUG),1:""),$P(^(0),"^",15)=$G(ROUTE)
"RTN","PSOHLNEW",103,0)
 S ^PS(52.41,PENDING,"IBQ")=$G(PSOIBY)
"RTN","PSOHLNEW",104,0)
 I $G(PSODYSPL)'="",$E(PSODYSPL)?1A S PSODYSPL=$E(PSODYSPL,2,$L(PSODYSPL))
"RTN","PSOHLNEW",105,0)
 S $P(^PS(52.41,PENDING,"INI"),"^")=$G(PSINPTR),$P(^(0),"^",12)=$G(PSOLOG),$P(^(0),"^",22)=$G(PSODYSPL)
"RTN","PSOHLNEW",106,0)
 I $G(QCOUNT) S ^PS(52.41,PENDING,1,0)="^52.413^"_QCOUNT_"^"_QCOUNT
"RTN","PSOHLNEW",107,0)
 S PSOQWX=$G(PSODDRUG) D:'$G(PSOQWX) OID^PSOHLNE1
"RTN","PSOHLNEW",108,0)
 F PP=0:0 S PP=$O(Q1I(PP)) Q:'PP  S ^PS(52.41,PENDING,1,PP,0)=$S($G(PSOQWX)&($G(PSOLQ1II(PP))):Q1I(PP),$G(PSOQWX)&($G(PSOLQ1IX(PP))'="")&('$G(PSOLQ1II(PP))):PSOLQ1IX(PP),1:PSOLQ1I(PP))
"RTN","PSOHLNEW",109,0)
 F EE=0:0 S EE=$O(QTARRAY(EE)) Q:'EE  S ^PS(52.41,PENDING,1,EE,1)=QTARRAY(EE),^PS(52.41,PENDING,1,EE,2)=$S($G(PSOQWX)&($G(PSOLQ1II(EE))):$G(QTARRAY2(EE)),$G(PSOQWX)&($G(PSOLQ1IX(EE))'="")&('$G(PSOLQ1II(EE))):PSOLQ1IX(EE),1:$G(PSOLQ1I(EE))) D
"RTN","PSOHLNEW",110,0)
 .S $P(^PS(52.41,PENDING,1,EE,1),"^",8)=+$G(ROUTE(EE))
"RTN","PSOHLNEW",111,0)
 S:$P($G(^PS(52.41,PENDING,1,1,1)),"^",3) $P(^PS(52.41,PENDING,0),"^",18)=$E($P($G(^PS(52.41,PENDING,1,1,1)),"^",3),1,7)
"RTN","PSOHLNEW",112,0)
 D STUFF^PSOHLNE2
"RTN","PSOHLNEW",113,0)
 D ^PSOHLPII
"RTN","PSOHLNEW",114,0)
 S LL=0 I $O(WPARRAY(6,0)) F LLL=0:0 S LLL=$O(WPARRAY(6,LLL)) Q:'LLL  S LL=LL+1 S ^PS(52.41,PENDING,3,LL,0)=$G(WPARRAY(6,LLL))
"RTN","PSOHLNEW",115,0)
 I LL S ^PS(52.41,PENDING,3,0)="^52.42^"_LL_"^"_LL
"RTN","PSOHLNEW",116,0)
 S LL=0 I $O(WPARRAY(7,0)) F LLL=0:0 S LLL=$O(WPARRAY(7,LLL)) Q:'LLL  S LL=LL+1 S ^PS(52.41,PENDING,"INS1",LL,0)=$G(WPARRAY(7,LLL))
"RTN","PSOHLNEW",117,0)
 I LL S ^PS(52.41,PENDING,"INS1",0)="^^"_LL_"^"_LL_"^"_$G(DT)_"^"
"RTN","PSOHLNEW",118,0)
 I $P($G(^PS(50.7,+$G(PSORDITE),"INS")),"^")'="" S $P(^PS(52.41,PENDING,"INS"),"^",2)=$S($O(^PS(52.41,PENDING,"INS1",0)):1,1:0)
"RTN","PSOHLNEW",119,0)
 I $G(OCOUNT) S ^PS(52.41,PENDING,"OBX",0)="^52.4118A^"_OCOUNT_"^"_OCOUNT F OCOUNT=1:1:OCOUNT D
"RTN","PSOHLNEW",120,0)
 .S ^PS(52.41,PENDING,"OBX",OCOUNT,0)=$G(OBXAR(OCOUNT,1))
"RTN","PSOHLNEW",121,0)
 .D USER^PSOORFI2(+$G(PROV)) S ^PS(52.41,PENDING,"OBX",OCOUNT,1)=USER1 K USER1
"RTN","PSOHLNEW",122,0)
 .S PSOBCT=1 F LLL=2:1 Q:'$D(OBXAR(OCOUNT,LLL))  S ^PS(52.41,PENDING,"OBX",OCOUNT,2,PSOBCT,0)=OBXAR(OCOUNT,LLL),^PS(52.41,PENDING,"OBX",OCOUNT,2,0)="^^"_PSOBCT_"^"_PSOBCT_"^"_$G(DT)_"^"
"RTN","PSOHLNEW",123,0)
 D ^PSOHLPIS
"RTN","PSOHLNEW",124,0)
 K DIK S DIK="^PS(52.41,",DA=PENDING D IX^DIK
"RTN","PSOHLNEW",125,0)
 I $G(PSOOC)="RNW",$G(PREV),$D(^PSRX(+$G(PREV),0)) D EN^PSOHLSN1(PREV,"SC","ZZ","")
"RTN","PSOHLNEW",126,0)
 S PSOMSORR=1,IPPLACER=$P($G(^PS(52.41,PENDING,0)),"^") I IPPLACER D
"RTN","PSOHLNEW",127,0)
 .I '$G(XOFLAG) D EN^PSOHLSN(IPPLACER,"OK","IP") Q
"RTN","PSOHLNEW",128,0)
 .D EN^PSOHLSN(IPPLACER,"XR","IP") I $G(PFLAG) D DCP^PSOHLSN Q
"RTN","PSOHLNEW",129,0)
 .K PSOMSORR I $D(^PSRX(+$G(PREV),0)) S $P(^PSRX(PREV,"STA"),"^")=15,$P(^PSRX(PREV,3),"^",5)=$S($P($G(^PSRX(PREV,3)),"^"):$P(^(3),"^"),1:DT) D CAN^PSOTPCAN(PREV),CAN^PSOUTL(PREV) D  D EN^PSOHLSN1(PREV,"RP","","","A")
"RTN","PSOHLNEW",130,0)
 ..D CNT^PSOHLNE1
"RTN","PSOHLNEW",131,0)
 ..D:$G(^PS(52.41,PENDING,1,1,0))=""&($P($G(^PS(52.41,PENDING,1,1,1)),"^")="")&($G(^PS(52.41,PENDING,"SIG",1,0))="")
"RTN","PSOHLNEW",132,0)
 ...N FSIG,BSIG
"RTN","PSOHLNEW",133,0)
 ...I '$P($G(^PSRX(PREV,"SIG")),"^",2),$P($G(^("SIG")),"^")'="" D
"RTN","PSOHLNEW",134,0)
 ....D EN3^PSOUTLA1(PREV,70)
"RTN","PSOHLNEW",135,0)
 ....I $G(BSIG(1))'="" S ^PS(52.41,PENDING,"SIG",1,0)=$G(BSIG(1)) I $O(BSIG(1)) F EE=1:0 S EE=$O(BSIG(EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",EE,0)=$G(BSIG(EE))
"RTN","PSOHLNEW",136,0)
 ...I $P($G(^PSRX(PREV,"SIG")),"^",2),$G(^PSRX(PREV,"SIG1",1,0))'="" D
"RTN","PSOHLNEW",137,0)
 ....D FSIG^PSOUTLA("R",PREV,70)
"RTN","PSOHLNEW",138,0)
 ....I $G(FSIG(1))'="" S ^PS(52.41,PENDING,"SIG",1,0)=$G(FSIG(1)) I $O(FSIG(1)) F EE=1:0 S EE=$O(FSIG(EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",EE,0)=$G(FSIG(EE))
"RTN","PSOHLNEW",139,0)
 ...F EE=0:0 S EE=$O(^PS(52.41,PENDING,"SIG",EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",0)="^52.4124A^"_EE_"^"_EE
"RTN","PSOHLNEW",140,0)
 S (EE,EEE)=0 F  S EE=$O(PSOICD(EE)) Q:EE=""  D
"RTN","PSOHLNEW",141,0)
 .S EEE=EEE+1,^PS(52.41,PENDING,"ICD",EEE,0)=PSOICD(EE)
"RTN","PSOHLNEW",142,0)
 .S ^PS(52.41,PENDING,"ICD",0)="^52.41311PA"_U_EEE_U_EEE
"RTN","PSOHLNEW",143,0)
 Q
"RTN","PSOHLNEW",144,0)
SPDFN S PDFN=$P($G(MSG(OO)),"|",4) Q
"RTN","PSOHLNEW",145,0)
KL K PSOPLC,PSOFFL,PSOSND
"RTN","PSOHLNEW",146,0)
 Q
"RTN","PSOHLNEW",147,0)
FILL ;
"RTN","PSOHLNEW",148,0)
 S (PSOFILNM,OR("PSOFILNM"))=$P($P(MSG(OO),"|",4),"^")
"RTN","PSOHLNEW",149,0)
 Q
"RTN","PSOHLSN1")
0^4^B86702182^B86664066
"RTN","PSOHLSN1",1,0)
PSOHLSN1 ;BIR/RTR - Send order info to OERR from file 52 ;10/10/94
"RTN","PSOHLSN1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,10,24,27,55,46,71,101,99,121,139,157,181,143,235**;DEC 1997
"RTN","PSOHLSN1",3,0)
 ;Ref #50.606-DBIA 2174
"RTN","PSOHLSN1",4,0)
 ;#50.607-2221
"RTN","PSOHLSN1",5,0)
 ;#50.7-2223
"RTN","PSOHLSN1",6,0)
 ;#51.2-2226
"RTN","PSOHLSN1",7,0)
 ;#50-221
"RTN","PSOHLSN1",8,0)
 ;PSNDF-2195
"RTN","PSOHLSN1",9,0)
 ;EN^PSSUTIL1-3179
"RTN","PSOHLSN1",10,0)
 ;
"RTN","PSOHLSN1",11,0)
EN(PSRXIEN,STAT,PSSTAT,COMM,PSNOO) ;
"RTN","PSOHLSN1",12,0)
 N COUNT,DFN,J,LIMIT,NAME,NULLFLDS,PSDIEN,PSFLAG,PSND1,PSND2,PSND3,PRODUCT,UNIT,POIPTR,PSOHINST,PODOSE,PODOSENM,PSROUTE,RTNAME,SEGMENT,CCC,BBB,CSCOUNT,PPTR,MSG,PSOHSTRT,PSOHSTOP,PSOHISSD,PSORTLP,ZRXFLAG,RXE2FLAG,RXE2ONLY,PSODFN,EDUZ
"RTN","PSOHLSN1",13,0)
 N PSOCDDUZ,DA,FSIG,BSIG,PSHRX,PSHORX,PSNOOTX,ZPRE,PSOZSTAT,CCCX,PSOCPS,PSOICD
"RTN","PSOHLSN1",14,0)
 K FIELD
"RTN","PSOHLSN1",15,0)
 I $G(STAT)="" Q
"RTN","PSOHLSN1",16,0)
 I STAT="CR"!(STAT="DR")!(STAT="HR")!(STAT="OC")!(STAT="OD")!(STAT="OH")!(STAT="Z@")!(STAT="RP") S PSOZSTAT=STAT D DELP^PSOHLSN S STAT=PSOZSTAT G SKIP
"RTN","PSOHLSN1",17,0)
 I STAT="SC" I $G(PSSTAT)="ZE"!($G(PSSTAT)="HD")!($G(PSSTAT)="DC") S PSOZSTAT=STAT D DELP^PSOHLSN S STAT=PSOZSTAT
"RTN","PSOHLSN1",18,0)
SKIP ;
"RTN","PSOHLSN1",19,0)
 I $G(STAT)="SC",$G(PSSTAT)="ZE",$P($G(^PSRX(+$G(PSRXIEN),0)),"^",19)=2 Q
"RTN","PSOHLSN1",20,0)
 I $G(STAT)="RP" S STAT="OD",PSSTAT="RP"
"RTN","PSOHLSN1",21,0)
 S COUNT=0,NULLFLDS="F JJ=0:1:LIMIT S FIELD(JJ)="""""
"RTN","PSOHLSN1",22,0)
 I '$D(^PSRX(PSRXIEN,0)) Q
"RTN","PSOHLSN1",23,0)
 I STAT'="SN",STAT'="ZC",'$P($G(^PSRX(PSRXIEN,"OR1")),"^",2) Q
"RTN","PSOHLSN1",24,0)
 I $G(STAT)="SC",$G(PSSTAT)="ZE" S $P(^PSRX(PSRXIEN,0),"^",19)=2
"RTN","PSOHLSN1",25,0)
 D INIT
"RTN","PSOHLSN1",26,0)
 S COUNT=1,(ZRXFLAG,RXE2FLAG,RXE2ONLY)=0 D PID,PV1,ORC
"RTN","PSOHLSN1",27,0)
 I $G(STAT)="Z@" G NCM
"RTN","PSOHLSN1",28,0)
 I $G(STAT)="OK"!($G(STAT)="SN")!($G(STAT)="ZC")!($G(STAT)="XX")!($G(STAT)="SC")!($G(STAT)="RO") D RXO,RXE,RXR,ZRX,DG1,ZCL G NCM
"RTN","PSOHLSN1",29,0)
 I $G(STAT)="SC",$G(PSSTAT)="CM" D RXO,RXE,RXR,ZRX,DG1,ZCL
"RTN","PSOHLSN1",30,0)
 I '$G(RXE2FLAG) S RXE2ONLY=1 D RXE,SEGPARX^PSOHLSN
"RTN","PSOHLSN1",31,0)
 I '$G(ZRXFLAG) D ZRX
"RTN","PSOHLSN1",32,0)
NCM D SEND
"RTN","PSOHLSN1",33,0)
 K PSRXIEN Q
"RTN","PSOHLSN1",34,0)
INIT K ^UTILITY("DIQ1",$J),DIQ S DA=$P($$SITE^VASITE(),"^") I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOHINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIQ,DIC
"RTN","PSOHLSN1",35,0)
 S MSG(1)="MSH|^~\&|PHARMACY|"_$G(PSOHINST)_"|||||"_$S($G(PSOMSORR):"ORR",1:"ORM")
"RTN","PSOHLSN1",36,0)
 Q
"RTN","PSOHLSN1",37,0)
PID S LIMIT=5 X NULLFLDS
"RTN","PSOHLSN1",38,0)
 S DFN=+$P(^PSRX(PSRXIEN,0),"^",2) D DEM^VADPT S NAME=$G(VADM(1)) K VADM
"RTN","PSOHLSN1",39,0)
 S FIELD(0)="PID"
"RTN","PSOHLSN1",40,0)
 S FIELD(3)=DFN
"RTN","PSOHLSN1",41,0)
 S FIELD(5)=NAME
"RTN","PSOHLSN1",42,0)
 D SEG Q
"RTN","PSOHLSN1",43,0)
DG1 D DG1^PSOHLSN2
"RTN","PSOHLSN1",44,0)
 Q
"RTN","PSOHLSN1",45,0)
PV1 ;
"RTN","PSOHLSN1",46,0)
 S LIMIT=19 X NULLFLDS
"RTN","PSOHLSN1",47,0)
 S FIELD(0)="PV1"
"RTN","PSOHLSN1",48,0)
 S FIELD(2)="O"
"RTN","PSOHLSN1",49,0)
 S:$P(^PSRX(PSRXIEN,0),"^",5) FIELD(3)=$P(^(0),"^",5)
"RTN","PSOHLSN1",50,0)
 D SEG Q
"RTN","PSOHLSN1",51,0)
ORC ;
"RTN","PSOHLSN1",52,0)
 S LIMIT=15 X NULLFLDS
"RTN","PSOHLSN1",53,0)
 S FIELD(0)="ORC"
"RTN","PSOHLSN1",54,0)
 S FIELD(1)=$G(STAT)
"RTN","PSOHLSN1",55,0)
 I $G(STAT)'="SN",$G(STAT)'="ZC" S FIELD(2)=$P($G(^PSRX(PSRXIEN,"OR1")),"^",2)
"RTN","PSOHLSN1",56,0)
 S:FIELD(2)'="" FIELD(2)=FIELD(2)_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"
"RTN","PSOHLSN1",57,0)
 S FIELD(3)=PSRXIEN_"^PS"
"RTN","PSOHLSN1",58,0)
 S FIELD(5)=$G(PSSTAT)
"RTN","PSOHLSN1",59,0)
 I $G(STAT)="RO",$G(PSOROPCH)'="PATCH" S FIELD(5)="CM"
"RTN","PSOHLSN1",60,0)
 I $G(FIELD(5))="" I $G(STAT)="OR"!($G(STAT)="OE") S FIELD(5)="CM"
"RTN","PSOHLSN1",61,0)
 S X=$P($G(^PSRX(PSRXIEN,2)),"^") I X S FIELD(9)=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",62,0)
 S EDUZ=$P($G(^PSRX(PSRXIEN,0)),"^",16) I EDUZ S FIELD(10)=EDUZ_"^"_$P($G(^VA(200,EDUZ,0)),"^")
"RTN","PSOHLSN1",63,0)
 I $G(PSOCANRC),$G(PSOCANRN)'="" I $G(STAT)="OD"!($G(STAT)="OC") S FIELD(12)=$G(PSOCANRC)_"^"_$G(PSOCANRN)
"RTN","PSOHLSN1",64,0)
 I '$G(FIELD(12)) S FIELD(12)=$P($G(^PSRX(PSRXIEN,0)),"^",4)_"^"_$P($G(^VA(200,+$P($G(^PSRX(PSRXIEN,0)),"^",4),0)),"^")
"RTN","PSOHLSN1",65,0)
 S PSOHISSD="",X=$P($G(^PSRX(PSRXIEN,0)),"^",13) I X S PSOHISSD=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",66,0)
 S FIELD(15)=$G(PSOHISSD) K X
"RTN","PSOHLSN1",67,0)
 D SEG
"RTN","PSOHLSN1",68,0)
 I $G(COMM)'=""!($G(PSNOO)'="") D
"RTN","PSOHLSN1",69,0)
 .I $G(PSNOO)'="" D NOO
"RTN","PSOHLSN1",70,0)
 .I $L($G(COMM))+($L(MSG(COUNT)))+($L($G(PSNOOTX)))+($S($G(PSNOO)'="":11,1:5))<245 S MSG(COUNT)=MSG(COUNT)_"|"_$G(PSNOO)_"^"_$G(PSNOOTX)_"^"_$S($G(PSNOO)'="":"99ORN",1:"")_"^^"_$G(COMM)_"^" Q
"RTN","PSOHLSN1",71,0)
 .S MSG(COUNT,1)="|"_$G(PSNOO)_"^"_$G(PSNOOTX)_"^"_$S($G(PSNOO)'="":"99ORN",1:"")_"^^"_$G(COMM)_"^"
"RTN","PSOHLSN1",72,0)
 Q
"RTN","PSOHLSN1",73,0)
 ;
"RTN","PSOHLSN1",74,0)
RXO ;
"RTN","PSOHLSN1",75,0)
 S LIMIT=1 X NULLFLDS
"RTN","PSOHLSN1",76,0)
 S FIELD(0)="RXO"
"RTN","PSOHLSN1",77,0)
 S PPTR=+$P($G(^PSRX(PSRXIEN,"OR1")),"^")
"RTN","PSOHLSN1",78,0)
 S FIELD(1)=$S('PPTR:"^^^^^",1:"^^^"_PPTR_"^"_$P($G(^PS(50.7,PPTR,0)),"^")_" "_$P($G(^PS(50.606,+$P($G(^(0)),"^",2),0)),"^")_"^99PSP")
"RTN","PSOHLSN1",79,0)
 D SEG Q
"RTN","PSOHLSN1",80,0)
 ;
"RTN","PSOHLSN1",81,0)
RXE ;
"RTN","PSOHLSN1",82,0)
 S RXE2FLAG=1
"RTN","PSOHLSN1",83,0)
 S LIMIT=$S('$G(RXE2ONLY):26,1:2) X NULLFLDS
"RTN","PSOHLSN1",84,0)
 S FIELD(0)="RXE"
"RTN","PSOHLSN1",85,0)
 S (PSOHSTRT,PSOHSTOP)="" S X=$P($G(^PSRX(PSRXIEN,2)),"^",2) I X S PSOHSTRT=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",86,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLSN1",87,0)
 S X=$S($P($G(^PSRX(PSRXIEN,3)),"^",5):$P($G(^(3)),"^",5),$G(STAT)="OD"!($G(STAT)="OC"):$G(DT),$P($G(^(2)),"^",6):$P($G(^(2)),"^",6),1:$G(DT)) I X S PSOHSTOP=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",88,0)
 K X N PSOMZT,MMZZ,MMZZT S MMZZT=1 F MMZZ=0:0 S MMZZ=$O(^PSRX(PSRXIEN,6,MMZZ)) Q:'MMZZ  D:$D(^(MMZZ,0))
"RTN","PSOHLSN1",89,0)
 .S FIELD(1,MMZZT)=$S($P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",2):$P($G(^(0)),"^")_"&"_$P($G(^PS(50.607,+$P($G(^(0)),"^",3),0)),"^")_"&"_$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",2)_"&"_$P($G(^(0)),"^",4),1:"")_"^"_$P($G(^(0)),"^",8)
"RTN","PSOHLSN1",90,0)
 .I $P($G(FIELD(1,MMZZT)),"^")'="" F PSOMZT=1,3 I $E($P(FIELD(1,MMZZT),"&",PSOMZT),1)="." S $P(FIELD(1,MMZZT),"&",PSOMZT)="0"_$P(FIELD(1,MMZZT),"&",PSOMZT)
"RTN","PSOHLSN1",91,0)
 .S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"^"_$$DUR(PSRXIEN,MMZZ)_"^^^^^"_$S($P($G(FIELD(1,MMZZT)),"^")'="":$P($G(FIELD(1,MMZZT)),"&")_$P($G(FIELD(1,MMZZT)),"&",2),1:$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^"))
"RTN","PSOHLSN1",92,0)
 .S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"^"_$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",6)
"RTN","PSOHLSN1",93,0)
 .I $O(^PSRX(PSRXIEN,6,MMZZ)) S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"~"
"RTN","PSOHLSN1",94,0)
 .S MMZZT=MMZZT+1
"RTN","PSOHLSN1",95,0)
 S $P(FIELD(1,1),"^",4)=$G(PSOHSTRT),$P(FIELD(1,1),"^",5)=$G(PSOHSTOP)
"RTN","PSOHLSN1",96,0)
 S PSFLAG=0,PSDIEN=+$P(^PSRX(PSRXIEN,0),"^",6),PSND1=$P($G(^PSDRUG(PSDIEN,"ND")),"^"),PSND2=$P($G(^("ND")),"^",2),PSND3=$P($G(^("ND")),"^",3) I PSND1,PSND3 S PSFLAG=1
"RTN","PSOHLSN1",97,0)
 S FIELD(2)=$S(PSFLAG:PSND1_"."_PSND3_"^"_PSND2_"^"_"99NDF",1:"^^")_"^"_PSDIEN_"^"_$P($G(^PSDRUG(PSDIEN,0)),"^")_"^"_"99PSD"
"RTN","PSOHLSN1",98,0)
 Q:$G(RXE2ONLY)
"RTN","PSOHLSN1",99,0)
 I PSFLAG D
"RTN","PSOHLSN1",100,0)
 .I $T(^PSNAPIS)]"" S PSOXN=$$DFSU^PSNAPIS(PSND1,PSND3) S FIELD(5)="^^^"_$P($G(PSOXN),"^",5)_"^"_$P($G(PSOXN),"^",6)_"^"_"99PSU" K PSOXN Q
"RTN","PSOHLSN1",101,0)
 .S PRODUCT=$G(^PSNDF(PSND1,5,PSND3,0)) S UNIT=$P($G(^PSNDF(PSND1,2,+$P(PRODUCT,"^",2),3,+$P(PRODUCT,"^",3),4,+$P(PRODUCT,"^",4),0)),"^")
"RTN","PSOHLSN1",102,0)
 .S FIELD(5)="^^^"_UNIT_"^"_$P($G(^PS(50.607,+UNIT,0)),"^")_"^"_"99PSU"
"RTN","PSOHLSN1",103,0)
 S POIPTR=$P($G(^PSRX(PSRXIEN,"OR1")),"^") I POIPTR S PODOSE=$P($G(^PS(50.7,POIPTR,0)),"^",2),PODOSENM=$P($G(^PS(50.606,+PODOSE,0)),"^")
"RTN","PSOHLSN1",104,0)
 I POIPTR S FIELD(6)="^^^"_$G(PODOSE)_"^"_$G(PODOSENM)_"^"_"99PSF"
"RTN","PSOHLSN1",105,0)
 S FIELD(10)=$P(^PSRX(PSRXIEN,0),"^",7)
"RTN","PSOHLSN1",106,0)
 S FIELD(12)=$P(^PSRX(PSRXIEN,0),"^",9)
"RTN","PSOHLSN1",107,0)
 S FIELD(14)=$P(^PSRX(PSRXIEN,0),"^",4)
"RTN","PSOHLSN1",108,0)
 S FIELD(15)=$P(^PSRX(PSRXIEN,0),"^")
"RTN","PSOHLSN1",109,0)
 S FIELD(22)=$P(^PSRX(PSRXIEN,0),"^",8)
"RTN","PSOHLSN1",110,0)
 K MMZZ S MMZZ=$$EN^PSSUTIL1(PSDIEN) S FIELD(25)=$S($E($P(MMZZ,"|"),1)=".":"0",1:"")_$P(MMZZ,"|"),FIELD(26)=$P(MMZZ,"|",2)
"RTN","PSOHLSN1",111,0)
 N PLIM,PVAR,PVAR1,SUBCOUNT D SEGPARX^PSOHLSN
"RTN","PSOHLSN1",112,0)
 ;
"RTN","PSOHLSN1",113,0)
 I $O(^PSRX(PSRXIEN,"PRC",0)) D
"RTN","PSOHLSN1",114,0)
 .S COUNT=COUNT+1,CCC=$O(^PSRX(PSRXIEN,"PRC",0))
"RTN","PSOHLSN1",115,0)
 .S MSG(COUNT)="NTE|6||"_$G(^PSRX(PSRXIEN,"PRC",CCC,0))
"RTN","PSOHLSN1",116,0)
 .S CSCOUNT=1 F CCC=CCC:0 S CCC=$O(^PSRX(PSRXIEN,"PRC",CCC)) Q:'CCC  S MSG(COUNT,CSCOUNT)=$G(^PSRX(PSRXIEN,"PRC",CCC,0)),CSCOUNT=CSCOUNT+1
"RTN","PSOHLSN1",117,0)
 I $O(^PSRX(PSRXIEN,"INS1",0)) D
"RTN","PSOHLSN1",118,0)
 .S COUNT=COUNT+1,CCC=$O(^PSRX(PSRXIEN,"INS1",0))
"RTN","PSOHLSN1",119,0)
 .S MSG(COUNT)="NTE|7|L|"_$G(^PSRX(PSRXIEN,"INS1",CCC,0))
"RTN","PSOHLSN1",120,0)
 .S CCCX=1 F CCC=CCC:0 S CCC=$O(^PSRX(PSRXIEN,"INS1",CCC,0)) Q:'CCC  I $D(^(0)) S MSG(COUNT,CCCX)=$G(^(0)) S CCCX=CCCX+1
"RTN","PSOHLSN1",121,0)
 S COUNT=COUNT+1
"RTN","PSOHLSN1",122,0)
 I $P($G(^PSRX(PSRXIEN,"SIG")),"^",2) D  Q
"RTN","PSOHLSN1",123,0)
 .D FSIG^PSOUTLA("R",PSRXIEN,238) S MSG(COUNT)="NTE|21||"_$S($G(FSIG(1))'="":$G(FSIG(1)),1:"No SIG available") I $O(FSIG(1)) F CCC=1:0 S CCC=$O(FSIG(CCC)) Q:'CCC  S MSG(COUNT,(CCC-1))=$G(FSIG(CCC))
"RTN","PSOHLSN1",124,0)
 I '$P($G(^PSRX(PSRXIEN,"SIG")),"^",2) D  Q
"RTN","PSOHLSN1",125,0)
 .D EN3^PSOUTLA1(PSRXIEN,238) S MSG(COUNT)="NTE|21||"_$S($G(BSIG(1))'="":$G(BSIG(1)),1:"No SIG available") I $O(BSIG(1)) F CCC=1:0 S CCC=$O(BSIG(CCC)) Q:'CCC  S MSG(COUNT,(CCC-1))=$G(BSIG(CCC))
"RTN","PSOHLSN1",126,0)
 Q
"RTN","PSOHLSN1",127,0)
 ;
"RTN","PSOHLSN1",128,0)
RXR ;
"RTN","PSOHLSN1",129,0)
 F PSORTLP=0:0 S PSORTLP=$O(^PSRX(PSRXIEN,6,PSORTLP)) Q:'PSORTLP  D
"RTN","PSOHLSN1",130,0)
 .S LIMIT=1 X NULLFLDS
"RTN","PSOHLSN1",131,0)
 .S FIELD(0)="RXR"
"RTN","PSOHLSN1",132,0)
 .S PSROUTE=$P($G(^PSRX(PSRXIEN,6,PSORTLP,0)),"^",7) I PSROUTE,$D(^PS(51.2,PSROUTE,0))  S RTNAME=$P(^PS(51.2,PSROUTE,0),"^")
"RTN","PSOHLSN1",133,0)
 .S FIELD(1)="^^^"_$G(PSROUTE)_"^"_$G(RTNAME)_"^"_"99PSR"
"RTN","PSOHLSN1",134,0)
 .D SEG
"RTN","PSOHLSN1",135,0)
 Q
"RTN","PSOHLSN1",136,0)
 ;
"RTN","PSOHLSN1",137,0)
ZCL D ZCL^PSOHLSN2
"RTN","PSOHLSN1",138,0)
 Q
"RTN","PSOHLSN1",139,0)
ZSC S PSOCPS=$$DT^PSOMLLDT S LIMIT=$S($G(PSOCPS):6,1:1) X NULLFLDS
"RTN","PSOHLSN1",140,0)
 S FIELD(0)="ZSC"
"RTN","PSOHLSN1",141,0)
 I '$G(PSOCPS) S FIELD(1)=$S($P($G(^PSRX(PSRXIEN,"IB")),"^"):"NSC",1:"SC")
"RTN","PSOHLSN1",142,0)
 I $G(PSOCPS) D
"RTN","PSOHLSN1",143,0)
 .S FIELD(1)=$P($G(^PSRX(PSRXIEN,"IBQ")),"^"),FIELD(2)=$P($G(^("IBQ")),"^",2),FIELD(3)=$P($G(^("IBQ")),"^",3),FIELD(4)=$P($G(^("IBQ")),"^",4),FIELD(5)=$P($G(^("IBQ")),"^",5),FIELD(6)=$P($G(^("IBQ")),"^",6),FIELD(7)=$P($G(^("IBQ")),"^",7)
"RTN","PSOHLSN1",144,0)
 D SEG Q
"RTN","PSOHLSN1",145,0)
ZRX ;
"RTN","PSOHLSN1",146,0)
 S ZRXFLAG=1
"RTN","PSOHLSN1",147,0)
 S LIMIT=6 X NULLFLDS
"RTN","PSOHLSN1",148,0)
 S FIELD(0)="ZRX"
"RTN","PSOHLSN1",149,0)
 S ZPRE=$P($G(^PSRX(PSRXIEN,"OR1")),"^",3) I ZPRE S FIELD(1)=$P($G(^PSRX(ZPRE,"OR1")),"^",2)
"RTN","PSOHLSN1",150,0)
 I '$G(FIELD(1)),$G(PSORDEDT) S FIELD(1)=$P($G(^PS(52.41,$G(PSORDEDT),0)),"^")
"RTN","PSOHLSN1",151,0)
 S FIELD(2)=$G(PSNOO)
"RTN","PSOHLSN1",152,0)
 I $G(STAT)="SN"!($G(STAT)="RO") S FIELD(3)=$S($G(STAT)="RO"!($G(PSOEDIT)):"E",$G(PSOOPT)=3:"R",1:"N")
"RTN","PSOHLSN1",153,0)
 S FIELD(4)=$P(^PSRX(PSRXIEN,0),"^",11)
"RTN","PSOHLSN1",154,0)
 S PSOCDDUZ=$S($G(PSOROPCH)="PATCH":$P($G(^PSRX(PSRXIEN,"OR1")),"^",5),$G(PSOHUIOR)&($P($G(^PSRX(PSRXIEN,"EXT")),"^")'=""):+$G(PSOCANRC),1:$G(DUZ))
"RTN","PSOHLSN1",155,0)
 I $G(PSOCDDUZ) S FIELD(5)=PSOCDDUZ_"^"_$P($G(^VA(200,PSOCDDUZ,0)),"^")_"^"_"99NP"
"RTN","PSOHLSN1",156,0)
 I $G(STAT)="ZD",$G(PSODISPP) S FIELD(6)="P"
"RTN","PSOHLSN1",157,0)
 D SEG Q
"RTN","PSOHLSN1",158,0)
SEG S SEGMENT="" F J=0:1:LIMIT S SEGMENT=$S(SEGMENT="":FIELD(J),1:SEGMENT_"|"_FIELD(J))
"RTN","PSOHLSN1",159,0)
 S COUNT=COUNT+1,MSG(COUNT)=SEGMENT
"RTN","PSOHLSN1",160,0)
 Q
"RTN","PSOHLSN1",161,0)
SEND D:$G(PSRXIEN)&($T(EN^PSOHDR)]"")&($G(PSOSSMES)'="CPRSUP")  K FIELD D MSG^XQOR("PS EVSEND OR",.MSG) Q
"RTN","PSOHLSN1",162,0)
 .I $G(STAT)="ZC"!($G(STAT)="UC")!($G(STAT)="UD")!($G(STAT)="UH")!($G(STAT)="UR")!($G(STAT)="DE")!($G(STAT)="ZD")!($G(STAT)="SN")!($G(STAT)="Z@") Q
"RTN","PSOHLSN1",163,0)
 .I $G(STAT)="SC",$G(PSSTAT)="ZZ" Q
"RTN","PSOHLSN1",164,0)
 .D EN^PSOHDR("PRES",PSRXIEN)
"RTN","PSOHLSN1",165,0)
 ;
"RTN","PSOHLSN1",166,0)
NOO ;
"RTN","PSOHLSN1",167,0)
 I $G(PSNOO)="" S PSNOOTX="" Q
"RTN","PSOHLSN1",168,0)
 S PSNOOTX=$S(PSNOO="W":"Written",PSNOO="V":"Verbal",PSNOO="P":"Telephoned",PSNOO="S":"Service Correction",PSNOO="X":"Rejected",PSNOO="D":"Duplicate",PSNOO="I":"Policy",PSNOO="E":"Physician Entered",PSNOO="A":"Auto DC",1:"") Q
"RTN","PSOHLSN1",169,0)
 Q
"RTN","PSOHLSN1",170,0)
 ;
"RTN","PSOHLSN1",171,0)
DUR(PSODX1,PSODX2) ;
"RTN","PSOHLSN1",172,0)
 N PSODX,PSODX4,PSODX5,PSODX6,PSODX7 S PSODX=$P($G(^PSRX(PSODX1,6,PSODX2,0)),"^",5)
"RTN","PSOHLSN1",173,0)
 I 'PSODX Q PSODX
"RTN","PSOHLSN1",174,0)
 S PSODX4=$L(PSODX),PSODX5=$E(PSODX,PSODX4)
"RTN","PSOHLSN1",175,0)
 S PSODX=$S(PSODX5?1A:PSODX,1:PSODX_"D")
"RTN","PSOHLSN1",176,0)
 S PSODX6=$L(PSODX)
"RTN","PSOHLSN1",177,0)
 S PSODX7=$E(PSODX,PSODX6)_$E(PSODX,1,(PSODX6-1))
"RTN","PSOHLSN1",178,0)
 Q PSODX7
"RTN","PSOHLSN1",179,0)
 Q
"RTN","PSOSUCHG")
0^8^B75647503^B71186627
"RTN","PSOSUCHG",1,0)
PSOSUCHG ;BIR/RTR-CHANGE SUSPENSE AND FILL AND REFILL DATES ;4/29/93
"RTN","PSOSUCHG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,26,130,235**;DEC 1997
"RTN","PSOSUCHG",3,0)
 ;External reference A^PSXCH is supported by DBIA 2205
"RTN","PSOSUCHG",4,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOSUCHG",5,0)
 ;External reference P^PSXCH is supported by DBIA 2205
"RTN","PSOSUCHG",6,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOSUCHG",7,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSOSUCHG",8,0)
 I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) D WARN^PSOSUDCN Q
"RTN","PSOSUCHG",9,0)
LU N PSOSDLK,PSOLKQT,PSODELLK,PSOSSTP W !! S DIR("A")="Change a specific Rx# or all Rx's for one patient",DIR(0)="SBO^S:SPECIFIC RX;A:ALL RXs FOR ONE PATIENT"
"RTN","PSOSUCHG",10,0)
 S DIR("?",1)="Enter 'S' to change a single prescription suspense date.",DIR("?")="Enter 'A' to change all of the prescription suspense dates for one patient."
"RTN","PSOSUCHG",11,0)
 D ^DIR K DIR G:$G(DIRUT)!(Y="") EXIT S ACT=Y D:ACT="A" ALL D:ACT="S" SPEC D ULK G LU
"RTN","PSOSUCHG",12,0)
EXIT D ULK K ISFLAG,ACT,BC,BCNUM,CBD,CNT,COM,D1,DA,DEAD,DEL,DELCNT,DFN,DIRUT,DR,DTOUT,DUOUT,HDSFN,I,II,INDT,OLD,OUT,PSPOP,RF,RFCNT,RX,RXDATE,RXREC,SFN,STOP,SUB,SUSCNT,VADM,WARN,X,Y,XOK,SRXPAR,SRXREC,SUSDOD,RECORD,PSOPOPUP,PSOSDLK,DELFLAG
"RTN","PSOSUCHG",13,0)
 K VADM,VA("PID"),VA("BID"),PSDIVCHK,PSOMSG,PSOLKQT,PSODELLK,PSOSSTP Q
"RTN","PSOSUCHG",14,0)
SPEC D ULK K INDT S (DELCNT,WARN,PSPOP,OUT)=0 W ! S DIR("A")="Select SUSPENDED Rx #: ",DIR(0)="FOA",DIR("?")="Enter the prescription# or wand the barcode.  To obtain a list of suspense prescriptions, type '??'",DIR("??")="^D LISTSUS^PSOSUCH1"
"RTN","PSOSUCHG",15,0)
 D ^DIR K DIR Q:$D(DIRUT)  D:Y["-" PSOINST^PSOSUPAT G:$G(OUT) SPEC D  W ! S DIC("S")="I $D(^PSRX(+$P(^PS(52.5,+Y,0),""^""),0))",DIC="^PS(52.5,",DIC(0)="ZQE" D ^DIC K DIC W ! Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOSUCHG",16,0)
 .I Y["-" S Y=$P(Y,"-",2),X=+$P($G(^PSRX(Y,0)),"^") Q
"RTN","PSOSUCHG",17,0)
 .S X=Y
"RTN","PSOSUCHG",18,0)
 G:Y<0 SPEC S DEAD=0,(SFN,DA)=+Y,RXREC=+Y(0),DFN=$P(^PS(52.5,SFN,0),"^",3),RXDATE=$P(Y(0),"^",2),STOP=$P(^PSRX(RXREC,2),"^",6),STAT=$P($G(^("STA")),"^") D  Q:$G(PSOLKQT)  D TST G:$T P^PSXCH
"RTN","PSOSUCHG",19,0)
 .K PSOMSG,PSOLKQT D PSOL^PSSLOCK(RXREC) I '$G(PSOMSG) W !,"Rx number: "_$P($G(^PSRX(RXREC,0)),"^")_" cannot be changed because" D LMES,PAUSE S PSOLKQT=1 K PSOMSG Q
"RTN","PSOSUCHG",20,0)
 .K PSOMSG S PSOSDLK(RXREC)=""
"RTN","PSOSUCHG",21,0)
RTN I STAT=11!(STOP<DT)!(STAT=12) D EXPCAN Q
"RTN","PSOSUCHG",22,0)
 D:$P($G(^PSRX(RXREC,"STA")),"^")<9 CHKDEAD^PSOSUCH1 Q:DEAD  I $G(PSODIV),+$P($G(^PS(52.5,SFN,0)),"^",6)'=PSOSITE S PSPOP=0 D CKDIV^PSOSUPAT Q:PSPOP
"RTN","PSOSUCHG",23,0)
 S DA=SFN,DIE=52.5,DR=".02;S INDT=X" D ^DIE K DIE D  Q:$D(Y)  W !
"RTN","PSOSUCHG",24,0)
 .I $D(INDT),INDT'=RXDATE,INDT<+$P($G(^PSRX(RXREC,0)),"^",13) S DA=SFN,DIE=52.5,DR=".02///"_RXDATE D ^DIE K DIE S Y="" W !!,"Suspense date cannot be before Issue Date of Rx!",!
"RTN","PSOSUCHG",25,0)
 I $D(X),X'=RXDATE S DA=RXREC D CHANGE^PSOSUCH1
"RTN","PSOSUCHG",26,0)
 D DEL G:ACT="A" ALL G:ACT="S" SPEC
"RTN","PSOSUCHG",27,0)
ALL D ULK K INDT S (DELCNT,PSDIVCHK,DELFLAG,PSPOP,PSOPOPUP,WARN,SUSCNT)=0 W ! S DIR("A")="Are you entering the patient name or barcode?",DIR(0)="SBO^P:Patient Name;B:Barcode"
"RTN","PSOSUCHG",28,0)
 S DIR("?")="Enter 'P' if you are going to enter the patient name.  Enter 'B' to enter or wand the barcode." D ^DIR K DIR Q:$D(DIRUT)  S BC=Y
"RTN","PSOSUCHG",29,0)
BC S OUT=0 I BC="B" W ! S DIR("A")="Enter/wand barcode",DIR(0)="FO^5:20",DIR("?")="Enter the barcode number or wand the barcode to change all of the prescription suspense dates for one patient" D ^DIR K DIR G:$G(DIRUT) ALL S BCNUM=Y D
"RTN","PSOSUCHG",30,0)
 .S RX=$P(BCNUM,"-",2) I '$G(RX) S OUT=1 W $C(7),!!?5,"Invalid Barcode!" Q
"RTN","PSOSUCHG",31,0)
 .I $D(^PSRX(RX,0)) D PSOINST^PSOSUPAT Q:OUT  S DFN=$P(^PSRX(RX,0),"^",2) W " ",$P($G(^DPT(DFN,0)),"^")
"RTN","PSOSUCHG",32,0)
 G:OUT BC
"RTN","PSOSUCHG",33,0)
 I BC="B",'$D(^PSRX(RX,0)) W $C(7),!!?5,"Invalid Barcode!",! G BC
"RTN","PSOSUCHG",34,0)
 I BC="B",'$D(^PS(52.5,"AC",DFN)) W !!?3,"This patient has no Rx's in suspense that have not already been printed!",! G BC
"RTN","PSOSUCHG",35,0)
NAM I BC="P" W ! S DIC(0)="AEMZQ",DIC="^DPT(",DIC("S")="I $D(^PS(52.5,""AC"",+Y))!($D(^PS(52.5,""AG"",+Y)))" D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<0) ALL S DFN=+Y
"RTN","PSOSUCHG",36,0)
 F CBD=0:0 S CBD=$O(^PS(55,DFN,"P",CBD)) Q:CBD'>0!($G(PSOPOPUP))  S:$D(^PS(55,DFN,"P",CBD,0)) RXREC=+^(0) D:$D(^PS(52.5,"B",RXREC)) TEST D ULK
"RTN","PSOSUCHG",37,0)
 G:ACT="A" ALL G:ACT="S" SPEC
"RTN","PSOSUCHG",38,0)
TEST S SFN=+$O(^PS(52.5,"B",RXREC,0)) Q:'SFN  Q:$P($G(^PS(52.5,SFN,"P")),"^")'=0  S STOP=$P(^PSRX(RXREC,2),"^",6),STAT=$P($G(^("STA")),"^") D  Q:$G(PSOLKQT)  D TST D:$T A^PSXCH Q:$G(XOK)=0  I STAT=11!(STOP<DT)!(STAT=12) D EXPCAN Q
"RTN","PSOSUCHG",39,0)
 .K PSOMSG,PSOLKQT D PSOL^PSSLOCK(RXREC) I '$G(PSOMSG) W !!,"Rx number: "_$P($G(^PSRX(RXREC,0)),"^")_" cannot be changed because" D LMES,PAUSE S PSOLKQT=1 K PSOMSG Q
"RTN","PSOSUCHG",40,0)
 .K PSOMSG S PSOSDLK(RXREC)=""
"RTN","PSOSUCHG",41,0)
 S PSPOP=0 D:PSODIV&('$G(PSDIVCHK)) DIV^PSOSUPAT S PSDIVCHK=1 S:PSPOP PSOPOPUP=1 I 'PSPOP D:$P($G(^PSRX(RXREC,"STA")),"^")<9 CHKDEAD^PSOSUCH1 Q:DEAD  D BEG
"RTN","PSOSUCHG",42,0)
 Q
"RTN","PSOSUCHG",43,0)
BEG S RXDATE=$P(^PS(52.5,SFN,0),"^",2),ISFLAG=0
"RTN","PSOSUCHG",44,0)
 I 'SUSCNT S DA=SFN,DIE=52.5,DR=".02;S INDT=X" D ^DIE D SI Q:ISFLAG  K:$G(^PS(52.5,SFN,"P"))=1 ^PS(52.5,"AC",DFN,+$P(^PS(52.5,SFN,0),"^",2),SFN) S:$D(Y) PSOPOPUP=1 Q:X=""!($D(DTOUT))!($G(PSOPOPUP))  S SUSCNT=1
"RTN","PSOSUCHG",45,0)
 I SUSCNT D IS Q:$G(ISFLAG)  S DA=SFN,DIE=52.5,DR=".02///"_INDT D ^DIE K DIE K:$G(^PS(52.5,SFN,"P"))=1 ^PS(52.5,"AC",DFN,+$P($G(^PS(52.5,SFN,0)),"^",2),SFN) I $D(DTOUT)!($D(DUOUT))!($D(Y)) S PSOPOPUP=1 Q
"RTN","PSOSUCHG",46,0)
 D CHANGE^PSOSUCH1
"RTN","PSOSUCHG",47,0)
DEL I 'DELCNT W !! S DIR("A")="Do you want to delete"_$S($G(ACT)="S":" this Rx ",1:" Rx's ")_"from suspense"_$S($G(ACT)="A":" for this patient",1:""),DIR("B")="N",DIR(0)="Y" D ^DIR K DIR S DELCNT=1 S DEL=Y Q:'Y  I $D(DIRUT) S PSOPOPUP=1 Q
"RTN","PSOSUCHG",48,0)
 I $G(ACT)="A",DELCNT,$G(DEL),'$G(DELFLAG) W !!,"Deleting Rx's from suspense..",! S DELFLAG=1 D DEL1 Q
"RTN","PSOSUCHG",49,0)
 Q:'DEL
"RTN","PSOSUCHG",50,0)
 I '$D(PSOSDLK(RXREC)) D  Q:$G(PSODELLK)
"RTN","PSOSUCHG",51,0)
 .K PSOMSG,PSODELLK D PSOL^PSSLOCK(RXREC) I '$G(PSOMSG) W !,"Rx number: "_$P($G(^PSRX(RXREC,0)),"^")_" cannot be deleted from suspense because" D LMES,PAUSE S PSODELLK=1 K PSOMSG Q
"RTN","PSOSUCHG",52,0)
 .K PSOMSG S PSOSDLK(RXREC)=""
"RTN","PSOSUCHG",53,0)
 I DEL S DA=$O(^PS(52.5,"B",RXREC,0)) D RF S DIK="^PS(52.5," D ^DIK K DIK D:$P(^PSRX(RXREC,"STA"),"^")=5  W:$G(ACT)="S" !!,"Rx# ",$P($G(^PSRX(RXREC,0)),"^")," has been deleted from suspense!",!
"RTN","PSOSUCHG",54,0)
 .S $P(^PSRX(RXREC,"STA"),"^")=0
"RTN","PSOSUCHG",55,0)
 .N PSOZZD S PSOZZD="Removed from suspense" D EN^PSOHLSN1(RXREC,"SC","ZU",PSOZZD) K PSOZZD Q
"RTN","PSOSUCHG",56,0)
 Q
"RTN","PSOSUCHG",57,0)
EXPCAN S DIK="^PS(52.5,",DA=SFN D ^DIK K DIK S Y=STOP D DD^%DT S PSOSSTP=Y I STOP<DT!(STAT=11) D:STAT'=11  W $C(7),!,"Rx# "_$P($G(^PSRX(RXREC,0)),"^")_" expired "_$G(PSOSSTP)_"."
"RTN","PSOSUCHG",58,0)
 .S $P(^PSRX(RXREC,"STA"),"^")=11
"RTN","PSOSUCHG",59,0)
 .N PSOZZD S PSOZZD="Expired while suspended" D EN^PSOHLSN1(RXREC,"SC","ZE",PSOZZD) K PSOZZD
"RTN","PSOSUCHG",60,0)
 W:STAT=12 $C(7),!,"Rx# "_$P(^PSRX(RXREC,0),"^")_" was discontinued "_Y_"." K STAT,STOP Q
"RTN","PSOSUCHG",61,0)
TST N X S X="PSXCH" X ^%ZOSF("TEST") K X Q
"RTN","PSOSUCHG",62,0)
 ;
"RTN","PSOSUCHG",63,0)
RF ;
"RTN","PSOSUCHG",64,0)
 S PSSHLDDA=DA,PSODFS=0
"RTN","PSOSUCHG",65,0)
 S SNODE=$G(^PS(52.5,DA,0)),PSINN=+SNODE D DAREC^PSOSUCH1 I '$G(PSINN)!($P(SNODE,"^",5)) K PSINN,SNODE,PSODFS S DA=PSSHLDDA Q
"RTN","PSOSUCHG",66,0)
 S PSIFN=0 F  S PSIFN=$O(^PSRX(PSINN,1,PSIFN)) Q:'PSIFN  I $P($G(^PSRX(PSINN,1,PSIFN,0)),"^")=$P(SNODE,"^",2),'$P($G(^PSRX(PSINN,1,PSIFN,0)),"^",18),$P($G(^PS(52.5,+$G(PSSHLDDA),"P")),"^")=0 S PSODFS=1 D
"RTN","PSOSUCHG",67,0)
 .K ^PSRX(PSINN,1,PSIFN,0),^PSRX(PSINN,1,PSIFN,1),^PSRX(PSINN,1,PSIFN,"IB"),^PSRX("AD",$P(SNODE,"^",2),PSINN,PSIFN),^PSRX(PSINN,1,"B",$P(SNODE,"^",2),PSIFN)
"RTN","PSOSUCHG",68,0)
 .S $P(^PSRX(PSINN,1,0),"^",4)=$P(^PSRX(PSINN,1,0),"^",4)-1
"RTN","PSOSUCHG",69,0)
 .S $P(^PSRX(PSINN,1,0),"^",3)=$P(^PSRX(PSINN,1,0),"^",3)-1
"RTN","PSOSUCHG",70,0)
 .S PSUSD=$P(SNODE,"^",2) D DATE
"RTN","PSOSUCHG",71,0)
 I '$G(PSODFS) G RFPS
"RTN","PSOSUCHG",72,0)
 S PSIFN=0 F  S PSIFN=$O(^PSRX(PSINN,1,PSIFN)) Q:'PSIFN  I '$O(^PSRX(PSINN,1,PSIFN)) S $P(^PSRX(PSINN,3),"^")=+$P(^PSRX(PSINN,1,PSIFN,0),"^")
"RTN","PSOSUCHG",73,0)
 I '$O(^PSRX(PSINN,1,0)) S $P(^PSRX(PSINN,3),"^")=$P(^PSRX(PSINN,2),"^",2)
"RTN","PSOSUCHG",74,0)
 S PSOX("IRXN")=PSINN D NEXT^PSOUTIL(.PSOX) S PSONEXT=$P(PSOX("RX3"),"^",2),DA=PSINN,DIE=52,DR="102///"_PSONEXT D ^DIE K DIE K PSONEXT,PSOX
"RTN","PSOSUCHG",75,0)
RFPS K PSODFS,ZZZ,PSINN,PSIFN,PSUSD,PNOD,SNODE S DA=PSSHLDDA K PSSHLDDA Q
"RTN","PSOSUCHG",76,0)
DATE S PNOD=0 F ZZZ=0:0 S ZZZ=$O(^PSRX(PSINN,1,ZZZ)) Q:'ZZZ  S PNOD=ZZZ
"RTN","PSOSUCHG",77,0)
 I PNOD=1 S $P(^PSRX(PSINN,3),"^",4)=$P(^PSRX(PSINN,2),"^",2) Q
"RTN","PSOSUCHG",78,0)
DATEX I $G(PNOD) S PNOD=PNOD-1 G:'$D(^PSRX(PSINN,1,PNOD,0)) DATEX
"RTN","PSOSUCHG",79,0)
 I PNOD=0 S $P(^PSRX(PSINN,3),"^",4)=$P(^PSRX(PSINN,2),"^",2) Q
"RTN","PSOSUCHG",80,0)
 S $P(^PSRX(PSINN,3),"^",4)=$P(^PSRX(PSINN,1,PNOD,0),"^") Q
"RTN","PSOSUCHG",81,0)
 Q
"RTN","PSOSUCHG",82,0)
IS K DIE I $G(INDT),$G(INDT)<+$P($G(^PSRX(RXREC,0)),"^",13) S DIE=52.5,DA=SFN,DR=".02///"_RXDATE D ^DIE K DIE W !!,"Suspense date cannot be before Issue Date for Rx# ",$P($G(^PSRX(RXREC,0)),"^") S ISFLAG=1
"RTN","PSOSUCHG",83,0)
 Q
"RTN","PSOSUCHG",84,0)
SI ;
"RTN","PSOSUCHG",85,0)
 S SUSCNT=1
"RTN","PSOSUCHG",86,0)
 I $D(Y) S (ISFLAG,PSOPOPUP)=1
"RTN","PSOSUCHG",87,0)
 G IS
"RTN","PSOSUCHG",88,0)
DEL1 ;
"RTN","PSOSUCHG",89,0)
 S PSOSUPOP=1
"RTN","PSOSUCHG",90,0)
 F WW=0:0 S WW=$O(^PS(55,DFN,"P",WW)) Q:WW'>0  S:$D(^PS(55,DFN,"P",WW,0)) RXREC=+^(0) D:$D(^PS(52.5,"B",+$G(RXREC)))
"RTN","PSOSUCHG",91,0)
 .I '$D(PSOSDLK(RXREC)) K PSODELLK D DELONE Q:$G(PSODELLK)
"RTN","PSOSUCHG",92,0)
 .I $P($G(^PSRX(RXREC,"STA")),"^")=11!($P($G(^PSRX(RXREC,2)),"^",6)<DT) D EXPCAN1 Q
"RTN","PSOSUCHG",93,0)
 .S DA=$O(^PS(52.5,"B",RXREC,0)) D RF S DIK="^PS(52.5," D ^DIK K DIK D:$P(^PSRX(RXREC,"STA"),"^")=5  W:$G(ACT)="S" !!,"Rx# ",$P($G(^PSRX(RXREC,0)),"^")," has been deleted from suspense!",!
"RTN","PSOSUCHG",94,0)
 ..S $P(^PSRX(RXREC,"STA"),"^")=0
"RTN","PSOSUCHG",95,0)
 ..N PSOZZD S PSOZZD="Removed from suspense" D EN^PSOHLSN1(RXREC,"SC","ZU",PSOZZD) K PSOZZD Q
"RTN","PSOSUCHG",96,0)
 Q
"RTN","PSOSUCHG",97,0)
ULK ;Unlock prescriptions
"RTN","PSOSUCHG",98,0)
 I '$O(PSOSDLK("")) Q
"RTN","PSOSUCHG",99,0)
 N PSOSDLKR S PSOSDLKR="" F  S PSOSDLKR=$O(PSOSDLK(PSOSDLKR)) Q:PSOSDLKR=""  D PSOUL^PSSLOCK(PSOSDLKR)
"RTN","PSOSUCHG",100,0)
 K PSOSDLK
"RTN","PSOSUCHG",101,0)
 Q
"RTN","PSOSUCHG",102,0)
PAUSE ;
"RTN","PSOSUCHG",103,0)
 W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR W !
"RTN","PSOSUCHG",104,0)
 Q
"RTN","PSOSUCHG",105,0)
LMES ;
"RTN","PSOSUCHG",106,0)
 W !,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order.")
"RTN","PSOSUCHG",107,0)
 Q
"RTN","PSOSUCHG",108,0)
DELONE ;
"RTN","PSOSUCHG",109,0)
 K PSOMSG,PSODELLK D PSOL^PSSLOCK(RXREC) I '$G(PSOMSG) W !,"Rx number: "_$P($G(^PSRX(RXREC,0)),"^")_" cannot be deleted from suspense because" D LMES,PAUSE S PSODELLK=1 K PSOMSG Q
"RTN","PSOSUCHG",110,0)
 K PSOMSG S PSOSDLK(RXREC)=""
"RTN","PSOSUCHG",111,0)
 Q
"RTN","PSOSUCHG",112,0)
EXPCAN1 ;
"RTN","PSOSUCHG",113,0)
 N SFN,Y,PSOSSTP,STAT,STOP
"RTN","PSOSUCHG",114,0)
 S STAT=$P($G(^PSRX(RXREC,"STA")),"^"),STOP=$P($G(^PSRX(RXREC,2)),"^",6)
"RTN","PSOSUCHG",115,0)
 S SFN=+$O(^PS(52.5,"B",RXREC,0)) Q:'SFN
"RTN","PSOSUCHG",116,0)
 S DIK="^PS(52.5,",DA=SFN D ^DIK K DIK S Y=STOP D DD^%DT S PSOSSTP=Y I STOP<DT!(STAT=11) D:STAT'=11  W $C(7),!,"Rx# "_$P($G(^PSRX(RXREC,0)),"^")_" expired "_$G(PSOSSTP)_"."
"RTN","PSOSUCHG",117,0)
 .S $P(^PSRX(RXREC,"STA"),"^")=11
"RTN","PSOSUCHG",118,0)
 .N PSOZZD S PSOZZD="Expired while suspended" D EN^PSOHLSN1(RXREC,"SC","ZE",PSOZZD) K PSOZZD
"RTN","PSOSUCHG",119,0)
 Q
"RTN","PSOSUTL")
0^6^B65085992^B60464250
"RTN","PSOSUTL",1,0)
PSOSUTL ;BIR/RTR - Suspense utility routine ;12/15/95
"RTN","PSOSUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,34,139,167,235**;DEC 1997
"RTN","PSOSUTL",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOSUTL",4,0)
 ;External reference to ^PSNDF supported by DBIA 2195
"RTN","PSOSUTL",5,0)
AREC1 ;
"RTN","PSOSUTL",6,0)
 S $P(^PSRX(RX,"STA"),"^")=0
"RTN","PSOSUTL",7,0)
 S SFN=$O(^PS(52.5,"B",RX,0)) I 'SFN D CPMS Q
"RTN","PSOSUTL",8,0)
 D NOW^%DTC S DTTM=% S COM="Suspense "_$S($G(RXRP(RX)):"(Reprint) ",1:"")_"Label Pulled Early"_$S($G(RXP):" (Partial)",1:"") S CNT=0 F JJ=0:0 S JJ=$O(^PSRX(RX,"A",JJ)) Q:'JJ  S CNT=JJ
"RTN","PSOSUTL",9,0)
 D DEL S $P(^PSRX(RX,"STA"),"^")=0 K PSODEL S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(RX,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOSUTL",10,0)
 I 'RFCNT,'$G(RXP),'$D(RXRP(RX)) S (X,OLD)=$P(^PSRX(RX,2),"^",2) D  K DIE
"RTN","PSOSUTL",11,0)
 .K DIE S DA=RX,DR="22////"_DT_";101////"_DT_";25////"_DT,DIE=52 D ^DIE
"RTN","PSOSUTL",12,0)
 I RFCNT,'$G(RXP),'$D(RXRP(RX)) S (OLD,X)=+$P($G(^PSRX(RX,1,RFCNT,0)),"^") D  K DIE S $P(^PSRX(RX,3),"^")=DT
"RTN","PSOSUTL",13,0)
 .K DIE S DA(1)=RX,DA=RFCNT,DIE="^PSRX("_DA(1)_",1,",DR=".01///"_DT_";10.1///"_DT D ^DIE
"RTN","PSOSUTL",14,0)
 S:'$D(PDUZ) PDUZ=DUZ S CNT=CNT+1,^PSRX(RX,"A",0)="^52.3DA^"_CNT_"^"_CNT
"RTN","PSOSUTL",15,0)
 S ^PSRX(RX,"A",CNT,0)=DTTM_"^S^"_PDUZ_"^"_$S($G(RXP):6,'RFCNT:RFCNT,RFCNT<6:RFCNT,1:(RFCNT+1))_"^"_COM
"RTN","PSOSUTL",16,0)
 D CPMS
"RTN","PSOSUTL",17,0)
 Q
"RTN","PSOSUTL",18,0)
CPMS ;
"RTN","PSOSUTL",19,0)
 N PSOZZDD S PSOZZDD="Label printed from suspense" D EN^PSOHLSN1(RX,"SC","ZU",PSOZZDD) K PSOZZDD
"RTN","PSOSUTL",20,0)
 Q
"RTN","PSOSUTL",21,0)
 ;
"RTN","PSOSUTL",22,0)
DEL S DA=SFN,DIK="^PS(52.5," D ^DIK K DIK Q
"RTN","PSOSUTL",23,0)
 ;I 'PSODELE S NODE=^PS(52.5,SFN,0) K ^PS(52.5,"C",$P(NODE,"^",2),SFN),^PS(52.5,"AC",$P(NODE,"^",3),$P(NODE,"^",2),SFN) S $P(^PS(52.5,SFN,0),"^",2)=DT,^PS(52.5,"C",DT,SFN)="",^PS(52.5,SFN,"P")=1 D  K NODE
"RTN","PSOSUTL",24,0)
 ;.S X1=DT,X2=+$P($G(^PS(59.7,1,40.1)),"^",5) D C^%DTC S ^PS(52.5,"ADL",X,SFN)="" K X
"RTN","PSOSUTL",25,0)
 ;I $P($G(^PS(52.5,SFN,0)),"^",7)'="" N DA,DR,DIE S DA=SFN,DIE="^PS(52.5,",DR="3////P" D ^DIE
"RTN","PSOSUTL",26,0)
 Q
"RTN","PSOSUTL",27,0)
AREC N PSOZZDMS S PSOZZDMS=0 S:$P(^PSRX(RX,"STA"),"^")=5 PSOZZDMS=1
"RTN","PSOSUTL",28,0)
 S:$P(^PSRX(RX,"STA"),"^")=5 $P(^PSRX(RX,"STA"),"^")=0 S SFN=$O(^PS(52.5,"B",RX,0)) D:'SFN&(PSOZZDMS) CPMSG Q:'SFN  D NOW^%DTC S DTTM=% S COM="Suspense "_$S($G(RXRP(RX)):"(Reprint) ",1:"")_"Label Printed"_$S($G(RXP):" (Partial)",1:"")
"RTN","PSOSUTL",29,0)
 S $P(^PS(52.5,SFN,"P"),"^")=1 D  K ^PS(52.5,"AC",DFN,$P(^PS(52.5,SFN,0),"^",2),SFN) S CNT=0 F JJ=0:0 S JJ=$O(^PSRX(RX,"A",JJ)) Q:'JJ  S CNT=JJ
"RTN","PSOSUTL",30,0)
 .S ^PS(52.5,"ADL",$E(PSOTIME,1,7),SFN)=""
"RTN","PSOSUTL",31,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(RX,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOSUTL",32,0)
 S CNT=CNT+1,^PSRX(RX,"A",0)="^52.3DA^"_CNT_"^"_CNT S ^PSRX(RX,"A",CNT,0)=DTTM_"^S^"_DUZ_"^"_$S($G(RXP):6,1:RFCNT)_"^"_COM
"RTN","PSOSUTL",33,0)
 S $P(^PS(52.5,SFN,0),"^",8)=PSOTIME,$P(^PS(52.5,SFN,0),"^",9)=PDUZ S:'$P(^PS(52.5,SFN,0),"^",6) $P(^PS(52.5,SFN,0),"^",6)=PSOSITE
"RTN","PSOSUTL",34,0)
 I PSOZZDMS D CPMSG
"RTN","PSOSUTL",35,0)
 Q
"RTN","PSOSUTL",36,0)
CPMSG ;
"RTN","PSOSUTL",37,0)
 N PSOZZDDD S PSOZZDDD="Label printed from suspense" D EN^PSOHLSN1(RX,"SC","ZU",PSOZZDDD) K PSOZZDDD
"RTN","PSOSUTL",38,0)
 Q
"RTN","PSOSUTL",39,0)
 ;
"RTN","PSOSUTL",40,0)
ARECD D NOW^%DTC S CNT=0,DTTM=% F JJ=0:0 S JJ=$O(^PSRX(RX,"A",JJ)) Q:'JJ  S CNT=JJ
"RTN","PSOSUTL",41,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(RX,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOSUTL",42,0)
 S RXP=$P(^PS(52.5,SFN,0),"^",5)
"RTN","PSOSUTL",43,0)
 S CNT=CNT+1,^PSRX(RX,"A",0)="^52.3DA^"_CNT_"^"_CNT S ^PSRX(RX,"A",CNT,0)=DTTM_"^C^"_DUZ_"^"_$S($G(RXP):6,1:RFCNT)_"^"_COM K RXP
"RTN","PSOSUTL",44,0)
 D EN^PSOHLSN1(RX,"OD","",COM,"A")
"RTN","PSOSUTL",45,0)
 Q
"RTN","PSOSUTL",46,0)
EX Q:'$G(RXREC)  D NOW^%DTC S PSCOU=0,DTTM=% F AAA=0:0 S AAA=$O(^PSRX(RXREC,"A",AAA)) Q:'AAA  S PSCOU=AAA
"RTN","PSOSUTL",47,0)
 S VVV=0 F QQQ=0:0 S QQQ=$O(^PSRX(RXREC,1,QQQ)) Q:'QQQ  S VVV=QQQ S:QQQ>5 VVV=QQQ+1
"RTN","PSOSUTL",48,0)
 S PSOPRT=$P(^PS(52.5,SFN,0),"^",5)
"RTN","PSOSUTL",49,0)
 S PSOEXPI="Expired while on suspense"
"RTN","PSOSUTL",50,0)
 S PSCOU=PSCOU+1,^PSRX(RXREC,"A",0)="^52.3DA^"_PSCOU_"^"_PSCOU S ^PSRX(RXREC,"A",PSCOU,0)=DTTM_"^S^"_DUZ_"^"_$S($G(PSOPRT):6,1:VVV)_"^"_PSOEXPI
"RTN","PSOSUTL",51,0)
 D EN^PSOHLSN1(RXREC,"SC","ZE",PSOEXPI)
"RTN","PSOSUTL",52,0)
 K PSCOU,AAA,QQQ,VVV,PSOPRT,PSOEXPI Q
"RTN","PSOSUTL",53,0)
SET ; Set DEA in Suspense File
"RTN","PSOSUTL",54,0)
 N PSOSUDEA
"RTN","PSOSUTL",55,0)
 Q:'$G(X)  Q:'$D(^PSRX(X,0))
"RTN","PSOSUTL",56,0)
 S PSOSUDEA=$P($G(^PSRX(X,0)),"^",6) I PSOSUDEA,$D(^PSDRUG(PSOSUDEA,0)) S $P(^PS(52.5,DA,0),"^",10)=$P(^PSDRUG(PSOSUDEA,0),"^",3)
"RTN","PSOSUTL",57,0)
 Q
"RTN","PSOSUTL",58,0)
KILL Q:'$G(DA)  Q:'$D(^PS(52.5,DA,0))
"RTN","PSOSUTL",59,0)
 S $P(^PS(52.5,DA,0),"^",10)=""
"RTN","PSOSUTL",60,0)
 Q
"RTN","PSOSUTL",61,0)
SAS ;X-ref on Division field
"RTN","PSOSUTL",62,0)
 N PSOC7,PSUSPIEN S PSUSPIEN=$O(^PS(52.5,"B",DA,0)) I PSUSPIEN,$D(^PS(52.5,PSUSPIEN,0)),'$P($G(^(0)),"^",5),'$O(^PSRX(DA,1,0)) D
"RTN","PSOSUTL",63,0)
 .S PSOC7=$P($G(^PS(52.5,PSUSPIEN,0)),"^",7)
"RTN","PSOSUTL",64,0)
 .S $P(^PS(52.5,PSUSPIEN,0),"^",6)=X S:$P(^PS(52.5,PSUSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P($G(^(0)),"^",7)="") ^PS(52.5,"AS",$P(^PS(52.5,PSUSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSUSPIEN)=""
"RTN","PSOSUTL",65,0)
 .S $P(^PS(52.5,PSUSPIEN,0),"^",6)=X S:$P(^PS(52.5,PSUSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P($G(^(0)),"^",7)="P") ^PS(52.5,"APR",$P(^PS(52.5,PSUSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSUSPIEN)=""
"RTN","PSOSUTL",66,0)
 .K:$P(^PS(52.5,PSUSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P($G(^(0)),"^",7)="P") ^PS(52.5,"AS",$P(^PS(52.5,PSUSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSUSPIEN)
"RTN","PSOSUTL",67,0)
 .I PSOC7'="" D SCMPX^PSOCMOP(PSUSPIEN,PSOC7)
"RTN","PSOSUTL",68,0)
 Q
"RTN","PSOSUTL",69,0)
KAS ;
"RTN","PSOSUTL",70,0)
 N PSUSPIEN,PSOC7 S PSUSPIEN=$O(^PS(52.5,"B",DA,0)) I PSUSPIEN,$D(^PS(52.5,PSUSPIEN,0)),'$P($G(^(0)),"^",5),'$O(^PSRX(DA,1,0)) D
"RTN","PSOSUTL",71,0)
 .K:$P(^PS(52.5,PSUSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P(^(0),"^",7)="") ^PS(52.5,"AS",$P(^PS(52.5,PSUSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSUSPIEN)
"RTN","PSOSUTL",72,0)
 .K:$P(^PS(52.5,PSUSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P(^(0),"^",7)="P") ^PS(52.5,"APR",$P(^PS(52.5,PSUSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSUSPIEN)
"RTN","PSOSUTL",73,0)
 .S PSOC7=$P($G(^PS(52.5,PSUSPIEN,0)),"^",7)
"RTN","PSOSUTL",74,0)
 .I PSOC7'="" D KCMPX^PSOCMOP(PSUSPIEN,PSOC7)
"RTN","PSOSUTL",75,0)
 Q
"RTN","PSOSUTL",76,0)
SAS1 ;Refill Division x-ref
"RTN","PSOSUTL",77,0)
 N PSOSPIEN,ZZZ,PSREFCNT,PSOC7 S PSOSPIEN=$O(^PS(52.5,"B",DA(1),0)) I PSOSPIEN,$D(^PS(52.5,PSOSPIEN,0)),'$P($G(^(0)),"^",5),$O(^PSRX(DA(1),1,0)) D
"RTN","PSOSUTL",78,0)
 .S PSOC7=$P($G(^PS(52.5,PSOSPIEN,0)),"^",7)
"RTN","PSOSUTL",79,0)
 .S PSREFCNT=0 F ZZZ=0:0 S ZZZ=$O(^PSRX(DA(1),1,ZZZ)) Q:'ZZZ  S PSREFCNT=PSREFCNT+1
"RTN","PSOSUTL",80,0)
 .I PSREFCNT=DA S $P(^PS(52.5,PSOSPIEN,0),"^",6)=X D
"RTN","PSOSUTL",81,0)
 ..S:$P(^PS(52.5,PSOSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P($G(^(0)),"^",7)="") ^PS(52.5,"AS",$P(^PS(52.5,PSOSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSOSPIEN)=""
"RTN","PSOSUTL",82,0)
 ..S:$P(^PS(52.5,PSOSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P($G(^(0)),"^",7)="P") ^PS(52.5,"APR",$P(^PS(52.5,PSOSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSOSPIEN)=""
"RTN","PSOSUTL",83,0)
 ..K:$P(^PS(52.5,PSOSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P($G(^(0)),"^",7)="P") ^PS(52.5,"AS",$P(^PS(52.5,PSOSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSOSPIEN)
"RTN","PSOSUTL",84,0)
 ..I PSOC7'="" D SCMPX^PSOCMOP(PSOSPIEN,PSOC7)
"RTN","PSOSUTL",85,0)
 Q
"RTN","PSOSUTL",86,0)
KAS1 ;
"RTN","PSOSUTL",87,0)
 N PSOSPIEN,ZZZ,PSREFCNT,PSOC7 S PSOSPIEN=$O(^PS(52.5,"B",DA(1),0)) I PSOSPIEN,$D(^PS(52.5,PSOSPIEN,0)),'$P($G(^(0)),"^",5),$O(^PSRX(DA(1),1,0)) D
"RTN","PSOSUTL",88,0)
 .S PSREFCNT=0 F ZZZ=0:0 S ZZZ=$O(^PSRX(DA(1),1,ZZZ)) Q:'ZZZ  S PSREFCNT=PSREFCNT+1
"RTN","PSOSUTL",89,0)
 .I PSREFCNT=DA D
"RTN","PSOSUTL",90,0)
 ..K:$P(^PS(52.5,PSOSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P(^(0),"^",7)="") ^PS(52.5,"AS",$P(^PS(52.5,PSOSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSOSPIEN)
"RTN","PSOSUTL",91,0)
 ..K:$P(^PS(52.5,PSOSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P(^(0),"^",7)="P") ^PS(52.5,"APR",$P(^PS(52.5,PSOSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSOSPIEN)
"RTN","PSOSUTL",92,0)
 ..S PSOC7=$P($G(^PS(52.5,PSOSPIEN,0)),"^",7)
"RTN","PSOSUTL",93,0)
 ..I PSOC7'="" D KCMPX^PSOCMOP(PSOSPIEN,PSOC7)
"RTN","PSOSUTL",94,0)
 Q
"RTN","PSOSUTL",95,0)
SAS2 ;For partials
"RTN","PSOSUTL",96,0)
 N PSPSPIEN S PSPSPIEN=$O(^PS(52.5,"B",DA(1),0)) I PSPSPIEN,$D(^PS(52.5,PSPSPIEN,0)),$P($G(^(0)),"^",5) D
"RTN","PSOSUTL",97,0)
 .I DA=$P(^PS(52.5,PSPSPIEN,0),"^",5) S $P(^(0),"^",6)=X D
"RTN","PSOSUTL",98,0)
 ..S:$P(^PS(52.5,PSPSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P($G(^(0)),"^",7)="") ^PS(52.5,"AS",$P(^PS(52.5,PSPSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSPSPIEN)=""
"RTN","PSOSUTL",99,0)
 ..S:$P(^PS(52.5,PSPSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P($G(^(0)),"^",7)="P") ^PS(52.5,"APR",$P(^PS(52.5,PSPSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSPSPIEN)=""
"RTN","PSOSUTL",100,0)
 ..K:$P(^PS(52.5,PSPSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P($G(^(0)),"^",7)="P") ^PS(52.5,"AS",$P(^PS(52.5,PSPSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSPSPIEN)
"RTN","PSOSUTL",101,0)
 Q
"RTN","PSOSUTL",102,0)
KAS2 ;
"RTN","PSOSUTL",103,0)
 N PSPSPIEN S PSPSPIEN=$O(^PS(52.5,"B",DA(1),0)) I PSPSPIEN,$D(^PS(52.5,PSPSPIEN,0)),$P($G(^(0)),"^",5) D
"RTN","PSOSUTL",104,0)
 .I DA=$P(^PS(52.5,PSPSPIEN,0),"^",5) D
"RTN","PSOSUTL",105,0)
 ..K:$P(^PS(52.5,PSPSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P(^(0),"^",7)="") ^PS(52.5,"AS",$P(^PS(52.5,PSPSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSPSPIEN)
"RTN","PSOSUTL",106,0)
 ..K:$P(^PS(52.5,PSPSPIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",11))&($P(^(0),"^",7)="P") ^PS(52.5,"APR",$P(^PS(52.5,PSPSPIEN,0),"^",8),$P(^(0),"^",9),X,$P(^(0),"^",11),PSPSPIEN)
"RTN","PSOSUTL",107,0)
 Q
"RTN","PSOSUTL",108,0)
SDEA ;Update Suspense with DEA
"RTN","PSOSUTL",109,0)
 N PSSSPIEN S PSSSPIEN=$O(^PS(52.5,"B",DA,0)) Q:'$G(PSSSPIEN)
"RTN","PSOSUTL",110,0)
 I $D(^PS(52.5,PSSSPIEN,0)),$P($G(^("P")),"^")=0 S $P(^PS(52.5,PSSSPIEN,0),"^",10)=$P($G(^PSDRUG(+X,0)),"^",3)
"RTN","PSOSUTL",111,0)
 Q
"RTN","PSOSUTL",112,0)
SDIV N PSODINT,PSDVP,PSLOOP
"RTN","PSOSUTL",113,0)
 S PSODINT=+$P($G(^PS(52.5,DA,0)),"^") Q:'PSODINT
"RTN","PSOSUTL",114,0)
 S PSDVP=$P($G(^PS(52.5,DA,0)),"^",5) I PSDVP D  Q
"RTN","PSOSUTL",115,0)
 .S:$D(^PSRX(PSODINT,"P",+PSDVP,0)) $P(^(0),"^",9)=X
"RTN","PSOSUTL",116,0)
 S PSDVP=0 F PSLOOP=0:0 S PSLOOP=$O(^PSRX(PSODINT,1,PSLOOP)) Q:'PSLOOP  S PSDVP=PSLOOP
"RTN","PSOSUTL",117,0)
 I PSDVP S:$D(^PSRX(PSODINT,1,PSDVP,0)) $P(^(0),"^",9)=X Q
"RTN","PSOSUTL",118,0)
 S:$D(^PSRX(PSODINT,2)) $P(^(2),"^",9)=X
"RTN","PSOSUTL",119,0)
 Q
"RTN","PSOSUTL",120,0)
ZZ(RX) ; Returns VA print name, Trade Name, Generic Name
"RTN","PSOSUTL",121,0)
 S I50=$P(^PSRX(RX,0),U,6),ZDRUG=$P(^PSDRUG(I50,0),U)
"RTN","PSOSUTL",122,0)
 I $G(ZDRUG)']"" S ZDRUG="DRUG NOT ON FILE ("_I50_")" G END
"RTN","PSOSUTL",123,0)
 I $G(^PSRX(RX,"TN"))]"" S ZDRUG=^("TN") G END
"RTN","PSOSUTL",124,0)
 I $D(^PSDRUG("AQ",I50)),($D(^PSDRUG(I50,"ND"))) D
"RTN","PSOSUTL",125,0)
 .S Z1=$P($G(^PSDRUG(I50,"ND")),U),Z2=$P($G(^("ND")),U,3)
"RTN","PSOSUTL",126,0)
 .I $G(Z1),($G(Z2)) D
"RTN","PSOSUTL",127,0)
 ..I $T(^PSNAPIS)]"" S PSOXN=$$PROD2^PSNAPIS(Z1,Z2) S ZDRUG=$P($G(PSOXN),"^") K PSOXN Q
"RTN","PSOSUTL",128,0)
 ..S ZDRUG=$P($G(^PSNDF(Z1,5,Z2,2)),"^")
"RTN","PSOSUTL",129,0)
 .K Z1,Z2,I50
"RTN","PSOSUTL",130,0)
END K I50
"RTN","PSOSUTL",131,0)
 Q ZDRUG
"RTN","PSOVDF1")
0^1^B87117915^B67244261
"RTN","PSOVDF1",1,0)
PSOVDF1 ;BPOIFO/EL-OUTPATIENT PHARMACY (PRES, PREF, PPAR) HL7 MESSAGE ;10/04/04
"RTN","PSOVDF1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**190,205,220,235**;DEC 1997
"RTN","PSOVDF1",3,0)
 ;
"RTN","PSOVDF1",4,0)
VALID ;;VDEF HL7 MESSAGE BUILDER
"RTN","PSOVDF1",5,0)
 ;
"RTN","PSOVDF1",6,0)
 ; DBIA #4248 - $$XCN200^VDEFEL (or <MultipleTag>^VDEFEL)
"RTN","PSOVDF1",7,0)
 ; DBIA #3552 - $$PARAM^HLCS2
"RTN","PSOVDF1",8,0)
 ; DBIA #3630 - BLDPID^VAFCQRY
"RTN","PSOVDF1",9,0)
 ; DBIA #10040 - 0-NODE of ^SC
"RTN","PSOVDF1",10,0)
 ; DBIA 4571 - ERR^VDEFREQ
"RTN","PSOVDF1",11,0)
 ;
"RTN","PSOVDF1",12,0)
 ; 
"RTN","PSOVDF1",13,0)
 ; This routine is called at tag EN as a Function by VDEFREQ1
"RTN","PSOVDF1",14,0)
 ;
"RTN","PSOVDF1",15,0)
 Q
"RTN","PSOVDF1",16,0)
 ;
"RTN","PSOVDF1",17,0)
EN(EVIEN,KEY,VFLAG,OUT,MSHP) ;
"RTN","PSOVDF1",18,0)
 ; This routine creates one of three Outpatient Pharmacy HL7 messages:
"RTN","PSOVDF1",19,0)
 ; RDE^O11^PRES, RDS^O13^PREF, or RDS^O13^PPAR
"RTN","PSOVDF1",20,0)
 ;
"RTN","PSOVDF1",21,0)
 ; Input Parameters:
"RTN","PSOVDF1",22,0)
 ;    EVIEN - IEN of message in file 577
"RTN","PSOVDF1",23,0)
 ;    KEY -   IEN to File #52 ^PSRX
"RTN","PSOVDF1",24,0)
 ;    VFLAG - "V" for VistA HL7 destination (default)
"RTN","PSOVDF1",25,0)
 ;    OUT -   Target array.  Must be passed by reference
"RTN","PSOVDF1",26,0)
 ;    MSHP -  4th piece is SUBTYPE (PRES, PREF, PPAR)
"RTN","PSOVDF1",27,0)
 ;
"RTN","PSOVDF1",28,0)
 ; Returns:
"RTN","PSOVDF1",29,0)
 ;    Two piece string with separator '^':
"RTN","PSOVDF1",30,0)
 ;    Piece 1 - "LM" - LOCAL ARRAY
"RTN","PSOVDF1",31,0)
 ;    Piece 2 - MSH segment, is not set
"RTN","PSOVDF1",32,0)
 ;    OUT - OUTPUT array includes HL7 message for every segment except MSH
"RTN","PSOVDF1",33,0)
 ;              
"RTN","PSOVDF1",34,0)
 ;  Message Body "MSH,PID,ORC1,RXE1,RXR1,FT1,OBX1,NTE1,ORC2,ORC3"
"RTN","PSOVDF1",35,0)
 ;  The Pharmacy Original Fill message will be generated by pgm:PSOVDF2 - (ORC1. . NTE1)
"RTN","PSOVDF1",36,0)
 ;
"RTN","PSOVDF1",37,0)
 ;
"RTN","PSOVDF1",38,0)
 N CTR,PSOVDFD0,PSOVDFD1,DFN,DRCODE,PSOVDRUG,ERR,FILE,FIELD,GIVECODE,GL,GLOB,GLOBAL,HLINST,PSOVDDIV,PSOVD59,PSOVERR
"RTN","PSOVDF1",39,0)
 N I,L,MSG,NTE,P,RES,SEPC,SEPE,SEPF,SEPR,SEPS,SRC,SUBTYPE,TARGET,PSOVDFES,PSOVESC,PSOVDFIN
"RTN","PSOVDF1",40,0)
 N HL7DEL,REPSEPC,REPSEPE,REPSEPF,REPSEPR,REPSEPS,TEMP,TP,UNIT,VAL,WR,X,Y,Z
"RTN","PSOVDF1",41,0)
 ;
"RTN","PSOVDF1",42,0)
 S (ERR,TARGET)=""
"RTN","PSOVDF1",43,0)
 D INIT
"RTN","PSOVDF1",44,0)
 I $G(ERR)'="" D ERR^VDEFREQ(ERR) S ZTSTOP=1 G QUIT
"RTN","PSOVDF1",45,0)
 D MSHPID
"RTN","PSOVDF1",46,0)
 I $G(ERR)'="" D ERR^VDEFREQ(ERR) S ZTSTOP=1 G QUIT
"RTN","PSOVDF1",47,0)
 D PROCESS^PSOVDF2
"RTN","PSOVDF1",48,0)
 D ORC2
"RTN","PSOVDF1",49,0)
QUIT Q TARGET
"RTN","PSOVDF1",50,0)
 ;
"RTN","PSOVDF1",51,0)
INIT ; INITIALIZATION
"RTN","PSOVDF1",52,0)
 K GL,OUT,TEMP,TP
"RTN","PSOVDF1",53,0)
 S (PSOVDFD0,PSOVDFES,DFN,DRCODE,PSOVDRUG,FILE,GIVECODE,GLOB,SEPC,SEPE,SEPF,SEPR,SEPS,SRC,SUBTYPE,UNIT,VAL)=""
"RTN","PSOVDF1",54,0)
 S (HL7DEL,REPSEPC,REPSEPE,REPSEPF,REPSEPR,REPSEPS)=""
"RTN","PSOVDF1",55,0)
 S OUT("HLS")=0
"RTN","PSOVDF1",56,0)
 S PSOVDFD0=KEY
"RTN","PSOVDF1",57,0)
 I $G(U)'="^" S U="^"
"RTN","PSOVDF1",58,0)
 S FILE=52
"RTN","PSOVDF1",59,0)
 S SUBTYPE=$P($G(MSHP),"~",4)
"RTN","PSOVDF1",60,0)
 S VAL=$G(HL("ECH")) I VAL="" S VAL="~|\&",HL("ECH")=VAL
"RTN","PSOVDF1",61,0)
 S SEPE=$E(VAL,3),REPSEPE=SEPE_"E"_SEPE
"RTN","PSOVDF1",62,0)
 S SEPC=$E(VAL,1),REPSEPC=SEPE_"S"_SEPE
"RTN","PSOVDF1",63,0)
 S SEPR=$E(VAL,2),REPSEPR=SEPE_"R"_SEPE
"RTN","PSOVDF1",64,0)
 S SEPS=$E(VAL,4),REPSEPS=SEPE_"T"_SEPE
"RTN","PSOVDF1",65,0)
 S VAL=$G(HL("FS")) I VAL="" S VAL="^",HL("FS")=VAL
"RTN","PSOVDF1",66,0)
 S SEPF=$E(VAL,1),REPSEPF=SEPE_"F"_SEPE
"RTN","PSOVDF1",67,0)
 S HL7DEL=$G(HL("ECH"))_$G(HL("FS"))
"RTN","PSOVDF1",68,0)
 S GLOB=$$ROOT^DILFD(FILE)_PSOVDFD0_")"
"RTN","PSOVDF1",69,0)
 M GL=@GLOB
"RTN","PSOVDF1",70,0)
 S DFN=$P($G(GL(0)),U,2)
"RTN","PSOVDF1",71,0)
 I $G(DFN)="" S ERR="MISSING DFN IN FILE-52 AT IEN="_PSOVDFD0 Q
"RTN","PSOVDF1",72,0)
 I $G(^DPT(DFN,0))="" S ERR="MISSING DFN IN FILE-2 AT FILE-52/IEN="_PSOVDFD0 Q
"RTN","PSOVDF1",73,0)
 S PSOVDFES=$$REPL(PSOVDFD0)
"RTN","PSOVDF1",74,0)
 S PSOVDFIN=$$SITE^VASITE,PSOVDFIN=$P($G(PSOVDFIN),"^",2),PSOVDFIN=$$REPL(PSOVDFIN)
"RTN","PSOVDF1",75,0)
 Q
"RTN","PSOVDF1",76,0)
 ;
"RTN","PSOVDF1",77,0)
PUT(P) ; Put in MSG
"RTN","PSOVDF1",78,0)
 I $G(VAL)="" Q
"RTN","PSOVDF1",79,0)
 S $P(MSG,SEPF,P)=VAL
"RTN","PSOVDF1",80,0)
 Q
"RTN","PSOVDF1",81,0)
 ;
"RTN","PSOVDF1",82,0)
REPL(L) ; REPLACE HL7 DELIMITER CHAR
"RTN","PSOVDF1",83,0)
 I $G(L)="" Q ""
"RTN","PSOVDF1",84,0)
 I $TR(L,$G(HL7DEL))=L Q L
"RTN","PSOVDF1",85,0)
 N X,Y,Z,RES
"RTN","PSOVDF1",86,0)
 S RES=L
"RTN","PSOVDF1",87,0)
 I $F(L,SEPE) S X=RES D
"RTN","PSOVDF1",88,0)
 . S Z=$P(X,SEPE,2,9999),Y=$P(X,SEPE)_REPSEPE_Z,RES=Y,X=Z I '$F(Z,SEPE) Q
"RTN","PSOVDF1",89,0)
 . F I=2:1 S Z=$P(X,SEPE,2,9999),Y=$P(RES,REPSEPE,1,I-1)_REPSEPE_$P(X,SEPE)_REPSEPE_Z,RES=Y,X=Z I '$F(Z,SEPE) Q
"RTN","PSOVDF1",90,0)
 ;
"RTN","PSOVDF1",91,0)
 I $F(RES,SEPC) F I=1:1 S Y=$P(RES,SEPC)_REPSEPC_$P(RES,SEPC,2,9999),RES=Y I '$F(RES,SEPC) Q
"RTN","PSOVDF1",92,0)
 I $F(RES,SEPR) F I=1:1 S Y=$P(RES,SEPR)_REPSEPR_$P(RES,SEPR,2,9999),RES=Y I '$F(RES,SEPR) Q
"RTN","PSOVDF1",93,0)
 I $F(RES,SEPS) F I=1:1 S Y=$P(RES,SEPS)_REPSEPS_$P(RES,SEPS,2,9999),RES=Y I '$F(RES,SEPS) Q
"RTN","PSOVDF1",94,0)
 I $F(RES,SEPF) F I=1:1 S Y=$P(RES,SEPF)_REPSEPF_$P(RES,SEPF,2,9999),RES=Y I '$F(RES,SEPF) Q
"RTN","PSOVDF1",95,0)
 Q RES
"RTN","PSOVDF1",96,0)
 ;
"RTN","PSOVDF1",97,0)
 ;
"RTN","PSOVDF1",98,0)
OUT D OUT^PSOVDF2 Q
"RTN","PSOVDF1",99,0)
OUT20 D OUT20^PSOVDF2 Q
"RTN","PSOVDF1",100,0)
 ;
"RTN","PSOVDF1",101,0)
MSHPID ;
"RTN","PSOVDF1",102,0)
MSH ; MSH
"RTN","PSOVDF1",103,0)
 S (HLINST,MSG,SRC)=""
"RTN","PSOVDF1",104,0)
 I '$D(SITEPARM) S SITEPARM=$$PARAM^HLCS2
"RTN","PSOVDF1",105,0)
 S HLINST=$P(SITEPARM,U,6),HLINST=$$REPL(HLINST),SRC=HLINST_"_"_FILE
"RTN","PSOVDF1",106,0)
 S TARGET="LM"_SEPF_MSG
"RTN","PSOVDF1",107,0)
 ;
"RTN","PSOVDF1",108,0)
PID ; PID
"RTN","PSOVDF1",109,0)
 K WR
"RTN","PSOVDF1",110,0)
 S (MSG)=""
"RTN","PSOVDF1",111,0)
 D BLDPID^VAFCQRY(DFN,1,"",.WR,.HL,.ERR)
"RTN","PSOVDF1",112,0)
 I $G(WR(1))="" S ERR="MISSING PID AT DFN="_DFN_" IN FILE-52 AT IEN="_PSOVDFD0 Q
"RTN","PSOVDF1",113,0)
 I $P(WR(1),U,3)="V" S $P(WR(1),U,3)=""
"RTN","PSOVDF1",114,0)
 D OUT20
"RTN","PSOVDF1",115,0)
 K WR
"RTN","PSOVDF1",116,0)
 Q
"RTN","PSOVDF1",117,0)
 ;
"RTN","PSOVDF1",118,0)
ORC2 ; REFILL
"RTN","PSOVDF1",119,0)
 I '$D(GL(1)) G ORC3
"RTN","PSOVDF1",120,0)
 K TEMP M TEMP=GL(1)
"RTN","PSOVDF1",121,0)
 S PSOVDFD1=0
"RTN","PSOVDF1",122,0)
ORC2A S PSOVDFD1=$O(TEMP(PSOVDFD1)) G ORC3:'PSOVDFD1
"RTN","PSOVDF1",123,0)
 S MSG=""
"RTN","PSOVDF1",124,0)
 S TP=$G(TEMP(PSOVDFD1,0)) I TP="" G ORC2A
"RTN","PSOVDF1",125,0)
 S PSOVESC=$$REPL(PSOVDFD1),VAL=PSOVESC D PUT(3)
"RTN","PSOVDF1",126,0)
 ; (7~4-10.1)
"RTN","PSOVDF1",127,0)
 S (VAL,WR)="",WR=$P(TP,U,19) I $G(WR)'="" D
"RTN","PSOVDF1",128,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL(WR),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="DISPENSED"
"RTN","PSOVDF1",129,0)
 ; (7~5-13)
"RTN","PSOVDF1",130,0)
 S WR=$P(TP,U,15) I $G(WR)'="" D
"RTN","PSOVDF1",131,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL(WR),$P(VAL,SEPC,5)=WR,$P(VAL,SEPC,7)=$P(VAL,SEPC,7)_"/EXPIRATION"
"RTN","PSOVDF1",132,0)
 D PUT(7)
"RTN","PSOVDF1",133,0)
 S VAL="",$P(VAL,SEPC,2)=PSOVDFES D PUT(8)
"RTN","PSOVDF1",134,0)
 ; (9-7)
"RTN","PSOVDF1",135,0)
 S VAL=$P(TP,U,8) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL(VAL) D PUT(9)
"RTN","PSOVDF1",136,0)
 ; (12-15)
"RTN","PSOVDF1",137,0)
 S VAL=$P(TP,U,17) I $G(VAL)'="" S VAL=$$XCN200^VDEFEL(VAL) D PUT(12)
"RTN","PSOVDF1",138,0)
 S VAL="REFILL" D PUT(16)
"RTN","PSOVDF1",139,0)
 S VAL=$P(TP,U,9) S:$G(VAL)="" VAL=$P($G(^PSRX(PSOVDFD0,2)),"^",9) I $G(VAL)'="" D
"RTN","PSOVDF1",140,0)
 .S PSOVD59=VAL I $D(PSOVDDIV(VAL)) S VAL=$G(PSOVDDIV(VAL)) S $P(VAL,SEPC,3)=$P($P(VAL,SEPC,3),"_")_"_52.1_8" D PUT(17) Q
"RTN","PSOVDF1",141,0)
 .N PSONCRF,PSONCRFP,PSOSTNUM
"RTN","PSOVDF1",142,0)
 .S X=$G(^PS(59,VAL,0)),PSONCRFP=$P($G(^("SAND")),"^",3)
"RTN","PSOVDF1",143,0)
 .S VAL=$P(X,U),(VAL,PSONCRF)=$$REPL(VAL) Q:VAL=""
"RTN","PSOVDF1",144,0)
 .S PSOSTNUM=$P(X,U,6),PSOSTNUM=$$REPL(PSOSTNUM)
"RTN","PSOVDF1",145,0)
 .S VAL=PSOSTNUM_SEPC_VAL_SEPC_HLINST_"_52.1_8"
"RTN","PSOVDF1",146,0)
 .I PSONCRFP'="" S PSONCRFP=$$REPL(PSONCRFP),VAL=VAL_SEPC_PSONCRFP_SEPC_PSONCRF_SEPC_"NCPDP"
"RTN","PSOVDF1",147,0)
 .S PSOVDDIV(PSOVD59)=$G(VAL)
"RTN","PSOVDF1",148,0)
 .D PUT(17)
"RTN","PSOVDF1",149,0)
 S VAL=$G(PSOVDFIN) D PUT(21)
"RTN","PSOVDF1",150,0)
 ;
"RTN","PSOVDF1",151,0)
 I $G(MSG)="" G ORC2Q
"RTN","PSOVDF1",152,0)
 S $P(MSG,U)="RF"
"RTN","PSOVDF1",153,0)
 S MSG="ORC"_SEPF_MSG D OUT
"RTN","PSOVDF1",154,0)
ORC2Q ; Q
"RTN","PSOVDF1",155,0)
 ;
"RTN","PSOVDF1",156,0)
RXE2 ; REFILL
"RTN","PSOVDF1",157,0)
 S MSG=""
"RTN","PSOVDF1",158,0)
 ; (1~4-.01)
"RTN","PSOVDF1",159,0)
 S (VAL,WR)="",WR=$P(TP,U,1) I $G(WR)'="" D
"RTN","PSOVDF1",160,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL(WR),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="REFILL" D PUT(1)
"RTN","PSOVDF1",161,0)
 ; (2~1..~3-6, 2~4-API , 2~6-NDC)
"RTN","PSOVDF1",162,0)
 S VAL=""
"RTN","PSOVDF1",163,0)
 I $T(NDC^PSOHDR)]"" D
"RTN","PSOVDF1",164,0)
 .S VAL=$$NDC^PSOHDR(PSOVDFD0,PSOVDFD1,"R")
"RTN","PSOVDF1",165,0)
 E  S VAL=$P($G(TEMP(PSOVDFD1,1)),U,3) D
"RTN","PSOVDF1",166,0)
 .I $G(VAL)="",$G(PSOVDRUG)'="" S VAL=$P($G(^PSDRUG(PSOVDRUG,2)),"^",4)
"RTN","PSOVDF1",167,0)
 I $G(VAL)'="" D
"RTN","PSOVDF1",168,0)
 .S VAL=$$REPL(VAL)
"RTN","PSOVDF1",169,0)
 .S X="",X=GIVECODE,$P(X,SEPC,4)=VAL,$P(X,SEPC,6)="NDC",VAL=X D PUT(2)
"RTN","PSOVDF1",170,0)
 E  S VAL=GIVECODE D PUT(2)
"RTN","PSOVDF1",171,0)
 S VAL=0 D PUT(3)
"RTN","PSOVDF1",172,0)
 ; (5-DEF="UNK" or API)
"RTN","PSOVDF1",173,0)
 S VAL=UNIT D PUT(5)
"RTN","PSOVDF1",174,0)
 ; (8~6-2)
"RTN","PSOVDF1",175,0)
 S (VAL,WR)=""
"RTN","PSOVDF1",176,0)
 S WR=$$GET1^DIQ(52.1,PSOVDFD1_","_PSOVDFD0_",",2,"","","PSOVERR") K PSOVERR I $G(WR)'="" S WR=$$REPL(WR),$P(VAL,SEPC,6)=WR D PUT(8)
"RTN","PSOVDF1",177,0)
 ; (10-1)
"RTN","PSOVDF1",178,0)
 S VAL=$P(TP,U,4),VAL=$$REPL(VAL) D PUT(10)
"RTN","PSOVDF1",179,0)
 ; (14|1-4)
"RTN","PSOVDF1",180,0)
 S VAL=$P(TP,U,5) I $G(VAL)="" G RXE2A
"RTN","PSOVDF1",181,0)
 S VAL=$$XCN200^VDEFEL(VAL,"PHARMACIST") D PUT(14)
"RTN","PSOVDF1",182,0)
 ; (18-17)
"RTN","PSOVDF1",183,0)
RXE2A S VAL=$P(TP,U,18) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL(VAL) D PUT(18)
"RTN","PSOVDF1",184,0)
 ; (22-1.1)
"RTN","PSOVDF1",185,0)
 S VAL=$P(TP,U,10) I $G(VAL)'="" S VAL="D"_VAL,VAL=$$REPL(VAL) D PUT(22)
"RTN","PSOVDF1",186,0)
 ;
"RTN","PSOVDF1",187,0)
 I $G(MSG)="" G RXE2Q
"RTN","PSOVDF1",188,0)
 S MSG="RXE"_SEPF_MSG D OUT
"RTN","PSOVDF1",189,0)
RXE2Q ; Q
"RTN","PSOVDF1",190,0)
 ;
"RTN","PSOVDF1",191,0)
NTE2 ; REFILL
"RTN","PSOVDF1",192,0)
 S MSG=""
"RTN","PSOVDF1",193,0)
 ; (3-52.1_3)
"RTN","PSOVDF1",194,0)
 S VAL=$P(TP,U,3) I $G(VAL)="" G NTE2Q
"RTN","PSOVDF1",195,0)
 S VAL=$$REPL(VAL)
"RTN","PSOVDF1",196,0)
 D PUT(3)
"RTN","PSOVDF1",197,0)
 S VAL="RE"_SEPC_"REMARKS" D PUT(4)
"RTN","PSOVDF1",198,0)
 S MSG="NTE"_SEPF_MSG D OUT
"RTN","PSOVDF1",199,0)
NTE2Q G ORC2A
"RTN","PSOVDF1",200,0)
 ;
"RTN","PSOVDF1",201,0)
ORC3 ; PARTIAL       
"RTN","PSOVDF1",202,0)
 I '$D(GL("P")) Q
"RTN","PSOVDF1",203,0)
 K TEMP M TEMP=GL("P")
"RTN","PSOVDF1",204,0)
 S PSOVDFD1=0
"RTN","PSOVDF1",205,0)
ORC3A S PSOVDFD1=$O(TEMP(PSOVDFD1)) Q:'PSOVDFD1
"RTN","PSOVDF1",206,0)
 S MSG=""
"RTN","PSOVDF1",207,0)
 S TP=$G(TEMP(PSOVDFD1,0)) I TP="" G ORC3A
"RTN","PSOVDF1",208,0)
 S PSOVESC=$$REPL(PSOVDFD1),VAL=PSOVESC D PUT(3)
"RTN","PSOVDF1",209,0)
 ; (7~4-7.5)
"RTN","PSOVDF1",210,0)
 S WR=$P(TP,U,13) I $G(WR)'="" D
"RTN","PSOVDF1",211,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL(WR),VAL="",$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="DISPENSED" D PUT(7)
"RTN","PSOVDF1",212,0)
 S VAL="",$P(VAL,SEPC,2)=PSOVDFES D PUT(8)
"RTN","PSOVDF1",213,0)
 ; (9-.08)
"RTN","PSOVDF1",214,0)
 S VAL=$P(TP,U,8) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL(VAL) D PUT(9)
"RTN","PSOVDF1",215,0)
 ; (12-6)
"RTN","PSOVDF1",216,0)
 S VAL=$P(TP,U,17) I $G(VAL)'="" S VAL=$$XCN200^VDEFEL(VAL) D PUT(12)
"RTN","PSOVDF1",217,0)
 S VAL="PARTIAL" D PUT(16)
"RTN","PSOVDF1",218,0)
 S VAL=$P(TP,U,9) S:$G(VAL)="" VAL=$P($G(^PSRX(PSOVDFD0,2)),"^",9) I $G(VAL)'="" D
"RTN","PSOVDF1",219,0)
 .S PSOVD59=VAL I $D(PSOVDDIV(VAL)) S VAL=$G(PSOVDDIV(VAL)) S $P(VAL,SEPC,3)=$P($P(VAL,SEPC,3),"_")_"_52.2_.09" D PUT(17) Q
"RTN","PSOVDF1",220,0)
 .N PSONCPR,PSONCPRP,PSOSPNUM
"RTN","PSOVDF1",221,0)
 .S X=$G(^PS(59,VAL,0)),PSONCPRP=$P($G(^("SAND")),"^",3)
"RTN","PSOVDF1",222,0)
 .S VAL=$P(X,U),(VAL,PSONCPR)=$$REPL(VAL) Q:VAL=""
"RTN","PSOVDF1",223,0)
 .S PSOSPNUM=$P(X,U,6),PSOSPNUM=$$REPL(PSOSPNUM)
"RTN","PSOVDF1",224,0)
 .S VAL=PSOSPNUM_SEPC_VAL_SEPC_HLINST_"_52.2_.09"
"RTN","PSOVDF1",225,0)
 .I PSONCPRP'="" S PSONCPRP=$$REPL(PSONCPRP),VAL=VAL_SEPC_PSONCPRP_SEPC_PSONCPR_SEPC_"NCPDP"
"RTN","PSOVDF1",226,0)
 .S PSOVDDIV(PSOVD59)=$G(VAL)
"RTN","PSOVDF1",227,0)
 .D PUT(17)
"RTN","PSOVDF1",228,0)
 S VAL=$G(PSOVDFIN) D PUT(21)
"RTN","PSOVDF1",229,0)
 ;
"RTN","PSOVDF1",230,0)
 I $G(MSG)="" G ORC3Q
"RTN","PSOVDF1",231,0)
 S $P(MSG,U)="RF"
"RTN","PSOVDF1",232,0)
 S MSG="ORC"_SEPF_MSG D OUT
"RTN","PSOVDF1",233,0)
ORC3Q ; Q
"RTN","PSOVDF1",234,0)
 ;
"RTN","PSOVDF1",235,0)
RXE3 ; PARTIAL
"RTN","PSOVDF1",236,0)
 S MSG=""
"RTN","PSOVDF1",237,0)
 ; (1~4-.01)
"RTN","PSOVDF1",238,0)
 S WR=$P(TP,U,1) I $G(WR)'="" D
"RTN","PSOVDF1",239,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL(WR),VAL="",$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="PARTIAL" D PUT(1)
"RTN","PSOVDF1",240,0)
 ; (2~1..~3-6, 2~4-API, 2~6-NDC)
"RTN","PSOVDF1",241,0)
 S VAL=""
"RTN","PSOVDF1",242,0)
 I $T(NDC^PSOHDR)]"" D
"RTN","PSOVDF1",243,0)
 .S VAL=$$NDC^PSOHDR(PSOVDFD0,PSOVDFD1,"P")
"RTN","PSOVDF1",244,0)
 E  S VAL=$P($G(TEMP(PSOVDFD1,0)),U,12) D
"RTN","PSOVDF1",245,0)
 .I $G(VAL)="",$G(PSOVDRUG)'="" S VAL=$P($G(^PSDRUG(PSOVDRUG,2)),"^",4)
"RTN","PSOVDF1",246,0)
 I $G(VAL)'="" D
"RTN","PSOVDF1",247,0)
 .S VAL=$$REPL(VAL)
"RTN","PSOVDF1",248,0)
 .S X="",X=GIVECODE,$P(X,SEPC,4)=VAL,$P(X,SEPC,6)="NDC",VAL=X D PUT(2)
"RTN","PSOVDF1",249,0)
 E  S VAL=GIVECODE D PUT(2)
"RTN","PSOVDF1",250,0)
 S VAL=0 D PUT(3)
"RTN","PSOVDF1",251,0)
 ; (5-DEF="UNK" or API)
"RTN","PSOVDF1",252,0)
 S VAL=UNIT D PUT(5)
"RTN","PSOVDF1",253,0)
 ; (8~6-.02)
"RTN","PSOVDF1",254,0)
 S (VAL,WR)=""
"RTN","PSOVDF1",255,0)
 S WR=$$GET1^DIQ(52.2,PSOVDFD1_","_PSOVDFD0_",",.02,"","","PSOVERR") K PSOVERR I $G(WR)'="" S WR=$$REPL(WR),$P(VAL,SEPC,6)=WR D PUT(8)
"RTN","PSOVDF1",256,0)
 ; (10-.04)
"RTN","PSOVDF1",257,0)
 S VAL=$P(TP,U,4),VAL=$$REPL(VAL) D PUT(10)
"RTN","PSOVDF1",258,0)
 ; (14|1-.05)
"RTN","PSOVDF1",259,0)
 S VAL=$P(TP,U,5) I $G(VAL)="" G RXE3B
"RTN","PSOVDF1",260,0)
 S VAL=$$XCN200^VDEFEL(VAL,"PHARMACIST") D PUT(14)
"RTN","PSOVDF1",261,0)
 ; (18-8)
"RTN","PSOVDF1",262,0)
RXE3B S VAL=$P(TP,U,19) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL(VAL) D PUT(18)
"RTN","PSOVDF1",263,0)
 ; (22-.041)
"RTN","PSOVDF1",264,0)
 S VAL=$P(TP,U,10) I $G(VAL)'="" S VAL="D"_VAL,VAL=$$REPL(VAL) D PUT(22)
"RTN","PSOVDF1",265,0)
 ;
"RTN","PSOVDF1",266,0)
 I $G(MSG)="" G RXE3Q
"RTN","PSOVDF1",267,0)
 S MSG="RXE"_SEPF_MSG D OUT
"RTN","PSOVDF1",268,0)
RXE3Q ; Q
"RTN","PSOVDF1",269,0)
 ;
"RTN","PSOVDF1",270,0)
NTE3 ; PARTIAL
"RTN","PSOVDF1",271,0)
 S MSG=""
"RTN","PSOVDF1",272,0)
 ; (3-.03)
"RTN","PSOVDF1",273,0)
 S VAL=$P(TP,U,3) I $G(VAL)="" G NTE3Q
"RTN","PSOVDF1",274,0)
 S VAL=$$REPL(VAL)
"RTN","PSOVDF1",275,0)
 D PUT(3)
"RTN","PSOVDF1",276,0)
 S VAL="RE"_SEPC_"REMARKS" D PUT(4)
"RTN","PSOVDF1",277,0)
 S MSG="NTE"_SEPF_MSG D OUT
"RTN","PSOVDF1",278,0)
 ;
"RTN","PSOVDF1",279,0)
NTE3Q G ORC3A
"RTN","PSOVDF1",280,0)
 ;
"RTN","PSOVDF1",281,0)
 Q
"RTN","PSOVDF2")
0^2^B85283768^B86129954
"RTN","PSOVDF2",1,0)
PSOVDF2 ;BPOIFO/EL-OUTPATIENT PHARMACY (PRES, PREF, PPAR) HL7 MESSAGE ;10/04/04
"RTN","PSOVDF2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**190,205,220,235**;DEC 1997
"RTN","PSOVDF2",3,0)
 ;
"RTN","PSOVDF2",4,0)
 ; DBIAs:
"RTN","PSOVDF2",5,0)
 ; 2226-PS(51.2
"RTN","PSOVDF2",6,0)
 ; 221-PSDRUG
"RTN","PSOVDF2",7,0)
 ; 4248-VDEFEL
"RTN","PSOVDF2",8,0)
 ;
"RTN","PSOVDF2",9,0)
 Q
"RTN","PSOVDF2",10,0)
 ;
"RTN","PSOVDF2",11,0)
 ; Creates one of three Outpatient HL7 messages:
"RTN","PSOVDF2",12,0)
 ; RDE^O11^PRES, RDS^O13^PREF, or RDS^O13^PPAR
"RTN","PSOVDF2",13,0)
 ;
"RTN","PSOVDF2",14,0)
 ; Returns:
"RTN","PSOVDF2",15,0)
 ; Piece ^ 1 - "LM"-Local Array
"RTN","PSOVDF2",16,0)
 ; Piece ^ 2 - MSH segment, not set
"RTN","PSOVDF2",17,0)
 ; OUT - OUTPUT array includes HL7 message for every segment except MSH
"RTN","PSOVDF2",18,0)
 ;
"RTN","PSOVDF2",19,0)
 ; Message Body "MSH,PID,ORC1,RXE1,RXR1,FT1,OBX1,NTE1,ORC2,ORC3"
"RTN","PSOVDF2",20,0)
 ;
"RTN","PSOVDF2",21,0)
 ;
"RTN","PSOVDF2",22,0)
OUT ; Output
"RTN","PSOVDF2",23,0)
 N WR K WR
"RTN","PSOVDF2",24,0)
 S L=1
"RTN","PSOVDF2",25,0)
OUT10 I $L(MSG)<247 S WR(L)=MSG
"RTN","PSOVDF2",26,0)
 I $L(MSG)>246 S WR(L)=$E(MSG,1,246),L=L+1,MSG=$E(MSG,247,99999) G OUT10
"RTN","PSOVDF2",27,0)
 ;
"RTN","PSOVDF2",28,0)
OUT20 ; VISTA HL7
"RTN","PSOVDF2",29,0)
 S X=""
"RTN","PSOVDF2",30,0)
 F I=1:1 S X=$G(WR(I)) Q:X=""  D
"RTN","PSOVDF2",31,0)
 .  I I=1 S OUT("HLS")=$G(OUT("HLS"))+1,OUT("HLS",OUT("HLS"))=X
"RTN","PSOVDF2",32,0)
 .  E  I I>1 S OUT("HLS",OUT("HLS"),I-1)=X
"RTN","PSOVDF2",33,0)
 Q
"RTN","PSOVDF2",34,0)
 ;
"RTN","PSOVDF2",35,0)
GET(GLOBAL,L,P) ; GET(GLOBAL,NODE,PIECE)
"RTN","PSOVDF2",36,0)
 I $G(GLOBAL(L))="" Q ""
"RTN","PSOVDF2",37,0)
 N RES
"RTN","PSOVDF2",38,0)
 S RES=$P(GLOBAL(L),U,P)
"RTN","PSOVDF2",39,0)
 Q RES
"RTN","PSOVDF2",40,0)
 ;
"RTN","PSOVDF2",41,0)
PUT(P) ; Put in MSG
"RTN","PSOVDF2",42,0)
 I $G(VAL)="" Q
"RTN","PSOVDF2",43,0)
 S $P(MSG,SEPF,P)=VAL
"RTN","PSOVDF2",44,0)
 Q
"RTN","PSOVDF2",45,0)
 ;
"RTN","PSOVDF2",46,0)
PROCESS ;
"RTN","PSOVDF2",47,0)
ORC1 ; ORC ORIGINAL FILL
"RTN","PSOVDF2",48,0)
 S MSG="",CTR=0
"RTN","PSOVDF2",49,0)
 S VAL=$$GET(.GL,"OR1",2) I $G(VAL)'="" S VAL=$$REPL^PSOVDF1(VAL),VAL=VAL_SEPC_SRC_"_39.3" D PUT(2)
"RTN","PSOVDF2",50,0)
 S VAL=PSOVDFES_SEPC_SRC_"_.001" D PUT(3)
"RTN","PSOVDF2",51,0)
 S VAL="CM" D PUT(5)
"RTN","PSOVDF2",52,0)
 S (VAL,WR)="",WR=$$GET(.GL,2,2) I $G(WR)'="" D
"RTN","PSOVDF2",53,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="FILL"
"RTN","PSOVDF2",54,0)
 S WR=$$GET(.GL,2,6) I $G(WR)'="" D
"RTN","PSOVDF2",55,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(VAL,SEPC,5)=WR,$P(VAL,SEPC,7)=$P(VAL,SEPC,7)_"/EXPIRATION"
"RTN","PSOVDF2",56,0)
 I $G(VAL)'="" S CTR=CTR+1
"RTN","PSOVDF2",57,0)
 S (TP)="",WR=$$GET(.GL,0,13) I $G(WR)'="" D
"RTN","PSOVDF2",58,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(TP,SEPC,5)=WR,$P(TP,SEPC,7)="ISSUED" S CTR=CTR+1,$P(VAL,SEPR,CTR)=TP
"RTN","PSOVDF2",59,0)
 S (TP)="",WR=$$GET(.GL,2,5) I $G(WR)'="" D
"RTN","PSOVDF2",60,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(TP,SEPC,4)=WR,$P(TP,SEPC,7)="DISPENSED"
"RTN","PSOVDF2",61,0)
 ; (7~5|3-101)
"RTN","PSOVDF2",62,0)
 S WR=$$GET(.GL,3,1) I $G(WR)'="" D
"RTN","PSOVDF2",63,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(TP,SEPC,5)=WR,$P(TP,SEPC,7)=$P(TP,SEPC,7)_"/LAST DISPENSED"
"RTN","PSOVDF2",64,0)
 I $G(TP)'="" S CTR=CTR+1,$P(VAL,SEPR,CTR)=TP
"RTN","PSOVDF2",65,0)
 ; (7~5|4-26.1)
"RTN","PSOVDF2",66,0)
 S (TP)="",WR=$$GET(.GL,3,5) I $G(WR)'="" D
"RTN","PSOVDF2",67,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(TP,SEPC,5)=WR,$P(TP,SEPC,7)="CANCEL" S CTR=CTR+1,$P(VAL,SEPR,CTR)=TP
"RTN","PSOVDF2",68,0)
 I $G(VAL)'="" D PUT(7)
"RTN","PSOVDF2",69,0)
 ; (9-21)
"RTN","PSOVDF2",70,0)
 S VAL=$$GET(.GL,2,1),VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL^PSOVDF1(VAL) D PUT(9)
"RTN","PSOVDF2",71,0)
 ; (10-16)
"RTN","PSOVDF2",72,0)
 S VAL=$$GET(.GL,0,16) I $G(VAL)'="" S VAL=$$XCN200^VDEFEL(VAL) D PUT(10)
"RTN","PSOVDF2",73,0)
 ; (12|1-4)
"RTN","PSOVDF2",74,0)
 S WR="",VAL=$$GET(.GL,0,4) I $G(VAL)'="" D
"RTN","PSOVDF2",75,0)
 . S WR=$$XCN200^VDEFEL(VAL,"RE")
"RTN","PSOVDF2",76,0)
 ; (12|2-109)
"RTN","PSOVDF2",77,0)
 S TP="",VAL=$$GET(.GL,3,3) I $G(VAL)'="" D
"RTN","PSOVDF2",78,0)
 . S TP=$$XCN200^VDEFEL(VAL,"COSIGNER"),$P(WR,SEPR,2)=TP
"RTN","PSOVDF2",79,0)
 I $G(WR)'="" S VAL=WR D PUT(12)
"RTN","PSOVDF2",80,0)
 ; (13-5)
"RTN","PSOVDF2",81,0)
 S VAL=$$GET(.GL,0,5)
"RTN","PSOVDF2",82,0)
 I $G(VAL)'="" S VAL=$P($G(^SC(VAL,0)),U),VAL=$$REPL^PSOVDF1(VAL) D PUT(13)
"RTN","PSOVDF2",83,0)
 S (VAL,PSOVD59)=$$GET(.GL,2,9) I $G(VAL)'="" D
"RTN","PSOVDF2",84,0)
 .N PSONCOR,PSONCORP,PSOSINUM
"RTN","PSOVDF2",85,0)
 .S X=$G(^PS(59,VAL,0)),PSONCORP=$P($G(^("SAND")),"^",3)
"RTN","PSOVDF2",86,0)
 .S VAL=$P(X,U),(VAL,PSONCOR)=$$REPL^PSOVDF1(VAL) Q:VAL=""
"RTN","PSOVDF2",87,0)
 .S PSOSINUM=$P(X,U,6),PSOSINUM=$$REPL^PSOVDF1(PSOSINUM)
"RTN","PSOVDF2",88,0)
 .S VAL=PSOSINUM_SEPC_VAL_SEPC_SRC_"_20"
"RTN","PSOVDF2",89,0)
 .I PSONCORP'="" S PSONCORP=$$REPL^PSOVDF1(PSONCORP),VAL=VAL_SEPC_PSONCORP_SEPC_PSONCOR_SEPC_"NCPDP"
"RTN","PSOVDF2",90,0)
 .S PSOVDDIV(PSOVD59)=$G(VAL)
"RTN","PSOVDF2",91,0)
 .D PUT(17)
"RTN","PSOVDF2",92,0)
 S VAL=$G(PSOVDFIN) D PUT(21)
"RTN","PSOVDF2",93,0)
 N PSOVLV,PSOVAR,PSOVEN,DIC,DR,DA,DIQ D
"RTN","PSOVDF2",94,0)
 .S DIC=52,DR="100",(DA,PSOVEN)=PSOVDFD0,DIQ="PSOVAR",DIQ(0)="IE" D EN^DIQ1 S VAL=$G(PSOVAR(52,PSOVEN,100,"I")) I $G(VAL)="" Q
"RTN","PSOVDF2",95,0)
 .N PSOVALE S PSOVALE=$G(PSOVAR(52,PSOVEN,100,"E")),PSOVALE=$$REPL^PSOVDF1(PSOVALE)
"RTN","PSOVDF2",96,0)
 .S PSOVLV=$$GETVUID^XTID(52,100,VAL) I $P($G(PSOVLV),"^")'=0 S PSOVLV=$P(PSOVLV,"^"),PSOVLV=$$REPL^PSOVDF1(PSOVLV) S VAL=$G(PSOVLV)_SEPC_$G(PSOVALE)_SEPC_"99VA_52_100" D PUT(25) Q
"RTN","PSOVDF2",97,0)
 .I $G(VAL)'="" S VAL=$$REPL^PSOVDF1(VAL),VAL=VAL_SEPC_$G(PSOVALE)_SEPC_SRC_"_100" D PUT(25)
"RTN","PSOVDF2",98,0)
 ;
"RTN","PSOVDF2",99,0)
 I $G(MSG)="" G ORC1Q
"RTN","PSOVDF2",100,0)
 S $P(MSG,U)="RE"
"RTN","PSOVDF2",101,0)
 S MSG="ORC"_SEPF_MSG D OUT
"RTN","PSOVDF2",102,0)
ORC1Q ; Q
"RTN","PSOVDF2",103,0)
 ;
"RTN","PSOVDF2",104,0)
RXE1 ; RXE ORIGINAL FILL
"RTN","PSOVDF2",105,0)
 S MSG=""
"RTN","PSOVDF2",106,0)
 ; (1~4-22)
"RTN","PSOVDF2",107,0)
 S (VAL,WR)="",CTR=0 I $D(GL(6)) K TEMP M TEMP=GL(6) S WR=$$DOSE^PSOVDF3(.TEMP) I $G(WR)'="" S VAL=WR
"RTN","PSOVDF2",108,0)
 D FINISH^PSOVDF3
"RTN","PSOVDF2",109,0)
 D PUT(1)
"RTN","PSOVDF2",110,0)
 N PSOV568,PSOVNAME,PSOVUIDN,PSOVLL,PSOVNND,PSOVNDF,PSONAM50
"RTN","PSOVDF2",111,0)
 S (GIVECODE,P,PSOVNDF,PSOVDRUG,VAL,PSOVNND,PSOV568,PSOVNAME,PSOVLL,PSOVUIDN)="",PSOVDRUG=$$GET(.GL,0,6)
"RTN","PSOVDF2",112,0)
 I +$G(PSOVDRUG)'>0 G RXE1A
"RTN","PSOVDF2",113,0)
 S PSOVNND=$G(^PSDRUG(PSOVDRUG,"ND")),PSOV568=0
"RTN","PSOVDF2",114,0)
 S PSOVNDF=$P(PSOVNND,"^",3),PSOVLL=$P(PSOVNND,"^") I +PSOVNDF>0 D
"RTN","PSOVDF2",115,0)
 .S PSOVUIDN=$$PROD0^PSNAPIS(+PSOVLL,+PSOVNDF),PSOVNAME=$P(PSOVUIDN,"^"),PSOVNAME=$$REPL^PSOVDF1(PSOVNAME) S PSOV568=$$GETVUID^XTID(50.68,,+PSOVNDF_",")
"RTN","PSOVDF2",116,0)
 I $P($G(PSOV568),"^")'=0 S PSOV568=$$REPL^PSOVDF1(PSOV568) S VAL=$G(PSOV568)_SEPC_$G(PSOVNAME)_SEPC_"99VA_52_6",GIVECODE=VAL G RXE1A
"RTN","PSOVDF2",117,0)
 S PSONAM50=$P($G(^PSDRUG(PSOVDRUG,0)),"^"),PSONAM50=$$REPL^PSOVDF1(PSONAM50) S VAL=SEPC_PSONAM50_SEPC_SRC_"_6",GIVECODE=VAL
"RTN","PSOVDF2",118,0)
 ; (2~4-API or 52_27 or 50_31)
"RTN","PSOVDF2",119,0)
RXE1A S WR=""
"RTN","PSOVDF2",120,0)
 I $T(NDC^PSOHDR)]"" D
"RTN","PSOVDF2",121,0)
 .  S WR=$$NDC^PSOHDR(PSOVDFD0,0)
"RTN","PSOVDF2",122,0)
 E  S WR=$$GET(.GL,2,7) D
"RTN","PSOVDF2",123,0)
 .  I $G(WR)="",($G(PSOVDRUG)'="") S X=$G(^PSDRUG(PSOVDRUG,2)),WR=$P(X,U,4)
"RTN","PSOVDF2",124,0)
 I $G(WR)'="" S WR=$$REPL^PSOVDF1(WR),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,6)="NDC",DRCODE=VAL
"RTN","PSOVDF2",125,0)
 D PUT(2)
"RTN","PSOVDF2",126,0)
 N PSOLUN,PSOLUNI
"RTN","PSOVDF2",127,0)
 S (UNIT,VAL)="" I $G(PSOVNDF)'="" D
"RTN","PSOVDF2",128,0)
 .S PSOLUN=$$DFSU^PSNAPIS(PSOVLL,PSOVNDF)
"RTN","PSOVDF2",129,0)
 .I $G(PSOLUN)'="" N PSOUNTXT S PSOUNTXT=$P(PSOLUN,U,6),PSOUNTXT=$$REPL^PSOVDF1(PSOUNTXT),PSOLUNI=$P(PSOLUN,"^",5),PSOLUNI=$$REPL^PSOVDF1(PSOLUNI) S VAL=PSOLUNI_SEPC_PSOUNTXT_SEPC_SRC_"_6"
"RTN","PSOVDF2",130,0)
 I $G(VAL)="" S VAL="UNK"
"RTN","PSOVDF2",131,0)
 S UNIT=VAL D PUT(5)
"RTN","PSOVDF2",132,0)
 S VAL=0 D PUT(3)
"RTN","PSOVDF2",133,0)
 S CTR=0,(VAL,WR)=""
"RTN","PSOVDF2",134,0)
 ; (7|3-113)
"RTN","PSOVDF2",135,0)
 I $D(GL(6)) K TEMP M TEMP=GL(6) S WR=$$SSET^PSOVDF3(.TEMP,8,HLINST_"_52.0113_7") I $G(WR)'="" S VAL=WR
"RTN","PSOVDF2",136,0)
 ;Don't piece out INS nodes, can possibly contain up-arrow from Provider Comments
"RTN","PSOVDF2",137,0)
 S WR=$G(GL("INS")) I $G(WR)'="" S WR=$$REPL^PSOVDF1(WR),CTR=CTR+1,WR=WR_SEPC_SEPC_SRC_"_114",$P(VAL,SEPR,CTR)=WR
"RTN","PSOVDF2",138,0)
 S WR=$$GET(.GL,"INSS",1) I $G(WR)'="" S WR=$$REPL^PSOVDF1(WR),CTR=CTR+1,WR=WR_SEPC_SEPC_SRC_"_114.1",$P(VAL,SEPR,CTR)=WR
"RTN","PSOVDF2",139,0)
 D PUT(7)
"RTN","PSOVDF2",140,0)
 ; (8~6-11)
"RTN","PSOVDF2",141,0)
 S (WR,VAL)=""
"RTN","PSOVDF2",142,0)
 S WR=$$GET1^DIQ(52,PSOVDFD0_",",11,"","","PSOVERR") K PSOVERR I $G(WR)'="" S WR=$$REPL^PSOVDF1(WR),$P(VAL,SEPC,6)=WR D PUT(8)
"RTN","PSOVDF2",143,0)
 ; (10-7)
"RTN","PSOVDF2",144,0)
 S VAL=$$GET(.GL,0,7),VAL=$$REPL^PSOVDF1(VAL) D PUT(10)
"RTN","PSOVDF2",145,0)
 ; (12-9)
"RTN","PSOVDF2",146,0)
 S VAL=$$GET(.GL,0,9),VAL=$$REPL^PSOVDF1(VAL) D PUT(12)
"RTN","PSOVDF2",147,0)
 ; (14|1-23)
"RTN","PSOVDF2",148,0)
 S WR="",VAL=$$GET(.GL,2,3) I $G(VAL)'="" D
"RTN","PSOVDF2",149,0)
 . S WR=$$XCN200^VDEFEL(VAL,"PHARMACIST")
"RTN","PSOVDF2",150,0)
 ; (14|2-104)
"RTN","PSOVDF2",151,0)
 S TP="",VAL=$$GET(.GL,2,10) I $G(VAL)'="" D
"RTN","PSOVDF2",152,0)
 . S TP=$$XCN200^VDEFEL(VAL,"VERIFIER PHARM"),$P(WR,SEPR,2)=TP
"RTN","PSOVDF2",153,0)
 I $G(WR)'="" S VAL=WR D PUT(14)
"RTN","PSOVDF2",154,0)
 ; (15-.01)
"RTN","PSOVDF2",155,0)
 S VAL=$$GET(.GL,0,1),VAL=$$REPL^PSOVDF1(VAL) D PUT(15)
"RTN","PSOVDF2",156,0)
 ; (18-31)
"RTN","PSOVDF2",157,0)
 S VAL=$$GET(.GL,2,13) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL^PSOVDF1(VAL) D PUT(18)
"RTN","PSOVDF2",158,0)
 ; (21|1-10.2=1 or 10)
"RTN","PSOVDF2",159,0)
 S VAL="" I '$D(GL("SIG")) G RXE1B
"RTN","PSOVDF2",160,0)
 I $P(GL("SIG"),U,2)=1 D
"RTN","PSOVDF2",161,0)
 . I $D(GL("SIG1")) K TEMP M TEMP=GL("SIG1") S VAL=$$SSETX^PSOVDF3(.TEMP,1,SRC_"_10.2")
"RTN","PSOVDF2",162,0)
 E  S VAL=$$GET(.GL,"SIG",1) I $G(VAL)'="" S VAL=$$REPL^PSOVDF1(VAL),VAL=VAL_SEPC_SEPC_SRC_"_10"
"RTN","PSOVDF2",163,0)
 D PUT(21)
"RTN","PSOVDF2",164,0)
RXE1B ; (22-8)
"RTN","PSOVDF2",165,0)
 S VAL=$$GET(.GL,0,8) I $G(VAL)'="" S VAL="D"_VAL,VAL=$$REPL^PSOVDF1(VAL) D PUT(22)
"RTN","PSOVDF2",166,0)
 S VAL=$$GET(.GL,"TN",1)
"RTN","PSOVDF2",167,0)
 I $G(VAL)'="" S VAL=$$REPL^PSOVDF1(VAL)_SEPC_SEPC_SRC_"_6.5" D PUT(31)
"RTN","PSOVDF2",168,0)
 ;
"RTN","PSOVDF2",169,0)
 I $G(MSG)="" G RXE1Q
"RTN","PSOVDF2",170,0)
 S MSG="RXE"_SEPF_MSG D OUT
"RTN","PSOVDF2",171,0)
RXE1Q ; Q
"RTN","PSOVDF2",172,0)
 ;
"RTN","PSOVDF2",173,0)
RXR1 ; RXR ORIGINAL FILL
"RTN","PSOVDF2",174,0)
 S MSG=""
"RTN","PSOVDF2",175,0)
 I '$D(GL(6)) G RXR1Q
"RTN","PSOVDF2",176,0)
 N PSOVRTE,PSORTX
"RTN","PSOVDF2",177,0)
 K TEMP M TEMP=GL(6)
"RTN","PSOVDF2",178,0)
 S PSORTX="",PSOVDFD1=0
"RTN","PSOVDF2",179,0)
RXR1A S PSOVDFD1=$O(TEMP(PSOVDFD1)) G RXR1B:'PSOVDFD1
"RTN","PSOVDF2",180,0)
 S PSORTX=$P($G(TEMP(PSOVDFD1,0)),U,7)
"RTN","PSOVDF2",181,0)
 I $G(PSORTX)="" G RXR1A
"RTN","PSOVDF2",182,0)
 I '$D(^PS(51.2,PSORTX,0)) G RXR1A
"RTN","PSOVDF2",183,0)
 S PSOVRTE=$P(^PS(51.2,PSORTX,0),U),PSOVRTE=$$REPL^PSOVDF1(PSOVRTE),PSORTX=$$REPL^PSOVDF1(PSORTX)
"RTN","PSOVDF2",184,0)
 S VAL=PSORTX_SEPC_PSOVRTE_SEPC_HLINST_"_52.0113_6"
"RTN","PSOVDF2",185,0)
 I $G(MSG)'="" S MSG=MSG_SEPR_VAL
"RTN","PSOVDF2",186,0)
 E  S MSG=VAL
"RTN","PSOVDF2",187,0)
 G RXR1A
"RTN","PSOVDF2",188,0)
RXR1B I $G(MSG)="" G RXR1Q
"RTN","PSOVDF2",189,0)
 S MSG="RXR"_SEPF_MSG D OUT
"RTN","PSOVDF2",190,0)
RXR1Q ; Q
"RTN","PSOVDF2",191,0)
 ;
"RTN","PSOVDF2",192,0)
FT1 ;FT1 ORIGINAL FILL
"RTN","PSOVDF2",193,0)
 S (MSG)=""
"RTN","PSOVDF2",194,0)
 ; (4-22)
"RTN","PSOVDF2",195,0)
 S VAL=$$GET(.GL,2,2)
"RTN","PSOVDF2",196,0)
 I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL^PSOVDF1(VAL) D PUT(4)
"RTN","PSOVDF2",197,0)
 S VAL="CG" D PUT(6)
"RTN","PSOVDF2",198,0)
 S VAL=$$GET1^DIQ(52,PSOVDFD0_",",39.2,"","","PSOVERR") K PSOVERR
"RTN","PSOVDF2",199,0)
 I $G(VAL)'="" S VAL=$$REPL^PSOVDF1(VAL),VAL=VAL_SEPC_SEPC_SRC_"_39.2" D PUT(7)
"RTN","PSOVDF2",200,0)
 ; (12-17)
"RTN","PSOVDF2",201,0)
 S VAL=$$GET(.GL,0,17),VAL=$$REPL^PSOVDF1(VAL) D PUT(12)
"RTN","PSOVDF2",202,0)
 ; (18-3)
"RTN","PSOVDF2",203,0)
 S TP="",TP=$$GET(.GL,0,3)
"RTN","PSOVDF2",204,0)
 I $G(TP)'="" S VAL=$P($G(^PS(53,TP,0)),U,2),VAL=$$REPL^PSOVDF1(VAL) D PUT(18)
"RTN","PSOVDF2",205,0)
 I $G(MSG)="" G FT1Q
"RTN","PSOVDF2",206,0)
 S MSG="FT1"_SEPF_MSG D OUT
"RTN","PSOVDF2",207,0)
FT1Q ; Q
"RTN","PSOVDF2",208,0)
 ;
"RTN","PSOVDF2",209,0)
OBX1 ; OBX ORIGINAL FILL
"RTN","PSOVDF2",210,0)
 S CTR=0
"RTN","PSOVDF2",211,0)
 F FIELD=41,42,116,117,118,119,120,121,201 D OBXLP
"RTN","PSOVDF2",212,0)
 G OBX1B
"RTN","PSOVDF2",213,0)
 ;
"RTN","PSOVDF2",214,0)
OBXLP ;
"RTN","PSOVDF2",215,0)
 S MSG=""
"RTN","PSOVDF2",216,0)
 N DIC,DR,DA,DIQ,PSOOVAR,PSOOVEN
"RTN","PSOVDF2",217,0)
 S DIC=52,DR=FIELD,(DA,PSOOVEN)=PSOVDFD0,DIQ="PSOOVAR",DIQ(0)="IE" D EN^DIQ1 S VAL=$G(PSOOVAR(52,PSOOVEN,FIELD,"I"))
"RTN","PSOVDF2",218,0)
 I $G(VAL)="" Q
"RTN","PSOVDF2",219,0)
 N PSOOVALE S PSOOVALE=$G(PSOOVAR(52,PSOOVEN,FIELD,"E")),PSOOVALE=$$REPL^PSOVDF1(PSOOVALE)
"RTN","PSOVDF2",220,0)
 N PSOVLVU D
"RTN","PSOVDF2",221,0)
 .S PSOVLVU=$$GETVUID^XTID(52,FIELD,VAL) I $P($G(PSOVLVU),"^")'=0 S VAL=$$REPL^PSOVDF1(PSOVLVU)_SEPC_$G(PSOOVALE)_SEPC_"99VA_52_"_FIELD D PUT(5) Q
"RTN","PSOVDF2",222,0)
 .S VAL=$$REPL^PSOVDF1(VAL),VAL=VAL_SEPC_$G(PSOOVALE)_SEPC_SRC_"_"_FIELD D PUT(5)
"RTN","PSOVDF2",223,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF2",224,0)
 S VAL="CE" D PUT(2)
"RTN","PSOVDF2",225,0)
 N DD D FIELD^DID(52,FIELD,"","LABEL","DD","ERR")
"RTN","PSOVDF2",226,0)
 S VAL=$G(DD("LABEL")),VAL=$$REPL^PSOVDF1(VAL) D PUT(3)
"RTN","PSOVDF2",227,0)
 S VAL="F" D PUT(11)
"RTN","PSOVDF2",228,0)
 S MSG="OBX"_SEPF_MSG D OUT
"RTN","PSOVDF2",229,0)
 Q
"RTN","PSOVDF2",230,0)
 ;
"RTN","PSOVDF2",231,0)
OBX1B ;
"RTN","PSOVDF2",232,0)
 S MSG=""
"RTN","PSOVDF2",233,0)
 ; (5-301)
"RTN","PSOVDF2",234,0)
 S VAL=$$GET(.GL,"SAND",1)
"RTN","PSOVDF2",235,0)
 I $G(VAL)'="" D CLOZ^PSOVDF3
"RTN","PSOVDF2",236,0)
 ;
"RTN","PSOVDF2",237,0)
OBX1C ;
"RTN","PSOVDF2",238,0)
 S MSG=""
"RTN","PSOVDF2",239,0)
 ; (5-302)
"RTN","PSOVDF2",240,0)
 S VAL=$$GET(.GL,"SAND",2)
"RTN","PSOVDF2",241,0)
 I $G(VAL)'="" D WBC^PSOVDF3
"RTN","PSOVDF2",242,0)
 ;
"RTN","PSOVDF2",243,0)
NTE1 ;
"RTN","PSOVDF2",244,0)
 D REM^PSOVDF3
"RTN","PSOVDF2",245,0)
 ;
"RTN","PSOVDF2",246,0)
NTE1B ;
"RTN","PSOVDF2",247,0)
 D PRC^PSOVDF3
"RTN","PSOVDF2",248,0)
 ;
"RTN","PSOVDF2",249,0)
NTE1C ;
"RTN","PSOVDF2",250,0)
 D DEL^PSOVDF3
"RTN","PSOVDF2",251,0)
NTE1Q Q
"RTN","PSOVDF3")
0^3^B24142157^B4799011
"RTN","PSOVDF3",1,0)
PSOVDF3 ;BIR/RTR-OUTPATIENT PHARMACY VDEF MESSAGE CONTINUED ;06/16/05
"RTN","PSOVDF3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**205,235**;DEC 1997
"RTN","PSOVDF3",3,0)
 ;
"RTN","PSOVDF3",4,0)
 ;External refernce to PS(50.607 supported by DBIA 2221
"RTN","PSOVDF3",5,0)
 ;
"RTN","PSOVDF3",6,0)
DOSE(GLOBAL) ;Add Dosage information to RXE 1
"RTN","PSOVDF3",7,0)
 N RES S RES=""
"RTN","PSOVDF3",8,0)
 N PSODD1,PSODD2,PSODD3,PSODD5,PSODDL,PSODDN,PSORES1,PSODDUNT,PSOD1FLG
"RTN","PSOVDF3",9,0)
 F PSODDL=0:0 S PSODDL=$O(GLOBAL(PSODDL)) Q:'PSODDL  D
"RTN","PSOVDF3",10,0)
 .S PSODDN=$G(GLOBAL(PSODDL,0)) Q:PSODDN=""
"RTN","PSOVDF3",11,0)
 .S PSODD1=$P(PSODDN,"^"),PSODD2=$P(PSODDN,"^",2),PSODD3=$P(PSODDN,"^",3),PSODD5=$P(PSODDN,"^",5),PSODDUNT=""
"RTN","PSOVDF3",12,0)
 .I PSODD1="",PSODD2="",PSODD5="" Q
"RTN","PSOVDF3",13,0)
 .I PSODD5'="",($E(PSODD5,$L(PSODD5))'?1A) S PSODD5=PSODD5_"D"
"RTN","PSOVDF3",14,0)
 .I PSODD5'="" S PSODD5=$$REPL^PSOVDF1(PSODD5)
"RTN","PSOVDF3",15,0)
 .S PSOD1FLG=0
"RTN","PSOVDF3",16,0)
 .I PSODD2'="",PSODD3'="",$P($G(^PS(50.607,PSODD3,0)),"^")'="" S PSOD1FLG=1,PSODDUNT=$P($G(^(0)),"^"),PSODDUNT=$$REPL^PSOVDF1(PSODDUNT) S:$G(PSODD1)'="" PSODD1=$$REPL^PSOVDF1(PSODD1),PSODD1=PSODD1_PSODDUNT
"RTN","PSOVDF3",17,0)
 .I 'PSOD1FLG,$G(PSODD1)'="" S PSODD1=$$REPL^PSOVDF1(PSODD1)
"RTN","PSOVDF3",18,0)
 .S PSORES1=""
"RTN","PSOVDF3",19,0)
 .I PSODD1'=""!(PSODD2'="") D
"RTN","PSOVDF3",20,0)
 ..I PSODD2'="" S PSODD2=$$REPL^PSOVDF1(PSODD2) S PSORES1=PSODD2 S:PSODD1'="" PSORES1=PSORES1_SEPS_PSODD1 Q
"RTN","PSOVDF3",21,0)
 ..S PSORES1=SEPS_PSODD1
"RTN","PSOVDF3",22,0)
 .I PSODD5'="" D
"RTN","PSOVDF3",23,0)
 ..I PSORES1="" S PSORES1=SEPC_SEPC_PSODD5 Q
"RTN","PSOVDF3",24,0)
 ..S PSORES1=PSORES1_SEPC_SEPC_PSODD5
"RTN","PSOVDF3",25,0)
 .Q:PSORES1=""
"RTN","PSOVDF3",26,0)
 .I $G(RES)'="" S RES=RES_SEPR_PSORES1 Q
"RTN","PSOVDF3",27,0)
 .S RES=PSORES1
"RTN","PSOVDF3",28,0)
 K TEMP
"RTN","PSOVDF3",29,0)
 Q RES
"RTN","PSOVDF3",30,0)
 ;
"RTN","PSOVDF3",31,0)
FINISH ;Finish rest of RXE 1 segment
"RTN","PSOVDF3",32,0)
 N PSOVAL1 S PSOVAL1=$P(VAL,SEPR)
"RTN","PSOVDF3",33,0)
 S WR=""
"RTN","PSOVDF3",34,0)
 S WR=$$GET^PSOVDF2(.GL,2,2)
"RTN","PSOVDF3",35,0)
 I $G(WR)'="" S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(PSOVAL1,SEPC,4)=WR,$P(PSOVAL1,SEPC,7)="FILL"
"RTN","PSOVDF3",36,0)
 ; (1~5-26.1)
"RTN","PSOVDF3",37,0)
 S WR=$$GET^PSOVDF2(.GL,3,5)
"RTN","PSOVDF3",38,0)
 I $G(WR)'="" D
"RTN","PSOVDF3",39,0)
 .S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(PSOVAL1,SEPC,5)=WR,$P(PSOVAL1,SEPC,7)=$P(PSOVAL1,SEPC,7)_"/CANCEL"
"RTN","PSOVDF3",40,0)
 E  S WR=$$GET^PSOVDF2(.GL,2,6) I $G(WR)'="" D
"RTN","PSOVDF3",41,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS") I WR>0 S WR=$$REPL^PSOVDF1(WR),$P(PSOVAL1,SEPC,5)=WR,$P(PSOVAL1,SEPC,7)=$P(PSOVAL1,SEPC,7)_"/EXPIRATION"
"RTN","PSOVDF3",42,0)
 S $P(VAL,SEPR)=PSOVAL1
"RTN","PSOVDF3",43,0)
 S WR=""
"RTN","PSOVDF3",44,0)
 Q
"RTN","PSOVDF3",45,0)
 ;
"RTN","PSOVDF3",46,0)
REM ;Remarks for Original Fill
"RTN","PSOVDF3",47,0)
 S MSG="",CTR=0
"RTN","PSOVDF3",48,0)
 S VAL=$$GET^PSOVDF2(.GL,3,7)
"RTN","PSOVDF3",49,0)
 I $G(VAL)="" Q
"RTN","PSOVDF3",50,0)
 S VAL=$$REPL^PSOVDF1(VAL)
"RTN","PSOVDF3",51,0)
 D PUT(3)
"RTN","PSOVDF3",52,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF3",53,0)
 S VAL="RE"_SEPC_"REMARKS"_SEPC_SRC_"_12" D PUT(4)
"RTN","PSOVDF3",54,0)
 S MSG="NTE"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",55,0)
 Q
"RTN","PSOVDF3",56,0)
 ;
"RTN","PSOVDF3",57,0)
DEL ;Deletion comments
"RTN","PSOVDF3",58,0)
 S MSG=""
"RTN","PSOVDF3",59,0)
 S VAL=$$GET^PSOVDF2(.GL,"D",1)
"RTN","PSOVDF3",60,0)
 I $G(VAL)="" Q
"RTN","PSOVDF3",61,0)
 S VAL=$$REPL^PSOVDF1(VAL)
"RTN","PSOVDF3",62,0)
 D PUT(3)
"RTN","PSOVDF3",63,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF3",64,0)
 S VAL="DE"_SEPC_"DELETION COMMENTS"_SEPC_SRC_"_108" D PUT(4)
"RTN","PSOVDF3",65,0)
 S MSG="NTE"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",66,0)
 Q
"RTN","PSOVDF3",67,0)
 ;
"RTN","PSOVDF3",68,0)
CLOZ ; Clozapine Dosage
"RTN","PSOVDF3",69,0)
 S VAL=$$REPL^PSOVDF1(VAL)
"RTN","PSOVDF3",70,0)
 D PUT(5)
"RTN","PSOVDF3",71,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF3",72,0)
 S VAL="NM" D PUT(2)
"RTN","PSOVDF3",73,0)
 S VAL="CLOZAPINE DOSAGE" D PUT(3)
"RTN","PSOVDF3",74,0)
 S VAL="MG/DAY" D PUT(6)
"RTN","PSOVDF3",75,0)
 S VAL="F" D PUT(11)
"RTN","PSOVDF3",76,0)
 S MSG="OBX"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",77,0)
 Q
"RTN","PSOVDF3",78,0)
 ;
"RTN","PSOVDF3",79,0)
WBC ; WBC results
"RTN","PSOVDF3",80,0)
 S VAL=$$REPL^PSOVDF1(VAL)
"RTN","PSOVDF3",81,0)
 D PUT(5)
"RTN","PSOVDF3",82,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF3",83,0)
 S VAL="NM" D PUT(2)
"RTN","PSOVDF3",84,0)
 S VAL="WBC RESULTS" D PUT(3)
"RTN","PSOVDF3",85,0)
 S VAL="F" D PUT(11)
"RTN","PSOVDF3",86,0)
 ; (14-303)
"RTN","PSOVDF3",87,0)
 S VAL=$$GET^PSOVDF2(.GL,"SAND",3)
"RTN","PSOVDF3",88,0)
 I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") I VAL>0 S VAL=$$REPL^PSOVDF1(VAL) D PUT(14)
"RTN","PSOVDF3",89,0)
 S MSG="OBX"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",90,0)
 Q
"RTN","PSOVDF3",91,0)
PRC ;Provider Comments, do not piece out data, can contain up-arrow
"RTN","PSOVDF3",92,0)
 S MSG=""
"RTN","PSOVDF3",93,0)
 I '$D(GL("PRC")) Q
"RTN","PSOVDF3",94,0)
 S VAL="" K TEMP M TEMP=GL("PRC") S VAL=$$SSETZ(.TEMP,1)
"RTN","PSOVDF3",95,0)
 I $G(VAL)="" Q
"RTN","PSOVDF3",96,0)
 D PUT(3)
"RTN","PSOVDF3",97,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF3",98,0)
 S VAL="PR"_SEPC_"PROVIDER COMMENTS"_SEPC_HLINST_"_52.039_.01" D PUT(4)
"RTN","PSOVDF3",99,0)
 S MSG="NTE"_SEPF_MSG D OUT^PSOVDF2
"RTN","PSOVDF3",100,0)
 Q
"RTN","PSOVDF3",101,0)
SSETZ(GLOBAL,P) ;Format Provider Comments
"RTN","PSOVDF3",102,0)
 N RES,PSOVPCOM,PSOVDFD1,X
"RTN","PSOVDF3",103,0)
 S (RES,X)="",PSOVDFD1=0
"RTN","PSOVDF3",104,0)
SSET10Z S PSOVDFD1=$O(GLOBAL(PSOVDFD1)) G SSETQZ:'PSOVDFD1
"RTN","PSOVDF3",105,0)
 S PSOVPCOM=GLOBAL(PSOVDFD1,0) I PSOVPCOM="" G SSET10Z
"RTN","PSOVDF3",106,0)
 I $G(RES)'="" S RES=RES_" "_PSOVPCOM
"RTN","PSOVDF3",107,0)
 E  S RES=PSOVPCOM
"RTN","PSOVDF3",108,0)
 G SSET10Z
"RTN","PSOVDF3",109,0)
SSETQZ ;
"RTN","PSOVDF3",110,0)
 I $G(RES)'="" S RES=$$REPL^PSOVDF1(RES)
"RTN","PSOVDF3",111,0)
 Q RES
"RTN","PSOVDF3",112,0)
 ;
"RTN","PSOVDF3",113,0)
 Q
"RTN","PSOVDF3",114,0)
 ;
"RTN","PSOVDF3",115,0)
PUT(P) ; Put in MSG
"RTN","PSOVDF3",116,0)
 I $G(VAL)="" Q
"RTN","PSOVDF3",117,0)
 S $P(MSG,SEPF,P)=VAL
"RTN","PSOVDF3",118,0)
 Q
"RTN","PSOVDF3",119,0)
 ;
"RTN","PSOVDF3",120,0)
SSET(GLOBAL,P,L) ;Schedule field
"RTN","PSOVDF3",121,0)
 N RES,PSOVSCH,PSOVDFD1,X
"RTN","PSOVDF3",122,0)
 S (RES,X)="",PSOVDFD1=0
"RTN","PSOVDF3",123,0)
SSET10 S PSOVDFD1=$O(GLOBAL(PSOVDFD1)) G SSETQ:'PSOVDFD1
"RTN","PSOVDF3",124,0)
 I $G(L)="" S L=""
"RTN","PSOVDF3",125,0)
 S X=$G(GLOBAL(PSOVDFD1,0)) S PSOVSCH=$P($G(X),U,P),PSOVSCH=$$REPL^PSOVDF1(PSOVSCH) I PSOVSCH'="" D
"RTN","PSOVDF3",126,0)
 .I $G(RES)'="" S RES=RES_SEPR_PSOVSCH_SEPC_SEPC_L
"RTN","PSOVDF3",127,0)
 .E  S RES=PSOVSCH_SEPC_SEPC_L
"RTN","PSOVDF3",128,0)
 .S CTR=CTR+1
"RTN","PSOVDF3",129,0)
 G SSET10
"RTN","PSOVDF3",130,0)
SSETQ ;
"RTN","PSOVDF3",131,0)
 Q RES
"RTN","PSOVDF3",132,0)
 ;
"RTN","PSOVDF3",133,0)
 Q
"RTN","PSOVDF3",134,0)
 ;
"RTN","PSOVDF3",135,0)
SSETX(GLOBAL,P,L) ;Format Sig, don't piece out, can possibly contain up-arrow from Provider Comments
"RTN","PSOVDF3",136,0)
 N RES,PSOVSIG,PSOVDFD1,X
"RTN","PSOVDF3",137,0)
 S (RES,X)="",PSOVDFD1=0
"RTN","PSOVDF3",138,0)
SSET10X S PSOVDFD1=$O(GLOBAL(PSOVDFD1)) G SSETQX:'PSOVDFD1
"RTN","PSOVDF3",139,0)
 I $G(L)="" S L=""
"RTN","PSOVDF3",140,0)
 S PSOVSIG=GLOBAL(PSOVDFD1,0) I PSOVSIG'="" D
"RTN","PSOVDF3",141,0)
 .I $G(RES)'="" S RES=RES_PSOVSIG
"RTN","PSOVDF3",142,0)
 .E  S RES=PSOVSIG
"RTN","PSOVDF3",143,0)
 G SSET10X
"RTN","PSOVDF3",144,0)
SSETQX I $G(RES)="" Q RES
"RTN","PSOVDF3",145,0)
 S RES=$$REPL^PSOVDF1(RES)
"RTN","PSOVDF3",146,0)
 S RES=RES_SEPC_SEPC_L
"RTN","PSOVDF3",147,0)
 Q RES
"RTN","PSOVDF3",148,0)
 ;
"RTN","PSOVDF3",149,0)
 Q
"VER")
8.0^22.0
"BLD",6003,6)
^208
**END**
**END**
