Released IB*2*275 SEQ #263
Extracted from mail message
**KIDS**:IB*2.0*275^

**INSTALL NAME**
IB*2.0*275
"BLD",4865,0)
IB*2.0*275^INTEGRATED BILLING^0^3040726^y
"BLD",4865,4,0)
^9.64PA^^
"BLD",4865,"INIT")
POST^IB20P275
"BLD",4865,"KRN",0)
^9.67PA^8989.52^19
"BLD",4865,"KRN",.4,0)
.4
"BLD",4865,"KRN",.401,0)
.401
"BLD",4865,"KRN",.402,0)
.402
"BLD",4865,"KRN",.403,0)
.403
"BLD",4865,"KRN",.5,0)
.5
"BLD",4865,"KRN",.84,0)
.84
"BLD",4865,"KRN",3.6,0)
3.6
"BLD",4865,"KRN",3.8,0)
3.8
"BLD",4865,"KRN",9.2,0)
9.2
"BLD",4865,"KRN",9.8,0)
9.8
"BLD",4865,"KRN",9.8,"NM",0)
^9.68A^22^6
"BLD",4865,"KRN",9.8,"NM",1,0)
IBACV^^0^B33359562
"BLD",4865,"KRN",9.8,"NM",13,0)
IBTRKR3^^0^B28801835
"BLD",4865,"KRN",9.8,"NM",17,0)
IBARXEU1^^0^B13926560
"BLD",4865,"KRN",9.8,"NM",18,0)
IB20P275^^0^B3899344
"BLD",4865,"KRN",9.8,"NM",19,0)
IBAMTC^^0^B23660778
"BLD",4865,"KRN",9.8,"NM",22,0)
IBAHVE3^^0^B25291751
"BLD",4865,"KRN",9.8,"NM","B","IB20P275",18)

"BLD",4865,"KRN",9.8,"NM","B","IBACV",1)

"BLD",4865,"KRN",9.8,"NM","B","IBAHVE3",22)

"BLD",4865,"KRN",9.8,"NM","B","IBAMTC",19)

"BLD",4865,"KRN",9.8,"NM","B","IBARXEU1",17)

"BLD",4865,"KRN",9.8,"NM","B","IBTRKR3",13)

"BLD",4865,"KRN",19,0)
19
"BLD",4865,"KRN",19,"NM",0)
^9.68A^^0
"BLD",4865,"KRN",19.1,0)
19.1
"BLD",4865,"KRN",101,0)
101
"BLD",4865,"KRN",409.61,0)
409.61
"BLD",4865,"KRN",771,0)
771
"BLD",4865,"KRN",870,0)
870
"BLD",4865,"KRN",8989.51,0)
8989.51
"BLD",4865,"KRN",8989.52,0)
8989.52
"BLD",4865,"KRN",8994,0)
8994
"BLD",4865,"KRN","B",.4,.4)

"BLD",4865,"KRN","B",.401,.401)

"BLD",4865,"KRN","B",.402,.402)

"BLD",4865,"KRN","B",.403,.403)

"BLD",4865,"KRN","B",.5,.5)

"BLD",4865,"KRN","B",.84,.84)

"BLD",4865,"KRN","B",3.6,3.6)

"BLD",4865,"KRN","B",3.8,3.8)

"BLD",4865,"KRN","B",9.2,9.2)

"BLD",4865,"KRN","B",9.8,9.8)

"BLD",4865,"KRN","B",19,19)

"BLD",4865,"KRN","B",19.1,19.1)

"BLD",4865,"KRN","B",101,101)

"BLD",4865,"KRN","B",409.61,409.61)

"BLD",4865,"KRN","B",771,771)

"BLD",4865,"KRN","B",870,870)

"BLD",4865,"KRN","B",8989.51,8989.51)

"BLD",4865,"KRN","B",8989.52,8989.52)

"BLD",4865,"KRN","B",8994,8994)

"BLD",4865,"QUES",0)
^9.62^^
"BLD",4865,"REQB",0)
^9.611^3^3
"BLD",4865,"REQB",1,0)
IB*2.0*74^2
"BLD",4865,"REQB",2,0)
IB*2.0*215^2
"BLD",4865,"REQB",3,0)
IB*2.0*247^2
"BLD",4865,"REQB","B","IB*2.0*215",2)

"BLD",4865,"REQB","B","IB*2.0*247",3)

"BLD",4865,"REQB","B","IB*2.0*74",1)

"INIT")
POST^IB20P275
"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321
"PKG",200,22,1,"PAH",1,0)
275^3040726
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","IB20P275")
0^18^B3899344
"RTN","IB20P275",1,0)
IB20P275 ;WOIFO/SS - POST INIT ROUTINE FOR IB*2*275 ;11-MAY-04
"RTN","IB20P275",2,0)
 ;;2.0;INTEGRATED BILLING;**275**;21-MAR-94
"RTN","IB20P275",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IB20P275",4,0)
 ;
"RTN","IB20P275",5,0)
 Q
"RTN","IB20P275",6,0)
POST ; adding charge removal reason entries if not there
"RTN","IB20P275",7,0)
 N IBX,IBT,IBY,X,Y,DIC,DO
"RTN","IB20P275",8,0)
 D ADDAUTO
"RTN","IB20P275",9,0)
 D ADDCRR
"RTN","IB20P275",10,0)
 Q
"RTN","IB20P275",11,0)
 ;
"RTN","IB20P275",12,0)
ADDAUTO ; need to add charge removal reasons
"RTN","IB20P275",13,0)
 N IBX,IBT,IBY,DIC,Y,X
"RTN","IB20P275",14,0)
 F IBX=1:1 S IBY=$P($T(AUTO+IBX),";",3,99) Q:IBY=""  S IBT=$P(IBY,";") I '$O(^IBE(354.2,"B",IBT,0)) K DO D
"RTN","IB20P275",15,0)
 . S DIC="^IBE(354.2,",DIC(0)="",X=IBT,DIC("DR")=$P(IBY,";",2,5)
"RTN","IB20P275",16,0)
 . D FILE^DICN I Y>0 D BMES^XPDUTL("  --> Added Exemption Reason File: "_IBT)
"RTN","IB20P275",17,0)
 Q
"RTN","IB20P275",18,0)
ADDCRR ; add charge removal reasons
"RTN","IB20P275",19,0)
 N IBX,IBT,IBY,DIC,Y,X
"RTN","IB20P275",20,0)
 F IBX=1:1 S IBY=$P($T(CRR+IBX),";",3,99) Q:IBY=""  S IBT=$P(IBY,";") I '$O(^IBE(350.3,"B",IBT,0)) K DO D
"RTN","IB20P275",21,0)
 . S DIC="^IBE(350.3,",DIC(0)="",X=IBT,DIC("DR")=$P(IBY,";",2,3)
"RTN","IB20P275",22,0)
 . D FILE^DICN I Y>0 D BMES^XPDUTL("  --> Added Charge Removal Reasons: "_IBT)
"RTN","IB20P275",23,0)
 Q
"RTN","IB20P275",24,0)
 ;
"RTN","IB20P275",25,0)
 ;
"RTN","IB20P275",26,0)
AUTO ; Exemption Reasons to add in #354.2 
"RTN","IB20P275",27,0)
 ;;FORMER POW;.02///Patient is a former Prisoner Of War;.03///COPAY INCOME EXEMPTION;.04///EXEMPT;.05///80
"RTN","IB20P275",28,0)
 ;;UNEMPLOYABLE VETERAN;.02///Patient is an unemployable veteran;.03///COPAY INCOME EXEMPTION;.04///EXEMPT;.05///90
"RTN","IB20P275",29,0)
 ;;
"RTN","IB20P275",30,0)
 ;
"RTN","IB20P275",31,0)
CRR ; charge removal reasons to add in #350.3
"RTN","IB20P275",32,0)
 ;;RX FOR FORMER POW;.02///POW;.03///RX
"RTN","IB20P275",33,0)
 ;;RX FOR UNEMPLOYABLE VETERAN;.02///UNEMPL;.03///RX
"RTN","IB20P275",34,0)
 ;;
"RTN","IB20P275",35,0)
 ;
"RTN","IBACV")
0^1^B33359562
"RTN","IBACV",1,0)
IBACV ;WOIFO/SS-COMBAT VET UTILITIES ;7-AUG-03
"RTN","IBACV",2,0)
 ;;2.0;INTEGRATED BILLING;**234,247,275**;21-MAR-94
"RTN","IBACV",3,0)
 ;; Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBACV",4,0)
 ;
"RTN","IBACV",5,0)
 ;To replace CL^SDCO21 with CL^IBACV that wraps out both CL^SDCO21 and $$CVEDT^DGCV
"RTN","IBACV",6,0)
CL(IBDFN,IBSDDT,IBSDOE,IBSDCLY) ;Build Classification Array
"RTN","IBACV",7,0)
 ; Input  -- DFN      Patient file IEN  
"RTN","IBACV",8,0)
 ;   SDDT     Date/Time [Optional]
"RTN","IBACV",9,0)
 ;   SDOE     Outpatient Encounter file IEN  [Optional]
"RTN","IBACV",10,0)
 ; Output -- SDCLY    Classification Array
"RTN","IBACV",11,0)
 ;    Subscripted by Class. Type file (#409.41) IEN
"RTN","IBACV",12,0)
 ;
"RTN","IBACV",13,0)
 D CL^SDCO21(IBDFN,$G(IBSDDT),$G(IBSDOE),.IBSDCLY)
"RTN","IBACV",14,0)
 Q
"RTN","IBACV",15,0)
 ;
"RTN","IBACV",16,0)
 ;returns CV status as:
"RTN","IBACV",17,0)
 ; current_CV_status^end_date^if_ever_had_CV_status
"RTN","IBACV",18,0)
CVEDT(IBDFN,IBDT) ;
"RTN","IBACV",19,0)
 N IBRET S IBRET=$$CVEDT^DGCV($G(IBDFN),$G(IBDT))
"RTN","IBACV",20,0)
 Q (+$P(IBRET,"^",3))_"^"_(+$P(IBRET,"^",2))_"^"_(+$P(IBRET,"^",1))  ;swop
"RTN","IBACV",21,0)
 ;
"RTN","IBACV",22,0)
 ;/**
"RTN","IBACV",23,0)
 ;Return the classification description of code sets for #.03 in #351.2.
"RTN","IBACV",24,0)
 ;  Input:
"RTN","IBACV",25,0)
 ; X  --  Patient class [1-ao|2-ir|3-ec|4-sc|5-mst|6-hnc|7-cv]
"RTN","IBACV",26,0)
 ; IBCASE -- "M" - mixed case (the first letter is uppercase and others-lowercase)
"RTN","IBACV",27,0)
PATTYPE(X,IBCASE) ; */
"RTN","IBACV",28,0)
 N IBZ
"RTN","IBACV",29,0)
 S IBZ=$S(X=1:"AGENT ORANGE",X=2:"IONIZING RADIATION",X=3:"ENVIRONMENTAL CONTAMINANT",X=4:"SERVICE CONNECTED",X=5:"MILITARY SEXUAL TRAUMA",X=6:"HEAD/NECK CANCER",X=7:"COMBAT VETERAN",1:"SPECIAL")
"RTN","IBACV",30,0)
 Q:$G(IBCASE)="M" $$LOWER^VALM1(IBZ)
"RTN","IBACV",31,0)
 Q IBZ
"RTN","IBACV",32,0)
 ;
"RTN","IBACV",33,0)
 ;if Combat Vet sends e-mail to mailgroup "IB COMBAT VET RX COPAY"
"RTN","IBACV",34,0)
 ;IBDFN-patient IEN, IBDT - date, IBRXPTR - pointer to #52 file to get prescription #
"RTN","IBACV",35,0)
RXALRT(IBDFN,IBDT,IBRXPTR) ;
"RTN","IBACV",36,0)
 N IB1
"RTN","IBACV",37,0)
 S IB1=$$CVEDT(IBDFN,$G(IBDT))
"RTN","IBACV",38,0)
 I +IB1 D EMAIL(IBDFN,$G(IBDT),$P(IB1,"^",2),$G(IBRXPTR))
"RTN","IBACV",39,0)
 Q
"RTN","IBACV",40,0)
 ;sends e-mail to mail group IB COMBAT VET RX COPAY
"RTN","IBACV",41,0)
EMAIL(DFN,IBEFDT,IBEXPDT,IBRX) ;
"RTN","IBACV",42,0)
 N IBTODAY,IBPAT,IBT,IBSSN
"RTN","IBACV",43,0)
 N XMSUB,XMY,XMTEXT,XMDUZ
"RTN","IBACV",44,0)
 N Y D NOW^%DTC S Y=%\1 X ^DD("DD") S IBTODAY=Y
"RTN","IBACV",45,0)
 I +$G(DFN)>0 D
"RTN","IBACV",46,0)
 . N VADM,VA,VAERR
"RTN","IBACV",47,0)
 . D DEM^VADPT
"RTN","IBACV",48,0)
 . S IBPAT=$G(VADM(1))
"RTN","IBACV",49,0)
 . S IBSSN=$P($G(VADM(2)),"^",2)
"RTN","IBACV",50,0)
 S IBRX=$P($G(^PSRX(+$G(IBRX),0)),"^",1) ;get RX number
"RTN","IBACV",51,0)
 S:IBPAT="" IBPAT="Unknown"
"RTN","IBACV",52,0)
 S XMSUB="COMBAT VET RX COPAY REVIEW NEEDED"
"RTN","IBACV",53,0)
 S XMY("G.IB COMBAT VET RX COPAY")=""
"RTN","IBACV",54,0)
 S XMTEXT="IBT(",XMDUZ="INTEGRATED BILLING PACKAGE"
"RTN","IBACV",55,0)
 S IBT(1,0)="PATIENT: "_IBPAT
"RTN","IBACV",56,0)
 I $G(IBEXPDT)>0 S Y=IBEXPDT X ^DD("DD") S IBT(1,0)=IBT(1,0)_"  COMBAT VET until: "_Y
"RTN","IBACV",57,0)
 S IBT(2,0)="SSN: "_IBSSN
"RTN","IBACV",58,0)
 S IBT(3,0)=""
"RTN","IBACV",59,0)
 S IBT(4,0)=$S(IBRX'="":"RX#: "_IBRX,1:"")
"RTN","IBACV",60,0)
 S IBT(5,0)="RX RELEASE DATE: "_IBTODAY
"RTN","IBACV",61,0)
 S IBT(6,0)=""
"RTN","IBACV",62,0)
 S IBT(7,0)="The above patient has a Combat Veteran status. Please review this"
"RTN","IBACV",63,0)
 S IBT(8,0)="prescription to determine if the RX Copay charge should be cancelled."
"RTN","IBACV",64,0)
 S IBT(9,0)=""
"RTN","IBACV",65,0)
 D ^XMD
"RTN","IBACV",66,0)
 Q
"RTN","IBACV",67,0)
 ;
"RTN","IBACV",68,0)
 ;--------------------------------------------------------------------
"RTN","IBACV",69,0)
 ;is called from PROC^IBAMTC for each active inpatient
"RTN","IBACV",70,0)
IFCVEXP(IBDFN,IBNJDT,IB405) ;
"RTN","IBACV",71,0)
 ;Input:IBDFN1 - patient's ien in PATIENT file
"RTN","IBACV",72,0)
 ;      IBNJDT  - Nightly Job date 
"RTN","IBACV",73,0)
 ;      IB405 - ptr to #405
"RTN","IBACV",74,0)
 N IBTSTDT,IBPAT,IBZ,IBEXPIR,IBADM
"RTN","IBACV",75,0)
 S IBPAT=$$PT^IBEFUNC(IBDFN)
"RTN","IBACV",76,0)
 S (IBZ,IBEXPIR)=0
"RTN","IBACV",77,0)
 S IBZ=$$CVEDT^IBACV(IBDFN,IBNJDT)
"RTN","IBACV",78,0)
 I $P(IBZ,"^",3)=0 Q  ;patient has never been CV
"RTN","IBACV",79,0)
 S IBEXPIR=+$P(IBZ,"^",2)\1
"RTN","IBACV",80,0)
 I IBEXPIR>IBNJDT Q  ;expires in the future
"RTN","IBACV",81,0)
 ;get last date when Nightly job checked CV status for inpatients
"RTN","IBACV",82,0)
 S IBTSTDT=$$XTMPLST()
"RTN","IBACV",83,0)
 ;if ^XTMP is not there then make the last CV check date as TODAY-7
"RTN","IBACV",84,0)
 I IBTSTDT=0 S IBTSTDT=$$CHNGDATE^IBAHVE3(IBNJDT,-7) D SETXTMP0(IBTSTDT)
"RTN","IBACV",85,0)
 S IBADM=+$G(^DGPM(IB405,0))\1 ;admission/movement date
"RTN","IBACV",86,0)
 I IBTSTDT'<IBNJDT Q
"RTN","IBACV",87,0)
 ;check for all the days since the last check date thru today
"RTN","IBACV",88,0)
 F  D  Q:(IBTSTDT'<IBNJDT)!(IBTSTDT=IBEXPIR)
"RTN","IBACV",89,0)
 . S IBTSTDT=$$CHNGDATE^IBAHVE3(IBTSTDT,+1) ;next date
"RTN","IBACV",90,0)
 . ;quit if the date is before the admission
"RTN","IBACV",91,0)
 . I IBTSTDT<IBADM Q
"RTN","IBACV",92,0)
 . ;send alert if CV expires this day
"RTN","IBACV",93,0)
 . I IBEXPIR=IBTSTDT D SETXTPM(IBDFN,IBTSTDT,IBEXPIR,IBADM,IBPAT)
"RTN","IBACV",94,0)
 Q
"RTN","IBACV",95,0)
 ;
"RTN","IBACV",96,0)
XTMPLST() ;get the last CV check date in ^XTMP
"RTN","IBACV",97,0)
 Q +$P($G(^XTMP("IBCVEXPDT",0)),"^",2)
"RTN","IBACV",98,0)
 ;
"RTN","IBACV",99,0)
SETXTPM(IBDFN,IBCHKDT,IBEXP,IBADMIS,IBPT) ;save info in ^XTMP
"RTN","IBACV",100,0)
 ;Input:IBDFN - patient's ien in PATIENT file
"RTN","IBACV",101,0)
 ;  IBCHKDT - check date
"RTN","IBACV",102,0)
 ;  IBEXP - CV expiration date
"RTN","IBACV",103,0)
 ;  IBADMIS - admission/movement date
"RTN","IBACV",104,0)
 ;  IBPT - patient's info
"RTN","IBACV",105,0)
 S ^XTMP("IBCVEXPDT",IBDFN)=IBDFN_"^"_IBCHKDT_"^"_IBEXP_"^"_IBADMIS_"^"_$P(IBPT,"^",1,2)
"RTN","IBACV",106,0)
 Q
"RTN","IBACV",107,0)
 ;
"RTN","IBACV",108,0)
 ;is called from IBAMTC after PROC^IBAMTC and sends e-mail alert 
"RTN","IBACV",109,0)
 ;with the list of inpatient's with CV expired
"RTN","IBACV",110,0)
CVEXMAIL(IBDT) ;send all e-mails
"RTN","IBACV",111,0)
 N Y,IBT,IBZ1,IBZ2,IBC,IBT,IBTOTAL
"RTN","IBACV",112,0)
 S IBC=0,IBTOTAL=0
"RTN","IBACV",113,0)
 ;loop thru ^XTMP
"RTN","IBACV",114,0)
 S IBZ1=0 F  S IBZ1=$O(^XTMP("IBCVEXPDT",IBZ1)) Q:+IBZ1=0  D
"RTN","IBACV",115,0)
 . D HEADER
"RTN","IBACV",116,0)
 . S IBZ2=$G(^XTMP("IBCVEXPDT",IBZ1))
"RTN","IBACV",117,0)
 . I IBZ2'="" S IBTOTAL=IBTOTAL+1 D MKEMAIL($P(IBZ2,U,3),$P(IBZ2,U,4),$P(IBZ2,U,5),$P(IBZ2,U,6))
"RTN","IBACV",118,0)
 I IBC>0 D
"RTN","IBACV",119,0)
 . D FOOTER(IBTOTAL)
"RTN","IBACV",120,0)
 . D SEND^IBACVA2
"RTN","IBACV",121,0)
 D SETXTMP0(IBDT)
"RTN","IBACV",122,0)
 Q
"RTN","IBACV",123,0)
 ;
"RTN","IBACV",124,0)
HEADER ;prints a header for the e-mail
"RTN","IBACV",125,0)
 I IBC>0 Q
"RTN","IBACV",126,0)
 S XMSUB="INPATIENTS' COMBAT VET STATUS EXPIRED"
"RTN","IBACV",127,0)
 N IBX S IBX="",$P(IBX,"=",70)=""
"RTN","IBACV",128,0)
 S IBC=IBC+1,IBT(IBC)="The following patients whose records indicate that they had CV status, were"
"RTN","IBACV",129,0)
 S IBC=IBC+1,IBT(IBC)="admitted for inpatient care with CV status, and their CV status has expired"
"RTN","IBACV",130,0)
 S IBC=IBC+1,IBT(IBC)="during their stays. Please check their CV exp date again before adjusting"
"RTN","IBACV",131,0)
 S IBC=IBC+1,IBT(IBC)="their billings accordingly."
"RTN","IBACV",132,0)
 S IBC=IBC+1,IBT(IBC)=""
"RTN","IBACV",133,0)
 S IBC=IBC+1,IBT(IBC)=$$LRJ("Patient NAME",23)_$$LRJ("SSN",14)_$$LRJ("CV exp. date",20)_$$LRJ("Date of admission",20)
"RTN","IBACV",134,0)
 S IBC=IBC+1,IBT(IBC)=IBX
"RTN","IBACV",135,0)
 Q
"RTN","IBACV",136,0)
FOOTER(IBTOTAL) ;
"RTN","IBACV",137,0)
 S IBC=IBC+1,IBT(IBC)=""
"RTN","IBACV",138,0)
 S IBC=IBC+1,IBT(IBC)="Total: "_IBTOTAL_" patient(s)"
"RTN","IBACV",139,0)
 Q
"RTN","IBACV",140,0)
 ;
"RTN","IBACV",141,0)
MKEMAIL(IBEXP,IBADM,IBNAME,IBSSN) ;
"RTN","IBACV",142,0)
 ;send e-mail alert if CV does expire today
"RTN","IBACV",143,0)
 N Y
"RTN","IBACV",144,0)
 S Y=IBEXP D DD^%DT S IBEXP=Y
"RTN","IBACV",145,0)
 S Y=IBADM D DD^%DT S IBADM=Y
"RTN","IBACV",146,0)
 S IBC=IBC+1,IBT(IBC)=$$LRJ($E(IBNAME,1,21),23)_$$LRJ(IBSSN,14)_$$LRJ(IBEXP,20)_$$LRJ(IBADM,20)
"RTN","IBACV",147,0)
 Q
"RTN","IBACV",148,0)
 ;
"RTN","IBACV",149,0)
SETXTMP0(IBDT) ;set the new "last CV check date" in ^XTMP
"RTN","IBACV",150,0)
 N IBPURGDT S IBPURGDT=+$$CHNGDATE^IBAHVE3(IBDT,+7)
"RTN","IBACV",151,0)
 K ^XTMP("IBCVEXPDT")
"RTN","IBACV",152,0)
 S ^XTMP("IBCVEXPDT",0)=IBPURGDT_"^"_IBDT_"^LAST DATE NIGHTLY JOB CHECKED COMBAT VET EXPIRATION FOR INPATIENTS"
"RTN","IBACV",153,0)
 Q
"RTN","IBACV",154,0)
 ;
"RTN","IBACV",155,0)
 ;---
"RTN","IBACV",156,0)
 ;adds spaces on right/left or truncates to make return string IBLEN characters long
"RTN","IBACV",157,0)
 ;IBST- original string
"RTN","IBACV",158,0)
 ;IBLEN - desired length
"RTN","IBACV",159,0)
 ;IBCHR -character (default = SPACE)
"RTN","IBACV",160,0)
 ;IBSIDE - on which side to add characters (default = RIGHT)
"RTN","IBACV",161,0)
LRJ(IBST,IBLEN,IBCHR,IBSIDE) ;
"RTN","IBACV",162,0)
 N Y S $P(Y,$S($L($G(IBCHR)):IBCHR,1:" "),$S(IBLEN-$L(IBST)<0:1,1:IBLEN-$L(IBST)+1))=""
"RTN","IBACV",163,0)
 Q $E($S($G(IBSIDE)="L":Y_IBST,1:IBST_Y),1,IBLEN)
"RTN","IBACV",164,0)
 ;---
"RTN","IBACV",165,0)
 ;
"RTN","IBAHVE3")
0^22^B25291751
"RTN","IBAHVE3",1,0)
IBAHVE3 ;WOIFO/SS - CV EXPIRATION REPORT ;06/16/04
"RTN","IBAHVE3",2,0)
 ;;2.0;INTEGRATED BILLING;**275**;21-MAR-94
"RTN","IBAHVE3",3,0)
 ;
"RTN","IBAHVE3",4,0)
START ;start report
"RTN","IBAHVE3",5,0)
 N Y
"RTN","IBAHVE3",6,0)
 S Y=+$$CHNGDATE(DT,-90)\1 X ^DD("DD")
"RTN","IBAHVE3",7,0)
 S DIR(0)="DA^:NOW:EX",DIR("B")=Y,DIR("A")="From DATE: " D ^DIR K DIR I $D(DIRUT) D EXIT Q
"RTN","IBAHVE3",8,0)
 S IBBEGDT=+Y
"RTN","IBAHVE3",9,0)
 S DIR(0)="DA^"_+Y_":NOW:EX"
"RTN","IBAHVE3",10,0)
 S Y=+DT\1 X ^DD("DD")
"RTN","IBAHVE3",11,0)
 S DIR("B")=Y,DIR("A")="To DATE: " D ^DIR K DIR I $D(DIRUT) D EXIT Q
"RTN","IBAHVE3",12,0)
 S IBENDDT=+Y
"RTN","IBAHVE3",13,0)
 D PRNINFO(IBBEGDT,IBENDDT)
"RTN","IBAHVE3",14,0)
 D OPEN I POP D EXIT Q
"RTN","IBAHVE3",15,0)
 I $D(IO("Q")) D QUEUED,HOME^%ZIS D END Q
"RTN","IBAHVE3",16,0)
 U IO
"RTN","IBAHVE3",17,0)
 D REPORT
"RTN","IBAHVE3",18,0)
 Q
"RTN","IBAHVE3",19,0)
 ;
"RTN","IBAHVE3",20,0)
REPORT ;
"RTN","IBAHVE3",21,0)
 D PREPRPT
"RTN","IBAHVE3",22,0)
 D PRINTRPT
"RTN","IBAHVE3",23,0)
 D END
"RTN","IBAHVE3",24,0)
 D EXIT
"RTN","IBAHVE3",25,0)
 Q
"RTN","IBAHVE3",26,0)
 ;
"RTN","IBAHVE3",27,0)
END ;
"RTN","IBAHVE3",28,0)
 I $D(ZTQUEUED) S ZTREQ="@" Q
"RTN","IBAHVE3",29,0)
 D ^%ZISC
"RTN","IBAHVE3",30,0)
 D EXIT
"RTN","IBAHVE3",31,0)
 Q
"RTN","IBAHVE3",32,0)
 ;
"RTN","IBAHVE3",33,0)
EXIT ; kills all vars
"RTN","IBAHVE3",34,0)
 K IBOUT,IBPAGE,POP,IBBEGDT,IBENDDT
"RTN","IBAHVE3",35,0)
 K IBX,IBXX,Y,DFN,IBCOL2,IBCOL3,IBCOL4,IBCOLPG,IBDONE,^TMP($J,"IBACVEXP"),DIRUT
"RTN","IBAHVE3",36,0)
 K ZTDESC,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,%ZIS,IO("Q")
"RTN","IBAHVE3",37,0)
 D KVAR^VADPT
"RTN","IBAHVE3",38,0)
 Q
"RTN","IBAHVE3",39,0)
 ;
"RTN","IBAHVE3",40,0)
OPEN ;
"RTN","IBAHVE3",41,0)
 S %ZIS="QM" D ^%ZIS
"RTN","IBAHVE3",42,0)
 Q
"RTN","IBAHVE3",43,0)
 ;
"RTN","IBAHVE3",44,0)
QUEUED ;
"RTN","IBAHVE3",45,0)
 S ZTRTN="REPORT^IBAHVE3",ZTDESC="Current Continuous Pt Report",ZTSAVE("IBENDDT")="",ZTSAVE("IBBEGDT")=""
"RTN","IBAHVE3",46,0)
 D ^%ZTLOAD W !!,$S($D(ZTSK):"Request Queued!",1:"Request Cancelled")
"RTN","IBAHVE3",47,0)
 Q
"RTN","IBAHVE3",48,0)
 ;
"RTN","IBAHVE3",49,0)
PREPRPT ;prepare data 
"RTN","IBAHVE3",50,0)
 ; IBBEGDT - begin date ,IBENDDT - end date
"RTN","IBAHVE3",51,0)
 S IBCOL2=23,IBCOL3=37,IBCOL4=57,IBCOLPG=70,IBDONE=0
"RTN","IBAHVE3",52,0)
 N IBDFN,IBDT,IBDFN,IBADMDAT,IB405,IBDISCH,IBCVSTAT,IBEXPDT
"RTN","IBAHVE3",53,0)
 ;scan all admission before ENDDATE
"RTN","IBAHVE3",54,0)
 S IBDT=0 F  S IBDT=$O(^DGPM("AMV1",IBDT)) Q:+IBDT=0  Q:IBDT>IBENDDT  D
"RTN","IBAHVE3",55,0)
 . S IBDFN=0 F  S IBDFN=$O(^DGPM("AMV1",IBDT,IBDFN)) Q:+IBDFN=0  D
"RTN","IBAHVE3",56,0)
 . . S IB405=0 F  S IB405=$O(^DGPM("AMV1",IBDT,IBDFN,IB405)) Q:+IB405=0  D
"RTN","IBAHVE3",57,0)
 . . . S IBADMDAT=$G(^DGPM(IB405,0)) D:IBADMDAT>0
"RTN","IBAHVE3",58,0)
 . . . . S IBDISCH=+$G(^DGPM(+$P(IBADMDAT,U,17),0))
"RTN","IBAHVE3",59,0)
 . . . . ;don't include if discharge before IBBEGDT
"RTN","IBAHVE3",60,0)
 . . . . I IBDISCH,IBDISCH<IBBEGDT Q
"RTN","IBAHVE3",61,0)
 . . . . S IBCVSTAT=$$CVEDT^IBACV(IBDFN)
"RTN","IBAHVE3",62,0)
 . . . . I '$P(IBCVSTAT,U,3) Q  ;check if ever had CV
"RTN","IBAHVE3",63,0)
 . . . . S IBEXPDT=+$P(IBCVSTAT,U,2)
"RTN","IBAHVE3",64,0)
 . . . . I IBEXPDT=0 Q
"RTN","IBAHVE3",65,0)
 . . . . I IBEXPDT<IBBEGDT Q  ;if expired before IBBEGDT
"RTN","IBAHVE3",66,0)
 . . . . I IBEXPDT>IBENDDT Q  ;if expired after IBENDDT
"RTN","IBAHVE3",67,0)
 . . . . I IBDISCH,IBEXPDT>IBDISCH Q  ;if expired after discharge
"RTN","IBAHVE3",68,0)
 . . . . I IBEXPDT<IBADMDAT Q  ;if expired before admission
"RTN","IBAHVE3",69,0)
 . . . . D SETTMP(IBDFN,+IBADMDAT,+$P(IBADMDAT,U,6),IBEXPDT)
"RTN","IBAHVE3",70,0)
 Q
"RTN","IBAHVE3",71,0)
 ;
"RTN","IBAHVE3",72,0)
SETTMP(IBDFN,IBADMDT,IBWARD,IBCVDT) ;additional check and set ^TMP
"RTN","IBAHVE3",73,0)
 ;IBDFN -Pat ID,IBADMDT-admission date
"RTN","IBAHVE3",74,0)
 ;IBWARD-ward location
"RTN","IBAHVE3",75,0)
 I '$D(^DPT(IBDFN,0)) Q
"RTN","IBAHVE3",76,0)
 D
"RTN","IBAHVE3",77,0)
 . N VADM,VA,VAERR,Y
"RTN","IBAHVE3",78,0)
 . N DFN,IBPAT,IBSSN,IBADMIS,IBCVEXP
"RTN","IBAHVE3",79,0)
 . S DFN=+IBDFN
"RTN","IBAHVE3",80,0)
 . D DEM^VADPT
"RTN","IBAHVE3",81,0)
 . S IBPAT=$G(VADM(1))
"RTN","IBAHVE3",82,0)
 . S IBSSN=$P($G(VADM(2)),"^",2)
"RTN","IBAHVE3",83,0)
 . S Y=IBADMDT\1 X ^DD("DD") S IBADMIS=Y ;date in readable form
"RTN","IBAHVE3",84,0)
 . S Y=IBCVDT\1 X ^DD("DD") S IBCVEXP=Y ;date in readable form
"RTN","IBAHVE3",85,0)
 . S ^TMP($J,"IBACVEXP",IBDFN,IBADMDT)=IBPAT_"^"_IBSSN_"^"_IBCVEXP_"^"_IBADMIS
"RTN","IBAHVE3",86,0)
 Q
"RTN","IBAHVE3",87,0)
 ;
"RTN","IBAHVE3",88,0)
PRINTRPT ;print the report
"RTN","IBAHVE3",89,0)
 S Y=DT X ^DD("DD")
"RTN","IBAHVE3",90,0)
 S IBPAGE=1,IBOUT=""
"RTN","IBAHVE3",91,0)
 D HEADER
"RTN","IBAHVE3",92,0)
 N IBADM,IBDFN,IBTOTAL
"RTN","IBAHVE3",93,0)
 S IBTOTAL=0
"RTN","IBAHVE3",94,0)
 S IBDFN=0 F  S IBDFN=$O(^TMP($J,"IBACVEXP",IBDFN)) Q:+IBDFN=0!(IBDONE)  D
"RTN","IBAHVE3",95,0)
 . S IBADM=0 F  S IBADM=$O(^TMP($J,"IBACVEXP",IBDFN,IBADM)) Q:+IBADM=0!(IBDONE)  D
"RTN","IBAHVE3",96,0)
 . . D PRNTLINE($G(^TMP($J,"IBACVEXP",IBDFN,IBADM))) S IBTOTAL=IBTOTAL+1
"RTN","IBAHVE3",97,0)
 I 'IBDONE D PRNTLINE("Total: "_IBTOTAL_" patient(s)")
"RTN","IBAHVE3",98,0)
 Q
"RTN","IBAHVE3",99,0)
 ;
"RTN","IBAHVE3",100,0)
HEADER ;print the header
"RTN","IBAHVE3",101,0)
 I IBPAGE>1,($E(IOST,1,2)="C-") S DIR(0)="E" D ^DIR K DIR I $D(DUOUT) S IBDONE=1 K DUOUT Q
"RTN","IBAHVE3",102,0)
 I $E(IOST,1,2)["C-"!(IBPAGE>1) W @IOF
"RTN","IBAHVE3",103,0)
 W !,?8,"***Inpatient Combat Veteran Status Expiration Report***",?IBCOLPG,"PAGE ",IBPAGE
"RTN","IBAHVE3",104,0)
 W !,?14,"Report from " S Y=IBBEGDT\1 X ^DD("DD") W Y
"RTN","IBAHVE3",105,0)
 W " to " S Y=IBENDDT\1 X ^DD("DD") W Y
"RTN","IBAHVE3",106,0)
 W !,?15,"Run Date/Time: " D NOW^%DTC S Y=% X ^DD("DD") W Y
"RTN","IBAHVE3",107,0)
 W !!,"Patient NAME",?IBCOL2,"SSN",?IBCOL3,"CV exp. date",?IBCOL4,"Date of admission"
"RTN","IBAHVE3",108,0)
 W !!
"RTN","IBAHVE3",109,0)
 S IBX="",$P(IBX,"=",IOM)="" W IBX,!
"RTN","IBAHVE3",110,0)
 S IBPAGE=IBPAGE+1
"RTN","IBAHVE3",111,0)
 Q
"RTN","IBAHVE3",112,0)
 ;
"RTN","IBAHVE3",113,0)
PRNTLINE(IBRECORD) ;print line of the report
"RTN","IBAHVE3",114,0)
 ;Patient NAME
"RTN","IBAHVE3",115,0)
 W $E($P(IBRECORD,"^",1),1,21)
"RTN","IBAHVE3",116,0)
 ;SSN
"RTN","IBAHVE3",117,0)
 W ?IBCOL2,$E($P(IBRECORD,"^",2),1,11)
"RTN","IBAHVE3",118,0)
 ;CV exp. date
"RTN","IBAHVE3",119,0)
 W ?IBCOL3,$E($P(IBRECORD,"^",3),1,14)
"RTN","IBAHVE3",120,0)
 ;Date of admission
"RTN","IBAHVE3",121,0)
 W ?IBCOL4,$E($P(IBRECORD,"^",4),1,14)
"RTN","IBAHVE3",122,0)
 W !
"RTN","IBAHVE3",123,0)
 D:$Y+4>IOSL HEADER
"RTN","IBAHVE3",124,0)
 Q
"RTN","IBAHVE3",125,0)
 ;
"RTN","IBAHVE3",126,0)
CHNGDATE(DATE,CHNG) ;
"RTN","IBAHVE3",127,0)
 N X,X1,X2
"RTN","IBAHVE3",128,0)
 S X1=DATE,X2=CHNG D C^%DTC
"RTN","IBAHVE3",129,0)
 Q X
"RTN","IBAHVE3",130,0)
 ;
"RTN","IBAHVE3",131,0)
 ;
"RTN","IBAHVE3",132,0)
PRNINFO(IBBEG,IBEND) ;
"RTN","IBAHVE3",133,0)
 N Y
"RTN","IBAHVE3",134,0)
 W !,"The following patients whose records indicate that they had CV status, were"
"RTN","IBAHVE3",135,0)
 W !,"admitted for inpatient care with CV status, and their CV status has expired"
"RTN","IBAHVE3",136,0)
 W !,"during their stays in the period of "
"RTN","IBAHVE3",137,0)
 S Y=IBBEG X ^DD("DD")
"RTN","IBAHVE3",138,0)
 W Y," - "
"RTN","IBAHVE3",139,0)
 S Y=IBEND X ^DD("DD")
"RTN","IBAHVE3",140,0)
 W Y
"RTN","IBAHVE3",141,0)
 Q
"RTN","IBAHVE3",142,0)
 ;
"RTN","IBAMTC")
0^19^B23660778
"RTN","IBAMTC",1,0)
IBAMTC ;ALB/CPM-MEANS TEST NIGHTLY COMPILATION JOB ;09-OCT-91
"RTN","IBAMTC",2,0)
V ;;2.0;INTEGRATED BILLING;**34,52,70,93,100,118,115,132,150,153,137,176,215,275**;21-MAR-94
"RTN","IBAMTC",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBAMTC",4,0)
 ;
"RTN","IBAMTC",5,0)
INIT ; Entry point - initialize variables and parameters
"RTN","IBAMTC",6,0)
 ;
"RTN","IBAMTC",7,0)
 ;***
"RTN","IBAMTC",8,0)
 ;S XRTL=$ZU(0),XRTN="IBAMTC-1" D T0^%ZOSV ;start rt clock
"RTN","IBAMTC",9,0)
 ;
"RTN","IBAMTC",10,0)
 D NIGHTLY^IBTRKR ; claims tracking nightly update
"RTN","IBAMTC",11,0)
 ;
"RTN","IBAMTC",12,0)
 D ^IBCD ; automated biller
"RTN","IBAMTC",13,0)
 ;
"RTN","IBAMTC",14,0)
 D RELPR^IBAMTV3 ; auto-release patient charges on hold at least 60 days
"RTN","IBAMTC",15,0)
 ;
"RTN","IBAMTC",16,0)
 D EN^IBOHRL ; auto-release patient charges on hold longer than 90 days
"RTN","IBAMTC",17,0)
 ;
"RTN","IBAMTC",18,0)
 K IBDT D BJ^IBJDE  ; Automated DM extract monthly background job.
"RTN","IBAMTC",19,0)
 ;
"RTN","IBAMTC",20,0)
 D ^IBATEI1 ; transfer pricing background job
"RTN","IBAMTC",21,0)
 ;
"RTN","IBAMTC",22,0)
 D NIGHT^IBARXMA ; transmit copay cap info
"RTN","IBAMTC",23,0)
 ;
"RTN","IBAMTC",24,0)
 D NOW^%DTC S IBAFY=$$FY^IBOUTL(X),DT=X,U="^"
"RTN","IBAMTC",25,0)
 S (IBERRN,IBWHER,IBJOB,IBY,Y)=1,IBCNT=0 K ^TMP($J,"IBAMTC")
"RTN","IBAMTC",26,0)
 D SITE^IBAUTL I Y<1 S IBY=Y D ERR G CLEAN
"RTN","IBAMTC",27,0)
 D SERV^IBAUTL2 I IBY<1 D ERR G CLEAN
"RTN","IBAMTC",28,0)
 ;
"RTN","IBAMTC",29,0)
 ; Compile Means Test copay and per diem charges for all inpatients
"RTN","IBAMTC",30,0)
 S (IBWARD,DFN)="" F  S IBWARD=$O(^DPT("CN",IBWARD)) Q:IBWARD=""  F  S DFN=$O(^DPT("CN",IBWARD,DFN)) Q:'DFN  W !,DFN S IBA=^(DFN),IBY=1 D PROC
"RTN","IBAMTC",31,0)
 ;
"RTN","IBAMTC",32,0)
 ;send inpatients' CV (CombatVet) expiration e-mail alert
"RTN","IBAMTC",33,0)
 D CVEXMAIL^IBACV(DT)
"RTN","IBAMTC",34,0)
 ;
"RTN","IBAMTC",35,0)
 ;check & start LTC Monthly Job LTC if necessary
"RTN","IBAMTC",36,0)
 D NJ^IBAECN1
"RTN","IBAMTC",37,0)
 ;
"RTN","IBAMTC",38,0)
 D EN^IBCE ; Transmit electronic bills
"RTN","IBAMTC",39,0)
 ; Clean up expired Means Test billing clocks
"RTN","IBAMTC",40,0)
CLEAN S %H=+$H-1 D YMD^%DTC S IBDT=X,(IBN,DFN)=0,IBWHER=23
"RTN","IBAMTC",41,0)
 F  S DFN=$O(^IBE(351,"ACT",DFN)) Q:'DFN  D
"RTN","IBAMTC",42,0)
 . F  S IBN=$O(^IBE(351,"ACT",DFN,IBN)) Q:'IBN  D
"RTN","IBAMTC",43,0)
 ..  S IBY=1,X1=IBDT,(X2,IBCLDT)=+$P($G(^IBE(351,+IBN,0)),"^",3) D ^%DTC
"RTN","IBAMTC",44,0)
 ..  I X>364 S IBCLDA=IBN D CLOCKCL^IBAUTL3,ERR:IBY<1
"RTN","IBAMTC",45,0)
 ;
"RTN","IBAMTC",46,0)
 ; Close out incomplete events where the patient has been discharged,
"RTN","IBAMTC",47,0)
 ; pass the related charges if they appear correct, and send a bulletin
"RTN","IBAMTC",48,0)
 ; - also, send bulletins on old incomplete charges where there is no
"RTN","IBAMTC",49,0)
 ; incomplete event
"RTN","IBAMTC",50,0)
 D MAIN^IBAMTC2
"RTN","IBAMTC",51,0)
 ;
"RTN","IBAMTC",52,0)
 ;D ^IBAMTC1
"RTN","IBAMTC",53,0)
 ;
"RTN","IBAMTC",54,0)
 ; Send bulletin reporting job completion
"RTN","IBAMTC",55,0)
 D BULL^IBAMTC1
"RTN","IBAMTC",56,0)
 ;
"RTN","IBAMTC",57,0)
 ; -- purge alerts
"RTN","IBAMTC",58,0)
 D PURGE^IBAERR3
"RTN","IBAMTC",59,0)
 ;
"RTN","IBAMTC",60,0)
 ; Monitor special inpatient billing cases
"RTN","IBAMTC",61,0)
 D BGJ^IBAMTI
"RTN","IBAMTC",62,0)
 ;
"RTN","IBAMTC",63,0)
 ; Print Pharmacy Copay Exemption Income Test Reminder Letters
"RTN","IBAMTC",64,0)
 D EN^IBARXEL
"RTN","IBAMTC",65,0)
 ;
"RTN","IBAMTC",66,0)
 ; Kill variables and quit.
"RTN","IBAMTC",67,0)
 D KILL1
"RTN","IBAMTC",68,0)
 ;
"RTN","IBAMTC",69,0)
 I $D(ZTQUEUED),$G(ZTSK) D KILL^%ZTLOAD
"RTN","IBAMTC",70,0)
 ;***
"RTN","IBAMTC",71,0)
 ;I $D(XRT0) S:'$D(XRTN) XRTN="IBAMTC" D T1^%ZOSV ;stop rt clock
"RTN","IBAMTC",72,0)
 ;
"RTN","IBAMTC",73,0)
 Q
"RTN","IBAMTC",74,0)
 ;
"RTN","IBAMTC",75,0)
 ;
"RTN","IBAMTC",76,0)
PROC ; Process all currently admitted patients.
"RTN","IBAMTC",77,0)
 ;
"RTN","IBAMTC",78,0)
 D IFCVEXP^IBACV(DFN,DT,IBA) ;if CV has expired (see CVEXMAIL^IBACV)
"RTN","IBAMTC",79,0)
 ;--
"RTN","IBAMTC",80,0)
 ;1) checks effective date for LTC legislation.
"RTN","IBAMTC",81,0)
 ;2) determine current treating specialty (TS) for the 
"RTN","IBAMTC",82,0)
 ;"original" admission.
"RTN","IBAMTC",83,0)
 ;if TS is LTC: 
"RTN","IBAMTC",84,0)
 ;  - creates new LTC #350 parent event entry if necessary.
"RTN","IBAMTC",85,0)
 ;NOTE: It doesn't stop MT billing for LTC. CALC^IBAUTL4 does it.
"RTN","IBAMTC",86,0)
 I $$ISLTCADM^IBAECN1(DFN,IBA)
"RTN","IBAMTC",87,0)
 ;--
"RTN","IBAMTC",88,0)
 D ORIG  ; find "original" admission date
"RTN","IBAMTC",89,0)
 Q:$$BILST^DGMTUB(DFN)<IBADMDT  ; pat. was last billable before admission
"RTN","IBAMTC",90,0)
 Q:IBADMDT\1=DT  ; patient was admitted today - process tomorrow
"RTN","IBAMTC",91,0)
 Q:+$$MVT^DGPMOBS(IBA)  ; admitted for Observation & Examination
"RTN","IBAMTC",92,0)
 Q:$O(^IBE(351.2,"AC",IBA,0))  ; skip special inpatient admissions
"RTN","IBAMTC",93,0)
 ;
"RTN","IBAMTC",94,0)
 ; - if vet is SC, create a Special Inpatient Billing Case
"RTN","IBAMTC",95,0)
 ;   in file #351.2 (use code 3 for SC, as it is changed to 4 in IBAMTI)
"RTN","IBAMTC",96,0)
 D ELIG^VADPT I VAEL(3) D ADM^IBAMTI(DFN,IBA,3) Q
"RTN","IBAMTC",97,0)
 ;
"RTN","IBAMTC",98,0)
 ; - gather event information
"RTN","IBAMTC",99,0)
 D EVFIND^IBAUTL3 I 'IBEVDA D BSEC Q:'IBBS  ; wasn't billable yesterday
"RTN","IBAMTC",100,0)
 S X=IBADMDT D H^%DTC S IBBDT=%H D:'IBEVDA LAST^IBAUTL5
"RTN","IBAMTC",101,0)
 I IBEVDA,IBEVCAL S X1=IBEVCAL,X2=1 D C^%DTC S IBBDT=%H
"RTN","IBAMTC",102,0)
 S IBEDT=+$H-1
"RTN","IBAMTC",103,0)
 ; - gather clock information
"RTN","IBAMTC",104,0)
 S IBWHER=24 D CLOCK^IBAUTL3 I IBY<1 D ERR G PROCQ
"RTN","IBAMTC",105,0)
 I IBCLDA S X=IBCLDT D H^%DTC S IBCLCT=IBBDT-%H
"RTN","IBAMTC",106,0)
 ; - build charges for inpatient days
"RTN","IBAMTC",107,0)
 D ^IBAUTL4 I IBY<1 D ERR G PROCQ
"RTN","IBAMTC",108,0)
 ; - pass per diem if over 30 days old, or both per diem and the copay
"RTN","IBAMTC",109,0)
 ; - if 4 days from patient's statement date; update event, clock
"RTN","IBAMTC",110,0)
 S IBWHER=22
"RTN","IBAMTC",111,0)
 I $G(IBCHPDA),$P($G(^IB(+IBCHPDA,0)),"^",6)>30!($$STD^IBAUTL5(DFN)) S IBNOS=IBCHPDA D FILER^IBAUTL5 I IBY<1 D ERR G PROCQ
"RTN","IBAMTC",112,0)
 I $G(IBCHCDA),$$STD^IBAUTL5(DFN) S IBNOS=IBCHCDA D FILER^IBAUTL5 I IBY<1 D ERR G PROCQ
"RTN","IBAMTC",113,0)
 I IBEVDA,$D(IBDT) S IBEVCLD=IBDT D EVUPD^IBAUTL3
"RTN","IBAMTC",114,0)
 I IBCLDA D CLUPD^IBAUTL3
"RTN","IBAMTC",115,0)
PROCQ D KILL Q
"RTN","IBAMTC",116,0)
 ;
"RTN","IBAMTC",117,0)
BSEC ; Determine patient's bedsection for the previous day.
"RTN","IBAMTC",118,0)
 S X1=DT,X2=-1 D C^%DTC
"RTN","IBAMTC",119,0)
 S VAIP("D")=X_.2359 D IN5^VADPT S IBBS=$$SECT^IBAUTL5(+VAIP(8)) Q
"RTN","IBAMTC",120,0)
 ;
"RTN","IBAMTC",121,0)
ERR ; Error processing.  Input:  IBY, IBWHER, IBCNT
"RTN","IBAMTC",122,0)
 S IBDUZ=DUZ,IBCNT=IBCNT+1 D ^IBAERR1 K IBDUZ Q
"RTN","IBAMTC",123,0)
 ;S ^TMP($J,"IBAMTC","E",IBERRN)=$P(IBY,"^",2)_"^"_$S($D(DFN):DFN,1:"")_"^"_IBWHER,IBERRN=IBERRN+1 Q
"RTN","IBAMTC",124,0)
 ;
"RTN","IBAMTC",125,0)
ORIG ; Find first admission date, considering ASIH movements
"RTN","IBAMTC",126,0)
 ;  Input:  IBA    Output:  IBADMDT
"RTN","IBAMTC",127,0)
 N X,Y,Z S Z=IBA
"RTN","IBAMTC",128,0)
 F  S X=$G(^DGPM(Z,0)),Y=$P(X,"^",21) Q:Y=""  S Z=+$P($G(^DGPM(Y,0)),"^",14)
"RTN","IBAMTC",129,0)
 S IBADMDT=+X Q
"RTN","IBAMTC",130,0)
 ;
"RTN","IBAMTC",131,0)
KILL1 ; Kill all IB variables.
"RTN","IBAMTC",132,0)
 K VAERR,VAEL,VAIP,IBA,IBADMDT,IBAFY,IBATYP,IBBDT,IBBS,IBCHARG,IBCHG,IBCNT,IBCUR,IBDESC,IBDISDT,IBDT,IBDUZ,IBFAC,IBI,IBIL,IBJOB,IBLC,IBMAX
"RTN","IBAMTC",133,0)
 K IBN,IBNOS,IBSAVBS,IBSEQNO,IBSERV,IBSITE,IBSL,IBTRAN,IBX,IBY,IBWHER,IBWARD,IBEDT,IBCHCTY,IBCHPDE,IBERRN,IBASIH,IBRTED
"RTN","IBAMTC",134,0)
KILL ; Kill all IB variables needed to build charges.
"RTN","IBAMTC",135,0)
 K IBCLCT,IBCLDA,IBCLDT,IBCLDAY,IBCLDOL,IBCHPDA,IBCHCDA,IBCHG,IBCHFR,IBCHTO,IBCHTOTL,IBBS,IBNH
"RTN","IBAMTC",136,0)
 K IBEVDA,IBEVDT,IBEVCLD,IBEVCAL,IBEVNEW,IBEVOLD,IBMED,IBTOTL,IBDESC,IBIL,IBTRAN,IBATYP,IBDATE
"RTN","IBAMTC",137,0)
 Q
"RTN","IBARXEU1")
0^17^B13926560
"RTN","IBARXEU1",1,0)
IBARXEU1 ;AAS/ALB - RX EXEMPTION UTILITY ROUTINE (CONT.) ;2-NOV-92
"RTN","IBARXEU1",2,0)
 ;;2.0;INTEGRATED BILLING;**26,112,74,275**;21-MAR-94
"RTN","IBARXEU1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBARXEU1",4,0)
 ;
"RTN","IBARXEU1",5,0)
STATUS(DFN,IBDT) ; -- Determine medication copayment exemption status
"RTN","IBARXEU1",6,0)
 ; -- requests data from MAS
"RTN","IBARXEU1",7,0)
 ;
"RTN","IBARXEU1",8,0)
 ;    returns :        = exemption reason (pointer to 354.2) ^ date
"RTN","IBARXEU1",9,0)
 ;
"RTN","IBARXEU1",10,0)
 N X,Y
"RTN","IBARXEU1",11,0)
 I $G(IBDT)="" S IBDT=DT
"RTN","IBARXEU1",12,0)
 S X=$$AUTOST(DFN,IBDT)
"RTN","IBARXEU1",13,0)
 I X'="" G STATUSQ
"RTN","IBARXEU1",14,0)
 S X=$$INCST(DFN,IBDT)
"RTN","IBARXEU1",15,0)
STATUSQ Q X
"RTN","IBARXEU1",16,0)
 ;
"RTN","IBARXEU1",17,0)
AUTOST(DFN,IBDT) ; -- Determine automatically exempt patients.
"RTN","IBARXEU1",18,0)
 ;    input :     dfn  =  patient file pointer
"RTN","IBARXEU1",19,0)
 ;               ibdt  =  internal form of effective date
"RTN","IBARXEU1",20,0)
 ;
"RTN","IBARXEU1",21,0)
 ;    returns :        =  exemption reason (pointer to 354.2) ^ date
"RTN","IBARXEU1",22,0)
 ;                        null if no autostatus
"RTN","IBARXEU1",23,0)
 ;
"RTN","IBARXEU1",24,0)
 N IBEXREA,IBEXMT,I
"RTN","IBARXEU1",25,0)
 S (IBEXREA,IBEXMT)=""
"RTN","IBARXEU1",26,0)
 I $G(IBDT)="" S IBDT=DT
"RTN","IBARXEU1",27,0)
 ;
"RTN","IBARXEU1",28,0)
 ; -- ask mas if in receipt of pension/a&a/hb, etc.
"RTN","IBARXEU1",29,0)
 ;    the automatic determinations
"RTN","IBARXEU1",30,0)
 ;    returns:
"RTN","IBARXEU1",31,0)
 ; sc>50% ^ rec a&a ^ rec hb ^ rec pen ^ n/a ^ non-vet ^ ^ POW ^ Unempl. 
"RTN","IBARXEU1",32,0)
 ;   1         1        1         1                1        1      1
"RTN","IBARXEU1",33,0)
 ;    pieces =1 if true
"RTN","IBARXEU1",34,0)
 S IBEXMT=$$AUTOINFO^DGMTCOU1(DFN) I IBEXMT="" G AUTOSTQ
"RTN","IBARXEU1",35,0)
 I IBEXMT[1 F I=1,2,3,4,6,8,9 I $P(IBEXMT,"^",I)=1 S IBEXREA=I*10 Q  ;lookup code is piece position time 10
"RTN","IBARXEU1",36,0)
 ;
"RTN","IBARXEU1",37,0)
AUTOSTQ I IBEXREA="" Q IBEXREA
"RTN","IBARXEU1",38,0)
 Q $O(^IBE(354.2,"ACODE",+IBEXREA,0))_"^"_IBDT
"RTN","IBARXEU1",39,0)
 ;
"RTN","IBARXEU1",40,0)
 ;
"RTN","IBARXEU1",41,0)
INCST(DFN,IBDT) ; -- return medication copayment exemption reason/date
"RTN","IBARXEU1",42,0)
 ; -- ask mas for income data
"RTN","IBARXEU1",43,0)
 ;
"RTN","IBARXEU1",44,0)
 ;    returns :  = exemption reason (pointer to 354.2) ^ date
"RTN","IBARXEU1",45,0)
 ;
"RTN","IBARXEU1",46,0)
 N IBDATA,X
"RTN","IBARXEU1",47,0)
 S IBDATA=$G(^DGMT(408.31,+$$LST^DGMTCOU1(DFN,IBDT,3),0)) ;get any test
"RTN","IBARXEU1",48,0)
 I $$PLUS^IBARXEU0(+IBDATA)<IBDT S X=$O(^IBE(354.2,"ACODE",210,0))_"^"_IBDT G INCSTQ ; means test too old -no data
"RTN","IBARXEU1",49,0)
 I $$NETW^IBARXEU1 S X=$$MTCOMP^IBARXEU5($$INCDT(IBDATA),IBDATA)
"RTN","IBARXEU1",50,0)
 I '$$NETW^IBARXEU1 S X=$$INCDT(IBDATA),X=$P(X,"^",3)_"^"_$P(X,"^",2)
"RTN","IBARXEU1",51,0)
INCSTQ Q X
"RTN","IBARXEU1",52,0)
 ;
"RTN","IBARXEU1",53,0)
INCDT(IBDATA) ; -- calcualtes copay exemption status based on income
"RTN","IBARXEU1",54,0)
 ; and net worth
"RTN","IBARXEU1",55,0)
 ;    input  := zeroth node from 408.31
"RTN","IBARXEU1",56,0)
 ;    output := 1 = exempt    ^date of test^ exemption reason 
"RTN","IBARXEU1",57,0)
 ;              2 = non-exempt^...
"RTN","IBARXEU1",58,0)
 ;              3 = pending adjudication (if active)^...
"RTN","IBARXEU1",59,0)
 ;
"RTN","IBARXEU1",60,0)
 N X,IBDT,IBINCOM,IBEXREA,IBDEPEN,IBNETW,IBTABLE,IBLEVEL,IBTHRES
"RTN","IBARXEU1",61,0)
 I '$D(DFN) N DFN S DFN=$P(IBDATA,"^",2)
"RTN","IBARXEU1",62,0)
 S IBEXREA=""
"RTN","IBARXEU1",63,0)
 ;
"RTN","IBARXEU1",64,0)
 ; -- if test incomplete, no longer required, no longer applicable, or
"RTN","IBARXEU1",65,0)
 ;    required set to no income data 
"RTN","IBARXEU1",66,0)
 ;    autoexempt test should be done first before getting to here
"RTN","IBARXEU1",67,0)
 S X=$P(IBDATA,"^",3) I X=1!(X=3)!(X=10)!(X=9)!($P(IBDATA,"^",14)) S IBEXREA=$S($P(IBDATA,"^",14):110,1:210) G NO
"RTN","IBARXEU1",68,0)
 ;
"RTN","IBARXEU1",69,0)
 S IBDT=+IBDATA
"RTN","IBARXEU1",70,0)
 S IBINCOM=$P(IBDATA,"^",4)-$P(IBDATA,"^",15) I IBINCOM<0 S IBINCOM=0
"RTN","IBARXEU1",71,0)
 S IBDEPEN=$P(IBDATA,"^",18),IBNETW=$P(IBDATA,"^",5)
"RTN","IBARXEU1",72,0)
 ;
"RTN","IBARXEU1",73,0)
 ; -- get A&A income level
"RTN","IBARXEU1",74,0)
 ;S IBLEVEL=$$THRES(IBDT,2,IBDEPEN)
"RTN","IBARXEU1",75,0)
 S IBLEVEL=$$THRES(IBDT,$S($E(IBDT,1,5)'<29612:1,1:2),IBDEPEN)
"RTN","IBARXEU1",76,0)
 I $P(IBLEVEL,"^",3) S IBPRIOR=$P(IBLEVEL,"^",3)
"RTN","IBARXEU1",77,0)
 ;
"RTN","IBARXEU1",78,0)
 S IBEXREA=120 ; low income
"RTN","IBARXEU1",79,0)
 I IBINCOM>+IBLEVEL S IBEXREA=110 G NO ;high income not exempt
"RTN","IBARXEU1",80,0)
 ;
"RTN","IBARXEU1",81,0)
 I '$$NETW G NO
"RTN","IBARXEU1",82,0)
 ;
"RTN","IBARXEU1",83,0)
 ; -- get networth threshold amount
"RTN","IBARXEU1",84,0)
 S IBTHRES=+$$THRES(IBDT,4,0)
"RTN","IBARXEU1",85,0)
 ; -- low income check for net worth
"RTN","IBARXEU1",86,0)
 S IBEXREA=$S((IBINCOM+IBNETW)>IBTHRES:130,1:120)
"RTN","IBARXEU1",87,0)
 ;
"RTN","IBARXEU1",88,0)
NO ; -- not enough information
"RTN","IBARXEU1",89,0)
 I IBEXREA="" S IBEXREA=210
"RTN","IBARXEU1",90,0)
 ;
"RTN","IBARXEU1",91,0)
 I $$NETW S Y=$S(IBEXREA=110:2,IBEXREA=120:1,IBEXREA=130:3,1:2)
"RTN","IBARXEU1",92,0)
 I '$$NETW S Y=$S(IBEXREA=120:1,1:2)
"RTN","IBARXEU1",93,0)
 ;
"RTN","IBARXEU1",94,0)
INCDTQ Q Y_"^"_+IBDATA_"^"_$O(^IBE(354.2,"ACODE",+IBEXREA,0))
"RTN","IBARXEU1",95,0)
 ;
"RTN","IBARXEU1",96,0)
THRES(DATE,TYPE,DEPEND) ; -- return threshold amount 
"RTN","IBARXEU1",97,0)
 ;
"RTN","IBARXEU1",98,0)
 ; -- if date is less than 12/1/92 will use 12/1 92 rates
"RTN","IBARXEU1",99,0)
 ;     date =: fileman format of effective date
"RTN","IBARXEU1",100,0)
 ;     type =: 2= pension plus A&A   1992 thru 1995
"RTN","IBARXEU1",101,0)
 ;     type =: 1= basic pension 1996 to present
"RTN","IBARXEU1",102,0)
 ;     depend =: number of dependents
"RTN","IBARXEU1",103,0)
 ;
"RTN","IBARXEU1",104,0)
 ; -- returns rate^effective date^prior year
"RTN","IBARXEU1",105,0)
 ;
"RTN","IBARXEU1",106,0)
 I DATE<2921201 S DATE=2921201 ; use threshold rates from 12/1/92
"RTN","IBARXEU1",107,0)
 N IBTABLE,IBLEVEL,IBPRIOR
"RTN","IBARXEU1",108,0)
 S IBLEVEL=""
"RTN","IBARXEU1",109,0)
 ; -- get entry to determine income amounts
"RTN","IBARXEU1",110,0)
 S IBTABLE=$G(^IBE(354.3,+$O(^(+$O(^IBE(354.3,"AIVDT",TYPE,-(DATE+.000001))),0)),0))
"RTN","IBARXEU1",111,0)
 G:IBTABLE="" THRESQ
"RTN","IBARXEU1",112,0)
 I TYPE=4 S DEPEND=0
"RTN","IBARXEU1",113,0)
 ;
"RTN","IBARXEU1",114,0)
 ; --see if rate is for prior year
"RTN","IBARXEU1",115,0)
 S IBPRIOR="" I $$PLUS^IBARXEU0(+IBTABLE)<DATE S IBPRIOR=+IBTABLE
"RTN","IBARXEU1",116,0)
 ;
"RTN","IBARXEU1",117,0)
 ; -- rates begin in piece 3 for veteran alone, piece 4 for 1 dependent..
"RTN","IBARXEU1",118,0)
 S IBLEVEL=$S(DEPEND<9:$P(IBTABLE,"^",DEPEND+3),1:"")
"RTN","IBARXEU1",119,0)
 I IBLEVEL="" S IBLEVEL=$P(IBTABLE,"^",4)+((DEPEND-1)*$P(IBTABLE,"^",12))
"RTN","IBARXEU1",120,0)
THRESQ Q IBLEVEL_"^"_+IBTABLE_"^"_IBPRIOR
"RTN","IBARXEU1",121,0)
 ;
"RTN","IBARXEU1",122,0)
NETW() ; -- use networth in determining copay exemptions - specs keep changing
"RTN","IBARXEU1",123,0)
 ;    returns 1 if should use networth in exemption determination
"RTN","IBARXEU1",124,0)
 ;    returns 0 if should not use networth in exemption
"RTN","IBARXEU1",125,0)
 Q 0
"RTN","IBTRKR3")
0^13^B28801835
"RTN","IBTRKR3",1,0)
IBTRKR3 ;ALB/AAS - CLAIMS TRACKING - ADD/TRACK RX FILLS ;13-AUG-93
"RTN","IBTRKR3",2,0)
 ;;2.0;INTEGRATED BILLING;**13,43,121,160,247,275**;21-MAR-94
"RTN","IBTRKR3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBTRKR3",4,0)
 ;
"RTN","IBTRKR3",5,0)
% ; -- entry point for nightly background job
"RTN","IBTRKR3",6,0)
 N IBTSBDT,IBTSEDT
"RTN","IBTRKR3",7,0)
 S IBTSBDT=$$FMADD^XLFDT(DT,-14)-.1
"RTN","IBTRKR3",8,0)
 S IBTSEDT=$$FMADD^XLFDT(DT,-7)+.9
"RTN","IBTRKR3",9,0)
 D EN1
"RTN","IBTRKR3",10,0)
 Q
"RTN","IBTRKR3",11,0)
 ;
"RTN","IBTRKR3",12,0)
EN ; -- entry point to ask date range
"RTN","IBTRKR3",13,0)
 N IBBDT,IBEDT,IBTSBDT,IBTSEDT,IBTALK,IBMESS
"RTN","IBTRKR3",14,0)
 S IBTALK=1
"RTN","IBTRKR3",15,0)
 I '$P($G(^IBE(350.9,1,6)),"^",4) W !!,"I'm sorry, Tracking of Prescription Refills is currrently turned off." G ENQ
"RTN","IBTRKR3",16,0)
 W !!!,"Select the Date Range of Rx Refills to Add to Claims Tracking.",!
"RTN","IBTRKR3",17,0)
 D DATE^IBOUTL
"RTN","IBTRKR3",18,0)
 I IBBDT<1!(IBEDT<1) G ENQ
"RTN","IBTRKR3",19,0)
 S IBTSBDT=IBBDT,IBTSEDT=IBEDT
"RTN","IBTRKR3",20,0)
 ;
"RTN","IBTRKR3",21,0)
 ; -- check selected dates
"RTN","IBTRKR3",22,0)
 S IBTRKR=$G(^IBE(350.9,1,6))
"RTN","IBTRKR3",23,0)
 ; start date can't be before parameters
"RTN","IBTRKR3",24,0)
 I +IBTRKR,IBTSBDT<+IBTRKR S IBTSBDT=IBTRKR W !!,"Begin date is before Claims Tracking Start Date, changed to ",$$DAT1^IBOUTL(IBTSBDT)
"RTN","IBTRKR3",25,0)
 ; -- end date into future
"RTN","IBTRKR3",26,0)
 I IBTSEDT>$$FMADD^XLFDT(DT,-3) W !!,"I'll automatically change the end date to 3 days prior to the date queued to run."
"RTN","IBTRKR3",27,0)
 ;
"RTN","IBTRKR3",28,0)
 W !!!,"I'm going to automatically queue this off and send you a"
"RTN","IBTRKR3",29,0)
 W !,"mail message when complete.",!
"RTN","IBTRKR3",30,0)
 S ZTIO="",ZTRTN="EN1^IBTRKR3",ZTSAVE("IB*")="",ZTDESC="IB - Add Rx Refills to Claims Tracking"
"RTN","IBTRKR3",31,0)
 D ^%ZTLOAD I $G(ZTSK) K ZTSK W !,"Request Queued"
"RTN","IBTRKR3",32,0)
ENQ K ZTSK,ZTIO,ZTSAVE,ZTDESC,ZTRTN
"RTN","IBTRKR3",33,0)
 D HOME^%ZIS
"RTN","IBTRKR3",34,0)
 Q
"RTN","IBTRKR3",35,0)
 ;
"RTN","IBTRKR3",36,0)
EN1 ; -- add rx refills to claims tracking file
"RTN","IBTRKR3",37,0)
 N I,J,X,Y,IBTRKR,IBDT,IBRXN,IBFILL,DFN,IBDATA,IBCNT,IBCNT1,IBCNT2
"RTN","IBTRKR3",38,0)
 ;
"RTN","IBTRKR3",39,0)
 ; -- check parameters
"RTN","IBTRKR3",40,0)
 S IBTRKR=$G(^IBE(350.9,1,6))
"RTN","IBTRKR3",41,0)
 G:'$P(IBTRKR,"^",4) EN1Q ; quit if rx tracking off
"RTN","IBTRKR3",42,0)
 I +IBTRKR,IBTSBDT<+IBTRKR S IBTSBDT=IBTRKR ; start date can't be before parameters
"RTN","IBTRKR3",43,0)
 ;
"RTN","IBTRKR3",44,0)
 ; -- users can queue into future, make sure dates not after date run
"RTN","IBTRKR3",45,0)
 I IBTSEDT>$$FMADD^XLFDT(DT,-3) S IBMESS="(Selected end date of "_$$DAT1^IBOUTL(IBTSEDT)_" automatically changed to "_$$DAT1^IBOUTL($$FMADD^XLFDT(DT,-3))_".)",IBTSEDT=$$FMADD^XLFDT(DT,-3)
"RTN","IBTRKR3",46,0)
 ;
"RTN","IBTRKR3",47,0)
 S IBRXTYP=$O(^IBE(356.6,"AC",4,0)) ; event type pointer for rx billing
"RTN","IBTRKR3",48,0)
 ;
"RTN","IBTRKR3",49,0)
 ; -- cnt= total count, cnt1=count added nsc, cnt2=count of pending
"RTN","IBTRKR3",50,0)
 S (IBCNT,IBCNT1,IBCNT2)=0
"RTN","IBTRKR3",51,0)
 S IBDT=IBTSBDT-.0001
"RTN","IBTRKR3",52,0)
 F  S IBDT=$O(^PSRX("AD",IBDT)) Q:'IBDT!(IBDT>IBTSEDT)  S IBRXN="" F  S IBRXN=$O(^PSRX("AD",IBDT,IBRXN)) Q:'IBRXN  S IBFILL="" F  S IBFILL=$O(^PSRX("AD",IBDT,IBRXN,IBFILL)) Q:IBFILL=""  D RXCHK
"RTN","IBTRKR3",53,0)
 ;
"RTN","IBTRKR3",54,0)
 I $G(IBTALK) D BULL^IBTRKR31
"RTN","IBTRKR3",55,0)
EN1Q I $D(ZTQUEUED) S ZTREQ="@"
"RTN","IBTRKR3",56,0)
 Q
"RTN","IBTRKR3",57,0)
 ;
"RTN","IBTRKR3",58,0)
RXCHK ; -- check and add rx
"RTN","IBTRKR3",59,0)
 S IBCNT=IBCNT+1
"RTN","IBTRKR3",60,0)
 ;I IBFILL<1 G RXCHKQ ;       original fill
"RTN","IBTRKR3",61,0)
 I IBDT>(DT+.24) G RXCHKQ ;  future fill
"RTN","IBTRKR3",62,0)
 I '$D(ZTQUEUED),($G(IBTALK)) W "."
"RTN","IBTRKR3",63,0)
 ;
"RTN","IBTRKR3",64,0)
 S IBRXDATA=$G(^PSRX(IBRXN,0)),IBRXSTAT=$P(IBRXDATA,"^",15)
"RTN","IBTRKR3",65,0)
 S DFN=$P(IBRXDATA,"^",2)
"RTN","IBTRKR3",66,0)
 ;I IBDT=$P($O(^DPT(DFN,"S",(IBDT-.00001))),".") G RXCHKQ ;scheduled appointment on same day as fill date
"RTN","IBTRKR3",67,0)
 ;I $$BABCSC^IBEFUNC(DFN,$P(IBDT,".",1)) G RXCHKQ ; is billable clinic stop in encounter file for data (allows telephone stops on same day, but not others) (P121 - RC, can now bill Rx if on same day as opt visit)
"RTN","IBTRKR3",68,0)
 ;
"RTN","IBTRKR3",69,0)
 ; -- not already in claims tracking
"RTN","IBTRKR3",70,0)
 I $O(^IBT(356,"ARXFL",IBRXN,IBFILL,0)) G RXCHKQ ; already in claims tracking
"RTN","IBTRKR3",71,0)
 ;
"RTN","IBTRKR3",72,0)
 ; -- see if tracking only insured and pt is insured
"RTN","IBTRKR3",73,0)
 I $P(IBTRKR,"^",4)=1,'$$INSURED^IBCNS1(DFN,IBDT) G RXCHKQ ; patient not insure
"RTN","IBTRKR3",74,0)
 ;
"RTN","IBTRKR3",75,0)
 ; -- check rx status (not deleted)
"RTN","IBTRKR3",76,0)
 I IBRXSTAT=13 G RXCHKQ
"RTN","IBTRKR3",77,0)
 ;
"RTN","IBTRKR3",78,0)
 ; -- original fill not released or returned to stock
"RTN","IBTRKR3",79,0)
 I 'IBFILL,'$P($G(^PSRX(IBRXN,2)),"^",13) G RXCHKQ
"RTN","IBTRKR3",80,0)
 I 'IBFILL,$P($G(^PSRX(IBRXN,2)),"^",15) G RXCHKQ
"RTN","IBTRKR3",81,0)
 ;
"RTN","IBTRKR3",82,0)
 ; -- refill not released or returned to stock
"RTN","IBTRKR3",83,0)
 I +IBFILL,'$P($G(^PSRX(IBRXN,1,IBFILL,0)),"^",18) G RXCHKQ
"RTN","IBTRKR3",84,0)
 I +IBFILL,$P($G(^PSRX(IBRXN,1,IBFILL,0)),"^",16) G RXCHKQ
"RTN","IBTRKR3",85,0)
 ;
"RTN","IBTRKR3",86,0)
 ; -- check drug (not investigational, supply, or over the counter drug
"RTN","IBTRKR3",87,0)
 S IBDRUG=$P(IBRXDATA,"^",6)
"RTN","IBTRKR3",88,0)
 S IBDEA=$P($G(^PSDRUG(+$P(IBRXDATA,"^",6),0)),"^",3)
"RTN","IBTRKR3",89,0)
 I IBDEA["I"!(IBDEA["S")!(IBDEA["9") G RXCHKQ ; investigational drug, supply or otc
"RTN","IBTRKR3",90,0)
 ;
"RTN","IBTRKR3",91,0)
 ; -- see if insured for prescriptions
"RTN","IBTRKR3",92,0)
 I '$$PTCOV^IBCNSU3(DFN,IBDT,"PHARMACY",.IBANY) S IBRMARK=$S($G(IBANY):"SERVICE NOT COVERED",1:"NOT INSURED")
"RTN","IBTRKR3",93,0)
 ;
"RTN","IBTRKR3",94,0)
 ; -- check sc status
"RTN","IBTRKR3",95,0)
 D ELIG^VADPT
"RTN","IBTRKR3",96,0)
 ;if the patient is covered by insurance for pharmacy ($G(IBRMARK)="")
"RTN","IBTRKR3",97,0)
 ;AND if no copay in #350
"RTN","IBTRKR3",98,0)
 ;then we need to determine the non billable reason and set IBRMARK
"RTN","IBTRKR3",99,0)
 ;
"RTN","IBTRKR3",100,0)
 ;IF VAEL(3) -- if this is a veteran with SC(service connection) status
"RTN","IBTRKR3",101,0)
 I $G(IBRMARK)="",VAEL(3),'$G(^PSRX(IBRXN,"IB")) D
"RTN","IBTRKR3",102,0)
 .I $P(VAEL(3),"^",2)>49 S IBRMARK="NEEDS SC DETERMINATION"
"RTN","IBTRKR3",103,0)
 .;in case of POW and Unempl.vet we cannot decide if the 3rd party should be exempt
"RTN","IBTRKR3",104,0)
 .N IBPOWUNV,IBAUTRET S IBAUTRET=$$AUTOINFO^DGMTCOU1(DFN),IBPOWUNV=$S($P(IBAUTRET,U,8):1,$P(IBAUTRET,U,9):1,1:0)
"RTN","IBTRKR3",105,0)
 .I $P(VAEL(3),"^",2)<50 S IBRMARK=$S(IBPOWUNV:"NEEDS SC DETERMINATION",1:"SC TREATMENT")
"RTN","IBTRKR3",106,0)
 .I $$RXST^IBARXEU(DFN,$P(IBRXDATA,U,13))>0 S IBRMARK="NEEDS SC DETERMINATION"
"RTN","IBTRKR3",107,0)
 ;
"RTN","IBTRKR3",108,0)
 ;IF +VAEL(3)=0 if the veteran doesn't have SC status, but
"RTN","IBTRKR3",109,0)
 ;the veteran still may have CV status active
"RTN","IBTRKR3",110,0)
 I $G(IBRMARK)="",+VAEL(3)=0,'$G(^PSRX(IBRXN,"IB")) D
"RTN","IBTRKR3",111,0)
 .I $$CVEDT^IBACV(DFN,IBDT) S IBRMARK="NEEDS SC DETERMINATION" ;SC-because IB staff usually is using this reason to search for cases that need to be reviewed. COMBAT VETERAN reason will be used after review if this was a case
"RTN","IBTRKR3",112,0)
 ;
"RTN","IBTRKR3",113,0)
 ; -- ok to add to tracking module
"RTN","IBTRKR3",114,0)
 D REFILL^IBTUTL1(DFN,IBRXTYP,IBDT,IBRXN,IBFILL,$G(IBRMARK)) I '$D(ZTQUEUED),$G(IBTALK) W "+"
"RTN","IBTRKR3",115,0)
 I $G(IBRMARK)'="" S IBCNT2=IBCNT2+1
"RTN","IBTRKR3",116,0)
 I $G(IBRMARK)="" S IBCNT1=IBCNT1+1
"RTN","IBTRKR3",117,0)
 K IBANY,IBRMARK,VAEL,VA,IBDEA,IBDRUG,IBRXSTAT,IBRXDATA,DFN,X,Y
"RTN","IBTRKR3",118,0)
RXCHKQ Q
"VER")
8.0^22.0
**END**
**END**
