Released OR*3*265 SEQ #247
Extracted from mail message
**KIDS**:OR*3.0*265^

**INSTALL NAME**
OR*3.0*265
"BLD",6985,0)
OR*3.0*265^ORDER ENTRY/RESULTS REPORTING^0^3070301^y
"BLD",6985,1,0)
^^20^20^3061211^
"BLD",6985,1,1,0)
This build/patch address 3 issues:
"BLD",6985,1,2,0)
1. "AW" Cross Reference on TO field of File 100 not updated when order 
"BLD",6985,1,3,0)
changes.
"BLD",6985,1,4,0)
2. Lab Threshold exceeded warning not working when results has a greater 
"BLD",6985,1,5,0)
than or less than symbol. Example: <5 or >5
"BLD",6985,1,6,0)
3. Quick Orders not retaining Dosage when edited and dose is over 20 
"BLD",6985,1,7,0)
characters.
"BLD",6985,1,8,0)
4.Update the routine ORB3TIM2 to work the alert even when not passed in 
"BLD",6985,1,9,0)
ORBLST (expired).
"BLD",6985,1,10,0)
5. The correct IEN for pointer for Imaging is
"BLD",6985,1,11,0)
checked and update if needed by the post init routine ORY26508.
"BLD",6985,1,12,0)
6. Modify SESSION^ORCHECK to also check the ADVERSE REACTION ASSESSMENT 
"BLD",6985,1,13,0)
(120.86) for allergies before assuming the error message stored at 
"BLD",6985,1,14,0)
^OR(100,+ORIFN,9 is up to date and displaying the "no allergy assessment" 
"BLD",6985,1,15,0)
error again upon signing the order.
"BLD",6985,1,16,0)
7. If they comment is the same, set the ORDIALOG flag 
"BLD",6985,1,17,0)
"FORMAT" to "@" to prevent the duplication of the comment in CPRS.
"BLD",6985,1,18,0)
8. Modify MEDHIST^ORWPS to set ORPHMID regardless if the flag CKPKG for 
"BLD",6985,1,19,0)
PSB*2.0*19 is set.  Use ORPHMID in the call to HISTORY^PSBMLHS instead
"BLD",6985,1,20,0)
of ORPSID.
"BLD",6985,4,0)
^9.64PA^^
"BLD",6985,6)
6^
"BLD",6985,6.3)
17
"BLD",6985,"INID")
^n
"BLD",6985,"INIT")
ORY26508
"BLD",6985,"KRN",0)
^9.67PA^8989.52^19
"BLD",6985,"KRN",.4,0)
.4
"BLD",6985,"KRN",.4,"NM",0)
^9.68A^^
"BLD",6985,"KRN",.401,0)
.401
"BLD",6985,"KRN",.402,0)
.402
"BLD",6985,"KRN",.403,0)
.403
"BLD",6985,"KRN",.5,0)
.5
"BLD",6985,"KRN",.84,0)
.84
"BLD",6985,"KRN",3.6,0)
3.6
"BLD",6985,"KRN",3.8,0)
3.8
"BLD",6985,"KRN",9.2,0)
9.2
"BLD",6985,"KRN",9.8,0)
9.8
"BLD",6985,"KRN",9.8,"NM",0)
^9.68A^9^7
"BLD",6985,"KRN",9.8,"NM",2,0)
ORB3^^0^B89017690
"BLD",6985,"KRN",9.8,"NM",3,0)
ORB3TIM2^^0^B40286221
"BLD",6985,"KRN",9.8,"NM",5,0)
ORCSAVE2^^0^B47694215
"BLD",6985,"KRN",9.8,"NM",6,0)
ORMPS1^^0^B67707538
"BLD",6985,"KRN",9.8,"NM",7,0)
ORWPS^^0^B46786086
"BLD",6985,"KRN",9.8,"NM",8,0)
ORMPS2^^0^B41616166
"BLD",6985,"KRN",9.8,"NM",9,0)
ORCACT2^^0^B62329288
"BLD",6985,"KRN",9.8,"NM","B","ORB3",2)

"BLD",6985,"KRN",9.8,"NM","B","ORB3TIM2",3)

"BLD",6985,"KRN",9.8,"NM","B","ORCACT2",9)

"BLD",6985,"KRN",9.8,"NM","B","ORCSAVE2",5)

"BLD",6985,"KRN",9.8,"NM","B","ORMPS1",6)

"BLD",6985,"KRN",9.8,"NM","B","ORMPS2",8)

"BLD",6985,"KRN",9.8,"NM","B","ORWPS",7)

"BLD",6985,"KRN",19,0)
19
"BLD",6985,"KRN",19.1,0)
19.1
"BLD",6985,"KRN",101,0)
101
"BLD",6985,"KRN",409.61,0)
409.61
"BLD",6985,"KRN",771,0)
771
"BLD",6985,"KRN",870,0)
870
"BLD",6985,"KRN",8989.51,0)
8989.51
"BLD",6985,"KRN",8989.52,0)
8989.52
"BLD",6985,"KRN",8994,0)
8994
"BLD",6985,"KRN","B",.4,.4)

"BLD",6985,"KRN","B",.401,.401)

"BLD",6985,"KRN","B",.402,.402)

"BLD",6985,"KRN","B",.403,.403)

"BLD",6985,"KRN","B",.5,.5)

"BLD",6985,"KRN","B",.84,.84)

"BLD",6985,"KRN","B",3.6,3.6)

"BLD",6985,"KRN","B",3.8,3.8)

"BLD",6985,"KRN","B",9.2,9.2)

"BLD",6985,"KRN","B",9.8,9.8)

"BLD",6985,"KRN","B",19,19)

"BLD",6985,"KRN","B",19.1,19.1)

"BLD",6985,"KRN","B",101,101)

"BLD",6985,"KRN","B",409.61,409.61)

"BLD",6985,"KRN","B",771,771)

"BLD",6985,"KRN","B",870,870)

"BLD",6985,"KRN","B",8989.51,8989.51)

"BLD",6985,"KRN","B",8989.52,8989.52)

"BLD",6985,"KRN","B",8994,8994)

"BLD",6985,"QUES",0)
^9.62^^
"BLD",6985,"REQB",0)
^9.611^6^4
"BLD",6985,"REQB",1,0)
OR*3.0*253^2
"BLD",6985,"REQB",3,0)
OR*3.0*251^2
"BLD",6985,"REQB",4,0)
OR*3.0*215^2
"BLD",6985,"REQB",6,0)
OR*3.0*149^2
"BLD",6985,"REQB","B","OR*3.0*149",6)

"BLD",6985,"REQB","B","OR*3.0*215",4)

"BLD",6985,"REQB","B","OR*3.0*251",3)

"BLD",6985,"REQB","B","OR*3.0*253",1)

"INIT")
ORY26508
"MBREQ")
0
"PKG",167,-1)
1^1
"PKG",167,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",167,20,0)
^9.402P^^
"PKG",167,22,0)
^9.49I^1^1
"PKG",167,22,1,0)
3.0^2971217^2980417^1271
"PKG",167,22,1,"PAH",1,0)
265^3070301^33245
"PKG",167,22,1,"PAH",1,1,0)
^^20^20^3070301
"PKG",167,22,1,"PAH",1,1,1,0)
This build/patch address 3 issues:
"PKG",167,22,1,"PAH",1,1,2,0)
1. "AW" Cross Reference on TO field of File 100 not updated when order 
"PKG",167,22,1,"PAH",1,1,3,0)
changes.
"PKG",167,22,1,"PAH",1,1,4,0)
2. Lab Threshold exceeded warning not working when results has a greater 
"PKG",167,22,1,"PAH",1,1,5,0)
than or less than symbol. Example: <5 or >5
"PKG",167,22,1,"PAH",1,1,6,0)
3. Quick Orders not retaining Dosage when edited and dose is over 20 
"PKG",167,22,1,"PAH",1,1,7,0)
characters.
"PKG",167,22,1,"PAH",1,1,8,0)
4.Update the routine ORB3TIM2 to work the alert even when not passed in 
"PKG",167,22,1,"PAH",1,1,9,0)
ORBLST (expired).
"PKG",167,22,1,"PAH",1,1,10,0)
5. The correct IEN for pointer for Imaging is
"PKG",167,22,1,"PAH",1,1,11,0)
checked and update if needed by the post init routine ORY26508.
"PKG",167,22,1,"PAH",1,1,12,0)
6. Modify SESSION^ORCHECK to also check the ADVERSE REACTION ASSESSMENT 
"PKG",167,22,1,"PAH",1,1,13,0)
(120.86) for allergies before assuming the error message stored at 
"PKG",167,22,1,"PAH",1,1,14,0)
^OR(100,+ORIFN,9 is up to date and displaying the "no allergy assessment" 
"PKG",167,22,1,"PAH",1,1,15,0)
error again upon signing the order.
"PKG",167,22,1,"PAH",1,1,16,0)
7. If they comment is the same, set the ORDIALOG flag 
"PKG",167,22,1,"PAH",1,1,17,0)
"FORMAT" to "@" to prevent the duplication of the comment in CPRS.
"PKG",167,22,1,"PAH",1,1,18,0)
8. Modify MEDHIST^ORWPS to set ORPHMID regardless if the flag CKPKG for 
"PKG",167,22,1,"PAH",1,1,19,0)
PSB*2.0*19 is set.  Use ORPHMID in the call to HISTORY^PSBMLHS instead
"PKG",167,22,1,"PAH",1,1,20,0)
of ORPSID.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","ORB3")
0^2^B89017690^B88202399
"RTN","ORB3",1,0)
ORB3 ; slc/CLA - Main routine for OE/RR 3 notifications ;6/6/01  10:46 [8/16/05 5:33am]
"RTN","ORB3",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**31,74,91,105,139,190,220,253,265**;Dec 17, 1997;Build 17
"RTN","ORB3",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORB3",4,0)
EN(ORN,ORBDFN,ORNUM,ORBADUZ,ORBPMSG,ORBPDATA) ;
"RTN","ORB3",5,0)
 ;
"RTN","ORB3",6,0)
 N ORBENT
"RTN","ORB3",7,0)
 S ORBENT=$$ENTITY^ORB31(ORNUM)
"RTN","ORB3",8,0)
 ;
"RTN","ORB3",9,0)
 Q:$$GET^XPAR(ORBENT,"ORB SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORB3",10,0)
 Q:'$L($G(^ORD(100.9,ORN,0)))
"RTN","ORB3",11,0)
 Q:+$$ONOFF^ORB3FN(ORN)=0
"RTN","ORB3",12,0)
 ;
"RTN","ORB3",13,0)
 S ORBPMSG=$E($G(ORBPMSG),1,51)
"RTN","ORB3",14,0)
 ;
"RTN","ORB3",15,0)
 ;if msg from notif file or oc notif (#54), quit if dup w/in past 1 min:
"RTN","ORB3",16,0)
 N ORBDUP,ORBN
"RTN","ORB3",17,0)
 S ORBN=^ORD(100.9,ORN,0)
"RTN","ORB3",18,0)
 I ($P(ORBN,"^",4)="NOT")!(ORN=54) D
"RTN","ORB3",19,0)
 .S ORBDUP=$$DUP^ORB31(ORN,ORBDFN,ORBPMSG,ORNUM)
"RTN","ORB3",20,0)
 Q:+$G(ORBDUP)=1
"RTN","ORB3",21,0)
 ;
"RTN","ORB3",22,0)
 N ORBDESC
"RTN","ORB3",23,0)
 S ORBDESC=" Send Alert Notification ("_(+ORN)_") "_$P($G(^ORD(100.9,+ORN,0)),U,1)_"  "
"RTN","ORB3",24,0)
 ;
"RTN","ORB3",25,0)
 D QUEUE^ORB31(ORN,ORBDFN,$G(ORNUM),.ORBADUZ,$G(ORBPMSG),$G(ORBPDATA),$H,ORBDESC,$G(DGPMA))
"RTN","ORB3",26,0)
 Q
"RTN","ORB3",27,0)
ZTSK ;
"RTN","ORB3",28,0)
 D START
"RTN","ORB3",29,0)
 S ZTREQ="@"
"RTN","ORB3",30,0)
 Q
"RTN","ORB3",31,0)
UTL(ORBU,ORN,ORBDFN,ORNUM,ORBADUZ,ORBPMSG,ORBPDATA) ;
"RTN","ORB3",32,0)
 Q:$G(ORBU)'=1
"RTN","ORB3",33,0)
START Q:$G(ORN)=""!($G(ORBDFN)="")
"RTN","ORB3",34,0)
 Q:'$L($G(^ORD(100.9,ORN,0)))
"RTN","ORB3",35,0)
 N ORBNOW,ORBID,ORBLOCK,ORBDESC
"RTN","ORB3",36,0)
 S ORBNOW=$$NOW^XLFDT
"RTN","ORB3",37,0)
 S ORBLOCK=0
"RTN","ORB3",38,0)
 ;
"RTN","ORB3",39,0)
 ;lock to prevent concurrent processing by other resource slots:
"RTN","ORB3",40,0)
 I '$D(ORBU) D
"RTN","ORB3",41,0)
 .S ^XTMP("ORBLOCK",0)=$$FMADD^XLFDT(ORBNOW,1,"","","")_"^"_ORBNOW
"RTN","ORB3",42,0)
 .S ORBID=$P($P($G(ORBPDATA),"|",2),"@")  ;get unique data id
"RTN","ORB3",43,0)
 .I $L(ORBID) D
"RTN","ORB3",44,0)
 ..LOCK +^XTMP("ORBLOCK",ORBDFN,ORN,ORBID):60 E  D  Q
"RTN","ORB3",45,0)
 ...S ORBDESC=" Requeue Alert Notification ("_(+ORN)_") "_$P($G(^ORD(100.9,+ORN,0)),U,1)_"  "
"RTN","ORB3",46,0)
 ...D QUEUE^ORB31(ORN,ORBDFN,$G(ORNUM),.ORBADUZ,$G(ORBPMSG),$G(ORBPDATA),$$HADD^XLFDT($H,"","",5,""),ORBDESC,$G(DGPMA)) ;requeue in 5 min.
"RTN","ORB3",47,0)
 ...S ORBLOCK=1
"RTN","ORB3",48,0)
 .;
"RTN","ORB3",49,0)
 .I '$L(ORBID) D
"RTN","ORB3",50,0)
 ..LOCK +^XTMP("ORBLOCK",ORBDFN,ORN):60 E  D  Q
"RTN","ORB3",51,0)
 ...S ORBDESC=" Requeue Alert Notification ("_(+ORN)_") "_$P($G(^ORD(100.9,+ORN,0)),U,1)_"  "
"RTN","ORB3",52,0)
 ...D QUEUE^ORB31(ORN,ORBDFN,$G(ORNUM),.ORBADUZ,$G(ORBPMSG),$G(ORBPDATA),$$HADD^XLFDT($H,"","",5,""),ORBDESC,$G(DGPMA)) ;requeue in 5 min.
"RTN","ORB3",53,0)
 ...S ORBLOCK=1
"RTN","ORB3",54,0)
 .;
"RTN","ORB3",55,0)
 I ORBLOCK=1 D QUIT Q
"RTN","ORB3",56,0)
 ;
"RTN","ORB3",57,0)
DOALERT ; Entry point for alert logic outside of TaskMan
"RTN","ORB3",58,0)
 N ORBDUZ,ORBN,ORBXQAID,ORPTNAM,ORBPRIM,ORBATTD,ORBDEV,ORBENT
"RTN","ORB3",59,0)
 N ORBUI,ORBASPEC,ORBSMSG,ORBADT,ORBSDEV,ORBDEL,ORBDI,ORBTDEV,ORY
"RTN","ORB3",60,0)
 S ORBUI=1,ORBADT=0
"RTN","ORB3",61,0)
 S:'$L($G(ORBPMSG)) ORBPMSG=""
"RTN","ORB3",62,0)
 I '$L(ORBPDATA),(+$G(ORNUM)>0) S ORBPDATA=+$G(ORNUM)_"@"
"RTN","ORB3",63,0)
 S ORBN=^ORD(100.9,ORN,0)
"RTN","ORB3",64,0)
 ;
"RTN","ORB3",65,0)
 S ORBENT=$$ENTITY^ORB31(ORNUM)
"RTN","ORB3",66,0)
 ;
"RTN","ORB3",67,0)
 N DFN S DFN=ORBDFN,VA200="" D OERR^VADPT
"RTN","ORB3",68,0)
 I ('$L($G(VA("BID"))))!('$L($G(VADM(1)))) D QUIT Q
"RTN","ORB3",69,0)
 I (ORN=18)!(ORN=20)!(ORN=35) S ORBADT=1 ;A/D/T notif
"RTN","ORB3",70,0)
 ;if not an A/D/T notif, get primary & attending from OERR^VADPT:
"RTN","ORB3",71,0)
 I ORBADT=0 S ORBPRIM=+$P(VAIN(2),U),ORBATTD=+$P(VAIN(11),U)
"RTN","ORB3",72,0)
 I ORBADT=1 D ADT^ORB31(ORN,ORBDFN,.ORBPRIM,.ORBATTD,$G(ORDGPMA)) ;A/D/T notif
"RTN","ORB3",73,0)
 I $D(ORBU) D  ;create debug msg
"RTN","ORB3",74,0)
 .S ORBU(ORBUI)="Processing notification: "_$P(ORBN,U),ORBUI=ORBUI+1
"RTN","ORB3",75,0)
 .S ORBU(ORBUI)="            for patient: "_VADM(1),ORBUI=ORBUI+1
"RTN","ORB3",76,0)
 .I $G(ORNUM)>0 S ORBU(ORBUI)="              for order: "_ORNUM,ORBUI=ORBUI+1
"RTN","ORB3",77,0)
 D REGULAR^ORB3REG(ORN,.XQA,.ORBU,.ORBUI,.ORBDEV,ORBDFN)
"RTN","ORB3",78,0)
 D SPECIAL^ORB3SPEC(ORN,.ORBASPEC,.ORBU,.ORBUI,$G(ORNUM),ORBDFN,$G(ORBPDATA),.ORBSMSG,$G(ORBPMSG),.ORBSDEV,$G(ORBPRIM),$G(ORBATTD))
"RTN","ORB3",79,0)
 I $L($G(ORBSMSG)) S ORBPMSG=$E(ORBSMSG,1,51)
"RTN","ORB3",80,0)
 I $D(ORBASPEC)>1 D SPECDUZS ;special recips
"RTN","ORB3",81,0)
 I $D(ORBADUZ)>1 D PKGDUZS ;pkg-supplied recips
"RTN","ORB3",82,0)
 D TITLE ;provider recips
"RTN","ORB3",83,0)
 S ORBXQAID=$P(ORBN,"^",2)_","_ORBDFN_","_ORN
"RTN","ORB3",84,0)
 ;
"RTN","ORB3",85,0)
 I ($D(XQA)>1)!($D(ORBDEV)>1)!($D(ORBSDEV)>1) D  ;recips found
"RTN","ORB3",86,0)
 .S XQAFLG=$P(ORBN,"^",5)
"RTN","ORB3",87,0)
 .S XQADFN=ORBDFN
"RTN","ORB3",88,0)
 .I XQAFLG="R" S XQAROU=$P(ORBN,"^",6)_"^"_$P(ORBN,"^",7)
"RTN","ORB3",89,0)
 .I $G(ORBPDATA)'="" S XQADATA=ORBPDATA
"RTN","ORB3",90,0)
 .S ORPTNAM=$E(VADM(1)_"         ",1,9)
"RTN","ORB3",91,0)
 .S XQAMSG=ORPTNAM_" "_"("_$E(ORPTNAM)_$E(VA("BID"),1,4)_")"_": "
"RTN","ORB3",92,0)
 .S XQAMSG=XQAMSG_$S(ORBPMSG'="":ORBPMSG,1:$P(ORBN,"^",3))
"RTN","ORB3",93,0)
 .S XQAARCH=$$GET^XPAR(ORBENT,"ORB ARCHIVE PERIOD",ORN,"I")
"RTN","ORB3",94,0)
 .S XQASUPV=$$GET^XPAR(ORBENT,"ORB FORWARD SUPERVISOR",ORN,"I")
"RTN","ORB3",95,0)
 .S XQASURO=$$GET^XPAR(ORBENT,"ORB FORWARD SURROGATES",ORN,"I")
"RTN","ORB3",96,0)
 .S XQAREVUE=$$GET^XPAR(ORBENT,"ORB FORWARD BACKUP REVIEWER",ORN,"I")
"RTN","ORB3",97,0)
 .S XQACNDEL=$$GET^XPAR(ORBENT,"ORB REMOVE",ORN,"I")
"RTN","ORB3",98,0)
 .S XQACNDEL=$S(XQACNDEL=1:1,1:"")
"RTN","ORB3",99,0)
 .I $D(ORBDEV)>1 D REGDEV^ORB31(.ORBDEV)
"RTN","ORB3",100,0)
 .I $D(ORBSDEV)>1 D REGDEV^ORB31(.ORBSDEV)
"RTN","ORB3",101,0)
 .I $D(ORBTDEV)>1 D REGDEV^ORB31(.ORBTDEV)
"RTN","ORB3",102,0)
 .S XQAID=ORBXQAID
"RTN","ORB3",103,0)
 .I $D(XQA) D SETUP^XQALERT  ;if no [new] recips don't send alert
"RTN","ORB3",104,0)
QUIT ;
"RTN","ORB3",105,0)
 K VA,VA200,VADM,VAERR,VAIN,XQA,XQADATA,XQAID,XQAFLG,XQAMSG,XQAROU,XQAARCH,XQASUPV,XQASURO,XQADFN
"RTN","ORB3",106,0)
 K ^XTMP("ORBUSER",$J)
"RTN","ORB3",107,0)
 I '$D(ORBU),$D(ORBLOCK) D
"RTN","ORB3",108,0)
 .I $G(ORBID)]"" LOCK -^XTMP("ORBLOCK",ORBDFN,ORN,ORBID)
"RTN","ORB3",109,0)
 .E  LOCK -^XTMP("ORBLOCK",ORBDFN,ORN)
"RTN","ORB3",110,0)
 Q
"RTN","ORB3",111,0)
PKGDUZS ;get DUZs from pkg-passed ORBADUZ() array
"RTN","ORB3",112,0)
 N ORBPDUZ
"RTN","ORB3",113,0)
 I $D(ORBU) D
"RTN","ORB3",114,0)
 .S ORBU(ORBUI)=" ",ORBUI=ORBUI+1
"RTN","ORB3",115,0)
 .I ORN=68 S ORBU(ORBUI)="Recipients with Lab Threshold Exceeded:",ORBUI=ORBUI+1
"RTN","ORB3",116,0)
 .E  S ORBU(ORBUI)="Recipients defined when notif was triggered:",ORBUI=ORBUI+1
"RTN","ORB3",117,0)
 S ORBPDUZ=""
"RTN","ORB3",118,0)
 F  S ORBPDUZ=$O(ORBADUZ(ORBPDUZ)) Q:ORBPDUZ=""  S ORBDUZ=ORBPDUZ D USER
"RTN","ORB3",119,0)
 Q
"RTN","ORB3",120,0)
SPECDUZS ;get DUZs rtn by SPECIAL^ORB3SPEC
"RTN","ORB3",121,0)
 N ORBSDUZ
"RTN","ORB3",122,0)
 I $D(ORBU) D
"RTN","ORB3",123,0)
 .S ORBU(ORBUI)=" ",ORBUI=ORBUI+1
"RTN","ORB3",124,0)
 .S ORBU(ORBUI)="Special recipients associated with the notification:",ORBUI=ORBUI+1
"RTN","ORB3",125,0)
 S ORBSDUZ=""
"RTN","ORB3",126,0)
 F  S ORBSDUZ=$O(ORBASPEC(ORBSDUZ)) Q:ORBSDUZ=""  S ORBDUZ=ORBSDUZ D USER
"RTN","ORB3",127,0)
 Q
"RTN","ORB3",128,0)
TITLE ;get provider recips
"RTN","ORB3",129,0)
 N TITLES
"RTN","ORB3",130,0)
 I $D(ORBU) D
"RTN","ORB3",131,0)
 .S ORBU(ORBUI)=" ",ORBUI=ORBUI+1
"RTN","ORB3",132,0)
 .S ORBU(ORBUI)="Recipients determined by Provider Recipient parameter:",ORBUI=ORBUI+1
"RTN","ORB3",133,0)
 ;
"RTN","ORB3",134,0)
 S TITLES=$$GET^XPAR(ORBENT,"ORB PROVIDER RECIPIENTS",ORN,"I")
"RTN","ORB3",135,0)
 I TITLES["P" D PRIMARY
"RTN","ORB3",136,0)
 I TITLES["A" D ATTEND
"RTN","ORB3",137,0)
 I TITLES["T" D TEAMS
"RTN","ORB3",138,0)
 I TITLES["O" D ORDERER
"RTN","ORB3",139,0)
 I TITLES["E" D ENTERBY
"RTN","ORB3",140,0)
 I TITLES["R" D PCMMPRIM
"RTN","ORB3",141,0)
 I TITLES["S" D PCMMASSC
"RTN","ORB3",142,0)
 I TITLES["M" D PCMMTEAM
"RTN","ORB3",143,0)
 Q
"RTN","ORB3",144,0)
PRIMARY ;
"RTN","ORB3",145,0)
 I $D(ORBU),ORBADT=0 S ORBU(ORBUI)=" Inpt primary provider:",ORBUI=ORBUI+1
"RTN","ORB3",146,0)
 I $D(ORBU),ORBADT=1 S ORBU(ORBUI)=" Inpt primary provider: option cannot determine without A/D/T event data.",ORBUI=ORBUI+1
"RTN","ORB3",147,0)
 I +$G(ORBPRIM)>0 S ORBDUZ=ORBPRIM D USER
"RTN","ORB3",148,0)
 Q
"RTN","ORB3",149,0)
ATTEND ;
"RTN","ORB3",150,0)
 I $D(ORBU),ORBADT=0 S ORBU(ORBUI)=" Attending physician:",ORBUI=ORBUI+1
"RTN","ORB3",151,0)
 I $D(ORBU),ORBADT=1 S ORBU(ORBUI)=" Attending physician: option cannot determine without A/D/T event data.",ORBUI=ORBUI+1
"RTN","ORB3",152,0)
 I +$G(ORBATTD)>0 S ORBDUZ=ORBATTD D USER
"RTN","ORB3",153,0)
 Q
"RTN","ORB3",154,0)
TEAMS ;
"RTN","ORB3",155,0)
 I $D(ORBU) S ORBU(ORBUI)=" Teams/Personal Lists related to patient:",ORBUI=ORBUI+1
"RTN","ORB3",156,0)
 N ORBLST,ORBI,ORBJ,ORBTM,ORBTNAME,ORBTTYPE,ORBTD
"RTN","ORB3",157,0)
 D TMSPT^ORQPTQ1(.ORBLST,ORBDFN)
"RTN","ORB3",158,0)
 Q:+$G(ORBLST(1))<1
"RTN","ORB3",159,0)
 S ORBI="" F  S ORBI=$O(ORBLST(ORBI)) Q:ORBI=""  D
"RTN","ORB3",160,0)
 .S ORBTM=$P(ORBLST(ORBI),U),ORBTNAME=$P(ORBLST(ORBI),U,2)
"RTN","ORB3",161,0)
 .S ORBTTYPE=$P(ORBLST(ORBI),U,3)
"RTN","ORB3",162,0)
 .I $D(ORBU) D
"RTN","ORB3",163,0)
 ..S ORBU(ORBUI)="  Patient list "_ORBTNAME_" ["_ORBTTYPE_"]:",ORBUI=ORBUI+1
"RTN","ORB3",164,0)
 .N ORBLST2 D TEAMPROV^ORQPTQ1(.ORBLST2,ORBTM)
"RTN","ORB3",165,0)
 .Q:+$G(ORBLST2(1))<1
"RTN","ORB3",166,0)
 .S ORBJ="" F  S ORBJ=$O(ORBLST2(ORBJ)) Q:ORBJ=""  D
"RTN","ORB3",167,0)
 ..S ORBDUZ=$P(ORBLST2(ORBJ),U)_U_ORBTM I +$G(ORBDUZ)>0 D USER
"RTN","ORB3",168,0)
 .;
"RTN","ORB3",169,0)
 .S ORBTD=$P($$TMDEV^ORB31(ORBTM),U,2)  ;Team's device
"RTN","ORB3",170,0)
 .I $L(ORBTD) D
"RTN","ORB3",171,0)
 ..S ORBTDEV(ORBTD)=""
"RTN","ORB3",172,0)
 ..I $D(ORBU) D
"RTN","ORB3",173,0)
 ...S ORBU(ORBUI)="   Team's Device "_ORBTD_" is a recipient",ORBUI=ORBUI+1
"RTN","ORB3",174,0)
 Q
"RTN","ORB3",175,0)
ORDERER ;
"RTN","ORB3",176,0)
 Q:+$G(ORNUM)<1
"RTN","ORB3",177,0)
 I $D(ORBU) S ORBU(ORBUI)=" Ordering provider:",ORBUI=ORBUI+1
"RTN","ORB3",178,0)
 N ORBLST,ORBI,ORBTM,ORBJ,ORBTNAME,ORBPLST,ORBPI,ORBPTM,ORBTTYPE
"RTN","ORB3",179,0)
 S ORBDUZ=$S(ORN=12:+$$UNSIGNOR^ORQOR2(ORNUM),1:$$ORDERER^ORQOR2(ORNUM))
"RTN","ORB3",180,0)
 I +$G(ORBDUZ)>0 D
"RTN","ORB3",181,0)
 .D USER
"RTN","ORB3",182,0)
 .;if notif = Order Req E/S (#12) or Order Req Co-sign (#37) and
"RTN","ORB3",183,0)
 .;user doesn't have ES authority, send to fellow team members w/ES:
"RTN","ORB3",184,0)
 .I ((ORN=12)!(ORN=37)),('$D(^XUSEC("ORES",ORBDUZ))) D
"RTN","ORB3",185,0)
 ..I $D(ORBU) S ORBU(ORBUI)=" Orderer can't elec sign, getting teams orderer belongs to:",ORBUI=ORBUI+1
"RTN","ORB3",186,0)
 ..D TEAMPR^ORQPTQ1(.ORBLST,ORBDUZ)  ;get orderer's tms
"RTN","ORB3",187,0)
 ..Q:+$G(ORBLST(1))<1
"RTN","ORB3",188,0)
 ..D TMSPT^ORQPTQ1(.ORBPLST,ORBDFN)  ;get pt's tms
"RTN","ORB3",189,0)
 ..Q:+$G(ORBPLST(1))<1
"RTN","ORB3",190,0)
 ..S ORBI="" F  S ORBI=$O(ORBLST(ORBI)) Q:ORBI=""  D
"RTN","ORB3",191,0)
 ...S ORBPI="" F  S ORBPI=$O(ORBPLST(ORBPI)) Q:ORBPI=""  D
"RTN","ORB3",192,0)
 ....S ORBTM=$P(ORBLST(ORBI),U),ORBPTM=$P(ORBPLST(ORBPI),U)
"RTN","ORB3",193,0)
 ....I ORBTM=ORBPTM D  ;if pt is on provider's team
"RTN","ORB3",194,0)
 .....I +$G(ORBPTM)>0 D
"RTN","ORB3",195,0)
 ......S ORBTNAME=$P(ORBPLST(ORBPI),U,2)
"RTN","ORB3",196,0)
 ......S ORBTTYPE=$P(ORBPLST(ORBPI),U,3)
"RTN","ORB3",197,0)
 ......I $D(ORBU) S ORBU(ORBUI)="  Orderer's pt list "_ORBTNAME_" ["_ORBTTYPE_"] recipients: ",ORBUI=ORBUI+1
"RTN","ORB3",198,0)
 ......N ORBLST2 D TEAMPROV^ORQPTQ1(.ORBLST2,ORBPTM)
"RTN","ORB3",199,0)
 ......Q:+$G(ORBLST2(1))<1
"RTN","ORB3",200,0)
 ......S ORBJ="" F  S ORBJ=$O(ORBLST2(ORBJ)) Q:ORBJ=""  D
"RTN","ORB3",201,0)
 .......S ORBDUZ=$P(ORBLST2(ORBJ),U)_U_ORBPTM I +$G(ORBDUZ)>0,($D(^XUSEC("ORES",+ORBDUZ))) D USER
"RTN","ORB3",202,0)
 Q
"RTN","ORB3",203,0)
ENTERBY ;
"RTN","ORB3",204,0)
 I $D(ORBU) S ORBU(ORBUI)=" User entering order's most recent activity:",ORBUI=ORBUI+1
"RTN","ORB3",205,0)
 Q:+$G(ORNUM)<1
"RTN","ORB3",206,0)
 I $D(^OR(100,ORNUM,8,0)) D
"RTN","ORB3",207,0)
 .S ORBDUZ=$P(^OR(100,ORNUM,8,$P(^OR(100,ORNUM,8,0),U,3),0),U,13)
"RTN","ORB3",208,0)
 I +$G(ORBDUZ)>0 D USER
"RTN","ORB3",209,0)
 Q
"RTN","ORB3",210,0)
PCMMPRIM ;
"RTN","ORB3",211,0)
 I $D(ORBU) S ORBU(ORBUI)=" PCMM Primary Care Practitioner:",ORBUI=ORBUI+1
"RTN","ORB3",212,0)
 S ORBDUZ=+$$OUTPTPR^SDUTL3(ORBDFN,$$NOW^XLFDT,1)  ;DBIA #1252
"RTN","ORB3",213,0)
 I +$G(ORBDUZ)>0 D USER
"RTN","ORB3",214,0)
 Q
"RTN","ORB3",215,0)
PCMMASSC ;
"RTN","ORB3",216,0)
 I $D(ORBU) S ORBU(ORBUI)=" PCMM Associate Provider:",ORBUI=ORBUI+1
"RTN","ORB3",217,0)
 S ORBDUZ=+$$OUTPTAP^SDUTL3(ORBDFN,$$NOW^XLFDT)  ;DBIA #1252
"RTN","ORB3",218,0)
 I +$G(ORBDUZ)>0 D USER
"RTN","ORB3",219,0)
 Q
"RTN","ORB3",220,0)
PCMMTEAM ;
"RTN","ORB3",221,0)
 N ORPCMM,ORPCMMDZ
"RTN","ORB3",222,0)
 I $D(ORBU) S ORBU(ORBUI)=" PCMM Team Position Assignments:",ORBUI=ORBUI+1
"RTN","ORB3",223,0)
 S ORPCMM=$$PRPT^SCAPMC(ORBDFN,,,,,,"^TMP(""ORPCMM"",$J)",)  ;DBIA #1916
"RTN","ORB3",224,0)
 S ORPCMMDZ=0
"RTN","ORB3",225,0)
 F  S ORPCMMDZ=$O(^TMP("ORPCMM",$J,"SCPR",ORPCMMDZ)) Q:'ORPCMMDZ  D
"RTN","ORB3",226,0)
 .S ORBDUZ=ORPCMMDZ D USER
"RTN","ORB3",227,0)
 K ^TMP("ORPCMM",$J)
"RTN","ORB3",228,0)
 Q
"RTN","ORB3",229,0)
USER ;should USER (ORBDUZ) be a recip
"RTN","ORB3",230,0)
 D USER^ORB3USER(.XQA,ORBDUZ,ORN,.ORBU,.ORBUI,ORBDFN,+$G(ORNUM))
"RTN","ORB3",231,0)
 Q
"RTN","ORB3TIM2")
0^3^B40286221^B38807562
"RTN","ORB3TIM2",1,0)
ORB3TIM2 ; slc/CLA - Routine to trigger time-related notifications ;3/30/01  07:41 [1/3/05 8:21am]
"RTN","ORB3TIM2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**102,215,251,265**;Dec 17, 1997;Build 17
"RTN","ORB3TIM2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORB3TIM2",4,0)
 ;
"RTN","ORB3TIM2",5,0)
EXPIR ;trigger expiring order notifs
"RTN","ORB3TIM2",6,0)
 N EDT,EXDT,EXORN,ORBDNR,ORPT,ORBRSLT,RXORD,ORLASTDT,X,Y,%DT
"RTN","ORB3TIM2",7,0)
 N OIFILE,ORBY,ORBZ,ORBI,ORSCH,ORSCHFIL,ONETIME,ORST,ORNG,ORDT,ORDW,ORHOL
"RTN","ORB3TIM2",8,0)
 N EXOI,ORBLST,ORBERR,OITXT,PTLOC,ORSDT,ORNOW,ORLDT
"RTN","ORB3TIM2",9,0)
 ;
"RTN","ORB3TIM2",10,0)
 S ORNOW=$$NOW^XLFDT
"RTN","ORB3TIM2",11,0)
 ;
"RTN","ORB3TIM2",12,0)
 I '$D(^XTMP("ORB LAST EXPIRE")) D  ;holds last dt EXPIR processed
"RTN","ORB3TIM2",13,0)
 .S ^XTMP("ORB LAST EXPIRE",0)=$$FMADD^XLFDT(ORNOW,7,"","","")_U
"RTN","ORB3TIM2",14,0)
 ;
"RTN","ORB3TIM2",15,0)
 ;determine number of days to return orders using day of week & holidays
"RTN","ORB3TIM2",16,0)
 F ORNG=1:1 D  I ORHOL=0,ORDW=0 Q
"RTN","ORB3TIM2",17,0)
 .S ORDW=$S($H-4+ORNG#7>4:1,1:0)          ;if Sat or Sun, ORDW=0
"RTN","ORB3TIM2",18,0)
 .S ORDT=$$FMADD^XLFDT(DT,ORNG)
"RTN","ORB3TIM2",19,0)
 .K DIC S DIC="^HOLIDAY(",X=ORDT D ^DIC
"RTN","ORB3TIM2",20,0)
 .S ORHOL=$S(+$G(Y)>0:1,1:0)              ;if ORDT is a holiday, ORHOL=0
"RTN","ORB3TIM2",21,0)
 S %DT="",X="T+"_ORNG D ^%DT
"RTN","ORB3TIM2",22,0)
 S EDT=Y_".2400"
"RTN","ORB3TIM2",23,0)
 K DIC
"RTN","ORB3TIM2",24,0)
 ;
"RTN","ORB3TIM2",25,0)
 ;get DNR OIs:
"RTN","ORB3TIM2",26,0)
 S OIFILE=$$TERMLKUP^ORB31(.ORBY,"DNR")
"RTN","ORB3TIM2",27,0)
 ;
"RTN","ORB3TIM2",28,0)
 ;get local admin schedules for ONE TIME MED:
"RTN","ORB3TIM2",29,0)
 S ORSCHFIL=$$TERMLKUP^ORB31(.ORBZ,"ONE TIME MED")
"RTN","ORB3TIM2",30,0)
 ;
"RTN","ORB3TIM2",31,0)
 ;examine expiring orders:
"RTN","ORB3TIM2",32,0)
 S ORLASTDT=$P(^XTMP("ORB LAST EXPIRE",0),U,2)
"RTN","ORB3TIM2",33,0)
 S EXDT=$S($L(ORLASTDT):ORLASTDT,1:ORNOW)
"RTN","ORB3TIM2",34,0)
 F  S EXDT=$O(^OR(100,"AE",EXDT)) Q:(EXDT="")  D  Q:ORBRSLT<0
"RTN","ORB3TIM2",35,0)
 .S ORBRSLT=$$FMDIFF^XLFDT(EDT,$P(EXDT,".")_".2400",2)  ;diff in seconds
"RTN","ORB3TIM2",36,0)
 .Q:ORBRSLT<0
"RTN","ORB3TIM2",37,0)
 .S EXORN="" F  S EXORN=$O(^OR(100,"AE",EXDT,EXORN)) Q:EXORN=""  D
"RTN","ORB3TIM2",38,0)
 ..;
"RTN","ORB3TIM2",39,0)
 ..;Quit if isn't at least next day after order's Date of Last Activity:
"RTN","ORB3TIM2",40,0)
 ..S ORLDT=$P(^OR(100,EXORN,3),U)
"RTN","ORB3TIM2",41,0)
 ..Q:$$FMDIFF^XLFDT(ORNOW,ORLDT)<1
"RTN","ORB3TIM2",42,0)
 ..;
"RTN","ORB3TIM2",43,0)
 ..Q:$D(^XTMP("ORB LAST EXPIRE",EXORN))  ;quit if order already processed
"RTN","ORB3TIM2",44,0)
 ..S ^XTMP("ORB LAST EXPIRE",EXORN)=EXDT
"RTN","ORB3TIM2",45,0)
 ..;
"RTN","ORB3TIM2",46,0)
 ..S ORPT=$$PT^ORQOR2(EXORN)   ; get pt assoc w/order
"RTN","ORB3TIM2",47,0)
 ..Q:+$G(ORPT)<1
"RTN","ORB3TIM2",48,0)
 ..;
"RTN","ORB3TIM2",49,0)
 ..Q:+$G(^DPT(ORPT,.35))>0  ; quit if pt deceased - DBIA #10035
"RTN","ORB3TIM2",50,0)
 ..;
"RTN","ORB3TIM2",51,0)
 ..S PTLOC=$G(^DPT(+$G(ORPT),.1)),PTLOC=$S($L(PTLOC):PTLOC,1:"OUTPT")
"RTN","ORB3TIM2",52,0)
 ..;
"RTN","ORB3TIM2",53,0)
 ..; is expiring order a DNR order:
"RTN","ORB3TIM2",54,0)
 ..I $D(ORBY),(+$G(OIFILE)=101.43) D
"RTN","ORB3TIM2",55,0)
 ...F ORBI=1:1:ORBY D
"RTN","ORB3TIM2",56,0)
 ....S ORBDNR=$P(ORBY(ORBI),U) I ORBDNR=$$OI^ORQOR2(EXORN) D
"RTN","ORB3TIM2",57,0)
 .....S ORST=$P($$STATUS^ORQOR2(EXORN),U,2)
"RTN","ORB3TIM2",58,0)
 .....I ORST'="DISCONTINUED",ORST'="COMPLETE",ORST'="EXPIRED",ORST'="CANCELLED",ORST'="DISCONTINUED/EDIT" D
"RTN","ORB3TIM2",59,0)
 ......D EN^ORB3(45,ORPT,EXORN,"","",EXORN_"@") ;trigger DNR notif
"RTN","ORB3TIM2",60,0)
 ..;
"RTN","ORB3TIM2",61,0)
 ..; is expiring order a flagged oi:
"RTN","ORB3TIM2",62,0)
 ..S EXOI=$$OI^ORQOR2(EXORN) I +$G(EXOI)>0 D
"RTN","ORB3TIM2",63,0)
 ...I $L(PTLOC),PTLOC'="OUTPT" D
"RTN","ORB3TIM2",64,0)
 ....D ENVAL^XPAR(.ORBLST,"ORB OI EXPIRING - INPT","`"_EXOI,.ORBERR)
"RTN","ORB3TIM2",65,0)
 ....I 'ORBERR,'$G(ORBLST) D ENVAL^XPAR(.ORBLST,"ORB OI EXPIRING - INPT PR","`"_EXOI,.ORBERR)
"RTN","ORB3TIM2",66,0)
 ....I 'ORBERR,$G(ORBLST)>0 D
"RTN","ORB3TIM2",67,0)
 .....S OITXT=$P(^ORD(101.43,EXOI,0),U)
"RTN","ORB3TIM2",68,0)
 .....S ORSDT=$P(^OR(100,EXORN,0),U,8),ORSDT=$$FMTE^XLFDT(ORSDT,"2P")
"RTN","ORB3TIM2",69,0)
 .....D EN^ORB3(64,ORPT,EXORN,"","["_PTLOC_"] Order expiring: "_OITXT_" "_ORSDT,EXORN_"@") ;trigger Expiring Flagged OI - INPT notification
"RTN","ORB3TIM2",70,0)
 ...;
"RTN","ORB3TIM2",71,0)
 ...I $L(PTLOC),PTLOC="OUTPT" D
"RTN","ORB3TIM2",72,0)
 ....D ENVAL^XPAR(.ORBLST,"ORB OI EXPIRING - OUTPT","`"_EXOI,.ORBERR)
"RTN","ORB3TIM2",73,0)
 ....I 'ORBERR,$G(ORBLST)>0 D
"RTN","ORB3TIM2",74,0)
 .....S OITXT=$P(^ORD(101.43,EXOI,0),U)
"RTN","ORB3TIM2",75,0)
 .....S ORSDT=$P(^OR(100,EXORN,0),U,8),ORSDT=$$FMTE^XLFDT(ORSDT,"2P")
"RTN","ORB3TIM2",76,0)
 .....D EN^ORB3(65,ORPT,EXORN,"","["_PTLOC_"] Order expiring: "_OITXT_" "_ORSDT,EXORN_"@") ;trigger Expiring Flagged OI - OUTPT notification
"RTN","ORB3TIM2",77,0)
 ..;
"RTN","ORB3TIM2",78,0)
 ..;is expiring order a med order:
"RTN","ORB3TIM2",79,0)
 ..S RXORD=$$DGRX^ORQOR2(EXORN)
"RTN","ORB3TIM2",80,0)
 ..I $L(RXORD) D  ;if expiring order is a med order
"RTN","ORB3TIM2",81,0)
 ...;
"RTN","ORB3TIM2",82,0)
 ...N DFN S DFN=ORPT
"RTN","ORB3TIM2",83,0)
 ...D ADM^VADPT2
"RTN","ORB3TIM2",84,0)
 ...;
"RTN","ORB3TIM2",85,0)
 ...I (RXORD="OUTPATIENT MEDICATIONS")!(+$G(VADMVT)<1&(RXORD'="CLINIC ORDERS")) D
"RTN","ORB3TIM2",86,0)
 ....D EN^ORB3(72,ORPT,EXORN,"","",EXORN_"@")  ;trigger outpt notif
"RTN","ORB3TIM2",87,0)
 ...;
"RTN","ORB3TIM2",88,0)
 ...Q:RXORD="OUTPATIENT MEDICATIONS"  ;quit if an outpt med
"RTN","ORB3TIM2",89,0)
 ...Q:+$G(VADMVT)<1&(RXORD'="CLINIC ORDERS")  ;quit if an outpt
"RTN","ORB3TIM2",90,0)
 ...;
"RTN","ORB3TIM2",91,0)
 ...K VADMVT
"RTN","ORB3TIM2",92,0)
 ...;
"RTN","ORB3TIM2",93,0)
 ...;is schedule for the order a ONE TIME MED:
"RTN","ORB3TIM2",94,0)
 ...S ONETIME=0
"RTN","ORB3TIM2",95,0)
 ...I $D(ORBZ),(+$G(ORSCHFIL)=51.1) F ORBI=1:1:ORBZ D
"RTN","ORB3TIM2",96,0)
 ....S ORSCH=$P(ORBZ(ORBI),U,2)
"RTN","ORB3TIM2",97,0)
 ....I ORSCH=$$VALUE^ORCSAVE2(EXORN,"SCHEDULE") S ONETIME=1 Q
"RTN","ORB3TIM2",98,0)
 ...Q:+$G(ONETIME)=1  ;quit if one time med
"RTN","ORB3TIM2",99,0)
 ...;
"RTN","ORB3TIM2",100,0)
 ...;check if this is an IMO order and what it is,send an M.E.-OUTPT alert
"RTN","ORB3TIM2",101,0)
 ...I RXORD="CLINIC ORDERS" D  Q
"RTN","ORB3TIM2",102,0)
 ....N ORDLG,ORDG,ORDLGNM,FLAG,ORX
"RTN","ORB3TIM2",103,0)
 ....S FLAG=0
"RTN","ORB3TIM2",104,0)
 ....S ORDLG=$P($G(^OR(100,EXORN,0)),U,5) Q:$P(ORDLG,";",2)'="ORD(101.41,"
"RTN","ORB3TIM2",105,0)
 ....S ORDLGNM=$P($G(^ORD(101.41,+ORDLG,0)),U)
"RTN","ORB3TIM2",106,0)
 ....S ORDG=$P($G(^ORD(101.41,+ORDLG,0)),U,2)
"RTN","ORB3TIM2",107,0)
 ....I ORDLGNM="PSJ OR PAT OE"!(ORDLGNM="PSJI OR PAT FLUID OE") S FLAG=1
"RTN","ORB3TIM2",108,0)
 ....I 'FLAG F ORX="INPATIENT MEDICATIONS","IV MEDICATIONS","UNIT DOSE MEDICATIONS","CLINIC ORDERS" I $$UPPER^ORU(ORDG)=ORX D
"RTN","ORB3TIM2",109,0)
 .....S FLAG=1
"RTN","ORB3TIM2",110,0)
 .....I ORX="IV MEDICATIONS",(+$$IVRENEW(EXORN)=0) S FLAG=0
"RTN","ORB3TIM2",111,0)
 .....I ORX="UNIT DOSE MEDICATIONS",(+$$UDRENEW(EXORN,EXDT)=0) S FLAG=0
"RTN","ORB3TIM2",112,0)
 ....I FLAG D EN^ORB3(72,ORPT,EXORN,"","",EXORN_"@")  ;trigger outpt notif
"RTN","ORB3TIM2",113,0)
 ...;
"RTN","ORB3TIM2",114,0)
 ...;quit if inpt/unit dose med and med is not renewable:
"RTN","ORB3TIM2",115,0)
 ...I RXORD="UNIT DOSE MEDICATIONS",(+$$UDRENEW(EXORN,EXDT)=0) Q
"RTN","ORB3TIM2",116,0)
 ...;
"RTN","ORB3TIM2",117,0)
 ...;quit if IV med and med is not renewable:
"RTN","ORB3TIM2",118,0)
 ...I RXORD="IV MEDICATIONS",(+$$IVRENEW(EXORN)=0) Q
"RTN","ORB3TIM2",119,0)
 ...;
"RTN","ORB3TIM2",120,0)
 ...D EN^ORB3(47,ORPT,EXORN,"","",EXORN_"@")  ;trigger notif
"RTN","ORB3TIM2",121,0)
 S ^XTMP("ORB LAST EXPIRE",0)=$$FMADD^XLFDT(ORNOW,7,"","","")_U_$$NOW^XLFDT
"RTN","ORB3TIM2",122,0)
 D EXCLN(ORNOW)
"RTN","ORB3TIM2",123,0)
 Q
"RTN","ORB3TIM2",124,0)
UDRENEW(EXORN,EXDT) ;extr function returns 1 if med is renewable, 0 if not
"RTN","ORB3TIM2",125,0)
 N ORNOW,ORSLT,ORSTATUS
"RTN","ORB3TIM2",126,0)
 S ORSLT=0
"RTN","ORB3TIM2",127,0)
 S ORSTATUS=$P($$STATUS^ORQOR2(EXORN),U,2)
"RTN","ORB3TIM2",128,0)
 I ORSTATUS="ACTIVE" Q 1  ;renewable if "active"
"RTN","ORB3TIM2",129,0)
 I ORSTATUS="HOLD" Q 1   ;renewable if "on hold"
"RTN","ORB3TIM2",130,0)
 I ORSTATUS="EXPIRED" D
"RTN","ORB3TIM2",131,0)
 .S ORNOW=$$NOW^XLFDT
"RTN","ORB3TIM2",132,0)
 .;renewable if expired w/in past 4 days:
"RTN","ORB3TIM2",133,0)
 .I $$FMDIFF^XLFDT(ORNOW,EXDT,1)<4 S ORSLT=1
"RTN","ORB3TIM2",134,0)
 Q ORSLT
"RTN","ORB3TIM2",135,0)
 ;
"RTN","ORB3TIM2",136,0)
IVRENEW(EXORN) ;extr function returns 1 if med is renewable, 0 if not
"RTN","ORB3TIM2",137,0)
 N ORSLT,ORSTATUS
"RTN","ORB3TIM2",138,0)
 S ORSLT=0
"RTN","ORB3TIM2",139,0)
 S ORSTATUS=$P($$STATUS^ORQOR2(EXORN),U,2)
"RTN","ORB3TIM2",140,0)
 I ORSTATUS="ACTIVE" Q 1   ;renewable if "active"
"RTN","ORB3TIM2",141,0)
 I ORSTATUS="HOLD" Q 1   ;renewable if "on hold"
"RTN","ORB3TIM2",142,0)
 I ORSTATUS="EXPIRED" Q 1  ;renewable if "expired"
"RTN","ORB3TIM2",143,0)
 Q ORSLT
"RTN","ORB3TIM2",144,0)
 ;
"RTN","ORB3TIM2",145,0)
EXCLN(ORNOW) ;clean up old entires in ^XTMP("ORB LAST EXPIRE")
"RTN","ORB3TIM2",146,0)
 N ORN,ORDT
"RTN","ORB3TIM2",147,0)
 S ORN=1
"RTN","ORB3TIM2",148,0)
 F  S ORN=$O(^XTMP("ORB LAST EXPIRE",ORN)) Q:ORN=""  D
"RTN","ORB3TIM2",149,0)
 .S ORDT=$G(^XTMP("ORB LAST EXPIRE",ORN))
"RTN","ORB3TIM2",150,0)
 .I $L(ORDT),(ORDT<ORNOW) D
"RTN","ORB3TIM2",151,0)
 ..K ^XTMP("ORB LAST EXPIRE",ORN)
"RTN","ORB3TIM2",152,0)
 Q
"RTN","ORCACT2")
0^9^B62329288^B60946711
"RTN","ORCACT2",1,0)
ORCACT2 ;SLC/MKB-DC orders ; 08 May 2002  2:12 PM
"RTN","ORCACT2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,48,79,92,108,94,141,149,265**;Dec 17, 1997;Build 17
"RTN","ORCACT2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCACT2",4,0)
DC ; -- start here with:
"RTN","ORCACT2",5,0)
 ;    ORNMBR = #,#,...,# of selected orders
"RTN","ORCACT2",6,0)
 ;
"RTN","ORCACT2",7,0)
 ;    OREBUILD defined on return if Orders tab needs to be rebuilt
"RTN","ORCACT2",8,0)
 ;
"RTN","ORCACT2",9,0)
 N ORACT,ORI,NMBR,ORQUIT,ORIFN,ORDC,OREVT,ORNATR,ORPTLK,ORLK,IDX,ORDITM,ORPRINT,ORERR,ORSTS,ORPRNT,ORCLNUP,ORDA,ORCREATE,OR0,OR3,OREASON,ORXNP,ORX S VALMBCK=""
"RTN","ORCACT2",10,0)
 S ORPTLK=$$LOCK^ORX2(+ORVP) I 'ORPTLK W !!,$C(7),$P(ORPTLK,U,2) H 2 Q
"RTN","ORCACT2",11,0)
 I '$G(ORNMBR) S ORNMBR=$$ORDERS^ORCHART("") G:'ORNMBR DCQ
"RTN","ORCACT2",12,0)
 D FREEZE^ORCMENU S ORACT="DC",VALMBCK="R" K OREBUILD
"RTN","ORCACT2",13,0)
DC1 F ORI=1:1:$L(ORNMBR,",") S NMBR=$P(ORNMBR,",",ORI) D:NMBR  Q:$D(ORQUIT)
"RTN","ORCACT2",14,0)
 . S IDX=$G(^TMP("OR",$J,ORTAB,"IDX",NMBR))
"RTN","ORCACT2",15,0)
 . S ORIFN=$S(ORTAB="MEDS":$P(IDX,U,4),1:$P(IDX,U)) Q:'ORIFN
"RTN","ORCACT2",16,0)
 . I '$D(^OR(100,+ORIFN,0)) W !,"This order has been deleted!" H 1 Q
"RTN","ORCACT2",17,0)
 . S:'$P(ORIFN,";",2) ORIFN=+ORIFN_";"_+$P($G(^OR(100,+ORIFN,3)),U,7)
"RTN","ORCACT2",18,0)
 . S ORDITM=$$ORDITEM(ORIFN) D SUBHDR(ORDITM)
"RTN","ORCACT2",19,0)
 . I '$$VALID^ORCACT0(ORIFN,ORACT,.ORERR) W !,ORERR H 1 Q
"RTN","ORCACT2",20,0)
 . S ORLK=$$LOCK1^ORX2(+ORIFN) I 'ORLK W !,$P(ORLK,U,2) H 1 Q
"RTN","ORCACT2",21,0)
 . S OR0=$G(^OR(100,+ORIFN,0)),OR3=$G(^(3)),ORSTS=$P($G(^(8,+$P(ORIFN,";",2),0)),U,15)
"RTN","ORCACT2",22,0)
 . S:$P(OR0,U,17) OREVT(+$P(OR0,U,17))="" ;ck event when done
"RTN","ORCACT2",23,0)
 . I (ORSTS=10)!(ORSTS=11) D UNREL Q  ;delete unreleased orders
"RTN","ORCACT2",24,0)
 . I $P(OR0,U,11)=$O(^ORD(100.98,"B","TF",0)),$P(OR3,U,3)=6 D RESUME(ORIFN) Q:$G(ORQUIT)
"RTN","ORCACT2",25,0)
DC2 . S ORDC(ORI)=ORIFN I $$NMSP^ORCD(+$P(OR0,U,14))="PS" S ORX=1 D  ;meds
"RTN","ORCACT2",26,0)
 .. I $P(OR3,U,9),$$VALUE^ORX8(+ORIFN,"SCHEDULE")'="NOW",$$DOSES^ORCACT4($P(OR3,U,9))>1 D
"RTN","ORCACT2",27,0)
 ... N I,X S ORDC("DAD",+$P(OR3,U,9),+ORIFN)=""
"RTN","ORCACT2",28,0)
 ... W !,$C(7),"This is part of a complex order, which will be discontinued in its entirety:"
"RTN","ORCACT2",29,0)
 ... S I=0 F  S I=$O(^OR(100,+$P(OR3,U,9),8,1,.1,I)) Q:I<1  S X=$G(^(I,0)) W:$$UP^XLFSTR(X)'=" FIRST DOSE NOW" !,X
"RTN","ORCACT2",30,0)
 .. N ORY,ORJ,ORV,ORTX,DA,DIK D DELAYED^ORX8(.ORY,+ORIFN) Q:ORY'>0
"RTN","ORCACT2",31,0)
 .. W !,+ORY_" delayed order(s) for the same medication were found:"
"RTN","ORCACT2",32,0)
 .. S ORJ=0 F  S ORJ=$O(ORY(ORJ)) Q:ORJ'>0  S ORV=ORY(ORJ) D TEXT^ORQ12(.ORTX,ORJ) W !,$E(ORTX(1),1,75)_$S($L(ORTX(1))>75:"...",1:""),!,"  >> delayed until "_$P(ORV,U,2)
"RTN","ORCACT2",33,0)
 .. I '$$OK(+ORY) W ! Q
"RTN","ORCACT2",34,0)
 .. W !,"Orders not signed or released to the service will be deleted.",!
"RTN","ORCACT2",35,0)
 .. S DIK="^OR(100,",DA=0 F  S DA=$O(ORY(DA)) Q:DA'>0  D
"RTN","ORCACT2",36,0)
 ... N ORJ,ORSIG,STS,ORLKD
"RTN","ORCACT2",37,0)
 ... S ORLKD=$$LOCK1^ORX2(+DA) I 'ORLKD W !,$P(ORLKD,U,2) H 1 Q
"RTN","ORCACT2",38,0)
 ... S STS=$P($G(^OR(100,DA,3)),U,3),ORSIG=$S($P($G(^(8,1,0)),U,4)=2:0,1:1)
"RTN","ORCACT2",39,0)
 ... I STS'=10 S ORDC($$NXT)=DA Q  ;released - add to list
"RTN","ORCACT2",40,0)
 ... D CLRDLY(DA):ORSIG,^DIK:'ORSIG S OREVT(+ORY(DA))=""
"RTN","ORCACT2",41,0)
 ... I $D(^TMP("ORNEW",$J,DA,1)) K ^(1) D UNLK1^ORX2(DA) ;unlock again
"RTN","ORCACT2",42,0)
 G:'$O(ORDC(0)) DCQ D:$D(ORDC("DAD")) COMPLX
"RTN","ORCACT2",43,0)
DC3 S OREASON=$$DCREASON I OREASON'>0 D UNLOCK G DCQ
"RTN","ORCACT2",44,0)
 S ORNATR=$P(OREASON,U,3),ORCREATE=1 ; CHGD $$CREATE^ORX1(ORNATR)
"RTN","ORCACT2",45,0)
 I 'ORCREATE,$G(ORX),$D(^XUSEC("OREMAS",DUZ)),$$GET^XPAR("ALL","OR OREMAS MED ORDERS")<2 W $C(7),!,"You are not authorized to release med orders.",! G DC3
"RTN","ORCACT2",46,0)
 I ORCREATE D  I (ORNP="^")!($G(ORL)="^") D UNLOCK G DCQ
"RTN","ORCACT2",47,0)
 . S ORNP=$$PROVIDER^ORCMENU1 Q:ORNP="^"  ;S:ORNP=DUZ ORNATR="E"
"RTN","ORCACT2",48,0)
 . I $G(ORX) D PROVIDER^ORCDPSIV I $G(ORQUIT) S ORNP="^" Q
"RTN","ORCACT2",49,0)
 . S:'$G(ORL) ORL=$$LOCATION^ORCMENU1
"RTN","ORCACT2",50,0)
 W ! W:'ORCREATE "Discontinuing orders ..."
"RTN","ORCACT2",51,0)
 S ORPRNT=$$PRINT(ORNATR),ORCLNUP=$S(ORNATR="D":1,ORNATR="M":1,1:0)
"RTN","ORCACT2",52,0)
 S (ORI,ORPRINT)=0 F  S ORI=$O(ORDC(ORI)) Q:ORI'>0  S ORIFN=ORDC(ORI) D
"RTN","ORCACT2",53,0)
 . I ORCREATE S ORDA=$$ACTION^ORCSAVE("DC",+ORIFN,ORNP) Q:'ORDA  D SET(+ORIFN,ORNATR,+OREASON,$P(OREASON,U,2)) S ^TMP("ORNEW",$J,+ORIFN,ORDA)="" W "." Q
"RTN","ORCACT2",54,0)
 . ; release -> no order or ES req'd
"RTN","ORCACT2",55,0)
 . D EN^ORCSEND(+ORIFN,ORACT,3,1,ORNATR,+OREASON,.ORERR),UNLK1^ORX2(+ORIFN)
"RTN","ORCACT2",56,0)
 . I '$G(ORERR) S:$P(ORPRNT,U)!$P(ORPRNT,U,5) ORPRINT=ORPRINT+1,ORPRINT(ORPRINT)=+ORIFN_";" W "." Q
"RTN","ORCACT2",57,0)
 . W !,$$ORDITEM(+ORIFN)_" not discontinued."
"RTN","ORCACT2",58,0)
 . W:$L($P($G(ORERR),U,2)) !,"  >> "_$P(ORERR,U,2) W ! H 1
"RTN","ORCACT2",59,0)
 W:ORCREATE "... discontinue order(s) placed." H 1
"RTN","ORCACT2",60,0)
 I $O(ORPRINT(0)) D PRINT^ORPR02(ORVP,.ORPRINT,,ORL,ORPRNT)
"RTN","ORCACT2",61,0)
 S OREBUILD=1 ; rebuild orders list
"RTN","ORCACT2",62,0)
DCQ D:$G(OREBUILD) UNOTIF^ORCSIGN ; undo notif?
"RTN","ORCACT2",63,0)
 D:'$D(^TMP("ORNEW",$J)) UNLOCK^ORX2(+ORVP) ;unlock if no new orders
"RTN","ORCACT2",64,0)
 S:$G(ORXNP) ORNP=ORXNP ;reset provider if needed
"RTN","ORCACT2",65,0)
 D:$D(OREVT) EVENT ;cancel any events?
"RTN","ORCACT2",66,0)
 Q
"RTN","ORCACT2",67,0)
 ;
"RTN","ORCACT2",68,0)
UNLOCK ; -- Unlock orders in ORDC(ORI)=ORIFN
"RTN","ORCACT2",69,0)
 N ORI,ORIFN S ORI=0
"RTN","ORCACT2",70,0)
 F  S ORI=$O(ORDC(ORI)) Q:ORI'>0  S ORIFN=+ORDC(ORI) D UNLK1^ORX2(ORIFN)
"RTN","ORCACT2",71,0)
 Q
"RTN","ORCACT2",72,0)
 ;
"RTN","ORCACT2",73,0)
OK(NUM) ; -- Ok to DC delayed order(s) too?
"RTN","ORCACT2",74,0)
 N X,Y,DIR S DIR(0)="YA",DIR("B")="NO"
"RTN","ORCACT2",75,0)
 S DIR("A")="Do you want to discontinue "_$S(NUM>1:"these orders",1:"this order")_" too? "
"RTN","ORCACT2",76,0)
 S DIR("?")="Enter YES to also cancel the delayed order(s), or NO to allow the order(s) to be activated when the designated event occurs."
"RTN","ORCACT2",77,0)
 W ! D ^DIR
"RTN","ORCACT2",78,0)
 Q +Y
"RTN","ORCACT2",79,0)
 ;
"RTN","ORCACT2",80,0)
NXT() ; -- Return next available subscript in ORDC()
"RTN","ORCACT2",81,0)
 N Y S Y=$L(ORNMBR,",")+1 S:Y'>$O(ORDC(""),-1) Y=$O(ORDC(""),-1)+1
"RTN","ORCACT2",82,0)
 Q Y
"RTN","ORCACT2",83,0)
 ;
"RTN","ORCACT2",84,0)
PRINT(NATR) ; -- Ok to print order?
"RTN","ORCACT2",85,0)
 N I,OR1,Y S I=$O(^ORD(100.02,"C",NATR,0)),OR1=$G(^ORD(100.02,I,1))
"RTN","ORCACT2",86,0)
 S Y=$P(OR1,U,2)_"^^^^"_$P(OR1,U,5)
"RTN","ORCACT2",87,0)
 Q Y
"RTN","ORCACT2",88,0)
 ;
"RTN","ORCACT2",89,0)
ORDITEM(ID) ; -- Returns order text
"RTN","ORCACT2",90,0)
 ;N X,I,MORE S X=""
"RTN","ORCACT2",91,0)
 ;I $P(ID,";",2)>1 S I=$P($G(^OR(100,+ID,8,+$P(ID,";",2),0)),U,2),X=$S(I="DC":"Discontinue ",I="HD":"Hold ",1:"")
"RTN","ORCACT2",92,0)
 ;S I=$O(^OR(100,+ID,1,0)) Q:'I "" S MORE=$O(^(I)),X=X_$G(^(I,0))
"RTN","ORCACT2",93,0)
 ;I $L(X)>68 S X=$E(X,1,68),MORE=1
"RTN","ORCACT2",94,0)
 ;S:MORE X=X_" ..."
"RTN","ORCACT2",95,0)
 N X,ORX D TEXT^ORQ12(.ORX,ID,68) S X=ORX(1)_$S(ORX>1:" ...",1:"")
"RTN","ORCACT2",96,0)
 Q X
"RTN","ORCACT2",97,0)
 ;
"RTN","ORCACT2",98,0)
SUBHDR(X) ; -- Display subheader of order being acted on
"RTN","ORCACT2",99,0)
 W !!,?(36-($L(X)\2)),"-- "_X_" --",!
"RTN","ORCACT2",100,0)
 Q
"RTN","ORCACT2",101,0)
 ;
"RTN","ORCACT2",102,0)
COMPLX ; -- Ck for other child orders to be dc'd at same time
"RTN","ORCACT2",103,0)
 N DAD,CHLD
"RTN","ORCACT2",104,0)
 S DAD=0 F  S DAD=$O(ORDC("DAD",DAD)) Q:DAD<1  D
"RTN","ORCACT2",105,0)
 . S CHLD=0 F  S CHLD=$O(^OR(100,DAD,2,CHLD)) Q:CHLD<1  D
"RTN","ORCACT2",106,0)
 .. Q:"^1^2^7^12^13^14^15^"[(U_$P($G(^OR(100,CHLD,3)),U,3)_U)
"RTN","ORCACT2",107,0)
 .. Q:$D(ORDC("DAD",DAD,CHLD))  S ORDC($$NXT)=CHLD
"RTN","ORCACT2",108,0)
 Q
"RTN","ORCACT2",109,0)
 ;
"RTN","ORCACT2",110,0)
DCREASON() ; -- Returns Reason for DC
"RTN","ORCACT2",111,0)
 N X,Y,DIC
"RTN","ORCACT2",112,0)
 ;I $D(^XUSEC("ORES",DUZ)) S Y=+$O(^ORD(100.03,"C","ORREQ",0)) I Y S Y(0)=$G(^ORD(100.03,Y,0)),Y=Y_U_$P(Y(0),U) G DCRQ ; silent
"RTN","ORCACT2",113,0)
 S DIC="^ORD(100.03,",DIC(0)="AEMQZ",DIC("B")=+$O(^ORD(100.03,"C","ORREQ",0)),DIC("W")="W:$L($P(^(0),U))>30 $E($P(^(0),U),31,999)" K:DIC("B")'>0 DIC("B")
"RTN","ORCACT2",114,0)
 S DIC("S")="I '$P(^(0),U,4),$P(^(0),U,5)="_+$O(^DIC(9.4,"C","OR",0))_",$P(^(0),U,7)'="_+$O(^ORD(100.02,"C","A",0)),DIC("A")="REASON FOR DC: "  ;is referenced by DBIA #2058
"RTN","ORCACT2",115,0)
 D ^DIC
"RTN","ORCACT2",116,0)
DCRQ S:Y>0 Y=Y_U_$S($P(Y(0),U,7):$P($G(^ORD(100.02,+$P(Y(0),U,7),0)),U,2),1:"W") ; ^nature
"RTN","ORCACT2",117,0)
 Q Y
"RTN","ORCACT2",118,0)
 ;
"RTN","ORCACT2",119,0)
SET(ORDER,NATURE,REASON,TEXT) ; -- Set DC Reason into 6-node
"RTN","ORCACT2",120,0)
 Q:'$G(ORDER)  Q:'$D(^OR(100,+ORDER,0))  S ORDER=+ORDER
"RTN","ORCACT2",121,0)
 I $L($G(NATURE)),NATURE'>0 S NATURE=$O(^ORD(100.02,"C",NATURE,0))
"RTN","ORCACT2",122,0)
 S ^OR(100,ORDER,6)=$G(NATURE)_U_DUZ_U_$E($$NOW^XLFDT,1,12)_U_$G(REASON)_U_$G(TEXT)
"RTN","ORCACT2",123,0)
 Q
"RTN","ORCACT2",124,0)
 ;
"RTN","ORCACT2",125,0)
RESUME(ORDER) ; -- Resume tray service when dc'ing tubefeeding ORDER?
"RTN","ORCACT2",126,0)
 N X,Y,DIR,DIC,DA S X=$$RESUME^FHWORR(+ORVP)
"RTN","ORCACT2",127,0)
 I '$L(X) W !,"NOTE: NO current diet order exists for this patient!" Q
"RTN","ORCACT2",128,0)
 Q:'X  I X=2 W !,"Note: Patient is on a WITHHOLD SERVICE order!"
"RTN","ORCACT2",129,0)
 S DIR(0)="YA",DIR("A")="Do you wish to resume tray service? "
"RTN","ORCACT2",130,0)
 S DIR("?")="Enter YES to resume the previous diet order",DIR("B")="NO"
"RTN","ORCACT2",131,0)
 D ^DIR I Y'=1 S:$D(DTOUT)!(X["^") ORQUIT=1
"RTN","ORCACT2",132,0)
 D:Y=1 RESUME^ORCSAVE(+ORDER)
"RTN","ORCACT2",133,0)
 Q
"RTN","ORCACT2",134,0)
 ;
"RTN","ORCACT2",135,0)
UNREL ; -- Process unreleased/delayed order
"RTN","ORCACT2",136,0)
 N ORA,ORA0,ORDEL,DA,DR,DIE
"RTN","ORCACT2",137,0)
 S ORA=+$P(ORIFN,";",2),ORA0=$G(^OR(100,+ORIFN,8,ORA,0))
"RTN","ORCACT2",138,0)
 S ORDEL=$S(ORSTS=11:1,$P(ORA0,U,4)=2:1,1:0)
"RTN","ORCACT2",139,0)
 W !,"This order was not released "_$S(ORDEL:"to the service and will be deleted.",1:"but signed and will be cancelled.") H 1 I ORDEL D
"RTN","ORCACT2",140,0)
 . K:$P(ORA0,U,2)="DC" ^OR(100,+ORIFN,6) I $P(ORA0,U,2)="NW" D
"RTN","ORCACT2",141,0)
 .. S:$P(OR3,U,5) $P(^OR(100,+$P(OR3,U,5),3),U,6)=""
"RTN","ORCACT2",142,0)
 .. I $P(OR0,U,17) S DA=+$O(^ORE(100.2,"AO",+ORIFN,0)) I DA S DR="4///@",DIE=100.2 D ^DIE
"RTN","ORCACT2",143,0)
 . D DELETE^ORCSAVE2(ORIFN)
"RTN","ORCACT2",144,0)
 D CLRDLY(+ORIFN):'ORDEL,UNLK1^ORX2(+ORIFN) S OREBUILD=1
"RTN","ORCACT2",145,0)
 I $D(^TMP("ORNEW",$J,+ORIFN,ORA)) K ^(ORA) D UNLK1^ORX2(+ORIFN) ;decrement lock again
"RTN","ORCACT2",146,0)
 Q
"RTN","ORCACT2",147,0)
 ;
"RTN","ORCACT2",148,0)
EVENT ; -- Cancel event too?
"RTN","ORCACT2",149,0)
 N EVT,X
"RTN","ORCACT2",150,0)
 S EVT=0 F  S EVT=$O(OREVT(EVT)) Q:EVT<1  D  Q:$G(ORQUIT)
"RTN","ORCACT2",151,0)
 . Q:$G(^ORE(100.2,EVT,1))  Q:'$$EMPTY^OREVNTX(EVT)  ;done or has orders
"RTN","ORCACT2",152,0)
 . ;W !!,$P($$NAME^OREVNTX(EVT)," ",2,99)_" has no more delayed orders."
"RTN","ORCACT2",153,0)
 . ;S DIR(0)="YA",DIR("A")="Do you want to cancel this event? "
"RTN","ORCACT2",154,0)
 . ;S DIR("?")="Enter NO if you wish to enter new delayed orders for this event, otherwise enter YES to terminate it."
"RTN","ORCACT2",155,0)
 . ;S DIR("B")="YES" D ^DIR I $D(DTOUT)!$D(DUOUT) S ORQUIT=1 Q
"RTN","ORCACT2",156,0)
 . D CANCEL^OREVNTX(EVT) S X=$P($$NAME^OREVNTX(EVT)," ",2,99)
"RTN","ORCACT2",157,0)
 . W !,"   ... "_X_" event cancelled." H 1
"RTN","ORCACT2",158,0)
 . I $G(OREVENT),OREVENT=EVT D EX^OREVNT ;Return to Active Orders
"RTN","ORCACT2",159,0)
 Q
"RTN","ORCACT2",160,0)
 ;
"RTN","ORCACT2",161,0)
DCD(IFN) ; -- order discontinued already?
"RTN","ORCACT2",162,0)
 N STS,Y,I S Y=0 I '$G(IFN) Q 1
"RTN","ORCACT2",163,0)
 S STS=+$P($G(^OR(100,+IFN,3)),U,3)
"RTN","ORCACT2",164,0)
 I "^1^2^7^12^13^14^"[(U_STS_U) S Y=1 G DQ ;terminal sts
"RTN","ORCACT2",165,0)
 ;look for existing DC action awaiting ES:
"RTN","ORCACT2",166,0)
 S I=0 F  S I=+$O(^OR(100,+IFN,8,"C","DC",I)) Q:I<1  I $P($G(^OR(100,+IFN,8,I,0)),U,15)=11 S Y=1 Q
"RTN","ORCACT2",167,0)
DQ Q Y
"RTN","ORCACT2",168,0)
 ;
"RTN","ORCACT2",169,0)
CLRDLY(IFN) ; -- [old Clear delayed fields] Cancel delayed [event]order
"RTN","ORCACT2",170,0)
 N STS,ORX S IFN=+$G(IFN) Q:IFN'>0
"RTN","ORCACT2",171,0)
 Q:'$D(^OR(100,IFN,0))  S STS=$P($G(^(3)),U,3)
"RTN","ORCACT2",172,0)
 S ORX="Delayed "_$S(STS=10:"Order",1:"Release Event")_" Cancelled"
"RTN","ORCACT2",173,0)
 S ^OR(100,IFN,6)=$O(^ORD(100.02,"C","M",0))_U_DUZ_U_+$E($$NOW^XLFDT,1,12)_U_U_ORX
"RTN","ORCACT2",174,0)
 D STATUS^ORCSAVE2(IFN,13) S $P(^OR(100,IFN,8,1,0),U,15)=13
"RTN","ORCACT2",175,0)
 Q
"RTN","ORCSAVE2")
0^5^B47694215^B45774520
"RTN","ORCSAVE2",1,0)
ORCSAVE2 ;SLC/MKB-Utilities to update an order ;04:19 PM  06/16/2004
"RTN","ORCSAVE2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**4,27,56,70,94,116,190,157,215,265**;Dec 17, 1997;Build 17
"RTN","ORCSAVE2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORCSAVE2",4,0)
 ;
"RTN","ORCSAVE2",5,0)
STATUS(IFN,ST) ; -- Update status of order
"RTN","ORCSAVE2",6,0)
 Q:'$G(IFN)  Q:'$D(^OR(100,+IFN,0))  Q:$P($G(^(3)),U,3)=$G(ST)  ;no change
"RTN","ORCSAVE2",7,0)
 Q:'$G(ST)  Q:'$D(^ORD(100.01,+ST,0))
"RTN","ORCSAVE2",8,0)
 N NODE0,NODE3,ORNOW,DA,XACT,PROV,ORVP
"RTN","ORCSAVE2",9,0)
 S NODE3=$G(^OR(100,+IFN,3)),ORVP=$P($G(^(0)),U,2),ORNOW=$$NOW^XLFDT
"RTN","ORCSAVE2",10,0)
 S $P(NODE3,U)=ORNOW,$P(NODE3,U,3)=ST,^OR(100,+IFN,3)=NODE3
"RTN","ORCSAVE2",11,0)
 I (ST<3)!(ST=12)!(ST=13),$G(ORDCNTRL)'="ZC" D DATES(+IFN,,+$E(ORNOW,1,12))
"RTN","ORCSAVE2",12,0)
 I "^1^2^7^12^13^15^"[(U_ST_U) D CANCEL^ORCSEND(+IFN),UNOTIF^ORCSIGN
"RTN","ORCSAVE2",13,0)
 I $P(NODE3,U,9) D CKPARENT($P(NODE3,U,9)) ; ck siblings to update parent
"RTN","ORCSAVE2",14,0)
 D SETALL^ORDD100(+IFN)
"RTN","ORCSAVE2",15,0)
 Q
"RTN","ORCSAVE2",16,0)
 ;
"RTN","ORCSAVE2",17,0)
CKPARENT(ORIFN) ; -- Update status of parent order, if appropriate
"RTN","ORCSAVE2",18,0)
 N ORSTS,ALLRELSD,ALLDONE,DC,COMP,CH,CHSTS,ACTIVE,LAPS
"RTN","ORCSAVE2",19,0)
 Q:'$D(^OR(100,ORIFN,0))  S ORSTS=$P($G(^(3)),U,3)
"RTN","ORCSAVE2",20,0)
 I (ORSTS=11)!(ORSTS=10) S ALLRELSD=1 D  Q  ;Parent unrel'd - ck children
"RTN","ORCSAVE2",21,0)
 . F CH=0:0 S CH=$O(^OR(100,ORIFN,2,CH)) Q:CH'>0  D  Q:'ALLRELSD
"RTN","ORCSAVE2",22,0)
 . . I '$D(^OR(100,CH)) K ^OR(100,ORIFN,2,CH) Q
"RTN","ORCSAVE2",23,0)
 . . S CHSTS=$P($G(^OR(100,CH,3)),U,3) S:CHSTS=11 ALLRELSD=0
"RTN","ORCSAVE2",24,0)
 . I ALLRELSD D STATUS(ORIFN,5) ; update Parent order to pending
"RTN","ORCSAVE2",25,0)
 S ALLDONE=1,(DC,COMP,LAPS,ACTIVE)=0
"RTN","ORCSAVE2",26,0)
 F CH=0:0 S CH=$O(^OR(100,ORIFN,2,CH)) Q:CH'>0  D  Q:'ALLDONE
"RTN","ORCSAVE2",27,0)
 . I '$D(^OR(100,CH)) K ^OR(100,ORIFN,2,CH) Q
"RTN","ORCSAVE2",28,0)
 . S CHSTS=$P($G(^OR(100,CH,3)),U,3) I CHSTS=14 S LAPS=1 Q
"RTN","ORCSAVE2",29,0)
 . I "^1^12^13^"[(U_CHSTS_U) S DC=1 Q
"RTN","ORCSAVE2",30,0)
 . I "^2^7^"[(U_CHSTS_U) S COMP=1 Q
"RTN","ORCSAVE2",31,0)
 . S ALLDONE=0 S:CHSTS=6 ACTIVE=1
"RTN","ORCSAVE2",32,0)
 I ALLDONE S ORSTS=$S(COMP:2,DC:1,LAPS:14,1:"") D:ORSTS STATUS(ORIFN,ORSTS) Q
"RTN","ORCSAVE2",33,0)
 I ACTIVE,ORSTS'=6 D STATUS(ORIFN,6) ;at least child active
"RTN","ORCSAVE2",34,0)
 Q
"RTN","ORCSAVE2",35,0)
 ;
"RTN","ORCSAVE2",36,0)
RELEASE(ORDER,ACTION,WHEN,WHO,NATURE) ; -- Mark order as released to service
"RTN","ORCSAVE2",37,0)
 S:'$G(ACTION) ACTION=1 S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12) S:'$G(WHO) WHO=DUZ
"RTN","ORCSAVE2",38,0)
 Q:'$G(ORDER)  N OR0 S OR0=$G(^OR(100,ORDER,8,ACTION,0))
"RTN","ORCSAVE2",39,0)
 S:$L($G(NATURE)) $P(OR0,U,12)=$S(NATURE:NATURE,1:+$O(^ORD(100.02,"C",NATURE,0)))
"RTN","ORCSAVE2",40,0)
 S:($P(OR0,U,15)=10)!($P(OR0,U,15)=11) $P(OR0,U,15)=""
"RTN","ORCSAVE2",41,0)
 ;S $P(OR0,U,16,17)=WHEN_U_WHO,^OR(100,"AR",ORVP,9999999-WHEN,ORDER,ACTION)=""
"RTN","ORCSAVE2",42,0)
 S $P(OR0,U,16,17)=WHEN_U_WHO
"RTN","ORCSAVE2",43,0)
 S ^OR(100,ORDER,8,ACTION,0)=OR0
"RTN","ORCSAVE2",44,0)
 I $P(OR0,U,2)="NW",'$P(^OR(100,ORDER,0),U,8) D STARTDT(ORDER)
"RTN","ORCSAVE2",45,0)
 ;Set the "AR" index.
"RTN","ORCSAVE2",46,0)
 D RS^ORDD100(ORDER,ACTION,ORVP,WHEN)
"RTN","ORCSAVE2",47,0)
 Q
"RTN","ORCSAVE2",48,0)
 ;
"RTN","ORCSAVE2",49,0)
STARTDT(DA) ; -- resolve Start and Stop dates from Responses
"RTN","ORCSAVE2",50,0)
 N X,Y,%DT,ORDG,ORT,ORLAB
"RTN","ORCSAVE2",51,0)
 S ORDG=$P($G(^ORD(100.98,+$P(^OR(100,DA,0),U,11),0)),U,3)
"RTN","ORCSAVE2",52,0)
 S ORLAB="^LAB^CH^HEMA^MI^AP^AU^EM^SP^CY^BB^"[(U_ORDG_U),ORT=""
"RTN","ORCSAVE2",53,0)
 S:ORDG="E/L T" ORT=$$VALUE(DA,"TIME") S:ORDG="MEAL" ORT=$$MEALTIME^ORCDFHO(DA)
"RTN","ORCSAVE2",54,0)
STRT S X=$$VALUE(DA,"START") I '$L(X) D WS^ORDD100 Q  S:$L(ORT) X=X_"@"_ORT
"RTN","ORCSAVE2",55,0)
 D AM:X="AM",NEXT:X="NEXT",ADMIN("NEXT"):X="NEXTA",ADMIN("CLOSEST"):X="CLOSEST"
"RTN","ORCSAVE2",56,0)
 S %DT="T" D ^%DT Q:Y'>0  S:$E($P(Y,".",2),1,2)=24 Y=$P(Y,".")_".2359"
"RTN","ORCSAVE2",57,0)
 S $P(^OR(100,DA,0),U,8)=Y D SS^ORDD100,WS^ORDD100,OI1^ORDD100A(DA)
"RTN","ORCSAVE2",58,0)
STOP I ORLAB S X=$$VALUE(DA,"DAYS") Q:X'>1  S X=$$FMADD^XLFDT(Y,(X-1))
"RTN","ORCSAVE2",59,0)
 I 'ORLAB S X=$$VALUE(DA,"STOP") Q:'$L(X)  S:$L(ORT) X=X_"@"_ORT
"RTN","ORCSAVE2",60,0)
 S %DT="T" D ^%DT Q:Y'>0  S:$E($P(Y,".",2),1,2)=24 Y=$P(Y,".")_".2359"
"RTN","ORCSAVE2",61,0)
 S $P(^OR(100,DA,0),U,9)=Y D ES^ORDD100A
"RTN","ORCSAVE2",62,0)
 Q
"RTN","ORCSAVE2",63,0)
 ;
"RTN","ORCSAVE2",64,0)
NEXT ; -- Resolve next lab collection to FM date/time
"RTN","ORCSAVE2",65,0)
 N ORTIME,ORDAY,NOW,NEXT,ENT
"RTN","ORCSAVE2",66,0)
 S ENT=$S($P($G(^SC(+$G(ORL),0)),U,4):+$P(^(0),U,4),1:+$G(DUZ(2)))_";DIC(4," S:ENT'>0 ENT="ALL"   ;is referenced by DBIA #964
"RTN","ORCSAVE2",67,0)
 D GETLST^XPAR(.ORTIME,ENT,"LR PHLEBOTOMY COLLECTION","N")
"RTN","ORCSAVE2",68,0)
 S NOW=$P($H,",",2),ORDAY=$S($O(ORTIME(NOW)):"T",1:"T+1")
"RTN","ORCSAVE2",69,0)
 S ORDAY=$$NEXTCOLL^ORCDLR1(ORDAY) S:ORDAY["+" NOW=0
"RTN","ORCSAVE2",70,0)
 S NEXT=$O(ORTIME(NOW)),X=ORDAY_"@"_$P($G(ORTIME(+NEXT)),U)
"RTN","ORCSAVE2",71,0)
 Q
"RTN","ORCSAVE2",72,0)
 ;
"RTN","ORCSAVE2",73,0)
AM ; -- Resolve AM lab collection to FM date/time
"RTN","ORCSAVE2",74,0)
 N ORTIME,ORDAY,AM,NOW,ENT
"RTN","ORCSAVE2",75,0)
 S ENT=$S($P($G(^SC(+$G(ORL),0)),U,4):+$P(^(0),U,4),1:+$G(DUZ(2)))_";DIC(4," S:ENT'>0 ENT="ALL"   ;is referenced by DBIA #964
"RTN","ORCSAVE2",76,0)
 D GETLST^XPAR(.ORTIME,ENT,"LR PHLEBOTOMY COLLECTION","N")
"RTN","ORCSAVE2",77,0)
 S AM=$O(ORTIME(0)),NOW=$P($H,",",2)
"RTN","ORCSAVE2",78,0)
 S ORDAY=$S(AM=$O(ORTIME(NOW)):"T",1:"T+1")
"RTN","ORCSAVE2",79,0)
 S X=$$NEXTCOLL^ORCDLR1(ORDAY)_"@"_$P($G(ORTIME(+AM)),U)
"RTN","ORCSAVE2",80,0)
 Q
"RTN","ORCSAVE2",81,0)
 ;
"RTN","ORCSAVE2",82,0)
ADMIN(START) ; -- Resolve next/closest administration times to FM date/time
"RTN","ORCSAVE2",83,0)
 N PAT,SCH,OI,LOC,Y,I
"RTN","ORCSAVE2",84,0)
 I $G(DA) D  ;get data from order DA
"RTN","ORCSAVE2",85,0)
 . S PAT=+$P($G(^OR(100,DA,0)),U,2),LOC=""
"RTN","ORCSAVE2",86,0)
 . S I=+$O(^OR(100,DA,4.5,"ID","INSTR",0)),I=+$P($G(^OR(100,DA,4.5,I,0)),U,3) ;first
"RTN","ORCSAVE2",87,0)
 . S SCH=$$VALUE(DA,"SCHEDULE",I),OI=$$VALUE(DA,"ORDERABLE")
"RTN","ORCSAVE2",88,0)
 I '$G(DA) D  ;or look in ORDIALOG() instead
"RTN","ORCSAVE2",89,0)
 . S I=+$O(ORDIALOG($$PTR^ORCD("OR GTX INSTRUCTIONS"),0))
"RTN","ORCSAVE2",90,0)
 . S PAT=$G(ORVP),SCH=$G(ORDIALOG($$PTR^ORCD("OR GTX SCHEDULE"),I))
"RTN","ORCSAVE2",91,0)
 . S OI=$G(ORDIALOG($$PTR^ORCD("OR GTX ORDERABLE ITEM"),1)),LOC=""
"RTN","ORCSAVE2",92,0)
 S OI=+$P($G(^ORD(101.43,+OI,0)),U,2) ;PSOI
"RTN","ORCSAVE2",93,0)
 S Y=$$RESOLVE^PSJORPOE(PAT,SCH,OI,START,LOC),X=$P(Y,U,2)   ;is referenced by DBIA #3167
"RTN","ORCSAVE2",94,0)
 Q
"RTN","ORCSAVE2",95,0)
 ;
"RTN","ORCSAVE2",96,0)
SIGN(DA,WHO,WHEN,HOW,WHAT) ; -- affix ES to order
"RTN","ORCSAVE2",97,0)
 Q:'$G(DA)  S:'$G(WHAT) WHAT=1
"RTN","ORCSAVE2",98,0)
 N X S X=$G(^OR(100,DA,8,WHAT,0)) D S2^ORDD100(DA,WHAT) ; kill AS xref
"RTN","ORCSAVE2",99,0)
 S $P(X,U,4,7)=$G(HOW)_U_$G(WHO)_U_$E($G(WHEN),1,12)_U_$S(HOW=0:DUZ,1:"")
"RTN","ORCSAVE2",100,0)
 ; S:$G(WHO) $P(X,U,3)=WHO ; reset provider to signer
"RTN","ORCSAVE2",101,0)
 S ^OR(100,DA,8,WHAT,0)=X
"RTN","ORCSAVE2",102,0)
 D:$G(HOW)=2 S1^ORDD100(DA,WHAT) ; reset AS xref
"RTN","ORCSAVE2",103,0)
 Q
"RTN","ORCSAVE2",104,0)
 ;
"RTN","ORCSAVE2",105,0)
SIGSTS(IFN,ACT) ; -- Set SigSts for backdoor orders [Called from ^ORM* rtns]
"RTN","ORCSAVE2",106,0)
 ; Expects ORNATR, ORVP, ORNP to be defined
"RTN","ORCSAVE2",107,0)
 Q:'$G(IFN)  Q:'$G(ACT)  N X,OR0 S OR0=+$P($G(^OR(100,+IFN,8,ACT,0)),U)
"RTN","ORCSAVE2",108,0)
 S X=$S($$SIGNREQD^ORCACT1(+IFN):$$SIGSTS^ORX1(ORNATR),1:3)
"RTN","ORCSAVE2",109,0)
 K ^OR(100,"AS",ORVP,9999999-OR0,+IFN,ACT)
"RTN","ORCSAVE2",110,0)
 S $P(^OR(100,+IFN,8,ACT,0),U,4)=X
"RTN","ORCSAVE2",111,0)
 I X=2 S ^OR(100,"AS",ORVP,9999999-OR0,+IFN,ACT)="" D NOTIF^ORCSIGN
"RTN","ORCSAVE2",112,0)
 Q
"RTN","ORCSAVE2",113,0)
 ;
"RTN","ORCSAVE2",114,0)
UNVEIL(IFN) ; -- unveil new order
"RTN","ORCSAVE2",115,0)
 S $P(^OR(100,IFN,3),U,8)=""
"RTN","ORCSAVE2",116,0)
 Q
"RTN","ORCSAVE2",117,0)
 ;
"RTN","ORCSAVE2",118,0)
DELETE(ORDER) ; -- delete order [action]
"RTN","ORCSAVE2",119,0)
 N DIK,DA,DAD
"RTN","ORCSAVE2",120,0)
 I $P(ORDER,";",2)>1 S DA=+$P(ORDER,";",2),DA(1)=+ORDER,DIK="^OR(100,"_DA(1)_",8," D:DA ^DIK Q
"RTN","ORCSAVE2",121,0)
 S DAD=+$P($G(^OR(100,+ORDER,3)),U,9) I DAD S DIK="^OR(100,"_DAD_",2,",DA(1)=DAD,DA=+ORDER D ^DIK ; remove link to child from parent
"RTN","ORCSAVE2",122,0)
 K DA S DA=+ORDER,DIK="^OR(100," D ^DIK ;remove order, text
"RTN","ORCSAVE2",123,0)
 Q
"RTN","ORCSAVE2",124,0)
 ;
"RTN","ORCSAVE2",125,0)
VERIFY(IFN,DA,TYPE,WHO,WHEN) ; -- order verified
"RTN","ORCSAVE2",126,0)
 Q:'$G(IFN)  Q:'$G(DA)  Q:"^N^C^R^"'[(U_$G(TYPE)_U)
"RTN","ORCSAVE2",127,0)
 N FLD S FLD=$S(TYPE="N":8,TYPE="C":10,1:18)
"RTN","ORCSAVE2",128,0)
 S:'$G(WHO) WHO=DUZ S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12)
"RTN","ORCSAVE2",129,0)
 S $P(^OR(100,IFN,8,DA,0),U,FLD,FLD+1)=WHO_U_WHEN
"RTN","ORCSAVE2",130,0)
 Q
"RTN","ORCSAVE2",131,0)
 ;
"RTN","ORCSAVE2",132,0)
COMP(IFN,WHO,WHEN) ; -- order completed
"RTN","ORCSAVE2",133,0)
 Q:'$G(IFN)  S:'$G(WHO) WHO=DUZ S:'$G(WHEN) WHEN=+$E($$NOW^XLFDT,1,12)
"RTN","ORCSAVE2",134,0)
 D DATES(+IFN,,WHEN),STATUS(+IFN,2)
"RTN","ORCSAVE2",135,0)
 S $P(^OR(100,+IFN,6),U,6,7)=WHEN_U_WHO
"RTN","ORCSAVE2",136,0)
 Q
"RTN","ORCSAVE2",137,0)
 ;
"RTN","ORCSAVE2",138,0)
DATES(DA,START,STOP) ; -- Update start/stop dates for order DA
"RTN","ORCSAVE2",139,0)
 Q:'$G(DA)  I $G(START) D
"RTN","ORCSAVE2",140,0)
 . Q:START=$P(^OR(100,DA,0),U,8)
"RTN","ORCSAVE2",141,0)
 . D SK^ORDD100,WK^ORDD100,OI2^ORDD100A(DA)
"RTN","ORCSAVE2",142,0)
 . S $P(^OR(100,DA,0),U,8)=START
"RTN","ORCSAVE2",143,0)
 . D SS^ORDD100,WS^ORDD100,OI1^ORDD100A(DA)
"RTN","ORCSAVE2",144,0)
 I $G(STOP) D
"RTN","ORCSAVE2",145,0)
 . ;Q:STOP=$P(^OR(100,DA,0),U,9)  ;ck xref anyway
"RTN","ORCSAVE2",146,0)
 . D EK^ORDD100A S $P(^OR(100,DA,0),U,9)=STOP D ES^ORDD100A
"RTN","ORCSAVE2",147,0)
 Q
"RTN","ORCSAVE2",148,0)
 ;
"RTN","ORCSAVE2",149,0)
OC ; -- Save order checks in ORCHECK() in ^OR(100,+ORIFN,9)
"RTN","ORCSAVE2",150,0)
 Q:'$G(ORIFN)  Q:'$D(^OR(100,+ORIFN,0))  K ^OR(100,+ORIFN,9)
"RTN","ORCSAVE2",151,0)
 N NOW,CNT,CDL,I,OC,OVERIDE S NOW=+$E($$NOW^XLFDT,1,12),CNT=0
"RTN","ORCSAVE2",152,0)
 S CDL=0 F  S CDL=$O(ORCHECK(+ORIFN,CDL)) Q:CDL'>0  D
"RTN","ORCSAVE2",153,0)
 . S I=0 F  S I=$O(ORCHECK(+ORIFN,CDL,I)) Q:I'>0  D
"RTN","ORCSAVE2",154,0)
 . . S OC=ORCHECK(+ORIFN,CDL,I) Q:'OC
"RTN","ORCSAVE2",155,0)
 . . S OVERIDE=$S($G(MODE)="NOTIF":$G(ORCHECK("OK"))_U,CDL=1:$G(ORCHECK("OK"))_U_DUZ,1:U_DUZ)_U_NOW
"RTN","ORCSAVE2",156,0)
 . . S CNT=CNT+1,^OR(100,+ORIFN,9,"B",+OC,CNT)=""
"RTN","ORCSAVE2",157,0)
 . . S ^OR(100,+ORIFN,9,CNT,0)=$P(OC,U,1,2)_U_U_OVERIDE,^(1)=$E($P(OC,U,3),1,245)
"RTN","ORCSAVE2",158,0)
 S:CNT ^OR(100,+ORIFN,9,0)="^100.09PA^"_CNT_U_CNT
"RTN","ORCSAVE2",159,0)
 Q
"RTN","ORCSAVE2",160,0)
 ;
"RTN","ORCSAVE2",161,0)
VALUE(IFN,ID,INST) ; -- Returns value of prompt by identifier ID
"RTN","ORCSAVE2",162,0)
 I '$G(IFN)!('$D(^OR(100,+$G(IFN),0)))!($G(ID)="") Q ""
"RTN","ORCSAVE2",163,0)
 N I,Y S I=0,Y="" S:'$G(INST) INST=1
"RTN","ORCSAVE2",164,0)
 F  S I=$O(^OR(100,IFN,4.5,"ID",ID,I)) Q:I'>0  I $P($G(^OR(100,IFN,4.5,+I,0)),U,3)=INST S Y=$G(^(1)) Q
"RTN","ORCSAVE2",165,0)
 Q Y
"RTN","ORCSAVE2",166,0)
 ;
"RTN","ORCSAVE2",167,0)
SC(ORX,ORIFN) ; -- save responses to SC questions
"RTN","ORCSAVE2",168,0)
 Q:'$G(ORIFN)  Q:'$D(^OR(100,+ORIFN,0))  ;invalid order number
"RTN","ORCSAVE2",169,0)
 N OR5,I,P S OR5=$G(^OR(100,+ORIFN,5)),P=0
"RTN","ORCSAVE2",170,0)
 F I="SC","MST","AO","IR","EC","HNC","CV" S P=P+1 S:$D(ORX(I)) $P(OR5,U,P)=ORX(I)
"RTN","ORCSAVE2",171,0)
 S ^OR(100,+ORIFN,5)=OR5
"RTN","ORCSAVE2",172,0)
 Q
"RTN","ORMPS1")
0^6^B67707538^B63542078
"RTN","ORMPS1",1,0)
ORMPS1 ;SLC/MKB - Process Pharmacy ORM msgs cont ;12/9/04  12:01
"RTN","ORMPS1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**86,92,94,116,134,152,158,149,190,195,215,265**;Dec 17, 1997;Build 17
"RTN","ORMPS1",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORMPS1",4,0)
UDOSE ; -- new Unit Dose order
"RTN","ORMPS1",5,0)
 N QT,DRUG,INSTR,DOSE,RTE,SCH,OI,URG,WP,DUR,STR,DRGNM,X,PSOI,PSDD,S0,ID,LDOSE,XC,NTE,S0,RXR
"RTN","ORMPS1",6,0)
 S ORDIALOG=+$O(^ORD(101.41,"AB","PSJ OR PAT OE",0))
"RTN","ORMPS1",7,0)
 I $G(ORAPPT)>0 S ORDG=+$O(^ORD(100.98,"B","CLINIC ORDERS",0))
"RTN","ORMPS1",8,0)
 E  S ORDG=+$O(^ORD(100.98,"B","UNIT DOSE MEDICATIONS",0))
"RTN","ORMPS1",9,0)
 S ORPKG=+$$PKG("PSJ")
"RTN","ORMPS1",10,0)
 D GETDLG1^ORCD(ORDIALOG) S QT=$G(ORQT(1))
"RTN","ORMPS1",11,0)
 S DRUG=$$PTR("DISPENSE DRUG"),INSTR=$$PTR("INSTRUCTIONS")
"RTN","ORMPS1",12,0)
 S DOSE=$$PTR("DOSE"),RTE=$$PTR("ROUTE"),SCH=$$PTR("SCHEDULE")
"RTN","ORMPS1",13,0)
 S OI=$$PTR("ORDERABLE ITEM"),URG=$$PTR("URGENCY")
"RTN","ORMPS1",14,0)
 S WP=$$PTR("WORD PROCESSING 1"),DUR=$$PTR("DURATION")
"RTN","ORMPS1",15,0)
 S STR=$$PTR("STRENGTH"),DRGNM=$$PTR("DRUG NAME")
"RTN","ORMPS1",16,0)
UD1 S:RXO X=$P(RXO,"|",2),ORDIALOG(OI,1)=$$ORDITEM^ORM(X),PSOI=$P(X,U,4,5)
"RTN","ORMPS1",17,0)
 I '$G(ORDIALOG(OI,1)) S ORERR="Missing or invalid orderable item" Q
"RTN","ORMPS1",18,0)
 S PSDD=$P($$FIND^ORM(+RXE,3),U,4,5),ORDIALOG(DRUG,1)=+PSDD
"RTN","ORMPS1",19,0)
 S S0=$$FIND^ORM(+RXE,26)_"&"_$P($$FIND^ORM(+RXE,27),U,5)
"RTN","ORMPS1",20,0)
 S ID=$P(QT,U),LDOSE=$P(QT,U,8) I 'ID,S0 D
"RTN","ORMPS1",21,0)
 . N UNT,PTRN S UNT=$P(S0,"&",2),PTRN="1.N1"""_UNT_""""
"RTN","ORMPS1",22,0)
 . I LDOSE?@PTRN S $P(ID,"&",1,2)=+LDOSE_"&"_UNT Q  ;pre-POE orders
"RTN","ORMPS1",23,0)
 . S:$P(PSOI,U,2)'[S0 ORDIALOG(STR,1)=$TR(S0,"&")
"RTN","ORMPS1",24,0)
 I 'ID,'S0 S ORDIALOG(DRGNM,1)=$P(PSDD,U,2)
"RTN","ORMPS1",25,0)
 S:$L(ID) ORDIALOG(DOSE,1)=$P(ID,"&",1,4)_"&"_LDOSE_"&"_+PSDD_"&"_S0
"RTN","ORMPS1",26,0)
 I LDOSE="" D  I LDOSE="" S ORERR="Unable to determine instructions" Q
"RTN","ORMPS1",27,0)
 . I $G(RXC)'>0 D  Q  ;look for units/dose
"RTN","ORMPS1",28,0)
 .. S LDOSE=$P(ID,"&",3),X=$P(ID,"&",4) I 'LDOSE S LDOSE="" Q
"RTN","ORMPS1",29,0)
 .. S:'$L(X) X=$P($$FIND^ORM(+RXE,7),U,5) S:$L(X) LDOSE=LDOSE_" "_X
"RTN","ORMPS1",30,0)
 .. S ORDIALOG(DRGNM,1)=$P(PSDD,U,2) ;force use of DD
"RTN","ORMPS1",31,0)
 . F  D  Q:LDOSE'=""  S RXC=$O(@ORMSG@(RXC)) Q:'RXC  Q:$E(@ORMSG@(RXC),1,3)'="RXC"
"RTN","ORMPS1",32,0)
 .. S XC=@ORMSG@(RXC) Q:+$P($P(XC,"|",3),U,4)'=+PSOI
"RTN","ORMPS1",33,0)
 .. S LDOSE=$P(XC,"|",4)_$P($P(XC,"|",5),U,5) ;strength_units
"RTN","ORMPS1",34,0)
 S ORDIALOG(INSTR,1)=LDOSE
"RTN","ORMPS1",35,0)
UD2 S NTE=$$NTE(21) I NTE D
"RTN","ORMPS1",36,0)
 . N CNT,I S CNT=1,^TMP("ORWORD",$J,WP,1,CNT,0)=$P(@ORMSG@(NTE),"|",4)
"RTN","ORMPS1",37,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,WP,1,CNT,0)=@ORMSG@(NTE,I)
"RTN","ORMPS1",38,0)
 . S ^TMP("ORWORD",$J,WP,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",39,0)
 . S ORDIALOG(WP,1)="^TMP(""ORWORD"",$J,"_WP_",1)"
"RTN","ORMPS1",40,0)
 S RXR=$$RXR^ORMPS I 'RXR S ORERR="Missing or invalid RXR segment" Q
"RTN","ORMPS1",41,0)
 S ORDIALOG(RTE,1)=$P($P(RXR,"|",2),U,4),ORDIALOG(URG,1)=ORURG
"RTN","ORMPS1",42,0)
 S ORDIALOG(SCH,1)=$P(QT,U,2),X=$P(QT,U,3)
"RTN","ORMPS1",43,0)
 I $L(X) D  ;set only if previous order had duration
"RTN","ORMPS1",44,0)
 . N IFN S IFN=$S($G(ORIFN):+ORIFN,$P(ZRX,"|",2):+$P(ZRX,"|",2),1:0)
"RTN","ORMPS1",45,0)
 . S:$O(^OR(100,+IFN,4.5,"ID","DAYS",0)) ORDIALOG(DUR,1)=$$DURATION(X)
"RTN","ORMPS1",46,0)
 D DOSETEXT^ORCDPS2 ;reset Instructions text, SIG
"RTN","ORMPS1",47,0)
 Q
"RTN","ORMPS1",48,0)
OUT ; -- new Outpt order
"RTN","ORMPS1",49,0)
 N OI,SIG,INSTR,DOSE,RTE,SCH,DUR,SC,STR,DRUG,PI,CONJ,PSOI,PSDD,S0,X,I,RXR,J,NTE,ZSC,CNT,PC
"RTN","ORMPS1",50,0)
 S ORDIALOG=+$O(^ORD(101.41,"AB","PSO OERR",0))
"RTN","ORMPS1",51,0)
 S ORDG=+$O(^ORD(100.98,"B","OUTPATIENT MEDICATIONS",0))
"RTN","ORMPS1",52,0)
 S ORPKG=+$$PKG("PSO") D GETDLG1^ORCD(ORDIALOG)
"RTN","ORMPS1",53,0)
 S OI=$$PTR("ORDERABLE ITEM"),SIG=$$PTR("SIG")
"RTN","ORMPS1",54,0)
 S INSTR=$$PTR("INSTRUCTIONS"),DOSE=$$PTR("DOSE")
"RTN","ORMPS1",55,0)
 S SCH=$$PTR("SCHEDULE"),DUR=$$PTR("DURATION")
"RTN","ORMPS1",56,0)
 S RTE=$$PTR("ROUTE"),SC=$$PTR("SERVICE CONNECTED")
"RTN","ORMPS1",57,0)
 S STR=$$PTR("STRENGTH"),DRUG=$$PTR("DISPENSE DRUG")
"RTN","ORMPS1",58,0)
 S PI=$$PTR("PATIENT INSTRUCTIONS"),CONJ=$$PTR("AND/THEN")
"RTN","ORMPS1",59,0)
 S PC=$$PTR("WORD PROCESSING 1")
"RTN","ORMPS1",60,0)
 S:RXO X=$P(RXO,"|",2),ORDIALOG(OI,1)=$$ORDITEM^ORM(X),PSOI=$P(X,U,4,5)
"RTN","ORMPS1",61,0)
 I '$G(ORDIALOG(OI,1)) S ORERR="Missing or invalid orderable item" Q
"RTN","ORMPS1",62,0)
 S PSDD=$P($$FIND^ORM(+RXE,3),U,4,5),ORDIALOG(DRUG,1)=+PSDD
"RTN","ORMPS1",63,0)
 S S0=$$FIND^ORM(+RXE,26)_"&"_$P($$FIND^ORM(+RXE,27),U,5)
"RTN","ORMPS1",64,0)
 I S0,$P(PSOI,U,2)'[S0 S ORDIALOG(STR,1)=$TR(S0,"&")
"RTN","ORMPS1",65,0)
 I 'S0,'$G(ORQT(1)) S ORDIALOG($$PTR("DRUG NAME"),1)=$P(PSDD,U,2)
"RTN","ORMPS1",66,0)
OUT1 S ORDIALOG($$PTR("QUANTITY"),1)=$$FIND^ORM(+RXE,11)
"RTN","ORMPS1",67,0)
 S ORDIALOG($$PTR("REFILLS"),1)=$$FIND^ORM(+RXE,13)
"RTN","ORMPS1",68,0)
 S X=$$FIND^ORM(+RXE,23) S:$E(X)="D" X=+$E(X,2,99)
"RTN","ORMPS1",69,0)
 S:X ORDIALOG($$PTR("DAYS SUPPLY"),1)=X
"RTN","ORMPS1",70,0)
 I ZRX S X=$P(ZRX,"|",5) S:$L(X) ORDIALOG($$PTR("ROUTING"),1)=X
"RTN","ORMPS1",71,0)
 S:ORURG ORDIALOG($$PTR("URGENCY"),1)=ORURG F I=1:1:ORQT D
"RTN","ORMPS1",72,0)
 . S ORDIALOG(INSTR,I)=$P(ORQT(I),U,8),X=$P(ORQT(I),U)
"RTN","ORMPS1",73,0)
 . S:$L(X) ORDIALOG(DOSE,I)=$P(X,"&",1,4)_"&"_$P(ORQT(I),U,8)_"&"_+PSDD_"&"_S0
"RTN","ORMPS1",74,0)
 . S X=$P(ORQT(I),U,2) S:$L(X) ORDIALOG(SCH,I)=X
"RTN","ORMPS1",75,0)
 . S X=$P(ORQT(I),U,3) S:$L(X) ORDIALOG(DUR,I)=$$DURATION(X)
"RTN","ORMPS1",76,0)
 . S X=$P(ORQT(I),U,9) S:$L(X) ORDIALOG(CONJ,I)=$S(X="S":"T",1:X)
"RTN","ORMPS1",77,0)
 S RXR=$$RXR^ORMPS I RXR S ORDIALOG(RTE,1)=$P($P(RXR,"|",2),U,4) D
"RTN","ORMPS1",78,0)
 . S I=1,J=+RXR ;look for multiple RXR's
"RTN","ORMPS1",79,0)
 . F  S J=$O(@ORMSG@(J)) Q:J'>0  S RXR=@ORMSG@(J) Q:$E(RXR,1,3)'="RXR"  S I=I+1,ORDIALOG(RTE,I)=$P($P(RXR,"|",2),U,4)
"RTN","ORMPS1",80,0)
OUT2 S NTE=$$NTE(6) D:'NTE PCOMM^ORMPS2 I NTE D  ;Prov Comm
"RTN","ORMPS1",81,0)
 . S CNT=1,^TMP("ORWORD",$J,PC,1,CNT,0)=$P(@ORMSG@(NTE),"|",4)
"RTN","ORMPS1",82,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,PC,1,CNT,0)=@ORMSG@(NTE,I)
"RTN","ORMPS1",83,0)
 . S ^TMP("ORWORD",$J,PC,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",84,0)
 . S ORDIALOG(PC,1)="^TMP(""ORWORD"",$J,"_PC_",1)"
"RTN","ORMPS1",85,0)
 . N XCNT,XCOMM,XCOMMENT,XORCOMM,XXCNT,XORIFN S (XCNT,XCOMM,XORCOMM,XXCNT)=""
"RTN","ORMPS1",86,0)
 . S XORIFN=$G(ORIFN) I XORIFN="" S XORIFN=$P(RXR,"|",2)
"RTN","ORMPS1",87,0)
 . Q:XORIFN=""
"RTN","ORMPS1",88,0)
 . S XCOMM=$O(^OR(100,+XORIFN,4.5,"ID","COMMENT",XCOMM))
"RTN","ORMPS1",89,0)
 . S XCNT=0 F  S XCNT=$O(^TMP("ORWORD",$J,PC,1,XCNT)) Q:XCNT=""  S XCOMMENT=^TMP("ORWORD",$J,PC,1,XCNT,0) D
"RTN","ORMPS1",90,0)
 . . I XCOMM'="" S XORCOMM=^OR(100,+XORIFN,4.5,XCOMM,2,XCNT,0)
"RTN","ORMPS1",91,0)
 . . I XORCOMM="" F  S XXCNT=$O(^OR(100,+XORIFN,4.5,XCOMM,2,XXCNT)) Q:XXCNT=""  S XORCOMM=^OR(100,+XORIFN,4.5,XCOMM,2,XXCNT,0) Q:XORCOMM'=""
"RTN","ORMPS1",92,0)
 . . I $G(XCOMMENT)=$G(XORCOMM) S ORDIALOG(PC,"FORMAT")="@"
"RTN","ORMPS1",93,0)
 S NTE=$$NTE(7) I NTE D  ;Pat Instr
"RTN","ORMPS1",94,0)
 . S CNT=1,^TMP("ORWORD",$J,PI,1,CNT,0)=$P(@ORMSG@(NTE),"|",4)
"RTN","ORMPS1",95,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,PI,1,CNT,0)=@ORMSG@(NTE,I)
"RTN","ORMPS1",96,0)
 . S ^TMP("ORWORD",$J,PI,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",97,0)
 . S ORDIALOG(PI,1)="^TMP(""ORWORD"",$J,"_PI_",1)"
"RTN","ORMPS1",98,0)
 S NTE=$$NTE(21) I NTE D  ;Sig
"RTN","ORMPS1",99,0)
 . S CNT=1,^TMP("ORWORD",$J,SIG,1,CNT,0)=$P(@ORMSG@(NTE),"|",4)
"RTN","ORMPS1",100,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,SIG,1,CNT,0)=@ORMSG@(NTE,I)
"RTN","ORMPS1",101,0)
 . S ^TMP("ORWORD",$J,SIG,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",102,0)
 . S ORDIALOG(SIG,1)="^TMP(""ORWORD"",$J,"_SIG_",1)"
"RTN","ORMPS1",103,0)
 . S ORDIALOG(PI,"FORMAT")="@" ;PI already included in Sig
"RTN","ORMPS1",104,0)
OUT3 I '$G(ORQT(1))!('NTE) D DOSETEXT^ORCDPS2 ;reset Instructions text, Sig
"RTN","ORMPS1",105,0)
 S ZSC=$$ZSC,X=$P(ZSC,"|",2) I X?2.3U S ORDIALOG(SC,1)=$S(X="SC":1,1:0)
"RTN","ORMPS1",106,0)
 Q
"RTN","ORMPS1",107,0)
IV ; -- new IV order
"RTN","ORMPS1",108,0)
 N IVTYP S IVTYP=$P(ZRX,"|",7) I IVTYP="",$$NUMADDS'>1 G UDOSE
"RTN","ORMPS1",109,0)
 N SOLN,VOL,ADDS,STR,UNITS,RATE,URG,X,X1,X2,I,J,TYPE,OI,WP,NTE,SCH,DAYS
"RTN","ORMPS1",110,0)
 S ORDIALOG=+$O(^ORD(101.41,"AB","PSJI OR PAT FLUID OE",0))
"RTN","ORMPS1",111,0)
 I +$G(ORAPPT)>0 S ORDG=+$O(^ORD(100.98,"B","CLINIC ORDERS",0))
"RTN","ORMPS1",112,0)
 E  S ORDG=+$O(^ORD(100.98,"B",$S($P(ZRX,"|",7)="TPN":"TPN",1:"IV RX"),0))
"RTN","ORMPS1",113,0)
 S ORPKG=+$$PKG("PSJ") D GETDLG1^ORCD(ORDIALOG)
"RTN","ORMPS1",114,0)
 S SOLN=$$PTR("ORDERABLE ITEM"),VOL=$$PTR("VOLUME"),SCH=$$PTR("SCHEDULE")
"RTN","ORMPS1",115,0)
 S RATE=$$PTR("INFUSION RATE") S:ORURG ORDIALOG($$PTR("URGENCY"),1)=ORURG
"RTN","ORMPS1",116,0)
 S WP=$$PTR("WORD PROCESSING 1"),ADDS=$$PTR("ADDITIVE")
"RTN","ORMPS1",117,0)
 S STR=$$PTR("STRENGTH PSIV"),UNITS=$$PTR("UNITS")
"RTN","ORMPS1",118,0)
 S DAYS=$$PTR("DURATION")
"RTN","ORMPS1",119,0)
IV1 S NTE=$$NTE(21) I NTE D
"RTN","ORMPS1",120,0)
 . N CNT,I S CNT=1,^TMP("ORWORD",$J,WP,1,CNT,0)=$P(@ORMSG@(NTE),"|",4)
"RTN","ORMPS1",121,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,WP,1,CNT,0)=@ORMSG@(NTE,I)
"RTN","ORMPS1",122,0)
 . S ^TMP("ORWORD",$J,WP,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",123,0)
 . S ORDIALOG(WP,1)="^TMP(""ORWORD"",$J,"_WP_",1)"
"RTN","ORMPS1",124,0)
 N ORDAYS S ORDAYS=""
"RTN","ORMPS1",125,0)
 S:$D(RXO) ORDAYS=$P($P(RXO,"|",2),"^",3)
"RTN","ORMPS1",126,0)
 S:$L(ORDAYS) ORDAYS=$$IVLIM^ORMPS2(ORDAYS)
"RTN","ORMPS1",127,0)
 S:$L(ORDAYS) ORDIALOG(DAYS,1)=ORDAYS
"RTN","ORMPS1",128,0)
 S X=$P($$FIND^ORM(+RXE,25),U,5)
"RTN","ORMPS1",129,0)
 S ORDIALOG(RATE,1)=$$FIND^ORM(+RXE,24)_$S($L(X):" "_X,1:""),(I,J)=0
"RTN","ORMPS1",130,0)
 F  D  S RXC=$O(@ORMSG@(RXC)) Q:'RXC  Q:$E(@ORMSG@(RXC),1,3)'="RXC"
"RTN","ORMPS1",131,0)
 . S X=@ORMSG@(RXC),TYPE=$P(X,"|",2),OI=$$ORDITEM^ORM($P(X,"|",3)) Q:'OI
"RTN","ORMPS1",132,0)
 . S X1=$P(X,"|",4),X2=$P($P(X,"|",5),U,5)
"RTN","ORMPS1",133,0)
 . I $E(TYPE)="B" S J=J+1,ORDIALOG(SOLN,J)=OI,ORDIALOG(VOL,J)=X1 Q
"RTN","ORMPS1",134,0)
 . S I=I+1,ORDIALOG(ADDS,I)=OI,ORDIALOG(STR,I)=X1,ORDIALOG(UNITS,I)=X2
"RTN","ORMPS1",135,0)
 I IVTYP="" S X=$P($G(ORQT(1)),U,2) S:$L(X) ORDIALOG(SCH,1)=X
"RTN","ORMPS1",136,0)
 Q
"RTN","ORMPS1",137,0)
NTE(ID) ; -- Return subscript of NTE segment for RXE-<ID>
"RTN","ORMPS1",138,0)
 N I,SEG,Y S Y="",I=+RXE S:'$G(ID) ID=21
"RTN","ORMPS1",139,0)
 F  S I=$O(@ORMSG@(I)) Q:I'>0  S SEG=@ORMSG@(I) Q:$E(SEG,1,3)="ORC"  I $P(SEG,"|",1,2)=("NTE|"_ID) S Y=I Q
"RTN","ORMPS1",140,0)
 Q Y
"RTN","ORMPS1",141,0)
ZSC() ; -- Return subscript of ZSC segment
"RTN","ORMPS1",142,0)
 N I,SEG,Y S Y="",I=+RXE
"RTN","ORMPS1",143,0)
 F  S I=$O(@ORMSG@(I)) Q:I'>0  S SEG=$E(@ORMSG@(I),1,3) Q:SEG="ORC"  I SEG="ZSC" S Y=I_U_@ORMSG@(I) Q
"RTN","ORMPS1",144,0)
 Q Y
"RTN","ORMPS1",145,0)
NUMADDS() ; -- count number of additives to determine type
"RTN","ORMPS1",146,0)
 N CNT,I,X S CNT=0,I=+RXE
"RTN","ORMPS1",147,0)
 F  S I=$O(@ORMSG@(I)) Q:I'>0  S X=@ORMSG@(I) Q:$P(X,"|")="ORC"  I $E(X,1,6)="RXC|A|" S CNT=CNT+1
"RTN","ORMPS1",148,0)
 Q CNT
"RTN","ORMPS1",149,0)
PKG(NMSP) ; -- Return Package file ptr for NMSP
"RTN","ORMPS1",150,0)
 N I S I=0
"RTN","ORMPS1",151,0)
 F  S I=+$O(^DIC(9.4,"C",NMSP,I)) Q:I<1  Q:'$O(^(I,0))  ;no Addl Prefs  DBIA #2058
"RTN","ORMPS1",152,0)
 Q I
"RTN","ORMPS1",153,0)
PTR(NAME) ; -- Returns ien of prompt NAME in Order Dialog file #101.41
"RTN","ORMPS1",154,0)
 Q +$O(^ORD(101.41,"AB",$E("OR GTX "_NAME,1,63),0))
"RTN","ORMPS1",155,0)
DURATION(X) ; -- Returns "# units" from U# format
"RTN","ORMPS1",156,0)
 N Y,Y1,Y2 I X'?.1U1.N Q ""
"RTN","ORMPS1",157,0)
 S Y1=$E(X),Y2=+$E(X,2,$L(X)) I X=+X S Y1="D",Y2=+X
"RTN","ORMPS1",158,0)
 S Y=Y2_" "_$S(Y1="L":"MONTH",Y1="W":"WEEK",Y1="H":"HOUR",Y1="M":"MINUTE",Y1="S":"SECOND",1:"DAY")_$S(Y2>1:"S",1:"")
"RTN","ORMPS1",159,0)
 Q Y
"RTN","ORMPS1",160,0)
QT ; -- Unpiece the Q/T field from RXE
"RTN","ORMPS1",161,0)
 I 'RXE S ORQT(1)=ORQT,ORQT=1 Q  ; nothing to reset
"RTN","ORMPS1",162,0)
 N X,Y,I,J,P,SEG,DONE K ORQT
"RTN","ORMPS1",163,0)
 S SEG=$G(@ORMSG@(+RXE)),X=$P(SEG,"|",2),(I,J,P,DONE)=0
"RTN","ORMPS1",164,0)
 F  D  Q:DONE
"RTN","ORMPS1",165,0)
 . S P=P+1,Y=$P(X,"~",P) I Y="" S DONE=1 Q
"RTN","ORMPS1",166,0)
 . I P<$L(X,"~") S I=I+1,ORQT(I)=Y Q
"RTN","ORMPS1",167,0)
 . I $L(SEG,"|")>2 S I=I+1,ORQT(I)=Y,DONE=1 Q
"RTN","ORMPS1",168,0)
 . S J=+$O(@ORMSG@(+RXE,J)) I J'>0 S I=I+1,ORQT(I)=Y,DONE=1 Q
"RTN","ORMPS1",169,0)
 . S SEG=$G(@ORMSG@(+RXE,J)),X=$P(SEG,"|"),P=1,I=I+1,ORQT(I)=Y_$P(X,"~")
"RTN","ORMPS1",170,0)
 S ORQT=I Q:'ORQT  ; else reset ORSTRT, ORSTOP, ORURG
"RTN","ORMPS1",171,0)
 S ORSTRT=$P(ORQT(1),U,4),ORSTOP=$P(ORQT(ORQT),U,5),ORURG=$P(ORQT(1),U,6)
"RTN","ORMPS1",172,0)
 S:ORSTRT ORSTRT=$$FMDATE^ORM(ORSTRT) S:ORSTOP ORSTOP=$$FMDATE^ORM(ORSTOP) S:$L(ORURG) ORURG=$$URGENCY^ORM(ORURG)
"RTN","ORMPS1",173,0)
 Q
"RTN","ORMPS2")
0^8^B41616166^B37957594
"RTN","ORMPS2",1,0)
ORMPS2 ;SLC/MKB - Process Pharmacy ORM msgs cont ; 1/26/07 11:58am
"RTN","ORMPS2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**94,116,129,134,186,190,195,215,265**;Dec 17, 1997;Build 17
"RTN","ORMPS2",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORMPS2",4,0)
 ;
"RTN","ORMPS2",5,0)
FINISHED() ; -- new order [SN^ORMPS] due to finishing?
"RTN","ORMPS2",6,0)
 N Y,ORIG,TYPE,ORIG4 S Y=0
"RTN","ORMPS2",7,0)
 S ORIG=+$P(ZRX,"|",2),TYPE=$P(ZRX,"|",4),ORIG4=$G(^OR(100,ORIG,4))
"RTN","ORMPS2",8,0)
 I ORIG,TYPE="E",ORIG4?1.N1"P"!(ORIG4?1.N1"S") S ORIFN=+ORIG,Y=1
"RTN","ORMPS2",9,0)
 Q Y
"RTN","ORMPS2",10,0)
 ;
"RTN","ORMPS2",11,0)
WPX() ; -- Compare comments in @ORMSG@(NTE) with order ORIFN
"RTN","ORMPS2",12,0)
 ;     Returns 1 if different, or 0 if same
"RTN","ORMPS2",13,0)
 N NTE,SPINST,Y,I,J,X,X1 S Y=0
"RTN","ORMPS2",14,0)
 S NTE=+$$NTE^ORMPS1(21),SPINST=$S(NTE:$P(@ORMSG@(NTE),"|",4),1:"")
"RTN","ORMPS2",15,0)
 S I=+$O(^OR(100,+ORIFN,4.5,"ID","COMMENT",0)) I I'>0 S:$L(SPINST) Y=1 G WQ
"RTN","ORMPS2",16,0)
 S X=$G(^OR(100,+ORIFN,4.5,I,2,1,0)) ;1st line
"RTN","ORMPS2",17,0)
 I '$O(^OR(100,+ORIFN,4.5,I,2,1)) S:X'=SPINST Y=1 G WQ
"RTN","ORMPS2",18,0)
 S J=1 F  S J=$O(^OR(100,+ORIFN,4.5,I,2,J)) Q:J'>0  S X1=$G(^(J,0)) D  Q:$L(X)'<240
"RTN","ORMPS2",19,0)
 . I ($L(X)+$L(X1)+1)'>240 S X=X_" "_X1 Q
"RTN","ORMPS2",20,0)
 . S X=X_" "_$E(X1,1,239-$L(X))
"RTN","ORMPS2",21,0)
 S:X'=SPINST Y=1 ;changed
"RTN","ORMPS2",22,0)
WQ Q Y
"RTN","ORMPS2",23,0)
 ;
"RTN","ORMPS2",24,0)
IVX() ; -- Compare ORMSG to Inpt order ORIFN if IV, return 0 if 'diff or 'IV
"RTN","ORMPS2",25,0)
 N Y,RXC,DG,OI,PSOI,XC,RATE,ORA,ORB,ORX,I,J,OI0,INST,VOL,STR,UNT
"RTN","ORMPS2",26,0)
 S RXC=$$RXC^ORMPS,Y=0 I RXC'>0 Q Y  ;not IV of any kind
"RTN","ORMPS2",27,0)
 S DG=+$P($G(^OR(100,+ORIFN,0)),U,11),DG=$P($G(^ORD(100.98,DG,0)),U,3)
"RTN","ORMPS2",28,0)
 I DG'="IV RX",DG'="TPN" D  Q Y  ;not fluid
"RTN","ORMPS2",29,0)
 . I $P(ZRX,"|",7)'="" S Y=1 Q
"RTN","ORMPS2",30,0)
 . I $$NUMADDS^ORMPS1>1 S Y=1 Q
"RTN","ORMPS2",31,0)
 . S OI=$$VALUE("ORDERABLE"),PSOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORMPS2",32,0)
 . S XC=@ORMSG@(RXC) I PSOI'=$P(XC,U,4) S Y=1 Q
"RTN","ORMPS2",33,0)
 . N X1,X2,X3 S X1=$P(XC,"|",4),X2=$P($P(XC,"|",5),U,5)
"RTN","ORMPS2",34,0)
 . S X3=$$VALUE("INSTR") I (X1_X2)'=X3,(X1_" "_X2)'=X3 S Y=1 Q
"RTN","ORMPS2",35,0)
IV1 S RATE=$$FIND^ORM(+RXE,24),UNT=$P($$FIND^ORM(+RXE,25),U,5)
"RTN","ORMPS2",36,0)
 S:$L(UNT) RATE=RATE_" "_UNT I RATE'=$$VALUE("RATE") S Y=1 Q Y
"RTN","ORMPS2",37,0)
 S ORB=+$$PTR("ORDERABLE ITEM"),ORA=+$$PTR("ADDITIVE"),I=+RXC
"RTN","ORMPS2",38,0)
 F  S XC=@ORMSG@(I) Q:$E(XC,1,3)'="RXC"  D  S I=$O(@ORMSG@(I)) Q:I'>0
"RTN","ORMPS2",39,0)
 . S ORX($P(XC,"|",2),+$P(XC,U,4))=$P(XC,"|",4)_U_$P($P(XC,"|",5),U,5)
"RTN","ORMPS2",40,0)
 . ;ORX("A",PSOI)=str^units or ORX("B",PSOI)=volume^units
"RTN","ORMPS2",41,0)
 F I="STRENGTH","UNITS","VOLUME" D  ;ORX(I,inst)=value
"RTN","ORMPS2",42,0)
 . S J=0 F  S J=$O(^OR(100,+ORIFN,4.5,"ID",I,J)) Q:J'>0  D
"RTN","ORMPS2",43,0)
 .. S INST=+$P($G(^OR(100,+ORIFN,4.5,J,0)),U,3)
"RTN","ORMPS2",44,0)
 .. S:INST ORX(I,INST)=$G(^OR(100,+ORIFN,4.5,J,1))
"RTN","ORMPS2",45,0)
 S I=0 F  S I=$O(^OR(100,+ORIFN,4.5,"ID","ORDERABLE",I)) Q:I'>0  D  Q:Y
"RTN","ORMPS2",46,0)
 . S OI0=$G(^OR(100,+ORIFN,4.5,I,0)),OI=+$G(^(1))
"RTN","ORMPS2",47,0)
 . S PSOI=+$P($G(^ORD(101.43,OI,0)),U,2)
"RTN","ORMPS2",48,0)
 . I $P(OI0,U,2)=ORA,$G(ORX("A",PSOI)) D  Q
"RTN","ORMPS2",49,0)
 .. S INST=$P(OI0,U,3),STR=+ORX("A",PSOI),UNT=$P(ORX("A",PSOI),U,2)
"RTN","ORMPS2",50,0)
 .. I STR'=$G(ORX("STRENGTH",INST)) S Y=1 Q
"RTN","ORMPS2",51,0)
 .. I UNT'=$G(ORX("UNITS",INST)) S Y=1 Q
"RTN","ORMPS2",52,0)
 .. K ORX("A",PSOI) ;same
"RTN","ORMPS2",53,0)
 . I $P(OI0,U,2)=ORB,$G(ORX("B",PSOI)) D  Q
"RTN","ORMPS2",54,0)
 .. S INST=$P(OI0,U,3),VOL=+$G(ORX("B",PSOI))
"RTN","ORMPS2",55,0)
 .. I VOL'=$G(ORX("VOLUME",INST)) S Y=1 Q
"RTN","ORMPS2",56,0)
 .. K ORX("B",PSOI) ;same
"RTN","ORMPS2",57,0)
 . S Y=1
"RTN","ORMPS2",58,0)
 I $O(ORX("A",0))!$O(ORX("B",0)) S Y=1 ;leftover items - changed
"RTN","ORMPS2",59,0)
 Q Y
"RTN","ORMPS2",60,0)
 ;
"RTN","ORMPS2",61,0)
CHANGED() ; -- Compare ORMSG to order ORIFN, return 1 if different
"RTN","ORMPS2",62,0)
 N X,Y,X1,ZSC,NTE,SIG,PI S Y=0
"RTN","ORMPS2",63,0)
 I $G(ORCAT)="I" D  G CHQ
"RTN","ORMPS2",64,0)
 . I $$WPX S Y=1 Q  ;Special Instructions
"RTN","ORMPS2",65,0)
 . ;S X=$$VALUE("DAYS") ;duration
"RTN","ORMPS2",66,0)
 . ;I X S X1=$$DURATION^ORMPS1($P($G(ORQT(1)),U,3)) I X'=X1 S Y=1 Q
"RTN","ORMPS2",67,0)
 . I $$IVX S Y=1 Q  ;IV fields
"RTN","ORMPS2",68,0)
 S X=$P($P(RXE,"|",3),U,4) I X'=$$VALUE("DRUG") S Y=1 G CHQ
"RTN","ORMPS2",69,0)
 I $P(RXE,"|",11)'=$$VALUE("QTY") S Y=1 G CHQ
"RTN","ORMPS2",70,0)
 I $P(RXE,"|",13)'=$$VALUE("REFILLS") S Y=1 G CHQ
"RTN","ORMPS2",71,0)
 S X=$P(RXE,"|",23) S:$E(X)="D" X=+$E(X,2,99) I X'=$$VALUE("SUPPLY") S Y=1 G CHQ
"RTN","ORMPS2",72,0)
 I $P(ZRX,"|",5)'=$$VALUE("PICKUP") S Y=1 G CHQ
"RTN","ORMPS2",73,0)
 S NTE=$$NTE^ORMPS1(21),SIG=+$O(^OR(100,+ORIFN,4.5,"ID","SIG",0)) ;verb
"RTN","ORMPS2",74,0)
 I NTE,SIG,$P($P(@ORMSG@(NTE),"|",4)," ")'=$P($G(^OR(100,+ORIFN,4.5,SIG,2,1,0))," ") S Y=1 G CHQ
"RTN","ORMPS2",75,0)
 S NTE=$$NTE^ORMPS1(7),PI=+$O(^OR(100,+ORIFN,4.5,"ID","PI",0))
"RTN","ORMPS2",76,0)
 I (NTE&'PI)!('NTE&PI) Q 1 ;added or deleted
"RTN","ORMPS2",77,0)
 I NTE,PI,$P(@ORMSG@(NTE),"|",4)'=$G(^OR(100,+ORIFN,4.5,PI,2,1,0)) S Y=1 G CHQ
"RTN","ORMPS2",78,0)
 Q:'$P($G(^OR(100,+ORIFN,8,0)),U,3)
"RTN","ORMPS2",79,0)
 N LSTACT,PREPRV,CURPRV S LSTACT="?",(PREPRV,CURPRV)=0
"RTN","ORMPS2",80,0)
 F  S LSTACT=$O(^OR(100,+ORIFN,8,LSTACT),-1) Q:LSTACT
"RTN","ORMPS2",81,0)
 S PREPRV=$P($G(^OR(100,+ORIFN,8,LSTACT,0)),U,3)
"RTN","ORMPS2",82,0)
 S CURPRV=$P($G(ORC),"|",13)
"RTN","ORMPS2",83,0)
 I (PREPRV'=CURPRV) S Y=1 G CHQ
"RTN","ORMPS2",84,0)
CHQ Q Y
"RTN","ORMPS2",85,0)
 ;
"RTN","ORMPS2",86,0)
VALUE(ID) ; -- Return value of ID in ^OR(100,+ORIFN,4.5,"ID")
"RTN","ORMPS2",87,0)
 N I,Y I '$L($G(ID)) Q ""
"RTN","ORMPS2",88,0)
 S I=+$O(^OR(100,+ORIFN,4.5,"ID",ID,0))
"RTN","ORMPS2",89,0)
 S Y=$G(^OR(100,+ORIFN,4.5,I,1))
"RTN","ORMPS2",90,0)
 Q Y
"RTN","ORMPS2",91,0)
 ;
"RTN","ORMPS2",92,0)
PTR(X) ; -- Return ptr to prompt OR GTX X
"RTN","ORMPS2",93,0)
 Q +$O(^ORD(101.41,"AB","OR GTX "_X,0))
"RTN","ORMPS2",94,0)
 ;
"RTN","ORMPS2",95,0)
RO ; -- Replacement order (finished)
"RTN","ORMPS2",96,0)
 ;
"RTN","ORMPS2",97,0)
 N RXO,RXC,ORDIALOG,ORDG,ORPKG,ORDA,ORX,ORSIG,ORP,ZSC,NEWSTS
"RTN","ORMPS2",98,0)
 K ^TMP("ORWORD",$J)
"RTN","ORMPS2",99,0)
 I '$D(^VA(200,ORNP,0)) S ORERR="Missing or invalid ordering provider" Q
"RTN","ORMPS2",100,0)
 I 'RXE S ORERR="Missing or invalid RXE segment" Q
"RTN","ORMPS2",101,0)
 S RXO=$$RXO^ORMPS,RXC=$$RXC^ORMPS,ORIFN=+$G(ORIFN)
"RTN","ORMPS2",102,0)
 I ORIFN'>0 S ORERR="Missing or invalid order number" Q
"RTN","ORMPS2",103,0)
 D @($S(RXC:"IV",$G(ORCAT)="I":"UDOSE",1:"OUT")_"^ORMPS1") Q:$D(ORERR)
"RTN","ORMPS2",104,0)
 S ORDA=$$ACTION^ORCSAVE("XX",ORIFN,ORNP,"",ORNOW,ORWHO)
"RTN","ORMPS2",105,0)
 I ORDA'>0 S ORERR="Cannot create new order action" Q
"RTN","ORMPS2",106,0)
RO1 ; -Update sts of order to active, last action to dc/edit:
"RTN","ORMPS2",107,0)
 S ORX=ORDA F  S ORX=+$O(^OR(100,ORIFN,8,ORX),-1) Q:ORX'>0  I $D(^(ORX,0)),$P(^(0),U,15)="" Q  ;ORX=last released action
"RTN","ORMPS2",108,0)
 S:ORX $P(^OR(100,ORIFN,8,ORX,0),U,15)=12 ;dc/edit
"RTN","ORMPS2",109,0)
 S $P(^OR(100,ORIFN,3),U,7)=ORDA,NEWSTS=$S('$G(ORSTS):0,ORSTS=$P(^(3),U,3):0,1:1) K ^(6)
"RTN","ORMPS2",110,0)
 D STATUS^ORCSAVE2(ORIFN,ORSTS):NEWSTS,SETALL^ORDD100(ORIFN):'NEWSTS
"RTN","ORMPS2",111,0)
 D DATES^ORCSAVE2(ORIFN,ORSTRT,ORSTOP)
"RTN","ORMPS2",112,0)
 D RELEASE^ORCSAVE2(ORIFN,ORDA,ORNOW,ORWHO,ORNATR)
"RTN","ORMPS2",113,0)
 ; -If unsigned edit, leave XX unsigned & mark ORX as Sig Not Req'd
"RTN","ORMPS2",114,0)
 S ORSIG=$S($P($G(^OR(100,ORIFN,8,ORX,0)),U,4)'=2:1,1:0)
"RTN","ORMPS2",115,0)
 D SIGSTS^ORCSAVE2(ORIFN,ORDA):ORSIG,SIGN^ORCSAVE2(ORIFN,,,5,ORX):'ORSIG
"RTN","ORMPS2",116,0)
RO2 ; -Update responses, get/save new order text:
"RTN","ORMPS2",117,0)
 K ^OR(100,ORIFN,4.5) D RESPONSE^ORCSAVE,ORDTEXT^ORCSAVE1(ORIFN_";"_ORDA)
"RTN","ORMPS2",118,0)
 S $P(^OR(100,ORIFN,0),U,5)=ORDIALOG_";ORD(101.41,",$P(^(0),U,14)=ORPKG
"RTN","ORMPS2",119,0)
 ;I $P(^OR(100,ORIFN,0),U,11)'=ORDG D  ;update DG,xrefs
"RTN","ORMPS2",120,0)
 ;AGP Changes to handle IMO IV orders CPRS 26v43
"RTN","ORMPS2",121,0)
 I $P(^OR(100,ORIFN,0),U,11)'=ORDG,$P(^OR(100,ORIFN,0),U,11)'=$O(^ORD(100.98,"B","CLINIC ORDERS","")) D
"RTN","ORMPS2",122,0)
 . N DA,DR,DIE
"RTN","ORMPS2",123,0)
 . S DA=ORIFN,DR="23////"_ORDG,DIE="^OR(100," D ^DIE
"RTN","ORMPS2",124,0)
 S ^OR(100,ORIFN,4)=PKGIFN,$P(^(8,ORDA,0),U,14)=ORDA
"RTN","ORMPS2",125,0)
 S ORIFN=ORIFN_";"_ORDA,ORDCNTRL="SN" ;to send NA msg back
"RTN","ORMPS2",126,0)
 I $G(ORL) S ORP(1)=ORIFN_"^1" D PRINTS^ORWD1(.ORP,+ORL)
"RTN","ORMPS2",127,0)
 I $G(ORCAT)="O" S ZSC=$$ZSC^ORMPS1 I ZSC,$P(ZSC,"|",2)'?2.3U S ^OR(100,+ORIFN,5)=$TR($P(ZSC,"|",2,7),"|","^") ;1 or 0 instead of [N]SC in #100
"RTN","ORMPS2",128,0)
 Q
"RTN","ORMPS2",129,0)
IVLIM(IVDUR)    ;
"RTN","ORMPS2",130,0)
 I $L(IVDUR) D
"RTN","ORMPS2",131,0)
 . N DURU,DURV S DURU="",DURV=0
"RTN","ORMPS2",132,0)
 . S DURU=$E(IVDUR,1),DURV=$E(IVDUR,2,$L(IVDUR))
"RTN","ORMPS2",133,0)
 . I (DURU="D")!(DURU="d") S IVDUR="for "_+DURV_$S(+DURV=1:" day",+DURV>1:" days",1:" day")
"RTN","ORMPS2",134,0)
 . I (DURU="H")!(DURU="h") S IVDUR="for "_+DURV_$S(+DURV=1:" hours",+DURV>1:" hours",1:" hour")
"RTN","ORMPS2",135,0)
 . I (DURU="M")!(DURU="m") S IVDUR="with total volume "_+DURV_" ml"
"RTN","ORMPS2",136,0)
 . I (DURU="L")!(DURU="l") S IVDUR="with total volume "_+DURV_" L"
"RTN","ORMPS2",137,0)
 Q IVDUR
"RTN","ORMPS2",138,0)
PCOMM ; -- Get Provider Comments from previous order, when changed
"RTN","ORMPS2",139,0)
 N OLD,I
"RTN","ORMPS2",140,0)
 S OLD=+$G(ORIFN) I OLD<1 S OLD=+$P(ZRX,"|",2) Q:OLD<1
"RTN","ORMPS2",141,0)
 S I=+$O(^OR(100,OLD,4.5,"ID","COMMENT",0)) Q:I<1
"RTN","ORMPS2",142,0)
 Q:'$O(^OR(100,OLD,4.5,I,2,0))  ;none
"RTN","ORMPS2",143,0)
 M ^TMP("ORWORD",$J,PC,1)=^OR(100,OLD,4.5,I,2)
"RTN","ORMPS2",144,0)
 S ORDIALOG(PC,1)="^TMP(""ORWORD"",$J,"_PC_",1)"
"RTN","ORMPS2",145,0)
 S ORDIALOG(PC,"FORMAT")="@" ;text in Sig already
"RTN","ORMPS2",146,0)
 Q
"RTN","ORWPS")
0^7^B46786086^B45940660
"RTN","ORWPS",1,0)
ORWPS ; SLC/KCM/JLI/REV/CLA - Meds Tab; 05/22/03
"RTN","ORWPS",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,85,116,132,141,173,203,190,195,265**;Dec 17, 1997;Build 17
"RTN","ORWPS",3,0)
 ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORWPS",4,0)
COVER(LST,DFN)  ; retrieve meds for cover sheet
"RTN","ORWPS",5,0)
 K ^TMP("PS",$J)
"RTN","ORWPS",6,0)
 D OCL^PSOORRL(DFN,"","")  ;DBIA #2400
"RTN","ORWPS",7,0)
 N ILST,ITMP,X S ILST=0
"RTN","ORWPS",8,0)
 S ITMP="" F  S ITMP=$O(^TMP("PS",$J,ITMP)) Q:'ITMP  D
"RTN","ORWPS",9,0)
 . S X=^TMP("PS",$J,ITMP,0)
"RTN","ORWPS",10,0)
 . I '$L($P(X,U,2)) S X="??"  ; show something if drug empty
"RTN","ORWPS",11,0)
 . I $D(^TMP("PS",$J,ITMP,"CLINIC",0)) S LST($$NXT)=$P(X,U,1,2)_U_$P(X,U,8,9)_U_"C"
"RTN","ORWPS",12,0)
 . E  S LST($$NXT)=$P(X,U,1,2)_U_$P(X,U,8,9)
"RTN","ORWPS",13,0)
 K ^TMP("PS",$J)
"RTN","ORWPS",14,0)
 Q
"RTN","ORWPS",15,0)
DT(X) ; -- Returns FM date for X
"RTN","ORWPS",16,0)
 N Y,%DT S %DT="T",Y="" D:X'="" ^%DT
"RTN","ORWPS",17,0)
 Q Y
"RTN","ORWPS",18,0)
 ;
"RTN","ORWPS",19,0)
ACTIVE(LST,DFN) ; retrieve active inpatient & outpatient meds
"RTN","ORWPS",20,0)
 K ^TMP("PS",$J)
"RTN","ORWPS",21,0)
 K ^TMP("ORACT",$J)
"RTN","ORWPS",22,0)
 N BEG,END,CTX
"RTN","ORWPS",23,0)
 S (BEG,END,CTX)=""
"RTN","ORWPS",24,0)
 S CTX=$$GET^XPAR("ALL","ORCH CONTEXT MEDS")
"RTN","ORWPS",25,0)
 I CTX=";" D DEL^XPAR("USR.`"_DUZ,"ORCH CONTEXT MEDS")
"RTN","ORWPS",26,0)
 S CTX=$$GET^XPAR("ALL","ORCH CONTEXT MEDS")
"RTN","ORWPS",27,0)
 S BEG=$$DT($P(CTX,";")),END=$$DT($P(CTX,";",2))
"RTN","ORWPS",28,0)
 D OCL^PSOORRL(DFN,BEG,END)  ;DBIA #2400
"RTN","ORWPS",29,0)
 N ITMP,FIELDS,INSTRUCT,COMMENTS,REASON,NVSDT,TYPE,ILST,J S ILST=0
"RTN","ORWPS",30,0)
 S ITMP="" F  S ITMP=$O(^TMP("PS",$J,ITMP),-1) Q:'ITMP  D
"RTN","ORWPS",31,0)
 . K INSTRUCT,COMMENTS,REASON
"RTN","ORWPS",32,0)
 . K ^TMP("ORACT",$J,"COMMENTS")
"RTN","ORWPS",33,0)
 . S COMMENTS="^TMP(""ORACT"",$J,""COMMENTS"")"
"RTN","ORWPS",34,0)
 . S (INSTRUCT,@COMMENTS)="",FIELDS=^TMP("PS",$J,ITMP,0)
"RTN","ORWPS",35,0)
 . I +$P(FIELDS,"^",8),$D(^OR(100,+$P(FIELDS,"^",8),8,"C","XX")) D
"RTN","ORWPS",36,0)
 . . S $P(^TMP("PS",$J,ITMP,0),"^",2)="*"_$P(^TMP("PS",$J,ITMP,0),"^",2) ;dan testing
"RTN","ORWPS",37,0)
 . S TYPE=$S($P($P(FIELDS,U),";",2)="O":"OP",1:"UD")
"RTN","ORWPS",38,0)
 . I $D(^TMP("PS",$J,ITMP,"CLINIC",0)) S TYPE="CP"
"RTN","ORWPS",39,0)
 . N LOC,LOCEX S (LOC,LOCEX)=""
"RTN","ORWPS",40,0)
 . I TYPE="CP" S LOC=$G(^TMP("PS",$J,ITMP,"CLINIC",0))
"RTN","ORWPS",41,0)
 . S:LOC LOCEX=$P($G(^SC(+LOC,0)),U)_":"_+LOC ;IMO NEW  DBIA #964
"RTN","ORWPS",42,0)
 . I TYPE="OP",$P(FIELDS,";")["N" S TYPE="NV"          ;non-VA med
"RTN","ORWPS",43,0)
 . I $O(^TMP("PS",$J,ITMP,"A",0))>0 S TYPE="IV"
"RTN","ORWPS",44,0)
 . I $O(^TMP("PS",$J,ITMP,"B",0))>0 S TYPE="IV"
"RTN","ORWPS",45,0)
 . I (TYPE="UD")!(TYPE="CP") D UDINST(.INSTRUCT,ITMP)
"RTN","ORWPS",46,0)
 . I TYPE="OP" D OPINST(.INSTRUCT,ITMP)
"RTN","ORWPS",47,0)
 . I TYPE="IV" D IVINST(.INSTRUCT,ITMP)
"RTN","ORWPS",48,0)
 . I TYPE="NV" D NVINST(.INSTRUCT,ITMP),NVREASON(.REASON,.NVSDT,ITMP)
"RTN","ORWPS",49,0)
 . I (TYPE="UD")!(TYPE="IV")!(TYPE="NV")!(TYPE="CP") D SETMULT(COMMENTS,ITMP,"SIO")
"RTN","ORWPS",50,0)
 . M COMMENTS=@COMMENTS
"RTN","ORWPS",51,0)
 . I $D(COMMENTS(1)) S COMMENTS(1)="\"_COMMENTS(1)
"RTN","ORWPS",52,0)
 . S:TYPE="NV" $P(FIELDS,U,4)=$G(NVSDT)
"RTN","ORWPS",53,0)
 . I LOC S LST($$NXT)="~CP:"_LOCEX_U_FIELDS
"RTN","ORWPS",54,0)
 . E  S LST($$NXT)="~"_TYPE_U_FIELDS
"RTN","ORWPS",55,0)
 . S J=0 F  S J=$O(INSTRUCT(J)) Q:'J  S LST($$NXT)=INSTRUCT(J)
"RTN","ORWPS",56,0)
 . S J=0 F  S J=$O(COMMENTS(J)) Q:'J  S LST($$NXT)="t"_COMMENTS(J)
"RTN","ORWPS",57,0)
 . S J=0 F  S J=$O(REASON(J)) Q:'J  S LST($$NXT)="t"_REASON(J)
"RTN","ORWPS",58,0)
 K ^TMP("PS",$J)
"RTN","ORWPS",59,0)
 K ^TMP("ORACT",$J)
"RTN","ORWPS",60,0)
 Q
"RTN","ORWPS",61,0)
NXT() ; increment ILST
"RTN","ORWPS",62,0)
 S ILST=ILST+1
"RTN","ORWPS",63,0)
 Q ILST
"RTN","ORWPS",64,0)
 ;
"RTN","ORWPS",65,0)
UDINST(Y,INDEX) ; assembles instructions for a unit dose order
"RTN","ORWPS",66,0)
 N I,X,RST
"RTN","ORWPS",67,0)
 S X=^TMP("PS",$J,INDEX,0)
"RTN","ORWPS",68,0)
 S RST="^TMP(""ORACT"",$J,""INSTRUCT"")"
"RTN","ORWPS",69,0)
 S @RST@(1)=" "_$P(X,U,2),@RST=1
"RTN","ORWPS",70,0)
 S X=$S($L($P(X,U,6)):$P(X,U,6),1:$P(X,U,7))
"RTN","ORWPS",71,0)
 I $L(X) S @RST=2,@RST@(2)=X
"RTN","ORWPS",72,0)
 E  S @RST=1 D SETMULT(.RST,INDEX,"SIG")
"RTN","ORWPS",73,0)
 S @RST@(2)="\Give: "_$G(@RST@(2)),@RST=$G(@RST,2)
"RTN","ORWPS",74,0)
 D SETMULT(RST,INDEX,"MDR"),SETMULT(RST,INDEX,"SCH")
"RTN","ORWPS",75,0)
 F I=3:1:@RST S @RST@(I)=" "_@RST@(I)
"RTN","ORWPS",76,0)
 M Y=@RST K @RST
"RTN","ORWPS",77,0)
 Q
"RTN","ORWPS",78,0)
OPINST(Y,INDEX) ; assembles instructions for an outpatient prescription
"RTN","ORWPS",79,0)
 N I,X,RST
"RTN","ORWPS",80,0)
 S X=^TMP("PS",$J,INDEX,0)
"RTN","ORWPS",81,0)
 S RST="^TMP(""ORACT"",$J,""INSTRUCT"")"
"RTN","ORWPS",82,0)
 S @RST@(1)=" "_$P(X,U,2),@RST=1
"RTN","ORWPS",83,0)
 I $L($P(X,U,12)) S @RST@(1)=@RST@(1)_"  Qty: "_$P(X,U,12)
"RTN","ORWPS",84,0)
 I $L($P(X,U,11)) S @RST@(1)=@RST@(1)_" for "_$P(X,U,11)_" days"
"RTN","ORWPS",85,0)
 D SETMULT(RST,INDEX,"SIG")
"RTN","ORWPS",86,0)
 I @RST=1 D
"RTN","ORWPS",87,0)
 . D SETMULT(RST,INDEX,"SIO")
"RTN","ORWPS",88,0)
 . D SETMULT(RST,INDEX,"MDR")
"RTN","ORWPS",89,0)
 . D SETMULT(RST,INDEX,"SCH")
"RTN","ORWPS",90,0)
 S @RST@(2)="\ Sig: "_$G(@RST@(2))
"RTN","ORWPS",91,0)
 F I=3:1:@RST S @RST@(I)=" "_@RST@(I)
"RTN","ORWPS",92,0)
 M Y=@RST K @RST
"RTN","ORWPS",93,0)
 Q
"RTN","ORWPS",94,0)
IVINST(Y,INDEX) ; assembles instructions for an IV order
"RTN","ORWPS",95,0)
 N SOLN1,I,RST,IVDUR
"RTN","ORWPS",96,0)
 S IVDUR=""
"RTN","ORWPS",97,0)
 S RST="^TMP(""ORACT"",$J,""INSTRUCT"")"
"RTN","ORWPS",98,0)
 S @RST=0 D SETMULT(RST,INDEX,"A") S SOLN1=@RST+1
"RTN","ORWPS",99,0)
 D SETMULT(RST,INDEX,"B")
"RTN","ORWPS",100,0)
 I $D(@RST@(SOLN1)),$L($P(FIELDS,U,2)) S @RST@(SOLN1)="in "_@RST@(SOLN1)
"RTN","ORWPS",101,0)
 S SOLN1=@RST+1
"RTN","ORWPS",102,0)
 D SETMULT(RST,INDEX,"SCH") S:$D(@RST@(SOLN1)) @RST@(SOLN1)=" "_@RST@(SOLN1)
"RTN","ORWPS",103,0)
 F I=1:1:@RST S @RST@(I)="\"_$TR(@RST@(I),U," ")
"RTN","ORWPS",104,0)
 I $D(@RST@(1)) S @RST@(1)=" "_$E(@RST@(1),2,999)
"RTN","ORWPS",105,0)
 S @RST@(@RST)=@RST@(@RST)_" "_$P(^TMP("PS",$J,INDEX,0),U,3)
"RTN","ORWPS",106,0)
 S:$D(^TMP("PS",$J,INDEX,"IVLIM",0)) IVDUR=$G(^TMP("PS",$J,INDEX,"IVLIM",0))
"RTN","ORWPS",107,0)
 I $L(IVDUR) D
"RTN","ORWPS",108,0)
 . N DURU,DURV S DURU="",DURV=0
"RTN","ORWPS",109,0)
 . S DURU=$E(IVDUR,1),DURV=$E(IVDUR,2,$L(IVDUR))
"RTN","ORWPS",110,0)
 . I (DURU="D")!(DURU="d") S IVDUR="for "_+DURV_$S(+DURV=1:" day",+DURV>1:" days",1:" day")
"RTN","ORWPS",111,0)
 . I (DURU="H")!(DURU="h") S IVDUR="for "_+DURV_$S(+DURV=1:" hours",+DURV>1:" hours",1:" hour")
"RTN","ORWPS",112,0)
 . I (DURU="M")!(DURU="m") S IVDUR="with total volume "_+DURV_" ml"
"RTN","ORWPS",113,0)
 . I (DURU="L")!(DURU="l") S IVDUR="with total volume "_+DURV_" L"
"RTN","ORWPS",114,0)
 . S @RST@(@RST)=@RST@(@RST)_" "_IVDUR
"RTN","ORWPS",115,0)
 M Y=@RST K @RST
"RTN","ORWPS",116,0)
 Q
"RTN","ORWPS",117,0)
NVINST(Y,INDEX) ; assembles instructions for a non-VA med
"RTN","ORWPS",118,0)
 N I,X,RST
"RTN","ORWPS",119,0)
 S X=^TMP("PS",$J,INDEX,0)
"RTN","ORWPS",120,0)
 S RST="^TMP(""ORACT"",$J,""INSTRUCT"")"
"RTN","ORWPS",121,0)
 S @RST@(1)=" "_$P(X,U,2),@RST=1
"RTN","ORWPS",122,0)
 D SETMULT(RST,INDEX,"SIG")
"RTN","ORWPS",123,0)
 I @RST=1 D
"RTN","ORWPS",124,0)
 . D SETMULT(RST,INDEX,"SIO")
"RTN","ORWPS",125,0)
 . D SETMULT(RST,INDEX,"MDR")
"RTN","ORWPS",126,0)
 . D SETMULT(RST,INDEX,"SCH")
"RTN","ORWPS",127,0)
 S @RST@(2)="\ "_$G(@RST@(2))
"RTN","ORWPS",128,0)
 F I=3:1:@RST S @RST@(I)=" "_@RST@(I)
"RTN","ORWPS",129,0)
 M Y=@RST K @RST
"RTN","ORWPS",130,0)
 Q
"RTN","ORWPS",131,0)
NVREASON(ORR,NVSDT,INDEX) ; assembles start date and reasons for a non-VA med
"RTN","ORWPS",132,0)
 N ORI,J,X,ORN,ORA
"RTN","ORWPS",133,0)
 S ORI=0 K ORR
"RTN","ORWPS",134,0)
 S X=^TMP("PS",$J,INDEX,0)
"RTN","ORWPS",135,0)
 S ORN=+$P(X,U,8)
"RTN","ORWPS",136,0)
 I $D(^OR(100,ORN,0)) D
"RTN","ORWPS",137,0)
 .S NVSDT=$P(^OR(100,ORN,0),U,8)
"RTN","ORWPS",138,0)
 .D WPVAL^ORWDXR(.ORA,ORN,"STATEMENTS") I $D(ORA) D
"RTN","ORWPS",139,0)
 ..S J=0 F  S J=$O(ORA(J)) Q:J<1  S ORI=ORI+1,ORR(ORI)=ORA(J)
"RTN","ORWPS",140,0)
 Q
"RTN","ORWPS",141,0)
SETMULT(Y,INDEX,SUB) ; appends the multiple at the subscript to Y
"RTN","ORWPS",142,0)
 N I,X,J
"RTN","ORWPS",143,0)
 S J=$G(@Y)
"RTN","ORWPS",144,0)
 S I=0 F  S I=$O(^TMP("PS",$J,INDEX,SUB,I)) Q:'I  S X=$G(^(I,0)) D
"RTN","ORWPS",145,0)
 . I SUB="B",$L($P(X,U,3)) S X=$P(X,U)_" "_$P(X,U,3)_"^"_$P(X,U,2)
"RTN","ORWPS",146,0)
 . S J=J+1,@Y@(J)=X
"RTN","ORWPS",147,0)
 S @Y=J
"RTN","ORWPS",148,0)
 Q
"RTN","ORWPS",149,0)
COMPRESS(Y) ; concatenate Y subscripts into smallest possible number
"RTN","ORWPS",150,0)
 N I,J,X S J=1,X(J)=""
"RTN","ORWPS",151,0)
 S I=0 F  S I=$O(Y(I)) Q:'I  D
"RTN","ORWPS",152,0)
 . I ($L(Y(I))+$L(X(J)))>245 S J=J+1,X(J)=""
"RTN","ORWPS",153,0)
 . S X(J)=X(J)_$S($L(X(J)):" ",1:"")_Y(I)
"RTN","ORWPS",154,0)
 K Y M Y=X
"RTN","ORWPS",155,0)
 Q
"RTN","ORWPS",156,0)
DETAIL(ROOT,DFN,ID) ; -- show details for a med order
"RTN","ORWPS",157,0)
 K ^TMP("ORXPND",$J)
"RTN","ORWPS",158,0)
 N LCNT,ORVP
"RTN","ORWPS",159,0)
 S LCNT=0,ORVP=DFN_";DPT("
"RTN","ORWPS",160,0)
 D MEDS^ORCXPND1
"RTN","ORWPS",161,0)
 S ROOT=$NA(^TMP("ORXPND",$J))
"RTN","ORWPS",162,0)
 Q
"RTN","ORWPS",163,0)
MEDHIST(ORROOT,DFN,ORIFN)       ; -- show admin history for a med  (RV)
"RTN","ORWPS",164,0)
 N ORPSID,ISIV,CKPKG,ORPHMID
"RTN","ORWPS",165,0)
 S ORPSID=+$P($$OI^ORX8(ORIFN),U,3),ISIV=0
"RTN","ORWPS",166,0)
 S ORROOT=$NA(^TMP("ORHIST",$J)) K @ORROOT
"RTN","ORWPS",167,0)
 S ORPHMID=$G(^OR(100,+ORIFN,4))  ;Pharmacy order number
"RTN","ORWPS",168,0)
 S ISIV=$O(^ORD(100.98,"B","IV RX",ISIV))
"RTN","ORWPS",169,0)
 S CKPKG=$$PATCH^XPDUTL("PSB*2.0*19")
"RTN","ORWPS",170,0)
 I $P($G(^OR(100,+ORIFN,0)),U,11)=ISIV D  Q
"RTN","ORWPS",171,0)
 . I 'CKPKG S @ORROOT@(0)="Medication Administration History is not available at this time for IV fluids."
"RTN","ORWPS",172,0)
 . I CKPKG D
"RTN","ORWPS",173,0)
 . . D RPC^PSBO(.ORROOT,"PM",DFN,"","","","","","","","","",ORPHMID)  ;DBIA #3955
"RTN","ORWPS",174,0)
 . . I '$D(@ORROOT) S @ORROOT@(0)="No Medication Administration History found for the IV order."
"RTN","ORWPS",175,0)
 I '$L($T(HISTORY^PSBMLHS)) D  Q  ;DBIA #3459
"RTN","ORWPS",176,0)
 . S @ORROOT@(0)="This report is only available using BCMA version 2.0."
"RTN","ORWPS",177,0)
 D HISTORY^PSBMLHS(.ORROOT,DFN,ORPHMID)  ; DBIA #3459 for BCMA v2.0
"RTN","ORWPS",178,0)
 Q
"RTN","ORWPS",179,0)
 ;
"RTN","ORWPS",180,0)
REASON(ORY) ; -- Return Non-VA Med Statement/Reasons
"RTN","ORWPS",181,0)
 N ORE
"RTN","ORWPS",182,0)
 D GETLST^XPAR(.ORY,"ALL","ORWD NONVA REASON","E")
"RTN","ORWPS",183,0)
 Q
"RTN","ORY26508")
0^^B24415418^n/a
"RTN","ORY26508",1,0)
ORY26508 ;SLC/JEH - OCX PACKAGE RULE TRANSPORT ROUTINE - PLUS ;NOV 16, 2006 15:00
"RTN","ORY26508",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**265**;Dec 17,1997;Build 17
"RTN","ORY26508",3,0)
 ;;  ;;ORDER CHECK EXPERT version 1.01 released OCT 29,1998
"RTN","ORY26508",4,0)
 ;;  ;;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","ORY26508",5,0)
 ;
"RTN","ORY26508",6,0)
 ;
"RTN","ORY26508",7,0)
SCH ; This code will correct the pointer to imaging. 
"RTN","ORY26508",8,0)
 N DTIME,DLAYGO,DINUM,DIC,Y,X,IX,OLD,RPTID,DONEX
"RTN","ORY26508",9,0)
 S DIC="^ORD(100.98,"   ; Find the IEN of IMAGING in the Display File
"RTN","ORY26508",10,0)
 S DIC(0)="N,O,X"
"RTN","ORY26508",11,0)
 S X="IMAGING"
"RTN","ORY26508",12,0)
 D ^DIC
"RTN","ORY26508",13,0)
 I $G(Y) D   ; RPT SCHEDULED/DUE ACTIVITY replace IEN for NURSING (13) (found at some sites) with IMAGING IEN
"RTN","ORY26508",14,0)
 . S X=+Y
"RTN","ORY26508",15,0)
 . ;
"RTN","ORY26508",16,0)
 . S (IX,DONEX,RPTID,OLD)=0
"RTN","ORY26508",17,0)
 . S RPTID=$O(^ORD(102.21,"B","RPT SCHEDULED/DUE ACTIVITY",0))
"RTN","ORY26508",18,0)
 . F  S IX=$O(^ORD(102.21,RPTID,1,IX)) Q:('IX)!DONEX  D
"RTN","ORY26508",19,0)
 . . I $P(^ORD(102.21,RPTID,1,IX,0),U,4)="IMAGING" D
"RTN","ORY26508",20,0)
 . . . I ^ORD(102.21,RPTID,1,IX,1,1,0)'=X D
"RTN","ORY26508",21,0)
 . . . . S OLD=^ORD(102.21,RPTID,1,IX,1,1,0)
"RTN","ORY26508",22,0)
 . . . . S ^ORD(102.21,RPTID,1,IX,1,1,0)=X
"RTN","ORY26508",23,0)
 . . . . K ^ORD(102.21,RPTID,1,IX,1,"B",OLD,1)
"RTN","ORY26508",24,0)
 . . . . S ^ORD(102.21,RPTID,1,IX,1,"B",X,1)="",DONEX=1
"RTN","ORY26508",25,0)
 W !,"FINISHED: UPDATING CPRS QUERY DEFINITION NAME / RPT SCHEDULED/DUE ACTIVITY"
"RTN","ORY26508",26,0)
 W !
"RTN","ORY26508",27,0)
 ;
"RTN","ORY26508",28,0)
OCX ; this code updates the expert system to compile code that allows results with "<>=" in matching the threshold limit.
"RTN","ORY26508",29,0)
 N LINE,UPDATE,TEXT1,TEXT2,ADDTEXT,TTALCNT,CNT
"RTN","ORY26508",30,0)
 S UPDATE=0
"RTN","ORY26508",31,0)
 S TEXT1="",TEXT2=""
"RTN","ORY26508",32,0)
 S TTALCNT=$P(^OCXS(860.8,53,"CODE",0),"^",3)+1
"RTN","ORY26508",33,0)
 S LINE=1
"RTN","ORY26508",34,0)
 S ADDTEXT=$P($T(DATA+1),";",3,40)
"RTN","ORY26508",35,0)
 F   S LINE=$O(^OCXS(860.8,53,"CODE",LINE)) Q:(LINE=TTALCNT)!(LINE="")!(LINE]"@")  D
"RTN","ORY26508",36,0)
 . I ^OCXS(860.8,53,"CODE",LINE,0)=ADDTEXT S TTALCNT=LINE+1 Q  ; If change has already been made
"RTN","ORY26508",37,0)
 . I UPDATE=0,^OCXS(860.8,53,"CODE",LINE,0)="  ; Q:'$G(OCXLAB)!'$G(OCXSPEC)!'$G(OCXRSLT)!'$L($G(OCXOP)) 0" D
"RTN","ORY26508",38,0)
 . . S TEXT1=^OCXS(860.8,53,"CODE",LINE,0)
"RTN","ORY26508",39,0)
 . . S ^OCXS(860.8,53,"CODE",LINE,0)=$P($T(DATA+1),";",3,40)
"RTN","ORY26508",40,0)
 . . S UPDATE=1
"RTN","ORY26508",41,0)
 . . ; Q
"RTN","ORY26508",42,0)
 . I UPDATE=1 D
"RTN","ORY26508",43,0)
 . . S TEXT2=TEXT1
"RTN","ORY26508",44,0)
 . . S CNT=LINE+1
"RTN","ORY26508",45,0)
 . . S TEXT1=$G(^OCXS(860.8,53,"CODE",CNT,0))
"RTN","ORY26508",46,0)
 . . S ^OCXS(860.8,53,"CODE",CNT,0)=TEXT2
"RTN","ORY26508",47,0)
 . . Q:TEXT1=""
"RTN","ORY26508",48,0)
 I UPDATE=1 D
"RTN","ORY26508",49,0)
 . S $P(^OCXS(860.8,53,"CODE",0),"^",3)=TTALCNT
"RTN","ORY26508",50,0)
 . S $P(^OCXS(860.8,53,"CODE",0),"^",4)=TTALCNT
"RTN","ORY26508",51,0)
 . W !,"FINISHED: UPDATING ORDER CHECK COMPILER FUNCTIONS"
"RTN","ORY26508",52,0)
 . W !!,"THE EXPERT SYSTEM WILL NEED TO BE RECOMPILED TO COMPLETE THIS PROCESS"
"RTN","ORY26508",53,0)
 . W !,"PLEASE SEE THE PATCH INSTRUCTION ON RECOMPILING THE EXPERT SYSTEM"
"RTN","ORY26508",54,0)
 I UPDATE=0 W !,"NO UPDATE NEEDED OR MADE TO EXPERT SYSTEM"
"RTN","ORY26508",55,0)
 Q
"RTN","ORY26508",56,0)
 ;
"RTN","ORY26508",57,0)
RECOVER ; RESET TO OLD GLOBAL
"RTN","ORY26508",58,0)
 N LINE,TEXT1,TTALCNT
"RTN","ORY26508",59,0)
 S TEXT1=""
"RTN","ORY26508",60,0)
 S TTALCNT=$P(^OCXS(860.8,53,"CODE",0),"^",3)+1
"RTN","ORY26508",61,0)
 S LINE=0
"RTN","ORY26508",62,0)
 F   S LINE=$O(^OCXS(860.8,53,"CODE",LINE)) Q:(LINE=TTALCNT)!(LINE="")!(LINE]"@")  D
"RTN","ORY26508",63,0)
 . S TEXT1=$P($T(DATA2+LINE),";",3,40)
"RTN","ORY26508",64,0)
 . S ^OCXS(860.8,53,"CODE",LINE,0)=TEXT1
"RTN","ORY26508",65,0)
 S ^OCXS(860.8,53,"CODE",0)="^^16^16^3060823^"
"RTN","ORY26508",66,0)
 Q
"RTN","ORY26508",67,0)
 ;
"RTN","ORY26508",68,0)
DATA ;
"RTN","ORY26508",69,0)
 ;;  ; S OCXRSLT=$TR($G(OCXRSLT),"<>=","")
"RTN","ORY26508",70,0)
 ;
"RTN","ORY26508",71,0)
 ;;^OCXS(860.8,53,0)=LAB THRESHOLD EXCEEDED BOOLEAN^LABTHRSB
"RTN","ORY26508",72,0)
 ;;^OCXS(860.8,53,"CODE",0)=^^17^17^3060823^
"RTN","ORY26508",73,0)
 ;;^OCXS(860.8,53,"CODE",1,0)=  ;LABTHRSB(OCXLAB,OCXPEC,OCXRSLT,OCXOP)       ;
"RTN","ORY26508",74,0)
 ;;^OCXS(860.8,53,"CODE",2,0)=  ; ;
"RTN","ORY26508",75,0)
 ;;^OCXS(860.8,53,"CODE",3,0)=  ; S OCXRSLT=$TR($G(OCXRSLT),"<>=","")
"RTN","ORY26508",76,0)
 ;;^OCXS(860.8,53,"CODE",4,0)=  ; Q:'$G(OCXLAB)!'$G(OCXPEC)!'$G(OCXRSLT)!'$L($G(OCXOP)) 0
"RTN","ORY26508",77,0)
 ;;^OCXS(860.8,53,"CODE",5,0)=  ; ;
"RTN","ORY26508",78,0)
 ;;^OCXS(860.8,53,"CODE",6,0)=  ; N OCXX,OCXPENT,OCXERR,OCXLABSP,OCXPVAL,OCXEXCD
"RTN","ORY26508",79,0)
 ;;^OCXS(860.8,53,"CODE",7,0)=  ; S OCXEXCD=0,OCXLABSP=OCXLAB_";"_OCXPEC
"RTN","ORY26508",80,0)
 ;;^OCXS(860.8,53,"CODE",8,0)=  ; D ENVAL^XPAR(.OCXX,"ORB LAB "_OCXOP_" THRESHOLD",OCXLABSP,.OCXERR)
"RTN","ORY26508",81,0)
 ;;^OCXS(860.8,53,"CODE",9,0)=T+; I $G(OCXTRACE) W !,"Lab parameter values:",! ZW OCXX,OCXERR
"RTN","ORY26508",82,0)
 ;;^OCXS(860.8,53,"CODE",10,0)=  ; Q:+$G(ORERR)'=0 OCXEXCD
"RTN","ORY26508",83,0)
 ;;^OCXS(860.8,53,"CODE",11,0)=  ; Q:+$G(OCXX)=0 OCXEXCD
"RTN","ORY26508",84,0)
 ;;^OCXS(860.8,53,"CODE",12,0)=  ; S OCXPENT="" F  S OCXPENT=$O(OCXX(OCXPENT)) Q:'OCXPENT!OCXEXCD=1  D
"RTN","ORY26508",85,0)
 ;;^OCXS(860.8,53,"CODE",13,0)=  ; .S OCXPVAL=OCXX(OCXPENT,OCXLABSP)
"RTN","ORY26508",86,0)
 ;;^OCXS(860.8,53,"CODE",14,0)=  ; .I $L(OCXPVAL) D
"RTN","ORY26508",87,0)
 ;;^OCXS(860.8,53,"CODE",15,0)=  ; ..I $P(OCXPENT,";",2)="VA(200,",@((+OCXRSLT)_OCXOP_OCXPVAL) D
"RTN","ORY26508",88,0)
 ;;^OCXS(860.8,53,"CODE",16,0)=  ; ...S OCXEXCD=1
"RTN","ORY26508",89,0)
 ;;^OCXS(860.8,53,"CODE",17,0)=  ; Q OCXEXCD
"RTN","ORY26508",90,0)
 ;
"RTN","ORY26508",91,0)
DATA2 ;
"RTN","ORY26508",92,0)
 ;;  ;LABTHRSB(OCXLAB,OCXPEC,OCXRSLT,OCXOP)       ;
"RTN","ORY26508",93,0)
 ;;  ; ;
"RTN","ORY26508",94,0)
 ;;  ; Q:'$G(OCXLAB)!'$G(OCXSPEC)!'$G(OCXRSLT)!'$L($G(OCXOP)) 0
"RTN","ORY26508",95,0)
 ;;  ; ;
"RTN","ORY26508",96,0)
 ;;  ; N OCXX,OCXPENT,OCXERR,OCXLABSP,OCXPVAL,OCXEXCD
"RTN","ORY26508",97,0)
 ;;  ; S OCXEXCD=0,OCXLABSP=OCXLAB_";"_OCXPEC
"RTN","ORY26508",98,0)
 ;;  ; D ENVAL^XPAR(.OCXX,"ORB LAB "_OCXOP_" THRESHOLD",OCXLABSP,.OCXERR)
"RTN","ORY26508",99,0)
 ;;T+; I $G(OCXTRACE) W !,"Lab parameter values:",! ZW OCXX,OCXERR
"RTN","ORY26508",100,0)
 ;;  ; Q:+$G(ORERR)'=0 OCXEXCD
"RTN","ORY26508",101,0)
 ;;  ; Q:+$G(OCXX)=0 OCXEXCD
"RTN","ORY26508",102,0)
 ;;  ; S OCXPENT="" F  S OCXPENT=$O(OCXX(OCXPENT)) Q:'OCXPENT!OCXEXCD=1  D
"RTN","ORY26508",103,0)
 ;;  ; .S OCXPVAL=OCXX(OCXPENT,OCXLABSP)
"RTN","ORY26508",104,0)
 ;;  ; .I $L(OCXPVAL) D
"RTN","ORY26508",105,0)
 ;;  ; ..I $P(OCXPENT,";",2)="VA(200,",@((+OCXRSLT)_OCXOP_OCXPVAL) D
"RTN","ORY26508",106,0)
 ;;  ; ...S OCXEXCD=1
"RTN","ORY26508",107,0)
 ;;  ; Q OCXEXCD
"RTN","ORY26508",108,0)
 ;
"VER")
8.0^22.0
"BLD",6985,6)
^247
**END**
**END**
