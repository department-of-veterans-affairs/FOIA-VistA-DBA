Released DG*5.3*488 SEQ #432
Extracted from mail message
**KIDS**:DG*5.3*488^

**INSTALL NAME**
DG*5.3*488
"BLD",4440,0)
DG*5.3*488^REGISTRATION^0^3030204^y
"BLD",4440,1,0)
^^3^3^3021217^
"BLD",4440,1,1,0)
CLEANUP RECORDS FROM THE 408.12, 408.21, & 408.22 FILES THAT WERE 
"BLD",4440,1,2,0)
PARTIALLY STUBBED IN BECAUSE OF AN HL7 VER. 1.6 PROBLEM.  
"BLD",4440,1,3,0)
NOIS:NIN-0802-40682
"BLD",4440,4,0)
^9.64PA^^
"BLD",4440,"KRN",0)
^9.67PA^8989.52^19
"BLD",4440,"KRN",.4,0)
.4
"BLD",4440,"KRN",.401,0)
.401
"BLD",4440,"KRN",.402,0)
.402
"BLD",4440,"KRN",.403,0)
.403
"BLD",4440,"KRN",.5,0)
.5
"BLD",4440,"KRN",.84,0)
.84
"BLD",4440,"KRN",3.6,0)
3.6
"BLD",4440,"KRN",3.8,0)
3.8
"BLD",4440,"KRN",9.2,0)
9.2
"BLD",4440,"KRN",9.8,0)
9.8
"BLD",4440,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",4440,"KRN",9.8,"NM",1,0)
DG488^^0^B89074323
"BLD",4440,"KRN",9.8,"NM",2,0)
DG488M^^0^B31928620
"BLD",4440,"KRN",9.8,"NM","B","DG488",1)

"BLD",4440,"KRN",9.8,"NM","B","DG488M",2)

"BLD",4440,"KRN",19,0)
19
"BLD",4440,"KRN",19,"NM",0)
^9.68A^4^4
"BLD",4440,"KRN",19,"NM",1,0)
DG488 * CLEANUP MAIN MENU *^^0
"BLD",4440,"KRN",19,"NM",2,0)
DG488 CLEANUP 408 FILES^^0
"BLD",4440,"KRN",19,"NM",3,0)
DG488 MONITOR 408 CLEANUP^^0
"BLD",4440,"KRN",19,"NM",4,0)
DG488 TEST CLEANUP 408 FILES^^0
"BLD",4440,"KRN",19,"NM","B","DG488 * CLEANUP MAIN MENU *",1)

"BLD",4440,"KRN",19,"NM","B","DG488 CLEANUP 408 FILES",2)

"BLD",4440,"KRN",19,"NM","B","DG488 MONITOR 408 CLEANUP",3)

"BLD",4440,"KRN",19,"NM","B","DG488 TEST CLEANUP 408 FILES",4)

"BLD",4440,"KRN",19.1,0)
19.1
"BLD",4440,"KRN",101,0)
101
"BLD",4440,"KRN",409.61,0)
409.61
"BLD",4440,"KRN",771,0)
771
"BLD",4440,"KRN",870,0)
870
"BLD",4440,"KRN",8989.51,0)
8989.51
"BLD",4440,"KRN",8989.52,0)
8989.52
"BLD",4440,"KRN",8994,0)
8994
"BLD",4440,"KRN","B",.4,.4)

"BLD",4440,"KRN","B",.401,.401)

"BLD",4440,"KRN","B",.402,.402)

"BLD",4440,"KRN","B",.403,.403)

"BLD",4440,"KRN","B",.5,.5)

"BLD",4440,"KRN","B",.84,.84)

"BLD",4440,"KRN","B",3.6,3.6)

"BLD",4440,"KRN","B",3.8,3.8)

"BLD",4440,"KRN","B",9.2,9.2)

"BLD",4440,"KRN","B",9.8,9.8)

"BLD",4440,"KRN","B",19,19)

"BLD",4440,"KRN","B",19.1,19.1)

"BLD",4440,"KRN","B",101,101)

"BLD",4440,"KRN","B",409.61,409.61)

"BLD",4440,"KRN","B",771,771)

"BLD",4440,"KRN","B",870,870)

"BLD",4440,"KRN","B",8989.51,8989.51)

"BLD",4440,"KRN","B",8989.52,8989.52)

"BLD",4440,"KRN","B",8994,8994)

"BLD",4440,"QUES",0)
^9.62^^
"KRN",19,11554,-1)
0^4
"KRN",19,11554,0)
DG488 TEST CLEANUP 408 FILES^Test of Cleanup Patient Relation/Income files^^R^^^^^^^^
"KRN",19,11554,1,0)
^^6^6^3021216^
"KRN",19,11554,1,1,0)
This option will allow the authorized user the ability to test the 
"KRN",19,11554,1,2,0)
cleanup process of the 3 Patient Relation & Income type files, 408.12, 
"KRN",19,11554,1,3,0)
408.21, & 408.22.  An HL7 error left some of these files partially 
"KRN",19,11554,1,4,0)
stubbed in and not pointing to their proper entries in the related 
"KRN",19,11554,1,5,0)
files.  This option will produce the XTMP("DG488" global for review prior 
"KRN",19,11554,1,6,0)
to actually performing the cleanup.
"KRN",19,11554,25)
TEST^DG488
"KRN",19,11554,"U")
TEST OF CLEANUP PATIENT RELATI
"KRN",19,11555,-1)
0^2
"KRN",19,11555,0)
DG488 CLEANUP 408 FILES^Cleanup Patient Relation/Income files (Live)^^R^^^^^^^^
"KRN",19,11555,1,0)
^^4^4^3021216^
"KRN",19,11555,1,1,0)
This option will allow the authorized user the ability to run in Live 
"KRN",19,11555,1,2,0)
mode the cleanup process of the 3 Patient Relation & Income type files,
"KRN",19,11555,1,3,0)
408.12, 408.21, & 408.22.  Bad pointers and partially stubbed in records 
"KRN",19,11555,1,4,0)
will be deleted.
"KRN",19,11555,25)
EN^DG488
"KRN",19,11555,"U")
CLEANUP PATIENT RELATION/INCOM
"KRN",19,11556,-1)
0^3
"KRN",19,11556,0)
DG488 MONITOR 408 CLEANUP^Monitor the Cleanup of the 408 files^^R^^^^^^^^
"KRN",19,11556,1,0)
^^2^2^3021216^
"KRN",19,11556,1,1,0)
This opiton will monitor the status of the cleanup process of the 408 
"KRN",19,11556,1,2,0)
files.
"KRN",19,11556,25)
MONITOR^DG488M
"KRN",19,11556,"U")
MONITOR THE CLEANUP OF THE 408
"KRN",19,11557,-1)
0^1
"KRN",19,11557,0)
DG488 * CLEANUP MAIN MENU *^408 Files Cleanup^^M^^^^^^^^
"KRN",19,11557,1,0)
^^2^2^3021216^
"KRN",19,11557,1,1,0)
This menu contains links to the options needed to successfully run the 
"KRN",19,11557,1,2,0)
cleanup process of the 408 realted patient files.
"KRN",19,11557,10,0)
^19.01IP^3^3
"KRN",19,11557,10,1,0)
11555^RUN^2
"KRN",19,11557,10,1,"^")
DG488 CLEANUP 408 FILES
"KRN",19,11557,10,2,0)
11554^TST^1
"KRN",19,11557,10,2,"^")
DG488 TEST CLEANUP 408 FILES
"KRN",19,11557,10,3,0)
11556^MON^3
"KRN",19,11557,10,3,"^")
DG488 MONITOR 408 CLEANUP
"KRN",19,11557,99)
59154,46990
"KRN",19,11557,"U")
408 FILES CLEANUP
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
488^3030204
"PKG",5,22,1,"PAH",1,1,0)
^^3^3^3030204
"PKG",5,22,1,"PAH",1,1,1,0)
CLEANUP RECORDS FROM THE 408.12, 408.21, & 408.22 FILES THAT WERE 
"PKG",5,22,1,"PAH",1,1,2,0)
PARTIALLY STUBBED IN BECAUSE OF AN HL7 VER. 1.6 PROBLEM.  
"PKG",5,22,1,"PAH",1,1,3,0)
NOIS:NIN-0802-40682
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","DG488")
0^1^B89074323
"RTN","DG488",1,0)
DG488 ;ALB/GN - CLEANUP PATIENT RELATION & INCOME FILES;12/11/02 ; 2/4/03 1:25pm
"RTN","DG488",2,0)
 ;;5.3;REGISTRATION;**488**;5-1-2001
"RTN","DG488",3,0)
 ;
"RTN","DG488",4,0)
 Q
"RTN","DG488",5,0)
 ;
"RTN","DG488",6,0)
TEST ; Entry point for testing this routine, then fall thru.
"RTN","DG488",7,0)
 S TESTING=1
"RTN","DG488",8,0)
EN ; Entry point to start job
"RTN","DG488",9,0)
 ;
"RTN","DG488",10,0)
 N QUIT,ZTDESC,ZTIO,ZTRTN,ZTSK,ZTQUEUED,ZTSAVE
"RTN","DG488",11,0)
 ;
"RTN","DG488",12,0)
 S TESTING=+$G(TESTING)
"RTN","DG488",13,0)
 ; setup TM variables and Load 
"RTN","DG488",14,0)
 S ZTSAVE("TESTING")=""
"RTN","DG488",15,0)
 S ZTRTN=("TASK^DG488")
"RTN","DG488",16,0)
 S ZTDESC="Cleanup Patient Relation & Income Files"
"RTN","DG488",17,0)
 S ZTIO=""
"RTN","DG488",18,0)
 W !!,ZTDESC,!
"RTN","DG488",19,0)
 ;
"RTN","DG488",20,0)
 ;check if already running or completed.
"RTN","DG488",21,0)
 S QUIT=$$CHKSTAT
"RTN","DG488",22,0)
 I QUIT L -^XTMP($$NAMSPC) K TESTING Q
"RTN","DG488",23,0)
 D ^%ZTLOAD
"RTN","DG488",24,0)
 L -^XTMP($$NAMSPC)
"RTN","DG488",25,0)
 K TESTING
"RTN","DG488",26,0)
 I $D(ZTSK) D
"RTN","DG488",27,0)
 . W !,"This request queued as Task # ",ZTSK,!
"RTN","DG488",28,0)
 Q
"RTN","DG488",29,0)
 ;
"RTN","DG488",30,0)
TASK ; Entry point for taskman
"RTN","DG488",31,0)
 L +^XTMP($$NAMSPC):10 I '$T D  Q   ;quit if can't get a lock
"RTN","DG488",32,0)
 . S $P(^XTMP($$NAMSPC,0,0),U,12)="NO LOCK GAINED"
"RTN","DG488",33,0)
 N ZTSTOP,LSTREC,DIK,DA,NAMSPC,DGT12,DG12,DG12X,DGT22,DG22,DG22X
"RTN","DG488",34,0)
 N BEGTIME,PURGDT,DGFIL,IEN,DGIEN,BTIME,STAT,STIME,DGT21,DG21,DG21X
"RTN","DG488",35,0)
 S NAMSPC=$$NAMSPC
"RTN","DG488",36,0)
 S ZTDESC=$G(ZTDESC,"Cleanup of Patient Related Income files")
"RTN","DG488",37,0)
 ;
"RTN","DG488",38,0)
 S TESTING=$G(TESTING,1)        ;assume testing if not defined
"RTN","DG488",39,0)
 ;setup XTMP according to stds.
"RTN","DG488",40,0)
 S BEGTIME=$$NOW^XLFDT()
"RTN","DG488",41,0)
 S PURGDT=$$FMADD^XLFDT(BEGTIME,30)
"RTN","DG488",42,0)
 S ^XTMP(NAMSPC,0)=PURGDT_U_BEGTIME_U_ZTDESC
"RTN","DG488",43,0)
 S ^XTMP(NAMSPC,0,"TASKID")=$G(ZTSK,"DIRECT")
"RTN","DG488",44,0)
 S ^XTMP(NAMSPC,0,"TESTING")=TESTING
"RTN","DG488",45,0)
 ;get last run data
"RTN","DG488",46,0)
 D GETLAST
"RTN","DG488",47,0)
 ;init begin time, if not there, and status & stop time fields
"RTN","DG488",48,0)
 S $P(^XTMP(NAMSPC,0,0),U,12,13)="RUNNING^"
"RTN","DG488",49,0)
 S:$P(^XTMP(NAMSPC,0,0),U,11)="" $P(^XTMP(NAMSPC,0,0),U,11)=$$NOW^XLFDT
"RTN","DG488",50,0)
 ;start/restart cleanups
"RTN","DG488",51,0)
 S:DGFIL="" DGFIL=408.12
"RTN","DG488",52,0)
 I DGFIL=408.12 D
"RTN","DG488",53,0)
 . S IEN=DGIEN,DGIEN=0
"RTN","DG488",54,0)
 . D DG40812(IEN)
"RTN","DG488",55,0)
 . S:'ZTSTOP DGFIL=408.21       ;continue if stop not requested
"RTN","DG488",56,0)
 I DGFIL=408.21 D
"RTN","DG488",57,0)
 . S IEN=DGIEN,DGIEN=0
"RTN","DG488",58,0)
 . D DG40821(IEN)
"RTN","DG488",59,0)
 . S:'ZTSTOP DGFIL=408.22       ;continue if stop not requested
"RTN","DG488",60,0)
 I DGFIL=408.22 D
"RTN","DG488",61,0)
 . S IEN=DGIEN
"RTN","DG488",62,0)
 . D DG40822(IEN)
"RTN","DG488",63,0)
 ;
"RTN","DG488",64,0)
 ;set status and mail stats
"RTN","DG488",65,0)
 I ZTSTOP S $P(^XTMP(NAMSPC,0,0),U,12,13)="STOPPED"_U_$$NOW^XLFDT
"RTN","DG488",66,0)
 E  S $P(^XTMP(NAMSPC,0,0),U,12,13)="COMPLETED"_U_$$NOW^XLFDT
"RTN","DG488",67,0)
 D MAIL^DG488M
"RTN","DG488",68,0)
 L -^XTMP(NAMSPC)
"RTN","DG488",69,0)
 K TESTING
"RTN","DG488",70,0)
 Q
"RTN","DG488",71,0)
 ;
"RTN","DG488",72,0)
DG40812(IEN) ; Main Cleanup driver for file 408.12
"RTN","DG488",73,0)
 N REC12 S ZTSTOP=0
"RTN","DG488",74,0)
 F  S IEN=$O(^DGPR(408.12,"B",IEN)) Q:('IEN)!(ZTSTOP)  D
"RTN","DG488",75,0)
 . S REC12=0
"RTN","DG488",76,0)
 . F  S REC12=$O(^DGPR(408.12,"B",IEN,REC12)) Q:('REC12)!(ZTSTOP)  D
"RTN","DG488",77,0)
 . . S DGT12=DGT12+1
"RTN","DG488",78,0)
 . . ;
"RTN","DG488",79,0)
 . . ;if bad xref then kill the xref, else check for damaged 0 node
"RTN","DG488",80,0)
 . . I '$D(^DGPR(408.12,REC12)) D
"RTN","DG488",81,0)
 . . . S ^XTMP(NAMSPC,408.12,"B",IEN,REC12)=""
"RTN","DG488",82,0)
 . . . I 'TESTING K ^DGPR(408.12,"B",IEN,REC12)
"RTN","DG488",83,0)
 . . . S DG12X=DG12X+1
"RTN","DG488",84,0)
 . . E  D
"RTN","DG488",85,0)
 . . . Q:+$P(^DGPR(408.12,REC12,0),U,3)      ;quit if piece 3 is there
"RTN","DG488",86,0)
 . . . M ^XTMP(NAMSPC,"408.12",REC12)=^DGPR(408.12,REC12)
"RTN","DG488",87,0)
 . . . D DEL40821(REC12,.DG21,.DG21X)
"RTN","DG488",88,0)
 . . . ;
"RTN","DG488",89,0)
 . . . ;delete bad 408.12
"RTN","DG488",90,0)
 . . . S DIK="^DGPR(408.12,",DA=REC12
"RTN","DG488",91,0)
 . . . I 'TESTING D ^DIK
"RTN","DG488",92,0)
 . . . K DIK,DA
"RTN","DG488",93,0)
 . . . S DG12=DG12+1
"RTN","DG488",94,0)
 . . ;
"RTN","DG488",95,0)
 . . ;check for stop request after every 100 processed recs
"RTN","DG488",96,0)
 . . I DGT12#100=0 D
"RTN","DG488",97,0)
 . . . S:$$S^%ZTLOAD ZTSTOP=1
"RTN","DG488",98,0)
 . . . I $D(^XTMP(NAMSPC,0,"STOP")) S ZTSTOP=1 K ^XTMP(NAMSPC,0,"STOP")
"RTN","DG488",99,0)
 . . S LSTREC=DGFIL_"/"_IEN
"RTN","DG488",100,0)
 . . S $P(^XTMP(NAMSPC,0,0),U,1)=LSTREC
"RTN","DG488",101,0)
 . . S $P(^XTMP(NAMSPC,0,0),U,2,6)=DGT12_U_DG12_U_DG12X_U_DGT22_U_DG22
"RTN","DG488",102,0)
 . . S $P(^XTMP(NAMSPC,0,0),U,9,10)=DG21_U_DG21X
"RTN","DG488",103,0)
 Q
"RTN","DG488",104,0)
 ;
"RTN","DG488",105,0)
DEL40821(R12,DG21,DG21X) ; Delete any entries in 408.21 that point to the bad
"RTN","DG488",106,0)
 ;                 408.12 record.
"RTN","DG488",107,0)
 N REC21 S REC21=0
"RTN","DG488",108,0)
 F  S REC21=$O(^DGMT(408.21,"C",R12,REC21)) Q:'REC21  D
"RTN","DG488",109,0)
 . ;if bad xref then kill the xref, else kill the real record
"RTN","DG488",110,0)
 . I '$D(^DGMT(408.21,REC21)) D
"RTN","DG488",111,0)
 . . S ^XTMP(NAMSPC,408.21,"C",R12,REC21)=""
"RTN","DG488",112,0)
 . . I 'TESTING K ^DGMT(408.21,"C",R12,REC21)
"RTN","DG488",113,0)
 . . S DG21X=DG21X+1
"RTN","DG488",114,0)
 . E  D
"RTN","DG488",115,0)
 . . M ^XTMP(NAMSPC,"408.21",REC21)=^DGMT(408.21,REC21)
"RTN","DG488",116,0)
 . . D DG22AIND(REC21)
"RTN","DG488",117,0)
 . . S DIK="^DGMT(408.21,",DA=REC21
"RTN","DG488",118,0)
 . . I 'TESTING D ^DIK
"RTN","DG488",119,0)
 . . K DIK,DA
"RTN","DG488",120,0)
 . . S DG21=DG21+1
"RTN","DG488",121,0)
 Q
"RTN","DG488",122,0)
 ;
"RTN","DG488",123,0)
DG22AIND(R21) ;Delete any entries in 408.22 that is pointing to the bad 408.21
"RTN","DG488",124,0)
 N REC22 S REC22=0
"RTN","DG488",125,0)
 F  S REC22=$O(^DGMT(408.22,"AIND",R21,REC22)) Q:'REC22  D
"RTN","DG488",126,0)
 . S DGT22=DGT22+1
"RTN","DG488",127,0)
 . ;if bad xref then kill the xref, else kill the real record
"RTN","DG488",128,0)
 . I '$D(^DGMT(408.22,REC22)) D
"RTN","DG488",129,0)
 . . I 'TESTING K ^DGMT(408.22,"AIND",R21,REC22)
"RTN","DG488",130,0)
 . . S DG22=DG22+1
"RTN","DG488",131,0)
 . E  D
"RTN","DG488",132,0)
 . . M ^XTMP(NAMSPC,"408.22",REC22)=^DGMT(408.22,REC22)
"RTN","DG488",133,0)
 . . S DIK="^DGMT(408.22,",DA=REC22
"RTN","DG488",134,0)
 . . I 'TESTING D ^DIK
"RTN","DG488",135,0)
 . . K DIK,DA
"RTN","DG488",136,0)
 . . S DG22=DG22+1
"RTN","DG488",137,0)
 Q
"RTN","DG488",138,0)
 ;
"RTN","DG488",139,0)
DG40821(IEN) ; Main Cleanup driver for file 408.21, If 408.21 not pointed to
"RTN","DG488",140,0)
 ; by any 408.22 record, then delete it and check 408.12 for possible
"RTN","DG488",141,0)
 ; deletion as well.
"RTN","DG488",142,0)
 N REC21 S ZTSTOP=0
"RTN","DG488",143,0)
 F  S IEN=$O(^DGMT(408.21,"B",IEN)) Q:('IEN)!(ZTSTOP)  D
"RTN","DG488",144,0)
 . S REC21=0
"RTN","DG488",145,0)
 . F  S REC21=$O(^DGMT(408.21,"B",IEN,REC21)) Q:('REC21)!(ZTSTOP)  D
"RTN","DG488",146,0)
 . . S DGT21=DGT21+1
"RTN","DG488",147,0)
 . . ;if bad xref then kill the xref, else check for damaged 0 node
"RTN","DG488",148,0)
 . . I '$D(^DGMT(408.21,REC21)) D
"RTN","DG488",149,0)
 . . . S ^XTMP(NAMSPC,408.21,"B",IEN,REC21)=""
"RTN","DG488",150,0)
 . . . I 'TESTING K ^DGMT(408.21,"B",IEN,REC21)
"RTN","DG488",151,0)
 . . . S DG21X=DG21X+1
"RTN","DG488",152,0)
 . . E  D
"RTN","DG488",153,0)
 . . . Q:$D(^DGMT(408.22,"AIND",REC21))     ;quit if 408.21 pointed to
"RTN","DG488",154,0)
 . . . M ^XTMP(NAMSPC,"408.21",REC21)=^DGMT(408.21,REC21)
"RTN","DG488",155,0)
 . . . S REC12=0
"RTN","DG488",156,0)
 . . . D DEL21(REC21,.REC12,.DG21)
"RTN","DG488",157,0)
 . . . D:REC12 CHK40812(REC12,REC21,.DG12)
"RTN","DG488",158,0)
 . . ;
"RTN","DG488",159,0)
 . . ;check for stop request after every 100 processed recs
"RTN","DG488",160,0)
 . . I DGT21#100=0 D
"RTN","DG488",161,0)
 . . . S:$$S^%ZTLOAD ZTSTOP=1
"RTN","DG488",162,0)
 . . . I $D(^XTMP(NAMSPC,0,"STOP")) S ZTSTOP=1 K ^XTMP(NAMSPC,0,"STOP")
"RTN","DG488",163,0)
 . . S LSTREC=DGFIL_"/"_IEN
"RTN","DG488",164,0)
 . . S $P(^XTMP(NAMSPC,0,0),U,1)=LSTREC
"RTN","DG488",165,0)
 . . S $P(^XTMP(NAMSPC,0,0),U,3)=DG12
"RTN","DG488",166,0)
 . . S $P(^XTMP(NAMSPC,0,0),U,8,10)=DGT21_U_DG21_U_DG21X
"RTN","DG488",167,0)
 Q
"RTN","DG488",168,0)
 ;
"RTN","DG488",169,0)
DEL21(R21,R12,DG21) ; save to Xtmp & associated REC12, then delete the 408.21
"RTN","DG488",170,0)
 Q:'$D(^DGMT(408.21,R21))
"RTN","DG488",171,0)
 M ^XTMP(NAMSPC,"408.21",R21)=^DGMT(408.21,R21)
"RTN","DG488",172,0)
 S R12=+$P($G(^DGMT(408.21,R21,0)),U,2)
"RTN","DG488",173,0)
 S DIK="^DGMT(408.21,",DA=R21
"RTN","DG488",174,0)
 I 'TESTING D ^DIK
"RTN","DG488",175,0)
 K DIK,DA
"RTN","DG488",176,0)
 S DG21=DG21+1
"RTN","DG488",177,0)
 Q
"RTN","DG488",178,0)
 ;
"RTN","DG488",179,0)
CHK40812(R12,R21,DG12) ; delete 408.12's if no other 408.21's pointing to it
"RTN","DG488",180,0)
 N XX,OK,REC21 S (REC21,OK)=0
"RTN","DG488",181,0)
 F XX=0:1 S REC21=$O(^DGMT(408.21,"C",R12,REC21)) Q:'REC21  D
"RTN","DG488",182,0)
 . S:REC21=R21 OK=1
"RTN","DG488",183,0)
 Q:XX>1                 ;quit if other 408.21's are pointing to 408.12
"RTN","DG488",184,0)
 Q:(XX=1)&('OK)         ;quit if only one rec and not the correct one
"RTN","DG488",185,0)
 ;
"RTN","DG488",186,0)
 M ^XTMP(NAMSPC,"408.12",R12)=^DGPR(408.12,R12)
"RTN","DG488",187,0)
 S DIK="^DGPR(408.12,",DA=R12
"RTN","DG488",188,0)
 I 'TESTING D ^DIK
"RTN","DG488",189,0)
 K DIK,DA
"RTN","DG488",190,0)
 S DG12=DG12+1
"RTN","DG488",191,0)
 Q
"RTN","DG488",192,0)
 ;
"RTN","DG488",193,0)
DG40822(IEN) ; Main Cleanup driver for file 408.22
"RTN","DG488",194,0)
 N REC22 S ZTSTOP=0
"RTN","DG488",195,0)
 F  S IEN=$O(^DGMT(408.22,"B",IEN)) Q:('IEN)!(ZTSTOP)  D
"RTN","DG488",196,0)
 . S REC22=0
"RTN","DG488",197,0)
 . F  S REC22=$O(^DGMT(408.22,"B",IEN,REC22)) Q:('REC22)!(ZTSTOP)  D
"RTN","DG488",198,0)
 . . S DGT22=DGT22+1
"RTN","DG488",199,0)
 . . ;
"RTN","DG488",200,0)
 . . ;if bad xref then kill the xref, else check for damaged 0 node
"RTN","DG488",201,0)
 . . I '$D(^DGMT(408.22,REC22)) D
"RTN","DG488",202,0)
 . . . S ^XTMP(NAMSPC,"408.22","B",IEN,REC22)=""
"RTN","DG488",203,0)
 . . . I 'TESTING K ^DGMT(408.22,"B",IEN,REC22)
"RTN","DG488",204,0)
 . . . S DG22X=DG22X+1
"RTN","DG488",205,0)
 . . E  D
"RTN","DG488",206,0)
 . . . Q:+$P(^DGMT(408.22,REC22,0),U,2)      ;quit if piece 2 is there
"RTN","DG488",207,0)
 . . . ;save & delete bad 408.22 rec
"RTN","DG488",208,0)
 . . . M ^XTMP(NAMSPC,"408.22",REC22)=^DGMT(408.22,REC22)
"RTN","DG488",209,0)
 . . . S DIK="^DGMT(408.22,",DA=REC22
"RTN","DG488",210,0)
 . . . I 'TESTING D ^DIK
"RTN","DG488",211,0)
 . . . K DIK,DA
"RTN","DG488",212,0)
 . . . S DG22=DG22+1
"RTN","DG488",213,0)
 . . ;
"RTN","DG488",214,0)
 . . ;check for stop request after every 100 processed recs
"RTN","DG488",215,0)
 . . I DGT22#100=0 D
"RTN","DG488",216,0)
 . . . S:$$S^%ZTLOAD ZTSTOP=1
"RTN","DG488",217,0)
 . . . I $D(^XTMP(NAMSPC,0,"STOP")) S ZTSTOP=1 K ^XTMP(NAMSPC,0,"STOP")
"RTN","DG488",218,0)
 . . S LSTREC=DGFIL_"/"_IEN
"RTN","DG488",219,0)
 . . S $P(^XTMP(NAMSPC,0,0),U,1)=LSTREC
"RTN","DG488",220,0)
 . . S $P(^XTMP(NAMSPC,0,0),U,5,7)=DGT22_U_DG22_U_DG22X
"RTN","DG488",221,0)
 Q
"RTN","DG488",222,0)
 ;
"RTN","DG488",223,0)
CHKSTAT() ;check if job is running, stopped, or completed
"RTN","DG488",224,0)
 N Y,DUOUT,DTOUT,QUIT,NAMSPC
"RTN","DG488",225,0)
 S QUIT=0
"RTN","DG488",226,0)
 S NAMSPC=$$NAMSPC
"RTN","DG488",227,0)
 L +^XTMP(NAMSPC):1
"RTN","DG488",228,0)
 I '$T W !!,*7,"*** ALREADY RUNNING ***" H 4 Q 1
"RTN","DG488",229,0)
 ;
"RTN","DG488",230,0)
 ; get current mode
"RTN","DG488",231,0)
 N TESTMODE S TESTMODE=$G(^XTMP(NAMSPC,0,"TESTING"))
"RTN","DG488",232,0)
 ; get job status
"RTN","DG488",233,0)
 S STAT=$P($G(^XTMP(NAMSPC,0,0)),U,12)
"RTN","DG488",234,0)
 S STIME=$P($G(^XTMP(NAMSPC,0,0)),U,13)
"RTN","DG488",235,0)
 Q:STAT="" QUIT
"RTN","DG488",236,0)
 ;
"RTN","DG488",237,0)
 ;if job Completed or trying to resume in Live mode when previously
"RTN","DG488",238,0)
 ;incompleted in Test mode,  ask to Re-Run
"RTN","DG488",239,0)
 I STAT="COMPLETED" D
"RTN","DG488",240,0)
 . D MSG(.QUIT)
"RTN","DG488",241,0)
 E  D
"RTN","DG488",242,0)
 . I ('TESTING&TESTMODE)!(TESTING&'TESTMODE) D MSG(.QUIT)
"RTN","DG488",243,0)
 Q QUIT
"RTN","DG488",244,0)
 ;
"RTN","DG488",245,0)
GETLAST ;get last run info
"RTN","DG488",246,0)
 S DGFIL=$P($G(^XTMP(NAMSPC,0,0)),"/")      ;file
"RTN","DG488",247,0)
 S DGIEN=+$P($G(^XTMP(NAMSPC,0,0)),"/",2)   ;ien
"RTN","DG488",248,0)
 S DGT12=+$P($G(^XTMP(NAMSPC,0,0)),U,2)     ;tot 408.12 recs processed
"RTN","DG488",249,0)
 S DG12=+$P($G(^XTMP(NAMSPC,0,0)),U,3)      ;tot 408.12 recs purged
"RTN","DG488",250,0)
 S DG12X=+$P($G(^XTMP(NAMSPC,0,0)),U,4)     ;tot bad 408.12 "B" purged
"RTN","DG488",251,0)
 S DGT22=+$P($G(^XTMP(NAMSPC,0,0)),U,5)     ;tot 408.22 recs processed
"RTN","DG488",252,0)
 S DG22=+$P($G(^XTMP(NAMSPC,0,0)),U,6)      ;tot 408.22 recs purged
"RTN","DG488",253,0)
 S DG22X=+$P($G(^XTMP(NAMSPC,0,0)),U,7)     ;tot bad 408.22 "B" purged
"RTN","DG488",254,0)
 S DGT21=+$P($G(^XTMP(NAMSPC,0,0)),U,8)     ;tot 408.21 recs processed
"RTN","DG488",255,0)
 S DG21=+$P($G(^XTMP(NAMSPC,0,0)),U,9)      ;tot 408.21 recs purged
"RTN","DG488",256,0)
 S DG21X=+$P($G(^XTMP(NAMSPC,0,0)),U,10)    ;tot bad 408.21 "C" purged
"RTN","DG488",257,0)
 S BTIME=$P($G(^XTMP(NAMSPC,0,0)),U,11)     ;begin time
"RTN","DG488",258,0)
 S STAT=$P($G(^XTMP(NAMSPC,0,0)),U,12)      ;status
"RTN","DG488",259,0)
 S STIME=$P($G(^XTMP(NAMSPC,0,0)),U,13)     ;stop time
"RTN","DG488",260,0)
 Q
"RTN","DG488",261,0)
 ;
"RTN","DG488",262,0)
MSG(QUIT) ;print message to user
"RTN","DG488",263,0)
 W " was "_STAT_" on "_$$FMTE^XLFDT(STIME)
"RTN","DG488",264,0)
 W " in "_$S(TESTMODE:"TEST",1:"LIVE")_" mode "
"RTN","DG488",265,0)
 W !,"  Do you want to Re-Run in "_$S(TESTING:"TEST",1:"LIVE")
"RTN","DG488",266,0)
 W " mode?"
"RTN","DG488",267,0)
 K DIR
"RTN","DG488",268,0)
 S DIR("?",1)="  Entering Y, will delete the XTMP global where the previous cleanup"
"RTN","DG488",269,0)
 S DIR("?")="  information was stored and begin a new job, or N to cancel request"
"RTN","DG488",270,0)
 S DIR(0)="Y" D ^DIR
"RTN","DG488",271,0)
 I 'Y S QUIT=1 Q
"RTN","DG488",272,0)
 W !," ARE YOU SURE?"
"RTN","DG488",273,0)
 K DIR
"RTN","DG488",274,0)
 S DIR("?")="Enter Y to begin a new Job or N to cancel request"
"RTN","DG488",275,0)
 S DIR(0)="Y" D ^DIR
"RTN","DG488",276,0)
 I 'Y S QUIT=1 Q
"RTN","DG488",277,0)
 ;fall thru to re-run mode, kill ^XTMP
"RTN","DG488",278,0)
 K ^XTMP(NAMSPC)
"RTN","DG488",279,0)
 Q
"RTN","DG488",280,0)
 ;
"RTN","DG488",281,0)
STOP ; alternate stop method
"RTN","DG488",282,0)
 S ^XTMP($$NAMSPC,0,"STOP")=""
"RTN","DG488",283,0)
 Q
"RTN","DG488",284,0)
NAMSPC() ;
"RTN","DG488",285,0)
 Q "DG*5.3*488"
"RTN","DG488M")
0^2^B31928620
"RTN","DG488M",1,0)
DG488M ;ALB/GN - MONITOR/MAIL CLEANUP PATIENT RELATION & INCOME FILES;12/11/02 ; 2/4/03 12:56pm
"RTN","DG488M",2,0)
 ;;5.3;REGISTRATION;**488**;5-1-2001
"RTN","DG488M",3,0)
 ;
"RTN","DG488M",4,0)
 Q
"RTN","DG488M",5,0)
 ;
"RTN","DG488M",6,0)
MONITOR ; Monitor job while running
"RTN","DG488M",7,0)
 N IOINORM,IOINHI,IOUON,IOUOFF,IOBON,IOBOFF,IORVON,IORVOFF,IOHOME
"RTN","DG488M",8,0)
 N IOELEOL,NAMSPC,DGT12,DG12,DG12X,DGT21,DG21,DG21X,DGT22,DG22,DG22X
"RTN","DG488M",9,0)
 N STAT,DGLINE,DGBLNK,NOWTIM,%H,DTOUT,I,DGLEN,DGQUIT,TITLE,TLEN,X,REC
"RTN","DG488M",10,0)
 N NAMSPC,NOWTIME,PCT,TESTING,TASKID,MODE,BTIME,DGFIL,DGIEN,STIME,RUN
"RTN","DG488M",11,0)
 S:'$D(U) U="^"
"RTN","DG488M",12,0)
 S NAMSPC=$$NAMSPC^DG488
"RTN","DG488M",13,0)
 S DGQUIT=0
"RTN","DG488M",14,0)
 D SCRNSET
"RTN","DG488M",15,0)
 S TESTING=+$G(^XTMP(NAMSPC,0,"TESTING"))
"RTN","DG488M",16,0)
 S TASKID=$G(^XTMP(NAMSPC,0,"TASKID"))
"RTN","DG488M",17,0)
 ;
"RTN","DG488M",18,0)
 F  D  Q:DGQUIT
"RTN","DG488M",19,0)
 . ;check lock status
"RTN","DG488M",20,0)
 . L +^XTMP(NAMSPC):3
"RTN","DG488M",21,0)
 . I '$T S RUN=1
"RTN","DG488M",22,0)
 . E  S RUN=0
"RTN","DG488M",23,0)
 . L -^XTMP(NAMSPC)
"RTN","DG488M",24,0)
 . ;get last run info
"RTN","DG488M",25,0)
 . D GETLAST^DG488
"RTN","DG488M",26,0)
 . S:STAT="" STAT="NOT RUNNING"
"RTN","DG488M",27,0)
 . S NOWTIME=$$NOW^XLFDT
"RTN","DG488M",28,0)
 . I (RUN&(STAT'="RUNNING"))!('RUN&(STAT="RUNNING")) D
"RTN","DG488M",29,0)
 . . S STAT="ERRORED"
"RTN","DG488M",30,0)
 . D CLRSCR
"RTN","DG488M",31,0)
 . S $P(DGBLNK," ",81)=""
"RTN","DG488M",32,0)
 . S DGLINE=DGBLNK
"RTN","DG488M",33,0)
 . S TITLE=$P($G(^XTMP(NAMSPC,0),"^^DG488 JOB"),U,3)
"RTN","DG488M",34,0)
 . S TLEN=(80-$L(TITLE)\2)
"RTN","DG488M",35,0)
 . W $$FMTE^XLFDT($$NOW^XLFDT,"2P")
"RTN","DG488M",36,0)
 . S MODE=$S(TESTING:"TEST",1:"LIVE")
"RTN","DG488M",37,0)
 . W ?32,"** ",MODE," MODE **"
"RTN","DG488M",38,0)
 . W ?63,"Task ID: ",TASKID
"RTN","DG488M",39,0)
 . W !!
"RTN","DG488M",40,0)
 . ;title line
"RTN","DG488M",41,0)
 . W ?TLEN,IOINHI,IOUON,TITLE,IOUOFF,IOINORM,!
"RTN","DG488M",42,0)
 . ;begin next line
"RTN","DG488M",43,0)
 . S DGLINE=DGBLNK
"RTN","DG488M",44,0)
 . S DGLINE=$$FMTLINE(DGLINE,4,"Status")
"RTN","DG488M",45,0)
 . S DGLINE=$$FMTLINE(DGLINE,30,"Last ien")
"RTN","DG488M",46,0)
 . S DGLINE=$$FMTLINE(DGLINE,58,"Completed Time")
"RTN","DG488M",47,0)
 . W !!,IORVON,DGLINE,IORVOFF
"RTN","DG488M",48,0)
 . ;begin next line
"RTN","DG488M",49,0)
 . S DGLINE=DGBLNK
"RTN","DG488M",50,0)
 . S DGLINE=$$FMTLINE(DGLINE,4,STAT)
"RTN","DG488M",51,0)
 . S DGLINE=$$FMTLINE(DGLINE,26,DGFIL_"/"_DGIEN)
"RTN","DG488M",52,0)
 . S DGLINE=$$FMTLINE(DGLINE,58,$$FMTE^XLFDT(STIME,2))
"RTN","DG488M",53,0)
 . W !,DGLINE
"RTN","DG488M",54,0)
 . ;begin next line
"RTN","DG488M",55,0)
 . S DGLINE=DGBLNK
"RTN","DG488M",56,0)
 . S DGLINE=$$FMTLINE(DGLINE,5,"Tot 408.12 recs")
"RTN","DG488M",57,0)
 . S DGLINE=$$FMTLINE(DGLINE,30,"408.12 recs purged")
"RTN","DG488M",58,0)
 . S DGLINE=$$FMTLINE(DGLINE,55,"408.12 bad xrefs")
"RTN","DG488M",59,0)
 . W !!,IORVON,DGLINE,IORVOFF
"RTN","DG488M",60,0)
 . ;begin next line
"RTN","DG488M",61,0)
 . S DGLINE=DGBLNK
"RTN","DG488M",62,0)
 . S DGLINE=$$FMTLINE(DGLINE,7,$J($FN(DGT12,","),10))
"RTN","DG488M",63,0)
 . S DGLINE=$$FMTLINE(DGLINE,32,$J($FN(DG12,","),10))
"RTN","DG488M",64,0)
 . S DGLINE=$$FMTLINE(DGLINE,57,$J($FN(DG12X,","),10))
"RTN","DG488M",65,0)
 . W !,DGLINE
"RTN","DG488M",66,0)
 . ;begin next line
"RTN","DG488M",67,0)
 . S DGLINE=DGBLNK
"RTN","DG488M",68,0)
 . S DGLINE=$$FMTLINE(DGLINE,5,"Tot 408.21 recs")
"RTN","DG488M",69,0)
 . S DGLINE=$$FMTLINE(DGLINE,30,"408.21 recs purged")
"RTN","DG488M",70,0)
 . S DGLINE=$$FMTLINE(DGLINE,55,"408.21 bad xrefs")
"RTN","DG488M",71,0)
 . W !!,IORVON,DGLINE,IORVOFF
"RTN","DG488M",72,0)
 . ;begin next line
"RTN","DG488M",73,0)
 . S DGLINE=DGBLNK
"RTN","DG488M",74,0)
 . S DGLINE=$$FMTLINE(DGLINE,7,$J($FN(DGT21,","),10))
"RTN","DG488M",75,0)
 . S DGLINE=$$FMTLINE(DGLINE,32,$J($FN(DG21,","),10))
"RTN","DG488M",76,0)
 . S DGLINE=$$FMTLINE(DGLINE,57,$J($FN(DG21X,","),10))
"RTN","DG488M",77,0)
 . W !,DGLINE
"RTN","DG488M",78,0)
 . ;begin next line
"RTN","DG488M",79,0)
 . S DGLINE=DGBLNK
"RTN","DG488M",80,0)
 . S DGLINE=$$FMTLINE(DGLINE,5,"Tot 408.22 recs")
"RTN","DG488M",81,0)
 . S DGLINE=$$FMTLINE(DGLINE,30,"408.22 recs purged")
"RTN","DG488M",82,0)
 . S DGLINE=$$FMTLINE(DGLINE,55,"408.22 bad xrefs")
"RTN","DG488M",83,0)
 . W !!,IORVON,DGLINE,IORVOFF
"RTN","DG488M",84,0)
 . ;begin next line
"RTN","DG488M",85,0)
 . S DGLINE=DGBLNK
"RTN","DG488M",86,0)
 . S DGLINE=$$FMTLINE(DGLINE,7,$J($FN(DGT22,","),10))
"RTN","DG488M",87,0)
 . S DGLINE=$$FMTLINE(DGLINE,32,$J($FN(DG22,","),10))
"RTN","DG488M",88,0)
 . S DGLINE=$$FMTLINE(DGLINE,57,$J($FN(DG22X,","),10))
"RTN","DG488M",89,0)
 . W !,DGLINE
"RTN","DG488M",90,0)
 . ;begin next line
"RTN","DG488M",91,0)
 . S DGLINE=DGBLNK
"RTN","DG488M",92,0)
 . W !!!
"RTN","DG488M",93,0)
 . K DIR
"RTN","DG488M",94,0)
 . S DIR("T")=5
"RTN","DG488M",95,0)
 . W ?15,"screen refreshes automatically every "_DIR("T")_" seconds",!
"RTN","DG488M",96,0)
 . W !!,"Press "_IORVON_"<Enter>"_IORVOFF_" to Stop Monitor...",!
"RTN","DG488M",97,0)
 . S DIR(0)="EA"
"RTN","DG488M",98,0)
 . D ^DIR
"RTN","DG488M",99,0)
 . I '$D(DTOUT) S DGQUIT=1
"RTN","DG488M",100,0)
 . I STAT'="RUNNING" S DGQUIT=1
"RTN","DG488M",101,0)
 W @IOF
"RTN","DG488M",102,0)
 Q
"RTN","DG488M",103,0)
 ;
"RTN","DG488M",104,0)
FMTLINE(DGLINE,DGTB,DGTX) ; format a line
"RTN","DG488M",105,0)
 N DGEND
"RTN","DG488M",106,0)
 S DGLEN=$L(DGTX)
"RTN","DG488M",107,0)
 S DGEND=DGTB+DGLEN-1
"RTN","DG488M",108,0)
 S $E(DGLINE,DGTB,DGEND)=DGTX
"RTN","DG488M",109,0)
 Q DGLINE
"RTN","DG488M",110,0)
 ;
"RTN","DG488M",111,0)
SCRNSET ; setup screen variables
"RTN","DG488M",112,0)
 S:'$D(IOST(0)) IOST(0)="C-VT320"
"RTN","DG488M",113,0)
 S X="IOINORM;IOINHI;IOUON;IOUOFF;IOBON;IOBOFF;IORVON;IORVOFF;IOHOME"
"RTN","DG488M",114,0)
 S X=X_";IOELEOL" D ENDR^%ZISS
"RTN","DG488M",115,0)
 Q
"RTN","DG488M",116,0)
 ;
"RTN","DG488M",117,0)
CLRSCR ; clear screen and return to normal
"RTN","DG488M",118,0)
 W IOHOME,IORVOFF,IOBOFF,IOUOFF,IOINORM,@IOF
"RTN","DG488M",119,0)
 S $X=0,$Y=0
"RTN","DG488M",120,0)
 Q
"RTN","DG488M",121,0)
 ;
"RTN","DG488M",122,0)
MAIL ; mail stats
"RTN","DG488M",123,0)
 N HTEXT,TEXT,NAMSPC,LIN
"RTN","DG488M",124,0)
 S LIN=0
"RTN","DG488M",125,0)
 S NAMSPC=$$NAMSPC^DG488
"RTN","DG488M",126,0)
 K ^TMP(NAMSPC,$J)
"RTN","DG488M",127,0)
 ;get last run data
"RTN","DG488M",128,0)
 D GETLAST^DG488
"RTN","DG488M",129,0)
 ;build text for message
"RTN","DG488M",130,0)
 S HTEXT=ZTDESC_" "_STAT_" on "
"RTN","DG488M",131,0)
 S HTEXT=HTEXT_$$FMTE^XLFDT(STIME)
"RTN","DG488M",132,0)
 D BLDLINE(HTEXT)
"RTN","DG488M",133,0)
 D BLDLINE("Elapsed time: "_$$FMDIFF^XLFDT(STIME,BTIME,3))
"RTN","DG488M",134,0)
 D BLDLINE("")
"RTN","DG488M",135,0)
 I TESTING S TEXT="** TESTING **" D BLDLINE(TEXT)
"RTN","DG488M",136,0)
 D BLDLINE("")
"RTN","DG488M",137,0)
 S TEXT="     Total 408.12 Records Processed: "_$J($FN(DGT12,","),11)
"RTN","DG488M",138,0)
 D BLDLINE(TEXT)
"RTN","DG488M",139,0)
 S TEXT="          408.12 bad records purged: "_$J($FN(DG12,","),11)
"RTN","DG488M",140,0)
 D BLDLINE(TEXT)
"RTN","DG488M",141,0)
 S TEXT="            408.12 bad xrefs purged: "_$J($FN(DG12X,","),11)
"RTN","DG488M",142,0)
 D BLDLINE(TEXT)
"RTN","DG488M",143,0)
 D BLDLINE("")
"RTN","DG488M",144,0)
 S TEXT="     Total 408.21 Records Processed: "_$J($FN(DGT21,","),11)
"RTN","DG488M",145,0)
 D BLDLINE(TEXT)
"RTN","DG488M",146,0)
 S TEXT="          408.21 bad records purged: "_$J($FN(DG21,","),11)
"RTN","DG488M",147,0)
 D BLDLINE(TEXT)
"RTN","DG488M",148,0)
 S TEXT="            408.21 bad xrefs purged: "_$J($FN(DG21X,","),11)
"RTN","DG488M",149,0)
 D BLDLINE(TEXT)
"RTN","DG488M",150,0)
 D BLDLINE("")
"RTN","DG488M",151,0)
 S TEXT="     Total 408.22 Records Processed: "_$J($FN(DGT22,","),11)
"RTN","DG488M",152,0)
 D BLDLINE(TEXT)
"RTN","DG488M",153,0)
 S TEXT="          408.22 bad records purged: "_$J($FN(DG22,","),11)
"RTN","DG488M",154,0)
 D BLDLINE(TEXT)
"RTN","DG488M",155,0)
 S TEXT="            408.22 bad xrefs purged: "_$J($FN(DG22X,","),11)
"RTN","DG488M",156,0)
 D BLDLINE(TEXT)
"RTN","DG488M",157,0)
 ;send the message
"RTN","DG488M",158,0)
 D MAILIT(HTEXT)
"RTN","DG488M",159,0)
 K ^TMP(NAMSPC,$J)
"RTN","DG488M",160,0)
 Q
"RTN","DG488M",161,0)
 ;
"RTN","DG488M",162,0)
BLDLINE(TEXT) ;
"RTN","DG488M",163,0)
 S LIN=LIN+1
"RTN","DG488M",164,0)
 S ^TMP(NAMSPC,$J,"MSG",LIN)=TEXT
"RTN","DG488M",165,0)
 Q
"RTN","DG488M",166,0)
MAILIT(HTEXT) ; send the mail message
"RTN","DG488M",167,0)
 N XMY,XMDUZ,XMSUB,XMTEXT
"RTN","DG488M",168,0)
 S XMY(DUZ)="",XMDUZ=.5
"RTN","DG488M",169,0)
 S XMSUB=HTEXT_" Results"
"RTN","DG488M",170,0)
 S XMTEXT="^TMP(NAMSPC,$J,""MSG"","
"RTN","DG488M",171,0)
 D ^XMD
"RTN","DG488M",172,0)
 Q
"RTN","DG488M",173,0)
 ;
"VER")
8.0^22
**END**
**END**
