EMERGENCY Released PSJ*5*144 SEQ #127
Extracted from mail message
**KIDS**:PSJ*5.0*144^

**INSTALL NAME**
PSJ*5.0*144
"BLD",5293,0)
PSJ*5.0*144^INPATIENT MEDICATIONS^0^3050602^y
"BLD",5293,1,0)
^^12^12^3050602^
"BLD",5293,1,1,0)
 HD0000000086717 - Multiple active Orders Appearing in BCBU
"BLD",5293,1,2,0)
 ----------------------------------------------------------
"BLD",5293,1,3,0)
 A problem has been identified that will cause the BCBU to contain
"BLD",5293,1,4,0)
 multiple active orders for the same order.  This issue happens in the
"BLD",5293,1,5,0)
 PSJ OE (Inpatient Medications) option.  After a pharmacist finishes and
"BLD",5293,1,6,0)
 accepts a complex order, then edits and verifies each order in sequence,
"BLD",5293,1,7,0)
 multiple HL7 records are sent to the BCBU signifying the order has been
"BLD",5293,1,8,0)
 verified.  The BCBU should only receive 1 record signifying the order is
"BLD",5293,1,9,0)
 verified.  This patch will modify this behavior by sending the HL7   
"BLD",5293,1,10,0)
 records as "Pending" until all child orders are verified.  Then a final 
"BLD",5293,1,11,0)
 HL7 transaction will be sent telling the BCBU that the entire order has 
"BLD",5293,1,12,0)
 been verified.
"BLD",5293,4,0)
^9.64PA^^
"BLD",5293,"ABPKG")
n
"BLD",5293,"KRN",0)
^9.67PA^8989.52^19
"BLD",5293,"KRN",.4,0)
.4
"BLD",5293,"KRN",.401,0)
.401
"BLD",5293,"KRN",.402,0)
.402
"BLD",5293,"KRN",.403,0)
.403
"BLD",5293,"KRN",.5,0)
.5
"BLD",5293,"KRN",.84,0)
.84
"BLD",5293,"KRN",3.6,0)
3.6
"BLD",5293,"KRN",3.8,0)
3.8
"BLD",5293,"KRN",9.2,0)
9.2
"BLD",5293,"KRN",9.8,0)
9.8
"BLD",5293,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",5293,"KRN",9.8,"NM",1,0)
PSJHL2^^0^B31715034
"BLD",5293,"KRN",9.8,"NM","B","PSJHL2",1)

"BLD",5293,"KRN",19,0)
19
"BLD",5293,"KRN",19.1,0)
19.1
"BLD",5293,"KRN",101,0)
101
"BLD",5293,"KRN",409.61,0)
409.61
"BLD",5293,"KRN",771,0)
771
"BLD",5293,"KRN",870,0)
870
"BLD",5293,"KRN",8989.51,0)
8989.51
"BLD",5293,"KRN",8989.52,0)
8989.52
"BLD",5293,"KRN",8994,0)
8994
"BLD",5293,"KRN","B",.4,.4)

"BLD",5293,"KRN","B",.401,.401)

"BLD",5293,"KRN","B",.402,.402)

"BLD",5293,"KRN","B",.403,.403)

"BLD",5293,"KRN","B",.5,.5)

"BLD",5293,"KRN","B",.84,.84)

"BLD",5293,"KRN","B",3.6,3.6)

"BLD",5293,"KRN","B",3.8,3.8)

"BLD",5293,"KRN","B",9.2,9.2)

"BLD",5293,"KRN","B",9.8,9.8)

"BLD",5293,"KRN","B",19,19)

"BLD",5293,"KRN","B",19.1,19.1)

"BLD",5293,"KRN","B",101,101)

"BLD",5293,"KRN","B",409.61,409.61)

"BLD",5293,"KRN","B",771,771)

"BLD",5293,"KRN","B",870,870)

"BLD",5293,"KRN","B",8989.51,8989.51)

"BLD",5293,"KRN","B",8989.52,8989.52)

"BLD",5293,"KRN","B",8994,8994)

"BLD",5293,"QUES",0)
^9.62^^
"BLD",5293,"REQB",0)
^9.611^1^1
"BLD",5293,"REQB",1,0)
PSJ*5.0*112^2
"BLD",5293,"REQB","B","PSJ*5.0*112",1)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
144^3050602
"PKG",197,22,1,"PAH",1,1,0)
^^12^12^3050602
"PKG",197,22,1,"PAH",1,1,1,0)
 HD0000000086717 - Multiple active Orders Appearing in BCBU
"PKG",197,22,1,"PAH",1,1,2,0)
 ----------------------------------------------------------
"PKG",197,22,1,"PAH",1,1,3,0)
 A problem has been identified that will cause the BCBU to contain
"PKG",197,22,1,"PAH",1,1,4,0)
 multiple active orders for the same order.  This issue happens in the
"PKG",197,22,1,"PAH",1,1,5,0)
 PSJ OE (Inpatient Medications) option.  After a pharmacist finishes and
"PKG",197,22,1,"PAH",1,1,6,0)
 accepts a complex order, then edits and verifies each order in sequence,
"PKG",197,22,1,"PAH",1,1,7,0)
 multiple HL7 records are sent to the BCBU signifying the order has been
"PKG",197,22,1,"PAH",1,1,8,0)
 verified.  The BCBU should only receive 1 record signifying the order is
"PKG",197,22,1,"PAH",1,1,9,0)
 verified.  This patch will modify this behavior by sending the HL7   
"PKG",197,22,1,"PAH",1,1,10,0)
 records as "Pending" until all child orders are verified.  Then a final 
"PKG",197,22,1,"PAH",1,1,11,0)
 HL7 transaction will be sent telling the BCBU that the entire order has 
"PKG",197,22,1,"PAH",1,1,12,0)
 been verified.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","PSJHL2")
0^1^B31715034
"RTN","PSJHL2",1,0)
PSJHL2 ;BIR/RLW-PATIENT ID AND VISIT SEGMENTS ;22 Nov 1999  9:27 AM
"RTN","PSJHL2",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**1,18,16,23,28,42,50,70,58,100,102,110,111,112,144**;16 DEC 97
"RTN","PSJHL2",3,0)
 ;
"RTN","PSJHL2",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSJHL2",5,0)
 ; Reference to ^ORERR is supported by DBIA# 2187.
"RTN","PSJHL2",6,0)
 ;
"RTN","PSJHL2",7,0)
EN1(PSJHLDFN,PSOC,PSJORDER,PSREASON) ; start here
"RTN","PSJHL2",8,0)
 ; passed in are PSJHLDFN (patient ien)
"RTN","PSJHL2",9,0)
 ;               PSJORDER* (order_file (N,P,V, etc))
"RTN","PSJHL2",10,0)
 ;               PSOC* (order control code - NW for new order, OK to return filler number to OE/RR, OC for order canceled, SC for status change)
"RTN","PSJHL2",11,0)
 ;               PSREASON* (text reason)
"RTN","PSJHL2",12,0)
 ; *=optional, only required if an order segment is also to be generated
"RTN","PSJHL2",13,0)
START ;
"RTN","PSJHL2",14,0)
 K ^TMP("PSJHLS",$J,"PS")
"RTN","PSJHL2",15,0)
 N CLERK,J,LIMIT,NAME,NEXT,NODE1,NODE2,NODE4,NOO,PSJCLEAR,PSJHINST,PSJHLSDT,PROVIDER,PSJI,ROOMBED,RXORDER,STATUS,UNDO,VERIFY,WARD
"RTN","PSJHL2",16,0)
 S RXORDER=PSJORDER,PSJORDER=$S((PSJORDER["N")!(PSJORDER["P"):"^PS(53.1,"_+PSJORDER,PSJORDER["V":"^PS(55,"_PSJHLDFN_",""IV"","_+PSJORDER,1:"^PS(55,"_PSJHLDFN_",5,"_+PSJORDER)_","
"RTN","PSJHL2",17,0)
 I RXORDER["P",$P($G(@(PSJORDER_"0)")),U,15)'=PSJHLDFN S ORDCON="Patient does not match/PSJHL2" S X="ORERR" X ^%ZOSF("TEST") I  D EN^ORERR(ORDCON) Q
"RTN","PSJHL2",18,0)
 S UNDO=$S("OC^CR"[PSOC:1,1:0)
"RTN","PSJHL2",19,0)
 D INIT,PID,PV1,ORC
"RTN","PSJHL2",20,0)
 D @$S("SN^SC^OC^OD^DR^CR^OH^OR^XX^ZC^XR"[PSOC:"EN1^PSJHL3(PSJHLDFN,PSOC,PSJORDER)",1:"CALL^PSJHLU(PSJI)")
"RTN","PSJHL2",21,0)
 I UNDO D UNDO
"RTN","PSJHL2",22,0)
 K ^TMP("PSJHLS",$J,"PS"),FIELD
"RTN","PSJHL2",23,0)
 Q
"RTN","PSJHL2",24,0)
 ;
"RTN","PSJHL2",25,0)
INIT ; initialize HL7 variables, set master file identification segment
"RTN","PSJHL2",26,0)
 ; PSJHLMTN = message type - ORR for messages sent as a response to an OE/RR event; ORM for "unsolicited" messages.
"RTN","PSJHL2",27,0)
 S PSJI=0,PSJHLMTN=$S($G(PSJHLMTN)]"":PSJHLMTN,1:"ORM")
"RTN","PSJHL2",28,0)
 D INIT^PSJHLU
"RTN","PSJHL2",29,0)
 S LIMIT=17 X PSJCLEAR
"RTN","PSJHL2",30,0)
 S FIELD(0)="MSH",FIELD(1)="^~\&",FIELD(2)="PHARMACY",FIELD(3)=$G(PSJHINST),FIELD(8)=PSJHLMTN
"RTN","PSJHL2",31,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY
"RTN","PSJHL2",32,0)
 Q
"RTN","PSJHL2",33,0)
 ;
"RTN","PSJHL2",34,0)
PID ; get patient data, format PID SEGMENT
"RTN","PSJHL2",35,0)
 S LIMIT=22 X PSJCLEAR
"RTN","PSJHL2",36,0)
 S FIELD(0)="PID"
"RTN","PSJHL2",37,0)
 S FIELD(3)=PSJHLDFN
"RTN","PSJHL2",38,0)
 N DFN S DFN=PSJHLDFN D DEM^VADPT S FIELD(5)=VADM(1)
"RTN","PSJHL2",39,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY
"RTN","PSJHL2",40,0)
 Q
"RTN","PSJHL2",41,0)
 ;
"RTN","PSJHL2",42,0)
PV1 ; get patient visit information, format PV1 segment
"RTN","PSJHL2",43,0)
 N PSJAPPT
"RTN","PSJHL2",44,0)
 S LIMIT=50 X PSJCLEAR
"RTN","PSJHL2",45,0)
 S FIELD(0)="PV1"
"RTN","PSJHL2",46,0)
 I PSJHLMTN="ORR" S FIELD(3)=LOC
"RTN","PSJHL2",47,0)
 I PSJHLMTN="ORM" D
"RTN","PSJHL2",48,0)
 .S LOC="",WARD=$G(^DPT(PSJHLDFN,.1)),LOC=$S($G(WARD)]"":$O(^SC("B",WARD,LOC)),1:LOC)
"RTN","PSJHL2",49,0)
 .I $G(LOC)="" D
"RTN","PSJHL2",50,0)
 .. N A
"RTN","PSJHL2",51,0)
 .. I RXORDER["P",($G(^PS(53.1,+RXORDER,"DSS"))) S A=^("DSS"),LOC=$P(A,"^"),PSJAPPT=$P(A,"^",2)
"RTN","PSJHL2",52,0)
 .. I RXORDER["V",($G(^PS(55,PSJHLDFN,"IV",+RXORDER,"DSS"))) S A=^("DSS"),LOC=$P(A,"^"),PSJAPPT=$P(A,"^",2)
"RTN","PSJHL2",53,0)
 .. I RXORDER["U",$G(^PS(55,PSJHLDFN,5,+RXORDER,8)) S A=^(8),LOC=$P(A,"^"),PSJAPPT=$P(A,"^",2)
"RTN","PSJHL2",54,0)
 .I $G(LOC)]"" S ROOMBED=$G(^DPT(PSJHLDFN,.101)),LOC=LOC_"^"_ROOMBED
"RTN","PSJHL2",55,0)
 .S FIELD(3)=LOC I $G(PSJAPPT)]"" S FIELD(44)=$$FMTHL7^XLFDT(PSJAPPT)
"RTN","PSJHL2",56,0)
 S FIELD(2)=$S($G(CLASS)="O":CLASS,1:"I")
"RTN","PSJHL2",57,0)
 I FIELD(2)="I" N DFN S DFN=PSJHLDFN D INP^VADPT S FIELD(19)=VAIN(1)
"RTN","PSJHL2",58,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY
"RTN","PSJHL2",59,0)
 Q
"RTN","PSJHL2",60,0)
 ;
"RTN","PSJHL2",61,0)
ORC ; order control segment
"RTN","PSJHL2",62,0)
 S LIMIT=18 X PSJCLEAR
"RTN","PSJHL2",63,0)
 Q:'$D(PSJORDER)!'$D(PSOC)
"RTN","PSJHL2",64,0)
 S NODE1=$G(@(PSJORDER_"0)")),NODE2=$G(@(PSJORDER_"2)"))
"RTN","PSJHL2",65,0)
 S NODE4=$G(@(PSJORDER_"4)"))
"RTN","PSJHL2",66,0)
 S FIELD(0)="ORC"
"RTN","PSJHL2",67,0)
 S FIELD(1)=PSOC
"RTN","PSJHL2",68,0)
 S FIELD(2)=$S(PSOC="SN":"",1:$P(NODE1,"^",21))_"^OR" I $P(FIELD(2),"^")=0 S $P(FIELD(2),"^")="" ; IV orders are created with a zero in the oerr order number, for some reason
"RTN","PSJHL2",69,0)
 S FIELD(3)=RXORDER_"^PS"
"RTN","PSJHL2",70,0)
 ; translate Pharmacy status code to HL7 status code, set in FIELD(5)
"RTN","PSJHL2",71,0)
 S STATUS=$S($G(PSJEXPOE):"E",(($P(NODE1,"^",17)]"")&(RXORDER["V")):($P(NODE1,"^",17)),($P(NODE1,"^",9)]""):$P(NODE1,"^",9),$G(PSIVCOPY):"DE",1:"")
"RTN","PSJHL2",72,0)
 ;BHW;Remedy HD0000000086717;If the order has a pending number, send pending status even if current status is Active.
"RTN","PSJHL2",73,0)
 I STATUS="A",RXORDER["P" S STATUS="N" D @STATUS S STATUS="A"
"RTN","PSJHL2",74,0)
 E  D @STATUS
"RTN","PSJHL2",75,0)
 I STATUS="U",RXORDER["P" S FIELD(3)="^PS"
"RTN","PSJHL2",76,0)
 S FIELD(9)=$S(RXORDER["V":$$FMTHL7^XLFDT($P(NODE2,"^")),1:$$FMTHL7^XLFDT($P(NODE1,"^",16)))
"RTN","PSJHL2",77,0)
 S CLERK=$S(RXORDER["V":$P(NODE2,"^",11),1:$P(NODE4,"^",7))
"RTN","PSJHL2",78,0)
 S NAME=$P($G(^VA(200,+CLERK,0)),"^")
"RTN","PSJHL2",79,0)
 S FIELD(10)=CLERK_"^"_NAME
"RTN","PSJHL2",80,0)
 I PSOC="ZV"!($G(PSJBCBU)) S VERIFY=$P($G(NODE4),"^"),FIELD(11)=VERIFY_"^"_$P($G(^VA(200,+VERIFY,0)),"^"),FIELD(9)=$$FMTHL7^XLFDT($P(NODE4,"^",2))
"RTN","PSJHL2",81,0)
 S PROVIDER=$S($G(PSJDCPRV)]"":$G(PSJDCPRV),RXORDER["V":$P(NODE1,"^",6),1:$P(NODE1,"^",2)) K PSJDCPRV
"RTN","PSJHL2",82,0)
 S NAME=$P($G(^VA(200,+PROVIDER,0)),"^")
"RTN","PSJHL2",83,0)
 S FIELD(12)=PROVIDER_"^"_NAME
"RTN","PSJHL2",84,0)
 S FIELD(15)=$S(RXORDER["V":$$FMTHL7^XLFDT($P(NODE1,"^",2)),1:$$FMTHL7^XLFDT($P(NODE2,"^",2)))
"RTN","PSJHL2",85,0)
 I $S(RXORDER["V":$P(NODE2,"^",8)="R",1:$P(NODE1,"^",24)="R")
"RTN","PSJHL2",86,0)
 N FIELD9 S FIELD9=$$FMTHL7^XLFDT($$LASTREN^PSJLMPRI(PSJHLDFN,RXORDER)) I FIELD9>FIELD(9) S FIELD(9)=FIELD9,FIELD(15)=FIELD9
"RTN","PSJHL2",87,0)
 S NOO=$S(PSJORDER["IV":$G(P("NAT")),(($G(PSJNOO)="")&($G(P("NAT"))]"")):$G(P("NAT")),1:$G(PSJNOO)),PSREASON=$S(NOO="D":"",1:$G(PSREASON))
"RTN","PSJHL2",88,0)
 S FIELD(16)=NOO_U_$S(NOO="P":"Telephoned",NOO="D":"Duplicate",NOO="X":"Rejected",NOO="A":"Auto",NOO="S":"Service Correction",NOO="W":"Written",NOO="V":"Verbal",NOO="E":"Physician Entered",NOO="I":"Policy",1:"")_U_"99ORN"_U_U_$G(PSREASON)_U
"RTN","PSJHL2",89,0)
 D SEGMENT^PSJHLU(LIMIT),DISPLAY
"RTN","PSJHL2",90,0)
 Q
"RTN","PSJHL2",91,0)
 ;
"RTN","PSJHL2",92,0)
DISPLAY ; just for testing
"RTN","PSJHL2",93,0)
 I $G(MSGTEST) W ! F NEXT=0:1:LIMIT W FIELD(NEXT)_"|"
"RTN","PSJHL2",94,0)
 Q
"RTN","PSJHL2",95,0)
UNDO ;Undo Renew if Pending Renewal is dc'd
"RTN","PSJHL2",96,0)
 I RXORDER["P",(STATUS="D"),($G(PSJNOO)'="A"),($P(NODE1,U,24)="R") D ENBKOUT^PSJOREN(PSJHLDFN,RXORDER)
"RTN","PSJHL2",97,0)
 Q
"RTN","PSJHL2",98,0)
 ;
"RTN","PSJHL2",99,0)
A S FIELD(5)="CM" Q  ; active
"RTN","PSJHL2",100,0)
D S FIELD(5)="DC" Q  ; discontinued
"RTN","PSJHL2",101,0)
I S FIELD(5)="IP" Q  ; incomplete
"RTN","PSJHL2",102,0)
N S FIELD(5)="IP" Q  ; non-verified
"RTN","PSJHL2",103,0)
U S FIELD(5)="ZX" Q  ; unreleased
"RTN","PSJHL2",104,0)
P S FIELD(5)="IP" Q  ; pending
"RTN","PSJHL2",105,0)
DE S FIELD(5)="RP" Q  ; discontinued (edit)
"RTN","PSJHL2",106,0)
E S FIELD(5)="ZE" Q  ; expired
"RTN","PSJHL2",107,0)
H S FIELD(5)="HD" Q  ; hold
"RTN","PSJHL2",108,0)
R S FIELD(5)="ZZ" Q  ; renewed
"RTN","PSJHL2",109,0)
RE S FIELD(5)="CM" Q  ; reinstated
"RTN","PSJHL2",110,0)
DR S FIELD(5)="DC" Q  ; discontinued (renewal)
"RTN","PSJHL2",111,0)
O S FIELD(5)="HD" Q  ; on call (is this kind of like HOLD?)
"VER")
8.0^22.0
"BLD",5293,6)
^SEQ #127
**END**
**END**
