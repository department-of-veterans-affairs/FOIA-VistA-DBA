Released TIU*1*144 SEQ #145
Extracted from mail message
**KIDS**:TIU*1.0*144^

**INSTALL NAME**
TIU*1.0*144
"BLD",4012,0)
TIU*1.0*144^TEXT INTEGRATION UTILITIES^0^3030306^y
"BLD",4012,1,0)
^^2^2^3021106^
"BLD",4012,1,1,0)
The description of this build can be found in the National Patch Module, 
"BLD",4012,1,2,0)
under patch TIU*1*144.
"BLD",4012,4,0)
^9.64PA^^
"BLD",4012,"KRN",0)
^9.67PA^8989.52^19
"BLD",4012,"KRN",.4,0)
.4
"BLD",4012,"KRN",.401,0)
.401
"BLD",4012,"KRN",.402,0)
.402
"BLD",4012,"KRN",.403,0)
.403
"BLD",4012,"KRN",.5,0)
.5
"BLD",4012,"KRN",.84,0)
.84
"BLD",4012,"KRN",3.6,0)
3.6
"BLD",4012,"KRN",3.8,0)
3.8
"BLD",4012,"KRN",9.2,0)
9.2
"BLD",4012,"KRN",9.8,0)
9.8
"BLD",4012,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",4012,"KRN",9.8,"NM",1,0)
TIU144^^0^B59693485
"BLD",4012,"KRN",9.8,"NM",2,0)
TIU131^^1^
"BLD",4012,"KRN",9.8,"NM",3,0)
TIUCNSLT^^0^B22334690
"BLD",4012,"KRN",9.8,"NM","B","TIU131",2)

"BLD",4012,"KRN",9.8,"NM","B","TIU144",1)

"BLD",4012,"KRN",9.8,"NM","B","TIUCNSLT",3)

"BLD",4012,"KRN",19,0)
19
"BLD",4012,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",4012,"KRN",19,"NM",1,0)
TIU144 ENHANCED MISMATCH LIST^^0
"BLD",4012,"KRN",19,"NM",2,0)
TIU131 LIST CONSULT MISMATCHES^^1^
"BLD",4012,"KRN",19,"NM","B","TIU131 LIST CONSULT MISMATCHES",2)

"BLD",4012,"KRN",19,"NM","B","TIU144 ENHANCED MISMATCH LIST",1)

"BLD",4012,"KRN",19.1,0)
19.1
"BLD",4012,"KRN",101,0)
101
"BLD",4012,"KRN",409.61,0)
409.61
"BLD",4012,"KRN",771,0)
771
"BLD",4012,"KRN",870,0)
870
"BLD",4012,"KRN",8989.51,0)
8989.51
"BLD",4012,"KRN",8989.52,0)
8989.52
"BLD",4012,"KRN",8994,0)
8994
"BLD",4012,"KRN","B",.4,.4)

"BLD",4012,"KRN","B",.401,.401)

"BLD",4012,"KRN","B",.402,.402)

"BLD",4012,"KRN","B",.403,.403)

"BLD",4012,"KRN","B",.5,.5)

"BLD",4012,"KRN","B",.84,.84)

"BLD",4012,"KRN","B",3.6,3.6)

"BLD",4012,"KRN","B",3.8,3.8)

"BLD",4012,"KRN","B",9.2,9.2)

"BLD",4012,"KRN","B",9.8,9.8)

"BLD",4012,"KRN","B",19,19)

"BLD",4012,"KRN","B",19.1,19.1)

"BLD",4012,"KRN","B",101,101)

"BLD",4012,"KRN","B",409.61,409.61)

"BLD",4012,"KRN","B",771,771)

"BLD",4012,"KRN","B",870,870)

"BLD",4012,"KRN","B",8989.51,8989.51)

"BLD",4012,"KRN","B",8989.52,8989.52)

"BLD",4012,"KRN","B",8994,8994)

"BLD",4012,"QUES",0)
^9.62^^
"BLD",4012,"REQB",0)
^9.611^2^2
"BLD",4012,"REQB",1,0)
TIU*1.0*131^2
"BLD",4012,"REQB",2,0)
TIU*1.0*142^2
"BLD",4012,"REQB","B","TIU*1.0*131",1)

"BLD",4012,"REQB","B","TIU*1.0*142",2)

"KRN",19,9060,-1)
0^1
"KRN",19,9060,0)
TIU144 ENHANCED MISMATCH LIST^Enhanced Mismatched Consults List^^A^^^^^^^n^TEXT INTEGRATION UTILITIES^^1
"KRN",19,9060,1,0)
^^11^11^3021106^
"KRN",19,9060,1,1,0)
Option sent out with TIU*1*144.  Option lists TIU Consult documents whose
"KRN",19,9060,1,2,0)
patient does not match the patient of the associated Consult Request.
"KRN",19,9060,1,3,0)
Such documents should either be relinked to the appropriate request or
"KRN",19,9060,1,4,0)
reassigned to the correct patient.
"KRN",19,9060,1,5,0)
 
"KRN",19,9060,1,6,0)
Option can be rerun if necessary, to check that all mismatches have been
"KRN",19,9060,1,7,0)
corrected.
"KRN",19,9060,1,8,0)
 
"KRN",19,9060,1,9,0)
Option is similar to option provided in patch 131, but display contains 
"KRN",19,9060,1,10,0)
more information, making it easier to reassign a document to the correct 
"KRN",19,9060,1,11,0)
patient, if necessary.
"KRN",19,9060,20)
D BEGIN^TIU144
"KRN",19,9060,99)
58903,48422
"KRN",19,9060,"U")
ENHANCED MISMATCHED CONSULTS L
"KRN",19,9142,-1)
1^2
"KRN",19,9142,0)
TIU131 LIST CONSULT MISMATCHES
"MBREQ")
0
"ORD",0,9.8)
9.8;;1;RTNF^XPDTA;RTNE^XPDTA
"ORD",0,9.8,0)
ROUTINE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",193,-1)
1^1
"PKG",193,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",193,20,0)
^9.402P^^
"PKG",193,22,0)
^9.49I^1^1
"PKG",193,22,1,0)
1.0^3010321^3010321^11
"PKG",193,22,1,"PAH",1,0)
144^3030306
"PKG",193,22,1,"PAH",1,1,0)
^^2^2^3030306
"PKG",193,22,1,"PAH",1,1,1,0)
The description of this build can be found in the National Patch Module, 
"PKG",193,22,1,"PAH",1,1,2,0)
under patch TIU*1*144.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","TIU131")
1^2
"RTN","TIU144")
0^1^B59693485
"RTN","TIU144",1,0)
TIU144 ; SLC/MAM -  Consults with Mismatched Patients ;3/6/03
"RTN","TIU144",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**144**;Jun 20, 1997
"RTN","TIU144",3,0)
 ; External References
"RTN","TIU144",4,0)
 ;   DBIA 3983  ^GMR(123
"RTN","TIU144",5,0)
 ;   DBIA 3472  $$CPPAT^GMRCCP
"RTN","TIU144",6,0)
BEGIN ; List mismatched Consults
"RTN","TIU144",7,0)
 W !!,"Searching for mismatched Consults could take some time.  Please"
"RTN","TIU144",8,0)
 W !,"remember to queue this option."
"RTN","TIU144",9,0)
 W ! K IOP S %ZIS="Q" D ^%ZIS I POP K POP Q
"RTN","TIU144",10,0)
 I $D(IO("Q")) K IO("Q") D  Q
"RTN","TIU144",11,0)
 .S ZTRTN="BUILD^TIU144",ZTSAVE("DUZ")=""
"RTN","TIU144",12,0)
 .S ZTDESC="TIU Mismatched Consults List - TIU*1*144"
"RTN","TIU144",13,0)
 .D ^%ZTLOAD W !,$S($D(ZTSK):"Request Queued!",1:"Request Canceled!")
"RTN","TIU144",14,0)
 .K ZTSK,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","TIU144",15,0)
 .D HOME^%ZIS
"RTN","TIU144",16,0)
 U IO D BUILD,^%ZISC
"RTN","TIU144",17,0)
 Q
"RTN","TIU144",18,0)
 ;
"RTN","TIU144",19,0)
BUILD ; Build array of mismatched Consults
"RTN","TIU144",20,0)
 N TIUCVPTR,TIUDA,TIUCNT,CNSLTCLS,NUMFOUND,NUMCHEKD
"RTN","TIU144",21,0)
 I $E(IOST)="C" W !!,"Searching for Consult documents with mismatched patients...",!
"RTN","TIU144",22,0)
 S CNSLTCLS=$$CLASS^TIUCNSLT()
"RTN","TIU144",23,0)
 S TIUCVPTR="",NUMCHEKD=0
"RTN","TIU144",24,0)
 F  S TIUCVPTR=$O(^TIU(8925,"G",TIUCVPTR)) Q:TIUCVPTR=""  D
"RTN","TIU144",25,0)
 . ; -- If Requesting Pkg IEN is 0 or -1, exclude document:
"RTN","TIU144",26,0)
 . Q:TIUCVPTR'>0
"RTN","TIU144",27,0)
 . ; -- If Req Pkg has file but it's not GMR(123, exclude document:
"RTN","TIU144",28,0)
 . I $P(TIUCVPTR,";",2)]"",$P(TIUCVPTR,";",2)'="GMR(123," Q
"RTN","TIU144",29,0)
 . S TIUDA=0
"RTN","TIU144",30,0)
 . F  S TIUDA=+$O(^TIU(8925,"G",TIUCVPTR,TIUDA)) Q:'TIUDA  D
"RTN","TIU144",31,0)
 . . N DFN,TIUCNNBR,OK,TIUD0,TIUD13,DOC,TIUDAD,TIUDAD0,TITLDA,CAPTURE
"RTN","TIU144",32,0)
 . . N PT,EDT,STATX,CNSLTPT,CNSLTEDT,TOSERV,CNSLTST,TIUMATCH,LOC,TIUD12
"RTN","TIU144",33,0)
 . . N DIC,DR,DA,DIQ,DIV,EXTRA,CNSLT1,CNSLT2
"RTN","TIU144",34,0)
 . . S TIUD0=$G(^TIU(8925,TIUDA,0)),DFN=+$P(TIUD0,U,2)
"RTN","TIU144",35,0)
 . . S TITLDA=+TIUD0,NUMCHEKD=NUMCHEKD+1
"RTN","TIU144",36,0)
 . . ; --If Req Pkg lacks file, & docmt is not a Consult, exclude docmt:
"RTN","TIU144",37,0)
 . . I $P(TIUCVPTR,";",2)="",'$$ISA^TIULX(TITLDA,CNSLTCLS) Q
"RTN","TIU144",38,0)
 . . S STATX=$P($G(^TIU(8925.6,+$P(TIUD0,U,5),0)),U)
"RTN","TIU144",39,0)
 . . Q:STATX="RETRACTED"
"RTN","TIU144",40,0)
 . . Q:STATX="DELETED"
"RTN","TIU144",41,0)
 . . S TIUCNNBR=+$P(TIUCVPTR,";")
"RTN","TIU144",42,0)
 . . S OK=$$CPPAT^GMRCCP(TIUCNNBR,DFN)
"RTN","TIU144",43,0)
 . . Q:OK>0
"RTN","TIU144",44,0)
 . . ; --If docmt is not a Consult, exclude docmt:
"RTN","TIU144",45,0)
 . . I TITLDA'=81,'$$ISA^TIULX(TITLDA,CNSLTCLS) Q
"RTN","TIU144",46,0)
 . . I TITLDA=81 S TIUDAD=+$P(TIUD0,U,6),TIUDAD0=$G(^TIU(8925,TIUDAD,0)) I '$$ISA^TIULX(+TIUDAD0,CNSLTCLS) Q
"RTN","TIU144",47,0)
 . . S TIUD13=$G(^TIU(8925,TIUDA,13))
"RTN","TIU144",48,0)
 . . S CAPTURE=$P(TIUD13,U,3)
"RTN","TIU144",49,0)
 . . S DOC=$E($$PNAME^TIULC1(+TIUD0),1,39)
"RTN","TIU144",50,0)
 . . S PT=$$PATIENT(DFN)
"RTN","TIU144",51,0)
 . . S EDT=$$DATE^TIULS($P(TIUD13,U),"MM/DD/YY")
"RTN","TIU144",52,0)
 . . S TIUD12=$G(^TIU(8925,TIUDA,12))
"RTN","TIU144",53,0)
 . . S LOC=+$P(TIUD12,U,5)
"RTN","TIU144",54,0)
 . . S DIV=+$P($G(^SC(LOC,0)),U,4)
"RTN","TIU144",55,0)
 . . S DIC="^GMR(123,",DR=".02;1;3;8"
"RTN","TIU144",56,0)
 . . S DA=TIUCNNBR,DIQ(0)="IE",DIQ="TIUMATCH"
"RTN","TIU144",57,0)
 . . D EN^DIQ1
"RTN","TIU144",58,0)
 . . S CNSLTPT=+$G(TIUMATCH(123,DA,.02,"I"))
"RTN","TIU144",59,0)
 . . S CNSLTEDT=$G(TIUMATCH(123,DA,3,"I")),CNSLTEDT=$$DATE^TIULS(CNSLTEDT,"MM/DD/YY")
"RTN","TIU144",60,0)
 . . S TOSERV=$E($G(TIUMATCH(123,DA,1,"E")),1,40)
"RTN","TIU144",61,0)
 . . S CNSLTPT=$$PATIENT(CNSLTPT)
"RTN","TIU144",62,0)
 . . S CNSLTST=$G(TIUMATCH(123,DA,8,"E"))
"RTN","TIU144",63,0)
 . . S CNSLTST=$S(CNSLTST="DISCONTINUED":"(dc)",1:"")
"RTN","TIU144",64,0)
 . . S TIUCNT=+$G(TIUCNT)+1
"RTN","TIU144",65,0)
 . . S ^TMP("TIU144",$J,DIV,TITLDA,TIUCNT,"DOCMT")=DOC_U_TIUDA_U_PT_U_EDT_U_CAPTURE_U_STATX
"RTN","TIU144",66,0)
 . . S ^TMP("TIU144",$J,DIV,TITLDA,TIUCNT,"CNSLT")=TOSERV_U_TIUCNNBR_U_CNSLTPT_U_CNSLTEDT_U_CNSLTST
"RTN","TIU144",67,0)
 . . ; -- Add lines about parent if docmt is addendum:
"RTN","TIU144",68,0)
 . . I TITLDA=81 D
"RTN","TIU144",69,0)
 . . . N DADDFN,TIUDAD13,DADDOC,DADPT,DADEDT,DADSTATX
"RTN","TIU144",70,0)
 . . . S DADDFN=$P(TIUDAD0,U,2) Q:'DADDFN
"RTN","TIU144",71,0)
 . . . S DADSTATX=$P($G(^TIU(8925.6,+$P(TIUDAD0,U,5),0)),U)
"RTN","TIU144",72,0)
 . . . S TIUDAD13=$G(^TIU(8925,TIUDAD,13))
"RTN","TIU144",73,0)
 . . . S DADDOC=$E($$PNAME^TIULC1(+TIUDAD0),1,40)
"RTN","TIU144",74,0)
 . . . S DADPT=$$PATIENT(DADDFN)
"RTN","TIU144",75,0)
 . . . S DADEDT=$$DATE^TIULS($P(TIUDAD13,U),"MM/DD/YY")
"RTN","TIU144",76,0)
 . . . S ^TMP("TIU144",$J,DIV,TITLDA,TIUCNT,"DADDOCMT")=DADDOC_U_TIUDAD_U_DADPT_U_DADEDT_U_DADSTATX
"RTN","TIU144",77,0)
 . . Q:TIUCNNBR'>0
"RTN","TIU144",78,0)
 . . S EXTRA=0
"RTN","TIU144",79,0)
 . . S CNSLT1=+$O(^GMR(123,"R",TIUDA_";TIU(8925,",0))
"RTN","TIU144",80,0)
 . . Q:CNSLT1'>0
"RTN","TIU144",81,0)
 . . I CNSLT1'=TIUCNNBR S EXTRA=CNSLT1
"RTN","TIU144",82,0)
 . . I 'EXTRA S CNSLT2=+$O(^GMR(123,"R",TIUDA_";TIU(8925,",CNSLT1))
"RTN","TIU144",83,0)
 . . I $G(CNSLT2)>0,CNSLT2'=TIUCNNBR S EXTRA=CNSLT2
"RTN","TIU144",84,0)
 . . I +EXTRA S ^TMP("TIU144",$J,DIV,TITLDA,TIUCNT,"EXTRA")=EXTRA
"RTN","TIU144",85,0)
 S NUMFOUND=+$G(TIUCNT)
"RTN","TIU144",86,0)
 D PRINT(NUMCHEKD,NUMFOUND)
"RTN","TIU144",87,0)
 K ^TMP("TIU144",$J)
"RTN","TIU144",88,0)
 Q
"RTN","TIU144",89,0)
 ;
"RTN","TIU144",90,0)
PATIENT(PTDA) ; Return Patient Name & last 4 of SSN
"RTN","TIU144",91,0)
 ; Receives Patient file IEN
"RTN","TIU144",92,0)
 N PT,LASTI,LAST4
"RTN","TIU144",93,0)
 S PT=$$NAME^TIULS($$PTNAME^TIULC1(+PTDA),"LAST,FI MI")
"RTN","TIU144",94,0)
 S LASTI=$E(PT)
"RTN","TIU144",95,0)
 S LAST4=$E($P($G(^DPT(+PTDA,0)),U,9),6,9)
"RTN","TIU144",96,0)
 S LAST4="("_LASTI_LAST4_")"
"RTN","TIU144",97,0)
 S PT=PT_" "_LAST4
"RTN","TIU144",98,0)
 Q PT
"RTN","TIU144",99,0)
PRINT(CHEKD,FOUND) ; Print
"RTN","TIU144",100,0)
 N TIUCNT,TIUCONT,DOCDATA,DADDATA,CNDATA,TITLDA,DIV,EXTDIV,MISMNUM
"RTN","TIU144",101,0)
 I $D(ZTQUEUED) S ZTREQ="@" ; Tell TaskMan to delete Task log entry
"RTN","TIU144",102,0)
 I $E(IOST)="C" W @IOF,!
"RTN","TIU144",103,0)
 W "             Consult Documents with Mismatched Patients"
"RTN","TIU144",104,0)
 W !!,"        ",CHEKD," documents processed"
"RTN","TIU144",105,0)
 I 'FOUND W !,"        No mismatches found" G PRINTX
"RTN","TIU144",106,0)
 W !,"        ",FOUND," mismatched documents found"
"RTN","TIU144",107,0)
 W !!," In listed mismatches, the patient for the request associated with the"
"RTN","TIU144",108,0)
 W !,"document does not match the patient for the document. See the description for"
"RTN","TIU144",109,0)
 W !,"patch TIU*1*144 in the National Patch Module for further explanation of this"
"RTN","TIU144",110,0)
 W !,"display and for instructions on how to correct listed entries.",!!
"RTN","TIU144",111,0)
 ;W " In addition to patient mismatches, this list may contain some Consult Results",!,"which are not linked to any request.",!!
"RTN","TIU144",112,0)
 S DIV="",TIUCONT=1,MISMNUM=0
"RTN","TIU144",113,0)
 F  S DIV=$O(^TMP("TIU144",$J,DIV)) Q:DIV=""  D  Q:'TIUCONT
"RTN","TIU144",114,0)
 . I DIV'=$O(^TMP("TIU144",$J,"")) D  Q:'TIUCONT
"RTN","TIU144",115,0)
 . . I $E(IOST)="C" W !! S TIUCONT=$$STOP Q
"RTN","TIU144",116,0)
 . . W @IOF
"RTN","TIU144",117,0)
 . S EXTDIV=$$EXTERNAL^DILFD(44,3,"",DIV)
"RTN","TIU144",118,0)
 . I EXTDIV']"" S EXTDIV="UNKNOWN"
"RTN","TIU144",119,0)
 . W "===============================================================================",!
"RTN","TIU144",120,0)
 . W "        Division: ",EXTDIV
"RTN","TIU144",121,0)
 . W !,"==============================================================================="
"RTN","TIU144",122,0)
 . S TITLDA=""
"RTN","TIU144",123,0)
 . F  S TITLDA=$O(^TMP("TIU144",$J,DIV,TITLDA)) Q:TITLDA=""  D  Q:'TIUCONT
"RTN","TIU144",124,0)
 . . S TIUCNT=""
"RTN","TIU144",125,0)
 . . F  S TIUCNT=$O(^TMP("TIU144",$J,DIV,TITLDA,TIUCNT)) Q:TIUCNT=""  D  Q:'TIUCONT
"RTN","TIU144",126,0)
 . . . W !!
"RTN","TIU144",127,0)
 . . . S TIUCONT=$$SETCONT Q:'TIUCONT
"RTN","TIU144",128,0)
 . . . S DOCDATA=^TMP("TIU144",$J,DIV,TITLDA,TIUCNT,"DOCMT")
"RTN","TIU144",129,0)
 . . . S MISMNUM=MISMNUM+1
"RTN","TIU144",130,0)
 . . . W ?2,MISMNUM,".",?7,"Note Title: ",$P(DOCDATA,U),?59,"#: ",$P(DOCDATA,U,2),?72,"Capt: ",$P(DOCDATA,U,5)
"RTN","TIU144",131,0)
 . . . W !,?2,"Pt: ",$P(DOCDATA,U,3),?59,"Rf Date: ",$P(DOCDATA,U,4)
"RTN","TIU144",132,0)
 . . . S CNDATA=^TMP("TIU144",$J,DIV,TITLDA,TIUCNT,"CNSLT")
"RTN","TIU144",133,0)
 . . . W !,?2,"Cnslt To Serv: ",$P(CNDATA,U),?59,"Cnslt #: ",$P(CNDATA,U,2),?75,$P(CNDATA,U,5)
"RTN","TIU144",134,0)
 . . . W !,?2,"Pt: ",$P(CNDATA,U,3),?59,"Date: ",$P(CNDATA,U,4)
"RTN","TIU144",135,0)
 . . . S DADDATA=$G(^TMP("TIU144",$J,DIV,TITLDA,TIUCNT,"DADDOCMT"))
"RTN","TIU144",136,0)
 . . . I DADDATA]"" D
"RTN","TIU144",137,0)
 . . . . W !,?2,"Parent Title: ",$P(DADDATA,U),?59,"#: ",$P(DADDATA,U,2)
"RTN","TIU144",138,0)
 . . . . W !,?2,"Rf Date: ",$P(DADDATA,U,4)
"RTN","TIU144",139,0)
 . . . I $D(^TMP("TIU144",$J,DIV,TITLDA,TIUCNT,"EXTRA")) W !,?2,"Consult # ",^TMP("TIU144",$J,DIV,TITLDA,TIUCNT,"EXTRA")," is ALSO linked to this document on the Consults side."
"RTN","TIU144",140,0)
PRINTX I $G(TIUCONT) W !! S TIUCONT=$$SETCONT W ?5,"================ ",FOUND," Mismatches Found."," ================="
"RTN","TIU144",141,0)
 D MAIL(CHEKD,FOUND)
"RTN","TIU144",142,0)
 Q
"RTN","TIU144",143,0)
MAIL(CHEKD,FOUND) ; Send msg to person who ran option & Pt Safety Committee
"RTN","TIU144",144,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,XMMG,TIUTXT
"RTN","TIU144",145,0)
 S XMDUZ="PATCH TIU*1*144 MISMATCHED CONSULTS SEARCH OPTION"
"RTN","TIU144",146,0)
 S:$G(DUZ) XMY(DUZ)=""
"RTN","TIU144",147,0)
 S XMY("G.PATIENT SAFETY NOTIFICATIONS")="",XMY(.5)=""
"RTN","TIU144",148,0)
 S TIUTXT(1)="TIU Consult Documents Linked to Different Patient's Request"
"RTN","TIU144",149,0)
 S TIUTXT(2)=""
"RTN","TIU144",150,0)
 S TIUTXT(3)="Search completed successfully on "_$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","TIU144",151,0)
 S TIUTXT(4)="Number of TIU documents processed: "_CHEKD
"RTN","TIU144",152,0)
 S TIUTXT(5)="Number of mismatched documents found: "_FOUND
"RTN","TIU144",153,0)
 S TIUTXT(6)=""
"RTN","TIU144",154,0)
 S TIUTXT(7)="These documents should be cleaned up manually, using TIU Document Management"
"RTN","TIU144",155,0)
 S TIUTXT(8)="options.  For more information, see patch TIU*1*144 in the National Patch"
"RTN","TIU144",156,0)
 S TIUTXT(9)="Module on FORUM, or contact "_$S($G(DUZ):$P(^VA(200,DUZ,0),"^"),1:"IRM")_"."
"RTN","TIU144",157,0)
 S XMTEXT="TIUTXT(",XMSUB="TIU*1*144 Mismatched TIU Consult Documents"
"RTN","TIU144",158,0)
 D ^XMD
"RTN","TIU144",159,0)
 Q
"RTN","TIU144",160,0)
STOP() ;on screen paging check
"RTN","TIU144",161,0)
 ; quits TIUCONT=1 if cont. ELSE quits TIUCONT=0
"RTN","TIU144",162,0)
 N DIR,Y,TIUCONT
"RTN","TIU144",163,0)
 S DIR(0)="E" D ^DIR
"RTN","TIU144",164,0)
 S TIUCONT=Y
"RTN","TIU144",165,0)
 I TIUCONT W @IOF,!
"RTN","TIU144",166,0)
 Q TIUCONT
"RTN","TIU144",167,0)
 ;
"RTN","TIU144",168,0)
SETCONT() ; D form feed, Set TIUCONT
"RTN","TIU144",169,0)
 N TIUCONT
"RTN","TIU144",170,0)
 S TIUCONT=1
"RTN","TIU144",171,0)
 I $E(IOST)="C" G SETX:$Y+8<IOSL
"RTN","TIU144",172,0)
 I $E(IOST)="C" S TIUCONT=$$STOP G SETX
"RTN","TIU144",173,0)
 G:$Y+7<IOSL SETX
"RTN","TIU144",174,0)
 W @IOF
"RTN","TIU144",175,0)
SETX Q TIUCONT
"RTN","TIUCNSLT")
0^3^B22334690
"RTN","TIUCNSLT",1,0)
TIUCNSLT ; SLC/JER - Patient movement look-up ;1/7/03
"RTN","TIUCNSLT",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**4,31,109,131,142,144**;Jun 20, 1997
"RTN","TIUCNSLT",3,0)
 ; External References
"RTN","TIUCNSLT",4,0)
 ;   DBIA 2324   $$ISA^USRLM
"RTN","TIUCNSLT",5,0)
 ;   DBIA 3473   SEND^GMRCTIU
"RTN","TIUCNSLT",6,0)
 ;   DBIA 3473   GET^GMRCTIU
"RTN","TIUCNSLT",7,0)
 ;   DBIA 3575   ROLLBACK^GMRCTIU1
"RTN","TIUCNSLT",8,0)
GETCNSLT(DFN,TIUCPF,TIUDA,TIUOVR) ; Match consult result
"RTN","TIUCNSLT",9,0)
 ;to an active request
"RTN","TIUCNSLT",10,0)
 ; Call with:
"RTN","TIUCNSLT",11,0)
 ;     [DFN] - patient file entry number
"RTN","TIUCNSLT",12,0)
 ;  [TIUCPF] - flag to indicate clinical procedure (Optional)
"RTN","TIUCNSLT",13,0)
 ;  [TIUDA] - TIU document IEN of consult result (Optional).
"RTN","TIUCNSLT",14,0)
 ;            If TIUDA has a request, return it w/o asking user.
"RTN","TIUCNSLT",15,0)
 ;  [TIUOVR] - flag to override restrictions on selectable requests
"RTN","TIUCNSLT",16,0)
 ;             (Optional).  If not received or received as null, reset
"RTN","TIUCNSLT",17,0)
 ;             according to whether user is in MIS.
"RTN","TIUCNSLT",18,0)
 ;      Note - If DA is defined and TIU document DA has a request,
"RTN","TIUCNSLT",19,0)
 ;             code returns its request instead of asking user.
"RTN","TIUCNSLT",20,0)
 ;   Returns:     TIUY  - Variable pointer to consult request
"RTN","TIUCNSLT",21,0)
 ;                      = -1 if pat has no requests
"RTN","TIUCNSLT",22,0)
 ;                      = 0 if no request is selected
"RTN","TIUCNSLT",23,0)
AGN ; Loop for handling repeated attempts
"RTN","TIUCNSLT",24,0)
 N TIUI,TIUII,TIUER,TIUOK,TIUOUT,TIUX,TIUY,TIUCNT,X
"RTN","TIUCNSLT",25,0)
 I +DFN'>0 S TIUOUT=1 Q 0
"RTN","TIUCNSLT",26,0)
 I +$G(GMRCO) S TIUX=+$G(GMRCO) G GETX
"RTN","TIUCNSLT",27,0)
 ; -- If TIUDA is not defined, try DA for backward
"RTN","TIUCNSLT",28,0)
 ;    compatibility:
"RTN","TIUCNSLT",29,0)
 S TIUDA=$S('$D(TIUDA):+$G(DA),1:+TIUDA)
"RTN","TIUCNSLT",30,0)
 ; -- Ignore TIUDA if it doesn't match pt DFN:
"RTN","TIUCNSLT",31,0)
 I $P($G(^TIU(8925,TIUDA,0)),U,2)'=+DFN S TIUDA=0
"RTN","TIUCNSLT",32,0)
 ; -- If TIUDA or its parent already has a request,
"RTN","TIUCNSLT",33,0)
 ;    return it & don't ask user:
"RTN","TIUCNSLT",34,0)
 I +$P($G(^TIU(8925,TIUDA,14)),U,5) S TIUX=+$P($G(^(14)),U,5) G GETX
"RTN","TIUCNSLT",35,0)
 I +$$ISADDNDM^TIULC1(TIUDA) S TIUX=+$$DADCR(TIUDA) G:+TIUX>0 GETX
"RTN","TIUCNSLT",36,0)
 ; -- If override flag is null or is not defined, set it according to
"RTN","TIUCNSLT",37,0)
 ;    user's membership in MIS:
"RTN","TIUCNSLT",38,0)
 S TIUOVR=$S($G(TIUOVR)="":+$$ISA^USRLM(DUZ,"MEDICAL INFORMATION SECTION"),1:+TIUOVR)
"RTN","TIUCNSLT",39,0)
 D SEND^GMRCTIU(DFN,$G(TIUOVR),$G(TIUCPF))
"RTN","TIUCNSLT",40,0)
 ; If no consult requests for patient, then quit with -1
"RTN","TIUCNSLT",41,0)
 I $S($G(^TMP("GMRCR",$J,"TIU",1,0))["No Consults":1,'$D(^TMP("GMRCR",$J,"TIU")):1,1:0) D  Q -1
"RTN","TIUCNSLT",42,0)
 . W !!,$C(7),"No CONSULT REQUESTS to Result for ",$P($G(^DPT(DFN,0)),U),".",!
"RTN","TIUCNSLT",43,0)
 S (TIUCNT,TIUI)=0 F  S TIUI=+$O(^TMP("GMRCR",$J,"TIU",TIUI)) Q:+TIUI'>0  D
"RTN","TIUCNSLT",44,0)
 . S TIUCNT=+$G(TIUCNT)+1
"RTN","TIUCNSLT",45,0)
 W !,"You must link this Result to a Consult Request...",!
"RTN","TIUCNSLT",46,0)
 D  I +TIUER Q:+$G(TIUOUT) 0  G AGN
"RTN","TIUCNSLT",47,0)
 . W !,"The following CONSULT REQUEST"
"RTN","TIUCNSLT",48,0)
 . W $S(+TIUCNT>1:"(S) are",1:" is")," available:"
"RTN","TIUCNSLT",49,0)
 . S (TIUER,TIUOK,TIUI)=0
"RTN","TIUCNSLT",50,0)
 . F  S TIUI=$O(^TMP("GMRCR",$J,"TIU",TIUI)) Q:+TIUI'>0!+TIUER!+TIUOK  D
"RTN","TIUCNSLT",51,0)
 . . S TIUII=TIUI,TIUX=$G(^TMP("GMRCR",$J,"TIU",TIUI,0))
"RTN","TIUCNSLT",52,0)
 . . D WRITE I '(TIUI#5) D BREAK
"RTN","TIUCNSLT",53,0)
 . Q:$D(TIUOUT)
"RTN","TIUCNSLT",54,0)
 . I +TIUER S TIUOUT=1 Q
"RTN","TIUCNSLT",55,0)
 . I TIUII#5 D BREAK Q:$D(TIUOUT)
"RTN","TIUCNSLT",56,0)
 . I +TIUER S TIUOUT=1 Q
"RTN","TIUCNSLT",57,0)
 . S TIUX=$O(^TMP("GMRCR",$J,"TIU","B",+TIUOK,0))
"RTN","TIUCNSLT",58,0)
 . ;,^DISV(DUZ,"^GMR(123,",DFN)=+TIUX
"RTN","TIUCNSLT",59,0)
 . W "  ",+TIUX
"RTN","TIUCNSLT",60,0)
GETX S TIUY=+TIUX_";GMR(123,"
"RTN","TIUCNSLT",61,0)
 Q $G(TIUY)
"RTN","TIUCNSLT",62,0)
BREAK ; Handle prompting
"RTN","TIUCNSLT",63,0)
 W !,"CHOOSE 1-",TIUII W:$D(^TMP("GMRCR",$J,"TIU",TIUII+1,0)) !,"<RETURN> TO CONTINUE",!,"OR '^' TO QUIT" W ": " R X:DTIME
"RTN","TIUCNSLT",64,0)
 I $S('$T!(X["^"):1,X=""&'$D(^TMP("GMRCR",$J,"TIU",TIUII+1)):1,1:0) S TIUER=1 Q
"RTN","TIUCNSLT",65,0)
 I X="" Q
"RTN","TIUCNSLT",66,0)
 I X'=+X!'$D(^TMP("GMRCR",$J,"TIU",+X)) W !!,$C(7),"INVALID RESPONSE",! G BREAK
"RTN","TIUCNSLT",67,0)
 S TIUOK=X
"RTN","TIUCNSLT",68,0)
 Q
"RTN","TIUCNSLT",69,0)
DADCR(DA) ; Get the Consult request associated with the parent record
"RTN","TIUCNSLT",70,0)
 N TIUDADA,TIUY S TIUDADA=$P($G(^TIU(8925,+DA,0)),U,6)
"RTN","TIUCNSLT",71,0)
 S TIUY=$P($G(^TIU(8925,TIUDADA,14)),U,5)
"RTN","TIUCNSLT",72,0)
 Q TIUY
"RTN","TIUCNSLT",73,0)
WRITE W !,TIUX
"RTN","TIUCNSLT",74,0)
 Q
"RTN","TIUCNSLT",75,0)
POST(TIUDA,STATUS) ; Post status updates to Consult Tracking
"RTN","TIUCNSLT",76,0)
 N GMRCDA,DA,TIUAUTH S GMRCDA=+$P($G(^TIU(8925,+TIUDA,14)),U,5)
"RTN","TIUCNSLT",77,0)
 I +GMRCDA'>0 Q
"RTN","TIUCNSLT",78,0)
 S TIUAUTH=$P($G(^TIU(8925,TIUDA,12)),U,2)
"RTN","TIUCNSLT",79,0)
 D GET^GMRCTIU(GMRCDA,TIUDA,STATUS,TIUAUTH)
"RTN","TIUCNSLT",80,0)
 Q 
"RTN","TIUCNSLT",81,0)
ISCNSLT(TIUY,TITLE) ; Boolean RPC to evaluate whether TITLE is a CONSULT
"RTN","TIUCNSLT",82,0)
 N TIUCLASS
"RTN","TIUCNSLT",83,0)
 S TIUCLASS=+$$CLASS
"RTN","TIUCNSLT",84,0)
 I +TIUCLASS'>0 S TIUY=0 Q
"RTN","TIUCNSLT",85,0)
 S TIUY=+$$ISA^TIULX(TITLE,TIUCLASS)
"RTN","TIUCNSLT",86,0)
 Q
"RTN","TIUCNSLT",87,0)
CHANGE(TIUDA,TIUCPF,TIUNOCS) ; Re-direct the TIU Document to a different CT Record
"RTN","TIUCNSLT",88,0)
 ; Passes back TIUNOCS=-1 if pt has no requests or none is selected
"RTN","TIUCNSLT",89,0)
 N DA,DFN,DIE,DR,GMRCO,GMRCSTAT,GMRCVP,TIUD0,TIUD14
"RTN","TIUCNSLT",90,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUD14=$G(^(14))
"RTN","TIUCNSLT",91,0)
 S DFN=$P(TIUD0,U,2),GMRCO=$P(TIUD14,U,5)
"RTN","TIUCNSLT",92,0)
 Q:+DFN'>0
"RTN","TIUCNSLT",93,0)
 I GMRCO'="" D ROLLBACK(TIUDA) K GMRCO ;P144
"RTN","TIUCNSLT",94,0)
CHAGN S DA=TIUDA,TIUNOCS=0
"RTN","TIUCNSLT",95,0)
 W ! S GMRCVP=+$$GETCNSLT(DFN,$G(TIUCPF))_";GMR(123,"
"RTN","TIUCNSLT",96,0)
 I +GMRCVP=0 W !!,$C(7),"You must select a Consult Request...Restoring record."
"RTN","TIUCNSLT",97,0)
 I +GMRCVP'>0 D RETREAT(TIUDA,TIUD14) S TIUPOP=1,TIUNOCS=-1 Q  ;P144
"RTN","TIUCNSLT",98,0)
 S DIE=8925,DA=TIUDA,DR="1405////^S X=GMRCVP" D ^DIE
"RTN","TIUCNSLT",99,0)
 D UPDTADD(TIUDA,GMRCVP)
"RTN","TIUCNSLT",100,0)
 S GMRCO=+GMRCVP,GMRCSTAT=$S($P(TIUD0,U,5)>6:"COMPLETED",1:"INCOMPLETE")
"RTN","TIUCNSLT",101,0)
 D POST(TIUDA,GMRCSTAT)
"RTN","TIUCNSLT",102,0)
 Q
"RTN","TIUCNSLT",103,0)
RETREAT(DA,TIUD14) ; If Pt has no requests, retreat gracefully
"RTN","TIUCNSLT",104,0)
 N DIE,DR,GMRCO,GMRCSTAT
"RTN","TIUCNSLT",105,0)
 S DIE=8925,DR="1405////^S X=$P(TIUD14,U,5)" D ^DIE
"RTN","TIUCNSLT",106,0)
 S GMRCO=+$P(TIUD14,U,5)
"RTN","TIUCNSLT",107,0)
 S GMRCSTAT=$S($P(TIUD0,U,5)>6:"COMPLETED",1:"INCOMPLETE")
"RTN","TIUCNSLT",108,0)
 D POST(TIUDA,GMRCSTAT)
"RTN","TIUCNSLT",109,0)
 Q
"RTN","TIUCNSLT",110,0)
UPDTADD(TIUDA,TIUCVP) ; Addenda for re-linked original are updated
"RTN","TIUCNSLT",111,0)
 ;Update TIU(8925 ONLY.  GMR(123 doesn't track individual adda
"RTN","TIUCNSLT",112,0)
 I $$HASADDEN^TIULC1(+TIUDA) D
"RTN","TIUCNSLT",113,0)
 . N DA
"RTN","TIUCNSLT",114,0)
 . S DA=0 F  S DA=$O(^TIU(8925,"DAD",+TIUDA,DA)) Q:+DA'>0  D
"RTN","TIUCNSLT",115,0)
 . . N DR,DIE
"RTN","TIUCNSLT",116,0)
 . . I '+$$ISADDNDM^TIULC1(+DA) Q
"RTN","TIUCNSLT",117,0)
 . . S DR="1405////^S X=TIUCVP"
"RTN","TIUCNSLT",118,0)
 . . S DIE=8925 D ^DIE
"RTN","TIUCNSLT",119,0)
 . . D ^DIE
"RTN","TIUCNSLT",120,0)
 Q
"RTN","TIUCNSLT",121,0)
ROLLBACK(TIUDA) ; Roll back CT Record when TIU changes require it
"RTN","TIUCNSLT",122,0)
 N GMRCDA,DIE,DR,DA S GMRCDA=+$P($G(^TIU(8925,TIUDA,14)),U,5)
"RTN","TIUCNSLT",123,0)
 I +GMRCDA>0 D ROLLBACK^GMRCTIU1(GMRCDA,TIUDA) ;P144
"RTN","TIUCNSLT",124,0)
 S DIE="^TIU(8925,",DA=TIUDA,DR="1405///@" D ^DIE
"RTN","TIUCNSLT",125,0)
 Q
"RTN","TIUCNSLT",126,0)
CLASS() ; What is the TIU Class (or Document Class) for CONSULTS
"RTN","TIUCNSLT",127,0)
 N GMRCY
"RTN","TIUCNSLT",128,0)
 S GMRCY=+$O(^TIU(8925.1,"B","CONSULTS",0))
"RTN","TIUCNSLT",129,0)
 I +GMRCY>0,$S($P($G(^TIU(8925.1,+GMRCY,0)),U,4)="CL":0,$P($G(^(0)),U,4)="DC":0,1:1) S GMRCY=0
"RTN","TIUCNSLT",130,0)
 Q GMRCY
"VER")
8.0^22.0
**END**
**END**
