Released GMRA*4*23 SEQ #21
Extracted from mail message
**KIDS**:GMRA*4.0*23^

**INSTALL NAME**
GMRA*4.0*23
"BLD",5590,0)
GMRA*4.0*23^ADVERSE REACTION TRACKING^0^3050718^y
"BLD",5590,1,0)
^^3^3^3050718^^^^
"BLD",5590,1,1,0)
This patch includes changes required for continued support
"BLD",5590,1,2,0)
of the Health Data Repository project.  Please see the national
"BLD",5590,1,3,0)
patch module for a full description of this patch.
"BLD",5590,4,0)
^9.64PA^120.84^4
"BLD",5590,4,120.8,0)
120.8
"BLD",5590,4,120.8,2,0)
^9.641^120.81^2
"BLD",5590,4,120.8,2,120.8,0)
PATIENT ALLERGIES  (File-top level)
"BLD",5590,4,120.8,2,120.8,1,0)
^9.6411^.02^1
"BLD",5590,4,120.8,2,120.8,1,.02,0)
REACTANT
"BLD",5590,4,120.8,2,120.81,0)
REACTIONS  (sub-file)
"BLD",5590,4,120.8,2,120.81,1,0)
^9.6411^.01^2
"BLD",5590,4,120.8,2,120.81,1,.01,0)
REACTION
"BLD",5590,4,120.8,2,120.81,1,1,0)
OTHER REACTION
"BLD",5590,4,120.8,222)
y^y^p^^^^n^^n
"BLD",5590,4,120.8,224)

"BLD",5590,4,120.82,0)
120.82
"BLD",5590,4,120.82,2,0)
^9.641^120.8299^2
"BLD",5590,4,120.82,2,120.82,0)
GMR ALLERGIES  (File-top level)
"BLD",5590,4,120.82,2,120.82,1,0)
^9.6411^99.99^2
"BLD",5590,4,120.82,2,120.82,1,99.98,0)
MASTER ENTRY FOR VUID
"BLD",5590,4,120.82,2,120.82,1,99.99,0)
VUID
"BLD",5590,4,120.82,2,120.8299,0)
EFFECTIVE DATE/TIME  (sub-file)
"BLD",5590,4,120.82,2,120.8299,1,0)
^9.6411^^
"BLD",5590,4,120.82,222)
y^y^p^^^^n^^n
"BLD",5590,4,120.82,224)

"BLD",5590,4,120.83,0)
120.83
"BLD",5590,4,120.83,2,0)
^9.641^120.8399^2
"BLD",5590,4,120.83,2,120.83,0)
SIGN/SYMPTOMS  (File-top level)
"BLD",5590,4,120.83,2,120.83,1,0)
^9.6411^99.99^2
"BLD",5590,4,120.83,2,120.83,1,99.98,0)
MASTER ENTRY FOR VUID
"BLD",5590,4,120.83,2,120.83,1,99.99,0)
VUID
"BLD",5590,4,120.83,2,120.8399,0)
EFFECTIVE DATE/TIME  (sub-file)
"BLD",5590,4,120.83,2,120.8399,1,0)
^9.6411^^
"BLD",5590,4,120.83,222)
y^y^p^^^^n^^n
"BLD",5590,4,120.83,224)

"BLD",5590,4,120.84,0)
120.84
"BLD",5590,4,120.84,2,0)
^9.641^120.841^1
"BLD",5590,4,120.84,2,120.841,0)
TOP 10 REACTIONS  (sub-file)
"BLD",5590,4,120.84,2,120.841,1,0)
^9.6411^^
"BLD",5590,4,120.84,222)
y^y^p^^^^n^^n
"BLD",5590,4,120.84,224)

"BLD",5590,4,"APDD",120.8,120.8)

"BLD",5590,4,"APDD",120.8,120.8,.02)

"BLD",5590,4,"APDD",120.8,120.81)

"BLD",5590,4,"APDD",120.8,120.81,.01)

"BLD",5590,4,"APDD",120.8,120.81,1)

"BLD",5590,4,"APDD",120.82,120.82)

"BLD",5590,4,"APDD",120.82,120.82,99.98)

"BLD",5590,4,"APDD",120.82,120.82,99.99)

"BLD",5590,4,"APDD",120.82,120.8299)

"BLD",5590,4,"APDD",120.83,120.83)

"BLD",5590,4,"APDD",120.83,120.83,99.98)

"BLD",5590,4,"APDD",120.83,120.83,99.99)

"BLD",5590,4,"APDD",120.83,120.8399)

"BLD",5590,4,"APDD",120.84,120.841)

"BLD",5590,4,"B",120.8,120.8)

"BLD",5590,4,"B",120.82,120.82)

"BLD",5590,4,"B",120.83,120.83)

"BLD",5590,4,"B",120.84,120.84)

"BLD",5590,6)
11^
"BLD",5590,"ABPKG")
n
"BLD",5590,"INI")

"BLD",5590,"INIT")
POST^GMRAY23
"BLD",5590,"KRN",0)
^9.67PA^8989.52^19
"BLD",5590,"KRN",.4,0)
.4
"BLD",5590,"KRN",.401,0)
.401
"BLD",5590,"KRN",.402,0)
.402
"BLD",5590,"KRN",.403,0)
.403
"BLD",5590,"KRN",.5,0)
.5
"BLD",5590,"KRN",.84,0)
.84
"BLD",5590,"KRN",3.6,0)
3.6
"BLD",5590,"KRN",3.8,0)
3.8
"BLD",5590,"KRN",9.2,0)
9.2
"BLD",5590,"KRN",9.8,0)
9.8
"BLD",5590,"KRN",9.8,"NM",0)
^9.68A^20^17
"BLD",5590,"KRN",9.8,"NM",1,0)
GMRAFUT0^^0^B29214778
"BLD",5590,"KRN",9.8,"NM",2,0)
GMRAFX^^0^B91485304
"BLD",5590,"KRN",9.8,"NM",3,0)
GMRAY23A^^0^B1029998
"BLD",5590,"KRN",9.8,"NM",4,0)
GMRAY23B^^0^B1182237
"BLD",5590,"KRN",9.8,"NM",7,0)
GMRAUTL2^^0^B71296835
"BLD",5590,"KRN",9.8,"NM",8,0)
GMRAFX3^^0^B36523272
"BLD",5590,"KRN",9.8,"NM",9,0)
GMRAPES0^^0^B72112674
"BLD",5590,"KRN",9.8,"NM",11,0)
GMRAPHR1^^0^B19292074
"BLD",5590,"KRN",9.8,"NM",12,0)
GMRAIAD1^^0^B71618059
"BLD",5590,"KRN",9.8,"NM",13,0)
GMRAIAD2^^0^B17674891
"BLD",5590,"KRN",9.8,"NM",14,0)
GMRAIAL1^^0^B32654103
"BLD",5590,"KRN",9.8,"NM",15,0)
GMRAIAL2^^0^B32309600
"BLD",5590,"KRN",9.8,"NM",16,0)
GMRAIVDK^^0^B5294548
"BLD",5590,"KRN",9.8,"NM",17,0)
GMRAPER0^^0^B56465976
"BLD",5590,"KRN",9.8,"NM",18,0)
GMRAFX2^^0^B24928118
"BLD",5590,"KRN",9.8,"NM",19,0)
GMRAY23^^0^B35594453
"BLD",5590,"KRN",9.8,"NM",20,0)
GMRAY23C^^0^B1627478
"BLD",5590,"KRN",9.8,"NM","B","GMRAFUT0",1)

"BLD",5590,"KRN",9.8,"NM","B","GMRAFX",2)

"BLD",5590,"KRN",9.8,"NM","B","GMRAFX2",18)

"BLD",5590,"KRN",9.8,"NM","B","GMRAFX3",8)

"BLD",5590,"KRN",9.8,"NM","B","GMRAIAD1",12)

"BLD",5590,"KRN",9.8,"NM","B","GMRAIAD2",13)

"BLD",5590,"KRN",9.8,"NM","B","GMRAIAL1",14)

"BLD",5590,"KRN",9.8,"NM","B","GMRAIAL2",15)

"BLD",5590,"KRN",9.8,"NM","B","GMRAIVDK",16)

"BLD",5590,"KRN",9.8,"NM","B","GMRAPER0",17)

"BLD",5590,"KRN",9.8,"NM","B","GMRAPES0",9)

"BLD",5590,"KRN",9.8,"NM","B","GMRAPHR1",11)

"BLD",5590,"KRN",9.8,"NM","B","GMRAUTL2",7)

"BLD",5590,"KRN",9.8,"NM","B","GMRAY23",19)

"BLD",5590,"KRN",9.8,"NM","B","GMRAY23A",3)

"BLD",5590,"KRN",9.8,"NM","B","GMRAY23B",4)

"BLD",5590,"KRN",9.8,"NM","B","GMRAY23C",20)

"BLD",5590,"KRN",19,0)
19
"BLD",5590,"KRN",19.1,0)
19.1
"BLD",5590,"KRN",101,0)
101
"BLD",5590,"KRN",409.61,0)
409.61
"BLD",5590,"KRN",771,0)
771
"BLD",5590,"KRN",870,0)
870
"BLD",5590,"KRN",8989.51,0)
8989.51
"BLD",5590,"KRN",8989.52,0)
8989.52
"BLD",5590,"KRN",8994,0)
8994
"BLD",5590,"KRN","B",.4,.4)

"BLD",5590,"KRN","B",.401,.401)

"BLD",5590,"KRN","B",.402,.402)

"BLD",5590,"KRN","B",.403,.403)

"BLD",5590,"KRN","B",.5,.5)

"BLD",5590,"KRN","B",.84,.84)

"BLD",5590,"KRN","B",3.6,3.6)

"BLD",5590,"KRN","B",3.8,3.8)

"BLD",5590,"KRN","B",9.2,9.2)

"BLD",5590,"KRN","B",9.8,9.8)

"BLD",5590,"KRN","B",19,19)

"BLD",5590,"KRN","B",19.1,19.1)

"BLD",5590,"KRN","B",101,101)

"BLD",5590,"KRN","B",409.61,409.61)

"BLD",5590,"KRN","B",771,771)

"BLD",5590,"KRN","B",870,870)

"BLD",5590,"KRN","B",8989.51,8989.51)

"BLD",5590,"KRN","B",8989.52,8989.52)

"BLD",5590,"KRN","B",8994,8994)

"BLD",5590,"PRE")

"BLD",5590,"PRET")
PRETRAN^GMRAY23
"BLD",5590,"QUES",0)
^9.62^^
"BLD",5590,"REQB",0)
^9.611^3^3
"BLD",5590,"REQB",1,0)
GMRA*4.0*21^1
"BLD",5590,"REQB",2,0)
GMRA*4.0*22^1
"BLD",5590,"REQB",3,0)
OR*3.0*233^1
"BLD",5590,"REQB","B","GMRA*4.0*21",1)

"BLD",5590,"REQB","B","GMRA*4.0*22",2)

"BLD",5590,"REQB","B","OR*3.0*233",3)

"FIA",120.8)
PATIENT ALLERGIES
"FIA",120.8,0)
^GMR(120.8,
"FIA",120.8,0,0)
120.8IPs
"FIA",120.8,0,1)
y^y^p^^^^n^^n
"FIA",120.8,0,10)

"FIA",120.8,0,11)

"FIA",120.8,0,"RLRO")

"FIA",120.8,0,"VR")
4.0^GMRA
"FIA",120.8,120.8)
1
"FIA",120.8,120.8,.02)

"FIA",120.8,120.8,10)

"FIA",120.8,120.81)
1
"FIA",120.8,120.81,.01)

"FIA",120.8,120.81,1)

"FIA",120.82)
GMR ALLERGIES
"FIA",120.82,0)
^GMRD(120.82,
"FIA",120.82,0,0)
120.82I
"FIA",120.82,0,1)
y^y^p^^^^n^^n
"FIA",120.82,0,10)

"FIA",120.82,0,11)

"FIA",120.82,0,"RLRO")

"FIA",120.82,0,"VR")
4.0^GMRA
"FIA",120.82,120.82)
1
"FIA",120.82,120.82,99.98)

"FIA",120.82,120.82,99.99)

"FIA",120.82,120.82,99.991)

"FIA",120.82,120.8299)
0
"FIA",120.83)
SIGN/SYMPTOMS
"FIA",120.83,0)
^GMRD(120.83,
"FIA",120.83,0,0)
120.83I
"FIA",120.83,0,1)
y^y^p^^^^n^^n
"FIA",120.83,0,10)

"FIA",120.83,0,11)

"FIA",120.83,0,"RLRO")

"FIA",120.83,0,"VR")
4.0^GMRA
"FIA",120.83,120.83)
1
"FIA",120.83,120.83,99.98)

"FIA",120.83,120.83,99.99)

"FIA",120.83,120.83,99.991)

"FIA",120.83,120.8399)
0
"FIA",120.84)
GMR ALLERGY SITE PARAMETERS
"FIA",120.84,0)
^GMRD(120.84,
"FIA",120.84,0,0)
120.84
"FIA",120.84,0,1)
y^y^p^^^^n^^n
"FIA",120.84,0,10)

"FIA",120.84,0,11)

"FIA",120.84,0,"RLRO")

"FIA",120.84,0,"VR")
4.0^GMRA
"FIA",120.84,120.84)
1
"FIA",120.84,120.84,1)

"FIA",120.84,120.841)
0
"INIT")
POST^GMRAY23
"IX",120.8,120.8,"AHDR",0)
120.8^AHDR^Sends data to HDR upon entry^MU^^R^R^I^120.8^^^^^A
"IX",120.8,120.8,"AHDR",.1,0)
^^2^2^3041220
"IX",120.8,120.8,"AHDR",.1,1,0)
This cross reference will send the HDR allergy data upon entry or editing 
"IX",120.8,120.8,"AHDR",.1,2,0)
of allergy related data.
"IX",120.8,120.8,"AHDR",1)
Q:$D(DIU(0))  D SETADR^GMRAHDR
"IX",120.8,120.8,"AHDR",2)
Q:$D(DIU(0))  D KILLADR^GMRAHDR
"IX",120.8,120.8,"AHDR",2.5)
Q
"IX",120.8,120.8,"AHDR",11.1,0)
^.114IA^15^15
"IX",120.8,120.8,"AHDR",11.1,1,0)
1^F^120.8^.01^^^F
"IX",120.8,120.8,"AHDR",11.1,2,0)
2^F^120.8^.02^^^F
"IX",120.8,120.8,"AHDR",11.1,3,0)
3^F^120.8^1^^^F
"IX",120.8,120.8,"AHDR",11.1,4,0)
4^F^120.8^3.1^^^F
"IX",120.8,120.8,"AHDR",11.1,5,0)
5^F^120.8^4^^^F
"IX",120.8,120.8,"AHDR",11.1,6,0)
6^F^120.8^5^^^F
"IX",120.8,120.8,"AHDR",11.1,7,0)
7^F^120.8^6^^^F
"IX",120.8,120.8,"AHDR",11.1,8,0)
8^F^120.8^15^^^F
"IX",120.8,120.8,"AHDR",11.1,9,0)
9^F^120.8^17^^^F
"IX",120.8,120.8,"AHDR",11.1,10,0)
10^F^120.8^19^^^F
"IX",120.8,120.8,"AHDR",11.1,11,0)
11^F^120.8^20^^^F
"IX",120.8,120.8,"AHDR",11.1,12,0)
12^F^120.8^21^^^F
"IX",120.8,120.8,"AHDR",11.1,13,0)
13^F^120.8^22^^^F
"IX",120.8,120.8,"AHDR",11.1,14,0)
14^F^120.8^23^^^F
"IX",120.8,120.8,"AHDR",11.1,15,0)
15^F^120.8^24^^^F
"IX",120.8,120.81,"AHDR",0)
120.81^AHDR^Send data to HDR upon entry or edit^MU^^R^R^I^120.81^^^^^A
"IX",120.8,120.81,"AHDR",.1,0)
^^1^1^3041220
"IX",120.8,120.81,"AHDR",.1,1,0)
Sends data to HDR when reactions (sign/symptoms) are added or edited.
"IX",120.8,120.81,"AHDR",1)
Q:$D(DIU(0))  D SETADR^GMRAHDR
"IX",120.8,120.81,"AHDR",2)
Q:$D(DIU(0))  D KILLADR^GMRAHDR
"IX",120.8,120.81,"AHDR",2.5)
Q
"IX",120.8,120.81,"AHDR",11.1,0)
^.114IA^4^4
"IX",120.8,120.81,"AHDR",11.1,1,0)
1^F^120.81^.01^^^F
"IX",120.8,120.81,"AHDR",11.1,2,0)
2^F^120.81^1^^^F
"IX",120.8,120.81,"AHDR",11.1,3,0)
3^F^120.81^2^^^F
"IX",120.8,120.81,"AHDR",11.1,4,0)
4^F^120.81^3^^^F
"IX",120.82,120.82,"AMASTERVUID",0)
120.82^AMASTERVUID^Identifies Master entry for a VUID^R^^R^IR^I^120.82^^^^^S
"IX",120.82,120.82,"AMASTERVUID",.1,0)
^^3^3^3050311^
"IX",120.82,120.82,"AMASTERVUID",.1,1,0)
If multiple entries have the same VUID in the file, this cross-reference 
"IX",120.82,120.82,"AMASTERVUID",.1,2,0)
can be used to identify the Master entry for a VUID associated with a 
"IX",120.82,120.82,"AMASTERVUID",.1,3,0)
Term/Concept.
"IX",120.82,120.82,"AMASTERVUID",1)
S ^GMRD(120.82,"AMASTERVUID",$E(X(1),1,30),X(2),DA)=""
"IX",120.82,120.82,"AMASTERVUID",2)
K ^GMRD(120.82,"AMASTERVUID",$E(X(1),1,30),X(2),DA)
"IX",120.82,120.82,"AMASTERVUID",2.5)
K ^GMRD(120.82,"AMASTERVUID")
"IX",120.82,120.82,"AMASTERVUID",11.1,0)
^.114IA^2^2
"IX",120.82,120.82,"AMASTERVUID",11.1,1,0)
1^F^120.82^99.99^30^1^F
"IX",120.82,120.82,"AMASTERVUID",11.1,1,3)

"IX",120.82,120.82,"AMASTERVUID",11.1,2,0)
2^F^120.82^99.98^^2^F
"IX",120.82,120.82,"AMASTERVUID",11.1,2,3)

"IX",120.83,120.83,"AMASTERVUID",0)
120.83^AMASTERVUID^This cross-reference identifies the Master entry for a VUID^R^^R^IR^I^120.83^^^^^S
"IX",120.83,120.83,"AMASTERVUID",.1,0)
^^3^3^3050311^
"IX",120.83,120.83,"AMASTERVUID",.1,1,0)
If multiple entries have the same VUID in the file, this cross-reference 
"IX",120.83,120.83,"AMASTERVUID",.1,2,0)
can be used to identify the Master entry for  VUID associated with a 
"IX",120.83,120.83,"AMASTERVUID",.1,3,0)
Term/Concept.
"IX",120.83,120.83,"AMASTERVUID",1)
S ^GMRD(120.83,"AMASTERVUID",$E(X(1),1,30),X(2),DA)=""
"IX",120.83,120.83,"AMASTERVUID",2)
K ^GMRD(120.83,"AMASTERVUID",$E(X(1),1,30),X(2),DA)
"IX",120.83,120.83,"AMASTERVUID",2.5)
K ^GMRD(120.83,"AMASTERVUID")
"IX",120.83,120.83,"AMASTERVUID",11.1,0)
^.114IA^2^2
"IX",120.83,120.83,"AMASTERVUID",11.1,1,0)
1^F^120.83^99.99^30^1^F
"IX",120.83,120.83,"AMASTERVUID",11.1,1,3)

"IX",120.83,120.83,"AMASTERVUID",11.1,2,0)
2^F^120.83^99.98^^2^F
"IX",120.83,120.83,"AMASTERVUID",11.1,2,3)

"MBREQ")
0
"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
23^3050718^1326
"PKG",140,22,1,"PAH",1,1,0)
^^3^3^3050718
"PKG",140,22,1,"PAH",1,1,1,0)
This patch includes changes required for continued support
"PKG",140,22,1,"PAH",1,1,2,0)
of the Health Data Repository project.  Please see the national
"PKG",140,22,1,"PAH",1,1,3,0)
patch module for a full description of this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
17
"RTN","GMRAFUT0")
0^1^B29214778
"RTN","GMRAFUT0",1,0)
GMRAFUT0 ;HIRMFO/YMP,RFM,WAA-ALLERGY/ADVERSE REACTION FILE UTILITIES ;3/14/05  12:21
"RTN","GMRAFUT0",2,0)
 ;;4.0;Adverse Reaction Tracking;**23**;Mar 29, 1996
"RTN","GMRAFUT0",3,0)
EN1 ; Entry for GMRA LOCAL ALLERGIES EDIT option
"RTN","GMRAFUT0",4,0)
 D PROCESS Q  ;23
"RTN","GMRAFUT0",5,0)
 K DR,DIC,DLAYGO,X,Y,DA,GMRAIEN
"RTN","GMRAFUT0",6,0)
 W ! S DLAYGO=120.82,DIC="^GMRD(120.82,",DIC("A")="Select a LOCAL ALLERGY/ADVERSE REACTION: ",DIC(0)="AEQML",DIC("DR")="1" D ^DIC K DIC,DLAYGO G:+Y'>0 EXIT S (DA,GMRAIEN)=+Y
"RTN","GMRAFUT0",7,0)
 L +^GMRD(120.82,GMRAIEN):1 I '$T W !,"THIS ENTRY IS BEING EDITED BY SOMEONE ELSE",$C(7) D EXIT Q
"RTN","GMRAFUT0",8,0)
 N GMRALN,DIE,GMRACT
"RTN","GMRAFUT0",9,0)
 S GMRALN=$G(^GMRD(120.82,GMRAIEN,0))
"RTN","GMRAFUT0",10,0)
 S DIE="^GMRD(120.82,",DR="",GMRACT=1
"RTN","GMRAFUT0",11,0)
 I +$P(GMRALN,U,3) S DR(1,120.82,1)="@1;W !!,$C(7),""CANNOT EDIT NAME FIELD OF A NATIONAL ALLERGY."",!;3;"
"RTN","GMRAFUT0",12,0)
 E  D
"RTN","GMRAFUT0",13,0)
 .   S DR(1,120.82,1)=".01;3;"
"RTN","GMRAFUT0",14,0)
 .   S DR(1,120.82,2)="S (GMRAY,GMRAX)=$P(GMRALN,U,2) D EDTTYPE^GMRAUTL(.GMRAX);"
"RTN","GMRAFUT0",15,0)
 .   S DR(1,120.82,3)="S:GMRAX=GMRAY!(""^^""[GMRAX) X=GMRAX,Y=$S(""^^""[GMRAX:""@3"",1:""@4"");1///^S X=GMRAX;@4;4;5;@3;"
"RTN","GMRAFUT0",16,0)
 .   Q
"RTN","GMRAFUT0",17,0)
 D ^DIE K DIE,DA,DR,DLAYGO,GMRAX,GMRAY
"RTN","GMRAFUT0",18,0)
 L -^GMRD(120.82,GMRAIEN)
"RTN","GMRAFUT0",19,0)
 G:'$D(Y) EN1
"RTN","GMRAFUT0",20,0)
 D EXIT Q
"RTN","GMRAFUT0",21,0)
EN2 ; Entry for GMRA LOCAL REACTIONS EDIT option
"RTN","GMRAFUT0",22,0)
 D PROCESS Q  ;23
"RTN","GMRAFUT0",23,0)
 W ! S DLAYGO=120.83,DIC="^GMRD(120.83,",DIC("A")="Select a LOCAL SIGN/SYMPTOM: ",DIC(0)="AEQML",DIC("DR")="" D ^DIC K DIC,DLAYGO G:+Y'>0 EXIT S (DA,GMRAY)=+Y
"RTN","GMRAFUT0",24,0)
 L +^GMRD(120.83,GMRAY):1 I '$T W !,"THIS ENTRY IS BEING EDITED BY SOMEONE ELSE",$C(7) D EXIT Q
"RTN","GMRAFUT0",25,0)
 S DIE="^GMRD(120.83,",DR="S Y=""@""_+$P($G(^GMRD(120.83,DA,0)),U,2);@0;.01;S Y=""@2"";@1;W !,""NAME: ""_$P($G(^GMRD(120.83,DA,0)),U)_""  (no editing)"";@2;2" D ^DIE K DA,DIE,DR
"RTN","GMRAFUT0",26,0)
 L -^GMRD(120.83,GMRAY)
"RTN","GMRAFUT0",27,0)
 G:'$D(Y) EN2
"RTN","GMRAFUT0",28,0)
 D EXIT Q
"RTN","GMRAFUT0",29,0)
EN3 ; Entry for GMRA SITE FILE EDIT option
"RTN","GMRAFUT0",30,0)
 S DLAYGO=120.84,DIC="^GMRD(120.84,",DIC(0)="AEQL" D ^DIC K DIC,DLAYGO G:+Y'>0 EXIT S GMRASITE=+Y
"RTN","GMRAFUT0",31,0)
 L +^GMRD(120.84,GMRASITE):1 I '$T W !,"THIS ENTRY IS BEING EDITED BY SOMEONE ELSE",$C(7) D EXIT Q
"RTN","GMRAFUT0",32,0)
 I $P(Y,"^",2)="HOSPITAL" W !,"NAME: HOSPITAL// (No editing)"
"RTN","GMRAFUT0",33,0)
 E  S DA=GMRASITE,DIE="^GMRD(120.84,",DR=".01" D ^DIE I $D(Y) L -^GMRD(120.84,GMRASITE) G EXIT
"RTN","GMRAFUT0",34,0)
 I '$D(^GMRD(120.84,GMRASITE,0)) L -^GMRD(120.84,GMRASITE) G EN3
"RTN","GMRAFUT0",35,0)
 S DA=GMRASITE,DIE="^GMRD(120.84,",DR=6 D ^DIE I $D(Y) L -^GMRD(120.84,GMRASITE) G EXIT
"RTN","GMRAFUT0",36,0)
RE10 S (GMRACTR,GMRARECN,GMRABRK,GMRAMID)=0,GMRALLER=""
"RTN","GMRAFUT0",37,0)
 W !!,"The following are the ten most common signs/symptoms:"
"RTN","GMRAFUT0",38,0)
 F GMRAX=1:1:5 D PRT10
"RTN","GMRAFUT0",39,0)
RRD W !,"Enter the number of the sign/symptom that you would like to edit: "
"RTN","GMRAFUT0",40,0)
 R GMRANS:DTIME S:'$T GMRANS="^^" I "^^"[GMRANS L:(GMRANS["^") -^GMRD(120.84,GMRASITE) G EXIT:(GMRANS["^"),EDCON
"RTN","GMRAFUT0",41,0)
 I GMRANS'=+GMRANS!(GMRANS<1)!(GMRANS>10)!(GMRANS\1'=GMRANS) W !?4,$C(7),"ENTER THE CORRECT NUMBER (1-10) OF THE SIGN/SYMPTOM TO BE EDITED" G RRD
"RTN","GMRAFUT0",42,0)
 S:'$D(^GMRD(120.84,GMRASITE,1,0)) ^(0)="^120.841P^^" S (GMRAX,GMRAY)=$G(^GMRD(120.84,GMRASITE,1,0)) I '$D(^GMRD(120.84,GMRASITE,1,+GMRANS,0)) S ^(0)="",$P(GMRAY,"^",3,4)=+GMRANS_"^"_($P(GMRAY,"^",4)+1)
"RTN","GMRAFUT0",43,0)
 S DIE="^GMRD(120.84,DA(1),1,",DA(1)=GMRASITE,DA=+GMRANS,DR=".01" D ^DIE
"RTN","GMRAFUT0",44,0)
 I $G(^GMRD(120.84,GMRASITE,1,+GMRANS,0))="" K ^(0) S GMRAY=GMRAX
"RTN","GMRAFUT0",45,0)
 I GMRAY'=GMRAX S ^GMRD(120.84,GMRASITE,1,0)=GMRAY
"RTN","GMRAFUT0",46,0)
 G RE10:'$D(Y) L -^GMRD(120.84,GMRASITE) G EXIT
"RTN","GMRAFUT0",47,0)
EDCON S DIE="^GMRD(120.84,",DA=GMRASITE,DR="2;3;3.5;4;7;7.1;7.2;7.3SEND CHART MARK BULLETIN FOR NEW ADMISSIONS;10;10.1ENABLE COMMENTS FIELD FOR REACTIONS THAT ARE ENTERED IN ERROR" D ^DIE
"RTN","GMRAFUT0",48,0)
 I $D(Y) L -^GMRD(120.84,GMRASITE) G EXIT
"RTN","GMRAFUT0",49,0)
 S X=$G(^GMRD(120.84,GMRASITE,"RPT"))
"RTN","GMRAFUT0",50,0)
 W !!,"REPORTER NAME: ",$P(X,U),!?6,"ADDRESS: ",$P(X,U,2) W:$L($P(X,U,3)) !?15,$P(X,U,3) W:$L($P(X,U,4)) !?15,$P(X,U,4) W !?9,"CITY: ",$P(X,U,5),!?8,"STATE: ",$P($G(^DIC(5,+$P(X,U,6),0)),U),!?10,"ZIP: ",$P(X,U,7),!?8,"PHONE: ",$P(X,U,8)
"RTN","GMRAFUT0",51,0)
 W !,?3,"OCCUPATION: ",$P(X,U,11)
"RTN","GMRAFUT0",52,0)
 F  S %=2 W !,"Do you want to edit Reporter Information shown above" D YN^DICN S:%=-1 %=2 Q:%  W !?3,"ENTER YES TO CHANGE/ADD THE SITE'S DEFAULT REPORTER INFORMATION",!?3,"THAT WILL APPEAR ON THE FDA ADR REPORTS, ELSE ANSWER NO."
"RTN","GMRAFUT0",53,0)
 I %'=1 L -^GMRD(120.84,GMRASITE) G EXIT
"RTN","GMRAFUT0",54,0)
 S DIE="^GMRD(120.84,",DA=GMRASITE,DR="11:19" D ^DIE
"RTN","GMRAFUT0",55,0)
 L -^GMRD(120.84,GMRASITE)
"RTN","GMRAFUT0",56,0)
EXIT ;
"RTN","GMRAFUT0",57,0)
 D KILL^XUSCLEAN
"RTN","GMRAFUT0",58,0)
 Q
"RTN","GMRAFUT0",59,0)
PRT10 ;
"RTN","GMRAFUT0",60,0)
 S GMRAY=$S($D(^GMRD(120.84,GMRASITE,1,GMRAX,0)):+^(0),1:0),GMRAZ=$S($D(^GMRD(120.84,GMRASITE,1,GMRAX+5,0)):+^(0),1:0)
"RTN","GMRAFUT0",61,0)
 W !,$J(GMRAX,2),".",?4,$S($D(^GMRD(120.83,GMRAY,0)):$P(^(0),"^"),1:""),?35,$J(GMRAX+5,2),".",?39,$S($D(^GMRD(120.83,GMRAZ,0)):$P(^(0),"^"),1:"")
"RTN","GMRAFUT0",62,0)
 Q
"RTN","GMRAFUT0",63,0)
EN4 ; ENTRY FROM INPUT TRANSFORM FOR FIELDS .01 AND 22 OF FILE
"RTN","GMRAFUT0",64,0)
 ; 120.85, WHERE GMRA=FIELD NUMBER, X IS DATA TO BE TRANSFORMED.
"RTN","GMRAFUT0",65,0)
 S %DT="ETX",%DT(0)="-NOW" D ^%DT S X=Y I Y<1 W !?5,"DATE MUST BE IN THE PAST, AND TIME IS NOT A REQUIRED RESPONSE." G K4
"RTN","GMRAFUT0",66,0)
 S GMRA(0)=$G(^GMR(120.85,+$G(DA),0)),GMRA("HELP")="DATE MUST BE "_$P("GREATER THAN DATE/TIME OBSERVED^LESS THAN DATE/TIME MD NOTIFIED","^",GMRA=.01+1),%DT(0)=+($E("-",GMRA=.01)_$P(GMRA(0),U,$E(12,1,GMRA=.01+1)))
"RTN","GMRAFUT0",67,0)
 G:%DT(0)=0 Q4 S %DT="TX" D ^%DT S X=Y W:Y<1 !?5,GMRA("HELP") G:Y>0 Q4
"RTN","GMRAFUT0",68,0)
K4 K X
"RTN","GMRAFUT0",69,0)
Q4 K %DT,GMRA
"RTN","GMRAFUT0",70,0)
 Q
"RTN","GMRAFUT0",71,0)
 ;PROCESS section added with patch 23
"RTN","GMRAFUT0",72,0)
PROCESS ;Additions to 120.82 and 120.83 are no longer allowed
"RTN","GMRAFUT0",73,0)
 I $L($T(NTRTMSG^HDISVAP)) D NTRTMSG^HDISVAP() Q
"RTN","GMRAFUT0",74,0)
 W !!,"The addition of local reactants and sign/symptoms are no longer"
"RTN","GMRAFUT0",75,0)
 W !,"allowed.  Requests for new terms/concepts should be made through"
"RTN","GMRAFUT0",76,0)
 W !,"the New Term Rapid Turn-around (NTRT) process.",!
"RTN","GMRAFUT0",77,0)
 Q
"RTN","GMRAFX")
0^2^B91485304
"RTN","GMRAFX",1,0)
GMRAFX ;SLC/DAN Fix existing free text entries ;2/18/05  13:56
"RTN","GMRAFX",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19,23**;Mar 29, 1996
"RTN","GMRAFX",3,0)
 ;DBIA SECTION
"RTN","GMRAFX",4,0)
 ;10118 - VALM
"RTN","GMRAFX",5,0)
 ;2056  - DIQ
"RTN","GMRAFX",6,0)
 ;3744  - $$TESTPAT^VADPT
"RTN","GMRAFX",7,0)
 ;10006 - DIC
"RTN","GMRAFX",8,0)
 ;10103 - XLFDT
"RTN","GMRAFX",9,0)
 ;10102 - XQORM1
"RTN","GMRAFX",10,0)
 ;10104 - XLFSTR
"RTN","GMRAFX",11,0)
 ;10117 - VALM10
"RTN","GMRAFX",12,0)
 ;10116 - VALM1
"RTN","GMRAFX",13,0)
 ;10026 - DIR
"RTN","GMRAFX",14,0)
 ;10018 - DIE
"RTN","GMRAFX",15,0)
 ;10013 - DIK
"RTN","GMRAFX",16,0)
 ;10061 - VADPT
"RTN","GMRAFX",17,0)
 ;10101 - XQOR
"RTN","GMRAFX",18,0)
 ;
"RTN","GMRAFX",19,0)
EN ; -- main entry point for GMRA FIX
"RTN","GMRAFX",20,0)
 N NMBR,REBLD,Y,DIR,I
"RTN","GMRAFX",21,0)
 I $D(^XTMP("GMRAFX","B")) W !,"The list is currently being built by another user so this option is",!,"temporarily unavailable.  Please try again in a few minutes." Q
"RTN","GMRAFX",22,0)
 I $D(^XTMP("GMRAFX","INUSE")) D
"RTN","GMRAFX",23,0)
 .W !,"The utility is currently in use by the following people:",!
"RTN","GMRAFX",24,0)
 .S I=0 F  S I=$O(^XTMP("GMRAFX","INUSE",I)) Q:'+I  W !,$$GET1^DIQ(200,I,.01)
"RTN","GMRAFX",25,0)
 .W !!,"As a result, the existing free text list will be used." D WAIT^GMRAFX3
"RTN","GMRAFX",26,0)
 I $D(^XTMP("GMRAFX")),'$D(^XTMP("GMRAFX","INUSE")) D
"RTN","GMRAFX",27,0)
 .W !,"The free text list was last built on ",$$FMTE^XLFDT($P(^XTMP("GMRAFX",0),U,2)),!
"RTN","GMRAFX",28,0)
 .S DIR(0)="Y",DIR("A")="Do you want to rebuild the list",DIR("B")="NO",DIR("?")="Enter yes to rebuild the list of free text entries.  Enter NO to use the currently existing list"
"RTN","GMRAFX",29,0)
 .D ^DIR I Y=1 K ^XTMP("GMRAFX") S REBLD=1
"RTN","GMRAFX",30,0)
 I $G(REBLD)!('$D(^XTMP("GMRAFX"))) W !,"Building list of free text allergies...this may take a few minutes",!
"RTN","GMRAFX",31,0)
 S ^XTMP("GMRAFX","INUSE",+$G(DUZ))=""
"RTN","GMRAFX",32,0)
 D EN^VALM("GMRA FIX")
"RTN","GMRAFX",33,0)
 K ^XTMP("GMRAFX","INUSE",+$G(DUZ))
"RTN","GMRAFX",34,0)
 Q
"RTN","GMRAFX",35,0)
 ;
"RTN","GMRAFX",36,0)
HDR ; -- header code
"RTN","GMRAFX",37,0)
 S VALMHDR(1)="Allergy Tracking Free Text Entries"
"RTN","GMRAFX",38,0)
 Q
"RTN","GMRAFX",39,0)
PHDR ;
"RTN","GMRAFX",40,0)
 S VALMSG="Select one or more entries"
"RTN","GMRAFX",41,0)
 S XQORM("#")=$$FIND1^DIC(101,,"BX","GMRA FIX FREE TEXT LIST") ;19
"RTN","GMRAFX",42,0)
 D SHOW^VALM
"RTN","GMRAFX",43,0)
 Q
"RTN","GMRAFX",44,0)
 ;
"RTN","GMRAFX",45,0)
INIT ;Initialize variables, etc
"RTN","GMRAFX",46,0)
 S VALMBCK="",VALMBG=$S($G(VALMBG)'="":VALMBG,1:1),VALMCNT=$S($D(^XTMP("GMRAFX",0)):$P(^(0),U,3),1:0),VALMWD=80
"RTN","GMRAFX",47,0)
 Q
"RTN","GMRAFX",48,0)
LIST ; -- obtain and display list of free text allergies
"RTN","GMRAFX",49,0)
 N GMRAIEN,GMRAOTH,GMRATXT,GMRAUTXT,SP1,SP2,SP3,UP,TXT
"RTN","GMRAFX",50,0)
 S VALMBCK="R",VALMCNT=0
"RTN","GMRAFX",51,0)
 K ^XTMP("GMRAFX") S ^XTMP("GMRAFX","B")="",^XTMP("GMRAFX","INUSE",+$G(DUZ))=""
"RTN","GMRAFX",52,0)
 S GMRAOTH=$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0))_";GMRD(120.82," ;Gets IEN;FILE ENTRY for free text entries
"RTN","GMRAFX",53,0)
 S GMRAIEN=0 F  S GMRAIEN=$O(^GMR(120.8,GMRAIEN)) Q:'+GMRAIEN  I $P($G(^(GMRAIEN,0)),U,3)=GMRAOTH D
"RTN","GMRAFX",54,0)
 .Q:+$G(^GMR(120.8,GMRAIEN,"ER"))  ;Quit if reactant entered in error
"RTN","GMRAFX",55,0)
 .Q:$$DECEASED(+$P($G(^GMR(120.8,GMRAIEN,0)),U))  ;Don't report expired patients
"RTN","GMRAFX",56,0)
 .Q:$$TESTPAT^VADPT($P($G(^GMR(120.8,GMRAIEN,0)),U))  ;Don't report test patients
"RTN","GMRAFX",57,0)
 .S GMRATXT=$E($P($G(^GMR(120.8,GMRAIEN,0)),U,2),1,75) ;Get "reactant" text entry, no more than 75 characters
"RTN","GMRAFX",58,0)
 .S GMRATXT=$TR(GMRATXT,"""","") ;19 remove quote marks from text
"RTN","GMRAFX",59,0)
 .S GMRAUTXT=$$UP^XLFSTR(GMRATXT) ;Convert to upper case
"RTN","GMRAFX",60,0)
 .S ^XTMP("GMRAFX","GMRAR",GMRAUTXT,GMRATXT)=$G(^XTMP("GMRAFX","GMRAR",GMRAUTXT,GMRATXT))+1 ;Local array of free text entries = active
"RTN","GMRAFX",61,0)
 .S ^XTMP("GMRAFX","GMRAR",GMRAUTXT,GMRATXT,GMRAIEN)="" ;Store entry number
"RTN","GMRAFX",62,0)
 .Q
"RTN","GMRAFX",63,0)
 S UP="" F  S UP=$O(^XTMP("GMRAFX","GMRAR",UP)) Q:UP=""  S TXT="" F  S TXT=$O(^XTMP("GMRAFX","GMRAR",UP,TXT)) Q:TXT=""  D
"RTN","GMRAFX",64,0)
 .S VALMCNT=VALMCNT+1
"RTN","GMRAFX",65,0)
 .S SP1=4-$L(VALMCNT),SP2=40-$L(TXT),SP3=16-$L(^XTMP("GMRAFX","GMRAR",UP,TXT))\2 ;Set up spacing before storing
"RTN","GMRAFX",66,0)
 .D SET^VALM10(VALMCNT,VALMCNT_$$REPEAT^XLFSTR(" ",SP1)_TXT_$$REPEAT^XLFSTR(" ",SP2)_$$REPEAT^XLFSTR(" ",SP3)_^XTMP("GMRAFX","GMRAR",UP,TXT))
"RTN","GMRAFX",67,0)
 .S ^XTMP("GMRAFX","IDX",VALMCNT)=UP_"^"_TXT
"RTN","GMRAFX",68,0)
 K ^XTMP("GMRAFX","B") ;Done building
"RTN","GMRAFX",69,0)
 S ^XTMP("GMRAFX",0)=$$FMADD^XLFDT(DT,30)_U_DT_U_$G(VALMCNT)
"RTN","GMRAFX",70,0)
 Q
"RTN","GMRAFX",71,0)
 ;
"RTN","GMRAFX",72,0)
HELP ; -- help code
"RTN","GMRAFX",73,0)
 D FULL^VALM1
"RTN","GMRAFX",74,0)
 W !!,"Use AE to add local allergies to the GMR ALLERGY file.  This",!,"should only be done if you're sure no existing reactant matches your needs."
"RTN","GMRAFX",75,0)
 W !!,"Use EE to mark all entries within the selected group as entered",!,"in error.  You may select multiple groups if you like."
"RTN","GMRAFX",76,0)
 W !!,"Use DD to get a detailed display.  It's highly recommended that you",!,"use the detailed display menu to make all changes."
"RTN","GMRAFX",77,0)
 W !!,"Use UR to update the reactant.  Extreme caution should be used when doing",!,"mass updates.  It would be better to do the updates from within",!,"the detailed display menu.",!
"RTN","GMRAFX",78,0)
 D WAIT^GMRAFX3 S VALMBCK="R"
"RTN","GMRAFX",79,0)
 Q
"RTN","GMRAFX",80,0)
 ;
"RTN","GMRAFX",81,0)
EXIT ; -- exit code
"RTN","GMRAFX",82,0)
 D FULL^VALM1
"RTN","GMRAFX",83,0)
 D DESELECT  ;Clear any remaining items
"RTN","GMRAFX",84,0)
 Q
"RTN","GMRAFX",85,0)
 ;
"RTN","GMRAFX",86,0)
EXPND ; -- expand code
"RTN","GMRAFX",87,0)
 Q
"RTN","GMRAFX",88,0)
 ;
"RTN","GMRAFX",89,0)
CHKSEL ;Evaluate selection if done by number
"RTN","GMRAFX",90,0)
 N J,TMP,DIR,NUM,X,Y,TNMBR
"RTN","GMRAFX",91,0)
 S VALMBCK="R"
"RTN","GMRAFX",92,0)
 S NUM=$P($G(XQORNOD(0)),"=",2) ;get currently selected entries
"RTN","GMRAFX",93,0)
 I NUM'="" D
"RTN","GMRAFX",94,0)
 .I NUM=$G(NMBR) D DESELECT Q  ;If user selects same entry without taking an entry, unhighlight and stop processing
"RTN","GMRAFX",95,0)
 .D DESELECT:$G(NMBR) ;If user previously selected entries but took no action, unhighlight before highlighting new choices
"RTN","GMRAFX",96,0)
 .S NMBR=$P(XQORNOD(0),"=",2),DIR(0)="L^"_"1:"_VALMCNT,X=NMBR,DIR("V")="" D ^DIR K DIR
"RTN","GMRAFX",97,0)
 .I Y="" D FULL^VALM1 W !,"Invalid selection." D WAIT^GMRAFX3 K NMBR Q  ;Selection out of range, stop processing
"RTN","GMRAFX",98,0)
 .S TNMBR=""
"RTN","GMRAFX",99,0)
 .F J=1:1:$L(NMBR,",")-1 S TMP=$P(NMBR,",",J) I $$LOCK^GMRAFX3(TMP) S TNMBR=TNMBR_TMP_"," D CNTRL^VALM10(TMP,1,+$G(VALMWD),IORVON,IORVOFF)
"RTN","GMRAFX",100,0)
 .I TNMBR="" K NMBR Q
"RTN","GMRAFX",101,0)
 .S NMBR=TNMBR
"RTN","GMRAFX",102,0)
 Q
"RTN","GMRAFX",103,0)
 ;
"RTN","GMRAFX",104,0)
DESELECT ;Un-highlight selected choices
"RTN","GMRAFX",105,0)
 N J,TMP
"RTN","GMRAFX",106,0)
 F J=1:1:$L($G(NMBR),",")-1 S TMP=$P(NMBR,",",J) D CNTRL^VALM10(TMP,1,+$G(VALMWD),IORVOFF,IORVOFF) L -^XTMP("GMRAFX","IDX",TMP)
"RTN","GMRAFX",107,0)
 K NMBR
"RTN","GMRAFX",108,0)
 Q
"RTN","GMRAFX",109,0)
 ;
"RTN","GMRAFX",110,0)
AEA ; Entry for GMRA LOCAL ALLERGIES EDIT option
"RTN","GMRAFX",111,0)
 S VALMBCK="R" D FULL^VALM1,PROCESS^GMRAFUT0,WAIT^GMRAFX3 Q  ;23
"RTN","GMRAFX",112,0)
 N DLAYGO,DIC,Y,GMRAIEN,DA,GMRALN,DIE,GMRACT,DR,GMRAX,GMRAY,X
"RTN","GMRAFX",113,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX",114,0)
 W ! S DLAYGO=120.82,DIC="^GMRD(120.82,",DIC("A")="Select a LOCAL ALLERGY/ADVERSE REACTION: ",DIC(0)="AEQML",DIC("DR")="1" D ^DIC K DIC,DLAYGO Q:+Y'>0  S (DA,GMRAIEN)=+Y
"RTN","GMRAFX",115,0)
 L +^GMRD(120.82,GMRAIEN):1 I '$T W !,"THIS ENTRY IS BEING EDITED BY SOMEONE ELSE" Q
"RTN","GMRAFX",116,0)
 S GMRALN=$G(^GMRD(120.82,GMRAIEN,0))
"RTN","GMRAFX",117,0)
 S DIE="^GMRD(120.82,",DR="",GMRACT=1
"RTN","GMRAFX",118,0)
 I +$P(GMRALN,U,3) S DR(1,120.82,1)="@1;W !!,$C(7),""CANNOT EDIT NAME FIELD OF A NATIONAL ALLERGY."",!;3;"
"RTN","GMRAFX",119,0)
 E  D
"RTN","GMRAFX",120,0)
 .S DR(1,120.82,1)=".01;3;"
"RTN","GMRAFX",121,0)
 .S DR(1,120.82,2)="S (GMRAY,GMRAX)=$P(GMRALN,U,2) D EDTTYPE^GMRAUTL(.GMRAX);"
"RTN","GMRAFX",122,0)
 .S DR(1,120.82,3)="S:GMRAX=GMRAY!(""^^""[GMRAX) X=GMRAX,Y=$S(""^^""[GMRAX:""@3"",1:""@4"");1///^S X=GMRAX;@4;4;5;@3;"
"RTN","GMRAFX",123,0)
 .Q
"RTN","GMRAFX",124,0)
 D ^DIE
"RTN","GMRAFX",125,0)
 L -^GMRD(120.82,GMRAIEN)
"RTN","GMRAFX",126,0)
 Q
"RTN","GMRAFX",127,0)
 ;
"RTN","GMRAFX",128,0)
PROCESS(TYPE) ;API to mark all entries as entered in error or update entries to new reactant
"RTN","GMRAFX",129,0)
 N GMRAPA,GMRAI,GMRAJ,DIR,Y,ROOT,NUM,ENTRY,GMRADONE,STOP,J,TNMBR,GMRAAR
"RTN","GMRAFX",130,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX",131,0)
 I '$G(NMBR) S NMBR=$$GETNUM^GMRAFX3("") Q:'+NMBR  D  Q:'+$G(NMBR)
"RTN","GMRAFX",132,0)
 .S TNMBR=""
"RTN","GMRAFX",133,0)
 .F J=1:1:$L(NMBR,",")-1 S TMP=$P(NMBR,",",J) I $$LOCK^GMRAFX3(TMP) S TNMBR=TNMBR_TMP_","
"RTN","GMRAFX",134,0)
 .I TNMBR="" K NMBR Q
"RTN","GMRAFX",135,0)
 .S NMBR=TNMBR
"RTN","GMRAFX",136,0)
 I TYPE="U" W !!,"You should use the detailed display option to review entries in",!,"this group before doing a mass update.  CHANGES CANNOT BE UN-DONE!" D WAIT^GMRAFX3
"RTN","GMRAFX",137,0)
 W !!,"You are about to ",$S(TYPE="E":"mark",1:"update")," ALL allergies with the selected reactant ",!,$S(TYPE="E":"as entered in error.",1:"to a new reactant."),!
"RTN","GMRAFX",138,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="ARE YOU SURE"
"RTN","GMRAFX",139,0)
 S DIR("?")="If you're unsure, use the 'detailed display' option to get a list of individual patients."
"RTN","GMRAFX",140,0)
 S DIR("?",1)="Answering YES to this prompt will cause all allergies associated with"
"RTN","GMRAFX",141,0)
 S DIR("?",2)="the selected reactant to be "_$S(TYPE="E":"marked as entered in error.",1:"updated to the new reactant.")
"RTN","GMRAFX",142,0)
 S DIR("?",3)=""
"RTN","GMRAFX",143,0)
 S DIR("?",4)="Be SURE this is what you want to do."
"RTN","GMRAFX",144,0)
 D ^DIR Q:Y'=1  ;Stop if user doesn't answer yes
"RTN","GMRAFX",145,0)
 F GMRAI=1:1:($L(NMBR,",")-1) D
"RTN","GMRAFX",146,0)
 .S NUM=$P(NMBR,",",GMRAI),ENTRY=^XTMP("GMRAFX","IDX",NUM),STOP=0
"RTN","GMRAFX",147,0)
 .S ROOT="^XTMP(""GMRAFX"",""GMRAR"","_""""_$P(ENTRY,"^")_""""_","_""""_$P(ENTRY,"^",2)_""""_")",GMRAJ=0 Q:'@ROOT
"RTN","GMRAFX",148,0)
 .I TYPE="U" W !!,"Updating ",$P(ENTRY,U)," reactions"
"RTN","GMRAFX",149,0)
 .F  S GMRAJ=$O(@ROOT@(GMRAJ)) Q:GMRAJ=""!($G(STOP))  I GMRAJ D
"RTN","GMRAFX",150,0)
 ..S GMRAPA=GMRAJ,GMRADONE=1 D @$S(TYPE="E":"EIE",1:"UIE^GMRAFX3")
"RTN","GMRAFX",151,0)
 ..D:GMRADONE UPDATE^GMRAFX3
"RTN","GMRAFX",152,0)
 Q
"RTN","GMRAFX",153,0)
 ;
"RTN","GMRAFX",154,0)
EIE ;Mark individual entry as entered in error
"RTN","GMRAFX",155,0)
 N DIE,DA,DR,Y,DIK,DFN,OROLD,VAIN,X,GMRAOUT
"RTN","GMRAFX",156,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR="22///1;23///NOW;24////"_$G(DUZ,.5)
"RTN","GMRAFX",157,0)
 D ^DIE ;Entered in error on date/time by user
"RTN","GMRAFX",158,0)
 D ADCOM(GMRAPA,"E","Marked Entered in Error during clean up process")
"RTN","GMRAFX",159,0)
 I $$NKASCR^GMRANKA($P(^GMR(120.8,GMRAPA,0),U)) D
"RTN","GMRAFX",160,0)
 .S DIK="^GMR(120.86,",DA=$P(^GMR(120.8,GMRAPA,0),U)
"RTN","GMRAFX",161,0)
 .D ^DIK ;If patient's last allergy marked as entered in error then delete assessment
"RTN","GMRAFX",162,0)
 .W !!,"**NOTE: By marking this reaction as entered in error, ",$$GET1^DIQ(2,DA,.01,"E"),!,"no longer has an assessment on file.  You may reassess this patient",!
"RTN","GMRAFX",163,0)
 .W "now by answering the following prompt or hit return to do it later.",!
"RTN","GMRAFX",164,0)
 .D NKAASK^GMRANKA(DA)
"RTN","GMRAFX",165,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAFX",166,0)
 S GMRAOUT=0
"RTN","GMRAFX",167,0)
 D EN1^GMRAEAB ;Sends entered in error bulletin to appropriate mail groups
"RTN","GMRAFX",168,0)
 S DFN=$P(GMRAPA(0),U)
"RTN","GMRAFX",169,0)
 D INP^VADPT S X=$$FIND1^DIC(101,,"BX","GMRA ENTERED IN ERROR")_";ORD(101," ;19
"RTN","GMRAFX",170,0)
 D:X EN^XQOR ;Process protocols hanging off of "entered in error" protocol
"RTN","GMRAFX",171,0)
 Q
"RTN","GMRAFX",172,0)
 ;
"RTN","GMRAFX",173,0)
DECEASED(GMRAIFN) ;Function returns 1 if patient is deceased, 0 if living
"RTN","GMRAFX",174,0)
 N DFN,VADM
"RTN","GMRAFX",175,0)
 Q:GMRAIFN=0 1  ;If no patient entry return true
"RTN","GMRAFX",176,0)
 S DFN=GMRAIFN
"RTN","GMRAFX",177,0)
 D DEM^VADPT
"RTN","GMRAFX",178,0)
 Q $S(+VADM(6):1,1:0)  ;VADM(6) holds date of death
"RTN","GMRAFX",179,0)
 ;
"RTN","GMRAFX",180,0)
ADCOM(ENTRY,TYPE,COM) ;Add comment to allergy
"RTN","GMRAFX",181,0)
 N DIC,DIE,DR,DA,Y,X
"RTN","GMRAFX",182,0)
 S DA(1)=ENTRY
"RTN","GMRAFX",183,0)
 S DIC="^GMR(120.8,"_DA(1)_",26,",DIC(0)="L" F  S X=$$NOW^XLFDT Q:'$D(^GMR(120.8,DA(1),26,"B",X))  ;23 Don't allow duplicate entries
"RTN","GMRAFX",184,0)
 D ^DIC Q:Y=-1  ;add new comment multiple
"RTN","GMRAFX",185,0)
 S DA=+Y
"RTN","GMRAFX",186,0)
 S DIE=DIC K DIC
"RTN","GMRAFX",187,0)
 S DR="1////"_$G(DUZ,.5)_";1.5///"_TYPE_";2///"_$TR(COM,";"," ") ;remove semi-colon from free text
"RTN","GMRAFX",188,0)
 D ^DIE ;Comment added by user
"RTN","GMRAFX",189,0)
 Q
"RTN","GMRAFX2")
0^18^B24928118
"RTN","GMRAFX2",1,0)
GMRAFX2 ;SLC/DAN Select reactant for update ;5/13/05  15:44
"RTN","GMRAFX2",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19,21,23**;Mar 29, 1996
"RTN","GMRAFX2",3,0)
 ;DBIA SECTION
"RTN","GMRAFX2",4,0)
 ;10026 - DIR
"RTN","GMRAFX2",5,0)
 ;2056  - DIQ
"RTN","GMRAFX2",6,0)
 ;221   - PSDRUG("B", and PSDRUG("C", cross references
"RTN","GMRAFX2",7,0)
 ;10104 - XLFSTR
"RTN","GMRAFX2",8,0)
 ;10006 - DIC
"RTN","GMRAFX2",9,0)
 ;2531  - $$T^PSNAPIS
"RTN","GMRAFX2",10,0)
 ;2574  - $$TGTOG^PSNAPIS
"RTN","GMRAFX2",11,0)
 ;
"RTN","GMRAFX2",12,0)
EN1 ; Select new reactant
"RTN","GMRAFX2",13,0)
 N DIR,Y,DIRUT,X,DTOUT,DUOUT,DIC,GMRALAR,D,ENTRY,OK,CNT,LST,ROOT,NAM,DIROUT
"RTN","GMRAFX2",14,0)
 S DIR(0)="FO^3:30",DIR("A")="Enter Causative Agent",DIR("?")="^D HELP^GMRAFX2" D ^DIR S:$D(DIROUT) STOP=1 Q:$D(DIRUT)  S GMRALAR=$$UP^XLFSTR(Y)
"RTN","GMRAFX2",15,0)
NPA S DIC("S")="I $P(^(0),U)'=""OTHER ALLERGY/ADVERSE REACTION""&($S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(120.82,.01,Y_"",""),1:1))" ;21,23
"RTN","GMRAFX2",16,0)
 W !!,"Checking GMR ALLERGIES (#120.82) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 ENTRY=X D DIC ;21
"RTN","GMRAFX2",17,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) Q
"RTN","GMRAFX2",18,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAFX2",19,0)
 K Y,DTOUT,DUOUT,ENTRY
"RTN","GMRAFX2",20,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAFX2",21,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.6,.01,Y_"",""),1:1)" D ^DIC K DIC S:+Y>0 ENTRY=X D DIC ;23
"RTN","GMRAFX2",22,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" Q
"RTN","GMRAFX2",23,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAFX2",24,0)
 K DUOUT,DTOUT,Y,ENTRY
"RTN","GMRAFX2",25,0)
 S ROOT=$$T^PSNAPIS,CNT=0,X=GMRALAR
"RTN","GMRAFX2",26,0)
 I $D(@ROOT@(X)),$S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.6,.01,$$TGTOG^PSNAPIS(X)_","),1:1) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;23 Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAFX2",27,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAFX2",28,0)
 .Q:$S($L($T(SCREEN^XTID)):$$SCREEN^XTID(50.6,.01,$$TGTOG^PSNAPIS(NAM)_","),1:0)  ;23
"RTN","GMRAFX2",29,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAFX2",30,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAFX2",31,0)
 I CNT=1 S Y(0)=LST(1),ENTRY=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAFX2",32,0)
 I CNT>1 D
"RTN","GMRAFX2",33,0)
 .D MATCHES
"RTN","GMRAFX2",34,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAFX2",35,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAFX2",36,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),(ENTRY,X)=$P(Y(0),U,2)
"RTN","GMRAFX2",37,0)
 D DIC
"RTN","GMRAFX2",38,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" Q
"RTN","GMRAFX2",39,0)
 ;Selection from file 50 removed in patch 23
"RTN","GMRAFX2",40,0)
DRUG ;W !!,"Now checking the DRUG (#50) file for matches...",! K Y,DTOUT,DUOUT,ENTRY
"RTN","GMRAFX2",41,0)
 ;S CNT=0,X=GMRALAR K LST
"RTN","GMRAFX2",42,0)
 ;F ROOT="^PSDRUG(""B"")","^PSDRUG(""C"")" D
"RTN","GMRAFX2",43,0)
 ;.I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$O(@ROOT@(X,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(X,0)),.01)_" <"_X_">",1:X) ;Exact match stores IEN in 50
"RTN","GMRAFX2",44,0)
 ;.S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAFX2",45,0)
 ;..S CNT=CNT+1,LST(CNT)=$O(@ROOT@(NAM,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(NAM,0)),.01)_" <"_NAM_">",1:NAM)
"RTN","GMRAFX2",46,0)
 ;I 'CNT S Y=-1 ;No matches found
"RTN","GMRAFX2",47,0)
 ;I CNT=1 S Y(0)=LST(1),ENTRY=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAFX2",48,0)
 ;I CNT>1 D
"RTN","GMRAFX2",49,0)
 ;.D MATCHES
"RTN","GMRAFX2",50,0)
 ;.S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAFX2",51,0)
 ;.S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAFX2",52,0)
 ;.D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),(ENTRY,X)=$P(Y(0),U,2)
"RTN","GMRAFX2",53,0)
 ;D DIC
"RTN","GMRAFX2",54,0)
 ;I +Y>0&($G(OK)) S GMRAAR=+Y(0)_";PSDRUG(",GMRAAR(0)=$$GET1^DIQ(50,+Y(0),.01),GMRAAR("O")="D" Q
"RTN","GMRAFX2",55,0)
 ;19 - Moved ING and CLASS code here from above
"RTN","GMRAFX2",56,0)
ING W !!,"Now checking INGREDIENT (#50.416) file for matches...",! ;23
"RTN","GMRAFX2",57,0)
 K Y,DTOUT,DUOUT,ENTRY S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.416,.01,Y_"",""),1:1)",X=GMRALAR D IX^DIC K DIC S:+Y>0 ENTRY=X D DIC ;23
"RTN","GMRAFX2",58,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" Q
"RTN","GMRAFX2",59,0)
CLASS W !!,"Now checking VA DRUG CLASS (#50.605) file for matches...",! ;23
"RTN","GMRAFX2",60,0)
 K Y,DTOUT,DUOUT,ENTRY S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.605,.01,Y_"",""),1:1)",D="C" D IX^DIC K DIC S:+Y>0 ENTRY=X D DIC ;23
"RTN","GMRAFX2",61,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" Q
"RTN","GMRAFX2",62,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files.",!,"Please try again (check spelling, etc).",!,"If you need to add a new reactant, use the AE option." G EN1
"RTN","GMRAFX2",63,0)
 Q
"RTN","GMRAFX2",64,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAFX2",65,0)
 N DIR,X,Y
"RTN","GMRAFX2",66,0)
 Q:'$D(ENTRY)
"RTN","GMRAFX2",67,0)
 K OK
"RTN","GMRAFX2",68,0)
 W !!,"You selected ",ENTRY
"RTN","GMRAFX2",69,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Is this correct",DIR("?")="Answer yes if this is the correct reactant" D ^DIR S:Y=1 OK=1
"RTN","GMRAFX2",70,0)
 Q
"RTN","GMRAFX2",71,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAFX2",72,0)
 N I,J,QUIT
"RTN","GMRAFX2",73,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAFX2",74,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAFX2",75,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAFX2",76,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAFX2",77,0)
 Q
"RTN","GMRAFX2",78,0)
        ;
"RTN","GMRAFX2",79,0)
MORE()  ; -- show more matches
"RTN","GMRAFX2",80,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAFX2",81,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAFX2",82,0)
 D ^DIR
"RTN","GMRAFX2",83,0)
 Q +Y
"RTN","GMRAFX2",84,0)
 ;
"RTN","GMRAFX2",85,0)
HELP ;Display help for selection of causative agent
"RTN","GMRAFX2",86,0)
 W !,"Enter new causative agent to be assigned to the selected entries."
"RTN","GMRAFX2",87,0)
 W !,"Enter between 3 and 30 characters.  The entered text will then be"
"RTN","GMRAFX2",88,0)
 W !,"searched for in a number of different files.  Select the appropriate"
"RTN","GMRAFX2",89,0)
 W !,"entry from the appropriate file to update the selected patient."
"RTN","GMRAFX2",90,0)
 W !!,"Enter ^ to skip the current patient or ^^ to exit the entire process."
"RTN","GMRAFX2",91,0)
 Q
"RTN","GMRAFX3")
0^8^B36523272
"RTN","GMRAFX3",1,0)
GMRAFX3 ;SLC/DAN Update existing entries to new reactant ;2/24/05  12:11
"RTN","GMRAFX3",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19,23**;Mar 29, 1996
"RTN","GMRAFX3",3,0)
 ;DBIA SECTION
"RTN","GMRAFX3",4,0)
 ;10018 - DIE
"RTN","GMRAFX3",5,0)
 ;2056  - DIQ
"RTN","GMRAFX3",6,0)
 ;3154  - ORQ1
"RTN","GMRAFX3",7,0)
 ;4134  - ORCHECK
"RTN","GMRAFX3",8,0)
 ;4135  - ORKCHK
"RTN","GMRAFX3",9,0)
 ;10026 - DIR
"RTN","GMRAFX3",10,0)
 ;
"RTN","GMRAFX3",11,0)
UIE ;Update individual entries
"RTN","GMRAFX3",12,0)
 N DFN,GMRAOUT,GMRAING,GMRADRCL,DIE,DA,DR,AIFN,SIGN,TIME,SUB,ORX,GMRAORX,GMRAOC,GI,FND,COM,SIEN,DIR,Y
"RTN","GMRAFX3",13,0)
 S GMRADONE=0 ;Flag to keep track of updated entries
"RTN","GMRAFX3",14,0)
 S DFN=$P($G(^GMR(120.8,GMRAPA,0)),U) Q:'+DFN
"RTN","GMRAFX3",15,0)
 W !!,"For patient ",$$GET1^DIQ(2,DFN_",",.01),!
"RTN","GMRAFX3",16,0)
 I $D(GMRAAR) D
"RTN","GMRAFX3",17,0)
 .S DIR(0)="Y",DIR("A")="Use reactant "_GMRAAR(0),DIR("B")="Y" D ^DIR
"RTN","GMRAFX3",18,0)
 .K:'Y GMRAAR
"RTN","GMRAFX3",19,0)
 .Q
"RTN","GMRAFX3",20,0)
 D:'$D(GMRAAR) ^GMRAFX2 Q:'$D(GMRAAR)  ;Get new reactant
"RTN","GMRAFX3",21,0)
 S GMRAOUT=0
"RTN","GMRAFX3",22,0)
 I $$DUP W !,"Patient already has an active allergy for this reactant.",!,"Duplicate not allowed.",! D WAIT Q
"RTN","GMRAFX3",23,0)
 I $$DUPCHK^GMRAPES0(GMRAAR(0),DFN,GMRAPA) Q  ;Checks to see if reactant previously entered in error.
"RTN","GMRAFX3",24,0)
 ;Update reactant, allergy and signed off fields
"RTN","GMRAFX3",25,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR=".02////"_GMRAAR(0)_";1////^S X=GMRAAR"_";3.1////"_GMRAAR("O")_";15///1" D ^DIE
"RTN","GMRAFX3",26,0)
 I $D(^GMR(120.85,"C",GMRAPA)) D  ;Observed reaction, need to update data
"RTN","GMRAFX3",27,0)
 .S AIFN=0
"RTN","GMRAFX3",28,0)
 .F  S AIFN=$O(^GMR(120.85,"C",GMRAPA,AIFN)) Q:'+AIFN  D
"RTN","GMRAFX3",29,0)
 ..S SIEN=$O(^GMR(120.85,AIFN,3,"B",$P(^XTMP("GMRAFX","IDX",+NMBR),"^"),0)) Q:'+SIEN  ;Was previous reactant stored as "suspected agent"
"RTN","GMRAFX3",30,0)
 ..S DA(1)=AIFN,DA=SIEN
"RTN","GMRAFX3",31,0)
 ..S DIE="^GMR(120.85,DA(1),3,",DR=".01////^S X=GMRAAR(0)" D ^DIE ;Update suspected agent to new value
"RTN","GMRAFX3",32,0)
 D DELMUL(2),DELMUL(3) ;Delete drug ingredient/drug classes multiples
"RTN","GMRAFX3",33,0)
 I GMRAAR("O")["D" D UPDATE^GMRAPES1 ;If reactant type is Drug then add appropriate ingredients and classes
"RTN","GMRAFX3",34,0)
 S GMRADONE=1 ;Update complete
"RTN","GMRAFX3",35,0)
 S COM="Updated using clean up process.  Changed reactant from "_$P(^XTMP("GMRAFX","IDX",+NMBR),"^",2)_" (free text) "_"to "_GMRAAR(0)_"(file - "_$P(GMRAAR,";",2)_")"
"RTN","GMRAFX3",36,0)
 D ADCOM^GMRAFX(GMRAPA,"O",COM) ;Add a comment for this update
"RTN","GMRAFX3",37,0)
 ;Do order checking here - compare existing orders against new allergy information.
"RTN","GMRAFX3",38,0)
 W !,"Performing order checking..."
"RTN","GMRAFX3",39,0)
 K ^TMP("ORR",$J),GMRAOC,ORX
"RTN","GMRAFX3",40,0)
 D EN^ORQ1(DFN_";DPT(") ;Retrieve active orders
"RTN","GMRAFX3",41,0)
 S TIME=$O(^TMP("ORR",$J,0))
"RTN","GMRAFX3",42,0)
 Q:'^TMP("ORR",$J,TIME,"TOT")  ;No orders found
"RTN","GMRAFX3",43,0)
 S SUB=0 F  S SUB=$O(^TMP("ORR",$J,TIME,SUB)) Q:'+SUB  D
"RTN","GMRAFX3",44,0)
 .D BLD^ORCHECK(+^TMP("ORR",$J,TIME,SUB)) ;Get "order" information in order checking format
"RTN","GMRAFX3",45,0)
 M GMRAORX=ORX K ORX ;19
"RTN","GMRAFX3",46,0)
 D EN^ORKCHK(.GMRAOC,DFN,.GMRAORX,"ACCEPT")
"RTN","GMRAFX3",47,0)
 S GI=0,FND=0 F  S GI=$O(GMRAOC(GI)) Q:'+GI  D
"RTN","GMRAFX3",48,0)
 .Q:$P(GMRAOC(GI),U,2)'=3  ;Quit if not allergy related
"RTN","GMRAFX3",49,0)
 .Q:$D(^OR(100,$P(GMRAOC(GI),U),9,"B",3))  ;23 If order check exists can't be for this data
"RTN","GMRAFX3",50,0)
 .W !,"Patient has a(n) ",$P($$STATUS^ORQOR2($P(GMRAOC(GI),U)),U,2)," order for",$P($P(GMRAOC(GI),U,4),":",2),", order #",$P(GMRAOC(GI),U)
"RTN","GMRAFX3",51,0)
 .S FND=1
"RTN","GMRAFX3",52,0)
 W:'FND "No problems found"
"RTN","GMRAFX3",53,0)
 D WAIT
"RTN","GMRAFX3",54,0)
 Q
"RTN","GMRAFX3",55,0)
 ;
"RTN","GMRAFX3",56,0)
DELMUL(FIELD) ;Delete multiple FIELD from GMR ALLERGY file
"RTN","GMRAFX3",57,0)
 N MIEN,DA,DIE,DR
"RTN","GMRAFX3",58,0)
 S MIEN=0 F  S MIEN=$O(^GMR(120.8,GMRAPA,FIELD,MIEN)) Q:'+MIEN  D
"RTN","GMRAFX3",59,0)
 .S DA(1)=GMRAPA,DA=MIEN
"RTN","GMRAFX3",60,0)
 .S DIE="^GMR(120.8,DA(1),FIELD,",DR=".01///@" D ^DIE ;Delete entry
"RTN","GMRAFX3",61,0)
 Q
"RTN","GMRAFX3",62,0)
 ;
"RTN","GMRAFX3",63,0)
DUP() ;Function returns true (1) if selected reactant is a duplicate
"RTN","GMRAFX3",64,0)
 N LOOP,FND
"RTN","GMRAFX3",65,0)
 S LOOP=0,FND=0
"RTN","GMRAFX3",66,0)
 F  S LOOP=$O(^GMR(120.8,"B",DFN,LOOP)) Q:'+LOOP!(FND)  D
"RTN","GMRAFX3",67,0)
 .I $P(^GMR(120.8,LOOP,0),U,3)=GMRAAR&('$D(^GMR(120.8,LOOP,"ER"))) S FND=1
"RTN","GMRAFX3",68,0)
 Q FND
"RTN","GMRAFX3",69,0)
 ;
"RTN","GMRAFX3",70,0)
WAIT ;Issues press enter to return prompt
"RTN","GMRAFX3",71,0)
 N DIR
"RTN","GMRAFX3",72,0)
 S DIR(0)="E",DIR("A")="Press enter to continue" D ^DIR
"RTN","GMRAFX3",73,0)
 Q
"RTN","GMRAFX3",74,0)
 ;
"RTN","GMRAFX3",75,0)
GETNUM(ACTION) ; -- Return numbers to act on, if action chosen first
"RTN","GMRAFX3",76,0)
 N X,Y,DIR,MAX
"RTN","GMRAFX3",77,0)
 S MAX=$S($D(^TMP($J,"IDX2")):$G(^TMP($J,"IDX2",0)),1:$G(VALMCNT)) Q:MAX'>0 ""
"RTN","GMRAFX3",78,0)
 I ACTION="DET" W !!,"Please choose only one entry for the detailed display."
"RTN","GMRAFX3",79,0)
 S DIR(0)="LAO^1:"_MAX,DIR("A")="Select Entries from list: "
"RTN","GMRAFX3",80,0)
 S DIR("?")="Enter the items you wish to act on, as a range or list of numbers."
"RTN","GMRAFX3",81,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","GMRAFX3",82,0)
 I $D(Y(1)) W !,">>>Too many entries selected, try using smaller ranges" H 2 S Y="^"
"RTN","GMRAFX3",83,0)
 I $L($G(Y),",")>2,ACTION="DET" W !,">>You may only choose ONE group for detailed display." H 2 S Y="^"
"RTN","GMRAFX3",84,0)
 Q Y
"RTN","GMRAFX3",85,0)
 ;
"RTN","GMRAFX3",86,0)
UPDATE ;Update display to account for changes to the list
"RTN","GMRAFX3",87,0)
 N CNT,SP1,SP2,SP3
"RTN","GMRAFX3",88,0)
 I VALMAR["GMRADET" N VALMAR S VALMAR="^XTMP(""GMRAFX"")"
"RTN","GMRAFX3",89,0)
 S CNT=^XTMP("GMRAFX","GMRAR",$P(ENTRY,U),$P(ENTRY,U,2))-1
"RTN","GMRAFX3",90,0)
 S ^XTMP("GMRAFX","GMRAR",$P(ENTRY,U),$P(ENTRY,U,2))=CNT K ^($P(ENTRY,U,2),GMRAJ)
"RTN","GMRAFX3",91,0)
 S SP1=4-$L(+NUM),SP2=40-$L($P(ENTRY,U)),SP3=$S(CNT:16-$L(CNT)\2,1:2)
"RTN","GMRAFX3",92,0)
 D SET^VALM10(+NUM,+NUM_$$REPEAT^XLFSTR(" ",SP1)_$P(ENTRY,U,2)_$$REPEAT^XLFSTR(" ",(SP2+SP3))_$S(CNT:CNT,1:"** FIXED **"))
"RTN","GMRAFX3",93,0)
 Q
"RTN","GMRAFX3",94,0)
 ;
"RTN","GMRAFX3",95,0)
LOCK(ENTRY) ;Lock entry in 120.8
"RTN","GMRAFX3",96,0)
 N LOCK
"RTN","GMRAFX3",97,0)
 S LOCK=1
"RTN","GMRAFX3",98,0)
 L +^XTMP("GMRAFX","IDX",ENTRY):1
"RTN","GMRAFX3",99,0)
 I '$T D FULL^VALM1 S VALMBCK="R" W !,"The ",$P(^XTMP("GMRAFX","IDX",ENTRY),U)," group is being edited by another user" D WAIT S LOCK=0
"RTN","GMRAFX3",100,0)
 Q LOCK
"RTN","GMRAFX3",101,0)
 ;
"RTN","GMRAFX3",102,0)
AR ;Add/edit patient reactions
"RTN","GMRAFX3",103,0)
 N LCV,DFN,SUB
"RTN","GMRAFX3",104,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX3",105,0)
 W !!,"You should use this option to add NEW reactions only.  If you mark"
"RTN","GMRAFX3",106,0)
 W !,"existing free text entries as entered in error from within this option it will"
"RTN","GMRAFX3",107,0)
 W !,"not update the utility's display until the list is rebuilt upon re-entry"
"RTN","GMRAFX3",108,0)
 W !,"of this option.  This could cause confusion as the list will no longer"
"RTN","GMRAFX3",109,0)
 W !,"be accurate.",!
"RTN","GMRAFX3",110,0)
 I '$G(NMBR2) D WAIT,EN1^GMRAPEM0 Q
"RTN","GMRAFX3",111,0)
 F LCV=1:1:$L(NMBR2,",")-1 S SUB=$P(NMBR2,",",LCV) S DFN=+$P($G(^GMR(120.8,+$P($G(^TMP($J,"IDX2",SUB)),U,2),0)),U) I DFN W !!,"Now working with patient ",$$GET1^DIQ(2,DFN,.01),! D WAIT D EN2^GMRAPEM0
"RTN","GMRAFX3",112,0)
 Q
"RTN","GMRAFX3",113,0)
 ;
"RTN","GMRAFX3",114,0)
DSPREACT ;Display detailed information about the free text reactant
"RTN","GMRAFX3",115,0)
 N DIC,DA,GMRAI,STOP,NUM2,DIR,Y
"RTN","GMRAFX3",116,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX3",117,0)
 I '$G(NMBR2) S NMBR2=$$GETNUM("") Q:'+NMBR2
"RTN","GMRAFX3",118,0)
 F GMRAI=1:1:($L(NMBR2,",")-1) D  Q:$G(STOP)
"RTN","GMRAFX3",119,0)
 .S NUM2=$P(NMBR2,",",GMRAI)
"RTN","GMRAFX3",120,0)
 .S DA=$P(^TMP($J,"IDX2",NUM2),U,2) Q:'DA
"RTN","GMRAFX3",121,0)
 .S DIC="^GMR(120.8,"
"RTN","GMRAFX3",122,0)
 .W ! D EN^DIQ
"RTN","GMRAFX3",123,0)
 .S DIR(0)="E",DIR("A")="Press return to continue or '^' to stop" D ^DIR
"RTN","GMRAFX3",124,0)
 .S:$D(DIRUT) STOP=1
"RTN","GMRAFX3",125,0)
 .Q
"RTN","GMRAFX3",126,0)
 Q
"RTN","GMRAIAD1")
0^12^B71618059
"RTN","GMRAIAD1",1,0)
GMRAIAD1 ;BPOIFO/JG - BUILD HL7 ORU^R01 MESSAGE FOR ADVERSE REACTION - PART 1 ; 18 Feb 2005  2:54 PM
"RTN","GMRAIAD1",2,0)
 ;;4.0;Adverse Reaction Tracking;**22,23**;Mar 29, 1996
"RTN","GMRAIAD1",3,0)
VALID ;;VDEF HL7 MESSAGE BUILDER
"RTN","GMRAIAD1",4,0)
 ; Creates HL7 V2.4 ORU^R01 message for allergy adverse reaction
"RTN","GMRAIAD1",5,0)
 ;
"RTN","GMRAIAD1",6,0)
 ; This routines uses the following IAs:
"RTN","GMRAIAD1",7,0)
 ;   #4248 - VDEFEL calls        (controlled)
"RTN","GMRAIAD1",8,0)
 ;   #3630 - VAFCQRY calls       (controlled)
"RTN","GMRAIAD1",9,0)
 ;   #2196 - ^PS(50.416,IEN,0)   (controlled)
"RTN","GMRAIAD1",10,0)
 ;   #4571 - ERR^VDEFREQ         (controlled)
"RTN","GMRAIAD1",11,0)
 ;
"RTN","GMRAIAD1",12,0)
 ; This routine is called at tag EN as a Function by VDEFREQ1
"RTN","GMRAIAD1",13,0)
 ;
"RTN","GMRAIAD1",14,0)
 ; This routine calls GMRAIAD2 for a portion of message
"RTN","GMRAIAD1",15,0)
 ;
"RTN","GMRAIAD1",16,0)
 Q
"RTN","GMRAIAD1",17,0)
 ;
"RTN","GMRAIAD1",18,0)
EN(EVIEN,KEY,VFLAG,OUT,MSHP) ;
"RTN","GMRAIAD1",19,0)
 ;
"RTN","GMRAIAD1",20,0)
 ; Inputs: EVIEN = IEN of message in file 577
"RTN","GMRAIAD1",21,0)
 ;      KEY - IEN of file to create message from
"RTN","GMRAIAD1",22,0)
 ;      VFLAG - "V" for VistA HL7 destination (default)
"RTN","GMRAIAD1",23,0)
 ;      OUT - target array, passed by reference
"RTN","GMRAIAD1",24,0)
 ;      MSHP - Piece 4 contains message subtype
"RTN","GMRAIAD1",25,0)
 ;
"RTN","GMRAIAD1",26,0)
 ; Output: Two part string with parts separated by "^"
"RTN","GMRAIAD1",27,0)
 ;      Part 1: "LM" - output in local array passed in "OUT" parameter
"RTN","GMRAIAD1",28,0)
 ;              "GM" - output in ^TMP("HLS",$J)
"RTN","GMRAIAD1",29,0)
 ;      Part 2: No longer used
"RTN","GMRAIAD1",30,0)
 ;
"RTN","GMRAIAD1",31,0)
 N DFN,HLFS,HLCM,HLSC,HLRP,HLES,HLQ,ALRDATA,DTE,DTP,ADD
"RTN","GMRAIAD1",32,0)
 N DATA,VAL,I,S,X,Y,Z,X1,X2,HL7RC,IEN,OUTX,LIKE,LIKERSP,GMRAPID,SEQ
"RTN","GMRAIAD1",33,0)
 N SEPF,SEPC,SEPR,SEPE,SEPS,ARRAY,PTC,CMP,GMRAHL
"RTN","GMRAIAD1",34,0)
 ;
"RTN","GMRAIAD1",35,0)
 ; Initialize stuff
"RTN","GMRAIAD1",36,0)
 K ^TMP("HLS",$J) S S=0,ARRAY="OUT("_"""HLS"""_",S)",TARGET="LM^"
"RTN","GMRAIAD1",37,0)
 M GMRAHL=VDEFHL
"RTN","GMRAIAD1",38,0)
 ;
"RTN","GMRAIAD1",39,0)
 ; Set up HL7 delimiters
"RTN","GMRAIAD1",40,0)
 S HLCM=$E(GMRAHL("ECH")),HLRP=$E(GMRAHL("ECH"),2),HLSC=$E(GMRAHL("ECH"),4),HLES=$E(GMRAHL("ECH"),3)
"RTN","GMRAIAD1",41,0)
 S HLFS=GMRAHL("FS"),HLQ=GMRAHL("Q"),HL7RC=HLES_HLFS_HLCM_HLRP_HLSC
"RTN","GMRAIAD1",42,0)
 D SETDLMS^VDEFEL
"RTN","GMRAIAD1",43,0)
 ;
"RTN","GMRAIAD1",44,0)
 ; Get allergy data & patient ID
"RTN","GMRAIAD1",45,0)
 S ALRDATA=$G(^GMR(120.85,KEY,0))
"RTN","GMRAIAD1",46,0)
 I ALRDATA="" D ERR^VDEFREQ("No data in file GMR(120.85) for IEN "_KEY) S ZTSTOP=1 G EXIT
"RTN","GMRAIAD1",47,0)
 S DFN=$P(ALRDATA,U,2)
"RTN","GMRAIAD1",48,0)
 I $G(^DPT(DFN,0))="" D ERR^VDEFREQ("No data in file DPT for DFN "_DFN) S ZTSTOP=1 G EXIT
"RTN","GMRAIAD1",49,0)
 ;
"RTN","GMRAIAD1",50,0)
 ; Build segments for message in OUT, $P # = HL7 field #
"RTN","GMRAIAD1",51,0)
 ;
"RTN","GMRAIAD1",52,0)
 ; PID - Use MPI PID builder
"RTN","GMRAIAD1",53,0)
PID K GMRAPID S OUTX="",S=1,SEQ=""
"RTN","GMRAIAD1",54,0)
 D BLDPID^VAFCQRY(DFN,1,SEQ,.GMRAPID,.GMRAHL)
"RTN","GMRAIAD1",55,0)
 F I=2:1 Q:$G(GMRAPID(I))=""  S GMRAPID(1,I-1)=GMRAPID(I) K GMRAPID(I)
"RTN","GMRAIAD1",56,0)
 M OUTX=GMRAPID(1) K GMRAPID D SAVE
"RTN","GMRAIAD1",57,0)
 ;
"RTN","GMRAIAD1",58,0)
 ; OBR
"RTN","GMRAIAD1",59,0)
OBR S S=S+1,OUTX="",$P(OUTX,HLFS)=1,$P(OUTX,HLFS,25)="F"
"RTN","GMRAIAD1",60,0)
 S VAL=KEY_HLCM_$P(SITEPARM,U,6)_"_120.85",$P(OUTX,HLFS,3)=VAL
"RTN","GMRAIAD1",61,0)
 S $P(OUTX,HLFS,4)="ADVERSE REACTION REPORT"_HLCM_HLCM_"L"
"RTN","GMRAIAD1",62,0)
 ;
"RTN","GMRAIAD1",63,0)
 ;Date/time reaction occured
"RTN","GMRAIAD1",64,0)
 S $P(OUTX,HLFS,7)=$$TS^VDEFEL($P(ALRDATA,U,1))
"RTN","GMRAIAD1",65,0)
 ;
"RTN","GMRAIAD1",66,0)
 ; Entering User
"RTN","GMRAIAD1",67,0)
 S VAL=$$XCN200^VDEFEL($P(ALRDATA,U,19)),$P(VAL,HLCM,8)="ENT",$P(OUTX,HLFS,32)=VAL
"RTN","GMRAIAD1",68,0)
 ;
"RTN","GMRAIAD1",69,0)
 ; Observer (Witness)
"RTN","GMRAIAD1",70,0)
 S VAL=$$XCN200^VDEFEL($P(ALRDATA,U,13)),$P(VAL,HLCM,8)="OBS"
"RTN","GMRAIAD1",71,0)
 ;
"RTN","GMRAIAD1",72,0)
 ; Reporter
"RTN","GMRAIAD1",73,0)
 S X=$P($G(^GMR(120.85,KEY,"RPT")),U,1)
"RTN","GMRAIAD1",74,0)
 S X=HLCM_$P(X,",",1)_HLCM_$P($P(X,",",2)," ",1)_HLCM_$P($P(X,",",2)," ",2)
"RTN","GMRAIAD1",75,0)
 S $P(X,HLCM,8)="RPT",$P(OUTX,HLFS,34)=VAL_HLRP_X
"RTN","GMRAIAD1",76,0)
 ;
"RTN","GMRAIAD1",77,0)
 ; Related Reaction
"RTN","GMRAIAD1",78,0)
 S X=$P(ALRDATA,U,15)_HLCM_$P($G(^GMR(120.8,$P(ALRDATA,U,15),0)),U,2)_HLCM_"L"
"RTN","GMRAIAD1",79,0)
 S $P(OUTX,HLFS,47)=X
"RTN","GMRAIAD1",80,0)
 S OUTX="OBR"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",81,0)
 ;
"RTN","GMRAIAD1",82,0)
 ; OBX 1 - Symptoms
"RTN","GMRAIAD1",83,0)
OBX1 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"SYMPTOM"_HLFS
"RTN","GMRAIAD1",84,0)
 ;
"RTN","GMRAIAD1",85,0)
 ; Get the reactions
"RTN","GMRAIAD1",86,0)
 S X=0,(Y,Z)="" F  S X=$O(^GMR(120.85,KEY,2,X))  Q:X'?1N.N  D
"RTN","GMRAIAD1",87,0)
 . S Y=^GMR(120.85,KEY,2,X,0),VAL=$P(Y,U,3)
"RTN","GMRAIAD1",88,0)
 . I $P(Y,U,2)'="" S Z=Z_$P(Y,U,2)_HLRP
"RTN","GMRAIAD1",89,0)
 . E  S Z=Z_$P(^GMRD(120.83,+Y,0),U,1)_HLRP
"RTN","GMRAIAD1",90,0)
 S $P(OUTX,HLFS,5)=$E(Z,1,$L(Z)-1)
"RTN","GMRAIAD1",91,0)
 ;
"RTN","GMRAIAD1",92,0)
 ; Severity
"RTN","GMRAIAD1",93,0)
 S $P(OUTX,HLFS,8)=$$GET1^DIQ(120.85,KEY_",",14.5)
"RTN","GMRAIAD1",94,0)
 ;
"RTN","GMRAIAD1",95,0)
 ; Reaction entered by
"RTN","GMRAIAD1",96,0)
 S $P(OUTX,HLFS,16)=$$XCN200^VDEFEL(VAL)
"RTN","GMRAIAD1",97,0)
 S $P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD1",98,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",99,0)
 ;
"RTN","GMRAIAD1",100,0)
 ; RXA/RXE/RXR/OBX Suspected Agent Group
"RTN","GMRAIAD1",101,0)
 G OBX2:$G(^GMR(120.85,KEY,3,1,0))="" S IEN=0
"RTN","GMRAIAD1",102,0)
RXAGRP1 F  S IEN=$O(^GMR(120.85,KEY,3,IEN)) Q:IEN'?1N.N  D
"RTN","GMRAIAD1",103,0)
 . S S=S+1,OUTX="0"_HLFS_"1" K ALRDATA M ALRDATA=^GMR(120.85,KEY,3,IEN)
"RTN","GMRAIAD1",104,0)
 . ;
"RTN","GMRAIAD1",105,0)
 . ; RXA
"RTN","GMRAIAD1",106,0)
 . ; Start & Stop dates
"RTN","GMRAIAD1",107,0)
 . S VAL=$P($G(ALRDATA(1)),U) I VAL S $P(OUTX,HLFS,3)=$$TS^VDEFEL(VAL)
"RTN","GMRAIAD1",108,0)
 . S VAL=$P($G(ALRDATA(1)),U,2) I VAL S $P(OUTX,HLFS,4)=$$TS^VDEFEL(VAL)
"RTN","GMRAIAD1",109,0)
 . ;
"RTN","GMRAIAD1",110,0)
 . ; Suspected agent & daily dose
"RTN","GMRAIAD1",111,0)
 . S VAL=$P(ALRDATA(0),U),$P(OUTX,HLFS,5)=$$HL7RC(VAL)
"RTN","GMRAIAD1",112,0)
 . S VAL=$P(ALRDATA(0),U,2),$P(OUTX,HLFS,6)=$$HL7RC(VAL)
"RTN","GMRAIAD1",113,0)
 . ;
"RTN","GMRAIAD1",114,0)
 . ; Lot number, Exp. Date, Manufacturer
"RTN","GMRAIAD1",115,0)
 . S VAL=$P(ALRDATA(0),U,8) S:VAL $P(OUTX,HLFS,15)=$$HL7RC(VAL)
"RTN","GMRAIAD1",116,0)
 . S VAL=$P($G(ALRDATA(1)),U,3) I VAL S $P(OUTX,HLFS,16)=$$TS^VDEFEL(VAL)
"RTN","GMRAIAD1",117,0)
 . S VAL=$P(ALRDATA(0),U,7) S:VAL $P(OUTX,HLFS,17)=$$HL7RC(VAL)
"RTN","GMRAIAD1",118,0)
 . ;
"RTN","GMRAIAD1",119,0)
 . ; Indication for use
"RTN","GMRAIAD1",120,0)
 . S VAL=$P(ALRDATA(0),U,4) S:VAL $P(OUTX,HLFS,19)=$$HL7RC(VAL)
"RTN","GMRAIAD1",121,0)
 . ;
"RTN","GMRAIAD1",122,0)
 . ; Set into array
"RTN","GMRAIAD1",123,0)
 . S OUTX="RXA"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",124,0)
 . ;
"RTN","GMRAIAD1",125,0)
 . ; RXE
"RTN","GMRAIAD1",126,0)
 . S S=S+1,OUTX="",CMP=""
"RTN","GMRAIAD1",127,0)
 . ;
"RTN","GMRAIAD1",128,0)
 . ; Previous doses
"RTN","GMRAIAD1",129,0)
 . S $P(CMP,HLCM,1)=$$HL7RC($P(ALRDATA(0),U,9))
"RTN","GMRAIAD1",130,0)
 . ;
"RTN","GMRAIAD1",131,0)
 . ; Duration
"RTN","GMRAIAD1",132,0)
 . S X1=$P($G(ALRDATA(1)),U,2),X2=$P($G(ALRDATA(1)),U) D ^%DTC S:X="" X=0 S $P(CMP,HLCM,3)=X
"RTN","GMRAIAD1",133,0)
 . ;
"RTN","GMRAIAD1",134,0)
 . ; Last date given
"RTN","GMRAIAD1",135,0)
 . S VAL=$P(ALRDATA(0),U,10) I VAL S $P(CMP,HLCM,5)=$$TS^VDEFEL(VAL)
"RTN","GMRAIAD1",136,0)
 . S $P(OUTX,HLFS)=CMP,CMP=""
"RTN","GMRAIAD1",137,0)
 . ;
"RTN","GMRAIAD1",138,0)
 . ; Give codes
"RTN","GMRAIAD1",139,0)
 . S VAL=$P(ALRDATA(0),U),$P(CMP,HLCM,1)=$$HL7RC(VAL)
"RTN","GMRAIAD1",140,0)
 . S $P(CMP,HLCM,4)=$P($G(ALRDATA(1)),U,4),$P(CMP,HLCM,6)="NDC"
"RTN","GMRAIAD1",141,0)
 . S $P(OUTX,HLFS,2)=CMP,$P(OUTX,HLFS,3)=0
"RTN","GMRAIAD1",142,0)
 . ;
"RTN","GMRAIAD1",143,0)
 . ; SIG
"RTN","GMRAIAD1",144,0)
 . S $P(OUTX,HLFS,7)=$$HL7RC($P($G(ALRDATA(1)),U,5))
"RTN","GMRAIAD1",145,0)
 . ;
"RTN","GMRAIAD1",146,0)
 . ; Daily dose
"RTN","GMRAIAD1",147,0)
 . S $P(OUTX,HLFS,19)=$$HL7RC($P(ALRDATA(0),U,2))
"RTN","GMRAIAD1",148,0)
 . S OUTX="RXE"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",149,0)
 . ;
"RTN","GMRAIAD1",150,0)
 . ; RXR
"RTN","GMRAIAD1",151,0)
 . ; Route of administration
"RTN","GMRAIAD1",152,0)
 . S OUTX="",VAL=$P(ALRDATA(0),U,3) S:VAL="" VAL="UNKNOWN" S $P(OUTX,HLFS,1)=$$HL7RC(VAL)
"RTN","GMRAIAD1",153,0)
 . S S=S+1,OUTX="RXR"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",154,0)
 . ;
"RTN","GMRAIAD1",155,0)
 . ; OBX - LIKES
"RTN","GMRAIAD1",156,0)
 . S LIKERSP=$G(ALRDATA("LIKE")) I LIKERSP'="" F LIKE=1:1:6 D
"RTN","GMRAIAD1",157,0)
 . . S S=S+1,OUTX=1_HLFS_"CE"_HLFS
"RTN","GMRAIAD1",158,0)
 . . S VAL="LIKE "_LIKE_HLCM_$P($T(LIKEQ+(LIKE)),";",3),$P(OUTX,HLFS,3)=VAL
"RTN","GMRAIAD1",159,0)
 . . S X=$P(LIKERSP,U,LIKE),X=$S(X="y":"Y",X="n":"N",1:""),VAL=X_HLCM
"RTN","GMRAIAD1",160,0)
 . . S X=$S(X="Y":"YES",X="N":"NO",1:"")
"RTN","GMRAIAD1",161,0)
 . . S VAL=VAL_X_HLCM_"HL70136",$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD1",162,0)
 . . S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",163,0)
 . . ;
"RTN","GMRAIAD1",164,0)
 . ; Likelihood
"RTN","GMRAIAD1",165,0)
 . S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"LIKELIHOOD"
"RTN","GMRAIAD1",166,0)
 . S VAL=$P(LIKERSP,U,7) S:VAL="" VAL=5
"RTN","GMRAIAD1",167,0)
 . S X=VAL_HLCM_$P("REMOTE,POSSIBLE,PROBABLE,HIGHLY PROBABLE, ",",",VAL)
"RTN","GMRAIAD1",168,0)
 . S $P(OUTX,HLFS,5)=X,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD1",169,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",170,0)
 ;
"RTN","GMRAIAD1",171,0)
 ; OBX2 - Lab Results
"RTN","GMRAIAD1",172,0)
OBX2 S X=$G(^GMR(120.85,KEY,4,0)) G CALL:X=""
"RTN","GMRAIAD1",173,0)
 S IEN=0 F  S IEN=$O(^GMR(120.85,KEY,4,IEN)) Q:IEN'?1N.N  D
"RTN","GMRAIAD1",174,0)
 . S S=S+1,OUTX=1_HLFS_"CE"_HLFS
"RTN","GMRAIAD1",175,0)
 . S X=^GMR(120.85,KEY,4,IEN,0),$P(OUTX,HLFS,3)=$$HL7RC($P(X,U,1))
"RTN","GMRAIAD1",176,0)
 . S $P(OUTX,HLFS,5)=$$HL7RC($P(X,U,2)),$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD1",177,0)
 . S $P(OUTX,HLFS,14)=$$TS^VDEFEL($P(X,U,3))
"RTN","GMRAIAD1",178,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",179,0)
 ;
"RTN","GMRAIAD1",180,0)
 ; Call GMRAIAD2
"RTN","GMRAIAD1",181,0)
CALL D ENTRY^GMRAIAD2
"RTN","GMRAIAD1",182,0)
 ;
"RTN","GMRAIAD1",183,0)
 ; OBX10 - IND/NDA Info
"RTN","GMRAIAD1",184,0)
OBX10 S X=$G(^GMR(120.85,KEY,"MFR2")) G RXAGRP2:X=""
"RTN","GMRAIAD1",185,0)
 S S=S+1,OUTX=1_HLFS_"ST",$P(OUTX,HLFS,5)=$P(X,U,1)
"RTN","GMRAIAD1",186,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",187,0)
 ;
"RTN","GMRAIAD1",188,0)
 ; RXA/RXE Concommitant Drugs Group
"RTN","GMRAIAD1",189,0)
RXAGRP2 S X=$G(^GMR(120.85,KEY,13,0)) G EXIT:X=""
"RTN","GMRAIAD1",190,0)
 S IEN=0 F  S IEN=$O(^GMR(120.85,KEY,13,IEN)) Q:IEN'?1N.N  D
"RTN","GMRAIAD1",191,0)
 . ;
"RTN","GMRAIAD1",192,0)
 . ; RXA
"RTN","GMRAIAD1",193,0)
 . S X=^GMR(120.85,KEY,13,IEN,0),S=S+1,OUTX=0_HLFS_1
"RTN","GMRAIAD1",194,0)
 . ;
"RTN","GMRAIAD1",195,0)
 . ; Start Date, Stop Date
"RTN","GMRAIAD1",196,0)
 . I $P(X,U,2)'="" S $P(OUTX,HLFS,3)=$$TS^VDEFEL($P(X,U,2))
"RTN","GMRAIAD1",197,0)
 . I $P(X,U,3)'="" S $P(OUTX,HLFS,4)=$$TS^VDEFEL($P(X,U,3))
"RTN","GMRAIAD1",198,0)
 . ;
"RTN","GMRAIAD1",199,0)
 . ; Drug Name
"RTN","GMRAIAD1",200,0)
 . S $P(OUTX,HLFS,5)=$$HL7RC($P(X,U,1)),$P(OUTX,HLFS,6)=0
"RTN","GMRAIAD1",201,0)
 . S OUTX="RXA"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",202,0)
 . ;
"RTN","GMRAIAD1",203,0)
 . ; RXE
"RTN","GMRAIAD1",204,0)
 . ; Stop Date
"RTN","GMRAIAD1",205,0)
 . S S=S+1,OUTX="",VAL=$$TS^VDEFEL($P(X,U,3))
"RTN","GMRAIAD1",206,0)
 . S Y="",$P(Y,HLCM,5)=VAL,$P(OUTX,HLFS,1)=Y
"RTN","GMRAIAD1",207,0)
 . ;
"RTN","GMRAIAD1",208,0)
 . ; Drug Name
"RTN","GMRAIAD1",209,0)
 . S $P(OUTX,HLFS,2)=$$HL7RC($P(X,U,1)),$P(OUTX,HLFS,3)=0
"RTN","GMRAIAD1",210,0)
 . ;
"RTN","GMRAIAD1",211,0)
 . ; SIG if known
"RTN","GMRAIAD1",212,0)
 . S $P(OUTX,HLFS,5)="UNK",$P(OUTX,HLFS,7)=$$HL7RC($P(X,U,5))
"RTN","GMRAIAD1",213,0)
 . S OUTX="RXE"_HLFS_OUTX D SAVE
"RTN","GMRAIAD1",214,0)
 ;
"RTN","GMRAIAD1",215,0)
 ; Done building segments
"RTN","GMRAIAD1",216,0)
EXIT Q TARGET
"RTN","GMRAIAD1",217,0)
 ;
"RTN","GMRAIAD1",218,0)
 ;
"RTN","GMRAIAD1",219,0)
 ; Place current string into message array
"RTN","GMRAIAD1",220,0)
 ; Turn string into array if length >245.
"RTN","GMRAIAD1",221,0)
 ; Move local array to global if needed
"RTN","GMRAIAD1",222,0)
SAVE N I
"RTN","GMRAIAD1",223,0)
 I $P(OUTX,HLFS)'="PID",$L(OUTX)>245 D
"RTN","GMRAIAD1",224,0)
 . K ADD S ADD=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX))
"RTN","GMRAIAD1",225,0)
 . F I=1:1 S ADD(I)=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX)) Q:OUTX=""
"RTN","GMRAIAD1",226,0)
 . K OUTX M OUTX=ADD
"RTN","GMRAIAD1",227,0)
 M @ARRAY=OUTX
"RTN","GMRAIAD1",228,0)
 ;
"RTN","GMRAIAD1",229,0)
 ; Move local array to global if it's getting big.
"RTN","GMRAIAD1",230,0)
 I $P(TARGET,U)="LM",$S<16000 D
"RTN","GMRAIAD1",231,0)
 . K ^TMP("HLS",$J) M ^TMP("HLS",$J)=OUT("HLS") K OUT("HLS")
"RTN","GMRAIAD1",232,0)
 . S $P(TARGET,U)="GM",ARRAY="^TMP("_"""HLS"""_",$J,S)"
"RTN","GMRAIAD1",233,0)
 K OUTX,ADD
"RTN","GMRAIAD1",234,0)
 Q
"RTN","GMRAIAD1",235,0)
 ;
"RTN","GMRAIAD1",236,0)
 ; Replace any HL7 coding chars. in strings with HL7 escape sequence
"RTN","GMRAIAD1",237,0)
 ; Input: X = data string
"RTN","GMRAIAD1",238,0)
HL7RC(X) N OCHR,RCHR,RCHRI,TYPE,I F TYPE="E","F","C","R","S" D
"RTN","GMRAIAD1",239,0)
 . S RCHRI=$S(TYPE="E":1,TYPE="F":2,TYPE="C":3,TYPE="R":4,TYPE="S":5)
"RTN","GMRAIAD1",240,0)
 . S OCHR=$E(HL7RC,RCHRI),RCHR=$E("EFSRT",RCHRI)
"RTN","GMRAIAD1",241,0)
 . Q:'$F(X,OCHR)
"RTN","GMRAIAD1",242,0)
 . F I=1:1 Q:$E(X,I)=""  I $E(X,I)=OCHR S X=$E(X,1,I-1)_HLES_RCHR_HLES_$E(X,I+1,999),I=I+2
"RTN","GMRAIAD1",243,0)
 Q X
"RTN","GMRAIAD1",244,0)
 ;
"RTN","GMRAIAD1",245,0)
LIKEQ ; LIKE set
"RTN","GMRAIAD1",246,0)
 ;;1. Reaction normally occurs with this reactant?
"RTN","GMRAIAD1",247,0)
 ;;2. Administration of the reactant was stopped?
"RTN","GMRAIAD1",248,0)
 ;;3. Reaction stopped when the administration of the reactant was terminated?
"RTN","GMRAIAD1",249,0)
 ;;4. Reactant was re-administered?
"RTN","GMRAIAD1",250,0)
 ;;5. Reaction could be due to the patient current clinical condition?
"RTN","GMRAIAD1",251,0)
 ;;6. Reaction reappeared after the reactant was re-administered?
"RTN","GMRAIAD2")
0^13^B17674891
"RTN","GMRAIAD2",1,0)
GMRAIAD2 ;BPOIFO/JG - BUILD HL7 ORU^R01 MESSAGE FOR ADVERSE REACTION - PART 2 ; 5 Oct 2005 8:57 AM
"RTN","GMRAIAD2",2,0)
 ;;4.0;Adverse Reaction Tracking;**22,23**;Mar 29, 1996
"RTN","GMRAIAD2",3,0)
 ; Creates HL7 V2.4 ORU^R01 message for allergy adverse reaction
"RTN","GMRAIAD2",4,0)
 ;
"RTN","GMRAIAD2",5,0)
 ; This routine uses the following IAs:
"RTN","GMRAIAD2",6,0)
 ;   #4248 - VDEFEL calls        (conrolled)
"RTN","GMRAIAD2",7,0)
 ;   #3630 - VAFCQRY calls       (controlled)
"RTN","GMRAIAD2",8,0)
 ;   #2196 - ^PS(50.416,IEN,0)   (controlled)
"RTN","GMRAIAD2",9,0)
 ;
"RTN","GMRAIAD2",10,0)
 ; This routine is called as a subroutine by GMRAIAD1
"RTN","GMRAIAD2",11,0)
 ;
"RTN","GMRAIAD2",12,0)
 Q
"RTN","GMRAIAD2",13,0)
 ;
"RTN","GMRAIAD2",14,0)
ENTRY ; Entry point from GMRAIAD1
"RTN","GMRAIAD2",15,0)
 ;
"RTN","GMRAIAD2",16,0)
 ; OBX3 - QUESTIONS 1 thru 10
"RTN","GMRAIAD2",17,0)
OBX3 S Y="",ALRDATA=^GMR(120.85,KEY,0)
"RTN","GMRAIAD2",18,0)
 F I=3:1:7,9:1:11,16,17 S Y=Y_$P(ALRDATA,U,I)_U
"RTN","GMRAIAD2",19,0)
 F I=1:1:10 D
"RTN","GMRAIAD2",20,0)
 . Q:$P(Y,U,I)=""  S S=S+1,OUTX=1_HLFS_"CE"_HLFS
"RTN","GMRAIAD2",21,0)
 . S VAL="Q"_I_HLCM_$P($T(QSTNS+(I)),";",3),$P(OUTX,HLFS,3)=VAL
"RTN","GMRAIAD2",22,0)
 . S X=$P(Y,U,I),X=$S(X="y":"Y",X="n":"N",1:""),VAL=X_HLCM
"RTN","GMRAIAD2",23,0)
 . S X=$S(X="Y":"YES",X="N":"NO",1:"")
"RTN","GMRAIAD2",24,0)
 . S VAL=VAL_X_HLCM_"HL70136",$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD2",25,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",26,0)
 ;
"RTN","GMRAIAD2",27,0)
 ; OBX4 - # Days in Hospital
"RTN","GMRAIAD2",28,0)
OBX4 S X=$P(ALRDATA,U,8)+0 G OBX5:X=0
"RTN","GMRAIAD2",29,0)
 S S=S+1,OUTX=1_HLFS_"NM"_HLFS_"DAYS IN HOSPITAL"
"RTN","GMRAIAD2",30,0)
 S $P(OUTX,HLFS,5)=X,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD2",31,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",32,0)
 ;
"RTN","GMRAIAD2",33,0)
 ; OBX5 - Other related history
"RTN","GMRAIAD2",34,0)
OBX5 S X=$G(^GMR(120.85,KEY,14,1,0)) G OBX6:X=""
"RTN","GMRAIAD2",35,0)
 F I=2:1 S Y=$G(^GMR(120.85,KEY,14,I,0)) Q:Y=""  S X=X_" "_Y
"RTN","GMRAIAD2",36,0)
 S S=S+1,OUTX=1_HLFS_"TX"_HLFS_"Other History"_HLFS_HLFS_$$HL7RC^GMRAIAD1(X)
"RTN","GMRAIAD2",37,0)
 S $P(OUTX,HLFS,11)="F",OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",38,0)
 ;
"RTN","GMRAIAD2",39,0)
 ; OBX6 - FDA Questions
"RTN","GMRAIAD2",40,0)
OBX6 S PTC=$G(^GMR(120.85,KEY,"PTC1")) G OBX8:PTC=""
"RTN","GMRAIAD2",41,0)
 F I=1:1:5 D
"RTN","GMRAIAD2",42,0)
 . S S=S+1,OUTX=1_HLFS_"CE"_HLFS
"RTN","GMRAIAD2",43,0)
 . S VAL="FDAQ"_I_HLCM_$P($T(FDAQ+I),";",3),$P(OUTX,HLFS,3)=VAL
"RTN","GMRAIAD2",44,0)
 . S VAL=$P(PTC,U,I+(I=5*8)),VAL=VAL_HLCM_$S(VAL="y":"Yes",VAL="n":"No",1:"Unknown")_HLCM_"HL70136"
"RTN","GMRAIAD2",45,0)
 . S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F",OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",46,0)
 ;
"RTN","GMRAIAD2",47,0)
 ; OBX7 - P & T Questions
"RTN","GMRAIAD2",48,0)
OBX7 F I=1:1:3 D
"RTN","GMRAIAD2",49,0)
 . S S=S+1,OUTX=1_HLFS_"CE"_HLFS,Y=$$HL7RC^GMRAIAD1("P&T")_" ACTION "
"RTN","GMRAIAD2",50,0)
 . S Y=Y_$P("FDA^MFR^RCPM",U,I)_" REPORT",VAL="PTQ"_I_HLCM_Y,$P(OUTX,HLFS,3)=VAL
"RTN","GMRAIAD2",51,0)
 . S VAL=$P(X,U,I+8),VAL=VAL_HLCM_$S(VAL="y":"Yes",VAL="n":"No",1:"Unknown")_HLCM_"HL70136"
"RTN","GMRAIAD2",52,0)
 . S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F",OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",53,0)
 ;
"RTN","GMRAIAD2",54,0)
 ; OBX8 - P & T Addendum
"RTN","GMRAIAD2",55,0)
OBX8 S PTC=$O(^GMR(120.85,KEY,"PTC2",0)) G OBX9:PTC="" S IEN=0
"RTN","GMRAIAD2",56,0)
 S VAL=$$TS^VDEFEL(^GMR(120.85,KEY,"PTC2",1,0))
"RTN","GMRAIAD2",57,0)
 F  S IEN=$O(^GMR(120.85,KEY,"PTC2",1,1,IEN)) Q:IEN=""  D
"RTN","GMRAIAD2",58,0)
 . S S=S+1,OUTX=1_HLFS_"TX"_HLFS_$$HL7RC^GMRAIAD1("P&T Addendum")
"RTN","GMRAIAD2",59,0)
 . S $P(OUTX,HLFS,5)=$$HL7RC^GMRAIAD1(^GMR(120.85,KEY,"PTC2",1,1,IEN,0))
"RTN","GMRAIAD2",60,0)
 . S $P(OUTX,HLFS,11)="F",$P(OUTX,HLFS,14)=VAL
"RTN","GMRAIAD2",61,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",62,0)
 ;
"RTN","GMRAIAD2",63,0)
 ; OBX9 - Notification Dates
"RTN","GMRAIAD2",64,0)
OBX9 S VAL=$P(^GMR(120.85,KEY,0),U,12) I VAL'="" D
"RTN","GMRAIAD2",65,0)
 . ;
"RTN","GMRAIAD2",66,0)
 . ; Date MD notified
"RTN","GMRAIAD2",67,0)
 . S VAL=$$TS^VDEFEL(VAL) S S=S+1,OUTX=1_HLFS_"DT"_HLFS_"DATE MD NOTIFIED"
"RTN","GMRAIAD2",68,0)
 . S $P(OUTX,5,HLFS)=VAL,$P(OUTX,11,HLFS)="F"
"RTN","GMRAIAD2",69,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",70,0)
 ;
"RTN","GMRAIAD2",71,0)
 ; Dates reported to FDA, MFR, RCPM, VAERS
"RTN","GMRAIAD2",72,0)
 S PTC=$G(^GMR(120.85,KEY,"PTC1")) G RETURN:PTC=""
"RTN","GMRAIAD2",73,0)
 F I=1:1:5 S VAL=$P(PTC,U,I+4) I VAL'="" D
"RTN","GMRAIAD2",74,0)
 . S VAL=$$TS^VDEFEL(VAL) S S=S+1,OUTX=1_HLFS_"DT"_HLFS_$P($T(RPTXT+I),";",3)
"RTN","GMRAIAD2",75,0)
 . S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMRAIAD2",76,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAD1
"RTN","GMRAIAD2",77,0)
 ;
"RTN","GMRAIAD2",78,0)
 ; Return to GMRAIAD1
"RTN","GMRAIAD2",79,0)
RETURN Q
"RTN","GMRAIAD2",80,0)
 ;
"RTN","GMRAIAD2",81,0)
QSTNS ; Question 1-10 Set
"RTN","GMRAIAD2",82,0)
 ;;Patient died from reaction?
"RTN","GMRAIAD2",83,0)
 ;;Patient treated with RX drug?
"RTN","GMRAIAD2",84,0)
 ;;Life threatening illness?
"RTN","GMRAIAD2",85,0)
 ;;Required ER/MD visit?
"RTN","GMRAIAD2",86,0)
 ;;Required hospitalization?
"RTN","GMRAIAD2",87,0)
 ;;Prolonged hospitalization?
"RTN","GMRAIAD2",88,0)
 ;;Resulted in permanent disability?
"RTN","GMRAIAD2",89,0)
 ;;Patient recovered?
"RTN","GMRAIAD2",90,0)
 ;;Is this event a congenital anomaly?
"RTN","GMRAIAD2",91,0)
 ;;Did this event require intervention to prevent impairment or damage?
"RTN","GMRAIAD2",92,0)
 ;
"RTN","GMRAIAD2",93,0)
FDAQ ; FDA Questions
"RTN","GMRAIAD2",94,0)
 ;;Serious ADR?
"RTN","GMRAIAD2",95,0)
 ;;ADR related to new drug? (Marketed within last 2 yrs.)
"RTN","GMRAIAD2",96,0)
 ;;Unexpected ADR?
"RTN","GMRAIAD2",97,0)
 ;;ADR related to therapeutic failure?
"RTN","GMRAIAD2",98,0)
 ;;Dose related?
"RTN","GMRAIAD2",99,0)
 ;
"RTN","GMRAIAD2",100,0)
RPTXT ; Dates Reported Texts
"RTN","GMRAIAD2",101,0)
 ;;DATE REPORTED TO FDA
"RTN","GMRAIAD2",102,0)
 ;;DATE OF PATIENT CONSENT TO MFR
"RTN","GMRAIAD2",103,0)
 ;;DATE SENT TO MFR
"RTN","GMRAIAD2",104,0)
 ;;DATE SENT TO RCPM
"RTN","GMRAIAD2",105,0)
 ;;DATE SENT TO VAERS
"RTN","GMRAIAL1")
0^14^B32654103
"RTN","GMRAIAL1",1,0)
GMRAIAL1 ;BPOIFO/JG - BUILD HL7 ORU^R01 MESSAGE FOR ALLERGIES - PART 1 ; 21 Jun 2005  8:41 AM
"RTN","GMRAIAL1",2,0)
 ;;4.0;Adverse Reaction Tracking;**22,23**;Mar 29, 1996
"RTN","GMRAIAL1",3,0)
VALID ;;VDEF HL7 MESSAGE BUILDER
"RTN","GMRAIAL1",4,0)
 ; Creates HL7 V2.4 ORU^R01 message for allergy updates & assessments
"RTN","GMRAIAL1",5,0)
 ;
"RTN","GMRAIAL1",6,0)
 ; This routine uses the following IAs:
"RTN","GMRAIAL1",7,0)
 ;   #4248 - VDEFEL calls       (controlled)
"RTN","GMRAIAL1",8,0)
 ;   #3630 - VAFCQRY calls      (controlled)
"RTN","GMRAIAL1",9,0)
 ;   #2196 - ^PS(50.416,IEN,0)  (controlled)
"RTN","GMRAIAL1",10,0)
 ;   #2574 - $$CLASS2^PSNAPIS   (supported)
"RTN","GMRAIAL1",11,0)
 ;   #4571 - ERR^VDEFREQ        (controlled)
"RTN","GMRAIAL1",12,0)
 ;   #4631 - XTID calls         (supported)
"RTN","GMRAIAL1",13,0)
 ;
"RTN","GMRAIAL1",14,0)
 ; This routine is called at tag EN as a Function by VDEFREQ1
"RTN","GMRAIAL1",15,0)
 ;
"RTN","GMRAIAL1",16,0)
 ; This routine calls GMRAIAL2 for a portion of message
"RTN","GMRAIAL1",17,0)
 ;
"RTN","GMRAIAL1",18,0)
 Q
"RTN","GMRAIAL1",19,0)
 ;
"RTN","GMRAIAL1",20,0)
EN(EVIEN,KEY,VFLAG,OUT,MSHP) ; Entry point
"RTN","GMRAIAL1",21,0)
 ;
"RTN","GMRAIAL1",22,0)
 ; Inputs: EVIEN = IEN of VDEF Event in file 577
"RTN","GMRAIAL1",23,0)
 ;         KEY - IEN of file to create message from
"RTN","GMRAIAL1",24,0)
 ;         VFLAG - "V" for VistA HL7 destination (default)
"RTN","GMRAIAL1",25,0)
 ;         OUT - target array, passed by reference
"RTN","GMRAIAL1",26,0)
 ;         MSHP - Piece 4 contains message sutbtype
"RTN","GMRAIAL1",27,0)
 ;
"RTN","GMRAIAL1",28,0)
 ; Output: Two part string with parts separated by "^"
"RTN","GMRAIAL1",29,0)
 ;         Part 1: "LM" - output in local array passed in "OUT" parameter
"RTN","GMRAIAL1",30,0)
 ;                 "GM" - output in ^TMP("HLS",$J)
"RTN","GMRAIAL1",31,0)
 ;         Part 2: No longer used
"RTN","GMRAIAL1",32,0)
 ;
"RTN","GMRAIAL1",33,0)
 N DFN,HLFS,HLCM,HLSC,HLRP,HLES,HLQ,ALRDATA,ADD,ALTYPE
"RTN","GMRAIAL1",34,0)
 N DATA,VAL,I,S,X,Y,Z,X1,HL7RC,IEN,IEN1,OUTX,GMRAPID,ENTERR
"RTN","GMRAIAL1",35,0)
 N SEPF,SEPC,SEPR,SEPE,SEPS,ARRAY,CMP,SEQ,GMRAHL,RSLTSTA
"RTN","GMRAIAL1",36,0)
 N GMRAFILE,GMRAIENS,GMRAVUID
"RTN","GMRAIAL1",37,0)
 ;
"RTN","GMRAIAL1",38,0)
 ; Initialize stuff
"RTN","GMRAIAL1",39,0)
 K ^TMP("HLS",$J) S S=0,ARRAY="OUT("_"""HLS"""_",S)",TARGET="LM^"
"RTN","GMRAIAL1",40,0)
 M GMRAHL=VDEFHL
"RTN","GMRAIAL1",41,0)
 ;
"RTN","GMRAIAL1",42,0)
 ; Determine whether API was Allergy Update or Assessment
"RTN","GMRAIAL1",43,0)
 S ALTYPE=$S($P(MSHP,"~",4)="ALGY":1,$P(MSHP,"~",4)="ADAS":2,1:1)
"RTN","GMRAIAL1",44,0)
 ;
"RTN","GMRAIAL1",45,0)
 ; Set up HL7 delimiters
"RTN","GMRAIAL1",46,0)
 S HLCM=$E(GMRAHL("ECH")),HLRP=$E(GMRAHL("ECH"),2),HLSC=$E(GMRAHL("ECH"),4),HLES=$E(GMRAHL("ECH"),3)
"RTN","GMRAIAL1",47,0)
 S HLFS=GMRAHL("FS"),HLQ=GMRAHL("Q"),HL7RC=HLES_HLFS_HLCM_HLRP_HLSC
"RTN","GMRAIAL1",48,0)
 D SETDLMS^VDEFEL
"RTN","GMRAIAL1",49,0)
 ;
"RTN","GMRAIAL1",50,0)
 ; Get allergy data, patient ID, 'entered in error data'
"RTN","GMRAIAL1",51,0)
 ; based on whether it's an allergy update or an assessment
"RTN","GMRAIAL1",52,0)
 ; Allergy: ALTYPE=1, Assessment: ALTYPE=2
"RTN","GMRAIAL1",53,0)
 D:ALTYPE=1  G EXIT:ZTSTOP=1
"RTN","GMRAIAL1",54,0)
 . S ALRDATA=$G(^GMR(120.8,KEY,0))
"RTN","GMRAIAL1",55,0)
 . I ALRDATA="" D ERR^VDEFREQ("No data in file GMR(120.8) for IEN "_KEY) S ZTSTOP=1 Q
"RTN","GMRAIAL1",56,0)
 . S DFN=$P(ALRDATA,U),ENTERR=$G(^GMR(120.8,KEY,"ER"))
"RTN","GMRAIAL1",57,0)
 . S RSLTSTA=$E("FW",1+(ENTERR'=""))
"RTN","GMRAIAL1",58,0)
 . I $G(^DPT(DFN,0))="" D ERR^VDEFREQ("No data in file DPT for DFN "_DFN) S ZTSTOP=1 Q
"RTN","GMRAIAL1",59,0)
 D:ALTYPE=2  G EXIT:ZTSTOP=1
"RTN","GMRAIAL1",60,0)
 . S ENTERR="",ALRDATA=$G(^GMR(120.86,KEY,0))
"RTN","GMRAIAL1",61,0)
 . I $P(ALRDATA,U,2)="" S ENTERR=1
"RTN","GMRAIAL1",62,0)
 . S DFN=$S(ENTERR=1:KEY,1:$P(ALRDATA,U))
"RTN","GMRAIAL1",63,0)
 . I $G(^DPT(DFN,0))="" D ERR^VDEFREQ("No data in file DPT for DFN "_DFN) S ZTSTOP=1 Q
"RTN","GMRAIAL1",64,0)
 ;
"RTN","GMRAIAL1",65,0)
 ; Build segments for message in OUT, $P # = HL7 field #
"RTN","GMRAIAL1",66,0)
 ;
"RTN","GMRAIAL1",67,0)
 ; PID - Use MPI PID builder
"RTN","GMRAIAL1",68,0)
PID K GMRAPID S OUTX="",S=1,SEQ=""
"RTN","GMRAIAL1",69,0)
 D BLDPID^VAFCQRY(DFN,1,SEQ,.GMRAPID,.GMRAHL)
"RTN","GMRAIAL1",70,0)
 F I=2:1 Q:$G(GMRAPID(I))=""  S GMRAPID(1,I-1)=GMRAPID(I) K GMRAPID(I)
"RTN","GMRAIAL1",71,0)
 M OUTX=GMRAPID(1) K GMRAPID D SAVE
"RTN","GMRAIAL1",72,0)
 ;
"RTN","GMRAIAL1",73,0)
 ; OBR
"RTN","GMRAIAL1",74,0)
OBR S S=S+1,OUTX="",$P(OUTX,HLFS)=1
"RTN","GMRAIAL1",75,0)
 S $P(OUTX,HLFS,3)=KEY_HLCM_$P(SITEPARM,U,6)_$S(ALTYPE=1:"_120.8",ALTYPE=2:"_120.86")
"RTN","GMRAIAL1",76,0)
 S $P(OUTX,HLFS,4)=$P("ALLERGY,ASSESSMENT",",",ALTYPE)_HLCM_HLCM_"L"
"RTN","GMRAIAL1",77,0)
 ;
"RTN","GMRAIAL1",78,0)
 ; Result Status
"RTN","GMRAIAL1",79,0)
 S $P(OUTX,HLFS,25)=$E("FE",1+(ENTERR'=""))
"RTN","GMRAIAL1",80,0)
 ;
"RTN","GMRAIAL1",81,0)
 ; Date/time reaction entered in system
"RTN","GMRAIAL1",82,0)
 S $P(OUTX,HLFS,7)=$$TS^VDEFEL($P(ALRDATA,U,4))
"RTN","GMRAIAL1",83,0)
 ;
"RTN","GMRAIAL1",84,0)
 ; Originator for allergy
"RTN","GMRAIAL1",85,0)
 S VAL=$P(ALRDATA,U,$P("5^3",U,ALTYPE))
"RTN","GMRAIAL1",86,0)
 I VAL'="" S $P(OUTX,HLFS,32)=$$XCN200^VDEFEL(VAL)
"RTN","GMRAIAL1",87,0)
 G OBRX:ALTYPE=2
"RTN","GMRAIAL1",88,0)
 ;
"RTN","GMRAIAL1",89,0)
 ; Repeating field of various person roles
"RTN","GMRAIAL1",90,0)
 ; Enterer, Verifier, Error User, ID Band Marker, Chart Marker
"RTN","GMRAIAL1",91,0)
 ; and associated dates
"RTN","GMRAIAL1",92,0)
 S (X,Y,Z)=""
"RTN","GMRAIAL1",93,0)
ENT S VAL=$P(ALRDATA,U,5) G VER:VAL=""
"RTN","GMRAIAL1",94,0)
 S VAL=$$XCN200^VDEFEL(VAL),VAL=$TR(VAL,HLCM,HLSC),$P(VAL,HLSC,8)="E",Z=VAL
"RTN","GMRAIAL1",95,0)
 S $P(Z,HLCM,2)=$$TS^VDEFEL($P(ALRDATA,U,4)),X=Z
"RTN","GMRAIAL1",96,0)
VER G ERR:$P(ALRDATA,U,17)=""
"RTN","GMRAIAL1",97,0)
 S VAL=$$XCN200^VDEFEL($P(ALRDATA,U,18)),VAL=$TR(VAL,HLCM,HLSC),$P(VAL,HLSC,8)="V",Z=VAL
"RTN","GMRAIAL1",98,0)
 S $P(Z,HLCM,2)=$$TS^VDEFEL($P(ALRDATA,U,17)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",99,0)
ERR S VAL=$P(ENTERR,U,3) G IDBM:VAL=""
"RTN","GMRAIAL1",100,0)
 S VAL=$$XCN200^VDEFEL(VAL),VAL=$TR(VAL,HLCM,HLSC),$P(VAL,HLSC,8)="EE",Z=VAL
"RTN","GMRAIAL1",101,0)
 S $P(Z,HLCM,2)=$$TS^VDEFEL($P(ENTERR,U,2)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",102,0)
 ;
"RTN","GMRAIAL1",103,0)
 ; May be multiple entries for ID Band & Chart Marker persons
"RTN","GMRAIAL1",104,0)
IDBM G CHRT:'$D(^GMR(120.8,KEY,14))
"RTN","GMRAIAL1",105,0)
 S IEN1=0 F  S IEN1=$O(^GMR(120.8,KEY,14,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL1",106,0)
 . S X1=$G(^GMR(120.8,KEY,14,IEN1,0)),VAL=$$XCN200^VDEFEL($P(X1,U,2))
"RTN","GMRAIAL1",107,0)
 . S VAL=$TR(VAL,HLCM,HLSC) S:VAL="" VAL=Y S $P(VAL,HLSC,8)="BM",Z=VAL
"RTN","GMRAIAL1",108,0)
 . S $P(Z,HLCM,2)=$$TS^VDEFEL($P(X1,U,1)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",109,0)
CHRT G OBR1:'$D(^GMR(120.8,KEY,13))
"RTN","GMRAIAL1",110,0)
 S IEN1=0 F  S IEN1=$O(^GMR(120.8,KEY,13,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL1",111,0)
 . S X1=$G(^GMR(120.8,KEY,13,IEN1,0)),VAL=$$XCN200^VDEFEL($P(X1,U,2))
"RTN","GMRAIAL1",112,0)
 . S VAL=$TR(VAL,HLCM,HLSC) S:VAL="" VAL=Y S $P(VAL,HLSC,8)="CM",Z=VAL
"RTN","GMRAIAL1",113,0)
 . S $P(Z,HLCM,2)=$$TS^VDEFEL($P(X1,U,1)),X=$G(X)_HLRP_Z
"RTN","GMRAIAL1",114,0)
OBR1 S $P(OUTX,HLFS,34)=X
"RTN","GMRAIAL1",115,0)
 ;
"RTN","GMRAIAL1",116,0)
 ; Observed/Historical Indicator
"RTN","GMRAIAL1",117,0)
 S X=$P(ALRDATA,U,6),GMRAVUID=$$GETVUID(120.8,6,X)
"RTN","GMRAIAL1",118,0)
 S VAL=$P(GMRAVUID,U)_HLCM_$S(X="o":"OBSERVED",X="h":"HISTORICAL",1:"")
"RTN","GMRAIAL1",119,0)
 S VAL=VAL_HLCM_$P(GMRAVUID,U,2)
"RTN","GMRAIAL1",120,0)
 S $P(OUTX,HLFS,47)=VAL
"RTN","GMRAIAL1",121,0)
OBRX S OUTX="OBR"_HLFS_OUTX D SAVE
"RTN","GMRAIAL1",122,0)
 ;
"RTN","GMRAIAL1",123,0)
 ; If the record is missing both the Reactant and the GMR Allergy
"RTN","GMRAIAL1",124,0)
 ; trap it as an error.
"RTN","GMRAIAL1",125,0)
 I ALTYPE'=2,$P(ALRDATA,U,2)="",$P(ALRDATA,U,3)="" D ERR^VDEFREQ("Record is missing Reactant and GMR Allergy") S ZTSTOP=1 Q
"RTN","GMRAIAL1",126,0)
 ;
"RTN","GMRAIAL1",127,0)
 ; OK to continue, call GMRAIAL2 for the rest of the message
"RTN","GMRAIAL1",128,0)
CALL D ENTRY^GMRAIAL2
"RTN","GMRAIAL1",129,0)
 ;
"RTN","GMRAIAL1",130,0)
 ; Done building segments
"RTN","GMRAIAL1",131,0)
EXIT Q TARGET
"RTN","GMRAIAL1",132,0)
 ;
"RTN","GMRAIAL1",133,0)
 ;
"RTN","GMRAIAL1",134,0)
 ; Place current string into message array.
"RTN","GMRAIAL1",135,0)
 ; Turn string into array if length >245.
"RTN","GMRAIAL1",136,0)
 ; Move local array to global if needed.
"RTN","GMRAIAL1",137,0)
SAVE N I
"RTN","GMRAIAL1",138,0)
 I $P(OUTX,HLFS)'="PID",$L(OUTX)>245 D
"RTN","GMRAIAL1",139,0)
 . K ADD S ADD=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX))
"RTN","GMRAIAL1",140,0)
 . F I=1:1 S ADD(I)=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX)) Q:OUTX=""
"RTN","GMRAIAL1",141,0)
 . K OUTX M OUTX=ADD
"RTN","GMRAIAL1",142,0)
 M @ARRAY=OUTX
"RTN","GMRAIAL1",143,0)
 ;
"RTN","GMRAIAL1",144,0)
 ; Move local array to global if it's getting big.
"RTN","GMRAIAL1",145,0)
 I $P(TARGET,U)="LM",$S<16000 D
"RTN","GMRAIAL1",146,0)
 . K ^TMP("HLS",$J) M ^TMP("HLS",$J)=OUT("HLS") K OUT("HLS")
"RTN","GMRAIAL1",147,0)
 . S $P(TARGET,U)="GM",ARRAY="^TMP("_"""HLS"""_",$J,S)"
"RTN","GMRAIAL1",148,0)
 K OUTX,ADD
"RTN","GMRAIAL1",149,0)
 Q
"RTN","GMRAIAL1",150,0)
 ;
"RTN","GMRAIAL1",151,0)
 ; Replace any HL7 coding chars. in strings with HL7 escape sequence
"RTN","GMRAIAL1",152,0)
 ; Input: X = data string
"RTN","GMRAIAL1",153,0)
HL7RC(X) N OCHR,RCHR,RCHRI,TYPE,I F TYPE="E","F","C","R","S" D
"RTN","GMRAIAL1",154,0)
 . S RCHRI=$S(TYPE="E":1,TYPE="F":2,TYPE="C":3,TYPE="R":4,TYPE="S":5)
"RTN","GMRAIAL1",155,0)
 . S OCHR=$E(HL7RC,RCHRI),RCHR=$E("EFSRT",RCHRI)
"RTN","GMRAIAL1",156,0)
 . Q:'$F(X,OCHR)
"RTN","GMRAIAL1",157,0)
 . F I=1:1 Q:$E(X,I)=""  I $E(X,I)=OCHR S X=$E(X,1,I-1)_HLES_RCHR_HLES_$E(X,I+1,999),I=I+2
"RTN","GMRAIAL1",158,0)
 Q X
"RTN","GMRAIAL1",159,0)
 ;
"RTN","GMRAIAL1",160,0)
 ; Get the VUID value and set up name of coding system
"RTN","GMRAIAL1",161,0)
GETVUID(GMRAFILE,GMRAFLD,GMRADATA,GMRAFLSW) ;
"RTN","GMRAIAL1",162,0)
 ; Input parameters:
"RTN","GMRAIAL1",163,0)
 ;  GMRAFILE - VistA File #
"RTN","GMRAIAL1",164,0)
 ;  GMRAFLD  - Field # in GMRAFILE
"RTN","GMRAIAL1",165,0)
 ;  GMRADATA - Reference value to look up VUID for
"RTN","GMRAIAL1",166,0)
 ;  GMRAFLSW - (Optional) Use 8985.1 if nil, else use GMRAFILE
"RTN","GMRAIAL1",167,0)
 ;
"RTN","GMRAIAL1",168,0)
 ; Output parameter:
"RTN","GMRAIAL1",169,0)
 ;  1st '^' piece - VUID # or 0 if no VUID
"RTN","GMRAIAL1",170,0)
 ;  2nd '^' piece - Coding system: "99VA8985.1" if VUID and GMRAFLSW=nil
"RTN","GMRAIAL1",171,0)
 ;                                 "99VA"_GMRAFILE if GMRAFLSW=1
"RTN","GMRAIAL1",172,0)
 ;                  else = <site_VistA application file #> if no VUID
"RTN","GMRAIAL1",173,0)
 N X S X=+$$GETVUID^XTID(GMRAFILE,GMRAFLD,GMRADATA),GMRAFLSW=$G(GMRAFLSW)
"RTN","GMRAIAL1",174,0)
 I X S $P(X,U,2)="99VA"_$S(GMRAFLSW:GMRAFILE,1:"8985.1")
"RTN","GMRAIAL1",175,0)
 E  S $P(X,U,2)=$P(SITEPARM,U,6)_"_"_GMRAFILE
"RTN","GMRAIAL1",176,0)
 Q X
"RTN","GMRAIAL2")
0^15^B32309600
"RTN","GMRAIAL2",1,0)
GMRAIAL2 ;BPOIFO/JG - BUILD HL7 ORU^R01 MESSAGE FOR ALLERGIES - PART 2 ; 21 Jun 2005  8:41 AM
"RTN","GMRAIAL2",2,0)
 ;;4.0;Adverse Reaction Tracking;**22,23**;Mar 29, 1996
"RTN","GMRAIAL2",3,0)
 ; Creates HL7 V2.4 ORU^R01 message for allergy updates & assessments
"RTN","GMRAIAL2",4,0)
 ;
"RTN","GMRAIAL2",5,0)
 ; This routine uses the following IAs:
"RTN","GMRAIAL2",6,0)
 ;   #4248 - VDEFEL calls       (controlled)
"RTN","GMRAIAL2",7,0)
 ;   #3630 - VAFCQRY calls       (controlled)
"RTN","GMRAIAL2",8,0)
 ;   #2196 -  ^PS(50.416,IEN,0)  (controlled)
"RTN","GMRAIAL2",9,0)
 ;   #2574 - $$CLASS2^PSNAPIS    (supported)
"RTN","GMRAIAL2",10,0)
 ;
"RTN","GMRAIAL2",11,0)
 ; This routine is called as a subroutine by GMRAIAL1
"RTN","GMRAIAL2",12,0)
 ;
"RTN","GMRAIAL2",13,0)
 Q
"RTN","GMRAIAL2",14,0)
 ;
"RTN","GMRAIAL2",15,0)
ENTRY ; Entry point from GMRAIAL1
"RTN","GMRAIAL2",16,0)
 ;
"RTN","GMRAIAL2",17,0)
 ; Skip to OBX8 if doing an assessment
"RTN","GMRAIAL2",18,0)
 G OBX8:ALTYPE=2
"RTN","GMRAIAL2",19,0)
 ;
"RTN","GMRAIAL2",20,0)
 ; OBX 1 - Reactant
"RTN","GMRAIAL2",21,0)
OBX1 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"AGENT"_HLFS
"RTN","GMRAIAL2",22,0)
 S $P(OUTX,HLFS,5)=$$HL7RC^GMRAIAL1($P(ALRDATA,U,2)),$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",23,0)
 S X=$P(SITEPARM,U,6)_HLCM_$P(SITEPARM,U,5)_HLCM_"L",$P(OUTX,HLFS,15)=X
"RTN","GMRAIAL2",24,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",25,0)
 ;
"RTN","GMRAIAL2",26,0)
 ; OBX2 - Allergy Type
"RTN","GMRAIAL2",27,0)
OBX2 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"ALLERGY TYPE"_HLFS
"RTN","GMRAIAL2",28,0)
 S X=$P(ALRDATA,U,20),VAL=X_HLCM F I=1:1:$L(X) D
"RTN","GMRAIAL2",29,0)
 . S Y=$E(X,I),Y=$S(Y="D":"DRUG",Y="F":"FOOD",Y="O":"OTHER",1:"")
"RTN","GMRAIAL2",30,0)
 . S VAL=VAL_Y S:I<$L(X) VAL=VAL_","
"RTN","GMRAIAL2",31,0)
 S VAL=VAL_HLCM_"L",$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",32,0)
 S X=$P(SITEPARM,U,6)_HLCM_$P(SITEPARM,U,5)_HLCM_"L",$P(OUTX,HLFS,15)=X
"RTN","GMRAIAL2",33,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",34,0)
 ;
"RTN","GMRAIAL2",35,0)
 ; OBX3 - GMR Allergy
"RTN","GMRAIAL2",36,0)
 ;        ALLERGIES FROM VA DRUG CLASS HAVE SPECIAL FORMAT FOR
"RTN","GMRAIAL2",37,0)
 ;        OBX-5
"RTN","GMRAIAL2",38,0)
OBX3 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"GMR ALLERGY"_HLFS
"RTN","GMRAIAL2",39,0)
 S VAL="",X=$P(ALRDATA,U,3) G OBX4:X=""
"RTN","GMRAIAL2",40,0)
 I X'["50.605" D
"RTN","GMRAIAL2",41,0)
 . S VAL=$P($G(@("^"_$P(X,";",2)_$P(X,";",1)_",0)")),U)
"RTN","GMRAIAL2",42,0)
 . I VAL="" D ERR^VDEFREQ("No data in GMR Allergy file "_$P(X,";",2)_$P(X,";")_",0)") S ZTSTOP=1 Q
"RTN","GMRAIAL2",43,0)
 . I X["PSDRUG" S GMRAVUID=$P(X,";",1)_U_$P(SITEPARM,U,6)_"_"_50
"RTN","GMRAIAL2",44,0)
 . E  D
"RTN","GMRAIAL2",45,0)
 . . S GMRAFILE=+$P($P(X,";",2),"(",2),GMRAIENS=+X_","
"RTN","GMRAIAL2",46,0)
 . . S GMRAVUID=$$GETVUID^GMRAIAL1(GMRAFILE,.01,GMRAIENS,1)
"RTN","GMRAIAL2",47,0)
 . S VAL=$P(GMRAVUID,U)_HLCM_VAL_HLCM_$P(GMRAVUID,U,2)
"RTN","GMRAIAL2",48,0)
 I X["50.605" D
"RTN","GMRAIAL2",49,0)
 . S GMRAIENS=$P(X,";"),Y=$$CLASS2^PSNAPIS(GMRAIENS)
"RTN","GMRAIAL2",50,0)
 . S GMRAVUID=$$GETVUID^GMRAIAL1(50.605,.01,GMRAIENS_",",1)
"RTN","GMRAIAL2",51,0)
 . S VAL=$G(VAL)_$P(GMRAVUID,U)_HLCM_$P(Y,U,2)_HLCM_$P(GMRAVUID,U,2)_HLCM_$P(Y,U)_HLCM_$P(Y,U,2)_HLCM_$P(SITEPARM,U,6)_"_50.605"
"RTN","GMRAIAL2",52,0)
 G RETURN:ZTSTOP
"RTN","GMRAIAL2",53,0)
 S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",54,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",55,0)
 ;
"RTN","GMRAIAL2",56,0)
 ; OBX4 - List of drug ingredients
"RTN","GMRAIAL2",57,0)
OBX4 G OBX5:'$D(^GMR(120.8,KEY,2))
"RTN","GMRAIAL2",58,0)
 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"DRUG INGREDIENTS"_HLFS
"RTN","GMRAIAL2",59,0)
 S IEN1=0,VAL="" F  S IEN1=$O(^GMR(120.8,KEY,2,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL2",60,0)
 . S Y=^GMR(120.8,KEY,2,IEN1,0),GMRAVUID=$$GETVUID^GMRAIAL1(50.416,.01,Y_",",1)
"RTN","GMRAIAL2",61,0)
 . S X=$P(GMRAVUID,U)_HLCM_$P(^PS(50.416,Y,0),U)_HLCM_$P(GMRAVUID,U,2),VAL=VAL_X_HLRP
"RTN","GMRAIAL2",62,0)
 S VAL=$E(VAL,1,$L(VAL)-1),$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",63,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",64,0)
 ;
"RTN","GMRAIAL2",65,0)
 ; OBX5 - Drug class
"RTN","GMRAIAL2",66,0)
OBX5 G OBX6:'$D(^GMR(120.8,KEY,3))
"RTN","GMRAIAL2",67,0)
 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"DRUG CLASSES"_HLFS
"RTN","GMRAIAL2",68,0)
 S IEN1=0,VAL="" F  S IEN1=$O(^GMR(120.8,KEY,3,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL2",69,0)
 . S GMRAIENS=^GMR(120.8,KEY,3,IEN1,0),X=$$CLASS2^PSNAPIS(GMRAIENS)
"RTN","GMRAIAL2",70,0)
 . S GMRAVUID=$$GETVUID^GMRAIAL1(50.605,.01,GMRAIENS_",",1)
"RTN","GMRAIAL2",71,0)
 . S VAL=$G(VAL)_$P(GMRAVUID,U)_HLCM_$P(X,U,2)_HLCM_$P(GMRAVUID,U,2)_HLCM_$P(X,U)_HLCM_$P(X,U,2)_HLCM_$P(SITEPARM,U,6)_"_50.605"_HLRP
"RTN","GMRAIAL2",72,0)
 S VAL=$E(VAL,1,$L(VAL)-1),$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",73,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",74,0)
 ;
"RTN","GMRAIAL2",75,0)
 ; OBX6 - MECHANISM
"RTN","GMRAIAL2",76,0)
OBX6 S X=$P(ALRDATA,U,14) G OBX7:X=""
"RTN","GMRAIAL2",77,0)
 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"MECHANISM"_HLFS
"RTN","GMRAIAL2",78,0)
 S GMRAVUID=$$GETVUID^GMRAIAL1(120.8,17,X)
"RTN","GMRAIAL2",79,0)
 S VAL=$P(GMRAVUID,U)_HLCM_$S(X="A":"ALLERGY",X="P":"PHARMACOLOGIC",X="U":"UNKNOWN",1:"")_HLCM_$P(GMRAVUID,U,2)
"RTN","GMRAIAL2",80,0)
 S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",81,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",82,0)
 ;
"RTN","GMRAIAL2",83,0)
 ; OBX7 - Reaction
"RTN","GMRAIAL2",84,0)
OBX7 S IEN1=0 F  S IEN1=$O(^GMR(120.8,KEY,10,IEN1)) Q:'+IEN1  D  Q:ZTSTOP
"RTN","GMRAIAL2",85,0)
 . S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"REACTION"_HLFS
"RTN","GMRAIAL2",86,0)
 . S X=^GMR(120.8,KEY,10,IEN1,0),GMRAVUID=""
"RTN","GMRAIAL2",87,0)
 . S:$P(X,U,2)'="" GMRAVUID="^L"
"RTN","GMRAIAL2",88,0)
 . S:$P(X,U,2)="" $P(X,U,2)=$P($G(^GMRD(120.83,+X,0)),U)
"RTN","GMRAIAL2",89,0)
 . S:GMRAVUID'="^L" GMRAVUID=$$GETVUID^GMRAIAL1(120.83,.01,+X_",",1)
"RTN","GMRAIAL2",90,0)
 . S VAL=$P(GMRAVUID,U)_HLCM_$P(X,U,2)_HLCM_$P(GMRAVUID,U,2)
"RTN","GMRAIAL2",91,0)
 . S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=RSLTSTA
"RTN","GMRAIAL2",92,0)
 . S $P(OUTX,HLFS,14)=$$TS^VDEFEL($P(X,U,4))
"RTN","GMRAIAL2",93,0)
 . S VAL=$$XCN200^VDEFEL($P(X,U,3)),$P(OUTX,HLFS,16)=VAL
"RTN","GMRAIAL2",94,0)
 . S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",95,0)
 ;
"RTN","GMRAIAL2",96,0)
 ; Skip assessment if allergy update
"RTN","GMRAIAL2",97,0)
 G OBX9:ALTYPE=1
"RTN","GMRAIAL2",98,0)
 ;
"RTN","GMRAIAL2",99,0)
 ; OBX8 - Assessment
"RTN","GMRAIAL2",100,0)
OBX8 S S=S+1,OUTX=1_HLFS_"CE"_HLFS_"ASSESSMENT"_HLFS
"RTN","GMRAIAL2",101,0)
 I ENTERR=1 S VAL=HLCM_"ENTERED IN ERROR"_HLCM G OBX8A
"RTN","GMRAIAL2",102,0)
 S X=+$P(ALRDATA,U,2),GMRAVUID=$$GETVUID^GMRAIAL1(120.86,1,X)
"RTN","GMRAIAL2",103,0)
 S VAL=$P(GMRAVUID,U)_HLCM_$S(X=0:"NO KNOWN ALLERGIES",X=1:"YES",1:"")
"RTN","GMRAIAL2",104,0)
 S VAL=VAL_HLCM_$P(GMRAVUID,U,2)
"RTN","GMRAIAL2",105,0)
OBX8A S $P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)=$E("FW",1+(ENTERR'=""))
"RTN","GMRAIAL2",106,0)
 I '+ENTERR S $P(OUTX,HLFS,14)=$$TS^VDEFEL($P(ALRDATA,U,4))
"RTN","GMRAIAL2",107,0)
 I '+ENTERR S VAL=$$XCN200^VDEFEL($P(ALRDATA,U,3)),$P(OUTX,HLFS,16)=VAL
"RTN","GMRAIAL2",108,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",109,0)
 ;
"RTN","GMRAIAL2",110,0)
 ; Done if assessment
"RTN","GMRAIAL2",111,0)
 G RETURN:ALTYPE=2
"RTN","GMRAIAL2",112,0)
 ;
"RTN","GMRAIAL2",113,0)
 ; OBX9 - Comments
"RTN","GMRAIAL2",114,0)
 ; One OBX for each comment
"RTN","GMRAIAL2",115,0)
OBX9 S IEN=0 F  S IEN=$O(^GMR(120.8,KEY,26,IEN)) Q:'+IEN  D
"RTN","GMRAIAL2",116,0)
 . S ALRDATA=$G(^GMR(120.8,KEY,26,IEN,0)) G RETURN:ALRDATA=""
"RTN","GMRAIAL2",117,0)
 . ; Set up the static fields
"RTN","GMRAIAL2",118,0)
 . S X1=1_HLFS_"TX"_HLFS_"COMMENT"_HLFS
"RTN","GMRAIAL2",119,0)
 . S $P(X1,HLFS,11)=RSLTSTA,$P(X1,HLFS,16)=$$XCN200^VDEFEL($P(ALRDATA,U,2))
"RTN","GMRAIAL2",120,0)
 . S $P(X1,HLFS,19)=$$TS^VDEFEL($P(ALRDATA,U)),X=$P(ALRDATA,U,3)
"RTN","GMRAIAL2",121,0)
 . S GMRAVUID=$$GETVUID^GMRAIAL1(120.826,1.5,X)
"RTN","GMRAIAL2",122,0)
 . S $P(X,HLCM,2)=$S(X="V":"VERIFIED",X="O":"OBSERVED",X="E":"ERRORED",1:"")
"RTN","GMRAIAL2",123,0)
 . S $P(X,HLCM)=+GMRAVUID,$P(X,HLCM,3)=$P(GMRAVUID,U,2)
"RTN","GMRAIAL2",124,0)
 . S $P(X1,HLFS,17)=X
"RTN","GMRAIAL2",125,0)
 . ;
"RTN","GMRAIAL2",126,0)
 . ; A comment may be more than one line
"RTN","GMRAIAL2",127,0)
 . S IEN1=0,VAL="" F  S IEN1=$O(^GMR(120.8,KEY,26,IEN,2,IEN1)) Q:'+IEN1  D
"RTN","GMRAIAL2",128,0)
 . . S X=$$HL7RC^GMRAIAL1(^GMR(120.8,KEY,26,IEN,2,IEN1,0)),VAL=VAL_X_HLRP
"RTN","GMRAIAL2",129,0)
 . S:$E(VAL,$L(VAL))=HLRP VAL=$E(VAL,1,$L(VAL)-1)
"RTN","GMRAIAL2",130,0)
 . S OUTX=X1,$P(OUTX,HLFS,5)=VAL
"RTN","GMRAIAL2",131,0)
 . S S=S+1,OUTX="OBX"_HLFS_OUTX D SAVE^GMRAIAL1
"RTN","GMRAIAL2",132,0)
 ;
"RTN","GMRAIAL2",133,0)
 ; Return to GMRAIAL1
"RTN","GMRAIAL2",134,0)
RETURN Q
"RTN","GMRAIVDK")
0^16^B5294548
"RTN","GMRAIVDK",1,0)
GMRAIVDK ;BPOIFO/JG - KIDS POST INSTALL FOR VDEF PATCH ;10/5/04  08:57
"RTN","GMRAIVDK",2,0)
 ;;4.0;ADVERSE REACTION TRACKING;**22,23**;Mar 29, 1996
"RTN","GMRAIVDK",3,0)
 ;
"RTN","GMRAIVDK",4,0)
 ; This routine uses the following IAs:
"RTN","GMRAIVDK",5,0)
 ;    #4447 - POSTKID^VDEF   (controlled)
"RTN","GMRAIVDK",6,0)
 ;   #10141 - XPDUTL calls   (controlled)
"RTN","GMRAIVDK",7,0)
 ;
"RTN","GMRAIVDK",8,0)
 ; This program is used as the KIDS Post-Install routine
"RTN","GMRAIVDK",9,0)
 ; for the second VDEF patch that installs GMRA application
"RTN","GMRAIVDK",10,0)
 ; specific components that are required by VDEF to construct
"RTN","GMRAIVDK",11,0)
 ; a message.
"RTN","GMRAIVDK",12,0)
 ;
"RTN","GMRAIVDK",13,0)
POSTKID ; Entry point
"RTN","GMRAIVDK",14,0)
 ; Inputs that are required by POSTKID^VDEFVU:
"RTN","GMRAIVDK",15,0)
 ;    MSGTYP - HL7 message type (ADT, ORU, etc)
"RTN","GMRAIVDK",16,0)
 ;    EVNTYP - HL7 event type (A60, R01, etc)
"RTN","GMRAIVDK",17,0)
 ;    SUBTYP - VDEF Event Subtype (ALGY, PPAR, etc)
"RTN","GMRAIVDK",18,0)
 ;    PROTO - VistA HL7 Event Driver Protocol Name
"RTN","GMRAIVDK",19,0)
 ;    CUSTPKG - Custodial Package Name
"RTN","GMRAIVDK",20,0)
 ;    EXTROUT - VDEF Message Extraction Program
"RTN","GMRAIVDK",21,0)
 ;    EVDESC - Event description
"RTN","GMRAIVDK",22,0)
 ;    SUBDESC - Subtype description
"RTN","GMRAIVDK",23,0)
 ;
"RTN","GMRAIVDK",24,0)
 ; If needed, POSTKID^VDEFVU will generate error message (BMES^XPDUTL)
"RTN","GMRAIVDK",25,0)
 ; and set GMRABORT=1
"RTN","GMRAIVDK",26,0)
 ;
"RTN","GMRAIVDK",27,0)
 K XPDABORT
"RTN","GMRAIVDK",28,0)
 I $G(XPDNM)="" D BMES^XPDUTL("Must be run as a KIDS Post-Install process.") S XPDABORT=1 Q
"RTN","GMRAIVDK",29,0)
 N MSGTYP,EVNTYP,SUBTYP,PROTO,CUSTPKG,EXTROUT,EVDESC,SUBDESC,ERRMSG,GMRABORT
"RTN","GMRAIVDK",30,0)
 ;
"RTN","GMRAIVDK",31,0)
 ; Create Allergy Update/Insert Event
"RTN","GMRAIVDK",32,0)
 S MSGTYP="ORU"
"RTN","GMRAIVDK",33,0)
 S EVNTYP="R01"
"RTN","GMRAIVDK",34,0)
 S SUBTYP="ALGY"
"RTN","GMRAIVDK",35,0)
 S PROTO="GMRA VDEF ORU R01 ALLERGY VS"
"RTN","GMRAIVDK",36,0)
 S CUSTPKG="ADVERSE REACTION TRACKING"
"RTN","GMRAIVDK",37,0)
 S EXTROUT="GMRAIAL1"
"RTN","GMRAIVDK",38,0)
 S EVDESC="ALLERGY UPDATE/INSERT"
"RTN","GMRAIVDK",39,0)
 S SUBDESC="ALLERGY UPDATE/INSERT"
"RTN","GMRAIVDK",40,0)
 D POSTKID^VDEFVU(MSGTYP,EVNTYP,SUBTYP,PROTO,CUSTPKG,EXTROUT,EVDESC,SUBDESC,.GMRABORT)
"RTN","GMRAIVDK",41,0)
 Q:$G(GMRABORT)
"RTN","GMRAIVDK",42,0)
 ;
"RTN","GMRAIVDK",43,0)
 ; Create Allergy Assessment Event
"RTN","GMRAIVDK",44,0)
 S SUBTYP="ADAS"
"RTN","GMRAIVDK",45,0)
 S PROTO="GMRA VDEF ORU R01 ADV ASSESS VS"
"RTN","GMRAIVDK",46,0)
 S EVDESC="ALLERGY ASSESSMENT"
"RTN","GMRAIVDK",47,0)
 S SUBDESC="ALLERGY ASSESSMENT"
"RTN","GMRAIVDK",48,0)
 D POSTKID^VDEFVU(MSGTYP,EVNTYP,SUBTYP,PROTO,CUSTPKG,EXTROUT,EVDESC,SUBDESC,.GMRABORT)
"RTN","GMRAIVDK",49,0)
 Q:$G(GMRABORT)
"RTN","GMRAIVDK",50,0)
 ;
"RTN","GMRAIVDK",51,0)
 ; Create Adverse Reaction Report Event
"RTN","GMRAIVDK",52,0)
 S SUBTYP="ADRA"
"RTN","GMRAIVDK",53,0)
 S PROTO="GMRA VDEF ORU R01 ADV REACT VS"
"RTN","GMRAIVDK",54,0)
 S EXTROUT="GMRAIAD1"
"RTN","GMRAIVDK",55,0)
 S EVDESC="ADVERSE REACTION REPORT"
"RTN","GMRAIVDK",56,0)
 S SUBDESC="ADVERSE REACTION"
"RTN","GMRAIVDK",57,0)
 D POSTKID^VDEFVU(MSGTYP,EVNTYP,SUBTYP,PROTO,CUSTPKG,EXTROUT,EVDESC,SUBDESC,.GMRABORT)
"RTN","GMRAIVDK",58,0)
 Q:$G(GMRABORT)
"RTN","GMRAIVDK",59,0)
 ;
"RTN","GMRAIVDK",60,0)
 ; Success!!
"RTN","GMRAIVDK",61,0)
 D BMES^XPDUTL("VDEF Event(s) successfully installed in VDEF globals.")
"RTN","GMRAIVDK",62,0)
 Q
"RTN","GMRAPER0")
0^17^B56465976
"RTN","GMRAPER0",1,0)
GMRAPER0 ;HIRMFO/WAA-REACTIONS SELECT ROUTINE ;6/9/05  11:12
"RTN","GMRAPER0",2,0)
 ;;4.0;Adverse Reaction Tracking;**7,21,23**;Mar 29, 1996
"RTN","GMRAPER0",3,0)
EN1 ; ENTRY POINT TO SELECT SIGNS/SYMPTOMS
"RTN","GMRAPER0",4,0)
 K GMRARAD,GMRAROT,GMRARDL,GMRAROTD S GMRAR10(11)=GMRAOTH_"^OTHER SIGN/SYMPTOM"
"RTN","GMRAPER0",5,0)
LIST ; Display Signs/Symptoms
"RTN","GMRAPER0",6,0)
 W #
"RTN","GMRAPER0",7,0)
 I $O(GMRARPR(""))="" W !!,"No signs/symptoms have been specified.  Please add some now."
"RTN","GMRAPER0",8,0)
RELIST D DSPREAC
"RTN","GMRAPER0",9,0)
 ;This is to handle historical events
"RTN","GMRAPER0",10,0)
 I 'GMRAOUT,($O(GMRARPR(""))=""&($P(GMRAPA(0),U,6)="h")) G Q1
"RTN","GMRAPER0",11,0)
 ;This is to handle observed events
"RTN","GMRAPER0",12,0)
 I 'GMRAOUT,($O(GMRARPR(""))=""&($P(GMRAPA(0),U,6)="o")) W !!,$C(7),"SIGNS/SYMPTOMS MUST BE SPECIFIED.  THIS IS A REQUIRED RESPONSE." G RELIST
"RTN","GMRAPER0",13,0)
 G:'GMRAOUT LIST S:GMRAOUT GMRAOUT=2-GMRAOUT
"RTN","GMRAPER0",14,0)
Q1 ; Exit from program
"RTN","GMRAPER0",15,0)
 K %,DIC,GMADATE,GMRACTR,GMRADO,GMRAOK,GMRAPC,GMRAR10,GMRADATE,GMRAREAC,GMRARECN,GMRARPR,GMRAX,GMRAY,GMRARADD,GMRAROTT,X,Y
"RTN","GMRAPER0",16,0)
 Q
"RTN","GMRAPER0",17,0)
DSPREAC ; Display all the patient reactions
"RTN","GMRAPER0",18,0)
 I $O(GMRARPR(""))="" G NOREAC
"RTN","GMRAPER0",19,0)
 W !!,"The following is the list of reported signs/symptoms for this reaction:"
"RTN","GMRAPER0",20,0)
 ; GMRACHC(Y) is the reaction that the user can change
"RTN","GMRAPER0",21,0)
 S GMRAREAC="",GMRACTR=0 K GMRACHC
"RTN","GMRAPER0",22,0)
 F  S GMRAREAC=$O(GMRARPR(GMRAREAC)) Q:GMRAREAC=""  D
"RTN","GMRAPER0",23,0)
 .S GMRARECN=0 F  S GMRARECN=$O(GMRARPR(GMRAREAC,GMRARECN)) Q:GMRARECN'>0  D
"RTN","GMRAPER0",24,0)
 ..S Y=$$CHC,GMRACHC(Y,GMRAREAC,GMRARECN)=""
"RTN","GMRAPER0",25,0)
 ..S:Y GMRACHC(Y)=GMRARECN_U_GMRAREAC
"RTN","GMRAPER0",26,0)
 ..Q
"RTN","GMRAPER0",27,0)
 .Q
"RTN","GMRAPER0",28,0)
 ;v=reaction that this user did not enter
"RTN","GMRAPER0",29,0)
 I $D(GMRACHC(0)) D
"RTN","GMRAPER0",30,0)
 .W !!,"          These reactions were entered by another user:"
"RTN","GMRAPER0",31,0)
 .W !,"     Signs/Symptoms                                  " W:'$G(GMRANDT) "Date Observed"
"RTN","GMRAPER0",32,0)
 .W !,$$REPEAT^XLFSTR("-",75)
"RTN","GMRAPER0",33,0)
 .S X="" F  S X=$O(GMRACHC(0,X)) Q:X=""  S Y=0 F  S Y=$O(GMRACHC(0,X,Y)) Q:Y<1  D
"RTN","GMRAPER0",34,0)
 ..S GMRARECN=Y
"RTN","GMRAPER0",35,0)
 ..S GMRAREAC=X
"RTN","GMRAPER0",36,0)
 ..D:$G(GMRAPRP(GMRAREAC,GMRARECN))="" PRTREAC
"RTN","GMRAPER0",37,0)
 ..Q
"RTN","GMRAPER0",38,0)
 .W !
"RTN","GMRAPER0",39,0)
 .Q
"RTN","GMRAPER0",40,0)
 ;v===Reaction that this user entered
"RTN","GMRAPER0",41,0)
 S X=0 F  S X=$O(GMRACHC(X)) Q:X<1  D
"RTN","GMRAPER0",42,0)
 .S GMRARECN=$P(GMRACHC(X),U)
"RTN","GMRAPER0",43,0)
 .S GMRAREAC=$P(GMRACHC(X),U,2)
"RTN","GMRAPER0",44,0)
 .D:$G(GMRAPRP(GMRAREAC,GMRARECN))="" PRTREAC
"RTN","GMRAPER0",45,0)
 .Q
"RTN","GMRAPER0",46,0)
MANIL ;
"RTN","GMRAPER0",47,0)
 W !!,"Select Action (A)DD",$S(GMRACTR>0:", (D)ELETE ",1:" "),"OR <RET>: " R X:DTIME S:'$T X="^^" I "^^"[X S GMRAOUT=2-(X'="") Q
"RTN","GMRAPER0",48,0)
 S:X?1L X=$C($A(X)-32)
"RTN","GMRAPER0",49,0)
 I '(X="A"!(X="D")) W !?4,$C(7),"ENTER AN A TO ADD SIGNS/SYMPTOMS TO THIS LIST," W:GMRACTR !?10,"OR D TO DELETE SIGNS/SYMPTOMS FROM THIS LIST," W !?10,"OR <RET> TO ACCEPT THIS LIST OF SIGNS/SYMPTOMS." G MANIL
"RTN","GMRAPER0",50,0)
 I X="D" D DELREAC^GMRAPER1 Q
"RTN","GMRAPER0",51,0)
NOREAC D ADREAC
"RTN","GMRAPER0",52,0)
 Q:'$D(GMRARPR)
"RTN","GMRAPER0",53,0)
 ;v---Ask the date then loop through the RPR array and put the date in 3
"RTN","GMRAPER0",54,0)
 Q:GMRAOUT
"RTN","GMRAPER0",55,0)
 S GMRAASK=0
"RTN","GMRAPER0",56,0)
 S GMADATE=$G(GMADATE)
"RTN","GMRAPER0",57,0)
 I GMADATE="",$G(GMRAODT)>0 S GMADATE=GMRAODT
"RTN","GMRAPER0",58,0)
 I '$G(GMRANDT) D DATE(.GMADATE,.GMRAASK) Q:GMRAOUT  D
"RTN","GMRAPER0",59,0)
 .N GMRAX
"RTN","GMRAPER0",60,0)
 .;Add the data to the new reaction unless it has a date
"RTN","GMRAPER0",61,0)
 .;Reaction from the reaction file 120.8
"RTN","GMRAPER0",62,0)
 .S GMRAX=0 F  S GMRAX=$O(GMRARAD(GMRAX)) Q:GMRAX<1  D
"RTN","GMRAPER0",63,0)
 ..I $P(GMRARAD(GMRAX),U,2)'=""!($D(GMRARADD("DONE",GMRAX))) Q  ;Date had been added to this reaction or reaction has already been processed.  Allows null entry
"RTN","GMRAPER0",64,0)
 ..S $P(GMRARAD(GMRAX),U,2)=GMADATE,GMRARADD("DONE",GMRAX)="" ;keeps track of entries edited so null dates aren't over written during same session
"RTN","GMRAPER0",65,0)
 ..S $P(GMRARPR($P(GMRARAD(GMRAX),U),GMRAX),U,3)=GMADATE
"RTN","GMRAPER0",66,0)
 ..Q
"RTN","GMRAPER0",67,0)
 .;Other Reaction
"RTN","GMRAPER0",68,0)
 .S GMRAX="" F  S GMRAX=$O(GMRAROT(GMRAX)) Q:GMRAX=""  D
"RTN","GMRAPER0",69,0)
 ..I $P(GMRAROT(GMRAX),U,2)'=""!($D(GMRAROTT("DONE",GMRAX))) Q  ;Date had been added to this reaction or sign has already been processed.
"RTN","GMRAPER0",70,0)
 ..S $P(GMRAROT(GMRAX),U,2)=GMADATE,GMRAROTT("DONE",GMRAX)="" ;entries processed will not be overwritten by other sign/symptoms during same editing session
"RTN","GMRAPER0",71,0)
 ..S $P(GMRARPR($P(GMRAROT(GMRAX),U),GMRAOTH),U,3)=GMADATE
"RTN","GMRAPER0",72,0)
 .Q
"RTN","GMRAPER0",73,0)
 K GMADATE ;Delete date associated with this sign/symptom
"RTN","GMRAPER0",74,0)
 Q
"RTN","GMRAPER0",75,0)
ADREAC ;This is the site parameter's top ten most common signs/symptoms
"RTN","GMRAPER0",76,0)
 I $G(ERR) W !!,"One or more entries you selected were inactive.  Please use option 11",!,"to find a similar term to replace the inactive sign/symptom you selected." K ERR ;23
"RTN","GMRAPER0",77,0)
 W !!,"The following are the top ten most common signs/symptoms:"
"RTN","GMRAPER0",78,0)
 F GMRAREAC=1:1:5 W !,$J(GMRAREAC,2),".",?4,$P(GMRAR10(GMRAREAC),U,2),?35,$J(GMRAREAC+6,2),".",?39,$P(GMRAR10(GMRAREAC+6),U,2)
"RTN","GMRAPER0",79,0)
 W !?1,"6.",?4,$P(GMRAR10(6),U,2)
"RTN","GMRAPER0",80,0)
RRD ;
"RTN","GMRAPER0",81,0)
 K DIR S DIR(0)="LOA^1:11"
"RTN","GMRAPER0",82,0)
 S DIR(0)=DIR(0)_"^I X[""."" W !,""DO NOT USE DECIMAL VALUES."",$C(7) K X Q"
"RTN","GMRAPER0",83,0)
 S DIR("A")="Enter from the list above :  "
"RTN","GMRAPER0",84,0)
 S DIR("?",1)="PLEASE ENTER THE NUMBERS OF THE SIGNS/SYMPTOMS YOU WOULD LIKE TO ADD."
"RTN","GMRAPER0",85,0)
 S DIR("?",2)="RANGES CAN BE SEPARATED BY A HYPHEN (-) AND GROUPS OF NUMBERS,"
"RTN","GMRAPER0",86,0)
 S DIR("?")="SEPARATED BY A COMMA (,)."
"RTN","GMRAPER0",87,0)
 D ^DIR K DIR
"RTN","GMRAPER0",88,0)
 S:$D(DTOUT) GMRAOUT=1
"RTN","GMRAPER0",89,0)
 S:$D(DUOUT) GMRAOUT=1
"RTN","GMRAPER0",90,0)
 Q:GMRAOUT!(Y="")
"RTN","GMRAPER0",91,0)
 S GMRADO=Y K Y,GMRAY
"RTN","GMRAPER0",92,0)
 S GMRAASK=0
"RTN","GMRAPER0",93,0)
 F Y=1:1:$L(GMRADO,",") S GMRAY=$P(GMRADO,",",Y) I +GMRAY D
"RTN","GMRAPER0",94,0)
 .I +GMRAY=11 D ADD Q  ;23 Handle request for "other" separately
"RTN","GMRAPER0",95,0)
 .I $L($T(SCREEN^XTID)) I $$SCREEN^XTID(120.83,.01,$P(GMRAR10(+GMRAY),U)_",") W !!,$P(GMRAR10(+GMRAY),U,2)," is inactive and may not be used." S ERR=1 Q  ;23
"RTN","GMRAPER0",96,0)
 .D ADD ;23
"RTN","GMRAPER0",97,0)
 I $G(ERR) G ADREAC ;23
"RTN","GMRAPER0",98,0)
 Q
"RTN","GMRAPER0",99,0)
CHC() ; Check reaction to see if user can see and edit this reaction
"RTN","GMRAPER0",100,0)
 I $P(GMRARPR(GMRAREAC,GMRARECN),U,2)=DUZ!'$L($P(GMRARPR(GMRAREAC,GMRARECN),U,2)),'$P(GMRAPA(0),U,12)!$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) S GMRACTR=GMRACTR+1 Q GMRACTR
"RTN","GMRAPER0",101,0)
 Q 0
"RTN","GMRAPER0",102,0)
PRTREAC ;
"RTN","GMRAPER0",103,0)
 N GMRAPDAT
"RTN","GMRAPER0",104,0)
 I X=1 D
"RTN","GMRAPER0",105,0)
 .W !!,"     Signs/Symptoms                                  " W:'$G(GMRANDT) "Date Observed"
"RTN","GMRAPER0",106,0)
 .W !,$$REPEAT^XLFSTR("-",75)
"RTN","GMRAPER0",107,0)
 .Q
"RTN","GMRAPER0",108,0)
 W !?1,$S(X:$J(X,2),1:""),?5,$E($P(GMRARPR(GMRAREAC,GMRARECN),U),1,45)
"RTN","GMRAPER0",109,0)
 S GMRAPDAT=$S($P(GMRARPR(GMRAREAC,GMRARECN),U,3)'="":$P(GMRARPR(GMRAREAC,GMRARECN),U,3),$G(GMRADATE)>0:GMADATE,1:"")
"RTN","GMRAPER0",110,0)
 I '$G(GMRANDT) W ?53 W:GMRAPDAT'="" $$FMTE^XLFDT(GMRAPDAT,1)
"RTN","GMRAPER0",111,0)
 Q
"RTN","GMRAPER0",112,0)
ADD ;
"RTN","GMRAPER0",113,0)
 N Y
"RTN","GMRAPER0",114,0)
 I GMRAY=11 D  Q
"RTN","GMRAPER0",115,0)
 .F  D  Q:+Y<0
"RTN","GMRAPER0",116,0)
 ..S DIC=120.83,DIC(0)="AEMQ",DIC("S")="I $P(^(0),U)'=""OTHER REACTION"",$S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(120.83,.01,Y_"",""),1:1)" D ^DIC
"RTN","GMRAPER0",117,0)
 ..I +Y>0 D SETT
"RTN","GMRAPER0",118,0)
 S Y=GMRAR10(GMRAY) D SETT
"RTN","GMRAPER0",119,0)
 Q
"RTN","GMRAPER0",120,0)
SETT ;
"RTN","GMRAPER0",121,0)
 Q:'$L(Y)
"RTN","GMRAPER0",122,0)
 S GMRAREAC=$P(Y,U,2),GMRARECN=$P(Y,U) K GMRARDL(GMRARECN)
"RTN","GMRAPER0",123,0)
 S:'$D(GMRARPR(GMRAREAC,GMRARECN)) GMRARAD(GMRARECN)=GMRAREAC,GMRARPR(GMRAREAC,GMRARECN)=GMRAREAC
"RTN","GMRAPER0",124,0)
 Q
"RTN","GMRAPER0",125,0)
STRIN ;This will handle a string input
"RTN","GMRAPER0",126,0)
 W !!,"Enter OTHER SIGN/SYMPTOM: " R X:DTIME S:'$T X="^^" I "^^"[X S:X="^^"!(X=U) GMRAOUT=1 Q
"RTN","GMRAPER0",127,0)
 S DIC="^GMRD(120.83,",DIC("S")="I $P(^(0),U)'=""OTHER REACTION"",$S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(120.83,.01,Y_"",""),1:1)",DIC(0)="EM",D="B^D",GMRAREAC=X K DTOUT,DUOUT D MIX^DIC1 K DIC G:X?1"?".E STRIN ;21,23
"RTN","GMRAPER0",128,0)
 I +Y'>0 S:$D(DTOUT)!$D(DUOUT) GMRAOUT=1 Q:GMRAOUT  D ADDG Q:GMRAOUT  G STRIN:%=2,ASKAN
"RTN","GMRAPER0",129,0)
YNOK W !,$P(Y,U,2)_" OK " S %=1 D YN^DICN I '% W !?4,$C(7),"ANSWER YES IF THE DATA ABOVE IS CORRECT, ELSE ANSWER NO." G YNOK
"RTN","GMRAPER0",130,0)
 I %=-1 S GMRAOUT=1 Q
"RTN","GMRAPER0",131,0)
 I %=2 S X=GMRAREAC G STRIN:X=$P(Y,U,2) D ADDG Q:GMRAOUT  G STRIN:%=2,ASKAN
"RTN","GMRAPER0",132,0)
 D SETT
"RTN","GMRAPER0",133,0)
ASKAN ;
"RTN","GMRAPER0",134,0)
 W !,"Would you like to add another sign/symptom" S %=2 D YN^DICN I '% W !?4,$C(7),"ANSWER YES TO ADD ANOTHER SIGN/SYMPTOM, ELSE ANSWER NO." G ASKAN
"RTN","GMRAPER0",135,0)
 S:%=-1 GMRAOUT=1 Q:%=2!GMRAOUT
"RTN","GMRAPER0",136,0)
 G STRIN
"RTN","GMRAPER0",137,0)
 Q
"RTN","GMRAPER0",138,0)
ADDG ;
"RTN","GMRAPER0",139,0)
 I $L(X)<3!($L(X)>30) W " ??",$C(7) S %=2 Q
"RTN","GMRAPER0",140,0)
 W !,X," is not in the Sign/Symptoms file." S %=2 D:$L($T(NTRTMSG^HDISVAP)) NTRTMSG^HDISVAP() Q  ;
"RTN","GMRAPER0",141,0)
 S:%=-1 GMRAOUT=1
"RTN","GMRAPER0",142,0)
 I %=1 N % I 'GMRAOUT S:'$D(GMRARPR(X,GMRAOTH)) GMRAROT(X)=X,GMRARPR(X,GMRAOTH)=X K GMRAROTD(X)
"RTN","GMRAPER0",143,0)
 Q
"RTN","GMRAPER0",144,0)
DATE(DATE,ASK) ; Enter the date for a reaction
"RTN","GMRAPER0",145,0)
 Q:ASK
"RTN","GMRAPER0",146,0)
 N %DT,X,Y
"RTN","GMRAPER0",147,0)
 S DATE=$G(DATE,""),%DT="AEPT",%DT("A")="Date(Time Optional) of appearance of Sign/Symptom(s): "
"RTN","GMRAPER0",148,0)
 S:$P(GMRAPA(0),U,6)="o" %DT("B")=$S(DATE="":"NOW",1:$$FMTE^XLFDT(DATE,1))
"RTN","GMRAPER0",149,0)
 S %DT(0)="-NOW" D ^%DT  I "^^"[X S GMRAOUT=$L(X) Q
"RTN","GMRAPER0",150,0)
 S DATE=Y,ASK=1
"RTN","GMRAPER0",151,0)
 Q
"RTN","GMRAPES0")
0^9^B72112674
"RTN","GMRAPES0",1,0)
GMRAPES0 ;HIRMFO/RM-SELECT PATIENT ALLERGY TO EDIT ;5/13/05  15:40
"RTN","GMRAPES0",2,0)
 ;;4.0;Adverse Reaction Tracking;**13,17,19,21,23**;Mar 29, 1996
"RTN","GMRAPES0",3,0)
EN1 ; GIVEN DFN, SELECT PATIENT ALLERGY
"RTN","GMRAPES0",4,0)
 N GMRAGOUT,ROOT,CNT,LST,NAM,DIR,GMRAET
"RTN","GMRAPES0",5,0)
 S GMRARET=0
"RTN","GMRAPES0",6,0)
 S GMRAPA=-1,GMRANEW=0 R !!,"Enter Causative Agent: ",GMRALAR:DTIME S:'$T GMRALAR="^^" S:GMRALAR="" GMRARET=1 I "^^"[GMRALAR S GMRAOUT='$L(GMRALAR)+1 G Q1
"RTN","GMRAPES0",7,0)
 I GMRALAR?1P.E!($L(GMRALAR)<3)!($L(GMRALAR)>30) S GMRAHLP=1 D EN1^GMRAHLP0 G EN1:'GMRAOUT,Q1
"RTN","GMRAPES0",8,0)
 I GMRALAR?.E1L.E S GMRALAR=$$UP^XLFSTR(GMRALAR)
"RTN","GMRAPES0",9,0)
PAL K Y,DTOUT,DUOUT S DGSENFLG="",DIC="^GMR(120.8,",DIC(0)="SEZ",X=GMRANAM,DIC("S")="I '+$G(^(""ER"")),$P(^(0),U,2)?@(""1""""""_GMRALAR_"""""".E""),$D(^GMR(120.8,""B"",DFN,+Y))",DIC("W")="W $P(^(0),U,2)"
"RTN","GMRAPES0",10,0)
 W !!,"Checking existing PATIENT ALLERGIES (#120.8) file for matches...",!
"RTN","GMRAPES0",11,0)
 D ^DIC S X=$P($G(Y(0)),"^",2) K DIC,DGSENFLG,DTOUT,DUOUT D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",12,0)
 S:+Y>0 GMRAPA=+Y G Q1:+Y>0!GMRAOUT,PAL:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",13,0)
 G Q1:'GMRALAGO
"RTN","GMRAPES0",14,0)
NPA W !!,"Now checking GMR ALLERGIES (#120.82) file for matches...",!
"RTN","GMRAPES0",15,0)
 S DIC("S")="I $P(^(0),U)'=""OTHER ALLERGY/ADVERSE REACTION""&($S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(120.82,.01,Y_"",""),1:1))" ;21,23
"RTN","GMRAPES0",16,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 X=$P(Y,"^",2) D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",17,0)
 I +Y>0 S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",18,0)
 G Q1:GMRAOUT,NPA:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",19,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAPES0",20,0)
 K Y,DTOUT,DUOUT
"RTN","GMRAPES0",21,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAPES0",22,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.6,.01,Y_"",""),1:1)" D ^DIC K DIC D DIC ;23
"RTN","GMRAPES0",23,0)
 I +Y>0 S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",24,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAPES0",25,0)
 K DUOUT,DTOUT,Y
"RTN","GMRAPES0",26,0)
 S ROOT=$$T^PSNAPIS,CNT=0,X=GMRALAR
"RTN","GMRAPES0",27,0)
 I $D(@ROOT@(X)),$S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.6,.01,$$TGTOG^PSNAPIS(X)_","),1:1) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;23 Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAPES0",28,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",29,0)
 .Q:$S($L($T(SCREEN^XTID)):$$SCREEN^XTID(50.6,.01,$$TGTOG^PSNAPIS(NAM)_","),1:0)  ;23
"RTN","GMRAPES0",30,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAPES0",31,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",32,0)
 I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",33,0)
 I CNT>1 D
"RTN","GMRAPES0",34,0)
 .D MATCHES
"RTN","GMRAPES0",35,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",36,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",37,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",38,0)
 D DIC I GMRAOUT S GMRAOUT=GMRAOUT=1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",39,0)
 I +Y>0 S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",40,0)
 ;Selection from file 50 removed in patch 23
"RTN","GMRAPES0",41,0)
DRUG ;W !!,"Now checking the DRUG (#50) file for matches...",! K Y,DTOUT,DUOUT
"RTN","GMRAPES0",42,0)
 ;S CNT=0,X=GMRALAR K LST
"RTN","GMRAPES0",43,0)
 ;F ROOT="^PSDRUG(""B"")","^PSDRUG(""C"")" D
"RTN","GMRAPES0",44,0)
 ;.I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$O(@ROOT@(X,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(X,0)),.01)_" <"_X_">",1:X)
"RTN","GMRAPES0",45,0)
 ;.S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",46,0)
 ;..S CNT=CNT+1,LST(CNT)=$O(@ROOT@(NAM,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(NAM,0)),.01)_" <"_NAM_">",1:NAM)
"RTN","GMRAPES0",47,0)
 ;I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",48,0)
 ;I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",49,0)
 ;I CNT>1 D
"RTN","GMRAPES0",50,0)
 ;.D MATCHES
"RTN","GMRAPES0",51,0)
 ;.S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",52,0)
 ;.S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",53,0)
 ;.D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",54,0)
 ;D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",55,0)
 ;I +Y>0 S GMRAAR=+Y(0)_";PSDRUG(",GMRAAR(0)=$$GET1^DIQ(50,+Y(0),.01),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",56,0)
 ;19 - Moved ING and CLASS code here
"RTN","GMRAPES0",57,0)
ING W !!,"Now checking the INGREDIENTS (#50.416) file for matches...",!
"RTN","GMRAPES0",58,0)
 K Y,DTOUT,DUOUT S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.416,.01,Y_"",""),1:1)",X=GMRALAR D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",59,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",60,0)
 G Q1:GMRAOUT,ING:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",61,0)
CLASS W !!,"Now checking VA DRUG CLASS (50.605) file for matches...",!
"RTN","GMRAPES0",62,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",D="C",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.605,.01,Y_"",""),1:1)" D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",63,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",64,0)
 G Q1:GMRAOUT,CLASS:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",65,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files."
"RTN","GMRAPES0",66,0)
 W !!,"Before sending an email requesting the addition of a new reactant, please",!,"try entering the first 3 or 4 letters of the reactant to search for",!,"the desired entry.",!
"RTN","GMRAPES0",67,0)
 W !,"Would you like to send an email requesting ",GMRALAR,!,"be added as a causative agent?"
"RTN","GMRAPES0",68,0)
 S DIR("A")="Send email"
"RTN","GMRAPES0",69,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("?")="^D MESS^GMRAPES0"
"RTN","GMRAPES0",70,0)
 D ^DIR
"RTN","GMRAPES0",71,0)
 I Y'=+Y S GMRAOUT=1 G Q1
"RTN","GMRAPES0",72,0)
 I '+Y G EN1
"RTN","GMRAPES0",73,0)
YNDRG ;
"RTN","GMRAPES0",74,0)
 D GETINPUT(.GMRAET)
"RTN","GMRAPES0",75,0)
 S X=$$SENDREQ(DUZ,DFN,GMRALAR,.GMRAET)
"RTN","GMRAPES0",76,0)
 I '+X W !!,"Error - Message not sent - ",$P(X,U,2)
"RTN","GMRAPES0",77,0)
 I +X W !!,"Message sent - NOTE: This reactant was NOT added for this patient."
"RTN","GMRAPES0",78,0)
 W !
"RTN","GMRAPES0",79,0)
Q1 ;
"RTN","GMRAPES0",80,0)
 S:GMRAPA>0 GMRAPA(0)=$S($D(^GMR(120.8,+GMRAPA,0)):^(0),1:"")
"RTN","GMRAPES0",81,0)
 K %,D,DA,DIC,DTOUT,DUOUT,GMRAAR,GMRAHLP,GMRAING,GMRALAGO,GMRALAR,PSNDA,PSODA,X,Y
"RTN","GMRAPES0",82,0)
 Q
"RTN","GMRAPES0",83,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAPES0",84,0)
 S:$D(DTOUT) X="^^" I X="^^" S GMRAOUT=1 Q
"RTN","GMRAPES0",85,0)
 S:$D(DUOUT) Y=0 Q:+Y'>0
"RTN","GMRAPES0",86,0)
YNOK W !?3,X,"   OK" S %=1 D YN^DICN S:%=-1 GMRAOUT=1,Y=-1 Q:GMRAOUT  S:%=2 Y=-1 Q:Y=-1  S:$$DUPCHK(X,DFN,Y) Y=-1 Q:GMRAOUT  I % W ! Q  ;19
"RTN","GMRAPES0",87,0)
 W !?5,$C(7),"ANSWER YES IF THIS IS THE CORRECT ALLERGY/ADVERSE REACTION,",!?5,"ELSE ANSWER NO."
"RTN","GMRAPES0",88,0)
 G YNOK
"RTN","GMRAPES0",89,0)
DUPCHK(X,Y,Z) ;CHECK FOR ENTERED IN ERROR
"RTN","GMRAPES0",90,0)
 N GMRAPA,GMRAGOUT,%,%Y S GMRAGOUT=0
"RTN","GMRAPES0",91,0)
 I $P($G(^GMR(120.8,+Z,0)),U,2)=X Q GMRAGOUT
"RTN","GMRAPES0",92,0)
 I $O(^GMR(120.8,"B",Y,0)) S GMRAPA=0 F  S GMRAPA=$O(^GMR(120.8,"B",Y,GMRAPA)) Q:GMRAPA<1  D  Q:GMRAOUT!(GMRAGOUT)
"RTN","GMRAPES0",93,0)
 .I $P(^GMR(120.8,GMRAPA,0),U,2)'=X Q
"RTN","GMRAPES0",94,0)
 .I $D(^GMR(120.8,GMRAPA,"ER")) D
"RTN","GMRAPES0",95,0)
 ..F  S %=2 W !,?5,$C(7),"This Agent has been Entered in Error once before.",!,?5,"Are you sure you want to select this Agent again" D  Q:%
"RTN","GMRAPES0",96,0)
 ...D YN^DICN S:%'=1 %=2,GMRAOUT=1  S:%Y?2"^" GMRAOUT=2
"RTN","GMRAPES0",97,0)
 ...Q:%  W !,?10,"ENTER 'Y' FOR YES OR 'N' FOR NO"
"RTN","GMRAPES0",98,0)
 ...Q
"RTN","GMRAPES0",99,0)
 ..S GMRAGOUT=%
"RTN","GMRAPES0",100,0)
 ..Q
"RTN","GMRAPES0",101,0)
 .Q
"RTN","GMRAPES0",102,0)
 I GMRAGOUT=0 S GMRAGOUT=1
"RTN","GMRAPES0",103,0)
 Q (GMRAGOUT-1)
"RTN","GMRAPES0",104,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAPES0",105,0)
 N I,J,QUIT
"RTN","GMRAPES0",106,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAPES0",107,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAPES0",108,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAPES0",109,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAPES0",110,0)
 Q
"RTN","GMRAPES0",111,0)
 ;
"RTN","GMRAPES0",112,0)
MORE()  ; -- show more matches
"RTN","GMRAPES0",113,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAPES0",114,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAPES0",115,0)
 D ^DIR
"RTN","GMRAPES0",116,0)
 Q +Y
"RTN","GMRAPES0",117,0)
 ;
"RTN","GMRAPES0",118,0)
SENDREQ(USER,PAT,TEXT,GMRAET) ;Send email to GMRA REQUEST NEW REACTANT indicating user's request for a new allergy
"RTN","GMRAPES0",119,0)
 ;Returns 0^reason for error
"RTN","GMRAPES0",120,0)
 ;        1 if successful
"RTN","GMRAPES0",121,0)
 N XMDUZ,XMY,XMSUB,GMRATXT,XMTEXT,XMZ,XMMG,GMRAUI,GMRAPI,GMRAUS,GMRAPS,CNT,J
"RTN","GMRAPES0",122,0)
 Q:'$G(USER)!('+$G(DUZ))!('$L(TEXT)) "0^Required information missing"
"RTN","GMRAPES0",123,0)
 S XMDUZ="Allergy Package",XMSUB="Request to add new reactant"
"RTN","GMRAPES0",124,0)
 S XMY("G.GMRA REQUEST NEW REACTANT")=""
"RTN","GMRAPES0",125,0)
 S XMY(DUZ)="" ;Include requestor in message
"RTN","GMRAPES0",126,0)
 D GETS^DIQ(200,USER,".01;.132;.138;8","E","GMRAUI"),GETS^DIQ(2,PAT,".01;.09","IE","GMRAPI") S GMRAUS=USER_",",GMRAPS=PAT_","
"RTN","GMRAPES0",127,0)
 S CNT=1
"RTN","GMRAPES0",128,0)
 S GMRATXT(CNT)="A request to add "_TEXT_" as a new reactant was entered",CNT=CNT+1
"RTN","GMRAPES0",129,0)
 S GMRATXT(CNT)="by "_GMRAUI(200,GMRAUS,.01,"E")_" for patient "_GMRAPI(2,GMRAPS,.01,"E")_" ("_$E(GMRAPI(2,GMRAPS,.09,"I"),6,9)_")",CNT=CNT+1
"RTN","GMRAPES0",130,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",131,0)
 S GMRATXT(CNT)="User's contact information:",CNT=CNT+1
"RTN","GMRAPES0",132,0)
 S GMRATXT(CNT)="Title        : "_GMRAUI(200,GMRAUS,8,"E"),CNT=CNT+1
"RTN","GMRAPES0",133,0)
 S GMRATXT(CNT)="Office Phone : "_GMRAUI(200,GMRAUS,.132,"E"),CNT=CNT+1
"RTN","GMRAPES0",134,0)
 S GMRATXT(CNT)="Digital Pager: "_GMRAUI(200,GMRAUS,.138,"E"),CNT=CNT+1
"RTN","GMRAPES0",135,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",136,0)
 I $D(GMRAET) S GMRATXT(CNT)="The user added the following comment:",CNT=CNT+1 F J=1:1:$P(GMRAET(0),U,3) S GMRATXT(CNT)=GMRAET(J,0),CNT=CNT+1
"RTN","GMRAPES0",137,0)
 I $D(GMRAET) S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",138,0)
 S GMRATXT(CNT)="Please verify with the user the intended reactant and then take the",CNT=CNT+1
"RTN","GMRAPES0",139,0)
 S GMRATXT(CNT)="appropriate action.  Be sure to try alternate spellings, etc before",CNT=CNT+1
"RTN","GMRAPES0",140,0)
 S GMRATXT(CNT)="requesting new reactants through NTRT (New Term Rapid Turnaround).",CNT=CNT+1 ;23
"RTN","GMRAPES0",141,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",142,0)
 S GMRATXT(CNT)="Please note, a reaction WAS NOT entered for this patient!",CNT=CNT+1
"RTN","GMRAPES0",143,0)
 S XMTEXT="GMRATXT("
"RTN","GMRAPES0",144,0)
 D ^XMD
"RTN","GMRAPES0",145,0)
 Q $S($D(XMMG):"0^Mail group GMRA REQUEST NEW REACTANT has no members - contact IRM",1:1)
"RTN","GMRAPES0",146,0)
 ;
"RTN","GMRAPES0",147,0)
MESS ;Provide help for sending email message
"RTN","GMRAPES0",148,0)
 W !,"Enter YES to send an email to the allergy coordinator(s) indicating that",!,"Reactant--> ",GMRALAR,!,"was not found when you were trying to add it for this patient.",!,"Enter NO to try entering the reactant again."
"RTN","GMRAPES0",149,0)
 Q
"RTN","GMRAPES0",150,0)
 ;
"RTN","GMRAPES0",151,0)
GETINPUT(GMRAET) ;Allow user to add comment to message
"RTN","GMRAPES0",152,0)
 N DIC,DWLW,DWPK,DIWEPSE
"RTN","GMRAPES0",153,0)
 S ^TMP($J,"TEXT",0)=""
"RTN","GMRAPES0",154,0)
 S DIC="^TMP($J,""TEXT"","
"RTN","GMRAPES0",155,0)
 S DWLW=70,DWPK=1,DIWEPSE=""
"RTN","GMRAPES0",156,0)
 W !!,"You may now add any comments you may have to the message that",!,"is going to be sent with the request to add this reactant."
"RTN","GMRAPES0",157,0)
 W !,"You may want to add things like sign/symptoms, observed or historical, etc",!,"that may be useful to the reviewer.",!
"RTN","GMRAPES0",158,0)
 D EN^DIWE
"RTN","GMRAPES0",159,0)
 I $O(^TMP($J,"TEXT",0)) M GMRAET=^TMP($J,"TEXT")
"RTN","GMRAPES0",160,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAPES0",161,0)
 Q
"RTN","GMRAPHR1")
0^11^B19292074
"RTN","GMRAPHR1",1,0)
GMRAPHR1 ;HIRMFO/WAA,FT-ADD/DELETE/EDIT CONCOMITANT DRUGS ;4/6/05  14:18
"RTN","GMRAPHR1",2,0)
 ;;4.0;Adverse Reaction Tracking;**5,23**;Mar 29, 1996
"RTN","GMRAPHR1",3,0)
EN1 ;
"RTN","GMRAPHR1",4,0)
 Q:GMRAOUT
"RTN","GMRAPHR1",5,0)
 W @IOF N DIE,DA,GMRAXXX,GMRAX,GMRAGHC
"RTN","GMRAPHR1",6,0)
 K ^UTILITY("PSG",$J),^UTILITY("PSIV",$J),GMRARRAY
"RTN","GMRAPHR1",7,0)
 S GMRADT=$P(^GMR(120.85,GMRAPA1,0),U)
"RTN","GMRAPHR1",8,0)
 D ^GMRADSP7 G:'GMRAPA EXIT
"RTN","GMRAPHR1",9,0)
SELECT W ! D LST
"RTN","GMRAPHR1",10,0)
 ;SELECT ACTION
"RTN","GMRAPHR1",11,0)
 K DIR S DIR(0)="SOMBA^A:ADD;D:DELETE;E:EDIT",DIR("A")="Select Action (A/D/E): "
"RTN","GMRAPHR1",12,0)
 S DIR("?",1)="ENTER A TO ADD A NEW DRUG, D TO DELETE A DRUG OR"
"RTN","GMRAPHR1",13,0)
 S DIR("?")="E TO EDIT A DRUG ON FILE FOR THIS PATIENT"
"RTN","GMRAPHR1",14,0)
 D ^DIR I "^^"[Y S GMRAOUT=$L(Y) G EXIT
"RTN","GMRAPHR1",15,0)
 S GMRASEL=Y K DIR
"RTN","GMRAPHR1",16,0)
 I GMRASEL="A" S GMRALOOK=0 W ! D ADD K GMRALOOK G:GMRAOUT EXIT K GMRALOOK G SELECT
"RTN","GMRAPHR1",17,0)
 I GMRASEL="D" W ! D DEL G:GMRAOUT EXIT G SELECT
"RTN","GMRAPHR1",18,0)
 I GMRASEL="E" W ! D EDIT G:GMRAOUT EXIT G SELECT
"RTN","GMRAPHR1",19,0)
 G SELECT
"RTN","GMRAPHR1",20,0)
EDIT ;EDIT A DRUG
"RTN","GMRAPHR1",21,0)
 I '$O(^GMR(120.85,GMRAPA1,13,0)) W !,?3,"YOU CANNOT EDIT WHEN THERE IS NO DATA ON FILE.",$C(7) Q
"RTN","GMRAPHR1",22,0)
EDITLST ; DISPLAY TO EDIT FIELD
"RTN","GMRAPHR1",23,0)
 W !,"Select the DRUG RX you want to edit:",!
"RTN","GMRAPHR1",24,0)
 D LST
"RTN","GMRAPHR1",25,0)
EEDT K DA,DO,DIC,DIE,DLAYGO,DR
"RTN","GMRAPHR1",26,0)
 S DA(1)=GMRAPA1,DIC="^GMR(120.85,"_DA(1)_",13,",DIC(0)="AMQEZ" D ^DIC K DIC
"RTN","GMRAPHR1",27,0)
 I $D(DUOUT)!($D(DTOUT))!(Y=-1) S GMRAOUT=1 G QE
"RTN","GMRAPHR1",28,0)
 S DA(1)=GMRAPA1,DIE="^GMR(120.85,"_DA(1)_",13,",DA=+Y,DR=".01;1;2;3;4" D ^DIE
"RTN","GMRAPHR1",29,0)
QE K GMRAX,DA,DIE,DR,DIC,DLAYGO
"RTN","GMRAPHR1",30,0)
 Q
"RTN","GMRAPHR1",31,0)
ADD ;SELECT ON OF THE DRUG OR FREE TEXT
"RTN","GMRAPHR1",32,0)
 D DISP^GMRAPHR0 I GMRAOUT S GMRAOUT=GMRAOUT-1 Q:GMRAOUT
"RTN","GMRAPHR1",33,0)
 K % I '$D(GMRARRAY) D ADD2 Q:X=""!(X="^")  G ADD
"RTN","GMRAPHR1",34,0)
ADDED W !,"Enter the number(s) of the DRUG to ADD or ""N"" for NEW: "
"RTN","GMRAPHR1",35,0)
 R GMRAX:DTIME S:'$T GMRAX="^^" I "^^"[GMRAX S GMRAOUT=$L(GMRAX) Q
"RTN","GMRAPHR1",36,0)
 I "??"[GMRAX W !,"ENTER THE NUMBER(S) OF THE ENTRY YOU WANT OR ""N"" FOR A NEW DRUG" G:$L(GMRAX)=1 ADDED G ADD
"RTN","GMRAPHR1",37,0)
 I GMRAX="n" S GMRAX="N"
"RTN","GMRAPHR1",38,0)
 I GMRAX="N" D ADD2 Q:X=""  G ADD
"RTN","GMRAPHR1",39,0)
 I '$$VALST^GMRAPHR2(GMRAX,"PH") W !,$C(7),"INVALID SELECTION PLEASE SELECT ONE OF THE DRUGS LISTED OR ""N"" FOR A NEW DRUG" G ADD
"RTN","GMRAPHR1",40,0)
 S GMRALST=0 F  S GMRALST=$O(GMRALST(GMRALST)) Q:GMRALST<1  S GMRAX=GMRALST D  Q:GMRAOUT
"RTN","GMRAPHR1",41,0)
 .S X=$P(GMRARRAY("PH",GMRAX),U,2)
"RTN","GMRAPHR1",42,0)
 .I $D(^GMR(120.85,GMRAPA1,13,"B",X)) D  Q:GMRAOUT!(%-1)  K %
"RTN","GMRAPHR1",43,0)
 ..W !,"You already have a ",X," drug on file."
"RTN","GMRAPHR1",44,0)
 ..S %=2 F  W !,"Do You still want to add this one" D YN^DICN S:%=-1 %=2,GMRAOUT=1 Q:%  W !,"ENTER YES TO ADD THE DRUG or NO TO SELECT ANOTHER"
"RTN","GMRAPHR1",45,0)
 ..Q
"RTN","GMRAPHR1",46,0)
 .K DD,DO
"RTN","GMRAPHR1",47,0)
 .I '$O(^GMR(120.85,GMRAPA1,13,0)) S ^(0)="^120.8513^^"
"RTN","GMRAPHR1",48,0)
 .S DA(1)=GMRAPA1,DIC="^GMR(120.85,"_GMRAPA1_",13,",DIC(0)="L",DLAYGO=120.85 D FILE^DICN Q:(+Y<1)
"RTN","GMRAPHR1",49,0)
 .S DA=+Y,DIE=DIC K DIC
"RTN","GMRAPHR1",50,0)
 .I $P(GMRARRAY("PH",GMRAX),U)="OP" S DR="3////"_$P(GMRARRAY("PH",GMRAX),U,4)_";4////"_$E($P(GMRARRAY("PH",GMRAX),U,3),1,30)
"RTN","GMRAPHR1",51,0)
 .I $P(GMRARRAY("PH",GMRAX),U)="D" D
"RTN","GMRAPHR1",52,0)
 ..S DR="1////"_$P(GMRARRAY("PH",GMRAX),U,6)_";2////"_$P($P(GMRARRAY("PH",GMRAX),U,7),".") ;23 Only get date
"RTN","GMRAPHR1",53,0)
 ..S DR=DR_";4////"_$P(GMRARRAY("PH",GMRAX),U,3)_" "_$P(GMRARRAY("PH",GMRAX),U,4)_" "_$P(GMRARRAY("PH",GMRAX),U,5)
"RTN","GMRAPHR1",54,0)
 ..Q
"RTN","GMRAPHR1",55,0)
 .I $P(GMRARRAY("PH",GMRAX),U)="IV" D
"RTN","GMRAPHR1",56,0)
 ..S DR="1////"_$P(GMRARRAY("PH",GMRAX),U,6)_";2////"_$P($P(GMRARRAY("PH",GMRAX),U,7),".") ;23 Get date not time
"RTN","GMRAPHR1",57,0)
 ..S DR=DR_";4////"_$P(GMRARRAY("PH",GMRAX),U,3)_" IV "_$P(GMRARRAY("PH",GMRAX),U,4)_" "_$P(GMRARRAY("PH",GMRAX),U,5)
"RTN","GMRAPHR1",58,0)
 ..Q
"RTN","GMRAPHR1",59,0)
 .D ^DIE K DIE,DA,DR,GMRAX
"RTN","GMRAPHR1",60,0)
 .Q
"RTN","GMRAPHR1",61,0)
 ;G ADD
"RTN","GMRAPHR1",62,0)
 Q
"RTN","GMRAPHR1",63,0)
ADD2 ;
"RTN","GMRAPHR1",64,0)
 I '$O(^GMR(120.85,GMRAPA1,13,0)) S ^(0)="^120.8513^^"
"RTN","GMRAPHR1",65,0)
 S DA=GMRAPA1,DIE="^GMR(120.85,",DLAYGO=120.85,DR="13" D ^DIE
"RTN","GMRAPHR1",66,0)
 K DIE,DA,DR
"RTN","GMRAPHR1",67,0)
 Q
"RTN","GMRAPHR1",68,0)
DEL ;
"RTN","GMRAPHR1",69,0)
 I '$D(^GMR(120.85,GMRAPA1,13,0)) W !,"THERE ARE NO DRUGS SELECTED FOR THIS PATIENT." Q
"RTN","GMRAPHR1",70,0)
 K DA,DO,DIC,DIE,DLAYGO,DR
"RTN","GMRAPHR1",71,0)
 S DA(1)=GMRAPA1,DIC="^GMR(120.85,"_DA(1)_",13,",DIC(0)="AMQEZ" D ^DIC
"RTN","GMRAPHR1",72,0)
 I $D(DUOUT)!($D(DTOUT))!(Y=-1) S GMRAOUT=1 G DQ
"RTN","GMRAPHR1",73,0)
 K DIC,DA,DO
"RTN","GMRAPHR1",74,0)
 S DA(1)=GMRAPA1,DIK="^GMR(120.85,"_DA(1)_",13,",DA=+Y D ^DIK W "DELETED.."
"RTN","GMRAPHR1",75,0)
DQ K DIC,DIC,DA,DO,DLAYGO,DIK,Y
"RTN","GMRAPHR1",76,0)
 Q
"RTN","GMRAPHR1",77,0)
LST I '$O(^GMR(120.85,GMRAPA1,13,0)) W !,"THIS PATIENT HAS NO CONCOMITANT DRUGS ON FILE" Q
"RTN","GMRAPHR1",78,0)
 W !!,"This patient has the following Drugs selected: ",!
"RTN","GMRAPHR1",79,0)
 S GMRAX=0 F GMRAXX=1:1  S GMRAX=$O(^GMR(120.85,GMRAPA1,13,GMRAX)) Q:GMRAX<1  W !,?10,$P(^(GMRAX,0),U)
"RTN","GMRAPHR1",80,0)
 W ! K GMRAXX,GMRAX
"RTN","GMRAPHR1",81,0)
 Q
"RTN","GMRAPHR1",82,0)
EXIT ;EXIT LINE
"RTN","GMRAPHR1",83,0)
 K DIR,Y,GMRALST,GMRASEL,GMRABGDT,GMRAENDT,^UTILITY("PSG",$J),^UTILITY("PSIV",$J),GMRARRAY
"RTN","GMRAPHR1",84,0)
 Q
"RTN","GMRAUTL2")
0^7^B71296835
"RTN","GMRAUTL2",1,0)
GMRAUTL2 ;SLC/DAN New style index utilities, update utility for 120.8 ;7/15/05  12:49
"RTN","GMRAUTL2",2,0)
 ;;4.0;Adverse Reaction Tracking;**23**;Mar 29, 1996
"RTN","GMRAUTL2",3,0)
 ;
"RTN","GMRAUTL2",4,0)
 N GMRAI,GMRAC,ENTRY,UPDATED
"RTN","GMRAUTL2",5,0)
 Q:$G(X1(1))=$G(X2(1))  ;Entry unchanged
"RTN","GMRAUTL2",6,0)
 S ENTRY=DA(1)_";GMRD(120.82,"_"^"_$P(^GMRD(120.82,DA(1),0),"^")
"RTN","GMRAUTL2",7,0)
 I $G(X1(1))>0,$G(X2(1))>0 S:$G(GMRAT)="ING" GMRAI("D",X1(1))="",GMRAI("A",X2(1))="" S:$G(GMRAT)="CLASS" GMRAC("D",X1(1))="",GMRAC("A",X2(1))="" ;Edited existing entry
"RTN","GMRAUTL2",8,0)
 I $G(X1(1))>0,$G(X2(1))="" S:$G(GMRAT)="ING" GMRAI("D",X1(1))="" S:$G(GMRAT)="CLASS" GMRAC("D",X1(1))="" ;Entry deleted
"RTN","GMRAUTL2",9,0)
 I $G(X1(1))="",$G(X2(1))>0 S:$G(GMRAT)="ING" GMRAI("A",X2(1))="" S:$G(GMRAT)="CLASS" GMRAC("A",X2(1))="" ;New entry
"RTN","GMRAUTL2",10,0)
 D QUP ;Queue updating of existing entries and order checking
"RTN","GMRAUTL2",11,0)
 Q
"RTN","GMRAUTL2",12,0)
 ;
"RTN","GMRAUTL2",13,0)
QUP ;Queue the update
"RTN","GMRAUTL2",14,0)
 S ZTRTN="UPDATE^GMRAUTL2(ENTRY,.GMRAI,.GMRAC)",ZTIO="GMRA UPDATE RESOURCE",ZTDTH=$H,ZTDESC="Update existing allergies",ZTSAVE("*")="" D ^%ZTLOAD Q
"RTN","GMRAUTL2",15,0)
 ;
"RTN","GMRAUTL2",16,0)
UPDATE(ENTRY,ING,CLASS) ;Update existing entries in 120.8 with new information.
"RTN","GMRAUTL2",17,0)
 ;Entry is IEN;File reference^Text of file entry - 6;GMRD(120.82,^STRAWBERRIES
"RTN","GMRAUTL2",18,0)
 ;ING - Array of ingredients - "A",IEN for those to be added and "D",IEN for those to be deleted
"RTN","GMRAUTL2",19,0)
 ;CLASS - Array of drug classes - "A",IEN for those to be added and "D",IEN for those to be deleted
"RTN","GMRAUTL2",20,0)
 ;
"RTN","GMRAUTL2",21,0)
 N ALLERGY,POINTER,SUB,ACTION,SUB,SUBI,SUBC,DFN,GMRAS,GMRACOM
"RTN","GMRAUTL2",22,0)
 S ALLERGY=$P(ENTRY,"^",2) Q:ALLERGY=""
"RTN","GMRAUTL2",23,0)
 S POINTER=$P(ENTRY,"^") Q:POINTER=""
"RTN","GMRAUTL2",24,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,"C",ALLERGY,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",25,0)
 .S DFN=$P(^GMR(120.8,SUB,0),U)
"RTN","GMRAUTL2",26,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",27,0)
 .Q:$P(^GMR(120.8,SUB,0),"^",3)'=POINTER  ;Same text name but not the same entry
"RTN","GMRAUTL2",28,0)
 .Q:$G(^GMR(120.8,SUB,"ER"))>0  ;Entered in error
"RTN","GMRAUTL2",29,0)
 .S GMRACOM=0
"RTN","GMRAUTL2",30,0)
 .F ACTION="A","D" D
"RTN","GMRAUTL2",31,0)
 ..S SUBI=0 F  S SUBI=$O(ING(ACTION,SUBI)) Q:'+SUBI  D
"RTN","GMRAUTL2",32,0)
 ...I ACTION="A" D ADD("I",SUB,SUBI,.GMRAS) I $G(GMRAS) S ING(ACTION,SUBI)=1,GMRACOM=1,UPDATED(DFN)=""
"RTN","GMRAUTL2",33,0)
 ...I ACTION="D" D DEL("I",SUB,SUBI,.GMRAS) I $G(GMRAS) S ING(ACTION,SUBI)=1,GMRACOM=1
"RTN","GMRAUTL2",34,0)
 ..S SUBC=0 F  S SUBC=$O(CLASS(ACTION,SUBC)) Q:'+SUBC  D
"RTN","GMRAUTL2",35,0)
 ...I ACTION="A" D ADD("C",SUB,SUBC,.GMRAS) I $G(GMRAS) S CLASS(ACTION,SUBC)=1,UPDATED(DFN)="",GMRACOM=1
"RTN","GMRAUTL2",36,0)
 ...I ACTION="D" D DEL("C",SUB,SUBC,.GMRAS) I $G(GMRAS) S GMRACOM=1,CLASS(ACTION,SUBC)=1
"RTN","GMRAUTL2",37,0)
 .I $G(GMRACOM) D ADDCOM
"RTN","GMRAUTL2",38,0)
 I $D(UPDATED) D CHKORD ;Run utility that checks for order conflicts with updated allergy data
"RTN","GMRAUTL2",39,0)
 Q
"RTN","GMRAUTL2",40,0)
 ;
"RTN","GMRAUTL2",41,0)
ADD(TYPE,ALENT,SUBENT,GMRAS) ;Adds entry to appropriate multiple
"RTN","GMRAUTL2",42,0)
 N FILE,FDA,EM
"RTN","GMRAUTL2",43,0)
 S GMRAS=1
"RTN","GMRAUTL2",44,0)
 I $D(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT)) S GMRAS=0 Q  ;Entry already exists
"RTN","GMRAUTL2",45,0)
 L +^GMR(120.8,ALENT)
"RTN","GMRAUTL2",46,0)
 S FILE=$S(TYPE="I":120.802,1:120.803)
"RTN","GMRAUTL2",47,0)
 S FDA(FILE,"+1,"_ALENT_",",.01)=SUBENT
"RTN","GMRAUTL2",48,0)
 D UPDATE^DIE("","FDA",,"EM")
"RTN","GMRAUTL2",49,0)
 L -^GMR(120.8,ALENT)
"RTN","GMRAUTL2",50,0)
 Q
"RTN","GMRAUTL2",51,0)
 ;
"RTN","GMRAUTL2",52,0)
DEL(TYPE,ALENT,SUBENT,GMRAS) ;Delete entry from multiple
"RTN","GMRAUTL2",53,0)
 N FILE,FDA,EM,ENTRY
"RTN","GMRAUTL2",54,0)
 S GMRAS=1
"RTN","GMRAUTL2",55,0)
 I '$D(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT)) S GMRAS=0 Q  ;No entry to delete
"RTN","GMRAUTL2",56,0)
 L +^GMR(120.8,ALENT)
"RTN","GMRAUTL2",57,0)
 S ENTRY=$O(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT,0)) Q:'+ENTRY
"RTN","GMRAUTL2",58,0)
 S FILE=$S(TYPE="I":120.802,1:120.803)
"RTN","GMRAUTL2",59,0)
 S FDA(FILE,ENTRY_","_ALENT_",",.01)="@"
"RTN","GMRAUTL2",60,0)
 D FILE^DIE("","FDA","EM")
"RTN","GMRAUTL2",61,0)
 L -^GMR(120.8,ALENT)
"RTN","GMRAUTL2",62,0)
 Q
"RTN","GMRAUTL2",63,0)
 ;
"RTN","GMRAUTL2",64,0)
CHKORD ;Check for orders that are now in conflict with existing allergy data
"RTN","GMRAUTL2",65,0)
 N TIME,GMRAOC,ORX,SUB,GMRAORX,GI,CNT,DFN
"RTN","GMRAUTL2",66,0)
 Q:'+$G(DUZ)  ;Don't check if no valid user to send data to
"RTN","GMRAUTL2",67,0)
 K ^TMP("ORR",$J),^TMP($J,"ERR")
"RTN","GMRAUTL2",68,0)
 S DFN=0 F  S DFN=$O(UPDATED(DFN)) Q:'+DFN  D
"RTN","GMRAUTL2",69,0)
 .D EN^ORQ1(DFN_";DPT(") ;Retrieve active orders
"RTN","GMRAUTL2",70,0)
 .S TIME=$O(^TMP("ORR",$J,0))
"RTN","GMRAUTL2",71,0)
 .Q:'^TMP("ORR",$J,TIME,"TOT")  ;No orders found
"RTN","GMRAUTL2",72,0)
 .S SUB=0 F  S SUB=$O(^TMP("ORR",$J,TIME,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",73,0)
 ..D BLD^ORCHECK(+^TMP("ORR",$J,TIME,SUB)) ;Get "order" information in order checking format
"RTN","GMRAUTL2",74,0)
 .M GMRAORX=ORX K ORX,GMRAOC
"RTN","GMRAUTL2",75,0)
 .D EN^ORKCHK(.GMRAOC,DFN,.GMRAORX,"ACCEPT")
"RTN","GMRAUTL2",76,0)
 .S GI=0,CNT=0 F  S GI=$O(GMRAOC(GI)) Q:'+GI  D
"RTN","GMRAUTL2",77,0)
 ..Q:$P(GMRAOC(GI),U,2)'=3  ;Quit if not allergy related
"RTN","GMRAUTL2",78,0)
 ..Q:$D(^OR(100,$P(GMRAOC(GI),U),9,"B",3))  ;Quit if existing allergy order check, can't be for this new information
"RTN","GMRAUTL2",79,0)
 ..S CNT=CNT+1,^TMP($J,"ERR",DFN,CNT)=$P($$STATUS^ORQOR2($P(GMRAOC(GI),U)),U,2)_" order for "_$P($$OI^ORX8($P(GMRAOC(GI),U)),U,2)_",order #"_$P(GMRAOC(GI),U)
"RTN","GMRAUTL2",80,0)
 .K GMRAORX ;Remove previous list of orders
"RTN","GMRAUTL2",81,0)
 D MAIL K ^TMP("ORR",$J),^TMP($J,"ERR")
"RTN","GMRAUTL2",82,0)
 Q
"RTN","GMRAUTL2",83,0)
 ;
"RTN","GMRAUTL2",84,0)
ADDCOM ;Add comment to updated allergy indicating changes
"RTN","GMRAUTL2",85,0)
 Q  ;Don't add comments at this time
"RTN","GMRAUTL2",86,0)
 N TYPE,ROOT,SUB2,DICR,DIEL,DL,DP,DM,DK,DIK,DC,DE,GLOB,DH,D,DQ,DR,DIC,DIE,DIA,DI,DG,DDH,DDER,DA,D0,D1
"RTN","GMRAUTL2",87,0)
 F GLOB="ING(""A"")","ING(""D"")","CLASS(""A"")","CLASS(""D"")" I $D(@GLOB) D
"RTN","GMRAUTL2",88,0)
 .S TYPE=$S(GLOB="ING(""A"")":1,GLOB="ING(""D"")":2,GLOB="CLASS(""A"")":3,1:4) ;Determines if we're adding or deleting ingredients or classes
"RTN","GMRAUTL2",89,0)
 .S COM="The following "_$S(TYPE=1!(TYPE=2):"ingredients",1:"drug classes")_" were "_$S(TYPE=2!(TYPE=4):"deleted",1:"added")_": "
"RTN","GMRAUTL2",90,0)
 .S ROOT=$S(TYPE=1:"ING(""A"")",TYPE=2:"ING(""D"")",TYPE=3:"CLASS(""A"")",1:"CLASS(""D"")")
"RTN","GMRAUTL2",91,0)
 .S SUB2=0 F  S SUB2=$O(@ROOT@(SUB2)) Q:'+SUB2  I @ROOT@(SUB2) S COM=COM_$S($P(COM,": ",2)'="":", ",1:"")_$S(TYPE=1!(TYPE=2):$$GET1^DIQ(50.416,SUB2_",",.01),1:$$GET1^DIQ(50.605,SUB2_",",.01))
"RTN","GMRAUTL2",92,0)
 .I $P(COM,": ",2)'="" L +^GMR(120.8,SUB) D ADCOM^GMRAFX(SUB,"O",COM) L -^GMR(120.8,SUB)
"RTN","GMRAUTL2",93,0)
 Q
"RTN","GMRAUTL2",94,0)
 ;
"RTN","GMRAUTL2",95,0)
MAIL ;Send message containing potential order checks to user.
"RTN","GMRAUTL2",96,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,CNT,SUB,ERR,TYPE,NUM
"RTN","GMRAUTL2",97,0)
 Q:'$D(^TMP($J,"ERR"))  ;Nothing to report
"RTN","GMRAUTL2",98,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAUTL2",99,0)
 S XMDUZ="Allergy auto-update program"
"RTN","GMRAUTL2",100,0)
 S XMY($G(DUZ,.5))="" ;Send to user who initiated change or postmaster
"RTN","GMRAUTL2",101,0)
 S XMY("G.GMRA REQUEST NEW REACTANT")="" ;Include mail group to be sure someone gets this message
"RTN","GMRAUTL2",102,0)
 S CNT=1
"RTN","GMRAUTL2",103,0)
 S ^TMP($J,"TEXT",CNT)="The "_$P(ENTRY,U,2)_" reactant was updated.",CNT=CNT+1
"RTN","GMRAUTL2",104,0)
 S ^TMP($J,"TEXT",CNT)="The following drug classes and/or drug ingredients were added:",CNT=CNT+1,^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",105,0)
 F TYPE="GMRAI","GMRAC" D
"RTN","GMRAUTL2",106,0)
 .I $D(@(TYPE)) D
"RTN","GMRAUTL2",107,0)
 ..S ^TMP($J,"TEXT",CNT)=$S(TYPE="GMRAI":"Ingredients",1:"Classes")_": ",CNT=CNT+1
"RTN","GMRAUTL2",108,0)
 ..S NUM=0 F  S NUM=$O(@TYPE@("A",NUM)) Q:'+NUM  S ^TMP($J,"TEXT",CNT)=$G(^TMP($J,"TEXT",CNT))_$S($L($G(^TMP($J,"TEXT",CNT))):",",1:"")_$$GET1^DIQ($S(TYPE="GMRAI":50.416,1:50.605),NUM_",",.01)
"RTN","GMRAUTL2",109,0)
 ..S CNT=CNT+1,^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",110,0)
 S ^TMP($J,"TEXT",CNT)="As a result of the update the following patients have drug-allergy",CNT=CNT+1
"RTN","GMRAUTL2",111,0)
 S ^TMP($J,"TEXT",CNT)="interactions that need to be reviewed to ensure the patient's safety.",CNT=CNT+1
"RTN","GMRAUTL2",112,0)
 S SUB=0 F  S SUB=$O(^TMP($J,"ERR",SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",113,0)
 .S ^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",114,0)
 .S ^TMP($J,"TEXT",CNT)=$$GET1^DIQ(2,SUB_",",.01),CNT=CNT+1
"RTN","GMRAUTL2",115,0)
 .S ERR=0 F  S ERR=$O(^TMP($J,"ERR",SUB,ERR)) Q:'+ERR  S ^TMP($J,"TEXT",CNT)="   "_^TMP($J,"ERR",SUB,ERR),CNT=CNT+1
"RTN","GMRAUTL2",116,0)
 S XMTEXT="^TMP($J,""TEXT"",",XMSUB="Potential order checks from allergy update"
"RTN","GMRAUTL2",117,0)
 D ^XMD
"RTN","GMRAUTL2",118,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAUTL2",119,0)
 Q
"RTN","GMRAUTL2",120,0)
 ;
"RTN","GMRAUTL2",121,0)
TOP10 ;Check top 10 reactions after push of file 120.83
"RTN","GMRAUTL2",122,0)
 N SUB,REAC,REACNO,ARRAY,SUBNM,REACNM,GMRATXT,XMSUB,XMTEXT,XMDUZ,XMY,DIFROM,CNT
"RTN","GMRAUTL2",123,0)
 I '$L($T(SCREEN^XTID)) Q  ;No screening code so quit
"RTN","GMRAUTL2",124,0)
 S SUB=0 F  S SUB=$O(^GMRD(120.84,SUB)) Q:'+SUB  I $D(^GMRD(120.84,SUB,1)) D
"RTN","GMRAUTL2",125,0)
 .S REAC=0 F  S REAC=$O(^GMRD(120.84,SUB,1,REAC)) Q:'+REAC  D
"RTN","GMRAUTL2",126,0)
 ..S REACNO=$P(^GMRD(120.84,SUB,1,REAC,0),U) Q:'+REACNO
"RTN","GMRAUTL2",127,0)
 ..I $$SCREEN^XTID(120.83,.01,REACNO_",") D
"RTN","GMRAUTL2",128,0)
 ...S SUBNM=$P(^GMRD(120.84,SUB,0),U),REACNM=$P(^GMRD(120.83,REACNO,0),U)
"RTN","GMRAUTL2",129,0)
 ...S ARRAY(SUBNM,REACNM)=""
"RTN","GMRAUTL2",130,0)
 I $D(ARRAY) D
"RTN","GMRAUTL2",131,0)
 .S XMDUZ="Data Standardization update of file 120.83",XMY("G.GMRA REQUEST NEW REACTANT")=""
"RTN","GMRAUTL2",132,0)
 .S GMRATXT(1)="The signs/symptoms file has been automatically updated.  You're receiving"
"RTN","GMRAUTL2",133,0)
 .S GMRATXT(2)="this message because one or more signs/symptoms was inactivated during this"
"RTN","GMRAUTL2",134,0)
 .S GMRATXT(3)="update and the term(s) appear in your top ten list and must be replaced."
"RTN","GMRAUTL2",135,0)
 .S GMRATXT(4)="Below you will find the name of the site parameter and the terms that are now"
"RTN","GMRAUTL2",136,0)
 .S GMRATXT(5)="inactive for that entry.  Use the Enter/Edit Site Parameters [GMRA SITE FILE]"
"RTN","GMRAUTL2",137,0)
 .S GMRATXT(6)="option to find and replace these terms."
"RTN","GMRAUTL2",138,0)
 .S GMRATXT(7)=""
"RTN","GMRAUTL2",139,0)
 .S CNT=7
"RTN","GMRAUTL2",140,0)
 .S SUB="" F  S SUB=$O(ARRAY(SUB)) Q:SUB=""  S CNT=CNT+1,GMRATXT(CNT)="Site parameter: "_SUB D  S CNT=CNT+1,GMRATXT(CNT)=""
"RTN","GMRAUTL2",141,0)
 ..S REAC="" F  S REAC=$O(ARRAY(SUB,REAC)) Q:REAC=""  S CNT=CNT+1,GMRATXT(CNT)="Term: "_REAC
"RTN","GMRAUTL2",142,0)
 .S XMTEXT="GMRATXT(",XMSUB="Signs/symptoms require updating"
"RTN","GMRAUTL2",143,0)
 .D ^XMD
"RTN","GMRAUTL2",144,0)
 Q
"RTN","GMRAUTL2",145,0)
 ;
"RTN","GMRAUTL2",146,0)
QREACT ;Queue name update, called from "AC" xref in file 120.82.  Entire section added in patch 23
"RTN","GMRAUTL2",147,0)
 N OTERM,NTERM,ZTRTN,ZTDTH,ZTIO,ZTDESC
"RTN","GMRAUTL2",148,0)
 Q:X1(1)=""!(X2(1)="")  ;Entry is new or has been deleted, no updating required
"RTN","GMRAUTL2",149,0)
 Q:X1(1)=X2(1)  ;Entry has been updated to same value, no updating required
"RTN","GMRAUTL2",150,0)
 S OTERM=X1(1),NTERM=X2(1)
"RTN","GMRAUTL2",151,0)
 S ZTRTN="REACT^GMRAUTL2",ZTIO="GMRA UPDATE RESOURCE",ZTDTH=$H,ZTDESC="UPDATE REACTANT FIELD IN 120.8",ZTSAVE("*")="" D ^%ZTLOAD
"RTN","GMRAUTL2",152,0)
 Q
"RTN","GMRAUTL2",153,0)
 ;
"RTN","GMRAUTL2",154,0)
REACT ;Update REACTANT field with name from 120.82.  Section added with patch 23
"RTN","GMRAUTL2",155,0)
 N IEN,FDA,EM,DFN
"RTN","GMRAUTL2",156,0)
 S IEN=0 F  S IEN=$O(^GMR(120.8,"C",OTERM,IEN)) Q:'+IEN  D
"RTN","GMRAUTL2",157,0)
 .S DFN=$P(^GMR(120.8,IEN,0),U)
"RTN","GMRAUTL2",158,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",159,0)
 .Q:+$G(^GMR(120.8,IEN,"ER"))  ;Don't update if entered in error
"RTN","GMRAUTL2",160,0)
 .L +^GMR(120.8,IEN)
"RTN","GMRAUTL2",161,0)
 .S FDA(120.8,IEN_",",.02)=NTERM
"RTN","GMRAUTL2",162,0)
 .D FILE^DIE("","FDA","EM")
"RTN","GMRAUTL2",163,0)
 .L -^GMR(120.8,IEN)
"RTN","GMRAUTL2",164,0)
 Q
"RTN","GMRAY23")
0^19^B35594453
"RTN","GMRAY23",1,0)
GMRAY23 ;SLC/DAN Installation Utilities ;7/18/05  08:06
"RTN","GMRAY23",2,0)
 ;;4.0;Adverse Reaction Tracking;**23**;Mar 29, 1996
"RTN","GMRAY23",3,0)
 ;
"RTN","GMRAY23",4,0)
 ;DBIA SECTION
"RTN","GMRAY23",5,0)
 ;3744  - $$TESTPAT^VADPT
"RTN","GMRAY23",6,0)
 ;10061 - VADPT
"RTN","GMRAY23",7,0)
 ;2916  - DDMOD
"RTN","GMRAY23",8,0)
 ;10013 - DIK
"RTN","GMRAY23",9,0)
 ;2056  - DIQ
"RTN","GMRAY23",10,0)
 ;10018 - DIE
"RTN","GMRAY23",11,0)
 ;10070 - XMD
"RTN","GMRAY23",12,0)
 ;10103 - XLFDT
"RTN","GMRAY23",13,0)
 ;2051  - DIC
"RTN","GMRAY23",14,0)
 ;2232  - XUDHSET
"RTN","GMRAY23",15,0)
 ;
"RTN","GMRAY23",16,0)
PRETRAN ;Load descriptions for files 120.82 and 120.83
"RTN","GMRAY23",17,0)
 M @XPDGREF@("GMRADD82")=^DIC(120.82,"%D")
"RTN","GMRAY23",18,0)
 M @XPDGREF@("GMRADD83")=^DIC(120.83,"%D")
"RTN","GMRAY23",19,0)
 Q
"RTN","GMRAY23",20,0)
 ;
"RTN","GMRAY23",21,0)
GETERMS ;Make the request for the allergy standardized terms to be pushed to the site
"RTN","GMRAY23",22,0)
 N TMP,GMRADOM
"RTN","GMRAY23",23,0)
 S TMP=$$GETIEN^HDISVF09("ALLERGIES",.GMRADOM)
"RTN","GMRAY23",24,0)
 D EN^HDISVCMR(GMRADOM,"")
"RTN","GMRAY23",25,0)
 Q
"RTN","GMRAY23",26,0)
 ;
"RTN","GMRAY23",27,0)
POST ;Post installation processes
"RTN","GMRAY23",28,0)
 N ERR,GMRADONT
"RTN","GMRAY23",29,0)
 D RESFILE
"RTN","GMRAY23",30,0)
 D RESDEV
"RTN","GMRAY23",31,0)
 D FIXREF
"RTN","GMRAY23",32,0)
 D ^GMRAY23A,^GMRAY23B,^GMRAY23C ;Set up new style xrefs
"RTN","GMRAY23",33,0)
 ;S GMRADONT=1 ;When GMRADONT is defined, messages are NOT sent to HDR
"RTN","GMRAY23",34,0)
 D CLN85
"RTN","GMRAY23",35,0)
 D FIXALG
"RTN","GMRAY23",36,0)
 D GETERMS
"RTN","GMRAY23",37,0)
 D MAIL
"RTN","GMRAY23",38,0)
 Q
"RTN","GMRAY23",39,0)
 ;
"RTN","GMRAY23",40,0)
CLN85 ;Clean up erroneous date/times that are in the STOP DATE OF ADMINISTRATION field of CONCOMITANT DRUG multiple
"RTN","GMRAY23",41,0)
 N GMRAI,GMRAJ,ENDT
"RTN","GMRAY23",42,0)
 S GMRAI=0 F  S GMRAI=$O(^GMR(120.85,GMRAI)) Q:'+GMRAI  I $D(^GMR(120.85,GMRAI,13)) D
"RTN","GMRAY23",43,0)
 .S GMRAJ=0 F  S GMRAJ=$O(^GMR(120.85,GMRAI,13,GMRAJ)) Q:'+GMRAJ  D
"RTN","GMRAY23",44,0)
 ..S ENDT=$P($G(^GMR(120.85,GMRAI,13,GMRAJ,0)),U,3) Q:ENDT=""
"RTN","GMRAY23",45,0)
 ..I ENDT\1'=ENDT S $P(^GMR(120.85,GMRAI,13,GMRAJ,0),U,3)=ENDT\1 ;If value is date/time strip time
"RTN","GMRAY23",46,0)
 Q
"RTN","GMRAY23",47,0)
 ;
"RTN","GMRAY23",48,0)
FIXALG ;Loop through 120.8, fix database issues
"RTN","GMRAY23",49,0)
 N GMRAI,FREE,REACTANT,ENTRY
"RTN","GMRAY23",50,0)
 S FREE=$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0)) S:'+FREE ERR=1 S:FREE FREE=FREE_";GMRD(120.82," Q:$G(ERR)
"RTN","GMRAY23",51,0)
 S GMRAI=0 F  S GMRAI=$O(^GMR(120.8,GMRAI)) Q:'+GMRAI  D
"RTN","GMRAY23",52,0)
 .I '$D(^GMR(120.8,GMRAI,0))!($L(^GMR(120.8,GMRAI,0),"^")=1) D DEL Q
"RTN","GMRAY23",53,0)
 .Q:$$TESTPAT^VADPT($P(^GMR(120.8,GMRAI,0),U))  ;stop if test patient
"RTN","GMRAY23",54,0)
 .I $D(^GMR(120.8,GMRAI,10)) D CHECKSS ;Check signs/symptoms for broken pointers
"RTN","GMRAY23",55,0)
 .D CHECK23(.DELETED) Q:$G(DELETED)  ;If pieces 2 and 3 cannot be resolved, delete entry
"RTN","GMRAY23",56,0)
 Q
"RTN","GMRAY23",57,0)
 ;
"RTN","GMRAY23",58,0)
DEL ;No zero node, remove entry
"RTN","GMRAY23",59,0)
 N DIK,DA
"RTN","GMRAY23",60,0)
 S DIK="^GMR(120.8,",DA=GMRAI
"RTN","GMRAY23",61,0)
 D ^DIK
"RTN","GMRAY23",62,0)
 Q
"RTN","GMRAY23",63,0)
 ;
"RTN","GMRAY23",64,0)
CHECKSS ;Check Signs/Symptoms for broken pointers, delete if necessary
"RTN","GMRAY23",65,0)
 N GMRAJ,REF,DIK,DA,RIEN
"RTN","GMRAY23",66,0)
 S GMRAJ=0 F  S GMRAJ=$O(^GMR(120.8,GMRAI,10,GMRAJ)) Q:'+GMRAJ  D
"RTN","GMRAY23",67,0)
 .S REF=$P($G(^GMR(120.8,GMRAI,10,GMRAJ,0)),U) ;Pointer to 120.83
"RTN","GMRAY23",68,0)
 .I REF I $D(^GMRD(120.83,REF)) Q  ;Pointer isn't broken - done
"RTN","GMRAY23",69,0)
 .S DA(1)=GMRAI,DA=GMRAJ,DIK="^GMR(120.8,DA(1),10," D ^DIK ;Remove S/S with broken pointer
"RTN","GMRAY23",70,0)
 .;If observed reaction then there should be a broken pointer in 120.85
"RTN","GMRAY23",71,0)
 .S RIEN=$O(^GMR(120.85,"C",GMRAI,0)) Q:'+RIEN
"RTN","GMRAY23",72,0)
 .S DA(1)=RIEN
"RTN","GMRAY23",73,0)
 .S DA=$O(^GMR(120.85,RIEN,2,"B",REF,0)) Q:'+DA  ;S/S not found
"RTN","GMRAY23",74,0)
 .S DIK="^GMR(120.85,DA(1),2," D ^DIK ;Remove S/S from obs entry
"RTN","GMRAY23",75,0)
 Q
"RTN","GMRAY23",76,0)
 ;
"RTN","GMRAY23",77,0)
CHECK23(DELETED) ;Check REACTANT (piece 2) and GMR ALLERGY (piece 3) to make sure they are present and valid
"RTN","GMRAY23",78,0)
 N REACTANT,ALLPTR,GMRA0,IEN,FILE,DIE,DA,DR,BROKEN
"RTN","GMRAY23",79,0)
 S DELETED=0
"RTN","GMRAY23",80,0)
 S GMRA0=$G(^GMR(120.8,GMRAI,0))
"RTN","GMRAY23",81,0)
 S REACTANT=$P(GMRA0,U,2)
"RTN","GMRAY23",82,0)
 S ALLPTR=$P(GMRA0,U,3)
"RTN","GMRAY23",83,0)
 S FILE=$P(ALLPTR,";",2)
"RTN","GMRAY23",84,0)
 S IEN=$P(ALLPTR,";")
"RTN","GMRAY23",85,0)
 S BROKEN=$S(ALLPTR="":1,FILE="":1,IEN="":1,1:$G(@("^"_FILE_IEN_",0)"))="")
"RTN","GMRAY23",86,0)
 I ALLPTR=""!(BROKEN) D  Q  ;If no pointer present or pointer is broken
"RTN","GMRAY23",87,0)
 .I REACTANT'="" S $P(^GMR(120.8,GMRAI,0),U,3)=FREE Q  ;If REACTANT field has a value then set GMR ALLERGY to "free text" entry
"RTN","GMRAY23",88,0)
 .I REACTANT="" D DEL S DELETED=1 Q  ;If no pointer or broken pointer and no value in REACTANT then delete entry
"RTN","GMRAY23",89,0)
 Q:DELETED
"RTN","GMRAY23",90,0)
 I ALLPTR'="",REACTANT="" D  ;Pointer exists but no value in REACTANT field
"RTN","GMRAY23",91,0)
 .S FILE=+$P(@("^"_FILE_"0)"),U,2) ;Get file number
"RTN","GMRAY23",92,0)
 .S REACTANT=$$GET1^DIQ(FILE,IEN,$S(FILE'=50.67:.01,1:4))
"RTN","GMRAY23",93,0)
 .S DIE="^GMR(120.8,",DA=GMRAI,DR=".02////"_REACTANT D ^DIE
"RTN","GMRAY23",94,0)
 Q
"RTN","GMRAY23",95,0)
 ;
"RTN","GMRAY23",96,0)
MAIL ;Send message indicating post install is finished
"RTN","GMRAY23",97,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,GMRATXT,CNT,VADM,DFN,REACTANT,LOOP,DIFROM
"RTN","GMRAY23",98,0)
 S XMDUZ="PATCH GMRA*4*23 POST-INSTALL",XMY(.5)="" S:$G(DUZ) XMY(DUZ)=""
"RTN","GMRAY23",99,0)
 S GMRATXT(1)="The post-install routine for patch GMRA*4*23"
"RTN","GMRAY23",100,0)
 S GMRATXT(2)="finished on "_$$FMTE^XLFDT($$NOW^XLFDT)_"."
"RTN","GMRAY23",101,0)
 S GMRATXT(3)=""
"RTN","GMRAY23",102,0)
 S CNT=3
"RTN","GMRAY23",103,0)
 I $G(ERR)=1 D
"RTN","GMRAY23",104,0)
 .S GMRATXT(4)="**NOTE: There was a problem with the installation!"
"RTN","GMRAY23",105,0)
 .S GMRATXT(5)="Required entry missing from file 120.82 - CONVERSION ABORTED.",GMRATXT(6)="Contact the National Help Desk for Immediate assistance."
"RTN","GMRAY23",106,0)
 S XMTEXT="GMRATXT(",XMSUB="PATCH GMRA*4*23 Post Install COMPLETED"
"RTN","GMRAY23",107,0)
 D ^XMD
"RTN","GMRAY23",108,0)
 Q
"RTN","GMRAY23",109,0)
 ;
"RTN","GMRAY23",110,0)
RESFILE ;Restrict file access and update description
"RTN","GMRAY23",111,0)
 N FILE,J,GMRASEC
"RTN","GMRAY23",112,0)
 M ^DIC(120.82,"%D")=@XPDGREF@("GMRADD82")
"RTN","GMRAY23",113,0)
 M ^DIC(120.83,"%D")=@XPDGREF@("GMRADD83")
"RTN","GMRAY23",114,0)
 F J="DD","WR","DEL","LAYGO","AUDIT" S GMRASEC(J)="@"
"RTN","GMRAY23",115,0)
 F FILE=120.82,120.83 D
"RTN","GMRAY23",116,0)
 .S ^DD(FILE,.01,"LAYGO",1,0)="D:'$D(XUMF) EN^DDIOL(""Entries must be added via the Master File Server (MFS)."","""",""!?5,$C(7)"") I $D(XUMF)"
"RTN","GMRAY23",117,0)
 .S ^DD(FILE,.01,7.5)="I $G(DIC(0))[""L"",'$D(XUMF) K X D EN^DDIOL(""Entries must be edited via the Master File Server (MFS)."","""",""!?5,$C(7)"")"
"RTN","GMRAY23",118,0)
 .S ^DD(FILE,.01,"DEL",1,0)="D:'$D(XUMF) EN^DDIOL(""Entries must be inactivated via the Master File Server (MFS)."","""",""!?5,$C(7)"") I $D(XUMF)"
"RTN","GMRAY23",119,0)
 .D FILESEC^DDMOD(FILE,.GMRASEC) ;Force security update to file
"RTN","GMRAY23",120,0)
 F J=.01,1,2,99.98,99.99 S ^DD(120.82,J,9)="^",^DD(120.83,J,9)="^"
"RTN","GMRAY23",121,0)
 F J=120.821,120.831 S ^DD(J,.01,9)="^",^DD(J,.02,9)="^"
"RTN","GMRAY23",122,0)
 F J=120.823,120.824,120.8205 S ^DD(J,.01,9)="^"
"RTN","GMRAY23",123,0)
 Q
"RTN","GMRAY23",124,0)
 ;
"RTN","GMRAY23",125,0)
RESDEV ;Set up resource device
"RTN","GMRAY23",126,0)
 N X
"RTN","GMRAY23",127,0)
 S X=$$RES^XUDHSET("GMRA UPDATE RESOURCE",,1,"Allergy update control")
"RTN","GMRAY23",128,0)
 Q
"RTN","GMRAY23",129,0)
 ;
"RTN","GMRAY23",130,0)
FIXREF ;Fix new style xrefs so they fire when using DIK to set xrefs for an entry in the file
"RTN","GMRAY23",131,0)
 N LCV,DIE,DR,DA
"RTN","GMRAY23",132,0)
 S LCV=0 F  S LCV=$O(^DD("IX","IX","AHDR",LCV)) Q:'+LCV  S DIE="^DD(""IX"",",DA=LCV,DR=".41///"_"R" D ^DIE
"RTN","GMRAY23",133,0)
 Q
"RTN","GMRAY23A")
0^3^B1029998
"RTN","GMRAY23A",1,0)
GMRAY23A ;SLC/DAN-CREATE NEW-STYLE XREF ;7/6/05  10:22
"RTN","GMRAY23A",2,0)
 ;;4.0;Adverse Reaction Tracking;**23**;Mar 29, 1996
"RTN","GMRAY23A",3,0)
 ;
"RTN","GMRAY23A",4,0)
 N GMRAXR,GMRARES,GMRAOUT
"RTN","GMRAY23A",5,0)
 S GMRAXR("FILE")=120.824
"RTN","GMRAY23A",6,0)
 S GMRAXR("NAME")="AC"
"RTN","GMRAY23A",7,0)
 S GMRAXR("TYPE")="MU"
"RTN","GMRAY23A",8,0)
 S GMRAXR("USE")="A"
"RTN","GMRAY23A",9,0)
 S GMRAXR("EXECUTION")="F"
"RTN","GMRAY23A",10,0)
 S GMRAXR("ACTIVITY")="R"
"RTN","GMRAY23A",11,0)
 S GMRAXR("SHORT DESCR")="Identifies changes to existing ingredients"
"RTN","GMRAY23A",12,0)
 S GMRAXR("SET")="Q:$D(DIU(0))  S GMRAT=""ING"" D ^GMRAUTL2"
"RTN","GMRAY23A",13,0)
 S GMRAXR("KILL")="Q:$D(DIU(0))  S GMRAT=""ING"" D ^GMRAUTL2"
"RTN","GMRAY23A",14,0)
 S GMRAXR("VAL",1)=.01
"RTN","GMRAY23A",15,0)
 S GMRAXR("VAL",1,"COLLATION")="F"
"RTN","GMRAY23A",16,0)
 D CREIXN^DDMOD(.GMRAXR,"k",.GMRARES,"GMRAOUT")
"RTN","GMRAY23A",17,0)
 Q
"RTN","GMRAY23B")
0^4^B1182237
"RTN","GMRAY23B",1,0)
GMRAY23B ;SLC/DAN-CREATE NEW-STYLE XREF ;7/6/05  10:22
"RTN","GMRAY23B",2,0)
 ;;4.0;Adverse Reaction Tracking;**23**;Mar 29, 1996
"RTN","GMRAY23B",3,0)
 ;
"RTN","GMRAY23B",4,0)
 N GMRAXR,GMRARES,GMRAOUT
"RTN","GMRAY23B",5,0)
 S GMRAXR("FILE")=120.8205
"RTN","GMRAY23B",6,0)
 S GMRAXR("NAME")="AC"
"RTN","GMRAY23B",7,0)
 S GMRAXR("TYPE")="MU"
"RTN","GMRAY23B",8,0)
 S GMRAXR("USE")="A"
"RTN","GMRAY23B",9,0)
 S GMRAXR("EXECUTION")="F"
"RTN","GMRAY23B",10,0)
 S GMRAXR("ACTIVITY")="R"
"RTN","GMRAY23B",11,0)
 S GMRAXR("SHORT DESCR")="Update entries in 120.8 when changes are made to this subfile"
"RTN","GMRAY23B",12,0)
 S GMRAXR("SET")="Q:$D(DIU(0))  S GMRAT=""CLASS"" D ^GMRAUTL2"
"RTN","GMRAY23B",13,0)
 S GMRAXR("KILL")="Q:$D(DIU(0))  S GMRAT=""CLASS"" D ^GMRAUTL2"
"RTN","GMRAY23B",14,0)
 S GMRAXR("VAL",1)=.01
"RTN","GMRAY23B",15,0)
 S GMRAXR("VAL",1,"COLLATION")="F"
"RTN","GMRAY23B",16,0)
 D CREIXN^DDMOD(.GMRAXR,"k",.GMRARES,"GMRAOUT")
"RTN","GMRAY23B",17,0)
 Q
"RTN","GMRAY23C")
0^20^B1627478
"RTN","GMRAY23C",1,0)
GMRAY23C ;SLC/DAN-CREATE NEW-STYLE XREF ;7/18/05  08:49
"RTN","GMRAY23C",2,0)
 ;;4.0;Adverse Reaction Tracking;**23**;Mar 29, 1996
"RTN","GMRAY23C",3,0)
 ;
"RTN","GMRAY23C",4,0)
 N GMRAXR,GMRARES,GMRAOUT
"RTN","GMRAY23C",5,0)
 S GMRAXR("FILE")=120.82
"RTN","GMRAY23C",6,0)
 S GMRAXR("NAME")="AC"
"RTN","GMRAY23C",7,0)
 S GMRAXR("TYPE")="MU"
"RTN","GMRAY23C",8,0)
 S GMRAXR("USE")="A"
"RTN","GMRAY23C",9,0)
 S GMRAXR("EXECUTION")="F"
"RTN","GMRAY23C",10,0)
 S GMRAXR("ACTIVITY")="R"
"RTN","GMRAY23C",11,0)
 S GMRAXR("SHORT DESCR")="Updates REACTANT field in file 120.8 when changed"
"RTN","GMRAY23C",12,0)
 S GMRAXR("DESCR",1)="Changes to the NAME field in file 120.82 will cause an update"
"RTN","GMRAY23C",13,0)
 S GMRAXR("DESCR",2)="to the REACTANT field in file 120.8 for associated entries."
"RTN","GMRAY23C",14,0)
 S GMRAXR("SET")="Q:$D(DIU(0))  D QREACT^GMRAUTL2"
"RTN","GMRAY23C",15,0)
 S GMRAXR("KILL")="Q"
"RTN","GMRAY23C",16,0)
 S GMRAXR("VAL",1)=.01
"RTN","GMRAY23C",17,0)
 S GMRAXR("VAL",1,"COLLATION")="F"
"RTN","GMRAY23C",18,0)
 D CREIXN^DDMOD(.GMRAXR,"k",.GMRARES,"GMRAOUT")
"RTN","GMRAY23C",19,0)
 Q
"TEMP","GMRADD82",0)
^1.001^10^10^3050609^^^^
"TEMP","GMRADD82",1,0)
Contains a listing of allergies from which user can select.
"TEMP","GMRADD82",2,0)
 
"TEMP","GMRADD82",3,0)
Per VHA directive XXX, this file has been "locked down" by Data
"TEMP","GMRADD82",4,0)
Standardization (DS).  The file definition (i.e. data dictionary) shall
"TEMP","GMRADD82",5,0)
not be modified.  All additions, changes and deletions to entries in the
"TEMP","GMRADD82",6,0)
file shall be done by Enterprise Reference Terminology (ERT) using the
"TEMP","GMRADD82",7,0)
Master File Server (MFS), provided by Common Services (CS).  Creating
"TEMP","GMRADD82",8,0)
and/or editing locally defined fields in the file are not permitted.  Use
"TEMP","GMRADD82",9,0)
of locally defined fields that were created prior to VHA Directive XXX
"TEMP","GMRADD82",10,0)
shall not be supported.
"TEMP","GMRADD83",0)
^1.001^10^10^3050314^^
"TEMP","GMRADD83",1,0)
A listing of possible allergic reactions.
"TEMP","GMRADD83",2,0)
 
"TEMP","GMRADD83",3,0)
Per VHA directive XXX, this file has been "locked down" by Data
"TEMP","GMRADD83",4,0)
Standardization (DS).  The file definition (i.e. data dictionary) shall
"TEMP","GMRADD83",5,0)
not be modified.  All additions, changes and deletions to entries in the
"TEMP","GMRADD83",6,0)
file shall be done by Enterprise Reference Terminology (ERT) using the
"TEMP","GMRADD83",7,0)
Master File Server (MFS), provided by Common Services (CS).  Creating
"TEMP","GMRADD83",8,0)
and/or editing locally defined fields in the file are not permitted.  Use
"TEMP","GMRADD83",9,0)
of locally defined fields that were created prior to VHA Directive XXX
"TEMP","GMRADD83",10,0)
shall not be supported.
"UP",120.8,120.81,-1)
120.8^10
"UP",120.8,120.81,0)
120.81
"UP",120.82,120.8299,-1)
120.82^TERMSTATUS
"UP",120.82,120.8299,0)
120.8299
"UP",120.83,120.8399,-1)
120.83^TERMSTATUS
"UP",120.83,120.8399,0)
120.8399
"UP",120.84,120.841,-1)
120.84^1
"UP",120.84,120.841,0)
120.841
"VER")
8.0^22.0
"^DD",120.8,120.8,.02,0)
REACTANT^RFX^^0;2^D EN^DDIOL("Editing not allowed!","","$C(7),!?4") K X
"^DD",120.8,120.8,.02,.1)
CAUSATIVE AGENT
"^DD",120.8,120.8,.02,1,0)
^.1^^-1
"^DD",120.8,120.8,.02,1,1,0)
120.8^C
"^DD",120.8,120.8,.02,1,1,1)
S ^GMR(120.8,"C",$E(X,1,30),DA)=""
"^DD",120.8,120.8,.02,1,1,2)
K ^GMR(120.8,"C",$E(X,1,30),DA)
"^DD",120.8,120.8,.02,3)
Answer must be 3-30 characters in length.
"^DD",120.8,120.8,.02,21,0)
^^4^4^3050330^
"^DD",120.8,120.8,.02,21,1,0)
This is the agent to which the patient had this reaction.  This is the 
"^DD",120.8,120.8,.02,21,2,0)
name of the reactant and will be the result of a look up on either the GMR
"^DD",120.8,120.8,.02,21,3,0)
Allergies (120.82), National Drug (50.6), Drug Ingredients (50.416), 
"^DD",120.8,120.8,.02,21,4,0)
Local Drug (50) or VA Drug Class (50.605) files.
"^DD",120.8,120.8,.02,"DT")
3040813
"^DD",120.8,120.8,10,0)
REACTIONS^120.81P^^10;0
"^DD",120.8,120.8,10,21,0)
^.001^1^1^3050330^^^^
"^DD",120.8,120.8,10,21,1,0)
These are the reactions observed for this allergy/adverse reaction.
"^DD",120.8,120.81,0)
REACTIONS SUB-FIELD^^3^4
"^DD",120.8,120.81,0,"NM","REACTIONS")

"^DD",120.8,120.81,.01,0)
REACTION^MP120.83'^GMRD(120.83,^0;1^Q
"^DD",120.8,120.81,.01,1,0)
^.1
"^DD",120.8,120.81,.01,1,1,0)
120.81^B
"^DD",120.8,120.81,.01,1,1,1)
S ^GMR(120.8,DA(1),10,"B",$E(X,1,30),DA)=""
"^DD",120.8,120.81,.01,1,1,2)
K ^GMR(120.8,DA(1),10,"B",$E(X,1,30),DA)
"^DD",120.8,120.81,.01,3)
If an entry does not appear in the list, notify the Allergy Coordinator to have it added.
"^DD",120.8,120.81,.01,21,0)
^.001^1^1^3050330^^^^
"^DD",120.8,120.81,.01,21,1,0)
One of the reactions for this allergy/adverse reaction.
"^DD",120.8,120.81,.01,"DT")
3040813
"^DD",120.8,120.81,1,0)
OTHER REACTION^F^^0;2^K:$L(X)>30!($L(X)<3) X
"^DD",120.8,120.81,1,3)
Answer must be 3-30 characters in length.
"^DD",120.8,120.81,1,21,0)
^.001^7^7^3050330^^^
"^DD",120.8,120.81,1,21,1,0)
If this reaction cannot be found in the Sign/Symptoms (120.83) file, then
"^DD",120.8,120.81,1,21,2,0)
the free text of what the user typed in will be here, and the GMR Reaction
"^DD",120.8,120.81,1,21,3,0)
of OTHER will be the value of the Name field.
"^DD",120.8,120.81,1,21,4,0)
 
"^DD",120.8,120.81,1,21,5,0)
Once the SIGNS/SYMPTOMS file is standardized then this field will
"^DD",120.8,120.81,1,21,6,0)
no longer be needed as all entries will appear in file 120.83 and
"^DD",120.8,120.81,1,21,7,0)
free text entries will no longer be allowed.
"^DD",120.8,120.81,1,"DT")
3040813
"^DD",120.82,120.82,99.98,0)
MASTER ENTRY FOR VUID^RSI^1:YES;0:NO;^VUID;2^Q
"^DD",120.82,120.82,99.98,9)
^
"^DD",120.82,120.82,99.98,21,0)
^^2^2^3050311^
"^DD",120.82,120.82,99.98,21,1,0)
This field identifies the Master entry for a VUID associated
"^DD",120.82,120.82,99.98,21,2,0)
with a Term/Concept.
"^DD",120.82,120.82,99.98,"DT")
3050311
"^DD",120.82,120.82,99.99,0)
VUID^RFXI^^VUID;1^S X=+X K:$L(X)>20!($L(X)<1)!'(X?1.20N) X
"^DD",120.82,120.82,99.99,1,0)
^.1
"^DD",120.82,120.82,99.99,1,1,0)
120.82^AVUID
"^DD",120.82,120.82,99.99,1,1,1)
S ^GMRD(120.82,"AVUID",$E(X,1,30),DA)=""
"^DD",120.82,120.82,99.99,1,1,2)
K ^GMRD(120.82,"AVUID",$E(X,1,30),DA)
"^DD",120.82,120.82,99.99,1,1,"%D",0)
^^1^1^3050217^
"^DD",120.82,120.82,99.99,1,1,"%D",1,0)
File entries by VUID.
"^DD",120.82,120.82,99.99,1,1,"DT")
3050217
"^DD",120.82,120.82,99.99,3)
Answer must be 1-20 characters in length.
"^DD",120.82,120.82,99.99,9)
^
"^DD",120.82,120.82,99.99,21,0)
^.001^2^2^3050311^^^^
"^DD",120.82,120.82,99.99,21,1,0)
VHA Unique ID (VUID).  A unique meaningless integer
"^DD",120.82,120.82,99.99,21,2,0)
assigned to reference terms VHA wide.
"^DD",120.82,120.82,99.99,"DT")
3050311
"^DD",120.82,120.82,99.991,0)
EFFECTIVE DATE/TIME^120.8299D^^TERMSTATUS;0
"^DD",120.82,120.82,99.991,21,0)
^.001^2^2^3050509^^^
"^DD",120.82,120.82,99.991,21,1,0)
Describes the pair Status and Effective Date/Time for each reference
"^DD",120.82,120.82,99.991,21,2,0)
term.
"^DD",120.82,120.8299,0)
EFFECTIVE DATE/TIME SUB-FIELD^^.02^2
"^DD",120.82,120.8299,0,"DT")
3050303
"^DD",120.82,120.8299,0,"IX","B",120.8299,.01)

"^DD",120.82,120.8299,0,"NM","EFFECTIVE DATE/TIME")

"^DD",120.82,120.8299,0,"UP")
120.82
"^DD",120.82,120.8299,.01,0)
EFFECTIVE DATE/TIME^RDI^^0;1^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",120.82,120.8299,.01,1,0)
^.1
"^DD",120.82,120.8299,.01,1,1,0)
120.8299^B
"^DD",120.82,120.8299,.01,1,1,1)
S ^GMRD(120.82,DA(1),"TERMSTATUS","B",$E(X,1,30),DA)=""
"^DD",120.82,120.8299,.01,1,1,2)
K ^GMRD(120.82,DA(1),"TERMSTATUS","B",$E(X,1,30),DA)
"^DD",120.82,120.8299,.01,1,1,"%D",0)
^^1^1^3050303^
"^DD",120.82,120.8299,.01,1,1,"%D",1,0)
Cross-referenced by Effective Date/Time
"^DD",120.82,120.8299,.01,9)
^
"^DD",120.82,120.8299,.01,21,0)
^.001^2^2^3050509^^^^
"^DD",120.82,120.8299,.01,21,1,0)
This is the date/time when the Status of the reference term
"^DD",120.82,120.8299,.01,21,2,0)
was established.
"^DD",120.82,120.8299,.01,"DT")
3050303
"^DD",120.82,120.8299,.02,0)
STATUS^RSI^1:ACTIVE;0:INACTIVE;^0;2^Q
"^DD",120.82,120.8299,.02,9)
^
"^DD",120.82,120.8299,.02,21,0)
^^4^4^3050303^
"^DD",120.82,120.8299,.02,21,1,0)
The Status of a reference term is either 'ACTIVE' or 'INACTIVE'.  If
"^DD",120.82,120.8299,.02,21,2,0)
'ACTIVE', then the term will be accessible by end-users to
"^DD",120.82,120.8299,.02,21,3,0)
document a particular patient event.  If 'INACTIVE', then the term
"^DD",120.82,120.8299,.02,21,4,0)
will only be accessible by the application to display legacy data.
"^DD",120.82,120.8299,.02,"DT")
3050303
"^DD",120.83,120.83,99.98,0)
MASTER ENTRY FOR VUID^RSI^1:YES;0:NO;^VUID;2^Q
"^DD",120.83,120.83,99.98,9)
^
"^DD",120.83,120.83,99.98,21,0)
^.001^2^2^3050314^^^
"^DD",120.83,120.83,99.98,21,1,0)
This field identifies the Master entry for a VUID associated with
"^DD",120.83,120.83,99.98,21,2,0)
a Term/Concept.
"^DD",120.83,120.83,99.98,"DT")
3050311
"^DD",120.83,120.83,99.99,0)
VUID^RFXI^^VUID;1^S X=+X K:$L(X)>20!($L(X)<1)!'(X?1.20N) X
"^DD",120.83,120.83,99.99,1,0)
^.1
"^DD",120.83,120.83,99.99,1,1,0)
120.83^AVUID
"^DD",120.83,120.83,99.99,1,1,1)
S ^GMRD(120.83,"AVUID",$E(X,1,30),DA)=""
"^DD",120.83,120.83,99.99,1,1,2)
K ^GMRD(120.83,"AVUID",$E(X,1,30),DA)
"^DD",120.83,120.83,99.99,1,1,"%D",0)
^^1^1^3050304^
"^DD",120.83,120.83,99.99,1,1,"%D",1,0)
This cross-reference is by VUID.
"^DD",120.83,120.83,99.99,1,1,"DT")
3050304
"^DD",120.83,120.83,99.99,3)
Answer must be 1-20 digits in length.
"^DD",120.83,120.83,99.99,9)
^
"^DD",120.83,120.83,99.99,21,0)
^.001^2^2^3050314^^^^
"^DD",120.83,120.83,99.99,21,1,0)
VHA Unique ID (VUID).  A unique meaningless integer assigned to
"^DD",120.83,120.83,99.99,21,2,0)
reference terms VHA wide.
"^DD",120.83,120.83,99.99,"DT")
3050311
"^DD",120.83,120.83,99.991,0)
EFFECTIVE DATE/TIME^120.8399DA^^TERMSTATUS;0
"^DD",120.83,120.83,99.991,21,0)
^^2^2^3050310^
"^DD",120.83,120.83,99.991,21,1,0)
Describes the pair status and effective date/time for each
"^DD",120.83,120.83,99.991,21,2,0)
reference term.
"^DD",120.83,120.8399,0)
EFFECTIVE DATE/TIME SUB-FIELD^^.02^2
"^DD",120.83,120.8399,0,"DT")
3050310
"^DD",120.83,120.8399,0,"IX","B",120.8399,.01)

"^DD",120.83,120.8399,0,"NM","EFFECTIVE DATE/TIME")

"^DD",120.83,120.8399,0,"UP")
120.83
"^DD",120.83,120.8399,.01,0)
EFFECTIVE DATE/TIME^RDI^^0;1^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",120.83,120.8399,.01,1,0)
^.1
"^DD",120.83,120.8399,.01,1,1,0)
120.8399^B
"^DD",120.83,120.8399,.01,1,1,1)
S ^GMRD(120.83,DA(1),"TERMSTATUS","B",$E(X,1,30),DA)=""
"^DD",120.83,120.8399,.01,1,1,2)
K ^GMRD(120.83,DA(1),"TERMSTATUS","B",$E(X,1,30),DA)
"^DD",120.83,120.8399,.01,9)
^
"^DD",120.83,120.8399,.01,21,0)
^.001^2^2^3050310^^^
"^DD",120.83,120.8399,.01,21,1,0)
This is the date/time when the status of the reference term was
"^DD",120.83,120.8399,.01,21,2,0)
established
"^DD",120.83,120.8399,.01,"DT")
3050310
"^DD",120.83,120.8399,.02,0)
STATUS^RSI^1:ACTIVE;0:INACTIVE;^0;2^Q
"^DD",120.83,120.8399,.02,9)
^
"^DD",120.83,120.8399,.02,21,0)
^.001^4^4^3050310^^
"^DD",120.83,120.8399,.02,21,1,0)
The status of a reference term is either 'ACTIVE' or 'INACTIVE'.  If
"^DD",120.83,120.8399,.02,21,2,0)
'ACTIVE', then the term will be accessible by end-users to 
"^DD",120.83,120.8399,.02,21,3,0)
document a particular patient event.  If 'INACTIVE', then the term will
"^DD",120.83,120.8399,.02,21,4,0)
only be accessible by the application to display legacy data.
"^DD",120.83,120.8399,.02,"DT")
3050310
"^DD",120.84,120.84,1,0)
TOP 10 REACTIONS^120.841IP^^1;0
"^DD",120.84,120.84,1,21,0)
^^3^3^2910828^^^^
"^DD",120.84,120.84,1,21,1,0)
A list of reactions for the user to choose from when selecting reactions
"^DD",120.84,120.84,1,21,2,0)
for a patient allergy/adverse reactions.  These will be the ten most
"^DD",120.84,120.84,1,21,3,0)
common reactions, and modifiable by the site.
"^DD",120.84,120.841,0)
TOP 10 REACTIONS SUB-FIELD^^.01^1
"^DD",120.84,120.841,0,"DT")
3050518
"^DD",120.84,120.841,0,"ID","WRITE")
S GMRAHLPX="    ("_Y_")" D EN^DDIOL(GMRAHLPX,"","?0") K GMRAHLPX
"^DD",120.84,120.841,0,"IX","B",120.841,.01)

"^DD",120.84,120.841,0,"NM","TOP 10 REACTIONS")

"^DD",120.84,120.841,0,"UP")
120.84
"^DD",120.84,120.841,.01,0)
REACTION^M*P120.83'^GMRD(120.83,^0;1^S DIC("S")="I $P(^(0),U)'=""OTHER REACTION""&($S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(120.83,.01,Y_"",""),1:1))" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",120.84,120.841,.01,1,0)
^.1
"^DD",120.84,120.841,.01,1,1,0)
120.841^B
"^DD",120.84,120.841,.01,1,1,1)
S ^GMRD(120.84,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",120.84,120.841,.01,1,1,2)
K ^GMRD(120.84,DA(1),1,"B",$E(X,1,30),DA)
"^DD",120.84,120.841,.01,4)
D:DZ="?" EN^DDIOL("One of the ten most commonly selected reactions.","","!?5")
"^DD",120.84,120.841,.01,12)
Don't allow inactive sign/symptoms to be chosen
"^DD",120.84,120.841,.01,12.1)
S DIC("S")="I $P(^(0),U)'=""OTHER REACTION""&($S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(120.83,.01,Y_"",""),1:1))"
"^DD",120.84,120.841,.01,21,0)
^^1^1^2910828^^^^
"^DD",120.84,120.841,.01,21,1,0)
One of the ten most commonly selected reactions.
"^DD",120.84,120.841,.01,"DEL",1,0)
I 1 D EN^DDIOL("CANNOT DELETE FROM TOP TEN LIST","","!?4,$C(7)")
"^DD",120.84,120.841,.01,"DT")
3050518
"^DD",120.84,120.841,.01,"LAYGO",1,0)
D EN^DDIOL("CANNOT ADD ENTRIES VIA FILEMAN, SEE THE GMRA SITE FILE EDIT OPTION","","!?4,$C(7)") I 0
"BLD",5590,6)
^SEQ #21
**END**
**END**
