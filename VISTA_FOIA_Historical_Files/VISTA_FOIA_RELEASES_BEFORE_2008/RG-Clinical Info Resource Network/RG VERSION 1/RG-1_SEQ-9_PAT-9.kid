Released RG*1*9 SEQ #9
Extracted from mail message
**KIDS**:RG*1.0*9^

**INSTALL NAME**
RG*1.0*9
"BLD",1083,0)
RG*1.0*9^CLINICAL INFO RESOURCE NETWORK^0^3001031^y
"BLD",1083,1,0)
^^3^3^3001027^
"BLD",1083,1,1,0)
NASHVILLE/MURFREESBORO NDBI/MPI CLEANUP
"BLD",1083,1,2,0)
Refer to patch RG*1*9 in the FORUM Patch Module for a complete
"BLD",1083,1,3,0)
description.
"BLD",1083,4,0)
^9.64PA^^0
"BLD",1083,"ABNS",0)
^9.66A^1^1
"BLD",1083,"ABNS",1,0)
RG
"BLD",1083,"ABNS",1,1,0)
^9.661A^^
"BLD",1083,"ABNS","B","RG",1)

"BLD",1083,"ABPKG")
n^y^G.CIRN DEV@DEVCRN.ISC-ALBANY.VA.GOV
"BLD",1083,"INID")
y^y
"BLD",1083,"INIT")
RGP9PST
"BLD",1083,"KRN",0)
^9.67PA^19^17
"BLD",1083,"KRN",.4,0)
.4
"BLD",1083,"KRN",.401,0)
.401
"BLD",1083,"KRN",.402,0)
.402
"BLD",1083,"KRN",.403,0)
.403
"BLD",1083,"KRN",.5,0)
.5
"BLD",1083,"KRN",.84,0)
.84
"BLD",1083,"KRN",3.6,0)
3.6
"BLD",1083,"KRN",3.8,0)
3.8
"BLD",1083,"KRN",9.2,0)
9.2
"BLD",1083,"KRN",9.8,0)
9.8
"BLD",1083,"KRN",9.8,"NM",0)
^9.68A^7^6
"BLD",1083,"KRN",9.8,"NM",1,0)
RGFICLN^^0^B37789322
"BLD",1083,"KRN",9.8,"NM",2,0)
RGFIRM^^0^B21477446
"BLD",1083,"KRN",9.8,"NM",4,0)
RGFIPM1^^0^B32519091
"BLD",1083,"KRN",9.8,"NM",5,0)
RGP9ENV^^0^B3837385
"BLD",1083,"KRN",9.8,"NM",6,0)
RGP9PST^^0^B1160137
"BLD",1083,"KRN",9.8,"NM",7,0)
RGFIBM^^0^B20317706
"BLD",1083,"KRN",9.8,"NM","B","RGFIBM",7)

"BLD",1083,"KRN",9.8,"NM","B","RGFICLN",1)

"BLD",1083,"KRN",9.8,"NM","B","RGFIPM1",4)

"BLD",1083,"KRN",9.8,"NM","B","RGFIRM",2)

"BLD",1083,"KRN",9.8,"NM","B","RGP9ENV",5)

"BLD",1083,"KRN",9.8,"NM","B","RGP9PST",6)

"BLD",1083,"KRN",19,0)
19
"BLD",1083,"KRN",19,"NM",0)
^9.68A^^
"BLD",1083,"KRN",19.1,0)
19.1
"BLD",1083,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",1083,"KRN",101,0)
101
"BLD",1083,"KRN",101,"NM",0)
^9.68A^^
"BLD",1083,"KRN",409.61,0)
409.61
"BLD",1083,"KRN",771,0)
771
"BLD",1083,"KRN",870,0)
870
"BLD",1083,"KRN",8994,0)
8994
"BLD",1083,"KRN","B",.4,.4)

"BLD",1083,"KRN","B",.401,.401)

"BLD",1083,"KRN","B",.402,.402)

"BLD",1083,"KRN","B",.403,.403)

"BLD",1083,"KRN","B",.5,.5)

"BLD",1083,"KRN","B",.84,.84)

"BLD",1083,"KRN","B",3.6,3.6)

"BLD",1083,"KRN","B",3.8,3.8)

"BLD",1083,"KRN","B",9.2,9.2)

"BLD",1083,"KRN","B",9.8,9.8)

"BLD",1083,"KRN","B",19,19)

"BLD",1083,"KRN","B",19.1,19.1)

"BLD",1083,"KRN","B",101,101)

"BLD",1083,"KRN","B",409.61,409.61)

"BLD",1083,"KRN","B",771,771)

"BLD",1083,"KRN","B",870,870)

"BLD",1083,"KRN","B",8994,8994)

"BLD",1083,"PRE")
RGP9ENV
"BLD",1083,"QUES",0)
^9.62^^
"BLD",1083,"REQB",0)
^9.611^1^1
"BLD",1083,"REQB",1,0)
RG*1.0*5^2
"BLD",1083,"REQB","B","RG*1.0*5",1)

"INIT")
RGP9PST
"MBREQ")
0
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^^0
"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
9^3001031
"PKG",272,22,1,"PAH",1,1,0)
^^3^3^3001031
"PKG",272,22,1,"PAH",1,1,1,0)
NASHVILLE/MURFREESBORO NDBI/MPI CLEANUP
"PKG",272,22,1,"PAH",1,1,2,0)
Refer to patch RG*1*9 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,3,0)
description.
"PRE")
RGP9ENV
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","RGFIBM")
0^7^B20317706
"RTN","RGFIBM",1,0)
RGFIBM ;ALB/CJM-SEND FACILITY INTEGRATION MESSAGE ;08/27/99
"RTN","RGFIBM",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**5,9**;30 Apr 99
"RTN","RGFIBM",3,0)
 ;
"RTN","RGFIBM",4,0)
SEND(DFN,LEGACY,PRIMARY,RESULTS,ERROR) ;
"RTN","RGFIBM",5,0)
 ;Description:  Sends the facility integration message for this patient
"RTN","RGFIBM",6,0)
 ;using routing logic based on the subscription list.
"RTN","RGFIBM",7,0)
 ;
"RTN","RGFIBM",8,0)
 ;Input:
"RTN","RGFIBM",9,0)
 ;  DFN - ien of patient
"RTN","RGFIBM",10,0)
 ;  LEGACY - station number of the legacy site
"RTN","RGFIBM",11,0)
 ;  PRIMARY - station number of the primary site
"RTN","RGFIBM",12,0)
 ;Output:
"RTN","RGFIBM",13,0)
 ;  Function Value - 1 on success, 0 on failure
"RTN","RGFIBM",14,0)
 ;  RESULTS() - results array returned by calling GENERATE^HLMA (pass by reference,optional)
"RTN","RGFIBM",15,0)
 ;  ERROR - error message (pass by reference,optional)
"RTN","RGFIBM",16,0)
 ;
"RTN","RGFIBM",17,0)
 N HL,HLA,HLERR,HLL,HLDT,HLCD,HLINK0,HLINKIEN,HLINKP,HLINKX,HLDOM,HLECH,HLFS,HLHDR,HLINST,HLN,HLPARAM,HLQ,HLSAN,HLTYPE,HLX,RGI,ERRFOUND
"RTN","RGFIBM",18,0)
 K RESULTS,ERROR
"RTN","RGFIBM",19,0)
 ;
"RTN","RGFIBM",20,0)
 ;
"RTN","RGFIBM",21,0)
 I $G(DFN),$G(PRIMARY),$G(LEGACY) D
"RTN","RGFIBM",22,0)
 .;just checking!
"RTN","RGFIBM",23,0)
 E  S ERROR="MISSING PARAMETER" Q 0
"RTN","RGFIBM",24,0)
 ;
"RTN","RGFIBM",25,0)
 I '$$BUILD("HLA(""HLS"")",DFN,LEGACY,PRIMARY,.ERROR) Q 0
"RTN","RGFIBM",26,0)
 ;
"RTN","RGFIBM",27,0)
 D ROUTE^RGFIRM(DFN,LEGACY,PRIMARY,.HLL)
"RTN","RGFIBM",28,0)
 ;
"RTN","RGFIBM",29,0)
 D GENERATE^HLMA("RG FACILITY INTEGRATION SERVER","LM",1,.RESULTS)
"RTN","RGFIBM",30,0)
 ;
"RTN","RGFIBM",31,0)
 S ERRFOUND=0
"RTN","RGFIBM",32,0)
 I +$P($G(RESULTS),"^",2) S ERROR=$P(RESULTS,"^",3),ERROR="ERROR ENCOUNTERED BY HL7 WHILE SENDING FACILITY INTEGRATION MESSAGE: "_ERROR_" MSGID: "_+RESULTS D EXC^RGFIU(6,ERROR,DFN) S ERRFOUND=1
"RTN","RGFIBM",33,0)
 S RGI=0
"RTN","RGFIBM",34,0)
 I $D(RESULTS) F  S RGI=$O(RESULTS(RGI)) Q:'RGI  D
"RTN","RGFIBM",35,0)
 .I +$P($G(RESULTS(RGI)),"^",2) S ERROR=$P(RESULTS(RGI),"^",3),ERROR="ERROR ENCOUNTERED BY HL7 WHILE SENDING FACILITY INTEGRATION MESSAGE: "_ERROR_" MSGID: "_+RESULTS(RGI) D EXC^RGFIU(6,ERROR,DFN) S ERRFOUND=1
"RTN","RGFIBM",36,0)
 Q:ERRFOUND 0
"RTN","RGFIBM",37,0)
 Q 1
"RTN","RGFIBM",38,0)
 ;
"RTN","RGFIBM",39,0)
BUILD(LOC,DFN,LEGACY,PRIMARY,ERROR) ;
"RTN","RGFIBM",40,0)
 ;Description:  Builds the facility integration message.
"RTN","RGFIBM",41,0)
 ;
"RTN","RGFIBM",42,0)
 ;Input:
"RTN","RGFIBM",43,0)
 ;  LOC - global location to place the message, referenced by @indirection
"RTN","RGFIBM",44,0)
 ;  DFN - ien of patient
"RTN","RGFIBM",45,0)
 ;  LEGACY - station number of the legacy site
"RTN","RGFIBM",46,0)
 ;  PRIMARY - station number of the primary site
"RTN","RGFIBM",47,0)
 ;Output:
"RTN","RGFIBM",48,0)
 ;  Function Value - 1 on success, 0 on failure
"RTN","RGFIBM",49,0)
 ;  ERROR - error message (pass by reference,optional)
"RTN","RGFIBM",50,0)
 ;  HL7 variables defined by INIT^HLFNC2
"RTN","RGFIBM",51,0)
 ;
"RTN","RGFIBM",52,0)
 N ICNPLUS
"RTN","RGFIBM",53,0)
 K ERROR
"RTN","RGFIBM",54,0)
 ;
"RTN","RGFIBM",55,0)
 ;
"RTN","RGFIBM",56,0)
 I $G(DFN),$G(PRIMARY),$G(LEGACY) D
"RTN","RGFIBM",57,0)
 .;just checking!
"RTN","RGFIBM",58,0)
 E  S ERROR="MISSING PARAMETER NEEDED TO BUILD FACILITY INTEGRATION MESSAGE" D EXC^RGFIU(6,ERROR,DFN) Q 0
"RTN","RGFIBM",59,0)
 ;
"RTN","RGFIBM",60,0)
 ;don't send message if there is no ICN to identify it
"RTN","RGFIBM",61,0)
 S ICNPLUS=$$GETICN^MPIF001(DFN)
"RTN","RGFIBM",62,0)
 I (+ICNPLUS)'>0 S ERROR="UNABLE TO SEND FACILITY INTEGRATION MESSAGE - PATIENT LACKS ICN" D EXC^RGFIU(6,ERROR,DFN) Q 0
"RTN","RGFIBM",63,0)
 ;
"RTN","RGFIBM",64,0)
 ;don't send if local ICN
"RTN","RGFIBM",65,0)
 I $$IFLOCAL^MPIF001(DFN) S ERROR="UNABLE TO SEND FACILITY INTEGRATION MESSAGE - PATIENT ICN IS LOCAL" D EXC^RGFIU(6,ERROR,DFN) Q 0
"RTN","RGFIBM",66,0)
 ;
"RTN","RGFIBM",67,0)
 D INIT^HLFNC2("RG FACILITY INTEGRATION SERVER",.HL)
"RTN","RGFIBM",68,0)
 I $G(HL) S ERROR="ERROR ENCOUNTERED BY HL7 WHILE SENDING FACILITY INTEGRATION MESSAGE: "_HL D EXC^RGFIU(6,ERROR,DFN) Q 0
"RTN","RGFIBM",69,0)
 ;
"RTN","RGFIBM",70,0)
 S @LOC@(1)=$$EVN^VAFHLEVN("A08",51)
"RTN","RGFIBM",71,0)
 S @LOC@(2)=$$EN^VAFCPID(DFN,"2,3,5,19")
"RTN","RGFIBM",72,0)
 S @LOC@(3)="PV1"
"RTN","RGFIBM",73,0)
 S $P(@LOC@(3),HL("FS"),3)="O"
"RTN","RGFIBM",74,0)
 S @LOC@(4)="NTE"
"RTN","RGFIBM",75,0)
 S $P(@LOC@(4),HL("FS"),3)="P"
"RTN","RGFIBM",76,0)
 S $P(@LOC@(4),HL("FS"),4)=LEGACY_$E(HL("ECH"),1)_PRIMARY
"RTN","RGFIBM",77,0)
 Q 1
"RTN","RGFIBM",78,0)
 ;
"RTN","RGFIBM",79,0)
SITESEND(TO,DFN,LEGACY,PRIMARY,RESULTS,ERROR) ;
"RTN","RGFIBM",80,0)
 ;Description:  Sends the facility integration message for this patient
"RTN","RGFIBM",81,0)
 ;to a single site.
"RTN","RGFIBM",82,0)
 ;
"RTN","RGFIBM",83,0)
 ;Input:
"RTN","RGFIBM",84,0)
 ;  TO - station # of destination
"RTN","RGFIBM",85,0)
 ;  DFN - ien of patient
"RTN","RGFIBM",86,0)
 ;  LEGACY - station number (without suffix) of the legacy site
"RTN","RGFIBM",87,0)
 ;  PRIMARY - station number (without suffix) of the primary site
"RTN","RGFIBM",88,0)
 ;Output:
"RTN","RGFIBM",89,0)
 ;  Function Value - 1 on success, 0 on failure
"RTN","RGFIBM",90,0)
 ;  RESULTS() - results array returned by calling GENERATE^HLMA (pass by reference,optional)
"RTN","RGFIBM",91,0)
 ;  ERROR - error message (pass by reference,optional)
"RTN","RGFIBM",92,0)
 ;
"RTN","RGFIBM",93,0)
 N HL,HLA,HLERR,HLL,SITEIEN,LINK,HLDT,HLCD,HLINK0,HLINKIEN,HLINKP,HLINKX,HLDOM,HLECH,HLFS,HLHDR,HLINST,HLN,HLPARAM,HLQ,HLSAN,HLTYPE,HLX
"RTN","RGFIBM",94,0)
 K RESULTS,ERROR
"RTN","RGFIBM",95,0)
 ;
"RTN","RGFIBM",96,0)
 ;
"RTN","RGFIBM",97,0)
 I $G(DFN),$G(PRIMARY),$G(LEGACY),$G(TO) D
"RTN","RGFIBM",98,0)
 .;just checking!
"RTN","RGFIBM",99,0)
 E  S ERROR="MISSING PARAMETER" Q 0
"RTN","RGFIBM",100,0)
 ;
"RTN","RGFIBM",101,0)
 S SITEIEN=$$LKUP^XUAF4(TO)
"RTN","RGFIBM",102,0)
 I 'SITEIEN S ERROR="SITE NOT FOUND IN INSTITUTION FILE" Q 0
"RTN","RGFIBM",103,0)
 ;
"RTN","RGFIBM",104,0)
 ;set HLL array to route message to a single site
"RTN","RGFIBM",105,0)
 S LINK=$$GETLINK^RGFIU(SITEIEN)
"RTN","RGFIBM",106,0)
 I '$L(LINK) D
"RTN","RGFIBM",107,0)
 .D EXC^RGFIU(224,"Facility Integration Message not sent to station #  "_TO,DFN)
"RTN","RGFIBM",108,0)
 E  D
"RTN","RGFIBM",109,0)
 .S HLL("LINKS",1)="RG FACILITY INTEGRATION CLIENT^"_LINK
"RTN","RGFIBM",110,0)
 ;
"RTN","RGFIBM",111,0)
 ;create the message
"RTN","RGFIBM",112,0)
 I '$$BUILD("HLA(""HLS"")",DFN,LEGACY,PRIMARY,.ERROR) Q 0
"RTN","RGFIBM",113,0)
 ;
"RTN","RGFIBM",114,0)
 D GENERATE^HLMA("RG FACILITY INTEGRATION SERVER","LM",1,.RESULTS)
"RTN","RGFIBM",115,0)
 ;
"RTN","RGFIBM",116,0)
 I +$P($G(RESULTS),"^",2) S ERROR=$P(RESULTS,"^",3),ERROR="ERROR ENCOUNTERED BY HL7 WHILE SENDING FACILITY INTEGRATION MESSAGE: "_ERROR D EXC^RGFIU(6,ERROR,DFN) Q 0
"RTN","RGFIBM",117,0)
 Q 1
"RTN","RGFICLN")
0^1^B37789322
"RTN","RGFICLN",1,0)
RGFICLN ;ALB/CJM-MPI/PD NDBI SITE CLEANUP UTILITY ;08/27/99
"RTN","RGFICLN",2,0)
 ;;1.0; CLINICAL INFO RESOURCE NETWORK ;**9**;30 Apr 99
"RTN","RGFICLN",3,0)
 ;
"RTN","RGFICLN",4,0)
 ;Description:
"RTN","RGFICLN",5,0)
 ;Looks for patients that have the legacy site as a treating facilty or
"RTN","RGFICLN",6,0)
 ;as the CMOR and replaces it with the primary site.
"RTN","RGFICLN",7,0)
 ;
"RTN","RGFICLN",8,0)
 ;This utility can be executed in a test mode by setting the TESTMODE
"RTN","RGFICLN",9,0)
 ;input parameter to 1.
"RTN","RGFICLN",10,0)
 ;
"RTN","RGFICLN",11,0)
CLEAN(LEGACY,PRIMARY,TESTMODE,ERROR) ;
"RTN","RGFICLN",12,0)
 ;Input:
"RTN","RGFICLN",13,0)
 ;  LEGACY - station # of legacy site
"RTN","RGFICLN",14,0)
 ;  PRIMARY - station # of primary site
"RTN","RGFICLN",15,0)
 ;  TESTMODE - set to 1 if this routine is to be run in interactive mode
"RTN","RGFICLN",16,0)
 ;Output:
"RTN","RGFICLN",17,0)
 ;  Function Value:  1 on success, 0 on failure
"RTN","RGFICLN",18,0)
 ;  ERROR:  optional error msg returned on failure (pass by reference)
"RTN","RGFICLN",19,0)
 ;  ** Also sends a report to the MPI EXCEPTIONS mailgroup
"RTN","RGFICLN",20,0)
 ;
"RTN","RGFICLN",21,0)
 ;Variables:
"RTN","RGFICLN",22,0)
 ;  LEGACY("PTR"):  ien of the legacy site in the Institution file
"RTN","RGFICLN",23,0)
 ;  PRIMARY("PTR"): ien of the primary site in the institution file
"RTN","RGFICLN",24,0)
 ;
"RTN","RGFICLN",25,0)
 S TESTMODE=+$G(TESTMODE)
"RTN","RGFICLN",26,0)
 Q:'$$LOOKUP(.LEGACY,.PRIMARY,.ERROR) 0
"RTN","RGFICLN",27,0)
 D LOOP(.LEGACY,.PRIMARY)
"RTN","RGFICLN",28,0)
 Q 1
"RTN","RGFICLN",29,0)
 ;
"RTN","RGFICLN",30,0)
LOOKUP(LEGACY,PRIMARY,ERROR) ;
"RTN","RGFICLN",31,0)
 ;Does a lookup on the Institution file for the legacy and primary site
"RTN","RGFICLN",32,0)
 ;Input:
"RTN","RGFICLN",33,0)
 ;  LEGACY - station # of legacy site
"RTN","RGFICLN",34,0)
 ;  PRIMARY - station # of primary site
"RTN","RGFICLN",35,0)
 ;Output:
"RTN","RGFICLN",36,0)
 ;  function value - 1 on success, 0 on faiure
"RTN","RGFICLN",37,0)
 ;  LEGACY("PTR") - the ien (optional, pass LEGACY by reference)
"RTN","RGFICLN",38,0)
 ;  PRIMARY("PTR") - the ien (optional, pass PRIMARY by reference)
"RTN","RGFICLN",39,0)
 ;  ERROR - error message on failure (optional, pass by reference)
"RTN","RGFICLN",40,0)
 ;
"RTN","RGFICLN",41,0)
 S LEGACY("PTR")=$$LKUP^XUAF4($G(LEGACY))
"RTN","RGFICLN",42,0)
 I 'LEGACY("PTR") S ERROR="LEGACY STATION NUMBER NOT FOUND UNIQUELY IN THE INSTITUTION FILE!" Q 0
"RTN","RGFICLN",43,0)
 S PRIMARY("PTR")=$$LKUP^XUAF4($G(PRIMARY))
"RTN","RGFICLN",44,0)
 I 'PRIMARY("PTR") S ERROR="PRIMARY STATION NUMBER NOT FOUND UNIQUELY IN THE INSTITUTION FILE!" Q 0
"RTN","RGFICLN",45,0)
 Q 1
"RTN","RGFICLN",46,0)
 ;
"RTN","RGFICLN",47,0)
LOOP(LEGACY,PRIMARY) ;
"RTN","RGFICLN",48,0)
 ;Description:  Looks for patients having the Legacy site as the CMOR
"RTN","RGFICLN",49,0)
 ;or as a TF and for each such patient exchanges the legacy site with the
"RTN","RGFICLN",50,0)
 ;primary site.
"RTN","RGFICLN",51,0)
 ;
"RTN","RGFICLN",52,0)
 ;Input:
"RTN","RGFICLN",53,0)
 ;  LEGACY():  as above
"RTN","RGFICLN",54,0)
 ;  PRIMARY(): as above
"RTN","RGFICLN",55,0)
 ;Output:
"RTN","RGFICLN",56,0)
 ;  MPI/NDBI SITE CLEANUP REPORT mailed to the MPI EXCEPTIONS mailgroup
"RTN","RGFICLN",57,0)
 ;VARIABLES:
"RTN","RGFICLN",58,0)
 ;  RGREPORT - @RGREPORT will store interim results for the report
"RTN","RGFICLN",59,0)
 ;  COUNT("TF") - count of patients found with legacy as TF
"RTN","RGFICLN",60,0)
 ;  COUNT("CMOR") - count of patients found with legacy as CMOR
"RTN","RGFICLN",61,0)
 ;  HERE - station # of the site this is running on
"RTN","RGFICLN",62,0)
 ;  CMOR - patient's CMOR
"RTN","RGFICLN",63,0)
 ;  CMOR("#") - station # of patient's CMOR
"RTN","RGFICLN",64,0)
 ;
"RTN","RGFICLN",65,0)
 N DFN,COUNT,RGREPORT,HERE
"RTN","RGFICLN",66,0)
 S RGREPORT="^TMP($J,""RG FACILITY INTEGRATION CLEANUP"")"
"RTN","RGFICLN",67,0)
 K @RGREPORT
"RTN","RGFICLN",68,0)
 S HERE=$P($$SITE^VASITE(),"^",3)
"RTN","RGFICLN",69,0)
 ;
"RTN","RGFICLN",70,0)
 ;don't do this if this is the legacy site
"RTN","RGFICLN",71,0)
 Q:(HERE=LEGACY)
"RTN","RGFICLN",72,0)
 ;
"RTN","RGFICLN",73,0)
 S (COUNT("TF"),COUNT("CMOR"),DFN)=0
"RTN","RGFICLN",74,0)
 I TESTMODE W !!,"Looking for patients with legacy site as CMOR ..."
"RTN","RGFICLN",75,0)
 F  S DFN=$O(^DPT("ACMOR",LEGACY("PTR"),DFN)) Q:'DFN  D  I TESTMODE Q:'$$ASKYESNO^RGFIU("Another","YES")
"RTN","RGFICLN",76,0)
 .N CMOR
"RTN","RGFICLN",77,0)
 .S CMOR=$$GETFIELD^RGFIU(2,991.03,DFN)
"RTN","RGFICLN",78,0)
 .Q:(CMOR'=LEGACY("PTR"))
"RTN","RGFICLN",79,0)
 .I TESTMODE Q:'$$ASKOK(DFN)
"RTN","RGFICLN",80,0)
 .D PROC
"RTN","RGFICLN",81,0)
 .D CMORADD(RGREPORT,.COUNT,DFN)
"RTN","RGFICLN",82,0)
 ;
"RTN","RGFICLN",83,0)
 I TESTMODE W !!,"Looking for patients with legacy site as treating facility ..."
"RTN","RGFICLN",84,0)
 S DFN=0
"RTN","RGFICLN",85,0)
 F  S DFN=$O(^DGCN(391.91,"AINST",LEGACY("PTR"),DFN)) Q:'DFN  D  I TESTMODE Q:'$$ASKYESNO^RGFIU("Another","YES")
"RTN","RGFICLN",86,0)
 .N CMOR
"RTN","RGFICLN",87,0)
 .I TESTMODE Q:'$$ASKOK(DFN)
"RTN","RGFICLN",88,0)
 .S CMOR=$$GETFIELD^RGFIU(2,991.03,DFN)
"RTN","RGFICLN",89,0)
 .D PROC
"RTN","RGFICLN",90,0)
 .D TFADD(RGREPORT,.COUNT,DFN)
"RTN","RGFICLN",91,0)
 I $G(TESTMODE) W !,"Returned mail message number:",$$REPORT(.COUNT,RGREPORT,LEGACY,PRIMARY)
"RTN","RGFICLN",92,0)
 I '$G(TESTMODE),$$REPORT(.COUNT,RGREPORT,LEGACY,PRIMARY)
"RTN","RGFICLN",93,0)
 K @RGREPORT
"RTN","RGFICLN",94,0)
 Q
"RTN","RGFICLN",95,0)
 ;
"RTN","RGFICLN",96,0)
PROC ;
"RTN","RGFICLN",97,0)
 N RES,ERROR,I
"RTN","RGFICLN",98,0)
 I '$$XCHANGE^RGFIPM(DFN,LEGACY,PRIMARY,.ERROR),TESTMODE W !,"** ERROR: ",$G(ERROR)
"RTN","RGFICLN",99,0)
 S CMOR("#")=$$STATNUM^RGFIU(CMOR)
"RTN","RGFICLN",100,0)
 I HERE=CMOR("#") D
"RTN","RGFICLN",101,0)
 .I TESTMODE D
"RTN","RGFICLN",102,0)
 ..I $$SEND^RGFIBM(DFN,LEGACY,PRIMARY,.RES,.ERROR) W !,"HL7 Message sent: "
"RTN","RGFICLN",103,0)
 ..E  W !,"*** HL7 Message NOT sent! :",$G(ERROR)
"RTN","RGFICLN",104,0)
 ..I $D(RES) S I=0 W !," Msg 1: ",RES F  S I=$O(RES(I)) Q:'I  W !," Msg ",(I+1),": ",RES(I)
"RTN","RGFICLN",105,0)
 .I 'TESTMODE,$$SEND^RGFIBM(DFN,LEGACY,PRIMARY,.RES,.ERROR)
"RTN","RGFICLN",106,0)
 Q
"RTN","RGFICLN",107,0)
 ;
"RTN","RGFICLN",108,0)
TFADD(RGREPORT,COUNT,DFN) ;
"RTN","RGFICLN",109,0)
 ;adds patient to list of legacy as TF
"RTN","RGFICLN",110,0)
 S COUNT("TF")=COUNT("TF")+1
"RTN","RGFICLN",111,0)
 S @RGREPORT@("TF",DFN)=""
"RTN","RGFICLN",112,0)
 Q
"RTN","RGFICLN",113,0)
 ;
"RTN","RGFICLN",114,0)
CMORADD(RGREPORT,COUNT,DFN) ;
"RTN","RGFICLN",115,0)
 ;adds patient to list of legacy as CMOR
"RTN","RGFICLN",116,0)
 ;
"RTN","RGFICLN",117,0)
 S COUNT("CMOR")=COUNT("CMOR")+1
"RTN","RGFICLN",118,0)
 S @RGREPORT@("CMOR",DFN)=""
"RTN","RGFICLN",119,0)
 Q
"RTN","RGFICLN",120,0)
 ;
"RTN","RGFICLN",121,0)
ASKOK(DFN) ;
"RTN","RGFICLN",122,0)
 ;Discription: Displays the CMOR and TF's for a single patient and asks whether to process
"RTN","RGFICLN",123,0)
 ;
"RTN","RGFICLN",124,0)
 ;Input:
"RTN","RGFICLN",125,0)
 ;   DFN - patient that was just processed
"RTN","RGFICLN",126,0)
 ;Output:
"RTN","RGFICLN",127,0)
 ;   Function value - 1 to quit, 0 to continue
"RTN","RGFICLN",128,0)
 ;Variables:
"RTN","RGFICLN",129,0)
 ;   MPIDATA() - to contain the MPI data
"RTN","RGFICLN",130,0)
 ;
"RTN","RGFICLN",131,0)
 N SUB,MPIDATA
"RTN","RGFICLN",132,0)
 D GETALL^RGFIU(DFN,.MPIDATA)
"RTN","RGFICLN",133,0)
 W !!
"RTN","RGFICLN",134,0)
 W !,"Patient DFN:   ",DFN
"RTN","RGFICLN",135,0)
 W !,"Patient Name:  ",$$NAME^RGFIU(DFN)_"   SSN:  ",$$SSN^RGFIU(DFN)
"RTN","RGFICLN",136,0)
 W !,"Patient ICN:   ",MPIDATA("ICN"),$S(MPIDATA("LOC"):" (local)",1:""),"   CMOR:  ",MPIDATA("CMOR")
"RTN","RGFICLN",137,0)
 ;
"RTN","RGFICLN",138,0)
 W !,"Treating Facilities:"
"RTN","RGFICLN",139,0)
 S SUB=0
"RTN","RGFICLN",140,0)
 F  S SUB=$O(MPIDATA("TF",SUB)) Q:'SUB  W !,"    ",SUB
"RTN","RGFICLN",141,0)
 ;
"RTN","RGFICLN",142,0)
 Q $$ASKYESNO^RGFIU("Process patient")
"RTN","RGFICLN",143,0)
 ;
"RTN","RGFICLN",144,0)
REPORT(COUNT,RGREPORT,LEGACY,PRIMARY) ;
"RTN","RGFICLN",145,0)
 ;Description: Mails report of cases found requiring cleanup after a site integration
"RTN","RGFICLN",146,0)
 ;
"RTN","RGFICLN",147,0)
 ;Input:
"RTN","RGFICLN",148,0)
 ;  RGREPORT - @RGREPORT is the location of the report data
"RTN","RGFICLN",149,0)
 ;  COUNT() - contains counts of patients cleaned up (pass by reference)
"RTN","RGFICLN",150,0)
 ;  LEGACY - legacy site station #
"RTN","RGFICLN",151,0)
 ;  PRIMARY - primary site station #
"RTN","RGFICLN",152,0)
 ;Output: none
"RTN","RGFICLN",153,0)
 ;
"RTN","RGFICLN",154,0)
 ;
"RTN","RGFICLN",155,0)
 N DFN,LINECNT
"RTN","RGFICLN",156,0)
 S (DFN,LINECNT)=0
"RTN","RGFICLN",157,0)
 K @RGREPORT@("MAILTEXT")
"RTN","RGFICLN",158,0)
 D HEADER
"RTN","RGFICLN",159,0)
 D ADDLINE("** Patients with Legacy Site as CMOR **")
"RTN","RGFICLN",160,0)
 D ADDLINE(" ")
"RTN","RGFICLN",161,0)
 F  S DFN=$O(@RGREPORT@("CMOR",DFN)) Q:'DFN  D
"RTN","RGFICLN",162,0)
 .D ADDLINE("Patient: "_$$LJ^XLFSTR($$NAME^RGFIU(DFN),30)_"  SSN: "_$$SSN^RGFIU(DFN)_"  ICN: "_$$ICN^RGFIU(DFN))
"RTN","RGFICLN",163,0)
 D ADDLINE(" "),ADDLINE(" ")
"RTN","RGFICLN",164,0)
 D ADDLINE("** Patients with Legacy Site as Treating Facility **")
"RTN","RGFICLN",165,0)
 D ADDLINE(" ")
"RTN","RGFICLN",166,0)
 S DFN=0
"RTN","RGFICLN",167,0)
 F  S DFN=$O(@RGREPORT@("TF",DFN)) Q:'DFN  D
"RTN","RGFICLN",168,0)
 .D ADDLINE("Patient: "_$$LJ^XLFSTR($$NAME^RGFIU(DFN),30)_"  SSN: "_$$SSN^RGFIU(DFN)_"  ICN: "_$$ICN^RGFIU(DFN))
"RTN","RGFICLN",169,0)
 D ADDLINE(" "),ADDLINE("** END OF MPI/NDBI SITE CLEANUP REPORT **")
"RTN","RGFICLN",170,0)
 Q $$MAIL
"RTN","RGFICLN",171,0)
 ;
"RTN","RGFICLN",172,0)
HEADER ;
"RTN","RGFICLN",173,0)
 D ADDLINE("MPI/NDBI SITE CLEANUP REPORT FROM "_$P($$SITE^VASITE(),"^",2)_"       DATE: "_$$FMTE^XLFDT(DT,"1"))
"RTN","RGFICLN",174,0)
 D ADDLINE("Primary Station: "_PRIMARY_"  Legacy Station: "_LEGACY)
"RTN","RGFICLN",175,0)
 D ADDLINE("Count of Patients Found with Legacy Site as CMOR: "_COUNT("CMOR"))
"RTN","RGFICLN",176,0)
 D ADDLINE("Count of Patients Found with Legacy Site as Treating Facility: "_COUNT("TF"))
"RTN","RGFICLN",177,0)
 D ADDLINE("  ")
"RTN","RGFICLN",178,0)
 Q
"RTN","RGFICLN",179,0)
 ;
"RTN","RGFICLN",180,0)
ADDLINE(LINE) ;
"RTN","RGFICLN",181,0)
 ;Description: adds one one to the message text
"RTN","RGFICLN",182,0)
 ;Inputs:
"RTN","RGFICLN",183,0)
 ;  LINE - the line of text to be added
"RTN","RGFICLN",184,0)
 ;  RGREPORT - @RGREPORT is the location of the report
"RTN","RGFICLN",185,0)
 ;  LINECNT - should be defined, the count of lines added to mail msg
"RTN","RGFICLN",186,0)
 S LINECNT=$G(LINECNT)+1
"RTN","RGFICLN",187,0)
 S @RGREPORT@("MAILTEXT",LINECNT)=LINE
"RTN","RGFICLN",188,0)
 Q
"RTN","RGFICLN",189,0)
MAIL() ;
"RTN","RGFICLN",190,0)
 N XMY,XMSUB,XMDUZ,XMTEXT,XMZ,XMDUN,DIFROM
"RTN","RGFICLN",191,0)
 S XMY=.5
"RTN","RGFICLN",192,0)
 S XMDUZ="MPI/PD at "_$P($$SITE^VASITE(),"^",2)
"RTN","RGFICLN",193,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","RGFICLN",194,0)
 S XMY("G.MPIF EXCEPTIONS")=""
"RTN","RGFICLN",195,0)
 S XMTEXT=$P(RGREPORT,")")_",""MAILTEXT"","
"RTN","RGFICLN",196,0)
 S XMSUB="MPI/NDBI SITE CLEANUP"
"RTN","RGFICLN",197,0)
 D ^XMD
"RTN","RGFICLN",198,0)
 Q $G(XMZ)
"RTN","RGFIPM1")
0^4^B32519091
"RTN","RGFIPM1",1,0)
RGFIPM1 ;ALB/CJM-PROCESS FACILITY INTEGRATION MESSAGE ;08/27/99
"RTN","RGFIPM1",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**5,9**;30 Apr 99
"RTN","RGFIPM1",3,0)
 ;
"RTN","RGFIPM1",4,0)
RECEIVE ;
"RTN","RGFIPM1",5,0)
 ;Description: Process the Facility Integration Message
"RTN","RGFIPM1",6,0)
 ;
"RTN","RGFIPM1",7,0)
 ;Input:
"RTN","RGFIPM1",8,0)
 ;  HL7 variables must be defined
"RTN","RGFIPM1",9,0)
 ;Output: none
"RTN","RGFIPM1",10,0)
 ;Variables:
"RTN","RGFIPM1",11,0)
 ;  LEGACY - station # of legacy site
"RTN","RGFIPM1",12,0)
 ;  PRIMARY - station # of primary site
"RTN","RGFIPM1",13,0)
 ;  ICN - patient ICN from message
"RTN","RGFIPM1",14,0)
 ;  CHECKSUM - ICN checksum from message
"RTN","RGFIPM1",15,0)
 ;  CMOR - station # of CMOR
"RTN","RGFIPM1",16,0)
 ;  CMORIEN - ien of CMOR in Institution file
"RTN","RGFIPM1",17,0)
 ;  HERE - ien in Institution file of site this routine is executing on
"RTN","RGFIPM1",18,0)
 ;  HERE("STATION#") - station number of this site
"RTN","RGFIPM1",19,0)
 ;  FROM - station # of sending site
"RTN","RGFIPM1",20,0)
 ;  DFN - ien from the patient file
"RTN","RGFIPM1",21,0)
 ;  HLERR - error encountered
"RTN","RGFIPM1",22,0)
 ;  LCHKSUM - local checksum
"RTN","RGFIPM1",23,0)
 ;
"RTN","RGFIPM1",24,0)
 N CMOR,CMORIEN,LEGACY,PRIMARY,ICN,FROM,HERE,DFN,CHECKSUM,LCHKSUM
"RTN","RGFIPM1",25,0)
 K HLERR
"RTN","RGFIPM1",26,0)
 D
"RTN","RGFIPM1",27,0)
 .I '$$PARSE(0,.LEGACY,.PRIMARY,.ICN,.CHECKSUM,.FROM,.HLERR) Q
"RTN","RGFIPM1",28,0)
 .S HERE=$$SITE^VASITE(),HERE("STATION#")=$P(HERE,"^",3),HERE=+HERE
"RTN","RGFIPM1",29,0)
 .S DFN=$$DFN^RGFIU(ICN)
"RTN","RGFIPM1",30,0)
 .I ('DFN)!('$D(^DPT(+DFN))) D  Q
"RTN","RGFIPM1",31,0)
 ..S HLERR=$$ERROR("PATIENT LOOKUP BASED ON ICN FAILED",228,ICN)
"RTN","RGFIPM1",32,0)
 .;
"RTN","RGFIPM1",33,0)
 .S LCHKSUM=$P($$GETICN^MPIF001(DFN),"V",2)
"RTN","RGFIPM1",34,0)
 .I (+CHECKSUM)'=(+LCHKSUM) D  Q
"RTN","RGFIPM1",35,0)
 ..;If this is a local problem notify the local site
"RTN","RGFIPM1",36,0)
 ..I (+LCHKSUM)'=(+$$CHECKDG^MPIFSPC(ICN)) D
"RTN","RGFIPM1",37,0)
 ...S HLERR=$$ERROR("LOCAL DATABASE HAS INCORRECT ICN CHECKSUM",1,ICN)
"RTN","RGFIPM1",38,0)
 ...D EXC^RGFIU(1,$P(HLERR,"^",2),DFN)
"RTN","RGFIPM1",39,0)
 ..E  D
"RTN","RGFIPM1",40,0)
 ...S HLERR=$$ERROR("SENT INCORRECT ICN CHECKSUM",1,ICN)
"RTN","RGFIPM1",41,0)
 .;
"RTN","RGFIPM1",42,0)
 .S CMORIEN=$P($$MPINODE^RGFIU(DFN),"^",3)
"RTN","RGFIPM1",43,0)
 .S CMOR=$$STATNUM^RGFIU(CMORIEN)
"RTN","RGFIPM1",44,0)
 .;
"RTN","RGFIPM1",45,0)
 .;Notify site if there is no station number for CMOR
"RTN","RGFIPM1",46,0)
 .I 'CMOR D EXC^RGFIU(221,"ERROR ENCOUNTERED WHILE PROCESSING FACILITY INTEGRATION MESSAGE",DFN)
"RTN","RGFIPM1",47,0)
 .;
"RTN","RGFIPM1",48,0)
 .;If this is the legacy site it does not need to process this message
"RTN","RGFIPM1",49,0)
 .Q:(HERE("STATION#")=LEGACY)
"RTN","RGFIPM1",50,0)
 .;
"RTN","RGFIPM1",51,0)
 .;If this site is the CMOR, it should only be receiving this message
"RTN","RGFIPM1",52,0)
 .;from the legacy site
"RTN","RGFIPM1",53,0)
 .I (CMORIEN=HERE),(FROM'=LEGACY) D  Q
"RTN","RGFIPM1",54,0)
 ..S HLERR=$$ERROR("SITE INTEGRATION MSG TO CMOR NOT FROM LEGACY SITE",230,ICN)
"RTN","RGFIPM1",55,0)
 .;
"RTN","RGFIPM1",56,0)
 .;If this site is not the CMOR, the message must be from the CMOR
"RTN","RGFIPM1",57,0)
 .I CMORIEN,HERE'=CMORIEN,FROM'=CMOR D  Q
"RTN","RGFIPM1",58,0)
 ..S HLERR=$$ERROR("SITE INTEGRATION MSG NOT FROM CMOR, CMOR IS "_CMOR,226,ICN)
"RTN","RGFIPM1",59,0)
 .;
"RTN","RGFIPM1",60,0)
 .;update database
"RTN","RGFIPM1",61,0)
 .I '$$XCHANGE^RGFIPM(DFN,LEGACY,PRIMARY) ;local exceptins are logged by $$XCHANGE if errors are encountered
"RTN","RGFIPM1",62,0)
 .;
"RTN","RGFIPM1",63,0)
 .;at this point the receiving application has decided that it can accept the message.  An AA will be returned to the sender.
"RTN","RGFIPM1",64,0)
 .;
"RTN","RGFIPM1",65,0)
 .I '$D(HLERR),$G(HL("APAT"))="AL" D ACK(FROM,.HLERR)
"RTN","RGFIPM1",66,0)
 .;
"RTN","RGFIPM1",67,0)
 .;if this is the CMOR, notify subscribers & MPI of the site integration
"RTN","RGFIPM1",68,0)
 .I CMORIEN=HERE,'$$SEND^RGFIBM(DFN,LEGACY,PRIMARY) ;local exceptions are logged by $$SEND if errors are encountered
"RTN","RGFIPM1",69,0)
 ;
"RTN","RGFIPM1",70,0)
 I $D(HLERR),$G(HL("APAT"))="AL" D ACK(FROM,.HLERR)
"RTN","RGFIPM1",71,0)
 D:$G(RGLOG) STOP^RGHLLOG(1)
"RTN","RGFIPM1",72,0)
 Q
"RTN","RGFIPM1",73,0)
 ;
"RTN","RGFIPM1",74,0)
ACK(FROM,HLERR) ;
"RTN","RGFIPM1",75,0)
 ;Description:  Send an acknowledment
"RTN","RGFIPM1",76,0)
 ;
"RTN","RGFIPM1",77,0)
 ;Input:
"RTN","RGFIPM1",78,0)
 ;  FROM - station number of site that sent the original message
"RTN","RGFIPM1",79,0)
 ;  HLERR - error to be returned in format <exception code>^<error text>
"RTN","RGFIPM1",80,0)
 ;  HL7 variables - assumed defined
"RTN","RGFIPM1",81,0)
 ;
"RTN","RGFIPM1",82,0)
 N RESULT,HLA,FS,CS,HLL,TOLINK
"RTN","RGFIPM1",83,0)
 S TOLINK=$$GETLINK^RGFIU($$LKUP^XUAF4(FROM))
"RTN","RGFIPM1",84,0)
 S HLL("LINKS",1)="RG FACILITY INTEGRATION CLIENT^"_TOLINK
"RTN","RGFIPM1",85,0)
 S FS=HL("FS"),CS=$E(HL("ECH"),1)
"RTN","RGFIPM1",86,0)
 I $D(HLERR) D
"RTN","RGFIPM1",87,0)
 .;return NAK
"RTN","RGFIPM1",88,0)
 .S HLA("HLA",1)="MSA"_FS_"ER"_FS_HL("MID")_FS_$P($G(HLERR),";;",2)_FS_FS_FS_CS_CS_CS_$P($G(HLERR),";;")
"RTN","RGFIPM1",89,0)
 E  D
"RTN","RGFIPM1",90,0)
 .;return ACK
"RTN","RGFIPM1",91,0)
 .S HLA("HLA",1)="MSA"_FS_"AA"_FS_HL("MID")
"RTN","RGFIPM1",92,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.RESULT)
"RTN","RGFIPM1",93,0)
 Q
"RTN","RGFIPM1",94,0)
 ;
"RTN","RGFIPM1",95,0)
PARSE(SKIPMSH,LEGACY,PRIMARY,ICN,CHECKSUM,FROM,HLERR) ;
"RTN","RGFIPM1",96,0)
 ;Description:  Parses the message and returns parameters.
"RTN","RGFIPM1",97,0)
 ;Input:
"RTN","RGFIPM1",98,0)
 ;   SKIPMSH - (optional) if set to 1, means that the MSH segment is
"RTN","RGFIPM1",99,0)
 ;              not expected to exist. This is the case when the
"RTN","RGFIPM1",100,0)
 ;              routing logic is called.
"RTN","RGFIPM1",101,0)
 ;   HL7 variables must be defined (assumed)
"RTN","RGFIPM1",102,0)
 ;Output:
"RTN","RGFIPM1",103,0)
 ;  Function Value:  1 on success, 0 on failure
"RTN","RGFIPM1",104,0)
 ;  LEGACY - station # of legacy site (pass by reference)
"RTN","RGFIPM1",105,0)
 ;  PRIMARY - station # of primary site (pass by reference)
"RTN","RGFIPM1",106,0)
 ;  ICN - ICN of patient (pass by reference)
"RTN","RGFIPM1",107,0)
 ;  CHECKSUM - ICN checksum (pass by reference)
"RTN","RGFIPM1",108,0)
 ;  FROM - station # of sendign site (pass by reference)
"RTN","RGFIPM1",109,0)
 ;  HLERR - returns a message if an error is encountered (pass by reference) 
"RTN","RGFIPM1",110,0)
 ;
"RTN","RGFIPM1",111,0)
 ;Variables:
"RTN","RGFIPM1",112,0)
 ;  FS - field seperator
"RTN","RGFIPM1",113,0)
 ;  CS - component seperator
"RTN","RGFIPM1",114,0)
 ;  ERRFLAG - initially set to 1, set to 0 if message passes all checks
"RTN","RGFIPM1",115,0)
 ;
"RTN","RGFIPM1",116,0)
 N FS,CS,ERRFLAG
"RTN","RGFIPM1",117,0)
 S FS=HL("FS")
"RTN","RGFIPM1",118,0)
 S CS=$E(HL("ECH"),1)
"RTN","RGFIPM1",119,0)
 S ERRFLAG=1
"RTN","RGFIPM1",120,0)
 S (LEGACY,PRIMARY,ICN,CHECKSUM,FROM)=""
"RTN","RGFIPM1",121,0)
 K HLERR
"RTN","RGFIPM1",122,0)
 ;
"RTN","RGFIPM1",123,0)
 D
"RTN","RGFIPM1",124,0)
 .D:'$G(SKIPMSH)  Q:$D(HLERR)
"RTN","RGFIPM1",125,0)
 ..X HLNEXT I (HLQUIT'>0) S HLERR=$$SEGERROR("MSH") Q
"RTN","RGFIPM1",126,0)
 ..I $P(HLNODE,FS)'["MSH" S HLERR=$$SEGERROR("MSH") Q
"RTN","RGFIPM1",127,0)
 ..S FROM=$P($P(HLNODE,FS,4),CS)
"RTN","RGFIPM1",128,0)
 ..I 'FROM S HLERR=$$ERROR("MISSING STATION NUMBER IN MSH SEGMENT FOR SENDING SITE",11) Q
"RTN","RGFIPM1",129,0)
 .;
"RTN","RGFIPM1",130,0)
 .X HLNEXT I (HLQUIT'>0) S HLERR=$$SEGERROR("EVN") Q
"RTN","RGFIPM1",131,0)
 .I $P(HLNODE,FS)'["EVN" D  Q:$D(HLERR)
"RTN","RGFIPM1",132,0)
 ..I $G(SKIPMSH) X HLNEXT
"RTN","RGFIPM1",133,0)
 ..I $P(HLNODE,FS)'["EVN" S HLERR=$$SEGERROR("EVN") Q
"RTN","RGFIPM1",134,0)
 .I $P(HLNODE,FS,5)'=51 S HLERR=$$ERROR("EVENT REASON CODE NOT 51",9) Q
"RTN","RGFIPM1",135,0)
 .;
"RTN","RGFIPM1",136,0)
 .X HLNEXT I (HLQUIT'>0) S HLERR=$$SEGERROR("PID") Q
"RTN","RGFIPM1",137,0)
 .I $P(HLNODE,FS)'["PID" S HLERR=$$SEGERROR("PID") Q
"RTN","RGFIPM1",138,0)
 .S ICN=$P($P(HLNODE,FS,3),"V")
"RTN","RGFIPM1",139,0)
 .I 'ICN D  Q
"RTN","RGFIPM1",140,0)
 ..S HLERR=$$ERROR("MISSING ICN IN PID SEGMENT",10)
"RTN","RGFIPM1",141,0)
 .S CHECKSUM=$P($P(HLNODE,FS,3),"V",2)
"RTN","RGFIPM1",142,0)
 .;
"RTN","RGFIPM1",143,0)
 .X HLNEXT I (HLQUIT'>0) S HLERR=$$SEGERROR("PV1",ICN) Q
"RTN","RGFIPM1",144,0)
 .I $P(HLNODE,FS)'["PV1" S HLERR=$$SEGERROR("PV1",ICN) Q
"RTN","RGFIPM1",145,0)
 .;
"RTN","RGFIPM1",146,0)
 .X HLNEXT I (HLQUIT'>0) S HLERR=$$SEGERROR("NTE",ICN) Q
"RTN","RGFIPM1",147,0)
 .I $P(HLNODE,FS)'["NTE" S HLERR=$$SEGERROR("NTE",ICN) Q
"RTN","RGFIPM1",148,0)
 .S LEGACY=$P($P(HLNODE,FS,4),CS)
"RTN","RGFIPM1",149,0)
 .I 'LEGACY S HLERR=$$ERROR("MISSING LEGACY STATION # IN NTE SEGMENT",8,ICN) Q
"RTN","RGFIPM1",150,0)
 .S PRIMARY=$P($P(HLNODE,FS,4),CS,2)
"RTN","RGFIPM1",151,0)
 .I 'PRIMARY S HLERR=$$ERROR("MISSING PRIMARY STATION # IN NTE SEGMENT",8,ICN) Q
"RTN","RGFIPM1",152,0)
 .S ERRFLAG=0
"RTN","RGFIPM1",153,0)
 Q 'ERRFLAG
"RTN","RGFIPM1",154,0)
 ;
"RTN","RGFIPM1",155,0)
ERROR(ERRMSG,CODE,ICN) ;
"RTN","RGFIPM1",156,0)
 ;Description:  formats ERRMSG in format <exception type>;;<error text>
"RTN","RGFIPM1",157,0)
 ;Input:
"RTN","RGFIPM1",158,0)
 ;  ERRMSG - text to incorporate into message
"RTN","RGFIPM1",159,0)
 ;  CODE - Exception Type
"RTN","RGFIPM1",160,0)
 ;  ICN - patient ICN
"RTN","RGFIPM1",161,0)
 ;  
"RTN","RGFIPM1",162,0)
 ;
"RTN","RGFIPM1",163,0)
 Q $G(CODE)_";;"_" From Station:"_$P($$SITE^VASITE(),"^",3)_" ICN:"_$G(ICN)_" Code:"_$G(CODE)_" Msg:"_$G(ERRMSG)
"RTN","RGFIPM1",164,0)
 ;
"RTN","RGFIPM1",165,0)
 ;
"RTN","RGFIPM1",166,0)
SEGERROR(SEGMENT,ICN) ;
"RTN","RGFIPM1",167,0)
 ;Description:  formats error if expected segment not there
"RTN","RGFIPM1",168,0)
 S ERRMSG="MISSING SEGMENT: "_SEGMENT
"RTN","RGFIPM1",169,0)
 Q $$ERROR(ERRMSG,7,$G(ICN))
"RTN","RGFIRM")
0^2^B21477446
"RTN","RGFIRM",1,0)
RGFIRM ;ALB/CJM-ROUTE FACILITY INTEGRATION MESSAGE ;08/27/99
"RTN","RGFIRM",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**5,9**;30 Apr 99
"RTN","RGFIRM",3,0)
 ;
"RTN","RGFIRM",4,0)
MROUTE ;
"RTN","RGFIRM",5,0)
 ;Description: routing logic for the Facility Integration Message. This
"RTN","RGFIRM",6,0)
 ;entry point is meant to be called by the HL7 pacakge when used in
"RTN","RGFIRM",7,0)
 ;the message routing logic of the client protocol.
"RTN","RGFIRM",8,0)
 ;
"RTN","RGFIRM",9,0)
 ;Input:
"RTN","RGFIRM",10,0)
 ;  HL7 variables must be defined
"RTN","RGFIRM",11,0)
 ;Output:
"RTN","RGFIRM",12,0)
 ;  HLL("LINKS") array containing the dynamic routing list
"RTN","RGFIRM",13,0)
 ;Variables:
"RTN","RGFIRM",14,0)
 ;  LEGACY - station # of legacy site
"RTN","RGFIRM",15,0)
 ;  PRIMARY - station # of primary site
"RTN","RGFIRM",16,0)
 ;  ICN - patient ICN from message
"RTN","RGFIRM",17,0)
 ;  DFN - ien from the patient file
"RTN","RGFIRM",18,0)
 ;
"RTN","RGFIRM",19,0)
 N LEGACY,PRIMARY,ICN,DFN
"RTN","RGFIRM",20,0)
 S (DFN,LEGACY,PRIMARY,ICN)=""
"RTN","RGFIRM",21,0)
 Q:'$$PARSE^RGFIPM1(1,.LEGACY,.PRIMARY,.ICN)
"RTN","RGFIRM",22,0)
 S DFN=$$DFN^RGFIU(ICN)
"RTN","RGFIRM",23,0)
 Q:'DFN
"RTN","RGFIRM",24,0)
 D ROUTE(DFN,LEGACY,PRIMARY,.HLL)
"RTN","RGFIRM",25,0)
 Q
"RTN","RGFIRM",26,0)
 ;
"RTN","RGFIRM",27,0)
ROUTE(DFN,LEGACY,PRIMARY,HLL) ;
"RTN","RGFIRM",28,0)
 ;Description: routing logic for the Facility Integration Message. This
"RTN","RGFIRM",29,0)
 ;entry point is designed to be called directly by the application.
"RTN","RGFIRM",30,0)
 ;
"RTN","RGFIRM",31,0)
 ;Input:
"RTN","RGFIRM",32,0)
 ;  DFN - ien from the patient file
"RTN","RGFIRM",33,0)
 ;  LEGACY - station # of legacy site
"RTN","RGFIRM",34,0)
 ;  PRIMARY - station # of primary site
"RTN","RGFIRM",35,0)
 ;Output:
"RTN","RGFIRM",36,0)
 ;  HLL("LINKS") array containing the dynamic routing list (pass HLL by reference)
"RTN","RGFIRM",37,0)
 ;Variables:
"RTN","RGFIRM",38,0)
 ;  SUB - ien of the subscriber list
"RTN","RGFIRM",39,0)
 ;  HERE - station # of site this routine is executing on
"RTN","RGFIRM",40,0)
 ;  HEREIEN - ien in Institution file of site this routine is executing on
"RTN","RGFIRM",41,0)
 ;  MPINODE - "MPI" node from the Patient file
"RTN","RGFIRM",42,0)
 ;  CMOR - station # of CMOR
"RTN","RGFIRM",43,0)
 ;  CMORIEN - ien in Institution file of CMOR
"RTN","RGFIRM",44,0)
 ;
"RTN","RGFIRM",45,0)
 K HLL("LINKS")
"RTN","RGFIRM",46,0)
 ;
"RTN","RGFIRM",47,0)
 I $G(LEGACY),$G(PRIMARY),$G(DFN) D
"RTN","RGFIRM",48,0)
 .;just checking
"RTN","RGFIRM",49,0)
 E  Q
"RTN","RGFIRM",50,0)
 ;
"RTN","RGFIRM",51,0)
 N SUB,HERE,HEREIEN,MPINODE,CMOR,CMORIEN
"RTN","RGFIRM",52,0)
 S (SUB,HERE,HEREIEN,MPINODE,CMOR,CMORIEN)=""
"RTN","RGFIRM",53,0)
 S HEREIEN=$$SITE^VASITE(),HERE=$P(HEREIEN,"^",3),HEREIEN=+HEREIEN
"RTN","RGFIRM",54,0)
 S MPINODE=$$MPINODE^RGFIU(DFN)
"RTN","RGFIRM",55,0)
 S CMORIEN=$P(MPINODE,"^",3)
"RTN","RGFIRM",56,0)
 S CMOR=$$STATNUM^RGFIU(CMORIEN)
"RTN","RGFIRM",57,0)
 ;
"RTN","RGFIRM",58,0)
 ;If the CMOR is not known, the message can not be routed
"RTN","RGFIRM",59,0)
 I 'CMORIEN D  Q
"RTN","RGFIRM",60,0)
 .D EXC^RGFIU(221,"ERROR ENCOUNTERED WHILE PROCESSING FACITLIY INTEGRATION MESSAGE: MISSING CMOR",DFN)
"RTN","RGFIRM",61,0)
 ;
"RTN","RGFIRM",62,0)
 S SUB=$P(MPINODE,"^",5)
"RTN","RGFIRM",63,0)
 I CMOR=HERE D
"RTN","RGFIRM",64,0)
 .;this is the CMOR, so send to subscribers (except legacy) and Austin MPI
"RTN","RGFIRM",65,0)
 .N MPILINK ;logical link of MPI
"RTN","RGFIRM",66,0)
 .S MPILINK=$$MPILINK^MPIFAPI()
"RTN","RGFIRM",67,0)
 .I $P(MPILINK,"^")=-1 D
"RTN","RGFIRM",68,0)
 ..D EXC^RGFIU(224,"Facility Integration Message not sent to MPI, no MPI link identified in CIRN SITE PARAMETER file (#991.8)",DFN)
"RTN","RGFIRM",69,0)
 .E  D
"RTN","RGFIRM",70,0)
 ..S HLL("LINKS",1)="RG FACILITY INTEGRATION CLIENT^"_MPILINK
"RTN","RGFIRM",71,0)
 .;
"RTN","RGFIRM",72,0)
 .;If this prmary site is not the CMOR, than make sure the prmary site
"RTN","RGFIRM",73,0)
 .;is on the subscription list
"RTN","RGFIRM",74,0)
 .;If this prmary site is not the CMOR, than make sure the prmary site
"RTN","RGFIRM",75,0)
 .;is on the subscription list
"RTN","RGFIRM",76,0)
 .I PRIMARY'=CMOR D
"RTN","RGFIRM",77,0)
 ..;PRIMIEN = ien of primary site in Institution file, LINK = its logical link
"RTN","RGFIRM",78,0)
 ..N PRIMIEN,LINK
"RTN","RGFIRM",79,0)
 ..S PRIMIEN=$$LKUP^XUAF4(PRIMARY)
"RTN","RGFIRM",80,0)
 ..Q:'PRIMIEN
"RTN","RGFIRM",81,0)
 ..;set HLL array to route message to primary site
"RTN","RGFIRM",82,0)
 ..S LINK=$$GETLINK^RGFIU(PRIMIEN)
"RTN","RGFIRM",83,0)
 ..I '$L(LINK) D
"RTN","RGFIRM",84,0)
 ...D EXC^RGFIU(224,"Facility Integration Message not sent to primary site, station # "_PRIMARY,DFN)
"RTN","RGFIRM",85,0)
 ..E  D
"RTN","RGFIRM",86,0)
 ...S HLL("LINKS",2)="RG FACILITY INTEGRATION CLIENT^"_LINK
"RTN","RGFIRM",87,0)
 .;
"RTN","RGFIRM",88,0)
 .D:SUB
"RTN","RGFIRM",89,0)
 ..;there is a subscription list, use it to route the message, with changes
"RTN","RGFIRM",90,0)
 ..;Variables:
"RTN","RGFIRM",91,0)
 ..;  ITEM - one of the sites (by subscript # on HLL("LINKS") array) on the subscriber list
"RTN","RGFIRM",92,0)
 ..;  LINK - logical link ien of subscriber
"RTN","RGFIRM",93,0)
 ..;  HERELINK - logical link of this site
"RTN","RGFIRM",94,0)
 ..;  LEGLINK - logical link of legacy site
"RTN","RGFIRM",95,0)
 ..;
"RTN","RGFIRM",96,0)
 ..N ITEM,NODE,LINK,HERELINK,LEGLINK
"RTN","RGFIRM",97,0)
 ..S HERELINK=$$GETLINK^RGFIU(HEREIEN)
"RTN","RGFIRM",98,0)
 ..S LEGLINK=$$GETLINK^RGFIU($$LKUP^XUAF4(LEGACY))
"RTN","RGFIRM",99,0)
 ..D GET^HLSUB(SUB,,"RG FACILITY INTEGRATION CLIENT",.HLL)
"RTN","RGFIRM",100,0)
 ..;screen out legacy and this (here) site
"RTN","RGFIRM",101,0)
 ..S ITEM=0 F  S ITEM=$O(HLL("LINKS",ITEM)) Q:'ITEM  S NODE=$G(HLL("LINKS",ITEM)),LINK=$P(NODE,"^",2) D:$L(LINK)
"RTN","RGFIRM",102,0)
 ...I HERELINK=LINK K HLL("LINKS",ITEM) Q
"RTN","RGFIRM",103,0)
 ...I LEGLINK=LINK K HLL("LINKS",ITEM) Q
"RTN","RGFIRM",104,0)
 E  D
"RTN","RGFIRM",105,0)
 .;send message to CMOR, but only if this is the legacy site
"RTN","RGFIRM",106,0)
 .N CMORLINK
"RTN","RGFIRM",107,0)
 .Q:(LEGACY'=HERE)
"RTN","RGFIRM",108,0)
 .S CMORLINK=$$GETLINK^RGFIU(CMORIEN)
"RTN","RGFIRM",109,0)
 .I '$L(CMORLINK) D
"RTN","RGFIRM",110,0)
 ..D EXC^RGFIU(224,"Facility Integration Message not sent to site "_CMOR,DFN)
"RTN","RGFIRM",111,0)
 .E  D
"RTN","RGFIRM",112,0)
 ..S HLL("LINKS",1)="RG FACILITY INTEGRATION CLIENT^"_CMORLINK
"RTN","RGFIRM",113,0)
 Q
"RTN","RGP9ENV")
0^5^B3837385
"RTN","RGP9ENV",1,0)
RGP9ENV ;B'HAM/PTD/CJM-RG*1*9 PATCH ENVIRONMENT CHECK ROUTINE ;06/17/99
"RTN","RGP9ENV",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**9**;30 Apr 99
"RTN","RGP9ENV",3,0)
 ;
"RTN","RGP9ENV",4,0)
 D
"RTN","RGP9ENV",5,0)
 .N ERROR
"RTN","RGP9ENV",6,0)
 .;Determine current version of CIRN installed.
"RTN","RGP9ENV",7,0)
 .S RGVER=$$VERSION^XPDUTL("RG")
"RTN","RGP9ENV",8,0)
 .;If version not 1.0, abort install.
"RTN","RGP9ENV",9,0)
 .I (RGVER'="1.0") W !!," Environment Check Failed: CLINICAL INFO RESOURCE NETWORK version 1.0 must be installed." S XPDQUIT=2 Q
"RTN","RGP9ENV",10,0)
 .;
"RTN","RGP9ENV",11,0)
 .;Check that Nashville and Murfreesboro can be found uniquely
"RTN","RGP9ENV",12,0)
 .;in the Institution file and logical link for Nashville can be found
"RTN","RGP9ENV",13,0)
 .I '$$CHECK(622,626,.ERROR) S XPDQUIT=2 W !!," Environment Check Failed: "_ERROR
"RTN","RGP9ENV",14,0)
 I '$D(XPDQUIT) W !!,"Environment check is ok.",!
"RTN","RGP9ENV",15,0)
 K RGVER
"RTN","RGP9ENV",16,0)
 Q
"RTN","RGP9ENV",17,0)
 ;
"RTN","RGP9ENV",18,0)
CHECK(LEGACY,PRIMARY,ERROR) ;
"RTN","RGP9ENV",19,0)
 ;Checks that iens for the legacy and primary site can be found.
"RTN","RGP9ENV",20,0)
 ;Input:
"RTN","RGP9ENV",21,0)
 ;  LEGACY - station # of legacy site
"RTN","RGP9ENV",22,0)
 ;  PRIMARY - station # of primary site
"RTN","RGP9ENV",23,0)
 ;Output:
"RTN","RGP9ENV",24,0)
 ;  Function Value:  1 if ok, 0 if checks fail
"RTN","RGP9ENV",25,0)
 ;  ERROR - error message on failure (optional, pass by reference)
"RTN","RGP9ENV",26,0)
 ;
"RTN","RGP9ENV",27,0)
 N PRIMPTR
"RTN","RGP9ENV",28,0)
 I '$$LKUP^XUAF4($G(LEGACY)) S ERROR="LEGACY STATION NUMBER NOT FOUND UNIQUELY IN THE INSTITUTION FILE!" Q 0
"RTN","RGP9ENV",29,0)
 S PRIMPTR=$$LKUP^XUAF4($G(PRIMARY))
"RTN","RGP9ENV",30,0)
 I 'PRIMPTR S ERROR="PRIMARY STATION NUMBER NOT FOUND UNIQUELY IN THE INSTITUTION FILE!" Q 0
"RTN","RGP9ENV",31,0)
 I '$L($$GETLINK^RGFIU(PRIMPTR)) S ERROR="LOOKUP OF LOGICAL LINK FOR THE PRIMARY SITE FAILED!" Q 0
"RTN","RGP9ENV",32,0)
 Q 1
"RTN","RGP9PST")
0^6^B1160137
"RTN","RGP9PST",1,0)
RGP9PST ;ALB/CJM-RG*1*9 PATCH POST INSTALL ROUTINE ;06/17/99
"RTN","RGP9PST",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**9**;30 Apr 99
"RTN","RGP9PST",3,0)
 ;
"RTN","RGP9PST",4,0)
 ;First change the action on exceptions 1,6,7
"RTN","RGP9PST",5,0)
 D ACTION
"RTN","RGP9PST",6,0)
 ;
"RTN","RGP9PST",7,0)
 ;
"RTN","RGP9PST",8,0)
 ;Future integrations need only change the station numbers
"RTN","RGP9PST",9,0)
 ;Parameter #1:  station number of the legacy site
"RTN","RGP9PST",10,0)
 ;Parameter #2:  station number of the primary site
"RTN","RGP9PST",11,0)
 N ERROR
"RTN","RGP9PST",12,0)
 I '$$CLEAN^RGFICLN(622,626,0,.ERROR) D
"RTN","RGP9PST",13,0)
 .D BMES^XPDUTL("Post-Install Routine Failed: "_$G(ERROR))
"RTN","RGP9PST",14,0)
 E  D
"RTN","RGP9PST",15,0)
 .D BMES^XPDUTL("Post-Install Routine Completed Successfully")
"RTN","RGP9PST",16,0)
 Q
"RTN","RGP9PST",17,0)
 ;
"RTN","RGP9PST",18,0)
ACTION ;Change action for exceptions 1,6,7
"RTN","RGP9PST",19,0)
 N EXCEPT
"RTN","RGP9PST",20,0)
 F EXCEPT=1,6,7 D
"RTN","RGP9PST",21,0)
 .N DIE,DIC,DR,DA,Y,D0
"RTN","RGP9PST",22,0)
 .S DIC="^RGHL7(991.11,",DIC(0)="XQZ",X=EXCEPT
"RTN","RGP9PST",23,0)
 .D ^DIC
"RTN","RGP9PST",24,0)
 .Q:+Y<0
"RTN","RGP9PST",25,0)
 .L +^RGHL7(991.11,EXCEPT):10
"RTN","RGP9PST",26,0)
 .S DA=+Y,DIE="^RGHL7(991.11,",DR="2///MAIL"
"RTN","RGP9PST",27,0)
 .D ^DIE
"RTN","RGP9PST",28,0)
 .L -^RGHL7(991.11,EXCEPT)
"RTN","RGP9PST",29,0)
 K DA,DIC,DIE,DR,EXCEPT,X,Y
"RTN","RGP9PST",30,0)
 Q
"VER")
8.0^22.0
**END**
**END**
