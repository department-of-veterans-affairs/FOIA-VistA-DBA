Released DG*5.3*593 SEQ #528
Extracted from mail message
**KIDS**:DG*5.3*593^

**INSTALL NAME**
DG*5.3*593
"BLD",5505,0)
DG*5.3*593^REGISTRATION^0^3040624^y
"BLD",5505,1,0)
^^1^1^3040412^
"BLD",5505,1,1,0)
Patient File cleanup and $(G) to DGPMVDD
"BLD",5505,4,0)
^9.64PA^^
"BLD",5505,"KRN",0)
^9.67PA^8989.52^19
"BLD",5505,"KRN",.4,0)
.4
"BLD",5505,"KRN",.401,0)
.401
"BLD",5505,"KRN",.402,0)
.402
"BLD",5505,"KRN",.403,0)
.403
"BLD",5505,"KRN",.5,0)
.5
"BLD",5505,"KRN",.84,0)
.84
"BLD",5505,"KRN",3.6,0)
3.6
"BLD",5505,"KRN",3.8,0)
3.8
"BLD",5505,"KRN",9.2,0)
9.2
"BLD",5505,"KRN",9.8,0)
9.8
"BLD",5505,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5505,"KRN",9.8,"NM",1,0)
DGPMVDD^^0^B18480590
"BLD",5505,"KRN",9.8,"NM",2,0)
DG53P593^^0^B33984220
"BLD",5505,"KRN",9.8,"NM","B","DG53P593",2)

"BLD",5505,"KRN",9.8,"NM","B","DGPMVDD",1)

"BLD",5505,"KRN",19,0)
19
"BLD",5505,"KRN",19.1,0)
19.1
"BLD",5505,"KRN",101,0)
101
"BLD",5505,"KRN",409.61,0)
409.61
"BLD",5505,"KRN",771,0)
771
"BLD",5505,"KRN",870,0)
870
"BLD",5505,"KRN",8989.51,0)
8989.51
"BLD",5505,"KRN",8989.52,0)
8989.52
"BLD",5505,"KRN",8994,0)
8994
"BLD",5505,"KRN","B",.4,.4)

"BLD",5505,"KRN","B",.401,.401)

"BLD",5505,"KRN","B",.402,.402)

"BLD",5505,"KRN","B",.403,.403)

"BLD",5505,"KRN","B",.5,.5)

"BLD",5505,"KRN","B",.84,.84)

"BLD",5505,"KRN","B",3.6,3.6)

"BLD",5505,"KRN","B",3.8,3.8)

"BLD",5505,"KRN","B",9.2,9.2)

"BLD",5505,"KRN","B",9.8,9.8)

"BLD",5505,"KRN","B",19,19)

"BLD",5505,"KRN","B",19.1,19.1)

"BLD",5505,"KRN","B",101,101)

"BLD",5505,"KRN","B",409.61,409.61)

"BLD",5505,"KRN","B",771,771)

"BLD",5505,"KRN","B",870,870)

"BLD",5505,"KRN","B",8989.51,8989.51)

"BLD",5505,"KRN","B",8989.52,8989.52)

"BLD",5505,"KRN","B",8994,8994)

"BLD",5505,"PRE")

"BLD",5505,"QUES",0)
^9.62^^
"BLD",5505,"REQB",0)
^9.611^3^3
"BLD",5505,"REQB",1,0)
DG*5.3*222^1
"BLD",5505,"REQB",2,0)
DG*5.3*578^1
"BLD",5505,"REQB",3,0)
DG*5.3*418^1
"BLD",5505,"REQB","B","DG*5.3*222",1)

"BLD",5505,"REQB","B","DG*5.3*418",3)

"BLD",5505,"REQB","B","DG*5.3*578",2)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
593^3040624^100850
"PKG",5,22,1,"PAH",1,1,0)
^^1^1^3040624
"PKG",5,22,1,"PAH",1,1,1,0)
Patient File cleanup and $(G) to DGPMVDD
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","DG53P593")
0^2^B33984220
"RTN","DG53P593",1,0)
DG53P593 ;BAY/JAT - Patient File Cleanup; 2/22/1999 ; 6/24/04 3:43pm
"RTN","DG53P593",2,0)
 ;;5.3;Registration;**593**;Aug 13,1993
"RTN","DG53P593",3,0)
 Q
"RTN","DG53P593",4,0)
 ;
"RTN","DG53P593",5,0)
CLEANUP ;This entry point will do the cleanup.
"RTN","DG53P593",6,0)
 ;
"RTN","DG53P593",7,0)
 N DGENSKIP
"RTN","DG53P593",8,0)
 S DGENSKIP=0
"RTN","DG53P593",9,0)
 W !,"This is a one-time cleanup of the Patient File."
"RTN","DG53P593",10,0)
 W !,"Certain records which were created in error will be deleted."
"RTN","DG53P593",11,0)
 N X1,X2
"RTN","DG53P593",12,0)
 K ^XTMP("DG53P593",$J)
"RTN","DG53P593",13,0)
 S X1=DT,X2=90 D C^%DTC
"RTN","DG53P593",14,0)
 S ^XTMP("DG53P593",$J,0)=X_"^"_DT_"^Patient File cleanup"
"RTN","DG53P593",15,0)
 I $$DEVICE() D ENTER
"RTN","DG53P593",16,0)
 Q
"RTN","DG53P593",17,0)
 ;
"RTN","DG53P593",18,0)
REPORT ;This entry point was provided for testing, so that before
"RTN","DG53P593",19,0)
 ;patient records are deleted the site can have a list of
"RTN","DG53P593",20,0)
 ;the DFN's that would be deleted.
"RTN","DG53P593",21,0)
 ; 
"RTN","DG53P593",22,0)
 ;Use this entry point to report on what the cleanup would do.
"RTN","DG53P593",23,0)
 ;No changes will be made to the database.
"RTN","DG53P593",24,0)
 ;
"RTN","DG53P593",25,0)
 N DGENSKIP
"RTN","DG53P593",26,0)
 S DGENSKIP=1
"RTN","DG53P593",27,0)
 W !,"This is a preliminary report by DFN of the Patient file"
"RTN","DG53P593",28,0)
 W !,"records which would be deleted by the cleanup."
"RTN","DG53P593",29,0)
 N X1,X2
"RTN","DG53P593",30,0)
 K ^XTMP("DG53P593",$J)
"RTN","DG53P593",31,0)
 S X1=DT,X2=90 D C^%DTC
"RTN","DG53P593",32,0)
 S ^XTMP("DG53P593",$J,0)=X_"^"_DT_"^Patient File cleanup"
"RTN","DG53P593",33,0)
 I $$DEVICE() D ENTER
"RTN","DG53P593",34,0)
 Q
"RTN","DG53P593",35,0)
 ;
"RTN","DG53P593",36,0)
ENTER ;
"RTN","DG53P593",37,0)
 ;
"RTN","DG53P593",38,0)
 D DELETE(DGENSKIP)
"RTN","DG53P593",39,0)
 D:(DGENSKIP) ^%ZISC
"RTN","DG53P593",40,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","DG53P593",41,0)
 Q
"RTN","DG53P593",42,0)
DEVICE() ;
"RTN","DG53P593",43,0)
 ;Description: allows the user to select a device.
"RTN","DG53P593",44,0)
 ;
"RTN","DG53P593",45,0)
 ;Output:
"RTN","DG53P593",46,0)
 ;  Function Value - Returns 0 if the user decides not to print or to
"RTN","DG53P593",47,0)
 ;       queue the report, 1 otherwise.
"RTN","DG53P593",48,0)
 ;
"RTN","DG53P593",49,0)
 N OK,IOP,POP,%ZIS
"RTN","DG53P593",50,0)
 S OK=1
"RTN","DG53P593",51,0)
 S %ZIS="MQ"
"RTN","DG53P593",52,0)
 D ^%ZIS
"RTN","DG53P593",53,0)
 S:POP OK=0
"RTN","DG53P593",54,0)
 D:OK&$D(IO("Q"))
"RTN","DG53P593",55,0)
 .N ZTRTN,ZTDESC,ZTSKM,ZTREQ,ZTSTOP
"RTN","DG53P593",56,0)
 .S ZTRTN="ENTER^DG53P593",ZTDESC=$S(DGENSKIP:"Report",1:"Cleanup")_" of Incomplete Patient Records"
"RTN","DG53P593",57,0)
 .S ZTSAVE("DGENSKIP")=""
"RTN","DG53P593",58,0)
 .D ^%ZTLOAD
"RTN","DG53P593",59,0)
 .W !,$S($D(ZTSK):"REQUEST QUEUED TASK="_ZTSK,1:"REQUEST CANCELLED")
"RTN","DG53P593",60,0)
 .D HOME^%ZIS
"RTN","DG53P593",61,0)
 .S OK=0
"RTN","DG53P593",62,0)
 Q OK
"RTN","DG53P593",63,0)
 ;
"RTN","DG53P593",64,0)
DELETE(DGENSKIP) ;
"RTN","DG53P593",65,0)
 ;This will delete bogus patient records --
"RTN","DG53P593",66,0)
 ;
"RTN","DG53P593",67,0)
 ;Input: If DGENSKIP=1, the records will not be deleted, 
"RTN","DG53P593",68,0)
 ;just reported.
"RTN","DG53P593",69,0)
 ;
"RTN","DG53P593",70,0)
 N DFN,SUB,GOOD,COUNT,DGNAME,DGDEL,DGSORT,DGVAL,DGFDA,DGERR
"RTN","DG53P593",71,0)
 S (COUNT,DFN)=0
"RTN","DG53P593",72,0)
 F  S DFN=$O(^DPT(DFN)) Q:'DFN  D
"RTN","DG53P593",73,0)
 .; merged record
"RTN","DG53P593",74,0)
 .I $D(^DPT(DFN,-9)) Q
"RTN","DG53P593",75,0)
 .; in process of being merged
"RTN","DG53P593",76,0)
 .I $P($G(^DPT(DFN,0)),U)["MERGING INTO" Q
"RTN","DG53P593",77,0)
 .; usual good patient record
"RTN","DG53P593",78,0)
 .I $D(^DPT(DFN,0)) S DGNAME=$P($G(^DPT(DFN,0)),U) I DGNAME'="",$D(^DPT("B",DGNAME,DFN)) Q
"RTN","DG53P593",79,0)
 .; evaluate if record related to DG*5.3*578 
"RTN","DG53P593",80,0)
 .D EVAL578
"RTN","DG53P593",81,0)
 .; evaluate if record related to DG*5.3*222
"RTN","DG53P593",82,0)
 .S GOOD=0
"RTN","DG53P593",83,0)
 .S SUB=""
"RTN","DG53P593",84,0)
 .F  S SUB=$O(^DPT(DFN,SUB)) Q:SUB=""  D
"RTN","DG53P593",85,0)
 ..I (SUB'=.3),(SUB'=.38),(SUB'=.52) S GOOD=1 Q
"RTN","DG53P593",86,0)
 .I 'GOOD D DIKDEL Q
"RTN","DG53P593",87,0)
 .I DGDEL D DIKDEL
"RTN","DG53P593",88,0)
 ;
"RTN","DG53P593",89,0)
 D PRINT
"RTN","DG53P593",90,0)
 Q
"RTN","DG53P593",91,0)
 ;
"RTN","DG53P593",92,0)
EVAL578 ;
"RTN","DG53P593",93,0)
 S DGDEL=0
"RTN","DG53P593",94,0)
 N DGCNT,DGNODE,DGSSN,DGNEWIEN,DGMPI
"RTN","DG53P593",95,0)
 I '$D(^DPT(DFN,0)) Q
"RTN","DG53P593",96,0)
 S DGNODE=""
"RTN","DG53P593",97,0)
 S DGCNT=0
"RTN","DG53P593",98,0)
 F  S DGNODE=$O(^DPT(DFN,DGNODE)) Q:DGNODE=""  S DGCNT=DGCNT+1
"RTN","DG53P593",99,0)
 ; there must be minimal data, so skip if too many nodes
"RTN","DG53P593",100,0)
 Q:DGCNT>7
"RTN","DG53P593",101,0)
 I DGNAME="" S DGDEL=DGDEL+1
"RTN","DG53P593",102,0)
 I DGNAME'="",'$D(^DPT("B",DGNAME,DFN)) S DGDEL=DGDEL+1
"RTN","DG53P593",103,0)
 S DGSSN=$P($G(^DPT(DFN,0)),U,9)
"RTN","DG53P593",104,0)
 I DGSSN="" S DGDEL=DGDEL+1
"RTN","DG53P593",105,0)
 I DGSSN'="",'$D(^DPT("SSN",DGSSN,DFN)) S DGDEL=DGDEL+1 D
"RTN","DG53P593",106,0)
 .S DGNEWIEN=0
"RTN","DG53P593",107,0)
 .F  S DGNEWIEN=$O(^DPT("SSN",DGSSN,DGNEWIEN)) Q:'DGNEWIEN  I DGNEWIEN S DGDEL=DGDEL+1
"RTN","DG53P593",108,0)
 S DGMPI=$E($P($G(^DPT(DFN,"MPI")),U),1,3)
"RTN","DG53P593",109,0)
 I DGMPI="" S DGDEL=DGDEL+1
"RTN","DG53P593",110,0)
 ; checking if only local ICN
"RTN","DG53P593",111,0)
 I DGMPI=+$$SITE^VASITE() S DGDEL=DGDEL+1
"RTN","DG53P593",112,0)
 I DGDEL>1 Q
"RTN","DG53P593",113,0)
 S DGDEL=0
"RTN","DG53P593",114,0)
 Q
"RTN","DG53P593",115,0)
 ;
"RTN","DG53P593",116,0)
DIKDEL ;
"RTN","DG53P593",117,0)
 S COUNT=COUNT+1
"RTN","DG53P593",118,0)
 S DGSORT=$S('GOOD:2,1:1)
"RTN","DG53P593",119,0)
 S ^XTMP("DG53P593",$J,DGSORT,DFN)=$S(DGSORT=1:"Related to DG*5.3*578",1:"Related to DG*5.3*222")
"RTN","DG53P593",120,0)
 I 'DGENSKIP D
"RTN","DG53P593",121,0)
 .D DELEXE
"RTN","DG53P593",122,0)
 .I '$D(^DPT(DFN,0)) D  Q
"RTN","DG53P593",123,0)
 ..S DA=DFN,DIK="^DPT(" D ^DIK K DA,DIK
"RTN","DG53P593",124,0)
 .I $P($G(^DPT(DFN,0)),U)="" K ^DPT(DFN) Q
"RTN","DG53P593",125,0)
 .S DGVAL="@"
"RTN","DG53P593",126,0)
 .S DGFDA(2,DFN_",",.01)=DGVAL
"RTN","DG53P593",127,0)
 .D FILE^DIE("","DGFDA","DGERR")
"RTN","DG53P593",128,0)
 Q
"RTN","DG53P593",129,0)
 ;
"RTN","DG53P593",130,0)
DELEXE ; Delete exceptions on file for patient record being removed.
"RTN","DG53P593",131,0)
 S EXCT=""
"RTN","DG53P593",132,0)
 F  S EXCT=$O(^RGHL7(991.1,"ADFN",EXCT)) Q:EXCT=""  D
"RTN","DG53P593",133,0)
 . I $D(^RGHL7(991.1,"ADFN",EXCT,DFN)) D
"RTN","DG53P593",134,0)
 .. S IEN=0
"RTN","DG53P593",135,0)
 .. F  S IEN=$O(^RGHL7(991.1,"ADFN",EXCT,DFN,IEN)) Q:'IEN  D
"RTN","DG53P593",136,0)
 ... S IEN2=0
"RTN","DG53P593",137,0)
 ... F  S IEN2=$O(^RGHL7(991.1,"ADFN",EXCT,DFN,IEN,IEN2)) Q:'IEN2  D
"RTN","DG53P593",138,0)
  .... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","DG53P593",139,0)
  .... I NUM=1 D
"RTN","DG53P593",140,0)
  ..... L +^RGHL7(991.1,IEN):10
"RTN","DG53P593",141,0)
  ..... S DIK="^RGHL7(991.1,",DA=IEN
"RTN","DG53P593",142,0)
  ..... D ^DIK K DIK,DA
"RTN","DG53P593",143,0)
  ..... L -^RGHL7(991.1,IEN)
"RTN","DG53P593",144,0)
  .... E  I NUM>1 D DELE
"RTN","DG53P593",145,0)
 K EXCT,IEN,IEN2,NUM
"RTN","DG53P593",146,0)
 Q
"RTN","DG53P593",147,0)
DELE ; delete exception
"RTN","DG53P593",148,0)
 L +^RGHL7(991.1,IEN):10
"RTN","DG53P593",149,0)
 S DA(1)=IEN,DA=IEN2
"RTN","DG53P593",150,0)
 S DIK="^RGHL7(991.1,"_DA(1)_",1,"
"RTN","DG53P593",151,0)
 D ^DIK K DIK,DA
"RTN","DG53P593",152,0)
 L -^RGHL7(991.1,IEN)
"RTN","DG53P593",153,0)
 Q
"RTN","DG53P593",154,0)
PRINT ;
"RTN","DG53P593",155,0)
 U IO
"RTN","DG53P593",156,0)
 N DGDDT,DGQUIT,DGPG
"RTN","DG53P593",157,0)
 S DGDDT=$$FMTE^XLFDT($$NOW^XLFDT,"D")
"RTN","DG53P593",158,0)
 S (DGQUIT,DGPG)=0
"RTN","DG53P593",159,0)
 D HEAD
"RTN","DG53P593",160,0)
 I '$G(COUNT) D  Q
"RTN","DG53P593",161,0)
 .W !!!,?20,"*** No records to report ***"
"RTN","DG53P593",162,0)
 W !!,"*** COUNT OF BAD PATIENT RECORDS"_$S(DGENSKIP:"",1:" DELETED")_": ",COUNT," ***",!!
"RTN","DG53P593",163,0)
 S DGSORT=0
"RTN","DG53P593",164,0)
 F  S DGSORT=$O(^XTMP("DG53P593",$J,DGSORT)) Q:'DGSORT  D  Q:DGQUIT
"RTN","DG53P593",165,0)
 .S DFN=0
"RTN","DG53P593",166,0)
 .F  S DFN=$O(^XTMP("DG53P593",$J,DGSORT,DFN)) Q:'DFN  D  Q:DGQUIT
"RTN","DG53P593",167,0)
 ..I $Y>(IOSL-4) D HEAD
"RTN","DG53P593",168,0)
 ..W ?2,DFN,?15,$G(^XTMP("DG53P593",$J,DGSORT,DFN)),!
"RTN","DG53P593",169,0)
 ;
"RTN","DG53P593",170,0)
 I DGQUIT W:$D(ZTQUEUED) !!,"Report stopped at user's request" Q
"RTN","DG53P593",171,0)
 I $G(DGPG)>0,$E(IOST)="C" K DIR S DIR(0)="E" D ^DIR K DIR S:+Y=0 DGQUIT=1
"RTN","DG53P593",172,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","DG53P593",173,0)
 Q
"RTN","DG53P593",174,0)
 ;
"RTN","DG53P593",175,0)
HEAD ;
"RTN","DG53P593",176,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S (ZTSTOP,DGQUIT)=1 Q
"RTN","DG53P593",177,0)
 I $G(DGPG)>0,$E(IOST)="C" K DIR S DIR(0)="E" D ^DIR K DIR S:+Y=0 DGQUIT=1
"RTN","DG53P593",178,0)
 Q:DGQUIT
"RTN","DG53P593",179,0)
 S DGPG=$G(DGPG)+1
"RTN","DG53P593",180,0)
 W @IOF,!,DGDDT,?15,"DG*5.3*593 Patient File Cleanup Utility",?70,"Page:",$J(DGPG,5),! K X S $P(X,"-",81)="" W X,!
"RTN","DG53P593",181,0)
 W !,?2,"DFN",?15,"Reason for Deletion",!
"RTN","DG53P593",182,0)
 S $P(X,"-",81)="" W X,!
"RTN","DG53P593",183,0)
 Q
"RTN","DGPMVDD")
0^1^B18480590
"RTN","DGPMVDD",1,0)
DGPMVDD ;ALB/MIR - MISCELLANEOUS DD CALLS FROM FILE 405 AND 405.1 ; 4/14/04 6:26pm
"RTN","DGPMVDD",2,0)
 ;;5.3;Registration;**418,593**;Aug 13, 1993
"RTN","DGPMVDD",3,0)
W ;called from input transform for ward location
"RTN","DGPMVDD",4,0)
 I '$D(DGPMT) K X,DIC Q
"RTN","DGPMVDD",5,0)
 S DGPMTYP=$P(^DGPM(DA,0),"^",18),DGPMWD=$P(DGPMP,"^",6) D W1:DGPMT=1,W2:DGPMT=2!($P(^DGPM(DA,0),"^",2)=2) Q
"RTN","DGPMVDD",6,0)
W1 ;consistency edits for ward location from admit option
"RTN","DGPMVDD",7,0)
 I $D(DGPMSVC) S DIC("S")=DIC("S")_","_$S(DGPMSVC="H":"""^NH^D^""'[(""^""_$P(^(0),""^"",3)_""^"")",1:"$P(^(0),""^"",3)=DGPMSVC") Q
"RTN","DGPMVDD",8,0)
 S DGX=$P(DGPMP,"^",17) I DGX,(DGPMTYP=40),$S('$D(^DGPM(+DGX,0)):0,+^(0):1,1:0) S DIC("S")="I +Y=DGPMWD" Q
"RTN","DGPMVDD",9,0)
 ;S DGX="" I DGPMTYP=18 S DIC("S")=DIC("S")_",""^NH^D^""[(""^""_$P(^(0),""^"",3)_""^"")" Q
"RTN","DGPMVDD",10,0)
 S DGX="" I DGPMTYP=18 S DIC("S")=DIC("S")_",""^NH^D^""[(""^""_$P(^(0),""^"",3)_""^"")!($P(^(0),""^"",17)=1)" ;p-418
"RTN","DGPMVDD",11,0)
 ;I (DGPMWD&$S($P(DGPM2,"^",2)=2:1,1:0))!(DGPMTYP=40) S DGX=$S($D(^DIC(42,+DGPMWD,0)):$P(^(0),"^",3),1:""),DGX=$S("^NH^D^"'[("^"_DGX_"^"):"H",1:DGX)
"RTN","DGPMVDD",12,0)
 ;S DGPMWD="",DGPMTYP=40  ; simulate NOIS REN-0304-60611
"RTN","DGPMVDD",13,0)
 I (DGPMWD&$S($P(DGPM2,"^",2)=2:1,1:0))!(DGPMTYP=40) S DGX=$S($D(^DIC(42,+DGPMWD,0)):$P($G(^DIC(42,+DGPMWD,0)),U,3),1:""),DGX=$S("^NH^D^"'[("^"_DGX_"^")&($P($G(^DIC(42,+DGPMWD,0)),U,17)'=1):"H",1:DGX) ;p-418/593
"RTN","DGPMVDD",14,0)
 ;I DGX]"" S DIC("S")=DIC("S")_",("_$S(DGX="NH":"""^NH^:""[",DGX="D":"""^D^""[",1:"""^NH^D^""'[")_"(""^""_$P(^(0),""^"",3)_""^""))"
"RTN","DGPMVDD",15,0)
ZZ I DGX]"" S DIC("S")=DIC("S")_",("_$S(DGX="NH":"""^NH^:""[",DGX="D":"""^D^""[",1:"""^NH^D^""'[")_"(""^""_$P(^(0),""^"",3)_""^"")&($P(^(0),""^"",17)'=1))" ;p-418
"RTN","DGPMVDD",16,0)
 I $P(DGPM2,"^",2)=2&$P(DGPM2,"^",6),'DGPMABL S DIC("S")=DIC("S")_",+Y'=$P(DGPM2,""^"",6)"
"RTN","DGPMVDD",17,0)
 Q
"RTN","DGPMVDD",18,0)
W2 ;Ward consistency check for transfer.  interward transfers not to same ward.  unless ASIH mvt, can't go from hospital to NHCU/DOM, vice versa
"RTN","DGPMVDD",19,0)
 ;I "^13^44^"[("^"_DGPMTYP_"^") S DIC("S")=DIC("S")_",""^NH^D^""'[(""^""_$P(^(0),""^"",3)_""^"")" Q
"RTN","DGPMVDD",20,0)
 I "^13^44^"[("^"_DGPMTYP_"^") S DIC("S")=DIC("S")_",""^NH^D^""'[(""^""_$P(^(0),""^"",3)_""^"")&($P(^(0),U,17)'=1)" Q  ;added p-418
"RTN","DGPMVDD",21,0)
 S DGX=$S($D(^DGPM(+$P(^DGPM(DA,0),"^",14),0)):$P(^(0),"^",6),1:0),DGX=$S($D(^DIC(42,+DGX,0)):$P(^(0),"^",3),1:"")
"RTN","DGPMVDD",22,0)
 N DGRAI S DGRAI=$S(DGX="":"",1:$P(^(0),"^",17)) ;added p-418
"RTN","DGPMVDD",23,0)
 ;I "^14^43^45^"[("^"_DGPMTYP_"^") S DIC("S")=DIC("S")_",DGX=$P(^(0),""^"",3)" Q
"RTN","DGPMVDD",24,0)
 I "^14^43^45^"[("^"_DGPMTYP_"^") D  Q  ;added p-418
"RTN","DGPMVDD",25,0)
 .I DGX="D" S DIC("S")=DIC("S")_",($P(^(0),""^"",3)="""_DGX_""")"
"RTN","DGPMVDD",26,0)
 .I DGX="NH"!(DGX="I"&(DGRAI=1)) S DIC("S")=DIC("S")_",""^NH^""[(""^""_$P(^(0),""^"",3)_""^"")!(""^I^""[(""^""_$P(^(0),""^"",3)_""^"")&($P(^(0),""^"",17)=1))" ;added p-418
"RTN","DGPMVDD",27,0)
 S DGX=$S($D(^DIC(42,+$P(DGPM0,"^",6),0)):$P(^(0),"^",3),1:"")
"RTN","DGPMVDD",28,0)
 S DGRAI=$S(DGX="":"",1:$P(^(0),"^",17)) ;added p-418
"RTN","DGPMVDD",29,0)
 ;I DGX="D"!(DGX="NH") S DIC("S")=DIC("S")_",($P(^(0),""^"",3)="""_DGX_""")"
"RTN","DGPMVDD",30,0)
 I DGX="D"!(DGX="NH")!(DGX="I"&(DGRAI=1)) D
"RTN","DGPMVDD",31,0)
 .I DGX="D" S DIC("S")=DIC("S")_",($P(^(0),""^"",3)="""_DGX_""")"
"RTN","DGPMVDD",32,0)
 .I DGX="NH"!(DGX="I"&(DGRAI=1)) S DIC("S")=DIC("S")_",""^NH^""[(""^""_$P(^(0),""^"",3)_""^"")!(""^I^""[(""^""_$P(^(0),""^"",3)_""^"")&($P(^(0),""^"",17)=1))" ;added p-418
"RTN","DGPMVDD",33,0)
 ;I DGX'="D"&(DGX'="NH") S DIC("S")=DIC("S")_",""^NH^D^""'[(""^""_$P(^(0),""^"",3)_""^"")"
"RTN","DGPMVDD",34,0)
 I DGX'="D"&(DGX'="NH")&(DGX'="I"!(DGRAI'=1)) D
"RTN","DGPMVDD",35,0)
 .S DIC("S")=DIC("S")_",""^NH^D^""'[(""^""_$P(^(0),""^"",3)_""^"")&((""^I^""'[(""^""_$P(^(0),""^"",3)_""^"")!($P(^(0),""^"",17)'=1)))" ;added p-418
"RTN","DGPMVDD",36,0)
 I $D(^DG(405.2,+DGPMTYP,"E")),'^("E") S DGX=$S(DGPMABL:0,1:$P(DGPM2,"^",6)),DIC("S")=DIC("S")_",+Y'=DGX,+Y'=$P(DGPM0,""^"",6)"
"RTN","DGPMVDD",37,0)
 Q
"RTN","DGPMVDD",38,0)
WARD ;is ward active at time of movement?
"RTN","DGPMVDD",39,0)
 S DGPMOS=+^DGPM(DA,0) N D0,X S D0=+Y D WIN^DGPMDDCF I X W !,"Ward inactive at time of movement" S DGOOS=1 Q
"RTN","DGPMVDD",40,0)
 Q
"RTN","DGPMVDD",41,0)
ROOM ;is room-bed active at time of movement? - called from input transform of .07 in 405
"RTN","DGPMVDD",42,0)
 S DGPMOS=$S('$D(DGSWITCH):+^DGPM(DA,0),1:DT) N D0,X S D0=+Y D RIN^DGPMDDCF I X W !,"Room-bed inactive at time of movement" S DGOOS=1 Q
"RTN","DGPMVDD",43,0)
 Q
"RTN","DGPMVDD",44,0)
 ;
"RTN","DGPMVDD",45,0)
TROC ;is bed occupied when transferring from 1 or 23 movement?
"RTN","DGPMVDD",46,0)
 ;called from DGPM TRANSFER edit template
"RTN","DGPMVDD",47,0)
 ;output variables DGPMOC &/or DGOOS
"RTN","DGPMVDD",48,0)
 ;DGPMOC = 2 if occupied & no more beds on ward, 1 if occupied, 0 if unoccupied
"RTN","DGPMVDD",49,0)
 ;DGOOS = 1 if inactive (out-of-service), otherwise = 0
"RTN","DGPMVDD",50,0)
 S (DGPMOC,DGOOS)=0,DGZ7=$P(DGPM0,"^",7),DGZ6=+$P(DGPM0,"^",6)
"RTN","DGPMVDD",51,0)
 F DGPMX=0:0 S DGPMX=$O(^DGPM("ARM",+DGZ7,DGPMX)) Q:DGPMX'>0  I $D(^DGPM(DGPMX,0)),$P(DGPM0,"^",3)'=$P(^DGPM(DGPMX,0),"^",3) S DGPMOC=1
"RTN","DGPMVDD",52,0)
 ;I 'DGPMOC,$S('$D(^DGPM(+DGPMX,0)):0,'$D(^DG(405.4,DGZ7,"W","B",+$P(DGPM0,"^",6))):1,1:0) S DGPMOC=1
"RTN","DGPMVDD",53,0)
 ;I DGPMOC S DGOCC=0 D TROCWB I DGOCC=DGB S DGPMOC=2
"RTN","DGPMVDD",54,0)
 I 'DGPMOC S DGPMOS=+DGPM0 N D0,X S D0=+DGZ7 D RIN^DGPMDDCF S:X DGOOS=1
"RTN","DGPMVDD",55,0)
 K DGB,DGOCC,DGPMX,DGPMOS,I Q
"RTN","DGPMVDD",56,0)
 Q
"RTN","DGPMVDD",57,0)
TROCWB ;check if ward still has available beds
"RTN","DGPMVDD",58,0)
 S I=0 F DGB=0:1 S I=$O(^DG(405.4,"W",DGZ6,I)) Q:I'>0  I $D(^DGPM("ARM",I)) S DGOCC=DGOCC+1
"RTN","DGPMVDD",59,0)
 ;
"RTN","DGPMVDD",60,0)
ABSRET ;check absence return date for consistency with movement type
"RTN","DGPMVDD",61,0)
 S DGPMX=^DGPM(DA,0),DGPMTYP=$P(DGPMX,"^",18),DGPMRD=X
"RTN","DGPMVDD",62,0)
 I DGPMTYP=1 S X1=$P(+DGPMX,".",1),X2=4 D C^%DTC I DGPMRD>X K X W !,"Must be within 4 days"
"RTN","DGPMVDD",63,0)
 I DGPMTYP=2 S X1=$P(+DGPMX,".",1),X2=5 D C^%DTC I DGPMRD<X K X W !,"Must be more than 4 days"
"RTN","DGPMVDD",64,0)
 I $D(X) S X1=$P(+DGPMX,".",1),X2=30 D C^%DTC I DGPMRD>X K X W !,"Must be within 30 days of transfer"
"RTN","DGPMVDD",65,0)
 S:$D(X) X=DGPMRD K DGPMTYP,DGPMX,DGPMRD
"RTN","DGPMVDD",66,0)
 Q
"RTN","DGPMVDD",67,0)
 ;
"RTN","DGPMVDD",68,0)
UARET ;called from DGPM TRANSFER template...default 30 day return from UA
"RTN","DGPMVDD",69,0)
 N DGPMX,X,X1,X2,Y
"RTN","DGPMVDD",70,0)
 S DGPMX=^DGPM(DA,0)
"RTN","DGPMVDD",71,0)
 I $P(DGPMX,"^",18)'=3 S DGPMRET="" Q
"RTN","DGPMVDD",72,0)
 S X1=$P(+DGPMX,".",1),X2=30 D C^%DTC S Y=X X ^DD("DD") S DGPMRET=Y
"RTN","DGPMVDD",73,0)
 Q
"VER")
8.0^22
**END**
**END**
