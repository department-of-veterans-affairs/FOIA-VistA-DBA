EMERGENCY Released XM*8*18 SEQ #25
Extracted from mail message
**KIDS**:XM*8.0*18^

**INSTALL NAME**
XM*8.0*18
"BLD",546,0)
XM*8.0*18^MAILMAN^0^3040602^y
"BLD",546,1,0)
^^2^2^3040526^
"BLD",546,1,1,0)
See patch XM*8*18 in the National Patch Module on FORUM for complete
"BLD",546,1,2,0)
information on this patch.
"BLD",546,4,0)
^9.64PA^4.3^1
"BLD",546,4,4.3,0)
4.3
"BLD",546,4,4.3,2,0)
^9.641^4.34^3
"BLD",546,4,4.3,2,4.3,0)
MAILMAN SITE PARAMETERS  (File-top level)
"BLD",546,4,4.3,2,4.3,1,0)
^9.6411^31^1
"BLD",546,4,4.3,2,4.3,1,31,0)
AUTO-FORWARD LIMITED?
"BLD",546,4,4.3,2,4.33,0)
AUTO-FORWARD APPROVED SITE  (sub-file)
"BLD",546,4,4.3,2,4.33,1,0)
^9.6411^^
"BLD",546,4,4.3,2,4.34,0)
AUTO-FORWARD WAIVER SITE  (sub-file)
"BLD",546,4,4.3,2,4.34,1,0)
^9.6411^^
"BLD",546,4,4.3,222)
y^y^p^^^^n^^n
"BLD",546,4,4.3,224)

"BLD",546,4,"APDD",4.3,4.3)

"BLD",546,4,"APDD",4.3,4.3,31)

"BLD",546,4,"APDD",4.3,4.33)

"BLD",546,4,"APDD",4.3,4.34)

"BLD",546,4,"B",4.3,4.3)

"BLD",546,"INID")
^y
"BLD",546,"INIT")
POST^XMYP18
"BLD",546,"KRN",0)
^9.67PA^8989.52^17
"BLD",546,"KRN",.4,0)
.4
"BLD",546,"KRN",.401,0)
.401
"BLD",546,"KRN",.402,0)
.402
"BLD",546,"KRN",.403,0)
.403
"BLD",546,"KRN",.5,0)
.5
"BLD",546,"KRN",.84,0)
.84
"BLD",546,"KRN",.84,"NM",0)
^9.68A^3^3
"BLD",546,"KRN",.84,"NM",1,0)
38130.1^^0
"BLD",546,"KRN",.84,"NM",2,0)
38130.2^^0
"BLD",546,"KRN",.84,"NM",3,0)
38130.3^^0
"BLD",546,"KRN",.84,"NM","B",38130.1,1)

"BLD",546,"KRN",.84,"NM","B",38130.2,2)

"BLD",546,"KRN",.84,"NM","B",38130.3,3)

"BLD",546,"KRN",3.6,0)
3.6
"BLD",546,"KRN",3.8,0)
3.8
"BLD",546,"KRN",9.2,0)
9.2
"BLD",546,"KRN",9.8,0)
9.8
"BLD",546,"KRN",9.8,"NM",0)
^9.68A^9^9
"BLD",546,"KRN",9.8,"NM",1,0)
XMVVITA^^0^B37353323
"BLD",546,"KRN",9.8,"NM",2,0)
XMXADDR^^0^B68177416
"BLD",546,"KRN",9.8,"NM",3,0)
XMXADDR3^^0^B38170725
"BLD",546,"KRN",9.8,"NM",4,0)
XMXADDRG^^0^B70215802
"BLD",546,"KRN",9.8,"NM",5,0)
XMS3^^0^B52850375
"BLD",546,"KRN",9.8,"NM",6,0)
XMTDF^^0^B26288762
"BLD",546,"KRN",9.8,"NM",7,0)
XMTDL1^^0^B6684306
"BLD",546,"KRN",9.8,"NM",8,0)
XMTDT^^0^B25129965
"BLD",546,"KRN",9.8,"NM",9,0)
XMVGROUP^^0^B60085081
"BLD",546,"KRN",9.8,"NM","B","XMS3",5)

"BLD",546,"KRN",9.8,"NM","B","XMTDF",6)

"BLD",546,"KRN",9.8,"NM","B","XMTDL1",7)

"BLD",546,"KRN",9.8,"NM","B","XMTDT",8)

"BLD",546,"KRN",9.8,"NM","B","XMVGROUP",9)

"BLD",546,"KRN",9.8,"NM","B","XMVVITA",1)

"BLD",546,"KRN",9.8,"NM","B","XMXADDR",2)

"BLD",546,"KRN",9.8,"NM","B","XMXADDR3",3)

"BLD",546,"KRN",9.8,"NM","B","XMXADDRG",4)

"BLD",546,"KRN",19,0)
19
"BLD",546,"KRN",19.1,0)
19.1
"BLD",546,"KRN",19.1,"NM",0)
^9.68A^1^1
"BLD",546,"KRN",19.1,"NM",1,0)
XM AUTO-FORWARD WAIVER^^0
"BLD",546,"KRN",19.1,"NM","B","XM AUTO-FORWARD WAIVER",1)

"BLD",546,"KRN",101,0)
101
"BLD",546,"KRN",409.61,0)
409.61
"BLD",546,"KRN",8989.51,0)
8989.51
"BLD",546,"KRN",8989.52,0)
8989.52
"BLD",546,"KRN",8994,0)
8994
"BLD",546,"KRN","B",.4,.4)

"BLD",546,"KRN","B",.401,.401)

"BLD",546,"KRN","B",.402,.402)

"BLD",546,"KRN","B",.403,.403)

"BLD",546,"KRN","B",.5,.5)

"BLD",546,"KRN","B",.84,.84)

"BLD",546,"KRN","B",3.6,3.6)

"BLD",546,"KRN","B",3.8,3.8)

"BLD",546,"KRN","B",9.2,9.2)

"BLD",546,"KRN","B",9.8,9.8)

"BLD",546,"KRN","B",19,19)

"BLD",546,"KRN","B",19.1,19.1)

"BLD",546,"KRN","B",101,101)

"BLD",546,"KRN","B",409.61,409.61)

"BLD",546,"KRN","B",8989.51,8989.51)

"BLD",546,"KRN","B",8989.52,8989.52)

"BLD",546,"KRN","B",8994,8994)

"BLD",546,"QUES",0)
^9.62^^
"BLD",546,"REQB",0)
^9.611^^0
"FIA",4.3)
MAILMAN SITE PARAMETERS
"FIA",4.3,0)
^XMB(1,
"FIA",4.3,0,0)
4.3P
"FIA",4.3,0,1)
y^y^p^^^^n^^n
"FIA",4.3,0,10)

"FIA",4.3,0,11)

"FIA",4.3,0,"RLRO")

"FIA",4.3,0,"VR")
8.0^XM
"FIA",4.3,4.3)
1
"FIA",4.3,4.3,31)

"FIA",4.3,4.3,31.1)

"FIA",4.3,4.3,31.2)

"FIA",4.3,4.33)
0
"FIA",4.3,4.34)
0
"INIT")
POST^XMYP18
"KRN",.84,38130.1,-1)
0^1
"KRN",.84,38130.1,0)
38130.1^1^^MAILMAN^You can't have your mail forwarded to a
"KRN",.84,38130.1,2,0)
^^3^3^3030415^
"KRN",.84,38130.1,2,1,0)
You can't have your mail forwarded to a non-VA site.
"KRN",.84,38130.1,2,2,0)

"KRN",.84,38130.1,2,3,0)
Waivers can be requested through your site Information Security Officer (ISO).
"KRN",.84,38130.1,5,0)
^.841^1^1
"KRN",.84,38130.1,5,1,0)
XMXADDR3
"KRN",.84,38130.1,5,"B","XMXADDR3",1)

"KRN",.84,38130.2,-1)
0^2
"KRN",.84,38130.2,0)
38130.2^1^^MAILMAN^You have been granted a waiver
"KRN",.84,38130.2,2,0)
^.844^4^4^3030415^^
"KRN",.84,38130.2,2,1,0)
You have been granted a waiver to have your mail forwarded to a non-VA
"KRN",.84,38130.2,2,2,0)
site, but this site is not one of the sites for which a waiver has been
"KRN",.84,38130.2,2,3,0)
granted.  Please contact your site Information Security Officer (ISO)
"KRN",.84,38130.2,2,4,0)
for further information.
"KRN",.84,38130.2,5,0)
^.841^1^1
"KRN",.84,38130.2,5,1,0)
XMXADDR3
"KRN",.84,38130.2,5,"B","XMXADDR3",1)

"KRN",.84,38130.3,-1)
0^3
"KRN",.84,38130.3,0)
38130.3^2^^MAILMAN^Forwarding Address ignored.
"KRN",.84,38130.3,2,0)
^.844^1^1^3030429^^
"KRN",.84,38130.3,2,1,0)
Forwarding Address ignored.
"KRN",.84,38130.3,5,0)
^.841^1^1
"KRN",.84,38130.3,5,1,0)
XMXADDR
"KRN",.84,38130.3,5,"B","XMXADDR",1)

"KRN",19.1,90,-1)
0^1
"KRN",19.1,90,0)
XM AUTO-FORWARD WAIVER^^l^y
"KRN",19.1,90,1,0)
^19.11^12^12^3030415^^
"KRN",19.1,90,1,1,0)
If the AUTO-FORWARD LIMIT? (#31) field is set to YES, auto-forward
"KRN",19.1,90,1,2,0)
addresses are limited to sites in the AUTO-FORWARD APPROVED SITE (#31.1)
"KRN",19.1,90,1,3,0)
multiple.
"KRN",19.1,90,1,4,0)

"KRN",19.1,90,1,5,0)
However, any user who has been assigned this security key, may also
"KRN",19.1,90,1,6,0)
auto-forward to the sites which are listed in the AUTO-FORWARD WAIVER
"KRN",19.1,90,1,7,0)
SITE (#31.2) multiple.
"KRN",19.1,90,1,8,0)

"KRN",19.1,90,1,9,0)
To obtain this security key, the user must submit a request for a waiver
"KRN",19.1,90,1,10,0)
through the site Information Security Officer (ISO).  Only after the waiver
"KRN",19.1,90,1,11,0)
has been granted may the user be assigned this key.  Check with the ISO for
"KRN",19.1,90,1,12,0)
details on the requirements for the waiver.
"MBREQ")
0
"ORD",3,19.1)
19.1;3;1;;KEY^XPDTA1;;;;;KEYDEL^XPDIA1
"ORD",3,19.1,0)
SECURITY KEY
"ORD",9,.84)
.84;9;;;EDEOUT^DIFROMSO(.84,DA,"",XPDA);FPRE^DIFROMSI(.84,"",XPDA);EPRE^DIFROMSI(.84,DA,"",XPDA,"",OLDA);;EPOST^DIFROMSI(.84,DA,"",XPDA);DEL^DIFROMSK(.84,"",%)
"ORD",9,.84,0)
DIALOG
"PKG",8,-1)
1^1
"PKG",8,0)
MAILMAN^XM^Electronic Mail, both local and networked
"PKG",8,20,0)
^9.402P^^
"PKG",8,22,0)
^9.49I^1^1
"PKG",8,22,1,0)
8.0^3020829
"PKG",8,22,1,"PAH",1,0)
18^3040602
"PKG",8,22,1,"PAH",1,1,0)
^^2^2^3040602
"PKG",8,22,1,"PAH",1,1,1,0)
See patch XM*8*18 in the National Patch Module on FORUM for complete
"PKG",8,22,1,"PAH",1,1,2,0)
information on this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","XMS3")
0^5^B52850375
"RTN","XMS3",1,0)
XMS3 ;ISC-SF/GMB-SMTP Send (RFC 822) ;04/15/2003  12:44
"RTN","XMS3",2,0)
 ;;8.0;MailMan;**18**;Jun 28, 2002
"RTN","XMS3",3,0)
 ; Entry points (DBIA 10073):
"RTN","XMS3",4,0)
 ; REC   Get the next line of message text
"RTN","XMS3",5,0)
 Q
"RTN","XMS3",6,0)
HEADER(XMZ,XMZREC,XMFROM,XMNETNAM) ; RFC 822 - Header Records
"RTN","XMS3",7,0)
 ; These records are what you see when you do a "QN" at the prompt:
"RTN","XMS3",8,0)
 ; "Message Action: Ignore//"
"RTN","XMS3",9,0)
 S XMSG="Subject: "_$S($P(XMZREC,U)=$$EZBLD^DIALOG(34012):"",1:$P(XMZREC,U)) X XMSEN Q:ER
"RTN","XMS3",10,0)
 S XMSG="Date: "_$$INDT^XMXUTIL1($P(XMZREC,U,3)) X XMSEN Q:ER
"RTN","XMS3",11,0)
 S XMSG="Message-ID: <"_$$NETID(XMZ)_">" X XMSEN Q:ER
"RTN","XMS3",12,0)
 I $D(^XMB(3.9,XMZ,"IN")) D  Q:ER
"RTN","XMS3",13,0)
 . N XMINRE
"RTN","XMS3",14,0)
 . S XMINRE=^XMB(3.9,XMZ,"IN")
"RTN","XMS3",15,0)
 . I $P(XMINRE,"@",1)?.E1".VA.GOV"!($P(XMINRE,"@",2)?.N) S XMINRE=$P(XMINRE,"@",2)_"@"_$P(XMINRE,"@")
"RTN","XMS3",16,0)
 . S XMSG="In-reply-to: <"_XMINRE_">" X XMSEN
"RTN","XMS3",17,0)
 I "^Y^y^"[(U_$P(XMZREC,U,5)_U) D  Q:ER
"RTN","XMS3",18,0)
 . S XMSG="Return-Receipt-To: "_XMFROM X XMSEN
"RTN","XMS3",19,0)
 I $D(^XMB(3.9,XMZ,"K")) D  Q:ER
"RTN","XMS3",20,0)
 . S XMSG="Encrypted: "_$P(XMZREC,U,10)_U_^("K") X XMSEN
"RTN","XMS3",21,0)
 I $P(XMZREC,U,4)'="" D  Q:ER
"RTN","XMS3",22,0)
 . S XMSG="Sender: "_$$FROM^XMS1($P(XMZREC,U,4),XMNETNAM) X XMSEN
"RTN","XMS3",23,0)
 S XMSG="From: "_XMFROM X XMSEN Q:ER
"RTN","XMS3",24,0)
 I $P(XMZREC,U,6)'="" D  Q:ER
"RTN","XMS3",25,0)
 . S XMSG="Expiry-Date: "_$$INDT^XMXUTIL1($P(XMZREC,U,6)) X XMSEN
"RTN","XMS3",26,0)
 I $P(XMZREC,U,7)["P" D  Q:ER
"RTN","XMS3",27,0)
 . S XMSG="Importance: high" X XMSEN Q:ER
"RTN","XMS3",28,0)
 . S XMSG="X-Priority: 1" X XMSEN
"RTN","XMS3",29,0)
 I "^Y^y^"[(U_$P(XMZREC,U,11)_U) D  Q:ER
"RTN","XMS3",30,0)
 . S XMSG="Sensitivity: Private" X XMSEN
"RTN","XMS3",31,0)
 I $D(^XMB(3.9,XMZ,.5)) D  Q:ER
"RTN","XMS3",32,0)
 . N XMZBSKT
"RTN","XMS3",33,0)
 . S XMZBSKT=$P($G(^XMB(3.9,XMZ,.5)),U,1)
"RTN","XMS3",34,0)
 . Q:XMZBSKT=""
"RTN","XMS3",35,0)
 . S XMSG="X-MM-Basket: "_XMZBSKT X XMSEN
"RTN","XMS3",36,0)
 I $P(XMZREC,U,7)'="",$P(XMZREC,U,7)'="P" D  Q:ER
"RTN","XMS3",37,0)
 . S XMSG="X-MM-Type: "_$P(XMZREC,U,7) X XMSEN
"RTN","XMS3",38,0)
 I "^Y^y^"[(U_$P(XMZREC,U,9)_U) D  Q:ER
"RTN","XMS3",39,0)
 . S XMSG="X-MM-Closed: YES" X XMSEN
"RTN","XMS3",40,0)
 I "^Y^y^"[(U_$P(XMZREC,U,12)_U) D  Q:ER
"RTN","XMS3",41,0)
 . S XMSG="X-MM-Info-Only: YES" X XMSEN
"RTN","XMS3",42,0)
 D TOLIST(XMZ,XMNETNAM) Q:ER
"RTN","XMS3",43,0)
 Q
"RTN","XMS3",44,0)
NETID(XMZ) ;
"RTN","XMS3",45,0)
 N XMCRE8
"RTN","XMS3",46,0)
 S XMCRE8=$P($G(^XMB(3.9,XMZ,.6)),U,1)
"RTN","XMS3",47,0)
 I 'XMCRE8 D
"RTN","XMS3",48,0)
 . S XMCRE8=$P($G(^XMB(3.9,XMZ,0)),U,3)
"RTN","XMS3",49,0)
 . I $P(XMCRE8,".")?7N S XMCRE8=$P(XMCRE8,".")
"RTN","XMS3",50,0)
 . E  D
"RTN","XMS3",51,0)
 . . S XMCRE8=$$CONVERT^XMXUTIL1(XMCRE8)
"RTN","XMS3",52,0)
 . . I XMCRE8=-1 S XMCRE8=DT
"RTN","XMS3",53,0)
 . S $P(^XMB(3.9,XMZ,.6),U,1)=XMCRE8
"RTN","XMS3",54,0)
 . S ^XMB(3.9,"C",XMCRE8,XMZ)=""
"RTN","XMS3",55,0)
 N XMREMID
"RTN","XMS3",56,0)
 I $D(^XMB(3.9,XMZ,5)) D  Q:XMREMID'="" XMREMID
"RTN","XMS3",57,0)
 . S XMREMID=^XMB(3.9,XMZ,5)
"RTN","XMS3",58,0)
 . I $P(XMREMID,"@",1)?.E1".VA.GOV"!($P(XMREMID,"@",2)?.N) S XMREMID=$P(XMREMID,"@",2)_"@"_$P(XMREMID,"@")
"RTN","XMS3",59,0)
 . Q:XMREMID'=""
"RTN","XMS3",60,0)
 . D PARSE^XMR3(XMZ,.XMREMID)
"RTN","XMS3",61,0)
 ;Q XMZ_"@"_^XMB("NETNAME")
"RTN","XMS3",62,0)
 Q XMZ_"."_XMCRE8_"@"_^XMB("NETNAME")
"RTN","XMS3",63,0)
TOLIST(XMZ,XMNETNAM) ;
"RTN","XMS3",64,0)
 N XMTO,XMIEN
"RTN","XMS3",65,0)
 S XMIEN=$O(^XMB(3.9,XMZ,6,0)),XMSG="To: "_$$TOFORMAT($P(^XMB(3.9,XMZ,6,XMIEN,0),U,1),$S($G(XMC("MAILMAN")):$P(^(0),U,2),1:""))
"RTN","XMS3",66,0)
 F  S XMIEN=$O(^XMB(3.9,XMZ,6,XMIEN)) Q:'XMIEN!(XMIEN>50)  D  Q:ER
"RTN","XMS3",67,0)
 . S XMTO=$$TOFORMAT($P(^XMB(3.9,XMZ,6,XMIEN,0),U,1),$S($G(XMC("MAILMAN")):$P(^(0),U,2),1:""))
"RTN","XMS3",68,0)
 . S XMSG=XMSG_","
"RTN","XMS3",69,0)
 . I $L(XMSG)+$L(XMTO)>80 D TOSEND(.XMSG) Q:ER
"RTN","XMS3",70,0)
 . S XMSG=XMSG_" "_XMTO
"RTN","XMS3",71,0)
 Q:ER
"RTN","XMS3",72,0)
 D TOSEND(.XMSG) Q:ER
"RTN","XMS3",73,0)
 I XMIEN>50 S XMSG="(Too many recipients to list...)" D TOSEND(.XMSG) Q:ER
"RTN","XMS3",74,0)
 Q
"RTN","XMS3",75,0)
TOFORMAT(XMTO,XMPREFIX) ;
"RTN","XMS3",76,0)
 N XMDOM
"RTN","XMS3",77,0)
 S XMDOM=$S(XMTO["@":$P(XMTO,"@",2,99),1:XMNETNAM)
"RTN","XMS3",78,0)
 S XMTO=$$TO($P(XMTO,"@"))
"RTN","XMS3",79,0)
 Q $S(XMPREFIX="":"",$E(XMTO,1)=$C(34):"",1:XMPREFIX_":")_XMTO_"@"_XMDOM
"RTN","XMS3",80,0)
TO(XMTO) ;
"RTN","XMS3",81,0)
 I $E(XMTO)'=$C(34),(XMTO[",")!(XMTO[" ") D
"RTN","XMS3",82,0)
 . I XMTO["," S XMTO=$TR(XMTO,", .","._+")
"RTN","XMS3",83,0)
 . I XMTO[" " S XMTO=$C(34)_XMTO_$C(34)
"RTN","XMS3",84,0)
 Q XMTO
"RTN","XMS3",85,0)
TOSEND(XMSG) ;
"RTN","XMS3",86,0)
 I $L(XMSG)>80 D  Q
"RTN","XMS3",87,0)
 . N XMSGHOLD,XMPIECES
"RTN","XMS3",88,0)
 . S XMPIECES=$L(XMSG,"@")
"RTN","XMS3",89,0)
 . S XMSGHOLD=$P(XMSG,"@",XMPIECES)
"RTN","XMS3",90,0)
 . S XMSG=$P(XMSG,"@",1,XMPIECES-1)
"RTN","XMS3",91,0)
 . X XMSEN
"RTN","XMS3",92,0)
 . S XMSG="    @"_XMSGHOLD
"RTN","XMS3",93,0)
 X XMSEN
"RTN","XMS3",94,0)
 S XMSG="   "
"RTN","XMS3",95,0)
 Q
"RTN","XMS3",96,0)
TEXT(XMZ) ; Send body of text
"RTN","XMS3",97,0)
 N XMS0AJ
"RTN","XMS3",98,0)
 ;S XMBLOCK=1 ; *** What's this?  See ^XML4CRC* & ^XMLSWP*
"RTN","XMS3",99,0)
 S XMS0AJ=0
"RTN","XMS3",100,0)
 F  S XMS0AJ=$O(^XMB(3.9,XMZ,2,XMS0AJ)) Q:XMS0AJ'>0  D  Q:ER
"RTN","XMS3",101,0)
 . S XMSG=^XMB(3.9,XMZ,2,XMS0AJ,0)
"RTN","XMS3",102,0)
 . I $E(XMSG)="." S XMSG="."_XMSG
"RTN","XMS3",103,0)
 . E  I $E(XMSG,1,4)="~*~^" S XMSG=" "_XMSG  ; *** What's this?
"RTN","XMS3",104,0)
 . X XMSEN
"RTN","XMS3",105,0)
 I ER S ER("MSG")="Error sending msg "_XMZ_", text line "_XMS0AJ Q
"RTN","XMS3",106,0)
 ;D:$D(XMBLOCK) KILL^XML4CRC
"RTN","XMS3",107,0)
 Q
"RTN","XMS3",108,0)
RCPTERR(XMERRMSG,XMZ,XMZREC,XMNVFROM,XMRCPTO,XMRCPT,XMIEN) ; Non-delivery to recipient
"RTN","XMS3",109,0)
 N XMFDA,XMIENS,XMTO,XMPARM,XMINSTR
"RTN","XMS3",110,0)
 S XMIENS=XMIEN_","_XMZ_","
"RTN","XMS3",111,0)
 S XMFDA(3.91,XMIENS,3)="@"                ; remote msg id
"RTN","XMS3",112,0)
 S XMFDA(3.91,XMIENS,4)=XMCM("START","FM") ; xmit date/time
"RTN","XMS3",113,0)
 S XMFDA(3.91,XMIENS,5)=$E($P(XMERRMSG," ",2,999),1,30)  ; status
"RTN","XMS3",114,0)
 S XMFDA(3.91,XMIENS,6)="@"                ; path
"RTN","XMS3",115,0)
 D FILE^DIE("","XMFDA")
"RTN","XMS3",116,0)
 S XMTO=$$SENDER(XMZ,XMZREC,XMNVFROM,XMIEN,1,XMERRMSG) Q:"<>"[XMTO
"RTN","XMS3",117,0)
 S XMINSTR("FROM")="POSTMASTER"
"RTN","XMS3",118,0)
 S XMPARM(1)=$P(XMZREC,U,1) ; subject
"RTN","XMS3",119,0)
 S XMPARM(2)=XMRCPTO
"RTN","XMS3",120,0)
 S XMPARM(3)=XMERRMSG
"RTN","XMS3",121,0)
 S XMPARM(4)=XMRCPT
"RTN","XMS3",122,0)
 S XMPARM(5)=$S(XMTO["@":$G(^XMB(3.9,XMZ,5)),1:XMZ)
"RTN","XMS3",123,0)
 D TASKBULL^XMXBULL(.5,"XM SEND ERR RECIPIENT",.XMPARM,"",XMTO,.XMINSTR)
"RTN","XMS3",124,0)
 Q
"RTN","XMS3",125,0)
MSGERR(XMSITE,XMINST,XMERRMSG,XMZ,XMZREC,XMNVFROM,XMRCPT) ;
"RTN","XMS3",126,0)
 ; If a message is rejected at a site for any reason (the whole message,
"RTN","XMS3",127,0)
 ; not just one recipient), then this message may be sent.
"RTN","XMS3",128,0)
 N XMTO,XMPARM,XMIEN,XMNAME,XMCNT,XMINSTR
"RTN","XMS3",129,0)
 D DOTRAN^XMC1(XMERRMSG)
"RTN","XMS3",130,0)
 S XMPARM(3)=XMERRMSG
"RTN","XMS3",131,0)
 S XMERRMSG=$E($P(XMERRMSG," ",2,999),1,30)
"RTN","XMS3",132,0)
 K ^TMP("XM",$J,"REJECT")
"RTN","XMS3",133,0)
 S XMIEN=""
"RTN","XMS3",134,0)
 F  S XMIEN=$S($D(XMRCPT):$O(XMRCPT(XMIEN)),1:$O(^XMB(3.9,XMZ,1,"AQUEUE",XMINST,XMIEN))) Q:XMIEN=""  D
"RTN","XMS3",135,0)
 . N XMFDA,XMIENS
"RTN","XMS3",136,0)
 . S XMIENS=XMIEN_","_XMZ_","
"RTN","XMS3",137,0)
 . S XMFDA(3.91,XMIENS,3)="@"      ; remote msg id
"RTN","XMS3",138,0)
 . S XMFDA(3.91,XMIENS,4)=XMCM("START","FM") ; xmit date/time
"RTN","XMS3",139,0)
 . S XMFDA(3.91,XMIENS,5)=XMERRMSG ; status
"RTN","XMS3",140,0)
 . S XMFDA(3.91,XMIENS,6)="@"      ; path
"RTN","XMS3",141,0)
 . S XMFDA(3.91,XMIENS,9)="@"      ; xmit time
"RTN","XMS3",142,0)
 . D FILE^DIE("","XMFDA")
"RTN","XMS3",143,0)
 . S XMNAME=$P($G(^XMB(3.9,XMZ,1,XMIEN,0)),U,1) Q:XMNAME=""
"RTN","XMS3",144,0)
 . S XMTO=$$SENDER(XMZ,XMZREC,XMNVFROM,XMIEN) Q:"<>"[XMTO
"RTN","XMS3",145,0)
 . S (XMCNT,^(XMTO))=$G(^TMP("XM",$J,"REJECT",XMTO))+1
"RTN","XMS3",146,0)
 . S ^TMP("XM",$J,"REJECT",XMTO,XMCNT)=XMNAME
"RTN","XMS3",147,0)
 S XMINSTR("FROM")="POSTMASTER"
"RTN","XMS3",148,0)
 S XMPARM(1)=$P(XMZREC,U,1) ; subject
"RTN","XMS3",149,0)
 S XMPARM(2)=XMSITE
"RTN","XMS3",150,0)
 S XMTO=""
"RTN","XMS3",151,0)
 F  S XMTO=$O(^TMP("XM",$J,"REJECT",XMTO)) Q:XMTO=""  D TASKBULL^XMXBULL(.5,"XM SEND ERR MSG",.XMPARM,"^TMP(""XM"",$J,""REJECT"",XMTO)",XMTO,.XMINSTR)
"RTN","XMS3",152,0)
 K ^TMP("XM",$J,"REJECT")
"RTN","XMS3",153,0)
 Q
"RTN","XMS3",154,0)
SENDER(XMZ,XMZREC,XMNVFROM,XMIEN,XMDELFWD,XMERRMSG) ; Function returns 'to whom to send error message'
"RTN","XMS3",155,0)
 N XMFWDREC,XMFWDR
"RTN","XMS3",156,0)
 S XMFWDREC=$G(^XMB(3.9,XMZ,1,XMIEN,"F")) ; Try to find forwarder
"RTN","XMS3",157,0)
 S XMFWDR=$P(XMFWDREC,U,2)
"RTN","XMS3",158,0)
 I XMFWDR'="" D  Q XMFWDR  ; Forwarder is local
"RTN","XMS3",159,0)
 . I $G(XMDELFWD) D DELFWD(XMZ,XMIEN,XMFWDR,XMERRMSG)
"RTN","XMS3",160,0)
 I $E(XMFWDREC)="<" Q $E($P($P(XMFWDREC,U,1),">",1),2,999)  ; Forwarder is remote
"RTN","XMS3",161,0)
 Q:$D(^XMB(3.9,XMZ,.7)) XMNVFROM  ; Sender is remote
"RTN","XMS3",162,0)
 N XMFROM
"RTN","XMS3",163,0)
 S XMFROM=$P(XMZREC,U,2)
"RTN","XMS3",164,0)
 I +XMFROM=XMFROM Q XMFROM  ; Sender is local
"RTN","XMS3",165,0)
 I XMFROM'["@" Q .5         ; Sender is fictitious, so notify postmaster
"RTN","XMS3",166,0)
 Q XMNVFROM  ; Sender is remote
"RTN","XMS3",167,0)
DELFWD(XMZ,XMIEN,XMFWDR,XMERRMSG) ; Delete user's forwarding address
"RTN","XMS3",168,0)
 Q:+XMFWDR'=XMFWDR
"RTN","XMS3",169,0)
 N XMFWD
"RTN","XMS3",170,0)
 S XMFWD=$P(^XMB(3.7,XMFWDR,0),U,2) Q:XMFWD=""
"RTN","XMS3",171,0)
 N XMINSTR,XMADDR,XMFULL,XMERROR,XMFDA,XMTXT,XMFWDADD
"RTN","XMS3",172,0)
 S XMINSTR("ADDR FLAGS")="X" ; do not create ^TMP(, just check.
"RTN","XMS3",173,0)
 S XMADDR=$P(^XMB(3.9,XMZ,1,XMIEN,0),U,1)
"RTN","XMS3",174,0)
 D ADDRESS^XMXADDR(DUZ,XMFWD,.XMFULL,.XMERROR)
"RTN","XMS3",175,0)
 I '$D(XMERROR),XMADDR'=$G(XMFULL) Q
"RTN","XMS3",176,0)
 D DELFWD^XMVVITA(XMFWDR,XMFWD,XMERRMSG)
"RTN","XMS3",177,0)
 Q
"RTN","XMS3",178,0)
 ; The following has nothing to do with the above.
"RTN","XMS3",179,0)
 ; These are used by the SERVER Communications Protocol in file 3.4.
"RTN","XMS3",180,0)
REC ; Read the next line of text from the message.  When called for the
"RTN","XMS3",181,0)
 ; first time, returns the first line.
"RTN","XMS3",182,0)
 ; In:
"RTN","XMS3",183,0)
 ; XMZ   - IEN of the message in file 3.9
"RTN","XMS3",184,0)
 ; XMPOS - (optional) line number of the previous line read
"RTN","XMS3",185,0)
 ;         Default is .999999
"RTN","XMS3",186,0)
 ; Out:
"RTN","XMS3",187,0)
 ; XMPOS - line number of XMRG
"RTN","XMS3",188,0)
 ; XMRG  - =the next line of text, if OK; ="" if end of text reached
"RTN","XMS3",189,0)
 ; XMER  - =0 if OK; =-1 if end of text reached
"RTN","XMS3",190,0)
 S XMPOS=$S('$D(XMPOS):.999999,XMPOS<.999999:.999999,1:XMPOS)
"RTN","XMS3",191,0)
 S XMPOS=$O(^XMB(3.9,XMZ,2,XMPOS))
"RTN","XMS3",192,0)
 I +XMPOS'=XMPOS S XMER=-1,XMRG="" Q
"RTN","XMS3",193,0)
 S XMRG=^XMB(3.9,XMZ,2,XMPOS,0),XMER=0
"RTN","XMS3",194,0)
 Q
"RTN","XMS3",195,0)
SEN ; Send a line to the return message
"RTN","XMS3",196,0)
 S XMSLINE=XMSLINE+1,^XMB(3.9,XMZ,2,XMSLINE,0)=XMSG
"RTN","XMS3",197,0)
 Q
"RTN","XMS3",198,0)
OPEN ; Open the reverse message path
"RTN","XMS3",199,0)
 Q
"RTN","XMS3",200,0)
CLOSE ; Close the reverse message
"RTN","XMS3",201,0)
 S ^XMB(3.9,XMZ,2,0)="^3.92A^"_XMSLINE_U_XMSLINE_U_DT
"RTN","XMS3",202,0)
 Q
"RTN","XMTDF")
0^6^B26288762
"RTN","XMTDF",1,0)
XMTDF ;ISC-SF/GMB-Filter message: multiple conditions ;04/15/2003  12:45
"RTN","XMTDF",2,0)
 ;;8.0;MailMan;**18**;Jun 28, 2002
"RTN","XMTDF",3,0)
 ; XMF("SUBJ")  Subject contains this string
"RTN","XMTDF",4,0)
 ; XMF("FROM")  Message is from this person
"RTN","XMTDF",5,0)
 ; XMF("TO")    Message is to this person
"RTN","XMTDF",6,0)
FILTER(XMDUZ,XMZ,XMZSUBJ,XMZFROM,XMK,XMKN,XMACT) ; figures out which basket to save to
"RTN","XMTDF",7,0)
 ; the message should be put in.
"RTN","XMTDF",8,0)
 ; Defaults: the "IN" basket.
"RTN","XMTDF",9,0)
 ; If basket doesn't exist, it creates the basket.
"RTN","XMTDF",10,0)
 ; Returns:
"RTN","XMTDF",11,0)
 ; XMK  basket number
"RTN","XMTDF",12,0)
 ; XMKN basket name
"RTN","XMTDF",13,0)
 ; Optionally, if specified by user:
"RTN","XMTDF",14,0)
 ; XMACT("VDAYS") set vaporize date to this many days from today.
"RTN","XMTDF",15,0)
 ; XMACT("NONEW") don't make this message new.
"RTN","XMTDF",16,0)
 ; XMACT("FWD")   forward this message
"RTN","XMTDF",17,0)
 N XMORDER,XMIEN,XMFREC
"RTN","XMTDF",18,0)
 K XMK,XMKN
"RTN","XMTDF",19,0)
 S (XMORDER,XMIEN)=0
"RTN","XMTDF",20,0)
 F  S XMORDER=$O(^XMB(3.7,XMDUZ,15,"AF",XMORDER)) Q:'XMORDER  D  Q:$D(XMKN)
"RTN","XMTDF",21,0)
 . F  S XMIEN=$O(^XMB(3.7,XMDUZ,15,"AF",XMORDER,XMIEN)) Q:'XMIEN  D  Q:$D(XMKN)
"RTN","XMTDF",22,0)
 . . N XMF
"RTN","XMTDF",23,0)
 . . S XMFREC=$G(^XMB(3.7,XMDUZ,15,XMIEN,0))
"RTN","XMTDF",24,0)
 . . S:$P(XMFREC,U,5)]"" XMF("SUBJ")=$P(XMFREC,U,5)
"RTN","XMTDF",25,0)
 . . S:$P(XMFREC,U,6)]"" XMF("FROM")=$P(XMFREC,U,6)
"RTN","XMTDF",26,0)
 . . S:$P(XMFREC,U,7)]"" XMF("TO")=$P(XMFREC,U,7)
"RTN","XMTDF",27,0)
 . . S:$$GOODMSG(XMZ,XMZSUBJ,XMZFROM,.XMF) XMKN=$P(XMFREC,U,3)
"RTN","XMTDF",28,0)
 I '$D(XMKN) D  Q
"RTN","XMTDF",29,0)
 . S XMK=1,XMKN=$$EZBLD^DIALOG(37005)   ; Default to "IN" basket
"RTN","XMTDF",30,0)
 . D:'$D(^XMB(3.7,XMDUZ,2,XMK,0)) MAKEBSKT^XMXBSKT(XMDUZ,XMK,XMKN)
"RTN","XMTDF",31,0)
 S XMK=$O(^XMB(3.7,XMDUZ,2,"B",XMKN,0))
"RTN","XMTDF",32,0)
 I $P(XMFREC,U,8) S XMACT("VDAYS")=$P(XMFREC,U,8)
"RTN","XMTDF",33,0)
 I $P(XMFREC,U,9)="N" S XMACT("NONEW")=1
"RTN","XMTDF",34,0)
 I $D(^XMB(3.7,XMDUZ,15,XMIEN,1,"B")),$$OKFWD(XMZ) S XMACT("FWD")=XMIEN
"RTN","XMTDF",35,0)
 Q:XMK
"RTN","XMTDF",36,0)
 I XMKN=$$EZBLD^DIALOG(37004) S XMK=.5 D MAKEBSKT^XMXBSKT(XMDUZ,XMK,XMKN) Q  ; "WASTE"
"RTN","XMTDF",37,0)
 D MAKEBSKT^XMXBSKT(XMDUZ,.XMK,XMKN)
"RTN","XMTDF",38,0)
 Q
"RTN","XMTDF",39,0)
GOODMSG(XMZ,XMZSUBJ,XMZFROM,XMF) ;
"RTN","XMTDF",40,0)
 ; This function is a copy of $$GOODMSG^XMJMFB, but with fewer
"RTN","XMTDF",41,0)
 ; conditions to match on.
"RTN","XMTDF",42,0)
 N XMNOGOOD
"RTN","XMTDF",43,0)
 I $D(XMF("SUBJ")),$$UP^XLFSTR(XMZSUBJ)'[XMF("SUBJ") Q 0
"RTN","XMTDF",44,0)
 I $D(XMF("FROM")) D  Q:XMNOGOOD 0
"RTN","XMTDF",45,0)
 . I XMF("FROM")=+XMF("FROM"),XMF("FROM")=XMZFROM S XMNOGOOD=0 Q
"RTN","XMTDF",46,0)
 . S XMNOGOOD=1
"RTN","XMTDF",47,0)
 . Q:XMF("FROM")'["@"
"RTN","XMTDF",48,0)
 . S XMZFROM=$$UP^XLFSTR(XMZFROM)
"RTN","XMTDF",49,0)
 . Q:$P(XMZFROM,"@")'[$P(XMF("FROM"),"@")
"RTN","XMTDF",50,0)
 . Q:$P(XMZFROM,"@",2)'[$P(XMF("FROM"),"@",2)
"RTN","XMTDF",51,0)
 . S XMNOGOOD=0
"RTN","XMTDF",52,0)
 I $D(XMF("TO")) D  Q:XMNOGOOD 0
"RTN","XMTDF",53,0)
 . I $D(^XMB(3.9,XMZ,6,"B",XMF("TO"))) S XMNOGOOD=0 Q
"RTN","XMTDF",54,0)
 . I $L(XMF("TO"))>30,$D(^XMB(3.9,XMZ,6,"B",$E(XMF("TO"),1,30))),XMF("TO")=$P($G(^XMB(3.9,XMZ,6,+$O(^XMB(3.9,XMZ,6,"B",$E(XMF("TO"),1,30),0)),0)),U,1) S XMNOGOOD=0 Q
"RTN","XMTDF",55,0)
 . S XMNOGOOD=1
"RTN","XMTDF",56,0)
 . Q:XMF("TO")'["@"
"RTN","XMTDF",57,0)
 . N XMTOX,XMTO
"RTN","XMTDF",58,0)
 . S XMTO=""
"RTN","XMTDF",59,0)
 . F  S XMTO=$O(^XMB(3.9,XMZ,6,"B",XMTO)) Q:XMTO=""  D  Q:'XMNOGOOD
"RTN","XMTDF",60,0)
 . . Q:XMTO'["@"
"RTN","XMTDF",61,0)
 . . S XMTOX=$$UP^XLFSTR(XMTO)
"RTN","XMTDF",62,0)
 . . Q:$P(XMTOX,"@")'[$P(XMF("TO"),"@")
"RTN","XMTDF",63,0)
 . . Q:$P(XMTOX,"@",2)'[$P(XMF("TO"),"@",2)
"RTN","XMTDF",64,0)
 . . S XMNOGOOD=0
"RTN","XMTDF",65,0)
 Q 1
"RTN","XMTDF",66,0)
BASKET(X) ; Input Transform for file 3.7, subfile 3.715, field 2 BASKET
"RTN","XMTDF",67,0)
 N DIC,Y,DA
"RTN","XMTDF",68,0)
 S DA(1)=$G(XMDUZ,DUZ)
"RTN","XMTDF",69,0)
 S DIC="^XMB(3.7,"_DA(1)_",2,"
"RTN","XMTDF",70,0)
 S DIC("P")=3.701
"RTN","XMTDF",71,0)
 S DIC(0)="EQL"
"RTN","XMTDF",72,0)
 D ^DIC
"RTN","XMTDF",73,0)
 I $P(Y,U)=1 K X Q  ; May not filter to the IN basket
"RTN","XMTDF",74,0)
 I Y>0 S X=$P(Y,U,2) Q
"RTN","XMTDF",75,0)
 K X
"RTN","XMTDF",76,0)
 Q
"RTN","XMTDF",77,0)
BSKTHELP ; Executable Help for file 3.7, subfile 3.715, field 2 BASKET
"RTN","XMTDF",78,0)
 N DIC,Y
"RTN","XMTDF",79,0)
 Q:"??"'[X
"RTN","XMTDF",80,0)
 S DIC("S")="I X'="""_$$EZBLD^DIALOG(37005)_"""" ; IN
"RTN","XMTDF",81,0)
 S DIC="^XMB(3.7,"_$G(XMDUZ,DUZ)_",2,"
"RTN","XMTDF",82,0)
 S DIC(0)="EQL"
"RTN","XMTDF",83,0)
 D ^DIC
"RTN","XMTDF",84,0)
 Q
"RTN","XMTDF",85,0)
FROM(X) ; Input Transform for file 3.7, subfile 3.715, field 5 FROM
"RTN","XMTDF",86,0)
 S X=$$UP^XLFSTR(X)
"RTN","XMTDF",87,0)
 I X["@" K:$L(X)<2!($L(X)>45) X Q
"RTN","XMTDF",88,0)
 N DIC,Y
"RTN","XMTDF",89,0)
 S DIC="^VA(200,",DIC(0)="MNE"
"RTN","XMTDF",90,0)
 D ^DIC
"RTN","XMTDF",91,0)
 I Y=-1 K X Q
"RTN","XMTDF",92,0)
 S X=+Y
"RTN","XMTDF",93,0)
 Q
"RTN","XMTDF",94,0)
TO(X) ; Input Transform for file 3.7, subfile 3.715, field 6 ADDRESSED TO
"RTN","XMTDF",95,0)
 I X["@" D  Q
"RTN","XMTDF",96,0)
 . S X=$$UP^XLFSTR(X)
"RTN","XMTDF",97,0)
 . K:$L(X)<2!($L(X)>55) X
"RTN","XMTDF",98,0)
 I $E(X,1,2)="G."!($E(X,1,2)="g.") D  Q
"RTN","XMTDF",99,0)
 . ; See GETPERS^XMJMF2 for another way to do the lookup.  The difference
"RTN","XMTDF",100,0)
 . ; is that the other way does not let unauthorized senders pick groups
"RTN","XMTDF",101,0)
 . ; which have authorized senders.
"RTN","XMTDF",102,0)
 . S X=$E(X,3,99)
"RTN","XMTDF",103,0)
 . N DIC,Y
"RTN","XMTDF",104,0)
 . ; Screen:  Group is public OR user is organizer
"RTN","XMTDF",105,0)
 . ;          OR group is unrestricted and user is member
"RTN","XMTDF",106,0)
 . S DIC("S")="N XMR S XMR=^(0) I $S($P(XMR,U,2)=""PU"":1,$P($G(^XMB(3.8,+Y,3),.5),U)=$G(XMDUZ,DUZ):1,+$P(XMR,U,6):0,$D(^XMB(3.8,+Y,1,""B"",$G(XMDUZ,DUZ))):1,1:0)"
"RTN","XMTDF",107,0)
 . S DIC="^XMB(3.8,"
"RTN","XMTDF",108,0)
 . S DIC(0)="MEZ"
"RTN","XMTDF",109,0)
 . D ^DIC
"RTN","XMTDF",110,0)
 . I Y=-1 K X Q
"RTN","XMTDF",111,0)
 . S X="G."_$P(Y,U,2)_$S($P(Y(0),U,6):$$EZBLD^DIALOG(39135),1:"") ; " [Private Mail Group]"
"RTN","XMTDF",112,0)
 S X=$$UP^XLFSTR(X)
"RTN","XMTDF",113,0)
 N DIC,Y
"RTN","XMTDF",114,0)
 S DIC="^VA(200,",DIC(0)="MNE"
"RTN","XMTDF",115,0)
 D ^DIC
"RTN","XMTDF",116,0)
 I Y=-1 K X Q
"RTN","XMTDF",117,0)
 S X=$P(Y,U,2)
"RTN","XMTDF",118,0)
 Q
"RTN","XMTDF",119,0)
FWDTO(XMADDR,XMIA) ; Input Transform for file 3.7, subfile 3.715,
"RTN","XMTDF",120,0)
 ; subfile 3.7159, field .01 FORWARD TO
"RTN","XMTDF",121,0)
 N DO ; to keep FileMan from exploding (that's D-oh)
"RTN","XMTDF",122,0)
 N XMERROR,XMRESTR,XMINSTR,XMFULL,XMFWDADD
"RTN","XMTDF",123,0)
 S XMINSTR("ADDR FLAGS")="X" ; do not create ^TMP(, just check.
"RTN","XMTDF",124,0)
 D ADDRESS^XMXADDR(DUZ,XMADDR,.XMFULL,.XMERROR)
"RTN","XMTDF",125,0)
 I $D(XMERROR) K XMADDR Q
"RTN","XMTDF",126,0)
 S XMADDR=XMFULL
"RTN","XMTDF",127,0)
 Q
"RTN","XMTDF",128,0)
DELFWDTO(XMUSER,XMFILTER,XMIEN,XMFWD,XMERROR) ; Delete a user's invalid FORWARD TO address.
"RTN","XMTDF",129,0)
 N XMPARM,XMINSTR,XMFDA
"RTN","XMTDF",130,0)
 S XMFDA(3.7159,XMIEN_","_XMFILTER_","_XMUSER_",",.01)="@"
"RTN","XMTDF",131,0)
 D FILE^DIE("","XMFDA")
"RTN","XMTDF",132,0)
 S XMINSTR("FROM")=.5
"RTN","XMTDF",133,0)
 S XMPARM(1)=XMFWD,XMPARM(3)=XMERROR
"RTN","XMTDF",134,0)
 S XMPARM(2)=$P(^XMB(3.7,XMUSER,15,XMFILTER,0),U,1) ; filter name
"RTN","XMTDF",135,0)
 D TASKBULL^XMXBULL(.5,"XM FILTER FWD ADDRESS DELETE",.XMPARM,"",XMUSER,.XMINSTR)
"RTN","XMTDF",136,0)
 Q
"RTN","XMTDF",137,0)
OKFWD(XMZ) ; Is it OK to automatically forward this message?
"RTN","XMTDF",138,0)
 N XMZREC
"RTN","XMTDF",139,0)
 S XMZREC=$G(^XMB(3.9,XMZ,0))
"RTN","XMTDF",140,0)
 Q:$$CLOSED^XMXSEC(XMZREC) 0
"RTN","XMTDF",141,0)
 Q:$$CONFID^XMXSEC(XMZREC) 0
"RTN","XMTDF",142,0)
 Q 1
"RTN","XMTDL1")
0^7^B6684306
"RTN","XMTDL1",1,0)
XMTDL1 ;ISC-SF/GMB-Deliver local mail to mailbox (cont.) ;04/15/2003  12:53
"RTN","XMTDL1",2,0)
 ;;8.0;MailMan;**18**;Jun 28, 2002
"RTN","XMTDL1",3,0)
BRODCAST(XMZ,XMZSUBJ,XMZFROM,XMFROM,XMK,XMDEL,XMZPDATE,XMZBSKT,XMACNT) ;
"RTN","XMTDL1",4,0)
 N XMTO,XMREC,XMIA,XMNOFWD
"RTN","XMTDL1",5,0)
 ; Don't forward message if this is FORUM and it was sent to G.EVERYBODY.
"RTN","XMTDL1",6,0)
 S XMNOFWD=$S('$$FORUM^XMXADDRD:0,'$D(^XMB(3.9,XMZ,6,"B","G.EVERYBODY")):0,1:1)
"RTN","XMTDL1",7,0)
 D INIT^XMXADDR
"RTN","XMTDL1",8,0)
 S (XMTO,XMIA)=0
"RTN","XMTDL1",9,0)
 F  S XMTO=$O(^XMB(3.7,XMTO)) Q:'XMTO  D
"RTN","XMTDL1",10,0)
 . Q:$P($G(^VA(200,XMTO,0)),U,3)=""!($P($G(^(.1)),U,2)="")!($P($G(^(201)),U)="")  ; Quit if no access code, or verify code, or primary menu
"RTN","XMTDL1",11,0)
 . Q:$D(^XUSEC("XM NO BROADCASTS",XMTO))  ; Quit if user doesn't want broadcast messages
"RTN","XMTDL1",12,0)
 . S XMACNT=XMACNT+1
"RTN","XMTDL1",13,0)
 . S XMREC=$G(^XMB(3.7,XMTO,0)) Q:XMREC=""
"RTN","XMTDL1",14,0)
 . I $P(XMREC,U,2)=""!XMNOFWD D DELIVER^XMTDL2(XMTO,XMZ,XMZSUBJ,XMZFROM,XMFROM,0,$G(XMK(XMTO)),$G(XMDEL(XMTO),XMZPDATE),XMZBSKT) Q
"RTN","XMTDL1",15,0)
 . N XMERROR,XMFULL,XMFWDADD
"RTN","XMTDL1",16,0)
 . S XMFWDADD=XMTO
"RTN","XMTDL1",17,0)
 . D REMOTE^XMXADDR3(.5,$P(XMREC,U,2),0,"","",.XMFULL)
"RTN","XMTDL1",18,0)
 . I $D(XMERROR) D DELFWD^XMVVITA(XMTO,$P(XMREC,U,2),XMERROR)
"RTN","XMTDL1",19,0)
 . I '$D(XMERROR),$D(^TMP("XMY",$J,XMFULL)) S ^TMP("XMY",$J,XMFULL,"F")=XMTO
"RTN","XMTDL1",20,0)
 . I $P(XMREC,U,8)!$D(XMERROR)!'$D(^TMP("XMY",$J,$G(XMFULL,"?"))) D DELIVER^XMTDL2(XMTO,XMZ,XMZSUBJ,XMZFROM,XMFROM,0,$G(XMK(XMTO)),$G(XMDEL(XMTO),XMZPDATE),XMZBSKT)
"RTN","XMTDL1",21,0)
 S XMTO=0
"RTN","XMTDL1",22,0)
 F  S XMTO=$O(^TMP("XMY",$J,XMTO)) Q:+XMTO'=XMTO  K ^(XMTO) ; Don't forward to locals
"RTN","XMTDL1",23,0)
 I $$GOTADDR^XMXADDR D
"RTN","XMTDL1",24,0)
 . N XMINSTR
"RTN","XMTDL1",25,0)
 . S XMINSTR("FWD BY")=""
"RTN","XMTDL1",26,0)
 . D FWD^XMKP(.5,XMZ,.XMINSTR)
"RTN","XMTDL1",27,0)
 D CLEANUP^XMXADDR
"RTN","XMTDL1",28,0)
 Q
"RTN","XMTDL1",29,0)
STATS(XMGROUP,XMQUEUE,XMMCNT,XMRCNT,XMACNT) ;
"RTN","XMTDL1",30,0)
 ; The following global is incremented in STATS^XMKPLQ
"RTN","XMTDL1",31,0)
 ; # messages in queue^# recipients anticipated
"RTN","XMTDL1",32,0)
 N XMSTATS
"RTN","XMTDL1",33,0)
 L +^XMBPOST("QSTATS",XMGROUP,XMQUEUE)
"RTN","XMTDL1",34,0)
 S XMSTATS=^XMBPOST(XMGROUP,XMQUEUE),^(XMQUEUE)=($P(XMSTATS,U)-XMMCNT)_U_($P(XMSTATS,U,2)-XMRCNT)
"RTN","XMTDL1",35,0)
 L -^XMBPOST("QSTATS",XMGROUP,XMQUEUE)
"RTN","XMTDL1",36,0)
 ; The following global is incremented here only.
"RTN","XMTDL1",37,0)
 ; # recipients delivered
"RTN","XMTDL1",38,0)
 L +^XMBPOST("GSTATS",XMGROUP)
"RTN","XMTDL1",39,0)
 S ^(XMGROUP)=$G(^XMBPOST("STATS",XMGROUP))+$G(XMACNT)
"RTN","XMTDL1",40,0)
 L -^XMBPOST("GSTATS",XMGROUP)
"RTN","XMTDL1",41,0)
 Q
"RTN","XMTDT")
0^8^B25129965
"RTN","XMTDT",1,0)
XMTDT ;ISC-SF/GMB-Deliver later'd msgs & delete inactive msgs ;04/15/2003  12:48
"RTN","XMTDT",2,0)
 ;;8.0;MailMan;**18**;Jun 28, 2002
"RTN","XMTDT",3,0)
 ; Replaces ^XMADJ999,LATER^XMAD2 (ISC-WASH/CAP)
"RTN","XMTDT",4,0)
GO ;
"RTN","XMTDT",5,0)
 N XMWAIT
"RTN","XMTDT",6,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XMTDT",7,0)
 L +^XMBPOST("POST_Tickler"):1 E  Q
"RTN","XMTDT",8,0)
 I $D(ZTQUEUED) S %=$$PSET^%ZTLOAD(ZTSK)
"RTN","XMTDT",9,0)
 F  Q:$P($G(^XMB(1,1,0)),U,16)  D
"RTN","XMTDT",10,0)
 . D LATERNEW
"RTN","XMTDT",11,0)
 . D LATERFWD
"RTN","XMTDT",12,0)
 . D PURGEOLD
"RTN","XMTDT",13,0)
 . D FILTRFWD
"RTN","XMTDT",14,0)
 . S XMWAIT=$$TSTAMP^XMXUTIL1      ; Why can't we just H 60?
"RTN","XMTDT",15,0)
 . F  D  Q:$$TSTAMP^XMXUTIL1-XMWAIT>60
"RTN","XMTDT",16,0)
 . . H XMHANG
"RTN","XMTDT",17,0)
 L -^XMBPOST("POST_Tickler")
"RTN","XMTDT",18,0)
 I $D(ZTQUEUED) D PCLEAR^%ZTLOAD(ZTSK)
"RTN","XMTDT",19,0)
 Q
"RTN","XMTDT",20,0)
LATERNEW ; This routine takes care of 'new'ing messages which the user
"RTN","XMTDT",21,0)
 ; had previously 'later'ed for himself.
"RTN","XMTDT",22,0)
 N XMNOW,XMLATER,DIK,XMDUZ,XMZ,DA,XMZREC,XMINACT
"RTN","XMTDT",23,0)
 S XMNOW=$$NOW^XLFDT
"RTN","XMTDT",24,0)
 S XMLATER=0
"RTN","XMTDT",25,0)
 F  S XMLATER=$O(^XMB(3.73,"AB",XMLATER)) Q:XMLATER'>0!(XMLATER>XMNOW)  D
"RTN","XMTDT",26,0)
 . S DIK="^XMB(3.73,"
"RTN","XMTDT",27,0)
 . S XMDUZ=0
"RTN","XMTDT",28,0)
 . F  S XMDUZ=$O(^XMB(3.73,"AB",XMLATER,XMDUZ)) Q:'XMDUZ  D
"RTN","XMTDT",29,0)
 . . S XMINACT=$S($P($G(^VA(200,XMDUZ,0)),U,3)="":1,$P($G(^(.1)),U,2)="":1,$P($G(^(201)),U)="":1,1:0)  ; user is inactive if no access code, or verify code, or primary menu
"RTN","XMTDT",30,0)
 . . S XMZ=0
"RTN","XMTDT",31,0)
 . . F  S XMZ=$O(^XMB(3.73,"AB",XMLATER,XMDUZ,XMZ)) Q:'XMZ  D
"RTN","XMTDT",32,0)
 . . . S DA=$O(^XMB(3.73,"AB",XMLATER,XMDUZ,XMZ,0)) Q:'DA
"RTN","XMTDT",33,0)
 . . . I '$D(^XMB(3.73,DA,0)) D  Q  ; *** This should not be necessary
"RTN","XMTDT",34,0)
 . . . . K ^XMB(3.73,"AB",XMLATER,XMDUZ,XMZ,DA)
"RTN","XMTDT",35,0)
 . . . . K ^XMB(3.73,"AC",XMZ,XMDUZ,DA)
"RTN","XMTDT",36,0)
 . . . . K ^XMB(3.73,"C",XMDUZ,DA)
"RTN","XMTDT",37,0)
 . . . D ^DIK
"RTN","XMTDT",38,0)
 . . . Q:XMINACT
"RTN","XMTDT",39,0)
 . . . S XMZREC=$G(^XMB(3.9,XMZ,0)) Q:XMZREC=""
"RTN","XMTDT",40,0)
 . . . D RESURECT^XMXMSGS2(XMDUZ,XMZ)
"RTN","XMTDT",41,0)
 . . . D DELIVER^XMTDL2(XMDUZ,XMZ,$P(XMZREC,U,1),$P(XMZREC,U,2),0,1)
"RTN","XMTDT",42,0)
 Q
"RTN","XMTDT",43,0)
LATERFWD ; This routine takes care of forwarding messages which a user
"RTN","XMTDT",44,0)
 ; had previously scheduled for 'later' delivery to other users.
"RTN","XMTDT",45,0)
 N XMDUZ,XMNOW,XMLATER,DIK,XMIEN,XMZ,DA,XMREC,XMV,XMINSTR,XMTO,XMPRIVAT
"RTN","XMTDT",46,0)
 K XMERR,^TMP("XMERR",$J)
"RTN","XMTDT",47,0)
 S XMPRIVAT=$$EZBLD^DIALOG(39135) ; " [Private Mail Group]"
"RTN","XMTDT",48,0)
 S XMINSTR("FWD BY XMDUZ")=""
"RTN","XMTDT",49,0)
 S XMNOW=$$NOW^XLFDT
"RTN","XMTDT",50,0)
 S XMLATER=0
"RTN","XMTDT",51,0)
 F  S XMLATER=$O(^XMB(3.9,"AL",XMLATER)) Q:XMLATER'>0!(XMLATER>XMNOW)  D
"RTN","XMTDT",52,0)
 . S XMZ=0
"RTN","XMTDT",53,0)
 . F  S XMZ=$O(^XMB(3.9,"AL",XMLATER,XMZ)) Q:'XMZ  D
"RTN","XMTDT",54,0)
 . . S DA(1)=XMZ
"RTN","XMTDT",55,0)
 . . S DIK="^XMB(3.9,"_DA(1)_",7,"
"RTN","XMTDT",56,0)
 . . S XMIEN=0
"RTN","XMTDT",57,0)
 . . F  S XMIEN=$O(^XMB(3.9,"AL",XMLATER,XMZ,XMIEN)) Q:'XMIEN  D
"RTN","XMTDT",58,0)
 . . . S XMREC=$G(^XMB(3.9,XMZ,7,XMIEN,0))
"RTN","XMTDT",59,0)
 . . . I XMREC="" K ^XMB(3.9,"AL",XMLATER,XMZ,XMIEN) Q
"RTN","XMTDT",60,0)
 . . . S XMDUZ=$P(XMREC,U,3)
"RTN","XMTDT",61,0)
 . . . S XMTO=$P(XMREC,U,1)
"RTN","XMTDT",62,0)
 . . . I XMTO[XMPRIVAT S XMTO=$P(XMTO,XMPRIVAT,1) ; " [Private Mail Group]" (set in ^XMXADDRG)
"RTN","XMTDT",63,0)
 . . . I $P(XMREC,U,2)'="" S XMTO=$P(XMREC,U,2)_":"_XMTO
"RTN","XMTDT",64,0)
 . . . D INIT^XMXADDR
"RTN","XMTDT",65,0)
 . . . D CHKADDR^XMXADDR(XMDUZ,XMTO) K:$D(XMERR) XMERR,^TMP("XMERR",$J)
"RTN","XMTDT",66,0)
 . . . S XMINSTR("FWD BY")=$P(XMREC,U,4)
"RTN","XMTDT",67,0)
 . . . D:$D(^TMP("XMY",$J)) FWD^XMKP(XMDUZ,XMZ,.XMINSTR)
"RTN","XMTDT",68,0)
 . . . D CLEANUP^XMXADDR
"RTN","XMTDT",69,0)
 . . . S DA=XMIEN
"RTN","XMTDT",70,0)
 . . . D ^DIK
"RTN","XMTDT",71,0)
 Q
"RTN","XMTDT",72,0)
PURGEOLD ; This routine deletes msgs marked for automatic deletion,
"RTN","XMTDT",73,0)
 ; whether marked by the user, or marked by the 'in basket purge'
"RTN","XMTDT",74,0)
 ; because they hadn't been accessed for a certain number of days.
"RTN","XMTDT",75,0)
 ; Replaces ^XMAI0 (ISC-WASH/CAP/RJ)
"RTN","XMTDT",76,0)
 ; XMDDATE  Message delete date
"RTN","XMTDT",77,0)
 N XMDDATE,XMDUZ,XMK,XMZ,XMNOW
"RTN","XMTDT",78,0)
 S XMNOW=$$NOW^XLFDT
"RTN","XMTDT",79,0)
 S (XMDDATE,XMDUZ,XMK,XMZ)=""
"RTN","XMTDT",80,0)
 F  S XMDDATE=$O(^XMB(3.7,"AC",XMDDATE)) Q:XMDDATE=""!(XMDDATE>XMNOW)  D
"RTN","XMTDT",81,0)
 . F  S XMDUZ=$O(^XMB(3.7,"AC",XMDDATE,XMDUZ)) Q:XMDUZ=""  D
"RTN","XMTDT",82,0)
 . . F  S XMK=$O(^XMB(3.7,"AC",XMDDATE,XMDUZ,XMK)) Q:XMK=""  D
"RTN","XMTDT",83,0)
 . . . F  S XMZ=$O(^XMB(3.7,"AC",XMDDATE,XMDUZ,XMK,XMZ)) Q:XMZ=""  D
"RTN","XMTDT",84,0)
 . . . . I $D(^XMB(3.7,XMDUZ,2,XMK,1,XMZ,0)) D ZAPIT^XMXMSGS2(XMDUZ,XMK,XMZ) Q
"RTN","XMTDT",85,0)
 . . . . K ^XMB(3.7,"AC",XMDDATE,XMDUZ,XMK,XMZ)
"RTN","XMTDT",86,0)
 Q
"RTN","XMTDT",87,0)
FILTRFWD ; This routine forwards messages for a user when a filter
"RTN","XMTDT",88,0)
 ; with 'forward to' recipients has activated during message delivery.
"RTN","XMTDT",89,0)
 N XMDUZ,XMUPTR,XMZ,XMREC,XMV,XMINSTR,XMTO,XMPRIVAT,XMFIEN,XMFWDIEN
"RTN","XMTDT",90,0)
 S XMPRIVAT=$$EZBLD^DIALOG(39135) ; " [Private Mail Group]"
"RTN","XMTDT",91,0)
 S XMINSTR("FWD BY XMDUZ")="F"
"RTN","XMTDT",92,0)
 S XMFIEN=0
"RTN","XMTDT",93,0)
 F  S XMFIEN=$O(^XMB(3.9,"AF",XMFIEN)) Q:'XMFIEN  D
"RTN","XMTDT",94,0)
 . S XMZ=0
"RTN","XMTDT",95,0)
 . F  S XMZ=$O(^XMB(3.9,"AF",XMFIEN,XMZ)) Q:'XMZ  D
"RTN","XMTDT",96,0)
 . . S XMUPTR=0
"RTN","XMTDT",97,0)
 . . F  S XMUPTR=$O(^XMB(3.9,"AF",XMFIEN,XMZ,XMUPTR)) Q:'XMUPTR  D
"RTN","XMTDT",98,0)
 . . . S XMREC=$G(^XMB(3.9,XMZ,1,XMUPTR,0))
"RTN","XMTDT",99,0)
 . . . S XMDUZ=$P(XMREC,U,1)
"RTN","XMTDT",100,0)
 . . . I XMREC=""!'XMDUZ!($P(XMREC,U,13)'=XMFIEN) K ^XMB(3.9,"AF",XMFIEN,XMZ,XMUPTR) Q
"RTN","XMTDT",101,0)
 . . . S XMFWDIEN=0
"RTN","XMTDT",102,0)
 . . . D INIT^XMXADDR
"RTN","XMTDT",103,0)
 . . . F  S XMFWDIEN=$O(^XMB(3.7,XMDUZ,15,XMFIEN,1,XMFWDIEN)) Q:'XMFWDIEN  S XMREC=$G(^(XMFWDIEN,0)) D
"RTN","XMTDT",104,0)
 . . . . S XMTO=$P(XMREC,U,1) Q:XMTO=""
"RTN","XMTDT",105,0)
 . . . . N XMERROR,XMFULL,XMFWDADD
"RTN","XMTDT",106,0)
 . . . . I XMTO[XMPRIVAT S XMTO=$P(XMTO,XMPRIVAT,1) ; " [Private Mail Group]" (set in ^XMXADDRG)
"RTN","XMTDT",107,0)
 . . . . ;I $P(XMREC,U,2)'="" S XMTO=$P(XMREC,U,2)_":"_XMTO
"RTN","XMTDT",108,0)
 . . . . D ADDRESS^XMXADDR(XMDUZ,XMTO,.XMFULL,.XMERROR) Q:'$D(XMERROR)
"RTN","XMTDT",109,0)
 . . . . D DELFWDTO^XMTDF(XMDUZ,XMFIEN,XMFWDIEN,XMTO,$$GETERR^XMXADDR4)
"RTN","XMTDT",110,0)
 . . . S XMINSTR("FWD BY")=$$NAME^XMXUTIL(XMDUZ)
"RTN","XMTDT",111,0)
 . . . D:$D(^TMP("XMY",$J)) FWD^XMKP(XMDUZ,XMZ,.XMINSTR)
"RTN","XMTDT",112,0)
 . . . D CLEANUP^XMXADDR
"RTN","XMTDT",113,0)
 . . . N XMFDA
"RTN","XMTDT",114,0)
 . . . S XMFDA(3.91,XMUPTR_","_XMZ_",",15)=0 ; filter forward completed
"RTN","XMTDT",115,0)
 . . . D FILE^DIE("","XMFDA")
"RTN","XMTDT",116,0)
 Q
"RTN","XMVGROUP")
0^9^B60085081
"RTN","XMVGROUP",1,0)
XMVGROUP ;ISC-SF/GMB-Group creation/enrollment ;04/15/2003  12:50
"RTN","XMVGROUP",2,0)
 ;;8.0;MailMan;**18**;Jun 28, 2002
"RTN","XMVGROUP",3,0)
 ; Replaces JOIN, ENT^XMA7G & ^XMA7G1 (ISC-WASH/RJ/THM/CAP/JA)
"RTN","XMVGROUP",4,0)
 ; Entry points used by MailMan options (not covered by DBIA):
"RTN","XMVGROUP",5,0)
 ; EDITMG    XMEDITMG        - Mail Group Edit
"RTN","XMVGROUP",6,0)
 ; ENROLL    XMENROLL        - Enroll in / Disenroll from a group
"RTN","XMVGROUP",7,0)
 ; LCOORD    XMMGR-MAIL-GRP-COORDINATOR
"RTN","XMVGROUP",8,0)
 ; RCOORD    XMMGR-MAIL-GRP-COORD-W/REMOTES
"RTN","XMVGROUP",9,0)
 ; PERSONAL  XMEDITPERSGROUP - Edit user's personal group.
"RTN","XMVGROUP",10,0)
 ;
"RTN","XMVGROUP",11,0)
 ; DBIAs:
"RTN","XMVGROUP",12,0)
 ;   1544 - Use $$ISA^USRLM (Authorization/Subscription)
"RTN","XMVGROUP",13,0)
ENROLL ; Enroll in / Disenroll from a group
"RTN","XMVGROUP",14,0)
 N DIC,Y,XMABORT,XMIEN,XMSELF,XMIA
"RTN","XMVGROUP",15,0)
 S XMABORT=0
"RTN","XMVGROUP",16,0)
 S:'$D(XMDUZ) XMDUZ=DUZ
"RTN","XMVGROUP",17,0)
 S XMSELF=+$P($G(^XMB(1,1,2)),U,2) ; Is self-disenrollment allowed in a non-self enrolling mail group?
"RTN","XMVGROUP",18,0)
 F  D  Q:XMABORT
"RTN","XMVGROUP",19,0)
 . S DIC="^XMB(3.8,",DIC(0)="AEQMZ"
"RTN","XMVGROUP",20,0)
 . S DIC("S")="I $S($P(^(0),U,2)=""PU"":1,$D(^XMB(3.8,+Y,1,""B"",XMDUZ)):1,1:0)"
"RTN","XMVGROUP",21,0)
 . S DIC("W")="W:$D(^XMB(3.8,+Y,1,""B"",XMDUZ)) ?35,"""_$$EZBLD^DIALOG(38020)_""" I $P(^XMB(3.8,+Y,0),U,3)'=""y"" W ?43,"""_$$EZBLD^DIALOG(38021)_"""" ; Member / ...Self Enrollment Not Allowed.
"RTN","XMVGROUP",22,0)
 . W !
"RTN","XMVGROUP",23,0)
 . D ^DIC I Y<0 S XMABORT=1 Q
"RTN","XMVGROUP",24,0)
 . S XMIEN=+Y
"RTN","XMVGROUP",25,0)
 . I $D(^XMB(3.8,XMIEN,1,"B",XMDUZ)) D  Q
"RTN","XMVGROUP",26,0)
 . . I $P(^XMB(3.8,XMIEN,0),U,3)'="y",'XMSELF W !,$$EZBLD^DIALOG(38022.1) Q  ;Self enrollment is not allowed for this mail group.
"RTN","XMVGROUP",27,0)
 . . D DROP(XMIEN,XMDUZ)
"RTN","XMVGROUP",28,0)
 . I $P(^XMB(3.8,XMIEN,0),U,3)'="y" W !,$$EZBLD^DIALOG(38022) Q  ;Self enrollment is not allowed for this mail group.
"RTN","XMVGROUP",29,0)
 . D JOIN(XMIEN,XMDUZ)
"RTN","XMVGROUP",30,0)
 Q
"RTN","XMVGROUP",31,0)
JOIN(XMIEN,XMDUZ) ; Enroll in a group
"RTN","XMVGROUP",32,0)
 N XMFDA
"RTN","XMVGROUP",33,0)
 S XMFDA(3.81,"+1,"_XMIEN_",",.01)=XMDUZ
"RTN","XMVGROUP",34,0)
 D UPDATE^DIE("","XMFDA")
"RTN","XMVGROUP",35,0)
 W !,$$EZBLD^DIALOG(38023) ;You are now a member.
"RTN","XMVGROUP",36,0)
 N DIR,X,Y
"RTN","XMVGROUP",37,0)
 S DIR(0)="Y"
"RTN","XMVGROUP",38,0)
 ; Do you want past messages to this group to be forwarded to you?
"RTN","XMVGROUP",39,0)
 D BLD^DIALOG(38023.1,"","","DIR(""A"")")
"RTN","XMVGROUP",40,0)
 S DIR("B")=$$EZBLD^DIALOG(39053) ; no
"RTN","XMVGROUP",41,0)
 D BLD^DIALOG(38232,"","","DIR(""?"")")
"RTN","XMVGROUP",42,0)
 ;Answer YES to forward past mail group messages.
"RTN","XMVGROUP",43,0)
 ;You will be asked for a time frame to search,
"RTN","XMVGROUP",44,0)
 ;and then MailMan will create a task to find and forward
"RTN","XMVGROUP",45,0)
 ;existing mail group messages.
"RTN","XMVGROUP",46,0)
 D ^DIR Q:$D(DIRUT)!'Y
"RTN","XMVGROUP",47,0)
 N XMINSTR,XMTSK,XMABORT
"RTN","XMVGROUP",48,0)
 I '$D(XMV) N XMV,XMDISPI,XMDUN,XMNOSEND,XMPRIV D INITAPI^XMVVITAE
"RTN","XMVGROUP",49,0)
 S XMABORT=0,XMINSTR("FLAGS")="F"
"RTN","XMVGROUP",50,0)
 D FWDBSKT(XMDUZ,.XMINSTR,.XMABORT) Q:XMABORT
"RTN","XMVGROUP",51,0)
 D FWDDATES^XMVGRP(XMDUZ,.XMINSTR,.XMABORT) Q:XMABORT
"RTN","XMVGROUP",52,0)
 D FAFMSGS^XMXGRP1(XMDUZ,$P($G(^XMB(3.8,XMIEN,0)),U,1),XMDUZ,.XMINSTR,.XMTSK)
"RTN","XMVGROUP",53,0)
 D FWDTSK(XMTSK)
"RTN","XMVGROUP",54,0)
 Q
"RTN","XMVGROUP",55,0)
FWDBSKT(XMDUZ,XMINSTR,XMABORT) ; Select basket to forward to
"RTN","XMVGROUP",56,0)
 N XMDIC,XMK
"RTN","XMVGROUP",57,0)
 S XMDIC("B")=$$EZBLD^DIALOG(37005) ;IN
"RTN","XMVGROUP",58,0)
 D SELBSKT^XMJBU(XMDUZ,39022,"L",.XMDIC,.XMK) I XMK=U S XMABORT=1 Q
"RTN","XMVGROUP",59,0)
 S XMINSTR("SELF BSKT")=XMK
"RTN","XMVGROUP",60,0)
 Q
"RTN","XMVGROUP",61,0)
FWDTSK(XMTSK) ;
"RTN","XMVGROUP",62,0)
 W !
"RTN","XMVGROUP",63,0)
 ;Task #|1| will find and forward past messages.
"RTN","XMVGROUP",64,0)
 N XMTEXT
"RTN","XMVGROUP",65,0)
 D BLD^DIALOG(38023.9,XMTSK,"","XMTEXT","F")
"RTN","XMVGROUP",66,0)
 D MSG^DIALOG("WM","",IOM,"","XMTEXT")
"RTN","XMVGROUP",67,0)
 Q
"RTN","XMVGROUP",68,0)
DROP(XMIEN,XMDUZ) ; Disenroll from a group
"RTN","XMVGROUP",69,0)
 N DIR,X,Y
"RTN","XMVGROUP",70,0)
 S DIR(0)="Y"
"RTN","XMVGROUP",71,0)
 I $P(^XMB(3.8,XMIEN,0),U,3)'="y" D
"RTN","XMVGROUP",72,0)
 . ;You're a member. Self enrollment is not allowed for this mail group.
"RTN","XMVGROUP",73,0)
 . ;If you drop out, you will not be able to re-join. (To re-join later,
"RTN","XMVGROUP",74,0)
 . ;you will have to ask the group coordinator to re-enroll you.)
"RTN","XMVGROUP",75,0)
 . ;You are a member.  Do you want to drop out
"RTN","XMVGROUP",76,0)
 . D BLD^DIALOG(38024.1,"","","DIR(""A"")")
"RTN","XMVGROUP",77,0)
 E  D  ;You are a member.  Do you want to drop out
"RTN","XMVGROUP",78,0)
 . S DIR("A")=$$EZBLD^DIALOG(38024)
"RTN","XMVGROUP",79,0)
 S DIR("B")=$$EZBLD^DIALOG(39053) ;No
"RTN","XMVGROUP",80,0)
 ;Enter YES to remove yourself from the group; NO to remain a member.
"RTN","XMVGROUP",81,0)
 D BLD^DIALOG(38025,"","","DIR(""?"")")
"RTN","XMVGROUP",82,0)
 D ^DIR Q:$D(DIRUT)!'Y
"RTN","XMVGROUP",83,0)
 K DIR,X,Y
"RTN","XMVGROUP",84,0)
 N DA,DIK
"RTN","XMVGROUP",85,0)
 S DA(1)=XMIEN,DA=$O(^XMB(3.8,XMIEN,1,"B",XMDUZ,0)),DIK="^XMB(3.8,"_XMIEN_",1,"
"RTN","XMVGROUP",86,0)
 D ^DIK
"RTN","XMVGROUP",87,0)
 W !,$$EZBLD^DIALOG(38026) ;You are no longer a member.
"RTN","XMVGROUP",88,0)
 Q
"RTN","XMVGROUP",89,0)
PERSONAL ; Enter/Edit Personal Group
"RTN","XMVGROUP",90,0)
 ; See entry EDIT for info on XMIA & XMTRKNEW
"RTN","XMVGROUP",91,0)
 N DIC,DLAYGO,X,Y,XMABORT,XMIA,XMTRKNEW
"RTN","XMVGROUP",92,0)
 S XMABORT=0,(XMIA,XMTRKNEW)=1
"RTN","XMVGROUP",93,0)
 S DIC="^XMB(3.8,",DIC(0)="AEQMZL",DLAYGO=3.8
"RTN","XMVGROUP",94,0)
 ; Group is private, and user is organizer
"RTN","XMVGROUP",95,0)
 S DIC("S")="I $P(^(0),U,2)=""PR"",$P($G(^XMB(3.8,+Y,3)),U)=$G(XMDUZ,DUZ)"
"RTN","XMVGROUP",96,0)
 F  D  Q:XMABORT
"RTN","XMVGROUP",97,0)
 . W !
"RTN","XMVGROUP",98,0)
 . D ^DIC I Y<0 S XMABORT=1 Q
"RTN","XMVGROUP",99,0)
 . N XMDR,XMNEW
"RTN","XMVGROUP",100,0)
 . S XMNEW=$P(Y,U,3)
"RTN","XMVGROUP",101,0)
 . S:XMNEW XMDR="4////PR;5////"_$G(XMDUZ,DUZ)_";10////1;"
"RTN","XMVGROUP",102,0)
 . S XMDR=$G(XMDR)_".01T;2;3" ; name, members, description
"RTN","XMVGROUP",103,0)
 . S XMDR=XMDR_";10;12" ; restrictions, remote members
"RTN","XMVGROUP",104,0)
 . D EDIT(+Y,XMDR,XMNEW)
"RTN","XMVGROUP",105,0)
 Q
"RTN","XMVGROUP",106,0)
EDIT(XMG,DR,XMNEW) ; Edit mail group
"RTN","XMVGROUP",107,0)
 ; XMIA is used for interaction on the REMOTE MEMBER input transform
"RTN","XMVGROUP",108,0)
 ; to facilitate lookup.  XMTRKNEW is used by the AC xref on the
"RTN","XMVGROUP",109,0)
 ; .01 field of the LOCAL MEMBER multiple.  If local members are added
"RTN","XMVGROUP",110,0)
 ; to the group, XMNEWMBR is set by the AC xref.
"RTN","XMVGROUP",111,0)
 N DIE,DIDEL,Y,DIC,DA,XMNEWMBR
"RTN","XMVGROUP",112,0)
 S (DIDEL,DIE)=3.8,DA=XMG
"RTN","XMVGROUP",113,0)
 S:$P(^XMB(1,1,0),U,19) DR=DR_";14;15" ; fax recipients, fax groups
"RTN","XMVGROUP",114,0)
 D ^DIE
"RTN","XMVGROUP",115,0)
 I 'XMNEW,$D(XMNEWMBR) D FWD(XMG,.XMNEWMBR)
"RTN","XMVGROUP",116,0)
 Q
"RTN","XMVGROUP",117,0)
FWD(XMG,XMTO) ; Forward past mail group messages to new local members
"RTN","XMVGROUP",118,0)
 N XMI
"RTN","XMVGROUP",119,0)
 S XMI=""
"RTN","XMVGROUP",120,0)
 F  S XMI=$O(XMTO(XMI)) Q:'XMI  K:'$D(^XMB(3.8,XMG,1,"B",XMI)) XMTO(XMI)
"RTN","XMVGROUP",121,0)
 Q:'$D(XMTO)
"RTN","XMVGROUP",122,0)
 I '$D(XMV) N XMV,XMDISPI,XMDUN,XMNOSEND,XMPRIV D INITAPI^XMVVITAE
"RTN","XMVGROUP",123,0)
 D NOTIFY^XMXGRP1(XMG,.XMTO)
"RTN","XMVGROUP",124,0)
 N XMINSTR,XMTSK,XMABORT
"RTN","XMVGROUP",125,0)
 S XMABORT=0
"RTN","XMVGROUP",126,0)
 D ENFWD^XMVGRP(XMDUZ,.XMINSTR,.XMABORT) Q:XMABORT
"RTN","XMVGROUP",127,0)
 D FAFMSGS^XMXGRP1(XMDUZ,$P(^XMB(3.8,XMG,0),U,1),.XMTO,.XMINSTR,.XMTSK)
"RTN","XMVGROUP",128,0)
 D FWDTSK(XMTSK)
"RTN","XMVGROUP",129,0)
 Q
"RTN","XMVGROUP",130,0)
LAYGO(X) ; Prevent someone from adding a (private) group with the same name as a public one.
"RTN","XMVGROUP",131,0)
 ; This function is invoked by the LAYGO field of ^XMB(3.8,.01)
"RTN","XMVGROUP",132,0)
 ; Returns 1 if group X may be created; 0 if not.
"RTN","XMVGROUP",133,0)
 N IEN,LAYGO
"RTN","XMVGROUP",134,0)
 S IEN="",LAYGO=1
"RTN","XMVGROUP",135,0)
 F  S IEN=$O(^XMB(3.8,"B",X,IEN)) Q:IEN=""  D  Q:'LAYGO
"RTN","XMVGROUP",136,0)
 . Q:$P(^XMB(3.8,IEN,0),U,2)="PR"
"RTN","XMVGROUP",137,0)
 . S LAYGO=0 ;Can't add it because public group '|1|' already exists.
"RTN","XMVGROUP",138,0)
 . D EN^DDIOL($$EZBLD^DIALOG(38027,X),"","!,$C(7)")
"RTN","XMVGROUP",139,0)
 Q LAYGO
"RTN","XMVGROUP",140,0)
REMOTE(XMADDR,XMIA) ; Serves as input transform for 'remote member'
"RTN","XMVGROUP",141,0)
 ; Allow remote addressees or local devices or local servers
"RTN","XMVGROUP",142,0)
 N XMERROR,XMRESTR,XMINSTR,XMFULL,XMPREFIX,DIX,DO,XMFWDADD
"RTN","XMVGROUP",143,0)
 S XMINSTR("ADDR FLAGS")="X" ; do not create ^TMP(, just check.
"RTN","XMVGROUP",144,0)
 I XMADDR[":" D  Q:'$D(XMADDR)
"RTN","XMVGROUP",145,0)
 . D RTYPE^XMXADDR($P(XMADDR,":")) I $D(XMERROR) K XMADDR Q
"RTN","XMVGROUP",146,0)
 . D PREFIX^XMXADDR(.XMADDR,.XMPREFIX) I $D(XMERROR) K XMADDR Q
"RTN","XMVGROUP",147,0)
 I XMADDR'["@",".D.d.H.h.S.s."'[("."_$E(XMADDR,1,2)),'$D(XMPREFIX) K XMADDR Q
"RTN","XMVGROUP",148,0)
 D ADDRESS^XMXADDR(DUZ,XMADDR,.XMFULL,.XMERROR)
"RTN","XMVGROUP",149,0)
 I $D(XMERROR) K XMADDR Q
"RTN","XMVGROUP",150,0)
 I XMFULL'["@" D
"RTN","XMVGROUP",151,0)
 . I ".D.H.S."[("."_$E(XMFULL,1,2)) S XMFULL=XMFULL_"@"_^XMB("NETNAME") Q
"RTN","XMVGROUP",152,0)
 . ;I $G(XMPREFIX)'="" S XMFULL=XMFULL_"@"_^XMB("NETNAME") Q
"RTN","XMVGROUP",153,0)
 I XMFULL'["@" D  Q
"RTN","XMVGROUP",154,0)
 . K XMADDR
"RTN","XMVGROUP",155,0)
 . D EN^DDIOL($$EZBLD^DIALOG(38028)) ;It can't be a local address, except for Device or Server.
"RTN","XMVGROUP",156,0)
 . I $E(XMFULL,1,2)="G." D EN^DDIOL($$EZBLD^DIALOG(38029)) ;Put the group in the MEMBER GROUP multiple.
"RTN","XMVGROUP",157,0)
 . E  D EN^DDIOL($$EZBLD^DIALOG(38030)) ;Put the person in the MEMBER multiple.
"RTN","XMVGROUP",158,0)
 . I $G(XMPREFIX)'="" D EN^DDIOL($$EZBLD^DIALOG(38031,XMPREFIX)) ;Put '|1|' in the TYPE field.
"RTN","XMVGROUP",159,0)
 I $G(XMPREFIX)'="" S XMFULL=XMPREFIX_":"_XMFULL
"RTN","XMVGROUP",160,0)
 S XMADDR=XMFULL
"RTN","XMVGROUP",161,0)
 Q
"RTN","XMVGROUP",162,0)
EDITMG ; Mail Group Edit
"RTN","XMVGROUP",163,0)
 ; See entry EDIT for info on XMIA & XMTRKNEW
"RTN","XMVGROUP",164,0)
 N DIC,XMABORT,DLAYGO,X,Y,XMIA,XMTRKNEW,XMREC
"RTN","XMVGROUP",165,0)
 S XMABORT=0,(XMIA,XMTRKNEW)=1,DLAYGO=3.8
"RTN","XMVGROUP",166,0)
 S DIC(0)="AEQLM",DIC="^XMB(3.8,"
"RTN","XMVGROUP",167,0)
 S DIC("S")=$$GRPSCR(0)
"RTN","XMVGROUP",168,0)
 F  D  Q:XMABORT
"RTN","XMVGROUP",169,0)
 . W !
"RTN","XMVGROUP",170,0)
 . D ^DIC I Y<0 S XMABORT=1 Q
"RTN","XMVGROUP",171,0)
 . N XMDR
"RTN","XMVGROUP",172,0)
 . S XMDR=".01T;2;3" ; name, members, description
"RTN","XMVGROUP",173,0)
 . ; type - if type is public, ask about self enrollment,
"RTN","XMVGROUP",174,0)
 . ;        else ask about restrictions.
"RTN","XMVGROUP",175,0)
 . S XMDR=XMDR_";4;I X=""PU"" S Y=7;10;S Y=5;7"
"RTN","XMVGROUP",176,0)
 . S XMDR=XMDR_";5:6.9" ; organizer, coordinator, authorized senders
"RTN","XMVGROUP",177,0)
 . S XMDR=XMDR_";10.1:13.9" ; member groups, remote members, distr list
"RTN","XMVGROUP",178,0)
 . D EDIT(+Y,XMDR,$P(Y,U,3))
"RTN","XMVGROUP",179,0)
 Q
"RTN","XMVGROUP",180,0)
GRPSCR(XMCOORD) ; Who may edit a mail group?
"RTN","XMVGROUP",181,0)
 N XMSCR,XMOK
"RTN","XMVGROUP",182,0)
 S XMOK=0
"RTN","XMVGROUP",183,0)
 I $T(ISA^USRLM)'="" S XMOK=$$ISA^USRLM(DUZ,"CLINICAL COORDINATOR")
"RTN","XMVGROUP",184,0)
 I $D(^XUSEC("XMMGR",DUZ))!$D(^XUSEC("XM GROUP EDIT MASTER",DUZ))!XMOK D
"RTN","XMVGROUP",185,0)
 . ; Screen whether group is public or (private and) unrestricted
"RTN","XMVGROUP",186,0)
 . S XMSCR="N XMREC S XMREC=^(0) I $P(XMREC,U,2)=""PU""!'$P(XMREC,U,6)!"
"RTN","XMVGROUP",187,0)
 E  S XMSCR="I " ; Or, at the very minimum,
"RTN","XMVGROUP",188,0)
 ; Screen whether user is organizer or coordinator.
"RTN","XMVGROUP",189,0)
 Q XMSCR_"($P($G(^XMB(3.8,+Y,3)),U,1)=$G(XMDUZ,DUZ))"_$S($G(XMCOORD):"!$D(^XMB(3.8,""AC"",$G(XMDUZ,DUZ),+Y))",1:"")
"RTN","XMVGROUP",190,0)
 ;
"RTN","XMVGROUP",191,0)
LCOORD ; Mail Group Coordinator edit w/o remote members
"RTN","XMVGROUP",192,0)
 D COORD(0)
"RTN","XMVGROUP",193,0)
 Q
"RTN","XMVGROUP",194,0)
RCOORD ; Mail Group Coordinator edit w/remote members
"RTN","XMVGROUP",195,0)
 D COORD(1)
"RTN","XMVGROUP",196,0)
 Q
"RTN","XMVGROUP",197,0)
COORD(XMREMOTE) ;
"RTN","XMVGROUP",198,0)
 ; See entry EDIT for info on XMIA & XMTRKNEW
"RTN","XMVGROUP",199,0)
 N DIC,XMABORT,DLAYGO,X,Y,XMIA,XMTRKNEW
"RTN","XMVGROUP",200,0)
 S XMABORT=0,(XMIA,XMTRKNEW)=1
"RTN","XMVGROUP",201,0)
 S DIC(0)="AEQM",DIC="^XMB(3.8,"
"RTN","XMVGROUP",202,0)
 S DIC("S")=$$GRPSCR(1)
"RTN","XMVGROUP",203,0)
 F  D  Q:XMABORT
"RTN","XMVGROUP",204,0)
 . W !
"RTN","XMVGROUP",205,0)
 . D ^DIC I Y<0 S XMABORT=1 Q
"RTN","XMVGROUP",206,0)
 . ; edit local members, member groups, & perhaps, remote members
"RTN","XMVGROUP",207,0)
 . D EDIT(+Y,"2;11"_$S(XMREMOTE:";12",1:""),0)
"RTN","XMVGROUP",208,0)
 Q
"RTN","XMVVITA")
0^1^B37353323
"RTN","XMVVITA",1,0)
XMVVITA ;ISC-SF/GMB-Edit User's MailMan Variables ;04/29/2003  07:49
"RTN","XMVVITA",2,0)
 ;;8.0;MailMan;**18**;Jun 28, 2002
"RTN","XMVVITA",3,0)
 ; Replaces ^XMGAPI1,FWD^XMA21FWD,BANNER^XMA6,EDIT^XMA7 (ISC-WASH/CAP)
"RTN","XMVVITA",4,0)
 ;
"RTN","XMVVITA",5,0)
 ; Entry points used by MailMan options (not covered by DBIA):
"RTN","XMVVITA",6,0)
 ; BANNER   XMBANNER       - Edit user's banner
"RTN","XMVVITA",7,0)
 ; EDIT     XMEDITUSER     - Edit user's preferences
"RTN","XMVVITA",8,0)
 ; FILTER   XM FILTER EDIT - Edit user's message filters
"RTN","XMVVITA",9,0)
 ; BASKET   XM DELIVERY BASKET EDIT - Edit user's delivery basket preferences
"RTN","XMVVITA",10,0)
 ; FORWARD  XMEDITFWD      - Edit user's forwarding address
"RTN","XMVVITA",11,0)
 ; SURR     XMEDITSURR     - Edit user's surrogates
"RTN","XMVVITA",12,0)
FORWARD ; Edit forwarding address
"RTN","XMVVITA",13,0)
 N XMIA
"RTN","XMVVITA",14,0)
 S XMIA=1
"RTN","XMVVITA",15,0)
 N DIE,DA,DR
"RTN","XMVVITA",16,0)
 S DIE=3.7
"RTN","XMVVITA",17,0)
 S DA=DUZ
"RTN","XMVVITA",18,0)
 S DR="2;2.1"
"RTN","XMVVITA",19,0)
 D ^DIE
"RTN","XMVVITA",20,0)
 Q
"RTN","XMVVITA",21,0)
XMFWD(XMADDR,XMIA) ; Serves as input transform for 'forwarding address'
"RTN","XMVVITA",22,0)
 N XMERROR,XMRESTR,XMINSTR,XMFULL,XMFWDADD
"RTN","XMVVITA",23,0)
 I XMADDR'["@",".D.d.H.h.S.s."'[("."_$E(XMADDR,1,2)) K XMADDR Q
"RTN","XMVVITA",24,0)
 S XMINSTR("ADDR FLAGS")="X" ; do not create ^TMP(, just check.
"RTN","XMVVITA",25,0)
 S XMFWDADD=DUZ ; editing forwarding address
"RTN","XMVVITA",26,0)
 D ADDRESS^XMXADDR(DUZ,XMADDR,.XMFULL,.XMERROR)
"RTN","XMVVITA",27,0)
 I $D(XMERROR) K XMADDR Q
"RTN","XMVVITA",28,0)
 I XMFULL'["@" D
"RTN","XMVVITA",29,0)
 . ; Remote address is really local.  OK if device or server.
"RTN","XMVVITA",30,0)
 . I ".D.H.S."[("."_$E(XMFULL,1,2)) S XMFULL=XMFULL_"@"_^XMB("NETNAME")
"RTN","XMVVITA",31,0)
 I XMFULL'["@" D  Q
"RTN","XMVVITA",32,0)
 . ; Remote address is really local
"RTN","XMVVITA",33,0)
 . K XMADDR
"RTN","XMVVITA",34,0)
 . D EN^DDIOL($$EZBLD^DIALOG(38130)) ; You can't have your mail forwarded to a local address.
"RTN","XMVVITA",35,0)
 S XMADDR=XMFULL
"RTN","XMVVITA",36,0)
 Q
"RTN","XMVVITA",37,0)
DELFWD(XMUSER,XMFWD,XMERROR) ; Delete a user's invalid forwarding address.
"RTN","XMVVITA",38,0)
 S XMFDA(3.7,XMUSER_",",2)="@"
"RTN","XMVVITA",39,0)
 D FILE^DIE("","XMFDA")
"RTN","XMVVITA",40,0)
 N XMPARM,XMINSTR,XMTEXT,XMAPPEND
"RTN","XMVVITA",41,0)
 S XMINSTR("FROM")=.5
"RTN","XMVVITA",42,0)
 S XMPARM(1)=XMFWD
"RTN","XMVVITA",43,0)
 I +XMERROR=XMERROR D
"RTN","XMVVITA",44,0)
 . D BLD^DIALOG(XMERROR,.XMERROR,"","XMTEXT","F")
"RTN","XMVVITA",45,0)
 . D MSG^DIALOG("AE",.XMAPPEND,"","","XMTEXT")
"RTN","XMVVITA",46,0)
 E  D
"RTN","XMVVITA",47,0)
 . S XMPARM(2)=XMERROR
"RTN","XMVVITA",48,0)
 . S XMAPPEND=""
"RTN","XMVVITA",49,0)
 D TASKBULL^XMXBULL(.5,"XM FWD ADDRESS DELETE",.XMPARM,"XMAPPEND",XMUSER,.XMINSTR)
"RTN","XMVVITA",50,0)
 Q
"RTN","XMVVITA",51,0)
BANNER ; Edit banner
"RTN","XMVVITA",52,0)
 N DIE,DA,DR
"RTN","XMVVITA",53,0)
 S DIE=3.7
"RTN","XMVVITA",54,0)
 S (XMDUZ,DA)=$G(XMDUZ,DUZ)
"RTN","XMVVITA",55,0)
 S DR=4
"RTN","XMVVITA",56,0)
 D ^DIE
"RTN","XMVVITA",57,0)
 D SETBAN^XMVVITAE(XMDUZ,.XMV)
"RTN","XMVVITA",58,0)
 Q
"RTN","XMVVITA",59,0)
FILTER ; Edit filters
"RTN","XMVVITA",60,0)
 N DIE,DA,DR,XMIA
"RTN","XMVVITA",61,0)
 S XMIA=1
"RTN","XMVVITA",62,0)
 S DIE=3.7
"RTN","XMVVITA",63,0)
 S DA=DUZ
"RTN","XMVVITA",64,0)
 S DR="16;15"     ; Message filters flag ; Message filters
"RTN","XMVVITA",65,0)
 D ^DIE
"RTN","XMVVITA",66,0)
 Q:$D(^XMB(3.7,DUZ,15,"AF"))
"RTN","XMVVITA",67,0)
 W !!,$C(7),$$EZBLD^DIALOG(38131) ; Note that you have no active filters.
"RTN","XMVVITA",68,0)
 Q
"RTN","XMVVITA",69,0)
BASKET ; Edit delivery baskets
"RTN","XMVVITA",70,0)
 N DIE,DA,DR
"RTN","XMVVITA",71,0)
 S DIE=3.7
"RTN","XMVVITA",72,0)
 S DA=DUZ
"RTN","XMVVITA",73,0)
 S DR="16.2;S:X'=""S"" Y=0;1"     ; Accept delivery basket? ; Select basket.
"RTN","XMVVITA",74,0)
 S DR(2,3.701)="3" ; Is this a delivery basket?
"RTN","XMVVITA",75,0)
 D ^DIE
"RTN","XMVVITA",76,0)
 Q
"RTN","XMVVITA",77,0)
SURR ; Edit Surrogates
"RTN","XMVVITA",78,0)
 N DIE,DA,DR
"RTN","XMVVITA",79,0)
 S DIE="^XMB(3.7,"
"RTN","XMVVITA",80,0)
 S DA=DUZ
"RTN","XMVVITA",81,0)
 S DR="8"         ; surrogate
"RTN","XMVVITA",82,0)
 D ^DIE
"RTN","XMVVITA",83,0)
 Q
"RTN","XMVVITA",84,0)
EDIT ; Edit User Preferences
"RTN","XMVVITA",85,0)
 N DIE,DA,DR
"RTN","XMVVITA",86,0)
 D CHECK^XMVVITAE
"RTN","XMVVITA",87,0)
 W !!,$$EZBLD^DIALOG(38132,$$GET1^DID(3.7,"","","NAME")) ; Editing data in the MAILBOX file:
"RTN","XMVVITA",88,0)
 S DIE="^XMB(3.7,"
"RTN","XMVVITA",89,0)
 S DA=DUZ
"RTN","XMVVITA",90,0)
 S DR=""
"RTN","XMVVITA",91,0)
 S DR=DR_";4"         ; banner
"RTN","XMVVITA",92,0)
 S DR=DR_";17"        ; message display order
"RTN","XMVVITA",93,0)
 S DR=DR_";21"        ; new message read order
"RTN","XMVVITA",94,0)
 S DR=DR_";18"        ; message reader default
"RTN","XMVVITA",95,0)
 S DR=DR_";19"        ; message reader prompt
"RTN","XMVVITA",96,0)
 S DR=DR_";20"        ; new messages default option
"RTN","XMVVITA",97,0)
 S DR=DR_";6"         ; show message preview
"RTN","XMVVITA",98,0)
 S DR=DR_";11"        ; message action default
"RTN","XMVVITA",99,0)
 S DR=DR_";12"        ; ask basket
"RTN","XMVVITA",100,0)
 S DR=DR_";13"        ; show titles
"RTN","XMVVITA",101,0)
 S DR=DR_";14"        ; priority responses flag
"RTN","XMVVITA",102,0)
 S DR=DR_";14.1"      ; priority responses prompt
"RTN","XMVVITA",103,0)
 S DR=DR_";16.3"      ; p-message queued from
"RTN","XMVVITA",104,0)
 S DR=DR_";9"         ; mailman institution
"RTN","XMVVITA",105,0)
 S DR=DR_";2.21:2.23" ; network signature lines
"RTN","XMVVITA",106,0)
 S DR=DR_";4.5"       ; introduction
"RTN","XMVVITA",107,0)
 S DR=$E(DR,2,99)
"RTN","XMVVITA",108,0)
 D ^DIE
"RTN","XMVVITA",109,0)
 D NEWORDER
"RTN","XMVVITA",110,0)
 W !!,$$EZBLD^DIALOG(38132,$$GET1^DID(200,"","","NAME")) ; Editing data in the NEW PERSON file:
"RTN","XMVVITA",111,0)
 S DIE="^VA(200,"
"RTN","XMVVITA",112,0)
 S DA=DUZ
"RTN","XMVVITA",113,0)
 S DR=""
"RTN","XMVVITA",114,0)
 S DR=DR_";31.3"      ; preferred editor
"RTN","XMVVITA",115,0)
 S DR=DR_";.111"      ; street address 1
"RTN","XMVVITA",116,0)
 S DR=DR_";.112"      ; street address 2
"RTN","XMVVITA",117,0)
 S DR=DR_";.113"      ; street address 3
"RTN","XMVVITA",118,0)
 S DR=DR_";.114"      ; city
"RTN","XMVVITA",119,0)
 S DR=DR_";.115"      ; state
"RTN","XMVVITA",120,0)
 S DR=DR_";.116"      ; zip
"RTN","XMVVITA",121,0)
 S DR=DR_";.132"      ; office phone
"RTN","XMVVITA",122,0)
 S DR=DR_";.136"      ; fax #
"RTN","XMVVITA",123,0)
 S DR=DR_";.137"      ; voice pager
"RTN","XMVVITA",124,0)
 S DR=DR_";.138"      ; digital pager
"RTN","XMVVITA",125,0)
 S DR=DR_";.133"_$$EZBLD^DIALOG(38133,1) ; ADD'L PHONE 1  phone #3
"RTN","XMVVITA",126,0)
 S DR=DR_";.134"_$$EZBLD^DIALOG(38133,2) ; ADD'L PHONE 2  phone #4
"RTN","XMVVITA",127,0)
 S DR=$E(DR,2,99)
"RTN","XMVVITA",128,0)
 D ^DIE
"RTN","XMVVITA",129,0)
 D PREFER^XMVVITAE(DUZ,.XMV,.XMDISPI)
"RTN","XMVVITA",130,0)
 D SETBAN^XMVVITAE(XMDUZ,.XMV)
"RTN","XMVVITA",131,0)
 D SETNET^XMVVITAE(XMDUZ,.XMV)
"RTN","XMVVITA",132,0)
 Q
"RTN","XMVVITA",133,0)
NEWORDER ;
"RTN","XMVVITA",134,0)
 N XMDIC,XMK
"RTN","XMVVITA",135,0)
 I $D(^XMB(3.7,DUZ,2,"AP")) D
"RTN","XMVVITA",136,0)
 . N I,XMKN,XMTEXT
"RTN","XMVVITA",137,0)
 . W !
"RTN","XMVVITA",138,0)
 . ;Current priority order for reading baskets with new messages:
"RTN","XMVVITA",139,0)
 . D BLD^DIALOG(38140,"","","XMTEXT","F")
"RTN","XMVVITA",140,0)
 . D MSG^DIALOG("WM","","","","XMTEXT")
"RTN","XMVVITA",141,0)
 . S (I,XMK)=0
"RTN","XMVVITA",142,0)
 . F  S I=$O(^XMB(3.7,DUZ,2,"AP",I)) Q:'I  D
"RTN","XMVVITA",143,0)
 . . F  S XMK=$O(^XMB(3.7,DUZ,2,"AP",I,XMK)) Q:'XMK  D
"RTN","XMVVITA",144,0)
 . . . S ^TMP("XM",$J,"AP",I,$$BSKTNAME^XMXUTIL(DUZ,XMK))=""
"RTN","XMVVITA",145,0)
 . S I=0,XMKN=""
"RTN","XMVVITA",146,0)
 . F  S I=$O(^TMP("XM",$J,"AP",I)) Q:'I  D
"RTN","XMVVITA",147,0)
 . . F  S XMKN=$O(^TMP("XM",$J,"AP",I,XMKN)) Q:XMKN=""  D
"RTN","XMVVITA",148,0)
 . . . W !,$J(I,4),?8,XMKN
"RTN","XMVVITA",149,0)
 . K ^TMP("XM",$J,"AP")
"RTN","XMVVITA",150,0)
 W !
"RTN","XMVVITA",151,0)
 ;Editing the priority order for reading baskets with new messages.
"RTN","XMVVITA",152,0)
 ;Note:  You don't need priority ordering unless you want to change the
"RTN","XMVVITA",153,0)
 ;default 'read new messages' basket from IN to other basket(s).
"RTN","XMVVITA",154,0)
 D BLD^DIALOG(38141,"","","XMTEXT","F")
"RTN","XMVVITA",155,0)
 D MSG^DIALOG("WM","","","","XMTEXT")
"RTN","XMVVITA",156,0)
 F  D  Q:XMK=U
"RTN","XMVVITA",157,0)
 . S XMDIC("B")="@" ; no default basket
"RTN","XMVVITA",158,0)
 . S XMDIC("S")="I Y>1" ; can't select IN or WASTE baskets
"RTN","XMVVITA",159,0)
 . S XMDIC("W")="W ?40,$P(^(0),U,4)"
"RTN","XMVVITA",160,0)
 . W !
"RTN","XMVVITA",161,0)
 . D SELBSKT^XMJBU(DUZ,"","",.XMDIC,.XMK) Q:XMK=U
"RTN","XMVVITA",162,0)
 . N DA,DR,DIE
"RTN","XMVVITA",163,0)
 . S DIE="^XMB(3.7,"_DUZ_",2,"
"RTN","XMVVITA",164,0)
 . S DA(1)=DUZ,DA=XMK
"RTN","XMVVITA",165,0)
 . S DR="4T"    ; Read new messages basket priority
"RTN","XMVVITA",166,0)
 . D ^DIE
"RTN","XMVVITA",167,0)
 Q
"RTN","XMVVITA",168,0)
GOTNS(XMDUZ) ; Function: Does the user have a network signature? (1=yes; 0=no)
"RTN","XMVVITA",169,0)
 Q "^^"'[$G(^XMB(3.7,XMDUZ,"NS1"))
"RTN","XMVVITA",170,0)
CRE8NS ; The user does not have a network signature.
"RTN","XMVVITA",171,0)
 ; Does the user want to create a network signature now?
"RTN","XMVVITA",172,0)
 ; If the user creates one, routine sets $T to true; else false
"RTN","XMVVITA",173,0)
 N DIR,X,Y
"RTN","XMVVITA",174,0)
 S DIR(0)="Y",DIR("B")=$$EZBLD^DIALOG(39054) ; Yes
"RTN","XMVVITA",175,0)
 S DIR("A")=$$EZBLD^DIALOG(37309.5) ; Would you like to create a Network Signature now
"RTN","XMVVITA",176,0)
 D ^DIR Q:'Y
"RTN","XMVVITA",177,0)
 K DIR
"RTN","XMVVITA",178,0)
 D EDITNS
"RTN","XMVVITA",179,0)
 I $$GOTNS(DUZ)
"RTN","XMVVITA",180,0)
 Q
"RTN","XMVVITA",181,0)
EDITNS ; Edit network signature
"RTN","XMVVITA",182,0)
 N DIE,DA,DR
"RTN","XMVVITA",183,0)
 S DIE="^XMB(3.7,",DA=DUZ,DR="2.21:2.23" D ^DIE
"RTN","XMVVITA",184,0)
 Q
"RTN","XMXADDR")
0^2^B68177416
"RTN","XMXADDR",1,0)
XMXADDR ;ISC-SF/GMB-Address checker ;04/29/2003  08:51
"RTN","XMXADDR",2,0)
 ;;8.0;MailMan;**18**;Jun 28, 2002
"RTN","XMXADDR",3,0)
 ; Replaces ^XMA21,^XMA210,^XMA24 (ISC-WASH/CAP/AML/LL)
"RTN","XMXADDR",4,0)
 ; XMIA     1=Interactive; 0=not
"RTN","XMXADDR",5,0)
CHKADDR(XMDUZ,XMTO,XMINSTR,XMRESTR,XMFULL) ; Check addressee(s) NON-INTERACTIVE
"RTN","XMXADDR",6,0)
 ; This entry point is meant for calls in which the addressees are
"RTN","XMXADDR",7,0)
 ; already in an array:
"RTN","XMXADDR",8,0)
 ; XMTO("addressee 1")=""
"RTN","XMXADDR",9,0)
 ; XMTO("addressee 2")=""
"RTN","XMXADDR",10,0)
 ; or for just a single addressee:  "addressee 1"
"RTN","XMXADDR",11,0)
 N XMADDR,XMIA
"RTN","XMXADDR",12,0)
 ;K XMERR,^TMP("XMERR",$J) DO NOT PUT THIS LINE IN HERE!
"RTN","XMXADDR",13,0)
 S XMIA=0
"RTN","XMXADDR",14,0)
 I $G(XMTO)]"",$O(XMTO(""))="" D  Q
"RTN","XMXADDR",15,0)
 . N XMERROR K XMFULL
"RTN","XMXADDR",16,0)
 . D ADDRESS(XMDUZ,XMTO,.XMFULL,.XMERROR) Q:'$D(XMERROR)
"RTN","XMXADDR",17,0)
 . S XMERROR("PARAM","ID")="XMTO",XMERROR("PARAM","VALUE")=XMTO
"RTN","XMXADDR",18,0)
 . D ERRSET^XMXUTIL(XMERROR,.XMERROR)
"RTN","XMXADDR",19,0)
 . S:'$D(XMFULL) ^TMP("XMERR",$J,XMERR,"PARM")=XMTO
"RTN","XMXADDR",20,0)
 I $O(XMTO(""))="" D  Q
"RTN","XMXADDR",21,0)
 . ;S XMERR=$G(XMERR)+1,^TMP("XMERR",$J,XMERR,"TEXT",1)="Null addressee"
"RTN","XMXADDR",22,0)
 S XMADDR=""
"RTN","XMXADDR",23,0)
 F  S XMADDR=$O(XMTO(XMADDR)) Q:XMADDR=""  D
"RTN","XMXADDR",24,0)
 . N XMERROR,XMFULL,XMFWDADD
"RTN","XMXADDR",25,0)
 . D ADDRESS(XMDUZ,XMADDR,.XMFULL,.XMERROR) Q:'$D(XMERROR)
"RTN","XMXADDR",26,0)
 . S XMERROR("PARAM","ID")="XMTO",XMERROR("PARAM","VALUE")=XMADDR
"RTN","XMXADDR",27,0)
 . D ERRSET^XMXUTIL(XMERROR,.XMERROR)
"RTN","XMXADDR",28,0)
 . S:'$D(XMFULL) ^TMP("XMERR",$J,XMERR,"PARM")=XMADDR
"RTN","XMXADDR",29,0)
 Q
"RTN","XMXADDR",30,0)
INIT ;
"RTN","XMXADDR",31,0)
 K ^TMP("XMY",$J),^TMP("XMY0",$J),^TMP("XMYL",$J)
"RTN","XMXADDR",32,0)
INITLATR ;
"RTN","XMXADDR",33,0)
 N XMNOW
"RTN","XMXADDR",34,0)
 S XMNOW=$$NOW^XLFDT
"RTN","XMXADDR",35,0)
 S XMINLATR=$E($$FMADD^XLFDT(XMNOW,"","",5),1,12)  ; Staggered delivery must be at least 5 minutes from now
"RTN","XMXADDR",36,0)
 S XMAXLATR=$$SCH^XLFDT("1M",XMNOW)  ; Staggered delivery must be at most 1 month from now
"RTN","XMXADDR",37,0)
 S XMBIGGRP=$P(^XMB(1,1,0),U,7)  ; Big group size
"RTN","XMXADDR",38,0)
 Q
"RTN","XMXADDR",39,0)
CLEANUP ;
"RTN","XMXADDR",40,0)
 K ^TMP("XMY",$J),^TMP("XMY0",$J),^TMP("XMYL",$J),XMINLATR,XMAXLATR,XMBIGGRP
"RTN","XMXADDR",41,0)
 Q
"RTN","XMXADDR",42,0)
ADDR(XMDUZ,XMADDR,XMINSTR,XMRESTR,XMFULL) ; Check one addressee (INTERACTIVE)
"RTN","XMXADDR",43,0)
 N XMIA,XMFWDADD
"RTN","XMXADDR",44,0)
 S XMIA=1
"RTN","XMXADDR",45,0)
 D ADDRESS(XMDUZ,XMADDR,.XMFULL)
"RTN","XMXADDR",46,0)
 Q
"RTN","XMXADDR",47,0)
ADDRESS(XMDUZ,XMADDR,XMFULL,XMERROR) ; Check one addressee
"RTN","XMXADDR",48,0)
 ; XMADDR   (in) Addressee (if number, assumed to be a person's DUZ)
"RTN","XMXADDR",49,0)
 ; XMFULL   (out) The full address of the addressee
"RTN","XMXADDR",50,0)
 N XMSTRIKE,XMPREFIX,XMLATER,XMGCIRCL,XMGMBRS,XMG
"RTN","XMXADDR",51,0)
 D CHKPARM(.XMADDR,.XMSTRIKE,.XMPREFIX,.XMLATER) Q:$D(XMERROR)
"RTN","XMXADDR",52,0)
 I $G(XMINSTR("ADDR FLAGS"))["X",$G(XMINSTR("ADDR FLAGS"))'["Y" S XMSTRIKE=0,XMLATER="",XMPREFIX=""
"RTN","XMXADDR",53,0)
 I XMADDR["@"!(XMADDR["!") D
"RTN","XMXADDR",54,0)
 . I $D(XMRESTR("NONET")) D  Q
"RTN","XMXADDR",55,0)
 . . ;Messages longer than |1| lines may not be sent across the network.
"RTN","XMXADDR",56,0)
 . . D SETERR^XMXADDR4($G(XMIA),"!",39001,XMRESTR("NONET"))
"RTN","XMXADDR",57,0)
 . D REMOTE^XMXADDR3(XMDUZ,XMADDR,XMSTRIKE,XMPREFIX,.XMLATER,.XMFULL)
"RTN","XMXADDR",58,0)
 E  D LOCAL(XMDUZ,XMADDR,XMSTRIKE,XMPREFIX,.XMLATER,.XMFULL,.XMG)
"RTN","XMXADDR",59,0)
 D:'$D(XMERROR) SET(XMFULL,$G(XMG),XMSTRIKE,XMPREFIX,XMLATER)
"RTN","XMXADDR",60,0)
 Q
"RTN","XMXADDR",61,0)
LOCAL(XMDUZ,XMADDR,XMSTRIKE,XMPREFIX,XMLATER,XMFULL,XMG) ;
"RTN","XMXADDR",62,0)
 I $E(XMADDR,1)="*" D  Q
"RTN","XMXADDR",63,0)
 . D BRODCAST^XMXADDR2(XMDUZ,XMADDR,XMSTRIKE,XMPREFIX,.XMLATER,.XMFULL)
"RTN","XMXADDR",64,0)
 I $L(XMADDR)>2,".G.g.D.d.H.h.S.s."[("."_$E(XMADDR,1,2)) D  Q
"RTN","XMXADDR",65,0)
 . N XMADDR1
"RTN","XMXADDR",66,0)
 . S XMADDR1=$E(XMADDR,1)
"RTN","XMXADDR",67,0)
 . I "Gg"[XMADDR1 D EXPAND^XMXADDRG(XMDUZ,XMADDR,XMSTRIKE,XMPREFIX,.XMLATER,.XMFULL,.XMG) Q
"RTN","XMXADDR",68,0)
 . I "Ss"[XMADDR1 D SERVER^XMXADDR3(XMADDR,XMSTRIKE,XMPREFIX,.XMLATER,.XMFULL) Q
"RTN","XMXADDR",69,0)
 . I "DdHh"[XMADDR1 D DEVICE^XMXADDR3(XMADDR,XMSTRIKE,XMPREFIX,.XMLATER,.XMFULL) Q
"RTN","XMXADDR",70,0)
 I XMADDR?1N.N,$L(XMADDR)>25 D  Q
"RTN","XMXADDR",71,0)
 . D SETERR^XMXADDR4($G(XMIA),"!,$C(7)",39002) ;Not found.
"RTN","XMXADDR",72,0)
 I $G(XMIA) D
"RTN","XMXADDR",73,0)
 . D IPERSON^XMXADDR1(XMDUZ,.XMADDR,XMSTRIKE,XMPREFIX,.XMLATER,.XMG,.XMFULL) Q:$D(XMERROR)
"RTN","XMXADDR",74,0)
 . I XMLATER="?",XMG'=.6 D QLATER(XMFULL,.XMLATER)
"RTN","XMXADDR",75,0)
 E  D
"RTN","XMXADDR",76,0)
 . D PERSON^XMXADDR1(XMDUZ,.XMADDR,XMSTRIKE,XMPREFIX,XMLATER,.XMG,.XMFULL)
"RTN","XMXADDR",77,0)
 Q:$D(XMERROR)
"RTN","XMXADDR",78,0)
 D:XMFULL'["@" INDIV(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER)
"RTN","XMXADDR",79,0)
 Q
"RTN","XMXADDR",80,0)
INDIV(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER) ;
"RTN","XMXADDR",81,0)
 N XMGREC,XMIASAVE
"RTN","XMXADDR",82,0)
 I $D(XMFWDADD) D  Q
"RTN","XMXADDR",83,0)
 . ;You can't have a message forwarded to a local user.
"RTN","XMXADDR",84,0)
 . D SETERR^XMXADDR4(0,"",38001)
"RTN","XMXADDR",85,0)
 S XMGREC=^XMB(3.7,XMG,0)
"RTN","XMXADDR",86,0)
 I $P(XMGREC,U,2)=""!(XMG=DUZ) D SETEXP(XMG,"",XMSTRIKE,XMPREFIX,XMLATER) Q
"RTN","XMXADDR",87,0)
 ; Addressee has a forwarding address.
"RTN","XMXADDR",88,0)
 ; Ignore it if message is from remote postmaster (OR envelope from is empty) and forwarding address is to a remote site (to avoid looping error messages to bad fwding address).
"RTN","XMXADDR",89,0)
 I $D(XMRESTR("NET RECEIVE")),($$UP^XLFSTR(XMRESTR("NET RECEIVE"))["POSTMASTER"!("<>"[XMRESTR("NET RECEIVE"))),$$FIND1^DIC(4.2,"","QX",$P($P(XMGREC,U,2),"@",2),"B^C")'=^XMB("NUM") D SETEXP(XMG,"",XMSTRIKE,XMPREFIX,XMLATER) Q
"RTN","XMXADDR",90,0)
 N XMFULL,XMERROR
"RTN","XMXADDR",91,0)
 S XMFWDADD=XMG
"RTN","XMXADDR",92,0)
 I $G(XMIA) S XMIA=0,XMIASAVE=1
"RTN","XMXADDR",93,0)
 D REMOTE^XMXADDR3(XMDUZ,$P(XMGREC,U,2),XMSTRIKE,XMPREFIX,.XMLATER,.XMFULL)
"RTN","XMXADDR",94,0)
 K XMFWDADD
"RTN","XMXADDR",95,0)
 I $G(XMIASAVE) S XMIA=1
"RTN","XMXADDR",96,0)
 I '$D(XMERROR) D  Q:'$P(XMGREC,U,8)  ; quit if no local delivery
"RTN","XMXADDR",97,0)
 . Q:XMSTRIKE
"RTN","XMXADDR",98,0)
 . ; Note that recipient fwded
"RTN","XMXADDR",99,0)
 . I $D(XMINSTR("NET FWD BY")),$D(XMRESTR("NET RECEIVE")) S ^TMP("XMY",$J,XMFULL,"F")=XMG_U_XMINSTR("NET FWD BY") Q
"RTN","XMXADDR",100,0)
 . S ^TMP("XMY",$J,XMFULL,"F")=XMG
"RTN","XMXADDR",101,0)
 D SETEXP(XMG,"",XMSTRIKE,XMPREFIX,XMLATER)
"RTN","XMXADDR",102,0)
 Q:'$D(XMERROR)
"RTN","XMXADDR",103,0)
 D DELFWD^XMVVITA(XMG,$P(XMGREC,U,2),.XMERROR)
"RTN","XMXADDR",104,0)
 I $G(XMIA),'$D(XMGCIRCL) W !,$C(7),"     ",$$EZBLD^DIALOG(38130.3) ; Forwarding Address ignored.
"RTN","XMXADDR",105,0)
 Q
"RTN","XMXADDR",106,0)
SET(XMTO,XMG,XMSTRIKE,XMPREFIX,XMLATER) ;
"RTN","XMXADDR",107,0)
 I $G(XMINSTR("ADDR FLAGS"))["X",$G(XMINSTR("ADDR FLAGS"))'["Y" Q
"RTN","XMXADDR",108,0)
 I XMSTRIKE D  Q
"RTN","XMXADDR",109,0)
 . I $G(XMIA) D
"RTN","XMXADDR",110,0)
 . . I $E(XMTO,1,2)="G."!($E(XMTO,1,2)="*;") D
"RTN","XMXADDR",111,0)
 . . . I $D(^TMP("XMY0",$J,XMTO,"L")) D  Q
"RTN","XMXADDR",112,0)
 . . . . W $$EZBLD^DIALOG(39003) ;Later'd Group Deleted.
"RTN","XMXADDR",113,0)
 . . . . K ^TMP("XMYL",$J,XMTO)
"RTN","XMXADDR",114,0)
 . . . W !,$$EZBLD^DIALOG(39004) ;Members Deleted.
"RTN","XMXADDR",115,0)
 . . E  W:$X>70 ! W $$EZBLD^DIALOG(39005) ;Deleted.
"RTN","XMXADDR",116,0)
 . . ; 39006 - * (Broadcast to all local users)
"RTN","XMXADDR",117,0)
 . . I XMTO'=$$EZBLD^DIALOG(39006),$D(^TMP("XMY0",$J,$$EZBLD^DIALOG(39006))) W !,$$EZBLD^DIALOG(39007) ;But Broadcast will still go to all local users
"RTN","XMXADDR",118,0)
 . . Q:'$D(^TMP("XMYL",$J))
"RTN","XMXADDR",119,0)
 . . N XMGRP,XMTEXT ;But message will still go to all members of the following later'd group(s):
"RTN","XMXADDR",120,0)
 . . D BLD^DIALOG(39008,"","","XMTEXT","F")
"RTN","XMXADDR",121,0)
 . . D MSG^DIALOG("WM","","","","XMTEXT")
"RTN","XMXADDR",122,0)
 . . S XMGRP="" F  S XMGRP=$O(^TMP("XMYL",$J,XMGRP)) Q:XMGRP=""  W !,XMGRP
"RTN","XMXADDR",123,0)
 . K ^TMP("XMY0",$J,XMTO)
"RTN","XMXADDR",124,0)
 . K:$D(^TMP("XMYL",$J,XMTO)) ^TMP("XMYL",$J,XMTO)
"RTN","XMXADDR",125,0)
 S ^TMP("XMY0",$J,XMTO)=XMG    ; =XMIEN
"RTN","XMXADDR",126,0)
 I XMPREFIX'="" S ^TMP("XMY0",$J,XMTO,1)=$$UP^XLFSTR(XMPREFIX)
"RTN","XMXADDR",127,0)
 I XMLATER S ^TMP("XMY0",$J,XMTO,"L")=XMLATER I $E(XMTO,1,2)="G."!($E(XMTO,1,2)="*;") S ^TMP("XMYL",$J,XMTO)=""
"RTN","XMXADDR",128,0)
 I XMLATER="?",$G(XMIA) W !,$C(7),$$EZBLD^DIALOG(39009) ;'Later' not appropriate for this addressee
"RTN","XMXADDR",129,0)
 Q
"RTN","XMXADDR",130,0)
SETEXP(XMTO,XMIEN,XMSTRIKE,XMPREFIX,XMLATER) ;
"RTN","XMXADDR",131,0)
 Q:$G(XMINSTR("ADDR FLAGS"))["X"
"RTN","XMXADDR",132,0)
 I XMSTRIKE K ^TMP("XMY",$J,XMTO) Q
"RTN","XMXADDR",133,0)
 I XMLATER,XMTO'=XMDUZ Q
"RTN","XMXADDR",134,0)
 S ^TMP("XMY",$J,XMTO)=XMIEN
"RTN","XMXADDR",135,0)
 I XMPREFIX'="" S ^TMP("XMY",$J,XMTO,1)=$$UP^XLFSTR(XMPREFIX)
"RTN","XMXADDR",136,0)
 I $D(XMINSTR("NET FWD BY")),$D(XMRESTR("NET RECEIVE")) S ^TMP("XMY",$J,XMTO,"F")=XMINSTR("NET FWD BY")
"RTN","XMXADDR",137,0)
 Q
"RTN","XMXADDR",138,0)
GOTADDR() ; Function returns 1 if addressees exist; 0 if not.
"RTN","XMXADDR",139,0)
 Q:$D(^TMP("XMY",$J)) 1
"RTN","XMXADDR",140,0)
 Q:$D(^TMP("XMYL",$J)) 1
"RTN","XMXADDR",141,0)
 Q:'$D(^TMP("XMY0",$J)) 0
"RTN","XMXADDR",142,0)
 N XMTO
"RTN","XMXADDR",143,0)
 S XMTO=$O(^TMP("XMY0",$J,""))
"RTN","XMXADDR",144,0)
 Q:$D(^TMP("XMY0",$J,XMTO,"L")) 1
"RTN","XMXADDR",145,0)
 Q 0
"RTN","XMXADDR",146,0)
CHKPARM(XMADDR,XMSTRIKE,XMPREFIX,XMLATER) ;
"RTN","XMXADDR",147,0)
 I $E(XMADDR,1)="-" D
"RTN","XMXADDR",148,0)
 . S XMSTRIKE=1
"RTN","XMXADDR",149,0)
 . S XMADDR=$E(XMADDR,2,999)
"RTN","XMXADDR",150,0)
 E  S XMSTRIKE=0
"RTN","XMXADDR",151,0)
 I $E(XMADDR,1)=" "!($E(XMADDR,$L(XMADDR))=" ") S XMADDR=$$STRIP^XMXUTIL1(XMADDR)
"RTN","XMXADDR",152,0)
 I $P(XMADDR,"@",1)="" D  Q
"RTN","XMXADDR",153,0)
 . D SETERR^XMXADDR4($G(XMIA),"!",39010) ;Null addressee
"RTN","XMXADDR",154,0)
 I $E(XMADDR,1)'="""",XMADDR[":" D  Q
"RTN","XMXADDR",155,0)
 . D PREFIX(.XMADDR,.XMPREFIX,.XMLATER)
"RTN","XMXADDR",156,0)
 . I XMSTRIKE,XMLATER="?" S XMLATER=""
"RTN","XMXADDR",157,0)
 S XMPREFIX=""
"RTN","XMXADDR",158,0)
 S XMLATER=""
"RTN","XMXADDR",159,0)
 Q
"RTN","XMXADDR",160,0)
PREFIX(XMADDR,XMPREFIX,XMLATER) ;
"RTN","XMXADDR",161,0)
 N XMPRE
"RTN","XMXADDR",162,0)
 S XMPRE=$P(XMADDR,":",1)
"RTN","XMXADDR",163,0)
 I XMPRE="" D  Q
"RTN","XMXADDR",164,0)
 . D SETERR^XMXADDR4($G(XMIA),"!",39011) ;Null recipient type
"RTN","XMXADDR",165,0)
 S (XMLATER,XMPREFIX)=""
"RTN","XMXADDR",166,0)
 S XMPRE=$$UP^XLFSTR(XMPRE)
"RTN","XMXADDR",167,0)
 I $P(XMPRE,"@",1)["L",'$D(XMRESTR("NET RECEIVE")) D
"RTN","XMXADDR",168,0)
 . D LATER($P(XMPRE,"@",2,99),.XMLATER)
"RTN","XMXADDR",169,0)
 . S XMPRE=$TR($P(XMPRE,"@",1),"L")
"RTN","XMXADDR",170,0)
 D:XMPRE'="" RTYPE(XMPRE,.XMPREFIX)
"RTN","XMXADDR",171,0)
 I $D(XMERROR),$D(XMRESTR("NET RECEIVE")),$$FIND1^DIC(4.2,"","QX",$P(XMADDR,"@",2),"B^C")'=^XMB("NUM") K XMERROR Q
"RTN","XMXADDR",172,0)
 S XMADDR=$P(XMADDR,":",2)
"RTN","XMXADDR",173,0)
 Q
"RTN","XMXADDR",174,0)
LATER(XMWHEN,XMLATER) ; (XMWHEN=user-supplied date/time)
"RTN","XMXADDR",175,0)
 I $G(XMIA),XMWHEN="" S XMLATER="?" Q
"RTN","XMXADDR",176,0)
 I '$D(XMINLATR) D INITLATR
"RTN","XMXADDR",177,0)
 D DT^DILF("FTX",XMWHEN,.XMLATER,XMINLATR)
"RTN","XMXADDR",178,0)
 Q:XMLATER>0
"RTN","XMXADDR",179,0)
 S XMLATER=$S($G(XMIA):"?",1:"")
"RTN","XMXADDR",180,0)
 Q
"RTN","XMXADDR",181,0)
RTYPE(XMPRE,XMPREFIX) ;
"RTN","XMXADDR",182,0)
 N XMINTRNL
"RTN","XMXADDR",183,0)
 D CHK^DIE(3.91,6.5,"",XMPRE,.XMINTRNL)
"RTN","XMXADDR",184,0)
 I XMINTRNL="^" D  Q  ;Invalid recipient type '|1|'
"RTN","XMXADDR",185,0)
 . D SETERR^XMXADDR4($G(XMIA),"!",39012,XMPRE)
"RTN","XMXADDR",186,0)
 S XMPREFIX=XMINTRNL
"RTN","XMXADDR",187,0)
 Q
"RTN","XMXADDR",188,0)
QLATER(XMFULL,XMLATER) ;
"RTN","XMXADDR",189,0)
 N DIR,Y
"RTN","XMXADDR",190,0)
 I '$D(XMINLATR) D INITLATR
"RTN","XMXADDR",191,0)
 W !
"RTN","XMXADDR",192,0)
 S DIR(0)="DO^"_XMINLATR_":"_XMAXLATR_":EXT"
"RTN","XMXADDR",193,0)
 ;Later Delivery must be at least 5 minutes from now.
"RTN","XMXADDR",194,0)
 D BLD^DIALOG(39013,"","","DIR(""A"")") ;When Later
"RTN","XMXADDR",195,0)
 S DIR("B")=$$MMDT^XMXUTIL1($$FMADD^XLFDT($$NOW^XLFDT,"","",5)) ; (in 5 minutes)
"RTN","XMXADDR",196,0)
 S DIR("B")=$P(DIR("B")," ",1,3)_"@"_$P(DIR("B")," ",4)
"RTN","XMXADDR",197,0)
 D ^DIR I $D(DIRUT) D  Q
"RTN","XMXADDR",198,0)
 . S XMLATER=""
"RTN","XMXADDR",199,0)
 . D SETERR^XMXADDR4(0,"",37002) ;up-arrow or time out.
"RTN","XMXADDR",200,0)
 . W !,XMFULL,$$EZBLD^DIALOG(39015) ;removed from recipient list.
"RTN","XMXADDR",201,0)
 S XMLATER=Y
"RTN","XMXADDR",202,0)
 ;>> Remember, you won't be able to 'minus' anyone from the ...
"RTN","XMXADDR",203,0)
 I $E(XMFULL,1,2)="G." W !!,$$EZBLD^DIALOG(39016) ; group <<
"RTN","XMXADDR",204,0)
 I $E(XMFULL,1,2)="*;" W !!,$$EZBLD^DIALOG(39017) ; limited broadcast <<
"RTN","XMXADDR",205,0)
 Q
"RTN","XMXADDR3")
0^3^B38170725
"RTN","XMXADDR3",1,0)
XMXADDR3 ;ISC-SF/GMB-XMXADDR (cont.) ;04/15/2003  13:16
"RTN","XMXADDR3",2,0)
 ;;8.0;MailMan;**18**;Jun 28, 2002
"RTN","XMXADDR3",3,0)
SERVER(XMADDR,XMSTRIKE,XMPREFIX,XMLATER,XMFULL) ;
"RTN","XMXADDR3",4,0)
 N XMG
"RTN","XMXADDR3",5,0)
 S XMADDR=$P(XMADDR,".",2,99)
"RTN","XMXADDR3",6,0)
 I $G(XMIA) D
"RTN","XMXADDR3",7,0)
 . N DIC,X
"RTN","XMXADDR3",8,0)
 . S X=XMADDR
"RTN","XMXADDR3",9,0)
 . S DIC="^DIC(19,"
"RTN","XMXADDR3",10,0)
 . S DIC(0)="FEZ"_$S($D(XMGCIRCL):"O",1:"")
"RTN","XMXADDR3",11,0)
 . D ^DIC
"RTN","XMXADDR3",12,0)
 . I Y<0 D SETERR^XMXADDR4(1,"!",39060) Q  ;Invalid server name
"RTN","XMXADDR3",13,0)
 . S XMG=+Y
"RTN","XMXADDR3",14,0)
 E  D
"RTN","XMXADDR3",15,0)
 . S XMG=$$FIND1^DIC(19,"","O",XMADDR) I 'XMG D SETERR^XMXADDR4(0,"",$S($D(DIERR):39061,1:39062)) ; Server ambiguous / Server not found.
"RTN","XMXADDR3",16,0)
 Q:$D(XMERROR)
"RTN","XMXADDR3",17,0)
 S XMFULL="S."_$P(^DIC(19,XMG,0),U,1)
"RTN","XMXADDR3",18,0)
 D SETEXP^XMXADDR(XMFULL,XMG,XMSTRIKE,XMPREFIX,XMLATER)
"RTN","XMXADDR3",19,0)
 Q
"RTN","XMXADDR3",20,0)
DEVICE(XMADDR,XMSTRIKE,XMPREFIX,XMLATER,XMFULL) ;
"RTN","XMXADDR3",21,0)
 N XMG
"RTN","XMXADDR3",22,0)
 S XMADDR1=$$UP^XLFSTR($E(XMADDR,1))
"RTN","XMXADDR3",23,0)
 S XMADDR=$P(XMADDR,".",2,99)
"RTN","XMXADDR3",24,0)
 I $G(XMIA) D
"RTN","XMXADDR3",25,0)
 . N DIC,X
"RTN","XMXADDR3",26,0)
 . S X=XMADDR
"RTN","XMXADDR3",27,0)
 . S DIC="^%ZIS(1,"   ; file 3.5
"RTN","XMXADDR3",28,0)
 . S DIC(0)="EF"_$S($D(XMGCIRCL):"O",1:"")
"RTN","XMXADDR3",29,0)
 . D ^DIC
"RTN","XMXADDR3",30,0)
 . I Y<0 D SETERR^XMXADDR4(1,"!",39063) Q  ;Invalid device name
"RTN","XMXADDR3",31,0)
 . S XMG=+Y
"RTN","XMXADDR3",32,0)
 . S XMADDR=$P(Y,U,2)
"RTN","XMXADDR3",33,0)
 E  D
"RTN","XMXADDR3",34,0)
 . S XMG=$$FIND1^DIC(3.5,"","O",XMADDR) I 'XMG D SETERR^XMXADDR4(0,"",$S($D(DIERR):39064,1:39065)) Q  ; Device ambiguous. / Device not found.
"RTN","XMXADDR3",35,0)
 . S XMADDR=$P(^%ZIS(1,XMG,0),U,1)
"RTN","XMXADDR3",36,0)
 Q:$D(XMERROR)
"RTN","XMXADDR3",37,0)
 I XMADDR["P-MESSAGE" D  Q  ;You may not use P-MESSAGE in an address.
"RTN","XMXADDR3",38,0)
 . D SETERR^XMXADDR4($G(XMIA),"!",39066)
"RTN","XMXADDR3",39,0)
 S XMFULL=XMADDR1_"."_XMADDR
"RTN","XMXADDR3",40,0)
 D SETEXP^XMXADDR(XMFULL,XMG,XMSTRIKE,XMPREFIX,XMLATER)
"RTN","XMXADDR3",41,0)
 Q
"RTN","XMXADDR3",42,0)
REMOTE(XMDUZ,XMADDR,XMSTRIKE,XMPREFIX,XMLATER,XMFULL) ;
"RTN","XMXADDR3",43,0)
 ; XMVIA    IEN of domain in ^DIC(4.2 via which the msg will be sent
"RTN","XMXADDR3",44,0)
 ; XMVIAN   Name of domain via which the msg will be sent
"RTN","XMXADDR3",45,0)
 ; XMDOMAIN Domain of the addressee
"RTN","XMXADDR3",46,0)
 ; XMNAME   Name of the addressee
"RTN","XMXADDR3",47,0)
 N XMVIA,XMVIAN,XMDOMAIN,XMNAME
"RTN","XMXADDR3",48,0)
 S:XMADDR["<"!(XMADDR[" ") XMADDR=$$REMADDR(XMADDR)
"RTN","XMXADDR3",49,0)
 S XMNAME=$P(XMADDR,"@",1)
"RTN","XMXADDR3",50,0)
 I XMNAME="" D  Q
"RTN","XMXADDR3",51,0)
 . D SETERR^XMXADDR4($G(XMIA),"!",39010) ;Null addressee
"RTN","XMXADDR3",52,0)
 S XMDOMAIN=$P(XMADDR,"@",2,99)
"RTN","XMXADDR3",53,0)
 I XMDOMAIN="" D  Q
"RTN","XMXADDR3",54,0)
 . ; You must specify a reachable uunet host / Null domain
"RTN","XMXADDR3",55,0)
 . D SETERR^XMXADDR4($G(XMIA),"!",$S(XMNAME["!":39067,1:39068))
"RTN","XMXADDR3",56,0)
 ; find out the full domain name, and
"RTN","XMXADDR3",57,0)
 ; whether the domain is valid, and if so, via which entry in DIC(4.2
"RTN","XMXADDR3",58,0)
 D DNS^XMXADDRD(XMDUZ,.XMDOMAIN,.XMVIA,.XMVIAN) Q:$D(XMERROR)
"RTN","XMXADDR3",59,0)
 I XMDOMAIN=^XMB("NETNAME") D  ; the full domain name = the local domain
"RTN","XMXADDR3",60,0)
 . N XMQUOTED
"RTN","XMXADDR3",61,0)
 . I XMNAME?1""""1.E1"""" S XMNAME=$E(XMNAME,2,$L(XMNAME)-1),XMQUOTED=1
"RTN","XMXADDR3",62,0)
 . I $E(XMNAME,1)=" "!($E(XMNAME,$L(XMNAME))=" ") S XMNAME=$$STRIP^XMXUTIL1(XMNAME)
"RTN","XMXADDR3",63,0)
 . D LOCAL^XMXADDR(XMDUZ,XMNAME,XMSTRIKE,XMPREFIX,.XMLATER,.XMFULL)
"RTN","XMXADDR3",64,0)
 . Q:'$D(XMERROR)
"RTN","XMXADDR3",65,0)
 . Q:$G(XMQUOTED)
"RTN","XMXADDR3",66,0)
 . N XMSAVE
"RTN","XMXADDR3",67,0)
 . S XMSAVE=XMNAME
"RTN","XMXADDR3",68,0)
 . I ".G.g.D.d.H.h.S.s."[("."_$E(XMNAME,1,2)) S XMNAME=$E(XMNAME,1,2)_$TR($E(XMNAME,3,99),"._+",", .")
"RTN","XMXADDR3",69,0)
 . E  S XMNAME=$TR(XMNAME,"._+",", .")
"RTN","XMXADDR3",70,0)
 . I XMSAVE'=XMNAME D  Q:'$D(XMERROR)
"RTN","XMXADDR3",71,0)
 . . K XMERROR
"RTN","XMXADDR3",72,0)
 . . I $G(XMIA) D EN^DDIOL($$EZBLD^DIALOG(39069,XMNAME)) ;Checking: |1|
"RTN","XMXADDR3",73,0)
 . . D LOCAL^XMXADDR(XMDUZ,XMNAME,XMSTRIKE,XMPREFIX,.XMLATER,.XMFULL)
"RTN","XMXADDR3",74,0)
 . Q:'$G(XMRESTR("NET RECEIVE"))
"RTN","XMXADDR3",75,0)
 . Q:"^39062^39065^39132^"'[(U_XMERROR_U)
"RTN","XMXADDR3",76,0)
 . ; Server, Device, or Group not found.  Try lower case.
"RTN","XMXADDR3",77,0)
 . ; (We do not need to try local user again.)
"RTN","XMXADDR3",78,0)
 . S XMSAVE=XMNAME,XMNAME=$$LOW^XLFSTR(XMNAME) Q:XMSAVE=XMNAME
"RTN","XMXADDR3",79,0)
 . K XMERROR
"RTN","XMXADDR3",80,0)
 . D LOCAL^XMXADDR(XMDUZ,XMNAME,XMSTRIKE,XMPREFIX,.XMLATER,.XMFULL)
"RTN","XMXADDR3",81,0)
 E  D
"RTN","XMXADDR3",82,0)
 . I $D(XMRESTR("NONET")) D  Q
"RTN","XMXADDR3",83,0)
 . . ;Messages longer than |1| lines may not be sent across the network.
"RTN","XMXADDR3",84,0)
 . . D SETERR^XMXADDR4($G(XMIA),"!",39001,XMRESTR("NONET"))
"RTN","XMXADDR3",85,0)
 . I $D(XMFWDADD),+$G(^XMB(1,1,3)) D  Q:$D(XMERROR)
"RTN","XMXADDR3",86,0)
 . . ; This is an auto-forward address, and we are limiting it.
"RTN","XMXADDR3",87,0)
 . . Q:$$FWDOK(3.1,XMDOMAIN)  ; Approved auto-forward site?
"RTN","XMXADDR3",88,0)
 . . I '$D(^XUSEC("XM AUTO-FORWARD WAIVER",+XMFWDADD)) D  Q
"RTN","XMXADDR3",89,0)
 . . . ;You can't have your mail forwarded to a non-VA site.  Waivers can
"RTN","XMXADDR3",90,0)
 . . . ;be requested through your site Information Security Officer (ISO)
"RTN","XMXADDR3",91,0)
 . . . D SETERR^XMXADDR4($G(XMIA),"P",38130.1)
"RTN","XMXADDR3",92,0)
 . . Q:$$FWDOK(3.2,XMDOMAIN)  ; Waiver auto-forward site?
"RTN","XMXADDR3",93,0)
 . . ;You have been granted a waiver to have your mail forwarded to a
"RTN","XMXADDR3",94,0)
 . . ;non-VA site, but this site is not one of the sites for which a
"RTN","XMXADDR3",95,0)
 . . ;waiver has been granted.  Please contact your site Information
"RTN","XMXADDR3",96,0)
 . . ;Security Officer (ISO) for further information.
"RTN","XMXADDR3",97,0)
 . . D SETERR^XMXADDR4($G(XMIA),"P",38130.2)
"RTN","XMXADDR3",98,0)
 . ; I XMDOMAIN?.E1".VA.GOV" D
"RTN","XMXADDR3",99,0)
 . ;. ; Check the address before the @ to find any obvious errors
"RTN","XMXADDR3",100,0)
 . ; Now transform spaces, commas, and periods in XMNAME
"RTN","XMXADDR3",101,0)
 . S XMFULL=XMNAME_"@"_XMDOMAIN
"RTN","XMXADDR3",102,0)
 . I XMSTRIKE D REMINUS(.XMFULL,XMNAME,XMDOMAIN) Q:$D(XMERROR)
"RTN","XMXADDR3",103,0)
 . I XMLATER="?" D QLATER^XMXADDR(XMFULL,.XMLATER) Q:$D(XMERROR)
"RTN","XMXADDR3",104,0)
 . D SETEXP^XMXADDR(XMFULL,XMVIA,XMSTRIKE,XMPREFIX,XMLATER)
"RTN","XMXADDR3",105,0)
 Q
"RTN","XMXADDR3",106,0)
FWDOK(XMNODE,XMDOMAIN) ; Is the auto-forward domain OK?
"RTN","XMXADDR3",107,0)
 N I,XMOK
"RTN","XMXADDR3",108,0)
 S I="",XMOK=0
"RTN","XMXADDR3",109,0)
 F  S I=$O(^XMB(1,1,XMNODE,"B",I)) Q:I=""!(I=$E(XMDOMAIN,$L(XMDOMAIN)-$L(I)+1,99))
"RTN","XMXADDR3",110,0)
 Q I'=""
"RTN","XMXADDR3",111,0)
REMINUS(XMFULL,XMNAME,XMDOMAIN) ;
"RTN","XMXADDR3",112,0)
 Q:$D(^TMP("XMY",$J,XMFULL))
"RTN","XMXADDR3",113,0)
 I $O(^TMP("XMY",$J,":"))="" Q:'$G(XMIA)  D  Q
"RTN","XMXADDR3",114,0)
 . D SETERR^XMXADDR4($G(XMIA),"!",39015.1) ;Not a current recipient.
"RTN","XMXADDR3",115,0)
 N XMTRY,XMTO
"RTN","XMXADDR3",116,0)
 S XMTRY=$$LOW^XLFSTR(XMNAME)_"@"_XMDOMAIN
"RTN","XMXADDR3",117,0)
 I $D(^TMP("XMY",$J,XMTRY)) S XMFULL=XMTRY Q
"RTN","XMXADDR3",118,0)
 S XMTRY=$$UP^XLFSTR(XMNAME)_"@"_XMDOMAIN
"RTN","XMXADDR3",119,0)
 I $D(^TMP("XMY",$J,XMTRY)) S XMFULL=XMTRY Q
"RTN","XMXADDR3",120,0)
 S XMTO=":"
"RTN","XMXADDR3",121,0)
 F  S XMTO=$O(^TMP("XMY",$J,XMTO)) Q:XMTO=""  Q:$$UP^XLFSTR(XMTO)=XMTRY
"RTN","XMXADDR3",122,0)
 I XMTO="" Q:'$G(XMIA)  D SETERR^XMXADDR4($G(XMIA),"!",39015.1) Q  ;Not a current recipient.
"RTN","XMXADDR3",123,0)
 S XMFULL=XMTO
"RTN","XMXADDR3",124,0)
 Q
"RTN","XMXADDR3",125,0)
REMADDR(XMADDR) ;
"RTN","XMXADDR3",126,0)
 I XMADDR["<" Q $TR($P($P(XMADDR,">",1),"<",2,99),"<")  ; handles <addr> and <<addr>>
"RTN","XMXADDR3",127,0)
 Q:XMADDR'[" " XMADDR
"RTN","XMXADDR3",128,0)
 I $E(XMADDR,1)=" "!($E(XMADDR,$L(XMADDR))=" ") S XMADDR=$$STRIP^XMXUTIL1(XMADDR)
"RTN","XMXADDR3",129,0)
 I XMADDR'["""",XMADDR'["(" Q XMADDR
"RTN","XMXADDR3",130,0)
 I XMADDR["""@" D  Q XMADDR
"RTN","XMXADDR3",131,0)
 . ; "first last"@domain
"RTN","XMXADDR3",132,0)
 . N I,J,XMDOM
"RTN","XMXADDR3",133,0)
 . S I=$F(XMADDR,"""@")
"RTN","XMXADDR3",134,0)
 . S XMDOM=$E(XMADDR,I,999)
"RTN","XMXADDR3",135,0)
 . S XMDOM=$P(XMDOM," ",1)
"RTN","XMXADDR3",136,0)
 . S J=$F(XMADDR,"""")
"RTN","XMXADDR3",137,0)
 . S XMADDR=$E(XMADDR,J-1,I-J)_"@"_XMDOM
"RTN","XMXADDR3",138,0)
 ; last.first@domain (first last)
"RTN","XMXADDR3",139,0)
 N I
"RTN","XMXADDR3",140,0)
 F I=1:1:$L(XMADDR," ") Q:$P(XMADDR," ",I)["@"
"RTN","XMXADDR3",141,0)
 S XMADDR=$P(XMADDR," ",1,I)
"RTN","XMXADDR3",142,0)
 Q XMADDR
"RTN","XMXADDRG")
0^4^B70215802
"RTN","XMXADDRG",1,0)
XMXADDRG ;ISC-SF/GMB-Expand group ;04/15/2003  13:05
"RTN","XMXADDRG",2,0)
 ;;8.0;MailMan;**18**;Jun 28, 2002
"RTN","XMXADDRG",3,0)
 ; Replaces ^XMA21G (ISC-WASH/CAP)
"RTN","XMXADDRG",4,0)
EXPAND(XMDUZ,XMADDR,XMSTRIKE,XMPREFIX,XMLATER,XMFULL,XMG) ;
"RTN","XMXADDRG",5,0)
 ; XMG      IEN of group in ^XMB(3.8)
"RTN","XMXADDRG",6,0)
 ; XMGN     Name of group
"RTN","XMXADDRG",7,0)
 ; XMGPRIV  Restrictions on use of group
"RTN","XMXADDRG",8,0)
 ; XMGMREC  Group member's ^XMB(3.7,x,0 record
"RTN","XMXADDRG",9,0)
 ; XMGCIRCL Array used to guard against circular references
"RTN","XMXADDRG",10,0)
 N XMGREC,XMGN,XMGPRIV,XMSCREEN,XMGCIRCL,XMIASAVE,XMGMBRS
"RTN","XMXADDRG",11,0)
 I $D(XMRESTR("NOFPG")) D  Q  ;Must be sender or hold XM GROUP PRIORITY
"RTN","XMXADDRG",12,0)
 . ;key to forward priority mail to groups.
"RTN","XMXADDRG",13,0)
 . D SETERR^XMXADDR4($G(XMIA),"!",39130)
"RTN","XMXADDRG",14,0)
 S XMADDR=$E(XMADDR,3,999)
"RTN","XMXADDRG",15,0)
 ; Screen:  Group is public OR user is organizer
"RTN","XMXADDRG",16,0)
 ;          OR group is unrestricted and user is member
"RTN","XMXADDRG",17,0)
 S XMSCREEN="N XMR S XMR=^(0) I $S($P(XMR,U,2)=""PU"":1,$P($G(^XMB(3.8,+Y,3),.5),U)=XMDUZ:1,+$P(XMR,U,6):0,$D(^XMB(3.8,+Y,1,""B"",XMDUZ)):1,1:0)"
"RTN","XMXADDRG",18,0)
 I $G(XMIA) D  Q:$D(XMERROR)
"RTN","XMXADDRG",19,0)
 . N DIC,X
"RTN","XMXADDRG",20,0)
 . S X=XMADDR
"RTN","XMXADDRG",21,0)
 . S DIC("S")=XMSCREEN
"RTN","XMXADDRG",22,0)
 . S DIC="^XMB(3.8,"
"RTN","XMXADDRG",23,0)
 . S DIC(0)="MEZ"
"RTN","XMXADDRG",24,0)
 . D ^DIC
"RTN","XMXADDRG",25,0)
 . I Y<0 D SETERR^XMXADDR4(XMADDR'="?","",39002) Q  ;Not found.
"RTN","XMXADDRG",26,0)
 . S XMG=+Y
"RTN","XMXADDRG",27,0)
 . S XMGN=$P(Y,U,2)
"RTN","XMXADDRG",28,0)
 . S XMGREC=Y(0)
"RTN","XMXADDRG",29,0)
 E  D  Q:$D(XMERROR)
"RTN","XMXADDRG",30,0)
 . S XMG=$$FIND1^DIC(3.8,"","MO",XMADDR,"",XMSCREEN) I 'XMG D SETERR^XMXADDR4(0,"",$S($D(DIERR):39131,1:39132)) Q  ; Mail group ambiguous. / Mail group not found.
"RTN","XMXADDRG",31,0)
 . S XMGREC=^XMB(3.8,XMG,0)
"RTN","XMXADDRG",32,0)
 . S XMGN=$P(XMGREC,U)
"RTN","XMXADDRG",33,0)
 I $D(^XMB(3.8,XMG,4,"B")),'$D(^("B",XMDUZ))!$D(XMRESTR("NET RECEIVE")) D  Q
"RTN","XMXADDRG",34,0)
 . ; If the group has authorized senders, then the sender must be local.
"RTN","XMXADDRG",35,0)
 . ; Incoming network mail may not address such a group.
"RTN","XMXADDRG",36,0)
 . D SETERR^XMXADDR4(0,"",39133) ;Sender not authorized to group.
"RTN","XMXADDRG",37,0)
 . Q:'$G(XMIA)
"RTN","XMXADDRG",38,0)
 . N XMABORT,XMTEXT
"RTN","XMXADDRG",39,0)
 . S XMABORT=0
"RTN","XMXADDRG",40,0)
 . W @IOF
"RTN","XMXADDRG",41,0)
 . ;You may not send mail directly to this group.
"RTN","XMXADDRG",42,0)
 . ;You must send it to an authorized sender for the group.
"RTN","XMXADDRG",43,0)
 . D BLD^DIALOG(39134,"","","XMTEXT","F")
"RTN","XMXADDRG",44,0)
 . D MSG^DIALOG("WE","","","","XMTEXT")
"RTN","XMXADDRG",45,0)
 . D AUTHSEND^XMHIG(XMG,XMABORT)
"RTN","XMXADDRG",46,0)
 S XMGPRIV=$P(XMGREC,U,6)
"RTN","XMXADDRG",47,0)
 S XMFULL="G."_XMGN_$S($G(XMINSTR("ADDR FLAGS"))["Y":"",XMGPRIV:$$EZBLD^DIALOG(39135),1:"") ;[Private Mail Group]
"RTN","XMXADDRG",48,0)
 I $G(XMINSTR("ADDR FLAGS"))["X" Q
"RTN","XMXADDRG",49,0)
 I XMSTRIKE Q:$D(^TMP("XMY0",$J,XMFULL,"L"))  W:$G(XMIA) $$EZBLD^DIALOG(39136) ;Deleting Members ...
"RTN","XMXADDRG",50,0)
 I $G(XMIA),'XMSTRIKE D  Q:$D(XMERROR)
"RTN","XMXADDRG",51,0)
 . I XMLATER="",$G(XMBIGGRP),$$BIG(XMG) D LATERIT(XMFULL,.XMLATER)
"RTN","XMXADDRG",52,0)
 . I XMLATER="?" D QLATER^XMXADDR(XMFULL,.XMLATER)
"RTN","XMXADDRG",53,0)
 I XMLATER,'$G(XMIA) Q
"RTN","XMXADDRG",54,0)
 I $D(XMIA) S XMIASAVE=XMIA
"RTN","XMXADDRG",55,0)
 I $D(^TMP("XM",$J,"GRPERR")) K ^TMP("XM",$J,"GRPERR")
"RTN","XMXADDRG",56,0)
 D EXPGROUP(XMDUZ,XMG,XMGREC,XMSTRIKE,XMPREFIX,XMLATER,.XMGCIRCL)
"RTN","XMXADDRG",57,0)
 I '$G(XMGMBRS),'XMLATER D
"RTN","XMXADDRG",58,0)
 . D SETERR^XMXADDR4($G(XMIA),"",39137) ;Mail group has no members
"RTN","XMXADDRG",59,0)
 I $D(^TMP("XM",$J,"GRPERR")) D
"RTN","XMXADDRG",60,0)
 . D GRPERR^XMXADDR4(XMDUZ,XMG,XMGN)
"RTN","XMXADDRG",61,0)
 . K ^TMP("XM",$J,"GRPERR")
"RTN","XMXADDRG",62,0)
 K XMIA
"RTN","XMXADDRG",63,0)
 I $D(XMIASAVE) S XMIA=XMIASAVE
"RTN","XMXADDRG",64,0)
 Q
"RTN","XMXADDRG",65,0)
BIG(XMIEN) ; Function returns 1 if big group, 0 if not
"RTN","XMXADDRG",66,0)
 Q:$D(^XMB(3.8,XMIEN,5,"B")) 1  ; has member groups
"RTN","XMXADDRG",67,0)
 Q:$D(^XMB(3.8,XMIEN,7,"B")) 1  ; has distribution list
"RTN","XMXADDRG",68,0)
 ;Q:$D(^XMB(3.8,XMIEN,9,"B")) 1  ; has fax groups
"RTN","XMXADDRG",69,0)
 N XMCNT,XMNODE
"RTN","XMXADDRG",70,0)
 S XMCNT=0
"RTN","XMXADDRG",71,0)
 F XMNODE=1,6,8 D  ; local, remote, & fax members
"RTN","XMXADDRG",72,0)
 . Q:'$D(^XMB(3.8,XMIEN,XMNODE,0))
"RTN","XMXADDRG",73,0)
 . S XMCNT=XMCNT+$P($G(^XMB(3.8,XMIEN,XMNODE,0)),U,4)
"RTN","XMXADDRG",74,0)
 Q XMCNT'<XMBIGGRP
"RTN","XMXADDRG",75,0)
LATERIT(XMFULL,XMLATER) ;
"RTN","XMXADDRG",76,0)
 N DIR,X,Y,DIRUT
"RTN","XMXADDRG",77,0)
 ;This group seems to be fairly big.  If you don't need to 'minus'
"RTN","XMXADDRG",78,0)
 ;anyone from it, then you can save some time by queuing it for 'Later'
"RTN","XMXADDRG",79,0)
 ;delivery.  Would you like to queue this group for later delivery
"RTN","XMXADDRG",80,0)
 D BLD^DIALOG(39138,"","","DIR(""A"")")
"RTN","XMXADDRG",81,0)
 S DIR(0)="Y"
"RTN","XMXADDRG",82,0)
 S DIR("B")=$$EZBLD^DIALOG(39053) ;No
"RTN","XMXADDRG",83,0)
 ;Answer NO if
"RTN","XMXADDRG",84,0)
 ; - You need to delete any group members from the message.
"RTN","XMXADDRG",85,0)
 ;Answer YES if
"RTN","XMXADDRG",86,0)
 ; - You don't need to delete any group members from the message
"RTN","XMXADDRG",87,0)
 ; - and you'd like to save a bit of time.
"RTN","XMXADDRG",88,0)
 D BLD^DIALOG(39139,"","","DIR(""?"")")
"RTN","XMXADDRG",89,0)
 D ^DIR I $D(DIRUT) D  Q
"RTN","XMXADDRG",90,0)
 . D SETERR^XMXADDR4(0,"",37002) ;up-arrow or time out.
"RTN","XMXADDRG",91,0)
 . D EN^DDIOL(XMFULL_$$EZBLD^DIALOG(39015)) ;removed from recipient list.
"RTN","XMXADDRG",92,0)
 Q:'Y
"RTN","XMXADDRG",93,0)
 S XMLATER="?"
"RTN","XMXADDRG",94,0)
 Q
"RTN","XMXADDRG",95,0)
EXPGROUP(XMDUZ,XMG,XMGREC,XMSTRIKE,XMPREFIX,XMLATER,XMGCIRCL) ;
"RTN","XMXADDRG",96,0)
 ;Q:'$$AUTHGRP(XMDUZ,XMG,XMGREC)
"RTN","XMXADDRG",97,0)
 S XMGCIRCL(XMG)=""
"RTN","XMXADDRG",98,0)
 S $P(^XMB(3.8,XMG,0),U,4,5)=$P(XMGREC,U,4)+1_U_DT ; # references to group^date last ref'd
"RTN","XMXADDRG",99,0)
 I $G(XMIA) D
"RTN","XMXADDRG",100,0)
 . W !
"RTN","XMXADDRG",101,0)
 . D DISPCNT(XMG,1,39141) ;Local
"RTN","XMXADDRG",102,0)
 . D DISPCNT(XMG,5,39142) ;Member Group(s)
"RTN","XMXADDRG",103,0)
 . D DISPCNT(XMG,6,39143) ;Remote
"RTN","XMXADDRG",104,0)
 . D DISPCNT(XMG,7,39144) ;Distribution List(s)
"RTN","XMXADDRG",105,0)
 . D DISPCNT(XMG,8,39145) ;Fax Recipient(s)
"RTN","XMXADDRG",106,0)
 . D DISPCNT(XMG,9,39146) ;Fax Group(s)
"RTN","XMXADDRG",107,0)
 . I $X>1 W ":",!
"RTN","XMXADDRG",108,0)
 D INDIV(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER) I XMLATER,'$G(XMIA) K XMGCIRCL(XMG) Q
"RTN","XMXADDRG",109,0)
 D GROUP(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER,.XMGCIRCL) I XMLATER,'$G(XMIA) K XMGCIRCL(XMG) Q
"RTN","XMXADDRG",110,0)
 D REMOTE(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER) I XMLATER,'$G(XMIA) K XMGCIRCL(XMG) Q
"RTN","XMXADDRG",111,0)
 D DISTR^XMXADDR4(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER) I XMLATER,'$G(XMIA) K XMGCIRCL(XMG) Q
"RTN","XMXADDRG",112,0)
 I $P(^XMB(1,1,0),U,19) D FAXGROUP^XMXADDR4(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER) I XMLATER,'$G(XMIA) K XMGCIRCL(XMG) Q
"RTN","XMXADDRG",113,0)
 I $P(^XMB(1,1,0),U,19) D FAXINDIV^XMXADDR4(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER) I XMLATER,'$G(XMIA) K XMGCIRCL(XMG) Q
"RTN","XMXADDRG",114,0)
 K XMGCIRCL(XMG)
"RTN","XMXADDRG",115,0)
 Q
"RTN","XMXADDRG",116,0)
DISPCNT(XMIEN,XMNODE,XMDESCR) ;
"RTN","XMXADDRG",117,0)
 N XMCNT
"RTN","XMXADDRG",118,0)
 S XMDESCR=$$EZBLD^DIALOG(XMDESCR)
"RTN","XMXADDRG",119,0)
 S XMCNT=$P($G(^XMB(3.8,XMIEN,XMNODE,0)),U,4) Q:'XMCNT
"RTN","XMXADDRG",120,0)
 I $X+3+$L(XMCNT)+$L(XMDESCR)>IOM W ",",!
"RTN","XMXADDRG",121,0)
 E  W:$X>4 ", "
"RTN","XMXADDRG",122,0)
 W XMCNT," ",XMDESCR
"RTN","XMXADDRG",123,0)
 Q
"RTN","XMXADDRG",124,0)
AUTHGRP(XMDUZ,XMG,XMGREC) ;
"RTN","XMXADDRG",125,0)
 ; Screen:  Group is public OR user is owner
"RTN","XMXADDRG",126,0)
 ;          OR group is unrestricted and user is member
"RTN","XMXADDRG",127,0)
 N XMOWNER
"RTN","XMXADDRG",128,0)
 I $P(XMGREC,U,2)="PU" Q 1  ; Group is public
"RTN","XMXADDRG",129,0)
 S XMOWNER=$P(^XMB(3.8,XMG,3),U,1) S:XMOWNER="" XMOWNER=.5
"RTN","XMXADDRG",130,0)
 I XMDUZ=XMOWNER Q 1  ; User is owner of group
"RTN","XMXADDRG",131,0)
 I +$P(XMGREC,U,6)=0,$D(^XMB(3.8,XMG,1,"B",XMDUZ)) Q 1  ; Group is unrestricted and user is a member
"RTN","XMXADDRG",132,0)
 D SETERR^XMXADDR4($G(XMIA),"!",39147,$P(XMGREC,U,1))
"RTN","XMXADDRG",133,0)
 Q 0  ;You may not access group '|1|'.
"RTN","XMXADDRG",134,0)
INDIV(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER) ;
"RTN","XMXADDRG",135,0)
 ; XMGM     Group member
"RTN","XMXADDRG",136,0)
 N XMI,XMGM,XMCNT,XMREC,XMTYPE
"RTN","XMXADDRG",137,0)
 S XMI=0,XMCNT=0
"RTN","XMXADDRG",138,0)
 F  S XMI=$O(^XMB(3.8,XMG,1,XMI)) Q:'XMI  S XMREC=^(XMI,0) D  I XMLATER,'$G(XMIA) Q
"RTN","XMXADDRG",139,0)
 . S XMGM=$P(XMREC,U,1),XMTYPE=$P(XMREC,U,2)
"RTN","XMXADDRG",140,0)
 . ; If SHARED,MAIL or no mailbox, then delete from group.
"RTN","XMXADDRG",141,0)
 . I XMGM=.6!'$D(^XMB(3.7,XMGM))!'$D(^VA(200,XMGM,0)) D DELETE2^XMXADDR4(XMG,1,XMI) Q
"RTN","XMXADDRG",142,0)
 . N XMFULL,XMERROR,XMFWDADD
"RTN","XMXADDRG",143,0)
 . D PERSON^XMXADDR1(XMDUZ,XMGM,"","","","",.XMFULL)
"RTN","XMXADDRG",144,0)
 . I $D(XMERROR) D  Q
"RTN","XMXADDRG",145,0)
 . . ; Commenting out because I'm not sure it should be reported.
"RTN","XMXADDRG",146,0)
 . . ;S XMFULL=$P($G(^VA(200,XMGM,0)),U,1)
"RTN","XMXADDRG",147,0)
 . . ;I XMFULL="" S XMFULL="USER #"_XMGM
"RTN","XMXADDRG",148,0)
 . . ;S ^TMP("XM",$J,"GRPERR",XMG,"L",XMFULL)=XMERROR
"RTN","XMXADDRG",149,0)
 . S XMGMBRS=1
"RTN","XMXADDRG",150,0)
 . I 'XMLATER D INDIV^XMXADDR(XMDUZ,XMGM,XMSTRIKE,$S(XMPREFIX'="":XMPREFIX,1:XMTYPE),XMLATER)
"RTN","XMXADDRG",151,0)
 . Q:'$G(XMIA)
"RTN","XMXADDRG",152,0)
 . I XMCNT,XMCNT#16=0 D  Q:'$G(XMIA)
"RTN","XMXADDRG",153,0)
 . . N DIR,Y
"RTN","XMXADDRG",154,0)
 . . S DIR("A")=$$EZBLD^DIALOG(39148) ;Do you want to see more members
"RTN","XMXADDRG",155,0)
 . . S DIR(0)="Y",DIR("B")=$$EZBLD^DIALOG(39053) ;No
"RTN","XMXADDRG",156,0)
 . . D ^DIR
"RTN","XMXADDRG",157,0)
 . . S XMIA=+Y  ; The '+' takes care of $D(DIRUT)
"RTN","XMXADDRG",158,0)
 . S XMCNT=XMCNT+1
"RTN","XMXADDRG",159,0)
 . W:XMCNT#4-1=0 !
"RTN","XMXADDRG",160,0)
 . W ?XMCNT-1#4*20,$E($S(XMPREFIX'="":XMPREFIX_":",XMTYPE="":"",1:XMTYPE_":")_XMFULL,1,19)
"RTN","XMXADDRG",161,0)
 Q
"RTN","XMXADDRG",162,0)
GROUP(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER,XMGCIRCL) ;
"RTN","XMXADDRG",163,0)
 N XMIEN,XMI,XMREC,XMTYPE
"RTN","XMXADDRG",164,0)
 S XMI=0
"RTN","XMXADDRG",165,0)
 F  S XMI=$O(^XMB(3.8,XMG,5,XMI)) Q:'XMI  S XMREC=^(XMI,0) D  I XMLATER,'$G(XMIA) Q
"RTN","XMXADDRG",166,0)
 . S XMIEN=$P(XMREC,U,1),XMTYPE=$P(XMREC,U,2)
"RTN","XMXADDRG",167,0)
 . I '$D(^XMB(3.8,XMIEN,0)) D DELETE2^XMXADDR4(XMG,5,XMI) Q
"RTN","XMXADDRG",168,0)
 . S XMREC=^XMB(3.8,XMIEN,0)
"RTN","XMXADDRG",169,0)
 . W:$G(XMIA) !,$S(XMPREFIX'="":"",XMTYPE="":"",1:XMTYPE_":"),"G.",$P(XMREC,U,1),":"
"RTN","XMXADDRG",170,0)
 . I $D(XMGCIRCL(XMIEN)) D  Q
"RTN","XMXADDRG",171,0)
 . . ; Circular (infinite loop) reference!  Don't go there!
"RTN","XMXADDRG",172,0)
 . . S ^TMP("XM",$J,"GRPERR",XMG,"C",$P(XMREC,U,1))="" Q
"RTN","XMXADDRG",173,0)
 . . Q:'$G(XMIASAVE)
"RTN","XMXADDRG",174,0)
 . . N XMTEXT
"RTN","XMXADDRG",175,0)
 . . ;Mail group contains circular reference to G.|1|.
"RTN","XMXADDRG",176,0)
 . . ;Circular reference ignored.
"RTN","XMXADDRG",177,0)
 . . ;This circular reference should be investigated and eliminated.
"RTN","XMXADDRG",178,0)
 . . D BLD^DIALOG(39140,$P(XMGREC,U,1),"","XMTEXT","F")
"RTN","XMXADDRG",179,0)
 . . D MSG^DIALOG("WE","","","","XMTEXT")
"RTN","XMXADDRG",180,0)
 . D EXPGROUP(XMDUZ,XMIEN,XMREC,XMSTRIKE,$S(XMPREFIX'="":XMPREFIX,1:XMTYPE),XMLATER,.XMGCIRCL)
"RTN","XMXADDRG",181,0)
 . W:$G(XMIA) !,$$EZBLD^DIALOG(39149,$P(XMREC,U,1)) ;Finished with group |1|.
"RTN","XMXADDRG",182,0)
 Q
"RTN","XMXADDRG",183,0)
REMOTE(XMDUZ,XMG,XMSTRIKE,XMPREFIX,XMLATER) ;
"RTN","XMXADDRG",184,0)
 N XMGM,XMI
"RTN","XMXADDRG",185,0)
 S XMI=0
"RTN","XMXADDRG",186,0)
 F  S XMI=$O(^XMB(3.8,XMG,6,XMI)) Q:XMI'>0  D  I XMLATER,'$G(XMIA) Q
"RTN","XMXADDRG",187,0)
 . S XMGM=$P(^XMB(3.8,XMG,6,XMI,0),U)
"RTN","XMXADDRG",188,0)
 . Q:XMGM=""  ; Really should delete it from the remotes.
"RTN","XMXADDRG",189,0)
 . W:$G(XMIA) !,XMGM
"RTN","XMXADDRG",190,0)
 . Q:XMLATER
"RTN","XMXADDRG",191,0)
 . D DOREMOTE(XMDUZ,XMGM,XMSTRIKE,XMPREFIX,XMLATER)
"RTN","XMXADDRG",192,0)
 Q
"RTN","XMXADDRG",193,0)
DOREMOTE(XMDUZ,XMGM,XMSTRIKE,XMPREFIX,XMLATER) ;
"RTN","XMXADDRG",194,0)
 N XMERROR,XMFWDADD
"RTN","XMXADDRG",195,0)
 I XMGM[":" D  Q:$D(XMERROR)
"RTN","XMXADDRG",196,0)
 . I XMPREFIX="" D
"RTN","XMXADDRG",197,0)
 . . D PREFIX^XMXADDR(.XMGM,.XMPREFIX)
"RTN","XMXADDRG",198,0)
 . E  D
"RTN","XMXADDRG",199,0)
 . . D PREFIX^XMXADDR(.XMGM)
"RTN","XMXADDRG",200,0)
 . I $D(XMERROR) S ^TMP("XM",$J,"GRPERR",XMG,"R",XMGM)=$$GETERR^XMXADDR4
"RTN","XMXADDRG",201,0)
 D REMOTE^XMXADDR3(XMDUZ,XMGM,XMSTRIKE,XMPREFIX,XMLATER)
"RTN","XMXADDRG",202,0)
 I '$D(XMERROR) S XMGMBRS=1 Q
"RTN","XMXADDRG",203,0)
 ;37000 - up-arrow out.
"RTN","XMXADDRG",204,0)
 ;37001 - time out.
"RTN","XMXADDRG",205,0)
 ;37002 - up-arrow or time out.
"RTN","XMXADDRG",206,0)
 ;39015.1 - Not a current recipient.
"RTN","XMXADDRG",207,0)
 ;39133 - Sender not authorized to group.
"RTN","XMXADDRG",208,0)
 I "^37000^37001^37002^39015.1^39133^"[(U_XMERROR_U) S XMGMBRS=1 Q
"RTN","XMXADDRG",209,0)
 S ^TMP("XM",$J,"GRPERR",XMG,"R",XMGM)=$$GETERR^XMXADDR4
"RTN","XMXADDRG",210,0)
 Q
"RTN","XMYP18")
0^^B232665
"RTN","XMYP18",1,0)
XMYP18 ;ISC-SF/GMB-Post- Init ;04/28/2003  10:24
"RTN","XMYP18",2,0)
 ;;8.0;MailMan;**18**;Jun 28, 2002
"RTN","XMYP18",3,0)
POST ; Post-init
"RTN","XMYP18",4,0)
 Q:^XMB("NETNAME")'[".VA.GOV"
"RTN","XMYP18",5,0)
 S ^XMB(1,1,3)=1 ; field 31: AUTO-FORWARD LIMITED?
"RTN","XMYP18",6,0)
 ; field 31.1: AUTO-FORWARD APPROVED SITE
"RTN","XMYP18",7,0)
 N XMFDA
"RTN","XMYP18",8,0)
 S XMFDA(4.33,"+1,1,",.01)=".VA.GOV"
"RTN","XMYP18",9,0)
 D UPDATE^DIE("","XMFDA")
"RTN","XMYP18",10,0)
 Q
"UP",4.3,4.33,-1)
4.3^3.1
"UP",4.3,4.33,0)
4.33
"UP",4.3,4.34,-1)
4.3^3.2
"UP",4.3,4.34,0)
4.34
"VER")
8.0^22.0
"^DD",4.3,4.3,31,0)
AUTO-FORWARD LIMITED?^S^0:NO;1:YES;^3;1^Q
"^DD",4.3,4.3,31,3)
Should auto-forward capability be limited?
"^DD",4.3,4.3,31,21,0)
^^10^10^3030415^^
"^DD",4.3,4.3,31,21,1,0)
For security or privacy reasons, you may wish to limit the sites to which
"^DD",4.3,4.3,31,21,2,0)
users may have their mail auto-forwarded.  If so, set this field to YES,
"^DD",4.3,4.3,31,21,3,0)
and enter the approved sites in the AUTO-FORWARD APPROVED SITE multiple.
"^DD",4.3,4.3,31,21,4,0)

"^DD",4.3,4.3,31,21,5,0)
For VA sites, this field must be set to YES.  The only approved sites are
"^DD",4.3,4.3,31,21,6,0)
those ending in ".VA.GOV".
"^DD",4.3,4.3,31,21,7,0)

"^DD",4.3,4.3,31,21,8,0)
If this field is set to YES, MailMan will limit auto-forwarding to only
"^DD",4.3,4.3,31,21,9,0)
those sites whose names are in (or end in the ones in) the AUTO-FORWARD
"^DD",4.3,4.3,31,21,10,0)
APPROVED SITE multiple.
"^DD",4.3,4.3,31,"DT")
3030415
"^DD",4.3,4.3,31.1,0)
AUTO-FORWARD APPROVED SITE^4.33^^3.1;0
"^DD",4.3,4.3,31.2,0)
AUTO-FORWARD WAIVER SITE^4.34^^3.2;0
"^DD",4.3,4.3,31.2,"DT")
3030414
"^DD",4.3,4.33,0)
AUTO-FORWARD APPROVED SITE SUB-FIELD^^.01^1
"^DD",4.3,4.33,0,"DT")
3030414
"^DD",4.3,4.33,0,"IX","B",4.33,.01)

"^DD",4.3,4.33,0,"NM","AUTO-FORWARD APPROVED SITE")

"^DD",4.3,4.33,0,"UP")
4.3
"^DD",4.3,4.33,.01,0)
AUTO-FORWARD APPROVED SITE^MF^^0;1^K:$L(X)>64!($L(X)<3) X
"^DD",4.3,4.33,.01,1,0)
^.1
"^DD",4.3,4.33,.01,1,1,0)
4.33^B
"^DD",4.3,4.33,.01,1,1,1)
S ^XMB(1,DA(1),3.1,"B",$E(X,1,64),DA)=""
"^DD",4.3,4.33,.01,1,1,2)
K ^XMB(1,DA(1),3.1,"B",$E(X,1,64),DA)
"^DD",4.3,4.33,.01,3)
Answer must be 3-64 characters in length.
"^DD",4.3,4.33,.01,21,0)
^^5^5^3030414^^
"^DD",4.3,4.33,.01,21,1,0)
If the AUTO-FORWARD LIMIT? (#31) field is set to YES, auto-forward addresses
"^DD",4.3,4.33,.01,21,2,0)
are limited to sites which are listed here, or which end in those which are
"^DD",4.3,4.33,.01,21,3,0)
listed here.
"^DD",4.3,4.33,.01,21,4,0)

"^DD",4.3,4.33,.01,21,5,0)
For VA sites, the one and only entry should be ".VA.GOV".
"^DD",4.3,4.33,.01,"DT")
3030414
"^DD",4.3,4.34,0)
AUTO-FORWARD WAIVER SITE SUB-FIELD^^.01^1
"^DD",4.3,4.34,0,"DT")
3030414
"^DD",4.3,4.34,0,"IX","B",4.34,.01)

"^DD",4.3,4.34,0,"NM","AUTO-FORWARD WAIVER SITE")

"^DD",4.3,4.34,0,"UP")
4.3
"^DD",4.3,4.34,.01,0)
AUTO-FORWARD WAIVER SITE^MF^^0;1^K:$L(X)>64!($L(X)<3) X
"^DD",4.3,4.34,.01,1,0)
^.1
"^DD",4.3,4.34,.01,1,1,0)
4.34^B
"^DD",4.3,4.34,.01,1,1,1)
S ^XMB(1,DA(1),3.2,"B",$E(X,1,64),DA)=""
"^DD",4.3,4.34,.01,1,1,2)
K ^XMB(1,DA(1),3.2,"B",$E(X,1,64),DA)
"^DD",4.3,4.34,.01,3)
Answer must be 3-64 characters in length.
"^DD",4.3,4.34,.01,21,0)
^.001^11^11^3030415^^^^
"^DD",4.3,4.34,.01,21,1,0)
If the AUTO-FORWARD LIMIT? (#31) field is set to YES, auto-forward
"^DD",4.3,4.34,.01,21,2,0)
addresses are limited to sites in the AUTO-FORWARD APPROVED SITE (#31.1)
"^DD",4.3,4.34,.01,21,3,0)
multiple.
"^DD",4.3,4.34,.01,21,4,0)

"^DD",4.3,4.34,.01,21,5,0)
However, any user who has been assigned the XM AUTO-FORWARD WAIVER
"^DD",4.3,4.34,.01,21,6,0)
security key, may also auto-forward to the sites which are listed here,
"^DD",4.3,4.34,.01,21,7,0)
or which end in those which are listed here.
"^DD",4.3,4.34,.01,21,8,0)

"^DD",4.3,4.34,.01,21,9,0)
Requests for waivers must be submitted through the site Information Security
"^DD",4.3,4.34,.01,21,10,0)
Officer (ISO).  Only after a waiver has been granted may a site be added
"^DD",4.3,4.34,.01,21,11,0)
here.  Check with the ISO for details on the requirements for the waiver.
"^DD",4.3,4.34,.01,"DT")
3030415
**END**
**END**
