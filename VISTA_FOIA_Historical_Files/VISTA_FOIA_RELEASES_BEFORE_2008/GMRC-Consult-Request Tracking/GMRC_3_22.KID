KIDS Distribution saved on Apr 04, 2002@15:33:33
Released GMRC*3*22
**KIDS**:GMRC*3.0*22^

**INSTALL NAME**
GMRC*3.0*22
"BLD",3387,0)
GMRC*3.0*22^CONSULT/REQUEST TRACKING^0^3020404^y
"BLD",3387,1,0)
^^2^2^3020402^
"BLD",3387,1,1,0)
This BUILD includes the Inter-facility Consults enhancement. See the 
"BLD",3387,1,2,0)
National Patch Module for full details.
"BLD",3387,4,0)
^9.64PA^123.1^5
"BLD",3387,4,123,0)
123
"BLD",3387,4,123,2,0)
^9.641^123.051^3
"BLD",3387,4,123,2,123,0)
REQUEST/CONSULTATION  (File-top level)
"BLD",3387,4,123,2,123,1,0)
^9.6411^.126^8
"BLD",3387,4,123,2,123,1,.06,0)
REMOTE CONSULT FILE ENTRY
"BLD",3387,4,123,2,123,1,.07,0)
ROUTING FACILITY
"BLD",3387,4,123,2,123,1,.125,0)
IFC ROLE
"BLD",3387,4,123,2,123,1,.126,0)
REMOTE ORDERING PROVIDER
"BLD",3387,4,123,2,123,1,.131,0)
IFC REMOTE SERVICE NAME
"BLD",3387,4,123,2,123,1,.132,0)
REMOTE REQUESTOR PHONE
"BLD",3387,4,123,2,123,1,.133,0)
REMOTE REQUESTOR DIG PAGER
"BLD",3387,4,123,2,123,1,10,0)
SENDING PROVIDER
"BLD",3387,4,123,2,123.02,0)
REQUEST PROCESSING ACTIVITY  (sub-file)
"BLD",3387,4,123,2,123.02,1,0)
^9.6411^2^8
"BLD",3387,4,123,2,123.02,1,.21,0)
REMOTE ENTERING PERSON
"BLD",3387,4,123,2,123.02,1,.22,0)
REMOTE RESPONSIBLE PERSON
"BLD",3387,4,123,2,123.02,1,.23,0)
REMOTE ACTIVITY TIME ZONE
"BLD",3387,4,123,2,123.02,1,.24,0)
REMOTE RESULT
"BLD",3387,4,123,2,123.02,1,.25,0)
REMOTE DATE/TIME OF FILING
"BLD",3387,4,123,2,123.02,1,.31,0)
PREVIOUS REMOTE SERVICE NAME
"BLD",3387,4,123,2,123.02,1,1,0)
ACTIVITY
"BLD",3387,4,123,2,123.02,1,2,0)
DATE/TIME OF ACTUAL ACTIVITY
"BLD",3387,4,123,2,123.051,0)
REMOTE RESULTS  (sub-file)
"BLD",3387,4,123,2,123.051,1,0)
^9.6411^^
"BLD",3387,4,123,222)
y^n^p^^^^n
"BLD",3387,4,123.1,0)
123.1
"BLD",3387,4,123.1,222)
n^y^f^^n^^y^o^n
"BLD",3387,4,123.1,224)
I Y=23!(Y=24)!(Y=25)
"BLD",3387,4,123.3,0)
123.3
"BLD",3387,4,123.3,2,0)
^9.641^123.3128^2
"BLD",3387,4,123.3,2,123.3,0)
GMRC PROCEDURE  (File-top level)
"BLD",3387,4,123.3,2,123.3,1,0)
^9.6411^3^4
"BLD",3387,4,123.3,2,123.3,1,3,0)
INTERNAL NAME
"BLD",3387,4,123.3,2,123.3,1,126,0)
IFC ROUTING SITE
"BLD",3387,4,123.3,2,123.3,1,127,0)
IFC REMOTE PROC NAME
"BLD",3387,4,123.3,2,123.3,1,129,0)
IFC COORDINATOR
"BLD",3387,4,123.3,2,123.3128,0)
IFC SENDING FACILITY  (sub-file)
"BLD",3387,4,123.3,2,123.3128,1,0)
^9.6411^^
"BLD",3387,4,123.3,222)
y^n^p^^^^n
"BLD",3387,4,123.5,0)
123.5
"BLD",3387,4,123.5,2,0)
^9.641^123.5134^2
"BLD",3387,4,123.5,2,123.5,0)
REQUEST SERVICES  (File-top level)
"BLD",3387,4,123.5,2,123.5,1,0)
^9.6411^11^4
"BLD",3387,4,123.5,2,123.5,1,11,0)
INTERNAL NAME
"BLD",3387,4,123.5,2,123.5,1,132,0)
IFC ROUTING SITE
"BLD",3387,4,123.5,2,123.5,1,133,0)
IFC REMOTE NAME
"BLD",3387,4,123.5,2,123.5,1,135,0)
IFC COORDINATOR
"BLD",3387,4,123.5,2,123.5134,0)
IFC SENDING FACILITY  (sub-file)
"BLD",3387,4,123.5,2,123.5134,1,0)
^9.6411^^
"BLD",3387,4,123.5,222)
y^n^p^^^^n
"BLD",3387,4,123.6,0)
123.6
"BLD",3387,4,123.6,222)
y^y^f^^^^n
"BLD",3387,4,"APDD",123,123)

"BLD",3387,4,"APDD",123,123,.06)

"BLD",3387,4,"APDD",123,123,.07)

"BLD",3387,4,"APDD",123,123,.125)

"BLD",3387,4,"APDD",123,123,.126)

"BLD",3387,4,"APDD",123,123,.131)

"BLD",3387,4,"APDD",123,123,.132)

"BLD",3387,4,"APDD",123,123,.133)

"BLD",3387,4,"APDD",123,123,10)

"BLD",3387,4,"APDD",123,123.02)

"BLD",3387,4,"APDD",123,123.02,.21)

"BLD",3387,4,"APDD",123,123.02,.22)

"BLD",3387,4,"APDD",123,123.02,.23)

"BLD",3387,4,"APDD",123,123.02,.24)

"BLD",3387,4,"APDD",123,123.02,.25)

"BLD",3387,4,"APDD",123,123.02,.31)

"BLD",3387,4,"APDD",123,123.02,1)

"BLD",3387,4,"APDD",123,123.02,2)

"BLD",3387,4,"APDD",123,123.051)

"BLD",3387,4,"APDD",123.3,123.3)

"BLD",3387,4,"APDD",123.3,123.3,3)

"BLD",3387,4,"APDD",123.3,123.3,126)

"BLD",3387,4,"APDD",123.3,123.3,127)

"BLD",3387,4,"APDD",123.3,123.3,129)

"BLD",3387,4,"APDD",123.3,123.3128)

"BLD",3387,4,"APDD",123.5,123.5)

"BLD",3387,4,"APDD",123.5,123.5,11)

"BLD",3387,4,"APDD",123.5,123.5,132)

"BLD",3387,4,"APDD",123.5,123.5,133)

"BLD",3387,4,"APDD",123.5,123.5,135)

"BLD",3387,4,"APDD",123.5,123.5134)

"BLD",3387,4,"B",123,123)

"BLD",3387,4,"B",123.1,123.1)

"BLD",3387,4,"B",123.3,123.3)

"BLD",3387,4,"B",123.5,123.5)

"BLD",3387,4,"B",123.6,123.6)

"BLD",3387,"INID")
^
"BLD",3387,"INIT")

"BLD",3387,"KRN",0)
^9.67PA^8989.52^19
"BLD",3387,"KRN",.4,0)
.4
"BLD",3387,"KRN",.401,0)
.401
"BLD",3387,"KRN",.402,0)
.402
"BLD",3387,"KRN",.402,"NM",0)
^9.68A^2^2
"BLD",3387,"KRN",.402,"NM",1,0)
GMRC SETUP REQUEST SERVICE    FILE #123.5^123.5^0
"BLD",3387,"KRN",.402,"NM",2,0)
GMRC PROCEDURE SETUP    FILE #123.3^123.3^0
"BLD",3387,"KRN",.402,"NM","B","GMRC PROCEDURE SETUP    FILE #123.3",2)

"BLD",3387,"KRN",.402,"NM","B","GMRC SETUP REQUEST SERVICE    FILE #123.5",1)

"BLD",3387,"KRN",.403,0)
.403
"BLD",3387,"KRN",.5,0)
.5
"BLD",3387,"KRN",.84,0)
.84
"BLD",3387,"KRN",3.6,0)
3.6
"BLD",3387,"KRN",3.8,0)
3.8
"BLD",3387,"KRN",3.8,"NM",0)
^9.68A^3^3
"BLD",3387,"KRN",3.8,"NM",1,0)
IFC CLIN ERRORS^^0
"BLD",3387,"KRN",3.8,"NM",2,0)
IFC TECH ERRORS^^0
"BLD",3387,"KRN",3.8,"NM",3,0)
IFC PATIENT ERROR MESSAGES^^0
"BLD",3387,"KRN",3.8,"NM","B","IFC CLIN ERRORS",1)

"BLD",3387,"KRN",3.8,"NM","B","IFC PATIENT ERROR MESSAGES",3)

"BLD",3387,"KRN",3.8,"NM","B","IFC TECH ERRORS",2)

"BLD",3387,"KRN",9.2,0)
9.2
"BLD",3387,"KRN",9.2,"NM",0)
^9.68A^^
"BLD",3387,"KRN",9.8,0)
9.8
"BLD",3387,"KRN",9.8,"NM",0)
^9.68A^59^58
"BLD",3387,"KRN",9.8,"NM",1,0)
GMRCIAC1^^0^B64026480
"BLD",3387,"KRN",9.8,"NM",2,0)
GMRCIAC2^^0^B38286349
"BLD",3387,"KRN",9.8,"NM",3,0)
GMRCIACT^^0^B58449814
"BLD",3387,"KRN",9.8,"NM",4,0)
GMRCIBKG^^0^B26231165
"BLD",3387,"KRN",9.8,"NM",5,0)
GMRCIERR^^0^B52568549
"BLD",3387,"KRN",9.8,"NM",6,0)
GMRCIEV1^^0^B30337425
"BLD",3387,"KRN",9.8,"NM",7,0)
GMRCIEVT^^0^B46854845
"BLD",3387,"KRN",9.8,"NM",8,0)
GMRCIMSG^^0^B21948665
"BLD",3387,"KRN",9.8,"NM",9,0)
GMRCINC^^0^B31742816
"BLD",3387,"KRN",9.8,"NM",10,0)
GMRCISEG^^0^B29580709
"BLD",3387,"KRN",9.8,"NM",11,0)
GMRCISG1^^0^B26938225
"BLD",3387,"KRN",9.8,"NM",12,0)
GMRCIUTL^^0^B29858704
"BLD",3387,"KRN",9.8,"NM",13,0)
GMRCASV^^0^B64890269
"BLD",3387,"KRN",9.8,"NM",14,0)
GMRCSTL2^^0^B30799061
"BLD",3387,"KRN",9.8,"NM",15,0)
GMRCSTLM^^0^B82358343
"BLD",3387,"KRN",9.8,"NM",16,0)
GMRCSTL1^^0^B16566727
"BLD",3387,"KRN",9.8,"NM",17,0)
GMRCPC^^0^B10819119
"BLD",3387,"KRN",9.8,"NM",18,0)
GMRCSLM2^^0^B58749629
"BLD",3387,"KRN",9.8,"NM",19,0)
GMRCSLM4^^0^B35674872
"BLD",3387,"KRN",9.8,"NM",20,0)
GMRCTIUP^^0^B20610246
"BLD",3387,"KRN",9.8,"NM",21,0)
GMRCART^^0^B68881545
"BLD",3387,"KRN",9.8,"NM",22,0)
GMRCP5A^^0^B74868100
"BLD",3387,"KRN",9.8,"NM",23,0)
GMRCGUIB^^0^B38678179
"BLD",3387,"KRN",9.8,"NM",24,0)
GMRCP^^0^B12740937
"BLD",3387,"KRN",9.8,"NM",25,0)
GMRCHL7U^^0^B23953120
"BLD",3387,"KRN",9.8,"NM",26,0)
GMRCHL7B^^0^B22430425
"BLD",3387,"KRN",9.8,"NM",27,0)
GMRCAU^^0^B65349968
"BLD",3387,"KRN",9.8,"NM",28,0)
GMRCACTM^^0^B6768099
"BLD",3387,"KRN",9.8,"NM",29,0)
GMRCGUIC^^0^B50329951
"BLD",3387,"KRN",9.8,"NM",30,0)
GMRCEDT1^^0^B37918500
"BLD",3387,"KRN",9.8,"NM",31,0)
GMRCEDT2^^0^B15605173
"BLD",3387,"KRN",9.8,"NM",32,0)
GMRCEDT3^^0^B15652021
"BLD",3387,"KRN",9.8,"NM",33,0)
GMRCEDT4^^0^B72310406
"BLD",3387,"KRN",9.8,"NM",34,0)
GMRCGUIU^^0^B29044760
"BLD",3387,"KRN",9.8,"NM",35,0)
GMRCDIS^^0^B32914586
"BLD",3387,"KRN",9.8,"NM",37,0)
GMRCITST^^0^B18676001
"BLD",3387,"KRN",9.8,"NM",38,0)
GMRCIR^^0^B34893714
"BLD",3387,"KRN",9.8,"NM",39,0)
GMRCITR^^0^B35634845
"BLD",3387,"KRN",9.8,"NM",40,0)
GMRCP5D^^0^B45656870
"BLD",3387,"KRN",9.8,"NM",41,0)
GMRCP5B^^0^B38799733
"BLD",3387,"KRN",9.8,"NM",42,0)
GMRCAFRD^^0^B35065187
"BLD",3387,"KRN",9.8,"NM",43,0)
GMRCGUIA^^0^B45802159
"BLD",3387,"KRN",9.8,"NM",44,0)
GMRCILKP^^0^B5121604
"BLD",3387,"KRN",9.8,"NM",45,0)
GMRCASV1^^0^B4425153
"BLD",3387,"KRN",9.8,"NM",46,0)
GMRCPSL2^^0^B61336942
"BLD",3387,"KRN",9.8,"NM",47,0)
GMRCPSL3^^0^B66312673
"BLD",3387,"KRN",9.8,"NM",48,0)
GMRCPSL4^^0^B6086417
"BLD",3387,"KRN",9.8,"NM",49,0)
GMRCACMT^^0^B24714854
"BLD",3387,"KRN",9.8,"NM",50,0)
GMRCSLM^^0^B38790135
"BLD",3387,"KRN",9.8,"NM",51,0)
GMRCSLM1^^0^B55642136
"BLD",3387,"KRN",9.8,"NM",52,0)
GMRCASF^^0^B13068944
"BLD",3387,"KRN",9.8,"NM",53,0)
GMRCQC^^0^B2459309
"BLD",3387,"KRN",9.8,"NM",54,0)
GMRCQCST^^0^B26009200
"BLD",3387,"KRN",9.8,"NM",55,0)
GMRCIBKM^^0^B13637196
"BLD",3387,"KRN",9.8,"NM",56,0)
GMRCTIU^^0^B16773527
"BLD",3387,"KRN",9.8,"NM",57,0)
GMRCPSL1^^0^B77326174
"BLD",3387,"KRN",9.8,"NM",58,0)
GMRCHL7A^^0^B30106209
"BLD",3387,"KRN",9.8,"NM",59,0)
GMRCITPI^^0^B12566886
"BLD",3387,"KRN",9.8,"NM","B","GMRCACMT",49)

"BLD",3387,"KRN",9.8,"NM","B","GMRCACTM",28)

"BLD",3387,"KRN",9.8,"NM","B","GMRCAFRD",42)

"BLD",3387,"KRN",9.8,"NM","B","GMRCART",21)

"BLD",3387,"KRN",9.8,"NM","B","GMRCASF",52)

"BLD",3387,"KRN",9.8,"NM","B","GMRCASV",13)

"BLD",3387,"KRN",9.8,"NM","B","GMRCASV1",45)

"BLD",3387,"KRN",9.8,"NM","B","GMRCAU",27)

"BLD",3387,"KRN",9.8,"NM","B","GMRCDIS",35)

"BLD",3387,"KRN",9.8,"NM","B","GMRCEDT1",30)

"BLD",3387,"KRN",9.8,"NM","B","GMRCEDT2",31)

"BLD",3387,"KRN",9.8,"NM","B","GMRCEDT3",32)

"BLD",3387,"KRN",9.8,"NM","B","GMRCEDT4",33)

"BLD",3387,"KRN",9.8,"NM","B","GMRCGUIA",43)

"BLD",3387,"KRN",9.8,"NM","B","GMRCGUIB",23)

"BLD",3387,"KRN",9.8,"NM","B","GMRCGUIC",29)

"BLD",3387,"KRN",9.8,"NM","B","GMRCGUIU",34)

"BLD",3387,"KRN",9.8,"NM","B","GMRCHL7A",58)

"BLD",3387,"KRN",9.8,"NM","B","GMRCHL7B",26)

"BLD",3387,"KRN",9.8,"NM","B","GMRCHL7U",25)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIAC1",1)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIAC2",2)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIACT",3)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIBKG",4)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIBKM",55)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIERR",5)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIEV1",6)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIEVT",7)

"BLD",3387,"KRN",9.8,"NM","B","GMRCILKP",44)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIMSG",8)

"BLD",3387,"KRN",9.8,"NM","B","GMRCINC",9)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIR",38)

"BLD",3387,"KRN",9.8,"NM","B","GMRCISEG",10)

"BLD",3387,"KRN",9.8,"NM","B","GMRCISG1",11)

"BLD",3387,"KRN",9.8,"NM","B","GMRCITPI",59)

"BLD",3387,"KRN",9.8,"NM","B","GMRCITR",39)

"BLD",3387,"KRN",9.8,"NM","B","GMRCITST",37)

"BLD",3387,"KRN",9.8,"NM","B","GMRCIUTL",12)

"BLD",3387,"KRN",9.8,"NM","B","GMRCP",24)

"BLD",3387,"KRN",9.8,"NM","B","GMRCP5A",22)

"BLD",3387,"KRN",9.8,"NM","B","GMRCP5B",41)

"BLD",3387,"KRN",9.8,"NM","B","GMRCP5D",40)

"BLD",3387,"KRN",9.8,"NM","B","GMRCPC",17)

"BLD",3387,"KRN",9.8,"NM","B","GMRCPSL1",57)

"BLD",3387,"KRN",9.8,"NM","B","GMRCPSL2",46)

"BLD",3387,"KRN",9.8,"NM","B","GMRCPSL3",47)

"BLD",3387,"KRN",9.8,"NM","B","GMRCPSL4",48)

"BLD",3387,"KRN",9.8,"NM","B","GMRCQC",53)

"BLD",3387,"KRN",9.8,"NM","B","GMRCQCST",54)

"BLD",3387,"KRN",9.8,"NM","B","GMRCSLM",50)

"BLD",3387,"KRN",9.8,"NM","B","GMRCSLM1",51)

"BLD",3387,"KRN",9.8,"NM","B","GMRCSLM2",18)

"BLD",3387,"KRN",9.8,"NM","B","GMRCSLM4",19)

"BLD",3387,"KRN",9.8,"NM","B","GMRCSTL1",16)

"BLD",3387,"KRN",9.8,"NM","B","GMRCSTL2",14)

"BLD",3387,"KRN",9.8,"NM","B","GMRCSTLM",15)

"BLD",3387,"KRN",9.8,"NM","B","GMRCTIU",56)

"BLD",3387,"KRN",9.8,"NM","B","GMRCTIUP",20)

"BLD",3387,"KRN",19,0)
19
"BLD",3387,"KRN",19,"NM",0)
^9.68A^15^15
"BLD",3387,"KRN",19,"NM",1,0)
GMRC IFC INC TRANS^^0
"BLD",3387,"KRN",19,"NM",2,0)
GMRC IFC RPT CONSULTS^^0
"BLD",3387,"KRN",19,"NM",3,0)
GMRC REPORTS^^2
"BLD",3387,"KRN",19,"NM",4,0)
GMRC IFC TEST SETUP^^0
"BLD",3387,"KRN",19,"NM",5,0)
GMRC MGR^^2
"BLD",3387,"KRN",19,"NM",6,0)
GMRC IFC TRANS^^0
"BLD",3387,"KRN",19,"NM",7,0)
GMRC IFC MGMT^^0
"BLD",3387,"KRN",19,"NM",8,0)
GMRC IFC REMOTE NUMBER^^0
"BLD",3387,"KRN",19,"NM",9,0)
GMRC IFC PRINT RPT NUMBERED^^0
"BLD",3387,"KRN",19,"NM",10,0)
GMRC IFC RPT CONSULTS BY PT^^0
"BLD",3387,"KRN",19,"NM",11,0)
GMRC IFC RPT CONSULTS BY REMPR^^0
"BLD",3387,"KRN",19,"NM",12,0)
GMRC IFC BACKGROUND STARTUP^^0
"BLD",3387,"KRN",19,"NM",13,0)
GMRC IFC BKG PARAM MON^^0
"BLD",3387,"KRN",19,"NM",14,0)
GMRC PRINT BY SEARCH^^0
"BLD",3387,"KRN",19,"NM",15,0)
GMRC IFC TEST PT MPI^^0
"BLD",3387,"KRN",19,"NM","B","GMRC IFC BACKGROUND STARTUP",12)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC BKG PARAM MON",13)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC INC TRANS",1)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC MGMT",7)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC PRINT RPT NUMBERED",9)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC REMOTE NUMBER",8)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC RPT CONSULTS",2)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC RPT CONSULTS BY PT",10)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC RPT CONSULTS BY REMPR",11)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC TEST PT MPI",15)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC TEST SETUP",4)

"BLD",3387,"KRN",19,"NM","B","GMRC IFC TRANS",6)

"BLD",3387,"KRN",19,"NM","B","GMRC MGR",5)

"BLD",3387,"KRN",19,"NM","B","GMRC PRINT BY SEARCH",14)

"BLD",3387,"KRN",19,"NM","B","GMRC REPORTS",3)

"BLD",3387,"KRN",19.1,0)
19.1
"BLD",3387,"KRN",101,0)
101
"BLD",3387,"KRN",101,"NM",0)
^9.68A^24^24
"BLD",3387,"KRN",101,"NM",1,0)
GMRC IF RETRANSMIT ACTIVITY^^0
"BLD",3387,"KRN",101,"NM",2,0)
GMRC IF SELECT NEW CONSULT^^0
"BLD",3387,"KRN",101,"NM",3,0)
GMRCIFM INCOMPLETE TRANS MENU^^0
"BLD",3387,"KRN",101,"NM",4,0)
GMRC IF COLUMN WIDTH MESSAGE^^0
"BLD",3387,"KRN",101,"NM",5,0)
GMRC IF COLUMN WIDTH PRINT LIST^^0
"BLD",3387,"KRN",101,"NM",6,0)
GMRC IF CONSLTS SELECT NUMBERED^^0
"BLD",3387,"KRN",101,"NM",7,0)
GMRC IF CONSLTS SELECT SERVICE^^0
"BLD",3387,"KRN",101,"NM",8,0)
GMRC IF CONSLTS SELECT STATUS^^0
"BLD",3387,"KRN",101,"NM",9,0)
GMRC IFC ORM EVENT^^0
"BLD",3387,"KRN",101,"NM",10,0)
GMRC IFC SUBSC^^0
"BLD",3387,"KRN",101,"NM",11,0)
GMRC OUTSTD CONSLTS SELECT NUMBERED^^0
"BLD",3387,"KRN",101,"NM",12,0)
GMRC OUTSTD CONSLTS SELECT SERVICE^^0
"BLD",3387,"KRN",101,"NM",13,0)
GMRC OUTSTD CONSLTS SELECT STATUS^^0
"BLD",3387,"KRN",101,"NM",14,0)
GMRC IFC ORM TEST^^0
"BLD",3387,"KRN",101,"NM",15,0)
GMRC IF QC CONSULTS^^0
"BLD",3387,"KRN",101,"NM",16,0)
GMRCIFM TRANS MENU^^0
"BLD",3387,"KRN",101,"NM",17,0)
GMRC IF MRK TRANSACTION COMP^^0
"BLD",3387,"KRN",101,"NM",18,0)
VALM PRINT LIST^^0
"BLD",3387,"KRN",101,"NM",19,0)
GMRC IF CONSLTS DESCRIPTION^^0
"BLD",3387,"KRN",101,"NM",20,0)
GMRC IF DETAILED DISPLAY^^0
"BLD",3387,"KRN",101,"NM",21,0)
GMRC IF CHANGE VIEW^^0
"BLD",3387,"KRN",101,"NM",22,0)
GMRCIFM BKG PARAM MENU^^0
"BLD",3387,"KRN",101,"NM",23,0)
GMRC IF ED BKG STRT^^0
"BLD",3387,"KRN",101,"NM",24,0)
GMRC IF REFRESH BKG PAR^^0
"BLD",3387,"KRN",101,"NM","B","GMRC IF CHANGE VIEW",21)

"BLD",3387,"KRN",101,"NM","B","GMRC IF COLUMN WIDTH MESSAGE",4)

"BLD",3387,"KRN",101,"NM","B","GMRC IF COLUMN WIDTH PRINT LIST",5)

"BLD",3387,"KRN",101,"NM","B","GMRC IF CONSLTS DESCRIPTION",19)

"BLD",3387,"KRN",101,"NM","B","GMRC IF CONSLTS SELECT NUMBERED",6)

"BLD",3387,"KRN",101,"NM","B","GMRC IF CONSLTS SELECT SERVICE",7)

"BLD",3387,"KRN",101,"NM","B","GMRC IF CONSLTS SELECT STATUS",8)

"BLD",3387,"KRN",101,"NM","B","GMRC IF DETAILED DISPLAY",20)

"BLD",3387,"KRN",101,"NM","B","GMRC IF ED BKG STRT",23)

"BLD",3387,"KRN",101,"NM","B","GMRC IF MRK TRANSACTION COMP",17)

"BLD",3387,"KRN",101,"NM","B","GMRC IF QC CONSULTS",15)

"BLD",3387,"KRN",101,"NM","B","GMRC IF REFRESH BKG PAR",24)

"BLD",3387,"KRN",101,"NM","B","GMRC IF RETRANSMIT ACTIVITY",1)

"BLD",3387,"KRN",101,"NM","B","GMRC IF SELECT NEW CONSULT",2)

"BLD",3387,"KRN",101,"NM","B","GMRC IFC ORM EVENT",9)

"BLD",3387,"KRN",101,"NM","B","GMRC IFC ORM TEST",14)

"BLD",3387,"KRN",101,"NM","B","GMRC IFC SUBSC",10)

"BLD",3387,"KRN",101,"NM","B","GMRC OUTSTD CONSLTS SELECT NUMBERED",11)

"BLD",3387,"KRN",101,"NM","B","GMRC OUTSTD CONSLTS SELECT SERVICE",12)

"BLD",3387,"KRN",101,"NM","B","GMRC OUTSTD CONSLTS SELECT STATUS",13)

"BLD",3387,"KRN",101,"NM","B","GMRCIFM BKG PARAM MENU",22)

"BLD",3387,"KRN",101,"NM","B","GMRCIFM INCOMPLETE TRANS MENU",3)

"BLD",3387,"KRN",101,"NM","B","GMRCIFM TRANS MENU",16)

"BLD",3387,"KRN",101,"NM","B","VALM PRINT LIST",18)

"BLD",3387,"KRN",409.61,0)
409.61
"BLD",3387,"KRN",409.61,"NM",0)
^9.68A^5^5
"BLD",3387,"KRN",409.61,"NM",1,0)
GMRC IF CONSULTS^^0
"BLD",3387,"KRN",409.61,"NM",2,0)
GMRC IF INCOMPLETE TRANSACTION^^0
"BLD",3387,"KRN",409.61,"NM",3,0)
GMRC PENDING CONSULTS^^0
"BLD",3387,"KRN",409.61,"NM",4,0)
GMRC IF TRANSACTION^^0
"BLD",3387,"KRN",409.61,"NM",5,0)
GMRC IF MONITOR BKG JOB^^0
"BLD",3387,"KRN",409.61,"NM","B","GMRC IF CONSULTS",1)

"BLD",3387,"KRN",409.61,"NM","B","GMRC IF INCOMPLETE TRANSACTION",2)

"BLD",3387,"KRN",409.61,"NM","B","GMRC IF MONITOR BKG JOB",5)

"BLD",3387,"KRN",409.61,"NM","B","GMRC IF TRANSACTION",4)

"BLD",3387,"KRN",409.61,"NM","B","GMRC PENDING CONSULTS",3)

"BLD",3387,"KRN",771,0)
771
"BLD",3387,"KRN",771,"NM",0)
^9.68A^2^2
"BLD",3387,"KRN",771,"NM",1,0)
GMRC IF CONSULT^^0
"BLD",3387,"KRN",771,"NM",2,0)
GMRC IF TEST^^0
"BLD",3387,"KRN",771,"NM","B","GMRC IF CONSULT",1)

"BLD",3387,"KRN",771,"NM","B","GMRC IF TEST",2)

"BLD",3387,"KRN",870,0)
870
"BLD",3387,"KRN",8989.51,0)
8989.51
"BLD",3387,"KRN",8989.51,"NM",0)
^9.68A^3^3
"BLD",3387,"KRN",8989.51,"NM",1,0)
GMRC IFC BACKGROUND FINISH^^0
"BLD",3387,"KRN",8989.51,"NM",2,0)
GMRC IFC BACKGROUND START^^0
"BLD",3387,"KRN",8989.51,"NM",3,0)
GMRC RETAIN IFC ACTIVITY DAYS^^0
"BLD",3387,"KRN",8989.51,"NM","B","GMRC IFC BACKGROUND FINISH",1)

"BLD",3387,"KRN",8989.51,"NM","B","GMRC IFC BACKGROUND START",2)

"BLD",3387,"KRN",8989.51,"NM","B","GMRC RETAIN IFC ACTIVITY DAYS",3)

"BLD",3387,"KRN",8989.52,0)
8989.52
"BLD",3387,"KRN",8994,0)
8994
"BLD",3387,"KRN","B",.4,.4)

"BLD",3387,"KRN","B",.401,.401)

"BLD",3387,"KRN","B",.402,.402)

"BLD",3387,"KRN","B",.403,.403)

"BLD",3387,"KRN","B",.5,.5)

"BLD",3387,"KRN","B",.84,.84)

"BLD",3387,"KRN","B",3.6,3.6)

"BLD",3387,"KRN","B",3.8,3.8)

"BLD",3387,"KRN","B",9.2,9.2)

"BLD",3387,"KRN","B",9.8,9.8)

"BLD",3387,"KRN","B",19,19)

"BLD",3387,"KRN","B",19.1,19.1)

"BLD",3387,"KRN","B",101,101)

"BLD",3387,"KRN","B",409.61,409.61)

"BLD",3387,"KRN","B",771,771)

"BLD",3387,"KRN","B",870,870)

"BLD",3387,"KRN","B",8989.51,8989.51)

"BLD",3387,"KRN","B",8989.52,8989.52)

"BLD",3387,"KRN","B",8994,8994)

"BLD",3387,"QUES",0)
^9.62^^
"BLD",3387,"REQB",0)
^9.611^17^14
"BLD",3387,"REQB",3,0)
XWB*1.1*22^2
"BLD",3387,"REQB",4,0)
XU*8.0*206^2
"BLD",3387,"REQB",6,0)
GMRC*3.0*12^2
"BLD",3387,"REQB",7,0)
GMRC*3.0*15^2
"BLD",3387,"REQB",8,0)
GMRC*3.0*17^2
"BLD",3387,"REQB",9,0)
GMRC*3.0*18^2
"BLD",3387,"REQB",10,0)
GMRC*3.0*20^2
"BLD",3387,"REQB",11,0)
GMRC*3.0*21^2
"BLD",3387,"REQB",12,0)
GMRC*3.0*23^2
"BLD",3387,"REQB",13,0)
OR*3.0*109^2
"BLD",3387,"REQB",14,0)
XU*8.0*209^2
"BLD",3387,"REQB",15,0)
XU*8.0*212^2
"BLD",3387,"REQB",16,0)
GMRC*3.0*24^2
"BLD",3387,"REQB",17,0)
GMRC*3.0*7^2
"BLD",3387,"REQB","B","GMRC*3.0*12",6)

"BLD",3387,"REQB","B","GMRC*3.0*15",7)

"BLD",3387,"REQB","B","GMRC*3.0*17",8)

"BLD",3387,"REQB","B","GMRC*3.0*18",9)

"BLD",3387,"REQB","B","GMRC*3.0*20",10)

"BLD",3387,"REQB","B","GMRC*3.0*21",11)

"BLD",3387,"REQB","B","GMRC*3.0*23",12)

"BLD",3387,"REQB","B","GMRC*3.0*24",16)

"BLD",3387,"REQB","B","GMRC*3.0*7",17)

"BLD",3387,"REQB","B","OR*3.0*109",13)

"BLD",3387,"REQB","B","XU*8.0*206",4)

"BLD",3387,"REQB","B","XU*8.0*209",14)

"BLD",3387,"REQB","B","XU*8.0*212",15)

"BLD",3387,"REQB","B","XWB*1.1*22",3)

"DATA",123.1,23,0)
REMOTE REQUEST RECEIVED^5^^^IP^^IP
"DATA",123.1,24,0)
INITIAL REMOTE REQUEST^5^^^^^IP^Initial remote request
"DATA",123.1,25,0)
FWD TO REMOTE SERVICE^5^^^XX^^IP^FWD to remote service
"FIA",123)
REQUEST/CONSULTATION
"FIA",123,0)
^GMR(123,
"FIA",123,0,0)
123DI
"FIA",123,0,1)
y^n^p^^^^n
"FIA",123,0,10)

"FIA",123,0,11)

"FIA",123,0,"RLRO")

"FIA",123,0,"VR")
3.0^GMRC
"FIA",123,123)
1
"FIA",123,123,.06)

"FIA",123,123,.07)

"FIA",123,123,.125)

"FIA",123,123,.126)

"FIA",123,123,.131)

"FIA",123,123,.132)

"FIA",123,123,.133)

"FIA",123,123,10)

"FIA",123,123,51)

"FIA",123,123.02)
1
"FIA",123,123.02,.21)

"FIA",123,123.02,.22)

"FIA",123,123.02,.23)

"FIA",123,123.02,.24)

"FIA",123,123.02,.25)

"FIA",123,123.02,.31)

"FIA",123,123.02,1)

"FIA",123,123.02,2)

"FIA",123,123.051)
0
"FIA",123.1)
REQUEST ACTION TYPES
"FIA",123.1,0)
^GMR(123.1,
"FIA",123.1,0,0)
123.1
"FIA",123.1,0,1)
n^y^f^^n^^y^o^n
"FIA",123.1,0,10)

"FIA",123.1,0,11)
I Y=23!(Y=24)!(Y=25)
"FIA",123.1,0,"RLRO")

"FIA",123.1,0,"VR")
3.0^GMRC
"FIA",123.1,123.1)
0
"FIA",123.3)
GMRC PROCEDURE
"FIA",123.3,0)
^GMR(123.3,
"FIA",123.3,0,0)
123.3O
"FIA",123.3,0,1)
y^n^p^^^^n
"FIA",123.3,0,10)

"FIA",123.3,0,11)

"FIA",123.3,0,"RLRO")

"FIA",123.3,0,"VR")
3.0^GMRC
"FIA",123.3,123.3)
1
"FIA",123.3,123.3,3)

"FIA",123.3,123.3,126)

"FIA",123.3,123.3,127)

"FIA",123.3,123.3,128)

"FIA",123.3,123.3,129)

"FIA",123.3,123.3128)
0
"FIA",123.5)
REQUEST SERVICES
"FIA",123.5,0)
^GMR(123.5,
"FIA",123.5,0,0)
123.5I
"FIA",123.5,0,1)
y^n^p^^^^n
"FIA",123.5,0,10)

"FIA",123.5,0,11)

"FIA",123.5,0,"RLRO")

"FIA",123.5,0,"VR")
3.0^GMRC
"FIA",123.5,123.5)
1
"FIA",123.5,123.5,11)

"FIA",123.5,123.5,132)

"FIA",123.5,123.5,133)

"FIA",123.5,123.5,134)

"FIA",123.5,123.5,135)

"FIA",123.5,123.5134)
0
"FIA",123.6)
IFC MESSAGE LOG
"FIA",123.6,0)
^GMR(123.6,
"FIA",123.6,0,0)
123.6D
"FIA",123.6,0,1)
y^y^f^^^^n
"FIA",123.6,0,10)

"FIA",123.6,0,11)

"FIA",123.6,0,"RLRO")

"FIA",123.6,0,"VR")
3.0^GMRC
"FIA",123.6,123.6)
0
"IX",123,123,"AIFC",0)
123^AIFC^Index on ROUTING FACILITY & REMOTE CONSULT #^R^^R^IR^I^123^^^^^S
"IX",123,123,"AIFC",1)
S ^GMR(123,"AIFC",$E(X(1),1,5),$E(X(2),1,9),DA)=""
"IX",123,123,"AIFC",2)
K ^GMR(123,"AIFC",$E(X(1),1,5),$E(X(2),1,9),DA)
"IX",123,123,"AIFC",2.5)
K ^GMR(123,"AIFC")
"IX",123,123,"AIFC",11.1,0)
^.114IA^2^2
"IX",123,123,"AIFC",11.1,1,0)
1^F^123^.07^5^1^F
"IX",123,123,"AIFC",11.1,2,0)
2^F^123^.06^9^2^F
"IX",123,123.02,"AC",0)
123.02^AC^Index on activity, actual date of activity and remote date of activity^R^^R^IR^I^123.02^^^^^S
"IX",123,123.02,"AC",.1,0)
^^4^4^3020307^
"IX",123,123.02,"AC",.1,1,0)
This index will be built using the ACTIVITY (field #1), ACTUAL DATE/TIME
"IX",123,123.02,"AC",.1,2,0)
OF ACTIVITY (field #2) and the REMOTE DATE/TIME OF FILING (field #.25).
"IX",123,123.02,"AC",.1,3,0)
This index will be used to prevent an activity from being filed more than
"IX",123,123.02,"AC",.1,4,0)
once, in case of re-transmission of the activity from the remote site.
"IX",123,123.02,"AC",1)
S ^GMR(123,DA(1),40,"AC",$E(X(1),1,3),$E(X(2),1,17),$E(X(3),1,17),DA)=""
"IX",123,123.02,"AC",2)
K ^GMR(123,DA(1),40,"AC",$E(X(1),1,3),$E(X(2),1,17),$E(X(3),1,17),DA)
"IX",123,123.02,"AC",2.5)
K ^GMR(123,DA(1),40,"AC")
"IX",123,123.02,"AC",11.1,0)
^.114IA^3^3
"IX",123,123.02,"AC",11.1,1,0)
1^F^123.02^1^3^1^F
"IX",123,123.02,"AC",11.1,2,0)
2^F^123.02^.25^17^2^F
"IX",123,123.02,"AC",11.1,3,0)
3^F^123.02^2^17^3^F
"IX",123,123.051,"AR",0)
123.051^AR^Index on REMOTE ASSOCIATED RESULT and RESULTING SITE^R^^R^IR^I^123.051^^^^^S
"IX",123,123.051,"AR",.1,0)
^^2^2^3011025^
"IX",123,123.051,"AR",.1,1,0)
This index is used to keep track of the remote results associated with a 
"IX",123,123.051,"AR",.1,2,0)
particular IFC. 
"IX",123,123.051,"AR",1)
S ^GMR(123,DA(1),51,"AR",$E(X(1),1,30),$E(X(2),1,10),DA)=""
"IX",123,123.051,"AR",2)
K ^GMR(123,DA(1),51,"AR",$E(X(1),1,30),$E(X(2),1,10),DA)
"IX",123,123.051,"AR",2.5)
K ^GMR(123,DA(1),51,"AR")
"IX",123,123.051,"AR",11.1,0)
^.114IA^2^2
"IX",123,123.051,"AR",11.1,1,0)
1^F^123.051^.02^30^1^F
"IX",123,123.051,"AR",11.1,2,0)
2^F^123.051^.03^10^2^F
"IX",123.6,123.6,"AC",0)
123.6^AC^This index is used to sort incomplete records by request number^R^^R^IR^I^123.6^^^^^S
"IX",123.6,123.6,"AC",1)
S ^GMR(123.6,"AC",$E(X(1),1,15),$E(X(2),1,4),$E(X(3),1,1),DA)=""
"IX",123.6,123.6,"AC",2)
K ^GMR(123.6,"AC",$E(X(1),1,15),$E(X(2),1,4),$E(X(3),1,1),DA)
"IX",123.6,123.6,"AC",2.5)
K ^GMR(123.6,"AC")
"IX",123.6,123.6,"AC",11.1,0)
^.114IA^3^3
"IX",123.6,123.6,"AC",11.1,1,0)
1^F^123.6^.04^15^1^F
"IX",123.6,123.6,"AC",11.1,2,0)
2^F^123.6^.05^4^2^F
"IX",123.6,123.6,"AC",11.1,3,0)
3^F^123.6^.06^1^3^F
"IX",123.6,123.6,"C",0)
123.6^C^Index on Consult# & Activity#^R^^R^IR^I^123.6^^^^^LS
"IX",123.6,123.6,"C",1)
S ^GMR(123.6,"C",$E(X(1),1,10),$E(X(2),1,4),DA)=""
"IX",123.6,123.6,"C",2)
K ^GMR(123.6,"C",$E(X(1),1,10),$E(X(2),1,4),DA)
"IX",123.6,123.6,"C",2.5)
K ^GMR(123.6,"C")
"IX",123.6,123.6,"C",11.1,0)
^.114IA^2^2
"IX",123.6,123.6,"C",11.1,1,0)
1^F^123.6^.04^10^1^F^Select Consult #
"IX",123.6,123.6,"C",11.1,2,0)
2^F^123.6^.05^4^2^F
"KRN",.402,763,-1)
0^1
"KRN",.402,763,0)
GMRC SETUP REQUEST SERVICE^3020204.16^^123.5^^^3020329
"KRN",.402,763,"DIAB",1,0,123.5,3)
1.11;"ABBREVIATED PRINT NAME (Optional)~"
"KRN",.402,763,"DIAB",1,1,123.51,0)
ALL
"KRN",.402,763,"DIAB",1,1,123.5134,0)
ALL
"KRN",.402,763,"DIAB",1,1,123.52,0)
ALL
"KRN",.402,763,"DIAB",1,1,123.53,0)
ALL
"KRN",.402,763,"DIAB",1,1,123.54,0)
ALL
"KRN",.402,763,"DIAB",1,1,123.555,0)
ALL
"KRN",.402,763,"DIAB",1,1,123.57,0)
ALL
"KRN",.402,763,"DIAB",1,1,123.58,0)
ALL
"KRN",.402,763,"DIAB",1,1,123.59,0)
ALL
"KRN",.402,763,"DR",1,123.5)
I '$D(GMRCSAFE) D EN^DDIOL("Editing of this file should only be done via the Setup Request Services option.") S Y="";
"KRN",.402,763,"DR",1,123.5,1)
I $O(^GMR(123.5,DA,"IFCS",0)) D EN^DDIOL("Service is configured to receive inter-facility consults from another facility.","","!!");
"KRN",.402,763,"DR",1,123.5,2)
I $O(^GMR(123.5,DA,"IFCS",0)) D EN^DDIOL("Editing of the SERVICE NAME may disrupt inter-facility consult operations.","","!");D EN^DDIOL(" ") I $G(GMRCSAFE) S Y=123.01;.01;123.01///^S X="CONSULTS";I $G(GMRCSAFE) S Y=1.1;
"KRN",.402,763,"DR",1,123.5,3)
1.11ABBREVIATED PRINT NAME (Optional)~~;11;1.1;123.03///^S X="GMRCACTM SERVICE ACTION MENU";2;123.09;1.04;1.05;125;I $G(GMRCSAFE) S Y=123.08;1.01;1.02;124;1.03;D EN^DDIOL(" ");D EN^DDIOL("Inter-facility information");
"KRN",.402,763,"DR",1,123.5,4)
I $O(^GMR(123.5,DA,"IFCS",0)) D EN^DDIOL(" ") S Y=134;132;133;I +$G(^GMR(123.5,DA,"IFC")) D EN^DDIOL(" ") S Y=123.08;134;D EN^DDIOL(" ");123.08;123.1;123.2;.08;123.3;123.31;123.35;123.33;123.34;.07;D EN^DDIOL(" ");123.5;1.06;.06;
"KRN",.402,763,"DR",1,123.5,5)
10;
"KRN",.402,763,"DR",2,123.51)
.01:2
"KRN",.402,763,"DR",2,123.5134)
.01
"KRN",.402,763,"DR",2,123.52)
.01
"KRN",.402,763,"DR",2,123.53)
.01
"KRN",.402,763,"DR",2,123.54)
.01:2
"KRN",.402,763,"DR",2,123.55)
.01;
"KRN",.402,763,"DR",2,123.555)
.01:.02
"KRN",.402,763,"DR",2,123.57)
.01
"KRN",.402,763,"DR",2,123.58)
.01:.02
"KRN",.402,763,"DR",2,123.59)
.01
"KRN",.402,1391,-1)
0^2
"KRN",.402,1391,0)
GMRC PROCEDURE SETUP^3020204.1613^@^123.3^^@^3020329
"KRN",.402,1391,"DIAB",1,1,123.31,0)
ALL
"KRN",.402,1391,"DIAB",1,1,123.3128,0)
ALL
"KRN",.402,1391,"DIAB",1,1,123.32,0)
ALL
"KRN",.402,1391,"DR",1,123.3)
I $O(^GMR(123.3,DA,"IFCS",0)) D EN^DDIOL("Procedure configured to receive inter-facility consults from another facility.","","!");
"KRN",.402,1391,"DR",1,123.3,1)
I $O(^GMR(123.3,DA,"IFCS",0)) D EN^DDIOL("Editing of the procedure name may disrupt inter-facility consult operations.","","!");.01;Q;I '$G(GMRCNEW) S Y="@99";
"KRN",.402,1391,"DR",1,123.3,2)
D EN^DDIOL("The new procedure will not be orderable unless the INACTIVE flag is deleted.");Q;.02//^S X="YES";S Y="@999";@99;.02;@999;1;3;2;.05;I '$$VERSION^XPDUTL("MD") S Y="@9999";I $D(^GMR(123.3,DA,"IFC")) S Y="@9999";
"KRN",.402,1391,"DR",1,123.3,3)
I $D(^GMR(123.3,DA,"IFCS")) S Y="@9999";.04;@9999;D EN^DDIOL(" ");125;.07;.08;124;.09;I $P(^GMR(123.3,DA,0),U,4) S Y="";D EN^DDIOL(" ");D EN^DDIOL("Inter-facility information:");
"KRN",.402,1391,"DR",1,123.3,4)
I $O(^GMR(123.3,DA,"IFCS",0)) D EN^DDIOL(" ") S Y=128;126;127;I +$G(^GMR(123.3,DA,"IFC")) D EN^DDIOL(" ") S Y="";128;
"KRN",.402,1391,"DR",2,123.31)
.01
"KRN",.402,1391,"DR",2,123.3128)
.01
"KRN",.402,1391,"DR",2,123.32)
.01
"KRN",3.8,112,-1)
0^3
"KRN",3.8,112,0)
IFC PATIENT ERROR MESSAGES^PU^n^^^^
"KRN",3.8,112,2,0)
^^2^2^3011120^
"KRN",3.8,112,2,1,0)
This mail group will be used to deliver messages regarding Inter-facility
"KRN",3.8,112,2,2,0)
Consult errors due to unknown patients.
"KRN",3.8,112,3)

"KRN",3.8,113,-1)
0^1
"KRN",3.8,113,0)
IFC CLIN ERRORS^PU^n^^^^
"KRN",3.8,113,2,0)
^3.801^3^3^3020323^^
"KRN",3.8,113,2,1,0)
The members of this mail group will receive Kernel alerts when 
"KRN",3.8,113,2,2,0)
Inter-facility consult transactions fail for reasons most likely due to 
"KRN",3.8,113,2,3,0)
improper setup or implementation.
"KRN",3.8,113,3)

"KRN",3.8,114,-1)
0^2
"KRN",3.8,114,0)
IFC TECH ERRORS^PU^n^^^^
"KRN",3.8,114,2,0)
^^3^3^3011120^
"KRN",3.8,114,2,1,0)
The members of this mail group will receive Kernel alerts when 
"KRN",3.8,114,2,2,0)
Inter-facility consult transactions fail due to technical problems with 
"KRN",3.8,114,2,3,0)
network connectivity or VistA HL7. 
"KRN",3.8,114,3)

"KRN",19,2046,-1)
2^5
"KRN",19,2046,0)
GMRC MGR^Consult Management^^M^.5^^^^^^^128
"KRN",19,2046,10,0)
^19.01IP^21^19
"KRN",19,2046,10,20,0)
4142^RPT^1
"KRN",19,2046,10,20,"^")
GMRC REPORTS
"KRN",19,2046,10,21,0)
8792^IFC
"KRN",19,2046,10,21,"^")
GMRC IFC MGMT
"KRN",19,2046,"U")
CONSULT MANAGEMENT
"KRN",19,4142,-1)
2^3
"KRN",19,4142,0)
GMRC REPORTS^Consult Tracking Reports^^M^1326^^^^^^^
"KRN",19,4142,10,0)
^19.01IP^16^14
"KRN",19,4142,10,12,0)
8738^PL
"KRN",19,4142,10,12,"^")
GMRC PRINT BY SEARCH
"KRN",19,4142,10,13,0)
8767^IFC
"KRN",19,4142,10,13,"^")
GMRC IFC RPT CONSULTS
"KRN",19,4142,10,14,0)
8805^PI
"KRN",19,4142,10,14,"^")
GMRC IFC PRINT RPT NUMBERED
"KRN",19,4142,10,15,0)
8807^IP
"KRN",19,4142,10,15,"^")
GMRC IFC RPT CONSULTS BY PT
"KRN",19,4142,10,16,0)
8810^IR
"KRN",19,4142,10,16,"^")
GMRC IFC RPT CONSULTS BY REMPR
"KRN",19,4142,"U")
CONSULT TRACKING REPORTS
"KRN",19,8738,-1)
0^14
"KRN",19,8738,0)
GMRC PRINT BY SEARCH^Print Consults by Provider, Location, or Procedure^^R^^^^^^^^
"KRN",19,8738,1,0)
^^9^9^3020305^
"KRN",19,8738,1,1,0)
This option will compile a list of consult requests based on Provider,
"KRN",19,8738,1,2,0)
Location, or Procedure search criteria. Date range, status, and output
"KRN",19,8738,1,3,0)
formats are selectable parameters.
"KRN",19,8738,1,4,0)
 
"KRN",19,8738,1,5,0)
There are additional prompts for selection of local, remote, or both local
"KRN",19,8738,1,6,0)
and remote Provider(s) and Location(s). For the purposes of this 
"KRN",19,8738,1,7,0)
option, "local" refers to non-Inter-facility requests and Inter-facility
"KRN",19,8738,1,8,0)
requests originating locally; "remote" only refers to Inter-facility
"KRN",19,8738,1,9,0)
requests originating at another site.
"KRN",19,8738,25)
EN^GMRCPSL1
"KRN",19,8738,99)
58686,53687
"KRN",19,8738,"U")
PRINT CONSULTS BY PROVIDER, LO
"KRN",19,8767,-1)
0^2
"KRN",19,8767,0)
GMRC IFC RPT CONSULTS^IFC Requests^^R^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,8767,1,0)
^^29^29^3020313^
"KRN",19,8767,1,1,0)
This option provides detailed information regarding inter-facility 
"KRN",19,8767,1,2,0)
consults.
"KRN",19,8767,1,3,0)
 
"KRN",19,8767,1,4,0)
If not specified, all status' are utilized.
"KRN",19,8767,1,5,0)
 
"KRN",19,8767,1,6,0)
"Routing Facility" data: If selecting requesting site information, this 
"KRN",19,8767,1,7,0)
refers to the facility the consult is sent to; if selecting consulting 
"KRN",19,8767,1,8,0)
site information, this refers to the facility the consult is sent from.
"KRN",19,8767,1,9,0)
 
"KRN",19,8767,1,10,0)
"Days Diff" data: This refers to the (whole number) of days difference 
"KRN",19,8767,1,11,0)
between the COMPLETE activity date/time and one of the following activity 
"KRN",19,8767,1,12,0)
date/time (if one doesn't exist, retrieve the next): RECEIVED, ENTERED IN 
"KRN",19,8767,1,13,0)
CPRS, SERVICE ENTERED, FILE ENTRY DATE. All date/time data must be in the
"KRN",19,8767,1,14,0)
range selected. Field REMOTE ACTIVITY TIME ZONE is NOT figured into the
"KRN",19,8767,1,15,0)
calculations.
"KRN",19,8767,1,16,0)
 
"KRN",19,8767,1,17,0)
"Rec Date" data: For IFC consulting site report requests only, the option
"KRN",19,8767,1,18,0)
checks for DATE/TIME OF ACTION ENTRY for activity of REMOTE REQUEST
"KRN",19,8767,1,19,0)
RECEIVED, and if that doesn't exist it checks for DATE/TIME OF ACTION
"KRN",19,8767,1,20,0)
ENTRY for the activity of RECEIVED. Only date is listed in the report.
"KRN",19,8767,1,21,0)
 
"KRN",19,8767,1,22,0)
"Mean Days Completed To Service <service> @ <facility>" data: For only 
"KRN",19,8767,1,23,0)
those entries in which Days Diff exists, this calculation for each service
"KRN",19,8767,1,24,0)
at each routing facility is: Days Diff total divided by Number of Days
"KRN",19,8767,1,25,0)
Diff values.
"KRN",19,8767,1,26,0)
 
"KRN",19,8767,1,27,0)
"Mean Days Completed To Service <service>" data: For only those entries in
"KRN",19,8767,1,28,0)
which Days Diff exists, this calculation for each service is: Days Diff
"KRN",19,8767,1,29,0)
total divided by Number of Days Diff values.
"KRN",19,8767,25)
EN^GMRCIR
"KRN",19,8767,"U")
IFC REQUESTS
"KRN",19,8773,-1)
0^1
"KRN",19,8773,0)
GMRC IFC INC TRANS^List incomplete IFC transactions^^R^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,8773,1,0)
^19.06^2^2^3011213^^
"KRN",19,8773,1,1,0)
This option is used to list and/or retransmit any and all Inter-facility
"KRN",19,8773,1,2,0)
Consult activities that did not complete successfully. 
"KRN",19,8773,25)
EN^GMRCINC
"KRN",19,8773,"U")
LIST INCOMPLETE IFC TRANSACTIO
"KRN",19,8775,-1)
0^4
"KRN",19,8775,0)
GMRC IFC TEST SETUP^Test IFC implementation^^R^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,8775,1,0)
^^4^4^3011130^
"KRN",19,8775,1,1,0)
This option can be used to test the IFC setup for a given procedure or 
"KRN",19,8775,1,2,0)
consult service.  After selection of the service or procedure, the remote 
"KRN",19,8775,1,3,0)
site will be contacted and the procedure or service name will be 
"KRN",19,8775,1,4,0)
confirmed as correct.  Any errors encountered will be listed.
"KRN",19,8775,25)
EN^GMRCITST
"KRN",19,8775,"U")
TEST IFC IMPLEMENTATION
"KRN",19,8786,-1)
0^6
"KRN",19,8786,0)
GMRC IFC TRANS^IFC Transaction Report^^R^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,8786,1,0)
^^5^5^3020227^
"KRN",19,8786,1,1,0)
This option is used to list any or all Inter-facility Consult entries
"KRN",19,8786,1,2,0)
from the IFC MESSAGE LOG file (#123.6).
"KRN",19,8786,1,3,0)
NOTE: The parameter GMRC RETAIN IFC ACTIVITY DAYS controls the number of 
"KRN",19,8786,1,4,0)
days that completed Inter-facility Consult transactions are maintained in
"KRN",19,8786,1,5,0)
the IFC MESSAGE LOG (#123.6) file.
"KRN",19,8786,25)
EN^GMRCITR
"KRN",19,8786,"U")
IFC TRANSACTION REPORT
"KRN",19,8791,-1)
0^8
"KRN",19,8791,0)
GMRC IFC REMOTE NUMBER^Locate IFC by Remote Cslt #^^R^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,8791,1,0)
^^3^3^3020108^
"KRN",19,8791,1,1,0)
This option allows the look-up of a local consult/request when only the 
"KRN",19,8791,1,2,0)
remote site and remote consult number are known.  Upon look-up, the option
"KRN",19,8791,1,3,0)
includes both a brief and detailed display of the request.
"KRN",19,8791,25)
EN^GMRCILKP
"KRN",19,8791,"U")
LOCATE IFC BY REMOTE CSLT #
"KRN",19,8792,-1)
0^7
"KRN",19,8792,0)
GMRC IFC MGMT^IFC Management Menu^^M^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,8792,1,0)
^19.06^2^2^3020402^^^^
"KRN",19,8792,1,1,0)
This menu contains a collection of options used to implement and manage 
"KRN",19,8792,1,2,0)
the Inter-facility Consults interface.
"KRN",19,8792,10,0)
^19.01IP^10^10
"KRN",19,8792,10,1,0)
8775^TI^1
"KRN",19,8792,10,1,"^")
GMRC IFC TEST SETUP
"KRN",19,8792,10,2,0)
8773^LI^2
"KRN",19,8792,10,2,"^")
GMRC IFC INC TRANS
"KRN",19,8792,10,3,0)
8767^IFC^3
"KRN",19,8792,10,3,"^")
GMRC IFC RPT CONSULTS
"KRN",19,8792,10,4,0)
8791^LK^5
"KRN",19,8792,10,4,"^")
GMRC IFC REMOTE NUMBER
"KRN",19,8792,10,5,0)
8786^TR^4
"KRN",19,8792,10,5,"^")
GMRC IFC TRANS
"KRN",19,8792,10,6,0)
8805^PI
"KRN",19,8792,10,6,"^")
GMRC IFC PRINT RPT NUMBERED
"KRN",19,8792,10,7,0)
8807^IP
"KRN",19,8792,10,7,"^")
GMRC IFC RPT CONSULTS BY PT
"KRN",19,8792,10,8,0)
8810^IR
"KRN",19,8792,10,8,"^")
GMRC IFC RPT CONSULTS BY REMPR
"KRN",19,8792,10,9,0)
8813^BK^6
"KRN",19,8792,10,9,"^")
GMRC IFC BKG PARAM MON
"KRN",19,8792,10,10,0)
8856^MP
"KRN",19,8792,10,10,"^")
GMRC IFC TEST PT MPI
"KRN",19,8792,99)
58896,38715
"KRN",19,8792,"U")
IFC MANAGEMENT MENU
"KRN",19,8805,-1)
0^9
"KRN",19,8805,0)
GMRC IFC PRINT RPT NUMBERED^Print IFC Requests^^R^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,8805,1,0)
^^3^3^3020116^
"KRN",19,8805,1,1,0)
Sends the Inter-facility Consult Requests report to a device without going
"KRN",19,8805,1,2,0)
through the List Manager display of the report and waiting for the list to
"KRN",19,8805,1,3,0)
be built.
"KRN",19,8805,25)
PRNTONLY^GMRCIR(120)
"KRN",19,8805,"U")
PRINT IFC REQUESTS
"KRN",19,8807,-1)
0^10
"KRN",19,8807,0)
GMRC IFC RPT CONSULTS BY PT^IFC Requests By Patient^^R^^^^^^^^CONSULT/REQUEST TRACKING^^1^1
"KRN",19,8807,1,0)
^^5^5^3020118^
"KRN",19,8807,1,1,0)
This option provides actions which a service may use to track 
"KRN",19,8807,1,2,0)
inter-facility consults and requests.  
"KRN",19,8807,1,3,0)
   
"KRN",19,8807,1,4,0)
The processing flow is similiar to the OE/RR review screen.  Most of the
"KRN",19,8807,1,5,0)
actions have the same mnemonics as OE/RR for clinician familiarity.
"KRN",19,8807,15)
K GMRCIS D ^GMRCREXT
"KRN",19,8807,20)
S GMRCIS=""
"KRN",19,8807,25)
EN^GMRCSLM
"KRN",19,8807,"U")
IFC REQUESTS BY PATIENT
"KRN",19,8810,-1)
0^11
"KRN",19,8810,0)
GMRC IFC RPT CONSULTS BY REMPR^IFC Requests by Remote Ordering Provider^^R^^^^^^^^CONSULT/REQUEST TRACKING^^1^1
"KRN",19,8810,1,0)
^^2^2^3020201^
"KRN",19,8810,1,1,0)
This option provides detailed information regarding inter-facility
"KRN",19,8810,1,2,0)
consults by remote ordering provider for consulting sites to utilize.
"KRN",19,8810,15)
K GMRCREMP,GMRCRF
"KRN",19,8810,20)
S (GMRCREMP,GMRCRF)=""
"KRN",19,8810,25)
EN^GMRCIR
"KRN",19,8810,"U")
IFC REQUESTS BY REMOTE ORDERIN
"KRN",19,8811,-1)
0^12
"KRN",19,8811,0)
GMRC IFC BACKGROUND STARTUP^IFC Background Startup^^R^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,8811,1,0)
^^4^4^3020308^
"KRN",19,8811,1,1,0)
This menu option is not designed for user interaction.  It is defined to
"KRN",19,8811,1,2,0)
be called upon system startup and when taskman unexpectedly stops. This
"KRN",19,8811,1,3,0)
option starts the background error processor for Inter-facility Consults
"KRN",19,8811,1,4,0)
(IFC).
"KRN",19,8811,25)
EN^GMRCIBKG
"KRN",19,8811,"U")
IFC BACKGROUND STARTUP
"KRN",19,8813,-1)
0^13
"KRN",19,8813,0)
GMRC IFC BKG PARAM MON^Monitor IFC background job parameters^^R^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,8813,1,0)
^^6^6^3020214^
"KRN",19,8813,1,1,0)
This option allows the viewing of the two parameters involved in the
"KRN",19,8813,1,2,0)
scheduling and running of the IFC background job. The parameters and their
"KRN",19,8813,1,3,0)
current setting is listed along with any information the system can tell 
"KRN",19,8813,1,4,0)
from the settings.  From this display the start parameter may be edited 
"KRN",19,8813,1,5,0)
to a date/time in the future which will have the effect of delaying the 
"KRN",19,8813,1,6,0)
next run of the background job until the time defined in this parameter.
"KRN",19,8813,25)
EN^GMRCIBKM
"KRN",19,8813,"U")
MONITOR IFC BACKGROUND JOB PAR
"KRN",19,8856,-1)
0^15
"KRN",19,8856,0)
GMRC IFC TEST PT MPI^Configure test account patients for IFC^^R^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",19,8856,1,0)
^^8^8^3020402^
"KRN",19,8856,1,1,0)
WARNING: This option is for use in test accounts ONLY!
"KRN",19,8856,1,2,0)
This option will not function in a production VistA environment.
"KRN",19,8856,1,3,0)
 
"KRN",19,8856,1,4,0)
This option will use the social security number of the patient and create 
"KRN",19,8856,1,5,0)
a pseudo-ICN for the patient selected. If the patient name and social 
"KRN",19,8856,1,6,0)
security number are the same at the local facility and the IFC partnering
"KRN",19,8856,1,7,0)
facility, the selected patient can be used for IFC testing after this
"KRN",19,8856,1,8,0)
option is executed on both systems.
"KRN",19,8856,25)
EN^GMRCITPI
"KRN",19,8856,"U")
CONFIGURE TEST ACCOUNT PATIENT
"KRN",101,2769,-1)
0^18
"KRN",101,2769,0)
VALM PRINT LIST^Print List^^A^^^^^^^^LIST MANAGER
"KRN",101,2769,1,0)
^^2^2^2920113^
"KRN",101,2769,1,1,0)
This action allws the user to print the entire list of
"KRN",101,2769,1,2,0)
entries currently being displayed.
"KRN",101,2769,20)
D PRTL^VALM1
"KRN",101,2769,99)
58665,38132
"KRN",101,3740,-1)
0^12
"KRN",101,3740,0)
GMRC OUTSTD CONSLTS SELECT SERVICE^Service^^A^^^^^^^^
"KRN",101,3740,1,0)
^^2^2^2991202^^^^
"KRN",101,3740,1,1,0)
List Manager Protocol:  Select a new service for displaying consults
"KRN",101,3740,1,2,0)
still pending resolution (all consults not discontinued or complete.)
"KRN",101,3740,2,0)
^101.02A^1^1
"KRN",101,3740,2,1,0)
SS
"KRN",101,3740,2,"B","SS",1)

"KRN",101,3740,4)
24^2
"KRN",101,3740,15)
S VALMBCK="R"
"KRN",101,3740,20)
D EN^GMRCSTLM Q:$D(GMRCQUT)  S GMRCARRN="CP" D ENORLM^GMRCSTLM(GMRCARRN),INIT^GMRCPC,HDR^GMRCPC S VALMBG=1
"KRN",101,3740,99)
58044,59686
"KRN",101,5548,-1)
0^13
"KRN",101,5548,0)
GMRC OUTSTD CONSLTS SELECT STATUS^Status^^A^^^^^^^^
"KRN",101,5548,1,0)
^^2^2^2991201^
"KRN",101,5548,1,1,0)
List Manager Protocol:  Select a list of statuses for displaying consults
"KRN",101,5548,1,2,0)
still pending resolution (all consults not discontinued or complete.)
"KRN",101,5548,2,0)
^101.02A^2^1
"KRN",101,5548,2,2,0)
ST
"KRN",101,5548,2,"B","ST",2)

"KRN",101,5548,4)
24^2^^
"KRN",101,5548,15)
S VALMBCK="R"
"KRN",101,5548,20)
D NEWSTS^GMRCPC1 Q:$D(GMRCQUT)  S GMRCARRN="CP" D ENORLM^GMRCSTLM(GMRCARRN),INIT^GMRCPC,HDR^GMRCPC S VALMBG=1
"KRN",101,5548,99)
58044,59703
"KRN",101,5549,-1)
0^11
"KRN",101,5549,0)
GMRC OUTSTD CONSLTS SELECT NUMBERED^Number on/off^^A^^^^^^^^
"KRN",101,5549,1,0)
^^2^2^2991203^
"KRN",101,5549,1,1,0)
List Manager Protocol:  Togles on and off the display of the consult
"KRN",101,5549,1,2,0)
number in the report.
"KRN",101,5549,2,0)
^101.02A^^0
"KRN",101,5549,4)
24^2
"KRN",101,5549,15)
S VALMBCK="R"
"KRN",101,5549,20)
D NUMBER^GMRCPC1 Q:$D(GMRCQUT)  S GMRCARRN="CP" D ENORLM^GMRCSTLM(GMRCARRN),INIT^GMRCPC,HDR^GMRCPC S VALMBG=1
"KRN",101,5549,99)
58045,42959
"KRN",101,5670,-1)
0^9
"KRN",101,5670,0)
GMRC IFC ORM EVENT^Send IFC Order Message^^E^^^^^^^^
"KRN",101,5670,99)
58267,37486
"KRN",101,5670,770)
GMRC IF CONSULT^^ORM^O01^49^^^AL^AL^2.3^
"KRN",101,5670,772)
D ORRIN^GMRCIMSG
"KRN",101,5670,775,0)
^101.0775PA^1^1
"KRN",101,5670,775,1,0)
5943
"KRN",101,5670,775,1,"^")
GMRC IFC SUBSC
"KRN",101,5943,-1)
0^10
"KRN",101,5943,0)
GMRC IFC SUBSC^IFC Subscriber Protocol^^S^^^^^^^^
"KRN",101,5943,99)
58688,45554
"KRN",101,5943,770)
^GMRC IF CONSULT^^O02^^^^^^^ORR
"KRN",101,5943,771)
D IN^GMRCIMSG
"KRN",101,5943,773)
1^1
"KRN",101,5943,774)
Q
"KRN",101,5951,-1)
0^15
"KRN",101,5951,0)
GMRC IF QC CONSULTS^Print IF Consults By Service^^M^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5951,1,0)
^^2^2^3011121^
"KRN",101,5951,1,1,0)
List Manager Protocol to print inter-facility consults by service for QC
"KRN",101,5951,1,2,0)
purposes.  
"KRN",101,5951,4)
25
"KRN",101,5951,10,0)
^101.01PA^6^5
"KRN",101,5951,10,1,0)
5952^^1^
"KRN",101,5951,10,1,"^")
GMRC IF CONSLTS SELECT SERVICE
"KRN",101,5951,10,3,0)
5957^^4^
"KRN",101,5951,10,3,"^")
GMRC IF COLUMN WIDTH PRINT LIST
"KRN",101,5951,10,4,0)
5954^^3^
"KRN",101,5951,10,4,"^")
GMRC IF CONSLTS SELECT NUMBERED
"KRN",101,5951,10,5,0)
5953^^2^
"KRN",101,5951,10,5,"^")
GMRC IF CONSLTS SELECT STATUS
"KRN",101,5951,10,6,0)
5970^^5^
"KRN",101,5951,10,6,"^")
GMRC IF CONSLTS DESCRIPTION
"KRN",101,5951,26)
D SHOW^VALM
"KRN",101,5951,99)
58846,51308
"KRN",101,5952,-1)
0^7
"KRN",101,5952,0)
GMRC IF CONSLTS SELECT SERVICE^Service^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5952,1,0)
^^2^2^3011121^
"KRN",101,5952,1,1,0)
List Manager Protocol:  Select a new service for displaying 
"KRN",101,5952,1,2,0)
inter-facility consults.
"KRN",101,5952,2,0)
^101.02A^1^1
"KRN",101,5952,2,1,0)
SS
"KRN",101,5952,2,"B","SS",1)

"KRN",101,5952,4)
25^2
"KRN",101,5952,15)
S VALMBCK="R"
"KRN",101,5952,20)
D EN^GMRCSTLM Q:$D(GMRCQUT)  S GMRCARRN="IFC" D ENORLM^GMRCSTLM(GMRCARRN),HDR^GMRCIR S VALMBG=1
"KRN",101,5952,99)
58836,56323
"KRN",101,5953,-1)
0^8
"KRN",101,5953,0)
GMRC IF CONSLTS SELECT STATUS^Status^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5953,1,0)
^^2^2^3011121^
"KRN",101,5953,1,1,0)
List Manager Protocol:  Select a list of statuses for displaying 
"KRN",101,5953,1,2,0)
inter-facility consults.
"KRN",101,5953,2,0)
^101.02A^2^1
"KRN",101,5953,2,2,0)
ST
"KRN",101,5953,2,"B","ST",2)

"KRN",101,5953,4)
25^2
"KRN",101,5953,15)
S VALMBCK="R"
"KRN",101,5953,20)
D NEWSTS^GMRCPC1 Q:$D(GMRCQUT)  S GMRCARRN="IFC" D ENORLM^GMRCSTLM(GMRCARRN),HDR^GMRCIR S VALMBG=1
"KRN",101,5953,99)
58836,56327
"KRN",101,5954,-1)
0^6
"KRN",101,5954,0)
GMRC IF CONSLTS SELECT NUMBERED^Number on/off^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5954,1,0)
^^2^2^3011121^
"KRN",101,5954,1,1,0)
List Manager Protocol:  Toggles on and off the display of the consult
"KRN",101,5954,1,2,0)
number in the inter-facility consults report.
"KRN",101,5954,4)
25^2
"KRN",101,5954,15)
S VALMBCK="R"
"KRN",101,5954,20)
D NUMBER^GMRCPC1 Q:$D(GMRCQUT)  S GMRCARRN="IFC" D ENORLM^GMRCSTLM(GMRCARRN),HDR^GMRCIR S VALMBG=1
"KRN",101,5954,99)
58836,56319
"KRN",101,5956,-1)
0^4
"KRN",101,5956,0)
GMRC IF COLUMN WIDTH MESSAGE^COLUMN WIDTH PRINT OUT^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5956,20)
D PWIDTH^GMRCIR(130)
"KRN",101,5956,99)
58766,28494
"KRN",101,5957,-1)
0^5
"KRN",101,5957,0)
GMRC IF COLUMN WIDTH PRINT LIST^Print List^^X^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5957,10,0)
^101.01PA^3^2
"KRN",101,5957,10,2,0)
2769^^2^
"KRN",101,5957,10,2,"^")
VALM PRINT LIST
"KRN",101,5957,10,3,0)
5956^^1^
"KRN",101,5957,10,3,"^")
GMRC IF COLUMN WIDTH MESSAGE
"KRN",101,5957,99)
58766,28739
"KRN",101,5958,-1)
0^2
"KRN",101,5958,0)
GMRC IF SELECT NEW CONSULT^Select new Consult^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5958,1,0)
^^2^2^3011126^
"KRN",101,5958,1,1,0)
This protocol allows the user to select a new consult number for which to 
"KRN",101,5958,1,2,0)
display incomplete IFC transactions.
"KRN",101,5958,15)
S VALMBCK="R"
"KRN",101,5958,20)
D NEWCSLT^GMRCINC
"KRN",101,5958,99)
58767,72925
"KRN",101,5959,-1)
0^3
"KRN",101,5959,0)
GMRCIFM INCOMPLETE TRANS MENU^Incomplete Transaction Menu^^M^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5959,1,0)
^101.06^2^2^3020124^^
"KRN",101,5959,1,1,0)
This protocol contains the menu of actions that one can take from the 
"KRN",101,5959,1,2,0)
List incomplete IFC transactions option.
"KRN",101,5959,4)
39^3
"KRN",101,5959,10,0)
^101.01PA^3^3
"KRN",101,5959,10,1,0)
5958^SC^1^
"KRN",101,5959,10,1,"^")
GMRC IF SELECT NEW CONSULT
"KRN",101,5959,10,2,0)
5960^RT^2^
"KRN",101,5959,10,2,"^")
GMRC IF RETRANSMIT ACTIVITY
"KRN",101,5959,10,3,0)
5969^CM^6^
"KRN",101,5959,10,3,"^")
GMRC IF MRK TRANSACTION COMP
"KRN",101,5959,26)
D SHOW^VALM
"KRN",101,5959,28)
Select action: 
"KRN",101,5959,99)
58828,40917
"KRN",101,5960,-1)
0^1
"KRN",101,5960,0)
GMRC IF RETRANSMIT ACTIVITY^Retransmit an IFC activity^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5960,1,0)
^^2^2^3011126^
"KRN",101,5960,1,1,0)
This protocol is used to re-transmit an unsuccessful activity on an 
"KRN",101,5960,1,2,0)
inter-facility consult.
"KRN",101,5960,15)
S VALMBCK="R"
"KRN",101,5960,20)
D RETRAN^GMRCINC
"KRN",101,5960,99)
58767,81055
"KRN",101,5961,-1)
0^14
"KRN",101,5961,0)
GMRC IFC ORM TEST^Test ORM event for IFC^^E^^^^^^^^
"KRN",101,5961,1,0)
^^2^2^3011203^
"KRN",101,5961,1,1,0)
This item is the event protocol used to test the IFC implementation of 
"KRN",101,5961,1,2,0)
services or procedures.
"KRN",101,5961,99)
58776,73374
"KRN",101,5961,770)
GMRC IF TEST^^ORM^O01^49^^^NE^AL^2.3^
"KRN",101,5961,775,0)
^101.0775PA^1^1
"KRN",101,5961,775,1,0)
5943
"KRN",101,5961,775,1,"^")
GMRC IFC SUBSC
"KRN",101,5962,-1)
0^16
"KRN",101,5962,0)
GMRCIFM TRANS MENU^Transaction Menu^^M^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5962,1,0)
^^2^2^3011211^
"KRN",101,5962,1,1,0)
This protocol contains the menu of actions that one can take from the 
"KRN",101,5962,1,2,0)
IFC Transaction Report option.
"KRN",101,5962,4)
25^3
"KRN",101,5962,10,0)
^101.01PA^4^4
"KRN",101,5962,10,1,0)
5958^SC^1^
"KRN",101,5962,10,1,"^")
GMRC IF SELECT NEW CONSULT
"KRN",101,5962,10,2,0)
5957^PL^2^
"KRN",101,5962,10,2,"^")
GMRC IF COLUMN WIDTH PRINT LIST
"KRN",101,5962,10,3,0)
5971^DD^3^
"KRN",101,5962,10,3,"^")
GMRC IF DETAILED DISPLAY
"KRN",101,5962,10,4,0)
5972^CV^4^
"KRN",101,5962,10,4,"^")
GMRC IF CHANGE VIEW
"KRN",101,5962,26)
D SHOW^VALM
"KRN",101,5962,28)
Select action:
"KRN",101,5962,99)
58848,47838
"KRN",101,5969,-1)
0^17
"KRN",101,5969,0)
GMRC IF MRK TRANSACTION COMP^Mark transaction complete^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5969,1,0)
^^2^2^3020124^
"KRN",101,5969,1,1,0)
This protocol is used to mark an inter-facility consult transaction 
"KRN",101,5969,1,2,0)
complete.
"KRN",101,5969,15)
S VALMBCK="R"
"KRN",101,5969,20)
D MKCOMP^GMRCINC
"KRN",101,5969,99)
58828,31750
"KRN",101,5970,-1)
0^19
"KRN",101,5970,0)
GMRC IF CONSLTS DESCRIPTION^Description of Data^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5970,1,0)
^101.06^2^2^3020211^^
"KRN",101,5970,1,1,0)
List Manager Protocol: Display the Description from the Option file for
"KRN",101,5970,1,2,0)
option Inter-Facility Consult Requests [GMRC IFC RPT CONSULTS].
"KRN",101,5970,2,0)
^101.02A^1^1
"KRN",101,5970,2,1,0)
DE
"KRN",101,5970,2,"B","DE",1)

"KRN",101,5970,4)
25^2
"KRN",101,5970,15)
S VALMBCK="R"
"KRN",101,5970,20)
D DESC^GMRCIR
"KRN",101,5970,99)
58836,56125
"KRN",101,5971,-1)
0^20
"KRN",101,5971,0)
GMRC IF DETAILED DISPLAY^Detailed Display^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5971,1,0)
^^2^2^3020211^
"KRN",101,5971,1,1,0)
This protocol allows the user to select a consult number for which to
"KRN",101,5971,1,2,0)
display details from the IFC MESSAGE LOG (#123.6) file.
"KRN",101,5971,2,0)
^101.02A^^0
"KRN",101,5971,4)
^
"KRN",101,5971,15)
S VALMBCK="R"
"KRN",101,5971,20)
D SELECT^GMRCITR
"KRN",101,5971,99)
58846,49718
"KRN",101,5972,-1)
0^21
"KRN",101,5972,0)
GMRC IF CHANGE VIEW^Change View^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5972,1,0)
^^2^2^3020213^
"KRN",101,5972,1,1,0)
This protocol allows the user to change the view (sort) of entries from
"KRN",101,5972,1,2,0)
the IFC MESSAGE LOG (#123.6) file.
"KRN",101,5972,15)
S VALMBCK="R"
"KRN",101,5972,20)
D VIEW^GMRCITR Q:$D(GMRCQUT)  D DATA^GMRCITR(GMRCS),HDR^GMRCITR,LM^GMRCITR,INIT^GMRCINC
"KRN",101,5972,99)
58848,47007
"KRN",101,5973,-1)
0^23
"KRN",101,5973,0)
GMRC IF ED BKG STRT^Edit background job start parameter^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5973,1,0)
^^3^3^3020214^
"KRN",101,5973,1,1,0)
This protocol allows the start parameter for the IFC background job to be
"KRN",101,5973,1,2,0)
edited to some time in the future. This will delay the next running of 
"KRN",101,5973,1,3,0)
the background job until the date/time defined in this parameter.
"KRN",101,5973,20)
D EDSTRT^GMRCIBKM
"KRN",101,5973,99)
58849,51902
"KRN",101,5974,-1)
0^24
"KRN",101,5974,0)
GMRC IF REFRESH BKG PAR^Refresh background parameter list^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5974,1,0)
^^2^2^3020214^
"KRN",101,5974,1,1,0)
This protocol allows the listing of the IFC background parameters to be 
"KRN",101,5974,1,2,0)
refreshed and redisplayed.
"KRN",101,5974,20)
D REFRESH^GMRCIBKM
"KRN",101,5974,99)
58849,51974
"KRN",101,5975,-1)
0^22
"KRN",101,5975,0)
GMRCIFM BKG PARAM MENU^Monitor IFC background parameter menu^^M^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,5975,1,0)
^^2^2^3020214^
"KRN",101,5975,1,1,0)
This protocol contains actions that may be taken during the display of 
"KRN",101,5975,1,2,0)
the IFC background job parameters.
"KRN",101,5975,4)
45^3
"KRN",101,5975,10,0)
^101.01PA^2^2
"KRN",101,5975,10,1,0)
5973^ES^1^
"KRN",101,5975,10,1,"^")
GMRC IF ED BKG STRT
"KRN",101,5975,10,2,0)
5974^RL^2^
"KRN",101,5975,10,2,"^")
GMRC IF REFRESH BKG PAR
"KRN",101,5975,26)
D SHOW^VALM
"KRN",101,5975,28)
Select action:
"KRN",101,5975,99)
58849,52410
"KRN",409.61,170,-1)
0^3
"KRN",409.61,170,0)
GMRC PENDING CONSULTS^1^1^102^5^20^1^1^^GMRC QC OUTSTANDING CONSULTS^Service Consults by Status^1^^1
"KRN",409.61,170,1)
^GMRC COLUMN WIDTH HIDDEN MENU
"KRN",409.61,170,"ARRAY")
 ^TMP("GMRCR",$J,"CP")
"KRN",409.61,170,"COL",0)
^409.621^1^1
"KRN",409.61,170,"COL",1,0)
CAPTION LINE^2^79^
"KRN",409.61,170,"COL","B","CAPTION LINE",1)

"KRN",409.61,170,"FNL")
D KILL^VALM10(),CLEAR^VALM1,EXIT^GMRCPC
"KRN",409.61,170,"HDR")
D HDR^GMRCPC
"KRN",409.61,170,"HLP")
D HELP^GMRCPC
"KRN",409.61,170,"INIT")
S GMRCARRN="CP" D ENORLM^GMRCSTLM(GMRCARRN)
"KRN",409.61,820,-1)
0^1
"KRN",409.61,820,0)
GMRC IF CONSULTS^1^1^138^6^20^1^1^^GMRC IF QC CONSULTS^Inter-facility Consults^1^^1
"KRN",409.61,820,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,820,"ARRAY")
 ^TMP("GMRCR",$J,"IFC")
"KRN",409.61,820,"COL",0)
^409.621^2^2
"KRN",409.61,820,"COL",1,0)
CAPTION LINE^2^79
"KRN",409.61,820,"COL",2,0)
CAPTION LINE 1^90^47
"KRN",409.61,820,"COL","B","CAPTION LINE",1)

"KRN",409.61,820,"COL","B","CAPTION LINE 1",2)

"KRN",409.61,820,"FNL")
D KILL^VALM10(),CLEAR^VALM1,EXIT^GMRCIR
"KRN",409.61,820,"HDR")
D HDR^GMRCIR
"KRN",409.61,820,"HLP")
D HELP^GMRCIR
"KRN",409.61,820,"INIT")
S GMRCARRN="IFC" D ENORLM^GMRCSTLM(GMRCARRN)
"KRN",409.61,821,-1)
0^2
"KRN",409.61,821,0)
GMRC IF INCOMPLETE TRANSACTION^1^^80^4^19^1^1^^GMRCIFM INCOMPLETE TRANS MENU^Incomplete IFC Transactions^1^^1
"KRN",409.61,821,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,821,"ARRAY")
 ^TMP("GMRCINC",$J)
"KRN",409.61,821,"FNL")
D EXIT^GMRCINC
"KRN",409.61,821,"HDR")
D HDR^GMRCINC
"KRN",409.61,821,"HLP")
D HELP^GMRCINC
"KRN",409.61,821,"INIT")
D INIT^GMRCINC
"KRN",409.61,822,-1)
0^4
"KRN",409.61,822,0)
GMRC IF TRANSACTION^1^^128^5^20^1^1^^GMRCIFM TRANS MENU^IFC Transactions^1^^1
"KRN",409.61,822,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,822,"ARRAY")
 ^TMP("GMRCINC",$J)
"KRN",409.61,822,"COL",0)
^409.621^2^2
"KRN",409.61,822,"COL",1,0)
CAPTION LINE^2^79
"KRN",409.61,822,"COL",2,0)
CAPTION LINE 1^85^45
"KRN",409.61,822,"COL","B","CAPTION LINE",1)

"KRN",409.61,822,"COL","B","CAPTION LINE 1",2)

"KRN",409.61,822,"FNL")
D EXIT^GMRCINC
"KRN",409.61,822,"HDR")
D HDR^GMRCITR
"KRN",409.61,822,"HLP")
D HELP^GMRCINC
"KRN",409.61,822,"INIT")
D INIT^GMRCINC,LM^GMRCITR
"KRN",409.61,825,-1)
0^5
"KRN",409.61,825,0)
GMRC IF MONITOR BKG JOB^1^^80^4^19^0^1^^GMRCIFM BKG PARAM MENU^IFC Background Parameters^1^^1
"KRN",409.61,825,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,825,"ARRAY")
 ^TMP("GMRCBK",$J)
"KRN",409.61,825,"FNL")
D EXIT^GMRCIBKM
"KRN",409.61,825,"HDR")
D HDR^GMRCIBKM
"KRN",409.61,825,"HLP")
D HELP^GMRCIBKM
"KRN",409.61,825,"INIT")
D BLD^GMRCIBKM
"KRN",771,69,-1)
0^1
"KRN",771,69,0)
GMRC IF CONSULT^a^^^^^US
"KRN",771,69,"EC")
^~\&
"KRN",771,69,"FS")
|
"KRN",771,70,-1)
0^2
"KRN",771,70,0)
GMRC IF TEST^a^^^^^US
"KRN",771,70,"EC")
^~\&
"KRN",771,70,"FS")
|
"KRN",8989.51,4749,-1)
0^1
"KRN",8989.51,4749,0)
GMRC IFC BACKGROUND FINISH^Finish time of IFC Background job^0^^Finish date/time
"KRN",8989.51,4749,1)
D^::T^Enter a date/time
"KRN",8989.51,4749,6)
N
"KRN",8989.51,4749,20,0)
^^7^7^3020204^
"KRN",8989.51,4749,20,1,0)
This parameter holds the date/time that the Inter-facility Consults 
"KRN",8989.51,4749,20,2,0)
background job last finished running. The parameter is set by the 
"KRN",8989.51,4749,20,3,0)
background job.  This parameter is not intended to be modified using
"KRN",8989.51,4749,20,4,0)
parameter tools.
"KRN",8989.51,4749,20,5,0)
 
"KRN",8989.51,4749,20,6,0)
If this parameter becomes delinquent for an extended period, IRM personnel
"KRN",8989.51,4749,20,7,0)
will be alerted that the job is overdue.
"KRN",8989.51,4749,30,0)
^8989.513I^1^1
"KRN",8989.51,4749,30,1,0)
1^4.2
"KRN",8989.51,4750,-1)
0^2
"KRN",8989.51,4750,0)
GMRC IFC BACKGROUND START^Start date/time of IFC background job^0^^Start date/time
"KRN",8989.51,4750,1)
D^::T^You must enter a date/time no more than 4 days in the future.
"KRN",8989.51,4750,2)
N %DT S %DT="T" D ^%DT I Y,Y>$$FMADD^XLFDT(DT,4) K X
"KRN",8989.51,4750,6)
N
"KRN",8989.51,4750,20,0)
^^6^6^3020204^
"KRN",8989.51,4750,20,1,0)
This parameter contains the last start date/time of the Inter-facility 
"KRN",8989.51,4750,20,2,0)
Consults background job.   This parameter will help the system know 
"KRN",8989.51,4750,20,3,0)
whether a sufficient amount of time has passed since the last run.  If 
"KRN",8989.51,4750,20,4,0)
this parameter is set to afuture date/time, the background job will not 
"KRN",8989.51,4750,20,5,0)
run until that date /time.  The parameter may only be set up to 4 days in 
"KRN",8989.51,4750,20,6,0)
the future.
"KRN",8989.51,4750,30,0)
^8989.513I^1^1
"KRN",8989.51,4750,30,1,0)
1^4.2
"KRN",8989.51,4751,-1)
0^3
"KRN",8989.51,4751,0)
GMRC RETAIN IFC ACTIVITY DAYS^Days to retain complete IFC transactions^0^^Retention days
"KRN",8989.51,4751,1)
N^7:180^Enter the number of days (7-180) to retain completed transactions
"KRN",8989.51,4751,6)
N
"KRN",8989.51,4751,20,0)
^8989.512^6^6^3020227^^
"KRN",8989.51,4751,20,1,0)
This parameter controls the number of days that completed Inter-facility 
"KRN",8989.51,4751,20,2,0)
Consult transactions are maintained in the IFC MESSAGE LOG (#123.6) file.
"KRN",8989.51,4751,20,3,0)
 
"KRN",8989.51,4751,20,4,0)
Completed transactions represent Consult activities transmitted to a
"KRN",8989.51,4751,20,5,0)
remote facility via HL7 which have been responded to with no error 
"KRN",8989.51,4751,20,6,0)
condition.
"KRN",8989.51,4751,30,0)
^8989.513I^1^1
"KRN",8989.51,4751,30,1,0)
1^4.2
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"ORD",11,3.8)
3.8;11;;;MAILG^XPDTA1;MAILGF1^XPDIA1;MAILGE1^XPDIA1;MAILGF2^XPDIA1
"ORD",11,3.8,0)
MAIL GROUP
"ORD",14,771)
771;14;;;HLAP^XPDTA1;HLAPF1^XPDIA1;HLAPE1^XPDIA1;HLAPF2^XPDIA1;;
"ORD",14,771,0)
HL7 APPLICATION PARAMETER
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"ORD",17,409.61)
409.61;17;1;;;;;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",128,-1)
1^1
"PKG",128,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",128,20,0)
^9.402P^^
"PKG",128,22,0)
^9.49I^1^1
"PKG",128,22,1,0)
3.0^2980101
"PKG",128,22,1,"PAH",1,0)
22^3020404
"PKG",128,22,1,"PAH",1,1,0)
^^2^2^3020404
"PKG",128,22,1,"PAH",1,1,1,0)
This BUILD includes the Inter-facility Consults enhancement. See the 
"PKG",128,22,1,"PAH",1,1,2,0)
National Patch Module for full details.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
58
"RTN","GMRCACMT")
0^49^B24714854
"RTN","GMRCACMT",1,0)
GMRCACMT ;SLC/DLT,DCM,MA - Comment Action and alerting ;1/11/01  12:53
"RTN","GMRCACMT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,14,18,20,22**;DEC 27, 1997
"RTN","GMRCACMT",3,0)
 ; This routine invokes IA #10060
"RTN","GMRCACMT",4,0)
COMMENT(GMRCO) ;Add a comment without changing the status
"RTN","GMRCACMT",5,0)
 K GMRCQIT,GMRCQUT N GMRCA
"RTN","GMRCACMT",6,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCACMT",7,0)
 S GMRCNOW=$$NOW^XLFDT,GMRCAD=GMRCNOW
"RTN","GMRCACMT",8,0)
 S GMRCOM=1,GMRCA=20,GMRCPROV=$P(^GMR(123,GMRCO,0),"^",14) D AUDIT^GMRCP
"RTN","GMRCACMT",9,0)
 ;GMRCOM=1 defined the variable and tells AUDIT^GMRCP that the word-processing logic should be executed. If an actual comment is added, $P(GMRCOM,"^",2)=1 (send alert), if not GMRCOM=1 and no '^' exists (do not send alert)
"RTN","GMRCACMT",10,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCACMT",11,0)
 ;continue if no lock problems occurred
"RTN","GMRCACMT",12,0)
 I $P(GMRCOM,"^",2) D
"RTN","GMRCACMT",13,0)
 . I $P($G(^GMR(123,GMRCO,12)),U,5)="F" D
"RTN","GMRCACMT",14,0)
 .. W !!,"The ordering provider for this inter-facility consult will "
"RTN","GMRCACMT",15,0)
        .. W "automatically be ",!,"notified.",!
"RTN","GMRCACMT",16,0)
 . D PROCALRT("",1,20,GMRCO)
"RTN","GMRCACMT",17,0)
 D END
"RTN","GMRCACMT",18,0)
 Q
"RTN","GMRCACMT",19,0)
 ;
"RTN","GMRCACMT",20,0)
PROCALRT(GMRCORTX,GMRCDELR,ACTION,GMRCO) ;Process alert for comments
"RTN","GMRCACMT",21,0)
 ;If GMRCDELR=1, the ordering provider can be deleted from the list.
"RTN","GMRCACMT",22,0)
 N GMRCADUZ,GMRCANS,NOTIF,GMRCQIT
"RTN","GMRCACMT",23,0)
 S GMRCANS=$$READ("Y","Do You Wish To Send An Alert With This Comment","N","Enter Y to continue with recipient prompts. Otherwise, enter N.",1)
"RTN","GMRCACMT",24,0)
 I (GMRCANS[U)!(GMRCANS=0) D END Q
"RTN","GMRCACMT",25,0)
 ;
"RTN","GMRCACMT",26,0)
 D WHOTO
"RTN","GMRCACMT",27,0)
 I $G(GMRCQIT) D END Q  ;User "^" at requesting provider.
"RTN","GMRCACMT",28,0)
 ;
"RTN","GMRCACMT",29,0)
 ; Patch 18 changes Notification #27 to #63.
"RTN","GMRCACMT",30,0)
 ; Patch 20 checks to see if GUI v15 is installed to use new
"RTN","GMRCACMT",31,0)
 ; alert code #63
"RTN","GMRCACMT",32,0)
 N GMRCALT
"RTN","GMRCACMT",33,0)
 S GMRCALT=$S($$PATCH^XPDUTL("OR*3.0*85"):63,1:27)
"RTN","GMRCACMT",34,0)
 S NOTIF=$S(ACTION=20:GMRCALT,1:23)
"RTN","GMRCACMT",35,0)
 ; Use NEW SERVICE CONSULT/REQUEST (27) for the ADD COMMENT action to
"RTN","GMRCACMT",36,0)
 ;     prevent the forced PAO entries that occur with the
"RTN","GMRCACMT",37,0)
 ;     CONSULT/REQUEST RESOLUTION (23) notification.
"RTN","GMRCACMT",38,0)
 D SENDMSG(NOTIF,+GMRCO)
"RTN","GMRCACMT",39,0)
 Q
"RTN","GMRCACMT",40,0)
 ;
"RTN","GMRCACMT",41,0)
SENDMSG(NOTIF,GMRCO) ;Send the alert
"RTN","GMRCACMT",42,0)
 N GMRCDFN
"RTN","GMRCACMT",43,0)
 I '$D(GMRCADUZ) S GMRCADUZ=""
"RTN","GMRCACMT",44,0)
 W !,"Processing Alerts..."
"RTN","GMRCACMT",45,0)
 S GMRCDFN=$P($G(^GMR(123,+GMRCO,0)),"^",2)
"RTN","GMRCACMT",46,0)
 S GMRCORTX=$S($L(GMRCORTX):GMRCORTX,1:"Comment Added to Consult ")_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCACMT",47,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,NOTIF,.GMRCADUZ,0)
"RTN","GMRCACMT",48,0)
 Q
"RTN","GMRCACMT",49,0)
 ;
"RTN","GMRCACMT",50,0)
END ;kill off variables and exit
"RTN","GMRCACMT",51,0)
 K GMRC,GMRCA,GMRCMSG,GMRCOM,GMRCO,GMRCORTX,GMRCERR,GMRCERMS,GMRCQUT,GMRCUT
"RTN","GMRCACMT",52,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCACMT",53,0)
 K DTOUT,DIROUT,DUOUT,DIRUT
"RTN","GMRCACMT",54,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCACMT",55,0)
 Q
"RTN","GMRCACMT",56,0)
 ;
"RTN","GMRCACMT",57,0)
WHOTO ;Get the users who should receive an alert
"RTN","GMRCACMT",58,0)
 ;Asks about requesting provider first, then prompts for additional users
"RTN","GMRCACMT",59,0)
 ;Returns GMRCADUZ array of users to send an alert to and GMRCQIT if "^"
"RTN","GMRCACMT",60,0)
 N GMRCRP,GMRCANS
"RTN","GMRCACMT",61,0)
 S GMRCRP=$P($G(^GMR(123,+GMRCO,0)),U,14) ;requesting provider entry
"RTN","GMRCACMT",62,0)
 I +GMRCRP S GMRCRP=$P($G(^VA(200,+GMRCRP,0)),U,1) ;provider name
"RTN","GMRCACMT",63,0)
 ;GMRCRP is now the requestor name or null
"RTN","GMRCACMT",64,0)
 I $L(GMRCRP) D  I GMRCANS[U S GMRCQIT=1 Q
"RTN","GMRCACMT",65,0)
 . S GMRCANS=$$READ("Y","Send Alert To Requesting Provider "_GMRCRP,"N","Enter Y to send an alert to the ordering provider, otherwise enter N.",1)
"RTN","GMRCACMT",66,0)
 . S:GMRCANS=1 GMRCADUZ($P(^GMR(123,+GMRCO,0),"^",14))=""
"RTN","GMRCACMT",67,0)
 . Q
"RTN","GMRCACMT",68,0)
 ;
"RTN","GMRCACMT",69,0)
ANDTO ;Ask for additional recipients
"RTN","GMRCACMT",70,0)
 D NAMELIST("Send Alert to: ",.GMRCADUZ,GMRCDELR)
"RTN","GMRCACMT",71,0)
 Q
"RTN","GMRCACMT",72,0)
 ;
"RTN","GMRCACMT",73,0)
NAMELIST(GMRCP,GMRCOLD,GMRCDELR) ;manage the list of recipients
"RTN","GMRCACMT",74,0)
 ;
"RTN","GMRCACMT",75,0)
 ; GMRCP - Prompt
"RTN","GMRCACMT",76,0)
 ; GMRCOLD - Original list with ordering provider.
"RTN","GMRCACMT",77,0)
 ; GMRCDELR - 1 means the original list may have names deleted
"RTN","GMRCACMT",78,0)
 ; Returns final list in GMRCOLD array
"RTN","GMRCACMT",79,0)
 ;
"RTN","GMRCACMT",80,0)
 N GMRCNEW,GMRCNT,GMRCDUZ,GMRCUSER,GMRCQ,GMRCADD,DIC,X,Y
"RTN","GMRCACMT",81,0)
 ;
"RTN","GMRCACMT",82,0)
 M GMRCNEW=GMRCOLD
"RTN","GMRCACMT",83,0)
 I GMRCDELR=1 K GMRCOLD S GMRCOLD="" ;Remove mandatory users from GMRCOLD
"RTN","GMRCACMT",84,0)
 S GMRCNT=0 F  D  Q:(GMRCUSER[U)
"RTN","GMRCACMT",85,0)
 .S GMRCUSER=$$READ("FAO;3;46",$S(GMRCNT:"And ",1:"")_GMRCP,"","^D NAMEHELP^GMRCACMT")
"RTN","GMRCACMT",86,0)
 .S:'$L(GMRCUSER) GMRCUSER=U Q:(GMRCUSER[U)
"RTN","GMRCACMT",87,0)
 .I ($E(GMRCUSER,1)="-") S GMRCADD=0,GMRCUSER=$E(GMRCUSER,2,$L(GMRCUSER))
"RTN","GMRCACMT",88,0)
 .E  S GMRCADD=1
"RTN","GMRCACMT",89,0)
 .;
"RTN","GMRCACMT",90,0)
 .S X=GMRCUSER,DIC=200,DIC(0)="EMQ" D ^DIC
"RTN","GMRCACMT",91,0)
 .;
"RTN","GMRCACMT",92,0)
 .I (Y>0) D  I 1
"RTN","GMRCACMT",93,0)
 ..;W $E($P(Y,U,2),$L(GMRCUSER)+1,$L($P(Y,U,2)))
"RTN","GMRCACMT",94,0)
 ..;
"RTN","GMRCACMT",95,0)
 ..I GMRCADD D
"RTN","GMRCACMT",96,0)
 ...I $D(GMRCNEW(+Y)) W " already in the list." Q
"RTN","GMRCACMT",97,0)
 ...S GMRCNEW(+Y)="" W " added to the list." S GMRCNT=GMRCNT+1
"RTN","GMRCACMT",98,0)
 ..;
"RTN","GMRCACMT",99,0)
 ..I 'GMRCADD D
"RTN","GMRCACMT",100,0)
 ...I $D(GMRCOLD(+Y)) W " can't delete this name from the list." Q
"RTN","GMRCACMT",101,0)
 ...I '$D(GMRCNEW(+Y)) W " not currently in the list." Q
"RTN","GMRCACMT",102,0)
 ...K GMRCNEW(+Y) S GMRCNT=GMRCNT-1 W " deleted from the list."
"RTN","GMRCACMT",103,0)
 .;
"RTN","GMRCACMT",104,0)
 .E  I $L(GMRCUSER) W "  Name not found."
"RTN","GMRCACMT",105,0)
 ;
"RTN","GMRCACMT",106,0)
 M GMRCOLD=GMRCNEW
"RTN","GMRCACMT",107,0)
 Q
"RTN","GMRCACMT",108,0)
 ;
"RTN","GMRCACMT",109,0)
READ(GMRC0,GMRCA,GMRCB,GMRCH,GMRCL) ;read logic
"RTN","GMRCACMT",110,0)
 ;
"RTN","GMRCACMT",111,0)
 ;  GMRC0 -> DIR(0) --- Type of read
"RTN","GMRCACMT",112,0)
 ;  GMRCA -> DIR("A") - Prompt
"RTN","GMRCACMT",113,0)
 ;  GMRCB -> DIR("B") - Default Answer
"RTN","GMRCACMT",114,0)
 ;  GMRCH -> DIR("?") - Help text or ^Execute code
"RTN","GMRCACMT",115,0)
 ;  GMRCL -> Number of blank lines to put before Prompt
"RTN","GMRCACMT",116,0)
 ;
"RTN","GMRCACMT",117,0)
 ;  Returns "^" or answer
"RTN","GMRCACMT",118,0)
 ;
"RTN","GMRCACMT",119,0)
 N GMRCLINE,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCACMT",120,0)
 Q:'$L($G(GMRC0)) U
"RTN","GMRCACMT",121,0)
 S DIR(0)=GMRC0
"RTN","GMRCACMT",122,0)
 S:$L($G(GMRCA)) DIR("A")=GMRCA
"RTN","GMRCACMT",123,0)
 S:$L($G(GMRCB)) DIR("B")=GMRCB
"RTN","GMRCACMT",124,0)
 S:$L($G(GMRCH)) DIR("?")=GMRCH
"RTN","GMRCACMT",125,0)
 F GMRCLINE=1:1:($G(GMRCL)-1) W !
"RTN","GMRCACMT",126,0)
 D ^DIR
"RTN","GMRCACMT",127,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q U
"RTN","GMRCACMT",128,0)
 Q Y
"RTN","GMRCACMT",129,0)
 ;
"RTN","GMRCACMT",130,0)
 ;
"RTN","GMRCACMT",131,0)
NAMEHELP ;Help for the recipient list logic
"RTN","GMRCACMT",132,0)
 N GMRCDUZ
"RTN","GMRCACMT",133,0)
 W !,"Enter the name of the user to send the alert to,"
"RTN","GMRCACMT",134,0)
 W !," or put a '-' in front of a name to delete from the list."
"RTN","GMRCACMT",135,0)
 W !
"RTN","GMRCACMT",136,0)
 W !,"  Example:"
"RTN","GMRCACMT",137,0)
 W !,"     SMITH,FRED  ->  to add Fred to the list."
"RTN","GMRCACMT",138,0)
 W !,"     -SMITH,FRED ->  to delete Fred from the list."
"RTN","GMRCACMT",139,0)
 W !,"Already selected: "
"RTN","GMRCACMT",140,0)
 W !
"RTN","GMRCACMT",141,0)
 S GMRCDUZ=0 F  S GMRCDUZ=$O(GMRCNEW(GMRCDUZ)) Q:'GMRCDUZ  D
"RTN","GMRCACMT",142,0)
 .W !,?5,$P(^VA(200,GMRCDUZ,0),U,1)
"RTN","GMRCACMT",143,0)
 .W:$D(GMRCOLD(GMRCDUZ)) "  <mandatory>"
"RTN","GMRCACMT",144,0)
 W !
"RTN","GMRCACMT",145,0)
 Q
"RTN","GMRCACMT",146,0)
 ;
"RTN","GMRCACTM")
0^28^B6768099
"RTN","GMRCACTM",1,0)
GMRCACTM ; SLC/DLT,DCM,JFR - Set action menus  ;10/17/01 22:41
"RTN","GMRCACTM",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,11,18,15,17,22**;DEC 27, 1997
"RTN","GMRCACTM",3,0)
 ;
"RTN","GMRCACTM",4,0)
 ; This routine invokes IA #2425
"RTN","GMRCACTM",5,0)
 ;
"RTN","GMRCACTM",6,0)
CPRS(GMRCPM,GUI) ;Entry point for setting menu actions for CPRS user
"RTN","GMRCACTM",7,0)
 ;Input:
"RTN","GMRCACTM",8,0)
 ;  GMRCPM=a list of File 123 IEN's to check for menu actions.
"RTN","GMRCACTM",9,0)
 ;       Passed in as '300;303;295;309;313'
"RTN","GMRCACTM",10,0)
 ;  GUI =1 if coming from the GUI; return field name in ORFLG also
"RTN","GMRCACTM",11,0)
 ;Output:
"RTN","GMRCACTM",12,0)
 ;  ORFLG(ien)= A^B^C^D^E^F^G^H where:
"RTN","GMRCACTM",13,0)
 ;    Ien = internal entry of record in file 123
"RTN","GMRCACTM",14,0)
 ;    A = a number representing one of the following:
"RTN","GMRCACTM",15,0)
 ;       1 - user has only review capabilities
"RTN","GMRCACTM",16,0)
 ;       2 - user has full update capabilities
"RTN","GMRCACTM",17,0)
 ;       3 - user has administrative update capabilities
"RTN","GMRCACTM",18,0)
 ;       4 - user has full update and admin user capabilities
"RTN","GMRCACTM",19,0)
 ;    B = field in file 123.5 (REQUEST SERVICES) that gave the user 
"RTN","GMRCACTM",20,0)
 ;        update authority (ex.  Update user w/o Notification)
"RTN","GMRCACTM",21,0)
 ;    C = Service in file 123.5 (REQUEST SERVICES) that gave the user
"RTN","GMRCACTM",22,0)
 ;        update authority (ex. CARDIOLOGY,NEUROLOGY)
"RTN","GMRCACTM",23,0)
 ;    D = contains a 1 if user is allowed to associate medicine results
"RTN","GMRCACTM",24,0)
 ;        with a consult procedure request
"RTN","GMRCACTM",25,0)
 ;    F = contain a 1 if user can disassociate a medicine result that was
"RTN","GMRCACTM",26,0)
 ;        incorrectly associated with a consult procedure request
"RTN","GMRCACTM",27,0)
 ;    G = contains a 1 if user is allowed to EDIT and RESUBMIT a canceled
"RTN","GMRCACTM",28,0)
 ;        request
"RTN","GMRCACTM",29,0)
 ;    H = 0-4 depending on actions allowed on a Clin. Proc. request
"RTN","GMRCACTM",30,0)
 ;
"RTN","GMRCACTM",31,0)
 I '$L(GMRCPM) S ORFLG=1 Q
"RTN","GMRCACTM",32,0)
 K ORFLG
"RTN","GMRCACTM",33,0)
 N I,GMRCSS,GMRCIEN
"RTN","GMRCACTM",34,0)
 F I=1:1 S ORFLG=1,GMRCIEN=$P(GMRCPM,";",I) Q:GMRCIEN=""  D
"RTN","GMRCACTM",35,0)
 .S ORFLG(GMRCIEN)=1 ;set default answer to read only
"RTN","GMRCACTM",36,0)
 .I $P($G(^GMR(123,GMRCIEN,12)),U,5)="P" D  Q  ;IFC placer so only ED/RES
"RTN","GMRCACTM",37,0)
 .. ;can user edit/resubmit
"RTN","GMRCACTM",38,0)
 .. I $$VALPROV^GMRCEDIT(GMRCIEN) S $P(ORFLG(GMRCIEN),U,6)=1
"RTN","GMRCACTM",39,0)
 .S GMRCSS=+$P($G(^GMR(123,+GMRCIEN,0)),"^",5)
"RTN","GMRCACTM",40,0)
 .Q:'+$G(GMRCSS)
"RTN","GMRCACTM",41,0)
 .;when service is defined, check for service user 
"RTN","GMRCACTM",42,0)
 .D EN
"RTN","GMRCACTM",43,0)
 .S ORFLG(GMRCIEN)=ORFLG
"RTN","GMRCACTM",44,0)
 . ;what actions to allow if a Clincial Procedure
"RTN","GMRCACTM",45,0)
 . S $P(ORFLG(GMRCIEN),U,7)=$$CPACTM^GMRCCP(GMRCIEN)
"RTN","GMRCACTM",46,0)
 .I ORFLG>1 D
"RTN","GMRCACTM",47,0)
 .. ;can DUZ associate med results?  only if not a CP!
"RTN","GMRCACTM",48,0)
 .. N P4
"RTN","GMRCACTM",49,0)
 .. S P4=$S(+$P(ORFLG(GMRCIEN),U,7):0,1:$$CANDOMED^GMRCGUIU(GMRCIEN))
"RTN","GMRCACTM",50,0)
 .. S $P(ORFLG(GMRCIEN),U,4)=P4
"RTN","GMRCACTM",51,0)
 . ;can DUZ disassociate a med result?
"RTN","GMRCACTM",52,0)
 . S $P(ORFLG(GMRCIEN),U,5)=+$$REMUSR^GMRCDIS(GMRCIEN)
"RTN","GMRCACTM",53,0)
 . ;can user edit/resubmit
"RTN","GMRCACTM",54,0)
 . I $$VALPROV^GMRCEDIT(GMRCIEN) S $P(ORFLG(GMRCIEN),U,6)=1
"RTN","GMRCACTM",55,0)
 . Q
"RTN","GMRCACTM",56,0)
 Q
"RTN","GMRCACTM",57,0)
 ;
"RTN","GMRCACTM",58,0)
EN ;Set GMRCACTM with appropriate menu of actions based on user
"RTN","GMRCACTM",59,0)
 ;If ORFLG is DEFINED then GMRCACTM is returned as a set of codes:
"RTN","GMRCACTM",60,0)
 ;    1 = GMRCACTM USER REVIEW SCREEN - simple actions
"RTN","GMRCACTM",61,0)
 ;    2 = GMRCACTM SERVICE ACTION menu  - all actions possible for
"RTN","GMRCACTM",62,0)
 ;        clinical user in service
"RTN","GMRCACTM",63,0)
 ;    3 =  administrative user
"RTN","GMRCACTM",64,0)
 ; initialize GMRCACTM for read only
"RTN","GMRCACTM",65,0)
 S GMRCACTM="GMRCACTM USER REVIEW SCREEN"
"RTN","GMRCACTM",66,0)
 ; if service and entry aren't defined, assume read only access
"RTN","GMRCACTM",67,0)
 I '$D(XQADATA),$S('+$G(GMRCSS):1,1:0) D  Q
"RTN","GMRCACTM",68,0)
 .I $D(ORFLG) S ORFLG(GMRCIEN)=1 K GMRCACTM
"RTN","GMRCACTM",69,0)
 .Q
"RTN","GMRCACTM",70,0)
 ;
"RTN","GMRCACTM",71,0)
 ;Get the users service update level
"RTN","GMRCACTM",72,0)
 N GMRCFLG
"RTN","GMRCACTM",73,0)
 S GMRCFLG=$$VALID^GMRCAU(+GMRCSS,"",,$G(GUI))
"RTN","GMRCACTM",74,0)
 ;
"RTN","GMRCACTM",75,0)
 ;If ORFLG is all that should be returned, than set and exit
"RTN","GMRCACTM",76,0)
 I $D(ORFLG) D  Q
"RTN","GMRCACTM",77,0)
 . K GMRCACTM
"RTN","GMRCACTM",78,0)
 . I GMRCFLG=0 S ORFLG=1 Q
"RTN","GMRCACTM",79,0)
 . S ORFLG=GMRCFLG Q
"RTN","GMRCACTM",80,0)
 ;
"RTN","GMRCACTM",81,0)
 ; If GMRCSS=and IFC sending service, only allow review screen
"RTN","GMRCACTM",82,0)
 I $D(^GMR(123.5,+GMRCSS,"IFC")),$P(^("IFC"),U) S GMRCFLG=0
"RTN","GMRCACTM",83,0)
 ;
"RTN","GMRCACTM",84,0)
 ;Process the GMRCFLG value to get the GMRCACTM defined.
"RTN","GMRCACTM",85,0)
 I GMRCFLG>0 D  Q
"RTN","GMRCACTM",86,0)
 . S GMRCACTM="GMRCACTM SERVICE ACTION MENU"
"RTN","GMRCACTM",87,0)
 Q
"RTN","GMRCAFRD")
0^42^B35065187
"RTN","GMRCAFRD",1,0)
GMRCAFRD ;SLC/DLT,DCM,JFR - LM FORWARD ACTION ;1/8/02 14:36
"RTN","GMRCAFRD",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,10,12,15,22**;DEC 27, 1997
"RTN","GMRCAFRD",3,0)
 ;
"RTN","GMRCAFRD",4,0)
 ; This routine invokes IA #2395
"RTN","GMRCAFRD",5,0)
 ;
"RTN","GMRCAFRD",6,0)
FR(GMRCO) ;Forward Request to a new service
"RTN","GMRCAFRD",7,0)
 N ORVP,GMRCLCK,DFN
"RTN","GMRCAFRD",8,0)
 W !!,"Forward Request To Another Service For Action."
"RTN","GMRCAFRD",9,0)
 W !,"Select the service to send the consult to.",!
"RTN","GMRCAFRD",10,0)
 S:$D(GMRCSS) GMRCSSS=GMRCSS
"RTN","GMRCAFRD",11,0)
 N GMRCPL,GMRCPR,GMRCURG,GMRCDG,GMRCFF,GMRCORNP,GMRCAD,GMRCTO,GMRCADUZ
"RTN","GMRCAFRD",12,0)
 K GMRCQUT,GMRCSEL,GMRCSSS
"RTN","GMRCAFRD",13,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCAFRD",14,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",15,0)
 I '$$LOCK^GMRCA1(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",16,0)
 S GMRCLCK=1
"RTN","GMRCAFRD",17,0)
 ;
"RTN","GMRCAFRD",18,0)
 I $P(^GMR(123,GMRCO,0),"^",12)<3 S GMRCMSG="NO ACTION POSSIBLE. This Consult Has Already Been Completed Or Discontinued." D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",19,0)
 I $P(^GMR(123,GMRCO,0),"^",12)=13 S GMRCMSG="NO ACTION POSSIBLE. This Consult Has Already Been Cancelled." D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",20,0)
 I $P(^GMR(123,GMRCO,0),"^",12)=9 D  Q:+$G(GMRCQUT)
"RTN","GMRCAFRD",21,0)
 .S GMRCMSG="Invalid action. This consult has partial results."
"RTN","GMRCAFRD",22,0)
 .S GMRCMSG(1)="Remove the associated results before forwarding."
"RTN","GMRCAFRD",23,0)
 .D EXAC^GMRCADC(.GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",24,0)
 ;
"RTN","GMRCAFRD",25,0)
 I $D(IOBM),$D(IOTM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCAFRD",26,0)
 I $P(^GMR(123,GMRCO,0),"^",16) W !!,"This is a SERVICE ENTERED order stub.  Please send the written consult to the",!,"Service, in addition to the automated forwarding!"
"RTN","GMRCAFRD",27,0)
 S DFN=+$P(^GMR(123,GMRCO,0),"^",2)
"RTN","GMRCAFRD",28,0)
 S GMRCTO=1,GMRCASV="Forward Consult To Which Service/Specialty: "
"RTN","GMRCAFRD",29,0)
 D ASRV^GMRCASV K GMRCASV I $S($D(DTOUT):1,$D(DIROUT):1,$D(GMRCQUT):1,1:0) D END Q
"RTN","GMRCAFRD",30,0)
 I 'GMRCDG S GMRCMSG="No Service Was Selected. Consult Was Not Forwarded To Any Service!" D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",31,0)
 S GMRCFF=$P(^GMR(123,GMRCO,0),"^",5) I GMRCFF=+GMRCDG S GMRCMSG="The Forwarding Service Cannot Forward A Consult To Itself!" D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",32,0)
 S GETPROV="Who is responsible for Forwarding the Consult?"
"RTN","GMRCAFRD",33,0)
 D GETPROV^GMRCAU I '$D(GMRCORNP) D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",34,0)
 S GMRCAD=$$GETDT^GMRCUTL1 I GMRCAD="^" D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",35,0)
 I '$G(GMRCAD) S GMRCAD=$$NOW^XLFDT
"RTN","GMRCAFRD",36,0)
 N GMRCSS,GMRCSSNM,GMRCA,GMRCMSG,GMRCIROL,GMRCINM,GMRCIROU,ORSTS
"RTN","GMRCAFRD",37,0)
 D DEFAULT
"RTN","GMRCAFRD",38,0)
 S GMRCSS=+GMRCDG
"RTN","GMRCAFRD",39,0)
 I +GMRCSS,'$D(^GMR(123.5,+GMRCSS,0)) S GMRCMSG="Error in Service Chosen - SERVICE Does Not Exist!" D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",40,0)
 S GMRCSSNM=$S($L($G(^GMR(123.5,+GMRCSS,.1))):^(.1),1:$P($G(^GMR(123.5,+GMRCSS,0)),U,1))
"RTN","GMRCAFRD",41,0)
 D URG I $D(GMRCEND),GMRCEND D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",42,0)
 S GMRCA=17,DR=""
"RTN","GMRCAFRD",43,0)
 I $D(^GMR(123.5,+GMRCSS,"IFC")) D  ; if fwd to IFC serv, get extra flds
"RTN","GMRCAFRD",44,0)
 . S GMRCIROU=$P(^GMR(123.5,+GMRCSS,"IFC"),U) Q:GMRCIROU=""  ;no rout fac
"RTN","GMRCAFRD",45,0)
 . S GMRCINM=$P(^GMR(123.5,+GMRCSS,"IFC"),U,2) Q:GMRCINM=""  ;no serv nm
"RTN","GMRCAFRD",46,0)
 . S GMRCA=25,GMRCIROL="P"
"RTN","GMRCAFRD",47,0)
 . S DR=".07////^S X=GMRCIROU;.125////^S X=GMRCIROL;.131///^S X=GMRCINM;"
"RTN","GMRCAFRD",48,0)
 S DIE="^GMR(123,",DA=GMRCO,ORSTS=5
"RTN","GMRCAFRD",49,0)
 S DR=DR_"1////^S X=GMRCSS;5////^S X=GMRCURGI;8////^S X=ORSTS;9////^S X=GMRCA;.1///@"
"RTN","GMRCAFRD",50,0)
 L +^GMR(123,GMRCO):2 I '$T K DIE,DA,DR S GMRCMSG="Another User Is Accessing This Record. UPDATE WAS UNSUCCESSFUL.",GMRCMSG(1)="Try Again Later." D EXAC^GMRCADC(.GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",51,0)
 D ^DIE L -^GMR(123,GMRCO) K DIE,DA,DR
"RTN","GMRCAFRD",52,0)
 S GMRCOM=1 D AUDIT^GMRCP ;GMRCORNP is the responsible provider here
"RTN","GMRCAFRD",53,0)
 ;
"RTN","GMRCAFRD",54,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO) ;unlk before FWD changes order #
"RTN","GMRCAFRD",55,0)
 ;
"RTN","GMRCAFRD",56,0)
FRMSG ; Common logic used by GUI and List Manager to process the HL7 message
"RTN","GMRCAFRD",57,0)
 ; to update the order in OE/RR and then forward an alert to recipients
"RTN","GMRCAFRD",58,0)
 ; is passed in as the DUZ instead of the responsible provider
"RTN","GMRCAFRD",59,0)
 D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCRB),"XX^FORWARD",$G(DUZ),$G(VISIT),.GMRCOM,,$G(GMRCAD))
"RTN","GMRCAFRD",60,0)
 S GMRCADUZ=""
"RTN","GMRCAFRD",61,0)
 S GMRCORNP=$P(^GMR(123,GMRCO,0),"^",14) ;This is the original provider that ordered the consult
"RTN","GMRCAFRD",62,0)
 I +$G(GMRCORNP) S GMRCADUZ(+GMRCORNP)="" ;alert original provider of forward
"RTN","GMRCAFRD",63,0)
 S GMRCORTX="Forwarded consult "_$$ORTX^GMRCAU(+GMRCO)_" ("_GMRCURG_")"
"RTN","GMRCAFRD",64,0)
 D MSG^GMRCP(DFN,GMRCORTX,+GMRCO,27,.GMRCADUZ,1) ;GMRCO=IEN of consult from file 123; 27 is notification entry from file ORD(100.9
"RTN","GMRCAFRD",65,0)
 K GMRCOM
"RTN","GMRCAFRD",66,0)
 S GMRCDEV=$P($G(^GMR(123.5,GMRCSS,123)),"^",9)
"RTN","GMRCAFRD",67,0)
 I GMRCDEV D PRNT^GMRCUTL1(GMRCSS,+GMRCO)
"RTN","GMRCAFRD",68,0)
 D END
"RTN","GMRCAFRD",69,0)
 Q
"RTN","GMRCAFRD",70,0)
URG ;Get the default urgency
"RTN","GMRCAFRD",71,0)
 N X,Y,XQORM,DIROUT,DTOUT,DIRUT,DUOUT
"RTN","GMRCAFRD",72,0)
 I $P(^GMR(123,+GMRCO,0),"^",18)["I" D
"RTN","GMRCAFRD",73,0)
 .I GMRCTYPE="GMRCOR CONSULT" S X="GMRCURGENCYM CSLT - INPATIENT"
"RTN","GMRCAFRD",74,0)
 .S X="GMRCURGENCYM REQ - INPATIENT"
"RTN","GMRCAFRD",75,0)
 E  S X="GMRCURGENCYM - OUTPATIENT"
"RTN","GMRCAFRD",76,0)
 I '$D(GMRCURG) S GMRCURGI=$O(^ORD(101,"B","GMRCURGENCY - ROUTINE","")) S:+GMRCURGI GMRCURG=$P($G(^ORD(101,+GMRCURGI,0)),"^",2)
"RTN","GMRCAFRD",77,0)
 S Y=$O(^ORD(101,"B",X,""))
"RTN","GMRCAFRD",78,0)
 S XQORM=+Y_";ORD(101,",XQORM(0)="1A\",XQORM("A")="Urgency: ",XQORM("NO^^")=""
"RTN","GMRCAFRD",79,0)
 S:$L(GMRCURG) XQORM("B")=GMRCURG D EN^XQORM I X="^"!($D(DIROUT)) K XQORM S GMRCEND=1 Q
"RTN","GMRCAFRD",80,0)
 K XQORM(0),XQORM("A"),XQORM("B"),XQORM("NO^^") S XQORM=""
"RTN","GMRCAFRD",81,0)
 I '$D(Y) S GMRCEND=1 Q
"RTN","GMRCAFRD",82,0)
 I $D(Y(1)) S GMRCURG=$P(Y(1),"^",3),GMRCURGI=$P(Y(1),"^",2)
"RTN","GMRCAFRD",83,0)
 Q
"RTN","GMRCAFRD",84,0)
DEFAULT ;Set up defaults for editing to be equal to the existing data.
"RTN","GMRCAFRD",85,0)
 D DEM^GMRCU
"RTN","GMRCAFRD",86,0)
 N GMRC,GMRCDIC,GMRCPLI,GMRCPRI
"RTN","GMRCAFRD",87,0)
 Q:'$D(GMRCO)  S (GMRCSS,GMRCSSNM,GMRCPL,GMRCPR,GMRCPRI,GMRCURG)=""
"RTN","GMRCAFRD",88,0)
 S GMRCOM=0,GMRC(0)=$S($D(^GMR(123,+GMRCO,0)):^(0),1:"")
"RTN","GMRCAFRD",89,0)
 S GMRCSS=$P(GMRC(0),"^",5) I +GMRCSS,$D(^GMR(123.5,+GMRCSS,0)) S GMRCSSNM=$S($L($P($G(^GMR(123.5,+GMRCSS,0)),U,1)):$P(^(0),U,1),1:"")
"RTN","GMRCAFRD",90,0)
 S GMRCPLI=$P(GMRC(0),"^",10) I GMRCPLI S GMRCPL=$P($G(^ORD(101,GMRCPLI,0)),"^",2)
"RTN","GMRCAFRD",91,0)
 S GMRCURGI=$P(GMRC(0),"^",9) I GMRCURGI S GMRCURG=$P($G(^ORD(101,GMRCURGI,0)),"^",2)
"RTN","GMRCAFRD",92,0)
 S GMRCPRI=$P(GMRC(0),"^",8) I GMRCPRI["ORD(101" D
"RTN","GMRCAFRD",93,0)
 . S GMRCPR=$$GET1^DIQ(101,+GMRCPRI,1)
"RTN","GMRCAFRD",94,0)
 I $L(GMRCPRI),GMRCPRI'["ORD(101" D  ;ZPROC
"RTN","GMRCAFRD",95,0)
 . S GMRCPR=$$GET1^DIQ(123.3,+GMRCPRI,.01)
"RTN","GMRCAFRD",96,0)
TYPE ;This entry point is used when the only default needed is the GMRCTYPE
"RTN","GMRCAFRD",97,0)
 ;Called by GMRCGUIA to get variables ready for FRMSG call.
"RTN","GMRCAFRD",98,0)
 S GMRCTYPE=$$GET1^DIQ(123,+GMRCO,13,"I") ;ZPROC (P or C)
"RTN","GMRCAFRD",99,0)
 Q
"RTN","GMRCAFRD",100,0)
END ;Kill off variables and exit
"RTN","GMRCAFRD",101,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO)
"RTN","GMRCAFRD",102,0)
 K GETPROV,GMRCDG,GMRCDEV,GMRCEND,GMRCFF,GMRCOM,GMRCIFN,GMRCO,GMRCORNP
"RTN","GMRCAFRD",103,0)
 K GMRCTYPE,GMRCORTX,GMRCPL,GMRCPR,GMRCSEL,GMRCURG,GMRCADUZ,Y
"RTN","GMRCAFRD",104,0)
 K DTOUT,DIROUT,DUOUT,GMRCURGI
"RTN","GMRCAFRD",105,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCAFRD",106,0)
 Q
"RTN","GMRCART")
0^21^B68881545
"RTN","GMRCART",1,0)
GMRCART ;SLC/DCM,DLT,JFR - Result display logic ;12/17/01 22:39
"RTN","GMRCART",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,15,17,23,22**;DEC 27, 1997
"RTN","GMRCART",3,0)
 ;
"RTN","GMRCART",4,0)
 ; This routine invokes IA #2638,#10060
"RTN","GMRCART",5,0)
 ;
"RTN","GMRCART",6,0)
RT(GMRCO) ;Result Display logic - called from GMRCA1
"RTN","GMRCART",7,0)
 N GMRCCT,GMRCTMP,GMRCSR,GMRCTUFN,GMRCSTS,GMRCMSG
"RTN","GMRCART",8,0)
 ;
"RTN","GMRCART",9,0)
 S GMRCSR=$P($G(^GMR(123,+GMRCO,0)),"^",15),GMRCTUFN=$P(^(0),"^",20)
"RTN","GMRCART",10,0)
 S GMRCSTS=$P($G(^GMR(123,+GMRCO,0)),"^",12)
"RTN","GMRCART",11,0)
 I '$$RESOLUS^GMRCAU(GMRCSTS),('+GMRCSR&('GMRCTUFN)) S GMRCMSG="No results available for review." D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCART",12,0)
 ;
"RTN","GMRCART",13,0)
 W !,"Compiling Result Display..."
"RTN","GMRCART",14,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCART",15,0)
 K ^TMP("GMRCR",$J,"DT") S GMRCCT=1
"RTN","GMRCART",16,0)
 S XQORM("A")="Select Action: "
"RTN","GMRCART",17,0)
 S:$D(VALMAR) GMRCVAL=VALMAR
"RTN","GMRCART",18,0)
 S GMRCTMP="^TMP(""GMRCR"",$J,""DT"")"
"RTN","GMRCART",19,0)
 S GMRCDVL="",$P(GMRCDVL,"-",41)=""
"RTN","GMRCART",20,0)
 ;
"RTN","GMRCART",21,0)
 D GETRSLT(GMRCTMP)
"RTN","GMRCART",22,0)
 ;
"RTN","GMRCART",23,0)
 D EN^VALM("GMRC RESULTS DISPLAY")
"RTN","GMRCART",24,0)
 S:$D(GMRCVAL) VALMAR=GMRCVAL S:$D(LNCT) VALMCNT=LNCT
"RTN","GMRCART",25,0)
 D KILL^VALM10()
"RTN","GMRCART",26,0)
 K OREND,ORAGE,ORIO,ORDOB,ORFT,ORHI,ORIFN,ORNP,ORL,ORPD,ORPNM,ORPV,ORSEQ,ORSEX,ORWARD,ORDG
"RTN","GMRCART",27,0)
 K GMRCDVL,GMRCLCT,GMRCRPT,GMRCTUFN,GMRCVAL,MCFILE,MCPROC,GMRCX,GMRCTO,GMRCPRNM
"RTN","GMRCART",28,0)
 D END
"RTN","GMRCART",29,0)
 Q
"RTN","GMRCART",30,0)
 ;
"RTN","GMRCART",31,0)
GETRSLT(TMPGLOB,GMRCDET) ;load the results into global defined in TMPGLOB
"RTN","GMRCART",32,0)
 ;used for GUI formated results and list manager
"RTN","GMRCART",33,0)
 ;
"RTN","GMRCART",34,0)
 ;I GMRCDET=1 coming from a detailed display not results display
"RTN","GMRCART",35,0)
 ;
"RTN","GMRCART",36,0)
 N GMRCCT,GMRCCTS,SF,TAB
"RTN","GMRCART",37,0)
 S TAB="",$P(TAB," ",31)=""
"RTN","GMRCART",38,0)
 S GMRCDVL="",$P(GMRCDVL,"-",41)=""
"RTN","GMRCART",39,0)
 K @TMPGLOB
"RTN","GMRCART",40,0)
 S GMRCCT=1
"RTN","GMRCART",41,0)
 S:'$D(GMRCDET) GMRCDET=0
"RTN","GMRCART",42,0)
 I $L($P(^GMR(123,GMRCO,0),"^",19)) S SF=$P(^(0),"^",19),@TMPGLOB@(GMRCCT,0)="Significant Findings: "_$S(SF="Y":"**Yes**",SF="N":"No",1:"Unknown"),GMRCCT=GMRCCT+1
"RTN","GMRCART",43,0)
 ;S @TMPGLOB@(GMRCCT,0)=GMRCDVL_GMRCDVL,GMRCCT=GMRCCT+1 ;GMRCDVL_GMRCDVL
"RTN","GMRCART",44,0)
 D PRINT^GMRCTIUP(GMRCO,GMRCCT,1,GMRCDET)
"RTN","GMRCART",45,0)
 S GMRCCTS=GMRCCT ;save the line count before printing med and TIU notes
"RTN","GMRCART",46,0)
 D GETMCAR
"RTN","GMRCART",47,0)
 D GETCP
"RTN","GMRCART",48,0)
 D GETRES
"RTN","GMRCART",49,0)
 ; I '$D(GMRCDET) D GETREMOT(GMRCO,TMPGLOB,.GMRCCT)
"RTN","GMRCART",50,0)
 I GMRCCT=GMRCCTS D  ;check if count changed for notes or med results
"RTN","GMRCART",51,0)
 . S:+$L($G(SF)) @TMPGLOB@(GMRCCT,0)=GMRCDVL_GMRCDVL,GMRCCT=GMRCCT+1 ;GMRCDVL_GMRCDVL
"RTN","GMRCART",52,0)
 . S @TMPGLOB@(GMRCCT,0)="No local TIU results or Medicine results available for this consult"
"RTN","GMRCART",53,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCART",54,0)
 ;
"RTN","GMRCART",55,0)
 I '$D(GMRCDET) D GETCOM
"RTN","GMRCART",56,0)
 I GMRCCT>2 S @TMPGLOB@(GMRCCT,0)="",$P(@TMPGLOB@(GMRCCT,0),"=",81)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",57,0)
 Q
"RTN","GMRCART",58,0)
 ;
"RTN","GMRCART",59,0)
GETMCAR ;load the medicine results into TMPGLOB
"RTN","GMRCART",60,0)
 Q:'$O(^TMP("GMRCR",$J,"MCAR",0))
"RTN","GMRCART",61,0)
 N ND,ND1
"RTN","GMRCART",62,0)
 S ND=0 F  S ND=$O(^TMP("GMRCR",$J,"MCAR",ND)) Q:ND=""!(ND?1A.E)  D
"RTN","GMRCART",63,0)
 .S @TMPGLOB@(GMRCCT,0)="",$P(^(0),"-",80)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",64,0)
 .S @TMPGLOB@(GMRCCT,0)=TAB_"Medicine Package Report",GMRCCT=GMRCCT+1
"RTN","GMRCART",65,0)
 .S ND1=0 F  S ND1=$O(^TMP("GMRCR",$J,"MCAR",ND,ND1)) Q:ND1=""  S @TMPGLOB@(GMRCCT,0)=^TMP("GMRCR",$J,"MCAR",ND,ND1,0),GMRCCT=GMRCCT+1
"RTN","GMRCART",66,0)
 .Q
"RTN","GMRCART",67,0)
 K ^TMP("GMRCR",$J,"MCAR")
"RTN","GMRCART",68,0)
 Q
"RTN","GMRCART",69,0)
 ;
"RTN","GMRCART",70,0)
GETCP ; Load up any Clin. Proc. results
"RTN","GMRCART",71,0)
 Q:'$O(^TMP("GMRCR",$J,"CP",0))
"RTN","GMRCART",72,0)
 N ND,ND1
"RTN","GMRCART",73,0)
 S ND=0 F  S ND=$O(^TMP("GMRCR",$J,"CP",ND)) Q:ND=""!(ND?1A.E)  D
"RTN","GMRCART",74,0)
 .S @TMPGLOB@(GMRCCT,0)="",$P(^(0),"-",80)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",75,0)
 .S @TMPGLOB@(GMRCCT,0)=TAB_"Clinical Procedure Report",GMRCCT=GMRCCT+1
"RTN","GMRCART",76,0)
 .S ND1=0 F  S ND1=$O(^TMP("GMRCR",$J,"CP",ND,ND1)) Q:ND1=""  D
"RTN","GMRCART",77,0)
 .. S @TMPGLOB@(GMRCCT,0)=^TMP("GMRCR",$J,"CP",ND,ND1,0),GMRCCT=GMRCCT+1
"RTN","GMRCART",78,0)
 .Q
"RTN","GMRCART",79,0)
 K ^TMP("GMRCR",$J,"CP")
"RTN","GMRCART",80,0)
 Q
"RTN","GMRCART",81,0)
 ;
"RTN","GMRCART",82,0)
GETRES ;load the TIU notes into TMPGLOB
"RTN","GMRCART",83,0)
 Q:'+$O(^TMP("GMRCR",$J,"RES",0))
"RTN","GMRCART",84,0)
 ;
"RTN","GMRCART",85,0)
 N ND,ND1
"RTN","GMRCART",86,0)
 S ND=0 F  S ND=$O(^TMP("GMRCR",$J,"RES",ND)) Q:(ND="")!(ND?1A.E)  D
"RTN","GMRCART",87,0)
 . I $D(^TMP("GMRCR",$J,"RES",ND,"TEXT","GMRCRPT")) D
"RTN","GMRCART",88,0)
 . . S @TMPGLOB@(GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",89,0)
 . . S @TMPGLOB@(GMRCCT,0)=$E(GMRCDVL,1,80-$L(^TMP("GMRCR",$J,"RES",ND,"TEXT","GMRCRPT"))\2)_^("GMRCRPT")_$E(GMRCDVL,1,80-$L(^("GMRCRPT"))\2)
"RTN","GMRCART",90,0)
 . . S GMRCCT=GMRCCT+1
"RTN","GMRCART",91,0)
 . S:'$D(^TMP("GMRCR",$J,"RES",ND,"TEXT","GMRCRPT")) @TMPGLOB@(GMRCCT,0)=GMRCDVL_GMRCDVL,GMRCCT=GMRCCT+1
"RTN","GMRCART",92,0)
 . S:$O(^TMP("GMRCR",$J,"RES",ND,"TEXT",0)) @TMPGLOB@(GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",93,0)
 . S ND1=0 F  S ND1=$O(^TMP("GMRCR",$J,"RES",ND,"TEXT",ND1)) Q:ND1?1A.E!(ND1="")  S @TMPGLOB@(GMRCCT,0)=^TMP("GMRCR",$J,"RES",ND,"TEXT",ND1,0),GMRCCT=GMRCCT+1
"RTN","GMRCART",94,0)
 . I $O(^TMP("GMRCR",$J,"RES",ND,"ADD",0)) S ND1=0 F  S ND1=$O(^TMP("GMRCR",$J,"RES",ND,"ADD",ND1)) Q:ND1=""   D
"RTN","GMRCART",95,0)
 . . S @TMPGLOB@(GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",96,0)
 . . S @TMPGLOB@(GMRCCT,0)=TAB_"ADDENDUM TO REPORT",GMRCCT=GMRCCT+1
"RTN","GMRCART",97,0)
 . . S ND2=0 F  S ND2=$O(^TMP("GMRCR",$J,"RES",ND,"ADD",ND1,ND2)) Q:ND2=""!(ND2?1A.E)  S @TMPGLOB@(GMRCCT,0)=^TMP("GMRCR",$J,"RES",ND,"ADD",ND1,ND2,0),GMRCCT=GMRCCT+1
"RTN","GMRCART",98,0)
 . . Q
"RTN","GMRCART",99,0)
 . Q
"RTN","GMRCART",100,0)
 K ^TMP("GMRCR",$J,"RES")
"RTN","GMRCART",101,0)
 Q
"RTN","GMRCART",102,0)
 ;
"RTN","GMRCART",103,0)
GETCOM ;Get the comments for resolution actions
"RTN","GMRCART",104,0)
 S GMRCSTS=$P($G(^GMR(123,+GMRCO,0)),"^",12)
"RTN","GMRCART",105,0)
 Q:'$$RESOLUS^GMRCAU(+GMRCSTS) 
"RTN","GMRCART",106,0)
 ;
"RTN","GMRCART",107,0)
 ;Loop thru actions to find the resolution type actions
"RTN","GMRCART",108,0)
 N ND,ND1,ND2
"RTN","GMRCART",109,0)
 S ND="" F  S ND=$O(^GMR(123,+GMRCO,40,"B",ND)) Q:ND=""  S ND1=$O(^GMR(123,+GMRCO,40,"B",ND,"")) D
"RTN","GMRCART",110,0)
 . ;
"RTN","GMRCART",111,0)
 . ;Check for resulting action types:complete,sig finding,dc,cancel
"RTN","GMRCART",112,0)
 . N GMRCAIEN
"RTN","GMRCART",113,0)
 . S GMRCAIEN=$P($G(^GMR(123,+GMRCO,40,ND1,0)),"^",2)
"RTN","GMRCART",114,0)
 . I '$$RESOLUA^GMRCAU(GMRCAIEN) Q
"RTN","GMRCART",115,0)
 . ;
"RTN","GMRCART",116,0)
 . ;save the action header info in case there are comments
"RTN","GMRCART",117,0)
 . N GMRCAHDR,GMRCPROV,GMRCENBY,GMRCENDT
"RTN","GMRCART",118,0)
 . D SAVEHDR
"RTN","GMRCART",119,0)
 . ;
"RTN","GMRCART",120,0)
 . ;check for comments, print header on first pass
"RTN","GMRCART",121,0)
 . S ND2=0
"RTN","GMRCART",122,0)
 . F  S ND2=$O(^GMR(123,GMRCO,40,ND1,1,ND2)) Q:ND2=""  D
"RTN","GMRCART",123,0)
 . . I +$G(GMRCAHDR) D GETHDR ;GMRCAHDR will =1 on first pass
"RTN","GMRCART",124,0)
 . . S @TMPGLOB@(GMRCCT,0)=^GMR(123,GMRCO,40,ND1,1,ND2,0),GMRCCT=GMRCCT+1
"RTN","GMRCART",125,0)
 . . Q
"RTN","GMRCART",126,0)
 . Q
"RTN","GMRCART",127,0)
 Q
"RTN","GMRCART",128,0)
 ;
"RTN","GMRCART",129,0)
SAVEHDR ;Save the action header info to print later if there are comments
"RTN","GMRCART",130,0)
 S GMRCAHDR=1 ;flag to print action header on first pass of comments
"RTN","GMRCART",131,0)
 ;save the provider, entered by and date
"RTN","GMRCART",132,0)
 S GMRCPROV=$P(^GMR(123,GMRCO,40,ND1,0),"^",4),GMRCENBY=$P(^(0),"^",5)
"RTN","GMRCART",133,0)
 S GMRCENDT=$$FMTE^XLFDT($P($G(^GMR(123,GMRCO,40,ND1,0)),"^",3))
"RTN","GMRCART",134,0)
 Q
"RTN","GMRCART",135,0)
 ;
"RTN","GMRCART",136,0)
GETHDR ;Print the comment header if the action had a comment
"RTN","GMRCART",137,0)
 S @TMPGLOB@(GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCART",138,0)
 S @TMPGLOB@(GMRCCT,0)=$$CENTER^GMRCP5D("("_$P($G(^GMR(123.1,GMRCAIEN,0)),"^",8)_" Comment)"),GMRCCT=GMRCCT+1
"RTN","GMRCART",139,0)
 S @TMPGLOB@(GMRCCT,0)="      Entered by: "_$S($L(GMRCENBY):$P(^VA(200,GMRCENBY,0),"^",1),1:"")_" - "_GMRCENDT,GMRCCT=GMRCCT+1
"RTN","GMRCART",140,0)
 I +GMRCPROV S @TMPGLOB@(GMRCCT,0)="      Responsible Clinician: "_$P($G(^VA(200,GMRCPROV,0)),"^",1),GMRCCT=GMRCCT+1
"RTN","GMRCART",141,0)
 K GMRCAHDR
"RTN","GMRCART",142,0)
 Q
"RTN","GMRCART",143,0)
 ;
"RTN","GMRCART",144,0)
GETREMOT(GMRCDA,GMRCAR,GMRCNT) ;retrieve remote results and load up in display
"RTN","GMRCART",145,0)
 ; Input:
"RTN","GMRCART",146,0)
 ; GMRCDA  = consult ien from file 123
"RTN","GMRCART",147,0)
 ; GMRCAR  = array to return results in (e.g. $NA(^TMP("GMRCAR",$J)) )
"RTN","GMRCART",148,0)
 ; GMRCNT  = number within GMRCAR to start placing results (pass by ref)
"RTN","GMRCART",149,0)
 ;
"RTN","GMRCART",150,0)
 ;Output:
"RTN","GMRCART",151,0)
 ; array containing remote results in format:
"RTN","GMRCART",152,0)
 ;   ^TMP("GMRCAR",$J,1,0)= result text line 1
"RTN","GMRCART",153,0)
 ;   ^TMP("GMRCAR",$J,2,0)= result text line 2
"RTN","GMRCART",154,0)
 ;
"RTN","GMRCART",155,0)
 I '$O(^GMR(123,GMRCDA,51,0)) Q  ;no remote results
"RTN","GMRCART",156,0)
 N HDR,GMRCREM,GMRCDATA,FTR,GMRCIO
"RTN","GMRCART",157,0)
 S @GMRCAR@(GMRCNT,0)="",GMRCNT=GMRCNT+1
"RTN","GMRCART",158,0)
 S HDR=$$REPEAT^XLFSTR("*",31)_" REMOTE RESULTS "_$$REPEAT^XLFSTR("*",31)
"RTN","GMRCART",159,0)
 S FTR=$$REPEAT^XLFSTR("*",27)_" END OF REMOTE RESULTS "_$$REPEAT^XLFSTR("*",28)
"RTN","GMRCART",160,0)
 S @GMRCAR@(GMRCNT,0)=HDR,GMRCNT=GMRCNT+1
"RTN","GMRCART",161,0)
 S @GMRCAR@(GMRCNT,0)="",GMRCNT=GMRCNT+1
"RTN","GMRCART",162,0)
 S GMRCREM=0 F  S GMRCREM=$O(^GMR(123,GMRCDA,51,GMRCREM)) Q:'GMRCREM  D
"RTN","GMRCART",163,0)
 . N GMRCSITE,GMRCRES,GMRCSTA,GMRCRPC,GMRCREM0
"RTN","GMRCART",164,0)
 . S GMRCREM0=^GMR(123,GMRCDA,51,GMRCREM,0) Q:'$L(GMRCREM0)
"RTN","GMRCART",165,0)
 . S GMRCSTA=$$STA^XUAF4($P(GMRCREM0,U,3))
"RTN","GMRCART",166,0)
 . D F4^XUAF4(GMRCSTA,.GMRCSITE) I '+GMRCSITE Q
"RTN","GMRCART",167,0)
 . S GMRCRES=$P(GMRCREM0,U,2)_","
"RTN","GMRCART",168,0)
 . I GMRCRES["TIU" S GMRCRPC="TIU GET RECORD TEXT",GMRCRES=+GMRCRES
"RTN","GMRCART",169,0)
 . I GMRCRES["MCAR" S GMRCRPC="ORQQCN GET MED RESULT DETAILS"
"RTN","GMRCART",170,0)
 . D SAVDEV^%ZISUTL("GMRCIO") ; save off current device settings
"RTN","GMRCART",171,0)
 . D DIRECT^XWB2HL7(.GMRCDATA,GMRCSTA,GMRCRPC,"0",GMRCRES)
"RTN","GMRCART",172,0)
 . D USE^%ZISUTL("GMRCIO") ; restore IO to previous settings
"RTN","GMRCART",173,0)
 . D RMDEV^%ZISUTL("GMRCIO") ; kills data saved in GMRCIO
"RTN","GMRCART",174,0)
 . I '$D(GMRCDATA) Q
"RTN","GMRCART",175,0)
 . S @GMRCAR@(GMRCNT,0)=$$CJ^XLFSTR($S(GMRCRES["MCAR":"Medicine report from:",1:"TIU Document from:"),80),GMRCNT=GMRCNT+1
"RTN","GMRCART",176,0)
 . S @GMRCAR@(GMRCNT,0)=$$CJ^XLFSTR(GMRCSITE("NAME"),80)
"RTN","GMRCART",177,0)
 . S GMRCNT=GMRCNT+1
"RTN","GMRCART",178,0)
 . S @GMRCAR@(GMRCNT,0)=$$CJ^XLFSTR("Associated on: "_$$FMTE^XLFDT(+GMRCREM0),80),GMRCNT=GMRCNT+1
"RTN","GMRCART",179,0)
 . S @GMRCAR@(GMRCNT,0)="",GMRCNT=GMRCNT+1
"RTN","GMRCART",180,0)
 . N GMRCQT S GMRCQT=0
"RTN","GMRCART",181,0)
 . I '$L($G(GMRCDATA)) D
"RTN","GMRCART",182,0)
 .. N I S I="" F  S I=$O(GMRCDATA(I)) Q:I=""!(GMRCQT)  D
"RTN","GMRCART",183,0)
 ... I $P(GMRCDATA(I),U)=-1 D  S GMRCQT=1 Q
"RTN","GMRCART",184,0)
 .... S @GMRCAR@(GMRCNT,0)="Report not currently available"
"RTN","GMRCART",185,0)
 .... S GMRCNT=GMRCNT+1
"RTN","GMRCART",186,0)
 ... S @GMRCAR@(GMRCNT,0)=GMRCDATA(I),GMRCNT=GMRCNT+1
"RTN","GMRCART",187,0)
 . I $L($G(GMRCDATA)),$D(@GMRCDATA) D
"RTN","GMRCART",188,0)
 .. N I S I="" F  S I=$O(@GMRCDATA@(I)) Q:I=""!(GMRCQT)  D
"RTN","GMRCART",189,0)
 ... I $P(@GMRCDATA@(I),U)=-1 D  S GMRCQT=1 Q
"RTN","GMRCART",190,0)
 .... S @GMRCAR@(GMRCNT,0)="Report not currently available"
"RTN","GMRCART",191,0)
 .... S GMRCNT=GMRCNT+1
"RTN","GMRCART",192,0)
 ... S @GMRCAR@(GMRCNT,0)=@GMRCDATA@(I),GMRCNT=GMRCNT+1
"RTN","GMRCART",193,0)
 .. K @GMRCDATA
"RTN","GMRCART",194,0)
 . K GMRCDATA
"RTN","GMRCART",195,0)
 . Q
"RTN","GMRCART",196,0)
 S @GMRCAR@(GMRCNT,0)="",GMRCNT=GMRCNT+1
"RTN","GMRCART",197,0)
 S @GMRCAR@(GMRCNT,0)=FTR,GMRCNT=GMRCNT+1
"RTN","GMRCART",198,0)
 S @GMRCAR@(GMRCNT,0)=""
"RTN","GMRCART",199,0)
 Q
"RTN","GMRCART",200,0)
 ;
"RTN","GMRCART",201,0)
END ;kill off variables and exit
"RTN","GMRCART",202,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCART",203,0)
 K DTOUT,DIROUT,DUOUT
"RTN","GMRCART",204,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCART",205,0)
 Q
"RTN","GMRCASF")
0^52^B13068944
"RTN","GMRCASF",1,0)
GMRCASF ;SLC/DLT - Significant Findings Action ;9/8/98  03:40
"RTN","GMRCASF",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,10,14,22**;DEC 27, 1997
"RTN","GMRCASF",3,0)
SF(GMRCO) ;Evaluate Significant Findings and update accordingly
"RTN","GMRCASF",4,0)
 ;GMRCO is the selected consult
"RTN","GMRCASF",5,0)
 N GMRCQIT,GMRCLCK
"RTN","GMRCASF",6,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)  I $D(GMRCQUT) D END Q
"RTN","GMRCASF",7,0)
 I '+($G(GMRCO)) D END Q
"RTN","GMRCASF",8,0)
 I '$$LOCK^GMRCA1(GMRCO) D END Q
"RTN","GMRCASF",9,0)
 S GMRCLCK=1
"RTN","GMRCASF",10,0)
 ;
"RTN","GMRCASF",11,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCASF",12,0)
 N GMRC,GMRCSTS,GMRCSF,GMRCSFO,GMRCORTX,GMRCDR
"RTN","GMRCASF",13,0)
 S GMRC(0)=$G(^GMR(123,+GMRCO,0)) Q:GMRC(0)=""
"RTN","GMRCASF",14,0)
 ;
"RTN","GMRCASF",15,0)
 S GMRCSFO=$P(GMRC(0),"^",19)
"RTN","GMRCASF",16,0)
 W !!,"Current Significant Findings = "_$S(GMRCSFO="U":"Unknown",GMRCSFO="Y":"Yes",GMRCSFO="N":"No",1:"not entered yet"),!!
"RTN","GMRCASF",17,0)
 S GMRCSF=$$GETSIGF(GMRCSFO)
"RTN","GMRCASF",18,0)
 I GMRCSF=0 D END Q
"RTN","GMRCASF",19,0)
 ; If no change in old and new value ask if should continue
"RTN","GMRCASF",20,0)
 I GMRCSF=GMRCSFO D  I 'Y D END Q
"RTN","GMRCASF",21,0)
 . W !,"The old and new Significant Findings are the same."
"RTN","GMRCASF",22,0)
 . N DIR,DA,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCASF",23,0)
 . S DIR("A")="Do you want to proceed with this action"
"RTN","GMRCASF",24,0)
 . S DIR(0)="Y"
"RTN","GMRCASF",25,0)
 . S DIR("B")="NO"
"RTN","GMRCASF",26,0)
 . D ^DIR
"RTN","GMRCASF",27,0)
 . I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) S Y=0 Q
"RTN","GMRCASF",28,0)
 . I Y=0 Q
"RTN","GMRCASF",29,0)
 ;
"RTN","GMRCASF",30,0)
 ;Update last action and sig findings but don't change the status
"RTN","GMRCASF",31,0)
 S GMRCSTS=$P(GMRC(0),"^",12),GMRCA=4
"RTN","GMRCASF",32,0)
 S GMRCDR="8////^S X=GMRCSTS;9////^S X=GMRCA;15////^S X=GMRCSF"
"RTN","GMRCASF",33,0)
 D STATUS^GMRCP
"RTN","GMRCASF",34,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCASF",35,0)
 ;
"RTN","GMRCASF",36,0)
 S GMRCOM=1 D AUDIT^GMRCP
"RTN","GMRCASF",37,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCASF",38,0)
 ;
"RTN","GMRCASF",39,0)
 ;GMRCOM=1 tells AUDIT^GMRCP to do the word-processing logic
"RTN","GMRCASF",40,0)
 ;If an actual comment is added, $P(GMRCOM,"^",2)=1 (send alert),
"RTN","GMRCASF",41,0)
 ; if not GMRCOM=1 and no '^' exists (do not send alert)
"RTN","GMRCASF",42,0)
 D SETORTX
"RTN","GMRCASF",43,0)
 I GMRCSTS=2 D SENDALRT(GMRCORTX) Q
"RTN","GMRCASF",44,0)
 I +$P(GMRCOM,"^",2) D
"RTN","GMRCASF",45,0)
 . W !,"An alert with the following text will be sent if recipients are selected: "
"RTN","GMRCASF",46,0)
 . W !,"     "_GMRCORTX_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCASF",47,0)
 . W !
"RTN","GMRCASF",48,0)
 . I GMRCSTS'=2 W !,"or the alert will be sent when the order is completed.",!
"RTN","GMRCASF",49,0)
 . I $P($G(^GMR(123,GMRCO,12)),U,5)="F" D
"RTN","GMRCASF",50,0)
 . W !!,"The ordering provider for this inter-facility consult will "
"RTN","GMRCASF",51,0)
 . W "automatically be ",!,"notified.",!
"RTN","GMRCASF",52,0)
 . D PROCALRT^GMRCACMT(GMRCORTX,1,4,GMRCO)
"RTN","GMRCASF",53,0)
 . ;For consults not completed, the original provider may be deleted from
"RTN","GMRCASF",54,0)
 . ;the recipient list for the alert.
"RTN","GMRCASF",55,0)
 D END
"RTN","GMRCASF",56,0)
 Q
"RTN","GMRCASF",57,0)
 ;
"RTN","GMRCASF",58,0)
SETORTX ;Set prefix text for the alert
"RTN","GMRCASF",59,0)
 S GMRCORTX=$S(GMRCSF="N":"No ",GMRCSF="Y":"",1:"Unknown ")
"RTN","GMRCASF",60,0)
 S GMRCORTX=GMRCORTX_"Sig Findings for "_$P($G(^ORD(100.01,+GMRCSTS,0)),"^",2)_" consult " Q
"RTN","GMRCASF",61,0)
 Q
"RTN","GMRCASF",62,0)
 ;
"RTN","GMRCASF",63,0)
SENDALRT(GMRCORTX) ;Send to the requesting provider
"RTN","GMRCASF",64,0)
 N GMRCRP,GMRCADUZ,GMRCDELR
"RTN","GMRCASF",65,0)
 S GMRCRP=$P($G(^GMR(123,+GMRCO,0)),U,14) ;requesting clinician
"RTN","GMRCASF",66,0)
 I +GMRCRP S GMRCADUZ(+GMRCRP)=""
"RTN","GMRCASF",67,0)
 W !,"Alert will be sent to Requesting Provider: "_$P($G(^VA(200,+GMRCRP,0)),U,1)
"RTN","GMRCASF",68,0)
 S GMRCDELR=0
"RTN","GMRCASF",69,0)
 D ANDTO^GMRCACMT
"RTN","GMRCASF",70,0)
 D SENDMSG^GMRCACMT(23,+GMRCO)
"RTN","GMRCASF",71,0)
 ;Sig Findings uses the CONSULT/REQUEST RESOLUTION (23) notification
"RTN","GMRCASF",72,0)
 Q
"RTN","GMRCASF",73,0)
 ;
"RTN","GMRCASF",74,0)
GETSIGF(GMRCSFO) ;Get the significant findings
"RTN","GMRCASF",75,0)
 ;GMRCSFO is the old significant findings value
"RTN","GMRCASF",76,0)
 N DIR,DA,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCASF",77,0)
 S DIR(0)="123,15"
"RTN","GMRCASF",78,0)
 S DIR("B")=GMRCSFO
"RTN","GMRCASF",79,0)
 S:DIR("B")="" DIR("B")="unknown"
"RTN","GMRCASF",80,0)
 S DIR("A")="Are there significant findings? (Y/N/U)"
"RTN","GMRCASF",81,0)
 D ^DIR
"RTN","GMRCASF",82,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q 0
"RTN","GMRCASF",83,0)
 Q Y
"RTN","GMRCASF",84,0)
 ;
"RTN","GMRCASF",85,0)
END ;cleanup variables
"RTN","GMRCASF",86,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO) ;JFR
"RTN","GMRCASF",87,0)
 K GMRCO,GMRCA,GMRCMSG,GMRCOM,GMRCSEL,GMRCERR,GMRCERMS
"RTN","GMRCASF",88,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCASF",89,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCASF",90,0)
 Q
"RTN","GMRCASV")
0^13^B64890269
"RTN","GMRCASV",1,0)
GMRCASV ;SLC/KCM,DLT - Build ^TMP("GMRCS" of Svc(s)/Specialties ; 11/25/2000
"RTN","GMRCASV",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,12,18,22**;DEC 27, 1997
"RTN","GMRCASV",3,0)
 ; This routine invokes IA #2426
"RTN","GMRCASV",4,0)
 ;
"RTN","GMRCASV",5,0)
ASRV ;Ask for service/specialty group {output} GMRCDG,GMRCBUF,GMRCACT,^TMP("GMRCS",$J,^TMP("GMRCSLIST",$J
"RTN","GMRCASV",6,0)
 K GMRCQUT
"RTN","GMRCASV",7,0)
 N GMRCSEL
"RTN","GMRCASV",8,0)
 D SERV0 D:GMRCDG SERV1
"RTN","GMRCASV",9,0)
 K W,X,Y Q
"RTN","GMRCASV",10,0)
SERV0 ;Assume that the lookup must begin with ALL SERVICES, or value of GMRCSVNM
"RTN","GMRCASV",11,0)
 ;GMRCASV=the ask prompt text
"RTN","GMRCASV",12,0)
 ;GMRCSVNM=text to use for default name
"RTN","GMRCASV",13,0)
 S GMRCDG=0
"RTN","GMRCASV",14,0)
 S:$G(GMRCASV)["Forward" GMRCTO=1
"RTN","GMRCASV",15,0)
 F  D ASKPRMPT S:X["^^" DIROUT=1 S:X["^" GMRCQUT=1 Q:X["^"  D @$S(X["?":"LISTALL",1:"LKUP") D:($L($G(GMRCSVNM))&GMRCDG) LISTSRV Q:GMRCDG
"RTN","GMRCASV",16,0)
 Q
"RTN","GMRCASV",17,0)
ASKPRMPT ;Write the prompt and do the Read to get the user text entered in X
"RTN","GMRCASV",18,0)
 W !!,$S($D(GMRCASV):GMRCASV,1:"Select Service/Specialty: ")_$S($L($G(GMRCSVNM)):GMRCSVNM,1:"ALL SERVICES")_"// "
"RTN","GMRCASV",19,0)
 R X:DTIME
"RTN","GMRCASV",20,0)
 I '$T S X="^"
"RTN","GMRCASV",21,0)
 I X'["^" S X=$S($G(GMRCASV)["Forward"&('$L(X)):"^",'$L(X):"ALL SERVICES",1:X) Q
"RTN","GMRCASV",22,0)
 Q
"RTN","GMRCASV",23,0)
SERV1 ;Create selected SERVICE ^TMP array of service information
"RTN","GMRCASV",24,0)
 ;If GMRCTO=1 then the BILD section will not include disabled or tracking services which the user cannot send to.
"RTN","GMRCASV",25,0)
 N GMRCDGT
"RTN","GMRCASV",26,0)
 S GMRCBUF=GMRCDG
"RTN","GMRCASV",27,0)
 I GMRCBUF>0 D
"RTN","GMRCASV",28,0)
 . K ^TMP("GMRCS",$J),^TMP("GMRCSLIST",$J)
"RTN","GMRCASV",29,0)
 . S GMRCDGT=0,GMRCSEL="BILD" D EN
"RTN","GMRCASV",30,0)
 . S GMRCGRP("NAM")=^GMR(123.5,GMRCBUF,0)
"RTN","GMRCASV",31,0)
 . S (GMRCDG,GMRCGRP("ROOT"))=GMRCBUF
"RTN","GMRCASV",32,0)
 . S GMRCGRP("NAM")=$S($L($P(GMRCGRP("NAM"),"^",3)):$P(GMRCGRP("NAM"),"^",3),1:$E($P(GMRCGRP("NAM"),"^"),1,5))
"RTN","GMRCASV",33,0)
 K GMRCSEQ,GMRCBUF
"RTN","GMRCASV",34,0)
 Q
"RTN","GMRCASV",35,0)
LKUP ;Ask the user for the service; use the value of x for lookup; branch to list on ??
"RTN","GMRCASV",36,0)
 ; Patch 18 added Identifier to 123.5 in place of DIC("W")
"RTN","GMRCASV",37,0)
 ; Remove commented line in next patch.
"RTN","GMRCASV",38,0)
 ;S DIC="^GMR(123.5,",DIC(0)="MNEQZ"
"RTN","GMRCASV",39,0)
 ;D ^DIC K DIC
"RTN","GMRCASV",40,0)
 S DIC="^GMR(123.5,",DIC(0)="MNEQZ",D="B^D"
"RTN","GMRCASV",41,0)
 D MIX^DIC1 K DIC
"RTN","GMRCASV",42,0)
 I '$D(Y(0)) D LISTALL Q
"RTN","GMRCASV",43,0)
 N W,GMRCEXCL I +$G(GMRCTO) D
"RTN","GMRCASV",44,0)
 . S W=Y(0),GMRCDG=+Y
"RTN","GMRCASV",45,0)
 . S GMRCEXCL=0 D EXCLUDE
"RTN","GMRCASV",46,0)
 . I GMRCEXCL=1 S GMRCSVNM=Y(0,0),GMRCEXCL=0 Q
"RTN","GMRCASV",47,0)
 . K GMRCSVNM ;Service selected is not a grouper for lookup
"RTN","GMRCASV",48,0)
 . I GMRCEXCL=9 S GMRCMSG="You have selected a disabled service!" D EXAC^GMRCADC(GMRCMSG) K GMRCMSG Q
"RTN","GMRCASV",49,0)
 . I GMRCEXCL=3 S GMRCMSG="You may not forward this Inter-facility Consult to another inter-facility consult service." D EXAC^GMRCADC(GMRCMSG) K GMRCMSG Q
"RTN","GMRCASV",50,0)
 . N GMRCDAD D CHECKDAD
"RTN","GMRCASV",51,0)
 . I GMRCEXCL=90 S GMRCMSG="You have selected a service that is not part of the ALL SERVICES hierarchy!",GMRCMSG(1)="Contact Consult ADPAC" D EXAC^GMRCADC(.GMRCMSG) K GMRCMSG Q
"RTN","GMRCASV",52,0)
 . ;I GMRCEXCL=9 S GMRCMSG="You have selected a service whose parent is disabled!" D EXAC^GMRCADC(GMRCMSG) K GMRCMSG Q
"RTN","GMRCASV",53,0)
 . I GMRCEXCL=2 S GMRCMSG="You have selected a service whose parent is a tracking service!",GMRCMSG(1)="You do not have authorization to send consults to this service." D EXAC^GMRCADC(.GMRCMSG) K GMRCMSG Q
"RTN","GMRCASV",54,0)
 . I GMRCEXCL=3 S GMRCMSG="You may not forward this Inter-facility Consult to another inter-facility consult service." D EXAC^GMRCADC(GMRCMSG) K GMRCMSG Q
"RTN","GMRCASV",55,0)
 I +$G(GMRCEXCL) S Y=0,GMRCDG=0
"RTN","GMRCASV",56,0)
 S:Y>0 GMRCDG=+Y ;falls to here when service is a grouper or not excluded
"RTN","GMRCASV",57,0)
 Q
"RTN","GMRCASV",58,0)
 ;
"RTN","GMRCASV",59,0)
LISTOPT ;called from option to list hierarchy
"RTN","GMRCASV",60,0)
 S %ZIS="Q"
"RTN","GMRCASV",61,0)
 D ^%ZIS I POP Q
"RTN","GMRCASV",62,0)
 I $D(IO("Q")) D QUEUE^GMRCASV1 D ^%ZISC,HOME^%ZIS Q
"RTN","GMRCASV",63,0)
 D PRTLST
"RTN","GMRCASV",64,0)
 D ^%ZISC,HOME^%ZIS
"RTN","GMRCASV",65,0)
 Q
"RTN","GMRCASV",66,0)
 ;
"RTN","GMRCASV",67,0)
PRTLST ;queued entry point or just print it
"RTN","GMRCASV",68,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","GMRCASV",69,0)
 U IO
"RTN","GMRCASV",70,0)
 N GMRCPRT,GMRCPG,GMRCTO,GMRCDG,GMRCOUT
"RTN","GMRCASV",71,0)
 N DUOUT,DTOUT,DIROUT
"RTN","GMRCASV",72,0)
 S GMRCPG=0,GMRCPRT=1
"RTN","GMRCASV",73,0)
 D PAGE^GMRCASV1(.GMRCPG)
"RTN","GMRCASV",74,0)
 D LISTALL I $D(GMRCOUT) Q
"RTN","GMRCASV",75,0)
 I $Y>(IOSL-4) D READ I $D(GMRCOUT) Q
"RTN","GMRCASV",76,0)
 W !!,"Services not currently part of the Consults Hierarchy:"
"RTN","GMRCASV",77,0)
 N SERV S SERV=1
"RTN","GMRCASV",78,0)
 F  S SERV=$O(^GMR(123.5,SERV)) Q:'SERV  Q:$D(GMRCOUT)  D
"RTN","GMRCASV",79,0)
 . I '$D(^GMR(123.5,"APC",SERV)) D
"RTN","GMRCASV",80,0)
 .. I $Y>(IOSL-4) D READ I $D(GMRCOUT) Q
"RTN","GMRCASV",81,0)
 .. W !,?3,$P(^GMR(123.5,SERV,0),U) I '$P(^(0),U,2) Q
"RTN","GMRCASV",82,0)
 .. N USE S USE=$P(^GMR(123.5,SERV,0),U,2)
"RTN","GMRCASV",83,0)
 .. W "  ("
"RTN","GMRCASV",84,0)
 .. W $S(USE=1:"Grouper Only",USE=9:"Disabled",1:"Tracking Only")_")"
"RTN","GMRCASV",85,0)
 K GMRCDG D EXIT
"RTN","GMRCASV",86,0)
 Q
"RTN","GMRCASV",87,0)
LISTALL ;display LIST of Services in their hierarchy beginning with ALL SERVICES
"RTN","GMRCASV",88,0)
 S GMRCDG=$O(^GMR(123.5,"B","ALL SERVICES",0)) Q:'GMRCDG
"RTN","GMRCASV",89,0)
 S GMRCSEL="DISP" W:'$D(GMRCPRT) @IOF D EN
"RTN","GMRCASV",90,0)
 S GMRCDG=0 W !
"RTN","GMRCASV",91,0)
 Q
"RTN","GMRCASV",92,0)
LISTSRV ;display LIST of sub-services beginning with a selected service
"RTN","GMRCASV",93,0)
 S GMRC1=0,GMRCDG=$O(^GMR(123.5,"B",GMRCSVNM,0)) Q:'GMRCDG
"RTN","GMRCASV",94,0)
 S GMRCSEL="DISP" W @IOF D EN
"RTN","GMRCASV",95,0)
 S GMRCDG=0 W !
"RTN","GMRCASV",96,0)
 Q
"RTN","GMRCASV",97,0)
EN ;Setup Specialty groups   entry: GMRCDG,GMRCSEL   exit: GMRCGRP if GMRCSEL="BILD"
"RTN","GMRCASV",98,0)
 N GMRCSTK,PARENT,GMRCUSG,GMRCEXCL
"RTN","GMRCASV",99,0)
 S GMRCSTK=0,PARENT=0 ;beginning service logic
"RTN","GMRCASV",100,0)
 D @GMRCSEL Q:$D(DUOUT)!($D(DIROUT))!($D(GMRCOUT))
"RTN","GMRCASV",101,0)
EN1 ;GMRCSTK is used to manage the level of stacks under beginning service
"RTN","GMRCASV",102,0)
 S GMRCSTK=1,GMRCSTK(GMRCSTK)=GMRCDG_"^0",GMRCSTK(0)=0,GMRCMEM=0,GMRCNAM=""
"RTN","GMRCASV",103,0)
 F  S GMRCNAM=$O(^GMR(123.5,+GMRCSTK(GMRCSTK),10,"AC",GMRCNAM)) D  D @$S(+GMRCMEM'>0:"POP",1:"PROC") Q:GMRCSTK<1
"RTN","GMRCASV",104,0)
 . I $G(GMRCEXCL) S GMRCMEM=0 Q  ;Exclude children of excluded parent
"RTN","GMRCASV",105,0)
 . I '$L(GMRCNAM) S GMRCMEM=0 ;No more 10th node children
"RTN","GMRCASV",106,0)
 . E  S GMRCMEM=$O(^GMR(123.5,+GMRCSTK(GMRCSTK),10,"AC",GMRCNAM,""))
"RTN","GMRCASV",107,0)
 K DUOUT,GMRCMEM,GMRCNAM,GMRCSTK,GMRCSEL
"RTN","GMRCASV",108,0)
 Q
"RTN","GMRCASV",109,0)
POP ;Go back one level in service stack hierarchy and initialize exclude
"RTN","GMRCASV",110,0)
 S GMRCSTK=GMRCSTK-1,GMRCMEM=$P(GMRCSTK(GMRCSTK),"^",2),GMRCNAM=$P(GMRCSTK(GMRCSTK),"^",3),GMRCEXCL=0
"RTN","GMRCASV",111,0)
 Q
"RTN","GMRCASV",112,0)
PROC ;GMRCMEM is the member ien in the 10th node being processed
"RTN","GMRCASV",113,0)
 ;GMRCDG is the ien of file 123.5 being processed
"RTN","GMRCASV",114,0)
 ;GMRCNAM is the services name
"RTN","GMRCASV",115,0)
 S $P(GMRCSTK(GMRCSTK),"^",2)=GMRCMEM
"RTN","GMRCASV",116,0)
 S $P(GMRCSTK(GMRCSTK),"^",3)=GMRCNAM
"RTN","GMRCASV",117,0)
 Q:'$D(^GMR(123.5,+GMRCSTK(GMRCSTK),10,GMRCMEM,0))  ;ghost "AC" x-ref 
"RTN","GMRCASV",118,0)
 S GMRCDG=$P(^GMR(123.5,+GMRCSTK(GMRCSTK),10,GMRCMEM,0),"^",1)
"RTN","GMRCASV",119,0)
 S PARENT=+GMRCSTK(GMRCSTK)
"RTN","GMRCASV",120,0)
 S W=$G(^GMR(123.5,GMRCDG,0))
"RTN","GMRCASV",121,0)
 I $G(GMRCTO)=1 S GMRCEXCL=0 D EXCLUDE S:GMRCEXCL=1 GMRCEXCL=0 ;Includes grouper only
"RTN","GMRCASV",122,0)
 D:'+$G(GMRCEXCL) @GMRCSEL G:($D(DUOUT)!$D(DIROUT)) EXIT
"RTN","GMRCASV",123,0)
 ;Initialize a stack level entry to process children of the multiple
"RTN","GMRCASV",124,0)
 S GMRCSTK=GMRCSTK+1,GMRCSTK(GMRCSTK)=GMRCDG_"^0",GMRCMEM=0,GMRCNAM=""
"RTN","GMRCASV",125,0)
 Q
"RTN","GMRCASV",126,0)
DISP ;Display individual entries alphabetically for each service as processed
"RTN","GMRCASV",127,0)
 Q:$D(GMRCOUT)
"RTN","GMRCASV",128,0)
 I $Y>(IOSL-4) D READ S:$D(DUOUT)!($D(DIROUT)) GMRCSTK=0 G:GMRCSTK=0 EXIT
"RTN","GMRCASV",129,0)
 S W=$G(^GMR(123.5,GMRCDG,0))
"RTN","GMRCASV",130,0)
 S GMRCUSG=$P(W,"^",2)
"RTN","GMRCASV",131,0)
 W !,?((GMRCSTK*2)),$S(GMRCUSG=9:"<",1:"")_$P(W,"^")_$S(GMRCUSG=9:">",1:"")_"  "_$S(GMRCUSG=1:"(Grouper Only)",GMRCUSG=2:"(Tracking Only)",GMRCUSG=9:"<Disabled>",1:"")_"  "_$S($G(^GMR(123.5,GMRCDG,"IFC")):"(Inter-facility)",1:"")
"RTN","GMRCASV",132,0)
 Q
"RTN","GMRCASV",133,0)
BILD ;The following logic will build an array for review for GUI
"RTN","GMRCASV",134,0)
 ;GMRCDGT=sequential number,GMRCDG=service pointer,
"RTN","GMRCASV",135,0)
 ;W=^GMR(123.5,GMRCDG,0),1st piece is name, 2nd piece usage
"RTN","GMRCASV",136,0)
 ;If GMRCTO=1 then services that only consults can be sent to will be
"RTN","GMRCASV",137,0)
 ;included with the exception of "grouper only" which keeps the
"RTN","GMRCASV",138,0)
 ;hierarchy in order.
"RTN","GMRCASV",139,0)
 N CHILD
"RTN","GMRCASV",140,0)
 S W=$G(^GMR(123.5,GMRCDG,0))
"RTN","GMRCASV",141,0)
 S ^TMP("GMRCS",$J,GMRCDG)=$P(W,"^")
"RTN","GMRCASV",142,0)
 S GMRCDGT=GMRCDGT+1
"RTN","GMRCASV",143,0)
 S CHILD=$O(^GMR(123.5,GMRCDG,10,0)) S CHILD=$S(+CHILD:"+",1:"")
"RTN","GMRCASV",144,0)
 S ^TMP("GMRCSLIST",$J,GMRCDGT)=GMRCDG_U_$P(W,"^")_U_PARENT_U_CHILD_U_$P(W,"^",2)
"RTN","GMRCASV",145,0)
 Q
"RTN","GMRCASV",146,0)
EXCLUDE ;This logic excludes services the user cannot send a consult to.
"RTN","GMRCASV",147,0)
 ;If GMRCTO=1 the user is forwarding or sending a consult
"RTN","GMRCASV",148,0)
 ;W=zeroth node of service,GMRCDG=ien of service,GMRCO=ien of consult (optional)
"RTN","GMRCASV",149,0)
 Q:'$L($G(W))
"RTN","GMRCASV",150,0)
 S GMRCEXCL=+$P(W,"^",2) ;Include grouper for hierarchy building only
"RTN","GMRCASV",151,0)
 I $G(GMRCTO),$G(GMRCO) D  ;exclude fwd'ing into IFC svc
"RTN","GMRCASV",152,0)
 . I $P($G(^GMR(123,+GMRCO,12)),U,5)'="F" Q
"RTN","GMRCASV",153,0)
 . I +$G(^GMR(123.5,+GMRCDG,"IFC")) S GMRCEXCL=3 Q
"RTN","GMRCASV",154,0)
 . I $L($P($G(^GMR(123.5,+GMRCDG,"IFC")),U,2)) S GMRCEXCL=3 Q
"RTN","GMRCASV",155,0)
 I GMRCEXCL=2 D  ;tracking service exclusion check
"RTN","GMRCASV",156,0)
 . N GMRCSRV I +$G(GMRCO) S GMRCSRV=$P($G(^GMR(123,+GMRCO,0)),"^",5) I $D(^GMR(123.5,"APC",+GMRCDG,+GMRCSRV)) S GMRCEXCL=0 Q  ;Checks if parent is the consults current service
"RTN","GMRCASV",157,0)
 . I $$VALID^GMRCAU(+GMRCDG,,DUZ) S GMRCEXCL=0 ;update user?
"RTN","GMRCASV",158,0)
 . Q
"RTN","GMRCASV",159,0)
 Q
"RTN","GMRCASV",160,0)
CHECKDAD ;Check the service usage statuses for a selected services parents
"RTN","GMRCASV",161,0)
 ;There are two passes, one to get any user accessible parent
"RTN","GMRCASV",162,0)
 ;and the second pass is through the GMRCDAD array to check the parents usage
"RTN","GMRCASV",163,0)
 ;The GMRCEXCL value is returned for exclusion due to parent
"RTN","GMRCASV",164,0)
 S GMRCDAD=""
"RTN","GMRCASV",165,0)
 ;FIRST PASS
"RTN","GMRCASV",166,0)
 F  S GMRCDAD=$O(^GMR(123.5,"APC",+GMRCDG,GMRCDAD)) Q:GMRCDAD=""  D  I $P($G(GMRCDAD(+GMRCDAD)),U,2)="OK" S GMRCEXCL="OK"
"RTN","GMRCASV",167,0)
 . S GMRCDAD(+GMRCDAD)=$P(^GMR(123.5,+GMRCDAD,0),U,2) ;dads service usage
"RTN","GMRCASV",168,0)
 . ;I $P($G(^GMR(123.5,+GMRCDAD,0)),U,1)="ALL SERVICES" S $P(GMRCDAD(GMRCDAD),U,2,3)="OK^ALL" Q  ;If one of the dad's is all services, than OK to send to if not previously excluded.
"RTN","GMRCASV",169,0)
 . I GMRCDAD(+GMRCDAD)=1 S $P(GMRCDAD(+GMRCDAD),"^",2)="OK" Q  ;Groupers Only are OK!
"RTN","GMRCASV",170,0)
 . I $$VALID^GMRCAU(+GMRCDAD,,DUZ) S $P(GMRCDAD(GMRCDAD),U,2,3)="OK^Update access" ;update user?
"RTN","GMRCASV",171,0)
 . Q
"RTN","GMRCASV",172,0)
 I GMRCEXCL="OK" S GMRCEXCL=0 Q  ;There is a parent which user has access to.
"RTN","GMRCASV",173,0)
 ;Second Pass of the GMRCDAD array (multiple parents)
"RTN","GMRCASV",174,0)
 S GMRCDAD=$O(GMRCDAD("")) I 'GMRCDAD S GMRCEXCL=90 Q  ;Not part of hierarchy; missing dad
"RTN","GMRCASV",175,0)
 ;Use first parent found in hierarchy.
"RTN","GMRCASV",176,0)
 S GMRCEXCL=+GMRCDAD(GMRCDAD)
"RTN","GMRCASV",177,0)
 Q
"RTN","GMRCASV",178,0)
READ ;;Hold screen
"RTN","GMRCASV",179,0)
 I $D(IOST) Q:$E(IOST)'="C"
"RTN","GMRCASV",180,0)
 W ! I $D(IOSL),$Y<(IOSL-4) G READ
"RTN","GMRCASV",181,0)
 N X W !?5,"Press RETURN to continue, ^ to exit: " R X:DTIME
"RTN","GMRCASV",182,0)
 S:X="^" DUOUT=1 S:'$T!(X="^^") DIROUT=1
"RTN","GMRCASV",183,0)
 I $D(DUOUT)!$D(DIROUT) S:$D(GMRCPRT) GMRCOUT=1
"RTN","GMRCASV",184,0)
 W @IOF
"RTN","GMRCASV",185,0)
 I '$D(DTOUT),('$D(DUOUT))&($D(GMRCPRT)) D PAGE^GMRCASV1(.GMRCPG)
"RTN","GMRCASV",186,0)
 Q
"RTN","GMRCASV",187,0)
 ;
"RTN","GMRCASV",188,0)
EXIT ;Kill off variables and quit
"RTN","GMRCASV",189,0)
 K DIROUT,DUOUT,DTOUT,DIRUT
"RTN","GMRCASV",190,0)
 Q
"RTN","GMRCASV1")
0^45^B4425153
"RTN","GMRCASV1",1,0)
GMRCASV1 ;SLC/JFR - HIERARCHY MGMT cont'd ; 01/10/02 21:34
"RTN","GMRCASV1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**18,15,23,22**;DEC 27, 1997
"RTN","GMRCASV1",3,0)
 ;
"RTN","GMRCASV1",4,0)
 ; This routine invokes IA #3252
"RTN","GMRCASV1",5,0)
 ;
"RTN","GMRCASV1",6,0)
 Q  ; don't start at the top
"RTN","GMRCASV1",7,0)
GUI(GMRCARR,GMRCSTRT,GMRCWHY,GMRCSYN,GMRCO) ;;return CSLT services for GUI
"RTN","GMRCASV1",8,0)
 ;Input:
"RTN","GMRCASV1",9,0)
 ; GMRCARR - passed in as the array to return results in
"RTN","GMRCASV1",10,0)
 ; GMRCSTRT- service to begin building from
"RTN","GMRCASV1",11,0)
 ; GMRCWHY - 0 for display, 1 for forwarding or ordering
"RTN","GMRCASV1",12,0)
 ; GMRCSYN - Boolean: 1=return synonyms, 0=do not
"RTN","GMRCASV1",13,0)
 ; GMRCO   - consult ien from file 123
"RTN","GMRCASV1",14,0)
 ;Output: Array formatted as follows-
"RTN","GMRCASV1",15,0)
 ;      svc ien^svc name or syn^parent^has children^svc usage
"RTN","GMRCASV1",16,0)
 ;
"RTN","GMRCASV1",17,0)
 N GMRCDG,GMRCGRP,GMRCTO
"RTN","GMRCASV1",18,0)
 S GMRCDG=GMRCSTRT,GMRCTO=GMRCWHY
"RTN","GMRCASV1",19,0)
 D SERV1^GMRCASV I '$D(^TMP("GMRCSLIST",$J)) Q
"RTN","GMRCASV1",20,0)
 I '$G(GMRCSYN) M @GMRCARR=^TMP("GMRCSLIST",$J) Q  ;no synonyms needed
"RTN","GMRCASV1",21,0)
 N GMRC,GMRCSVC,GMRCS,NEXT,PIEC
"RTN","GMRCASV1",22,0)
 S GMRC=0,NEXT=$O(^TMP("GMRCSLIST",$J," "),-1)+1
"RTN","GMRCASV1",23,0)
 F  S GMRC=$O(^TMP("GMRCSLIST",$J,GMRC)) Q:'GMRC  Q:$P(^TMP("GMRCSLIST",$J,GMRC),U,5)="S"  D
"RTN","GMRCASV1",24,0)
 . I $P(^TMP("GMRCSLIST",$J,GMRC),U,5)=1 Q
"RTN","GMRCASV1",25,0)
 . S GMRCSVC=+^TMP("GMRCSLIST",$J,GMRC)
"RTN","GMRCASV1",26,0)
 . S GMRCS=0
"RTN","GMRCASV1",27,0)
 . F  S GMRCS=$O(^GMR(123.5,GMRCSVC,2,GMRCS)) Q:'GMRCS  D
"RTN","GMRCASV1",28,0)
 .. S PIEC(1)=GMRCSVC
"RTN","GMRCASV1",29,0)
 .. S PIEC(2)=$P(^GMR(123.5,GMRCSVC,0),U)
"RTN","GMRCASV1",30,0)
 .. S PIEC(2)=^GMR(123.5,GMRCSVC,2,GMRCS,0)_"  <"_PIEC(2)_">"
"RTN","GMRCASV1",31,0)
 .. S ^TMP("GMRCSLIST",$J,NEXT)=PIEC(1)_"^"_PIEC(2)_"^^^S"
"RTN","GMRCASV1",32,0)
 .. S NEXT=NEXT+1
"RTN","GMRCASV1",33,0)
 .. Q
"RTN","GMRCASV1",34,0)
 . Q
"RTN","GMRCASV1",35,0)
 M @GMRCARR=^TMP("GMRCSLIST",$J)
"RTN","GMRCASV1",36,0)
 K ^TMP("GMRCSLIST",$J)
"RTN","GMRCASV1",37,0)
 Q
"RTN","GMRCASV1",38,0)
 ;
"RTN","GMRCASV1",39,0)
PAGE(PG) ;print header and increment page
"RTN","GMRCASV1",40,0)
 S PG=PG+1
"RTN","GMRCASV1",41,0)
 W !,"Consult Hierarchy list",?30,$$HTE^XLFDT($H),?60,"Page: ",PG
"RTN","GMRCASV1",42,0)
 W !,$$REPEAT^XLFSTR("-",78)
"RTN","GMRCASV1",43,0)
 Q
"RTN","GMRCASV1",44,0)
 ;
"RTN","GMRCASV1",45,0)
QUEUE ; queue up the print
"RTN","GMRCASV1",46,0)
 N ZTRTN,ZTSK,ZTIO,ZTDTH,ZTDESC
"RTN","GMRCASV1",47,0)
 S ZTRTN="PRTLST^GMRCASV",ZTDESC="Consult Service Hierarchy List"
"RTN","GMRCASV1",48,0)
 S ZTIO=ION,ZTDTH=$H
"RTN","GMRCASV1",49,0)
 D ^%ZTLOAD
"RTN","GMRCASV1",50,0)
 I $G(ZTSK) W !,"Queued to Print, Task # ",ZTSK
"RTN","GMRCASV1",51,0)
 E  W !,"Sorry, Try again Later"
"RTN","GMRCASV1",52,0)
 Q
"RTN","GMRCAU")
0^27^B65349968
"RTN","GMRCAU",1,0)
GMRCAU ;SLC/DLT,JFR - Action Utilities  ;10/17/01 18:31
"RTN","GMRCAU",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,11,14,12,15,17,22**;DEC 27, 1997
"RTN","GMRCAU",3,0)
 ;
"RTN","GMRCAU",4,0)
 ; This routine invokes IA #2324,#2692
"RTN","GMRCAU",5,0)
 ;
"RTN","GMRCAU",6,0)
GETPROV K GMRCORNP N DIR S DIR(0)="123.02,3"
"RTN","GMRCAU",7,0)
 S DIR("A")=$S($D(GETPROV):GETPROV,1:"Responsible Clinician")
"RTN","GMRCAU",8,0)
 D ^DIR K DIR I $D(DTOUT)!$D(DIROUT)!(X="^") S GMRCQIT="Q" Q
"RTN","GMRCAU",9,0)
 G:Y<1 GETPROV S GMRCORNP=+Y
"RTN","GMRCAU",10,0)
 Q
"RTN","GMRCAU",11,0)
GETDT ;Get actual activity date
"RTN","GMRCAU",12,0)
 K GMRCQIT,%
"RTN","GMRCAU",13,0)
 D NOW^%DTC S (X,GMRCDT)=% D REGDTM^GMRCU S GMRCAD=X
"RTN","GMRCAU",14,0)
 S DIR(0)="123.02,2",DIR("A")=$S($D(GETDT):GETDT,1:"Date/Time of Actual Activity"),DIR("B")="NOW" D ^DIR K DIR I $D(DIRUT) S GMRCQIT="Q" Q
"RTN","GMRCAU",15,0)
 I X="NOW" K GMRCAD,Y Q
"RTN","GMRCAU",16,0)
 S GMRCAD=Y K X,Y,DIRUT,DUOUT
"RTN","GMRCAU",17,0)
 Q
"RTN","GMRCAU",18,0)
ORTX(GMRCO) ;Get the abbreviated text for alert displays
"RTN","GMRCAU",19,0)
 ;GMRCO is the consult entry from 123
"RTN","GMRCAU",20,0)
 N GMRCSVC,GMRCSSNM,GMRCPROC,GMRCORTX
"RTN","GMRCAU",21,0)
 S GMRCSSNM=$$SVC(GMRCO)
"RTN","GMRCAU",22,0)
 S GMRCPROC=$$PROC(GMRCO)
"RTN","GMRCAU",23,0)
 S GMRCORTX=$S($L(GMRCPROC):($E(GMRCSSNM,1,10)_" "_$E(GMRCPROC,1,10)),1:$E(GMRCSSNM,1,20))
"RTN","GMRCAU",24,0)
 Q GMRCORTX
"RTN","GMRCAU",25,0)
 ;
"RTN","GMRCAU",26,0)
SVC(GMRCO) ;Get abbreviated service text
"RTN","GMRCAU",27,0)
 N GMRCSSNM,GMRCSVC
"RTN","GMRCAU",28,0)
 S GMRCSVC=$P(^GMR(123,+GMRCO,0),"^",5),GMRCSSNM=""
"RTN","GMRCAU",29,0)
 I +GMRCSVC S GMRCSSNM=$S($L($G(^GMR(123.5,+GMRCSVC,.1))):^(.1),1:$P($G(^GMR(123.5,+GMRCSVC,0)),U,1))
"RTN","GMRCAU",30,0)
 Q GMRCSSNM
"RTN","GMRCAU",31,0)
PROC(GMRCO) ;Get abbreviated procedure text
"RTN","GMRCAU",32,0)
 N GMRCPROC
"RTN","GMRCAU",33,0)
 S GMRCPROC=$P(^GMR(123,+GMRCO,0),"^",8)
"RTN","GMRCAU",34,0)
 I +GMRCPROC S GMRCPROC=$$GET1^DIQ(123.3,+GMRCPROC,.01)
"RTN","GMRCAU",35,0)
 Q GMRCPROC
"RTN","GMRCAU",36,0)
 ;
"RTN","GMRCAU",37,0)
LMTX(GMRCO) ;Get the text for list manager displays
"RTN","GMRCAU",38,0)
 ;GMRCO is the consult entry from 123
"RTN","GMRCAU",39,0)
 N GMRCSVC,GMRCSSNM,GMRCREQ,GMRCORTX
"RTN","GMRCAU",40,0)
 S GMRCSSNM=$$SVC(GMRCO)
"RTN","GMRCAU",41,0)
 S GMRCREQ=$$PROC(GMRCO)
"RTN","GMRCAU",42,0)
 S GMRCORTX=$S($L(GMRCREQ):($E(GMRCSSNM,1,10)_" "_$E(GMRCREQ,1,10)),1:$E(GMRCSSNM,1,20))
"RTN","GMRCAU",43,0)
 Q GMRCORTX
"RTN","GMRCAU",44,0)
 ;
"RTN","GMRCAU",45,0)
 ;
"RTN","GMRCAU",46,0)
VALID(GMRCSER,GMRCO,GMRCUSER,GMRCTST,GMRCIFC) ;Get users update authority
"RTN","GMRCAU",47,0)
 ; check GMRCSS and all parents for authority
"RTN","GMRCAU",48,0)
 ; codes returned are same as $$VALIDU
"RTN","GMRCAU",49,0)
 N GMRCUPDL,GMRCLIS,GMRCHKD,GMRCNT,GMRCLP,GMRCQUIT
"RTN","GMRCAU",50,0)
 I '$G(GMRCUSER) S GMRCUSER=DUZ
"RTN","GMRCAU",51,0)
 ; check initial service first
"RTN","GMRCAU",52,0)
 S GMRCUPDL=$$VALIDU(GMRCSER,GMRCUSER,$G(GMRCIFC)) I +GMRCUPDL D  G VALEX
"RTN","GMRCAU",53,0)
 . I $G(GMRCTST) S $P(GMRCUPDL,U,3)=$P($G(^GMR(123.5,+GMRCSER,0)),U)
"RTN","GMRCAU",54,0)
 S GMRCHKD(+GMRCSER)="",GMRCNT=1
"RTN","GMRCAU",55,0)
 ; find parents if set to process, quit if none
"RTN","GMRCAU",56,0)
 I '$P($G(^GMR(123.5,+GMRCSER,0)),U,7) G VALEX ;process parents = 0
"RTN","GMRCAU",57,0)
 D FINDPAR(GMRCSER,.GMRCNT) I '$D(GMRCLIS) S GMRCUPDL=0 G VALEX
"RTN","GMRCAU",58,0)
 S GMRCLP=0
"RTN","GMRCAU",59,0)
 F  S GMRCLP=$O(GMRCLIS(GMRCLP)) Q:'GMRCLP!($D(GMRCQUIT))  D  I +GMRCUPDL G VALEX
"RTN","GMRCAU",60,0)
 . I +$P(GMRCLIS(GMRCLP),U,2) K GMRCLIS(GMRCLP) Q  ;been checked
"RTN","GMRCAU",61,0)
 . I '$D(GMRCHKD(+GMRCLIS(GMRCLP))) D
"RTN","GMRCAU",62,0)
 .. ; check parent 
"RTN","GMRCAU",63,0)
 .. S GMRCUPDL=$$VALIDU(+GMRCLIS(GMRCLP),GMRCUSER,$G(GMRCIFC))
"RTN","GMRCAU",64,0)
 .. S GMRCHKD(+GMRCLIS(GMRCLP))=""
"RTN","GMRCAU",65,0)
 . S $P(GMRCLIS(GMRCLP),U,2)=1
"RTN","GMRCAU",66,0)
 . I +GMRCUPDL D  Q  ;got one
"RTN","GMRCAU",67,0)
 .. S:$G(GMRCTST) $P(GMRCUPDL,U,3)=$P($G(^GMR(123.5,+GMRCLIS(GMRCLP),0)),U)
"RTN","GMRCAU",68,0)
 . I $P(^GMR(123.5,+GMRCLIS(GMRCLP),0),U,7) D  ;process parents
"RTN","GMRCAU",69,0)
 .. D FINDPAR(+GMRCLIS(GMRCLP),.GMRCNT)
"RTN","GMRCAU",70,0)
 . S GMRCLP=0 ;start back at top and don't miss any
"RTN","GMRCAU",71,0)
VALEX Q GMRCUPDL
"RTN","GMRCAU",72,0)
FINDPAR(SERV,ARCNT)     ;find parents of SERV
"RTN","GMRCAU",73,0)
 ; SERV = service to find parents of
"RTN","GMRCAU",74,0)
 ; ARCNT = next array element
"RTN","GMRCAU",75,0)
 N PARENT
"RTN","GMRCAU",76,0)
 S PARENT=0
"RTN","GMRCAU",77,0)
 F  S PARENT=$O(^GMR(123.5,"APC",SERV,PARENT)) Q:'PARENT  D
"RTN","GMRCAU",78,0)
 . S GMRCLIS(ARCNT)=PARENT
"RTN","GMRCAU",79,0)
 . S ARCNT=ARCNT+1
"RTN","GMRCAU",80,0)
 Q
"RTN","GMRCAU",81,0)
 ;
"RTN","GMRCAU",82,0)
VALIDU(GMRCSS,GMRCUSR,GMRCIFC) ;Check to see if user is an update user
"RTN","GMRCAU",83,0)
 ;The value returned is the equivalent of this set of codes:
"RTN","GMRCAU",84,0)
 ;    0 = not an update user
"RTN","GMRCAU",85,0)
 ;    2 = update user
"RTN","GMRCAU",86,0)
 ;    3 = administrative update user
"RTN","GMRCAU",87,0)
 ;    4 = admin AND update user
"RTN","GMRCAU",88,0)
 ;    5 = IFC coordinator
"RTN","GMRCAU",89,0)
 ;
"RTN","GMRCAU",90,0)
 N GMRCUPD,GMRCAD,GMRCUP
"RTN","GMRCAU",91,0)
 I '$G(GMRCUSR) S GMRCUSR=DUZ
"RTN","GMRCAU",92,0)
 I '+$G(GMRCSS) Q 0
"RTN","GMRCAU",93,0)
 S GMRCAD=0,GMRCUP=0
"RTN","GMRCAU",94,0)
 I $G(GMRCIFC),$P($G(^GMR(123.5,GMRCSS,"IFC")),U,3) Q 5
"RTN","GMRCAU",95,0)
 I 'GMRCUP,+$P($G(^GMR(123.5,GMRCSS,0)),U,6) S GMRCUP=2_$$FIELD(.06)
"RTN","GMRCAU",96,0)
 I 'GMRCUP,$D(^GMR(123.5,+GMRCSS,123.3,"B",GMRCUSR)) D
"RTN","GMRCAU",97,0)
 . S GMRCUP=2_$$FIELD(123.3)
"RTN","GMRCAU",98,0)
 I 'GMRCUP,GMRCUSR=$P($G(^GMR(123.5,+GMRCSS,123)),"^",8) D
"RTN","GMRCAU",99,0)
 . S GMRCUP=2_$$FIELD(123.08)
"RTN","GMRCAU",100,0)
 I $D(^GMR(123.5,+GMRCSS,123.33,"B",GMRCUSR)) S GMRCAD=3_$$FIELD(123.33)
"RTN","GMRCAU",101,0)
 ;
"RTN","GMRCAU",102,0)
 I GMRCAD,GMRCUP Q $$BOTH(GMRCAD,GMRCUP) ;admin and upd user
"RTN","GMRCAU",103,0)
 ;
"RTN","GMRCAU",104,0)
 S GMRCUPD=0
"RTN","GMRCAU",105,0)
 ; check service teams to notify, update teams w/o
"RTN","GMRCAU",106,0)
 I 'GMRCUP N NODE F NODE=123.1,123.31 D  I +GMRCUP Q
"RTN","GMRCAU",107,0)
 . I '$D(^GMR(123.5,+GMRCSS,NODE)) Q
"RTN","GMRCAU",108,0)
 . D TEAM(.GMRCUP,NODE,GMRCUSR)
"RTN","GMRCAU",109,0)
 ;
"RTN","GMRCAU",110,0)
 I GMRCAD,GMRCUP Q $$BOTH(GMRCUP,GMRCAD) ;admin and upd user
"RTN","GMRCAU",111,0)
 ;
"RTN","GMRCAU",112,0)
 I 'GMRCAD D  ;check adm teams w/o
"RTN","GMRCAU",113,0)
 . I '$D(^GMR(123.5,+GMRCSS,123.34)) Q
"RTN","GMRCAU",114,0)
 . D TEAM(.GMRCAD,123.34,GMRCUSR)
"RTN","GMRCAU",115,0)
 ; 
"RTN","GMRCAU",116,0)
 I GMRCAD,GMRCUP Q $$BOTH(GMRCUP,GMRCAD) ;admin and upd user
"RTN","GMRCAU",117,0)
 ;
"RTN","GMRCAU",118,0)
 ; check ASU user classes in field 123.35
"RTN","GMRCAU",119,0)
 I 'GMRCUP S GMRCUP=$$USR(GMRCSS,GMRCUSR)
"RTN","GMRCAU",120,0)
 ;
"RTN","GMRCAU",121,0)
 I GMRCAD,GMRCUP Q $$BOTH(GMRCUP,GMRCAD) ;admin and upd
"RTN","GMRCAU",122,0)
 ;
"RTN","GMRCAU",123,0)
 I 'GMRCUP I $D(^GMR(123.5,+GMRCSS,123.2)) D LOC(.GMRCUP)
"RTN","GMRCAU",124,0)
 ;
"RTN","GMRCAU",125,0)
 I GMRCAD,GMRCUP Q $$BOTH(GMRCUP,GMRCAD) ;admin and upd
"RTN","GMRCAU",126,0)
 I GMRCUP,'GMRCAD Q GMRCUP ;update user only
"RTN","GMRCAU",127,0)
 I GMRCAD,'GMRCUP Q GMRCAD ;admin user only
"RTN","GMRCAU",128,0)
 Q 0
"RTN","GMRCAU",129,0)
 ;
"RTN","GMRCAU",130,0)
BOTH(ADMN,UPD) ;return string with fields if testing
"RTN","GMRCAU",131,0)
 I $G(GMRCTST) Q "4^"_$P(ADMN,U,2)_" and "_$P(UPD,U,2)
"RTN","GMRCAU",132,0)
 Q 4
"RTN","GMRCAU",133,0)
 ;
"RTN","GMRCAU",134,0)
LOC(GMRCUPD) ;Check for the DUZ in the NOTIFICATION BY PT LOCATION multiple
"RTN","GMRCAU",135,0)
 N GMRCL,GMRCTM
"RTN","GMRCAU",136,0)
 S GMRCL=0 ;Check if DUZ is associated with any location/ward
"RTN","GMRCAU",137,0)
 F  S GMRCL=$O(^GMR(123.5,+GMRCSS,123.2,GMRCL))  Q:'GMRCL!+GMRCUPD  D  Q:+GMRCUPD
"RTN","GMRCAU",138,0)
 . ;Get user and/or team assigned to location
"RTN","GMRCAU",139,0)
 . S GMRCL(0)=$G(^GMR(123.5,+GMRCSS,123.2,+GMRCL,0))
"RTN","GMRCAU",140,0)
 . I $P(GMRCL(0),"^",2)=DUZ S GMRCUPD=2 Q
"RTN","GMRCAU",141,0)
 . I $P(GMRCL(0),"^",3) S GMRCTM=$P(GMRCL(0),"^",3) ;D CHKTM
"RTN","GMRCAU",142,0)
 Q
"RTN","GMRCAU",143,0)
 ;
"RTN","GMRCAU",144,0)
TEAM(TYPE,SUBSC,USER) ;Check for the DUZ in the multiple of SUBSC
"RTN","GMRCAU",145,0)
 N GMRCTM,GMRCHIT
"RTN","GMRCAU",146,0)
 S GMRCTM=""
"RTN","GMRCAU",147,0)
 I '$G(USER) S USER=DUZ
"RTN","GMRCAU",148,0)
 F  S GMRCTM=$O(^GMR(123.5,GMRCSS,SUBSC,"B",GMRCTM)) Q:'GMRCTM!+TYPE  D
"RTN","GMRCAU",149,0)
 . S GMRCHIT=$$CHKTM(GMRCTM,USER) Q:'GMRCHIT
"RTN","GMRCAU",150,0)
 . S TYPE=$S(SUBSC=123.34:3,1:2)_$$FIELD(SUBSC)
"RTN","GMRCAU",151,0)
 Q
"RTN","GMRCAU",152,0)
 ;
"RTN","GMRCAU",153,0)
CHKTM(TEAM,PERS) ;checks for PERS in list of users on TEAM
"RTN","GMRCAU",154,0)
 ;Input:  TEAM must be set to the Order Team entry number
"RTN","GMRCAU",155,0)
 ;Output: 1 will be returned PERS is on TEAM
"RTN","GMRCAU",156,0)
 N ND,GMRCLST,FOUND
"RTN","GMRCAU",157,0)
 S GMRCLST=""
"RTN","GMRCAU",158,0)
 D TEAMPROV^ORQPTQ1(.GMRCLST,TEAM)
"RTN","GMRCAU",159,0)
 I $P(GMRCLST(1),"^",2)="No providers found." Q 0
"RTN","GMRCAU",160,0)
 S ND=0
"RTN","GMRCAU",161,0)
 F  S ND=$O(GMRCLST(ND)) Q:ND=""  I +GMRCLST(ND)=PERS S FOUND=1 Q
"RTN","GMRCAU",162,0)
 Q $S($G(FOUND):1,1:0)
"RTN","GMRCAU",163,0)
 ;
"RTN","GMRCAU",164,0)
USR(SERV,USER) ; check USR classes for user
"RTN","GMRCAU",165,0)
 N UCLS,UPD
"RTN","GMRCAU",166,0)
 I '$O(^GMR(123.5,+SERV,123.35,0)) Q 0
"RTN","GMRCAU",167,0)
 S UCLS=0,UPD=0
"RTN","GMRCAU",168,0)
 F  S UCLS=$O(^GMR(123.5,+SERV,123.35,"B",UCLS)) Q:'UCLS!(+UPD)  D
"RTN","GMRCAU",169,0)
 . Q:'UCLS
"RTN","GMRCAU",170,0)
 . S UPD=$$ISA^USRLM(USER,UCLS)
"RTN","GMRCAU",171,0)
 . I +UPD S UPD=2_$$FIELD(123.35)
"RTN","GMRCAU",172,0)
 . Q
"RTN","GMRCAU",173,0)
 Q UPD
"RTN","GMRCAU",174,0)
FIELD(GMRCFLD) ;return field name where became update user
"RTN","GMRCAU",175,0)
 I '$G(GMRCTST) Q ""
"RTN","GMRCAU",176,0)
 D FIELD^DID(123.5,GMRCFLD,,"LABEL","GMRCFLD")
"RTN","GMRCAU",177,0)
 Q "^"_$G(GMRCFLD("LABEL"))
"RTN","GMRCAU",178,0)
COMPLETE(GMRCA) ;Determine if the action is a complete action (10,13,14)
"RTN","GMRCAU",179,0)
 S GMRCA=$G(GMRCA)
"RTN","GMRCAU",180,0)
 Q $S(GMRCA=13:1,GMRCA=14:1,GMRCA=10:1,1:0)
"RTN","GMRCAU",181,0)
 ;   10=administrative complete, 13=ADDENDUM ADDED, 14=New Note
"RTN","GMRCAU",182,0)
 ;
"RTN","GMRCAU",183,0)
RESOLUA(GMRCA) ;Determine if action has resolution info for clinician
"RTN","GMRCAU",184,0)
 ;Action value is based on value in ^ORD(100.01,"
"RTN","GMRCAU",185,0)
 ;Returns 1 for consult resolution, 0 for pending resolution
"RTN","GMRCAU",186,0)
 S GMRCA=$G(GMRCA)
"RTN","GMRCAU",187,0)
 Q $S(GMRCA=4:1,GMRCA=6:1,GMRCA=10:1,GMRCA=11:1,GMRCA=12:1,GMRCA=13:1,GMRCA=14:1,GMRCA=19:1,1:0)
"RTN","GMRCAU",188,0)
 ;    4=Sig Findings, 6=discontinued, 10=administrative complete
"RTN","GMRCAU",189,0)
 ;    11=Edit/resubmit
"RTN","GMRCAU",190,0)
 ;    12=Disassociate result, 13=Addendum Added, 14=New Note
"RTN","GMRCAU",191,0)
 ;    19=cancelled
"RTN","GMRCAU",192,0)
 ;
"RTN","GMRCAU",193,0)
RESOLUS(GMRCSTS) ;Determine status indicates the consult has a resolution
"RTN","GMRCAU",194,0)
 ;Status value is based on values in ^ORD(100.01,"
"RTN","GMRCAU",195,0)
 ;Returns 1 for consult resolution, 0 for pending resolution
"RTN","GMRCAU",196,0)
 S GMRCSTS=$G(GMRCSTS)
"RTN","GMRCAU",197,0)
 Q $S(GMRCSTS:1,GMRCSTS=2:1,GMRCSTS=13:1,1:0)
"RTN","GMRCAU",198,0)
 ;    1=dc,2=comp,13=canc
"RTN","GMRCAU",199,0)
 ;
"RTN","GMRCAU",200,0)
TEST ;called from GMRC UPDATE AUTHORITY
"RTN","GMRCAU",201,0)
 ; determines how a user gets update authority for a service 
"RTN","GMRCAU",202,0)
 W !
"RTN","GMRCAU",203,0)
 N GMRCSRV,GMRCUSR,UPD,GMRCDG,GMRC1
"RTN","GMRCAU",204,0)
 N DIR,DIROUT,DIRUT,DUOUT,DTOUT,X,Y
"RTN","GMRCAU",205,0)
 S DIR(0)="PO^123.5:EM",DIR("A")="Select Consult Service"
"RTN","GMRCAU",206,0)
 S DIR("?")="Choose the consult service to check update status of user"
"RTN","GMRCAU",207,0)
 S DIR("??")="^D TESTHELP^GMRCAU(""ALL SERVICES"")" D ^DIR
"RTN","GMRCAU",208,0)
 I $D(DIRUT) Q
"RTN","GMRCAU",209,0)
 S GMRCSRV=+Y
"RTN","GMRCAU",210,0)
 N DIR
"RTN","GMRCAU",211,0)
 S DIR(0)="PO^200:EM",DIR("A")="Choose user to check for update status"
"RTN","GMRCAU",212,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCAU",213,0)
 S GMRCUSR=+Y
"RTN","GMRCAU",214,0)
 S UPD=$$VALID(GMRCSRV,,GMRCUSR,1)
"RTN","GMRCAU",215,0)
 I +UPD=0 W !!,"This user has no update authority"
"RTN","GMRCAU",216,0)
 I +UPD D
"RTN","GMRCAU",217,0)
 . I +UPD=2 W !!,"This user is an update user for: ",$P(UPD,U,3)
"RTN","GMRCAU",218,0)
 . I +UPD=3 W !!,"This user is an administrative user for: ",$P(UPD,U,3)
"RTN","GMRCAU",219,0)
 . I +UPD=4 D
"RTN","GMRCAU",220,0)
 .. W !!,"This user is both and administrative and update user"
"RTN","GMRCAU",221,0)
 .. W " for: ",!,$P(UPD,U,3)
"RTN","GMRCAU",222,0)
 . W !,"via the ",$P(UPD,U,2)," field",$S(+UPD=4:"(s).",1:".")
"RTN","GMRCAU",223,0)
 . W ! I $L($P(UPD,U,3)) D
"RTN","GMRCAU",224,0)
 .. I $P(UPD,U,3)'=$P(^GMR(123.5,+GMRCSRV,0),U) D HIER^GMRCT($P(UPD,U,3))
"RTN","GMRCAU",225,0)
 W !!
"RTN","GMRCAU",226,0)
 K GMRCSRV,GMRCUSR,UPD
"RTN","GMRCAU",227,0)
 K DIR,DIROUT,DIRUT,DUOUT,DTOUT,X,Y
"RTN","GMRCAU",228,0)
 G TEST
"RTN","GMRCAU",229,0)
TESTHELP(GMRCSVNM) ;wrapper for LISTSRV^GMRCASV
"RTN","GMRCAU",230,0)
 N DIR,GMRC1,GMRCDG
"RTN","GMRCAU",231,0)
 D LISTSRV^GMRCASV
"RTN","GMRCAU",232,0)
 Q
"RTN","GMRCAU",233,0)
TSTINTRO ;entry action of GMRC UPDATE AUTHORITY option
"RTN","GMRCAU",234,0)
 W !!,"This option will allow you to check a user's update authority for any given"
"RTN","GMRCAU",235,0)
 W !,"service in the consults hierarchy.  If the PROCESS PARENTS FOR UPDATES field"
"RTN","GMRCAU",236,0)
 W !,"is set to YES, all ancestors of the selected service will be checked."
"RTN","GMRCAU",237,0)
 W !,"The type of update authority and the service to which they are assigned will"
"RTN","GMRCAU",238,0)
 W !,"be displayed.",!!
"RTN","GMRCAU",239,0)
 Q
"RTN","GMRCDIS")
0^35^B32914586
"RTN","GMRCDIS",1,0)
GMRCDIS ;SLC/JFR - LM ROUTINE TO DISASSOCIATE MED RESULTS; 11/5/01 11:20
"RTN","GMRCDIS",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**15,22**;DEC 27, 1997
"RTN","GMRCDIS",3,0)
 ;
"RTN","GMRCDIS",4,0)
 ; This routine invokes IA #2324,#3042,#3120
"RTN","GMRCDIS",5,0)
 ;
"RTN","GMRCDIS",6,0)
EN ;invoke list template
"RTN","GMRCDIS",7,0)
 D EN^VALM("GMRC DISASSOC RESULTS")
"RTN","GMRCDIS",8,0)
 Q
"RTN","GMRCDIS",9,0)
HDR ;format list template header
"RTN","GMRCDIS",10,0)
 N GMRCVTIT
"RTN","GMRCDIS",11,0)
 S GMRCVTIT="Procedure/Medicine Resulting"
"RTN","GMRCDIS",12,0)
 D HDR^GMRCSLDT
"RTN","GMRCDIS",13,0)
 S VALMHDR(2)="Consult No.: "_GMRCO
"RTN","GMRCDIS",14,0)
 S VALMHDR(2)=$$SETSTR^VALM1("Associated Medicine Results",VALMHDR(2),30,28)
"RTN","GMRCDIS",15,0)
 Q
"RTN","GMRCDIS",16,0)
PHDR    ;set protocols into actions
"RTN","GMRCDIS",17,0)
 S VALMSG=$$CJ^XLFSTR("Select action or item number    ?? for help",80)
"RTN","GMRCDIS",18,0)
 S XQORM("M")=3
"RTN","GMRCDIS",19,0)
 D SHOW^VALM
"RTN","GMRCDIS",20,0)
 S XQORM("#")=$O(^ORD(101,"B","GMRCACT SELECT MED RESULT",0))_"^1:"_VALMCNT
"RTN","GMRCDIS",21,0)
 S XQORM("KEY","EX")=$O(^ORD(101,"B","GMRCACT QUIT",0))_"^1"
"RTN","GMRCDIS",22,0)
 S XQORM("KEY","Q")=$O(^ORD(101,"B","GMRCACT QUIT",0))_"^1"
"RTN","GMRCDIS",23,0)
 S XQORM("KEY","CLOSE")=$O(^ORD(101,"B","GMRCACT QUIT",0))_"^1"
"RTN","GMRCDIS",24,0)
 S XQORM("KEY","NX")=$O(^ORD(101,"B","GMRCACT NEXT SCREEN",0))_"^1"
"RTN","GMRCDIS",25,0)
 S XQORM("KEY","DM")=$O(^ORD(101,"B","GMRCACT DISASSOC MED RSLT",0))_"^1"
"RTN","GMRCDIS",26,0)
 S XQORM("KEY","DR")=$O(^ORD(101,"B","GMRCACT DISPLAY MED RESULT",0))_"^1"
"RTN","GMRCDIS",27,0)
 Q
"RTN","GMRCDIS",28,0)
INIT ; set up array into ^TMP("GMRCR",$J,"DT"...
"RTN","GMRCDIS",29,0)
 ; should already have it
"RTN","GMRCDIS",30,0)
 S VALMCNT=$O(^TMP("GMRCR",$J,"DT",999999),-1),VALMBG=1
"RTN","GMRCDIS",31,0)
 Q
"RTN","GMRCDIS",32,0)
GETRES(GMRCO) ; get associated MEDICINE results and format
"RTN","GMRCDIS",33,0)
 N RES,GMRCMCR,CNT,DATA
"RTN","GMRCDIS",34,0)
 S RES=0,CNT=1
"RTN","GMRCDIS",35,0)
 F  S RES=$O(^GMR(123,GMRCO,50,RES)) Q:'RES  D
"RTN","GMRCDIS",36,0)
 . I $G(^GMR(123,GMRCO,50,RES,0))'["MCAR" Q
"RTN","GMRCDIS",37,0)
 . S GMRCMCR=$$SINGLE^MCAPI(^GMR(123,GMRCO,50,RES,0))
"RTN","GMRCDIS",38,0)
 . S DATA=""
"RTN","GMRCDIS",39,0)
 . S DATA=$$SETSTR^VALM1(CNT,DATA,2,$L(CNT))
"RTN","GMRCDIS",40,0)
 . S DATA=$$SETSTR^VALM1($P(GMRCMCR,U),DATA,6,23)
"RTN","GMRCDIS",41,0)
 . S DATA=$$SETSTR^VALM1($P(GMRCMCR,U,6),DATA,30,$L($P(GMRCMCR,U,6)))
"RTN","GMRCDIS",42,0)
 . S DATA=$$SETSTR^VALM1($P(GMRCMCR,U,7),DATA,50,$L($P(GMRCMCR,U,7)))
"RTN","GMRCDIS",43,0)
 . S ^TMP("GMRCR",$J,"DT",CNT,0)=DATA
"RTN","GMRCDIS",44,0)
 . S ^TMP("GMRCR",$J,"DT",CNT,1)=^GMR(123,GMRCO,50,RES,0)
"RTN","GMRCDIS",45,0)
 . S CNT=CNT+1
"RTN","GMRCDIS",46,0)
 Q
"RTN","GMRCDIS",47,0)
DIS(GMRCO) ;select consult and start disassoc process
"RTN","GMRCDIS",48,0)
 N GMRCQUT,GMRCQIT,GMRCSS,GMRCMSG
"RTN","GMRCDIS",49,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) Q
"RTN","GMRCDIS",50,0)
 I '+$G(GMRCO) Q
"RTN","GMRCDIS",51,0)
 I '$$LOCK^GMRCA1(GMRCO) Q
"RTN","GMRCDIS",52,0)
 S GMRCMSG=$$REMUSR(GMRCO,DUZ) I '+GMRCMSG D  Q
"RTN","GMRCDIS",53,0)
 . N MSG
"RTN","GMRCDIS",54,0)
 . I '$L($P(GMRCMSG,U,2)) D
"RTN","GMRCDIS",55,0)
 .. S MSG="You are not authorized to disassociate results."
"RTN","GMRCDIS",56,0)
 . D EXAC^GMRCADC($S($D(MSG):MSG,1:$P(GMRCMSG,U,2)))
"RTN","GMRCDIS",57,0)
 D GETRES(GMRCO)
"RTN","GMRCDIS",58,0)
 D EN
"RTN","GMRCDIS",59,0)
 D UNLOCK^GMRCA1(GMRCO)
"RTN","GMRCDIS",60,0)
 Q
"RTN","GMRCDIS",61,0)
EXIT ;
"RTN","GMRCDIS",62,0)
 K ^TMP("GMRCR",$J,"DT")
"RTN","GMRCDIS",63,0)
 Q
"RTN","GMRCDIS",64,0)
EN1(GMRCRSLT) ; select result and verify remove action
"RTN","GMRCDIS",65,0)
 I '+$G(^TMP("GMRCR",$J,"DT",1,1)) D  Q  ;no result there
"RTN","GMRCDIS",66,0)
 . D EXAC^GMRCADC("There are no results to remove")
"RTN","GMRCDIS",67,0)
 N RESTXT,RESULT,DIR,X,Y,DUOUT,DTOUT,DIROUT
"RTN","GMRCDIS",68,0)
 I '$G(ITEM),'$G(GMRCMEDR) D  Q:'ITEM
"RTN","GMRCDIS",69,0)
 . S ITEM=$$SELECT^GMRCMED(VALMCNT)
"RTN","GMRCDIS",70,0)
 . D SET^GMRCMED(ITEM)
"RTN","GMRCDIS",71,0)
 I $G(GMRCMEDR) S ITEM=GMRCMEDR
"RTN","GMRCDIS",72,0)
 D FULL^VALM1
"RTN","GMRCDIS",73,0)
 S RESTXT=$E(^TMP("GMRCR",$J,"DT",ITEM,0),6,80)
"RTN","GMRCDIS",74,0)
 S RESULT=^TMP("GMRCR",$J,"DT",ITEM,1) Q:'+RESULT
"RTN","GMRCDIS",75,0)
 S DIR(0)="YA",DIR("B")="NO"
"RTN","GMRCDIS",76,0)
 S DIR("A",1)="",DIR("A",2)="   "_RESTXT,DIR("A",3)=""
"RTN","GMRCDIS",77,0)
 S DIR("A")="Are you sure you want to disassociate this result? "
"RTN","GMRCDIS",78,0)
 D ^DIR I Y<1 Q
"RTN","GMRCDIS",79,0)
 D REMOVE(GMRCO,RESULT)
"RTN","GMRCDIS",80,0)
 Q
"RTN","GMRCDIS",81,0)
REMOVE(GMRCO,RSLT,GMRCAD,GMRCORNP) ;disassociate result
"RTN","GMRCDIS",82,0)
 ; remove rslt, log actv, update sts, send alerts
"RTN","GMRCDIS",83,0)
 ; Input:
"RTN","GMRCDIS",84,0)
 ;  GMRCO    - ien from file 123
"RTN","GMRCDIS",85,0)
 ;  RSLT     - medicine result in var ptr form (e.g. "19;MCAR(691.5,")
"RTN","GMRCDIS",86,0)
 ;  GMRCAD   - FM date/time of action (optional)
"RTN","GMRCDIS",87,0)
 ;  GMRCORNP - DUZ of person performing action  (optional) 
"RTN","GMRCDIS",88,0)
 ;
"RTN","GMRCDIS",89,0)
 N GMRCRES,DIK,DA,GMRCQUT,GMRCQIT
"RTN","GMRCDIS",90,0)
 S GMRCRES=$O(^GMR(123,+GMRCO,50,"B",RSLT,0)) I 'GMRCRES D  Q
"RTN","GMRCDIS",91,0)
 . D EXAC^GMRCADC("This result is no longer associated with the request")
"RTN","GMRCDIS",92,0)
 ; delete result entry
"RTN","GMRCDIS",93,0)
 S DA(1)=+GMRCO,DA=GMRCRES,DIK="^GMR(123,"_DA(1)_",50," D ^DIK
"RTN","GMRCDIS",94,0)
 I $P(^GMR(123,+GMRCO,0),U,15)=RSLT D
"RTN","GMRCDIS",95,0)
 . N DA,DIE,DR
"RTN","GMRCDIS",96,0)
 . S DIE="^GMR(123,",DA=+GMRCO,DR="11///@" D ^DIE
"RTN","GMRCDIS",97,0)
 ; update activity tracking
"RTN","GMRCDIS",98,0)
 N GMRCA,GMRCRSLT
"RTN","GMRCDIS",99,0)
 S GMRCA=12,GMRCRSLT=RSLT
"RTN","GMRCDIS",100,0)
 D AUDIT^GMRCP
"RTN","GMRCDIS",101,0)
 ; Update status back to active if not completed before
"RTN","GMRCDIS",102,0)
 N GMRCDFN,GMRCTYP
"RTN","GMRCDIS",103,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),U,2)
"RTN","GMRCDIS",104,0)
 I $$STSCHG(GMRCO) D
"RTN","GMRCDIS",105,0)
 . N GMRCSTS
"RTN","GMRCDIS",106,0)
 . S GMRCSTS=6 D STATUS^GMRCP
"RTN","GMRCDIS",107,0)
 . ; update CPRS
"RTN","GMRCDIS",108,0)
 . S GMRCTYP=$P(^GMR(123,+GMRCO,0),U,17)
"RTN","GMRCDIS",109,0)
 . D EN^GMRCHL7(GMRCDFN,+GMRCO,GMRCTYP,"","SC",$G(GMRCORNP),"")
"RTN","GMRCDIS",110,0)
 ; send notification?
"RTN","GMRCDIS",111,0)
 I '$G(GMRCORNP) S GMRCORNP=DUZ
"RTN","GMRCDIS",112,0)
 I GMRCORNP'=$P(^GMR(123,+GMRCO,0),U,14) D
"RTN","GMRCDIS",113,0)
 . Q:'$P(^GMR(123,+GMRCO,0),U,14)
"RTN","GMRCDIS",114,0)
 . N GMRCADUZ,GMRCORTX
"RTN","GMRCDIS",115,0)
 . S GMRCADUZ($P(^GMR(123,+GMRCO,0),U,14))=""
"RTN","GMRCDIS",116,0)
 . S GMRCORTX="Result removed from "_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCDIS",117,0)
 . D MSG^GMRCP(GMRCDFN,GMRCORTX,GMRCO,27,.GMRCADUZ,0)
"RTN","GMRCDIS",118,0)
 Q
"RTN","GMRCDIS",119,0)
 ;
"RTN","GMRCDIS",120,0)
STSCHG(GMRCIEN) ;completed before or go back
"RTN","GMRCDIS",121,0)
 I $O(^GMR(123,GMRCIEN,50,0)) Q 0 ;still at least one result
"RTN","GMRCDIS",122,0)
 I $O(^GMR(123,GMRCIEN,51,0)) Q 0 ;still at least one remote result
"RTN","GMRCDIS",123,0)
 N CHG,ACT,I S ACT=0,CHG=1,I=0
"RTN","GMRCDIS",124,0)
 F  S I=$O(^GMR(123,GMRCIEN,40,I)) Q:'I  D
"RTN","GMRCDIS",125,0)
 . S ACT(0)=^GMR(123,GMRCIEN,40,I,0),ACT(2)=$G(^(2))
"RTN","GMRCDIS",126,0)
 . I $P(ACT(0),U,2)=10,('$L($P(ACT(0),U,9))&('$L($P(ACT(2),U,4)))) D
"RTN","GMRCDIS",127,0)
 .. S CHG=0 ; admin completed before if no results
"RTN","GMRCDIS",128,0)
 . Q
"RTN","GMRCDIS",129,0)
 Q CHG
"RTN","GMRCDIS",130,0)
 ;
"RTN","GMRCDIS",131,0)
REFRESH(GMRCIEN) ;re-build list of associated results
"RTN","GMRCDIS",132,0)
 I $G(GMRCMEDR) D RESETIT^GMRCMED(GMRCMEDR)
"RTN","GMRCDIS",133,0)
 K ^TMP("GMRCR",$J,"DT"),GMRCMEDR
"RTN","GMRCDIS",134,0)
 D GETRES(GMRCIEN)
"RTN","GMRCDIS",135,0)
 I '$O(^TMP("GMRCR",$J,"DT",0)) D
"RTN","GMRCDIS",136,0)
 . S ^TMP("GMRCR",$J,"DT",1,0)="No further results to disassociate"
"RTN","GMRCDIS",137,0)
 S VALMCNT=$O(^TMP("GMRCR",$J,"DT",""),-1)
"RTN","GMRCDIS",138,0)
 S VALMBCK="R"
"RTN","GMRCDIS",139,0)
 Q
"RTN","GMRCDIS",140,0)
REMUSR(GMRCIEN,USER) ; check to see if user is authorized to remove results
"RTN","GMRCDIS",141,0)
 N GMRCSS,GMRCCLS,RES
"RTN","GMRCDIS",142,0)
 I '+$P($G(^GMR(123,GMRCIEN,0)),U,8) Q 0
"RTN","GMRCDIS",143,0)
 S GMRCSS=$P(^GMR(123,GMRCIEN,0),U,5) I 'GMRCSS Q 0  ;no service
"RTN","GMRCDIS",144,0)
 S GMRCCLS=$P($G(^GMR(123.5,GMRCSS,1)),U,6) I 'GMRCCLS Q 0  ;no class
"RTN","GMRCDIS",145,0)
 I '$O(^GMR(123,GMRCIEN,50,0)) Q "0^There are no results associated with this request." ;no results to remove
"RTN","GMRCDIS",146,0)
 S RES=""
"RTN","GMRCDIS",147,0)
 F  S RES=$O(^GMR(123,GMRCIEN,50,"B",RES)) Q:RES=""  Q:RES["MCAR"
"RTN","GMRCDIS",148,0)
 I RES="" Q "0^There are no Medicine results associated with this request." ;no med results
"RTN","GMRCDIS",149,0)
 I '$G(USER) S USER=DUZ
"RTN","GMRCDIS",150,0)
 I $$ISA^USRLM(USER,GMRCCLS) Q 1  ;part of USR CLASS in fld 1.06
"RTN","GMRCDIS",151,0)
 Q 0
"RTN","GMRCEDT1")
0^30^B37918500
"RTN","GMRCEDT1",1,0)
GMRCEDT1 ;SLC/DCM,JFR - EDIT A CONSULT AND RE-SEND AS NEW ;10/22/01 22:22
"RTN","GMRCEDT1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,22**;DEC 27, 1997
"RTN","GMRCEDT1",3,0)
 ;
"RTN","GMRCEDT1",4,0)
 ; This routine invokes IA #2638
"RTN","GMRCEDT1",5,0)
 ;
"RTN","GMRCEDT1",6,0)
EN(GMRCO) ;GMRCO=IEN of consult from file 123
"RTN","GMRCEDT1",7,0)
 ;GMRCSS=To Service   GMRCPROC=Procedure Request Type
"RTN","GMRCEDT1",8,0)
 ;GMRCURG=Urgency     GMRCPL=Place Of Consultation
"RTN","GMRCEDT1",9,0)
 ;GMRCATN=Attention   GMRCINO=Service is In/Out Patient
"RTN","GMRCEDT1",10,0)
 ;GMRCPNM=Patient Name  GMRCDIAG=Provisional Diagnosis
"RTN","GMRCEDT1",11,0)
 N GMRCSS,GMRCPROC,GMRCURG,GMRCPL,GMRCATN,GMRCINO,GMRCDIAG,LN
"RTN","GMRCEDT1",12,0)
 K ^TMP("GMRCR",$J,"ED") S GMRCLNO=1
"RTN","GMRCEDT1",13,0)
 I $L($P(^GMR(123,+GMRCO,0),"^",12)) S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  CURRENT STATUS: (Not Editable): "_$P(^ORD(100.01,$P(^(0),"^",12),0),"^",1),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",14,0)
 S GMRCD=0 F  S GMRCD=$O(^GMR(123,+GMRCO,40,"B",GMRCD)) Q:'GMRCD  S GMRCDD="" F  S GMRCDD=$O(^GMR(123,GMRCO,40,"B",GMRCD,GMRCDD)) Q:'GMRCDD  D
"RTN","GMRCEDT1",15,0)
 .I $P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",2)=19 S LN=0 D
"RTN","GMRCEDT1",16,0)
 ..N GMRCPERS,GMRCTX
"RTN","GMRCEDT1",17,0)
 ..I '$D(^GMR(123,+GMRCO,12)) D
"RTN","GMRCEDT1",18,0)
 ...S GMRCPERS=+$P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",5)
"RTN","GMRCEDT1",19,0)
 ...S GMRCPERS=$$GET1^DIQ(200,GMRCPERS,.01)
"RTN","GMRCEDT1",20,0)
 ..I $D(^GMR(123,+GMRCO,12)) D
"RTN","GMRCEDT1",21,0)
 ...S GMRCPERS=$P($G(^GMR(123,+GMRCO,40,GMRCDD,2)),U,2)
"RTN","GMRCEDT1",22,0)
 ..S GMRCTX="  CANCELLED BY (Not Editable): "_GMRCPERS
"RTN","GMRCEDT1",23,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=GMRCTX,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",24,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  CANCELLED COMMENT (Not Editable):",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",25,0)
 ..S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  I $L(^GMR(123,+GMRCO,40,GMRCDD,1,LN,0))>75 S FLG=1 D WPSET^GMRCUTIL("^GMR(123,+GMRCO,40,GMRCDD,1)","^TMP(""GMRCR"",$J,""ED"")","",.GMRCLNO,"",FLG)
"RTN","GMRCEDT1",26,0)
 ..I '$D(FLG) S LN=0 F  S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^(LN,0),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",27,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",$P(^(0),"-",79)=""
"RTN","GMRCEDT1",28,0)
 ..S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",29,0)
 ..Q
"RTN","GMRCEDT1",30,0)
 .Q
"RTN","GMRCEDT1",31,0)
 S GMRCSS=$S($D(GMRCEDT(1)):GMRCEDT(1),1:$P(^GMR(123,+GMRCO,0),"^",5)_U_$P(^GMR(123.5,$P(^GMR(123,+GMRCO,0),"^",5),0),U))
"RTN","GMRCEDT1",32,0)
 S GMRCPROC=$S($D(GMRCED(1)):GMRCED(1),1:$P(^GMR(123,+GMRCO,0),"^",8)_U_$$GET1^DIQ(123.3,+$P(^GMR(123,+GMRCO,0),"^",8),.01))
"RTN","GMRCEDT1",33,0)
 S GMRCURG=$S($D(GMRCED(3)):GMRCED(3),1:$P(^GMR(123,+GMRCO,0),"^",9)_U_$$GET1^DIQ(101,+$P(^(0),"^",9),1))
"RTN","GMRCEDT1",34,0)
 S GMRCPL=$S($D(GMRCED(4)):GMRCED(4),1:$P(^GMR(123,+GMRCO,0),"^",10)_U_$$GET1^DIQ(101,+$P(^(0),U,10),1))
"RTN","GMRCEDT1",35,0)
 S GMRCATN=$S($D(GMRCED(5)):GMRCED(5),1:$P(^GMR(123,+GMRCO,0),"^",11)_U_$$GET1^DIQ(200,+$P(^(0),U,11),.01))
"RTN","GMRCEDT1",36,0)
 I '$D(^GMR(123,GMRCO,30.1)) D
"RTN","GMRCEDT1",37,0)
 . I $D(GMRCED(6)),$L($P(GMRCED(6),U,2)) D  Q
"RTN","GMRCEDT1",38,0)
 .. S GMRCDIAG=$P(GMRCED(6),U)_" ("_$P(GMRCED(6),U,2)_")"
"RTN","GMRCEDT1",39,0)
 . S GMRCDIAG=$S($D(GMRCED(6)):GMRCED(6),1:$G(^GMR(123,+GMRCO,30)))
"RTN","GMRCEDT1",40,0)
 I $D(^GMR(123,GMRCO,30.1)) D
"RTN","GMRCEDT1",41,0)
 . I $D(GMRCED(6)),$L(GMRCED(6)) D  Q
"RTN","GMRCEDT1",42,0)
 .. S GMRCDIAG=$P(GMRCED(6),U)_" ("_$P(GMRCED(6),U,2)_")"
"RTN","GMRCEDT1",43,0)
 . S GMRCDIAG=$G(^GMR(123,+GMRCO,30))
"RTN","GMRCEDT1",44,0)
 I $D(GMRCED(2)) S GMRCINO=GMRCED(2)
"RTN","GMRCEDT1",45,0)
 I '$D(GMRCINO) S GMRCINO=$P(^GMR(123,+GMRCO,0),U,18)_U_$S($P(^(0),U,18)="I":"Inpatient",1:"Outpatient")
"RTN","GMRCEDT1",46,0)
 S GMRCREQ=$S(+$P(^GMR(123,+GMRCO,0),U,17)="P":"Procedure",1:"Consult")
"RTN","GMRCEDT1",47,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="SENDING PROVIDER (Not Editable): "_$$GET1^DIQ(200,+$P(^GMR(123,+GMRCO,0),"^",14),.01),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",48,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="REQUEST TYPE (Not Editable): "_GMRCREQ,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",49,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=$$REPEAT^XLFSTR("-",79),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",50,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  TO SERVICE (Not Editable): "_$P(GMRCSS,U,2) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",51,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=" ",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",52,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="1 PROCEDURE: "_$P(GMRCPROC,U,2)
"RTN","GMRCEDT1",53,0)
 D:+GMRCPROC RVRS(GMRCLNO,$D(GMRCED(1))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",54,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="2 Performed as INPT OR OUTPT: "_$P(GMRCINO,U,2) D RVRS(GMRCLNO,$D(GMRCED(2))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",55,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="3 URGENCY: "_$P(GMRCURG,U,2) D RVRS(GMRCLNO,$D(GMRCED(3))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",56,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="4 PLACE OF CONSULTATION: "_$P(GMRCPL,U,2) D RVRS(GMRCLNO,$D(GMRCED(4))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",57,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="5 ATTENTION (CONSULTANT): "_$P(GMRCATN,U,2) D RVRS(GMRCLNO,$D(GMRCED(5))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",58,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="6 PROVISIONAL DIAGNOSIS: "_GMRCDIAG D RVRS(GMRCLNO,$D(GMRCED(6))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",59,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="7 REASON FOR REQUEST:" D RVRS(GMRCLNO,$D(^TMP("GMRCED",$J,20))) S GMRCLNO=GMRCLNO+1 D
"RTN","GMRCEDT1",60,0)
 . I $D(^TMP("GMRCED",$J,20)) D  Q
"RTN","GMRCEDT1",61,0)
 .. N ND S ND=0
"RTN","GMRCEDT1",62,0)
 .. F  S ND=$O(^TMP("GMRCED",$J,20,ND)) Q:'ND  D
"RTN","GMRCEDT1",63,0)
 ... D KILL^VALM10(GMRCLNO)
"RTN","GMRCEDT1",64,0)
 ... S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCED",$J,20,ND,0)
"RTN","GMRCEDT1",65,0)
 ... S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",66,0)
 . N ND S ND=0
"RTN","GMRCEDT1",67,0)
 . F  S ND=$O(^GMR(123,+GMRCO,20,ND)) Q:ND=""  D
"RTN","GMRCEDT1",68,0)
 .. S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^GMR(123,+GMRCO,20,ND,0)
"RTN","GMRCEDT1",69,0)
 .. S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",70,0)
 .Q
"RTN","GMRCEDT1",71,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",GMRCLNO=GMRCLNO+1,^TMP("GMRCR",$J,"ED",GMRCLNO,0)="8 COMMENT(S): (Add Only)" D RVRS(GMRCLNO) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",72,0)
 I $D(^TMP("GMRCED",$J,40)) D
"RTN","GMRCEDT1",73,0)
 . D KILL^VALM10(GMRCLNO)
"RTN","GMRCEDT1",74,0)
 . S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  New Comment:",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",75,0)
 . N ND S ND=0 F  S ND=$O(^TMP("GMRCED",$J,40,ND)) Q:'ND  D
"RTN","GMRCEDT1",76,0)
 .. S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCED",$J,40,ND,0)
"RTN","GMRCEDT1",77,0)
 .. S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",78,0)
 N GMRCEDCT
"RTN","GMRCEDT1",79,0)
 S GMRCD=0,GMRCEDCT=0 F  S GMRCD=$O(^GMR(123,+GMRCO,40,"B",GMRCD)) Q:'GMRCD  S GMRCDD="",GMRCDD=$O(^GMR(123,+GMRCO,40,"B",GMRCD,GMRCDD)) Q:'GMRCDD  D
"RTN","GMRCEDT1",80,0)
 .I $P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",2)=20 S LN=0,GMRCEDCT=GMRCEDCT+1,GMRCEDCM(GMRCEDCT)=GMRCDD D
"RTN","GMRCEDT1",81,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",GMRCLNO=GMRCLNO+1,^TMP("GMRCR",$J,"ED",GMRCLNO,0)="ADDED COMMENT (Not Editable) Entered: "_$P($$FMTE^XLFDT($P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",1)),"@",1)
"RTN","GMRCEDT1",82,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCR",$J,"ED",GMRCLNO,0)_" BY: "_$S($L($P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",4)):$P(^VA(200,$P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",4),0),"^",1),1:"UNKNOWN"),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",83,0)
 ..S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  I $L(^GMR(123,+GMRCO,40,GMRCDD,1,LN,0))>75 S FLG=1 D WPSET^GMRCUTIL("^GMR(123,+GMRCO,40,GMRCDD,1)","^TMP(""GMRCR"",$J,""ED"")","",.GMRCLNO,"",FLG) Q
"RTN","GMRCEDT1",84,0)
 ..S LN=0 F  S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^(LN,0),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",85,0)
 ..Q
"RTN","GMRCEDT1",86,0)
 .Q
"RTN","GMRCEDT1",87,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=""
"RTN","GMRCEDT1",88,0)
 K FLG
"RTN","GMRCEDT1",89,0)
 Q
"RTN","GMRCEDT1",90,0)
RVRS(LINE,EDITED) ;reverse video for fields that can be edited
"RTN","GMRCEDT1",91,0)
 I '$G(EDITED) D CNTRL^VALM10(LINE,1,1,IORVON,IORVOFF) Q
"RTN","GMRCEDT1",92,0)
 D CNTRL^VALM10(LINE,1,1,IORVON_IOINHI,IORVOFF_IOINORM)
"RTN","GMRCEDT1",93,0)
 Q
"RTN","GMRCEDT2")
0^31^B15605173
"RTN","GMRCEDT2",1,0)
GMRCEDT2 ;SLC/JFR,DCM - RESUBMIT A CANCELLED CONSULT ;1/4/99 00:27
"RTN","GMRCEDT2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,22**;DEC 27, 1997
"RTN","GMRCEDT2",3,0)
EN(GMRCO,COMNO) ;entry point into the routine
"RTN","GMRCEDT2",4,0)
 ;COMNO=CMDA from ^GMRCEDT2=comments array IEN from ^GMR(123,IEN,40,
"RTN","GMRCEDT2",5,0)
 ;GMRCO=IEN of the consult from file 123
"RTN","GMRCEDT2",6,0)
 I $S($P(^GMR(123,GMRCO,0),"^",12)'=13:1,$D(GMRCRSUB):1,1:0) D  Q
"RTN","GMRCEDT2",7,0)
 .S GMRCMSG="***     Consult Has Already Been Resubmitted   ***"
"RTN","GMRCEDT2",8,0)
 .S GMRCMSG(1)="***  No Further Action Is Required Or Allowed ***"
"RTN","GMRCEDT2",9,0)
 .D EXAC^GMRCADC(.GMRCMSG)
"RTN","GMRCEDT2",10,0)
 .S:'$D(GMRCRSUB) GMRCRSUB=1
"RTN","GMRCEDT2",11,0)
 .Q
"RTN","GMRCEDT2",12,0)
 N MSG S MSG=$$EDRESOK(GMRCO)
"RTN","GMRCEDT2",13,0)
 I '+MSG D EXAC^GMRCADC($P(MSG,U,2)) Q
"RTN","GMRCEDT2",14,0)
 I '$D(GMRCGUIF) W !,"Resubmitting Consult ... One moment please ..."
"RTN","GMRCEDT2",15,0)
 K ^TMP("GMRCSUB",$J) S ^TMP("GMRCSUB",$J)=0
"RTN","GMRCEDT2",16,0)
 I $D(GMRCEDT(1)) S ^TMP("GMRCSUB",$J,1)="GMRCSS^"_+GMRCEDT(1)
"RTN","GMRCEDT2",17,0)
 I $D(GMRCED(1)) D
"RTN","GMRCEDT2",18,0)
 . I $P(GMRCED(1),U)=$P(^GMR(123,+GMRCO,0),U,8) K GMRCED(1) Q
"RTN","GMRCEDT2",19,0)
 . S ^TMP("GMRCSUB",$J,2)="GMRCPROC^"_+GMRCED(1)_";GMR(123.3,"
"RTN","GMRCEDT2",20,0)
 I $D(GMRCED(2)) D
"RTN","GMRCEDT2",21,0)
 . I $P(GMRCED(2),U)=$P(^GMR(123,+GMRCO,0),U,18) K GMRCED(2) Q
"RTN","GMRCEDT2",22,0)
 . S ^TMP("GMRCSUB",$J,3)="GMRCION^"_$P(GMRCED(2),U)
"RTN","GMRCEDT2",23,0)
 I $D(GMRCED(3)) D
"RTN","GMRCEDT2",24,0)
 . I $P(GMRCED(3),U)=$P(^GMR(123,+GMRCO,0),U,9) K GMRCED(3) Q
"RTN","GMRCEDT2",25,0)
 . S ^TMP("GMRCSUB",$J,4)="GMRCURG^"_$P(GMRCED(3),U)
"RTN","GMRCEDT2",26,0)
 I $D(GMRCED(4)) D
"RTN","GMRCEDT2",27,0)
 . I $P(GMRCED(4),U)=$P(^GMR(123,+GMRCO,0),U,10) K GMRCED(4) Q
"RTN","GMRCEDT2",28,0)
 . S ^TMP("GMRCSUB",$J,5)="GMRCPL^"_$P(GMRCED(4),U)
"RTN","GMRCEDT2",29,0)
 I $D(GMRCED(5)) D
"RTN","GMRCEDT2",30,0)
 . I $P(GMRCED(5),U)=$P(^GMR(123,+GMRCO,0),U,11) K GMRCED(5) Q
"RTN","GMRCEDT2",31,0)
 . I '$L($P(GMRCED(5),U)) S $P(GMRCED(5),U)="@"
"RTN","GMRCEDT2",32,0)
 . S ^TMP("GMRCSUB",$J,6)="GMRCATN^"_$P(GMRCED(5),U)
"RTN","GMRCEDT2",33,0)
 I $D(GMRCED(6)) D
"RTN","GMRCEDT2",34,0)
 . I GMRCED(6)=$G(^GMR(123,+GMRCO,30)) K GMRCED(6) Q
"RTN","GMRCEDT2",35,0)
 . I $P(GMRCED(6),U)_" ("_$P(GMRCED(6),U,2)_")"=$G(^GMR(123,GMRCO,30)) K GMRCED(6) Q
"RTN","GMRCEDT2",36,0)
 . I '$L($P(GMRCED(6),U)) S $P(GMRCED(6),U,1,2)="@"
"RTN","GMRCEDT2",37,0)
 . I $L($P(GMRCED(6),U,2)),$P(GMRCED(6),U,2)'="@" D
"RTN","GMRCEDT2",38,0)
 .. S $P(GMRCED(6),U)=$P(GMRCED(6),U)_" ("_$P(GMRCED(6),U,2)_")"
"RTN","GMRCEDT2",39,0)
 . S ^TMP("GMRCSUB",$J,7)="GMRCDIAG^"_GMRCED(6)
"RTN","GMRCEDT2",40,0)
 I $D(^TMP("GMRCED",$J,20)) S ^TMP("GMRCSUB",$J,20)="GMRCRFQ^" D
"RTN","GMRCEDT2",41,0)
 . N ND S ND=0
"RTN","GMRCEDT2",42,0)
 . F  S ND=$O(^TMP("GMRCED",$J,20,ND)) Q:'ND  D
"RTN","GMRCEDT2",43,0)
 .. S ^TMP("GMRCSUB",$J,20,ND)=^TMP("GMRCED",$J,20,ND,0)
"RTN","GMRCEDT2",44,0)
 I $D(^TMP("GMRCED",$J,40)) S ^TMP("GMRCSUB",$J,40)="COMMENT^" D
"RTN","GMRCEDT2",45,0)
 . N ND S ND=0
"RTN","GMRCEDT2",46,0)
 . F  S ND=$O(^TMP("GMRCED",$J,40,ND)) Q:'ND  D
"RTN","GMRCEDT2",47,0)
 .. S ^TMP("GMRCSUB",$J,40,ND)=^TMP("GMRCED",$J,40,ND,0)
"RTN","GMRCEDT2",48,0)
 D FILE^GMRCGUIC(+GMRCO,$NAME(^TMP("GMRCSUB",$J)),1)
"RTN","GMRCEDT2",49,0)
 N GMRCADUZ S GMRCADUZ=""
"RTN","GMRCEDT2",50,0)
 S DFN=$P(^GMR(123,+GMRCO,0),"^",2),GMRCPROV=$P(^(0),"^",14)
"RTN","GMRCEDT2",51,0)
 S GMRCTYPE=$P(^GMR(123,+GMRCO,0),U,17),GMRCTRLC="XX",VISIT="",RMBED=""
"RTN","GMRCEDT2",52,0)
 S DIE="^GMR(123,",DA=+GMRCO,DR="8////^S X=5;9////^S X=11" D ^DIE
"RTN","GMRCEDT2",53,0)
 K DIE,DA,DR
"RTN","GMRCEDT2",54,0)
 S GMRCRSUB=1
"RTN","GMRCEDT2",55,0)
 S GMRCURG=$P(^GMR(123,+GMRCO,0),"^",9)
"RTN","GMRCEDT2",56,0)
 I +$P(^GMR(123,+GMRCO,0),"^",11) S GMRCADUZ($P(^(0),"^",11))=""
"RTN","GMRCEDT2",57,0)
 S GMRCSVC=$P(^GMR(123,+GMRCO,0),"^",5)
"RTN","GMRCEDT2",58,0)
 I +GMRCSVC D
"RTN","GMRCEDT2",59,0)
 . D EN^GMRCT(GMRCSVC)
"RTN","GMRCEDT2",60,0)
 S GMRCORTX="Resubmitted consult "_$$ORTX^GMRCAU(+GMRCO)_$S(+GMRCURG:" ("_$P(^ORD(101,+GMRCURG,0),"^",2)_")",1:"")
"RTN","GMRCEDT2",61,0)
 K GMRCFL,GMRCPROV,GMRCTYPE,GMRCTRLC,VISIT,RMBED,GMRCOM,GMRCURG
"RTN","GMRCEDT2",62,0)
 K GMRCSVC,GMRCORTX
"RTN","GMRCEDT2",63,0)
 Q
"RTN","GMRCEDT2",64,0)
EDRESOK(GMRCDA) ;check cslt or proc to see if still resubmittable
"RTN","GMRCEDT2",65,0)
 ; if procedure is inactive or no services, not resubmittable
"RTN","GMRCEDT2",66,0)
 ; if service is grouper or disabled, not resubmittable
"RTN","GMRCEDT2",67,0)
 N MSG,GMRC
"RTN","GMRCEDT2",68,0)
 Q:'$D(^GMR(123,+$G(GMRCDA),0)) "0^Invalid Consult Number"
"RTN","GMRCEDT2",69,0)
 I $P($G(^GMR(123,+GMRCDA,12)),U,5)="F" D  Q MSG
"RTN","GMRCEDT2",70,0)
 . S MSG="0^This inter-facility cconsult may only be resubmitted by the"
"RTN","GMRCEDT2",71,0)
 . S MSG=MSG_" ordering facility."
"RTN","GMRCEDT2",72,0)
 S GMRC(0)=^GMR(123,+GMRCDA,0)
"RTN","GMRCEDT2",73,0)
 I '$P(GMRC(0),U,8) D  Q MSG
"RTN","GMRCEDT2",74,0)
 . I "19"[+$P(^GMR(123.5,+$P(GMRC(0),U,5),0),U,2) D  Q
"RTN","GMRCEDT2",75,0)
 .. S MSG="0^The service for this Consult is no longer orderable."
"RTN","GMRCEDT2",76,0)
 . S MSG=1
"RTN","GMRCEDT2",77,0)
 S MSG=1
"RTN","GMRCEDT2",78,0)
 I "19"[+$P(^GMR(123.5,+$P(GMRC(0),U,5),0),U,2) S MSG=0
"RTN","GMRCEDT2",79,0)
 I '$L($$GET1^DIQ(123.3,+$P(GMRC(0),U,8),.01)) S MSG=0
"RTN","GMRCEDT2",80,0)
 I +$$GET1^DIQ(123.3,+$P(GMRC(0),U,8),.02) S MSG=0
"RTN","GMRCEDT2",81,0)
 I '$D(^GMR(123.3,+$P(GMRC(0),U,8),2,"B",+$P(GMRC(0),U,5))) S MSG=0
"RTN","GMRCEDT2",82,0)
 I MSG=0 D
"RTN","GMRCEDT2",83,0)
 . S MSG=MSG_"^This procedure may no longer be ordered or the service "
"RTN","GMRCEDT2",84,0)
 . S MSG=MSG_"may no longer perform it."
"RTN","GMRCEDT2",85,0)
 Q MSG
"RTN","GMRCEDT3")
0^32^B15652021
"RTN","GMRCEDT3",1,0)
GMRCEDT3 ;SLC/DCM,JFR - file edit/resubmit ;1/16/02 19:28
"RTN","GMRCEDT3",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,15,22**;DEC 27, 1997
"RTN","GMRCEDT3",3,0)
EN(GMRCDA) ;File tracking Data from array
"RTN","GMRCEDT3",4,0)
 W:'$D(GMRCGUIF) !,"Filing Tracking Data..."
"RTN","GMRCEDT3",5,0)
 N GMRCOUNT,GMRC40DA
"RTN","GMRCEDT3",6,0)
 S GMRCDT=$$NOW^XLFDT
"RTN","GMRCEDT3",7,0)
 S DIE="^GMR(123,",DA=GMRCDA,DR="8////^S X=5" D ^DIE K DIE,DA,DR
"RTN","GMRCEDT3",8,0)
 I '$D(^GMR(123,GMRCDA,40,0)) S ^GMR(123,GMRCDA,40,0)="123.02^^"
"RTN","GMRCEDT3",9,0)
 S DA=$S(+$P(^GMR(123,GMRCDA,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCEDT3",10,0)
 S GMRC40DA=DA
"RTN","GMRCEDT3",11,0)
 S $P(^GMR(123,GMRCDA,40,0),"^",3,4)=DA_"^"_DA D
"RTN","GMRCEDT3",12,0)
 .S ^GMR(123,GMRCDA,40,DA,0)=GMRCDT_"^"_$O(^GMR(123.1,"B","EDIT/RESUBMITTED",0))_"^"_GMRCDT_"^"_DUZ_"^"_DUZ D
"RTN","GMRCEDT3",13,0)
 .S ^GMR(123,GMRCDA,40,DA,1,0)="^^^^"_GMRCDT_"^" D
"RTN","GMRCEDT3",14,0)
 ..S GMRCOUNT=1,GMRCND=0,^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=$$REPEAT^XLFSTR("-",21)_" PREVIOUS VALUES OF EDITED FIELDS  "_$$REPEAT^XLFSTR("-",21),GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",15,0)
 ..I '$D(GMRCFLD) S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="No Fields Were Edited Before Resubmission",GMRCOUNT=GMRCOUNT+1 Q
"RTN","GMRCEDT3",16,0)
 ..F  S GMRCND=$O(GMRCFLD(GMRCND)) Q:GMRCND=""  D  S GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",17,0)
 ...I GMRCND=.1 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="DISPLAY TEXT OF ITEM ORDERED: "_$P(GMRCFLD(GMRCND),"^",1),GMRCOUNT=GMRCOUNT+1 Q
"RTN","GMRCEDT3",18,0)
 ...I GMRCND=1 D  S GMRCOUNT=GMRCOUNT+1 Q
"RTN","GMRCEDT3",19,0)
 ....S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="To Service: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value")
"RTN","GMRCEDT3",20,0)
 ....Q
"RTN","GMRCEDT3",21,0)
 ...I GMRCND=4 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Procedure: "_$$GET1^DIQ(123.3,+GMRCFLD(4),.01) Q
"RTN","GMRCEDT3",22,0)
 ...I GMRCND=14 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Performed as Inpt or Outpt: "_$S($L($P(GMRCFLD(GMRCND),"^")):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q
"RTN","GMRCEDT3",23,0)
 ...I $S(GMRCND=5:1,GMRCND=6:1,GMRCND=13:1,1:0) D  Q
"RTN","GMRCEDT3",24,0)
 ....N CAPTION S CAPTION=$S(GMRCND=5:"Urgency: ",GMRCND=6:"Place of Consultation: ",1:"Type of Request: ")
"RTN","GMRCEDT3",25,0)
 ....S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=CAPTION_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value")
"RTN","GMRCEDT3",26,0)
 ...I GMRCND=7 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Attention: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q
"RTN","GMRCEDT3",27,0)
 ...I GMRCND=20 N GMRCND1 S GMRCND1=0,GMRCOUNT=GMRCOUNT+1 D  Q
"RTN","GMRCEDT3",28,0)
 ....S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Reason for Request: "
"RTN","GMRCEDT3",29,0)
 ....S GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",30,0)
 ....F  S GMRCND1=$O(@GMRCFLD(20)@(GMRCND1)) Q:GMRCND1=""  S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=@GMRCFLD(20)@(GMRCND1,0),GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",31,0)
 ...I GMRCND=30 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Provisional Diagnosis: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q 
"RTN","GMRCEDT3",32,0)
 ...I GMRCND=40 S ^GMR(123,+GMRCDA,40,DA,1,GMRCOUNT,0)=$P(GMRCFLD(GMRCND),"^",1) Q
"RTN","GMRCEDT3",33,0)
 ...Q
"RTN","GMRCEDT3",34,0)
 ..Q
"RTN","GMRCEDT3",35,0)
 .S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=$$REPEAT^XLFSTR("-",75),GMRCOUNT=GMRCOUNT-1,^GMR(123,+GMRCDA,40,"B",GMRCDT,DA)=""
"RTN","GMRCEDT3",36,0)
 .S $P(^GMR(123,GMRCDA,40,DA,1,0),"^",3)=GMRCOUNT-1,$P(^(0),"^",4)=GMRCOUNT-1,^GMR(123,+GMRCDA,40,"B",GMRCDT,DA)=""
"RTN","GMRCEDT3",37,0)
 .Q
"RTN","GMRCEDT3",38,0)
 K GMRCIND,GMRCND
"RTN","GMRCEDT3",39,0)
 Q GMRC40DA
"RTN","GMRCEDT3",40,0)
 ;
"RTN","GMRCEDT3",41,0)
ADDCM(GMRCO) ;set up to add comment when none exists or to add a new comment
"RTN","GMRCEDT3",42,0)
 ;returns DA for the entry it sets up
"RTN","GMRCEDT3",43,0)
 N X
"RTN","GMRCEDT3",44,0)
 S:'$D(^GMR(123,+GMRCO,40,0)) ^(0)="^123.02DA^^" S X=$S($P(^GMR(123,GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCEDT3",45,0)
 S $P(^GMR(123,GMRCO,40,0),"^",3,4)=X_"^"_X
"RTN","GMRCEDT3",46,0)
 Q X
"RTN","GMRCEDT3",47,0)
 ;
"RTN","GMRCEDT3",48,0)
AUDIT0(DA,GMRCDA) ;Add the necessary tracking information to word processing fields
"RTN","GMRCEDT3",49,0)
 N DIE,DR
"RTN","GMRCEDT3",50,0)
 S DIE="^GMR(123,"_GMRCDA_",40,",DA(1)=GMRCDA,DR=".01////^S X=$$NOW^XLFDT;1////^S X=GMRCA;2////^S X=$$NOW^XLFDT;3////^S X=DUZ;4////^S X=DUZ"
"RTN","GMRCEDT3",51,0)
 D ^DIE
"RTN","GMRCEDT3",52,0)
 Q
"RTN","GMRCEDT4")
0^33^B72310406
"RTN","GMRCEDT4",1,0)
GMRCEDT4 ;SLC/DCM,JFR - UTILITIES FOR EDITING FIELDS ;10/24/01 10:42
"RTN","GMRCEDT4",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,22**;DEC 27, 1997
"RTN","GMRCEDT4",3,0)
 Q
"RTN","GMRCEDT4",4,0)
EDITFLD(GMRCO)    ;edit field in file 123.
"RTN","GMRCEDT4",5,0)
 ;GMRCO=IEN of consult record in file 123
"RTN","GMRCEDT4",6,0)
 N DIR,X,Y,GMRCSS,GMRCPROC,GMRCPROC,GMRCURG,GMRCPL,GMRCREND,GMRCY,GMRCX
"RTN","GMRCEDT4",7,0)
 N GMRCMSG,GMRCTAG
"RTN","GMRCEDT4",8,0)
 I $S($P(^GMR(123,GMRCO,0),"^",12)'=13:1,$D(GMRCRSUB):1,1:0) D  Q
"RTN","GMRCEDT4",9,0)
 .S GMRCMSG="This consult is no longer editable." D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCEDT4",10,0)
 S GMRCMSG=$$EDRESOK^GMRCEDT2(GMRCO)
"RTN","GMRCEDT4",11,0)
 I '+GMRCMSG D EXAC^GMRCADC($P(GMRCMSG,U,2)) Q
"RTN","GMRCEDT4",12,0)
 S DIR(0)="LAO^1:8",DIR("A")="Select the fields to edit: "
"RTN","GMRCEDT4",13,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCEDT4",14,0)
 I $P(Y,",")<1 Q
"RTN","GMRCEDT4",15,0)
 S GMRCY=Y
"RTN","GMRCEDT4",16,0)
 F GMRCX=1:1:8 S GMRCTAG=$P(GMRCY,",",GMRCX) Q:'GMRCTAG  D
"RTN","GMRCEDT4",17,0)
 . D SETUP
"RTN","GMRCEDT4",18,0)
 . D @GMRCTAG
"RTN","GMRCEDT4",19,0)
 . K DIROUT,DIRUT,DTOUT,DUOUT
"RTN","GMRCEDT4",20,0)
 . D EN^GMRCEDT1(+GMRCO),INIT^GMRCEDIT
"RTN","GMRCEDT4",21,0)
 Q
"RTN","GMRCEDT4",22,0)
SETUP   ;get info needed for edit (save global reads)
"RTN","GMRCEDT4",23,0)
 S:$D(GMRCEDT(1)) GMRCSS=GMRCEDT(1)
"RTN","GMRCEDT4",24,0)
 I '$D(GMRCSS) S GMRCSS=$P(^GMR(123,+GMRCO,0),U,5),GMRCSS=GMRCSS_U_$P(^GMR(123.5,GMRCSS,0),U)
"RTN","GMRCEDT4",25,0)
 S:$D(GMRCED(1)) GMRCPROC=GMRCED(1)
"RTN","GMRCEDT4",26,0)
 I '$D(GMRCPROC) S GMRCPROC=+$P(^GMR(123,+GMRCO,0),U,8),GMRCPROC=GMRCPROC_U_$$GET1^DIQ(123.3,+GMRCPROC,.01)
"RTN","GMRCEDT4",27,0)
 S:$D(GMRCED(2)) GMRCREND=GMRCED(2)
"RTN","GMRCEDT4",28,0)
 I '$D(GMRCREND) S GMRCREND=$P(^GMR(123,GMRCO,0),U,18),GMRCREND=GMRCREND_U_$S(GMRCREND="I":"In",1:"Out")_"patient"
"RTN","GMRCEDT4",29,0)
 S:$D(GMRCED(3)) GMRCURG=GMRCED(3)
"RTN","GMRCEDT4",30,0)
 I '$D(GMRCURG) S GMRCURG=$P(^GMR(123,+GMRCO,0),U,9),GMRCURG=GMRCURG_U_$$GET1^DIQ(101,+GMRCURG,1)
"RTN","GMRCEDT4",31,0)
 S:$D(GMRCED(4)) GMRCPL=GMRCED(4)
"RTN","GMRCEDT4",32,0)
 I '$D(GMRCPL) S GMRCPL=$P(^GMR(123,+GMRCO,0),U,10),GMRCPL=GMRCPL_U_$$GET1^DIQ(101,+GMRCPL,1)
"RTN","GMRCEDT4",33,0)
 Q
"RTN","GMRCEDT4",34,0)
01       ;edit TO SERVICE
"RTN","GMRCEDT4",35,0)
 N I,PROCSERV,DIR,X,Y
"RTN","GMRCEDT4",36,0)
 I $G(GMRCPROC) D  Q:'PROCSERV
"RTN","GMRCEDT4",37,0)
 . N I S I=0,PROCSERV=0 F  S I=$O(^GMR(123.3,+GMRCPROC,2,"B",I)) Q:'I  D
"RTN","GMRCEDT4",38,0)
 .. S PROCSERV(I)="",PROCSERV=PROCSERV+1
"RTN","GMRCEDT4",39,0)
 . I PROCSERV=1 W !,"Only one SERVICE can perform this procedure.",!
"RTN","GMRCEDT4",40,0)
 S DIR(0)="PA^123.5:EMQ"
"RTN","GMRCEDT4",41,0)
 I $G(PROCSERV) D
"RTN","GMRCEDT4",42,0)
 . I $D(PROCSERV(+GMRCSS)) Q
"RTN","GMRCEDT4",43,0)
 . S DIR("B")=$$GET1^DIQ(123.5,$O(PROCSERV(0)),.01)
"RTN","GMRCEDT4",44,0)
 I '$D(DIR("B")) S DIR("B")=$P(GMRCSS,U,2)
"RTN","GMRCEDT4",45,0)
 S DIR("A")="Select the Service to perform this request: "
"RTN","GMRCEDT4",46,0)
 S DIR("S")="I $P(^(0),U,2)<1"
"RTN","GMRCEDT4",47,0)
 I +$G(GMRCPROC) S DIR("S")=DIR("S")_",$D(PROCSERV(+Y))"
"RTN","GMRCEDT4",48,0)
 S DIR("??")="^D LISTALL^GMRCASV"
"RTN","GMRCEDT4",49,0)
 D ^DIR I $D(DUOUT)!($D(DTOUT)) Q
"RTN","GMRCEDT4",50,0)
 I Y<1!(+Y=+GMRCSS) W !,$$NOCHG,! Q
"RTN","GMRCEDT4",51,0)
 S GMRCEDT(1)=Y,GMRCSS=Y
"RTN","GMRCEDT4",52,0)
 Q
"RTN","GMRCEDT4",53,0)
1 ;edit Procedure
"RTN","GMRCEDT4",54,0)
 W !,$C(7),"The procedure associated with a request may not be changed."
"RTN","GMRCEDT4",55,0)
 W !,"Place a new request if a different procedure is desired"
"RTN","GMRCEDT4",56,0)
 H 2 Q
"RTN","GMRCEDT4",57,0)
 I +$P(^GMR(123,+GMRCO,0),U,17)'="P" D  Q
"RTN","GMRCEDT4",58,0)
 . W !,"Procedures may only be selected for Procedure requests.",!
"RTN","GMRCEDT4",59,0)
 . H 2
"RTN","GMRCEDT4",60,0)
 N DIC,PROCED,X,Y,D
"RTN","GMRCEDT4",61,0)
 S DIC=101.43,DIC(0)="AEQZ",D="S.PROC",DIC("B")=$P(GMRCPROC,U,2)
"RTN","GMRCEDT4",62,0)
 S DIC("A")="Select Procedure: "
"RTN","GMRCEDT4",63,0)
 S DIC("S")="I $D(^GMR(123.3,+$P(^(0),U,2),2,""B"",+GMRCSS))"
"RTN","GMRCEDT4",64,0)
 D IX^DIC
"RTN","GMRCEDT4",65,0)
 I $D(DUOUT)!($D(DTOUT)) Q
"RTN","GMRCEDT4",66,0)
 I Y<1!(+$P(Y(0),U,3)=$P(GMRCPROC,U,2)) W !,$$NOCHG,! Q
"RTN","GMRCEDT4",67,0)
 S PROCED=+$P(Y(0),U,2)_U_$$UP^XLFSTR($P(Y(0),U))
"RTN","GMRCEDT4",68,0)
 I '$D(^GMR(123.5,"APR",+PROCED,+GMRCSS)) D
"RTN","GMRCEDT4",69,0)
 . ;never executed; service non-editable
"RTN","GMRCEDT4",70,0)
 . N GMRCEDD1,GMRCSSV,GMRCPROC
"RTN","GMRCEDT4",71,0)
 . W !,"The service is no longer appropriate for this procedure.",!
"RTN","GMRCEDT4",72,0)
 . S GMRCSSV=GMRCSS,GMRCPROC=PROCED
"RTN","GMRCEDT4",73,0)
 . S:$D(GMRCEDT(1)) GMRCEDD1=GMRCEDT(1)
"RTN","GMRCEDT4",74,0)
 . D 01
"RTN","GMRCEDT4",75,0)
 . I '$D(^GMR(123.3,+PROCED,2,"B",+GMRCSS)) D
"RTN","GMRCEDT4",76,0)
 .. W !,$C(7),"Unable to change procedure.",!
"RTN","GMRCEDT4",77,0)
 .. K PROCED,GMRCEDT(1) S GMRCSS=GMRCSSV
"RTN","GMRCEDT4",78,0)
 .. I $D(GMRCEDD1) S GMRCEDT(1)=GMRCEDD1
"RTN","GMRCEDT4",79,0)
 I $D(PROCED) S (GMRCPROC,GMRCED(1))=PROCED
"RTN","GMRCEDT4",80,0)
 Q
"RTN","GMRCEDT4",81,0)
2       ;edit service rendered
"RTN","GMRCEDT4",82,0)
 N DIR,X,Y,GMRCURSV,GMRCPLSV,GMRCED4,GMRCED5,RENDED
"RTN","GMRCEDT4",83,0)
 S DIR(0)="S:A^I:Inpatient;O:Outpatient",DIR("B")=$P(GMRCREND,U,2)
"RTN","GMRCEDT4",84,0)
 S DIR("A")="Service to be performed Inpatient or Outpatient: "
"RTN","GMRCEDT4",85,0)
 D ^DIR I $D(DUOUT)!($D(DTOUT)) W !,$$NOCHG,! Q
"RTN","GMRCEDT4",86,0)
 I Y'=$P(GMRCREND,U) S RENDED=Y_U_Y(0)
"RTN","GMRCEDT4",87,0)
 I '$D(RENDED) Q
"RTN","GMRCEDT4",88,0)
 I '$$VALIDUR(GMRCURG,RENDED,+$G(GMRCPROC)) D  I '$D(RENDED) Q
"RTN","GMRCEDT4",89,0)
 . N GMRCREND,CHGIO S GMRCREND=RENDED
"RTN","GMRCEDT4",90,0)
 . W $C(7),!!,"The urgency of this request is no longer valid.",!
"RTN","GMRCEDT4",91,0)
 . S GMRCURSV=GMRCURG S:$D(GMRCED(3)) GMRCED3=GMRCED(3)
"RTN","GMRCEDT4",92,0)
 . S CHGREND="" D 3
"RTN","GMRCEDT4",93,0)
 . I '$$VALIDUR(GMRCURG,RENDED,+$G(GMRCPROC)) D  Q
"RTN","GMRCEDT4",94,0)
 .. W !,$C(7),"Unable to change the way service is rendered.",!
"RTN","GMRCEDT4",95,0)
 .. K RENDED S GMRCURG=GMRCURSV S:$D(GMRCED3) GMRCED(3)=GMRCED3
"RTN","GMRCEDT4",96,0)
 I '$$VALIDPL(GMRCPL,RENDED) D  I '$D(RENDED) Q
"RTN","GMRCEDT4",97,0)
 . N GMRCREND,CHGREND S GMRCREND=RENDED
"RTN","GMRCEDT4",98,0)
 . W $C(7),!!,"The Place of Consultation is no longer valid.",!
"RTN","GMRCEDT4",99,0)
 . S GMRCPLSV=GMRCPL S:$D(GMRCED(4)) GMRCED4=GMRCED(4) S CHGREND="" D 4
"RTN","GMRCEDT4",100,0)
 . I '$$VALIDPL(GMRCPL,RENDED) D  Q
"RTN","GMRCEDT4",101,0)
 .. W !,$C(7),"Unable to change the way service is rendered.",!
"RTN","GMRCEDT4",102,0)
 .. K RENDED S GMRCPL=GMRCPLSV S:$D(GMRCED4) GMRCED(4)=GMRCED4
"RTN","GMRCEDT4",103,0)
 .. S:$D(GMRCURSV) GMRCURG=GMRCURSV
"RTN","GMRCEDT4",104,0)
 .. S:$D(GMRCED3) GMRCED(3)=GMRCED3
"RTN","GMRCEDT4",105,0)
 S (GMRCREND,GMRCED(2))=RENDED
"RTN","GMRCEDT4",106,0)
 Q
"RTN","GMRCEDT4",107,0)
3 ;edit urgency
"RTN","GMRCEDT4",108,0)
 N X,Y,XQORM
"RTN","GMRCEDT4",109,0)
 I $P(GMRCREND,U)="O" S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM - OUTPATIENT")
"RTN","GMRCEDT4",110,0)
 I '$D(Y) D  ;inpatient
"RTN","GMRCEDT4",111,0)
 .I '$G(GMRCPROC) S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM CSLT - INPATIENT") Q
"RTN","GMRCEDT4",112,0)
 .S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM REQ - INPATIENT")
"RTN","GMRCEDT4",113,0)
 I 'Y W !,$C(7),"Unable to change urgency." Q
"RTN","GMRCEDT4",114,0)
 S XQORM=+Y_";ORD(101,",XQORM(0)="1A\",XQORM("A")="Urgency: "
"RTN","GMRCEDT4",115,0)
 S XQORM("^^NO")=0
"RTN","GMRCEDT4",116,0)
 S:'$D(CHGREND) XQORM("B")=$P($G(GMRCURG),U,2)
"RTN","GMRCEDT4",117,0)
 D EN^XQORM
"RTN","GMRCEDT4",118,0)
 Q:Y'>0
"RTN","GMRCEDT4",119,0)
 I $P(Y(1),U,2)'=+GMRCURG D
"RTN","GMRCEDT4",120,0)
 . S GMRCED(3)=$P(Y(1),U,2)_U_$P(Y(1),U,3),GMRCURG=GMRCED(3)
"RTN","GMRCEDT4",121,0)
 Q
"RTN","GMRCEDT4",122,0)
4 ;edit place of CSLT
"RTN","GMRCEDT4",123,0)
 N X,Y,XQORM
"RTN","GMRCEDT4",124,0)
 S Y=$$FIND1^DIC(101,,"QX","GMRCPLACEM - "_$$UP^XLFSTR($P(GMRCREND,U,2))) Q:'Y
"RTN","GMRCEDT4",125,0)
 S XQORM=Y_";ORD(101,"
"RTN","GMRCEDT4",126,0)
 S XQORM(0)="1AR\",XQORM("A")="Place of Consultation: ",XQORM("NO^^")=""
"RTN","GMRCEDT4",127,0)
 S:'$D(CHGREND) XQORM("B")=$P($G(GMRCPL),U,2)
"RTN","GMRCEDT4",128,0)
 D EN^XQORM
"RTN","GMRCEDT4",129,0)
 Q:Y'>0
"RTN","GMRCEDT4",130,0)
 I $P(Y(1),U,2)'=+GMRCPL D
"RTN","GMRCEDT4",131,0)
 . S GMRCED(4)=$P(Y(1),U,2)_U_$P(Y(1),U,3),GMRCPL=GMRCED(4)
"RTN","GMRCEDT4",132,0)
 Q
"RTN","GMRCEDT4",133,0)
5 ;edit ATTN person
"RTN","GMRCEDT4",134,0)
 N X,Y,DIR
"RTN","GMRCEDT4",135,0)
 S DIR(0)="PAO^200:EQM",DIR("A")="Select ATTENTION person: "
"RTN","GMRCEDT4",136,0)
 S DIR("B")=$$GET1^DIQ(200,+$P(^GMR(123,+GMRCO,0),U,11),.01)
"RTN","GMRCEDT4",137,0)
 S:$D(GMRCED(5)) DIR("B")=$P($G(GMRCED(5)),U,2)
"RTN","GMRCEDT4",138,0)
 K:'$L(DIR("B")) DIR("B")
"RTN","GMRCEDT4",139,0)
 D ^DIR I $D(DTOUT)!($D(DUOUT)) Q
"RTN","GMRCEDT4",140,0)
 I $G(DIR("B"))=$P(Y,U,2) Q
"RTN","GMRCEDT4",141,0)
 S GMRCED(5)=$S(Y=-1:"",1:Y)
"RTN","GMRCEDT4",142,0)
 I GMRCED(5)="" W !,?5,"<DELETED>",!
"RTN","GMRCEDT4",143,0)
 Q
"RTN","GMRCEDT4",144,0)
6 ;edit prov. DX
"RTN","GMRCEDT4",145,0)
 N X,Y,DIC,DIR,PRMPT
"RTN","GMRCEDT4",146,0)
 S PRMPT=$$PROVDX^GMRCUTL1(+$P(^GMR(123,+GMRCO,0),U,5))
"RTN","GMRCEDT4",147,0)
 I $P(PRMPT,U,2)="F" D
"RTN","GMRCEDT4",148,0)
 . S DIR(0)="FA^2:180",DIR("A")="Provisional Diagnosis: "
"RTN","GMRCEDT4",149,0)
 . I $P(PRMPT,U)'="R" S $P(DIR(0),U)="FAO"
"RTN","GMRCEDT4",150,0)
 . S:$D(GMRCED(6)) DIR("B")=$P(GMRCED(6),U)
"RTN","GMRCEDT4",151,0)
 . I '$D(DIR("B")) S DIR("B")=$G(^GMR(123,+GMRCO,30))
"RTN","GMRCEDT4",152,0)
 . K:'$L(DIR("B")) DIR("B")
"RTN","GMRCEDT4",153,0)
 . D ^DIR Q:$D(DTOUT)!($D(DUOUT))  Q:Y=$G(DIR("B"))
"RTN","GMRCEDT4",154,0)
 . I '$L(Y) W !,?5,"<DELETED>",!
"RTN","GMRCEDT4",155,0)
 . S GMRCED(6)=Y
"RTN","GMRCEDT4",156,0)
 I $P(PRMPT,U,2)="L" D
"RTN","GMRCEDT4",157,0)
 . D CONFIG^LEXSET("ICD","ICD")
"RTN","GMRCEDT4",158,0)
 . S DIR(0)="PA"_$S($P(PRMPT,U)'="R":"O",1:"")_"^757.01:EQM"
"RTN","GMRCEDT4",159,0)
 . S DIR("A")="Provisional Diagnosis: "
"RTN","GMRCEDT4",160,0)
 . I $D(GMRCED(6)) S DIR("B")=$P(GMRCED(6),U)
"RTN","GMRCEDT4",161,0)
 . I '$D(DIR("B")),$D(^GMR(123,+GMRCO,30.1)) D
"RTN","GMRCEDT4",162,0)
 .. S DIR("B")=$P(^GMR(123,GMRCO,30),(" ("_^(30.1)_")"))
"RTN","GMRCEDT4",163,0)
 . D ^DIR Q:$D(DTOUT)!($D(DUOUT))
"RTN","GMRCEDT4",164,0)
 . I $G(^GMR(123,GMRCO,30.1)),$D(Y(1)),^(30.1)=Y(1) Q
"RTN","GMRCEDT4",165,0)
 . S GMRCED(6)=$S(Y=-1:"",1:$P(Y,U,2)_U_$G(Y(1)))
"RTN","GMRCEDT4",166,0)
 . ;I $D(GMRCED(6)) S $P(GMRCED(6),U,2)=$G(Y(1))
"RTN","GMRCEDT4",167,0)
 . Q
"RTN","GMRCEDT4",168,0)
 Q
"RTN","GMRCEDT4",169,0)
7 ;edit Reason for Request
"RTN","GMRCEDT4",170,0)
 N DIC,DIWESUB,DWLW,DWPK
"RTN","GMRCEDT4",171,0)
 I $D(^TMP("GMRCED",$J,20)) M ^TMP("GMRCEDSV",$J,20)=^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",172,0)
 I '$D(^TMP("GMRCED",$J,20)) M ^TMP("GMRCED",$J,20)=^GMR(123,+GMRCO,20)
"RTN","GMRCEDT4",173,0)
 S DIC="^TMP(""GMRCED"",$J,20,",DIWESUB="Reason for Request"
"RTN","GMRCEDT4",174,0)
 W !,"Editing Reason for Request:",!
"RTN","GMRCEDT4",175,0)
 S DWPK=1,DWLW=74 D EN^DIWE
"RTN","GMRCEDT4",176,0)
 I '$$DIFFRFR($D(^TMP("GMRCEDSV",$J,20))) D  Q
"RTN","GMRCEDT4",177,0)
 . I $D(^TMP("GMRCEDSV",$J,20)) K ^TMP("GMRCEDSV",$J,20) Q
"RTN","GMRCEDT4",178,0)
 . K ^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",179,0)
 K ^TMP("GMRCEDSV",$J,20)
"RTN","GMRCEDT4",180,0)
 I '$D(^TMP("GMRCED",$J,20))!('$O(^TMP("GMRCED",$J,20,0))) D
"RTN","GMRCEDT4",181,0)
 . N GMRCMSG
"RTN","GMRCEDT4",182,0)
 . S GMRCMSG="Unable to delete Reason for Request (REQUIRED)"
"RTN","GMRCEDT4",183,0)
 . D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCEDT4",184,0)
 . K ^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",185,0)
 Q
"RTN","GMRCEDT4",186,0)
8 ;add comment
"RTN","GMRCEDT4",187,0)
 N DIC,DIWEPSE,DIWESUB,DWLW,DWPK
"RTN","GMRCEDT4",188,0)
 I $D(^TMP("GMRCED",$J,40)) D
"RTN","GMRCEDT4",189,0)
 . W !,"An unsaved comment exists. You may edit this comment.",!
"RTN","GMRCEDT4",190,0)
 . S DIWEPSE=1
"RTN","GMRCEDT4",191,0)
 S DIC="^TMP(""GMRCED"",$J,40,",DIWESUB="New Comment"
"RTN","GMRCEDT4",192,0)
 W !,"Adding new comment:",!
"RTN","GMRCEDT4",193,0)
 S DWPK=1,DWLW=74 D EN^DIWE
"RTN","GMRCEDT4",194,0)
 I '$O(^TMP("GMRCED",$J,40,0)) K ^TMP("GMRCED",$J,40)
"RTN","GMRCEDT4",195,0)
 Q
"RTN","GMRCEDT4",196,0)
DIFFRFR(SAVED) ;edited reason for req same as original?
"RTN","GMRCEDT4",197,0)
 N I,DIFF
"RTN","GMRCEDT4",198,0)
 I SAVED,$P($G(^TMP("GMRCED",$J,20,0)),U,3,4)'=$P($G(^TMP("GMRCEDSV",$J,20,0)),U,3,4) S DIFF=1 Q 1
"RTN","GMRCEDT4",199,0)
 I 'SAVED,$P($G(^TMP("GMRCED",$J,20,0)),U,3,4)'=$P($G(^GMR(123,+GMRCO,20,0)),U,3,4) S DIFF=1 Q 1
"RTN","GMRCEDT4",200,0)
 I SAVED S I=0 F  S I=$O(^TMP("GMRCED",$J,20,I)) Q:'I!($D(DIFF))  D
"RTN","GMRCEDT4",201,0)
 . I ^TMP("GMRCED",$J,20,I,0)=$G(^TMP("GMRCEDSV",$J,20,I,0)) Q
"RTN","GMRCEDT4",202,0)
 . S DIFF=1
"RTN","GMRCEDT4",203,0)
 . Q
"RTN","GMRCEDT4",204,0)
 I 'SAVED S I=0 F  S I=$O(^TMP("GMRCED",$J,20,I)) Q:'I!($D(DIFF))  D
"RTN","GMRCEDT4",205,0)
 . I ^TMP("GMRCED",$J,20,I,0)'=$G(^GMR(123,+GMRCO,20,I,0)) S DIFF=1
"RTN","GMRCEDT4",206,0)
 . Q
"RTN","GMRCEDT4",207,0)
 Q $G(DIFF)
"RTN","GMRCEDT4",208,0)
VALIDPL(PL,REND) ; place still valid?
"RTN","GMRCEDT4",209,0)
 N PLMENU
"RTN","GMRCEDT4",210,0)
 S PLMENU=$S($P(REND,U)="I":"IN",1:"OUT")
"RTN","GMRCEDT4",211,0)
 S PLMENU="GMRCPLACEM - "_PLMENU_"PATIENT"
"RTN","GMRCEDT4",212,0)
 S PLMENU=$$FIND1^DIC(101,,"QX",PLMENU) Q:PLMENU'>1 0
"RTN","GMRCEDT4",213,0)
 Q $D(^ORD(101,PLMENU,10,"B",+PL))
"RTN","GMRCEDT4",214,0)
VALIDUR(URG,REND,PROC) ;urgency still valid?
"RTN","GMRCEDT4",215,0)
 N URMENU
"RTN","GMRCEDT4",216,0)
 I $P(REND,U)="I" D
"RTN","GMRCEDT4",217,0)
 .I 'PROC S URMENU="GMRCURGENCYM CSLT - INPATIENT" Q
"RTN","GMRCEDT4",218,0)
 .S URMENU="GMRCURGENCYM REQ - INPATIENT" Q
"RTN","GMRCEDT4",219,0)
 I '$D(URMENU) S URMENU="GMRCURGENCYM - OUTPATIENT"
"RTN","GMRCEDT4",220,0)
 S URMENU=$$FIND1^DIC(101,,"QX",URMENU) Q:URMENU<0 0
"RTN","GMRCEDT4",221,0)
 Q $D(^ORD(101,URMENU,10,"B",+URG))
"RTN","GMRCEDT4",222,0)
 Q
"RTN","GMRCEDT4",223,0)
NOCHG() ;no changes made
"RTN","GMRCEDT4",224,0)
 Q "No Changes made!"
"RTN","GMRCGUIA")
0^43^B45802159
"RTN","GMRCGUIA",1,0)
GMRCGUIA ;SLC/DCM,JFR - File Consult actions from GUI  ;1/8/02 14:36
"RTN","GMRCGUIA",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,12,15,22**;DEC 27, 1997
"RTN","GMRCGUIA",3,0)
 ;
"RTN","GMRCGUIA",4,0)
 ; This routine invokes IA #2638,#2926
"RTN","GMRCGUIA",5,0)
 ;
"RTN","GMRCGUIA",6,0)
NEW(DFN,GMRCDA,GMRCLOC,GMRCTYPE,GMRCSVC,GMRCPROV,GMRCURG,GMRCPLI,GMRCNP,GMRCATN,GMRCINOT,GMRCDIAG,GMRCRFQ) ;Add a new consult for a patient.
"RTN","GMRCGUIA",7,0)
 ;DFN=Patient ^DPT( file number
"RTN","GMRCGUIA",8,0)
 ;GMRCRFQ=Reason For Request, why the consult is being ordered. Passed in as
"RTN","GMRCGUIA",9,0)
 ;    an array
"RTN","GMRCGUIA",10,0)
 ;GMRCDIAG=Povisional diagnosis; what is suspected to be the problem
"RTN","GMRCGUIA",11,0)
 ;GMRCTYPE=Request type -Consult or Procedure
"RTN","GMRCGUIA",12,0)
 ;GMRCLOC=Patient location.
"RTN","GMRCGUIA",13,0)
 ;GMRCDA=Date Time of Request
"RTN","GMRCGUIA",14,0)
 ;GMRCSVC=To Service; consulting service
"RTN","GMRCGUIA",15,0)
 ;GMRCLOC=Hospital Location ordering consult
"RTN","GMRCGUIA",16,0)
 ;GMRCPR=If a procedure, the procedure ordered (pointer to file 101)
"RTN","GMRCGUIA",17,0)
 ;GMRCURG=Urgency of request (stat, routine, etc) from file 101
"RTN","GMRCGUIA",18,0)
 ;GMRCPLI=Place of consultation (bedside, consultants choice, etc.) from file 101
"RTN","GMRCGUIA",19,0)
 ;GMRCPROV=Sending Provider
"RTN","GMRCGUIA",20,0)
 ;GMRCATN=if consult is to go to a specific provider, this provider is identified here.
"RTN","GMRCGUIA",21,0)
 ;GMRCINOT=Service provided as Inpatient or Outpatient
"RTN","GMRCGUIA",22,0)
 N DIC,DLAYGO,Y,DIE,GMRCADUZ,X,GMRCO,DR
"RTN","GMRCGUIA",23,0)
 S DIC="^GMR(123,",DIC(0)="L",X="""N""",DLAYGO=123 D ^DIC K DLAYGO
"RTN","GMRCGUIA",24,0)
 S (DA,GMRCO)=+Y,GMRCSTS=5,GMRCA=1,DIE=DIC
"RTN","GMRCGUIA",25,0)
 L +^GMR(123,GMRC0)
"RTN","GMRCGUIA",26,0)
 S DR=".02////^S X=DFN;.04////^S X=GMRCLOC;1////^S X=GMRCSVC;3////^S X=GMRCDA;4////^S X=GMRCPR;5////^S X=GMRCURG;6////^S X=GMRCPLI"_$S(GMRCATN]"":"7////^S X=GMRCATN",1:"")
"RTN","GMRCGUIA",27,0)
 D ^DIE
"RTN","GMRCGUIA",28,0)
 S DR="8////^S X=GMRCSTS;9////^S X=GMRCA;10////^S X=GMRCPROV;11////^S X=GMRCATN;13////^S X=GMRCTYPE;14////^S X=GMRCINOT"_$S($D(GMRCDIAG):"30:////^S X=GMRCDIAG",1:"")
"RTN","GMRCGUIA",29,0)
 D ^DIE L -^GMR(123,GMRCO)
"RTN","GMRCGUIA",30,0)
 I $O(GMRCRFQ(0)) D REASON^GMRCGUIB(GMRCO,GMRCRFQ,GMRCDA)
"RTN","GMRCGUIA",31,0)
 D EN^GMRCHL7(DFN,GMRCDA,GMRCTYPE,$G(GMRCRB),"NW",DUZ,$G(VISIT),"")
"RTN","GMRCGUIA",32,0)
 D EXIT
"RTN","GMRCGUIA",33,0)
 Q
"RTN","GMRCGUIA",34,0)
 ;
"RTN","GMRCGUIA",35,0)
RC(GMRCO,GMRCORNP,GMRCAD,GMRCMT,GMRCDUZ) ;Receive consult into service
"RTN","GMRCGUIA",36,0)
 ;
"RTN","GMRCGUIA",37,0)
 ;Input variables:
"RTN","GMRCGUIA",38,0)
 ;GMRCO - The internal file number of the consult from File 123
"RTN","GMRCGUIA",39,0)
 ;GMRCORNP - Name of the person who actually 'Received'the consult 
"RTN","GMRCGUIA",40,0)
 ;GMRCDUZ - DUZ of person entering the consult as being 'RECEIVED'.
"RTN","GMRCGUIA",41,0)
 ;GMRCAD - Actual date time that consult was received into the service.
"RTN","GMRCGUIA",42,0)
 ;GMRCMT - array of comments if entered (by reference)
"RTN","GMRCGUIA",43,0)
 ;   ARRAY(1)="FIRST LINE OF COMMENT"
"RTN","GMRCGUIA",44,0)
 ;   ARRAY(2)="SECOND LINE OF COMMENT"
"RTN","GMRCGUIA",45,0)
 ;GMRCDUZ - DUZ of person entering the consult as being 'RECEIVED'
"RTN","GMRCGUIA",46,0)
 ;
"RTN","GMRCGUIA",47,0)
 ;Output:
"RTN","GMRCGUIA",48,0)
 ;GMRCERR - Error Condition Code: 0 = NO error, 1=error
"RTN","GMRCGUIA",49,0)
 ;GMRCERMS - Error message or null
"RTN","GMRCGUIA",50,0)
 ;  returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIA",51,0)
 ;
"RTN","GMRCGUIA",52,0)
 N DFN,GMRCSTS,GMRCNOW,GMRCERR,GMRCERMS
"RTN","GMRCGUIA",53,0)
 S GMRCERR=0,GMRCERMS="",GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIA",54,0)
 S:$G(GMRCAD)="" GMRCAD=GMRCNOW
"RTN","GMRCGUIA",55,0)
 S:'$G(GMRCDUZ) GMRCDUZ=DUZ
"RTN","GMRCGUIA",56,0)
 S DFN=$P($G(^GMR(123,GMRCO,0)),"^",2) I DFN="" S GMRCERR="1",GMRCERMS="Not A Valid Consult - File Not Found." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",57,0)
 S GMRCSTS=6,GMRCA=21
"RTN","GMRCGUIA",58,0)
 D STATUS^GMRCP I $D(GMRCQUT) D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",59,0)
 I '$O(GMRCMT(0)) D AUDIT^GMRCP
"RTN","GMRCGUIA",60,0)
 I $O(GMRCMT(0)) D
"RTN","GMRCGUIA",61,0)
 . S DA=$$SETDA^GMRCGUIB
"RTN","GMRCGUIA",62,0)
 . D SETCOM^GMRCGUIB(.GMRCMT,GMRCDUZ)
"RTN","GMRCGUIA",63,0)
 D EN^GMRCHL7(DFN,GMRCO,"","","SC",GMRCORNP,"","")
"RTN","GMRCGUIA",64,0)
 D EXIT
"RTN","GMRCGUIA",65,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",66,0)
 ;
"RTN","GMRCGUIA",67,0)
DC(GMRCO,GMRCORNP,GMRCAD,GMRCACTM,GMRCOM) ;Discontinue or Deny a consult
"RTN","GMRCGUIA",68,0)
 ;
"RTN","GMRCGUIA",69,0)
 ;Input variables:
"RTN","GMRCGUIA",70,0)
 ;GMRCO - Internal file number of consult from File 123
"RTN","GMRCGUIA",71,0)
 ;GMRCORNP - Provider who Discontinued or Denied consult
"RTN","GMRCGUIA",72,0)
 ;GMRCAD - FM date/time of actual activity.
"RTN","GMRCGUIA",73,0)
 ;GMRCACTM - set to "DY" if 'CANCELLED'(old DENY)
"RTN","GMRCGUIA",74,0)
 ;           set to "DC" if consult is Discontinued 
"RTN","GMRCGUIA",75,0)
 ;GMRCOM - Comment array containing explanation of action
"RTN","GMRCGUIA",76,0)
 ;    Passed by reference in the following form :
"RTN","GMRCGUIA",77,0)
 ;     ARRAY(1)="xxx xxx xxx"
"RTN","GMRCGUIA",78,0)
 ;     ARRAY(2)="XXX XXX"
"RTN","GMRCGUIA",79,0)
 ;     ARRAY(3)="XXX XXX xx", etc.
"RTN","GMRCGUIA",80,0)
 ;  Comment is a required field when consult is denied or discontinued.
"RTN","GMRCGUIA",81,0)
 ;
"RTN","GMRCGUIA",82,0)
 ;Output:
"RTN","GMRCGUIA",83,0)
 ;GMRCERR=Error Flag: 0 if no error, 1 if error occurred 
"RTN","GMRCGUIA",84,0)
 ;GMRCERMS - Error message or null
"RTN","GMRCGUIA",85,0)
 ; returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIA",86,0)
 ;
"RTN","GMRCGUIA",87,0)
 N GMRCDUZ,DFN,GMRCNOW,GMRCSTS,GMRCERR,GMRCERMS,GMRCADUZ,GMRCTRLC
"RTN","GMRCGUIA",88,0)
 S GMRCERR=0,GMRCERMS=""
"RTN","GMRCGUIA",89,0)
 S GMRCDUZ=DUZ,GMRCERR=0,GMRCERMS="",GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIA",90,0)
 K GMRCQUT
"RTN","GMRCGUIA",91,0)
 S:$G(GMRCAD)="" GMRCAD=GMRCNOW
"RTN","GMRCGUIA",92,0)
 S DFN=$P($G(^GMR(123,GMRCO,0)),"^",2) I DFN="" S GMRCERR="1",GMRCERMS="Not A Valid Consult - File Not Found." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",93,0)
 I '$D(GMRCOM) S GMRCERR=1,GMRCERMS="Comments are required for this action." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",94,0)
 S GMRCSTS=$P(^ORD(100.01,$P(^GMR(123,GMRCO,0),"^",12),0),U,2)
"RTN","GMRCGUIA",95,0)
 I GMRCSTS="dc" S GMRCERR=1,GMRCERMS="Order Has Already Been Discontinued." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",96,0)
 I GMRCSTS="ca" S GMRCERR=1,GMRCERMS="Order Has Already Been Cancelled." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",97,0)
 I GMRCSTS="comp" S GMRCERR=1,GMRCERMS="Order Has Already Been Completed." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",98,0)
 S GMRCA=$S(GMRCACTM="DC":6,1:19),GMRCSTS=$S(GMRCA=6:1,1:13)
"RTN","GMRCGUIA",99,0)
 D STATUS^GMRCP I $D(GMRCQUT) D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",100,0)
 I GMRCACTM="DC",$$DCPRNT^GMRCUTL1(GMRCO,DUZ) D PRNT^GMRCUTL1("",GMRCO)
"RTN","GMRCGUIA",101,0)
 S DA=$$SETDA^GMRCGUIB D SETCOM^GMRCGUIB(.GMRCOM)
"RTN","GMRCGUIA",102,0)
 S GMRCOM(0)=DA
"RTN","GMRCGUIA",103,0)
 S GMRCTRLC=$S(GMRCACTM="DC":"OD",1:"OC")
"RTN","GMRCGUIA",104,0)
 D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCRB),GMRCTRLC,GMRCORNP,$G(GMRCVSIT),.GMRCOM,,GMRCAD)
"RTN","GMRCGUIA",105,0)
 S GMRCORTX=$S(GMRCACTM="DY":"Cancelled",1:"Discontinued")_" consult "
"RTN","GMRCGUIA",106,0)
 S GMRCORTX=GMRCORTX_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCGUIA",107,0)
 S GMRCADUZ="",GMRCFL=0
"RTN","GMRCGUIA",108,0)
 I GMRCACTM="DC" D
"RTN","GMRCGUIA",109,0)
 . S GMRCFL=$$DCNOTE^GMRCADC(GMRCO,DUZ) ;NOTIFY SERVICE ON DC ?
"RTN","GMRCGUIA",110,0)
 I +$P($G(^GMR(123,+GMRCO,0)),"^",14),$P(^(0),"^",14)'=DUZ D
"RTN","GMRCGUIA",111,0)
 . S GMRCADUZ($P(^(0),"^",14))=""
"RTN","GMRCGUIA",112,0)
 ;send notification
"RTN","GMRCGUIA",113,0)
 N NOTYPE S NOTYPE=$S(GMRCA=6:23,1:30)
"RTN","GMRCGUIA",114,0)
 D MSG^GMRCP(DFN,GMRCORTX,+GMRCO,NOTYPE,.GMRCADUZ,GMRCFL)
"RTN","GMRCGUIA",115,0)
 D EXIT
"RTN","GMRCGUIA",116,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",117,0)
 ;
"RTN","GMRCGUIA",118,0)
FR(GMRCO,GMRCSS,GMRCORNP,GMRCATTN,GMRCURGI,GMRCOM,GMRCAD) ;FWD consult
"RTN","GMRCGUIA",119,0)
 ;to another service
"RTN","GMRCGUIA",120,0)
 ;
"RTN","GMRCGUIA",121,0)
 ;Input variables:
"RTN","GMRCGUIA",122,0)
 ;GMRCO=File 123 IEN of the consult record
"RTN","GMRCGUIA",123,0)
 ;GMRCSS=service being forwarded to; ptr to REQUEST SERVICES (#123.5)
"RTN","GMRCGUIA",124,0)
 ;GMRCORNP=Provider Responsible for action
"RTN","GMRCGUIA",125,0)
 ;GMRCATTN=NEW PERSON to whose attention action should be directed
"RTN","GMRCGUIA",126,0)
 ;GMRCURGI=urgency from PROTOCOL(#101) file
"RTN","GMRCGUIA",127,0)
 ;GMRCOM=Comment array containing explanation of action
"RTN","GMRCGUIA",128,0)
 ;    Passed by reference in the following form :
"RTN","GMRCGUIA",129,0)
 ;     ARRAY(1)="xxx xxx xxx"
"RTN","GMRCGUIA",130,0)
 ;     ARRAY(2)="XXX XXX"
"RTN","GMRCGUIA",131,0)
 ;     ARRAY(3)="XXX XXX xx", etc.
"RTN","GMRCGUIA",132,0)
 ;GMRCAD=FM date/time of actual activity
"RTN","GMRCGUIA",133,0)
 ;
"RTN","GMRCGUIA",134,0)
 ;Output:
"RTN","GMRCGUIA",135,0)
 ;  GMRCERR=Error Flag: 0 if no error, 1 if error occurred 
"RTN","GMRCGUIA",136,0)
 ;  GMRCERMS - Error message or null
"RTN","GMRCGUIA",137,0)
 ;     returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIA",138,0)
 ;
"RTN","GMRCGUIA",139,0)
 N DR,GMRCDUZ,GMRCNOW,GMRCFF,GMRCFR,GMRCADUZ,GMRCURG
"RTN","GMRCGUIA",140,0)
 N GMRCERR,GMRCERMS,GMRCIROL,GMRCINM,GMRCIROU
"RTN","GMRCGUIA",141,0)
 S GMRCERR=0,GMRCERMS=""
"RTN","GMRCGUIA",142,0)
 S DFN=$P(^GMR(123,+GMRCO,0),U,2)
"RTN","GMRCGUIA",143,0)
 S GMRCDUZ=DUZ,GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIA",144,0)
 S:'$G(GMRCAD) GMRCAD=GMRCNOW  ;Actual FM date/time consult was FWD'd 
"RTN","GMRCGUIA",145,0)
 S:'$G(GMRCURGI) GMRCURGI=$P(^GMR(123,GMRCO,0),U,9)
"RTN","GMRCGUIA",146,0)
 S GMRCA=17,GMRCSTS=5
"RTN","GMRCGUIA",147,0)
 S GMRCFF=$P($G(^GMR(123.5,+GMRCSS,123)),U,9) ;printed to new serv
"RTN","GMRCGUIA",148,0)
 S GMRCFR=$P($G(^GMR(123,+GMRCO,0)),"^",5) ;Get current service 
"RTN","GMRCGUIA",149,0)
 S DIE="^GMR(123,",DA=GMRCO,DR=""
"RTN","GMRCGUIA",150,0)
 I $D(^GMR(123.5,+GMRCSS,"IFC")) D  ; if fwd to IFC serv, get extra flds
"RTN","GMRCGUIA",151,0)
 . S GMRCIROU=$P(^GMR(123.5,+GMRCSS,"IFC"),U) Q:GMRCIROU=""  ;no rout fac
"RTN","GMRCGUIA",152,0)
 . S GMRCINM=$P(^GMR(123.5,+GMRCSS,"IFC"),U,2) Q:GMRCINM=""  ;no serv nm
"RTN","GMRCGUIA",153,0)
 . S GMRCA=25,GMRCIROL="P"
"RTN","GMRCGUIA",154,0)
 . S DR=".07////^S X=GMRCIROU;.125////^S X=GMRCIROL;"
"RTN","GMRCGUIA",155,0)
 S DR=DR_"1////^S X=$G(GMRCSS);5////^S X=$G(GMRCURGI);8////^S X=$G(GMRCSTS);9////^S X=$G(GMRCA);.1///@"_$S($L($G(GMRCATTN)):";7////^S X=GMRCATTN",1:"")
"RTN","GMRCGUIA",156,0)
 L +^GMR(123,GMRCO):3 I '$T K DIE,DA,DR S GMRCERR=1,GMRCERMS="Data Not Filed - File In Use By Another User." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",157,0)
 D ^DIE L -^GMR(123,GMRCO) K DIE,DA,DR
"RTN","GMRCGUIA",158,0)
 S DA=$$SETDA^GMRCGUIB D SETCOM^GMRCGUIB(.GMRCOM)
"RTN","GMRCGUIA",159,0)
 S GMRCURG=$P($G(^ORD(101,+GMRCURGI,0)),"^",2)
"RTN","GMRCGUIA",160,0)
 D DEM^GMRCU ;sets GMRCRB and other variables
"RTN","GMRCGUIA",161,0)
 D TYPE^GMRCAFRD ;sets GMRCTYPE
"RTN","GMRCGUIA",162,0)
 D FRMSG^GMRCAFRD ;create XX HL7 message for OE/RR and send alert 
"RTN","GMRCGUIA",163,0)
 D EXIT
"RTN","GMRCGUIA",164,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",165,0)
 ;
"RTN","GMRCGUIA",166,0)
RT(GMRCO,TMPGLOB) ;Set ^TMP("GMRCR",$J,"DT", with results from med and TIU
"RTN","GMRCGUIA",167,0)
 ;GMRCO=IEN of consult from file 123
"RTN","GMRCGUIA",168,0)
 ;Set TMPGLOB to a ^TMP global other than ^TMP("GMRCR",$J,"MCAR", or ^TMP("GMRCR",$J,"RES", i.e., S TMPGLOB="^TMP(""GMRCR"",$J,""RT"")"'
"RTN","GMRCGUIA",169,0)
 Q:'$G(GMRCO)
"RTN","GMRCGUIA",170,0)
 K @TMPGLOB
"RTN","GMRCGUIA",171,0)
 S GMRCDVL="",$P(GMRCDVL,"-",41)=""
"RTN","GMRCGUIA",172,0)
 S GMRCSR=$P(^GMR(123,+GMRCO,0),"^",15),GMRCTUFN=$P(^(0),"^",20)
"RTN","GMRCGUIA",173,0)
 S GMRCRTFL=$S('+GMRCSR&('GMRCTUFN):1,1:0)
"RTN","GMRCGUIA",174,0)
 ;
"RTN","GMRCGUIA",175,0)
 D GETRSLT^GMRCART(TMPGLOB)
"RTN","GMRCGUIA",176,0)
 ;
"RTN","GMRCGUIA",177,0)
 D EXIT
"RTN","GMRCGUIA",178,0)
 Q
"RTN","GMRCGUIA",179,0)
EXIT ;kill off variables for exit from actions
"RTN","GMRCGUIA",180,0)
 K GMRCA,GMRCDVL,GMRCSR,GMRCRTFL,GMRCFL,GMRCORNP,GMRCQUT,GMRCSTS,GMRCTUFN
"RTN","GMRCGUIA",181,0)
 K GMRCRTFL,GMRCADUZ,GMRCORTX
"RTN","GMRCGUIA",182,0)
 Q
"RTN","GMRCGUIB")
0^23^B38678179
"RTN","GMRCGUIB",1,0)
GMRCGUIB ;SLC/DCM,JFR,MA - GUI actions for consults ;1/11/01  12:53
"RTN","GMRCGUIB",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,18,20,17,22**;DEC 27, 1997
"RTN","GMRCGUIB",3,0)
 ; This routine invokes IA #2980
"RTN","GMRCGUIB",4,0)
 ;
"RTN","GMRCGUIB",5,0)
SETDA() ;set DA of where audit actions are to be filed
"RTN","GMRCGUIB",6,0)
 S:'$D(^GMR(123,+GMRCO,40,0)) ^GMR(123,GMRCO,40,0)="^123.02DA^^"
"RTN","GMRCGUIB",7,0)
 S DA=$S($P(^GMR(123,+GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCGUIB",8,0)
 S $P(^GMR(123,+GMRCO,40,0),"^",3,4)=DA_"^"_DA
"RTN","GMRCGUIB",9,0)
 Q DA
"RTN","GMRCGUIB",10,0)
REASON(GMRCFN,GMRCRQ,GMRCDT) ;Load the reason for the request into ^GMR(123,GMRCO,20
"RTN","GMRCGUIB",11,0)
 ;GMRCFN=File 123 IFN; GMRCRQ=Array containing Reason For Request
"RTN","GMRCGUIB",12,0)
 ;GMRCDT=Date time of entry
"RTN","GMRCGUIB",13,0)
 S ^GMR(123,GMRCFN,20,0)="^^^"_GMRCDT_"^"
"RTN","GMRCGUIB",14,0)
 S L=0,LN=1 F  S L=$O(GMRCRQ(L)) Q:L=""  S ^GMR(123,GMRCFN,20,LN,0)=GMRCRQ(L),LN=LN+1
"RTN","GMRCGUIB",15,0)
 S LN=LN-1,$P(^GMR(123,GMRCFN,20,0),"^",3)=LN
"RTN","GMRCGUIB",16,0)
 K LN,L
"RTN","GMRCGUIB",17,0)
 Q
"RTN","GMRCGUIB",18,0)
SETCOM(COMMENT,WHO) ;Set comment array into tracking actions
"RTN","GMRCGUIB",19,0)
 N GMRCNOW,DR,DIE
"RTN","GMRCGUIB",20,0)
 S GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIB",21,0)
 S DIE="^GMR(123,GMRCO,40,",DA(1)=GMRCO,DR=".01////^S X=GMRCNOW;1////^S X=GMRCA;2////^S X=GMRCAD;3////^S X=$G(GMRCORNP);4////^S X=$S($G(WHO):WHO,1:DUZ);6////^S X=$G(GMRCFR);8////^S X=$G(GMRCFF)"
"RTN","GMRCGUIB",22,0)
 D ^DIE
"RTN","GMRCGUIB",23,0)
 S ^GMR(123,GMRCO,40,DA,1,0)="^^^^"_GMRCAD_"^"
"RTN","GMRCGUIB",24,0)
 S (GMRCND,GMRCND1)=0 F  S GMRCND1=$O(COMMENT(GMRCND1)) Q:GMRCND1=""  S GMRCND=GMRCND+1,^GMR(123,GMRCO,40,DA,1,GMRCND,0)=COMMENT(GMRCND)
"RTN","GMRCGUIB",25,0)
 S $P(^GMR(123,GMRCO,40,DA,1,0),"^",3)=GMRCND,$P(^(0),"^",4)=GMRCND,^GMR(123,GMRCO,40,"B",GMRCNOW,DA)=""
"RTN","GMRCGUIB",26,0)
 ;
"RTN","GMRCGUIB",27,0)
 ; if an IFC, call event handler to generate a msg to remote site
"RTN","GMRCGUIB",28,0)
 I $D(^GMR(123,+GMRCO,12)),$D(^(40,DA)) D TRIGR^GMRCIEVT(GMRCO,DA)
"RTN","GMRCGUIB",29,0)
 ;
"RTN","GMRCGUIB",30,0)
 K GMRCND,GMRCND1
"RTN","GMRCGUIB",31,0)
 Q
"RTN","GMRCGUIB",32,0)
CMT(GMRCO,GMRCOM,GMRCADUZ,GMRCWHN,GMRCWHO) ;add comment to consult record
"RTN","GMRCGUIB",33,0)
 ; GMRCO = IEN from file 123
"RTN","GMRCGUIB",34,0)
 ; GMRCOM = array of comments in format GMRCOM(1)="xxxx", GMRCOM(2)="xxx"
"RTN","GMRCGUIB",35,0)
 ; GMRCADUZ= array of alert recipients as GMRCADUZ(DUZ)="" (optional)
"RTN","GMRCGUIB",36,0)
 ; GMRCWHO= IEN from file 200 who's responsible activity (optional)
"RTN","GMRCGUIB",37,0)
 ; GMRCWHN= date time of activity in FM format
"RTN","GMRCGUIB",38,0)
 ;
"RTN","GMRCGUIB",39,0)
 N DA,GMRCA,GMRCAD,GMRCORTX,GMRCDFN
"RTN","GMRCGUIB",40,0)
 S DA=$$SETDA ; get next activity tracking entry
"RTN","GMRCGUIB",41,0)
 S GMRCA=20,GMRCAD=GMRCWHN S:$G(GMRCWHO) GMRCORNP=GMRCWHO
"RTN","GMRCGUIB",42,0)
 D SETCOM(.GMRCOM,$G(GMRCWHO))
"RTN","GMRCGUIB",43,0)
 Q:'$D(GMRCADUZ)
"RTN","GMRCGUIB",44,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCGUIB",45,0)
 S GMRCORTX="Comment Added to Consult "
"RTN","GMRCGUIB",46,0)
 S GMRCORTX=GMRCORTX_$$GET1^DIQ(123.5,$P(^GMR(123,+GMRCO,0),U,5),.01)
"RTN","GMRCGUIB",47,0)
 ;
"RTN","GMRCGUIB",48,0)
 ; Patch 18 changed MSG 27 to 63 "Consult/request update"
"RTN","GMRCGUIB",49,0)
 ; Patch 20 checks to see if GUI v15 is installed to use new
"RTN","GMRCGUIB",50,0)
 ; alert code #63
"RTN","GMRCGUIB",51,0)
 N GMRCALT
"RTN","GMRCGUIB",52,0)
 S GMRCALT=$S($$PATCH^XPDUTL("OR*3.0*85"):63,1:27)
"RTN","GMRCGUIB",53,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,GMRCALT,.GMRCADUZ,0)
"RTN","GMRCGUIB",54,0)
 Q
"RTN","GMRCGUIB",55,0)
SFILE(GMRCO,GMRCA,GMRCSF,GMRCORNP,GMRCDUZ,GMRCOM,GMRCALF,GMRCATO,GMRCAD) ;Process various file update functions from the GUI for a consult
"RTN","GMRCGUIB",56,0)
 ; ADMIN COMPLETE or SIGNIFICANT FINDINGS
"RTN","GMRCGUIB",57,0)
 ;Input variables:
"RTN","GMRCGUIB",58,0)
 ;GMRCO=File 123 IEN of the consult record
"RTN","GMRCGUIB",59,0)
 ;GMRCA=pointer to REQUEST ACTION TYPES (#123.1) 10=complete, 4=Sig find.
"RTN","GMRCGUIB",60,0)
 ;GMRCSF=Significant Findings flag: 'Y'= significant finding
"RTN","GMRCGUIB",61,0)
 ;                                : 'N'= no significant finding
"RTN","GMRCGUIB",62,0)
 ;                                : 'U'=unknown significant finding
"RTN","GMRCGUIB",63,0)
 ;GMRCORNP=Provider Responsible for action
"RTN","GMRCGUIB",64,0)
 ;GMRCDUZ=Person actually doing the action
"RTN","GMRCGUIB",65,0)
 ;GMRCOM=An array of comments by reference ARRAY(1)="xxx",ARRAY(2)="xxx"
"RTN","GMRCGUIB",66,0)
 ;GMRCALF=Flag to signal that alerts are to be sent; 'N'=NO, 'Y'=YES
"RTN","GMRCGUIB",67,0)
 ;GMRCATO=Who alerts are to be sent to; a comma delimited string of DUZ's
"RTN","GMRCGUIB",68,0)
 ;GMRCAD =FM date/time of activity
"RTN","GMRCGUIB",69,0)
 ;
"RTN","GMRCGUIB",70,0)
 ;Output:
"RTN","GMRCGUIB",71,0)
 ; GMRCERR=Error Flag: 0 if no error, 1 if error occurred 
"RTN","GMRCGUIB",72,0)
 ; GMRCERMS - Error message or null
"RTN","GMRCGUIB",73,0)
 ;    returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIB",74,0)
 ;
"RTN","GMRCGUIB",75,0)
 N GMRCERR,GMRCERMS
"RTN","GMRCGUIB",76,0)
 L +^GMR(123,GMRCO):5 I '$T S GMRCERR=1,GMRCERMS="Record Locked. File Update Not Accomplished." Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",77,0)
 S GMRCERR=0,GMRCERMS="",DR="",GMRCORTX=""
"RTN","GMRCGUIB",78,0)
 N GMRCADUZ S GMRCADUZ=""
"RTN","GMRCGUIB",79,0)
 S GMRCNOW=$$NOW^XLFDT,GMRCSTS=$P(^GMR(123,+GMRCO,0),"^",12),GMRCDFN=$P(^(0),"^",2)
"RTN","GMRCGUIB",80,0)
 I '$G(GMRCDUZ) S GMRCDUZ=DUZ
"RTN","GMRCGUIB",81,0)
 I '$G(GMRCAD) S GMRCAD=GMRCNOW
"RTN","GMRCGUIB",82,0)
 I +$G(GMRCA),GMRCA=10 D
"RTN","GMRCGUIB",83,0)
 .S GMRCSF=$G(GMRCSF,"")
"RTN","GMRCGUIB",84,0)
 .S GMRCSTS=2
"RTN","GMRCGUIB",85,0)
 .S DR="8////^S X=GMRCSTS;9////^S X=GMRCA"
"RTN","GMRCGUIB",86,0)
 .S GMRCORTX="Completed Consult "_$$ORTX^GMRCAU(+GMRCO)_$S(GMRCSF="Y":" with Sig Findings",GMRCSF="N":" with no Sig Findings",1:"")
"RTN","GMRCGUIB",87,0)
 .I $P($G(^GMR(123,+GMRCO,0)),U,14) S GMRCADUZ($P($G(^(0)),U,14))=""
"RTN","GMRCGUIB",88,0)
 .Q
"RTN","GMRCGUIB",89,0)
 I $G(GMRCALF)=1 D
"RTN","GMRCGUIB",90,0)
 .N I
"RTN","GMRCGUIB",91,0)
 .F I=1:1  S X=$P(GMRCATO,";",I) Q:X=""  S GMRCADUZ(X)=""
"RTN","GMRCGUIB",92,0)
 .Q
"RTN","GMRCGUIB",93,0)
 I $L(GMRCA),GMRCA=4 S DR=DR_$S($L(DR):";",1:"")_"9////^S X=GMRCA;15////^S X=GMRCSF" D
"RTN","GMRCGUIB",94,0)
 .S GMRCORTX=$S(GMRCSF="Y":"Sig Findings ",GMRCSF="N":"No Sig Findings ",1:"Unknown Sig Findings ")_"for consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCGUIB",95,0)
 .I $P($G(^GMR(123,+GMRCO,0)),U,14) S GMRCADUZ($P($G(^(0)),U,14))=""
"RTN","GMRCGUIB",96,0)
 .Q
"RTN","GMRCGUIB",97,0)
 I $L(DR) S DIE="^GMR(123,",DA=GMRCO D ^DIE K DIE,DR
"RTN","GMRCGUIB",98,0)
 I '$O(GMRCOM(0)) D AUDIT^GMRCP
"RTN","GMRCGUIB",99,0)
 I $D(GMRCOM),$O(GMRCOM(0)) D
"RTN","GMRCGUIB",100,0)
 .N DA
"RTN","GMRCGUIB",101,0)
 .S DA=$$SETDA()
"RTN","GMRCGUIB",102,0)
 .D SETCOM(.GMRCOM,GMRCDUZ)
"RTN","GMRCGUIB",103,0)
 .Q
"RTN","GMRCGUIB",104,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCGUIB",105,0)
 ;
"RTN","GMRCGUIB",106,0)
 ; Patch #18 changed GMRCA=20:27 TO 20:63
"RTN","GMRCGUIB",107,0)
 ; Patch 20 checks to see if GUI v15 is installed to use new
"RTN","GMRCGUIB",108,0)
 ; alert code #63
"RTN","GMRCGUIB",109,0)
 N GMRCALT
"RTN","GMRCGUIB",110,0)
 S GMRCALT=$S($$PATCH^XPDUTL("OR*3.0*85"):63,1:27)
"RTN","GMRCGUIB",111,0)
 I +$G(GMRCALF) D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,$S(GMRCA=20:GMRCALT,1:23),.GMRCADUZ,0)
"RTN","GMRCGUIB",112,0)
 I $S(GMRCA=10:1,1:0) D EN^GMRCHL7($P(^GMR(123,GMRCO,0),"^",2),GMRCO,$G(GMRCTYPE),$G(GMRCRB),"RE",GMRCORNP,$G(GMRCVSIT),.GMRCOM,,GMRCAD)
"RTN","GMRCGUIB",113,0)
 K DIE,DR,DA,GMRCDT,GMRCNOW,GMRCAD,GMRCORNP,GMRCDUZ,GMRCRSLT,GMRCSTS,GMRCADUZ,GMRCORTX,GMRCDFN
"RTN","GMRCGUIB",114,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",115,0)
 ;
"RTN","GMRCGUIB",116,0)
SCH(GMRCO,GMRCORNP,GMRCAD,GMRCADUZ,GMRCMT) ;schedule a consult API
"RTN","GMRCGUIB",117,0)
 ; Input variables:
"RTN","GMRCGUIB",118,0)
 ;GMRCO - The internal file number of the consult from File 123
"RTN","GMRCGUIB",119,0)
 ;GMRCORNP - Name of the person who actually 'Received' the consult 
"RTN","GMRCGUIB",120,0)
 ;GMRCAD - Actual date time that consult was received into the service.
"RTN","GMRCGUIB",121,0)
 ;GMRCADUZ - array of alert recipients as chosen by user (by reference)
"RTN","GMRCGUIB",122,0)
 ;   ARRAY(DUZ)="" 
"RTN","GMRCGUIB",123,0)
 ;GMRCMT - array of comments if entered (by reference)
"RTN","GMRCGUIB",124,0)
 ;   ARRAY(1)="FIRST LINE OF COMMENT"
"RTN","GMRCGUIB",125,0)
 ;   ARRAY(2)="SECOND LINE OF COMMENT"
"RTN","GMRCGUIB",126,0)
 ;
"RTN","GMRCGUIB",127,0)
 ;Output:
"RTN","GMRCGUIB",128,0)
 ;GMRCERR - Error Condition Code: 0 = NO error, 1=error
"RTN","GMRCGUIB",129,0)
 ;GMRCERMS - Error message or null
"RTN","GMRCGUIB",130,0)
 ;  returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIB",131,0)
        ;
"RTN","GMRCGUIB",132,0)
 N DFN,GMRCSTS,GMRCNOW,GMRCERR,GMRCERMS
"RTN","GMRCGUIB",133,0)
 S GMRCERR=0,GMRCERMS="",GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIB",134,0)
 S:$G(GMRCAD)="" GMRCAD=GMRCNOW
"RTN","GMRCGUIB",135,0)
 S:'$G(GMRCDUZ) GMRCDUZ=DUZ
"RTN","GMRCGUIB",136,0)
 S DFN=$P($G(^GMR(123,GMRCO,0)),"^",2) I DFN="" D  Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",137,0)
 . S GMRCERR="1",GMRCERMS="Not A Valid Consult - File Not Found."
"RTN","GMRCGUIB",138,0)
 . D EXIT^GMRCGUIA
"RTN","GMRCGUIB",139,0)
 S GMRCSTS=8,GMRCA=8
"RTN","GMRCGUIB",140,0)
 D STATUS^GMRCP I $D(GMRCQUT) D EXIT^GMRCGUIA Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",141,0)
 I '$O(GMRCMT(0)) D AUDIT^GMRCP
"RTN","GMRCGUIB",142,0)
 I $O(GMRCMT(0)) D
"RTN","GMRCGUIB",143,0)
 . S DA=$$SETDA
"RTN","GMRCGUIB",144,0)
 . D SETCOM(.GMRCMT,GMRCDUZ)
"RTN","GMRCGUIB",145,0)
 D EN^GMRCHL7(DFN,GMRCO,"","","SC",GMRCORNP,"","","",GMRCAD)
"RTN","GMRCGUIB",146,0)
 I $D(GMRCADUZ),$O(GMRCMT(0)) D
"RTN","GMRCGUIB",147,0)
 . N TXT S TXT="Scheduled Consult: "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCGUIB",148,0)
 . ; Patch 18 changed alert 27 to 63 "Consult/request update"
"RTN","GMRCGUIB",149,0)
 . ; Patch 20 checks to see if GUI v15 is installed to use new
"RTN","GMRCGUIB",150,0)
 . ; alert code #63
"RTN","GMRCGUIB",151,0)
 . N GMRALERT
"RTN","GMRCGUIB",152,0)
 . S GMRALERT=$S($$PATCH^XPDUTL("OR*3.0*85"):63,1:27)
"RTN","GMRCGUIB",153,0)
 . D MSG^GMRCP(DFN,TXT,GMRCO,GMRALERT,.GMRCADUZ,0)
"RTN","GMRCGUIB",154,0)
 D EXIT^GMRCGUIA
"RTN","GMRCGUIB",155,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",156,0)
DOCLIST(GMRCAR,GMRCDA,GMRCMED)  ;return list of linked results
"RTN","GMRCGUIB",157,0)
 ; Input:
"RTN","GMRCGUIB",158,0)
 ;  GMRCAR - array to return list, passed by reference
"RTN","GMRCGUIB",159,0)
 ;  GMRCDA - ien from file 123
"RTN","GMRCGUIB",160,0)
 ;  GMRCMED- 1 = include med results; 0 = only TIU docs
"RTN","GMRCGUIB",161,0)
 ;
"RTN","GMRCGUIB",162,0)
 ; Output:
"RTN","GMRCGUIB",163,0)
 ;  GMRCAR - array in format
"RTN","GMRCGUIB",164,0)
 ;       GMRCAR(0)=zero node of record
"RTN","GMRCGUIB",165,0)
 ;       GMRCAR(50,1)="ien;global ref," e.g. 5;TIU(8925, or 3;MCAR(691,
"RTN","GMRCGUIB",166,0)
 ;       GMRCAR(50,2)="ien;global ref,"
"RTN","GMRCGUIB",167,0)
 ;
"RTN","GMRCGUIB",168,0)
 I '$D(^GMR(123,GMRCDA,0)) Q
"RTN","GMRCGUIB",169,0)
 S GMRCAR(0)=^GMR(123,GMRCDA,0),$P(GMRCAR(0),U,20)=""
"RTN","GMRCGUIB",170,0)
 N RES,CNT S RES="",CNT=1
"RTN","GMRCGUIB",171,0)
 F  S RES=$O(^GMR(123,GMRCDA,50,"B",RES)) Q:RES=""  D
"RTN","GMRCGUIB",172,0)
 . I '$G(GMRCMED) Q:RES'["TIU(8925"
"RTN","GMRCGUIB",173,0)
 . S GMRCAR(50,CNT)=RES
"RTN","GMRCGUIB",174,0)
 . I RES["MCAR" D
"RTN","GMRCGUIB",175,0)
 .. N ARR,STR
"RTN","GMRCGUIB",176,0)
 .. D MEDLKUP^MCARUTL3(.ARR,+$P(RES,"MCAR(",2),+RES)
"RTN","GMRCGUIB",177,0)
 .. I '+ARR K GMRCAR(50,CNT) Q
"RTN","GMRCGUIB",178,0)
 .. S STR=$P(ARR,U,9)_U_$P(ARR,U,6)_$S($P(ARR,U,10):"^^^^^^^^1",1:"")
"RTN","GMRCGUIB",179,0)
 .. S GMRCAR(50,CNT)=GMRCAR(50,CNT)_U_STR
"RTN","GMRCGUIB",180,0)
 . S CNT=CNT+1
"RTN","GMRCGUIB",181,0)
 Q
"RTN","GMRCGUIC")
0^29^B50329951
"RTN","GMRCGUIC",1,0)
GMRCGUIC ;SLC/DCM,JFR - GUI actions for editing consults; 1/17/02 14:14
"RTN","GMRCGUIC",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,20,15,22**;DEC 27, 1997
"RTN","GMRCGUIC",3,0)
 ;
"RTN","GMRCGUIC",4,0)
 ; This routine invokes IA #2398,#2698,#2713,#2960
"RTN","GMRCGUIC",5,0)
 ;
"RTN","GMRCGUIC",6,0)
RFQ(GMRCO,MSG,ND,NOW) ;File Reason For Request field 20
"RTN","GMRCGUIC",7,0)
 N GMRCND,GMRCNT
"RTN","GMRCGUIC",8,0)
 S GMRCND=$O(^GMR(123,GMRCO,20,0)) I GMRCND="" S GMRCFLD(20)="Reason For Request: No Previous Value^20" Q
"RTN","GMRCGUIC",9,0)
 M ^TMP("GMRCFLD20",$J,20)=^GMR(123,GMRCO,20)
"RTN","GMRCGUIC",10,0)
 S GMRCFLD(20)=$NAME(^TMP("GMRCFLD20",$J,20))
"RTN","GMRCGUIC",11,0)
 K ^GMR(123,GMRCO,20)
"RTN","GMRCGUIC",12,0)
 S ^GMR(123,GMRCO,20,0)="^^^^"_DT_"^"
"RTN","GMRCGUIC",13,0)
 S GMRCND="",GMRCNT=1 F  S GMRCND=$O(@MSG@(ND,GMRCND)) Q:GMRCND=""  S ^GMR(123,GMRCO,20,GMRCNT,0)=@MSG@(ND,GMRCND),GMRCNT=GMRCNT+1
"RTN","GMRCGUIC",14,0)
 S $P(^GMR(123,GMRCO,20,0),"^",3)=GMRCNT-1,$P(^(0),"^",4)=GMRCNT-1
"RTN","GMRCGUIC",15,0)
 Q
"RTN","GMRCGUIC",16,0)
FILE(GMRCO,MSG,GMRCLM) ;File Edit changes
"RTN","GMRCGUIC",17,0)
 ;GMRCO=Record IEN,  GMRCCOM=Comment Array
"RTN","GMRCGUIC",18,0)
 ;MSG=^TMP global where the data resides, i.e., MSG="^TMP(""GMRCR"",$J)"
"RTN","GMRCGUIC",19,0)
 ;    Data is stored in subscripted nodes: ^TMP("GMRCR",$J,1)="GMRCSS^2"
"RTN","GMRCGUIC",20,0)
 ;    Word processing data is stored in second subscripted node:
"RTN","GMRCGUIC",21,0)
 ;    ^TMP("GMRCR",$J,9,1)="This is word processing data."
"RTN","GMRCGUIC",22,0)
 ;GMRCSS=To Service     GMRCPROC=procedure/Request Type
"RTN","GMRCGUIC",23,0)
 ;GMRCURG=Urgency       GMRCPL=Place Of Consultation
"RTN","GMRCGUIC",24,0)
 ;GMRCATN=Attention To  GMRCINO=Service is In/Out Patient
"RTN","GMRCGUIC",25,0)
 ;GMRCDIAG=Provisional Diagnosis  .GMRCRFQ=Reason For Request array
"RTN","GMRCGUIC",26,0)
 ;GMRCREQ=Procedure or Request; i.e., GMRCRQT=1727=^ORD(101,1727,0)='Procedure';GMRCRQT=1296=^ORD(101,1296,0)='Consult'
"RTN","GMRCGUIC",27,0)
 ;GMRCITM=Item ordered for field .1 (stored in ^GMR(123,GMRCO,1.11,
"RTN","GMRCGUIC",28,0)
 ;GMRCLM=coming from List Manager instead of the GUI
"RTN","GMRCGUIC",29,0)
 ;
"RTN","GMRCGUIC",30,0)
 I '$D(GMRCO)!('+GMRCO) Q
"RTN","GMRCGUIC",31,0)
 N GMRCSS,GMRCPROC,GMRCURG,GMRCPL,GMRCATN,GMRCRQT
"RTN","GMRCGUIC",32,0)
 N GMRCION,GMRCDIAG,GMRCDXCD,GMRCACTN
"RTN","GMRCGUIC",33,0)
 S GMRCDT=$$NOW^XLFDT
"RTN","GMRCGUIC",34,0)
 S GMRCMSG="",GMRCNOD=0
"RTN","GMRCGUIC",35,0)
 F  S GMRCNOD=$O(@MSG@(GMRCNOD)) Q:GMRCNOD=""  S GMRCMSG=@MSG@(GMRCNOD) D
"RTN","GMRCGUIC",36,0)
 .I $P(GMRCMSG,"^",1)="COMMENT" D COMMENT^GMRCGUIU(GMRCO,MSG,GMRCNOD,$P(GMRCMSG,"^",2)) Q
"RTN","GMRCGUIC",37,0)
 .I $P(GMRCMSG,"^",1)="GMRCRFQ" D RFQ(GMRCO,MSG,GMRCNOD,GMRCDT) Q
"RTN","GMRCGUIC",38,0)
 .I $P(GMRCMSG,"^",1)="GMRCSS" S GMRCSS=$P(GMRCMSG,"^",2),GMRCFLD(1)=$P(^GMR(123.5,$P(^GMR(123,GMRCO,0),"^",5),0),"^",1)_"^1" Q
"RTN","GMRCGUIC",39,0)
 .I $P(GMRCMSG,"^",1)="GMRCITM" S GMRCITM=$P(GMRCMSG,"^",2),GMRCFLD(.1)=^GMR(123,GMRCO,1.11)_"^.1" Q
"RTN","GMRCGUIC",40,0)
 .I $P(GMRCMSG,"^",1)="GMRCPROC" Q  ;S GMRCFLD(4)=+$P(^GMR(123,+GMRCO,0),"^",8)_"^4" D  Q ;ignore procedure, can't be changed currently
"RTN","GMRCGUIC",41,0)
 .; ..S GMRCPROC=$P(GMRCMSG,"^",2) I $L($P(^GMR(123,GMRCO,0),"^",8)),$P(GMRCMSG,"^",2)="" S GMRCPROC="DELETE"
"RTN","GMRCGUIC",42,0)
 .I $P(GMRCMSG,"^",1)="GMRCURG" S GMRCURG=$P(GMRCMSG,"^",2),GMRCFLD(5)=$S(+$P(^GMR(123,+GMRCO,0),"^",9):$P(^ORD(101,+$P(^GMR(123,+GMRCO,0),"^",9),0),"^",2),1:"")_"^"_$P(^GMR(123,+GMRCO,0),"^",9) Q
"RTN","GMRCGUIC",43,0)
 .I $P(GMRCMSG,"^",1)="GMRCPL" D  Q
"RTN","GMRCGUIC",44,0)
 ..S GMRCPL=$P(GMRCMSG,"^",2) I '+GMRCPL D
"RTN","GMRCGUIC",45,0)
 ...S GMRCPL="GMRCPLACE - "_$S(GMRCPL="C":"ON CALL",GMRCPL="B":"BEDSIDE",GMRCPL="E":"EMERGENCY ROOM",1:GMRCPL),GMRCPL=$O(^ORD(101,"B",GMRCPL,0))
"RTN","GMRCGUIC",46,0)
 ..S GMRCFLD(6)=$S(+$P(^GMR(123,+GMRCO,0),"^",10):$P($P(^ORD(101,+$P(^GMR(123,+GMRCO,0),"^",10),0),"^",1)," - ",2),1:"")_"^6"
"RTN","GMRCGUIC",47,0)
 ..Q
"RTN","GMRCGUIC",48,0)
 .I $P(GMRCMSG,"^",1)="GMRCATN" S GMRCATN=$P(GMRCMSG,"^",2),GMRCFLD(7)=$S(+$P(^GMR(123,+GMRCO,0),"^",11):$P(^VA(200,+$P(^GMR(123,+GMRCO,0),"^",11),0),"^",1),1:"")_"^7" Q
"RTN","GMRCGUIC",49,0)
 .I $P(GMRCMSG,"^",1)="GMRCREQ" S GMRCREQ=$P(GMRCMSG,"^",2),GMRCFLD(13)=$S($P(^GMR(123,+GMRCO,0),"^",17)="P":"Procedure",1:"Consult")_"^13" Q
"RTN","GMRCGUIC",50,0)
 .I $P(GMRCMSG,"^",1)="GMRCION" S GMRCION=$P(GMRCMSG,"^",2),GMRCFLD(14)=$S($P(^GMR(123,+GMRCO,0),"^",18)="I":"Inpatient",$P(^(0),"^",18)="O":"Outpatient",1:"")_"^14" Q
"RTN","GMRCGUIC",51,0)
 .I $P(GMRCMSG,"^",1)="GMRCDIAG" D  Q
"RTN","GMRCGUIC",52,0)
 ..S GMRCDIAG=$P(GMRCMSG,"^",2)
"RTN","GMRCGUIC",53,0)
 ..S GMRCFLD(30)=$G(^GMR(123,+GMRCO,30))_"^30"
"RTN","GMRCGUIC",54,0)
 ..I $P(GMRCFLD(30),U)="" S $P(GMRCFLD(30),U)="No Previous Value"
"RTN","GMRCGUIC",55,0)
 ..I $L($P(GMRCMSG,U,3)) D
"RTN","GMRCGUIC",56,0)
 ...S GMRCDXCD=$P(GMRCMSG,"^",3)
"RTN","GMRCGUIC",57,0)
 ...S GMRCFLD(30.1)=$G(^GMR(123,+GMRCO,30.1))
"RTN","GMRCGUIC",58,0)
 .Q
"RTN","GMRCGUIC",59,0)
 S:'$D(GMRCLM) GMRCGUIF=1
"RTN","GMRCGUIC",60,0)
 S GMRCACTN=$$EN^GMRCEDT3(GMRCO)
"RTN","GMRCGUIC",61,0)
 S DR=$$SETDA^GMRCGUIU($G(GMRCSS),$G(GMRCPROC),$G(GMRCURG),$G(GMRCPL),$G(GMRCATN),$G(GMRCRQT),$G(GMRCION),$G(GMRCDIAG),$G(GMRCDXCD)) I $L(DR) D
"RTN","GMRCGUIC",62,0)
 .S DIE="^GMR(123,",DA=GMRCO
"RTN","GMRCGUIC",63,0)
 .L +^GMR(123,GMRCO)
"RTN","GMRCGUIC",64,0)
 .D ^DIE
"RTN","GMRCGUIC",65,0)
 .S DR="8////^S X=5;9////^S X=11"
"RTN","GMRCGUIC",66,0)
 .D ^DIE
"RTN","GMRCGUIC",67,0)
 .L -^GMR(123,GMRCO)
"RTN","GMRCGUIC",68,0)
 .K DIE,DR,DA
"RTN","GMRCGUIC",69,0)
 .Q
"RTN","GMRCGUIC",70,0)
 S DFN=$P(^GMR(123,+GMRCO,0),"^",2),GMRCPROV=$P(^(0),"^",14),GMRCTYPE=$P(^(0),"^",17),GMRCTRLC="XX^RESUBMIT",VISIT="",RMBED=""
"RTN","GMRCGUIC",71,0)
 D EN^GMRCHL7(DFN,+GMRCO,GMRCTYPE,RMBED,GMRCTRLC,$G(DUZ),VISIT,.GMRCOM)
"RTN","GMRCGUIC",72,0)
 S GMRCSVC=$S($G(GMRCSS):GMRCSS,1:$P(^GMR(123,+GMRCO,0),U,5))
"RTN","GMRCGUIC",73,0)
 S GMRCORTX="Resubmitted consult "_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCGUIC",74,0)
 S GMRCORTX=GMRCORTX_$S($G(GMRCURG):" ("_$P(^ORD(101,+GMRCURG,0),"^",2)_")",+$P(^GMR(123,+GMRCO,0),U,9):"( "_$P(^ORD(101,+$P(^GMR(123,+GMRCO,0),U,9),0),"^",2)_" )",1:"")
"RTN","GMRCGUIC",75,0)
 S GMRCFL=1
"RTN","GMRCGUIC",76,0)
 D MSG^GMRCP(DFN,GMRCORTX,+GMRCO,27,.GMRCADUZ,GMRCFL) ;Send notification of NEW consult
"RTN","GMRCGUIC",77,0)
 D PRNT^GMRCUTL1(+$P(^GMR(123,+GMRCO,0),U,5),+GMRCO) ;send 513 to service
"RTN","GMRCGUIC",78,0)
 ;Next line gets rid of alert
"RTN","GMRCGUIC",79,0)
 I $D(XQAID),$L(XQAID) D
"RTN","GMRCGUIC",80,0)
 . N GMRCCORY
"RTN","GMRCGUIC",81,0)
 . S XQAKILL=$$XQAKILL^ORB3F1 D DEL^ORB3FUP1(.GMRCCORY,XQAID)
"RTN","GMRCGUIC",82,0)
 I $P($G(^GMR(123,+GMRCO,12)),U,5)="P" D
"RTN","GMRCGUIC",83,0)
 . D TRIGR^GMRCIEVT(GMRCO,GMRCACTN)
"RTN","GMRCGUIC",84,0)
 D GUIC^GMRCGUIU
"RTN","GMRCGUIC",85,0)
 Q
"RTN","GMRCGUIC",86,0)
SEND(GMRCO,GLOBAL) ;Get data fields to send to GUI for editing consult
"RTN","GMRCGUIC",87,0)
 ;GMRCO=record being edited GLOBAL=Global Referece, i.e., "^TMP("GMRCR",$J)"
"RTN","GMRCGUIC",88,0)
 K @GLOBAL
"RTN","GMRCGUIC",89,0)
 N ND,GMRCSX,TYPE,NDX
"RTN","GMRCGUIC",90,0)
 S ND=1,GMRCSX=""
"RTN","GMRCGUIC",91,0)
 I '$D(GMRCO)!('+GMRCO) Q
"RTN","GMRCGUIC",92,0)
 S GMRC(0)=$G(^GMR(123,+GMRCO,0)) Q:'$L(GMRC(0))
"RTN","GMRCGUIC",93,0)
 S GMRCSS=$P(GMRC(0),"^",5),GMRCPROC=$P(GMRC(0),"^",8)
"RTN","GMRCGUIC",94,0)
 S GMRCURG=$P(GMRC(0),"^",9),GMRCPL=$P(GMRC(0),"^",10)
"RTN","GMRCGUIC",95,0)
 S GMRCATN=$P(GMRC(0),"^",11),GMRCINO=$P(GMRC(0),"^",18)
"RTN","GMRCGUIC",96,0)
 S GMRCREQ=$P(GMRC(0),"^",17)
"RTN","GMRCGUIC",97,0)
 S GMRCDIAG=$G(^GMR(123,+GMRCO,30)) I $L($G(^(30.1))) D
"RTN","GMRCGUIC",98,0)
 . S GMRCDIAG=GMRCDIAG_U_$G(^GMR(123,+GMRCO,30.1))
"RTN","GMRCGUIC",99,0)
 S GMRCPROV=$S($P(^GMR(123,+GMRCO,0),U,14):$$GET1^DIQ(200,+$P(^(0),U,14),.01),1:"")
"RTN","GMRCGUIC",100,0)
 S @GLOBAL@(ND,0)="~SERVICE",ND=ND+1
"RTN","GMRCGUIC",101,0)
 I +GMRCSS S GMRCSX=$P(^GMR(123.5,GMRCSS,0),"^",1),@GLOBAL@(ND,0)="d"_GMRCSX_"^"_GMRCSS_"^",ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",102,0)
 E  S @GLOBAL@(ND,0)="d"_"^^",ND=ND+1
"RTN","GMRCGUIC",103,0)
 S @GLOBAL@(ND,0)="~PROCEDURE",ND=ND+1
"RTN","GMRCGUIC",104,0)
 I $L(GMRCPROC),+GMRCPROC D
"RTN","GMRCGUIC",105,0)
 .S GMRCSX=$$UP^XLFSTR($$GET1^DIQ(123.3,+GMRCPROC,.01))
"RTN","GMRCGUIC",106,0)
 .S GMRCSY=$$FIND1^DIC(101.43,,"QX",+GMRCPROC_";99PRC","ID")
"RTN","GMRCGUIC",107,0)
 .I +GMRCSY D
"RTN","GMRCGUIC",108,0)
 ..S @GLOBAL@(ND,0)="d"_GMRCSY_"^"_GMRCSX,ND=ND+1
"RTN","GMRCGUIC",109,0)
 ..Q
"RTN","GMRCGUIC",110,0)
 E  S @GLOBAL@(ND,0)="d^^"
"RTN","GMRCGUIC",111,0)
 S @GLOBAL@(ND,0)="~TYPE",ND=ND+1
"RTN","GMRCGUIC",112,0)
 I $L(GMRCREQ) D  I '$L(GMRCREQ) S @GLOBAL@(ND,0)="d^^"
"RTN","GMRCGUIC",113,0)
 . S GMRCSX=$S(GMRCREQ="P":"PROCEDURE",1:"CONSULT")
"RTN","GMRCGUIC",114,0)
 . S @GLOBAL@(ND,0)="d"_$E(GMRCSX,1)_"^"_GMRCSX_"^"_GMRCREQ
"RTN","GMRCGUIC",115,0)
 . S GMRCSX=""
"RTN","GMRCGUIC",116,0)
 S ND=ND+1
"RTN","GMRCGUIC",117,0)
 S @GLOBAL@(ND,0)="~CATEGORY",ND=ND+1
"RTN","GMRCGUIC",118,0)
 I $L(GMRCINO) D  S ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",119,0)
 .S @GLOBAL@(ND,0)="d"_GMRCINO_"^"_$S(GMRCINO="I":"INPATIENT",1:"OUTPATIENT")_"^"
"RTN","GMRCGUIC",120,0)
 .S @GLOBAL@(ND,0)=@GLOBAL@(ND,0)_$S(GMRCINO="I":$O(^ORD(101,"B","GMRCURGENCYM CSLT - INPATIENT",0)),1:$O(^ORD(101,"B","GMRCURGENCYM - OUTPATIENT",0)))
"RTN","GMRCGUIC",121,0)
 .Q
"RTN","GMRCGUIC",122,0)
 E  S @GLOBAL@(ND,0)="d^^"
"RTN","GMRCGUIC",123,0)
 S @GLOBAL@(ND,0)="~DIAGNOSIS",ND=ND+1
"RTN","GMRCGUIC",124,0)
 I $L(GMRCDIAG) S @GLOBAL@(ND,0)="d"_GMRCDIAG,ND=ND+1
"RTN","GMRCGUIC",125,0)
 E  S @GLOBAL@(ND,0)="d"
"RTN","GMRCGUIC",126,0)
 S @GLOBAL@(ND,0)="~PLACE",ND=ND+1
"RTN","GMRCGUIC",127,0)
 I +GMRCPL D  S ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",128,0)
 .S GMRCSX=$P($P(^ORD(101,GMRCPL,0),"^",1),"GMRCPLACE - ",2),GMRCSX=$S(GMRCSX="ON CALL":"CONSULTANTS CHOICE",1:GMRCSX),@GLOBAL@(ND,0)="d"_$E(GMRCSX,1)_"^"_GMRCSX_"^"_GMRCPL
"RTN","GMRCGUIC",129,0)
 .Q
"RTN","GMRCGUIC",130,0)
 E  S @GLOBAL@(ND,0)="d^^",ND=ND+1
"RTN","GMRCGUIC",131,0)
 S @GLOBAL@(ND,0)="~ATTENTION",ND=ND+1
"RTN","GMRCGUIC",132,0)
 I +GMRCATN S GMRCSX=$P(^VA(200,GMRCATN,0),"^",1),@GLOBAL@(ND,0)="d"_GMRCATN_"^"_GMRCSX_"^"_GMRCATN,ND=ND+1,GMRCSX=""
"RTN","GMRCGUIC",133,0)
 E  S @GLOBAL@(ND,0)="d^^",ND=ND+1
"RTN","GMRCGUIC",134,0)
 S @GLOBAL@(ND,0)="~URGENCY",ND=ND+1
"RTN","GMRCGUIC",135,0)
 I +GMRCURG S GMRCSX=$P($P(^ORD(101,GMRCURG,0),"^",1),"GMRCURGENCY - ",2),GMRCURGY=$O(^ORD(101.42,"S.GMRCO",GMRCSX,0)) I $L(GMRCSX) D
"RTN","GMRCGUIC",136,0)
 .S GMRCSY=$O(^ORD(101.42,"B",GMRCSX,0))
"RTN","GMRCGUIC",137,0)
 .S @GLOBAL@(ND,0)="d"_GMRCSY_"^"_GMRCSX_"^"_GMRCURG,ND=ND+1
"RTN","GMRCGUIC",138,0)
 .S GMRCSX="" K GMRCSY
"RTN","GMRCGUIC",139,0)
 .Q
"RTN","GMRCGUIC",140,0)
 E  S @GLOBAL@(ND,0)="d^^",ND=ND+1
"RTN","GMRCGUIC",141,0)
 ;Get reason for request
"RTN","GMRCGUIC",142,0)
 S @GLOBAL@(ND,0)="~REASON",ND=ND+1
"RTN","GMRCGUIC",143,0)
 I $O(^GMR(123,+GMRCO,20,0)) S NDX=0 F  S NDX=$O(^GMR(123,+GMRCO,20,NDX)) Q:NDX=""  S @GLOBAL@(ND,0)="t"_^GMR(123,+GMRCO,20,NDX,0),ND=ND+1
"RTN","GMRCGUIC",144,0)
 E  S @GLOBAL@(ND,0)="~REASON",ND=ND+1,@GLOBAL@(ND,0)="tREASON "
"RTN","GMRCGUIC",145,0)
 ;Get Comments, including Deny Comments
"RTN","GMRCGUIC",146,0)
 D SENDCOMT^GMRCGUIU(GMRCO,.ND)
"RTN","GMRCGUIC",147,0)
 D GUIC^GMRCGUIU
"RTN","GMRCGUIC",148,0)
 Q
"RTN","GMRCGUIU")
0^34^B29044760
"RTN","GMRCGUIU",1,0)
GMRCGUIU ;SLC/DCM,JFR - Utilities for CPRS GUI ;10/24/01 15:15
"RTN","GMRCGUIU",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,15,17,22**;DEC 27, 1997
"RTN","GMRCGUIU",3,0)
 ;
"RTN","GMRCGUIU",4,0)
 ; This routine invokes IA #2757,#3042,#3122,#3171
"RTN","GMRCGUIU",5,0)
 ;
"RTN","GMRCGUIU",6,0)
GUIC ;Kill variables from GMRCGUIC
"RTN","GMRCGUIU",7,0)
 K GMRC(0),GMRCA,GMRCATN,GMRCD,GMRCDD,GMRCDIAG,GMRCDT,GMRCED,GMRCEDCM
"RTN","GMRCGUIU",8,0)
 K GMRCFL,GMRCFLD,GMRCION,GMRCLNO,GMRCNATO,GMRCNT,GMRCORTX,GMRCPL
"RTN","GMRCGUIU",9,0)
 K GMRCPROC,GMRCRQT,GMRCS38,GMRCSS,GMRCSVC,GMRCTRLC,GMRCTYPE,GMRCURG
"RTN","GMRCGUIU",10,0)
 K GMRCX,LN,GMRCADUZ,ORDG,RMBED,VISIT
"RTN","GMRCGUIU",11,0)
 K GMRCITM,GMRCMSG,GMRCND1,GMRCNOD,GMRCPROV,GMRCOUNT,GMRCGUIF,GMRCREQ
"RTN","GMRCGUIU",12,0)
 K GMRCSS,GMRCPROC,GMRCURG,GMRCURGY,GMRCPL,GMRCATN,GMRCINO,GMRCREQ
"RTN","GMRCGUIU",13,0)
 K GMRCDIAG,GMRCDXCD,GMRCPROV,ND,NDX
"RTN","GMRCGUIU",14,0)
 K XQAKILL,^TMP("GMRCFLD20",$J)
"RTN","GMRCGUIU",15,0)
 Q
"RTN","GMRCGUIU",16,0)
SETDA(GMRCSS,GMRCPROC,GMRCURG,GMRCPL,GMRCATN,GMRCRQT,GMRCION,GMRCDIAG,GMRCDXCD)  ;Set DA in ^GMR(123,GMRCO,40
"RTN","GMRCGUIU",17,0)
 N X
"RTN","GMRCGUIU",18,0)
 S X=""
"RTN","GMRCGUIU",19,0)
 I +GMRCSS S X="1////^S X=+GMRCSS;.1///@;"
"RTN","GMRCGUIU",20,0)
 I +GMRCPROC S X=X_"4////^S X=GMRCPROC;.1///@;"
"RTN","GMRCGUIU",21,0)
 I +GMRCURG S X=X_"5////^S X=GMRCURG;"
"RTN","GMRCGUIU",22,0)
 I +GMRCPL S X=X_"6////^S X=GMRCPL;"
"RTN","GMRCGUIU",23,0)
 I +GMRCATN S X=X_"7////^S X=GMRCATN;"
"RTN","GMRCGUIU",24,0)
 I $G(GMRCATN)="@" S X=X_"7///@;"
"RTN","GMRCGUIU",25,0)
 I $L(GMRCION) S X=X_"14///^S X=GMRCION;"
"RTN","GMRCGUIU",26,0)
 I $L(GMRCDIAG) D 
"RTN","GMRCGUIU",27,0)
 . I GMRCDIAG="@" S X=X_"30///@;30.1///@;" Q
"RTN","GMRCGUIU",28,0)
 . S X=X_"30////^S X=GMRCDIAG;"
"RTN","GMRCGUIU",29,0)
 I $L(GMRCDXCD) S X=X_"30.1////^S X=GMRCDXCD;"
"RTN","GMRCGUIU",30,0)
 I $L(X) S X=$E(X,1,$L(X)-1)
"RTN","GMRCGUIU",31,0)
 Q X
"RTN","GMRCGUIU",32,0)
 ;
"RTN","GMRCGUIU",33,0)
COMMENT(GMRCO,MSG,ND,GMRCDA)    ;File comments from GUI edits
"RTN","GMRCGUIU",34,0)
 N Y,GMRCND
"RTN","GMRCGUIU",35,0)
 S GMRCDA=$$ADDCM^GMRCEDT3(GMRCO),GMRCA=20
"RTN","GMRCGUIU",36,0)
 D AUDIT0^GMRCEDT3(GMRCDA,GMRCO)
"RTN","GMRCGUIU",37,0)
 S Y=$$FMTE^XLFDT(DT,"1D"),GMRCFLD(40)="COMMENT ADDED: "_Y_"^"_GMRCDA
"RTN","GMRCGUIU",38,0)
 S GMRCND="",GMRCNT=1 F  S GMRCND=$O(@MSG@(ND,GMRCND)) Q:GMRCND=""  S ^GMR(123,GMRCO,40,GMRCDA,1,GMRCNT,0)=@MSG@(ND,GMRCND),GMRCNT=GMRCNT+1
"RTN","GMRCGUIU",39,0)
 S ^GMR(123,GMRCO,40,GMRCDA,1,0)="^^"_(GMRCNT-1)_"^"_(GMRCNT-1)_"^"_GMRCDT_"^"
"RTN","GMRCGUIU",40,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D
"RTN","GMRCGUIU",41,0)
 . D TRIGR^GMRCIEVT(GMRCO,GMRCDA)
"RTN","GMRCGUIU",42,0)
 Q
"RTN","GMRCGUIU",43,0)
 ;
"RTN","GMRCGUIU",44,0)
SENDCOMT(GMRCO,ND1)     ;Get comments
"RTN","GMRCGUIU",45,0)
 N NDX,NDY,CMTDT,SENDR,TYPE
"RTN","GMRCGUIU",46,0)
 S NDX=0,CMTDT="",SENDR=""
"RTN","GMRCGUIU",47,0)
 S NDX=0 F  S NDX=$O(^GMR(123,GMRCO,40,NDX)) Q:NDX?1A.E!(NDX="")  S TYPE=$P(^GMR(123,GMRCO,40,NDX,0),"^",2) I $S(TYPE=19:1,TYPE=20:1,1:0) S TYPE(TYPE,NDX)=""
"RTN","GMRCGUIU",48,0)
 I $O(TYPE(19,0)) S @GLOBAL@(ND1,0)="~DENY COMMENT",ND1=ND1+1 D
"RTN","GMRCGUIU",49,0)
 .S NDX=0 F  S NDX=$O(TYPE(19,NDX)) Q:NDX=""   D
"RTN","GMRCGUIU",50,0)
 ..S CMTDT=$$FMTE^XLFDT($P(^GMR(123,GMRCO,40,NDX,0),"^",1)),SENDR=$S($L($P(^GMR(123,GMRCO,40,NDX,0),"^",4)):$P(^VA(200,$P(^(0),"^",4),0),"^",1),1:"Missing Data")
"RTN","GMRCGUIU",51,0)
 ..S @GLOBAL@(ND1,0)="t"_"CANCELLED: "_CMTDT_" BY: "_SENDR,ND1=ND1+1,NDY=0
"RTN","GMRCGUIU",52,0)
 ..S NDY=0 F  S NDY=$O(^GMR(123,GMRCO,40,NDX,1,NDY)) Q:NDY=""  S @GLOBAL@(ND1,0)="t"_^GMR(123,GMRCO,40,NDX,1,NDY,0),ND1=ND1+1
"RTN","GMRCGUIU",53,0)
 ..S @GLOBAL@(ND1,0)="t",$P(@GLOBAL@(ND1,0),"-",81)="",ND1=ND1+1
"RTN","GMRCGUIU",54,0)
 ..Q
"RTN","GMRCGUIU",55,0)
 .Q
"RTN","GMRCGUIU",56,0)
 S NDX=0 F  S NDX=$O(TYPE(20,NDX)) Q:NDX=""  S @GLOBAL@(ND1,0)="~ADDED COMMENT",ND1=ND1+1 D
"RTN","GMRCGUIU",57,0)
 .S CMTDT=$$FMTE^XLFDT($P(^GMR(123,GMRCO,40,NDX,0),"^",1)),SENDR=$S($L($P(^GMR(123,GMRCO,40,NDX,0),"^",4)):$P(^VA(200,$P(^GMR(123,GMRCO,40,NDX,0),"^",4),0),"^",1),1:"UNKNOWN")
"RTN","GMRCGUIU",58,0)
 .S @GLOBAL@(ND1,0)="t"_"COMMENT on "_CMTDT_" BY: "_SENDR,ND1=ND1+1
"RTN","GMRCGUIU",59,0)
 .S NDY=0 F  S NDY=$O(^GMR(123,GMRCO,40,NDX,1,NDY)) Q:NDY=""  S @GLOBAL@(ND,0)="t"_^GMR(123,GMRCO,40,NDX,1,NDY,0),ND1=ND1+1
"RTN","GMRCGUIU",60,0)
 .S @GLOBAL@(ND1,0)="t",$P(@GLOBAL@(ND1,0),"-",81)="",ND1=ND1+1
"RTN","GMRCGUIU",61,0)
 .Q
"RTN","GMRCGUIU",62,0)
 Q
"RTN","GMRCGUIU",63,0)
GETMED(GMRCIFN,GMRCRES) ;return available med results for proc request
"RTN","GMRCGUIU",64,0)
 ; input: 
"RTN","GMRCGUIU",65,0)
 ;    GMRCIFN - ien from file 123
"RTN","GMRCGUIU",66,0)
 ;    GMRCRES - variable passed in by reference used for output
"RTN","GMRCGUIU",67,0)
 ; output: 
"RTN","GMRCGUIU",68,0)
 ;     GMRCRES(x) = result_name^date^summary^result_ref
"RTN","GMRCGUIU",69,0)
 ;      example:
"RTN","GMRCGUIU",70,0)
 ;       GMRCRES(1)="19;MCAR(691.5,^EKG^JUN 30,1999@15:52^ABNORMAL"
"RTN","GMRCGUIU",71,0)
 N CNT,ROOT,PROC,S5,DFN,I
"RTN","GMRCGUIU",72,0)
 N MCARCODE,MCARDT,MCESKEY,MCKEYCAR,MCFILE
"RTN","GMRCGUIU",73,0)
 S PROC=+$P($G(^GMR(123,GMRCIFN,0)),U,8)
"RTN","GMRCGUIU",74,0)
 I 'PROC Q  ;no procedure there
"RTN","GMRCGUIU",75,0)
 S ROOT=$$GET1^DIQ(697.2,+$P(^GMR(123.3,PROC,0),U,5),1)
"RTN","GMRCGUIU",76,0)
 I '$L(ROOT) Q  ;proc not set up for med resulting
"RTN","GMRCGUIU",77,0)
 S S5=ROOT D EN^MCARPS2(+$P(^GMR(123,GMRCIFN,0),U,2))
"RTN","GMRCGUIU",78,0)
 I '$D(^TMP("OR",$J,"MCAR","OT")) Q  ;no results available
"RTN","GMRCGUIU",79,0)
 S CNT=0,I=0
"RTN","GMRCGUIU",80,0)
 F  S CNT=$O(^TMP("OR",$J,"MCAR","OT",CNT)) Q:'CNT  D
"RTN","GMRCGUIU",81,0)
 . N DATA S DATA=^TMP("OR",$J,"MCAR","OT",CNT)
"RTN","GMRCGUIU",82,0)
 . Q:$D(^GMR(123,"R",$P(DATA,U,2)_";"_ROOT_","))
"RTN","GMRCGUIU",83,0)
 . Q:$$SCRNDRFT^GMRCMED($P(DATA,U,2),$P(ROOT,"(",2))  ;screen draft rpts
"RTN","GMRCGUIU",84,0)
 . S I=I+1
"RTN","GMRCGUIU",85,0)
 . S GMRCRES(I)=$P(DATA,U,2)_";"_ROOT_","_U_$P(DATA,U)_U_$P(DATA,U,6,7)
"RTN","GMRCGUIU",86,0)
 . Q
"RTN","GMRCGUIU",87,0)
 K MCARCODE,MCARDT,MCESKEY,MCKEYCAR,MCFILE
"RTN","GMRCGUIU",88,0)
 K ^TMP("OR",$J,"MCAR")
"RTN","GMRCGUIU",89,0)
 Q
"RTN","GMRCGUIU",90,0)
GETRES(GMRCO,GMRCAR) ;return array of associated med rslts
"RTN","GMRCGUIU",91,0)
 ; DBIA #: ?
"RTN","GMRCGUIU",92,0)
 ; Input:
"RTN","GMRCGUIU",93,0)
 ;   GMRCO - ien from file 123
"RTN","GMRCGUIU",94,0)
 ;   GMRCAR - variable passed by ref to return array in
"RTN","GMRCGUIU",95,0)
 ; Output:
"RTN","GMRCGUIU",96,0)
 ;   GMRCAR(x)=result_ref^result_name^date^impression
"RTN","GMRCGUIU",97,0)
 ;    Example:
"RTN","GMRCGUIU",98,0)
 ;      GMRCAR(1)="19;MCAR(691.5,^EKG^JUN 30,1999@15:52^ABNORMAL"
"RTN","GMRCGUIU",99,0)
 N RES,CNT,DATA
"RTN","GMRCGUIU",100,0)
 S RES=0,CNT=1
"RTN","GMRCGUIU",101,0)
 F  S RES=$O(^GMR(123,GMRCO,50,RES)) Q:'RES  D
"RTN","GMRCGUIU",102,0)
 . N GMRCMCR,GMRCMCAR,RES0
"RTN","GMRCGUIU",103,0)
 . S RES0=$G(^GMR(123,GMRCO,50,RES,0))
"RTN","GMRCGUIU",104,0)
 . I RES0'["MCAR" Q
"RTN","GMRCGUIU",105,0)
 . S GMRCMCR=$$SINGLE^MCAPI(RES0)
"RTN","GMRCGUIU",106,0)
 . Q:'$L(GMRCMCR)
"RTN","GMRCGUIU",107,0)
 . D MEDLKUP^MCARUTL3(.GMRCMCAR,+$P(RES0,"MCAR(",2),+RES0)
"RTN","GMRCGUIU",108,0)
 . S GMRCAR(CNT)=^GMR(123,GMRCO,50,RES,0)_U
"RTN","GMRCGUIU",109,0)
 . S GMRCAR(CNT)=GMRCAR(CNT)_$P(GMRCMCR,U)_U_$P(GMRCMCR,U,6,7)
"RTN","GMRCGUIU",110,0)
 . I $P(GMRCMCAR,U,10) S GMRCAR(CNT)=GMRCAR(CNT)_"^1"
"RTN","GMRCGUIU",111,0)
 . S CNT=CNT+1
"RTN","GMRCGUIU",112,0)
 . Q
"RTN","GMRCGUIU",113,0)
 Q
"RTN","GMRCGUIU",114,0)
DISPMED(GMRCRES,GMRCAR) ; display a med result
"RTN","GMRCGUIU",115,0)
 ; Input:
"RTN","GMRCGUIU",116,0)
 ;  GMRCRES - med result var ptr  (e.g. "19;MCAR(691.5")
"RTN","GMRCGUIU",117,0)
 ;  GMRCAR  - array to return output from medicine API
"RTN","GMRCGUIU",118,0)
 ; Output:
"RTN","GMRCGUIU",119,0)
 ;  GMRCAR 
"RTN","GMRCGUIU",120,0)
 ;    - var passed by ref or as global ref to return text of 
"RTN","GMRCGUIU",121,0)
 ;      medicine pkg report
"RTN","GMRCGUIU",122,0)
 ;    Example:  GMRCAR(1)="      PROCEDURE DATE/TIME: 06/30/99 15:52"
"RTN","GMRCGUIU",123,0)
 ;              GMRCAR(2)="        CONFIDENTIAL ECG REPORT"
"RTN","GMRCGUIU",124,0)
 ;              GMRCAR(3...)=
"RTN","GMRCGUIU",125,0)
 D START^ORWRP(80,"EN^MCAPI(GMRCRES,1)")
"RTN","GMRCGUIU",126,0)
 I '$D(^TMP("ORDATA",$J,1)) D  Q
"RTN","GMRCGUIU",127,0)
 . I $D(GMRCAR) S @GMRCAR@(1)="Unable to locate result." Q
"RTN","GMRCGUIU",128,0)
 . I '$D(GMRCAR) S GMRCAR(1)="Unable to locate result."
"RTN","GMRCGUIU",129,0)
 I $D(GMRCAR) M @GMRCAR=^TMP("ORDATA",$J,1)
"RTN","GMRCGUIU",130,0)
 I '$D(GMRCAR) M GMRCAR=^TMP("ORDATA",$J,1)
"RTN","GMRCGUIU",131,0)
 K ^TMP("ORDATA",$J,1)
"RTN","GMRCGUIU",132,0)
 Q
"RTN","GMRCGUIU",133,0)
CANDOMED(GMRCIEN,USER) ;can person associate med results?
"RTN","GMRCGUIU",134,0)
 ; GMRCIEN - ien from file 123
"RTN","GMRCGUIU",135,0)
 N PROC
"RTN","GMRCGUIU",136,0)
 I '$D(^GMR(123,GMRCIEN,0)) Q 0  ;bad record
"RTN","GMRCGUIU",137,0)
 S PROC=+$P(^GMR(123,GMRCIEN,0),U,8) I 'PROC Q 0  ;no procedure
"RTN","GMRCGUIU",138,0)
 I +$G(^GMR(123,GMRCIEN,1)) Q 0  ;med rslts not allowed on CP
"RTN","GMRCGUIU",139,0)
 I '+$P(^GMR(123.3,PROC,0),U,5) Q 0  ;proc not set up
"RTN","GMRCGUIU",140,0)
 Q 1
"RTN","GMRCHL7A")
0^58^B30106209
"RTN","GMRCHL7A",1,0)
GMRCHL7A ;SLC/DCM,MA - Receive HL-7 Message from OERR ;3/7/02 13:20
"RTN","GMRCHL7A",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,15,21,22**;DEC 27, 1997
"RTN","GMRCHL7A",3,0)
 ; This routine invokes IA #2849
"RTN","GMRCHL7A",4,0)
URG(X) ;Return Urgency give Z-code from HL-7 segment; see ORC+9
"RTN","GMRCHL7A",5,0)
 S X=$S(X="S":"STAT",X="R":"ROUTINE",X="ZT":"TODAY",X="Z24":"WITHIN 24 HOURS",X="Z48":"WITHIN 48 HOURS",X="Z72":"WITHIN 72 HOURS",X="ZW":"WITHIN 1 WEEK",X="ZM":"WITHIN 1 MONTH",X="ZNA":"NEXT AVAILABLE",1:X)
"RTN","GMRCHL7A",6,0)
 I $E(X,1)="Z" S X=$S(X="ZT":"TODAY",X="ZE":"EMERGENCY",1:"")
"RTN","GMRCHL7A",7,0)
 Q X
"RTN","GMRCHL7A",8,0)
 ;
"RTN","GMRCHL7A",9,0)
ORC(GMRCORC) ;Get fields from ORC segment and set into GMRC variables
"RTN","GMRCHL7A",10,0)
 ;GMRCTRLC=ORC control code from HL7 Table 119
"RTN","GMRCHL7A",11,0)
 ;GMRCURGI=priority/urgency     GMRCPLCR=who entered the order
"RTN","GMRCHL7A",12,0)
 ;GMRCORNP=provider             GMRCNATO=nature of order
"RTN","GMRCHL7A",13,0)
 ;GMRCAD=date of request        GMRCOCR=order request reason
"RTN","GMRCHL7A",14,0)
 ;GMRCORFN=oe/rr file number    GMRCO=file 123 IEN - if not a new order
"RTN","GMRCHL7A",15,0)
 ;GMRCS38=order status - taken from Table 38, HL7 standard
"RTN","GMRCHL7A",16,0)
 S GMRCTRLC=$P(GMRCORC,SEP1,2),GMRCORFN=$P(GMRCORC,SEP1,3),GMRCORFN=$P($P(GMRCORFN,SEP2,1),";",1),GMRCAPP=$P($P(GMRCORC,SEP1,3),SEP2,2)
"RTN","GMRCHL7A",17,0)
 S GMRCS38=$P(GMRCORC,SEP1,6),GMRCURGI=$P($P(GMRCORC,SEP1,8),SEP2,6),GMRCPLCR=$P(GMRCORC,SEP1,11),GMRCORNP=$P(GMRCORC,SEP1,13)
"RTN","GMRCHL7A",18,0)
 I $L(GMRCURGI) S GMRCURGI="GMRCURGENCY - "_$$URG(GMRCURGI),GMRCURGI=$O(^ORD(101,"B",GMRCURGI,0))
"RTN","GMRCHL7A",19,0)
 S GMRCO=+$P($P(GMRCORC,SEP1,4),SEP2,1)
"RTN","GMRCHL7A",20,0)
 S GMRCODT=$P(GMRCORC,SEP1,16),GMRCAD=$$FMDATE^GMRCHL7(GMRCODT)
"RTN","GMRCHL7A",21,0)
 S GMRCOCR=$P(GMRCORC,SEP1,17),GMRCNATO=$P(GMRCOCR,SEP2,5)
"RTN","GMRCHL7A",22,0)
 Q
"RTN","GMRCHL7A",23,0)
OBR(GMRCOBR) ;Get fields from OBR segment and set into GMRC variables
"RTN","GMRCHL7A",24,0)
 ;GMRCTYPE=GMRC consult or GMRC request  GMRCSS=To Service
"RTN","GMRCHL7A",25,0)
 ;GMRCPLI=place of consultation          GMRCODT=observation date/time
"RTN","GMRCHL7A",26,0)
 ;GMRCATN=person to alert (attention)    GMRCSTDT=status change date/time
"RTN","GMRCHL7A",27,0)
 ;GMRCS123=results status (table 123)    GMRCINTR=results interpreter
"RTN","GMRCHL7A",28,0)
 ;GMRCPRI=procedure from file ^ORD(101,  
"RTN","GMRCHL7A",29,0)
 ;GMRCXMF=foreign consult service
"RTN","GMRCHL7A",30,0)
 ;        a flag that tells the HL7 routine that
"RTN","GMRCHL7A",31,0)
 ;        consults does not need to return CPRS a file
"RTN","GMRCHL7A",32,0)
 ;        IEN for file 123. See routine ^GMRCXMF
"RTN","GMRCHL7A",33,0)
 S GMRCPR=$P($P(GMRCOBR,SEP1,5),SEP2,6)
"RTN","GMRCHL7A",34,0)
 S GMRCTYPE=$S(GMRCPR="99PRC":"P",1:"C")
"RTN","GMRCHL7A",35,0)
 S GMRCPRI="",GMRCSS=""
"RTN","GMRCHL7A",36,0)
 I GMRCPR="99PRC" D
"RTN","GMRCHL7A",37,0)
 . S GMRCPRI=$P($P(GMRCOBR,SEP1,5),SEP2,4)
"RTN","GMRCHL7A",38,0)
 . S GMRCPRI=$S(+GMRCPRI:GMRCPRI_";GMR(123.3,",1:"")
"RTN","GMRCHL7A",39,0)
 . Q
"RTN","GMRCHL7A",40,0)
 ;
"RTN","GMRCHL7A",41,0)
 S GMRCOTXT=$P($P(GMRCOBR,SEP1,5),SEP2,5) ;consult type or service name
"RTN","GMRCHL7A",42,0)
 S GMRCODT=$P(GMRCOBR,SEP1,7) I GMRCODT]"" S GMRCODT=$$FMDATE^GMRCHL7(GMRCODT)
"RTN","GMRCHL7A",43,0)
 S GMRCPLI=$P(GMRCOBR,SEP1,19) I GMRCPLI]"" S GMRCPLI="GMRCPLACE - "_$S(GMRCPLI="OC":"ON CALL",GMRCPLI="B":"BEDSIDE",GMRCPLI="E":"EMERGENCY ROOM",1:GMRCPLI),GMRCPLI=$O(^ORD(101,"B",GMRCPLI,0))
"RTN","GMRCHL7A",44,0)
 S GMRCATN=$P(GMRCOBR,SEP1,20),GMRCSTDT=$P(GMRCOBR,SEP1,23),GMRCSTDT=$$FMDATE^GMRCHL7(GMRCSTDT)
"RTN","GMRCHL7A",45,0)
 S GMRCS123=$P(GMRCOBR,SEP1,26),GMRCINTR=$P(GMRCOBR,SEP1,33)
"RTN","GMRCHL7A",46,0)
 Q
"RTN","GMRCHL7A",47,0)
ZSV(GMRCZSV) ;Get service from ZSV segment and set into GMRCSS
"RTN","GMRCHL7A",48,0)
 S GMRCZSS=$P($P(GMRCZSV,SEP1,2),SEP2,4)
"RTN","GMRCHL7A",49,0)
 I +$G(GMRCZSS) S GMRCSS=+$G(GMRCZSS) ;Set the service if ZSV provided
"RTN","GMRCHL7A",50,0)
 I $L($P(GMRCZSV,"|",3)) S GMRCOTXT=$P(GMRCZSV,"|",3) ;consult type
"RTN","GMRCHL7A",51,0)
 Q
"RTN","GMRCHL7A",52,0)
OBX(GMRCOBX) ;Get fields from OBX segment and set into GMRC variables
"RTN","GMRCHL7A",53,0)
 ;GMRCVTYP=Value type from table 123 - i.e. TX(text), ST(string data),etc.
"RTN","GMRCHL7A",54,0)
 ;GMRCOID=observation id identifying value in seg. 5
"RTN","GMRCHL7A",55,0)
 ;GMRCVAL=observation value coded by segment 3
"RTN","GMRCHL7A",56,0)
 ;GMRCPRDG=provisional diagnosis
"RTN","GMRCHL7A",57,0)
 ;    free text or code^free text^I9C
"RTN","GMRCHL7A",58,0)
 S GMRCMSG=MSG(GMRCOBX)
"RTN","GMRCHL7A",59,0)
 S GMRCVTYP=$P(GMRCMSG,SEP1,3),GMRCOID=$P($P(GMRCMSG,SEP1,4),SEP2,2),GMRCVAL=$P(GMRCOID,SEP2,3)
"RTN","GMRCHL7A",60,0)
 I GMRCOID="REASON FOR REQUEST" D
"RTN","GMRCHL7A",61,0)
 .S GMRCRFQ(1)=$P(GMRCMSG,SEP1,6)
"RTN","GMRCHL7A",62,0)
 .S LN=0 F  S LN=$O(MSG(GMRCOBX,LN)) Q:LN=""  S GMRCRFQ(LN+1)=MSG(GMRCOBX,LN)
"RTN","GMRCHL7A",63,0)
 .Q
"RTN","GMRCHL7A",64,0)
 I GMRCOID="PROVISIONAL DIAGNOSIS" D  Q
"RTN","GMRCHL7A",65,0)
 . I GMRCVTYP="TX" S GMRCPRDG=$P(GMRCMSG,SEP1,6) Q
"RTN","GMRCHL7A",66,0)
 . I GMRCVTYP="CE" D  Q
"RTN","GMRCHL7A",67,0)
 .. N PRDXSEG S PRDXSEG=$P(GMRCMSG,SEP1,6)
"RTN","GMRCHL7A",68,0)
 .. S GMRCPRDG=$P(PRDXSEG,"^",2)_" ("_$P(PRDXSEG,"^")_")"
"RTN","GMRCHL7A",69,0)
 .. S GMRCPRCD=$P(PRDXSEG,"^")
"RTN","GMRCHL7A",70,0)
 I GMRCOID["COMMENT" D
"RTN","GMRCHL7A",71,0)
 .S GMRCCMT(1)=$P(GMRCMSG,SEP1,6)
"RTN","GMRCHL7A",72,0)
 .S LN=0 F  S LN=$O(MSG(GMRCOBX,LN)) Q:LN=""  S GMRCCMT(LN+1)=MSG(GMRCOBX,LN)
"RTN","GMRCHL7A",73,0)
 .Q
"RTN","GMRCHL7A",74,0)
 K LN
"RTN","GMRCHL7A",75,0)
 Q
"RTN","GMRCHL7A",76,0)
EN(MSG) ;Entry point to routine
"RTN","GMRCHL7A",77,0)
 ;MSG = local array which contains the HL-7 segments
"RTN","GMRCHL7A",78,0)
 ;GMRCSEND=sending application   GMRCFAC=sending facility
"RTN","GMRCHL7A",79,0)
 ;GMRCMTP=message type
"RTN","GMRCHL7A",80,0)
 N DFN,GMRCACT,GMRCADD,GMRCFAC,GMRCMTP,GMRCPNM,GMRCO,GMRCOCR,GMRCORNP
"RTN","GMRCHL7A",81,0)
 N GMRCORFN,GMRCPLCR,GMRCRB,GMRCSEND,GMRCSTS,GMRCTRLC,GMRCWARD,ORIFN
"RTN","GMRCHL7A",82,0)
 N GMRCTRLC,GMRCAD,ORC,GMRCSBR,GMRCZSS,GMRCSS,GMRCOTXT,GMRCPRCD,GMRCRECV
"RTN","GMRCHL7A",83,0)
 S GMRCMSG="",GMRCNOD=0 F  S GMRCNOD=$O(MSG(GMRCNOD)) Q:GMRCNOD=""  S GMRCMSG=MSG(GMRCNOD) I $E(GMRCMSG,1,3)="MSH" D INIT^GMRCHL7U(GMRCMSG) D  Q
"RTN","GMRCHL7A",84,0)
 .S GMRCSEND=$P(GMRCMSG,SEP1,3),GMRCFAC=$P(GMRCMSG,SEP1,4)
"RTN","GMRCHL7A",85,0)
 .S GMRCMTP=$P(GMRCMSG,SEP1,9),GMRCRECV=$P(GMRCMSG,SEP1,5)
"RTN","GMRCHL7A",86,0)
 .Q
"RTN","GMRCHL7A",87,0)
 I $G(GMRCRECV)'="CONSULTS" Q  ;not intended for Consults
"RTN","GMRCHL7A",88,0)
 S GMRCMSG="",GMRCNOD=0
"RTN","GMRCHL7A",89,0)
 F  S GMRCNOD=$O(MSG(GMRCNOD)) Q:GMRCNOD=""  S GMRCMSG=MSG(GMRCNOD) D
"RTN","GMRCHL7A",90,0)
 .I $E(GMRCMSG,1,3)="PID" D PID^GMRCHL7U(GMRCMSG) Q
"RTN","GMRCHL7A",91,0)
 .I $E(GMRCMSG,1,3)="PV1" D PV1^GMRCHL7U(GMRCMSG) Q
"RTN","GMRCHL7A",92,0)
 .I $E(GMRCMSG,1,3)="ORC" D ORC(GMRCMSG) Q
"RTN","GMRCHL7A",93,0)
 .I $E(GMRCMSG,1,3)="OBR" D OBR(GMRCMSG) Q
"RTN","GMRCHL7A",94,0)
 .I $E(GMRCMSG,1,3)="ZSV" D ZSV(GMRCMSG) Q
"RTN","GMRCHL7A",95,0)
 .I $E(GMRCMSG,1,3)="OBX" D OBX(GMRCNOD) Q
"RTN","GMRCHL7A",96,0)
 .I $E(GMRCMSG,1,3)="NTE" D NTE^GMRCHL7U(.MSG,GMRCNOD,GMRCO,GMRCTRLC) Q
"RTN","GMRCHL7A",97,0)
 .I $E(GMRCMSG,1,3)="ZXX" S GMRCOFN=+$P(GMRCMSG,SEP1,2) K MSG(GMRCNOD) Q 
"RTN","GMRCHL7A",98,0)
 .Q
"RTN","GMRCHL7A",99,0)
 ;Note, ZXX is not used yet; planned for future sharing consults with foreign facilities.
"RTN","GMRCHL7A",100,0)
 I '$D(GMRCTRLC) D EXIT^GMRCHL7U Q
"RTN","GMRCHL7A",101,0)
 I GMRCTRLC="Z@" D CPRSPURG^GMRCPURG(+GMRCO),EXIT^GMRCHL7U Q
"RTN","GMRCHL7A",102,0)
 I GMRCTRLC="NW" D NEW^GMRCHL7B D
"RTN","GMRCHL7A",103,0)
 . I $G(GMRCO) D RETURN^GMRCHL7U(GMRCO,GMRCTRLC) Q
"RTN","GMRCHL7A",104,0)
 . D REJECT^GMRCHL7U(.MSG,"unable to file order")
"RTN","GMRCHL7A",105,0)
 I $D(GMRCXMF) D
"RTN","GMRCHL7A",106,0)
 .;Set GMRCO=to the file number at this site for a new consult/request before sending HL-7 message to CPRS
"RTN","GMRCHL7A",107,0)
 .S GMRCNOD=0 F  S GMRCNOD=$O(@GMRCMSG(ND)) Q:GMRCNOD=""  I $P(@(GMRCMSG(GMRCNOD)),"|",1)="ORC" S $P(@(GMRCMSG(GMRCNOD)),"|",3)=$G(GMRCO) Q
"RTN","GMRCHL7A",108,0)
 .Q
"RTN","GMRCHL7A",109,0)
 I '$D(GMRCO) D EXIT^GMRCHL7U Q
"RTN","GMRCHL7A",110,0)
 I $S(GMRCTRLC="CA":1,GMRCTRLC="DC":1,1:0) D DC^GMRCHL7B(GMRCO,GMRCTRLC),RETURN^GMRCHL7U(GMRCO,GMRCTRLC)
"RTN","GMRCHL7A",111,0)
 I GMRCTRLC="NA" D RTN(GMRCORFN,GMRCO)
"RTN","GMRCHL7A",112,0)
 I GMRCTRLC="XX" D MODIFY^GMRCHL7B ;Not currently returned by CPRS
"RTN","GMRCHL7A",113,0)
 ; If consults sends an XX, CPRS returns an NA.
"RTN","GMRCHL7A",114,0)
 D EXIT^GMRCHL7U
"RTN","GMRCHL7A",115,0)
 Q
"RTN","GMRCHL7A",116,0)
RTN(GMRCORN,DA) ;Put ^OR(100, ien for order into ^GMR(123, 
"RTN","GMRCHL7A",117,0)
 S DIE="^GMR(123,",DR=".03////^S X=GMRCORN"
"RTN","GMRCHL7A",118,0)
 L +^GMR(123,DA) D ^DIE L -^GMR(123,DA)
"RTN","GMRCHL7A",119,0)
 K DIE,DR
"RTN","GMRCHL7A",120,0)
 Q
"RTN","GMRCHL7B")
0^26^B22430425
"RTN","GMRCHL7B",1,0)
GMRCHL7B ;SLC/DCM,MA - Process order parameters from ^GMRCHL7A and place data into ^GMR(123 global ;10/17/01 17:18
"RTN","GMRCHL7B",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,21,17,22**;DEC 27, 1997
"RTN","GMRCHL7B",3,0)
 ; Patch #21 changed Activity title on Consult detail display
"RTN","GMRCHL7B",4,0)
 ; from "ENTERED IN CPRS" to "CPRS RELEASED ORDER".
"RTN","GMRCHL7B",5,0)
NEW ;Add new order
"RTN","GMRCHL7B",6,0)
 ;GMRCO=^GMR(123,IFN, the new file number in file ^GMR(123,
"RTN","GMRCHL7B",7,0)
 ;GMRCORFN=OE/RR file number       GMRCWARD=ward patient is on
"RTN","GMRCHL7B",8,0)
 ;GMRCSS=service consult sent to   GMRCAD=date/time of request
"RTN","GMRCHL7B",9,0)
 ;GMRCPRI=procedure/request        GMRCURGI=urgency
"RTN","GMRCHL7B",10,0)
 ;GMRCATN=attention                GMRCSTS=OE/RR order status
"RTN","GMRCHL7B",11,0)
 ;GMRCORNP=patient's provider      GMRCTYPE=request type (request or consult)
"RTN","GMRCHL7B",12,0)
 ;GMRCSBR=service rendered on what basis (Inpatient, or Outpatient)
"RTN","GMRCHL7B",13,0)
 ;GMRCRFQ=reason for request array - word processing fields
"RTN","GMRCHL7B",14,0)
 ;GMRCOTXT=order display text from dialog or orderable item
"RTN","GMRCHL7B",15,0)
 ;GMRCPRDG=provisional DX
"RTN","GMRCHL7B",16,0)
 ;GMRCPRCD=provisional DX code 
"RTN","GMRCHL7B",17,0)
 N DIC,DLAYGO,X,DR,DIE,GMRCADUZ,GMRCCP
"RTN","GMRCHL7B",18,0)
 S DIC="^GMR(123,",DIC(0)="L",X="""N""",DLAYGO=123 D ^DIC K DLAYGO Q:Y<1
"RTN","GMRCHL7B",19,0)
 ; Patch #21 changed GMRCA=1 to GMRCA=2
"RTN","GMRCHL7B",20,0)
 S (DA,GMRCO)=+Y,GMRCSTS=5,GMRCA=2,DIE=DIC
"RTN","GMRCHL7B",21,0)
 L +^GMR(123,GMRCO)
"RTN","GMRCHL7B",22,0)
 S DR=".02////^S X=DFN;.03////^S X=GMRCORFN;.04////^S X=GMRCWARD;.05////^S X=GMRCFAC;.06////^S X=$G(GMRCOFN);1////^S X=GMRCSS;2////^S X=$G(GMRCWARD);3////^S X=GMRCAD;4////^S X=GMRCPRI;5////^S X=GMRCURGI;7////^S X=$G(GMRCATN)"
"RTN","GMRCHL7B",23,0)
 D ^DIE
"RTN","GMRCHL7B",24,0)
 I GMRCOTXT=$$GET1^DIQ(123.5,+GMRCSS,.01) S GMRCOTXT=""
"RTN","GMRCHL7B",25,0)
 ;Added new field .1 to DR on 7/11/98 to save the order text
"RTN","GMRCHL7B",26,0)
 S DR="6////^S X=GMRCPLI;8////^S X=GMRCSTS;9////^S X=GMRCA;10////^S X=GMRCORNP;13////^S X=GMRCTYPE;14////^S X=$G(GMRCSBR);30////^S X=$G(GMRCPRDG);.1////^S X=$G(GMRCOTXT)"
"RTN","GMRCHL7B",27,0)
 I $D(GMRCPRCD) S DR=DR_";30.1///^S X=GMRCPRCD"
"RTN","GMRCHL7B",28,0)
 S GMRCCP=$P($G(^GMR(123.3,+GMRCPRI,0)),U,4) I GMRCCP D  ;file CP 
"RTN","GMRCHL7B",29,0)
 . S DR=DR_";1.01///^S X=GMRCCP"
"RTN","GMRCHL7B",30,0)
 D  ;check to see if an IFC and add .07 ROUTING FACILITY
"RTN","GMRCHL7B",31,0)
 . I $G(GMRCPRI) D  Q  ;see if procedure is mapped
"RTN","GMRCHL7B",32,0)
 .. I '$D(^GMR(123.3,+GMRCPRI,"IFC")) Q
"RTN","GMRCHL7B",33,0)
 .. N IFC S IFC=$G(^GMR(123.3,+GMRCPRI,"IFC"))
"RTN","GMRCHL7B",34,0)
 .. I '+IFC Q  ; no ifc routing site
"RTN","GMRCHL7B",35,0)
 .. I '$L($P(^GMR(123.3,+GMRCPRI,"IFC"),U,2)) Q  ;no remote proc name
"RTN","GMRCHL7B",36,0)
 .. S DR=DR_";.07////"_+IFC_";.125////P"
"RTN","GMRCHL7B",37,0)
 . I '$G(GMRCPRI) D  Q  ;see if service is mapped
"RTN","GMRCHL7B",38,0)
 .. I '$D(^GMR(123.5,+GMRCSS,"IFC")) Q
"RTN","GMRCHL7B",39,0)
 .. N IFC S IFC=$G(^GMR(123.5,+GMRCSS,"IFC"))
"RTN","GMRCHL7B",40,0)
 .. I '+IFC Q  ; no ifc routing site
"RTN","GMRCHL7B",41,0)
 .. I '$L($P(IFC,U,2)) Q  ;no remote service name
"RTN","GMRCHL7B",42,0)
 .. S DR=DR_";.07////"_+IFC_";.125////P;.131////"_$P(IFC,U,2)
"RTN","GMRCHL7B",43,0)
 . Q
"RTN","GMRCHL7B",44,0)
 D ^DIE
"RTN","GMRCHL7B",45,0)
 I $O(GMRCRFQ(0)) D REASON
"RTN","GMRCHL7B",46,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCHL7B",47,0)
 S GMRCA=1 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",48,0)
 I $D(GMRCXMF),$D(GMRCOFN) S $P(^GMR(123,GMRCO,0),"^",21)=GMRCOFN
"RTN","GMRCHL7B",49,0)
 I $D(GMRCACTN) S GMRCADUZ(GMRCACTN)=""
"RTN","GMRCHL7B",50,0)
 D ALERT^GMRCHL7U(DFN,GMRCSS,GMRCPRI,GMRCO,GMRCURGI,"")
"RTN","GMRCHL7B",51,0)
 D PRNT^GMRCUTL1(GMRCSS,GMRCO) ;contains print audit update
"RTN","GMRCHL7B",52,0)
 D EXIT
"RTN","GMRCHL7B",53,0)
 Q
"RTN","GMRCHL7B",54,0)
DC(GMRCO,ACTRL) ;Discontinue request from OERR
"RTN","GMRCHL7B",55,0)
 ;Denied request also gets this action. Deny request updates status to dc
"RTN","GMRCHL7B",56,0)
 ;GMRCO=IEN of record in file ^GMR(123, i.e., ^GMR(123,DA,
"RTN","GMRCHL7B",57,0)
 ;ACTRL=GMRCCTRL=control code defining action -
"RTN","GMRCHL7B",58,0)
 ;         DC control code = action DC for discontinued 
"RTN","GMRCHL7B",59,0)
 ;         CA control code = action DY for denied
"RTN","GMRCHL7B",60,0)
 ;Update the last action taken, order status, and processing activity
"RTN","GMRCHL7B",61,0)
 Q:'$L(GMRCO)
"RTN","GMRCHL7B",62,0)
 N GMRCACT,GMRCSVC,GMRCDFN,GMRCFL,GMRCADUZ,GMRCRQR,DA
"RTN","GMRCHL7B",63,0)
 S GMRCACT=$O(^GMR(123.1,"D",ACTRL,0))
"RTN","GMRCHL7B",64,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",65,0)
 S DIE="^GMR(123,",DA=GMRCO
"RTN","GMRCHL7B",66,0)
 S DR="8////^S X=GMRCSTS;9////^S X=GMRCACT" ; upd status + last action
"RTN","GMRCHL7B",67,0)
 D ^DIE
"RTN","GMRCHL7B",68,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",69,0)
 ; send 513 back through service printer if order DC'd
"RTN","GMRCHL7B",70,0)
 I $G(ACTRL)="DC",$$DCPRNT^GMRCUTL1(GMRCO,DUZ) D
"RTN","GMRCHL7B",71,0)
 . D PRNT^GMRCUTL1(+$P(^GMR(123,GMRCO,0),U,5),GMRCO)
"RTN","GMRCHL7B",72,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCHL7B",73,0)
 S GMRCFL=$$DCNOTE^GMRCADC(GMRCO,DUZ),GMRCADUZ=""
"RTN","GMRCHL7B",74,0)
 S GMRCRQR=+$P($G(^GMR(123,+GMRCO,0)),"^",14)
"RTN","GMRCHL7B",75,0)
 I +GMRCRQR,GMRCRQR'=DUZ S GMRCADUZ(GMRCRQR)=""
"RTN","GMRCHL7B",76,0)
 S GMRCSVC=$P($G(^GMR(123,+GMRCO,0)),"^",5)
"RTN","GMRCHL7B",77,0)
 I +GMRCSVC S GMRCSVC=$S($D(^GMR(123.5,GMRCSVC,.1)):^(.1),1:$P(^GMR(123.5,GMRCSVC,0),"^",1))
"RTN","GMRCHL7B",78,0)
 E  S GMRCSVC="Unknown Service: Consult # "_GMRCO
"RTN","GMRCHL7B",79,0)
 S GMRCORTX=$S(ACTRL="DC":"Discontinued",1:"Cancelled")
"RTN","GMRCHL7B",80,0)
 S GMRCORTX=GMRCORTX_" Consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCHL7B",81,0)
 N NOTYPE S NOTYPE=$S(ACTRL="DC":23,1:30)
"RTN","GMRCHL7B",82,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,NOTYPE,.GMRCADUZ,GMRCFL)
"RTN","GMRCHL7B",83,0)
 D EXIT
"RTN","GMRCHL7B",84,0)
 Q
"RTN","GMRCHL7B",85,0)
MODIFY ;Change an order/request when an HL7 'XX' code is received
"RTN","GMRCHL7B",86,0)
 ;This is currently not used.
"RTN","GMRCHL7B",87,0)
 ;    When Consults sends an XX, CPRS returns NA with a new order ien.
"RTN","GMRCHL7B",88,0)
 ;GMRCACT=processing activity - from file ^GMR(123.1,
"RTN","GMRCHL7B",89,0)
 S DIE="^GMR(123,",DA=+GMRCO
"RTN","GMRCHL7B",90,0)
 S GMRCWARD=$G(GMRCWARD),GMRCPRI=$G(GMRCPRI),GMRCURGI=$G(GMRCURGI),GMRCSTS=$G(GMRCSTS),GMRCTYPE=$G(GMRCTYPE),GMRCSS=$G(GMRCSS)
"RTN","GMRCHL7B",91,0)
 S GMRCACT=$O(^GMR(123.1,"D",GMRCTRLC,0))
"RTN","GMRCHL7B",92,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",93,0)
 S DIE=123,DR=".04////^S X=$G(GMRCWARD);1////^S X=$G(GMRCSS);4////^S X=$G(GMRCPRI);5////^S X=$G(GMRCURGI);8////^S X=$G(GMRCSTS);9////^S X=GMRCACT"
"RTN","GMRCHL7B",94,0)
 D ^DIE
"RTN","GMRCHL7B",95,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",96,0)
 D EXIT Q
"RTN","GMRCHL7B",97,0)
REASON ;load the reason for request into ^GMR(123,IFN,20
"RTN","GMRCHL7B",98,0)
 S ^GMR(123,GMRCO,20,0)="^^^"_$S($D(GMRCDA):GMRCDA,1:DT)_"^"
"RTN","GMRCHL7B",99,0)
 S L=0,LN=1 F  S L=$O(GMRCRFQ(L)) Q:L=""  S ^GMR(123,GMRCO,20,LN,0)=GMRCRFQ(L),LN=LN+1
"RTN","GMRCHL7B",100,0)
 S LN=LN-1,$P(^GMR(123,GMRCO,20,0),"^",3)=LN
"RTN","GMRCHL7B",101,0)
 K L,LN
"RTN","GMRCHL7B",102,0)
 Q
"RTN","GMRCHL7B",103,0)
COMMENT(GMRCARY) ;add comments to the record.  Add the comment header, then the comment lines, and lastly, the number of comment lines to the header
"RTN","GMRCHL7B",104,0)
 ;GMRCARY= GMRCNTC array
"RTN","GMRCHL7B",105,0)
 S LN=0,^GMR(123,GMRCO,40,DA,1,0)="^^^^"_$P(GMRCDA,".",1)_"^"
"RTN","GMRCHL7B",106,0)
 F  S LN=$O(GMRCARY(LN)) Q:LN=""  S ^GMR(123,+GMRCO,40,DA,1,LN,0)=GMRCARY(LN),LN1=LN
"RTN","GMRCHL7B",107,0)
 S $P(^GMR(123,+GMRCO,40,DA,1,0),"^",3,4)=LN1_"^"_LN1
"RTN","GMRCHL7B",108,0)
 K LN,LN1 Q
"RTN","GMRCHL7B",109,0)
 Q
"RTN","GMRCHL7B",110,0)
EXIT ;kill off all variables
"RTN","GMRCHL7B",111,0)
 K DA,DIC,DIE,DR,GMRCORTX,GMRCADUZ
"RTN","GMRCHL7B",112,0)
 Q
"RTN","GMRCHL7U")
0^25^B23953120
"RTN","GMRCHL7U",1,0)
GMRCHL7U ;SLC/DCM,MA - Utilities associated with HL7 messages ;10/18/01 17:18
"RTN","GMRCHL7U",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,12,21,22**;DEC 27, 1997
"RTN","GMRCHL7U",3,0)
 ; Patch #21 added more variables to in line tage EXIT.
"RTN","GMRCHL7U",4,0)
INIT(MSH) ;break out MSH segment separators and set other neeed variables
"RTN","GMRCHL7U",5,0)
 ;MSH = MSH segment of the HL-7 message
"RTN","GMRCHL7U",6,0)
 N X
"RTN","GMRCHL7U",7,0)
 S (SEP1,SEP2,SEP3,SEP4,SEP5)=""
"RTN","GMRCHL7U",8,0)
 S SEP1=$E(MSH,4),X=$P(MSH,SEP1,2)
"RTN","GMRCHL7U",9,0)
 S SEP2=$E(X,1),SEP3=$E(X,2),SEP4=$E(X,3),SEP5=$E(X,4)
"RTN","GMRCHL7U",10,0)
 Q
"RTN","GMRCHL7U",11,0)
PID(GMRCPID) ;Get fields from PID segment and set into GMRC variables.
"RTN","GMRCHL7U",12,0)
 S DFN=$P(GMRCPID,SEP1,4),GMRCPNM=$P(GMRCPID,SEP1,6)
"RTN","GMRCHL7U",13,0)
 Q
"RTN","GMRCHL7U",14,0)
NTE(MSG,GMRCNTE,GMRCNODE,CTRLCODE) ;set NTE segments of HL-7 message into variables and globals
"RTN","GMRCHL7U",15,0)
 ;MSG = whole HL-7 array.
"RTN","GMRCHL7U",16,0)
 ;GMRCNTE = Node in array where NTE message begins
"RTN","GMRCHL7U",17,0)
 ;CTRLCODE = segment 1 of the ORC segment of HL-7 message
"RTN","GMRCHL7U",18,0)
 ;GMRCNODE = IEN of entry int file ^GMR(123,
"RTN","GMRCHL7U",19,0)
 N GMRCACT ;not sure why this is newed here
"RTN","GMRCHL7U",20,0)
 S GMRCAD=$G(GMRCAD),GMRCORNP=$G(GMRCORNP),GMRCFF=$G(GMRCFF),GMRCPA=$G(GMRCPA),GMRCDEV=$G(GMRCDEV)
"RTN","GMRCHL7U",21,0)
 S GMRCACT=$S(CTRLCODE="CA":19,CTRLCODE="DC":6,CTRLCODE="NW":1,1:$O(^GMR(123.1,"D",CTRLCODE,0)))
"RTN","GMRCHL7U",22,0)
 S GMRCNTC(1)=$P(MSG(GMRCNTE),SEP1,4)
"RTN","GMRCHL7U",23,0)
 S LN=0,LN1=2 F  S LN=$O(MSG(GMRCNTE,LN)) Q:LN=""  S GMRCNTC(LN1)=MSG(GMRCNTE,LN),LN1=LN1+1
"RTN","GMRCHL7U",24,0)
 K LN,LN1
"RTN","GMRCHL7U",25,0)
 Q
"RTN","GMRCHL7U",26,0)
PV1(GMRCPV1) ;Get fields from PV1 segment of HL-7 message and set into GMRC variables
"RTN","GMRCHL7U",27,0)
 ;GMRCRB  = patients room/bed            GMRCWARD=patients ward
"RTN","GMRCHL7U",28,0)
 ;GMRCSBR = service basis to be rendered (Inpatient or Outpatient)
"RTN","GMRCHL7U",29,0)
 N X
"RTN","GMRCHL7U",30,0)
 S X=$P(GMRCPV1,SEP1,3),GMRCSBR=$S(X]"":X,1:"")
"RTN","GMRCHL7U",31,0)
 S X=$P(GMRCPV1,SEP1,4),GMRCWARD=$S($P(X,SEP2,1)]"":$P(X,SEP2,1),1:""),VISIT=$S($P(GMRCPV1,SEP1,20)]"":$P(GMRCPV1,SEP1,20),1:"")
"RTN","GMRCHL7U",32,0)
 S GMRCRB=$S($P(X,SEP2,2)]"":$P(X,SEP2,2),1:"")
"RTN","GMRCHL7U",33,0)
 S:VISIT]"" GMRCVSIT=$$FMDATE^GMRCHL7(VISIT)
"RTN","GMRCHL7U",34,0)
 Q
"RTN","GMRCHL7U",35,0)
 ;
"RTN","GMRCHL7U",36,0)
REJECT(GMRCMSG,REAS) ;action can't be filed send reject message
"RTN","GMRCHL7U",37,0)
 ; Does anyone know why this section has been commented out
"RTN","GMRCHL7U",38,0)
 ; so the new on GMRCMESS is not done or DO MSG^XQOR?
"RTN","GMRCHL7U",39,0)
 N MSH,ORC,I ;GMRCMESS
"RTN","GMRCHL7U",40,0)
 S I=0 F  S I=$O(GMRCMSG(I)) Q:'I  D
"RTN","GMRCHL7U",41,0)
 . I $P(GMRCMSG(I),"|")="PID" S PID=GMRCMSG(I)
"RTN","GMRCHL7U",42,0)
 . I $P(GMRCMSG(I),"|")="ORC" D
"RTN","GMRCHL7U",43,0)
 .. N ORFN,GMRCFN,P17,CTRLCD
"RTN","GMRCHL7U",44,0)
 .. S ORFN=$P(GMRCMSG(I),"|",3),GMRCFN=$P(GMRCMSG(I),"|",4)
"RTN","GMRCHL7U",45,0)
 .. S CTRLCD=$P(GMRCMSG(I),"|",2)
"RTN","GMRCHL7U",46,0)
 .. S ORC="ORC|"_$S(CTRLCD="NW":"UA",1:"UD")_"|"_ORFN_"|"_GMRCFN
"RTN","GMRCHL7U",47,0)
 .. S P17=$S($D(REAS):REAS,1:"UNABLE TO FILE ACTION")
"RTN","GMRCHL7U",48,0)
 .. S $P(ORC,"|",17)="X^REJECTED^99ORN^^"_P17
"RTN","GMRCHL7U",49,0)
 S MSH=$$MSH^GMRCHL7
"RTN","GMRCHL7U",50,0)
 S $P(MSH,SEP1,9)="ORR"
"RTN","GMRCHL7U",51,0)
 S GMRCMESS(1)=MSH
"RTN","GMRCHL7U",52,0)
 S GMRCMESS(2)=PID
"RTN","GMRCHL7U",53,0)
 S GMRCMESS(3)=ORC
"RTN","GMRCHL7U",54,0)
 ;D MSG^XQOR("GMRC EVSEND OR",.GMRCMESS)
"RTN","GMRCHL7U",55,0)
 Q
"RTN","GMRCHL7U",56,0)
 ;
"RTN","GMRCHL7U",57,0)
RETURN(GMRCIEN,GMRCTRLC) ;return IEN of record in ^GMR(123,IEN, to OERR
"RTN","GMRCHL7U",58,0)
 ;GMRCIEN = internal record number of record in ^GMR(123,
"RTN","GMRCHL7U",59,0)
 ;GMRCTRLC=Control code from HL-7 Table 119
"RTN","GMRCHL7U",60,0)
 N MSH,PID,ORC,GMRCORCC
"RTN","GMRCHL7U",61,0)
 S SEP1="|",GMRCORCC=$S(GMRCTRLC="NW":"OK",GMRCTRLC="DC":"DR",1:"OK")
"RTN","GMRCHL7U",62,0)
 S MSH=$$MSH^GMRCHL7($G(X)) S $P(MSH,SEP1,9)="ORR"
"RTN","GMRCHL7U",63,0)
 S PID=$$PID^GMRCHL7(GMRCIEN)
"RTN","GMRCHL7U",64,0)
 D ORC^GMRCHL7(GMRCIEN,GMRCORCC,"") S ORC=$P(ORC,"|",1,4)
"RTN","GMRCHL7U",65,0)
 D BLD^GMRCHL7(MSH,PID,"",ORC,"","",,"",GMRCTRLC)
"RTN","GMRCHL7U",66,0)
 D MSG^XQOR("GMRC EVSEND OR",.GMRCMSG)
"RTN","GMRCHL7U",67,0)
 Q
"RTN","GMRCHL7U",68,0)
FILE(GMRCO,DR) ;File data into ^GMR(123,IEN,40 using ^DIE
"RTN","GMRCHL7U",69,0)
 N DIE,DA,GMRCACTI
"RTN","GMRCHL7U",70,0)
 ;GMRCO = IEN of record from file ^GMR(123,
"RTN","GMRCHL7U",71,0)
 ;DR = DR string required by ^DIE
"RTN","GMRCHL7U",72,0)
 L +^GMR(123,+GMRCO,40) S:'$D(^GMR(123,+GMRCO,40,0)) ^(0)="^123.02DA^^"
"RTN","GMRCHL7U",73,0)
 S (DA,GMRCACTI)=$S($P(^GMR(123,+GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1),DA(1)=+GMRCO
"RTN","GMRCHL7U",74,0)
 S DIE="^GMR(123,"_GMRCO_",40,"
"RTN","GMRCHL7U",75,0)
 S $P(^GMR(123,+GMRCO,40,0),"^",3,4)=DA_"^"_DA
"RTN","GMRCHL7U",76,0)
 D ^DIE
"RTN","GMRCHL7U",77,0)
 I $D(GMRCNTC) D COMMENT^GMRCHL7B(.GMRCNTC)
"RTN","GMRCHL7U",78,0)
 I $D(GMRCCMT) D COMMENT^GMRCHL7B(.GMRCCMT)
"RTN","GMRCHL7U",79,0)
 D  ; if record is an IFC build and send update
"RTN","GMRCHL7U",80,0)
 . I '$D(^GMR(123,GMRCO,12)) Q
"RTN","GMRCHL7U",81,0)
 . D TRIGR^GMRCIEVT(GMRCO,GMRCACTI)
"RTN","GMRCHL7U",82,0)
 L -^GMR(123,+GMRCO,40)
"RTN","GMRCHL7U",83,0)
 Q
"RTN","GMRCHL7U",84,0)
EXIT ;Kill variables and exit
"RTN","GMRCHL7U",85,0)
 K HLQ,J,LN,ND,ND1,ND2,SEP1,SEP2,SEP3,SEP4,SEP5
"RTN","GMRCHL7U",86,0)
 K GMRCA,GMRCACT,GMRCAD,GMRCAP,GMRCAPP,GMRCATN,GMRCDA,GMRCDEV,GMRCFAC,GMRCFF,GMRCINTR,GMRCMTP,GMRCMSG,GMRCMSH,GMRCNOD,GMRCNTC,GMRCODT,GMRCOID,GMRCORFN,GMRCPA,GMRCPLCR,GMRCPLI,GMRCPNM,GMRCPR,GMRCPRI,GMRCFQ
"RTN","GMRCHL7U",87,0)
 K GMRCPRDG,GMRCSEND,GMRCSTDT,GMRCSTS,GMRCURGI,GMRCVAL,GMRCVTYP,GMRCWARD,GMRCPRV,GMRCTYPE,GMRCND,GMRCND1,VISIT
"RTN","GMRCHL7U",88,0)
 K GMRCRB,GMRCPRA,GMRCRFQ,MSH,OBXND,PID,GMRCORPV,GMRCOTXT,GMRCNATO
"RTN","GMRCHL7U",89,0)
 K GMRCOFN,GMRCS123,GMRCS38,GMRCCMT
"RTN","GMRCHL7U",90,0)
 K:'$D(GMRCXMF) GMRCTRLC,GMRCSS,GMRCO,GMRCORNP
"RTN","GMRCHL7U",91,0)
 Q
"RTN","GMRCHL7U",92,0)
AUDIT0 ;place activity audit tracking info into global ^GMR(123,IEN,40,
"RTN","GMRCHL7U",93,0)
 ;GMRCACT=processing activity (from ^GMR(123.1,
"RTN","GMRCHL7U",94,0)
 ;GMRCDA=date/time file entered     GMRCAD=date/time activity took place
"RTN","GMRCHL7U",95,0)
 ;GMRCORNP=name of provider         GMRCFF=forwared from (if forwarded)
"RTN","GMRCHL7U",96,0)
 ;GMRCPA=provider previously assigned
"RTN","GMRCHL7U",97,0)
 ;GMRCDEV=device printed to        GMRCCMT=comment array from OBX segment
"RTN","GMRCHL7U",98,0)
 N GMRCDA
"RTN","GMRCHL7U",99,0)
 S X="NOW" D NOW^%DTC S GMRCDA=%
"RTN","GMRCHL7U",100,0)
 L +^GMR(123,+GMRCO,40) S:'$D(^GMR(123,+GMRCO,40,0)) ^GMR(123,+GMRCO,40,0)="^123.02DA^^"
"RTN","GMRCHL7U",101,0)
 S GMRCAD=$S($D(GMRCAD):GMRCAD,1:GMRCDA),GMRCORNP=$G(GMRCORNP),GMRCFF=$G(GMRCFF),GMRCPA=$G(GMRCPA),GMRCDEV=$G(GMRCDEV),GMRCPLCR=$G(GMRCPLCR)
"RTN","GMRCHL7U",102,0)
 ;Use the Control code from CPRS in 123.1 to determine the action.
"RTN","GMRCHL7U",103,0)
 ;If action undefined, then use "ADDED COMMENT", entry 20.
"RTN","GMRCHL7U",104,0)
 S GMRCACT=$O(^GMR(123.1,"D",GMRCTRLC,0))
"RTN","GMRCHL7U",105,0)
 S:'GMRCACT GMRCACT=20
"RTN","GMRCHL7U",106,0)
 S DR=".01////^S X=GMRCDA;1////^S X=GMRCACT;2////^S X=GMRCAD;3////^S X=GMRCORNP;4////^S X=GMRCPLCR;6////^S X=GMRCFF;7////^S X=GMRCPA;8////^S X=GMRCDEV"
"RTN","GMRCHL7U",107,0)
 D FILE(GMRCO,DR)
"RTN","GMRCHL7U",108,0)
 L -^GMR(123,+GMRCO,40)
"RTN","GMRCHL7U",109,0)
 Q
"RTN","GMRCHL7U",110,0)
ALERT(GMRCDFN,GMRCSS,GMRCPR,GMRCFN,GMRCURG,GMRCORA) ;generate an alert when receiving a consult
"RTN","GMRCHL7U",111,0)
 ;GMRCDFN=patient DFN from file 2
"RTN","GMRCHL7U",112,0)
 ;GMRCSS=Service
"RTN","GMRCHL7U",113,0)
 ;GMRCPR=procedure being ordered
"RTN","GMRCHL7U",114,0)
 ;GMRCFN=File 123 IEN
"RTN","GMRCHL7U",115,0)
 ;GMRCURG=urgency of request from protocol file
"RTN","GMRCHL7U",116,0)
 ;GMRCADUZ=array of those who receive alerts
"RTN","GMRCHL7U",117,0)
 ;GMRCORA=action to take on alert: 27 is for new alert
"RTN","GMRCHL7U",118,0)
 N GMRCORTX
"RTN","GMRCHL7U",119,0)
 S GMRCORTX="New consult "_$$ORTX^GMRCAU(+GMRCO)_$S(+GMRCURG:" ("_$P(^ORD(101,+GMRCURG,0),"^",2)_")",1:"")
"RTN","GMRCHL7U",120,0)
 S:'$D(GMRCORA) GMRCORA=27 S:GMRCORA="" GMRCORA=27
"RTN","GMRCHL7U",121,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,GMRCFN,GMRCORA,.GMRCADUZ,1)
"RTN","GMRCHL7U",122,0)
 K GMRCADUZ
"RTN","GMRCHL7U",123,0)
 Q
"RTN","GMRCIAC1")
0^1^B64026480
"RTN","GMRCIAC1",1,0)
GMRCIAC1 ;SLC/JFR - FILE IFC ACTIVITIES cont'd ;2/11/02 16:11
"RTN","GMRCIAC1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIAC1",3,0)
 Q
"RTN","GMRCIAC1",4,0)
COMP(GMRCAR) ;process partial result, clin complete and admin complete
"RTN","GMRCIAC1",5,0)
 ;
"RTN","GMRCIAC1",6,0)
 N GMRCDA,GMRCFDA,GMRCORC,GMRCLAT,GMRCACT,FDA
"RTN","GMRCIAC1",7,0)
 N GMRCRES,GMRCERR,GMRCSTS,GMRCREAS
"RTN","GMRCIAC1",8,0)
 M ^TMP("GMRCIN",$J)=@GMRCAR
"RTN","GMRCIAC1",9,0)
 S GMRCORC=^TMP("GMRCIN",$J,"ORC")
"RTN","GMRCIAC1",10,0)
 S GMRCREAS=$P($P(GMRCORC,"|",16),U)
"RTN","GMRCIAC1",11,0)
 S GMRCDA=$$GETDA^GMRCIAC2(GMRCORC)
"RTN","GMRCIAC1",12,0)
 S GMRCSTS=$P(^GMR(123,GMRCDA,0),U,12)
"RTN","GMRCIAC1",13,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIAC1",14,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ;send app. ACK
"RTN","GMRCIAC1",15,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIAC1",16,0)
 ;
"RTN","GMRCIAC1",17,0)
 S GMRCFDA(8)=$S($P(GMRCORC,"|",5)="CM":2,GMRCSTS=2:2,1:9) ;comp or pr
"RTN","GMRCIAC1",18,0)
 S GMRCLAT=$S($P(GMRCORC,"|",5)="A":9,GMRCREAS="A":13,1:10)
"RTN","GMRCIAC1",19,0)
 S GMRCFDA(9)=GMRCLAT ;complete/upd or incomplete rpt
"RTN","GMRCIAC1",20,0)
 I $D(^TMP("GMRCIN",$J,"OBX",6,1)) D
"RTN","GMRCIAC1",21,0)
 . S GMRCFDA(15)=$P(^TMP("GMRCIN",$J,"OBX",6,1),"|",5)
"RTN","GMRCIAC1",22,0)
 ;     v-- check to see if a duplicate transmission
"RTN","GMRCIAC1",23,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,GMRCLAT,GMRCORC,$S(GMRCLAT=13:"",1:$G(^TMP("GMRCIN",$J,"OBX",4,1)))) Q
"RTN","GMRCIAC1",24,0)
 M FDA(1,123,GMRCDA_",")=GMRCFDA
"RTN","GMRCIAC1",25,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file last action and status
"RTN","GMRCIAC1",26,0)
 ; check GMRCERR and act if error
"RTN","GMRCIAC1",27,0)
 K GMRCERR
"RTN","GMRCIAC1",28,0)
 K GMRCFDA,FDA
"RTN","GMRCIAC1",29,0)
 D FILEACT^GMRCIAC2(GMRCDA,GMRCLAT,,$NA(^TMP("GMRCIN",$J)))
"RTN","GMRCIAC1",30,0)
 ;     ^--- file result and activities
"RTN","GMRCIAC1",31,0)
 I $D(^TMP("GMRCIN",$J,"OBX",4,1)) D  ;file result if there
"RTN","GMRCIAC1",32,0)
 . I GMRCLAT=13 Q  ; addendum carries the result that it's addending
"RTN","GMRCIAC1",33,0)
 . I GMRCLAT=9 Q  ; don't file result on inc. report
"RTN","GMRCIAC1",34,0)
 . I $P(^GMR(123,GMRCDA,12),U,5)="F" Q  ;no comp coming from placer
"RTN","GMRCIAC1",35,0)
 . D FILRES^GMRCIAC2(GMRCDA,^TMP("GMRCIN",$J,"OBX",4,1))
"RTN","GMRCIAC1",36,0)
 D  ;send notifications
"RTN","GMRCIAC1",37,0)
 . I GMRCLAT=9 Q
"RTN","GMRCIAC1",38,0)
 . I $P(^GMR(123,GMRCDA,12),U,5)="F" Q  ;filler only gets historical comp
"RTN","GMRCIAC1",39,0)
 . N GMRCORTX S GMRCORTX=""
"RTN","GMRCIAC1",40,0)
 . I $O(^GMR(123,GMRCDA,51," "),-1)>1 D
"RTN","GMRCIAC1",41,0)
 .. S GMRCORTX="New remote result added to "
"RTN","GMRCIAC1",42,0)
 . I GMRCLAT=13 S GMRCORTX="Addendum added to "
"RTN","GMRCIAC1",43,0)
 . S GMRCORTX=GMRCORTX_"Remote Complete Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIAC1",44,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCORTX,GMRCDA,23,,1)
"RTN","GMRCIAC1",45,0)
 D  ;send appl ACK
"RTN","GMRCIAC1",46,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA")
"RTN","GMRCIAC1",47,0)
 ;
"RTN","GMRCIAC1",48,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC1",49,0)
 Q
"RTN","GMRCIAC1",50,0)
 ;
"RTN","GMRCIAC1",51,0)
FWD(GMRCAR)     ;file forward action from a remote site
"RTN","GMRCIAC1",52,0)
 ;Input:
"RTN","GMRCIAC1",53,0)
 ; GMRCAR = array name containing message 
"RTN","GMRCIAC1",54,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIAC1",55,0)
 ;
"RTN","GMRCIAC1",56,0)
 N GMRCFDA,GMRCDA,GMRCFWSR,GMRCFROM,GMRCORC,GMRCTIFC,GMRCLAC,GMRCROL
"RTN","GMRCIAC1",57,0)
 M ^TMP("GMRCIN",$J)=@GMRCAR
"RTN","GMRCIAC1",58,0)
 I '$D(^TMP("GMRCIN",$J,"OBR")) Q
"RTN","GMRCIAC1",59,0)
 S GMRCORC=^TMP("GMRCIN",$J,"ORC")
"RTN","GMRCIAC1",60,0)
 S GMRCTIFC=$S($P($P(GMRCORC,"|",16),U)="F":0,1:1)
"RTN","GMRCIAC1",61,0)
 S GMRCDA=$$GETDA^GMRCIAC2(GMRCORC)
"RTN","GMRCIAC1",62,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIAC1",63,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ;send app. ACK
"RTN","GMRCIAC1",64,0)
        . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIAC1",65,0)
 S GMRCROL=$P(^GMR(123,GMRCDA,12),U,5)
"RTN","GMRCIAC1",66,0)
 I 'GMRCTIFC D
"RTN","GMRCIAC1",67,0)
 . S GMRCFDA(9)=17,GMRCLAC=17
"RTN","GMRCIAC1",68,0)
 . I GMRCROL="F" D  Q
"RTN","GMRCIAC1",69,0)
 .. S GMRCFROM=$P($P(^TMP("GMRCIN",$J,"OBR"),"|",4),U,2)
"RTN","GMRCIAC1",70,0)
 . S GMRCFDA(.131)=$P($P(^TMP("GMRCIN",$J,"OBR"),"|",4),U,2)
"RTN","GMRCIAC1",71,0)
 . S GMRCFROM=$P($G(^GMR(123,GMRCDA,13)),U)
"RTN","GMRCIAC1",72,0)
 I GMRCTIFC D
"RTN","GMRCIAC1",73,0)
 . S GMRCFROM=$P($P(^TMP("GMRCIN",$J,"OBR"),"|",4),U,2)
"RTN","GMRCIAC1",74,0)
 . S GMRCFDA(9)=25,GMRCLAC=25
"RTN","GMRCIAC1",75,0)
 ;
"RTN","GMRCIAC1",76,0)
 S GMRCFDA(8)=5
"RTN","GMRCIAC1",77,0)
 D  ;get urgency to file
"RTN","GMRCIAC1",78,0)
 . N URG
"RTN","GMRCIAC1",79,0)
 . S URG=$$URG^GMRCHL7A($P($P(^TMP("GMRCIN",$J,"ORC"),"|",7),U,6))
"RTN","GMRCIAC1",80,0)
 . S GMRCFDA(5)=$$FIND1^DIC(101,"","X","GMRCURGENCY - "_URG)
"RTN","GMRCIAC1",81,0)
 ;   v-- chk to see if activity is a dup transmission
"RTN","GMRCIAC1",82,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,GMRCLAC,GMRCORC) Q
"RTN","GMRCIAC1",83,0)
 ;
"RTN","GMRCIAC1",84,0)
 M FDA(1,123,GMRCDA_",")=GMRCFDA
"RTN","GMRCIAC1",85,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIAC1",86,0)
 K GMRCFDA
"RTN","GMRCIAC1",87,0)
 ;
"RTN","GMRCIAC1",88,0)
 ; file activity tracking
"RTN","GMRCIAC1",89,0)
 D FILEACT^GMRCIAC2(GMRCDA,GMRCLAC,GMRCFROM,$NA(^TMP("GMRCIN",$J)))
"RTN","GMRCIAC1",90,0)
 ;
"RTN","GMRCIAC1",91,0)
 ; send alerts
"RTN","GMRCIAC1",92,0)
 I GMRCROL="F" D
"RTN","GMRCIAC1",93,0)
 . I GMRCLAC'=25 Q  ; filler alerts only on FWD 2 IFC
"RTN","GMRCIAC1",94,0)
 . N GMRCTX
"RTN","GMRCIAC1",95,0)
 . S GMRCTX="New remote Consult: "_$$ORTX^GMRCAU(GMRCDA)
"RTN","GMRCIAC1",96,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCTX,GMRCDA,27,,1)
"RTN","GMRCIAC1",97,0)
 . Q
"RTN","GMRCIAC1",98,0)
 I GMRCROL="P" D
"RTN","GMRCIAC1",99,0)
 . N GMRCTX
"RTN","GMRCIAC1",100,0)
 . S GMRCTX="Updated Remote Consult: "_$$ORTX^GMRCAU(GMRCDA)
"RTN","GMRCIAC1",101,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCTX,GMRCDA,63,,1)
"RTN","GMRCIAC1",102,0)
 . Q
"RTN","GMRCIAC1",103,0)
 ;
"RTN","GMRCIAC1",104,0)
 ; print if FWD to IFC
"RTN","GMRCIAC1",105,0)
 I GMRCROL="F" D
"RTN","GMRCIAC1",106,0)
 . I GMRCLAC'=25 Q
"RTN","GMRCIAC1",107,0)
 . D PRNT^GMRCUTL1("",GMRCDA)
"RTN","GMRCIAC1",108,0)
 ;
"RTN","GMRCIAC1",109,0)
 D  ;send app. ACK and unlock record
"RTN","GMRCIAC1",110,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA")
"RTN","GMRCIAC1",111,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC1",112,0)
 Q
"RTN","GMRCIAC1",113,0)
 ;
"RTN","GMRCIAC1",114,0)
SF(GMRCAR) ;add significant findings
"RTN","GMRCIAC1",115,0)
 ; Input:
"RTN","GMRCIAC1",116,0)
 ; GMRCAR = array name containing message 
"RTN","GMRCIAC1",117,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIAC1",118,0)
 ;
"RTN","GMRCIAC1",119,0)
 N FDA,GMRCERR,GMRCOSF,GMRCISF
"RTN","GMRCIAC1",120,0)
 M ^TMP("GMRCIS",$J)=@GMRCAR
"RTN","GMRCIAC1",121,0)
 I '$D(^TMP("GMRCIS",$J,"OBX",6,1)) Q  ;no SF flag sent  ;-(
"RTN","GMRCIAC1",122,0)
 S GMRCDA=$$GETDA^GMRCIAC2(^TMP("GMRCIS",$J,"ORC"))
"RTN","GMRCIAC1",123,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIAC1",124,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ;send app. ACK
"RTN","GMRCIAC1",125,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIAC1",126,0)
 ;
"RTN","GMRCIAC1",127,0)
 S GMRCOSF=$P(^GMR(123,GMRCDA,0),U,19)
"RTN","GMRCIAC1",128,0)
 S GMRCISF=$P(^TMP("GMRCIS",$J,"OBX",6,1),"|",5)
"RTN","GMRCIAC1",129,0)
 S FDA(1,123,GMRCDA_",",15)=GMRCISF
"RTN","GMRCIAC1",130,0)
 S FDA(1,123,GMRCDA_",",9)=4
"RTN","GMRCIAC1",131,0)
 ;   v-- quit if a duplicate activity
"RTN","GMRCIAC1",132,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,4,^TMP("GMRCIS",$J,"ORC")) Q
"RTN","GMRCIAC1",133,0)
 ;
"RTN","GMRCIAC1",134,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file last action and SF
"RTN","GMRCIAC1",135,0)
 D FILEACT^GMRCIAC2(GMRCDA,4,,$NA(^TMP("GMRCIS",$J))) ;activity track
"RTN","GMRCIAC1",136,0)
 D  ;send notifications
"RTN","GMRCIAC1",137,0)
 . I $P(^GMR(123,GMRCDA,12),U,5)="F" Q  ;filler only gets hist. SF 
"RTN","GMRCIAC1",138,0)
 . N GMRCORTX
"RTN","GMRCIAC1",139,0)
 . S GMRCORTX=$S(GMRCISF="N":"No ",GMRCISF="Y":"",1:"Unknown ")
"RTN","GMRCIAC1",140,0)
 . S GMRCORTX=GMRCORTX_"Sig Findings for "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIAC1",141,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCORTX,GMRCDA,23,,1)
"RTN","GMRCIAC1",142,0)
 D  ;send appl ACK and unlock record
"RTN","GMRCIAC1",143,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA")
"RTN","GMRCIAC1",144,0)
 K ^TMP("GMRCIS",$J)
"RTN","GMRCIAC1",145,0)
 Q
"RTN","GMRCIAC1",146,0)
 ;
"RTN","GMRCIAC1",147,0)
RESUB(GMRCAR) ;resubmit a cancelled, remote consult
"RTN","GMRCIAC1",148,0)
 ; Input:
"RTN","GMRCIAC1",149,0)
 ;   GMRCAR - array name containing message 
"RTN","GMRCIAC1",150,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIAC1",151,0)
 ;
"RTN","GMRCIAC1",152,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC1",153,0)
 M ^TMP("GMRCIN",$J)=@GMRCAR
"RTN","GMRCIAC1",154,0)
 N GMRCDA,GMRCFDA,FDA
"RTN","GMRCIAC1",155,0)
 S GMRCDA=$$GETDA^GMRCIAC2(^TMP("GMRCIN",$J,"ORC"))
"RTN","GMRCIAC1",156,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIAC1",157,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ; send app. ACK
"RTN","GMRCIAC1",158,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIAC1",159,0)
 ;
"RTN","GMRCIAC1",160,0)
 S GMRCFDA(8)=5,GMRCFDA(9)=11 ;status and last action
"RTN","GMRCIAC1",161,0)
 ;
"RTN","GMRCIAC1",162,0)
 I $D(^TMP("GMRCIN",$J,"OBR")) D  ; has INPATIENT or OUTPATIENT changed?
"RTN","GMRCIAC1",163,0)
 . N GMRCION
"RTN","GMRCIAC1",164,0)
 . S GMRCION=$P(^TMP("GMRCIN",$J,"OBR"),"|",18)
"RTN","GMRCIAC1",165,0)
 . I GMRCION'=$P(^GMR(123,GMRCDA,0),U,18) S GMRCFDA(14)=GMRCION
"RTN","GMRCIAC1",166,0)
 . Q
"RTN","GMRCIAC1",167,0)
 D  ; check for change in urgency
"RTN","GMRCIAC1",168,0)
 . N GMRCURG
"RTN","GMRCIAC1",169,0)
 . S GMRCURG=$P($P(^TMP("GMRCIN",$J,"ORC"),"|",7),U,6)
"RTN","GMRCIAC1",170,0)
 . I '$L(GMRCURG) Q
"RTN","GMRCIAC1",171,0)
 . S GMRCURG=$$URG^GMRCHL7A(GMRCURG)
"RTN","GMRCIAC1",172,0)
 . S GMRCURG=$$FIND1^DIC(101,"","X","GMRCURGENCY - "_GMRCURG)
"RTN","GMRCIAC1",173,0)
 . I GMRCURG'>1 Q
"RTN","GMRCIAC1",174,0)
 . I GMRCURG=$P(^GMR(123,GMRCDA,0),U,9) Q  ;no change
"RTN","GMRCIAC1",175,0)
 . S GMRCFDA(5)=GMRCURG
"RTN","GMRCIAC1",176,0)
 . Q
"RTN","GMRCIAC1",177,0)
 I $D(^TMP("GMRCIN",$J,"OBX",2)) D  ; change in Prov. DX?
"RTN","GMRCIAC1",178,0)
 . N PROVDX
"RTN","GMRCIAC1",179,0)
 . S PROVDX=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U,2)
"RTN","GMRCIAC1",180,0)
 . I '$L(PROVDX) Q
"RTN","GMRCIAC1",181,0)
 . I PROVDX=$G(^GMR(123,GMRCDA,30)) Q  ; no change
"RTN","GMRCIAC1",182,0)
 . S GMRCFDA(30)=PROVDX
"RTN","GMRCIAC1",183,0)
 . S GMRCFDA(30.1)=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U)
"RTN","GMRCIAC1",184,0)
 . Q
"RTN","GMRCIAC1",185,0)
 ;   v-- QUIT if a duplicate transmission
"RTN","GMRCIAC1",186,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,11,^TMP("GMRCIN",$J,"ORC")) Q
"RTN","GMRCIAC1",187,0)
 ;
"RTN","GMRCIAC1",188,0)
 M FDA(1,123,GMRCDA_",")=GMRCFDA
"RTN","GMRCIAC1",189,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file edits
"RTN","GMRCIAC1",190,0)
 K GMRCFDA,FDA
"RTN","GMRCIAC1",191,0)
 ;
"RTN","GMRCIAC1",192,0)
 I $D(^TMP("GMRCIN",$J,"OBX",1)) D  ; reason for request change?
"RTN","GMRCIAC1",193,0)
 . D TRIMWP^GMRCIUTL($NA(^TMP("GMRCIN",$J,"OBX",1)),5)
"RTN","GMRCIAC1",194,0)
 . N DIFF S DIFF=0
"RTN","GMRCIAC1",195,0)
 . D  I 'DIFF Q
"RTN","GMRCIAC1",196,0)
 .. I $O(^TMP("GMRCIN",$J,"OBX",1," "),-1)'=$O(^GMR(123,GMRCDA,20," "),-1) S DIFF=1 Q  ;  diff # of lines in new and existing
"RTN","GMRCIAC1",197,0)
 .. N LN S LN=0 F  S LN=$O(^GMR(123,GMRCDA,20,LN)) Q:'LN!(DIFF)  D
"RTN","GMRCIAC1",198,0)
 ... I $G(^GMR(123,GMRCDA,20,LN,0))=$G(^TMP("GMRCIN",$J,"OBX",1,LN)) Q
"RTN","GMRCIAC1",199,0)
 ... S DIFF=1 ;if the lines aren't the same, set DIFF and Q
"RTN","GMRCIAC1",200,0)
 . D WP^DIE(123,GMRCDA_",",20,"K",$NA(^TMP("GMRCIN",$J,"OBX",1)))
"RTN","GMRCIAC1",201,0)
 . Q
"RTN","GMRCIAC1",202,0)
 D  ;file activity tracking
"RTN","GMRCIAC1",203,0)
 . D FILEACT^GMRCIAC2(GMRCDA,11,,$NA(^TMP("GMRCIN",$J)))
"RTN","GMRCIAC1",204,0)
 N GMRCNTIF
"RTN","GMRCIAC1",205,0)
 D  ;determine if part of a FWD to IFC
"RTN","GMRCIAC1",206,0)
 . I $P(^GMR(123,GMRCDA,40,1,0),U,2)'=24 S GMRCNTIF=1 Q
"RTN","GMRCIAC1",207,0)
 . N ACT S ACT=1
"RTN","GMRCIAC1",208,0)
 . S GMRCNTIF=0
"RTN","GMRCIAC1",209,0)
 . F  S ACT=$O(^GMR(123,GMRCDA,40,ACT)) Q:'ACT!($G(GMRCNTIF))  D
"RTN","GMRCIAC1",210,0)
 .. I $P(^GMR(123,GMRCDA,40,ACT,0),U,2)=25,$O(^(40,ACT)) S GMRCNTIF=1
"RTN","GMRCIAC1",211,0)
 ;
"RTN","GMRCIAC1",212,0)
 D  ;print SF-513 & send notifications
"RTN","GMRCIAC1",213,0)
 . I '$G(GMRCNTIF) Q  ;part of a FWD to IFC
"RTN","GMRCIAC1",214,0)
 . D PRNT^GMRCUTL1("",GMRCDA)
"RTN","GMRCIAC1",215,0)
 . N GMRCORTX
"RTN","GMRCIAC1",216,0)
 . S GMRCORTX="New remotely re-submitted consult "
"RTN","GMRCIAC1",217,0)
 . S GMRCORTX=GMRCORTX_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIAC1",218,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCORTX,GMRCDA,27,,1)
"RTN","GMRCIAC1",219,0)
 ;
"RTN","GMRCIAC1",220,0)
 D  ;send appl ACK and unlock record
"RTN","GMRCIAC1",221,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA")
"RTN","GMRCIAC1",222,0)
 ;
"RTN","GMRCIAC1",223,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC1",224,0)
 Q
"RTN","GMRCIAC1",225,0)
 ;
"RTN","GMRCIAC2")
0^2^B38286349
"RTN","GMRCIAC2",1,0)
GMRCIAC2 ;SLC/JFR - FILE IFC ACTIVITIES CONT'D ;03/05/02 10:48
"RTN","GMRCIAC2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIAC2",3,0)
 Q  ;can't start here
"RTN","GMRCIAC2",4,0)
FILRES(GMRCO,GMRCOBX) ;file or delete results
"RTN","GMRCIAC2",5,0)
 N GMRCRES,GMRCFIL,GMRCSITE,GMRCROOT,RESIEN,GMRCERR
"RTN","GMRCIAC2",6,0)
 S GMRCRES=+$P(GMRCOBX,"|",5)
"RTN","GMRCIAC2",7,0)
 S GMRCFIL=$P($P(GMRCOBX,"|",3),U,3)
"RTN","GMRCIAC2",8,0)
 S GMRCROOT=$S($P($P(GMRCOBX,"|",3),U,2)["TIU":"TIU(",1:"MCAR(")
"RTN","GMRCIAC2",9,0)
 S GMRCFIL=$P(GMRCFIL,"VA",2)
"RTN","GMRCIAC2",10,0)
 S GMRCRES=GMRCRES_";"_GMRCROOT_GMRCFIL
"RTN","GMRCIAC2",11,0)
 S GMRCSITE=$$IEN^XUAF4($P($P(GMRCOBX,"|",5),U,3))
"RTN","GMRCIAC2",12,0)
 I $P(GMRCOBX,"|",11)'="D" D  ;add new result
"RTN","GMRCIAC2",13,0)
 . S FDA(1,123.051,"+1,"_GMRCO_",",.01)=$$NOW^XLFDT
"RTN","GMRCIAC2",14,0)
 . S FDA(1,123.051,"+1,"_GMRCO_",",.02)=GMRCRES
"RTN","GMRCIAC2",15,0)
 . S FDA(1,123.051,"+1,"_GMRCO_",",.03)=GMRCSITE
"RTN","GMRCIAC2",16,0)
 I $P(GMRCOBX,"|",11)="D" D  ; find and delete result
"RTN","GMRCIAC2",17,0)
 . N RESIEN
"RTN","GMRCIAC2",18,0)
 . S RESIEN=$O(^GMR(123,GMRCO,51,"AR",GMRCRES,GMRCSITE,0))
"RTN","GMRCIAC2",19,0)
 . I 'RESIEN Q
"RTN","GMRCIAC2",20,0)
 . S FDA(1,123.051,RESIEN_","_GMRCO_",",.01)="@"
"RTN","GMRCIAC2",21,0)
 I '$D(FDA) Q
"RTN","GMRCIAC2",22,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIAC2",23,0)
 Q
"RTN","GMRCIAC2",24,0)
 ;
"RTN","GMRCIAC2",25,0)
UPDORD(GMRCDA,GMRC40) ; update CPRS order if action on placer order.
"RTN","GMRCIAC2",26,0)
 ; Input:
"RTN","GMRCIAC2",27,0)
 ;  GMRCDA   = ien from file 123
"RTN","GMRCIAC2",28,0)
 ;  GMRC40 = ien of activity in 40 multiple
"RTN","GMRCIAC2",29,0)
 ;
"RTN","GMRCIAC2",30,0)
 N GMRCDFN,GMRCAD,AC,GMRCOC,GMRCMT
"RTN","GMRCIAC2",31,0)
 S GMRCDFN=$P(^GMR(123,GMRCDA,0),U,2)
"RTN","GMRCIAC2",32,0)
 I $O(^GMR(123,GMRCDA,40,GMRC40,1,0)) D
"RTN","GMRCIAC2",33,0)
 . S GMRCMT=1,GMRCMT(0)=GMRC40
"RTN","GMRCIAC2",34,0)
 S GMRCAD=$P(^GMR(123,GMRCDA,40,GMRC40,0),U,3)
"RTN","GMRCIAC2",35,0)
 S AC=$P(^GMR(123,GMRCDA,40,GMRC40,0),U,2)
"RTN","GMRCIAC2",36,0)
 S GMRCOC=$S(AC=6:"OD",AC=19:"OC",AC=10:"RE",AC=9:"RE",AC=8:"ZC",1:"SC")
"RTN","GMRCIAC2",37,0)
 D EN^GMRCHL7(GMRCDFN,GMRCDA,"","",GMRCOC,"","",.GMRCMT,,GMRCAD)
"RTN","GMRCIAC2",38,0)
 Q
"RTN","GMRCIAC2",39,0)
FILEACT(GMRCO,GMRCLAST,GMRCFR,GMRCAR) ;file REQUEST PROCESSING ACTIVITY 
"RTN","GMRCIAC2",40,0)
 ; Input:
"RTN","GMRCIAC2",41,0)
 ;  GMRCO     = ien from file 123
"RTN","GMRCIAC2",42,0)
 ;  GMRCLAST  = last action taken on request
"RTN","GMRCIAC2",43,0)
 ;  GMRCFR    = service that consult was forwarded from
"RTN","GMRCIAC2",44,0)
 ;  GMRCAR    = name of the array containing the message
"RTN","GMRCIAC2",45,0)
 ;
"RTN","GMRCIAC2",46,0)
 N GMRCORC,GMRCFDA,GMRCRP,GMRCEP,GMRCACT,GMRCERR,FDA
"RTN","GMRCIAC2",47,0)
 M ^TMP("GMRCFIL",$J)=@GMRCAR
"RTN","GMRCIAC2",48,0)
 S GMRCORC=^TMP("GMRCFIL",$J,"ORC")
"RTN","GMRCIAC2",49,0)
 S ^XTMP("GMRCORC")=GMRCORC
"RTN","GMRCIAC2",50,0)
 S GMRCFDA(.01)=$$NOW^XLFDT
"RTN","GMRCIAC2",51,0)
 S GMRCFDA(.25)=$$HL7TFM^XLFDT($P(GMRCORC,"|",9))
"RTN","GMRCIAC2",52,0)
 S GMRCFDA(1)=GMRCLAST
"RTN","GMRCIAC2",53,0)
 S GMRCFDA(2)=$$HL7TFM^XLFDT($P(GMRCORC,"|",15))
"RTN","GMRCIAC2",54,0)
 D  ;get entering and responsible persons
"RTN","GMRCIAC2",55,0)
 . D UNHLNAME^GMRCIUTL($P(GMRCORC,"|",10),.GMRCEP,1,U)
"RTN","GMRCIAC2",56,0)
 . D UNHLNAME^GMRCIUTL($P(GMRCORC,"|",12),.GMRCRP,1,U)
"RTN","GMRCIAC2",57,0)
 S GMRCFDA(.21)=GMRCEP
"RTN","GMRCIAC2",58,0)
 S GMRCFDA(.22)=GMRCRP
"RTN","GMRCIAC2",59,0)
 S GMRCFDA(.23)=$P($G(^TMP("GMRCFIL",$J,"OBX",5,1)),"|",5)
"RTN","GMRCIAC2",60,0)
 I $D(GMRCFR) S GMRCFDA(.31)=GMRCFR
"RTN","GMRCIAC2",61,0)
 I $D(^TMP("GMRCFIL",$J,"OBX",4)) D
"RTN","GMRCIAC2",62,0)
 . N RFIL,RSLT,DESC,GMRCOBX,ROOT,RSITE
"RTN","GMRCIAC2",63,0)
 . S GMRCOBX=^TMP("GMRCFIL",$J,"OBX",4,1)
"RTN","GMRCIAC2",64,0)
 . S RFIL=$P($P(GMRCOBX,"|",3),U,3),RFIL=$P(RFIL,"VA",2)
"RTN","GMRCIAC2",65,0)
 . S RSLT=+$P(GMRCOBX,"|",5)
"RTN","GMRCIAC2",66,0)
 . S RSITE=$$IEN^XUAF4($P($P(GMRCOBX,"|",5),U,3))
"RTN","GMRCIAC2",67,0)
 . S ROOT=$S($P($P(GMRCOBX,"|",3),U,2)["TIU":"TIU(",1:"MCAR(")
"RTN","GMRCIAC2",68,0)
 . S DESC=$P($P(GMRCOBX,"|",5),U,2)
"RTN","GMRCIAC2",69,0)
 . S GMRCFDA(.24)=RSLT_";"_ROOT_RFIL_";"_DESC_";"_RSITE
"RTN","GMRCIAC2",70,0)
 I GMRCLAST=10 D  ; overwite inc. report in last action?
"RTN","GMRCIAC2",71,0)
 . N GMRCLACT
"RTN","GMRCIAC2",72,0)
 . S GMRCLACT=$O(^GMR(123,GMRCO,40," "),-1)
"RTN","GMRCIAC2",73,0)
 . I '$G(GMRCLACT) Q
"RTN","GMRCIAC2",74,0)
 . I $P($G(^GMR(123,GMRCO,40,GMRCLACT,0)),U,2)'=9 Q
"RTN","GMRCIAC2",75,0)
 . I $$FMDIFF^XLFDT($$NOW^XLFDT,+^GMR(123,GMRCO,40,GMRCLACT,0),2)>900 Q
"RTN","GMRCIAC2",76,0)
 . I $P($G(^GMR(123,GMRCO,40,GMRCLACT,2)),U,4)=GMRCFDA(.24) D
"RTN","GMRCIAC2",77,0)
 .. S GMRCACT(1)=GMRCLACT
"RTN","GMRCIAC2",78,0)
 .. M FDA(1,123.02,GMRCACT(1)_","_GMRCO_",")=GMRCFDA
"RTN","GMRCIAC2",79,0)
 .. D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIAC2",80,0)
 . Q
"RTN","GMRCIAC2",81,0)
 I '$D(GMRCACT(1)) D  ; need to create new activity
"RTN","GMRCIAC2",82,0)
 . M FDA(1,123.02,"+1,"_GMRCO_",")=GMRCFDA
"RTN","GMRCIAC2",83,0)
 . D UPDATE^DIE("","FDA(1)","GMRCACT","GMRCERR")
"RTN","GMRCIAC2",84,0)
 K GMRCFDA,FDA
"RTN","GMRCIAC2",85,0)
 D  ; file comments if present
"RTN","GMRCIAC2",86,0)
 . I $D(^TMP("GMRCFIL",$J,"OBX",3)) D  ; general comments
"RTN","GMRCIAC2",87,0)
 .. N TMPARR
"RTN","GMRCIAC2",88,0)
 .. S TMPARR=$NA(^TMP("GMRCFIL",$J,"OBX",3))
"RTN","GMRCIAC2",89,0)
 .. D TRIMWP^GMRCIUTL(TMPARR,5)
"RTN","GMRCIAC2",90,0)
 .. D WP^DIE(123.02,GMRCACT(1)_","_GMRCO_",",5,"K",TMPARR)
"RTN","GMRCIAC2",91,0)
 . I $D(^TMP("GMRCFIL",$J,"NTE")) D  ; DC or cancel comments
"RTN","GMRCIAC2",92,0)
 .. N TMPARR
"RTN","GMRCIAC2",93,0)
 .. S TMPARR=$NA(^TMP("GMRCFIL",$J,"NTE"))
"RTN","GMRCIAC2",94,0)
 .. D TRIMWP^GMRCIUTL(TMPARR,3)
"RTN","GMRCIAC2",95,0)
 .. D WP^DIE(123.02,GMRCACT(1)_","_GMRCO_",",5,"K",TMPARR)
"RTN","GMRCIAC2",96,0)
 .. Q
"RTN","GMRCIAC2",97,0)
 D  ; update order if necessary
"RTN","GMRCIAC2",98,0)
 . I $P($G(^GMR(123,GMRCO,12)),U,5)="F" Q  ; fillers have no order
"RTN","GMRCIAC2",99,0)
 . I GMRCLAST=11!(GMRCLAST=13)!(GMRCLAST=14) Q  ;no status chg
"RTN","GMRCIAC2",100,0)
 . I GMRCLAST=4!(GMRCLAST=20) Q  ;no status chg
"RTN","GMRCIAC2",101,0)
 . D UPDORD(GMRCO,GMRCACT(1))
"RTN","GMRCIAC2",102,0)
 K ^TMP("GMRCFIL",$J)
"RTN","GMRCIAC2",103,0)
 Q
"RTN","GMRCIAC2",104,0)
 ;
"RTN","GMRCIAC2",105,0)
TST(ARRAY) ;process test message and check item ordered
"RTN","GMRCIAC2",106,0)
 ;Input:
"RTN","GMRCIAC2",107,0)
 ; ARRAY  = name of array containing message parts
"RTN","GMRCIAC2",108,0)
 ;
"RTN","GMRCIAC2",109,0)
 N GMRCFDA,GMRCORC,GMRCDA,GMRCITM,GMRCITER
"RTN","GMRCIAC2",110,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC2",111,0)
 M ^TMP("GMRCIN",$J)=@ARRAY
"RTN","GMRCIAC2",112,0)
 D  ;get ordered item and service
"RTN","GMRCIAC2",113,0)
 . S GMRCITM=$P(^TMP("GMRCIN",$J,"OBR"),"|",4)
"RTN","GMRCIAC2",114,0)
 . I GMRCITM["VA1233" D  ; proc
"RTN","GMRCIAC2",115,0)
 .. N PROC
"RTN","GMRCIAC2",116,0)
 .. S PROC=$$GETPROC^GMRCIUTL(GMRCITM)
"RTN","GMRCIAC2",117,0)
 .. I +PROC'>0!('$P(PROC,U,2)) S GMRCITER=$P(PROC,U,3) Q
"RTN","GMRCIAC2",118,0)
 . I GMRCITM["VA1235" D
"RTN","GMRCIAC2",119,0)
 .. N SERV
"RTN","GMRCIAC2",120,0)
 .. S SERV=$$GETSERV^GMRCIUTL(GMRCITM) ;consult
"RTN","GMRCIAC2",121,0)
 .. I +SERV'>0 S GMRCITER=$P(SERV,U,3)
"RTN","GMRCIAC2",122,0)
 I $D(GMRCITER) D  ;error in procedure or service, reject new order
"RTN","GMRCIAC2",123,0)
 . N GMRCRSLT
"RTN","GMRCIAC2",124,0)
 . D RESP^GMRCIUTL("AR",HL("MID"),,,GMRCITER) ;build HLA(
"RTN","GMRCIAC2",125,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIAC2",126,0)
 I '$D(GMRCITER) D
"RTN","GMRCIAC2",127,0)
 . N GMRCRSLT
"RTN","GMRCIAC2",128,0)
 . D RESP^GMRCIUTL("AA",HL("MID")) ;build HLA(
"RTN","GMRCIAC2",129,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIAC2",130,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC2",131,0)
 Q
"RTN","GMRCIAC2",132,0)
 ;
"RTN","GMRCIAC2",133,0)
GETDA(GMRCORC) ; determine what local Consult ien to work on
"RTN","GMRCIAC2",134,0)
 ; Input:
"RTN","GMRCIAC2",135,0)
 ;  GMRCORC = ORC seg from incoming message
"RTN","GMRCIAC2",136,0)
 ; Output:
"RTN","GMRCIAC2",137,0)
 ;  ien from file 123
"RTN","GMRCIAC2",138,0)
 ;
"RTN","GMRCIAC2",139,0)
 N GMRCORC2,GMRCORC3
"RTN","GMRCIAC2",140,0)
 S GMRCORC2=$P(GMRCORC,"|",2),GMRCORC3=$P(GMRCORC,"|",3)
"RTN","GMRCIAC2",141,0)
 I $$IEN^XUAF4($P(GMRCORC2,U,2))=$$KSP^XUPARAM("INST") Q +GMRCORC2
"RTN","GMRCIAC2",142,0)
 Q +GMRCORC3
"RTN","GMRCIAC2",143,0)
 ;
"RTN","GMRCIAC2",144,0)
DUPACT(GMRCO,ACTVT,ORC,OBX) ;check to see if activity is a dup transmission
"RTN","GMRCIAC2",145,0)
 ;Input:
"RTN","GMRCIAC2",146,0)
 ;  GMRCO = ien of consult
"RTN","GMRCIAC2",147,0)
 ;  ACTVT = ien of activity from file 123.1
"RTN","GMRCIAC2",148,0)
 ;  ORC   = ORC segment from message
"RTN","GMRCIAC2",149,0)
 ;  OBX   = OBX segment containing result
"RTN","GMRCIAC2",150,0)
 ;
"RTN","GMRCIAC2",151,0)
 ;Output:
"RTN","GMRCIAC2",152,0)
 ;  0  = activity is not a duplicate of one on file already
"RTN","GMRCIAC2",153,0)
 ;  1  = duplicate, activity already on file
"RTN","GMRCIAC2",154,0)
 ;
"RTN","GMRCIAC2",155,0)
 N GMRCIADT,GMRCIFDT,DUP
"RTN","GMRCIAC2",156,0)
 S GMRCIFDT=+$$HL7TFM^XLFDT($P(ORC,"|",9))
"RTN","GMRCIAC2",157,0)
 S GMRCIADT=+$$HL7TFM^XLFDT($P(ORC,"|",15))
"RTN","GMRCIAC2",158,0)
 S DUP=0
"RTN","GMRCIAC2",159,0)
 I $D(^GMR(123,GMRCO,40,"AC",ACTVT,GMRCIFDT,GMRCIADT)) D  Q DUP ;dupl.
"RTN","GMRCIAC2",160,0)
 . N RSLT,RFIL,RSITE,ROOT
"RTN","GMRCIAC2",161,0)
 . I $L($G(OBX)) D  Q:'$G(DUP)
"RTN","GMRCIAC2",162,0)
 .. S RFIL=$P($P(OBX,"|",3),U,3),RFIL=$P(RFIL,"VA",2)
"RTN","GMRCIAC2",163,0)
 .. S RSLT=+$P(OBX,"|",5)
"RTN","GMRCIAC2",164,0)
 .. S RSITE=$$IEN^XUAF4($P($P(OBX,"|",5),U,3))
"RTN","GMRCIAC2",165,0)
 .. S ROOT=$S($P($P(OBX,"|",3),U,2)["TIU":"TIU(",1:"MCAR(")
"RTN","GMRCIAC2",166,0)
 .. S RSLT=RSLT_";"_ROOT_RFIL
"RTN","GMRCIAC2",167,0)
 .. I ACTVT=12,$D(^GMR(123,GMRCO,51,"AR",RSLT,RSITE)) Q  ;no dup
"RTN","GMRCIAC2",168,0)
 .. I ACTVT'=12,'$D(^GMR(123,GMRCO,51,"AR",RSLT,RSITE)) Q  ;no dup
"RTN","GMRCIAC2",169,0)
 .. S DUP=1
"RTN","GMRCIAC2",170,0)
 . S DUP=1
"RTN","GMRCIAC2",171,0)
 . D APPACK(GMRCO,"AR",802) ;send app. ACK and unlock record
"RTN","GMRCIAC2",172,0)
 Q 0
"RTN","GMRCIAC2",173,0)
 ;
"RTN","GMRCIAC2",174,0)
APPACK(GMRCO,ACK,ERR) ;send application acknowledgement for all cases
"RTN","GMRCIAC2",175,0)
 ;Input:
"RTN","GMRCIAC2",176,0)
 ;  GMRCO = ien from file 123
"RTN","GMRCIAC2",177,0)
 ;  ACK   = ACK code to include  ("AA"=accept or "AR"=reject)
"RTN","GMRCIAC2",178,0)
 ;  ERR   = error code to return if there is one (optional)
"RTN","GMRCIAC2",179,0)
 ;
"RTN","GMRCIAC2",180,0)
 ; Output: none
"RTN","GMRCIAC2",181,0)
 ;
"RTN","GMRCIAC2",182,0)
 ;send appl ACK
"RTN","GMRCIAC2",183,0)
 N GMRCRSLT
"RTN","GMRCIAC2",184,0)
 I '$G(ERR) S ERR=""
"RTN","GMRCIAC2",185,0)
 D RESP^GMRCIUTL(ACK,HL("MID"),,,ERR) ;build HLA("HLA", array
"RTN","GMRCIAC2",186,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIAC2",187,0)
 ;
"RTN","GMRCIAC2",188,0)
 D UNLKREC^GMRCUTL1(GMRCO) ;unlock record
"RTN","GMRCIAC2",189,0)
 Q
"RTN","GMRCIACT")
0^3^B58449814
"RTN","GMRCIACT",1,0)
GMRCIACT ;SLC/JFR - PROCESS ACTIONS ON IFC ;02/10/02 22:13
"RTN","GMRCIACT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIACT",3,0)
 Q  ;don't start here!
"RTN","GMRCIACT",4,0)
NW(ARRAY) ;process and file new order
"RTN","GMRCIACT",5,0)
 ;Input:
"RTN","GMRCIACT",6,0)
 ; ARRAY  = name of array containing message parts
"RTN","GMRCIACT",7,0)
 ;
"RTN","GMRCIACT",8,0)
 N GMRCFDA,GMRCORC,GMRCDA,GMRCITM,GMRCITER,GMRCROUT,GMRCFCN,GMRCLAC
"RTN","GMRCIACT",9,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",10,0)
 M ^TMP("GMRCIN",$J)=@ARRAY
"RTN","GMRCIACT",11,0)
 S GMRCORC=^TMP("GMRCIN",$J,"ORC")
"RTN","GMRCIACT",12,0)
 D  I $D(GMRCITER) Q  ;Check for order already being on file
"RTN","GMRCIACT",13,0)
 . S GMRCFCN=+$P(GMRCORC,"|",2)
"RTN","GMRCIACT",14,0)
 . S GMRCROUT=$$IEN^XUAF4($P($P(GMRCORC,"|",2),U,2))
"RTN","GMRCIACT",15,0)
 . I '$O(^GMR(123,"AIFC",GMRCROUT,GMRCFCN,0)) Q  ;no dup
"RTN","GMRCIACT",16,0)
 . S GMRCITER=802
"RTN","GMRCIACT",17,0)
 . D APPACK^GMRCIAC2(0,"AR",GMRCITER) ;send app. ack w/ error
"RTN","GMRCIACT",18,0)
 . K ^TMP("GMRCIN",$J) Q 
"RTN","GMRCIACT",19,0)
 I '$D(^TMP("GMRCIN",$J,"PID")) Q  ;prepare reject message (no PID)
"RTN","GMRCIACT",20,0)
 D  ;get patient DFN from ICN in message
"RTN","GMRCIACT",21,0)
 . N PAT
"RTN","GMRCIACT",22,0)
 . S PAT=$$GETDFN^MPIF001(+$P(^TMP("GMRCIN",$J,"PID"),"|",2))
"RTN","GMRCIACT",23,0)
 . I +PAT'>1 S GMRCFDA(.02)="" Q
"RTN","GMRCIACT",24,0)
 . S GMRCFDA(.02)=+PAT
"RTN","GMRCIACT",25,0)
 I '$G(GMRCFDA(.02)) D  Q  ;reject message, patient is unknown
"RTN","GMRCIACT",26,0)
 . N STA S STA=$P($P(^TMP("GMRCIN",$J,"ORC"),"|",2),U,2)
"RTN","GMRCIACT",27,0)
 . D PTERRMSG^GMRCIERR(^TMP("GMRCIN",$J,"PID"),STA)
"RTN","GMRCIACT",28,0)
 . D APPACK^GMRCIAC2(0,"AR",201) ; send app. ack w/error
"RTN","GMRCIACT",29,0)
 . K ^TMP("GMRCIN",$J) Q 
"RTN","GMRCIACT",30,0)
 D  ;get ordered item and service
"RTN","GMRCIACT",31,0)
 . S GMRCITM=$P(^TMP("GMRCIN",$J,"OBR"),"|",4)
"RTN","GMRCIACT",32,0)
 . I GMRCITM["VA1233" D  ; proc
"RTN","GMRCIACT",33,0)
 .. N PROC
"RTN","GMRCIACT",34,0)
 .. S PROC=$$GETPROC^GMRCIUTL(GMRCITM)
"RTN","GMRCIACT",35,0)
 .. I +PROC'>0!('$P(PROC,U,2)) S GMRCITER=$P(PROC,U,3) Q
"RTN","GMRCIACT",36,0)
 .. S GMRCFDA(4)=$P(PROC,U)_";GMR(123.3,"
"RTN","GMRCIACT",37,0)
 .. S GMRCFDA(1)=$P(PROC,U,2)
"RTN","GMRCIACT",38,0)
 . I GMRCITM["VA1235" D
"RTN","GMRCIACT",39,0)
 .. N SERV
"RTN","GMRCIACT",40,0)
 .. S SERV=$$GETSERV^GMRCIUTL(GMRCITM) ;consult
"RTN","GMRCIACT",41,0)
 .. I +SERV'>0 S GMRCITER=$P(SERV,U,3)
"RTN","GMRCIACT",42,0)
 .. S GMRCFDA(1)=SERV
"RTN","GMRCIACT",43,0)
 I $D(GMRCITER) D  Q  ;error in procedure or service, reject new order
"RTN","GMRCIACT",44,0)
 . D APPACK^GMRCIAC2(0,"AR",GMRCITER) ; send app. ACK
"RTN","GMRCIACT",45,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",46,0)
 ;
"RTN","GMRCIACT",47,0)
 S GMRCFDA(.01)=$$NOW^XLFDT
"RTN","GMRCIACT",48,0)
 S GMRCFDA(3)=$$HL7TFM^XLFDT($P(GMRCORC,"|",15))
"RTN","GMRCIACT",49,0)
 S GMRCFDA(6)=$$FIND1^DIC(101,"","X","GMRCPLACE - ON CALL")
"RTN","GMRCIACT",50,0)
 D  ;get urgency to file
"RTN","GMRCIACT",51,0)
 . N URG
"RTN","GMRCIACT",52,0)
 . S URG=$$URG^GMRCHL7A($P($P(GMRCORC,"|",7),U,6))
"RTN","GMRCIACT",53,0)
 . S GMRCFDA(5)=$$FIND1^DIC(101,"","X","GMRCURGENCY - "_URG)
"RTN","GMRCIACT",54,0)
 S GMRCFDA(8)=5
"RTN","GMRCIACT",55,0)
 S GMRCFDA(9)=$S($P(GMRCORC,"|",16)["FI":24,1:23),GMRCLAC=GMRCFDA(9)
"RTN","GMRCIACT",56,0)
 S GMRCFDA(14)=$P(^TMP("GMRCIN",$J,"OBR"),"|",18)
"RTN","GMRCIACT",57,0)
 S GMRCFDA(.05)=$$IEN^XUAF4(+$P(GMRCORC,"|",17))
"RTN","GMRCIACT",58,0)
 S GMRCFDA(.06)=GMRCFCN
"RTN","GMRCIACT",59,0)
 S GMRCFDA(.07)=GMRCROUT
"RTN","GMRCIACT",60,0)
 D  ;get and set ordering prov info & entering person info
"RTN","GMRCIACT",61,0)
 . N GMRCOP
"RTN","GMRCIACT",62,0)
 . S GMRCOP=$$FMNAME^XLFNAME($P(GMRCORC,"|",12))
"RTN","GMRCIACT",63,0)
 . Q:'$L(GMRCOP)
"RTN","GMRCIACT",64,0)
 . S GMRCFDA(.126)=GMRCOP
"RTN","GMRCIACT",65,0)
 . Q
"RTN","GMRCIACT",66,0)
 S GMRCFDA(.125)="F"
"RTN","GMRCIACT",67,0)
 I $L($P(GMRCORC,"|",14)) D
"RTN","GMRCIACT",68,0)
 . N GMRCP14 S GMRCP14=$P(GMRCORC,"|",14)
"RTN","GMRCIACT",69,0)
 . S GMRCFDA(.132)=$P(GMRCP14,"B") ; requestor's phone number
"RTN","GMRCIACT",70,0)
 . S GMRCFDA(.133)=$P(GMRCP14,"B",2) ; requestor's dig pager
"RTN","GMRCIACT",71,0)
 S GMRCFDA(13)=$S($D(GMRCFDA(4)):"P",1:"C")
"RTN","GMRCIACT",72,0)
 I $D(^TMP("GMRCIN",$J,"OBX",2)) D
"RTN","GMRCIACT",73,0)
 . S GMRCFDA(30)=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U,2)
"RTN","GMRCIACT",74,0)
 . S GMRCFDA(30.1)=$P($P(^TMP("GMRCIN",$J,"OBX",2,1),"|",5),U)
"RTN","GMRCIACT",75,0)
 M FDA(1,123,"+1,")=GMRCFDA
"RTN","GMRCIACT",76,0)
 D UPDATE^DIE("","FDA(1)","GMRCDA","GMRCERR")
"RTN","GMRCIACT",77,0)
 I '$D(GMRCDA) D  Q  ;couldn't get new consult #
"RTN","GMRCIACT",78,0)
 . D APPACK^GMRCIAC2(0,"AR",901) ; send app. ACK
"RTN","GMRCIACT",79,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",80,0)
 K GMRCFDA,FDA
"RTN","GMRCIACT",81,0)
 D  ; file reason for request
"RTN","GMRCIACT",82,0)
 . D TRIMWP^GMRCIUTL($NA(^TMP("GMRCIN",$J,"OBX",1)),5)
"RTN","GMRCIACT",83,0)
 . D WP^DIE(123,GMRCDA(1)_",",20,"K",$NA(^TMP("GMRCIN",$J,"OBX",1)))
"RTN","GMRCIACT",84,0)
 . Q
"RTN","GMRCIACT",85,0)
 D  ;file activity tracking
"RTN","GMRCIACT",86,0)
 . N GMRCSEG
"RTN","GMRCIACT",87,0)
 . S GMRCSEG("ORC")=GMRCORC
"RTN","GMRCIACT",88,0)
 . S GMRCSEG("OBX",5,1)=^TMP("GMRCIN",$J,"OBX",5,1)
"RTN","GMRCIACT",89,0)
 . D FILEACT^GMRCIAC2(GMRCDA(1),GMRCLAC,,"GMRCSEG")
"RTN","GMRCIACT",90,0)
 D  ;print SF-513
"RTN","GMRCIACT",91,0)
 . I GMRCLAC=24 Q  ;don't print if part of a FWD to IFC
"RTN","GMRCIACT",92,0)
 . D PRNT^GMRCUTL1("",GMRCDA(1))
"RTN","GMRCIACT",93,0)
 D  ;send notifications
"RTN","GMRCIACT",94,0)
 . I GMRCLAC=24 Q  ;no alerts yet if part of FWD to IFC
"RTN","GMRCIACT",95,0)
 . N GMRCORTX
"RTN","GMRCIACT",96,0)
 . S GMRCORTX="New remotely ordered consult "_$$ORTX^GMRCAU(+GMRCDA(1))
"RTN","GMRCIACT",97,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA(1),0),U,2),GMRCORTX,GMRCDA(1),27,,1)
"RTN","GMRCIACT",98,0)
 D  ;send appl ack :-(
"RTN","GMRCIACT",99,0)
 . N GMRCRSLT
"RTN","GMRCIACT",100,0)
 . D RESP^GMRCIUTL("AA",HL("MID"),$P(GMRCORC,"|"),GMRCDA(1))
"RTN","GMRCIACT",101,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIACT",102,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",103,0)
 Q
"RTN","GMRCIACT",104,0)
 ;
"RTN","GMRCIACT",105,0)
DIS(GMRCAR) ;dis-associate a result from a remote request
"RTN","GMRCIACT",106,0)
 ;Input:
"RTN","GMRCIACT",107,0)
 ; GMRCAR = array name containing message 
"RTN","GMRCIACT",108,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIACT",109,0)
 N GMRCDA,GMRCFDA,FDA,GMRCERR,GMRCORC
"RTN","GMRCIACT",110,0)
 M ^TMP("GMRCID",$J)=@GMRCAR
"RTN","GMRCIACT",111,0)
 S GMRCORC=^TMP("GMRCID",$J,"ORC")
"RTN","GMRCIACT",112,0)
 S GMRCDA=$$GETDA^GMRCIAC2(GMRCORC)
"RTN","GMRCIACT",113,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIACT",114,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ;send app. ACK
"RTN","GMRCIACT",115,0)
 . K ^TMP("GMRCID",$J) Q
"RTN","GMRCIACT",116,0)
 ;    v--check to see if a dup transmission
"RTN","GMRCIACT",117,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,12,GMRCORC,^TMP("GMRCID",$J,"OBX",4,1)) Q
"RTN","GMRCIACT",118,0)
 ;
"RTN","GMRCIACT",119,0)
 D FILEACT^GMRCIAC2(GMRCDA,12,,$NA(^TMP("GMRCID",$J))) ; act. tracking
"RTN","GMRCIACT",120,0)
 D FILRES^GMRCIAC2(GMRCDA,^TMP("GMRCID",$J,"OBX",4,1)) ;file results
"RTN","GMRCIACT",121,0)
 K GMRCERR,FDA,GMRCFDA
"RTN","GMRCIACT",122,0)
 I $$STSCHG^GMRCDIS(GMRCDA) S FDA(1,123,GMRCDA_",",8)=6
"RTN","GMRCIACT",123,0)
 S FDA(1,123,GMRCDA_",",9)=12
"RTN","GMRCIACT",124,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file last action and status
"RTN","GMRCIACT",125,0)
 D  ;send notifications
"RTN","GMRCIACT",126,0)
 . I $P(^GMR(123,GMRCDA,12),U,5)="F" Q  ;DIS from placer before IFC
"RTN","GMRCIACT",127,0)
 . N GMRCORTX
"RTN","GMRCIACT",128,0)
 . S GMRCORTX="Remote result removed from "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",129,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCORTX,GMRCDA,63,,1)
"RTN","GMRCIACT",130,0)
 D  ;send appl ACK
"RTN","GMRCIACT",131,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA") ; send app. ACK and unlock record
"RTN","GMRCIACT",132,0)
 K ^TMP("GMRCID",$J)
"RTN","GMRCIACT",133,0)
 Q
"RTN","GMRCIACT",134,0)
 ;
"RTN","GMRCIACT",135,0)
OTHER(GMRCAR) ;process most IFC actions
"RTN","GMRCIACT",136,0)
 ;will process the receive, schedule, DC, cancel and added comment action
"RTN","GMRCIACT",137,0)
 ;
"RTN","GMRCIACT",138,0)
 ;Input:
"RTN","GMRCIACT",139,0)
 ; GMRCAR = array name containing message 
"RTN","GMRCIACT",140,0)
 ;      e.g.  ^TMP("GMRCIF",$J)
"RTN","GMRCIACT",141,0)
 ;
"RTN","GMRCIACT",142,0)
 N GMRCDA,GMRCFDA,GMRCORC,GMRCLAT,GMRCACT,GMRCROL,FDA
"RTN","GMRCIACT",143,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",144,0)
 M ^TMP("GMRCIN",$J)=@GMRCAR
"RTN","GMRCIACT",145,0)
 ;
"RTN","GMRCIACT",146,0)
 S GMRCORC=^TMP("GMRCIN",$J,"ORC")
"RTN","GMRCIACT",147,0)
 S GMRCDA=$$GETDA^GMRCIAC2(GMRCORC)  ;get ien to work on 
"RTN","GMRCIACT",148,0)
 S GMRCROL=$P(^GMR(123,GMRCDA,12),U,5)
"RTN","GMRCIACT",149,0)
 I '$$LOCKREC^GMRCUTL1(GMRCDA) D  Q  ;couldn't lock record
"RTN","GMRCIACT",150,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AR",901) ; send app. ACK
"RTN","GMRCIACT",151,0)
 . K ^TMP("GMRCIN",$J) Q
"RTN","GMRCIACT",152,0)
 ;
"RTN","GMRCIACT",153,0)
 I $P(GMRCORC,"|")'="IP" D  ; status update
"RTN","GMRCIACT",154,0)
 . N GMRCOS S GMRCOS=$P(GMRCORC,"|",5)
"RTN","GMRCIACT",155,0)
 . S GMRCFDA(8)=$S(GMRCOS="IP":6,GMRCOS="SC":8,GMRCOS="CA":13,1:1)
"RTN","GMRCIACT",156,0)
 . ; IP=receive, SC=schedule, CA=cancel, DC=discontinue
"RTN","GMRCIACT",157,0)
 D  ; get last action taken
"RTN","GMRCIACT",158,0)
 . I '$G(GMRCFDA(8)) S (GMRCFDA(9),GMRCLAT)=20 Q
"RTN","GMRCIACT",159,0)
 . I GMRCFDA(8)=6 S (GMRCFDA(9),GMRCLAT)=21 Q
"RTN","GMRCIACT",160,0)
 . I GMRCFDA(8)=8 S (GMRCFDA(9),GMRCLAT)=8 Q
"RTN","GMRCIACT",161,0)
 . I GMRCFDA(8)=1 S (GMRCFDA(9),GMRCLAT)=6 Q
"RTN","GMRCIACT",162,0)
 . I GMRCFDA(8)=13 S (GMRCFDA(9),GMRCLAT)=19 Q
"RTN","GMRCIACT",163,0)
 ;                         ^--last action taken
"RTN","GMRCIACT",164,0)
 ;    v-- check to see if a dup transmission
"RTN","GMRCIACT",165,0)
 I $$DUPACT^GMRCIAC2(GMRCDA,GMRCLAT,GMRCORC) Q
"RTN","GMRCIACT",166,0)
 ;
"RTN","GMRCIACT",167,0)
 M FDA(1,123,GMRCDA_",")=GMRCFDA
"RTN","GMRCIACT",168,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR") ;file last action and update status
"RTN","GMRCIACT",169,0)
 K GMRCFDA
"RTN","GMRCIACT",170,0)
 D FILEACT^GMRCIAC2(GMRCDA,GMRCLAT,,$NA(^TMP("GMRCIN",$J)))
"RTN","GMRCIACT",171,0)
 D  ;send notifications
"RTN","GMRCIACT",172,0)
 . N GMRCTX,GMRCNOT,GMRCFL
"RTN","GMRCIACT",173,0)
 . S GMRCFL=1
"RTN","GMRCIACT",174,0)
 . I GMRCLAT=20!(GMRCLAT=8)!(GMRCLAT=21) D
"RTN","GMRCIACT",175,0)
 .. I GMRCLAT=20 D  I '$D(GMRCTX) Q
"RTN","GMRCIACT",176,0)
 ... I $P(^GMR(123,GMRCDA,40,1,0),U,2)'=24 D  Q
"RTN","GMRCIACT",177,0)
 .... S GMRCTX="Comment Added to remote"
"RTN","GMRCIACT",178,0)
 ... N ACT S ACT=1
"RTN","GMRCIACT",179,0)
 ... F  S ACT=$O(^GMR(123,GMRCDA,40,ACT)) Q:'ACT!($D(GMRCTX))  D
"RTN","GMRCIACT",180,0)
 .... I $P(^GMR(123,GMRCDA,40,ACT,0),U,2)=25,$O(^(40,ACT)) D
"RTN","GMRCIACT",181,0)
 ..... S GMRCTX="Comment Added to remote"
"RTN","GMRCIACT",182,0)
 .. I '$D(GMRCTX),GMRCROL="F" Q  ;sch & rec on filler part of FWD 2 IFC
"RTN","GMRCIACT",183,0)
 .. I GMRCLAT=8 S GMRCTX="Scheduled remote"
"RTN","GMRCIACT",184,0)
 .. I GMRCLAT=21 S GMRCTX="Received remote"
"RTN","GMRCIACT",185,0)
 .. S GMRCTX=GMRCTX_" Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",186,0)
 .. S GMRCNOT=63
"RTN","GMRCIACT",187,0)
 . I GMRCLAT=6 D
"RTN","GMRCIACT",188,0)
 .. S GMRCFL=$$DCNOTE^GMRCADC(GMRCDA,.5)
"RTN","GMRCIACT",189,0)
 .. S GMRCTX="Discontinued remote Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",190,0)
 .. S GMRCNOT=23
"RTN","GMRCIACT",191,0)
 . I GMRCLAT=19 D
"RTN","GMRCIACT",192,0)
 .. I GMRCROL="F" Q  ;canc on a filler is part of FWD 2 IFC
"RTN","GMRCIACT",193,0)
 .. S GMRCTX="Cancelled remote Consult: "_$$ORTX^GMRCAU(+GMRCDA)
"RTN","GMRCIACT",194,0)
 .. S GMRCNOT=30
"RTN","GMRCIACT",195,0)
 . I '$D(GMRCNOT) Q  ;don't send any alerts
"RTN","GMRCIACT",196,0)
 . D MSG^GMRCP($P(^GMR(123,GMRCDA,0),U,2),GMRCTX,GMRCDA,GMRCNOT,,GMRCFL)
"RTN","GMRCIACT",197,0)
 ;
"RTN","GMRCIACT",198,0)
 D  ;send appl ACK
"RTN","GMRCIACT",199,0)
 . D APPACK^GMRCIAC2(GMRCDA,"AA") ;send app. ACK and unlock record
"RTN","GMRCIACT",200,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIACT",201,0)
 Q
"RTN","GMRCIACT",202,0)
 ;
"RTN","GMRCIBKG")
0^4^B26231165
"RTN","GMRCIBKG",1,0)
GMRCIBKG ;SLC/JFR - IFC BACKGROUND ERROR PROCESSOR; 1/29/02 22:01
"RTN","GMRCIBKG",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIBKG",3,0)
EN ;process file 123.6 and take action
"RTN","GMRCIBKG",4,0)
 ;Start background process
"RTN","GMRCIBKG",5,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","GMRCIBKG",6,0)
 ;
"RTN","GMRCIBKG",7,0)
 ; OK to run?
"RTN","GMRCIBKG",8,0)
 I '$$GONOGO Q
"RTN","GMRCIBKG",9,0)
 ;
"RTN","GMRCIBKG",10,0)
 ; set start param to NOW and run
"RTN","GMRCIBKG",11,0)
 D EN^XPAR("SYS","GMRC IFC BACKGROUND START",1,$$NOW^XLFDT)
"RTN","GMRCIBKG",12,0)
 ;
"RTN","GMRCIBKG",13,0)
 N GMRCLOG,GMRCTIM,GMRCLOG0
"RTN","GMRCIBKG",14,0)
 S GMRCLOG=0
"RTN","GMRCIBKG",15,0)
 S GMRCTIM=$$FMADD^XLFDT($$NOW^XLFDT,,-1)
"RTN","GMRCIBKG",16,0)
 F  S GMRCLOG=$O(^GMR(123.6,GMRCLOG)) Q:'GMRCLOG  D
"RTN","GMRCIBKG",17,0)
 . S GMRCLOG0=$G(^GMR(123.6,GMRCLOG,0))
"RTN","GMRCIBKG",18,0)
 . ;
"RTN","GMRCIBKG",19,0)
 . ;  v-- resend if couldn't update file immediately
"RTN","GMRCIBKG",20,0)
 . I $P(GMRCLOG0,U,6),$P(GMRCLOG0,U,8)=901 D  Q
"RTN","GMRCIBKG",21,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",22,0)
 . ;  v-- wait at least 1 hour on all other errors
"RTN","GMRCIBKG",23,0)
 . I $P(GMRCLOG0,U)>GMRCTIM Q
"RTN","GMRCIBKG",24,0)
 . ;  v-- if incomplete activity is now the earliest, resend it
"RTN","GMRCIBKG",25,0)
 . I $P(GMRCLOG0,U,6),$P(GMRCLOG0,U,8)=902 D  Q
"RTN","GMRCIBKG",26,0)
 .. Q:$O(^GMR(123.6,"AC",$P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)),-1)
"RTN","GMRCIBKG",27,0)
 .. D DELALRT(GMRCLOG)
"RTN","GMRCIBKG",28,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",29,0)
 . ; v-- delete complete entries after # in GMRC RETAIN IFC ACTIVITY DAYS
"RTN","GMRCIBKG",30,0)
 . I '$P(GMRCLOG0,U,6) D  Q
"RTN","GMRCIBKG",31,0)
 .. N DIK,DA,GMRCRETN
"RTN","GMRCIBKG",32,0)
 .. S GMRCRETN=$$GET^XPAR("SYS","GMRC RETAIN IFC ACTIVITY DAYS",1)
"RTN","GMRCIBKG",33,0)
 .. I 'GMRCRETN S GMRCRETN=7
"RTN","GMRCIBKG",34,0)
 .. I $P(GMRCLOG0,U)>$$FMADD^XLFDT(GMRCTIM,(0-GMRCRETN)) Q  ;don't delete
"RTN","GMRCIBKG",35,0)
 .. S DIK="^GMR(123.6,",DA=GMRCLOG
"RTN","GMRCIBKG",36,0)
 .. D ^DIK ;remove old completed entries
"RTN","GMRCIBKG",37,0)
 . ;
"RTN","GMRCIBKG",38,0)
 . ;  v-- if getting unkown patient error 5 times, alert CAC's
"RTN","GMRCIBKG",39,0)
 . I $P(GMRCLOG0,U,8)=201,$P(GMRCLOG0,U,7)>4 D  Q
"RTN","GMRCIBKG",40,0)
 .. D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",41,0)
 .. D SNDALRT^GMRCIERR(GMRCLOG,"C") ; alert CAC's to patient errors
"RTN","GMRCIBKG",42,0)
 . ;  v-- if local ICN error after 5 tries, alert CAC's
"RTN","GMRCIBKG",43,0)
 . I $P(GMRCLOG0,U,8)=202,$P(GMRCLOG0,U,7)>4 D  Q
"RTN","GMRCIBKG",44,0)
 .. D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",45,0)
 .. D SNDALRT^GMRCIERR(GMRCLOG,"C") ; alert CAC's to patient errors
"RTN","GMRCIBKG",46,0)
 . ;  v-- resend unknown patient errors after 3 hours
"RTN","GMRCIBKG",47,0)
 . I $P(GMRCLOG0,U,8)=201,GMRCLOG0<$$FMADD^XLFDT($$NOW^XLFDT,,-3) D  Q
"RTN","GMRCIBKG",48,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",49,0)
 . ;  v-- resend local ICN errors after 3 hours
"RTN","GMRCIBKG",50,0)
 . I $P(GMRCLOG0,U,8)=202,GMRCLOG0<$$FMADD^XLFDT($$NOW^XLFDT,,-3) D  Q
"RTN","GMRCIBKG",51,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",52,0)
 . ;  v-- re-process implementation errors
"RTN","GMRCIBKG",53,0)
 . I $P(GMRCLOG0,U,8)>300,$P(GMRCLOG0,U,8)<702 D  Q
"RTN","GMRCIBKG",54,0)
 .. D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",55,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",56,0)
 . ;  v-- if incomplete and no error, alert tech group
"RTN","GMRCIBKG",57,0)
 . I '$P(GMRCLOG0,U,8)!($P(GMRCLOG0,U,8)>902) D  Q
"RTN","GMRCIBKG",58,0)
 .. D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",59,0)
 .. D SNDALRT^GMRCIERR(GMRCLOG,"T")
"RTN","GMRCIBKG",60,0)
 . Q
"RTN","GMRCIBKG",61,0)
 ;
"RTN","GMRCIBKG",62,0)
 ;  v-- set finish param 
"RTN","GMRCIBKG",63,0)
 D EN^XPAR("SYS","GMRC IFC BACKGROUND FINISH",1,$$NOW^XLFDT)
"RTN","GMRCIBKG",64,0)
 ;  v-- start it again one hour after completing
"RTN","GMRCIBKG",65,0)
 D REQUEUE
"RTN","GMRCIBKG",66,0)
 Q
"RTN","GMRCIBKG",67,0)
 ;
"RTN","GMRCIBKG",68,0)
REQUEUE ;task job to start up again one hour after completing
"RTN","GMRCIBKG",69,0)
 N ZTRTN,ZTSK,ZTIO,ZTDESC,ZTDTH
"RTN","GMRCIBKG",70,0)
 S ZTDESC="IF Consults background error processor"
"RTN","GMRCIBKG",71,0)
 S ZTIO=""
"RTN","GMRCIBKG",72,0)
 S ZTRTN="EN^GMRCIBKG"
"RTN","GMRCIBKG",73,0)
 S ZTDTH=$$FMTH^XLFDT($$FMADD^XLFDT($$NOW^XLFDT,,1))
"RTN","GMRCIBKG",74,0)
 D ^%ZTLOAD
"RTN","GMRCIBKG",75,0)
 Q
"RTN","GMRCIBKG",76,0)
DELALRT(MSGLOG) ;delete obsolete alerts for an entry
"RTN","GMRCIBKG",77,0)
 ; Input:
"RTN","GMRCIBKG",78,0)
 ;   MSGLOG = ien from file 123.6
"RTN","GMRCIBKG",79,0)
 ;
"RTN","GMRCIBKG",80,0)
 N XQAID,XQAKILL
"RTN","GMRCIBKG",81,0)
 S XQAID="GMRCIFC,trans error,"_MSGLOG,XQAKILL=0
"RTN","GMRCIBKG",82,0)
 D DELETEA^XQALERT
"RTN","GMRCIBKG",83,0)
 Q
"RTN","GMRCIBKG",84,0)
 ;
"RTN","GMRCIBKG",85,0)
OVERDUE ; write message for alert to tell IRM job is overdue
"RTN","GMRCIBKG",86,0)
 W @IOF
"RTN","GMRCIBKG",87,0)
 W !,"The Inter-facility Consults background job is overdue."
"RTN","GMRCIBKG",88,0)
 W !,"This is likely due to an error while the job runs. It is suggested"
"RTN","GMRCIBKG",89,0)
 W !,"that you check the systems for errors. If the errors are resolved"
"RTN","GMRCIBKG",90,0)
 W !,"the background job will catch up and run normally. There is a "
"RTN","GMRCIBKG",91,0)
 W !,"remote possibility that the GMRC IFC BACKGROUND... parameters have"
"RTN","GMRCIBKG",92,0)
 W !,"been edited and are out of synch."
"RTN","GMRCIBKG",93,0)
 S XQAKILL=0
"RTN","GMRCIBKG",94,0)
 Q
"RTN","GMRCIBKG",95,0)
 ;
"RTN","GMRCIBKG",96,0)
GONOGO() ; determine if background job should run or not
"RTN","GMRCIBKG",97,0)
 ;Output: 
"RTN","GMRCIBKG",98,0)
 ;  1 = go ahead and run
"RTN","GMRCIBKG",99,0)
 ;  0 = don't run for some reason
"RTN","GMRCIBKG",100,0)
 N GMRCQT
"RTN","GMRCIBKG",101,0)
 S GMRCQT=1
"RTN","GMRCIBKG",102,0)
 D
"RTN","GMRCIBKG",103,0)
 . N GMRCBST,GMRCNOW,GMRCBFI
"RTN","GMRCIBKG",104,0)
 . S GMRCBST=$$GET^XPAR("SYS","GMRC IFC BACKGROUND START",1)
"RTN","GMRCIBKG",105,0)
 . I 'GMRCBST Q  ; has never run or needs to
"RTN","GMRCIBKG",106,0)
 . S GMRCNOW=$$NOW^XLFDT
"RTN","GMRCIBKG",107,0)
 . I GMRCBST>GMRCNOW S GMRCQT=0 Q  ;set to future date/time - don't run
"RTN","GMRCIBKG",108,0)
 . S GMRCBFI=$$GET^XPAR("SYS","GMRC IFC BACKGROUND FINISH",1)
"RTN","GMRCIBKG",109,0)
 . I $$FMDIFF^XLFDT(GMRCNOW,GMRCBFI,2)<3600,GMRCBFI>GMRCBST S GMRCQT=0 Q
"RTN","GMRCIBKG",110,0)
 . ;                 ^--ran < 1 hr ago
"RTN","GMRCIBKG",111,0)
 . I $$FMDIFF^XLFDT(GMRCBST,GMRCBFI,2)>4500 D  Q
"RTN","GMRCIBKG",112,0)
 .. ; >1.5 hrs and job not finishing for some reason, alert techies
"RTN","GMRCIBKG",113,0)
 .. N XQA,XQAMSG,XQAROU,XQAID,XQAKILL
"RTN","GMRCIBKG",114,0)
 .. S XQAID="GMRC IFC BKG",XQAKILL=0 D DELETEA^XQALERT
"RTN","GMRCIBKG",115,0)
 .. S XQA("G.IFC TECH ERRORS")=""
"RTN","GMRCIBKG",116,0)
 .. S XQAMSG="IFC Background job overdue."
"RTN","GMRCIBKG",117,0)
 .. S XQAID="GMRC IFC BKG"
"RTN","GMRCIBKG",118,0)
 .. S XQAROU="OVERDUE^GMRCIBKG"
"RTN","GMRCIBKG",119,0)
 .. D SETUP^XQALERT
"RTN","GMRCIBKG",120,0)
 .. Q
"RTN","GMRCIBKG",121,0)
 . Q
"RTN","GMRCIBKG",122,0)
 Q GMRCQT
"RTN","GMRCIBKM")
0^55^B13637196
"RTN","GMRCIBKM",1,0)
GMRCIBKM ;SLC/JFR - MONITOR IFC BKG PARAMS ; 2/14/02 21:22
"RTN","GMRCIBKM",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIBKM",3,0)
EN ; -- main entry point for GMRC IFC MONITOR BKG JOB
"RTN","GMRCIBKM",4,0)
 D REFRESH
"RTN","GMRCIBKM",5,0)
 D EN^VALM("GMRC IF MONITOR BKG JOB")
"RTN","GMRCIBKM",6,0)
 Q
"RTN","GMRCIBKM",7,0)
 ;
"RTN","GMRCIBKM",8,0)
HDR ; -- header code
"RTN","GMRCIBKM",9,0)
 S VALMHDR(1)="Inter-facility Consults background job parameter display"
"RTN","GMRCIBKM",10,0)
 Q
"RTN","GMRCIBKM",11,0)
 ;
"RTN","GMRCIBKM",12,0)
BLD ; Build list for LM display
"RTN","GMRCIBKM",13,0)
 N GMRCBST,GMRCNOW,GMRCBFI,CNT,GMRCBSTE,GMRCBFIE,TXT
"RTN","GMRCIBKM",14,0)
 K ^TMP("GMRCBK",$J)
"RTN","GMRCIBKM",15,0)
 S GMRCNOW=$$NOW^XLFDT
"RTN","GMRCIBKM",16,0)
 S GMRCBST=$$GET^XPAR("SYS","GMRC IFC BACKGROUND START",1)
"RTN","GMRCIBKM",17,0)
 S GMRCBSTE=$S($G(GMRCBST):$$FMTE^XLFDT(GMRCBST),1:"Unknown")
"RTN","GMRCIBKM",18,0)
 S GMRCBFI=$$GET^XPAR("SYS","GMRC IFC BACKGROUND FINISH",1)
"RTN","GMRCIBKM",19,0)
 S GMRCBFIE=$S($G(GMRCBFI):$$FMTE^XLFDT(GMRCBFI),1:"Unknown")
"RTN","GMRCIBKM",20,0)
 S ^TMP("GMRCBK",$J,1,0)=""
"RTN","GMRCIBKM",21,0)
 I GMRCBST>GMRCNOW S TXT(2)="The IFC background job is delayed until: "
"RTN","GMRCIBKM",22,0)
 I '$D(TXT(2)) S TXT(2)="The IFC background job last started:     "
"RTN","GMRCIBKM",23,0)
 S ^TMP("GMRCBK",$J,2,0)=TXT(2)_GMRCBSTE
"RTN","GMRCIBKM",24,0)
 S TXT(3)="The IFC background job last finished:    "
"RTN","GMRCIBKM",25,0)
 S ^TMP("GMRCBK",$J,3,0)=TXT(3)_GMRCBFIE
"RTN","GMRCIBKM",26,0)
 S ^TMP("GMRCBK",$J,4,0)=""
"RTN","GMRCIBKM",27,0)
 I GMRCBST>GMRCNOW  D  Q
"RTN","GMRCIBKM",28,0)
 . S ^TMP("GMRCBK",$J,5,0)="The start parameter for this job has been "
"RTN","GMRCIBKM",29,0)
 . S ^TMP("GMRCBK",$J,6,0)="intentionally set to a future date/time."
"RTN","GMRCIBKM",30,0)
 . S ^TMP("GMRCBK",$J,7,0)=""
"RTN","GMRCIBKM",31,0)
 . S ^TMP("GMRCBK",$J,8,0)="The background job will not start until the "
"RTN","GMRCIBKM",32,0)
 . S ^TMP("GMRCBK",$J,9,0)="date/time indicated in this parameter"
"RTN","GMRCIBKM",33,0)
 I $$FMDIFF^XLFDT(GMRCBST,GMRCBFI,2)>4500 D  Q
"RTN","GMRCIBKM",34,0)
 . S ^TMP("GMRCBK",$J,5,0)="The background job is overdue."
"RTN","GMRCIBKM",35,0)
 . S ^TMP("GMRCBK",$J,6,0)="IRMS should review the system for errors"
"RTN","GMRCIBKM",36,0)
 . S ^TMP("GMRCBK",$J,7,0)="related to the IFC background job."
"RTN","GMRCIBKM",37,0)
 . S ^TMP("GMRCBK",$J,8,0)=" "
"RTN","GMRCIBKM",38,0)
 . S ^TMP("GMRCBK",$J,9,0)="If errors can not be resolved, contact NVS"
"RTN","GMRCIBKM",39,0)
 . S ^TMP("GMRCBK",$J,10,0)="for assistance."
"RTN","GMRCIBKM",40,0)
 I GMRCNOW>GMRCBST,$$FMDIFF^XLFDT(GMRCNOW,GMRCBST,2)>4500 D  Q
"RTN","GMRCIBKM",41,0)
 . S ^TMP("GMRCBK",$J,5,0)="The background job is overdue."
"RTN","GMRCIBKM",42,0)
 . S ^TMP("GMRCBK",$J,6,0)="IRMS should review the system for errors"
"RTN","GMRCIBKM",43,0)
 . S ^TMP("GMRCBK",$J,7,0)="related to the IFC background job."
"RTN","GMRCIBKM",44,0)
 . S ^TMP("GMRCBK",$J,8,0)=" "
"RTN","GMRCIBKM",45,0)
 . S ^TMP("GMRCBK",$J,9,0)="If errors can not be resolved, contact NVS"
"RTN","GMRCIBKM",46,0)
 . S ^TMP("GMRCBK",$J,10,0)="for assistance."
"RTN","GMRCIBKM",47,0)
 D  ; all is well
"RTN","GMRCIBKM",48,0)
 . S ^TMP("GMRCBK",$J,5,0)="The IFC background job is on schedule or is"
"RTN","GMRCIBKM",49,0)
 . S ^TMP("GMRCBK",$J,6,0)="running. "
"RTN","GMRCIBKM",50,0)
 . S ^TMP("GMRCBK",$J,7,0)=""
"RTN","GMRCIBKM",51,0)
 . S ^TMP("GMRCBK",$J,8,0)="It may be delayed by editing the start time"
"RTN","GMRCIBKM",52,0)
 . S ^TMP("GMRCBK",$J,9,0)="to a future date/time using the Edit start "
"RTN","GMRCIBKM",53,0)
 . S ^TMP("GMRCBK",$J,10,0)="time action."
"RTN","GMRCIBKM",54,0)
 Q
"RTN","GMRCIBKM",55,0)
 ;
"RTN","GMRCIBKM",56,0)
EDSTRT ; edit the start parameter
"RTN","GMRCIBKM",57,0)
 ;
"RTN","GMRCIBKM",58,0)
 N DIR,X,Y,DIRUT,DTOUT,DUOUT,DIROUT,GMRCLATE,GMRCSTRT
"RTN","GMRCIBKM",59,0)
 D FULL^VALM1
"RTN","GMRCIBKM",60,0)
 S GMRCLATE=$$FMADD^XLFDT($$NOW^XLFDT,4)
"RTN","GMRCIBKM",61,0)
 S GMRCSTRT=$$GET^XPAR("SYS","GMRC IFC BACKGROUND START",1)
"RTN","GMRCIBKM",62,0)
 S DIR(0)="D0A^"_DT_":"_GMRCLATE_":ETSR"
"RTN","GMRCIBKM",63,0)
 S DIR("A",1)=""
"RTN","GMRCIBKM",64,0)
 S DIR("A")="Next date/time the IFC background job should run: "
"RTN","GMRCIBKM",65,0)
 S DIR("B")=$$FMTE^XLFDT(GMRCSTRT)
"RTN","GMRCIBKM",66,0)
 D ^DIR
"RTN","GMRCIBKM",67,0)
 I '+Y S VALMBCK="R" Q
"RTN","GMRCIBKM",68,0)
 D EN^XPAR("SYS","GMRC IFC BACKGROUND START",1,Y)
"RTN","GMRCIBKM",69,0)
 D REFRESH
"RTN","GMRCIBKM",70,0)
 Q
"RTN","GMRCIBKM",71,0)
 ;
"RTN","GMRCIBKM",72,0)
REFRESH ; rebuild list
"RTN","GMRCIBKM",73,0)
 D BLD
"RTN","GMRCIBKM",74,0)
 S VALMBCK="R",VALMCNT=$O(^TMP("GMRCBK",$J," "),-1)
"RTN","GMRCIBKM",75,0)
 S VALMBG=1
"RTN","GMRCIBKM",76,0)
 Q
"RTN","GMRCIBKM",77,0)
HELP ; -- help code
"RTN","GMRCIBKM",78,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","GMRCIBKM",79,0)
 Q
"RTN","GMRCIBKM",80,0)
 ;
"RTN","GMRCIBKM",81,0)
EXIT ; -- exit code
"RTN","GMRCIBKM",82,0)
 K ^TMP("GMRCBK",$J)
"RTN","GMRCIBKM",83,0)
 S VALMBCK="Q"
"RTN","GMRCIBKM",84,0)
 Q
"RTN","GMRCIBKM",85,0)
 ;
"RTN","GMRCIERR")
0^5^B52568549
"RTN","GMRCIERR",1,0)
GMRCIERR ;SLC/JFR - process IFC message error alert ;11/01/01 00:16
"RTN","GMRCIERR",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIERR",3,0)
EN(GMRCLOG,GMRCDA,GMRCACT,GMRCRPT) ;start here
"RTN","GMRCIERR",4,0)
 K ^TMP("GMRCIERR",$J)
"RTN","GMRCIERR",5,0)
 N GMRCPNM,GMRCACTV,GMRCERR,GMRCRP,GMRCEP,GMRCACTM,GMRCCOM,GMRCSS
"RTN","GMRCIERR",6,0)
 N GMRCPROC,GMRCSITE,GMRCFCN,GMRCPT,GMRCSSN,VAHOW,VAROOT
"RTN","GMRCIERR",7,0)
 I '$D(^GMR(123.6,GMRCLOG,0)) D  Q
"RTN","GMRCIERR",8,0)
 . S ^TMP("GMRCIERR",$J,1,0)="Message log entry no longer exists"
"RTN","GMRCIERR",9,0)
 I $P(^GMR(123.6,GMRCLOG,0),U,4)'=GMRCDA D  Q
"RTN","GMRCIERR",10,0)
 . S ^TMP("GMRCIERR",$J,1,0)="Message log entry and Consult# don't match"
"RTN","GMRCIERR",11,0)
 I $P(^GMR(123.6,GMRCLOG,0),U,5)'=GMRCACT D  Q
"RTN","GMRCIERR",12,0)
 . S ^TMP("GMRCIERR",$J,1,0)="Message log entry & activity# don't match"
"RTN","GMRCIERR",13,0)
 S DFN=$P(^GMR(123,GMRCDA,0),U,2),VAROOT="GMRCPT",VAHOW=1
"RTN","GMRCIERR",14,0)
 D DEM^VADPT
"RTN","GMRCIERR",15,0)
 S GMRCPNM=GMRCPT("NM")
"RTN","GMRCIERR",16,0)
 S GMRCSSN=$P(GMRCPT("SS"),U,2)
"RTN","GMRCIERR",17,0)
 S GMRCACTV=$G(^GMR(123,GMRCDA,40,GMRCACT,0))
"RTN","GMRCIERR",18,0)
 S GMRCRP=$$GET1^DIQ(200,+$P(GMRCACTV,U,4),.01)
"RTN","GMRCIERR",19,0)
 S GMRCEP=$$GET1^DIQ(200,+$P(GMRCACTV,U,5),.01)
"RTN","GMRCIERR",20,0)
 S GMRCACTM=$$FMTE^XLFDT($P(GMRCACTV,U,3))
"RTN","GMRCIERR",21,0)
 S GMRCACTV=$$GET1^DIQ(123.1,$P(GMRCACTV,U,2),.01)
"RTN","GMRCIERR",22,0)
 S GMRCCOM=$O(^GMR(123,GMRCDA,40,GMRCACT,1,0))
"RTN","GMRCIERR",23,0)
 S GMRCSS=$$GET1^DIQ(123.5,+$P(^GMR(123,GMRCDA,0),U,5),.01)
"RTN","GMRCIERR",24,0)
 S GMRCPROC=$$GET1^DIQ(123.3,+$P(^GMR(123,GMRCDA,0),U,8),.01)
"RTN","GMRCIERR",25,0)
 S GMRCFCN=$P(^GMR(123,GMRCDA,0),U,22)
"RTN","GMRCIERR",26,0)
 D F4^XUAF4($$STA^XUAF4($P(^GMR(123,GMRCDA,0),U,23)),.GMRCSITE)
"RTN","GMRCIERR",27,0)
 N LN S LN=1
"RTN","GMRCIERR",28,0)
 S ^TMP("GMRCIERR",$J,LN,0)="An error occurred transmitting the following inter-facility consult ",LN=LN+1
"RTN","GMRCIERR",29,0)
 S ^TMP("GMRCIERR",$J,LN,0)="activity to "_GMRCSITE("NAME")_":",LN=LN+1
"RTN","GMRCIERR",30,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",31,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Consult #: "_GMRCDA,LN=LN+1
"RTN","GMRCIERR",32,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Remote Consult #: "_GMRCFCN,LN=LN+1
"RTN","GMRCIERR",33,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Patient Name: "_GMRCPNM,LN=LN+1
"RTN","GMRCIERR",34,0)
 S ^TMP("GMRCIERR",$J,LN,0)="SSN: "_GMRCSSN,LN=LN+1
"RTN","GMRCIERR",35,0)
 S ^TMP("GMRCIERR",$J,LN,0)="To Service: "_GMRCSS,LN=LN+1
"RTN","GMRCIERR",36,0)
 I $L(GMRCPROC) S ^TMP("GMRCIERR",$J,LN,0)="Procedure: "_GMRCPROC,LN=LN+1
"RTN","GMRCIERR",37,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",38,0)
 I '$D(GMRCRPT) D ACTLG(GMRCDA,GMRCACT,GMRCLOG,.LN)
"RTN","GMRCIERR",39,0)
 Q
"RTN","GMRCIERR",40,0)
ACTLG(GMRCDA,GMRCACT,LOG,LN) ;build activity log entry
"RTN","GMRCIERR",41,0)
 N GMRCCT,TAB,GMRCERR,GMRCDIF
"RTN","GMRCIERR",42,0)
 S TAB="",$P(TAB," ",30)=""
"RTN","GMRCIERR",43,0)
 S GMRCERR=$T(@("ERR"_$P(^GMR(123.6,LOG,0),U,8)_"^GMRCIUTL"))
"RTN","GMRCIERR",44,0)
 S GMRCERR=$S($L(GMRCERR):$P(GMRCERR,";",2),1:"Technical error")
"RTN","GMRCIERR",45,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Activity #: "_GMRCACT,LN=LN+1
"RTN","GMRCIERR",46,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Activity"_$E(TAB,1,17)_"Date/Time/Zone"_$E(TAB,1,6)_"Responsible Person"_$E(TAB,1,2)_"Entered By",LN=LN+1
"RTN","GMRCIERR",47,0)
 S GMRCCT=LN
"RTN","GMRCIERR",48,0)
 D BLDALN^GMRCSLM4(GMRCDA,GMRCACT)
"RTN","GMRCIERR",49,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",50,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",51,0)
 S ^TMP("GMRCIERR",$J,LN,0)="The error was: "_GMRCERR
"RTN","GMRCIERR",52,0)
 M ^TMP("GMRCIERR",$J)=^TMP("GMRCR",$J,"DT")
"RTN","GMRCIERR",53,0)
 K ^TMP("GMRCR",$J,"DT")
"RTN","GMRCIERR",54,0)
 Q
"RTN","GMRCIERR",55,0)
 ;
"RTN","GMRCIERR",56,0)
DIALOG(GMRCDATA) ;ask user what to do based on error and activity
"RTN","GMRCIERR",57,0)
 ;Input:
"RTN","GMRCIERR",58,0)
 ;  GMRCDATA  = XQADATA from alert handler
"RTN","GMRCIERR",59,0)
 ;      in form:   IFC_msg_log#|consult#|activity#
"RTN","GMRCIERR",60,0)
 ;
"RTN","GMRCIERR",61,0)
 ;Output:
"RTN","GMRCIERR",62,0)
 ;  value to set XQAKILL to
"RTN","GMRCIERR",63,0)
 N DIR,X,Y,LN,DUOUT,DTOUT
"RTN","GMRCIERR",64,0)
 D EN($P(GMRCDATA,"|"),$P(GMRCDATA,"|",2),$P(GMRCDATA,"|",3))
"RTN","GMRCIERR",65,0)
 W @IOF
"RTN","GMRCIERR",66,0)
 S LN=0 F  S LN=$O(^TMP("GMRCIERR",$J,LN)) Q:'LN  W !,^(LN,0)
"RTN","GMRCIERR",67,0)
 K ^TMP("GMRCIERR",$J)
"RTN","GMRCIERR",68,0)
 W !
"RTN","GMRCIERR",69,0)
 I $O(^TMP("GMRCIERR",$J," "),-1)<2 Q 0 ;some problem so delete alert
"RTN","GMRCIERR",70,0)
 S DIR(0)="E" D ^DIR
"RTN","GMRCIERR",71,0)
 I $D(DTOUT)!($D(DUOUT)) Q "@"
"RTN","GMRCIERR",72,0)
 W !
"RTN","GMRCIERR",73,0)
 I $O(^GMR(123.6,"AC",$P(GMRCDATA,"|",2),$P(GMRCDATA,"|",3)),-1) D  Q "@"
"RTN","GMRCIERR",74,0)
 . W !,"There is at least one earlier incomplete transaction for this"
"RTN","GMRCIERR",75,0)
 . W !,"consult, all incomplete transactions should be processed in "
"RTN","GMRCIERR",76,0)
 . W !,"order.",!
"RTN","GMRCIERR",77,0)
 . W !,"You can use the List incomplete IFC transactions option to"
"RTN","GMRCIERR",78,0)
 . W !,"locate and process the incomplete transactions for this consult."
"RTN","GMRCIERR",79,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCIERR",80,0)
 S DIR(0)="YA",DIR("B")="N"
"RTN","GMRCIERR",81,0)
 S DIR("A",1)="If you have corrected this problem you may resend this activity!"
"RTN","GMRCIERR",82,0)
 S DIR("A",2)=" "
"RTN","GMRCIERR",83,0)
 S DIR("A")="Do you want to retransmit this? " D ^DIR
"RTN","GMRCIERR",84,0)
 I $G(Y)=1 D  Q 0
"RTN","GMRCIERR",85,0)
 . D TRIGR^GMRCIEVT($P(GMRCDATA,"|",2),$P(GMRCDATA,"|",3))
"RTN","GMRCIERR",86,0)
 K DIR
"RTN","GMRCIERR",87,0)
 W !
"RTN","GMRCIERR",88,0)
 S DIR(0)="YA",DIR("B")="N"
"RTN","GMRCIERR",89,0)
 S DIR("A")="Do you want to delete this alert for yourself? "
"RTN","GMRCIERR",90,0)
 D ^DIR
"RTN","GMRCIERR",91,0)
 I $G(Y)=1 Q 1
"RTN","GMRCIERR",92,0)
 Q "@"
"RTN","GMRCIERR",93,0)
 ;
"RTN","GMRCIERR",94,0)
FOLLUP ;action to take from alert
"RTN","GMRCIERR",95,0)
 S XQAKILL=$$DIALOG(XQADATA)
"RTN","GMRCIERR",96,0)
 I XQAKILL="@" K XQAKILL
"RTN","GMRCIERR",97,0)
 Q
"RTN","GMRCIERR",98,0)
 ;
"RTN","GMRCIERR",99,0)
SNDALRT(GMRCLOG,TYPE) ; send an alert on some errors
"RTN","GMRCIERR",100,0)
 ;Input:
"RTN","GMRCIERR",101,0)
 ; GMRCLOG = IFC MESSAGE LOG entry
"RTN","GMRCIERR",102,0)
 ; TYPE    = "C" for a clinical error, "T" for a technical error
"RTN","GMRCIERR",103,0)
 ;
"RTN","GMRCIERR",104,0)
 N XQA,XQAROU,XQAMSG,XQADATA,XQAID,GROUP,GMRCACT,GMRCDA,GMRCLOG0
"RTN","GMRCIERR",105,0)
 S GMRCLOG0=$G(^GMR(123.6,GMRCLOG,0)) Q:'$L(GMRCLOG0)
"RTN","GMRCIERR",106,0)
 S GMRCDA=$P(GMRCLOG0,U,4) Q:'GMRCDA
"RTN","GMRCIERR",107,0)
 S GMRCACT=$P(GMRCLOG0,U,5) Q:'GMRCACT
"RTN","GMRCIERR",108,0)
 S GROUP=$S(TYPE="C":"G.IFC CLIN ERRORS",1:"G.IFC TECH ERRORS")
"RTN","GMRCIERR",109,0)
 S XQA(GROUP)=""
"RTN","GMRCIERR",110,0)
 S XQAMSG="Failed IFC transaction"
"RTN","GMRCIERR",111,0)
 S XQAROU="FOLLUP^GMRCIERR"
"RTN","GMRCIERR",112,0)
 S XQAID="GMRCIFC,trans error,"_GMRCLOG
"RTN","GMRCIERR",113,0)
 S XQADATA=GMRCLOG_"|"_GMRCDA_"|"_GMRCACT
"RTN","GMRCIERR",114,0)
 D SETUP^XQALERT
"RTN","GMRCIERR",115,0)
 Q
"RTN","GMRCIERR",116,0)
PTERRMSG(GMRCPID,GMRCSTA) ;send IFC patient error to MAS mail group
"RTN","GMRCIERR",117,0)
 ;Input:
"RTN","GMRCIERR",118,0)
 ;  GMRCPID = PID seg from IFC message
"RTN","GMRCIERR",119,0)
 ;  GMRCSTA = station # of site where message originated
"RTN","GMRCIERR",120,0)
 ;
"RTN","GMRCIERR",121,0)
 ;Output:
"RTN","GMRCIERR",122,0)
 ;  mail message containing patient demographics
"RTN","GMRCIERR",123,0)
 ;
"RTN","GMRCIERR",124,0)
 N GMRCGRP,GMRCMSG,GMRCNM,GMRCNAM,GMRCDOB
"RTN","GMRCIERR",125,0)
 N XMERR,GMRCSUB,GMRCSITE,GMRCERR,GMRCICN
"RTN","GMRCIERR",126,0)
 N XMTEXT,XMY,XMDUZ,XMSUB,XMZ,XMMG
"RTN","GMRCIERR",127,0)
 S GMRCNAM=$P(GMRCPID,"|",5)
"RTN","GMRCIERR",128,0)
 S GMRCNM("FAMILY")=$P(GMRCNAM,U),GMRCNM("GIVEN")=$P(GMRCNAM,U,2)
"RTN","GMRCIERR",129,0)
 S GMRCNM("MIDDLE")=$P(GMRCNAM,U,3),GMRCNM("SUFFIX")=$P(GMRCNAM,U,4)
"RTN","GMRCIERR",130,0)
 S GMRCNAM=$$NAMEFMT^XLFNAME(.GMRCNM,"F","CL56Xc")
"RTN","GMRCIERR",131,0)
 S GMRCDOB=$$HL7TFM^XLFDT($P(GMRCPID,"|",7))
"RTN","GMRCIERR",132,0)
 S GMRCDOB=$$FMTE^XLFDT(GMRCDOB)
"RTN","GMRCIERR",133,0)
 S GMRCICN=+$P(GMRCPID,"|",2)
"RTN","GMRCIERR",134,0)
 D F4^XUAF4(GMRCSTA,.GMRCSITE)
"RTN","GMRCIERR",135,0)
 S GMRCMSG(1,0)="An Inter-facility Consult for the following patient has been requested."
"RTN","GMRCIERR",136,0)
 S GMRCMSG(2,0)="The patient has either never been registered at your facility or the MPI"
"RTN","GMRCIERR",137,0)
 S GMRCMSG(3,0)="information for this patient at your site does not match that from the"
"RTN","GMRCIERR",138,0)
 S GMRCMSG(4,0)="requesting site. Please resolve this problem so that the request may be "
"RTN","GMRCIERR",139,0)
 S GMRCMSG(5,0)="processed at your site.",GMRCMSG(6,0)=" "
"RTN","GMRCIERR",140,0)
 S GMRCMSG(7,0)="Patient demographics from "_GMRCSITE("NAME")
"RTN","GMRCIERR",141,0)
 S GMRCMSG(8,0)="   Patient name: "_GMRCNAM
"RTN","GMRCIERR",142,0)
 S GMRCMSG(9,0)="            SSN: "_$P(GMRCPID,"|",19)
"RTN","GMRCIERR",143,0)
 S GMRCMSG(10,0)="  Date of birth: "_GMRCDOB
"RTN","GMRCIERR",144,0)
 S GMRCMSG(11,0)="            Sex: "_$P(GMRCPID,"|",8)
"RTN","GMRCIERR",145,0)
 S GMRCMSG(12,0)="     Remote ICN: "_GMRCICN
"RTN","GMRCIERR",146,0)
 ;
"RTN","GMRCIERR",147,0)
 S XMY("G.IFC PATIENT ERROR MESSAGES")=""
"RTN","GMRCIERR",148,0)
 S XMSUB="Incoming IFC patient error, "_GMRCNAM
"RTN","GMRCIERR",149,0)
 S XMDUZ="Consult/Request Tracking Package"
"RTN","GMRCIERR",150,0)
 S XMTEXT="GMRCMSG("
"RTN","GMRCIERR",151,0)
 D ^XMD
"RTN","GMRCIERR",152,0)
 Q
"RTN","GMRCIERR",153,0)
 ;
"RTN","GMRCIERR",154,0)
PTMPIER(GMRCDFN) ;send IFC local MPI error to MAS mail group
"RTN","GMRCIERR",155,0)
 ;Input:
"RTN","GMRCIERR",156,0)
 ;  GMRCDFN = DFN from file 2 of patient with MPI problem
"RTN","GMRCIERR",157,0)
 ;
"RTN","GMRCIERR",158,0)
 ;Output:
"RTN","GMRCIERR",159,0)
 ;  mail message containing patient demographics
"RTN","GMRCIERR",160,0)
 ;
"RTN","GMRCIERR",161,0)
 N DFN,GMRCPT,GMRCMSG,VAHOW,VAROOT
"RTN","GMRCIERR",162,0)
 N XMTEXT,XMY,XMDUZ,XMSUB,XMZ,XMMG
"RTN","GMRCIERR",163,0)
 S DFN=GMRCDFN,VAHOW=1,VAROOT="GMRCPT"
"RTN","GMRCIERR",164,0)
 D DEM^VADPT
"RTN","GMRCIERR",165,0)
 S GMRCMSG(1,0)="An Inter-facility Consult for the following patient has been requested."
"RTN","GMRCIERR",166,0)
 S GMRCMSG(2,0)="The PATIENT file either contains a local ICN or the patient information for "
"RTN","GMRCIERR",167,0)
 S GMRCMSG(3,0)="this patient at your site does not match that from the VA MPI."
"RTN","GMRCIERR",168,0)
 S GMRCMSG(4,0)="Please resolve this problem so that the request may be processed at your site."
"RTN","GMRCIERR",169,0)
 S GMRCMSG(5,0)=" "
"RTN","GMRCIERR",170,0)
 S GMRCMSG(6,0)="   Patient name: "_GMRCPT("NM")
"RTN","GMRCIERR",171,0)
 S GMRCMSG(7,0)="            SSN: "_$P(GMRCPT("SS"),U,2)
"RTN","GMRCIERR",172,0)
 S GMRCMSG(8,0)="  Date of birth: "_$P(GMRCPT("DB"),U,2)
"RTN","GMRCIERR",173,0)
 S GMRCMSG(9,0)="            Sex: "_$P(GMRCPT("SX"),U,2)
"RTN","GMRCIERR",174,0)
 ;
"RTN","GMRCIERR",175,0)
 S XMY("G.IFC PATIENT ERROR MESSAGES")=""
"RTN","GMRCIERR",176,0)
 S XMSUB="Outgoing IFC patient error, "_GMRCPT("NM")
"RTN","GMRCIERR",177,0)
 S XMDUZ="Consult/Request Tracking Package"
"RTN","GMRCIERR",178,0)
 S XMTEXT="GMRCMSG("
"RTN","GMRCIERR",179,0)
 D ^XMD
"RTN","GMRCIERR",180,0)
 Q
"RTN","GMRCIERR",181,0)
 ;
"RTN","GMRCIEV1")
0^6^B30337425
"RTN","GMRCIEV1",1,0)
GMRCIEV1 ;SLC/JFR - IFC EVENTS CONT'D ;10/30/01 23:19
"RTN","GMRCIEV1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIEV1",3,0)
 Q  ;no-no-no
"RTN","GMRCIEV1",4,0)
RESUB(GMRCDA,GMRCACT) ;build HL7 msg with edits from resubit
"RTN","GMRCIEV1",5,0)
 ;Input:
"RTN","GMRCIEV1",6,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",7,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",8,0)
 ;
"RTN","GMRCIEV1",9,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEV1",10,0)
 S SEG=1
"RTN","GMRCIEV1",11,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEV1",12,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEV1",13,0)
 D  I $D(GMRCIQT) D NOMPI^GMRCIEVT(GMRCDA,GMRCACT) Q  ;build PID seg
"RTN","GMRCIEV1",14,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEV1",15,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",16,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEV1",17,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",18,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEV1",19,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",20,0)
 . Q
"RTN","GMRCIEV1",21,0)
 ;
"RTN","GMRCIEV1",22,0)
 ;build ORC seg based on GMRCACT
"RTN","GMRCIEV1",23,0)
 S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,"XO","IP",GMRCACT)
"RTN","GMRCIEV1",24,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",25,0)
 ;
"RTN","GMRCIEV1",26,0)
 ; include Inpatient or Outpatient
"RTN","GMRCIEV1",27,0)
 S ^TMP("HLS",$J,SEG)=$$OBR^GMRCISG1(GMRCDA,GMRCACT)
"RTN","GMRCIEV1",28,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",29,0)
 ;
"RTN","GMRCIEV1",30,0)
 D  ;load up reason for request
"RTN","GMRCIEV1",31,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEV1",32,0)
 . D OBXWP^GMRCISEG(GMRCDA,"XO",GMRCACT,$NA(^TMP("GMRCRFR",$J)))
"RTN","GMRCIEV1",33,0)
 . I '$D(^TMP("GMRCRFR",$J)) Q
"RTN","GMRCIEV1",34,0)
 . N I S I=0
"RTN","GMRCIEV1",35,0)
 . F  S I=$O(^TMP("GMRCRFR",$J,I)) Q:'I  D
"RTN","GMRCIEV1",36,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCRFR",$J,I)
"RTN","GMRCIEV1",37,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",38,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEV1",39,0)
 . Q
"RTN","GMRCIEV1",40,0)
 D  ;prov DX changed, send it
"RTN","GMRCIEV1",41,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXPD^GMRCISG1(GMRCDA)
"RTN","GMRCIEV1",42,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",43,0)
 ;
"RTN","GMRCIEV1",44,0)
 D  ;send ed-res comment and file as is
"RTN","GMRCIEV1",45,0)
 . N I
"RTN","GMRCIEV1",46,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",47,0)
 . D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEV1",48,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEV1",49,0)
 . S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEV1",50,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEV1",51,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",52,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",53,0)
 . Q
"RTN","GMRCIEV1",54,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEV1",55,0)
 S HLL("LINKS",1)=$$ROUTE^GMRCIEVT(GMRCDA) I '$L(HLL("LINKS",1)) D  Q
"RTN","GMRCIEV1",56,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,"",903) ;log error
"RTN","GMRCIEV1",57,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEV1",58,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEV1",59,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEV1",60,0)
 Q
"RTN","GMRCIEV1",61,0)
 ;
"RTN","GMRCIEV1",62,0)
SF(GMRCDA,GMRCACT) ;send SIG FINDING update
"RTN","GMRCIEV1",63,0)
 ;Input:
"RTN","GMRCIEV1",64,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",65,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",66,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT,GMRCOS
"RTN","GMRCIEV1",67,0)
 S SEG=1
"RTN","GMRCIEV1",68,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEV1",69,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEV1",70,0)
 D  I $D(GMRCIQT) D NOMPI^GMRCIEVT(GMRCDA,GMRCACT) Q  ;build PID seg
"RTN","GMRCIEV1",71,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEV1",72,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",73,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEV1",74,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",75,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEV1",76,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",77,0)
 . Q
"RTN","GMRCIEV1",78,0)
 ;
"RTN","GMRCIEV1",79,0)
 ;build ORC seg based on GMRCACT
"RTN","GMRCIEV1",80,0)
 S GMRCOS=$S($P(^GMR(123,GMRCDA,0),U,12)="2":"CM",1:"IP")
"RTN","GMRCIEV1",81,0)
 S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,"RE","CM",GMRCACT)
"RTN","GMRCIEV1",82,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",83,0)
 I $O(^GMR(123,GMRCDA,40,GMRCACT,1,0)) D  ;load up comment to send
"RTN","GMRCIEV1",84,0)
 . D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEV1",85,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEV1",86,0)
 . N I S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEV1",87,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEV1",88,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",89,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",90,0)
 . Q
"RTN","GMRCIEV1",91,0)
 S ^TMP("HLS",$J,SEG)=$$OBXSF^GMRCISEG(GMRCDA),SEG=SEG+1
"RTN","GMRCIEV1",92,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEV1",93,0)
 S HLL("LINKS",1)=$$ROUTE^GMRCIEVT(GMRCDA) I '$L(HLL("LINKS",1)) D  Q
"RTN","GMRCIEV1",94,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,"",903) ;log error
"RTN","GMRCIEV1",95,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEV1",96,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEV1",97,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEV1",98,0)
 Q
"RTN","GMRCIEV1",99,0)
 ;
"RTN","GMRCIEV1",100,0)
FWD(GMRCDA,GMRCACT) ;bld HL7 msg upon FWD action
"RTN","GMRCIEV1",101,0)
 ;Input:
"RTN","GMRCIEV1",102,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",103,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",104,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT,GMRCOS
"RTN","GMRCIEV1",105,0)
 S SEG=1
"RTN","GMRCIEV1",106,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEV1",107,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEV1",108,0)
 D  I $D(GMRCIQT) D NOMPI^GMRCIEVT(GMRCDA,GMRCACT) Q  ;build PID seg
"RTN","GMRCIEV1",109,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEV1",110,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",111,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEV1",112,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",113,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEV1",114,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",115,0)
 . Q
"RTN","GMRCIEV1",116,0)
 ;
"RTN","GMRCIEV1",117,0)
 ;build ORC seg based on GMRCACT
"RTN","GMRCIEV1",118,0)
 S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,"XX","IP",GMRCACT)
"RTN","GMRCIEV1",119,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",120,0)
 S ^TMP("HLS",$J,SEG)=$$OBR^GMRCISG1(GMRCDA,GMRCACT),SEG=SEG+1
"RTN","GMRCIEV1",121,0)
 I $O(^GMR(123,GMRCDA,40,GMRCACT,1,0)) D  ;load up comment to send
"RTN","GMRCIEV1",122,0)
 . D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEV1",123,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEV1",124,0)
 . N I S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEV1",125,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEV1",126,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",127,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",128,0)
 . Q
"RTN","GMRCIEV1",129,0)
 S ^TMP("HLS",$J,SEG)=$$OBXSF^GMRCISEG(GMRCDA),SEG=SEG+1
"RTN","GMRCIEV1",130,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEV1",131,0)
 S HLL("LINKS",1)=$$ROUTE^GMRCIEVT(GMRCDA) I '$L(HLL("LINKS",1)) D  Q
"RTN","GMRCIEV1",132,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,"",903) ;log error
"RTN","GMRCIEV1",133,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEV1",134,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEV1",135,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEV1",136,0)
 Q
"RTN","GMRCIEV1",137,0)
 ;
"RTN","GMRCIEV1",138,0)
FWD2IFC(GMRCDA,GMRCACT) ;pkg up and send request upon fwd'ing into IFC serv
"RTN","GMRCIEV1",139,0)
 ;Input:
"RTN","GMRCIEV1",140,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",141,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",142,0)
 N GMRCACTN
"RTN","GMRCIEV1",143,0)
 I '$P(^GMR(123,GMRCDA,0),U,22),'$D(^GMR(123.6,"C",GMRCDA)) D  Q
"RTN","GMRCIEV1",144,0)
 . D NW^GMRCIEVT(GMRCDA)
"RTN","GMRCIEV1",145,0)
 . S GMRCACTN=1
"RTN","GMRCIEV1",146,0)
 . F  S GMRCACTN=$O(^GMR(123,GMRCDA,40,GMRCACTN)) Q:'GMRCACTN  D
"RTN","GMRCIEV1",147,0)
 .. D TRIGR^GMRCIEVT(GMRCDA,GMRCACTN)
"RTN","GMRCIEV1",148,0)
 D FWD(GMRCDA,GMRCACT)
"RTN","GMRCIEV1",149,0)
 Q
"RTN","GMRCIEVT")
0^7^B46854845
"RTN","GMRCIEVT",1,0)
GMRCIEVT ;SLC/JFR - process events and build HL7 message; 1/30/01 19:18
"RTN","GMRCIEVT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIEVT",3,0)
 ;
"RTN","GMRCIEVT",4,0)
 Q  ;don't start at the top
"RTN","GMRCIEVT",5,0)
TRIGR(IEN,ACTN) ;determine what action was taken on IFC and call event point
"RTN","GMRCIEVT",6,0)
 ;Input: 
"RTN","GMRCIEVT",7,0)
 ;  IEN   = consult number from file 123
"RTN","GMRCIEVT",8,0)
 ;  ACT   = ien in 40 multiple corresponding to activity
"RTN","GMRCIEVT",9,0)
 ;
"RTN","GMRCIEVT",10,0)
 N ACTYPE
"RTN","GMRCIEVT",11,0)
 S ACTYPE=$P(^GMR(123,IEN,40,ACTN,0),U,2)
"RTN","GMRCIEVT",12,0)
 I 'ACTYPE Q
"RTN","GMRCIEVT",13,0)
 ;
"RTN","GMRCIEVT",14,0)
 ; check bkgrd job and run if overdue
"RTN","GMRCIEVT",15,0)
 I '$D(ZTQUEUED),$$GONOGO^GMRCIBKG D
"RTN","GMRCIEVT",16,0)
 . N ZTQUEUED S ZTQUEUED=1 D EN^GMRCIBKG ;remove ZTQUEUED? 
"RTN","GMRCIEVT",17,0)
 ;
"RTN","GMRCIEVT",18,0)
 I $O(^GMR(123.6,"AC",IEN,ACTN),-1) D  Q  ;earlier pending activities
"RTN","GMRCIEVT",19,0)
 . I ACTYPE=22 Q  ; not a trigger or not done here
"RTN","GMRCIEVT",20,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",902) ;msg log entry but no msg sent
"RTN","GMRCIEVT",21,0)
 I ACTYPE=2 D NW(IEN) Q  ;send new order
"RTN","GMRCIEVT",22,0)
 I ACTYPE=9!(ACTYPE=14) D RSLT(IEN,ACTN) Q  ;inc report or add'l notes
"RTN","GMRCIEVT",23,0)
 I ACTYPE=10,$P(^GMR(123,IEN,40,ACTN,0),U,9) D RSLT(IEN,ACTN) Q  ;comp
"RTN","GMRCIEVT",24,0)
 I ACTYPE=12 D RSLT(IEN,ACTN) Q  ;dis-associate result
"RTN","GMRCIEVT",25,0)
 I ACTYPE=11 D RESUB^GMRCIEV1(IEN,ACTN) Q  ;ed/resubmit
"RTN","GMRCIEVT",26,0)
 I ACTYPE=13 D RSLT(IEN,ACTN) Q  ; addendum added
"RTN","GMRCIEVT",27,0)
 I ACTYPE=4 D SF^GMRCIEV1(IEN,ACTN) Q  ; sig finding update
"RTN","GMRCIEVT",28,0)
 I ACTYPE=22 Q  ;printed to is not a trigger
"RTN","GMRCIEVT",29,0)
 I ACTYPE=17 D FWD^GMRCIEV1(IEN,ACTN) Q  ; forward
"RTN","GMRCIEVT",30,0)
 I ACTYPE=25 D FWD2IFC^GMRCIEV1(IEN,ACTN) Q  ; FWD into an IFC service
"RTN","GMRCIEVT",31,0)
 D GENUPD(IEN,ACTN) ;all other updates
"RTN","GMRCIEVT",32,0)
 Q
"RTN","GMRCIEVT",33,0)
NW(GMRCDA) ;build new order message for IFC
"RTN","GMRCIEVT",34,0)
 ; Input:
"RTN","GMRCIEVT",35,0)
 ;   GMRCDA  = ien from file 123
"RTN","GMRCIEVT",36,0)
 ;
"RTN","GMRCIEVT",37,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",38,0)
 S SEG=1
"RTN","GMRCIEVT",39,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",40,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",41,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,1) Q  ;build PID seg if not a local ICN
"RTN","GMRCIEVT",42,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",43,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",44,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",45,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",46,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",47,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",48,0)
 . Q
"RTN","GMRCIEVT",49,0)
 S ^TMP("HLS",$J,SEG)=$$NWORC^GMRCISG1(GMRCDA) ; get ORC for new ord
"RTN","GMRCIEVT",50,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",51,0)
 S ^TMP("HLS",$J,SEG)=$$OBR^GMRCISG1(GMRCDA) ;get OBR segment
"RTN","GMRCIEVT",52,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",53,0)
 D  ;build reason for request into OBX segment(s)
"RTN","GMRCIEVT",54,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEVT",55,0)
 . D OBXWP^GMRCISEG(GMRCDA,"NW",1,$NA(^TMP("GMRCRFR",$J)))
"RTN","GMRCIEVT",56,0)
 . I '$D(^TMP("GMRCRFR",$J)) Q
"RTN","GMRCIEVT",57,0)
 . N I S I=0
"RTN","GMRCIEVT",58,0)
 . F  S I=$O(^TMP("GMRCRFR",$J,I)) Q:'I  D
"RTN","GMRCIEVT",59,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCRFR",$J,I)
"RTN","GMRCIEVT",60,0)
 .. S SEG=SEG+1
"RTN","GMRCIEVT",61,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEVT",62,0)
 . Q
"RTN","GMRCIEVT",63,0)
 S ^TMP("HLS",$J,SEG)=$$OBXPD^GMRCISG1(GMRCDA) ; build prov DX in OBX
"RTN","GMRCIEVT",64,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",65,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always send local time zone
"RTN","GMRCIEVT",66,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",67,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",68,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",69,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"")
"RTN","GMRCIEVT",70,0)
 D LOGMSG^GMRCIUTL(GMRCDA,1,+GMRC773,ERR)
"RTN","GMRCIEVT",71,0)
 Q
"RTN","GMRCIEVT",72,0)
 ;
"RTN","GMRCIEVT",73,0)
GENUPD(GMRCDA,GMRCACT) ;build msg and send upon REC, SC or ADD CMT event
"RTN","GMRCIEVT",74,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",75,0)
 S SEG=1
"RTN","GMRCIEVT",76,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",77,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",78,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,GMRCACT) Q  ;build PID seg if nat'l ICN
"RTN","GMRCIEVT",79,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",80,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",81,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",82,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",83,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",84,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",85,0)
 . Q
"RTN","GMRCIEVT",86,0)
 D  ;build ORC seg based on GMRCACT
"RTN","GMRCIEVT",87,0)
 . N ACTVT,OC,OS
"RTN","GMRCIEVT",88,0)
 . S ACTVT=$P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2) ; get activity
"RTN","GMRCIEVT",89,0)
 . ;set order control for ORC seg:
"RTN","GMRCIEVT",90,0)
 . ;   v-- IP=cmt RE=adm comp OD=DC OC=cancel SC=sch or receive
"RTN","GMRCIEVT",91,0)
 . S OC=$S(ACTVT=20:"IP",ACTVT=10:"RE",ACTVT=6:"OD",ACTVT=19:"OC",1:"SC")
"RTN","GMRCIEVT",92,0)
 . ;set order status for ORC seg:
"RTN","GMRCIEVT",93,0)
 . ;   v-- SC=sch RE=adm comp DC=DC CA=cancel IP=cmt or receive
"RTN","GMRCIEVT",94,0)
 . S OS=$S(ACTVT=8:"SC",ACTVT=10:"CM",ACTVT=6:"DC",ACTVT=19:"CA",1:"IP")
"RTN","GMRCIEVT",95,0)
 . S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,OC,OS,GMRCACT)
"RTN","GMRCIEVT",96,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",97,0)
 . Q
"RTN","GMRCIEVT",98,0)
 I $L($P(^GMR(123,GMRCDA,0),U,19)) D  ;send sig findings
"RTN","GMRCIEVT",99,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXSF^GMRCISEG(GMRCDA)
"RTN","GMRCIEVT",100,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",101,0)
 I $O(^GMR(123,GMRCDA,40,GMRCACT,1,0)) D  ;load up a comment if there
"RTN","GMRCIEVT",102,0)
 . N I
"RTN","GMRCIEVT",103,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEVT",104,0)
 . I $P(^TMP("HLS",$J,SEG-1),"|",2)'["O" D 
"RTN","GMRCIEVT",105,0)
 .. D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEVT",106,0)
 . I $P(^TMP("HLS",$J,SEG-1),"|",2)["O" D
"RTN","GMRCIEVT",107,0)
 .. N GMRCMT
"RTN","GMRCIEVT",108,0)
 .. D NTE^GMRCISEG(GMRCDA,GMRCACT,.GMRCMT)
"RTN","GMRCIEVT",109,0)
 .. I $D(GMRCMT) M ^TMP("GMRCMT",$J)=GMRCMT
"RTN","GMRCIEVT",110,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEVT",111,0)
 . S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEVT",112,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEVT",113,0)
 .. S SEG=SEG+1
"RTN","GMRCIEVT",114,0)
 . Q
"RTN","GMRCIEVT",115,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEVT",116,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",117,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",118,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",119,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEVT",120,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEVT",121,0)
 Q
"RTN","GMRCIEVT",122,0)
 ;
"RTN","GMRCIEVT",123,0)
RSLT(GMRCDA,GMRCACT) ;attach or dis-associate results and update
"RTN","GMRCIEVT",124,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",125,0)
 S SEG=1
"RTN","GMRCIEVT",126,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",127,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",128,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,GMRCACT) Q  ;build PID seg if nat'l ICN
"RTN","GMRCIEVT",129,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",130,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",131,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",132,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",133,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",134,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",135,0)
 . Q
"RTN","GMRCIEVT",136,0)
 D  ;build ORC seg based on GMRCACT
"RTN","GMRCIEVT",137,0)
 . N ACTVT,OC,OS
"RTN","GMRCIEVT",138,0)
 . S ACTVT=$P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2) ; get activity
"RTN","GMRCIEVT",139,0)
 . S OC="RE"
"RTN","GMRCIEVT",140,0)
 . S OS=$S(ACTVT=9:"A",ACTVT=12:"IP",1:"CM") ; A=part res CM=comp IP=dis
"RTN","GMRCIEVT",141,0)
 . S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,OC,OS,GMRCACT)
"RTN","GMRCIEVT",142,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",143,0)
 I $P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2)'=99 D
"RTN","GMRCIEVT",144,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXRSLT^GMRCISEG(GMRCDA,GMRCACT)
"RTN","GMRCIEVT",145,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",146,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEVT",147,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",148,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",149,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",150,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEVT",151,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEVT",152,0)
 Q
"RTN","GMRCIEVT",153,0)
 ;
"RTN","GMRCIEVT",154,0)
NOMPI(GMRCIEN,GMRCACTV) ;process MPI exception
"RTN","GMRCIEVT",155,0)
 N GMRCDFN
"RTN","GMRCIEVT",156,0)
 S GMRCDFN=$P(^GMR(123,GMRCIEN,0),U,2)
"RTN","GMRCIEVT",157,0)
 D PTMPIER^GMRCIERR(GMRCDFN) ; send msg to local group for ICN problem
"RTN","GMRCIEVT",158,0)
 D LOGMSG^GMRCIUTL(GMRCIEN,GMRCACTV,,202) ;put inc. entry in MSG log
"RTN","GMRCIEVT",159,0)
 Q
"RTN","GMRCIEVT",160,0)
 ;
"RTN","GMRCIEVT",161,0)
ROUTE(GMRCDA) ; determine correct routing for IFC msg
"RTN","GMRCIEVT",162,0)
 ; Input:
"RTN","GMRCIEVT",163,0)
 ;  GMRCDA = ien from file 123
"RTN","GMRCIEVT",164,0)
 ;
"RTN","GMRCIEVT",165,0)
 ; Output:
"RTN","GMRCIEVT",166,0)
 ;   the logical link to send the message to in format
"RTN","GMRCIEVT",167,0)
 ;     "GMRC IFC SUBSC^VHAHIN"
"RTN","GMRCIEVT",168,0)
 ;
"RTN","GMRCIEVT",169,0)
 N SITE,GMRCLINK,STA
"RTN","GMRCIEVT",170,0)
 S SITE=$P(^GMR(123,GMRCDA,0),U,23) I 'SITE Q "" ;no ROUTING FACILITY
"RTN","GMRCIEVT",171,0)
 S STA=$$STA^XUAF4(SITE)
"RTN","GMRCIEVT",172,0)
 I '$L(STA) Q "" ;can't find station num for that site
"RTN","GMRCIEVT",173,0)
 D LINK^HLUTIL3(STA,.GMRCLINK,"I")
"RTN","GMRCIEVT",174,0)
 S GMRCLINK=$O(GMRCLINK(0)) I 'GMRCLINK Q "" ; no link for that site
"RTN","GMRCIEVT",175,0)
 S GMRCLINK=GMRCLINK(GMRCLINK) I '$L(GMRCLINK) Q "" ;no link name
"RTN","GMRCIEVT",176,0)
 Q "GMRC IFC SUBSC^"_GMRCLINK
"RTN","GMRCILKP")
0^44^B5121604
"RTN","GMRCILKP",1,0)
GMRCILKP ;SLC/JFR - LOOK UP IFC BY REMOTE CONS #; 1/2/02 14:34
"RTN","GMRCILKP",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCILKP",3,0)
EN ; start here
"RTN","GMRCILKP",4,0)
 N DIR,DIRUT,DIROUT,DTOUT,DUOUT,X,Y,GMRCSIT,GMRCO,DFN,GMRCREMC
"RTN","GMRCILKP",5,0)
 N VALMBCK,VALMCNT,GMRCA,GMRCDIF,GMRCDVL,GMRCLOC,GMRCWARD,GMRCX,GMRCDISP
"RTN","GMRCILKP",6,0)
 S DIR(0)="PO^4:EMQ"
"RTN","GMRCILKP",7,0)
 S DIR("S")="I $$STA^XUAF4(+Y)=+$$STA^XUAF4(+Y)"
"RTN","GMRCILKP",8,0)
 S DIR("A")="Choose the facility to which the remote entry belongs"
"RTN","GMRCILKP",9,0)
 D ^DIR
"RTN","GMRCILKP",10,0)
 I $D(DIRUT) Q
"RTN","GMRCILKP",11,0)
 S GMRCSIT=+Y
"RTN","GMRCILKP",12,0)
 K X,Y,DIR
"RTN","GMRCILKP",13,0)
 S DIR(0)="NO^1:9999999"
"RTN","GMRCILKP",14,0)
 S DIR("A")="Select the Remote Consult Entry #"
"RTN","GMRCILKP",15,0)
 D ^DIR
"RTN","GMRCILKP",16,0)
 I $D(DIRUT) Q
"RTN","GMRCILKP",17,0)
 S GMRCREMC=Y
"RTN","GMRCILKP",18,0)
 S GMRCO=$O(^GMR(123,"AIFC",GMRCSIT,GMRCREMC,0))
"RTN","GMRCILKP",19,0)
 I '$G(GMRCO) D  G EN
"RTN","GMRCILKP",20,0)
 . W $C(7),!!
"RTN","GMRCILKP",21,0)
 . W "No Consult on file for the selected site with that remote number!"
"RTN","GMRCILKP",22,0)
 . W !!
"RTN","GMRCILKP",23,0)
 . K DIR
"RTN","GMRCILKP",24,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCILKP",25,0)
 . W !,"Select again"
"RTN","GMRCILKP",26,0)
 S DFN=$P(^GMR(123,GMRCO,0),U,2)
"RTN","GMRCILKP",27,0)
 K DIR
"RTN","GMRCILKP",28,0)
 S DIR(0)="S^B:brief;D:detailed"
"RTN","GMRCILKP",29,0)
 S DIR("A")="Display type"
"RTN","GMRCILKP",30,0)
 S DIR("B")="B"
"RTN","GMRCILKP",31,0)
 D ^DIR
"RTN","GMRCILKP",32,0)
 I $D(DTOUT)!($D(DUOUT)) Q
"RTN","GMRCILKP",33,0)
 S GMRCDISP=Y
"RTN","GMRCILKP",34,0)
 I GMRCDISP="B" D  G EN
"RTN","GMRCILKP",35,0)
 . N GMRCST,GMRCSS,GMRCPNM,GMRCSN
"RTN","GMRCILKP",36,0)
 . D DEM^GMRCU
"RTN","GMRCILKP",37,0)
 . S GMRCSN=$P(GMRCSN,"-",3)
"RTN","GMRCILKP",38,0)
 . S GMRCPNM=$E(GMRCPNM,1,23)
"RTN","GMRCILKP",39,0)
 . S GMRCST=$$GET1^DIQ(100.01,$P(^GMR(123,GMRCO,0),U,12),.1)
"RTN","GMRCILKP",40,0)
 . S GMRCSS=$E($$SVC^GMRCAU(GMRCO),1,22)
"RTN","GMRCILKP",41,0)
 . W !!,"Local cslt#   To Service",?37,"Status   Patient",?74,"SSN"
"RTN","GMRCILKP",42,0)
 . W !,$$REPEAT^XLFSTR("-",79)
"RTN","GMRCILKP",43,0)
 . W !,GMRCO,?14,GMRCSS,?39,GMRCST,?46,GMRCPNM,?74,GMRCSN,!!
"RTN","GMRCILKP",44,0)
 . K DIR S DIR(0)="E" D ^DIR
"RTN","GMRCILKP",45,0)
 . W !,"Select again"
"RTN","GMRCILKP",46,0)
 . D ^GMRCREXT
"RTN","GMRCILKP",47,0)
 I GMRCDISP="D" D  G EN
"RTN","GMRCILKP",48,0)
 . D DT^GMRCSLM2(GMRCO)
"RTN","GMRCILKP",49,0)
 . I '$D(^TMP("GMRCR",$J,"DT")) W !,"Error finding details!" Q
"RTN","GMRCILKP",50,0)
 . M ^TMP("GMRCR",$J,"DTLIST")=^TMP("GMRCR",$J,"DT")
"RTN","GMRCILKP",51,0)
 . S VALMCNT=$O(^TMP("GMRCR",$J,"DTLIST"," "),-1)
"RTN","GMRCILKP",52,0)
 . D EN^VALM("GMRC DETAILED DISPLAY")
"RTN","GMRCILKP",53,0)
 . D ^GMRCREXT
"RTN","GMRCILKP",54,0)
 Q
"RTN","GMRCIMSG")
0^8^B21948665
"RTN","GMRCIMSG",1,0)
GMRCIMSG ;SLC/JFR - IFC MESSAGE HANDLING ROUTINE; 10/26/01 00:23
"RTN","GMRCIMSG",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIMSG",3,0)
 ;
"RTN","GMRCIMSG",4,0)
 Q  ;don't start at the top
"RTN","GMRCIMSG",5,0)
IN ;process incoming message and save segments to ^TMP(
"RTN","GMRCIMSG",6,0)
 K ^TMP("GMRCIF",$J)
"RTN","GMRCIMSG",7,0)
 N HLNODE,SEG,I,GMRCIER  ;production code
"RTN","GMRCIMSG",8,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","GMRCIMSG",9,0)
 . I $P(HLNODE,"|")="OBX" D  ;multiple segs for OBX
"RTN","GMRCIMSG",10,0)
 .. S ^TMP("GMRCIF",$J,"OBX",$P(HLNODE,"|",2),$P(HLNODE,"|",5))=$E(HLNODE,5,999)
"RTN","GMRCIMSG",11,0)
 . I $P(HLNODE,"|")="NTE" D  ; may be multiple NTE's
"RTN","GMRCIMSG",12,0)
 .. S ^TMP("GMRCIF",$J,"NTE",$P(HLNODE,"|",2))=$E(HLNODE,5,999)
"RTN","GMRCIMSG",13,0)
 . I "OBXNTE"'[$P(HLNODE,"|") D  ;all other segs are single
"RTN","GMRCIMSG",14,0)
 .. S ^TMP("GMRCIF",$J,$P(HLNODE,"|"))=$E(HLNODE,5,999)
"RTN","GMRCIMSG",15,0)
 . Q
"RTN","GMRCIMSG",16,0)
 ;
"RTN","GMRCIMSG",17,0)
 I '$$VALMSG(^TMP("GMRCIF",$J,"ORC")) D EX Q  ;chk msg for valid cslt #'s
"RTN","GMRCIMSG",18,0)
 ;
"RTN","GMRCIMSG",19,0)
 I $P(^TMP("GMRCIF",$J,"ORC"),"|")="NW" D  D EX Q
"RTN","GMRCIMSG",20,0)
 . I $P(^TMP("GMRCIF",$J,"ORC"),"|",2)["TST1234" D  D EX Q  ;testing impl
"RTN","GMRCIMSG",21,0)
 .. D TST^GMRCIAC2($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",22,0)
 . D NW^GMRCIACT($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",23,0)
 I $P(^TMP("GMRCIF",$J,"ORC"),"|")="XO" D  D EX Q
"RTN","GMRCIMSG",24,0)
 . D RESUB^GMRCIAC1($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",25,0)
 I $P(^TMP("GMRCIF",$J,"ORC"),"|")="XX" D  D EX Q
"RTN","GMRCIMSG",26,0)
 . D FWD^GMRCIAC1($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",27,0)
 I $P(^TMP("GMRCIF",$J,"ORC"),"|")="RE" D  D EX Q
"RTN","GMRCIMSG",28,0)
 . I $P($G(^TMP("GMRCIF",$J,"OBX",4,1)),"|",11)="D" D  Q
"RTN","GMRCIMSG",29,0)
 .. D DIS^GMRCIACT($NA(^TMP("GMRCIF",$J))) ; dis-assoc. result
"RTN","GMRCIMSG",30,0)
 . I $P($P(^TMP("GMRCIF",$J,"ORC"),"|",16),U)="S" D  Q
"RTN","GMRCIMSG",31,0)
 .. D SF^GMRCIAC1($NA(^TMP("GMRCIF",$J))) ; significant findings
"RTN","GMRCIMSG",32,0)
 . D COMP^GMRCIAC1($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",33,0)
 D OTHER^GMRCIACT($NA(^TMP("GMRCIF",$J)))
"RTN","GMRCIMSG",34,0)
 D EX
"RTN","GMRCIMSG",35,0)
 Q
"RTN","GMRCIMSG",36,0)
 ;
"RTN","GMRCIMSG",37,0)
EX ; clean up ^TMP(
"RTN","GMRCIMSG",38,0)
 K ^TMP("GMRCIF",$J)
"RTN","GMRCIMSG",39,0)
 Q
"RTN","GMRCIMSG",40,0)
 ;
"RTN","GMRCIMSG",41,0)
ORRIN ;process IFC responses
"RTN","GMRCIMSG",42,0)
 K ^TMP("GMRCIF",$J)
"RTN","GMRCIMSG",43,0)
 N HLNODE,SEG,I  ;production code
"RTN","GMRCIMSG",44,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","GMRCIMSG",45,0)
 .S ^TMP("GMRCIF",$J,$P(HLNODE,"|"))=$E(HLNODE,5,999)
"RTN","GMRCIMSG",46,0)
 I $D(^TMP("GMRCIF",$J,"ORC")),$P(^("ORC"),"|")="OK" D
"RTN","GMRCIMSG",47,0)
 . N GMRCFNUM,GMRCROUT,GMRCDA,FDA
"RTN","GMRCIMSG",48,0)
 . S GMRCROUT=$$IEN^XUAF4($P($P(^TMP("GMRCIF",$J,"ORC"),"|",3),U,2))
"RTN","GMRCIMSG",49,0)
 . S GMRCDA=+$P(^TMP("GMRCIF",$J,"ORC"),"|",2)
"RTN","GMRCIMSG",50,0)
 . ;I GMRCROUT'=$P(^GMR(123,GMRCDA,0),U,23) Q
"RTN","GMRCIMSG",51,0)
 . S GMRCFNUM=+$P(^TMP("GMRCIF",$J,"ORC"),"|",3)
"RTN","GMRCIMSG",52,0)
 . S FDA(1,123,GMRCDA_",",.06)=GMRCFNUM
"RTN","GMRCIMSG",53,0)
 . D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIMSG",54,0)
 . Q
"RTN","GMRCIMSG",55,0)
 I $P(^TMP("GMRCIF",$J,"MSA"),"|")="AA" D
"RTN","GMRCIMSG",56,0)
 . N MSGID,MSGLOG,FDA,GMRCDA,GMRCACT,GMRCLOG
"RTN","GMRCIMSG",57,0)
 . S MSGID=$P(^TMP("GMRCIF",$J,"MSA"),"|",2)
"RTN","GMRCIMSG",58,0)
 . S MSGLOG=$O(^GMR(123.6,"AM",MSGID,0)) Q:'MSGLOG
"RTN","GMRCIMSG",59,0)
 . S FDA(1,123.6,MSGLOG_",",.06)="@"
"RTN","GMRCIMSG",60,0)
 . S FDA(1,123.6,MSGLOG_",",.08)="@"
"RTN","GMRCIMSG",61,0)
 . D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIMSG",62,0)
 . S GMRCDA=$P(^GMR(123.6,MSGLOG,0),U,4) Q:'GMRCDA
"RTN","GMRCIMSG",63,0)
 . S GMRCACT=$P(^GMR(123.6,MSGLOG,0),U,5) Q:'GMRCACT
"RTN","GMRCIMSG",64,0)
 . S GMRCACT=$O(^GMR(123.6,"AC",GMRCDA,GMRCACT)) D
"RTN","GMRCIMSG",65,0)
 .. I 'GMRCACT Q
"RTN","GMRCIMSG",66,0)
 .. S GMRCLOG=$O(^GMR(123.6,"AC",GMRCDA,GMRCACT,1,0)) Q:'GMRCLOG
"RTN","GMRCIMSG",67,0)
 .. I $P(^GMR(123.6,GMRCLOG,0),U,8)<900 Q  ;re-send 901 & 902 immed.
"RTN","GMRCIMSG",68,0)
 .. D TRIGR^GMRCIEVT(GMRCDA,GMRCACT)
"RTN","GMRCIMSG",69,0)
 . Q
"RTN","GMRCIMSG",70,0)
 I $P(^TMP("GMRCIF",$J,"MSA"),"|")="AR" D
"RTN","GMRCIMSG",71,0)
 . N MSGID,MSGLOG,FDA,GMRCERR,GMRCE
"RTN","GMRCIMSG",72,0)
 . S MSGID=$P(^TMP("GMRCIF",$J,"MSA"),"|",2)
"RTN","GMRCIMSG",73,0)
 . S MSGLOG=$O(^GMR(123.6,"AM",MSGID,0)) Q:'MSGLOG
"RTN","GMRCIMSG",74,0)
 . S GMRCE=$P(^TMP("GMRCIF",$J,"MSA"),"|",3)
"RTN","GMRCIMSG",75,0)
 . S FDA(1,123.6,MSGLOG_",",.08)=GMRCE
"RTN","GMRCIMSG",76,0)
 . I GMRCE=802 S FDA(1,123.6,MSGLOG_",",.06)="@"
"RTN","GMRCIMSG",77,0)
 . D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIMSG",78,0)
 . I GMRCE=901!(GMRCE=201)!(GMRCE=902) Q  ;no alerts on these probs (yet)
"RTN","GMRCIMSG",79,0)
 . D SNDALRT^GMRCIERR(MSGLOG,"C")
"RTN","GMRCIMSG",80,0)
 I $D(GMRCERR) M ^XTMP("GMRCIRR",$J,"ERR")=GMRCERR
"RTN","GMRCIMSG",81,0)
 K ^TMP("GMRCIF",$J)
"RTN","GMRCIMSG",82,0)
 Q
"RTN","GMRCIMSG",83,0)
 ;
"RTN","GMRCIMSG",84,0)
VALMSG(GMRCORC) ;check to make sure placer and filler # match current entry
"RTN","GMRCIMSG",85,0)
 ; Input: 
"RTN","GMRCIMSG",86,0)
 ;  GMRCORC = ORC segment from incoming HL7 msg
"RTN","GMRCIMSG",87,0)
 ;
"RTN","GMRCIMSG",88,0)
 I $P(GMRCORC,"|")="NW" Q 1 ; no #'s to match on new order
"RTN","GMRCIMSG",89,0)
 N GMRCPDA,GMRCFDA,GMRCPSIT,GMRCFSIT,GMRCROL,GMRCOK
"RTN","GMRCIMSG",90,0)
 S GMRCPDA=+$P(GMRCORC,"|",2)
"RTN","GMRCIMSG",91,0)
 S GMRCPSIT=$$IEN^XUAF4($P($P(GMRCORC,"|",2),U,2))
"RTN","GMRCIMSG",92,0)
 S GMRCFDA=+$P(GMRCORC,"|",3)
"RTN","GMRCIMSG",93,0)
 S GMRCFSIT=$$IEN^XUAF4($P($P(GMRCORC,"|",3),U,2))
"RTN","GMRCIMSG",94,0)
 I $$KSP^XUPARAM("INST")=GMRCPSIT S GMRCROL="P"
"RTN","GMRCIMSG",95,0)
 I $$KSP^XUPARAM("INST")=GMRCFSIT S GMRCROL="F"
"RTN","GMRCIMSG",96,0)
 S GMRCOK=1
"RTN","GMRCIMSG",97,0)
 I '$D(GMRCROL) S GMRCOK=0,GMRCROL="" ;bad institutions in msg
"RTN","GMRCIMSG",98,0)
 I GMRCROL="P" D
"RTN","GMRCIMSG",99,0)
 . I '$D(^GMR(123,GMRCPDA,0)) S GMRCOK=0 Q  ;no such cslt #
"RTN","GMRCIMSG",100,0)
 . I $P(^GMR(123,GMRCPDA,0),U,22)'=GMRCFDA S GMRCOK=0 Q  ;cslt # prob
"RTN","GMRCIMSG",101,0)
 . I $P(^GMR(123,GMRCPDA,0),U,23)'=GMRCFSIT S GMRCOK=0 Q  ;routing facil.
"RTN","GMRCIMSG",102,0)
 I GMRCROL="F" D
"RTN","GMRCIMSG",103,0)
 . I '$D(^GMR(123,GMRCFDA,0)) S GMRCOK=0 Q  ;no such cslt #
"RTN","GMRCIMSG",104,0)
 . I $P(^GMR(123,GMRCFDA,0),U,22)'=GMRCPDA S GMRCOK=0 Q  ;cslt # prob
"RTN","GMRCIMSG",105,0)
 . I $P(^GMR(123,GMRCFDA,0),U,23)'=GMRCPSIT S GMRCOK=0 Q  ;routing facil.
"RTN","GMRCIMSG",106,0)
 I 'GMRCOK D  ;return a 101 error to sending site
"RTN","GMRCIMSG",107,0)
 . N GMRCRSLT
"RTN","GMRCIMSG",108,0)
 . D RESP^GMRCIUTL("AR",HL("MID"),,,101) ;build HLA(
"RTN","GMRCIMSG",109,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT) ;-(
"RTN","GMRCIMSG",110,0)
 Q GMRCOK
"RTN","GMRCIMSG",111,0)
 ;
"RTN","GMRCINC")
0^9^B31742816
"RTN","GMRCINC",1,0)
GMRCINC ;SLC/JFR - list incomplete IFC transactions ; 2/12/02 15:05
"RTN","GMRCINC",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCINC",3,0)
EN ; -- main entry point for GMRCIF INCOMPLETE TRANSACTION
"RTN","GMRCINC",4,0)
 N DIR,X,Y,DIRUT,DIROUT
"RTN","GMRCINC",5,0)
 S DIR(0)="PO^123:EMQ",DIR("A")="Select a consult request"
"RTN","GMRCINC",6,0)
 S DIR("?")="Type in the number, date of request or patient name"
"RTN","GMRCINC",7,0)
 S DIR("S")="I $D(^GMR(123.6,""AC"",+Y))"
"RTN","GMRCINC",8,0)
 D ^DIR
"RTN","GMRCINC",9,0)
 I $D(DIRUT) Q
"RTN","GMRCINC",10,0)
 I '$D(^GMR(123,+Y,0)) D  Q
"RTN","GMRCINC",11,0)
 . W !,"There is no such consult request number"
"RTN","GMRCINC",12,0)
 . K DIR S DIR(0)="E" D ^DIR
"RTN","GMRCINC",13,0)
 S GMRCNUM=+Y
"RTN","GMRCINC",14,0)
 D BLD(GMRCNUM)
"RTN","GMRCINC",15,0)
 D EN^VALM("GMRC IF INCOMPLETE TRANSACTION")
"RTN","GMRCINC",16,0)
 Q
"RTN","GMRCINC",17,0)
 ;
"RTN","GMRCINC",18,0)
BLD(GMRCDA) ;get list of incomplete IF transactions for a consult #
"RTN","GMRCINC",19,0)
 ; Input: 
"RTN","GMRCINC",20,0)
 ;   GMRCDA = ien of consult from file 123
"RTN","GMRCINC",21,0)
 ;
"RTN","GMRCINC",22,0)
 ; Output:
"RTN","GMRCINC",23,0)
 ;    some kind of ^TMP( array
"RTN","GMRCINC",24,0)
 N GMRCLOG,ACT,ENT,LINE
"RTN","GMRCINC",25,0)
 S ACT=0
"RTN","GMRCINC",26,0)
 F  S ACT=$O(^GMR(123.6,"AC",GMRCDA,ACT)) Q:'ACT  D
"RTN","GMRCINC",27,0)
 . S ENT=$O(^GMR(123.6,"AC",GMRCDA,ACT,1,0)) Q:'ENT
"RTN","GMRCINC",28,0)
 . S GMRCLOG(ACT)=ENT
"RTN","GMRCINC",29,0)
 I '$O(GMRCLOG(0)) D  Q
"RTN","GMRCINC",30,0)
 .S ^TMP("GMRCINC",$J,1,0)="No incomplete transactions for request #"_GMRCDA
"RTN","GMRCINC",31,0)
 S GMRCLOG=GMRCLOG($O(GMRCLOG(0)))
"RTN","GMRCINC",32,0)
 D EN^GMRCIERR(GMRCLOG,GMRCDA,$O(GMRCLOG(0)),1)
"RTN","GMRCINC",33,0)
 M ^TMP("GMRCINC",$J)=^TMP("GMRCIERR",$J)
"RTN","GMRCINC",34,0)
 S ACT=0
"RTN","GMRCINC",35,0)
 F  S ACT=$O(GMRCLOG(ACT)) Q:'ACT  D
"RTN","GMRCINC",36,0)
 . K ^TMP("GMRCIERR",$J)
"RTN","GMRCINC",37,0)
 . S LINE=$O(^TMP("GMRCINC",$J," "),-1)+1
"RTN","GMRCINC",38,0)
 . D ACTLG^GMRCIERR(GMRCDA,ACT,GMRCLOG(ACT),.LINE)
"RTN","GMRCINC",39,0)
 . I '$D(^TMP("GMRCIERR",$J)) Q
"RTN","GMRCINC",40,0)
 . S ^TMP("GMRCINC",$J,"B",ACT)=$O(^TMP("GMRCIERR",$J,0))+1
"RTN","GMRCINC",41,0)
 . S LINE=0 F  S LINE=$O(^TMP("GMRCIERR",$J,LINE)) Q:'LINE  D
"RTN","GMRCINC",42,0)
 .. S ^TMP("GMRCINC",$J,LINE+1,0)=^TMP("GMRCIERR",$J,LINE,0)
"RTN","GMRCINC",43,0)
 .. Q
"RTN","GMRCINC",44,0)
 . Q
"RTN","GMRCINC",45,0)
 K ^TMP("GMRCIERR",$J)
"RTN","GMRCINC",46,0)
 Q
"RTN","GMRCINC",47,0)
 ;
"RTN","GMRCINC",48,0)
HDR ; -- header code
"RTN","GMRCINC",49,0)
 S VALMHDR(1)="Incomplete transaction(s) for consult#: "_GMRCNUM
"RTN","GMRCINC",50,0)
 Q
"RTN","GMRCINC",51,0)
 ;
"RTN","GMRCINC",52,0)
INIT ; -- init variables and list array
"RTN","GMRCINC",53,0)
 N ACT,LIN
"RTN","GMRCINC",54,0)
 S VALMBG=1
"RTN","GMRCINC",55,0)
 S VALMCNT=$O(^TMP("GMRCINC",$J," "),-1)
"RTN","GMRCINC",56,0)
 S ACT=0 F  S ACT=$O(^TMP("GMRCINC",$J,"B",ACT)) Q:'ACT  D
"RTN","GMRCINC",57,0)
 . S LIN=^TMP("GMRCINC",$J,"B",ACT)
"RTN","GMRCINC",58,0)
 . D CNTRL^VALM10(LIN,1,14,IORVON,IORVOFF)
"RTN","GMRCINC",59,0)
 S VALMBCK="R"
"RTN","GMRCINC",60,0)
 Q
"RTN","GMRCINC",61,0)
 ;
"RTN","GMRCINC",62,0)
HELP ; -- help code
"RTN","GMRCINC",63,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","GMRCINC",64,0)
 Q
"RTN","GMRCINC",65,0)
 ;
"RTN","GMRCINC",66,0)
EXIT ; -- exit code
"RTN","GMRCINC",67,0)
 K GMRCNUM,GMRCSEL
"RTN","GMRCINC",68,0)
 K ^TMP("GMRCINC",$J),^TMP("GMRCS",$J)
"RTN","GMRCINC",69,0)
 Q
"RTN","GMRCINC",70,0)
 ;
"RTN","GMRCINC",71,0)
NEWCSLT ; pick new consult number to check for inc. trans.
"RTN","GMRCINC",72,0)
 N DIR,DIRUT,DUOUT,DTOUT,DIROUT,X,Y
"RTN","GMRCINC",73,0)
 D FULL^VALM1
"RTN","GMRCINC",74,0)
 S DIR(0)="PO^123:EMQ",DIR("A")="Select a new Consult number"
"RTN","GMRCINC",75,0)
 S DIR("?")="Type in the number, date of request or patient name"
"RTN","GMRCINC",76,0)
 D ^DIR
"RTN","GMRCINC",77,0)
 I $D(DIRUT) Q
"RTN","GMRCINC",78,0)
 I '$D(^GMR(123,+Y,0)) D  Q
"RTN","GMRCINC",79,0)
 . W !,"There is no such consult request number"
"RTN","GMRCINC",80,0)
 . K DIR S DIR(0)="E" D ^DIR
"RTN","GMRCINC",81,0)
 K ^TMP("GMRCINC",$J),^TMP("GMRCS",$J)
"RTN","GMRCINC",82,0)
 S GMRCNUM=+Y
"RTN","GMRCINC",83,0)
 I '$D(GMRCSEL) D
"RTN","GMRCINC",84,0)
 . D BLD(GMRCNUM)
"RTN","GMRCINC",85,0)
 . D INIT
"RTN","GMRCINC",86,0)
 . D HDR
"RTN","GMRCINC",87,0)
 E  D
"RTN","GMRCINC",88,0)
 . S GMRCSEL=GMRCNUM
"RTN","GMRCINC",89,0)
 . K GMRCLOG
"RTN","GMRCINC",90,0)
 . D BLD^GMRCITR(GMRCNUM)
"RTN","GMRCINC",91,0)
 . I '$O(GMRCLOG(0)) D
"RTN","GMRCINC",92,0)
 .. S ^TMP("GMRCINC",$J,1,0)="No transactions for consult#: "_GMRCNUM
"RTN","GMRCINC",93,0)
 . E  D
"RTN","GMRCINC",94,0)
 .. D DATA^GMRCITR(GMRCS)
"RTN","GMRCINC",95,0)
 . D HDR^GMRCITR,LM^GMRCITR
"RTN","GMRCINC",96,0)
 S VALMCNT=$O(^TMP("GMRCINC",$J," "),-1)
"RTN","GMRCINC",97,0)
 S VALMBG=1
"RTN","GMRCINC",98,0)
 Q
"RTN","GMRCINC",99,0)
 ;
"RTN","GMRCINC",100,0)
RETRAN ;resend a particular transaction
"RTN","GMRCINC",101,0)
 N DIR,DIRUT,DUOUT,DTOUT,DIROUT,X,Y,GMRCACT
"RTN","GMRCINC",102,0)
 D FULL^VALM1
"RTN","GMRCINC",103,0)
 S GMRCACT=$$SELACT(GMRCNUM) I 'GMRCACT Q
"RTN","GMRCINC",104,0)
 I $O(^GMR(123.6,"AC",GMRCNUM,GMRCACT),-1)>0 D  Q
"RTN","GMRCINC",105,0)
 . W !!,"There is at least one earlier incomplete transaction for this"
"RTN","GMRCINC",106,0)
 . W !,"consult, all incomplete transactions should be processed in "
"RTN","GMRCINC",107,0)
 . W !,"order.",!
"RTN","GMRCINC",108,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCINC",109,0)
 W !
"RTN","GMRCINC",110,0)
 S DIR(0)="YA"
"RTN","GMRCINC",111,0)
 S DIR("A")="Are you sure you want to retransmit this activity? "
"RTN","GMRCINC",112,0)
 S DIR("A",1)="You have selected the following activity:"
"RTN","GMRCINC",113,0)
 S DIR("A",2)=$$GET1^DIQ(123.1,$P(^GMR(123,GMRCNUM,40,GMRCACT,0),U,2),.01)_" entered "_$$FMTE^XLFDT($P(^GMR(123,GMRCNUM,40,GMRCACT,0),U))
"RTN","GMRCINC",114,0)
 S DIR("A",3)=" "
"RTN","GMRCINC",115,0)
 D ^DIR
"RTN","GMRCINC",116,0)
 I +Y'=1 Q
"RTN","GMRCINC",117,0)
 D DELALRT^GMRCIBKG($O(^GMR(123.6,"AC",GMRCNUM,GMRCACT,1,0)))
"RTN","GMRCINC",118,0)
 D TRIGR^GMRCIEVT(GMRCNUM,GMRCACT)
"RTN","GMRCINC",119,0)
 S VALMBG=1
"RTN","GMRCINC",120,0)
 Q
"RTN","GMRCINC",121,0)
 ;
"RTN","GMRCINC",122,0)
SELACT(GMRCDA)  ;select an incomplete activity
"RTN","GMRCINC",123,0)
 N DIR,DIRUT,DUOUT,DTOUT,DIROUT,X,Y,GMRC40
"RTN","GMRCINC",124,0)
 S DIR(0)="N",DIR("A")="Select an activity number" D ^DIR
"RTN","GMRCINC",125,0)
 I $D(DIRUT) Q ""
"RTN","GMRCINC",126,0)
 S GMRC40=+Y
"RTN","GMRCINC",127,0)
 K DIR
"RTN","GMRCINC",128,0)
 I '$D(^GMR(123,GMRCDA,40,GMRC40)) D  Q ""
"RTN","GMRCINC",129,0)
 . W !,"There is no such activity number for consult# "_GMRCNUM
"RTN","GMRCINC",130,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCINC",131,0)
 I '$D(^GMR(123.6,"AC",GMRCDA,GMRC40)) D  Q ""
"RTN","GMRCINC",132,0)
 . W !,"There is no incomplete IFC transaction for that activity"
"RTN","GMRCINC",133,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCINC",134,0)
 Q GMRC40
"RTN","GMRCINC",135,0)
 ;
"RTN","GMRCINC",136,0)
MKCOMP ; mark a particular transaction complete
"RTN","GMRCINC",137,0)
 N DIR,DIRUT,DUOUT,DTOUT,DIROUT,X,Y,GMRCACT,FDA,GMRCLOG,GMRCERR
"RTN","GMRCINC",138,0)
 D FULL^VALM1
"RTN","GMRCINC",139,0)
 S GMRCACT=$$SELACT(GMRCNUM) I 'GMRCACT Q
"RTN","GMRCINC",140,0)
 W !
"RTN","GMRCINC",141,0)
 S DIR(0)="YA"
"RTN","GMRCINC",142,0)
 S DIR("A")="Are you sure you want to mark this activity complete? "
"RTN","GMRCINC",143,0)
 S DIR("A",1)="You have selected the following activity:"
"RTN","GMRCINC",144,0)
 S DIR("A",2)=$$GET1^DIQ(123.1,$P(^GMR(123,GMRCNUM,40,GMRCACT,0),U,2),.01)_" entered "_$$FMTE^XLFDT($P(^GMR(123,GMRCNUM,40,GMRCACT,0),U))
"RTN","GMRCINC",145,0)
 S DIR("A",3)=" "
"RTN","GMRCINC",146,0)
 S DIR("A",4)="Use Caution marking a transaction complete!"
"RTN","GMRCINC",147,0)
 S DIR("A",5)=" "
"RTN","GMRCINC",148,0)
 D ^DIR
"RTN","GMRCINC",149,0)
 I +$G(Y)'=1 Q
"RTN","GMRCINC",150,0)
 S GMRCLOG=$O(^GMR(123.6,"AC",GMRCNUM,GMRCACT,1,0))
"RTN","GMRCINC",151,0)
 I 'GMRCLOG Q
"RTN","GMRCINC",152,0)
 S FDA(1,123.6,GMRCLOG_",",.06)="@"
"RTN","GMRCINC",153,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCINC",154,0)
 K ^TMP("GMRCINC",$J),^TMP("GMRCS",$J)
"RTN","GMRCINC",155,0)
 D BLD(GMRCNUM)
"RTN","GMRCINC",156,0)
 D INIT
"RTN","GMRCINC",157,0)
 S VALMBG=1
"RTN","GMRCINC",158,0)
 Q
"RTN","GMRCIR")
0^38^B34893714
"RTN","GMRCIR",1,0)
GMRCIR ;SLC/JAK - IFC Request data & statistics ;03/05/02 08:20
"RTN","GMRCIR",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIR",3,0)
EN ; -- main entry point for GMRC IF CONSULTS
"RTN","GMRCIR",4,0)
 K GMRCSVC,GMRCSVCP
"RTN","GMRCIR",5,0)
 N GMRCCK,GMRCDG,GMRCIS,GMRCSTAT
"RTN","GMRCIR",6,0)
 N GMRCDT1,GMRCDT2,GMRCEDT1,GMRCEDT2
"RTN","GMRCIR",7,0)
 I $D(GMRCREMP),$D(GMRCRF) D
"RTN","GMRCIR",8,0)
 .I '$D(^GMR(123,"AIP")) D
"RTN","GMRCIR",9,0)
 ..W !!,$C(7),"No entries with Remote Ordering Provider data.",!
"RTN","GMRCIR",10,0)
 ..S GMRCQUT=1
"RTN","GMRCIR",11,0)
 .E  D
"RTN","GMRCIR",12,0)
 ..N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCIR",13,0)
 ..S DIR(0)="PO^4:EMQ"
"RTN","GMRCIR",14,0)
 ..S DIR("S")="I $$STA^XUAF4(+Y)=+$$STA^XUAF4(+Y)"
"RTN","GMRCIR",15,0)
 ..S DIR("A")="Select Requesting site"
"RTN","GMRCIR",16,0)
 ..D ^DIR I $D(DIRUT) S GMRCQUT=1 Q
"RTN","GMRCIR",17,0)
 ..S GMRCRF=+Y
"RTN","GMRCIR",18,0)
 ..W !
"RTN","GMRCIR",19,0)
 ..N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCIR",20,0)
 ..S DIR(0)="FO^2:40^D UP^GMRCA2 K:'$D(^GMR(123,""AIP"",X)) X"
"RTN","GMRCIR",21,0)
 ..S DIR("?")="^D HELPR^GMRCIR"
"RTN","GMRCIR",22,0)
 ..S DIR("A",1)="   Enter the ENTIRE name in proper CASE, exactly as it"
"RTN","GMRCIR",23,0)
 ..S DIR("A",2)="   appears in the list (including any credentials)."
"RTN","GMRCIR",24,0)
 ..S DIR("A",3)="   Use copy/paste to avoid typing errors."
"RTN","GMRCIR",25,0)
 ..S DIR("A",4)="   NO partial matches are done."
"RTN","GMRCIR",26,0)
 ..S DIR("A",5)="   Enter ? to display a list of possible entries."
"RTN","GMRCIR",27,0)
 ..S DIR("A")="Select Remote Ordering Provider"
"RTN","GMRCIR",28,0)
 ..D ^DIR I $D(DIRUT) S GMRCQUT=1 Q
"RTN","GMRCIR",29,0)
 ..D UP^GMRCA2 S Y=X,GMRCREMP=Y
"RTN","GMRCIR",30,0)
 .S GMRCIS="C"
"RTN","GMRCIR",31,0)
 E  D
"RTN","GMRCIR",32,0)
 .N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCIR",33,0)
 .S DIR(0)="SB^R:REQUESTING;C:CONSULTING"
"RTN","GMRCIR",34,0)
 .S DIR("A")="Are you the Requesting site or the Consulting site"
"RTN","GMRCIR",35,0)
 .D ^DIR I $D(DIRUT) S GMRCQUT=1 Q
"RTN","GMRCIR",36,0)
 .S GMRCIS=Y
"RTN","GMRCIR",37,0)
 I $D(GMRCQUT) D EXIT Q
"RTN","GMRCIR",38,0)
 ;Get the statuses
"RTN","GMRCIR",39,0)
 S GMRCSTAT=$$STS^GMRCPC1
"RTN","GMRCIR",40,0)
 I $D(GMRCQUT) D EXIT Q
"RTN","GMRCIR",41,0)
 I $D(GMRCEACT),$L(GMRCEACT) D  I '$D(^GMR(123.5,$G(GMRCSVC),0)) D EXIT Q
"RTN","GMRCIR",42,0)
 .S GMRCSVCP=GMRCEACT
"RTN","GMRCIR",43,0)
 .S GMRCSVC=$O(^GMR(123.5,"B",GMRCSVCP,0))
"RTN","GMRCIR",44,0)
 .Q:'$D(^GMR(123.5,$G(GMRCSVC),0))
"RTN","GMRCIR",45,0)
 .;Build service array
"RTN","GMRCIR",46,0)
 .S GMRCDG=GMRCSVC
"RTN","GMRCIR",47,0)
 .D SERV1^GMRCASV
"RTN","GMRCIR",48,0)
 .;Set date range to ALL
"RTN","GMRCIR",49,0)
 .S GMRCDT1="ALL"
"RTN","GMRCIR",50,0)
 .S GMRCDT2=0
"RTN","GMRCIR",51,0)
 .D LISTDATE^GMRCSTU1(GMRCDT1,GMRCDT2,.GMRCEDT1,.GMRCEDT2)
"RTN","GMRCIR",52,0)
 ;If no service ask for one
"RTN","GMRCIR",53,0)
 I '$L($G(GMRCSVC)) D EN^GMRCSTLM I $D(GMRCQUT) D EXIT Q
"RTN","GMRCIR",54,0)
 ;Quit if no array of services
"RTN","GMRCIR",55,0)
 I '$O(^TMP("GMRCSLIST",$J,0)) S GMRCQUT=1 D EXIT Q
"RTN","GMRCIR",56,0)
 ;
"RTN","GMRCIR",57,0)
 D EN^VALM("GMRC IF CONSULTS")
"RTN","GMRCIR",58,0)
 Q
"RTN","GMRCIR",59,0)
 ;
"RTN","GMRCIR",60,0)
HDR ; -- header code
"RTN","GMRCIR",61,0)
 Q:$D(GMRCQUT)!'$D(GMRCCT)
"RTN","GMRCIR",62,0)
 S VALMHDR(1)="IFC Requests: "_$S(GMRCIS="R":"Requesting",1:"Consulting")_" Site"
"RTN","GMRCIR",63,0)
 S VALMHDR(2)="Service: "_GMRCHEAD
"RTN","GMRCIR",64,0)
 S VALMHDR(3)="From: "_$G(GMRCEDT1)_"   To: "_$G(GMRCEDT2)
"RTN","GMRCIR",65,0)
 I $G(GMRCCTRL)=1 S VALMCAP="     "_VALMCAP
"RTN","GMRCIR",66,0)
 Q
"RTN","GMRCIR",67,0)
 ;
"RTN","GMRCIR",68,0)
HELP ; -- help code
"RTN","GMRCIR",69,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","GMRCIR",70,0)
 Q
"RTN","GMRCIR",71,0)
 ;
"RTN","GMRCIR",72,0)
EXIT ; -- exit code
"RTN","GMRCIR",73,0)
 K CNT,CTRLCOL,GMRCCT,GMRCQUT,GMRCSVC,GMRCSVCP,VALMHDR
"RTN","GMRCIR",74,0)
 K GMRCEDT1,GMRCEDT2,GMRCSVNM
"RTN","GMRCIR",75,0)
 K GMRCCTRL,GMRCSTAT,GMRCARRN
"RTN","GMRCIR",76,0)
 K ^TMP("GMRCS",$J),^TMP("GMRCSLIST",$J),^TMP("GMRCR",$J,"IFC"),^TMP("GMRCRINDEX",$J),^TMP("GMRCTOT",$J)
"RTN","GMRCIR",77,0)
 Q
"RTN","GMRCIR",78,0)
 ;
"RTN","GMRCIR",79,0)
EXPND ; -- expand code
"RTN","GMRCIR",80,0)
 Q
"RTN","GMRCIR",81,0)
 ;
"RTN","GMRCIR",82,0)
CWIDTH(GMRCCTRL) ;Prints a message about how wide the report is.
"RTN","GMRCIR",83,0)
 N WIDTH
"RTN","GMRCIR",84,0)
 S WIDTH=128
"RTN","GMRCIR",85,0)
 I GMRCCTRL#100\10 D
"RTN","GMRCIR",86,0)
 .I GMRCCTRL#100\10=1 S WIDTH=WIDTH+5
"RTN","GMRCIR",87,0)
 .E  S WIDTH=WIDTH+10
"RTN","GMRCIR",88,0)
 I GMRCCTRL#1000\100 S WIDTH=WIDTH-6
"RTN","GMRCIR",89,0)
 Q WIDTH
"RTN","GMRCIR",90,0)
 ;
"RTN","GMRCIR",91,0)
PWIDTH(GMRCCTRL) ;Prints a message about how wide the report is.
"RTN","GMRCIR",92,0)
 W !!,"This print out is "_$$CWIDTH(GMRCCTRL)_" columns wide."
"RTN","GMRCIR",93,0)
 Q
"RTN","GMRCIR",94,0)
 ;
"RTN","GMRCIR",95,0)
HELPR ;Help for Remote Ordering Provider prompt
"RTN","GMRCIR",96,0)
 N GMRCRP,GMRCQUT
"RTN","GMRCIR",97,0)
 S GMRCRP=""
"RTN","GMRCIR",98,0)
 W @IOF
"RTN","GMRCIR",99,0)
 F  S GMRCRP=$O(^GMR(123,"AIP",GMRCRP)) Q:GMRCRP=""!$D(GMRCQUT)  D
"RTN","GMRCIR",100,0)
 .W GMRCRP,!
"RTN","GMRCIR",101,0)
 .I $Y>(IOSL-4) N X,Y D  W:Y @IOF I 'Y S GMRCQUT=1 Q
"RTN","GMRCIR",102,0)
 ..N DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","GMRCIR",103,0)
 ..S DIR(0)="E" D ^DIR
"RTN","GMRCIR",104,0)
 I $D(GMRCQUT) Q
"RTN","GMRCIR",105,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCIR",106,0)
 S DIR(0)="E",DIR("A")="Enter RETURN or '^' to exit" D ^DIR
"RTN","GMRCIR",107,0)
 Q
"RTN","GMRCIR",108,0)
 ;
"RTN","GMRCIR",109,0)
DESC ;Displays Description from Option file
"RTN","GMRCIR",110,0)
 N GMRCDESC,GMRCNUM,GMRCOPT,GMRCOPTN,GMRCQUT
"RTN","GMRCIR",111,0)
 S GMRCNUM=""
"RTN","GMRCIR",112,0)
 S GMRCOPTN="GMRC IFC RPT CONSULTS"
"RTN","GMRCIR",113,0)
 S GMRCOPT=$$FIND1^DIC(19,"","X",GMRCOPTN)
"RTN","GMRCIR",114,0)
 I 'GMRCOPT Q
"RTN","GMRCIR",115,0)
 S GMRCDESC=$$GET1^DIQ(19,GMRCOPT,3.5,"","GMRCDESC") ; DBIA #10075
"RTN","GMRCIR",116,0)
 I '$O(GMRCDESC(0)) Q
"RTN","GMRCIR",117,0)
 W @IOF F  S GMRCNUM=$O(GMRCDESC(GMRCNUM)) Q:GMRCNUM=""!$D(GMRCQUT)  D
"RTN","GMRCIR",118,0)
 .W GMRCDESC(GMRCNUM),!
"RTN","GMRCIR",119,0)
 .I $Y>(IOSL-4) N X,Y D  W:+Y @IOF I '+Y S GMRCQUT=1 Q
"RTN","GMRCIR",120,0)
 ..N DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","GMRCIR",121,0)
 ..S DIR(0)="E" D ^DIR
"RTN","GMRCIR",122,0)
 I $D(GMRCQUT) Q
"RTN","GMRCIR",123,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCIR",124,0)
 S DIR(0)="E",DIR("A")="Enter RETURN or '^' to exit" D ^DIR
"RTN","GMRCIR",125,0)
 Q
"RTN","GMRCIR",126,0)
 ;
"RTN","GMRCIR",127,0)
PRNTONLY(GMRCCTRL) ;Option to just send the report to a device.
"RTN","GMRCIR",128,0)
 N GMRCQUT,RETURN,GMRCDG,GMRCSTAT,VALMBCK
"RTN","GMRCIR",129,0)
 N GMRCDT1,GMRCDT2,GMRCEDT1,GMRCEDT2
"RTN","GMRCIR",130,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,GMRCIS,GMRCCK,X,Y
"RTN","GMRCIR",131,0)
 S DIR(0)="SB^R:REQUESTING;C:CONSULTING"
"RTN","GMRCIR",132,0)
 S DIR("A")="Are you the Requesting site or the Consulting site"
"RTN","GMRCIR",133,0)
 D ^DIR Q:$D(DIRUT)  S GMRCIS=Y
"RTN","GMRCIR",134,0)
 ;Get the statuses
"RTN","GMRCIR",135,0)
 S GMRCSTAT=$$STS^GMRCPC1
"RTN","GMRCIR",136,0)
 I $D(GMRCQUT) D EXIT Q
"RTN","GMRCIR",137,0)
 ;Get the service and date range.
"RTN","GMRCIR",138,0)
 D EN^GMRCSTLM
"RTN","GMRCIR",139,0)
 I $D(GMRCQUT) D EXIT Q
"RTN","GMRCIR",140,0)
 ;Quit if no array of services
"RTN","GMRCIR",141,0)
 I '$O(^TMP("GMRCSLIST",$J,0)) S GMRCQUT=1 D EXIT Q
"RTN","GMRCIR",142,0)
 I '($D(GMRCCTRL)#2) S GMRCCTRL=0 ; default to just the list
"RTN","GMRCIR",143,0)
 ;Get description?
"RTN","GMRCIR",144,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCIR",145,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","GMRCIR",146,0)
 S DIR("A")="Want to view a description of the data for this report now"
"RTN","GMRCIR",147,0)
 D ^DIR I $D(DIRUT) D EXIT Q
"RTN","GMRCIR",148,0)
 I Y>0 D DESC
"RTN","GMRCIR",149,0)
 D PWIDTH(GMRCCTRL)
"RTN","GMRCIR",150,0)
 ;Get the device
"RTN","GMRCIR",151,0)
 D PRNTASK^GMRCSTU
"RTN","GMRCIR",152,0)
 I $D(GMRCQUT) D EXIT Q
"RTN","GMRCIR",153,0)
 ;Save some things if the report is queued
"RTN","GMRCIR",154,0)
 I $D(IO("Q")) D
"RTN","GMRCIR",155,0)
 .S ZTSAVE("GMRCCTRL")=""
"RTN","GMRCIR",156,0)
 .S ZTSAVE("GMRCIS")=""
"RTN","GMRCIR",157,0)
 .S ZTSAVE("GMRCSTAT")=""
"RTN","GMRCIR",158,0)
 ;Create the report if not queued
"RTN","GMRCIR",159,0)
 E  D ENOR^GMRCSTLM(.RETURN,GMRCDG,GMRCDT1,GMRCDT2,GMRCSTAT,GMRCCTRL,"IFC")
"RTN","GMRCIR",160,0)
 ;Print the report
"RTN","GMRCIR",161,0)
 D PRNTIT^GMRCSTU("IFC","PRNTQ^GMRCIR","CONSULT/REQUEST PACKAGE PRINT INTER-FACILITY CONSULT REQUESTS FROM OPTION")
"RTN","GMRCIR",162,0)
 D EXIT
"RTN","GMRCIR",163,0)
 Q
"RTN","GMRCIR",164,0)
 ;
"RTN","GMRCIR",165,0)
PRNTQ ;Print Queued report from ^TMP global then kill off ^TMP & ^XTMP
"RTN","GMRCIR",166,0)
 ;Create the report
"RTN","GMRCIR",167,0)
 N RETURN,INDEX
"RTN","GMRCIR",168,0)
 D ENOR^GMRCSTLM(.RETURN,GMRCDG,GMRCDT1,GMRCDT2,GMRCSTAT,GMRCCTRL,"IFC")
"RTN","GMRCIR",169,0)
 U IO
"RTN","GMRCIR",170,0)
 S INDEX=""
"RTN","GMRCIR",171,0)
 F  S INDEX=$O(^TMP("GMRCR",$J,TMPNAME,INDEX)) Q:INDEX=""  W ^TMP("GMRCR",$J,TMPNAME,INDEX,0),!
"RTN","GMRCIR",172,0)
 K ^TMP("GMRCR",$J,TMPNAME),^XTMP("GMRCR",J,DOLLARH,"PRINT"),J,DOLLARH
"RTN","GMRCIR",173,0)
 D ^%ZISC
"RTN","GMRCIR",174,0)
 D EXIT
"RTN","GMRCIR",175,0)
 Q
"RTN","GMRCIR",176,0)
 ;
"RTN","GMRCISEG")
0^10^B29580709
"RTN","GMRCISEG",1,0)
GMRCISEG ;SLC/JFR - CREATE IFC HL7 SEGMENTS ; 7/26/01 22:15
"RTN","GMRCISEG",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCISEG",3,0)
 Q  ;don't enter at top
"RTN","GMRCISEG",4,0)
BUILD(SEG,PCS) ;create any segment from array in PCS using |^&/~
"RTN","GMRCISEG",5,0)
 ; SEG = ORC,OBR,etc.
"RTN","GMRCISEG",6,0)
 ; PCS = array of data elements to be combined into the segement
"RTN","GMRCISEG",7,0)
 ;       array is numbered by the "|" piece 
"RTN","GMRCISEG",8,0)
 N ARR,SEGMNT
"RTN","GMRCISEG",9,0)
 S ARR=0,SEGMNT=""
"RTN","GMRCISEG",10,0)
 F  S ARR=$O(PCS(ARR)) Q:'ARR  D
"RTN","GMRCISEG",11,0)
 . S $P(SEGMNT,"|",ARR)=PCS(ARR)
"RTN","GMRCISEG",12,0)
 . Q
"RTN","GMRCISEG",13,0)
 Q SEG_"|"_SEGMNT
"RTN","GMRCISEG",14,0)
ORC(GMRCO,GMRCOC,GMRCOS,GMRCACT)    ;build ORC for all but new orders
"RTN","GMRCISEG",15,0)
 ;Input:
"RTN","GMRCISEG",16,0)
 ; GMRCO = ien from file 123
"RTN","GMRCISEG",17,0)
 ; GMRCOC = order control
"RTN","GMRCISEG",18,0)
 ; GMRCOS = order status
"RTN","GMRCISEG",19,0)
 ; GMRCACT = ien in 40 multiple of particular action
"RTN","GMRCISEG",20,0)
 ;
"RTN","GMRCISEG",21,0)
 ;Output: 
"RTN","GMRCISEG",22,0)
 ; ORC segment
"RTN","GMRCISEG",23,0)
 ;
"RTN","GMRCISEG",24,0)
 I '$D(GMRCO)!('$D(GMRCOC))!('$D(GMRCACT)) Q "ERROR"
"RTN","GMRCISEG",25,0)
 N GMRCPCS,SITE,GMRCRP
"RTN","GMRCISEG",26,0)
 S GMRCPCS(1)=GMRCOC
"RTN","GMRCISEG",27,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D
"RTN","GMRCISEG",28,0)
 . S GMRCPCS(2)=GMRCO_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_"^GMRCIFR"
"RTN","GMRCISEG",29,0)
 . S GMRCPCS(3)=$P(^GMR(123,GMRCO,0),U,22)_U_$$STA^XUAF4($P(^(0),U,23))
"RTN","GMRCISEG",30,0)
 . S GMRCPCS(3)=GMRCPCS(3)_"^GMRCIFC"
"RTN","GMRCISEG",31,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="F" D
"RTN","GMRCISEG",32,0)
 . S GMRCPCS(2)=$P(^GMR(123,GMRCO,0),U,22)_U_$$STA^XUAF4($P(^(0),U,23))
"RTN","GMRCISEG",33,0)
 . S GMRCPCS(2)=GMRCPCS(2)_"^GMRCIFR"
"RTN","GMRCISEG",34,0)
 . S GMRCPCS(3)=GMRCO_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_"^GMRCIFC"
"RTN","GMRCISEG",35,0)
 S GMRCPCS(5)=$S($D(GMRCOS):GMRCOS,1:"")
"RTN","GMRCISEG",36,0)
 I GMRCOC["X" S $P(GMRCPCS(7),U,6)=$$URG^GMRCIUTL(GMRCO)
"RTN","GMRCISEG",37,0)
 S GMRCPCS(9)=$$FMTHL7^XLFDT($P(^GMR(123,GMRCO,40,GMRCACT,0),U,1))
"RTN","GMRCISEG",38,0)
 S GMRCPCS(10)=$$HLNAME^GMRCIUTL($P(^GMR(123,GMRCO,40,GMRCACT,0),U,5))
"RTN","GMRCISEG",39,0)
 S GMRCRP=$P(^GMR(123,GMRCO,40,GMRCACT,0),U,4) I +GMRCRP D
"RTN","GMRCISEG",40,0)
 . S GMRCPCS(12)=$$HLNAME^GMRCIUTL(GMRCRP)
"RTN","GMRCISEG",41,0)
 . N GMRCPHN,GMRCPAG
"RTN","GMRCISEG",42,0)
 . S GMRCPHN=$$GET1^DIQ(200,GMRCRP,.132)
"RTN","GMRCISEG",43,0)
 . S GMRCPAG=$$GET1^DIQ(200,GMRCRP,.138)
"RTN","GMRCISEG",44,0)
 . S GMRCPCS(14)=$$HLPHONE^HLFNC(GMRCPHN,GMRCPAG)
"RTN","GMRCISEG",45,0)
 S GMRCPCS(15)=$$FMTHL7^XLFDT($P(^GMR(123,GMRCO,40,GMRCACT,0),U,3))
"RTN","GMRCISEG",46,0)
 I GMRCOC["X"!(GMRCOC="SC")!(GMRCOC="RE") D 
"RTN","GMRCISEG",47,0)
 . I GMRCOC="XX" D  Q
"RTN","GMRCISEG",48,0)
 .. I $P(^GMR(123,GMRCO,40,GMRCACT,0),U,2)=25 D  Q
"RTN","GMRCISEG",49,0)
 ... S GMRCPCS(16)="FI^FORWARD TO IFC^99GMRC"
"RTN","GMRCISEG",50,0)
 .. S GMRCPCS(16)="F^FORWARD^99GMRC"
"RTN","GMRCISEG",51,0)
 . I GMRCOC="XO" S GMRCPCS(16)="E^EDIT-RESUBMIT^99GMRC" Q
"RTN","GMRCISEG",52,0)
 . I GMRCOC="SC" D  Q
"RTN","GMRCISEG",53,0)
 .. I GMRCOS="IP" S GMRCPCS(16)="R^RECEIVE^99GMRC"
"RTN","GMRCISEG",54,0)
 .. I GMRCOS="SC"  S GMRCPCS(16)="SC^SCHEDULE^99GMRC"
"RTN","GMRCISEG",55,0)
 . I GMRCOC="RE" D
"RTN","GMRCISEG",56,0)
 .. N ACTVT S ACTVT=$P(^GMR(123,GMRCO,40,GMRCACT,0),U,2)
"RTN","GMRCISEG",57,0)
 .. I ACTVT=12 S GMRCPCS(16)="D^DISASSOCIATE RESULT^99GMRC"
"RTN","GMRCISEG",58,0)
 .. I ACTVT=13 S GMRCPCS(16)="A^ADDENDUM^99GMRC"
"RTN","GMRCISEG",59,0)
 .. I ACTVT=4 S GMRCPCS(16)="S^SIGNIFICANT FINDING^99GMRC"
"RTN","GMRCISEG",60,0)
 . Q
"RTN","GMRCISEG",61,0)
 S SITE=$$SITE^VASITE
"RTN","GMRCISEG",62,0)
 I +SITE S GMRCPCS(17)=$P(SITE,U,3)_U_$P(SITE,U,2) ;use loc instead? ;-(
"RTN","GMRCISEG",63,0)
 Q $$BUILD^GMRCISEG("ORC",.GMRCPCS)
"RTN","GMRCISEG",64,0)
 ;
"RTN","GMRCISEG",65,0)
OBXWP(GMRCO,GMRCOC,GMRCACT,GMRCSEG) ; return a WP field in OBX segs
"RTN","GMRCISEG",66,0)
 ; Input:
"RTN","GMRCISEG",67,0)
 ;  GMRCO   = 
"RTN","GMRCISEG",68,0)
 ;  GMRCOC  =
"RTN","GMRCISEG",69,0)
 ;  GMRCACT = activity in 40 mult triggering msg
"RTN","GMRCISEG",70,0)
 ;  GMRCSEG = GLOBAL array to return results in
"RTN","GMRCISEG",71,0)
 ;
"RTN","GMRCISEG",72,0)
 ; Output:
"RTN","GMRCISEG",73,0)
 ;  ARRAY(1)=OBX|1|TX|coding scheme|1|text||||||obs result status
"RTN","GMRCISEG",74,0)
 ;  ARRAY(2)=OBX|1|TX|coding scheme|2|text||||||obs result status
"RTN","GMRCISEG",75,0)
 ;
"RTN","GMRCISEG",76,0)
 K ^TMP("GMRCWP",$J)
"RTN","GMRCISEG",77,0)
 N GMRCPCS
"RTN","GMRCISEG",78,0)
 I GMRCOC="NW"!(GMRCOC="XO") D  Q
"RTN","GMRCISEG",79,0)
 . N SUBS S SUBS=0
"RTN","GMRCISEG",80,0)
 . F  S SUBS=$O(^GMR(123,GMRCO,20,SUBS)) Q:'SUBS  D
"RTN","GMRCISEG",81,0)
 .. S GMRCPCS(1)=1,GMRCPCS(2)="TX"
"RTN","GMRCISEG",82,0)
 .. S GMRCPCS(3)="2000.02^REASON FOR REQUEST^AS4",GMRCPCS(4)=SUBS
"RTN","GMRCISEG",83,0)
 .. S GMRCPCS(5)=$G(^GMR(123,GMRCO,20,SUBS,0)),GMRCPCS(11)="O"
"RTN","GMRCISEG",84,0)
 .. S ^TMP("GMRCWP",$J,SUBS)=$$BUILD^GMRCISEG("OBX",.GMRCPCS)
"RTN","GMRCISEG",85,0)
 . M @GMRCSEG=^TMP("GMRCWP",$J)
"RTN","GMRCISEG",86,0)
 . K ^TMP("GMRCWP",$J)
"RTN","GMRCISEG",87,0)
 . Q
"RTN","GMRCISEG",88,0)
 I '$D(GMRCACT)!('$D(^GMR(123,GMRCO,40,GMRCACT,1))) Q
"RTN","GMRCISEG",89,0)
 N CMT,ACTVT
"RTN","GMRCISEG",90,0)
 S CMT=0,ACTVT=$P(^GMR(123,GMRCO,40,GMRCACT,0),U,2)
"RTN","GMRCISEG",91,0)
 F  S CMT=$O(^GMR(123,GMRCO,40,GMRCACT,1,CMT)) Q:'CMT  D
"RTN","GMRCISEG",92,0)
 . S GMRCPCS(1)=3,GMRCPCS(2)="TX"
"RTN","GMRCISEG",93,0)
 . S GMRCPCS(3)="^COMMENTS^",GMRCPCS(4)=CMT
"RTN","GMRCISEG",94,0)
 . S GMRCPCS(5)=$G(^GMR(123,GMRCO,40,GMRCACT,1,CMT,0))
"RTN","GMRCISEG",95,0)
 . S GMRCPCS(11)=$S(ACTVT=10:"F",1:"P") ;F if an admin comp. else "P"
"RTN","GMRCISEG",96,0)
 . S ^TMP("GMRCWP",$J,CMT)=$$BUILD^GMRCISEG("OBX",.GMRCPCS)
"RTN","GMRCISEG",97,0)
 M @GMRCSEG=^TMP("GMRCWP",$J)
"RTN","GMRCISEG",98,0)
 K ^TMP("GMRCWP",$J)
"RTN","GMRCISEG",99,0)
 Q
"RTN","GMRCISEG",100,0)
 ;
"RTN","GMRCISEG",101,0)
OBXRSLT(GMRCO,GMRCACT) ; build an OBX segment to send a TIU doc reference
"RTN","GMRCISEG",102,0)
 ; Input:
"RTN","GMRCISEG",103,0)
 ;  GMRCO   = ien from file 123
"RTN","GMRCISEG",104,0)
 ;  GMRCACT = activity entry in 40 multiple
"RTN","GMRCISEG",105,0)
 ;
"RTN","GMRCISEG",106,0)
 ; Output:
"RTN","GMRCISEG",107,0)
 ;  OBX segment 
"RTN","GMRCISEG",108,0)
 ;    e.g. OBX|4|RP|^TIU DOC^VA8925||41320^TIU^660||||||||F
"RTN","GMRCISEG",109,0)
 ;
"RTN","GMRCISEG",110,0)
 Q:'$D(^GMR(123,GMRCO,40,GMRCACT)) ""
"RTN","GMRCISEG",111,0)
 N GMRCPCS,RSLT,GMRCACTV
"RTN","GMRCISEG",112,0)
 S GMRCPCS(1)=4,GMRCPCS(2)="RP"
"RTN","GMRCISEG",113,0)
 S GMRCPCS(4)=1
"RTN","GMRCISEG",114,0)
 S GMRCACTV=$P(^GMR(123,GMRCO,40,GMRCACT,0),U,2)
"RTN","GMRCISEG",115,0)
 S RSLT=$P(^GMR(123,GMRCO,40,GMRCACT,0),U,9)
"RTN","GMRCISEG",116,0)
 I RSLT["TIU" D
"RTN","GMRCISEG",117,0)
 . S GMRCPCS(3)="^TIU DOC^VA8925"
"RTN","GMRCISEG",118,0)
 . S GMRCPCS(5)=+RSLT_"^TIU DOCUMENT^"_$$STA^XUAF4($$KSP^XUPARAM("INST"))
"RTN","GMRCISEG",119,0)
 I RSLT["MCAR" D
"RTN","GMRCISEG",120,0)
 . N MCPRNM S MCPRNM=$P($$SINGLE^MCAPI(RSLT),U)
"RTN","GMRCISEG",121,0)
 . S GMRCPCS(3)="^MED RSLT^VA"_+$P(RSLT,"MCAR(",2)
"RTN","GMRCISEG",122,0)
 . S GMRCPCS(5)=+RSLT_U_MCPRNM_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))
"RTN","GMRCISEG",123,0)
 S GMRCPCS(11)=$S(GMRCACTV=9:"S",GMRCACTV=12:"D",1:"F")
"RTN","GMRCISEG",124,0)
 Q $$BUILD^GMRCISEG("OBX",.GMRCPCS)
"RTN","GMRCISEG",125,0)
 ;
"RTN","GMRCISEG",126,0)
NTE(GMRCO,GMRCACT,GMRCAR) ;format an NTE seg with DC comment
"RTN","GMRCISEG",127,0)
 ; Input:
"RTN","GMRCISEG",128,0)
 ;  GMRCO   = ien from file 123
"RTN","GMRCISEG",129,0)
 ;  GMRCACT = activity entry in 40 multiple
"RTN","GMRCISEG",130,0)
 ;  GMRCAR  = array in which to pass back NTE segs 
"RTN","GMRCISEG",131,0)
 ;
"RTN","GMRCISEG",132,0)
 ; Output:
"RTN","GMRCISEG",133,0)
 ;  array of NTE segments containing the comment
"RTN","GMRCISEG",134,0)
 ;   e.g. NTE|1|L|cancelled by requestor
"RTN","GMRCISEG",135,0)
 ;
"RTN","GMRCISEG",136,0)
 Q:'$D(^GMR(123,GMRCO,40,GMRCACT,1))
"RTN","GMRCISEG",137,0)
 N CMT,GMRCPCS S CMT=0
"RTN","GMRCISEG",138,0)
 F  S CMT=$O(^GMR(123,GMRCO,40,GMRCACT,1,CMT)) Q:'CMT  D
"RTN","GMRCISEG",139,0)
 . S GMRCPCS(1)=CMT,GMRCPCS(2)="L"
"RTN","GMRCISEG",140,0)
 . S GMRCPCS(3)=$G(^GMR(123,GMRCO,40,GMRCACT,1,CMT,0))
"RTN","GMRCISEG",141,0)
 . S GMRCAR(CMT)=$$BUILD^GMRCISEG("NTE",.GMRCPCS)
"RTN","GMRCISEG",142,0)
 Q
"RTN","GMRCISEG",143,0)
 ;
"RTN","GMRCISEG",144,0)
MSA(GMRCAC,GMRCMSG,GMRCERR) ; build MSA for response to placer activity
"RTN","GMRCISEG",145,0)
 ; Input:
"RTN","GMRCISEG",146,0)
 ;  GMRCAC  = acknowledgment code  (AA or AR)
"RTN","GMRCISEG",147,0)
 ;  GMRCMSG = message number from incoming msg being responded to
"RTN","GMRCISEG",148,0)
 ;  GMRCERR = error message if can't accept the activity
"RTN","GMRCISEG",149,0)
 ;
"RTN","GMRCISEG",150,0)
 ; Output:
"RTN","GMRCISEG",151,0)
 ;  MSA segment to include with ACK or NAK
"RTN","GMRCISEG",152,0)
 ;
"RTN","GMRCISEG",153,0)
 N GMRCPCS
"RTN","GMRCISEG",154,0)
 S GMRCPCS(1)=GMRCAC
"RTN","GMRCISEG",155,0)
 S GMRCPCS(2)=GMRCMSG
"RTN","GMRCISEG",156,0)
 S GMRCPCS(3)=$G(GMRCERR)
"RTN","GMRCISEG",157,0)
 Q $$BUILD^GMRCISEG("MSA",.GMRCPCS)
"RTN","GMRCISEG",158,0)
 ;
"RTN","GMRCISEG",159,0)
OBXTZ() ;build and return an OBX with the current TIME ZONE encoded
"RTN","GMRCISEG",160,0)
 ;Input:
"RTN","GMRCISEG",161,0)
 ;  none
"RTN","GMRCISEG",162,0)
 ;
"RTN","GMRCISEG",163,0)
 ;Output:
"RTN","GMRCISEG",164,0)
 ;  OBX segment in the format:
"RTN","GMRCISEG",165,0)
 ;    OBX|5|CE|^TIME ZONE^VA4.4|1|MST||||||O
"RTN","GMRCISEG",166,0)
 ;
"RTN","GMRCISEG",167,0)
 N GMRCPCS
"RTN","GMRCISEG",168,0)
 S GMRCPCS(1)=5,GMRCPCS(2)="CE"
"RTN","GMRCISEG",169,0)
 S GMRCPCS(3)="^TIME ZONE^VA4.4",GMRCPCS(4)=1
"RTN","GMRCISEG",170,0)
 S GMRCPCS(5)=$$GET1^DIQ(4.3,1,1)
"RTN","GMRCISEG",171,0)
 Q $$BUILD^GMRCISEG("OBX",.GMRCPCS)
"RTN","GMRCISEG",172,0)
 ;
"RTN","GMRCISEG",173,0)
OBXSF(GMRCO) ; build OBX seg for Sig. Find.
"RTN","GMRCISEG",174,0)
 ; Input:
"RTN","GMRCISEG",175,0)
 ;  GMRCO = ien from file 123
"RTN","GMRCISEG",176,0)
 ;
"RTN","GMRCISEG",177,0)
 ; Output:
"RTN","GMRCISEG",178,0)
 ;   OBX segment in format:
"RTN","GMRCISEG",179,0)
 ;     OBX|6|TX|^SIG FINDINGS^|1|S||||||O
"RTN","GMRCISEG",180,0)
 ;
"RTN","GMRCISEG",181,0)
 I '$L($P(^GMR(123,GMRCO,0),U,19)) Q ""
"RTN","GMRCISEG",182,0)
 N GMRCPCS
"RTN","GMRCISEG",183,0)
 S GMRCPCS(1)=6,GMRCPCS(2)="TX",GMRCPCS(3)="^SIG FINDINGS^"
"RTN","GMRCISEG",184,0)
 S GMRCPCS(4)=1,GMRCPCS(5)=$P(^GMR(123,GMRCO,0),U,19),GMRCPCS(11)="O"
"RTN","GMRCISEG",185,0)
 Q $$BUILD^GMRCISEG("OBX",.GMRCPCS)
"RTN","GMRCISG1")
0^11^B26938225
"RTN","GMRCISG1",1,0)
GMRCISG1 ;SLC/JFR - BUILD IFC HL7 SEGMENTS CONT'D ;10/31/01 09:00
"RTN","GMRCISG1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCISG1",3,0)
 Q  ;can't start here
"RTN","GMRCISG1",4,0)
ORCRESP(GMRCO,GMRCOC,GMRCOS) ;build ORC for app ACK msgs
"RTN","GMRCISG1",5,0)
 ; Input:
"RTN","GMRCISG1",6,0)
 ;  GMRCO   = ien from file 123 of entry responding to
"RTN","GMRCISG1",7,0)
 ;  GMRCOC  = order control to put into segment
"RTN","GMRCISG1",8,0)
 ;  GMRCOS  = HL7 encoded order status to put in message
"RTN","GMRCISG1",9,0)
 ; 
"RTN","GMRCISG1",10,0)
 ; Output:
"RTN","GMRCISG1",11,0)
 ;  ORC segment to use in response message
"RTN","GMRCISG1",12,0)
 ;
"RTN","GMRCISG1",13,0)
 N GMRCPCS,SITE
"RTN","GMRCISG1",14,0)
 S GMRCPCS(1)=GMRCOC
"RTN","GMRCISG1",15,0)
 S GMRCPCS(2)=$P(^GMR(123,GMRCO,0),U,22)_U_$$STA^XUAF4($P(^(0),U,23))_"^GMRCIFR"
"RTN","GMRCISG1",16,0)
 S GMRCPCS(3)=GMRCO_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_"^GMRCIFC"
"RTN","GMRCISG1",17,0)
 S GMRCPCS(5)=$G(GMRCOS)
"RTN","GMRCISG1",18,0)
 S GMRCPCS(17)=$$STA^XUAF4($$KSP^XUPARAM("INST"))
"RTN","GMRCISG1",19,0)
 Q $$BUILD^GMRCISEG("ORC",.GMRCPCS)
"RTN","GMRCISG1",20,0)
 ;
"RTN","GMRCISG1",21,0)
NWORC(GMRCO) ; build ORC seg for a new order
"RTN","GMRCISG1",22,0)
 ; Input:
"RTN","GMRCISG1",23,0)
 ;  GMRCO = ien from file 123 of order to send remotely
"RTN","GMRCISG1",24,0)
 ;
"RTN","GMRCISG1",25,0)
 ; Output:
"RTN","GMRCISG1",26,0)
 ;  ORC segment to send with a new order to remote facility
"RTN","GMRCISG1",27,0)
 ;
"RTN","GMRCISG1",28,0)
 N GMRCPCS,SITE,GMRCPHN,GMRCPAG
"RTN","GMRCISG1",29,0)
 S GMRCPCS(1)="NW"
"RTN","GMRCISG1",30,0)
 S GMRCPCS(2)=GMRCO_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_U_"GMRCIFR"
"RTN","GMRCISG1",31,0)
 S $P(GMRCPCS(7),U,6)=$$URG^GMRCIUTL(GMRCO)
"RTN","GMRCISG1",32,0)
 S GMRCPCS(9)=$$FMTHL7^XLFDT(+^GMR(123,GMRCO,0))
"RTN","GMRCISG1",33,0)
 S GMRCPCS(10)=$$HLNAME^GMRCIUTL($P($G(^GMR(123,GMRCO,40,1,0)),U,5))
"RTN","GMRCISG1",34,0)
 S GMRCPCS(12)=$$HLNAME^GMRCIUTL($P(^GMR(123,GMRCO,0),U,14))
"RTN","GMRCISG1",35,0)
 S GMRCPHN=$$GET1^DIQ(200,$P(^GMR(123,GMRCO,0),U,14),.132)
"RTN","GMRCISG1",36,0)
 S GMRCPAG=$$GET1^DIQ(200,$P(^GMR(123,GMRCO,0),U,14),.138)
"RTN","GMRCISG1",37,0)
 S GMRCPCS(14)=$$HLPHONE^HLFNC(GMRCPHN,GMRCPAG)
"RTN","GMRCISG1",38,0)
 S GMRCPCS(15)=$$FMTHL7^XLFDT($P(^GMR(123,GMRCO,0),U,7))
"RTN","GMRCISG1",39,0)
 I $O(^GMR(123,GMRCO,40,1)) D
"RTN","GMRCISG1",40,0)
 . N I,ACTV S I=1
"RTN","GMRCISG1",41,0)
 . F  S I=$O(^GMR(123,GMRCO,40,I)) Q:'I  S ACTV=$P(^(I,0),U,2) D
"RTN","GMRCISG1",42,0)
 .. I ACTV'=25 Q
"RTN","GMRCISG1",43,0)
 .. S GMRCPCS(16)="FI^FORWARD TO IFC^99GMRC"
"RTN","GMRCISG1",44,0)
 S SITE=$$SITE^VASITE
"RTN","GMRCISG1",45,0)
 I +SITE S GMRCPCS(17)=$P(SITE,U,3)_U_$P(SITE,U,2) ;use loc instead? ;-(
"RTN","GMRCISG1",46,0)
 Q $$BUILD^GMRCISEG("ORC",.GMRCPCS)
"RTN","GMRCISG1",47,0)
OBXPD(GMRCO) ; create OBX segment for the prov. dx
"RTN","GMRCISG1",48,0)
 ; Input:
"RTN","GMRCISG1",49,0)
 ;  GMRCO  = ien from file 123 of order to send remotely
"RTN","GMRCISG1",50,0)
 ;
"RTN","GMRCISG1",51,0)
 ; Output:
"RTN","GMRCISG1",52,0)
 ;  OBX segment containing the Provisional Diagnosis
"RTN","GMRCISG1",53,0)
 ;
"RTN","GMRCISG1",54,0)
 Q:'$L($G(^GMR(123,GMRCO,30))) ""
"RTN","GMRCISG1",55,0)
 N GMRCPCS
"RTN","GMRCISG1",56,0)
 S GMRCPCS(1)=2,GMRCPCS(2)=$S($L($G(^GMR(123,GMRCO,30.1))):"CE",1:"TX")
"RTN","GMRCISG1",57,0)
 S GMRCPCS(3)="^PROVISIONAL DIAGNOSIS^",GMRCPCS(4)=1
"RTN","GMRCISG1",58,0)
 S GMRCPCS(11)="O"
"RTN","GMRCISG1",59,0)
 I $L($G(^GMR(123,GMRCO,30.1))) D  Q $$BUILD^GMRCISEG("OBX",.GMRCPCS)
"RTN","GMRCISG1",60,0)
 . ;coded diagnosis
"RTN","GMRCISG1",61,0)
 . S GMRCPCS(5)=$G(^GMR(123,GMRCO,30.1))_U_$G(^(30))_U_"I9C"
"RTN","GMRCISG1",62,0)
 S GMRCPCS(5)=U_$G(^GMR(123,GMRCO,30))_U ;free text dx
"RTN","GMRCISG1",63,0)
 Q $$BUILD^GMRCISEG("OBX",.GMRCPCS)
"RTN","GMRCISG1",64,0)
 ;
"RTN","GMRCISG1",65,0)
OBR(GMRCO,GMRCACT) ; build an OBR seg for new order or resubmit
"RTN","GMRCISG1",66,0)
 ; Input:
"RTN","GMRCISG1",67,0)
 ;  GMRCO   = ien from file 123
"RTN","GMRCISG1",68,0)
 ;  GMRCACT = ien from 40 multiple of action (only on resubmit or fwd)
"RTN","GMRCISG1",69,0)
 ;
"RTN","GMRCISG1",70,0)
 ; Output:
"RTN","GMRCISG1",71,0)
 ;  OBR segment 
"RTN","GMRCISG1",72,0)
 ;
"RTN","GMRCISG1",73,0)
 N GMRCPCS,GMRCROL
"RTN","GMRCISG1",74,0)
 S GMRCPCS(1)=1
"RTN","GMRCISG1",75,0)
 S GMRCROL=$P(^GMR(123,GMRCO,12),U,5)
"RTN","GMRCISG1",76,0)
 I GMRCROL="P" D
"RTN","GMRCISG1",77,0)
 . S GMRCPCS(2)=GMRCO_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_U_"GMRCIFR"
"RTN","GMRCISG1",78,0)
 I $D(GMRCACT) D  ;  resubmit sends filler # too
"RTN","GMRCISG1",79,0)
 . I GMRCROL="P" D
"RTN","GMRCISG1",80,0)
 .. S GMRCPCS(3)=$P(^GMR(123,GMRCO,0),U,22)_U_$$STA^XUAF4($P(^(0),U,23))
"RTN","GMRCISG1",81,0)
 .. S GMRCPCS(3)=GMRCPCS(3)_U_"GMRCIFC"
"RTN","GMRCISG1",82,0)
 . I GMRCROL="F" D
"RTN","GMRCISG1",83,0)
 .. S GMRCPCS(2)=$P(^GMR(123,GMRCO,0),U,22)_U_$$STA^XUAF4($P(^(0),U,23))
"RTN","GMRCISG1",84,0)
 .. S GMRCPCS(2)=GMRCPCS(2)_U_"GMRCIFR"
"RTN","GMRCISG1",85,0)
 .. S GMRCPCS(3)=GMRCO_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_U_"GMRCIFC"
"RTN","GMRCISG1",86,0)
 I $D(GMRCACT),$P(^GMR(123,GMRCO,40,GMRCACT,0),U,2)=17 D
"RTN","GMRCISG1",87,0)
 . ;FWD uses txt of current svc
"RTN","GMRCISG1",88,0)
 . N SITE,SERVNM,SERV
"RTN","GMRCISG1",89,0)
 . S SITE=$$STA^XUAF4($$KSP^XUPARAM("INST"))_"VA1235"
"RTN","GMRCISG1",90,0)
 . I GMRCROL="F" S SERV=$P(^GMR(123,GMRCO,0),U,5)
"RTN","GMRCISG1",91,0)
 . I GMRCROL="P" S SERV=$P(^GMR(123,GMRCO,40,GMRCACT,0),U,6)
"RTN","GMRCISG1",92,0)
 . S SERVNM=$S(+SERV:$P(^GMR(123.5,SERV,0),U),1:"")
"RTN","GMRCISG1",93,0)
 . S GMRCPCS(4)=SERV_U_SERVNM_U_SITE
"RTN","GMRCISG1",94,0)
 I $D(GMRCACT),$P(^GMR(123,GMRCO,40,GMRCACT,0),U,2)=25 D
"RTN","GMRCISG1",95,0)
 . ;FWD to IFC uses the FORWARDED FROM service name
"RTN","GMRCISG1",96,0)
 . N SITE,SERVNM,SERV
"RTN","GMRCISG1",97,0)
 . S SITE=$$STA^XUAF4($$KSP^XUPARAM("INST"))_"VA1235"
"RTN","GMRCISG1",98,0)
 . S SERV=$P(^GMR(123,GMRCO,40,GMRCACT,0),U,6)
"RTN","GMRCISG1",99,0)
 . I '+SERV Q
"RTN","GMRCISG1",100,0)
 . S SERVNM=$P(^GMR(123.5,SERV,0),U)
"RTN","GMRCISG1",101,0)
 . S GMRCPCS(4)=SERV_U_SERVNM_U_SITE
"RTN","GMRCISG1",102,0)
 I '$D(GMRCPCS(4)) D
"RTN","GMRCISG1",103,0)
 . S GMRCPCS(4)=$$CODEOI^GMRCIUTL(GMRCO) ;get remote service or proc
"RTN","GMRCISG1",104,0)
 I $D(GMRCACT) D  ;resubmit or fwd so use activity fields for msg
"RTN","GMRCISG1",105,0)
 . S GMRCPCS(6)=$$FMTHL7^XLFDT($P(^GMR(123,GMRCO,40,GMRCACT,0),U,3))
"RTN","GMRCISG1",106,0)
 . S GMRCPCS(16)=$$HLNAME^GMRCIUTL($P(^GMR(123,GMRCO,40,GMRCACT,0),U,4))
"RTN","GMRCISG1",107,0)
 I '$D(GMRCACT) D  ; new order being sent
"RTN","GMRCISG1",108,0)
 . S GMRCPCS(6)=$$FMTHL7^XLFDT($P(^GMR(123,GMRCO,0),U,7))
"RTN","GMRCISG1",109,0)
 . S GMRCPCS(16)=$$HLNAME^GMRCIUTL($P(^GMR(123,GMRCO,0),U,14))
"RTN","GMRCISG1",110,0)
 S GMRCPCS(18)=$P(^GMR(123,GMRCO,0),U,18)
"RTN","GMRCISG1",111,0)
 Q $$BUILD^GMRCISEG("OBR",.GMRCPCS)
"RTN","GMRCISG1",112,0)
 ;
"RTN","GMRCISG1",113,0)
ORCTST() ;build ORC for testing imp.
"RTN","GMRCISG1",114,0)
 ;Input:
"RTN","GMRCISG1",115,0)
 ;
"RTN","GMRCISG1",116,0)
 ;Output: 
"RTN","GMRCISG1",117,0)
 ; ORC segment used to test IFC implementation
"RTN","GMRCISG1",118,0)
 ;
"RTN","GMRCISG1",119,0)
 N GMRCPCS,SITE,GMRCRP
"RTN","GMRCISG1",120,0)
 S GMRCPCS(1)="NW"
"RTN","GMRCISG1",121,0)
 S GMRCPCS(2)="TST1234"_U_$$STA^XUAF4($$KSP^XUPARAM("INST"))_"^GMRCIFR"
"RTN","GMRCISG1",122,0)
 S GMRCPCS(9)=$$FMTHL7^XLFDT($$NOW^XLFDT)
"RTN","GMRCISG1",123,0)
 S GMRCPCS(10)="PUBLIC^JOHN^Q"
"RTN","GMRCISG1",124,0)
 S GMRCPCS(16)="T^TESTING^99GMRC"
"RTN","GMRCISG1",125,0)
 Q $$BUILD^GMRCISEG("ORC",.GMRCPCS)
"RTN","GMRCISG1",126,0)
 ;
"RTN","GMRCISG1",127,0)
 ;
"RTN","GMRCISG1",128,0)
OBRTST(GMRCOI,GMRCTYP) ; build OBR seg for testing imp.
"RTN","GMRCISG1",129,0)
 ; Input:
"RTN","GMRCISG1",130,0)
 ;  GMRCOI   = ien from file 123.5 or 123.3
"RTN","GMRCISG1",131,0)
 ;  GMRCTYP = "P" or "C"   (procedure or consult service)
"RTN","GMRCISG1",132,0)
 ;
"RTN","GMRCISG1",133,0)
 ; Output:
"RTN","GMRCISG1",134,0)
 ;  OBR segment used to test implementation
"RTN","GMRCISG1",135,0)
 ;
"RTN","GMRCISG1",136,0)
 N GMRCPCS,SITE
"RTN","GMRCISG1",137,0)
 S SITE=$$STA^XUAF4($$KSP^XUPARAM("INST"))
"RTN","GMRCISG1",138,0)
 S GMRCPCS(1)=1
"RTN","GMRCISG1",139,0)
 S GMRCPCS(2)="TST1234"_U_SITE_"^GMRCIFR"
"RTN","GMRCISG1",140,0)
 I GMRCTYP="C" D
"RTN","GMRCISG1",141,0)
 . N SERV
"RTN","GMRCISG1",142,0)
 . S SERV=$P(^GMR(123.5,GMRCOI,"IFC"),U,2)
"RTN","GMRCISG1",143,0)
 . S GMRCPCS(4)=GMRCOI_U_SERV_U_SITE_"VA1235"
"RTN","GMRCISG1",144,0)
 I GMRCTYP="P" D
"RTN","GMRCISG1",145,0)
 . N PROC
"RTN","GMRCISG1",146,0)
 . S PROC=$P(^GMR(123.3,GMRCOI,"IFC"),U,2)
"RTN","GMRCISG1",147,0)
 . S GMRCPCS(4)=GMRCOI_U_PROC_U_SITE_"VA1233"
"RTN","GMRCISG1",148,0)
 Q $$BUILD^GMRCISEG("OBR",.GMRCPCS)
"RTN","GMRCISG1",149,0)
 ;
"RTN","GMRCITPI")
0^59^B12566886
"RTN","GMRCITPI",1,0)
GMRCITPI ;SLC/JFR - SET TEST PATIENT ICN'S ;4/2/02 22:10
"RTN","GMRCITPI",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCITPI",3,0)
 ;
"RTN","GMRCITPI",4,0)
 ; This routine invokes IA #'s 3552, 3553
"RTN","GMRCITPI",5,0)
 ;
"RTN","GMRCITPI",6,0)
 ;
"RTN","GMRCITPI",7,0)
 ; WARNING: due to complications that may occur with the VA MPI, this 
"RTN","GMRCITPI",8,0)
 ;          routine should never be executed in a production VistA 
"RTN","GMRCITPI",9,0)
 ;          environment.  
"RTN","GMRCITPI",10,0)
 ;
"RTN","GMRCITPI",11,0)
EN ;set test patient ICN's based on SSN
"RTN","GMRCITPI",12,0)
 I '$$ENVOK Q  ;don't continue if environment isn't right
"RTN","GMRCITPI",13,0)
 N DIR,X,Y,DIRUT,DIROUT,DUOUT,DTOUT,GMRCPT,VA,VAHOW,VAROOT,DFN,OK
"RTN","GMRCITPI",14,0)
 W !!
"RTN","GMRCITPI",15,0)
 S DIR(0)="PAO^2:EMQZ",DIR("A")="Select shared patient: "
"RTN","GMRCITPI",16,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCITPI",17,0)
 S DFN=+Y
"RTN","GMRCITPI",18,0)
 S VAROOT="GMRCPT",VAHOW=1 D DEM^VADPT
"RTN","GMRCITPI",19,0)
 I '$$PATOK($P(GMRCPT("SS"),U)) G EN
"RTN","GMRCITPI",20,0)
 W !!,"Trying to set test patient ICN..."
"RTN","GMRCITPI",21,0)
 S OK=$$SETICN^MPIF001(DFN,(9_+GMRCPT("SS")),$E(GMRCPT("SS"),3,8))
"RTN","GMRCITPI",22,0)
 I 'OK W !!,"Unable to set ICN for this patient. Try again or select another patient." Q
"RTN","GMRCITPI",23,0)
 W !!,"  Done.",!
"RTN","GMRCITPI",24,0)
 G EN
"RTN","GMRCITPI",25,0)
 Q
"RTN","GMRCITPI",26,0)
ENVOK() ;check and quit if this could be a production environment
"RTN","GMRCITPI",27,0)
 ; checks PROCESSING ID (#.03) of file 869.3 to see if training
"RTN","GMRCITPI",28,0)
 N GMRCPID
"RTN","GMRCITPI",29,0)
 S GMRCPID=$P($$PARAM^HLCS2,U,3) ; new API to call
"RTN","GMRCITPI",30,0)
 I '$L(GMRCPID) D  Q 0
"RTN","GMRCITPI",31,0)
 . W !!,"Unable to continue! VistA HL7 is not configured."
"RTN","GMRCITPI",32,0)
 . W !,"Check the HL COMMUNICATION SERVER PARAMETERS file to be sure this is "
"RTN","GMRCITPI",33,0)
 . W !,"configured as a test environment."
"RTN","GMRCITPI",34,0)
 I GMRCPID="P" D  Q 0
"RTN","GMRCITPI",35,0)
 . W !!,$C(7),"This appears to be a prduction system!",!!
"RTN","GMRCITPI",36,0)
 . W "This option is only for use in training environments!",!
"RTN","GMRCITPI",37,0)
 . W !,"If this is indeed a traning environment, Check the HL COMMUNICATION "
"RTN","GMRCITPI",38,0)
 . W !,"SERVER PARAMETERS file to be sure this is configured as a test environment."
"RTN","GMRCITPI",39,0)
 . W !,"Then access this option again."
"RTN","GMRCITPI",40,0)
 Q 1
"RTN","GMRCITPI",41,0)
 ;
"RTN","GMRCITPI",42,0)
PATOK(GMRCSSN) ;make sure patient is only one with the SSN passed in
"RTN","GMRCITPI",43,0)
 ; Input:
"RTN","GMRCITPI",44,0)
 ;   GMRCSSN = ssn of patient in question
"RTN","GMRCITPI",45,0)
 ;
"RTN","GMRCITPI",46,0)
 ; Output:
"RTN","GMRCITPI",47,0)
 ;   1 = patient has a unique SSN and can be assigned a pseudo-ICN
"RTN","GMRCITPI",48,0)
 ;   0 = already a patient on file with the SSN
"RTN","GMRCITPI",49,0)
 N GMRCPT,ICN,OK
"RTN","GMRCITPI",50,0)
 I $E(GMRCSSN,1,5)="00000" D  Q 0
"RTN","GMRCITPI",51,0)
 . W !,"Patients having a SSN with 5 leading zeros cannot be used for inter-facility",!,"consult testing. Edit the SSN or choose a different patient."
"RTN","GMRCITPI",52,0)
 I GMRCSSN["P" D  Q 0
"RTN","GMRCITPI",53,0)
 . W !!,"This patient has a pseudo-SSN. A pseudo-ICN cannot be assigned. Edit the SSN",!,"or choose a different patient.",!
"RTN","GMRCITPI",54,0)
 S GMRCPT=$$FIND1^DIC(2,"","X",GMRCSSN,"SSN")
"RTN","GMRCITPI",55,0)
 I GMRCPT'>0 D  Q 0
"RTN","GMRCITPI",56,0)
 . W !,"There is more than one patient on file with the SSN of this patient. ",!,"A pseudo-ICN cannot be assigned. Edit the SSN or choose different patient."
"RTN","GMRCITPI",57,0)
 S ICN=$$GETICN^MPIF001(GMRCPT)
"RTN","GMRCITPI",58,0)
 I $L(ICN),+ICN=(9_GMRCSSN) D  Q 0
"RTN","GMRCITPI",59,0)
 . W !!,"Test patient ICN already set using current SSN.",!
"RTN","GMRCITPI",60,0)
 I $L(ICN),'$$IFLOCAL^MPIF001(GMRCPT) D  Q OK
"RTN","GMRCITPI",61,0)
 . S OK=1
"RTN","GMRCITPI",62,0)
 . W !!,"This patient appears to have a national ICN on file.",!
"RTN","GMRCITPI",63,0)
 . N DIR,X,Y,DTOUT,DIRUT,DUOUT
"RTN","GMRCITPI",64,0)
 . S DIR(0)="YA",DIR("A")="Are you sure you want to overwrite this ICN? "
"RTN","GMRCITPI",65,0)
 . D ^DIR
"RTN","GMRCITPI",66,0)
 . I Y'>0 S OK=0
"RTN","GMRCITPI",67,0)
 Q 1
"RTN","GMRCITR")
0^39^B35634845
"RTN","GMRCITR",1,0)
GMRCITR ;SLC/JAK - IFC transactions ; 02/27/02 15:50
"RTN","GMRCITR",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCITR",3,0)
EN ; -- main entry point for GMRC IF TRANSACTION
"RTN","GMRCITR",4,0)
 N GMRCDAS,GMRCLOG,GMRCQUT,GMRCS,X,Y
"RTN","GMRCITR",5,0)
 N GMRCDT1,GMRCDT2,GMRCEDT1,GMRCEDT2
"RTN","GMRCITR",6,0)
 D CON I $D(GMRCQUT) D EXIT^GMRCINC Q
"RTN","GMRCITR",7,0)
 ;Ask for date range
"RTN","GMRCITR",8,0)
 D ^GMRCSPD
"RTN","GMRCITR",9,0)
 I $D(GMRCQUT) D EXIT^GMRCINC Q
"RTN","GMRCITR",10,0)
 D LISTDATE^GMRCSTU1(GMRCDT1,GMRCDT2,.GMRCEDT1,.GMRCEDT2)
"RTN","GMRCITR",11,0)
 D VIEW I $D(GMRCQUT) D EXIT^GMRCINC Q
"RTN","GMRCITR",12,0)
 I GMRCSEL="ALL" D
"RTN","GMRCITR",13,0)
 . S GMRCNUM=0 F  S GMRCNUM=$O(^GMR(123.6,"C",GMRCNUM)) Q:'GMRCNUM  D
"RTN","GMRCITR",14,0)
 .. D BLD(GMRCNUM)
"RTN","GMRCITR",15,0)
 E  D
"RTN","GMRCITR",16,0)
 . S GMRCNUM=GMRCSEL
"RTN","GMRCITR",17,0)
 . D BLD(GMRCNUM)
"RTN","GMRCITR",18,0)
 I '$O(GMRCLOG(0)) D
"RTN","GMRCITR",19,0)
 . S ^TMP("GMRCINC",$J,1,0)="No transactions for consult#: "_GMRCSEL
"RTN","GMRCITR",20,0)
 E  D
"RTN","GMRCITR",21,0)
 . D DATA(GMRCS)
"RTN","GMRCITR",22,0)
 D EN^VALM("GMRC IF TRANSACTION")
"RTN","GMRCITR",23,0)
 Q
"RTN","GMRCITR",24,0)
 ;
"RTN","GMRCITR",25,0)
CON ; ask for consult number or all
"RTN","GMRCITR",26,0)
 S GMRCSEL=0
"RTN","GMRCITR",27,0)
 F  D ASK S:X["^" GMRCQUT=1 Q:X["^"  Q:X="ALL"  D LKUP Q:GMRCSEL
"RTN","GMRCITR",28,0)
 Q
"RTN","GMRCITR",29,0)
ASK ; write prompt, do read
"RTN","GMRCITR",30,0)
 W !!,"Select Consult/Request Number: ALL// "
"RTN","GMRCITR",31,0)
 R X:DTIME
"RTN","GMRCITR",32,0)
 I '$T S X="^"
"RTN","GMRCITR",33,0)
 I X'["^" S X=$S('$L(X):"ALL",1:X)
"RTN","GMRCITR",34,0)
 S:X="ALL" GMRCSEL="ALL"
"RTN","GMRCITR",35,0)
 Q
"RTN","GMRCITR",36,0)
LKUP ; use value of x for lookup
"RTN","GMRCITR",37,0)
 N DIC
"RTN","GMRCITR",38,0)
 S DIC="^GMR(123,",DIC(0)="MNEQZ"
"RTN","GMRCITR",39,0)
 D ^DIC I '$D(Y(0)) W "...invalid entry"
"RTN","GMRCITR",40,0)
 S:Y>0 GMRCSEL=+Y
"RTN","GMRCITR",41,0)
 Q
"RTN","GMRCITR",42,0)
VIEW ; ask for sort/view
"RTN","GMRCITR",43,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCITR",44,0)
 K GMRCQUT
"RTN","GMRCITR",45,0)
 S DIR(0)="SA^C:CONSULT;D:DATE;A:ACTIVITY;M:MESSAGE STATUS"
"RTN","GMRCITR",46,0)
 S DIR("A")="View by (C)onsult, (D)ate, (A)ctivity, or (M)essage Status: "
"RTN","GMRCITR",47,0)
 S DIR("B")="Consult"
"RTN","GMRCITR",48,0)
 S DIR("?")="Data will be sorted by your selection."
"RTN","GMRCITR",49,0)
 D ^DIR I $D(DIRUT) S GMRCQUT=1 Q
"RTN","GMRCITR",50,0)
 S GMRCS=Y
"RTN","GMRCITR",51,0)
 Q
"RTN","GMRCITR",52,0)
BLD(GMRCDA) ; get list of IF transactions for one or all consults
"RTN","GMRCITR",53,0)
 ; Input:
"RTN","GMRCITR",54,0)
 ;   GMRCDA = ien of consult from file 123
"RTN","GMRCITR",55,0)
 ;
"RTN","GMRCITR",56,0)
 N ACT,ENT,GMRCDTE
"RTN","GMRCITR",57,0)
 S ACT=0
"RTN","GMRCITR",58,0)
 F  S ACT=$O(^GMR(123.6,"C",GMRCDA,ACT)) Q:'ACT  D
"RTN","GMRCITR",59,0)
 . S ENT=$O(^GMR(123.6,"C",GMRCDA,ACT,0)) Q:'ENT
"RTN","GMRCITR",60,0)
 . I $S(GMRCDT1="ALL":0,1:1) D  Q:GMRCDTE<GMRCDT1!(GMRCDTE'<GMRCDT2)
"RTN","GMRCITR",61,0)
 .. S GMRCDTE=+$P($G(^GMR(123.6,ENT,0)),"^")
"RTN","GMRCITR",62,0)
 .. S GMRCDT2=GMRCDT2+1
"RTN","GMRCITR",63,0)
 . S GMRCLOG(GMRCDA,ACT)=ENT
"RTN","GMRCITR",64,0)
 Q
"RTN","GMRCITR",65,0)
DATA(GMRCS) ; get data for IF transaction(s)
"RTN","GMRCITR",66,0)
 ; Input:
"RTN","GMRCITR",67,0)
 ;   GMRCS = sort/view by selection
"RTN","GMRCITR",68,0)
 ; Output:
"RTN","GMRCITR",69,0)
 ;   ^TMP("GMRCINC",$J array
"RTN","GMRCITR",70,0)
 N ACT,GMRCSV,TAB
"RTN","GMRCITR",71,0)
 I $O(GMRCLOG(0)) D
"RTN","GMRCITR",72,0)
 . K GMRCDAS
"RTN","GMRCITR",73,0)
 . K ^TMP("GMRCS",$J),^TMP("GMRCINC",$J)
"RTN","GMRCITR",74,0)
 S (GMRCDA,LINE)=0
"RTN","GMRCITR",75,0)
 S TAB="",$P(TAB," ",30)=""
"RTN","GMRCITR",76,0)
 F  S GMRCDA=$O(GMRCLOG(GMRCDA)) Q:'GMRCDA  D
"RTN","GMRCITR",77,0)
 . S ACT=0
"RTN","GMRCITR",78,0)
 . F  S ACT=$O(GMRCLOG(GMRCDA,ACT)) Q:'ACT  D
"RTN","GMRCITR",79,0)
 .. S GMRCLOG=$G(GMRCLOG(GMRCDA,ACT)) D
"RTN","GMRCITR",80,0)
 ... N ACTTXT,EDT,IERR,STA,GMRCACT,GMRCLOG0
"RTN","GMRCITR",81,0)
 ... S GMRCLOG0=$G(^GMR(123.6,GMRCLOG,0)) Q:'GMRCLOG0
"RTN","GMRCITR",82,0)
 ... S GMRCDA(0)=$G(^GMR(123,GMRCDA,40,ACT,0)) Q:'GMRCDA(0)
"RTN","GMRCITR",83,0)
 ... S LINE=LINE+1
"RTN","GMRCITR",84,0)
 ... S X=$P(GMRCLOG0,"^") D REGDTM^GMRCU
"RTN","GMRCITR",85,0)
 ... S EDT=$S(X]"":X,1:"No Date/Time")
"RTN","GMRCITR",86,0)
 ... S GMRCACT=$P(GMRCDA(0),"^",2)
"RTN","GMRCITR",87,0)
 ... S ACTTXT=$P($G(^GMR(123.1,+GMRCACT,0)),"^",1)
"RTN","GMRCITR",88,0)
 ... S:'$L(ACTTXT) ACTTXT=GMRCACT_" action?"
"RTN","GMRCITR",89,0)
 ... S STA=$P(GMRCLOG0,"^",3),STA=$$MSGSTAT^HLUTIL(STA) ; IA #3098
"RTN","GMRCITR",90,0)
 ... S STA=$S(+STA>0:$E($$GET1^DIQ(771.6,+STA,.01),1,22),1:"No Status")
"RTN","GMRCITR",91,0)
 ... S IERR=$T(@("ERR"_$P(GMRCLOG0,"^",8)_"^GMRCIUTL"))
"RTN","GMRCITR",92,0)
 ... S IERR=$S(IERR]"":$E($P(IERR,";",2),1,45),1:"No Error")
"RTN","GMRCITR",93,0)
 ... ;
"RTN","GMRCITR",94,0)
 ... S GMRCDAS(GMRCDA)=""
"RTN","GMRCITR",95,0)
 ... ; sort data
"RTN","GMRCITR",96,0)
 ... S GMRCSV=$S(GMRCS="C":GMRCDA,GMRCS="D":EDT,GMRCS="A":ACTTXT,1:STA)
"RTN","GMRCITR",97,0)
 ... S ^TMP("GMRCS",$J,GMRCSV,GMRCLOG)=GMRCDA
"RTN","GMRCITR",98,0)
 ... S ^TMP("GMRCS",$J,GMRCSV,GMRCLOG)=^TMP("GMRCS",$J,GMRCSV,GMRCLOG)_$E(TAB,1,13-$L(^(GMRCLOG)))_EDT_$E(TAB,1,5)_ACTTXT
"RTN","GMRCITR",99,0)
 ... S ^TMP("GMRCS",$J,GMRCSV,GMRCLOG)=^TMP("GMRCS",$J,GMRCSV,GMRCLOG)_$E(TAB,1,56-$L(^(GMRCLOG)))_STA
"RTN","GMRCITR",100,0)
 ... S ^TMP("GMRCS",$J,GMRCSV,GMRCLOG)=^TMP("GMRCS",$J,GMRCSV,GMRCLOG)_$E(TAB,1,84-$L(^(GMRCLOG)))_IERR
"RTN","GMRCITR",101,0)
 .. Q
"RTN","GMRCITR",102,0)
 . ; set data in array name
"RTN","GMRCITR",103,0)
 . N GMRC1,LINE
"RTN","GMRCITR",104,0)
 . S GMRC1="",LINE=0
"RTN","GMRCITR",105,0)
 . F  S GMRC1=$O(^TMP("GMRCS",$J,GMRC1)) Q:GMRC1=""  D
"RTN","GMRCITR",106,0)
 .. N GMRC2
"RTN","GMRCITR",107,0)
 .. S GMRC2=""
"RTN","GMRCITR",108,0)
 .. F  S GMRC2=$O(^TMP("GMRCS",$J,GMRC1,GMRC2)) Q:GMRC2=""  D
"RTN","GMRCITR",109,0)
 ... S LINE=LINE+1
"RTN","GMRCITR",110,0)
 ... S ^TMP("GMRCINC",$J,LINE,0)=$G(^TMP("GMRCS",$J,GMRC1,GMRC2))
"RTN","GMRCITR",111,0)
 .. Q
"RTN","GMRCITR",112,0)
 . Q
"RTN","GMRCITR",113,0)
 Q
"RTN","GMRCITR",114,0)
 ;
"RTN","GMRCITR",115,0)
HDR ; -- header code
"RTN","GMRCITR",116,0)
 S VALMHDR(1)="Transaction(s) for consult#: "_GMRCSEL
"RTN","GMRCITR",117,0)
 S VALMHDR(2)="From: "_$G(GMRCEDT1)_"   To: "_$G(GMRCEDT2)
"RTN","GMRCITR",118,0)
 Q
"RTN","GMRCITR",119,0)
LM ; set caption line
"RTN","GMRCITR",120,0)
 D CHGCAP^VALM("CAPTION LINE","Consult     Entry Date/Time    Activity                HL7 Message Status")
"RTN","GMRCITR",121,0)
 D CHGCAP^VALM("CAPTION LINE 1","Error")
"RTN","GMRCITR",122,0)
 Q
"RTN","GMRCITR",123,0)
SELECT ; select a consult for detailed display of information
"RTN","GMRCITR",124,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y,GMRCDDS
"RTN","GMRCITR",125,0)
 K GMRCLOG
"RTN","GMRCITR",126,0)
 S DIR(0)="NO^1:9999999^D CKSEL^GMRCITR(X) K:'GMRCDDS X"
"RTN","GMRCITR",127,0)
 S DIR("A")="Select a Consult number from the display"
"RTN","GMRCITR",128,0)
 S DIR("?")="This response must be a number from the display."
"RTN","GMRCITR",129,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCITR",130,0)
 K ^TMP("GMRCINC",$J)
"RTN","GMRCITR",131,0)
 S GMRCSEL=Y
"RTN","GMRCITR",132,0)
 D BLD(GMRCSEL)
"RTN","GMRCITR",133,0)
 N ACT,ENT,GMRCND,LINE
"RTN","GMRCITR",134,0)
 S (ACT,LINE)=0
"RTN","GMRCITR",135,0)
 F  S ACT=$O(^GMR(123.6,"C",GMRCSEL,ACT)) Q:'ACT  D
"RTN","GMRCITR",136,0)
 . S ENT=$O(^GMR(123.6,"C",GMRCSEL,ACT,0)) Q:'ENT  D
"RTN","GMRCITR",137,0)
 .. Q:'$D(^GMR(123.6,ENT,0))
"RTN","GMRCITR",138,0)
 .. N DIC,DR,DA,DIQ,GMRCA
"RTN","GMRCITR",139,0)
 .. S DIC="^GMR(123.6,",DR=".01:.08",DA=ENT,DIQ="GMRCA"
"RTN","GMRCITR",140,0)
 .. D EN^DIQ1
"RTN","GMRCITR",141,0)
 .. S LINE=LINE+1
"RTN","GMRCITR",142,0)
 .. S GMRCND="^TMP(""GMRCINC"",$J,LINE,0)"
"RTN","GMRCITR",143,0)
 .. S @GMRCND="ENTRY DATE/TIME: "_GMRCA(123.6,ENT,.01),LINE=LINE+1
"RTN","GMRCITR",144,0)
 .. S @GMRCND="FACILITY: "_GMRCA(123.6,ENT,.02),LINE=LINE+1
"RTN","GMRCITR",145,0)
 .. S @GMRCND="MESSAGE #: "_GMRCA(123.6,ENT,.03),LINE=LINE+1
"RTN","GMRCITR",146,0)
 .. S @GMRCND="ACTIVITY #: "_GMRCA(123.6,ENT,.05),LINE=LINE+1
"RTN","GMRCITR",147,0)
 .. S @GMRCND="INCOMPLETE: "_GMRCA(123.6,ENT,.06),LINE=LINE+1
"RTN","GMRCITR",148,0)
 .. S @GMRCND="TRANS. ATTEMPTS: "_GMRCA(123.6,ENT,.07),LINE=LINE+1
"RTN","GMRCITR",149,0)
 .. S @GMRCND="ERROR: "_GMRCA(123.6,ENT,.08),LINE=LINE+1
"RTN","GMRCITR",150,0)
 .. S @GMRCND=""
"RTN","GMRCITR",151,0)
 S VALMHDR(1)="Detailed Display"
"RTN","GMRCITR",152,0)
 S VALMHDR(2)="Consult#: "_GMRCSEL
"RTN","GMRCITR",153,0)
 D CHGCAP^VALM("CAPTION LINE","")
"RTN","GMRCITR",154,0)
 D CHGCAP^VALM("CAPTION LINE 1","")
"RTN","GMRCITR",155,0)
 S VALMCNT=$O(^TMP("GMRCINC",$J," "),-1)
"RTN","GMRCITR",156,0)
 S VALMBG=1
"RTN","GMRCITR",157,0)
 Q
"RTN","GMRCITR",158,0)
CKSEL(X) ; check selection
"RTN","GMRCITR",159,0)
 N GMRCDA
"RTN","GMRCITR",160,0)
 S (GMRCDA,GMRCDDS)=0
"RTN","GMRCITR",161,0)
 F  S GMRCDA=$O(GMRCDAS(GMRCDA)) Q:'GMRCDA!GMRCDDS  D
"RTN","GMRCITR",162,0)
 . I GMRCDA=X S GMRCDDS=1
"RTN","GMRCITR",163,0)
 Q
"RTN","GMRCITST")
0^37^B18676001
"RTN","GMRCITST",1,0)
GMRCITST ;SLC/JFR - test IFC setup ; 11/30/01 10:30
"RTN","GMRCITST",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCITST",3,0)
EN ; start here
"RTN","GMRCITST",4,0)
 ;Prompt for choice of consult service or procedure
"RTN","GMRCITST",5,0)
 ;route to the ROUTING FACILITY and see if it's a GO
"RTN","GMRCITST",6,0)
 N DIR,X,Y,DIROUT,DIRUT,DTOUT
"RTN","GMRCITST",7,0)
 S DIR(0)="SO^P:procedure;C:consult service"
"RTN","GMRCITST",8,0)
 S DIR("A")="Would you like to test a procedure or consult service"
"RTN","GMRCITST",9,0)
 D ^DIR
"RTN","GMRCITST",10,0)
 I $D(DIRUT) Q
"RTN","GMRCITST",11,0)
 W !!
"RTN","GMRCITST",12,0)
 D RUN(Y)
"RTN","GMRCITST",13,0)
 W !!
"RTN","GMRCITST",14,0)
 K DIR,X,Y
"RTN","GMRCITST",15,0)
 S DIR(0)="YA",DIR("A")="Would you like to test another implementation? "
"RTN","GMRCITST",16,0)
 D ^DIR
"RTN","GMRCITST",17,0)
 I Y=1 G EN
"RTN","GMRCITST",18,0)
 Q
"RTN","GMRCITST",19,0)
RUN(GMRCTYP) ; check the procedure or service for proper setup
"RTN","GMRCITST",20,0)
 N DIR,X,Y,DIROUT,DIRUT,DTOUT,SERV,PROC,GMRC773,HLL,LINK,HL
"RTN","GMRCITST",21,0)
 I GMRCTYP="P" D
"RTN","GMRCITST",22,0)
 . S DIR(0)="PA^123.3:EMQ"
"RTN","GMRCITST",23,0)
 . S DIR("A")="Select the GMRC Procedure that you'd like to test: "
"RTN","GMRCITST",24,0)
 I GMRCTYP="C" D
"RTN","GMRCITST",25,0)
 . S DIR(0)="PA^123.5:EMQ"
"RTN","GMRCITST",26,0)
 . S DIR("A")="Select the Consult service that you'd like to test: "
"RTN","GMRCITST",27,0)
 . S DIR("A")="Select the Consult service that you'd like to test: "
"RTN","GMRCITST",28,0)
 D ^DIR
"RTN","GMRCITST",29,0)
 I $G(Y)'>0 W !,"No procedure or service selected." Q
"RTN","GMRCITST",30,0)
 I GMRCTYP="P" S PROC=+Y I '$$TSTPROC(PROC) Q
"RTN","GMRCITST",31,0)
 I GMRCTYP="C" S SERV=+Y I '$$TSTSERV(SERV) Q
"RTN","GMRCITST",32,0)
 ;
"RTN","GMRCITST",33,0)
 ;send msg
"RTN","GMRCITST",34,0)
 K ^TMP("HLS",$J)
"RTN","GMRCITST",35,0)
 D INIT^HLFNC2("GMRC IFC ORM TEST",.HL)
"RTN","GMRCITST",36,0)
 S ^TMP("HLS",$J,1)=$$ORCTST^GMRCISG1
"RTN","GMRCITST",37,0)
 I $G(PROC) S ^TMP("HLS",$J,2)=$$OBRTST^GMRCISG1(PROC,"P")
"RTN","GMRCITST",38,0)
 I $G(SERV) S ^TMP("HLS",$J,2)=$$OBRTST^GMRCISG1(SERV,"C")
"RTN","GMRCITST",39,0)
 S LINK=$$ROUTE($S($G(PROC):PROC_";GMR(123.3,",1:SERV_";GMR(123.5,"))
"RTN","GMRCITST",40,0)
 I '$L(LINK) D  Q  ;problem with the HL LOGICAL LINK
"RTN","GMRCITST",41,0)
 . W !!,"The proper HL LOGICAL link could not be located!"
"RTN","GMRCITST",42,0)
 . W !,"Can't continue to test.  Contact IRM."
"RTN","GMRCITST",43,0)
 S HLL("LINKS",1)=LINK
"RTN","GMRCITST",44,0)
 W !!,"   attempting to connect to remote system...",!
"RTN","GMRCITST",45,0)
 D DIRECT^HLMA("GMRC IFC ORM TEST","GM",1,.GMRC773)
"RTN","GMRCITST",46,0)
 I +$P(GMRC773,U,2) D  Q  ;problem with the HL link 
"RTN","GMRCITST",47,0)
 . W !,"There was a problem communicating with the remote site."
"RTN","GMRCITST",48,0)
 . W !,"IRM may need to check the HL7 communications."
"RTN","GMRCITST",49,0)
 N HLNODE,SEG,I  ;process response
"RTN","GMRCITST",50,0)
 K ^TMP("GMRCIF",$J)
"RTN","GMRCITST",51,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","GMRCITST",52,0)
 .S ^TMP("GMRCIF",$J,$P(HLNODE,"|"))=$E(HLNODE,5,999)
"RTN","GMRCITST",53,0)
 I $P(^TMP("GMRCIF",$J,"MSA"),"|")="AA" D
"RTN","GMRCITST",54,0)
 . W !!,"Congratulations!  You're configured correctly."
"RTN","GMRCITST",55,0)
 I $P(^TMP("GMRCIF",$J,"MSA"),"|")="AR" D
"RTN","GMRCITST",56,0)
 . N ERR,GMRCER
"RTN","GMRCITST",57,0)
 . W !!,"There is an implementation problem. The remote site indicated:"
"RTN","GMRCITST",58,0)
 . S ERR=$P(^TMP("GMRCIF",$J,"MSA"),"|",3),GMRCER=+ERR
"RTN","GMRCITST",59,0)
 . I ERR S ERR="ERR"_ERR_"^GMRCIUTL" S ERR=$T(@ERR),ERR=$P(ERR,";",2)
"RTN","GMRCITST",60,0)
 . W !,?5,ERR_$S(+GMRCER:" ("_GMRCER_")",1:" (HL7 ERROR)")
"RTN","GMRCITST",61,0)
 K ^TMP("GMRCIF",$J),^TMP("HLS",$J),HLNEXT,HLQUIT
"RTN","GMRCITST",62,0)
 Q
"RTN","GMRCITST",63,0)
 ;
"RTN","GMRCITST",64,0)
TSTPROC(GMRCPR) ;check procedure and make sure it has required fields for IFC
"RTN","GMRCITST",65,0)
 ; Input:
"RTN","GMRCITST",66,0)
 ;  GMRCPR = ien from file 123.3
"RTN","GMRCITST",67,0)
 ;
"RTN","GMRCITST",68,0)
 ; Output:
"RTN","GMRCITST",69,0)
 ;  1 = configured correctly
"RTN","GMRCITST",70,0)
 ;  0 = one or more fields missing
"RTN","GMRCITST",71,0)
 ; 
"RTN","GMRCITST",72,0)
 I '$D(^GMR(123.3,GMRCPR,"IFC")) D  Q 0
"RTN","GMRCITST",73,0)
 . W !!,"This procedure is not configured for Inter-facility purposes."
"RTN","GMRCITST",74,0)
 I '$P(^GMR(123.3,GMRCPR,"IFC"),U) D  Q 0
"RTN","GMRCITST",75,0)
 . W !!,"This procedure has no IFC ROUTING FACILITY entered."
"RTN","GMRCITST",76,0)
 I '$L($P(^GMR(123.3,GMRCPR,"IFC"),U,2)) D  Q 0
"RTN","GMRCITST",77,0)
 . W !!,"This procedure has no IFC REMOTE NAME entered."
"RTN","GMRCITST",78,0)
 Q 1
"RTN","GMRCITST",79,0)
 ;
"RTN","GMRCITST",80,0)
TSTSERV(GMRCSS) ;check service and make sure it has required fields for IFC
"RTN","GMRCITST",81,0)
 ; Input:
"RTN","GMRCITST",82,0)
 ;  GMRCSS = ien from file 123.5
"RTN","GMRCITST",83,0)
 ;
"RTN","GMRCITST",84,0)
 ; Output:
"RTN","GMRCITST",85,0)
 ;  1 = configured correctly
"RTN","GMRCITST",86,0)
 ;  0 = one or more fields missing
"RTN","GMRCITST",87,0)
 ; 
"RTN","GMRCITST",88,0)
 I '$D(^GMR(123.5,GMRCSS,"IFC")) D  Q 0
"RTN","GMRCITST",89,0)
 . W !!,"This service is not configured for Inter-facility purposes."
"RTN","GMRCITST",90,0)
 I '$P(^GMR(123.5,GMRCSS,"IFC"),U) D  Q 0
"RTN","GMRCITST",91,0)
 . W !!,"This service has no IFC ROUTING FACILITY entered."
"RTN","GMRCITST",92,0)
 I '$L($P(^GMR(123.5,GMRCSS,"IFC"),U,2)) D  Q 0
"RTN","GMRCITST",93,0)
 . W !!,"This service has no IFC REMOTE NAME entered."
"RTN","GMRCITST",94,0)
 Q 1
"RTN","GMRCITST",95,0)
 ;
"RTN","GMRCITST",96,0)
ROUTE(GMRCOI) ; get the right HL link for testing
"RTN","GMRCITST",97,0)
 ;Input: 
"RTN","GMRCITST",98,0)
 ;  GMRCOI = ien from file 123.3 or 123.5 in var ptr format
"RTN","GMRCITST",99,0)
 ;
"RTN","GMRCITST",100,0)
 ;Output:
"RTN","GMRCITST",101,0)
 ;   the logical link to send the message to in format
"RTN","GMRCITST",102,0)
 ;     "GMRC IFC SUBSC^VHAHIN"
"RTN","GMRCITST",103,0)
 ;
"RTN","GMRCITST",104,0)
 N SITE,GMRCLINK,STA
"RTN","GMRCITST",105,0)
 I '$G(GMRCOI) Q ""
"RTN","GMRCITST",106,0)
 I $P(GMRCOI,";",2)[123.3 D
"RTN","GMRCITST",107,0)
 . S SITE=$P($G(^GMR(123.3,+GMRCOI,"IFC")),U)
"RTN","GMRCITST",108,0)
 I $P(GMRCOI,";",2)[123.5 D
"RTN","GMRCITST",109,0)
 . S SITE=$P($G(^GMR(123.5,+GMRCOI,"IFC")),U)
"RTN","GMRCITST",110,0)
 I '$G(SITE) Q ""
"RTN","GMRCITST",111,0)
 S STA=$$STA^XUAF4(SITE)
"RTN","GMRCITST",112,0)
 I '$L(STA) Q ""
"RTN","GMRCITST",113,0)
 D LINK^HLUTIL3(STA,.GMRCLINK,"I")
"RTN","GMRCITST",114,0)
 S GMRCLINK=$O(GMRCLINK(0)) I 'GMRCLINK Q "" ; no link for that site
"RTN","GMRCITST",115,0)
 S GMRCLINK=GMRCLINK(GMRCLINK) I '$L(GMRCLINK) Q "" ;no link name
"RTN","GMRCITST",116,0)
 Q "GMRC IFC SUBSC^"_GMRCLINK
"RTN","GMRCIUTL")
0^12^B29858704
"RTN","GMRCIUTL",1,0)
GMRCIUTL ;SLC/JFR - UTILITIES FOR INTER-FACILITY CONSULTS ;11/26/01 15:34
"RTN","GMRCIUTL",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22**;DEC 27, 1997
"RTN","GMRCIUTL",3,0)
 ;
"RTN","GMRCIUTL",4,0)
 Q  ;don't start at the top
"RTN","GMRCIUTL",5,0)
 ;
"RTN","GMRCIUTL",6,0)
DIV(LOC) ; get the division from a hospital location
"RTN","GMRCIUTL",7,0)
 ; Input  -- LOC  HOSPITAL LOCATION file (#44) IEN
"RTN","GMRCIUTL",8,0)
 ; Output -- INSTITUTION file (#4) IEN^INSTITUTION file (#4) NAME
"RTN","GMRCIUTL",9,0)
 ;
"RTN","GMRCIUTL",10,0)
 N GMRCHL,GMRCSTN,GMRCDIV
"RTN","GMRCIUTL",11,0)
 S GMRCHL=$P($G(^SC(+LOC,0)),U,15)
"RTN","GMRCIUTL",12,0)
 I +GMRCHL D
"RTN","GMRCIUTL",13,0)
 . S GMRCSTN=$$SITE^VASITE(,GMRCHL)
"RTN","GMRCIUTL",14,0)
 . I $P(GMRCSTN,U)>0,($P(GMRCSTN,U,2)]"") D
"RTN","GMRCIUTL",15,0)
 . . S GMRCDIV=$P(GMRCSTN,U)_U_$P(GMRCSTN,U,2)
"RTN","GMRCIUTL",16,0)
 I '$G(GMRCDIV) D
"RTN","GMRCIUTL",17,0)
 . S GMRCDIV=+$G(DUZ(2))_U_$P($$NS^XUAF4(+$G(DUZ(2))),U)
"RTN","GMRCIUTL",18,0)
 Q GMRCDIV
"RTN","GMRCIUTL",19,0)
 ;
"RTN","GMRCIUTL",20,0)
HLNAME(GMRCWHO)        ;HL7 format a name from a pointer to 200
"RTN","GMRCIUTL",21,0)
 Q:'$D(^VA(200,+GMRCWHO,0)) ""
"RTN","GMRCIUTL",22,0)
 N GMRC
"RTN","GMRCIUTL",23,0)
 S GMRC("FILE")=200
"RTN","GMRCIUTL",24,0)
 S GMRC("IENS")=GMRCWHO
"RTN","GMRCIUTL",25,0)
 S GMRC("FIELD")=.01
"RTN","GMRCIUTL",26,0)
 Q $$HLNAME^XLFNAME(.GMRC,"S")
"RTN","GMRCIUTL",27,0)
 ;
"RTN","GMRCIUTL",28,0)
UNHLNAME(GMRCNM,GMRCNMC,STD,DEL) ;return regular name from HL7 name
"RTN","GMRCIUTL",29,0)
 ;Input:
"RTN","GMRCIUTL",30,0)
 ;  GMRCNM  = HL7 formatted name from a message
"RTN","GMRCIUTL",31,0)
 ;  GMRCNMC = array to retun name components in (by reference)
"RTN","GMRCIUTL",32,0)
 ;  STD     = 1 or 0; 1 = return name given middle family suffix
"RTN","GMRCIUTL",33,0)
 ;  DEL     = delimiting character separating name components
"RTN","GMRCIUTL",34,0)
 ;
"RTN","GMRCIUTL",35,0)
 ;Output:
"RTN","GMRCIUTL",36,0)
 ;  GMRCNMC=DREW,NANCY M III MD or NANCY M DREW III MD
"RTN","GMRCIUTL",37,0)
 ;  GMRCNMC("FAMILY")=DREW
"RTN","GMRCIUTL",38,0)
 ;  GMRCNMC("GIVEN")=NANCY
"RTN","GMRCIUTL",39,0)
 ;  GMRCNMC("MIDDLE")=M
"RTN","GMRCIUTL",40,0)
 ;  GMRCNM("SUFFIX")=III MD
"RTN","GMRCIUTL",41,0)
 ;
"RTN","GMRCIUTL",42,0)
 I '$D(DEL) S DEL=U
"RTN","GMRCIUTL",43,0)
 S GMRCNMC=GMRCNM
"RTN","GMRCIUTL",44,0)
 S GMRCNMC=$$FMNAME^XLFNAME(.GMRCNMC,"CS")
"RTN","GMRCIUTL",45,0)
 I $G(STD) S GMRCNMC=$$NAMEFMT^XLFNAME(.GMRCNMC,"G","Dc")
"RTN","GMRCIUTL",46,0)
 Q
"RTN","GMRCIUTL",47,0)
 ;
"RTN","GMRCIUTL",48,0)
TRIMWP(ARRAY,PIECE) ;trim OBX or NTE segments so that only comment remains
"RTN","GMRCIUTL",49,0)
 ; Input:
"RTN","GMRCIUTL",50,0)
 ;   ARRAY  = the array in which the segments are contained
"RTN","GMRCIUTL",51,0)
 ;      ex. ^TMP("GMRCIF",541083753,"OBX",3,3)=3|TX|^COMMENTS^|3|text "
"RTN","GMRCIUTL",52,0)
 ;   PIECE  = the piece in the array where the text lives
"RTN","GMRCIUTL",53,0)
 ; 
"RTN","GMRCIUTL",54,0)
 ; Output:
"RTN","GMRCIUTL",55,0)
 ;   trimmed array 
"RTN","GMRCIUTL",56,0)
 ;     ex. ^TMP("GMRCIF",541083753,"OBX",3,3)="text"
"RTN","GMRCIUTL",57,0)
 ;
"RTN","GMRCIUTL",58,0)
 N I S I=0
"RTN","GMRCIUTL",59,0)
 F  S I=$O(@(ARRAY)@(I)) Q:'I  D
"RTN","GMRCIUTL",60,0)
 . S @(ARRAY)@(I)=$P(@(ARRAY)@(I),"|",PIECE)
"RTN","GMRCIUTL",61,0)
 Q
"RTN","GMRCIUTL",62,0)
 ;
"RTN","GMRCIUTL",63,0)
VALMSG(GMRCPID,GMRCORC) ; determine if message is valid
"RTN","GMRCIUTL",64,0)
 ;Input:
"RTN","GMRCIUTL",65,0)
 ;  GMRCPID  = PID segment from an IFC HL7 message
"RTN","GMRCIUTL",66,0)
 ;  GMRCORC  = ORC segment from an IFC HL7 message
"RTN","GMRCIUTL",67,0)
 ;
"RTN","GMRCIUTL",68,0)
 ;Output:
"RTN","GMRCIUTL",69,0)
 ;  1     = message passes screening on patient, institution and ien
"RTN","GMRCIUTL",70,0)
 ;  0^msg = message failed screening
"RTN","GMRCIUTL",71,0)
 ;    possible msg values:
"RTN","GMRCIUTL",72,0)
 ;        
"RTN","GMRCIUTL",73,0)
 ;
"RTN","GMRCIUTL",74,0)
 ;
"RTN","GMRCIUTL",75,0)
 N GMRCDA,GMRCINST
"RTN","GMRCIUTL",76,0)
 Q
"RTN","GMRCIUTL",77,0)
 ;
"RTN","GMRCIUTL",78,0)
URG(GMRCO) ;return urgency code to send in HL7 msg
"RTN","GMRCIUTL",79,0)
 ; Input:
"RTN","GMRCIUTL",80,0)
 ;   GMRCO = consult ien from file 123
"RTN","GMRCIUTL",81,0)
 ;
"RTN","GMRCIUTL",82,0)
 ; Output:
"RTN","GMRCIUTL",83,0)
 ;   S   = stat
"RTN","GMRCIUTL",84,0)
 ;   R   = routine
"RTN","GMRCIUTL",85,0)
 ;   ZT  = today
"RTN","GMRCIUTL",86,0)
 ;   Z24 = within 24 hours
"RTN","GMRCIUTL",87,0)
 ;   Z48 = within 48 hours
"RTN","GMRCIUTL",88,0)
 ;   Z72 = within 72 hours
"RTN","GMRCIUTL",89,0)
 ;   ZW  = within 1 week
"RTN","GMRCIUTL",90,0)
 ;   ZM  = within 1 month
"RTN","GMRCIUTL",91,0)
 ;   ZNA = next available
"RTN","GMRCIUTL",92,0)
 ;   ZE  = emergency
"RTN","GMRCIUTL",93,0)
 ;
"RTN","GMRCIUTL",94,0)
 N URG,PROT,ORURG
"RTN","GMRCIUTL",95,0)
 S PROT=$P(^GMR(123,GMRCO,0),U,9)
"RTN","GMRCIUTL",96,0)
 S URG=$P($G(^ORD(101,+PROT,0)),U),URG=$P(URG," - ",2)
"RTN","GMRCIUTL",97,0)
 I '$L(URG) Q ""
"RTN","GMRCIUTL",98,0)
 S ORURG=$S(URG="EMERGENCY":"STAT",URG="NOW":"STAT",URG="OUTPATIENT":"ROUTINE",1:URG)
"RTN","GMRCIUTL",99,0)
 S ORURG=$O(^ORD(101.42,"B",ORURG,0))
"RTN","GMRCIUTL",100,0)
 I '+ORURG Q ""
"RTN","GMRCIUTL",101,0)
 Q $P(^ORD(101.42,ORURG,0),"^",2)
"RTN","GMRCIUTL",102,0)
GETSERV(GMRCSRV) ;return local service from IFC service in HL7 msg
"RTN","GMRCIUTL",103,0)
 ;Input:
"RTN","GMRCIUTL",104,0)
 ;  GMRCSRV = OBR-4 (e.g. 4^CARDIOLOGY^578VA1235)
"RTN","GMRCIUTL",105,0)
 ;
"RTN","GMRCIUTL",106,0)
 ;Output:
"RTN","GMRCIUTL",107,0)
 ;  ien of local service
"RTN","GMRCIUTL",108,0)
 N SERV,SENDER,ERROR
"RTN","GMRCIUTL",109,0)
 S SERV=$$FIND1^DIC(123.5,"","X",$P(GMRCSRV,U,2))
"RTN","GMRCIUTL",110,0)
 I 'SERV S ERROR="-1^ERROR IN SERVICE NAME^701"
"RTN","GMRCIUTL",111,0)
 I '$D(ERROR) D
"RTN","GMRCIUTL",112,0)
 . S SENDER=$P(GMRCSRV,U,3)
"RTN","GMRCIUTL",113,0)
 . S SENDER=+$$IEN^XUAF4($P(SENDER,"VA1235"))
"RTN","GMRCIUTL",114,0)
 I '$D(ERROR) D
"RTN","GMRCIUTL",115,0)
 . I $O(^GMR(123.5,SERV,"IFCS","B",SENDER,0)) Q
"RTN","GMRCIUTL",116,0)
 . S ERROR="-1^IMPROPER SENDING FACILITY^301"
"RTN","GMRCIUTL",117,0)
 Q $S($D(ERROR):ERROR,1:SERV)
"RTN","GMRCIUTL",118,0)
 ;
"RTN","GMRCIUTL",119,0)
GETPROC(GMRCSID) ;return procedure and sercvice ordered by IFC
"RTN","GMRCIUTL",120,0)
 ;Input:
"RTN","GMRCIUTL",121,0)
 ;  GMRCSID  =OBR-4 from IFC msg  (e.g. "31^EKG^578VA1233" )
"RTN","GMRCIUTL",122,0)
 ;
"RTN","GMRCIUTL",123,0)
 ;Output:
"RTN","GMRCIUTL",124,0)
 ;  string in format  local_proc_ien^service_ien_to perform
"RTN","GMRCIUTL",125,0)
 ;
"RTN","GMRCIUTL",126,0)
 N GMRCSS,GMRCPR,SENDER,ERROR
"RTN","GMRCIUTL",127,0)
 S GMRCPR=$$FIND1^DIC(123.3,"","X",$P(GMRCSID,U,2))
"RTN","GMRCIUTL",128,0)
 I 'GMRCPR S ERROR="-1^ERROR IN PROCEDURE NAME^501"
"RTN","GMRCIUTL",129,0)
 I '$D(ERROR) D
"RTN","GMRCIUTL",130,0)
 . S SENDER=$P(GMRCSID,U,3)
"RTN","GMRCIUTL",131,0)
 . S SENDER=+$$IEN^XUAF4($P(SENDER,"VA1233"))
"RTN","GMRCIUTL",132,0)
 I '$D(ERROR) D
"RTN","GMRCIUTL",133,0)
 . I $O(^GMR(123.3,GMRCPR,"IFCS","B",SENDER,0)) Q
"RTN","GMRCIUTL",134,0)
 . S ERROR="-1^IMPROPER SENDING FACILITY^401"
"RTN","GMRCIUTL",135,0)
 I '$D(ERROR) D
"RTN","GMRCIUTL",136,0)
 . D GETSVC^GMRCPR0(.GMRCSS,GMRCPR)
"RTN","GMRCIUTL",137,0)
 . I GMRCSS>1 S ERROR="-1^MULTIPLE SERVICES DEFINED^601" Q
"RTN","GMRCIUTL",138,0)
 . S GMRCSS=+GMRCSS(1)
"RTN","GMRCIUTL",139,0)
 Q $S($D(ERROR):ERROR,1:GMRCPR_U_GMRCSS)
"RTN","GMRCIUTL",140,0)
CODEOI(GMRCDA) ; look at ordered procedure or service and code it for IFC msg
"RTN","GMRCIUTL",141,0)
 ;Input:
"RTN","GMRCIUTL",142,0)
 ;  GMRCDA = ien from file 123 of consult or procedure to send as IFC
"RTN","GMRCIUTL",143,0)
 ;
"RTN","GMRCIUTL",144,0)
 ;Output:
"RTN","GMRCIUTL",145,0)
 ;  consult:  svc_ien^remote_service_name^station#_VA1235
"RTN","GMRCIUTL",146,0)
 ;  proc:     proc_ien^remote_proc_name^station#_VA1233
"RTN","GMRCIUTL",147,0)
 ;
"RTN","GMRCIUTL",148,0)
 N GMRCPR,GMRCSS,GMRCSIT,GMRCOI
"RTN","GMRCIUTL",149,0)
 S GMRCSIT=$$STA^XUAF4($$KSP^XUPARAM("INST"))
"RTN","GMRCIUTL",150,0)
 I +$P(^GMR(123,GMRCDA,0),U,8) D  ; it's a procedure
"RTN","GMRCIUTL",151,0)
 . S GMRCPR=+$P(^GMR(123,GMRCDA,0),U,8)
"RTN","GMRCIUTL",152,0)
 . S GMRCOI=GMRCPR_U_$P(^GMR(123.3,GMRCPR,"IFC"),U,2)_U_GMRCSIT_"VA1233"
"RTN","GMRCIUTL",153,0)
 I '$D(GMRCOI) D  ; it's a consult
"RTN","GMRCIUTL",154,0)
 . S GMRCSS=$P(^GMR(123,GMRCDA,0),U,5)
"RTN","GMRCIUTL",155,0)
 . S GMRCOI=GMRCSS_U_$P(^GMR(123.5,GMRCSS,"IFC"),U,2)_U_GMRCSIT_"VA1235"
"RTN","GMRCIUTL",156,0)
 Q GMRCOI
"RTN","GMRCIUTL",157,0)
 ;
"RTN","GMRCIUTL",158,0)
RESP(GMRCAC,GMRCMID,GMRCOC,GMRCDA,GMRCERR) ;build and send appl ACK/NAK 
"RTN","GMRCIUTL",159,0)
 ; Input:
"RTN","GMRCIUTL",160,0)
 ;   GMRCAC  = acknowledgement code (AA or AR)
"RTN","GMRCIUTL",161,0)
 ;   GMRCMID = message id from original msg
"RTN","GMRCIUTL",162,0)
 ;   GMRCOC  = order control from original msg ORC
"RTN","GMRCIUTL",163,0)
 ;   GMRCDA  = ien of consult being worked on
"RTN","GMRCIUTL",164,0)
 ;   GMRCERR = only defined if an error is found
"RTN","GMRCIUTL",165,0)
 ;
"RTN","GMRCIUTL",166,0)
 S HLA("HLA",1)=$$MSA^GMRCISEG(GMRCAC,GMRCMID,$G(GMRCERR))
"RTN","GMRCIUTL",167,0)
 I $D(GMRCOC) D
"RTN","GMRCIUTL",168,0)
 . I GMRCOC="NW" S HLA("HLA",2)=$$ORCRESP^GMRCISG1(GMRCDA,"OK","IP")
"RTN","GMRCIUTL",169,0)
 Q
"RTN","GMRCIUTL",170,0)
 ;
"RTN","GMRCIUTL",171,0)
LOGMSG(GMRCO,GMRCACT,GMRCMSG,GMRCER) ;create or update IFC MESSAGE LOG entry
"RTN","GMRCIUTL",172,0)
 ;Input:
"RTN","GMRCIUTL",173,0)
 ; GMRC0   = ien from file 123
"RTN","GMRCIUTL",174,0)
 ; GMRCACT = ien in 40 multiple from file 123
"RTN","GMRCIUTL",175,0)
 ; GMRCMSG = HL7 message ID of message being sent 
"RTN","GMRCIUTL",176,0)
 ; GMRCER  = error number if can't transmit immediately
"RTN","GMRCIUTL",177,0)
 ;
"RTN","GMRCIUTL",178,0)
 N GMRCLG,GMRCERR,FDA
"RTN","GMRCIUTL",179,0)
 S GMRCLG=$O(^GMR(123.6,"AC",GMRCO,GMRCACT,1,0))
"RTN","GMRCIUTL",180,0)
 I +GMRCLG D  Q  ; update existing incomplete record.
"RTN","GMRCIUTL",181,0)
 . S FDA(1,123.6,GMRCLG_",",.01)=$$NOW^XLFDT
"RTN","GMRCIUTL",182,0)
 . S FDA(1,123.6,GMRCLG_",",.03)=$G(GMRCMSG)
"RTN","GMRCIUTL",183,0)
 . S FDA(1,123.6,GMRCLG_",",.07)=$P(^GMR(123.6,GMRCLG,0),U,7)+1
"RTN","GMRCIUTL",184,0)
 . I $G(GMRCER) S FDA(1,123.6,GMRCLG_",",.08)=GMRCER
"RTN","GMRCIUTL",185,0)
 . D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIUTL",186,0)
 ;
"RTN","GMRCIUTL",187,0)
 ; create new record
"RTN","GMRCIUTL",188,0)
 S FDA(1,123.6,"+1,",.01)=$$NOW^XLFDT
"RTN","GMRCIUTL",189,0)
 S FDA(1,123.6,"+1,",.02)=$P(^GMR(123,GMRCO,0),U,23)
"RTN","GMRCIUTL",190,0)
 S FDA(1,123.6,"+1,",.03)=$G(GMRCMSG)
"RTN","GMRCIUTL",191,0)
 S FDA(1,123.6,"+1,",.04)=GMRCO
"RTN","GMRCIUTL",192,0)
 S FDA(1,123.6,"+1,",.05)=GMRCACT
"RTN","GMRCIUTL",193,0)
 S FDA(1,123.6,"+1,",.06)=1
"RTN","GMRCIUTL",194,0)
 S FDA(1,123.6,"+1,",.07)=1
"RTN","GMRCIUTL",195,0)
 I $G(GMRCER) S FDA(1,123.6,"+1,",.08)=GMRCER
"RTN","GMRCIUTL",196,0)
 D UPDATE^DIE("","FDA(1)","GMRCLG","GMRCERR")
"RTN","GMRCIUTL",197,0)
 Q
"RTN","GMRCIUTL",198,0)
 ;
"RTN","GMRCIUTL",199,0)
ERR101 ;Unknown Consult/Procedure request
"RTN","GMRCIUTL",200,0)
ERR201 ;Unknown Patient
"RTN","GMRCIUTL",201,0)
ERR202 ;Local or unknown MPI identifiers
"RTN","GMRCIUTL",202,0)
ERR301 ;Service not matched to receiving facility
"RTN","GMRCIUTL",203,0)
ERR401 ;Procedure not matched to receiving facility
"RTN","GMRCIUTL",204,0)
ERR501 ;Error in procedure name
"RTN","GMRCIUTL",205,0)
ERR601 ;Multiple services matched to procedure
"RTN","GMRCIUTL",206,0)
ERR701 ;Error in Service name
"RTN","GMRCIUTL",207,0)
ERR801 ;Inappropriate action for specified request
"RTN","GMRCIUTL",208,0)
ERR802 ;Duplicate, activity not filed
"RTN","GMRCIUTL",209,0)
ERR901 ;Unable to update record successfully
"RTN","GMRCIUTL",210,0)
ERR902 ;Earlier pending transactions
"RTN","GMRCIUTL",211,0)
ERR903 ;HL Logical Link not found
"RTN","GMRCIUTL",212,0)
ERR904 ;VistA HL7 unable to send transaction
"RTN","GMRCP")
0^24^B12740937
"RTN","GMRCP",1,0)
GMRCP ;SLC/DLT,DCM - Message audit and status process ;4/19/01  11:52
"RTN","GMRCP",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,17,22**;DEC 27, 1997
"RTN","GMRCP",3,0)
 ;Processing action on Generic Requests/Consults from OE/RR
"RTN","GMRCP",4,0)
MSG(GMRCDFN,GMRCALRM,GMRCIFN,ORN,GMRCADUZ,FLG) ;send alert notification information to OERR for notification or update
"RTN","GMRCP",5,0)
 ;GMRCDFN=patient's DFN           GMRCORFN=OR file # ^OR(100,GMRCORFN
"RTN","GMRCP",6,0)
 ;GMRCALRM=alert message to be displayed with alert
"RTN","GMRCP",7,0)
 ;GMRCIFN=internal file number of consult in file 123
"RTN","GMRCP",8,0)
 ;GMRCADUZ=set in call to EN^GMRCT=array of providers who will be alerted
"RTN","GMRCP",9,0)
 ;FLG=1 if need to get list of service's providers, 0 if service dc'd.
"RTN","GMRCP",10,0)
 ;ORN=IFN from file ^ORD(100.9, for consult notification action
"RTN","GMRCP",11,0)
 N GMRCSS,GMRCORFN
"RTN","GMRCP",12,0)
 S GMRCORFN=$P(^GMR(123,+GMRCIFN,0),"^",3)
"RTN","GMRCP",13,0)
 S GMRCSS=$P($G(^GMR(123,+GMRCIFN,0)),"^",5)
"RTN","GMRCP",14,0)
 I FLG,GMRCSS D EN^GMRCT(GMRCSS)
"RTN","GMRCP",15,0)
 I $P($G(^GMR(123,+GMRCIFN,12)),U,5)="P" D
"RTN","GMRCP",16,0)
 . Q:ORN=27  ; don't notify requestor if a new order they placed, duh...
"RTN","GMRCP",17,0)
 . I DUZ=+$P(^GMR(123,+GMRCIFN,0),U,14) Q  ; don;t alert on own actions
"RTN","GMRCP",18,0)
 . S GMRCADUZ(+$P(^GMR(123,+GMRCIFN,0),U,14))=""
"RTN","GMRCP",19,0)
 I FLG,$P(^GMR(123,+GMRCIFN,0),"^",11) S GMRCADUZ($P(^(0),"^",11))=""
"RTN","GMRCP",20,0)
 S:'$D(GMRCADUZ) GMRCADUZ=""
"RTN","GMRCP",21,0)
 D EN^ORB3(ORN,GMRCDFN,GMRCORFN,.GMRCADUZ,GMRCALRM,GMRCIFN)
"RTN","GMRCP",22,0)
 Q
"RTN","GMRCP",23,0)
AUDIT ;Build processing activity audit trail multiple.
"RTN","GMRCP",24,0)
 S GMRCDT=$$NOW^XLFDT
"RTN","GMRCP",25,0)
AUDIT0 ;alternate entry with date already defined
"RTN","GMRCP",26,0)
 L +^GMR(123,+GMRCO,40):5 I '$T S GMRCUT=1,GMRCERR=1,GMRCERMS="Activity Trail Not filed - Consult In Use By Another User." L -^GMR(123,+GMRCO,40)  Q
"RTN","GMRCP",27,0)
 S:'$D(^GMR(123,+GMRCO,40,0)) ^(0)="^123.02DA^^"
"RTN","GMRCP",28,0)
 S DA=$S($P(^GMR(123,+GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCP",29,0)
 S $P(^GMR(123,+GMRCO,40,0),"^",3,4)=DA_"^"_DA
"RTN","GMRCP",30,0)
AUDIT1 ;entry when the DA is not incremented (INCOMPLETE RPT writeovers)
"RTN","GMRCP",31,0)
 S GMRCORNP=$G(GMRCORNP) S:'$D(GMRCOM) GMRCOM=0
"RTN","GMRCP",32,0)
 S GMRCDEV=$G(GMRCDEV),GMRCFF=$G(GMRCFF),GMRCPA=$G(GMRCPA)
"RTN","GMRCP",33,0)
 S GMRCAD=$S('$D(GMRCAD):GMRCDT,1:GMRCAD)
"RTN","GMRCP",34,0)
 S GMRCRSLT=$G(GMRCRSLT) ;Added result with GMRC*3.0*4
"RTN","GMRCP",35,0)
 S DIE="^GMR(123,"_+GMRCO_",40,",DA(1)=+GMRCO
"RTN","GMRCP",36,0)
 I '$D(^GMR(123,DA(1),40,DA,0)) D
"RTN","GMRCP",37,0)
 . S DR=".01////^S X=GMRCDT;1////^S X=GMRCA;2////^S X=GMRCAD;3////^S X=GMRCORNP"
"RTN","GMRCP",38,0)
 . I GMRCA'=22 S DR=DR_";4////^S X=DUZ" ;if it's a print, pkg did it
"RTN","GMRCP",39,0)
 . S DR=DR_";6////^S X=GMRCFF;7////^S X=GMRCPA;8////^S X=GMRCDEV;9////^S X=GMRCRSLT"
"RTN","GMRCP",40,0)
 E  D
"RTN","GMRCP",41,0)
 . ;DR string on .01 allows write over, rather than forced new entry
"RTN","GMRCP",42,0)
 . S DR=".01///^S X=GMRCDT;1////^S X=GMRCA;2////^S X=GMRCAD;3////^S X=GMRCORNP;4////^S X=DUZ;6////^S X=GMRCFF;7////^S X=GMRCPA;8////^S X=GMRCDEV;9////^S X=GMRCRSLT"
"RTN","GMRCP",43,0)
 ;Added result to the DR string
"RTN","GMRCP",44,0)
 D ^DIE
"RTN","GMRCP",45,0)
 ;Enter comment
"RTN","GMRCP",46,0)
 I +$G(GMRCOM) S GMRCOM(0)=DA D
"RTN","GMRCP",47,0)
 . W !,"Enter COMMENT..."
"RTN","GMRCP",48,0)
 . N DIC,DWPK,DWLW,DIWESUB
"RTN","GMRCP",49,0)
 . S DIC=DIE_DA_",1,",DWPK=1,DWLW=74
"RTN","GMRCP",50,0)
 . S DIWESUB="COMMENTS" D EN^DIWE
"RTN","GMRCP",51,0)
 . I $P($G(^GMR(123.1,+$P(^GMR(123,+GMRCO,40,DA,0),U,2),0)),U)="ADDED COMMENT",'$O(^GMR(123,+GMRCO,40,DA,0)) D  Q
"RTN","GMRCP",52,0)
 .. S DA(1)=+GMRCO,DIK="^GMR(123,"_DA(1)_",40," D ^DIK K DIK
"RTN","GMRCP",53,0)
 .. Q
"RTN","GMRCP",54,0)
 . I $D(^GMR(123,+GMRCO,40,DA,0)),$O(^GMR(123,+GMRCO,40,DA,0)) S $P(GMRCOM,"^",2)=1
"RTN","GMRCP",55,0)
 . Q
"RTN","GMRCP",56,0)
 L -^GMR(123,+GMRCO,40)
"RTN","GMRCP",57,0)
 ; if an IFC, call event handler to generate a msg to remote site
"RTN","GMRCP",58,0)
 I $D(^GMR(123,GMRCO,12)),$L($P(^(12),U,5)) D
"RTN","GMRCP",59,0)
 . Q:'$D(^GMR(123,GMRCO,40,DA)) 
"RTN","GMRCP",60,0)
 . D TRIGR^GMRCIEVT(GMRCO,DA)
"RTN","GMRCP",61,0)
 ;
"RTN","GMRCP",62,0)
 K DIE,DA,DR,GMRCDEV,GMRCFF,GMRCPA,X,% Q
"RTN","GMRCP",63,0)
 ;
"RTN","GMRCP",64,0)
STATUS ;Update the status for the Request/Consultation File
"RTN","GMRCP",65,0)
 K GMRCQUT
"RTN","GMRCP",66,0)
 Q:'$D(GMRCSTS)!('$D(GMRCA))
"RTN","GMRCP",67,0)
 S DIE=123,DA=+GMRCO
"RTN","GMRCP",68,0)
 I $D(GMRCDR),$L(GMRCDR) S DR=GMRCDR
"RTN","GMRCP",69,0)
 E  S DR="8////^S X=GMRCSTS;9////^S X=GMRCA"
"RTN","GMRCP",70,0)
 L +^GMR(123,GMRCO):2 I '$T S GMRCQUT=1,GMRCERR=1,GMRCERMS="Unable to update status and last action - Consult In Use By Another User." Q
"RTN","GMRCP",71,0)
 D ^DIE
"RTN","GMRCP",72,0)
 L -^GMR(123,+GMRCO)
"RTN","GMRCP",73,0)
 K DIE,DA,DR,GMRCDR
"RTN","GMRCP",74,0)
 Q
"RTN","GMRCP5A")
0^22^B74868100
"RTN","GMRCP5A",1,0)
GMRCP5A ;SLC/DCM,RJS,MA - Print Consult form 513 (Gather Data - TIU Results) ;4/18/01  10:29
"RTN","GMRCP5A",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,13,12,15,21,22**;Dec 27, 1997
"RTN","GMRCP5A",3,0)
 ; Patch #21 added PRNTAUDT to this routine.
"RTN","GMRCP5A",4,0)
 ;
"RTN","GMRCP5A",5,0)
PRNT(GMRCIFN,TIUFLG,GMRCQUED,GMRCCPY,GMRCGUI,GMRCAUDT) ;
"RTN","GMRCP5A",6,0)
 ;
"RTN","GMRCP5A",7,0)
 ; Input Arguments:
"RTN","GMRCP5A",8,0)
 ;
"RTN","GMRCP5A",9,0)
 ;  GMRCIFN: IEN of the Consult/Request in file 123
"RTN","GMRCP5A",10,0)
 ;   TIUFLG: Called from TIU ?  1=yes 0=no
"RTN","GMRCP5A",11,0)
 ; GMRCQUED: Queued job ?  1=yes 0=no
"RTN","GMRCP5A",12,0)
 ;  GMRCCPY: Chart Copy ? C=Chart Copy  W=Working Copy  null=Not Applicable
"RTN","GMRCP5A",13,0)
 ;  GMRCGUI: Called from the GUI. (Only produce output in a formatted global.)
"RTN","GMRCP5A",14,0)
 ; GMRCAUDT:  Set to 1 in GMRCUTL1 if NW or DC consult.
"RTN","GMRCP5A",15,0)
 ; ZTIO:      Output device when job is tasked
"RTN","GMRCP5A",16,0)
 ;
"RTN","GMRCP5A",17,0)
 N GMRCSIG,GMRCSDT,GMRCCSIG,GMRCSIGT,GMRCADDS
"RTN","GMRCP5A",18,0)
 ;
"RTN","GMRCP5A",19,0)
 I GMRCGUI D  Q
"RTN","GMRCP5A",20,0)
 . D FORMAT(80)
"RTN","GMRCP5A",21,0)
 . D ASSMBL^GMRCP5C(GMRCGUI,80)
"RTN","GMRCP5A",22,0)
 . F GMRCX="GMRCTIU","RES","MCAR" K ^TMP("GMRCR",$J,GMRCX)
"RTN","GMRCP5A",23,0)
 . K ^TMP("GMRC",$J,"OUTPUT")
"RTN","GMRCP5A",24,0)
 . Q
"RTN","GMRCP5A",25,0)
 ;
"RTN","GMRCP5A",26,0)
 I 'TIUFLG,'GMRCQUED W @IOF I '$$CRT^GMRCP5C,$L($G(IO(0))),'(IO=IO(0)) U IO(0) W !,"PRINTING... "
"RTN","GMRCP5A",27,0)
 ;
"RTN","GMRCP5A",28,0)
 D FORMAT(IOM),ASSMBL^GMRCP5C(IOSL,IOM)
"RTN","GMRCP5A",29,0)
 U IO
"RTN","GMRCP5A",30,0)
 D PRINT^GMRCP5C(IOSL,IOM)
"RTN","GMRCP5A",31,0)
 ;
"RTN","GMRCP5A",32,0)
 I 'TIUFLG,'$$CRT^GMRCP5C U IO(0) D ^%ZISC
"RTN","GMRCP5A",33,0)
 ;
"RTN","GMRCP5A",34,0)
 I $G(GMRCQUED),$G(ZTSK) D KILL^%ZTLOAD
"RTN","GMRCP5A",35,0)
 ;
"RTN","GMRCP5A",36,0)
 F GMRCX="OUTPUT","SF513" K ^TMP("GMRC",$J,GMRCX)
"RTN","GMRCP5A",37,0)
 F GMRCX="GMRCTIU","RES","MCAR" K ^TMP("GMRCR",$J,GMRCX)
"RTN","GMRCP5A",38,0)
 ; If print device (ZTIO) do PRNTAUDT unless there is no GMRCAUDT
"RTN","GMRCP5A",39,0)
 ; GMRCAUDT=1 means print for NW or DC consult
"RTN","GMRCP5A",40,0)
 I $D(ZTIO),$D(GMRCAUDT) D PRNTAUDT(GMRCIFN,ZTIO,GMRCAUDT)
"RTN","GMRCP5A",41,0)
 Q
"RTN","GMRCP5A",42,0)
 ;
"RTN","GMRCP5A",43,0)
PRNTAUDT(GMRCIFN,ZTIO,GMRCAUDT) ; Update the last activity field in 123 and
"RTN","GMRCP5A",44,0)
 ; Processing Activity multiple
"RTN","GMRCP5A",45,0)
 ; Update the activity log to reflect "Printed To:" and the printer
"RTN","GMRCP5A",46,0)
 ; GMRCAUDT=1 indicates the consult is NW or Discontinued
"RTN","GMRCP5A",47,0)
 ; and it should update the audit trail.
"RTN","GMRCP5A",48,0)
 I $G(GMRCAUDT)'=1 K GMRCAUDT  Q
"RTN","GMRCP5A",49,0)
 N GMRCOM,GMRCORNP,GMRCFF,GMRCPA,GMRCAD,GMRCA,DA,DIE
"RTN","GMRCP5A",50,0)
 S GMRCA=22
"RTN","GMRCP5A",51,0)
 S GMRCO=GMRCIFN,GMRCDEV=ZTIO
"RTN","GMRCP5A",52,0)
 S DIE="^GMR(123,",DA=+GMRCO,DR="9////^S X=GMRCA"
"RTN","GMRCP5A",53,0)
 L +^GMR(123,GMRCO):5
"RTN","GMRCP5A",54,0)
 D ^DIE
"RTN","GMRCP5A",55,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCP5A",56,0)
 ;Update activity other than HL7 original msg received
"RTN","GMRCP5A",57,0)
 D AUDIT^GMRCP
"RTN","GMRCP5A",58,0)
 KILL GMRCO,GMRCA,GMRCDEV
"RTN","GMRCP5A",59,0)
 Q
"RTN","GMRCP5A",60,0)
 ;
"RTN","GMRCP5A",61,0)
FORMAT(PAGEWID) ;
"RTN","GMRCP5A",62,0)
 ;
"RTN","GMRCP5A",63,0)
 N %I,CMT,COUNT,D0,DFN,DIC,DIQ2,DR,GLOBAL,GMRC400,GMRCADD,GMRCADDT,GMRCAGE,GMRCCSDT
"RTN","GMRCP5A",64,0)
 N GMRCCTIT,GMRCDFN,GMRCDOB,GMRCDVL,GMRCELIG,GMRCEQL,GMRCERR,GMRCFAC,GMRCFP
"RTN","GMRCP5A",65,0)
 N GMRCFTR,GMRCIPH,GMRCINO,GMRCIRL,GMRCLAST,GMRCMODE,GMRCND,GMRCNDX,GMRCNT,GMRCPG,GMRCPGR,GMRCPNM,GMRCPRNM
"RTN","GMRCP5A",66,0)
 N GMRCPTR,GMRCQSTR,GMRCQSTT,GMRCR0,GMRCR1,GMRCR2,GMRCRB,GMRCRD,GMRCRPT,GMRCSG,GMRCSGAD,GMRCSIGM
"RTN","GMRCP5A",67,0)
 N GMRCSN,GMRCSR,GMRCSVC,GMRCTO,GMRCUL,GMRCWARD,GMRCWLI,GMRCX,LN,MCFILE,MCPROC
"RTN","GMRCP5A",68,0)
 N ND,ND1,ND2,NDS,ORACTION,SEX,TAB,X,Y
"RTN","GMRCP5A",69,0)
 ;
"RTN","GMRCP5A",70,0)
 S GMRCFTR=13,GMRCFP=0,GMRCPG=0
"RTN","GMRCP5A",71,0)
 S GMRCRD=$G(^GMR(123,GMRCIFN,0)),(DFN,GMRCDFN)=$P(GMRCRD,U,2)
"RTN","GMRCP5A",72,0)
 Q:'(DFN)
"RTN","GMRCP5A",73,0)
 D ELIG^VADPT S GMRCELIG=$P(VAEL(6),U,2) K VAEL
"RTN","GMRCP5A",74,0)
 S GMRCDVL="",$P(GMRCDVL,"-",PAGEWID+1)=""
"RTN","GMRCP5A",75,0)
 S GMRCEQL="",$P(GMRCEQL,"=",PAGEWID+1)=""
"RTN","GMRCP5A",76,0)
 S GMRCUL="",$P(GMRCUL,"_",40)=""
"RTN","GMRCP5A",77,0)
 S DFN=GMRCDFN D DEM^GMRCU
"RTN","GMRCP5A",78,0)
 ;
"RTN","GMRCP5A",79,0)
 S GMRCFAC=+$P(GMRCRD,U,21)
"RTN","GMRCP5A",80,0)
 I 'GMRCFAC S GMRCFAC=+$G(DUZ(2))
"RTN","GMRCP5A",81,0)
 I 'GMRCFAC S GMRCFAC=+$$SITE^VASITE()
"RTN","GMRCP5A",82,0)
 I +GMRCFAC S GMRCFAC=$$GET1^DIQ(4,+GMRCFAC,.01)
"RTN","GMRCP5A",83,0)
 E  S GMRCFAC="" Q
"RTN","GMRCP5A",84,0)
 ;
"RTN","GMRCP5A",85,0)
 ; get inter-facility consult info
"RTN","GMRCP5A",86,0)
 I $P(GMRCRD,U,23) D
"RTN","GMRCP5A",87,0)
 .S GMRCINO=$P(GMRCRD,U,22)
"RTN","GMRCP5A",88,0)
 .S GMRCRD(12)=$G(^GMR(123,GMRCIFN,12))
"RTN","GMRCP5A",89,0)
 .S GMRCRD(13)=$G(^GMR(123,GMRCIFN,13))
"RTN","GMRCP5A",90,0)
 .S GMRCIRL=$S($P(GMRCRD(12),U,5)="P":"Requesting facility",$P(GMRCRD(12),U,5)="F":"Consulting facility",1:"")
"RTN","GMRCP5A",91,0)
 ;
"RTN","GMRCP5A",92,0)
 I $P(GMRCRD,U,12)=2!(TIUFLG) D
"RTN","GMRCP5A",93,0)
 . D PRINT^GMRCTIUP(GMRCIFN,0,0)
"RTN","GMRCP5A",94,0)
 ;
"RTN","GMRCP5A",95,0)
 K GMRCSG I $D(^TMP("GMRCR",$J,"RES")) D
"RTN","GMRCP5A",96,0)
 .;
"RTN","GMRCP5A",97,0)
 .S GMRCR0=0 F  Q:$D(GMRCSG)  S GMRCR0=$O(^TMP("GMRCR",$J,"RES",GMRCR0)) Q:'GMRCR0  D
"RTN","GMRCP5A",98,0)
 ..F GMRCV="GMRCSDT","GMRCSIG","GMRCSIGM","GMRCSIGT" S @GMRCV=$G(^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT",GMRCV))
"RTN","GMRCP5A",99,0)
 ..Q:'$L($G(GMRCSIG))
"RTN","GMRCP5A",100,0)
 ..F GMRCV="GMRCSDT","GMRCSIG","GMRCSIGM","GMRCSIGT" S GMRCSG(GMRCV)=@GMRCV
"RTN","GMRCP5A",101,0)
 ;
"RTN","GMRCP5A",102,0)
 D INIT^GMRCP5B(.GMRCSG) ; Build Header, Footer, Request, and Primary Diagnosis Segments
"RTN","GMRCP5A",103,0)
 ;
"RTN","GMRCP5A",104,0)
 I $L($G(GMRCCPY)) D
"RTN","GMRCP5A",105,0)
 .D BLD("RES",1,1,0,$$CENTER($S(GMRCCPY="C":"C H A R T   C O P Y",1:"W O R K I N G   C O P Y")))
"RTN","GMRCP5A",106,0)
 I ($P(GMRCRD,U,19)="Y") D
"RTN","GMRCP5A",107,0)
 .D BLD("RES",1,1,0,$$CENTER("******* Significant Findings *******"))
"RTN","GMRCP5A",108,0)
 I ($P(GMRCRD,U,19)="N") D
"RTN","GMRCP5A",109,0)
 .D BLD("RES",1,1,0,$$CENTER("******* No Significant Findings *******"))
"RTN","GMRCP5A",110,0)
 I ($P(GMRCRD,U,19)="U") D
"RTN","GMRCP5A",111,0)
 .D BLD("RES",1,1,0,$$CENTER("******* Unknown Significant Findings *******"))
"RTN","GMRCP5A",112,0)
 ;
"RTN","GMRCP5A",113,0)
 I $P(GMRCRD,U,12)=1  D 
"RTN","GMRCP5A",114,0)
 . D BLD("RES",1,2,0,$$CENTER("**** REQUEST CANCELLED    REQUEST CANCELLED ****"))
"RTN","GMRCP5A",115,0)
 I '$D(^TMP("GMRCR",$J,"RES")),'$D(^("MCAR")) D
"RTN","GMRCP5A",116,0)
 .I $L($G(GMRCRPT)) D BLD("RES",1,2,0,$$CENTER(" No Consultation Results for "_GMRCRPT_" available."))
"RTN","GMRCP5A",117,0)
 .I '$L($G(GMRCRPT)) D BLD("RES",1,2,0,$$CENTER(" No Consultation Results available."))
"RTN","GMRCP5A",118,0)
 ;
"RTN","GMRCP5A",119,0)
 I $D(^TMP("GMRCR",$J,"RES")) D
"RTN","GMRCP5A",120,0)
 .;
"RTN","GMRCP5A",121,0)
 .S (GMRCNT,GMRCR0)=0 F  S GMRCR0=$O(^TMP("GMRCR",$J,"RES",GMRCR0)) Q:'GMRCR0  D
"RTN","GMRCP5A",122,0)
 ..N GMRCCSDT,GMRCCSGM,GMRCCSIG,GMRCCTIT,GMRCRPT,GMRCSDT
"RTN","GMRCP5A",123,0)
 ..N GMRCSIG,GMRCSIGM,GMRCSIGT,GMRCV,GMRCENT,GMRCVIS,GMRCVLOC,GMRCNODT
"RTN","GMRCP5A",124,0)
 ..;
"RTN","GMRCP5A",125,0)
 ..F GMRCV="GMRCCSDT","GMRCCSGM","GMRCCSIG","GMRCCTIT","GMRCRPT","GMRCSDT","GMRCSIG","GMRCSIGM","GMRCSIGT","GMRCVIS","GMRCENT","GMRCVLOC","GMRCNODT" D
"RTN","GMRCP5A",126,0)
 ...S @GMRCV=$G(^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT",GMRCV))
"RTN","GMRCP5A",127,0)
 ..;
"RTN","GMRCP5A",128,0)
 ..S GMRCNDX=$O(^TMP("GMRC",$J,"OUTPUT","RES"," "),-1)+1
"RTN","GMRCP5A",129,0)
 ..I $L($G(GMRCRPT)) D SUB("H","RES",GMRCNDX,"Consultation Results "_$S(GMRCR0=.5:"",1:"#"_GMRCR0_" ")_"for "_GMRCRPT_" continued.")
"RTN","GMRCP5A",130,0)
 ..I '$L($G(GMRCRPT)) D SUB("H","RES",GMRCNDX,"Consultation Results "_$S(GMRCR0=.5:"",1:"#"_GMRCR0_" ")_"continued.")
"RTN","GMRCP5A",131,0)
 ..D SUB("H","RES",GMRCNDX," ")
"RTN","GMRCP5A",132,0)
 ..I $L($G(GMRCSIG)) D
"RTN","GMRCP5A",133,0)
 ...D SUB("F","RES",GMRCNDX," ")
"RTN","GMRCP5A",134,0)
 ...I (GMRCSIGM="electronic") S GMRCX=" Results Signature: "_GMRCSIG_" /es/ "_$$EXDT($G(GMRCSDT))
"RTN","GMRCP5A",135,0)
 ...I '(GMRCSIGM="electronic") S GMRCX=" Results Signature: "_GMRCSIG_" /chart/ " S:$L($G(GMRCSDT)) GMRCX=GMRCX_$$EXDT(GMRCSDT)
"RTN","GMRCP5A",136,0)
 ...D SUB("F","RES",GMRCNDX,GMRCX)
"RTN","GMRCP5A",137,0)
 ...D:$L($G(GMRCSIGT)) SUB("F","RES",GMRCNDX,"                    "_GMRCSIGT)
"RTN","GMRCP5A",138,0)
 ..I $L($G(GMRCCSIG)) D
"RTN","GMRCP5A",139,0)
 ...D SUB("F","RES",GMRCNDX," ")
"RTN","GMRCP5A",140,0)
 ...I (GMRCCSGM="electronic") S GMRCX=" Results CoSignature: "_GMRCCSIG_" /es/ "_$$EXDT($G(GMRCCSDT))
"RTN","GMRCP5A",141,0)
 ...I '(GMRCCSGM="electronic") S GMRCX=" Results CoSignature: "_GMRCCSIG_" /chart/ " S:$L($G(GMRCCSDT)) GMRCX=GMRCX_$$EXDT(GMRCCSDT)
"RTN","GMRCP5A",142,0)
 ...D SUB("F","RES",GMRCNDX,GMRCX)
"RTN","GMRCP5A",143,0)
 ...D:$L($G(GMRCCTIT)) SUB("F","RES",GMRCNDX,"                      "_GMRCCTIT)
"RTN","GMRCP5A",144,0)
 ..;extra signers
"RTN","GMRCP5A",145,0)
 .. I $D(^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT","GMRCXTRA")) D
"RTN","GMRCP5A",146,0)
 ... D SUB("F","RES",GMRCNDX," ")
"RTN","GMRCP5A",147,0)
 ... D SUB("F","RES",GMRCNDX," Receipt acknowledged by: ")
"RTN","GMRCP5A",148,0)
 ... N XTRA S XTRA=0 F  S XTRA=$O(^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT","GMRCXTRA",XTRA)) Q:'XTRA  D
"RTN","GMRCP5A",149,0)
 .... D SUB("F","RES",GMRCNDX,^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT","GMRCXTRA",XTRA,0))
"RTN","GMRCP5A",150,0)
 .... D SUB("F","RES",GMRCNDX,^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT","GMRCXTRA",XTRA,1))
"RTN","GMRCP5A",151,0)
 ..;
"RTN","GMRCP5A",152,0)
 ..D BLD("RES",GMRCNDX,1,0," ")
"RTN","GMRCP5A",153,0)
 ..I $L($G(GMRCRPT)) D BLD("RES",GMRCNDX,1,0,$$CENTER("CONSULTATION NOTE "_$S(GMRCR0=.5:"",1:"#"_GMRCR0_" ")_"FOR "_GMRCRPT))
"RTN","GMRCP5A",154,0)
 ..I '$L($G(GMRCRPT)) D BLD("RES",GMRCNDX,1,0,$$CENTER("CONSULTATION NOTE "_$S(GMRCR0=.5:"",1:"#"_GMRCR0)))
"RTN","GMRCP5A",155,0)
 ..D BLD("RES",GMRCNDX,1,0," ")
"RTN","GMRCP5A",156,0)
 ..I $L($G(GMRCENT)) D
"RTN","GMRCP5A",157,0)
 ...S GMRCX="         Entry Date: "_$$EXDT($G(GMRCENT))
"RTN","GMRCP5A",158,0)
 ...D BLD("RES",GMRCNDX,1,0,GMRCX)
"RTN","GMRCP5A",159,0)
 ..I $L($G(GMRCNODT)) D
"RTN","GMRCP5A",160,0)
 ...Q:$$EXDT($G(GMRCNODT))=$$EXDT($G(GMRCENT)) 
"RTN","GMRCP5A",161,0)
 ...S GMRCX="Date/Time of result: "_$$EXDT($G(GMRCNODT))
"RTN","GMRCP5A",162,0)
 ...D BLD("RES",GMRCNDX,1,0,GMRCX)
"RTN","GMRCP5A",163,0)
 ..I $L($G(GMRCVIS)) D
"RTN","GMRCP5A",164,0)
 ...S GMRCX="              Visit: "_$$EXDT($G(GMRCVIS))
"RTN","GMRCP5A",165,0)
 ...I $L($G(GMRCVLOC)) S GMRCX=GMRCX_"   "_GMRCVLOC
"RTN","GMRCP5A",166,0)
 ...D BLD("RES",GMRCNDX,1,0,GMRCX)
"RTN","GMRCP5A",167,0)
 ..I $L($G(GMRCVLOC)) S GMRCX=GMRCVLOC
"RTN","GMRCP5A",168,0)
 ..D BLD("RES",GMRCNDX,1,0," ")
"RTN","GMRCP5A",169,0)
 ..I $D(^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT",0,0)) D  I 1
"RTN","GMRCP5A",170,0)
 ...D BLD("RES",GMRCNDX,1,0,^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT",0,0))
"RTN","GMRCP5A",171,0)
 ..E  I '$O(^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT","")) D
"RTN","GMRCP5A",172,0)
 ...D BLD("RES",1,1,0,$$CENTER("CONSULTATION NOTE TEXT NOT AVAILABLE"))
"RTN","GMRCP5A",173,0)
 ..S GMRCR1=0 F  S GMRCR1=$O(^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT",GMRCR1)) Q:'GMRCR1  D
"RTN","GMRCP5A",174,0)
 ...D BLD("RES",GMRCNDX,1,0,^TMP("GMRCR",$J,"RES",GMRCR0,"TEXT",GMRCR1,0))
"RTN","GMRCP5A",175,0)
 ..;
"RTN","GMRCP5A",176,0)
 ..;  GET ADDENDUMS TO THIS NOTE
"RTN","GMRCP5A",177,0)
 ..;
"RTN","GMRCP5A",178,0)
 ..I +$O(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",0)) D ADDEND^GMRCP5D(GMRCIFN,GMRCR0,GMRCNDX,GMRCRD,PAGEWID)
"RTN","GMRCP5A",179,0)
 ;
"RTN","GMRCP5A",180,0)
 D FORMAT^GMRCP5D(GMRCIFN,GMRCRD,PAGEWID) ;  GET SERVICE REPORTS AND COMMENTS
"RTN","GMRCP5A",181,0)
 ;
"RTN","GMRCP5A",182,0)
 Q
"RTN","GMRCP5A",183,0)
 ;
"RTN","GMRCP5A",184,0)
EXDT(X) ;EXTERNAL DATE FORMAT
"RTN","GMRCP5A",185,0)
 ;
"RTN","GMRCP5A",186,0)
 N DATE,TIME,HR,MN,PD,Y,%DT
"RTN","GMRCP5A",187,0)
 Q:'$L(X) ""
"RTN","GMRCP5A",188,0)
 I '(X?7N.1".".6N) S %DT="PTS" D ^%DT S X=Y
"RTN","GMRCP5A",189,0)
 Q $$FMTE^XLFDT(X,"5PMZ")
"RTN","GMRCP5A",190,0)
 ;
"RTN","GMRCP5A",191,0)
CENTER(X) ;
"RTN","GMRCP5A",192,0)
 ;
"RTN","GMRCP5A",193,0)
 N TEXT,COL
"RTN","GMRCP5A",194,0)
 S COL=35-($L(X)\2) Q:(COL<1) X
"RTN","GMRCP5A",195,0)
 S $E(TEXT,COL)=X
"RTN","GMRCP5A",196,0)
 Q TEXT
"RTN","GMRCP5A",197,0)
 ;
"RTN","GMRCP5A",198,0)
BLD(SUB,NDX,LINE,TAB,TEXT,RUNTIME) ;
"RTN","GMRCP5A",199,0)
 ;
"RTN","GMRCP5A",200,0)
 Q:'$L($G(SUB))
"RTN","GMRCP5A",201,0)
 N LINECNT
"RTN","GMRCP5A",202,0)
 ;
"RTN","GMRCP5A",203,0)
 F LINECNT=1:1:+LINE S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX)+1,0)=""
"RTN","GMRCP5A",204,0)
 ;
"RTN","GMRCP5A",205,0)
 S $E(^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX),0),TAB+1)=TEXT
"RTN","GMRCP5A",206,0)
 I $L($G(RUNTIME)) S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX),1)=RUNTIME
"RTN","GMRCP5A",207,0)
 ;
"RTN","GMRCP5A",208,0)
 S GMRCLAST=SUB
"RTN","GMRCP5A",209,0)
 Q
"RTN","GMRCP5A",210,0)
 ;
"RTN","GMRCP5A",211,0)
SUB(ZONE,SUB,NDX,TEXT) ;
"RTN","GMRCP5A",212,0)
 ;
"RTN","GMRCP5A",213,0)
 N NEXT
"RTN","GMRCP5A",214,0)
 S NEXT=$O(^TMP("GMRC",$J,"OUTPUT",SUB,NDX,ZONE," "),-1)+1
"RTN","GMRCP5A",215,0)
 S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,ZONE,NEXT,0)=TEXT
"RTN","GMRCP5A",216,0)
 Q
"RTN","GMRCP5A",217,0)
 ;
"RTN","GMRCP5A",218,0)
LASTLN(SUB,NDX) ;
"RTN","GMRCP5A",219,0)
 Q +$O(^TMP("GMRC",$J,"OUTPUT",SUB,NDX," "),-1)
"RTN","GMRCP5A",220,0)
 ;
"RTN","GMRCP5B")
0^41^B38799733
"RTN","GMRCP5B",1,0)
GMRCP5B ;SLC/DCM,RJS - Print Consult form 513 (Gather Data - Footers, Provisional Diagnosis and Reason For Request) ;10/5/01 09:20
"RTN","GMRCP5B",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,13,12,15,24,23,22**;Dec 27, 1997
"RTN","GMRCP5B",3,0)
 ;
"RTN","GMRCP5B",4,0)
 ; Patch #23 add "SERVICE RENDERED AS:" to SF513
"RTN","GMRCP5B",5,0)
 ; This routine invokes IA #1252,#10112
"RTN","GMRCP5B",6,0)
 ; DBIA 10035      ;PATIENT FILE
"RTN","GMRCP5B",7,0)
 ; DBIA 2849       ;PROTOCOL
"RTN","GMRCP5B",8,0)
 ; DBIA 10060      ;NEW PERSON
"RTN","GMRCP5B",9,0)
 Q
"RTN","GMRCP5B",10,0)
 ;
"RTN","GMRCP5B",11,0)
INIT(GMRCSG) ; Initialize the form
"RTN","GMRCP5B",12,0)
 ;
"RTN","GMRCP5B",13,0)
 D HDR^GMRCP5D,FTR(.GMRCSG),REQUEST,PDIAG Q
"RTN","GMRCP5B",14,0)
 ;
"RTN","GMRCP5B",15,0)
REQUEST ;
"RTN","GMRCP5B",16,0)
 N GMRCX
"RTN","GMRCP5B",17,0)
 ;
"RTN","GMRCP5B",18,0)
 I $L($T(OUTPTPR^SDUTL3)) D
"RTN","GMRCP5B",19,0)
 .S GMRCX=$P($$OUTPTPR^SDUTL3(DFN),U,2)
"RTN","GMRCP5B",20,0)
 .D:$L(GMRCX) BLD("REQ",1,1,0,"Current Primary Care Provider: "_GMRCX)
"RTN","GMRCP5B",21,0)
 I $L($T(OUTPTTM^SDUTL3)) D
"RTN","GMRCP5B",22,0)
 .S GMRCX=$P($$OUTPTTM^SDUTL3(DFN),U,2)
"RTN","GMRCP5B",23,0)
 .D:$L(GMRCX) BLD("REQ",1,1,0,"    Current Primary Care Team: "_GMRCX)
"RTN","GMRCP5B",24,0)
 ;
"RTN","GMRCP5B",25,0)
 I $O(^TMP("GMRC",$J,"OUTPUT","REQ",0)) D BLD("REQ",1,1,0,"")
"RTN","GMRCP5B",26,0)
 ;
"RTN","GMRCP5B",27,0)
 D SUB("H","REQ",1,"Reason For Request continued.")
"RTN","GMRCP5B",28,0)
 D SUB("H","REQ",1," ")
"RTN","GMRCP5B",29,0)
 ;
"RTN","GMRCP5B",30,0)
 D BLD("REQ",1,1,0,"REASON FOR REQUEST: (Complaints and findings)")
"RTN","GMRCP5B",31,0)
 I '$O(^GMR(123,GMRCIFN,20,0)) D BLD("REQ",1,1,0,"") I 1
"RTN","GMRCP5B",32,0)
 E  D
"RTN","GMRCP5B",33,0)
 .N LN S LN=0 F  S LN=$O(^GMR(123,GMRCIFN,20,LN)) Q:LN=""  D
"RTN","GMRCP5B",34,0)
 ..D BLD("REQ",1,1,0,^GMR(123,GMRCIFN,20,LN,0))
"RTN","GMRCP5B",35,0)
 ;
"RTN","GMRCP5B",36,0)
 Q
"RTN","GMRCP5B",37,0)
PDIAG ;
"RTN","GMRCP5B",38,0)
 ;
"RTN","GMRCP5B",39,0)
 D BLD("PDIAG",1,1,0,"PROVISIONAL DIAG: "_$G(^GMR(123,GMRCIFN,30)))
"RTN","GMRCP5B",40,0)
 D BLD("PDIAG",1,1,0,GMRCDVL)
"RTN","GMRCP5B",41,0)
 ;
"RTN","GMRCP5B",42,0)
 S (GMRCQSTR,GMRCPGR,GMRCIPH,GMRCQSTT)=""
"RTN","GMRCP5B",43,0)
 ;
"RTN","GMRCP5B",44,0)
 I $S('$P(GMRCRD,U,23):1,$P(GMRCRD(12),U,5)="P":1,1:0) D
"RTN","GMRCP5B",45,0)
 .S GMRCQSTR=$P(GMRCRD,U,14)
"RTN","GMRCP5B",46,0)
 .S:'GMRCQSTR GMRCQSTR=$$GET1^DIQ(100,+$P(GMRCRD,U,3),1)
"RTN","GMRCP5B",47,0)
 .S GMRCX=$G(^VA(200,+GMRCQSTR,.13))
"RTN","GMRCP5B",48,0)
 .S GMRCPGR=$P(GMRCX,U,7) S:'$L(GMRCPGR) GMRCPGR=$P(GMRCX,U,8)
"RTN","GMRCP5B",49,0)
 .S GMRCIPH=$P(GMRCX,U,2)
"RTN","GMRCP5B",50,0)
 .;
"RTN","GMRCP5B",51,0)
 .S GMRCQSTT=$P($G(^VA(200,+GMRCQSTR,20)),U,3)
"RTN","GMRCP5B",52,0)
 .S:'$L(GMRCQSTT) GMRCQSTT=$$GET1^DIQ(200,+GMRCQSTR,8)
"RTN","GMRCP5B",53,0)
 .S GMRCQSTR=$P($G(^VA(200,+GMRCQSTR,0)),U,1)
"RTN","GMRCP5B",54,0)
 ;
"RTN","GMRCP5B",55,0)
 I $P(GMRCRD,U,23),$P(GMRCRD(12),U,5)="F" D
"RTN","GMRCP5B",56,0)
 .S GMRCQSTR=$P(GMRCRD(12),U,6)
"RTN","GMRCP5B",57,0)
 .S GMRCIPH=$P(GMRCRD(13),U,2)
"RTN","GMRCP5B",58,0)
 .S GMRCPGR=$P(GMRCRD(13),U,3)
"RTN","GMRCP5B",59,0)
 ;
"RTN","GMRCP5B",60,0)
 S GMRCIPH="(Phone: "_GMRCIPH_")"
"RTN","GMRCP5B",61,0)
 S GMRCPGR="(Pager: "_GMRCPGR_")"
"RTN","GMRCP5B",62,0)
 ;
"RTN","GMRCP5B",63,0)
 D BLD("PDIAG",1,1,0,"REQUESTED BY: ")
"RTN","GMRCP5B",64,0)
 D BLD("PDIAG",1,0,35,"|PLACE:")
"RTN","GMRCP5B",65,0)
 D BLD("PDIAG",1,0,59,"|URGENCY:")
"RTN","GMRCP5B",66,0)
 ;
"RTN","GMRCP5B",67,0)
 D BLD("PDIAG",1,1,0,$E(GMRCQSTR,1,37))
"RTN","GMRCP5B",68,0)
 D BLD("PDIAG",1,0,35,"|"_$E($P($G(^ORD(101,+$P(GMRCRD,U,10),0)),U,2),1,20))
"RTN","GMRCP5B",69,0)
 D BLD("PDIAG",1,0,59,"|"_$E($P($G(^ORD(101,+$P(GMRCRD,U,9),0)),U,2),1,18))
"RTN","GMRCP5B",70,0)
 ;
"RTN","GMRCP5B",71,0)
 I $L(GMRCQSTT) D
"RTN","GMRCP5B",72,0)
 .D BLD("PDIAG",1,1,0,GMRCQSTT)
"RTN","GMRCP5B",73,0)
 .D BLD("PDIAG",1,0,35,"|")
"RTN","GMRCP5B",74,0)
 .D BLD("PDIAG",1,0,59,"|")
"RTN","GMRCP5B",75,0)
 D BLD("PDIAG",1,1,0,GMRCPGR)
"RTN","GMRCP5B",76,0)
 D BLD("PDIAG",1,0,35,"|SERVICE RENDERED AS:")
"RTN","GMRCP5B",77,0)
 D BLD("PDIAG",1,0,59,"|")
"RTN","GMRCP5B",78,0)
 S GMRCINOU=$S($P(GMRCRD,U,18)="O":"Outpatient",1:"Inpatient")
"RTN","GMRCP5B",79,0)
 I $D(GMRCIPH)>0 D
"RTN","GMRCP5B",80,0)
 .D BLD("PDIAG",1,1,0,GMRCIPH)
"RTN","GMRCP5B",81,0)
 .D BLD("PDIAG",1,0,35,"|"_GMRCINOU)
"RTN","GMRCP5B",82,0)
 E  D
"RTN","GMRCP5B",83,0)
 .D BLD("PDIAG",1,1,35,"|"_GMRCINOU)
"RTN","GMRCP5B",84,0)
 D BLD("PDIAG",1,0,59,"|")
"RTN","GMRCP5B",85,0)
 K GMRCINOU
"RTN","GMRCP5B",86,0)
 ;***************************************************************
"RTN","GMRCP5B",87,0)
 D BLD("PDIAG",1,1,0,GMRCDVL)
"RTN","GMRCP5B",88,0)
 ;
"RTN","GMRCP5B",89,0)
 Q
"RTN","GMRCP5B",90,0)
 ;
"RTN","GMRCP5B",91,0)
FTR(GMRCSG) ;Footer of form 513
"RTN","GMRCP5B",92,0)
 ;
"RTN","GMRCP5B",93,0)
 N GMRCRMBD,GMRCFAC1,GMRCLOC,GMRCX,SUB,GMRCX,VAIN,VAPA,VAERR
"RTN","GMRCP5B",94,0)
 ;
"RTN","GMRCP5B",95,0)
 D ADD^VADPT,INP^VADPT
"RTN","GMRCP5B",96,0)
 ;
"RTN","GMRCP5B",97,0)
 S (GMRCLOC,GMRCRMBD)=""
"RTN","GMRCP5B",98,0)
 S GMRCLOC=$P($G(VAIN(4)),U,2)
"RTN","GMRCP5B",99,0)
 S GMRCRMBD=$G(VAIN(5))
"RTN","GMRCP5B",100,0)
 S:'$L(GMRCLOC) GMRCLOC=$P($G(^SC(+$P($G(^GMR(123,+GMRCIFN,0)),U,4),0)),U,1)
"RTN","GMRCP5B",101,0)
 ;No location, IFC - consulting site
"RTN","GMRCP5B",102,0)
 I '$L(GMRCLOC),$P(GMRCRD,U,23),$P($G(GMRCRD(12)),U,5)="F" D
"RTN","GMRCP5B",103,0)
 .I $P(GMRCRD,U,21) S GMRCLOC=$$GET1^DIQ(4,$P(GMRCRD,U,21),.01)
"RTN","GMRCP5B",104,0)
 .E  S GMRCLOC=$$GET1^DIQ(4,$P(GMRCRD,U,23),.01)
"RTN","GMRCP5B",105,0)
 S:'$L(GMRCLOC) GMRCLOC=GMRCUL
"RTN","GMRCP5B",106,0)
 ;
"RTN","GMRCP5B",107,0)
 D BLD("FTR",0,1,0,GMRCEQL)
"RTN","GMRCP5B",108,0)
 D BLD("FTR",1,1,0,GMRCEQL)
"RTN","GMRCP5B",109,0)
 ;
"RTN","GMRCP5B",110,0)
 I ($G(GMRCSG("GMRCSIGM"))="electronic") D  I 1
"RTN","GMRCP5B",111,0)
 .D BLD("FTR",0,1,0,"SIGNATURE & TITLE: ")
"RTN","GMRCP5B",112,0)
 .D BLD("FTR",0,0,20,$G(GMRCSG("GMRCSIG"))_" /es/")
"RTN","GMRCP5B",113,0)
 .D BLD("FTR",0,0,54,"|")
"RTN","GMRCP5B",114,0)
 .D BLD("FTR",0,1,20,$G(GMRCSG("GMRCSIGT")))
"RTN","GMRCP5B",115,0)
 .D BLD("FTR",0,0,54,"|DATE: "_$$EXDT($G(GMRCSG("GMRCSDT"))))
"RTN","GMRCP5B",116,0)
 E  D
"RTN","GMRCP5B",117,0)
 .D BLD("FTR",0,1,0,"AUTHOR & TITLE: ")
"RTN","GMRCP5B",118,0)
 .D BLD("FTR",0,0,20,$G(GMRCSG("GMRCSIG")))
"RTN","GMRCP5B",119,0)
 .D BLD("FTR",0,0,54,"|")
"RTN","GMRCP5B",120,0)
 .D BLD("FTR",0,1,20,$G(GMRCSG("GMRCSIGT")))
"RTN","GMRCP5B",121,0)
 .D BLD("FTR",0,0,54,"|DATE: "_$$EXDT($G(GMRCSG("GMRCSDT"))))
"RTN","GMRCP5B",122,0)
 ;
"RTN","GMRCP5B",123,0)
 S GMRCFAC1=+$G(DUZ(2))
"RTN","GMRCP5B",124,0)
 S:'GMRCFAC1 GMRCFAC1=+$$SITE^VASITE()
"RTN","GMRCP5B",125,0)
 S GMRCFAC1=$$GET1^DIQ(4,+GMRCFAC1,.01)
"RTN","GMRCP5B",126,0)
 ;
"RTN","GMRCP5B",127,0)
 D BLD("FTR",0,1,0,GMRCDVL)
"RTN","GMRCP5B",128,0)
 D BLD("FTR",0,1,0,"ID #:"_$E(GMRCUL,1,8))
"RTN","GMRCP5B",129,0)
 D BLD("FTR",0,0,12,"|ORGANIZATION:"_$J($E(GMRCFAC1,1,17),17))
"RTN","GMRCP5B",130,0)
 D BLD("FTR",0,0,45,"|REG #:"_$E(GMRCUL,1,4))
"RTN","GMRCP5B",131,0)
 D BLD("FTR",0,0,58,"|LOC: "_$E($G(GMRCLOC),1,11))
"RTN","GMRCP5B",132,0)
 ;
"RTN","GMRCP5B",133,0)
 I $L(GMRCRMBD) D  I 1
"RTN","GMRCP5B",134,0)
 .D BLD("FTR",0,1,12,"|")
"RTN","GMRCP5B",135,0)
 .D BLD("FTR",0,0,45,"|")
"RTN","GMRCP5B",136,0)
 .D BLD("FTR",0,0,58,"|RM/BD: "_GMRCRMBD)
"RTN","GMRCP5B",137,0)
 ;
"RTN","GMRCP5B",138,0)
 D BLD("FTR",0,1,0,GMRCDVL)
"RTN","GMRCP5B",139,0)
 ;
"RTN","GMRCP5B",140,0)
 F SUB=0,1 D
"RTN","GMRCP5B",141,0)
 .D BLD("FTR",SUB,1,0,$P($G(^DPT(GMRCDFN,0)),U,1)_"  "_GMRCELIG)
"RTN","GMRCP5B",142,0)
 .I 'SUB D BLD("FTR",SUB,0,45,"CONSULTATION SHEET")
"RTN","GMRCP5B",143,0)
 .I SUB D BLD("FTR",SUB,0,45,"CONSULTATION SHEET  (Continued)")
"RTN","GMRCP5B",144,0)
 .D BLD("FTR",SUB,1,0,GMRCSN)
"RTN","GMRCP5B",145,0)
 .D BLD("FTR",SUB,0,20,$$EXDT(GMRCDOB))
"RTN","GMRCP5B",146,0)
 .D BLD("FTR",SUB,0,45,"Standard Form 513 (Rev 9-77)")
"RTN","GMRCP5B",147,0)
 ;
"RTN","GMRCP5B",148,0)
 ;                                  ADDRESS LINES 1-3
"RTN","GMRCP5B",149,0)
 F GMRCX=1,2,3 D:$L(VAPA(GMRCX)) BLD("FTR",0,1,0,VAPA(GMRCX))
"RTN","GMRCP5B",150,0)
 ;
"RTN","GMRCP5B",151,0)
 ;         CITY              STATE                ZIP CODE
"RTN","GMRCP5B",152,0)
 S GMRCX=VAPA(4)_"   "_$P(VAPA(5),U,2)_"      "_VAPA(6)
"RTN","GMRCP5B",153,0)
 ;
"RTN","GMRCP5B",154,0)
 I $L(VAPA(8)) S GMRCX=GMRCX_"      Phone: "_VAPA(8)   ; TELEPHONE (IF AVAILABLE)
"RTN","GMRCP5B",155,0)
 ;
"RTN","GMRCP5B",156,0)
 D BLD("FTR",0,1,0,GMRCX)
"RTN","GMRCP5B",157,0)
 ;
"RTN","GMRCP5B",158,0)
 Q
"RTN","GMRCP5B",159,0)
 ;
"RTN","GMRCP5B",160,0)
CONSRQ(GMRCRQ) ;
"RTN","GMRCP5B",161,0)
 ;
"RTN","GMRCP5B",162,0)
 N ORND,ORFL,REF
"RTN","GMRCP5B",163,0)
 I '$L(GMRCRQ) Q "Consult"
"RTN","GMRCP5B",164,0)
 S ORND=$P(GMRCRQ,";",1),ORFL=$P(GMRCRQ,";",2),REF=U_ORFL_ORND_",0)"
"RTN","GMRCP5B",165,0)
 S GMRCRQ=$P($G(@(REF)),U,2)
"RTN","GMRCP5B",166,0)
 Q:$L(GMRCRQ) GMRCRQ Q "Consult"
"RTN","GMRCP5B",167,0)
 ;
"RTN","GMRCP5B",168,0)
EXDT(X) ;EXTERNAL DATE FORMAT
"RTN","GMRCP5B",169,0)
 ;
"RTN","GMRCP5B",170,0)
 N DATE,TIME,HR,MN,PD,Y,%DT
"RTN","GMRCP5B",171,0)
 Q:'$L(X) ""
"RTN","GMRCP5B",172,0)
 I '(X?7N.1".".6N) S %DT="PTS" D ^%DT S X=Y
"RTN","GMRCP5B",173,0)
 Q $$FMTE^XLFDT(X,"5PMZ")
"RTN","GMRCP5B",174,0)
 ;
"RTN","GMRCP5B",175,0)
PRCMT(CMT) ;
"RTN","GMRCP5B",176,0)
 ;
"RTN","GMRCP5B",177,0)
 Q $P($G(^GMR(123.1,+CMT,0)),U,8)
"RTN","GMRCP5B",178,0)
 ;
"RTN","GMRCP5B",179,0)
 ;
"RTN","GMRCP5B",180,0)
BLD(SUB,NDX,LINE,TAB,TEXT,RUNTIME) ;
"RTN","GMRCP5B",181,0)
 ;
"RTN","GMRCP5B",182,0)
 Q:'$L($G(SUB))
"RTN","GMRCP5B",183,0)
 N LINECNT
"RTN","GMRCP5B",184,0)
 ;
"RTN","GMRCP5B",185,0)
 F LINECNT=1:1:+LINE S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX)+1,0)=""
"RTN","GMRCP5B",186,0)
 ;
"RTN","GMRCP5B",187,0)
 S $E(^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX),0),TAB+1)=TEXT
"RTN","GMRCP5B",188,0)
 I $L($G(RUNTIME)) S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX),1)=RUNTIME
"RTN","GMRCP5B",189,0)
 ;
"RTN","GMRCP5B",190,0)
 S GMRCLAST=SUB
"RTN","GMRCP5B",191,0)
 Q
"RTN","GMRCP5B",192,0)
 ;
"RTN","GMRCP5B",193,0)
SUB(ZONE,SUB,NDX,TEXT) ;
"RTN","GMRCP5B",194,0)
 ;
"RTN","GMRCP5B",195,0)
 N NEXT
"RTN","GMRCP5B",196,0)
 S NEXT=$O(^TMP("GMRC",$J,"OUTPUT",SUB,NDX,ZONE," "),-1)+1
"RTN","GMRCP5B",197,0)
 S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,ZONE,NEXT,0)=TEXT
"RTN","GMRCP5B",198,0)
 Q
"RTN","GMRCP5B",199,0)
 ;
"RTN","GMRCP5B",200,0)
LASTLN(SUB,NDX) ;
"RTN","GMRCP5B",201,0)
 Q +$O(^TMP("GMRC",$J,"OUTPUT",SUB,NDX," "),-1)
"RTN","GMRCP5B",202,0)
 ;
"RTN","GMRCP5D")
0^40^B45656870
"RTN","GMRCP5D",1,0)
GMRCP5D ;SLC/DCM,RJS,JFR - Print Consult form 513 (Gather Data - Addendums, Headers, Service reports and Comments) ;3/1/02 11:12
"RTN","GMRCP5D",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,15,22**;Dec 27, 1997
"RTN","GMRCP5D",3,0)
 ;
"RTN","GMRCP5D",4,0)
FORMAT(GMRCIFN,GMRCRD,PAGEWID) ;
"RTN","GMRCP5D",5,0)
 ;
"RTN","GMRCP5D",6,0)
 I $L($P(GMRCRD,U,15)) D
"RTN","GMRCP5D",7,0)
 .I $O(^TMP("GMRCR",$J,"MCAR",0)) D
"RTN","GMRCP5D",8,0)
 ..N GMRCSVC
"RTN","GMRCP5D",9,0)
 ..S GMRCSVC=$P($G(^GMR(123.5,+$P(GMRCRD,U,5),0)),U,1)
"RTN","GMRCP5D",10,0)
 ..S:$L(GMRCSVC) GMRCSVC=GMRCSVC_" "
"RTN","GMRCP5D",11,0)
 ..;
"RTN","GMRCP5D",12,0)
 ..; Medicine Results?
"RTN","GMRCP5D",13,0)
 ..S GMRCR0=0 F  S GMRCR0=$O(^TMP("GMRCR",$J,"MCAR",GMRCR0)) Q:'GMRCR0  D
"RTN","GMRCP5D",14,0)
 ...D SUB("H","SREP",GMRCR0,$$CENTER(GMRCSVC_"Service Report #"_GMRCR0_" continued."))
"RTN","GMRCP5D",15,0)
 ...D SUB("H","SREP",GMRCR0," ")
"RTN","GMRCP5D",16,0)
 ...D BLD("SREP",GMRCR0,1,0,$$CENTER("Medicine Package Report"))
"RTN","GMRCP5D",17,0)
 ...D BLD("SREP",GMRCR0,1,0,"")
"RTN","GMRCP5D",18,0)
 ...N LN
"RTN","GMRCP5D",19,0)
 ...S LN=0 F  S LN=$O(^TMP("GMRCR",$J,"MCAR",GMRCR0,LN)) Q:'LN  D
"RTN","GMRCP5D",20,0)
 ....D BLD("SREP",GMRCR0,1,0,$G(^TMP("GMRCR",$J,"MCAR",GMRCR0,LN,0)))
"RTN","GMRCP5D",21,0)
 ;
"RTN","GMRCP5D",22,0)
 ; Build Processing Activities
"RTN","GMRCP5D",23,0)
 S GMRCR0=0 F  S GMRCR0=$O(^GMR(123,GMRCIFN,40,GMRCR0)) Q:'GMRCR0  D
"RTN","GMRCP5D",24,0)
 .N GMRCR1,GMRC400,CMT,USER,GMRCDT,RPRV,GMRC402
"RTN","GMRCP5D",25,0)
 .S GMRCR1=+$O(^GMR(123,GMRCIFN,40,GMRCR0,0)) Q:GMRCR1'=1
"RTN","GMRCP5D",26,0)
 .S GMRC400=$G(^GMR(123,GMRCIFN,40,GMRCR0,0))
"RTN","GMRCP5D",27,0)
 .S GMRC402=$G(^GMR(123,GMRCIFN,40,GMRCR0,2))
"RTN","GMRCP5D",28,0)
 .S CMT=$$PRCMT^GMRCP5B(+$P(GMRC400,U,2)) Q:'$L(CMT)
"RTN","GMRCP5D",29,0)
 .S GMRCDT=$P(GMRC400,U,3) S:'GMRCDT GMRCDT=$P(GMRC400,U,1)
"RTN","GMRCP5D",30,0)
 .S GMRCDT=$$EXDT(GMRCDT)_" "_$P(GMRC402,U,3)
"RTN","GMRCP5D",31,0)
 .;
"RTN","GMRCP5D",32,0)
 .S RPRV=$$GET1^DIQ(200,+$P(GMRC400,U,4),.01)
"RTN","GMRCP5D",33,0)
 .I '$L(RPRV) S RPRV=$P(GMRC402,U,2) ;+JFR 3/1/02
"RTN","GMRCP5D",34,0)
 .S:($L(RPRV)) RPRV="Responsible Person: "_RPRV
"RTN","GMRCP5D",35,0)
 .S USER=$$GET1^DIQ(200,+$P(GMRC400,U,5),.01)
"RTN","GMRCP5D",36,0)
 .I '$L(USER) S USER=$P(GMRC402,U) ;+JFR 3/1/02
"RTN","GMRCP5D",37,0)
 .S USER="Entered by: "_USER_" - "_GMRCDT
"RTN","GMRCP5D",38,0)
 .D SUB("H","COM",GMRCR0,CMT_" Comment ("_USER_") continued.")
"RTN","GMRCP5D",39,0)
 .D SUB("H","COM",GMRCR0," ")
"RTN","GMRCP5D",40,0)
 .D BLD("COM",GMRCR0,1,0,"")
"RTN","GMRCP5D",41,0)
 .D BLD("COM",GMRCR0,1,0,$$CENTER("("_CMT_" Comment)"))
"RTN","GMRCP5D",42,0)
 .D BLD("COM",GMRCR0,1,5,USER)
"RTN","GMRCP5D",43,0)
 .D:($L(RPRV)) BLD("COM",GMRCR0,1,5,RPRV)
"RTN","GMRCP5D",44,0)
 .;
"RTN","GMRCP5D",45,0)
 .N GMRCR2 S GMRCR2=0
"RTN","GMRCP5D",46,0)
 .F  S GMRCR2=$O(^GMR(123,GMRCIFN,40,GMRCR0,GMRCR1,GMRCR2)) Q:'GMRCR2  D
"RTN","GMRCP5D",47,0)
 ..D BLD("COM",GMRCR0,1,0,$G(^GMR(123,GMRCIFN,40,GMRCR0,GMRCR1,GMRCR2,0)))
"RTN","GMRCP5D",48,0)
 ;
"RTN","GMRCP5D",49,0)
 Q
"RTN","GMRCP5D",50,0)
 ;
"RTN","GMRCP5D",51,0)
ADDEND(GMRCIFN,GMRCR0,GMRCNDX,GMRCRD,PAGEWID) ;
"RTN","GMRCP5D",52,0)
 ;
"RTN","GMRCP5D",53,0)
 N GMRCADD,GMRCNDX,GMRCR1,GMRCV,TEXT,GMRCX
"RTN","GMRCP5D",54,0)
 ;
"RTN","GMRCP5D",55,0)
 S GMRCADD=0 F  S GMRCADD=$O(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",GMRCADD)) Q:'GMRCADD  D
"RTN","GMRCP5D",56,0)
 .N GMRCSGNM,GMRCNMDT,GMRCTIT,GMRCMODE,GMRCCSDT,GMRCCTIT,GMRCCSGM
"RTN","GMRCP5D",57,0)
 .;
"RTN","GMRCP5D",58,0)
 .F GMRCV="GMRCSGNM","GMRCNMDT","GMRCTIT","GMRCMODE" D
"RTN","GMRCP5D",59,0)
 ..S @GMRCV=$G(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",GMRCADD,GMRCV))
"RTN","GMRCP5D",60,0)
 .;
"RTN","GMRCP5D",61,0)
 . F GMRCV="GMRCCSDT","GMRCCTIT","GMRCCSGM","GMRCCSIG" D
"RTN","GMRCP5D",62,0)
 .. S @GMRCV=$G(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",GMRCADD,GMRCV))
"RTN","GMRCP5D",63,0)
 .S GMRCNDX=$O(^TMP("GMRC",$J,"OUTPUT","RES"," "),-1)+1
"RTN","GMRCP5D",64,0)
 .I $L($G(GMRCRPT)) D SUB("H","RES",GMRCNDX,"Addendum #"_GMRCADD_" To Consult Note #"_GMRCR0_" for "_GMRCRPT_" continued.")
"RTN","GMRCP5D",65,0)
 .I '$L($G(GMRCRPT)) D SUB("H","RES",GMRCNDX,"Addendum #"_GMRCADD_" To Consult Note #"_GMRCR0_" continued.")
"RTN","GMRCP5D",66,0)
 .D SUB("H","RES",GMRCNDX," ")
"RTN","GMRCP5D",67,0)
 .I $L($G(GMRCSGNM)) D
"RTN","GMRCP5D",68,0)
 ..D SUB("F","RES",GMRCNDX," ")
"RTN","GMRCP5D",69,0)
 ..I (GMRCMODE="electronic") S GMRCX=" Addendum Signature: "_GMRCSGNM_" /es/ "_$$EXDT($G(GMRCNMDT))
"RTN","GMRCP5D",70,0)
 ..I '(GMRCMODE="electronic") S GMRCX=" Addendum Author: "_GMRCSGNM S:$L($G(GMRCNMDT)) GMRCX=GMRCX_" Last edited: "_$$EXDT(GMRCNMDT)
"RTN","GMRCP5D",71,0)
 ..D SUB("F","RES",GMRCNDX,GMRCX)
"RTN","GMRCP5D",72,0)
 ..D:$L($G(GMRCTIT)) SUB("F","RES",GMRCNDX,"                     "_GMRCTIT)
"RTN","GMRCP5D",73,0)
 .I $L($G(GMRCCSDT)) D
"RTN","GMRCP5D",74,0)
 ..D SUB("F","RES",GMRCNDX," ")
"RTN","GMRCP5D",75,0)
 ..I (GMRCCSGM="electronic") S GMRCX=" Addendum CoSignature: "_GMRCCSIG_" /es/ "_$$EXDT(GMRCCSDT)
"RTN","GMRCP5D",76,0)
 ..I '(GMRCCSGM="electronic") S GMRCX=" Addendum CoSignature: "_GMRCCSIG_" /chart/ "_$$EXDT(GMRCCSDT)
"RTN","GMRCP5D",77,0)
 ..D SUB("F","RES",GMRCNDX,GMRCX)
"RTN","GMRCP5D",78,0)
 ..D:$L($G(GMRCCTIT)) SUB("F","RES",GMRCNDX,"                       "_GMRCCTIT)
"RTN","GMRCP5D",79,0)
 .D BLD("RES",GMRCNDX,1,0," ")
"RTN","GMRCP5D",80,0)
 .I $L($G(GMRCRPT)) D BLD("RES",GMRCNDX,1,0,$$CENTER("ADDENDUM #"_GMRCADD_" TO CONSULT NOTE #"_GMRCR0_" FOR "_GMRCRPT))
"RTN","GMRCP5D",81,0)
 .I '$L($G(GMRCRPT)) D BLD("RES",GMRCNDX,1,0,$$CENTER("ADDENDUM #"_GMRCADD_" TO CONSULT NOTE #"_GMRCR0))
"RTN","GMRCP5D",82,0)
 .D BLD("RES",GMRCNDX,1,0," ")
"RTN","GMRCP5D",83,0)
 .S GMRCR1=0 F  S GMRCR1=$O(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",GMRCADD,GMRCR1)) Q:'GMRCR1  D
"RTN","GMRCP5D",84,0)
 ..D BLD("RES",GMRCNDX,1,0,$G(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",GMRCADD,GMRCR1,0)))
"RTN","GMRCP5D",85,0)
 Q
"RTN","GMRCP5D",86,0)
 ;
"RTN","GMRCP5D",87,0)
HDR ; Header code for form 513
"RTN","GMRCP5D",88,0)
 ;
"RTN","GMRCP5D",89,0)
 N PG,GMRCFROM
"RTN","GMRCP5D",90,0)
 ;
"RTN","GMRCP5D",91,0)
 F PG=0,1 D
"RTN","GMRCP5D",92,0)
 .D BLD("HDR",PG,1,0,GMRCDVL)
"RTN","GMRCP5D",93,0)
 .D BLD("HDR",PG,1,6,"MEDICAL RECORD")
"RTN","GMRCP5D",94,0)
 .D BLD("HDR",PG,0,29,"|")
"RTN","GMRCP5D",95,0)
 .D BLD("HDR",PG,0,36,"CONSULTATION SHEET")
"RTN","GMRCP5D",96,0)
 .I PG D BLD("HDR",PG,0,60,"Page ","GMRCPG,65") I 1
"RTN","GMRCP5D",97,0)
 .E  I '$G(GMRCGUI) D BLD("HDR",PG,0,60,"Page ","GMRCPG,65")
"RTN","GMRCP5D",98,0)
 .;
"RTN","GMRCP5D",99,0)
 .D BLD("HDR",PG,1,0,GMRCDVL)
"RTN","GMRCP5D",100,0)
 .D BLD("HDR",PG,1,0,"Consult Request: "_$$CONSRQ(GMRCIFN))
"RTN","GMRCP5D",101,0)
 .D BLD("HDR",PG,0,55,"|Consult No.: "_GMRCIFN)
"RTN","GMRCP5D",102,0)
 .;
"RTN","GMRCP5D",103,0)
 D BLD("HDR",1,1,0,GMRCEQL)
"RTN","GMRCP5D",104,0)
 D BLD("HDR",0,1,0,GMRCDVL)
"RTN","GMRCP5D",105,0)
 ;
"RTN","GMRCP5D",106,0)
 I $G(CMT) D BLD("HDR",0,1,27,"("_$$PRCMT^GMRCP5B(CMT)_")") Q
"RTN","GMRCP5D",107,0)
 ;
"RTN","GMRCP5D",108,0)
 S GMRCFROM=$P($G(^SC(+$P(GMRCRD,U,6),0)),U,1)
"RTN","GMRCP5D",109,0)
 ;
"RTN","GMRCP5D",110,0)
 I '$L(GMRCFROM) D
"RTN","GMRCP5D",111,0)
 .N VAIN
"RTN","GMRCP5D",112,0)
 .D INP^VADPT
"RTN","GMRCP5D",113,0)
 .S GMRCFROM=$P($G(VAIN(4)),U,2)
"RTN","GMRCP5D",114,0)
 .I $L($G(VAIN(5))) S GMRCFROM=GMRCFROM_" (Rm/Bd: "_$G(VAIN(5))_" )"
"RTN","GMRCP5D",115,0)
 ;No location, IFC - consulting site
"RTN","GMRCP5D",116,0)
 I '$L(GMRCFROM),$P(GMRCRD,U,23),$P($G(GMRCRD(12)),U,5)="F" D
"RTN","GMRCP5D",117,0)
 .I $P(GMRCRD,U,21) S GMRCFROM=$$GET1^DIQ(4,$P(GMRCRD,U,21),.01)
"RTN","GMRCP5D",118,0)
 .E  S GMRCFROM=$$GET1^DIQ(4,$P(GMRCRD,U,23),.01)
"RTN","GMRCP5D",119,0)
 ;
"RTN","GMRCP5D",120,0)
 D BLD("HDR",0,1,0,"To: "_$P($G(^GMR(123.5,+$P(GMRCRD,U,5),0)),U,1))
"RTN","GMRCP5D",121,0)
 D BLD("HDR",0,1,5,"From: "_GMRCFROM)
"RTN","GMRCP5D",122,0)
 D BLD("HDR",0,0,49,"|Requested: "_$$EXDT($P(GMRCRD,U,7)))
"RTN","GMRCP5D",123,0)
 ;
"RTN","GMRCP5D",124,0)
 D BLD("HDR",0,1,0,GMRCDVL)
"RTN","GMRCP5D",125,0)
 D BLD("HDR",0,1,0,"Requesting Facility: "_$E(GMRCFAC,1,22))
"RTN","GMRCP5D",126,0)
 I $P(GMRCRD,U,11) D BLD("HDR",0,0,45,"|ATTENTION: "_$E($P($G(^VA(200,+$P(GMRCRD,U,11),0)),U,1),1,21))
"RTN","GMRCP5D",127,0)
 I $P(GMRCRD,U,23) D
"RTN","GMRCP5D",128,0)
 . D BLD("HDR",0,1,0,"Remote Consult No.: "_GMRCINO)
"RTN","GMRCP5D",129,0)
 . D BLD("HDR",0,1,0,"Role: "_GMRCIRL)
"RTN","GMRCP5D",130,0)
 D BLD("HDR",0,1,0,GMRCEQL)
"RTN","GMRCP5D",131,0)
 ;
"RTN","GMRCP5D",132,0)
 Q
"RTN","GMRCP5D",133,0)
 ;
"RTN","GMRCP5D",134,0)
CENTER(X) ;
"RTN","GMRCP5D",135,0)
 ;
"RTN","GMRCP5D",136,0)
 N TEXT,COL
"RTN","GMRCP5D",137,0)
 S COL=35-($L(X)\2) Q:(COL<1) X
"RTN","GMRCP5D",138,0)
 S $E(TEXT,COL)=X
"RTN","GMRCP5D",139,0)
 Q TEXT
"RTN","GMRCP5D",140,0)
 ;
"RTN","GMRCP5D",141,0)
BLD(SUB,NDX,LINE,TAB,TEXT,RUNTIME) ;
"RTN","GMRCP5D",142,0)
 ;
"RTN","GMRCP5D",143,0)
 Q:'$L($G(SUB))
"RTN","GMRCP5D",144,0)
 N LINECNT
"RTN","GMRCP5D",145,0)
 ;
"RTN","GMRCP5D",146,0)
 F LINECNT=1:1:+LINE S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX)+1,0)=""
"RTN","GMRCP5D",147,0)
 ;
"RTN","GMRCP5D",148,0)
 S $E(^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX),0),TAB+1)=TEXT
"RTN","GMRCP5D",149,0)
 I $L($G(RUNTIME)) S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX),1)=RUNTIME
"RTN","GMRCP5D",150,0)
 ;
"RTN","GMRCP5D",151,0)
 S GMRCLAST=SUB
"RTN","GMRCP5D",152,0)
 Q
"RTN","GMRCP5D",153,0)
 ;
"RTN","GMRCP5D",154,0)
SUB(ZONE,SUB,NDX,TEXT) ;
"RTN","GMRCP5D",155,0)
 ;
"RTN","GMRCP5D",156,0)
 N NEXT
"RTN","GMRCP5D",157,0)
 S NEXT=$O(^TMP("GMRC",$J,"OUTPUT",SUB,NDX,ZONE," "),-1)+1
"RTN","GMRCP5D",158,0)
 S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,ZONE,NEXT,0)=TEXT
"RTN","GMRCP5D",159,0)
 Q
"RTN","GMRCP5D",160,0)
 ;
"RTN","GMRCP5D",161,0)
LASTLN(SUB,NDX) ;
"RTN","GMRCP5D",162,0)
 Q +$O(^TMP("GMRC",$J,"OUTPUT",SUB,NDX," "),-1)
"RTN","GMRCP5D",163,0)
 ;
"RTN","GMRCP5D",164,0)
CONSRQ(IFN) ;
"RTN","GMRCP5D",165,0)
 ;
"RTN","GMRCP5D",166,0)
 N PTR,LINK,REF,GMRCRQ
"RTN","GMRCP5D",167,0)
 I +$P(^GMR(123,+IFN,0),U,8) D
"RTN","GMRCP5D",168,0)
 . S GMRCRQ=$P(^GMR(123,+IFN,0),U,8)
"RTN","GMRCP5D",169,0)
 . S GMRCRQ=$$GET1^DIQ(123.3,+GMRCRQ,.01)
"RTN","GMRCP5D",170,0)
 . I '$L(GMRCRQ) S GMRCRQ="Procedure"
"RTN","GMRCP5D",171,0)
 I $L($G(GMRCRQ)) Q GMRCRQ
"RTN","GMRCP5D",172,0)
 I $L($G(^GMR(123,IFN,1.11))) D
"RTN","GMRCP5D",173,0)
 . N SERV,TYPE
"RTN","GMRCP5D",174,0)
 . S SERV=$$UP^XLFSTR($$GET1^DIQ(123.5,$P(^GMR(123,IFN,0),U,5),.01))
"RTN","GMRCP5D",175,0)
 . S TYPE=$$UP^XLFSTR(^GMR(123,IFN,1.11)) I TYPE'=SERV D
"RTN","GMRCP5D",176,0)
 . I TYPE'=SERV S GMRCRQ=$E(^GMR(123,IFN,1.11),1,36)
"RTN","GMRCP5D",177,0)
 Q:$L($G(GMRCRQ)) GMRCRQ Q "Consult"
"RTN","GMRCP5D",178,0)
 ;
"RTN","GMRCP5D",179,0)
EXDT(X) ;EXTERNAL DATE FORMAT
"RTN","GMRCP5D",180,0)
 ;
"RTN","GMRCP5D",181,0)
 N DATE,TIME,HR,MN,PD,Y,%DT
"RTN","GMRCP5D",182,0)
 Q:'$L(X) ""
"RTN","GMRCP5D",183,0)
 I '(X?7N.1".".6N) S %DT="PTS" D ^%DT S X=Y
"RTN","GMRCP5D",184,0)
 Q $$FMTE^XLFDT(X,"5PMZ")
"RTN","GMRCP5D",185,0)
 ;
"RTN","GMRCPC")
0^17^B10819119
"RTN","GMRCPC",1,0)
GMRCPC ;SLC/DCM,dee,MA - List Manager Routine: Collect and display consults by service and status ;4/18/01  10:29
"RTN","GMRCPC",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,7,21,23,22**;DEC 27, 1997
"RTN","GMRCPC",3,0)
 ; Patch #21 added clean-up KILL for ^TMP("GMRCTOT",$J)
"RTN","GMRCPC",4,0)
 ; Patch #23 add a KILL for GMRCSVNM
"RTN","GMRCPC",5,0)
EN ;GMRC List Manager Routine -- main entry point for GMRC PENDING CONSULTS
"RTN","GMRCPC",6,0)
 K GMRCSVC,GMRCSVCP
"RTN","GMRCPC",7,0)
 I $D(GMRCEACT),$L(GMRCEACT) D  I '$D(^GMR(123.5,$G(GMRCSVC),0)) D EXIT Q
"RTN","GMRCPC",8,0)
 .S GMRCSVCP=GMRCEACT
"RTN","GMRCPC",9,0)
 .S GMRCSVC=$O(^GMR(123.5,"B",GMRCSVCP,0))
"RTN","GMRCPC",10,0)
 .Q:'$D(^GMR(123.5,$G(GMRCSVC),0))
"RTN","GMRCPC",11,0)
 .;Build service array
"RTN","GMRCPC",12,0)
 .S GMRCDG=GMRCSVC
"RTN","GMRCPC",13,0)
 .D SERV1^GMRCASV
"RTN","GMRCPC",14,0)
 .S GMRCDT1="ALL"
"RTN","GMRCPC",15,0)
 .S GMRCDT2=0
"RTN","GMRCPC",16,0)
 .D LISTDATE^GMRCSTU1(GMRCDT1,GMRCDT2,.GMRCEDT1,.GMRCEDT2)
"RTN","GMRCPC",17,0)
 ;If no service ask for one
"RTN","GMRCPC",18,0)
 I '$L($G(GMRCSVC)) D EN^GMRCSTLM I $D(GMRCQUT) D EXIT Q
"RTN","GMRCPC",19,0)
 ;Quit if no array of services
"RTN","GMRCPC",20,0)
 I '$O(^TMP("GMRCSLIST",$J,0)) S GMRCQUT=1 D EXIT Q
"RTN","GMRCPC",21,0)
 ;
"RTN","GMRCPC",22,0)
 D EN^VALM("GMRC PENDING CONSULTS")
"RTN","GMRCPC",23,0)
 ;
"RTN","GMRCPC",24,0)
HDR ; -- header code
"RTN","GMRCPC",25,0)
 Q:$D(GMRCQUT)!'$D(GMRCCT)
"RTN","GMRCPC",26,0)
 S VALMHDR(1)="To Service:  "_GMRCHEAD
"RTN","GMRCPC",27,0)
 S VALMHDR(2)="From: "_$G(GMRCEDT1)_"   To: "_$G(GMRCEDT2)
"RTN","GMRCPC",28,0)
 I $G(GMRCCTRL)=1 S VALMCAP="     "_VALMCAP
"RTN","GMRCPC",29,0)
 Q
"RTN","GMRCPC",30,0)
 ;
"RTN","GMRCPC",31,0)
INIT ; -- init variables and list array
"RTN","GMRCPC",32,0)
 ;This entry is not used ENORLM^GMRCSTLM is used instead.
"RTN","GMRCPC",33,0)
 Q
"RTN","GMRCPC",34,0)
 ;
"RTN","GMRCPC",35,0)
HELP ; -- help code
"RTN","GMRCPC",36,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","GMRCPC",37,0)
 Q
"RTN","GMRCPC",38,0)
 ;
"RTN","GMRCPC",39,0)
EXIT ; -- exit code
"RTN","GMRCPC",40,0)
 K CNT,CTRLCOL,GMRCCT,GMRCQUT,GMRCSVC,GMRCSVCP,VALMHDR,GMRCCOMP
"RTN","GMRCPC",41,0)
 K GMRCEDT1,GMRCEDT2,GMRCSVNM
"RTN","GMRCPC",42,0)
 K GMRCHEAD,GMRCCTRL,GMRCSTAT,GMRCARRN
"RTN","GMRCPC",43,0)
 K ^TMP("GMRCS",$J),^TMP("GMRCSLIST",$J),^TMP("GMRCR",$J,"CP"),^TMP("GMRCRINDEX",$J),^TMP("GMRCTOT",$J)
"RTN","GMRCPC",44,0)
 Q
"RTN","GMRCPC",45,0)
 ;
"RTN","GMRCPC",46,0)
EXPND ; -- expand code
"RTN","GMRCPC",47,0)
 Q
"RTN","GMRCPC",48,0)
 ;
"RTN","GMRCPC",49,0)
CWIDTH(GMRCCTRL) ;Prints a message about how wide the report is.
"RTN","GMRCPC",50,0)
 N WIDTH
"RTN","GMRCPC",51,0)
 S WIDTH=92
"RTN","GMRCPC",52,0)
 I GMRCCTRL#100\10 D
"RTN","GMRCPC",53,0)
 .I GMRCCTRL#100\10=1 S WIDTH=WIDTH+5
"RTN","GMRCPC",54,0)
 .E  S WIDTH=WIDTH+10
"RTN","GMRCPC",55,0)
 I GMRCCTRL#1000\100 S WIDTH=WIDTH-6
"RTN","GMRCPC",56,0)
 Q WIDTH
"RTN","GMRCPC",57,0)
 ;
"RTN","GMRCPC",58,0)
PWIDTH(GMRCCTRL) ;Prints a message about how wide the report is.
"RTN","GMRCPC",59,0)
 W !!,"This print out is "_$$CWIDTH(GMRCCTRL)_" columns wide."
"RTN","GMRCPC",60,0)
 Q
"RTN","GMRCPC",61,0)
 ;
"RTN","GMRCPC",62,0)
PRNTONLY(GMRCCTRL) ;Option to just send the report to a device.
"RTN","GMRCPC",63,0)
 N GMRCQUT,RETURN,GMRCDG,GMRCSTAT,VALMBCK
"RTN","GMRCPC",64,0)
 N GMRCDT1,GMRCDT2,GMRCEDT1,GMRCEDT2
"RTN","GMRCPC",65,0)
 ;Get the statuses
"RTN","GMRCPC",66,0)
 S GMRCSTAT=$$STS^GMRCPC1
"RTN","GMRCPC",67,0)
 I $D(GMRCQUT) D EXIT Q
"RTN","GMRCPC",68,0)
 ;Get the service and date range.
"RTN","GMRCPC",69,0)
 D EN^GMRCSTLM
"RTN","GMRCPC",70,0)
 I $D(GMRCQUT) D EXIT Q
"RTN","GMRCPC",71,0)
 ;Quit if no array of services
"RTN","GMRCPC",72,0)
 I '$O(^TMP("GMRCSLIST",$J,0)) S GMRCQUT=1 D EXIT Q
"RTN","GMRCPC",73,0)
 I '($D(GMRCCTRL)#2) S GMRCCTRL=0 ;default to just the list
"RTN","GMRCPC",74,0)
 D PWIDTH(GMRCCTRL)
"RTN","GMRCPC",75,0)
 ;Get the device
"RTN","GMRCPC",76,0)
 D PRNTASK^GMRCSTU
"RTN","GMRCPC",77,0)
 I $D(GMRCQUT) D EXIT Q
"RTN","GMRCPC",78,0)
 ;Save some things if the report is queued
"RTN","GMRCPC",79,0)
 I $D(IO("Q")) D
"RTN","GMRCPC",80,0)
 .S ZTSAVE("GMRCSTAT")=""
"RTN","GMRCPC",81,0)
 .S ZTSAVE("GMRCCTRL")=""
"RTN","GMRCPC",82,0)
 ;Create the report if not queued
"RTN","GMRCPC",83,0)
 E  D ENOR^GMRCSTLM(.RETURN,GMRCDG,GMRCDT1,GMRCDT2,GMRCSTAT,GMRCCTRL,"CP")
"RTN","GMRCPC",84,0)
 ;Print the report
"RTN","GMRCPC",85,0)
 D PRNTIT^GMRCSTU("CP","PRNTQ^GMRCPC","CONSULT/REQUEST PACKAGE PRINT SERVICE CONSULTS BY STATUS FROM OPTION")
"RTN","GMRCPC",86,0)
 D EXIT
"RTN","GMRCPC",87,0)
 Q
"RTN","GMRCPC",88,0)
 ;
"RTN","GMRCPC",89,0)
PRNTQ ;Print Queued report from ^TMP global then kill off ^TMP & ^XTMP
"RTN","GMRCPC",90,0)
 ;Create the report
"RTN","GMRCPC",91,0)
 N RETURN,INDEX
"RTN","GMRCPC",92,0)
 D ENOR^GMRCSTLM(.RETURN,GMRCDG,GMRCDT1,GMRCDT2,GMRCSTAT,GMRCCTRL,"CP")
"RTN","GMRCPC",93,0)
 U IO
"RTN","GMRCPC",94,0)
 S INDEX=""
"RTN","GMRCPC",95,0)
 F  S INDEX=$O(^TMP("GMRCR",$J,TMPNAME,INDEX)) Q:INDEX=""  W ^TMP("GMRCR",$J,TMPNAME,INDEX,0),!
"RTN","GMRCPC",96,0)
 K ^TMP("GMRCR",$J,TMPNAME),^XTMP("GMRCR",J,DOLLARH,"PRINT"),J,DOLLARH
"RTN","GMRCPC",97,0)
 D ^%ZISC
"RTN","GMRCPC",98,0)
 D EXIT
"RTN","GMRCPC",99,0)
 Q
"RTN","GMRCPC",100,0)
 ;
"RTN","GMRCPSL1")
0^57^B77326174
"RTN","GMRCPSL1",1,0)
GMRCPSL1 ;SLC/MA - Special Consult Reports;9/21/01  05:25 ;1/10/02  14:26
"RTN","GMRCPSL1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**23,22**;DEC 27, 1997
"RTN","GMRCPSL1",3,0)
 ; This is the main entry routine for the Consult Reports that
"RTN","GMRCPSL1",4,0)
 ; allow a user to search for consults by:  Provider, Location,
"RTN","GMRCPSL1",5,0)
 ; or Procedure.  Also the user may select a date range and
"RTN","GMRCPSL1",6,0)
 ; Consult status.
"RTN","GMRCPSL1",7,0)
 ; The routines will not let the user search on any Inter-Facility
"RTN","GMRCPSL1",8,0)
 ; information but will will use IFC when local fields are not present
"RTN","GMRCPSL1",9,0)
EN ;
"RTN","GMRCPSL1",10,0)
 ; GMRCARRY = used for entering more than one search value.
"RTN","GMRCPSL1",11,0)
 ;            This array will be used by all the diff searches.
"RTN","GMRCPSL1",12,0)
 ; GMRCDT1  = Start date
"RTN","GMRCPSL1",13,0)
 ; GMRCDT2  = Stop date
"RTN","GMRCPSL1",14,0)
 ; GMRCEND  = If equal to one end routine
"RTN","GMRCPSL1",15,0)
 ; GMRCSRCH = Indicates which field to search on
"RTN","GMRCPSL1",16,0)
 ; GMRCSTAT = Indicates which CPRS status to include
"RTN","GMRCPSL1",17,0)
 ; GMRCRPT  = 80 - 132 character report & data only output
"RTN","GMRCPSL1",18,0)
 ; GMRCBRK  = Print page break between sub-totals <Y-N>
"RTN","GMRCPSL1",19,0)
 N GMRCDT1,GMRCDT2,GMRCARRY,GMRCSRCH,GMRCEND,GMRCSTAT,GMRCRPT,GMRCBRK
"RTN","GMRCPSL1",20,0)
 N GMRCQUIT
"RTN","GMRCPSL1",21,0)
 S (GMRCBRK,GMRCQUIT,GMRCEND)=0
"RTN","GMRCPSL1",22,0)
 S GMRCSRCH=$$GETSRCH                  ; Get search sequence
"RTN","GMRCPSL1",23,0)
 I GMRCSRCH=1 D                        ; Get Provider
"RTN","GMRCPSL1",24,0)
 . D GETPROV(.GMRCARRY) D
"RTN","GMRCPSL1",25,0)
 . . I '$D(GMRCARRY(1)) D WARNING
"RTN","GMRCPSL1",26,0)
 ;
"RTN","GMRCPSL1",27,0)
 I GMRCSRCH=2 D                        ; Get Location
"RTN","GMRCPSL1",28,0)
 . D GETLOC(.GMRCARRY) D
"RTN","GMRCPSL1",29,0)
 . . I '$D(GMRCARRY(1)) D WARNING
"RTN","GMRCPSL1",30,0)
 ;
"RTN","GMRCPSL1",31,0)
 I GMRCSRCH=3 D                        ; Get Procedure
"RTN","GMRCPSL1",32,0)
 . D GETPROC(.GMRCARRY) D
"RTN","GMRCPSL1",33,0)
 . . I '$D(GMRCARRY) D WARNING
"RTN","GMRCPSL1",34,0)
 I GMRCEND=1 K GMRCEND Q
"RTN","GMRCPSL1",35,0)
 S GMRCRPT=$$TYPERPT Q:GMRCRPT=0       ; Get type or print
"RTN","GMRCPSL1",36,0)
 I GMRCRPT'=3 S GMRCBRK=$$PAGEBRK      ; Break between sub-totals
"RTN","GMRCPSL1",37,0)
 I GMRCBRK>1 Q
"RTN","GMRCPSL1",38,0)
 D GETDATE I GMRCQUIT Q                ; Get Date
"RTN","GMRCPSL1",39,0)
 I '$D(GMRCDT2) Q
"RTN","GMRCPSL1",40,0)
 S GMRCDT2=GMRCDT2+1
"RTN","GMRCPSL1",41,0)
 ;
"RTN","GMRCPSL1",42,0)
 ;
"RTN","GMRCPSL1",43,0)
 S GMRCSTAT=$$STS^GMRCPC1 Q:'GMRCSTAT  ; Get search CPRS status
"RTN","GMRCPSL1",44,0)
 ;
"RTN","GMRCPSL1",45,0)
 I GMRCRPT=0 Q
"RTN","GMRCPSL1",46,0)
 ;
"RTN","GMRCPSL1",47,0)
 D DEVICE                              ; Get printer device
"RTN","GMRCPSL1",48,0)
 ;
"RTN","GMRCPSL1",49,0)
 ; At this point all user input has been collected
"RTN","GMRCPSL1",50,0)
 ;
"RTN","GMRCPSL1",51,0)
 I $D(IO("Q")) D QUEUE Q
"RTN","GMRCPSL1",52,0)
 ;
"RTN","GMRCPSL1",53,0)
 ; Go build ^TMP("GMRCRPT",$J) using user input variables &
"RTN","GMRCPSL1",54,0)
 ; write report
"RTN","GMRCPSL1",55,0)
 D PRINT^GMRCPSL2(GMRCSRCH,.GMRCARRY,GMRCDT1,GMRCDT2,GMRCSTAT,GMRCRPT,GMRCBRK)  ;Report writer
"RTN","GMRCPSL1",56,0)
 KILL DIR,DIC,^TMP("GMRCRPT",$J)
"RTN","GMRCPSL1",57,0)
 Q
"RTN","GMRCPSL1",58,0)
 ;
"RTN","GMRCPSL1",59,0)
CHECK(GMRCDAT)  ;CHECK FREE TEXT INPUT 
"RTN","GMRCPSL1",60,0)
 N %DT,X,Y
"RTN","GMRCPSL1",61,0)
 I $E("ALL DATES",1,$L(GMRCDAT))=$$UP^XLFSTR(GMRCDAT) Q "ALL"
"RTN","GMRCPSL1",62,0)
 S %DT="E",X=GMRCDAT D ^%DT I Y<1 Q 0
"RTN","GMRCPSL1",63,0)
 Q +Y
"RTN","GMRCPSL1",64,0)
 I '$D(GMRCDT1) Q
"RTN","GMRCPSL1",65,0)
 I GMRCDT1="ALL" S GMRCDT1=0000000,GMRCDT2=9999999
"RTN","GMRCPSL1",66,0)
 Q
"RTN","GMRCPSL1",67,0)
DEVICE  ; device for printout of entries to group update
"RTN","GMRCPSL1",68,0)
 N %ZIS,POP
"RTN","GMRCPSL1",69,0)
 I GMRCRPT=2 D
"RTN","GMRCPSL1",70,0)
 . W !!,"You must configure your terminal so that it"
"RTN","GMRCPSL1",71,0)
 . W " will support 132 character"
"RTN","GMRCPSL1",72,0)
 . W !,"emulation and reply 132 to the right margin setting if"
"RTN","GMRCPSL1",73,0)
 . W " using HOME"
"RTN","GMRCPSL1",74,0)
 . W !,"as the device."
"RTN","GMRCPSL1",75,0)
 . W !,""
"RTN","GMRCPSL1",76,0)
 I GMRCRPT=3 D
"RTN","GMRCPSL1",77,0)
 . W !!,"OK, you have selected a TABLE output format."
"RTN","GMRCPSL1",78,0)
 . W !,"You must use your personal computer's terminal emulation"
"RTN","GMRCPSL1",79,0)
 . W !,"to capture the output:"
"RTN","GMRCPSL1",80,0)
 . W !,""
"RTN","GMRCPSL1",81,0)
 . W !,"     1.  Enter at the DEVICE: HOME// prompt "";250;99999999"
"RTN","GMRCPSL1",82,0)
 . W !,"         and do not hit the enter key."
"RTN","GMRCPSL1",83,0)
 . W !,"     2.  Open a capture file within your terminal emulation program."
"RTN","GMRCPSL1",84,0)
 . W !,"     3.  Hit enter to start the down load."
"RTN","GMRCPSL1",85,0)
 . W !,"     4.  Close the capture file when the output stops."
"RTN","GMRCPSL1",86,0)
 . W !,""
"RTN","GMRCPSL1",87,0)
RETRY ;
"RTN","GMRCPSL1",88,0)
 S %ZIS="MQ"
"RTN","GMRCPSL1",89,0)
 D ^%ZIS
"RTN","GMRCPSL1",90,0)
 I POP S GMRCEND=1 Q
"RTN","GMRCPSL1",91,0)
 Q
"RTN","GMRCPSL1",92,0)
 ;
"RTN","GMRCPSL1",93,0)
GETDATE ;Get START and STOP dates
"RTN","GMRCPSL1",94,0)
 ;GMRCDT1=Start date
"RTN","GMRCPSL1",95,0)
 ;GMRCDT2=Stop date
"RTN","GMRCPSL1",96,0)
 N DTOUT,DIR,DUOUT,DIRUT,X,Y
"RTN","GMRCPSL1",97,0)
GETDATE1 ;
"RTN","GMRCPSL1",98,0)
 S DIR(0)="FA^1:45",DIR("A")="List From Starting Date (ALL): "
"RTN","GMRCPSL1",99,0)
 S DIR("B")="T-30" D ^DIR
"RTN","GMRCPSL1",100,0)
 I $D(DUOUT)!($D(DTOUT)) S GMRCQUIT=1 Q
"RTN","GMRCPSL1",101,0)
 S GMRCDT1=$$CHECK(X)
"RTN","GMRCPSL1",102,0)
 I 'GMRCDT1,GMRCDT1'="ALL" G GETDATE1
"RTN","GMRCPSL1",103,0)
 I GMRCDT1="ALL" S GMRCDT1=0,GMRCDT2=9999999 Q
"RTN","GMRCPSL1",104,0)
 K DIR
"RTN","GMRCPSL1",105,0)
 S DIR(0)="DAO^::E",DIR("A")="List To This Ending Date: " D ^DIR
"RTN","GMRCPSL1",106,0)
 I $D(DTOUT)!($D(DUOUT)) K GMRCDT1,GMRCDT2 Q
"RTN","GMRCPSL1",107,0)
 I +Y=0 W "(NOW)" S GMRCDT2=$$DT^XLFDT Q
"RTN","GMRCPSL1",108,0)
 I +Y<GMRCDT1 S GMRCDT2=GMRCDT1,GMRCDT1=+Y
"RTN","GMRCPSL1",109,0)
 S:'$D(GMRCDT2) GMRCDT2=+Y
"RTN","GMRCPSL1",110,0)
 Q
"RTN","GMRCPSL1",111,0)
 ;
"RTN","GMRCPSL1",112,0)
 ; Get a Location
"RTN","GMRCPSL1",113,0)
GETLOC(GMRCARRY) ;
"RTN","GMRCPSL1",114,0)
 ; DBIA 10040 call DIC=44
"RTN","GMRCPSL1",115,0)
 N DIC,DIR,DIRUT,DUOUT,DTOUT,X,Y,GMRCCNTR,GMRCQLOC
"RTN","GMRCPSL1",116,0)
 S GMRCCNTR=0
"RTN","GMRCPSL1",117,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","GMRCPSL1",118,0)
 S DIR("A")="Enter 'YES' if you want all LOCATIONS"
"RTN","GMRCPSL1",119,0)
 W !,""
"RTN","GMRCPSL1",120,0)
 D ^DIR
"RTN","GMRCPSL1",121,0)
 W !,""
"RTN","GMRCPSL1",122,0)
 I Y=1 S GMRCARRY(1)="ALL"
"RTN","GMRCPSL1",123,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCPSL1",124,0)
 S DIR(0)="SA^L:LOCAL;R:REMOTE;B:BOTH LOCAL AND REMOTE LOCATIONS"
"RTN","GMRCPSL1",125,0)
 S DIR("A")=$S($D(GMRCARRY):"All ",1:"")_"(L)ocal, (R)emote, or (B)oth Local and Remote Locations: "
"RTN","GMRCPSL1",126,0)
 S DIR("B")="Local"
"RTN","GMRCPSL1",127,0)
 S DIR("?")="^D HELP^GMRCPSL1"
"RTN","GMRCPSL1",128,0)
 D ^DIR I $D(DIRUT) S GMRCEND=1 Q
"RTN","GMRCPSL1",129,0)
 S GMRCARRY=Y
"RTN","GMRCPSL1",130,0)
 Q:$D(GMRCARRY(1))
"RTN","GMRCPSL1",131,0)
 W !
"RTN","GMRCPSL1",132,0)
 I "LB"[GMRCARRY D
"RTN","GMRCPSL1",133,0)
 . S DIC=44,DIC(0)="AEMQ",DIC("A")="ENTER Local LOCATION: "
"RTN","GMRCPSL1",134,0)
 . F  D ^DIC Q:$D(DUOUT)!($D(DTOUT))!(Y<0)  D
"RTN","GMRCPSL1",135,0)
 . .  S GMRCCNTR=GMRCCNTR+1
"RTN","GMRCPSL1",136,0)
 . .  S GMRCARRY(GMRCCNTR)=Y_"^"_44
"RTN","GMRCPSL1",137,0)
 I "B"[GMRCARRY W !
"RTN","GMRCPSL1",138,0)
 I "RB"[GMRCARRY D
"RTN","GMRCPSL1",139,0)
 . N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCPSL1",140,0)
 . S DIR(0)="PO^4:EMQ"
"RTN","GMRCPSL1",141,0)
 . S DIR("S")="I $$STA^XUAF4(+Y)=+$$STA^XUAF4(+Y)"
"RTN","GMRCPSL1",142,0)
 . S DIR("A")="ENTER Remote LOCATION"
"RTN","GMRCPSL1",143,0)
 . S DIR("?")="For this report, Institution file (#4) entries are considered Remote locations."
"RTN","GMRCPSL1",144,0)
 . F  D ^DIR S:$D(DTOUT) GMRCEND=1 S:$D(DUOUT) GMRCEND=1 Q:$D(DIRUT)  D
"RTN","GMRCPSL1",145,0)
 . . S GMRCCNTR=GMRCCNTR+1
"RTN","GMRCPSL1",146,0)
 . . S GMRCARRY(GMRCCNTR)=Y_"^"_4
"RTN","GMRCPSL1",147,0)
 Q
"RTN","GMRCPSL1",148,0)
 ;
"RTN","GMRCPSL1",149,0)
 ; Get a Procedure
"RTN","GMRCPSL1",150,0)
GETPROC(GMRCARRY) ;
"RTN","GMRCPSL1",151,0)
 N DIC,DIR,DIRUT,DUOUT,DTOUT,X,Y,GMRCCNTR,GMRCQPRC
"RTN","GMRCPSL1",152,0)
 S GMRCCNTR=0
"RTN","GMRCPSL1",153,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","GMRCPSL1",154,0)
 S DIR("A")="Enter 'YES' if you want all PROCEDURES"
"RTN","GMRCPSL1",155,0)
 W !,""
"RTN","GMRCPSL1",156,0)
 D ^DIR
"RTN","GMRCPSL1",157,0)
 W !,""
"RTN","GMRCPSL1",158,0)
 I Y=1 S GMRCARRY(1)="ALL"  Q
"RTN","GMRCPSL1",159,0)
 S DIC=123.3,DIC(0)="AEMQ",DIC("A")="ENTER PROCEDURE: "
"RTN","GMRCPSL1",160,0)
 F  D ^DIC Q:$D(DUOUT)!($D(DTOUT))!(Y<0)  D
"RTN","GMRCPSL1",161,0)
 .  S GMRCCNTR=GMRCCNTR+1
"RTN","GMRCPSL1",162,0)
 .  S GMRCARRY(GMRCCNTR)=Y
"RTN","GMRCPSL1",163,0)
 Q
"RTN","GMRCPSL1",164,0)
 ;
"RTN","GMRCPSL1",165,0)
 ; Get a Provider name
"RTN","GMRCPSL1",166,0)
GETPROV(GMRCARRY) ;
"RTN","GMRCPSL1",167,0)
 ; DBIA 10060 call DIC=200
"RTN","GMRCPSL1",168,0)
 N DIC,DIRUT,DUOUT,DTOUT,X,Y,GMRCCNTR,GMRCQPRV
"RTN","GMRCPSL1",169,0)
 S GMRCCNTR=0
"RTN","GMRCPSL1",170,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","GMRCPSL1",171,0)
 S DIR("A")="Enter 'YES' if you want all PROVIDERS"
"RTN","GMRCPSL1",172,0)
 W !,""
"RTN","GMRCPSL1",173,0)
 D ^DIR
"RTN","GMRCPSL1",174,0)
 W !,""
"RTN","GMRCPSL1",175,0)
 I Y=1 S GMRCARRY(1)="ALL"
"RTN","GMRCPSL1",176,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCPSL1",177,0)
 S DIR(0)="SA^L:LOCAL;R:REMOTE;B:BOTH LOCAL AND REMOTE PROVIDERS"
"RTN","GMRCPSL1",178,0)
 S DIR("A")=$S($D(GMRCARRY):"All ",1:"")_"(L)ocal, (R)emote, or (B)oth Local and Remote Providers: "
"RTN","GMRCPSL1",179,0)
 S DIR("B")="Local"
"RTN","GMRCPSL1",180,0)
 S DIR("?")="^D HELP^GMRCPSL1"
"RTN","GMRCPSL1",181,0)
 D ^DIR I $D(DIRUT) S GMRCEND=1 Q
"RTN","GMRCPSL1",182,0)
 S GMRCARRY=Y
"RTN","GMRCPSL1",183,0)
 Q:$D(GMRCARRY(1))
"RTN","GMRCPSL1",184,0)
 W !
"RTN","GMRCPSL1",185,0)
 I "LB"[GMRCARRY D
"RTN","GMRCPSL1",186,0)
 . S DIC=200,DIC(0)="AEMQ",DIC("A")="ENTER Local PROVIDER: "
"RTN","GMRCPSL1",187,0)
 . F  D ^DIC Q:$D(DUOUT)!($D(DTOUT))!(Y<0)  D
"RTN","GMRCPSL1",188,0)
 . .  S GMRCCNTR=GMRCCNTR+1
"RTN","GMRCPSL1",189,0)
 . .  S GMRCARRY(GMRCCNTR)=Y_"^"_200
"RTN","GMRCPSL1",190,0)
 I "B"[GMRCARRY W !
"RTN","GMRCPSL1",191,0)
 I "RB"[GMRCARRY D
"RTN","GMRCPSL1",192,0)
 . N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","GMRCPSL1",193,0)
 . S DIR(0)="FO^2:40^D UP^GMRCA2 K:'$D(^GMR(123,""AIP"",X)) X"
"RTN","GMRCPSL1",194,0)
 . S DIR("?")="^D HELPR^GMRCIR,HELPR^GMRCPSL1"
"RTN","GMRCPSL1",195,0)
 . S DIR("A")="ENTER Remote PROVIDER"
"RTN","GMRCPSL1",196,0)
 . F  D ^DIR S:$D(DTOUT) GMRCEND=1 S:$D(DUOUT) GMRCEND=1 Q:$D(DIRUT)  D
"RTN","GMRCPSL1",197,0)
 . . D UP^GMRCA2 S Y=X
"RTN","GMRCPSL1",198,0)
 . . S GMRCCNTR=GMRCCNTR+1
"RTN","GMRCPSL1",199,0)
 . . S GMRCARRY(GMRCCNTR)=Y
"RTN","GMRCPSL1",200,0)
 Q
"RTN","GMRCPSL1",201,0)
HELP ; Help for location and provider prompts
"RTN","GMRCPSL1",202,0)
 W !!?3,"""Local"" refers to non-Inter-facility requests and Inter-"
"RTN","GMRCPSL1",203,0)
 W !?3,"facility requests originating locally."
"RTN","GMRCPSL1",204,0)
 W !?3,"""Remote"" only refers to Inter-facility requests originating"
"RTN","GMRCPSL1",205,0)
 W !?3,"at another site."
"RTN","GMRCPSL1",206,0)
 Q
"RTN","GMRCPSL1",207,0)
HELPR ; Help for remote provider prompt
"RTN","GMRCPSL1",208,0)
 W:$Y>(IOSL-4) @IOF
"RTN","GMRCPSL1",209,0)
 W !!?3,"Enter the ENTIRE name in proper CASE, exactly as it"
"RTN","GMRCPSL1",210,0)
 W !?3,"appears in the above list (including any credentials)."
"RTN","GMRCPSL1",211,0)
 W !?3,"Use copy/paste to avoid typing errors."
"RTN","GMRCPSL1",212,0)
 W !?3,"NO partial matches are done."
"RTN","GMRCPSL1",213,0)
 W !
"RTN","GMRCPSL1",214,0)
 Q
"RTN","GMRCPSL1",215,0)
GETSRCH() ;   What search criteria should report be in???
"RTN","GMRCPSL1",216,0)
 N DIR,Y,X
"RTN","GMRCPSL1",217,0)
 S DIR("A",1)="Enter Search criteria:"
"RTN","GMRCPSL1",218,0)
 S DIR("A",2)=""
"RTN","GMRCPSL1",219,0)
 S DIR("A",3)="                  1 = Sending Provider"
"RTN","GMRCPSL1",220,0)
 S DIR("A",4)="                  2 = Location"
"RTN","GMRCPSL1",221,0)
 S DIR("A",5)="                  3 = Procedure"
"RTN","GMRCPSL1",222,0)
 S DIR("A",6)=""
"RTN","GMRCPSL1",223,0)
 S DIR("A")="Search criteria"
"RTN","GMRCPSL1",224,0)
 S DIR("B")=1
"RTN","GMRCPSL1",225,0)
 S DIR(0)="NO^1:3"
"RTN","GMRCPSL1",226,0)
 D ^DIR
"RTN","GMRCPSL1",227,0)
 I ($D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT)) S GMRCEND=1
"RTN","GMRCPSL1",228,0)
 Q Y
"RTN","GMRCPSL1",229,0)
 ;
"RTN","GMRCPSL1",230,0)
PAGEBRK() ; Does user want page breaks between sub-totals?
"RTN","GMRCPSL1",231,0)
 N DIR
"RTN","GMRCPSL1",232,0)
 S DIR(0)="Y"
"RTN","GMRCPSL1",233,0)
 S DIR("A")="Display sort sequence & page breaks between sub-totals"
"RTN","GMRCPSL1",234,0)
 S DIR("B")="YES"
"RTN","GMRCPSL1",235,0)
 D ^DIR I $D(DIRUT) Q 2
"RTN","GMRCPSL1",236,0)
 Q +Y
"RTN","GMRCPSL1",237,0)
TYPERPT() ; Get type of report to print
"RTN","GMRCPSL1",238,0)
 N DIR
"RTN","GMRCPSL1",239,0)
 S DIR(0)="SO^1:80 column;2:132 column;3:Table Export"
"RTN","GMRCPSL1",240,0)
 S DIR("L",1)="Please select an output format from the following:"
"RTN","GMRCPSL1",241,0)
 S DIR("L",2)=""
"RTN","GMRCPSL1",242,0)
 S DIR("L",3)="1 -  80 column standard print [STANDARD]"
"RTN","GMRCPSL1",243,0)
 S DIR("L",4)="2 - 132 column standard print"
"RTN","GMRCPSL1",244,0)
 S DIR("L")="3 - Table without headers (export to another application)"
"RTN","GMRCPSL1",245,0)
 S DIR("B")=1
"RTN","GMRCPSL1",246,0)
 D ^DIR I $D(DIRUT)!(Y>3) Q 0
"RTN","GMRCPSL1",247,0)
 Q +Y
"RTN","GMRCPSL1",248,0)
 ;
"RTN","GMRCPSL1",249,0)
QUEUE   ; send task for print and update
"RTN","GMRCPSL1",250,0)
 N ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSAVE,ZTSK
"RTN","GMRCPSL1",251,0)
 S ZTRTN="PRTTSK^GMRCPSL2",ZTDESC="PRINT OF RECORDS FILE 123"
"RTN","GMRCPSL1",252,0)
 S ZTIO=ION
"RTN","GMRCPSL1",253,0)
 S ZTSAVE("GMRC*")=""
"RTN","GMRCPSL1",254,0)
 D ^%ZTLOAD I $G(ZTSK) W !,"Task # ",ZTSK
"RTN","GMRCPSL1",255,0)
 I '$G(ZTSK) W !,"Unable to queue report!  Try again later."
"RTN","GMRCPSL1",256,0)
 Q
"RTN","GMRCPSL1",257,0)
WARNING ; Let user know that they did not enter any data.
"RTN","GMRCPSL1",258,0)
 W !!,"No search criteria was entered" H 1
"RTN","GMRCPSL1",259,0)
 S GMRCEND=1
"RTN","GMRCPSL1",260,0)
 Q
"RTN","GMRCPSL2")
0^46^B61336942
"RTN","GMRCPSL2",1,0)
GMRCPSL2 ;SLC/MA - Special Consult Reports;9/21/01  05:25 ;1/17/02  18:19
"RTN","GMRCPSL2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**23,22**;DEC 27, 1997
"RTN","GMRCPSL2",3,0)
 ; This routine is used by GMRCPSL1 to build ^TMP("GMRCRPT",$J)
"RTN","GMRCPSL2",4,0)
 ; which will be passed to GMRCPSL3.
"RTN","GMRCPSL2",5,0)
PRINT(GMRCSRCH,GMRCARRY,GMRCDT1,GMRCDT2,GMRCSTAT,GMRCRPT,GMRCBRK) ; Untasked Print
"RTN","GMRCPSL2",6,0)
PRTTSK ; Print report
"RTN","GMRCPSL2",7,0)
 ; GMRCARRY = Array contains search values.
"RTN","GMRCPSL2",8,0)
 ; GMRCSRCH = Indicates which field to search on
"RTN","GMRCPSL2",9,0)
 ; GMRCDT1  = Start date
"RTN","GMRCPSL2",10,0)
 ; GMRCDT2  = Stop date
"RTN","GMRCPSL2",11,0)
 ; GMRCSTAT = CPRS status to include in report
"RTN","GMRCPSL2",12,0)
 ; SUBTOT   = Counter for different groups
"RTN","GMRCPSL2",13,0)
 ; GMRCRPT  = 80 - 132 character report & data only output
"RTN","GMRCPSL2",14,0)
 ; GMRCBRK  = Print page break between sub-totals <Y-N>
"RTN","GMRCPSL2",15,0)
 ; TOTCNTR  = Count for total records
"RTN","GMRCPSL2",16,0)
 I GMRCSRCH=1 D BLDPROV(.GMRCARRY)   ;BLD PROVIDER  ^TMP(GLOBAL)
"RTN","GMRCPSL2",17,0)
 I GMRCSRCH=2 D BLDLOC(.GMRCARRY)    ;BLD LOCATION  ^TMP(GLOBAL)
"RTN","GMRCPSL2",18,0)
 I GMRCSRCH=3 D BLDPROC(.GMRCARRY)   ;BLD PROCEDURE ^TMP(GLOBAL)
"RTN","GMRCPSL2",19,0)
 N TOTCNTR,SUBTOT S (SUBTOT,TOTCNTR)=0
"RTN","GMRCPSL2",20,0)
 I GMRCRPT=1 D REPORT80^GMRCPSL3(.SUBTOT,.TOTCNTR,GMRCSRCH,GMRCBRK)
"RTN","GMRCPSL2",21,0)
 I GMRCRPT=2 D REPORT32^GMRCPSL3(.SUBTOT,.TOTCNTR,GMRCSRCH,GMRCBRK)
"RTN","GMRCPSL2",22,0)
 I GMRCRPT=3 D DATAONLY^GMRCPSL4 Q
"RTN","GMRCPSL2",23,0)
 W !!,"SUB TOTAL= ",SUBTOT,!
"RTN","GMRCPSL2",24,0)
 W !,"TOTAL RECORDS= ",TOTCNTR
"RTN","GMRCPSL2",25,0)
 D ^%ZISC
"RTN","GMRCPSL2",26,0)
 K ^TMP("GMRCRPT",$J)
"RTN","GMRCPSL2",27,0)
 I ($E(IOST)="C") D
"RTN","GMRCPSL2",28,0)
 .N DIR
"RTN","GMRCPSL2",29,0)
 .S DIR(0)="E"
"RTN","GMRCPSL2",30,0)
 .W !
"RTN","GMRCPSL2",31,0)
 .D ^DIR K DIR
"RTN","GMRCPSL2",32,0)
 Q
"RTN","GMRCPSL2",33,0)
 ;
"RTN","GMRCPSL2",34,0)
BLDLOC(GMRCARRY) ; Build ^TMP were search was on location.
"RTN","GMRCPSL2",35,0)
 K ^TMP("GMRCRPT",$J)
"RTN","GMRCPSL2",36,0)
 N GMRCCNTR,LOCATION,GMRCSRT1,GMRCSRT2,GMRCLOC1,GMRCLOC2,IEN
"RTN","GMRCPSL2",37,0)
 N GMRCREM,LOCPN
"RTN","GMRCPSL2",38,0)
 S GMRCCNTR=0
"RTN","GMRCPSL2",39,0)
 ;
"RTN","GMRCPSL2",40,0)
 ; get all Locations by date range
"RTN","GMRCPSL2",41,0)
 I GMRCARRY(1)="ALL" D
"RTN","GMRCPSL2",42,0)
 .  S GMRCLOC1=GMRCDT1,GMRCLOC2=GMRCDT2
"RTN","GMRCPSL2",43,0)
 .  F  S GMRCLOC1=$O(^GMR(123,"E",GMRCLOC1)) Q:GMRCLOC1>GMRCLOC2  Q:GMRCLOC1=""  D
"RTN","GMRCPSL2",44,0)
 . .  S IEN=0
"RTN","GMRCPSL2",45,0)
 . .  F  S IEN=$O(^GMR(123,"E",GMRCLOC1,IEN)) Q:IEN'>0  D
"RTN","GMRCPSL2",46,0)
 . . .  ;
"RTN","GMRCPSL2",47,0)
 . . .  ; Check for Patient Location
"RTN","GMRCPSL2",48,0)
 . . .  I "LB"[GMRCARRY,$$CKSTAT(IEN,GMRCSTAT),+$P(^GMR(123,IEN,0),"^",4) D  Q
"RTN","GMRCPSL2",49,0)
 . . . .  S LOCATION=$P(^GMR(123,IEN,0),"^",4)   ; PATIENT LOCATION
"RTN","GMRCPSL2",50,0)
 . . . .  S GMRCSRT1=$$GET1^DIQ(44,LOCATION,.01)  ; PATIENT LOCATION
"RTN","GMRCPSL2",51,0)
 . . . .  S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)   ; DATE OF REQUEST
"RTN","GMRCPSL2",52,0)
 . . . .  S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)
"RTN","GMRCPSL2",53,0)
 . . .  ;
"RTN","GMRCPSL2",54,0)
 . . .  ; If no patient location, check for Ordering Facility
"RTN","GMRCPSL2",55,0)
 . . .  I $$CKSTAT(IEN,GMRCSTAT),'+$P(^GMR(123,IEN,0),"^",4),+$P(^GMR(123,IEN,0),"^",21),("L"[GMRCARRY&'+$P(^GMR(123,IEN,0),"^",23)!("RB"[GMRCARRY&+$P(^GMR(123,IEN,0),"^",23))) D  Q
"RTN","GMRCPSL2",56,0)
 . . . .  S LOCATION=$P(^GMR(123,IEN,0),"^",21)  ;ORDERING FACILITY
"RTN","GMRCPSL2",57,0)
 . . . .  S GMRCSRT1=$$GET1^DIQ(4,LOCATION,.01)  ;ORDERING FACILITY
"RTN","GMRCPSL2",58,0)
 . . . .  S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)   ;DATE OF REQUEST
"RTN","GMRCPSL2",59,0)
 . . . .  S GMRCREM=$P($G(^GMR(123,IEN,12)),"^",6)
"RTN","GMRCPSL2",60,0)
 . . . .  S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)_"^"_GMRCREM
"RTN","GMRCPSL2",61,0)
 . . .  ;
"RTN","GMRCPSL2",62,0)
 . . .  ; If no patient location & NO Ordering Facility, then
"RTN","GMRCPSL2",63,0)
 . . .  ; check for Routing Facility
"RTN","GMRCPSL2",64,0)
 . . .  I "RB"[GMRCARRY,$$CKSTAT(IEN,GMRCSTAT),'+$P(^GMR(123,IEN,0),"^",4),'+$P(^GMR(123,IEN,0),"^",21),+$P(^GMR(123,IEN,0),"^",23) D  Q
"RTN","GMRCPSL2",65,0)
 . . . .  S LOCATION=$P(^GMR(123,IEN,0),"^",23)  ;ROUTING FACILITY
"RTN","GMRCPSL2",66,0)
 . . . .  S GMRCSRT1=$$GET1^DIQ(4,LOCATION,.01)  ;ROUTING FACILITY
"RTN","GMRCPSL2",67,0)
 . . . .  S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)   ;DATE OF REQUEST
"RTN","GMRCPSL2",68,0)
 . . . .  S GMRCREM=$P($G(^GMR(123,IEN,12)),"^",6)
"RTN","GMRCPSL2",69,0)
 . . . .  S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)_"^"_GMRCREM
"RTN","GMRCPSL2",70,0)
 ; Get location list from GMRCARRY and then go to global using location
"RTN","GMRCPSL2",71,0)
 I GMRCARRY(1)="ALL" Q
"RTN","GMRCPSL2",72,0)
 F  S GMRCCNTR=$O(GMRCARRY(GMRCCNTR)) Q:'GMRCCNTR  D
"RTN","GMRCPSL2",73,0)
 .  S LOCATION=$P(GMRCARRY(GMRCCNTR),"^",1)
"RTN","GMRCPSL2",74,0)
 . I "LB"[GMRCARRY,$P(GMRCARRY(GMRCCNTR),"^",3)=44 D
"RTN","GMRCPSL2",75,0)
 . .  N IEN S IEN=0
"RTN","GMRCPSL2",76,0)
 . .  F  S IEN=$O(^GMR(123,"AL",LOCATION,IEN)) Q:IEN'>0  D
"RTN","GMRCPSL2",77,0)
 . . .  I $P(^GMR(123,IEN,0),"^",7)>GMRCDT1,$P(^GMR(123,IEN,0),"^",7)<GMRCDT2,$$CKSTAT(IEN,GMRCSTAT) D
"RTN","GMRCPSL2",78,0)
 . . . . S GMRCSRT1=$P(GMRCARRY(GMRCCNTR),"^",2)   ; Patient Location
"RTN","GMRCPSL2",79,0)
 . . . . S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)      ; DATE OF REQUEST
"RTN","GMRCPSL2",80,0)
 . . . . S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)
"RTN","GMRCPSL2",81,0)
 . I "RB"[GMRCARRY,$P(GMRCARRY(GMRCCNTR),"^",3)=4 D
"RTN","GMRCPSL2",82,0)
 . . S GMRCLOC1=GMRCDT1,GMRCLOC2=GMRCDT2
"RTN","GMRCPSL2",83,0)
 . . F  S GMRCLOC1=$O(^GMR(123,"E",GMRCLOC1)) Q:GMRCLOC1>GMRCLOC2  Q:GMRCLOC1=""  D
"RTN","GMRCPSL2",84,0)
 . . .  N IEN S IEN=0
"RTN","GMRCPSL2",85,0)
 . . .  F  S IEN=$O(^GMR(123,"E",GMRCLOC1,IEN)) Q:IEN'>0  D
"RTN","GMRCPSL2",86,0)
 . . . . I $$CKSTAT(IEN,GMRCSTAT),$P($G(^GMR(123,IEN,12)),"^",5)="F",+$P($G(^GMR(123,IEN,0)),"^",21)=LOCATION D  Q
"RTN","GMRCPSL2",87,0)
 . . . . . S GMRCSRT1=$P(GMRCARRY(GMRCCNTR),"^",2)
"RTN","GMRCPSL2",88,0)
 . . . . . S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)
"RTN","GMRCPSL2",89,0)
 . . . . . S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)
"RTN","GMRCPSL2",90,0)
 . . . . I $$CKSTAT(IEN,GMRCSTAT),$P($G(^GMR(123,IEN,12)),"^",5)="F",'+$P(^GMR(123,IEN,0),"^",21),+$P($G(^GMR(123,IEN,0)),"^",23)=LOCATION D  Q
"RTN","GMRCPSL2",91,0)
 . . . . . S GMRCSRT1=$P(GMRCARRY(GMRCCNTR),"^",2)
"RTN","GMRCPSL2",92,0)
 . . . . . S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)
"RTN","GMRCPSL2",93,0)
 . . . . . S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)
"RTN","GMRCPSL2",94,0)
 Q
"RTN","GMRCPSL2",95,0)
BLDPROC(GMRCARRY) ; Build ^TMP were search was on procedure.
"RTN","GMRCPSL2",96,0)
 K ^TMP("GMRCRPT",$J)
"RTN","GMRCPSL2",97,0)
 N GMRCCNTR,PROCEDUR,GMRCSRT1,GMRCSRT2,GMRCPRC1,GMRCPRC2,IEN,GMRCREM
"RTN","GMRCPSL2",98,0)
 S GMRCCNTR=0
"RTN","GMRCPSL2",99,0)
 ; get all Procedures by date range
"RTN","GMRCPSL2",100,0)
 I GMRCARRY(1)="ALL" D
"RTN","GMRCPSL2",101,0)
 .  S GMRCPRC1=GMRCDT1,GMRCPRC2=GMRCDT2
"RTN","GMRCPSL2",102,0)
 .  F  S GMRCPRC1=$O(^GMR(123,"E",GMRCPRC1)) Q:GMRCPRC1>GMRCPRC2  Q:GMRCPRC1=""  D
"RTN","GMRCPSL2",103,0)
 . .  S IEN=0
"RTN","GMRCPSL2",104,0)
 . .  F  S IEN=$O(^GMR(123,"E",GMRCPRC1,IEN)) Q:IEN'>0  D
"RTN","GMRCPSL2",105,0)
 . . .  I $$CKSTAT(IEN,GMRCSTAT) D        ; Ck Status
"RTN","GMRCPSL2",106,0)
 . . . .  I $P(^GMR(123,IEN,0),"^",8)>"" D              ; Ck for Proc
"RTN","GMRCPSL2",107,0)
 . . . . .  S PROCEDUR=$P($P(^GMR(123,IEN,0),"^",8),";",1)
"RTN","GMRCPSL2",108,0)
 . . . . .  S GMRCSRT1=$$GET1^DIQ(123.3,PROCEDUR,.01)   ;Procedure
"RTN","GMRCPSL2",109,0)
 . . . . .  S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)        ;Req Date
"RTN","GMRCPSL2",110,0)
 . . . . .  S GMRCREM=$P($G(^GMR(123,IEN,12)),"^",6)
"RTN","GMRCPSL2",111,0)
 . . . . .  S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)_"^"_GMRCREM
"RTN","GMRCPSL2",112,0)
 ; Get each procedure from GMRCARRY and then go to global using procedure
"RTN","GMRCPSL2",113,0)
 I GMRCARRY(1)="ALL" Q
"RTN","GMRCPSL2",114,0)
 F  S GMRCCNTR=$O(GMRCARRY(GMRCCNTR)) Q:'GMRCCNTR  D
"RTN","GMRCPSL2",115,0)
 .  S PROCEDUR=$P(GMRCARRY(GMRCCNTR),"^",1)
"RTN","GMRCPSL2",116,0)
 .  N IEN S IEN=0
"RTN","GMRCPSL2",117,0)
 .  F  S IEN=$O(^GMR(123,"AP",PROCEDUR_";GMR(123.3,",IEN)) Q:IEN'>0  D
"RTN","GMRCPSL2",118,0)
 . .  I $P(^GMR(123,IEN,0),"^",7)>GMRCDT1,$P(^GMR(123,IEN,0),"^",7)<GMRCDT2,$$CKSTAT(IEN,GMRCSTAT) D
"RTN","GMRCPSL2",119,0)
 . . . S GMRCSRT1=$P(GMRCARRY(GMRCCNTR),"^",2)   ; PROCEDURE TYPE
"RTN","GMRCPSL2",120,0)
 . . . S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)      ; DATE OF REQUEST
"RTN","GMRCPSL2",121,0)
 . . . S GMRCREM=$P($G(^GMR(123,IEN,12)),"^",6)
"RTN","GMRCPSL2",122,0)
 . . . S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)_"^"_GMRCREM
"RTN","GMRCPSL2",123,0)
 Q
"RTN","GMRCPSL2",124,0)
BLDPROV(GMRCARRY) ; Build ^TMP were search was on provider.
"RTN","GMRCPSL2",125,0)
 K ^TMP("GMRCRPT",$J)
"RTN","GMRCPSL2",126,0)
 N GMRCCNTR,PROVIDER,GMRCSRT1,GMRCSRT2,GMRCPRV1,GMRCPRV2,IEN
"RTN","GMRCPSL2",127,0)
 N GMRCPROV
"RTN","GMRCPSL2",128,0)
 S GMRCCNTR=0
"RTN","GMRCPSL2",129,0)
 ; get all providers by date range
"RTN","GMRCPSL2",130,0)
 I GMRCARRY(1)="ALL" D
"RTN","GMRCPSL2",131,0)
 .  S GMRCPRV1=GMRCDT1,GMRCPRV2=GMRCDT2
"RTN","GMRCPSL2",132,0)
 .  F  S GMRCPRV1=$O(^GMR(123,"E",GMRCPRV1)) Q:GMRCPRV1>GMRCPRV2  Q:GMRCPRV1=""  D
"RTN","GMRCPSL2",133,0)
 . .  S IEN=0
"RTN","GMRCPSL2",134,0)
 . .  F  S IEN=$O(^GMR(123,"E",GMRCPRV1,IEN)) Q:IEN'>0  D
"RTN","GMRCPSL2",135,0)
 . . .  ; Provider not null
"RTN","GMRCPSL2",136,0)
 . . .  I "LB"[GMRCARRY,$$CKSTAT(IEN,GMRCSTAT) D
"RTN","GMRCPSL2",137,0)
 . . . .  I +$P(^GMR(123,IEN,0),"^",14) D
"RTN","GMRCPSL2",138,0)
 . . . . .  S GMRCPROV=$P(^GMR(123,IEN,0),"^",14)      ; SENDING PROVIDER
"RTN","GMRCPSL2",139,0)
 . . . . .  S GMRCSRT1=$$GET1^DIQ(200,GMRCPROV,.01)    ; SENDING PROVIDER
"RTN","GMRCPSL2",140,0)
 . . . . .  S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)       ; DATE OF REQUEST
"RTN","GMRCPSL2",141,0)
 . . . . .  S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)
"RTN","GMRCPSL2",142,0)
 . . .  ; Provider null and REMOTE ORDERING PROVIDER not
"RTN","GMRCPSL2",143,0)
 . . .  I "RB"[GMRCARRY,$$CKSTAT(IEN,GMRCSTAT) D
"RTN","GMRCPSL2",144,0)
 . . . .  I '+$P(^GMR(123,IEN,0),"^",14),$P($G(^GMR(123,IEN,12)),"^",6)'="" D
"RTN","GMRCPSL2",145,0)
 . . . . .   S GMRCPROV=$P($G(^GMR(123,IEN,12)),"^",6)
"RTN","GMRCPSL2",146,0)
 . . . . .   S GMRCSRT1=GMRCPROV
"RTN","GMRCPSL2",147,0)
 . . . . .   S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)       ; DATE OF REQUEST
"RTN","GMRCPSL2",148,0)
 . . . . .   S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)_"^"_GMRCPROV
"RTN","GMRCPSL2",149,0)
 ; Get provider list from GMRCARRY and then go to global using provider
"RTN","GMRCPSL2",150,0)
 I GMRCARRY(1)="ALL" Q
"RTN","GMRCPSL2",151,0)
 F  S GMRCCNTR=$O(GMRCARRY(GMRCCNTR)) Q:'GMRCCNTR  D
"RTN","GMRCPSL2",152,0)
 .  S PROVIDER=$P(GMRCARRY(GMRCCNTR),"^",1)
"RTN","GMRCPSL2",153,0)
 . I "LB"[GMRCARRY,$P(GMRCARRY(GMRCCNTR),"^",3)=200 D
"RTN","GMRCPSL2",154,0)
 . .  S IEN=0
"RTN","GMRCPSL2",155,0)
 . .  F  S IEN=$O(^GMR(123,"G",PROVIDER,IEN)) Q:IEN'>0  D
"RTN","GMRCPSL2",156,0)
 . . .  I $P(^GMR(123,IEN,0),"^",7)>GMRCDT1,$P(^GMR(123,IEN,0),"^",7)<GMRCDT2,$$CKSTAT(IEN,GMRCSTAT) D
"RTN","GMRCPSL2",157,0)
 . . . . S GMRCSRT1=$P(GMRCARRY(GMRCCNTR),"^",2)   ; SENDING PROVIDER
"RTN","GMRCPSL2",158,0)
 . . . . S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)      ; DATE OF REQUEST
"RTN","GMRCPSL2",159,0)
 . . . . S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)
"RTN","GMRCPSL2",160,0)
 . I "RB"[GMRCARRY,'$P(GMRCARRY(GMRCCNTR),"^",2) D
"RTN","GMRCPSL2",161,0)
 . . S IEN=0
"RTN","GMRCPSL2",162,0)
 . . F  S IEN=$O(^GMR(123,"AIP",PROVIDER,IEN)) Q:IEN'>0  D
"RTN","GMRCPSL2",163,0)
 . . .  I $P(^GMR(123,IEN,0),"^",7)>GMRCDT1,$P(^GMR(123,IEN,0),"^",7)<GMRCDT2,$$CKSTAT(IEN,GMRCSTAT) D
"RTN","GMRCPSL2",164,0)
 . . . . S GMRCSRT1=$P(GMRCARRY(GMRCCNTR),"^",1)
"RTN","GMRCPSL2",165,0)
 . . . . S GMRCSRT2=$P(^GMR(123,IEN,0),"^",7)
"RTN","GMRCPSL2",166,0)
 . . . . S ^TMP("GMRCRPT",$J,GMRCSRT1,GMRCSRT2,IEN)=IEN_"|"_^GMR(123,IEN,0)_"^"_PROVIDER
"RTN","GMRCPSL2",167,0)
 Q
"RTN","GMRCPSL2",168,0)
CKSTAT(IEN,GMRCSTAT) ; Does entry have selected status
"RTN","GMRCPSL2",169,0)
 ; Input:
"RTN","GMRCPSL2",170,0)
 ;  IEN      = File #123 IEN
"RTN","GMRCPSL2",171,0)
 ;  GMRCSTAT = Selected status(es)
"RTN","GMRCPSL2",172,0)
 ; Output:
"RTN","GMRCPSL2",173,0)
 ;  GMRCKS   = Result (1:yes; 0:no)
"RTN","GMRCPSL2",174,0)
 N GMRCKS,GMRCS,LOOP,STATUS
"RTN","GMRCPSL2",175,0)
 S GMRCKS=0
"RTN","GMRCPSL2",176,0)
 S GMRCS=+$P(^GMR(123,IEN,0),"^",12)
"RTN","GMRCPSL2",177,0)
 F LOOP=1:1:$L(GMRCSTAT,",") S STATUS=$P(GMRCSTAT,",",LOOP) Q:GMRCKS  D
"RTN","GMRCPSL2",178,0)
 . I STATUS=GMRCS S GMRCKS=1
"RTN","GMRCPSL2",179,0)
 Q GMRCKS
"RTN","GMRCPSL3")
0^47^B66312673
"RTN","GMRCPSL3",1,0)
GMRCPSL3 ;SLC/MA - Special Consult Reports;9/21/01  05:25 ;1/17/02  18:19
"RTN","GMRCPSL3",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**23,22**;DEC 27, 1997
"RTN","GMRCPSL3",3,0)
 ; This routine is called by GMRCPSL2 to generate reports or
"RTN","GMRCPSL3",4,0)
 ; date output.
"RTN","GMRCPSL3",5,0)
 ; DBIA 10035 call DIQ=2     ;PATIENT FILE
"RTN","GMRCPSL3",6,0)
 ; DBIA 10040 call DIQ=44    ;LOCATION FILE
"RTN","GMRCPSL3",7,0)
 ; DBIA 10060 call DIQ=200   ;NEW PERSON FILE
"RTN","GMRCPSL3",8,0)
 ; GMRCDT1  = Start date
"RTN","GMRCPSL3",9,0)
 ; GMRCDT2  = Stop date
"RTN","GMRCPSL3",10,0)
 ; GMRCBRK  = Print page break between sub-totals <Y-N>
"RTN","GMRCPSL3",11,0)
 ; TOTCNTR  = Count for total records
"RTN","GMRCPSL3",12,0)
 ; DISPLINE = ^GMR(123,,0) + FORMATED 12 NODE
"RTN","GMRCPSL3",13,0)
REPORT32(SUBTOT,TOTCNTR,GMRCSRCH,GMRCBRK) ; Read ^TMP("GMRCRPT",$J) and format report
"RTN","GMRCPSL3",14,0)
 ; The ^TMP global can be in any order but it will always have 3
"RTN","GMRCPSL3",15,0)
 ; sorting parameters (PROVIDER,DATE,IEN) or (PT LOCATION,DATE,IEN)
"RTN","GMRCPSL3",16,0)
 ; or (PROCEDURE TYPE,DATE,IEN)
"RTN","GMRCPSL3",17,0)
 ; RPTTITL = Used to vary report title
"RTN","GMRCPSL3",18,0)
 ; SRTCOMP = Used to tell when to print subtotals
"RTN","GMRCPSL3",19,0)
 ; SUBTOT  = Used to count subtotals
"RTN","GMRCPSL3",20,0)
 N RPTTITL,SRTCOMP,GMRCQUIT
"RTN","GMRCPSL3",21,0)
 U IO
"RTN","GMRCPSL3",22,0)
 N IEN,SRT1,SRT2,SRT3,DISPLINE,LINECNT,PAGE,RPTTITL,SUBCOMP,GMRCFRST
"RTN","GMRCPSL3",23,0)
 S RPTTITL=$$RPTT(GMRCSRCH)
"RTN","GMRCPSL3",24,0)
 S (LINECNT,PAGE,SUBTOT,GMRCQUIT)=0,GMRCFRST=1
"RTN","GMRCPSL3",25,0)
 S SRT1="",SRTCOMP=""
"RTN","GMRCPSL3",26,0)
 ;  Sorted by GMRCSRCH & date.  First sort compare is just to watch
"RTN","GMRCPSL3",27,0)
 ;  for GMRCSRCH change to print sub-totals.
"RTN","GMRCPSL3",28,0)
 F  S SRT1=$O(^TMP("GMRCRPT",$J,SRT1)) Q:'$L(SRT1)  Q:GMRCQUIT  D
"RTN","GMRCPSL3",29,0)
 .  I SRTCOMP="" S SRTCOMP=SRT1
"RTN","GMRCPSL3",30,0)
 .  I SRTCOMP'=SRT1 D
"RTN","GMRCPSL3",31,0)
 . .  W !!,"SUB TOTAL= ",SUBTOT,!
"RTN","GMRCPSL3",32,0)
 . .  S LINECNT=LINECNT+3
"RTN","GMRCPSL3",33,0)
 . .  S SUBTOT=0
"RTN","GMRCPSL3",34,0)
 . .  I GMRCBRK D PAGEBK32
"RTN","GMRCPSL3",35,0)
 .  S SRT2=0
"RTN","GMRCPSL3",36,0)
 .  F  S SRT2=$O(^TMP("GMRCRPT",$J,SRT1,SRT2)) Q:'SRT2  Q:GMRCQUIT  D
"RTN","GMRCPSL3",37,0)
 . . S SRT3=0
"RTN","GMRCPSL3",38,0)
 . . F  S SRT3=$O(^TMP("GMRCRPT",$J,SRT1,SRT2,SRT3)) Q:'SRT3  Q:GMRCQUIT  D
"RTN","GMRCPSL3",39,0)
 . . .   S DISPLINE=^TMP("GMRCRPT",$J,SRT1,SRT2,SRT3)
"RTN","GMRCPSL3",40,0)
 . . .   I GMRCFRST D PAGEBK32           ;  Kick out first page header
"RTN","GMRCPSL3",41,0)
 . . .   I LINECNT>IOSL D PAGEBK32
"RTN","GMRCPSL3",42,0)
 . . .   I GMRCQUIT Q
"RTN","GMRCPSL3",43,0)
 . . .  ;
"RTN","GMRCPSL3",44,0)
 . . .  ; Start writing the print line
"RTN","GMRCPSL3",45,0)
 . . .   W !,$P(DISPLINE,"|",1)                    ;IEN
"RTN","GMRCPSL3",46,0)
 . . .   W ?11,$$FMTE^XLFDT($P(DISPLINE,"^",7),"D")   ;REQ DAT
"RTN","GMRCPSL3",47,0)
 . . .   ; If Provider not NULL, If IFC record Provider will be NULL
"RTN","GMRCPSL3",48,0)
 . . .   I GMRCSRCH=1 D
"RTN","GMRCPSL3",49,0)
 . . . .   I +$P(DISPLINE,"^",14) D
"RTN","GMRCPSL3",50,0)
 . . . . .   W ?25,$E($$GET1^DIQ(200,$P(DISPLINE,"^",14),.01),1,20) ;PROVIDER
"RTN","GMRCPSL3",51,0)
 . . . .   ; Provider Null and REMOTE ORDERING PROVIDER not, must be an IFC record 
"RTN","GMRCPSL3",52,0)
 . . . .   I '+$P(DISPLINE,"^",14),$P(DISPLINE,"^",24)'="" D
"RTN","GMRCPSL3",53,0)
 . . . . .   W ?25,$E($P(DISPLINE,"^",24),1,40)
"RTN","GMRCPSL3",54,0)
 . . . .   W ?48,$E($$GET1^DIQ(123.5,$P(DISPLINE,"^",5),.01),1,40)  ;TO SERVICE
"RTN","GMRCPSL3",55,0)
 . . .     I GMRCSRCH=2 D
"RTN","GMRCPSL3",56,0)
 . . . .     ; Location not null, if null then it is a IFC record
"RTN","GMRCPSL3",57,0)
 . . . .     I +$P(DISPLINE,"^",4) D
"RTN","GMRCPSL3",58,0)
 . . . . .     W ?25,$E($$GET1^DIQ(44,$P(DISPLINE,"^",4),.01),1,22)
"RTN","GMRCPSL3",59,0)
 . . . .     ; Location null and Ordering Facility not, IFC record
"RTN","GMRCPSL3",60,0)
 . . . .     I '+$P(DISPLINE,"^",4),+$P(DISPLINE,"^",21) D
"RTN","GMRCPSL3",61,0)
 . . . . .     W ?25,$E($$GET1^DIQ(4,$P(DISPLINE,"^",21),.01),1,22)
"RTN","GMRCPSL3",62,0)
 . . . .     ; Location null, Ordering Facility null, Routing Facility not
"RTN","GMRCPSL3",63,0)
 . . . .     ; meaning this is an IFC record
"RTN","GMRCPSL3",64,0)
 . . . .     I '+$P(DISPLINE,"^",4),'+$P(DISPLINE,"^",21),+$P(DISPLINE,"^",23) D
"RTN","GMRCPSL3",65,0)
 . . . . .     W ?25,$E($$GET1^DIQ(4,$P(DISPLINE,"^",23),.01),1,22)
"RTN","GMRCPSL3",66,0)
 . . . .     W ?48,$E($$GET1^DIQ(123.5,$P(DISPLINE,"^",5),.01),1,40)  ;TO SERVICE
"RTN","GMRCPSL3",67,0)
 . . .     I GMRCSRCH=3 D
"RTN","GMRCPSL3",68,0)
 . . . .     W ?25,$E($$GET1^DIQ(123.3,$P($P(DISPLINE,"^",8),";",1),.01),1,20) ;PROCEDURE
"RTN","GMRCPSL3",69,0)
 . . . .     W ?48,$E($$GET1^DIQ(123.5,$P(DISPLINE,"^",5),.01),1,40)  ;TO SERVICE
"RTN","GMRCPSL3",70,0)
 . . .     W ?89,$E($$GET1^DIQ(2,$P(DISPLINE,"^",2),.01),1,20)       ;PATIENT
"RTN","GMRCPSL3",71,0)
 . . .     W ?121,$E($$GET1^DIQ(2,$P(DISPLINE,"^",2),.09),6,9) ;SSN
"RTN","GMRCPSL3",72,0)
 . . .     W ?129,$$GET1^DIQ(100.01,$P(DISPLINE,"^",12),.1) ;STATUS
"RTN","GMRCPSL3",73,0)
 . . .     S LINECNT=LINECNT+1,TOTCNTR=TOTCNTR+1,SUBTOT=SUBTOT+1
"RTN","GMRCPSL3",74,0)
 Q
"RTN","GMRCPSL3",75,0)
 ;
"RTN","GMRCPSL3",76,0)
REPORT80(SUBTOT,TOTCNTR,GMRCSRCH,GMRCBRK)   ; Read ^TMP("GMRCRPT",$J) and format report
"RTN","GMRCPSL3",77,0)
 ; The ^TMP global can be in any order but it will always have 3
"RTN","GMRCPSL3",78,0)
 ; sorting parameters (PROVIDER,DATE,IEN) or (PT LOCATION,DATE,IEN)
"RTN","GMRCPSL3",79,0)
 ; or (PROCEDURE TYPE,DATE,IEN)
"RTN","GMRCPSL3",80,0)
 ; RPTTITL = Used to vary report title
"RTN","GMRCPSL3",81,0)
 ; SRTCOMP = Used to tell when to print subtotals
"RTN","GMRCPSL3",82,0)
 ; SUBTOT  = Used to count subtotals
"RTN","GMRCPSL3",83,0)
 ; GMRCFRST= Set to one to get first report headers to print
"RTN","GMRCPSL3",84,0)
 N RPTTITL,SRTCOMP,GMRCQUIT
"RTN","GMRCPSL3",85,0)
 U IO
"RTN","GMRCPSL3",86,0)
 N IEN,SRT1,SRT2,SRT3,DISPLINE,LINECNT,PAGE,RPTTITL,SUBCOMP,GMRCFRST
"RTN","GMRCPSL3",87,0)
 S RPTTITL=$$RPTT(GMRCSRCH)
"RTN","GMRCPSL3",88,0)
 S (LINECNT,PAGE,SUBTOT,GMRCQUIT)=0,GMRCFRST=1
"RTN","GMRCPSL3",89,0)
 S SRT1="",SRTCOMP=""
"RTN","GMRCPSL3",90,0)
 ;  Sorted by GMRCSRCH & date.  First sort compare is just to watch
"RTN","GMRCPSL3",91,0)
 ;  for GMRCSRCH change to print sub-totals.
"RTN","GMRCPSL3",92,0)
 F  S SRT1=$O(^TMP("GMRCRPT",$J,SRT1)) Q:'$L(SRT1)  Q:GMRCQUIT  D
"RTN","GMRCPSL3",93,0)
 .  I SRTCOMP="" S SRTCOMP=SRT1
"RTN","GMRCPSL3",94,0)
 .  I SRTCOMP'=SRT1 D
"RTN","GMRCPSL3",95,0)
 . .  I (LINECNT+3)>IOSL D PAGEBK80
"RTN","GMRCPSL3",96,0)
 . .  W !!,"SUB TOTAL= ",SUBTOT,!
"RTN","GMRCPSL3",97,0)
 . .  S LINECNT=LINECNT+3
"RTN","GMRCPSL3",98,0)
 . .  S SUBTOT=0
"RTN","GMRCPSL3",99,0)
 . .  I GMRCBRK D PAGEBK80
"RTN","GMRCPSL3",100,0)
 .  S SRT2=0
"RTN","GMRCPSL3",101,0)
 .  F  S SRT2=$O(^TMP("GMRCRPT",$J,SRT1,SRT2)) Q:'SRT2  Q:GMRCQUIT  D
"RTN","GMRCPSL3",102,0)
 . . S SRT3=0
"RTN","GMRCPSL3",103,0)
 . . F  S SRT3=$O(^TMP("GMRCRPT",$J,SRT1,SRT2,SRT3)) Q:'SRT3  Q:GMRCQUIT  D
"RTN","GMRCPSL3",104,0)
 . . .    S DISPLINE=^TMP("GMRCRPT",$J,SRT1,SRT2,SRT3)
"RTN","GMRCPSL3",105,0)
 . . .    I GMRCFRST=1 D PAGEBK80          ; Kick out first page header
"RTN","GMRCPSL3",106,0)
 . . .    I LINECNT>IOSL D PAGEBK80
"RTN","GMRCPSL3",107,0)
 . . .    I GMRCQUIT Q
"RTN","GMRCPSL3",108,0)
 . . .    ;
"RTN","GMRCPSL3",109,0)
 . . .    ; STARTING WRITING THE PRINT LINE
"RTN","GMRCPSL3",110,0)
 . . .    ;
"RTN","GMRCPSL3",111,0)
 . . .    W !,$P(DISPLINE,"|",1)                    ;IEN
"RTN","GMRCPSL3",112,0)
 . . .    W ?9,$P($$FMTE^XLFDT($P(DISPLINE,"^",7),2),"@",1)   ;REQ DATE
"RTN","GMRCPSL3",113,0)
 . . .    I GMRCSRCH=1 D
"RTN","GMRCPSL3",114,0)
 . . . .    ; Provider not null, If null then it is an IFC record
"RTN","GMRCPSL3",115,0)
 . . . .    I +$P(DISPLINE,"^",14) D
"RTN","GMRCPSL3",116,0)
 . . . . .    W ?18,$E($$GET1^DIQ(200,$P(DISPLINE,"^",14),.01),1,16) ;PROVIDER
"RTN","GMRCPSL3",117,0)
 . . . .    ; Provider null and REMOTE ORDERING PROVIDER  not, this is an IFC record
"RTN","GMRCPSL3",118,0)
 . . . .    I '+$P(DISPLINE,"^",14),$P(DISPLINE,"^",24)'="" D
"RTN","GMRCPSL3",119,0)
 . . . . .    W ?18,$E($P(DISPLINE,"^",24),1,16)
"RTN","GMRCPSL3",120,0)
 . . .    ; Location not null,  If null then it is an IFC record
"RTN","GMRCPSL3",121,0)
 . . .    I GMRCSRCH=2,+$P(DISPLINE,"^",4) D
"RTN","GMRCPSL3",122,0)
 . . . .    W ?18,$E($$GET1^DIQ(44,$P(DISPLINE,"^",4),.01),1,16)  ;LOCATION
"RTN","GMRCPSL3",123,0)
 . . . .  ; Location null meaning IFC record.  Use Ordering Facility
"RTN","GMRCPSL3",124,0)
 . . .    I GMRCSRCH=2,$P(DISPLINE,"^",4)="",+$P(DISPLINE,"^",21) D
"RTN","GMRCPSL3",125,0)
 . . . .    W ?18,$E($$GET1^DIQ(4,$P(DISPLINE,"^",21),.01),1,16) ;ORD FACILITY
"RTN","GMRCPSL3",126,0)
 . . .    ; Location null, Ordering Facility null, use Routing Facilty
"RTN","GMRCPSL3",127,0)
 . . .    ; Still an IFC record
"RTN","GMRCPSL3",128,0)
 . . .    I GMRCSRCH=2,$P(DISPLINE,"^",4)="",'$P(DISPLINE,"^",21) D
"RTN","GMRCPSL3",129,0)
 . . . .    I +$P(DISPLINE,"^",23) D
"RTN","GMRCPSL3",130,0)
 . . . . .    W ?18,$E($$GET1^DIQ(4,$P(DISPLINE,"^",23),.01),1,16) ;ROUTIN FACILITY
"RTN","GMRCPSL3",131,0)
 . . .    I GMRCSRCH=3 D
"RTN","GMRCPSL3",132,0)
 . . . .    W ?18,$E($$GET1^DIQ(123.3,$P($P(DISPLINE,"^",8),";",1),.01),1,16)   ; PROCEDURE
"RTN","GMRCPSL3",133,0)
 . . .    W ?35,$E($$GET1^DIQ(2,$P(DISPLINE,"^",2),.01),1,20)  ;PATIENT
"RTN","GMRCPSL3",134,0)
 . . .    W ?56,$E($$GET1^DIQ(2,$P(DISPLINE,"^",2),.09),6,9) ;SSN
"RTN","GMRCPSL3",135,0)
 . . .    W ?61,$E($$GET1^DIQ(123.5,$P(DISPLINE,"^",5),.01),1,15)  ;TO SERVICE
"RTN","GMRCPSL3",136,0)
 . . .    W ?77,$$GET1^DIQ(100.01,$P(DISPLINE,"^",12),.1) ;STATUS
"RTN","GMRCPSL3",137,0)
 . . .    S LINECNT=LINECNT+1,TOTCNTR=TOTCNTR+1,SUBTOT=SUBTOT+1
"RTN","GMRCPSL3",138,0)
 Q
"RTN","GMRCPSL3",139,0)
PAGEBK32 ;
"RTN","GMRCPSL3",140,0)
 S GMRCFRST=0
"RTN","GMRCPSL3",141,0)
 K DIR
"RTN","GMRCPSL3",142,0)
 I ($E(IOST)="C")&(IO=IO(0))&(PAGE>0) D
"RTN","GMRCPSL3",143,0)
 .S DIR(0)="E"
"RTN","GMRCPSL3",144,0)
 .W !
"RTN","GMRCPSL3",145,0)
 .D ^DIR K DIR
"RTN","GMRCPSL3",146,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)) S GMRCQUIT=1  Q
"RTN","GMRCPSL3",147,0)
 W:$D(IOF) @IOF
"RTN","GMRCPSL3",148,0)
 S PAGE=PAGE+1
"RTN","GMRCPSL3",149,0)
 I $E(IOST)="C",IO=IO(0) W @IOF
"RTN","GMRCPSL3",150,0)
 E  W !
"RTN","GMRCPSL3",151,0)
 N TEMPDATE,TEXTLEN,LINE
"RTN","GMRCPSL3",152,0)
 S TEMPDATE=$$NOW^XLFDT,TEMPDATE=$$FMTE^XLFDT(TEMPDATE,"P")
"RTN","GMRCPSL3",153,0)
 S TEMPDATE=TEMPDATE_"  Page "_PAGE
"RTN","GMRCPSL3",154,0)
 I GMRCSRCH=1,GMRCBRK D
"RTN","GMRCPSL3",155,0)
 . W !,?6,"ORDERING PROVIDER:  ",?26,SRT1
"RTN","GMRCPSL3",156,0)
 I GMRCSRCH=2,GMRCBRK D
"RTN","GMRCPSL3",157,0)
 . W !,?6,"LOCATION:  ",?12,SRT1,?45
"RTN","GMRCPSL3",158,0)
 I GMRCSRCH=3,GMRCBRK D
"RTN","GMRCPSL3",159,0)
 . W !,?6,"PROCEDURE:  ",?12,SRT1,?45
"RTN","GMRCPSL3",160,0)
 W !,"CONSULT LIST BY "_RPTTITL_", FOR SPECIFIED DATE(S)"
"RTN","GMRCPSL3",161,0)
 W ?97,TEMPDATE
"RTN","GMRCPSL3",162,0)
 I GMRCDT1>0 D
"RTN","GMRCPSL3",163,0)
 . W !,"FROM: ",$$FMTE^XLFDT(GMRCDT1,"D"),"   TO: ",$$FMTE^XLFDT(GMRCDT2-1,"D")
"RTN","GMRCPSL3",164,0)
 ELSE  W !,"FROM:  ALL","   TO:  ALL"
"RTN","GMRCPSL3",165,0)
 W ?121,"LAST 4",?128,"CON"
"RTN","GMRCPSL3",166,0)
 W !!,"CONSULT #",?11,"REQUEST DATE"
"RTN","GMRCPSL3",167,0)
 I GMRCSRCH=1 W ?26,"ORDERING PROVIDER",?48,"TO SERVICE"
"RTN","GMRCPSL3",168,0)
 I GMRCSRCH=2 W ?26,"FROM LOCATION",?48,"TO SERVICE"
"RTN","GMRCPSL3",169,0)
 I GMRCSRCH=3 W ?26,"PROCEDURE",?48,"ASSOCIATED CONSULT SERVICE"
"RTN","GMRCPSL3",170,0)
 W ?89,"PATIENT NAME",?121,"SSN",?128,"STAT"
"RTN","GMRCPSL3",171,0)
 S LINE="",$P(LINE,"-",132)=""
"RTN","GMRCPSL3",172,0)
 W !,LINE
"RTN","GMRCPSL3",173,0)
 S LINECNT=$S(GMRCBRK=1:8,1:7)
"RTN","GMRCPSL3",174,0)
 S LINECNT=9
"RTN","GMRCPSL3",175,0)
 Q
"RTN","GMRCPSL3",176,0)
PAGEBK80 ;
"RTN","GMRCPSL3",177,0)
 S GMRCFRST=0
"RTN","GMRCPSL3",178,0)
 K DIR
"RTN","GMRCPSL3",179,0)
 I ($E(IOST)="C")&(IO=IO(0))&(PAGE>0) D
"RTN","GMRCPSL3",180,0)
 .S DIR(0)="E"
"RTN","GMRCPSL3",181,0)
 .W !
"RTN","GMRCPSL3",182,0)
 .D ^DIR K DIR
"RTN","GMRCPSL3",183,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)) S GMRCQUIT=1  Q
"RTN","GMRCPSL3",184,0)
 W:$D(IOF) @IOF
"RTN","GMRCPSL3",185,0)
 S PAGE=PAGE+1
"RTN","GMRCPSL3",186,0)
 I $E(IOST)="C",IO=IO(0) W @IOF
"RTN","GMRCPSL3",187,0)
 E  W !
"RTN","GMRCPSL3",188,0)
 N TEMPDATE,TEXTLEN,LINE
"RTN","GMRCPSL3",189,0)
 S TEMPDATE=$$NOW^XLFDT,TEMPDATE=$$FMTE^XLFDT(TEMPDATE,"P")
"RTN","GMRCPSL3",190,0)
 S TEMPDATE=TEMPDATE_"  Page "_PAGE
"RTN","GMRCPSL3",191,0)
 I GMRCSRCH=1,GMRCBRK D
"RTN","GMRCPSL3",192,0)
 . W !,?6,"ORDERING PROVIDER:  ",?26,SRT1,?45,TEMPDATE
"RTN","GMRCPSL3",193,0)
 I GMRCSRCH=2,GMRCBRK D
"RTN","GMRCPSL3",194,0)
 . W !,?6,"LOCATION:  ",?12,SRT1,?45,TEMPDATE
"RTN","GMRCPSL3",195,0)
 I GMRCSRCH=3,GMRCBRK D
"RTN","GMRCPSL3",196,0)
 . W !,?6,"PROCEDURE:  ",?12,SRT1,?45,TEMPDATE
"RTN","GMRCPSL3",197,0)
 I 'GMRCBRK W !,?45,TEMPDATE
"RTN","GMRCPSL3",198,0)
 W !,"CONSULT LIST BY "_RPTTITL_", FOR SPECIFIED DATE(S)"
"RTN","GMRCPSL3",199,0)
 I GMRCDT1>0 D
"RTN","GMRCPSL3",200,0)
 . W !,"FROM: ",$$FMTE^XLFDT(GMRCDT1,"D"),"   TO: ",$$FMTE^XLFDT(GMRCDT2-1,"D")
"RTN","GMRCPSL3",201,0)
 ELSE  W !,"FROM:  ALL","   TO:  ALL"
"RTN","GMRCPSL3",202,0)
 W !!,"CONSULT",?9,"REQ DATE"
"RTN","GMRCPSL3",203,0)
 I GMRCSRCH=1 W ?18,"ORDERING PROVIDER"
"RTN","GMRCPSL3",204,0)
 I GMRCSRCH=2 W ?18,"LOCATION"
"RTN","GMRCPSL3",205,0)
 I GMRCSRCH=3 W ?18,"PROCEDURE"
"RTN","GMRCPSL3",206,0)
 W ?37,"PATIENT NAME",?56,"SSN",?61,"TO SERVICE",?77,"ST"
"RTN","GMRCPSL3",207,0)
 S LINE="",$P(LINE,"-",80)=""
"RTN","GMRCPSL3",208,0)
 W !,LINE
"RTN","GMRCPSL3",209,0)
 S LINECNT=9
"RTN","GMRCPSL3",210,0)
 Q
"RTN","GMRCPSL3",211,0)
RPTT(GMRCSRCH) ; Title
"RTN","GMRCPSL3",212,0)
 S RPTTITL=$S(GMRCSRCH=1:"PROVIDER(S)",GMRCSRCH=2:"LOCATION(S)",1:"PROCEDURE(S)")
"RTN","GMRCPSL3",213,0)
 I GMRCSRCH'=3 D
"RTN","GMRCPSL3",214,0)
 . S RPTTITL=RPTTITL_" - "_$S(GMRCARRY(1)="ALL":"ALL ",1:"SELECTED ")_$S(GMRCARRY="L":"LOCAL",GMRCARRY="R":"REMOTE",1:"LOCAL & REMOTE")
"RTN","GMRCPSL3",215,0)
 Q RPTTITL
"RTN","GMRCPSL4")
0^48^B6086417
"RTN","GMRCPSL4",1,0)
GMRCPSL4 ;SLC/MA - Special Consult Reports;1/10/02  14:27 ;1/17/02  18:20
"RTN","GMRCPSL4",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**23,22**;DEC 27, 1997
"RTN","GMRCPSL4",3,0)
 ; This routine is called by GMRCPSL2 to generate reports or
"RTN","GMRCPSL4",4,0)
 ; date output.
"RTN","GMRCPSL4",5,0)
 ; DBIA 10035 call DIQ=2     ;PATIENT FILE
"RTN","GMRCPSL4",6,0)
 ; DBIA 10040 call DIQ=44    ;LOCATION FILE
"RTN","GMRCPSL4",7,0)
 ; DBIA 10060 call DIQ=200   ;NEW PERSON FILE
"RTN","GMRCPSL4",8,0)
        ; DISPLINE = ^GMR(123,,0) + FORMATED 12 NODE
"RTN","GMRCPSL4",9,0)
DATAONLY ;  Write data only for user to capture
"RTN","GMRCPSL4",10,0)
 N SRT1,SRT2,SRT3,IEN,DISPLINE
"RTN","GMRCPSL4",11,0)
 ; DATA LINE = IEN^REQ DATE^PROVIDER^LOCATION^TO SERVICE^
"RTN","GMRCPSL4",12,0)
 ;             PATIENT^SSN^STATUS^PROCEDURE
"RTN","GMRCPSL4",13,0)
 S SRT1="",SRTCOMP=""
"RTN","GMRCPSL4",14,0)
 W !,"Consult#^Req Date^Ordering Provider^Location^"
"RTN","GMRCPSL4",15,0)
 W "To Service^Patient^SSN^Status^Procedure"
"RTN","GMRCPSL4",16,0)
 W !
"RTN","GMRCPSL4",17,0)
 F  S SRT1=$O(^TMP("GMRCRPT",$J,SRT1)) Q:'$L(SRT1)  D
"RTN","GMRCPSL4",18,0)
 .  S SRT2=0
"RTN","GMRCPSL4",19,0)
 .  F  S SRT2=$O(^TMP("GMRCRPT",$J,SRT1,SRT2)) Q:'SRT2  D
"RTN","GMRCPSL4",20,0)
 . . S SRT3=0
"RTN","GMRCPSL4",21,0)
 . . F  S SRT3=$O(^TMP("GMRCRPT",$J,SRT1,SRT2,SRT3)) Q:'SRT3  D
"RTN","GMRCPSL4",22,0)
 . . .   S DISPLINE=^TMP("GMRCRPT",$J,SRT1,SRT2,SRT3)
"RTN","GMRCPSL4",23,0)
 . . .   D DATAMOVE
"RTN","GMRCPSL4",24,0)
 Q
"RTN","GMRCPSL4",25,0)
DATAMOVE ; Create the DATA ONLY OUTPUT
"RTN","GMRCPSL4",26,0)
 N DATALINE
"RTN","GMRCPSL4",27,0)
 S $P(DATALINE,"^",1)=$P(DISPLINE,"|",1)                      ;IEN
"RTN","GMRCPSL4",28,0)
 S $P(DATALINE,"^",2)=$$FMTE^XLFDT($P(DISPLINE,"^",7),"D")    ;REQ Date
"RTN","GMRCPSL4",29,0)
 ; Provider not Null.  If null the must be an IFC record
"RTN","GMRCPSL4",30,0)
 I +$P(DISPLINE,"^",14) D
"RTN","GMRCPSL4",31,0)
 .  S $P(DATALINE,"^",3)=$$GET1^DIQ(200,$P(DISPLINE,"^",14),.01) ;PROVIDER
"RTN","GMRCPSL4",32,0)
 ; Provider Null, REMOTE ORDERING PROVIDER not.  IFC record
"RTN","GMRCPSL4",33,0)
 I '+$P(DISPLINE,"^",14),$P(DISPLINE,"^",24)'="" D
"RTN","GMRCPSL4",34,0)
 .  S $P(DATALINE,"^",3)=$P(DISPLINE,"^",24)                    ;PROVIDER
"RTN","GMRCPSL4",35,0)
 ;
"RTN","GMRCPSL4",36,0)
 ; Patient location not null.  If null then must be an IFC record
"RTN","GMRCPSL4",37,0)
 I +$P(DISPLINE,"^",4) D
"RTN","GMRCPSL4",38,0)
 . S $P(DATALINE,"^",4)=$$GET1^DIQ(44,$P(DISPLINE,"^",4),.01)
"RTN","GMRCPSL4",39,0)
 ;
"RTN","GMRCPSL4",40,0)
 ; Patient Location null, Ordering Facility not.  IFC record
"RTN","GMRCPSL4",41,0)
 I '+$P(DISPLINE,"^",4),+$P(DISPLINE,"^",21) D
"RTN","GMRCPSL4",42,0)
 . S $P(DATALINE,"^",4)=$$GET1^DIQ(4,$P(DISPLINE,"^",21),.01)
"RTN","GMRCPSL4",43,0)
 ;
"RTN","GMRCPSL4",44,0)
 ; Patient Location null, Ordering Facility null, Routing Facility not
"RTN","GMRCPSL4",45,0)
 ; IFC record
"RTN","GMRCPSL4",46,0)
 I '+$P(DISPLINE,"^",4),'+$P(DISPLINE,"^",21),+$P(DISPLINE,"^",23) D
"RTN","GMRCPSL4",47,0)
 . S $P(DATALINE,"^",4)=$$GET1^DIQ(4,$P(DISPLINE,"^",23),.01)
"RTN","GMRCPSL4",48,0)
 ;
"RTN","GMRCPSL4",49,0)
 S $P(DATALINE,"^",5)=$$GET1^DIQ(123.5,$P(DISPLINE,"^",5),.01) ;TO SERVICE
"RTN","GMRCPSL4",50,0)
 S $P(DATALINE,"^",6)=$$GET1^DIQ(2,$P(DISPLINE,"^",2),.01)     ;PATIENT
"RTN","GMRCPSL4",51,0)
 S $P(DATALINE,"^",7)=$E($$GET1^DIQ(2,$P(DISPLINE,"^",2),.09),6,10) ;SSN
"RTN","GMRCPSL4",52,0)
 S $P(DATALINE,"^",8)=$$GET1^DIQ(100.01,$P(DISPLINE,"^",12),.1)   ;STATUS
"RTN","GMRCPSL4",53,0)
 I $P(DISPLINE,"^",8)>"" D
"RTN","GMRCPSL4",54,0)
 . S $P(DATALINE,"^",9)=$$GET1^DIQ(123.3,$P($P(DISPLINE,"^",8),";",1),.01)  ;PROCEDURE
"RTN","GMRCPSL4",55,0)
 W !,DATALINE
"RTN","GMRCPSL4",56,0)
 Q
"RTN","GMRCQC")
0^53^B2459309
"RTN","GMRCQC",1,0)
GMRCQC ;SLC/DCM - GMRC List Manager routine to print Consults pending resolution for QC purposes ;5/20/98  14:20
"RTN","GMRCQC",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,22**;DEC 27, 1997
"RTN","GMRCQC",3,0)
EN ; -- main entry point for GMRC QC CON PENDING RESOLUTION
"RTN","GMRCQC",4,0)
 K GMRCQUT
"RTN","GMRCQC",5,0)
 S DIC="^GMR(123.5,",DIC(0)="AEMQ",DIC("A")="Select Service/Specialty: "
"RTN","GMRCQC",6,0)
 S DIC("S")="I $P(^(0),U,2)'=9",D="B^D"
"RTN","GMRCQC",7,0)
 D MIX^DIC1 K DIC
"RTN","GMRCQC",8,0)
 I $S(Y<1:1,$D(DUOUT):1,$D(DTOUT):1,1:0) D  Q
"RTN","GMRCQC",9,0)
 . S (GMRCQIT,GMRCQUT)=1 K DUOUT,DTOUT,DIROUT Q
"RTN","GMRCQC",10,0)
 S (GMRCSVCP,GMRCSVC)=$P(Y,"^",2),GMRCSVCN=+Y
"RTN","GMRCQC",11,0)
 D EN^VALM("GMRC QC CON PENDING RESOLUTION")
"RTN","GMRCQC",12,0)
 Q
"RTN","GMRCQC",13,0)
 ;
"RTN","GMRCQC",14,0)
HDR ; -- header code
"RTN","GMRCQC",15,0)
 S VALMHDR(1)="CONSULTS/REQUESTS PENDING RESOLUTION"
"RTN","GMRCQC",16,0)
 S VALMHDR(2)="Service: "_GMRCSVCP
"RTN","GMRCQC",17,0)
 Q
"RTN","GMRCQC",18,0)
 ;
"RTN","GMRCQC",19,0)
INIT ; -- init variables and list array
"RTN","GMRCQC",20,0)
 K ^TMP("GMRCR",$J,"QCLIST")
"RTN","GMRCQC",21,0)
 S DSPLINE=0,VALMAR="^TMP(""GMRCR"",$J,""QCLIST"")"
"RTN","GMRCQC",22,0)
 F LINE=1:1:GMRCCT S DSPLINE=$O(^TMP("GMRCR",$J,"CP",DSPLINE)) Q:DSPLINE=""!(DSPLINE?1A.E)  S DATA=^(DSPLINE,0) D SET^VALM10(LINE,DATA)
"RTN","GMRCQC",23,0)
 S VALMCNT=GMRCCT,VALMBCK="R"
"RTN","GMRCQC",24,0)
 K DATA,DSPLINE,LINE
"RTN","GMRCQC",25,0)
 Q
"RTN","GMRCQC",26,0)
 ;
"RTN","GMRCQC",27,0)
HELP ; -- help code
"RTN","GMRCQC",28,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","GMRCQC",29,0)
 Q
"RTN","GMRCQC",30,0)
 ;
"RTN","GMRCQC",31,0)
EXIT ; -- exit code
"RTN","GMRCQC",32,0)
 K ^TMP("GMRCR",$J,"CP"),^TMP("GMRCR",$J,"QCLIST")
"RTN","GMRCQC",33,0)
 K GMRCCT,GMRCSVCP,GMRCQUT,GMRCSVTT
"RTN","GMRCQC",34,0)
 Q
"RTN","GMRCQC",35,0)
 ;
"RTN","GMRCQC",36,0)
EXPND ; -- expand code
"RTN","GMRCQC",37,0)
 Q
"RTN","GMRCQC",38,0)
 ;
"RTN","GMRCQCST")
0^54^B26009200
"RTN","GMRCQCST",1,0)
GMRCQCST ;SLC/DCM - Gather all consults for QC that do not have status of discontinued,complete, or expired ;5/21/98  10:53
"RTN","GMRCQCST",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,22**;DEC 27, 1997
"RTN","GMRCQCST",3,0)
STS(SRV) ;;Set partial statistics into the ^TMP global for printing
"RTN","GMRCQCST",4,0)
 ;;SRV=Service being worked on
"RTN","GMRCQCST",5,0)
 ;;STS=OERR status of order (3=hold, 4=flagged, 5=pending, etc.)
"RTN","GMRCQCST",6,0)
 S GMRCTOTS=0
"RTN","GMRCQCST",7,0)
 I GMRCSVCP'="ALL SERVICES" S ^TMP("GMRCR",$J,"CP",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCQCST",8,0)
 F K=3,4,5,6,7,8,9,11,99 I $G(GMRCTOT(SRV,K))>0 D
"RTN","GMRCQCST",9,0)
 .S ^TMP("GMRCR",$J,"CP",GMRCCT,0)="Consults "_$S(K=3:"On Hold:    ",K=4:"Flagged:    ",K=5:"Pending:    ",K=6:"Active:     ",K=7:"Expired:    ",K=8:"Scheduled:  ",K=9:"Incomplete: ",K=11:"Unreleased: ",1:"No Status:  ")
"RTN","GMRCQCST",10,0)
 .S ^TMP("GMRCR",$J,"CP",GMRCCT,0)=^TMP("GMRCR",$J,"CP",GMRCCT,0)_$J(GMRCTOT(SRV,K),4,0),GMRCCT=GMRCCT+1,GMRCTOTS=GMRCTOTS+GMRCTOT(SRV,K)
"RTN","GMRCQCST",11,0)
 .Q
"RTN","GMRCQCST",12,0)
 S ^TMP("GMRCR",$J,"CP",GMRCCT,0)="Totals for Service:  "_$J(GMRCTOTS,4,0),GMRCCT=GMRCCT+1,^TMP("GMRCR",$J,"CP",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCQCST",13,0)
 Q
"RTN","GMRCQCST",14,0)
EN ;Use fileman to get service
"RTN","GMRCQCST",15,0)
 K GMRCQUT
"RTN","GMRCQCST",16,0)
 S DIC="^GMR(123.5,",DIC(0)="AEMQ",DIC("A")="Select Service/Specialty: "
"RTN","GMRCQCST",17,0)
 S DIC("S")="I $P(^(0),U,2)'=9",D="B^D"
"RTN","GMRCQCST",18,0)
 D MIX^DIC1 K DIC I Y<1!($D(DUOUT)) S GMRCQUT=1 K DIROUT,DUOUT,DTOUT Q
"RTN","GMRCQCST",19,0)
 S (GMRCSVCP,GMRCSVC)=$P(Y,"^",2),GMRCSVCN=+Y
"RTN","GMRCQCST",20,0)
EN1 ;Collect all consults for service chosen, excluding status discontinued
"RTN","GMRCQCST",21,0)
 K ^TMP("GMRCR",$J,"CP")
"RTN","GMRCQCST",22,0)
 S TAB="",$P(TAB," ",30)="",GMRCCT=1,GMRCSND=GMRCSVC,GMRCTOT=0,GMRCTOT(3)=0,GMRCTOT(4)=0,GMRCTOT(5)=0,GMRCTOT(6)=0,GMRCTOT(7)=0,GMRCTOT(8)=0,GMRCTOT(9)=0,GMRCTOT(11)=0,GMRCTOT(99)=0
"RTN","GMRCQCST",23,0)
 S GMRCSVTT=0
"RTN","GMRCQCST",24,0)
 I "ALL SERVICES"[GMRCSVC F  S GMRCSVC=$O(^GMR(123.5,"B",GMRCSVC)) Q:GMRCSVC=""  S GMRCSVCN=0,GMRCSVCN=$O(^GMR(123.5,"B",GMRCSVC,GMRCSVCN)) I $P(^GMR(123.5,GMRCSVCN,0),"^",2)'=9 D  D STS(GMRCSVCN)
"RTN","GMRCQCST",25,0)
 .S ^TMP("GMRCR",$J,"CP",GMRCCT,0)="SERVICE: "_$P(^GMR(123.5,GMRCSVCN,0),"^",1),GMRCCT=GMRCCT+1 D PROC(GMRCSVCN) S ^TMP("GMRCR",$J,"CP",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCQCST",26,0)
 .Q
"RTN","GMRCQCST",27,0)
 I "ALL SERVICES"'[GMRCSVC S ^TMP("GMRCR",$J,"CP",GMRCCT,0)="SERVICE: "_GMRCSVC,GMRCCT=GMRCCT+1 D PROC(GMRCSVCN),STS(GMRCSVCN) D KILL S GMRCCT=GMRCCT-1 Q
"RTN","GMRCQCST",28,0)
 S ^TMP("GMRCR",$J,"CP",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCQCST",29,0)
 S ^TMP("GMRCR",$J,"CP",GMRCCT,0)="SUMMARY STATISTICS (ALL SERVICES)",GMRCCT=GMRCCT+1 D
"RTN","GMRCQCST",30,0)
 .F I=3,4,5,6,7,8,9,11,99 I GMRCTOT(I)>0 S ^TMP("GMRCR",$J,"CP",GMRCCT,0)="Total Consults/Requests " D
"RTN","GMRCQCST",31,0)
 ..S ^TMP("GMRCR",$J,"CP",GMRCCT,0)=^TMP("GMRCR",$J,"CP",GMRCCT,0)_$S(I=3:"On Hold:     ",I=4:"Flagged:    ",I=5:"Pending:    ",I=6:"Active:     ",I=7:"Expired:    ",I=8:"Scheduled:  ",I=9:"Incomplete: ",I=11:"Unreleased: ",1:"No Status:  ")
"RTN","GMRCQCST",32,0)
 ..S ^TMP("GMRCR",$J,"CP",GMRCCT,0)=^TMP("GMRCR",$J,"CP",GMRCCT,0)_$J(GMRCTOT(I),4,0),GMRCCT=GMRCCT+1
"RTN","GMRCQCST",33,0)
 ..Q
"RTN","GMRCQCST",34,0)
 .Q
"RTN","GMRCQCST",35,0)
 S ^TMP("GMRCR",$J,"CP",GMRCCT,0)="Total Pending Resolution For All Services: "_GMRCTOT,GMRCCT=GMRCCT+1,^TMP("GMRCR",$J,"CP",GMRCCT,0)=""
"RTN","GMRCQCST",36,0)
 S GMRCCT=GMRCCT-1
"RTN","GMRCQCST",37,0)
 D KILL
"RTN","GMRCQCST",38,0)
 Q
"RTN","GMRCQCST",39,0)
PROC(GMRCSRV) ;Set status' info into the ^TMP global
"RTN","GMRCQCST",40,0)
 F I=3,4,5,6,7,8,9,11,99 S GMRCXDT=0,GMRCTOT(GMRCSRV,I)=0 F  S GMRCXDT=$O(^GMR(123,"AE",GMRCSRV,I,GMRCXDT)) Q:GMRCXDT=""  D
"RTN","GMRCQCST",41,0)
 .S GMRCPT=0 F  S GMRCPT=$O(^GMR(123,"AE",GMRCSRV,I,GMRCXDT,GMRCPT)) Q:GMRCPT=""  D  S GMRCTOT=GMRCTOT+1,GMRCTOT(I)=GMRCTOT(I)+1,GMRCTOT(GMRCSRV,I)=GMRCTOT(GMRCSRV,I)+1
"RTN","GMRCQCST",42,0)
 ..S X=9999999-GMRCXDT D REGDTM^GMRCU S GMRCDT=$P(X," ",1)
"RTN","GMRCQCST",43,0)
 ..S GMRCDLA=$P(X," ",1),GMRCD(0)=^GMR(123,GMRCPT,0) S GMRCPTN=$P(^DPT($P(GMRCD(0),"^",2),0),"^",1),GMRCPTN=$P(GMRCPTN,",",1)_","_$E($P(GMRCPTN,",",2),1)_".",GMRCPTSN="("_$E($P(^(0),"^",9),6,9)_")"
"RTN","GMRCQCST",44,0)
 ..S GMRCD=0,GMRCD=$O(^GMR(123,GMRCPT,40,"B",GMRCD)) I GMRCD]"" S GMRCDA="",GMRCDA=$O(^GMR(123,+GMRCPT,40,"B",GMRCD,GMRCDA)) I GMRCDA]"" S GMRCDA(0)=^GMR(123,GMRCPT,40,GMRCDA,0) D
"RTN","GMRCQCST",45,0)
 ...S GMRCDLA=$E($P($G(^GMR(123.1,$P(GMRCDA(0),"^",2),0)),"^"),1,20)
"RTN","GMRCQCST",46,0)
 ...Q
"RTN","GMRCQCST",47,0)
 ..S GMRCLOC=$P(GMRCD(0),"^",4) S:+GMRCLOC GMRCLOC=$P(^SC(GMRCLOC,0),"^",1)
"RTN","GMRCQCST",48,0)
 ..S STS=$S(I=1:"Discontinued",I=3:"Hold",I=4:"Flagged",I=5:"Pending",I=6:"Active",I=7:"Expired",I=11:"Unreleased",1:"No Status")
"RTN","GMRCQCST",49,0)
 ..S ^TMP("GMRCR",$J,"CP",GMRCCT,0)=STS_$E(TAB,1,10-$L(STS)+1)_GMRCDLA_$E(TAB,1,18-$L(GMRCDLA))_GMRCDT_" "_GMRCPTN_" "_GMRCPTSN_$E(TAB,1,10-$L(GMRCPTN)+5)_GMRCLOC,GMRCCT=GMRCCT+1
"RTN","GMRCQCST",50,0)
 ..Q
"RTN","GMRCQCST",51,0)
 .Q
"RTN","GMRCQCST",52,0)
 Q
"RTN","GMRCQCST",53,0)
KILL ;Kill all variables
"RTN","GMRCQCST",54,0)
 K I,K,Y,STS,TAB,GMRCT,GMRCD,GMRCDA,GMRCDT,GMRCPT,GMRCND,GMRCDLA,GMRCTM,GMRCBM,GMRCPTN,GMRCTOT,GMRCTOTS,GMRCPTSN,GMRCSND,GMRCSVC,GMRCSRV,GMRCSVCN,GMRCLOC,GMRCSVCN,GMRCXDT Q
"RTN","GMRCQCST",55,0)
 Q
"RTN","GMRCSLM")
0^50^B38790135
"RTN","GMRCSLM",1,0)
GMRCSLM ;SLC/DCM,JFR - List Mgr routine for consult tracking list ;9/8/99 14:52
"RTN","GMRCSLM",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,14,12,22**;DEC 27, 1997
"RTN","GMRCSLM",3,0)
EN ; -- main entry point for GMRC CONSULT TRACKING
"RTN","GMRCSLM",4,0)
 K GMRCOER
"RTN","GMRCSLM",5,0)
 S GMRCEN=1 K GMRCQUT
"RTN","GMRCSLM",6,0)
 ;IF Consults
"RTN","GMRCSLM",7,0)
 I $D(GMRCIS) D  I $D(GMRCQUT) K GMRCEN,GMRCIS,GMRCQUT Q
"RTN","GMRCSLM",8,0)
 .N DIR,DIRUT,DTOUT,DUOUT,Y
"RTN","GMRCSLM",9,0)
 .S DIR(0)="SB^R:REQUESTING;C:CONSULTING"
"RTN","GMRCSLM",10,0)
 .S DIR("A")="Are you the Requesting site or the Consulting site"
"RTN","GMRCSLM",11,0)
 .D ^DIR I $D(DIRUT) S GMRCQUT=1 Q
"RTN","GMRCSLM",12,0)
 .S GMRCIS=Y
"RTN","GMRCSLM",13,0)
 D SP K GMRCEN I $D(GMRCQUT) K GMRCQUT Q
"RTN","GMRCSLM",14,0)
 D EN^VALM("GMRC CONSULT TRACKING")
"RTN","GMRCSLM",15,0)
 Q
"RTN","GMRCSLM",16,0)
 ;
"RTN","GMRCSLM",17,0)
HDR ; -- header code
"RTN","GMRCSLM",18,0)
 ;override title if IF Consults
"RTN","GMRCSLM",19,0)
 I $D(GMRCIS) S VALM("TITLE")="IFC Requests: "_$S(GMRCIS="R":"Requesting",1:"Consulting")_" Site"
"RTN","GMRCSLM",20,0)
 D HDR1 ;format line 1 of header
"RTN","GMRCSLM",21,0)
 D:$L(GMRCWT) HDR2("")
"RTN","GMRCSLM",22,0)
 Q
"RTN","GMRCSLM",23,0)
 ;
"RTN","GMRCSLM",24,0)
HDR1 ;format VALMHDR(1) with patient information
"RTN","GMRCSLM",25,0)
 N GMRCX,GMRCX1,GMRCX2,GMRCX3,TIUCWAD,GMRVSTR,X
"RTN","GMRCSLM",26,0)
 ;Expects DFN
"RTN","GMRCSLM",27,0)
 S GMRVSTR="WT" D EN6^GMRVUTL
"RTN","GMRCSLM",28,0)
 S GMRCWT="Wt.(lb): "_$S($L($P(X,U,8)):$P(X,U,8),1:"No Entry")
"RTN","GMRCSLM",29,0)
 D DEM^GMRCU ;returns GMRCPNM,GMRCSN,GMRCAGE,SEX,GMRCWARD,GMRCRB,GMRCDOB,GMRCWLI
"RTN","GMRCSLM",30,0)
 S GMRCX1=GMRCPNM_"   "_GMRCSN
"RTN","GMRCSLM",31,0)
 ;
"RTN","GMRCSLM",32,0)
 S GMRCLOC=+$G(^DIC(42,+GMRCWLI,44))_";SC(" I 'GMRCLOC,'$D(XQAID) S GMRCLOC=""
"RTN","GMRCSLM",33,0)
 S GMRCX2="" I +$G(GMRCLOC) D
"RTN","GMRCSLM",34,0)
 . N L S L=$G(^SC(+GMRCLOC,0)),GMRCX2=$P(L,U,2)
"RTN","GMRCSLM",35,0)
 . S:'$L(GMRCX2) GMRCX2=$E($P(L,U),1,4)
"RTN","GMRCSLM",36,0)
 S:$L($G(GMRCRB)) GMRCX2=GMRCX2_"/"_GMRCRB
"RTN","GMRCSLM",37,0)
 ;
"RTN","GMRCSLM",38,0)
 S GMRCX=GMRCX1_$J(GMRCX2,40+($L(GMRCX2)\2)-$L(GMRCX1))
"RTN","GMRCSLM",39,0)
 S GMRCX3=" "_GMRCDOB_" ("_GMRCAGE_")"
"RTN","GMRCSLM",40,0)
 S TIUCWAD=$$CWAD^ORQPT2(+DFN) S:TIUCWAD]"" GMRCX3=GMRCX3_"   <"_TIUCWAD_">"
"RTN","GMRCSLM",41,0)
 S VALMHDR(1)=GMRCX_$J(GMRCX3,79-$L(GMRCX))
"RTN","GMRCSLM",42,0)
 K VALMHDR(2)
"RTN","GMRCSLM",43,0)
 Q
"RTN","GMRCSLM",44,0)
HDR2(GMRCX) ;format VALMHDR(2) with patient weight
"RTN","GMRCSLM",45,0)
 S VALMHDR(2)=$G(GMRCX)_$J($G(GMRCWT),79-$L($G(GMRCX)))
"RTN","GMRCSLM",46,0)
 Q
"RTN","GMRCSLM",47,0)
 ;
"RTN","GMRCSLM",48,0)
INIT ; -- init variables and list array
"RTN","GMRCSLM",49,0)
 K ^TMP("GMRCR",$J,"LIST")
"RTN","GMRCSLM",50,0)
 S DSPLINE=0,DATA="",VALMAR="^TMP(""GMRCR"",$J,""LIST"")"
"RTN","GMRCSLM",51,0)
 F LINE=1:1:LNCT S DSPLINE=$O(^TMP("GMRCR",$J,"CS",DSPLINE)) Q:DSPLINE=""!(DSPLINE?1A.E)  S DATA=^(DSPLINE,0) D SET^VALM10(LINE,DATA)
"RTN","GMRCSLM",52,0)
 S VALMCNT=LNCT,VALMPGE=1,XQORM("A")="Select Action: "
"RTN","GMRCSLM",53,0)
 K DSPLINE,DATA,LINE
"RTN","GMRCSLM",54,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCSLM",55,0)
 Q
"RTN","GMRCSLM",56,0)
 ;
"RTN","GMRCSLM",57,0)
HELP ; -- help code
"RTN","GMRCSLM",58,0)
 N X,DX,DY D FULL^VALM1
"RTN","GMRCSLM",59,0)
 W !!,"Enter the display number of the item you wish to act on, or select an action."
"RTN","GMRCSLM",60,0)
 W !!,"If you'd like another view of the consults, enter CV."
"RTN","GMRCSLM",61,0)
 W !!,"Status key:",!?5,"'a' - active",?27,"'c' - complete",?50,"'dc' - discontinued",!?5,"'p' - pending",?27,"'x' - cancelled",?50,"'pr' - partial results",!?5,"'s' - scheduled",?27,"'e' - expired"
"RTN","GMRCSLM",62,0)
 W !!,"Enter ?? to see a list of actions available for navigating the list."
"RTN","GMRCSLM",63,0)
 W !!,"Press <return> to continue ..." R X:DTIME
"RTN","GMRCSLM",64,0)
 S VALMBCK="R"
"RTN","GMRCSLM",65,0)
 ; S VALMSG=$$MSG
"RTN","GMRCSLM",66,0)
 S (DX,DY)=0 X ^%ZOSF("XY")
"RTN","GMRCSLM",67,0)
 D EXIT^GMRCSLMA("R")
"RTN","GMRCSLM",68,0)
 Q
"RTN","GMRCSLM",69,0)
 ;
"RTN","GMRCSLM",70,0)
EXIT ; -- exit code
"RTN","GMRCSLM",71,0)
 K ^TMP("GMRCR",$J,"LIST")
"RTN","GMRCSLM",72,0)
 K VALMCNT,VALMBCK,VALMPGE
"RTN","GMRCSLM",73,0)
 D ^GMRCREXT
"RTN","GMRCSLM",74,0)
 Q
"RTN","GMRCSLM",75,0)
 ;
"RTN","GMRCSLM",76,0)
PHYEN ;Entry Point When Provider's service is known and only needs to look at consults for that service
"RTN","GMRCSLM",77,0)
 Q:'$D(DUZ)  Q:'$D(^VA(200,DUZ,5))  Q:'$L(^VA(200,DUZ,5))
"RTN","GMRCSLM",78,0)
 S DIC="^DIC(49,",DIC(0)="MNO",X=^VA(200,DUZ,5) D ^DIC K DIC S GMRCSSNM=$S($L($P(Y,"^",2)):$P(Y,"^",2),1:"") I $L(GMRCSSNM) S GMRCSS=$O(^GMR(123.5,"B",GMRCSSNM,0))
"RTN","GMRCSLM",79,0)
 S GMRCFL=1 D SP I $D(GMRCQUT),GMRCQUT=1 Q
"RTN","GMRCSLM",80,0)
 D SPD I $D(GMRCQUT) D END,EXIT Q
"RTN","GMRCSLM",81,0)
 K GMRCFL
"RTN","GMRCSLM",82,0)
 D AD^GMRCSLM1
"RTN","GMRCSLM",83,0)
 I GMRCSSNM'["MEDICINE" D EN^VALM("GMRC CONSULT TRACKING"),END,EXIT Q
"RTN","GMRCSLM",84,0)
 D EN^VALM("GMRC TRK MEDICINE CONSULTS"),END,EXIT Q
"RTN","GMRCSLM",85,0)
 Q
"RTN","GMRCSLM",86,0)
SP ;;Select a new patient and return DFN and GMRCSSNM to display consults and requested Service.
"RTN","GMRCSLM",87,0)
 I $D(VALM) D FULL^VALM1
"RTN","GMRCSLM",88,0)
 K GMRCQUT S GMRCDFN1=$S($D(DFN):DFN,1:0)
"RTN","GMRCSLM",89,0)
 D SELPT^GMRCS I $S($D(GMRCQUT):1,'$D(DFN):1,1:0) S GMRCQUT=1,DFN=GMRCDFN1 G SPK
"RTN","GMRCSLM",90,0)
 I $D(Y),Y<0&(X["^") S GMRCQUT=1 G SPK
"RTN","GMRCSLM",91,0)
 I $D(Y),Y<0 S DFN=GMRCDFN1 S GMRCQUT=1 G SPK
"RTN","GMRCSLM",92,0)
 I $D(GMRC("NMBR")) D RESET^GMRCSLMV(GMRC("NMBR")) K GMRC("NMBR")
"RTN","GMRCSLM",93,0)
 S GMRCWRD=GMRCWARD
"RTN","GMRCSLM",94,0)
 I $D(GMRCFL) D SPK Q
"RTN","GMRCSLM",95,0)
 D ASRV^GMRCASV I $S($D(GMRCQUT):1,$D(DTOUT):1,$D(DUOUT):1,1:0) K DTOUT,DIROUT,DUOUT S (GMRCQUT,GMRCQIT)=1 Q
"RTN","GMRCSLM",96,0)
 S GMRCSS=GMRCDG,GMRCSSNM=$P(^GMR(123.5,GMRCSS,0),"^",1) S GMRCSTCK=""
"RTN","GMRCSLM",97,0)
 D EN^GMRCMENU
"RTN","GMRCSLM",98,0)
SPD ;Enter a date range for serching consults;  null entry selects all consults and does not exclude by date
"RTN","GMRCSLM",99,0)
 D ^GMRCSPD Q:$D(GMRCQUT)
"RTN","GMRCSLM",100,0)
 I $D(GMRCEN) D SPK Q  ;GMRCEN defined if branched to here from EN^GMRCSLM
"RTN","GMRCSLM",101,0)
 S GMRCOER=0
"RTN","GMRCSLM",102,0)
 D AD^GMRCSLM1 ;Do not delete. Needed to get new Pt. data into ^TMP("GMRCR",
"RTN","GMRCSLM",103,0)
 S VALMCNT=LNCT,VALMBCK="R",VALMPGE=1 K GMRCDFN1
"RTN","GMRCSLM",104,0)
 Q
"RTN","GMRCSLM",105,0)
SPQ ;New patient has not been selected - keep current patient
"RTN","GMRCSLM",106,0)
 I '$D(DFN),GMRCDFN1<1 S GMRCQUT=1 K GMRCDFN1 Q
"RTN","GMRCSLM",107,0)
 S DFN=GMRCDFN1 Q:DFN<1  W " "_GMRCPNM K GMRCDFN1
"RTN","GMRCSLM",108,0)
 S VALMBCK="R",GMRCQUT=1 K GMRCDFN1
"RTN","GMRCSLM",109,0)
SPK ;Kill variables
"RTN","GMRCSLM",110,0)
 ;I $D(GMRCTM),$D(GMRCBM),$D(IOSTBM) S IOTM=GMRCTM,IOBM=IOSTBM
"RTN","GMRCSLM",111,0)
 K GMRCDFN1,GMRCBM,GMRCTM
"RTN","GMRCSLM",112,0)
 Q
"RTN","GMRCSLM",113,0)
SS ;Select A New Service or ALL SERVICES to Display Patient Consults
"RTN","GMRCSLM",114,0)
 K GMRCQUT,GMRCVP S GMRCOER=0
"RTN","GMRCSLM",115,0)
 D FULL^VALM1
"RTN","GMRCSLM",116,0)
 D ASRV^GMRCASV I $D(GMRCQUT),GMRCQUT=1 Q
"RTN","GMRCSLM",117,0)
 S GMRCSS=GMRCDG,GMRCSSNM=$P(^GMR(123.5,GMRCSS,0),"^",1)
"RTN","GMRCSLM",118,0)
 D AD^GMRCSLM1,INIT,HDR
"RTN","GMRCSLM",119,0)
 S VALMBCK="R",VALMCNT=LNCT
"RTN","GMRCSLM",120,0)
 D EN^GMRCACTM,EN^GMRCMENU
"RTN","GMRCSLM",121,0)
 I $D(GMRC("NMBR")) D RESET^GMRCSLMV(GMRC("NMBR")) K GMRC("NMBR")
"RTN","GMRCSLM",122,0)
 Q
"RTN","GMRCSLM",123,0)
STS ;Select a status for view. i.e., only active, pendings, DC'd, etc.
"RTN","GMRCSLM",124,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCSLM",125,0)
 S GMRCERR=0
"RTN","GMRCSLM",126,0)
 N DIR,X,Y
"RTN","GMRCSLM",127,0)
 S DIR(0)="SAOM^dc:Discontinued;c:Complete;p:Pending;a:Active;pr:Partial Results;s:Scheduled;x:Cancelled"
"RTN","GMRCSLM",128,0)
 S $P(DIR(0),U,2)="al:All Status's;"_$P(DIR(0),U,2)
"RTN","GMRCSLM",129,0)
 S DIR("A")="Only Display Consults With Status of: "
"RTN","GMRCSLM",130,0)
 S DIR("B")="All Status's"
"RTN","GMRCSLM",131,0)
 I $G(GMRCSTCK) D
"RTN","GMRCSLM",132,0)
 . S DIR("A")="Another Status to display: "
"RTN","GMRCSLM",133,0)
 . K DIR("B")
"RTN","GMRCSLM",134,0)
 D ^DIR
"RTN","GMRCSLM",135,0)
 I $D(DUOUT)!($D(DTOUT))!('$L(Y)) G END
"RTN","GMRCSLM",136,0)
 D STCK($$LOW^XLFSTR(Y)) I $G(GMRCSTCK)="" D:$D(GMRC("NMBR"))  G END
"RTN","GMRCSLM",137,0)
 . D RESET^GMRCSLMV(GMRC("NMBR"))
"RTN","GMRCSLM",138,0)
 . K GMRC("NMBR")
"RTN","GMRCSLM",139,0)
 . Q
"RTN","GMRCSLM",140,0)
 I $D(GMRC("NMBR")) D RESET^GMRCSLMV(GMRC("NMBR")) K GMRC("NMBR")
"RTN","GMRCSLM",141,0)
 G STS
"RTN","GMRCSLM",142,0)
STCK(RES)     ;change code to status
"RTN","GMRCSLM",143,0)
 N CODE
"RTN","GMRCSLM",144,0)
 I RES="al" S GMRCSTCK="" Q
"RTN","GMRCSLM",145,0)
 I RES="dc" S CODE=1
"RTN","GMRCSLM",146,0)
 I RES="c" S CODE=2
"RTN","GMRCSLM",147,0)
 I RES="p" S CODE=5
"RTN","GMRCSLM",148,0)
 I RES="a" S CODE=6
"RTN","GMRCSLM",149,0)
 I RES="pr" S CODE=9
"RTN","GMRCSLM",150,0)
 I RES="x" S CODE=13
"RTN","GMRCSLM",151,0)
 I RES="s" S CODE=8
"RTN","GMRCSLM",152,0)
 I $D(GMRCSTCK)  I $$FND(CODE) W $C(7),!,"Already selected" Q
"RTN","GMRCSLM",153,0)
 I +$G(GMRCSTCK) S GMRCSTCK=GMRCSTCK_","_CODE Q
"RTN","GMRCSLM",154,0)
 S GMRCSTCK=CODE
"RTN","GMRCSLM",155,0)
 Q
"RTN","GMRCSLM",156,0)
FND(CD) ;status already selected?
"RTN","GMRCSLM",157,0)
 I GMRCSTCK=CD Q 1
"RTN","GMRCSLM",158,0)
 I $F(GMRCSTCK,(CD_",")) Q 1
"RTN","GMRCSLM",159,0)
 I $E(GMRCSTCK,$L(GMRCSTCK))=CD Q 1
"RTN","GMRCSLM",160,0)
 Q 0
"RTN","GMRCSLM",161,0)
END K DIR,GMRCERR,Y
"RTN","GMRCSLM",162,0)
 Q
"RTN","GMRCSLM1")
0^51^B55642136
"RTN","GMRCSLM1",1,0)
GMRCSLM1 ;SLC/DCM - Gather data and format ^TMP global for consult tracking Silent call for use by List Manager and GUI ;10/9/01 23:12
"RTN","GMRCSLM1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,10,12,15,17,22**;DEC 27, 1997
"RTN","GMRCSLM1",3,0)
 ;
"RTN","GMRCSLM1",4,0)
 ; This routine invokes IA #2638,#2740
"RTN","GMRCSLM1",5,0)
 ;
"RTN","GMRCSLM1",6,0)
 G AD
"RTN","GMRCSLM1",7,0)
SVC(NODE) ;Check for a valid service
"RTN","GMRCSLM1",8,0)
 K GMRCDEAV
"RTN","GMRCSLM1",9,0)
 I '$D(^GMR(123,NODE,0)) Q 0
"RTN","GMRCSLM1",10,0)
 I '+$P(^GMR(123,NODE,0),"^",5) Q 0
"RTN","GMRCSLM1",11,0)
 I '$D(^TMP("GMRCS",$J,$P(^GMR(123,NODE,0),"^",5))) Q 0
"RTN","GMRCSLM1",12,0)
 Q 1
"RTN","GMRCSLM1",13,0)
AD ;Main entry point. Loop through AD x-ref in file 123; Find consults that have been released to requested service
"RTN","GMRCSLM1",14,0)
 ;;DFN and GMRCSSNM must be defined when this entry point is called
"RTN","GMRCSLM1",15,0)
 ;;DFN=Internal File Number of Patient in ^DPT
"RTN","GMRCSLM1",16,0)
 ;;GMRCSSNM=Service Name of a Hospital Service from file ^GMR(123.5
"RTN","GMRCSLM1",17,0)
 ;;If GMRCSSNM is not defined or is null, then no records will be found.
"RTN","GMRCSLM1",18,0)
 ;;GMRCOER must be passed so that proper formatting for GUI or List Manager can be performed.  GMRCOER is passed as 0 for List Manager, 1 for GUI.
"RTN","GMRCSLM1",19,0)
 ;;GMRCDT1 and GMRCDT2 are passed in as start and stop dates for the lookup. If GMRCDT1="" or GMRCDT1="ALL", then all dates are searched.
"RTN","GMRCSLM1",20,0)
 ;;GMRCIS=IFC site (if defined); Values: R(equesting) or C(onsulting)
"RTN","GMRCSLM1",21,0)
 ;;  ***********************************************************
"RTN","GMRCSLM1",22,0)
 K ^TMP("GMRCR",$J,"CS"),GMRCNUL
"RTN","GMRCSLM1",23,0)
 I $D(GMRCSSS) S (GMRCDG,GMRCSS)=GMRCSSS,GMRCSSNM=($P($G(^GMR(123.5,+GMRCSS,0)),"^",1)) D SERV1^GMRCASV K GMRCSSS ;reset after forward
"RTN","GMRCSLM1",24,0)
 S TAB="",$P(TAB," ",41)="",BLK=0,LNCT=1 S:'$D(GMRCOER) GMRCOER=0
"RTN","GMRCSLM1",25,0)
 S GMRCD=0 F  S GMRCD=$O(^GMR(123,"AD",DFN,GMRCD)) Q:'GMRCD  S GMRCDA=0 F  S GMRCDA=$O(^GMR(123,"AD",DFN,GMRCD,GMRCDA)) Q:'GMRCDA  I $$SVC(GMRCDA) D SET
"RTN","GMRCSLM1",26,0)
 D END Q
"RTN","GMRCSLM1",27,0)
SET ;;Format entries into a word processing 'TMP("GMRCR",$J,"CS",' global that List Manager can display
"RTN","GMRCSLM1",28,0)
 ;;GMRCOER is a variable that signals that data is being formatted for the OE/RR GUI; this data is formatted differently than the data for List Manager.
"RTN","GMRCSLM1",29,0)
 ;;GMRCOER=0 : Data is List Manager formatted.
"RTN","GMRCSLM1",30,0)
 ;;GMRCOER=1 : Data is OE/RR GUI formatted.
"RTN","GMRCSLM1",31,0)
 S:'$D(TAB) TAB="",$P(TAB," ",30)=""
"RTN","GMRCSLM1",32,0)
 S GMRCIFN=$G(GMRCDA) I '$L(GMRCIFN),$D(XQADATA) S (GMRCDA,GMRCIFN)=+XQADATA
"RTN","GMRCSLM1",33,0)
 S GMRCSEX=$S($P(^DPT(DFN,0),"^",2)="M":"MALE",1:"FEMALE")
"RTN","GMRCSLM1",34,0)
 I '$D(^GMR(123,+GMRCIFN,0)) S GMRCQUT=1 Q
"RTN","GMRCSLM1",35,0)
 S PROC="",GMRC(0)=^GMR(123,GMRCIFN,0)
"RTN","GMRCSLM1",36,0)
 ;IF Consults
"RTN","GMRCSLM1",37,0)
 N GMRCCK
"RTN","GMRCSLM1",38,0)
 I $D(GMRCIS) D  Q:'GMRCCK
"RTN","GMRCSLM1",39,0)
 . S GMRCCK=1
"RTN","GMRCSLM1",40,0)
 . S:'$P($G(GMRC(0)),"^",23) GMRCCK=0
"RTN","GMRCSLM1",41,0)
 . I GMRCCK=1 D
"RTN","GMRCSLM1",42,0)
 . . S GMRC(12)=$G(^GMR(123,GMRCIFN,12))
"RTN","GMRCSLM1",43,0)
 . . I GMRCIS="R",$P(GMRC(12),"^",5)'="P" S GMRCCK=0
"RTN","GMRCSLM1",44,0)
 . . I GMRCIS="C",$P(GMRC(12),"^",5)'="F" S GMRCCK=0
"RTN","GMRCSLM1",45,0)
 I $D(GMRCSTCK),GMRCSTCK'="" N STATUS,TITLE D  Q:'STATUS
"RTN","GMRCSLM1",46,0)
 . N I
"RTN","GMRCSLM1",47,0)
 . F I=1:1 S STATUS=$P(GMRCSTCK,",",I) Q:STATUS=$P(GMRC(0),"^",12)  Q:'STATUS
"RTN","GMRCSLM1",48,0)
 . Q
"RTN","GMRCSLM1",49,0)
 I $D(GMRCVP),GMRCVP'=$P(GMRC(0),"^",8) Q
"RTN","GMRCSLM1",50,0)
 S (GMRCFMDT,X)=$P(GMRC(0),"^",7) I GMRCDT1'="ALL",$P(X,".",1)<GMRCDT1!($P(X,".",1)>GMRCDT2) Q
"RTN","GMRCSLM1",51,0)
 I GMRCOER'=2 D
"RTN","GMRCSLM1",52,0)
 . S BLK=BLK+1
"RTN","GMRCSLM1",53,0)
 . S ^TMP("GMRCR",$J,"CS","AD",BLK,LNCT,GMRCDA)=""
"RTN","GMRCSLM1",54,0)
 D REGDTM^GMRCU S CDT=$P(X," ")
"RTN","GMRCSLM1",55,0)
 S PROC=$S($P(GMRC(0),U,17)="P":"Procedure",1:"Consult")
"RTN","GMRCSLM1",56,0)
 I PROC'="Consult" S PROC=$$GET1^DIQ(123.3,+$P(GMRC(0),"^",8),.01)
"RTN","GMRCSLM1",57,0)
 S:PROC="" PROC="Consult"
"RTN","GMRCSLM1",58,0)
 S TO=+$P(GMRC(0),"^",5)
"RTN","GMRCSLM1",59,0)
 I +TO S TOD=$S($P($G(^GMR(123.5,+TO,0)),"^",2)=9:1,1:0)
"RTN","GMRCSLM1",60,0)
 I '$D(TOD) S TOD=0
"RTN","GMRCSLM1",61,0)
 S TO=$S(+TO:$P($G(^GMR(123.5,+TO,0)),"^",1),1:"")
"RTN","GMRCSLM1",62,0)
 S TO=$S(TOD:"<",1:"")_TO
"RTN","GMRCSLM1",63,0)
 S TO=$S(GMRCOER:TO,1:$E(TO,1,40))_$S(TOD:">",1:"")
"RTN","GMRCSLM1",64,0)
 I '$L(TO) S TO="**Unknown Service**"
"RTN","GMRCSLM1",65,0)
 S STS=$P(GMRC(0),"^",12) D
"RTN","GMRCSLM1",66,0)
 . I '+STS,'$D(^ORD(100.01,+STS,0)) Q
"RTN","GMRCSLM1",67,0)
 . I '+GMRCOER S STS=$P(^ORD(100.01,+STS,.1),"^",1) Q
"RTN","GMRCSLM1",68,0)
 . I GMRCOER=1 S STS=$P(^ORD(100.01,+STS,0),"^") Q
"RTN","GMRCSLM1",69,0)
 . S STS=$P(^ORD(100.01,+STS,.1),"^")
"RTN","GMRCSLM1",70,0)
 I $S(STS="":1,'$D(^ORD(100.01,+$P(GMRC(0),"^",12),0)):1,1:0) S STS=99,$P(GMRC(0),"^",12)=STS,STS=$S(GMRCOER=1:$P(^ORD(100.01,5,0),"^",1),1:$P(^ORD(100.01,+STS,.1),"^",1))
"RTN","GMRCSLM1",71,0)
 D SERVPROC
"RTN","GMRCSLM1",72,0)
 I 'GMRCOER D  Q
"RTN","GMRCSLM1",73,0)
 . S ^TMP("GMRCR",$J,"CS",LNCT,0)=BLK_$E(TAB,1,(4-$L(BLK)))_CDT_"  "_$E(STS,1,3)_$S(STS?1A:"  ",STS?2A:" ",1:"")_" "_$J(GMRCDA,7)_" "_$S($P(GMRC(0),"^",19)="Y":"*",1:" ")_TITLE
"RTN","GMRCSLM1",74,0)
 . S LNCT=LNCT+1
"RTN","GMRCSLM1",75,0)
 I GMRCOER D
"RTN","GMRCSLM1",76,0)
 . N DATA
"RTN","GMRCSLM1",77,0)
 . S DATA=GMRCDA_U_GMRCFMDT_U_STS_U_TO_U_PROC_U
"RTN","GMRCSLM1",78,0)
 . S DATA=DATA_$S($P(GMRC(0),U,19)="Y":"*",1:"")_U
"RTN","GMRCSLM1",79,0)
 . S DATA=DATA_TITLE_U_$P(GMRC(0),U,3)
"RTN","GMRCSLM1",80,0)
 . D  ;get type of record for proper icon in GUI
"RTN","GMRCSLM1",81,0)
 .. ; "C"=reg cons, "P"=reg proc, "M"=clin proc, "I"=IF cons, "R"=IF proc
"RTN","GMRCSLM1",82,0)
 .. I +$G(^GMR(123,GMRCDA,1)) S $P(DATA,U,9)="M" Q
"RTN","GMRCSLM1",83,0)
 .. S $P(DATA,U,9)=$P(GMRC(0),U,17)
"RTN","GMRCSLM1",84,0)
 .. N GMRCGVER
"RTN","GMRCSLM1",85,0)
 .. S GMRCGVER=$P($G(ORWCLVER),".",3,4) ;GUI version running
"RTN","GMRCSLM1",86,0)
 .. I GMRCGVER'>19.1 Q  ;will crash at less than 19.1
"RTN","GMRCSLM1",87,0)
 .. I $P(GMRC(0),U,23) S $P(DATA,U,9)=$S($P(DATA,U,9)="P":"R",1:"I")
"RTN","GMRCSLM1",88,0)
 . S ^TMP("GMRCR",$J,"CS",LNCT,0)=DATA
"RTN","GMRCSLM1",89,0)
 . S LNCT=LNCT+1
"RTN","GMRCSLM1",90,0)
 . K STSOER Q
"RTN","GMRCSLM1",91,0)
 Q
"RTN","GMRCSLM1",92,0)
END I LNCT<2 S (BLK,LNCT,GMRCNUL)=1,GMRCNPM="< PATIENT DOES NOT HAVE ANY CONSULTS/REQUESTS "_$S($D(GMRCPRNM):"FOR "_GMRCPRNM,1:"")_" ON FILE. >",GMRCNPM=$E(TAB,1,(80-$L(GMRCNPM))\80)_GMRCNPM,^TMP("GMRCR",$J,"CS",LNCT,0)=GMRCNPM D
"RTN","GMRCSLM1",93,0)
 .I GMRCDT1'="ALL",$D(GMRCDT1)&($D(GMRCDT2)) S LNCT=LNCT+1,^TMP("GMRCR",$J,"CS",LNCT,0)="Between Dates: "_$$FMTE^XLFDT(GMRCDT1)_" and "_$$FMTE^XLFDT(GMRCDT2)
"RTN","GMRCSLM1",94,0)
 .I $D(GMRCSTCK),$L(GMRCSTCK) S LNCT=LNCT+1,^TMP("GMRCR",$J,"CS",LNCT,0)="With Status: " S STS="" F I=1:1 S STS=$P(GMRCSTCK,",",I) Q:STS=""  S ^TMP("GMRCR",$J,"CS",LNCT,0)=^(0)_$P($G(^ORD(100.01,+STS,0)),"^",1)_" "
"RTN","GMRCSLM1",95,0)
 .Q
"RTN","GMRCSLM1",96,0)
 E  S (BLK,LNCT)=LNCT-1,^TMP("GMRCR",$J,"CS",0)="^^^"_LNCT
"RTN","GMRCSLM1",97,0)
 I $D(GMRCALFL) S (BLK,LNCT)=1
"RTN","GMRCSLM1",98,0)
 K TO,TOD,END,FLG,GMRC(0),GMRCD,GMRCDG,GMRCIFN,GMRCFMDT,GMRCNPM,GMRCWARD
"RTN","GMRCSLM1",99,0)
 K I,PROC,STS,URG
"RTN","GMRCSLM1",100,0)
 Q
"RTN","GMRCSLM1",101,0)
OER(DFN,GMRCDG,GMRCDT1,GMRCDT2,GMRCSTCK,GMRCOER) ;;GUI interface for CPRS
"RTN","GMRCSLM1",102,0)
 ;;DFN=Patient internal file number
"RTN","GMRCSLM1",103,0)
 ;;GMRCDG:  Internal file number of consult service from file 123.5
"RTN","GMRCSLM1",104,0)
 ;;GMRCDT1:  Beginning date for lookup
"RTN","GMRCSLM1",105,0)
 ;;GMRCDT2:  Ending date for lookup
"RTN","GMRCSLM1",106,0)
 ;;GMRCSTCK: IEN from OER Status File [^OER(100.01)] to screen results
"RTN","GMRCSLM1",107,0)
 ;;     so that only consults with a desired status are displayed
"RTN","GMRCSLM1",108,0)
 ;;     Can be sent as a set of statuses: i.e., 6,5,2
"RTN","GMRCSLM1",109,0)
 ;;      (GMRCSTCK=GMRC STATUS CHECK)
"RTN","GMRCSLM1",110,0)
 ;;GMRCOER=0 if request is from CONSULTS
"RTN","GMRCSLM1",111,0)
 ;;       =1 if request is for CPRS List Manager
"RTN","GMRCSLM1",112,0)
 ;;       =2 if for CPRS GUI
"RTN","GMRCSLM1",113,0)
 I GMRCDT1="" S GMRCDT1="ALL"
"RTN","GMRCSLM1",114,0)
 I GMRCDG="" S GMRCDG=$O(^GMR(123.5,"B","ALL SERVICES",0))
"RTN","GMRCSLM1",115,0)
 S:'$D(GMRCOER) GMRCOER=1
"RTN","GMRCSLM1",116,0)
 D SERV1^GMRCASV,AD
"RTN","GMRCSLM1",117,0)
 K ^TMP("GMRCS",$J),^TMP("GMRCSLIST",$J)
"RTN","GMRCSLM1",118,0)
 Q
"RTN","GMRCSLM1",119,0)
SERVPROC ; Build contents of SERV/PROC field for List Manager
"RTN","GMRCSLM1",120,0)
 N TYPE,OTXT
"RTN","GMRCSLM1",121,0)
 S TITLE=""
"RTN","GMRCSLM1",122,0)
 S TYPE=""
"RTN","GMRCSLM1",123,0)
 S OTXT=$P($G(^GMR(123,GMRCDA,1.11)),"^")
"RTN","GMRCSLM1",124,0)
 I OTXT="" D BUILD2
"RTN","GMRCSLM1",125,0)
 I OTXT'="" D BUILD1
"RTN","GMRCSLM1",126,0)
 Q
"RTN","GMRCSLM1",127,0)
BUILD1 ;OTXT does contain information
"RTN","GMRCSLM1",128,0)
 N FLG,BADFLG,TPROC,TTO,LEN,ABBRS,ABBRP
"RTN","GMRCSLM1",129,0)
 S TPROC=$$UP^XLFSTR(PROC),TTO=$$UP^XLFSTR(TO)
"RTN","GMRCSLM1",130,0)
 S TITLE=OTXT,OTXT=$$UP^XLFSTR(OTXT)
"RTN","GMRCSLM1",131,0)
 S BADFLG=0
"RTN","GMRCSLM1",132,0)
 I PROC="Consult" S FLG=1,TYPE="Cons"
"RTN","GMRCSLM1",133,0)
 I PROC'="Consult" S FLG=0,TYPE="Proc"
"RTN","GMRCSLM1",134,0)
 S LEN=$L(TITLE)
"RTN","GMRCSLM1",135,0)
 I TO="" S TO="No Service"
"RTN","GMRCSLM1",136,0)
 I LEN<30,FLG=1,OTXT'=TTO S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",137,0)
 I LEN<30,FLG=1,OTXT=TTO S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",138,0)
 I TO["<" S BADFLG=1
"RTN","GMRCSLM1",139,0)
 S ABBRS=$$SVC^GMRCAU(GMRCDA),ABBRP=$$PROC^GMRCAU(GMRCDA)
"RTN","GMRCSLM1",140,0)
 I LEN<30,FLG=0,TPROC'=OTXT,TTO'=TPROC S TITLE=TITLE_" "_PROC_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",141,0)
 I LEN<30,FLG=0,TPROC=OTXT,TTO'=TPROC S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",142,0)
 I LEN<30,FLG=0,TPROC=OTXT,TTO=TPROC S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",143,0)
 I LEN>30,FLG=1,TTO'=OTXT S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",144,0)
 I LEN>30,FLG=1,TTO=OTXT S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",145,0)
 I LEN>30,FLG=0,TPROC'=OTXT,TTO'=TPROC S TITLE=TITLE_" "_ABBRP_" "_TYPE Q
"RTN","GMRCSLM1",146,0)
 I LEN>30,FLG=0,TTO'=OTXT,BADFLG=0 S TITLE=TITLE_" "_ABBRS_" "_TYPE Q
"RTN","GMRCSLM1",147,0)
 I LEN>30,FLG=0,TTO'=OTXT,BADFLG=1 S TITLE=TITLE_" "_"<"_ABBRS_">"_TYPE Q
"RTN","GMRCSLM1",148,0)
 Q
"RTN","GMRCSLM1",149,0)
BUILD2 ;OTXT contains no information
"RTN","GMRCSLM1",150,0)
 N FLG,TPROC,TTO,LEN
"RTN","GMRCSLM1",151,0)
 S TPROC=$$UP^XLFSTR(PROC),TTO=$$UP^XLFSTR(TO)
"RTN","GMRCSLM1",152,0)
 I PROC="Consult" S TITLE=TO,LEN=$L(TITLE),FLG=1,TYPE="Cons"
"RTN","GMRCSLM1",153,0)
 I PROC'="Consult" S TITLE=PROC,LEN=$L(TITLE),FLG=0,TYPE="Proc"
"RTN","GMRCSLM1",154,0)
 I FLG=1 S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",155,0)
 I FLG=0,TTO=TPROC S TITLE=TITLE_" "_TYPE Q
"RTN","GMRCSLM1",156,0)
 I FLG=0,TTO'=TPROC S TITLE=TITLE_" "_TO_" "_TYPE Q
"RTN","GMRCSLM1",157,0)
 Q
"RTN","GMRCSLM2")
0^18^B58749629
"RTN","GMRCSLM2",1,0)
GMRCSLM2 ;SLC/DCM - LM Detailed  display and printing ;12/17/01 23:19
"RTN","GMRCSLM2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,18,15,17,23,22**;DEC 27,1997
"RTN","GMRCSLM2",3,0)
 ;
"RTN","GMRCSLM2",4,0)
 ; This routine invokes IA #616,#872,#875,#2467,#2638,#2693,#2925,#3138
"RTN","GMRCSLM2",5,0)
 ;                         #2849,#10040,#10060
"RTN","GMRCSLM2",6,0)
 ; DBIA 2638     ;ORDER STATUS
"RTN","GMRCSLM2",7,0)
 ; DBIA 2849     ;PROTOCOL
"RTN","GMRCSLM2",8,0)
 ; DBIA 10040    ;SCHEDULING
"RTN","GMRCSLM2",9,0)
 ; DBIA 10060    ;NEW PERSON
"RTN","GMRCSLM2",10,0)
 ;
"RTN","GMRCSLM2",11,0)
DT(GMRCO,GMRCIERR) ;;Entry point to set-up detailed display.
"RTN","GMRCSLM2",12,0)
 ;;Pass in GMRCO as +GMRCO - a number only. GMRCO=IEN from of consult from file 123
"RTN","GMRCSLM2",13,0)
 ;;Results are placed in ^TMP("GMRCR",$J,"DT",
"RTN","GMRCSLM2",14,0)
 ;;Pass in variable GMRCOER=2 if calling from the GUI, GMRCOER=1 if call is from CPRS consults tab
"RTN","GMRCSLM2",15,0)
 ;;Pass in variable GMRCOER=0 (or as <UNDEFINED>) if call is from consults routines
"RTN","GMRCSLM2",16,0)
 K GMRCQUT
"RTN","GMRCSLM2",17,0)
 N DFN,GMRCD,GMRCDA,ORIFN,GMRCSF S GMRCDVDL="",$P(GMRCDVDL,"-",80)=""
"RTN","GMRCSLM2",18,0)
 I $S('GMRCO:1,'$D(^GMR(123,+GMRCO,0)):1,1:0) D:$S('$D(GMRCOER):1,'GMRCOER:1,1:0)  S GMRCQUT=1 Q
"RTN","GMRCSLM2",19,0)
 .S GMRCMSG="The consult entry selected for the Detailed Display is unknown." D EXAC^GMRCADC(GMRCMSG) K GMRCMSG
"RTN","GMRCSLM2",20,0)
 .Q
"RTN","GMRCSLM2",21,0)
 K ^TMP("GMRCR",$J,"DT") S TAB="",$P(TAB," ",30)="",GMRCCT=1
"RTN","GMRCSLM2",22,0)
 S GMRCO(0)=^GMR(123,+GMRCO,0),ORIFN=$P(GMRCO(0),"^",3),DFN=$P(GMRCO(0),"^",2)
"RTN","GMRCSLM2",23,0)
 S X="SDUTL3" X ^%ZOSF("TEST") I  D
"RTN","GMRCSLM2",24,0)
 .N PR S PR=$$OUTPTPR^SDUTL3(DFN) I $L(PR) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Current PC Provider:   "_$P(PR,"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",25,0)
 .S PR=$$OUTPTTM^SDUTL3(DFN) I $L(PR) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Current PC Team:       "_$P(PR,"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",26,0)
 .Q
"RTN","GMRCSLM2",27,0)
 N VAIN,VAEL
"RTN","GMRCSLM2",28,0)
 D INP^VADPT S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Current Pat. Status:   "_$S(+VAIN(8):"Inpatient",1:"Outpatient"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",29,0)
 I $D(VAIN(4)),$L($P(VAIN(4),"^",2)) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Ward:"_$E(TAB,1,18)_$P(VAIN(4),"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",30,0)
 D ELIG^VADPT
"RTN","GMRCSLM2",31,0)
 I $L($P(VAEL(1),"^",2)) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Primary Eligibility:"_$E(TAB,1,11)_$P(VAEL(1),"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",32,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",33,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Order Information",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",34,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="To Service:"_$E(TAB,1,12)_$P($G(^GMR(123.5,+$P(GMRCO(0),"^",5),0)),"^"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",35,0)
 I $P(GMRCO(0),"^",11) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Attention:"_$E(TAB,1,13)_$P($G(^VA(200,$P(GMRCO(0),"^",11),0)),"^"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",36,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="From Service:"_$E(TAB,1,10)_$P($G(^SC(+$P(GMRCO(0),"^",6),0)),"^"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",37,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Requesting Provider: "_$E(TAB,1,2)_$S($P(GMRCO(0),"^",14)]"":$P($G(^VA(200,$P(GMRCO(0),"^",14),0)),"^",1),1:""),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",38,0)
 I $L($P(GMRCO(0),"^",18)) D
"RTN","GMRCSLM2",39,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Service is to be rendered on an "_$S($P(GMRCO(0),"^",18)="I":"INPATIENT",1:"OUTPATIENT")_" basis",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",40,0)
 .Q
"RTN","GMRCSLM2",41,0)
 I $P(GMRCO(0),"^",10) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Place:"_$E(TAB,1,17)_$P($G(^ORD(101,+$P(GMRCO(0),"^",10),0)),"^",2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",42,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Urgency:"_$E(TAB,1,15)_$S($L($P(GMRCO(0),"^",9)):$P($G(^ORD(101,+$P(GMRCO(0),"^",9),0)),"^",2),1:""),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",43,0)
 S X="ORX8" X ^%ZOSF("TEST") I  D
"RTN","GMRCSLM2",44,0)
 .N GMRCOITM S GMRCOITM=$$OI^ORX8(ORIFN)
"RTN","GMRCSLM2",45,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Orderable Item:"_$E(TAB,1,8)_$P(GMRCOITM,U,2),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",46,0)
 .Q
"RTN","GMRCSLM2",47,0)
 S GMRCPRNM=$P(GMRCO(0),"^",8),GMRCPROC=$S(+GMRCPRNM:$P($G(^GMR(123.3,+GMRCPRNM,0)),"^"),1:"Consult Request")
"RTN","GMRCSLM2",48,0)
 I $L(GMRCPROC) D
"RTN","GMRCSLM2",49,0)
 .N GMRCLN
"RTN","GMRCSLM2",50,0)
 .S GMRCTYPE=$S($P(GMRCO(0),U,17)="P":"Procedure",1:"Consult")
"RTN","GMRCSLM2",51,0)
 .S GMRCLN=GMRCTYPE_":"_$E(TAB,1,22-$L(GMRCTYPE))_GMRCPROC
"RTN","GMRCSLM2",52,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCLN
"RTN","GMRCSLM2",53,0)
 .S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",54,0)
 .I $G(^GMR(123,+GMRCO,1)) D
"RTN","GMRCSLM2",55,0)
 .. S GMRCLN=""
"RTN","GMRCSLM2",56,0)
 .. S GMRCLN="Clinical Procedure:"_$E(TAB,1,4)
"RTN","GMRCSLM2",57,0)
 .. S GMRCLN=GMRCLN_$$GET1^DIQ(123,+GMRCO,1.01,"E")
"RTN","GMRCSLM2",58,0)
 .. S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCLN
"RTN","GMRCSLM2",59,0)
 .. S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",60,0)
 .Q
"RTN","GMRCSLM2",61,0)
 S GMRCD=$G(^GMR(123,+GMRCO,30)) I $L(GMRCD) D
"RTN","GMRCSLM2",62,0)
 . I $L(GMRCD)>54 D
"RTN","GMRCSLM2",63,0)
 .. N SEG,I S I=2
"RTN","GMRCSLM2",64,0)
 .. F  S SEG=$P(GMRCD," ",1,I) Q:$L(SEG)>54  S I=I+1
"RTN","GMRCSLM2",65,0)
 .. S SEG=$P(GMRCD," ",1,(I-1))
"RTN","GMRCSLM2",66,0)
 .. S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Provisional Diagnosis: "_SEG
"RTN","GMRCSLM2",67,0)
 .. S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",68,0)
 .. S SEG=$$REPEAT^XLFSTR(" ",22)_$E(GMRCD,$L(SEG)+1,80)
"RTN","GMRCSLM2",69,0)
 .. S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=SEG S GMRCD=""
"RTN","GMRCSLM2",70,0)
 .. S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",71,0)
 I GMRCD'="" D
"RTN","GMRCSLM2",72,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Provisional Diagnosis: "_GMRCD
"RTN","GMRCSLM2",73,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",74,0)
 I $D(^GMR(123,+GMRCO,20,0)) D
"RTN","GMRCSLM2",75,0)
 .I $O(^GMR(123,+GMRCO,20,0)) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Reason For Request:",GMRCCT=GMRCCT+1 D  Q
"RTN","GMRCSLM2",76,0)
 .. S LN=0
"RTN","GMRCSLM2",77,0)
 .. F  S LN=$O(^GMR(123,+GMRCO,20,LN)) Q:LN=""  D
"RTN","GMRCSLM2",78,0)
 ... S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=^GMR(123,+GMRCO,20,LN,0)
"RTN","GMRCSLM2",79,0)
 ... I $G(GMRCIERR) D
"RTN","GMRCSLM2",80,0)
 .... N TXT S TXT=^TMP("GMRCR",$J,"DT",GMRCCT,0)_"..."
"RTN","GMRCSLM2",81,0)
 .... S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=TXT
"RTN","GMRCSLM2",82,0)
 .... S LN=9999 ;quit with just one line
"RTN","GMRCSLM2",83,0)
 ... S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",84,0)
 .. Q
"RTN","GMRCSLM2",85,0)
 . Q
"RTN","GMRCSLM2",86,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=" ",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",87,0)
 ; get inter-facility consult info
"RTN","GMRCSLM2",88,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Inter-facility Information",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",89,0)
 I '$P(GMRCO(0),"^",23) D
"RTN","GMRCSLM2",90,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="This is not an inter-facility consult request.",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",91,0)
 E  D
"RTN","GMRCSLM2",92,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$$REPEAT^XLFSTR("-",27)
"RTN","GMRCSLM2",93,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",94,0)
 . N GMRCOP
"RTN","GMRCSLM2",95,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Remote Facility:"_$E(TAB,1,6)_$P($G(^DIC(4,+$P(GMRCO(0),"^",23),0)),"^"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",96,0)
 . S GMRCO(12)=$G(^GMR(123,+GMRCO,12))
"RTN","GMRCSLM2",97,0)
 . I $L($P(GMRCO(12),U,6)) D
"RTN","GMRCSLM2",98,0)
 .. S GMRCOP=$P(GMRCO(12),U,6)
"RTN","GMRCSLM2",99,0)
 . I '$D(GMRCOP) S GMRCOP=$$GET1^DIQ(200,+$P(GMRCO(0),U,14),.01)
"RTN","GMRCSLM2",100,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Ordering Provider:"_$E(TAB,1,5)_GMRCOP,GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",101,0)
 . S GMRCO(13)=$G(^GMR(123,+GMRCO,13)) I $L($P(GMRCO(13),U,2,3))>1 D
"RTN","GMRCSLM2",102,0)
 .. N LINE
"RTN","GMRCSLM2",103,0)
 .. S LINE=$P(GMRCO(13),U,2) I $L(LINE) S LINE=LINE_$E(TAB,1,5) D 
"RTN","GMRCSLM2",104,0)
 ... S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Ordering Provider phone: "_LINE
"RTN","GMRCSLM2",105,0)
 ... S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",106,0)
 .. S LINE=$P(GMRCO(13),U,3) I $L(LINE) S LINE=LINE_$E(TAB,1,5) D
"RTN","GMRCSLM2",107,0)
 ... S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Ordering Provider pager: "_LINE
"RTN","GMRCSLM2",108,0)
 ... S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",109,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Remote Consult #"_$E(TAB)_$P(GMRCO(0),"^",22),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",110,0)
 . I $L($P(GMRCO(13),U)) S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Remote Service name: "_$E(TAB)_$P(GMRCO(13),U),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",111,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Role: "_$E(TAB,1,10)_$S($P(GMRCO(12),U,5)="P":"Requesting facility",1:"Consulting facility"),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",112,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",113,0)
 ;get status, last action, and significant findings
"RTN","GMRCSLM2",114,0)
 S STS=$P(GMRCO(0),"^",12),^TMP("GMRCR",$J,"DT",GMRCCT,0)="Status:  "_$E(TAB,1,14)_$S($D(^ORD(100.01,+STS,0)):$P(^(0),"^",1),1:$P(^ORD(100.01,6,0),"^",1)),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",115,0)
 S GMRCA=$P(^GMR(123,+GMRCO,0),"^",13),^TMP("GMRCR",$J,"DT",GMRCCT,0)="Last Action:"_$E(TAB,1,11)_$S(+GMRCA:$P($G(^GMR(123.1,GMRCA,0)),"^",1),1:""),GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",116,0)
 I $L($P(GMRCO(0),"^",19)) D
"RTN","GMRCSLM2",117,0)
 .S GMRCSF=$P(GMRCO(0),"^",19)
"RTN","GMRCSLM2",118,0)
 .S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Significant Findings:  "_$S(GMRCSF="Y":"YES",GMRCSF="N":"NO",1:"Unknown")
"RTN","GMRCSLM2",119,0)
 .S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",120,0)
 .Q
"RTN","GMRCSLM2",121,0)
 I $G(GMRCIERR) Q  ;don't need results or activities on IFC errors
"RTN","GMRCSLM2",122,0)
 D ACTLOG^GMRCSLM4(+GMRCO)
"RTN","GMRCSLM2",123,0)
 ; any inter-facility results?
"RTN","GMRCSLM2",124,0)
 I $P(GMRCO(0),"^",23) D
"RTN","GMRCSLM2",125,0)
 . N GMRCIFRS,X S GMRCIFRS=0,X=""
"RTN","GMRCSLM2",126,0)
 . F  S X=$O(^GMR(123,GMRCO,51,"B",X)) Q:X=""  S GMRCIFRS=GMRCIFRS+1
"RTN","GMRCSLM2",127,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",128,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Inter-facility Results: "_$S(GMRCIFRS>0:"Results are available via Display Results action.",1:"No results available for this consult request."),GMRCCT=GMRCCT+2
"RTN","GMRCSLM2",129,0)
 ;get local results
"RTN","GMRCSLM2",130,0)
 D GETRSLT^GMRCART($NA(^TMP("GMRCRT",$J)),1)
"RTN","GMRCSLM2",131,0)
 N NXT S NXT=0
"RTN","GMRCSLM2",132,0)
 F  S NXT=$O(^TMP("GMRCRT",$J,NXT)) Q:'NXT  D
"RTN","GMRCSLM2",133,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$G(^TMP("GMRCRT",$J,NXT,0))
"RTN","GMRCSLM2",134,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM2",135,0)
 . Q
"RTN","GMRCSLM2",136,0)
 K ^TMP("GMRCRT",$J)
"RTN","GMRCSLM2",137,0)
 I $S('$D(GMRCOER):1,'GMRCOER:1,1:0),$D(VALMAR) D CLEAN^VALM10
"RTN","GMRCSLM2",138,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",$P(^(0),"=",80)="",^(0)=$E(^(0),1,36)_" END "_$E(^(0),43,80)
"RTN","GMRCSLM2",139,0)
DTQ K X,LN,PL,TO,WP,FLG,SEX,STS,URG,WRD,BKLN,DATA,WRD,PROC,LINE,GMRC(0),GMRC(40),GMRCD,GMRCDVDL,GMRCO,GMRCAR,GMRCRB,GMRCLA,GMRCSR,GMRCTO,MCFILE,MCPROC,DSPLINE,GMRCLA1,GMRCPRNM,GMRCPROC,GMRCTYPE,GMRCWARD
"RTN","GMRCSLM2",140,0)
 I $D(GMRCOER),'GMRCOER D:$D(VALMEVL) KILL^VALM10() D:$D(VALMAR) CLEAN^VALM10
"RTN","GMRCSLM2",141,0)
 Q
"RTN","GMRCSLM4")
0^19^B35674872
"RTN","GMRCSLM4",1,0)
GMRCSLM4 ;SLC/DCM - List Manager routine - Activity Log Detailed Display ;1/28/99 10:30
"RTN","GMRCSLM4",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,15,22**;DEC 27,1997
"RTN","GMRCSLM4",3,0)
 ;
"RTN","GMRCSLM4",4,0)
 ; This routine invokes IA #3138
"RTN","GMRCSLM4",5,0)
 ;
"RTN","GMRCSLM4",6,0)
ACTLOG(GMRCO) ;Print activity log
"RTN","GMRCSLM4",7,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",8,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Facility",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",9,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=" Activity"_$E(TAB,1,16)_"Date/Time/Zone"_$E(TAB,1,6)_"Responsible Person"_$E(TAB,1,2)_"Entered By",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",10,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$$REPEAT^XLFSTR("-",79),GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",11,0)
 N GMRCD,GMRCDA
"RTN","GMRCSLM4",12,0)
 S GMRCD=0 F  S GMRCD=$O(^GMR(123,+GMRCO,40,"B",GMRCD)) Q:'GMRCD  S GMRCDA="" F  S GMRCDA=$O(^GMR(123,+GMRCO,40,"B",GMRCD,GMRCDA)) Q:'GMRCDA  D BLDALN(GMRCO,GMRCDA)
"RTN","GMRCSLM4",13,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",14,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="Note: TIME ZONE is local if not indicated",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",15,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",16,0)
 Q
"RTN","GMRCSLM4",17,0)
 ;
"RTN","GMRCSLM4",18,0)
BLDALN(GMRCO,GMRCDA) ;Build Activity Log Lines for an activity
"RTN","GMRCSLM4",19,0)
 ; GMRCO=  consult internal entry number
"RTN","GMRCSLM4",20,0)
 ; GMRCDA= activity internal entry number
"RTN","GMRCSLM4",21,0)
 N GMRCACT,GMRCSLN,XDT1,XDT2,FLG,LN,LINE,DASH,X,GMRCX,GMRCDEV,GMRCISIT
"RTN","GMRCSLM4",22,0)
 S GMRCDA(0)=^GMR(123,+GMRCO,40,GMRCDA,0)
"RTN","GMRCSLM4",23,0)
 S GMRCACT=$P(GMRCDA(0),"^",2)
"RTN","GMRCSLM4",24,0)
 S GMRCDA(2)=$G(^GMR(123,+GMRCO,40,GMRCDA,2))
"RTN","GMRCSLM4",25,0)
 S GMRCDA(3)=$G(^GMR(123,+GMRCO,40,GMRCDA,3))
"RTN","GMRCSLM4",26,0)
 I $D(^GMR(123,GMRCO,40,GMRCDA,2)) D
"RTN","GMRCSLM4",27,0)
 . S GMRCISIT=$P(^GMR(123,GMRCO,0),U,23) Q:'GMRCISIT
"RTN","GMRCSLM4",28,0)
 . S GMRCISIT=$$GET1^DIQ(4,GMRCISIT,.01)
"RTN","GMRCSLM4",29,0)
 D BLDLN1
"RTN","GMRCSLM4",30,0)
 D BLDLN2
"RTN","GMRCSLM4",31,0)
 D BLDCMTS
"RTN","GMRCSLM4",32,0)
 Q
"RTN","GMRCSLM4",33,0)
 ;
"RTN","GMRCSLM4",34,0)
BLDLN1 ;Build the first line for the activity
"RTN","GMRCSLM4",35,0)
 ;GMRCX is scratch pad variable
"RTN","GMRCSLM4",36,0)
 I $L($G(GMRCISIT)) D
"RTN","GMRCSLM4",37,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCISIT
"RTN","GMRCSLM4",38,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",39,0)
 S GMRCX=$P($G(^GMR(123.1,+GMRCACT,0)),"^",1)
"RTN","GMRCSLM4",40,0)
 S:'$L(GMRCX) GMRCX=GMRCACT_" action?"
"RTN","GMRCSLM4",41,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=" "_GMRCX
"RTN","GMRCSLM4",42,0)
 ;
"RTN","GMRCSLM4",43,0)
 ;Add to line for Printed to (action 22) when device name <13 characters
"RTN","GMRCSLM4",44,0)
 I GMRCACT=22 D
"RTN","GMRCSLM4",45,0)
 . S GMRCDEV=$$GET1^DIQ(3.5,+$P(GMRCDA(0),"^",8),.01)
"RTN","GMRCSLM4",46,0)
 . I '$L(GMRCDEV) S GMRCDEV=$P(GMRCDA(0),"^",8)
"RTN","GMRCSLM4",47,0)
 . I $L(GMRCDEV)<13 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=^TMP("GMRCR",$J,"DT",GMRCCT,0)_" "_GMRCDEV K GMRCDEV
"RTN","GMRCSLM4",48,0)
 ;
"RTN","GMRCSLM4",49,0)
 ;Add on generic fields that apply to every activity
"RTN","GMRCSLM4",50,0)
 ;Date/time of Actual Activity, Who's Responsible for Activity,
"RTN","GMRCSLM4",51,0)
 ;and Who entered activity
"RTN","GMRCSLM4",52,0)
 S X=$P(GMRCDA(0),"^",3) D REGDTM^GMRCU S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=$S($D(^TMP("GMRCR",$J,"DT",GMRCCT,0)):^TMP("GMRCR",$J,"DT",GMRCCT,0)_$E(TAB,1,25-$L(^(0)))_X,1:X)_$E(TAB)_$S($P(GMRCDA(2),"^",3)]"":$P(GMRCDA(2),"^",3),1:$E(TAB,1,3))
"RTN","GMRCSLM4",53,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=^TMP("GMRCR",$J,"DT",GMRCCT,0)_$E(TAB,1,45-$L(^(0)))_$S($P(GMRCDA(2),"^",2)]"":$E($P(GMRCDA(2),"^",2),1,17),$P(GMRCDA(0),"^",4):$E($P($G(^VA(200,$P(GMRCDA(0),"^",4),0)),"^"),1,17),1:$E(TAB,1,18))
"RTN","GMRCSLM4",54,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=^TMP("GMRCR",$J,"DT",GMRCCT,0)_$E(TAB,1,65-$L(^(0)))_$S($P(GMRCDA(2),"^")]"":$E($P(GMRCDA(2),"^"),1,17),$P(GMRCDA(0),"^",5):$E($P($G(^VA(200,$P(GMRCDA(0),"^",5),0)),"^"),1,17),1:$E(TAB,1,17))
"RTN","GMRCSLM4",55,0)
 S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",56,0)
 Q
"RTN","GMRCSLM4",57,0)
 ;
"RTN","GMRCSLM4",58,0)
BLDLN2 ;SECOND line for activity
"RTN","GMRCSLM4",59,0)
 N GMRCSLN S GMRCSLN="" ;saved SECOND line
"RTN","GMRCSLM4",60,0)
 ;
"RTN","GMRCSLM4",61,0)
 ; Check if the entry date and specified actual date are different
"RTN","GMRCSLM4",62,0)
 S XDT1=$P(GMRCDA(0),"^",1),XDT2=$P(GMRCDA(0),"^",3),GMRCX=0
"RTN","GMRCSLM4",63,0)
 S:XDT2>XDT1 X=XDT1,XDT1=XDT2,XDT2=X
"RTN","GMRCSLM4",64,0)
 S GMRCDIF=$$FMDIFF^XLFDT(XDT1,XDT2,3)
"RTN","GMRCSLM4",65,0)
 I $L(GMRCDIF) D
"RTN","GMRCSLM4",66,0)
 . I +$P(GMRCDIF," ",1)>0 S GMRCX=1 Q  ;Check Days
"RTN","GMRCSLM4",67,0)
 . S GMRCDIF=$P(GMRCDIF," ",2)
"RTN","GMRCSLM4",68,0)
 . I +$P(GMRCDIF,":",1)>0 S GMRCX=1 Q  ;Check Hours
"RTN","GMRCSLM4",69,0)
 . I +$P(GMRCDIF,":",2)>1 S GMRCX=1 Q  ;Check Minutes
"RTN","GMRCSLM4",70,0)
 . Q
"RTN","GMRCSLM4",71,0)
 I GMRCX D
"RTN","GMRCSLM4",72,0)
 . S X=$P(GMRCDA(0),"^",1) D REGDTM^GMRCU
"RTN","GMRCSLM4",73,0)
 . S GMRCSLN=$E(GMRCSLN_TAB,1,15)_"(entered) "_X_$E(TAB)_$S($P(GMRCDA(2),"^",3)]"":$P(GMRCDA(2),"^",3),1:$E(TAB,1,3))
"RTN","GMRCSLM4",74,0)
 . Q
"RTN","GMRCSLM4",75,0)
 ;
"RTN","GMRCSLM4",76,0)
 I $L(GMRCSLN) D  S GMRCSLN=""
"RTN","GMRCSLM4",77,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCSLN
"RTN","GMRCSLM4",78,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",79,0)
 . Q
"RTN","GMRCSLM4",80,0)
 ;
"RTN","GMRCSLM4",81,0)
 ;Get local Incomplete Report and Complete result # for second line of action
"RTN","GMRCSLM4",82,0)
 I +$P(GMRCDA(0),"^",9) D
"RTN","GMRCSLM4",83,0)
 . I $P($P(GMRCDA(0),"^",9),";",2)["TIU" D  Q
"RTN","GMRCSLM4",84,0)
 .. S GMRCSLN=$E(TAB,1,5)_"Note# "_+$P(GMRCDA(0),"^",9)
"RTN","GMRCSLM4",85,0)
 . I $P($P(GMRCDA(0),"^",9),";",2)["MCAR" D  Q
"RTN","GMRCSLM4",86,0)
 .. N MCFILE S MCFILE=+$P($P(GMRCDA(0),"^",9),"MCAR(",2) Q:'MCFILE
"RTN","GMRCSLM4",87,0)
 .. N MCPRDT S MCPRDT=$$GET1^DIQ(MCFILE,+$P(GMRCDA(0),"^",9),.01)
"RTN","GMRCSLM4",88,0)
 .. Q:'$L(MCPRDT)
"RTN","GMRCSLM4",89,0)
 .. S GMRCSLN=$E(TAB,1,5)_"Medicine Procedure performed: "_MCPRDT
"RTN","GMRCSLM4",90,0)
 ;
"RTN","GMRCSLM4",91,0)
 ;Get remote Incomplete Report and Complete result # for second line of action
"RTN","GMRCSLM4",92,0)
 I +$P(GMRCDA(2),"^",4) D
"RTN","GMRCSLM4",93,0)
 . N GMRCRR S GMRCRR=$P(GMRCDA(2),"^",4)
"RTN","GMRCSLM4",94,0)
 . S GMRCSLN=$E(TAB,1,5)_"Remote "_$P(GMRCRR,";",3)_" #"_+$P(GMRCRR,";")_" from "_$P($G(^DIC(4,+$P(GMRCRR,";",4),0)),"^")
"RTN","GMRCSLM4",95,0)
 ;
"RTN","GMRCSLM4",96,0)
 ;If GMRCDEV is defined, then print the device name on the second line
"RTN","GMRCSLM4",97,0)
 I GMRCACT=22,$D(GMRCDEV) D
"RTN","GMRCSLM4",98,0)
 . S GMRCSLN=$E(TAB,1,5)_$E(GMRCDEV,1,17) K GMRCDEV
"RTN","GMRCSLM4",99,0)
 ;
"RTN","GMRCSLM4",100,0)
 ;Build line for forwarded to (action 17)
"RTN","GMRCSLM4",101,0)
 I GMRCACT=17 D
"RTN","GMRCSLM4",102,0)
 . S GMRCX=$S(+$P(GMRCDA(0),"^",6):$P($G(^GMR(123.5,+$P(GMRCDA(0),"^",6),0)),"^"),$P(GMRCDA(3),"^")]"":$P(GMRCDA(3),"^"),1:" ??")
"RTN","GMRCSLM4",103,0)
 . S GMRCSLN=$E(TAB,1,5)_GMRCX
"RTN","GMRCSLM4",104,0)
 I GMRCACT=25 D
"RTN","GMRCSLM4",105,0)
 . S GMRCX=""
"RTN","GMRCSLM4",106,0)
 . I $P(^GMR(123,+GMRCO,12),U,5)="F" D
"RTN","GMRCSLM4",107,0)
 .. S GMRCX="Previous remote service name: "
"RTN","GMRCSLM4",108,0)
 . S GMRCX=GMRCX_$S(+$P(GMRCDA(0),"^",6):$P($G(^GMR(123.5,+$P(GMRCDA(0),"^",6),0)),"^"),$P(GMRCDA(3),"^")]"":$P(GMRCDA(3),"^"),1:" ??")
"RTN","GMRCSLM4",109,0)
 . S GMRCSLN=$E(TAB,1,5)_GMRCX
"RTN","GMRCSLM4",110,0)
 I $L(GMRCSLN) D
"RTN","GMRCSLM4",111,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=GMRCSLN
"RTN","GMRCSLM4",112,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",113,0)
 . Q
"RTN","GMRCSLM4",114,0)
 ;
"RTN","GMRCSLM4",115,0)
 Q
"RTN","GMRCSLM4",116,0)
 ;
"RTN","GMRCSLM4",117,0)
BLDCMTS ;Build lines for Comment activity.
"RTN","GMRCSLM4",118,0)
 I GMRCACT=11 D BLDCMT Q
"RTN","GMRCSLM4",119,0)
 ;
"RTN","GMRCSLM4",120,0)
 ;Build lines for general comments on any activity
"RTN","GMRCSLM4",121,0)
 I $D(^GMR(123,+GMRCO,40,+GMRCDA,1)) D  Q
"RTN","GMRCSLM4",122,0)
 . S LN=$O(^GMR(123,+GMRCO,40,+GMRCDA,1,0)) Q:'+LN
"RTN","GMRCSLM4",123,0)
 . ;Check for edited fields generated text with lines <75 characters
"RTN","GMRCSLM4",124,0)
 . I $G(^GMR(123,+GMRCO,40,+GMRCDA,1,LN,0))["EDITED FIELDS" D BLDCMT Q
"RTN","GMRCSLM4",125,0)
 . D BLDCMT
"RTN","GMRCSLM4",126,0)
 . Q
"RTN","GMRCSLM4",127,0)
 . I $L($G(^GMR(123,+GMRCO,40,+GMRCDA,1,LN,0)))'>75 D BLDCMT Q
"RTN","GMRCSLM4",128,0)
 . ;Use utilities for long line formating
"RTN","GMRCSLM4",129,0)
 . S FLG=1,LINE="     "
"RTN","GMRCSLM4",130,0)
 . D WPSET^GMRCUTIL("^GMR(123,+GMRCO,40,GMRCDA,1)","^TMP(""GMRCR"",$J,""DT"")",LINE,.GMRCCT,TAB,FLG)
"RTN","GMRCSLM4",131,0)
 . D BLDASH
"RTN","GMRCSLM4",132,0)
 . Q
"RTN","GMRCSLM4",133,0)
 Q
"RTN","GMRCSLM4",134,0)
 ;
"RTN","GMRCSLM4",135,0)
BLDCMT ;Build comment lines
"RTN","GMRCSLM4",136,0)
 ;DASH is 1 or "" for print dash line after comment
"RTN","GMRCSLM4",137,0)
 S LN=0
"RTN","GMRCSLM4",138,0)
 F  S LN=$O(^GMR(123,+GMRCO,40,+GMRCDA,1,LN)) Q:'+LN  D
"RTN","GMRCSLM4",139,0)
 . S ^TMP("GMRCR",$J,"DT",GMRCCT,0)=^GMR(123,+GMRCO,40,GMRCDA,1,LN,0) ;$P(^GMR(123,+GMRCO,40,GMRCDA,1,LN,0),"^",1)
"RTN","GMRCSLM4",140,0)
 . S GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",141,0)
 . Q
"RTN","GMRCSLM4",142,0)
 ;D BLDASH
"RTN","GMRCSLM4",143,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",144,0)
 Q
"RTN","GMRCSLM4",145,0)
 ;
"RTN","GMRCSLM4",146,0)
BLDASH ;Build separater line with dashes
"RTN","GMRCSLM4",147,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",$P(^(0),"-",80)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",148,0)
 S ^TMP("GMRCR",$J,"DT",GMRCCT,0)="",GMRCCT=GMRCCT+1
"RTN","GMRCSLM4",149,0)
 Q
"RTN","GMRCSTL1")
0^16^B16566727
"RTN","GMRCSTL1",1,0)
GMRCSTL1 ;SLC/DCM,dee;MA - List Manager Format Routine - Get Active Consults by service - pending,active,scheduled,incomplete,etc. ;4/18/01  10:30
"RTN","GMRCSTL1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**7,21,22**;DEC 27, 1997
"RTN","GMRCSTL1",3,0)
 ; Patch #21 changed array GMRCTOT to ^TMP("GMRCTOT,$J)
"RTN","GMRCSTL1",4,0)
 ; This routine invokes IA #875, #2638
"RTN","GMRCSTL1",5,0)
 Q
"RTN","GMRCSTL1",6,0)
STATNAME(STATUS) ;Return the name for the status number
"RTN","GMRCSTL1",7,0)
 I STATUS<9 Q $S(STATUS=1:"Discont.",STATUS=2:"Completed",STATUS=3:"On Hold",STATUS=4:"Flagged",STATUS=5:"Pending",STATUS=6:"Active",STATUS=7:"Expired",STATUS=8:"Scheduled",1:"No Status")
"RTN","GMRCSTL1",8,0)
 E  Q $S(STATUS=9:"Incomplete",STATUS=10:"Delayed",STATUS=11:"Unreleased",STATUS=12:"Discont/Ed",STATUS=13:"Cancelled",STATUS=14:"Lapsed",STATUS=15:"Renewed",1:"No Status")
"RTN","GMRCSTL1",9,0)
 Q
"RTN","GMRCSTL1",10,0)
 ;
"RTN","GMRCSTL1",11,0)
STATABBR(STATUS) ;Return the name for the status number
"RTN","GMRCSTL1",12,0)
 Q ^ORD(100.01,STATUS,.1)
"RTN","GMRCSTL1",13,0)
 ;
"RTN","GMRCSTL1",14,0)
LISTTOT(COUNT,GEN,INDEX,NAME,GROUPNAM,CONTROL,ARRN) ;
"RTN","GMRCSTL1",15,0)
 N LOOP,STATUS,STS,CTRLTEMP
"RTN","GMRCSTL1",16,0)
 S CTRLTEMP=$S(CONTROL#2:"^",1:"")
"RTN","GMRCSTL1",17,0)
 I GEN=2 D
"RTN","GMRCSTL1",18,0)
 . S COUNT=COUNT+1
"RTN","GMRCSTL1",19,0)
 . S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP
"RTN","GMRCSTL1",20,0)
 . S COUNT=COUNT+1
"RTN","GMRCSTL1",21,0)
 . S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"          GROUPER: "_NAME_" Totals:"
"RTN","GMRCSTL1",22,0)
 F LOOP=1:1:$L(GMRCSTAT,",") S STATUS=$P(GMRCSTAT,",",LOOP) I ^TMP("GMRCTOT",$J,GEN,INDEX,STATUS)>0 D
"RTN","GMRCSTL1",23,0)
 .S COUNT=COUNT+1
"RTN","GMRCSTL1",24,0)
 .S STS=$$STATNAME(STATUS)
"RTN","GMRCSTL1",25,0)
 .I GEN=1 S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"To Service "_NAME_" Total Requests "_STS_$J(^TMP("GMRCTOT",$J,1,INDEX,STATUS),6,0)
"RTN","GMRCSTL1",26,0)
 .E  S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"To Grouper "_NAME_" Total Requests "_STS_$J(^TMP("GMRCTOT",$J,2,INDEX,STATUS),6,0)
"RTN","GMRCSTL1",27,0)
 ;If any printed are pending then print the total that are pending for all pending status.
"RTN","GMRCSTL1",28,0)
 I ^TMP("GMRCTOT",$J,GEN,INDEX,"P")>0 D
"RTN","GMRCSTL1",29,0)
 .S COUNT=COUNT+1
"RTN","GMRCSTL1",30,0)
 .I GEN=1 S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"Total Requests Pending Resolution To Service "_NAME_": "_$J(^TMP("GMRCTOT",$J,1,INDEX,"P"),6,0)
"RTN","GMRCSTL1",31,0)
 .E  S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"Total Requests Pending Resolution To Grouper "_NAME_": "_$J(^TMP("GMRCTOT",$J,2,INDEX,"P"),6,0)
"RTN","GMRCSTL1",32,0)
 ; IF Consults
"RTN","GMRCSTL1",33,0)
 I ARRN="IFC" D
"RTN","GMRCSTL1",34,0)
 .N IRFN,VALSVC,VALTOT S IRFN=""
"RTN","GMRCSTL1",35,0)
 .F  S IRFN=$O(^TMP("GMRCTOT",$J,GEN,INDEX,"F",IRFN)) Q:IRFN=""  D
"RTN","GMRCSTL1",36,0)
 ..S COUNT=COUNT+1
"RTN","GMRCSTL1",37,0)
 ..I GEN=1 S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"Total Requests To Service "_$E(NAME,1,16)_" @ "_$E(IRFN,1,16)_": "_$J(^TMP("GMRCTOT",$J,1,INDEX,"F",IRFN),6,0)
"RTN","GMRCSTL1",38,0)
 ..E  S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"Total Requests to Grouper "_$E(NAME,1,20)_" @ "_$E(IRFN,1,20)_": "_$J(^TMP("GMRCTOT",$J,2,INDEX,"F",IRFN),6,0)
"RTN","GMRCSTL1",39,0)
 ..I $P($G(GMRCST(GEN,INDEX,IRFN)),"^",2)>0 D
"RTN","GMRCSTL1",40,0)
 ...S COUNT=COUNT+1
"RTN","GMRCSTL1",41,0)
 ...S VALSVC=$P(GMRCST(GEN,INDEX,IRFN),"^")\$P(GMRCST(GEN,INDEX,IRFN),"^",2)
"RTN","GMRCSTL1",42,0)
 ...S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"Mean Days Completed To "_$S(GEN=1:"Service ",1:"Grouper ")_$E(NAME,1,20)_" @ "_$E(IRFN,1,20)_": "_$J(VALSVC,4,0)
"RTN","GMRCSTL1",43,0)
 .I $P($G(GMRCST(GEN,INDEX)),"^",2)>0 D
"RTN","GMRCSTL1",44,0)
 ..S COUNT=COUNT+1
"RTN","GMRCSTL1",45,0)
 ..S VALTOT=$P(GMRCST(GEN,INDEX),"^")\$P(GMRCST(GEN,INDEX),"^",2)
"RTN","GMRCSTL1",46,0)
 ..S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"Mean Days Completed To "_$S(GEN=1:"Service ",1:"Grouper ")_$E(NAME,1,20)_": "_$J(VALTOT,4,0)
"RTN","GMRCSTL1",47,0)
 S COUNT=COUNT+1
"RTN","GMRCSTL1",48,0)
 I GEN=1 S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"Total Requests To Service "_NAME_": "_$J(^TMP("GMRCTOT",$J,1,INDEX,"T"),6,0)
"RTN","GMRCSTL1",49,0)
 E  S ^TMP("GMRCR",$J,ARRN,COUNT,0)=CTRLTEMP_"Total Requests To Grouper "_NAME_": "_$J(^TMP("GMRCTOT",$J,2,INDEX,"T"),6,0)
"RTN","GMRCSTL1",50,0)
 Q
"RTN","GMRCSTL1",51,0)
 ;
"RTN","GMRCSTL2")
0^14^B30799061
"RTN","GMRCSTL2",1,0)
GMRCSTL2 ;SLC/DCM,dee;MA - List Manager Format Routine - Get Active Consults by service - pending,active,scheduled,incomplete,etc. ;4/18/01  10:31
"RTN","GMRCSTL2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**7,21,22**;DEC 27, 1997
"RTN","GMRCSTL2",3,0)
 ; Patch #21 changed array GMRCTOT to ^TMP("GMRCTOT",$J)
"RTN","GMRCSTL2",4,0)
 ; Patch #21 also added a plus sign to the $P when setting
"RTN","GMRCSTL2",5,0)
 ; GMRCDLA to check for a NULL value.
"RTN","GMRCSTL2",6,0)
 ; This routine invokes IA #10035,#44, #10040
"RTN","GMRCSTL2",7,0)
 Q
"RTN","GMRCSTL2",8,0)
 ;
"RTN","GMRCSTL2",9,0)
ONESTAT(GMRCARRN) ;Process one status
"RTN","GMRCSTL2",10,0)
 ; Input -- GMRCARRN  List Template Array Name (Subscript)
"RTN","GMRCSTL2",11,0)
 ;          Values:
"RTN","GMRCSTL2",12,0)
 ;          "CP": pending consults; "IFC": inter-facility consults
"RTN","GMRCSTL2",13,0)
 ; Output - None
"RTN","GMRCSTL2",14,0)
 S ^TMP("GMRCTOT",$J,1,GMRCSVC,STATUS)=0
"RTN","GMRCSTL2",15,0)
 S ^TMP("GMRCTOT",$J,2,GMRCSVC,STATUS)=0
"RTN","GMRCSTL2",16,0)
 S GMRCXDT=$S(GMRCDT1="ALL":0,1:9999999-GMRCDT2-.6)
"RTN","GMRCSTL2",17,0)
 F  S GMRCXDT=$O(^GMR(123,"AE",GMRCSVC,STATUS,GMRCXDT)) Q:GMRCXDT=""!(GMRCXDT>(9999999-GMRCDT1))  D
"RTN","GMRCSTL2",18,0)
 .S GMRCPT=0
"RTN","GMRCSTL2",19,0)
ONE .;Loop for one consult at a time
"RTN","GMRCSTL2",20,0)
 .F  S GMRCPT=$O(^GMR(123,"AE",GMRCSVC,STATUS,GMRCXDT,GMRCPT)) Q:GMRCPT=""  D
"RTN","GMRCSTL2",21,0)
 ..; Check for bad "AE" x-ref
"RTN","GMRCSTL2",22,0)
 ..I '$D(^GMR(123,GMRCPT,0)) D  Q
"RTN","GMRCSTL2",23,0)
 ...K ^GMR(123,"AE",GMRCSVC,STATUS,GMRCXDT,GMRCPT)
"RTN","GMRCSTL2",24,0)
 ..S X=9999999-GMRCXDT
"RTN","GMRCSTL2",25,0)
 ..D REGDTM^GMRCU
"RTN","GMRCSTL2",26,0)
 ..S GMRCDT=$P(X," ",1)
"RTN","GMRCSTL2",27,0)
 ..S GMRCDLA=$P(X," ",1)
"RTN","GMRCSTL2",28,0)
 ..S GMRCD(0)=^GMR(123,GMRCPT,0)
"RTN","GMRCSTL2",29,0)
 ..I GMRCARRN="IFC" D  Q:'GMRCCK
"RTN","GMRCSTL2",30,0)
 ...S GMRCCK=1
"RTN","GMRCSTL2",31,0)
 ...S:'$D(GMRCIS) GMRCCK=0 S:'$P($G(GMRCD(0)),"^",23) GMRCCK=0
"RTN","GMRCSTL2",32,0)
 ...I GMRCCK=1 D
"RTN","GMRCSTL2",33,0)
 ....S GMRCD(12)=$G(^GMR(123,GMRCPT,12))
"RTN","GMRCSTL2",34,0)
 ....I GMRCIS="R",$P(GMRCD(12),"^",5)'="P" S GMRCCK=0
"RTN","GMRCSTL2",35,0)
 ....I GMRCIS="C",$P(GMRCD(12),"^",5)'="F" S GMRCCK=0
"RTN","GMRCSTL2",36,0)
 ....I $D(GMRCREMP),$P(GMRCD(12),"^",6)'=GMRCREMP S GMRCCK=0
"RTN","GMRCSTL2",37,0)
 ....I $D(GMRCRF),$P($G(GMRCD(0)),"^",23)'=GMRCRF S GMRCCK=0
"RTN","GMRCSTL2",38,0)
 ..S GMRCPTN=$P(^DPT($P(GMRCD(0),"^",2),0),"^",1)
"RTN","GMRCSTL2",39,0)
 ..S GMRCPTN=$P(GMRCPTN,",",1)_","_$E($P(GMRCPTN,",",2),1)_"."
"RTN","GMRCSTL2",40,0)
 ..S GMRCPTSN="("_$E($P(^DPT($P(GMRCD(0),"^",2),0),"^",9),6,9)_")"
"RTN","GMRCSTL2",41,0)
 ..; IF Consults
"RTN","GMRCSTL2",42,0)
 ..I GMRCARRN="IFC" D
"RTN","GMRCSTL2",43,0)
 ...N GMRCIRF,RCVDT,COMPLDT,ND
"RTN","GMRCSTL2",44,0)
 ...S GMRCIRFN="NONE",GMRCIDD="N/A",GMRCRDT=""
"RTN","GMRCSTL2",45,0)
 ...S GMRCIRF=$P($G(GMRCD(0)),"^",23)
"RTN","GMRCSTL2",46,0)
 ... I GMRCIRF S GMRCIRFN=$E($$GET1^DIQ(4,GMRCIRF,.01),1,16)
"RTN","GMRCSTL2",47,0)
 ...I '$D(^TMP("GMRCTOT",$J,1,GMRCSVC,"F",GMRCIRFN)) D
"RTN","GMRCSTL2",48,0)
 ....S ^TMP("GMRCTOT",$J,1,GMRCSVC,"F",GMRCIRFN)=0
"RTN","GMRCSTL2",49,0)
 ....S GMRCST(1,GMRCSVC,GMRCIRFN)="0^0"
"RTN","GMRCSTL2",50,0)
 ...D GETDT^GMRCSTU(GMRCPT)
"RTN","GMRCSTL2",51,0)
 ...I COMPLDT<9999999,$S(GMRCDT1="ALL":1,RCVDT'<GMRCDT1&(RCVDT'>GMRCDT2):1,1:0) D
"RTN","GMRCSTL2",52,0)
 ....S X1=COMPLDT,X2=RCVDT D ^%DTC
"RTN","GMRCSTL2",53,0)
 ....S GMRCIDD=X
"RTN","GMRCSTL2",54,0)
 ...I GMRCIS="C" D
"RTN","GMRCSTL2",55,0)
 ....S GMRCRDT=$$GETRDT(GMRCPT)
"RTN","GMRCSTL2",56,0)
 ....I GMRCRDT]"" D
"RTN","GMRCSTL2",57,0)
 .....N X
"RTN","GMRCSTL2",58,0)
 .....S X=GMRCRDT D REGDT^GMRCU
"RTN","GMRCSTL2",59,0)
 .....S GMRCRDT=X
"RTN","GMRCSTL2",60,0)
 ..S GMRCD=0
"RTN","GMRCSTL2",61,0)
 ..S GMRCD=$O(^GMR(123,GMRCPT,40,"B",GMRCD))
"RTN","GMRCSTL2",62,0)
 ..I GMRCD]"" D
"RTN","GMRCSTL2",63,0)
 ...S GMRCDA=""
"RTN","GMRCSTL2",64,0)
 ...S GMRCDA=$O(^GMR(123,+GMRCPT,40,"B",GMRCD,GMRCDA))
"RTN","GMRCSTL2",65,0)
 ..S GMRCDLA=$E($P($G(^GMR(123.1,+$P(GMRCD(0),"^",13),0)),"^"),1,19)
"RTN","GMRCSTL2",66,0)
 ..S GMRCLOC=$P(GMRCD(0),"^",4)
"RTN","GMRCSTL2",67,0)
 ..S:$L(GMRCLOC) GMRCLOC=$P($G(^SC(GMRCLOC,0)),"^",1) ;DBIA#10040
"RTN","GMRCSTL2",68,0)
 ..I '$L(GMRCLOC),$P(GMRCD(0),U,21) D
"RTN","GMRCSTL2",69,0)
 ...S GMRCLOC=$$GET1^DIQ(4,$P(GMRCD(0),U,21),.01)
"RTN","GMRCSTL2",70,0)
 ..I '$L(GMRCLOC),$P(GMRCD(0),U,23) D
"RTN","GMRCSTL2",71,0)
 ...S GMRCLOC=$$GET1^DIQ(4,$P(GMRCD(0),U,23),.01)
"RTN","GMRCSTL2",72,0)
 ..I GMRCARRN="IFC",$L(GMRCLOC) D
"RTN","GMRCSTL2",73,0)
 ...S GMRCLOC=$E(GMRCLOC,1,23)
"RTN","GMRCSTL2",74,0)
 ..I ^TMP("GMRCTOT",$J,1,GMRCSVC,"T")=0 D
"RTN","GMRCSTL2",75,0)
 ...S GMRCCT=GMRCCT+1
"RTN","GMRCSTL2",76,0)
 ...S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=CTRLTEMP
"RTN","GMRCSTL2",77,0)
 ...S GMRCCT=GMRCCT+1
"RTN","GMRCSTL2",78,0)
 ...S TEMP="SERVICE: "_GMRCSVCP
"RTN","GMRCSTL2",79,0)
 ...S:GMRCSVCG>0 TEMP=TEMP_" in Group: "_$P(^GMR(123.5,GMRCSVCG,0),"^",1)
"RTN","GMRCSTL2",80,0)
 ...S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=CTRLTEMP_TEMP
"RTN","GMRCSTL2",81,0)
 ...S NUMCLIN=NUMCLIN+1
"RTN","GMRCSTL2",82,0)
 ..S LINETEMP=""
"RTN","GMRCSTL2",83,0)
CTRL ..I GMRCCTRL#100\10 D
"RTN","GMRCSTL2",84,0)
 ...I GMRCCTRL#100\10=1 D
"RTN","GMRCSTL2",85,0)
 ....S GMRCLINE=GMRCLINE+1
"RTN","GMRCSTL2",86,0)
 ....S ^TMP("GMRCRINDEX",$J,GMRCLINE)=GMRCPT
"RTN","GMRCSTL2",87,0)
 ....S LINETEMP=$J(GMRCLINE,4)_" "
"RTN","GMRCSTL2",88,0)
 ...E  S LINETEMP=$J(GMRCPT,9)_" "
"RTN","GMRCSTL2",89,0)
 ..I GMRCCTRL#2 S LINETEMP=GMRCPT_"^"_LINETEMP
"RTN","GMRCSTL2",90,0)
 ..I GMRCCTRL#1000\100 D
"RTN","GMRCSTL2",91,0)
 ...S STS=$$STATABBR^GMRCSTL1(STATUS)
"RTN","GMRCSTL2",92,0)
 ...S STS=STS_$J("",4-$L(STS)+1)
"RTN","GMRCSTL2",93,0)
 ..E  D
"RTN","GMRCSTL2",94,0)
 ...S STS=$$STATNAME^GMRCSTL1(STATUS)
"RTN","GMRCSTL2",95,0)
 ...S STS=STS_$J("",10-$L(STS)+1)
"RTN","GMRCSTL2",96,0)
 ..S GMRCCT=GMRCCT+1
"RTN","GMRCSTL2",97,0)
 ..S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=LINETEMP_STS_GMRCDLA_$J("",20-$L(GMRCDLA))_GMRCDT_" "_GMRCPTN_" "_GMRCPTSN_$J("",12-$L(GMRCPTN)+5)_GMRCLOC
"RTN","GMRCSTL2",98,0)
 ..; IF Consults
"RTN","GMRCSTL2",99,0)
 ..I GMRCARRN="IFC" D
"RTN","GMRCSTL2",100,0)
 ...S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)_$J("",25-$L(GMRCLOC))_GMRCIRFN_$J("",17-$L(GMRCIRFN))_" "_GMRCIDD_$J("",9-$L(GMRCIDD))_"  "_GMRCRDT
"RTN","GMRCSTL2",101,0)
 ...S ^TMP("GMRCTOT",$J,1,GMRCSVC,"F",GMRCIRFN)=^TMP("GMRCTOT",$J,1,GMRCSVC,"F",GMRCIRFN)+1
"RTN","GMRCSTL2",102,0)
 ...I GMRCIDD'="N/A" D
"RTN","GMRCSTL2",103,0)
 ....S $P(GMRCST(1,GMRCSVC,GMRCIRFN),"^")=$P(GMRCST(1,GMRCSVC,GMRCIRFN),"^")+GMRCIDD
"RTN","GMRCSTL2",104,0)
 ....S $P(GMRCST(1,GMRCSVC,GMRCIRFN),"^",2)=$P(GMRCST(1,GMRCSVC,GMRCIRFN),"^",2)+1
"RTN","GMRCSTL2",105,0)
 ....S $P(GMRCST(1,GMRCSVC),"^")=$P(GMRCST(1,GMRCSVC),"^")+GMRCIDD
"RTN","GMRCSTL2",106,0)
 ....S $P(GMRCST(1,GMRCSVC),"^",2)=$P(GMRCST(1,GMRCSVC),"^",2)+1
"RTN","GMRCSTL2",107,0)
 ..;
"RTN","GMRCSTL2",108,0)
ADDTOT ..;Add to totals
"RTN","GMRCSTL2",109,0)
 ..;  for all status for this service
"RTN","GMRCSTL2",110,0)
 ..S ^TMP("GMRCTOT",$J,1,GMRCSVC,"T")=^TMP("GMRCTOT",$J,1,GMRCSVC,"T")+1
"RTN","GMRCSTL2",111,0)
 ..;  pending for this service
"RTN","GMRCSTL2",112,0)
 ..S:",3,4,5,6,8,9,11,99,"[(","_STATUS_",") ^TMP("GMRCTOT",$J,1,GMRCSVC,"P")=^TMP("GMRCTOT",$J,1,GMRCSVC,"P")+1
"RTN","GMRCSTL2",113,0)
 ..;  this status (STATUS) for this service
"RTN","GMRCSTL2",114,0)
 ..S ^TMP("GMRCTOT",$J,1,GMRCSVC,STATUS)=^TMP("GMRCTOT",$J,1,GMRCSVC,STATUS)+1
"RTN","GMRCSTL2",115,0)
 ;  this status (STATUS) for services to all of its groupers
"RTN","GMRCSTL2",116,0)
 F GRP=GROUPER:-1:1 S ^TMP("GMRCTOT",$J,2,GROUPER(GRP),STATUS)=$G(^TMP("GMRCTOT",$J,2,GROUPER(GRP),STATUS))+^TMP("GMRCTOT",$J,1,GMRCSVC,STATUS)
"RTN","GMRCSTL2",117,0)
 Q
"RTN","GMRCSTL2",118,0)
 ;
"RTN","GMRCSTL2",119,0)
GETRDT(GMRCPT) ;get the received date
"RTN","GMRCSTL2",120,0)
 ; Input:
"RTN","GMRCSTL2",121,0)
 ;  GMRCPT  = File #123 IEN
"RTN","GMRCSTL2",122,0)
 ; Output:
"RTN","GMRCSTL2",123,0)
 ;  GMRCRDT = Date of action entry for remote request received/received
"RTN","GMRCSTL2",124,0)
 N GMRCCKR,GMRCRDT,ND
"RTN","GMRCSTL2",125,0)
 S (GMRCCKR,ND)=0,GMRCRDT=""
"RTN","GMRCSTL2",126,0)
 F  S ND=$O(^GMR(123,GMRCPT,40,ND)) Q:ND'>0!GMRCCKR  D
"RTN","GMRCSTL2",127,0)
 .I $P(^GMR(123,GMRCPT,40,ND,0),"^",2)=23 D
"RTN","GMRCSTL2",128,0)
 ..S GMRCRDT=$P(^GMR(123,GMRCPT,40,ND,0),"^"),GMRCCKR=1
"RTN","GMRCSTL2",129,0)
 .I $P(^GMR(123,GMRCPT,40,ND,0),"^",2)=21 D
"RTN","GMRCSTL2",130,0)
 ..S GMRCRDT=$P(^GMR(123,GMRCPT,40,ND,0),"^")
"RTN","GMRCSTL2",131,0)
 Q GMRCRDT
"RTN","GMRCSTLM")
0^15^B82358343
"RTN","GMRCSTLM",1,0)
GMRCSTLM ;SLC/DCM,dee,MA - List Manager Format Routine - Get Active Consults by service - pending,active,scheduled,incomplete,etc. ;9/21/01  05:29
"RTN","GMRCSTLM",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,7,21,23,22**;DEC 27, 1997
"RTN","GMRCSTLM",3,0)
 ; Patch #21 added a initialization KILL for ^TMP("GMRCTOT",$J)
"RTN","GMRCSTLM",4,0)
 ; Patch #23 remove the default prompt "ALL SERVICES"
"RTN","GMRCSTLM",5,0)
 Q
"RTN","GMRCSTLM",6,0)
 ;
"RTN","GMRCSTLM",7,0)
EN ;Ask for new service and date range
"RTN","GMRCSTLM",8,0)
 K GMRCQUT
"RTN","GMRCSTLM",9,0)
 N DIROUT,DTOUT,DUOUT,DIR
"RTN","GMRCSTLM",10,0)
 ;
"RTN","GMRCSTLM",11,0)
 ;Ask for service
"RTN","GMRCSTLM",12,0)
 N Y
"RTN","GMRCSTLM",13,0)
 S DIR(0)="PO^123.5:EMQ",DIR("??")="^D LISTALL^GMRCASV"
"RTN","GMRCSTLM",14,0)
 S DIR("A")="Select Service/Specialty"
"RTN","GMRCSTLM",15,0)
 D ^DIR
"RTN","GMRCSTLM",16,0)
 I Y<1 S VALMBCK="Q" Q
"RTN","GMRCSTLM",17,0)
 S GMRCDG=+Y,GMRCSVNM=$P(Y,U,2)
"RTN","GMRCSTLM",18,0)
 D SERV1^GMRCASV
"RTN","GMRCSTLM",19,0)
 I '$O(^TMP("GMRCSLIST",$J,0)) S VALMBCK="Q" Q 
"RTN","GMRCSTLM",20,0)
 ;
"RTN","GMRCSTLM",21,0)
 ;Ask for date range
"RTN","GMRCSTLM",22,0)
 D ^GMRCSPD
"RTN","GMRCSTLM",23,0)
 I $D(GMRCQUT) S VALMBCK="Q" G EXIT
"RTN","GMRCSTLM",24,0)
 D LISTDATE^GMRCSTU1(GMRCDT1,GMRCDT2,.GMRCEDT1,.GMRCEDT2)
"RTN","GMRCSTLM",25,0)
 Q
"RTN","GMRCSTLM",26,0)
 ;
"RTN","GMRCSTLM",27,0)
ENOR(RETURN,GMRCSVC,GMRCDT1,GMRCDT2,GMRCSTAT,GMRCCTRL,GMRCARRN) ;Entry point for GUI interface.
"RTN","GMRCSTLM",28,0)
 ;.RETURN:   This is the root to the returned temp array.
"RTN","GMRCSTLM",29,0)
 ;GMRCSVC:  Service for which consults are to be displayed.
"RTN","GMRCSTLM",30,0)
 ;GMRCDT1:  Starting date or "ALL"
"RTN","GMRCSTLM",31,0)
 ;GMRCDT2:  Ending date if not GMRCDT1="ALL"
"RTN","GMRCSTLM",32,0)
 ;GMRCSTAT: The list of status to include separated by commas
"RTN","GMRCSTLM",33,0)
 ;GMRCCTRL:   0, null or not define then just the display list is 
"RTN","GMRCSTLM",34,0)
 ;                displayed
"RTN","GMRCSTLM",35,0)
 ;            1 then the list will be two pieces with the first piece 
"RTN","GMRCSTLM",36,0)
 ;                being the ien of the consult for selection in the gui
"RTN","GMRCSTLM",37,0)
 ;                and the second piece being the display text.
"RTN","GMRCSTLM",38,0)
 ;           10 then the consults will have a line number on them for
"RTN","GMRCSTLM",39,0)
 ;                selection
"RTN","GMRCSTLM",40,0)
 ;           20 then the consults will have the consult number displayed
"RTN","GMRCSTLM",41,0)
 ;          100 then use abbreviations for the statuses
"RTN","GMRCSTLM",42,0)
 ;      1, (10 or 20) and 100 can be added together to add there features
"RTN","GMRCSTLM",43,0)
 ;GMRCARRN: List Template Array Name
"RTN","GMRCSTLM",44,0)
 ;          "CP": pending; "IFC": inter-facility
"RTN","GMRCSTLM",45,0)
 ;
"RTN","GMRCSTLM",46,0)
 ;This temp array is used internally by the report:
"RTN","GMRCSTLM",47,0)
 ;^TMP("GMRCSLIST",$J,n)=ien^name^parient ien^"+" if grouper^status
"RTN","GMRCSTLM",48,0)
 ;  status is "" tracking and/or grouper
"RTN","GMRCSTLM",49,0)
 ;            1  grouper only
"RTN","GMRCSTLM",50,0)
 ;            2  tracking only
"RTN","GMRCSTLM",51,0)
 ;            9  disabled
"RTN","GMRCSTLM",52,0)
 ;
"RTN","GMRCSTLM",53,0)
 N GMRCEDT1,GMRCEDT2,GMRCDG,GMRCHEAD,GMRCCT,GMRCGRP,VALMCNT,VALMBCK
"RTN","GMRCSTLM",54,0)
 K ^TMP("GMRCR",$J,GMRCARRN)
"RTN","GMRCSTLM",55,0)
 S RETURN="^TMP(""GMRCR"",$J,GMRCARRN)"
"RTN","GMRCSTLM",56,0)
 I '($D(GMRCSVC)#2) S GMRCSVC=1
"RTN","GMRCSTLM",57,0)
 Q:'$D(^GMR(123.5,$G(GMRCSVC),0))
"RTN","GMRCSTLM",58,0)
 ;Build service array
"RTN","GMRCSTLM",59,0)
 S GMRCDG=GMRCSVC
"RTN","GMRCSTLM",60,0)
 D SERV1^GMRCASV
"RTN","GMRCSTLM",61,0)
 ;Get external form of date range
"RTN","GMRCSTLM",62,0)
 I '($D(GMRCDT1)#2) S GMRCDT1="ALL"
"RTN","GMRCSTLM",63,0)
 S:GMRCDT1="ALL" GMRCDT2=0
"RTN","GMRCSTLM",64,0)
 D LISTDATE^GMRCSTU1(GMRCDT1,$G(GMRCDT2),.GMRCEDT1,.GMRCEDT2)
"RTN","GMRCSTLM",65,0)
 G ENORSTR
"RTN","GMRCSTLM",66,0)
 ;
"RTN","GMRCSTLM",67,0)
ENORLM(GMRCARRN) ;Entry point for List Manager interface.
"RTN","GMRCSTLM",68,0)
 ; Input -- GMRCARRN  List Template Array Name
"RTN","GMRCSTLM",69,0)
 ;          "CP": pending; "IFC": inter-facility
"RTN","GMRCSTLM",70,0)
 ; Output - None
"RTN","GMRCSTLM",71,0)
 D WAIT^DICD
"RTN","GMRCSTLM",72,0)
 ;
"RTN","GMRCSTLM",73,0)
ENORSTR ;Common part
"RTN","GMRCSTLM",74,0)
 N GMRCDA,NUMCLIN,INDEX,STATUS,LOOP,GROUPER
"RTN","GMRCSTLM",75,0)
 N STS,GMRCD,GMRCDT,GMRCSVCG,TEMP
"RTN","GMRCSTLM",76,0)
 N GMRCPT,CTRLTEMP,LINETEMP,GMRCLINE
"RTN","GMRCSTLM",77,0)
 N GMRCPTN,GMRCPTSN,GMRCDLA,GMRCXDT,GMRCLOC,GMRCSVCP
"RTN","GMRCSTLM",78,0)
 N GRP,GMRCIRF,GMRCIRFN,GMRCIDD,GMRCST,GMRCRDT
"RTN","GMRCSTLM",79,0)
 S:'$D(GMRCARRN) GMRCARRN="CP"
"RTN","GMRCSTLM",80,0)
 ;
"RTN","GMRCSTLM",81,0)
 ; Patch #21 added the kill for ^TMP("GMRCTOT",$J)
"RTN","GMRCSTLM",82,0)
 K ^TMP("GMRCR",$J,GMRCARRN),^TMP("GMRCRINDEX",$J),^TMP("GMRCTOT",$J)
"RTN","GMRCSTLM",83,0)
 ;
"RTN","GMRCSTLM",84,0)
 S GMRCCT=0
"RTN","GMRCSTLM",85,0)
 S NUMCLIN=0
"RTN","GMRCSTLM",86,0)
 S GMRCLINE=0
"RTN","GMRCSTLM",87,0)
 S GROUPER=0
"RTN","GMRCSTLM",88,0)
 S GROUPER(0)=0
"RTN","GMRCSTLM",89,0)
 S GMRCCT=GMRCCT+1
"RTN","GMRCSTLM",90,0)
 I '($D(GMRCCTRL)#2) S GMRCCTRL=0 ;default to just the list
"RTN","GMRCSTLM",91,0)
 S CTRLTEMP=$S(GMRCCTRL#2:"^",1:"")
"RTN","GMRCSTLM",92,0)
 I GMRCARRN="IFC" D
"RTN","GMRCSTLM",93,0)
 .S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=CTRLTEMP_$J("",18)_"IF Consult/Request By Status - "_$S(GMRCIS="R":"Requesting",1:"Consulting")_" Site"
"RTN","GMRCSTLM",94,0)
 E  D
"RTN","GMRCSTLM",95,0)
 .S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=CTRLTEMP_$J("",28)_"Consult/Request By Status"
"RTN","GMRCSTLM",96,0)
 S GMRCCT=GMRCCT+1
"RTN","GMRCSTLM",97,0)
 S TEMP="FROM: "_GMRCEDT1_"   TO: "_GMRCEDT2
"RTN","GMRCSTLM",98,0)
 S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=CTRLTEMP_$J("",40-($L(TEMP)/2)+.5)_TEMP
"RTN","GMRCSTLM",99,0)
 I GMRCARRN="IFC",$D(GMRCRF),$D(GMRCREMP) D
"RTN","GMRCSTLM",100,0)
 .S GMRCCT=GMRCCT+1
"RTN","GMRCSTLM",101,0)
 .S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=CTRLTEMP_"Routing Facility - "_$$GET1^DIQ(4,GMRCRF,.01)
"RTN","GMRCSTLM",102,0)
 .S GMRCCT=GMRCCT+1
"RTN","GMRCSTLM",103,0)
 .S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=CTRLTEMP_"Remote Ordering Provider - "_GMRCREMP
"RTN","GMRCSTLM",104,0)
 I GMRCCTRL=120 D
"RTN","GMRCSTLM",105,0)
 .S GMRCCT=GMRCCT+1
"RTN","GMRCSTLM",106,0)
 .S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=CTRLTEMP
"RTN","GMRCSTLM",107,0)
 .S GMRCCT=GMRCCT+1
"RTN","GMRCSTLM",108,0)
 .S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)="   Number St   Last Action         Req Dt   Patient Name            Patient Location"_$S(GMRCARRN="IFC":"         Routing Facility  Days Diff"_$S(GMRCIS="C":"  Rec Dt",1:""),1:"")
"RTN","GMRCSTLM",109,0)
 ;
"RTN","GMRCSTLM",110,0)
 I '($D(GMRCSVC)#2) S GMRCSVC=1
"RTN","GMRCSTLM",111,0)
 I '($D(GMRCDT1)#2) S GMRCDT1="ALL",GMRCDT2=0
"RTN","GMRCSTLM",112,0)
 I '($D(GMRCDT2)#2) S GMRCDT2=""
"RTN","GMRCSTLM",113,0)
 I '($D(GMRCSTAT)#2),GMRCARRN="CP" S GMRCSTAT="3,4,5,6,8,9,11,99" ;pending consults
"RTN","GMRCSTLM",114,0)
 I '($D(GMRCSTAT)#2),GMRCARRN="IFC"  S GMRCSTAT="1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,99"
"RTN","GMRCSTLM",115,0)
 ;
"RTN","GMRCSTLM",116,0)
CAPTION ;Set the List Mangager Caption Line
"RTN","GMRCSTLM",117,0)
 ; Does GMRCCTRL contain 10 i.e. display line numbers
"RTN","GMRCSTLM",118,0)
 ;                    or 20 i.e. display consult number
"RTN","GMRCSTLM",119,0)
 I $G(VALMAR)="^TMP(""GMRCR"",$J,""CP"")"!($G(VALMAR)="^TMP(""GMRCR"",$J,""IFC"")") D
"RTN","GMRCSTLM",120,0)
 .I GMRCCTRL#100\10 D
"RTN","GMRCSTLM",121,0)
 ..I GMRCCTRL#100\10=1 D
"RTN","GMRCSTLM",122,0)
 ...; Does GMRCCTRL contain 100 i.e. use abbreviations for the statuses
"RTN","GMRCSTLM",123,0)
 ...I GMRCCTRL#1000\100 D CHGCAP^VALM("CAPTION LINE","     St    Last Action   Request Date  Patient Name         Pt Location")
"RTN","GMRCSTLM",124,0)
 ...; Do not use abbreviations for the statuses
"RTN","GMRCSTLM",125,0)
 ...E  D CHGCAP^VALM("CAPTION LINE","     Status      Last Action   Request Date  Patient Name         Pt Location")
"RTN","GMRCSTLM",126,0)
 ..; Do not display consult number
"RTN","GMRCSTLM",127,0)
 ..E  D
"RTN","GMRCSTLM",128,0)
 ...; Does GMRCCTRL contain 100 i.e. use abbreviations for the statuses
"RTN","GMRCSTLM",129,0)
 ...I GMRCCTRL#1000\100 D CHGCAP^VALM("CAPTION LINE"," Number   St    Last Action   Request Date  Patient Name         Pt Location")
"RTN","GMRCSTLM",130,0)
 ...; Do not use abbreviations for the statuses
"RTN","GMRCSTLM",131,0)
 ...E  D CHGCAP^VALM("CAPTION LINE"," Number   Status      Last Action   Request Date  Patient Name         Pt Location")
"RTN","GMRCSTLM",132,0)
 .E  D
"RTN","GMRCSTLM",133,0)
 ..; Does GMRCCTRL contain 100 i.e. use abbreviations for the statuses
"RTN","GMRCSTLM",134,0)
 ..I GMRCCTRL#1000\100 D CHGCAP^VALM("CAPTION LINE","St    Last Action   Request Date  Patient Name         Pt Location")
"RTN","GMRCSTLM",135,0)
 ..; Do not use abbreviations for the statuses
"RTN","GMRCSTLM",136,0)
 ..E  D CHGCAP^VALM("CAPTION LINE","Status      Last Action      Request Date  Patient Name      Pt Location")
"RTN","GMRCSTLM",137,0)
 .I GMRCARRN="IFC" D
"RTN","GMRCSTLM",138,0)
 ..D CHGCAP^VALM("CAPTION LINE 1","Routing Facility  Days Diff"_$S(GMRCIS="C":"  Rec Date",1:""))
"RTN","GMRCSTLM",139,0)
 ;Set screen width
"RTN","GMRCSTLM",140,0)
 S VALM("RM")=$S(GMRCARRN="CP":$$CWIDTH^GMRCPC(GMRCCTRL),1:$$CWIDTH^GMRCIR(GMRCCTRL))
"RTN","GMRCSTLM",141,0)
 ;
"RTN","GMRCSTLM",142,0)
 S GMRCHEAD=$P($G(^TMP("GMRCSLIST",$J,+$O(^TMP("GMRCSLIST",$J,"")))),"^",2)
"RTN","GMRCSTLM",143,0)
 S INDEX=""
"RTN","GMRCSTLM",144,0)
SVC ;Loop on Service
"RTN","GMRCSTLM",145,0)
 F  S INDEX=$O(^TMP("GMRCSLIST",$J,INDEX)) Q:INDEX=""  D
"RTN","GMRCSTLM",146,0)
 .S GMRCSVC=$P(^TMP("GMRCSLIST",$J,INDEX),"^",1)
"RTN","GMRCSTLM",147,0)
 .S GMRCSVCP=$P(^TMP("GMRCSLIST",$J,INDEX),"^",2)
"RTN","GMRCSTLM",148,0)
 .S GMRCSVCG=$P(^TMP("GMRCSLIST",$J,INDEX),"^",3)
"RTN","GMRCSTLM",149,0)
 .S ^TMP("GMRCTOT",$J,1,GMRCSVC,"T")=0
"RTN","GMRCSTLM",150,0)
 .S ^TMP("GMRCTOT",$J,1,GMRCSVC,"P")=0
"RTN","GMRCSTLM",151,0)
 .S ^TMP("GMRCTOT",$J,2,GMRCSVC,"T")=0
"RTN","GMRCSTLM",152,0)
 .S ^TMP("GMRCTOT",$J,2,GMRCSVC,"P")=0
"RTN","GMRCSTLM",153,0)
 .I GMRCARRN="IFC" D
"RTN","GMRCSTLM",154,0)
 ..S GMRCST(1,GMRCSVC)="0^0"
"RTN","GMRCSTLM",155,0)
 ..S GMRCST(2,GMRCSVC)="0^0"
"RTN","GMRCSTLM",156,0)
GROUPER .;Check if starting a new Grouper
"RTN","GMRCSTLM",157,0)
 .F  Q:GROUPER(GROUPER)=GMRCSVCG  D
"RTN","GMRCSTLM",158,0)
 ..;End of a group so print the group totals
"RTN","GMRCSTLM",159,0)
 ..D LISTTOT^GMRCSTL1(.GMRCCT,2,GROUPER(GROUPER),$P(^GMR(123.5,GROUPER(GROUPER),0),"^",1),"",GMRCCTRL,GMRCARRN)
"RTN","GMRCSTLM",160,0)
 ..;pop grouper from stack
"RTN","GMRCSTLM",161,0)
 ..S GROUPER=GROUPER-1
"RTN","GMRCSTLM",162,0)
 .I $P(^TMP("GMRCSLIST",$J,INDEX),"^",4)="+" D
"RTN","GMRCSTLM",163,0)
 ..;Start of a new group so print the group heading.
"RTN","GMRCSTLM",164,0)
 ..S GMRCCT=GMRCCT+1
"RTN","GMRCSTLM",165,0)
 ..S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=CTRLTEMP
"RTN","GMRCSTLM",166,0)
 ..S GMRCCT=GMRCCT+1
"RTN","GMRCSTLM",167,0)
 ..S TEMP="GROUPER: "_GMRCSVCP
"RTN","GMRCSTLM",168,0)
 ..S:GMRCSVCG>0 TEMP=TEMP_"  in Group: "_$P(^GMR(123.5,GMRCSVCG,0),"^",1)
"RTN","GMRCSTLM",169,0)
 ..S ^TMP("GMRCR",$J,GMRCARRN,GMRCCT,0)=CTRLTEMP_$J("",40-(($L(TEMP)/2)+.5))_TEMP
"RTN","GMRCSTLM",170,0)
 ..;push new grouper on stack
"RTN","GMRCSTLM",171,0)
 ..S GROUPER=GROUPER+1
"RTN","GMRCSTLM",172,0)
 ..S GROUPER(GROUPER)=GMRCSVC
"RTN","GMRCSTLM",173,0)
STAT .;Loop for one status at a time
"RTN","GMRCSTLM",174,0)
 .F LOOP=1:1:$L(GMRCSTAT,",") S STATUS=$P(GMRCSTAT,",",LOOP) D ONESTAT^GMRCSTL2(GMRCARRN)
"RTN","GMRCSTLM",175,0)
 .F GRP=GROUPER:-1:1 D
"RTN","GMRCSTLM",176,0)
 ..;  pending for this service to all of its groupers
"RTN","GMRCSTLM",177,0)
 ..S ^TMP("GMRCTOT",$J,2,GROUPER(GRP),"P")=$G(^TMP("GMRCTOT",$J,2,GROUPER(GRP),"P"))+^TMP("GMRCTOT",$J,1,GMRCSVC,"P")
"RTN","GMRCSTLM",178,0)
 ..;  for all status for this service to all of its groupers
"RTN","GMRCSTLM",179,0)
 ..S ^TMP("GMRCTOT",$J,2,GROUPER(GRP),"T")=$G(^TMP("GMRCTOT",$J,2,GROUPER(GRP),"T"))+^TMP("GMRCTOT",$J,1,GMRCSVC,"T")
"RTN","GMRCSTLM",180,0)
 ..;IF Consults
"RTN","GMRCSTLM",181,0)
 ..I GMRCARRN="IFC" S GMRCIRFN="" F  S GMRCIRFN=$O(^TMP("GMRCTOT",$J,1,GMRCSVC,"F",GMRCIRFN)) Q:GMRCIRFN=""  D
"RTN","GMRCSTLM",182,0)
 ...I '$D(^TMP("GMRCTOT",$J,2,GROUPER(GRP),"F",GMRCIRFN)) D
"RTN","GMRCSTLM",183,0)
 ....S ^TMP("GMRCTOT",$J,2,GROUPER(GRP),"F",GMRCIRFN)=0
"RTN","GMRCSTLM",184,0)
 ....S GMRCST(2,GROUPER(GRP),GMRCIRFN)="0^0"
"RTN","GMRCSTLM",185,0)
 ...S ^TMP("GMRCTOT",$J,2,GROUPER(GRP),"F",GMRCIRFN)=$G(^TMP("GMRCTOT",$J,2,GROUPER(GRP),"F",GMRCIRFN))+^TMP("GMRCTOT",$J,1,GMRCSVC,"F",GMRCIRFN)
"RTN","GMRCSTLM",186,0)
 ...I +$P(GMRCST(1,GMRCSVC,GMRCIRFN),"^",2)>0 D
"RTN","GMRCSTLM",187,0)
 ....S $P(GMRCST(2,GROUPER(GRP),GMRCIRFN),"^")=($P(GMRCST(2,GROUPER(GRP)),"^"))+($P(GMRCST(1,GMRCSVC,GMRCIRFN),"^"))
"RTN","GMRCSTLM",188,0)
 ....S $P(GMRCST(2,GROUPER(GRP),GMRCIRFN),"^",2)=($P(GMRCST(2,GROUPER(GRP),GMRCIRFN),"^",2))+($P(GMRCST(1,GMRCSVC,GMRCIRFN),"^",2))
"RTN","GMRCSTLM",189,0)
 ..I GMRCARRN="IFC" D
"RTN","GMRCSTLM",190,0)
 ...S $P(GMRCST(2,GROUPER(GRP)),"^")=($P(GMRCST(2,GROUPER(GRP)),"^"))+($P(GMRCST(1,GMRCSVC),"^"))
"RTN","GMRCSTLM",191,0)
 ...S $P(GMRCST(2,GROUPER(GRP)),"^",2)=($P(GMRCST(2,GROUPER(GRP)),"^",2))+($P(GMRCST(1,GMRCSVC),"^",2))
"RTN","GMRCSTLM",192,0)
 .;
"RTN","GMRCSTLM",193,0)
PRINTST .;Print the totals for this service that are >0
"RTN","GMRCSTLM",194,0)
 .I ^TMP("GMRCTOT",$J,1,GMRCSVC,"T")>0 D LISTTOT^GMRCSTL1(.GMRCCT,1,GMRCSVC,GMRCSVCP,$P($G(^GMR(123.5,GMRCSVCG,0)),"^",1),GMRCCTRL,GMRCARRN)
"RTN","GMRCSTLM",195,0)
 ;
"RTN","GMRCSTLM",196,0)
 ;Done so
"RTN","GMRCSTLM",197,0)
 ;Now list the group totals for the current groups
"RTN","GMRCSTLM",198,0)
 F GROUPER=GROUPER:-1:1 D
"RTN","GMRCSTLM",199,0)
 .D LISTTOT^GMRCSTL1(.GMRCCT,2,GROUPER(GROUPER),$P(^GMR(123.5,GROUPER(GROUPER),0),"^",1),"",GMRCCTRL,GMRCARRN)
"RTN","GMRCSTLM",200,0)
 ;
"RTN","GMRCSTLM",201,0)
 S VALMCNT=GMRCCT
"RTN","GMRCSTLM",202,0)
 I $D(IOBM),$D(IOTM) S VALMBCK="R"
"RTN","GMRCSTLM",203,0)
EXIT Q
"RTN","GMRCSTLM",204,0)
 ;
"RTN","GMRCTIU")
0^56^B16773527
"RTN","GMRCTIU",1,0)
GMRCTIU ;SLC/DCM - Consults - TIU utilities ;2/26/02 11:46
"RTN","GMRCTIU",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,12,18,15,17,22**;DEC 27, 1997
"RTN","GMRCTIU",3,0)
 ;
"RTN","GMRCTIU",4,0)
 ; This routine invokes IA #2427,#2638,#2832,#3161
"RTN","GMRCTIU",5,0)
 ;
"RTN","GMRCTIU",6,0)
GET(GMRCO,GMRCTUFN,GMRCTUST,GMRCAUTH) ;update Consult from TIU 
"RTN","GMRCTIU",7,0)
 ;GMRCO=IFN from file 123
"RTN","GMRCTIU",8,0)
 ;GMRCTUFN=TIU IFN
"RTN","GMRCTIU",9,0)
 ;GMRCTUST=TIU status of report
"RTN","GMRCTIU",10,0)
 ;GMRCAUTH=Author of Document
"RTN","GMRCTIU",11,0)
 N GMRCA,GMRCSTS,GMRCDFN,GMRCAD
"RTN","GMRCTIU",12,0)
 S GMRCA=$S($G(GMRCTUST)["INCOMPLETE":9,1:10),GMRCSTS=$S(GMRCA=10:2,1:9)
"RTN","GMRCTIU",13,0)
 I '+$G(GMRCA) S GMRCA=99,GMRCSTS=99
"RTN","GMRCTIU",14,0)
 D:+$G(GMRCA) STATUS^GMRCTIU1
"RTN","GMRCTIU",15,0)
 K GMRCOM,GMRCND,GMRCORNP,GMRCORTX,GMRCSA,GMRCSTS
"RTN","GMRCTIU",16,0)
 Q
"RTN","GMRCTIU",17,0)
 ;
"RTN","GMRCTIU",18,0)
DSPLAY(GMRCTUFN,LINECT) ;Get TIU results narrative and get it ready for display
"RTN","GMRCTIU",19,0)
 ;GMRCTUFN=TIU IEN of results record
"RTN","GMRCTIU",20,0)
 ;LINECT=line count for list manager
"RTN","GMRCTIU",21,0)
 N ND,GMRCARR
"RTN","GMRCTIU",22,0)
 D RPC^TIUSRV(.GMRCARR,GMRCTUFN)
"RTN","GMRCTIU",23,0)
 S ND=0
"RTN","GMRCTIU",24,0)
 F  S ND=$O(@GMRCARR@(ND)) Q:ND=""  S ^TMP("GMRCR",$J,"DT",LINECT,0)=@GMRCARR@(ND,0),LINECT=LINECT+1
"RTN","GMRCTIU",25,0)
 ;D CLEAN^VALM10
"RTN","GMRCTIU",26,0)
 K @GMRCARR,RESFL,GMRCTIUY
"RTN","GMRCTIU",27,0)
 S:LINECT>1 LINECT=LINECT-1
"RTN","GMRCTIU",28,0)
 Q
"RTN","GMRCTIU",29,0)
ENTER(GMRCO) ; Complete a consult with TIU note
"RTN","GMRCTIU",30,0)
 N XQADATA,XQA,XQAID,XQAROU,XQFLG,XQAKILL
"RTN","GMRCTIU",31,0)
 D ENTER^GMRCTIUE(GMRCO)
"RTN","GMRCTIU",32,0)
 Q
"RTN","GMRCTIU",33,0)
 ;
"RTN","GMRCTIU",34,0)
ADDEND(GMRCO) ; Make an addendum to a consult result
"RTN","GMRCTIU",35,0)
 N XQADATA,XQA,XQAID,XQAROU,XQFLG,XQAKILL
"RTN","GMRCTIU",36,0)
 D ADDEND^GMRCTIUE(GMRCO)
"RTN","GMRCTIU",37,0)
 Q
"RTN","GMRCTIU",38,0)
 ;
"RTN","GMRCTIU",39,0)
SEND(DFN,OVRRIDE,CP) ;Get consult list and return in ^TMP for TIU
"RTN","GMRCTIU",40,0)
 ;DFN=Patient's Internal file number from file 2
"RTN","GMRCTIU",41,0)
 ;OVRRIDE=BOOLEAN flag to override user validation
"RTN","GMRCTIU",42,0)
 ;CP=2 if only return entries that may have CP docs attached
"RTN","GMRCTIU",43,0)
 ;
"RTN","GMRCTIU",44,0)
 N GMRCI,TAB
"RTN","GMRCTIU",45,0)
 Q:DFN=""!(DFN<1)
"RTN","GMRCTIU",46,0)
 S TAB="",$P(TAB," ",30)=""
"RTN","GMRCTIU",47,0)
 K ^TMP("GMRCR",$J,"TIU")
"RTN","GMRCTIU",48,0)
 D GETCONSL(DFN,2,$G(OVRRIDE),$G(CP)) ;2=returns TIU format in ^TMP
"RTN","GMRCTIU",49,0)
 Q
"RTN","GMRCTIU",50,0)
 ;
"RTN","GMRCTIU",51,0)
RPCLIST(GMRCY,DFN) ;Get consult list and return in GMRCY for GUI
"RTN","GMRCTIU",52,0)
 N GMRCI
"RTN","GMRCTIU",53,0)
 I '+$G(DFN) S GMRCY(0)=0
"RTN","GMRCTIU",54,0)
 D GETCONSL(DFN,1) ;1=returns GUI format in GMRCY array
"RTN","GMRCTIU",55,0)
 ; The consults will be returned from GETCONSL in the GMRCY array.
"RTN","GMRCTIU",56,0)
 S GMRCY(0)=+$G(GMRCI)
"RTN","GMRCTIU",57,0)
 Q
"RTN","GMRCTIU",58,0)
GETCONSL(DFN,ORIGIN,OVRRIDE,GMRCCP) ;Get the patients consults
"RTN","GMRCTIU",59,0)
 ;ORIGIN is whether the request is for GUI=1 or LM=2.
"RTN","GMRCTIU",60,0)
 ;The logic loops through the "AD" cross-reference to find consults
"RTN","GMRCTIU",61,0)
 ;The output will be formatted in GMRCY for the GUI if ORIGIN is 1.
"RTN","GMRCTIU",62,0)
 ;The output will be formatted in ^TMP("GMRCR",$J,"TIU" if ORIGIN is 2.
"RTN","GMRCTIU",63,0)
 ;GMRCCP = 1 = return only CP entries that can have CP doc attached
"RTN","GMRCTIU",64,0)
 ;
"RTN","GMRCTIU",65,0)
 N GMRCQIT,GMRC,GMRCDA,GMRCDT,GMRCEDT,GMRCYR,GMRCSP,GMRCST,GMRCSTS
"RTN","GMRCTIU",66,0)
 N GMRCTIU,GMRCTIUC,GMRCSS,GMRCSVC,GMRCPROC,GMRCNOTE,Y,GMRCDAT,GMRAU
"RTN","GMRCTIU",67,0)
 ;
"RTN","GMRCTIU",68,0)
 ; Aug 2000 - MA changed routine to use Parameter global to set the
"RTN","GMRCTIU",69,0)
 ; number of days to look backward when getting a list of consults.
"RTN","GMRCTIU",70,0)
 S GMRCYR=$$FMADD^XLFDT(DT,-$$GET^XPAR("ALL","GMRC CONSULT LIST DAYS"))
"RTN","GMRCTIU",71,0)
 S GMRCYR=9999999-GMRCYR,GMRCDAT=0
"RTN","GMRCTIU",72,0)
 F  S GMRCDAT=$O(^GMR(123,"AD",DFN,GMRCDAT)) Q:'GMRCDAT!(GMRCDAT>GMRCYR)  D
"RTN","GMRCTIU",73,0)
 . S GMRCDA=0
"RTN","GMRCTIU",74,0)
 . F  S GMRCDA=$O(^GMR(123,"AD",DFN,GMRCDAT,GMRCDA)) Q:'GMRCDA  D
"RTN","GMRCTIU",75,0)
 .. S GMRC(0)=$G(^GMR(123,GMRCDA,0))
"RTN","GMRCTIU",76,0)
 .. S GMRCST=$P(GMRC(0),U,12)
"RTN","GMRCTIU",77,0)
 .. I $P($G(^GMR(123,GMRCDA,12)),U,5)="P" Q  ;can't attach to IFC placer
"RTN","GMRCTIU",78,0)
 .. I "25689"'[GMRCST Q  ;only return statuses c,p,a,s,pr
"RTN","GMRCTIU",79,0)
 .. S GMRCDT=+GMRC(0)
"RTN","GMRCTIU",80,0)
 .. S GMRCSS=$P(GMRC(0),U,5)
"RTN","GMRCTIU",81,0)
 .. I '+$G(OVRRIDE) D  Q:'GMRCAU
"RTN","GMRCTIU",82,0)
 ... S GMRCAU=$$VALID^GMRCAU(GMRCSS,GMRCDA)
"RTN","GMRCTIU",83,0)
 ... I GMRCAU=3 S GMRCAU=0 ;exclude admin users
"RTN","GMRCTIU",84,0)
 .. I '$G(GMRCCP),+$G(^GMR(123,GMRCDA,1)) Q  ;no CP requests for CPRS
"RTN","GMRCTIU",85,0)
 .. I $G(GMRCCP),'+$G(^GMR(123,GMRCDA,1)) Q  ;only return CP requests 
"RTN","GMRCTIU",86,0)
 .. S GMRCTIUC=0
"RTN","GMRCTIU",87,0)
 .. D GETLIST^GMRCTIUL(GMRCDA,0,1,.GMRCTIUC)
"RTN","GMRCTIU",88,0)
 .. I ORIGIN=1 D BLDGMRCY Q
"RTN","GMRCTIU",89,0)
 .. I ORIGIN=2 D BLDTMP Q
"RTN","GMRCTIU",90,0)
 .. Q
"RTN","GMRCTIU",91,0)
 . Q
"RTN","GMRCTIU",92,0)
 Q
"RTN","GMRCTIU",93,0)
 ;
"RTN","GMRCTIU",94,0)
BLDGMRCY ;Build the GMRCY array of existing consults
"RTN","GMRCTIU",95,0)
 S GMRCSTS=$P($G(^ORD(100.01,+GMRCST,0)),"^",1)
"RTN","GMRCTIU",96,0)
 S GMRCSS=$P(GMRC(0),U,5),GMRCSVC=$P($G(^GMR(123.5,GMRCSS,0)),U)
"RTN","GMRCTIU",97,0)
 S GMRCPROC=$P($G(^GMR(123.3,+$P(GMRC(0),U,8),0)),U)
"RTN","GMRCTIU",98,0)
 S GMRCI=+$G(GMRCI)+1
"RTN","GMRCTIU",99,0)
 S GMRCY(GMRCI)=GMRCDA_U_GMRCDT_U_GMRCSVC_U_GMRCPROC_U_GMRCSTS_U_+GMRCTIUC(0)
"RTN","GMRCTIU",100,0)
 Q
"RTN","GMRCTIU",101,0)
BLDTMP ;Build TMP global for TIU
"RTN","GMRCTIU",102,0)
 S GMRCSTS=$G(^ORD(100.01,+GMRCST,.1))
"RTN","GMRCTIU",103,0)
 S GMRCSP=$$ORTX^GMRCAU(GMRCDA)
"RTN","GMRCTIU",104,0)
 S GMRCNOTE=$S(GMRCTIUC(0)=1:" note",1:" notes")
"RTN","GMRCTIU",105,0)
 S GMRCEDT=$$FMTE^XLFDT(GMRCDT,"D")
"RTN","GMRCTIU",106,0)
 S GMRCI=+$G(GMRCI)+1
"RTN","GMRCTIU",107,0)
 S ^TMP("GMRCR",$J,"TIU",GMRCI,0)=$J(GMRCI,3)_"> "_$E(GMRCEDT_TAB,1,12)_" C#"_$E(GMRCDA_TAB,1,9)_$E(GMRCSP_TAB,1,21)_$E(GMRCSTS_TAB,1,4)_$E(+GMRCTIUC(0)_GMRCNOTE_TAB,1,10)
"RTN","GMRCTIU",108,0)
 S ^TMP("GMRCR",$J,"TIU","B",GMRCI,GMRCDA)=""
"RTN","GMRCTIU",109,0)
 Q
"RTN","GMRCTIUP")
0^20^B20610246
"RTN","GMRCTIUP",1,0)
GMRCTIUP ;SLC/DCM,JFR - TIU/Consults UTILITIES; 4/4/01 15:01
"RTN","GMRCTIUP",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,13,15,17,22**;DEC 27, 1997
"RTN","GMRCTIUP",3,0)
 ;
"RTN","GMRCTIUP",4,0)
 ; This routine invokes IA #616,#2693
"RTN","GMRCTIUP",5,0)
 ;
"RTN","GMRCTIUP",6,0)
HDR(GMRCTUPR,GMRCGLB,COUNT,FROM) ;Get Source info for header of display
"RTN","GMRCTIUP",7,0)
 ;and place data in ^TMP( global. Do Not Show Any Results
"RTN","GMRCTIUP",8,0)
 ;GMRCTUPR=TIU record being sought
"RTN","GMRCTIUP",9,0)
 ;GMRCGLOB=Global where data goes - i.e., ^TMP("GMRCR",$J,"RES",GMRCPTR,"ADD",GMRCADD,LINECT,0)
"RTN","GMRCTIUP",10,0)
 ;COUNT=Count of where current line is to go in ^TMP( global
"RTN","GMRCTIUP",11,0)
 ;FROM=flag to tell whether to add Addendum TIU # or not 0=NO, Otherwise addendum number
"RTN","GMRCTIUP",12,0)
 N DR,GMRCTMP
"RTN","GMRCTIUP",13,0)
 S:'$D(FROM) FROM=""
"RTN","GMRCTIUP",14,0)
 S DR=".01;.05;.07;.09;1201;1202;1204;1205;1208;1301;1302",GMRCERR=""
"RTN","GMRCTIUP",15,0)
 D EXTRACT^TIULQ(GMRCPTR,"LOCAL",.GMRCERR,DR)
"RTN","GMRCTIUP",16,0)
 S @GMRCGLB@(COUNT,0)="",COUNT=COUNT+1
"RTN","GMRCTIUP",17,0)
 S @GMRCGLB@(COUNT,0)="Source Information",COUNT=COUNT+1,@GMRCGLB@(COUNT,0)=""
"RTN","GMRCTIUP",18,0)
 S @GMRCGLB@(COUNT,0)="  Document Status: "_LOCAL(GMRCPTR,.05,"E"),COUNT=COUNT+1
"RTN","GMRCTIUP",19,0)
 S @GMRCGLB@(COUNT,0)="       Entry Date: "_$P($G(LOCAL(GMRCPTR,1201,"E")),":",1,2),COUNT=COUNT+1
"RTN","GMRCTIUP",20,0)
 S @GMRCGLB@(COUNT,0)="            Visit: "_$G(LOCAL(GMRCPTR,.07,"E"))_"  "_$G(LOCAL(GMRCPTR,1205,"E"))
"RTN","GMRCTIUP",21,0)
 S COUNT=COUNT+1
"RTN","GMRCTIUP",22,0)
 S @GMRCGLB@(COUNT,0)="           Author: "_LOCAL(GMRCPTR,1202,"E")
"RTN","GMRCTIUP",23,0)
 S COUNT=COUNT+1
"RTN","GMRCTIUP",24,0)
 S @GMRCGLB@(COUNT,0)="  Expected Signer: "_$E(LOCAL(GMRCPTR,1204,"E")_TAB,1,22)_$E(TAB,1,5)_"Expected Cosigner: "_$S($L($G(LOCAL(GMRCPTR,1208,"E"))):LOCAL(GMRCPTR,1208,"E"),1:"None"),COUNT=COUNT+1
"RTN","GMRCTIUP",25,0)
 S @GMRCGLB@(COUNT,0)="       Entered By: "_$E(LOCAL(GMRCPTR,1302,"E")_TAB,1,30)_"TIU Document #: "_GMRCTUPR,COUNT=COUNT+1
"RTN","GMRCTIUP",26,0)
 S @GMRCGLB@(COUNT,0)=$S(+FROM:"  TIU Addendum Document #: "_FROM,1:"")_$S(+FROM:$E(TAB,1,10),1:"     ")_"     Urgency: "_$S($L($G(LOCAL(GMRCPTR,.09,"E"))):LOCAL(GMRCPTR,.09,"E"),1:"None"),COUNT=COUNT+1
"RTN","GMRCTIUP",27,0)
 S @GMRCGLB@(COUNT,0)="",COUNT=COUNT+1
"RTN","GMRCTIUP",28,0)
 K LOCAL
"RTN","GMRCTIUP",29,0)
 Q
"RTN","GMRCTIUP",30,0)
PRINT(GMRCO,LINECT,GMRCRT,GMRCDET) ;get TIU results and prepare for the SF-513
"RTN","GMRCTIUP",31,0)
 ;GMRCRT=Flag from RT^GMRCA1 indicating that result request is from there
"RTN","GMRCTIUP",32,0)
 ; GMRCRT=0 means 'NO', 
"RTN","GMRCTIUP",33,0)
 ; GMRCRT=1 means 'YES" (and ES is appended to TIU main result); also, 
"RTN","GMRCTIUP",34,0)
 ;    No result is passed back to print on the 513 if GMRCRT=0.
"RTN","GMRCTIUP",35,0)
 ;GMRCTUFN=IEN of the TIU result from file 8925
"RTN","GMRCTIUP",36,0)
 ;GMRCSIG=signature block name of signer : GMRCSDT=date result was signed
"RTN","GMRCTIUP",37,0)
 ;GMRCSIGT=signers block title : GMRCTUFN=TIU IEN of the result record
"RTN","GMRCTIUP",38,0)
 ;GMRCCSIG=cosigners block name : GMRCCSDT=date cosigner signed
"RTN","GMRCTIUP",39,0)
 ;GMRCCTIT=cosigners block title : GMRCSIGM=Signature mode (E:ELECTRONIC/C:CHART)
"RTN","GMRCTIUP",40,0)
 ;I GMRCDET=1 coming from a detailed display not results display
"RTN","GMRCTIUP",41,0)
 N GMRCTUFN,TAB,GLOBAL
"RTN","GMRCTIUP",42,0)
 S:'$D(GMRCRT) GMRCRT=0 S:'$D(GMRCDET) GMRCDET=0
"RTN","GMRCTIUP",43,0)
 D GETRSLTS(GMRCO,.GMRCAR) ;I $D(GMRCQUT) D:$D(GMRCMSG) EXAC^GMRCADC(GMRCMSG) K GMRCMSG,GMRCRT Q
"RTN","GMRCTIUP",44,0)
 S GLOBAL="^TMP(""GMRCR"",$J,""GMRCTIU"")",TAB="",$P(TAB," ",31)=""
"RTN","GMRCTIUP",45,0)
 K ^TMP("GMRCR",$J,"RES"),^TMP("GMRCR",$J,"MCAR")
"RTN","GMRCTIUP",46,0)
 S (GMRCND,GMRCPTR)="" F  K @GLOBAL S GMRCND=$O(GMRCAR(GMRCND)) Q:GMRCND=""  S GMRCPKG=$P(GMRCND,";",2),GMRCPTR=$P(GMRCND,";",1) D
"RTN","GMRCTIUP",47,0)
 .I $E(GMRCPKG,1,3)="TIU" D
"RTN","GMRCTIUP",48,0)
 .. N GMRCTXT,GMRCPAR,GMRCACTN
"RTN","GMRCTIUP",49,0)
 .. D EXTRACT^TIULQ(GMRCPTR,"GMRCPAR",.GMRCERR,.06,"I")
"RTN","GMRCTIUP",50,0)
 .. I $D(GMRCAR(+$G(GMRCPAR(GMRCPTR,.06,"I"))_";TIU(8925,")) Q
"RTN","GMRCTIUP",51,0)
 .. S GMRCACTN=$S($G(GMRCRT):"VIEW",1:"PRINT RECORD")
"RTN","GMRCTIUP",52,0)
 .. D TGET^TIUSRVR1(.GMRCTXT,+GMRCPTR,GMRCACTN)
"RTN","GMRCTIUP",53,0)
 .. I $D(@(GMRCTXT)) M @GLOBAL@(GMRCPTR,"TEXT")=@GMRCTXT
"RTN","GMRCTIUP",54,0)
 .. K @GMRCTXT
"RTN","GMRCTIUP",55,0)
 .. I $O(@GLOBAL@(GMRCPTR,"TEXT",0)) D
"RTN","GMRCTIUP",56,0)
 ...S ND=0 F  S ND=$O(@GLOBAL@(GMRCPTR,"TEXT",ND)) Q:ND=""  D
"RTN","GMRCTIUP",57,0)
 ....S ^TMP("GMRCR",$J,"RES",GMRCPTR,"TEXT",LINECT,0)=@GLOBAL@(GMRCPTR,"TEXT",ND)
"RTN","GMRCTIUP",58,0)
 ....S LINECT=LINECT+1
"RTN","GMRCTIUP",59,0)
 ..Q
"RTN","GMRCTIUP",60,0)
 .I $E(GMRCPKG,1,4)="MCAR" S GMRCSR=GMRCND,MCFILE=$P(GMRCSR,";",2),MCFILE=$P(MCFILE,","),MCPROC=$O(^MCAR(697.2,"C",MCFILE,"")) Q:'MCPROC  D
"RTN","GMRCTIUP",61,0)
 ..S GMRCPRNM=$P(^MCAR(697.2,MCPROC,0),"^",8),ORIFN=$P(^GMR(123,GMRCO,0),"^",3),ORACTION=8,MCGLOBAL="^TMP(""GMRCR"",$J,""MCAR"","_GMRCPTR_")"
"RTN","GMRCTIUP",62,0)
 ..D EN^GMRCTIU3(GMRCO,ORIFN,MCGLOBAL,LINECT) K ^TMP("MC",$J)
"RTN","GMRCTIUP",63,0)
 ..Q
"RTN","GMRCTIUP",64,0)
 .Q
"RTN","GMRCTIUP",65,0)
 ; inter-facility remote results
"RTN","GMRCTIUP",66,0)
 I 'GMRCDET,$O(^GMR(123,GMRCO,51,0)) D
"RTN","GMRCTIUP",67,0)
 .N GMRCTMP S GMRCTMP="^TMP(""GMRCR"",$J,""RRES"")" K @GMRCTMP
"RTN","GMRCTIUP",68,0)
 .S GLOBAL="^TMP(""GMRCR"",$J,""GMRCRRES"")" K @GLOBAL
"RTN","GMRCTIUP",69,0)
 .D GETREMOT^GMRCART(GMRCO,GMRCTMP,LINECT)
"RTN","GMRCTIUP",70,0)
 .I $D(@(GMRCTMP)) M @GLOBAL@(.5,"TEXT")=@GMRCTMP K @GMRCTMP
"RTN","GMRCTIUP",71,0)
 .I $O(@GLOBAL@(.5,"TEXT",0)) D
"RTN","GMRCTIUP",72,0)
 ..S ND=0 F  S ND=$O(@GLOBAL@(.5,"TEXT",ND)) Q:ND=""  D
"RTN","GMRCTIUP",73,0)
 ...S ^TMP("GMRCR",$J,"RES",.5,"TEXT",LINECT,0)=@GLOBAL@(.5,"TEXT",ND,0)
"RTN","GMRCTIUP",74,0)
 ...S LINECT=LINECT+1
"RTN","GMRCTIUP",75,0)
 .Q
"RTN","GMRCTIUP",76,0)
 K DR,GLOBAL,GMRCSR,GMRCAR,GMRCPKG,GMRCPRNM,MCFILE,MCPROC,ORACTION,ORIFN,MCGLOBAL,ND,ND1,GMRCND,GMRCPTR
"RTN","GMRCTIUP",77,0)
 Q
"RTN","GMRCTIUP",78,0)
GETNOTE(GMRCO,FILE) ;Get the last result added to the record - this is found in $P(^(0),"^",20)
"RTN","GMRCTIUP",79,0)
 ;Function returns last note added to record.
"RTN","GMRCTIUP",80,0)
 ;If it does not contain the file pointer, it is assumed that
"RTN","GMRCTIUP",81,0)
 ;it pointed to the TIU file 8925
"RTN","GMRCTIUP",82,0)
 ;GMRCO=file 123 IEN
"RTN","GMRCTIUP",83,0)
 ;FILE='MCAR' to get last medicine result pointer
"RTN","GMRCTIUP",84,0)
 ;FILE='TIU' to get last TIU result pointer
"RTN","GMRCTIUP",85,0)
 N X,RSLT
"RTN","GMRCTIUP",86,0)
 S RSLT=999999,X=""
"RTN","GMRCTIUP",87,0)
 F  S RSLT=$O(^GMR(123,+GMRCO,50,RSLT),-1) Q:'RSLT  D  Q:+X
"RTN","GMRCTIUP",88,0)
 . I $G(^GMR(123,+GMRCO,50,RSLT,0))[FILE S X=^GMR(123,+GMRCO,50,RSLT,0)
"RTN","GMRCTIUP",89,0)
 Q X
"RTN","GMRCTIUP",90,0)
GETRSLTS(GMRCO,ARRAY) ;Get the results from record and return it in array 'ARRAY')
"RTN","GMRCTIUP",91,0)
 ;Looks for results in $P(^(0),"^",20),$P(^(0),"^",15) and Field 50 multiple
"RTN","GMRCTIUP",92,0)
 ;GMRCO=File 123 IEN
"RTN","GMRCTIUP",93,0)
 ;ARRAY=array to return results pointers in
"RTN","GMRCTIUP",94,0)
 ;ARRAY will be returned as ARRAY("IEN;FILE"), as e.g., "1289;^TIU(8925,"
"RTN","GMRCTIUP",95,0)
 N X
"RTN","GMRCTIUP",96,0)
 S X=$$GETNOTE(GMRCO,"TIU") I $L(X) S:$P(X,";",2)="" X=X_";TIU(8925," S ARRAY(X)=""
"RTN","GMRCTIUP",97,0)
 S X=$$GETNOTE(GMRCO,"MCAR") I $L(X) S ARRAY(X)=""
"RTN","GMRCTIUP",98,0)
 S X="" F  S X=$O(^GMR(123,GMRCO,50,"B",X)) Q:X?1A.E!(X="")  S ARRAY(X)=""
"SEC","^DIC",123.6,123.6,0,"AUDIT")
@
"SEC","^DIC",123.6,123.6,0,"DD")
@
"SEC","^DIC",123.6,123.6,0,"DEL")
@
"SEC","^DIC",123.6,123.6,0,"LAYGO")
@
"SEC","^DIC",123.6,123.6,0,"RD")
@
"SEC","^DIC",123.6,123.6,0,"WR")
@
"UP",123,123.02,-1)
123^40
"UP",123,123.02,0)
123.02
"UP",123,123.051,-1)
123^51
"UP",123,123.051,0)
123.051
"UP",123.3,123.3128,-1)
123.3^IFCS
"UP",123.3,123.3128,0)
123.3128
"UP",123.5,123.5134,-1)
123.5^IFCS
"UP",123.5,123.5134,0)
123.5134
"VER")
8.0^22.0
"^DD",123,123,.06,0)
REMOTE CONSULT FILE ENTRY^NJ12,0^^0;22^K:+X'=X!(X>999999999999)!(X<1)!(X?.E1"."1.N) X
"^DD",123,123,.06,3)
Type a number between 1 and 999999999999, 0 Decimal Digits
"^DD",123,123,.06,21,0)
^^6^6^3011127^
"^DD",123,123,.06,21,1,0)
This is the ^GMR(123, file number of the consult from a foreign database.
"^DD",123,123,.06,21,2,0)
It is stored here so that when the consult is returned in an HL7
"^DD",123,123,.06,21,3,0)
message, it can be located at the sending facility.  Also, if the sending
"^DD",123,123,.06,21,4,0)
facility needs to send updated consult information to the receiving
"^DD",123,123,.06,21,5,0)
facility, this number will reference the consult number there so that
"^DD",123,123,.06,21,6,0)
the data can be added/ammended and tracking information can be updated.
"^DD",123,123,.06,"DT")
3011203
"^DD",123,123,.07,0)
ROUTING FACILITY^P4'^DIC(4,^0;23^Q
"^DD",123,123,.07,3)
Enter the institution for routing updates
"^DD",123,123,.07,21,0)
^^3^3^3010712^
"^DD",123,123,.07,21,1,0)
This field will contain the INSTITUTION to which communications and
"^DD",123,123,.07,21,2,0)
updates regarding this request will be routed.  If the request is being
"^DD",123,123,.07,21,3,0)
requested and performed locally, this field will be blank. 
"^DD",123,123,.07,"DT")
3011203
"^DD",123,123,.125,0)
IFC ROLE^S^P:PLACER;F:FILLER;^12;5^Q
"^DD",123,123,.125,21,0)
^^9^9^3010713^
"^DD",123,123,.125,21,1,0)
This field will define the role of the particular VistA system in the
"^DD",123,123,.125,21,2,0)
fullfillment of the inter-facility consult. This facilitates proper
"^DD",123,123,.125,21,3,0)
HL7 message formats.
"^DD",123,123,.125,21,4,0)
 
"^DD",123,123,.125,21,5,0)
PLACER indicates that this VistA system originated and ordered this
"^DD",123,123,.125,21,6,0)
request. 
"^DD",123,123,.125,21,7,0)
 
"^DD",123,123,.125,21,8,0)
FILLER indicates that this request was generated at the institution in the
"^DD",123,123,.125,21,9,0)
ORDERING FACILITY field.
"^DD",123,123,.125,"DT")
3010713
"^DD",123,123,.126,0)
REMOTE ORDERING PROVIDER^F^^12;6^K:$L(X)>40!($L(X)<2) X
"^DD",123,123,.126,1,0)
^.1
"^DD",123,123,.126,1,1,0)
123^AIP^MUMPS
"^DD",123,123,.126,1,1,1)
S ^GMR(123,"AIP",$E(X,1,40),DA)=""
"^DD",123,123,.126,1,1,2)
K ^GMR(123,"AIP",$E(X,1,40),DA)
"^DD",123,123,.126,1,1,"DT")
3020201
"^DD",123,123,.126,3)
Answer must be 2-40 characters in length
"^DD",123,123,.126,21,0)
^^3^3^3020204^
"^DD",123,123,.126,21,1,0)
This field contains the name of the requesting provider of an 
"^DD",123,123,.126,21,2,0)
inter-facility consult. This field is only defined on an inter-facility 
"^DD",123,123,.126,21,3,0)
consult on file at a consulting site. 
"^DD",123,123,.126,"DT")
3020204
"^DD",123,123,.131,0)
IFC REMOTE SERVICE NAME^F^^13;1^K:$L(X)>63!($L(X)<3) X
"^DD",123,123,.131,3)
Answer must be 3-63 characters in length.
"^DD",123,123,.131,21,0)
^^2^2^3011106^
"^DD",123,123,.131,21,1,0)
This field holds the name of the service that will perform the Inter-
"^DD",123,123,.131,21,2,0)
facility Consult at the remote facility. 
"^DD",123,123,.131,"DT")
3011107
"^DD",123,123,.132,0)
REMOTE REQUESTOR PHONE^F^^13;2^K:$L(X)>20!($L(X)<1) X
"^DD",123,123,.132,3)
Answer must be 1-20 characters in length
"^DD",123,123,.132,21,0)
^^5^5^3011220^
"^DD",123,123,.132,21,1,0)
This field will contain the telephone number of the remote requestor of 
"^DD",123,123,.132,21,2,0)
an inter-facility consult. This will be displayed with the consult and 
"^DD",123,123,.132,21,3,0)
can expedite communication between requesting provider and consultant.
"^DD",123,123,.132,21,4,0)
 
"^DD",123,123,.132,21,5,0)
This field is derived from the OFFICE PHONE field of the NEW PERSON file. 
"^DD",123,123,.132,"DT")
3011220
"^DD",123,123,.133,0)
REMOTE REQUESTOR DIG PAGER^F^^13;3^K:$L(X)>20!($L(X)<1) X
"^DD",123,123,.133,3)
Answer must be 1-20 characters in length
"^DD",123,123,.133,21,0)
^^6^6^3011220^
"^DD",123,123,.133,21,1,0)
This field contains the digital pager number of a remote requesting 
"^DD",123,123,.133,21,2,0)
provider if this is an inter-facility consult.  This may expedite 
"^DD",123,123,.133,21,3,0)
communication between the requesting provider and the consultant. 
"^DD",123,123,.133,21,4,0)
 
"^DD",123,123,.133,21,5,0)
This data in this field is derived from the DIGITAL PAGER field of the 
"^DD",123,123,.133,21,6,0)
NEW PERSON file. 
"^DD",123,123,.133,"DT")
3011220
"^DD",123,123,10,0)
SENDING PROVIDER^P200'^VA(200,^0;14^Q
"^DD",123,123,10,1,0)
^.1
"^DD",123,123,10,1,1,0)
123^G
"^DD",123,123,10,1,1,1)
S ^GMR(123,"G",$E(X,1,30),DA)=""
"^DD",123,123,10,1,1,2)
K ^GMR(123,"G",$E(X,1,30),DA)
"^DD",123,123,10,1,1,"%D",0)
^^1^1^2980616^^
"^DD",123,123,10,1,1,"%D",1,0)
This index allows look-up of consults by sending provider. 
"^DD",123,123,10,1,1,"DT")
2980616
"^DD",123,123,10,3)
Enter the name of the Ordering Provider.
"^DD",123,123,10,21,0)
^^1^1^2970911^^^^
"^DD",123,123,10,21,1,0)
This is the provider who originated the order.
"^DD",123,123,10,"DT")
3011212
"^DD",123,123,51,0)
REMOTE RESULTS^123.051D^^51;0
"^DD",123,123,51,"DT")
3010730
"^DD",123,123.02,.21,0)
REMOTE ENTERING PERSON^F^^2;1^K:$L(X)>64!($L(X)<2) X
"^DD",123,123.02,.21,3)
Answer must be 2-64 characters in length
"^DD",123,123.02,.21,21,0)
^^5^5^3011207^
"^DD",123,123.02,.21,21,1,0)
This is the free text name of the individual that entered this activity 
"^DD",123,123.02,.21,21,2,0)
at the facility referenced in the ROUTING FACILITY field. 
"^DD",123,123.02,.21,21,3,0)
 
"^DD",123,123.02,.21,21,4,0)
This field will only be popluated for activities entered on a remote 
"^DD",123,123.02,.21,21,5,0)
VistA system for an inter-facility consult. 
"^DD",123,123.02,.21,"DT")
3011207
"^DD",123,123.02,.22,0)
REMOTE RESPONSIBLE PERSON^F^^2;2^K:$L(X)>64!($L(X)<2) X
"^DD",123,123.02,.22,3)
Answer must be 2-64 characters in length
"^DD",123,123.02,.22,21,0)
^^5^5^3011207^
"^DD",123,123.02,.22,21,1,0)
This is the free text name of the individual that is responsible for this 
"^DD",123,123.02,.22,21,2,0)
activity at the facility referenced in the ROUTING FACILITY field.
"^DD",123,123.02,.22,21,3,0)
 
"^DD",123,123.02,.22,21,4,0)
This field will only be popluated for activities entered on a remote
"^DD",123,123.02,.22,21,5,0)
VistA system for an inter-facility consult.         
"^DD",123,123.02,.22,"DT")
3011207
"^DD",123,123.02,.23,0)
REMOTE ACTIVITY TIME ZONE^F^^2;3^K:$L(X)>3!($L(X)<3) X
"^DD",123,123.02,.23,3)
Answer must be 3 characters in length
"^DD",123,123.02,.23,21,0)
^^4^4^3011207^
"^DD",123,123.02,.23,21,1,0)
This is the short representation of the time zone in which this activity 
"^DD",123,123.02,.23,21,2,0)
took place.  When an inter-facility consult update message is generated at
"^DD",123,123.02,.23,21,3,0)
a remote facility, the current MAILMAN TIME ZONE at that facility is sent 
"^DD",123,123.02,.23,21,4,0)
with the message and stored in this field.
"^DD",123,123.02,.23,"DT")
3011207
"^DD",123,123.02,.24,0)
REMOTE RESULT^F^^2;4^K:$L(X)>60!($L(X)<2) X
"^DD",123,123.02,.24,3)
Answer must be 2-60 characters in length.
"^DD",123,123.02,.24,21,0)
^^5^5^3011207^
"^DD",123,123.02,.24,21,1,0)
This field will contain a reference to a  result stored on a remote
"^DD",123,123.02,.24,21,2,0)
VistA system. 
"^DD",123,123.02,.24,21,3,0)
 
"^DD",123,123.02,.24,21,4,0)
Result will be in form: 
"^DD",123,123.02,.24,21,5,0)
  ien;source file of result;institution ien where result resides
"^DD",123,123.02,.24,"DT")
3011207
"^DD",123,123.02,.25,0)
REMOTE DATE/TIME OF FILING^D^^2;5^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",123,123.02,.25,3)
Enter the date/time the activity was actually filed at the remote site
"^DD",123,123.02,.25,21,0)
^^4^4^3020323^
"^DD",123,123.02,.25,21,1,0)
This field will hold the date/time this particular activity was filed at 
"^DD",123,123.02,.25,21,2,0)
the remote facility.  This field will be used in conjunction with the 
"^DD",123,123.02,.25,21,3,0)
DATE/TIME OF ACTUAL ACTIVITY field to detect and reject the filing of 
"^DD",123,123.02,.25,21,4,0)
duplicate activities.
"^DD",123,123.02,.25,"DT")
3020323
"^DD",123,123.02,.31,0)
PREVIOUS REMOTE SERVICE NAME^F^^3;1^K:$L(X)>63!($L(X)<3) X
"^DD",123,123.02,.31,3)
Answer must be 3-63 characters in length.
"^DD",123,123.02,.31,21,0)
^^2^2^3011207^
"^DD",123,123.02,.31,21,1,0)
This field holds the name of the service that the inter-facility consult
"^DD",123,123.02,.31,21,2,0)
was was directed to at the remote site prior to being forwarded.
"^DD",123,123.02,.31,"DT")
3011207
"^DD",123,123.02,1,0)
ACTIVITY^P123.1'^GMR(123.1,^0;2^Q
"^DD",123,123.02,1,3)
Enter the activity being updated (From file 123.1)
"^DD",123,123.02,1,21,0)
^^1^1^2970611^^
"^DD",123,123.02,1,21,1,0)
This is the activity that is being updated.
"^DD",123,123.02,1,"DT")
3020307
"^DD",123,123.02,2,0)
DATE/TIME OF ACTUAL ACTIVITY^DX^^0;3^S %DT="ETXRS",%DT(0)="-NOW" D ^%DT K %DT(0) S X=Y K:Y<1 X
"^DD",123,123.02,2,.1)

"^DD",123,123.02,2,3)
ENTER BOTH DATE AND TIME.  FUTURE DATE/TIME NOT PERMITTED.
"^DD",123,123.02,2,21,0)
^^2^2^2970611^^^^
"^DD",123,123.02,2,21,1,0)
The Date and time the actual activity was done.  This may be different 
"^DD",123,123.02,2,21,2,0)
than the DATE/TIME OF ACTION ENTRY for certain actions.
"^DD",123,123.02,2,"DT")
3020307
"^DD",123,123.051,0)
REMOTE RESULTS SUB-FIELD^^.03^3
"^DD",123,123.051,0,"DT")
3010730
"^DD",123,123.051,0,"IX","B",123.051,.01)

"^DD",123,123.051,0,"NM","REMOTE RESULTS")

"^DD",123,123.051,0,"UP")
123
"^DD",123,123.051,.01,0)
REMOTE RESULT DATE^D^^0;1^S %DT="ESTXR" D ^%DT S X=Y K:X<1 X
"^DD",123,123.051,.01,1,0)
^.1
"^DD",123,123.051,.01,1,1,0)
123.051^B
"^DD",123,123.051,.01,1,1,1)
S ^GMR(123,DA(1),51,"B",$E(X,1,30),DA)=""
"^DD",123,123.051,.01,1,1,2)
K ^GMR(123,DA(1),51,"B",$E(X,1,30),DA)
"^DD",123,123.051,.01,3)
(No range limit on date)
"^DD",123,123.051,.01,21,0)
^^1^1^3011207^
"^DD",123,123.051,.01,21,1,0)
This is the date/time that a remote result was added to the record.
"^DD",123,123.051,.01,"DT")
3011207
"^DD",123,123.051,.02,0)
REMOTE ASSOCIATED RESULT^F^^0;2^K:$L(X)>30!($L(X)<2) X
"^DD",123,123.051,.02,3)
Answer must be 2-30 characters in length
"^DD",123,123.051,.02,21,0)
^^2^2^3011207^
"^DD",123,123.051,.02,21,1,0)
This is the free text representation of a variable pointer from a remote 
"^DD",123,123.051,.02,21,2,0)
facility. The facility is referenced in the RESULTING SITE field. 
"^DD",123,123.051,.02,"DT")
3011207
"^DD",123,123.051,.03,0)
RESULTING SITE^P4'^DIC(4,^0;3^Q
"^DD",123,123.051,.03,21,0)
^^3^3^3011207^
"^DD",123,123.051,.03,21,1,0)
This field is a pointer to the INSTITUION file and contains the 
"^DD",123,123.051,.03,21,2,0)
institution that stores the result referenced in the REMOTE ASSOCIATED 
"^DD",123,123.051,.03,21,3,0)
RESULT FIELD.
"^DD",123,123.051,.03,"DT")
3011207
"^DD",123.1,123.1,0)
FIELD^^7^8
"^DD",123.1,123.1,0,"DDA")
N
"^DD",123.1,123.1,0,"DT")
2980701
"^DD",123.1,123.1,0,"IX","AC",123.1,1)

"^DD",123.1,123.1,0,"IX","B",123.1,.01)

"^DD",123.1,123.1,0,"IX","D",123.1,5)

"^DD",123.1,123.1,0,"NM","REQUEST ACTION TYPES")

"^DD",123.1,123.1,0,"PT",101,6)

"^DD",123.1,123.1,0,"PT",123,9)

"^DD",123.1,123.1,0,"PT",123.02,1)

"^DD",123.1,123.1,0,"VRPK")
GMRC
"^DD",123.1,123.1,.001,0)
NUMBER^NJ6,0^^ ^K:+X'=X!(X>999999)!(X<1)!(X?.E1"."1N.N) X
"^DD",123.1,123.1,.001,3)
Enter a number between your sites prefix_000 and your sites prefix_999.
"^DD",123.1,123.1,.001,21,0)
^^1^1^2971205^
"^DD",123.1,123.1,.001,21,1,0)
The internal entry number of the Request Action Type.
"^DD",123.1,123.1,.001,"DT")
2971205
"^DD",123.1,123.1,.01,0)
ACTION TYPE^RFX^^0;1^K:X[""""!($A(X)=45) X I $D(X) K:$L(X)>80!($L(X)<3)!'(X'?1P.E)!(X'?.ANP) X
"^DD",123.1,123.1,.01,1,0)
^.1^^-1
"^DD",123.1,123.1,.01,1,1,0)
123.1^B
"^DD",123.1,123.1,.01,1,1,1)
S ^GMR(123.1,"B",$E(X,1,30),DA)=""
"^DD",123.1,123.1,.01,1,1,2)
K ^GMR(123.1,"B",$E(X,1,30),DA)
"^DD",123.1,123.1,.01,3)
ENTER THE ACTION NAME. ANSWER MUST BE 3-80 CHARACTERS IN LENGTH
"^DD",123.1,123.1,.01,21,0)
^^6^6^2970911^^^^
"^DD",123.1,123.1,.01,21,1,0)
This file contains the tracking actions which may be taken to track
"^DD",123.1,123.1,.01,21,2,0)
a Consult or Request order from its entry in CPRS through its
"^DD",123.1,123.1,.01,21,3,0)
resolution.
"^DD",123.1,123.1,.01,21,4,0)
 
"^DD",123.1,123.1,.01,21,5,0)
This file also contains relationships of CPRS statuses which are the
"^DD",123.1,123.1,.01,21,6,0)
result of the action taken.
"^DD",123.1,123.1,.01,"DT")
2910529
"^DD",123.1,123.1,1,0)
RELATED OE/RR STATUS^P100.01'^ORD(100.01,^0;2^Q
"^DD",123.1,123.1,1,1,0)
^.1
"^DD",123.1,123.1,1,1,1,0)
123.1^AC
"^DD",123.1,123.1,1,1,1,1)
S ^GMR(123.1,"AC",$E(X,1,30),DA)=""
"^DD",123.1,123.1,1,1,1,2)
K ^GMR(123.1,"AC",$E(X,1,30),DA)
"^DD",123.1,123.1,1,1,1,"%D",0)
^^3^3^2920608^^^
"^DD",123.1,123.1,1,1,1,"%D",1,0)
This cross-reference is used when the call to RESULT^GMRCR returns an
"^DD",123.1,123.1,1,1,1,"%D",2,0)
OE/RR status.  This OE/RR status is used to determine the action type to
"^DD",123.1,123.1,1,1,1,"%D",3,0)
use to update activity tracking.
"^DD",123.1,123.1,1,1,1,"DT")
2910529
"^DD",123.1,123.1,1,3)
This is the CPRS Status used to update the order in CPRS.
"^DD",123.1,123.1,1,21,0)
^^2^2^2970911^^^^
"^DD",123.1,123.1,1,21,1,0)
This is the CPRS status which will be used to update the order in OE/RR
"^DD",123.1,123.1,1,21,2,0)
when this action is taken.
"^DD",123.1,123.1,1,"DT")
2970911
"^DD",123.1,123.1,3,0)
DISABLED MESSAGE^F^^0;4^K:$L(X)>40!($L(X)<1) X
"^DD",123.1,123.1,3,3)
Enter the message that will display when this action is disabled, 1-40 characters.
"^DD",123.1,123.1,3,21,0)
^^2^2^2970911^^^^
"^DD",123.1,123.1,3,21,1,0)
This field displays a 'DISABLED' message when this CPRS status has been
"^DD",123.1,123.1,3,21,2,0)
disabled.
"^DD",123.1,123.1,3,"DT")
2920225
"^DD",123.1,123.1,4,0)
HL7 CONTROL CODE FROM CONSULTS^F^^0;5^K:$L(X)>2!($L(X)<1) X
"^DD",123.1,123.1,4,3)
Enter 2 character HL7 code related to the action.
"^DD",123.1,123.1,4,21,0)
^^12^12^2971112^
"^DD",123.1,123.1,4,21,1,0)
This field indicates what HL7 control code is passed to CPRS from
"^DD",123.1,123.1,4,21,2,0)
Consults.
"^DD",123.1,123.1,4,21,3,0)
    Example: 
"^DD",123.1,123.1,4,21,4,0)
             "SN"=Service entered, backdoor consult, automatically
"^DD",123.1,123.1,4,21,5,0)
released from CPRS, though signatures may still be required depending on
"^DD",123.1,123.1,4,21,6,0)
nature of order
"^DD",123.1,123.1,4,21,7,0)
             "OD"=Discontinued
"^DD",123.1,123.1,4,21,8,0)
             "OC"=Denied by service (Cancelled)
"^DD",123.1,123.1,4,21,9,0)
             "SC"=Service status update (generic status change) for active
"^DD",123.1,123.1,4,21,10,0)
and partial results
"^DD",123.1,123.1,4,21,11,0)
             "XX"=Forwarded
"^DD",123.1,123.1,4,21,12,0)
             "RE"=Completed
"^DD",123.1,123.1,4,"DT")
2971112
"^DD",123.1,123.1,5,0)
HL7 CONTROL CODE FROM CPRS^F^^0;6^K:$L(X)>2!($L(X)<1) X
"^DD",123.1,123.1,5,1,0)
^.1
"^DD",123.1,123.1,5,1,1,0)
123.1^D
"^DD",123.1,123.1,5,1,1,1)
S ^GMR(123.1,"D",$E(X,1,30),DA)=""
"^DD",123.1,123.1,5,1,1,2)
K ^GMR(123.1,"D",$E(X,1,30),DA)
"^DD",123.1,123.1,5,1,1,"%D",0)
^^2^2^2971112^
"^DD",123.1,123.1,5,1,1,"%D",1,0)
This cross-reference allows Consults to convert an order control from
"^DD",123.1,123.1,5,1,1,"%D",2,0)
HL7 Table 0119 to a Consult activity for tracking.
"^DD",123.1,123.1,5,1,1,"DT")
2971112
"^DD",123.1,123.1,5,3)
Enter the HL7 Control code passed from CPRS for this action.
"^DD",123.1,123.1,5,21,0)
^^5^5^2971112^
"^DD",123.1,123.1,5,21,1,0)
This field indicates what HL7 control code is passed from CPRS to
"^DD",123.1,123.1,5,21,2,0)
Consults.
"^DD",123.1,123.1,5,21,3,0)
    Example: "NW"=New consult entered and released through CPRS
"^DD",123.1,123.1,5,21,4,0)
             "CA"=Cancelled via the orders tab
"^DD",123.1,123.1,5,21,5,0)
             "DC"=Discontinued
"^DD",123.1,123.1,5,"DT")
2971112
"^DD",123.1,123.1,6,0)
HL7 TABLE 38 ORDER STATUS^F^^0;7^K:$L(X)>2!($L(X)<1) X
"^DD",123.1,123.1,6,3)
Enter the 1-2 character code from HL7 Table 0038
"^DD",123.1,123.1,6,21,0)
^^2^2^2971114^
"^DD",123.1,123.1,6,21,1,0)
This field is for documenting purposes and contains the related Table 38
"^DD",123.1,123.1,6,21,2,0)
order status from HL7 for each activity.
"^DD",123.1,123.1,6,"DT")
2971114
"^DD",123.1,123.1,7,0)
ACTION PRINT NAME^F^^0;8^K:$L(X)>30!($L(X)<1) X
"^DD",123.1,123.1,7,3)
Enter the text to appear before comments on the 513
"^DD",123.1,123.1,7,21,0)
^^1^1^2980624^
"^DD",123.1,123.1,7,21,1,0)
This field is used on the 513 Form as a header for comments.
"^DD",123.1,123.1,7,"DT")
2980624
"^DD",123.3,123.3,3,0)
INTERNAL NAME^F^^3;1^K:$L(X)>80!($L(X)<2) X
"^DD",123.3,123.3,3,1,0)
^.1
"^DD",123.3,123.3,3,1,1,0)
123.3^D
"^DD",123.3,123.3,3,1,1,1)
S ^GMR(123.3,"D",$E(X,1,30),DA)=""
"^DD",123.3,123.3,3,1,1,2)
K ^GMR(123.3,"D",$E(X,1,30),DA)
"^DD",123.3,123.3,3,1,1,"%D",0)
^^2^2^3020201^
"^DD",123.3,123.3,3,1,1,"%D",1,0)
This cross-reference allows the look up of a procedure by the INTERNAL 
"^DD",123.3,123.3,3,1,1,"%D",2,0)
NAME.
"^DD",123.3,123.3,3,1,1,"DT")
3020201
"^DD",123.3,123.3,3,3)
Enter a name by which this service can be referred
"^DD",123.3,123.3,3,21,0)
^^4^4^3020131^
"^DD",123.3,123.3,3,21,1,0)
This field holds a name that can be used for internal name-spacing. 
"^DD",123.3,123.3,3,21,2,0)
This name will not be viewable to users when selecting a procedure. 
"^DD",123.3,123.3,3,21,3,0)
This name may be used to look up entries in the file via VA 
"^DD",123.3,123.3,3,21,4,0)
Fileman and the Setup Procedures option.
"^DD",123.3,123.3,3,"DT")
3020201
"^DD",123.3,123.3,126,0)
IFC ROUTING SITE^*P4'^DIC(4,^IFC;1^S DIC("S")="N STA S STA=$$STA^XUAF4(+Y) I STA,STA=+STA,+Y'=$$KSP^XUPARAM(""INST"")" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",123.3,123.3,126,3)
Enter the facility where this procedure will be performed.
"^DD",123.3,123.3,126,12)
Only national INSTITUTION file entries may be selected.
"^DD",123.3,123.3,126,12.1)
S DIC("S")="N STA S STA=$$STA^XUAF4(+Y) I STA,STA=+STA,+Y'=$$KSP^XUPARAM(""INST"")"
"^DD",123.3,123.3,126,21,0)
^.001^3^3^3020218^^^
"^DD",123.3,123.3,126,21,1,0)
This field contains the VA facility that will perform this procedure 
"^DD",123.3,123.3,126,21,2,0)
when requested. When a request for this procedure is ordered, it will
"^DD",123.3,123.3,126,21,3,0)
automatically be routed to the VA facility in this field.
"^DD",123.3,123.3,126,"DT")
3020218
"^DD",123.3,123.3,127,0)
IFC REMOTE PROC NAME^F^^IFC;2^K:$L(X)>63!($L(X)<3) X
"^DD",123.3,123.3,127,3)
Answer must be 3-63 characters in length.
"^DD",123.3,123.3,127,21,0)
^^8^8^3011120^
"^DD",123.3,123.3,127,21,1,0)
This field contains the name of the PROCEDURE that will be requested 
"^DD",123.3,123.3,127,21,2,0)
at the VAMC defined in the IFC ROUTING SITE field.
"^DD",123.3,123.3,127,21,3,0)
 
"^DD",123.3,123.3,127,21,4,0)
Enter the name of the procedure exactly as it is named at the remote
"^DD",123.3,123.3,127,21,5,0)
facility. If this name does not match the name of the procedure at 
"^DD",123.3,123.3,127,21,6,0)
the routing site, the request will fail to be filed at the remote site.
"^DD",123.3,123.3,127,21,7,0)
This will delay or prohibit the performance and processing of this
"^DD",123.3,123.3,127,21,8,0)
request.
"^DD",123.3,123.3,127,"DT")
3011120
"^DD",123.3,123.3,128,0)
IFC SENDING FACILITY^123.3128P^^IFCS;0
"^DD",123.3,123.3,129,0)
IFC COORDINATOR^P200'^VA(200,^IFC;3^Q
"^DD",123.3,123.3,129,21,0)
^^4^4^3011207^
"^DD",123.3,123.3,129,21,1,0)
The person entered in this field will have expanded abilities to correct 
"^DD",123.3,123.3,129,21,2,0)
IFC records that require manual intervention to remain updated.
"^DD",123.3,123.3,129,21,3,0)
 
"^DD",123.3,123.3,129,21,4,0)
The full capabilities of this field are not yet defined.
"^DD",123.3,123.3,129,"DT")
3011207
"^DD",123.3,123.3128,0)
IFC SENDING FACILITY SUB-FIELD^^.01^1
"^DD",123.3,123.3128,0,"DT")
3020124
"^DD",123.3,123.3128,0,"IX","B",123.3128,.01)

"^DD",123.3,123.3128,0,"NM","IFC SENDING FACILITY")

"^DD",123.3,123.3128,0,"UP")
123.3
"^DD",123.3,123.3128,.01,0)
IFC SENDING FACILITY^M*P4'^DIC(4,^0;1^S DIC("S")="N STA S STA=$$STA^XUAF4(+Y) I STA,STA=+STA" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",123.3,123.3128,.01,1,0)
^.1
"^DD",123.3,123.3128,.01,1,1,0)
123.3128^B
"^DD",123.3,123.3128,.01,1,1,1)
S ^GMR(123.3,DA(1),"IFCS","B",$E(X,1,30),DA)=""
"^DD",123.3,123.3128,.01,1,1,2)
K ^GMR(123.3,DA(1),"IFCS","B",$E(X,1,30),DA)
"^DD",123.3,123.3128,.01,12)
Only national INSTITUTION file entries may be selected.
"^DD",123.3,123.3128,.01,12.1)
S DIC("S")="N STA S STA=$$STA^XUAF4(+Y) I STA,STA=+STA"
"^DD",123.3,123.3128,.01,21,0)
^.001^3^3^3020124^^
"^DD",123.3,123.3128,.01,21,1,0)
This field contains the VA facilities that may send inter-facility 
"^DD",123.3,123.3128,.01,21,2,0)
requests for this procedure. Only active, primary VA facilities
"^DD",123.3,123.3128,.01,21,3,0)
should be entered in this field.
"^DD",123.3,123.3128,.01,"DT")
3020124
"^DD",123.5,123.5,11,0)
INTERNAL NAME^F^^11;1^K:$L(X)>80!($L(X)<2) X
"^DD",123.5,123.5,11,1,0)
^.1
"^DD",123.5,123.5,11,1,1,0)
123.5^E
"^DD",123.5,123.5,11,1,1,1)
S ^GMR(123.5,"E",$E(X,1,30),DA)=""
"^DD",123.5,123.5,11,1,1,2)
K ^GMR(123.5,"E",$E(X,1,30),DA)
"^DD",123.5,123.5,11,1,1,"DT")
3020130
"^DD",123.5,123.5,11,3)
Answer must be 2-80 characters in length
"^DD",123.5,123.5,11,21,0)
^^4^4^3020131^
"^DD",123.5,123.5,11,21,1,0)
This field holds a name that can be used for internal name-spacing. 
"^DD",123.5,123.5,11,21,2,0)
This name will not be viewable to users when selecting a service. 
"^DD",123.5,123.5,11,21,3,0)
This name may be used to look up entries in the file via VA Fileman 
"^DD",123.5,123.5,11,21,4,0)
and the Setup Consult Services option.
"^DD",123.5,123.5,11,"DT")
3020131
"^DD",123.5,123.5,132,0)
IFC ROUTING SITE^*P4'^DIC(4,^IFC;1^S DIC("S")="N STA S STA=$$STA^XUAF4(+Y) I STA,STA=+STA,+Y'=$$KSP^XUPARAM(""INST"")" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",123.5,123.5,132,3)
Enter the VA site that will perform consults directed to this service
"^DD",123.5,123.5,132,12)
Only national institution file entries may be selected
"^DD",123.5,123.5,132,12.1)
S DIC("S")="N STA S STA=$$STA^XUAF4(+Y) I STA,STA=+STA,+Y'=$$KSP^XUPARAM(""INST"")"
"^DD",123.5,123.5,132,21,0)
^.001^4^4^3020218^^^^
"^DD",123.5,123.5,132,21,1,0)
This field contains the VA facility that will perform consults 
"^DD",123.5,123.5,132,21,2,0)
requested for this service. When a consult for this service is 
"^DD",123.5,123.5,132,21,3,0)
ordered, it will automatically be routed to the VA facility in 
"^DD",123.5,123.5,132,21,4,0)
this field.
"^DD",123.5,123.5,132,"DT")
3020218
"^DD",123.5,123.5,133,0)
IFC REMOTE NAME^F^^IFC;2^K:$L(X)>63!($L(X)<2) X
"^DD",123.5,123.5,133,3)
Enter the name of the service at the consulting site
"^DD",123.5,123.5,133,21,0)
^^8^8^3011120^
"^DD",123.5,123.5,133,21,1,0)
This field contains the name of the service that will be requested at 
"^DD",123.5,123.5,133,21,2,0)
the VAMC defined in the IFC ROUTING SITE field.
"^DD",123.5,123.5,133,21,3,0)
 
"^DD",123.5,123.5,133,21,4,0)
Enter the name of the service exactly as it is named at the remote
"^DD",123.5,123.5,133,21,5,0)
facility. If this name does not match the name of the service at the
"^DD",123.5,123.5,133,21,6,0)
routing site, the request will fail to be filed at the remote site. 
"^DD",123.5,123.5,133,21,7,0)
This will delay or prohibit the performance and processing of this
"^DD",123.5,123.5,133,21,8,0)
request.
"^DD",123.5,123.5,133,"DT")
3010907
"^DD",123.5,123.5,134,0)
IFC SENDING FACILITY^123.5134P^^IFCS;0
"^DD",123.5,123.5,135,0)
IFC COORDINATOR^P200'^VA(200,^IFC;3^Q
"^DD",123.5,123.5,135,3)
Please enter the person that will administer inter-facility consults for this service.
"^DD",123.5,123.5,135,21,0)
^^4^4^3011017^
"^DD",123.5,123.5,135,21,1,0)
The person entered in this field will have the ability to act on consults
"^DD",123.5,123.5,135,21,2,0)
that would not otherwise be accessible to other update users for this 
"^DD",123.5,123.5,135,21,3,0)
service. This user will also be able to rectify certain communication 
"^DD",123.5,123.5,135,21,4,0)
failures with Inter-facility Consults.
"^DD",123.5,123.5,135,"DT")
3011017
"^DD",123.5,123.5134,0)
IFC SENDING FACILITY SUB-FIELD^^.01^1
"^DD",123.5,123.5134,0,"DT")
3020124
"^DD",123.5,123.5134,0,"IX","B",123.5134,.01)

"^DD",123.5,123.5134,0,"NM","IFC SENDING FACILITY")

"^DD",123.5,123.5134,0,"UP")
123.5
"^DD",123.5,123.5134,.01,0)
IFC SENDING FACILITY^M*P4'^DIC(4,^0;1^S DIC("S")="N STA S STA=$$STA^XUAF4(+Y) I STA,STA=+STA" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",123.5,123.5134,.01,1,0)
^.1
"^DD",123.5,123.5134,.01,1,1,0)
123.5134^B
"^DD",123.5,123.5134,.01,1,1,1)
S ^GMR(123.5,DA(1),"IFCS","B",$E(X,1,30),DA)=""
"^DD",123.5,123.5134,.01,1,1,2)
K ^GMR(123.5,DA(1),"IFCS","B",$E(X,1,30),DA)
"^DD",123.5,123.5134,.01,3)
Enter a VA Facility that will send consults for this service.
"^DD",123.5,123.5134,.01,12)
Only national INSTITUTION file entries may be selected.
"^DD",123.5,123.5134,.01,12.1)
S DIC("S")="N STA S STA=$$STA^XUAF4(+Y) I STA,STA=+STA"
"^DD",123.5,123.5134,.01,21,0)
^.001^3^3^3020124^^
"^DD",123.5,123.5134,.01,21,1,0)
This field contains the VA facilities that may send inter-facility 
"^DD",123.5,123.5134,.01,21,2,0)
consults to this service. Only active, primary VA facilities should 
"^DD",123.5,123.5134,.01,21,3,0)
be entered in this field.
"^DD",123.5,123.5134,.01,"DT")
3020124
"^DD",123.6,123.6,0)
FIELD^^.08^8
"^DD",123.6,123.6,0,"DDA")
N
"^DD",123.6,123.6,0,"DT")
3011015
"^DD",123.6,123.6,0,"IX","AI",123.6,.06)

"^DD",123.6,123.6,0,"IX","AM",123.6,.03)

"^DD",123.6,123.6,0,"IX","B",123.6,.01)

"^DD",123.6,123.6,0,"NM","IFC MESSAGE LOG")

"^DD",123.6,123.6,.01,0)
DATE/TIME OF ENTRY^RD^^0;1^S %DT="ESTX" D ^%DT S X=Y K:X<1 X
"^DD",123.6,123.6,.01,1,0)
^.1
"^DD",123.6,123.6,.01,1,1,0)
123.6^B
"^DD",123.6,123.6,.01,1,1,1)
S ^GMR(123.6,"B",$E(X,1,30),DA)=""
"^DD",123.6,123.6,.01,1,1,2)
K ^GMR(123.6,"B",$E(X,1,30),DA)
"^DD",123.6,123.6,.01,3)
(No range limit on date)
"^DD",123.6,123.6,.01,21,0)
^^2^2^3011207^
"^DD",123.6,123.6,.01,21,1,0)
This is the date time an HL7 message was directed to another VistA system
"^DD",123.6,123.6,.01,21,2,0)
containing an inter-facility consult update.
"^DD",123.6,123.6,.01,"DT")
3011207
"^DD",123.6,123.6,.02,0)
FACILITY^P4'^DIC(4,^0;2^Q
"^DD",123.6,123.6,.02,3)
Enter the INSTITUTION to which this message is directed
"^DD",123.6,123.6,.02,21,0)
^^2^2^3011207^
"^DD",123.6,123.6,.02,21,1,0)
This field contains the institution to which an HL7 message was sent. The 
"^DD",123.6,123.6,.02,21,2,0)
messages contain updates to an inter-facility consult. 
"^DD",123.6,123.6,.02,"DT")
3011207
"^DD",123.6,123.6,.03,0)
MESSAGE #^F^^0;3^K:$L(X)>20!($L(X)<2) X
"^DD",123.6,123.6,.03,1,0)
^.1
"^DD",123.6,123.6,.03,1,1,0)
123.6^AM
"^DD",123.6,123.6,.03,1,1,1)
S ^GMR(123.6,"AM",$E(X,1,30),DA)=""
"^DD",123.6,123.6,.03,1,1,2)
K ^GMR(123.6,"AM",$E(X,1,30),DA)
"^DD",123.6,123.6,.03,1,1,"DT")
3011010
"^DD",123.6,123.6,.03,3)
Enter the number of the HL7 message that corresponds to this entry
"^DD",123.6,123.6,.03,21,0)
^^3^3^3011207^
"^DD",123.6,123.6,.03,21,1,0)
This is the HL7 message number generated by the VistA HL7 package. This 
"^DD",123.6,123.6,.03,21,2,0)
message number is used to match up the application acknowledgement from 
"^DD",123.6,123.6,.03,21,3,0)
the remote system to the event that generated it. 
"^DD",123.6,123.6,.03,"DT")
3011207
"^DD",123.6,123.6,.04,0)
CONSULT/REQUEST #^NJ7,0^^0;4^K:+X'=X!(X>9999999)!(X<1)!(X?.E1"."1N.N) X
"^DD",123.6,123.6,.04,1,0)
^.1^^0
"^DD",123.6,123.6,.04,3)
Enter the file 123 IEN that initiated this message
"^DD",123.6,123.6,.04,21,0)
^^2^2^3011207^
"^DD",123.6,123.6,.04,21,1,0)
This is the numeric respresentation of the REQUEST/CONSULTATION file 
"^DD",123.6,123.6,.04,21,2,0)
entry that generated this message activity.
"^DD",123.6,123.6,.04,"DT")
3011207
"^DD",123.6,123.6,.05,0)
ACTIVITY #^NJ3,0^^0;5^K:+X'=X!(X>999)!(X<1)!(X?.E1"."1.N) X
"^DD",123.6,123.6,.05,3)
Enter the field 40 IEN that initiated this message
"^DD",123.6,123.6,.05,21,0)
^^3^3^3011207^
"^DD",123.6,123.6,.05,21,1,0)
This is the numeric representation of the ien within the REQUEST 
"^DD",123.6,123.6,.05,21,2,0)
PROCESSING ACTIVITY multiple for the consult entry referenced in the 
"^DD",123.6,123.6,.05,21,3,0)
CONSULT # field.
"^DD",123.6,123.6,.05,"DT")
3011207
"^DD",123.6,123.6,.06,0)
INCOMPLETE^S^1:YES;^0;6^Q
"^DD",123.6,123.6,.06,1,0)
^.1
"^DD",123.6,123.6,.06,1,1,0)
123.6^AI
"^DD",123.6,123.6,.06,1,1,1)
S ^GMR(123.6,"AI",$E(X,1,30),DA)=""
"^DD",123.6,123.6,.06,1,1,2)
K ^GMR(123.6,"AI",$E(X,1,30),DA)
"^DD",123.6,123.6,.06,1,1,"DT")
3011010
"^DD",123.6,123.6,.06,3)
Enter Yes if this transmission has not received the appl ACK
"^DD",123.6,123.6,.06,21,0)
^^2^2^3011207^
"^DD",123.6,123.6,.06,21,1,0)
This field is set to YES until a successful application accept 
"^DD",123.6,123.6,.06,21,2,0)
acknowledgement is received from the remote VistA system.
"^DD",123.6,123.6,.06,"DT")
3011207
"^DD",123.6,123.6,.07,0)
TRANS. ATTEMPTS^NJ2,0^^0;7^K:+X'=X!(X>20)!(X<1)!(X?.E1"."1.N) X
"^DD",123.6,123.6,.07,3)
Type a number between 1 and 20, 0 Decimal Digits
"^DD",123.6,123.6,.07,21,0)
^^2^2^3011207^
"^DD",123.6,123.6,.07,21,1,0)
This field contains the number of times an HL7 message containing a 
"^DD",123.6,123.6,.07,21,2,0)
particular consult activity was transmitted to a remote VistA system.
"^DD",123.6,123.6,.07,"DT")
3011207
"^DD",123.6,123.6,.08,0)
ERROR^NJ4,0O^^0;8^K:+X'=X!(X>1000)!(X<100)!(X?.E1"."1N.N) X
"^DD",123.6,123.6,.08,2)
S Y(0)=Y S Y="ERR"_Y_"^GMRCIUTL" S Y=$T(@Y),Y=$P(Y,";",2)
"^DD",123.6,123.6,.08,2.1)
S Y="ERR"_Y_"^GMRCIUTL" S Y=$T(@Y),Y=$P(Y,";",2)
"^DD",123.6,123.6,.08,3)
Type a Number between 100 and 1000, 0 Decimal Digits
"^DD",123.6,123.6,.08,21,0)
^^5^5^3020308^
"^DD",123.6,123.6,.08,21,1,0)
This field contains the error condition noted on the receiving site
"^DD",123.6,123.6,.08,21,2,0)
when receiving an IFC HL7 message.
"^DD",123.6,123.6,.08,21,3,0)
 
"^DD",123.6,123.6,.08,21,4,0)
The error code numbers are defined and maintained within package 
"^DD",123.6,123.6,.08,21,5,0)
documentation. 
"^DD",123.6,123.6,.08,"DT")
3011207
"^DIC",123.1,123.1,0)
REQUEST ACTION TYPES^123.1
"^DIC",123.1,123.1,0,"GL")
^GMR(123.1,
"^DIC",123.1,123.1,"%D",0)
^^6^6^2921119^^^^
"^DIC",123.1,123.1,"%D",1,0)
This file identifies the action types which may be used by a service to 
"^DIC",123.1,123.1,"%D",2,0)
track activity related to a consult or request.
"^DIC",123.1,123.1,"%D",3,0)
  
"^DIC",123.1,123.1,"%D",4,0)
Certain action types may have a "GMRCACT " protocol entry in the Protocol
"^DIC",123.1,123.1,"%D",5,0)
File (101) which corresponds to the action type.  Two actions should not 
"^DIC",123.1,123.1,"%D",6,0)
point to the same protocol.
"^DIC",123.1,"B","REQUEST ACTION TYPES",123.1)

"^DIC",123.6,123.6,0)
IFC MESSAGE LOG^123.6
"^DIC",123.6,123.6,0,"GL")
^GMR(123.6,
"^DIC",123.6,123.6,"%",0)
^1.005^^
"^DIC",123.6,123.6,"%D",0)
^^9^9^3011210^
"^DIC",123.6,123.6,"%D",1,0)
This file is used to maintain a log of transmissions of inter-facility 
"^DIC",123.6,123.6,"%D",2,0)
consult activities to a remote VistA system. The file will record the 
"^DIC",123.6,123.6,"%D",3,0)
record and activity that triggered the transmission as well as the 
"^DIC",123.6,123.6,"%D",4,0)
facility to which the transmission was directed. Any transmission that 
"^DIC",123.6,123.6,"%D",5,0)
receives a negative acknowledgement from the remote system will have an 
"^DIC",123.6,123.6,"%D",6,0)
error code recorded. 
"^DIC",123.6,123.6,"%D",7,0)
 
"^DIC",123.6,123.6,"%D",8,0)
Upon successful completion of a transmission with successful 
"^DIC",123.6,123.6,"%D",9,0)
acknowledgement, entries will be deleted after approximately one week.
"^DIC",123.6,"B","IFC MESSAGE LOG",123.6)

**END**
**END**
