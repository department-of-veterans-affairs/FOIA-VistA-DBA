Released PSJ*5*140 SEQ #131
Extracted from mail message
**KIDS**:PSJ*5.0*140^

**INSTALL NAME**
PSJ*5.0*140
"BLD",5289,0)
PSJ*5.0*140^INPATIENT MEDICATIONS^0^3050819^y
"BLD",5289,1,0)
^^17^17^3050819^
"BLD",5289,1,1,0)
 HD0000000086021 - IV Renewal Issue
"BLD",5289,1,2,0)
 -----------------------------------
"BLD",5289,1,3,0)
 When finishing a renewed IV order via Inpatient Order Entry [PSJ OE]
"BLD",5289,1,4,0)
 it is possible to enter the same stop date as the original for
"BLD",5289,1,5,0)
 the renewed order.  This will cause the database to improperly
"BLD",5289,1,6,0)
 index the renewal.  This causes the wrong number of labels to print as
"BLD",5289,1,7,0)
 well as not printing this order on the Ward List report. This patch
"BLD",5289,1,8,0)
 will resolve this issue by correcting indexing the renewal.
"BLD",5289,1,9,0)
 
"BLD",5289,1,10,0)
 HD0000000068894 - PSJOE Error
"BLD",5289,1,11,0)
 -----------------------------------
"BLD",5289,1,12,0)
 The following error has appeared in the error trap at various sites:
"BLD",5289,1,13,0)
 
"BLD",5289,1,14,0)
 <UNDEFINED>DISACTIO+36^PSJOE
"BLD",5289,1,15,0)
 
"BLD",5289,1,16,0)
 This patch will resolve this issue by re-initializing the variable in
"BLD",5289,1,17,0)
 question.
"BLD",5289,4,0)
^9.64PA^^
"BLD",5289,"ABPKG")
n
"BLD",5289,"KRN",0)
^9.67PA^8989.52^19
"BLD",5289,"KRN",.4,0)
.4
"BLD",5289,"KRN",.401,0)
.401
"BLD",5289,"KRN",.402,0)
.402
"BLD",5289,"KRN",.403,0)
.403
"BLD",5289,"KRN",.5,0)
.5
"BLD",5289,"KRN",.84,0)
.84
"BLD",5289,"KRN",3.6,0)
3.6
"BLD",5289,"KRN",3.8,0)
3.8
"BLD",5289,"KRN",9.2,0)
9.2
"BLD",5289,"KRN",9.8,0)
9.8
"BLD",5289,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5289,"KRN",9.8,"NM",1,0)
PSJOE^^0^B81086559
"BLD",5289,"KRN",9.8,"NM",2,0)
PSIVOREN^^0^B28317661
"BLD",5289,"KRN",9.8,"NM","B","PSIVOREN",2)

"BLD",5289,"KRN",9.8,"NM","B","PSJOE",1)

"BLD",5289,"KRN",19,0)
19
"BLD",5289,"KRN",19.1,0)
19.1
"BLD",5289,"KRN",101,0)
101
"BLD",5289,"KRN",409.61,0)
409.61
"BLD",5289,"KRN",771,0)
771
"BLD",5289,"KRN",870,0)
870
"BLD",5289,"KRN",8989.51,0)
8989.51
"BLD",5289,"KRN",8989.52,0)
8989.52
"BLD",5289,"KRN",8994,0)
8994
"BLD",5289,"KRN","B",.4,.4)

"BLD",5289,"KRN","B",.401,.401)

"BLD",5289,"KRN","B",.402,.402)

"BLD",5289,"KRN","B",.403,.403)

"BLD",5289,"KRN","B",.5,.5)

"BLD",5289,"KRN","B",.84,.84)

"BLD",5289,"KRN","B",3.6,3.6)

"BLD",5289,"KRN","B",3.8,3.8)

"BLD",5289,"KRN","B",9.2,9.2)

"BLD",5289,"KRN","B",9.8,9.8)

"BLD",5289,"KRN","B",19,19)

"BLD",5289,"KRN","B",19.1,19.1)

"BLD",5289,"KRN","B",101,101)

"BLD",5289,"KRN","B",409.61,409.61)

"BLD",5289,"KRN","B",771,771)

"BLD",5289,"KRN","B",870,870)

"BLD",5289,"KRN","B",8989.51,8989.51)

"BLD",5289,"KRN","B",8989.52,8989.52)

"BLD",5289,"KRN","B",8994,8994)

"BLD",5289,"QUES",0)
^9.62^^
"BLD",5289,"REQB",0)
^9.611^1^1
"BLD",5289,"REQB",1,0)
PSJ*5.0*133^2
"BLD",5289,"REQB","B","PSJ*5.0*133",1)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
140^3050819^10000000054
"PKG",197,22,1,"PAH",1,1,0)
^^17^17^3050819
"PKG",197,22,1,"PAH",1,1,1,0)
 HD0000000086021 - IV Renewal Issue
"PKG",197,22,1,"PAH",1,1,2,0)
 -----------------------------------
"PKG",197,22,1,"PAH",1,1,3,0)
 When finishing a renewed IV order via Inpatient Order Entry [PSJ OE]
"PKG",197,22,1,"PAH",1,1,4,0)
 it is possible to enter the same stop date as the original for
"PKG",197,22,1,"PAH",1,1,5,0)
 the renewed order.  This will cause the database to improperly
"PKG",197,22,1,"PAH",1,1,6,0)
 index the renewal.  This causes the wrong number of labels to print as
"PKG",197,22,1,"PAH",1,1,7,0)
 well as not printing this order on the Ward List report. This patch
"PKG",197,22,1,"PAH",1,1,8,0)
 will resolve this issue by correcting indexing the renewal.
"PKG",197,22,1,"PAH",1,1,9,0)
 
"PKG",197,22,1,"PAH",1,1,10,0)
 HD0000000068894 - PSJOE Error
"PKG",197,22,1,"PAH",1,1,11,0)
 -----------------------------------
"PKG",197,22,1,"PAH",1,1,12,0)
 The following error has appeared in the error trap at various sites:
"PKG",197,22,1,"PAH",1,1,13,0)
 
"PKG",197,22,1,"PAH",1,1,14,0)
 <UNDEFINED>DISACTIO+36^PSJOE
"PKG",197,22,1,"PAH",1,1,15,0)
 
"PKG",197,22,1,"PAH",1,1,16,0)
 This patch will resolve this issue by re-initializing the variable in
"PKG",197,22,1,"PAH",1,1,17,0)
 question.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSIVOREN")
0^2^B28317661
"RTN","PSIVOREN",1,0)
PSIVOREN ;BIR/MLM-UTILITIES FOR IV FLUIDS - OE/RR INTERFACE ; 25 Sep 98 / 2:00 PM
"RTN","PSIVOREN",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**3,18,69,110,127,133,140**;16 DEC 97
"RTN","PSIVOREN",3,0)
 ;
"RTN","PSIVOREN",4,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSIVOREN",5,0)
 ; Reference to ^VA(200 is supported by DBIA 10060.
"RTN","PSIVOREN",6,0)
 ; Reference to ^DIE is supported by DBIA 10018.
"RTN","PSIVOREN",7,0)
 ;
"RTN","PSIVOREN",8,0)
ENCPP ; Check Package Parameter
"RTN","PSIVOREN",9,0)
 D ORPARM I 'PSJORF W !!,"Inpatient Medications is not turned on for OE/RR.",!,"You will not be able to enter or edit IV or Unit Dose orders."
"RTN","PSIVOREN",10,0)
 I 'PSJIVORF W !!,"IV Medications is not turned on for OE/RR.",!,"You will not be able to enter or edit IV orders."
"RTN","PSIVOREN",11,0)
 I 'PSJORF!'PSJIVORF S PSJIVORF="" D DONE^PSIVORA1 Q
"RTN","PSIVOREN",12,0)
 S PSJORL=$G(VAIN(4)) I 'PSJORL,$G(DFN) D INP^VADPT S PSJORL=$G(VAIN(4))
"RTN","PSIVOREN",13,0)
 S PSJORPF=0,P("OT")="F^",PSJORNP=$S($G(PSJORNP):PSJORNP,1:+$G(DUZ))
"RTN","PSIVOREN",14,0)
 ;; S PSJORL=ORL,PSJORPF=0,P("OT")="F^"_$O(^ORD(101,"B","PSJI OR PAT FLUID OE",0))_";ORD(101,",PSJORNP=ORNP
"RTN","PSIVOREN",15,0)
 Q
"RTN","PSIVOREN",16,0)
 ;
"RTN","PSIVOREN",17,0)
PS ; Check if MD is authorized to write med. orders.
"RTN","PSIVOREN",18,0)
 S PSJORPF=0 S:PSJORNP X=$G(^VA(200,+PSJORNP,"PS")) Q:$S('PSJORNP:0,'X:0,'$P(X,U,4):1,$P(X,U,4)>DT:1,1:0)  D
"RTN","PSIVOREN",19,0)
 .W !?2,"(The selected PROVIDER is NOT qualified to write MEDICATION orders.  You must",!,"select a valid provider to be able to continue with Inpatient Medications.)"
"RTN","PSIVOREN",20,0)
 .K DIC S DIC="^VA(200,",DIC(0)="AEMQZ",DIC("A")="Select PHARMACY PROVIDER: ",DIC("S")="S PSIV=$G(^(""PS"")) I PSIV,$S($P(PSIV,""^"",4)="""":1,DT<$P(PSIV,""^"",4):1,1:0)" F  W ! D ^DIC Q:$D(DUOUT)!$D(DTOUT)!(Y>0)  W $C(7),"  (Required.)"
"RTN","PSIVOREN",21,0)
 .K DIC S:Y'>0 PSJORPF=11 S:Y>0 PSJORNP=+Y Q
"RTN","PSIVOREN",22,0)
 K DTOUT
"RTN","PSIVOREN",23,0)
 Q
"RTN","PSIVOREN",24,0)
 ;
"RTN","PSIVOREN",25,0)
RUPDATE(DFN,ON,NSTRT) ;
"RTN","PSIVOREN",26,0)
 ; Update renewal orders (called from Pharmacy options).
"RTN","PSIVOREN",27,0)
 N DA,DIE,DR,ND,NSTOP,OSTOP,NOO,ORETURN,PSIVACT,PSIVAL,PSIVALCK,PSJOSTRT,PSGOLDOE S DIE="^PS(55,"_DFN_","
"RTN","PSIVOREN",28,0)
 I ON["P" S OLDON=$P($G(^PS(53.1,+ON,0)),"^",25),NOO=$P($G(^PS(53.1,+ON,.2)),"^",3)
"RTN","PSIVOREN",29,0)
 I ON["V" S OLDON=ON,NOO=$P($G(^PS(55,DFN,"IV",+ON,.2)),"^",5)
"RTN","PSIVOREN",30,0)
 I ON["U" S OLDON=$P($G(^PS(55,DFN,5,+ON,0)),U,25)
"RTN","PSIVOREN",31,0)
 I OLDON["P" S OLDON=$P($G(^PS(53.1,+OLDON,0)),U,25)
"RTN","PSIVOREN",32,0)
 I OLDON["V" S ON55=OLDON,X=$G(^PS(55,DFN,"IV",+OLDON,2)),PSJOSTRT=$P(X,U,7),OSTOP=$S(($G(PSJOSTOP)>PSJOSTRT):PSJOSTOP,1:$P($G(^(0)),U,3)),DIE=DIE_"""IV"",",DR="100////A",PSIVACT=1
"RTN","PSIVOREN",33,0)
 I OLDON["U" S X=$G(^PS(55,DFN,5,+OLDON,2)),PSJOSTRT=$P(X,U,7),OSTOP=$P(X,U,4),DIE=DIE_"5,"
"RTN","PSIVOREN",34,0)
 S NSTOP=+$S($G(P(3)):P(3),1:0),DA=+OLDON,DA(1)=DFN I 'NSTOP W !,"CAN'T RENEW THIS ORDER!" D PAUSE^VALM1 Q
"RTN","PSIVOREN",35,0)
 ;I OSTOP>NSTOP W !,"NEW STOP DATE IS LESS THAN PREVIOUS STOP DATE" D PAUSE^VALM1
"RTN","PSIVOREN",36,0)
 ;
"RTN","PSIVOREN",37,0)
 I ON["V"!(ON["P") D EXPOE^PSGOER(DFN,ON)
"RTN","PSIVOREN",38,0)
 ;
"RTN","PSIVOREN",39,0)
 S DR=DR_";"_$S(OLDON["V":.03,OLDON["U":34,1:25)_"////"_NSTOP_";"_$S(OLDON["V":"114////@;123////@",1:"105////@;107////@") S:+$G(P(6))?1.30N DR=DR_";.06////"_+P(6) D ^DIE
"RTN","PSIVOREN",40,0)
 I ON["P" S DIE="^PS(53.1,",DR="28////A;105////@;",DA=+ON D ^DIE D
"RTN","PSIVOREN",41,0)
 .I $G(OLDON)["V" S PSGOLDOE=$P($G(^PS(55,DFN,"IV",+OLDON,0)),"^",21)
"RTN","PSIVOREN",42,0)
 .N NOEORD,VN,VNDT S NOEORD=$P(^PS(53.1,+ON,0),U,21) S VN=$P($G(^PS(53.1,+ON,4)),"^") I VN S VNDT=$P($G(^PS(53.1,+ON,4)),"^",2)
"RTN","PSIVOREN",43,0)
 .I NOEORD K DA,DR,DIE S DIE="^PS(55,"_DFN_",""IV"",",DA(1)=DFN,DA=+ON55,DR="110////"_+NOEORD D
"RTN","PSIVOREN",44,0)
 ..S DR=DR_";16////"_$S($G(VN):VN,1:"@")_";17////"_$S($G(VNDT):VNDT,1:"@")_";" D ^DIE I NOEORD[";" S $P(^PS(53.1,+ON,0),U,21)=NOEORD
"RTN","PSIVOREN",45,0)
 ..I $G(VN) D EN1^PSJHL2(DFN,"ZV",ON55)
"RTN","PSIVOREN",46,0)
 I ON["V" S DIE="^PS(55,DFN,""IV"",",DR="100////A;114////@;16////@;17////@" S DA=+ON55 D ^DIE
"RTN","PSIVOREN",47,0)
 N RDT S RDT=$P($G(@("^PS(53.1,"_+ON_",14,0)")),U,3) S:RDT RDT=+(^(RDT,0)) S RDT=$S(RDT:RDT,1:$$DATE^PSJUTL2) I RDT D UPDREN^PSIVOPT2(DFN,OLDON,RDT,+P(6),+$G(OSTOP),$G(NOO))
"RTN","PSIVOREN",48,0)
 ;
"RTN","PSIVOREN",49,0)
 I ON["V" D EN1^PSJHL2(DFN,"SN",ON,"NEW ORDER CREATED")
"RTN","PSIVOREN",50,0)
 I OLDON["V" S (ON,ON55)=OLDON,PSIVAL="",PSIVALCK="STOP",(P("FRES"),PSIVREA)="R" D LOG^PSIVORAL D
"RTN","PSIVOREN",51,0)
 .I $G(ON55),$G(OSTOP),$G(DFN) D STIX(OSTOP,OLDON,DFN)
"RTN","PSIVOREN",52,0)
 .;Add check to If statement below. If New Stop date ='s the old Stop Don't delete AIV x-ref (NSTOP'=PSJOSTOP)
"RTN","PSIVOREN",53,0)
 .I $G(PSJOSTOP),$G(NSTOP) I NSTOP=$P($G(^PS(55,DFN,"IV",+ON55,0)),"^",3),$D(^PS(55,"AIV",NSTOP,DFN,+ON55)),NSTOP'=PSJOSTOP K ^PS(55,"AIV",PSJOSTOP,DFN,+ON55)
"RTN","PSIVOREN",54,0)
 D:'$D(PSJIVORF) ORPARM Q:'PSJIVORF
"RTN","PSIVOREN",55,0)
 Q
"RTN","PSIVOREN",56,0)
 ;
"RTN","PSIVOREN",57,0)
RUPTXT(DFN,OLDON) ;
"RTN","PSIVOREN",58,0)
 ;Update ORTX( in OE/RR
"RTN","PSIVOREN",59,0)
 I OLDON'["V" ;; D ENUDTX^PSJOREN(DFN,OLDON,"OR") S ORIFN=$P($G(^PS(55,DFN,"IV",+OLDON,0)),U,21)
"RTN","PSIVOREN",60,0)
 I OLDON["V" S P("FRES")="R" D GTPC^PSIVORFB(OLDON),SORTX^PSIVORFE S ORIFN=$P($G(^PS(55,DFN,"IV",+OLDON,0)),U,21)
"RTN","PSIVOREN",61,0)
 ;; F X=0:0 S X=$O(ORTX(X)) Q:'X  S ORETURN("ORTX",X)=ORTX(X)
"RTN","PSIVOREN",62,0)
 Q
"RTN","PSIVOREN",63,0)
 ;
"RTN","PSIVOREN",64,0)
ORPARM ;Check if inpatient pkges are on.
"RTN","PSIVOREN",65,0)
 S (PSJORF,PSJIVORF)=1
"RTN","PSIVOREN",66,0)
 Q
"RTN","PSIVOREN",67,0)
 ;
"RTN","PSIVOREN",68,0)
NATURE ; Ask nature of order.
"RTN","PSIVOREN",69,0)
 I '+$G(PSJSYSU) S P("NAT")="W" Q
"RTN","PSIVOREN",70,0)
 K P("NAT") NEW X
"RTN","PSIVOREN",71,0)
 I $D(XQORNOD(0)) S X=$E($P(XQORNOD(0),U,3),1,1) S:X="" X="E"
"RTN","PSIVOREN",72,0)
 ;* S:'$D(X) X="N" S:X="A" X="E"
"RTN","PSIVOREN",73,0)
 S:'$D(X) X="N" S:"AF"[X X="E"
"RTN","PSIVOREN",74,0)
 I $G(PSIVCOPY) S X="N"
"RTN","PSIVOREN",75,0)
 S P("NAT")=$$ENNOO^PSJUTL5(X)
"RTN","PSIVOREN",76,0)
 K:P("NAT")=-1 P("NAT")
"RTN","PSIVOREN",77,0)
 Q
"RTN","PSIVOREN",78,0)
CLINIC ;Ask clinic where outpt is being seen for DSS
"RTN","PSIVOREN",79,0)
 K P("CLIN") NEW X1,X2,X,PSJDT,DIC,Y
"RTN","PSIVOREN",80,0)
 S X1=DT,X2=-7 D C^%DTC S PSJDT=X
"RTN","PSIVOREN",81,0)
 S DIC("S")="I $P($G(^SC(Y,0)),U,3)=""C"",$S('$P($G(^(""I"")),U):1,($P($G(^(""I"")),U)>PSJDT):1,(($P($G(^(""I"")),U)<PSJDT)&($P($G(^(""I"")),U,2)]"""")&(DT>$P($G(^(""I"")),U,2))):1,1:0)"
"RTN","PSIVOREN",82,0)
 S DIC=44,DIC(0)="QEAZ",DIC("A")="Select CLINIC LOCATION: " D ^DIC
"RTN","PSIVOREN",83,0)
 I $S($D(DTOUT):1,$D(DUOUT):1,1:0) Q
"RTN","PSIVOREN",84,0)
 S:+Y>0 P("CLIN")=+Y,$P(^PS(55,DFN,"IV",+ON55,"DSS"),"^")=+Y
"RTN","PSIVOREN",85,0)
 Q
"RTN","PSIVOREN",86,0)
 ;
"RTN","PSIVOREN",87,0)
STIX(OST,OON,DFN) ; Check start index, cleanup old start
"RTN","PSIVOREN",88,0)
 I $G(OST),$G(OON) S OS="" F  S OS=$O(^PS(55,DFN,"IV","AIS",OS)) Q:'OS  D
"RTN","PSIVOREN",89,0)
 . Q:'$D(^PS(55,DFN,"IV","AIS",OS,+OON))
"RTN","PSIVOREN",90,0)
 . I $P($G(^PS(55,DFN,"IV",+OON,0)),"^",3)'=OS K ^PS(55,DFN,"IV","AIS",OS,+OON)
"RTN","PSIVOREN",91,0)
 Q
"RTN","PSJOE")
0^1^B81086559
"RTN","PSJOE",1,0)
PSJOE ;BIR/MLM-INPATIENT ORDER ENTRY ;23 Jun 98 / 1:46 PM
"RTN","PSJOE",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**7,26,29,33,42,50,56,72,58,85,95,80,110,111,133,140**;16 DEC 97
"RTN","PSJOE",3,0)
 ;
"RTN","PSJOE",4,0)
 ; Reference to ^PS(55 is supported by DBIA #2191.
"RTN","PSJOE",5,0)
 ; Reference to EN^VALM is supported by DBIA #10118.
"RTN","PSJOE",6,0)
 ; Reference to FULL^VALM1 and PAUSE^VALM1 is supported by DBIA #10116.
"RTN","PSJOE",7,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSJOE",8,0)
 ; Reference to ^DPT is supported by DBIA #10035.
"RTN","PSJOE",9,0)
 ; Reference to ^ORCFLAG is supported by DBIA #3620.
"RTN","PSJOE",10,0)
 ; Reference to ^SDAMA203 is supported by DBIA #4133.
"RTN","PSJOE",11,0)
 ;
"RTN","PSJOE",12,0)
EN ; Start Inpatient LM OE
"RTN","PSJOE",13,0)
 N PSJLK,PSJNEWOE,PSJLMCON,PSJPROT,XQORS,VALMEVL D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",14,0)
 I $D(XQUIT) K XQUIT G DONE
"RTN","PSJOE",15,0)
 K PSGVBY,PSJPR S (PSJOL,PSJACOK,PSGOP,PSGNEF,PSGOEAV,PSGPXN)="" L +^PS(53.45,PSJSYSP):1 E  D LOCKERR^PSJOE G DONE^PSJOE
"RTN","PSJOE",16,0)
 F  S (PSJLMCON,PSGPTMP)=0 D ^PSJP,HK Q:PSGP'>0  S PSJPROT=3,DFN=PSGP D ^PSJAC D  I PSJLK D UL^PSSLOCK(PSGP)
"RTN","PSJOE",17,0)
 .K ^TMP("PSJ",$J)
"RTN","PSJOE",18,0)
 .S PSJLK=$$L^PSSLOCK(PSGP,1) I 'PSJLK W !,$C(7),$P(PSJLK,U,2) Q
"RTN","PSJOE",19,0)
 .K PSJLMPRO D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",20,0)
 .N NXTPT S NXTPT=0 F  Q:$G(NXTPT)  D
"RTN","PSJOE",21,0)
 ..K PSGRDTX
"RTN","PSJOE",22,0)
 ..I $G(PSJLMCON)!$G(PSJNEWOE) D
"RTN","PSJOE",23,0)
 ...S PSJOL=$S(",S,L,"[(","_$G(PSJOL)_","):PSJOL,1:"S")
"RTN","PSJOE",24,0)
 ...S PSJLMPRO=1,PSJLMCON=1,PSJNEWOE=0 D EN^VALM("PSJ LM OE")
"RTN","PSJOE",25,0)
 ..I $G(PSJNEWOE)!($G(VALMBCK)="Q") S PSJNEWOE=0 Q
"RTN","PSJOE",26,0)
 ..I $G(PSJLMCON)&$G(PSJLMPRO)&'$D(^TMP("PSJ",$J)) D  Q
"RTN","PSJOE",27,0)
 ...S PSJLMCON=0,PSJLMPRO=0 D EN^VALM("PSJ LM BRIEF PATIENT INFO")
"RTN","PSJOE",28,0)
 ...I $G(PSJNEWOE) S NXTPT=0 Q
"RTN","PSJOE",29,0)
 ...S NXTPT=1
"RTN","PSJOE",30,0)
 ..S NXTPT=1,PSJNEWOE=0
"RTN","PSJOE",31,0)
 .S PSJOL="S"
"RTN","PSJOE",32,0)
 .I $G(PSGPXN) I $P(PSJSYSW0,U,29)]""!($G(PSJCOM)) S PSGPXPT=PSGP D  K PSGPXPT S PSGPXN=0
"RTN","PSJOE",33,0)
 ..N DFN,PSGP,PSJPXDP
"RTN","PSJOE",34,0)
 ..I $P(PSJSYSW0,U,29)="" S PSJPDXP=1 D
"RTN","PSJOE",35,0)
 ...N IO,ION,IOS D HOME^%ZIS S $P(PSJSYSW0,U,29)=+$G(IOS)
"RTN","PSJOE",36,0)
 ..S (PSGP,DFN)=PSGPXPT D ^PSGPER S:$G(PSJPDXP) $P(PSJSYSW0,U,29)="" K PSJPDXP
"RTN","PSJOE",37,0)
 .D ENCV^PSGSETU,^PSIVXU
"RTN","PSJOE",38,0)
 K PSJLMPRO,^TMP("PSJPRO",$J),^TMP("PSJ",$J),^TMP("PSJON",$J)
"RTN","PSJOE",39,0)
 ;
"RTN","PSJOE",40,0)
DONE ;
"RTN","PSJOE",41,0)
 K AC,ACTION,D1,D2,MI,N,ON,P3,PNOW,PSIVAT,PSIVLN,PSIVSTR L -^PS(53.45,PSJSYSP)
"RTN","PSJOE",42,0)
 K DA,DRG,NE,PSGCF,PSGCANFL,PSGNEDFD,PSGNEF,PSGNEFD,PSGNEPR,PSGNESD,PSJACOK,PSJOE,PSJOECNT,PSJOEPF,PSJORD,PSGOEA,PSGOEAV,PSGOL,PSGOS,PSGON,PSGOP,PSGORD,PSGS0XT,PSGS0Y,RCT,ST,WD,XREF,Z,PSJIVORF,PSJIVPCL
"RTN","PSJOE",43,0)
 K PSGOEORF,PSIVREA,PSJOPC,PSJORL,PSJORPCL,PSJORTOI,RF,WSCHADM,PSJLM,PSJCT
"RTN","PSJOE",44,0)
 K DIU,DRGI,FLAG,FQC,ND2,PRI,PSGOE,PSGPRI,PSGSDN,PSGOEDMR,PSGOEPR,PSGPTS,PSGTOL,PSGTOO,PSGUOW,PSJIVOF,PSJOCNT,PSJON,PSJORQF,PSJORTOU,PSJORVP
"RTN","PSJOE",45,0)
 G:$G(PSGPXN) ^PSGPER1 D ENIVKV^PSGSETU
"RTN","PSJOE",46,0)
 Q
"RTN","PSJOE",47,0)
 ;
"RTN","PSJOE",48,0)
HK ; Housekeeping (a nice COBOL term)
"RTN","PSJOE",49,0)
 I PSGOP,PSGOP'=PSGP D
"RTN","PSJOE",50,0)
 .N PSJACPF,PSJACNWP,PSJPWD,PSJSYSL,PSJSYSW,PSJSYSW0,DFN,VAIN,VAERR S DFN=PSGOP
"RTN","PSJOE",51,0)
 .D INP^VADPT S PSJPWD=+VAIN(4) I PSJPWD S PSJACPF=10 D WP^PSJAC D:$P(PSJSYSL,"^",2)]"" ENQL^PSGLW
"RTN","PSJOE",52,0)
 Q:PSGP<0
"RTN","PSJOE",53,0)
 S (DFN,PSGOP)=PSGP,X=""
"RTN","PSJOE",54,0)
 Q
"RTN","PSJOE",55,0)
 ;
"RTN","PSJOE",56,0)
SELECT ; Select order from list
"RTN","PSJOE",57,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J)
"RTN","PSJOE",58,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0) D ENASR^PSGON
"RTN","PSJOE",59,0)
 I "^"[X S VALMQUIT=1 Q
"RTN","PSJOE",60,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL!($G(Y)<0)  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",61,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA Q:PSJORD=""!($G(Y)<0)  Q:PSJORD=+PSJORD  D
"RTN","PSJOE",62,0)
 ..Q:('$$LS^PSSLOCK(PSGP,PSJORD))
"RTN","PSJOE",63,0)
 ..Q:PSJORD=+PSJORD
"RTN","PSJOE",64,0)
 ..S PSGORD=""
"RTN","PSJOE",65,0)
 ..D DISACTIO(PSGP,PSJORD,"") S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",66,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD) Q:$G(Y)<0
"RTN","PSJOE",67,0)
 S VALMBCK="Q"
"RTN","PSJOE",68,0)
 K PSJLM
"RTN","PSJOE",69,0)
 Q
"RTN","PSJOE",70,0)
 ;
"RTN","PSJOE",71,0)
DISACTIO(DFN,PSJORD,PSJPNV)       ; Display UD order and allow actions.
"RTN","PSJOE",72,0)
 ; DFN    - Patient IEN
"RTN","PSJOE",73,0)
 ; PSJORD - Order #_location Code (P:53.1,V:55.01,U:55.06)
"RTN","PSJOE",74,0)
 ; PSJPNV - Invoked from Pending/NV option; (gets different hidden menu)
"RTN","PSJOE",75,0)
 N PSGP,PSJIVFLG,PSGSDX,PSGFDX,PSJXX1,ON55
"RTN","PSJOE",76,0)
 D OLDCOM^PSJOE0(DFN,PSJORD)
"RTN","PSJOE",77,0)
 S PSGP=DFN D ENIV^PSJAC I PSJORD["V" D EN^PSJLIORD(DFN,PSJORD) Q
"RTN","PSJOE",78,0)
 D GETUD^PSJLMGUD(DFN,PSJORD)
"RTN","PSJOE",79,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",80,0)
 S:$G(PSJTUD) PSGPD=$G(PSJCOI),PSGPDN=$$OINAME^PSJLMUTL(+PSGPD)
"RTN","PSJOE",81,0)
 K PSGOENG I '$D(PSGPRF) D  Q:$G(PSGOENG)
"RTN","PSJOE",82,0)
 . I PSJORD["U" L +^PS(55,PSGP,5,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",83,0)
 . I PSJORD["P" L +^PS(53.1,+PSJORD):1 E  S PSGOENG=1
"RTN","PSJOE",84,0)
 . I $G(PSGOENG) W !,"This order is being edited by another terminal.",! S PSGOENG=1 K DIR S DIR(0)="E" D ^DIR K DIR Q
"RTN","PSJOE",85,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD)
"RTN","PSJOE",86,0)
 I PSJORD["P" S PSJXX1=$G(^PS(53.1,+PSJORD,0)) I PSGP'=$P(PSJXX1,U,15)!(DFN'=$P(PSJXX1,U,15)) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",87,0)
 I PSJORD["P" D  S PSJXX1=$P($G(^PS(53.1,+PSJORD,0)),U,9) I $S($G(PSJIVFLG):1,$G(Y)<0:1,"PADE"[PSJXX1:1,1:0) L -^PS(53.1,+PSJORD) Q
"RTN","PSJOE",88,0)
 .I $P(PSJXX1,U,9)="N",($P(PSJXX1,U,4)'="U") D  Q
"RTN","PSJOE",89,0)
 .. S P("PON")=PSJORD,PSIVFLG=1
"RTN","PSJOE",90,0)
 .. N ON S ON=PSJORD D VF^PSIVORC2
"RTN","PSJOE",91,0)
 .I $P(PSJXX1,U,9)="P" D  Q
"RTN","PSJOE",92,0)
 ..S:$G(PSJTUD) $P(PSJXX1,U,4)="U"
"RTN","PSJOE",93,0)
 ..I $P(PSJXX1,U,4)="U" D  Q:$G(PSJIVFLG)
"RTN","PSJOE",94,0)
 ... N VAIP S CLINIC=$G(^PS(53.1,+PSJORD,"DSS")),APPT=$P(CLINIC,"^",2),CLINIC=$P(CLINIC,"^") I $$PATCH^XPDUTL("SD*5.3*285"),$$SDIMO^SDAMA203(CLINIC,DFN)>-1 Q
"RTN","PSJOE",95,0)
 ... Q:'PSJPDD  W !!,"Cannot process an Out-patient Unit Dose order for ",$P($G(^DPT(+PSGP,0)),U) D PAUSE^VALM1 S PSJIVFLG=1
"RTN","PSJOE",96,0)
 ..NEW PSGRSD,PSGRSDN,PSGRFD,PSGRFDN
"RTN","PSJOE",97,0)
 ..D REQDT^PSJLIVMD(PSJORD)
"RTN","PSJOE",98,0)
 ..I $P(PSJXX1,U,4)="U",($G(PSGSCH)="") W !!,"Invalid schedule, can't finish this order" D PAUSE^VALM1 Q
"RTN","PSJOE",99,0)
 ..I $P(PSJXX1,U,4)="U" N PSJLM S PSJLM=1,PSGORD=PSJORD D START^PSGOEF,ENSFE^PSGOEE0(PSGP,PSGORD),@$S($G(PSJTUD):"FINISH^PSGOEF",1:"EN^VALM(""PSJ LM PENDING EDIT"")") Q
"RTN","PSJOE",100,0)
 ..I $P(PSJXX1,U,4)'="U",PSGP=$P(PSJXX1,U,15),DFN=$P(PSJXX1,U,15) S PSJLYN=PSJORD D EN^PSJLIFN S PSJIVFLG=1 K PSJLYN,PSJMAI
"RTN","PSJOE",101,0)
 I $G(PSIVFLG) K PSIVFLG Q
"RTN","PSJOE",102,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSJORD),PSGOEEF=0 D GETUD^PSJLMGUD(PSGP,PSJORD),ENSFE^PSGOEE0(PSGP,PSJORD),EN^VALM("PSJ LM UD ACTION")
"RTN","PSJOE",103,0)
 I PSJORD["P" L -^PS(53.1,+PSJORD)
"RTN","PSJOE",104,0)
 I PSJORD["U" L -^PS(55,PSGP,5,+PSJORD)
"RTN","PSJOE",105,0)
 ;Send SN to CPRS if auto-verify OFF and Order Set Entry and no 21st piece
"RTN","PSJOE",106,0)
 S PSGOEAV=$P(PSJSYSP0,"^",9)&PSJSYSU
"RTN","PSJOE",107,0)
 I $D(PSGOES),'PSGOEAV,$D(PSGORD),PSGORD["P",$P($G(^PS(53.1,+PSGORD,0)),"^",21)']"" D ORSET^PSGOETO1
"RTN","PSJOE",108,0)
 D UNL^PSSLOCK(PSGP,PSJORD)
"RTN","PSJOE",109,0)
 Q
"RTN","PSJOE",110,0)
EDIT(PSGP,PSGORD,PROMPT) ;
"RTN","PSJOE",111,0)
 I "DE"[$$GTSTATUS(PSGP,PSGORD) W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",112,0)
 I PSGACT'["E" W !,"This order may not be edited." D PAUSE^VALM1 Q
"RTN","PSJOE",113,0)
 S PSGNEDFD="" D HOLDHDR,@$S('PROMPT:"ENEFA2^PSGON",1:"ENEFA^PSGON") I 'Y D ABORT^PSGOEE Q
"RTN","PSJOE",114,0)
 I PSGORD["P" D ENF^PSGOEE Q
"RTN","PSJOE",115,0)
 D ACT^PSGOEE
"RTN","PSJOE",116,0)
 Q
"RTN","PSJOE",117,0)
RENEW(PSGP,PSGORD) ;
"RTN","PSJOE",118,0)
 D HOLDHDR
"RTN","PSJOE",119,0)
 I 'PSJSYSU,$P($G(^PS(55,PSGP,5,+PSGORD,4)),U,15),$P($G(^(4)),U,16) W !!,"This order is already marked for renewal!" D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSJOE",120,0)
 I 'PSGRRF D ^PSGOER Q
"RTN","PSJOE",121,0)
 D ^PSGOERI
"RTN","PSJOE",122,0)
 Q
"RTN","PSJOE",123,0)
 ;
"RTN","PSJOE",124,0)
GTSTATUS(DFN,ON)   ;
"RTN","PSJOE",125,0)
 I ON["P" Q $P($G(^PS(53.1,+ON,0)),U,9)
"RTN","PSJOE",126,0)
 I ON["U" Q $P($G(^PS(55,DFN,5,+ON,0)),U,9)
"RTN","PSJOE",127,0)
 Q $P($G(^PS(55,DFN,"IV",+ON,0)),U,17)
"RTN","PSJOE",128,0)
 ;
"RTN","PSJOE",129,0)
DC(DFN,PSJORD) ; DC IV, UD, or pending orders.
"RTN","PSJOE",130,0)
 D HOLDHDR
"RTN","PSJOE",131,0)
 S X=$$GTSTATUS(DFN,PSJORD) I X="D"!(X="DE") W !,"This order has already been DISCONTINUED." D PAUSE^VALM1 Q
"RTN","PSJOE",132,0)
 D ENO^PSGOEC(DFN,PSJORD) ;,GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S VALMBCK="Q"
"RTN","PSJOE",133,0)
 S VALMBCK="Q"
"RTN","PSJOE",134,0)
 Q
"RTN","PSJOE",135,0)
HOLD(DFN,PSJORD) ; Change order's status from ACTIVE<->HOLD
"RTN","PSJOE",136,0)
 D HOLDHDR
"RTN","PSJOE",137,0)
 I PSJORD["V" D H^PSIVOPT(DFN,PSJORD,P(17),P(3))
"RTN","PSJOE",138,0)
 I PSJORD'["V" D H^PSGOE1(DFN,PSJORD)
"RTN","PSJOE",139,0)
 D GETUD^PSJLMGUD(DFN,PSJORD),INIT^PSJLMUDE(DFN,PSJORD) S PSGACT=$$ENACTION^PSGOE1(DFN,PSJORD),VALMBCK="R"
"RTN","PSJOE",140,0)
 Q
"RTN","PSJOE",141,0)
 ;
"RTN","PSJOE",142,0)
COPY(PSGP,PSGORD)  ; Copy an order (does not discontinue original order)
"RTN","PSJOE",143,0)
 I $D(PSGCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",144,0)
 I PSGORD["P" W !!,"You cannot copy this "_$S($G(PSGSTAT)]"":PSGSTAT,1:"PENDING IV")_" order." D PAUSE^VALM1 Q
"RTN","PSJOE",145,0)
 I PSGORD["V" D  Q
"RTN","PSJOE",146,0)
 .I $G(PSIVCOPY) W !!,"You cannot copy the order at this time" D PAUSE^VALM1 Q
"RTN","PSJOE",147,0)
 .D COPY^PSIVOD(PSGP,PSGORD) Q
"RTN","PSJOE",148,0)
 Q:'$$HIDDEN^PSJLMUTL("COPY")
"RTN","PSJOE",149,0)
 D ^PSJHVARS
"RTN","PSJOE",150,0)
 I $P($G(^PS(55,PSGP,5,+PSGORD,.2)),U,4)="D",'$P($G(^(4)),"^",3) W !!,"Nurse verified orders with a priority of DONE may not be Copied." D PAUSE^VALM1 Q
"RTN","PSJOE",151,0)
 S PSGOEAV=$P(PSJSYSP0,U,9)&PSJSYSU
"RTN","PSJOE",152,0)
 S PSGCOPY=1
"RTN","PSJOE",153,0)
 D FULL^VALM1,^PSGOD
"RTN","PSJOE",154,0)
 S VALMBCK="R"
"RTN","PSJOE",155,0)
 K PSGCOPY
"RTN","PSJOE",156,0)
 S PSGACT=$$ENACTION^PSGOE1(PSGP,PSGORD) ; resets PSGACT after copy
"RTN","PSJOE",157,0)
 I $G(PSGPXN) N PSGTMPXN S PSGTMPXN=PSGPXN
"RTN","PSJOE",158,0)
 D RESTORE^PSJHVARS I $G(PSGTMPXN) S PSGPXN=PSGTMPXN
"RTN","PSJOE",159,0)
 Q
"RTN","PSJOE",160,0)
 ;
"RTN","PSJOE",161,0)
UPDATE ; Refresh array, actions, & display.
"RTN","PSJOE",162,0)
 D GETUD^PSJLMGUD(DFN,ON),INIT^PSJLMUDE(DFN,ON) S VALMBCK="R"
"RTN","PSJOE",163,0)
 Q
"RTN","PSJOE",164,0)
FINISH ;
"RTN","PSJOE",165,0)
 D FINISH^PSGOEF,PAUSE^VALM1
"RTN","PSJOE",166,0)
 Q
"RTN","PSJOE",167,0)
 ;
"RTN","PSJOE",168,0)
LOG(DFN,PSGORD)        ;
"RTN","PSJOE",169,0)
 D FULL^VALM1,ENLM^PSGOEL(DFN,PSGORD),PAUSE^VALM1 S VALMBCK="R"
"RTN","PSJOE",170,0)
 Q
"RTN","PSJOE",171,0)
NEWSEL ;
"RTN","PSJOE",172,0)
 N PSGLMT,PSGODDD,PSJLMQT,PSJLMFIN,PSJUDPRF,PSGRDTX K ^TMP("PSJCOM",$J),^TMP("PSJCOM2",$J)
"RTN","PSJOE",173,0)
 S X=$P(XQORNOD(0),"=",2)
"RTN","PSJOE",174,0)
 S PSGONC=1,PSGLMT=^TMP("PSJPRO",$J,0)
"RTN","PSJOE",175,0)
 D ENCHK^PSGON I '$O(PSGODDD(0)) S VALMQUIT=1 Q
"RTN","PSJOE",176,0)
 S PSJLM=1,PSJSEL=0 F  S PSJSEL=$O(PSGODDD(PSJSEL)) Q:'PSJSEL  F PSJSEL1=1:1:$L(PSGODDD(PSJSEL),",")-1 D
"RTN","PSJOE",177,0)
 .S PSJORD=$G(^TMP("PSJON",$J,+$P(PSGODDD(PSJSEL),",",PSJSEL1))) D:PSJORD=+PSJORD SELECT^PSJOEA
"RTN","PSJOE",178,0)
 .Q:PSJORD=+PSJORD 
"RTN","PSJOE",179,0)
 .Q:PSJORD=""!($G(Y)<0)  Q:('$$LS^PSSLOCK(PSGP,PSJORD))  D
"RTN","PSJOE",180,0)
 ..S PSGORD=""
"RTN","PSJOE",181,0)
 ..S ON=PSJORD
"RTN","PSJOE",182,0)
 ..D DISACTIO(PSGP,PSJORD,$G(PSJPNV)) S:PSJORD["V" PSJORD=ON
"RTN","PSJOE",183,0)
 ..D UNL^PSSLOCK(PSGP,PSJORD) Q:$G(Y)<0
"RTN","PSJOE",184,0)
 S VALMBCK="Q"
"RTN","PSJOE",185,0)
 K PSJLM
"RTN","PSJOE",186,0)
 Q
"RTN","PSJOE",187,0)
HOLDHDR ; Freeze header text while processing order actions
"RTN","PSJOE",188,0)
 I $D(VALM("TM")) S IOTM=VALM("TM"),IOBM=IOSL W IOSC W @IOSTBM W IORC
"RTN","PSJOE",189,0)
 Q
"RTN","PSJOE",190,0)
LOCKERR ;
"RTN","PSJOE",191,0)
 W !!,$C(7),"You are entering or editing an Inpatient Medication order in another session.",!,"Only one order entry/edit session is allowed for a user at a time.",!! N DIR S DIR(0)="E" D ^DIR
"RTN","PSJOE",192,0)
 Q
"RTN","PSJOE",193,0)
FLAG(DFN,PSJORD) ;Flag order through CPRS entrypoint.
"RTN","PSJOE",194,0)
 N ORIFN,NODE0
"RTN","PSJOE",195,0)
 S NODE0=$S(PSJORD["V":$G(^PS(55,DFN,"IV",+PSJORD,0)),PSJORD["U":$G(^PS(55,DFN,5,+PSJORD,0)),1:^PS(53.1,+PSJORD,0))
"RTN","PSJOE",196,0)
 S ORIFN=$P(NODE0,"^",21)
"RTN","PSJOE",197,0)
 D EN1^ORCFLAG(ORIFN)
"RTN","PSJOE",198,0)
 D PAUSE^VALM1
"RTN","PSJOE",199,0)
 Q
"RTN","PSJOE",200,0)
 ;
"RTN","PSJOE",201,0)
COMPLEX(DFN,ON) ;
"RTN","PSJOE",202,0)
 N NDP2,COM
"RTN","PSJOE",203,0)
 S NDP2=$S(ON["P":$G(^PS(53.1,+ON,.2)),ON["U":$G(^PS(55,DFN,5,+ON,.2)),ON["V":$G(^PS(55,DFN,"IV",+ON,.2)),1:"")
"RTN","PSJOE",204,0)
 S COM=$P(NDP2,"^",8) I COM Q 1
"RTN","PSJOE",205,0)
 Q 0
"VER")
8.0^22.0
"BLD",5289,6)
^SEQ #131
**END**
**END**
