Released TIU*1*198 SEQ #188
Extracted from mail message
**KIDS**:TIU*1.0*198^

**INSTALL NAME**
TIU*1.0*198
"BLD",6307,0)
TIU*1.0*198^TEXT INTEGRATION UTILITIES^0^3050809^y
"BLD",6307,1,0)
^^7^7^3050809^
"BLD",6307,1,1,0)
CORRECT A PROBLEM WITH ACTIVE/RECENT MEDS OBJECT. UNDER CERTAIN 
"BLD",6307,1,2,0)
CONDITIONS IT WOULD SHOW A DISCONTINUED MED AND NOT THE ACTIVE MED FOR 
"BLD",6307,1,3,0)
THE SAME DRUG.
"BLD",6307,1,4,0)
 
"BLD",6307,1,5,0)
PROBLEM WITH TIU DOCUMENT PARAMETER EDIT.  SITES WERE CHANGING THE 
"BLD",6307,1,6,0)
DOCUMENT NAME DURING THE EDIT AND LOOSING ALL THE PARAMETERS FOR THE 
"BLD",6307,1,7,0)
DOCUMENT.  ADDED A WARNING MESSAGE IF DOCUMENT NAME IS CHANGED OR DELETED.
"BLD",6307,4,0)
^9.64PA^^
"BLD",6307,"ABPKG")
n
"BLD",6307,"KRN",0)
^9.67PA^8989.52^19
"BLD",6307,"KRN",.4,0)
.4
"BLD",6307,"KRN",.401,0)
.401
"BLD",6307,"KRN",.402,0)
.402
"BLD",6307,"KRN",.402,"NM",0)
^9.68A^1^1
"BLD",6307,"KRN",.402,"NM",1,0)
TIU DOCUMENT PARAMETER EDIT    FILE #8925.95^8925.95^0
"BLD",6307,"KRN",.402,"NM","B","TIU DOCUMENT PARAMETER EDIT    FILE #8925.95",1)

"BLD",6307,"KRN",.403,0)
.403
"BLD",6307,"KRN",.5,0)
.5
"BLD",6307,"KRN",.84,0)
.84
"BLD",6307,"KRN",3.6,0)
3.6
"BLD",6307,"KRN",3.8,0)
3.8
"BLD",6307,"KRN",9.2,0)
9.2
"BLD",6307,"KRN",9.8,0)
9.8
"BLD",6307,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",6307,"KRN",9.8,"NM",1,0)
TIUDPEDT^^0^B2778859
"BLD",6307,"KRN",9.8,"NM",2,0)
TIULMED^^0^B79707735
"BLD",6307,"KRN",9.8,"NM",3,0)
TIULMED3^^0^B354742
"BLD",6307,"KRN",9.8,"NM","B","TIUDPEDT",1)

"BLD",6307,"KRN",9.8,"NM","B","TIULMED",2)

"BLD",6307,"KRN",9.8,"NM","B","TIULMED3",3)

"BLD",6307,"KRN",19,0)
19
"BLD",6307,"KRN",19.1,0)
19.1
"BLD",6307,"KRN",101,0)
101
"BLD",6307,"KRN",409.61,0)
409.61
"BLD",6307,"KRN",771,0)
771
"BLD",6307,"KRN",870,0)
870
"BLD",6307,"KRN",8989.51,0)
8989.51
"BLD",6307,"KRN",8989.52,0)
8989.52
"BLD",6307,"KRN",8994,0)
8994
"BLD",6307,"KRN","B",.4,.4)

"BLD",6307,"KRN","B",.401,.401)

"BLD",6307,"KRN","B",.402,.402)

"BLD",6307,"KRN","B",.403,.403)

"BLD",6307,"KRN","B",.5,.5)

"BLD",6307,"KRN","B",.84,.84)

"BLD",6307,"KRN","B",3.6,3.6)

"BLD",6307,"KRN","B",3.8,3.8)

"BLD",6307,"KRN","B",9.2,9.2)

"BLD",6307,"KRN","B",9.8,9.8)

"BLD",6307,"KRN","B",19,19)

"BLD",6307,"KRN","B",19.1,19.1)

"BLD",6307,"KRN","B",101,101)

"BLD",6307,"KRN","B",409.61,409.61)

"BLD",6307,"KRN","B",771,771)

"BLD",6307,"KRN","B",870,870)

"BLD",6307,"KRN","B",8989.51,8989.51)

"BLD",6307,"KRN","B",8989.52,8989.52)

"BLD",6307,"KRN","B",8994,8994)

"BLD",6307,"QUES",0)
^9.62^^
"BLD",6307,"REQB",0)
^9.611^1^1
"BLD",6307,"REQB",1,0)
TIU*1.0*197^1
"BLD",6307,"REQB","B","TIU*1.0*197",1)

"KRN",.402,2132,-1)
0^1
"KRN",.402,2132,0)
TIU DOCUMENT PARAMETER EDIT^3050725.1303^@^8925.95^^@^3050801
"KRN",.402,2132,"DIAB",1,0,8925.95,2)
4;"FILING ALERT RECIPIENT"
"KRN",.402,2132,"DIAB",1,1,8925.954,0)
.01;"FILING ALERT RECIPIENT"
"KRN",.402,2132,"DR",1,8925.95)
.02;.03;.04;.06;.07;.08;.09;.1;@2;.11;I +X'>0 K DIE("NO^") S Y="@1";S DIE("NO^")="BACK";.12;K DIE("NO^");I +$P(^TIU(8925.95,+DA,0),U,12)>0 S Y="@1";W !,"You may not turn on IRT w/o specifying the Deficiency...";.11///@;S Y="@2";@1;
"KRN",.402,2132,"DR",1,8925.95,1)
.14;I +$P(^TIU(8925.95,+DA,0),U,14) S Y="@3";.15;.16;S Y="@4";@3;I +$P(^TIU(8925.95,+DA,0),U,14)'>0 S Y="@4";.15///@;.16///@;@4;.17;.18;.19;.2;3;W !!,"If document is to be uploaded, specify Filing Alert Recipients:",!;
"KRN",.402,2132,"DR",1,8925.95,2)
4FILING ALERT RECIPIENT~;W !!,"Now enter the USER CLASSES for which cosignature will be required:",!;5;W !!,"Now enter the DIVISIONAL parameters:",!;2;
"KRN",.402,2132,"DR",2,8925.952)
.02;.03;
"KRN",.402,2132,"DR",2,8925.954)
.01FILING ALERT RECIPIENT~;
"KRN",.402,2132,"DR",2,8925.955)
.01;
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"PKG",470,-1)
1^1
"PKG",470,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",470,20,0)
^9.402P^^
"PKG",470,22,0)
^9.49I^1^1
"PKG",470,22,1,0)
1.0^3010801^3010806^66481
"PKG",470,22,1,"PAH",1,0)
198^3050809^101036
"PKG",470,22,1,"PAH",1,1,0)
^^7^7^3050809
"PKG",470,22,1,"PAH",1,1,1,0)
CORRECT A PROBLEM WITH ACTIVE/RECENT MEDS OBJECT. UNDER CERTAIN 
"PKG",470,22,1,"PAH",1,1,2,0)
CONDITIONS IT WOULD SHOW A DISCONTINUED MED AND NOT THE ACTIVE MED FOR 
"PKG",470,22,1,"PAH",1,1,3,0)
THE SAME DRUG.
"PKG",470,22,1,"PAH",1,1,4,0)
 
"PKG",470,22,1,"PAH",1,1,5,0)
PROBLEM WITH TIU DOCUMENT PARAMETER EDIT.  SITES WERE CHANGING THE 
"PKG",470,22,1,"PAH",1,1,6,0)
DOCUMENT NAME DURING THE EDIT AND LOOSING ALL THE PARAMETERS FOR THE 
"PKG",470,22,1,"PAH",1,1,7,0)
DOCUMENT.  ADDED A WARNING MESSAGE IF DOCUMENT NAME IS CHANGED OR DELETED.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","TIUDPEDT")
0^1^B2778859
"RTN","TIUDPEDT",1,0)
TIUDPEDT ; SLC/JER - Document Parameter Edit ;2/19/93  16:15
"RTN","TIUDPEDT",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**198**;Jun 20, 1997
"RTN","TIUDPEDT",3,0)
MAIN ; Controls branching
"RTN","TIUDPEDT",4,0)
 N DIC,DA,DIE,DR,DLAYGO,X,Y,DWPK,TIUFPRIV S TIUFPRIV=1
"RTN","TIUDPEDT",5,0)
 W !,"First edit Institution-wide parameters:",!
"RTN","TIUDPEDT",6,0)
 ;VMP OIFO BAY PINES;ELR;TIU*1.0*198 MODIFIED FROM HERE DOWN
"RTN","TIUDPEDT",7,0)
 S (DIC,DLAYGO)=8925.95,DIC(0)="AEMQLZ",DIC("A")="Select DOCUMENT DEFINITION: "
"RTN","TIUDPEDT",8,0)
 D ^DIC K DLAYGO Q:+Y'>0  S DA=+Y
"RTN","TIUDPEDT",9,0)
 N TIUPRMPT S TIUPRMPT=Y(0,0)
"RTN","TIUDPEDT",10,0)
 K X,Y,DIC
"RTN","TIUDPEDT",11,0)
 ;VMP OIFO BAY PINES;ELR;TIU*1.0*198;REMOVED .01 FROM INPUT TEMPLATE AND ADDED WARNING MSG.
"RTN","TIUDPEDT",12,0)
 N TIURESP,TIURESP1 S TIURESP=$$READ^TIUU("8925.95,.01:O",,TIUPRMPT)
"RTN","TIUDPEDT",13,0)
 I $G(TIURESP)="@" S TIURESP=TIURESP_U_TIURESP K DIRUT G CONT
"RTN","TIUDPEDT",14,0)
 I (($D(DIRUT))!(+TIURESP<0)) K DIRUT Q
"RTN","TIUDPEDT",15,0)
CONT ;
"RTN","TIUDPEDT",16,0)
 I $P(TIURESP,U,2)'=TIUPRMPT D  Q:'+$G(TIURESP1)
"RTN","TIUDPEDT",17,0)
 . S TIURESP1=$$READ^TIUU("Y","You are about to loose the document parameters for "_TIUPRMPT_" Do you wish to continue","NO")
"RTN","TIUDPEDT",18,0)
 S DIE="^TIU(8925.95,",DR=".01///"_$P(TIURESP,U,2)
"RTN","TIUDPEDT",19,0)
 L +^TIU(8925.95,DA):0 I '$T W !,"Another user is editing this entry" H 1 Q
"RTN","TIUDPEDT",20,0)
 D ^DIE
"RTN","TIUDPEDT",21,0)
 I $G(TIURESP)="@" G END
"RTN","TIUDPEDT",22,0)
 S DIE=8925.95,DR="[TIU DOCUMENT PARAMETER EDIT]"
"RTN","TIUDPEDT",23,0)
 D ^DIE
"RTN","TIUDPEDT",24,0)
END L -^TIU(8925.95,DA)
"RTN","TIUDPEDT",25,0)
 Q
"RTN","TIULMED")
0^2^B79707735
"RTN","TIULMED",1,0)
TIULMED ; SLC/JM,JH - Active/Recent Med Objects Routine ;3/17/2004 [6/28/05 9:12am]
"RTN","TIULMED",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**38,73,92,94,183,193,197,198**;Jun 20, 1997
"RTN","TIULMED",3,0)
 Q
"RTN","TIULMED",4,0)
LIST(DFN,TARGET,ACTVONLY,DETAILED,ALLMEDS,ONELIST,CLASSORT,SUPPLIES) ;
"RTN","TIULMED",5,0)
 ; This is the TIU Medication objects API.  Optional parameters not
"RTN","TIULMED",6,0)
 ; provided defaults to 0 (with the exception of SUPPLIES).
"RTN","TIULMED",7,0)
 ;Required Parameters:
"RTN","TIULMED",8,0)
 ;  DFN       Patient identifier
"RTN","TIULMED",9,0)
 ;  TARGET    Where the medication data will be stored
"RTN","TIULMED",10,0)
 ;Optional Parameters:
"RTN","TIULMED",11,0)
 ;  ACTVONLY  0 - Active and recently expired meds
"RTN","TIULMED",12,0)
 ;            1 - Active meds only
"RTN","TIULMED",13,0)
 ;            2 - Recently expired meds only
"RTN","TIULMED",14,0)
 ;  DETAILED  0 - One line per med only
"RTN","TIULMED",15,0)
 ;            1 - Detailed information on each med
"RTN","TIULMED",16,0)
 ;  ALLMEDS   0 - Specifies Inpatient Meds if patient is an
"RTN","TIULMED",17,0)
 ;                Inpatient, or Outpatient Meds if patient
"RTN","TIULMED",18,0)
 ;                is an Outpatient
"RTN","TIULMED",19,0)
 ;            1 - Specifies both Inpatient and Outpatient
"RTN","TIULMED",20,0)
 ;            2 or "I" - Specifies Inpatient only
"RTN","TIULMED",21,0)
 ;            3 or "O" - Specifies Outpatient only
"RTN","TIULMED",22,0)
 ;  ONELIST   0 - Separates Active, Pending and Inactive
"RTN","TIULMED",23,0)
 ;                medications into separate lists
"RTN","TIULMED",24,0)
 ;            1 - Combines Active, Pending and Inactive
"RTN","TIULMED",25,0)
 ;                medications into the same list
"RTN","TIULMED",26,0)
 ;  CLASSORT  0 - Sort meds alphabetically
"RTN","TIULMED",27,0)
 ;            1 - Sort meds by drug class, and within the
"RTN","TIULMED",28,0)
 ;                same drug class, sort alphabetically
"RTN","TIULMED",29,0)
 ;            2 - Same as #1, but show drug class in header
"RTN","TIULMED",30,0)
 ;  SUPPLIES  0 - Supplies are excluded
"RTN","TIULMED",31,0)
 ;            1 - Supplies are included (Default)
"RTN","TIULMED",32,0)
 N NEXTLINE,EMPTY,INDEX,NODE,ISINP,KEEPMED,STATUS,ASTATS,PSTATS,OK
"RTN","TIULMED",33,0)
 N STATIDX,INPTYPE,OUTPTYPE,TYPE,MEDTYPE,CNT,DATA,MED,IDATE,XSTR,LLEN
"RTN","TIULMED",34,0)
 N LASTMEDT,LASTSTS,COUNT,TOTAL,SPACE60,DASH73,TEMP,LINE,TAB,HEADER
"RTN","TIULMED",35,0)
 N DRUGCLAS,DRUGIDX,LASTCLAS,OLDTAB,OLDHEADR,UNKNOWNS
"RTN","TIULMED",36,0)
 N NVATYPE,NVAMED,NVASTR,TIUXSTAT
"RTN","TIULMED",37,0)
 N %,%H,STOP,LSTFD ;Clean up after external calls...
"RTN","TIULMED",38,0)
 S (NEXTLINE,TAB,HEADER,UNKNOWNS)=0,LLEN=47
"RTN","TIULMED",39,0)
 K @TARGET,^TMP("PS",$J)
"RTN","TIULMED",40,0)
 ; Check for Pharmacy Package and required patches
"RTN","TIULMED",41,0)
 I '$L($T(OCL^PSOORRL)) D  G LISTX
"RTN","TIULMED",42,0)
 .D ADD^TIULMED1("Outpatient Pharmacy 7.0 Required for this Object.")
"RTN","TIULMED",43,0)
 .D ADD^TIULMED1(" ")
"RTN","TIULMED",44,0)
 I '$$PATCH^XPDUTL("PSO*7.0*20") D  G LISTX
"RTN","TIULMED",45,0)
 .D ADD^TIULMED1("Outpatient Pharmacy Patch PSO*7.0*20 is required for this Object.")
"RTN","TIULMED",46,0)
 .D ADD^TIULMED1(" ")
"RTN","TIULMED",47,0)
 I '$$PATCH^XPDUTL("PSJ*5.0*22") D  G LISTX
"RTN","TIULMED",48,0)
 .D ADD^TIULMED1("Inpatient Pharmacy Patch PSJ*5.0*22 is required for this Object.")
"RTN","TIULMED",49,0)
 .D ADD^TIULMED1(" ")
"RTN","TIULMED",50,0)
 I '+$G(ACTVONLY) S ACTVONLY=0
"RTN","TIULMED",51,0)
 I '+$G(DETAILED) S DETAILED=0
"RTN","TIULMED",52,0)
 I +$D(ALLMEDS) D
"RTN","TIULMED",53,0)
 .I ALLMEDS="I" S ALLMEDS=2
"RTN","TIULMED",54,0)
 .E  I ALLMEDS="O" S ALLMEDS=3
"RTN","TIULMED",55,0)
 I '+$G(ALLMEDS) S ALLMEDS=0
"RTN","TIULMED",56,0)
 I '+$G(ONELIST) S ONELIST=0
"RTN","TIULMED",57,0)
 I '+$G(CLASSORT) S CLASSORT=0
"RTN","TIULMED",58,0)
 I $G(SUPPLIES)'="0" S SUPPLIES=1
"RTN","TIULMED",59,0)
 S (EMPTY,HEADER)=1
"RTN","TIULMED",60,0)
 I ONELIST,'ALLMEDS,'DETAILED,'CLASSORT S HEADER=0
"RTN","TIULMED",61,0)
 I 'DETAILED S LLEN=60
"RTN","TIULMED",62,0)
 S ASTATS="^ACTIVE^REFILL^HOLD^PROVIDER HOLD^ON CALL^ACTIVE (S)^"
"RTN","TIULMED",63,0)
 S PSTATS="^NON-VERIFIED^DRUG INTERACTIONS^INCOMPLETE^PENDING^"
"RTN","TIULMED",64,0)
 S ISINP=($G(^DPT(DFN,.1))'="") ; Is this an inpatient?
"RTN","TIULMED",65,0)
 I ISINP S INPTYPE=1,OUTPTYPE=2
"RTN","TIULMED",66,0)
 E  S INPTYPE=2,OUTPTYPE=1
"RTN","TIULMED",67,0)
 S NVATYPE=3
"RTN","TIULMED",68,0)
 D ADDTITLE^TIULMED1
"RTN","TIULMED",69,0)
 ;
"RTN","TIULMED",70,0)
 ; *** Scan medication data and skip unwanted meds ***
"RTN","TIULMED",71,0)
 ;
"RTN","TIULMED",72,0)
 D OCL^PSOORRL(DFN,"","")
"RTN","TIULMED",73,0)
 S INDEX=0
"RTN","TIULMED",74,0)
 F  S INDEX=$O(^TMP("PS",$J,INDEX))  Q:INDEX'>0  D
"RTN","TIULMED",75,0)
 .S NODE=$G(^TMP("PS",$J,INDEX,0))
"RTN","TIULMED",76,0)
 .S KEEPMED=($L($P(NODE,U,2))>0) ;Discard Blank Meds
"RTN","TIULMED",77,0)
 .I KEEPMED D
"RTN","TIULMED",78,0)
 ..S STATUS=$P(NODE,U,9)
"RTN","TIULMED",79,0)
 ..I STATUS="SUSPENDED" S STATUS="ACTIVE (S)"
"RTN","TIULMED",80,0)
 ..I $F(ASTATS,"^"_STATUS_"^")>0 S STATIDX=1
"RTN","TIULMED",81,0)
 ..E  I ($F(PSTATS,"^"_STATUS_"^")>0) S STATIDX=2
"RTN","TIULMED",82,0)
 ..E  S STATIDX=3
"RTN","TIULMED",83,0)
 ..S TIUXSTAT=STATUS
"RTN","TIULMED",84,0)
 ..I ACTVONLY=1 S KEEPMED=(STATIDX<3)
"RTN","TIULMED",85,0)
 ..I ACTVONLY=2 S KEEPMED=(STATIDX=3)
"RTN","TIULMED",86,0)
 ..I +ONELIST S STATIDX=1
"RTN","TIULMED",87,0)
 .I KEEPMED D
"RTN","TIULMED",88,0)
 ..S TYPE=$P($P(NODE,U),";",2)
"RTN","TIULMED",89,0)
 ..S TYPE=$S(TYPE="O":"OP",TYPE="I":"UD",1:"")
"RTN","TIULMED",90,0)
 ..S NVAMED=$P($P(NODE,U),";")
"RTN","TIULMED",91,0)
 ..S NVAMED=$E(NVAMED,$L(NVAMED))
"RTN","TIULMED",92,0)
 ..S KEEPMED=(TYPE'="")
"RTN","TIULMED",93,0)
 .I KEEPMED D
"RTN","TIULMED",94,0)
 ..I $O(^TMP("PS",$J,INDEX,"A",0))>0 S TYPE="IV"
"RTN","TIULMED",95,0)
 ..E  I $O(^TMP("PS",$J,INDEX,"B",0))>0 S TYPE="IV"
"RTN","TIULMED",96,0)
 ..I TYPE="OP" S MEDTYPE=OUTPTYPE
"RTN","TIULMED",97,0)
 ..E  S MEDTYPE=INPTYPE
"RTN","TIULMED",98,0)
 ..I NVAMED="N" S MEDTYPE=NVATYPE
"RTN","TIULMED",99,0)
 ..I ALLMEDS=0 D  I 1
"RTN","TIULMED",100,0)
 ...I MEDTYPE=INPTYPE S KEEPMED=ISINP
"RTN","TIULMED",101,0)
 ...E  S KEEPMED='ISINP
"RTN","TIULMED",102,0)
 ..E  I ALLMEDS=2 S KEEPMED=(MEDTYPE=INPTYPE)
"RTN","TIULMED",103,0)
 ..E  I ALLMEDS=3 S KEEPMED=(MEDTYPE=OUTPTYPE!(MEDTYPE=NVATYPE))
"RTN","TIULMED",104,0)
 .S DRUGCLAS=" "
"RTN","TIULMED",105,0)
 .S MED=$P(NODE,U,2)
"RTN","TIULMED",106,0)
 .I KEEPMED,(CLASSORT!('SUPPLIES)) D
"RTN","TIULMED",107,0)
 ..S DRUGIDX=$$IENNAME^TIULMED2(MED)
"RTN","TIULMED",108,0)
 ..D GETCLASS
"RTN","TIULMED",109,0)
 ..I KEEPMED,+DRUGIDX=0 D  ;Find orderable item
"RTN","TIULMED",110,0)
 ...N IDX,ID,ORDIDX,TMPCLASS,CDONE,SDONE,TMPIDX,TMPNODE,ISSUPPLY
"RTN","TIULMED",111,0)
 ...S ID=$P(NODE,U),IDX=+ID,ID=$E(ID,$L(IDX)+1,$L(ID))
"RTN","TIULMED",112,0)
 ...S (DRUGIDX,ORDIDX)=0
"RTN","TIULMED",113,0)
 ...I ID="R;O" D
"RTN","TIULMED",114,0)
 ....S DRUGIDX=+$P($G(^PSRX(IDX,0)),U,6)
"RTN","TIULMED",115,0)
 ....S ORDIDX=+$P($G(^PSRX(IDX,"OR1")),U)
"RTN","TIULMED",116,0)
 ...I ID="P;O" D
"RTN","TIULMED",117,0)
 ....S DRUGIDX=+$P($G(^PS(52.41,IDX,0)),U,9)
"RTN","TIULMED",118,0)
 ....S ORDIDX=+$P($G(^PS(52.41,IDX,0)),U,8)
"RTN","TIULMED",119,0)
 ...I ID="P;I" D
"RTN","TIULMED",120,0)
 ....I $P($G(^PS(53.1,IDX,1,0)),U,4)=1 D
"RTN","TIULMED",121,0)
 .....S TMPIDX=$O(^PS(53.1,IDX,1,0)) I +TMPIDX D
"RTN","TIULMED",122,0)
 ......S DRUGIDX=$P($G(^PS(53.1,IDX,1,TMPIDX,0)),U)
"RTN","TIULMED",123,0)
 ....S ORDIDX=+$P($G(^PS(53.1,IDX,.2)),U)
"RTN","TIULMED",124,0)
 ...I ID="U;I" D
"RTN","TIULMED",125,0)
 ....I $P($G(^PS(55,DFN,5,IDX,1,0)),U,4)=1 D
"RTN","TIULMED",126,0)
 .....S TMPIDX=$O(^PS(55,DFN,5,IDX,1,0)) I +TMPIDX D
"RTN","TIULMED",127,0)
 ......S DRUGIDX=$P($G(^PS(55,DFN,5,IDX,1,TMPIDX,0)),U)
"RTN","TIULMED",128,0)
 ....S ORDIDX=+$P($G(^PS(55,DFN,5,IDX,.2)),U)
"RTN","TIULMED",129,0)
 ...I ID="V;I" D
"RTN","TIULMED",130,0)
 ....I $P($G(^PS(55,DFN,"IV",IDX,"AD",0)),U,4)=1 D
"RTN","TIULMED",131,0)
 .....S TMPIDX=$O(^PS(55,DFN,"IV",IDX,"AD",0)) I +TMPIDX D
"RTN","TIULMED",132,0)
 ......S TMPIDX=$P($G(^PS(55,DFN,"IV",IDX,"AD",TMPIDX,0)),U)
"RTN","TIULMED",133,0)
 ......I +TMPIDX S DRUGIDX=$$DRGIEN^TIULMED2(TMPIDX)
"RTN","TIULMED",134,0)
 ....S ORDIDX=+$P($G(^PS(55,DFN,"IV",IDX,.2)),U)
"RTN","TIULMED",135,0)
 ...S DRUGCLAS=""
"RTN","TIULMED",136,0)
 ...D GETCLASS
"RTN","TIULMED",137,0)
 ...I KEEPMED,+DRUGIDX=0,+ORDIDX,DRUGCLAS="" D
"RTN","TIULMED",138,0)
 ....S IDX=0,ISSUPPLY=2,CDONE='CLASSORT,SDONE=+SUPPLIES
"RTN","TIULMED",139,0)
 ....N LIST S LIST="TIULMED"
"RTN","TIULMED",140,0)
 ....D DRGIEN^PSS50P7(ORDIDX,"",LIST)
"RTN","TIULMED",141,0)
 ....F  S IDX=$O(^TMP($J,LIST,IDX)) Q:'IDX  D  Q:(CDONE&SDONE)
"RTN","TIULMED",142,0)
 .....S TMPCLASS=$$DRGCLASS^TIULMED2(IDX)
"RTN","TIULMED",143,0)
 .....S TMPNODE=U_TMPCLASS_U_$$DEA^TIULMED2(IDX)
"RTN","TIULMED",144,0)
 .....I 'CDONE,TMPCLASS="" S CDONE=1,DRUGCLAS=""
"RTN","TIULMED",145,0)
 .....I 'CDONE D
"RTN","TIULMED",146,0)
 ......I DRUGCLAS="" S DRUGCLAS=TMPCLASS
"RTN","TIULMED",147,0)
 ......E  I DRUGCLAS'=TMPCLASS S CDONE=1,DRUGCLAS=""
"RTN","TIULMED",148,0)
 .....I 'SDONE D
"RTN","TIULMED",149,0)
 ......S ISSUPPLY=(($E(TMPCLASS,1,2)="XA")&($P(TMPNODE,U,3)["S"))
"RTN","TIULMED",150,0)
 ......I 'ISSUPPLY S SDONE=1
"RTN","TIULMED",151,0)
 ....I 'SUPPLIES,(ISSUPPLY=1) S KEEPMED=0
"RTN","TIULMED",152,0)
 ..I (DRUGCLAS="")!('CLASSORT) S DRUGCLAS=" "
"RTN","TIULMED",153,0)
 .;
"RTN","TIULMED",154,0)
 .; *** Save wanted meds in "B" temp xref, removing duplicates ***
"RTN","TIULMED",155,0)
 .;
"RTN","TIULMED",156,0)
 .I KEEPMED D
"RTN","TIULMED",157,0)
 ..D ADDMED^TIULMED1(1) ; Get XSTR to check for duplicates
"RTN","TIULMED",158,0)
 ..;VMP OIFO BAY PINES;ELR;TIU*1.0*198;ADDED TIUXSTAT TO TMP GLOBAL
"RTN","TIULMED",159,0)
 ..S IDATE=$P(NODE,U,15)
"RTN","TIULMED",160,0)
 ..S OK='$D(@TARGET@("B",MED,XSTR,TIUXSTAT))
"RTN","TIULMED",161,0)
 ..I 'OK,(IDATE>@TARGET@("B",MED,XSTR,TIUXSTAT)) S OK=1
"RTN","TIULMED",162,0)
 ..I OK D
"RTN","TIULMED",163,0)
 ...S @TARGET@("B",MED,XSTR,TIUXSTAT)=IDATE_U_INDEX_U_MEDTYPE_STATIDX_U_TYPE_U_DRUGCLAS
"RTN","TIULMED",164,0)
 ...S EMPTY=0
"RTN","TIULMED",165,0)
 ...I DRUGCLAS=" " S UNKNOWNS=1
"RTN","TIULMED",166,0)
 ;
"RTN","TIULMED",167,0)
 ; *** Check for empty condition ***
"RTN","TIULMED",168,0)
 ;
"RTN","TIULMED",169,0)
 I EMPTY D  G LISTX
"RTN","TIULMED",170,0)
 .D ADD^TIULMED1("No Medications Found")
"RTN","TIULMED",171,0)
 .D ADD^TIULMED1(" ")
"RTN","TIULMED",172,0)
 ;
"RTN","TIULMED",173,0)
 ; *** Sort Meds in "C" temp xref - sort by Med Type, Status
"RTN","TIULMED",174,0)
 ;     Med Name, and reverse issue date, followed by a counter 
"RTN","TIULMED",175,0)
 ;     to avoid erasing meds issued on the same day
"RTN","TIULMED",176,0)
 ;
"RTN","TIULMED",177,0)
 S MED="",CNT=1000000
"RTN","TIULMED",178,0)
 F  S MED=$O(@TARGET@("B",MED)) Q:MED=""  D
"RTN","TIULMED",179,0)
 .S (XSTR,TIUXSTAT)=""
"RTN","TIULMED",180,0)
 .F  S XSTR=$O(@TARGET@("B",MED,XSTR)) Q:XSTR=""  D
"RTN","TIULMED",181,0)
 .. F  S TIUXSTAT=$O(@TARGET@("B",MED,XSTR,TIUXSTAT)) Q:TIUXSTAT=""  D
"RTN","TIULMED",182,0)
 ...S NODE=@TARGET@("B",MED,XSTR,TIUXSTAT)
"RTN","TIULMED",183,0)
 ...S DATA=$P(NODE,U,3)_U_$P(NODE,U,5)_U_MED,CNT=CNT+1
"RTN","TIULMED",184,0)
 ...S @TARGET@("C",DATA,(9999999-$P(NODE,U))_CNT)=$P(NODE,U,2)_U_$P(NODE,U,4)
"RTN","TIULMED",185,0)
 K @TARGET@("B")
"RTN","TIULMED",186,0)
 ;
"RTN","TIULMED",187,0)
 ; Read sorted data and save final version to TARGET
"RTN","TIULMED",188,0)
 ;
"RTN","TIULMED",189,0)
 S (DATA,LASTCLAS)="",(LASTMEDT,LASTSTS,COUNT,TOTAL)=0
"RTN","TIULMED",190,0)
 S $P(SPACE60," ",60)=" ",$P(DASH73,"=",73)="="
"RTN","TIULMED",191,0)
 D WARNING^TIULMED1
"RTN","TIULMED",192,0)
 F  S DATA=$O(@TARGET@("C",DATA)) Q:DATA=""  D
"RTN","TIULMED",193,0)
 .S MEDTYPE=$E(DATA),STATIDX=$E(DATA,2)
"RTN","TIULMED",194,0)
 .S DRUGCLAS=$P(DATA,U,2),MED=$P(DATA,U,3),CNT=""
"RTN","TIULMED",195,0)
 .F  S CNT=$O(@TARGET@("C",DATA,CNT)) Q:CNT=""  D
"RTN","TIULMED",196,0)
 ..S INDEX=@TARGET@("C",DATA,CNT)
"RTN","TIULMED",197,0)
 ..S TYPE=$P(INDEX,U,2),INDEX=+INDEX
"RTN","TIULMED",198,0)
 ..S NODE=^TMP("PS",$J,INDEX,0)
"RTN","TIULMED",199,0)
 ..I $P($P(NODE,U),";")["N" S $P(NODE,U,2)="Non-VA "_$P(NODE,U,2)
"RTN","TIULMED",200,0)
 ..I (MEDTYPE'=LASTMEDT)!(STATIDX'=LASTSTS) D  ; Create Header
"RTN","TIULMED",201,0)
 ...I CLASSORT'=2,DRUGCLAS'=" " S LASTCLAS=DRUGCLAS
"RTN","TIULMED",202,0)
 ...I 'HEADER Q
"RTN","TIULMED",203,0)
 ...S LASTMEDT=MEDTYPE,LASTSTS=STATIDX,TAB=0
"RTN","TIULMED",204,0)
 ...I COUNT>0 D ADD^TIULMED1(" ")
"RTN","TIULMED",205,0)
 ...I CLASSORT D ADD^TIULMED1(" ")
"RTN","TIULMED",206,0)
 ...S COUNT=0
"RTN","TIULMED",207,0)
 ...I DETAILED D
"RTN","TIULMED",208,0)
 ....I MEDTYPE=OUTPTYPE D  I 1
"RTN","TIULMED",209,0)
 .....D ADD^TIULMED1(SPACE60_"Issue Date")
"RTN","TIULMED",210,0)
 .....D ADD^TIULMED1($E($E(SPACE60,1,47)_"Status"_SPACE60,1,60)_"Last Fill")
"RTN","TIULMED",211,0)
 ....E  D ADD^TIULMED1(SPACE60_"Start Date")
"RTN","TIULMED",212,0)
 ...I 'ONELIST D
"RTN","TIULMED",213,0)
 ....S TEMP=$S(STATIDX=1:"Active",STATIDX=2:"Pending",1:"Inactive")_" "
"RTN","TIULMED",214,0)
 ...E  S TEMP=""
"RTN","TIULMED",215,0)
 ...S TEMP=TEMP_$S(MEDTYPE=INPTYPE:"Inpatient",MEDTYPE=NVATYPE:"Non-VA",1:"Outpatient")
"RTN","TIULMED",216,0)
 ...S TEMP="     "_TEMP_" Medications"
"RTN","TIULMED",217,0)
 ...I CLASSORT D
"RTN","TIULMED",218,0)
 ....I DETAILED S TEMP=TEMP_" (By Class)"
"RTN","TIULMED",219,0)
 ....E  S TEMP=TEMP_" (By Drug Class)"
"RTN","TIULMED",220,0)
 ...I DETAILED D  I 1
"RTN","TIULMED",221,0)
 ....S TEMP=$E(TEMP_SPACE60,1,47)
"RTN","TIULMED",222,0)
 ....I MEDTYPE=INPTYPE S TEMP=TEMP_"Status"
"RTN","TIULMED",223,0)
 ....E  S TEMP=TEMP_"Refills"
"RTN","TIULMED",224,0)
 ....S TEMP=$E(TEMP_SPACE60,1,60)
"RTN","TIULMED",225,0)
 ....I MEDTYPE=INPTYPE S TEMP=TEMP_"Stop Date"
"RTN","TIULMED",226,0)
 ....E  S TEMP=TEMP_"Expiration"
"RTN","TIULMED",227,0)
 ...E  D
"RTN","TIULMED",228,0)
 ....S TEMP=$E(TEMP_SPACE60,1,60)_"Status"
"RTN","TIULMED",229,0)
 ...D ADD^TIULMED1(TEMP),ADD^TIULMED1(DASH73)
"RTN","TIULMED",230,0)
 ..I CLASSORT,DRUGCLAS'="",DRUGCLAS'=LASTCLAS D
"RTN","TIULMED",231,0)
 ...S LASTCLAS=DRUGCLAS,OLDTAB=TAB,OLDHEADR=HEADER
"RTN","TIULMED",232,0)
 ...S (TAB,HEADER)=0
"RTN","TIULMED",233,0)
 ...I COUNT>0 D ADD^TIULMED1(" ")
"RTN","TIULMED",234,0)
 ...I (CLASSORT=2)!(DRUGCLAS=" ") D  I 1
"RTN","TIULMED",235,0)
 ....I DRUGCLAS=" " S TEMP="   ====== Drug Class Unknown "
"RTN","TIULMED",236,0)
 ....E  S TEMP="   ====== Drug Class: "_DRUGCLAS_" "
"RTN","TIULMED",237,0)
 ...E  S TEMP="   "
"RTN","TIULMED",238,0)
 ...S TEMP=$E(TEMP_DASH73,1,LLEN-2)
"RTN","TIULMED",239,0)
 ...D ADD^TIULMED1(TEMP)
"RTN","TIULMED",240,0)
 ...S HEADER=OLDHEADR,TAB=OLDTAB
"RTN","TIULMED",241,0)
 ..S COUNT=COUNT+1,TOTAL=TOTAL+1
"RTN","TIULMED",242,0)
 ..D ADDMED^TIULMED1(0)
"RTN","TIULMED",243,0)
 I COUNT'=TOTAL D
"RTN","TIULMED",244,0)
 .S TAB=0
"RTN","TIULMED",245,0)
 .D ADD^TIULMED1(" ")
"RTN","TIULMED",246,0)
 .D ADD^TIULMED1(TOTAL_" Total Medications")
"RTN","TIULMED",247,0)
 K @TARGET@("C")
"RTN","TIULMED",248,0)
LISTX K ^TMP("PS",$J)
"RTN","TIULMED",249,0)
 Q "~@"_$NA(@TARGET)
"RTN","TIULMED",250,0)
 ;
"RTN","TIULMED",251,0)
GETCLASS ;
"RTN","TIULMED",252,0)
 D GETCLASS^TIULMED3
"RTN","TIULMED",253,0)
 Q
"RTN","TIULMED3")
0^3^B354742
"RTN","TIULMED3",1,0)
TIULMED3 ; BP/ELR - cont. of Active/Recent Med Objects Routine ;3/17/2004 [6/28/05 9:12am]
"RTN","TIULMED3",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**198**;Aug 3, 2005
"RTN","TIULMED3",3,0)
 Q
"RTN","TIULMED3",4,0)
GETCLASS ; Get Drug Class, filter out supplies
"RTN","TIULMED3",5,0)
 I +DRUGIDX D
"RTN","TIULMED3",6,0)
 .N TEMPNODE
"RTN","TIULMED3",7,0)
 .S DRUGCLAS=$$DRGCLASS^TIULMED2(DRUGIDX)
"RTN","TIULMED3",8,0)
 .S TEMPNODE=U_DRUGCLAS_U_$$DEA^TIULMED2(DRUGIDX)
"RTN","TIULMED3",9,0)
 .I 'SUPPLIES,($E(DRUGCLAS,1,2)="XA") D
"RTN","TIULMED3",10,0)
 ..S KEEPMED='($P(TEMPNODE,U,3)["S")
"RTN","TIULMED3",11,0)
 Q
"VER")
8.0^22.0
"BLD",6307,6)
^SEQ #188
**END**
**END**
