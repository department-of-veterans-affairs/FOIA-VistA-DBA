Released XM*7.1*42 SEQ #34
Extracted from mail message
**KIDS**:XM*7.1*42^

**INSTALL NAME**
XM*7.1*42
"BLD",22,0)
XM*7.1*42^MAILMAN^0^2970331^n
"BLD",22,1,0)
^^53^53^2970331^^^^
"BLD",22,1,1,0)
 Prerequisites: none
"BLD",22,1,2,0)
=========================================================================== 
"BLD",22,1,3,0)
 This MailMan patch is in response to the following:
"BLD",22,1,4,0)

"BLD",22,1,5,0)
IOW-0397-40004, MWV-0297-20667, BAY-0397-30178, FAV-0397-71157
"BLD",22,1,6,0)
 KIDS messages were losing the Message Type field during transmission.
"BLD",22,1,7,0)
 When the user installed the patch they would get an 'UNDEFINDED
"BLD",22,1,8,0)
 FUNCTION' error.
"BLD",22,1,9,0)

"BLD",22,1,10,0)
ANN-0397-41843  Sites were sometimes getting a '550 Domain file locked'
"BLD",22,1,11,0)
 message after installing patch XM*7.1*34
"BLD",22,1,12,0)

"BLD",22,1,13,0)
This patch also contains code which lays the groundwork for the upcoming
"BLD",22,1,14,0)
domain name changes.
"BLD",22,1,15,0)
===========================================================================
"BLD",22,1,16,0)
 This patch should be installed during off-peak hours when network mail
"BLD",22,1,17,0)
 activity is low. This patch can be installed with users on the system.
"BLD",22,1,18,0)
===========================================================================
"BLD",22,1,19,0)
 
"BLD",22,1,20,0)
INSTALLATION:
"BLD",22,1,21,0)
  1.  These routines are usually mapped on systems that allow mapping,
"BLD",22,1,22,0)
      so you will need to disable mapping for the effected routines.
"BLD",22,1,23,0)
  2.  Use the 'INSTALL/CHECK MESSAGE' option on the PackMan menu. This
"BLD",22,1,24,0)
      option will load the KIDS package onto your system.
"BLD",22,1,25,0)
  3.  The patch has now been loaded into a Transport global on your
"BLD",22,1,26,0)
      system. You now need to use KIDS to install the Transport global.
"BLD",22,1,27,0)
  4.  Users can remain on the system. This patch can be queued and should be
"BLD",22,1,28,0)
      installed during off-peak hours.  TaskMan can remain running.
"BLD",22,1,29,0)
  5.  On the KIDS menu, under the 'Installation' menu, use the following
"BLD",22,1,30,0)
      options:
"BLD",22,1,31,0)
         2 Verify Checksums in Transport Global
"BLD",22,1,32,0)
         3 Print Transport Global
"BLD",22,1,33,0)
         4 Compare Transport Global to Current System
"BLD",22,1,34,0)
         5 Backup a Transport Global
"BLD",22,1,35,0)
         6 Install Package(s)
"BLD",22,1,36,0)
  6.  MSM Sites - Answer YES to the question 'Want to MOVE routines to
"BLD",22,1,37,0)
      other CPUs?'. Enter the names of your Compute and Print server(s).
"BLD",22,1,38,0)
  7.  AXP Sites, after patch has installed, rebuild your map set.
"BLD",22,1,39,0)
============================================================================ 
"BLD",22,1,40,0)
  
"BLD",22,1,41,0)
 ROUTINES:
"BLD",22,1,42,0)
   Checksums were calculated with CHECK^XTSUMBLD
"BLD",22,1,43,0)
   The second line of the routine now looks like:
"BLD",22,1,44,0)
       ;;7.1;MailMan;**[patch list]**;Jun 02, 1994
"BLD",22,1,45,0)
 
"BLD",22,1,46,0)
               Before          After
"BLD",22,1,47,0)
 Name          Checksum        Checksum        Patch List
"BLD",22,1,48,0)
 ----------------------------------------------------------
"BLD",22,1,49,0)
 XM0            5124637         3346676         4,42
"BLD",22,1,50,0)
 XMP2A          9900587        10037244         24,42
"BLD",22,1,51,0)
 XMR0B          9558225         9580242         4,6,13,34,42
"BLD",22,1,52,0)
============================================================================
"BLD",22,1,53,0)

"BLD",22,4,0)
^9.64PA^^0
"BLD",22,"KRN",0)
^9.67PA^19^14
"BLD",22,"KRN",.4,0)
.4
"BLD",22,"KRN",.401,0)
.401
"BLD",22,"KRN",.402,0)
.402
"BLD",22,"KRN",.403,0)
.403
"BLD",22,"KRN",.5,0)
.5
"BLD",22,"KRN",.84,0)
.84
"BLD",22,"KRN",3.6,0)
3.6
"BLD",22,"KRN",3.8,0)
3.8
"BLD",22,"KRN",9.2,0)
9.2
"BLD",22,"KRN",9.8,0)
9.8
"BLD",22,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",22,"KRN",9.8,"NM",1,0)
XM0^^0^B4451827
"BLD",22,"KRN",9.8,"NM",2,0)
XMP2A^^0^B18544183
"BLD",22,"KRN",9.8,"NM",3,0)
XMR0B^^0^B22511132
"BLD",22,"KRN",9.8,"NM","B","XM0",1)

"BLD",22,"KRN",9.8,"NM","B","XMP2A",2)

"BLD",22,"KRN",9.8,"NM","B","XMR0B",3)

"BLD",22,"KRN",19,0)
19
"BLD",22,"KRN",19.1,0)
19.1
"BLD",22,"KRN",101,0)
101
"BLD",22,"KRN",409.61,0)
409.61
"BLD",22,"KRN","B",.4,.4)

"BLD",22,"KRN","B",.401,.401)

"BLD",22,"KRN","B",.402,.402)

"BLD",22,"KRN","B",.403,.403)

"BLD",22,"KRN","B",.5,.5)

"BLD",22,"KRN","B",.84,.84)

"BLD",22,"KRN","B",3.6,3.6)

"BLD",22,"KRN","B",3.8,3.8)

"BLD",22,"KRN","B",9.2,9.2)

"BLD",22,"KRN","B",9.8,9.8)

"BLD",22,"KRN","B",19,19)

"BLD",22,"KRN","B",19.1,19.1)

"BLD",22,"KRN","B",101,101)

"BLD",22,"KRN","B",409.61,409.61)

"BLD",22,"QUES",0)
^9.62^^
"PKG",8,-1)
1^1
"PKG",8,0)
MAILMAN^XM^Electronic Mail, both local and networked
"PKG",8,22,0)
^9.49I^1^1
"PKG",8,22,1,0)
7.1^2940602^2951128
"PKG",8,22,1,"PAH",1,0)
42^2970331
"PKG",8,22,1,"PAH",1,1,0)
^^53^53^2970331
"PKG",8,22,1,"PAH",1,1,1,0)
 Prerequisites: none
"PKG",8,22,1,"PAH",1,1,2,0)
=========================================================================== 
"PKG",8,22,1,"PAH",1,1,3,0)
 This MailMan patch is in response to the following:
"PKG",8,22,1,"PAH",1,1,4,0)

"PKG",8,22,1,"PAH",1,1,5,0)
IOW-0397-40004, MWV-0297-20667, BAY-0397-30178, FAV-0397-71157
"PKG",8,22,1,"PAH",1,1,6,0)
 KIDS messages were losing the Message Type field during transmission.
"PKG",8,22,1,"PAH",1,1,7,0)
 When the user installed the patch they would get an 'UNDEFINDED
"PKG",8,22,1,"PAH",1,1,8,0)
 FUNCTION' error.
"PKG",8,22,1,"PAH",1,1,9,0)

"PKG",8,22,1,"PAH",1,1,10,0)
ANN-0397-41843  Sites were sometimes getting a '550 Domain file locked'
"PKG",8,22,1,"PAH",1,1,11,0)
 message after installing patch XM*7.1*34
"PKG",8,22,1,"PAH",1,1,12,0)

"PKG",8,22,1,"PAH",1,1,13,0)
This patch also contains code which lays the groundwork for the upcoming
"PKG",8,22,1,"PAH",1,1,14,0)
domain name changes.
"PKG",8,22,1,"PAH",1,1,15,0)
===========================================================================
"PKG",8,22,1,"PAH",1,1,16,0)
 This patch should be installed during off-peak hours when network mail
"PKG",8,22,1,"PAH",1,1,17,0)
 activity is low. This patch can be installed with users on the system.
"PKG",8,22,1,"PAH",1,1,18,0)
===========================================================================
"PKG",8,22,1,"PAH",1,1,19,0)
 
"PKG",8,22,1,"PAH",1,1,20,0)
INSTALLATION:
"PKG",8,22,1,"PAH",1,1,21,0)
  1.  These routines are usually mapped on systems that allow mapping,
"PKG",8,22,1,"PAH",1,1,22,0)
      so you will need to disable mapping for the effected routines.
"PKG",8,22,1,"PAH",1,1,23,0)
  2.  Use the 'INSTALL/CHECK MESSAGE' option on the PackMan menu. This
"PKG",8,22,1,"PAH",1,1,24,0)
      option will load the KIDS package onto your system.
"PKG",8,22,1,"PAH",1,1,25,0)
  3.  The patch has now been loaded into a Transport global on your
"PKG",8,22,1,"PAH",1,1,26,0)
      system. You now need to use KIDS to install the Transport global.
"PKG",8,22,1,"PAH",1,1,27,0)
  4.  Users can remain on the system. This patch can be queued and should be
"PKG",8,22,1,"PAH",1,1,28,0)
      installed during off-peak hours.  TaskMan can remain running.
"PKG",8,22,1,"PAH",1,1,29,0)
  5.  On the KIDS menu, under the 'Installation' menu, use the following
"PKG",8,22,1,"PAH",1,1,30,0)
      options:
"PKG",8,22,1,"PAH",1,1,31,0)
         2 Verify Checksums in Transport Global
"PKG",8,22,1,"PAH",1,1,32,0)
         3 Print Transport Global
"PKG",8,22,1,"PAH",1,1,33,0)
         4 Compare Transport Global to Current System
"PKG",8,22,1,"PAH",1,1,34,0)
         5 Backup a Transport Global
"PKG",8,22,1,"PAH",1,1,35,0)
         6 Install Package(s)
"PKG",8,22,1,"PAH",1,1,36,0)
  6.  MSM Sites - Answer YES to the question 'Want to MOVE routines to
"PKG",8,22,1,"PAH",1,1,37,0)
      other CPUs?'. Enter the names of your Compute and Print server(s).
"PKG",8,22,1,"PAH",1,1,38,0)
  7.  AXP Sites, after patch has installed, rebuild your map set.
"PKG",8,22,1,"PAH",1,1,39,0)
============================================================================ 
"PKG",8,22,1,"PAH",1,1,40,0)
  
"PKG",8,22,1,"PAH",1,1,41,0)
 ROUTINES:
"PKG",8,22,1,"PAH",1,1,42,0)
   Checksums were calculated with CHECK^XTSUMBLD
"PKG",8,22,1,"PAH",1,1,43,0)
   The second line of the routine now looks like:
"PKG",8,22,1,"PAH",1,1,44,0)
       ;;7.1;MailMan;**[patch list]**;Jun 02, 1994
"PKG",8,22,1,"PAH",1,1,45,0)
 
"PKG",8,22,1,"PAH",1,1,46,0)
               Before          After
"PKG",8,22,1,"PAH",1,1,47,0)
 Name          Checksum        Checksum        Patch List
"PKG",8,22,1,"PAH",1,1,48,0)
 ----------------------------------------------------------
"PKG",8,22,1,"PAH",1,1,49,0)
 XM0            5124637         3346676         4,42
"PKG",8,22,1,"PAH",1,1,50,0)
 XMP2A          9900587        10037244         24,42
"PKG",8,22,1,"PAH",1,1,51,0)
 XMR0B          9558225         9580242         4,6,13,34,42
"PKG",8,22,1,"PAH",1,1,52,0)
============================================================================
"PKG",8,22,1,"PAH",1,1,53,0)

"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","XM0")
0^1^B4451827
"RTN","XM0",1,0)
XM0 ;(WASH ISC)/CAP/THM-MailMan Main - Miscelaneous ;03/14/97  09:51
"RTN","XM0",2,0)
 ;;7.1;MailMan;**4,42**;Jun 02, 1994
"RTN","XM0",3,0)
MULTI ;From XM - If not the first sign-on for this person into MailMan
"RTN","XM0",4,0)
 W *7,!!,"It appears someone is signed on as you already."
"RTN","XM0",5,0)
 W !!,"YOU MAY NOT SEND MAIL OR RESPOND TO MAIL IN THIS SESSION !!!"
"RTN","XM0",6,0)
 W !,"(Only the 1st of multiple MailMan sessions may send or respond to mail.)"
"RTN","XM0",7,0)
 S XMNOSEND=1 Q
"RTN","XM0",8,0)
 ;
"RTN","XM0",9,0)
CHECK ;CHECK MAILMAN NAME SYNTAX
"RTN","XM0",10,0)
CHDOM N I,L,X1,X2
"RTN","XM0",11,0)
 I $L(X)>99 W !,*7,"Domain names must be less than 99 characters." G ER
"RTN","XM0",12,0)
 I $TR(X,"()<>@,;:\[]"_$C(34),"")'=X W !,*7," Domain names must contain only alpha, numeric, or '_' characters."  G ER
"RTN","XM0",13,0)
 S X1=$TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ"),L=$L(X1,".")
"RTN","XM0",14,0)
 F I=1:1:L D  G:'I ER
"RTN","XM0",15,0)
 .S X2=$P(X1,".",I)
"RTN","XM0",16,0)
 .I X2'?1A.E1AN!(X2'?.E1AN) W !,*7," Domain name must begin with a letter and end with a letter or number."  S I=0 Q
"RTN","XM0",17,0)
 .I $L(X2)>12!($L(X2)<1) W !,*7," Each ""."" piece must be 1 to 12 characters long." S I=0 Q
"RTN","XM0",18,0)
 .;don't check the last '.' piece or if this is a DIFROM
"RTN","XM0",19,0)
 .Q:I=L!$D(DIFROM)
"RTN","XM0",20,0)
 .I $O(^DIC(4.2996,"B",X2,0)) W !,*7," Domain name must not match with Internet reserved domain names." S I=0 Q
"RTN","XM0",21,0)
 Q
"RTN","XM0",22,0)
ER N Y
"RTN","XM0",23,0)
 R !,"Do you want HELP on NETWORK DOMAIN NAMES: NO// ",Y:DTIME
"RTN","XM0",24,0)
 I "Yy"'[$E(Y)!(Y="")!'$T G ER1
"RTN","XM0",25,0)
 S XQH="XMDOMAIN" D EN^XQH
"RTN","XM0",26,0)
ER1 K X Q
"RTN","XMP2A")
0^2^B18544183
"RTN","XMP2A",1,0)
XMP2A ;(WASH ISC)/GM/CAP- PACKMAN INSTALL ;03/14/97  10:52
"RTN","XMP2A",2,0)
 ;;7.1;MailMan;**24,42**;Jun 02, 1994
"RTN","XMP2A",3,0)
ENH I $P(XMR,U,7)]"" D  G:$D(XMPKIDS) 2
"RTN","XMP2A",4,0)
 .;check if KIDS format
"RTN","XMP2A",5,0)
 .I $P(XMR,U,7)["K",$$CHECK1("I $E(XMB0,1,5)=""$KID """) S XMPKIDS=1 Q
"RTN","XMP2A",6,0)
 .I $P(XMR,U,7)["X",$$CHECK1("I $E(XMB0,1,11)=""$TXT $KIDS """) S XMPKIDS=1 Q
"RTN","XMP2A",7,0)
 ;check if KIDS but Message Type field got lost
"RTN","XMP2A",8,0)
 I $P(XMR,U,7)="",$$CHECK1("I $E(XMB0,1,5)=""$KID """) S XMPKIDS=1 G 2
"RTN","XMP2A",9,0)
 G 1:$S('$D(DUZ(0)):1,DUZ(0)="@":0,$D(^XUSEC("XUPROGMODE",DUZ)):0,1:1)
"RTN","XMP2A",10,0)
 W !!,*7,"Warning:  Installing this message will cause a permanent update of globals"
"RTN","XMP2A",11,0)
 W !,"and routines"_$S($P(XMR,U,7)["X":" and run the INIT",1:"")_"." D  Q:'Y
"RTN","XMP2A",12,0)
 .N DIR,DIRUT
"RTN","XMP2A",13,0)
 .S DIR(0)="Y",DIR("B")="NO",DIR("A")="Do you really want to do this"
"RTN","XMP2A",14,0)
 .D ^DIR
"RTN","XMP2A",15,0)
1 D CHECK D:Y<0  G:'Y Q
"RTN","XMP2A",16,0)
 .N DIR,DIRUT
"RTN","XMP2A",17,0)
 .S DIR(0)="Y",DIR("B")="NO",DIR("A")="This doesn't appear to be an installable message, do you wish to continue"
"RTN","XMP2A",18,0)
 .D ^DIR
"RTN","XMP2A",19,0)
2 S XMPASS=1,XMA0=^XMB(3.9,XMZ,0) I $L(XMB0),$L($P(XMA0,U,10)),$D(^("K")) D ^XMPSEC G 3:$S('$D(DUZ(0)):0,DUZ(0)="@":1,$D(^XUSEC("XUPROGMODE",DUZ)):1,1:0)
"RTN","XMP2A",20,0)
 I $P(XMB0," at ",3)["on" S XMPASS=0 D FAIL^XMPSEC
"RTN","XMP2A",21,0)
 I $S('$D(DUZ(0)):1,DUZ(0)="@":0,$D(^XUSEC("XUPROGMODE",DUZ)):0,1:1) G Q
"RTN","XMP2A",22,0)
3 G X:XMP2="R",ENI^XMP2:XMPASS'=0
"RTN","XMP2A",23,0)
 W !,"This message may not be installed !!" G Q
"RTN","XMP2A",24,0)
X G Z:'$D(XMP2),Z:XMP2'="R" K DIR
"RTN","XMP2A",25,0)
 S DIR("A")="ROUTINE(S)",DIR(0)="FO^2:30",DIR("?")="^D HLP^XMP2A"
"RTN","XMP2A",26,0)
Y D ^DIR K DIRUT G Z:$D(DTOUT)!$D(DUOUT) G:X="" Q:$O(XMP2(""))="",ENI^XMP2
"RTN","XMP2A",27,0)
 I X'?1.A.AN.1"*" W " ???",*7 G Y
"RTN","XMP2A",28,0)
 S XMP2(X)="" G Y
"RTN","XMP2A",29,0)
Z G Q^XMP2
"RTN","XMP2A",30,0)
Q K DIR G Q^XMP2
"RTN","XMP2A",31,0)
ENTT ;LIST/PRINT TEXT ONLY
"RTN","XMP2A",32,0)
 F I=0:0 S XCN=$O(^XMB(3.9,XMZ,2,XCN)) Q:XCN=""  S X=^(XCN,0) D  I $D(XMOUT) K XMOUT Q
"RTN","XMP2A",33,0)
 .I $E(X,1,5)?1"$"3U1" " S:$E(X)="$" I=$S($E(X,1,4)="$END":0,X'["TXT":1,X["$TXT $KIDS":1,1:0)
"RTN","XMP2A",34,0)
 .I 'I,$E(X,1,4)'="$END" D P1^XMP2
"RTN","XMP2A",35,0)
 Q
"RTN","XMP2A",36,0)
ENTR ;INSTALL SELECTED ROUTINE(S) [IN XMP2 ARRAY]
"RTN","XMP2A",37,0)
 F I=0:0 S XCN=$O(^XMB(3.9,XMZ,2,XCN)) Q:XCN=""  S X=^(XCN,0) I $E(X)="$" S Y=$P(X," ",2),J="" F I=0:0 S J=$O(XMP2(J)),K=$L(J)-1 Q:J=""  I $S(J=Y:1,J'?.AN1"*":0,$E(J,1,K)=$E(Y,1,K):1,1:0) D S1^XMP2
"RTN","XMP2A",38,0)
 Q
"RTN","XMP2A",39,0)
HLP ;Routine selection
"RTN","XMP2A",40,0)
 W !!,"Choose routines that you wish to install from this message by entering",!,"single names or a series (XMP2*=all routines that begin with 'XMP2')."
"RTN","XMP2A",41,0)
 W !,"The message is not checked to see if there are any matches to your input.",!,"It may be helpful to request a SUMMARY of the message first."
"RTN","XMP2A",42,0)
 W !,"Only routines selected for installation are backed up.",!!
"RTN","XMP2A",43,0)
 Q
"RTN","XMP2A",44,0)
CHECK ;check text header
"RTN","XMP2A",45,0)
 S %="I $E(XMB0,1,5)=""$TXT "",$P(XMB0,""Created ""_$S(XMB0[""BACKUP"":""on "",1:""by ""),2)?1E.E1"" at "".E1"" at "".E",%=$$CHECK1(%)
"RTN","XMP2A",46,0)
 S Y=$S(%:%,1:-1)
"RTN","XMP2A",47,0)
 Q
"RTN","XMP2A",48,0)
CHECK1(XMCHK) ;Check text header meets condition XMCHK
"RTN","XMP2A",49,0)
 ;returns line number of text header or 0, XMB0=text header
"RTN","XMP2A",50,0)
 N XMCNT,XMFLAG
"RTN","XMP2A",51,0)
 S XMFLAG=0,XMCNT=.999,XMB0=""
"RTN","XMP2A",52,0)
 F  S XMCNT=$O(^XMB(3.9,XMZ,2,XMCNT)) Q:'XMCNT  S XMB0=$G(^(XMCNT,0)) D  Q:'XMCNT
"RTN","XMP2A",53,0)
 .X XMCHK I  S XMFLAG=XMCNT,XMCNT=""
"RTN","XMP2A",54,0)
 Q XMFLAG
"RTN","XMP2A",55,0)
 ;
"RTN","XMP2A",56,0)
PHELP ;Help for Editing PackMan fields
"RTN","XMP2A",57,0)
 D ZIS^XMAH1
"RTN","XMP2A",58,0)
 S X=99 X ^%ZOSF("RM") W *7,IORVON,IOBON,!!,"IMPORTANT",IORVOFF,IOBOFF,!!
"RTN","XMP2A",59,0)
 N % S %="You are about to edit what appears to be a PackMan message." D W
"RTN","XMP2A",60,0)
 S %="Please note the following:" D W
"RTN","XMP2A",61,0)
 S %="" D W S %="1. Editing this message may compromise its' integrity." D W
"RTN","XMP2A",62,0)
 S %="2. It is recommended that editing not be done to code." D W
"RTN","XMP2A",63,0)
 S %="3. Insertion on lines should be done directly after the 1st" D W
"RTN","XMP2A",64,0)
 S %="   line of this message (begins '$TXT'), never after any" D W
"RTN","XMP2A",65,0)
 S %="   other line that begins with a '$' (dollar sign)." D W
"RTN","XMP2A",66,0)
 S %="4. Do not begin any line with a $ sign. It causes problems." D W
"RTN","XMP2A",67,0)
 S %="" D W S %="So, note the above and be very careful !" D W
"RTN","XMP2A",68,0)
 R !!,"Hit any key to continue.",X:DTIME S X=IOM X ^%ZOSF("RM")
"RTN","XMP2A",69,0)
 K IORVON,IOBON,IORVOFF,IOBOFF Q
"RTN","XMP2A",70,0)
W W !?1,IORVON,"|",IORVOFF," " W %," ",?75,IORVON,"|",IORVOFF Q
"RTN","XMR0B")
0^3^B22511132
"RTN","XMR0B",1,0)
XMR0B ;(WASH ISC)/THM/CAP-SMTP (HELO/MAIL) [ARPANET RFC 821] ;03/18/97  13:11
"RTN","XMR0B",2,0)
VER ;;7.1;MailMan;**4,6,13,34,42**;Jun 02, 1994
"RTN","XMR0B",3,0)
HELO ;;HELLO COMMAND
"RTN","XMR0B",4,0)
 S XMRVAL=0
"RTN","XMR0B",5,0)
 I XMP="" S XMSG="501 Missing domain specification" X XMSEN Q
"RTN","XMR0B",6,0)
 I '$D(^XMB("NETNAME")) S XMSG="550 Unchristened local domain" X XMSEN Q
"RTN","XMR0B",7,0)
 D R1^XMR S X=$P(XMP,"<") I $E(X,$L(X))="." S XMSG="Invalid Domain Name" X XMSEN Q
"RTN","XMR0B",8,0)
 ;S XMHELO("XMP")=X,Y=$$DOMAIN(X)
"RTN","XMR0B",9,0)
 S Y=$$DOMAIN(X),XMHELO("XMP")=$P(Y,U,2)
"RTN","XMR0B",10,0)
 S XMINST=+Y S:'$G(XMRDOM) XMRDOM=XMINST
"RTN","XMR0B",11,0)
 ;Lock Domain
"RTN","XMR0B",12,0)
 L +^DIC(4.2,+Y,0):0 E  S XMSG="550 Domain file locked, try later" X XMSEN Q
"RTN","XMR0B",13,0)
 I '$D(^XMBS(4.2999,+Y,0)) D STAT^XMC1(+Y)
"RTN","XMR0B",14,0)
 ;XMBT=1 for batch processing, XMRVAL=validation number
"RTN","XMR0B",15,0)
 G H:XMBT S XMRVAL=$P($P(XMP,"<",2),">")
"RTN","XMR0B",16,0)
 S Y(0)=^DIC(4.2,+Y,0)
"RTN","XMR0B",17,0)
 ;check val. num
"RTN","XMR0B",18,0)
 D  I '$D(XMRVAL) G HQ
"RTN","XMR0B",19,0)
 . Q:XMRVAL=$P(Y(0),U,15)
"RTN","XMR0B",20,0)
 . I XMRVAL=$P(Y(0),U,18) S $P(Y(0),U,15)=$P(Y(0),U,18) Q
"RTN","XMR0B",21,0)
 . S XMB="XMVALBAD",XMB(1)=$P(XMP,"<") D ^XMB
"RTN","XMR0B",22,0)
 . S XMSG="550 Bad validation number" X XMSEN
"RTN","XMR0B",23,0)
 . K XMRVAL Q
"RTN","XMR0B",24,0)
 S XMSG="250 OK "_^XMB("NETNAME")
"RTN","XMR0B",25,0)
 ;generate new validation number
"RTN","XMR0B",26,0)
 I XMRVAL D
"RTN","XMR0B",27,0)
 . S XMRVAL=($R(8000000)+1000000)
"RTN","XMR0B",28,0)
 . ;set val. num in return message, set new Val. num field
"RTN","XMR0B",29,0)
 . S XMSG=XMSG_" <"_XMRVAL_">",$P(Y(0),U,18)=XMRVAL
"RTN","XMR0B",30,0)
 . S ^DIC(4.2,+Y,0)=Y(0)
"RTN","XMR0B",31,0)
 S XMSG=XMSG_" ["_$P($T(VER),";",3)_",DUP,SER,FTP]"
"RTN","XMR0B",32,0)
H S XMSITE=$P(Y,U,2),XMSTATE="^MAIL^",XMCONT=XMCONT_"TURN^MESS^"
"RTN","XMR0B",33,0)
 X XMSEN
"RTN","XMR0B",34,0)
 Q:$G(XMRVAL)
"RTN","XMR0B",35,0)
HQ L -^DIC(4.2,XMINST,0) Q
"RTN","XMR0B",36,0)
 ;
"RTN","XMR0B",37,0)
DOMAIN(X) ;Domain name of sender acceptable ?
"RTN","XMR0B",38,0)
 N DIC,ER,X9,XMA21A,XMP,XMR0B,XMSEN
"RTN","XMR0B",39,0)
 S DIC=4.2,DIC(0)="FM",XMR0B=X D I2^XMA21A
"RTN","XMR0B",40,0)
 I Y>0 Q Y
"RTN","XMR0B",41,0)
 N % S (%,X)=XMR0B X ^%ZOSF("UPPERCASE") S XMR0B=Y
"RTN","XMR0B",42,0)
 F  S Y=$O(^DIC(4.2,"C",XMR0B,0)) D  Q:Y>0!'$L(XMR0B)
"RTN","XMR0B",43,0)
 . I Y>0 Q
"RTN","XMR0B",44,0)
 . S XMR0B=$P(XMR0B,".",2,$L(XMR0B,"."))
"RTN","XMR0B",45,0)
 . Q
"RTN","XMR0B",46,0)
 I Y>0 Q $$DQ(Y)
"RTN","XMR0B",47,0)
 Q $$DN(%)
"RTN","XMR0B",48,0)
DQ(Y) Q Y_"^"_$P(^DIC(4.2,+Y,0),U)
"RTN","XMR0B",49,0)
DN(X) ;Add new Domain
"RTN","XMR0B",50,0)
 N DA,DD,DO,XMR0B
"RTN","XMR0B",51,0)
 X ^%ZOSF("UPPERCASE") S (XMR0B,X)=$P(Y,".",$L(Y,".")),XMR0B("X")=Y
"RTN","XMR0B",52,0)
 S DIC="^DIC(4.2,",DIC("DR")="1///C"_$S(^XMB("NETNAME")="FORUM.VA.GOV":"",1:";2///FORUM.VA.GOV") D FILE^DICN
"RTN","XMR0B",53,0)
 K DA,DD,DO
"RTN","XMR0B",54,0)
 S ^DIC(4.2,+Y,1,0)="^4.21^1^1"
"RTN","XMR0B",55,0)
 S ^DIC(4.2,+Y,1,1,0)="AUTO^^^OTHER",^(1,0)="^^1^1^"_DT,^(1,0)="X Q"
"RTN","XMR0B",56,0)
 S ^DIC(4.2,+Y,1,"NOTES",0)="^^1^1^"_DT,^(1,0)="Auto-Created-XMR0B"
"RTN","XMR0B",57,0)
 N XMDUZ,XMSUB
"RTN","XMR0B",58,0)
 S XMDUZ=.5,XMSUB="New Domain created - "_$P(Y,U,2),XMTEXT="A("
"RTN","XMR0B",59,0)
 S A(1)="An incoming transmission from this previously undefined"
"RTN","XMR0B",60,0)
 S A(2)="domain ("_XMR0B("X")_") caused this new domain"
"RTN","XMR0B",61,0)
 S A(3)="("_$P(Y,U,2)_") to be created"
"RTN","XMR0B",62,0)
 S A(4)="",A(5)="to limit the number of entries that are created."
"RTN","XMR0B",63,0)
 S A(5)="The Internet Suffix is used for this purpose."
"RTN","XMR0B",64,0)
 S A(6)="Statistics are then collected for that level of activity."
"RTN","XMR0B",65,0)
 S XMY("G.POSTMASTER")="" D ^XMD
"RTN","XMR0B",66,0)
 I '$O(^DIC(4.2996,"B",X,0)) S XMR0B("Y")=Y,DIC="^DIC(4.2996,",DIC("DR")="1///AUTOMATIC-XMR0B" D FILE^DICN S Y=XMR0B("Y")
"RTN","XMR0B",67,0)
 Q $P(Y,U,1,2)
"RTN","XMR0B",68,0)
 ;
"RTN","XMR0B",69,0)
VAL ;check validation number
"RTN","XMR0B",70,0)
 ;if new val. num. exist, then set val. num. to it and set to null
"RTN","XMR0B",71,0)
 N % K XMRVAL
"RTN","XMR0B",72,0)
 S %=$G(^DIC(4.2,XMINST,0))
"RTN","XMR0B",73,0)
 I $P(%,U,18) S $P(%,U,15)=$P(%,U,18),$P(%,U,18)="",^DIC(4.2,+XMINST,0)=%
"RTN","XMR0B",74,0)
 D HQ
"RTN","XMR0B",75,0)
 Q
"RTN","XMR0B",76,0)
MAIL ;;START
"RTN","XMR0B",77,0)
 S XMP=$P(XMP,":",2,999) I XMP="" S XMSG="501 Invalid reverse-path specification" X XMSEN Q
"RTN","XMR0B",78,0)
 I $$REJ(XMP) S XMSG="502 No message receipt authorization." X XMSEN Q
"RTN","XMR0B",79,0)
 K XMY,XMY0,^TMP("XMY",$J),^TMP("XMY0",$J),XMA21G D G2^XMA2 S XMZHOLD=XMDUZ,XMDUZ=.5,XMKM=.95
"RTN","XMR0B",80,0)
 I '$D(^XMB(3.7,.5,2,.95,0)) S ^(0)="ARRIVING",^XMB(3.7,.5,2,"B","ARRIVING",.95)=""
"RTN","XMR0B",81,0)
 D S2^XMA1B
"RTN","XMR0B",82,0)
 S XMDUZ=XMZHOLD,XMBCK=XMP,XMSG="250 OK Message-ID:"_XMZ_"@"_^XMB("NETNAME"),XMSTATE="^LOCK^RCPT^DATA",XMLOCK="" X XMSEN Q:ER
"RTN","XMR0B",83,0)
 S X="N",%DT="T" D ^%DT S ^XMB(3.9,XMZ,0)="^^"_Y,X=Y,Y=$E(X,6,7)_" "_$P("Jan^Feb^Mar^Apr^May^Jun^Jul^Aug^Sep^Oct^Nov^Dec",U,$E(X,4,5))_" "_$E(X,2,3) S:X\1'=X %=$P(X,".",2)_"0000",Y=Y_" "_$E(%,1,2)_":"_$E(%,3,4)
"RTN","XMR0B",84,0)
 S XMD=Y I $G(XMCHAN)="" S XMCHAN="Turn Around"
"RTN","XMR0B",85,0)
 S X=XMCHAN,X=$S(X'?.N:X,$D(^DIC(3.4,X,0)):$P(^(0),U),1:"")
"RTN","XMR0B",86,0)
 ;DON'T CHANGE ORDER OF .001 & .002 LINES !
"RTN","XMR0B",87,0)
 S ^XMB(3.9,XMZ,2,.001,0)="Received: "_$S($L($G(XMSITE("XMP"))):"from "_XMSITE("XMP")_" by "_^XMB("NETNAME")_", MailMan "_$P($T(VER),";",3)_"/"_X,1:"BATCH")_" ; "_XMD_" "_^XMB("TIMEZONE")
"RTN","XMR0B",88,0)
 Q
"RTN","XMR0B",89,0)
REJ(X) ;Check Senders rejected list
"RTN","XMR0B",90,0)
 I '$O(^XMBX(4.501,0)) G Q0
"RTN","XMR0B",91,0)
 N A,B,C,D,Y S C=^%ZOSF("UPPERCASE") X C S D=Y,A=""
"RTN","XMR0B",92,0)
 F  S A=$O(^XMBX(4.501,"B",A)) G Q0:A="" S X=A X C I D[Y S B=$O(^(A,0)) I B,'$P($G(^XMBX(4.501,B,0)),U,2) Q
"RTN","XMR0B",93,0)
 Q 1
"RTN","XMR0B",94,0)
Q0 Q 0
"VER")
8.0^21.0
**END**
**END**
