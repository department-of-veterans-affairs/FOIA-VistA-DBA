Released IB*2*244 SEQ #244
Extracted from mail message
**KIDS**:IB*2.0*244^

**INSTALL NAME**
IB*2.0*244
"BLD",5180,0)
IB*2.0*244^INTEGRATED BILLING^0^3040614^y
"BLD",5180,1,0)
^^3^3^3031218^
"BLD",5180,1,1,0)
This patch corrects a situation which allows the IB DM EXTRACT DATE file
"BLD",5180,1,2,0)
to become corrupted.  It also corrects a situation where the Subscriber ID
"BLD",5180,1,3,0)
is saved with hyphens still embedded in the number.
"BLD",5180,4,0)
^9.64PA^351.71^1
"BLD",5180,4,351.71,0)
351.71
"BLD",5180,4,351.71,2,0)
^9.641^351.71^1
"BLD",5180,4,351.71,2,351.71,0)
IB DM EXTRACT DATA  (File-top level)
"BLD",5180,4,351.71,2,351.71,1,0)
^9.6411^.01^1
"BLD",5180,4,351.71,2,351.71,1,.01,0)
MONTH/YEAR
"BLD",5180,4,351.71,222)
y^n^p^^^^n^^n
"BLD",5180,4,351.71,224)

"BLD",5180,4,"APDD",351.71,351.71)

"BLD",5180,4,"APDD",351.71,351.71,.01)

"BLD",5180,4,"B",351.71,351.71)

"BLD",5180,"INID")
^n
"BLD",5180,"INIT")
POST^IB20P244
"BLD",5180,"KRN",0)
^9.67PA^8989.52^19
"BLD",5180,"KRN",.4,0)
.4
"BLD",5180,"KRN",.401,0)
.401
"BLD",5180,"KRN",.402,0)
.402
"BLD",5180,"KRN",.403,0)
.403
"BLD",5180,"KRN",.5,0)
.5
"BLD",5180,"KRN",.84,0)
.84
"BLD",5180,"KRN",3.6,0)
3.6
"BLD",5180,"KRN",3.8,0)
3.8
"BLD",5180,"KRN",9.2,0)
9.2
"BLD",5180,"KRN",9.8,0)
9.8
"BLD",5180,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",5180,"KRN",9.8,"NM",1,0)
IBJDE^^0^B25096430
"BLD",5180,"KRN",9.8,"NM",2,0)
IBJDE1^^0^B74507836
"BLD",5180,"KRN",9.8,"NM",3,0)
IBCNSU1^^0^B11956107
"BLD",5180,"KRN",9.8,"NM",4,0)
IB20R244^^0^B80726601
"BLD",5180,"KRN",9.8,"NM","B","IB20R244",4)

"BLD",5180,"KRN",9.8,"NM","B","IBCNSU1",3)

"BLD",5180,"KRN",9.8,"NM","B","IBJDE",1)

"BLD",5180,"KRN",9.8,"NM","B","IBJDE1",2)

"BLD",5180,"KRN",19,0)
19
"BLD",5180,"KRN",19.1,0)
19.1
"BLD",5180,"KRN",101,0)
101
"BLD",5180,"KRN",409.61,0)
409.61
"BLD",5180,"KRN",771,0)
771
"BLD",5180,"KRN",870,0)
870
"BLD",5180,"KRN",8989.51,0)
8989.51
"BLD",5180,"KRN",8989.52,0)
8989.52
"BLD",5180,"KRN",8994,0)
8994
"BLD",5180,"KRN","B",.4,.4)

"BLD",5180,"KRN","B",.401,.401)

"BLD",5180,"KRN","B",.402,.402)

"BLD",5180,"KRN","B",.403,.403)

"BLD",5180,"KRN","B",.5,.5)

"BLD",5180,"KRN","B",.84,.84)

"BLD",5180,"KRN","B",3.6,3.6)

"BLD",5180,"KRN","B",3.8,3.8)

"BLD",5180,"KRN","B",9.2,9.2)

"BLD",5180,"KRN","B",9.8,9.8)

"BLD",5180,"KRN","B",19,19)

"BLD",5180,"KRN","B",19.1,19.1)

"BLD",5180,"KRN","B",101,101)

"BLD",5180,"KRN","B",409.61,409.61)

"BLD",5180,"KRN","B",771,771)

"BLD",5180,"KRN","B",870,870)

"BLD",5180,"KRN","B",8989.51,8989.51)

"BLD",5180,"KRN","B",8989.52,8989.52)

"BLD",5180,"KRN","B",8994,8994)

"BLD",5180,"QUES",0)
^9.62^^
"BLD",5180,"REQB",0)
^9.611^2^2
"BLD",5180,"REQB",1,0)
IB*2.0*254^1
"BLD",5180,"REQB",2,0)
IB*2.0*133^1
"BLD",5180,"REQB","B","IB*2.0*133",2)

"BLD",5180,"REQB","B","IB*2.0*254",1)

"FIA",351.71)
IB DM EXTRACT DATA
"FIA",351.71,0)
^IBE(351.71,
"FIA",351.71,0,0)
351.71D
"FIA",351.71,0,1)
y^n^p^^^^n^^n
"FIA",351.71,0,10)

"FIA",351.71,0,11)

"FIA",351.71,0,"RLRO")

"FIA",351.71,0,"VR")
2.0^IB
"FIA",351.71,351.71)
1
"FIA",351.71,351.71,.01)

"INIT")
POST^IB20P244
"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
244^3040614
"PKG",200,22,1,"PAH",1,1,0)
^^3^3^3040614
"PKG",200,22,1,"PAH",1,1,1,0)
This patch corrects a situation which allows the IB DM EXTRACT DATE file
"PKG",200,22,1,"PAH",1,1,2,0)
to become corrupted.  It also corrects a situation where the Subscriber ID
"PKG",200,22,1,"PAH",1,1,3,0)
is saved with hyphens still embedded in the number.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","IB20P244")
0^^B58419468
"RTN","IB20P244",1,0)
IB20P244 ;ISP/TDP - Post-Init routine for IB*2.0*244 ;10/14/2003
"RTN","IB20P244",2,0)
 ;;2.0;INTEGRATED BILLING;**244**;21-MAR-94
"RTN","IB20P244",3,0)
POST ; This routine is to remove hyphens from the SUBSCRIBER ID (#1) field
"RTN","IB20P244",4,0)
 ; of the INSURANCE TYPE SUB-FIELD (#2.312) file of the PATIENT (#2)
"RTN","IB20P244",5,0)
 ; file.  It also will delete invalid entries from the IB DM EXTRACT
"RTN","IB20P244",6,0)
 ; DATA (#351.71) file.
"RTN","IB20P244",7,0)
 ;
"RTN","IB20P244",8,0)
EN ; Start of Post-Init process.
"RTN","IB20P244",9,0)
 N %,IBDATE,IBNOW,IBPURGE,X,X1,X2
"RTN","IB20P244",10,0)
 D NOW^%DTC S (IBNOW,X1)=X,IBDATE=%
"RTN","IB20P244",11,0)
 S X2=120
"RTN","IB20P244",12,0)
 D C^%DTC S IBPURGE=X
"RTN","IB20P244",13,0)
 ;K ^XTMP("IB20P244",IBDATE)
"RTN","IB20P244",14,0)
 S ^XTMP("IB20P244",0)=IBPURGE_"^"_IBNOW_"^"_$G(DUZ)
"RTN","IB20P244",15,0)
 D SUBSCR
"RTN","IB20P244",16,0)
 D INSUR
"RTN","IB20P244",17,0)
 D END
"RTN","IB20P244",18,0)
 Q
"RTN","IB20P244",19,0)
SUBSCR ;Remove all hyphens from subscriber ID's in the INSURANCE TYPE
"RTN","IB20P244",20,0)
 ;SUB-FIELD (#2.312) file of the PATIENT (#2) file.
"RTN","IB20P244",21,0)
 D MES^XPDUTL("SUBSCRIBER ID clean up started in the")
"RTN","IB20P244",22,0)
 D MES^XPDUTL("   INSURANCE TYPE SUB-FIELD (#2.312) file.")
"RTN","IB20P244",23,0)
 D MES^XPDUTL("> Searching for SUBSCRIBER ID's containing invalid characters.")
"RTN","IB20P244",24,0)
 D MES^XPDUTL(" ")
"RTN","IB20P244",25,0)
 N DA,DFN,DIE,DR,IBCHAR,IBCHAR1,IBCNT,IBHICN,IBINS,IBINSCO,IBNAME,IBNODE
"RTN","IB20P244",26,0)
 N IBRC,IBSSN,IBSUB,IBSUB1,IBSUB2,IBWNR
"RTN","IB20P244",27,0)
 K ^TMP("IB20P244",$J)
"RTN","IB20P244",28,0)
 S ^TMP("IB20P244",$J)=""
"RTN","IB20P244",29,0)
 S IBCHAR="~` !@#$%^&*()_-+={}[]|\/:;<>,.?'"""
"RTN","IB20P244",30,0)
 S IBCHAR1="~`!@$%^&*()_+={}[]|:;<>?'"""
"RTN","IB20P244",31,0)
 S IBWNR=+$$GETWNR^IBCNSMM1
"RTN","IB20P244",32,0)
 S (DFN,IBRC,IBCNT)=0
"RTN","IB20P244",33,0)
 ; Loop through Patient (#2) file
"RTN","IB20P244",34,0)
 F  S DFN=$O(^DPT(DFN)) Q:DFN=""  D
"RTN","IB20P244",35,0)
 . S IBINS=0
"RTN","IB20P244",36,0)
 . ; Loop through Insurance Type Sub-Field
"RTN","IB20P244",37,0)
 . F  S IBINS=$O(^DPT(DFN,.312,IBINS)) Q:IBINS=""  D
"RTN","IB20P244",38,0)
 .. S IBCNT=IBCNT+1 I IBCNT>999 W ". " S IBCNT=0
"RTN","IB20P244",39,0)
 .. S IBNODE=$G(^DPT(DFN,.312,IBINS,0))
"RTN","IB20P244",40,0)
 .. ; Get Subscriber ID
"RTN","IB20P244",41,0)
 .. S IBSUB=$P(IBNODE,U,2) I IBSUB="" Q
"RTN","IB20P244",42,0)
 .. S IBSSN=$TR($P($G(^DPT(DFN,0)),U,9),IBCHAR,"")
"RTN","IB20P244",43,0)
 .. S IBNAME=$P($G(^DPT(DFN,0)),U,1)
"RTN","IB20P244",44,0)
 .. ; Remove non-alphanumeric characters
"RTN","IB20P244",45,0)
 .. I $P(IBNODE,U,1)=IBWNR D  ;Medicare
"RTN","IB20P244",46,0)
 ... S IBSUB1=$TR(IBSUB,IBCHAR,"")
"RTN","IB20P244",47,0)
 ... ; Check for invalid HICN format and no date of death
"RTN","IB20P244",48,0)
 ... I '$$VALHIC^IBCNSMM(IBSUB1),'$P($G(^DPT(DFN,.35)),U,1) S ^TMP("IB20P244",$J,"HICN INVALID",IBNAME_" ("_IBSSN_")")=IBSUB_"^"_IBSUB1
"RTN","IB20P244",49,0)
 .. I $P(IBNODE,U,1)'=IBWNR D  ;non-Medicare
"RTN","IB20P244",50,0)
 ... S IBSUB1=$TR(IBSUB,IBCHAR1,"")
"RTN","IB20P244",51,0)
 ... ;If subscriber id is SSN, then remove all extraneous characters
"RTN","IB20P244",52,0)
 ... S IBSUB2=$TR(IBSUB1," #-/\,.","")
"RTN","IB20P244",53,0)
 ... I IBSUB2=IBSSN,$L(IBSSN)=9 S IBSUB1=IBSUB2
"RTN","IB20P244",54,0)
 .. ;I IBHICN S ^TMP("IB20P244",$J,"HICN INVALID",IBNAME_" ("_IBSSN_")")=IBSUB_"^"_IBSUB1 S IBHICN=0
"RTN","IB20P244",55,0)
 .. ; Quit if no change in data
"RTN","IB20P244",56,0)
 .. I IBSUB1=IBSUB Q
"RTN","IB20P244",57,0)
 .. S IBINSCO=$P($G(^DIC(36,$P($G(^DPT(DFN,.312,IBINS,0)),U,1),0)),U,1)
"RTN","IB20P244",58,0)
 .. S IBRC=IBRC+1
"RTN","IB20P244",59,0)
 .. S ^XTMP("IB20P244",IBDATE,"SUB",DFN,IBINS)=IBSUB_"^"_IBSUB1
"RTN","IB20P244",60,0)
 .. ; Save newly cleaned Subscriber ID
"RTN","IB20P244",61,0)
 .. S DA=IBINS,DA(1)=DFN,DR="1////"_$S(IBSUB1="":"@",1:IBSUB1),DIE="^DPT(DFN,.312," D ^DIE
"RTN","IB20P244",62,0)
 .. ;D MES^XPDUTL(">> Converted SUBSCRIBER ID of patient "_IBNAME_" ("_IBSSN_") from "_IBSUB_" to "_IBSUB1_" for insurance company "_IBINSCO)
"RTN","IB20P244",63,0)
 D BMES^XPDUTL("> "_IBRC_" total SUBSCRIBER ID(S) were cleaned up.")
"RTN","IB20P244",64,0)
 I $D(^TMP("IB20P244",$J,"HICN INVALID")) D MESSAGE
"RTN","IB20P244",65,0)
 K ^TMP("IB20P244",$J)
"RTN","IB20P244",66,0)
 Q
"RTN","IB20P244",67,0)
 ;
"RTN","IB20P244",68,0)
END ; display message that post-init has completed successfully
"RTN","IB20P244",69,0)
 K X,Y
"RTN","IB20P244",70,0)
 D MES^XPDUTL(" ")
"RTN","IB20P244",71,0)
 D BMES^XPDUTL("Data clean up conversions complete.")
"RTN","IB20P244",72,0)
 Q
"RTN","IB20P244",73,0)
 ;
"RTN","IB20P244",74,0)
INSUR ;This will remove all future dates and all past date entries which
"RTN","IB20P244",75,0)
 ;contain a day other than "00".  For example, 3031000 is a valid entry
"RTN","IB20P244",76,0)
 ;while 3051200 and 3031014 are not based on a current date of 3031015.
"RTN","IB20P244",77,0)
 N FTDT,PTDT
"RTN","IB20P244",78,0)
 D MES^XPDUTL(" ")
"RTN","IB20P244",79,0)
 D BMES^XPDUTL("IB DM EXTRACT DATA (#351.71) file clean up started.")
"RTN","IB20P244",80,0)
 D MES^XPDUTL("> Searching for invalid entries.")
"RTN","IB20P244",81,0)
 D FUTURE
"RTN","IB20P244",82,0)
 D PAST
"RTN","IB20P244",83,0)
 D MES^XPDUTL(" ")
"RTN","IB20P244",84,0)
 I FTDT D MES^XPDUTL(">> "_FTDT_" invalid future date entries were deleted.")
"RTN","IB20P244",85,0)
 I 'FTDT D MES^XPDUTL(">> There were no invalid future date entries found.")
"RTN","IB20P244",86,0)
 I PTDT D MES^XPDUTL(">> "_PTDT_" invalid past date entries were deleted.")
"RTN","IB20P244",87,0)
 I 'PTDT D MES^XPDUTL(">> There were no invalid past date entries found.")
"RTN","IB20P244",88,0)
 D BMES^XPDUTL("> IB DM EXTRACT DATA (#351.71) file clean up completed.")
"RTN","IB20P244",89,0)
INSURQ Q
"RTN","IB20P244",90,0)
 ;
"RTN","IB20P244",91,0)
FUTURE ;This utility searches for and deletes future date entries from file
"RTN","IB20P244",92,0)
 ;351.71.
"RTN","IB20P244",93,0)
 ;Outputs:  FTDT - number of future date entries deleted from 351.71.
"RTN","IB20P244",94,0)
 ; ^XTMP("IB20P244",IBDATE,"INS","FUT") - This global is created
"RTN","IB20P244",95,0)
 ;        to temporarily store the data from the deleted future
"RTN","IB20P244",96,0)
 ;        date entries.  Will not exist if no future dates are
"RTN","IB20P244",97,0)
 ;        found.
"RTN","IB20P244",98,0)
 N CDT,DA,DATE,DIK
"RTN","IB20P244",99,0)
 S FTDT=0
"RTN","IB20P244",100,0)
 D NOW^%DTC S CDT=X
"RTN","IB20P244",101,0)
 S DATE=99999999
"RTN","IB20P244",102,0)
 F  S DATE=$O(^IBE(351.71,DATE),-1) Q:DATE'>CDT  D
"RTN","IB20P244",103,0)
 . M ^XTMP("IB20P244",IBDATE,"INS","FUT",DATE)=^IBE(351.71,DATE)
"RTN","IB20P244",104,0)
 . S DIK="^IBE(351.71,",DA=DATE D ^DIK
"RTN","IB20P244",105,0)
 . S FTDT=FTDT+1
"RTN","IB20P244",106,0)
 . Q
"RTN","IB20P244",107,0)
 Q
"RTN","IB20P244",108,0)
 ;
"RTN","IB20P244",109,0)
PAST ;This utility searches for and deletes past date entries from file
"RTN","IB20P244",110,0)
 ;351.71 that end with something other than "00".
"RTN","IB20P244",111,0)
 ;Outputs:  PTDT - number of entries deleted from 351.71.
"RTN","IB20P244",112,0)
 ; ^XTMP("IB20P244",IBDATE,"INS","PST") - This global is created
"RTN","IB20P244",113,0)
 ;        to temporarily store the data from the deleted past
"RTN","IB20P244",114,0)
 ;        date entries.  Will not exist if no past dates are
"RTN","IB20P244",115,0)
 ;        found.
"RTN","IB20P244",116,0)
 N DA,DATE,DIK
"RTN","IB20P244",117,0)
 S PTDT=0
"RTN","IB20P244",118,0)
 S DATE=0
"RTN","IB20P244",119,0)
 F  S DATE=$O(^IBE(351.71,DATE)) Q:DATE=""  D
"RTN","IB20P244",120,0)
 . I $E(DATE,6,7)="00" Q
"RTN","IB20P244",121,0)
 . I 'DATE Q
"RTN","IB20P244",122,0)
 . M ^XTMP("IB20P244",IBDATE,"INS","PST",DATE)=^IBE(351.71,DATE)
"RTN","IB20P244",123,0)
 . S DIK="^IBE(351.71,",DA=DATE D ^DIK
"RTN","IB20P244",124,0)
 . S PTDT=PTDT+1
"RTN","IB20P244",125,0)
 . Q
"RTN","IB20P244",126,0)
 Q
"RTN","IB20P244",127,0)
 ;
"RTN","IB20P244",128,0)
MESSAGE ; Send message reporting invalid HICN format
"RTN","IB20P244",129,0)
 N IBC,IBBCNT,IBCNT,IBDATA,IBFCNT,IBIDENT,IBGROUP,IBGRP,IBINSCO,IBMMSG
"RTN","IB20P244",130,0)
 N IBMSG,IBNETNM,IBPARAM,IBSUB,IBTCNT,IBTST,IBTXT,XMDUZ,XMERR,XMSUB
"RTN","IB20P244",131,0)
 N XMTEXT,XMY
"RTN","IB20P244",132,0)
 S IBTCNT=0,IBIDENT=""
"RTN","IB20P244",133,0)
 F  S IBIDENT=$O(^TMP("IB20P244",$J,"HICN INVALID",IBIDENT)) Q:IBIDENT=""  D
"RTN","IB20P244",134,0)
 . S IBTCNT=IBTCNT+1
"RTN","IB20P244",135,0)
 S IBSUB=0
"RTN","IB20P244",136,0)
 D MSGHDR
"RTN","IB20P244",137,0)
 I DUZ="" N DUZ S DUZ=.5 ; if user not defined set to postmaster
"RTN","IB20P244",138,0)
 S XMDUZ=DUZ,XMTEXT=$NA(^TMP($J))
"RTN","IB20P244",139,0)
 S IBPARAM("FROM")="PATCH IB*2.0*244 POST-INIT"
"RTN","IB20P244",140,0)
 S IBGROUP="IB EDI SUPERVISOR"
"RTN","IB20P244",141,0)
 S IBGRP=$O(^XMB(3.8,"B",IBGROUP,"")) I IBGRP D  ;billing group defined
"RTN","IB20P244",142,0)
 . I +$P($G(^XMB(3.8,IBGRP,1,0)),U,4)'>0 Q  ; no members defined
"RTN","IB20P244",143,0)
 . S XMY("G."_IBGROUP)="" ; send message to the group.
"RTN","IB20P244",144,0)
 ;I '$D(^XMB(3.8,"B",IBGROUP)) S IBGROUP=DUZ ; billing group not defined - send to the user
"RTN","IB20P244",145,0)
 ;E  S IBGROUP="G."_IBGROUP
"RTN","IB20P244",146,0)
 S XMY(DUZ)="" ; send message to user
"RTN","IB20P244",147,0)
 ;Send to developer if not test account (next 3 lines)
"RTN","IB20P244",148,0)
 S IBTST=".TEST.MIR.TST.MIRROR.TRAIN."     ; various test names
"RTN","IB20P244",149,0)
 S IBNETNM=$G(^XMB("NETNAME"))
"RTN","IB20P244",150,0)
 I IBNETNM'="",('$F(IBTST,"."_$P(IBNETNM,".",1)_".")) S XMY("PHELPS,TY@FORUM.VA.GOV")=""
"RTN","IB20P244",151,0)
 ;
"RTN","IB20P244",152,0)
 S IBINSCO=$P($G(^DIC(36,IBWNR,0)),U,1)
"RTN","IB20P244",153,0)
MSG1 S IBC=0
"RTN","IB20P244",154,0)
 S IBC=IBC+1,^TMP($J,IBC)="This message has been sent by patch IB*2.0*244 at the completion of"
"RTN","IB20P244",155,0)
 S IBC=IBC+1,^TMP($J,IBC)="the post-init routine."
"RTN","IB20P244",156,0)
 S IBC=IBC+1,^TMP($J,IBC)="The following "_IBINSCO_" SUBSCRIBER ID entries remain in an invalid state:"
"RTN","IB20P244",157,0)
 S IBC=IBC+1,^TMP($J,IBC)="  "
"RTN","IB20P244",158,0)
 S IBC=IBC+1,^TMP($J,IBC)="NAME(SSN) ^ ORIGINAL ID ^ MODIFIED ID"
"RTN","IB20P244",159,0)
 S IBC=IBC+1,^TMP($J,IBC)="  "
"RTN","IB20P244",160,0)
 S (IBMMSG,IBMSG)=0
"RTN","IB20P244",161,0)
 I IBSUB=1 S IBCNT=0,IBIDENT="",IBBCNT=1
"RTN","IB20P244",162,0)
 I IBSUB>1 S IBBCNT=IBCNT+1
"RTN","IB20P244",163,0)
 F  S IBIDENT=$O(^TMP("IB20P244",$J,"HICN INVALID",IBIDENT)) Q:IBIDENT=""  D  G:IBMSG MSG1
"RTN","IB20P244",164,0)
 . S IBDATA=$G(^TMP("IB20P244",$J,"HICN INVALID",IBIDENT))
"RTN","IB20P244",165,0)
 . S IBC=IBC+1,^TMP($J,IBC)=IBIDENT_"^"_IBDATA
"RTN","IB20P244",166,0)
 . S IBCNT=IBCNT+1
"RTN","IB20P244",167,0)
 . I 'IBMMSG S IBMMSG=1
"RTN","IB20P244",168,0)
 . I IBC>9500 S IBFCNT=IBCNT D
"RTN","IB20P244",169,0)
 .. S IBC=IBC+1,^TMP($J,IBC)="  "
"RTN","IB20P244",170,0)
 .. S IBC=IBC+1,^TMP($J,IBC)="This message contains "_IBBCNT_" thru "_IBFCNT_" of "_IBTCNT_" total"
"RTN","IB20P244",171,0)
 .. S IBC=IBC+1,^TMP($J,IBC)="records left in an invalid state."
"RTN","IB20P244",172,0)
 .. D SNDMSG,MSGHDR S IBMSG=1
"RTN","IB20P244",173,0)
 S IBC=IBC+1,^TMP($J,IBC)="  "
"RTN","IB20P244",174,0)
 I IBSUB=1 D
"RTN","IB20P244",175,0)
 .S IBC=IBC+1,^TMP($J,IBC)="Total records left in an invalid state: "_IBCNT_"."
"RTN","IB20P244",176,0)
 I IBSUB>1 D
"RTN","IB20P244",177,0)
 . S IBC=IBC+1,^TMP($J,IBC)="This message contains "_IBBCNT_" thru "_IBCNT_" of "_IBTCNT_" total"
"RTN","IB20P244",178,0)
 . S IBC=IBC+1,^TMP($J,IBC)="records left in an invalid state."
"RTN","IB20P244",179,0)
 I IBMMSG D SNDMSG
"RTN","IB20P244",180,0)
 Q
"RTN","IB20P244",181,0)
SNDMSG ;
"RTN","IB20P244",182,0)
 D SENDMSG^XMXAPI(XMDUZ,XMSUB,XMTEXT,.XMY,.IBPARAM,"","")
"RTN","IB20P244",183,0)
 S IBTXT="Invalid Medicare SUBSCRIBER ID message #"_IBSUB_" "_$S($D(XMERR):"not sent due to error in message set up.",1:"sent to ")_$S($D(XMY("G.IB EDI SUPERVISOR")):"IB EDI SUPERVISOR mail group, ",1:"")
"RTN","IB20P244",184,0)
 D BMES^XPDUTL(IBTXT)
"RTN","IB20P244",185,0)
 S IBTXT="   the "_$S(DUZ=.5:"POSTMASTER ",1:"user ")_"and the patch developer."
"RTN","IB20P244",186,0)
 D MES^XPDUTL(IBTXT)
"RTN","IB20P244",187,0)
 K ^TMP($J)
"RTN","IB20P244",188,0)
 Q
"RTN","IB20P244",189,0)
 ;
"RTN","IB20P244",190,0)
MSGHDR ;Creates message subject line
"RTN","IB20P244",191,0)
 K ^TMP($J)
"RTN","IB20P244",192,0)
 S IBSUB=IBSUB+1
"RTN","IB20P244",193,0)
 S XMSUB="SUBSCRIBER ID CLEAN UP COMPLETE"
"RTN","IB20P244",194,0)
 I IBSUB>1 S XMSUB=XMSUB_" (MSG #"_IBSUB_")"
"RTN","IB20P244",195,0)
 Q
"RTN","IB20R244")
0^4^B80726601
"RTN","IB20R244",1,0)
IB20R244 ;ISP/TDP - Restoral routine for IB*2.0*244 ;10/14/2003
"RTN","IB20R244",2,0)
 ;;2.0;INTEGRATED BILLING;**244**;21-MAR-94
"RTN","IB20R244",3,0)
 ; This routine is to restore data to the SUBSCRIBER ID (#1) field
"RTN","IB20R244",4,0)
 ; of the INSURANCE TYPE SUB-FIELD (#2.312) file of the PATIENT (#2)
"RTN","IB20R244",5,0)
 ; file and to the IB DM EXTRACT DATA (#351.71) file that was removed
"RTN","IB20R244",6,0)
 ; during the data conversion by post-init routine IB20P244 in patch
"RTN","IB20R244",7,0)
 ; IB*2.0*244.  Data can only be restored if the ^XTMP("IB20P244" file
"RTN","IB20R244",8,0)
 ; still exists.
"RTN","IB20R244",9,0)
 Q
"RTN","IB20R244",10,0)
UNDOALL ;Undoes all the changes made by the post-init routine, based on what
"RTN","IB20R244",11,0)
 ;is stored in ^XTMP("IB20P244".
"RTN","IB20R244",12,0)
 N ALL,IBDIK
"RTN","IB20R244",13,0)
 S ALL=1,IBDIK=0
"RTN","IB20R244",14,0)
 I '$D(^XTMP("IB20P244",0)) W !,"There is no data to restore." Q
"RTN","IB20R244",15,0)
 D UNDOP
"RTN","IB20R244",16,0)
 D UNDOF
"RTN","IB20R244",17,0)
 D UNDOSUB
"RTN","IB20R244",18,0)
 W !!,"Data restoral complete."
"RTN","IB20R244",19,0)
 Q
"RTN","IB20R244",20,0)
UNDOP ;Restore the past date entries in file 351.71 which were deleted.
"RTN","IB20R244",21,0)
 N IBJ,PCNT,PDATE
"RTN","IB20R244",22,0)
 I '$G(ALL),'$D(^XTMP("IB20P244",0)) W !,"There is no data to restore." Q
"RTN","IB20R244",23,0)
 S PCNT=0
"RTN","IB20R244",24,0)
 S IBJ=""
"RTN","IB20R244",25,0)
 F  S IBJ=$O(^XTMP("IB20P244",IBJ),-1) Q:IBJ=""  D
"RTN","IB20R244",26,0)
 . S PDATE=""
"RTN","IB20R244",27,0)
 . F  S PDATE=$O(^XTMP("IB20P244",IBJ,"INS","PST",PDATE)) Q:PDATE=""  D
"RTN","IB20R244",28,0)
 .. S PCNT=PCNT+1
"RTN","IB20R244",29,0)
 .. D MDATE(PDATE,"PST","RSTP")
"RTN","IB20R244",30,0)
 W !
"RTN","IB20R244",31,0)
 I PCNT=0 W !,"There are no past date entries to restore for file 351.71."
"RTN","IB20R244",32,0)
 I PCNT'=0 S IBDIK=1 I '$G(ALL) D RENDX K IBDIK
"RTN","IB20R244",33,0)
 Q
"RTN","IB20R244",34,0)
UNDOF ;Restore the future date entries in file 351.71 which were deleted.
"RTN","IB20R244",35,0)
 N IBJ,FCNT,FDATE
"RTN","IB20R244",36,0)
 I '$G(ALL),'$D(^XTMP("IB20P244",0)) W !,"There is no data to restore." Q
"RTN","IB20R244",37,0)
 S FCNT=0
"RTN","IB20R244",38,0)
 S IBJ=""
"RTN","IB20R244",39,0)
 F  S IBJ=$O(^XTMP("IB20P244",IBJ),-1) Q:IBJ=""  D
"RTN","IB20R244",40,0)
 . S FDATE=""
"RTN","IB20R244",41,0)
 . F  S FDATE=$O(^XTMP("IB20P244",IBJ,"INS","FUT",FDATE)) Q:FDATE=""  D
"RTN","IB20R244",42,0)
 .. S FCNT=FCNT+1
"RTN","IB20R244",43,0)
 .. D MDATE(FDATE,"FUT","RSTF")
"RTN","IB20R244",44,0)
 W !
"RTN","IB20R244",45,0)
 I FCNT=0 W !,"There are no future date entries to restore for file 351.71."
"RTN","IB20R244",46,0)
 I FCNT'=0!($G(IBDIK)) D RENDX
"RTN","IB20R244",47,0)
 Q
"RTN","IB20R244",48,0)
RENDX ;Re-index file 351.71.
"RTN","IB20R244",49,0)
 W !!,"Re-indexing file 351.71..."
"RTN","IB20R244",50,0)
 S DIK="^IBE(351.71," D IXALL^DIK K DIK
"RTN","IB20R244",51,0)
 W "Done"
"RTN","IB20R244",52,0)
 Q
"RTN","IB20R244",53,0)
MDATE(DATE,DTYP,DRTYP) ;Common date functionality merge/kill
"RTN","IB20R244",54,0)
 I $O(^IBE(351.71,DATE,""))'="" W !,"Entry already exists for "_DATE_".  Skipping restoral of this date entry." Q
"RTN","IB20R244",55,0)
 M ^IBE(351.71,DATE)=^XTMP("IB20P244",IBJ,"INS",DTYP,DATE)
"RTN","IB20R244",56,0)
 M ^XTMP("IB20P244",IBJ,"INS",DRTYP,DATE)=^XTMP("IB20P244",IBJ,"INS",DTYP,DATE)
"RTN","IB20R244",57,0)
 K ^XTMP("IB20P244",IBJ,"INS",DTYP,DATE)
"RTN","IB20R244",58,0)
 W !,"The entry for "_DATE_" has been restored."
"RTN","IB20R244",59,0)
 Q
"RTN","IB20R244",60,0)
UNDOSUB ;Restore original SUBSCRIBER ID'S modified in the INSURANCE TYPE
"RTN","IB20R244",61,0)
 ;SUB-FIELD (#2.312) file of the PATIENT (#2) file.
"RTN","IB20R244",62,0)
 N DA,DFN,DIE,DR,IBDATE,IBINS,IBINSCO,IBINSNM,IBJ,IBJN,IBNAME,IBNODATA
"RTN","IB20R244",63,0)
 N IBSSN,IBSUB,IBSUB1,SCNT,SEL,X,Y
"RTN","IB20R244",64,0)
 I '$G(ALL),'$D(^XTMP("IB20P244",0)) W !,"There is no data to restore." Q
"RTN","IB20R244",65,0)
 I $G(ALL) W ! G ALL
"RTN","IB20R244",66,0)
CHOICE S DIR("A")="DO YOU WANT TO RESTORE (A)LL OR (S)ELECTED SUBSCRIBER ID'S? "
"RTN","IB20R244",67,0)
 S DIR("B")="QUIT"
"RTN","IB20R244",68,0)
 S DIR("T")=300
"RTN","IB20R244",69,0)
 S DIR("?")="Choose ALL to restore all subscriber id's, or choose SELECTED to choose individual patient's for restoral."
"RTN","IB20R244",70,0)
 S DIR(0)="FAO^1:8^"
"RTN","IB20R244",71,0)
 D ^DIR
"RTN","IB20R244",72,0)
 I $E(X,1)="S" S Y="SELECTED"
"RTN","IB20R244",73,0)
 I $E(X,1)="A" S Y="ALL"
"RTN","IB20R244",74,0)
 I Y="QUIT"!(Y="")!($D(DTOUT))!($D(DUOUT)) G SUBEXIT
"RTN","IB20R244",75,0)
 I Y'="ALL",Y'="SELECTED" G CHOICE
"RTN","IB20R244",76,0)
 I Y="ALL" W ! G ALL
"RTN","IB20R244",77,0)
CHOICE1 S DIR("A")="DO YOU WANT TO RESTORE BY (P)ATIENT OR BY (I)NSURANCE COMPANY? "
"RTN","IB20R244",78,0)
 S DIR("B")="QUIT"
"RTN","IB20R244",79,0)
 S DIR("T")=300
"RTN","IB20R244",80,0)
 S DIR("?")="Choose PATIENT to restore specific patient subscriber id's, or choose INSURANCE COMPANY to choose specific insurance companies for restoral."
"RTN","IB20R244",81,0)
 S DIR(0)="FAO^1:8^"
"RTN","IB20R244",82,0)
 D ^DIR
"RTN","IB20R244",83,0)
 S IBNODATA=0
"RTN","IB20R244",84,0)
 I $E(X,1)="P" S Y="PATIENT"
"RTN","IB20R244",85,0)
 I $E(X,1)="I" S Y="INSURANCE COMPANY"
"RTN","IB20R244",86,0)
 I Y="QUIT"!(Y="")!($D(DTOUT))!($D(DUOUT)) G CHOICE
"RTN","IB20R244",87,0)
 I Y'="PATIENT",Y'="INSURANCE COMPANY" G CHOICE1
"RTN","IB20R244",88,0)
 I Y="PATIENT" W ! S SEL="PAT" G SELPAT
"RTN","IB20R244",89,0)
 W !
"RTN","IB20R244",90,0)
 S SEL="INS"
"RTN","IB20R244",91,0)
SELINS D GATHER I IBNODATA Q
"RTN","IB20R244",92,0)
SELECT1 S DIC("A")="SELECT INSURANCE COMPANY TO RESTORE SUBSCRIBER ID'S FOR: "
"RTN","IB20R244",93,0)
 S DIC(0)="AENQ"
"RTN","IB20R244",94,0)
 S DIC("S")="I $D(^TMP(""IB20P244"",$J,""SUB"",$P($G(Y),U,1)))"
"RTN","IB20R244",95,0)
 S DIC="^DIC(36,"
"RTN","IB20R244",96,0)
 D ^DIC
"RTN","IB20R244",97,0)
 I $D(DTOUT)!($D(DUOUT))!((X="")&('$D(^TMP("IB20P244",$J,"SEL")))) G CHOICE1
"RTN","IB20R244",98,0)
 I X="" W ! G SEL1
"RTN","IB20R244",99,0)
 S IBINS=$P($G(Y),U,1)
"RTN","IB20R244",100,0)
 M ^TMP("IB20P244",$J,"SEL",IBINS)=^TMP("IB20P244",$J,"SUB",IBINS)
"RTN","IB20R244",101,0)
 S (X,Y)="" G SELECT1
"RTN","IB20R244",102,0)
SEL1 ;RESTORE SELECTED INSURANCE COMPANY SUBSCRIBER ID'S
"RTN","IB20R244",103,0)
 S IBINSCO=""
"RTN","IB20R244",104,0)
 F  S IBINSCO=$O(^TMP("IB20P244",$J,"SEL",IBINSCO)) Q:IBINSCO=""  D
"RTN","IB20R244",105,0)
 . S IBINSNM=$P($G(^DIC(36,IBINSCO,0)),U,1)
"RTN","IB20R244",106,0)
 . S IBJ=""
"RTN","IB20R244",107,0)
 . F  S IBJ=$O(^TMP("IB20P244",$J,"SEL",IBINSCO,IBJ)) Q:IBJ=""  D
"RTN","IB20R244",108,0)
 .. S IBJN=-IBJ
"RTN","IB20R244",109,0)
 .. S Y=IBJN D DD^%DT S IBDATE=Y
"RTN","IB20R244",110,0)
 .. S DFN=""
"RTN","IB20R244",111,0)
 .. F  S DFN=$O(^TMP("IB20P244",$J,"SEL",IBINSCO,IBJ,DFN)) Q:DFN=""  D
"RTN","IB20R244",112,0)
 ... S IBNAME=$P($G(^DPT(DFN,0)),U,1)
"RTN","IB20R244",113,0)
 ... S IBSSN=$P($G(^DPT(DFN,0)),U,9)
"RTN","IB20R244",114,0)
 ... S IBINS=""
"RTN","IB20R244",115,0)
 ... F  S IBINS=$O(^TMP("IB20P244",$J,"SEL",IBINSCO,IBJ,DFN,IBINS)) Q:IBINS=""  D
"RTN","IB20R244",116,0)
 .... D MSUB(IBJN)
"RTN","IB20R244",117,0)
 W !
"RTN","IB20R244",118,0)
 G SELINS
"RTN","IB20R244",119,0)
SELPAT D GATHER I IBNODATA Q
"RTN","IB20R244",120,0)
SELECT S DIC("A")="SELECT PATIENT TO RESTORE SUBSCRIBER ID'S FOR: "
"RTN","IB20R244",121,0)
 S DIC(0)="AEINQ"
"RTN","IB20R244",122,0)
 S DIC("S")="I $D(^TMP(""IB20P244"",$J,""SUB"",$P($G(Y),U,1)))"
"RTN","IB20R244",123,0)
 S DIC="^DPT("
"RTN","IB20R244",124,0)
 D ^DIC
"RTN","IB20R244",125,0)
 I $D(DTOUT)!($D(DUOUT))!((X="")&('$D(^TMP("IB20P244",$J,"SEL")))) G CHOICE1
"RTN","IB20R244",126,0)
 I X="" W ! G SEL
"RTN","IB20R244",127,0)
 S DFN=$P($G(Y),U,1)
"RTN","IB20R244",128,0)
 M ^TMP("IB20P244",$J,"SEL",DFN)=^TMP("IB20P244",$J,"SUB",DFN)
"RTN","IB20R244",129,0)
 S (X,Y)="" G SELECT
"RTN","IB20R244",130,0)
SEL ;RESTORE SELECTED PATIENTS SUBSCRIBER ID'S
"RTN","IB20R244",131,0)
 S DFN=""
"RTN","IB20R244",132,0)
 F  S DFN=$O(^TMP("IB20P244",$J,"SEL",DFN)) Q:DFN=""  D
"RTN","IB20R244",133,0)
 . S IBNAME=$P($G(^DPT(DFN,0)),U,1)
"RTN","IB20R244",134,0)
 . S IBSSN=$P($G(^DPT(DFN,0)),U,9)
"RTN","IB20R244",135,0)
 . S IBJ=""
"RTN","IB20R244",136,0)
 . F  S IBJ=$O(^TMP("IB20P244",$J,"SEL",DFN,IBJ)) Q:IBJ=""  D
"RTN","IB20R244",137,0)
 .. S IBJN=-IBJ
"RTN","IB20R244",138,0)
 .. S Y=IBJN D DD^%DT S IBDATE=Y
"RTN","IB20R244",139,0)
 .. S IBINS=""
"RTN","IB20R244",140,0)
 .. F  S IBINS=$O(^TMP("IB20P244",$J,"SEL",DFN,IBJ,IBINS)) Q:IBINS=""  D
"RTN","IB20R244",141,0)
 ... S IBINSNM=$P($G(^DIC(36,$P($G(^DPT(DFN,.312,IBINS,0)),U,1),0)),U,1)
"RTN","IB20R244",142,0)
 ... D MSUB(IBJN)
"RTN","IB20R244",143,0)
 W !
"RTN","IB20R244",144,0)
 G SELPAT
"RTN","IB20R244",145,0)
SUBEXIT ;Cleans up temp globals
"RTN","IB20R244",146,0)
 K ^TMP("IB20P244",$J)
"RTN","IB20R244",147,0)
 K DIC,DIR,DTOUT,DUOUT
"RTN","IB20R244",148,0)
 Q
"RTN","IB20R244",149,0)
GATHER K ^TMP("IB20P244",$J)
"RTN","IB20R244",150,0)
 S IBJ=""
"RTN","IB20R244",151,0)
 F  S IBJ=$O(^XTMP("IB20P244",IBJ),-1) Q:IBJ=""  D
"RTN","IB20R244",152,0)
 . S DFN=""
"RTN","IB20R244",153,0)
 . F  S DFN=$O(^XTMP("IB20P244",IBJ,"SUB",DFN)) Q:DFN=""  D
"RTN","IB20R244",154,0)
 .. S IBINS=""
"RTN","IB20R244",155,0)
 .. F  S IBINS=$O(^XTMP("IB20P244",IBJ,"SUB",DFN,IBINS)) Q:IBINS=""  D
"RTN","IB20R244",156,0)
 ... I SEL="PAT" S ^TMP("IB20P244",$J,"SUB",DFN,-IBJ,IBINS)="" Q
"RTN","IB20R244",157,0)
 ... S IBINSCO=$P($G(^DPT(DFN,.312,IBINS,0)),U,1)
"RTN","IB20R244",158,0)
 ... S ^TMP("IB20P244",$J,"SUB",IBINSCO,-IBJ,DFN,IBINS)=""
"RTN","IB20R244",159,0)
 I '$D(^TMP("IB20P244")) W !,"There is no subscriber id data to restore!" S IBNODATA=1
"RTN","IB20R244",160,0)
 Q
"RTN","IB20R244",161,0)
ALL S SCNT=0
"RTN","IB20R244",162,0)
 S IBJ=""
"RTN","IB20R244",163,0)
 F  S IBJ=$O(^XTMP("IB20P244",IBJ),-1) Q:IBJ=""  D
"RTN","IB20R244",164,0)
 . S Y=IBJ D DD^%DT S IBDATE=Y
"RTN","IB20R244",165,0)
 . S DFN=""
"RTN","IB20R244",166,0)
 . F  S DFN=$O(^XTMP("IB20P244",IBJ,"SUB",DFN)) Q:DFN=""  D
"RTN","IB20R244",167,0)
 .. S IBNAME=$P($G(^DPT(DFN,0)),U,1)
"RTN","IB20R244",168,0)
 .. S IBSSN=$P($G(^DPT(DFN,0)),U,9)
"RTN","IB20R244",169,0)
 .. S IBINS=""
"RTN","IB20R244",170,0)
 .. F  S IBINS=$O(^XTMP("IB20P244",IBJ,"SUB",DFN,IBINS)) Q:IBINS=""  D
"RTN","IB20R244",171,0)
 ... S SCNT=SCNT+1
"RTN","IB20R244",172,0)
 ... S IBINSNM=$P($G(^DIC(36,$P($G(^DPT(DFN,.312,IBINS,0)),U,1),0)),U,1)
"RTN","IB20R244",173,0)
 ... D MSUB(IBJ)
"RTN","IB20R244",174,0)
 W !
"RTN","IB20R244",175,0)
 I SCNT=0 W !,"There are no SUBSCRIBER ID entries to restore in the INSURANCE TYPE",!,"     SUB-FIELD (#2.312) file of the PATIENT (#2) file."
"RTN","IB20R244",176,0)
 Q
"RTN","IB20R244",177,0)
MSUB(IBJN) ;Common subscriber id functionality merge/kill
"RTN","IB20R244",178,0)
 S IBSUB=$P($G(^XTMP("IB20P244",IBJN,"SUB",DFN,IBINS)),"^",1)
"RTN","IB20R244",179,0)
 I IBSUB=$P($G(^DPT(DFN,.312,IBINS,0)),U,2) W !,"SUBSCRIBER ID for "_IBNAME_" ("_IBSSN_"), entry "_IBINSNM_",",!,"     has already been restored!" D  Q
"RTN","IB20R244",180,0)
 . M ^XTMP("IB20P244",IBJN,"RSTS",DFN,IBINS)=^XTMP("IB20P244",IBJN,"SUB",DFN,IBINS)
"RTN","IB20R244",181,0)
 . K ^XTMP("IB20P244",IBJN,"SUB",DFN,IBINS)
"RTN","IB20R244",182,0)
 S IBSUB1=$P($G(^XTMP("IB20P244",IBJN,"SUB",DFN,IBINS)),"^",2)
"RTN","IB20R244",183,0)
 I IBSUB1'=$P($G(^DPT(DFN,.312,IBINS,0)),U,2) W !,"SUBSCRIBER ID for "_IBNAME_" ("_IBSSN_"), entry "_IBINSNM_", has been",!,"     changed since data conversion.  Skipping restoral of this SUBSCRIBER ID." Q
"RTN","IB20R244",184,0)
 I IBSUB[";" W !!,"Original SUBSCRIBER ID contains a semi-colon (;).  Unable to restore",!,"     SUBSCRIBER ID for "_IBNAME_" ("_IBSSN_"), insurance",!,"     company "_IBINSNM_".  Use Fileman to enter",!,"     ID of """_IBSUB_""".",! Q
"RTN","IB20R244",185,0)
 S DA=IBINS,DA(1)=DFN,DR="1////"_IBSUB,DIE="^DPT(DFN,.312," D ^DIE
"RTN","IB20R244",186,0)
 W !,"The SUBSCRIBER ID for "_IBNAME_" ("_IBSSN_"),",!,"     insurance company "_IBINSNM_", has been restored",!,"     from the "_IBDATE_" data conversion."
"RTN","IB20R244",187,0)
 M ^XTMP("IB20P244",IBJN,"RSTS",DFN,IBINS)=^XTMP("IB20P244",IBJN,"SUB",DFN,IBINS)
"RTN","IB20R244",188,0)
 K ^XTMP("IB20P244",IBJN,"SUB",DFN,IBINS)
"RTN","IB20R244",189,0)
 Q
"RTN","IB20R244",190,0)
SUBPRNT ;Allows user to print an excel friendly list of subscriber id's changed
"RTN","IB20R244",191,0)
 N DFN,IBINS,IBINSNM,IBJ,IBNAME
"RTN","IB20R244",192,0)
 K ^TMP("IB20P244",$J)
"RTN","IB20R244",193,0)
 S IBJ=""
"RTN","IB20R244",194,0)
 F  S IBJ=$O(^XTMP("IB20P244",IBJ),-1) Q:IBJ=""  D
"RTN","IB20R244",195,0)
 . S DFN=""
"RTN","IB20R244",196,0)
 . F  S DFN=$O(^XTMP("IB20P244",IBJ,"SUB",DFN)) Q:DFN=""  D
"RTN","IB20R244",197,0)
 .. S IBNAME=$P($G(^DPT(DFN,0)),U,1)_"("_$P($G(^DPT(DFN,0)),U,9)_")"
"RTN","IB20R244",198,0)
 .. I IBNAME="" S IBNAME="*** UNKNOWN ***"
"RTN","IB20R244",199,0)
 .. S IBINS=""
"RTN","IB20R244",200,0)
 .. F  S IBINS=$O(^XTMP("IB20P244",IBJ,"SUB",DFN,IBINS)) Q:IBINS=""  D
"RTN","IB20R244",201,0)
 ... S IBINSNM=$P($G(^DIC(36,$P($G(^DPT(DFN,.312,IBINS,0)),U,1),0)),U,1)
"RTN","IB20R244",202,0)
 ... I IBINSNM="" S IBINSNM="*** UNKNOWN ***"
"RTN","IB20R244",203,0)
 ... S ^TMP("IB20P244",$J,"SUB",IBINSNM,IBNAME,-IBJ,IBINS)=$G(^XTMP("IB20P244",IBJ,"SUB",DFN,IBINS))
"RTN","IB20R244",204,0)
 I '$D(^TMP("IB20P244",$J,"SUB")) W !,"THERE IS NO DATA TO DISPLAY" Q
"RTN","IB20R244",205,0)
 S IBINSNM=""
"RTN","IB20R244",206,0)
 F  S IBINSNM=$O(^TMP("IB20P244",$J,"SUB",IBINSNM)) Q:IBINSNM=""  D
"RTN","IB20R244",207,0)
 . S IBNAME=""
"RTN","IB20R244",208,0)
 . F  S IBNAME=$O(^TMP("IB20P244",$J,"SUB",IBINSNM,IBNAME)) Q:IBNAME=""  D
"RTN","IB20R244",209,0)
 .. S IBJ=""
"RTN","IB20R244",210,0)
 .. F  S IBJ=$O(^TMP("IB20P244",$J,"SUB",IBINSNM,IBNAME,IBJ)) Q:IBJ=""  D
"RTN","IB20R244",211,0)
 ... S IBINS=""
"RTN","IB20R244",212,0)
 ... F  S IBINS=$O(^TMP("IB20P244",$J,"SUB",IBINSNM,IBNAME,IBJ,IBINS)) Q:IBINS=""  D
"RTN","IB20R244",213,0)
 .... W !,IBINSNM_"^"_IBNAME_"^"_$G(^TMP("IB20P244",$J,"SUB",IBINSNM,IBNAME,IBJ,IBINS))
"RTN","IB20R244",214,0)
 K ^TMP("IB20P244",$J)
"RTN","IB20R244",215,0)
 Q
"RTN","IBCNSU1")
0^3^B11956107
"RTN","IBCNSU1",1,0)
IBCNSU1 ;ALB/AAS - INSURANCE UTILITY ROUTINE ; 19-MAY-93
"RTN","IBCNSU1",2,0)
 ;;2.0;INTEGRATED BILLING;**103,133,244**;21-MAR-94
"RTN","IBCNSU1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCNSU1",4,0)
 ;
"RTN","IBCNSU1",5,0)
RCHK(X) ; -- Input transform for different revenue codes in file 36
"RTN","IBCNSU1",6,0)
 ;    Returns 1 if passes, 0 if not pass input transform
"RTN","IBCNSU1",7,0)
 ;
"RTN","IBCNSU1",8,0)
 N I,Y,RC,NO S Y=0
"RTN","IBCNSU1",9,0)
 I $G(X)="" G RCHKQ
"RTN","IBCNSU1",10,0)
 F I=1:1 S RC=$P(X,",",I) Q:RC=""  I $S(RC?3N:0,RC?5N:0,1:1) S NO=1 Q
"RTN","IBCNSU1",11,0)
 I '$G(NO) S Y=1
"RTN","IBCNSU1",12,0)
RCHKQ Q Y
"RTN","IBCNSU1",13,0)
 ;
"RTN","IBCNSU1",14,0)
BU(DFN,IBCPOL,IBYR,IBCDFN,IBASK) ; -- Return entry in Benefits Used file
"RTN","IBCNSU1",15,0)
 ;     Input:  IBCDFN  = pointer to patient file policy (2.312)
"RTN","IBCNSU1",16,0)
 ;             DFN     = patient pointer        
"RTN","IBCNSU1",17,0)
 ;             IBCPOL  = pointer to health insurance policy file
"RTN","IBCNSU1",18,0)
 ;             IBYR    = fileman internal date, year will be calendar
"RTN","IBCNSU1",19,0)
 ;                       year of the internal date, Default = dt
"RTN","IBCNSU1",20,0)
 ;             IBASK   = 1 if want to ask okay to add new entry
"RTN","IBCNSU1",21,0)
 ;
"RTN","IBCNSU1",22,0)
 ;    Output:  IBCBU   = pointer to Benefits Used file if added,
"RTN","IBCNSU1",23,0)
 ;                       else null
"RTN","IBCNSU1",24,0)
 ;
"RTN","IBCNSU1",25,0)
 N DIR,IBCBU
"RTN","IBCNSU1",26,0)
 S IBCBU=""
"RTN","IBCNSU1",27,0)
 I $G(IBCPOL)="" G BUQ
"RTN","IBCNSU1",28,0)
 I $G(IBYR)="" S IBYR=DT
"RTN","IBCNSU1",29,0)
 ;
"RTN","IBCNSU1",30,0)
 ;if no match display message
"RTN","IBCNSU1",31,0)
 I '$O(^IBA(355.4,"APY",IBCPOL,-IBYR,0)) W !!,"You cannot add a new Benefits Used BENEFIT YEAR",!! G BUQ
"RTN","IBCNSU1",32,0)
 ;
"RTN","IBCNSU1",33,0)
 ; -- try to find entry for policy for year
"RTN","IBCNSU1",34,0)
 S IBCBU=$O(^IBA(355.5,"APPY",DFN,IBCPOL,-IBYR,IBCDFN,0))
"RTN","IBCNSU1",35,0)
 ;
"RTN","IBCNSU1",36,0)
 ; -- if no match add new entry
"RTN","IBCNSU1",37,0)
 I 'IBCBU D
"RTN","IBCNSU1",38,0)
 .I $G(IBASK) S DIR(0)="Y",DIR("A")="Are you adding a new Benefits Used YEAR",DIR("B")="YES" D ^DIR I $D(DIRUT)!(Y<1) S VALMQUIT="" Q
"RTN","IBCNSU1",39,0)
 .S IBCBU=$$ADDBU(DFN,IBCPOL,IBYR,IBCDFN)
"RTN","IBCNSU1",40,0)
 .Q
"RTN","IBCNSU1",41,0)
 ;
"RTN","IBCNSU1",42,0)
BUQ Q IBCBU
"RTN","IBCNSU1",43,0)
 ;
"RTN","IBCNSU1",44,0)
ADDBU(DFN,IBCPOL,IBYR,IBCDFN) ; -- add entries to Benefits Used file
"RTN","IBCNSU1",45,0)
 ;     Input:  DFN     = pointer to patient file
"RTN","IBCNSU1",46,0)
 ;             IBCDFN  = point to patient policy (2.312)
"RTN","IBCNSU1",47,0)
 ;             IBCPOL  = pointer to health insurance policy file
"RTN","IBCNSU1",48,0)
 ;             IBYR    = fileman internal date, year will be calendar
"RTN","IBCNSU1",49,0)
 ;                       year of the internal date, Default = dt
"RTN","IBCNSU1",50,0)
 ;
"RTN","IBCNSU1",51,0)
 ;    Output:  IBCBU   = pointer to Benefits Used file if added,
"RTN","IBCNSU1",52,0)
 ;                       else null
"RTN","IBCNSU1",53,0)
 ;
"RTN","IBCNSU1",54,0)
 N %DT,IBN1,IBCBU,DIC,DIE,DR,DA,DLAYGO,DO,DD
"RTN","IBCNSU1",55,0)
 S IBCBU=""
"RTN","IBCNSU1",56,0)
 I $G(IBCDFN)="" G ADDBUQ
"RTN","IBCNSU1",57,0)
 I $G(IBCPOL)="" G ADDBUQ
"RTN","IBCNSU1",58,0)
 I $G(IBYR)="" S IBYR=DT
"RTN","IBCNSU1",59,0)
 K DD,DO,DIC,DR S DIC="^IBA(355.5,",DIC(0)="L",DLAYGO=355.5
"RTN","IBCNSU1",60,0)
 ;
"RTN","IBCNSU1",61,0)
 ;S IBYR=$E(IBYR,1,3)_"0000"
"RTN","IBCNSU1",62,0)
 S X=IBCPOL D FILE^DICN I +Y<0 G ADDBUQ
"RTN","IBCNSU1",63,0)
 S (IBCBU,DA)=+Y,DIE="^IBA(355.5,",DR=".02////"_DFN_";.03////"_IBYR_";.17////"_IBCDFN_";1.01///NOW;1.02////"_DUZ
"RTN","IBCNSU1",64,0)
 D ^DIE K DIC,DIE,DA,DR
"RTN","IBCNSU1",65,0)
ADDBUQ Q IBCBU
"RTN","IBCNSU1",66,0)
 ;
"RTN","IBCNSU1",67,0)
VET() ; -- Input Transform for sub-file 2.312, Name of Insured (#17)
"RTN","IBCNSU1",68,0)
 ;    Quit 1 to stuff Patient Name
"RTN","IBCNSU1",69,0)
 ;    Quit 0 to not stuff and allow editing
"RTN","IBCNSU1",70,0)
 ;
"RTN","IBCNSU1",71,0)
 N IBY,IB0 S IBY=0
"RTN","IBCNSU1",72,0)
 S IB0=$G(^DPT(+$G(DA(1)),.312,+$G(DA),0))
"RTN","IBCNSU1",73,0)
 I $P(IB0,"^",6)'="v" G VETQ
"RTN","IBCNSU1",74,0)
 I +IB0'=+$$GETWNR^IBCNSMM1 S IBY=1 G VETQ
"RTN","IBCNSU1",75,0)
 I '$D(X),$P(IB0,"^",17)="" S IBY=1
"RTN","IBCNSU1",76,0)
VETQ Q IBY
"RTN","IBCNSU1",77,0)
 ;
"RTN","IBCNSU1",78,0)
 ;
"RTN","IBCNSU1",79,0)
SUBID ; -- Input Transform for sub-file #2.312, Subscriber ID (#1)
"RTN","IBCNSU1",80,0)
 N NODE,L,R,CHAR,X1
"RTN","IBCNSU1",81,0)
 S CHAR="~`!@#$%^&*()_-+={}[]|\/?.,<>;:' """
"RTN","IBCNSU1",82,0)
 S NODE=^DPT(DA(1),.312,DA,0)
"RTN","IBCNSU1",83,0)
 ;
"RTN","IBCNSU1",84,0)
 ; - if the policy is a Medicare policy, make sure the subscriber ID
"RTN","IBCNSU1",85,0)
 ;   is a valid HICN number
"RTN","IBCNSU1",86,0)
 I $P(NODE,U)=+$$GETWNR^IBCNSMM1 S X=$TR(X,"-","") I '$$VALHIC^IBCNSMM(X) D HLP^IBCNSM32 K X Q
"RTN","IBCNSU1",87,0)
 ;
"RTN","IBCNSU1",88,0)
 S R=$P(NODE,U,16)
"RTN","IBCNSU1",89,0)
 S L=$TR($P(^DPT(DA(1),0),U,9),CHAR,"")
"RTN","IBCNSU1",90,0)
 S R=$S(R="01":1,R="":1,1:0)
"RTN","IBCNSU1",91,0)
 ;
"RTN","IBCNSU1",92,0)
 ; - if subscriber ID is the SSN of patient, remove all extraneous
"RTN","IBCNSU1",93,0)
 ;   characters
"RTN","IBCNSU1",94,0)
 S X1=$TR(X,CHAR,"") I X1?9N,X1=L S X=X1
"RTN","IBCNSU1",95,0)
 ;
"RTN","IBCNSU1",96,0)
 ; - if "SS" is entered, and the policy belongs to the patient,
"RTN","IBCNSU1",97,0)
 ;   convert that string to the patient's SSN
"RTN","IBCNSU1",98,0)
 I R=1,X="SS" W "  ",L S X=L
"RTN","IBCNSU1",99,0)
 ;
"RTN","IBCNSU1",100,0)
 K:$L(X)>20!($L(X)<3) X
"RTN","IBCNSU1",101,0)
 Q
"RTN","IBCNSU1",102,0)
 ;
"RTN","IBCNSU1",103,0)
 ;
"RTN","IBCNSU1",104,0)
HICN(DFN) ; -- return Patient's Medicare HIC number
"RTN","IBCNSU1",105,0)
 ;    Return HICN of Medicare WNR Part A or Part B
"RTN","IBCNSU1",106,0)
 ;    Return -1 if none exits
"RTN","IBCNSU1",107,0)
 ;
"RTN","IBCNSU1",108,0)
 N IBWNR,IBX,IBY,IB0
"RTN","IBCNSU1",109,0)
 S IBWNR=$$GETWNR^IBCNSMM1,IBY=""
"RTN","IBCNSU1",110,0)
 I '$O(^DPT(DFN,.312,"B",+IBWNR,0)) S IBY=-1 G HICNQ
"RTN","IBCNSU1",111,0)
 S IBX=0 F  S IBX=$O(^DPT(DFN,.312,"B",+IBWNR,IBX)) Q:('IBX)!(IBY]"")  D
"RTN","IBCNSU1",112,0)
 .S IB0=$G(^DPT(DFN,.312,IBX,0))
"RTN","IBCNSU1",113,0)
 .I $P(IB0,U,18)'=$P(IBWNR,U,3),$P(IB0,U,18)'=$P(IBWNR,U,5) Q
"RTN","IBCNSU1",114,0)
 .; 8/18/2003 - Added translation code to remove hyphens if they exist.
"RTN","IBCNSU1",115,0)
 .I $P(IB0,U,2)]"" S IBY=$TR($P(IB0,U,2),"- ","")
"RTN","IBCNSU1",116,0)
 S:IBY="" IBY=-1
"RTN","IBCNSU1",117,0)
HICNQ Q IBY
"RTN","IBJDE")
0^1^B25096430
"RTN","IBJDE",1,0)
IBJDE ;ALB/RB - DM DATA EXTRACTION (MAIN ROUTINE) ; 15-APR-99
"RTN","IBJDE",2,0)
 ;;2.0;INTEGRATED BILLING;**100,118,123,235,248,254,244**;21-MAR-94
"RTN","IBJDE",3,0)
 ;
"RTN","IBJDE",4,0)
BJ ; - Entry point from IBAMTC.
"RTN","IBJDE",5,0)
 I $D(^IBE(351.7,"DISABLE")) G ENQ ; DM extraction process disabled.
"RTN","IBJDE",6,0)
 ;
"RTN","IBJDE",7,0)
 I $E(DT,6,7)=$E($$LDATE(DT)+1,6,7) S IBDT=$E($P($$M1(DT,0),"^",1),1,5)_"00"
"RTN","IBJDE",8,0)
 I '$G(IBDT) S IBDT=$$M1(DT,1)
"RTN","IBJDE",9,0)
 I $E(IBDT,6,7)'="00" S IBDT=$E(IBDT,1,5)_"00"
"RTN","IBJDE",10,0)
 I $D(^IBE(351.71,"AC",3,IBDT)) G ENQ ; Extract done for this date.
"RTN","IBJDE",11,0)
 ;
"RTN","IBJDE",12,0)
 D NOW^%DTC S IBRD=%,IBS=$P(%H,",",2)
"RTN","IBJDE",13,0)
 I $D(^IBE(351.71,IBDT,0)) D  G ST ; Entry for this date already made.
"RTN","IBJDE",14,0)
 .S DIE="^IBE(351.71,",DR=".02////1;.03////"_IBRD,DA=IBDT D ^DIE
"RTN","IBJDE",15,0)
 .K DA,DIE,DR
"RTN","IBJDE",16,0)
 ;
"RTN","IBJDE",17,0)
 ; - Create entry in IB DM EXTRACT DATA ELEMENTS file (#351.71).
"RTN","IBJDE",18,0)
 S DIC="^IBE(351.71,",DIC(0)="L",DIC("DR")=".02////1;.03////"_IBRD
"RTN","IBJDE",19,0)
 S (DINUM,X)=IBDT K DD,DO D FILE^DICN K DIC,DINUM,DD,DO S IBDT=+Y
"RTN","IBJDE",20,0)
 ;
"RTN","IBJDE",21,0)
ST ; - Start extraction process.
"RTN","IBJDE",22,0)
 I '$$CHK(IBDT) G COMP ; If data from all reports extracted, E-mail file.
"RTN","IBJDE",23,0)
 ;
"RTN","IBJDE",24,0)
 N IBUNBILL
"RTN","IBJDE",25,0)
 I $E(DT,6,7)=$E($$LDATE(DT)+1,6,7) S IBA0=$O(^IBE(351.7,"B","UNBILLED AMOUNTS REPORT",0)) G:'IBA0 ENQ  S IBN0=^IBE(351.7,IBA0,0),IBUNBILL=1 D EXTRACT G ENQ
"RTN","IBJDE",26,0)
 S IBA0=0 F  S IBA0=$O(^IBE(351.7,IBA0)) Q:'IBA0  S IBN0=^(IBA0,0) I $P(IBN0,"^",1)'="UNBILLED AMOUNTS REPORT" S IBUNBILL=0 D EXTRACT
"RTN","IBJDE",27,0)
 G ENQ
"RTN","IBJDE",28,0)
 ;
"RTN","IBJDE",29,0)
EXTRACT I $P(IBN0,U,2) Q  ;                      Report has been disabled.
"RTN","IBJDE",30,0)
 I $D(^IBE(351.71,"AD",3,IBDT,IBA0)) Q  ; Extract of report done.
"RTN","IBJDE",31,0)
 ;
"RTN","IBJDE",32,0)
 I '$D(^IBE(351.71,IBDT,1,IBA0,0)) D  ; Create REPORT sub-file entry.
"RTN","IBJDE",33,0)
 .S DIC="^IBE(351.71,"_IBDT_",1,",DIC(0)="L",DIC("DR")=".02////1"
"RTN","IBJDE",34,0)
 .S DIC("P")="351.711P",DA(1)=IBDT,(DA,DINUM,X)=IBA0 K DD,DO
"RTN","IBJDE",35,0)
 .D FILE^DICN K DA,DIC,DINUM,DD,DO
"RTN","IBJDE",36,0)
 ;
"RTN","IBJDE",37,0)
 ; - Set input variables.
"RTN","IBJDE",38,0)
 S IBA1=0 N ZTIO,ZTDESC,ZTSK,ZTDTH,ZTRTN,ZTSAVE
"RTN","IBJDE",39,0)
 F  S IBA1=$O(^IBE(351.7,IBA0,1,IBA1)) Q:'IBA1  S IBN1=$G(^(IBA1,0)) D
"RTN","IBJDE",40,0)
 .I $D(^IBE(351.7,IBA0,1,IBA1,1)) X ^(1)
"RTN","IBJDE",41,0)
 .E  S IBV=$P(IBN1,U),@(IBV)=$P(IBN1,U,2),ZTSAVE(IBV)=""
"RTN","IBJDE",42,0)
 ;
"RTN","IBJDE",43,0)
 ; - Set other ZT* variables for queueing.
"RTN","IBJDE",44,0)
 S ZTSAVE("IBUNBILL")=""
"RTN","IBJDE",45,0)
 S ZTDESC=$P(IBN0,U),ZTSAVE("IBXTRACT")=1,ZTIO=""
"RTN","IBJDE",46,0)
 I $G(IBX) S ZTSAVE("IBXDATE")=IBDT ; Date from DME manual start option.
"RTN","IBJDE",47,0)
 S ZTRTN=$G(^IBE(351.7,IBA0,2)) Q:ZTRTN=""  I ZTRTN'["^" S ZTRTN=U_ZTRTN
"RTN","IBJDE",48,0)
 S IBS=IBS+300,%=IBS D S^%DTC S ZTDTH=$P(IBRD,".")_% ; Run in 5 mins.
"RTN","IBJDE",49,0)
 D ^%ZTLOAD
"RTN","IBJDE",50,0)
 Q
"RTN","IBJDE",51,0)
 ;
"RTN","IBJDE",52,0)
 ;
"RTN","IBJDE",53,0)
E(RI,J) ; - Change report extract status/load DM summary report data.
"RTN","IBJDE",54,0)
 ;   Input: RI=Report IEN from IB DM EXTRACT REPORTS file (#351.7).
"RTN","IBJDE",55,0)
 ;           J=1-Change status, 0=Load DM data
"RTN","IBJDE",56,0)
 S IBDT=$S($G(IBXDATE):$E(IBXDATE,1,5)_"00",'$G(IBUNBILL):$$M1(DT,1),1:$E($P($$M1(DT,0),"^",1),1,5)_"00") I 'J G E1
"RTN","IBJDE",57,0)
 ;
"RTN","IBJDE",58,0)
 I '$D(^IBE(351.71,"AC",2,IBDT)) D  ; Change extract status to STARTED.
"RTN","IBJDE",59,0)
 .D NOW^%DTC S DIE="^IBE(351.71,",DR=".02////2;.03////"_%,DA=IBDT D ^DIE
"RTN","IBJDE",60,0)
 .K DA,DIE,DR
"RTN","IBJDE",61,0)
 ;
"RTN","IBJDE",62,0)
 ; - Change report extract status to EXTRACT STARTED.
"RTN","IBJDE",63,0)
 I '$D(^IBE(351.71,"AD",2,IBDT,RI)) D
"RTN","IBJDE",64,0)
 .D NOW^%DTC S DIE="^IBE(351.71,"_IBDT_",1,",DR=".02////2;.03////"_%
"RTN","IBJDE",65,0)
 .S DA(1)=IBDT,DA=RI D ^DIE K DA,DIE,DR
"RTN","IBJDE",66,0)
 ;
"RTN","IBJDE",67,0)
 G ENQ
"RTN","IBJDE",68,0)
 ;
"RTN","IBJDE",69,0)
E1 ; - Load DM summary report data into file #351.71.
"RTN","IBJDE",70,0)
 I $G(IBUNBILL) G E2
"RTN","IBJDE",71,0)
 S IBA0=0 F  S IBA0=$O(^IBE(351.701,"C",RI,IBA0)) Q:'IBA0  D
"RTN","IBJDE",72,0)
 .S IBN0=$P($G(^IBE(351.701,IBA0,0)),U,2) Q:IBN0=""  S IBN0=@(IBN0)
"RTN","IBJDE",73,0)
 .;
"RTN","IBJDE",74,0)
 .; - Create DATA ELEMENT sub-file entry in REPORT sub-file of #351.71
"RTN","IBJDE",75,0)
 .S DIC="^IBE(351.71,"_IBDT_",1,"_RI_",1,",DIC(0)="L"
"RTN","IBJDE",76,0)
 .S DIC("DR")=".02////"_IBN0,DIC("P")="351.7111P",DA(2)=IBDT,DA(1)=RI
"RTN","IBJDE",77,0)
 .S (DA,DINUM,X)=IBA0 K DD,DO D FILE^DICN K DA,DIC,DINUM,DD,DO
"RTN","IBJDE",78,0)
 ;
"RTN","IBJDE",79,0)
 ; - Change status in REPORT sub-file of #351.71 to EXTRACT COMPLETED.
"RTN","IBJDE",80,0)
E2 D NOW^%DTC S DIE="^IBE(351.71,"_IBDT_",1,",DR=".02////3;.04////"_%
"RTN","IBJDE",81,0)
 S DA(1)=IBDT,DA=RI D ^DIE K DA,DIE,DR,IBXDATE,IBXTRACT
"RTN","IBJDE",82,0)
 ;
"RTN","IBJDE",83,0)
 ; - Check if all data from all reports have been extracted, then change
"RTN","IBJDE",84,0)
 ;   status in file #351.71 entry to EXTRACT COMPLETED.
"RTN","IBJDE",85,0)
 I $$CHK(IBDT) G ENQ ; All reports not completed yet.
"RTN","IBJDE",86,0)
 ;
"RTN","IBJDE",87,0)
COMP D NOW^%DTC
"RTN","IBJDE",88,0)
 S DIE="^IBE(351.71,",DR=".02////3;.04////"_%,DA=IBDT D ^DIE K DA,DIE,DR
"RTN","IBJDE",89,0)
 I '$P(^IBE(351.71,IBDT,0),U,5) D XM^IBJDE1(IBDT) ; Transmit extract.
"RTN","IBJDE",90,0)
 ;
"RTN","IBJDE",91,0)
ENQ I '$G(IBX) K IBDT
"RTN","IBJDE",92,0)
 K IBA0,IBA1,IBCT,IBN0,IBN1,IBRD,IBS,IBV,IBV1,X,Y,%
"RTN","IBJDE",93,0)
 Q
"RTN","IBJDE",94,0)
 ;
"RTN","IBJDE",95,0)
M1(X,Y) ; - Return first/last day of month (if Y=0), previous month (if Y=1),
"RTN","IBJDE",96,0)
 ;   first/last day of month in MMDDYYYY format (if Y=2), or date in
"RTN","IBJDE",97,0)
 ;   external format (if Y=3).
"RTN","IBJDE",98,0)
 N X1,X2 S:'$G(X)!(X'?7N.1".".6N) X=DT S:'$G(Y) Y=0
"RTN","IBJDE",99,0)
 S X2="31^"_$S($E(X,1,3)#4=0:29,1:28)_"^31^30^31^30^31^31^30^31^30^31"
"RTN","IBJDE",100,0)
 I 'Y S X=$E(X,1,5),X=X_"01"_U_X_$P(X2,U,+$E(X,4,5)) G M1Q
"RTN","IBJDE",101,0)
 I Y=1 S X=($E(X,1,5)_"00")-$S(+$E(X,4,5)=1:8900,1:100) G M1Q
"RTN","IBJDE",102,0)
 I Y=2 D  G M1Q
"RTN","IBJDE",103,0)
 .S X1=1700+$E(X,1,3),X=$E(X,4,5),X=X_"01"_X1_U_X_$P(X2,U,+X)_X1
"RTN","IBJDE",104,0)
 S Y=X X ^DD("DD") S X=Y
"RTN","IBJDE",105,0)
M1Q Q X
"RTN","IBJDE",106,0)
 ;
"RTN","IBJDE",107,0)
M2(X,Y,Z,R) ; - Return specific date range.
"RTN","IBJDE",108,0)
 ; Input: X=Date in Fileman format
"RTN","IBJDE",109,0)
 ;        Y=Number of months back from X
"RTN","IBJDE",110,0)
 ;        Z=Number of months ahead from date created via Y
"RTN","IBJDE",111,0)
 ;        R=0-Date range in Fileman format, 1-In MMDDYYYY format 
"RTN","IBJDE",112,0)
 N X1,X2
"RTN","IBJDE",113,0)
 S:'$G(X) X=DT S:'$G(Y) Y=1 S:'$G(Z) Z=1 S:'$G(R) R=0 I X'?7N S X=DT
"RTN","IBJDE",114,0)
 S X=$E(X,1,5)
"RTN","IBJDE",115,0)
 S X1="31^"_$S($E(X,1,3)#4=0:29,1:28)_"^31^30^31^30^31^31^30^31^30^31"
"RTN","IBJDE",116,0)
 F X2=1:1:Y S X=X-$S(+$E(X,4,5)=1:89,1:1) I X2=Y S X3=X_"01"
"RTN","IBJDE",117,0)
 F X2=1:1:Z S X=X+$S(+$E(X,4,5)=12:89,1:1)
"RTN","IBJDE",118,0)
 S X=X3_U_X_$P(X1,U,+$E(X,4,5)) I 'R G M2Q
"RTN","IBJDE",119,0)
 S X1=1700+$E(X,1,3),X2=1700+$E(X,9,11),X=$E(X,4,7)_X1_U_$E(X,12,15)_X2
"RTN","IBJDE",120,0)
M2Q Q X
"RTN","IBJDE",121,0)
 ;
"RTN","IBJDE",122,0)
M3(X) ;Beginning date 365 days prior
"RTN","IBJDE",123,0)
 N X1,X2
"RTN","IBJDE",124,0)
 S X1=X,X2=-365 D C^%DTC
"RTN","IBJDE",125,0)
 Q X
"RTN","IBJDE",126,0)
CHK(X) ; - Check if all extract reports have completed.
"RTN","IBJDE",127,0)
 ;    Input: X=Date IEN of entry in file #351.71
"RTN","IBJDE",128,0)
 ;   Output: Y=0-Completed, 1-Not completed
"RTN","IBJDE",129,0)
 N X1,X2,X3 S (X1,X2,X3,Y)=0
"RTN","IBJDE",130,0)
 F  S X1=$O(^IBE(351.7,X1)) Q:'X1  I '$P(^(X1,0),U,2) S X2=X2+1
"RTN","IBJDE",131,0)
 S X1=0 F  S X1=$O(^IBE(351.71,"AD",3,X,X1)) Q:'X1  S X3=X3+1
"RTN","IBJDE",132,0)
 I X2'=X3 S Y=1
"RTN","IBJDE",133,0)
 Q Y
"RTN","IBJDE",134,0)
LDATE(X) ; DETERMINE CUT-OFF DATE FOR THE MONTH
"RTN","IBJDE",135,0)
 S X=$E(X,1,5)_$P("31^28^31^30^31^30^31^31^30^31^30^31","^",+$E(X,4,5))
"RTN","IBJDE",136,0)
 I +$E(X,6,7)=28,$E(X,2,3)#4=0 S $E(X,6,7)=29
"RTN","IBJDE",137,0)
 S X=$$WORKPLUS^XUWORKDY(X,-3)
"RTN","IBJDE",138,0)
 Q X
"RTN","IBJDE1")
0^2^B74507836
"RTN","IBJDE1",1,0)
IBJDE1 ;ALB/RB - DM DATA EXTRACTION (MENU OPTIONS/TRANSMIT E-MAIL) ;15-APR-99
"RTN","IBJDE1",2,0)
 ;;2.0;INTEGRATED BILLING;**100,118,123,159,254,244**;21-MAR-94
"RTN","IBJDE1",3,0)
 ;
"RTN","IBJDE1",4,0)
VPE ; - View/print entries in IB DM EXTRACT DATA file (#351.71).
"RTN","IBJDE1",5,0)
 I '$O(^IBE(351.71,0)) W !!,"There are no entries available.",*7 G ENQ
"RTN","IBJDE1",6,0)
 ;
"RTN","IBJDE1",7,0)
 S DIC="^IBE(351.71,",DIC(0)="AEMQZ",DIC("A")="Enter MONTH/YEAR: "
"RTN","IBJDE1",8,0)
 D ^DIC K DIC G:Y'>0 ENQ S IB0=+Y,IBS=$P(Y(0),U,2),IBDT=Y(0,0)
"RTN","IBJDE1",9,0)
 ;
"RTN","IBJDE1",10,0)
 S DIC="^IBE(351.71,",BY=.01,(FR,TO)=IB0,DHD="W ?0 D VPH^IBJDE1"
"RTN","IBJDE1",11,0)
 S FLDS="[IBJD DM V/P EXTRACTS]",L=0 D EN1^DIP W ! G VPE
"RTN","IBJDE1",12,0)
 ;
"RTN","IBJDE1",13,0)
VPH ; - Heading for View/Print option.
"RTN","IBJDE1",14,0)
 W "DIAGNOSTIC MEASURES SUMMARY EXTRACTIONS-",IBDT
"RTN","IBJDE1",15,0)
 W " (Status: ",$S(IBS=3:"COMPLETED",IBS=2:"STARTED",1:"ON STANDBY"),")"
"RTN","IBJDE1",16,0)
 W !!,"Summary Line Item",?58,"Total",! F X=1:1:80 W "-"
"RTN","IBJDE1",17,0)
 Q
"RTN","IBJDE1",18,0)
 ;
"RTN","IBJDE1",19,0)
DER ; - Disable/enable report(s) or extraction process.
"RTN","IBJDE1",20,0)
 W ! S DIR(0)="Y",DIR("B")="NO"
"RTN","IBJDE1",21,0)
 I $D(^IBE(351.7,"DISABLE")) D
"RTN","IBJDE1",22,0)
 .S DIR("A",1)="The DM extract background job has been disabled."
"RTN","IBJDE1",23,0)
 .S DIR("A")=" Do you want to re-enable it"
"RTN","IBJDE1",24,0)
 E  S DIR("A")="Do you want to disable the DM extract background job"
"RTN","IBJDE1",25,0)
 D ^DIR K DIR G:Y["^" ENQ I 'Y G DE1
"RTN","IBJDE1",26,0)
 I $D(^IBE(351.7,"DISABLE")) K ^("DISABLE")
"RTN","IBJDE1",27,0)
 E  S ^IBE(351.7,"DISABLE")=""
"RTN","IBJDE1",28,0)
 W " ...Done",*7
"RTN","IBJDE1",29,0)
 ;
"RTN","IBJDE1",30,0)
DE1 ; - List disabled reports, if any.
"RTN","IBJDE1",31,0)
 I $D(^IBE(351.7,"DISABLE")) G ENQ ; DM extract background job disabled.
"RTN","IBJDE1",32,0)
 ;
"RTN","IBJDE1",33,0)
 I $D(^IBE(351.7,"AC",1)) D
"RTN","IBJDE1",34,0)
 .W !!,"These DM reports have been disabled:",!! S X=0
"RTN","IBJDE1",35,0)
 .F  S X=$O(^IBE(351.7,"AC",1,X)) Q:'X  W ?3,$P($G(^IBE(351.7,X,0)),U),!
"RTN","IBJDE1",36,0)
 E  W !!,"There are no disabled DM reports.",!
"RTN","IBJDE1",37,0)
 ;
"RTN","IBJDE1",38,0)
DE2 S DIR(0)="PO^351.7:AEMQZ",DIR("A")="Enter REPORT NAME"
"RTN","IBJDE1",39,0)
 S DIR("?")="^D DEH^IBJDE1" D ^DIR K DIR I Y'>0 G ENQ
"RTN","IBJDE1",40,0)
 S IB0=+Y,IBFL=$P(Y(0),U,2) W !!,Y(0,0),!
"RTN","IBJDE1",41,0)
 ;
"RTN","IBJDE1",42,0)
 S DIR("A")="Do you want to "_$S(IBFL:"re-en",1:"dis")_"able this report"
"RTN","IBJDE1",43,0)
 S DIR(0)="Y",DIR("B")="NO" D ^DIR K DIR I Y["^"!('Y) W ! G DE2
"RTN","IBJDE1",44,0)
 S DIE="^IBE(351.7,",DR=".02///"_$S('IBFL&(Y):1,1:"@"),DA=IB0
"RTN","IBJDE1",45,0)
 D ^DIE K DA,DIE,DR W " ...Done",*7 G DE1
"RTN","IBJDE1",46,0)
 ;
"RTN","IBJDE1",47,0)
DEH ; - Help message for disable/enable option.
"RTN","IBJDE1",48,0)
 W !,"Enter the name of the report you want disabled or re-enabled."
"RTN","IBJDE1",49,0)
 W !,"If the report you enter is disabled, the monthly DM extraction"
"RTN","IBJDE1",50,0)
 W !,"process will not collect summary data from the report until you"
"RTN","IBJDE1",51,0)
 W !,"re-enable it again."
"RTN","IBJDE1",52,0)
 Q
"RTN","IBJDE1",53,0)
 ;
"RTN","IBJDE1",54,0)
RTN ; - Help message for the field ROUTINE (entry point for the reprot)
"RTN","IBJDE1",55,0)
 W !?9,"Enter the entry point for this report. You may enter  a  program"
"RTN","IBJDE1",56,0)
 W !?9,"name (^ROUTINE), or a specific label of a  program (TAG^ROUTINE)"
"RTN","IBJDE1",57,0)
 W !?9,"or you may also leave it blank.",!
"RTN","IBJDE1",58,0)
 W !?9,"Obs: If this field is left blank, it means that the code respon-"
"RTN","IBJDE1",59,0)
 W !?9,"     sible for extracting the data will be  invoked  by  another"
"RTN","IBJDE1",60,0)
 W !?9,"     report.",!
"RTN","IBJDE1",61,0)
 Q
"RTN","IBJDE1",62,0)
 ;
"RTN","IBJDE1",63,0)
MAN1 ; - Manually start DM extraction process.
"RTN","IBJDE1",64,0)
 I $D(^IBE(351.7,"DISABLE")) D  G ENQ
"RTN","IBJDE1",65,0)
 .W !!,"The DM extract process has been disabled.",!,*7
"RTN","IBJDE1",66,0)
 S (IBX,X)=0
"RTN","IBJDE1",67,0)
 F  S X=$O(^IBE(351.71,X)) Q:'X  I $P(^(X,0),U,2)'=3 S IBX=IBX+1
"RTN","IBJDE1",68,0)
 I 'IBX W !,"All DM extracts on file have been transmitted.",!,*7 G ENQ
"RTN","IBJDE1",69,0)
 ;
"RTN","IBJDE1",70,0)
M1A S DIC="^IBE(351.71,",DIC(0)="AEMQZ",DIC("A")="Enter DM extract date: "
"RTN","IBJDE1",71,0)
 S DIC("S")="I $P(^(0),U,2)'=3" W ! D ^DIC K DIC I Y'>0 G ENQ
"RTN","IBJDE1",72,0)
 S IBDT=+Y,IBN=Y(0),IBDT1=$$M1^IBJDE(IBDT,3),IBST=$P(IBN,U,2)
"RTN","IBJDE1",73,0)
 S DIR("A")="Do you want to start the DM extract process for "_IBDT1
"RTN","IBJDE1",74,0)
 S DIR(0)="Y",DIR("B")="NO" D ^DIR K DIR I 'Y G ENQ
"RTN","IBJDE1",75,0)
 I IBST=2 D  G:'Y ENQ
"RTN","IBJDE1",76,0)
 .S DIR(0)="Y",DIR("B")="NO",IBS=$$M1^IBJDE($P(IBN,U,3),3)
"RTN","IBJDE1",77,0)
 .S DIR("A",1)="The extract process for "_IBDT1_" began on "_IBS_"."
"RTN","IBJDE1",78,0)
 .S DIR("A")="Do you want to restart it" W ! D ^DIR K DIR
"RTN","IBJDE1",79,0)
 ;
"RTN","IBJDE1",80,0)
 D BJ^IBJDE ; Start DM extraction background job.
"RTN","IBJDE1",81,0)
 S IBS=$$M1^IBJDE($P($G(^IBE(351.71,IBDT,0)),U,3),3)
"RTN","IBJDE1",82,0)
 W !!,"Extract process started on ",IBS,".",*7 S IBX=IBX-1
"RTN","IBJDE1",83,0)
 I IBX D  G:Y M1A
"RTN","IBJDE1",84,0)
 .S DIR("A")="Do you want to start the process for another date"
"RTN","IBJDE1",85,0)
 .S DIR(0)="Y",DIR("B")="NO" D ^DIR K DIR
"RTN","IBJDE1",86,0)
 ;
"RTN","IBJDE1",87,0)
 G ENQ
"RTN","IBJDE1",88,0)
 ;
"RTN","IBJDE1",89,0)
MAN2 ; - Manually transmit DM extract file.
"RTN","IBJDE1",90,0)
 I $D(^IBE(351.7,"DISABLE")) D  G ENQ
"RTN","IBJDE1",91,0)
 .W !!,"The DM extract process has been disabled.",!,*7
"RTN","IBJDE1",92,0)
 S (IBX,X)=0
"RTN","IBJDE1",93,0)
 F  S X=$O(^IBE(351.71,X)) Q:'X  I $P(^(X,0),U,2)=3 S IBX=IBX+1
"RTN","IBJDE1",94,0)
 I 'IBX D  G ENQ
"RTN","IBJDE1",95,0)
 .W !,"All DM extracts on file have NOT been completed.",!,*7
"RTN","IBJDE1",96,0)
 ;
"RTN","IBJDE1",97,0)
M2A S DIC="^IBE(351.71,",DIC(0)="AEMQZ",DIC("A")="Enter DM extract date: "
"RTN","IBJDE1",98,0)
 S DIC("S")="I $P(^(0),U,2)=3" W ! D ^DIC K DIC I Y'>0 G ENQ
"RTN","IBJDE1",99,0)
 S IBDT=+Y,IBN=Y(0),DIR(0)="Y",DIR("B")="NO"
"RTN","IBJDE1",100,0)
 S DIR("A")="Are you sure you want to transmit for "_$$M1^IBJDE(IBDT,3)
"RTN","IBJDE1",101,0)
 D ^DIR K DIR I 'Y G M2A
"RTN","IBJDE1",102,0)
M2B S $P(^IBE(351.71,IBDT,0),U,5)="" D XM(IBDT)
"RTN","IBJDE1",103,0)
 I $G(XMZ) W " Done."
"RTN","IBJDE1",104,0)
 E  D  G:Y M2B
"RTN","IBJDE1",105,0)
 .S DIR(0)="Y",DIR("B")="NO"
"RTN","IBJDE1",106,0)
 .S DIR("A")="The DM extract message failed to transmit...try again"
"RTN","IBJDE1",107,0)
 .W !,*7 D ^DIR K DIR
"RTN","IBJDE1",108,0)
 ;
"RTN","IBJDE1",109,0)
 I IBX D  G:Y M2A
"RTN","IBJDE1",110,0)
 .S DIR("A")="Do you want to start the process for another date"
"RTN","IBJDE1",111,0)
 .S DIR(0)="Y",DIR("B")="NO" D ^DIR K DIR I Y S IBX=IBX-1
"RTN","IBJDE1",112,0)
 ;
"RTN","IBJDE1",113,0)
 G ENQ
"RTN","IBJDE1",114,0)
 ;
"RTN","IBJDE1",115,0)
MSG ; - DM extract reports message (shown when DM Menu is called up).
"RTN","IBJDE1",116,0)
 S IBDT=$$M1^IBJDE(DT,1),IBDT1=$$M1^IBJDE(IBDT,3)
"RTN","IBJDE1",117,0)
 I '$D(^IBE(351.71,IBDT,0)) G ENQ ; No extract data for this month yet.
"RTN","IBJDE1",118,0)
 ;
"RTN","IBJDE1",119,0)
 W @IOF S IBN=$G(^IBE(351.71,IBDT,0)),IBST=$P(IBN,U,2) I 'IBST G ENQ
"RTN","IBJDE1",120,0)
 I IBST=1 D  G MSQ
"RTN","IBJDE1",121,0)
 .W !,"The DM extract process for ",IBDT1," was initiated on "
"RTN","IBJDE1",122,0)
 .W $$M1^IBJDE($P(IBN,U,3),3),!,"but it hasn't run yet.",!
"RTN","IBJDE1",123,0)
 ;
"RTN","IBJDE1",124,0)
 I IBST=3 D  G ENQ
"RTN","IBJDE1",125,0)
 .W !,"The DM report data for ",IBDT1," has been successfully"
"RTN","IBJDE1",126,0)
 .W !,"extracted on ",$$M1^IBJDE($P(IBN,U,4),3),". This data has been"
"RTN","IBJDE1",127,0)
 .W !,"sent to the Central Collections mail group in FORUM.",*7
"RTN","IBJDE1",128,0)
 ;
"RTN","IBJDE1",129,0)
 S DIC="^IBE(351.71,",BY="[IBJD DM REPT SORT]",FR=IBDT_",1",TO=IBDT_",2"
"RTN","IBJDE1",130,0)
 S DIOEND="I $Y'<(IOSL-14) R X:DTIME",(IOP,L)=0
"RTN","IBJDE1",131,0)
 S DHD="W ?0 D MSH^IBJDE1",FLDS="[IBJD DM REPT PRINT]" D EN1^DIP
"RTN","IBJDE1",132,0)
 ;
"RTN","IBJDE1",133,0)
MSQ W !,"If you want, you can restart the DM extract process"
"RTN","IBJDE1",134,0)
 W !,"by using the ""Manually Start DM Extraction"" option in"
"RTN","IBJDE1",135,0)
 W !,"the Diagnostic Measures Extract Menu."
"RTN","IBJDE1",136,0)
 G ENQ
"RTN","IBJDE1",137,0)
 ;
"RTN","IBJDE1",138,0)
MSH ; - DM extract reports message header.
"RTN","IBJDE1",139,0)
 W !,"Data for the following DM reports have not been extracted"
"RTN","IBJDE1",140,0)
 W !," for ",IBDT1,":",!!,*7
"RTN","IBJDE1",141,0)
 Q
"RTN","IBJDE1",142,0)
 ;
"RTN","IBJDE1",143,0)
CHK ; - Check file #351.71 for completed and/or transmitted DM extracts
"RTN","IBJDE1",144,0)
 ;   (shown when DM Extract Menu is called up).
"RTN","IBJDE1",145,0)
 W @IOF,!,"Checking for completed and/or transmitted DM extracts"
"RTN","IBJDE1",146,0)
 K IBX,IBX1 S (IBX,IBX1,IB0)=0
"RTN","IBJDE1",147,0)
 S DT=$$DT^XLFDT
"RTN","IBJDE1",148,0)
 F  S IB0=$O(^IBE(351.71,IB0)) Q:'IB0  S IBN=$G(^(IB0,0)) D
"RTN","IBJDE1",149,0)
 .; - Do not process for invalid (day not equal 00 or future) dates
"RTN","IBJDE1",150,0)
 .;   and remove data.
"RTN","IBJDE1",151,0)
 .I (+$E(IB0,6,7)>0)!(IB0>DT) D  Q
"RTN","IBJDE1",152,0)
 ..W !,"** Invalid date entry found.  Entry ("_IB0_") deleted.**",!
"RTN","IBJDE1",153,0)
 ..S DIK="^IBE(351.71,",DA=IB0
"RTN","IBJDE1",154,0)
 ..D ^DIK
"RTN","IBJDE1",155,0)
 .; - Check for missing zero node.
"RTN","IBJDE1",156,0)
 .I IBN="" W !,"Zero node data missing for "_IB0_" entry.  Data corruption possible.",! Q
"RTN","IBJDE1",157,0)
 .; - Check for past months missing from file, if any.
"RTN","IBJDE1",158,0)
 .I $O(^IBE(351.71,IB0)) D
"RTN","IBJDE1",159,0)
 ..S IB1=$P(^IBE(351.71,0),U,4),IB2=IB0+$S($E(IB0,4,5)=12:8900,1:100)
"RTN","IBJDE1",160,0)
 ..I $D(^IBE(351.71,"B",IB2,IB2))!(IB2>DT) Q
"RTN","IBJDE1",161,0)
 ..S DIC="^IBE(351.71,",DIC(0)="L",DIC("DR")=".02///1",(DINUM,X)=IB2
"RTN","IBJDE1",162,0)
 ..K DD,DO D FILE^DICN S $P(^IBE(351.71,0),U,4)=IB1+1 K DIC,DINUM,DD,DO
"RTN","IBJDE1",163,0)
 .;
"RTN","IBJDE1",164,0)
 .I $P(IBN,U,2)'=3 S IBX(IB0)="" S:'IBX IBX=1 Q
"RTN","IBJDE1",165,0)
 .E  I '$P(IBN,U,5) S IBX1(IB0)="" S:'IBX1 IBX1=1 Q
"RTN","IBJDE1",166,0)
 .W "."
"RTN","IBJDE1",167,0)
 ;
"RTN","IBJDE1",168,0)
 I 'IBX,'IBX1 W "Done" G ENQ
"RTN","IBJDE1",169,0)
 I IBX D
"RTN","IBJDE1",170,0)
 .W !!,"DM data has NOT been fully extracted for these months:",!,*7
"RTN","IBJDE1",171,0)
 .S IB0=0 F  S IB0=$O(IBX(IB0)) Q:'IB0  W "  ",$$M1^IBJDE(IB0,3)
"RTN","IBJDE1",172,0)
 .W !,"If you want, you can start the DM extract process for these"
"RTN","IBJDE1",173,0)
 .W !,"months by using the ""Manually Start DM Extraction"" option."
"RTN","IBJDE1",174,0)
 ;
"RTN","IBJDE1",175,0)
 I IBX1 D
"RTN","IBJDE1",176,0)
 .W !!,"DM data has NOT been transmitted for these months:",!,*7
"RTN","IBJDE1",177,0)
 .S IB0=0 F  S IB0=$O(IBX1(IB0)) Q:'IB0  W "  ",$$M1^IBJDE(IB0,3)
"RTN","IBJDE1",178,0)
 .W !,"If you want, you can transmit the DM extract data for these"
"RTN","IBJDE1",179,0)
 .W !,"months by using the ""Manually Transmit DM Extract"" option."
"RTN","IBJDE1",180,0)
 ;
"RTN","IBJDE1",181,0)
 G ENQ
"RTN","IBJDE1",182,0)
 ;
"RTN","IBJDE1",183,0)
XM(IBDT) ; - Create/transmit DM extract file message.
"RTN","IBJDE1",184,0)
 ;
"RTN","IBJDE1",185,0)
 N DA,DIE,DR,IB0,IB1,IBC,IBDT1,IBMG,IBSTE,X,XMDUZ,XMSUB,XMTEXT
"RTN","IBJDE1",186,0)
 ;
"RTN","IBJDE1",187,0)
 K ^TMP("DME",$J) S IBSTE=$$SITE^VASITE,X=$E(DT,4,7)_(1700+$E(DT,1,3))
"RTN","IBJDE1",188,0)
 S ^TMP("DME",$J,1)="HDR^"_$P(IBSTE,U,3)_U_$P(IBSTE,U,2)_U_X
"RTN","IBJDE1",189,0)
 S IBC=1,IB0=0
"RTN","IBJDE1",190,0)
 F  S IB0=$O(^IBE(351.71,IBDT,1,IB0)) Q:'IB0  D
"RTN","IBJDE1",191,0)
 .Q:IB0=37  ; No unbilled report needed
"RTN","IBJDE1",192,0)
 .S X=$S(IB0=8:$$M2^IBJDE(IBDT,5,3,1),1:$$M1^IBJDE(IBDT,2))
"RTN","IBJDE1",193,0)
 .S IBC=IBC+1,^TMP("DME",$J,IBC)="DAT~"_IB0_"~"_$P(X,U)_"~"_$P(X,U,2)
"RTN","IBJDE1",194,0)
 .S IB1=0 F  S IB1=$O(^IBE(351.71,IBDT,1,IB0,1,IB1)) Q:'IB1  D
"RTN","IBJDE1",195,0)
 ..S X=$P($G(^IBE(351.71,IBDT,1,IB0,1,IB1,0)),U,2)
"RTN","IBJDE1",196,0)
 ..S ^TMP("DME",$J,IBC)=^TMP("DME",$J,IBC)_U_X
"RTN","IBJDE1",197,0)
 ;
"RTN","IBJDE1",198,0)
 S ^TMP("DME",$J,IBC+1)="END^"_$P(IBSTE,U,3),IBDT1=$$M1^IBJDE(IBDT,3)
"RTN","IBJDE1",199,0)
 S XMSUB="DIAG. MEASURES EXTRACT FILE-"_IBDT1_" ("_$P(IBSTE,U,2)_")"
"RTN","IBJDE1",200,0)
 ;
"RTN","IBJDE1",201,0)
 S IBMG=$P($G(^IBE(350.9,1,4)),U,5) I IBMG="" G ENQ:'$G(IBX),ENQ1
"RTN","IBJDE1",202,0)
 ;
"RTN","IBJDE1",203,0)
 S XMDUZ="INTEGRATED BILLING PACKAGE"
"RTN","IBJDE1",204,0)
 S XMTEXT="^TMP(""DME"",$J,",XMY(IBMG)=""
"RTN","IBJDE1",205,0)
 D SEND
"RTN","IBJDE1",206,0)
 I $G(XMZ) S DIE="^IBE(351.71,",DA=IBDT,DR=".05///1;.06///"_XMZ D ^DIE
"RTN","IBJDE1",207,0)
 ;
"RTN","IBJDE1",208,0)
 I $G(IBX) G ENQ1 ; Return to DME manual transmit option.
"RTN","IBJDE1",209,0)
 ;
"RTN","IBJDE1",210,0)
ENQ K IB2,IBDT2,IBD1,IBD2,IBDT,IBFL,IBFR,IBN,IBS,IBST,IBST1,IBX,IBX1,BY,DHD
"RTN","IBJDE1",211,0)
 K DIC,DIOEND,FLDS,FR,IOP,L,TO,X,XMZ,Y,%
"RTN","IBJDE1",212,0)
ENQ1 K IB0,IB1,IBC,IBDT1,IBMG,IBSTE,XMSUB,XMTEXT,XMY,^TMP("DME",$J)
"RTN","IBJDE1",213,0)
 Q
"RTN","IBJDE1",214,0)
 ;
"RTN","IBJDE1",215,0)
SEND ; Calls ^XMD to send the mail message with the data extracted
"RTN","IBJDE1",216,0)
 ; Obs: By NEWing DUZ, ^XMD will assume DUZ=.5 (Sender=POSTMASTER)
"RTN","IBJDE1",217,0)
 ;
"RTN","IBJDE1",218,0)
 N DUZ D ^XMD
"RTN","IBJDE1",219,0)
 Q
"VER")
8.0^22
"^DD",351.71,351.71,.01,0)
MONTH/YEAR^DX^^0;1^S %DT="E,M",%DT(0)="-NOW" D ^%DT K %DT(0) S X=Y K:Y<1!($E(Y,6,7)'="00") X I $D(X) S DINUM=X
"^DD",351.71,351.71,.01,1,0)
^.1
"^DD",351.71,351.71,.01,1,1,0)
351.71^B
"^DD",351.71,351.71,.01,1,1,1)
S ^IBE(351.71,"B",$E(X,1,30),DA)=""
"^DD",351.71,351.71,.01,1,1,2)
K ^IBE(351.71,"B",$E(X,1,30),DA)
"^DD",351.71,351.71,.01,3)
Enter the month/year corresponding to the extracted data.  Future dates are not allowed.
"^DD",351.71,351.71,.01,21,0)
^^1^1^2990518^^^^
"^DD",351.71,351.71,.01,21,1,0)
This is the month/year corresponding to the extracted data.
"^DD",351.71,351.71,.01,"DT")
3031210
**END**
**END**
