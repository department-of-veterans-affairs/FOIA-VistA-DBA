Released SD*5.3*347 SEQ #346
Extracted from mail message
**KIDS**:SD*5.3*347^

**INSTALL NAME**
SD*5.3*347
"BLD",5667,0)
SD*5.3*347^SCHEDULING^0^3050401^y
"BLD",5667,1,0)
^^4^4^3040728^
"BLD",5667,1,1,0)
Encapsulated APIs
"BLD",5667,1,2,0)
SDAPI - 2 New Fields Added
"BLD",5667,1,3,0)
NEXTAPPT / GETAPPT / PATAPPT / GETPLIST - Modified to call SDAPI instead 
"BLD",5667,1,4,0)
of direct calls to the Global.
"BLD",5667,4,0)
^9.64PA^^
"BLD",5667,"ABPKG")
n
"BLD",5667,"INID")
n^n^n
"BLD",5667,"KRN",0)
^9.67PA^8989.52^19
"BLD",5667,"KRN",.4,0)
.4
"BLD",5667,"KRN",.401,0)
.401
"BLD",5667,"KRN",.402,0)
.402
"BLD",5667,"KRN",.403,0)
.403
"BLD",5667,"KRN",.5,0)
.5
"BLD",5667,"KRN",.84,0)
.84
"BLD",5667,"KRN",3.6,0)
3.6
"BLD",5667,"KRN",3.8,0)
3.8
"BLD",5667,"KRN",9.2,0)
9.2
"BLD",5667,"KRN",9.8,0)
9.8
"BLD",5667,"KRN",9.8,"NM",0)
^9.68A^12^12
"BLD",5667,"KRN",9.8,"NM",1,0)
SDAMA200^^0^B35340914
"BLD",5667,"KRN",9.8,"NM",2,0)
SDAMA201^^0^B32514859
"BLD",5667,"KRN",9.8,"NM",3,0)
SDAMA202^^0^B19318464
"BLD",5667,"KRN",9.8,"NM",4,0)
SDAMA204^^0^B3244715
"BLD",5667,"KRN",9.8,"NM",5,0)
SDAMA205^^0^B15164247
"BLD",5667,"KRN",9.8,"NM",6,0)
SDAMA300^^0^B42283370
"BLD",5667,"KRN",9.8,"NM",7,0)
SDAMA301^^0^B3523610
"BLD",5667,"KRN",9.8,"NM",8,0)
SDAMA302^^0^B24026521
"BLD",5667,"KRN",9.8,"NM",9,0)
SDAMA303^^0^B22767510
"BLD",5667,"KRN",9.8,"NM",10,0)
SDAMA304^^0^B8330866
"BLD",5667,"KRN",9.8,"NM",11,0)
SDAMA305^^0^B43200965
"BLD",5667,"KRN",9.8,"NM",12,0)
SDAMA306^^0^B7276418
"BLD",5667,"KRN",9.8,"NM","B","SDAMA200",1)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA201",2)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA202",3)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA204",4)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA205",5)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA300",6)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA301",7)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA302",8)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA303",9)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA304",10)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA305",11)

"BLD",5667,"KRN",9.8,"NM","B","SDAMA306",12)

"BLD",5667,"KRN",19,0)
19
"BLD",5667,"KRN",19.1,0)
19.1
"BLD",5667,"KRN",101,0)
101
"BLD",5667,"KRN",409.61,0)
409.61
"BLD",5667,"KRN",771,0)
771
"BLD",5667,"KRN",870,0)
870
"BLD",5667,"KRN",8989.51,0)
8989.51
"BLD",5667,"KRN",8989.52,0)
8989.52
"BLD",5667,"KRN",8994,0)
8994
"BLD",5667,"KRN","B",.4,.4)

"BLD",5667,"KRN","B",.401,.401)

"BLD",5667,"KRN","B",.402,.402)

"BLD",5667,"KRN","B",.403,.403)

"BLD",5667,"KRN","B",.5,.5)

"BLD",5667,"KRN","B",.84,.84)

"BLD",5667,"KRN","B",3.6,3.6)

"BLD",5667,"KRN","B",3.8,3.8)

"BLD",5667,"KRN","B",9.2,9.2)

"BLD",5667,"KRN","B",9.8,9.8)

"BLD",5667,"KRN","B",19,19)

"BLD",5667,"KRN","B",19.1,19.1)

"BLD",5667,"KRN","B",101,101)

"BLD",5667,"KRN","B",409.61,409.61)

"BLD",5667,"KRN","B",771,771)

"BLD",5667,"KRN","B",870,870)

"BLD",5667,"KRN","B",8989.51,8989.51)

"BLD",5667,"KRN","B",8989.52,8989.52)

"BLD",5667,"KRN","B",8994,8994)

"BLD",5667,"QUES",0)
^9.62^^
"BLD",5667,"REQB",0)
^9.611^4^4
"BLD",5667,"REQB",1,0)
SD*5.3*283^2
"BLD",5667,"REQB",2,0)
SD*5.3*301^2
"BLD",5667,"REQB",3,0)
SD*5.3*310^2
"BLD",5667,"REQB",4,0)
SD*5.3*316^2
"BLD",5667,"REQB","B","SD*5.3*283",1)

"BLD",5667,"REQB","B","SD*5.3*301",2)

"BLD",5667,"REQB","B","SD*5.3*310",3)

"BLD",5667,"REQB","B","SD*5.3*316",4)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813^2930930
"PKG",16,22,1,"PAH",1,0)
347^3050401^520640572
"PKG",16,22,1,"PAH",1,1,0)
^^4^4^3050401
"PKG",16,22,1,"PAH",1,1,1,0)
Encapsulated APIs
"PKG",16,22,1,"PAH",1,1,2,0)
SDAPI - 2 New Fields Added
"PKG",16,22,1,"PAH",1,1,3,0)
NEXTAPPT / GETAPPT / PATAPPT / GETPLIST - Modified to call SDAPI instead 
"PKG",16,22,1,"PAH",1,1,4,0)
of direct calls to the Global.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","SDAMA200")
0^1^B35340914
"RTN","SDAMA200",1,0)
SDAMA200 ;BPOIFO/ACS-Scheduling Replacement API Errors and Validation ; 12/13/04 3:13pm
"RTN","SDAMA200",2,0)
 ;;5.3;Scheduling;**253,275,310,283,347**;13 Aug 1993
"RTN","SDAMA200",3,0)
 ;
"RTN","SDAMA200",4,0)
 ;*******************************************************************
"RTN","SDAMA200",5,0)
 ;              CHANGE LOG
"RTN","SDAMA200",6,0)
 ;
"RTN","SDAMA200",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA200",8,0)
 ;--------  ----------    -------------------------------------
"RTN","SDAMA200",9,0)
 ;09/20/02  SD*5.3*253    ROUTINE COMPLETED
"RTN","SDAMA200",10,0)
 ;12/10/02  SD*5.3*275    ADDED PATIENT STATUS FILTER AND VALIDATION
"RTN","SDAMA200",11,0)
 ;08/15/03  SD*5.3*310    ADD ERROR 114
"RTN","SDAMA200",12,0)
 ;08/19/03  SD*5.3*283    ADDED 'NT' APPT STATUS  MULTIPLE APPT STATUS
"RTN","SDAMA200",13,0)
 ;                        VALUES ALLOWED, NULL FIELD LIST ALLOWED.  
"RTN","SDAMA200",14,0)
 ;                        REMOVED ERROR CODE 107.
"RTN","SDAMA200",15,0)
 ;07/26/04  SD*5.3*347    NEW VARIABLES USED IN ^%DTC CALL.
"RTN","SDAMA200",16,0)
 ;                        ALLOW FOR APPOINTMENT STATUSES R,NT OR
"RTN","SDAMA200",17,0)
 ;                        R AND NT TO BE PASSED IF THE PATIENT STATUS
"RTN","SDAMA200",18,0)
 ;                        IS SET TO O.
"RTN","SDAMA200",19,0)
 ;
"RTN","SDAMA200",20,0)
 ;*******************************************************************
"RTN","SDAMA200",21,0)
 ;-------------------------------------------------------------------
"RTN","SDAMA200",22,0)
 ;             *** VALIDATE INPUT PARAMETERS ***
"RTN","SDAMA200",23,0)
 ;INPUT
"RTN","SDAMA200",24,0)
 ;  SDIEN         Patient, clinic, or facility IEN (required)
"RTN","SDAMA200",25,0)
 ;  SDFIELDS      Fields requested (optional)
"RTN","SDAMA200",26,0)
 ;  SDAPSTAT      Appointment status (optional)
"RTN","SDAMA200",27,0)
 ;  SDSTART       Start date (optional)
"RTN","SDAMA200",28,0)
 ;  SDEND         End date (optional)
"RTN","SDAMA200",29,0)
 ;  SDAPINAM      The API that is calling this routine (required)
"RTN","SDAMA200",30,0)
 ;  SDRTNNAM      The routine that is calling this routine (required)
"RTN","SDAMA200",31,0)
 ;  SDIOSTAT      Patient status filter
"RTN","SDAMA200",32,0)
 ;-------------------------------------------------------------------
"RTN","SDAMA200",33,0)
 ;
"RTN","SDAMA200",34,0)
VALIDATE(SDIEN,SDFIELDS,SDAPSTAT,SDSTART,SDEND,SDAPINAM,SDRTNNAM,SDIOSTAT) ;
"RTN","SDAMA200",35,0)
 ;
"RTN","SDAMA200",36,0)
 N SDERRFLG
"RTN","SDAMA200",37,0)
 S SDERRFLG=0
"RTN","SDAMA200",38,0)
 ;Validate IEN
"RTN","SDAMA200",39,0)
 I $G(SDIEN)="" D ERROR($S(SDAPINAM="GETPLIST":104,1:102),SDAPINAM,.SDERRFLG,SDRTNNAM)
"RTN","SDAMA200",40,0)
 I $G(SDIEN)'="",+$G(SDIEN)'=$G(SDIEN) D ERROR(110,SDAPINAM,.SDERRFLG,SDRTNNAM)
"RTN","SDAMA200",41,0)
 ;
"RTN","SDAMA200",42,0)
 ;Validate Appointment Status Filter
"RTN","SDAMA200",43,0)
 I $L($G(SDAPSTAT))>0 D
"RTN","SDAMA200",44,0)
 . ;validate each status, build new status list if necessary
"RTN","SDAMA200",45,0)
 . N SDNUM,SDPIECE,SDQUIT,SDAPVAL,SDNEWAP
"RTN","SDAMA200",46,0)
 . S SDQUIT=0
"RTN","SDAMA200",47,0)
 . ;get count of values passed in
"RTN","SDAMA200",48,0)
 . S SDNUM=$L(SDAPSTAT,";")
"RTN","SDAMA200",49,0)
 . S SDNEWAP=";"
"RTN","SDAMA200",50,0)
 . ;check each value passed in
"RTN","SDAMA200",51,0)
 . F SDPIECE=1:1:SDNUM S SDAPVAL=$P(SDAPSTAT,";",SDPIECE) D  Q:SDQUIT=1
"RTN","SDAMA200",52,0)
 .. I $G(SDAPVAL)="" D ERROR(109,SDAPINAM,.SDERRFLG,SDRTNNAM) S SDQUIT=1 Q
"RTN","SDAMA200",53,0)
 .. I ";R;C;N;NT;"'[(";"_SDAPVAL_";") D ERROR(109,SDAPINAM,.SDERRFLG,SDRTNNAM) S SDQUIT=1 Q
"RTN","SDAMA200",54,0)
 .. ;build status string
"RTN","SDAMA200",55,0)
 .. S SDNEWAP=SDNEWAP_SDAPVAL_";"
"RTN","SDAMA200",56,0)
 .S SDAPSTAT=SDNEWAP
"RTN","SDAMA200",57,0)
 ;set appointment status filter to 'all' if null or undefined
"RTN","SDAMA200",58,0)
 I $G(SDAPSTAT)="" S SDAPSTAT=";R;C;N;NT;"
"RTN","SDAMA200",59,0)
 ;
"RTN","SDAMA200",60,0)
 ;Validate start and end date/time variables if they are passed in
"RTN","SDAMA200",61,0)
 N SDSTVAL,SDENDVAL,%H,%T,%Y,X
"RTN","SDAMA200",62,0)
 S (SDSTVAL,SDENDVAL)=0
"RTN","SDAMA200",63,0)
 I $G(SDSTART)'="" D
"RTN","SDAMA200",64,0)
 . I +SDSTART'=SDSTART D ERROR(105,SDAPINAM,.SDERRFLG,SDRTNNAM) Q
"RTN","SDAMA200",65,0)
 . S X=SDSTART D H^%DTC I %H=0 D ERROR(105,SDAPINAM,.SDERRFLG,SDRTNNAM) Q
"RTN","SDAMA200",66,0)
 . S SDSTVAL=1
"RTN","SDAMA200",67,0)
 I $G(SDEND)'="" D
"RTN","SDAMA200",68,0)
 . I +SDEND'=SDEND D ERROR(106,SDAPINAM,.SDERRFLG,SDRTNNAM) Q
"RTN","SDAMA200",69,0)
 . S X=SDEND D H^%DTC I %H=0 D ERROR(106,SDAPINAM,.SDERRFLG,SDRTNNAM) Q
"RTN","SDAMA200",70,0)
 . S SDENDVAL=1
"RTN","SDAMA200",71,0)
 ;If start and end dates are valid, make sure start date not > end date
"RTN","SDAMA200",72,0)
 I SDSTVAL,SDENDVAL D
"RTN","SDAMA200",73,0)
 . I SDSTART>SDEND D ERROR(111,SDAPINAM,.SDERRFLG,SDRTNNAM)
"RTN","SDAMA200",74,0)
 ;
"RTN","SDAMA200",75,0)
 ;Remove beginning and ending semi-colons from SDFIELDS list if present
"RTN","SDAMA200",76,0)
 I $L($G(SDFIELDS))>0 D
"RTN","SDAMA200",77,0)
 . I $E($G(SDFIELDS),1,1)=";" D
"RTN","SDAMA200",78,0)
 .. S SDFIELDS=$E(SDFIELDS,2,$L(SDFIELDS))
"RTN","SDAMA200",79,0)
 .. I $G(SDFIELDS)="" D ERROR(103,SDAPINAM,.SDERRFLG,SDRTNNAM)
"RTN","SDAMA200",80,0)
 .I $L($G(SDFIELDS))>0 D
"RTN","SDAMA200",81,0)
 .. I $E($G(SDFIELDS),$L($G(SDFIELDS)),$L($G(SDFIELDS)))=";" D
"RTN","SDAMA200",82,0)
 ... S SDFIELDS=$E(SDFIELDS,1,$L(SDFIELDS)-1)
"RTN","SDAMA200",83,0)
 ... I $G(SDFIELDS)="" D ERROR(103,SDAPINAM,.SDERRFLG,SDRTNNAM)
"RTN","SDAMA200",84,0)
 ;
"RTN","SDAMA200",85,0)
 ;Validate SDFIELDS list 
"RTN","SDAMA200",86,0)
 N SDI,SDFIELD,SDNUM,SDEND
"RTN","SDAMA200",87,0)
 S (SDI,SDFIELD,SDNUM,SDEND)=0
"RTN","SDAMA200",88,0)
 ;Check field list for valid numbers requested
"RTN","SDAMA200",89,0)
 I $G(SDFIELDS)]"" D
"RTN","SDAMA200",90,0)
 . ;get number of pieces
"RTN","SDAMA200",91,0)
 . S SDNUM=$L(SDFIELDS,";")
"RTN","SDAMA200",92,0)
 . ;validate each piece
"RTN","SDAMA200",93,0)
 . F SDI=1:1:SDNUM S SDFIELD=$P(SDFIELDS,";",SDI) D  Q:SDEND
"RTN","SDAMA200",94,0)
 .. I $G(SDFIELD)="" D ERROR(103,SDAPINAM,.SDERRFLG,SDRTNNAM) S SDEND=1 Q
"RTN","SDAMA200",95,0)
 .. I '$D(^SDAM(44.3,SDFIELD)) D ERROR(103,SDAPINAM,.SDERRFLG,SDRTNNAM) S SDEND=1 Q
"RTN","SDAMA200",96,0)
 ;If field list is null and API is not NEXTAPPT, set up to include all
"RTN","SDAMA200",97,0)
 I ($G(SDFIELDS)="")&(SDAPINAM'="NEXTAPPT") S SDI=0 D
"RTN","SDAMA200",98,0)
 . F  S SDI=$O(^SDAM(44.3,SDI)) Q:+$G(SDI)=0  D
"RTN","SDAMA200",99,0)
 .. S SDFIELDS=$G(SDFIELDS)_SDI_";"
"RTN","SDAMA200",100,0)
 . ;remove ending semi-colon
"RTN","SDAMA200",101,0)
 . S SDFIELDS=$E(SDFIELDS,1,$L(SDFIELDS)-1)
"RTN","SDAMA200",102,0)
 ;
"RTN","SDAMA200",103,0)
 ;Validate Patient Status Filter
"RTN","SDAMA200",104,0)
 I $L($G(SDIOSTAT))>0 D
"RTN","SDAMA200",105,0)
 . I $L(SDIOSTAT)>1 D ERROR(112,SDAPINAM,.SDERRFLG,SDRTNNAM) Q
"RTN","SDAMA200",106,0)
 . I "IO"'[SDIOSTAT D ERROR(112,SDAPINAM,.SDERRFLG,SDRTNNAM) Q
"RTN","SDAMA200",107,0)
 ;set patient status filter to 'both' if null or undefined
"RTN","SDAMA200",108,0)
 I $G(SDIOSTAT)="" S SDIOSTAT="IO"
"RTN","SDAMA200",109,0)
 ;
"RTN","SDAMA200",110,0)
 ;Validate Appt Status and Patient Status Filter Combination 
"RTN","SDAMA200",111,0)
 ;if they specify a patient status, they must specify scheduled/kept appt type "R"
"RTN","SDAMA200",112,0)
 I $G(SDIOSTAT)="I",$G(SDAPSTAT)'=";R;" D ERROR(113,SDAPINAM,.SDERRFLG,SDRTNNAM)
"RTN","SDAMA200",113,0)
 I $G(SDIOSTAT)="O",$S($G(SDAPSTAT)=";R;":0,$G(SDAPSTAT)=";NT;":0,$G(SDAPSTAT)=";R;NT;":0,$G(SDAPSTAT)=";NT;R;":0,1:1) D ERROR(113,SDAPINAM,.SDERRFLG,SDRTNNAM)
"RTN","SDAMA200",114,0)
 ;
"RTN","SDAMA200",115,0)
 I SDERRFLG>0 Q -1
"RTN","SDAMA200",116,0)
 Q 1
"RTN","SDAMA200",117,0)
 ;
"RTN","SDAMA200",118,0)
ERROR(SDERRNUM,SDAPINAM,SDERRFLG,SDRTNNAM) ;
"RTN","SDAMA200",119,0)
 ;Put error message in ^TMP global
"RTN","SDAMA200",120,0)
 S SDERRFLG=1
"RTN","SDAMA200",121,0)
 S $P(^TMP($J,SDRTNNAM,SDAPINAM,"ERROR",SDERRNUM),"^",1)=$P($T(@SDERRNUM),";;",2)
"RTN","SDAMA200",122,0)
 Q
"RTN","SDAMA200",123,0)
 ;
"RTN","SDAMA200",124,0)
 ;***************************************************************
"RTN","SDAMA200",125,0)
 ; ERROR CODES AND MESSAGES USED FOR PARAMETER VALIDATION
"RTN","SDAMA200",126,0)
 ;***************************************************************
"RTN","SDAMA200",127,0)
 ;
"RTN","SDAMA200",128,0)
101 ;;DATABASE IS UNAVAILABLE
"RTN","SDAMA200",129,0)
102 ;;PATIENT ID IS REQUIRED
"RTN","SDAMA200",130,0)
103 ;;INVALID FIELD LIST
"RTN","SDAMA200",131,0)
104 ;;CLINIC ID IS REQUIRED
"RTN","SDAMA200",132,0)
105 ;;INVALID START DATE
"RTN","SDAMA200",133,0)
106 ;;INVALID END DATE
"RTN","SDAMA200",134,0)
108 ;;FACILITY ID IS REQUIRED
"RTN","SDAMA200",135,0)
109 ;;INVALID APPOINTMENT STATUS FILTER
"RTN","SDAMA200",136,0)
110 ;;ID MUST BE NUMERIC
"RTN","SDAMA200",137,0)
111 ;;START DATE CAN'T BE AFTER END DATE
"RTN","SDAMA200",138,0)
112 ;;INVALID PATIENT STATUS FILTER
"RTN","SDAMA200",139,0)
113 ;;APPT STATUS AND PATIENT STATUS FILTER COMBINATION UNSUPPORTED IN VISTA
"RTN","SDAMA200",140,0)
114 ;;INVALID PATIENT ID
"RTN","SDAMA200",141,0)
116 ;;DATA MISMATCH
"RTN","SDAMA200",142,0)
117 ;;SDAPI ERROR
"RTN","SDAMA200",143,0)
 ;
"RTN","SDAMA200",144,0)
 ;------------------------------------------------------------------
"RTN","SDAMA200",145,0)
 ;Additional APIs called from GETAPPT, GETPLIST, NEXTAPPT, GETALLCL
"RTN","SDAMA200",146,0)
 ;------------------------------------------------------------------
"RTN","SDAMA200",147,0)
 ;
"RTN","SDAMA200",148,0)
PATAPPT(SDPATIEN) ;For a patient IEN, return Boolean value for existence of appointments on ^DPT
"RTN","SDAMA200",149,0)
 I $D(^DPT(SDPATIEN,"S")) Q 1
"RTN","SDAMA200",150,0)
 Q 0
"RTN","SDAMA200",151,0)
 ;
"RTN","SDAMA200",152,0)
CLNAPPT(SDCLIEN) ;For a clinic IEN, return Boolean value for existence of appointments on ^SC
"RTN","SDAMA200",153,0)
 I $D(^SC($G(SDCLIEN),"S")) Q 1
"RTN","SDAMA200",154,0)
 Q 0
"RTN","SDAMA200",155,0)
GETCLIEN(SDPATIEN,SDAPPTDT) ; For a patient and appt date, return the clinic IEN on ^DPT
"RTN","SDAMA200",156,0)
 Q $P($G(^DPT($G(SDPATIEN),"S",$G(SDAPPTDT),0)),"^",1)
"RTN","SDAMA200",157,0)
 ;
"RTN","SDAMA200",158,0)
GETPTIEN(SDCLIEN,SDAPPTDT,SDPATCNT) ; For a clinic, appt date, and node, return the patient IEN on ^SC
"RTN","SDAMA200",159,0)
 Q $P($G(^SC($G(SDCLIEN),"S",$G(SDAPPTDT),1,$G(SDPATCNT),0)),"^",1)
"RTN","SDAMA200",160,0)
 ;
"RTN","SDAMA200",161,0)
GETSDDA(SDCLIEN,SDAPPTDT,SDPATIEN) ; For a clinic, appt date, and patient, return the SDDA node number on ^SC
"RTN","SDAMA200",162,0)
 N SDPATCNT,SDMATCH
"RTN","SDAMA200",163,0)
 S SDPATCNT=0,SDMATCH=0
"RTN","SDAMA200",164,0)
 F  S SDPATCNT=$O(^SC($G(SDCLIEN),"S",$G(SDAPPTDT),1,SDPATCNT)) D  Q:('SDPATCNT!SDMATCH)
"RTN","SDAMA200",165,0)
 . I 'SDPATCNT Q
"RTN","SDAMA200",166,0)
 . I $P($G(^SC(SDCLIEN,"S",SDAPPTDT,1,SDPATCNT,0)),"^",1)=SDPATIEN S SDMATCH=1
"RTN","SDAMA200",167,0)
 Q $G(SDPATCNT)
"RTN","SDAMA200",168,0)
 ;
"RTN","SDAMA200",169,0)
GETASTAT(SDPATIEN,SDAPPTDT) ;For a patient and appt date, return Appointment Status (N, C, R, or NT)
"RTN","SDAMA200",170,0)
 N SDSTAT
"RTN","SDAMA200",171,0)
 S SDSTAT=$P($G(^DPT(SDPATIEN,"S",SDAPPTDT,0)),"^",2)
"RTN","SDAMA200",172,0)
 S SDSTAT=$S($G(SDSTAT)="NT":"NT",$G(SDSTAT)="I":"R",$G(SDSTAT)["N":"N",$G(SDSTAT)["C":"C",1:"R")
"RTN","SDAMA200",173,0)
 Q SDSTAT
"RTN","SDAMA200",174,0)
 ;
"RTN","SDAMA200",175,0)
GETPSTAT(SDPATIEN,SDAPPTDT) ;For a patient and appt date, return Patient Status (I or O)
"RTN","SDAMA200",176,0)
 N SDSTAT
"RTN","SDAMA200",177,0)
 S SDSTAT=$P($G(^DPT(SDPATIEN,"S",SDAPPTDT,0)),"^",2)
"RTN","SDAMA200",178,0)
 S SDSTAT=$S($G(SDSTAT)="I":"I",1:"O")
"RTN","SDAMA200",179,0)
 Q SDSTAT
"RTN","SDAMA200",180,0)
 ;
"RTN","SDAMA201")
0^2^B32514859
"RTN","SDAMA201",1,0)
SDAMA201 ;BPOIFO/ACS-Scheduling Replacement APIs ; 12/13/04 3:14pm
"RTN","SDAMA201",2,0)
 ;;5.3;Scheduling;**253,275,283,316,347**;13 Aug 1993
"RTN","SDAMA201",3,0)
 ;
"RTN","SDAMA201",4,0)
 ;GETAPPT  - Returns appointment information for a patient
"RTN","SDAMA201",5,0)
 ;NEXTAPPT - Returns next appointment information for a patient
"RTN","SDAMA201",6,0)
 ;
"RTN","SDAMA201",7,0)
 ;**   BEFORE USING THE APIS IN THIS ROUTINE, PLEASE SUBSCRIBE   **
"RTN","SDAMA201",8,0)
 ;**   TO DBIA #3859                                             **
"RTN","SDAMA201",9,0)
 ;
"RTN","SDAMA201",10,0)
 ;*****************************************************************
"RTN","SDAMA201",11,0)
 ;              CHANGE LOG
"RTN","SDAMA201",12,0)
 ;
"RTN","SDAMA201",13,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA201",14,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA201",15,0)
 ;09/20/02  SD*5.3*253    ROUTINE COMPLETED
"RTN","SDAMA201",16,0)
 ;12/10/02  SD*5.3*275    ADDED PATIENT STATUS FILTER
"RTN","SDAMA201",17,0)
 ;07/03/03  SD*5.3*283    REMOVED 'NO ACTION TAKEN' EDIT
"RTN","SDAMA201",18,0)
 ;09/16/03  SD*5.3*316    CHANGED 'NEXTAPPT' TO START LOOKING 'NOW'
"RTN","SDAMA201",19,0)
 ;07/26/04  SD*5.3*347    NEW VARIABLES USED IN ^%DTC CALL.
"RTN","SDAMA201",20,0)
 ;                        NEXTAPPT TO GET DATA FROM SDAPI NOT VISTA.
"RTN","SDAMA201",21,0)
 ;                        GETAPPT WILL RETRIEVE APPT DATA THROUGH
"RTN","SDAMA201",22,0)
 ;                        SDAPI API.  PATIENT STATUS TO OVERWRITE 
"RTN","SDAMA201",23,0)
 ;                        APPOINTMENT STATUS OF "R" OR "R;I".
"RTN","SDAMA201",24,0)
 ;                        GETAPPT CALLS GETAPPT^SDAMA205.
"RTN","SDAMA201",25,0)
 ;
"RTN","SDAMA201",26,0)
 ;*****************************************************************
"RTN","SDAMA201",27,0)
GETAPPT(SDPATIEN,SDFIELDS,SDAPSTAT,SDSTART,SDEND,SDRESULT,SDIOSTAT) ;
"RTN","SDAMA201",28,0)
 ;*****************************************************************
"RTN","SDAMA201",29,0)
 ;
"RTN","SDAMA201",30,0)
 ;               GET APPOINTMENTS FOR PATIENT
"RTN","SDAMA201",31,0)
 ;
"RTN","SDAMA201",32,0)
 ;INPUT
"RTN","SDAMA201",33,0)
 ;  SDPATIEN     Patient IEN (required)
"RTN","SDAMA201",34,0)
 ;  SDFIELDS     Fields requested (optional)
"RTN","SDAMA201",35,0)
 ;  SDAPSTAT     Appointment Status Filter (optional)
"RTN","SDAMA201",36,0)
 ;  SDSTART      Start date/time (optional)
"RTN","SDAMA201",37,0)
 ;  SDEND        End date/time (optional)
"RTN","SDAMA201",38,0)
 ;  SDRESULT     Record count returned here (optional)
"RTN","SDAMA201",39,0)
 ;  SDIOSTAT     Patient Status filter (optional)
"RTN","SDAMA201",40,0)
 ;  
"RTN","SDAMA201",41,0)
 ;OUTPUT
"RTN","SDAMA201",42,0)
 ;  ^TMP($J,"SDAMA201","GETAPPT",X,Y)=FieldYdata
"RTN","SDAMA201",43,0)
 ;  where "X" is an incremental appointment counter and
"RTN","SDAMA201",44,0)
 ;  "Y" is the field number requested
"RTN","SDAMA201",45,0)
 ;  
"RTN","SDAMA201",46,0)
 ;*****************************************************************
"RTN","SDAMA201",47,0)
 ; Call API to Get Appointment(s) for Patient.
"RTN","SDAMA201",48,0)
 D GETAPPT^SDAMA205(.SDPATIEN,.SDFIELDS,.SDAPSTAT,.SDSTART,.SDEND,.SDRESULT,.SDIOSTAT)
"RTN","SDAMA201",49,0)
 Q
"RTN","SDAMA201",50,0)
 ;
"RTN","SDAMA201",51,0)
NEXTAPPT(SDPATIEN,SDFIELDS,SDAPSTAT,SDIOSTAT) ;
"RTN","SDAMA201",52,0)
 ;*****************************************************************
"RTN","SDAMA201",53,0)
 ;
"RTN","SDAMA201",54,0)
 ;               GET NEXT APPOINTMENT FOR PATIENT
"RTN","SDAMA201",55,0)
 ;
"RTN","SDAMA201",56,0)
 ; This API should be called with an EXTRINISIC call.  It will
"RTN","SDAMA201",57,0)
 ; return "-1" if an error occurs, "1" if a future appointment
"RTN","SDAMA201",58,0)
 ; exists, or "0" if no future appointment exists.  If the user
"RTN","SDAMA201",59,0)
 ; enters field numbers into the optional SDFIELDS parameter and a
"RTN","SDAMA201",60,0)
 ; next appointment is found, the requested fields for that next
"RTN","SDAMA201",61,0)
 ; appointment will be retrieved and put into: 
"RTN","SDAMA201",62,0)
 ; ^TMP($J,"SDAMA201","NEXTAPPT")
"RTN","SDAMA201",63,0)
 ;
"RTN","SDAMA201",64,0)
 ;INPUT
"RTN","SDAMA201",65,0)
 ;  SDPATIEN     Patient IEN (required)
"RTN","SDAMA201",66,0)
 ;  SDFIELDS     Fields requested (optional)
"RTN","SDAMA201",67,0)
 ;  SDAPSTAT     Appointment status filter (optional)
"RTN","SDAMA201",68,0)
 ;  SDIOSTAT     Patient status filter (optional)
"RTN","SDAMA201",69,0)
 ;
"RTN","SDAMA201",70,0)
 ;OUTPUT
"RTN","SDAMA201",71,0)
 ;  -1: error
"RTN","SDAMA201",72,0)
 ;   0: no future appointment
"RTN","SDAMA201",73,0)
 ;   1: future appointment exists
"RTN","SDAMA201",74,0)
 ;
"RTN","SDAMA201",75,0)
 ;  If "1" is returned and the user has requested fields in the 
"RTN","SDAMA201",76,0)
 ;  SDFIELDS  parameter, the following global is populated:
"RTN","SDAMA201",77,0)
 ;  ^TMP($J,"SDAMA201","NEXTAPPT",Y)=FieldYdata
"RTN","SDAMA201",78,0)
 ;  where "Y" is the field number requested
"RTN","SDAMA201",79,0)
 ;  
"RTN","SDAMA201",80,0)
 ;*****************************************************************
"RTN","SDAMA201",81,0)
 N SDAPINAM,SDRTNNAM,SDSTART,SDRESULT,%,%H,%I,X
"RTN","SDAMA201",82,0)
 S SDAPINAM="NEXTAPPT",SDRTNNAM="SDAMA201",SDRESULT=0
"RTN","SDAMA201",83,0)
 K ^TMP($J,SDRTNNAM,SDAPINAM)
"RTN","SDAMA201",84,0)
 ;
"RTN","SDAMA201",85,0)
 ;Validate input parameters
"RTN","SDAMA201",86,0)
 S SDRESULT=$$VALIDATE^SDAMA200(.SDPATIEN,.SDFIELDS,.SDAPSTAT,,,SDAPINAM,SDRTNNAM,.SDIOSTAT)
"RTN","SDAMA201",87,0)
 I SDRESULT=-1 Q -1
"RTN","SDAMA201",88,0)
 ;
"RTN","SDAMA201",89,0)
 ;Get current date/time
"RTN","SDAMA201",90,0)
 D NOW^%DTC
"RTN","SDAMA201",91,0)
 S SDSTART=$E(%,1,12)
"RTN","SDAMA201",92,0)
 ;GET NEXT APPOINTMENT DATA
"RTN","SDAMA201",93,0)
 ;If an appt was found and the user wants data returned, get fields requested
"RTN","SDAMA201",94,0)
 N SDICN,SDARRAY,SDCOUNT,SDAPLST,SDI,SDTMP,SDNUM,SDERR,SDFLDCNT,SDR,SDFLD,SD310
"RTN","SDAMA201",95,0)
 N SDAPT,SDCLN,SDFFLD,SDFS
"RTN","SDAMA201",96,0)
 S SDAPLST=""
"RTN","SDAMA201",97,0)
 ;
"RTN","SDAMA201",98,0)
 S SDARRAY(1)=SDSTART ; set searchpoint to current date/time
"RTN","SDAMA201",99,0)
 ; Translate and set up Appointment Status List
"RTN","SDAMA201",100,0)
 I $L($G(SDAPSTAT))>0 D
"RTN","SDAMA201",101,0)
 . ;Remove a leading and a trailing semicolon
"RTN","SDAMA201",102,0)
 . I $E(SDAPSTAT,$L(SDAPSTAT))=";" S SDAPSTAT=$E(SDAPSTAT,1,($L(SDAPSTAT)-1))
"RTN","SDAMA201",103,0)
 . I $E(SDAPSTAT)=";" S SDAPSTAT=$E(SDAPSTAT,2,$L(SDAPSTAT))
"RTN","SDAMA201",104,0)
 . ;IO/Appt Statuses have been validated by SDAMA200 to be I or O/R NT
"RTN","SDAMA201",105,0)
 . I $L($G(SDIOSTAT))=1 S SDAPLST=$S(SDIOSTAT="I":"I;",SDIOSTAT="O":SDAPSTAT_";")
"RTN","SDAMA201",106,0)
 . I $L($G(SDIOSTAT))'=1 D
"RTN","SDAMA201",107,0)
 .. ;Reset appointment status R=R;I C=CC;CP;CCR;CPR N=NS,NSR
"RTN","SDAMA201",108,0)
 .. S SDNUM=$L(SDAPSTAT,";") F SDI=1:1:SDNUM D
"RTN","SDAMA201",109,0)
 ... S SDTMP=$P(SDAPSTAT,";",SDI)
"RTN","SDAMA201",110,0)
 ... S SDTMP=$S(SDTMP="R":"R;I",SDTMP="C":"CC;CP;CCR;CPR",SDTMP="N":"NS;NSR",1:SDTMP)
"RTN","SDAMA201",111,0)
 ... S SDAPLST=SDAPLST_SDTMP_";"
"RTN","SDAMA201",112,0)
 . S SDARRAY(3)=$E(SDAPLST,1,($L(SDAPLST)-1)) ; Axe trailing semicolon
"RTN","SDAMA201",113,0)
 S SDARRAY(4)=SDPATIEN
"RTN","SDAMA201",114,0)
 S SDARRAY("MAX")=1
"RTN","SDAMA201",115,0)
 ; Must request at least 1 field, will ask for date/time which is field 1
"RTN","SDAMA201",116,0)
 S SDFIELDS=$G(SDFIELDS),(SDFFLD,SDFIELDS)=$S(SDFIELDS'="":SDFIELDS,1:1)
"RTN","SDAMA201",117,0)
 ; Strip out field 12 if it exists, replace with 3 if 3 is not already there
"RTN","SDAMA201",118,0)
 ; If we have both 3 and 12 in the field list, remove the 12 and a semicolon
"RTN","SDAMA201",119,0)
 I (";"_SDFIELDS_";")[";12;",((";"_SDFIELDS_";")[";3;") D
"RTN","SDAMA201",120,0)
 . S SDNUM=$L(SDFFLD,";"),SDI=$F(SDFFLD,12)
"RTN","SDAMA201",121,0)
 . I SDI=3 S SDFFLD=$E(SDFFLD,4,$L(SDFFLD)) Q
"RTN","SDAMA201",122,0)
 . S SDFFLD=$E(SDFFLD,1,(SDI-4))_$E(SDFFLD,SDI,$L(SDFFLD))
"RTN","SDAMA201",123,0)
 I ((";"_SDFIELDS_";")[";12;")&((";"_SDFIELDS_";")'[";3;") S SDNUM=$L(SDFFLD,";") D
"RTN","SDAMA201",124,0)
 . F SDI=1:1:SDNUM S SDR=$P(SDFFLD,";",SDI) I SDR=12 S $P(SDFFLD,";",SDI)=3 Q
"RTN","SDAMA201",125,0)
 ;
"RTN","SDAMA201",126,0)
 S SDARRAY("FLDS")=$S(SDFFLD'="":SDFFLD,1:1)
"RTN","SDAMA201",127,0)
 F SDI=1:1 S SDTMP=$P(SDFIELDS,";",SDI) Q:SDTMP=""  S SDFS(SDTMP)=SDI
"RTN","SDAMA201",128,0)
 ; Setup done, call SDAPI, quit if no appointment (SDCOUNT=0) and return 0
"RTN","SDAMA201",129,0)
 S SDCOUNT=$$SDAPI^SDAMA301(.SDARRAY) Q:SDCOUNT=0 0
"RTN","SDAMA201",130,0)
 ;If we have an appointment, process it
"RTN","SDAMA201",131,0)
 I SDCOUNT=1,SDFIELDS'="" S SDFLDCNT=$L(SDFIELDS,";") D:SDPATIEN'=""
"RTN","SDAMA201",132,0)
 . ;If malformed appointment data, set SDCOUNT to 0, quit
"RTN","SDAMA201",133,0)
 . S SDCLN=$O(^TMP($J,"SDAMA301",SDPATIEN,"")) I SDCLN="" S SDCOUNT=0 Q
"RTN","SDAMA201",134,0)
 . S SDAPT=$O(^TMP($J,"SDAMA301",SDPATIEN,SDCLN,"")) I SDAPT="" S SDCOUNT=0 Q
"RTN","SDAMA201",135,0)
 . S SD310=$G(^TMP($J,"SDAMA301",SDPATIEN,SDCLN,SDAPT)) I SD310="" S SDCOUNT=0 Q
"RTN","SDAMA201",136,0)
 . S SDTMP="" F SDI=1:1:SDFLDCNT S SDTMP=$O(SDFS(SDTMP)) Q:SDTMP=""  D
"RTN","SDAMA201",137,0)
 .. I "^1^5^9^11^"[(U_SDTMP_U) S ^TMP($J,"SDAMA201","NEXTAPPT",SDTMP)=$P(SD310,U,SDTMP) Q
"RTN","SDAMA201",138,0)
 .. I "^2^4^8^10^"[(U_SDTMP_U) S ^TMP($J,"SDAMA201","NEXTAPPT",SDTMP)=$TR($P(SD310,U,SDTMP),";","^") Q
"RTN","SDAMA201",139,0)
 .. I SDTMP=7 S ^TMP($J,"SDAMA201","NEXTAPPT",SDTMP)=$S($P(SD310,"^",SDTMP)="":"N",1:$P(SD310,"^",SDTMP)) Q
"RTN","SDAMA201",140,0)
 .. S SDFLD="FLD"_SDTMP
"RTN","SDAMA201",141,0)
 .. I "^3^6^12^"[(U_SDTMP_U) D @(SDFLD)
"RTN","SDAMA201",142,0)
 ;If err, set up err node
"RTN","SDAMA201",143,0)
 I SDCOUNT=-1 D
"RTN","SDAMA201",144,0)
 . S SDERR=$O(^TMP($J,"SDAMA301",""))
"RTN","SDAMA201",145,0)
 . S SDERR=$S(SDERR=101:101,SDERR=115:114,SDERR=116:114,1:117)
"RTN","SDAMA201",146,0)
 . D ERROR^SDAMA200(SDERR,"NEXTAPPT",0,"SDAMA201")
"RTN","SDAMA201",147,0)
 K ^TMP($J,"SDAMA301")
"RTN","SDAMA201",148,0)
 Q SDCOUNT
"RTN","SDAMA201",149,0)
 ;Xlate output from SDAPI as required
"RTN","SDAMA201",150,0)
FLD3 S SDR=$P($P(SD310,U,SDTMP),";",1)
"RTN","SDAMA201",151,0)
 S SDR=$S(SDR="I":"R",SDR?1(1"CC",1"CP",1"CPR"):"C",SDR?1(1"NS",1"NSR"):"N",1:SDR)
"RTN","SDAMA201",152,0)
 S ^TMP($J,"SDAMA201","NEXTAPPT",SDTMP)=SDR Q
"RTN","SDAMA201",153,0)
FLD6 S SDR=$G(^TMP($J,"SDAMA301",SDPATIEN,SDCLN,SDAPT,"C"))
"RTN","SDAMA201",154,0)
 S ^TMP($J,"SDAMA201","NEXTAPPT",SDTMP)=SDR Q
"RTN","SDAMA201",155,0)
FLD12 S SDR=$P($P(SD310,U,3),";",1)
"RTN","SDAMA201",156,0)
 S SDR=$S(SDR="I":"I",SDR="R":"O",SDR="NT":"O",1:"")
"RTN","SDAMA201",157,0)
 S ^TMP($J,"SDAMA201","NEXTAPPT",SDTMP)=SDR Q
"RTN","SDAMA202")
0^3^B19318464
"RTN","SDAMA202",1,0)
SDAMA202 ;BPOIFO/ACS-Scheduling Replacement APIs ; 12/13/04 3:15pm
"RTN","SDAMA202",2,0)
 ;;5.3;Scheduling;**253,275,283,316,347**;13 Aug 1993
"RTN","SDAMA202",3,0)
 ;
"RTN","SDAMA202",4,0)
 ;GETPLIST - Returns appointment information for a clinic
"RTN","SDAMA202",5,0)
 ;
"RTN","SDAMA202",6,0)
 ;**   BEFORE USING THE API IN THIS ROUTINE, PLEASE SUBSCRIBE      **
"RTN","SDAMA202",7,0)
 ;**   TO DBIA #3869                                               **
"RTN","SDAMA202",8,0)
 ;
"RTN","SDAMA202",9,0)
 ;*******************************************************************
"RTN","SDAMA202",10,0)
 ;              CHANGE LOG
"RTN","SDAMA202",11,0)
 ;
"RTN","SDAMA202",12,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA202",13,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA202",14,0)
 ;09/20/02  SD*5.3*253    ROUTINE COMPLETED
"RTN","SDAMA202",15,0)
 ;12/10/02  SD*5.3*275    ADDED PATIENT STATUS FILTER
"RTN","SDAMA202",16,0)
 ;07/03/03  SD*5.3*283    REMOVED 'NO ACTION TAKEN' EDIT.  REMOVED
"RTN","SDAMA202",17,0)
 ;                        'GETALLCL' API
"RTN","SDAMA202",18,0)
 ;09/16/03  SD*5.3*316    EXCLUDE 'CANCELLED' APPTS.  CHECK FOR 
"RTN","SDAMA202",19,0)
 ;                        CLINIC MATCH ON ^DPT
"RTN","SDAMA202",20,0)
 ;07/26/04  SD*5.3*347    ADDED PATIENT VARIABLE CHECK TO ENSURE THAT
"RTN","SDAMA202",21,0)
 ;                        VALUE RETURNED FROM $$GETPTIEN^SDAMA200 IS 
"RTN","SDAMA202",22,0)
 ;                        NOT NULL
"RTN","SDAMA202",23,0)
 ;                        REMOVE DIRECT ACCESS TO DATA.  ALL ACCESS
"RTN","SDAMA202",24,0)
 ;                        THROUGH SDAPI ONLY
"RTN","SDAMA202",25,0)
 ;********************************************************************  
"RTN","SDAMA202",26,0)
 ;
"RTN","SDAMA202",27,0)
GETPLIST(SDCLIEN,SDFIELDS,SDAPSTAT,SDSTART,SDEND,SDRESULT,SDIOSTAT) ;
"RTN","SDAMA202",28,0)
 ;********************************************************************
"RTN","SDAMA202",29,0)
 ;
"RTN","SDAMA202",30,0)
 ;               GET APPOINTMENTS FOR A CLINIC
"RTN","SDAMA202",31,0)
 ;
"RTN","SDAMA202",32,0)
 ;INPUT
"RTN","SDAMA202",33,0)
 ;  SDCLIEN      Clinic IEN (required) 
"RTN","SDAMA202",34,0)
 ;  SDFIELDS     Fields requested (optional)
"RTN","SDAMA202",35,0)
 ;  SDAPSTAT     Appointment Status filter (optional)
"RTN","SDAMA202",36,0)
 ;  SDSTART      Start date/time (optional)
"RTN","SDAMA202",37,0)
 ;  SDEND        End date/time (optional)
"RTN","SDAMA202",38,0)
 ;  SDRESULT     Record count returned here (optional)
"RTN","SDAMA202",39,0)
 ;  SDIOSTAT     Patient Status filter (optional)
"RTN","SDAMA202",40,0)
 ;  
"RTN","SDAMA202",41,0)
 ;OUTPUT
"RTN","SDAMA202",42,0)
 ;  ^TMP($J,"SDAMA202","GETPLIST",X,Y)=FieldYdata
"RTN","SDAMA202",43,0)
 ;  where "X" is an incremental appointment counter and
"RTN","SDAMA202",44,0)
 ;  "Y" is the field number requested
"RTN","SDAMA202",45,0)
 ;  
"RTN","SDAMA202",46,0)
 ;
"RTN","SDAMA202",47,0)
 ;********************************************************************
"RTN","SDAMA202",48,0)
 N SDAPINAM,SDRTNNAM
"RTN","SDAMA202",49,0)
 S SDAPINAM="GETPLIST",SDRTNNAM="SDAMA202",SDRESULT=0
"RTN","SDAMA202",50,0)
 K ^TMP($J,SDRTNNAM,SDAPINAM)
"RTN","SDAMA202",51,0)
 S SDRESULT=$$VALIDATE^SDAMA200(.SDCLIEN,.SDFIELDS,.SDAPSTAT,.SDSTART,.SDEND,SDAPINAM,SDRTNNAM,.SDIOSTAT)
"RTN","SDAMA202",52,0)
 I SDRESULT=-1 Q
"RTN","SDAMA202",53,0)
 ;
"RTN","SDAMA202",54,0)
 N SDCOUNT,SDNUM,SDTMP,SDI,SDARRAY,SDAPLST,SDX,SDY,SDCI,SDPI,SDTI,SDTR,SDF,SDA,SDR,SDO
"RTN","SDAMA202",55,0)
 S (SDNUM,SDCOUNT,SDI)=0,(SDAPLST,SDTMP)=""
"RTN","SDAMA202",56,0)
 F SDI="SDFIELDS","SDAPSTAT","SDSTART","SDEND","SDRESULT","SDIOSTAT" S @SDI=$G(@SDI)
"RTN","SDAMA202",57,0)
 ; Quit if only status requested is "C"
"RTN","SDAMA202",58,0)
 I SDAPSTAT="C"!(SDAPSTAT=";C;") S SDRESULT=0 Q
"RTN","SDAMA202",59,0)
 I +SDSTART!(+SDEND) S SDARRAY(1)=SDSTART_";"_SDEND
"RTN","SDAMA202",60,0)
 S SDARRAY(2)=SDCLIEN
"RTN","SDAMA202",61,0)
 I $L($G(SDAPSTAT))>0 D
"RTN","SDAMA202",62,0)
 . ;Remove a leading and a trailing semicolon
"RTN","SDAMA202",63,0)
 . I $E(SDAPSTAT,$L(SDAPSTAT))=";" S SDAPSTAT=$E(SDAPSTAT,1,($L(SDAPSTAT)-1))
"RTN","SDAMA202",64,0)
 . I $E(SDAPSTAT)=";" S SDAPSTAT=$E(SDAPSTAT,2,$L(SDAPSTAT))
"RTN","SDAMA202",65,0)
 . ;IO/Appt Statuses have been validated by SDAMA200 to be I or O/R NT
"RTN","SDAMA202",66,0)
 . I $L($G(SDIOSTAT))=1 S SDAPLST=$S(SDIOSTAT="I":"I;",SDIOSTAT="O":SDAPSTAT_";")
"RTN","SDAMA202",67,0)
 . I $L($G(SDIOSTAT))'=1,$L($G(SDAPSTAT)) D
"RTN","SDAMA202",68,0)
 .. ;Reset appointment status R=R;I N=NS,NSR
"RTN","SDAMA202",69,0)
 .. S SDNUM=$L(SDAPSTAT,";") F SDI=1:1:SDNUM D
"RTN","SDAMA202",70,0)
 ... S SDTMP=$P(SDAPSTAT,";",SDI) Q:SDTMP="C"
"RTN","SDAMA202",71,0)
 ... S SDTMP=$S(SDTMP="R":"R;I",SDTMP="N":"NS;NSR",1:SDTMP)
"RTN","SDAMA202",72,0)
 ... S SDAPLST=SDAPLST_SDTMP_";"
"RTN","SDAMA202",73,0)
 . ;Remove trailing semicolon
"RTN","SDAMA202",74,0)
 . S SDAPLST=$E(SDAPLST,1,($L(SDAPLST)-1))
"RTN","SDAMA202",75,0)
 I $L($G(SDAPSTAT))=0 S SDAPLST="R;I;NS;NSR;NT"
"RTN","SDAMA202",76,0)
 S SDARRAY(3)=SDAPLST
"RTN","SDAMA202",77,0)
 ;Field List Conversion
"RTN","SDAMA202",78,0)
 S SDARRAY("FLDS")=""
"RTN","SDAMA202",79,0)
 F SDX=1:1 S SDY=$P(SDFIELDS,";",SDX) Q:SDY=""  D
"RTN","SDAMA202",80,0)
 . I SDY=12,SDFIELDS[3 Q  ; if appt. stat. exists, pat. stat. not needed 
"RTN","SDAMA202",81,0)
 . I SDY=12 S SDY=3
"RTN","SDAMA202",82,0)
 . S SDARRAY("FLDS")=SDARRAY("FLDS")_SDY_";"
"RTN","SDAMA202",83,0)
 S:$L(SDARRAY("FLDS")) SDARRAY("FLDS")=$E(SDARRAY("FLDS"),1,$L(SDARRAY("FLDS"))-1)
"RTN","SDAMA202",84,0)
 I '$L(SDFIELDS) S SDARRAY("FLDS")="1;2;3;4;5;6;7;8;9;10;11"
"RTN","SDAMA202",85,0)
 ;
"RTN","SDAMA202",86,0)
 ; Setup done, call SDAPI, quit if no appointment (SDCOUNT=0) and return 0
"RTN","SDAMA202",87,0)
SDAPI S (SDRESULT,SDCOUNT)=$$SDAPI^SDAMA301(.SDARRAY) I SDCOUNT=0 S SDRESULT=0 Q
"RTN","SDAMA202",88,0)
 ;
"RTN","SDAMA202",89,0)
 ;If we have an appointment, process it
"RTN","SDAMA202",90,0)
 I SDCOUNT>0 S SDA=0,SDCI="" F  S SDCI=$O(^TMP($J,"SDAMA301",SDCI)) Q:SDCI=""  D
"RTN","SDAMA202",91,0)
 . S SDPI="" F  S SDPI=$O(^TMP($J,"SDAMA301",SDCI,SDPI)) Q:SDPI=""  D
"RTN","SDAMA202",92,0)
 .. S SDTI="" F  S SDTI=$O(^TMP($J,"SDAMA301",SDCI,SDPI,SDTI)) Q:SDTI=""  S SDTR=^(SDTI) D
"RTN","SDAMA202",93,0)
 ... S SDA=SDA+1 F SDX=1:1 S SDF=$P(SDFIELDS,";",SDX),SDY=$P(SDTR,"^",SDF) Q:SDF=""  D
"RTN","SDAMA202",94,0)
 .... I "^1^5^9^11^"[(U_SDF_U) S SDO=SDY D OUT Q
"RTN","SDAMA202",95,0)
 .... I "^2^4^8^10^"[(U_SDF_U) S SDO=$TR(SDY,";","^") D OUT Q
"RTN","SDAMA202",96,0)
 .... I "^3^6^7^12^"[(U_SDF_U) D @("FLD"_SDF)
"RTN","SDAMA202",97,0)
 ; Process errors if any
"RTN","SDAMA202",98,0)
 I SDCOUNT<0 D
"RTN","SDAMA202",99,0)
 .S SDRESULT=-1,SDX=$O(^TMP($J,"SDAMA301",""))
"RTN","SDAMA202",100,0)
 .S SDX=$S(SDX=101:101,SDX=116:116,1:117)
"RTN","SDAMA202",101,0)
 .D ERROR^SDAMA200(SDX,SDAPINAM,0,SDRTNNAM) Q
"RTN","SDAMA202",102,0)
 K ^TMP($J,"SDAMA301")
"RTN","SDAMA202",103,0)
 Q
"RTN","SDAMA202",104,0)
FLD3 S SDR=$P(SDY,";",1)
"RTN","SDAMA202",105,0)
 S SDO=$S(SDR="I":"R",SDR?1(1"NS",1"NSR"):"N",1:SDR) D OUT
"RTN","SDAMA202",106,0)
 Q
"RTN","SDAMA202",107,0)
FLD6 S SDO=$G(^TMP($J,"SDAMA301",SDCI,SDPI,SDTI,"C"))
"RTN","SDAMA202",108,0)
 D OUT
"RTN","SDAMA202",109,0)
 Q
"RTN","SDAMA202",110,0)
FLD7 S SDO=$S(SDY="":"N",1:SDY)
"RTN","SDAMA202",111,0)
 D OUT
"RTN","SDAMA202",112,0)
 Q
"RTN","SDAMA202",113,0)
FLD12 S SDR=$P($P(SDTR,U,3),";",1)
"RTN","SDAMA202",114,0)
 S SDO=$S(SDR="I":"I",SDR="R":"O",SDR="NT":"O",1:"") D OUT
"RTN","SDAMA202",115,0)
 Q
"RTN","SDAMA202",116,0)
OUT S ^TMP($J,"SDAMA202","GETPLIST",SDA,SDF)=SDO
"RTN","SDAMA202",117,0)
 Q
"RTN","SDAMA204")
0^4^B3244715
"RTN","SDAMA204",1,0)
SDAMA204 ;BPOIFO/NDH-Scheduling Replacement APIs ; 12/13/04 3:16pm
"RTN","SDAMA204",2,0)
 ;;5.3;Scheduling;**310,347**;13 Aug 1993
"RTN","SDAMA204",3,0)
 ;
"RTN","SDAMA204",4,0)
 ;PATAPPT - Determines if an appointment exists for a patient.
"RTN","SDAMA204",5,0)
 ;
"RTN","SDAMA204",6,0)
 ;**   BEFORE USING THE API IN THIS ROUTINE, PLEASE SUBSCRIBE    **
"RTN","SDAMA204",7,0)
 ;**   TO DBIA #4216                                             **
"RTN","SDAMA204",8,0)
 ;
"RTN","SDAMA204",9,0)
 ;*****************************************************************
"RTN","SDAMA204",10,0)
 ;              CHANGE LOG
"RTN","SDAMA204",11,0)
 ;
"RTN","SDAMA204",12,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA204",13,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA204",14,0)
 ;08/11/03  SD*5.3*310    API PATIENT APPOINTMENT EXISTS
"RTN","SDAMA204",15,0)
 ;07/26/04  SD*5.3*347    API Patient Appointment supports distributed
"RTN","SDAMA204",16,0)
 ;                        appointment files (whether actual files are
"RTN","SDAMA204",17,0)
 ;                        located in VistA DB or Oracle DB).
"RTN","SDAMA204",18,0)
 ;
"RTN","SDAMA204",19,0)
 ;*****************************************************************
"RTN","SDAMA204",20,0)
 ;
"RTN","SDAMA204",21,0)
PATAPPT(SDDFN) ; Check for existence of any appointment for a patient
"RTN","SDAMA204",22,0)
 ; 
"RTN","SDAMA204",23,0)
 ;       This API is an extrinsic function that returns 1 of 3 values.
"RTN","SDAMA204",24,0)
 ;       The API checks for the existence of appointment records.
"RTN","SDAMA204",25,0)
 ; 
"RTN","SDAMA204",26,0)
 ;       INPUT    SDDFN : Patient's DFN number (required)
"RTN","SDAMA204",27,0)
 ; 
"RTN","SDAMA204",28,0)
 ;       OUTPUT       1 : Appointment(s) on file
"RTN","SDAMA204",29,0)
 ;                    0 : No appointment(s) on file
"RTN","SDAMA204",30,0)
 ;                   -1 : Error
"RTN","SDAMA204",31,0)
 ;                   
"RTN","SDAMA204",32,0)
 ; ERROR CODES - 101 : Database is Unavailable
"RTN","SDAMA204",33,0)
 ;               102 : Patient ID is required
"RTN","SDAMA204",34,0)
 ;               110 : Patient ID must be numeric
"RTN","SDAMA204",35,0)
 ;               114 : Invalid Patient ID
"RTN","SDAMA204",36,0)
 ;               117 : SDAPI Error
"RTN","SDAMA204",37,0)
 ; 
"RTN","SDAMA204",38,0)
 ; ERROR LOCATION : ^TMP($J,"SDAMA204","PATAPPT","ERROR")
"RTN","SDAMA204",39,0)
 ; 
"RTN","SDAMA204",40,0)
 ; Check for proper parameter and return -1 if bad DFN
"RTN","SDAMA204",41,0)
 ; 
"RTN","SDAMA204",42,0)
 ; Initialize node for error reporting
"RTN","SDAMA204",43,0)
 K ^TMP($J,"SDAMA204","PATAPPT")
"RTN","SDAMA204",44,0)
 N SDARRAY,SDCOUNT,SDX,SDY,DFN,VAERR
"RTN","SDAMA204",45,0)
 ; 
"RTN","SDAMA204",46,0)
 ; Check for no input parameter
"RTN","SDAMA204",47,0)
 I '$D(SDDFN) D  Q -1
"RTN","SDAMA204",48,0)
 .D ERROR^SDAMA200(102,"PATAPPT",0,"SDAMA204")
"RTN","SDAMA204",49,0)
 ; Check if SDDFN is numeric
"RTN","SDAMA204",50,0)
 I SDDFN'?1.N D  Q -1
"RTN","SDAMA204",51,0)
 .D ERROR^SDAMA200(110,"PATAPPT",0,"SDAMA204")
"RTN","SDAMA204",52,0)
 ; Check if DFN exists or is 0
"RTN","SDAMA204",53,0)
 S DFN=SDDFN
"RTN","SDAMA204",54,0)
 D DEM^VADPT
"RTN","SDAMA204",55,0)
 I SDDFN=0!VAERR=1 D  Q -1
"RTN","SDAMA204",56,0)
 .D ERROR^SDAMA200(114,"PATAPPT",0,"SDAMA204")
"RTN","SDAMA204",57,0)
 D KVAR^VADPT
"RTN","SDAMA204",58,0)
 ; Check for patient appointments and return 1 if appointment found
"RTN","SDAMA204",59,0)
 ; and 0 if no appointments found.
"RTN","SDAMA204",60,0)
 ;
"RTN","SDAMA204",61,0)
 S SDARRAY(4)=DFN,SDARRAY("FLDS")=1,SDARRAY("MAX")=1
"RTN","SDAMA204",62,0)
 S SDCOUNT=$$SDAPI^SDAMA301(.SDARRAY)
"RTN","SDAMA204",63,0)
 I SDCOUNT=0 Q 0 ; No Appt found.
"RTN","SDAMA204",64,0)
 I SDCOUNT=1 K ^TMP($J,"SDAMA301") Q 1  ; Appt(s). found.
"RTN","SDAMA204",65,0)
 ; Error Encountered.
"RTN","SDAMA204",66,0)
 I SDCOUNT=-1 D
"RTN","SDAMA204",67,0)
 .S SDX=$O(^TMP($J,"SDAMA301",""))
"RTN","SDAMA204",68,0)
 .S SDX=$S(SDX=101:101,SDX=115:114,SDX=116:114,1:117)
"RTN","SDAMA204",69,0)
 .D ERROR^SDAMA200(SDX,"PATAPPT",0,"SDAMA204")
"RTN","SDAMA204",70,0)
 .K ^TMP($J,"SDAMA301")
"RTN","SDAMA204",71,0)
 Q -1
"RTN","SDAMA205")
0^5^B15164247
"RTN","SDAMA205",1,0)
SDAMA205 ;BPOIFO/ACS-Scheduling Replacement APIs ; 12/13/04 3:17pm
"RTN","SDAMA205",2,0)
 ;;5.3;Scheduling;**347**;13 Aug 1993
"RTN","SDAMA205",3,0)
 ;
"RTN","SDAMA205",4,0)
 ;*****************************************************************
"RTN","SDAMA205",5,0)
 ;              CHANGE LOG
"RTN","SDAMA205",6,0)
 ;
"RTN","SDAMA205",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA205",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA205",9,0)
 ;07/21/04  SD*5.3*347    CALLED FROM GETAPPT^SDAMA201.
"RTN","SDAMA205",10,0)
 ;
"RTN","SDAMA205",11,0)
 ;*****************************************************************
"RTN","SDAMA205",12,0)
GETAPPT(SDPATIEN,SDFIELDS,SDAPSTAT,SDSTART,SDEND,SDRESULT,SDIOSTAT) ;
"RTN","SDAMA205",13,0)
 ;*****************************************************************
"RTN","SDAMA205",14,0)
 ;
"RTN","SDAMA205",15,0)
 ;               GET APPOINTMENTS FOR PATIENT
"RTN","SDAMA205",16,0)
 ;
"RTN","SDAMA205",17,0)
 ;INPUT
"RTN","SDAMA205",18,0)
 ;  SDPATIEN     Patient IEN (required)
"RTN","SDAMA205",19,0)
 ;  SDFIELDS     Fields requested (optional)
"RTN","SDAMA205",20,0)
 ;  SDAPSTAT     Appointment Status Filter (optional)
"RTN","SDAMA205",21,0)
 ;  SDSTART      Start date/time (optional)
"RTN","SDAMA205",22,0)
 ;  SDEND        End date/time (optional)
"RTN","SDAMA205",23,0)
 ;  SDRESULT     Record count returned here (optional)
"RTN","SDAMA205",24,0)
 ;  SDIOSTAT     Patient Status filter (optional)
"RTN","SDAMA205",25,0)
 ;  
"RTN","SDAMA205",26,0)
 ;OUTPUT
"RTN","SDAMA205",27,0)
 ;  ^TMP($J,"SDAMA201","GETAPPT",X,Y)=FieldYdata
"RTN","SDAMA205",28,0)
 ;  where "X" is an incremental appointment counter and
"RTN","SDAMA205",29,0)
 ;  "Y" is the field number requested
"RTN","SDAMA205",30,0)
 ;  
"RTN","SDAMA205",31,0)
 ;*****************************************************************
"RTN","SDAMA205",32,0)
 N SDAPDT,SDAPINAM,SDARRAY,SDRTNNAM,SDAPNUM,SDCNVRT,SDDATA,SDX,SDY,SDZ
"RTN","SDAMA205",33,0)
 S SDAPINAM="GETAPPT",SDRTNNAM="SDAMA201",SDRESULT=0
"RTN","SDAMA205",34,0)
 K ^TMP($J,SDRTNNAM,SDAPINAM)
"RTN","SDAMA205",35,0)
 S SDRESULT=$$VALIDATE^SDAMA200(.SDPATIEN,.SDFIELDS,.SDAPSTAT,.SDSTART,.SDEND,SDAPINAM,SDRTNNAM,.SDIOSTAT)
"RTN","SDAMA205",36,0)
 I SDRESULT=-1 Q
"RTN","SDAMA205",37,0)
 ;
"RTN","SDAMA205",38,0)
 ;CONVERT INPUT VALUES TO SDAPI FILTER VALUES
"RTN","SDAMA205",39,0)
 S SDARRAY("SORT")="P"
"RTN","SDAMA205",40,0)
 S SDARRAY(4)=SDPATIEN
"RTN","SDAMA205",41,0)
 I $G(SDSTART)>0!($G(SDEND)>0) S SDARRAY(1)=$G(SDSTART)_";"_$G(SDEND)
"RTN","SDAMA205",42,0)
 ;convert Field List
"RTN","SDAMA205",43,0)
 S SDARRAY("FLDS")=""
"RTN","SDAMA205",44,0)
 F SDX=1:1 S SDY=$P(SDFIELDS,";",SDX) Q:SDY=""  D
"RTN","SDAMA205",45,0)
 .I SDY=12,SDFIELDS[3 Q  ; Patient Status not needed if Appt. Stat. exists.
"RTN","SDAMA205",46,0)
 .I SDY=12 S SDY=3 ; Patient Status and Appointment Status are the same here.
"RTN","SDAMA205",47,0)
 .S SDARRAY("FLDS")=SDARRAY("FLDS")_SDY_";"
"RTN","SDAMA205",48,0)
 I '$L(SDFIELDS) S SDARRAY("FLDS")="1;2;3;4;5;6;7;8;9;10;11"
"RTN","SDAMA205",49,0)
 ;convert Appt. List
"RTN","SDAMA205",50,0)
 S SDZ=""
"RTN","SDAMA205",51,0)
 ;IO Status has been validated by SDAMA200 to be I or O
"RTN","SDAMA205",52,0)
 I $L($G(SDIOSTAT))=1 S SDZ=$S(SDIOSTAT="I":"I;",SDIOSTAT="O":SDAPSTAT_";")
"RTN","SDAMA205",53,0)
 I $L($G(SDIOSTAT))'=1,$L($G(SDAPSTAT)) D
"RTN","SDAMA205",54,0)
 .F SDX=1:1:$L(SDAPSTAT,";") S SDY=$P(SDAPSTAT,";",SDX)  D
"RTN","SDAMA205",55,0)
 ..S SDZ=SDZ_$S(SDY="R":"R;I;",SDY="N":"NS;NSR;",SDY="C":"CC;CP;CCR;CPR;",1:SDY_";")
"RTN","SDAMA205",56,0)
 E  S SDZ="R;I;CC;CP;CCR;CPR;NS;NSR;NT;"
"RTN","SDAMA205",57,0)
 I $L(SDZ) S SDARRAY(3)=$E(SDZ,1,$L(SDZ)-1)
"RTN","SDAMA205",58,0)
 ;
"RTN","SDAMA205",59,0)
 ;CALL SDAPI TO RETRIEVE APPOINTMENT INFO
"RTN","SDAMA205",60,0)
 S SDRESULT=$$SDAPI^SDAMA301(.SDARRAY)
"RTN","SDAMA205",61,0)
 I SDRESULT=0 Q  ; No Appointment info returned.
"RTN","SDAMA205",62,0)
 ;
"RTN","SDAMA205",63,0)
 I SDRESULT=-1 D  Q  ; Error(s) Encountered.
"RTN","SDAMA205",64,0)
 .S SDX=$O(^TMP($J,"SDAMA301",""))
"RTN","SDAMA205",65,0)
 .S SDX=$S(SDX=101:101,SDX=115:114,SDX=116:114,1:117)
"RTN","SDAMA205",66,0)
 .D ERROR^SDAMA200(SDX,"GETAPPT",0,"SDAMA201")
"RTN","SDAMA205",67,0)
 .K ^TMP($J,"SDAMA301")
"RTN","SDAMA205",68,0)
 ;
"RTN","SDAMA205",69,0)
 ; Convert Appt. Info Returned from SDAPI to GETAPPT Format.
"RTN","SDAMA205",70,0)
 F SDX=1,5,7,9,11,12 S SDCNVRT(SDX)=""
"RTN","SDAMA205",71,0)
 F SDX=2,4,8,10 S SDCNVRT(SDX)="S SDDATA=$TR(SDDATA,"";"",""^"")"
"RTN","SDAMA205",72,0)
 S SDCNVRT(3)="S SDDATA=$P(SDDATA,"";""),SDDATA=$S(SDDATA=""R"":SDDATA,SDDATA=""I"":""R"",$E(SDDATA,1)=""C"":""C"",$E(SDDATA,1,2)=""NS"":""N"",1:""NT"")"
"RTN","SDAMA205",73,0)
 S SDCNVRT(6)="S SDDATA=$G(^TMP($J,""SDAMA301"",SDPATIEN,SDAPDT,""C""))"
"RTN","SDAMA205",74,0)
 ;
"RTN","SDAMA205",75,0)
 S SDAPNUM=0,SDAPDT=""
"RTN","SDAMA205",76,0)
 ;Loop through returned appointments from SDAPI
"RTN","SDAMA205",77,0)
 F  S SDAPDT=$O(^TMP($J,"SDAMA301",SDPATIEN,SDAPDT)) Q:SDAPDT=""  S SDX=^(SDAPDT) D
"RTN","SDAMA205",78,0)
 .S SDAPNUM=SDAPNUM+1
"RTN","SDAMA205",79,0)
 .;Loop through requested fields
"RTN","SDAMA205",80,0)
 .F SDY=1:1 S SDZ=$P($G(SDFIELDS),";",SDY) Q:SDZ=""  D
"RTN","SDAMA205",81,0)
 ..;Retrieve data for requested field
"RTN","SDAMA205",82,0)
 ..S SDDATA=$P(SDX,"^",SDZ)
"RTN","SDAMA205",83,0)
 ..;Convert Overbook to N if null value returned from SDAPI
"RTN","SDAMA205",84,0)
 ..I SDZ=7,SDDATA="" S SDDATA="N"
"RTN","SDAMA205",85,0)
 ..X SDCNVRT(SDZ) S ^TMP($J,"SDAMA201","GETAPPT",SDAPNUM,SDZ)=SDDATA
"RTN","SDAMA205",86,0)
 .;Set Patient Status Value in output based on Appt Status
"RTN","SDAMA205",87,0)
 .I $P($P(SDX,U,3),";")="I" S ^TMP($J,"SDAMA201","GETAPPT",SDAPNUM,12)="I"
"RTN","SDAMA205",88,0)
 .I $S($P($P(SDX,U,3),";")="R":1,$P($P(SDX,U,3),";")="NT":1,1:0) S ^TMP($J,"SDAMA201","GETAPPT",SDAPNUM,12)="O"
"RTN","SDAMA205",89,0)
 K ^TMP($J,"SDAMA301")
"RTN","SDAMA205",90,0)
 Q
"RTN","SDAMA205",91,0)
 ;
"RTN","SDAMA300")
0^6^B42283370
"RTN","SDAMA300",1,0)
SDAMA300 ;BPOIFO/ACS-Filter API Validate Filters ; 12/13/04 3:26pm
"RTN","SDAMA300",2,0)
 ;;5.3;Scheduling;**301,347**;13 Aug 1993
"RTN","SDAMA300",3,0)
 ;
"RTN","SDAMA300",4,0)
 ;*****************************************************************
"RTN","SDAMA300",5,0)
 ;              CHANGE LOG
"RTN","SDAMA300",6,0)
 ;
"RTN","SDAMA300",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA300",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA300",9,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA300",10,0)
 ;08/06/04  SD*5.3*347    ADDITION OF A NEW FILTER - DATE APPOINTMENT
"RTN","SDAMA300",11,0)
 ;                        MADE (FIELD #16) AND 2 NEW FIELDS TO RETURN:
"RTN","SDAMA300",12,0)
 ;                        1) AUTO-REBOOKED APPT DATE/TIME (FIELD #24)
"RTN","SDAMA300",13,0)
 ;                        2) NO-SHOW/CANCEL APPT DATE/TIME (FIELD #25)
"RTN","SDAMA300",14,0)
 ;
"RTN","SDAMA300",15,0)
 ;*****************************************************************
"RTN","SDAMA300",16,0)
 ;
"RTN","SDAMA300",17,0)
 ;*****************************************************************
"RTN","SDAMA300",18,0)
 ;
"RTN","SDAMA300",19,0)
 ;              VALIDATE FILTER ARRAY CONTENTS
"RTN","SDAMA300",20,0)
 ;INPUT
"RTN","SDAMA300",21,0)
 ;  SDARRAY    Appointment filters
"RTN","SDAMA300",22,0)
 ;  SDFLTR     Filter Flag array
"RTN","SDAMA300",23,0)
 ;
"RTN","SDAMA300",24,0)
 ;OUTPUT
"RTN","SDAMA300",25,0)
 ;  -1 if error
"RTN","SDAMA300",26,0)
 ;   1 if no errors
"RTN","SDAMA300",27,0)
 ;
"RTN","SDAMA300",28,0)
 ;*****************************************************************
"RTN","SDAMA300",29,0)
VALARR(SDARRAY,SDFLTR) ;
"RTN","SDAMA300",30,0)
 ;Initialize local variables
"RTN","SDAMA300",31,0)
 N SDI,SDX,SDQUIT,SDDATA,SDCOUNT,SDERR
"RTN","SDAMA300",32,0)
 S SDQUIT=0,SDERR=115
"RTN","SDAMA300",33,0)
 ;
"RTN","SDAMA300",34,0)
 ;Set filter flags and validate input array entries
"RTN","SDAMA300",35,0)
 F SDI="MAX","FLDS","FLTRS","SORT" Q:SDQUIT  D @SDI
"RTN","SDAMA300",36,0)
 Q:(SDARRAY("CNT")=-1) -1
"RTN","SDAMA300",37,0)
 ;filters allowed on these fields
"RTN","SDAMA300",38,0)
 F SDI=1:1:4,13,16 Q:SDQUIT  D
"RTN","SDAMA300",39,0)
 . I $G(SDARRAY(SDI))']"" S SDFLTR(SDI)=0
"RTN","SDAMA300",40,0)
 . E  S SDFLTR(SDI)=1 D
"RTN","SDAMA300",41,0)
 .. S SDCOUNT=$L(SDARRAY(SDI),";")
"RTN","SDAMA300",42,0)
 .. S SDQUIT=0
"RTN","SDAMA300",43,0)
 .. D @SDI
"RTN","SDAMA300",44,0)
 ;
"RTN","SDAMA300",45,0)
 I SDQUIT=0 D
"RTN","SDAMA300",46,0)
 . ;filters not allowed on these fields
"RTN","SDAMA300",47,0)
 . F SDI=5:1:12,14,15,17:1:SDARRAY("FC") Q:SDQUIT  D NOFIL
"RTN","SDAMA300",48,0)
 Q SDARRAY("CNT")
"RTN","SDAMA300",49,0)
 ;
"RTN","SDAMA300",50,0)
 ;*****************************************************************
"RTN","SDAMA300",51,0)
 ;
"RTN","SDAMA300",52,0)
1 ;SDARRAY(1): Appt dates
"RTN","SDAMA300",53,0)
 ;validate from/to date(/time)s
"RTN","SDAMA300",54,0)
 D CHKDTES($G(SDARRAY("FR")),$G(SDARRAY("TO")))
"RTN","SDAMA300",55,0)
 Q:SDQUIT
"RTN","SDAMA300",56,0)
 ;allow seconds in date/time filter!
"RTN","SDAMA300",57,0)
 I $L(SDARRAY("FR"))>14 D ERROR(SDERR)
"RTN","SDAMA300",58,0)
 Q:SDQUIT
"RTN","SDAMA300",59,0)
 I $L(SDARRAY("TO"))>14 D ERROR(SDERR)
"RTN","SDAMA300",60,0)
 Q
"RTN","SDAMA300",61,0)
2 ;SDARRAY(2): Clinic IEN
"RTN","SDAMA300",62,0)
 ;Clinic must be on ^SC
"RTN","SDAMA300",63,0)
 ;Clinic list is not in global
"RTN","SDAMA300",64,0)
 I SDARRAY("CLNGBL")'=1 D
"RTN","SDAMA300",65,0)
 . ; get each clinic IEN in the string and validate
"RTN","SDAMA300",66,0)
 . F SDX=1:1:SDCOUNT Q:SDQUIT  D
"RTN","SDAMA300",67,0)
 .. S SDDATA=$P(SDARRAY(2),";",SDX)
"RTN","SDAMA300",68,0)
 .. I ($G(SDDATA)=""!'$D(^SC(SDDATA,0))) D ERROR(SDERR)
"RTN","SDAMA300",69,0)
 ;Clinic list is in global or local array
"RTN","SDAMA300",70,0)
 I SDARRAY("CLNGBL")=1 D
"RTN","SDAMA300",71,0)
 . S SDX=SDARRAY(2)
"RTN","SDAMA300",72,0)
 . ;check for existence of IENs
"RTN","SDAMA300",73,0)
 . N SDIEN S SDIEN=$O(@(SDX_"0)")) I +$G(SDIEN)=0 D ERROR(SDERR)
"RTN","SDAMA300",74,0)
 . Q:SDQUIT
"RTN","SDAMA300",75,0)
 . S SDDATA=0
"RTN","SDAMA300",76,0)
 . ; get each IEN in the array and validate
"RTN","SDAMA300",77,0)
 . F  S SDDATA=$O(@(SDX_"SDDATA)")) Q:(($G(SDDATA)="")!(SDQUIT))  D
"RTN","SDAMA300",78,0)
 .. I '$D(^SC(SDDATA,0)) D ERROR(SDERR)
"RTN","SDAMA300",79,0)
 Q
"RTN","SDAMA300",80,0)
3 ;SDARRAY(3): Appointment Status Code
"RTN","SDAMA300",81,0)
 F SDX=1:1:SDCOUNT Q:SDQUIT  D
"RTN","SDAMA300",82,0)
 . S SDDATA=";"_$P(SDARRAY(3),";",SDX)_";"
"RTN","SDAMA300",83,0)
 . I ";I;R;NT;NS;NSR;CC;CCR;CP;CPR;"'[(SDDATA) D ERROR(SDERR)
"RTN","SDAMA300",84,0)
 Q
"RTN","SDAMA300",85,0)
4 ;SDARRAY(4): Patient DFN
"RTN","SDAMA300",86,0)
 ;patient must be on ^DPT
"RTN","SDAMA300",87,0)
 ;DFN list is not in global
"RTN","SDAMA300",88,0)
 I SDARRAY("PATGBL")'=1 D
"RTN","SDAMA300",89,0)
 . ; get each DFN in the string and validate
"RTN","SDAMA300",90,0)
 . F SDX=1:1:SDCOUNT Q:SDQUIT  D
"RTN","SDAMA300",91,0)
 .. S SDDATA=$P(SDARRAY(4),";",SDX)
"RTN","SDAMA300",92,0)
 .. I $G(SDDATA)="" D ERROR(SDERR)
"RTN","SDAMA300",93,0)
 .. Q:SDQUIT
"RTN","SDAMA300",94,0)
 .. I '$D(^DPT(SDDATA)) D ERROR(SDERR)
"RTN","SDAMA300",95,0)
 .. Q:SDQUIT
"RTN","SDAMA300",96,0)
 ;DFN list is in global or local array
"RTN","SDAMA300",97,0)
 I SDARRAY("PATGBL")=1 D
"RTN","SDAMA300",98,0)
 . S SDX=SDARRAY(4)
"RTN","SDAMA300",99,0)
 . ;check for existence of DFNs
"RTN","SDAMA300",100,0)
 . N SDDFN S SDDFN=$O(@(SDX_"0)")) I +$G(SDDFN)=0 D ERROR(SDERR)
"RTN","SDAMA300",101,0)
 . Q:SDQUIT
"RTN","SDAMA300",102,0)
 . S SDDATA=0
"RTN","SDAMA300",103,0)
 . ; get each DFN in the array and validate
"RTN","SDAMA300",104,0)
 . F  S SDDATA=$O(@(SDX_"SDDATA)")) Q:(($G(SDDATA)="")!(SDQUIT))  D
"RTN","SDAMA300",105,0)
 .. I '$D(^DPT(SDDATA)) D ERROR(SDERR)
"RTN","SDAMA300",106,0)
 .. Q:SDQUIT
"RTN","SDAMA300",107,0)
 Q
"RTN","SDAMA300",108,0)
13 ;SDARRAY(13): Primary Stop Code
"RTN","SDAMA300",109,0)
 ;primary stop code must exist on ^DIC(40.7
"RTN","SDAMA300",110,0)
 N SDY,SDVALID
"RTN","SDAMA300",111,0)
 S SDVALID=0
"RTN","SDAMA300",112,0)
 F SDX=1:1:SDCOUNT Q:SDQUIT  D
"RTN","SDAMA300",113,0)
 . S SDDATA=$P(SDARRAY(13),";",SDX) D
"RTN","SDAMA300",114,0)
 .. I (($G(SDDATA)<1)!($G(SDDATA)>999)) S SDQUIT=1 Q 
"RTN","SDAMA300",115,0)
 .. ;I '$D(^DIC(40.7,SDDATA)) S SDQUIT=1 Q
"RTN","SDAMA300",116,0)
 .. S SDVALID=0,SDY=0
"RTN","SDAMA300",117,0)
 .. F  S SDY=$O(^DIC(40.7,SDY)) Q:((SDY="")!(SDVALID=1))  D
"RTN","SDAMA300",118,0)
 ... I SDDATA=$P($G(^DIC(40.7,SDY,0)),"^",2) S SDVALID=1
"RTN","SDAMA300",119,0)
 .. I SDVALID=0 S SDQUIT=1
"RTN","SDAMA300",120,0)
 I SDQUIT D ERROR(SDERR)
"RTN","SDAMA300",121,0)
 Q
"RTN","SDAMA300",122,0)
16 ;SDARRAY(16): Date Appointment Made
"RTN","SDAMA300",123,0)
 ;validate from/to date(s)
"RTN","SDAMA300",124,0)
 D CHKDTES($G(SDARRAY("DAMFR")),$G(SDARRAY("DAMTO")))
"RTN","SDAMA300",125,0)
 Q:SDQUIT
"RTN","SDAMA300",126,0)
 ;ensure time not entered
"RTN","SDAMA300",127,0)
 I $L(SDARRAY("DAMFR"))>7 D ERROR(SDERR)
"RTN","SDAMA300",128,0)
 Q:SDQUIT
"RTN","SDAMA300",129,0)
 I $L(SDARRAY("DAMTO"))>7 D ERROR(SDERR)
"RTN","SDAMA300",130,0)
 Q
"RTN","SDAMA300",131,0)
NOFIL ;No filter allowed
"RTN","SDAMA300",132,0)
 I $G(SDARRAY(SDI))]"" D ERROR(SDERR)
"RTN","SDAMA300",133,0)
 Q
"RTN","SDAMA300",134,0)
FMDATE(SDDATE,SDERR) ;
"RTN","SDAMA300",135,0)
 ;dates must be valid internal FileMan format
"RTN","SDAMA300",136,0)
 N X,Y,%H,%T,%Y
"RTN","SDAMA300",137,0)
 S Y=SDDATE D DD^%DT I Y=-1 D ERROR(SDERR)
"RTN","SDAMA300",138,0)
 Q:SDQUIT
"RTN","SDAMA300",139,0)
 ;dates cannot be imprecise
"RTN","SDAMA300",140,0)
 S X=SDDATE D H^%DTC I %H=0 D ERROR(SDERR)
"RTN","SDAMA300",141,0)
 Q
"RTN","SDAMA300",142,0)
CHKDTES(SDFROM,SDTO) ;validate date(/time)s
"RTN","SDAMA300",143,0)
 N SDI,X,Y,%DT
"RTN","SDAMA300",144,0)
 S %DT="STX"
"RTN","SDAMA300",145,0)
 F SDI=SDFROM,SDTO Q:SDQUIT  D
"RTN","SDAMA300",146,0)
 .;valid fileman format
"RTN","SDAMA300",147,0)
 .I $G(SDI)'="" D
"RTN","SDAMA300",148,0)
 ..D FMDATE(SDI,SDERR)
"RTN","SDAMA300",149,0)
 ..Q:SDQUIT
"RTN","SDAMA300",150,0)
 ..;date(/time) must be numeric
"RTN","SDAMA300",151,0)
 ..I SDI'=+(SDI) D ERROR(SDERR)
"RTN","SDAMA300",152,0)
 ..;check for valid dates / leap yr dates
"RTN","SDAMA300",153,0)
 ..I SDI'[9999999 D
"RTN","SDAMA300",154,0)
 ...S X=$$FMTE^XLFDT(SDI)
"RTN","SDAMA300",155,0)
 ...D ^%DT
"RTN","SDAMA300",156,0)
 ...I Y<0 D ERROR(SDERR)
"RTN","SDAMA300",157,0)
 .Q:SDQUIT
"RTN","SDAMA300",158,0)
 Q:SDQUIT
"RTN","SDAMA300",159,0)
 ;from date(/time) can't be after to  date(/time)
"RTN","SDAMA300",160,0)
 I SDFROM>SDTO D ERROR(SDERR)
"RTN","SDAMA300",161,0)
 Q
"RTN","SDAMA300",162,0)
MAX ;Maximum number of appointments requested
"RTN","SDAMA300",163,0)
 ;max can't be 0
"RTN","SDAMA300",164,0)
 N SDMAXAPT,SDPCOUNT,SDCCOUNT
"RTN","SDAMA300",165,0)
 S SDMAXAPT=$G(SDARRAY("MAX"))
"RTN","SDAMA300",166,0)
 S (SDPCOUNT,SDCCOUNT)=0
"RTN","SDAMA300",167,0)
 I $G(SDMAXAPT)]"" D
"RTN","SDAMA300",168,0)
 . ;Check Max Entry
"RTN","SDAMA300",169,0)
 . I +SDMAXAPT'=SDMAXAPT S SDQUIT=1 Q
"RTN","SDAMA300",170,0)
 . I SDMAXAPT=0 S SDQUIT=1 Q
"RTN","SDAMA300",171,0)
 . I SDMAXAPT["." S SDQUIT=1 Q
"RTN","SDAMA300",172,0)
 . ;Verify a SINGLE valid PATIENT &/OR CLINIC Entry
"RTN","SDAMA300",173,0)
 . ;Get Number of Patients passed in
"RTN","SDAMA300",174,0)
 . I SDARRAY("PATGBL")=1 S SDPCOUNT=$$CHKGBL(SDARRAY(4))
"RTN","SDAMA300",175,0)
 . I SDARRAY("PATGBL")=0 S SDPCOUNT=$L(SDARRAY(4),";")
"RTN","SDAMA300",176,0)
 . ;Get Number of Clinics passed in
"RTN","SDAMA300",177,0)
 . I SDARRAY("CLNGBL")=1 S SDCCOUNT=$$CHKGBL(SDARRAY(2))
"RTN","SDAMA300",178,0)
 . I SDARRAY("CLNGBL")=0 S SDCCOUNT=$L(SDARRAY(4),";")
"RTN","SDAMA300",179,0)
 . I (SDPCOUNT>1)!(SDCCOUNT>1) S SDQUIT=1 Q
"RTN","SDAMA300",180,0)
 . I SDPCOUNT=0,SDCCOUNT=0 S SDQUIT=1
"RTN","SDAMA300",181,0)
 I SDQUIT D ERROR(SDERR)
"RTN","SDAMA300",182,0)
 Q
"RTN","SDAMA300",183,0)
 ;
"RTN","SDAMA300",184,0)
FLDS ;Quit if field list is null
"RTN","SDAMA300",185,0)
 N SDFIELDS,SDFIELD
"RTN","SDAMA300",186,0)
 I $G(SDARRAY("FLDS"))="" D ERROR(SDERR)
"RTN","SDAMA300",187,0)
 Q:SDQUIT
"RTN","SDAMA300",188,0)
 S SDFIELDS=SDARRAY("FLDS")
"RTN","SDAMA300",189,0)
 S SDCOUNT=$L(SDFIELDS,";")
"RTN","SDAMA300",190,0)
 F SDI=1:1:SDCOUNT Q:SDQUIT  D
"RTN","SDAMA300",191,0)
 . S SDFIELD=$P(SDFIELDS,";",SDI)
"RTN","SDAMA300",192,0)
 . I (($G(SDFIELD)'?.N)!($G(SDFIELD)<1)!($G(SDFIELD)>SDARRAY("FC"))) D ERROR(SDERR) S SDQUIT=1
"RTN","SDAMA300",193,0)
 Q
"RTN","SDAMA300",194,0)
 ;
"RTN","SDAMA300",195,0)
FLTRS ;Quit if max filters exceeded
"RTN","SDAMA300",196,0)
 N SDFCNT S SDFCNT=0
"RTN","SDAMA300",197,0)
 F SDI=1:1:SDARRAY("FC") D
"RTN","SDAMA300",198,0)
 . I $G(SDARRAY(SDI))]"" S SDFCNT=SDFCNT+1
"RTN","SDAMA300",199,0)
 I SDFCNT>SDARRAY("MF") D ERROR(SDERR) S SDQUIT=1
"RTN","SDAMA300",200,0)
 Q
"RTN","SDAMA300",201,0)
 ;
"RTN","SDAMA300",202,0)
SORT ;Quit if SORT Filter is a value other than P or null
"RTN","SDAMA300",203,0)
 N SDSORT
"RTN","SDAMA300",204,0)
 S SDSORT=$G(SDARRAY("SORT"))
"RTN","SDAMA300",205,0)
 I $G(SDSORT)="" Q
"RTN","SDAMA300",206,0)
 I '($G(SDSORT)="P") D ERROR(SDERR)
"RTN","SDAMA300",207,0)
 Q
"RTN","SDAMA300",208,0)
 ;
"RTN","SDAMA300",209,0)
ERROR(SDERRNUM) ;Generate Error and put in ^TMP global
"RTN","SDAMA300",210,0)
 S SDARRAY("CNT")=-1,SDQUIT=1
"RTN","SDAMA300",211,0)
 S $P(^TMP($J,"SDAMA301",SDERRNUM),"^",1)=$P($T(@SDERRNUM),";;",2)
"RTN","SDAMA300",212,0)
 Q
"RTN","SDAMA300",213,0)
 ;
"RTN","SDAMA300",214,0)
 ;Error code 101 is not used yet
"RTN","SDAMA300",215,0)
101 ;;DATABASE IS UNAVAILABLE
"RTN","SDAMA300",216,0)
115 ;;INVALID INPUT ARRAY ENTRY
"RTN","SDAMA300",217,0)
116 ;;DATA MISMATCH
"RTN","SDAMA300",218,0)
 ;
"RTN","SDAMA300",219,0)
CHKGBL(SDGBL) ;Check Global for number of entries
"RTN","SDAMA300",220,0)
 N SDIEN,SDCOUNT
"RTN","SDAMA300",221,0)
 S (SDIEN,SDCOUNT)=0
"RTN","SDAMA300",222,0)
 F  S SDIEN=$O(@(SDGBL_"SDIEN)"))  Q:(+$G(SDIEN)=0)!(SDCOUNT>2)  D
"RTN","SDAMA300",223,0)
 .S SDCOUNT=SDCOUNT+1
"RTN","SDAMA300",224,0)
 Q SDCOUNT
"RTN","SDAMA301")
0^7^B3523610
"RTN","SDAMA301",1,0)
SDAMA301 ;BPOIFO/ACS-Filter API Main Entry ; 12/13/04 3:21pm
"RTN","SDAMA301",2,0)
 ;;5.3;Scheduling;**301,347**;13 Aug 1993
"RTN","SDAMA301",3,0)
 ;
"RTN","SDAMA301",4,0)
 ;**   BEFORE USING THE API IN THIS ROUTINE, PLEASE SUBSCRIBE    **
"RTN","SDAMA301",5,0)
 ;**   TO DBIA #4433                                             **
"RTN","SDAMA301",6,0)
 ;
"RTN","SDAMA301",7,0)
 ;*****************************************************************
"RTN","SDAMA301",8,0)
 ;              CHANGE LOG
"RTN","SDAMA301",9,0)
 ;
"RTN","SDAMA301",10,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA301",11,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA301",12,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA301",13,0)
 ;08/06/04  SD*5.3*347    ADDITION OF A NEW FILTER - DATE APPOINTMENT
"RTN","SDAMA301",14,0)
 ;                        MADE (FIELD #16) AND 2 NEW FIELDS TO RETURN:
"RTN","SDAMA301",15,0)
 ;                        1) AUTO-REBOOKED APPT DATE/TIME (FIELD #24)
"RTN","SDAMA301",16,0)
 ;                        2) NO-SHOW/CANCEL APPT DATE/TIME (FIELD #25)
"RTN","SDAMA301",17,0)
 ;                        INCREASE NUMBER OF FILTERS ALLOWED TO 6
"RTN","SDAMA301",18,0)
 ;*****************************************************************
"RTN","SDAMA301",19,0)
 ;
"RTN","SDAMA301",20,0)
 ;*****************************************************************
"RTN","SDAMA301",21,0)
 ;
"RTN","SDAMA301",22,0)
 ;               GET APPOINTMENT DATA
"RTN","SDAMA301",23,0)
 ;
"RTN","SDAMA301",24,0)
 ;INPUT
"RTN","SDAMA301",25,0)
 ;  SDINPUT   Appointment Filters (required)
"RTN","SDAMA301",26,0)
 ;  
"RTN","SDAMA301",27,0)
 ;OUTPUT
"RTN","SDAMA301",28,0)
 ;    Extrinsic call returns: 
"RTN","SDAMA301",29,0)
 ;      -1 if error
"RTN","SDAMA301",30,0)
 ;      Appointment count if no error
"RTN","SDAMA301",31,0)
 ;    If no error, data returned in:
"RTN","SDAMA301",32,0)
 ;      ^TMP($J,"SDAMA301",SORT1,SORT2,Appt Date/Time)=DATAn^DATAn^..
"RTN","SDAMA301",33,0)
 ;      where SORT1 is first sort (patient or clinic), SORT2 is
"RTN","SDAMA301",34,0)
 ;      second sort (patient or clnic), and DATAn
"RTN","SDAMA301",35,0)
 ;      is the appointment data requested
"RTN","SDAMA301",36,0)
 ;    If erors, error codes and messages returned in:
"RTN","SDAMA301",37,0)
 ;      ^TMP($J,"SDAMA301","ERROR",error_code)=error_message
"RTN","SDAMA301",38,0)
 ;  
"RTN","SDAMA301",39,0)
 ;*****************************************************************
"RTN","SDAMA301",40,0)
SDAPI(SDINPUT) ;
"RTN","SDAMA301",41,0)
 K ^TMP($J,"SDAMA301")
"RTN","SDAMA301",42,0)
 ;Initialize global variables
"RTN","SDAMA301",43,0)
 N SDDV,SDI,SDARRAY,SDQUIT,SDFLTR,SDTEMP
"RTN","SDAMA301",44,0)
 S (SDARRAY("CNT"),SDARRAY("RSA"),SDQUIT,SDFLTR,SDTEMP)=0
"RTN","SDAMA301",45,0)
 ;Set Field Count and Max Filter variables
"RTN","SDAMA301",46,0)
 S SDARRAY("FC")=25,SDARRAY("MF")=6
"RTN","SDAMA301",47,0)
 ;Copy input array into "working" array
"RTN","SDAMA301",48,0)
 F SDI=1:1:SDARRAY("FC") S SDARRAY(SDI)=$G(SDINPUT(SDI))
"RTN","SDAMA301",49,0)
 S SDARRAY("FLDS")=$G(SDINPUT("FLDS"))
"RTN","SDAMA301",50,0)
 S SDARRAY("MAX")=$G(SDINPUT("MAX"))
"RTN","SDAMA301",51,0)
 S SDARRAY("SORT")=$G(SDINPUT("SORT"))
"RTN","SDAMA301",52,0)
 ;Initialize Input Array Filters as needed. Quit if error
"RTN","SDAMA301",53,0)
 D INITAE^SDAMA306(.SDARRAY)
"RTN","SDAMA301",54,0)
 Q:SDQUIT -1
"RTN","SDAMA301",55,0)
 ;Validate Input Array Filters.  Quit if error
"RTN","SDAMA301",56,0)
 I ($$VALARR^SDAMA300(.SDARRAY,.SDFLTR)=-1) S SDQUIT=1
"RTN","SDAMA301",57,0)
 Q:SDQUIT -1
"RTN","SDAMA301",58,0)
 ;
"RTN","SDAMA301",59,0)
 ;If Patient DFN populated, process by patient
"RTN","SDAMA301",60,0)
 I $G(SDARRAY(4))]"" D
"RTN","SDAMA301",61,0)
 . ;set RSA flag to true
"RTN","SDAMA301",62,0)
 . S SDARRAY("RSA")=1
"RTN","SDAMA301",63,0)
 . ;get data
"RTN","SDAMA301",64,0)
 . D PAT^SDAMA303(.SDARRAY,.SDDV,.SDFLTR)
"RTN","SDAMA301",65,0)
 ;
"RTN","SDAMA301",66,0)
 ;If Patient DFN is not populated, process by clinic
"RTN","SDAMA301",67,0)
 I $G(SDARRAY(4))']"" D
"RTN","SDAMA301",68,0)
 . D CLIN^SDAMA302(.SDARRAY,.SDDV,.SDFLTR)
"RTN","SDAMA301",69,0)
 ;
"RTN","SDAMA301",70,0)
 ;--Phase II--
"RTN","SDAMA301",71,0)
 N SDRSA
"RTN","SDAMA301",72,0)
 S SDRSA=0
"RTN","SDAMA301",73,0)
 ;If RSA flag = "true" and RSA implemented, get data from RSA
"RTN","SDAMA301",74,0)
 I SDARRAY("RSA"),$$IMP^SDAMA307(1) D DATA^SDAMA307(.SDARRAY)
"RTN","SDAMA301",75,0)
 ;
"RTN","SDAMA301",76,0)
 ;Pass back appointment count
"RTN","SDAMA301",77,0)
 Q SDARRAY("CNT")
"RTN","SDAMA302")
0^8^B24026521
"RTN","SDAMA302",1,0)
SDAMA302 ;BPOIFO/ACS-Filter API By Clinic ;04 Dec 2003 [5/18/04 10:58am]
"RTN","SDAMA302",2,0)
 ;;5.3;Scheduling;**301,347**;13 Aug 1993
"RTN","SDAMA302",3,0)
 ;
"RTN","SDAMA302",4,0)
 ;*****************************************************************
"RTN","SDAMA302",5,0)
 ;              CHANGE LOG
"RTN","SDAMA302",6,0)
 ;
"RTN","SDAMA302",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA302",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA302",9,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA302",10,0)
 ;08/06/04  SD*5.3*347    CHANGE CALL TO ^SDAMA305 TO SETARRAY
"RTN","SDAMA302",11,0)
 ;
"RTN","SDAMA302",12,0)
 ;*****************************************************************
"RTN","SDAMA302",13,0)
 ;
"RTN","SDAMA302",14,0)
 ;*****************************************************************
"RTN","SDAMA302",15,0)
 ;
"RTN","SDAMA302",16,0)
 ;               GET APPOINTMENT DATA BY CLINIC
"RTN","SDAMA302",17,0)
 ;
"RTN","SDAMA302",18,0)
 ;INPUT
"RTN","SDAMA302",19,0)
 ;  SDARRAY   Appointment Filter array
"RTN","SDAMA302",20,0)
 ;  SDDV      Appointment Data Values array
"RTN","SDAMA302",21,0)
 ;  SDFLTR    Filter Flags array
"RTN","SDAMA302",22,0)
 ;  
"RTN","SDAMA302",23,0)
 ;OUTPUT
"RTN","SDAMA302",24,0)
 ;  
"RTN","SDAMA302",25,0)
 ;*****************************************************************
"RTN","SDAMA302",26,0)
CLIN(SDARRAY,SDDV,SDFLTR) ;
"RTN","SDAMA302",27,0)
 N SDCOUNT,SDX,SDQUIT,SDCLIEN,SDSTART,SDEND,SDCLMIG,SDGBL
"RTN","SDAMA302",28,0)
 S (SDCOUNT,SDQUIT)=0
"RTN","SDAMA302",29,0)
 ;Set up start and end date/times for search criteria
"RTN","SDAMA302",30,0)
 I $G(SDARRAY("MAX"))'<0  D
"RTN","SDAMA302",31,0)
 .S SDSTART=$S(SDARRAY("FR")'="":(SDARRAY("FR")-.000001),1:0)
"RTN","SDAMA302",32,0)
 .S SDEND=SDARRAY("TO")
"RTN","SDAMA302",33,0)
 I $G(SDARRAY("MAX"))<0  D
"RTN","SDAMA302",34,0)
 .S SDSTART=$S($G(SDARRAY("FR"))'="":SDARRAY("FR"),1:0)
"RTN","SDAMA302",35,0)
 .S SDEND=(SDARRAY("TO")+.000001)
"RTN","SDAMA302",36,0)
 ;
"RTN","SDAMA302",37,0)
 ;If clinic filter is populated
"RTN","SDAMA302",38,0)
 I $L($G(SDARRAY(2)))>0 D
"RTN","SDAMA302",39,0)
 . ;if clinic is in a list:
"RTN","SDAMA302",40,0)
 . I SDARRAY("CLNGBL")=0 D
"RTN","SDAMA302",41,0)
 .. S SDCOUNT=$L(SDARRAY(2),";")
"RTN","SDAMA302",42,0)
 .. ;For each clinic in the filter:
"RTN","SDAMA302",43,0)
 .. F SDX=1:1:SDCOUNT D
"RTN","SDAMA302",44,0)
 ... S SDCLIEN=$P(SDARRAY(2),";",SDX)
"RTN","SDAMA302",45,0)
 ... D MIG(SDCLIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA302",46,0)
 . ;if clinic is in array, get IENs
"RTN","SDAMA302",47,0)
 . I SDARRAY("CLNGBL")=1 D
"RTN","SDAMA302",48,0)
 .. S SDGBL=SDARRAY(2),SDCLIEN=0
"RTN","SDAMA302",49,0)
 .. ;for each clinic in the global:
"RTN","SDAMA302",50,0)
 .. F  S SDCLIEN=$O(@(SDGBL_"SDCLIEN)")) Q:$G(SDCLIEN)=""  D
"RTN","SDAMA302",51,0)
 ... D MIG(SDCLIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA302",52,0)
 ;
"RTN","SDAMA302",53,0)
 ;If clinic filter is not populated
"RTN","SDAMA302",54,0)
 I $L(SDARRAY(2))'>0 D
"RTN","SDAMA302",55,0)
 . ;for each clinic on ^SC
"RTN","SDAMA302",56,0)
 . S SDCLIEN=0 F  S SDCLIEN=$O(^SC(SDCLIEN)) Q:(+$G(SDCLIEN)=0)  D
"RTN","SDAMA302",57,0)
 .. S SDARRAY("CLIN")=SDCLIEN
"RTN","SDAMA302",58,0)
 .. S SDCLMIG=$$CLMIG^SDAMA307(SDCLIEN)
"RTN","SDAMA302",59,0)
 .. ;if clinic has migrated, set flag else get appointment data
"RTN","SDAMA302",60,0)
 .. I SDCLMIG S SDARRAY("RSA")=1
"RTN","SDAMA302",61,0)
 .. E  D GETAPPT(SDCLIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA302",62,0)
 Q
"RTN","SDAMA302",63,0)
 ;
"RTN","SDAMA302",64,0)
MIG(SDCLIEN,SDSTART,SDEND,SDARRAY) ;
"RTN","SDAMA302",65,0)
 S SDCLMIG=$$CLMIG^SDAMA307(SDCLIEN)
"RTN","SDAMA302",66,0)
 ;if the clinic has migrated, add to list of migrated clinics else get appointment data
"RTN","SDAMA302",67,0)
 I SDCLMIG S SDARRAY("RSA")=1,SDARRAY("MIG")=$S($G(SDARRAY("MIG"))="":SDCLIEN,1:SDARRAY("MIG")_";"_SDCLIEN)
"RTN","SDAMA302",68,0)
 E  D
"RTN","SDAMA302",69,0)
 . S SDARRAY("CLIN")=SDCLIEN
"RTN","SDAMA302",70,0)
 . D GETAPPT(SDCLIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA302",71,0)
 Q
"RTN","SDAMA302",72,0)
 ;
"RTN","SDAMA302",73,0)
GETAPPT(SDCLIEN,SDSTART,SDEND,SDARRAY) ;
"RTN","SDAMA302",74,0)
 ;since "by clinic", 1st sort is clinic
"RTN","SDAMA302",75,0)
 S SDARRAY("SORT1")=SDCLIEN
"RTN","SDAMA302",76,0)
 N SDAPPTDT,SDA
"RTN","SDAMA302",77,0)
 ;if the current clinic has no appointments on ^SC, get next clinic
"RTN","SDAMA302",78,0)
 Q:'$D(^SC(SDCLIEN,"S"))
"RTN","SDAMA302",79,0)
 ;
"RTN","SDAMA302",80,0)
 ;
"RTN","SDAMA302",81,0)
 ;get first "N" appointments
"RTN","SDAMA302",82,0)
 I $G(SDARRAY("MAX"))'<0  D
"RTN","SDAMA302",83,0)
 .S SDAPPTDT=SDSTART
"RTN","SDAMA302",84,0)
 .;spin through each date/time for current clinic
"RTN","SDAMA302",85,0)
 .F  S SDAPPTDT=$O(^SC(SDCLIEN,"S",SDAPPTDT)) Q:$S(+$G(SDAPPTDT)=0:1,SDAPPTDT>SDEND:1,SDARRAY("CNT")=$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA302",86,0)
 .. ;spin through each appointment for that date/time
"RTN","SDAMA302",87,0)
 .. S SDA=0 F  S SDA=$O(^SC(SDCLIEN,"S",SDAPPTDT,1,SDA)) Q:$S(+$G(SDA)=0:1,SDARRAY("CNT")=$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA302",88,0)
 ... D GETINFO(SDCLIEN,SDAPPTDT,SDA,.SDARRAY)
"RTN","SDAMA302",89,0)
 ;
"RTN","SDAMA302",90,0)
 ;get last "N" appointments
"RTN","SDAMA302",91,0)
 I $G(SDARRAY("MAX"))<0  D
"RTN","SDAMA302",92,0)
 .S SDAPPTDT=SDEND
"RTN","SDAMA302",93,0)
 .;spin through each date/time for current clinic (REVERSE Order)
"RTN","SDAMA302",94,0)
 .F  S SDAPPTDT=$O(^SC(SDCLIEN,"S",SDAPPTDT),-1) Q:$S(+$G(SDAPPTDT)=0:1,SDAPPTDT<SDSTART:1,SDARRAY("CNT")=-$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA302",95,0)
 .. ;spin through each appointment for that date/time (REVERSE Order)
"RTN","SDAMA302",96,0)
 .. S SDA="" F  S SDA=$O(^SC(SDCLIEN,"S",SDAPPTDT,1,SDA),-1) Q:$S(+$G(SDA)=0:1,SDARRAY("CNT")=-$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA302",97,0)
 ... D GETINFO(SDCLIEN,SDAPPTDT,SDA,.SDARRAY)
"RTN","SDAMA302",98,0)
 Q
"RTN","SDAMA302",99,0)
 ;
"RTN","SDAMA302",100,0)
GETINFO(SDCLIEN,SDAPPTDT,SDA,SDARRAY) ;
"RTN","SDAMA302",101,0)
 N SDPATIEN,SDCAN,SDQUIT
"RTN","SDAMA302",102,0)
 S SDQUIT=0
"RTN","SDAMA302",103,0)
 ;get appointment data on ^SC
"RTN","SDAMA302",104,0)
 S SDARRAY("SC0")=$G(^SC(SDCLIEN,"S",SDAPPTDT,1,SDA,0))
"RTN","SDAMA302",105,0)
 S SDARRAY("SCC")=$G(^SC(SDCLIEN,"S",SDAPPTDT,1,SDA,"C"))
"RTN","SDAMA302",106,0)
 S SDARRAY("SCOB")=$G(^SC(SDCLIEN,"S",SDAPPTDT,1,SDA,"OB"))
"RTN","SDAMA302",107,0)
 S SDARRAY("DATE")=SDAPPTDT
"RTN","SDAMA302",108,0)
 ;exclude cancelled appts
"RTN","SDAMA302",109,0)
 S SDCAN=$P($G(SDARRAY("SC0")),"^",9)
"RTN","SDAMA302",110,0)
 Q:$G(SDCAN)="C"
"RTN","SDAMA302",111,0)
 ;initialize patient appointment data to null and get patient DFN
"RTN","SDAMA302",112,0)
 S (SDARRAY("DPT0"),SDARRAY("DPT1"))=""
"RTN","SDAMA302",113,0)
 S (SDPATIEN,SDARRAY("PAT"))=+SDARRAY("SC0")
"RTN","SDAMA302",114,0)
 ;quit if patient is null on ^SC
"RTN","SDAMA302",115,0)
 Q:SDPATIEN=0
"RTN","SDAMA302",116,0)
 ;since "by clinic", 2nd sort is patient
"RTN","SDAMA302",117,0)
 S SDARRAY("SORT2")=SDPATIEN
"RTN","SDAMA302",118,0)
 ;get corresponding appt zero node on ^DPT
"RTN","SDAMA302",119,0)
 S SDARRAY("DPT0")=$G(^DPT(SDPATIEN,"S",SDAPPTDT,0))
"RTN","SDAMA302",120,0)
 ;skip if appointment is cancelled on DPT
"RTN","SDAMA302",121,0)
 Q:($P($G(SDARRAY("DPT0")),"^",2)["C")
"RTN","SDAMA302",122,0)
 ;skip if appointment on DPT is for different clinic
"RTN","SDAMA302",123,0)
 Q:(+$G(SDARRAY("DPT0"))'=SDCLIEN)
"RTN","SDAMA302",124,0)
 ;get appointment 1 node on ^DPT
"RTN","SDAMA302",125,0)
 S SDARRAY("DPT1")=$G(^DPT(SDPATIEN,"S",SDAPPTDT,1))
"RTN","SDAMA302",126,0)
 ;appointment must match the "clinic" filter values
"RTN","SDAMA302",127,0)
 I $$MATCH^SDAMA304("C",.SDARRAY,.SDFLTR,.SDDV) D
"RTN","SDAMA302",128,0)
 . ;if appointment matches the "patient" filter values, put appointment data into output array
"RTN","SDAMA302",129,0)
 . I $$MATCH^SDAMA304("P",.SDARRAY,.SDFLTR,.SDDV) D SETARRAY^SDAMA305(.SDFLTR,.SDARRAY)
"RTN","SDAMA302",130,0)
 Q
"RTN","SDAMA303")
0^9^B22767510
"RTN","SDAMA303",1,0)
SDAMA303 ;BPOIFO/ACS-Filter API By Patient ;04 Dec 2003
"RTN","SDAMA303",2,0)
 ;;5.3;Scheduling;**301,347**;13 Aug 1993
"RTN","SDAMA303",3,0)
 ;
"RTN","SDAMA303",4,0)
 ;*****************************************************************
"RTN","SDAMA303",5,0)
 ;              CHANGE LOG
"RTN","SDAMA303",6,0)
 ;
"RTN","SDAMA303",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA303",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA303",9,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA303",10,0)
 ;08/06/04  SD*5.3*347    CHANGE CALL TO ^SDAMA305 TO SETARRAY
"RTN","SDAMA303",11,0)
 ;
"RTN","SDAMA303",12,0)
 ;*****************************************************************
"RTN","SDAMA303",13,0)
 ;
"RTN","SDAMA303",14,0)
 ;*****************************************************************
"RTN","SDAMA303",15,0)
 ;
"RTN","SDAMA303",16,0)
 ;               GET APPOINTMENT DATA BY PATIENT
"RTN","SDAMA303",17,0)
 ;
"RTN","SDAMA303",18,0)
 ;INPUT
"RTN","SDAMA303",19,0)
 ;  SDARRAY   Appointment Filter array
"RTN","SDAMA303",20,0)
 ;  SDDV      Appointment Data Values array
"RTN","SDAMA303",21,0)
 ;  SDFLTR    Filter Flags array
"RTN","SDAMA303",22,0)
 ;  
"RTN","SDAMA303",23,0)
 ;*****************************************************************
"RTN","SDAMA303",24,0)
PAT(SDARRAY,SDDV,SDFLTR) ;
"RTN","SDAMA303",25,0)
 N SDCOUNT,SDX,SDQUIT,SDPATIEN,SDSTART,SDEND,SDGBL
"RTN","SDAMA303",26,0)
 S (SDCOUNT,SDQUIT)=0
"RTN","SDAMA303",27,0)
 ;Set up start and end date/times for search criteria
"RTN","SDAMA303",28,0)
 I $G(SDARRAY("MAX"))'<0  D
"RTN","SDAMA303",29,0)
 .S SDSTART=$S(SDARRAY("FR")'="":(SDARRAY("FR")-.000001),1:0)
"RTN","SDAMA303",30,0)
 .S SDEND=(SDARRAY("TO"))
"RTN","SDAMA303",31,0)
 I $G(SDARRAY("MAX"))<0  D
"RTN","SDAMA303",32,0)
 .S SDSTART=$S($G(SDARRAY("FR"))'="":SDARRAY("FR"),1:0)
"RTN","SDAMA303",33,0)
 .S SDEND=(SDARRAY("TO")+.000001)
"RTN","SDAMA303",34,0)
 ;
"RTN","SDAMA303",35,0)
 ;if patient is not in global, get patient from filter list
"RTN","SDAMA303",36,0)
 I SDARRAY("PATGBL")=0 D
"RTN","SDAMA303",37,0)
 . S SDCOUNT=$L(SDARRAY(4),";")
"RTN","SDAMA303",38,0)
 . ;for each patient in the filter:
"RTN","SDAMA303",39,0)
 . F SDX=1:1:SDCOUNT D
"RTN","SDAMA303",40,0)
 .. S SDPATIEN=$P(SDARRAY(4),";",SDX)
"RTN","SDAMA303",41,0)
 .. D GETAPPT(SDPATIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA303",42,0)
 ;if patient is in global, get patient from global
"RTN","SDAMA303",43,0)
 I SDARRAY("PATGBL")=1 D
"RTN","SDAMA303",44,0)
 . S SDGBL=SDARRAY(4),SDPATIEN=0
"RTN","SDAMA303",45,0)
 . ;for each patient in the global:
"RTN","SDAMA303",46,0)
 . F  S SDPATIEN=$O(@(SDGBL_"SDPATIEN)")) Q:+$G(SDPATIEN)=0  D
"RTN","SDAMA303",47,0)
 .. D GETAPPT(SDPATIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA303",48,0)
 Q
"RTN","SDAMA303",49,0)
 ;
"RTN","SDAMA303",50,0)
GETAPPT(SDPATIEN,SDSTART,SDEND,SDARRAY) ;
"RTN","SDAMA303",51,0)
 ;if the patient has no appointments on ^DPT, get next patient
"RTN","SDAMA303",52,0)
 Q:'$D(^DPT(SDPATIEN,"S"))
"RTN","SDAMA303",53,0)
 ;since "by patient", 1st sort is patient
"RTN","SDAMA303",54,0)
 S (SDARRAY("SORT1"),SDARRAY("PAT"))=SDPATIEN
"RTN","SDAMA303",55,0)
 N SDAPPTDT
"RTN","SDAMA303",56,0)
 ;
"RTN","SDAMA303",57,0)
 ;get first "N" appointments
"RTN","SDAMA303",58,0)
 I $G(SDARRAY("MAX"))'<0  D
"RTN","SDAMA303",59,0)
 .S SDAPPTDT=SDSTART
"RTN","SDAMA303",60,0)
 .;Spin through each appointment on DPT for current patient
"RTN","SDAMA303",61,0)
 .F  S SDAPPTDT=$O(^DPT(SDPATIEN,"S",SDAPPTDT)) Q:$S(+$G(SDAPPTDT)=0:1,SDAPPTDT>SDEND:1,SDARRAY("CNT")=$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA303",62,0)
 .. D GETINFO(SDPATIEN,SDAPPTDT,.SDARRAY)
"RTN","SDAMA303",63,0)
 ;
"RTN","SDAMA303",64,0)
 ;get last "N" appointments
"RTN","SDAMA303",65,0)
 I $G(SDARRAY("MAX"))<0  D
"RTN","SDAMA303",66,0)
 .S SDAPPTDT=SDEND
"RTN","SDAMA303",67,0)
 .;spin through each appointment on DPT for current patient (REVERSE Order)
"RTN","SDAMA303",68,0)
 .F  S SDAPPTDT=$O(^DPT(SDPATIEN,"S",SDAPPTDT),-1) Q:$S(+$G(SDAPPTDT)=0:1,SDAPPTDT<SDSTART:1,SDARRAY("CNT")=-$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA303",69,0)
 .. D GETINFO(SDPATIEN,SDAPPTDT,.SDARRAY)
"RTN","SDAMA303",70,0)
 Q
"RTN","SDAMA303",71,0)
 ;
"RTN","SDAMA303",72,0)
GETINFO(SDPATIEN,SDAPPTDT,SDARRAY) ;
"RTN","SDAMA303",73,0)
 N SDMATCH,SDCLINIC,SDA,SDQUIT
"RTN","SDAMA303",74,0)
 S SDQUIT=0
"RTN","SDAMA303",75,0)
 ; initialize array to hold data values
"RTN","SDAMA303",76,0)
 S SDARRAY("DPT0")=$G(^DPT(SDPATIEN,"S",SDAPPTDT,0))
"RTN","SDAMA303",77,0)
 S SDARRAY("DPT1")=$G(^DPT(SDPATIEN,"S",SDAPPTDT,1))
"RTN","SDAMA303",78,0)
 S SDARRAY("DATE")=SDAPPTDT
"RTN","SDAMA303",79,0)
 ;appointment must match the "patient" filter values
"RTN","SDAMA303",80,0)
 I $$MATCH^SDAMA304("P",.SDARRAY,.SDFLTR,.SDDV) D
"RTN","SDAMA303",81,0)
 . ;set clinic appointment data to null and get clinic
"RTN","SDAMA303",82,0)
 . S (SDARRAY("SC0"),SDARRAY("SCC"),SDARRAY("SCOB"))=""
"RTN","SDAMA303",83,0)
 . S SDCLINIC=+$G(SDARRAY("DPT0"))
"RTN","SDAMA303",84,0)
 . ;quit if clinic is null(0)
"RTN","SDAMA303",85,0)
 . Q:SDCLINIC=0
"RTN","SDAMA303",86,0)
 . S SDARRAY("CLIN")=SDCLINIC
"RTN","SDAMA303",87,0)
 . ;since "by patient", 2nd sort is clinic
"RTN","SDAMA303",88,0)
 . S SDARRAY("SORT2")=SDCLINIC
"RTN","SDAMA303",89,0)
 . ;make sure clinic has not migrated
"RTN","SDAMA303",90,0)
 . Q:($$CLMIG^SDAMA307(SDCLINIC))
"RTN","SDAMA303",91,0)
 . S SDMATCH=1
"RTN","SDAMA303",92,0)
 . ;if appointment is not cancelled on ^DPT, find corresponding appt on ^SC
"RTN","SDAMA303",93,0)
 . ;and get data
"RTN","SDAMA303",94,0)
 . I ";C;CA;PC;PCA;"'[(";"_$P($G(SDARRAY("DPT0")),"^",2)_";") D
"RTN","SDAMA303",95,0)
 .. N SDCANCEL
"RTN","SDAMA303",96,0)
 .. S SDQUIT=0,SDA=0,SDMATCH=0
"RTN","SDAMA303",97,0)
 .. ;for current clinic and appt d/t, find matching appt on ^SC
"RTN","SDAMA303",98,0)
 .. F  S SDA=$O(^SC(SDCLINIC,"S",SDAPPTDT,1,SDA)) Q:(($G(SDA)="")!(SDQUIT=1))  D
"RTN","SDAMA303",99,0)
 ... S SDCANCEL=0
"RTN","SDAMA303",100,0)
 ... ;get next appt if patient doesn't match
"RTN","SDAMA303",101,0)
 ... Q:(+$G(^SC(SDCLINIC,"S",SDAPPTDT,1,SDA,0))'=SDPATIEN)
"RTN","SDAMA303",102,0)
 ... ;get appointment data on ^SC
"RTN","SDAMA303",103,0)
 ... S SDARRAY("SC0")=$G(^SC(SDCLINIC,"S",SDAPPTDT,1,SDA,0))
"RTN","SDAMA303",104,0)
 ... ;get next appt if cancelled on SC
"RTN","SDAMA303",105,0)
 ... S SDCANCEL=$P($G(SDARRAY("SC0")),"^",9)
"RTN","SDAMA303",106,0)
 ... Q:($G(SDCANCEL)="C")
"RTN","SDAMA303",107,0)
 ... ;get appointment "C" node on ^SC
"RTN","SDAMA303",108,0)
 ... S SDARRAY("SCC")=$G(^SC(SDCLINIC,"S",SDAPPTDT,1,SDA,"C"))
"RTN","SDAMA303",109,0)
 ... ;get appointment "OB" node on ^SC
"RTN","SDAMA303",110,0)
 ... S SDARRAY("SCOB")=$G(^SC(SDCLINIC,"S",SDAPPTDT,1,SDA,"OB"))
"RTN","SDAMA303",111,0)
 ... ;Corresponding appointment found on ^SC
"RTN","SDAMA303",112,0)
 ... S SDQUIT=1,SDMATCH=1
"RTN","SDAMA303",113,0)
 . ;if appointment matches the clinic filters, put appointment data into output array
"RTN","SDAMA303",114,0)
 . I SDMATCH D
"RTN","SDAMA303",115,0)
 .. I $$MATCH^SDAMA304("C",.SDARRAY,.SDFLTR,.SDDV) D SETARRAY^SDAMA305(.SDFLTR,.SDARRAY)
"RTN","SDAMA303",116,0)
 Q
"RTN","SDAMA304")
0^10^B8330866
"RTN","SDAMA304",1,0)
SDAMA304 ;BPOIFO/ACS-Filter API Apply Filters ; 8/10/04 2:29pm
"RTN","SDAMA304",2,0)
 ;;5.3;Scheduling;**301,347**;13 Aug 1993
"RTN","SDAMA304",3,0)
 ;
"RTN","SDAMA304",4,0)
 ;*****************************************************************
"RTN","SDAMA304",5,0)
 ;              CHANGE LOG
"RTN","SDAMA304",6,0)
 ;
"RTN","SDAMA304",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA304",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA304",9,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA304",10,0)
 ;08/06/04  SD*5.3*347    ADDITION OF A NEW FILTER - DATE APPOINTMENT
"RTN","SDAMA304",11,0)
 ;                        MADE (FIELD #16) AND 2 NEW FIELDS TO RETURN:
"RTN","SDAMA304",12,0)
 ;                        1) AUTO-REBOOKED APPT DATE/TIME (FIELD #24)
"RTN","SDAMA304",13,0)
 ;                        2) NO-SHOW/CANCEL APPT DATE/TIME (FIELD #25)
"RTN","SDAMA304",14,0)
 ;
"RTN","SDAMA304",15,0)
 ;*****************************************************************
"RTN","SDAMA304",16,0)
 ;
"RTN","SDAMA304",17,0)
 ;*****************************************************************
"RTN","SDAMA304",18,0)
 ;
"RTN","SDAMA304",19,0)
 ;                  APPLY FILTERS (Extrinsic call)
"RTN","SDAMA304",20,0)
 ;
"RTN","SDAMA304",21,0)
 ;INPUT
"RTN","SDAMA304",22,0)
 ;  SDFTYPE    Filter Type (P-patient or C-clinic)
"RTN","SDAMA304",23,0)
 ;  SDARRAY    Appointment Filter array
"RTN","SDAMA304",24,0)
 ;  SDFLTR     Filter Flags array
"RTN","SDAMA304",25,0)
 ;  SDDV       Appointment Data Values array
"RTN","SDAMA304",26,0)
 ;  
"RTN","SDAMA304",27,0)
 ;OUTPUT
"RTN","SDAMA304",28,0)
 ;  SDMATCH   -1 if no match
"RTN","SDAMA304",29,0)
 ;             1 if match
"RTN","SDAMA304",30,0)
 ;*****************************************************************
"RTN","SDAMA304",31,0)
MATCH(SDFTYPE,SDARRAY,SDFLTR,SDDV) ;
"RTN","SDAMA304",32,0)
 N SDMATCH,SDX,SDCLIEN
"RTN","SDAMA304",33,0)
 S SDMATCH=0
"RTN","SDAMA304",34,0)
 ;apply patient or clinic filters
"RTN","SDAMA304",35,0)
 I SDFTYPE="P" D PMATCH(.SDARRAY,.SDMATCH)
"RTN","SDAMA304",36,0)
 I SDFTYPE="C" D CMATCH(.SDARRAY,.SDMATCH)
"RTN","SDAMA304",37,0)
 Q SDMATCH
"RTN","SDAMA304",38,0)
PMATCH(SDARRAY,SDMATCH) ;Apply ^DPT-related filters
"RTN","SDAMA304",39,0)
 S SDMATCH=1
"RTN","SDAMA304",40,0)
 ;Clinic
"RTN","SDAMA304",41,0)
 I SDFLTR(2) D
"RTN","SDAMA304",42,0)
 . S SDDV(2)=$P($G(SDARRAY("DPT0")),"^",1)
"RTN","SDAMA304",43,0)
 . I SDDV(2)']"" S SDMATCH=0 Q
"RTN","SDAMA304",44,0)
 . ;apply filter to list or global
"RTN","SDAMA304",45,0)
 . I SDARRAY("CLNGBL")=1 D
"RTN","SDAMA304",46,0)
 .. S SDX=SDARRAY(2),SDCLIEN=SDDV(2)
"RTN","SDAMA304",47,0)
 .. I '$D(@(SDX_"SDCLIEN)")) S SDMATCH=0
"RTN","SDAMA304",48,0)
 . I SDARRAY("CLNGBL")=0 D
"RTN","SDAMA304",49,0)
 .. I ((";"_$G(SDARRAY(2))_";")'[(";"_SDDV(2)_";")) S SDMATCH=0
"RTN","SDAMA304",50,0)
 Q:'SDMATCH
"RTN","SDAMA304",51,0)
 ;Appointment Status
"RTN","SDAMA304",52,0)
 I SDFLTR(3) D
"RTN","SDAMA304",53,0)
 . N SDSTAT,SDTEMP
"RTN","SDAMA304",54,0)
 . S SDTEMP=$P($G(SDARRAY("DPT0")),"^",2)
"RTN","SDAMA304",55,0)
 . S SDSTAT=$S($G(SDTEMP)="":"R",SDTEMP="I":"I",SDTEMP="C":"CC",1:"X")
"RTN","SDAMA304",56,0)
 . I SDSTAT="X" S SDSTAT=$S(SDTEMP="CA":"CCR",SDTEMP="PC":"CP",1:"X")
"RTN","SDAMA304",57,0)
 . I SDSTAT="X" S SDSTAT=$S(SDTEMP="PCA":"CPR",SDTEMP="N":"NS",1:"X")
"RTN","SDAMA304",58,0)
 . I SDSTAT="X" S SDSTAT=$S(SDTEMP="NA":"NSR",SDTEMP="NT":"NT",1:"X")
"RTN","SDAMA304",59,0)
 . S SDDV(3)=SDSTAT
"RTN","SDAMA304",60,0)
 . I ((";"_$G(SDARRAY(3))_";")'[(";"_SDDV(3)_";")) S SDMATCH=0
"RTN","SDAMA304",61,0)
 Q:'SDMATCH
"RTN","SDAMA304",62,0)
 ;Date Appointment Made
"RTN","SDAMA304",63,0)
 I SDFLTR(16) D
"RTN","SDAMA304",64,0)
 .;get date appointment made from specific appt
"RTN","SDAMA304",65,0)
 .S SDDV(16)=$P($G(SDARRAY("DPT0")),"^",19)
"RTN","SDAMA304",66,0)
 .;compare date with range of dates specified
"RTN","SDAMA304",67,0)
 .I $S(+SDDV(16)=SDARRAY("DAMFR"):0,+SDDV(16)=SDARRAY("DAMTO"):0,1:1) D
"RTN","SDAMA304",68,0)
 ..I ((+SDDV(16)'>SDARRAY("DAMFR"))!(+SDDV(16)'<SDARRAY("DAMTO"))) D
"RTN","SDAMA304",69,0)
 ...S SDMATCH=0
"RTN","SDAMA304",70,0)
 Q
"RTN","SDAMA304",71,0)
 ;       
"RTN","SDAMA304",72,0)
CMATCH(SDARRAY,SDMATCH) ;Apply ^SC-related filters
"RTN","SDAMA304",73,0)
 N SDAMCLIN,SDSTOP
"RTN","SDAMA304",74,0)
 S SDMATCH=1
"RTN","SDAMA304",75,0)
 ;Primary Stop Code
"RTN","SDAMA304",76,0)
 I SDFLTR(13) D
"RTN","SDAMA304",77,0)
 . S SDAMCLIN=+$G(SDARRAY("DPT0"))
"RTN","SDAMA304",78,0)
 . I $G(SDAMCLIN)="" S SDMATCH=0 Q
"RTN","SDAMA304",79,0)
 . S SDSTOP=$P($G(^SC(SDAMCLIN,0)),"^",7)
"RTN","SDAMA304",80,0)
 . I $G(SDSTOP)="" S SDMATCH=0 Q
"RTN","SDAMA304",81,0)
 . S SDDV(13)=$P($G(^DIC(40.7,SDSTOP,0)),"^",2)
"RTN","SDAMA304",82,0)
 . I $G(SDDV(13))="" S SDMATCH=0 Q
"RTN","SDAMA304",83,0)
 . I ((";"_$G(SDARRAY(13))_";")'[(";"_SDDV(13)_";")) S SDMATCH=0
"RTN","SDAMA304",84,0)
 Q
"RTN","SDAMA305")
0^11^B43200965
"RTN","SDAMA305",1,0)
SDAMA305 ;BPOIFO/ACS-Filter API Get Data ; 8/10/04 2:35pm
"RTN","SDAMA305",2,0)
 ;;5.3;Scheduling;**301,347**;13 Aug 1993
"RTN","SDAMA305",3,0)
 ;
"RTN","SDAMA305",4,0)
 ;*****************************************************************
"RTN","SDAMA305",5,0)
 ;              CHANGE LOG
"RTN","SDAMA305",6,0)
 ;
"RTN","SDAMA305",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA305",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA305",9,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA305",10,0)
 ;08/06/04  SD*5.3*347    ADDITION OF A NEW FILTER - DATE APPOINTMENT
"RTN","SDAMA305",11,0)
 ;                        MADE (FIELD #16) AND 2 NEW FIELDS TO RETURN:
"RTN","SDAMA305",12,0)
 ;                        1) AUTO-REBOOKED APPT DATE/TIME (FIELD #24)
"RTN","SDAMA305",13,0)
 ;                        2) NO-SHOW/CANCEL APPT DATE/TIME (FIELD #25)
"RTN","SDAMA305",14,0)
 ;                        APPEND NATIONAL ELIGIBILITY TO ELIGIBILITY
"RTN","SDAMA305",15,0)
 ;                        (FIELD #8)
"RTN","SDAMA305",16,0)
 ;                        RENAME ENTRY POINT TO ROUTINE 
"RTN","SDAMA305",17,0)
 ;
"RTN","SDAMA305",18,0)
 ;*****************************************************************
"RTN","SDAMA305",19,0)
 ;
"RTN","SDAMA305",20,0)
 ;*****************************************************************
"RTN","SDAMA305",21,0)
 ;
"RTN","SDAMA305",22,0)
 ;              GET APPOINTMENT DATA FROM VISTA
"RTN","SDAMA305",23,0)
 ;              
"RTN","SDAMA305",24,0)
 ;INPUT
"RTN","SDAMA305",25,0)
 ;  SDFLTR     Filter Flags array
"RTN","SDAMA305",26,0)
 ;  SDARRAY    Appointment Filter array
"RTN","SDAMA305",27,0)
 ;  
"RTN","SDAMA305",28,0)
 ;OUTPUT
"RTN","SDAMA305",29,0)
 ;  ^TMP($J,"SDAMA301",SORT1,SORT2,APPT D/T)
"RTN","SDAMA305",30,0)
 ;  
"RTN","SDAMA305",31,0)
 ;*****************************************************************
"RTN","SDAMA305",32,0)
SETARRAY(SDFLTR,SDARRAY) ;
"RTN","SDAMA305",33,0)
 ;Initialize local variables
"RTN","SDAMA305",34,0)
 N SDI,SDIEN,SDNAME,SDFLDS,SDDATA,SDCOUNT,SDFIELD,SDCLIEN,SDDV
"RTN","SDAMA305",35,0)
 S SDFLDS=SDARRAY("FLDS")
"RTN","SDAMA305",36,0)
 S SDCOUNT=$L(SDFLDS,";")
"RTN","SDAMA305",37,0)
 ;Add 1 to appointment count
"RTN","SDAMA305",38,0)
 S SDARRAY("CNT")=(SDARRAY("CNT")+1)
"RTN","SDAMA305",39,0)
 ;For each appoitment field requested
"RTN","SDAMA305",40,0)
 F SDI=1:1:SDCOUNT D
"RTN","SDAMA305",41,0)
 . S (SDIEN,SDNAME,SDDATA)=""
"RTN","SDAMA305",42,0)
 . S SDFIELD=$P(SDFLDS,";",SDI)
"RTN","SDAMA305",43,0)
 . ;get data
"RTN","SDAMA305",44,0)
 . D @SDFIELD
"RTN","SDAMA305",45,0)
 . ;nodes in output global can't be null
"RTN","SDAMA305",46,0)
 . I $G(SDARRAY("SORT1"))="" S SDARRAY("SORT1")="X"_SDARRAY("CNT")
"RTN","SDAMA305",47,0)
 . I $G(SDARRAY("SORT2"))="" S SDARRAY("SORT2")="Y"_SDARRAY("CNT")
"RTN","SDAMA305",48,0)
 . ;add data to output array
"RTN","SDAMA305",49,0)
 . ;Store information with just Patient IEN (No Clinic IEN) in the global reference
"RTN","SDAMA305",50,0)
 . I $G(SDARRAY("SORT"))="P" D
"RTN","SDAMA305",51,0)
 . .S $P(^TMP($J,"SDAMA301",$G(SDARRAY("PAT")),SDARRAY("DATE")),"^",SDFIELD)=$S(SDFIELD=6:"",1:$G(SDDV(SDFIELD)))
"RTN","SDAMA305",52,0)
 . .I SDFIELD=6 S ^TMP($J,"SDAMA301",$G(SDARRAY("PAT")),SDARRAY("DATE"),"C")=$G(SDDV(SDFIELD))
"RTN","SDAMA305",53,0)
 . ;Store information with Patient and Clinic IEN (Sort1, Sort2) in the global reference
"RTN","SDAMA305",54,0)
 . I $G(SDARRAY("SORT"))'="P" D
"RTN","SDAMA305",55,0)
 . .S $P(^TMP($J,"SDAMA301",SDARRAY("SORT1"),SDARRAY("SORT2"),SDARRAY("DATE")),"^",SDFIELD)=$S(SDFIELD=6:"",1:$G(SDDV(SDFIELD)))
"RTN","SDAMA305",56,0)
 . .I SDFIELD=6 S ^TMP($J,"SDAMA301",SDARRAY("SORT1"),SDARRAY("SORT2"),SDARRAY("DATE"),"C")=$G(SDDV(SDFIELD))
"RTN","SDAMA305",57,0)
 Q
"RTN","SDAMA305",58,0)
1 ;Appt date/time
"RTN","SDAMA305",59,0)
 S SDDV(SDFIELD)=SDARRAY("DATE")
"RTN","SDAMA305",60,0)
 Q
"RTN","SDAMA305",61,0)
2 ;Clinic IEN and Name
"RTN","SDAMA305",62,0)
 S SDIEN=+$G(SDARRAY("DPT0"))
"RTN","SDAMA305",63,0)
 I '$G(SDIEN) S SDNAME=""
"RTN","SDAMA305",64,0)
 E  S SDNAME=$P($G(^SC(SDIEN,0)),"^",1)
"RTN","SDAMA305",65,0)
 S SDDV(SDFIELD)=$G(SDIEN)_";"_$G(SDNAME)
"RTN","SDAMA305",66,0)
 Q
"RTN","SDAMA305",67,0)
3 ;Appt Status and Status Description
"RTN","SDAMA305",68,0)
 N SDSTAT
"RTN","SDAMA305",69,0)
 S SDSTAT=$P($G(SDARRAY("DPT0")),"^",2)
"RTN","SDAMA305",70,0)
 I $G(SDSTAT)="" S SDDATA="R;SCHEDULED/KEPT"
"RTN","SDAMA305",71,0)
 E  D
"RTN","SDAMA305",72,0)
 . S SDDATA=$S(SDSTAT="I":"I;INPATIENT",SDSTAT="C":"CC;CANCELLED BY CLINIC",1:"X")
"RTN","SDAMA305",73,0)
 . I SDDATA="X" S SDDATA=$S(SDSTAT="CA":"CCR;CANCELLED BY CLINIC & RESCHEDULED",SDSTAT="PC":"CP;CANCELLED BY PATIENT",1:"X")
"RTN","SDAMA305",74,0)
 . I SDDATA="X" S SDDATA=$S(SDSTAT="PCA":"CPR;CANCELLED BY PATIENT & RESCHEDULED",SDSTAT="N":"NS;NO-SHOW",1:"X")
"RTN","SDAMA305",75,0)
 . I SDDATA="X" S SDDATA=$S(SDSTAT="NA":"NSR;NO-SHOW & RESCHEDULED",SDSTAT="NT":"NT;NO ACTION TAKEN",1:SDSTAT_";UNKNOWN")
"RTN","SDAMA305",76,0)
 S SDDV(SDFIELD)=SDDATA
"RTN","SDAMA305",77,0)
 Q
"RTN","SDAMA305",78,0)
4 ;Patient IEN and Name
"RTN","SDAMA305",79,0)
 S SDIEN=$G(SDARRAY("PAT"))
"RTN","SDAMA305",80,0)
 S SDNAME=$P($G(^DPT(SDIEN,0)),"^",1)
"RTN","SDAMA305",81,0)
 S SDDV(SDFIELD)=$G(SDIEN)_";"_$G(SDNAME)
"RTN","SDAMA305",82,0)
 Q
"RTN","SDAMA305",83,0)
5 ;Length of Appt
"RTN","SDAMA305",84,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("SC0")),"^",2)
"RTN","SDAMA305",85,0)
 Q
"RTN","SDAMA305",86,0)
6 ;Comments
"RTN","SDAMA305",87,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("SC0")),"^",4)
"RTN","SDAMA305",88,0)
 Q
"RTN","SDAMA305",89,0)
7 ;Overbook (return null if appt cancelled)
"RTN","SDAMA305",90,0)
 I $G(SDARRAY("SC0"))'="" D
"RTN","SDAMA305",91,0)
 . S SDDATA=$P($G(SDARRAY("SCOB")),"^",1)
"RTN","SDAMA305",92,0)
 . S SDDV(SDFIELD)=$S($G(SDDATA)="O":"Y",1:"N")
"RTN","SDAMA305",93,0)
 Q
"RTN","SDAMA305",94,0)
8 ;Local & National Eligiblity of Visit Codes and Names
"RTN","SDAMA305",95,0)
 N SDELIG
"RTN","SDAMA305",96,0)
 S SDDATA=$P($G(SDARRAY("SC0")),"^",10)
"RTN","SDAMA305",97,0)
 I $G(SDDATA)]"" D
"RTN","SDAMA305",98,0)
 . S SDELIG=$G(^DIC(8,SDDATA,0))
"RTN","SDAMA305",99,0)
 . ;Append Local Eligibility IEN and Name
"RTN","SDAMA305",100,0)
 . S SDDV(SDFIELD)=$G(SDDATA)_";"_$P(SDELIG,"^")
"RTN","SDAMA305",101,0)
 . ;Append National Eligibility IEN and Name
"RTN","SDAMA305",102,0)
 . S SDIEN=$P(SDELIG,"^",9)
"RTN","SDAMA305",103,0)
 . I $G(SDIEN) D
"RTN","SDAMA305",104,0)
 .. S SDNAME=$P($G(^DIC(8.1,SDIEN,0)),"^",1)
"RTN","SDAMA305",105,0)
 .. S SDDV(SDFIELD)=SDDV(SDFIELD)_";"_$G(SDIEN)_";"_$G(SDNAME)
"RTN","SDAMA305",106,0)
 Q
"RTN","SDAMA305",107,0)
9 ;Check-In Date/time
"RTN","SDAMA305",108,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("SCC")),"^",1)
"RTN","SDAMA305",109,0)
 Q
"RTN","SDAMA305",110,0)
10 ;Appt Type IEN and Name
"RTN","SDAMA305",111,0)
 S SDIEN=$P($G(SDARRAY("DPT0")),"^",16)
"RTN","SDAMA305",112,0)
 I $G(SDIEN)]"" D
"RTN","SDAMA305",113,0)
 . S SDNAME=$P($G(^SD(409.1,SDIEN,0)),"^",1)
"RTN","SDAMA305",114,0)
 . S SDDV(SDFIELD)=$G(SDIEN)_";"_$G(SDNAME)
"RTN","SDAMA305",115,0)
 Q
"RTN","SDAMA305",116,0)
11 ;Check-Out date/time
"RTN","SDAMA305",117,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("SCC")),"^",3)
"RTN","SDAMA305",118,0)
 Q
"RTN","SDAMA305",119,0)
12 ;Outpatient Encounter
"RTN","SDAMA305",120,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",20)
"RTN","SDAMA305",121,0)
 Q
"RTN","SDAMA305",122,0)
13 ;Primary Stop Code IEN and AMIS STOP CODE
"RTN","SDAMA305",123,0)
 N SDCODES
"RTN","SDAMA305",124,0)
 S SDCLIEN=+SDARRAY("DPT0")
"RTN","SDAMA305",125,0)
 I $G(SDCLIEN)]"" D
"RTN","SDAMA305",126,0)
 . S SDCODES=$$GETSTOP(SDCLIEN)
"RTN","SDAMA305",127,0)
 . I SDCODES'=-1 S SDDV(SDFIELD)=$P(SDCODES,"^",1)
"RTN","SDAMA305",128,0)
 Q
"RTN","SDAMA305",129,0)
14 ;Credit Stop Code IEN and AMIS STOP CODE
"RTN","SDAMA305",130,0)
 S SDCLIEN=+SDARRAY("DPT0")
"RTN","SDAMA305",131,0)
 I $G(SDCLIEN)]"" D
"RTN","SDAMA305",132,0)
 . S SDCODES=$$GETSTOP(SDCLIEN)
"RTN","SDAMA305",133,0)
 . I SDCODES'=-1 S SDDV(SDFIELD)=$P(SDCODES,"^",2)
"RTN","SDAMA305",134,0)
 Q
"RTN","SDAMA305",135,0)
15 ;Workload Non-Count
"RTN","SDAMA305",136,0)
 S SDCLIEN=+SDARRAY("DPT0")
"RTN","SDAMA305",137,0)
 I $G(SDCLIEN)]"" D
"RTN","SDAMA305",138,0)
 . S SDCODES=$$GETSTOP(SDCLIEN)
"RTN","SDAMA305",139,0)
 . I SDCODES'=-1 S SDDV(SDFIELD)=$P($G(SDCODES),"^",3)
"RTN","SDAMA305",140,0)
 Q
"RTN","SDAMA305",141,0)
16 ;Date Appt Made
"RTN","SDAMA305",142,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",19)
"RTN","SDAMA305",143,0)
 Q
"RTN","SDAMA305",144,0)
17 ;Desired Date of Appt
"RTN","SDAMA305",145,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT1")),"^",1)
"RTN","SDAMA305",146,0)
 Q
"RTN","SDAMA305",147,0)
18 ;Purpose of Visit
"RTN","SDAMA305",148,0)
 S SDDATA=$P($G(SDARRAY("DPT0")),"^",7)
"RTN","SDAMA305",149,0)
 I $G(SDDATA)'="" D
"RTN","SDAMA305",150,0)
 . S SDDATA=SDDATA_$S(SDDATA="1":";C&P",SDDATA="2":";10-10",SDDATA="3":";SV",SDDATA="4":";UV",1:";")
"RTN","SDAMA305",151,0)
 . S SDDV(SDFIELD)=SDDATA
"RTN","SDAMA305",152,0)
 Q
"RTN","SDAMA305",153,0)
19 ;EKG Date/time
"RTN","SDAMA305",154,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",5)
"RTN","SDAMA305",155,0)
 Q
"RTN","SDAMA305",156,0)
20 ;X-Ray Date/time
"RTN","SDAMA305",157,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",4)
"RTN","SDAMA305",158,0)
 Q
"RTN","SDAMA305",159,0)
21 ;Lab Date/time
"RTN","SDAMA305",160,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",3)
"RTN","SDAMA305",161,0)
 Q
"RTN","SDAMA305",162,0)
22 ;Status 
"RTN","SDAMA305",163,0)
 ;   (Status IEN; Status Description; Print Status; Checked In Date/Time; 
"RTN","SDAMA305",164,0)
 ;       Checked Out Date/Time; Admission Movement IEN)
"RTN","SDAMA305",165,0)
 ;       
"RTN","SDAMA305",166,0)
 ;convert to new appt status code
"RTN","SDAMA305",167,0)
 D 3
"RTN","SDAMA305",168,0)
 S SDDV(SDFIELD)=$$STATUS^SDAMA308(+$G(SDARRAY("PAT")),+$G(SDARRAY("DATE")),+$G(SDARRAY("DPT0")),$P(SDDV(SDFIELD),";"),$P($G(SDARRAY("SCC")),"^"),$P($G(SDARRAY("SCC")),"^",3),$P($G(SDARRAY("DPT0")),"^",20))
"RTN","SDAMA305",169,0)
 Q
"RTN","SDAMA305",170,0)
23 ;X-Ray Films
"RTN","SDAMA305",171,0)
 N SDRECS
"RTN","SDAMA305",172,0)
 ;Get Clinic IEN, X-Ray Films Required
"RTN","SDAMA305",173,0)
 S SDIEN=+$G(SDARRAY("DPT0"))
"RTN","SDAMA305",174,0)
 S SDRECS=$P($G(^SC(SDIEN,"RAD")),"^")
"RTN","SDAMA305",175,0)
 ;Translate Lower Case to Upper
"RTN","SDAMA305",176,0)
 S SDRECS=$TR(SDRECS,"ny","NY")
"RTN","SDAMA305",177,0)
 S SDDATA=$S(SDRECS["Y":"Y",1:"N")
"RTN","SDAMA305",178,0)
 S SDDV(SDFIELD)=SDDATA
"RTN","SDAMA305",179,0)
 Q
"RTN","SDAMA305",180,0)
24 ;Auto-Rebooked Appt. Date/Time
"RTN","SDAMA305",181,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",10)
"RTN","SDAMA305",182,0)
 Q
"RTN","SDAMA305",183,0)
25 ;No-Show/Cancel Date/Time
"RTN","SDAMA305",184,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",14)
"RTN","SDAMA305",185,0)
 Q
"RTN","SDAMA305",186,0)
GETSTOP(SDCLIEN) ;Primary Stop Code, Credit Stop Code, Non-Count
"RTN","SDAMA305",187,0)
 ; return codes or -1 if bad clinic
"RTN","SDAMA305",188,0)
 N SDPSC,SDPSCIEN,SDCSC,SDCSCIEN,SDNC,SDCODES
"RTN","SDAMA305",189,0)
 I +$G(SDCLIEN)=0 S SDCODES=-1
"RTN","SDAMA305",190,0)
 I +$G(SDCLIEN)'=0 D
"RTN","SDAMA305",191,0)
 . ;make sure clinic is on ^SC
"RTN","SDAMA305",192,0)
 . I '$D(^SC(SDCLIEN)) S SDCODES=-1 Q
"RTN","SDAMA305",193,0)
 . ;get primary stop code ien
"RTN","SDAMA305",194,0)
 . S SDPSCIEN=$P($G(^SC(SDCLIEN,0)),"^",7)
"RTN","SDAMA305",195,0)
 . ;get credit stop code ien
"RTN","SDAMA305",196,0)
 . S SDCSCIEN=$P($G(^SC(SDCLIEN,0)),"^",18)
"RTN","SDAMA305",197,0)
 . I $G(SDPSCIEN) S SDPSC=$P($G(^DIC(40.7,SDPSCIEN,0)),"^",2)
"RTN","SDAMA305",198,0)
 . I $G(SDCSCIEN) S SDCSC=$P($G(^DIC(40.7,SDCSCIEN,0)),"^",2)
"RTN","SDAMA305",199,0)
 . ;get workload non-count
"RTN","SDAMA305",200,0)
 . S SDNC=$P($G(^SC(SDCLIEN,0)),"^",17)
"RTN","SDAMA305",201,0)
 . S SDNC=$S($G(SDNC)="Y":"Y",1:"N")
"RTN","SDAMA305",202,0)
 . S SDCODES=$G(SDPSCIEN)_";"_$G(SDPSC)_"^"_$G(SDCSCIEN)_";"_$G(SDCSC)_"^"_SDNC
"RTN","SDAMA305",203,0)
 Q SDCODES
"RTN","SDAMA306")
0^12^B7276418
"RTN","SDAMA306",1,0)
SDAMA306 ;BPOIFO/ACS-Filter API Utilities ; 8/10/04 2:40pm
"RTN","SDAMA306",2,0)
 ;;5.3;Scheduling;**301,347**;13 Aug 1993
"RTN","SDAMA306",3,0)
 ;
"RTN","SDAMA306",4,0)
 ;
"RTN","SDAMA306",5,0)
 ;*****************************************************************
"RTN","SDAMA306",6,0)
 ;              CHANGE LOG
"RTN","SDAMA306",7,0)
 ;
"RTN","SDAMA306",8,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA306",9,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA306",10,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA306",11,0)
 ;08/06/04  SD*5.3*347    ADDITION OF A NEW FILTER - DATE APPOINTMENT
"RTN","SDAMA306",12,0)
 ;                        MADE (FIELD #16) AND 2 NEW FIELDS TO RETURN:
"RTN","SDAMA306",13,0)
 ;                        1) AUTO-REBOOKED APPT DATE/TIME (FIELD #24)
"RTN","SDAMA306",14,0)
 ;                        2) NO-SHOW/CANCEL APPT DATE/TIME (FIELD #25)
"RTN","SDAMA306",15,0)
 ;
"RTN","SDAMA306",16,0)
 ;*****************************************************************
"RTN","SDAMA306",17,0)
INITAE(SDARRAY) ;Initialize Array Entries as needed
"RTN","SDAMA306",18,0)
 ;Initialize Appointment "From" and "To" dates if null
"RTN","SDAMA306",19,0)
 N SDI
"RTN","SDAMA306",20,0)
 F SDI=1,16  D INITDTS(SDI)
"RTN","SDAMA306",21,0)
 ;
"RTN","SDAMA306",22,0)
 ;Remove leading and trailing semi-colons from filter lists if present
"RTN","SDAMA306",23,0)
 N SDNODE
"RTN","SDAMA306",24,0)
 F SDNODE=2,3,4,13,"FLDS" D
"RTN","SDAMA306",25,0)
 . I $L($G(SDARRAY(SDNODE)))>0 D
"RTN","SDAMA306",26,0)
 .. I $E(SDARRAY(SDNODE),$L(SDARRAY(SDNODE)))=";" D
"RTN","SDAMA306",27,0)
 ... S SDARRAY(SDNODE)=$E(SDARRAY(SDNODE),1,($L(SDARRAY(SDNODE))-1))
"RTN","SDAMA306",28,0)
 .. I $E(SDARRAY(SDNODE),1)=";" D
"RTN","SDAMA306",29,0)
 ... S SDARRAY(SDNODE)=$E(SDARRAY(SDNODE),2,$L(SDARRAY(SDNODE)))
"RTN","SDAMA306",30,0)
 ;
"RTN","SDAMA306",31,0)
 ;If the patient list is in a global, add comma at end if needed
"RTN","SDAMA306",32,0)
 S SDARRAY("PATGBL")=0
"RTN","SDAMA306",33,0)
 I $G(SDARRAY(4))["(" D
"RTN","SDAMA306",34,0)
 . ;flag as patient global input
"RTN","SDAMA306",35,0)
 . S SDARRAY("PATGBL")=1
"RTN","SDAMA306",36,0)
 . ;add comma to end of global root if needed
"RTN","SDAMA306",37,0)
 . N SDLCHAR S SDLCHAR=$E(SDARRAY(4),$L(SDARRAY(4)))
"RTN","SDAMA306",38,0)
 . I SDLCHAR="," Q
"RTN","SDAMA306",39,0)
 . E  I SDLCHAR'="(" S SDARRAY(4)=SDARRAY(4)_","
"RTN","SDAMA306",40,0)
 ;
"RTN","SDAMA306",41,0)
 ;If the clinic list is in a global, add comma at end if needed
"RTN","SDAMA306",42,0)
 S SDARRAY("CLNGBL")=0
"RTN","SDAMA306",43,0)
 I $G(SDARRAY(2))["(" D
"RTN","SDAMA306",44,0)
 . ;flag as clinic global input
"RTN","SDAMA306",45,0)
 . S SDARRAY("CLNGBL")=1
"RTN","SDAMA306",46,0)
 . ;add comma to end of global root if needed
"RTN","SDAMA306",47,0)
 . N SDLCHAR S SDLCHAR=$E(SDARRAY(2),$L(SDARRAY(2)))
"RTN","SDAMA306",48,0)
 . I SDLCHAR="," Q
"RTN","SDAMA306",49,0)
 . E  I SDLCHAR'="(" S SDARRAY(2)=SDARRAY(2)_","
"RTN","SDAMA306",50,0)
 Q
"RTN","SDAMA306",51,0)
 ;
"RTN","SDAMA306",52,0)
 ;***************************************************
"RTN","SDAMA306",53,0)
 ;INPUT
"RTN","SDAMA306",54,0)
 ;      SDFLTR    Filter to initialize
"RTN","SDAMA306",55,0)
 ;***************************************************
"RTN","SDAMA306",56,0)
INITDTS(SDFLTR) ;initialize Appt Date/Time and Date Appt Made
"RTN","SDAMA306",57,0)
 N SDFROM,SDTO,SDYR,SDDAY,SDMNTH,SDTIME,SDVAR
"RTN","SDAMA306",58,0)
 ;initialize variables to passed in values
"RTN","SDAMA306",59,0)
 S SDFROM=$P($G(SDARRAY(SDFLTR)),";",1)
"RTN","SDAMA306",60,0)
 S SDTO=$P($G(SDARRAY(SDFLTR)),";",2)
"RTN","SDAMA306",61,0)
 ;replace day and month to Jan 01 (0101) if 0s or "" are passed
"RTN","SDAMA306",62,0)
 ;replace time with 2359 if time is greater than 2359
"RTN","SDAMA306",63,0)
 F SDVAR="SDFROM","SDTO"  D
"RTN","SDAMA306",64,0)
 .I @SDVAR'="" D
"RTN","SDAMA306",65,0)
 ..S SDYR=$E(@SDVAR,1,3),SDMNTH=$E(@SDVAR,4,5),SDDAY=$E(@SDVAR,6,7)
"RTN","SDAMA306",66,0)
 ..S SDTIME=$P(@SDVAR,".",2) S:(SDTIME'="") SDTIME="."_SDTIME
"RTN","SDAMA306",67,0)
 ..S:(+SDDAY'>0) SDDAY="01"
"RTN","SDAMA306",68,0)
 ..S:(+SDMNTH'>0) SDMNTH="01"
"RTN","SDAMA306",69,0)
 ..S:((+SDTIME'=0)&(+SDTIME>.2359)) SDTIME=.2359
"RTN","SDAMA306",70,0)
 ..S @SDVAR=SDYR_SDMNTH_SDDAY
"RTN","SDAMA306",71,0)
 ..S:(SDTIME'="") @SDVAR=@SDVAR_SDTIME
"RTN","SDAMA306",72,0)
 ;initialize SDTO to default if null
"RTN","SDAMA306",73,0)
 I $G(SDTO)="" D
"RTN","SDAMA306",74,0)
 .S:SDFLTR=1 SDTO="9999999.9999"
"RTN","SDAMA306",75,0)
 .S:SDFLTR=16 SDTO="9999999"
"RTN","SDAMA306",76,0)
 ;if date passed in without time for Appt Date/Time filter add time
"RTN","SDAMA306",77,0)
 I SDFLTR=1,SDTO'["." S SDTO=SDTO_".2359"
"RTN","SDAMA306",78,0)
 ;create new variables to reference Date(/Time)s
"RTN","SDAMA306",79,0)
 I SDFLTR=1 D
"RTN","SDAMA306",80,0)
 .S SDARRAY("FR")=$G(SDFROM)
"RTN","SDAMA306",81,0)
 .S SDARRAY("TO")=$G(SDTO)
"RTN","SDAMA306",82,0)
 I SDFLTR=16 D
"RTN","SDAMA306",83,0)
 .S SDARRAY("DAMFR")=$G(SDFROM)
"RTN","SDAMA306",84,0)
 .S SDARRAY("DAMTO")=$G(SDTO)
"RTN","SDAMA306",85,0)
 Q
"VER")
8.0^22.0
"BLD",5667,6)
^SEQ #346
**END**
**END**
