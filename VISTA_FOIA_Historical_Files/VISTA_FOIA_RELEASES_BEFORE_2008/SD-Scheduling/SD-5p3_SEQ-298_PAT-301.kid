Released SD*5.3*301 SEQ #298
Extracted from mail message
**KIDS**:SD*5.3*301^

**INSTALL NAME**
SD*5.3*301
"BLD",4009,0)
SD*5.3*301^SCHEDULING^0^3040607^y
"BLD",4009,1,0)
^^1^1^3040226^^
"BLD",4009,1,1,0)
New Scheduling Replacement API
"BLD",4009,4,0)
^9.64PA^^
"BLD",4009,"KRN",0)
^9.67PA^8989.52^19
"BLD",4009,"KRN",.4,0)
.4
"BLD",4009,"KRN",.401,0)
.401
"BLD",4009,"KRN",.402,0)
.402
"BLD",4009,"KRN",.403,0)
.403
"BLD",4009,"KRN",.5,0)
.5
"BLD",4009,"KRN",.84,0)
.84
"BLD",4009,"KRN",3.6,0)
3.6
"BLD",4009,"KRN",3.8,0)
3.8
"BLD",4009,"KRN",9.2,0)
9.2
"BLD",4009,"KRN",9.8,0)
9.8
"BLD",4009,"KRN",9.8,"NM",0)
^9.68A^11^9
"BLD",4009,"KRN",9.8,"NM",1,0)
SDAMA300^^0^B38620255
"BLD",4009,"KRN",9.8,"NM",2,0)
SDAMA301^^0^B3474625
"BLD",4009,"KRN",9.8,"NM",3,0)
SDAMA303^^0^B22454517
"BLD",4009,"KRN",9.8,"NM",4,0)
SDAMA304^^0^B5782534
"BLD",4009,"KRN",9.8,"NM",5,0)
SDAMA305^^0^B36725544
"BLD",4009,"KRN",9.8,"NM",8,0)
SDAMA302^^0^B23704512
"BLD",4009,"KRN",9.8,"NM",9,0)
SDAMA306^^0^B3957578
"BLD",4009,"KRN",9.8,"NM",10,0)
SDAMA307^^0^B1446187
"BLD",4009,"KRN",9.8,"NM",11,0)
SDAMA308^^0^B11354365
"BLD",4009,"KRN",9.8,"NM","B","SDAMA300",1)

"BLD",4009,"KRN",9.8,"NM","B","SDAMA301",2)

"BLD",4009,"KRN",9.8,"NM","B","SDAMA302",8)

"BLD",4009,"KRN",9.8,"NM","B","SDAMA303",3)

"BLD",4009,"KRN",9.8,"NM","B","SDAMA304",4)

"BLD",4009,"KRN",9.8,"NM","B","SDAMA305",5)

"BLD",4009,"KRN",9.8,"NM","B","SDAMA306",9)

"BLD",4009,"KRN",9.8,"NM","B","SDAMA307",10)

"BLD",4009,"KRN",9.8,"NM","B","SDAMA308",11)

"BLD",4009,"KRN",19,0)
19
"BLD",4009,"KRN",19,"NM",0)
^9.68A^^
"BLD",4009,"KRN",19.1,0)
19.1
"BLD",4009,"KRN",101,0)
101
"BLD",4009,"KRN",409.61,0)
409.61
"BLD",4009,"KRN",771,0)
771
"BLD",4009,"KRN",870,0)
870
"BLD",4009,"KRN",8989.51,0)
8989.51
"BLD",4009,"KRN",8989.52,0)
8989.52
"BLD",4009,"KRN",8994,0)
8994
"BLD",4009,"KRN","B",.4,.4)

"BLD",4009,"KRN","B",.401,.401)

"BLD",4009,"KRN","B",.402,.402)

"BLD",4009,"KRN","B",.403,.403)

"BLD",4009,"KRN","B",.5,.5)

"BLD",4009,"KRN","B",.84,.84)

"BLD",4009,"KRN","B",3.6,3.6)

"BLD",4009,"KRN","B",3.8,3.8)

"BLD",4009,"KRN","B",9.2,9.2)

"BLD",4009,"KRN","B",9.8,9.8)

"BLD",4009,"KRN","B",19,19)

"BLD",4009,"KRN","B",19.1,19.1)

"BLD",4009,"KRN","B",101,101)

"BLD",4009,"KRN","B",409.61,409.61)

"BLD",4009,"KRN","B",771,771)

"BLD",4009,"KRN","B",870,870)

"BLD",4009,"KRN","B",8989.51,8989.51)

"BLD",4009,"KRN","B",8989.52,8989.52)

"BLD",4009,"KRN","B",8994,8994)

"BLD",4009,"QUES",0)
^9.62^^
"BLD",4009,"REQB",0)
^9.611^^0
"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
SCHEDULING^SD^APPOINTMENTS,PROFILES,LETTERS,AMIS REPORTS
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
5.3^2930813^2930824
"PKG",16,22,1,"PAH",1,0)
301^3040607^10000000073
"PKG",16,22,1,"PAH",1,1,0)
^^1^1^3040607
"PKG",16,22,1,"PAH",1,1,1,0)
New Scheduling Replacement API
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","SDAMA300")
0^1^B38620255
"RTN","SDAMA300",1,0)
SDAMA300 ;BPOIFO/ACS-Filter API Validate Filters ;04 Dec 2003 [6/7/04 2:39pm]
"RTN","SDAMA300",2,0)
 ;;5.3;Scheduling;**301**;13 Aug 1993
"RTN","SDAMA300",3,0)
 ;
"RTN","SDAMA300",4,0)
 ;*****************************************************************
"RTN","SDAMA300",5,0)
 ;              CHANGE LOG
"RTN","SDAMA300",6,0)
 ;
"RTN","SDAMA300",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA300",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA300",9,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA300",10,0)
 ;
"RTN","SDAMA300",11,0)
 ;*****************************************************************
"RTN","SDAMA300",12,0)
VALARR(SDARRAY,SDFLTR) ;
"RTN","SDAMA300",13,0)
 ;*****************************************************************
"RTN","SDAMA300",14,0)
 ;
"RTN","SDAMA300",15,0)
 ;              VALIDATE FILTER ARRAY CONTENTS
"RTN","SDAMA300",16,0)
 ;INPUT
"RTN","SDAMA300",17,0)
 ;  SDARRAY    Appointment filters
"RTN","SDAMA300",18,0)
 ;  SDFLTR     Filter Flag array
"RTN","SDAMA300",19,0)
 ;
"RTN","SDAMA300",20,0)
 ;OUTPUT
"RTN","SDAMA300",21,0)
 ;  -1 if error
"RTN","SDAMA300",22,0)
 ;   1 if no errors
"RTN","SDAMA300",23,0)
 ;
"RTN","SDAMA300",24,0)
 ;*****************************************************************
"RTN","SDAMA300",25,0)
 ;Initialize local variables
"RTN","SDAMA300",26,0)
 N SDI,SDX,SDQUIT,SDDATA,SDCOUNT,SDERR
"RTN","SDAMA300",27,0)
 S SDQUIT=0,SDERR=115
"RTN","SDAMA300",28,0)
 ;
"RTN","SDAMA300",29,0)
 ;Set filter flags and validate input array entries
"RTN","SDAMA300",30,0)
 F SDI="MAX","FLDS","FLTRS","SORT" Q:SDQUIT  D @SDI
"RTN","SDAMA300",31,0)
 Q:(SDARRAY("CNT")=-1) -1
"RTN","SDAMA300",32,0)
 ;filters allowed on these fields
"RTN","SDAMA300",33,0)
 F SDI=1:1:4,13 Q:SDQUIT  D
"RTN","SDAMA300",34,0)
 . I $G(SDARRAY(SDI))']"" S SDFLTR(SDI)=0
"RTN","SDAMA300",35,0)
 . E  S SDFLTR(SDI)=1 D
"RTN","SDAMA300",36,0)
 .. S SDCOUNT=$L(SDARRAY(SDI),";")
"RTN","SDAMA300",37,0)
 .. S SDQUIT=0
"RTN","SDAMA300",38,0)
 .. D @SDI
"RTN","SDAMA300",39,0)
 ;
"RTN","SDAMA300",40,0)
 I SDQUIT=0 D
"RTN","SDAMA300",41,0)
 . ;filters not allowed on these fields
"RTN","SDAMA300",42,0)
 . F SDI=5:1:12,14:1:SDARRAY("FC") Q:SDQUIT  D NOFIL
"RTN","SDAMA300",43,0)
 Q SDARRAY("CNT")
"RTN","SDAMA300",44,0)
 ;
"RTN","SDAMA300",45,0)
 ;*****************************************************************
"RTN","SDAMA300",46,0)
 ;
"RTN","SDAMA300",47,0)
1 ;SDARRAY(1): Appt dates
"RTN","SDAMA300",48,0)
 ;Appt D/T already initialized
"RTN","SDAMA300",49,0)
 I $G(SDARRAY("FR"))'="" D
"RTN","SDAMA300",50,0)
 .D FMDATE(SDARRAY("FR"),SDERR)
"RTN","SDAMA300",51,0)
 .Q:SDQUIT
"RTN","SDAMA300",52,0)
 .;dates must be numeric
"RTN","SDAMA300",53,0)
 .I SDARRAY("FR")'=+(SDARRAY("FR")) D ERROR(SDERR)
"RTN","SDAMA300",54,0)
 .Q:SDQUIT
"RTN","SDAMA300",55,0)
 D FMDATE(SDARRAY("TO"),SDERR)
"RTN","SDAMA300",56,0)
 Q:SDQUIT
"RTN","SDAMA300",57,0)
 ;dates must be numeric
"RTN","SDAMA300",58,0)
 I SDARRAY("TO")'=+(SDARRAY("TO")) D ERROR(SDERR)
"RTN","SDAMA300",59,0)
 Q:SDQUIT
"RTN","SDAMA300",60,0)
 I SDARRAY("FR")>SDARRAY("TO") D ERROR(SDERR)
"RTN","SDAMA300",61,0)
 ;allow seconds in date/time filter!
"RTN","SDAMA300",62,0)
 Q:SDQUIT
"RTN","SDAMA300",63,0)
 I $L(SDARRAY("FR"))>14 D ERROR(SDERR)
"RTN","SDAMA300",64,0)
 Q:SDQUIT
"RTN","SDAMA300",65,0)
 I $L(SDARRAY("TO"))>14 D ERROR(SDERR)
"RTN","SDAMA300",66,0)
 Q
"RTN","SDAMA300",67,0)
2 ;SDARRAY(2): Clinic IEN
"RTN","SDAMA300",68,0)
 ;Clinic must be on ^SC
"RTN","SDAMA300",69,0)
 ;Clinic list is not in global
"RTN","SDAMA300",70,0)
 I SDARRAY("CLNGBL")'=1 D
"RTN","SDAMA300",71,0)
 . ; get each clinic IEN in the string and validate
"RTN","SDAMA300",72,0)
 . F SDX=1:1:SDCOUNT Q:SDQUIT  D
"RTN","SDAMA300",73,0)
 .. S SDDATA=$P(SDARRAY(2),";",SDX)
"RTN","SDAMA300",74,0)
 .. I ($G(SDDATA)=""!'$D(^SC(SDDATA,0))) D ERROR(SDERR)
"RTN","SDAMA300",75,0)
 ;Clinic list is in global or local array
"RTN","SDAMA300",76,0)
 I SDARRAY("CLNGBL")=1 D
"RTN","SDAMA300",77,0)
 . S SDX=SDARRAY(2)
"RTN","SDAMA300",78,0)
 . ;check for existence of IENs
"RTN","SDAMA300",79,0)
 . N SDIEN S SDIEN=$O(@(SDX_"0)")) I +$G(SDIEN)=0 D ERROR(SDERR)
"RTN","SDAMA300",80,0)
 . Q:SDQUIT
"RTN","SDAMA300",81,0)
 . S SDDATA=0
"RTN","SDAMA300",82,0)
 . ; get each IEN in the array and validate
"RTN","SDAMA300",83,0)
 . F  S SDDATA=$O(@(SDX_"SDDATA)")) Q:(($G(SDDATA)="")!(SDQUIT))  D
"RTN","SDAMA300",84,0)
 .. I '$D(^SC(SDDATA,0)) D ERROR(SDERR)
"RTN","SDAMA300",85,0)
 Q
"RTN","SDAMA300",86,0)
3 ;SDARRAY(3): Appointment Status Code
"RTN","SDAMA300",87,0)
 F SDX=1:1:SDCOUNT Q:SDQUIT  D
"RTN","SDAMA300",88,0)
 . S SDDATA=";"_$P(SDARRAY(3),";",SDX)_";"
"RTN","SDAMA300",89,0)
 . I ";I;R;NT;NS;NSR;CC;CCR;CP;CPR;"'[(SDDATA) D ERROR(SDERR)
"RTN","SDAMA300",90,0)
 Q
"RTN","SDAMA300",91,0)
4 ;SDARRAY(4): Patient DFN
"RTN","SDAMA300",92,0)
 ;back door escape for Scheduling Replacement Team
"RTN","SDAMA300",93,0)
 ;Unpublished and should not be used by other apps
"RTN","SDAMA300",94,0)
 Q:SDARRAY("BD")=1
"RTN","SDAMA300",95,0)
 ;patient must be on ^DPT (and have valid NATIONAL ICN : PHASE II)
"RTN","SDAMA300",96,0)
 ;N SDY (PHASE II)
"RTN","SDAMA300",97,0)
 ;DFN list is not in global
"RTN","SDAMA300",98,0)
 I SDARRAY("PATGBL")'=1 D
"RTN","SDAMA300",99,0)
 . ; get each DFN in the string and validate
"RTN","SDAMA300",100,0)
 . F SDX=1:1:SDCOUNT Q:SDQUIT  D
"RTN","SDAMA300",101,0)
 .. S SDDATA=$P(SDARRAY(4),";",SDX)
"RTN","SDAMA300",102,0)
 .. I $G(SDDATA)="" D ERROR(SDERR)
"RTN","SDAMA300",103,0)
 .. Q:SDQUIT
"RTN","SDAMA300",104,0)
 .. I '$D(^DPT(SDDATA)) D ERROR(SDERR)
"RTN","SDAMA300",105,0)
 .. Q:SDQUIT
"RTN","SDAMA300",106,0)
 .. ;S SDY=$$GETICN^MPIF001(SDDATA) (PHASE II)
"RTN","SDAMA300",107,0)
 .. ;I +SDY=-1 D ERROR(SDERR) (PHASE II)
"RTN","SDAMA300",108,0)
 ;DFN list is in global or local array
"RTN","SDAMA300",109,0)
 I SDARRAY("PATGBL")=1 D
"RTN","SDAMA300",110,0)
 . S SDX=SDARRAY(4)
"RTN","SDAMA300",111,0)
 . ;check for existence of DFNs
"RTN","SDAMA300",112,0)
 . N SDDFN S SDDFN=$O(@(SDX_"0)")) I +$G(SDDFN)=0 D ERROR(SDERR)
"RTN","SDAMA300",113,0)
 . Q:SDQUIT
"RTN","SDAMA300",114,0)
 . S SDDATA=0
"RTN","SDAMA300",115,0)
 . ; get each DFN in the array and validate
"RTN","SDAMA300",116,0)
 . F  S SDDATA=$O(@(SDX_"SDDATA)")) Q:(($G(SDDATA)="")!(SDQUIT))  D
"RTN","SDAMA300",117,0)
 .. I '$D(^DPT(SDDATA)) D ERROR(SDERR)
"RTN","SDAMA300",118,0)
 .. Q:SDQUIT
"RTN","SDAMA300",119,0)
 .. ;S SDY=$$GETICN^MPIF001(SDDATA) (PHASE II)
"RTN","SDAMA300",120,0)
 .. ;I +SDY=-1 D ERROR(SDERR) (PHASE II)
"RTN","SDAMA300",121,0)
 Q
"RTN","SDAMA300",122,0)
13 ;SDARRAY(13): Primary Stop Code
"RTN","SDAMA300",123,0)
 ;primary stop code must exist on ^DIC(40.7
"RTN","SDAMA300",124,0)
 N SDY,SDVALID
"RTN","SDAMA300",125,0)
 S SDVALID=0
"RTN","SDAMA300",126,0)
 F SDX=1:1:SDCOUNT Q:SDQUIT  D
"RTN","SDAMA300",127,0)
 . S SDDATA=$P(SDARRAY(13),";",SDX) D
"RTN","SDAMA300",128,0)
 .. I (($G(SDDATA)<1)!($G(SDDATA)>999)) S SDQUIT=1 Q 
"RTN","SDAMA300",129,0)
 .. ;I '$D(^DIC(40.7,SDDATA)) S SDQUIT=1 Q
"RTN","SDAMA300",130,0)
 .. S SDVALID=0,SDY=0
"RTN","SDAMA300",131,0)
 .. F  S SDY=$O(^DIC(40.7,SDY)) Q:((SDY="")!(SDVALID=1))  D
"RTN","SDAMA300",132,0)
 ... I SDDATA=$P($G(^DIC(40.7,SDY,0)),"^",2) S SDVALID=1
"RTN","SDAMA300",133,0)
 .. I SDVALID=0 S SDQUIT=1
"RTN","SDAMA300",134,0)
 I SDQUIT D ERROR(SDERR)
"RTN","SDAMA300",135,0)
 Q
"RTN","SDAMA300",136,0)
NOFIL ;No filter allowed
"RTN","SDAMA300",137,0)
 I $G(SDARRAY(SDI))]"" D ERROR(SDERR)
"RTN","SDAMA300",138,0)
 Q
"RTN","SDAMA300",139,0)
FMDATE(SDDATE,SDERR) ;
"RTN","SDAMA300",140,0)
 ;dates must be valid internal FileMan format
"RTN","SDAMA300",141,0)
 N X,Y,%H,%T,%Y
"RTN","SDAMA300",142,0)
 S Y=SDDATE D DD^%DT I Y=-1 D ERROR(SDERR)
"RTN","SDAMA300",143,0)
 Q:SDQUIT
"RTN","SDAMA300",144,0)
 ;dates cannot be imprecise
"RTN","SDAMA300",145,0)
 S X=SDDATE D H^%DTC I %H=0 D ERROR(SDERR)
"RTN","SDAMA300",146,0)
 Q
"RTN","SDAMA300",147,0)
MAX ;Maximum number of appointments requested
"RTN","SDAMA300",148,0)
 ;max can't be 0
"RTN","SDAMA300",149,0)
 N SDMAXAPT,SDPCOUNT,SDCCOUNT
"RTN","SDAMA300",150,0)
 S SDMAXAPT=$G(SDARRAY("MAX"))
"RTN","SDAMA300",151,0)
 S (SDPCOUNT,SDCCOUNT)=0
"RTN","SDAMA300",152,0)
 I $G(SDMAXAPT)]"" D
"RTN","SDAMA300",153,0)
 . ;Check Max Entry
"RTN","SDAMA300",154,0)
 . I +SDMAXAPT'=SDMAXAPT S SDQUIT=1 Q
"RTN","SDAMA300",155,0)
 . I SDMAXAPT=0 S SDQUIT=1 Q
"RTN","SDAMA300",156,0)
 . I SDMAXAPT["." S SDQUIT=1 Q
"RTN","SDAMA300",157,0)
 . ;Verify a SINGLE valid PATIENT &/OR CLINIC Entry
"RTN","SDAMA300",158,0)
 . ;Get Number of Patients passed in
"RTN","SDAMA300",159,0)
 . I SDARRAY("PATGBL")=1 S SDPCOUNT=$$CHKGBL(SDARRAY(4))
"RTN","SDAMA300",160,0)
 . I SDARRAY("PATGBL")=0 S SDPCOUNT=$L(SDARRAY(4),";")
"RTN","SDAMA300",161,0)
 . ;Get Number of Clinics passed in
"RTN","SDAMA300",162,0)
 . I SDARRAY("CLNGBL")=1 S SDCCOUNT=$$CHKGBL(SDARRAY(2))
"RTN","SDAMA300",163,0)
 . I SDARRAY("CLNGBL")=0 S SDCCOUNT=$L(SDARRAY(4),";")
"RTN","SDAMA300",164,0)
 . I (SDPCOUNT>1)!(SDCCOUNT>1) S SDQUIT=1 Q
"RTN","SDAMA300",165,0)
 . I SDPCOUNT=0,SDCCOUNT=0 S SDQUIT=1
"RTN","SDAMA300",166,0)
 I SDQUIT D ERROR(SDERR)
"RTN","SDAMA300",167,0)
 Q
"RTN","SDAMA300",168,0)
 ;
"RTN","SDAMA300",169,0)
FLDS ;Quit if field list is null
"RTN","SDAMA300",170,0)
 N SDFIELDS,SDFIELD
"RTN","SDAMA300",171,0)
 I $G(SDARRAY("FLDS"))="" D ERROR(SDERR)
"RTN","SDAMA300",172,0)
 Q:SDQUIT
"RTN","SDAMA300",173,0)
 S SDFIELDS=SDARRAY("FLDS")
"RTN","SDAMA300",174,0)
 S SDCOUNT=$L(SDFIELDS,";")
"RTN","SDAMA300",175,0)
 F SDI=1:1:SDCOUNT Q:SDQUIT  D
"RTN","SDAMA300",176,0)
 . S SDFIELD=$P(SDFIELDS,";",SDI)
"RTN","SDAMA300",177,0)
 . I (($G(SDFIELD)'?.N)!($G(SDFIELD)<1)!($G(SDFIELD)>SDARRAY("FC"))) D ERROR(SDERR) S SDQUIT=1
"RTN","SDAMA300",178,0)
 Q
"RTN","SDAMA300",179,0)
 ;
"RTN","SDAMA300",180,0)
FLTRS ;Quit if max filters exceeded
"RTN","SDAMA300",181,0)
 N SDFCNT S SDFCNT=0
"RTN","SDAMA300",182,0)
 F SDI=1:1:SDARRAY("FC") D
"RTN","SDAMA300",183,0)
 . I $G(SDARRAY(SDI))]"" S SDFCNT=SDFCNT+1
"RTN","SDAMA300",184,0)
 I SDFCNT>SDARRAY("MF") D ERROR(SDERR) S SDQUIT=1
"RTN","SDAMA300",185,0)
 Q
"RTN","SDAMA300",186,0)
 ;
"RTN","SDAMA300",187,0)
SORT ;Quit if SORT Filter is a value other than P or null
"RTN","SDAMA300",188,0)
 N SDSORT
"RTN","SDAMA300",189,0)
 S SDSORT=$G(SDARRAY("SORT"))
"RTN","SDAMA300",190,0)
 I $G(SDSORT)="" Q
"RTN","SDAMA300",191,0)
 I '($G(SDSORT)="P") D ERROR(SDERR)
"RTN","SDAMA300",192,0)
 Q
"RTN","SDAMA300",193,0)
 ;
"RTN","SDAMA300",194,0)
ERROR(SDERRNUM) ;Generate Error and put in ^TMP global
"RTN","SDAMA300",195,0)
 S SDARRAY("CNT")=-1,SDQUIT=1
"RTN","SDAMA300",196,0)
 S $P(^TMP($J,"SDAMA301",SDERRNUM),"^",1)=$P($T(@SDERRNUM),";;",2)
"RTN","SDAMA300",197,0)
 Q
"RTN","SDAMA300",198,0)
 ;
"RTN","SDAMA300",199,0)
 ;Error code 101 is not used yet
"RTN","SDAMA300",200,0)
101 ;;DATABASE IS UNAVAILABLE
"RTN","SDAMA300",201,0)
115 ;;INVALID INPUT ARRAY ENTRY
"RTN","SDAMA300",202,0)
116 ;;DATA MISMATCH
"RTN","SDAMA300",203,0)
 ;
"RTN","SDAMA300",204,0)
CHKGBL(SDGBL) ;Check Global for number of entries
"RTN","SDAMA300",205,0)
 N SDIEN,SDCOUNT
"RTN","SDAMA300",206,0)
 S (SDIEN,SDCOUNT)=0
"RTN","SDAMA300",207,0)
 F  S SDIEN=$O(@(SDGBL_"SDIEN)"))  Q:(+$G(SDIEN)=0)!(SDCOUNT>2)  D
"RTN","SDAMA300",208,0)
 .S SDCOUNT=SDCOUNT+1
"RTN","SDAMA300",209,0)
 Q SDCOUNT
"RTN","SDAMA301")
0^2^B3474625
"RTN","SDAMA301",1,0)
SDAMA301 ;BPOIFO/ACS-Filter API Main Entry ;04 Dec 2003 [5/26/04 8:22am]
"RTN","SDAMA301",2,0)
 ;;5.3;Scheduling;**301**;13 Aug 1993
"RTN","SDAMA301",3,0)
 ;
"RTN","SDAMA301",4,0)
 ;**   BEFORE USING THE API IN THIS ROUTINE, PLEASE SUBSCRIBE    **
"RTN","SDAMA301",5,0)
 ;**   TO DBIA #4433                                             **
"RTN","SDAMA301",6,0)
 ;
"RTN","SDAMA301",7,0)
 ;*****************************************************************
"RTN","SDAMA301",8,0)
 ;              CHANGE LOG
"RTN","SDAMA301",9,0)
 ;
"RTN","SDAMA301",10,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA301",11,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA301",12,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA301",13,0)
 ;
"RTN","SDAMA301",14,0)
 ;*****************************************************************
"RTN","SDAMA301",15,0)
SDAPI(SDINPUT) ;
"RTN","SDAMA301",16,0)
 ;*****************************************************************
"RTN","SDAMA301",17,0)
 ;
"RTN","SDAMA301",18,0)
 ;               GET APPOINTMENT DATA
"RTN","SDAMA301",19,0)
 ;
"RTN","SDAMA301",20,0)
 ;INPUT
"RTN","SDAMA301",21,0)
 ;  SDINPUT   Appointment Filters (required)
"RTN","SDAMA301",22,0)
 ;  
"RTN","SDAMA301",23,0)
 ;OUTPUT
"RTN","SDAMA301",24,0)
 ;    Extrinsic call returns: 
"RTN","SDAMA301",25,0)
 ;      -1 if error
"RTN","SDAMA301",26,0)
 ;      Appointment count if no error
"RTN","SDAMA301",27,0)
 ;    If no error, data returned in:
"RTN","SDAMA301",28,0)
 ;      ^TMP($J,"SDAMA301",SORT1,SORT2,Appt Date/Time)=DATAn^DATAn^..
"RTN","SDAMA301",29,0)
 ;      where SORT1 is first sort (patient or clinic), SORT2 is
"RTN","SDAMA301",30,0)
 ;      second sort (patient or clnic), and DATAn
"RTN","SDAMA301",31,0)
 ;      is the appointment data requested
"RTN","SDAMA301",32,0)
 ;    If erors, error codes and messages returned in:
"RTN","SDAMA301",33,0)
 ;      ^TMP($J,"SDAMA301","ERROR",error_code)=error_message
"RTN","SDAMA301",34,0)
 ;  
"RTN","SDAMA301",35,0)
 ;*****************************************************************
"RTN","SDAMA301",36,0)
 ;
"RTN","SDAMA301",37,0)
 K ^TMP($J,"SDAMA301")
"RTN","SDAMA301",38,0)
 ;Initialize global variables
"RTN","SDAMA301",39,0)
 N SDDV,SDI,SDARRAY,SDQUIT,SDFLTR,SDTEMP
"RTN","SDAMA301",40,0)
 S (SDARRAY("CNT"),SDARRAY("RSA"),SDQUIT,SDFLTR,SDTEMP)=0
"RTN","SDAMA301",41,0)
 ;Set Field Count and Max Filter variables
"RTN","SDAMA301",42,0)
 S SDARRAY("FC")=23,SDARRAY("MF")=3
"RTN","SDAMA301",43,0)
 ;Copy input array into "working" array
"RTN","SDAMA301",44,0)
 F SDI=1:1:SDARRAY("FC") S SDARRAY(SDI)=$G(SDINPUT(SDI))
"RTN","SDAMA301",45,0)
 S SDARRAY("FLDS")=$G(SDINPUT("FLDS"))
"RTN","SDAMA301",46,0)
 S SDARRAY("MAX")=$G(SDINPUT("MAX"))
"RTN","SDAMA301",47,0)
 S SDARRAY("SORT")=$G(SDINPUT("SORT"))
"RTN","SDAMA301",48,0)
 S SDARRAY("BD")=$G(SDINPUT("BD"))
"RTN","SDAMA301",49,0)
 ;Initialize Input Array Filters as needed. Quit if error
"RTN","SDAMA301",50,0)
 D INITAE^SDAMA306(.SDARRAY)
"RTN","SDAMA301",51,0)
 Q:SDQUIT -1
"RTN","SDAMA301",52,0)
 ;Validate Input Array Filters.  Quit if error
"RTN","SDAMA301",53,0)
 I ($$VALARR^SDAMA300(.SDARRAY,.SDFLTR)=-1) S SDQUIT=1
"RTN","SDAMA301",54,0)
 Q:SDQUIT -1
"RTN","SDAMA301",55,0)
 ;
"RTN","SDAMA301",56,0)
 ;If Patient DFN populated, process by patient
"RTN","SDAMA301",57,0)
 I $G(SDARRAY(4))]"" D
"RTN","SDAMA301",58,0)
 . ;set RSA flag to true
"RTN","SDAMA301",59,0)
 . S SDARRAY("RSA")=1
"RTN","SDAMA301",60,0)
 . ;get data
"RTN","SDAMA301",61,0)
 . D PAT^SDAMA303(.SDARRAY,.SDDV,.SDFLTR)
"RTN","SDAMA301",62,0)
 ;
"RTN","SDAMA301",63,0)
 ;If Patient DFN is not populated, process by clinic
"RTN","SDAMA301",64,0)
 I $G(SDARRAY(4))']"" D
"RTN","SDAMA301",65,0)
 . D CLIN^SDAMA302(.SDARRAY,.SDDV,.SDFLTR)
"RTN","SDAMA301",66,0)
 ;
"RTN","SDAMA301",67,0)
 ;--Phase II--
"RTN","SDAMA301",68,0)
 N SDRSA
"RTN","SDAMA301",69,0)
 S SDRSA=0
"RTN","SDAMA301",70,0)
 ;If RSA flag = "true" and RSA implemented, get data from RSA
"RTN","SDAMA301",71,0)
 I SDARRAY("RSA"),$$IMP^SDAMA307(1) D DATA^SDAMA307(.SDARRAY)
"RTN","SDAMA301",72,0)
 ;
"RTN","SDAMA301",73,0)
 ;Pass back appointment count
"RTN","SDAMA301",74,0)
 Q SDARRAY("CNT")
"RTN","SDAMA302")
0^8^B23704512
"RTN","SDAMA302",1,0)
SDAMA302 ;BPOIFO/ACS-Filter API By Clinic ;04 Dec 2003 [5/18/04 10:58am]
"RTN","SDAMA302",2,0)
 ;;5.3;Scheduling;**301**;13 Aug 1993
"RTN","SDAMA302",3,0)
 ;
"RTN","SDAMA302",4,0)
 ;*****************************************************************
"RTN","SDAMA302",5,0)
 ;              CHANGE LOG
"RTN","SDAMA302",6,0)
 ;
"RTN","SDAMA302",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA302",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA302",9,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA302",10,0)
 ;
"RTN","SDAMA302",11,0)
 ;*****************************************************************
"RTN","SDAMA302",12,0)
CLIN(SDARRAY,SDDV,SDFLTR) ;
"RTN","SDAMA302",13,0)
 ;*****************************************************************
"RTN","SDAMA302",14,0)
 ;
"RTN","SDAMA302",15,0)
 ;               GET APPOINTMENT DATA BY CLINIC
"RTN","SDAMA302",16,0)
 ;
"RTN","SDAMA302",17,0)
 ;INPUT
"RTN","SDAMA302",18,0)
 ;  SDARRAY   Appointment Filter array
"RTN","SDAMA302",19,0)
 ;  SDDV      Appointment Data Values array
"RTN","SDAMA302",20,0)
 ;  SDFLTR    Filter Flags array
"RTN","SDAMA302",21,0)
 ;  
"RTN","SDAMA302",22,0)
 ;OUTPUT
"RTN","SDAMA302",23,0)
 ;  
"RTN","SDAMA302",24,0)
 ;*****************************************************************
"RTN","SDAMA302",25,0)
 ;
"RTN","SDAMA302",26,0)
 N SDCOUNT,SDX,SDQUIT,SDCLIEN,SDSTART,SDEND,SDCLMIG,SDGBL
"RTN","SDAMA302",27,0)
 S (SDCOUNT,SDQUIT)=0
"RTN","SDAMA302",28,0)
 ;Set up start and end date/times for search criteria
"RTN","SDAMA302",29,0)
 I $G(SDARRAY("MAX"))'<0  D
"RTN","SDAMA302",30,0)
 .S SDSTART=$S(SDARRAY("FR")'="":(SDARRAY("FR")-.000001),1:0)
"RTN","SDAMA302",31,0)
 .S SDEND=SDARRAY("TO")
"RTN","SDAMA302",32,0)
 I $G(SDARRAY("MAX"))<0  D
"RTN","SDAMA302",33,0)
 .S SDSTART=$S($G(SDARRAY("FR"))'="":SDARRAY("FR"),1:0)
"RTN","SDAMA302",34,0)
 .S SDEND=(SDARRAY("TO")+.000001)
"RTN","SDAMA302",35,0)
 ;
"RTN","SDAMA302",36,0)
 ;If clinic filter is populated
"RTN","SDAMA302",37,0)
 I $L($G(SDARRAY(2)))>0 D
"RTN","SDAMA302",38,0)
 . ;if clinic is in a list:
"RTN","SDAMA302",39,0)
 . I SDARRAY("CLNGBL")=0 D
"RTN","SDAMA302",40,0)
 .. S SDCOUNT=$L(SDARRAY(2),";")
"RTN","SDAMA302",41,0)
 .. ;For each clinic in the filter:
"RTN","SDAMA302",42,0)
 .. F SDX=1:1:SDCOUNT D
"RTN","SDAMA302",43,0)
 ... S SDCLIEN=$P(SDARRAY(2),";",SDX)
"RTN","SDAMA302",44,0)
 ... D MIG(SDCLIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA302",45,0)
 . ;if clinic is in array, get IENs
"RTN","SDAMA302",46,0)
 . I SDARRAY("CLNGBL")=1 D
"RTN","SDAMA302",47,0)
 .. S SDGBL=SDARRAY(2),SDCLIEN=0
"RTN","SDAMA302",48,0)
 .. ;for each clinic in the global:
"RTN","SDAMA302",49,0)
 .. F  S SDCLIEN=$O(@(SDGBL_"SDCLIEN)")) Q:$G(SDCLIEN)=""  D
"RTN","SDAMA302",50,0)
 ... D MIG(SDCLIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA302",51,0)
 ;
"RTN","SDAMA302",52,0)
 ;If clinic filter is not populated
"RTN","SDAMA302",53,0)
 I $L(SDARRAY(2))'>0 D
"RTN","SDAMA302",54,0)
 . ;for each clinic on ^SC
"RTN","SDAMA302",55,0)
 . S SDCLIEN=0 F  S SDCLIEN=$O(^SC(SDCLIEN)) Q:(+$G(SDCLIEN)=0)  D
"RTN","SDAMA302",56,0)
 .. S SDARRAY("CLIN")=SDCLIEN
"RTN","SDAMA302",57,0)
 .. S SDCLMIG=$$CLMIG^SDAMA307(SDCLIEN)
"RTN","SDAMA302",58,0)
 .. ;if clinic has migrated, set flag else get appointment data
"RTN","SDAMA302",59,0)
 .. I SDCLMIG S SDARRAY("RSA")=1
"RTN","SDAMA302",60,0)
 .. E  D GETAPPT(SDCLIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA302",61,0)
 Q
"RTN","SDAMA302",62,0)
 ;
"RTN","SDAMA302",63,0)
MIG(SDCLIEN,SDSTART,SDEND,SDARRAY) ;
"RTN","SDAMA302",64,0)
 S SDCLMIG=$$CLMIG^SDAMA307(SDCLIEN)
"RTN","SDAMA302",65,0)
 ;if the clinic has migrated, add to list of migrated clinics else get appointment data
"RTN","SDAMA302",66,0)
 I SDCLMIG S SDARRAY("RSA")=1,SDARRAY("MIG")=$S($G(SDARRAY("MIG"))="":SDCLIEN,1:SDARRAY("MIG")_";"_SDCLIEN)
"RTN","SDAMA302",67,0)
 E  D
"RTN","SDAMA302",68,0)
 . S SDARRAY("CLIN")=SDCLIEN
"RTN","SDAMA302",69,0)
 . D GETAPPT(SDCLIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA302",70,0)
 Q
"RTN","SDAMA302",71,0)
 ;
"RTN","SDAMA302",72,0)
GETAPPT(SDCLIEN,SDSTART,SDEND,SDARRAY) ;
"RTN","SDAMA302",73,0)
 ;since "by clinic", 1st sort is clinic
"RTN","SDAMA302",74,0)
 S SDARRAY("SORT1")=SDCLIEN
"RTN","SDAMA302",75,0)
 N SDAPPTDT,SDA
"RTN","SDAMA302",76,0)
 ;if the current clinic has no appointments on ^SC, get next clinic
"RTN","SDAMA302",77,0)
 Q:'$D(^SC(SDCLIEN,"S"))
"RTN","SDAMA302",78,0)
 ;
"RTN","SDAMA302",79,0)
 ;
"RTN","SDAMA302",80,0)
 ;get first "N" appointments
"RTN","SDAMA302",81,0)
 I $G(SDARRAY("MAX"))'<0  D
"RTN","SDAMA302",82,0)
 .S SDAPPTDT=SDSTART
"RTN","SDAMA302",83,0)
 .;spin through each date/time for current clinic
"RTN","SDAMA302",84,0)
 .F  S SDAPPTDT=$O(^SC(SDCLIEN,"S",SDAPPTDT)) Q:$S(+$G(SDAPPTDT)=0:1,SDAPPTDT>SDEND:1,SDARRAY("CNT")=$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA302",85,0)
 .. ;spin through each appointment for that date/time
"RTN","SDAMA302",86,0)
 .. S SDA=0 F  S SDA=$O(^SC(SDCLIEN,"S",SDAPPTDT,1,SDA)) Q:$S(+$G(SDA)=0:1,SDARRAY("CNT")=$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA302",87,0)
 ... D GETINFO(SDCLIEN,SDAPPTDT,SDA,.SDARRAY)
"RTN","SDAMA302",88,0)
 ;
"RTN","SDAMA302",89,0)
 ;get last "N" appointments
"RTN","SDAMA302",90,0)
 I $G(SDARRAY("MAX"))<0  D
"RTN","SDAMA302",91,0)
 .S SDAPPTDT=SDEND
"RTN","SDAMA302",92,0)
 .;spin through each date/time for current clinic (REVERSE Order)
"RTN","SDAMA302",93,0)
 .F  S SDAPPTDT=$O(^SC(SDCLIEN,"S",SDAPPTDT),-1) Q:$S(+$G(SDAPPTDT)=0:1,SDAPPTDT<SDSTART:1,SDARRAY("CNT")=-$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA302",94,0)
 .. ;spin through each appointment for that date/time (REVERSE Order)
"RTN","SDAMA302",95,0)
 .. S SDA="" F  S SDA=$O(^SC(SDCLIEN,"S",SDAPPTDT,1,SDA),-1) Q:$S(+$G(SDA)=0:1,SDARRAY("CNT")=-$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA302",96,0)
 ... D GETINFO(SDCLIEN,SDAPPTDT,SDA,.SDARRAY)
"RTN","SDAMA302",97,0)
 Q
"RTN","SDAMA302",98,0)
 ;
"RTN","SDAMA302",99,0)
GETINFO(SDCLIEN,SDAPPTDT,SDA,SDARRAY) ;
"RTN","SDAMA302",100,0)
 N SDPATIEN,SDCAN,SDQUIT
"RTN","SDAMA302",101,0)
 S SDQUIT=0
"RTN","SDAMA302",102,0)
 ;get appointment data on ^SC
"RTN","SDAMA302",103,0)
 S SDARRAY("SC0")=$G(^SC(SDCLIEN,"S",SDAPPTDT,1,SDA,0))
"RTN","SDAMA302",104,0)
 S SDARRAY("SCC")=$G(^SC(SDCLIEN,"S",SDAPPTDT,1,SDA,"C"))
"RTN","SDAMA302",105,0)
 S SDARRAY("SCOB")=$G(^SC(SDCLIEN,"S",SDAPPTDT,1,SDA,"OB"))
"RTN","SDAMA302",106,0)
 S SDARRAY("DATE")=SDAPPTDT
"RTN","SDAMA302",107,0)
 ;exclude cancelled appts
"RTN","SDAMA302",108,0)
 S SDCAN=$P($G(SDARRAY("SC0")),"^",9)
"RTN","SDAMA302",109,0)
 Q:$G(SDCAN)="C"
"RTN","SDAMA302",110,0)
 ;initialize patient appointment data to null and get patient DFN
"RTN","SDAMA302",111,0)
 S (SDARRAY("DPT0"),SDARRAY("DPT1"))=""
"RTN","SDAMA302",112,0)
 S (SDPATIEN,SDARRAY("PAT"))=+SDARRAY("SC0")
"RTN","SDAMA302",113,0)
 ;quit if patient is null on ^SC
"RTN","SDAMA302",114,0)
 Q:SDPATIEN=0
"RTN","SDAMA302",115,0)
 ;since "by clinic", 2nd sort is patient
"RTN","SDAMA302",116,0)
 S SDARRAY("SORT2")=SDPATIEN
"RTN","SDAMA302",117,0)
 ;get corresponding appt zero node on ^DPT
"RTN","SDAMA302",118,0)
 S SDARRAY("DPT0")=$G(^DPT(SDPATIEN,"S",SDAPPTDT,0))
"RTN","SDAMA302",119,0)
 ;skip if appointment is cancelled on DPT
"RTN","SDAMA302",120,0)
 Q:($P($G(SDARRAY("DPT0")),"^",2)["C")
"RTN","SDAMA302",121,0)
 ;skip if appointment on DPT is for different clinic
"RTN","SDAMA302",122,0)
 Q:(+$G(SDARRAY("DPT0"))'=SDCLIEN)
"RTN","SDAMA302",123,0)
 ;get appointment 1 node on ^DPT
"RTN","SDAMA302",124,0)
 S SDARRAY("DPT1")=$G(^DPT(SDPATIEN,"S",SDAPPTDT,1))
"RTN","SDAMA302",125,0)
 ;appointment must match the "clinic" filter values
"RTN","SDAMA302",126,0)
 I $$MATCH^SDAMA304("C",.SDARRAY,.SDFLTR,.SDDV) D
"RTN","SDAMA302",127,0)
 . ;if appointment matches the "patient" filter values, put appointment data into output array
"RTN","SDAMA302",128,0)
 . I $$MATCH^SDAMA304("P",.SDARRAY,.SDFLTR,.SDDV) D SET^SDAMA305(.SDFLTR,.SDARRAY)
"RTN","SDAMA302",129,0)
 Q
"RTN","SDAMA303")
0^3^B22454517
"RTN","SDAMA303",1,0)
SDAMA303 ;BPOIFO/ACS-Filter API By Patient ;04 Dec 2003
"RTN","SDAMA303",2,0)
 ;;5.3;Scheduling;**301**;13 Aug 1993
"RTN","SDAMA303",3,0)
 ;
"RTN","SDAMA303",4,0)
 ;*****************************************************************
"RTN","SDAMA303",5,0)
 ;              CHANGE LOG
"RTN","SDAMA303",6,0)
 ;
"RTN","SDAMA303",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA303",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA303",9,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA303",10,0)
 ;
"RTN","SDAMA303",11,0)
 ;*****************************************************************
"RTN","SDAMA303",12,0)
PAT(SDARRAY,SDDV,SDFLTR) ;
"RTN","SDAMA303",13,0)
 ;*****************************************************************
"RTN","SDAMA303",14,0)
 ;
"RTN","SDAMA303",15,0)
 ;               GET APPOINTMENT DATA BY PATIENT
"RTN","SDAMA303",16,0)
 ;
"RTN","SDAMA303",17,0)
 ;INPUT
"RTN","SDAMA303",18,0)
 ;  SDARRAY   Appointment Filter array
"RTN","SDAMA303",19,0)
 ;  SDDV      Appointment Data Values array
"RTN","SDAMA303",20,0)
 ;  SDFLTR    Filter Flags array
"RTN","SDAMA303",21,0)
 ;  
"RTN","SDAMA303",22,0)
 ;*****************************************************************
"RTN","SDAMA303",23,0)
 ;
"RTN","SDAMA303",24,0)
 N SDCOUNT,SDX,SDQUIT,SDPATIEN,SDSTART,SDEND,SDGBL
"RTN","SDAMA303",25,0)
 S (SDCOUNT,SDQUIT)=0
"RTN","SDAMA303",26,0)
 ;Set up start and end date/times for search criteria
"RTN","SDAMA303",27,0)
 I $G(SDARRAY("MAX"))'<0  D
"RTN","SDAMA303",28,0)
 .S SDSTART=$S(SDARRAY("FR")'="":(SDARRAY("FR")-.000001),1:0)
"RTN","SDAMA303",29,0)
 .S SDEND=(SDARRAY("TO"))
"RTN","SDAMA303",30,0)
 I $G(SDARRAY("MAX"))<0  D
"RTN","SDAMA303",31,0)
 .S SDSTART=$S($G(SDARRAY("FR"))'="":SDARRAY("FR"),1:0)
"RTN","SDAMA303",32,0)
 .S SDEND=(SDARRAY("TO")+.000001)
"RTN","SDAMA303",33,0)
 ;
"RTN","SDAMA303",34,0)
 ;if patient is not in global, get patient from filter list
"RTN","SDAMA303",35,0)
 I SDARRAY("PATGBL")=0 D
"RTN","SDAMA303",36,0)
 . S SDCOUNT=$L(SDARRAY(4),";")
"RTN","SDAMA303",37,0)
 . ;for each patient in the filter:
"RTN","SDAMA303",38,0)
 . F SDX=1:1:SDCOUNT D
"RTN","SDAMA303",39,0)
 .. S SDPATIEN=$P(SDARRAY(4),";",SDX)
"RTN","SDAMA303",40,0)
 .. D GETAPPT(SDPATIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA303",41,0)
 ;if patient is in global, get patient from global
"RTN","SDAMA303",42,0)
 I SDARRAY("PATGBL")=1 D
"RTN","SDAMA303",43,0)
 . S SDGBL=SDARRAY(4),SDPATIEN=0
"RTN","SDAMA303",44,0)
 . ;for each patient in the global:
"RTN","SDAMA303",45,0)
 . F  S SDPATIEN=$O(@(SDGBL_"SDPATIEN)")) Q:+$G(SDPATIEN)=0  D
"RTN","SDAMA303",46,0)
 .. D GETAPPT(SDPATIEN,SDSTART,SDEND,.SDARRAY)
"RTN","SDAMA303",47,0)
 Q
"RTN","SDAMA303",48,0)
 ;
"RTN","SDAMA303",49,0)
GETAPPT(SDPATIEN,SDSTART,SDEND,SDARRAY) ;
"RTN","SDAMA303",50,0)
 ;if the patient has no appointments on ^DPT, get next patient
"RTN","SDAMA303",51,0)
 Q:'$D(^DPT(SDPATIEN,"S"))
"RTN","SDAMA303",52,0)
 ;since "by patient", 1st sort is patient
"RTN","SDAMA303",53,0)
 S (SDARRAY("SORT1"),SDARRAY("PAT"))=SDPATIEN
"RTN","SDAMA303",54,0)
 N SDAPPTDT
"RTN","SDAMA303",55,0)
 ;
"RTN","SDAMA303",56,0)
 ;get first "N" appointments
"RTN","SDAMA303",57,0)
 I $G(SDARRAY("MAX"))'<0  D
"RTN","SDAMA303",58,0)
 .S SDAPPTDT=SDSTART
"RTN","SDAMA303",59,0)
 .;Spin through each appointment on DPT for current patient
"RTN","SDAMA303",60,0)
 .F  S SDAPPTDT=$O(^DPT(SDPATIEN,"S",SDAPPTDT)) Q:$S(+$G(SDAPPTDT)=0:1,SDAPPTDT>SDEND:1,SDARRAY("CNT")=$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA303",61,0)
 .. D GETINFO(SDPATIEN,SDAPPTDT,.SDARRAY)
"RTN","SDAMA303",62,0)
 ;
"RTN","SDAMA303",63,0)
 ;get last "N" appointments
"RTN","SDAMA303",64,0)
 I $G(SDARRAY("MAX"))<0  D
"RTN","SDAMA303",65,0)
 .S SDAPPTDT=SDEND
"RTN","SDAMA303",66,0)
 .;spin through each appointment on DPT for current patient (REVERSE Order)
"RTN","SDAMA303",67,0)
 .F  S SDAPPTDT=$O(^DPT(SDPATIEN,"S",SDAPPTDT),-1) Q:$S(+$G(SDAPPTDT)=0:1,SDAPPTDT<SDSTART:1,SDARRAY("CNT")=-$G(SDARRAY("MAX")):1,1:0)  D
"RTN","SDAMA303",68,0)
 .. D GETINFO(SDPATIEN,SDAPPTDT,.SDARRAY)
"RTN","SDAMA303",69,0)
 Q
"RTN","SDAMA303",70,0)
 ;
"RTN","SDAMA303",71,0)
GETINFO(SDPATIEN,SDAPPTDT,SDARRAY) ;
"RTN","SDAMA303",72,0)
 N SDMATCH,SDCLINIC,SDA,SDQUIT
"RTN","SDAMA303",73,0)
 S SDQUIT=0
"RTN","SDAMA303",74,0)
 ; initialize array to hold data values
"RTN","SDAMA303",75,0)
 S SDARRAY("DPT0")=$G(^DPT(SDPATIEN,"S",SDAPPTDT,0))
"RTN","SDAMA303",76,0)
 S SDARRAY("DPT1")=$G(^DPT(SDPATIEN,"S",SDAPPTDT,1))
"RTN","SDAMA303",77,0)
 S SDARRAY("DATE")=SDAPPTDT
"RTN","SDAMA303",78,0)
 ;appointment must match the "patient" filter values
"RTN","SDAMA303",79,0)
 I $$MATCH^SDAMA304("P",.SDARRAY,.SDFLTR,.SDDV) D
"RTN","SDAMA303",80,0)
 . ;set clinic appointment data to null and get clinic
"RTN","SDAMA303",81,0)
 . S (SDARRAY("SC0"),SDARRAY("SCC"),SDARRAY("SCOB"))=""
"RTN","SDAMA303",82,0)
 . S SDCLINIC=+$G(SDARRAY("DPT0"))
"RTN","SDAMA303",83,0)
 . ;quit if clinic is null(0)
"RTN","SDAMA303",84,0)
 . Q:SDCLINIC=0
"RTN","SDAMA303",85,0)
 . S SDARRAY("CLIN")=SDCLINIC
"RTN","SDAMA303",86,0)
 . ;since "by patient", 2nd sort is clinic
"RTN","SDAMA303",87,0)
 . S SDARRAY("SORT2")=SDCLINIC
"RTN","SDAMA303",88,0)
 . ;make sure clinic has not migrated
"RTN","SDAMA303",89,0)
 . Q:($$CLMIG^SDAMA307(SDCLINIC))
"RTN","SDAMA303",90,0)
 . S SDMATCH=1
"RTN","SDAMA303",91,0)
 . ;if appointment is not cancelled on ^DPT, find corresponding appt on ^SC
"RTN","SDAMA303",92,0)
 . ;and get data
"RTN","SDAMA303",93,0)
 . I ";C;CA;PC;PCA;"'[(";"_$P($G(SDARRAY("DPT0")),"^",2)_";") D
"RTN","SDAMA303",94,0)
 .. N SDCANCEL
"RTN","SDAMA303",95,0)
 .. S SDQUIT=0,SDA=0,SDMATCH=0
"RTN","SDAMA303",96,0)
 .. ;for current clinic and appt d/t, find matching appt on ^SC
"RTN","SDAMA303",97,0)
 .. F  S SDA=$O(^SC(SDCLINIC,"S",SDAPPTDT,1,SDA)) Q:(($G(SDA)="")!(SDQUIT=1))  D
"RTN","SDAMA303",98,0)
 ... S SDCANCEL=0
"RTN","SDAMA303",99,0)
 ... ;get next appt if patient doesn't match
"RTN","SDAMA303",100,0)
 ... Q:(+$G(^SC(SDCLINIC,"S",SDAPPTDT,1,SDA,0))'=SDPATIEN)
"RTN","SDAMA303",101,0)
 ... ;get appointment data on ^SC
"RTN","SDAMA303",102,0)
 ... S SDARRAY("SC0")=$G(^SC(SDCLINIC,"S",SDAPPTDT,1,SDA,0))
"RTN","SDAMA303",103,0)
 ... ;get next appt if cancelled on SC
"RTN","SDAMA303",104,0)
 ... S SDCANCEL=$P($G(SDARRAY("SC0")),"^",9)
"RTN","SDAMA303",105,0)
 ... Q:($G(SDCANCEL)="C")
"RTN","SDAMA303",106,0)
 ... ;get appointment "C" node on ^SC
"RTN","SDAMA303",107,0)
 ... S SDARRAY("SCC")=$G(^SC(SDCLINIC,"S",SDAPPTDT,1,SDA,"C"))
"RTN","SDAMA303",108,0)
 ... ;get appointment "OB" node on ^SC
"RTN","SDAMA303",109,0)
 ... S SDARRAY("SCOB")=$G(^SC(SDCLINIC,"S",SDAPPTDT,1,SDA,"OB"))
"RTN","SDAMA303",110,0)
 ... ;Corresponding appointment found on ^SC
"RTN","SDAMA303",111,0)
 ... S SDQUIT=1,SDMATCH=1
"RTN","SDAMA303",112,0)
 . ;if appointment matches the clinic filters, put appointment data into output array
"RTN","SDAMA303",113,0)
 . I SDMATCH D
"RTN","SDAMA303",114,0)
 .. I $$MATCH^SDAMA304("C",.SDARRAY,.SDFLTR,.SDDV) D SET^SDAMA305(.SDFLTR,.SDARRAY)
"RTN","SDAMA303",115,0)
 Q
"RTN","SDAMA304")
0^4^B5782534
"RTN","SDAMA304",1,0)
SDAMA304 ;BPOIFO/ACS-Filter API Apply Filters ;04 Dec 2003
"RTN","SDAMA304",2,0)
 ;;5.3;Scheduling;**301**;13 Aug 1993
"RTN","SDAMA304",3,0)
 ;
"RTN","SDAMA304",4,0)
 ;*****************************************************************
"RTN","SDAMA304",5,0)
 ;              CHANGE LOG
"RTN","SDAMA304",6,0)
 ;
"RTN","SDAMA304",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA304",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA304",9,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA304",10,0)
 ;
"RTN","SDAMA304",11,0)
 ;*****************************************************************
"RTN","SDAMA304",12,0)
MATCH(SDFTYPE,SDARRAY,SDFLTR,SDDV) ;
"RTN","SDAMA304",13,0)
 ;*****************************************************************
"RTN","SDAMA304",14,0)
 ;
"RTN","SDAMA304",15,0)
 ;                  APPLY FILTERS (Extrinsic call)
"RTN","SDAMA304",16,0)
 ;
"RTN","SDAMA304",17,0)
 ;INPUT
"RTN","SDAMA304",18,0)
 ;  SDFTYPE    Filter Type (P-patient or C-clinic)
"RTN","SDAMA304",19,0)
 ;  SDARRAY    Appointment Filter array
"RTN","SDAMA304",20,0)
 ;  SDFLTR     Filter Flags array
"RTN","SDAMA304",21,0)
 ;  SDDV       Appointment Data Values array
"RTN","SDAMA304",22,0)
 ;  
"RTN","SDAMA304",23,0)
 ;OUTPUT
"RTN","SDAMA304",24,0)
 ;  SDMATCH   -1 if no match
"RTN","SDAMA304",25,0)
 ;             1 if match
"RTN","SDAMA304",26,0)
 ;*****************************************************************
"RTN","SDAMA304",27,0)
 ;
"RTN","SDAMA304",28,0)
 N SDMATCH,SDX,SDCLIEN
"RTN","SDAMA304",29,0)
 S SDMATCH=0
"RTN","SDAMA304",30,0)
 ;apply patient or clinic filters
"RTN","SDAMA304",31,0)
 I SDFTYPE="P" D PMATCH(.SDARRAY,.SDMATCH)
"RTN","SDAMA304",32,0)
 I SDFTYPE="C" D CMATCH(.SDARRAY,.SDMATCH)
"RTN","SDAMA304",33,0)
 Q SDMATCH
"RTN","SDAMA304",34,0)
PMATCH(SDARRAY,SDMATCH) ;Apply ^DPT-related filters
"RTN","SDAMA304",35,0)
 S SDMATCH=1
"RTN","SDAMA304",36,0)
 ;Clinic
"RTN","SDAMA304",37,0)
 I SDFLTR(2) D
"RTN","SDAMA304",38,0)
 . S SDDV(2)=$P($G(SDARRAY("DPT0")),"^",1)
"RTN","SDAMA304",39,0)
 . I SDDV(2)']"" S SDMATCH=0 Q
"RTN","SDAMA304",40,0)
 . ;apply filter to list or global
"RTN","SDAMA304",41,0)
 . I SDARRAY("CLNGBL")=1 D
"RTN","SDAMA304",42,0)
 .. S SDX=SDARRAY(2),SDCLIEN=SDDV(2)
"RTN","SDAMA304",43,0)
 .. I '$D(@(SDX_"SDCLIEN)")) S SDMATCH=0
"RTN","SDAMA304",44,0)
 . I SDARRAY("CLNGBL")=0 D
"RTN","SDAMA304",45,0)
 .. I ((";"_$G(SDARRAY(2))_";")'[(";"_SDDV(2)_";")) S SDMATCH=0
"RTN","SDAMA304",46,0)
 Q:'SDMATCH
"RTN","SDAMA304",47,0)
 ;Appointment Status
"RTN","SDAMA304",48,0)
 I SDFLTR(3) D
"RTN","SDAMA304",49,0)
 . N SDSTAT,SDTEMP
"RTN","SDAMA304",50,0)
 . S SDTEMP=$P($G(SDARRAY("DPT0")),"^",2)
"RTN","SDAMA304",51,0)
 . S SDSTAT=$S($G(SDTEMP)="":"R",SDTEMP="I":"I",SDTEMP="C":"CC",1:"X")
"RTN","SDAMA304",52,0)
 . I SDSTAT="X" S SDSTAT=$S(SDTEMP="CA":"CCR",SDTEMP="PC":"CP",1:"X")
"RTN","SDAMA304",53,0)
 . I SDSTAT="X" S SDSTAT=$S(SDTEMP="PCA":"CPR",SDTEMP="N":"NS",1:"X")
"RTN","SDAMA304",54,0)
 . I SDSTAT="X" S SDSTAT=$S(SDTEMP="NA":"NSR",SDTEMP="NT":"NT",1:"X")
"RTN","SDAMA304",55,0)
 . S SDDV(3)=SDSTAT
"RTN","SDAMA304",56,0)
 . I ((";"_$G(SDARRAY(3))_";")'[(";"_SDDV(3)_";")) S SDMATCH=0
"RTN","SDAMA304",57,0)
 Q
"RTN","SDAMA304",58,0)
 ;       
"RTN","SDAMA304",59,0)
CMATCH(SDARRAY,SDMATCH) ;Apply ^SC-related filters
"RTN","SDAMA304",60,0)
 N SDAMCLIN,SDSTOP
"RTN","SDAMA304",61,0)
 S SDMATCH=1
"RTN","SDAMA304",62,0)
 ;Primary Stop Code
"RTN","SDAMA304",63,0)
 I SDFLTR(13) D
"RTN","SDAMA304",64,0)
 . S SDAMCLIN=+$G(SDARRAY("DPT0"))
"RTN","SDAMA304",65,0)
 . I $G(SDAMCLIN)="" S SDMATCH=0 Q
"RTN","SDAMA304",66,0)
 . S SDSTOP=$P($G(^SC(SDAMCLIN,0)),"^",7)
"RTN","SDAMA304",67,0)
 . I $G(SDSTOP)="" S SDMATCH=0 Q
"RTN","SDAMA304",68,0)
 . S SDDV(13)=$P($G(^DIC(40.7,SDSTOP,0)),"^",2)
"RTN","SDAMA304",69,0)
 . I $G(SDDV(13))="" S SDMATCH=0 Q
"RTN","SDAMA304",70,0)
 . I ((";"_$G(SDARRAY(13))_";")'[(";"_SDDV(13)_";")) S SDMATCH=0
"RTN","SDAMA304",71,0)
 Q
"RTN","SDAMA305")
0^5^B36725544
"RTN","SDAMA305",1,0)
SDAMA305 ;BPOIFO/ACS-Filter API Get Data ; 5/10/04 8:12am [5/18/04 10:59am]
"RTN","SDAMA305",2,0)
 ;;5.3;Scheduling;**301**;13 Aug 1993
"RTN","SDAMA305",3,0)
 ;
"RTN","SDAMA305",4,0)
 ;*****************************************************************
"RTN","SDAMA305",5,0)
 ;              CHANGE LOG
"RTN","SDAMA305",6,0)
 ;
"RTN","SDAMA305",7,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA305",8,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA305",9,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA305",10,0)
 ;
"RTN","SDAMA305",11,0)
 ;*****************************************************************
"RTN","SDAMA305",12,0)
SET(SDFLTR,SDARRAY) ;
"RTN","SDAMA305",13,0)
 ;*****************************************************************
"RTN","SDAMA305",14,0)
 ;
"RTN","SDAMA305",15,0)
 ;              GET APPOINTMENT DATA FROM VISTA
"RTN","SDAMA305",16,0)
 ;              
"RTN","SDAMA305",17,0)
 ;INPUT
"RTN","SDAMA305",18,0)
 ;  SDARRAY    Appointment Filter array
"RTN","SDAMA305",19,0)
 ;  
"RTN","SDAMA305",20,0)
 ;OUTPUT
"RTN","SDAMA305",21,0)
 ;  ^TMP($J,"SDAMA301",SORT1,SORT2,APPT D/T)
"RTN","SDAMA305",22,0)
 ;  
"RTN","SDAMA305",23,0)
 ;*****************************************************************
"RTN","SDAMA305",24,0)
 ;Initialize local variables
"RTN","SDAMA305",25,0)
 N SDI,SDIEN,SDNAME,SDFLDS,SDDATA,SDCOUNT,SDFIELD,SDCLIEN,SDDV
"RTN","SDAMA305",26,0)
 S SDFLDS=SDARRAY("FLDS")
"RTN","SDAMA305",27,0)
 S SDCOUNT=$L(SDFLDS,";")
"RTN","SDAMA305",28,0)
 ;Add 1 to appointment count
"RTN","SDAMA305",29,0)
 S SDARRAY("CNT")=(SDARRAY("CNT")+1)
"RTN","SDAMA305",30,0)
 ;For each appoitment field requested
"RTN","SDAMA305",31,0)
 F SDI=1:1:SDCOUNT D
"RTN","SDAMA305",32,0)
 . S (SDIEN,SDNAME,SDDATA)=""
"RTN","SDAMA305",33,0)
 . S SDFIELD=$P(SDFLDS,";",SDI)
"RTN","SDAMA305",34,0)
 . ;get data
"RTN","SDAMA305",35,0)
 . D @SDFIELD
"RTN","SDAMA305",36,0)
 . ;nodes in output global can't be null
"RTN","SDAMA305",37,0)
 . I $G(SDARRAY("SORT1"))="" S SDARRAY("SORT1")="X"_SDARRAY("CNT")
"RTN","SDAMA305",38,0)
 . I $G(SDARRAY("SORT2"))="" S SDARRAY("SORT2")="Y"_SDARRAY("CNT")
"RTN","SDAMA305",39,0)
 . ;add data to output array
"RTN","SDAMA305",40,0)
 . ;Store information with just Patient IEN (No Clinic IEN) in the global reference
"RTN","SDAMA305",41,0)
 . I $G(SDARRAY("SORT"))="P" D
"RTN","SDAMA305",42,0)
 . .S $P(^TMP($J,"SDAMA301",$G(SDARRAY("PAT")),SDARRAY("DATE")),"^",SDFIELD)=$S(SDFIELD=6:"",1:$G(SDDV(SDFIELD)))
"RTN","SDAMA305",43,0)
 . .I SDFIELD=6 S ^TMP($J,"SDAMA301",$G(SDARRAY("PAT")),SDARRAY("DATE"),"C")=$G(SDDV(SDFIELD))
"RTN","SDAMA305",44,0)
 . ;Store information with Patient and Clinic IEN (Sort1, Sort2) in the global reference
"RTN","SDAMA305",45,0)
 . I $G(SDARRAY("SORT"))'="P" D
"RTN","SDAMA305",46,0)
 . .S $P(^TMP($J,"SDAMA301",SDARRAY("SORT1"),SDARRAY("SORT2"),SDARRAY("DATE")),"^",SDFIELD)=$S(SDFIELD=6:"",1:$G(SDDV(SDFIELD)))
"RTN","SDAMA305",47,0)
 . .I SDFIELD=6 S ^TMP($J,"SDAMA301",SDARRAY("SORT1"),SDARRAY("SORT2"),SDARRAY("DATE"),"C")=$G(SDDV(SDFIELD))
"RTN","SDAMA305",48,0)
 Q
"RTN","SDAMA305",49,0)
1 ;Appt date/time
"RTN","SDAMA305",50,0)
 S SDDV(SDFIELD)=SDARRAY("DATE")
"RTN","SDAMA305",51,0)
 Q
"RTN","SDAMA305",52,0)
2 ;Clinic IEN and Name
"RTN","SDAMA305",53,0)
 S SDIEN=+$G(SDARRAY("DPT0"))
"RTN","SDAMA305",54,0)
 I '$G(SDIEN) S SDNAME=""
"RTN","SDAMA305",55,0)
 E  S SDNAME=$P($G(^SC(SDIEN,0)),"^",1)
"RTN","SDAMA305",56,0)
 S SDDV(SDFIELD)=$G(SDIEN)_";"_$G(SDNAME)
"RTN","SDAMA305",57,0)
 Q
"RTN","SDAMA305",58,0)
3 ;Appt Status and Status Description
"RTN","SDAMA305",59,0)
 N SDSTAT
"RTN","SDAMA305",60,0)
 S SDSTAT=$P($G(SDARRAY("DPT0")),"^",2)
"RTN","SDAMA305",61,0)
 I $G(SDSTAT)="" S SDDATA="R;SCHEDULED/KEPT"
"RTN","SDAMA305",62,0)
 E  D
"RTN","SDAMA305",63,0)
 . S SDDATA=$S(SDSTAT="I":"I;INPATIENT",SDSTAT="C":"CC;CANCELLED BY CLINIC",1:"X")
"RTN","SDAMA305",64,0)
 . I SDDATA="X" S SDDATA=$S(SDSTAT="CA":"CCR;CANCELLED BY CLINIC & RESCHEDULED",SDSTAT="PC":"CP;CANCELLED BY PATIENT",1:"X")
"RTN","SDAMA305",65,0)
 . I SDDATA="X" S SDDATA=$S(SDSTAT="PCA":"CPR;CANCELLED BY PATIENT & RESCHEDULED",SDSTAT="N":"NS;NO-SHOW",1:"X")
"RTN","SDAMA305",66,0)
 . I SDDATA="X" S SDDATA=$S(SDSTAT="NA":"NSR;NO-SHOW & RESCHEDULED",SDSTAT="NT":"NT;NO ACTION TAKEN",1:SDSTAT_";UNKNOWN")
"RTN","SDAMA305",67,0)
 S SDDV(SDFIELD)=SDDATA
"RTN","SDAMA305",68,0)
 Q
"RTN","SDAMA305",69,0)
4 ;Patient IEN and Name
"RTN","SDAMA305",70,0)
 S SDIEN=$G(SDARRAY("PAT"))
"RTN","SDAMA305",71,0)
 S SDNAME=$P($G(^DPT(SDIEN,0)),"^",1)
"RTN","SDAMA305",72,0)
 S SDDV(SDFIELD)=$G(SDIEN)_";"_$G(SDNAME)
"RTN","SDAMA305",73,0)
 Q
"RTN","SDAMA305",74,0)
5 ;Length of Appt
"RTN","SDAMA305",75,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("SC0")),"^",2)
"RTN","SDAMA305",76,0)
 Q
"RTN","SDAMA305",77,0)
6 ;Comments
"RTN","SDAMA305",78,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("SC0")),"^",4)
"RTN","SDAMA305",79,0)
 Q
"RTN","SDAMA305",80,0)
7 ;Overbook (return null if appt cancelled)
"RTN","SDAMA305",81,0)
 I $G(SDARRAY("SC0"))'="" D
"RTN","SDAMA305",82,0)
 . S SDDATA=$P($G(SDARRAY("SCOB")),"^",1)
"RTN","SDAMA305",83,0)
 . S SDDV(SDFIELD)=$S($G(SDDATA)="O":"Y",1:"N")
"RTN","SDAMA305",84,0)
 Q
"RTN","SDAMA305",85,0)
8 ;Eligiblity of Visit Code and Name
"RTN","SDAMA305",86,0)
 S SDDATA=$P($G(SDARRAY("SC0")),"^",10)
"RTN","SDAMA305",87,0)
 I $G(SDDATA)]"" D
"RTN","SDAMA305",88,0)
 . S SDIEN=$P($G(^DIC(8,SDDATA,0)),"^",9)
"RTN","SDAMA305",89,0)
 . I $G(SDIEN) S SDNAME=$P($G(^DIC(8.1,SDIEN,0)),"^",1)
"RTN","SDAMA305",90,0)
 . I $G(SDIEN) S SDDV(SDFIELD)=$G(SDIEN)_";"_$G(SDNAME)
"RTN","SDAMA305",91,0)
 Q
"RTN","SDAMA305",92,0)
9 ;Check-In Date/time
"RTN","SDAMA305",93,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("SCC")),"^",1)
"RTN","SDAMA305",94,0)
 Q
"RTN","SDAMA305",95,0)
10 ;Appt Type IEN and Name
"RTN","SDAMA305",96,0)
 S SDIEN=$P($G(SDARRAY("DPT0")),"^",16)
"RTN","SDAMA305",97,0)
 I $G(SDIEN)]"" D
"RTN","SDAMA305",98,0)
 . S SDNAME=$P($G(^SD(409.1,SDIEN,0)),"^",1)
"RTN","SDAMA305",99,0)
 . S SDDV(SDFIELD)=$G(SDIEN)_";"_$G(SDNAME)
"RTN","SDAMA305",100,0)
 Q
"RTN","SDAMA305",101,0)
11 ;Check-Out date/time
"RTN","SDAMA305",102,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("SCC")),"^",3)
"RTN","SDAMA305",103,0)
 Q
"RTN","SDAMA305",104,0)
12 ;Outpatient Encounter
"RTN","SDAMA305",105,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",20)
"RTN","SDAMA305",106,0)
 Q
"RTN","SDAMA305",107,0)
13 ;Primary Stop Code IEN and AMIS STOP CODE
"RTN","SDAMA305",108,0)
 N SDCODES
"RTN","SDAMA305",109,0)
 S SDCLIEN=+SDARRAY("DPT0")
"RTN","SDAMA305",110,0)
 I $G(SDCLIEN)]"" D
"RTN","SDAMA305",111,0)
 . S SDCODES=$$GETSTOP(SDCLIEN)
"RTN","SDAMA305",112,0)
 . I SDCODES'=-1 S SDDV(SDFIELD)=$P(SDCODES,"^",1)
"RTN","SDAMA305",113,0)
 Q
"RTN","SDAMA305",114,0)
14 ;Credit Stop Code IEN and AMIS STOP CODE
"RTN","SDAMA305",115,0)
 S SDCLIEN=+SDARRAY("DPT0")
"RTN","SDAMA305",116,0)
 I $G(SDCLIEN)]"" D
"RTN","SDAMA305",117,0)
 . S SDCODES=$$GETSTOP(SDCLIEN)
"RTN","SDAMA305",118,0)
 . I SDCODES'=-1 S SDDV(SDFIELD)=$P(SDCODES,"^",2)
"RTN","SDAMA305",119,0)
 Q
"RTN","SDAMA305",120,0)
15 ;Workload Non-Count
"RTN","SDAMA305",121,0)
 S SDCLIEN=+SDARRAY("DPT0")
"RTN","SDAMA305",122,0)
 I $G(SDCLIEN)]"" D
"RTN","SDAMA305",123,0)
 . S SDCODES=$$GETSTOP(SDCLIEN)
"RTN","SDAMA305",124,0)
 . I SDCODES'=-1 S SDDV(SDFIELD)=$P($G(SDCODES),"^",3)
"RTN","SDAMA305",125,0)
 Q
"RTN","SDAMA305",126,0)
16 ;Date Appt Made
"RTN","SDAMA305",127,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",19)
"RTN","SDAMA305",128,0)
 Q
"RTN","SDAMA305",129,0)
17 ;Desired Date of Appt
"RTN","SDAMA305",130,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT1")),"^",1)
"RTN","SDAMA305",131,0)
 Q
"RTN","SDAMA305",132,0)
18 ;Purpose of Visit
"RTN","SDAMA305",133,0)
 S SDDATA=$P($G(SDARRAY("DPT0")),"^",7)
"RTN","SDAMA305",134,0)
 I $G(SDDATA)'="" D
"RTN","SDAMA305",135,0)
 . S SDDATA=SDDATA_$S(SDDATA="1":";C&P",SDDATA="2":";10-10",SDDATA="3":";SV",SDDATA="4":";UV",1:";")
"RTN","SDAMA305",136,0)
 . S SDDV(SDFIELD)=SDDATA
"RTN","SDAMA305",137,0)
 Q
"RTN","SDAMA305",138,0)
19 ;EKG Date/time
"RTN","SDAMA305",139,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",5)
"RTN","SDAMA305",140,0)
 Q
"RTN","SDAMA305",141,0)
20 ;X-Ray Date/time
"RTN","SDAMA305",142,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",4)
"RTN","SDAMA305",143,0)
 Q
"RTN","SDAMA305",144,0)
21 ;Lab Date/time
"RTN","SDAMA305",145,0)
 S SDDV(SDFIELD)=$P($G(SDARRAY("DPT0")),"^",3)
"RTN","SDAMA305",146,0)
 Q
"RTN","SDAMA305",147,0)
22 ;Status 
"RTN","SDAMA305",148,0)
 ;   (Status IEN; Status Description; Print Status; Checked In Date/Time; 
"RTN","SDAMA305",149,0)
 ;       Checked Out Date/Time; Admission Movement IEN)
"RTN","SDAMA305",150,0)
 ;       
"RTN","SDAMA305",151,0)
 ;convert to new appt status code
"RTN","SDAMA305",152,0)
 D 3
"RTN","SDAMA305",153,0)
 S SDDV(SDFIELD)=$$STATUS^SDAMA308(+$G(SDARRAY("PAT")),+$G(SDARRAY("DATE")),+$G(SDARRAY("DPT0")),$P(SDDV(SDFIELD),";"),$P($G(SDARRAY("SCC")),"^"),$P($G(SDARRAY("SCC")),"^",3),$P($G(SDARRAY("DPT0")),"^",20))
"RTN","SDAMA305",154,0)
 Q
"RTN","SDAMA305",155,0)
23 ;X-Ray Films
"RTN","SDAMA305",156,0)
 N SDRECS
"RTN","SDAMA305",157,0)
 ;Get Clinic IEN, X-Ray Films Required
"RTN","SDAMA305",158,0)
 S SDIEN=+$G(SDARRAY("DPT0"))
"RTN","SDAMA305",159,0)
 S SDRECS=$P($G(^SC(SDIEN,"RAD")),"^")
"RTN","SDAMA305",160,0)
 ;Translate Lower Case to Upper
"RTN","SDAMA305",161,0)
 S SDRECS=$TR(SDRECS,"ny","NY")
"RTN","SDAMA305",162,0)
 S SDDATA=$S(SDRECS["Y":"Y",1:"N")
"RTN","SDAMA305",163,0)
 S SDDV(SDFIELD)=SDDATA
"RTN","SDAMA305",164,0)
 Q
"RTN","SDAMA305",165,0)
GETSTOP(SDCLIEN) ;Primary Stop Code, Credit Stop Code, Non-Count
"RTN","SDAMA305",166,0)
 ; return codes or -1 if bad clinic
"RTN","SDAMA305",167,0)
 N SDPSC,SDPSCIEN,SDCSC,SDCSCIEN,SDNC,SDCODES
"RTN","SDAMA305",168,0)
 I +$G(SDCLIEN)=0 S SDCODES=-1
"RTN","SDAMA305",169,0)
 I +$G(SDCLIEN)'=0 D
"RTN","SDAMA305",170,0)
 . ;make sure clinic is on ^SC
"RTN","SDAMA305",171,0)
 . I '$D(^SC(SDCLIEN)) S SDCODES=-1 Q
"RTN","SDAMA305",172,0)
 . ;get primary stop code ien
"RTN","SDAMA305",173,0)
 . S SDPSCIEN=$P($G(^SC(SDCLIEN,0)),"^",7)
"RTN","SDAMA305",174,0)
 . ;get credit stop code ien
"RTN","SDAMA305",175,0)
 . S SDCSCIEN=$P($G(^SC(SDCLIEN,0)),"^",18)
"RTN","SDAMA305",176,0)
 . I $G(SDPSCIEN) S SDPSC=$P($G(^DIC(40.7,SDPSCIEN,0)),"^",2)
"RTN","SDAMA305",177,0)
 . I $G(SDCSCIEN) S SDCSC=$P($G(^DIC(40.7,SDCSCIEN,0)),"^",2)
"RTN","SDAMA305",178,0)
 . ;get workload non-count
"RTN","SDAMA305",179,0)
 . S SDNC=$P($G(^SC(SDCLIEN,0)),"^",17)
"RTN","SDAMA305",180,0)
 . S SDNC=$S($G(SDNC)="Y":"Y",1:"N")
"RTN","SDAMA305",181,0)
 . S SDCODES=$G(SDPSCIEN)_";"_$G(SDPSC)_"^"_$G(SDCSCIEN)_";"_$G(SDCSC)_"^"_SDNC
"RTN","SDAMA305",182,0)
 Q SDCODES
"RTN","SDAMA306")
0^9^B3957578
"RTN","SDAMA306",1,0)
SDAMA306 ;BPOIFO/ACS-Filter API Utilities ;04 Dec 2003
"RTN","SDAMA306",2,0)
 ;;5.3;Scheduling;**301**;13 Aug 1993
"RTN","SDAMA306",3,0)
 ;
"RTN","SDAMA306",4,0)
 ;
"RTN","SDAMA306",5,0)
 ;*****************************************************************
"RTN","SDAMA306",6,0)
 ;              CHANGE LOG
"RTN","SDAMA306",7,0)
 ;
"RTN","SDAMA306",8,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA306",9,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA306",10,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA306",11,0)
 ;
"RTN","SDAMA306",12,0)
 ;*****************************************************************
"RTN","SDAMA306",13,0)
ADD(SDARRAY) ;Add RSA data to VistA data and re-calculate the
"RTN","SDAMA306",14,0)
 ;appointment count (Phase II)
"RTN","SDAMA306",15,0)
 Q
"RTN","SDAMA306",16,0)
INITAE(SDARRAY) ;Initialize Array Entries as needed
"RTN","SDAMA306",17,0)
 ;Initialize Appointment "From" and "To" dates if null
"RTN","SDAMA306",18,0)
 N SDYEAR,SDFROM,SDTO,SDPARM
"RTN","SDAMA306",19,0)
 S SDPARM=1
"RTN","SDAMA306",20,0)
 S SDFROM=$P($G(SDARRAY(1)),";",1)
"RTN","SDAMA306",21,0)
 S SDTO=$P($G(SDARRAY(1)),";",2)
"RTN","SDAMA306",22,0)
 I $G(SDTO)="" D
"RTN","SDAMA306",23,0)
 . S SDTO="9999999.9999"
"RTN","SDAMA306",24,0)
 I SDTO'["." S SDTO=SDTO_".9999"
"RTN","SDAMA306",25,0)
 S SDARRAY("FR")=$G(SDFROM)
"RTN","SDAMA306",26,0)
 S SDARRAY("TO")=$G(SDTO)
"RTN","SDAMA306",27,0)
 ;
"RTN","SDAMA306",28,0)
 ;Remove leading and trailing semi-colons from filter lists if present
"RTN","SDAMA306",29,0)
 N SDNODE
"RTN","SDAMA306",30,0)
 F SDNODE=2,3,4,13,"FLDS" D
"RTN","SDAMA306",31,0)
 . I $L($G(SDARRAY(SDNODE)))>0 D
"RTN","SDAMA306",32,0)
 .. I $E(SDARRAY(SDNODE),$L(SDARRAY(SDNODE)))=";" D
"RTN","SDAMA306",33,0)
 ... S SDARRAY(SDNODE)=$E(SDARRAY(SDNODE),1,($L(SDARRAY(SDNODE))-1))
"RTN","SDAMA306",34,0)
 .. I $E(SDARRAY(SDNODE),1)=";" D
"RTN","SDAMA306",35,0)
 ... S SDARRAY(SDNODE)=$E(SDARRAY(SDNODE),2,$L(SDARRAY(SDNODE)))
"RTN","SDAMA306",36,0)
 ;
"RTN","SDAMA306",37,0)
 ;If the patient list is in a global, add comma at end if needed
"RTN","SDAMA306",38,0)
 S SDARRAY("PATGBL")=0
"RTN","SDAMA306",39,0)
 I $G(SDARRAY(4))["(" D
"RTN","SDAMA306",40,0)
 . ;flag as patient global input
"RTN","SDAMA306",41,0)
 . S SDARRAY("PATGBL")=1
"RTN","SDAMA306",42,0)
 . ;add comma to end of global root if needed
"RTN","SDAMA306",43,0)
 . N SDLCHAR S SDLCHAR=$E(SDARRAY(4),$L(SDARRAY(4)))
"RTN","SDAMA306",44,0)
 . I SDLCHAR="," Q
"RTN","SDAMA306",45,0)
 . E  I SDLCHAR'="(" S SDARRAY(4)=SDARRAY(4)_","
"RTN","SDAMA306",46,0)
 ;
"RTN","SDAMA306",47,0)
 ;If the clinic list is in a global, add comma at end if needed
"RTN","SDAMA306",48,0)
 S SDARRAY("CLNGBL")=0
"RTN","SDAMA306",49,0)
 I $G(SDARRAY(2))["(" D
"RTN","SDAMA306",50,0)
 . ;flag as clinic global input
"RTN","SDAMA306",51,0)
 . S SDARRAY("CLNGBL")=1
"RTN","SDAMA306",52,0)
 . ;add comma to end of global root if needed
"RTN","SDAMA306",53,0)
 . N SDLCHAR S SDLCHAR=$E(SDARRAY(2),$L(SDARRAY(2)))
"RTN","SDAMA306",54,0)
 . I SDLCHAR="," Q
"RTN","SDAMA306",55,0)
 . E  I SDLCHAR'="(" S SDARRAY(2)=SDARRAY(2)_","
"RTN","SDAMA306",56,0)
 Q
"RTN","SDAMA307")
0^10^B1446187
"RTN","SDAMA307",1,0)
SDAMA307 ;BPOIFO/ACS-Filter API Call RSA ;04 Dec 2003 [5/13/04 1:49pm]
"RTN","SDAMA307",2,0)
 ;;5.3;Scheduling;**301**;13 Aug 1993
"RTN","SDAMA307",3,0)
 ;
"RTN","SDAMA307",4,0)
 ;**              GET APPOINTMENT DATA FROM RSA                  **
"RTN","SDAMA307",5,0)
 ;
"RTN","SDAMA307",6,0)
 ;*****************************************************************
"RTN","SDAMA307",7,0)
 ;              CHANGE LOG
"RTN","SDAMA307",8,0)
 ;
"RTN","SDAMA307",9,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA307",10,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA307",11,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA307",12,0)
 ;
"RTN","SDAMA307",13,0)
 ;*****************************************************************
"RTN","SDAMA307",14,0)
 ;  
"RTN","SDAMA307",15,0)
DATA(SDARRAY) ;Get RSA appointment data (Phase II)
"RTN","SDAMA307",16,0)
 Q
"RTN","SDAMA307",17,0)
 ;Initialize variables
"RTN","SDAMA307",18,0)
 ;Get VistA Instance
"RTN","SDAMA307",19,0)
 N SDVI,SDERROR,SDRSA
"RTN","SDAMA307",20,0)
 S SDERROR=0,SDRSA=0
"RTN","SDAMA307",21,0)
 ;Set up XML for call to RSA
"RTN","SDAMA307",22,0)
 D XML
"RTN","SDAMA307",23,0)
 ;Call RSA if available
"RTN","SDAMA307",24,0)
 I '$$AVAIL(1) S SDERROR=1
"RTN","SDAMA307",25,0)
 E  D 
"RTN","SDAMA307",26,0)
 . ;move migrated clinic list to correct array node
"RTN","SDAMA307",27,0)
 . I $G(SDARRAY("MIG"))]"" S SDARRAY(2)=SDARRAY("MIG")
"RTN","SDAMA307",28,0)
 . S SDRSA=$$CALL(.SDARRAY)
"RTN","SDAMA307",29,0)
 . ;flag if error from RSA
"RTN","SDAMA307",30,0)
 . I SDRSA=-1 S SDERROR=1
"RTN","SDAMA307",31,0)
 ;if no errors and RSA returned data, add RSA data to VistA data
"RTN","SDAMA307",32,0)
 I 'SDERROR I SDRSA D ADD^SDAMA306
"RTN","SDAMA307",33,0)
 ;if error, delete VistA output and generate error msg 101
"RTN","SDAMA307",34,0)
 I SDERROR D
"RTN","SDAMA307",35,0)
 . ;database is not available
"RTN","SDAMA307",36,0)
 . K ^TMP($J,"SDAMA301")
"RTN","SDAMA307",37,0)
 . D ERROR^SDAMA300(101)
"RTN","SDAMA307",38,0)
 Q
"RTN","SDAMA307",39,0)
AVAIL(SDX) ;If RSA is available (VistA Link running), return 1 else return -1
"RTN","SDAMA307",40,0)
 Q 1
"RTN","SDAMA307",41,0)
IMP(SDX) ;If RSA Implemented, return 1 else return 0
"RTN","SDAMA307",42,0)
 Q 0
"RTN","SDAMA307",43,0)
CLMIG(SDCLIEN) ;If Clinic has migrated, return 1 else return 0
"RTN","SDAMA307",44,0)
 Q 0
"RTN","SDAMA307",45,0)
XML ;Set up XML for call to RSA
"RTN","SDAMA307",46,0)
 Q
"RTN","SDAMA307",47,0)
CALL(SDX) ;Call RSA and return appt count
"RTN","SDAMA307",48,0)
 Q 0
"RTN","SDAMA308")
0^11^B11354365
"RTN","SDAMA308",1,0)
SDAMA308 ;BPOIFO/JFW-Filter API Appointment Statuses; 2/17/04 3:25pm ; 5/10/04 8:13am [5/17/04 10:14am]
"RTN","SDAMA308",2,0)
 ;;5.3;Scheduling;**301**;13 Aug 1993
"RTN","SDAMA308",3,0)
 ;
"RTN","SDAMA308",4,0)
 ;**              GET APPOINTMENT STATUS                         **
"RTN","SDAMA308",5,0)
 ;              - Replaces $$STATUS^SDAM1 -
"RTN","SDAMA308",6,0)
 ;*****************************************************************
"RTN","SDAMA308",7,0)
 ;              CHANGE LOG
"RTN","SDAMA308",8,0)
 ;
"RTN","SDAMA308",9,0)
 ;  DATE      PATCH       DESCRIPTION
"RTN","SDAMA308",10,0)
 ;--------  ----------    -----------------------------------------
"RTN","SDAMA308",11,0)
 ;12/04/03  SD*5.3*301    ROUTINE COMPLETED
"RTN","SDAMA308",12,0)
 ;
"RTN","SDAMA308",13,0)
 ;*****************************************************************
"RTN","SDAMA308",14,0)
 ;  
"RTN","SDAMA308",15,0)
STATUS(DFN,SDT,SDCL,SDSTS,SDCHKIN,SDCHKOUT,SDEIFN) ;Retrieve Appointment Status
"RTN","SDAMA308",16,0)
 ;
"RTN","SDAMA308",17,0)
 ;  Input:   DFN      := IFN of Patient
"RTN","SDAMA308",18,0)
 ;           SDT      := Appointment Date/Time   (FM Format)
"RTN","SDAMA308",19,0)
 ;           SDCL     := IFN of Clinic
"RTN","SDAMA308",20,0)
 ;           SDSTS    := Current VistA Appointment Status  (Optional)
"RTN","SDAMA308",21,0)
 ;           SDCHKIN  := Appointment Check-In Date/Time    (Optional)
"RTN","SDAMA308",22,0)
 ;           SDCHKOUT := Appointment Check-Out Date/Time   (Optional)
"RTN","SDAMA308",23,0)
 ;           SDEIFN   := Outpatient Encounter IFN for Appointment (Optional)
"RTN","SDAMA308",24,0)
 ;  Output:  Appoinment Status IFN ; Status Name ; Print Status ;
"RTN","SDAMA308",25,0)
 ;             Check In Date/Time ; Check Out Date/Time ;
"RTN","SDAMA308",26,0)
 ;                Admission Movement IFN
"RTN","SDAMA308",27,0)
 ;           -1 if errors with DFN,SDT or SDCL
"RTN","SDAMA308",28,0)
 ;  
"RTN","SDAMA308",29,0)
 ; Initialize Global Variables
"RTN","SDAMA308",30,0)
 N SDI,SDQUIT,SDCODE,SDSTSD,SDPSTS,SDINDCTR,SDAMVT,VADMVT,VAINDT
"RTN","SDAMA308",31,0)
 S SDQUIT=0
"RTN","SDAMA308",32,0)
 ;Validate parameters
"RTN","SDAMA308",33,0)
 F SDI="VDFN","FMDATE","VCLIN" Q:SDQUIT  D @SDI
"RTN","SDAMA308",34,0)
 Q:SDQUIT -1
"RTN","SDAMA308",35,0)
 ; Set initial Status value, if no value set to NULL
"RTN","SDAMA308",36,0)
 S SDSTSD=$S($G(SDSTS)]"":$P($T(@SDSTS),";;",3),1:"")
"RTN","SDAMA308",37,0)
 ; No R appt status in original VistA code
"RTN","SDAMA308",38,0)
 S:$G(SDSTS)="R" SDSTSD=""
"RTN","SDAMA308",39,0)
 ; If Status is null check for non-count clinic
"RTN","SDAMA308",40,0)
 I $G(SDSTSD)="" S SDCODE=$$GETSTOP^SDAMA305($G(SDCL)) S:$P($G(SDCODE),"^",3)="Y" SDSTSD="NON-COUNT"
"RTN","SDAMA308",41,0)
 ;Get admission movement ifn
"RTN","SDAMA308",42,0)
 S VAINDT=$G(SDT) D ADM^VADPT2
"RTN","SDAMA308",43,0)
 ;Inpatient? (Check Status, Admission IFN?, Domicillary Ward?, Ward Location = "D"?)
"RTN","SDAMA308",44,0)
 I SDSTSD["INPATIENT",$S('+VADMVT:1,'$P(^DG(43,1,0),"^",21):0,1:$P($G(^DIC(42,+$P($G(^DGPM(VADMVT,0)),"^",6),0)),"^",3)="D") S SDSTSD=""
"RTN","SDAMA308",45,0)
 ; Determine Checked In/Out Indicator
"RTN","SDAMA308",46,0)
 S SDINDCTR=$S(+$G(SDCHKOUT):"CHECKED OUT",+$G(SDCHKIN):"CHECKED IN",SDSTSD]"":"",$G(SDT)>(DT+.2359):"FUTURE",1:"NO ACTION TAKEN") S:SDSTSD="" SDSTSD=SDINDCTR
"RTN","SDAMA308",47,0)
 I SDSTSD="NO ACTION TAKEN",$P($G(SDT),".")=DT,SDINDCTR'["CHECKED IN" S SDINDCTR="TODAY"
"RTN","SDAMA308",48,0)
 I SDSTSD="CHECKED OUT"!(SDSTSD="CHECKED IN"),SDT'<$$REQDT^SDM1A,'$P($G(^SCE(+$G(SDEIFN),0)),"^",7) S SDSTSD="NO ACTION TAKEN"
"RTN","SDAMA308",49,0)
 ; Determine PRINT STATUS
"RTN","SDAMA308",50,0)
 S SDPSTS=$S(SDSTSD=SDINDCTR!(SDINDCTR=""):SDSTSD,1:"")
"RTN","SDAMA308",51,0)
 I SDPSTS="" D
"RTN","SDAMA308",52,0)
 .I SDSTSD="NO ACTION TAKEN",SDINDCTR="CHECKED OUT"!(SDINDCTR="CHECKED IN") S SDPSTS="ACT REQ/"_SDINDCTR Q
"RTN","SDAMA308",53,0)
 .S SDPSTS=$S(SDSTSD="NO ACTION TAKEN":SDSTSD,1:$P(SDSTSD," "))_"/"_SDINDCTR
"RTN","SDAMA308",54,0)
 ;Get Appointment Status IFN
"RTN","SDAMA308",55,0)
 S SDAMVT=+$O(^SD(409.63,"AC",SDSTSD,0))
"RTN","SDAMA308",56,0)
 Q SDAMVT_";"_SDSTSD_";"_SDPSTS_";"_$G(SDCHKIN)_";"_$G(SDCHKOUT)_";"_+VADMVT
"RTN","SDAMA308",57,0)
VDFN ; Verify for valid patient dfn
"RTN","SDAMA308",58,0)
 I $G(DFN)="" S SDQUIT=1
"RTN","SDAMA308",59,0)
 E  I '$D(^DPT(DFN)) S SDQUIT=1
"RTN","SDAMA308",60,0)
 Q
"RTN","SDAMA308",61,0)
VCLIN ; Verify for valid clinic dfn
"RTN","SDAMA308",62,0)
 I $G(SDCL)="" S SDQUIT=1
"RTN","SDAMA308",63,0)
 E  I '$D(^SC(SDCL,0)) S SDQUIT=1
"RTN","SDAMA308",64,0)
 Q
"RTN","SDAMA308",65,0)
FMDATE ;
"RTN","SDAMA308",66,0)
 ; Appointment Date must be a valid internal FileMan Format
"RTN","SDAMA308",67,0)
 N X,Y,%H,%T,%Y
"RTN","SDAMA308",68,0)
 S Y=$G(SDT) D DD^%DT I Y=-1 S SDQUIT=1
"RTN","SDAMA308",69,0)
 ; Appointment Date cannot be imprecise
"RTN","SDAMA308",70,0)
 I 'SDQUIT S X=$G(SDT) D H^%DTC I %H=0 S SDQUIT=1
"RTN","SDAMA308",71,0)
 Q
"RTN","SDAMA308",72,0)
 ;
"RTN","SDAMA308",73,0)
 ;LIST OF VISTA STATUS CODES /NEW DESCRIPTIONS /OLD DESCRIPTIONS
"RTN","SDAMA308",74,0)
CC ;;CANCELLED BY CLINIC;;CANCELLED BY CLINIC
"RTN","SDAMA308",75,0)
CCR ;;CANCELLED BY CLINIC & RESCHEDULED;;CANCELLED BY CLINIC & AUTO RE-BOOK
"RTN","SDAMA308",76,0)
CP ;;CANCELLED BY PATIENT;;CANCELLED BY PATIENT
"RTN","SDAMA308",77,0)
CPR ;;CANCELLED BY PATIENT & RESCHEDULED;;CANCELLED BY PATIENT & AUTO-REBOOK
"RTN","SDAMA308",78,0)
R ;;SCHEDULED/KEPT;;
"RTN","SDAMA308",79,0)
I ;;INPATIENT;;INPATIENT APPOINTMENT
"RTN","SDAMA308",80,0)
NS ;;NO-SHOW;;NO-SHOW
"RTN","SDAMA308",81,0)
NSR ;;NO-SHOW & RESCHEDULED;;NO-SHOW & AUTO RE-BOOK
"RTN","SDAMA308",82,0)
NT ;;NO ACTION TAKEN;;NO ACTION TAKEN
"VER")
8.0^22.0
**END**
**END**
