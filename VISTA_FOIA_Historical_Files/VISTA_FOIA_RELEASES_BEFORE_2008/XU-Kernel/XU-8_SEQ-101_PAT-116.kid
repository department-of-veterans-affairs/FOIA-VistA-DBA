Released XU*8*116 SEQ #101
Extracted from mail message
**KIDS**:XU*8.0*116^

**INSTALL NAME**
XU*8.0*116
"BLD",133,0)
XU*8.0*116^KERNEL^0^^y
"BLD",133,1,0)
^^1^1^2990210^
"BLD",133,1,1,0)
   See Patch Module for details.
"BLD",133,4,0)
^9.64PA^^
"BLD",133,"KRN",0)
^9.67PA^19^18
"BLD",133,"KRN",.4,0)
.4
"BLD",133,"KRN",.401,0)
.401
"BLD",133,"KRN",.402,0)
.402
"BLD",133,"KRN",.403,0)
.403
"BLD",133,"KRN",.5,0)
.5
"BLD",133,"KRN",.84,0)
.84
"BLD",133,"KRN",3.6,0)
3.6
"BLD",133,"KRN",3.8,0)
3.8
"BLD",133,"KRN",9.2,0)
9.2
"BLD",133,"KRN",9.8,0)
9.8
"BLD",133,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",133,"KRN",9.8,"NM",1,0)
XQ8^^0^B18952289
"BLD",133,"KRN",9.8,"NM",2,0)
XQ81^^0^B32521551
"BLD",133,"KRN",9.8,"NM",3,0)
XQCS^^0^B31323245
"BLD",133,"KRN",9.8,"NM","B","XQ8",1)
 
"BLD",133,"KRN",9.8,"NM","B","XQ81",2)
 
"BLD",133,"KRN",9.8,"NM","B","XQCS",3)
 
"BLD",133,"KRN",19,0)
19
"BLD",133,"KRN",19.1,0)
19.1
"BLD",133,"KRN",101,0)
101
"BLD",133,"KRN",409.61,0)
409.61
"BLD",133,"KRN",771,0)
771
"BLD",133,"KRN",869.2,0)
869.2
"BLD",133,"KRN",870,0)
870
"BLD",133,"KRN",8994,0)
8994
"BLD",133,"KRN","B",.4,.4)
 
"BLD",133,"KRN","B",.401,.401)
 
"BLD",133,"KRN","B",.402,.402)
 
"BLD",133,"KRN","B",.403,.403)
 
"BLD",133,"KRN","B",.5,.5)
 
"BLD",133,"KRN","B",.84,.84)
 
"BLD",133,"KRN","B",3.6,3.6)
 
"BLD",133,"KRN","B",3.8,3.8)
 
"BLD",133,"KRN","B",9.2,9.2)
 
"BLD",133,"KRN","B",9.8,9.8)
 
"BLD",133,"KRN","B",19,19)
 
"BLD",133,"KRN","B",19.1,19.1)
 
"BLD",133,"KRN","B",101,101)
 
"BLD",133,"KRN","B",409.61,409.61)
 
"BLD",133,"KRN","B",771,771)
 
"BLD",133,"KRN","B",869.2,869.2)
 
"BLD",133,"KRN","B",870,870)
 
"BLD",133,"KRN","B",8994,8994)
 
"BLD",133,"QUES",0)
^9.62^^
"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
116
"PKG",3,22,1,"PAH",1,1,0)
^^1^1^2990225
"PKG",3,22,1,"PAH",1,1,1,0)
   See Patch Module for details.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","XQ8")
0^1^B18952289
"RTN","XQ8",1,0)
XQ8 ;SEA/AMF,MJM - Build menu trees ;02/25/99  11:59
"RTN","XQ8",2,0)
 ;;8.0;KERNEL;**81,89,116**;Jul 10, 1995
"RTN","XQ8",3,0)
 ;
"RTN","XQ8",4,0)
TIME ;See if there are prohibited times for this option
"RTN","XQ8",5,0)
 S %XQI=$P(^DIC(19,Y,0),U,9) I $L(%XQI)>2 S XQP(L)=%XQI_"MO-FR"
"RTN","XQ8",6,0)
 I $D(^DIC(19,Y,3.91)) S %XQI=0 F  S %XQI=$O(^DIC(19,Y,3.91,%XQI)) Q:%XQI'>0  S XQP(L)=$S($D(XQP(L)):XQP(L)_";",1:"")_$P(^(%XQI,0),U,1)_$P(^(0),U,2)
"RTN","XQ8",7,0)
 K %XQI I '$D(XQP(L)),$L($P(Y(0),U,9)) S XQP(L)=$P(Y(0),U,9)
"RTN","XQ8",8,0)
 Q
"RTN","XQ8",9,0)
UP F Z=1:1 Q:X?.NUP  S W=$A(X,Z) I W<123,W>96 S X=$E(X,1,Z-1)_$C(W-32)_$E(X,Z+1,255)
"RTN","XQ8",10,0)
 Q
"RTN","XQ8",11,0)
CHK S XQRE=$D(^XUTL("XQO",XQDIC,"^BUILD")) I XQRE,($P($H,",",2)-^("^BUILD")>1800)!(^("^BUILD")>$P($H,",",2)) K ^("^BUILD") S XQRE=0
"RTN","XQ8",12,0)
 Q
"RTN","XQ8",13,0)
PMO ;Called from XQ71+21
"RTN","XQ8",14,0)
 D CHK W !,$S(XQRE:"I'M REBUILDING",1:"I NEED TO REBUILD")," MENUS .... QUICK ACCESS IS TEMPORARILY DISABLED" W:$D(XQMMJ) !!,"Please proceed to '",$E(XQMMJ,2,99),"'" K XQMMJ,XQMM I XQRE K XQRE Q
"RTN","XQ8",15,0)
 Q
"RTN","XQ8",16,0)
PM2 D:$D(XQCON) CHK S:'$D(XQRE) XQRE=0 Q:XQRE  K ^XUTL("XQO",XQDIC) S ^XUTL("XQO",XQDIC,"^BUILD")=$P($H,",",2) G:$D(XQFG1) REBLD
"RTN","XQ8",17,0)
 S ZTIO="",ZTRTN="REBLD^XQ8",ZTDTH=$H,ZTSAVE("XQDIC")="",ZTDESC="Rebuild Menu "_XQDIC D ^%ZTLOAD Q
"RTN","XQ8",18,0)
 ;
"RTN","XQ8",19,0)
REBLD K XQFG1 S U="^",UU="^^" ;Taskman entry
"RTN","XQ8",20,0)
 S XQDATE=$H
"RTN","XQ8",21,0)
 S %=$O(^DIC(19,"B","XUCOMMAND",0)) I %=+$P(XQDIC,"P",2) S XQDIC="PXU"
"RTN","XQ8",22,0)
 I XQDIC="PXU" D BLDPXU Q
"RTN","XQ8",23,0)
 I XQDIC'="PXU" S Y=+$P(XQDIC,"P",2) Q:Y'>0  Q:'$D(^DIC(19,Y,0))
"RTN","XQ8",24,0)
 ;
"RTN","XQ8",25,0)
 S Y=$P(XQDIC,"P",2) G:Y'>0!'$D(^DIC(19,+Y,0)) PMOKA I Y>0,$D(^DIC(19,Y,0)),$P(^(0),U,4)="M" D PMOK S %="",(L,X(0))=0,XQD=Y D TREE1
"RTN","XQ8",26,0)
 S:$D(^DIC(19,$E(XQDIC,2,99),0)) ^(99.1)=XQDATE S ^XUTL("XQO",XQDIC,0)=XQDATE
"RTN","XQ8",27,0)
 S Y=+$P(XQDIC,"P",2)
"RTN","XQ8",28,0)
 I Y>0 S (XQD,%)=^DIC(19,Y,0),L=1,XQP(L)="" D TIME S ^XUTL("XQO",XQDIC,U,Y)=U_$P(%,U,1,2)_U_$S(($P(%,U,3)]""):1,1:"")_U_$P(%,U,4)_UU_$P(%,U,6,8)_U_XQP(L)_U_$P(%,U,10,99)
"RTN","XQ8",29,0)
 I Y>0,'$D(^DIC(19,Y,"U")) S XQFL=0 S:$D(X)#2 XQSAVE=X,XQFL=1 S X=$E($P(^DIC(19,+Y,0),U,2),1,30) D UP S ^("U")=X S:XQFL X=XQSAVE
"RTN","XQ8",30,0)
 I Y>0 S ^XUTL("XQO",XQDIC,^DIC(19,Y,"U")_U)=Y_"^0"
"RTN","XQ8",31,0)
PMOKA K ^XUTL("XQO",XQDIC,"^BUILD") I '$D(XQFG),$D(ZTSK) K ^%ZTSK(ZTSK)
"RTN","XQ8",32,0)
PMOK K %,XQA,XQD,XQE,XQF,XQFL,XQP,XQR,XQRE,XQSAVE
"RTN","XQ8",33,0)
 Q
"RTN","XQ8",34,0)
TREE ;
"RTN","XQ8",35,0)
 S X(L)=$O(^DIC(19,XQD,10,X(L))) Q:X(L)'>0  S Y=^(X(L),0),%=$P(Y,U,2),Y=+Y G:$D(XQR(Y))!'$D(^DIC(19,Y,0)) TREE S XQR(Y)="" I $D(XQFG),'$D(XQNTREE) W:'(Y#5) "."
"RTN","XQ8",36,0)
TREE1 S Y(0)=^DIC(19,Y,0),X=$S($D(^("U")):^("U"),1:"") I X="" S X=$E($P(Y(0),U,2),1,30) D UP S ^("U")=X
"RTN","XQ8",37,0)
 S Y(1)=X S:'$L($P(Y(0),U,5)) $P(Y(0),U,5)=0
"RTN","XQ8",38,0)
 G:$L($P(Y(0),U,3)) TREE S:$L($P(Y(0),U,6)) XQK(L)=$P(Y(0),U,6) S XQA(L)=Y S:$L($P(Y(0),U,10)) XQE(L)=$P(Y(0),U,10)
"RTN","XQ8",39,0)
 S:$P(Y(0),U,16) XQF(L)=$P(^DIC(19,Y,3),U) I $D(XQF(L)) K:XQF(L)="" XQF(L)
"RTN","XQ8",40,0)
 D TIME,PMOSET S L=L+1,X(L)=0,(XQD,XQD(L))=Y D TREE
"RTN","XQ8",41,0)
 Q:L<2  K XQR(XQD(L)) S L=L-1 K XQA(L),XQK(L),XQP(L),XQE(L),XQF(L) S XQD=XQD(L) G TREE
"RTN","XQ8",42,0)
 ;
"RTN","XQ8",43,0)
PMOSET ;
"RTN","XQ8",44,0)
 S K=0,X=$E(Y(1),1,27) I $L(X) S X=X_U D:$D(^XUTL("XQO",XQDIC,X))!$D(^(X_"1")) PMO3 S:L&'K ^XUTL("XQO",XQDIC,X)=Y_"^1"
"RTN","XQ8",45,0)
 I $D(%),$L(%) S X=%,K=0 D UP Q:'$L(X)  S X=X_U D:$D(^XUTL("XQO",XQDIC,X))!$D(^(X_"1")) PMO3 S:L&'K ^XUTL("XQO",XQDIC,X)=Y_"^0"
"RTN","XQ8",46,0)
 S (XQA,XQK,XQP,XQE,XQF)="" F D="XQA","XQK","XQP","XQE","XQF" F I=1:1:L I $D(@(D_"(I)")) S @D=@D_@(D_"(I)")_","
"RTN","XQ8",47,0)
 I '$D(^XUTL("XQO",XQDIC,"^",Y)) S ^(Y)=U_$P(Y(0),U,1,2)_U_$S(($P(Y(0),U,3)]""):1,1:"")_U_$P(Y(0),U,4)_U_XQA_U_XQK_U_$P(Y(0),U,7,8)_U_XQP_U_XQE_U_$P(Y(0),U,11,15)_U_XQF_U_$P(Y(0),U,17,99) Q
"RTN","XQ8",48,0)
 S %=$S('$D(^XUTL("XQO",XQDIC,"^",Y,0)):1,1:^(0)+1),^(0)=%,^(0,%)=XQA_U_XQK_U_XQP_U_XQE_U_XQF
"RTN","XQ8",49,0)
 Q
"RTN","XQ8",50,0)
PMO3 ;
"RTN","XQ8",51,0)
 S D=X,K=$S($D(^XUTL("XQO",XQDIC,X)):(Y=+^(X)),1:0) F  S V=$O(^XUTL("XQO",XQDIC,D)) Q:K!($P(V,U,1)'=$P(X,U,1))  S D=V S:Y=+^(V) K=1
"RTN","XQ8",52,0)
 I 'K S I=$P(D,U,2) S:'$L(I) I=0 I I=0 S ^(X_"1")=^XUTL("XQO",XQDIC,X) K ^(X) S I=1
"RTN","XQ8",53,0)
 I 'K S X=X_(I+1)
"RTN","XQ8",54,0)
 Q
"RTN","XQ8",55,0)
 ;
"RTN","XQ8",56,0)
BLDPXU ;Let's rebuild XUCOMMAND shall we?
"RTN","XQ8",57,0)
 N XQCOM,XQDATE,XQDIC
"RTN","XQ8",58,0)
 S XQDIC="PXU"
"RTN","XQ8",59,0)
 S XQDATE=$H
"RTN","XQ8",60,0)
 S (XQCOM,Y)=$O(^DIC(19,"B","XUCOMMAND",0))
"RTN","XQ8",61,0)
 I Y>0 D
"RTN","XQ8",62,0)
 .S %="",(L,X(0))=0,(XQPX,XQD)=Y
"RTN","XQ8",63,0)
 .K ^XUTL("XQO","PXU")
"RTN","XQ8",64,0)
 .D TREE1,PMOK
"RTN","XQ8",65,0)
 .S ^XUTL("XQO","PXU",0)=XQDATE
"RTN","XQ8",66,0)
 .S ^DIC(19,XQCOM,99.1)=XQDATE
"RTN","XQ8",67,0)
 .Q
"RTN","XQ8",68,0)
 Q
"RTN","XQ81")
0^2^B32521551
"RTN","XQ81",1,0)
XQ81 ;SEA/AMF,SF/RWF - Build menu trees ;02/25/99  11:19
"RTN","XQ81",2,0)
 ;;8.0;KERNEL;**81,116**;Jul 10, 1995
"RTN","XQ81",3,0)
BUILD ;
"RTN","XQ81",4,0)
 ;
"RTN","XQ81",5,0)
RD2 K XQFG W !!,"This option will build menu trees for each primary and secondary menu.",!,"You may build all the trees, or build them selectively, using 'verify'.",!,"Note that the 'compiled menus' will only be built into ^XUTL on this CPU.",!
"RTN","XQ81",6,0)
 S DIR(0)="Y",DIR("A")="Do you wish to verify each primary menu",DIR("B")="NO",DIR("??")="XQBUILDTREE-VER" D ^DIR K DIR G:$D(DIRUT) BLDEND S XQVE=(Y=1)
"RTN","XQ81",7,0)
 S DIR(0)="Y",DIR("A")="Would you like to build secondary menu trees too",DIR("B")="YES",DIR("??")="XQBUILDTREE-SEC" D ^DIR G:$D(DIRUT) BLDEND S XQBSEC=(Y=1)
"RTN","XQ81",8,0)
 I 'XQVE S DIR(0)="Y",DIR("A")="Would you like to queue this job",DIR("B")="YES" D ^DIR K DIR G:$D(DIRUT) BLDEND I Y=1 S ZTRTN="DQ^XQ81",(ZTIO,ZTSAVE("XQVE"),ZTSAVE("XQBSEC"),ZTSAVE("XQPXU"))="",ZTDESC="Build tree" D ^%ZTLOAD K ZTSK G BLDEND
"RTN","XQ81",9,0)
 I 'XQVE S DIR(0)="Y",DIR("A")="Do you really wish to run this DIRECTLY (it may take some time)",DIR("B")="NO" D ^DIR K DIR G:$D(DIRUT) BLDEND G:Y'=1 RD2
"RTN","XQ81",10,0)
 ;
"RTN","XQ81",11,0)
KIDS ;Entry from KIDS
"RTN","XQ81",12,0)
 I '$D(XQVE) S XQFG=0,XQBSEC=1,XQVE=0
"RTN","XQ81",13,0)
 N XQNTREE,XQNDONE S (XQNTREE,XQNDONE)=0
"RTN","XQ81",14,0)
 ;
"RTN","XQ81",15,0)
 ;Set up the error trap so we can clear the screen if it blows
"RTN","XQ81",16,0)
 I $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^XQ81"
"RTN","XQ81",17,0)
 E  S X="ERR^XQ81",@^%ZOSF("TRAP")
"RTN","XQ81",18,0)
 ;
"RTN","XQ81",19,0)
 ;Set up the bar graph and window if not from KIDS
"RTN","XQ81",20,0)
 I '$D(XPDNM) D INIT^XPDID
"RTN","XQ81",21,0)
 I XPDIDVT D
"RTN","XQ81",22,0)
 .I $D(XPDIDTOT) S XQSAVTOT=XPDIDTOT
"RTN","XQ81",23,0)
 .S X="Rebuilding Menus" D TITLE^XPDID(X)
"RTN","XQ81",24,0)
 .S XPDIDTOT=50 ;Number of divisions in bar graph
"RTN","XQ81",25,0)
 .D UPDATE^XPDID(0)
"RTN","XQ81",26,0)
 .Q
"RTN","XQ81",27,0)
 ;
"RTN","XQ81",28,0)
 W !!,"Starting Menu Rebuild:  ",$$HTE^XLFDT($H)
"RTN","XQ81",29,0)
 S XQFG=0 W !!,"Collecting primary menus in the New Person file..."
"RTN","XQ81",30,0)
 ;
"RTN","XQ81",31,0)
 ;
"RTN","XQ81",32,0)
DQ ;Entry from taskman  Write if $D(XQFG)
"RTN","XQ81",33,0)
 S ^XUTL("XQO","P0")="",XQSEC=1,XQ81T="" I 'XQVE H 1
"RTN","XQ81",34,0)
 S XQI="" F XQK=0:0 S XQI=$O(^XUTL("XQO",XQI)) Q:XQI'=+XQI!(XQI="")  I $D(^XUTL("XQO",XQI,0))#2 S $P(^(0),U,2)=""
"RTN","XQ81",35,0)
 S XQI="U" F XQK=0:0 S XQI=$O(^XUTL("XQO",XQI)) Q:"U"'[$E(XQI)!(XQI="")  I $D(^XUTL("XQO",XQI,0))#2 S $P(^(0),U,2)=""
"RTN","XQ81",36,0)
 S XQI="P" F XQK=0:0 S XQI=$O(^XUTL("XQO",XQI)) Q:"P"'[$E(XQI)!(XQI="")  I $D(^XUTL("XQO",XQI,0))#2,$L(^(0)) S XQ81T=^(0) Q
"RTN","XQ81",37,0)
 S:XQ81T="" XQ81T="Unknown"
"RTN","XQ81",38,0)
 S XQI="P" F XQK=0:0 S XQI=$O(^XUTL("XQO",XQI)) Q:"P"'[$E(XQI)!(XQI="")  I "P"[$E(XQI),XQI'="P0" K ^XUTL("XQO",XQI)
"RTN","XQ81",39,0)
 ;
"RTN","XQ81",40,0)
 ;Find the various trees and put them into ^TMP($J), and count them
"RTN","XQ81",41,0)
 S:'$D(XQH) XQH=$H K ^TMP($J) S XQI=.5 F XQK=0:0 S XQI=$O(^VA(200,XQI)) Q:XQI'=+XQI  I $D(^VA(200,XQI,0)),$L($P(^VA(200,XQI,0),U,3)) D SET
"RTN","XQ81",42,0)
 ;
"RTN","XQ81",43,0)
 S (XQNTREE,%)=0 F  S %=$O(^TMP($J,%)) Q:%=""  S XQNTREE=XQNTREE+1
"RTN","XQ81",44,0)
 S %=0 F  S %=$O(^TMP($J,"SEC",%)) Q:%=""  S XQNTREE=XQNTREE+1
"RTN","XQ81",45,0)
 ;
"RTN","XQ81",46,0)
 W:$D(XQFG) !!?20,"Primary menus found in the New Person file",!?20,"------------------------------------------"
"RTN","XQ81",47,0)
 W:$D(XQFG) !!,"OPTION NAME         MENU TEXT",?49,"# OF",?62,"LAST",?71,"LAST",!?49,"USERS",?62,"USED",?71,"BUILT",!
"RTN","XQ81",48,0)
 S X="" F XQBLD=0:0 S XQBLD=$O(^TMP($J,XQBLD)) Q:XQBLD'>0!(X=U)  I $D(^DIC(19,XQBLD,0)) S XQJ=^DIC(19,XQBLD,0) D VER
"RTN","XQ81",49,0)
 W:$D(XQFG) !!,"Building the Common Options (XUCOMMAND)...." D BLDPXU^XQ8
"RTN","XQ81",50,0)
 S XQSEC=0 I $D(XQFG),XQBSEC W !!,"Building secondary menu trees...."
"RTN","XQ81",51,0)
 I XQBSEC S X="" F XQBLD=0:0 S XQBLD=$O(^TMP($J,"SEC",XQBLD)) Q:XQBLD'>0  D SEC
"RTN","XQ81",52,0)
 K ^XUTL("XQO","P0") I 'XQVE S XQK="P" F XQBLD=0:0 S XQK=$O(^XUTL("XQO",XQK)) Q:XQK'["P"  S ^(XQK,0)=XQH
"RTN","XQ81",53,0)
 G BLDEND
"RTN","XQ81",54,0)
 ;
"RTN","XQ81",55,0)
SEC S XQL="P"_XQBLD Q:$D(^XUTL("XQO",XQL))  D RD3 Q
"RTN","XQ81",56,0)
 S XQL="P" F XQN=0:0 S XQL=$O(^XUTL("XQO",XQL)) Q:$E(XQL)'="P"  I $D(^XUTL("XQO",XQL,"^",XQBLD)) Q
"RTN","XQ81",57,0)
 D:$E(XQL)'="P" RD3
"RTN","XQ81",58,0)
 Q
"RTN","XQ81",59,0)
 ;
"RTN","XQ81",60,0)
VER I $D(XQFG) D
"RTN","XQ81",61,0)
 .N XQMT,XQOPNM
"RTN","XQ81",62,0)
 .S XQK=$P(^TMP($J,XQBLD),U,2)
"RTN","XQ81",63,0)
 .S:$L(XQK) XQK=$E(XQK,4,5)_"/"_$E(XQK,6,7)_"/"_$E(XQK,2,3)
"RTN","XQ81",64,0)
 .S XQOPNM=$P(XQJ,U)
"RTN","XQ81",65,0)
 .S XQMT=$P(XQJ,U,2) I $L(XQMT)>28 S XQMT=$E(XQMT,1,25)_"..."
"RTN","XQ81",66,0)
 .W !,$P(XQJ,U,1)
"RTN","XQ81",67,0)
 .W:($L(XQOPNM)>20) !
"RTN","XQ81",68,0)
 .W ?20,XQMT,?49,+^TMP($J,XQBLD),?60,XQK
"RTN","XQ81",69,0)
 .Q
"RTN","XQ81",70,0)
 ;
"RTN","XQ81",71,0)
 I $D(XQFG) S:$D(^XUTL("XQO","P"_XQBLD,0)) XQ81T=+^(0) I $L(XQ81T) S %H=XQ81T D YMD^%DTC S XQK=X W ?71,$E(XQK,4,5),"/",$E(XQK,6,7),"/",$E(XQK,2,3)
"RTN","XQ81",72,0)
 ;
"RTN","XQ81",73,0)
RD3 ;Update counter an rebuild it if necessary
"RTN","XQ81",74,0)
 I $D(XQFG),XPDIDVT D
"RTN","XQ81",75,0)
 .N %
"RTN","XQ81",76,0)
 .S XQNDONE=XQNDONE+1
"RTN","XQ81",77,0)
 .S %=(XQNDONE/XQNTREE)*XPDIDTOT
"RTN","XQ81",78,0)
 .D UPDATE^XPDID(%)
"RTN","XQ81",79,0)
 .Q
"RTN","XQ81",80,0)
 ;
"RTN","XQ81",81,0)
 S XQDIC="P"_XQBLD D CHK^XQ8 I XQRE W:$D(XQFG) !,"SOMEONE ELSE IS CURRENTLY REBUILDING THIS MENU" Q
"RTN","XQ81",82,0)
 I XQVE,XQSEC S DIR(0)="Y",DIR("A")="Rebuild",DIR("B")="YES" D ^DIR Q:$D(DIRUT)  W ! Q:Y'=1
"RTN","XQ81",83,0)
 S XQFG1=1 D PM2^XQ8
"RTN","XQ81",84,0)
 Q
"RTN","XQ81",85,0)
SET G:'$D(^VA(200,XQI,201)) SET1 S XQK=+^(201) Q:'$L(XQK)  ;I $D(XQFG) W:'(XQI#10) "."
"RTN","XQ81",86,0)
 S XQR="" S:$D(^VA(200,XQI,1.1)) XQR=$P(^(1.1),".",1) S XQP=1_U_XQR
"RTN","XQ81",87,0)
 I $D(^TMP($J,XQK)) S XQP=^TMP($J,XQK) S XQP=XQP+1_U_$S(XQR>$P(XQP,U,2):XQR,1:$P(XQP,U,2))
"RTN","XQ81",88,0)
 I $D(^DIC(19,XQK,0)),$P(^(0),U,4)="M" S ^TMP($J,XQK)=XQP
"RTN","XQ81",89,0)
SET1 I XQBSEC F XQN=0:0 S XQN=$O(^VA(200,XQI,203,XQN)) Q:XQN'>0  S XQL=+^(XQN,0) I $D(^DIC(19,XQL,0)) S ^TMP($J,"SEC",XQL)=""
"RTN","XQ81",90,0)
 Q
"RTN","XQ81",91,0)
 ;
"RTN","XQ81",92,0)
QUE ;Entry point for the option XQBUILDTREEQUE, and XQBUILDALL
"RTN","XQ81",93,0)
 S XQPXU=1,XQVE=0,XQBSEC=1 K XQFG
"RTN","XQ81",94,0)
 G DQ
"RTN","XQ81",95,0)
 ;
"RTN","XQ81",96,0)
BLDEND ;
"RTN","XQ81",97,0)
 ;
"RTN","XQ81",98,0)
 K %,%H,%TG,D,DIC,DIR,I,J,K,L,V,XQBSEC,X,Y,Z,XQL,XQN,XQRE,XQK,XQI,XQII,UU,XQH,XQPX,XQSAV,XQXUF,XQ81T,XQDATE,XQSEC,XQVE,XQBLD,XQP,XQR,XQJ,^TMP($J)
"RTN","XQ81",99,0)
 ;
"RTN","XQ81",100,0)
 I '$D(XPDIDVT) K XQFG Q
"RTN","XQ81",101,0)
 ;
"RTN","XQ81",102,0)
 I $D(XQFG),XPDIDVT F %=((XQNDONE/XQNTREE)*XPDIDTOT):1:XPDIDTOT D UPDATE^XPDID(%) H .25
"RTN","XQ81",103,0)
 I $D(XQFG),XPDIDVT D UPDATE^XPDID(XPDIDTOT)
"RTN","XQ81",104,0)
 I $D(XQFG) W !!,"Menu Rebuild Complete:  ",$$HTE^XLFDT($H)
"RTN","XQ81",105,0)
 ;
"RTN","XQ81",106,0)
 H 2
"RTN","XQ81",107,0)
 ;If we're not from KIDS then clean it up, otherwise let kids do it.
"RTN","XQ81",108,0)
 I '$D(XPDNM) D
"RTN","XQ81",109,0)
 .D EXIT^XPDID()
"RTN","XQ81",110,0)
 .K XPDIDVT,XPDIDTOT
"RTN","XQ81",111,0)
 .Q
"RTN","XQ81",112,0)
 ;
"RTN","XQ81",113,0)
 I $D(XQSAVTOT) S XPDIDTOT=XQSAVTOT K XQSAVTOT
"RTN","XQ81",114,0)
 K XQFG
"RTN","XQ81",115,0)
 Q
"RTN","XQ81",116,0)
 ;
"RTN","XQ81",117,0)
ERR ;Come here on error
"RTN","XQ81",118,0)
 N XQERROR
"RTN","XQ81",119,0)
 S XQERROR=$$EC^%ZOSV
"RTN","XQ81",120,0)
 D ^%ZTER
"RTN","XQ81",121,0)
 D EXIT^XPDID()
"RTN","XQ81",122,0)
 G UNWIND^%ZTER
"RTN","XQ81",123,0)
 Q
"RTN","XQCS")
0^3^B31323245
"RTN","XQCS",1,0)
XQCS ;Luke/SEA - Client/Server Utilities ;02/10/99  11:13
"RTN","XQCS",2,0)
 ;;8.0;KERNEL;**15,28,82,116**;Jul 10, 1995
"RTN","XQCS",3,0)
 ;
"RTN","XQCS",4,0)
CHK(XQUSR,XQOPT,XQRPC) ;Check to see if this user can run this RPC from
"RTN","XQCS",5,0)
 ;this option.
"RTN","XQCS",6,0)
 ;
"RTN","XQCS",7,0)
 ;Input: XQUSR-DUZ of user
"RTN","XQCS",8,0)
 ;       XQOPT - name or IEN of the option
"RTN","XQCS",9,0)
 ;       XQRPC - name or IEN of the remote procedure.  If this
"RTN","XQCS",10,0)
 ;               variable is null no check is made to see if a
"RTN","XQCS",11,0)
 ;               procedure is allowed.  That is, we only look
"RTN","XQCS",12,0)
 ;               to see if the option is there and  if the user
"RTN","XQCS",13,0)
 ;               has been assigned access to it.
"RTN","XQCS",14,0)
 ;
"RTN","XQCS",15,0)
 ;Output: XQMES - returned as 1 if the user is allowed to use this
"RTN","XQCS",16,0)
 ;        option (and RPC is valid if XQRPC input variable is not
"RTN","XQCS",17,0)
 ;        null), or as a message string explaining why the option
"RTN","XQCS",18,0)
 ;        or RPC is not allowed.
"RTN","XQCS",19,0)
 ;
"RTN","XQCS",20,0)
 ;Rules: If M code exsists in ^DIC(19,option#,"RPC",rpc#,1) the
"RTN","XQCS",21,0)
 ;       RULES field for a corresponding RPC, the software sets
"RTN","XQCS",22,0)
 ;       the flag XQRPCOK to 1 and executes the field's code.
"RTN","XQCS",23,0)
 ;       If the flag is returned as less than 1, the request for
"RTN","XQCS",24,0)
 ;       use of that RPC is denied.  Rules are written by the
"RTN","XQCS",25,0)
 ;       package developer and are not required.
"RTN","XQCS",26,0)
 ;
"RTN","XQCS",27,0)
 ;
"RTN","XQCS",28,0)
 N %,X,XQCY0,XQDIC,XQKEY,XQRPCOK,XQPM,XQSM,XQSMY,XQYSAV
"RTN","XQCS",29,0)
 ;
"RTN","XQCS",30,0)
 S XQMES=1
"RTN","XQCS",31,0)
 D OPT I 'XQMES Q XQMES
"RTN","XQCS",32,0)
 D:XQUSR>0 USER I 'XQMES Q XQMES
"RTN","XQCS",33,0)
 S %=$G(XQRPC) I %]"" S XQRPC=% D RPC I 'XQMES Q XQMES
"RTN","XQCS",34,0)
 Q XQMES
"RTN","XQCS",35,0)
 ;
"RTN","XQCS",36,0)
 ;
"RTN","XQCS",37,0)
OPT ;See if the option is there and is a broker type option
"RTN","XQCS",38,0)
 I XQOPT'=+XQOPT S XQOPT=$O(^DIC(19,"B",XQOPT,0)) I XQOPT'>0 S XQMES="No such option in the ""B"" cross reference of the Option File." Q
"RTN","XQCS",39,0)
 I '$D(^DIC(19,XQOPT,0)) S XQMES="No such option in the Option File."  Q
"RTN","XQCS",40,0)
 I $P(^DIC(19,XQOPT,0),U,4)'="B" S XQMES="This option is not a Client/Server-type option."  Q
"RTN","XQCS",41,0)
 ;
"RTN","XQCS",42,0)
 ;Check for Out-Of-Order, etc.  Patch XU*8*38 7/16/96
"RTN","XQCS",43,0)
 ;
"RTN","XQCS",44,0)
 S XQCY0=^DIC(19,XQOPT,0) ;W XQCY0
"RTN","XQCS",45,0)
 I $L($P(XQCY0,U,3)) S XQMES="Option out of order with message: "_$P(XQCY0,U,3)_"."  Q
"RTN","XQCS",46,0)
 I $L($P(XQCY0,U,6)) S %=$P(XQCY0,U,6) I '$D(^XUSEC(%,DUZ)) S XQMES="Option locked, "_$P(^VA(200,DUZ,0),U)_" does not hold the key."  Q
"RTN","XQCS",47,0)
 I $L($P(XQCY0,U,16)) I $D(^DIC(19,XQOPT,3)),^(3)]"" S %=^(3) I $D(^XUSEC(%,DUZ)) S XQMES="Reverse lock, "_$P(^VA(200,DUZ,0),U)_" holds the key."  Q
"RTN","XQCS",48,0)
 I $L($P(XQCY0,U,9)) S XQZ=$P(XQCY0,U,9) D ^XQDATE S (XX,X)=% D XQO^XQ92 I X=""!(XX'=X) S XQMES="This option is time restricted."  Q
"RTN","XQCS",49,0)
 I $D(^DIC(19,+XQOPT,3.91)),$P(^(3.91,0),U,4)>1 S:$D(XQY) XQYSAV=XQY D ^XQDATE S X=%,XQY=+XQOPT D ^XQ92 S:$D(XQYSAV) XQY=XQYSAV I X="" S XQMES="This option is time restricted."  Q
"RTN","XQCS",50,0)
 ;End patch 38
"RTN","XQCS",51,0)
 Q
"RTN","XQCS",52,0)
 ;
"RTN","XQCS",53,0)
OPTLK(V) ;Lookup a Option in the file, Return it's IEN
"RTN","XQCS",54,0)
 Q $O(^DIC(19,"B",V,0))
"RTN","XQCS",55,0)
 ;
"RTN","XQCS",56,0)
RPC ;See if rpc exsists, is registered, is locked, etc.
"RTN","XQCS",57,0)
 I '$D(^DIC(19,XQOPT,"RPC",0)) S XQMES="No RPC subfile defined for the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",58,0)
 I $P(^DIC(19,XQOPT,"RPC",0),U,4)<1 S XQMES="No remote procedure calls registered for the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",59,0)
 I XQRPC'=+XQRPC S XQRPC=$O(^XWB(8994,"B",XQRPC,0)) I XQRPC'>0 S XQMES="No RPC by that name in the ""B"" cross-reference of the Remote Procedure File." Q
"RTN","XQCS",60,0)
 I '$D(^XWB(8994,XQRPC,0)) S XQMES="No such procedure in the Remote Procedure File." Q
"RTN","XQCS",61,0)
 I '$D(^DIC(19,XQOPT,"RPC","B",XQRPC)) S XQMES="The remote procedure "_$P(^XWB(8994,XQRPC,0),U)_" is not registered to the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",62,0)
 S %=$O(^DIC(19,XQOPT,"RPC","B",XQRPC,0)),XQKEY=$P(^DIC(19,XQOPT,"RPC",%,0),U,2)
"RTN","XQCS",63,0)
 I $L(XQKEY) I '$D(^XUSEC(XQKEY,XQUSR)) S XQMES="Remote procedure is locked." Q
"RTN","XQCS",64,0)
 ;
"RTN","XQCS",65,0)
RULES ;Check the rules for this RPC
"RTN","XQCS",66,0)
 S %=$O(^DIC(19,XQOPT,"RPC","B",XQRPC,0))
"RTN","XQCS",67,0)
 I $D(^DIC(19,XQOPT,"RPC",%,1)),$L(^(1)) D
"RTN","XQCS",68,0)
 .S XQRPCOK=1
"RTN","XQCS",69,0)
 .X ^DIC(19,XQOPT,"RPC",%,1)
"RTN","XQCS",70,0)
 .I XQRPCOK<1 S XQMES="Remote procedure request failed rules test."
"RTN","XQCS",71,0)
 .Q
"RTN","XQCS",72,0)
 Q
"RTN","XQCS",73,0)
 ;
"RTN","XQCS",74,0)
 ;
"RTN","XQCS",75,0)
 ;
"RTN","XQCS",76,0)
USER ;See if XQUSR has been assigned access this option or not
"RTN","XQCS",77,0)
 ;
"RTN","XQCS",78,0)
 N XQYES
"RTN","XQCS",79,0)
 S XQMES=1,(XQSMY,%,XQYES)=0
"RTN","XQCS",80,0)
 ;
"RTN","XQCS",81,0)
TOP ;See if XQOPT is on top level of a tree: primary, secondary, or common
"RTN","XQCS",82,0)
 S XQPM=+$G(^VA(200,XQUSR,201)) I XQOPT=XQPM Q
"RTN","XQCS",83,0)
 ;
"RTN","XQCS",84,0)
 I $D(^VA(200,XQUSR,203,0)),$P(^(0),U,4)>0 S XQSMY=1 D
"RTN","XQCS",85,0)
 .S XQDIC="U"_XQUSR I $S('$D(^XUTL("XQO",XQDIC,0)):1,'$D(^VA(200,XQUSR,203.1)):1,1:^VA(200,XQUSR,203.1)'=$P(^XUTL("XQO",XQDIC,0),U,2)) D ^XQSET
"RTN","XQCS",86,0)
 .S (XQSM,%)=0
"RTN","XQCS",87,0)
 .F  Q:%  S XQSM=$O(^XUTL("XQO",XQDIC,"^",XQSM)) Q:XQSM=""  I XQSM=XQOPT S XQYES=1 Q
"RTN","XQCS",88,0)
 .Q
"RTN","XQCS",89,0)
 I XQYES Q
"RTN","XQCS",90,0)
 ;
"RTN","XQCS",91,0)
 ;Check the Common Options (XUCOMMAND)
"RTN","XQCS",92,0)
 I $D(^DIC(19,"B","XUCOMMAND")) D
"RTN","XQCS",93,0)
 .I $D(^XUTL("XQO","PXU","^",XQOPT)) S XQYES=1
"RTN","XQCS",94,0)
 .Q
"RTN","XQCS",95,0)
 I XQYES Q
"RTN","XQCS",96,0)
 ;
"RTN","XQCS",97,0)
DEEP ;See if it's under the top somewhere - start with primary tree
"RTN","XQCS",98,0)
 I XQPM>0 D
"RTN","XQCS",99,0)
 .S XQDIC="P"_XQPM
"RTN","XQCS",100,0)
 .I $P(^DIC(19,XQPM,0),U,4)="M",'$D(^XUTL("XQO",XQDIC,0)) D BUILD
"RTN","XQCS",101,0)
 .I $D(^XUTL("XQO",XQDIC,"^",XQOPT)) S XQYES=1
"RTN","XQCS",102,0)
 .Q
"RTN","XQCS",103,0)
 I XQYES Q
"RTN","XQCS",104,0)
 ;
"RTN","XQCS",105,0)
 ;Check secondary trees
"RTN","XQCS",106,0)
 S (XQSM,%)=0
"RTN","XQCS",107,0)
 I XQSMY F  Q:XQYES  S XQSM=$O(^XUTL("XQO","U"_XQUSR,"^",XQSM)) Q:XQSM=""  D
"RTN","XQCS",108,0)
 .S XQDIC="P"_XQSM
"RTN","XQCS",109,0)
 .I $P(^DIC(19,XQSM,0),U,4)="M",'$D(^XUTL("XQO",XQDIC,0)) D BUILD
"RTN","XQCS",110,0)
 .I $D(^XUTL("XQO",XQDIC,"^",XQOPT)) S XQYES=1
"RTN","XQCS",111,0)
 .Q
"RTN","XQCS",112,0)
 I XQYES Q
"RTN","XQCS",113,0)
 ;
"RTN","XQCS",114,0)
 S XQMES="User "_$P(^VA(200,XQUSR,0),U)_" does not have access to option "_$P(^DIC(19,XQOPT,0),U)
"RTN","XQCS",115,0)
 Q
"RTN","XQCS",116,0)
 ;
"RTN","XQCS",117,0)
 ;End of main program
"RTN","XQCS",118,0)
 ;
"RTN","XQCS",119,0)
BUILD ;Build a single menu tree (XQDIC e.g. "P"_nnn) on the fly
"RTN","XQCS",120,0)
 Q:'$D(XQDIC)
"RTN","XQCS",121,0)
 K ^XUTL("XQO",XQDIC)
"RTN","XQCS",122,0)
 N %,%H,%TG,%Y,D,I,J,K,L,UU,V,X,Y,Z
"RTN","XQCS",123,0)
 N XQL,XQN,XQRE,XQK,XQI,XQPX,XQXUF,XQSAV,XQDATE,XQP,XQR,XQJ
"RTN","XQCS",124,0)
 N XQA,XQD,XQE,XQF,XQFL,XQSAVE ;From PMOK^XQ8
"RTN","XQCS",125,0)
 S XQXUF=1 D REBLD^XQ8
"RTN","XQCS",126,0)
 Q
"RTN","XQCS",127,0)
 ;
"RTN","XQCS",128,0)
BLDPXU ;Build ^XUTL("XQO","PXU") the XUCOMMAND compiled options tree
"RTN","XQCS",129,0)
 S:'$D(XQDIC) XQDIC="PXU"
"RTN","XQCS",130,0)
 N %,%H,%TG,%Y,D,I,J,K,L,UU,V,X,Y,Z
"RTN","XQCS",131,0)
 N XQCOM,XQDATE,XQI,XQJ,XQK,XQL,XQN,XQP,XQPX,XQR,XQRE,XQSAV
"RTN","XQCS",132,0)
 N XQA,XQD,XQE,XQF,XQFL,XQSAVE ;From PMOK^XQ8
"RTN","XQCS",133,0)
 K ^XUTL("XQO","PXU")
"RTN","XQCS",134,0)
 S XQSAV=XQDIC
"RTN","XQCS",135,0)
 S XQDIC="PXU",XQCOM=$O(^DIC(19,"B","XUCOMMAND",0)) Q:XQCOM'>0 
"RTN","XQCS",136,0)
 S Y=XQCOM,%="",(L,X(0))=0,(XQPX,XQD)=Y D TREE1^XQ8
"RTN","XQCS",137,0)
 S %H=$H,^XUTL("XQO","PXU",0)=%H,^DIC(19,XQCOM,99.1)=%H
"RTN","XQCS",138,0)
 S XQDIC=XQSAV
"RTN","XQCS",139,0)
 Q
"VER")
8.0^21.0
**END**
**END**
