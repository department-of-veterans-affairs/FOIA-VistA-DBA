Released OR*3*166 SEQ #151
Extracted from mail message
**KIDS**:OR*3.0*166^

**INSTALL NAME**
OR*3.0*166
"BLD",4061,0)
OR*3.0*166^ORDER ENTRY/RESULTS REPORTING^0^3021204^y
"BLD",4061,1,0)
^^2^2^3021202^
"BLD",4061,1,1,0)
Update to post-install for patch OR*3*158.  Please see FORUM patch module 
"BLD",4061,1,2,0)
for full details.
"BLD",4061,4,0)
^9.64PA^^
"BLD",4061,"ABPKG")
n
"BLD",4061,"KRN",0)
^9.67PA^8989.52^19
"BLD",4061,"KRN",.4,0)
.4
"BLD",4061,"KRN",.401,0)
.401
"BLD",4061,"KRN",.402,0)
.402
"BLD",4061,"KRN",.403,0)
.403
"BLD",4061,"KRN",.5,0)
.5
"BLD",4061,"KRN",.84,0)
.84
"BLD",4061,"KRN",3.6,0)
3.6
"BLD",4061,"KRN",3.8,0)
3.8
"BLD",4061,"KRN",9.2,0)
9.2
"BLD",4061,"KRN",9.8,0)
9.8
"BLD",4061,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",4061,"KRN",9.8,"NM",1,0)
ORY166^^0^B20589588
"BLD",4061,"KRN",9.8,"NM","B","ORY166",1)

"BLD",4061,"KRN",19,0)
19
"BLD",4061,"KRN",19.1,0)
19.1
"BLD",4061,"KRN",101,0)
101
"BLD",4061,"KRN",409.61,0)
409.61
"BLD",4061,"KRN",771,0)
771
"BLD",4061,"KRN",870,0)
870
"BLD",4061,"KRN",8989.51,0)
8989.51
"BLD",4061,"KRN",8989.52,0)
8989.52
"BLD",4061,"KRN",8994,0)
8994
"BLD",4061,"KRN","B",.4,.4)

"BLD",4061,"KRN","B",.401,.401)

"BLD",4061,"KRN","B",.402,.402)

"BLD",4061,"KRN","B",.403,.403)

"BLD",4061,"KRN","B",.5,.5)

"BLD",4061,"KRN","B",.84,.84)

"BLD",4061,"KRN","B",3.6,3.6)

"BLD",4061,"KRN","B",3.8,3.8)

"BLD",4061,"KRN","B",9.2,9.2)

"BLD",4061,"KRN","B",9.8,9.8)

"BLD",4061,"KRN","B",19,19)

"BLD",4061,"KRN","B",19.1,19.1)

"BLD",4061,"KRN","B",101,101)

"BLD",4061,"KRN","B",409.61,409.61)

"BLD",4061,"KRN","B",771,771)

"BLD",4061,"KRN","B",870,870)

"BLD",4061,"KRN","B",8989.51,8989.51)

"BLD",4061,"KRN","B",8989.52,8989.52)

"BLD",4061,"KRN","B",8994,8994)

"BLD",4061,"QUES",0)
^9.62^^
"BLD",4061,"REQB",0)
^9.611^1^1
"BLD",4061,"REQB",1,0)
OR*3.0*158^2
"BLD",4061,"REQB","B","OR*3.0*158",1)

"MBREQ")
0
"PKG",110,-1)
1^1
"PKG",110,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",110,20,0)
^9.402P^^
"PKG",110,22,0)
^9.49I^1^1
"PKG",110,22,1,0)
3.0^2971217
"PKG",110,22,1,"PAH",1,0)
166^3021204^1326
"PKG",110,22,1,"PAH",1,1,0)
^^2^2^3021204
"PKG",110,22,1,"PAH",1,1,1,0)
Update to post-install for patch OR*3*158.  Please see FORUM patch module 
"PKG",110,22,1,"PAH",1,1,2,0)
for full details.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","ORY166")
0^1^B20589588
"RTN","ORY166",1,0)
ORY166 ;SLC/DAN ;12/4/02  08:06
"RTN","ORY166",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**166**;Dec 17, 1997
"RTN","ORY166",3,0)
 ;DBIA 2058 allows read of B xref in DIC(9.4
"RTN","ORY166",4,0)
 ;DBIA 2197 allows reading of install file
"RTN","ORY166",5,0)
 ;
"RTN","ORY166",6,0)
POST ;Find child entries with a provider of 0 and update it to the correct provider
"RTN","ORY166",7,0)
 ;
"RTN","ORY166",8,0)
 N ORMSG,ZTSK,ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSAVE
"RTN","ORY166",9,0)
 S ORMSG(1)="This patch contains a post-init which will run in the background and fix"
"RTN","ORY166",10,0)
 S ORMSG(2)="any known database errors.  It will then send a mail message to the"
"RTN","ORY166",11,0)
 S ORMSG(3)="initiator indicating what was changed."
"RTN","ORY166",12,0)
 D BMES^XPDUTL(.ORMSG)
"RTN","ORY166",13,0)
 S ZTRTN="DQ^ORY166",ZTDESC="Patch OR*3*166 database clean up",ZTIO="",ZTSAVE("DUZ")="",ZTDTH=""
"RTN","ORY166",14,0)
 D ^%ZTLOAD
"RTN","ORY166",15,0)
 I $G(ZTSK) D BMES^XPDUTL("Post-init queued to background as task number "_ZTSK_".")
"RTN","ORY166",16,0)
 Q
"RTN","ORY166",17,0)
 ;
"RTN","ORY166",18,0)
DQ ;Enter here for queued task
"RTN","ORY166",19,0)
 N ERR,CNT
"RTN","ORY166",20,0)
 K ^TMP("ORFIX",$J)
"RTN","ORY166",21,0)
 D UPDATE,MAIL
"RTN","ORY166",22,0)
 K ^TMP("ORFIX",$J)
"RTN","ORY166",23,0)
 Q
"RTN","ORY166",24,0)
 ;
"RTN","ORY166",25,0)
UPDATE ;
"RTN","ORY166",26,0)
 N DATE,IEN,PARENT,PROV,PKG,PKGNUM
"RTN","ORY166",27,0)
 S DATE=$$INSTDT("ORDER ENTRY/RESULTS REPORTING 3.0")
"RTN","ORY166",28,0)
 S DATE=$S(DATE:$$FMADD^XLFDT(DATE,-1,23,59),1:2960630.24) ;If install date not found revert back to 1st possible install date
"RTN","ORY166",29,0)
 S IEN=$$GETIEN(DATE)-1 ;Get first order number for date, subtract one so the first order is reviewed
"RTN","ORY166",30,0)
 S CNT=0
"RTN","ORY166",31,0)
 I IEN=-1 S ERR="No orders in date range" Q  ;No orders to review
"RTN","ORY166",32,0)
 F  S IEN=$O(^OR(100,IEN)) Q:'+IEN  D
"RTN","ORY166",33,0)
 .Q:'$D(^OR(100,IEN,0))  Q:+$P(^OR(100,IEN,0),U,4)'=0  ;Quit if 0 node missing or if order is ok (provider '= 0)
"RTN","ORY166",34,0)
 .S PKGNUM=$P(^OR(100,IEN,0),U,14) Q:PKGNUM=""  ;Stop if no package entered
"RTN","ORY166",35,0)
 .S PKG=$E($$NMSP^ORCD(PKGNUM),1,2) ;Get first two characters of Package
"RTN","ORY166",36,0)
 .I PKG="LR"&($P(^OR(100,IEN,0),U,2)'["DPT") Q  ;Stop if lab and not from patient file
"RTN","ORY166",37,0)
 .I PKG="LR"!(PKG="PS") D  Q  ;If package lab or pharmacy then check
"RTN","ORY166",38,0)
 ..S PROV=$$CHKPAR
"RTN","ORY166",39,0)
 ..I PROV D
"RTN","ORY166",40,0)
 ...S ^TMP("ORFIX",$J,PKGNUM,IEN)=" - FIXED"
"RTN","ORY166",41,0)
 ...S $P(^OR(100,IEN,0),U,4)=PROV
"RTN","ORY166",42,0)
 ...S CNT=CNT+1
"RTN","ORY166",43,0)
 ...D CHKACT ;Check actions to be sure they have provider entered
"RTN","ORY166",44,0)
 Q
"RTN","ORY166",45,0)
 ;
"RTN","ORY166",46,0)
CHKPAR() ;Check to see if there is a parent order and if so, return provider
"RTN","ORY166",47,0)
 S PARENT=$P($G(^OR(100,IEN,3)),U,9)
"RTN","ORY166",48,0)
 I '+PARENT Q 0  ;No parent order found
"RTN","ORY166",49,0)
 S PROV=$P($G(^OR(100,PARENT,0)),U,4)
"RTN","ORY166",50,0)
 I '+PROV Q 0  ;No provider found in parent order
"RTN","ORY166",51,0)
 Q PROV
"RTN","ORY166",52,0)
 ;
"RTN","ORY166",53,0)
CHKACT ;Check actions for missing provider as well
"RTN","ORY166",54,0)
 N I
"RTN","ORY166",55,0)
 S I=0 F  S I=$O(^OR(100,IEN,8,I)) Q:'+I  D
"RTN","ORY166",56,0)
 .I $P($G(^OR(100,IEN,8,I,0)),U,3)=0 S $P(^(0),U,3)=PROV
"RTN","ORY166",57,0)
 Q
"RTN","ORY166",58,0)
GETIEN(STDT) ;Find first IEN associated with given start date
"RTN","ORY166",59,0)
 N DONE,IEN
"RTN","ORY166",60,0)
 S (DONE,IEN)=0
"RTN","ORY166",61,0)
 F  S STDT=$O(^OR(100,"AF",STDT)) Q:'+STDT!(DONE)  D
"RTN","ORY166",62,0)
 .S IEN=0 F  S IEN=$O(^OR(100,"AF",STDT,IEN)) Q:'+IEN  I $O(^(IEN,0))=1 S DONE=1 Q  ;Find first ORDER that is a new order
"RTN","ORY166",63,0)
 Q IEN
"RTN","ORY166",64,0)
 ;
"RTN","ORY166",65,0)
MAIL ;Send results of cleanup in a mail message to initiator
"RTN","ORY166",66,0)
 N I,XMSUB,XMTEXT,XMDUZ,XMY,PKG,ORD
"RTN","ORY166",67,0)
 S XMSUB="Patch OR*3*166 Clean up completed"
"RTN","ORY166",68,0)
 S XMDUZ="Patch OR*3*166 Post-Init"
"RTN","ORY166",69,0)
 S XMY(.5)="" S:$G(DUZ) XMY(DUZ)=""
"RTN","ORY166",70,0)
 S XMTEXT="^TMP(""ORTXT"",$J,"
"RTN","ORY166",71,0)
 K ^TMP("ORTXT",$J)
"RTN","ORY166",72,0)
 S I=1
"RTN","ORY166",73,0)
 S ^TMP("ORTXT",$J,I)="The database clean-up for patch OR*3*166 has completed.",I=I+1
"RTN","ORY166",74,0)
 S ^TMP("ORTXT",$J,I)="Below is a listing of what was changed and any possible error messages.",I=I+1
"RTN","ORY166",75,0)
 S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY166",76,0)
 S ^TMP("ORTXT",$J,I)=CNT_" orders had their provider field updated.",I=I+1
"RTN","ORY166",77,0)
 S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY166",78,0)
 I $D(ERR) D
"RTN","ORY166",79,0)
 .S ^TMP("ORTXT",$J,I)="An error occurred that stopped the post-init.  It was:",I=I+1
"RTN","ORY166",80,0)
 .S ^TMP("ORTXT",$J,I)=ERR,I=I+1
"RTN","ORY166",81,0)
 .S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY166",82,0)
 I '$D(ERR),'CNT S ^TMP("ORTXT",$J,I)="No changes were made to your database.",I=I+1
"RTN","ORY166",83,0)
 S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY166",84,0)
 S PKG=0 F  S PKG=$O(^TMP("ORFIX",$J,PKG)) Q:PKG=""  D
"RTN","ORY166",85,0)
 .S ^TMP("ORTXT",$J,I)=$P(^DIC(9.4,PKG,0),U),I=I+1
"RTN","ORY166",86,0)
 .S ORD=0 F  S ORD=$O(^TMP("ORFIX",$J,PKG,ORD)) Q:ORD=""  D
"RTN","ORY166",87,0)
 ..S ^TMP("ORTXT",$J,I)="   ORDER #: "_ORD_" "_^TMP("ORFIX",$J,PKG,ORD),I=I+1
"RTN","ORY166",88,0)
 .S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY166",89,0)
 D ^XMD ;send results
"RTN","ORY166",90,0)
 K ^TMP("ORTXT",$J)
"RTN","ORY166",91,0)
 Q
"RTN","ORY166",92,0)
 ;
"RTN","ORY166",93,0)
INSTDT(PATCH) ;Returns installation date patch first installed at site
"RTN","ORY166",94,0)
 N IEN
"RTN","ORY166",95,0)
 S IEN=$O(^XPD(9.7,"B",PATCH,0)) Q:'+IEN 0 ;Get IEN of first installation
"RTN","ORY166",96,0)
 Q $P($P($G(^XPD(9.7,IEN,1)),U),".")  ;Get date of first install
"VER")
8.0^22.0
**END**
**END**
