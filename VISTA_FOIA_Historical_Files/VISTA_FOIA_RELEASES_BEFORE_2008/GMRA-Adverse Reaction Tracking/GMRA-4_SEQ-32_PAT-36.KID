Released GMRA*4*36 SEQ #32
Extracted from mail message
**KIDS**:GMRA*4.0*36^

**INSTALL NAME**
GMRA*4.0*36
"BLD",6130,0)
GMRA*4.0*36^ADVERSE REACTION TRACKING^0^3070201^y
"BLD",6130,1,0)
^^3^3^3061012^^
"BLD",6130,1,1,0)
Removes ability to delete existing allergy entries from the
"BLD",6130,1,2,0)
roll and scroll environment.
"BLD",6130,1,3,0)
Please see the FORUM patch module for a complete description.
"BLD",6130,4,0)
^9.64PA^120.82^1
"BLD",6130,4,120.82,0)
120.82
"BLD",6130,4,120.82,2,0)
^9.641^120.824^1
"BLD",6130,4,120.82,2,120.824,0)
DRUG INGREDIENTS  (sub-file)
"BLD",6130,4,120.82,2,120.824,1,0)
^9.6411^.01^1
"BLD",6130,4,120.82,2,120.824,1,.01,0)
DRUG INGREDIENT
"BLD",6130,4,120.82,222)
y^y^p^^^^n^^n
"BLD",6130,4,120.82,224)

"BLD",6130,4,"APDD",120.82,120.824)

"BLD",6130,4,"APDD",120.82,120.824,.01)

"BLD",6130,4,"B",120.82,120.82)

"BLD",6130,6)
5^
"BLD",6130,6.3)
9
"BLD",6130,"ABPKG")
n
"BLD",6130,"INIT")
GMRAY36
"BLD",6130,"KRN",0)
^9.67PA^8989.52^19
"BLD",6130,"KRN",.4,0)
.4
"BLD",6130,"KRN",.401,0)
.401
"BLD",6130,"KRN",.402,0)
.402
"BLD",6130,"KRN",.403,0)
.403
"BLD",6130,"KRN",.5,0)
.5
"BLD",6130,"KRN",.84,0)
.84
"BLD",6130,"KRN",3.6,0)
3.6
"BLD",6130,"KRN",3.8,0)
3.8
"BLD",6130,"KRN",9.2,0)
9.2
"BLD",6130,"KRN",9.8,0)
9.8
"BLD",6130,"KRN",9.8,"NM",0)
^9.68A^11^11
"BLD",6130,"KRN",9.8,"NM",1,0)
GMRAPEM3^^0^B3076909
"BLD",6130,"KRN",9.8,"NM",2,0)
GMRAGUI1^^0^B56993804
"BLD",6130,"KRN",9.8,"NM",3,0)
GMRADEL^^0^B12620688
"BLD",6130,"KRN",9.8,"NM",4,0)
GMRASIGN^^0^B40714673
"BLD",6130,"KRN",9.8,"NM",5,0)
GMRASIG1^^0^B16149250
"BLD",6130,"KRN",9.8,"NM",6,0)
GMRAY36^^0^B23667730
"BLD",6130,"KRN",9.8,"NM",7,0)
GMRAY36A^^0^B1688077
"BLD",6130,"KRN",9.8,"NM",8,0)
GMRAUTL2^^0^B79798893
"BLD",6130,"KRN",9.8,"NM",9,0)
GMRAPEM0^^0^B43826251
"BLD",6130,"KRN",9.8,"NM",10,0)
GMRAMCB^^0^B10933598
"BLD",6130,"KRN",9.8,"NM",11,0)
GMRANKA^^0^B12980471
"BLD",6130,"KRN",9.8,"NM","B","GMRADEL",3)

"BLD",6130,"KRN",9.8,"NM","B","GMRAGUI1",2)

"BLD",6130,"KRN",9.8,"NM","B","GMRAMCB",10)

"BLD",6130,"KRN",9.8,"NM","B","GMRANKA",11)

"BLD",6130,"KRN",9.8,"NM","B","GMRAPEM0",9)

"BLD",6130,"KRN",9.8,"NM","B","GMRAPEM3",1)

"BLD",6130,"KRN",9.8,"NM","B","GMRASIG1",5)

"BLD",6130,"KRN",9.8,"NM","B","GMRASIGN",4)

"BLD",6130,"KRN",9.8,"NM","B","GMRAUTL2",8)

"BLD",6130,"KRN",9.8,"NM","B","GMRAY36",6)

"BLD",6130,"KRN",9.8,"NM","B","GMRAY36A",7)

"BLD",6130,"KRN",19,0)
19
"BLD",6130,"KRN",19.1,0)
19.1
"BLD",6130,"KRN",101,0)
101
"BLD",6130,"KRN",409.61,0)
409.61
"BLD",6130,"KRN",771,0)
771
"BLD",6130,"KRN",870,0)
870
"BLD",6130,"KRN",8989.51,0)
8989.51
"BLD",6130,"KRN",8989.52,0)
8989.52
"BLD",6130,"KRN",8994,0)
8994
"BLD",6130,"KRN","B",.4,.4)

"BLD",6130,"KRN","B",.401,.401)

"BLD",6130,"KRN","B",.402,.402)

"BLD",6130,"KRN","B",.403,.403)

"BLD",6130,"KRN","B",.5,.5)

"BLD",6130,"KRN","B",.84,.84)

"BLD",6130,"KRN","B",3.6,3.6)

"BLD",6130,"KRN","B",3.8,3.8)

"BLD",6130,"KRN","B",9.2,9.2)

"BLD",6130,"KRN","B",9.8,9.8)

"BLD",6130,"KRN","B",19,19)

"BLD",6130,"KRN","B",19.1,19.1)

"BLD",6130,"KRN","B",101,101)

"BLD",6130,"KRN","B",409.61,409.61)

"BLD",6130,"KRN","B",771,771)

"BLD",6130,"KRN","B",870,870)

"BLD",6130,"KRN","B",8989.51,8989.51)

"BLD",6130,"KRN","B",8989.52,8989.52)

"BLD",6130,"KRN","B",8994,8994)

"BLD",6130,"QUES",0)
^9.62^^
"BLD",6130,"REQB",0)
^9.611^2^2
"BLD",6130,"REQB",1,0)
GMRA*4.0*25^1
"BLD",6130,"REQB",2,0)
GMRA*4.0*23^1
"BLD",6130,"REQB","B","GMRA*4.0*23",2)

"BLD",6130,"REQB","B","GMRA*4.0*25",1)

"FIA",120.82)
GMR ALLERGIES
"FIA",120.82,0)
^GMRD(120.82,
"FIA",120.82,0,0)
120.82I
"FIA",120.82,0,1)
y^y^p^^^^n^^n
"FIA",120.82,0,10)

"FIA",120.82,0,11)

"FIA",120.82,0,"RLRO")

"FIA",120.82,0,"VR")
4.0^GMRA
"FIA",120.82,120.82)
1
"FIA",120.82,120.82,4)

"FIA",120.82,120.824)
1
"FIA",120.82,120.824,.01)

"INIT")
GMRAY36
"IX",120.82,120.824,"AC",0)
120.824^AC^Identifies changes to existing ingredients^MU^^F^R^I^120.824^^^^^A
"IX",120.82,120.824,"AC",1)
Q:$D(DIU(0))  S GMRAT="ING" D ^GMRAUTL2
"IX",120.82,120.824,"AC",2)
Q:$D(DIU(0))  S GMRAT="ING" D ^GMRAUTL2
"IX",120.82,120.824,"AC",11.1,0)
^.114IA^1^1
"IX",120.82,120.824,"AC",11.1,1,0)
1^F^120.824^.01^^^F
"MBREQ")
0
"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
36^3070201^1326
"PKG",140,22,1,"PAH",1,1,0)
^^3^3^3070201
"PKG",140,22,1,"PAH",1,1,1,0)
Removes ability to delete existing allergy entries from the
"PKG",140,22,1,"PAH",1,1,2,0)
roll and scroll environment.
"PKG",140,22,1,"PAH",1,1,3,0)
Please see the FORUM patch module for a complete description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
11
"RTN","GMRADEL")
0^3^B12620688^B8878805
"RTN","GMRADEL",1,0)
GMRADEL ;HIRMFO/WAA-PATIENT DELETE REACTION ;11/14/06  13:18
"RTN","GMRADEL",2,0)
 ;;4.0;Adverse Reaction Tracking;**36**;Mar 29, 1996;Build 9
"RTN","GMRADEL",3,0)
 ;
"RTN","GMRADEL",4,0)
 ; Is this data Correct question:  
"RTN","GMRADEL",5,0)
 ;Single Reaction:
"RTN","GMRADEL",6,0)
 ;  user    |
"RTN","GMRADEL",7,0)
 ; reponse  | action taken
"RTN","GMRADEL",8,0)
 ;-------------------------------------------------------------
"RTN","GMRADEL",9,0)
 ;   Yes    | Data is Sign off
"RTN","GMRADEL",10,0)
 ;          |
"RTN","GMRADEL",11,0)
 ;   No     | User is asked if they wish to delete the entry
"RTN","GMRADEL",12,0)
 ; ^,timeout|---------------------------------------------------
"RTN","GMRADEL",13,0)
 ;          | response | action taken
"RTN","GMRADEL",14,0)
 ;          |---------------------------------------------------
"RTN","GMRADEL",15,0)
 ;          |   yes    | the entry is deleted
"RTN","GMRADEL",16,0)
 ;          | ^,timeout|
"RTN","GMRADEL",17,0)
 ;          |          |
"RTN","GMRADEL",18,0)
 ;          |   no     | the entry is not deletes and a alert trigered
"RTN","GMRADEL",19,0)
 ;          |---------------------------------------------------
"RTN","GMRADEL",20,0)
 ;
"RTN","GMRADEL",21,0)
 ;Multiple Reaction:
"RTN","GMRADEL",22,0)
 ;  user    |
"RTN","GMRADEL",23,0)
 ; reponse  | action taken
"RTN","GMRADEL",24,0)
 ;-------------------------------------------------------------
"RTN","GMRADEL",25,0)
 ; select   | Selected reaction will be signed
"RTN","GMRADEL",26,0)
 ;reactions |
"RTN","GMRADEL",27,0)
 ;          |
"RTN","GMRADEL",28,0)
 ;reactions | all User is asked if they wish to delete the entry
"RTN","GMRADEL",29,0)
 ;NOT       |---------------------------------------------------
"RTN","GMRADEL",30,0)
 ;selected  | response | action taken
"RTN","GMRADEL",31,0)
 ; OR       |---------------------------------------------------
"RTN","GMRADEL",32,0)
 ;^,timeout |   yes    | the entries is deleted
"RTN","GMRADEL",33,0)
 ;          | ^,timeout|
"RTN","GMRADEL",34,0)
 ;          |          |
"RTN","GMRADEL",35,0)
 ;          |   no     | the entries is not deletes and a alert trigered
"RTN","GMRADEL",36,0)
 ;          |---------------------------------------------------
"RTN","GMRADEL",37,0)
 ;
"RTN","GMRADEL",38,0)
 ;Note: Only one entry point will be needed.....
"RTN","GMRADEL",39,0)
DEL ; Main Entry point
"RTN","GMRADEL",40,0)
 N DIR,GMRACNT,GMRAPCT
"RTN","GMRADEL",41,0)
 D DELPRT  ; No reaction to be deleted
"RTN","GMRADEL",42,0)
 S DIR(0)="YA",DIR("B")="YES"
"RTN","GMRADEL",43,0)
 S DIR("?")="PLEASE ENTER 'Y' TO DELETE THE CAUSATIVE AGENT"_$S(GMRACNT>1:"S",1:"")_" 'N' NOT TO DELETE THE DATA"
"RTN","GMRADEL",44,0)
 S DIR("??")="^D PRINT^GMRASIGN",DIR("A")="Do you wish to delete "_$S(GMRACNT>1:"these",1:"this")_" Causative Agent"_$S(GMRACNT>1:"s",1:"")_"? " D ^DIR
"RTN","GMRADEL",45,0)
 I $D(DIRUT) S Y=1,GMRAOUT=1
"RTN","GMRADEL",46,0)
 S GMRAPCT=Y
"RTN","GMRADEL",47,0)
 Q:'GMRAPCT  ; User did not want to delete the entry(s)
"RTN","GMRADEL",48,0)
 ; User want to delete the data
"RTN","GMRADEL",49,0)
 D DELETE
"RTN","GMRADEL",50,0)
 Q
"RTN","GMRADEL",51,0)
DELETE ; Deleting the data
"RTN","GMRADEL",52,0)
 N X
"RTN","GMRADEL",53,0)
 ;W !,"One moment please deleting data..."
"RTN","GMRADEL",54,0)
 S X=0 F  S X=$O(^TMP($J,"GMRASF",X)) Q:X<1  D
"RTN","GMRADEL",55,0)
 .N GMRAPA
"RTN","GMRADEL",56,0)
 .S GMRAPA=$O(^TMP($J,"GMRASF",X,0)) ; find 120.8 data
"RTN","GMRADEL",57,0)
 .S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRADEL",58,0)
 .I '$G(^TMP($J,"GMRASF",X,GMRAPA)) D EIE Q  ;36 Existing records are marked entered in error rather than being deleted
"RTN","GMRADEL",59,0)
 .N GMRAPA1
"RTN","GMRADEL",60,0)
 .S GMRAPA1=0
"RTN","GMRADEL",61,0)
 .; find 120.85 data
"RTN","GMRADEL",62,0)
 .F  S GMRAPA1=$O(^GMR(120.85,"C",GMRAPA,GMRAPA1)) Q:GMRAPA1<1  D
"RTN","GMRADEL",63,0)
 ..S GMRAPA1(0)=$G(^GMR(120.85,GMRAPA1,0))
"RTN","GMRADEL",64,0)
 ..I GMRAPA1(0)="" K ^GMR(120.85,"C",GMRAPA,GMRAPA1) Q 
"RTN","GMRADEL",65,0)
 ..D  ; delete 120.85 data
"RTN","GMRADEL",66,0)
 ...N DIK,DA
"RTN","GMRADEL",67,0)
 ...S DIK="^GMR(120.85,",DA=GMRAPA1 D ^DIK
"RTN","GMRADEL",68,0)
 ...D UNLOCK^GMRAUTL(120.85,GMRAPA1) ; Unlocking the data 120.85
"RTN","GMRADEL",69,0)
 ...;W "." ;36
"RTN","GMRADEL",70,0)
 ...Q
"RTN","GMRADEL",71,0)
 ..Q
"RTN","GMRADEL",72,0)
 .D  ; delete 120.8 data
"RTN","GMRADEL",73,0)
 ..N DIK,DA
"RTN","GMRADEL",74,0)
 ..S DIK="^GMR(120.8,",DA=GMRAPA D ^DIK
"RTN","GMRADEL",75,0)
 ..D UNLOCK^GMRAUTL(120.8,GMRAPA) ; Unlocking the data 120.8
"RTN","GMRADEL",76,0)
 ..;W "." ;36
"RTN","GMRADEL",77,0)
 ..Q
"RTN","GMRADEL",78,0)
 .S X=$O(^TMP($J,"GMRASF","B",GMRAPA,0))
"RTN","GMRADEL",79,0)
 .K ^TMP($J,"GMRASF",X,GMRAPA),^TMP($J,"GMRASF","B",GMRAPA,X)
"RTN","GMRADEL",80,0)
 .Q
"RTN","GMRADEL",81,0)
 Q
"RTN","GMRADEL",82,0)
DELPRT ; List all the reaction not signed
"RTN","GMRADEL",83,0)
 N X,GMRAPA
"RTN","GMRADEL",84,0)
 W @IOF
"RTN","GMRADEL",85,0)
 S (GMRACNT,X)=0
"RTN","GMRADEL",86,0)
 F  S X=$O(^TMP($J,"GMRASF",X)) Q:X<1  D
"RTN","GMRADEL",87,0)
 .S GMRAPA=$O(^TMP($J,"GMRASF",X,0))
"RTN","GMRADEL",88,0)
 .S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRADEL",89,0)
 .W !,$P(GMRAPA(0),U,2)
"RTN","GMRADEL",90,0)
 .S GMRACNT=GMRACNT+1
"RTN","GMRADEL",91,0)
 .Q
"RTN","GMRADEL",92,0)
 Q
"RTN","GMRADEL",93,0)
 ;
"RTN","GMRADEL",94,0)
EIE ;Section added in patch 36, will mark existing records entered in error
"RTN","GMRADEL",95,0)
 N GMRADFN,ALDATA,SUB
"RTN","GMRADEL",96,0)
 S GMRADFN=$P(GMRAPA(0),U)
"RTN","GMRADEL",97,0)
 S ALDATA("GMRAERRDT")=$$NOW^XLFDT,ALDATA("GMRAERRBY")=$G(DUZ,.5)
"RTN","GMRADEL",98,0)
 D EIE^GMRAGUI1(GMRAPA,GMRADFN,"ALDATA")
"RTN","GMRADEL",99,0)
 S SUB=$O(^TMP($J,"GMRASF","B",GMRAPA,0))
"RTN","GMRADEL",100,0)
 K ^TMP($J,"GMRASF",SUB,GMRAPA),^TMP($J,"GMRASF","B",GMRAPA,SUB) ;Delete entry as it's been taken care of
"RTN","GMRADEL",101,0)
 Q
"RTN","GMRAGUI1")
0^2^B56993804^B56901114
"RTN","GMRAGUI1",1,0)
GMRAGUI1 ;SLC/DAN - CPRS GUI support ;7/13/06  14:32
"RTN","GMRAGUI1",2,0)
 ;;4.0;Adverse Reaction Tracking;**21,25,36**;Mar 29, 1996;Build 9
"RTN","GMRAGUI1",3,0)
 ;
"RTN","GMRAGUI1",4,0)
 Q
"RTN","GMRAGUI1",5,0)
EN1 ; GETREC, cont'd
"RTN","GMRAGUI1",6,0)
OBSV ;  Get OBSERVATIONS from file 120.85
"RTN","GMRAGUI1",7,0)
 S STRING="~OBSERVATIONS" D NEXT
"RTN","GMRAGUI1",8,0)
 S OBSIEN=0
"RTN","GMRAGUI1",9,0)
OBSLOOP S OBSIEN=$O(^GMR(120.85,"C",GMRAIEN,OBSIEN)) G:OBSIEN<1 EXIT
"RTN","GMRAGUI1",10,0)
 S GMRA(1)=$G(^GMR(120.85,OBSIEN,0)) Q:'$L(GMRA(1))
"RTN","GMRAGUI1",11,0)
 S STRING="tRecord            : "_OBSIEN D NEXT
"RTN","GMRAGUI1",12,0)
 S USRNAM=""
"RTN","GMRAGUI1",13,0)
 S USR=$P(GMRA(1),U,13) I USR'="" D GETUSR
"RTN","GMRAGUI1",14,0)
 S Y=$P(GMRA(1),U,1) X ^DD("DD")
"RTN","GMRAGUI1",15,0)
 S STRING="tDate/Time of Event: "_Y D NEXT
"RTN","GMRAGUI1",16,0)
 S STRING="tObserver          : "_USRNAM D NEXT
"RTN","GMRAGUI1",17,0)
 S SEVCOD=$P(GMRA(1),U,14)
"RTN","GMRAGUI1",18,0)
 S SEVER=$S(SEVCOD=1:"MILD",SEVCOD=2:"MODERATE",SEVCOD=3:"SEVERE",1:"")
"RTN","GMRAGUI1",19,0)
 S STRING="tSeverity          : "_SEVER D NEXT
"RTN","GMRAGUI1",20,0)
 S Y=$P(GMRA(1),U,18) X ^DD("DD")
"RTN","GMRAGUI1",21,0)
 S STRING="tDate Reported     : "_Y D NEXT
"RTN","GMRAGUI1",22,0)
 S USRNAM=""
"RTN","GMRAGUI1",23,0)
 S USR=$P(GMRA(1),U,19) I USR'="" D GETUSR
"RTN","GMRAGUI1",24,0)
 S STRING="tReporting User    : "_USRNAM D NEXT
"RTN","GMRAGUI1",25,0)
 S STRING="t" F I=1:1:60 S STRING=STRING_"-"
"RTN","GMRAGUI1",26,0)
 D NEXT
"RTN","GMRAGUI1",27,0)
 G OBSLOOP
"RTN","GMRAGUI1",28,0)
EXIT Q
"RTN","GMRAGUI1",29,0)
NEXT ;SET ARRAY NODE AND INCREMENT ARRAY COUNTER
"RTN","GMRAGUI1",30,0)
 S @GMRARRAY@(ND)=STRING,ND=ND+1,STRING=""
"RTN","GMRAGUI1",31,0)
 Q
"RTN","GMRAGUI1",32,0)
GETUSR S USRNAM=$$GET1^DIQ(200,USR_",",".01")
"RTN","GMRAGUI1",33,0)
 Q
"RTN","GMRAGUI1",34,0)
 ;
"RTN","GMRAGUI1",35,0)
EIE(GMRAIEN,GMRADFN,GMRARRAY) ;Mark individual entry as entered in error
"RTN","GMRAGUI1",36,0)
 N DIE,DA,DR,Y,DIK,DFN,OROLD,VAIN,X,GMRAOUT,GMRAPA
"RTN","GMRAGUI1",37,0)
 L +^XTMP("GMRAED",GMRADFN):1 I '$T D MESS Q
"RTN","GMRAGUI1",38,0)
 S GMRAPA=GMRAIEN
"RTN","GMRAGUI1",39,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR="15///1;22///1;23///"_@GMRARRAY@("GMRAERRDT")_";24////"_$G(@GMRARRAY@("GMRAERRBY"),.5) ;36
"RTN","GMRAGUI1",40,0)
 D ^DIE ;Entered in error on date/time by user
"RTN","GMRAGUI1",41,0)
 I $D(@GMRARRAY@("GMRAERRCMTS")) D ADCOM(GMRAPA,"E",$NA(@GMRARRAY@("GMRAERRCMTS"))) ;add comments
"RTN","GMRAGUI1",42,0)
 I $$NKASCR^GMRANKA($P(^GMR(120.8,GMRAPA,0),U)) D
"RTN","GMRAGUI1",43,0)
 .S DIK="^GMR(120.86,",DA=$P(^GMR(120.8,GMRAPA,0),U)
"RTN","GMRAGUI1",44,0)
 .D ^DIK ;If patient's last allergy marked as entered in error then delete assessment
"RTN","GMRAGUI1",45,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAGUI1",46,0)
 S GMRAOUT=0
"RTN","GMRAGUI1",47,0)
 D EN1^GMRAEAB ;Sends entered in error bulletin to appropriate mail groups
"RTN","GMRAGUI1",48,0)
 D EN1^GMRAPET0(GMRADFN,GMRAPA,"E",.GMRAOUT) ;21 File Progress Note
"RTN","GMRAGUI1",49,0)
 S DFN=GMRADFN
"RTN","GMRAGUI1",50,0)
 D INP^VADPT S X=$$FIND1^DIC(101,,"BX","GMRA ENTERED IN ERROR")_";ORD(101,"
"RTN","GMRAGUI1",51,0)
 D:X EN^XQOR ;Process protocols hanging off of "entered in error" protocol
"RTN","GMRAGUI1",52,0)
 L -^XTMP("GMRAED",GMRADFN)
"RTN","GMRAGUI1",53,0)
 Q
"RTN","GMRAGUI1",54,0)
 ;
"RTN","GMRAGUI1",55,0)
ADCOM(ENTRY,TYPE,GMRACOM) ;Add comments to allergies
"RTN","GMRAGUI1",56,0)
 ;
"RTN","GMRAGUI1",57,0)
 N FDA,GMRAI,X,DIWL,DIWR
"RTN","GMRAGUI1",58,0)
 K ^UTILITY($J,"W") S DIWL=1,DIWR=60 S GMRAI=0 F  S GMRAI=$O(@GMRACOM@(GMRAI)) Q:'+GMRAI  S X=@GMRACOM@(GMRAI) D ^DIWP
"RTN","GMRAGUI1",59,0)
 S GMRACOM="^UTILITY($J,""W"",1)"
"RTN","GMRAGUI1",60,0)
 S FDA(120.826,"+1,"_ENTRY_",",.01)=$$NOW^XLFDT
"RTN","GMRAGUI1",61,0)
 S FDA(120.826,"+1,"_ENTRY_",",1)=DUZ
"RTN","GMRAGUI1",62,0)
 S FDA(120.826,"+1,"_ENTRY_",",1.5)=TYPE
"RTN","GMRAGUI1",63,0)
 S FDA(120.826,"+1,"_ENTRY_",",2)=GMRACOM
"RTN","GMRAGUI1",64,0)
 D UPDATE^DIE("","FDA")
"RTN","GMRAGUI1",65,0)
 Q
"RTN","GMRAGUI1",66,0)
 ;
"RTN","GMRAGUI1",67,0)
NKA ;Change patient assessment to NKA
"RTN","GMRAGUI1",68,0)
 ;
"RTN","GMRAGUI1",69,0)
 N DA,DR,DIE,NKA,DFN
"RTN","GMRAGUI1",70,0)
 S DFN=ORDFN
"RTN","GMRAGUI1",71,0)
 L +^XTMP("GMRAED",DFN):1 I '$T D MESS Q
"RTN","GMRAGUI1",72,0)
 S NKA=$$NKA^GMRANKA(DFN)
"RTN","GMRAGUI1",73,0)
 I NKA=0 Q  ;Patient is already NKA
"RTN","GMRAGUI1",74,0)
 I NKA=1 S ORY="-1^Patient has active allergies - can't mark as NKA" Q
"RTN","GMRAGUI1",75,0)
 L +^GMR(120.86,0):5 I '$T S ORY="-1^Unable to update assessment - try again." Q
"RTN","GMRAGUI1",76,0)
 I '$D(^GMR(120.86,DFN,0)) D  ;Add assessment entry
"RTN","GMRAGUI1",77,0)
 .S $P(^GMR(120.86,0),U,3,4)=(DFN_"^"_($P(^GMR(120.86,0),U,4)+1))
"RTN","GMRAGUI1",78,0)
 .S ^GMR(120.86,DFN,0)=DFN_U,^GMR(120.86,"B",DFN,DFN)=""
"RTN","GMRAGUI1",79,0)
 L -^GMR(120.86,0) L +^GMR(120.86,DFN,0):5 I '$T S ORY="-1^Unable to update assessment - try again." Q
"RTN","GMRAGUI1",80,0)
 S DIE="^GMR(120.86,",DA=DFN,DR="1////0;2////"_DUZ_";3///NOW" D ^DIE
"RTN","GMRAGUI1",81,0)
 S ORY=0
"RTN","GMRAGUI1",82,0)
 L -^XTMP("GMRAED",DFN)
"RTN","GMRAGUI1",83,0)
 Q
"RTN","GMRAGUI1",84,0)
 ;
"RTN","GMRAGUI1",85,0)
UPDATE(GMRAIEN,DFN,GMRARRAY) ;Add/edit allergies
"RTN","GMRAGUI1",86,0)
 N NEW,NKA,FDA,NODE,IEN,SUB,FILE,DA,DIK,SIEN,GMRAS0,GMRAIEN,GMRAL,GMRAPA,GMRAAR,GMRALL,GMRADFN,GMRAOUT,GMRAROT
"RTN","GMRAGUI1",87,0)
 S NEW='$G(GMRAIEN)
"RTN","GMRAGUI1",88,0)
 I NEW,$$DUPCHK^GMRAOR0(DFN,$P(@GMRARRAY@("GMRAGNT"),U))=1 S ORY="-1^Patient already has a "_$P(@GMRARRAY@("GMRAGNT"),U)_" reaction entered.  No duplicates allowed." Q
"RTN","GMRAGUI1",89,0)
 L +^XTMP("GMRAED",DFN):1 I '$T D MESS Q
"RTN","GMRAGUI1",90,0)
 D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRAGUI1",91,0)
 S NKA='$$NKA^GMRANKA(DFN) ;is patient NKA?
"RTN","GMRAGUI1",92,0)
 I NKA,NEW D
"RTN","GMRAGUI1",93,0)
 .S FDA(120.86,"?+"_DFN_",",.01)=DFN
"RTN","GMRAGUI1",94,0)
 .S FDA(120.86,"?+"_DFN_",",1)=1
"RTN","GMRAGUI1",95,0)
 .S FDA(120.86,"?+"_DFN_",",2)=DUZ
"RTN","GMRAGUI1",96,0)
 .S FDA(120.86,"?+"_DFN_",",3)=$G(@GMRARRAY@("GMRAORDT"),$$NOW^XLFDT)
"RTN","GMRAGUI1",97,0)
 .S IEN(DFN)=DFN
"RTN","GMRAGUI1",98,0)
 .D UPDATE^DIE("","FDA","IEN")
"RTN","GMRAGUI1",99,0)
 K FDA,IEN
"RTN","GMRAGUI1",100,0)
 S NODE=$S($G(NEW):"+1,",1:(GMRAIEN_","))
"RTN","GMRAGUI1",101,0)
 S:$G(NEW) FDA(120.8,NODE,.01)=DFN
"RTN","GMRAGUI1",102,0)
 I $P($G(@GMRARRAY@("GMRAGNT")),U,2)["50.67" S $P(@GMRARRAY@("GMRAGNT"),U,2)=$$TGTOG^PSNAPIS($P(@GMRARRAY@("GMRAGNT"),U))_";PSNDF(50.6,"
"RTN","GMRAGUI1",103,0)
 F SUB="GMRAGNT;.02","GMRATYPE;3.1","GMRANATR;17","GMRAORIG;5","GMRAORDT;4","GMRAOBHX;6" D
"RTN","GMRAGUI1",104,0)
 .S FDA(120.8,NODE,$P(SUB,";",2))=$P(@GMRARRAY@($P(SUB,";")),U)
"RTN","GMRAGUI1",105,0)
 .I (SUB["GMRAGNT"),NEW S FDA(120.8,NODE,1)=$P(@GMRARRAY@($P(SUB,";")),U,2)
"RTN","GMRAGUI1",106,0)
 D UPDATE^DIE("","FDA","IEN")
"RTN","GMRAGUI1",107,0)
 S:NEW GMRAIEN=IEN(1)
"RTN","GMRAGUI1",108,0)
 K FDA
"RTN","GMRAGUI1",109,0)
 F SUB="GMRACHT","GMRAIDBN" D
"RTN","GMRAGUI1",110,0)
 .Q:'$D(@GMRARRAY@(SUB))  ;Stop if no updates
"RTN","GMRAGUI1",111,0)
 .S FILE=$S(SUB="GMRACHT":120.813,1:120.814)
"RTN","GMRAGUI1",112,0)
 .S FDA(FILE,"+1,"_GMRAIEN_",",.01)=@GMRARRAY@(SUB,1)
"RTN","GMRAGUI1",113,0)
 .S FDA(FILE,"+1,"_GMRAIEN_",",1)=DUZ
"RTN","GMRAGUI1",114,0)
 .D UPDATE^DIE("","FDA")
"RTN","GMRAGUI1",115,0)
 I $D(@GMRARRAY@("GMRACMTS")) D ADCOM(GMRAIEN,"O",$NA(@GMRARRAY@("GMRACMTS"))) ;Add comments if included
"RTN","GMRAGUI1",116,0)
 K FDA
"RTN","GMRAGUI1",117,0)
 S SUB=0 F  S SUB=$O(@GMRARRAY@("GMRASYMP",SUB)) Q:'+SUB  D
"RTN","GMRAGUI1",118,0)
 .S GMRAS0=^(SUB) ;Naked from above
"RTN","GMRAGUI1",119,0)
 .Q:$P(^(SUB),U)=""  ;25 No text or free text entered so don't store
"RTN","GMRAGUI1",120,0)
 .S SIEN=$O(^GMR(120.8,GMRAIEN,10,"B",$P(GMRAS0,U),0))
"RTN","GMRAGUI1",121,0)
 .I SIEN,$P(^GMR(120.8,GMRAIEN,10,SIEN,0),U,4)=$P(GMRAS0,U,3) Q  ;Exists and nothing has changed
"RTN","GMRAGUI1",122,0)
 .I SIEN,$P(GMRAS0,U,5)="@" S DIK="^GMR(120.8,"_GMRAIEN_",",DA(1)=GMRAIEN,DA=SIEN D ^DIK Q  ;Sign/symptom deleted
"RTN","GMRAGUI1",123,0)
 .S:'SIEN FDA(120.81,"+1,"_GMRAIEN_",",.01)=$S($P(GMRAS0,U)="FT":$O(^GMRD(120.83,"B","OTHER REACTION",0)),1:$P(GMRAS0,U))
"RTN","GMRAGUI1",124,0)
 .S NODE=$S(SIEN:SIEN_","_GMRAIEN,1:"+1,"_GMRAIEN_",")
"RTN","GMRAGUI1",125,0)
 .S:$P(GMRAS0,U)="FT" FDA(120.81,NODE,1)=$P(GMRAS0,U,2)
"RTN","GMRAGUI1",126,0)
 .S FDA(120.81,NODE,2)=DUZ
"RTN","GMRAGUI1",127,0)
 .S FDA(120.81,NODE,3)=$P(GMRAS0,U,3)
"RTN","GMRAGUI1",128,0)
 .D UPDATE^DIE("","FDA","","ERR")
"RTN","GMRAGUI1",129,0)
 .S GMRAROT($P(GMRAS0,U,2))="" ;21 record s/s added
"RTN","GMRAGUI1",130,0)
 I NEW D
"RTN","GMRAGUI1",131,0)
 .S GMRALL(GMRAIEN)="" D VAD^GMRAUTL1(DFN,,.GMRALOC,.GMRANAM) D EN7^GMRAMCB ;Send mark chart/ID band bulletin if needed.
"RTN","GMRAGUI1",132,0)
 .I $P(@GMRARRAY@("GMRAOBHX"),U)="o" D  ;if observed reaction add data to 120.85
"RTN","GMRAGUI1",133,0)
 ..S GMRAOUT=0 ;21
"RTN","GMRAGUI1",134,0)
 ..S GMRAL(GMRAIEN,"O",GMRAIEN)=$G(@GMRARRAY@("GMRARDT"))_"^"_$G(@GMRARRAY@("GMRASEVR"))
"RTN","GMRAGUI1",135,0)
 ..S GMRADFN=DFN
"RTN","GMRAGUI1",136,0)
 ..S GMRAL(GMRAIEN)="^^"_$P($G(@GMRARRAY@("GMRAGNT")),U)_"^^^^"_$G(@GMRARRAY@("GMRAORIG"))
"RTN","GMRAGUI1",137,0)
 ..M GMRAL(GMRAIEN,"S")=@GMRARRAY@("GMRASYMP")
"RTN","GMRAGUI1",138,0)
 ..S SUB=0 F  S SUB=$O(GMRAL(GMRAIEN,"S",SUB)) Q:'+SUB  S $P(GMRAL(GMRAIEN,"S",SUB),U,2)=$P(GMRAL(GMRAIEN,"S",SUB),U,2)_"^" S:$P(GMRAL(GMRAIEN,"S",SUB),U)="FT" $P(GMRAL(GMRAIEN,"S",SUB),U)=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAGUI1",139,0)
 ..S GMRAL=GMRAIEN
"RTN","GMRAGUI1",140,0)
 ..D ADVERSE^GMRAOR7(GMRAIEN,.GMRAL) ;adds entry to 120.85
"RTN","GMRAGUI1",141,0)
 ..S GMRAIEN(GMRAIEN)="" ;21
"RTN","GMRAGUI1",142,0)
 ..D EN1^GMRAPET0(GMRADFN,.GMRAIEN,"S",.GMRAOUT) ;21 File progress note
"RTN","GMRAGUI1",143,0)
 ..I $G(@GMRARRAY@("GMRATYPE"))["D" S GMRAPA=GMRAIEN D EN1^GMRAPTB ;21 Send med-watch update
"RTN","GMRAGUI1",144,0)
 .S GMRAAR=$P($G(@GMRARRAY@("GMRAGNT")),U,2),GMRAPA=GMRAIEN
"RTN","GMRAGUI1",145,0)
 .D EN1^GMRAOR9 S ^TMP($J,"GMRASF",1,GMRAPA)="" D RANGE^GMRASIGN(1) ;add ingredients/classes send appropriate bulletins
"RTN","GMRAGUI1",146,0)
 S ORY=0
"RTN","GMRAGUI1",147,0)
 L -^XTMP("GMRAED",DFN)
"RTN","GMRAGUI1",148,0)
 Q
"RTN","GMRAGUI1",149,0)
 ;
"RTN","GMRAGUI1",150,0)
MESS ;Give out locked message
"RTN","GMRAGUI1",151,0)
 N GMRAXBOS,GMRAL1,GMRAL2
"RTN","GMRAGUI1",152,0)
 S GMRAXBOS=$$BROKER^XWBLIB ;In GUI?
"RTN","GMRAGUI1",153,0)
 S GMRAL1="Another user is editing this patient's allergy information."
"RTN","GMRAGUI1",154,0)
 S GMRAL2="Please refresh/review the patient's information before proceeding."
"RTN","GMRAGUI1",155,0)
 I 'GMRAXBOS W !,GMRAL1,!,GMRAL2 D WAIT^GMRAFX3 Q
"RTN","GMRAGUI1",156,0)
 S ORY="-1^"_GMRAL1_"  "_GMRAL2
"RTN","GMRAGUI1",157,0)
 Q
"RTN","GMRAMCB")
0^10^B10933598^B10298543
"RTN","GMRAMCB",1,0)
GMRAMCB ;HIRMFO/WAA-MARK CHART & ID BAND FIELD EDIT ;9/22/06  12:52
"RTN","GMRAMCB",2,0)
 ;;4.0;Adverse Reaction Tracking;**21,36**;Mar 29, 1996;Build 9
"RTN","GMRAMCB",3,0)
EN3 ;Entry for EDIT CHART & ID BAND option
"RTN","GMRAMCB",4,0)
 K GMRALL S GMRAOUT=0 D GETAL^GMRAMCB1 I GMRAOUT!'$D(GMRALL) L:DFN>0 -^GMR(120.8,"B",DFN) G Q3
"RTN","GMRAMCB",5,0)
 D EN5 D:'GMRAOUT EN7
"RTN","GMRAMCB",6,0)
 L -^GMR(120.8,"B",DFN)
"RTN","GMRAMCB",7,0)
 G Q3
"RTN","GMRAMCB",8,0)
EN4(GMRALL,DFN) ;THIS IS THE ENTRY POINT IF YOU KNOW THE ALLERGIES AND PATIENT
"RTN","GMRAMCB",9,0)
 D EN5 D:'GMRAOUT EN7 Q
"RTN","GMRAMCB",10,0)
EN5 ;THIS IS THE ENTRY POINT TO BY PASS THE FORMAL LIST AGAIN
"RTN","GMRAMCB",11,0)
 D VAD^GMRAUTL1(DFN,"",.GMRALOC,.GMRANAM,"",.GMRASSN)
"RTN","GMRAMCB",12,0)
 N REQ S REQ=0,GMRAPA=0 F  S GMRAPA=$O(GMRALL(GMRAPA)) Q:'+GMRAPA!(REQ)  S:'$O(^GMR(120.8,GMRAPA,14,0)) REQ=1 ;36
"RTN","GMRAMCB",13,0)
 S GMRATYPE="B",I=0,GMRAPA=0 W !,"This session you have CHOSEN:" F  S GMRAPA=$O(GMRALL(GMRAPA)) Q:GMRAPA<1  S I=I+1 W !,?5,$P($G(^GMR(120.8,GMRAPA,0)),U,2)
"RTN","GMRAMCB",14,0)
 W ! D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0)),GMRAOUT=0
"RTN","GMRAMCB",15,0)
 F GMRAMARK="13^Chart(s)","14^ID Band" S GMRAM2=$P(GMRAMARK,"^",2),GMRAM1=$P(GMRAMARK,"^") D  Q:GMRAOUT
"RTN","GMRAMCB",16,0)
 .I GMRAM1=14,($P(GMRASITE(0),U,5)=0!(GMRALOC=""))!('REQ) Q  ;36
"RTN","GMRAMCB",17,0)
 .S GMRANULL=0 F  S %=0 D  I %!(%Y="") Q
"RTN","GMRAMCB",18,0)
 ..I GMRAM1=13 S %=1,%Y="Y" Q  ;21 Marked on chart set to YES automatically
"RTN","GMRAMCB",19,0)
 ..W !,$S(GMRAM1=14:"Has",1:"Have")," the "_GMRAM2_" been marked for",$S(I>1:" these CAUSATIVE AGENTS",1:" this CAUSATIVE AGENT") D YN^DICN
"RTN","GMRAMCB",20,0)
 ..Q:%Y=""
"RTN","GMRAMCB",21,0)
 ..S:%<0 %=2,GMRAOUT=1 Q:%  W !?4,"ANSWER YES IF THE "_GMRAM2_" HAS BEEN MARKED, ELSE ANSWER NO."
"RTN","GMRAMCB",22,0)
 ..Q
"RTN","GMRAMCB",23,0)
 .I %=2!(%Y="") Q
"RTN","GMRAMCB",24,0)
 .S GMRAPA=0 F  S GMRAPA=$O(GMRALL(GMRAPA)) Q:GMRAPA<1  D
"RTN","GMRAMCB",25,0)
 ..I '$D(^GMR(120.8,GMRAPA,GMRAM1,0)) S ^(0)="^120.8"_GMRAM1_"DA^^"
"RTN","GMRAMCB",26,0)
 ..D NOW^%DTC K DO,DD,DINUM S X=%,DIC="^GMR(120.8,"_GMRAPA_","_GMRAM1_",",DIC(0)="L",DLAYGO=120.8,DA(1)=GMRAPA,DIC("DR")="1////"_DUZ D FILE^DICN K DIC,DLAYGO
"RTN","GMRAMCB",27,0)
 ..Q
"RTN","GMRAMCB",28,0)
 .Q
"RTN","GMRAMCB",29,0)
 Q
"RTN","GMRAMCB",30,0)
EN6(GMRALL,DFN,GMRATYPE) ;THIS IS THE ENTRY POINT IF YOU KNOW THE ALLERGIES AND PATIENT
"RTN","GMRAMCB",31,0)
 N GMRAOUT,%,%Y S GMRAOUT=0
"RTN","GMRAMCB",32,0)
 D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRAMCB",33,0)
EN7 I $D(%Y),%Y="" Q
"RTN","GMRAMCB",34,0)
 S GMRAPA=0 F  S GMRAPA=$O(GMRALL(GMRAPA)) Q:GMRAPA<1  D
"RTN","GMRAMCB",35,0)
 .I $O(^GMR(120.8,GMRAPA,13,0))&($P(GMRASITE(0),U,5)=0!$O(^GMR(120.8,GMRAPA,14,0))!(GMRALOC="")) Q
"RTN","GMRAMCB",36,0)
 .S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) D BULLT^GMRASEND
"RTN","GMRAMCB",37,0)
 .Q
"RTN","GMRAMCB",38,0)
 Q
"RTN","GMRAMCB",39,0)
Q3 ; CLEAN UP AFTER EN3
"RTN","GMRAMCB",40,0)
 D KILL^XUSCLEAN
"RTN","GMRAMCB",41,0)
 Q
"RTN","GMRAMCB",42,0)
HELP ;THIS ROUTINE WILL LIST ALL THE SELECTED ALLERGIES AND ALL THE
"RTN","GMRAMCB",43,0)
 ;CURRENT SELECTED ALLERGIES
"RTN","GMRAMCB",44,0)
 S GMRAPA=0 I '$D(GMRALL) W !,"No CAUSATIVE AGENTS have been selected for this patient."
"RTN","GMRAMCB",45,0)
 E  W !,"You have selected the following CAUSATIVE AGENTS:",! S GMRAPA=0 F  S GMRAPA=$O(GMRALL(GMRAPA)) Q:GMRAPA<1  W !,?5,$P($G(^GMR(120.8,GMRAPA,0)),U,2)
"RTN","GMRAMCB",46,0)
 K GMRAPA
"RTN","GMRAMCB",47,0)
 D HANGT^GMRAPEH0
"RTN","GMRAMCB",48,0)
HLP1 ;LIST ALL ALLERGIES
"RTN","GMRAMCB",49,0)
 W !,"You may choose CAUSATIVE AGENTS from the following list for this patient:"
"RTN","GMRAMCB",50,0)
 N DIC
"RTN","GMRAMCB",51,0)
 I '$D(^GMR(120.8,"B",DFN)) W !?4,"There are no reactions on file for this patient." Q
"RTN","GMRAMCB",52,0)
 D HLP12085^GMRAU851(DFN,"'+$G(^GMR(120.8,+GMRAX,""ER""))")
"RTN","GMRAMCB",53,0)
 D HANGT^GMRAPEH0
"RTN","GMRAMCB",54,0)
 Q
"RTN","GMRANKA")
0^11^B12980471^B15425405
"RTN","GMRANKA",1,0)
GMRANKA ;HIRMFO/WAA-ALLERGY/ADVERSE REACTION PATIENT NKA DRIVE ;10/12/06  11:03
"RTN","GMRANKA",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,21,36**;Mar 29, 1996;Build 9
"RTN","GMRANKA",3,0)
NKA(DFN) ;See if patient has reaction on file
"RTN","GMRANKA",4,0)
 ;  Input Variables:
"RTN","GMRANKA",5,0)
 ;       DFN = Patient Internal Entry Number
"RTN","GMRANKA",6,0)
 ;
"RTN","GMRANKA",7,0)
 ;  Output Variables:
"RTN","GMRANKA",8,0)
 ;       GMA = 1 Patient has known reaction
"RTN","GMRANKA",9,0)
 ;             0 Patient has No known reaction
"RTN","GMRANKA",10,0)
 ;             Null Patient has never been asked about reaction
"RTN","GMRANKA",11,0)
 S GMA=""
"RTN","GMRANKA",12,0)
 S GMA=$P($G(^GMR(120.86,DFN,0)),U,2)
"RTN","GMRANKA",13,0)
 Q GMA
"RTN","GMRANKA",14,0)
 ;
"RTN","GMRANKA",15,0)
NKAASK(DFN,GMRAOUT) ; Ask a Patient if patient has any known allergens
"RTN","GMRANKA",16,0)
 ;  Input Variables
"RTN","GMRANKA",17,0)
 ;     DFN = Patient Internal entry number
"RTN","GMRANKA",18,0)
 ;  GMRAOUT = Up Caret or time out flag
"RTN","GMRANKA",19,0)
 ;
"RTN","GMRANKA",20,0)
 ;Ask if patient has allergies
"RTN","GMRANKA",21,0)
 N DIR,Y,DIROUT,DTOUT,DIRUT,DUOUT,GMAOLD
"RTN","GMRANKA",22,0)
 S GMAOLD=$P($G(^GMR(120.86,DFN,0)),U,2)
"RTN","GMRANKA",23,0)
 S DIR(0)="120.86,1^AO^I Y=0&'$$NKASCR^GMRANKA(DFN) D INFO^GMRANKA K X"
"RTN","GMRANKA",24,0)
 S DIR("A")="Does this patient have any known allergies or adverse reactions? "
"RTN","GMRANKA",25,0)
 S DIR("B")=$S($P($G(^GMR(120.86,DFN,0)),U,2)=1:"Yes",$P($G(^GMR(120.86,DFN,0)),U,2)=0:"No",1:"") K:DIR("B")="" DIR("B")
"RTN","GMRANKA",26,0)
 S DIR("?")=$S(GMAOLD=0:"You may also enter @ to delete a previous NKA assessment and return the patient to a 'not assessed' state.  Use this if the NKA assessment was previously incorrectly entered.",1:"") ;21
"RTN","GMRANKA",27,0)
 D ^DIR
"RTN","GMRANKA",28,0)
 I $G(X)="@" D:GMAOLD=0 CLN W:GMAOLD=0 !,"Assessment deleted." Q  ;21 Allow removal of NKA
"RTN","GMRANKA",29,0)
 I $D(DTOUT)!$D(DIROUT) S GMRAOUT=1 Q  ;36
"RTN","GMRANKA",30,0)
 I $D(DUOUT) S GMRAOUT=2 Q  ;36
"RTN","GMRANKA",31,0)
 ; User Hits return and doesn't answer question
"RTN","GMRANKA",32,0)
 I Y="",GMAOLD="" Q  ;36
"RTN","GMRANKA",33,0)
 I Y'="",GMAOLD'=Y D
"RTN","GMRANKA",34,0)
 . N DIE,DA,DR
"RTN","GMRANKA",35,0)
 . S DIE="^GMR(120.86,",DA=DFN,DR=$S(GMAOLD="":(".01////"_DFN_";"),1:"")_"1////"_Y_";2////"_DUZ_";3///NOW" ;36
"RTN","GMRANKA",36,0)
 . D ^DIE
"RTN","GMRANKA",37,0)
 . Q
"RTN","GMRANKA",38,0)
 Q
"RTN","GMRANKA",39,0)
CLN ; Clean out entries that have not been answered.
"RTN","GMRANKA",40,0)
 S DIK="^GMR(120.86,",DA=DFN D ^DIK K DIK,DA
"RTN","GMRANKA",41,0)
 ;W !?20,"Patient will still be listed as not being",!?20,"asked about Allergies/Adverse Reactions."
"RTN","GMRANKA",42,0)
 Q
"RTN","GMRANKA",43,0)
INFO ; Info string
"RTN","GMRANKA",44,0)
 N GMASTR
"RTN","GMRANKA",45,0)
 S GMASTR(1)="Currently this patient has Causative Agents on file."
"RTN","GMRANKA",46,0)
 S GMASTR(2)="You will have to answer YES to this question and then"
"RTN","GMRANKA",47,0)
 S GMASTR(3)="indicate that each of the Causative Agents are incorrect."
"RTN","GMRANKA",48,0)
 S GMASTR(4)="Then you will be reasked this question and will be able"
"RTN","GMRANKA",49,0)
 S GMASTR(5)="to enter NO."
"RTN","GMRANKA",50,0)
 D WRITE^GMRADSP8(1,0,$C(7))
"RTN","GMRANKA",51,0)
 D WRITE^GMRADSP8(1,10,.GMASTR)
"RTN","GMRANKA",52,0)
 Q
"RTN","GMRANKA",53,0)
NKASCR(DFN) ; Is Patient NKA (No Known Allergy)
"RTN","GMRANKA",54,0)
 ;   Input Variable:
"RTN","GMRANKA",55,0)
 ;        DFN = Patient DFN in Patient file
"RTN","GMRANKA",56,0)
 ;
"RTN","GMRANKA",57,0)
 ;  Output Variable:
"RTN","GMRANKA",58,0)
 ;        GMA = 1 Patient is True NKA
"RTN","GMRANKA",59,0)
 ;            = 0 Patient has a reaction in file 120.8
"RTN","GMRANKA",60,0)
 ;
"RTN","GMRANKA",61,0)
 ; This code will screen out Entered in Error entries
"RTN","GMRANKA",62,0)
 S GMA=1
"RTN","GMRANKA",63,0)
 N GMAX
"RTN","GMRANKA",64,0)
 S GMAX=0
"RTN","GMRANKA",65,0)
 F  S GMAX=$O(^GMR(120.8,"B",DFN,GMAX)) Q:GMAX<1  D  Q:'GMA
"RTN","GMRANKA",66,0)
 .I +$G(^GMR(120.8,GMAX,"ER")) Q
"RTN","GMRANKA",67,0)
 .S GMA=0
"RTN","GMRANKA",68,0)
 .Q
"RTN","GMRANKA",69,0)
 Q GMA
"RTN","GMRANKA",70,0)
 ;
"RTN","GMRANKA",71,0)
DELNKA ;Remove assessment of NKA for a selected patient
"RTN","GMRANKA",72,0)
 N Y,DFN,DIR,DIC
"RTN","GMRANKA",73,0)
 S DIC=120.86,DIC(0)="AEMQZ",DIC("A")="Select PATIENT NAME: " D ^DIC Q:Y=-1
"RTN","GMRANKA",74,0)
 S DFN=+Y
"RTN","GMRANKA",75,0)
 W !
"RTN","GMRANKA",76,0)
 I $$NKA^GMRANKA(DFN)'=0 W !,"This patient doesn't currently have an assessment of NKA." Q
"RTN","GMRANKA",77,0)
 S DIR(0)="Y",DIR("A")="Delete NKA assessment for patient "_$G(Y(0,0)),DIR("B")="NO"
"RTN","GMRANKA",78,0)
 S DIR("?")="Enter Y to delete the NKA assessment and return the patient to a 'not assessed' status.  Enter N to cancel this action."
"RTN","GMRANKA",79,0)
 D ^DIR
"RTN","GMRANKA",80,0)
 I Y=1 D CLN^GMRANKA W "...Done"
"RTN","GMRANKA",81,0)
 Q
"RTN","GMRAPEM0")
0^9^B43826251^B44377298
"RTN","GMRAPEM0",1,0)
GMRAPEM0 ;HIRMFO/WAA,FT-ALLERGY/ADVERSE REACTION PATIENT EDIT DRIVER ;9/22/06  09:35
"RTN","GMRAPEM0",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,5,17,21,36**;Mar 29, 1996;Build 9
"RTN","GMRAPEM0",3,0)
EN11 ; Entry point for GMRA USER E/E PAT REC DATA option
"RTN","GMRAPEM0",4,0)
 ; GMRAUSER is a flag that indicates that this is a User
"RTN","GMRAPEM0",5,0)
 ; If user has Verifier Key then user will act normal
"RTN","GMRAPEM0",6,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) S GMRAUSER=1
"RTN","GMRAPEM0",7,0)
EN1 ; Entry for ENTER/EDIT PATIENT REACTION DATA option
"RTN","GMRAPEM0",8,0)
 ; EDIT PATIENT A/AR (DFN UNK.)
"RTN","GMRAPEM0",9,0)
 S GMRAOUT=0
"RTN","GMRAPEM0",10,0)
 W @IOF D PAT^GMRAPAT ; Select A Patient
"RTN","GMRAPEM0",11,0)
 D:'GMRAOUT EN21 G:'GMRAOUT EN1
"RTN","GMRAPEM0",12,0)
 K DFN,DIC,GMRAOUT,GMRARET,GMA,GMRAUSER
"RTN","GMRAPEM0",13,0)
 D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",14,0)
 Q
"RTN","GMRAPEM0",15,0)
EN21 ; Process patient data and determine if patient is NKA
"RTN","GMRAPEM0",16,0)
 S GMRAOUT=$G(GMRAOUT,0)
"RTN","GMRAPEM0",17,0)
 ; check patient assessment before enter/edit reaction
"RTN","GMRAPEM0",18,0)
 I $$NKA^GMRANKA(DFN),$$NKASCR^GMRANKA(DFN) D  ;delete 120.86 entry if assessment=yes, but no active reactions in 120.8
"RTN","GMRAPEM0",19,0)
 .N DA,DIK
"RTN","GMRAPEM0",20,0)
 .S DIK="^GMR(120.86,",DA=DFN D ^DIK
"RTN","GMRAPEM0",21,0)
 .Q
"RTN","GMRAPEM0",22,0)
 I '$$NKA^GMRANKA(DFN) D NKAASK^GMRANKA(DFN,.GMRAOUT) Q:GMRAOUT  I '$$NKA^GMRANKA(DFN) Q
"RTN","GMRAPEM0",23,0)
 L +^XTMP("GMRAED",DFN):1 I '$T D MESS^GMRAGUI1 Q  ;21
"RTN","GMRAPEM0",24,0)
 S GMRAOUT=0
"RTN","GMRAPEM0",25,0)
 D:'GMRAOUT SELECT
"RTN","GMRAPEM0",26,0)
 I $G(GMRAPA)'>0 S GMRAOUT=0
"RTN","GMRAPEM0",27,0)
 S GMRARP=1 I 'GMRAOUT D
"RTN","GMRAPEM0",28,0)
 .D ASK^GMRAUTL("Enter another Causative Agent? ",.GMRAOUT,.GMRARP)
"RTN","GMRAPEM0",29,0)
 .I 'GMRARP S GMRACNT=$O(^TMP($J,"GMRASF","B"),-1) D
"RTN","GMRAPEM0",30,0)
 ..I GMRACNT D SIGNOFF^GMRASIGN
"RTN","GMRAPEM0",31,0)
 ..I 'GMRAOUT D IDBAND^GMRASIGN
"RTN","GMRAPEM0",32,0)
 ..I GMRAOUT S GMRAOUT=2-GMRAOUT D:GMRAOUT&($D(^TMP($J,"GMRASF"))) ALERT^GMRASIGN K ^TMP($J,"GMRASF"),GMRACNT
"RTN","GMRAPEM0",33,0)
 ..Q
"RTN","GMRAPEM0",34,0)
 .Q
"RTN","GMRAPEM0",35,0)
 I GMRARP,'GMRAOUT K GMRARP L -^XTMP("GMRAED",DFN) G EN21 ;21
"RTN","GMRAPEM0",36,0)
 K GMRARP
"RTN","GMRAPEM0",37,0)
 ; check patient assessment when exiting enter/edit reaction
"RTN","GMRAPEM0",38,0)
 I $$NKA^GMRANKA(DFN),$$NKASCR^GMRANKA(DFN) D  ;delete 120.86 entry if assessment=yes, but no active reactions in 120.8
"RTN","GMRAPEM0",39,0)
 .N DA,DIK
"RTN","GMRAPEM0",40,0)
 .S DIK="^GMR(120.86,",DA=DFN D ^DIK
"RTN","GMRAPEM0",41,0)
 .Q
"RTN","GMRAPEM0",42,0)
 L -^XTMP("GMRAED",DFN) ;21
"RTN","GMRAPEM0",43,0)
 Q
"RTN","GMRAPEM0",44,0)
EN2 ; EDIT PATIENT A/AR (DFN KNOWN)
"RTN","GMRAPEM0",45,0)
 ; Called from the GMRAOR ALLERGY ENTER/EDIT protocol
"RTN","GMRAPEM0",46,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) S GMRAUSER=1
"RTN","GMRAPEM0",47,0)
 N GMRAOUT
"RTN","GMRAPEM0",48,0)
 D EN21 D
"RTN","GMRAPEM0",49,0)
 .;N GMRAOUT
"RTN","GMRAPEM0",50,0)
 .D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",51,0)
 .Q
"RTN","GMRAPEM0",52,0)
 K GMA,GMRARET,GMRAUSER
"RTN","GMRAPEM0",53,0)
 Q
"RTN","GMRAPEM0",54,0)
ALERT ; PROCESS ALERTS FOR ART
"RTN","GMRAPEM0",55,0)
 N DFN,GMRAPA,GMRACNT,GMRAOUT,GMRANEW,GMRAUSER
"RTN","GMRAPEM0",56,0)
 S (GMRACNT,GMRAOUT,GMRANEW)=0 D
"RTN","GMRAPEM0",57,0)
 .  I $G(XQADATA)="" S XQAKILL=0 Q
"RTN","GMRAPEM0",58,0)
 .  S DFN=$P(XQADATA,U),GMRAPA=$P(XQADATA,U,2),GMRAUSER=$P(XQADATA,U,3) Q:'DFN!'GMRAPA
"RTN","GMRAPEM0",59,0)
 .  I $D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) K GMRAUSER
"RTN","GMRAPEM0",60,0)
 .  S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAPEM0",61,0)
 .  I $P(GMRAPA(0),U,12) D  Q
"RTN","GMRAPEM0",62,0)
 .  .  W !,"This reaction has been signed off.",$C(7)
"RTN","GMRAPEM0",63,0)
 .  .  D HANGT^GMRAPEH0
"RTN","GMRAPEM0",64,0)
 .  .  S XQAKILL=0
"RTN","GMRAPEM0",65,0)
 .  .  Q
"RTN","GMRAPEM0",66,0)
 .  D EDIT^GMRAPEM4
"RTN","GMRAPEM0",67,0)
 .  D UPDATE^GMRAPEM3
"RTN","GMRAPEM0",68,0)
 .  I '$P(GMRAPA(0),U,12) D SIGNOFF^GMRASIGN
"RTN","GMRAPEM0",69,0)
 .  I GMRAOUT S GMRAOUT=2-GMRAOUT K XQAKILL
"RTN","GMRAPEM0",70,0)
 .  E  D
"RTN","GMRAPEM0",71,0)
 .  .I $P(GMRAPA(0),U,12) S XQAKILL=0
"RTN","GMRAPEM0",72,0)
 .  .I '$P(GMRAPA(0),U,12) K XQAKILL
"RTN","GMRAPEM0",73,0)
 .  D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",74,0)
 .  Q
"RTN","GMRAPEM0",75,0)
 Q
"RTN","GMRAPEM0",76,0)
SELECT ;Select a patient reaction
"RTN","GMRAPEM0",77,0)
 S GMRACNT=0 D 1^VADPT
"RTN","GMRAPEM0",78,0)
 S GMRALOC=$P(VAIN(4),U,2),GMRANAM=VADM(1),GMRASEX=VADM(5),GMRAOUT=0,GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0)) D KVAR^VADPT K VA,VAROOT
"RTN","GMRAPEM0",79,0)
 K GMRADUP S GMRALAGO=1
"RTN","GMRAPEM0",80,0)
 D REACT^GMRAPAT(DFN) ; Load all reaction for this patient.
"RTN","GMRAPEM0",81,0)
 D EN1^GMRAPES0
"RTN","GMRAPEM0",82,0)
 I GMRAPA>0 D TYPE D
"RTN","GMRAPEM0",83,0)
 .I GMRAOUT D:$G(GMRANEW) DELETE S:'$$MISSREQ&('$P($G(GMRAPA(0)),U,12)) GMRAOUT=0,^TMP($J,"GMRASF","B",GMRAPA,GMRACNT)="",^TMP($J,"GMRASF",GMRACNT,GMRAPA)="" D:GMRAOUT UPOUT^GMRAPEM3 Q  ; 21,36
"RTN","GMRAPEM0",84,0)
 .I GMRAERR D ERR^GMRAPEM3 Q  ;The reaction was entered in error
"RTN","GMRAPEM0",85,0)
 .I $P(GMRAPA(0),U,12) D SIGNED^GMRAPEM3 Q  ;The reaction has been signed
"RTN","GMRAPEM0",86,0)
 .; Reaction is a new reaction or Update data
"RTN","GMRAPEM0",87,0)
 .D UPDATE^GMRAPEM3
"RTN","GMRAPEM0",88,0)
 .Q
"RTN","GMRAPEM0",89,0)
 Q
"RTN","GMRAPEM0",90,0)
TYPE ; Select the type of the process to use this reaction
"RTN","GMRAPEM0",91,0)
 S GMRAERR=0
"RTN","GMRAPEM0",92,0)
 ; If reaction is not new check to see if user want to enter in error
"RTN","GMRAPEM0",93,0)
 I 'GMRANEW W @IOF N GMRADFN D EN1^GMRAPEE0 I GMRAERR!GMRAOUT Q
"RTN","GMRAPEM0",94,0)
 ;If reaction is observed and signed off
"RTN","GMRAPEM0",95,0)
 I $P(GMRAPA(0),U,6)="o",$P(GMRAPA(0),U,12) D  Q:GMRAOUT
"RTN","GMRAPEM0",96,0)
 .Q:$G(GMRAUSER,0)
"RTN","GMRAPEM0",97,0)
 .N GMRARP
"RTN","GMRAPEM0",98,0)
 .S GMRARP=0 D ASK^GMRAUTL("DO YOU WISH TO EDIT OBSERVED DATA? ",.GMRAOUT,.GMRARP) Q:GMRAOUT
"RTN","GMRAPEM0",99,0)
 .Q:'GMRARP  ;Observed data
"RTN","GMRAPEM0",100,0)
 .N GMRAOD S GMRAOD=$D(^GMR(120.85,"C",GMRAPA)) ;Existing observation data?
"RTN","GMRAPEM0",101,0)
OBSDATE .;
"RTN","GMRAPEM0",102,0)
 .S GMRALAGO=1 F  D EN2^GMRAU85 Q:GMRAPA1>0  Q:GMRAOUT  W !,"You must enter a valid date or an Up-arrow to exit",!,$C(7)
"RTN","GMRAPEM0",103,0)
 .I 'GMRAOUT,GMRAPA1>0  D EN2^GMRAROBS
"RTN","GMRAPEM0",104,0)
 .I '$D(^GMR(120.85,"C",GMRAPA)),$G(GMRANEW)!('$G(GMRANEW)&($G(GMRAOD))) D OBSPROB S GMRAOUT=0 G OBSDATE
"RTN","GMRAPEM0",105,0)
 .Q
"RTN","GMRAPEM0",106,0)
 ;Verify data
"RTN","GMRAPEM0",107,0)
 I 'GMRAERR,$P($G(^GMR(120.8,GMRAPA,0)),U,16)=0,$P(GMRAPA(0),U,12)=1,$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) D  Q:GMRAOUT
"RTN","GMRAPEM0",108,0)
 .K GMRAVER S GMRAVER=0
"RTN","GMRAPEM0",109,0)
 .N GMRAPRNT D EN1^GMRAVFY K GMRALLER,GMRAMEC,GMRAY
"RTN","GMRAPEM0",110,0)
 .I $P($G(^GMR(120.8,GMRAPA,0)),U,16)=1 S GMRASLL(GMRAPA)=1
"RTN","GMRAPEM0",111,0)
 .Q
"RTN","GMRAPEM0",112,0)
 ;EDIT Verified data
"RTN","GMRAPEM0",113,0)
 I 'GMRAERR,$P($G(^GMR(120.8,GMRAPA,0)),U,16)=1,$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) D  Q:GMRAOUT
"RTN","GMRAPEM0",114,0)
 .Q:$G(GMRAVER)=1
"RTN","GMRAPEM0",115,0)
 .N GMRARP
"RTN","GMRAPEM0",116,0)
 .S GMRARP=0
"RTN","GMRAPEM0",117,0)
 .D ASK^GMRAUTL("DO YOU WISH TO EDIT VERIFIED DATA? ",.GMRAOUT,.GMRARP) Q:GMRAOUT
"RTN","GMRAPEM0",118,0)
 .D:GMRARP SITE^GMRAUTL,EN1^GMRAPED0
"RTN","GMRAPEM0",119,0)
 .Q
"RTN","GMRAPEM0",120,0)
 ;if the reaction is new or not signed off
"RTN","GMRAPEM0",121,0)
 I '$P(GMRAPA(0),U,12) D
"RTN","GMRAPEM0",122,0)
 .D EDIT^GMRAPEM4
"RTN","GMRAPEM0",123,0)
 .I $P($G(^GMR(120.8,GMRAPA,0)),U,16) S GMRASLL(GMRAPA)=1
"RTN","GMRAPEM0",124,0)
 .Q
"RTN","GMRAPEM0",125,0)
 Q
"RTN","GMRAPEM0",126,0)
EXIT S GMRAPA=0 F  S GMRAPA=$O(^TMP($J,"GMRASF","B",GMRAPA)) Q:GMRAPA<1  D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAPEM0",127,0)
 K ^TMP($J,"GMRASF")
"RTN","GMRAPEM0",128,0)
 K ^TMP($J,"GMRALST")
"RTN","GMRAPEM0",129,0)
 Q
"RTN","GMRAPEM0",130,0)
 ;
"RTN","GMRAPEM0",131,0)
DELETE ;Delete entry if required information is not entered - section added in 17
"RTN","GMRAPEM0",132,0)
 N DA,DIK,GMRAPA1
"RTN","GMRAPEM0",133,0)
 W !!,"Entry process not completed, deleting entry...",!
"RTN","GMRAPEM0",134,0)
 S GMRAPA1=$O(^GMR(120.85,"C",GMRAPA,0))
"RTN","GMRAPEM0",135,0)
 I GMRAPA1,$G(^GMR(120.85,GMRAPA1,0))="" K ^GMR(120.85,"C",GMRAPA,GMRAPA1)
"RTN","GMRAPEM0",136,0)
 I GMRAPA1 S DIK="^GMR(120.85,",DA=GMRAPA1 D ^DIK D UNLOCK^GMRAUTL(120.85,GMRAPA1)
"RTN","GMRAPEM0",137,0)
 I GMRAPA S DIK="^GMR(120.8,",DA=GMRAPA D ^DIK D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAPEM0",138,0)
 Q
"RTN","GMRAPEM0",139,0)
 ;
"RTN","GMRAPEM0",140,0)
OBSPROB ;Display help information for missing observed date/time entry
"RTN","GMRAPEM0",141,0)
 W !!,"Observed reactions must have at least one observation entry.",!,"If this reaction is incorrect then enter a date and then proceed",!,"to mark it as entered in error.",!
"RTN","GMRAPEM0",142,0)
 Q
"RTN","GMRAPEM0",143,0)
 ;
"RTN","GMRAPEM0",144,0)
MISSREQ() ;Function determines if required data is missing
"RTN","GMRAPEM0",145,0)
 N GMRA0,TYPE
"RTN","GMRAPEM0",146,0)
 S GMRA0=$G(^GMR(120.8,+$G(GMRAPA),0)) I GMRA0="" Q 1  ;Entry not found
"RTN","GMRAPEM0",147,0)
 S TYPE=$P(GMRA0,U,6) ;Get observed/historical
"RTN","GMRAPEM0",148,0)
 I TYPE="" Q 1  ;Type not entered
"RTN","GMRAPEM0",149,0)
 I TYPE="h" Q 0  ;Historical has no requirements
"RTN","GMRAPEM0",150,0)
 I TYPE="o" I '$D(^GMR(120.85,"C",GMRAPA))!('$O(^GMR(120.85,+$O(^GMR(120.85,"C",GMRAPA,0)),2,0)))!('$$REQCOM) Q 1  ;Missing obs date/time or sign/symptom or required comment
"RTN","GMRAPEM0",151,0)
 Q 0
"RTN","GMRAPEM0",152,0)
 ;
"RTN","GMRAPEM0",153,0)
REQCOM() ;Function determines if comments required
"RTN","GMRAPEM0",154,0)
 I '$D(GMRASITE) D SITE^GMRAUTL
"RTN","GMRAPEM0",155,0)
 I +$P(^GMRD(120.84,+GMRASITE,0),U,4)=0 Q 1  ;Comments required?
"RTN","GMRAPEM0",156,0)
 I $O(^GMR(120.8,GMRAPA,26,0)) Q 1
"RTN","GMRAPEM0",157,0)
 Q 0
"RTN","GMRAPEM3")
0^1^B3076909^B2842314
"RTN","GMRAPEM3",1,0)
GMRAPEM3 ;HIRMFO/WAA-ALLERGY/ADVERSE REACTION PATIENT EDIT DRIVER ;3/20/06  14:55
"RTN","GMRAPEM3",2,0)
 ;;4.0;Adverse Reaction Tracking;**36**;Mar 29, 1996;Build 9
"RTN","GMRAPEM3",3,0)
UPOUT ; If the user uparrows out of the process
"RTN","GMRAPEM3",4,0)
 I GMRAOUT S GMRAOUT=2-GMRAOUT D:GMRAOUT&($D(^TMP($J,"GMRASF"))) ALERT^GMRASIGN K ^TMP($J,"GMRASF"),GMRACNT,GMRANAM,GMRAPA
"RTN","GMRAPEM3",5,0)
 K GMRANAM,GMRAPA
"RTN","GMRAPEM3",6,0)
 D CLEAN
"RTN","GMRAPEM3",7,0)
 Q
"RTN","GMRAPEM3",8,0)
ERR ; If the reaction that is entered in error
"RTN","GMRAPEM3",9,0)
 D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAPEM3",10,0)
 N GMRACNT Q:'$D(^TMP($J,"GMRASF","B",GMRAPA))
"RTN","GMRAPEM3",11,0)
 S GMRACNT=0 S GMRACNT=$O(^TMP($J,"GMRASF","B",GMRAPA,GMRACNT)) Q:GMRACNT<1
"RTN","GMRAPEM3",12,0)
 K ^TMP($J,"GMRASF",GMRACNT,GMRAPA),^TMP($J,"GMRASF","B",GMRAPA,GMRACNT)
"RTN","GMRAPEM3",13,0)
 D CLEAN
"RTN","GMRAPEM3",14,0)
 Q
"RTN","GMRAPEM3",15,0)
SIGNED ; If the reaction is already signed
"RTN","GMRAPEM3",16,0)
 D CLEAN
"RTN","GMRAPEM3",17,0)
 Q
"RTN","GMRAPEM3",18,0)
UPDATE ; Unlock global and prep for next allergy
"RTN","GMRAPEM3",19,0)
 I '$G(GMRAVER,0),'$D(^TMP($J,"GMRASF","B",GMRAPA)) S ^TMP($J,"GMRASF","B",GMRAPA,GMRACNT)=$G(GMRANEW),^TMP($J,"GMRASF",GMRACNT,GMRAPA)=$G(GMRANEW) ;36
"RTN","GMRAPEM3",20,0)
 D CLEAN
"RTN","GMRAPEM3",21,0)
 Q
"RTN","GMRAPEM3",22,0)
CLEAN ; Clean the account for the next reaction.
"RTN","GMRAPEM3",23,0)
 K %,DA,DIC,DIE,DIK,DR,GMRACHC,GMRAERR,GMRADRUG,GMRAIV,GMRANEW,GMRAOTH,GMRAPG,GMRAPRNT,GMRAREQ,GMRASEX,GMRASWH,GMRATYPE,GMRAVEDT,X,Y,GMRAVER
"RTN","GMRAPEM3",24,0)
 Q
"RTN","GMRASIG1")
0^5^B16149250^B15349456
"RTN","GMRASIG1",1,0)
GMRASIG1 ;HIRMFO/WAA-A/AR PATIENT SIGN OFF PART2 ;9/22/06  10:49
"RTN","GMRASIG1",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,17,21,36**;Mar 29, 1996;Build 9
"RTN","GMRASIG1",3,0)
PRINT ;Print out data to be signed off on
"RTN","GMRASIG1",4,0)
 N DIR,X,Y
"RTN","GMRASIG1",5,0)
 S GMRAPA=""
"RTN","GMRASIG1",6,0)
 I GMRASIGN W @IOF
"RTN","GMRASIG1",7,0)
 W !,"ADVERSE REACTION",!,"----------------" ;21
"RTN","GMRASIG1",8,0)
 S (GMRAI,GMRACNT)=0
"RTN","GMRASIG1",9,0)
 F  S GMRACNT=$O(^TMP($J,"GMRASF",GMRACNT)) Q:GMRACNT<1  S GMRAPA=$O(^TMP($J,"GMRASF",GMRACNT,0)) Q:GMRAPA<0  D  Q:GMRAOUT  I $Y>(IOSL-4) D PAGE Q:GMRAOUT
"RTN","GMRASIG1",10,0)
 .W ! W:GMRACNTT>1 GMRACNT,")" ;21
"RTN","GMRASIG1",11,0)
 .S GMRAG=^GMR(120.8,GMRAPA,0),GMRADRG=$S($P(GMRAG,U,20)="D":1,1:0)
"RTN","GMRASIG1",12,0)
 .W "  ",$P(GMRAG,U,2),! ;21
"RTN","GMRASIG1",13,0)
 .W !,?11,"Obs/Hist:",?21,$S($P(GMRAG,U,6)="o":"OBSERVED",$P(GMRAG,U,6)="h":"HISTORICAL",1:"") I $P(GMRAG,U,6)="o" W !,?12,"Obs d/t: ",$$FMTE^XLFDT($P(^GMR(120.85,$O(^GMR(120.85,"C",GMRAPA,0)),0),U)) ;21
"RTN","GMRASIG1",14,0)
 .K GMRAHEAD
"RTN","GMRASIG1",15,0)
 .K GMRAREC I $D(^GMR(120.8,GMRAPA,10,0)) D
"RTN","GMRASIG1",16,0)
 ..S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRASIG1",17,0)
 ..S GMRAREC=0 F  S GMRAREC=$O(^GMR(120.8,GMRAPA,10,GMRAREC)) Q:GMRAREC'>0  D  ;21
"RTN","GMRASIG1",18,0)
 ...S X=$G(^GMR(120.8,GMRAPA,10,GMRAREC,0)),GMRAREC(GMRAREC)=$S($P(X,U)'=GMRAOTH:$P($G(^GMRD(120.83,+$P(X,U),0)),U),1:$P(X,U,2)) ;21
"RTN","GMRASIG1",19,0)
 ...I $P(X,U,4)>0 S $P(GMRAREC(GMRAREC),U,2)=$$FMTE^XLFDT($P(X,U,4),2) ;21
"RTN","GMRASIG1",20,0)
 ...Q  ;21
"RTN","GMRASIG1",21,0)
 ..Q
"RTN","GMRASIG1",22,0)
 .I $D(GMRAREC)=11 S GMRAREC=$O(GMRAREC("")) W !,?5,"Signs/Symptoms: ",?21,$P(GMRAREC(GMRAREC),U) W:$P(GMRAREC(GMRAREC),U,2)'="" " ("_$P(GMRAREC(GMRAREC),U,2)_")" ;21
"RTN","GMRASIG1",23,0)
 .;W ?65,$S($P(GMRAG,U,6)="o":"OBSERVED",$P(GMRAG,U,6)="h":"HISTORICAL",1:"")
"RTN","GMRASIG1",24,0)
 .I $G(GMRAREC)>0 F  S GMRAREC=$O(GMRAREC(GMRAREC)) Q:GMRAREC<1  W !,?21,$P(GMRAREC(GMRAREC),U) W:$P(GMRAREC(GMRAREC),U,2)'="" " ("_$P(GMRAREC(GMRAREC),U,2)_")" I $Y>(IOSL-4) D PAGE Q:GMRAOUT  ;21
"RTN","GMRASIG1",25,0)
 .Q:GMRAOUT  D:$Y>(IOSL-4) PAGE Q:GMRAOUT  W !
"RTN","GMRASIG1",26,0)
 .D OUTPUT^GMRAPEM1 Q:GMRAOUT
"RTN","GMRASIG1",27,0)
 .Q
"RTN","GMRASIG1",28,0)
 Q:GMRACNTT'>1
"RTN","GMRASIG1",29,0)
 Q:'GMRASIGN
"RTN","GMRASIG1",30,0)
 W (GMRACNTT+1),")  All of the above",! ;17
"RTN","GMRASIG1",31,0)
 W (GMRACNTT+2),")  None of the above",! ;17
"RTN","GMRASIG1",32,0)
 Q
"RTN","GMRASIG1",33,0)
PAGE ;PAGE
"RTN","GMRASIG1",34,0)
 N DIR
"RTN","GMRASIG1",35,0)
 D ENDPG^GMRADSP3 Q:GMRAOUT
"RTN","GMRASIG1",36,0)
 W @IOF,!
"RTN","GMRASIG1",37,0)
 Q
"RTN","GMRASIG1",38,0)
PNOTE ; Generate a Progress Note for a patient
"RTN","GMRASIG1",39,0)
 Q:$G(GMRAUSER,0)
"RTN","GMRASIG1",40,0)
 N GMRAOUT S GMRAOUT=0
"RTN","GMRASIG1",41,0)
 I $D(GMRASLL) D
"RTN","GMRASIG1",42,0)
 .N GMRAFLL,X
"RTN","GMRASIG1",43,0)
 .S X=0 F  S X=$O(GMRASLL(X)) Q:X<1  D
"RTN","GMRASIG1",44,0)
 ..I GMRASLL(X) Q
"RTN","GMRASIG1",45,0)
 ..I $P($G(^GMR(120.8,X,0)),U,6)'="o" Q
"RTN","GMRASIG1",46,0)
 ..S GMRAFLL(X)=""
"RTN","GMRASIG1",47,0)
 ..Q
"RTN","GMRASIG1",48,0)
 .Q:'$D(GMRAFLL)
"RTN","GMRASIG1",49,0)
 .D EN1^GMRAPET0(DFN,.GMRAFLL,"S",.GMRAOUT)
"RTN","GMRASIG1",50,0)
 .Q
"RTN","GMRASIG1",51,0)
 Q
"RTN","GMRASIG1",52,0)
ENCNT ; Count how many entries where selected and set up Sort order
"RTN","GMRASIG1",53,0)
 N SUB ;36
"RTN","GMRASIG1",54,0)
 S (GMRACNTT,X)=0 K ^TMP($J,"GMRARE") ; Resort the entries
"RTN","GMRASIG1",55,0)
 F  S X=$O(^TMP($J,"GMRASF","B",X)) Q:X<1  D
"RTN","GMRASIG1",56,0)
 .S GMRACNTT=GMRACNTT+1
"RTN","GMRASIG1",57,0)
 .S SUB=$O(^TMP($J,"GMRASF","B",X,0)) ;36
"RTN","GMRASIG1",58,0)
 .S ^TMP($J,"GMRARE",GMRACNTT,X)=+$G(^TMP($J,"GMRASF","B",X,SUB)) ;36
"RTN","GMRASIG1",59,0)
 .S ^TMP($J,"GMRARE","B",X,GMRACNTT)=+$G(^TMP($J,"GMRASF","B",X,SUB)) ;36
"RTN","GMRASIG1",60,0)
 .Q
"RTN","GMRASIG1",61,0)
 K ^TMP($J,"GMRASF")
"RTN","GMRASIG1",62,0)
 M ^TMP($J,"GMRASF")=^TMP($J,"GMRARE")
"RTN","GMRASIG1",63,0)
 K ^TMP($J,"GMRARE")
"RTN","GMRASIG1",64,0)
 Q
"RTN","GMRASIG1",65,0)
YNSO ;Select sign off for a patient
"RTN","GMRASIG1",66,0)
 W @IOF,!,"Causative Agent Data edited this Session:"
"RTN","GMRASIG1",67,0)
 K X D PRINT ; Redisplay the reactions
"RTN","GMRASIG1",68,0)
 K DIR S DIR(0)="L^1:"_(GMRACNTT+2),GMRALL=GMRACNTT+1,GMRANON=GMRACNTT+2 ;17
"RTN","GMRASIG1",69,0)
 S DIR(0)=DIR(0)_"^I X[""."" W !,""DO NOT USE DECIMAL VALUES."",$C(7) K X Q"
"RTN","GMRASIG1",70,0)
 S DIR("A")="Select the Correct data "
"RTN","GMRASIG1",71,0)
 S DIR("?")="^D PRINT^GMRASIG1"
"RTN","GMRASIG1",72,0)
 D ^DIR K DIR
"RTN","GMRASIG1",73,0)
 I $D(DTOUT)!($D(DUOUT)) S Y=GMRANON_","
"RTN","GMRASIG1",74,0)
 I Y=(GMRALL_",") D ALLSNG^GMRASIGN ; User select all the reaction
"RTN","GMRASIG1",75,0)
 I Y=(GMRANON_",") S Y="" ; user select not of the reactions
"RTN","GMRASIG1",76,0)
 I $F(Y,","_GMRALL_",") W !,"INVALID SELECTION: You can only select ",GMRACNT+1,")  All by itself." G YNSO
"RTN","GMRASIG1",77,0)
 I $F(Y,","_GMRANON_",") W !,"INVALID SELECTION: You can only select ",GMRACNT+2,")  None by itself." G YNSO
"RTN","GMRASIG1",78,0)
 Q
"RTN","GMRASIGN")
0^4^B40714673^B37583197
"RTN","GMRASIGN",1,0)
GMRASIGN ;HIRMFO/WAA-ALLERGY/ADVERSE REACTION PATIENT SIGN OFF ;9/22/06  11:01
"RTN","GMRASIGN",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19,36**;Mar 29, 1996;Build 9
"RTN","GMRASIGN",3,0)
SIGNOFF ; The signoff code
"RTN","GMRASIGN",4,0)
 N GMRAOUT,GMRACNTT S GMRAOUT=0 ;19
"RTN","GMRASIGN",5,0)
 S GMRASIGN=0
"RTN","GMRASIGN",6,0)
 D ENCNT^GMRASIG1 ; Count entries
"RTN","GMRASIGN",7,0)
 D SOQ ; Display entries and ask if user wants all the entries signed.
"RTN","GMRASIGN",8,0)
 I 'Y D  ; User said no the sign off question
"RTN","GMRASIGN",9,0)
 .I GMRACNTT>1 S GMRASIGN=1 D YNSO^GMRASIG1 I Y'=0 D RANGE(Y) ; User had more than one entry
"RTN","GMRASIGN",10,0)
 .D ALERT ; Ask Delete and trigger alerts for those non delete entries 
"RTN","GMRASIGN",11,0)
 .Q
"RTN","GMRASIGN",12,0)
 K GMRASITE ; force the update of the site parameters
"RTN","GMRASIGN",13,0)
 D PNOTE^GMRASIG1 ; File progress note
"RTN","GMRASIGN",14,0)
 K ^TMP($J,"GMRASF") ; clean up the temp globals
"RTN","GMRASIGN",15,0)
 Q
"RTN","GMRASIGN",16,0)
SOQ ;Sign off on all allergies for a patient
"RTN","GMRASIGN",17,0)
 W @IOF,!,"Causative Agent Data edited this Session:"
"RTN","GMRASIGN",18,0)
 K X D PRINT^GMRASIG1 ; Display entries edit this session
"RTN","GMRASIGN",19,0)
 N DIR
"RTN","GMRASIGN",20,0)
 S DIR(0)="YA",DIR("B")="NO"
"RTN","GMRASIGN",21,0)
 S DIR("?")="PLEASE ENTER 'Y' IF THE DATA IS CORRECT OR 'N' IF IT IS NOT CORRECT"
"RTN","GMRASIGN",22,0)
 S DIR("??")="^D PRINT^GMRASIG1"
"RTN","GMRASIGN",23,0)
 S DIR("A")=$S(GMRACNTT>1:"Are ALL these",1:"Is this")_" correct? "
"RTN","GMRASIGN",24,0)
 D ^DIR
"RTN","GMRASIGN",25,0)
 I $D(DIRUT) S Y=0,GMRAOUT=1 ; user ^ or timed out
"RTN","GMRASIGN",26,0)
 I Y=0 Q  ; user answered no the sign off
"RTN","GMRASIGN",27,0)
 D ALLSNG,RANGE(Y) ; sign all the entries
"RTN","GMRASIGN",28,0)
 S Y=1
"RTN","GMRASIGN",29,0)
 Q
"RTN","GMRASIGN",30,0)
ALLSNG ;Sign off on all
"RTN","GMRASIGN",31,0)
 N X
"RTN","GMRASIGN",32,0)
 S Y="",X=0
"RTN","GMRASIGN",33,0)
 F  S X=$O(^TMP($J,"GMRASF",X)) Q:X<1  S Y=Y_X_","
"RTN","GMRASIGN",34,0)
 Q
"RTN","GMRASIGN",35,0)
RANGE(GMRARNG) ;Sign off select allergies
"RTN","GMRASIGN",36,0)
 ;Input:
"RTN","GMRASIGN",37,0)
 ;   GMRARNG = The entries that need to be signed
"RTN","GMRASIGN",38,0)
 ;
"RTN","GMRASIGN",39,0)
 N GMRATYPE ;19
"RTN","GMRASIGN",40,0)
 F I=1:1 S GMRACNT=$P(GMRARNG,",",I) Q:GMRACNT<1  S GMRAPA=$O(^TMP($J,"GMRASF",GMRACNT,0)) Q:GMRAPA'>0  D
"RTN","GMRASIGN",41,0)
 .N I,GMRARNG
"RTN","GMRASIGN",42,0)
 .S DA=GMRAPA,DIE="^GMR(120.8,",DR="15////1" D ^DIE
"RTN","GMRASIGN",43,0)
 .S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRASIGN",44,0)
 .S GMRATYPE=$P(GMRAPA(0),U,20)
"RTN","GMRASIGN",45,0)
 .S GMRASLL(GMRAPA)=0
"RTN","GMRASIGN",46,0)
 .I '$P(GMRAPA(0),U,16) D
"RTN","GMRASIGN",47,0)
 ..N GMRACNT K DR S DA=GMRAPA,DIE="^GMR(120.8,"
"RTN","GMRASIGN",48,0)
 ..I $$VFY(.GMRAPA) D
"RTN","GMRASIGN",49,0)
 ...S DR="19////1;20///N" D ^DIE
"RTN","GMRASIGN",50,0)
 ...Q
"RTN","GMRASIGN",51,0)
 ..E  S DR="19////0" D ^DIE,EN1^GMRAVAB
"RTN","GMRASIGN",52,0)
 ..S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRASIGN",53,0)
 .I $P(GMRAPA(0),U,6)="o",GMRATYPE["D" D PTBUL^GMRAROBS
"RTN","GMRASIGN",54,0)
 .D  ; Execute the event point for this reaction
"RTN","GMRASIGN",55,0)
 ..Q:'$D(GMRAPA)  S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRASIGN",56,0)
 ..N OROLD,DFN,GMRACNT S DFN=$P(GMRAPA(0),U)
"RTN","GMRASIGN",57,0)
 ..D INP^VADPT S X=$$FIND1^DIC(101,,"BX","GMRA SIGN-OFF ON DATA")_";ORD(101," D EN^XQOR:X K VAIN,X ;19
"RTN","GMRASIGN",58,0)
 ..Q
"RTN","GMRASIGN",59,0)
 .K ^TMP($J,"GMRASF",GMRACNT,GMRAPA),^TMP($J,"GMRASF","B",GMRAPA,GMRACNT)
"RTN","GMRASIGN",60,0)
 .Q
"RTN","GMRASIGN",61,0)
 Q
"RTN","GMRASIGN",62,0)
ALERT ; SENDS ALERT FOR ALL DATA THAT IS UNSIGNED
"RTN","GMRASIGN",63,0)
 I '$O(^TMP($J,"GMRASF",0)) Q
"RTN","GMRASIGN",64,0)
 D REMAIN ;D DEL^GMRADEL ; Ask user if they want to delete given entries
"RTN","GMRASIGN",65,0)
 Q:$D(XQADATA)  ; user is processing alert
"RTN","GMRASIGN",66,0)
 S (GMRACNT,GMRACNTF)=0 F  S GMRACNT=$O(^TMP($J,"GMRASF",GMRACNT)) Q:GMRACNT<1  S GMRAPA=$O(^TMP($J,"GMRASF",GMRACNT,0)) Q:GMRAPA<1  D
"RTN","GMRASIGN",67,0)
 .S GMRAPA(0)=(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRASIGN",68,0)
 .S XQA(DUZ)=""
"RTN","GMRASIGN",69,0)
 .S XQAMSG=GMRANAM_" with reaction of "_$P(GMRAPA(0),U,2)_" has not been Signed off."
"RTN","GMRASIGN",70,0)
 .S XQAID="GMASignoff Alert"
"RTN","GMRASIGN",71,0)
 .S XQADATA=DFN_U_GMRAPA_U_$G(GMRAUSER,0)
"RTN","GMRASIGN",72,0)
 .S XQAROU="ALERT^GMRAPEM0"
"RTN","GMRASIGN",73,0)
 .D SETUP^XQALERT
"RTN","GMRASIGN",74,0)
 .D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRASIGN",75,0)
 .I 'GMRACNTF W !,?5,"Please Note that these UNSIGNED Causative Agents ",!,?5,"will not show in the patient's records.",$C(7) D HANGT^GMRAPEH0 S GMRACNTF=1
"RTN","GMRASIGN",76,0)
 .S X=$O(^TMP($J,"GMRASF","B",GMRAPA,0))
"RTN","GMRASIGN",77,0)
 .K ^TMP($J,"GMRASF",X,GMRAPA),^TMP($J,"GMRASF","B",GMRAPA,X)
"RTN","GMRASIGN",78,0)
 .Q
"RTN","GMRASIGN",79,0)
 K XQA,XQAMSG,GMRACNTF
"RTN","GMRASIGN",80,0)
 Q
"RTN","GMRASIGN",81,0)
IDBAND ; Mark ID Bands and Charts for a given patient
"RTN","GMRASIGN",82,0)
 I $D(GMRASLL) D
"RTN","GMRASIGN",83,0)
 .D EN4^GMRAMCB(.GMRASLL,DFN) S GMRAPA=0 F  S GMRAPA=$O(GMRASLL(GMRAPA)) Q:GMRAPA<1  D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRASIGN",84,0)
 .K GMRASLL
"RTN","GMRASIGN",85,0)
 .Q
"RTN","GMRASIGN",86,0)
 Q
"RTN","GMRASIGN",87,0)
VFY(Y) ;THIS FUNCTION WILL RETURN TRUE IF THIS ALLERGY IS AUTO VERIFIED
"RTN","GMRASIGN",88,0)
 N GMRAPASS,X
"RTN","GMRASIGN",89,0)
 S GMRAPASS=0
"RTN","GMRASIGN",90,0)
 I '$D(GMRASITE) D SITE^GMRAUTL
"RTN","GMRASIGN",91,0)
 S X=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRASIGN",92,0)
 S GMRATYPE=$P(Y(0),U,20)
"RTN","GMRASIGN",93,0)
 I @(($P(Y(0),U,6)="o"&($P(X,U,3)\2)!($P(Y(0),U,6)="h"&($P(X,U,3)#2)))_$S($P(X,U,6)="&":"&",1:"!")_(GMRATYPE["F"&($P(X,U,2)\2#2)!(GMRATYPE["D"&($P(X,U,2)#2))!(GMRATYPE["O"&($P(X,U,2)\4)))) S GMRAPASS=1
"RTN","GMRASIGN",94,0)
 Q GMRAPASS
"RTN","GMRASIGN",95,0)
 Q
"RTN","GMRASIGN",96,0)
 ;
"RTN","GMRASIGN",97,0)
REMAIN ;Review remaining entries that were not signed off.  Entire section added with patch 17
"RTN","GMRASIGN",98,0)
 N GMRAPA,LCVJ,Y,DIR,DIRUT,DUOUT,SIGNED,GMRAOUT,GMRANEW,DIC,DONE
"RTN","GMRASIGN",99,0)
 S SIGNED=""
"RTN","GMRASIGN",100,0)
 S LCVJ=0 F  S LCVJ=$O(^TMP($J,"GMRASF",LCVJ)) Q:'+LCVJ  D
"RTN","GMRASIGN",101,0)
 .S GMRAPA=$O(^TMP($J,"GMRASF",LCVJ,0)) Q:'+GMRAPA  S GMRAPA(0)=^GMR(120.8,GMRAPA,0)
"RTN","GMRASIGN",102,0)
 .S DIR(0)="SB^Edit:Edit;Delete:Delete",DIR("B")="Edit" ;36
"RTN","GMRASIGN",103,0)
 .S DIR("?")="Select edit or delete" ;36
"RTN","GMRASIGN",104,0)
 .S DIR("?",1)="You must complete entry of this record.  Select edit to change" ;36
"RTN","GMRASIGN",105,0)
 .S DIR("?",2)="the record or delete to remove the record.  Previously existing" ;36
"RTN","GMRASIGN",106,0)
 .S DIR("?",3)="records will be marked as entered in error while records added" ;36
"RTN","GMRASIGN",107,0)
 .S DIR("?",4)="during this session will be deleted." ;36
"RTN","GMRASIGN",108,0)
 .S DIR("A")="For reactant "_$P(GMRAPA(0),U,2) D ^DIR K DIR S:$G(DIRUT) Y="E" ;36
"RTN","GMRASIGN",109,0)
 .I $E(Y)="D" Q  ;Do nothing if allergy is to be deleted
"RTN","GMRASIGN",110,0)
 .S GMRANEW=0
"RTN","GMRASIGN",111,0)
 .F  D  Q:DONE
"RTN","GMRASIGN",112,0)
 ..S DONE=0,GMRAOUT=0
"RTN","GMRASIGN",113,0)
 ..D EDIT^GMRAPEM4 W !
"RTN","GMRASIGN",114,0)
 ..I $P(^GMR(120.8,GMRAPA,0),U,6)="o" I '$D(^GMR(120.85,"C",GMRAPA))!('$O(^GMR(120.85,+$O(^GMR(120.85,"C",GMRAPA,0)),2,0)))!('$$REQCOM^GMRAPEM0) D  Q
"RTN","GMRASIGN",115,0)
 ...W !,"Observed reactions require the date of the reaction and",!,"sign/symptoms",$S('$$REQCOM^GMRAPEM0:" and comments.",1:"."),!
"RTN","GMRASIGN",116,0)
 ...S DIR(0)="SA^R:Re-edit;D:Delete",DIR("A")="Do you want to (R)e-edit or (D)elete this entry? ",DIR("B")="R" D ^DIR S:Y'="R" DONE=1 Q
"RTN","GMRASIGN",117,0)
 ..I $P(^GMR(120.8,GMRAPA,0),U,6)="h",$D(^GMR(120.85,"C",GMRAPA)) D DELOBS ;Delete observed data if changing to historical
"RTN","GMRASIGN",118,0)
 ..S DIR(0)="Y",DIR("A")="Is this entry now correct",DIR("B")="Y",DIR("?")="Answer yes to accept the allergy.  Enter NO to re-edit.  Enter ^ to delete this entry." D ^DIR
"RTN","GMRASIGN",119,0)
 ..I Y=0 Q
"RTN","GMRASIGN",120,0)
 ..I $G(DIRUT) S DONE=1 Q
"RTN","GMRASIGN",121,0)
 ..S SIGNED=SIGNED_LCVJ_",",DONE=1
"RTN","GMRASIGN",122,0)
 I $L(SIGNED)>1 D RANGE(SIGNED) ;Sign off on accepted allergies
"RTN","GMRASIGN",123,0)
 I $O(^TMP($J,"GMRASF",0)) D DELETE^GMRADEL ;Delete unaccepted entries
"RTN","GMRASIGN",124,0)
 Q
"RTN","GMRASIGN",125,0)
 ;
"RTN","GMRASIGN",126,0)
DELOBS ;Delete observed data from 120.85
"RTN","GMRASIGN",127,0)
 N OIEN,DIK,DA
"RTN","GMRASIGN",128,0)
 S OIEN=0 F  S OIEN=$O(^GMR(120.85,"C",GMRAPA,OIEN)) Q:'+OIEN  S DIK="^GMR(120.85,",DA=OIEN D ^DIK
"RTN","GMRASIGN",129,0)
 Q
"RTN","GMRAUTL2")
0^8^B79798893^B71296835
"RTN","GMRAUTL2",1,0)
GMRAUTL2 ;SLC/DAN New style index utilities, update utility for 120.8 ;1/3/07  08:02
"RTN","GMRAUTL2",2,0)
 ;;4.0;Adverse Reaction Tracking;**23,36**;Mar 29, 1996;Build 9
"RTN","GMRAUTL2",3,0)
 ;
"RTN","GMRAUTL2",4,0)
 N GMRAI,GMRAC,ENTRY,UPDATED
"RTN","GMRAUTL2",5,0)
 Q:$G(X1(1))=$G(X2(1))  ;Entry unchanged
"RTN","GMRAUTL2",6,0)
 S ENTRY=DA(1)_";GMRD(120.82,"_"^"_$P(^GMRD(120.82,DA(1),0),"^")
"RTN","GMRAUTL2",7,0)
 I $G(X1(1))>0,$G(X2(1))>0 S:$G(GMRAT)="ING" GMRAI("D",X1(1))="",GMRAI("A",X2(1))="" S:$G(GMRAT)="CLASS" GMRAC("D",X1(1))="",GMRAC("A",X2(1))="" ;Edited existing entry
"RTN","GMRAUTL2",8,0)
 I $G(X1(1))>0,$G(X2(1))="" S:$G(GMRAT)="ING" GMRAI("D",X1(1))="" S:$G(GMRAT)="CLASS" GMRAC("D",X1(1))="" ;Entry deleted
"RTN","GMRAUTL2",9,0)
 I $G(X1(1))="",$G(X2(1))>0 S:$G(GMRAT)="ING" GMRAI("A",X2(1))="" S:$G(GMRAT)="CLASS" GMRAC("A",X2(1))="" ;New entry
"RTN","GMRAUTL2",10,0)
 D QUP ;Queue updating of existing entries and order checking
"RTN","GMRAUTL2",11,0)
 Q
"RTN","GMRAUTL2",12,0)
 ;
"RTN","GMRAUTL2",13,0)
QUP ;Queue the update
"RTN","GMRAUTL2",14,0)
 S ZTRTN="UPDATE^GMRAUTL2(ENTRY,.GMRAI,.GMRAC)",ZTIO="GMRA UPDATE RESOURCE",ZTDTH=$H,ZTDESC="Update existing allergies",ZTSAVE("*")="" D ^%ZTLOAD Q
"RTN","GMRAUTL2",15,0)
 ;
"RTN","GMRAUTL2",16,0)
UPDATE(ENTRY,ING,CLASS) ;Update existing entries in 120.8 with new information.
"RTN","GMRAUTL2",17,0)
 ;Entry is IEN;File reference^Text of file entry - 6;GMRD(120.82,^STRAWBERRIES
"RTN","GMRAUTL2",18,0)
 ;ING - Array of ingredients - "A",IEN for those to be added and "D",IEN for those to be deleted
"RTN","GMRAUTL2",19,0)
 ;CLASS - Array of drug classes - "A",IEN for those to be added and "D",IEN for those to be deleted
"RTN","GMRAUTL2",20,0)
 ;
"RTN","GMRAUTL2",21,0)
 N ALLERGY,POINTER,ACTION,SUB,SUBI,SUBC,DFN,GMRAS,GMRACOM
"RTN","GMRAUTL2",22,0)
 S ALLERGY=$P(ENTRY,"^",2) Q:ALLERGY=""
"RTN","GMRAUTL2",23,0)
 S POINTER=$P(ENTRY,"^") Q:POINTER=""
"RTN","GMRAUTL2",24,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,"C",ALLERGY,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",25,0)
 .S DFN=$P(^GMR(120.8,SUB,0),U)
"RTN","GMRAUTL2",26,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",27,0)
 .Q:$P(^GMR(120.8,SUB,0),"^",3)'=POINTER  ;Same text name but not the same entry
"RTN","GMRAUTL2",28,0)
 .Q:$G(^GMR(120.8,SUB,"ER"))>0  ;Entered in error
"RTN","GMRAUTL2",29,0)
 .S GMRACOM=0
"RTN","GMRAUTL2",30,0)
 .F ACTION="A","D" D
"RTN","GMRAUTL2",31,0)
 ..S SUBI=0 F  S SUBI=$O(ING(ACTION,SUBI)) Q:'+SUBI  D
"RTN","GMRAUTL2",32,0)
 ...I ACTION="A" D ADD("I",SUB,SUBI,.GMRAS) I $G(GMRAS) S ING(ACTION,SUBI)=1,GMRACOM=1,UPDATED(DFN)=""
"RTN","GMRAUTL2",33,0)
 ...I ACTION="D" D DEL("I",SUB,SUBI,.GMRAS) I $G(GMRAS) S ING(ACTION,SUBI)=1,GMRACOM=1
"RTN","GMRAUTL2",34,0)
 ..S SUBC=0 F  S SUBC=$O(CLASS(ACTION,SUBC)) Q:'+SUBC  D
"RTN","GMRAUTL2",35,0)
 ...I ACTION="A" D ADD("C",SUB,SUBC,.GMRAS) I $G(GMRAS) S CLASS(ACTION,SUBC)=1,UPDATED(DFN)="",GMRACOM=1
"RTN","GMRAUTL2",36,0)
 ...I ACTION="D" D DEL("C",SUB,SUBC,.GMRAS) I $G(GMRAS) S GMRACOM=1,CLASS(ACTION,SUBC)=1
"RTN","GMRAUTL2",37,0)
 .I $G(GMRACOM) D ADDCOM
"RTN","GMRAUTL2",38,0)
 I $D(UPDATED) D CHKORD ;New order checks now?
"RTN","GMRAUTL2",39,0)
 Q
"RTN","GMRAUTL2",40,0)
 ;
"RTN","GMRAUTL2",41,0)
ADD(TYPE,ALENT,SUBENT,GMRAS) ;Adds entry to appropriate multiple
"RTN","GMRAUTL2",42,0)
 N FILE,FDA,EM
"RTN","GMRAUTL2",43,0)
 S GMRAS=1
"RTN","GMRAUTL2",44,0)
 I $D(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT)) S GMRAS=0 Q  ;Entry already exists
"RTN","GMRAUTL2",45,0)
 L +^GMR(120.8,ALENT)
"RTN","GMRAUTL2",46,0)
 S FILE=$S(TYPE="I":120.802,1:120.803)
"RTN","GMRAUTL2",47,0)
 S FDA(FILE,"+1,"_ALENT_",",.01)=SUBENT
"RTN","GMRAUTL2",48,0)
 D UPDATE^DIE("","FDA",,"EM")
"RTN","GMRAUTL2",49,0)
 L -^GMR(120.8,ALENT)
"RTN","GMRAUTL2",50,0)
 Q
"RTN","GMRAUTL2",51,0)
 ;
"RTN","GMRAUTL2",52,0)
DEL(TYPE,ALENT,SUBENT,GMRAS) ;Delete entry from multiple
"RTN","GMRAUTL2",53,0)
 N FILE,FDA,EM,ENTRY
"RTN","GMRAUTL2",54,0)
 S GMRAS=1
"RTN","GMRAUTL2",55,0)
 I '$D(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT)) S GMRAS=0 Q  ;No entry to delete
"RTN","GMRAUTL2",56,0)
 L +^GMR(120.8,ALENT)
"RTN","GMRAUTL2",57,0)
 S ENTRY=$O(^GMR(120.8,ALENT,$S(TYPE="I":2,1:3),"B",SUBENT,0)) Q:'+ENTRY
"RTN","GMRAUTL2",58,0)
 S FILE=$S(TYPE="I":120.802,1:120.803)
"RTN","GMRAUTL2",59,0)
 S FDA(FILE,ENTRY_","_ALENT_",",.01)="@"
"RTN","GMRAUTL2",60,0)
 D FILE^DIE("","FDA","EM")
"RTN","GMRAUTL2",61,0)
 L -^GMR(120.8,ALENT)
"RTN","GMRAUTL2",62,0)
 Q
"RTN","GMRAUTL2",63,0)
 ;
"RTN","GMRAUTL2",64,0)
CHKORD ;Check for orders that are now in conflict with existing allergy data
"RTN","GMRAUTL2",65,0)
 N TIME,GMRAOC,ORX,SUB,GMRAORX,GI,CNT,DFN
"RTN","GMRAUTL2",66,0)
 Q:'+$G(DUZ)  ;Don't check if no valid user to send data to
"RTN","GMRAUTL2",67,0)
 K ^TMP("ORR",$J),^TMP($J,"ERR")
"RTN","GMRAUTL2",68,0)
 S DFN=0 F  S DFN=$O(UPDATED(DFN)) Q:'+DFN  D
"RTN","GMRAUTL2",69,0)
 .D EN^ORQ1(DFN_";DPT(") ;Retrieve active orders
"RTN","GMRAUTL2",70,0)
 .S TIME=$O(^TMP("ORR",$J,0))
"RTN","GMRAUTL2",71,0)
 .Q:'^TMP("ORR",$J,TIME,"TOT")  ;No orders found
"RTN","GMRAUTL2",72,0)
 .S SUB=0 F  S SUB=$O(^TMP("ORR",$J,TIME,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",73,0)
 ..D BLD^ORCHECK(+^TMP("ORR",$J,TIME,SUB)) ;Get "order" information in order checking format
"RTN","GMRAUTL2",74,0)
 .M GMRAORX=ORX K ORX,GMRAOC
"RTN","GMRAUTL2",75,0)
 .D EN^ORKCHK(.GMRAOC,DFN,.GMRAORX,"ACCEPT")
"RTN","GMRAUTL2",76,0)
 .S GI=0,CNT=0 F  S GI=$O(GMRAOC(GI)) Q:'+GI  D
"RTN","GMRAUTL2",77,0)
 ..Q:$P(GMRAOC(GI),U,2)'=3  ;Quit if not allergy related
"RTN","GMRAUTL2",78,0)
 ..Q:$D(^OR(100,$P(GMRAOC(GI),U),9,"B",3))  ;Quit if existing allergy order check, can't be for this new information
"RTN","GMRAUTL2",79,0)
 ..S CNT=CNT+1,^TMP($J,"ERR",DFN,CNT)=$P($$STATUS^ORQOR2($P(GMRAOC(GI),U)),U,2)_" order for "_$P($$OI^ORX8($P(GMRAOC(GI),U)),U,2)_",order #"_$P(GMRAOC(GI),U)
"RTN","GMRAUTL2",80,0)
 .K GMRAORX ;Remove previous list of orders
"RTN","GMRAUTL2",81,0)
 D MAIL K ^TMP("ORR",$J),^TMP($J,"ERR")
"RTN","GMRAUTL2",82,0)
 Q
"RTN","GMRAUTL2",83,0)
 ;
"RTN","GMRAUTL2",84,0)
ADDCOM ;Add comment to updated allergy indicating changes
"RTN","GMRAUTL2",85,0)
 Q
"RTN","GMRAUTL2",86,0)
 N TYPE,ROOT,SUB2,DICR,DIEL,DL,DP,DM,DK,DIK,DC,DE,GLOB,DH,D,DQ,DR,DIC,DIE,DIA,DI,DG,DDH,DDER,DA,D0,D1
"RTN","GMRAUTL2",87,0)
 F GLOB="ING(""A"")","ING(""D"")","CLASS(""A"")","CLASS(""D"")" I $D(@GLOB) D
"RTN","GMRAUTL2",88,0)
 .S TYPE=$S(GLOB="ING(""A"")":1,GLOB="ING(""D"")":2,GLOB="CLASS(""A"")":3,1:4) ;Determines if we're adding or deleting ingredients or classes
"RTN","GMRAUTL2",89,0)
 .S COM="The following "_$S(TYPE=1!(TYPE=2):"ingredients",1:"drug classes")_" were "_$S(TYPE=2!(TYPE=4):"deleted",1:"added")_": "
"RTN","GMRAUTL2",90,0)
 .S ROOT=$S(TYPE=1:"ING(""A"")",TYPE=2:"ING(""D"")",TYPE=3:"CLASS(""A"")",1:"CLASS(""D"")")
"RTN","GMRAUTL2",91,0)
 .S SUB2=0 F  S SUB2=$O(@ROOT@(SUB2)) Q:'+SUB2  I @ROOT@(SUB2) S COM=COM_$S($P(COM,": ",2)'="":", ",1:"")_$S(TYPE=1!(TYPE=2):$$GET1^DIQ(50.416,SUB2_",",.01),1:$$GET1^DIQ(50.605,SUB2_",",.01))
"RTN","GMRAUTL2",92,0)
 .I $P(COM,": ",2)'="" L +^GMR(120.8,SUB) D ADCOM^GMRAFX(SUB,"O",COM) L -^GMR(120.8,SUB)
"RTN","GMRAUTL2",93,0)
 Q
"RTN","GMRAUTL2",94,0)
 ;
"RTN","GMRAUTL2",95,0)
MAIL ;Send message containing potential order checks to user.
"RTN","GMRAUTL2",96,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,CNT,SUB,ERR,TYPE,NUM
"RTN","GMRAUTL2",97,0)
 Q:'$D(^TMP($J,"ERR"))  ;Nothing to report
"RTN","GMRAUTL2",98,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAUTL2",99,0)
 S XMDUZ="Allergy auto-update program"
"RTN","GMRAUTL2",100,0)
 S XMY($G(DUZ,.5))="" ;Send to user who initiated change or postmaster
"RTN","GMRAUTL2",101,0)
 S XMY("G.GMRA REQUEST NEW REACTANT")="" ;Include mail group to be sure someone gets this message
"RTN","GMRAUTL2",102,0)
 S CNT=1
"RTN","GMRAUTL2",103,0)
 S ^TMP($J,"TEXT",CNT)="The "_$P(ENTRY,U,2)_" reactant was updated.",CNT=CNT+1
"RTN","GMRAUTL2",104,0)
 S ^TMP($J,"TEXT",CNT)="The following drug classes and/or drug ingredients were added:",CNT=CNT+1,^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",105,0)
 F TYPE="GMRAI","GMRAC" D
"RTN","GMRAUTL2",106,0)
 .I $D(@(TYPE)) D
"RTN","GMRAUTL2",107,0)
 ..S ^TMP($J,"TEXT",CNT)=$S(TYPE="GMRAI":"Ingredients",1:"Classes")_": ",CNT=CNT+1
"RTN","GMRAUTL2",108,0)
 ..S NUM=0 F  S NUM=$O(@TYPE@("A",NUM)) Q:'+NUM  S ^TMP($J,"TEXT",CNT)=$G(^TMP($J,"TEXT",CNT))_$S($L($G(^TMP($J,"TEXT",CNT))):",",1:"")_$$GET1^DIQ($S(TYPE="GMRAI":50.416,1:50.605),NUM_",",.01)
"RTN","GMRAUTL2",109,0)
 ..S CNT=CNT+1,^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",110,0)
 S ^TMP($J,"TEXT",CNT)="As a result of the update the following patients have drug-allergy",CNT=CNT+1
"RTN","GMRAUTL2",111,0)
 S ^TMP($J,"TEXT",CNT)="interactions that need to be reviewed to ensure the patient's safety.",CNT=CNT+1
"RTN","GMRAUTL2",112,0)
 S SUB=0 F  S SUB=$O(^TMP($J,"ERR",SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",113,0)
 .S ^TMP($J,"TEXT",CNT)="",CNT=CNT+1
"RTN","GMRAUTL2",114,0)
 .S ^TMP($J,"TEXT",CNT)=$$GET1^DIQ(2,SUB_",",.01),CNT=CNT+1
"RTN","GMRAUTL2",115,0)
 .S ERR=0 F  S ERR=$O(^TMP($J,"ERR",SUB,ERR)) Q:'+ERR  S ^TMP($J,"TEXT",CNT)="   "_^TMP($J,"ERR",SUB,ERR),CNT=CNT+1
"RTN","GMRAUTL2",116,0)
 S XMTEXT="^TMP($J,""TEXT"",",XMSUB="Potential order checks from allergy update"
"RTN","GMRAUTL2",117,0)
 D ^XMD
"RTN","GMRAUTL2",118,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAUTL2",119,0)
 Q
"RTN","GMRAUTL2",120,0)
 ;
"RTN","GMRAUTL2",121,0)
TOP10 ;Check top 10 reactions after push of file 120.83
"RTN","GMRAUTL2",122,0)
 N SUB,REAC,REACNO,ARRAY,SUBNM,REACNM,GMRATXT,XMSUB,XMTEXT,XMDUZ,XMY,DIFROM,CNT
"RTN","GMRAUTL2",123,0)
 I '$L($T(SCREEN^XTID)) Q  ;No screening code so quit
"RTN","GMRAUTL2",124,0)
 S SUB=0 F  S SUB=$O(^GMRD(120.84,SUB)) Q:'+SUB  I $D(^GMRD(120.84,SUB,1)) D
"RTN","GMRAUTL2",125,0)
 .S REAC=0 F  S REAC=$O(^GMRD(120.84,SUB,1,REAC)) Q:'+REAC  D
"RTN","GMRAUTL2",126,0)
 ..S REACNO=$P(^GMRD(120.84,SUB,1,REAC,0),U) Q:'+REACNO
"RTN","GMRAUTL2",127,0)
 ..I $$SCREEN^XTID(120.83,.01,REACNO_",") D
"RTN","GMRAUTL2",128,0)
 ...S SUBNM=$P(^GMRD(120.84,SUB,0),U),REACNM=$P(^GMRD(120.83,REACNO,0),U)
"RTN","GMRAUTL2",129,0)
 ...S ARRAY(SUBNM,REACNM)=""
"RTN","GMRAUTL2",130,0)
 I $D(ARRAY) D
"RTN","GMRAUTL2",131,0)
 .S XMDUZ="Data Standardization update of file 120.83",XMY("G.GMRA REQUEST NEW REACTANT")=""
"RTN","GMRAUTL2",132,0)
 .S GMRATXT(1)="The signs/symptoms file has been automatically updated.  You're receiving"
"RTN","GMRAUTL2",133,0)
 .S GMRATXT(2)="this message because one or more signs/symptoms was inactivated during this"
"RTN","GMRAUTL2",134,0)
 .S GMRATXT(3)="update and the term(s) appear in your top ten list and must be replaced."
"RTN","GMRAUTL2",135,0)
 .S GMRATXT(4)="Below you will find the name of the site parameter and the terms that are now"
"RTN","GMRAUTL2",136,0)
 .S GMRATXT(5)="inactive for that entry.  Use the Enter/Edit Site Parameters [GMRA SITE FILE]"
"RTN","GMRAUTL2",137,0)
 .S GMRATXT(6)="option to find and replace these terms."
"RTN","GMRAUTL2",138,0)
 .S GMRATXT(7)=""
"RTN","GMRAUTL2",139,0)
 .S CNT=7
"RTN","GMRAUTL2",140,0)
 .S SUB="" F  S SUB=$O(ARRAY(SUB)) Q:SUB=""  S CNT=CNT+1,GMRATXT(CNT)="Site parameter: "_SUB D  S CNT=CNT+1,GMRATXT(CNT)=""
"RTN","GMRAUTL2",141,0)
 ..S REAC="" F  S REAC=$O(ARRAY(SUB,REAC)) Q:REAC=""  S CNT=CNT+1,GMRATXT(CNT)="Term: "_REAC
"RTN","GMRAUTL2",142,0)
 .S XMTEXT="GMRATXT(",XMSUB="Signs/symptoms require updating"
"RTN","GMRAUTL2",143,0)
 .D ^XMD
"RTN","GMRAUTL2",144,0)
 Q
"RTN","GMRAUTL2",145,0)
 ;
"RTN","GMRAUTL2",146,0)
QREACT ;Queue name update, called from "AC" xref in file 120.82.  Entire section added in patch 23
"RTN","GMRAUTL2",147,0)
 N OTERM,NTERM,ZTRTN,ZTDTH,ZTIO,ZTDESC
"RTN","GMRAUTL2",148,0)
 Q:X1(1)=""!(X2(1)="")  ;Entry is new or has been deleted, no updating required
"RTN","GMRAUTL2",149,0)
 Q:X1(1)=X2(1)  ;Entry has been updated to same value, no updating required
"RTN","GMRAUTL2",150,0)
 S OTERM=X1(1),NTERM=X2(1)
"RTN","GMRAUTL2",151,0)
 S ZTRTN="REACT^GMRAUTL2",ZTIO="GMRA UPDATE RESOURCE",ZTDTH=$H,ZTDESC="UPDATE REACTANT FIELD IN 120.8",ZTSAVE("*")="" D ^%ZTLOAD
"RTN","GMRAUTL2",152,0)
 Q
"RTN","GMRAUTL2",153,0)
 ;
"RTN","GMRAUTL2",154,0)
REACT ;Update REACTANT field with name from 120.82.  Section added with patch 23
"RTN","GMRAUTL2",155,0)
 N IEN,FDA,EM,DFN
"RTN","GMRAUTL2",156,0)
 S IEN=0 F  S IEN=$O(^GMR(120.8,"C",OTERM,IEN)) Q:'+IEN  D
"RTN","GMRAUTL2",157,0)
 .S DFN=$P(^GMR(120.8,IEN,0),U)
"RTN","GMRAUTL2",158,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",159,0)
 .Q:+$G(^GMR(120.8,IEN,"ER"))  ;Don't update if entered in error
"RTN","GMRAUTL2",160,0)
 .L +^GMR(120.8,IEN)
"RTN","GMRAUTL2",161,0)
 .S FDA(120.8,IEN_",",.02)=NTERM
"RTN","GMRAUTL2",162,0)
 .D FILE^DIE("","FDA","EM")
"RTN","GMRAUTL2",163,0)
 .L -^GMR(120.8,IEN)
"RTN","GMRAUTL2",164,0)
 Q
"RTN","GMRAUTL2",165,0)
 ;
"RTN","GMRAUTL2",166,0)
QTYPE ;Queue allergy type updates, section added in 36
"RTN","GMRAUTL2",167,0)
 N ENTRY
"RTN","GMRAUTL2",168,0)
 S ENTRY=DA_";GMRD(120.82,"_"^"_$P(^GMRD(120.82,DA,0),"^")
"RTN","GMRAUTL2",169,0)
 Q:X1(1)=""!(X2(1)="")
"RTN","GMRAUTL2",170,0)
 Q:X1(1)=X2(1)
"RTN","GMRAUTL2",171,0)
 S ZTRTN="TYPE^GMRAUTL2",ZTIO="",ZTDTH=$H,ZTDESC="Allergy type updates",ZTSAVE("*")="" D ^%ZTLOAD
"RTN","GMRAUTL2",172,0)
 Q
"RTN","GMRAUTL2",173,0)
 ;
"RTN","GMRAUTL2",174,0)
TYPE ;Find related entries in 120.8 and update, section added in 36
"RTN","GMRAUTL2",175,0)
 N ALLERGY,POINTER,DFN,SUB
"RTN","GMRAUTL2",176,0)
 S ALLERGY=$P(ENTRY,"^",2) Q:ALLERGY=""
"RTN","GMRAUTL2",177,0)
 S POINTER=$P(ENTRY,"^") Q:POINTER=""
"RTN","GMRAUTL2",178,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,"C",ALLERGY,SUB)) Q:'+SUB  D
"RTN","GMRAUTL2",179,0)
 .Q:$P(^GMR(120.8,SUB,0),"^",3)'=POINTER  ;Same text name but not the same entry
"RTN","GMRAUTL2",180,0)
 .S DFN=$P(^GMR(120.8,SUB,0),U)
"RTN","GMRAUTL2",181,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Don't update if patient is deceased
"RTN","GMRAUTL2",182,0)
 .Q:$G(^GMR(120.8,SUB,"ER"))>0  ;Entered in error
"RTN","GMRAUTL2",183,0)
 .S DR="3.1///"_X2(1),DIE=120.8,DA=SUB D ^DIE ;Update allergy type
"RTN","GMRAUTL2",184,0)
 Q
"RTN","GMRAY36")
0^6^B23667730^n/a
"RTN","GMRAY36",1,0)
GMRAY36 ;SLC/DAN Post-install for patch 36 ;2/1/07  13:46
"RTN","GMRAY36",2,0)
 ;;4.0;Adverse Reaction Tracking;**36**;Mar 29, 1996;Build 9
"RTN","GMRAY36",3,0)
 ;DBIA SECTION
"RTN","GMRAY36",4,0)
 ;10063 - %ZTLOAD
"RTN","GMRAY36",5,0)
 ; 3744 - $$TESTPAT^VADPT
"RTN","GMRAY36",6,0)
 ;10018 - DIE
"RTN","GMRAY36",7,0)
 ;10103 - XLFDT
"RTN","GMRAY36",8,0)
 ;10070 - XMD
"RTN","GMRAY36",9,0)
 ;10141 - XPDUTL
"RTN","GMRAY36",10,0)
 ; 4631 - $$SCREEN^XTID
"RTN","GMRAY36",11,0)
 ;
"RTN","GMRAY36",12,0)
Q ;Entry point to queue process during install
"RTN","GMRAY36",13,0)
 N ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSK
"RTN","GMRAY36",14,0)
 S ZTRTN="DQ^GMRAY36",ZTDESC="GMRA*4*36 POST INSTALL ROUTINE",ZTIO="",ZTDTH=$H
"RTN","GMRAY36",15,0)
 D ^%ZTLOAD I '$G(ZTSK) D BMES^XPDUTL("POST INSTALL NOT QUEUED - RUN DQ^GMRA36 AFTER INSTALL FINISHES") Q
"RTN","GMRAY36",16,0)
 D BMES^XPDUTL("Post-install queued as task # "_$G(ZTSK))
"RTN","GMRAY36",17,0)
 Q
"RTN","GMRAY36",18,0)
 ;
"RTN","GMRAY36",19,0)
DQ ;Dequeue
"RTN","GMRAY36",20,0)
 N FIX,FTBP
"RTN","GMRAY36",21,0)
 D ^GMRAY36A ;Set up new style xref in file 120.82
"RTN","GMRAY36",22,0)
 D POST,MAIL
"RTN","GMRAY36",23,0)
 Q
"RTN","GMRAY36",24,0)
 ;
"RTN","GMRAY36",25,0)
POST ;Post-install for patch 36
"RTN","GMRAY36",26,0)
 N IEN,GMRA0,DIE,DA,DR,DFN,GMRAFT
"RTN","GMRAY36",27,0)
 S GMRAFT=$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0))
"RTN","GMRAY36",28,0)
 S IEN=0 F  S IEN=$O(^GMR(120.8,IEN)) Q:'+IEN  D
"RTN","GMRAY36",29,0)
 .S GMRA0=$G(^GMR(120.8,IEN,0)) ;Set GMRA0 to zero node
"RTN","GMRAY36",30,0)
 .Q:GMRA0=""  ;Quit if no zero node
"RTN","GMRAY36",31,0)
 .Q:+$G(^GMR(120.8,IEN,"ER"))  ;Quit if entered in error
"RTN","GMRAY36",32,0)
 .S DFN=$P(GMRA0,U) Q:'+DFN  ;Quit if no patient identifier
"RTN","GMRAY36",33,0)
 .Q:$$TESTPAT^VADPT(DFN)  ;Quit if test patient
"RTN","GMRAY36",34,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Quit if patient is deceased
"RTN","GMRAY36",35,0)
 .I $P(GMRA0,U,3)=(GMRAFT_";GMRD(120.82,") S FTBP=$G(FTBP)+1 ;Count existing free text entries
"RTN","GMRAY36",36,0)
 .I '+$P(GMRA0,U,12),$P(GMRA0,U,16) S DIE=120.8,DA=IEN,DR="15///1" D ^DIE ;If not signed off and verified then mark signed off
"RTN","GMRAY36",37,0)
 .I $P(GMRA0,U,3)["GMRD",+$P(GMRA0,U,3)'=GMRAFT D TYPENAME,INACT ;Check allergy type and reactant name of 120.82 entries and then check if inactive
"RTN","GMRAY36",38,0)
 .I $P(GMRA0,U,3)["PSDRUG" D FILE50 ;If file 50 check for ing/drug class
"RTN","GMRAY36",39,0)
 .I $D(^GMR(120.8,IEN,10)) D CHKSIGNS ;If reactions exist check for semi-colons in free text entries
"RTN","GMRAY36",40,0)
 Q
"RTN","GMRAY36",41,0)
 ;
"RTN","GMRAY36",42,0)
MAIL ;Send message indicating post install is finished
"RTN","GMRAY36",43,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,GMRATXT
"RTN","GMRAY36",44,0)
 S XMDUZ="PATCH GMRA*4*36 POST-INSTALL",XMY(.5)="" S:$G(DUZ) XMY(DUZ)=""
"RTN","GMRAY36",45,0)
 S XMY("DAVID.NABER@VA.GOV")="",XMY("CATHERINE.HOANG2@VA.GOV")="",XMY("THOMAS.CAMPBELL2@VA.GOV")="",XMY("HULET.LEE_ANN@FORUM.VA.GOV")=""
"RTN","GMRAY36",46,0)
 S XMY("VHAOIHSITESHDRIM@MED.VA.GOV")=""
"RTN","GMRAY36",47,0)
 S GMRATXT(1)="The post-install routine for patch GMRA*4*36"
"RTN","GMRAY36",48,0)
 S GMRATXT(2)="finished on "_$$FMTE^XLFDT($$NOW^XLFDT)_"."
"RTN","GMRAY36",49,0)
 S GMRATXT(3)=""
"RTN","GMRAY36",50,0)
 S GMRATXT(4)="Number of free text entries before patch 36  : "_+$G(FTBP)
"RTN","GMRAY36",51,0)
 S GMRATXT(5)="Allergies converted to free text by patch 36 : "_+$G(FIX)
"RTN","GMRAY36",52,0)
 S GMRATXT(6)="Total number of free text allergies at site  : "_($G(FTBP)+$G(FIX))
"RTN","GMRAY36",53,0)
 S GMRATXT(7)=""
"RTN","GMRAY36",54,0)
 S GMRATXT(8)="Please note that patch GMRA*4*29, when installed, will automatically"
"RTN","GMRAY36",55,0)
 S GMRATXT(9)="convert free text entries to a standardized entry.",GMRATXT(10)="As a result, you do not need to take any action at this point."
"RTN","GMRAY36",56,0)
 S XMTEXT="GMRATXT(",XMSUB="PATCH GMRA*4*36 Post Install COMPLETED"
"RTN","GMRAY36",57,0)
 D ^XMD
"RTN","GMRAY36",58,0)
 Q
"RTN","GMRAY36",59,0)
 ;
"RTN","GMRAY36",60,0)
INACT ;If 120.82 is inactive then convert 120.8 entry to free text
"RTN","GMRAY36",61,0)
 N DA,DIE,DR,GMRAAR,COM
"RTN","GMRAY36",62,0)
 Q:'$$SCREEN^XTID(120.82,,(+$P(GMRA0,U,3)_","))  ;Stop if term is active
"RTN","GMRAY36",63,0)
 S GMRAAR=GMRAFT_";GMRD(120.82,"
"RTN","GMRAY36",64,0)
 S DA=IEN,DIE=120.8,DR="1////^S X=GMRAAR" D ^DIE
"RTN","GMRAY36",65,0)
 S FIX=$G(FIX)+1 ;Increment counter
"RTN","GMRAY36",66,0)
 S COM="Changed from "_$P($G(GMRA0),U,2)_" (File 120.82) to free text by patch GMRA*4*36" D ADCOM^GMRAFX(IEN,"O",COM)
"RTN","GMRAY36",67,0)
 Q
"RTN","GMRAY36",68,0)
 ;
"RTN","GMRAY36",69,0)
TYPENAME ;Synch up allergy type
"RTN","GMRAY36",70,0)
 N DA,DIE,DR
"RTN","GMRAY36",71,0)
 Q:$$SCREEN^XTID(120.82,,(+$P(GMRA0,U,3)_","))  ;Stop if term is inactive
"RTN","GMRAY36",72,0)
 I $P($G(^GMRD(120.82,+$P(GMRA0,U,3),0)),U,2)'=$P(GMRA0,U,20) S DR="3.1///"_$P($G(^GMRD(120.82,+$P(GMRA0,U,3),0)),U,2)
"RTN","GMRAY36",73,0)
 I $P(GMRA0,U,2)'=$P($G(^GMRD(120.82,+$P(GMRA0,U,3),0)),U) S DR=$G(DR)_$S($G(DR)'="":";",1:"")_".02////"_$P($G(^GMRD(120.82,+$P(GMRA0,U,3),0)),U)
"RTN","GMRAY36",74,0)
 I $D(DR) S DIE=120.8,DA=IEN D ^DIE
"RTN","GMRAY36",75,0)
 Q
"RTN","GMRAY36",76,0)
 ;
"RTN","GMRAY36",77,0)
FILE50 ;Update to free text if no ing/drug class on file
"RTN","GMRAY36",78,0)
 N DA,DIE,DR,GMRAAR,COM
"RTN","GMRAY36",79,0)
 I '$O(^GMR(120.8,IEN,2,0))&('$O(^GMR(120.8,IEN,3,0))) D
"RTN","GMRAY36",80,0)
 .S GMRAAR=GMRAFT_";GMRD(120.82,"
"RTN","GMRAY36",81,0)
 .S DIE=120.8,DA=IEN,DR="1////^S X=GMRAAR" D ^DIE
"RTN","GMRAY36",82,0)
 .S FIX=$G(FIX)+1
"RTN","GMRAY36",83,0)
 .S COM="Changed from "_$P($G(GMRA0),U,2)_" (File 50) to free text by patch GMRA*4*36" D ADCOM^GMRAFX(IEN,"O",COM)
"RTN","GMRAY36",84,0)
 Q
"RTN","GMRAY36",85,0)
 ;
"RTN","GMRAY36",86,0)
CHKSIGNS ;Check free text reactions for semicolons.  If present substitute a comma to avoid display problems
"RTN","GMRAY36",87,0)
 N SUB,NAME,DR,DA,DIE
"RTN","GMRAY36",88,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,IEN,10,SUB)) Q:'+SUB  D
"RTN","GMRAY36",89,0)
 .I $P($G(^GMR(120.8,IEN,10,SUB,0)),U,2)[";" D
"RTN","GMRAY36",90,0)
 ..S NAME=$TR($P(^(0),U,2),";",",") ;Replace ; with , naked reference to above line
"RTN","GMRAY36",91,0)
 ..S DA(1)=IEN,DA=SUB,DIE="^GMR(120.8,DA(1),10,",DR="1////"_NAME D ^DIE
"RTN","GMRAY36",92,0)
 Q
"RTN","GMRAY36A")
0^7^B1688077^n/a
"RTN","GMRAY36A",1,0)
GMRAY36A ;SLC/DAN-CREATE NEW-STYLE XREF ;7/13/06  15:05
"RTN","GMRAY36A",2,0)
 ;;4.0;Adverse Reaction Tracking;**36**;Mar 29, 1996;Build 9
"RTN","GMRAY36A",3,0)
 ;
"RTN","GMRAY36A",4,0)
 N GMRAXR,GMRARES,GMRAOUT
"RTN","GMRAY36A",5,0)
 S GMRAXR("FILE")=120.82
"RTN","GMRAY36A",6,0)
 S GMRAXR("NAME")="AD"
"RTN","GMRAY36A",7,0)
 S GMRAXR("TYPE")="MU"
"RTN","GMRAY36A",8,0)
 S GMRAXR("USE")="A"
"RTN","GMRAY36A",9,0)
 S GMRAXR("EXECUTION")="F"
"RTN","GMRAY36A",10,0)
 S GMRAXR("ACTIVITY")="R"
"RTN","GMRAY36A",11,0)
 S GMRAXR("SHORT DESCR")="Update entries in 120.8 when this field changes"
"RTN","GMRAY36A",12,0)
 S GMRAXR("DESCR",1)="When the allergy type field for the entry in this file is changed"
"RTN","GMRAY36A",13,0)
 S GMRAXR("DESCR",2)="then all associated entries in file 120.8 will be updated."
"RTN","GMRAY36A",14,0)
 S GMRAXR("SET")="Q:$D(DIU(0))  D QTYPE^GMRAUTL2"
"RTN","GMRAY36A",15,0)
 S GMRAXR("KILL")="Q"
"RTN","GMRAY36A",16,0)
 S GMRAXR("VAL",1)=1
"RTN","GMRAY36A",17,0)
 S GMRAXR("VAL",1,"COLLATION")="F"
"RTN","GMRAY36A",18,0)
 D CREIXN^DDMOD(.GMRAXR,"k",.GMRARES,"GMRAOUT")
"RTN","GMRAY36A",19,0)
 Q
"UP",120.82,120.824,-1)
120.82^ING
"UP",120.82,120.824,0)
120.824
"VER")
8.0^22.0
"^DD",120.82,120.82,4,0)
DRUG INGREDIENTS^120.824P^^ING;0
"^DD",120.82,120.82,4,21,0)
^^1^1^2921022^^^
"^DD",120.82,120.82,4,21,1,0)
List of drug ingredients that comprise this particular allergy.
"^DD",120.82,120.824,0)
DRUG INGREDIENTS SUB-FIELD^^.01^1
"^DD",120.82,120.824,0,"NM","DRUG INGREDIENTS")

"^DD",120.82,120.824,.01,0)
DRUG INGREDIENT^M*P50.416'^PS(50.416,^0;1^S DIC("S")="N GMRA S GMRA=$P(^(0),U) X ""I $L(GMRA),$D(^PS(50.416,""""P"""",GMRA,Y))"" Q" D ^DIC K DIC S DIC=DIE,X=+Y K:Y<0 X
"^DD",120.82,120.824,.01,1,0)
^.1
"^DD",120.82,120.824,.01,1,1,0)
120.824^B
"^DD",120.82,120.824,.01,1,1,1)
S ^GMRD(120.82,DA(1),"ING","B",$E(X,1,30),DA)=""
"^DD",120.82,120.824,.01,1,1,2)
K ^GMRD(120.82,DA(1),"ING","B",$E(X,1,30),DA)
"^DD",120.82,120.824,.01,4)
D:DZ="?" EN^DDIOL("Enter one of the drug ingredients that make up this allergy.","","!?5")
"^DD",120.82,120.824,.01,9)
^
"^DD",120.82,120.824,.01,12)
Allow primary ingredients only.
"^DD",120.82,120.824,.01,12.1)
S DIC("S")="N GMRA S GMRA=$P(^(0),U) X ""I $L(GMRA),$D(^PS(50.416,""""P"""",GMRA,Y))"" Q"
"^DD",120.82,120.824,.01,21,0)
^.001^2^2^3060717^^^^
"^DD",120.82,120.824,.01,21,1,0)
This is one of the drug ingredients that make up this causative agent.
"^DD",120.82,120.824,.01,21,2,0)
Must be a primary ingredient.
"^DD",120.82,120.824,.01,"DT")
3060717
"BLD",6130,6)
^32
**END**
**END**
