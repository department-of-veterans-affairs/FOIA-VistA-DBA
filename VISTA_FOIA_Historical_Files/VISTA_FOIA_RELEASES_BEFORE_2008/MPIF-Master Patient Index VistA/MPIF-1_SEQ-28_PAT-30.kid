Released MPIF*1*30 SEQ #28
Extracted from mail message
**KIDS**:MPIF*1.0*30^

**INSTALL NAME**
MPIF*1.0*30
"BLD",1798,0)
MPIF*1.0*30^MASTER PATIENT INDEX VISTA^0^3030818^y
"BLD",1798,1,0)
^^3^3^3030818^
"BLD",1798,1,1,0)
CHANGE ROUTING FOR CMOR CHANGE MSGS
"BLD",1798,1,2,0)
Refer to patch MPIF*1.0*30 in the FORUM Patch Module for a complete
"BLD",1798,1,3,0)
description.
"BLD",1798,4,0)
^9.64PA^^
"BLD",1798,"ABNS",0)
^9.66A^^
"BLD",1798,"ABPKG")
y^y^G.CIRN DEV@FORUM.VA.GOV
"BLD",1798,"KRN",0)
^9.67PA^8989.52^19
"BLD",1798,"KRN",.4,0)
.4
"BLD",1798,"KRN",.401,0)
.401
"BLD",1798,"KRN",.402,0)
.402
"BLD",1798,"KRN",.403,0)
.403
"BLD",1798,"KRN",.5,0)
.5
"BLD",1798,"KRN",.84,0)
.84
"BLD",1798,"KRN",3.6,0)
3.6
"BLD",1798,"KRN",3.8,0)
3.8
"BLD",1798,"KRN",9.2,0)
9.2
"BLD",1798,"KRN",9.8,0)
9.8
"BLD",1798,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",1798,"KRN",9.8,"NM",1,0)
MPIFCMOR^^0^B8338320
"BLD",1798,"KRN",9.8,"NM",2,0)
MPIFCMRP^^0^B22600954
"BLD",1798,"KRN",9.8,"NM",3,0)
MPIFRESS^^0^B18945709
"BLD",1798,"KRN",9.8,"NM",4,0)
MPIFEDIT^^0^B30259872
"BLD",1798,"KRN",9.8,"NM",5,0)
MPIFREQ^^0^B27491051
"BLD",1798,"KRN",9.8,"NM","B","MPIFCMOR",1)

"BLD",1798,"KRN",9.8,"NM","B","MPIFCMRP",2)

"BLD",1798,"KRN",9.8,"NM","B","MPIFEDIT",4)

"BLD",1798,"KRN",9.8,"NM","B","MPIFREQ",5)

"BLD",1798,"KRN",9.8,"NM","B","MPIFRESS",3)

"BLD",1798,"KRN",19,0)
19
"BLD",1798,"KRN",19.1,0)
19.1
"BLD",1798,"KRN",101,0)
101
"BLD",1798,"KRN",409.61,0)
409.61
"BLD",1798,"KRN",771,0)
771
"BLD",1798,"KRN",870,0)
870
"BLD",1798,"KRN",8989.51,0)
8989.51
"BLD",1798,"KRN",8989.52,0)
8989.52
"BLD",1798,"KRN",8994,0)
8994
"BLD",1798,"KRN","B",.4,.4)

"BLD",1798,"KRN","B",.401,.401)

"BLD",1798,"KRN","B",.402,.402)

"BLD",1798,"KRN","B",.403,.403)

"BLD",1798,"KRN","B",.5,.5)

"BLD",1798,"KRN","B",.84,.84)

"BLD",1798,"KRN","B",3.6,3.6)

"BLD",1798,"KRN","B",3.8,3.8)

"BLD",1798,"KRN","B",9.2,9.2)

"BLD",1798,"KRN","B",9.8,9.8)

"BLD",1798,"KRN","B",19,19)

"BLD",1798,"KRN","B",19.1,19.1)

"BLD",1798,"KRN","B",101,101)

"BLD",1798,"KRN","B",409.61,409.61)

"BLD",1798,"KRN","B",771,771)

"BLD",1798,"KRN","B",870,870)

"BLD",1798,"KRN","B",8989.51,8989.51)

"BLD",1798,"KRN","B",8989.52,8989.52)

"BLD",1798,"KRN","B",8994,8994)

"BLD",1798,"QUES",0)
^9.62^^
"BLD",1798,"REQB",0)
^9.611^4^4
"BLD",1798,"REQB",1,0)
MPIF*1.0*11^1
"BLD",1798,"REQB",2,0)
MPIF*1.0*21^1
"BLD",1798,"REQB",3,0)
MPIF*1.0*22^1
"BLD",1798,"REQB",4,0)
MPIF*1.0*26^1
"BLD",1798,"REQB","B","MPIF*1.0*11",1)

"BLD",1798,"REQB","B","MPIF*1.0*21",2)

"BLD",1798,"REQB","B","MPIF*1.0*22",3)

"BLD",1798,"REQB","B","MPIF*1.0*26",4)

"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
30^3030818
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3030818
"PKG",282,22,1,"PAH",1,1,1,0)
CHANGE ROUTING FOR CMOR CHANGE MSGS
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1.0*30 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","MPIFCMOR")
0^1^B8338320
"RTN","MPIFCMOR",1,0)
MPIFCMOR ;BHM/RGY-Set and broadcast CMOR changes ;FEB 20, 1998
"RTN","MPIFCMOR",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,6,11,30**;30 Apr 99
"RTN","MPIFCMOR",3,0)
 ;
"RTN","MPIFCMOR",4,0)
 ; Intergation Agreements Utilized:
"RTN","MPIFCMOR",5,0)
 ;   EXC^RGHLLOG    IA #2796
"RTN","MPIFCMOR",6,0)
 ;   START^RGHLLOG  IA #2796
"RTN","MPIFCMOR",7,0)
 ;   STOP^RGHLLOG   IA #2796
"RTN","MPIFCMOR",8,0)
 ;   $$EN^VAFCPID   IA #3015
"RTN","MPIFCMOR",9,0)
 ;
"RTN","MPIFCMOR",10,0)
BROAD(REQNO,ER) ;Broadcase CMOR change to everyone
"RTN","MPIFCMOR",11,0)
 N CN,RGL,HL,CNT,HLA,PDX,ICN,HOME,RGLINK,RGL,TMP,II,CLIENT,HLA,USER,N0,NDATE,RLST,SERVER,ERR,MPILK
"RTN","MPIFCMOR",12,0)
 S ER=0
"RTN","MPIFCMOR",13,0)
 S SERVER="MPIF CMOR RESULT SERVER"
"RTN","MPIFCMOR",14,0)
 S CLIENT="MPIF CMOR RESULT CLIENT"
"RTN","MPIFCMOR",15,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFCMOR",16,0)
 S DFN=$P(N0,"^",4)
"RTN","MPIFCMOR",17,0)
 S NDATE=$P(N0,"^",3)
"RTN","MPIFCMOR",18,0)
 N X,Y,DIC
"RTN","MPIFCMOR",19,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(N0,"^",2)
"RTN","MPIFCMOR",20,0)
 D ^DIC
"RTN","MPIFCMOR",21,0)
 I $G(Y)<1 S USER="Automatic Processing"
"RTN","MPIFCMOR",22,0)
 I $G(Y)>0 S USER=$G(Y(0,0))
"RTN","MPIFCMOR",23,0)
 S SITE=+$P($$SITE^VASITE,"^",3)
"RTN","MPIFCMOR",24,0)
 S ICN=$$ICN^MPIFNQ(DFN)
"RTN","MPIFCMOR",25,0)
 S HOME=$P($$MPINODE^MPIFAPI(DFN),"^",3)
"RTN","MPIFCMOR",26,0)
 S CN=+$P($$MPINODE^MPIFAPI(DFN),"^",5)
"RTN","MPIFCMOR",27,0)
 S HL=0,CNT=0
"RTN","MPIFCMOR",28,0)
 K ^XTMP("MPIFCMOR","ERR")
"RTN","MPIFCMOR",29,0)
 D INIT^HLFNC2(SERVER,.HL)
"RTN","MPIFCMOR",30,0)
 I HL S ERR=HL D  Q
"RTN","MPIFCMOR",31,0)
 .D START^RGHLLOG()
"RTN","MPIFCMOR",32,0)
 .D EXC^RGHLLOG(220,"Unable to setup HL7 for Change CMOR Request # "_REQNO_" for ICN= "_ICN,DFN)
"RTN","MPIFCMOR",33,0)
 .D STOP^RGHLLOG()
"RTN","MPIFCMOR",34,0)
 .D RESET(DFN,REQNO)
"RTN","MPIFCMOR",35,0)
 K HLL("LINKS")
"RTN","MPIFCMOR",36,0)
 S MPILK=$$MPILINK^MPIFAPI ;routing all messages through the MPI
"RTN","MPIFCMOR",37,0)
 I +MPILK<0 D  Q
"RTN","MPIFCMOR",38,0)
 .D START^RGHLLOG()
"RTN","MPIFCMOR",39,0)
 .D EXC^RGHLLOG(224,"No MPI link found for Change CMOR Request # "_REQNO_" for ICN="_ICN,DFN)
"RTN","MPIFCMOR",40,0)
 .D STOP^RGHLLOG()
"RTN","MPIFCMOR",41,0)
 .D RESET(DFN,REQNO)
"RTN","MPIFCMOR",42,0)
 .S ER="-1^No Links found"
"RTN","MPIFCMOR",43,0)
 ;Broadcast new CMOR to MPI which will send it out to all sites
"RTN","MPIFCMOR",44,0)
 S HLL("LINKS",1)=CLIENT_"^"_MPILK
"RTN","MPIFCMOR",45,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_USER_HL("FS")_"NEW"
"RTN","MPIFCMOR",46,0)
 S CNT=CNT+1,PDX=$$EN^VAFCPID(DFN,"1,2,3,5,6,7,8,11,12,13,14,16,17,19")
"RTN","MPIFCMOR",47,0)
 S HLA("HLS",CNT)=PDX
"RTN","MPIFCMOR",48,0)
 S CNT=CNT+1,HLA("HLS",CNT)="PV1"_HL("FS")_HL("FS")_HL("FS")_$P($$NNT^XUAF4(+$P(N0,"^",7)),"^",2)_HL("FS")_HL("FS")_HL("FS")_$P($$SITE^VASITE,"^",3)
"RTN","MPIFCMOR",49,0)
 D GENERATE^HLMA(SERVER,"LM",1,.RLST,"",.HL)
"RTN","MPIFCMOR",50,0)
 I 'RLST D
"RTN","MPIFCMOR",51,0)
 .D START^RGHLLOG()
"RTN","MPIFCMOR",52,0)
 .D EXC^RGHLLOG(220,"Unable to Generate HL7 msg for Change CMOR Request # "_REQNO_" for ICN= "_ICN,DFN)
"RTN","MPIFCMOR",53,0)
 .D STOP^RGHLLOG()
"RTN","MPIFCMOR",54,0)
 .D RESET(DFN,REQNO)
"RTN","MPIFCMOR",55,0)
 .S ER="-1^error in HL7 sending msg"
"RTN","MPIFCMOR",56,0)
 Q
"RTN","MPIFCMOR",57,0)
RESET(DFN,REQNO) ;
"RTN","MPIFCMOR",58,0)
 ; reset status to pending approval and change CMOR to this site
"RTN","MPIFCMOR",59,0)
 N ERR
"RTN","MPIFCMOR",60,0)
 D RESET2^MPIFREQ(REQNO)
"RTN","MPIFCMOR",61,0)
 S ERR=$$CHANGE^MPIF001(DFN,+$$SITE^VASITE)
"RTN","MPIFCMOR",62,0)
 Q
"RTN","MPIFCMOR",63,0)
 ;
"RTN","MPIFCMOR",64,0)
SET(DFN,SITE) ;Set CMOR for patient to site
"RTN","MPIFCMOR",65,0)
 NEW RESULT
"RTN","MPIFCMOR",66,0)
 S RESULT=$$CHANGE^MPIF001(DFN,SITE)
"RTN","MPIFCMOR",67,0)
 Q
"RTN","MPIFCMRP")
0^2^B22600954
"RTN","MPIFCMRP",1,0)
MPIFCMRP ;BPCIO/CMC-PUSHING CMOR TO ANOTHER SITE ;NOV 15, 2000
"RTN","MPIFCMRP",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**11,21,30**;30 Apr 99
"RTN","MPIFCMRP",3,0)
 ;
"RTN","MPIFCMRP",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFCMRP",5,0)
 ;
"RTN","MPIFCMRP",6,0)
 ; ^DGCN(391.91   IA #2751
"RTN","MPIFCMRP",7,0)
 ;
"RTN","MPIFCMRP",8,0)
 ;Entry point for option: PUSH CMOR REQUEST - create a new request
"RTN","MPIFCMRP",9,0)
 ; to change CMOR when your site is the CMOR.
"RTN","MPIFCMRP",10,0)
 ; No input or output variables.
"RTN","MPIFCMRP",11,0)
 ;
"RTN","MPIFCMRP",12,0)
 ;Only if the site is the CMOR can this option be used
"RTN","MPIFCMRP",13,0)
 ; note: code here is very similar to MPIFEDIT
"RTN","MPIFCMRP",14,0)
NEW ;
"RTN","MPIFCMRP",15,0)
 N DIC,X,Y,DTOUT,DUOUT,PAT
"RTN","MPIFCMRP",16,0)
 S DIC="^DPT(",DIC(0)="QEAMZ",DIC("A")="Select PATIENT: "
"RTN","MPIFCMRP",17,0)
 D ^DIC
"RTN","MPIFCMRP",18,0)
 Q:$D(DTOUT)!$D(DUOUT)!(Y=-1)
"RTN","MPIFCMRP",19,0)
 S PAT=+Y
"RTN","MPIFCMRP",20,0)
 D LM(PAT)
"RTN","MPIFCMRP",21,0)
 Q
"RTN","MPIFCMRP",22,0)
LM(PAT) ; list manager entry point to push a change of CMOR with PAT set to the DFN
"RTN","MPIFCMRP",23,0)
 I +$$GETICN^MPIF001(PAT)<0 W !,"Patient doesn't have ICN, try again" G NEW
"RTN","MPIFCMRP",24,0)
 I $E($$GETICN^MPIF001(PAT),1,3)=$P($$SITE^VASITE(),"^",3) W !,"Patient has a Local ICN, try again" G NEW
"RTN","MPIFCMRP",25,0)
 I $$GETVCCI^MPIF001(PAT)<0 W !,"Patient doesn't have a CMOR, try again" G NEW
"RTN","MPIFCMRP",26,0)
 I $$GETVCCI^MPIF001(PAT)'=$P($$SITE^VASITE(),"^",3) W !,"You are NOT the CMOR, to request to be the CMOR, use option: Create a New CMOR Change Request" G NEW
"RTN","MPIFCMRP",27,0)
 N TMP,TCNT
"RTN","MPIFCMRP",28,0)
 S TMP=$O(^DGCN(391.91,"APAT",PAT,"")) I $O(^DGCN(391.91,"APAT",PAT,TMP))="" W !,"Patient isn't SHARED - CAN'T change CMOR" Q
"RTN","MPIFCMRP",29,0)
 ;Pt is shared, but are they shared with another VAMC?
"RTN","MPIFCMRP",30,0)
 S TMP="",TCNT=0 F  S TMP=$O(^DGCN(391.91,"APAT",PAT,TMP)) Q:TMP=""  D
"RTN","MPIFCMRP",31,0)
 .I $$GET1^DIQ(4,TMP_",",13)'="VAMC" Q
"RTN","MPIFCMRP",32,0)
 .S TCNT=TCNT+1
"RTN","MPIFCMRP",33,0)
 I TCNT<2 W !,"Patient isn't SHARED with another VAMC - CAN'T change CMOR" Q
"RTN","MPIFCMRP",34,0)
 ; CHECK IF ALREADY OPEN/PENDING REQUEST
"RTN","MPIFCMRP",35,0)
 N ENT,STOP,MPIFNM,REQNM
"RTN","MPIFCMRP",36,0)
 S ENT=0,STOP=0 F  S ENT=$O(^MPIF(984.9,"C",PAT,ENT)) Q:ENT=""!(STOP)  D
"RTN","MPIFCMRP",37,0)
 .I $P($G(^MPIF(984.9,ENT,0)),"^",6)<4 S STOP=1
"RTN","MPIFCMRP",38,0)
 I STOP W !!,"Already have request for this patient" G NEW
"RTN","MPIFCMRP",39,0)
 N N0,PHONE,DA,DIE,DR,DIR,ERROR,DIK,Y,DIRUT,REQ,TDA,PERS
"RTN","MPIFCMRP",40,0)
 S DA=$$ADD^MPIFNEW(),TDA=DA,PHONE=""
"RTN","MPIFCMRP",41,0)
 S DIE="^MPIF(984.9,",DR=".04///`"_PAT D ^DIE
"RTN","MPIFCMRP",42,0)
 S REQ=$P($G(^MPIF(984.9,DA,0)),"^")
"RTN","MPIFCMRP",43,0)
 W !,"REQUEST NUMBER:",REQ
"RTN","MPIFCMRP",44,0)
EDIT I $D(DUZ) D
"RTN","MPIFCMRP",45,0)
 .S PHONE=$P($G(^MPIF(984.9,+$O(^MPIF(984.9,"AD",DUZ,""),-1),0)),"^",5)
"RTN","MPIFCMRP",46,0)
 .N DA,DIC,DIQ S DIQ="MPIFNM",DR=".01;.132",DIQ(0)="E",DIC="^VA(200,",DA=DUZ
"RTN","MPIFCMRP",47,0)
 .D EN^DIQ1
"RTN","MPIFCMRP",48,0)
 .S REQNM=MPIFNM(200,DUZ,.01,"E")
"RTN","MPIFCMRP",49,0)
 I '$D(DUZ) S (PHONE,REQNM)=""
"RTN","MPIFCMRP",50,0)
 ;
"RTN","MPIFCMRP",51,0)
REASON S DIR("A")="Reason for Request",DIR("?")="Answer must be 3-60 characters in length.",DIR(0)="F^3:60" D ^DIR
"RTN","MPIFCMRP",52,0)
 I Y="" W !,"Answer must be 3-60 characters in length." G REASON
"RTN","MPIFCMRP",53,0)
 I X="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFCMRP",54,0)
 S DIE="^MPIF(984.9,",DR="1.02///"_X D ^DIE
"RTN","MPIFCMRP",55,0)
REQNM S DIR("A")="Requestor's Name",DIR("B")=REQNM,DIR("?")="Answer must be a valid user",DIR(0)="P^200:EQZ" D ^DIR K DIR("B")
"RTN","MPIFCMRP",56,0)
 I Y="" W !,"Must pick valid user" G REQNM
"RTN","MPIFCMRP",57,0)
 I X="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFCMRP",58,0)
 S PERS=+Y
"RTN","MPIFCMRP",59,0)
 S DIE="^MPIF(984.9,",DR=".02///`"_+Y D ^DIE
"RTN","MPIFCMRP",60,0)
PHONE S DIR("A")="Requestor's Phone",DIR("B")=PHONE,DIR("?")="Answer must be 4-20 charaters in length.",DIR(0)="F" D ^DIR K DIR("B")
"RTN","MPIFCMRP",61,0)
 I Y="" W !,"Answer must be 4-20 charaters in length."  G PHONE
"RTN","MPIFCMRP",62,0)
 I X="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFCMRP",63,0)
 S DIE="^MPIF(984.9,",DR=".05///"_X D ^DIE
"RTN","MPIFCMRP",64,0)
 ;
"RTN","MPIFCMRP",65,0)
CMOR S DIC("A")="Select Site to Be CMOR: ",DIC="^DIC(4,",DIC(0)="QEAM",DIC("S")="I $D(^DGCN(391.91,""APAT"",PAT,Y)) I $$GET1^DIQ(4,+Y_"","",13)=""VAMC"""
"RTN","MPIFCMRP",66,0)
 D ^DIC
"RTN","MPIFCMRP",67,0)
 I X="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFCMRP",68,0)
 N TSITE S TSITE=+Y
"RTN","MPIFCMRP",69,0)
 S DIE="^MPIF(984.9,",DR=".07///`"_TSITE_";1.03///3;.09///`"_TSITE D ^DIE
"RTN","MPIFCMRP",70,0)
 ;update site, type of action and cmor after approval
"RTN","MPIFCMRP",71,0)
 ;
"RTN","MPIFCMRP",72,0)
 I $$CHK^MPIFEDIT(DA) W !,"This request is missing required data." G EDIT
"RTN","MPIFCMRP",73,0)
 ;
"RTN","MPIFCMRP",74,0)
APP S DIR("A")="Select Request Action (SEND/EDIT/DELETE)? ",DIR("B")="SEND",DIR(0)="SAO^SEND:SEND;EDIT:EDIT;DELETE:DELETE"
"RTN","MPIFCMRP",75,0)
 D ^DIR K DIR
"RTN","MPIFCMRP",76,0)
 S DA=TDA
"RTN","MPIFCMRP",77,0)
 I $E(Y)="D"!$D(DIRUT) D  Q
"RTN","MPIFCMRP",78,0)
 .S DIK="^MPIF(984.9," D ^DIK W "... Request deleted"
"RTN","MPIFCMRP",79,0)
 .Q
"RTN","MPIFCMRP",80,0)
 I $E(Y)="E" G REASON
"RTN","MPIFCMRP",81,0)
 S DR=".08////^S X=2;.06////^S X=2",DIE="^MPIF(984.9," D ^DIE W !,"... Request will be sent"
"RTN","MPIFCMRP",82,0)
 ; removed event queue due to delivery issues - this msg must be sent first followed by the actual change cmor msg.
"RTN","MPIFCMRP",83,0)
 N ERR,MPIFHL7 S ERR="ERRS",MPIFHL7=""
"RTN","MPIFCMRP",84,0)
 D EN^MPIFREQ("CMOR CHANGE REQUEST",DA,.ERR,MPIFHL7)
"RTN","MPIFCMRP",85,0)
 ;
"RTN","MPIFCMRP",86,0)
 ;NOW CHANGE CMOR AND SEND CHANGE CMOR MESSAGE
"RTN","MPIFCMRP",87,0)
 N TEXT,DIR,DR,CMOR,TMP,ERROR
"RTN","MPIFCMRP",88,0)
 S TEXT="Auto change - pushed CMOR",ERROR=0
"RTN","MPIFCMRP",89,0)
 S DIE="^MPIF(984.9,",DA=TDA,DR=".06///^S X=4;3.01///^S X=TEXT"
"RTN","MPIFCMRP",90,0)
 D ^DIE
"RTN","MPIFCMRP",91,0)
 S CMOR=$P($G(^MPIF(984.9,TDA,0)),"^",7)
"RTN","MPIFCMRP",92,0)
 I CMOR="" D  Q
"RTN","MPIFCMRP",93,0)
 .W !,"New CMOR Not Defined, edit request"
"RTN","MPIFCMRP",94,0)
 .S ^DIE="^MPIF(984.9,",DA=TDA,DR=".06///^S X=1" D ^DIE
"RTN","MPIFCMRP",95,0)
 S TMP=$$CHANGE^MPIF001(PAT,CMOR)
"RTN","MPIFCMRP",96,0)
 I +TMP<0 S ^DIE="^MPIF(984.9,",DA=TDA,DR=".06///^S X=1" D ^DIE Q
"RTN","MPIFCMRP",97,0)
 D BROAD^MPIFCMOR(DA,.ERROR)
"RTN","MPIFCMRP",98,0)
 Q
"RTN","MPIFEDIT")
0^4^B30259872
"RTN","MPIFEDIT",1,0)
MPIFEDIT ;BHM/RGY-Request a CMOR for patient ;FEB 20, 1998
"RTN","MPIFEDIT",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**11,22,30**;30 Apr 99
"RTN","MPIFEDIT",3,0)
 ;
"RTN","MPIFEDIT",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFEDIT",5,0)
 ;
"RTN","MPIFEDIT",6,0)
 ;   EXC^RGHLLOG     IA #2796
"RTN","MPIFEDIT",7,0)
 ;   START^RGHLLOG   IA #2796
"RTN","MPIFEDIT",8,0)
 ;   STOP^RGHLLOG    IA #2796
"RTN","MPIFEDIT",9,0)
 ;   $$EN^VAFCPID    IA #3015
"RTN","MPIFEDIT",10,0)
 ;
"RTN","MPIFEDIT",11,0)
NEW ;
"RTN","MPIFEDIT",12,0)
 ;Entry point for option: MPIF NEW REQUEST - create a new request
"RTN","MPIFEDIT",13,0)
 ; to change CMOR.  No input or output variables.
"RTN","MPIFEDIT",14,0)
 ;
"RTN","MPIFEDIT",15,0)
 ;Only if the site is not the CMOR can this option be used
"RTN","MPIFEDIT",16,0)
 N DIC,X,Y,DTOUT,DUOUT,PAT
"RTN","MPIFEDIT",17,0)
 S DIC="^DPT(",DIC(0)="QEAMZ",DIC("A")="Select PATIENT: "
"RTN","MPIFEDIT",18,0)
 D ^DIC
"RTN","MPIFEDIT",19,0)
 Q:$D(DTOUT)!$D(DUOUT)!(Y=-1)
"RTN","MPIFEDIT",20,0)
 S PAT=+Y
"RTN","MPIFEDIT",21,0)
 I +$$GETICN^MPIF001(PAT)<0 W !!,"Patient doesn't have ICN, try again" G NEW
"RTN","MPIFEDIT",22,0)
 I $$GETVCCI^MPIF001(PAT)<0 W !!,"Patient doesn't have a CMOR, try again" G NEW
"RTN","MPIFEDIT",23,0)
 I $$GETVCCI^MPIF001(PAT)=$P($$SITE^VASITE(),"^",3) W !!,"You are the CMOR, to push the CMOR to another site use option: PUSH CMOR REQUEST" G NEW
"RTN","MPIFEDIT",24,0)
 ; CHECK IF ALREADY OPEN/PENDING REQUEST
"RTN","MPIFEDIT",25,0)
 N ENT,STOP
"RTN","MPIFEDIT",26,0)
 S ENT=0,STOP=0 F  S ENT=$O(^MPIF(984.9,"C",PAT,ENT)) Q:ENT=""!(STOP)  D
"RTN","MPIFEDIT",27,0)
 .I $P($G(^MPIF(984.9,ENT,0)),"^",6)<4 S STOP=1
"RTN","MPIFEDIT",28,0)
 I STOP W !!,"Already have request for this patient" G NEW
"RTN","MPIFEDIT",29,0)
 ;
"RTN","MPIFEDIT",30,0)
 N N0,PHONE,DA,DIE,DR,DIR,ERROR,DIK,Y,DIRUT,REQ,CMOR,MPIFREQ
"RTN","MPIFEDIT",31,0)
 S DA=$$ADD^MPIFNEW()
"RTN","MPIFEDIT",32,0)
 S DIE="^MPIF(984.9,",DR=".04///`"_PAT D ^DIE
"RTN","MPIFEDIT",33,0)
 S REQ=$P($G(^MPIF(984.9,DA,0)),"^")
"RTN","MPIFEDIT",34,0)
 W !,"REQUEST NUMBER:",REQ
"RTN","MPIFEDIT",35,0)
 S CMOR=$$HL7CMOR^MPIF001($P($G(^MPIF(984.9,DA,0)),"^",4),"^")
"RTN","MPIFEDIT",36,0)
 ;station # ^ Station Name
"RTN","MPIFEDIT",37,0)
 W !,"*** Current CMOR: "_$P(CMOR,"^",2)_" ("_+CMOR_") ***"
"RTN","MPIFEDIT",38,0)
 S DIE="^MPIF(984.9,",DR=".07///"_+CMOR_";1.03///1;.09///`"_+$$SITE^VASITE() D ^DIE
"RTN","MPIFEDIT",39,0)
 ; ^ update site, type of action, and cmor after approval
"RTN","MPIFEDIT",40,0)
 ;
"RTN","MPIFEDIT",41,0)
 S REQ=DA
"RTN","MPIFEDIT",42,0)
EDIT I $D(DUZ) D
"RTN","MPIFEDIT",43,0)
 .S PHONE=$P($G(^MPIF(984.9,+$O(^MPIF(984.9,"AD",DUZ,""),-1),0)),"^",5)
"RTN","MPIFEDIT",44,0)
 .N DA,DIC,DIQ S DIQ="MPIFREQ",DR=".01",DIQ(0)="E",DIC="^VA(200,",DA=DUZ
"RTN","MPIFEDIT",45,0)
 .D EN^DIQ1
"RTN","MPIFEDIT",46,0)
 .S MPIFREQ=MPIFREQ(200,DUZ,.01,"E")
"RTN","MPIFEDIT",47,0)
 I '$D(DUZ) S (MPIFREQ,PHONE)=""
"RTN","MPIFEDIT",48,0)
 ;
"RTN","MPIFEDIT",49,0)
REASON S DIR("A")="Reason for Request",DIR("?")="Answer must be 3-60 characters in length.",DIR(0)="F^3:60" D ^DIR
"RTN","MPIFEDIT",50,0)
 I Y="" W !,"Answer must be 3-60 characters in length." G REASON
"RTN","MPIFEDIT",51,0)
 I Y="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFEDIT",52,0)
 S DIE="^MPIF(984.9,",DR="1.02///"_X D ^DIE
"RTN","MPIFEDIT",53,0)
REQNM S DIR("A")="Requestor's Name:",DIR("B")=MPIFREQ,DIR("?")="Answer must be a valid user",DIR(0)="P^200:EQZ" D ^DIR K DIR("B")
"RTN","MPIFEDIT",54,0)
 I Y="" W !,"Must pick valid user" G REQNM
"RTN","MPIFEDIT",55,0)
 I Y="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFEDIT",56,0)
 S DIE="^MPIF(984.9,",DR=".02///`"_+Y D ^DIE
"RTN","MPIFEDIT",57,0)
PHONE S DIR("A")="Requestor Phone:",DIR("B")=PHONE,DIR("?")="Answer must be 4-20 charaters in length.",DIR(0)="F" D ^DIR K DIR("B")
"RTN","MPIFEDIT",58,0)
 I Y="" W !,"Answer must be 4-20 charaters in length."  G PHONE
"RTN","MPIFEDIT",59,0)
 I Y="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFEDIT",60,0)
 S DIE="^MPIF(984.9,",DR=".05///"_X D ^DIE
"RTN","MPIFEDIT",61,0)
 I $$CHK^MPIFEDIT(DA) W !,"This request is missing required data." G EDIT
"RTN","MPIFEDIT",62,0)
 ;
"RTN","MPIFEDIT",63,0)
APP S DIR("A")="Select Request Action (SEND/EDIT/DELETE)? ",DIR("B")="SEND",DIR(0)="SAO^SEND:SEND;EDIT:EDIT;DELETE:DELETE"
"RTN","MPIFEDIT",64,0)
 D ^DIR K DIR
"RTN","MPIFEDIT",65,0)
 I $E(Y)="D"!$D(DIRUT) D  Q
"RTN","MPIFEDIT",66,0)
 .S DIK="^MPIF(984.9," D ^DIK W "... Request deleted"
"RTN","MPIFEDIT",67,0)
 .Q
"RTN","MPIFEDIT",68,0)
 I $E(Y)="E" G REASON
"RTN","MPIFEDIT",69,0)
 S DR=".08////^S X=2;.06////^S X=2",DIE="^MPIF(984.9," D ^DIE W !,"... Request will be sent"
"RTN","MPIFEDIT",70,0)
 ;
"RTN","MPIFEDIT",71,0)
 I '$D(REQ) S REQ=DA
"RTN","MPIFEDIT",72,0)
 S N0=$G(^MPIF(984.9,REQ,0)),CNT=0
"RTN","MPIFEDIT",73,0)
 I N0="" S ERROR="Node for request #"_REQ_" is not defined" Q
"RTN","MPIFEDIT",74,0)
 S INST=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFEDIT",75,0)
 N X,Y,DIC
"RTN","MPIFEDIT",76,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(N0,"^",2)
"RTN","MPIFEDIT",77,0)
 D ^DIC
"RTN","MPIFEDIT",78,0)
 I $G(Y)<1 S USER=""
"RTN","MPIFEDIT",79,0)
 I $G(Y)>0 S USER=$G(Y(0,0))
"RTN","MPIFEDIT",80,0)
 S REASON=$P($G(^MPIF(984.9,REQ,1)),"^",2)
"RTN","MPIFEDIT",81,0)
 S NDATE=$P(N0,"^",3)
"RTN","MPIFEDIT",82,0)
 S ICN=$$ICN^MPIFNQ(+$P(N0,"^",4))
"RTN","MPIFEDIT",83,0)
 S PHONE=$P(N0,"^",5)
"RTN","MPIFEDIT",84,0)
 S ID=$P(N0,"^")
"RTN","MPIFEDIT",85,0)
 K HLA
"RTN","MPIFEDIT",86,0)
 D INIT^HLFNC2("MPIF CMOR REQUEST",.HL)
"RTN","MPIFEDIT",87,0)
 I $O(HL(""))="" D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQ_" FOR ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG() D RESET^MPIFREQ(REQ) Q
"RTN","MPIFEDIT",88,0)
 K HLL("LINKS") N MPILK
"RTN","MPIFEDIT",89,0)
 S MPILK=$$MPILINK^MPIFAPI ;routing all messages through the MPI
"RTN","MPIFEDIT",90,0)
 I +MPILK<0 D  Q
"RTN","MPIFEDIT",91,0)
 .D START^RGHLLOG()
"RTN","MPIFEDIT",92,0)
 .D EXC^RGHLLOG(224,"No MPI link found for Change CMOR Request # "_REQ_" for ICN="_ICN,$P(N0,"^",4))
"RTN","MPIFEDIT",93,0)
 .D STOP^RGHLLOG()
"RTN","MPIFEDIT",94,0)
 .D RESET^MPIFREQ(REQ)
"RTN","MPIFEDIT",95,0)
 .S ERROR="-1^No Links found"
"RTN","MPIFEDIT",96,0)
 ;Broadcast new CMOR to MPI which will send it out to all sites
"RTN","MPIFEDIT",97,0)
 S HLL("LINKS",1)="MPIF CMOR RESPONSE^"_MPILK
"RTN","MPIFEDIT",98,0)
 S CNT=CNT+1,PID=$$EN^VAFCPID(+$P(N0,"^",4),"1,2,4,5,6,7,8,11,12,13,14,16,17,19")
"RTN","MPIFEDIT",99,0)
 S HLA("HLS",CNT)=PID
"RTN","MPIFEDIT",100,0)
 S CNT=CNT+1
"RTN","MPIFEDIT",101,0)
 S CMOR=$P($$HL7CMOR^MPIF001($P($G(^MPIF(984.9,DA,0)),"^",4),"^"),"^")
"RTN","MPIFEDIT",102,0)
 S HLA("HLS",CNT)="NTE"_HL("FS")_HL("FS")_"P"_HL("FS")_PHONE_HL("FS")_REASON_HL("FS")_HL("FS")_ID_HL("FS")_INST_HL("FS")_HL("FS")_CMOR
"RTN","MPIFEDIT",103,0)
 S CNT=CNT+1
"RTN","MPIFEDIT",104,0)
 S HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_USER
"RTN","MPIFEDIT",105,0)
 N RLST
"RTN","MPIFEDIT",106,0)
 D GENERATE^HLMA("MPIF CMOR REQUEST","LM",1,.RLST,"",.HL)
"RTN","MPIFEDIT",107,0)
 I 'RLST D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQ_" for ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG(),RESET^MPIFREQ(REQ)
"RTN","MPIFEDIT",108,0)
 K CNT,ICN,INST,NDATE,PID,REASON,RGL,USER,XX,ID
"RTN","MPIFEDIT",109,0)
 Q
"RTN","MPIFEDIT",110,0)
 ;
"RTN","MPIFEDIT",111,0)
CHK(IEN) ;
"RTN","MPIFEDIT",112,0)
 N N0,X,ERROR
"RTN","MPIFEDIT",113,0)
 S ERROR=0
"RTN","MPIFEDIT",114,0)
 S N0=$G(^MPIF(984.9,IEN,0))
"RTN","MPIFEDIT",115,0)
 F X=1:1:7 I $P(N0,"^",X)="" S ERROR=1 Q
"RTN","MPIFEDIT",116,0)
 I $P($G(^MPIF(984.9,IEN,1)),"^",2)="" S ERROR=1
"RTN","MPIFEDIT",117,0)
 Q ERROR
"RTN","MPIFREQ")
0^5^B27491051
"RTN","MPIFREQ",1,0)
MPIFREQ ;SF/TN/CMC-CMOR CHANGE REQUEST ;FEB 20, 1998
"RTN","MPIFREQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,6,11,26,30**;30 Apr 99
"RTN","MPIFREQ",3,0)
 ;
"RTN","MPIFREQ",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFREQ",5,0)
 ;
"RTN","MPIFREQ",6,0)
 ;   EXC^RGHLLOG     IA #2796
"RTN","MPIFREQ",7,0)
 ;   START^RGHLLOG   IA #2796
"RTN","MPIFREQ",8,0)
 ;   STOP^RGHLLOG    IA #2796
"RTN","MPIFREQ",9,0)
 ;   $$EN^VAFCPID    IA #3015
"RTN","MPIFREQ",10,0)
 ;
"RTN","MPIFREQ",11,0)
EN(TYPE,REQNO,ERROR,HL7) ;
"RTN","MPIFREQ",12,0)
 ; Create HL7 message for Change of CMOR Request
"RTN","MPIFREQ",13,0)
 N RGL,INST,USER,REASON,NDATE,ICN,PHONE,N0,CNT,HLA,HL,ID,XX,PID
"RTN","MPIFREQ",14,0)
 S CNT=0,HL=0
"RTN","MPIFREQ",15,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFREQ",16,0)
 I N0="" S ERROR="Node for request #"_REQNO_" is not defined" Q
"RTN","MPIFREQ",17,0)
 S INST=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFREQ",18,0)
 N X,Y,DIC
"RTN","MPIFREQ",19,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(N0,"^",2)
"RTN","MPIFREQ",20,0)
 D ^DIC
"RTN","MPIFREQ",21,0)
 I $G(Y)<1 S USER=""
"RTN","MPIFREQ",22,0)
 I $G(Y)>0 S USER=$G(Y(0,0))
"RTN","MPIFREQ",23,0)
 S REASON=$P($G(^MPIF(984.9,REQNO,1)),"^",2)
"RTN","MPIFREQ",24,0)
 S NDATE=$P(N0,"^",3)
"RTN","MPIFREQ",25,0)
 S ICN=$$ICN^MPIFNQ(+$P(N0,"^",4))
"RTN","MPIFREQ",26,0)
 S PHONE=$P(N0,"^",5)
"RTN","MPIFREQ",27,0)
 S ID=$P(N0,"^")
"RTN","MPIFREQ",28,0)
 D INIT^HLFNC2("MPIF CMOR REQUEST",.HL)
"RTN","MPIFREQ",29,0)
 I HL D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQNO_" FOR ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG() D RESET(REQNO) Q
"RTN","MPIFREQ",30,0)
 K HLL("LINKS") N MPILK
"RTN","MPIFREQ",31,0)
 S MPILK=$$MPILINK^MPIFAPI ;routing all messages through the MPI
"RTN","MPIFREQ",32,0)
 I +MPILK<0 D  Q
"RTN","MPIFREQ",33,0)
 .D START^RGHLLOG()
"RTN","MPIFREQ",34,0)
 .D EXC^RGHLLOG(224,"No MPI link found for Change CMOR Request # "_REQNO_" for ICN="_ICN,$P(N0,"^",4))
"RTN","MPIFREQ",35,0)
 .D STOP^RGHLLOG()
"RTN","MPIFREQ",36,0)
 .D RESET^MPIFREQ(REQNO)
"RTN","MPIFREQ",37,0)
 .S ERROR="-1^No Links found"
"RTN","MPIFREQ",38,0)
 ;Broadcast new CMOR to MPI which will send it out to all sites
"RTN","MPIFREQ",39,0)
 S HLL("LINKS",1)="MPIF CMOR RESPONSE^"_MPILK
"RTN","MPIFREQ",40,0)
 S CNT=CNT+1,PID=$$EN^VAFCPID(+$P(N0,"^",4),"1,2,4,5,6,7,8,11,12,13,14,16,17,19")
"RTN","MPIFREQ",41,0)
 S HLA("HLS",CNT)=PID
"RTN","MPIFREQ",42,0)
 S CNT=CNT+1
"RTN","MPIFREQ",43,0)
 S CMOR=$P(^MPIF(984.9,REQNO,0),"^",9),CMOR=$$STA^XUAF4(CMOR)
"RTN","MPIFREQ",44,0)
 S HLA("HLS",CNT)="NTE"_HL("FS")_HL("FS")_"P"_HL("FS")_PHONE_HL("FS")_REASON_HL("FS")_HL("FS")_ID_HL("FS")_INST_HL("FS")_HL("FS")_CMOR
"RTN","MPIFREQ",45,0)
 S CNT=CNT+1
"RTN","MPIFREQ",46,0)
 S HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_USER
"RTN","MPIFREQ",47,0)
 N RLST
"RTN","MPIFREQ",48,0)
 D GENERATE^HLMA("MPIF CMOR REQUEST","LM",1,.RLST,"",.HL)
"RTN","MPIFREQ",49,0)
 I 'RLST D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQNO_" for ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG(),RESET(REQNO)
"RTN","MPIFREQ",50,0)
 Q
"RTN","MPIFREQ",51,0)
 ;
"RTN","MPIFREQ",52,0)
RESET(REQNO) ; reset status to Open
"RTN","MPIFREQ",53,0)
 S DIE="^MPIF(984.9,",DA=REQNO,DR=".06///1" D ^DIE
"RTN","MPIFREQ",54,0)
 K DIE,DA,DR
"RTN","MPIFREQ",55,0)
 Q
"RTN","MPIFREQ",56,0)
 ;
"RTN","MPIFREQ",57,0)
IN(INST,USER,REASON,NDATE,ICN,PHONE,ID) ;Process an incoming CMOR request
"RTN","MPIFREQ",58,0)
 N PATIEN,MAIL,MPIF,TYPE,N0,IEN,XMCHAN,XMDUZ,XMTEXT,XMSUB,XMY,TEXT,X
"RTN","MPIFREQ",59,0)
 S PATIEN=$$GETDFN^MPIF001(ICN)
"RTN","MPIFREQ",60,0)
 I PATIEN<1 D  Q
"RTN","MPIFREQ",61,0)
 . D START^RGHLLOG()
"RTN","MPIFREQ",62,0)
 . D EXC^RGHLLOG(210,"Received CMOR Change Request for ICN "_ICN_" ICN not Found. Request # "_ID)
"RTN","MPIFREQ",63,0)
 . D STOP^RGHLLOG()
"RTN","MPIFREQ",64,0)
 S IEN=$$ADD^MPIFNEW(ID) ;add request to request file
"RTN","MPIFREQ",65,0)
 S TYPE=2 ;type of action to Request Received From
"RTN","MPIFREQ",66,0)
 S INST=$G(HL("SFN")) ; site that sent this message
"RTN","MPIFREQ",67,0)
 S DIE="^MPIF(984.9,",DA=IEN,DR="[MPIF REQUEST INCOMING]" D ^DIE
"RTN","MPIFREQ",68,0)
 I $$IFVCCI^MPIF001(+PATIEN)=-1 D PUSH(IEN) Q
"RTN","MPIFREQ",69,0)
 ; ^ your site isn't the CMOR, so this is a push to make you the CMOR
"RTN","MPIFREQ",70,0)
 S DIE="^MPIF(984.9,",DA=IEN,DR=".09///"_INST D ^DIE
"RTN","MPIFREQ",71,0)
 ; ^ update CMOR AFTER APPROVAL field
"RTN","MPIFREQ",72,0)
 I $$AUTO^MPIFNQ() D AUTO(IEN) Q
"RTN","MPIFREQ",73,0)
 S MAIL=$$MAIL^MPIFUTL()
"RTN","MPIFREQ",74,0)
 I MAIL="" S MAIL="MPIF EXCEPTIONS"
"RTN","MPIFREQ",75,0)
 S XMDUZ="MPI VISTA Package",XMTEXT="MPIF(1,",MPIF(1,1)="New Coordinating Master Of Record (CMOR) request received for patient "_$S($P($G(^DPT(+PATIEN,0)),U)]"":$P(^DPT(PATIEN,0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",1:"UNKNOWN")
"RTN","MPIFREQ",76,0)
 I MAIL="MPIF EXCEPTIONS" S XMTEXT=XMTEXT_" no mail group defined for CMOR requests"
"RTN","MPIFREQ",77,0)
 S XMSUB="CMOR Change Request #"_$P(^MPIF(984.9,IEN,0),"^"),XMY("G."_MAIL)="" D ^XMD
"RTN","MPIFREQ",78,0)
 Q
"RTN","MPIFREQ",79,0)
 ;
"RTN","MPIFREQ",80,0)
AUTO(REQNO) ;Process a request automatically
"RTN","MPIFREQ",81,0)
 N DFN,MPIFERR,DIE,DR,DA,CMOR,RES,CMORN
"RTN","MPIFREQ",82,0)
 S MPIFERR=0
"RTN","MPIFREQ",83,0)
 S DIE="^MPIF(984.9,",DR="[MPIF REVIEW AUTO]",DA=REQNO D ^DIE
"RTN","MPIFREQ",84,0)
 S DFN=$P($G(^MPIF(984.9,REQNO,0)),"^",4)
"RTN","MPIFREQ",85,0)
 S CMORN=$P($G(^MPIF(984.9,REQNO,0)),"^",7)
"RTN","MPIFREQ",86,0)
 S CMOR=$$CMORNAME^MPIF001(CMORN)
"RTN","MPIFREQ",87,0)
 I +CMOR=-1 D START^RGHLLOG(),EXC^RGHLLOG(220,"CMOR not sent in Change CMOR message for patient DFN= "_DFN_" Request # "_REQNO,DFN),STOP^RGHLLOG(),RESET2(REQNO)
"RTN","MPIFREQ",88,0)
 Q:+CMOR=-1      ;No CMOR defined
"RTN","MPIFREQ",89,0)
 I $P($G(^MPIF(984.9,REQNO,1)),"^",3)=2 D
"RTN","MPIFREQ",90,0)
 .S RES=1,RES=$$CHANGE^MPIF001(DFN,CMORN)
"RTN","MPIFREQ",91,0)
 .I +RES<1 I +RES<1 D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to Change CMOR to "_CMOR_" in a CMOR Change Message for Patient DFN= "_DFN_" Request # "+REQNO,DFN),STOP^RGHLLOG(),RESET2(REQNO)
"RTN","MPIFREQ",92,0)
 .Q:+RES<1
"RTN","MPIFREQ",93,0)
 .D BROAD^MPIFCMOR(REQNO,.MPIFERR)
"RTN","MPIFREQ",94,0)
 .I +MPIFERR=0 D EN^MPIFRESS(REQNO)
"RTN","MPIFREQ",95,0)
 .; ^ trigger approval msg
"RTN","MPIFREQ",96,0)
 Q
"RTN","MPIFREQ",97,0)
 ;
"RTN","MPIFREQ",98,0)
RESET2(REQNO) ; reset status to Pending Approval
"RTN","MPIFREQ",99,0)
 S DIE="^MPIF(984.9,",DA=REQNO,DR=".06///3" D ^DIE
"RTN","MPIFREQ",100,0)
 K DIE,DA,DR
"RTN","MPIFREQ",101,0)
 Q
"RTN","MPIFREQ",102,0)
 ;
"RTN","MPIFREQ",103,0)
PUSH(IEN) ;Change of CMOR Request is a Push
"RTN","MPIFREQ",104,0)
 ; just want to get request into 984.9 for
"RTN","MPIFREQ",105,0)
 ; tracking purposes, marking it as approved
"RTN","MPIFREQ",106,0)
 N DA,DIE,X,Y,TEXT
"RTN","MPIFREQ",107,0)
 S DIE="^MPIF(984.9,",DA=IEN,TEXT="Auto change - CMOR pushed here"
"RTN","MPIFREQ",108,0)
 S DR=".06///4;1.03///4;3.01///"_TEXT_";.09///`"_+$$SITE^VASITE()
"RTN","MPIFREQ",109,0)
 D ^DIE
"RTN","MPIFREQ",110,0)
 Q
"RTN","MPIFRESS")
0^3^B18945709
"RTN","MPIFRESS",1,0)
MPIFRESS ;BHM/RGY-Process a CMOR result ;FEB 27, 1998
"RTN","MPIFRESS",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,6,11,30**;30 Apr 99
"RTN","MPIFRESS",3,0)
 ;
"RTN","MPIFRESS",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFRESS",5,0)
 ;
"RTN","MPIFRESS",6,0)
 ;   EXC^RGHLLOG     IA #2796
"RTN","MPIFRESS",7,0)
 ;   START^RGHLLOG   IA #2796
"RTN","MPIFRESS",8,0)
 ;   STOP^RGHLLOG    IA #2796
"RTN","MPIFRESS",9,0)
 ;   $$EN^VAFCPID    IA #3015
"RTN","MPIFRESS",10,0)
 ;
"RTN","MPIFRESS",11,0)
EN(REQNO) ;
"RTN","MPIFRESS",12,0)
 N RGL,ID,COMMENTS,STATUS,NDATE,PHONE,REVIEWER,N0,CNT,HL,HLA,XX,ERROR
"RTN","MPIFRESS",13,0)
 S CNT=0,HL=0
"RTN","MPIFRESS",14,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFRESS",15,0)
 I N0="" D  Q
"RTN","MPIFRESS",16,0)
 .D START^RGHLLOG()
"RTN","MPIFRESS",17,0)
 .D EXC^RGHLLOG(210,"CMOR Request # "_REQNO_" Does Not Exist attempting to generate approved/not approved msg")
"RTN","MPIFRESS",18,0)
 .D STOP^RGHLLOG()
"RTN","MPIFRESS",19,0)
 S ID=$P(N0,"^")
"RTN","MPIFRESS",20,0)
 S STATUS=$P(N0,"^",6)
"RTN","MPIFRESS",21,0)
 S COMMENTS=$P($G(^MPIF(984.9,REQNO,3)),"^",2)
"RTN","MPIFRESS",22,0)
 I $P($G(^MPIF(984.9,REQNO,3)),"^")]"" S REVIEWER=$P(^(3),"^")
"RTN","MPIFRESS",23,0)
 I $P($G(^MPIF(984.9,REQNO,3)),"^")']"" D
"RTN","MPIFRESS",24,0)
 .N DIC,X,Y
"RTN","MPIFRESS",25,0)
 .S DIC="^VA(200,",DIC(0)="ZMO",X="`"_+$P(^MPIF(984.9,REQNO,2),"^")
"RTN","MPIFRESS",26,0)
 .D ^DIC
"RTN","MPIFRESS",27,0)
 .I $G(Y)>1 S REVIEWER=$G(Y(0,0))
"RTN","MPIFRESS",28,0)
 .I $G(Y)<1 S REVIEWER=""
"RTN","MPIFRESS",29,0)
 S NDATE=$P($G(^MPIF(984.9,REQNO,2)),"^",2)
"RTN","MPIFRESS",30,0)
 S PHONE=$P($G(^MPIF(984.9,REQNO,2)),"^",3)
"RTN","MPIFRESS",31,0)
 S COMMENTS=$P($G(^MPIF(984.9,REQNO,3)),"^",2)
"RTN","MPIFRESS",32,0)
 K HLA
"RTN","MPIFRESS",33,0)
 D INIT^HLFNC2("MPIF CMOR APPROVE/DISAPPROVE",.HL)
"RTN","MPIFRESS",34,0)
 I HL S ERROR=HL D  Q
"RTN","MPIFRESS",35,0)
 .D START^RGHLLOG()
"RTN","MPIFRESS",36,0)
 .D EXC^RGHLLOG(220,"Unable to setup HL7 for Change CMOR Request # "_REQNO_" for Approved/Not Approved msg HL Error"_HL,$P(N0,"^",4))
"RTN","MPIFRESS",37,0)
 .D STOP^RGHLLOG()
"RTN","MPIFRESS",38,0)
 K HLL("LINKS") N MPILK
"RTN","MPIFRESS",39,0)
 S MPILK=$$MPILINK^MPIFAPI ;routing all messages through the MPI
"RTN","MPIFRESS",40,0)
 I +MPILK<0 D  Q
"RTN","MPIFRESS",41,0)
 .D START^RGHLLOG()
"RTN","MPIFRESS",42,0)
 .D EXC^RGHLLOG(224,"No MPI link found for Change CMOR Request # "_REQNO_" for ICN="_ICN,DFN)
"RTN","MPIFRESS",43,0)
 .D STOP^RGHLLOG()
"RTN","MPIFRESS",44,0)
 .S ERROR="-1^LINK FOR MPI NOT FOUND"
"RTN","MPIFRESS",45,0)
 ;Broadcast MSG to MPI which will send it to the requestor site
"RTN","MPIFRESS",46,0)
 S HLL("LINKS",1)="MPIF CMOR APP/DIS^"_MPILK
"RTN","MPIFRESS",47,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_REVIEWER
"RTN","MPIFRESS",48,0)
 S CNT=CNT+1,HLA("HLS",CNT)="NTE"_HL("FS")_HL("FS")_"P"_HL("FS")_PHONE_HL("FS")_COMMENTS_HL("FS")_STATUS_HL("FS")_ID
"RTN","MPIFRESS",49,0)
 S CNT=CNT+1,HLA("HLS",CNT)=$$EN^VAFCPID(+$P(N0,"^",4),"1,2,4,5,6,7,8,11,12,13,14,16,17,19")
"RTN","MPIFRESS",50,0)
 N RLST
"RTN","MPIFRESS",51,0)
 D GENERATE^HLMA("MPIF CMOR APPROVE/DISAPPROVE","LM",1,.RLST,"",.HL)
"RTN","MPIFRESS",52,0)
 I 'RLST S ERROR=RLST D START^RGHLLOG(),EXC^RGHLLOG(220,"Error Generating HL7 msg for Approve/Not Approved CMOR Request # "_REQNO,$P(N0,"^",4))
"RTN","MPIFRESS",53,0)
 Q
"RTN","MPIFRESS",54,0)
 ;
"RTN","MPIFRESS",55,0)
IN ;
"RTN","MPIFRESS",56,0)
 ; Processing approve/not approve msg to update Request in 984.9 file
"RTN","MPIFRESS",57,0)
 N DFN,ENT,XMY,XMDUZ,XMTEXT,MPIF,XMSUB,FSITE,CMOR,PHONE,RESULT,REVIEWER,COMMENTS,NDATE,II,ICN
"RTN","MPIFRESS",58,0)
 S (HLQUIT,ID,COMMENTS,PHONE,REVIEWER)=""
"RTN","MPIFRESS",59,0)
 F II=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFRESS",60,0)
 .I $P(HLNODE,HL("FS"),1)="NTE" D
"RTN","MPIFRESS",61,0)
 ..S ID=$P(HLNODE,HL("FS"),7),RESULT=$P(HLNODE,HL("FS"),6)
"RTN","MPIFRESS",62,0)
 ..S PHONE=$P(HLNODE,HL("FS"),4)
"RTN","MPIFRESS",63,0)
 ..S COMMENTS=$P(HLNODE,HL("FS"),5)
"RTN","MPIFRESS",64,0)
 .I $P(HLNODE,HL("FS"),1)="EVN" D
"RTN","MPIFRESS",65,0)
 ..S NDATE=$P(HLNODE,HL("FS"),3)
"RTN","MPIFRESS",66,0)
 ..S REVIEWER=$P(HLNODE,HL("FS"),6)
"RTN","MPIFRESS",67,0)
 .I $P(HLNODE,HL("FS"),1)="PID" D
"RTN","MPIFRESS",68,0)
 ..S ICN=+$P(HLNODE,HL("FS"),3)
"RTN","MPIFRESS",69,0)
 S ENT=$O(^MPIF(984.9,"B",ID,0))
"RTN","MPIFRESS",70,0)
 ;; CHANGE FOR NOIS MAD-0900-42526
"RTN","MPIFRESS",71,0)
 I ENT="" D
"RTN","MPIFRESS",72,0)
 .D START^RGHLLOG()
"RTN","MPIFRESS",73,0)
 .D EXC^RGHLLOG(210,"CMOR Request # "_ID_" Does Not Exist CMORs may be out of sync for ICN "_ICN_". HL7 msg# "_HL("MID"))
"RTN","MPIFRESS",74,0)
 .D STOP^RGHLLOG()
"RTN","MPIFRESS",75,0)
 Q:ENT=""
"RTN","MPIFRESS",76,0)
 Q:'$D(^MPIF(984.9,ENT,0))
"RTN","MPIFRESS",77,0)
 S DFN=$P($G(^MPIF(984.9,ENT,0)),"^",4),FSITE=$P($G(^(0)),"^",7)
"RTN","MPIFRESS",78,0)
 S DIC="^DIC(4,",DIC(0)="MXNZ",X=FSITE D ^DIC
"RTN","MPIFRESS",79,0)
 I $G(Y)>0 S FSITE=$P(Y,"^",2)
"RTN","MPIFRESS",80,0)
 K Y,X,DIC
"RTN","MPIFRESS",81,0)
 S DIE="^MPIF(984.9,",DA=ENT,DR="[MPIF RESULT INCOMING]" D ^DIE K DIE,DA,DR
"RTN","MPIFRESS",82,0)
 S XMDUZ="MPI VISTA Package"
"RTN","MPIFRESS",83,0)
 S XMSUB="Request "_ID_" is "_$S(RESULT=4:"approved",1:"disapproved")
"RTN","MPIFRESS",84,0)
 N REQR S REQR=$P($G(^MPIF(984.9,ENT,0)),"^",2) I REQR="" S REQR="AUTO"
"RTN","MPIFRESS",85,0)
 S XMY(REQR)="",XMTEXT="MPIF(1,"
"RTN","MPIFRESS",86,0)
 S MPIF(1,1)=FSITE_" received CMOR request for "_$P($G(^DPT(+$P(^MPIF(984.9,ENT,0),"^",4),0)),"^")_" ("_$E($P(^(0),"^",9),6,9)_")."
"RTN","MPIFRESS",87,0)
 S MPIF(1,2)=XMSUB_"."
"RTN","MPIFRESS",88,0)
 S MPIF(1,3)="Processed by: "_$G(REVIEWER)
"RTN","MPIFRESS",89,0)
 S MPIF(1,4)="Phone: "_$G(PHONE)
"RTN","MPIFRESS",90,0)
 S MPIF(1,5)="Comments: "_$G(COMMENTS)
"RTN","MPIFRESS",91,0)
 D ^XMD
"RTN","MPIFRESS",92,0)
 Q
"VER")
8.0^22.0
**END**
**END**
