Released DVBA*2.7*14 SEQ #15
Extracted from mail message
**KIDS**:DVBA*2.7*14^

**INSTALL NAME**
DVBA*2.7*14
"BLD",711,0)
DVBA*2.7*14^AUTOMATED MED INFO EXCHANGE^0^^y
"BLD",711,4,0)
^9.64PA^^
"BLD",711,"ABPKG")
n
"BLD",711,"INIT")
UPDATE^DVBA2714
"BLD",711,"KRN",0)
^9.67PA^19^18
"BLD",711,"KRN",.4,0)
.4
"BLD",711,"KRN",.401,0)
.401
"BLD",711,"KRN",.402,0)
.402
"BLD",711,"KRN",.403,0)
.403
"BLD",711,"KRN",.5,0)
.5
"BLD",711,"KRN",.84,0)
.84
"BLD",711,"KRN",3.6,0)
3.6
"BLD",711,"KRN",3.8,0)
3.8
"BLD",711,"KRN",9.2,0)
9.2
"BLD",711,"KRN",9.8,0)
9.8
"BLD",711,"KRN",9.8,"NM",0)
^9.68A^8^7
"BLD",711,"KRN",9.8,"NM",1,0)
DVBAREG1^^0^B29321037
"BLD",711,"KRN",9.8,"NM",2,0)
DVBAREG2^^0^B32322277
"BLD",711,"KRN",9.8,"NM",4,0)
DVBAREN1^^0^B20734249
"BLD",711,"KRN",9.8,"NM",5,0)
DVBADSNT^^0^B21575590
"BLD",711,"KRN",9.8,"NM",6,0)
DVBAPND1^^0^B16928596
"BLD",711,"KRN",9.8,"NM",7,0)
DVBADSCK^^0^B20187515
"BLD",711,"KRN",9.8,"NM",8,0)
DVBAFINL^^0^B8259541
"BLD",711,"KRN",9.8,"NM","B","DVBADSCK",7)

"BLD",711,"KRN",9.8,"NM","B","DVBADSNT",5)

"BLD",711,"KRN",9.8,"NM","B","DVBAFINL",8)

"BLD",711,"KRN",9.8,"NM","B","DVBAPND1",6)

"BLD",711,"KRN",9.8,"NM","B","DVBAREG1",1)

"BLD",711,"KRN",9.8,"NM","B","DVBAREG2",2)

"BLD",711,"KRN",9.8,"NM","B","DVBAREN1",4)

"BLD",711,"KRN",19,0)
19
"BLD",711,"KRN",19.1,0)
19.1
"BLD",711,"KRN",101,0)
101
"BLD",711,"KRN",409.61,0)
409.61
"BLD",711,"KRN",771,0)
771
"BLD",711,"KRN",869.2,0)
869.2
"BLD",711,"KRN",870,0)
870
"BLD",711,"KRN",8994,0)
8994
"BLD",711,"KRN","B",.4,.4)

"BLD",711,"KRN","B",.401,.401)

"BLD",711,"KRN","B",.402,.402)

"BLD",711,"KRN","B",.403,.403)

"BLD",711,"KRN","B",.5,.5)

"BLD",711,"KRN","B",.84,.84)

"BLD",711,"KRN","B",3.6,3.6)

"BLD",711,"KRN","B",3.8,3.8)

"BLD",711,"KRN","B",9.2,9.2)

"BLD",711,"KRN","B",9.8,9.8)

"BLD",711,"KRN","B",19,19)

"BLD",711,"KRN","B",19.1,19.1)

"BLD",711,"KRN","B",101,101)

"BLD",711,"KRN","B",409.61,409.61)

"BLD",711,"KRN","B",771,771)

"BLD",711,"KRN","B",869.2,869.2)

"BLD",711,"KRN","B",870,870)

"BLD",711,"KRN","B",8994,8994)

"BLD",711,"PRE")
DVBA2714
"BLD",711,"QUES",0)
^9.62^^
"BLD",711,"REQB",0)
^9.611^1^1
"BLD",711,"REQB",1,0)
SD*5.3*131^2
"BLD",711,"REQB","B","SD*5.3*131",1)

"INIT")
UPDATE^DVBA2714
"OER",223,0)
223^DVBA
"OER",223,1,0)
^100.9951PA^5^5
"OER",223,1,1,0)
634
"OER",223,1,1,1,0)
^100.99511PA^1^1
"OER",223,1,1,1,1,0)
1106
"OER",223,1,2,0)
635
"OER",223,1,2,1,0)
^100.99511PA^1^1
"OER",223,1,2,1,1,0)
1106
"OER",223,1,3,0)
644
"OER",223,1,3,1,0)
^100.99511PA^1^1
"OER",223,1,3,1,1,0)
1106
"OER",223,1,4,0)
642
"OER",223,1,4,1,0)
^100.99511PA^2^2
"OER",223,1,4,1,1,0)
1106
"OER",223,1,4,1,2,0)
1303
"OER",223,1,5,0)
1305
"OER",223,1,5,1,0)
^100.99511PA^1^1
"OER",223,1,5,1,1,0)
414
"PKG",223,-1)
1^1
"PKG",223,0)
AUTOMATED MED INFO EXCHANGE^DVBA^The entire AMIE package 7131/2507.
"PKG",223,22,0)
^9.49I^1^1
"PKG",223,22,1,0)
2.7^2950410^2950508
"PKG",223,22,1,"PAH",1,0)
14^2980116^12537
"PKG",223,22,1,"PAH",1,1,0)
^^1^1^2980116
"PKG",223,22,1,"PAH",1,1,1,0)
ACRP Database conversion software changes patch.
"PRE")
DVBA2714
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","DVBA2714")
0^^B901664
"RTN","DVBA2714",1,0)
DVBA2714 ;ALB/ABR - ENVIRONMENT CHECK ROUTINE;16-JAN-1998
"RTN","DVBA2714",2,0)
 ;;2.7;AMIE;**14**;Apr 10, 1995
"RTN","DVBA2714",3,0)
 ;
"RTN","DVBA2714",4,0)
EN ;Main entry point for patch DVBA*2.7*14 environment check routine
"RTN","DVBA2714",5,0)
 ;
"RTN","DVBA2714",6,0)
 ;Input  : All variables set by KIDS
"RTN","DVBA2714",7,0)
 ;Output : Variables required by KIDS to denote success or failure
"RTN","DVBA2714",8,0)
 ;         of environment check (XPDQUIT and XPDABORT)
"RTN","DVBA2714",9,0)
 ;
"RTN","DVBA2714",10,0)
 N PATCHED
"RTN","DVBA2714",11,0)
 ;
"RTN","DVBA2714",12,0)
 ;Check for installation of DVBA*2.7*15 - required for install
"RTN","DVBA2714",13,0)
 I $T(+2^DVBADSCK)'["15" D
"RTN","DVBA2714",14,0)
 .W !!,"      *** Required element missing ***"
"RTN","DVBA2714",15,0)
 .W !,"      Installation of this patch requires patch DVBA*2.7*15"
"RTN","DVBA2714",16,0)
 .W !
"RTN","DVBA2714",17,0)
 .S XPDABORT=2
"RTN","DVBA2714",18,0)
 Q
"RTN","DVBA2714",19,0)
UPDATE ;  update package file for patch DVBA*2.7*15
"RTN","DVBA2714",20,0)
 N PATCH,PKG,UPD
"RTN","DVBA2714",21,0)
 S PATCH="15 SEQ #14^"_DT_"^.05"
"RTN","DVBA2714",22,0)
 S PKG=$O(^DIC(9.4,"B","AUTOMATED MED INFO EXCHANGE",0)) Q:'PKG
"RTN","DVBA2714",23,0)
 S UPD=$$PKGPAT^XPDIP(PKG,2.7,.PATCH)
"RTN","DVBA2714",24,0)
 Q
"RTN","DVBADSCK")
0^7^B20187515
"RTN","DVBADSCK",1,0)
DVBADSCK ;ALB/GTS-557/THM-DISCHARGE CHECKER ;21 JUL 89
"RTN","DVBADSCK",2,0)
 ;;2.7;AMIE;**15,14**;Apr 10, 1995
"RTN","DVBADSCK",3,0)
 ;
"RTN","DVBADSCK",4,0)
 S DVBAMAN=""
"RTN","DVBADSCK",5,0)
 D NOPARM^DVBAUTL2 G:$D(DVBAQUIT) KILL
"RTN","DVBADSCK",6,0)
 S HD="MANUAL 7132 PROCESSING" D HOME^%ZIS K ^TMP($J)
"RTN","DVBADSCK",7,0)
DATE S %DT(0)=-DT,%DT="AE",%DT("A")="Enter BEGINNING date: "
"RTN","DVBADSCK",8,0)
 W @IOF,!?(IOM-$L(HD)\2),HD,!!!
"RTN","DVBADSCK",9,0)
 D ^%DT G:Y<0 KILL S (BDATE,BDATE1)=Y,BDATE=BDATE-.1
"RTN","DVBADSCK",10,0)
 S %DT("A")="     and ENDING date: ",%DT="AE" D ^%DT G:Y<0 DATE S (EDATE1,EDATE)=Y,EDATE=EDATE+.5
"RTN","DVBADSCK",11,0)
 I EDATE<BDATE W *7,!!,"Invalid date sequence." H 3 G DATE
"RTN","DVBADSCK",12,0)
 K %DT S Y=DT X ^DD("DD") S FDT(0)=Y
"RTN","DVBADSCK",13,0)
 W !! S %ZIS="AEQ",%ZIS("A")="Enter output device: " D ^%ZIS K %ZIS G:POP KILL
"RTN","DVBADSCK",14,0)
 I $D(IO("Q")) S ZTRTN="DATA^DVBADSCK",ZTIO=ION,NOASK=1,ZTDESC="AMIE Discharge Checker" F I="BDATE*","EDATE*","FDT(0)","HD","NOASK","DVBAMAN" S ZTSAVE(I)=""
"RTN","DVBADSCK",15,0)
 I $D(IO("Q")) D ^%ZTLOAD W:$D(ZTSK) !!,"Request queued.",! G KILL
"RTN","DVBADSCK",16,0)
 G DATA
"RTN","DVBADSCK",17,0)
 ;
"RTN","DVBADSCK",18,0)
ZTM D NOPARM^DVBAUTL2 G:$D(DVBAQUIT) KILL
"RTN","DVBADSCK",19,0)
 I '$D(DT) S X="T" D ^%DT S DT=Y
"RTN","DVBADSCK",20,0)
 S Y=DT X ^DD("DD") S FDT(0)=Y
"RTN","DVBADSCK",21,0)
 K ^TMP($J) S X="T-1" D ^%DT Q:Y<0  S (BDATE,BDATE1)=Y,BDATE=Y-.1,(EDATE1,EDATE)=Y,EDATE=Y+.5 G DATA
"RTN","DVBADSCK",22,0)
 ;
"RTN","DVBADSCK",23,0)
CHK ;* Find the IFN of the 7131 which matches the admission date (If a 7131
"RTN","DVBADSCK",24,0)
 ;*  exists).
"RTN","DVBADSCK",25,0)
 F XDA=0:0 S XDA=$O(^DVB(396,"B",DFN,XDA)) Q:XDA=""  I $P(^DVB(396,XDA,0),U,4)=ADMDT&($P(^DVB(396,XDA,2),"^",10)="A") Q
"RTN","DVBADSCK",26,0)
 Q
"RTN","DVBADSCK",27,0)
 ;
"RTN","DVBADSCK",28,0)
SET ;* Set up TMP global of admissions for discharges within range
"RTN","DVBADSCK",29,0)
 S DFN=DA,VAINDT=$S($D(^DGPM(+MB,0)):$P(^(0),U,1),1:""),VAINDT=VAINDT-.000002,VA200="" D INP^VADPT K VA200 S ADMDT=$P(VAIN(7),U,1),ADMNUM=VAIN(1)
"RTN","DVBADSCK",30,0)
 ;I ADMDT]"" S ADMDT=$P(ADMDT,".",1)
"RTN","DVBADSCK",31,0)
 Q:ADMDT=""  S ^TMP($J,ADMDT,+ADMNUM,DA)=""
"RTN","DVBADSCK",32,0)
 Q
"RTN","DVBADSCK",33,0)
 ;
"RTN","DVBADSCK",34,0)
SET1 ;* Get the discharge type and execute CREATE and CREAT1 as needed
"RTN","DVBADSCK",35,0)
 S DCHPTR=$P(^DGPM(LADM,0),U,17),TDIS=$S($D(^DGPM(+DCHPTR,0)):$P(^(0),U,18),1:"") I TDIS="" S TDIS="Unknown discharge type"
"RTN","DVBADSCK",36,0)
 S:'$D(^DG(405.2,+TDIS,0)) TDIS="Unknown discharge type" I $D(^(0)) S TDIS=$S($P(^DG(405.2,+TDIS,0),U,1)]"":$P(^(0),U,1),1:"Unknown discharge type")
"RTN","DVBADSCK",37,0)
 I XDA]"",$D(^DVB(396,XDA,0)) D CREATE Q
"RTN","DVBADSCK",38,0)
 I TDIS["DEATH"!(TDIS["TO CNH") D CREAT1
"RTN","DVBADSCK",39,0)
 Q
"RTN","DVBADSCK",40,0)
 ;
"RTN","DVBADSCK",41,0)
LOOK ;* Loop through Admission Date TMP global execute CHK and SET1
"RTN","DVBADSCK",42,0)
 K MA,DA,MB F ADMDT=0:0 S ADMDT=$O(^TMP($J,ADMDT)) Q:ADMDT=""  F LADM=0:0 S LADM=$O(^TMP($J,ADMDT,LADM)) Q:LADM=""  F DFN=0:0 S DFN=$O(^TMP($J,ADMDT,LADM,DFN)) Q:DFN=""  D CHK,SET1
"RTN","DVBADSCK",43,0)
 Q
"RTN","DVBADSCK",44,0)
 ;
"RTN","DVBADSCK",45,0)
DATA U IO W:(IOST?1"C-".E) @IOF
"RTN","DVBADSCK",46,0)
 W !,"Notices of discharge created on "_FDT(0)_" for discharge date range " S Y=$P(BDATE1,".",1) X ^DD("DD") W Y," TO " S Y=$P(EDATE1,".",1) X ^DD("DD") W Y,!!!
"RTN","DVBADSCK",47,0)
 W "Name",?35,"SSN",?50,"Admission date",! F LINE=1:1:IOM W "-"
"RTN","DVBADSCK",48,0)
 ;
"RTN","DVBADSCK",49,0)
 ;* Set up XRO array containing regional office station numbers
"RTN","DVBADSCK",50,0)
 ;*  contained in the AMIE Site Parameter File
"RTN","DVBADSCK",51,0)
 ;
"RTN","DVBADSCK",52,0)
 F I=0:0 S I=$O(^DVB(396.1,1,1,I)) Q:I=""!(+I=0)  S J=$P(^(I,0),U,1),J=$S($D(^DIC(4,+J,99)):$P(^(99),U),1:"") I J]"" S XRO(J)=""
"RTN","DVBADSCK",53,0)
 ;
"RTN","DVBADSCK",54,0)
 ;* Loop through Discharges ("AMV3") within entered date range DO SET
"RTN","DVBADSCK",55,0)
 ;*  when a discharge is found
"RTN","DVBADSCK",56,0)
 ;
"RTN","DVBADSCK",57,0)
 W !! S COUNT=0,MA=BDATE F J=0:0 S MA=$O(^DGPM("AMV3",MA)) Q:$P(MA,".")>EDATE!(MA="")  F DA=0:0 S DA=$O(^DGPM("AMV3",MA,DA)) Q:DA=""  F MB=0:0 S MB=$O(^DGPM("AMV3",MA,DA,MB)) Q:MB=""  I MA'>EDATE D SET
"RTN","DVBADSCK",58,0)
 ;
"RTN","DVBADSCK",59,0)
 ;* Loop through admission date TMP global
"RTN","DVBADSCK",60,0)
 ;
"RTN","DVBADSCK",61,0)
 D LOOK W @IOF,!!!,"Notice to MAS operator on ",FDT(0),!!! I '$D(NEW) W "There were no NOTICES OF DISCHARGE to create.",!!!
"RTN","DVBADSCK",62,0)
 I $D(NEW) W "There ",$S(COUNT=1:"was ",1:"were ")_COUNT_$S(COUNT=1:" notice",1:" notices")_" of discharge created.",!!!
"RTN","DVBADSCK",63,0)
 ;
"RTN","DVBADSCK",64,0)
KILL I $D(DVBAMAN)&($D(ZTQUEUED)) D KILL^%ZTLOAD
"RTN","DVBADSCK",65,0)
 K NEW,COUNT,XRO G KILL^DVBAUTIL
"RTN","DVBADSCK",66,0)
 ;
"RTN","DVBADSCK",67,0)
CREATE ;create notice
"RTN","DVBADSCK",68,0)
 ;* If a Notice of Discharge is requested on 7131, created it
"RTN","DVBADSCK",69,0)
 I $D(^DVB(396,XDA,2)) Q:$P(^(2),U,10)="L"
"RTN","DVBADSCK",70,0)
 Q:$P(^DVB(396,XDA,0),U,5)'="YES"  Q:$P(^(0),U,9)'="P"
"RTN","DVBADSCK",71,0)
 S XADMDT=$P(^DVB(396,XDA,0),U,4) Q:ADMDT'=XADMDT
"RTN","DVBADSCK",72,0)
CREAT1 Q:'$D(^DPT(DFN,0))  D ADM^DVBAVDPT I '$D(XRO(CFLOC))&(CFLOC'=376) Q  ;not a user RO
"RTN","DVBADSCK",73,0)
 I CFLOC=376,TDIS["DEATH" S CFLOC=$O(XRO(0)) Q:CFLOC=""
"RTN","DVBADSCK",74,0)
 Q:$D(^DVB(396.2,"D",ADMDT,DFN))  ;quit if one for admit date exists
"RTN","DVBADSCK",75,0)
 S (DIC,DIE)="^DVB(396.2,",DR="3.5///"_CFLOC_";1///"_ADMDT_";2///"_LADM_";3///R" S DLAYGO=396.2,DIC(0)="QLM",X=""""_SSN_"""" D ^DIC Q:+Y<0  S DA=+Y D ^DIE S NEW=1,COUNT=COUNT+1 K DLAYGO
"RTN","DVBADSCK",76,0)
 W PNAM,?35,SSN S Y=ADMDT X ^DD("DD") W ?50,Y,?70,TDIS,!
"RTN","DVBADSCK",77,0)
 Q
"RTN","DVBADSCK",78,0)
 ;
"RTN","DVBADSCK",79,0)
DOC ;XADMDT=admission date on 7131
"RTN","DVBADSCK",80,0)
 ;XDA=7131 file pointer--not all patients will have it
"RTN","DVBADSCK",81,0)
 ;DA=patient file pointer
"RTN","DVBADSCK",82,0)
 ;MB,LADM=admission pointers
"RTN","DVBADSCK",83,0)
 ;NOTE: DEATH,TO CNH discharges will NOT record discharge dates
"RTN","DVBADSNT")
0^5^B21575590
"RTN","DVBADSNT",1,0)
DVBADSNT ;ALB/GTS-557/THM-GENERATE AMIE NOTICE OF DISCHARGE ; 1/16/91  7:37 AM
"RTN","DVBADSNT",2,0)
 ;;2.7;AMIE;**1,14**;Apr 10, 1995
"RTN","DVBADSNT",3,0)
 K ^TMP($J) G TERM
"RTN","DVBADSNT",4,0)
 ;
"RTN","DVBADSNT",5,0)
SET Q:'$D(^DPT(DFN,0))  D RCV^DVBAVDPT S ^TMP($J,XCN,CFLOC,MB,DFN)=XDA_U_XDA2_U_ADMDT_U_RCVAA_U_RCVPEN_U_CNUM
"RTN","DVBADSNT",6,0)
 Q
"RTN","DVBADSNT",7,0)
 ;
"RTN","DVBADSNT",8,0)
PRINTB S XDA=$P(DATA,U),XDA2=$P(DATA,U,2),ADMDT=$P(DATA,U,3),RCVAA=$P(DATA,U,4),RCVPEN=$P(DATA,U,5),CNUM=$P(DATA,U,6),QUIT1=1 D ADM^DVBAVDPT
"RTN","DVBADSNT",9,0)
 S LADM=ADM
"RTN","DVBADSNT",10,0)
 I '$D(^DGPM(LADM,0)) S FND=1
"RTN","DVBADSNT",11,0)
 I $D(^DGPM(LADM,0)) N HPAT S HPAT=$P(^DGPM(LADM,0),"^",3) I $D(^DPT(HPAT,0)) S HPAT=$P(^DPT(HPAT,0),"^") I (HPAT'=PNAM)!(ADMDT'=$P(^DGPM(LADM,0),"^")) S FND=1
"RTN","DVBADSNT",12,0)
 I $D(FND) N Y S Y=ADMDT D DD^%DT W !!,"Admission entry in Patient Movement File has been deleted for: ",!,?5,PNAM,?25,SSN,?35," at ",Y,!,"Contact VAMC for further information.",! K Y,FND D FUPD Q
"RTN","DVBADSNT",13,0)
 S DCHPTR=$P(^DGPM(LADM,0),U,17),TDIS=$S($D(^DGPM(+DCHPTR,0)):$P(^(0),U,18),1:"") I TDIS="" S TDIS="Unknown discharge type"
"RTN","DVBADSNT",14,0)
 S:'$D(^DG(405.2,+TDIS,0)) TDIS="Unknown discharge type" I $D(^(0)) S TDIS=$S($P(^DG(405.2,+TDIS,0),U,1)]"":$P(^(0),U,1),1:"Unknown discharge type")
"RTN","DVBADSNT",15,0)
 I DCHGDT="" S DCHGDT=$S($D(^DGPM(+DCHPTR,0)):$P(^(0),U),1:"")
"RTN","DVBADSNT",16,0)
 W:(IOST?1"C-".E)!($D(DVBAON2)) @IOF
"RTN","DVBADSNT",17,0)
 W !!!!,?(80-$L(HEAD)\2),HEAD,!,?(80-$L(HEAD1)\2),HEAD1,!!
"RTN","DVBADSNT",18,0)
 W ?10,"Patient Name:",?26,PNAM,!!,?14,"Claim No:",?26,CNUM,!,?6,"Claim Folder Loc:",?26,CFLOC,!,?9,"Social Sec No:",?26,SSN,!,?8,"Discharge Date:",?26,$E(DCHGDT,4,5)_"/"_$E(DCHGDT,6,7)_"/"_$E(DCHGDT,2,3),!
"RTN","DVBADSNT",19,0)
 W ?5,"Type of Discharge:",?26,TDIS,!
"RTN","DVBADSNT",20,0)
 D LOS^DVBAUTIL W ?8,"Length of Stay:",?26,LOS_$S(LOS="":"Discharged same day",LOS=1:" day",1:" days"),!
"RTN","DVBADSNT",21,0)
 W ?11,"Bed Service:",?26,BEDSEC,! S DA=DFN D ELIG^DVBAVDPT
"RTN","DVBADSNT",22,0)
FUPD K DA I XDA2]"",$P(^DVB(396,XDA2,0),U,9)="P" S DA=XDA2,DIE="^DVB(396,",DR="4.5////C;4.8////"_DT_";4.9////"_"Notice of Discharge" D ^DIE K DA
"RTN","DVBADSNT",23,0)
 I $D(DVBAD2) I DVBAD2=CFLOC!(CFLOC=376) S DIE="^DVB(396.2,",DA=XDA,DR="3///P;4///"_DT_";5////"_DUZ D ^DIE
"RTN","DVBADSNT",24,0)
 I IOST?1"C-".E W *7,!,"Press RETURN to continue or ""^"" to stop    " R ANS:DTIME S:ANS=U!('$T) QUIT=1 I '$T S DVBAQUIT=1
"RTN","DVBADSNT",25,0)
 S DVBAON2=""
"RTN","DVBADSNT",26,0)
 Q
"RTN","DVBADSNT",27,0)
 ;
"RTN","DVBADSNT",28,0)
PRINT U IO S QUIT=""
"RTN","DVBADSNT",29,0)
 S XCN="" F M=0:0 S XCN=$O(^TMP($J,XCN)) Q:XCN=""!(QUIT=1)  S CFLOC="" F J=0:0 S CFLOC=$O(^TMP($J,XCN,CFLOC)) Q:CFLOC=""!(QUIT=1)  D PRINT1
"RTN","DVBADSNT",30,0)
 Q
"RTN","DVBADSNT",31,0)
PRINT1 S ADM="" F K=0:0 S ADM=$O(^TMP($J,XCN,CFLOC,ADM)) Q:ADM=""  S DFN="" F L=0:0 S DFN=$O(^TMP($J,XCN,CFLOC,ADM,DFN)) Q:DFN=""!(QUIT=1)  S DATA=^(DFN) D PRINTB
"RTN","DVBADSNT",32,0)
 Q
"RTN","DVBADSNT",33,0)
 ;
"RTN","DVBADSNT",34,0)
TERM D HOME^%ZIS K NOASK
"RTN","DVBADSNT",35,0)
 D DUZ2^DVBAUTIL I $D(DVBAQUIT) K DVBAQUIT G KILL
"RTN","DVBADSNT",36,0)
 ;
"RTN","DVBADSNT",37,0)
SETUP W @IOF,!,"NOTICE OF DISCHARGE REPORT" D NOPARM^DVBAUTL2 G:$D(DVBAQUIT) KILL^DVBAUTIL S DTAR=^DVB(396.1,1,0),FDT(0)=$E(DT,4,5)_"-"_$E(DT,6,7)_"-"_$E(DT,2,3)
"RTN","DVBADSNT",38,0)
 S HEAD="NOTICE OF DISCHARGE",HEAD1="FOR "_$P(DTAR,U,1)_" ON "_FDT(0)
"RTN","DVBADSNT",39,0)
 W !,HEAD1
"RTN","DVBADSNT",40,0)
EN1 W !!,"This program will print out any new NOTICES OF DISCHARGE,",!,"based on the hospital's discharges.",!!,"Do you want to continue" S %=2 D YN^DICN
"RTN","DVBADSNT",41,0)
 I $D(%Y) I %Y["?" W !!,"Enter Y to print out the notice, N if you want to exit the program.",! G EN1
"RTN","DVBADSNT",42,0)
 G:%'=1 KILL S %ZIS="Q" D ^%ZIS K %ZIS I POP G KILL
"RTN","DVBADSNT",43,0)
 ;
"RTN","DVBADSNT",44,0)
QUEUE I $D(IO("Q")) S ZTRTN="DEQUE^DVBADSNT",ZTIO=ION,NOASK=1,ZTDESC="AMIE NOTICE OF DISCHARGE REPORT" F I="FDT(0)","HEAD","HEAD1","NOASK","DVBAD2" S ZTSAVE(I)=""
"RTN","DVBADSNT",45,0)
 I $D(IO("Q")) D ^%ZTLOAD W:$D(ZTSK) !!,"Request queued.",!! K ZTSK G KILL
"RTN","DVBADSNT",46,0)
 ;
"RTN","DVBADSNT",47,0)
GO F XDA=0:0 S XDA=$O(^DVB(396.2,"C",DVBAD2,"R",XDA)) Q:XDA=""  I $D(^DVB(396.2,XDA,0)) S MB=^(0),DFN=$P(MB,U),ADMDT=$P(MB,U,2),MB=$P(MB,U,3) D CHK,SET I '$D(NOASK) W "."
"RTN","DVBADSNT",48,0)
 I '$D(^TMP($J)) U IO W !!,*7,"No data found.",!! H 2 G KILL
"RTN","DVBADSNT",49,0)
 D PRINT
"RTN","DVBADSNT",50,0)
KILL D:$D(ZTQUEUED) KILL^%ZTLOAD K DVBAON2 G KILL^DVBAUTIL
"RTN","DVBADSNT",51,0)
 ;
"RTN","DVBADSNT",52,0)
DEQUE K ^TMP($J) G GO
"RTN","DVBADSNT",53,0)
 ;
"RTN","DVBADSNT",54,0)
CHK ;pull 7131 pointer
"RTN","DVBADSNT",55,0)
 F XDA2=0:0 S XDA2=$O(^DVB(396,"G",ADMDT,XDA2)) Q:XDA2=""  I $D(^DVB(396,XDA2,2))&($D(^DVB(396,XDA2,0))) Q:($P(^DVB(396,XDA2,0),U,1)=DFN&($P(^DVB(396,XDA2,2),"^",10)="A"))
"RTN","DVBADSNT",56,0)
 Q
"RTN","DVBADSNT",57,0)
 ;
"RTN","DVBADSNT",58,0)
REPRINT D CHK,SET,PRINT G KILL
"RTN","DVBAFINL")
0^8^B8259541
"RTN","DVBAFINL",1,0)
DVBAFINL ;ALB/GTS-557/THM-AUTO-FINALIZE 7131 REQUESTS; 21 JUL 89
"RTN","DVBAFINL",2,0)
 ;;2.7;AMIE;**14**;Apr 10, 1995
"RTN","DVBAFINL",3,0)
 I $D(DUZ)#2=0 W *7,!!,"Your user number is not set.",!! H 3 Q
"RTN","DVBAFINL",4,0)
 I DUZ'>0 W *7,!!,"Your user number is invalid.  Please log off and back on.",!! H 3 Q
"RTN","DVBAFINL",5,0)
 ;
"RTN","DVBAFINL",6,0)
SETUP I '$D(DT) S %DT="",X="T" D ^%DT S DT=Y
"RTN","DVBAFINL",7,0)
 S OPER=$S($D(^VA(200,+DUZ,0)):$P(^(0),U,1),1:"Unknown operator"),CNT=0
"RTN","DVBAFINL",8,0)
 D HOME^%ZIS
"RTN","DVBAFINL",9,0)
 ;
"RTN","DVBAFINL",10,0)
EN W @IOF,!,"AUTOMATIC 7131 FINALIZATION - USER MODE",!!!,"This program will search the entire 7131 file",!,"and FINALIZE all requests that are ready."
"RTN","DVBAFINL",11,0)
ASK W !!,"Do you want to continue" S %=2 D YN^DICN
"RTN","DVBAFINL",12,0)
 I $D(%Y) I %Y["?" W !!,"Enter Y to go ahead and finalize all requests which are ready",!,"or N to exit.",!! H 1 G ASK
"RTN","DVBAFINL",13,0)
 G:%'=1 EXIT S %ZIS="AEQ",%ZIS("A")="Output device: " W ! D ^%ZIS K %ZIS G:POP EXIT
"RTN","DVBAFINL",14,0)
 I $D(IO("Q")) S ZTIO=ION,ZTRTN="EN1^DVBAFINL",ZTDESC="Automatic 7131 Finalization",ZTSAVE("OPER")="",ZTSAVE("CNT")=""
"RTN","DVBAFINL",15,0)
 I $D(IO("Q")) D ^%ZTLOAD W:$D(ZTSK) !!,"Request queued.",!! G EXIT
"RTN","DVBAFINL",16,0)
 ;
"RTN","DVBAFINL",17,0)
EN1 U IO W:(IOST?1"C-".E) @IOF
"RTN","DVBAFINL",18,0)
 W !,"The following Veterans had requests automatically finalized on " S Y=DT X ^DD("DD") W Y,!!
"RTN","DVBAFINL",19,0)
 W "Veteran name",?37,"Soc Sec #",?49,"Admission date",! F LINE=1:1:IOM W "-"
"RTN","DVBAFINL",20,0)
 W !! F DFN=0:0 S DFN=$O(^DVB(396,"B",DFN)) Q:DFN=""  F DA=0:0 S DA=$O(^DVB(396,"B",DFN,DA)) Q:DA=""  D CHK1
"RTN","DVBAFINL",21,0)
 W !!,"Total requests finalized: ",$J(CNT,4,0),!!
"RTN","DVBAFINL",22,0)
 G EXIT
"RTN","DVBAFINL",23,0)
 ;
"RTN","DVBAFINL",24,0)
CHK1 ;check status of each field
"RTN","DVBAFINL",25,0)
 S NOFINAL=0
"RTN","DVBAFINL",26,0)
 I '$D(^DVB(396,DA,1)) W !!,"Bad 7131 record for internal entry # ",DA,"!...Notify IRM!!",! Q
"RTN","DVBAFINL",27,0)
 Q:$P(^DVB(396,DA,1),U,12)'=""
"RTN","DVBAFINL",28,0)
 F ZA=9,11,13,15,17,19,21,23,26,28 I $P(^DVB(396,DA,0),U,ZA)="P" S NOFINAL=1 Q
"RTN","DVBAFINL",29,0)
 Q:NOFINAL=1  I $P(^DVB(396,DA,1),U,7)="P" S NOFINAL=1 Q
"RTN","DVBAFINL",30,0)
 Q:NOFINAL=1
"RTN","DVBAFINL",31,0)
 W $P(^DPT(DFN,0),U,1),?37,$P(^DPT(DFN,0),U,9),?49 S Y=$P(^DVB(396,DA,0),U,4) X ^DD("DD") W Y,! I $Y>55 D HDR
"RTN","DVBAFINL",32,0)
 S DIE="^DVB(396,",DR="25///"_DT_";26///"_OPER D ^DIE
"RTN","DVBAFINL",33,0)
 S CNT=CNT+1 Q
"RTN","DVBAFINL",34,0)
 ;
"RTN","DVBAFINL",35,0)
EXIT I $D(ZTQUEUED)&(OPER'="Auto-finalized") D KILL^%ZTLOAD
"RTN","DVBAFINL",36,0)
 K ZA G KILL^DVBAUTIL
"RTN","DVBAFINL",37,0)
 ;
"RTN","DVBAFINL",38,0)
HDR W @IOF,!,"Automatic 7131 finalization on " S Y=DT X ^DD("DD") W Y,!!
"RTN","DVBAFINL",39,0)
 Q
"RTN","DVBAFINL",40,0)
 ;
"RTN","DVBAFINL",41,0)
ZTM D NOPARM^DVBAUTL2 G:$D(DVBAQUIT) EXIT
"RTN","DVBAFINL",42,0)
 S OPER="Auto-finalized",CNT=0 I '$D(DT) S X="T" D ^%DT S DT=Y
"RTN","DVBAFINL",43,0)
 G EN1
"RTN","DVBAPND1")
0^6^B16928596
"RTN","DVBAPND1",1,0)
DVBAPND1 ;ALB ISC/GTS-AMIE PENDING RPT UT ;13 JAN 93@08:10 ; 7/2/90  2:48 PM
"RTN","DVBAPND1",2,0)
 ;;2.7;AMIE;**14**;Apr 10, 1995
"RTN","DVBAPND1",3,0)
 ;
"RTN","DVBAPND1",4,0)
 ;  ** The following routines are called from DVBAPEND **
"RTN","DVBAPND1",5,0)
SORTDIV W !!,"Sort by Division" S %=1 D YN^DICN
"RTN","DVBAPND1",6,0)
 I $D(DTOUT)!(%<0) K DTOUT S Y=-1 Q
"RTN","DVBAPND1",7,0)
 I $D(%Y),(%Y["?") W !!,*7,"Enter Y to sort by the Division you"
"RTN","DVBAPND1",8,0)
 I $D(%Y),(%Y["?") W !,"select or enter N to report ALL Divisions."
"RTN","DVBAPND1",9,0)
 I $D(%Y),(%Y["?") G SORTDIV
"RTN","DVBAPND1",10,0)
 I %'=1 S SELDIV="N",DIVNUM=0 Q
"RTN","DVBAPND1",11,0)
 I %=1 S SELDIV="Y" G ENTDIV
"RTN","DVBAPND1",12,0)
 W !,*7,"Invalid response.",!! G SORTDIV
"RTN","DVBAPND1",13,0)
 ;  ** Allow user to enter a selected Division to report **
"RTN","DVBAPND1",14,0)
ENTDIV S DIC="^DG(40.8,",DIC(0)="AEMQ",DIC("A")="Division number: "
"RTN","DVBAPND1",15,0)
 D ^DIC K DIC S DIVNUM=+Y
"RTN","DVBAPND1",16,0)
 S DIVNAM=$S($D(^DG(40.8,+Y,0)):$P(^(0),"^",1),1:"Unknown Division")
"RTN","DVBAPND1",17,0)
 Q
"RTN","DVBAPND1",18,0)
 ;
"RTN","DVBAPND1",19,0)
DCHGDT S DCHGDT="",DCHPTR=$P(^DGPM(XJ,0),U,17),XADMDT=$P(^(0),U,1) I DCHPTR]"",$D(^DGPM(+DCHPTR,0)) S DCHGDT=$P(^DGPM(+DCHPTR,0),U,1)
"RTN","DVBAPND1",20,0)
 K DCHPTR
"RTN","DVBAPND1",21,0)
 Q
"RTN","DVBAPND1",22,0)
 ;
"RTN","DVBAPND1",23,0)
PRINT S DOCTYPE=$S($D(^DVB(396,DA,2)):$P(^(2),U,10),1:""),DFN=$P(^DVB(396,DA,0),U,1),ADMDT=$P(^(0),U,4),RDATE=$P(^(1),U,1),PNAM=$P(^DPT(DFN,0),U,1),SSN=$P(^(0),U,9),CNUM=$S($D(^(.31)):$P(^(.31),U,3),1:"UNKNOWN")
"RTN","DVBAPND1",24,0)
 I RO="Y" S CFLOC=$$STATION^DVBAUTL1(DFN),CFLOC=$S(CFLOC>0:CFLOC,1:9999) Q:CFLOC'=RONUM&(CFLOC'=0)&(CFLOC'=376)
"RTN","DVBAPND1",25,0)
 K ^TMP("DVBA","ADMIT",$J)
"RTN","DVBAPND1",26,0)
 F XI=0:0 S XI=$O(^DGPM("APTT1",DFN,XI)) Q:XI=""  F XJ=0:0 S XJ=$O(^DGPM("APTT1",DFN,XI,XJ)) Q:XJ=""  D DCHGDT S ^TMP("DVBA","ADMIT",$J,XADMDT,DFN)=XI_U_DCHGDT
"RTN","DVBAPND1",27,0)
 W:SELDIV="Y" !,?10,"Division: "_ADIV,!
"RTN","DVBAPND1",28,0)
 W:SELDIV="N" !,?10,"Original Division: "_ADIV,!
"RTN","DVBAPND1",29,0)
 W !,PNAM,?49,"SSN: ",SSN,!,?44,"Claim no: ",CNUM,!,?38,$S(DOCTYPE="L":" Activity date: ",1:"Admission date: "),$E(ADMDT,4,5),"/",$E(ADMDT,6,7),"/",$E(ADMDT,2,3),!,?40,"Request date: ",$E(RDATE,4,5),"/",$E(RDATE,6,7),"/",$E(RDATE,2,3)
"RTN","DVBAPND1",30,0)
 S DCHGDT=""
"RTN","DVBAPND1",31,0)
 I $D(^TMP("DVBA","ADMIT",$J,+ADMDT,DFN)) S:DOCTYPE="A" DCHGDT=$P(^TMP("DVBA","ADMIT",$J,+ADMDT,DFN),U,2)
"RTN","DVBAPND1",32,0)
 D ELAPSED
"RTN","DVBAPND1",33,0)
 W ! I DCHGDT]"" S Y=DCHGDT X DVBADD W "** Discharged: ",Y
"RTN","DVBAPND1",34,0)
 W ?40,"Elapsed days: ",EDAYS,!!,?3,"Items Pending:"
"RTN","DVBAPND1",35,0)
ITEMS F Q=9,11,13,15,17,19,21,23,26,28 I $P(^DVB(396,DA,0),U,Q)="P" D PRINT1 Q:DVBAQUIT=1
"RTN","DVBAPND1",36,0)
 S Q=7 I $P(^DVB(396,DA,1),U,Q)="P" D PRINT1 Q:DVBAQUIT=1
"RTN","DVBAPND1",37,0)
 W !! W:$D(^DVB(396,DA,2)) "Requested by: ",$S($P(^DVB(396,DA,2),U,8)]"":$P(^(2),U,8),1:" (Not specified) ")," AT ",$S($P(^(2),U,7)]"":$P(^(2),U,7),1:" (Not specified) "),! F L=1:1:79 W "-"
"RTN","DVBAPND1",38,0)
 W !
"RTN","DVBAPND1",39,0)
 D TOP Q:DVBAQUIT=1
"RTN","DVBAPND1",40,0)
 Q
"RTN","DVBAPND1",41,0)
 ;
"RTN","DVBAPND1",42,0)
PRINT1 S:$D(^DVB(396,DA,6)) GDIVPTR=$P(^DVB(396,DA,6),"^",Q)
"RTN","DVBAPND1",43,0)
 S:'$D(^DVB(396,DA,6)) GDIVPTR=$P(^DVB(396,DA,2),"^",9)
"RTN","DVBAPND1",44,0)
 S:+GDIVPTR>0 GDIVNAM=$P(^DG(40.8,GDIVPTR,0),"^",1)
"RTN","DVBAPND1",45,0)
 S:+GDIVPTR'>0 GDIVNAM=""
"RTN","DVBAPND1",46,0)
 S NODTA=1 I QQ S MC=$T(@Q),MD=$P(MC,";;",2) S GDIV=" ("_$E(GDIVNAM,1,(9+(23-$L(MC))))_")" W !,?8,MD,GDIV S QQ='QQ Q
"RTN","DVBAPND1",47,0)
 I 'QQ S MC=$T(@Q),MD=$P(MC,";;",2) S GDIV=" ("_$E(GDIVNAM,1,(9+(23-$L(MC))))_")" W ?46,MD,GDIV S QQ='QQ I $Y>22 D TOP Q:DVBAQUIT=1
"RTN","DVBAPND1",48,0)
 Q
"RTN","DVBAPND1",49,0)
 ;
"RTN","DVBAPND1",50,0)
TOP I IOST?1"C-".E,'$D(NOASK) W !!,*7,"Press RETURN to continue or ""^"" to exit   " R ANS:DTIME W @IOF I ANS=U!('$T) S DVBAQUIT=1 Q
"RTN","DVBAPND1",51,0)
 I $Y'<53 D HEADER
"RTN","DVBAPND1",52,0)
 Q
"RTN","DVBAPND1",53,0)
 ;
"RTN","DVBAPND1",54,0)
ELAPSED K EDAYS,X1,X S X1=DT,X=RDATE D ^XUWORKDY
"RTN","DVBAPND1",55,0)
 S EDAYS=X
"RTN","DVBAPND1",56,0)
 Q
"RTN","DVBAPND1",57,0)
 ;
"RTN","DVBAPND1",58,0)
HEADER S PG=PG+1 W:(IOST?1"C-".E)!(PG>1) @IOF,!
"RTN","DVBAPND1",59,0)
 W ?(80-$L(HEAD)\2),HEAD,?71,"Page: ",PG,! I HEAD2]"" W ?(80-$L(HEAD2)\2),HEAD2,!
"RTN","DVBAPND1",60,0)
 W ?(80-$L(PROCDT)\2),PROCDT,!!
"RTN","DVBAPND1",61,0)
 Q
"RTN","DVBAPND1",62,0)
FIELDS ;
"RTN","DVBAPND1",63,0)
7 ;;ADMISSION RPT
"RTN","DVBAPND1",64,0)
9 ;;NOTICE OF DISCHARGE
"RTN","DVBAPND1",65,0)
11 ;;HOSPITAL SUMMARY
"RTN","DVBAPND1",66,0)
13 ;;21-DAY CERTIFICATE
"RTN","DVBAPND1",67,0)
15 ;;OTHER/EXAM REVIEW RMKS
"RTN","DVBAPND1",68,0)
17 ;;SPECIAL REPORT
"RTN","DVBAPND1",69,0)
19 ;;COMPETENCY REPORT
"RTN","DVBAPND1",70,0)
21 ;;VA FORM 21-2680
"RTN","DVBAPND1",71,0)
23 ;;ASSET INFORMATION
"RTN","DVBAPND1",72,0)
26 ;;OPT TREATMENT REPORT
"RTN","DVBAPND1",73,0)
28 ;;BEGINNING DATE/CARE
"RTN","DVBAPND1",74,0)
 Q
"RTN","DVBAREG1")
0^1^B29321037
"RTN","DVBAREG1",1,0)
DVBAREG1 ;ALB/JLU;557/THM-REQ FOR ADMITTED VETS ; 10/29/90  7:53 AM
"RTN","DVBAREG1",2,0)
 ;;2.7;AMIE;**14**;Apr 10, 1995
"RTN","DVBAREG1",3,0)
EN ;this is the main entry point for the driver
"RTN","DVBAREG1",4,0)
 D TERM
"RTN","DVBAREG1",5,0)
 I '$D(DVBAQUIT) DO
"RTN","DVBAREG1",6,0)
 .F  D BODY Q:$D(DVBAQUIT)
"RTN","DVBAREG1",7,0)
 .Q
"RTN","DVBAREG1",8,0)
 D EXIT^DVBAUTIL
"RTN","DVBAREG1",9,0)
 Q
"RTN","DVBAREG1",10,0)
 ;
"RTN","DVBAREG1",11,0)
TERM ;this subroutine will set various necessary variables
"RTN","DVBAREG1",12,0)
 ;
"RTN","DVBAREG1",13,0)
 K DVBAQUIT
"RTN","DVBAREG1",14,0)
 D DUZ2^DVBAUTIL
"RTN","DVBAREG1",15,0)
 Q:$D(DVBAQUIT)
"RTN","DVBAREG1",16,0)
 D NOPARM^DVBAUTL2
"RTN","DVBAREG1",17,0)
 Q:$D(DVBAQUIT)
"RTN","DVBAREG1",18,0)
 D HOME^%ZIS
"RTN","DVBAREG1",19,0)
 Q:$D(DVBAQUIT)
"RTN","DVBAREG1",20,0)
 S OPER=$S($D(^VA(200,+DUZ,0)):$P(^(0),U,1),1:"Unknown")
"RTN","DVBAREG1",21,0)
 S HD="PATIENT LOOKUP"
"RTN","DVBAREG1",22,0)
 S LOC=$S($D(^DIC(4,+DUZ(2),0)):$P(^(0),U,1),1:"")
"RTN","DVBAREG1",23,0)
 S HNAME=$$SITE^DVBCUTL4()
"RTN","DVBAREG1",24,0)
 S DVBAENTR=0
"RTN","DVBAREG1",25,0)
 Q
"RTN","DVBAREG1",26,0)
 ;
"RTN","DVBAREG1",27,0)
BODY ;this subroutine is a subdriver for this functionality
"RTN","DVBAREG1",28,0)
 S DVBAENTR=0
"RTN","DVBAREG1",29,0)
 D UNLOCK^DVBAUTL6(DVBAENTR) ;unlocks the record
"RTN","DVBAREG1",30,0)
 D CLEAN^DVBAREG2 ;cleans up some variables
"RTN","DVBAREG1",31,0)
 D PAGE^DVBAREG2 ;checks for bottom of the screen or page
"RTN","DVBAREG1",32,0)
 D SET1^DVBAREG3 ;sets a few variables
"RTN","DVBAREG1",33,0)
 S DFN=$$PAT^DVBAREG3() ;function call to get the patient
"RTN","DVBAREG1",34,0)
 I DFN=0 S DVBAQUIT=1 Q
"RTN","DVBAREG1",35,0)
 D SET2^DVBAREG3 ;sets up patient information variables
"RTN","DVBAREG1",36,0)
 D CLEAR^DVBAUTL4
"RTN","DVBAREG1",37,0)
 D DTRNG^DVBAREG2(DFN) ;gets the date range
"RTN","DVBAREG1",38,0)
 I $D(DVBAQUIT)!($D(DVBASTOP)) Q
"RTN","DVBAREG1",39,0)
 I DVBBDT>0 S DVBCHK=$$CHK(DFN,DVBBDT,DVBEDT)
"RTN","DVBAREG1",40,0)
 I DVBBDT=0 S DVBCHK=$$CHK(DFN,2010101,DT)
"RTN","DVBAREG1",41,0)
 D CLEAR^DVBAUTL4
"RTN","DVBAREG1",42,0)
 I DVBCHK=0 D ERR^DVBAUTL6(DVBBDT) S DVBASTOP=1 Q
"RTN","DVBAREG1",43,0)
 I DVBCHK="B" D QUEST1(DFN) Q:$D(DVBAQUIT)
"RTN","DVBAREG1",44,0)
 D OLD^DVBAREN1
"RTN","DVBAREG1",45,0)
 D DISPLAY
"RTN","DVBAREG1",46,0)
 Q:$D(DVBAQUIT)
"RTN","DVBAREG1",47,0)
 ;
"RTN","DVBAREG1",48,0)
 ;*The following line of code was removed as part of the coding to allow
"RTN","DVBAREG1",49,0)
 ;* Admission and Activity 7131s with the same date
"RTN","DVBAREG1",50,0)
 ;I $D(DVBANS) S DVBDOC=$$DOC^DVBAREG3(DVBANS)
"RTN","DVBAREG1",51,0)
 I '$D(DVBANS) DO SRCH I $D(DVBASTOP)!($D(DVBAQUIT))!('$D(DVBAENTR)) Q
"RTN","DVBAREG1",52,0)
 I $D(DVBANS) D SELECT^DVBAREG2
"RTN","DVBAREG1",53,0)
 Q:$D(DVBASTOP)!($D(DVBAQUIT))
"RTN","DVBAREG1",54,0)
 D ^DVBARQP
"RTN","DVBAREG1",55,0)
 D UNLOCK^DVBAUTL6(DVBAENTR)
"RTN","DVBAREG1",56,0)
 Q
"RTN","DVBAREG1",57,0)
 ;
"RTN","DVBAREG1",58,0)
CHK(A,B,C) ;checks for the existance of admissions, appointments, dispositions 
"RTN","DVBAREG1",59,0)
 ;or stop codes
"RTN","DVBAREG1",60,0)
 ;A is the DFN of the Patient
"RTN","DVBAREG1",61,0)
 ;B is the beginning date
"RTN","DVBAREG1",62,0)
 ;C is the ending date
"RTN","DVBAREG1",63,0)
 ;If all is selected then B and C should be dates that encompise all
"RTN","DVBAREG1",64,0)
 ;possible dates
"RTN","DVBAREG1",65,0)
 ;the date ranges provided must iclude the +/-for end of days
"RTN","DVBAREG1",66,0)
 N ADM,APT,DISP,SPCOD,B1,C1,C2,DVBADM,DVBAPT,DVBDISP,DVBSPCOD,DVBENC,DVBZERR
"RTN","DVBAREG1",67,0)
 S (DVBADM,DVBAPT,DVBDISP,DVBSPCOD)=0
"RTN","DVBAREG1",68,0)
 S B1=9999999.9999999-B
"RTN","DVBAREG1",69,0)
 S C1=9999999.9999999-C
"RTN","DVBAREG1",70,0)
 S ADM=$O(^DGPM("APTT1",+A,B))
"RTN","DVBAREG1",71,0)
 I ADM,ADM'>C S DVBADM=1
"RTN","DVBAREG1",72,0)
 S APT=$O(^DPT(+A,"S",B))
"RTN","DVBAREG1",73,0)
 I APT,APT'>C S DVBAPT=1
"RTN","DVBAREG1",74,0)
 S DISP=$O(^DPT(+A,"DIS",C1))
"RTN","DVBAREG1",75,0)
 I DISP,DISP'>B1 S DVBDISP=1
"RTN","DVBAREG1",76,0)
 ; Scheduling conversion
"RTN","DVBAREG1",77,0)
 S SPCOD=$$EXOE^SDOE(+A,B,9999999,,"DVBZERR")
"RTN","DVBAREG1",78,0)
 I SPCOD D GETGEN^SDOE(SPCOD,"DVBENC","DVBZERR") S SPCOD=$G(DVBENC(0))\1
"RTN","DVBAREG1",79,0)
 ;
"RTN","DVBAREG1",80,0)
 I SPCOD,SPCOD'>C S DVBSPCOD=1
"RTN","DVBAREG1",81,0)
 I DVBADM&((DVBAPT)!(DVBDISP)!(DVBSPCOD)) Q "B"
"RTN","DVBAREG1",82,0)
 I DVBADM Q "A"
"RTN","DVBAREG1",83,0)
 I DVBAPT!(DVBDISP)!(DVBSPCOD) Q "N"
"RTN","DVBAREG1",84,0)
 Q 0
"RTN","DVBAREG1",85,0)
 ;
"RTN","DVBAREG1",86,0)
QUEST1(DFN) ;ask user which they wish to see admission or non
"RTN","DVBAREG1",87,0)
 S DIR("A")="Which would you prefer"
"RTN","DVBAREG1",88,0)
 S DIR("A",1)=$P(DFN,U,2)_" has both Admission and Non Admission information."
"RTN","DVBAREG1",89,0)
 S DIR(0)="SM^A:Admissions;N:Non Admissions;B:Both"
"RTN","DVBAREG1",90,0)
 D ^DIR
"RTN","DVBAREG1",91,0)
 K DIR
"RTN","DVBAREG1",92,0)
 I $D(DTOUT)!($D(DUOUT))!(X="") S DVBAQUIT=1 Q
"RTN","DVBAREG1",93,0)
 S DVBCHK=Y
"RTN","DVBAREG1",94,0)
 Q
"RTN","DVBAREG1",95,0)
 ;
"RTN","DVBAREG1",96,0)
DISPLAY ;displays the patient information to the user.  Also asks the user
"RTN","DVBAREG1",97,0)
 ;to select which info.
"RTN","DVBAREG1",98,0)
 N X1,X2,X3,X4,VAR1
"RTN","DVBAREG1",99,0)
 I DVBANL=1 D SINGLE^DVBAREG2 Q
"RTN","DVBAREG1",100,0)
 K DVBANS
"RTN","DVBAREG1",101,0)
 S X2=$O(^TMP("DVBA",$J,0))
"RTN","DVBAREG1",102,0)
 I 'X2 S DVBASTOP=1 Q
"RTN","DVBAREG1",103,0)
 S $P(VAR1," ",5)=""
"RTN","DVBAREG1",104,0)
 S (X1,DVBCNT)=0
"RTN","DVBAREG1",105,0)
 F  DO  Q:$D(DVBASTOP)!($D(DVBANS))
"RTN","DVBAREG1",106,0)
 .S XTYPE=""
"RTN","DVBAREG1",107,0)
 .F  S XTYPE=$O(^TMP("DVBA",$J,X2,XTYPE)) Q:XTYPE=""  DO
"RTN","DVBAREG1",108,0)
 ..S X1=X1+1
"RTN","DVBAREG1",109,0)
 ..S DVBCNT=DVBCNT+1
"RTN","DVBAREG1",110,0)
 ..S VAR(DVBCNT,0)="0,0,0,1,0^"_X1_$E(VAR1,1,5-$L(X1))_$P(^TMP("DVBA",$J,X2,XTYPE),U,1)
"RTN","DVBAREG1",111,0)
 ..I '(X1#12)!($O(^TMP("DVBA",$J,X2,XTYPE))=""&'$O(^TMP("DVBA",$J,X2))) DO
"RTN","DVBAREG1",112,0)
 ...D WR^DVBAUTL4("VAR")
"RTN","DVBAREG1",113,0)
 ...K VAR
"RTN","DVBAREG1",114,0)
 ...S DVBCNT=0
"RTN","DVBAREG1",115,0)
 ...D CONT^DVBAREG2
"RTN","DVBAREG1",116,0)
 .S X2=$O(^TMP("DVBA",$J,X2))
"RTN","DVBAREG1",117,0)
 .I '$D(DVBANS),('X2) S DVBASTOP=1 Q
"RTN","DVBAREG1",118,0)
 .Q
"RTN","DVBAREG1",119,0)
 I $D(DVBANS) DO
"RTN","DVBAREG1",120,0)
 .S (X3,X4)=0,(DVBTYPE,DVBDOC)=""
"RTN","DVBAREG1",121,0)
 .F  Q:+X3=+DVBANS  S X4=$O(^TMP("DVBA",$J,X4)) Q:X4=""  DO
"RTN","DVBAREG1",122,0)
 ..F  Q:+X3=+DVBANS  S DVBTYPE=$O(^TMP("DVBA",$J,X4,DVBTYPE)) Q:DVBTYPE=""  S X3=X3+1
"RTN","DVBAREG1",123,0)
 .S DVBANS=X4
"RTN","DVBAREG1",124,0)
 .S DVBDOC=$S(DVBTYPE["ADMISSION":"A",1:"L")
"RTN","DVBAREG1",125,0)
 .Q
"RTN","DVBAREG1",126,0)
 K XTYPE
"RTN","DVBAREG1",127,0)
 Q
"RTN","DVBAREG1",128,0)
 ;
"RTN","DVBAREG1",129,0)
SRCH ;searches the 7131 file for an existing 7131 request.
"RTN","DVBAREG1",130,0)
 K DA,Y,DVBASTOP,DVBAENTR
"RTN","DVBAREG1",131,0)
 D DICW^DVBAUTIL
"RTN","DVBAREG1",132,0)
 S VAR(1,0)="0,0,0,2,0^Searching file for existing 7131 requests for "_PNAM
"RTN","DVBAREG1",133,0)
 D WR^DVBAUTL4("VAR")
"RTN","DVBAREG1",134,0)
 K VAR
"RTN","DVBAREG1",135,0)
 S DIC="^DVB(396,",DIC(0)="EM",X=SSN
"RTN","DVBAREG1",136,0)
 I DVBCHK'="B",DVBBDT=0 S DIC("S")=$S(DVBCHK="A":"I $P(^(2),U,10)=""A""",1:"I $P(^(2),U,10)=""L"""),DVBDOC=$S(DVBCHK="A":"A",1:"L")
"RTN","DVBAREG1",137,0)
 I DVBCHK'="B",DVBBDT>0 S DIC("S")=$S(DVBCHK="A":"I $P(^(2),U,10)=""A""",1:"I $P(^(2),U,10)=""L""")_",$P(^(0),U,4)>(DVBBDT-.0000001),$P(^(0),U,4)<(DVBEDT+.0000001)"
"RTN","DVBAREG1",138,0)
 D ^DIC
"RTN","DVBAREG1",139,0)
 K DIC
"RTN","DVBAREG1",140,0)
 S DVBAY=Y
"RTN","DVBAREG1",141,0)
 I DVBAY<0 DO  Q
"RTN","DVBAREG1",142,0)
 .S VAR(1,0)="0,0,0,2:2,0^No selection made!"
"RTN","DVBAREG1",143,0)
 .D WR^DVBAUTL4("VAR")
"RTN","DVBAREG1",144,0)
 .K VAR
"RTN","DVBAREG1",145,0)
 .D CONTMES^DVBCUTL4
"RTN","DVBAREG1",146,0)
 .S DVBASTOP=1
"RTN","DVBAREG1",147,0)
 .Q
"RTN","DVBAREG1",148,0)
 I DVBAY>0 DO
"RTN","DVBAREG1",149,0)
 .I '$$LOCK^DVBAUTL6(+DVBAY) S DVBASTOP=1 Q
"RTN","DVBAREG1",150,0)
 .S (ZI,DA,DVBAIFN)=+DVBAY
"RTN","DVBAREG1",151,0)
 .S DVBREQDT=$P(^DVB(396,DA,0),U,4)
"RTN","DVBAREG1",152,0)
 .D ALERT^DVBAREG2(+DVBAY)
"RTN","DVBAREG1",153,0)
 .D ASK^DVBAREG2
"RTN","DVBAREG1",154,0)
 .Q:$D(DVBAQUIT)!($D(DVBASTOP))
"RTN","DVBAREG1",155,0)
 .S ONFILE=0
"RTN","DVBAREG1",156,0)
 .S DVBAENTR=+DVBAY
"RTN","DVBAREG1",157,0)
 .S DVBDOC=$P(^DVB(396,DVBAENTR,2),U,10)
"RTN","DVBAREG1",158,0)
 .I DVBDOC["A" S ADMNUM=$$ADM(DVBREQDT,+DFN)
"RTN","DVBAREG1",159,0)
 .I STAT'="" D ALERT1^DVBAREG2
"RTN","DVBAREG1",160,0)
 .I $D(DVBAQUIT) K DVBAEDT
"RTN","DVBAREG1",161,0)
 .I ONFILE=1 S DVBASTOP=1 Q
"RTN","DVBAREG1",162,0)
 .Q
"RTN","DVBAREG1",163,0)
 K DVBAY
"RTN","DVBAREG1",164,0)
 Q
"RTN","DVBAREG1",165,0)
 ;
"RTN","DVBAREG1",166,0)
ADM(A,B) ;This entry point will return the IEN in DGPM for the patient
"RTN","DVBAREG1",167,0)
 ;and admission date given.  A will be the admission date and B will
"RTN","DVBAREG1",168,0)
 ;be the DFN of the patient.
"RTN","DVBAREG1",169,0)
 ;
"RTN","DVBAREG1",170,0)
 N X
"RTN","DVBAREG1",171,0)
 S A=9999999.9999999-A
"RTN","DVBAREG1",172,0)
 S X=$O(^DGPM("ATID1",+B,A,0))
"RTN","DVBAREG1",173,0)
 I X DO
"RTN","DVBAREG1",174,0)
 .I '$D(^DGPM(X,0)) S X=""
"RTN","DVBAREG1",175,0)
 .Q
"RTN","DVBAREG1",176,0)
 I X="" Q 0
"RTN","DVBAREG1",177,0)
 Q X
"RTN","DVBAREG2")
0^2^B32322277
"RTN","DVBAREG2",1,0)
DVBAREG2 ;ALB/JLU;second half of the 7131 input;9/20/94
"RTN","DVBAREG2",2,0)
 ;;2.7;AMIE;**3,5,14**;Apr 10, 1995
"RTN","DVBAREG2",3,0)
 ;
"RTN","DVBAREG2",4,0)
CONT ;asks selection from list
"RTN","DVBAREG2",5,0)
 S DIR(0)="NAO^1:"_X1_":0"
"RTN","DVBAREG2",6,0)
 S DIR("A")="Select 1-"_X1_"   or '^' to Exit or Return to continue "
"RTN","DVBAREG2",7,0)
 D ^DIR
"RTN","DVBAREG2",8,0)
 K DIR
"RTN","DVBAREG2",9,0)
 I $D(DTOUT)!$D(DUOUT) S DVBASTOP=1 Q
"RTN","DVBAREG2",10,0)
 I Y]"" S DVBANS=Y
"RTN","DVBAREG2",11,0)
 E  K DVBANS
"RTN","DVBAREG2",12,0)
 Q
"RTN","DVBAREG2",13,0)
 ;
"RTN","DVBAREG2",14,0)
SINGLE ;when select single entry point
"RTN","DVBAREG2",15,0)
 S XTYPE=""
"RTN","DVBAREG2",16,0)
 S X1=$O(^TMP("DVBA",$J,0))
"RTN","DVBAREG2",17,0)
 I X1="" S DVBASTOP=1 Q
"RTN","DVBAREG2",18,0)
 S XTYPE=$O(^TMP("DVBA",$J,X1,XTYPE))
"RTN","DVBAREG2",19,0)
 I XTYPE="" S DVBASTOP=1 Q
"RTN","DVBAREG2",20,0)
 S DIR("A",1)=""
"RTN","DVBAREG2",21,0)
 S DIR("A",2)=$P(^TMP("DVBA",$J,X1,XTYPE),U)
"RTN","DVBAREG2",22,0)
 S DIR("A")="Is this the correct information? "
"RTN","DVBAREG2",23,0)
 S DIR("B")="NO"
"RTN","DVBAREG2",24,0)
 S DIR(0)="YA"
"RTN","DVBAREG2",25,0)
 D ^DIR
"RTN","DVBAREG2",26,0)
 K DIR
"RTN","DVBAREG2",27,0)
 I $D(DUOUT)!($D(DTOUT)) S DVBASTOP=1 Q
"RTN","DVBAREG2",28,0)
 I Y S DVBANS=X1,DVBTYPE=XTYPE
"RTN","DVBAREG2",29,0)
 E  K DVBANS
"RTN","DVBAREG2",30,0)
 Q
"RTN","DVBAREG2",31,0)
 ;
"RTN","DVBAREG2",32,0)
DTRNG(DFN) ;gets date range from user
"RTN","DVBAREG2",33,0)
 S DIR("A",1)="Display Admission or Activity information"
"RTN","DVBAREG2",34,0)
 S DIR("A")="for "_$P(DFN,U,2)_"  by"
"RTN","DVBAREG2",35,0)
 S DIR("?")="Date Range will allow the user to select the specific dates."
"RTN","DVBAREG2",36,0)
 S DIR("?",1)="All Dates will show the user all possible information."
"RTN","DVBAREG2",37,0)
 S DIR(0)="SM^D:Date Range;A:All Dates"
"RTN","DVBAREG2",38,0)
 D ^DIR
"RTN","DVBAREG2",39,0)
 K DIR
"RTN","DVBAREG2",40,0)
 I $D(DTOUT)!($D(DUOUT)) S DVBAQUIT=1 Q
"RTN","DVBAREG2",41,0)
 I X="" S DVBASTOP=1 Q
"RTN","DVBAREG2",42,0)
 S DVBBDT=0,DVBEDT=0
"RTN","DVBAREG2",43,0)
 S VAR(1,0)="0,0,0,1,0^"
"RTN","DVBAREG2",44,0)
 D WR^DVBAUTL4("VAR")
"RTN","DVBAREG2",45,0)
 K VAR
"RTN","DVBAREG2",46,0)
 I Y="D" DO
"RTN","DVBAREG2",47,0)
 .D DATE^DVBCUTL4(.DVBBDT,.DVBEDT)
"RTN","DVBAREG2",48,0)
 .S Y="D"
"RTN","DVBAREG2",49,0)
 .I DVBBDT>0,'+$P(DVBBDT,".",2) S DVBBDT=DVBBDT-.0000001
"RTN","DVBAREG2",50,0)
 .I DVBEDT>0,'+$P(DVBEDT,".",2) S DVBEDT=DVBEDT+.9999999
"RTN","DVBAREG2",51,0)
 .I DVBBDT=0,DVBEDT=0 S DVBAQUIT=1
"RTN","DVBAREG2",52,0)
 .I DVBBDT=-1,DVBEDT=-1 S DVBASTOP=1
"RTN","DVBAREG2",53,0)
 .Q
"RTN","DVBAREG2",54,0)
 Q
"RTN","DVBAREG2",55,0)
 ;
"RTN","DVBAREG2",56,0)
CLEAN ;cleans up variables
"RTN","DVBAREG2",57,0)
 K DA,ADM,ADMDT,ADMNUM,DFN,DIC,A,DR,PNAM,SSN,TRN,Z,DINUM,DTAR,C,J,K,L,C,D,DIE,ONFILE,%,OLDDA,%Y,DIK,ZI,X,Y,AROWOUT,DVBAEDT,DVBAENTR,DVBASTOP,DVBREQDT,DVBANS,DVBTYPE
"RTN","DVBAREG2",58,0)
 K ^TMP("DVBA",$J),^UTILITY("DIQ1",$J)
"RTN","DVBAREG2",59,0)
 Q
"RTN","DVBAREG2",60,0)
 ;
"RTN","DVBAREG2",61,0)
PAGE ;pages/dispays end of page/screen
"RTN","DVBAREG2",62,0)
 S VAR(1,0)="0,0,0,0,1^"
"RTN","DVBAREG2",63,0)
 S VAR(2,0)="0,0,"_(IOM-$L(HD)\2)_":0,0,0^"_HD
"RTN","DVBAREG2",64,0)
 S VAR(3,0)="0,0,"_(IOM-$L(HNAME)\2)_":0,1:2,0^"_HNAME
"RTN","DVBAREG2",65,0)
 D WR^DVBAUTL4("VAR")
"RTN","DVBAREG2",66,0)
 K VAR
"RTN","DVBAREG2",67,0)
 Q
"RTN","DVBAREG2",68,0)
 ;
"RTN","DVBAREG2",69,0)
SELECT ;checks doc type, request status and calls deletion, if necessary
"RTN","DVBAREG2",70,0)
 N ZI
"RTN","DVBAREG2",71,0)
 K DVBAENTR
"RTN","DVBAREG2",72,0)
 S DVBREQDT=9999999.9999999-DVBANS
"RTN","DVBAREG2",73,0)
 I DVBTYPE["ADMISSION" DO
"RTN","DVBAREG2",74,0)
 .S ADMNUM=$P(^TMP("DVBA",$J,DVBANS,DVBTYPE),U,2)
"RTN","DVBAREG2",75,0)
 D COMPSEL
"RTN","DVBAREG2",76,0)
 Q
"RTN","DVBAREG2",77,0)
 ;
"RTN","DVBAREG2",78,0)
COMPSEL ;** Compare selected 7131 to existing
"RTN","DVBAREG2",79,0)
 N DVBATMPT
"RTN","DVBAREG2",80,0)
 I DVBTYPE["ADMISSION" S DVBATMPT="A"
"RTN","DVBAREG2",81,0)
 I DVBTYPE'["ADMISSION" S DVBATMPT="L"
"RTN","DVBAREG2",82,0)
 F ZI=0:0 S ZI=$O(^DVB(396,"B",+DFN,ZI)) Q:ZI=""  I $D(^DVB(396,"G",+$E(DVBREQDT,1,14),ZI))&(DVBATMPT=$P(^DVB(396,ZI,2),"^",10)) S DVBAENTR=ZI Q
"RTN","DVBAREG2",83,0)
 I $D(DVBAENTR) DO
"RTN","DVBAREG2",84,0)
 .D ALERT(ZI)
"RTN","DVBAREG2",85,0)
 .D ASK
"RTN","DVBAREG2",86,0)
 .Q:$D(DVBAQUIT)!($D(DVBASTOP))
"RTN","DVBAREG2",87,0)
 .I '$$LOCK^DVBAUTL6(DVBAENTR) S DVBASTOP=1 Q
"RTN","DVBAREG2",88,0)
 .S STAT=$P(^DVB(396,DVBAENTR,1),U,12)
"RTN","DVBAREG2",89,0)
 .S ONFILE=0
"RTN","DVBAREG2",90,0)
 .I STAT'="" D ALERT1
"RTN","DVBAREG2",91,0)
 .Q:$D(DVBAQUIT)!($D(DVBASTOP))
"RTN","DVBAREG2",92,0)
 .I ONFILE=1 S DVBASTOP=1 Q
"RTN","DVBAREG2",93,0)
 .Q
"RTN","DVBAREG2",94,0)
 I '$D(DVBAENTR) DO
"RTN","DVBAREG2",95,0)
 .D DICW^DVBAUTIL
"RTN","DVBAREG2",96,0)
 .D ASK1
"RTN","DVBAREG2",97,0)
 .I $D(DVBASTOP)!($D(DVBAQUIT)) Q
"RTN","DVBAREG2",98,0)
 .D STUFF
"RTN","DVBAREG2",99,0)
 .Q
"RTN","DVBAREG2",100,0)
 I '$D(DVBAENTR) S DVBASTOP=1
"RTN","DVBAREG2",101,0)
 Q
"RTN","DVBAREG2",102,0)
 ;
"RTN","DVBAREG2",103,0)
ALERT(Y) ;displays when a potential hit in the 7131 file.
"RTN","DVBAREG2",104,0)
 S VAR(1,0)="1,0,0,2,0^There is a 7131 already on file for "_$E(DVBREQDT,4,5)_"/"_$E(DVBREQDT,6,7)_"/"_$E(DVBREQDT,2,3)
"RTN","DVBAREG2",105,0)
 S STAT=$P(^DVB(396,+Y,1),U,12)
"RTN","DVBAREG2",106,0)
 S VAR(2,0)="0,0,0,1:1,0^Status is "_$S(STAT'="":"FINALIZED",1:"OPEN")
"RTN","DVBAREG2",107,0)
 D WR^DVBAUTL4("VAR")
"RTN","DVBAREG2",108,0)
 K VAR
"RTN","DVBAREG2",109,0)
 Q
"RTN","DVBAREG2",110,0)
ALERT1 ;
"RTN","DVBAREG2",111,0)
 I STAT'="" DO
"RTN","DVBAREG2",112,0)
 .S VAR(1,0)="0,0,0,1,0^"
"RTN","DVBAREG2",113,0)
 .D WR^DVBAUTL4("VAR")
"RTN","DVBAREG2",114,0)
 .K VAR
"RTN","DVBAREG2",115,0)
 .S DIR("A")="Do you want to delete the existing 7131 for this date: "
"RTN","DVBAREG2",116,0)
 .S DIR(0)="YAO"
"RTN","DVBAREG2",117,0)
 .S DIR("B")="NO"
"RTN","DVBAREG2",118,0)
 .S DIR("?")="Answer YES or No.  You may not have two 7131s for the same admission date."
"RTN","DVBAREG2",119,0)
 .D ^DIR
"RTN","DVBAREG2",120,0)
 .K DIR
"RTN","DVBAREG2",121,0)
 .I $D(DTOUT)!($D(DUOUT))!(Y="") S DVBAQUIT=1 Q
"RTN","DVBAREG2",122,0)
 .I 'Y S DVBASTOP=1 Q
"RTN","DVBAREG2",123,0)
 .I Y DO
"RTN","DVBAREG2",124,0)
 ..S DA=+DVBAENTR
"RTN","DVBAREG2",125,0)
 ..D REOPEN^DVBAUTL2
"RTN","DVBAREG2",126,0)
 ..K DA
"RTN","DVBAREG2",127,0)
 ..Q
"RTN","DVBAREG2",128,0)
 .Q
"RTN","DVBAREG2",129,0)
 Q
"RTN","DVBAREG2",130,0)
 ;
"RTN","DVBAREG2",131,0)
ASK1 ;ask user if wish to add new 7131
"RTN","DVBAREG2",132,0)
 S DVBAASIH=$P(DVBREQDT,".",2) ;*ASIH admit? (P4,v2.7)
"RTN","DVBAREG2",133,0)
 D:$L(DVBAASIH)>6 ASIHALRT^DVBAUTL8 ;**Warn ASIH admit
"RTN","DVBAREG2",134,0)
 S VAR(1,0)="1,0,0,1,0^"
"RTN","DVBAREG2",135,0)
 D WR^DVBAUTL4("VAR")
"RTN","DVBAREG2",136,0)
 K VAR
"RTN","DVBAREG2",137,0)
 S DIR("A",1)="Do you want to add a NEW 7131"
"RTN","DVBAREG2",138,0)
 S DIR("A")="for "_$P(PNAM,",",2,99)_" "_$P(PNAM,",",1,1)_" :"
"RTN","DVBAREG2",139,0)
 S DIR(0)="YAO"
"RTN","DVBAREG2",140,0)
 S DIR("B")="NO"
"RTN","DVBAREG2",141,0)
 S DIR("?")="'YES' to enter a new 7131. 'NO' to search for an existing one."
"RTN","DVBAREG2",142,0)
 D ^DIR
"RTN","DVBAREG2",143,0)
 K DIR,DVBAASIH
"RTN","DVBAREG2",144,0)
 I $D(DUOUT)!($D(DTOUT)) S DVBAQUIT=1 Q
"RTN","DVBAREG2",145,0)
 S:Y=1 DVBREQDT=+$E(DVBREQDT,1,14)
"RTN","DVBAREG2",146,0)
 I Y=0 S DVBASTOP=1 Q
"RTN","DVBAREG2",147,0)
 Q
"RTN","DVBAREG2",148,0)
 ;
"RTN","DVBAREG2",149,0)
ASK ;ask the user if wish to edit existing 7131
"RTN","DVBAREG2",150,0)
 S VAR(1,0)="1,0,0,1,0^"
"RTN","DVBAREG2",151,0)
 D WR^DVBAUTL4("VAR")
"RTN","DVBAREG2",152,0)
 K VAR
"RTN","DVBAREG2",153,0)
 S DIR("A")="Are you sure you want to edit this 7131 request: "
"RTN","DVBAREG2",154,0)
 S DIR("B")="NO"
"RTN","DVBAREG2",155,0)
 S DIR("?")="'YES' to edit the 7131 request."
"RTN","DVBAREG2",156,0)
 S DIR(0)="YAO"
"RTN","DVBAREG2",157,0)
 D ^DIR
"RTN","DVBAREG2",158,0)
 K DIR
"RTN","DVBAREG2",159,0)
 I $D(DUOUT)!($D(DTOUT)) S DVBAQUIT=1 Q
"RTN","DVBAREG2",160,0)
 I Y=0 S DVBASTOP=1 Q
"RTN","DVBAREG2",161,0)
 I Y=1 S DVBAEDT=1
"RTN","DVBAREG2",162,0)
 Q
"RTN","DVBAREG2",163,0)
 ;
"RTN","DVBAREG2",164,0)
STUFF ;enters 7131 into 7131 form file
"RTN","DVBAREG2",165,0)
 K DA,DIC("S"),DD,DO
"RTN","DVBAREG2",166,0)
 S DLAYGO=396,DIC(0)="QLM",DIC="^DVB(396,",X=+DFN
"RTN","DVBAREG2",167,0)
 D FILE^DICN
"RTN","DVBAREG2",168,0)
 I 'Y DO  S DVBASTOP=1 Q
"RTN","DVBAREG2",169,0)
 .S VAR(1,0)="1,0,0,2,0^Unable to add this new record!"
"RTN","DVBAREG2",170,0)
 .D WR^DVBAUTL4("VAR")
"RTN","DVBAREG2",171,0)
 .K VAR
"RTN","DVBAREG2",172,0)
 .Q
"RTN","DVBAREG2",173,0)
 I '$$LOCK^DVBAUTL6(Y) S DVBASTOP=1 Q
"RTN","DVBAREG2",174,0)
 S DVBAENTR=+Y
"RTN","DVBAREG2",175,0)
 S DR="1////"_CNUM_";2////"_SSN_";3////"_DVBREQDT_";23////"_DT_";24////"_DT_";27////"_LOC_";28////"_OPER_";30////"_$S($D(ADMNUM):"A",1:"L")
"RTN","DVBAREG2",176,0)
 S DIE=DIC
"RTN","DVBAREG2",177,0)
 D ^DIE
"RTN","DVBAREG2",178,0)
 K DLAYGO,DIC,DIE
"RTN","DVBAREG2",179,0)
 Q
"RTN","DVBAREG2",180,0)
 ;
"RTN","DVBAREN1")
0^4^B20734249
"RTN","DVBAREN1",1,0)
DVBAREN1 ;ALB/JLU;NEW 7131 REQ FOR NON-ADMIT VETS;9/20/94
"RTN","DVBAREN1",2,0)
 ;;2.7;AMIE;**14**;Apr 10, 1995
"RTN","DVBAREN1",3,0)
 ;this routine contains the logic to search for admissions, appointments, dispositions, and stop codes.
"RTN","DVBAREN1",4,0)
 ;
"RTN","DVBAREN1",5,0)
OLD ;this is the main entry point.
"RTN","DVBAREN1",6,0)
 S DVBANL=0
"RTN","DVBAREN1",7,0)
 I DVBCHK="A" D A1,COLADM
"RTN","DVBAREN1",8,0)
 I DVBCHK="N" D N1,COLAPT,COLLOG,COLSTP
"RTN","DVBAREN1",9,0)
 I DVBCHK="B" D B1,COLADM,COLAPT,COLLOG,COLSTP
"RTN","DVBAREN1",10,0)
 K DVBAWARN
"RTN","DVBAREN1",11,0)
 Q
"RTN","DVBAREN1",12,0)
A1 ;writes header statement for admission dates
"RTN","DVBAREN1",13,0)
 S VAR(1,0)="0,0,0,2:1,1^The following is a list of Admission dates for "_$P(DFN,U,2)
"RTN","DVBAREN1",14,0)
 D WR^DVBAUTL4("VAR")
"RTN","DVBAREN1",15,0)
 K VAR
"RTN","DVBAREN1",16,0)
 Q
"RTN","DVBAREN1",17,0)
 ;
"RTN","DVBAREN1",18,0)
N1 ;writes the header statement for activity dates
"RTN","DVBAREN1",19,0)
 S VAR(1,0)="0,0,0,2:1,1^The following is a list of activity dates for "_$P(DFN,U,2)
"RTN","DVBAREN1",20,0)
 D WR^DVBAUTL4("VAR")
"RTN","DVBAREN1",21,0)
 K VAR
"RTN","DVBAREN1",22,0)
 Q
"RTN","DVBAREN1",23,0)
 ;
"RTN","DVBAREN1",24,0)
B1 ;writes the header statement for both admission and activity dates
"RTN","DVBAREN1",25,0)
 S VAR(1,0)="0,0,0,2:1,1^The following is a list of Admission and Activity dates for "_$P(DFN,U,2)
"RTN","DVBAREN1",26,0)
 D WR^DVBAUTL4("VAR")
"RTN","DVBAREN1",27,0)
 K VAR
"RTN","DVBAREN1",28,0)
 Q
"RTN","DVBAREN1",29,0)
 ;
"RTN","DVBAREN1",30,0)
COLADM ;gathers the admission info. and stores in to the ^TMP global
"RTN","DVBAREN1",31,0)
 I DVBBDT=0 DO
"RTN","DVBAREN1",32,0)
 .N X,X1,X2
"RTN","DVBAREN1",33,0)
 .S X1=0
"RTN","DVBAREN1",34,0)
 .F X=1:1 S X1=$O(^DGPM("ATID1",+DFN,X1)) Q:'X1  D ADMSET(X1)
"RTN","DVBAREN1",35,0)
 .Q
"RTN","DVBAREN1",36,0)
 I DVBBDT>0 DO
"RTN","DVBAREN1",37,0)
 .N DVBBDT1,DVBEDT1,X,X1,X2
"RTN","DVBAREN1",38,0)
 .S DVBBDT1=9999999.9999999-(DVBBDT-.0000001)
"RTN","DVBAREN1",39,0)
 .S DVBEDT1=9999999.9999999-DVBEDT
"RTN","DVBAREN1",40,0)
 .S X1=DVBEDT1
"RTN","DVBAREN1",41,0)
 .F X=1:1 S X1=$O(^DGPM("ATID1",+DFN,X1)) Q:'X1!(X1>DVBBDT1)  D ADMSET(X1)
"RTN","DVBAREN1",42,0)
 .Q
"RTN","DVBAREN1",43,0)
 Q
"RTN","DVBAREN1",44,0)
 ;
"RTN","DVBAREN1",45,0)
ADMSET(A) ;starts the process of setting up the ^TMP global
"RTN","DVBAREN1",46,0)
 ;A is the internal entry number of the admission in the patient movement
"RTN","DVBAREN1",47,0)
 ;file.
"RTN","DVBAREN1",48,0)
 N X2,X3
"RTN","DVBAREN1",49,0)
 S X2=$O(^DGPM("ATID1",+DFN,A,0))
"RTN","DVBAREN1",50,0)
 S X3=$P(^DGPM(X2,0),U,4)
"RTN","DVBAREN1",51,0)
 Q:X3']""
"RTN","DVBAREN1",52,0)
 D SET(A,9999999.9999999-A,"ADMISSION",$P(^DG(405.1,X3,0),U,1),X2)
"RTN","DVBAREN1",53,0)
 S DVBANL=DVBANL+1
"RTN","DVBAREN1",54,0)
 Q
"RTN","DVBAREN1",55,0)
 ;
"RTN","DVBAREN1",56,0)
COLAPT ;gathers the appointment information
"RTN","DVBAREN1",57,0)
 I DVBBDT=0 DO
"RTN","DVBAREN1",58,0)
 .N X,X1,X2
"RTN","DVBAREN1",59,0)
 .S X1=0
"RTN","DVBAREN1",60,0)
 .F X=1:1 S X1=$O(^DPT(+DFN,"S",X1)) Q:'X1  D APTSET(X1)
"RTN","DVBAREN1",61,0)
 .Q
"RTN","DVBAREN1",62,0)
 I DVBBDT>0 DO
"RTN","DVBAREN1",63,0)
 .N X,X1
"RTN","DVBAREN1",64,0)
 .S X1=DVBBDT-.0000001
"RTN","DVBAREN1",65,0)
 .F X=1:1 S X1=$O(^DPT(+DFN,"S",X1)) Q:'X1!(X1>DVBEDT)  D APTSET(X1)
"RTN","DVBAREN1",66,0)
 .Q
"RTN","DVBAREN1",67,0)
 Q
"RTN","DVBAREN1",68,0)
 ;
"RTN","DVBAREN1",69,0)
APTSET(A) ;begins to set up the ^TMP global for appointments
"RTN","DVBAREN1",70,0)
 N X2
"RTN","DVBAREN1",71,0)
 S X2=$P(^DPT(+DFN,"S",A,0),U,1)
"RTN","DVBAREN1",72,0)
 S X2=$S($D(^SC(X2,0)):$P(^(0),U,1),1:"Unknown")
"RTN","DVBAREN1",73,0)
 D SET(9999999.9999999-X1,X1,"Appointment",X2)
"RTN","DVBAREN1",74,0)
 S DVBANL=DVBANL+1
"RTN","DVBAREN1",75,0)
 Q
"RTN","DVBAREN1",76,0)
 ;
"RTN","DVBAREN1",77,0)
COLSTP ;gathers the stop code information
"RTN","DVBAREN1",78,0)
 N DVBQUERY,DVBDFR,DVBDTO,DVBA,DVBA1,SDOE,SDOE0,DVBZERR
"RTN","DVBAREN1",79,0)
 S DVBDFR=$S(DVBBDT>0:DVBBDT,1:1),DVBDTO=$S(DVBBDT>0:DVBEDT\1+.99,1:9999999)
"RTN","DVBAREN1",80,0)
 ;
"RTN","DVBAREN1",81,0)
 D OPEN^SDQ(.DVBQUERY,"DVBZERR") Q:'$G(DVBQUERY)
"RTN","DVBAREN1",82,0)
 D INDEX^SDQ(.DVBQUERY,"PATIENT/DATE","SET","DVBZERR")
"RTN","DVBAREN1",83,0)
 D SCANCB^SDQ(.DVBQUERY,"I $P(SDOE0,U,3) S ^TMP(""DVBENC"",$J,+SDOE0)=$G(^TMP(""DVBENC"",$J,+SDOE0))+1","SET","DVBZERR")
"RTN","DVBAREN1",84,0)
 D PAT^SDQ(.DVBQUERY,+DFN,"SET","DVBZERR")
"RTN","DVBAREN1",85,0)
 D DATE^SDQ(.DVBQUERY,DVBDFR,DVBDTO,"SET","DVBZERR")
"RTN","DVBAREN1",86,0)
 D ACTIVE^SDQ(.DVBQUERY,"TRUE","SET","DVBZERR")
"RTN","DVBAREN1",87,0)
 K ^TMP("DVBENC",$J)
"RTN","DVBAREN1",88,0)
 D SCAN^SDQ(.DVBQUERY,"FORWARD","DVBZERR")
"RTN","DVBAREN1",89,0)
 D CLOSE^SDQ(.DVBQUERY)
"RTN","DVBAREN1",90,0)
 ;
"RTN","DVBAREN1",91,0)
 S DVBA=0 F  S DVBA=$O(^TMP("DVBENC",$J,DVBA)) Q:'DVBA  S DVBA1=^(DVBA) D
"RTN","DVBAREN1",92,0)
 . D SET(9999999.9999999-DVBA,DVBA,"Stop Code(s)",DVBA1_" Stops")
"RTN","DVBAREN1",93,0)
 . S DVBANL=DVBANL+1
"RTN","DVBAREN1",94,0)
 K ^TMP("DVBENC",$J)
"RTN","DVBAREN1",95,0)
 Q
"RTN","DVBAREN1",96,0)
 ;
"RTN","DVBAREN1",97,0)
COLLOG ;gathers the disposition information
"RTN","DVBAREN1",98,0)
 I DVBBDT>0 DO
"RTN","DVBAREN1",99,0)
 .N DVBBDT1,DVBEDT1,DVBA,DVBA1,DVBA2,DVBVAR
"RTN","DVBAREN1",100,0)
 .S DVBBDT1=9999999.9999999-(DVBBDT-.0000001)
"RTN","DVBAREN1",101,0)
 .S DVBEDT1=9999999.9999999-DVBEDT
"RTN","DVBAREN1",102,0)
 .S DVBA1=DVBEDT1
"RTN","DVBAREN1",103,0)
 .F DVBA=1:1 S DVBA1=$O(^DPT(+DFN,"DIS",DVBA1)) Q:'DVBA1!(DVBA1>DVBBDT1)  D DISSET(DVBA1)
"RTN","DVBAREN1",104,0)
 .Q
"RTN","DVBAREN1",105,0)
 I DVBBDT=0 DO
"RTN","DVBAREN1",106,0)
 .N DVBA,DVBA1,DVBA2
"RTN","DVBAREN1",107,0)
 .S DVBA1=0
"RTN","DVBAREN1",108,0)
 .F DVBA=1:1 S DVBA1=$O(^DPT(+DFN,"DIS",DVBA1)) Q:'DVBA1  D DISSET(DVBA1)
"RTN","DVBAREN1",109,0)
 .Q
"RTN","DVBAREN1",110,0)
 Q
"RTN","DVBAREN1",111,0)
 ;
"RTN","DVBAREN1",112,0)
DISSET(DVBA2) ;begins to set up the ^TMP with dispositions
"RTN","DVBAREN1",113,0)
 I '$D(^DPT(+DFN,"DIS",0)),'$D(DVBAWARN) DO
"RTN","DVBAREN1",114,0)
 .S VAR(1,0)="1,0,0,2:1,0^There is a problem with the Disposition Login information.  Contact IRM"
"RTN","DVBAREN1",115,0)
 .D WR^DVBAUTL4("VAR")
"RTN","DVBAREN1",116,0)
 .K VAR
"RTN","DVBAREN1",117,0)
 .D CONTMES^DVBCUTL4
"RTN","DVBAREN1",118,0)
 .S DVBAWARN=""
"RTN","DVBAREN1",119,0)
 I $D(^DPT(+DFN,"DIS",0)) DO  ;**Bullet Proof
"RTN","DVBAREN1",120,0)
 .K ^UTILITY("DIQ1",$J)
"RTN","DVBAREN1",121,0)
 .S DIC="^DPT(",DA=+DFN,DR=1000,DA(2.101)=DVBA2
"RTN","DVBAREN1",122,0)
 .S DR(2.101)=1,DIQ(0)="E"
"RTN","DVBAREN1",123,0)
 .D EN^DIQ1
"RTN","DVBAREN1",124,0)
 .K DIQ,DIC,DR,DA
"RTN","DVBAREN1",125,0)
 .D SET(DVBA2,9999999.9999999-DVBA2,"Disposition Login",^UTILITY("DIQ1",$J,2.101,DVBA2,1,"E"))
"RTN","DVBAREN1",126,0)
 .S DVBANL=DVBANL+1
"RTN","DVBAREN1",127,0)
 Q
"RTN","DVBAREN1",128,0)
 ;
"RTN","DVBAREN1",129,0)
SET(IDT,CDT,TYP,FTYP,X2) ;
"RTN","DVBAREN1",130,0)
 N VAR1
"RTN","DVBAREN1",131,0)
 S $P(VAR1," ",22)=""
"RTN","DVBAREN1",132,0)
 S Y=CDT
"RTN","DVBAREN1",133,0)
 D DD^%DT
"RTN","DVBAREN1",134,0)
 S ^TMP("DVBA",$J,IDT,TYP)=Y_$E(VAR1,1,23-$L(Y))_TYP_": "_FTYP_"^"_$S($D(X2):X2,1:"")
"RTN","DVBAREN1",135,0)
 Q
"RTN","DVBAREN1",136,0)
 ;
"VER")
8.0^21.0
**END**
**END**
