Released FB*3.5*97 SEQ #89
Extracted from mail message
**KIDS**:FB*3.5*97^

**INSTALL NAME**
FB*3.5*97
"BLD",6338,0)
FB*3.5*97^FEE BASIS^0^3060530^y
"BLD",6338,1,0)
^^6^6^3060524^
"BLD",6338,1,1,0)
 
"BLD",6338,1,2,0)
 
"BLD",6338,1,3,0)
This patch is issued to compensate for the longer MRA message to be 
"BLD",6338,1,4,0)
received from Austin Central Fee.  Central fee will begin sending MRA 
"BLD",6338,1,5,0)
messages containing spaced for the NPI number before the NPI enhancement
"BLD",6338,1,6,0)
patch (FB*3.5*98) is released.
"BLD",6338,4,0)
^9.64PA^^
"BLD",6338,"KRN",0)
^9.67PA^8989.52^19
"BLD",6338,"KRN",.4,0)
.4
"BLD",6338,"KRN",.401,0)
.401
"BLD",6338,"KRN",.402,0)
.402
"BLD",6338,"KRN",.403,0)
.403
"BLD",6338,"KRN",.5,0)
.5
"BLD",6338,"KRN",.84,0)
.84
"BLD",6338,"KRN",3.6,0)
3.6
"BLD",6338,"KRN",3.8,0)
3.8
"BLD",6338,"KRN",9.2,0)
9.2
"BLD",6338,"KRN",9.8,0)
9.8
"BLD",6338,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",6338,"KRN",9.8,"NM",1,0)
FBMRASVR^^0^B31881185
"BLD",6338,"KRN",9.8,"NM","B","FBMRASVR",1)

"BLD",6338,"KRN",19,0)
19
"BLD",6338,"KRN",19.1,0)
19.1
"BLD",6338,"KRN",101,0)
101
"BLD",6338,"KRN",409.61,0)
409.61
"BLD",6338,"KRN",771,0)
771
"BLD",6338,"KRN",870,0)
870
"BLD",6338,"KRN",8989.51,0)
8989.51
"BLD",6338,"KRN",8989.52,0)
8989.52
"BLD",6338,"KRN",8994,0)
8994
"BLD",6338,"KRN","B",.4,.4)

"BLD",6338,"KRN","B",.401,.401)

"BLD",6338,"KRN","B",.402,.402)

"BLD",6338,"KRN","B",.403,.403)

"BLD",6338,"KRN","B",.5,.5)

"BLD",6338,"KRN","B",.84,.84)

"BLD",6338,"KRN","B",3.6,3.6)

"BLD",6338,"KRN","B",3.8,3.8)

"BLD",6338,"KRN","B",9.2,9.2)

"BLD",6338,"KRN","B",9.8,9.8)

"BLD",6338,"KRN","B",19,19)

"BLD",6338,"KRN","B",19.1,19.1)

"BLD",6338,"KRN","B",101,101)

"BLD",6338,"KRN","B",409.61,409.61)

"BLD",6338,"KRN","B",771,771)

"BLD",6338,"KRN","B",870,870)

"BLD",6338,"KRN","B",8989.51,8989.51)

"BLD",6338,"KRN","B",8989.52,8989.52)

"BLD",6338,"KRN","B",8994,8994)

"BLD",6338,"QUES",0)
^9.62^^
"BLD",6338,"REQB",0)
^9.611^1^1
"BLD",6338,"REQB",1,0)
FB*3.5*50^2
"BLD",6338,"REQB","B","FB*3.5*50",1)

"MBREQ")
0
"PKG",60,-1)
1^1
"PKG",60,0)
FEE BASIS^FB
"PKG",60,20,0)
^9.402P^1^1
"PKG",60,20,1,0)
2^^FBPMRG
"PKG",60,20,1,1)

"PKG",60,20,"B",2,1)

"PKG",60,22,0)
^9.49I^1^1
"PKG",60,22,1,0)
3.5
"PKG",60,22,1,"PAH",1,0)
97^3060530
"PKG",60,22,1,"PAH",1,1,0)
^^6^6^3060530
"PKG",60,22,1,"PAH",1,1,1,0)
 
"PKG",60,22,1,"PAH",1,1,2,0)
 
"PKG",60,22,1,"PAH",1,1,3,0)
This patch is issued to compensate for the longer MRA message to be 
"PKG",60,22,1,"PAH",1,1,4,0)
received from Austin Central Fee.  Central fee will begin sending MRA 
"PKG",60,22,1,"PAH",1,1,5,0)
messages containing spaced for the NPI number before the NPI enhancement
"PKG",60,22,1,"PAH",1,1,6,0)
patch (FB*3.5*98) is released.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","FBMRASVR")
0^1^B31881185^B31269698
"RTN","FBMRASVR",1,0)
FBMRASVR ;AISC/CMR-Server Routine for MRA Messages ;11/16/01
"RTN","FBMRASVR",2,0)
 ;;3.5;FEE BASIS;**9,39,50,97**;JAN 30, 1995
"RTN","FBMRASVR",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","FBMRASVR",4,0)
 S X="TRAP^FBMRASV2" S @^%ZOSF("TRAP")
"RTN","FBMRASVR",5,0)
 ;K XMY S XMY("G.FEE DEVELOPERS@ISC-ALBANY.VA.GOV")="" D ENT1^XMD
"RTN","FBMRASVR",6,0)
 K ^TMP("FBMRA",$J),^TMP("FBER",$J)
"RTN","FBMRASVR",7,0)
 F I=1:1 X XMREC Q:XMER<0   S:$S($E(XMRG,1)=1:1,$E(XMRG,1)=4:1,1:0)&($S($E(XMRG,2)="C":1,$E(XMRG,2)="A":1,$E(XMRG,2)="Q":1,$E(XMRG,2)="F":1,1:0)) ^TMP("FBMRA",$J,I)=XMRG
"RTN","FBMRASVR",8,0)
TEST S (FBCNT,FBATOT,FBCTOT,FBFTOT,FBQTOT,FBI,FBID,FBER)=0 D STATION^FBAAUTL
"RTN","FBMRASVR",9,0)
 F  S FBI=$O(^TMP("FBMRA",$J,FBI)) Q:'FBI  S FBERR=0,FBJ=^(FBI),FBRT=$E(FBJ,1),FBAC=$E(FBJ,2) D PARSE D
"RTN","FBMRASVR",10,0)
 .I 'FBERR D EXTRACT S FBID=$$CKID(FBVID) S FBERR=$S('FBID:1,1:0) D:'FBERR ADD:FBAC="A"!(FBAC="Q"),CHANGE^FBMRASV1:FBAC="C",FPDS:FBAC="F" I FBERR D ER^FBMRASV2(1,FBJ,.FBER)
"RTN","FBMRASVR",11,0)
 .S:FBAC="A" FBATOT=FBATOT+1 S:FBAC="C" FBCTOT=FBCTOT+1 S:FBAC="Q" FBQTOT=FBQTOT+1 S:FBAC="F" FBFTOT=FBFTOT+1
"RTN","FBMRASVR",12,0)
 D MSG^FBMRASV2 Q
"RTN","FBMRASVR",13,0)
PARSE ;Extracts pharmacy or medical mra data
"RTN","FBMRASVR",14,0)
 D:FBRT=4  ;pharmacy record
"RTN","FBMRASVR",15,0)
 .I $L(FBJ)>179 S FBJ=$E(FBJ,1,167)
"RTN","FBMRASVR",16,0)
 .I $L(FBJ)=167 S FBJ=$E(FBJ,1,166)_"            $"
"RTN","FBMRASVR",17,0)
 .I $L(FBJ)'=179 D ER^FBMRASV2(2,FBJ,.FBER) S FBERR=1 Q
"RTN","FBMRASVR",18,0)
 .S FBVID=$E(FBJ,9,17),FBCHAIN=$E(FBJ,18,21),FBFEEO=$E(FBJ,22),FBVNAME=$E(FBJ,23,52),FBADD1=$E(FBJ,53,82),FBADD2=$E(FBJ,83,112),FBCITY=$E(FBJ,113,131),FBST=$E(FBJ,132,133),FBZIP=$E(FBJ,134,142),FBMRC=$E(FBJ,143,144)
"RTN","FBMRASVR",19,0)
 .S FBCC=$E(FBJ,145,147),FBPC=$E(FBJ,148),FBTID=$E(FBJ,149),FB1099=$E(FBJ,150),FBVT=$E(FBJ,151),FBICN=$E(FBJ,152,166)
"RTN","FBMRASVR",20,0)
 .S FBBT=$E(FBJ,167,168) F I=1:1:5 S FBSG(I)=$E(FBJ,I*2+167,I*2+168)
"RTN","FBMRASVR",21,0)
 .S FBCHAIN=$$EXTRL(FBCHAIN,1),FBCHAIN=$S(FBCHAIN=0:"",1:FBCHAIN)
"RTN","FBMRASVR",22,0)
 D:FBRT=1  ;medical record
"RTN","FBMRASVR",23,0)
 .I $L(FBJ)>183 S FBJ=$E(FBJ,1,171)
"RTN","FBMRASVR",24,0)
 .I $L(FBJ)=171 S FBJ=$E(FBJ,1,170)_"            $"
"RTN","FBMRASVR",25,0)
 .I $L(FBJ)'=183 D ER^FBMRASV2(2,FBJ,.FBER) S FBERR=1 Q
"RTN","FBMRASVR",26,0)
 .S FBVID=$E(FBJ,9,19),FBFEEO=$E(FBJ,22),FBSC=$E(FBJ,23,24),FBPART=$E(FBJ,25,26),FBVNAME=$E(FBJ,27,56),FBADD1=$E(FBJ,57,86),FBADD2=$E(FBJ,87,116),FBCITY=$E(FBJ,117,135),FBST=$E(FBJ,136,137),FBZIP=$E(FBJ,138,146)
"RTN","FBMRASVR",27,0)
 .S FBMRC=$E(FBJ,147,148),FBCC=$E(FBJ,149,151),FBPC=$E(FBJ,152),FBTID=$E(FBJ,153),FB1099=$E(FBJ,154),FBVT=$E(FBJ,155),FBICN=$E(FBJ,156,170)
"RTN","FBMRASVR",28,0)
 .S FBBT=$E(FBJ,171,172) F I=1:1:5 S FBSG(I)=$E(FBJ,I*2+171,I*2+172)
"RTN","FBMRASVR",29,0)
 .S FBSC=$S(FBSC="  ":"",$O(^FBAA(161.6,"C",FBSC,0))>0:$O(^FBAA(161.6,"C",FBSC,0)),1:""),FBPART=$$EXTRL(FBPART),FBPART=$O(^FBAA(161.81,"C",+FBPART,0))
"RTN","FBMRASVR",30,0)
 Q
"RTN","FBMRASVR",31,0)
EXTRACT ;Calls to remove leading/trailing spaces and zeros
"RTN","FBMRASVR",32,0)
 D:$D(XRTL) T0^%ZOSV
"RTN","FBMRASVR",33,0)
 S FBVID=$$EXTRT(FBVID),FBVNAME=$$EXTRT(FBVNAME),FBADD1=$$EXTRT(FBADD1),FBADD2=$$EXTRT(FBADD2),FBCITY=$$EXTRT(FBCITY),FBICN=$$EXTRL(FBICN,1),FBST=$$EXTRT(FBST),FBSTN=$E(FBICN,1,3)
"RTN","FBMRASVR",34,0)
 S FBMRC=$$EXTRL(FBMRC)
"RTN","FBMRASVR",35,0)
 S FBBT=$$EXTRT(FBBT)
"RTN","FBMRASVR",36,0)
 F I=1:1 Q:'$D(FBSG(I))  S FBSG(I)=$$EXTRT(FBSG(I)) I FBSG(I)="" K FBSG(I)
"RTN","FBMRASVR",37,0)
 ;Conversion from external to internal format.
"RTN","FBMRASVR",38,0)
 S FBSTATE=$S(FBST']"":"",$D(^DIC(5,"C",FBST)):$O(^DIC(5,"C",FBST,0)),1:""),FBZIP=$S($L(FBZIP)>5:$E(FBZIP,1,5)_"-"_$E(FBZIP,6,$L(FBZIP)),1:FBZIP),FBZIP1=$E(FBZIP,6,9) I '+FBZIP1 S FBZIP=$E(FBZIP,1,5)
"RTN","FBMRASVR",39,0)
 S FBCC=$S(FBCC="   ":"",FBCC']"":"",FBCC="000":"",$D(^DIC(5,+FBSTATE,1,"C",FBCC)):$O(^(FBCC,0)),1:"") I FBCC']"" S FBCC=$P($G(^FBAAV(+FBICN,0)),"^",13)
"RTN","FBMRASVR",40,0)
 D:FBAC="Q" EDIT^FBMRASV2
"RTN","FBMRASVR",41,0)
 I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV
"RTN","FBMRASVR",42,0)
 Q
"RTN","FBMRASVR",43,0)
CKID(X) ;determine if 1st 9 char of id is numeric
"RTN","FBMRASVR",44,0)
 ;INPUT:  X = vendor id
"RTN","FBMRASVR",45,0)
 ;OUTPUT: 1 if ok, 0 if not
"RTN","FBMRASVR",46,0)
 Q $S('+$G(X):0,X'?9N.2AN:0,1:1) ;$E(X,1,9)?9N:1,1:0)
"RTN","FBMRASVR",47,0)
 ;
"RTN","FBMRASVR",48,0)
ADD ;Process Add or Unsolicted Add Record
"RTN","FBMRASVR",49,0)
 I FBSTN'=FBSN D ER^FBMRASV2(3,FBJ,.FBER) Q
"RTN","FBMRASVR",50,0)
 D GET D:FBMRA']"" ER^FBMRASV2(5,FBJ,.FBER) I FBMRA]"" S FBCNT=FBCNT+1 D FILEV,DELMRA
"RTN","FBMRASVR",51,0)
 Q
"RTN","FBMRASVR",52,0)
FPDS ;Process FPDS-Only or Unsolicated FPDS-Only Record
"RTN","FBMRASVR",53,0)
 I FBSTN'=FBSN D
"RTN","FBMRASVR",54,0)
 .N EC S (FBICN,FBOUT)=0,FBERR=1,EC="" D
"RTN","FBMRASVR",55,0)
 ..F  S FBICN=$O(^FBAAV("C",FBVID,FBICN)) Q:'FBICN!(FBOUT)  D
"RTN","FBMRASVR",56,0)
 ...Q:$P($G(^FBAAV(FBICN,"ADEL")),"^")="Y"
"RTN","FBMRASVR",57,0)
 ...S EC="" I FBRT=4 Q:$P(^FBAAV(FBICN,0),U,7)'=3  Q:$P(^FBAAV(FBICN,0),U,10)'=FBCHAIN
"RTN","FBMRASVR",58,0)
 ...I FBRT=1 Q:$P($G(^FBAAV(FBICN,0)),U,7)=3
"RTN","FBMRASVR",59,0)
 ...I $E(FBVNAME,1,5)'=$E($P($G(^FBAAV(FBICN,"AMS")),U),1,5),'+$P($G(^FBAAV(FBICN,"ADEL")),U,4) S EC=4 Q
"RTN","FBMRASVR",60,0)
 ...S FBCNT=FBCNT+1,FBOUT=1,FBERR=0 D FILEV
"RTN","FBMRASVR",61,0)
 .I FBERR S:EC']"" EC=4.1 D ER^FBMRASV2(EC,FBJ,.FBER) S FBERR=0
"RTN","FBMRASVR",62,0)
 Q:FBSTN'=FBSN
"RTN","FBMRASVR",63,0)
 D GET D:FBMRA']"" ER^FBMRASV2(5,FBJ,.FBER) I FBMRA]"" S FBCNT=FBCNT+1 D FILEV,DELMRA
"RTN","FBMRASVR",64,0)
 Q
"RTN","FBMRASVR",65,0)
GET ;Get ICN and MRA entry from MRA file.
"RTN","FBMRASVR",66,0)
 S FBICN=$E(FBICN,4,$L(FBICN))
"RTN","FBMRASVR",67,0)
 S FBMRA=$G(^FBAA(161.25,FBICN,0))
"RTN","FBMRASVR",68,0)
 Q
"RTN","FBMRASVR",69,0)
FILEV ;Files MRA fm Austin in Vendor file.
"RTN","FBMRASVR",70,0)
 Q:'$D(^FBAAV(FBICN,0))  N FBNAM S:'FBCC FBCC=$P(^(0),"^",13) S:"ST"'[FBTID FBTID=""
"RTN","FBMRASVR",71,0)
 I FBAC="C",($G(FBICN1)]""),(FBICN1'=FBICN) S DIK="^FBAAV(",DA=FBICN D ^DIK K DA,DIK S %X="^FBAAV(FBICN1,",%Y="^FBAAV(FBICN," D %XY^%RCR K %X,%Y S DIK="^FBAAV(",DA=FBICN D IX1^DIK K DIK,DA
"RTN","FBMRASVR",72,0)
 S DIE="^FBAAV(",DA=FBICN
"RTN","FBMRASVR",73,0)
 S DR="1////^S X=FBVID;2////^S X=FBADD1;2.5////@;2.5////^S X=FBADD2;3////^S X=FBCITY;4////^S X=FBSTATE;5////^S X=FBZIP;5.5////^S X=FBCC;5.18////^S X=FBMRC;"_$S(FBRT=1:".05////^S X=FBSC;7////^S X=FBPART",1:"8////^S X=FBCHAIN")
"RTN","FBMRASVR",74,0)
 S DR(1,161.2,1)="12.1////^S X=DT;13.1////^S X=$S(FBSTN]"""":FBSTN,1:""000"");30.01////^S X=FBVNAME;30.03////^S X=FB1099;30.04////^S X=FBVT;30.05////^S X=FBPC;30.06////^S X=FBTID"_$S(FBBT]"":";24////^S X=FBBT",1:"")
"RTN","FBMRASVR",75,0)
 L +^FBAAV(FBICN):1
"RTN","FBMRASVR",76,0)
 D ^DIE K DIE,DA,DR
"RTN","FBMRASVR",77,0)
 I $O(FBSG(0)) D UPDGRP^FBAAUTL6(FBICN)
"RTN","FBMRASVR",78,0)
 L -^FBAAV(FBICN)
"RTN","FBMRASVR",79,0)
 Q
"RTN","FBMRASVR",80,0)
DELMRA ;Deletes MRA entry in FB Vendor Correction File.
"RTN","FBMRASVR",81,0)
 S FBVIEN=$S(FBAC="C":FBICN1,1:FBICN),DIE="^FBAA(161.25,"
"RTN","FBMRASVR",82,0)
 I FBAC="C"!(FBAC="Q"),$D(^FBAA(161.25,"AF",FBVIEN)) S FB1=0 F  S FB1=$O(^FBAA(161.25,"AF",FBVIEN,FB1)) Q:'FB1  S DA=FB1,FBLDA=$P($G(^FBAA(161.25,FBVIEN,0)),"^",6),DR="5////^S X=FBLDA" D
"RTN","FBMRASVR",83,0)
 .D LOCK^FBUCUTL(DIE,DA,1) I FBLOCK D ^DIE L -^FBAA(161.25,DA)
"RTN","FBMRASVR",84,0)
 .K FBLOCK
"RTN","FBMRASVR",85,0)
 S DA=FBVIEN,DIK="^FBAA(161.25," D ^DIK K DA,DIK,FB1,FBLDA,FBVIEN
"RTN","FBMRASVR",86,0)
 Q
"RTN","FBMRASVR",87,0)
EXTRL(V,T) ;Removes leading spaces or zeros.
"RTN","FBMRASVR",88,0)
 ;V=variable to be parced
"RTN","FBMRASVR",89,0)
 ;T=1 remove leading zeros, T="" remove leading spaces
"RTN","FBMRASVR",90,0)
 ;Q VAR
"RTN","FBMRASVR",91,0)
 S T=$S($D(T):0,1:" ")
"RTN","FBMRASVR",92,0)
 F  Q:$E(V)'=T  S V=$E(V,2,$L(V))
"RTN","FBMRASVR",93,0)
 Q V
"RTN","FBMRASVR",94,0)
EXTRT(V,T) ;Removes trailing spaces or zeros.
"RTN","FBMRASVR",95,0)
 ;V=variable to be parced
"RTN","FBMRASVR",96,0)
 ;T=1 remove trailing zeros, T="" remove trailing spaces
"RTN","FBMRASVR",97,0)
 N FBL
"RTN","FBMRASVR",98,0)
 S T=$S($D(T):0,1:" ")
"RTN","FBMRASVR",99,0)
 F  S FBL=$L(V) Q:$E(V,FBL)'=T  S V=$E(V,1,FBL-1)
"RTN","FBMRASVR",100,0)
 Q V
"VER")
8.0^22.0
"BLD",6338,6)
^89
**END**
**END**
