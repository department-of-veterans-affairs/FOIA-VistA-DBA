Released GMRA*4*20 SEQ #31
Extracted from mail message
**KIDS**:GMRA*4.0*20^

**INSTALL NAME**
GMRA*4.0*20
"BLD",6071,0)
GMRA*4.0*20^ADVERSE REACTION TRACKING^0^3060719^y
"BLD",6071,1,0)
^^3^3^3060509^^
"BLD",6071,1,1,0)
This patch updates the clean up utility to include ingredient based
"BLD",6071,1,2,0)
and drug class based allergies.  Please see FORUM for the complete
"BLD",6071,1,3,0)
description of this patch.
"BLD",6071,4,0)
^9.64PA^^
"BLD",6071,6.3)
1
"BLD",6071,"ABPKG")
n
"BLD",6071,"INIT")
POST^GMRAY20
"BLD",6071,"KRN",0)
^9.67PA^8989.52^19
"BLD",6071,"KRN",.4,0)
.4
"BLD",6071,"KRN",.401,0)
.401
"BLD",6071,"KRN",.402,0)
.402
"BLD",6071,"KRN",.403,0)
.403
"BLD",6071,"KRN",.5,0)
.5
"BLD",6071,"KRN",.84,0)
.84
"BLD",6071,"KRN",3.6,0)
3.6
"BLD",6071,"KRN",3.8,0)
3.8
"BLD",6071,"KRN",9.2,0)
9.2
"BLD",6071,"KRN",9.8,0)
9.8
"BLD",6071,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",6071,"KRN",9.8,"NM",1,0)
GMRAFX^^0^B82732558
"BLD",6071,"KRN",9.8,"NM",2,0)
GMRAFX1^^0^B32262757
"BLD",6071,"KRN",9.8,"NM",3,0)
GMRAFX3^^0^B68434515
"BLD",6071,"KRN",9.8,"NM",4,0)
GMRAPES0^^0^B74006536
"BLD",6071,"KRN",9.8,"NM",5,0)
GMRAY20^^0^B8283807
"BLD",6071,"KRN",9.8,"NM",6,0)
GMRAPET0^^0^B31689941
"BLD",6071,"KRN",9.8,"NM","B","GMRAFX",1)

"BLD",6071,"KRN",9.8,"NM","B","GMRAFX1",2)

"BLD",6071,"KRN",9.8,"NM","B","GMRAFX3",3)

"BLD",6071,"KRN",9.8,"NM","B","GMRAPES0",4)

"BLD",6071,"KRN",9.8,"NM","B","GMRAPET0",6)

"BLD",6071,"KRN",9.8,"NM","B","GMRAY20",5)

"BLD",6071,"KRN",19,0)
19
"BLD",6071,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",6071,"KRN",19,"NM",1,0)
GMRA FREE TEXT UTILITY^^0
"BLD",6071,"KRN",19,"NM",2,0)
GMRA SITE FILE MENU^^2
"BLD",6071,"KRN",19,"NM","B","GMRA FREE TEXT UTILITY",1)

"BLD",6071,"KRN",19,"NM","B","GMRA SITE FILE MENU",2)

"BLD",6071,"KRN",19.1,0)
19.1
"BLD",6071,"KRN",101,0)
101
"BLD",6071,"KRN",101,"NM",0)
^9.68A^3^3
"BLD",6071,"KRN",101,"NM",1,0)
GMRA FIX FREE TEXT LIST^^3
"BLD",6071,"KRN",101,"NM",2,0)
GMRA FIX DETAIL IN DETAIL^^0
"BLD",6071,"KRN",101,"NM",3,0)
GMRA FIX DETAIL MENU^^2
"BLD",6071,"KRN",101,"NM","B","GMRA FIX DETAIL IN DETAIL",2)

"BLD",6071,"KRN",101,"NM","B","GMRA FIX DETAIL MENU",3)

"BLD",6071,"KRN",101,"NM","B","GMRA FIX FREE TEXT LIST",1)

"BLD",6071,"KRN",409.61,0)
409.61
"BLD",6071,"KRN",409.61,"NM",0)
^9.68A^2^2
"BLD",6071,"KRN",409.61,"NM",1,0)
GMRA FIX^^0
"BLD",6071,"KRN",409.61,"NM",2,0)
GMRA FIX DETAIL^^0
"BLD",6071,"KRN",409.61,"NM","B","GMRA FIX",1)

"BLD",6071,"KRN",409.61,"NM","B","GMRA FIX DETAIL",2)

"BLD",6071,"KRN",771,0)
771
"BLD",6071,"KRN",870,0)
870
"BLD",6071,"KRN",8989.51,0)
8989.51
"BLD",6071,"KRN",8989.52,0)
8989.52
"BLD",6071,"KRN",8994,0)
8994
"BLD",6071,"KRN","B",.4,.4)

"BLD",6071,"KRN","B",.401,.401)

"BLD",6071,"KRN","B",.402,.402)

"BLD",6071,"KRN","B",.403,.403)

"BLD",6071,"KRN","B",.5,.5)

"BLD",6071,"KRN","B",.84,.84)

"BLD",6071,"KRN","B",3.6,3.6)

"BLD",6071,"KRN","B",3.8,3.8)

"BLD",6071,"KRN","B",9.2,9.2)

"BLD",6071,"KRN","B",9.8,9.8)

"BLD",6071,"KRN","B",19,19)

"BLD",6071,"KRN","B",19.1,19.1)

"BLD",6071,"KRN","B",101,101)

"BLD",6071,"KRN","B",409.61,409.61)

"BLD",6071,"KRN","B",771,771)

"BLD",6071,"KRN","B",870,870)

"BLD",6071,"KRN","B",8989.51,8989.51)

"BLD",6071,"KRN","B",8989.52,8989.52)

"BLD",6071,"KRN","B",8994,8994)

"BLD",6071,"QUES",0)
^9.62^^
"BLD",6071,"REQB",0)
^9.611^1^1
"BLD",6071,"REQB",1,0)
GMRA*4.0*23^2
"BLD",6071,"REQB","B","GMRA*4.0*23",1)

"INIT")
POST^GMRAY20
"KRN",19,2455,-1)
2^2
"KRN",19,2455,0)
GMRA SITE FILE MENU^Enter/Edit Site Configurable Files^^M^10^^^^^^^140
"KRN",19,2455,10,0)
^19.01IP^6^6
"KRN",19,2455,10,6,0)
9207^6
"KRN",19,2455,10,6,"^")
GMRA FREE TEXT UTILITY
"KRN",19,2455,"U")
ENTER/EDIT SITE CONFIGURABLE F
"KRN",19,9207,-1)
0^1
"KRN",19,9207,0)
GMRA FREE TEXT UTILITY^Allergy clean up utility^^R^^^^^^^^
"KRN",19,9207,1,0)
^^4^4^3060321^
"KRN",19,9207,1,1,0)
This utility will identify either free text reactants, ingredient based 
"KRN",19,9207,1,2,0)
reactants or drug class based reactants.  The user will then be allowed 
"KRN",19,9207,1,3,0)
to either update the reactant to a more appropriate choice or they can 
"KRN",19,9207,1,4,0)
mark it as entered in error.
"KRN",19,9207,25)
GMRAFX
"KRN",19,9207,"U")
ALLERGY CLEAN UP UTILITY
"KRN",101,6274,-1)
3^1
"KRN",101,6274,0)
GMRA FIX FREE TEXT LIST^Free text entries^^M^^^^^^^^
"KRN",101,6274,4)
25^4
"KRN",101,6274,10,0)
^101.01PA^4^4
"KRN",101,6274,15)

"KRN",101,6274,20)
D:'$D(^XTMP("GMRAFX",LTYPE,"IDX")) LIST^GMRAFX D CHKSEL^GMRAFX
"KRN",101,6274,26)
D PHDR^GMRAFX
"KRN",101,6274,99)
59711,42032
"KRN",101,6314,-1)
2^3
"KRN",101,6314,0)
GMRA FIX DETAIL MENU^^^M^1326
"KRN",101,6314,10,0)
^101.01PA^5^5
"KRN",101,6314,10,5,0)
6485^DD^5^
"KRN",101,6314,10,5,"^")
GMRA FIX DETAIL IN DETAIL
"KRN",101,6485,-1)
0^2
"KRN",101,6485,0)
GMRA FIX DETAIL IN DETAIL^Allergy Detailed Display^^A^^^^^^^^
"KRN",101,6485,15)
D DESELECT^GMRAFX1
"KRN",101,6485,20)
D DSPREACT^GMRAFX3
"KRN",101,6485,99)
60291,50768
"KRN",409.61,882,-1)
0^1
"KRN",409.61,882,0)
GMRA FIX^1^^80^4^20^0^1^^GMRA FIX FREE TEXT LIST^Allergy Tracking Update^1^^1
"KRN",409.61,882,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,882,"ARRAY")
 ^XTMP("GMRAFX",LTYPE)
"KRN",409.61,882,"COL",0)
^409.621^2^2
"KRN",409.61,882,"COL",1,0)
REACTANT^5^40^Reactant
"KRN",409.61,882,"COL",2,0)
ACTIVE^46^16^# Active Entries
"KRN",409.61,882,"COL","B","ACTIVE",2)

"KRN",409.61,882,"COL","B","REACTANT",1)

"KRN",409.61,882,"FNL")
D EXIT^GMRAFX
"KRN",409.61,882,"HDR")
D HDR^GMRAFX
"KRN",409.61,882,"HLP")
D HELP^GMRAFX
"KRN",409.61,882,"INIT")
D INIT^GMRAFX
"KRN",409.61,885,-1)
0^2
"KRN",409.61,885,0)
GMRA FIX DETAIL^1^^160^4^19^0^1^^GMRA FIX DETAIL MENU^Reactant Detailed Display^1^^1
"KRN",409.61,885,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,885,"ARRAY")
 ^TMP($J,LTYPE,"GMRADET")
"KRN",409.61,885,"COL",0)
^409.621^2^2
"KRN",409.61,885,"COL",1,0)
NAME^5^30^Patient Name
"KRN",409.61,885,"COL",2,0)
SSN^36^6^Last 4
"KRN",409.61,885,"COL","B","NAME",1)

"KRN",409.61,885,"COL","B","SSN",2)

"KRN",409.61,885,"FNL")
D EXIT^GMRAFX1
"KRN",409.61,885,"HDR")
D HDR^GMRAFX1
"KRN",409.61,885,"HLP")
D HELP^GMRAFX1
"KRN",409.61,885,"INIT")
D INIT^GMRAFX1
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"ORD",17,409.61)
409.61;17;1;;;;;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
20^3060719
"PKG",140,22,1,"PAH",1,1,0)
^^3^3^3060719
"PKG",140,22,1,"PAH",1,1,1,0)
This patch updates the clean up utility to include ingredient based
"PKG",140,22,1,"PAH",1,1,2,0)
and drug class based allergies.  Please see FORUM for the complete
"PKG",140,22,1,"PAH",1,1,3,0)
description of this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","GMRAFX")
0^1^B82732558^B91485304
"RTN","GMRAFX",1,0)
GMRAFX ;SLC/DAN Fix existing allergy entries ;3/2/06  13:46
"RTN","GMRAFX",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19,23,20**;Mar 29, 1996;Build 1
"RTN","GMRAFX",3,0)
 ;DBIA SECTION
"RTN","GMRAFX",4,0)
 ;10118 - VALM
"RTN","GMRAFX",5,0)
 ;2056  - DIQ
"RTN","GMRAFX",6,0)
 ;3744  - $$TESTPAT^VADPT
"RTN","GMRAFX",7,0)
 ;10006 - DIC
"RTN","GMRAFX",8,0)
 ;10103 - XLFDT
"RTN","GMRAFX",9,0)
 ;10102 - XQORM1
"RTN","GMRAFX",10,0)
 ;10104 - XLFSTR
"RTN","GMRAFX",11,0)
 ;10117 - VALM10
"RTN","GMRAFX",12,0)
 ;10116 - VALM1
"RTN","GMRAFX",13,0)
 ;10026 - DIR
"RTN","GMRAFX",14,0)
 ;10018 - DIE
"RTN","GMRAFX",15,0)
 ;10013 - DIK
"RTN","GMRAFX",16,0)
 ;10061 - VADPT
"RTN","GMRAFX",17,0)
 ;10101 - XQOR
"RTN","GMRAFX",18,0)
 ;
"RTN","GMRAFX",19,0)
EN ; -- main entry point for GMRA FIX
"RTN","GMRAFX",20,0)
 N NMBR,REBLD,Y,DIR,I,LTYPE
"RTN","GMRAFX",21,0)
 S LTYPE=$$GETTYPE^GMRAFX3(.LTYPE) Q:LTYPE=0
"RTN","GMRAFX",22,0)
 I $D(^XTMP("GMRAFX",LTYPE,"B")) W !,"The list is currently being built by another user so this option is",!,"temporarily unavailable.  Please try again in a few minutes." Q
"RTN","GMRAFX",23,0)
 I $D(^XTMP("GMRAFX",LTYPE,"INUSE")) D
"RTN","GMRAFX",24,0)
 .W !,"The utility is currently in use by the following people:",!
"RTN","GMRAFX",25,0)
 .S I=0 F  S I=$O(^XTMP("GMRAFX",LTYPE,"INUSE",I)) Q:'+I  W !,$$GET1^DIQ(200,I,.01)
"RTN","GMRAFX",26,0)
 .W !!,"As a result, the existing "_$S(LTYPE="FREE":"free text",LTYPE="ING":"ingredient",1:"drug class")_" list will be used." D WAIT^GMRAFX3
"RTN","GMRAFX",27,0)
 I $D(^XTMP("GMRAFX",LTYPE)),'$D(^XTMP("GMRAFX",LTYPE,"INUSE")) D
"RTN","GMRAFX",28,0)
 .W !,"The "_$S(LTYPE="FREE":"free text",LTYPE="ING":"ingredient",1:"drug class")_" list was last built on ",$$FMTE^XLFDT($P(^XTMP("GMRAFX",LTYPE,0),U,2)),!
"RTN","GMRAFX",29,0)
 .S DIR(0)="Y",DIR("A")="Do you want to rebuild the list",DIR("B")="NO",DIR("?")="Enter yes to rebuild the list of entries.  Enter NO to use the currently existing list"
"RTN","GMRAFX",30,0)
 .D ^DIR I Y=1 K ^XTMP("GMRAFX",LTYPE) S REBLD=1
"RTN","GMRAFX",31,0)
 I $G(REBLD)!('$D(^XTMP("GMRAFX",LTYPE))) W !,"Building list of "_$S(LTYPE="FREE":"free text",LTYPE="ING":"ingredient",1:"drug class")_" allergies...this may take a few minutes",!
"RTN","GMRAFX",32,0)
 S ^XTMP("GMRAFX",LTYPE,"INUSE",+$G(DUZ))=""
"RTN","GMRAFX",33,0)
 D EN^VALM("GMRA FIX")
"RTN","GMRAFX",34,0)
 K ^XTMP("GMRAFX",LTYPE,"INUSE",+$G(DUZ))
"RTN","GMRAFX",35,0)
 Q
"RTN","GMRAFX",36,0)
 ;
"RTN","GMRAFX",37,0)
HDR ; -- header code
"RTN","GMRAFX",38,0)
 S VALMHDR(1)="Allergy Tracking "_$S(LTYPE="FREE":"Free Text",LTYPE="ING":"Ingredient",1:"Drug CLass")_" Entries"
"RTN","GMRAFX",39,0)
 Q
"RTN","GMRAFX",40,0)
PHDR ;
"RTN","GMRAFX",41,0)
 S VALMSG="Select one or more entries"
"RTN","GMRAFX",42,0)
 S XQORM("#")=$$FIND1^DIC(101,,"BX","GMRA FIX FREE TEXT LIST") ;19
"RTN","GMRAFX",43,0)
 D SHOW^VALM
"RTN","GMRAFX",44,0)
 Q
"RTN","GMRAFX",45,0)
 ;
"RTN","GMRAFX",46,0)
INIT ;Initialize variables, etc
"RTN","GMRAFX",47,0)
 S VALMBCK="",VALMBG=$S($G(VALMBG)'="":VALMBG,1:1),VALMCNT=$S($D(^XTMP("GMRAFX",LTYPE,0)):$P(^(0),U,3),1:0),VALMWD=80
"RTN","GMRAFX",48,0)
 Q
"RTN","GMRAFX",49,0)
LIST ; -- obtain and display list of free text allergies
"RTN","GMRAFX",50,0)
 N GMRAIEN,GMRAOTH,GMRATXT,GMRAUTXT,SP1,SP2,SP3,UP,TXT
"RTN","GMRAFX",51,0)
 S VALMBCK="R",VALMCNT=0
"RTN","GMRAFX",52,0)
 K ^XTMP("GMRAFX",LTYPE) S ^XTMP("GMRAFX",LTYPE,"B")="",^XTMP("GMRAFX",LTYPE,"INUSE",+$G(DUZ))=""
"RTN","GMRAFX",53,0)
 S GMRAOTH=$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0))_";GMRD(120.82," ;Gets IEN;FILE ENTRY for free text entries
"RTN","GMRAFX",54,0)
 S GMRAIEN=0 F  S GMRAIEN=$O(^GMR(120.8,GMRAIEN)) Q:'+GMRAIEN  D
"RTN","GMRAFX",55,0)
 .I LTYPE="FREE" I $P($G(^GMR(120.8,GMRAIEN,0)),U,3)'=GMRAOTH Q
"RTN","GMRAFX",56,0)
 .I LTYPE="ING" I $P($G(^GMR(120.8,GMRAIEN,0)),U,3)'["50.416" Q
"RTN","GMRAFX",57,0)
 .I LTYPE="DRUG" I $P($G(^GMR(120.8,GMRAIEN,0)),U,3)'["50.605" Q
"RTN","GMRAFX",58,0)
 .Q:+$G(^GMR(120.8,GMRAIEN,"ER"))  ;Quit if reactant entered in error
"RTN","GMRAFX",59,0)
 .Q:$$DECEASED(+$P($G(^GMR(120.8,GMRAIEN,0)),U))  ;Don't report expired patients
"RTN","GMRAFX",60,0)
 .Q:$$TESTPAT^VADPT($P($G(^GMR(120.8,GMRAIEN,0)),U))  ;Don't report test patients
"RTN","GMRAFX",61,0)
 .S GMRATXT=$E($P($G(^GMR(120.8,GMRAIEN,0)),U,2),1,75) ;Get "reactant" text entry, no more than 75 characters
"RTN","GMRAFX",62,0)
 .S GMRATXT=$TR(GMRATXT,"""","") ;19 remove quote marks from text
"RTN","GMRAFX",63,0)
 .S GMRAUTXT=$$UP^XLFSTR(GMRATXT) ;Convert to upper case
"RTN","GMRAFX",64,0)
 .S ^XTMP("GMRAFX",LTYPE,"GMRAR",GMRAUTXT,GMRATXT)=$G(^XTMP("GMRAFX",LTYPE,"GMRAR",GMRAUTXT,GMRATXT))+1 ;# of active entries
"RTN","GMRAFX",65,0)
 .S ^XTMP("GMRAFX",LTYPE,"GMRAR",GMRAUTXT,GMRATXT,GMRAIEN)="" ;Store entry number
"RTN","GMRAFX",66,0)
 .Q
"RTN","GMRAFX",67,0)
 S UP="" F  S UP=$O(^XTMP("GMRAFX",LTYPE,"GMRAR",UP)) Q:UP=""  S TXT="" F  S TXT=$O(^XTMP("GMRAFX",LTYPE,"GMRAR",UP,TXT)) Q:TXT=""  D
"RTN","GMRAFX",68,0)
 .S VALMCNT=VALMCNT+1
"RTN","GMRAFX",69,0)
 .S SP1=4-$L(VALMCNT),SP2=40-$L(TXT),SP3=16-$L(^XTMP("GMRAFX",LTYPE,"GMRAR",UP,TXT))\2 ;Set up spacing before storing
"RTN","GMRAFX",70,0)
 .D SET^VALM10(VALMCNT,VALMCNT_$$REPEAT^XLFSTR(" ",SP1)_TXT_$$REPEAT^XLFSTR(" ",SP2)_$$REPEAT^XLFSTR(" ",SP3)_^XTMP("GMRAFX",LTYPE,"GMRAR",UP,TXT))
"RTN","GMRAFX",71,0)
 .S ^XTMP("GMRAFX",LTYPE,"IDX",VALMCNT)=UP_"^"_TXT
"RTN","GMRAFX",72,0)
 K ^XTMP("GMRAFX",LTYPE,"B") ;Done building
"RTN","GMRAFX",73,0)
 S ^XTMP("GMRAFX",LTYPE,0)=$$FMADD^XLFDT(DT,30)_U_DT_U_$G(VALMCNT)
"RTN","GMRAFX",74,0)
 Q
"RTN","GMRAFX",75,0)
 ;
"RTN","GMRAFX",76,0)
HELP ; -- help code
"RTN","GMRAFX",77,0)
 D FULL^VALM1
"RTN","GMRAFX",78,0)
 W !!,"Use AE to add local allergies to the GMR ALLERGY file.  This",!,"should only be done if you're sure no existing reactant matches your needs."
"RTN","GMRAFX",79,0)
 W !!,"Use EE to mark all entries within the selected group as entered",!,"in error.  You may select multiple groups if you like."
"RTN","GMRAFX",80,0)
 W !!,"Use DD to get a detailed display.  It's highly recommended that you",!,"use the detailed display menu to make all changes."
"RTN","GMRAFX",81,0)
 W !!,"Use UR to update the reactant.  Extreme caution should be used when doing",!,"mass updates.  It would be better to do the updates from within",!,"the detailed display menu.",!
"RTN","GMRAFX",82,0)
 D WAIT^GMRAFX3 S VALMBCK="R"
"RTN","GMRAFX",83,0)
 Q
"RTN","GMRAFX",84,0)
 ;
"RTN","GMRAFX",85,0)
EXIT ; -- exit code
"RTN","GMRAFX",86,0)
 D FULL^VALM1
"RTN","GMRAFX",87,0)
 D DESELECT  ;Clear any remaining items
"RTN","GMRAFX",88,0)
 Q
"RTN","GMRAFX",89,0)
 ;
"RTN","GMRAFX",90,0)
EXPND ; -- expand code
"RTN","GMRAFX",91,0)
 Q
"RTN","GMRAFX",92,0)
 ;
"RTN","GMRAFX",93,0)
CHKSEL ;Evaluate selection if done by number
"RTN","GMRAFX",94,0)
 N J,TMP,DIR,NUM,X,Y,TNMBR
"RTN","GMRAFX",95,0)
 S VALMBCK="R"
"RTN","GMRAFX",96,0)
 S NUM=$P($G(XQORNOD(0)),"=",2) ;get currently selected entries
"RTN","GMRAFX",97,0)
 I NUM'="" D
"RTN","GMRAFX",98,0)
 .I NUM=$G(NMBR) D DESELECT Q  ;If user selects same entry without taking an entry, unhighlight and stop processing
"RTN","GMRAFX",99,0)
 .D DESELECT:$G(NMBR) ;If user previously selected entries but took no action, unhighlight before highlighting new choices
"RTN","GMRAFX",100,0)
 .S NMBR=$P(XQORNOD(0),"=",2),DIR(0)="L^"_"1:"_VALMCNT,X=NMBR,DIR("V")="" D ^DIR K DIR
"RTN","GMRAFX",101,0)
 .I Y="" D FULL^VALM1 W !,"Invalid selection." D WAIT^GMRAFX3 K NMBR Q  ;Selection out of range, stop processing
"RTN","GMRAFX",102,0)
 .S TNMBR=""
"RTN","GMRAFX",103,0)
 .F J=1:1:$L(NMBR,",")-1 S TMP=$P(NMBR,",",J) I $$LOCK^GMRAFX3(TMP) S TNMBR=TNMBR_TMP_"," D CNTRL^VALM10(TMP,1,+$G(VALMWD),IORVON,IORVOFF)
"RTN","GMRAFX",104,0)
 .I TNMBR="" K NMBR Q
"RTN","GMRAFX",105,0)
 .S NMBR=TNMBR
"RTN","GMRAFX",106,0)
 Q
"RTN","GMRAFX",107,0)
 ;
"RTN","GMRAFX",108,0)
DESELECT ;Un-highlight selected choices
"RTN","GMRAFX",109,0)
 N J,TMP
"RTN","GMRAFX",110,0)
 F J=1:1:$L($G(NMBR),",")-1 S TMP=$P(NMBR,",",J) D CNTRL^VALM10(TMP,1,+$G(VALMWD),IORVOFF,IORVOFF) L -^XTMP("GMRAFX","IDX",TMP)
"RTN","GMRAFX",111,0)
 K NMBR
"RTN","GMRAFX",112,0)
 Q
"RTN","GMRAFX",113,0)
 ;
"RTN","GMRAFX",114,0)
AEA ; Entry for GMRA LOCAL ALLERGIES EDIT option
"RTN","GMRAFX",115,0)
 S VALMBCK="R" D FULL^VALM1,PROCESS^GMRAFUT0,WAIT^GMRAFX3 Q  ;23
"RTN","GMRAFX",116,0)
 N DLAYGO,DIC,Y,GMRAIEN,DA,GMRALN,DIE,GMRACT,DR,GMRAX,GMRAY,X
"RTN","GMRAFX",117,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX",118,0)
 W ! S DLAYGO=120.82,DIC="^GMRD(120.82,",DIC("A")="Select a LOCAL ALLERGY/ADVERSE REACTION: ",DIC(0)="AEQML",DIC("DR")="1" D ^DIC K DIC,DLAYGO Q:+Y'>0  S (DA,GMRAIEN)=+Y
"RTN","GMRAFX",119,0)
 L +^GMRD(120.82,GMRAIEN):1 I '$T W !,"THIS ENTRY IS BEING EDITED BY SOMEONE ELSE" Q
"RTN","GMRAFX",120,0)
 S GMRALN=$G(^GMRD(120.82,GMRAIEN,0))
"RTN","GMRAFX",121,0)
 S DIE="^GMRD(120.82,",DR="",GMRACT=1
"RTN","GMRAFX",122,0)
 I +$P(GMRALN,U,3) S DR(1,120.82,1)="@1;W !!,$C(7),""CANNOT EDIT NAME FIELD OF A NATIONAL ALLERGY."",!;3;"
"RTN","GMRAFX",123,0)
 E  D
"RTN","GMRAFX",124,0)
 .S DR(1,120.82,1)=".01;3;"
"RTN","GMRAFX",125,0)
 .S DR(1,120.82,2)="S (GMRAY,GMRAX)=$P(GMRALN,U,2) D EDTTYPE^GMRAUTL(.GMRAX);"
"RTN","GMRAFX",126,0)
 .S DR(1,120.82,3)="S:GMRAX=GMRAY!(""^^""[GMRAX) X=GMRAX,Y=$S(""^^""[GMRAX:""@3"",1:""@4"");1///^S X=GMRAX;@4;4;5;@3;"
"RTN","GMRAFX",127,0)
 .Q
"RTN","GMRAFX",128,0)
 D ^DIE
"RTN","GMRAFX",129,0)
 L -^GMRD(120.82,GMRAIEN)
"RTN","GMRAFX",130,0)
 Q
"RTN","GMRAFX",131,0)
 ;
"RTN","GMRAFX",132,0)
PROCESS(TYPE) ;API to mark all entries as entered in error or update entries to new reactant
"RTN","GMRAFX",133,0)
 N GMRAPA,GMRAI,GMRAJ,DIR,Y,ROOT,NUM,ENTRY,GMRADONE,STOP,J,TNMBR,GMRAAR,GMRASURE
"RTN","GMRAFX",134,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX",135,0)
 I '$G(NMBR) S NMBR=$$GETNUM^GMRAFX3("") Q:'+NMBR  D  Q:'+$G(NMBR)
"RTN","GMRAFX",136,0)
 .S TNMBR=""
"RTN","GMRAFX",137,0)
 .F J=1:1:$L(NMBR,",")-1 S TMP=$P(NMBR,",",J) I $$LOCK^GMRAFX3(TMP) S TNMBR=TNMBR_TMP_","
"RTN","GMRAFX",138,0)
 .I TNMBR="" K NMBR Q
"RTN","GMRAFX",139,0)
 .S NMBR=TNMBR
"RTN","GMRAFX",140,0)
 I TYPE="U" W !!,"You should use the detailed display option to review entries in",!,"this group before doing a mass update.  CHANGES CANNOT BE UN-DONE!" D WAIT^GMRAFX3
"RTN","GMRAFX",141,0)
 W !!,"You are about to ",$S(TYPE="E":"mark",1:"update")," ALL allergies with the selected reactant ",!,$S(TYPE="E":"as entered in error.",1:"to a new reactant."),!
"RTN","GMRAFX",142,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="ARE YOU SURE"
"RTN","GMRAFX",143,0)
 S DIR("?")="If you're unsure, use the 'detailed display' option to get a list of individual patients."
"RTN","GMRAFX",144,0)
 S DIR("?",1)="Answering YES to this prompt will cause all allergies associated with"
"RTN","GMRAFX",145,0)
 S DIR("?",2)="the selected reactant to be "_$S(TYPE="E":"marked as entered in error.",1:"updated to the new reactant.")
"RTN","GMRAFX",146,0)
 S DIR("?",3)=""
"RTN","GMRAFX",147,0)
 S DIR("?",4)="Be SURE this is what you want to do."
"RTN","GMRAFX",148,0)
 D ^DIR Q:Y'=1  ;Stop if user doesn't answer yes
"RTN","GMRAFX",149,0)
 F GMRAI=1:1:($L(NMBR,",")-1) D
"RTN","GMRAFX",150,0)
 .S NUM=$P(NMBR,",",GMRAI),ENTRY=^XTMP("GMRAFX",LTYPE,"IDX",NUM),STOP=0
"RTN","GMRAFX",151,0)
 .S ROOT="^XTMP(""GMRAFX"",LTYPE,""GMRAR"","_""""_$P(ENTRY,"^")_""""_","_""""_$P(ENTRY,"^",2)_""""_")",GMRAJ=0 Q:'@ROOT
"RTN","GMRAFX",152,0)
 .I TYPE="U" W !!,"Updating ",$P(ENTRY,U)," reactions"
"RTN","GMRAFX",153,0)
 .F  S GMRAJ=$O(@ROOT@(GMRAJ)) Q:GMRAJ=""!($G(STOP))  I GMRAJ D
"RTN","GMRAFX",154,0)
 ..S GMRAPA=GMRAJ,GMRADONE=1 D @$S(TYPE="E":"EIE",1:"UIE^GMRAFX3")
"RTN","GMRAFX",155,0)
 ..D:GMRADONE UPDATE^GMRAFX3
"RTN","GMRAFX",156,0)
 Q
"RTN","GMRAFX",157,0)
 ;
"RTN","GMRAFX",158,0)
EIE ;Mark individual entry as entered in error
"RTN","GMRAFX",159,0)
 D EIE^GMRAFX3 ;Moved due to size limits
"RTN","GMRAFX",160,0)
 Q
"RTN","GMRAFX",161,0)
 ;
"RTN","GMRAFX",162,0)
DECEASED(GMRAIFN) ;Function returns 1 if patient is deceased, 0 if living
"RTN","GMRAFX",163,0)
 N DFN,VADM
"RTN","GMRAFX",164,0)
 Q:GMRAIFN=0 1  ;If no patient entry return true
"RTN","GMRAFX",165,0)
 S DFN=GMRAIFN
"RTN","GMRAFX",166,0)
 D DEM^VADPT
"RTN","GMRAFX",167,0)
 Q $S(+VADM(6):1,1:0)  ;VADM(6) holds date of death
"RTN","GMRAFX",168,0)
 ;
"RTN","GMRAFX",169,0)
ADCOM(ENTRY,TYPE,COM) ;Add comment to allergy
"RTN","GMRAFX",170,0)
 N DIC,DIE,DR,DA,Y,X
"RTN","GMRAFX",171,0)
 S DA(1)=ENTRY
"RTN","GMRAFX",172,0)
 S DIC="^GMR(120.8,"_DA(1)_",26,",DIC(0)="L" F  S X=$$NOW^XLFDT Q:'$D(^GMR(120.8,DA(1),26,"B",X))  ;23 Don't allow duplicate entries
"RTN","GMRAFX",173,0)
 D ^DIC Q:Y=-1  ;add new comment multiple
"RTN","GMRAFX",174,0)
 S DA=+Y
"RTN","GMRAFX",175,0)
 S DIE=DIC K DIC
"RTN","GMRAFX",176,0)
 S DR="1////"_$G(DUZ,.5)_";1.5///"_TYPE_";2///"_$TR(COM,";"," ") ;remove semi-colon from free text
"RTN","GMRAFX",177,0)
 D ^DIE ;Comment added by user
"RTN","GMRAFX",178,0)
 Q
"RTN","GMRAFX1")
0^2^B32262757^B31454366
"RTN","GMRAFX1",1,0)
GMRAFX1 ;SLC/DAN Fix existing allergy entries-continued ;10/6/05  11:42
"RTN","GMRAFX1",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19,20**;Mar 29, 1996;Build 1
"RTN","GMRAFX1",3,0)
 ;DBIA SECTION
"RTN","GMRAFX1",4,0)
 ;10116 - VALM1
"RTN","GMRAFX1",5,0)
 ;10102 - XQORM1
"RTN","GMRAFX1",6,0)
 ;10104 - XLFSTR
"RTN","GMRAFX1",7,0)
 ;10061 - VADPT
"RTN","GMRAFX1",8,0)
 ;10017 - VALM10
"RTN","GMRAFX1",9,0)
 ;10118 - VALM
"RTN","GMRAFX1",10,0)
 ;10026 - DIR
"RTN","GMRAFX1",11,0)
 ;
"RTN","GMRAFX1",12,0)
DET ;Detailed listing of selected group
"RTN","GMRAFX1",13,0)
 N DIR,Y,DTOUT,DUOUT,DIRUT,J,GMRAT,GMRAUT,DFN,GMRA,GMRAL,VADM,CNT,VAERR,K,LEN,NAME,ENTRY,NMBR2,ENMBR,GMRAR
"RTN","GMRAFX1",14,0)
 S VALMBCK="R",CNT=0
"RTN","GMRAFX1",15,0)
 K ^TMP($J,LTYPE,"GMRADET"),^TMP($J,LTYPE,"IDX2")
"RTN","GMRAFX1",16,0)
 S ENMBR=+NMBR ;get number portion of entry
"RTN","GMRAFX1",17,0)
 S ENTRY=0
"RTN","GMRAFX1",18,0)
 S GMRAUT=$P(^XTMP("GMRAFX",LTYPE,"IDX",ENMBR),"^"),GMRAT=$P(^XTMP("GMRAFX",LTYPE,"IDX",ENMBR),"^",2)
"RTN","GMRAFX1",19,0)
 S J=0 F  S J=$O(^XTMP("GMRAFX",LTYPE,"GMRAR",GMRAUT,GMRAT,J)) Q:'+J  D
"RTN","GMRAFX1",20,0)
 .S DFN=$P($G(^GMR(120.8,J,0)),"^"),GMRA="0^0^111" D ^GMRADPT ;Get patient allergies
"RTN","GMRAFX1",21,0)
 .D DEM^VADPT ;Get patient information
"RTN","GMRAFX1",22,0)
 .Q:$G(VAERR)  ;Quit if patient lookup produces an error
"RTN","GMRAFX1",23,0)
 .S CNT=CNT+1,ENTRY=ENTRY+1
"RTN","GMRAFX1",24,0)
 .S GMRAR(CNT)=VADM(1)_$$REPEAT^XLFSTR(" ",(32-$L(VADM(1))))_$E(VADM(2),6,9)_" "
"RTN","GMRAFX1",25,0)
 .D SET^VALM10(CNT,ENTRY_$$REPEAT^XLFSTR(" ",(4-$L(ENTRY)))_GMRAR(CNT)) K GMRAR(CNT) ;19
"RTN","GMRAFX1",26,0)
 .S ^TMP($J,LTYPE,"IDX2",ENTRY)=CNT_"^"_J
"RTN","GMRAFX1",27,0)
 .S CNT=CNT+1,LEN=0,GMRAR(CNT)="Allergies: "
"RTN","GMRAFX1",28,0)
 .S K=0 F  S K=$O(GMRAL(K)) Q:'+K  D
"RTN","GMRAFX1",29,0)
 ..S NAME=$P(GMRAL(K),"^",2) ;Allergy name
"RTN","GMRAFX1",30,0)
 ..S LEN=LEN+$L(NAME)+1
"RTN","GMRAFX1",31,0)
 ..I LEN>70 D SET^VALM10(CNT,GMRAR(CNT)) K GMRAR(CNT) S CNT=CNT+1,LEN=$L(NAME)+1,GMRAR(CNT)="   " ;19
"RTN","GMRAFX1",32,0)
 ..S GMRAR(CNT)=$G(GMRAR(CNT))_NAME_$S($O(GMRAL(K)):"~",1:"") D:'$O(GMRAL(K)) SET^VALM10(CNT,GMRAR(CNT)) ;19
"RTN","GMRAFX1",33,0)
 S VALMCNT=CNT,^TMP($J,LTYPE,"IDX2",0)=ENTRY
"RTN","GMRAFX1",34,0)
 Q
"RTN","GMRAFX1",35,0)
 ;
"RTN","GMRAFX1",36,0)
HDR ; -- header code
"RTN","GMRAFX1",37,0)
 S VALMHDR(1)="Patient listing for reactant "_$S(+$G(NMBR):$P(^XTMP("GMRAFX",LTYPE,"IDX",+NMBR),"^"),1:"")
"RTN","GMRAFX1",38,0)
 Q
"RTN","GMRAFX1",39,0)
 ;
"RTN","GMRAFX1",40,0)
PHDR ;
"RTN","GMRAFX1",41,0)
 S VALMSG="Select a patient"
"RTN","GMRAFX1",42,0)
 S XQORM("#")=$$FIND1^DIC(101,,"BX","GMRA FIX DETAIL MENU") ;19
"RTN","GMRAFX1",43,0)
 D SHOW^VALM
"RTN","GMRAFX1",44,0)
 Q
"RTN","GMRAFX1",45,0)
 ;
"RTN","GMRAFX1",46,0)
INIT ; -- init variables and list array
"RTN","GMRAFX1",47,0)
 N DIR
"RTN","GMRAFX1",48,0)
 I '$G(NMBR) S NMBR=$$GETNUM^GMRAFX3("DET") S:'+NMBR VALMQUIT="" Q:'+NMBR  I '$$LOCK^GMRAFX3(+NMBR) S VALMQUIT="" Q
"RTN","GMRAFX1",49,0)
 I $L($G(NMBR),",")>2 D FULL^VALM1 W !,"Please select",$S('$G(NMBR):"",1:" only")," one entry from the list." S DIR(0)="E",DIR("A")="Press enter to continue" D ^DIR S VALMQUIT=1 Q
"RTN","GMRAFX1",50,0)
 K ^TMP($J,LTYPE,"GMRADET"),^TMP($J,LTYPE,"IDX2")
"RTN","GMRAFX1",51,0)
 S VALMBCK="",VALMBG=$G(VALMBG,1),VALMCNT=0,VALMWD=80
"RTN","GMRAFX1",52,0)
 Q
"RTN","GMRAFX1",53,0)
 ;
"RTN","GMRAFX1",54,0)
CHKSEL ;Evaluate selection if done by number
"RTN","GMRAFX1",55,0)
 N J,TMP,DIR,NUM,X,Y
"RTN","GMRAFX1",56,0)
 S NUM=$P($G(XQORNOD(0)),"=",2) ;get currently selected entries
"RTN","GMRAFX1",57,0)
 I NUM'="" D
"RTN","GMRAFX1",58,0)
 .I NUM=$G(NMBR2) D DESELECT Q  ;If user selects same entry without taking an entry, unhighlight and stop processing
"RTN","GMRAFX1",59,0)
 .D DESELECT:$G(NMBR2) ;If user previously selected entries but took no action, unhighlight before highlighting new choices
"RTN","GMRAFX1",60,0)
 .S NMBR2=$P(XQORNOD(0),"=",2),DIR(0)="L^"_"1:"_$G(^TMP($J,LTYPE,"IDX2",0)),X=NMBR2,DIR("V")="" D ^DIR K DIR
"RTN","GMRAFX1",61,0)
 .I Y="" D FULL^VALM1 W !,"Invalid selection." D WAIT^GMRAFX3 K NMBR2 Q  ;Selection out of range, stop processing
"RTN","GMRAFX1",62,0)
 .F J=1:1:$L(NMBR2,",")-1 S TMP=$P(NMBR2,",",J) D CNTRL^VALM10(+^TMP($J,LTYPE,"IDX2",TMP),1,+$G(VALMWD),IORVON,IORVOFF)
"RTN","GMRAFX1",63,0)
 Q
"RTN","GMRAFX1",64,0)
 ;
"RTN","GMRAFX1",65,0)
DESELECT ;Un-highlight selected choices
"RTN","GMRAFX1",66,0)
 N J,TMP
"RTN","GMRAFX1",67,0)
 F J=1:1:$L($G(NMBR2),",")-1 S TMP=$P(NMBR2,",",J) D CNTRL^VALM10(+^TMP($J,LTYPE,"IDX2",TMP),1,+$G(VALMWD),IORVOFF,IORVOFF)
"RTN","GMRAFX1",68,0)
 K NMBR2
"RTN","GMRAFX1",69,0)
 Q
"RTN","GMRAFX1",70,0)
HELP ; -- help code
"RTN","GMRAFX1",71,0)
 D FULL^VALM1
"RTN","GMRAFX1",72,0)
 W !!,"Use AE to add local allergies to the GMR ALLERGY file.  This",!,"should only be done if you're sure no existing reactant matches your needs."
"RTN","GMRAFX1",73,0)
 W !!,"Use EE to mark all selected entries as entered",!,"in error.  You may select multiple patients if you like."
"RTN","GMRAFX1",74,0)
 W !!,"Use UR to update the reactant.  Extreme caution should be used when updating",!,"reactants.  You may select multiple patients if you like,"
"RTN","GMRAFX1",75,0)
 W !!,"Use PR to add new allergies for the selected patient in",!,"addition to the ones listed here."
"RTN","GMRAFX1",76,0)
 W !!,"Use DD to get details about the allergy entry that you're",!,"currently working on for this patient.",!
"RTN","GMRAFX1",77,0)
 D WAIT^GMRAFX3 S VALMBCK="R"
"RTN","GMRAFX1",78,0)
 Q
"RTN","GMRAFX1",79,0)
 ;
"RTN","GMRAFX1",80,0)
EXIT ; -- exit code
"RTN","GMRAFX1",81,0)
 K ^TMP($J,LTYPE,"IDX2"),^TMP($J,LTYPE,"GMRADET")
"RTN","GMRAFX1",82,0)
 Q
"RTN","GMRAFX1",83,0)
 ;
"RTN","GMRAFX1",84,0)
EXPND ; -- expand code
"RTN","GMRAFX1",85,0)
 Q
"RTN","GMRAFX1",86,0)
 ;
"RTN","GMRAFX1",87,0)
PROCESS(TYPE) ;API to mark selected entries from the detailed listing as entered in error or update to new reactant
"RTN","GMRAFX1",88,0)
 N GMRAPA,GMRAJ,DIR,Y,NUM,GMRADONE,ENTRY,GMRAI,STOP,NUM2,GMRAAR
"RTN","GMRAFX1",89,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX1",90,0)
 I '$G(NMBR2) S NMBR2=$$GETNUM^GMRAFX3("") Q:'+NMBR2
"RTN","GMRAFX1",91,0)
 W !!,"You are about to ",$S(TYPE="E":"mark",1:"update")," the selected patient",$S($L(NMBR2,",")>2:"s'",1:"'s"),!
"RTN","GMRAFX1",92,0)
 S ENTRY=$G(^XTMP("GMRAFX",LTYPE,"IDX",+NMBR))
"RTN","GMRAFX1",93,0)
 W $P(ENTRY,"^",2)," allergy ",$S(TYPE="E":"as entered in error.",1:"to a new reactant."),!
"RTN","GMRAFX1",94,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="ARE YOU SURE"
"RTN","GMRAFX1",95,0)
 S DIR("?")="Once allergies are updated or marked as entered in error it cannot be undone!"
"RTN","GMRAFX1",96,0)
 S DIR("?",1)="Be sure this is what you want to do."
"RTN","GMRAFX1",97,0)
 D ^DIR Q:Y'=1  ;Stop if user doesn't answer yes
"RTN","GMRAFX1",98,0)
 S NUM=+NMBR
"RTN","GMRAFX1",99,0)
 F GMRAI=1:1:($L(NMBR2,",")-1) D  Q:$G(STOP)
"RTN","GMRAFX1",100,0)
 .S GMRADONE=1
"RTN","GMRAFX1",101,0)
 .S NUM2=$P(NMBR2,",",GMRAI)
"RTN","GMRAFX1",102,0)
 .S (GMRAPA,GMRAJ)=$P(^TMP($J,LTYPE,"IDX2",NUM2),U,2) Q:'GMRAPA
"RTN","GMRAFX1",103,0)
 .D @$S(TYPE="E":"EIE^GMRAFX",1:"UIE^GMRAFX3")
"RTN","GMRAFX1",104,0)
 .D:$G(GMRADONE) UPDATE^GMRAFX3
"RTN","GMRAFX1",105,0)
 Q
"RTN","GMRAFX3")
0^3^B68434515^B36523272
"RTN","GMRAFX3",1,0)
GMRAFX3 ;SLC/DAN Update existing entries to new reactant ;6/28/06  10:23
"RTN","GMRAFX3",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19,23,20**;Mar 29, 1996;Build 1
"RTN","GMRAFX3",3,0)
 ;DBIA SECTION
"RTN","GMRAFX3",4,0)
 ;10018 - DIE
"RTN","GMRAFX3",5,0)
 ;2056  - DIQ
"RTN","GMRAFX3",6,0)
 ;3154  - ORQ1
"RTN","GMRAFX3",7,0)
 ;4134  - ORCHECK
"RTN","GMRAFX3",8,0)
 ;4135  - ORKCHK
"RTN","GMRAFX3",9,0)
 ;10026 - DIR
"RTN","GMRAFX3",10,0)
 ;
"RTN","GMRAFX3",11,0)
UIE ;Update individual entries
"RTN","GMRAFX3",12,0)
 N DFN,GMRAOUT,GMRAING,GMRADRCL,DIE,DA,DR,AIFN,SIGN,TIME,SUB,ORX,GMRAORX,GMRAOC,GI,FND,COM,SIEN,DIR,Y
"RTN","GMRAFX3",13,0)
 S GMRADONE=0 ;Flag to keep track of updated entries
"RTN","GMRAFX3",14,0)
 S DFN=$P($G(^GMR(120.8,GMRAPA,0)),U) Q:'+DFN
"RTN","GMRAFX3",15,0)
 W !!,"For patient ",$$GET1^DIQ(2,DFN_",",.01),!
"RTN","GMRAFX3",16,0)
 I $D(GMRAAR) D
"RTN","GMRAFX3",17,0)
 .S DIR(0)="Y",DIR("A")="Use reactant "_GMRAAR(0),DIR("B")="Y" D ^DIR
"RTN","GMRAFX3",18,0)
 .K:'Y GMRAAR
"RTN","GMRAFX3",19,0)
 .Q
"RTN","GMRAFX3",20,0)
 I '$D(GMRAAR) D ^GMRAFX2 I $D(GMRAAR) D RUSURE(.GMRASURE) ;20 Get new reactant
"RTN","GMRAFX3",21,0)
 I '$D(GMRAAR)!('$G(GMRASURE)) K GMRAAR Q  ;20 stop if no reactant selected or if user doesn't want to use selected reactant
"RTN","GMRAFX3",22,0)
 S GMRAOUT=0
"RTN","GMRAFX3",23,0)
 I $$DUP W !,"Patient already has an active allergy for this reactant.",!,"Duplicate not allowed.",! D WAIT Q
"RTN","GMRAFX3",24,0)
 I $$DUPCHK^GMRAPES0(GMRAAR(0),DFN,GMRAPA) Q  ;Checks to see if reactant previously entered in error.
"RTN","GMRAFX3",25,0)
 ;Update reactant, allergy and signed off fields
"RTN","GMRAFX3",26,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR=".02////"_GMRAAR(0)_";1////^S X=GMRAAR"_";3.1////"_GMRAAR("O")_";15///1" D ^DIE
"RTN","GMRAFX3",27,0)
 I $D(^GMR(120.85,"C",GMRAPA)) D  ;Observed reaction, need to update data
"RTN","GMRAFX3",28,0)
 .S AIFN=0
"RTN","GMRAFX3",29,0)
 .F  S AIFN=$O(^GMR(120.85,"C",GMRAPA,AIFN)) Q:'+AIFN  D
"RTN","GMRAFX3",30,0)
 ..S SIEN=$O(^GMR(120.85,AIFN,3,"B",$P(^XTMP("GMRAFX",LTYPE,"IDX",+NMBR),"^"),0)) Q:'+SIEN  ;Was previous reactant stored as "suspected agent"
"RTN","GMRAFX3",31,0)
 ..S DA(1)=AIFN,DA=SIEN
"RTN","GMRAFX3",32,0)
 ..S DIE="^GMR(120.85,DA(1),3,",DR=".01////^S X=GMRAAR(0)" D ^DIE ;Update suspected agent to new value
"RTN","GMRAFX3",33,0)
 D DELMUL(2),DELMUL(3) ;Delete drug ingredient/drug classes multiples
"RTN","GMRAFX3",34,0)
 I GMRAAR("O")["D" D UPDATE^GMRAPES1 ;If reactant type is Drug then add appropriate ingredients and classes
"RTN","GMRAFX3",35,0)
 S GMRADONE=1 ;Update complete
"RTN","GMRAFX3",36,0)
 S COM="Updated using clean up process.  Changed reactant from "_$P(^XTMP("GMRAFX",LTYPE,"IDX",+NMBR),"^",2)_$S(LTYPE="FREE":" (free text) ",LTYPE="ING":" (ingredient) ",1:" (drug class) ")_"to "_GMRAAR(0)_"(file - "_$P(GMRAAR,";",2)_")"
"RTN","GMRAFX3",37,0)
 D ADCOM^GMRAFX(GMRAPA,"O",COM) ;Add a comment for this update
"RTN","GMRAFX3",38,0)
 ;Do order checking here - compare existing orders against new allergy information.
"RTN","GMRAFX3",39,0)
 W !,"Performing order checking..."
"RTN","GMRAFX3",40,0)
 K ^TMP("ORR",$J),GMRAOC,ORX
"RTN","GMRAFX3",41,0)
 D EN^ORQ1(DFN_";DPT(") ;Retrieve active orders
"RTN","GMRAFX3",42,0)
 S TIME=$O(^TMP("ORR",$J,0))
"RTN","GMRAFX3",43,0)
 I '^TMP("ORR",$J,TIME,"TOT") W "patient has no active orders." Q  ;20 No orders found
"RTN","GMRAFX3",44,0)
 S SUB=0 F  S SUB=$O(^TMP("ORR",$J,TIME,SUB)) Q:'+SUB  D
"RTN","GMRAFX3",45,0)
 .D BLD^ORCHECK(+^TMP("ORR",$J,TIME,SUB)) ;Get "order" information in order checking format
"RTN","GMRAFX3",46,0)
 M GMRAORX=ORX K ORX ;19
"RTN","GMRAFX3",47,0)
 D EN^ORKCHK(.GMRAOC,DFN,.GMRAORX,"ACCEPT")
"RTN","GMRAFX3",48,0)
 S GI=0,FND=0 F  S GI=$O(GMRAOC(GI)) Q:'+GI  D
"RTN","GMRAFX3",49,0)
 .Q:$P(GMRAOC(GI),U,2)'=3  ;Quit if not allergy related
"RTN","GMRAFX3",50,0)
 .Q:$D(^OR(100,$P(GMRAOC(GI),U),9,"B",3))  ;23 If order check exists can't be for this data
"RTN","GMRAFX3",51,0)
 .W !,"Patient has a(n) ",$P($$STATUS^ORQOR2($P(GMRAOC(GI),U)),U,2)," order for",$P($P(GMRAOC(GI),U,4),":",2),", order #",$P(GMRAOC(GI),U)
"RTN","GMRAFX3",52,0)
 .S FND=1
"RTN","GMRAFX3",53,0)
 W:'FND "No problems found"
"RTN","GMRAFX3",54,0)
 D WAIT
"RTN","GMRAFX3",55,0)
 Q
"RTN","GMRAFX3",56,0)
 ;
"RTN","GMRAFX3",57,0)
DELMUL(FIELD) ;Delete multiple FIELD from GMR ALLERGY file
"RTN","GMRAFX3",58,0)
 N MIEN,DA,DIE,DR
"RTN","GMRAFX3",59,0)
 S MIEN=0 F  S MIEN=$O(^GMR(120.8,GMRAPA,FIELD,MIEN)) Q:'+MIEN  D
"RTN","GMRAFX3",60,0)
 .S DA(1)=GMRAPA,DA=MIEN
"RTN","GMRAFX3",61,0)
 .S DIE="^GMR(120.8,DA(1),FIELD,",DR=".01///@" D ^DIE ;Delete entry
"RTN","GMRAFX3",62,0)
 Q
"RTN","GMRAFX3",63,0)
 ;
"RTN","GMRAFX3",64,0)
DUP() ;Function returns true (1) if selected reactant is a duplicate
"RTN","GMRAFX3",65,0)
 N LOOP,FND
"RTN","GMRAFX3",66,0)
 S LOOP=0,FND=0
"RTN","GMRAFX3",67,0)
 F  S LOOP=$O(^GMR(120.8,"B",DFN,LOOP)) Q:'+LOOP!(FND)  D
"RTN","GMRAFX3",68,0)
 .I $P(^GMR(120.8,LOOP,0),U,3)=GMRAAR&('$D(^GMR(120.8,LOOP,"ER"))) S FND=1
"RTN","GMRAFX3",69,0)
 Q FND
"RTN","GMRAFX3",70,0)
 ;
"RTN","GMRAFX3",71,0)
WAIT ;Issues press enter to return prompt
"RTN","GMRAFX3",72,0)
 N DIR
"RTN","GMRAFX3",73,0)
 S DIR(0)="E",DIR("A")="Press enter to continue" D ^DIR
"RTN","GMRAFX3",74,0)
 Q
"RTN","GMRAFX3",75,0)
 ;
"RTN","GMRAFX3",76,0)
GETNUM(ACTION) ; -- Return numbers to act on, if action chosen first
"RTN","GMRAFX3",77,0)
 N X,Y,DIR,MAX
"RTN","GMRAFX3",78,0)
 S MAX=$S($D(^TMP($J,LTYPE,"IDX2")):$G(^TMP($J,LTYPE,"IDX2",0)),1:$G(VALMCNT)) Q:MAX'>0 ""
"RTN","GMRAFX3",79,0)
 I ACTION="DET" W !!,"Please choose only one entry for the detailed display."
"RTN","GMRAFX3",80,0)
 S DIR(0)="LAO^1:"_MAX,DIR("A")="Select Entries from list: "
"RTN","GMRAFX3",81,0)
 S DIR("?")="Enter the items you wish to act on, as a range or list of numbers."
"RTN","GMRAFX3",82,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","GMRAFX3",83,0)
 I $D(Y(1)) W !,">>>Too many entries selected, try using smaller ranges" H 2 S Y="^"
"RTN","GMRAFX3",84,0)
 I $L($G(Y),",")>2,ACTION="DET" W !,">>You may only choose ONE group for detailed display." H 2 S Y="^"
"RTN","GMRAFX3",85,0)
 Q Y
"RTN","GMRAFX3",86,0)
 ;
"RTN","GMRAFX3",87,0)
UPDATE ;Update display to account for changes to the list
"RTN","GMRAFX3",88,0)
 N CNT,SP1,SP2,SP3
"RTN","GMRAFX3",89,0)
 I VALMAR["GMRADET" N VALMAR S VALMAR="^XTMP(""GMRAFX"",LTYPE)"
"RTN","GMRAFX3",90,0)
 S CNT=^XTMP("GMRAFX",LTYPE,"GMRAR",$P(ENTRY,U),$P(ENTRY,U,2))-1
"RTN","GMRAFX3",91,0)
 S ^XTMP("GMRAFX",LTYPE,"GMRAR",$P(ENTRY,U),$P(ENTRY,U,2))=CNT K ^($P(ENTRY,U,2),GMRAJ)
"RTN","GMRAFX3",92,0)
 S SP1=4-$L(+NUM),SP2=40-$L($P(ENTRY,U)),SP3=$S(CNT:16-$L(CNT)\2,1:2)
"RTN","GMRAFX3",93,0)
 D SET^VALM10(+NUM,+NUM_$$REPEAT^XLFSTR(" ",SP1)_$P(ENTRY,U,2)_$$REPEAT^XLFSTR(" ",(SP2+SP3))_$S(CNT:CNT,1:"** FIXED **"))
"RTN","GMRAFX3",94,0)
 Q
"RTN","GMRAFX3",95,0)
 ;
"RTN","GMRAFX3",96,0)
LOCK(ENTRY) ;Lock entry in 120.8
"RTN","GMRAFX3",97,0)
 N LOCK
"RTN","GMRAFX3",98,0)
 S LOCK=1
"RTN","GMRAFX3",99,0)
 L +^XTMP("GMRAFX",LTYPE,"IDX",ENTRY):1
"RTN","GMRAFX3",100,0)
 I '$T D FULL^VALM1 S VALMBCK="R" W !,"The ",$P(^XTMP("GMRAFX",LTYPE,"IDX",ENTRY),U)," group is being edited by another user" D WAIT S LOCK=0
"RTN","GMRAFX3",101,0)
 Q LOCK
"RTN","GMRAFX3",102,0)
 ;
"RTN","GMRAFX3",103,0)
AR ;Add/edit patient reactions
"RTN","GMRAFX3",104,0)
 N LCV,DFN,SUB
"RTN","GMRAFX3",105,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX3",106,0)
 W !!,"You should use this option to add NEW reactions only.  If you mark"
"RTN","GMRAFX3",107,0)
 W !,"existing entries as entered in error from within this option it will"
"RTN","GMRAFX3",108,0)
 W !,"not update the utility's display until the list is rebuilt upon re-entry"
"RTN","GMRAFX3",109,0)
 W !,"of this option.  This could cause confusion as the list will no longer"
"RTN","GMRAFX3",110,0)
 W !,"be accurate.",!
"RTN","GMRAFX3",111,0)
 I '$G(NMBR2) D WAIT,EN1^GMRAPEM0 Q
"RTN","GMRAFX3",112,0)
 F LCV=1:1:$L(NMBR2,",")-1 S SUB=$P(NMBR2,",",LCV) S DFN=+$P($G(^GMR(120.8,+$P($G(^TMP($J,LTYPE,"IDX2",SUB)),U,2),0)),U) I DFN W !!,"Now working with patient ",$$GET1^DIQ(2,DFN,.01),! D WAIT D EN2^GMRAPEM0
"RTN","GMRAFX3",113,0)
 Q
"RTN","GMRAFX3",114,0)
 ;
"RTN","GMRAFX3",115,0)
DSPREACT ;Display detailed information about the reactant
"RTN","GMRAFX3",116,0)
 N DIC,DA,GMRAI,STOP,NUM2,DIR,Y
"RTN","GMRAFX3",117,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX3",118,0)
 I '$G(NMBR2) S NMBR2=$$GETNUM("") Q:'+NMBR2
"RTN","GMRAFX3",119,0)
 F GMRAI=1:1:($L(NMBR2,",")-1) D  Q:$G(STOP)
"RTN","GMRAFX3",120,0)
 .S NUM2=$P(NMBR2,",",GMRAI)
"RTN","GMRAFX3",121,0)
 .S DA=$P(^TMP($J,LTYPE,"IDX2",NUM2),U,2) Q:'DA
"RTN","GMRAFX3",122,0)
 .S DIC="^GMR(120.8,"
"RTN","GMRAFX3",123,0)
 .W ! D EN^DIQ
"RTN","GMRAFX3",124,0)
 .S DIR(0)="E",DIR("A")="Press return to continue or '^' to stop" D ^DIR
"RTN","GMRAFX3",125,0)
 .S:$D(DIRUT) STOP=1
"RTN","GMRAFX3",126,0)
 .Q
"RTN","GMRAFX3",127,0)
 Q
"RTN","GMRAFX3",128,0)
 ;
"RTN","GMRAFX3",129,0)
GETTYPE(LTYPE) ;Function determines which list to work with
"RTN","GMRAFX3",130,0)
 N DIR,X,Y
"RTN","GMRAFX3",131,0)
 S DIR(0)="SO^1:Free Text;2:Ingredient;3:Drug Class"
"RTN","GMRAFX3",132,0)
 S DIR("A")="Select the list you wish to work with"
"RTN","GMRAFX3",133,0)
 D ^DIR K DIR
"RTN","GMRAFX3",134,0)
 S LTYPE=$S(Y=1:"FREE",Y=2:"ING",Y=3:"DRUG",1:0)
"RTN","GMRAFX3",135,0)
 Q LTYPE
"RTN","GMRAFX3",136,0)
 ;
"RTN","GMRAFX3",137,0)
EIE ;Mark individual entry as entered in error
"RTN","GMRAFX3",138,0)
 N DIE,DA,DR,Y,DIK,DFN,OROLD,VAIN,X,GMRAOUT
"RTN","GMRAFX3",139,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR="15///1;22///1;23///NOW;24////"_$G(DUZ,.5) ;20
"RTN","GMRAFX3",140,0)
 D ^DIE ;Entered in error on date/time by user
"RTN","GMRAFX3",141,0)
 D ADCOM^GMRAFX(GMRAPA,"E","Marked Entered in Error during clean up process")
"RTN","GMRAFX3",142,0)
 I $$NKASCR^GMRANKA($P(^GMR(120.8,GMRAPA,0),U)) D
"RTN","GMRAFX3",143,0)
 .S DIK="^GMR(120.86,",DA=$P(^GMR(120.8,GMRAPA,0),U)
"RTN","GMRAFX3",144,0)
 .D ^DIK ;If patient's last allergy marked as entered in error then delete assessment
"RTN","GMRAFX3",145,0)
 .W !!,"**NOTE: By marking this reaction as entered in error, ",$$GET1^DIQ(2,DA,.01,"E"),!,"no longer has an assessment on file.  You may reassess this patient",!
"RTN","GMRAFX3",146,0)
 .W "now by answering the following prompt or hit return to do it later.",!
"RTN","GMRAFX3",147,0)
 .D NKAASK^GMRANKA(DA)
"RTN","GMRAFX3",148,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAFX3",149,0)
 S GMRAOUT=0
"RTN","GMRAFX3",150,0)
 D EN1^GMRAEAB ;Sends entered in error bulletin to appropriate mail groups
"RTN","GMRAFX3",151,0)
 S DFN=$P(GMRAPA(0),U)
"RTN","GMRAFX3",152,0)
 D INP^VADPT S X=$$FIND1^DIC(101,,"BX","GMRA ENTERED IN ERROR")_";ORD(101," ;19
"RTN","GMRAFX3",153,0)
 D:X EN^XQOR ;Process protocols hanging off of "entered in error" protocol
"RTN","GMRAFX3",154,0)
 Q
"RTN","GMRAFX3",155,0)
 ;
"RTN","GMRAFX3",156,0)
RUSURE(GMRASURE) ;20 Make sure selection from ingredient or drug class file is ok
"RTN","GMRAFX3",157,0)
 ;entire section added in patch 20
"RTN","GMRAFX3",158,0)
 N DIR,Y,X
"RTN","GMRAFX3",159,0)
 S GMRASURE=1
"RTN","GMRAFX3",160,0)
 I $G(GMRAAR)["50.416"!($G(GMRAAR)["50.605") D
"RTN","GMRAFX3",161,0)
 .S DIR("A")="Are you sure you want to use this reactant"
"RTN","GMRAFX3",162,0)
 .S DIR("A",1)="You are about to update the entry with a selection from"
"RTN","GMRAFX3",163,0)
 .S DIR("A",2)="the "_$S($G(GMRAAR)["50.416":"INGREDIENT",1:"VA DRUG CLASS")_" file.  By doing that you are"
"RTN","GMRAFX3",164,0)
 .S DIR("A",3)="limiting the information available for order checking."
"RTN","GMRAFX3",165,0)
 .S DIR("A",4)=""
"RTN","GMRAFX3",166,0)
 .S DIR("A",5)="In general, it is better to choose from one of the drug related files"
"RTN","GMRAFX3",167,0)
 .S DIR("A",6)="as that ensures that drug class and ingredient information are part"
"RTN","GMRAFX3",168,0)
 .S DIR("A",7)="of the patient's allergy definition and will provide better allergy"
"RTN","GMRAFX3",169,0)
 .S DIR("A",8)="order checking."
"RTN","GMRAFX3",170,0)
 .S DIR("A",9)=""
"RTN","GMRAFX3",171,0)
 .S DIR(0)="Y",DIR("B")="NO"
"RTN","GMRAFX3",172,0)
 .D ^DIR S GMRASURE=+Y
"RTN","GMRAFX3",173,0)
 Q
"RTN","GMRAPES0")
0^4^B74006536^B72112674
"RTN","GMRAPES0",1,0)
GMRAPES0 ;HIRMFO/RM-SELECT PATIENT ALLERGY TO EDIT ;4/5/06  14:30
"RTN","GMRAPES0",2,0)
 ;;4.0;Adverse Reaction Tracking;**13,17,19,21,23,20**;Mar 29, 1996;Build 1
"RTN","GMRAPES0",3,0)
EN1 ; GIVEN DFN, SELECT PATIENT ALLERGY
"RTN","GMRAPES0",4,0)
 N GMRAGOUT,ROOT,CNT,LST,NAM,DIR,GMRAET
"RTN","GMRAPES0",5,0)
 S GMRARET=0
"RTN","GMRAPES0",6,0)
 S GMRAPA=-1,GMRANEW=0 R !!,"Enter Causative Agent: ",GMRALAR:DTIME S:'$T GMRALAR="^^" S:GMRALAR="" GMRARET=1 I "^^"[GMRALAR S GMRAOUT='$L(GMRALAR)+1 G Q1
"RTN","GMRAPES0",7,0)
 I GMRALAR?1P.E!($L(GMRALAR)<3)!($L(GMRALAR)>30) S GMRAHLP=1 D EN1^GMRAHLP0 G EN1:'GMRAOUT,Q1
"RTN","GMRAPES0",8,0)
 I GMRALAR?.E1L.E S GMRALAR=$$UP^XLFSTR(GMRALAR)
"RTN","GMRAPES0",9,0)
PAL K Y,DTOUT,DUOUT S DGSENFLG="",DIC="^GMR(120.8,",DIC(0)="SEZ",X=GMRANAM,DIC("S")="I '+$G(^(""ER"")),$P(^(0),U,2)?@(""1""""""_GMRALAR_"""""".E""),$D(^GMR(120.8,""B"",DFN,+Y))",DIC("W")="W $P(^(0),U,2)"
"RTN","GMRAPES0",10,0)
 W !!,"Checking existing PATIENT ALLERGIES (#120.8) file for matches...",!
"RTN","GMRAPES0",11,0)
 D ^DIC S X=$P($G(Y(0)),"^",2) K DIC,DGSENFLG,DTOUT,DUOUT D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",12,0)
 S:+Y>0 GMRAPA=+Y G Q1:+Y>0!GMRAOUT,PAL:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",13,0)
 G Q1:'GMRALAGO
"RTN","GMRAPES0",14,0)
NPA W !!,"Now checking GMR ALLERGIES (#120.82) file for matches...",!
"RTN","GMRAPES0",15,0)
 S DIC("S")="I $P(^(0),U)'=""OTHER ALLERGY/ADVERSE REACTION""&($S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(120.82,.01,Y_"",""),1:1))" ;21,23
"RTN","GMRAPES0",16,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 X=$P(Y,"^",2) D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",17,0)
 I +Y>0 S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",18,0)
 G Q1:GMRAOUT,NPA:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",19,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAPES0",20,0)
 K Y,DTOUT,DUOUT
"RTN","GMRAPES0",21,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAPES0",22,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.6,.01,Y_"",""),1:1)" D ^DIC K DIC D DIC ;23
"RTN","GMRAPES0",23,0)
 I +Y>0 S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",24,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAPES0",25,0)
 K DUOUT,DTOUT,Y
"RTN","GMRAPES0",26,0)
 S ROOT=$$T^PSNAPIS,CNT=0,X=GMRALAR
"RTN","GMRAPES0",27,0)
 I $D(@ROOT@(X)),$S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.6,.01,$$TGTOG^PSNAPIS(X)_","),1:1) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;23 Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAPES0",28,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",29,0)
 .Q:$S($L($T(SCREEN^XTID)):$$SCREEN^XTID(50.6,.01,$$TGTOG^PSNAPIS(NAM)_","),1:0)  ;23
"RTN","GMRAPES0",30,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAPES0",31,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",32,0)
 I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",33,0)
 I CNT>1 D
"RTN","GMRAPES0",34,0)
 .D MATCHES
"RTN","GMRAPES0",35,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",36,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",37,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",38,0)
 D DIC I GMRAOUT S GMRAOUT=GMRAOUT=1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",39,0)
 I +Y>0 S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",40,0)
 ;Selection from file 50 removed in patch 23
"RTN","GMRAPES0",41,0)
DRUG ;W !!,"Now checking the DRUG (#50) file for matches...",! K Y,DTOUT,DUOUT
"RTN","GMRAPES0",42,0)
 ;S CNT=0,X=GMRALAR K LST
"RTN","GMRAPES0",43,0)
 ;F ROOT="^PSDRUG(""B"")","^PSDRUG(""C"")" D
"RTN","GMRAPES0",44,0)
 ;.I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$O(@ROOT@(X,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(X,0)),.01)_" <"_X_">",1:X)
"RTN","GMRAPES0",45,0)
 ;.S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",46,0)
 ;..S CNT=CNT+1,LST(CNT)=$O(@ROOT@(NAM,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(NAM,0)),.01)_" <"_NAM_">",1:NAM)
"RTN","GMRAPES0",47,0)
 ;I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",48,0)
 ;I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",49,0)
 ;I CNT>1 D
"RTN","GMRAPES0",50,0)
 ;.D MATCHES
"RTN","GMRAPES0",51,0)
 ;.S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",52,0)
 ;.S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",53,0)
 ;.D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",54,0)
 ;D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",55,0)
 ;I +Y>0 S GMRAAR=+Y(0)_";PSDRUG(",GMRAAR(0)=$$GET1^DIQ(50,+Y(0),.01),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",56,0)
 ;19 - Moved ING and CLASS code here
"RTN","GMRAPES0",57,0)
ING W !!,"Now checking the INGREDIENTS (#50.416) file for matches...",!
"RTN","GMRAPES0",58,0)
 K Y,DTOUT,DUOUT S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.416,.01,Y_"",""),1:1)",X=GMRALAR D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",59,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",60,0)
 G Q1:GMRAOUT,ING:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",61,0)
CLASS W !!,"Now checking VA DRUG CLASS (50.605) file for matches...",!
"RTN","GMRAPES0",62,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",D="C",DIC("S")="I $S($L($T(SCREEN^XTID)):'$$SCREEN^XTID(50.605,.01,Y_"",""),1:1)" D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",63,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",64,0)
 G Q1:GMRAOUT,CLASS:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",65,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files."
"RTN","GMRAPES0",66,0)
 W !!,"Before sending an email requesting the addition of a new reactant, please",!,"try entering the first 3 or 4 letters of the reactant to search for",!,"the desired entry.",!
"RTN","GMRAPES0",67,0)
 W !,"Would you like to send an email requesting ",GMRALAR,!,"be added as a causative agent?"
"RTN","GMRAPES0",68,0)
 S DIR("A")="Send email"
"RTN","GMRAPES0",69,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("?")="^D MESS^GMRAPES0"
"RTN","GMRAPES0",70,0)
 D ^DIR
"RTN","GMRAPES0",71,0)
 I Y'=+Y S GMRAOUT=1 G Q1
"RTN","GMRAPES0",72,0)
 I '+Y G EN1
"RTN","GMRAPES0",73,0)
YNDRG ;
"RTN","GMRAPES0",74,0)
 D GETINPUT(.GMRAET)
"RTN","GMRAPES0",75,0)
 S X=$$SENDREQ(DUZ,DFN,GMRALAR,.GMRAET)
"RTN","GMRAPES0",76,0)
 I '+X W !!,"Error - Message not sent - ",$P(X,U,2)
"RTN","GMRAPES0",77,0)
 I +X W !!,"Message sent - NOTE: This reactant was NOT added for this patient."
"RTN","GMRAPES0",78,0)
 W !
"RTN","GMRAPES0",79,0)
Q1 ;
"RTN","GMRAPES0",80,0)
 S:GMRAPA>0 GMRAPA(0)=$S($D(^GMR(120.8,+GMRAPA,0)):^(0),1:"")
"RTN","GMRAPES0",81,0)
 K %,D,DA,DIC,DTOUT,DUOUT,GMRAAR,GMRAHLP,GMRAING,GMRALAGO,GMRALAR,PSNDA,PSODA,X,Y
"RTN","GMRAPES0",82,0)
 Q
"RTN","GMRAPES0",83,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAPES0",84,0)
 S:$D(DTOUT) X="^^" I X="^^" S GMRAOUT=1 Q
"RTN","GMRAPES0",85,0)
 S:$D(DUOUT) Y=0 Q:+Y'>0
"RTN","GMRAPES0",86,0)
YNOK W !?3,X,"   OK" S %=1 D YN^DICN S:%=-1 GMRAOUT=1,Y=-1 Q:GMRAOUT  S:%=2 Y=-1 Q:Y=-1  S:$$DUPCHK(X,DFN,Y) Y=-1 Q:GMRAOUT  I % W ! Q  ;19
"RTN","GMRAPES0",87,0)
 W !?5,$C(7),"ANSWER YES IF THIS IS THE CORRECT ALLERGY/ADVERSE REACTION,",!?5,"ELSE ANSWER NO."
"RTN","GMRAPES0",88,0)
 G YNOK
"RTN","GMRAPES0",89,0)
DUPCHK(X,Y,Z) ;CHECK FOR ENTERED IN ERROR
"RTN","GMRAPES0",90,0)
 N GMRAPA,GMRAGOUT,%,%Y S GMRAGOUT=0
"RTN","GMRAPES0",91,0)
 I $P($G(^GMR(120.8,+Z,0)),U,2)=X Q GMRAGOUT
"RTN","GMRAPES0",92,0)
 I $O(^GMR(120.8,"B",Y,0)) S GMRAPA=0 F  S GMRAPA=$O(^GMR(120.8,"B",Y,GMRAPA)) Q:GMRAPA<1  D  Q:GMRAOUT!(GMRAGOUT)
"RTN","GMRAPES0",93,0)
 .I $P(^GMR(120.8,GMRAPA,0),U,2)'=X Q
"RTN","GMRAPES0",94,0)
 .I $D(^GMR(120.8,GMRAPA,"ER")) D
"RTN","GMRAPES0",95,0)
 ..F  S %=2 W !,?5,$C(7),"This Agent has been Entered in Error once before.",!,?5,"Are you sure you want to select this Agent again" D  Q:%
"RTN","GMRAPES0",96,0)
 ...D YN^DICN S:%'=1 %=2,GMRAOUT=1  S:%Y?2"^" GMRAOUT=2
"RTN","GMRAPES0",97,0)
 ...Q:%  W !,?10,"ENTER 'Y' FOR YES OR 'N' FOR NO"
"RTN","GMRAPES0",98,0)
 ...Q
"RTN","GMRAPES0",99,0)
 ..S GMRAGOUT=%
"RTN","GMRAPES0",100,0)
 ..Q
"RTN","GMRAPES0",101,0)
 .Q
"RTN","GMRAPES0",102,0)
 I GMRAGOUT=0 S GMRAGOUT=1
"RTN","GMRAPES0",103,0)
 Q (GMRAGOUT-1)
"RTN","GMRAPES0",104,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAPES0",105,0)
 N I,J,QUIT
"RTN","GMRAPES0",106,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAPES0",107,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAPES0",108,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAPES0",109,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAPES0",110,0)
 Q
"RTN","GMRAPES0",111,0)
 ;
"RTN","GMRAPES0",112,0)
MORE()  ; -- show more matches
"RTN","GMRAPES0",113,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAPES0",114,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAPES0",115,0)
 D ^DIR
"RTN","GMRAPES0",116,0)
 Q +Y
"RTN","GMRAPES0",117,0)
 ;
"RTN","GMRAPES0",118,0)
SENDREQ(USER,PAT,TEXT,GMRAET) ;Send email to GMRA REQUEST NEW REACTANT indicating user's request for a new allergy
"RTN","GMRAPES0",119,0)
 ;Returns 0^reason for error
"RTN","GMRAPES0",120,0)
 ;        1 if successful
"RTN","GMRAPES0",121,0)
 N XMDUZ,XMY,XMSUB,GMRATXT,XMTEXT,XMZ,XMMG,GMRAUI,GMRAPI,GMRAUS,GMRAPS,CNT,J
"RTN","GMRAPES0",122,0)
 Q:'$G(USER)!('+$G(DUZ))!('$L(TEXT)) "0^Required information missing"
"RTN","GMRAPES0",123,0)
 S XMDUZ="Allergy Package",XMSUB="Request to add new reactant"
"RTN","GMRAPES0",124,0)
 S XMY("G.GMRA REQUEST NEW REACTANT")=""
"RTN","GMRAPES0",125,0)
 S XMY(DUZ)="" ;Include requestor in message
"RTN","GMRAPES0",126,0)
 D GETS^DIQ(200,USER,".01;.132;.138;8","E","GMRAUI"),GETS^DIQ(2,PAT,".01;.09","IE","GMRAPI") S GMRAUS=USER_",",GMRAPS=PAT_","
"RTN","GMRAPES0",127,0)
 S CNT=1
"RTN","GMRAPES0",128,0)
 S GMRATXT(CNT)="A request to add "_TEXT_" as a new reactant was entered",CNT=CNT+1
"RTN","GMRAPES0",129,0)
 S GMRATXT(CNT)="by "_GMRAUI(200,GMRAUS,.01,"E")_" for patient "_GMRAPI(2,GMRAPS,.01,"E")_" ("_$E(GMRAPI(2,GMRAPS,.09,"I"),6,9)_")",CNT=CNT+1
"RTN","GMRAPES0",130,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",131,0)
 S GMRATXT(CNT)="User's contact information:",CNT=CNT+1
"RTN","GMRAPES0",132,0)
 S GMRATXT(CNT)="Title        : "_GMRAUI(200,GMRAUS,8,"E"),CNT=CNT+1
"RTN","GMRAPES0",133,0)
 S GMRATXT(CNT)="Office Phone : "_GMRAUI(200,GMRAUS,.132,"E"),CNT=CNT+1
"RTN","GMRAPES0",134,0)
 S GMRATXT(CNT)="Digital Pager: "_GMRAUI(200,GMRAUS,.138,"E"),CNT=CNT+1
"RTN","GMRAPES0",135,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",136,0)
 I $D(GMRAET) S GMRATXT(CNT)="The user added the following comment:",CNT=CNT+1,GMRATXT(CNT)="",CNT=CNT+1 F J=1:1:$P(GMRAET(0),U,3) S GMRATXT(CNT)=GMRAET(J,0),CNT=CNT+1 ;20 Added blank line following comment
"RTN","GMRAPES0",137,0)
 I $D(GMRAET) S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",138,0)
 S GMRATXT(CNT)="Please verify with the user the intended reactant and then take the",CNT=CNT+1
"RTN","GMRAPES0",139,0)
 S GMRATXT(CNT)="appropriate action.  Be sure to try alternate spellings, etc before",CNT=CNT+1
"RTN","GMRAPES0",140,0)
 S GMRATXT(CNT)="requesting new reactants through NTRT (New Term Rapid Turnaround).",CNT=CNT+1 ;23
"RTN","GMRAPES0",141,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",142,0)
 S GMRATXT(CNT)="Please note, an allergy to "_TEXT_" was NOT entered for this patient!",CNT=CNT+1 ;20
"RTN","GMRAPES0",143,0)
 S XMTEXT="GMRATXT("
"RTN","GMRAPES0",144,0)
 D ^XMD
"RTN","GMRAPES0",145,0)
 Q $S($D(XMMG):"0^Mail group GMRA REQUEST NEW REACTANT has no members - contact IRM",1:1)
"RTN","GMRAPES0",146,0)
 ;
"RTN","GMRAPES0",147,0)
MESS ;Provide help for sending email message
"RTN","GMRAPES0",148,0)
 W !,"Enter YES to send an email to the allergy coordinator(s) indicating that",!,"Reactant--> ",GMRALAR,!,"was not found when you were trying to add it for this patient.",!,"Enter NO to try entering the reactant again."
"RTN","GMRAPES0",149,0)
 Q
"RTN","GMRAPES0",150,0)
 ;
"RTN","GMRAPES0",151,0)
GETINPUT(GMRAET) ;Allow user to add comment to message
"RTN","GMRAPES0",152,0)
 N DIC,DWLW,DWPK,DIWEPSE
"RTN","GMRAPES0",153,0)
 S ^TMP($J,"TEXT",0)=""
"RTN","GMRAPES0",154,0)
 S DIC="^TMP($J,""TEXT"","
"RTN","GMRAPES0",155,0)
 S DWLW=70,DWPK=1,DIWEPSE=""
"RTN","GMRAPES0",156,0)
 W !!,"You may now add any comments you may have to the message that",!,"is going to be sent with the request to add this reactant."
"RTN","GMRAPES0",157,0)
 W !,"You may want to add things like sign/symptoms, observed or historical, etc",!,"that may be useful to the reviewer.",!
"RTN","GMRAPES0",158,0)
 D EN^DIWE
"RTN","GMRAPES0",159,0)
 I $O(^TMP($J,"TEXT",0)) M GMRAET=^TMP($J,"TEXT")
"RTN","GMRAPES0",160,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAPES0",161,0)
 Q
"RTN","GMRAPET0")
0^6^B31689941^B26842733
"RTN","GMRAPET0",1,0)
GMRAPET0 ;HIRMFO/RM-VERIFIED ALLERGY TASKS ;4/7/06  12:38
"RTN","GMRAPET0",2,0)
 ;;4.0;Adverse Reaction Tracking;**6,17,21,20**;Mar 29, 1996;Build 1
"RTN","GMRAPET0",3,0)
EN1(GMRADFN,GMRAPA,GMRACT,GMRAOUT) ;
"RTN","GMRAPET0",4,0)
 ; ENTRY TO PERFORM ALL OF THE TASKS NECESSARY FOR
"RTN","GMRAPET0",5,0)
 ;                 A PROGRESS NOTE TO BE ENTERED BY ART
"RTN","GMRAPET0",6,0)
 ;     INPUT:
"RTN","GMRAPET0",7,0)
 ;           GMRADFN = PATIENT IEN IN THE PATIENT FILE
"RTN","GMRAPET0",8,0)
 ;           GMRAPA  = THE IEN IN THE PATIENT ALLERGY FILE
"RTN","GMRAPET0",9,0)
 ;           GMRACT  = THE ACTION TO BE ENTERED FOR THIS REACTION
"RTN","GMRAPET0",10,0)
 ;                   = "V" VERIFICATION OF A REACTION
"RTN","GMRAPET0",11,0)
 ;                   = "S" SIGN OFF OF A REACTION
"RTN","GMRAPET0",12,0)
 ;                   = "M" MEDWATCH FORM ENTERD
"RTN","GMRAPET0",13,0)
 ;                   = "E" REACTION ENERED IN ERROR
"RTN","GMRAPET0",14,0)
 ;      OUTPUT:
"RTN","GMRAPET0",15,0)
 ;           GMRAOUT = REACTION ALL WAS PASSED
"RTN","GMRAPET0",16,0)
 ;                   = 1 USER ABORT OR PN FAIL IN SOME WAY
"RTN","GMRAPET0",17,0)
 ;                   = 0 PASSED
"RTN","GMRAPET0",18,0)
 ;
"RTN","GMRAPET0",19,0)
 ;      VARABLE LIST
"RTN","GMRAPET0",20,0)
 ;        GMRACW = IS THE PROGRESS NOTE TITLE
"RTN","GMRAPET0",21,0)
 ;       GMRALOC = IS THE LOCATION OF THE PATIENT
"RTN","GMRAPET0",22,0)
 ;      GMRAHLOC = IS THE LOCATION IN FILE 44
"RTN","GMRAPET0",23,0)
 ;       GMRADFN = IS THE PATIENT IEN
"RTN","GMRAPET0",24,0)
 ;        GMRADT = IS THE DATE THE EVENT TOOK PLACE
"RTN","GMRAPET0",25,0)
 ;       GMRADUZ = IS THE USER WHO ENTERED THE INFORMATION
"RTN","GMRAPET0",26,0)
 ;        GMRAPN = IS THE IEN OF THE PROGRESS NOTE THAT WAS ENTERED
"RTN","GMRAPET0",27,0)
 ;
"RTN","GMRAPET0",28,0)
 ;CHECKING FOR A VALID TITLE
"RTN","GMRAPET0",29,0)
 K ^TMP("TIUP",$J),GMRAPN
"RTN","GMRAPET0",30,0)
 N GMRACW,GMRALOC,GMRAHLOC,GMRAXBOS ;21
"RTN","GMRAPET0",31,0)
 S GMRAPN=-1,GMRAXBOS=$$BROKER^XWBLIB ;21 Got GUI?
"RTN","GMRAPET0",32,0)
 I "VSME"'[GMRACT S GMRAOUT=1 D EXIT Q
"RTN","GMRAPET0",33,0)
 ; The following lines of code which reference Progress Notes files and
"RTN","GMRAPET0",34,0)
 ; routines will have to change when TIU replaces Progress Notes.
"RTN","GMRAPET0",35,0)
 ;S GMRACW=0 F  S GMRACW=$O(^GMR(121.2,"B","ADVERSE REACTION/ALLERGY",GMRACW)) Q:GMRACW<1  I $P($G(^GMR(121.1,$P($G(^GMR(121.2,GMRACW,0)),U,2),0)),U)="GENERAL NOTE" Q
"RTN","GMRAPET0",36,0)
 ;-----ADDED BY VAUGHN 1/13/97 FOR TIU REPLACES LINE ABOVE----
"RTN","GMRAPET0",37,0)
 S GMRACW=+$$WHATITLE^TIUPUTU("ADVERSE REACTION/ALLERGY")
"RTN","GMRAPET0",38,0)
 ;------END---
"RTN","GMRAPET0",39,0)
 ;-----CHANGED BY VAUGHN 1/13/97 FOR TIU---
"RTN","GMRAPET0",40,0)
 I GMRACW<1!($T(NEW^TIUPNAPI)']"")!('$$CANPICK^TIULP(GMRACW)) S GMRAOUT=1 D EXIT Q  ;21
"RTN","GMRAPET0",41,0)
 ;I GMRACW<1!($T(PN^GMRPART)']"") S GMRAOUT=1 D EXIT Q
"RTN","GMRAPET0",42,0)
 ;-----END----
"RTN","GMRAPET0",43,0)
 D @GMRACT I GMRAOUT D EXIT Q  ; THIS TELL'S THE PROGRAM WHERE TO GO
"RTN","GMRAPET0",44,0)
 S GMRALOC=""
"RTN","GMRAPET0",45,0)
 D VAD^GMRAUTL1(GMRADFN,"",.GMRALOC,"","","")
"RTN","GMRAPET0",46,0)
 I GMRALOC'="" S GMRAHLOC=+$G(^DIC(42,GMRALOC,44))
"RTN","GMRAPET0",47,0)
 ;E  I '$G(GMRAXBOS) D ASK ;20
"RTN","GMRAPET0",48,0)
 ; Call to Progress Notes
"RTN","GMRAPET0",49,0)
 ; vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
"RTN","GMRAPET0",50,0)
 ;S:'GMRAOUT GMRAPN=+$$PN^GMRPART(GMRADFN,GMRADUZ,GMRADT,GMRACW,GMRAHLOC)
"RTN","GMRAPET0",51,0)
 ;---REPLACED LINE ABOVE WITH LINE BELOW;1/13/97 VAUGHN---
"RTN","GMRAPET0",52,0)
 I 'GMRAOUT D
"RTN","GMRAPET0",53,0)
 .S GMRAPN=0 D NEW^TIUPNAPI(.GMRAPN,GMRADFN,GMRADUZ,GMRADT,GMRACW,$G(GMRAHLOC),$S($G(GMRAXBOS):0,1:1)) ;17,21 Allow editing if not in GUI
"RTN","GMRAPET0",54,0)
 ;----------END-------
"RTN","GMRAPET0",55,0)
 I GMRAPN=-1,'$G(GMRAXBOS) S GMRAOUT=1 W !,"No Progress Note was created." ;21
"RTN","GMRAPET0",56,0)
 I GMRAPN=0,'$G(GMRAXBOS) W !,"Progress note has not been signed." ;21
"RTN","GMRAPET0",57,0)
 D EXIT
"RTN","GMRAPET0",58,0)
 Q
"RTN","GMRAPET0",59,0)
EXIT ; Clean up of variables
"RTN","GMRAPET0",60,0)
 K ^TMP("TIUP",$J),GMRAPN,GMRALOC,GMRAHLOC,GMRADUZ
"RTN","GMRAPET0",61,0)
 Q
"RTN","GMRAPET0",62,0)
ASK ; Simple file manager query for a location in file 44
"RTN","GMRAPET0",63,0)
 N DIC
"RTN","GMRAPET0",64,0)
 S X=""
"RTN","GMRAPET0",65,0)
 S DIC=44,DIC(0)="AEQ",DIC("A")="Select a Hospital Location: ",DIC("S")="I ""CMW""[$P(^(0),U,3)" ;20
"RTN","GMRAPET0",66,0)
 W !,"A progress note is being created because you "_$S(GMRACT="V":"verified",GMRACT="E":"inactivated",GMRACT="S":"activated",1:"entered a medwatch form for"),!,$P($G(^GMR(120.8,GMRAPA,0)),U,2),"." ;20
"RTN","GMRAPET0",67,0)
 W !,"Enter a hospital location to be associated with this note." ;20
"RTN","GMRAPET0",68,0)
 D ^DIC
"RTN","GMRAPET0",69,0)
 I $D(DTOUT)!($D(DUOUT)) S GMRAOUT=1 Q
"RTN","GMRAPET0",70,0)
 S GMRAHLOC=+Y
"RTN","GMRAPET0",71,0)
 Q
"RTN","GMRAPET0",72,0)
V ; Verified Reaction
"RTN","GMRAPET0",73,0)
 N GMRAI ;21
"RTN","GMRAPET0",74,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPET0",75,0)
 S GMRADT=$P(GMRAPA(0),U,17),GMRADUZ=$P(GMRAPA(0),U,18)
"RTN","GMRAPET0",76,0)
 S:GMRADUZ="" GMRADUZ=DUZ ; Autoverified reaction being reverified
"RTN","GMRAPET0",77,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had an "_$S($P(GMRAPA(0),"^",14)="P":"adverse reaction reported for ",1:"allergy to ")_$P(GMRAPA(0),"^",2)
"RTN","GMRAPET0",78,0)
 S ^TMP("TIUP",$J,2,0)="verified on "_$$FMTE^XLFDT(GMRADT,1)_"."
"RTN","GMRAPET0",79,0)
 S GMRAI=2 D ADDCOM("V",.GMRAI) ;21
"RTN","GMRAPET0",80,0)
 S ^TMP("TIUP",$J,0)=U_U_GMRAI_U_GMRAI_U_GMRADT_"^^^" ;21
"RTN","GMRAPET0",81,0)
 Q
"RTN","GMRAPET0",82,0)
S ; Signed Reaction
"RTN","GMRAPET0",83,0)
 N GMRAI,GMRAREAC ;21
"RTN","GMRAPET0",84,0)
 D NOW^%DTC
"RTN","GMRAPET0",85,0)
 S GMRADT=%,GMRADUZ=DUZ
"RTN","GMRAPET0",86,0)
 S GMRAREAC=0,GMRAI=3 F  S GMRAREAC=$O(GMRAPA(GMRAREAC)) Q:GMRAREAC<1  S GMRAI=GMRAI+1,^TMP("TIUP",$J,GMRAI,0)=$P($G(^GMR(120.8,GMRAREAC,0)),U,2) S GMRAPA=GMRAREAC D  ;21
"RTN","GMRAPET0",87,0)
 .D ADDCOM("O",.GMRAI) ;21
"RTN","GMRAPET0",88,0)
 .S GMRAI=GMRAI+1,^TMP("TIUP",$J,GMRAI,0)="" ;21
"RTN","GMRAPET0",89,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had the following reaction"_$S(GMRAI=3:" ",1:"s ")
"RTN","GMRAPET0",90,0)
 S ^TMP("TIUP",$J,2,0)="signed-off on "_$$FMTE^XLFDT(GMRADT,1)_"."
"RTN","GMRAPET0",91,0)
 S ^TMP("TIUP",$J,3,0)="" ;21
"RTN","GMRAPET0",92,0)
 S ^TMP("TIUP",$J,0)=U_U_GMRAI_U_GMRAI_U_GMRADT_"^^^"
"RTN","GMRAPET0",93,0)
 Q
"RTN","GMRAPET0",94,0)
M ; MedWATCH data entered
"RTN","GMRAPET0",95,0)
 N X
"RTN","GMRAPET0",96,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPET0",97,0)
 D NOW^%DTC
"RTN","GMRAPET0",98,0)
 S GMRADT=%,GMRADUZ=DUZ
"RTN","GMRAPET0",99,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had a MEDWatch report completed on "_$$FMTE^XLFDT(GMRADT,1)_" for"
"RTN","GMRAPET0",100,0)
 S ^TMP("TIUP",$J,2,0)=$S($P(GMRAPA(0),"^",14)="P":"an adverse reaction to ",1:"allergy to ")_$P(GMRAPA(0),"^",2)_"."
"RTN","GMRAPET0",101,0)
 S ^TMP("TIUP",$J,0)=U_U_"2"_U_"2"_U_GMRADT_"^^^"
"RTN","GMRAPET0",102,0)
 Q
"RTN","GMRAPET0",103,0)
E ; Reaction Entered in Error
"RTN","GMRAPET0",104,0)
 N GMRAER,GMRAI ;21
"RTN","GMRAPET0",105,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPET0",106,0)
 S GMRAER=$G(^GMR(120.8,GMRAPA,"ER")) I GMRAER="" S GMRAOUT=1 Q
"RTN","GMRAPET0",107,0)
 S GMRADT=$P(GMRAER,U,2),GMRADUZ=$P(GMRAER,U,3)
"RTN","GMRAPET0",108,0)
 S ^TMP("TIUP",$J,1,0)="The "_$S($P(GMRAPA(0),"^",14)="P":"adverse reaction ",1:"allergy ")_"to "_$P(GMRAPA(0),"^",2)_" was removed on "_$$FMTE^XLFDT($P(GMRADT,"."),2)_"." ;20
"RTN","GMRAPET0",109,0)
 S ^TMP("TIUP",$J,2,0)="This reaction was either an erroneous entry or was found" ;20
"RTN","GMRAPET0",110,0)
 S ^TMP("TIUP",$J,3,0)="to no longer be a true "_$S($P(GMRAPA(0),"^",14)="P":"adverse reaction",1:"allergy")_"." ;20
"RTN","GMRAPET0",111,0)
 S GMRAI=3 D ADDCOM("E",.GMRAI) ;21,20
"RTN","GMRAPET0",112,0)
 S ^TMP("TIUP",$J,0)=U_U_GMRAI_U_GMRAI_U_GMRADT_"^^^" ;21
"RTN","GMRAPET0",113,0)
 Q
"RTN","GMRAPET0",114,0)
 ;
"RTN","GMRAPET0",115,0)
ADDCOM(TYPE,CNT) ;Add any comments to progress note - section added in patch 21
"RTN","GMRAPET0",116,0)
 N SUB,ENTRY
"RTN","GMRAPET0",117,0)
 S ENTRY=$O(^GMR(120.8,GMRAPA,26,"AVER",TYPE,0)) Q:'+ENTRY
"RTN","GMRAPET0",118,0)
 S CNT=CNT+1,^TMP("TIUP",$J,CNT,0)="",CNT=CNT+1,^TMP("TIUP",$J,CNT,0)="Author's comments:"
"RTN","GMRAPET0",119,0)
 S CNT=CNT+1,^TMP("TIUP",$J,CNT,0)=""
"RTN","GMRAPET0",120,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,GMRAPA,26,ENTRY,2,SUB)) Q:'+SUB  S CNT=CNT+1,^TMP("TIUP",$J,CNT,0)=^GMR(120.8,GMRAPA,26,ENTRY,2,SUB,0)
"RTN","GMRAPET0",121,0)
 Q
"RTN","GMRAY20")
0^5^B8283807^n/a
"RTN","GMRAY20",1,0)
GMRAY20 ;SLC/DAN Post-install for patch 20 ;6/22/06  10:09
"RTN","GMRAY20",2,0)
 ;;4.0;Adverse Reaction Tracking;**20**;Mar 29, 1996;Build 1
"RTN","GMRAY20",3,0)
 ;
"RTN","GMRAY20",4,0)
POST ;Executed following installation of patch 20
"RTN","GMRAY20",5,0)
 N SUB,TOP,DIK,DA
"RTN","GMRAY20",6,0)
 K ^XTMP("GMRAFX") ;Remove existing free text allergy list - switching location and don't need old list
"RTN","GMRAY20",7,0)
 S SUB=0 F  S SUB=$O(^GMRD(120.84,SUB)) Q:'+SUB  D
"RTN","GMRAY20",8,0)
 .Q:'$D(^GMRD(120.84,SUB,1))  ;Stop if no top 10 list associated with this entry
"RTN","GMRAY20",9,0)
 .S TOP=10 F  S TOP=$O(^GMRD(120.84,SUB,1,TOP)) Q:'+TOP  D
"RTN","GMRAY20",10,0)
 ..S DA(1)=SUB,DA=TOP,DIK="^GMRD(120.84,"_DA(1)_",1," D ^DIK ;Delete any entries in multiple numbered above 10
"RTN","GMRAY20",11,0)
 ;
"RTN","GMRAY20",12,0)
FIXZERO ;Find varible pointers associated with IEN zero
"RTN","GMRAY20",13,0)
 N TMP,IEN,FREE
"RTN","GMRAY20",14,0)
 S FREE=$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0)) Q:'FREE  S:FREE FREE=FREE_";GMRD(120.82,"
"RTN","GMRAY20",15,0)
 S IEN=0 F  S IEN=$O(^GMR(120.8,IEN)) Q:'+IEN  D
"RTN","GMRAY20",16,0)
 .I $E($P($G(^GMR(120.8,IEN,0)),U,3),1,2)="0;" D
"RTN","GMRAY20",17,0)
 ..S $P(^GMR(120.8,IEN,0),U,3)=FREE ;Update pointer to free text entry
"RTN","GMRAY20",18,0)
 ..S TMP($P(^GMR(120.8,IEN,0),U),$P(^GMR(120.8,IEN,0),U,2))=""
"RTN","GMRAY20",19,0)
 ;
"RTN","GMRAY20",20,0)
MAIL ;Send message indicating post install is finished
"RTN","GMRAY20",21,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,GMRATXT,CNT,VADM,DFN,REACTANT,LOOP,DIFROM
"RTN","GMRAY20",22,0)
 S XMDUZ="PATCH GMRA*4*20 POST-INSTALL",XMY(.5)="" S:$G(DUZ) XMY(DUZ)=""
"RTN","GMRAY20",23,0)
 S GMRATXT(1)="The post-install routine for patch GMRA*4*20"
"RTN","GMRAY20",24,0)
 S GMRATXT(2)="finished on "_$$FMTE^XLFDT($$NOW^XLFDT)_"."
"RTN","GMRAY20",25,0)
 S GMRATXT(3)=""
"RTN","GMRAY20",26,0)
 S CNT=4
"RTN","GMRAY20",27,0)
 I $D(TMP) D
"RTN","GMRAY20",28,0)
 .S GMRATXT(CNT)="The following patients had reactants updated to free text entries",CNT=CNT+1,GMRATXT(CNT)="because of a problem with the pointer data.",CNT=CNT+1
"RTN","GMRAY20",29,0)
 .S GMRATXT(CNT)="",CNT=CNT+1,GMRATXT(CNT)="Please use the Allergy Update Utility to fix these entries.",CNT=CNT+1,GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAY20",30,0)
 .S IEN=0 F  S IEN=$O(TMP(IEN)) Q:'+IEN  S NAME=$$GET1^DIQ(2,IEN,.01)_" ("_$E($$GET1^DIQ(2,IEN,.09),6,9)_")" S REACT="" F  S REACT=$O(TMP(IEN,REACT)) Q:REACT=""  D
"RTN","GMRAY20",31,0)
 ..S GMRATXT(CNT)=NAME_$$REPEAT^XLFSTR(" ",(38-$L(NAME)))_REACT,CNT=CNT+1
"RTN","GMRAY20",32,0)
 S XMTEXT="GMRATXT(",XMSUB="PATCH GMRA*4*20 Post Install COMPLETED"
"RTN","GMRAY20",33,0)
 D ^XMD
"RTN","GMRAY20",34,0)
 Q
"VER")
8.0^22.0
"BLD",6071,6)
^31
**END**
**END**
