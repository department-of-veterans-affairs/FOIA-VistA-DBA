Released TIU*1*179 SEQ #169
Extracted from mail message
**KIDS**:TIU*1.0*179^

**INSTALL NAME**
TIU*1.0*179
"BLD",4743,0)
TIU*1.0*179^TEXT INTEGRATION UTILITIES^0^3040914^y
"BLD",4743,1,0)
^^2^2^3040908^^^
"BLD",4743,1,1,0)
The description of this patch may be found in the National Patch Module 
"BLD",4743,1,2,0)
under TIU*1*179.
"BLD",4743,4,0)
^9.64PA^^
"BLD",4743,"KRN",0)
^9.67PA^8989.52^19
"BLD",4743,"KRN",.4,0)
.4
"BLD",4743,"KRN",.401,0)
.401
"BLD",4743,"KRN",.402,0)
.402
"BLD",4743,"KRN",.403,0)
.403
"BLD",4743,"KRN",.5,0)
.5
"BLD",4743,"KRN",.84,0)
.84
"BLD",4743,"KRN",3.6,0)
3.6
"BLD",4743,"KRN",3.8,0)
3.8
"BLD",4743,"KRN",9.2,0)
9.2
"BLD",4743,"KRN",9.8,0)
9.8
"BLD",4743,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",4743,"KRN",9.8,"NM",1,0)
TIUPXAP1^^0^B26483700
"BLD",4743,"KRN",9.8,"NM",2,0)
TIUPXAP3^^0^B3646814
"BLD",4743,"KRN",9.8,"NM",3,0)
TIURS^^0^B58351992
"BLD",4743,"KRN",9.8,"NM",4,0)
TIUVSIT^^0^B62393589
"BLD",4743,"KRN",9.8,"NM",5,0)
TIUPXAP2^^0^B35346501
"BLD",4743,"KRN",9.8,"NM",6,0)
TIUVSIT1^^0^B10115199
"BLD",4743,"KRN",9.8,"NM","B","TIUPXAP1",1)

"BLD",4743,"KRN",9.8,"NM","B","TIUPXAP2",5)

"BLD",4743,"KRN",9.8,"NM","B","TIUPXAP3",2)

"BLD",4743,"KRN",9.8,"NM","B","TIURS",3)

"BLD",4743,"KRN",9.8,"NM","B","TIUVSIT",4)

"BLD",4743,"KRN",9.8,"NM","B","TIUVSIT1",6)

"BLD",4743,"KRN",19,0)
19
"BLD",4743,"KRN",19,"NM",0)
^9.68A^^
"BLD",4743,"KRN",19.1,0)
19.1
"BLD",4743,"KRN",101,0)
101
"BLD",4743,"KRN",409.61,0)
409.61
"BLD",4743,"KRN",771,0)
771
"BLD",4743,"KRN",870,0)
870
"BLD",4743,"KRN",8989.51,0)
8989.51
"BLD",4743,"KRN",8989.52,0)
8989.52
"BLD",4743,"KRN",8994,0)
8994
"BLD",4743,"KRN","B",.4,.4)

"BLD",4743,"KRN","B",.401,.401)

"BLD",4743,"KRN","B",.402,.402)

"BLD",4743,"KRN","B",.403,.403)

"BLD",4743,"KRN","B",.5,.5)

"BLD",4743,"KRN","B",.84,.84)

"BLD",4743,"KRN","B",3.6,3.6)

"BLD",4743,"KRN","B",3.8,3.8)

"BLD",4743,"KRN","B",9.2,9.2)

"BLD",4743,"KRN","B",9.8,9.8)

"BLD",4743,"KRN","B",19,19)

"BLD",4743,"KRN","B",19.1,19.1)

"BLD",4743,"KRN","B",101,101)

"BLD",4743,"KRN","B",409.61,409.61)

"BLD",4743,"KRN","B",771,771)

"BLD",4743,"KRN","B",870,870)

"BLD",4743,"KRN","B",8989.51,8989.51)

"BLD",4743,"KRN","B",8989.52,8989.52)

"BLD",4743,"KRN","B",8994,8994)

"BLD",4743,"QUES",0)
^9.62^^
"BLD",4743,"REQB",0)
^9.611^3^3
"BLD",4743,"REQB",1,0)
TIU*1.0*109^2
"BLD",4743,"REQB",2,0)
TIU*1.0*149^2
"BLD",4743,"REQB",3,0)
SD*5.3*301^2
"BLD",4743,"REQB","B","SD*5.3*301",3)

"BLD",4743,"REQB","B","TIU*1.0*109",1)

"BLD",4743,"REQB","B","TIU*1.0*149",2)

"MBREQ")
0
"PKG",193,-1)
1^1
"PKG",193,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",193,20,0)
^9.402P^^
"PKG",193,22,0)
^9.49I^1^1
"PKG",193,22,1,0)
1.0^3010321^3010321^11
"PKG",193,22,1,"PAH",1,0)
179^3040914^1461
"PKG",193,22,1,"PAH",1,1,0)
^^2^2^3040914
"PKG",193,22,1,"PAH",1,1,1,0)
The description of this patch may be found in the National Patch Module 
"PKG",193,22,1,"PAH",1,1,2,0)
under TIU*1*179.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","TIUPXAP1")
0^1^B26483700
"RTN","TIUPXAP1",1,0)
TIUPXAP1 ; SLC/JER - Interface w/PCE/Visit Tracking ;28-OCT-2003 16:45:37 [8/18/04 11:24am]
"RTN","TIUPXAP1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**15,29,20,89,82,107,117,126,124,149,179**;Jun 20, 1997
"RTN","TIUPXAP1",3,0)
QUE ; Use a RESOURCE to post visit tracking information in background
"RTN","TIUPXAP1",4,0)
 N ZTDTH,ZTIO,ZTSAVE,ZTSK,ZTRTN,ZTDESC
"RTN","TIUPXAP1",5,0)
 ; if there is already a visit, and no workload data quit
"RTN","TIUPXAP1",6,0)
 I +$P($G(TIUDPRM(0)),U,16),(+$P($G(^TIU(8925,$S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)),0)),U,11)=0),+$$WORKOK($S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA))) D  Q:'$$BROKER^XWBLIB
"RTN","TIUPXAP1",7,0)
 . D DEFER($S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)))
"RTN","TIUPXAP1",8,0)
 I +$G(TIU("VISIT")),($D(CPT)'>9) Q
"RTN","TIUPXAP1",9,0)
 I +$P($G(^TIU(8925,$S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)),0)),U,3),($D(CPT)'>9) Q
"RTN","TIUPXAP1",10,0)
 S (ZTSAVE("TIU("),ZTSAVE("DFN"),ZTSAVE("TIUDA"),ZTSAVE("DA"))=""
"RTN","TIUPXAP1",11,0)
 S (ZTSAVE("DUZ("),ZTSAVE("ICD("),ZTSAVE("CPT("),ZTSAVE("SC("))=""
"RTN","TIUPXAP1",12,0)
 S (ZTSAVE("TIUPRLST("),ZTSAVE("XWBOS"))=""
"RTN","TIUPXAP1",13,0)
 S ZTDTH=$H,ZTIO="TIU/PXAPI RESOURCE",ZTRTN="ENQ^TIUPXAP1"
"RTN","TIUPXAP1",14,0)
 S ZTDESC="TIU/PCE/AmbCare API Call" D ^%ZTLOAD
"RTN","TIUPXAP1",15,0)
 I '$D(ZTSK) D ENQ ; If can't get Resource, Run PXAPI call in foreground
"RTN","TIUPXAP1",16,0)
 Q
"RTN","TIUPXAP1",17,0)
WORKOK(DA) ; Evaluate whether workload collection is appropriate
"RTN","TIUPXAP1",18,0)
 N TIUD0 S TIUD0=$G(^TIU(8925,DA,0))
"RTN","TIUPXAP1",19,0)
 Q $S($P(TIUD0,U,13)="A":1,$P(TIUD0,U,13)="I":1,$P(TIUD0,U,13)="T":1,1:0)
"RTN","TIUPXAP1",20,0)
ENQ ; Entry point for Resource
"RTN","TIUPXAP1",21,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","TIUPXAP1",22,0)
 D POST(.TIU,DFN,$S(+$G(TIUDA):+$G(TIUDA),1:$G(DA)),.ICD,.CPT,.SC)
"RTN","TIUPXAP1",23,0)
 Q
"RTN","TIUPXAP1",24,0)
POST(TIUX,DFN,TIUDA,ICD,CPT,SC) ; Call on commitment to post data to PCE/AmbCare
"RTN","TIUPXAP1",25,0)
 N TIULOC,TIUVDT,TIUSTOP,TIUVCAT,TIUVSIT,TIUD0
"RTN","TIUPXAP1",26,0)
 S TIULOC=$P($G(TIUX("VSTR")),";"),TIUVDT=+$P($G(TIUX("VSTR")),";",2)
"RTN","TIUPXAP1",27,0)
 S TIUVCAT=$P($G(TIUX("VSTR")),";",3),TIUSTOP=$P($G(^SC(+TIULOC,0)),U,7)
"RTN","TIUPXAP1",28,0)
 D PXAPI(.TIUVSIT,DFN,TIULOC,TIUVDT,TIUVCAT,TIUSTOP,.ICD,.CPT,.SC,TIUDA)
"RTN","TIUPXAP1",29,0)
 I +$G(TIUVSIT)>0,+$G(TIUDA)>0,$D(^TIU(8925,+TIUDA,0)) S TIUD0=^(0) D
"RTN","TIUPXAP1",30,0)
 . I $P(TIUD0,U,2)=DFN,$P(TIUD0,U,7)=TIUVDT,$P($G(^TIU(8925,+TIUDA,12)),U,11)=TIULOC D
"RTN","TIUPXAP1",31,0)
 . . N DIE,DR,DA S DA=+$G(TIUDA)
"RTN","TIUPXAP1",32,0)
 . . S DIE=8925,DR=".03////^S X="_+$G(TIUVSIT)
"RTN","TIUPXAP1",33,0)
 . . D ^DIE
"RTN","TIUPXAP1",34,0)
 . . S TIUX("VISIT")=+$G(TIUVSIT)_U_TIUVDT
"RTN","TIUPXAP1",35,0)
 Q
"RTN","TIUPXAP1",36,0)
PXAPI(TIUVSIT,DFN,VLOC,VDT,VCAT,VSTOP,ICD,CPT,SC,TIUDA) ; Build input root
"RTN","TIUPXAP1",37,0)
 N TIUPXAPI,SUCCESS,TIUI,TIUPROV,DA,TIUAUTH
"RTN","TIUPXAP1",38,0)
 K ^TMP("TIUPXAPI",$J) S TIUPXAPI=$NA(^TMP("TIUPXAPI",$J))
"RTN","TIUPXAP1",39,0)
 S:+$G(VDT) @TIUPXAPI@("ENCOUNTER",1,"ENC D/T")=+$G(VDT)
"RTN","TIUPXAP1",40,0)
 S:+$G(DFN) @TIUPXAPI@("ENCOUNTER",1,"PATIENT")=+$G(DFN)
"RTN","TIUPXAP1",41,0)
 S:+$G(VLOC) @TIUPXAPI@("ENCOUNTER",1,"HOS LOC")=+$G(VLOC)
"RTN","TIUPXAP1",42,0)
 I $D(SC)>9 D
"RTN","TIUPXAP1",43,0)
 . S @TIUPXAPI@("ENCOUNTER",1,"SC")=$P($G(SC("SC")),U)
"RTN","TIUPXAP1",44,0)
 . I $G(SC("AO"))]"" S @TIUPXAPI@("ENCOUNTER",1,"AO")=$P($G(SC("AO")),U)
"RTN","TIUPXAP1",45,0)
 . I $G(SC("IR"))]"" S @TIUPXAPI@("ENCOUNTER",1,"IR")=$P($G(SC("IR")),U)
"RTN","TIUPXAP1",46,0)
 . I $G(SC("EC"))]"" S @TIUPXAPI@("ENCOUNTER",1,"EC")=$P($G(SC("EC")),U)
"RTN","TIUPXAP1",47,0)
 . I $G(SC("MST"))]"" S @TIUPXAPI@("ENCOUNTER",1,"MST")=$P($G(SC("MST")),U)
"RTN","TIUPXAP1",48,0)
 . I $G(SC("HNC"))]"" S @TIUPXAPI@("ENCOUNTER",1,"HNC")=$P($G(SC("HNC")),U)
"RTN","TIUPXAP1",49,0)
 I $D(CPT) S @TIUPXAPI@("ENCOUNTER",1,"CHECKOUT D/T")=$E($$NOW^XLFDT,1,12)
"RTN","TIUPXAP1",50,0)
 S:$G(VCAT)]"" @TIUPXAPI@("ENCOUNTER",1,"SERVICE CATEGORY")=$G(VCAT)
"RTN","TIUPXAP1",51,0)
 S:+$G(VSTOP) @TIUPXAPI@("ENCOUNTER",1,"DSS ID")=+$G(VSTOP)
"RTN","TIUPXAP1",52,0)
 S @TIUPXAPI@("ENCOUNTER",1,"APPT")=9
"RTN","TIUPXAP1",53,0)
 S @TIUPXAPI@("ENCOUNTER",1,"ENCOUNTER TYPE")="P"
"RTN","TIUPXAP1",54,0)
 I $D(TIUPRLST) D
"RTN","TIUPXAP1",55,0)
 . M @TIUPXAPI@("PROVIDER")=TIUPRLST
"RTN","TIUPXAP1",56,0)
 . S TIUPROV=$S($G(TIUPRLST(1,"PRIMARY")):$G(TIUPRLST(1,"NAME")),1:$G(TIUPRLST(2,"NAME")))
"RTN","TIUPXAP1",57,0)
 E  D
"RTN","TIUPXAP1",58,0)
 . N TIUDDOC
"RTN","TIUPXAP1",59,0)
 . I +$G(TIUDA) D
"RTN","TIUPXAP1",60,0)
 . . S TIUAUTH=$P($G(^TIU(8925,+$G(TIUDA),12)),U,2) Q:+TIUAUTH'>0
"RTN","TIUPXAP1",61,0)
 . . I +$$PROVIDER(TIUAUTH,$G(VDT))'>0 S TIUAUTH=0
"RTN","TIUPXAP1",62,0)
 . S TIUDDOC=+$$DFLTDOC^TIUPXAPI(+$G(VLOC))
"RTN","TIUPXAP1",63,0)
 . D:'$D(TIUPRM0) SETPARM^TIULE
"RTN","TIUPXAP1",64,0)
 . S TIUPROV=$S(+$G(TIUAUTH):+$G(TIUAUTH),+$$PROVIDER(DUZ,$G(VDT)):+$G(DUZ),1:"")
"RTN","TIUPXAP1",65,0)
 . I +TIUPROV>0,'$D(XWBOS) D
"RTN","TIUPXAP1",66,0)
 . . I +TIUDDOC'=+TIUPROV,(+$P(TIUPRM0,U,8)=1) D
"RTN","TIUPXAP1",67,0)
 . . . S @TIUPXAPI@("PROVIDER",1,"NAME")=+TIUDDOC
"RTN","TIUPXAP1",68,0)
 . . . S @TIUPXAPI@("PROVIDER",1,"PRIMARY")=1
"RTN","TIUPXAP1",69,0)
 . . . S @TIUPXAPI@("PROVIDER",2,"NAME")=+TIUPROV
"RTN","TIUPXAP1",70,0)
 . . . S @TIUPXAPI@("PROVIDER",2,"PRIMARY")=0
"RTN","TIUPXAP1",71,0)
 . . E  D
"RTN","TIUPXAP1",72,0)
 . . . S @TIUPXAPI@("PROVIDER",1,"NAME")=+TIUPROV
"RTN","TIUPXAP1",73,0)
 I $D(ICD)>9 S TIUI=0 F  S TIUI=$O(ICD(TIUI)) Q:+TIUI'>0  D
"RTN","TIUPXAP1",74,0)
 . S @TIUPXAPI@("DX/PL",TIUI,"ENC PROVIDER")=$G(TIUPROV)
"RTN","TIUPXAP1",75,0)
 . S @TIUPXAPI@("DX/PL",TIUI,"DIAGNOSIS")=$P(ICD(TIUI),U)
"RTN","TIUPXAP1",76,0)
 . S @TIUPXAPI@("DX/PL",TIUI,"NARRATIVE")=$P(ICD(TIUI),U,3)
"RTN","TIUPXAP1",77,0)
 . S:$P(ICD(TIUI),U,4)]"" @TIUPXAPI@("DX/PL",TIUI,"CATEGORY")=$P(ICD(TIUI),U,4)
"RTN","TIUPXAP1",78,0)
 . S:+$G(ICD(TIUI,"PRIMARY")) @TIUPXAPI@("DX/PL",TIUI,"PRIMARY")=$G(ICD(TIUI,"PRIMARY"))
"RTN","TIUPXAP1",79,0)
 I $D(CPT)>9 S TIUI=0 F  S TIUI=$O(CPT(TIUI)) Q:+TIUI'>0  D
"RTN","TIUPXAP1",80,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"PROCEDURE")=$P(CPT(TIUI),U)
"RTN","TIUPXAP1",81,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"QTY")=$S(+$G(CPT(TIUI,"QTY")):+$G(CPT(TIUI,"QTY")),1:1)
"RTN","TIUPXAP1",82,0)
 . ;Set CPT Modifiers in Array for PCE
"RTN","TIUPXAP1",83,0)
 . N MODCNT,MODATA
"RTN","TIUPXAP1",84,0)
 . S MODCNT=0
"RTN","TIUPXAP1",85,0)
 . F  S MODCNT=$O(CPT(TIUI,"MOD",MODCNT)) Q:'MODCNT  D
"RTN","TIUPXAP1",86,0)
 . . S MODATA=$G(CPT(TIUI,"MOD",MODCNT))
"RTN","TIUPXAP1",87,0)
 . . S:$P(MODATA,U,2)'="" @TIUPXAPI@("PROCEDURE",TIUI,"MODIFIERS",$P(MODATA,U,2))=""
"RTN","TIUPXAP1",88,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"ENC PROVIDER")=$G(TIUPROV)
"RTN","TIUPXAP1",89,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"NARRATIVE")=$P(CPT(TIUI),U,2)
"RTN","TIUPXAP1",90,0)
 . S:$P(CPT(TIUI),U,3)]"" @TIUPXAPI@("PROCEDURE",TIUI,"CATEGORY")=$P(CPT(TIUI),U,3)
"RTN","TIUPXAP1",91,0)
 S SUCCESS=$$DATA2PCE^PXAPI(TIUPXAPI,"TIU","TEXT INTEGRATION UTILITIES",.TIUVSIT,DUZ,0)
"RTN","TIUPXAP1",92,0)
 K @TIUPXAPI
"RTN","TIUPXAP1",93,0)
 Q
"RTN","TIUPXAP1",94,0)
PROVIDER(USER,DATE) ; Was USER a PROVIDER on DATE?
"RTN","TIUPXAP1",95,0)
 N TIUY,PRVCL,EXCL S TIUY=0
"RTN","TIUPXAP1",96,0)
 S EXCL="V0802V0805V0806V0808V0809V0812V0813"
"RTN","TIUPXAP1",97,0)
 I +$$ISA^USRLM(USER,"PROVIDER") S TIUY=1 G PROVIDEX
"RTN","TIUPXAP1",98,0)
 S PRVCL=$$PRVCLASS^PXAPI(USER,DATE) I PRVCL'>0 G PROVIDEX
"RTN","TIUPXAP1",99,0)
 I $P(PRVCL,U,7)]"",(EXCL'[$E($P(PRVCL,U,7),1,5)) S TIUY=1
"RTN","TIUPXAP1",100,0)
PROVIDEX Q TIUY
"RTN","TIUPXAP1",101,0)
DEFER(DA) ; Mark record to defer workload collection
"RTN","TIUPXAP1",102,0)
 N DIE,DR,TIUVSIT
"RTN","TIUPXAP1",103,0)
 I +$P($G(^TIU(8925,$S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)),0)),U,11)=1 Q
"RTN","TIUPXAP1",104,0)
 S DIE=8925,DR=".11////1" D ^DIE
"RTN","TIUPXAP1",105,0)
 ;If not called via the broker try to link document to an existing visit
"RTN","TIUPXAP1",106,0)
 I '$$BROKER^XWBLIB,$$LNKVST^TIUPXAP3(+DA,.TIUVSIT)
"RTN","TIUPXAP1",107,0)
 Q
"RTN","TIUPXAP2")
0^5^B35346501
"RTN","TIUPXAP2",1,0)
TIUPXAP2 ; SLC/JER - More code for the workload capture ;12/4/02@07:54:52 [9/13/04 11:25am]
"RTN","TIUPXAP2",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**20,67,82,107,126,124,149,179**;Jun 20, 1997
"RTN","TIUPXAP2",3,0)
TEST ; Test the PXAPI Data Capture dialogs
"RTN","TIUPXAP2",4,0)
 N CPT,DFN,ICD,ICDARR,CPTARR,SC,DTOUT,TIU,TIUOK
"RTN","TIUPXAP2",5,0)
 S DFN=+$$PATIENT^TIULA
"RTN","TIUPXAP2",6,0)
 S TIU("LOC")=$$SELLOC^TIUVSIT
"RTN","TIUPXAP2",7,0)
 D GETICD^TIUPXAPI(TIU("LOC"),.ICDARR)
"RTN","TIUPXAP2",8,0)
 D ICD^TIUPXAPI(.ICD,.ICDARR)
"RTN","TIUPXAP2",9,0)
 D GETCPT^TIUPXAPC(TIU("LOC"),.CPTARR)
"RTN","TIUPXAP2",10,0)
CPTCALL D CPT^TIUPXAPC(.CPT,.CPTARR)
"RTN","TIUPXAP2",11,0)
 I '$D(CPT),'$D(DTOUT) W !!,$C(7),"You MUST enter one or more Procedures." G CPTCALL
"RTN","TIUPXAP2",12,0)
 D SCASK^TIUPXAPS(.SC,+DFN,.TIU)
"RTN","TIUPXAP2",13,0)
 I $D(DTOUT)!(+$O(ICD(0))'>0)&(+$O(CPT(0))'>0)&(+$O(SC(0))'>0) D  Q
"RTN","TIUPXAP2",14,0)
 . W !,$C(7),"Insufficient information for Workload Credit."
"RTN","TIUPXAP2",15,0)
 . W !,"Missing information will have to be captured by another method."
"RTN","TIUPXAP2",16,0)
 S TIUOK=$$CONFIRM^TIUPXAPI(.ICD,.CPT,.SC)
"RTN","TIUPXAP2",17,0)
 I '+TIUOK D  G TEST
"RTN","TIUPXAP2",18,0)
 . W !!,"Changes Discarded. Please Enter Corrected Workload Data..." H 3
"RTN","TIUPXAP2",19,0)
 . K ICD,CPT,SC,ICDARR,CPTARR
"RTN","TIUPXAP2",20,0)
 K CPTARR,ICDARR
"RTN","TIUPXAP2",21,0)
 W "Done."
"RTN","TIUPXAP2",22,0)
 Q
"RTN","TIUPXAP2",23,0)
CMBLST(EMCODES,CPTCODES) ; Combine E/M and other CPT codes
"RTN","TIUPXAP2",24,0)
 N TIUI,TIUJ,TMPARRY S (TIUI,TIUJ)=0
"RTN","TIUPXAP2",25,0)
 M TMPARRY=EMCODES S TIUI=EMCODES(0)
"RTN","TIUPXAP2",26,0)
 F  S TIUJ=$O(CPTCODES(TIUJ)) Q:+TIUJ'>0  D
"RTN","TIUPXAP2",27,0)
 . S TIUI=+$G(TIUI)+1,TMPARRY(TIUI)=CPTCODES(TIUJ),TMPARRY(0)=TIUI
"RTN","TIUPXAP2",28,0)
 . ;Merge CPT Modifiers
"RTN","TIUPXAP2",29,0)
 . M TMPARRY(TIUI,"MODIFIER")=CPTCODES(TIUJ,"MODIFIER")
"RTN","TIUPXAP2",30,0)
 K CPTCODES
"RTN","TIUPXAP2",31,0)
 M CPTCODES=TMPARRY
"RTN","TIUPXAP2",32,0)
 Q
"RTN","TIUPXAP2",33,0)
PICK(LOW,HIGH,PROMPT,TYPE) ; List selection
"RTN","TIUPXAP2",34,0)
 N X,Y S PROMPT=$G(PROMPT,"Select Item"),TYPE=$G(TYPE,"LO")
"RTN","TIUPXAP2",35,0)
 W !
"RTN","TIUPXAP2",36,0)
 S Y=$$READ^TIUU(TYPE_U_LOW_":"_HIGH,PROMPT)
"RTN","TIUPXAP2",37,0)
 Q Y
"RTN","TIUPXAP2",38,0)
EDTENC(TIUDA,CHNG) ; Edit the encounter for a given note
"RTN","TIUPXAP2",39,0)
 N TIUD0,TIUD12,TIUDFN,TIUI,TIUVSIT,TIUHL,TIUEDT,TIUPAUSE,TIUERR,TIUWHAT
"RTN","TIUPXAP2",40,0)
 N TIUCONT,DA
"RTN","TIUPXAP2",41,0)
 Q:$D(XWBOS)
"RTN","TIUPXAP2",42,0)
 Q:+$P($G(TIUDPRM(0)),U,14)
"RTN","TIUPXAP2",43,0)
 D FULL^VALM1
"RTN","TIUPXAP2",44,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD12=$G(^(12))
"RTN","TIUPXAP2",45,0)
 S TIUHL=$P(TIUD12,U,11)
"RTN","TIUPXAP2",46,0)
 I $P($G(^SC(+TIUHL,0)),U,3)'="C" Q
"RTN","TIUPXAP2",47,0)
 ;
"RTN","TIUPXAP2",48,0)
 ;If not ok to ask workload, quit
"RTN","TIUPXAP2",49,0)
 I '$$WORKOK^TIUPXAP1(+TIUDA) Q
"RTN","TIUPXAP2",50,0)
 ;
"RTN","TIUPXAP2",51,0)
 S TIUDFN=$P(TIUD0,U,2),TIUEDT=$P(TIUD0,U,7),TIUVSIT=$P(TIUD0,U,3)
"RTN","TIUPXAP2",52,0)
 N TIUMVSTF,TIUVSITS
"RTN","TIUPXAP2",53,0)
 ;If no visit has been filed with the document
"RTN","TIUPXAP2",54,0)
 I $G(TIUVSIT)'>0 D
"RTN","TIUPXAP2",55,0)
 . ;Check for the visit
"RTN","TIUPXAP2",56,0)
 . S TIUVSITS=$$GETENC^PXAPI(TIUDFN,TIUEDT,TIUHL)
"RTN","TIUPXAP2",57,0)
 . I TIUVSITS>0 S TIUVSIT=+TIUVSITS
"RTN","TIUPXAP2",58,0)
 . ;Set a flag if multiple visits
"RTN","TIUPXAP2",59,0)
 . I $P(TIUVSITS,U,2)'="" S TIUMVSTF=1
"RTN","TIUPXAP2",60,0)
 . ;If only one visit update the document
"RTN","TIUPXAP2",61,0)
 . I $G(TIUVSIT)>0,'$G(TIUMVSTF) D
"RTN","TIUPXAP2",62,0)
 . . S TIUERR=$$UPDVST(TIUDA,TIUVSIT)
"RTN","TIUPXAP2",63,0)
 . . K ^TMP("PXKENC",$J)
"RTN","TIUPXAP2",64,0)
 W !!
"RTN","TIUPXAP2",65,0)
 ;Ask the user if they wish to enter workload if the parameter is defined
"RTN","TIUPXAP2",66,0)
 ;and the multiple visit flag is not set
"RTN","TIUPXAP2",67,0)
 I $D(TIUDPRM(0)),'$G(TIUMVSTF),$G(TIUVSIT)>0 D  Q:'+TIUCONT
"RTN","TIUPXAP2",68,0)
 . S TIUCONT=$$READ^TIUU("Y","Do you wish to enter workload data at this time","YES")
"RTN","TIUPXAP2",69,0)
 I $G(VALMAR)="^TMP(""TIUR"",$J)" D
"RTN","TIUPXAP2",70,0)
 . N TIU D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUPXAP2",71,0)
 . W !!,"For ",$G(TIU("PNM"))," ",$G(TIU("PID"))," Visit on "
"RTN","TIUPXAP2",72,0)
 . W $P($G(TIU("EDT")),U,2),"...",!
"RTN","TIUPXAP2",73,0)
 I $P($P(TIUD0,U,7),".")>DT D  Q
"RTN","TIUPXAP2",74,0)
 . W !!,$C(7),"ACRP will not accept data for future Encounters.",!
"RTN","TIUPXAP2",75,0)
 . W !,"Workload questions won't be asked for this note.",!
"RTN","TIUPXAP2",76,0)
 . S TIUPAUSE=$$READ^TIUU("EA","Press RETURN to continue...")
"RTN","TIUPXAP2",77,0)
 I $G(VALMAR)'="^TMP(""TIUR"",$J)" W !!,"Editing Encounter Data...",!
"RTN","TIUPXAP2",78,0)
 S TIUWHAT=$S($$CHKAPPT(TIUVSIT,TIUDFN,TIUEDT,TIUHL):"INTV",1:"ADDEDIT")
"RTN","TIUPXAP2",79,0)
 S TIUERR=$$INTV^PXAPI(TIUWHAT,"TIU","TEXT INTEGRATION UTILITIES",.TIUVSIT,$S(+$G(TIUVSIT):"",1:TIUHL),TIUDFN,$S(+$G(TIUVSIT):"",1:TIUEDT))
"RTN","TIUPXAP2",80,0)
 ;
"RTN","TIUPXAP2",81,0)
 ;If an error is returned prompt to continue otherwise if a Visit
"RTN","TIUPXAP2",82,0)
 ;IEN is returned and one is not already defined update the document
"RTN","TIUPXAP2",83,0)
 I +TIUERR<0 D
"RTN","TIUPXAP2",84,0)
 . W ! S TIUPAUSE=$$READ^TIUU("EA","Press RETURN to continue...")
"RTN","TIUPXAP2",85,0)
 ELSE  D
"RTN","TIUPXAP2",86,0)
 . I $G(TIUVSIT)>0,'$P($G(^TIU(8925,+TIUDA,0)),U,3) S TIUERR=$$UPDVST(TIUDA,TIUVSIT)
"RTN","TIUPXAP2",87,0)
 S CHNG=1
"RTN","TIUPXAP2",88,0)
 Q
"RTN","TIUPXAP2",89,0)
 ;
"RTN","TIUPXAP2",90,0)
CHKVST(TIUDA) ;Check the visit associated with the document for key workload
"RTN","TIUPXAP2",91,0)
 ;data elements.  Key data elements include provider, diagnosis,
"RTN","TIUPXAP2",92,0)
 ;procedure and classifications.
"RTN","TIUPXAP2",93,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUPXAP2",94,0)
 ; Output -- 0=No Key Workload Data Elements Exist
"RTN","TIUPXAP2",95,0)
 ;           1=Key Workload Data Elements Exist
"RTN","TIUPXAP2",96,0)
 ;           2=Unable to Determine if Key Workload Data Elements Exist
"RTN","TIUPXAP2",97,0)
 N I,TIUCHKF,TIUD0,TIUDFN,TIUEDT,TIUHL,TIUVSIT,TIUVSITS,X
"RTN","TIUPXAP2",98,0)
 ;
"RTN","TIUPXAP2",99,0)
 ;Set variables, if the 0th node of the document is not defined quit
"RTN","TIUPXAP2",100,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)) I TIUD0="" S TIUCHKF=2 G CHKVSTQ
"RTN","TIUPXAP2",101,0)
 S TIUDFN=$P(TIUD0,U,2),TIUVSIT=$P(TIUD0,U,3),TIUEDT=$P(TIUD0,U,7)
"RTN","TIUPXAP2",102,0)
 S TIUHL=$P($G(^TIU(8925,+TIUDA,12)),U,11)
"RTN","TIUPXAP2",103,0)
 ;
"RTN","TIUPXAP2",104,0)
 ;Get data associated with the visit
"RTN","TIUPXAP2",105,0)
 I $G(TIUVSIT)>0 D
"RTN","TIUPXAP2",106,0)
 . D ENCEVENT^PXKENC(TIUVSIT)
"RTN","TIUPXAP2",107,0)
 ELSE  D
"RTN","TIUPXAP2",108,0)
 . S TIUVSITS=$$GETENC^PXAPI(TIUDFN,TIUEDT,TIUHL)
"RTN","TIUPXAP2",109,0)
 . I TIUVSITS>0 S TIUVSIT=+TIUVSITS
"RTN","TIUPXAP2",110,0)
 . I $P(TIUVSITS,U,2)'="" S TIUCHKF=2 ;multiple visits
"RTN","TIUPXAP2",111,0)
 ;
"RTN","TIUPXAP2",112,0)
 ;If a visit is not defined or multiple visits exist, quit
"RTN","TIUPXAP2",113,0)
 I $G(TIUVSIT)'>0!($G(TIUCHKF)=2) G CHKVSTQ
"RTN","TIUPXAP2",114,0)
 ;
"RTN","TIUPXAP2",115,0)
 ;If a provider or diagnosis or procedure exists for the visit, set flag
"RTN","TIUPXAP2",116,0)
 ;and quit
"RTN","TIUPXAP2",117,0)
 I $D(^TMP("PXKENC",$J,TIUVSIT,"PRV"))!($D(^("CPT")))!($D(^("POV"))) S TIUCHKF=1 G CHKVSTQ
"RTN","TIUPXAP2",118,0)
 ;
"RTN","TIUPXAP2",119,0)
 ;If a classification exists for the visit, set flag and quit
"RTN","TIUPXAP2",120,0)
 I $D(^TMP("PXKENC",$J,TIUVSIT,"VST",TIUVSIT,800)) S X=^(800) D
"RTN","TIUPXAP2",121,0)
 . F I=1:1:6 I $P(X,U,I)'="" S TIUCHKF=1 Q
"RTN","TIUPXAP2",122,0)
 ;
"RTN","TIUPXAP2",123,0)
CHKVSTQ K ^TMP("PXKENC",$J)
"RTN","TIUPXAP2",124,0)
 Q +$G(TIUCHKF)
"RTN","TIUPXAP2",125,0)
 ;
"RTN","TIUPXAP2",126,0)
UPDVST(TIUDA,TIUVSIT,ERROR) ;Update Visit in TIU Document file #8925
"RTN","TIUPXAP2",127,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUPXAP2",128,0)
 ;           TIUVSIT  Visit file (#9000010) IEN
"RTN","TIUPXAP2",129,0)
 ; Output -- 1=Successful and 0=Failure
"RTN","TIUPXAP2",130,0)
 ;           ERROR    Error Message  (Optional)
"RTN","TIUPXAP2",131,0)
 N DIERR,OKF,TIUFDA
"RTN","TIUPXAP2",132,0)
 ;
"RTN","TIUPXAP2",133,0)
 ;Quit if a visit is not defined
"RTN","TIUPXAP2",134,0)
 G UPDVSTQ:$G(TIUVSIT)'>0
"RTN","TIUPXAP2",135,0)
 ;
"RTN","TIUPXAP2",136,0)
 ;Update document with visit
"RTN","TIUPXAP2",137,0)
 S TIUFDA(8925,TIUDA_",",.03)=TIUVSIT
"RTN","TIUPXAP2",138,0)
 L +^TIU(8925,TIUDA):1 I $T D
"RTN","TIUPXAP2",139,0)
 . D FILE^DIE("","TIUFDA","") L -^TIU(8925,TIUDA)
"RTN","TIUPXAP2",140,0)
 . S ERROR=$G(DIERR)
"RTN","TIUPXAP2",141,0)
 . S OKF=$S(+$G(ERROR):0,1:1)
"RTN","TIUPXAP2",142,0)
 ELSE  D
"RTN","TIUPXAP2",143,0)
 . S OKF=0
"RTN","TIUPXAP2",144,0)
UPDVSTQ Q +$G(OKF)
"RTN","TIUPXAP2",145,0)
 ;
"RTN","TIUPXAP2",146,0)
CHKWKL(TIUDA,TIUDPRM) ;Check if workload data should be entered
"RTN","TIUPXAP2",147,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUPXAP2",148,0)
 ;           TIUDPRM  TIU Document Parameters file (#8925.95) Array
"RTN","TIUPXAP2",149,0)
 ; Output -- 1=Enter Workload and 0=Do Not Enter Workload
"RTN","TIUPXAP2",150,0)
 N STATUS,TIUAPPTF,TIUD0,TIUDFN,TIUEDT,TIUHL,TIUVSIT,TIUWKLF,TIURES,TIUINC,TIUARRAY,TIUCNT
"RTN","TIUPXAP2",151,0)
 ;
"RTN","TIUPXAP2",152,0)
 ;Set variables, if the 0th node of the document is not defined quit
"RTN","TIUPXAP2",153,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)) G CHKWKLQ:TIUD0=""
"RTN","TIUPXAP2",154,0)
 S TIUDFN=$P(TIUD0,U,2),TIUVSIT=$P(TIUD0,U,3),TIUEDT=$P(TIUD0,U,7)
"RTN","TIUPXAP2",155,0)
 S TIUHL=$P($G(^TIU(8925,+TIUDA,12)),U,11)
"RTN","TIUPXAP2",156,0)
 ;
"RTN","TIUPXAP2",157,0)
 ;Check if an appointment is associated with the visit
"RTN","TIUPXAP2",158,0)
 S:$$CHKAPPT(TIUVSIT,TIUDFN,TIUEDT,TIUHL)>0 TIUAPPTF=1
"RTN","TIUPXAP2",159,0)
 ;
"RTN","TIUPXAP2",160,0)
 ;If an appointment is not associated with the visit, assume
"RTN","TIUPXAP2",161,0)
 ;the visit is new, set flag to enter workload and quit
"RTN","TIUPXAP2",162,0)
 I '$G(TIUAPPTF) S TIUWKLF=1 G CHKWKLQ
"RTN","TIUPXAP2",163,0)
 ;
"RTN","TIUPXAP2",164,0)
 ;Check the parameter 'Ask Dx/CPT on All Opt Visits'.  If it is set to
"RTN","TIUPXAP2",165,0)
 ;No, workload should not be entered for the appointment.
"RTN","TIUPXAP2",166,0)
 I '$$BROKER^XWBLIB(),'$P($G(TIUDPRM(0)),U,16) G CHKWKLQ
"RTN","TIUPXAP2",167,0)
 ;
"RTN","TIUPXAP2",168,0)
 ;Get the status of the appointment
"RTN","TIUPXAP2",169,0)
 S TIUARRAY(1)=TIUEDT_";"_TIUEDT
"RTN","TIUPXAP2",170,0)
 S TIUARRAY(2)=TIUHL
"RTN","TIUPXAP2",171,0)
 S TIUARRAY(4)=TIUDFN
"RTN","TIUPXAP2",172,0)
 S TIUARRAY("SORT")="P"
"RTN","TIUPXAP2",173,0)
 S TIUARRAY("FLDS")="2;3;10;12;22"
"RTN","TIUPXAP2",174,0)
 S TIUCNT=$$SDAPI^SDAMA301(.TIUARRAY)
"RTN","TIUPXAP2",175,0)
 S STATUS=+$P($G(^TMP($J,"SDAMA301",TIUDFN,TIUEDT)),U,22)
"RTN","TIUPXAP2",176,0)
 ;Check the status of the appointment.  If the appointment can be
"RTN","TIUPXAP2",177,0)
 ;checked-out, workload can be entered.
"RTN","TIUPXAP2",178,0)
 I $D(^SD(409.63,"ACO",1,STATUS)) S TIUWKLF=1
"RTN","TIUPXAP2",179,0)
 ;
"RTN","TIUPXAP2",180,0)
CHKWKLQ Q +$G(TIUWKLF)
"RTN","TIUPXAP2",181,0)
 ;
"RTN","TIUPXAP2",182,0)
CHKAPPT(TIUVSIT,TIUDFN,TIUEDT,TIUHL) ;Check if an appointment is associated with the Visit
"RTN","TIUPXAP2",183,0)
 ; Input  -- TIUVSIT  Visit file (#9000010) IEN
"RTN","TIUPXAP2",184,0)
 ;           TIUDFN   Patient file (#2) IEN
"RTN","TIUPXAP2",185,0)
 ;           TIUEDT   Episode Begin Date/Time
"RTN","TIUPXAP2",186,0)
 ;           TIUHL    Hospital Location file (#44) IEN
"RTN","TIUPXAP2",187,0)
 ; Output -- 0=Appointment is not associated with the Visit
"RTN","TIUPXAP2",188,0)
 ;           1=Appointment is associated with the Visit
"RTN","TIUPXAP2",189,0)
 N TIUAPPTF
"RTN","TIUPXAP2",190,0)
 I $G(TIUVSIT),'$$BROKER^XWBLIB() D
"RTN","TIUPXAP2",191,0)
 . S:$$VST2APPT^PXAPI(TIUVSIT)>0 TIUAPPTF=1
"RTN","TIUPXAP2",192,0)
 ELSE  D
"RTN","TIUPXAP2",193,0)
 . S:$$APPOINT^PXUTL1(TIUDFN,TIUEDT,TIUHL)>0 TIUAPPTF=1
"RTN","TIUPXAP2",194,0)
 Q +$G(TIUAPPTF)
"RTN","TIUPXAP3")
0^2^B3646814
"RTN","TIUPXAP3",1,0)
TIUPXAP3 ;SLC/RMO - Link Document to Visit API ;10/24/03@1000
"RTN","TIUPXAP3",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**179**;Jun 20, 1997
"RTN","TIUPXAP3",3,0)
 ;
"RTN","TIUPXAP3",4,0)
LNKVST(TIUDA,TIUVSIT) ;Entry point to link a document to an existing visit
"RTN","TIUPXAP3",5,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUPXAP3",6,0)
 ; Output -- 1=Successful and 0=Failure
"RTN","TIUPXAP3",7,0)
 ;           TIUVSIT  Visit file (#9000010) IEN
"RTN","TIUPXAP3",8,0)
 N OKF,TIUMVSTF
"RTN","TIUPXAP3",9,0)
 ;
"RTN","TIUPXAP3",10,0)
 ;Check if document needs to be linked to a visit
"RTN","TIUPXAP3",11,0)
 I $D(^TIU(8925,TIUDA,0)),$P(^(0),U,3)'>0 D
"RTN","TIUPXAP3",12,0)
 . ;Get existing visit to associate with document
"RTN","TIUPXAP3",13,0)
 . D GETVST(TIUDA,.TIUVSIT,.TIUMVSTF)
"RTN","TIUPXAP3",14,0)
 . ;If only one visit update the document with the visit
"RTN","TIUPXAP3",15,0)
 . I $G(TIUVSIT)>0,'$G(TIUMVSTF) D
"RTN","TIUPXAP3",16,0)
 . . I $$UPDVST^TIUPXAP2(TIUDA,TIUVSIT) S OKF=1
"RTN","TIUPXAP3",17,0)
 Q +$G(OKF)
"RTN","TIUPXAP3",18,0)
 ;
"RTN","TIUPXAP3",19,0)
GETVST(TIUDA,TIUVSIT,TIUMVSTF) ;Get visit to associate with document
"RTN","TIUPXAP3",20,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUPXAP3",21,0)
 ; Output -- TIUVSIT  Visit file (#9000010) IEN
"RTN","TIUPXAP3",22,0)
 ;           TIUMVSTF Multiple Visit Flag
"RTN","TIUPXAP3",23,0)
 ;                    1=Multiple Visits
"RTN","TIUPXAP3",24,0)
 ;
"RTN","TIUPXAP3",25,0)
 N TIUD0,TIUDFN,TIUEDT,TIUHL,TIUVSITS,TIUVSTR
"RTN","TIUPXAP3",26,0)
 ;
"RTN","TIUPXAP3",27,0)
 ;Set variables
"RTN","TIUPXAP3",28,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0))
"RTN","TIUPXAP3",29,0)
 S TIUDFN=$P(TIUD0,U,2),TIUEDT=$P(TIUD0,U,7)
"RTN","TIUPXAP3",30,0)
 S TIUHL=$P($G(^TIU(8925,TIUDA,12)),U,11)
"RTN","TIUPXAP3",31,0)
 S TIUVSTR=TIUHL_";"_TIUEDT_";"_$P(TIUD0,U,13)
"RTN","TIUPXAP3",32,0)
 ;
"RTN","TIUPXAP3",33,0)
 ;Check if document is an addendum, if it is use visit of parent
"RTN","TIUPXAP3",34,0)
 I +$$ISADDNDM^TIULC1(TIUDA) D  G GETVSTQ
"RTN","TIUPXAP3",35,0)
 . I $D(^TIU(8925,+$P(TIUD0,U,6),0)),$P(^(0),U,3)>0 S TIUVSIT=$P(^(0),U,3)
"RTN","TIUPXAP3",36,0)
 ;
"RTN","TIUPXAP3",37,0)
 ;Check if a document has already been entered for the Vstring,
"RTN","TIUPXAP3",38,0)
 ;if it has use the visit in the AVSTRV cross-reference
"RTN","TIUPXAP3",39,0)
 I +$G(TIUVSTR),+$O(^TIU(8925,"AVSTRV",+TIUDFN,TIUVSTR,0))>0 D  G GETVSTQ:$G(TIUVSIT)>0
"RTN","TIUPXAP3",40,0)
 . S TIUVSIT=+$O(^TIU(8925,"AVSTRV",+TIUDFN,TIUVSTR,0))
"RTN","TIUPXAP3",41,0)
 . I $P($G(^AUPNVSIT(+TIUVSIT,0)),U,5)'=TIUDFN S TIUVSIT=""
"RTN","TIUPXAP3",42,0)
 ;
"RTN","TIUPXAP3",43,0)
 ;Check PCE for a visit
"RTN","TIUPXAP3",44,0)
 S TIUVSITS=$$GETENC^PXAPI(TIUDFN,TIUEDT,TIUHL)
"RTN","TIUPXAP3",45,0)
 I TIUVSITS>0 S TIUVSIT=+TIUVSITS
"RTN","TIUPXAP3",46,0)
 ;
"RTN","TIUPXAP3",47,0)
 ;Set a flag if multiple visits
"RTN","TIUPXAP3",48,0)
 I $P(TIUVSITS,U,2)'="" S TIUMVSTF=1
"RTN","TIUPXAP3",49,0)
GETVSTQ K ^TMP("PXKENC",$J)
"RTN","TIUPXAP3",50,0)
 Q
"RTN","TIURS")
0^3^B58351992
"RTN","TIURS",1,0)
TIURS ; SLC/JER - Electronic signature actions ;19-JAN-2001 11:14:07 [4/27/04 2:35pm] [9/7/04 9:40am]
"RTN","TIURS",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**3,4,20,67,79,98,107,58,100,109,179**;Jun 20, 1997
"RTN","TIURS",3,0)
ACCEPT(TIUSLST,TIUI) ; Accept for signing
"RTN","TIURS",4,0)
 N TIUSGN,TIUMSG,TIUPR,TIUFLAG
"RTN","TIURS",5,0)
 I +$G(TIUDA),($G(TIUEVNT)]"") D  Q:'+$G(TIUSGN)
"RTN","TIURS",6,0)
 . S TIUSGN=$$CANDO^TIULP(TIUDA,TIUEVNT)
"RTN","TIURS",7,0)
 . I '+TIUSGN D
"RTN","TIURS",8,0)
 . . D FULL^VALM1
"RTN","TIURS",9,0)
 . . W !!,"Document has changed...",!,$P(TIUSGN,U,2)
"RTN","TIURS",10,0)
 . . W !!,"Item #",TIUI,": Removed from signature list.",!
"RTN","TIURS",11,0)
 . . W:$$READ^TIUU("EA","Press RETURN to continue...") ""
"RTN","TIURS",12,0)
 S TIUSLST(TIUI)=""
"RTN","TIURS",13,0)
 W !,"Item #",TIUI,": Added to signature list." ;H 2
"RTN","TIURS",14,0)
 I +$P($G(TIUDPRM(0)),U,8) D
"RTN","TIURS",15,0)
 . S TIUMSG="Print this note"
"RTN","TIURS",16,0)
 . S TIUPR=$$READ^TIUU("Y",TIUMSG,"No")
"RTN","TIURS",17,0)
 . I +TIUPR S TIUSLST(TIUI)=1
"RTN","TIURS",18,0)
 I +$G(TIUPR),+$P($G(TIUDPRM(0)),U,9) D
"RTN","TIURS",19,0)
 . S TIUFLAG=$$FLAG^TIUPRPN3
"RTN","TIURS",20,0)
 . I +TIUFLAG S $P(TIUSLST(TIUI),U,2)=1
"RTN","TIURS",21,0)
 I +$G(XTRASGNR) S $P(TIUSLST(TIUI),U,3)=$G(XTRASGNR)
"RTN","TIURS",22,0)
 Q
"RTN","TIURS",23,0)
EDSIG(TIUDA,TIUADD,TIUPASK) ; interactive sign
"RTN","TIURS",24,0)
 N TIU,TIU0,TIU12,ASK,X,X1,TIUTYPE,SIGNER,COSIGNER,TIUTYPE,TIUMSG,TIUSTAT
"RTN","TIURS",25,0)
 N TIUES,TIUACT,TIUDPRM,XTRASGNR,TIUCOM,TIU15,TIUCPFLD
"RTN","TIURS",26,0)
 I +$D(TIUSIGN),(TIUSIGN=0) Q
"RTN","TIURS",27,0)
 I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIURS",28,0)
 I '+$P(TIUPRM0,U,2) S VALMBCK="R" Q
"RTN","TIURS",29,0)
 S TIUADD=1
"RTN","TIURS",30,0)
 S TIU0=$G(^TIU(8925,+TIUDA,0)),TIU12=$G(^(12)),TIU15=$G(^(15))
"RTN","TIURS",31,0)
 S SIGNER=$S(+$P(TIU12,U,4):$P(TIU12,U,4),1:$P(TIU12,U,2))
"RTN","TIURS",32,0)
 S COSIGNER=$P(TIU12,U,8)
"RTN","TIURS",33,0)
 I (DUZ'=SIGNER),(DUZ'=COSIGNER) S XTRASGNR=+$O(^TIU(8925.7,"AE",+TIUDA,+DUZ,0))
"RTN","TIURS",34,0)
 S TIUSTAT=+$P(TIU0,U,5)
"RTN","TIURS",35,0)
 S TIUACT=$S(TIUSTAT'>5:"SIGNATURE",+$G(XTRASGNR):"SIGNATURE",1:"COSIGNATURE")
"RTN","TIURS",36,0)
 S ASK=$$CANDO^TIULP(TIUDA,TIUACT)
"RTN","TIURS",37,0)
 S TIUTYPE=$$PNAME^TIULC1(+TIU0)
"RTN","TIURS",38,0)
 I +ASK'>0 D  Q
"RTN","TIURS",39,0)
 . S VALMBCK="R"
"RTN","TIURS",40,0)
 . I +$$ISA^USRLM(+$G(DUZ),"MEDICAL INFORMATION SECTION"),(+$$ISPN^TIULX(+TIU0)'>0) Q
"RTN","TIURS",41,0)
 . I +$$ISA^USRLM(+$G(DUZ),"MAS TRANSCRIPTIONIST") Q
"RTN","TIURS",42,0)
 . I +$$ISA^USRLM(+$G(DUZ),"TRANSCRIPTIONIST") Q
"RTN","TIURS",43,0)
 . W !,$P(ASK,U,2)
"RTN","TIURS",44,0)
 . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURS",45,0)
 W:$G(VALMAR)'="^TMP(""TIUVIEW"",$J)" !
"RTN","TIURS",46,0)
 ;If document is a clinical procedures (CP) title, and
"RTN","TIURS",47,0)
 ;(P179 for P182) this is not an additional signature,
"RTN","TIURS",48,0)
 ;check if CP fields are required. If required, prompt for them
"RTN","TIURS",49,0)
 ;and don't let user sign unless fields are defined. (P109)
"RTN","TIURS",50,0)
 I '$G(XTRASGNR),+$$ISA^TIULX(+TIU0,+$$CLASS^TIUCP),$$REQCPF^TIULP(+$P($G(^TIU(8925,+TIUDA,14)),U,5)) D  Q:+TIUCPFLD'>0
"RTN","TIURS",51,0)
 . I $G(^TIU(8925,+TIUDA,702)),$P(^(702),U)]"",$P(^(702),U,2)]"" S TIUCPFLD=1 Q
"RTN","TIURS",52,0)
 . S TIUCPFLD=$$ASKCPF(TIUDA)
"RTN","TIURS",53,0)
 . I +TIUCPFLD'>0 D
"RTN","TIURS",54,0)
 . . W !!,"The Procedure Summary Code and Date/Time Performed MUST be entered before",!,"you may sign.",!
"RTN","TIURS",55,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") ;pause
"RTN","TIURS",56,0)
 I $S(+$$REQCOSIG^TIULP(+TIU0,+TIUDA,+SIGNER):1,+$P(TIU15,U,6):1,1:0),(+COSIGNER'>0) D  Q:+COSIGNER'>0
"RTN","TIURS",57,0)
 . S COSIGNER=$$ASKCSNR(TIUDA,SIGNER)
"RTN","TIURS",58,0)
 . I +COSIGNER'>0 D
"RTN","TIURS",59,0)
 . . W !!,"This ",TIUTYPE," MUST have a cosigner before you may sign.",!
"RTN","TIURS",60,0)
 . . I $$READ^TIUU("EA","Press RETURN to continue...") ; pause
"RTN","TIURS",61,0)
 I TIUSTAT=5,$G(DUZ)'=SIGNER D
"RTN","TIURS",62,0)
 . S TIUMSG="Author hasn't signed, are you SURE you want to sign "_TIUTYPE
"RTN","TIURS",63,0)
 W ! I $G(TIUMSG)]"",$$READ^TIUU("YO",TIUMSG,"NO","^D SIG^TIUDIRH")'>0 S VALMBCK="R" Q
"RTN","TIURS",64,0)
 L +^TIU(8925,+TIUDA):1
"RTN","TIURS",65,0)
 E  W !?5,$C(7),"Another user is editing this entry.",! W:$$READ^TIUU("EA","Press RETURN to continue...") "" S TIUQUIT=2 Q
"RTN","TIURS",66,0)
 S TIUES=$$ASKSIG^TIULA1 L -^TIU(8925,+TIUDA) I '+TIUES Q
"RTN","TIURS",67,0)
 I $D(VALMAR) D FULL^VALM1
"RTN","TIURS",68,0)
 I +$G(XTRASGNR) D ADDSIG^TIURS1(TIUDA,XTRASGNR)
"RTN","TIURS",69,0)
 I '+$G(XTRASGNR) D ES(TIUDA,TIUES)
"RTN","TIURS",70,0)
 I $G(TIUACT)="COSIGNATURE",(+$$ISADDNDM^TIULC1(TIUDA)'>0) D  Q:+TIUCOM
"RTN","TIURS",71,0)
 . N TIUADDND S TIUCOM=0
"RTN","TIURS",72,0)
 . S TIUADDND=$$READ^TIUU("YO","Do you wish to add your comments in an addendum","NO")
"RTN","TIURS",73,0)
 . I +TIUADDND D ADD^TIUADD(TIUDA,.TIUCHNG) S TIUCOM=1
"RTN","TIURS",74,0)
 I '+$G(TIUPASK) Q
"RTN","TIURS",75,0)
 D DOCPRM^TIULC1(+TIU0,.TIUDPRM,TIUDA)
"RTN","TIURS",76,0)
 I +$P($G(TIUDPRM(0)),U,8) D PRINT^TIUEPRNT(TIUDA)
"RTN","TIURS",77,0)
 Q
"RTN","TIURS",78,0)
 ;
"RTN","TIURS",79,0)
ASKCPF(DA) ;Ask required clinical procedure fields
"RTN","TIURS",80,0)
 N DR,DIE,TIUY
"RTN","TIURS",81,0)
 D FULL^VALM1
"RTN","TIURS",82,0)
AGNCP W !!,$C(7),"You must designate the Procedure Summary Code and Date/Time Performed...",!
"RTN","TIURS",83,0)
 L +^TIU(8925,+DA):1
"RTN","TIURS",84,0)
 E  W !?5,$C(7),"Another user is editing this entry.",! W:$$READ^TIUU("EA","Press RETURN to continue...") "" G ASKCPFQ
"RTN","TIURS",85,0)
 S DR="70201R;70202R"
"RTN","TIURS",86,0)
 S DIE="^TIU(8925," D ^DIE
"RTN","TIURS",87,0)
ASKCPFQ L -^TIU(8925,+DA)
"RTN","TIURS",88,0)
 I $G(^TIU(8925,+DA,702)),$P(^(702),U)]"",$P(^(702),U,2)]"" S TIUY=1
"RTN","TIURS",89,0)
 Q +$G(TIUY)
"RTN","TIURS",90,0)
 ;
"RTN","TIURS",91,0)
ASKCSNR(DA,SIGNER) ; Ask cosigner
"RTN","TIURS",92,0)
 N DR,DIE,TIUY,TIUDCSNR,TIUPREF,TIUFLD
"RTN","TIURS",93,0)
 S TIUPREF=$$PERSPRF^TIULE(SIGNER)
"RTN","TIURS",94,0)
 S TIUDCSNR=$$PERSNAME^TIULC1($P(TIUPREF,U,9))
"RTN","TIURS",95,0)
 I TIUDCSNR="UNKNOWN" S TIUDCSNR=""
"RTN","TIURS",96,0)
 S TIUFLD=$S(+$$ISDS^TIULX(+$G(^TIU(8925,+DA,0))):"ATTENDING PHYSICIAN",1:"EXPECTED COSIGNER")
"RTN","TIURS",97,0)
 D FULL^VALM1
"RTN","TIURS",98,0)
AGN W !!,$C(7),"You must designate an ",TIUFLD,"...",!
"RTN","TIURS",99,0)
 L +^TIU(8925,+DA):1
"RTN","TIURS",100,0)
 E  W !?5,$C(7),"Another user is editing this entry.",! W:$$READ^TIUU("EA","Press RETURN to continue...") "" G ASKCOUT
"RTN","TIURS",101,0)
 I $E(TIUFLD)="A" S DR="1209R//^S X=TIUDCSNR;1208////^S X=$P(^TIU(8925,DA,12),U,9);1506////1"
"RTN","TIURS",102,0)
 E  S DR="1208R//^S X=TIUDCSNR;1506////1"
"RTN","TIURS",103,0)
 S DIE="^TIU(8925," D ^DIE
"RTN","TIURS",104,0)
ASKCOUT L -^TIU(8925,+DA)
"RTN","TIURS",105,0)
 S TIUY=+$P($G(^TIU(8925,+DA,12)),U,8)
"RTN","TIURS",106,0)
 Q TIUY
"RTN","TIURS",107,0)
ES(DA,TIUES,TIUI) ; ^DIE call for /es/
"RTN","TIURS",108,0)
 N SIGNER,DR,DIE,ESDT,TIUSTAT,TIUSTNOW,COSIGNER,SVCHIEF,CSREQ,TIUPRINT
"RTN","TIURS",109,0)
 N CSNEED,TIUTTL,TIUPSIG,TIUDPRM,DAO,TIUSTWAS,TIUSTIS,DAORIG
"RTN","TIURS",110,0)
 S TIUSTWAS=$P($G(^TIU(8925,DA,0)),U,5)
"RTN","TIURS",111,0)
 D DOCPRM^TIULC1(+$G(^TIU(8925,+DA,0)),.TIUDPRM,DA)
"RTN","TIURS",112,0)
 S TIUSTAT=$P($G(^TIU(8925,+DA,0)),U,5),ESDT=$$NOW^TIULC
"RTN","TIURS",113,0)
 S SVCHIEF=+$$ISA^USRLM(DUZ,"CLINICAL SERVICE CHIEF")
"RTN","TIURS",114,0)
 S SIGNER=$P(^TIU(8925,+DA,12),U,4),COSIGNER=$P(^(12),U,8),CSREQ=0
"RTN","TIURS",115,0)
 S CSNEED=+$P($G(^TIU(8925,+DA,15)),U,6)
"RTN","TIURS",116,0)
 I +CSNEED,(DUZ'=COSIGNER),'+$G(SVCHIEF),(TIUSTAT'=6) S CSREQ=1
"RTN","TIURS",117,0)
 I TIUSTAT=5 D
"RTN","TIURS",118,0)
 . S DR=".05////"_$S(+CSREQ:6,1:7)_";1501////"_ESDT_";1502////"_+DUZ
"RTN","TIURS",119,0)
 . I '+$G(CSREQ),+CSNEED,$S(DUZ=COSIGNER:1,+$G(SVCHIEF):1,1:0) D
"RTN","TIURS",120,0)
 . . S DR=DR_";1506////0;1507////"_ESDT_";1508////"_+DUZ_";1509///^S X=$P(TIUES,U,2);1510///^S X=$P(TIUES,U,3);1511////E"
"RTN","TIURS",121,0)
 I TIUSTAT=6 S DR=".05////7;1506////0;1507////"_ESDT_";1508////"_+DUZ
"RTN","TIURS",122,0)
 Q:'$D(DR)
"RTN","TIURS",123,0)
 S DIE=8925 D ^DIE W:'$D(XWBOS) "."
"RTN","TIURS",124,0)
 I TIUSTAT=5 S DR="1503///^S X=$P(TIUES,U,2);1504///^S X=$P(TIUES,U,3);1505////E"
"RTN","TIURS",125,0)
 I TIUSTAT=6 D
"RTN","TIURS",126,0)
 . N TIUSBY S DR="",TIUSBY=$P($G(^TIU(8925,+DA,15)),U,2)
"RTN","TIURS",127,0)
 . I +TIUSBY>0 S DR="1503///^S X=$$SIGNAME^TIULS("_TIUSBY_");1504///^S X=$$SIGTITL^TIULS("_TIUSBY_");"
"RTN","TIURS",128,0)
 . S DR=$G(DR)_"1509///^S X=$P(TIUES,U,2);1510///^S X=$P(TIUES,U,3);1511////E"
"RTN","TIURS",129,0)
 S DIE=8925 D ^DIE W:'$D(XWBOS) "." S:'+$G(TIUCHNG) TIUCHNG=1
"RTN","TIURS",130,0)
 D SEND^TIUALRT(DA),SIGNIRT^TIUDIRT(+DA)
"RTN","TIURS",131,0)
 S DAORIG=DA
"RTN","TIURS",132,0)
 I +$$ISADDNDM^TIULC1(DA) S DA=+$P(^(0),U,6)
"RTN","TIURS",133,0)
 I +$G(CSREQ)'>0 D MAIN^TIUPD(DA,"S") I 1
"RTN","TIURS",134,0)
 ;If 'Credit Stop Code on Completion' is Yes
"RTN","TIURS",135,0)
 I +$P(^TIU(8925,+DA,0),U,11) D
"RTN","TIURS",136,0)
 . ;If workload does not exist, process using TIU's interview otherwise
"RTN","TIURS",137,0)
 . ;process as an edit using PCE's interview
"RTN","TIURS",138,0)
 . I '$$CHKVST^TIUPXAP2(+DA) D  I 1
"RTN","TIURS",139,0)
 . . N TIUCONT,TIUPRMT
"RTN","TIURS",140,0)
 . . Q:$D(XWBOS)
"RTN","TIURS",141,0)
 . . I $P(+$P(^TIU(8925,+DA,0),U,7),".")>DT D  Q
"RTN","TIURS",142,0)
 . . . W !!
"RTN","TIURS",143,0)
 . . . D QUE^TIUPXAP1
"RTN","TIURS",144,0)
 . . . W:$$READ^TIUU("EA","Press RETURN to continue...") ""
"RTN","TIURS",145,0)
 . . W !!
"RTN","TIURS",146,0)
 . . ;Check if workload should be entered
"RTN","TIURS",147,0)
 . . I $$CHKWKL^TIUPXAP2(+DA,.TIUDPRM) D CREDIT^TIUVSIT(DA)
"RTN","TIURS",148,0)
 . E  D
"RTN","TIURS",149,0)
 . . ;Check if workload should be entered
"RTN","TIURS",150,0)
 . . I $$CHKWKL^TIUPXAP2(+DA,.TIUDPRM) D EDTENC^TIUPXAP2(DA)
"RTN","TIURS",151,0)
 . D REMFLAG^TIUVSIT(+DA)
"RTN","TIURS",152,0)
 ;If document does not have a visit and docmt is associated with
"RTN","TIURS",153,0)
 ;an event type visit or call is invoked by broker, check if
"RTN","TIURS",154,0)
 ;docmt can be linked to an existing visit or try and create a new
"RTN","TIURS",155,0)
 ;visit. (P179)
"RTN","TIURS",156,0)
 I $D(^TIU(8925,+DA,0)),$P(^(0),U,3)'>0,($P(^(0),U,13)="E"!($$BROKER^XWBLIB)) D
"RTN","TIURS",157,0)
 . N D0,DFN,TIU,TIUVSIT
"RTN","TIURS",158,0)
 . ;Try to link docmt to an existing visit, quit if successful
"RTN","TIURS",159,0)
 . I $$LNKVST^TIUPXAP3(DA,.TIUVSIT) Q
"RTN","TIURS",160,0)
 . ;Otherwise set TIU array and DFN to use TIU API which calls PCE
"RTN","TIURS",161,0)
 . ;to resolve multiple visits or creates a new visit
"RTN","TIURS",162,0)
 . D GETTIU^TIULD(.TIU,DA)
"RTN","TIURS",163,0)
 . S DFN=$P($G(^TIU(8925,+DA,0)),U,2)
"RTN","TIURS",164,0)
 . D QUE^TIUPXAP1
"RTN","TIURS",165,0)
 ; post-signature action
"RTN","TIURS",166,0)
 N TIUCONS S TIUCONS=-1
"RTN","TIURS",167,0)
 D ISCNSLT^TIUCNSLT(.TIUCONS,+$G(^TIU(8925,DA,0)))
"RTN","TIURS",168,0)
 I TIUCONS S DA=DAORIG
"RTN","TIURS",169,0)
 S TIUSTIS=$P($G(^TIU(8925,DA,0)),U,5)
"RTN","TIURS",170,0)
 S TIUTTL=+$G(^TIU(8925,+DA,0)),TIUPSIG=$$POSTSIGN^TIULC1(TIUTTL)
"RTN","TIURS",171,0)
 I +$L(TIUPSIG),'+$G(CSREQ) X TIUPSIG
"RTN","TIURS",172,0)
 I TIUCONS,TIUSTIS=7,TIUSTWAS<7,$$HASKIDS^TIUSRVLI(DA) D
"RTN","TIURS",173,0)
 . N SEQUENCE,TIUKIDS,TIUINT,TIUK
"RTN","TIURS",174,0)
 . S SEQUENCE="D",TIUKIDS="TIUKIDS",TIUINT=0,TIUK=0
"RTN","TIURS",175,0)
 . D SETKIDS^TIUSRVLI(TIUKIDS,DA,TIUINT)
"RTN","TIURS",176,0)
 . F  S TIUK=$O(TIUKIDS(TIUK)) Q:'TIUK  D
"RTN","TIURS",177,0)
 . . I $P(TIUKIDS(TIUK),U,7)="completed" X TIUPSIG
"RTN","TIURS",178,0)
 Q
"RTN","TIUVSIT")
0^4^B62393589
"RTN","TIUVSIT",1,0)
TIUVSIT ; SLC/JER - Interactive Visit look-up; 28-OCT-2003 [9/14/04 10:59am]
"RTN","TIUVSIT",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**39,91,107,117,179**;Jun 20, 1997
"RTN","TIUVSIT",3,0)
ENPN(TIUY,DFN,ALLOWNEW) ; Entry point for Progress Notes
"RTN","TIUVSIT",4,0)
 N DIRUT,DUOUT,DTOUT,TIULOC,TIUINOUT
"RTN","TIUVSIT",5,0)
 I +$G(DFN)'>0 Q
"RTN","TIUVSIT",6,0)
 I +$D(^DPT(DFN,.1)) D MAIN^TIUMOVE(.TIUY,DFN,"","","","1","CURRENT",0) Q
"RTN","TIUVSIT",7,0)
 S TIUINOUT=$$INOUT
"RTN","TIUVSIT",8,0)
 I $D(DIRUT) Q
"RTN","TIUVSIT",9,0)
 I $P(TIUINOUT,U)="o" D MAIN(.TIUY,DFN,"","","","",1,"","",$G(ALLOWNEW)) Q
"RTN","TIUVSIT",10,0)
 D MAIN^TIUMOVE(.TIUY,DFN,"","","",1,"LAST",1)
"RTN","TIUVSIT",11,0)
 Q
"RTN","TIUVSIT",12,0)
MAIN(TIUY,DFN,TIUSSN,TIUVDT,TIULDT,TIUDFLT,TIUMODE,TIULOC,TIUOCC,LETNEW) ;Control
"RTN","TIUVSIT",13,0)
 N TIUFUTUR
"RTN","TIUVSIT",14,0)
AGN K ^TMP("TIUVN",$J),^TMP("TIUVDT",$J),^TMP("TIUVNI",$J),^TMP("TIUNOT",$J),^TMP($J,"SDAMA301")
"RTN","TIUVSIT",15,0)
 N C,I,N,TIUI,TIUII,TIUDA,TIUER,TIUOK,TIUX,TIUOUT,X,TIUNVIS,VASD,VAERR
"RTN","TIUVSIT",16,0)
 N TIUPICK,TIULAST,TIUSDC,TIUVTRY,TIUAPPTS,TIUARR
"RTN","TIUVSIT",17,0)
 S TIUMODE=$G(TIUMODE,1),LETNEW=$G(LETNEW,1)
"RTN","TIUVSIT",18,0)
 S:+$G(DFN)'>0 DFN=+$$PATIENT^TIULA($G(TIUSSN)) I +DFN'>0 S TIUOUT=1 Q
"RTN","TIUVSIT",19,0)
 S TIUOCC=$G(TIUOCC,20)
"RTN","TIUVSIT",20,0)
 S TIUARR("FLDS")="1;2"
"RTN","TIUVSIT",21,0)
 S TIUARR(1)=2000000,TIUARR(4)=DFN
"RTN","TIUVSIT",22,0)
 S TIUAPPTS=$$SDAPI^SDAMA301(.TIUARR)
"RTN","TIUVSIT",23,0)
 K ^TMP($J,"SDAMA301")
"RTN","TIUVSIT",24,0)
 I '$G(TIUAPPTS),(+TIUMODE'>0) Q
"RTN","TIUVSIT",25,0)
 ; No appointments
"RTN","TIUVSIT",26,0)
 I '$G(TIUAPPTS),(+TIUMODE>0) D  I +$G(TIUX)'>0 Q
"RTN","TIUVSIT",27,0)
 . W !!,"No SCHEDULED APPOINTMENTS on file"
"RTN","TIUVSIT",28,0)
 . D MAIN^TIUVISIT(.TIUY,DFN,$G(TIUSSN),$G(TIUVDT),$G(TIULDT),$G(TIUDFLT),$G(TIUMODE),$G(TIULOC),$G(TIUOCC),$G(LETNEW),"H",1,.TIUFUTUR)
"RTN","TIUVSIT",29,0)
 . I +$G(TIUOUT) Q
"RTN","TIUVSIT",30,0)
 . I '$D(TIUY),+LETNEW,'+$G(TIUVTRY) D ADD(DFN,.TIUX,1,.TIUSDC)
"RTN","TIUVSIT",31,0)
 I '$G(TIUAPPTS),(+TIUX>0) G VADPT
"RTN","TIUVSIT",32,0)
 I '$D(^TMP("TIUVN",$J)) D GETAPPT^TIUVSIT1(DFN,$G(TIULOC),$G(TIUOCC),$G(TIULDT),"",.TIULAST,$G(TIUVDT),+$G(TIUFUTUR)) S TIUFUTUR=0
"RTN","TIUVSIT",33,0)
 ; error in visit lookup
"RTN","TIUVSIT",34,0)
 I +TIUMODE,$D(^TMP("TIUVERR",$J)) D  Q
"RTN","TIUVSIT",35,0)
 . W !!,$G(^TMP("TIUVERR",$J)),!
"RTN","TIUVSIT",36,0)
 . I $D(^TMP("TIUVERR",$J,115)) W ^TMP("TIUVERR",$J,115),!
"RTN","TIUVSIT",37,0)
 . K ^TMP("TIUVERR",$J)
"RTN","TIUVSIT",38,0)
 ; no appointments scheduled w/in selection range
"RTN","TIUVSIT",39,0)
 I +TIUMODE,'$D(^TMP("TIUVN",$J)),+LETNEW D  G:+$G(TIUFUTUR) AGN Q:+$G(TIUX)'>0  G VADPT
"RTN","TIUVSIT",40,0)
 . N WHATNOW
"RTN","TIUVSIT",41,0)
 . W !!,"No SCHEDULED APPOINTMENTS found through "
"RTN","TIUVSIT",42,0)
 . W $$DATE^TIULS($$FMADD^XLFDT(DT,1),"AMTH DD, CCYY"),"...",!
"RTN","TIUVSIT",43,0)
 . S WHATNOW=$$UP^XLFSTR($E($$NOTFOUND^TIUVSIT1))
"RTN","TIUVSIT",44,0)
 . Q:$S(+$G(DUOUT):1,+$G(DTOUT):1,+$G(DIROUT):1,1:0)
"RTN","TIUVSIT",45,0)
 . I $E(WHATNOW)="U" D  Q
"RTN","TIUVSIT",46,0)
 . . D MAIN^TIUVISIT(.TIUY,DFN,$G(TIUSSN),$G(TIUVDT),$G(TIULDT),$G(TIUDFLT),$G(TIUMODE),$G(TIULOC),$G(TIUOCC),$G(LETNEW),"H",1,.TIUFUTUR) Q:+$G(TIUFUTUR)
"RTN","TIUVSIT",47,0)
 . . I '$D(TIUY),+LETNEW,'+$G(TIUVTRY) D ADD(DFN,.TIUX,1,.TIUSDC)
"RTN","TIUVSIT",48,0)
 . I $E(WHATNOW)="F" S TIUFUTUR=1 Q  ; FUTURE
"RTN","TIUVSIT",49,0)
 . D ADD(DFN,.TIUX,$S($E(WHATNOW)="N":"",1:1),.TIUSDC)
"RTN","TIUVSIT",50,0)
 I '+TIUMODE,'$D(^TMP("TIUVNI",$J)) Q
"RTN","TIUVSIT",51,0)
 I '+TIUMODE,$G(TIUDFLT)="LAST" D  Q:+$G(TIUX)'>0  G VADPT
"RTN","TIUVSIT",52,0)
 . N TIUI S TIUI=+$O(^TMP("TIUVNI",$J,0))
"RTN","TIUVSIT",53,0)
 . S TIUX=$$GETVSIT(TIUI)
"RTN","TIUVSIT",54,0)
 I +TIUMODE,($G(TIUDFLT)="LAST"),(+$O(^TMP("TIUVNI",$J,0))>0) S TIUPICK=+$O(^TMP("TIUVNI",$J,0))
"RTN","TIUVSIT",55,0)
 S (TIUER,TIUOK,TIUI)=0
"RTN","TIUVSIT",56,0)
 W !!,"The following SCHEDULED VISITS are available:",!
"RTN","TIUVSIT",57,0)
 F  S TIUI=$O(^TMP("TIUVN",$J,TIUI)) Q:+TIUI'>0  D  Q:+TIUER!+TIUOK!+$G(TIUX)!+$G(TIUOUT)
"RTN","TIUVSIT",58,0)
 . S TIUII=TIUI D WRITE
"RTN","TIUVSIT",59,0)
 . I '(TIUI#5) D BREAK I $S($G(X)="U":1,$G(X)["UNS":1,1:0) D  Q
"RTN","TIUVSIT",60,0)
 . . D MAIN^TIUVISIT(.TIUY,DFN,$G(TIUSSN),$G(TIUVDT),$G(TIULDT),$G(TIUDFLT),$G(TIUMODE),$G(TIULOC),$G(TIUOCC),$G(LETNEW),"H",1,.TIUFUTUR)
"RTN","TIUVSIT",61,0)
 . . S TIUOUT=1
"RTN","TIUVSIT",62,0)
 . I $G(X)["?" S X="",TIUI=TIUI-5
"RTN","TIUVSIT",63,0)
 . I $G(X)["F" S X=""
"RTN","TIUVSIT",64,0)
 I +$G(TIUFUTUR),$S(+TIUOK:1,+TIUER:1,$D(TIUY)>9:1,+$G(TIUX):1,1:0) S TIUFUTUR=0
"RTN","TIUVSIT",65,0)
 I +$G(TIUFUTUR) S TIUOUT=0 G AGN
"RTN","TIUVSIT",66,0)
 G:$D(TIUOUT) CLEAN
"RTN","TIUVSIT",67,0)
 G AGN:+TIUER
"RTN","TIUVSIT",68,0)
 I +$G(TIUII)#5,+TIUMODE D BREAK I $S($G(X)="U":1,$G(X)["UNS":1,1:0) D  G:+$G(TIUFUTUR) AGN Q
"RTN","TIUVSIT",69,0)
 . D MAIN^TIUVISIT(.TIUY,DFN,$G(TIUSSN),$G(TIUVDT),$G(TIULDT),$G(TIUDFLT),$G(TIUMODE),$G(TIULOC),$G(TIUOCC),$G(LETNEW),"H",1,.TIUFUTUR)
"RTN","TIUVSIT",70,0)
 G:$D(TIUOUT) CLEAN
"RTN","TIUVSIT",71,0)
 I $S(+TIUER:1,$G(X)["?":1,$G(X)["F":1,1:0) G AGN
"RTN","TIUVSIT",72,0)
 I +TIUOK,'+$G(TIUNVIS) D
"RTN","TIUVSIT",73,0)
 . S TIUX=$$GETVSIT(+TIUOK)
"RTN","TIUVSIT",74,0)
 . W "  ",$$DATE^TIULS(+$P(TIUX,";",2),"AMTH DD CCYY@HR:MIN")
"RTN","TIUVSIT",75,0)
VADPT D PATVADPT^TIULV(.TIUY,DFN,"",$G(TIUX),$G(TIUSDC))
"RTN","TIUVSIT",76,0)
CLEAN K ^TMP("TIUVN",$J),^TMP("TIUVDT",$J),^TMP("TIUVNI",$J),^TMP("TIUNOT",$J)
"RTN","TIUVSIT",77,0)
 Q
"RTN","TIUVSIT",78,0)
BREAK ; Handle prompting
"RTN","TIUVSIT",79,0)
 I TIUII=1 S (TIUOK,X)=1
"RTN","TIUVSIT",80,0)
 W !,"CHOOSE 1-",TIUII,", or",!
"RTN","TIUVSIT",81,0)
 W:'(TIUII#20) "<M>ORE VISITS, " W "<U>NSCHEDULED VISITS, "
"RTN","TIUVSIT",82,0)
 I +$P(TIUPRM0,U,14) W:'+LETNEW " or " W "<F>UTURE VISITS, "
"RTN","TIUVSIT",83,0)
 W:+LETNEW "or <N>EW VISIT"
"RTN","TIUVSIT",84,0)
 W:$D(^TMP("TIUVN",$J,TIUII+1)) !,"<RETURN> TO CONTINUE",!,"OR '^' TO QUIT"
"RTN","TIUVSIT",85,0)
 W ": " W:$D(TIUPICK) $P(^TMP("TIUVN",$J,TIUPICK),U),"// " R X:DTIME
"RTN","TIUVSIT",86,0)
 S X=$$UP^XLFSTR(X)
"RTN","TIUVSIT",87,0)
 I $S('$T:1,X["^":1,1:0) S (TIUER,TIUOUT)=1 Q
"RTN","TIUVSIT",88,0)
 S:X=""&$D(TIUPICK) X=TIUPICK
"RTN","TIUVSIT",89,0)
 I X["?" D HELP^TIUVSITH(X) Q
"RTN","TIUVSIT",90,0)
 I $S(X="M":1,X="MORE":1,1:0) D MORE Q
"RTN","TIUVSIT",91,0)
 I $S(X="F":1,X["FUT":1,1:0) D FUTURE Q
"RTN","TIUVSIT",92,0)
 I $S(X="U":1,X["UNS":1,1:0) Q
"RTN","TIUVSIT",93,0)
 I +LETNEW'>0,(X=""),'$D(^TMP("TIUVN",$J,TIUII+1)) S (TIUER,TIUOUT)=1 Q
"RTN","TIUVSIT",94,0)
 I +LETNEW,$S(X="N":1,X="NEW":1,X=""&'$D(^TMP("TIUVN",$J,TIUII+1)):1,1:0) D ADD(DFN,.TIUX,$S(X="N":0,X="NEW":0,1:1),.TIUSDC) I +$G(TIUX)'>0 S (TIUER,TIUOUT)=1 Q
"RTN","TIUVSIT",95,0)
 I $S(X="":1,X="N":1,X="NEW":1,1:0) Q
"RTN","TIUVSIT",96,0)
 I X=" ",$D(^DISV(DUZ,"^DPT("_DFN_",""S"",")) S TIUX=^("^DPT("_DFN_",""S"",") I $D(^TMP("TIUVDT",$J,+TIUX)) S TIUOK=^(+TIUX) Q
"RTN","TIUVSIT",97,0)
 I X'=+X!'$D(^TMP("TIUVN",$J,+X)) W !!,$C(7),"INVALID RESPONSE",! G BREAK
"RTN","TIUVSIT",98,0)
 S TIUOK=X
"RTN","TIUVSIT",99,0)
 Q
"RTN","TIUVSIT",100,0)
INOUT() ; Ask INPATIENT/OUTPATIENT
"RTN","TIUVSIT",101,0)
 N TIUPRMT S TIUPRMT="Is this note for INPATIENT or OUTPATIENT care? "
"RTN","TIUVSIT",102,0)
 W:'$D(^DPT(DFN,.1)) !!,"This patient is not currently admitted to the facility...",!
"RTN","TIUVSIT",103,0)
 Q $$READ^TIUU("SA^i:INPATIENT;o:OUTPATIENT",TIUPRMT,"OUTPATIENT")
"RTN","TIUVSIT",104,0)
MORE ; Modify date range, list more visits
"RTN","TIUVSIT",105,0)
 N TIUI,TIUCNT
"RTN","TIUVSIT",106,0)
 S TIUI=+$O(^TMP("TIUVDT",$J,0)),TIUCNT=+$G(^TMP("TIUVDT",$J,+TIUI))
"RTN","TIUVSIT",107,0)
 D GETAPPT^TIUVSIT1(DFN,$G(TIULOC),$G(TIUOCC),TIUI,TIUCNT,.TIULAST)
"RTN","TIUVSIT",108,0)
 Q
"RTN","TIUVSIT",109,0)
FUTURE ; Get future appointments
"RTN","TIUVSIT",110,0)
 D GETAPPT^TIUVSIT1(DFN,$G(TIULOC),$G(TIUOCC),$G(TIULDT),"",.TIULAST,$G(TIUVDT),1)
"RTN","TIUVSIT",111,0)
 I $P(+$G(^TMP("TIUVNI",$J,1)),".")'>+$$NOW^XLFDT D
"RTN","TIUVSIT",112,0)
 . W !!,"No Future Appointments found...",!
"RTN","TIUVSIT",113,0)
 E  I $P(+$G(^TMP("TIUVNI",$J,1)),".")'>$$FMADD^XLFDT(DT,1) D
"RTN","TIUVSIT",114,0)
 . W !!,"No Appointments found more than one day in future..."
"RTN","TIUVSIT",115,0)
 S TIUI=0,TIUFUTUR=1
"RTN","TIUVSIT",116,0)
 Q
"RTN","TIUVSIT",117,0)
GETVSIT(TIUOK) ; Get associated visit
"RTN","TIUVSIT",118,0)
 N APPT,TIUVSIT,VLOC,VSTOP,VDT,VTYPE
"RTN","TIUVSIT",119,0)
 S APPT=$G(^TMP("TIUVNI",$J,+TIUOK))
"RTN","TIUVSIT",120,0)
 S VDT=+APPT,VLOC=$P(APPT,U,2)
"RTN","TIUVSIT",121,0)
 S VSTOP=$P($G(^SC(+VLOC,0)),U,7)
"RTN","TIUVSIT",122,0)
 S VTYPE=$S($P(APPT,U,3)="I":"I",1:"A")
"RTN","TIUVSIT",123,0)
 S TIUVSIT=VLOC_";"_VDT_";"_VTYPE
"RTN","TIUVSIT",124,0)
 Q TIUVSIT
"RTN","TIUVSIT",125,0)
ADD(DFN,VSTR,ASK,VSTOP) ; Add a visit for patient
"RTN","TIUVSIT",126,0)
 N VTYPE,VDT,VLOC,TIUY,DA,DIE,DR,TIUAPDT,X,Y W !
"RTN","TIUVSIT",127,0)
 S ASK=$G(ASK,1)
"RTN","TIUVSIT",128,0)
 I +ASK D
"RTN","TIUVSIT",129,0)
 . W !,$C(7),$C(7),"Patient & Visit are Required...",!
"RTN","TIUVSIT",130,0)
 . S TIUY=$$READ^TIUU("YAO","Do you wish to add a NEW Visit? ","NO")
"RTN","TIUVSIT",131,0)
 I +ASK,(+TIUY'>0) S TIUX=0,TIUER=1 Q
"RTN","TIUVSIT",132,0)
 I $G(VLOC)']"" S VLOC=$$SELLOC
"RTN","TIUVSIT",133,0)
 I +VLOC'>0 S TIUER=1 Q
"RTN","TIUVSIT",134,0)
 S VSTOP=+$P(^SC(+VLOC,0),U,7)
"RTN","TIUVSIT",135,0)
 S VDT=+$$READ^TIUU("D^:NOW:ERSX","Enter Visit Date/Time","NOW","Precise Date & Time are Required")
"RTN","TIUVSIT",136,0)
 I +VDT'>0 S TIUER=1 Q
"RTN","TIUVSIT",137,0)
 S TIUAPDT=+$O(^TMP("TIUNOT",$J,+VLOC,+$P(VDT,".")))
"RTN","TIUVSIT",138,0)
 I +TIUAPDT>0,(+$P(TIUAPDT,".")=+$P(VDT,".")) D  Q
"RTN","TIUVSIT",139,0)
 . W !!,$C(7),"  Item #",+$G(^TMP("TIUNOT",$J,+VLOC,+TIUAPDT))
"RTN","TIUVSIT",140,0)
 . W " is scheduled for ",$$DATE^TIULS(TIUAPDT,"MM/DD/YY HR:MIN")
"RTN","TIUVSIT",141,0)
 . W " at this location..."
"RTN","TIUVSIT",142,0)
 . W !!,"Please select the existing appointment, rather than creating a "
"RTN","TIUVSIT",143,0)
 . W "redundant one.",!
"RTN","TIUVSIT",144,0)
 . S TIUER=1
"RTN","TIUVSIT",145,0)
 S VTYPE=$$VSITYPE(VSTOP)
"RTN","TIUVSIT",146,0)
 S VSTR=+VLOC_";"_+VDT_";"_VTYPE
"RTN","TIUVSIT",147,0)
 I +VSTR'>0 S TIUER=1 Q
"RTN","TIUVSIT",148,0)
 S TIUNVIS=+VDT,TIUER=0
"RTN","TIUVSIT",149,0)
 Q
"RTN","TIUVSIT",150,0)
WRITE ; Writes each list element
"RTN","TIUVSIT",151,0)
 N TIUX S TIUX=^TMP("TIUVN",$J,TIUI)
"RTN","TIUVSIT",152,0)
 W !,$J(TIUII,4),">  ",$P(TIUX,U),?27,$E($P(TIUX,U,3),1,21),?50,$P(TIUX,U,2)
"RTN","TIUVSIT",153,0)
 Q
"RTN","TIUVSIT",154,0)
SELLOC() ; Select Hospital Location
"RTN","TIUVSIT",155,0)
 N DIC,X,Y,TIUAPDT S DIC=44,DIC(0)="AEMQ"
"RTN","TIUVSIT",156,0)
 S DIC("A")="PATIENT LOCATION: "
"RTN","TIUVSIT",157,0)
 S DIC("B")=$P($$PERSLOC^TIULE(DUZ),U,2)
"RTN","TIUVSIT",158,0)
 S:DIC("B")']"" DIC("B")=$P($G(^SC(+$G(^DISV(DUZ,"^SC(")),0)),U)
"RTN","TIUVSIT",159,0)
 S DIC("S")="I $$GOODLOC^TIUPREF(Y)"
"RTN","TIUVSIT",160,0)
 D ^DIC K DIC("S")
"RTN","TIUVSIT",161,0)
 Q Y
"RTN","TIUVSIT",162,0)
DEFER(DA,TIUSDC) ; Mark record for deferred crediting of stop code
"RTN","TIUVSIT",163,0)
 N DIE,DR,X,Y,TIUVSIT
"RTN","TIUVSIT",164,0)
 I +$G(TIUSDC)'>0 Q
"RTN","TIUVSIT",165,0)
 S DIE=8925
"RTN","TIUVSIT",166,0)
 S:$$WORKOK^TIUPXAP1(+DA) DR=".11////1;"
"RTN","TIUVSIT",167,0)
 S DR=$G(DR)_"1206////^S X="_+TIUSDC
"RTN","TIUVSIT",168,0)
 D ^DIE
"RTN","TIUVSIT",169,0)
 ;If not called via the broker try to link document to an existing visit
"RTN","TIUVSIT",170,0)
 I '$$BROKER^XWBLIB,$$LNKVST^TIUPXAP3(+DA,.TIUVSIT)
"RTN","TIUVSIT",171,0)
 Q
"RTN","TIUVSIT",172,0)
CREDIT(TIUDA) ; Call EN3^SDACS to Credit Stop Code
"RTN","TIUVSIT",173,0)
 N DA,DFN,VSIT,TIU,TIUD0,TIUDPRM
"RTN","TIUVSIT",174,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0))
"RTN","TIUVSIT",175,0)
 I TIUD0']"" Q
"RTN","TIUVSIT",176,0)
 D DOCPRM^TIULC1(+TIUD0,.TIUDPRM)
"RTN","TIUVSIT",177,0)
 ; If SUPPRESS DX/CPT ON NEW VISIT is set to YES, then Quit
"RTN","TIUVSIT",178,0)
 I +$P($G(TIUDPRM(0)),U,14)>0 Q
"RTN","TIUVSIT",179,0)
 S DFN=+$P(TIUD0,U,2),VSIT=$P(TIUD0,U,3)
"RTN","TIUVSIT",180,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUVSIT",181,0)
 D CREDIT^TIUPXAPI(DFN,.TIU,VSIT)
"RTN","TIUVSIT",182,0)
 Q
"RTN","TIUVSIT",183,0)
REMFLAG(DA) ; Remove credit flag from TIU Document Record
"RTN","TIUVSIT",184,0)
 N DIE,DR,X,Y
"RTN","TIUVSIT",185,0)
 S DIE=8925,DR=".11///@" D ^DIE
"RTN","TIUVSIT",186,0)
 Q
"RTN","TIUVSIT",187,0)
VSITYPE(VSTOP) ; Call reader to get VISIT TYPE
"RTN","TIUVSIT",188,0)
 N DFLT,PROMPT,X,Y S VSTOP=$P($G(^DIC(40.7,+$G(VSTOP),0)),U)
"RTN","TIUVSIT",189,0)
 S DFLT=$S(VSTOP["TELE":"TELEPHONE",1:"AMBULATORY")
"RTN","TIUVSIT",190,0)
 S PROMPT="TYPE OF VISIT: "
"RTN","TIUVSIT",191,0)
 S X="SMA^a:AMBULATORY (WALK-IN);t:TELEPHONE;i:IN HOSPITAL;e:EVENT (HISTORICAL)"
"RTN","TIUVSIT",192,0)
 S Y=$$READ^TIUU(X,PROMPT,DFLT) W "   ",$P(Y,U,2),!
"RTN","TIUVSIT",193,0)
 S Y=$$UP^XLFSTR($P(Y,U))
"RTN","TIUVSIT",194,0)
 Q Y
"RTN","TIUVSIT",195,0)
GETAPPT(DFN,CLINIC,OCCLIM,INDEX,COUNT,LAST,EARLY,FUTURE) ; Get list
"RTN","TIUVSIT",196,0)
 D GETAPPT^TIUVSIT1($G(DFN),$G(CLINIC),$G(OCCLIM),$G(INDEX),$G(COUNT),$G(LAST),$G(EARLY),$G(FUTURE))
"RTN","TIUVSIT",197,0)
 Q
"RTN","TIUVSIT1")
0^6^B10115199
"RTN","TIUVSIT1",1,0)
TIUVSIT1 ; SLC/JER - Visit look-up (cont'd) ;4/29/99@11:51:42 [8/9/04 8:16am]
"RTN","TIUVSIT1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**39,179**;Jun 20, 1997
"RTN","TIUVSIT1",3,0)
NOTFOUND() ; Ask <U>NSCHEDULED or <F>UTURE
"RTN","TIUVSIT1",4,0)
 N TIUY
"RTN","TIUVSIT1",5,0)
 W !,"CHOOSE <U>NSCHEDULED VISITS, <F>UTURE VISITS, or <N>EW VISIT"
"RTN","TIUVSIT1",6,0)
 W !,"<RETURN> TO CONTINUE"
"RTN","TIUVSIT1",7,0)
 S TIUY=$$READ^TIUU("FOA","OR '^' TO QUIT: ","","^D HELP^TIUVSITH(""?"")")
"RTN","TIUVSIT1",8,0)
 Q TIUY
"RTN","TIUVSIT1",9,0)
GETAPPT(DFN,CLINIC,OCCLIM,INDEX,COUNT,LAST,EARLY,FUTURE) ; Get list
"RTN","TIUVSIT1",10,0)
 ; of appointments
"RTN","TIUVSIT1",11,0)
 N TIUCNT,TIUI,TIUSREC,TIUJ,TIUFLIM,TIUARRAY,LATE,TIUK,TIUNUM
"RTN","TIUVSIT1",12,0)
 I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIUVSIT1",13,0)
 S TIUFLIM=$S(+$P(TIUPRM0,U,14)>0&+$G(FUTURE):$P(TIUPRM0,U,14),1:1)
"RTN","TIUVSIT1",14,0)
 S OCCLIM=$S(+$G(OCCLIM):+$G(OCCLIM),1:20)
"RTN","TIUVSIT1",15,0)
 S:'+$G(DT) DT=$$DT^XLFDT
"RTN","TIUVSIT1",16,0)
 S EARLY=+$G(EARLY)
"RTN","TIUVSIT1",17,0)
 S LATE=$S(+$G(INDEX):+$G(INDEX),1:$$FMADD^XLFDT(DT,TIUFLIM)_"."_235959)
"RTN","TIUVSIT1",18,0)
 S (LAST,TIUCNT,TIUK)=0,TIUJ=$S(+$G(COUNT):+$G(COUNT),1:0)
"RTN","TIUVSIT1",19,0)
 S TIUARRAY(1)=EARLY_";"_LATE
"RTN","TIUVSIT1",20,0)
 I $G(EARLY)=0 S TIUARRAY(1)=";"_LATE
"RTN","TIUVSIT1",21,0)
 S TIUARRAY(4)=DFN
"RTN","TIUVSIT1",22,0)
 S TIUARRAY("SORT")="P"
"RTN","TIUVSIT1",23,0)
 S TIUARRAY("FLDS")="1;2;3;10;12;22"
"RTN","TIUVSIT1",24,0)
 S TIUNUM=$$SDAPI^SDAMA301(.TIUARRAY) Q:'TIUNUM
"RTN","TIUVSIT1",25,0)
 S TIUI=LATE+.000001
"RTN","TIUVSIT1",26,0)
 I TIUNUM=-1 D  Q
"RTN","TIUVSIT1",27,0)
 . S ^TMP("TIUVERR",$J)="Could not retrieve patient information due to database issues."
"RTN","TIUVSIT1",28,0)
 . I $D(^TMP($J,"SDAMA301",115)) S ^TMP("TIUVERR",$J,115)="This patient may not have an assigned ICN."
"RTN","TIUVSIT1",29,0)
 F  S TIUI=$O(^TMP($J,"SDAMA301",DFN,TIUI),-1) S:+TIUI'>0 LAST=1 Q:+TIUI'>0!(+TIUCNT'<OCCLIM)!(+TIUI<EARLY)  D
"RTN","TIUVSIT1",30,0)
 . N APPTDT,APPTCL,APPTST,APPTTY,OPENC,STATUS
"RTN","TIUVSIT1",31,0)
 . S TIUCNT=+$G(TIUCNT)+1,TIUJ=+$G(TIUJ)+1
"RTN","TIUVSIT1",32,0)
 . S APPTCL=$P(^TMP($J,"SDAMA301",DFN,TIUI),U,2)
"RTN","TIUVSIT1",33,0)
 . S APPTST=$P(^TMP($J,"SDAMA301",DFN,TIUI),U,3)
"RTN","TIUVSIT1",34,0)
 . S APPTTY=$P(^TMP($J,"SDAMA301",DFN,TIUI),U,10)
"RTN","TIUVSIT1",35,0)
 . S OPENC=$P(^TMP($J,"SDAMA301",DFN,TIUI),U,12)
"RTN","TIUVSIT1",36,0)
 . S STATUS=$P(^TMP($J,"SDAMA301",DFN,TIUI),U,22)
"RTN","TIUVSIT1",37,0)
 . I +$G(CLINIC),(+APPTCL'=+CLINIC) Q
"RTN","TIUVSIT1",38,0)
 . ;Set up internal value array
"RTN","TIUVSIT1",39,0)
 . S ^TMP("TIUVNI",$J,TIUJ)=TIUI_U_+APPTCL
"RTN","TIUVSIT1",40,0)
 . I $P(APPTST,";")="R" S ^TMP("TIUVNI",$J,TIUJ)=^TMP("TIUVNI",$J,TIUJ)_U
"RTN","TIUVSIT1",41,0)
 . I $P(APPTST,";")'="R" S ^TMP("TIUVNI",$J,TIUJ)=^TMP("TIUVNI",$J,TIUJ)_U_$P(APPTST,";")
"RTN","TIUVSIT1",42,0)
 . S ^TMP("TIUVNI",$J,TIUJ)=^TMP("TIUVNI",$J,TIUJ)_U_+APPTTY
"RTN","TIUVSIT1",43,0)
 . S ^TMP("TIUVNI",$J,TIUJ)=^TMP("TIUVNI",$J,TIUJ)_U_$G(OPENC)
"RTN","TIUVSIT1",44,0)
 . ;Set up external value array
"RTN","TIUVSIT1",45,0)
 . S ^TMP("TIUVN",$J,TIUJ)=$$DATE^TIULS(TIUI,"AMTH DD, CCYY@HR:MIN")
"RTN","TIUVSIT1",46,0)
 . S ^TMP("TIUVN",$J,TIUJ)=^TMP("TIUVN",$J,TIUJ)_U_$P(APPTCL,";",2)
"RTN","TIUVSIT1",47,0)
 . S ^TMP("TIUVN",$J,TIUJ)=^TMP("TIUVN",$J,TIUJ)_U_$P(STATUS,";",3)
"RTN","TIUVSIT1",48,0)
 . S ^TMP("TIUVN",$J,TIUJ)=^TMP("TIUVN",$J,TIUJ)_U_$P(APPTTY,";",2)
"RTN","TIUVSIT1",49,0)
 . ;Set up index by date
"RTN","TIUVSIT1",50,0)
 . S ^TMP("TIUVDT",$J,TIUI)=TIUJ
"RTN","TIUVSIT1",51,0)
 . ;Set up array of appts to exclude dup visit creation if appt is for today
"RTN","TIUVSIT1",52,0)
 . I $P(APPTST,";")="R" S ^TMP("TIUNOT",$J,+$P($G(^TMP($J,"SDAMA301",DFN,TIUI)),U,2),+TIUI)=TIUJ
"RTN","TIUVSIT1",53,0)
 K ^TMP($J,"SDAMA301")
"RTN","TIUVSIT1",54,0)
 Q
"VER")
8.0^22.0
**END**
**END**
