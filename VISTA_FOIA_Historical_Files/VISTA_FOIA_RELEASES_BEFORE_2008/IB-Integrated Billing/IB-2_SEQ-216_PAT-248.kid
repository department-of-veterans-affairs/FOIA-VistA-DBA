EMERGENCY Released IB*2*248 SEQ #216
Extracted from mail message
**KIDS**:IB*2.0*248^

**INSTALL NAME**
IB*2.0*248
"BLD",5132,0)
IB*2.0*248^INTEGRATED BILLING^0^3031024^y
"BLD",5132,1,0)
^^6^6^3031023^^^
"BLD",5132,1,1,0)
This patch corrects the unbilled amounts report from generating
"BLD",5132,1,2,0)
again on the first of the month with the other DM reports.  It also
"BLD",5132,1,3,0)
corrects the IBT RE-GENERATE UNBILLED AMOUNTS REPORT.  The end date for
"BLD",5132,1,4,0)
the report for months prior to September 2003 will display as the last day
"BLD",5132,1,5,0)
of the calendar month.  Those months after September 2003 will use the
"BLD",5132,1,6,0)
EOAM date for that month.
"BLD",5132,4,0)
^9.64PA^^
"BLD",5132,"ABPKG")
n
"BLD",5132,"INI")
IB20P248
"BLD",5132,"INID")
^^y
"BLD",5132,"KRN",0)
^9.67PA^8989.52^19
"BLD",5132,"KRN",.4,0)
.4
"BLD",5132,"KRN",.401,0)
.401
"BLD",5132,"KRN",.402,0)
.402
"BLD",5132,"KRN",.403,0)
.403
"BLD",5132,"KRN",.5,0)
.5
"BLD",5132,"KRN",.84,0)
.84
"BLD",5132,"KRN",3.6,0)
3.6
"BLD",5132,"KRN",3.8,0)
3.8
"BLD",5132,"KRN",9.2,0)
9.2
"BLD",5132,"KRN",9.8,0)
9.8
"BLD",5132,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",5132,"KRN",9.8,"NM",1,0)
IBTUBO^^0^B24340382
"BLD",5132,"KRN",9.8,"NM",2,0)
IBJDE^^0^B23377946
"BLD",5132,"KRN",9.8,"NM",3,0)
IB20P248^^0^B5032059
"BLD",5132,"KRN",9.8,"NM","B","IB20P248",3)

"BLD",5132,"KRN",9.8,"NM","B","IBJDE",2)

"BLD",5132,"KRN",9.8,"NM","B","IBTUBO",1)

"BLD",5132,"KRN",19,0)
19
"BLD",5132,"KRN",19,"NM",0)
^9.68A^^
"BLD",5132,"KRN",19.1,0)
19.1
"BLD",5132,"KRN",101,0)
101
"BLD",5132,"KRN",409.61,0)
409.61
"BLD",5132,"KRN",771,0)
771
"BLD",5132,"KRN",870,0)
870
"BLD",5132,"KRN",8989.51,0)
8989.51
"BLD",5132,"KRN",8989.52,0)
8989.52
"BLD",5132,"KRN",8994,0)
8994
"BLD",5132,"KRN","B",.4,.4)

"BLD",5132,"KRN","B",.401,.401)

"BLD",5132,"KRN","B",.402,.402)

"BLD",5132,"KRN","B",.403,.403)

"BLD",5132,"KRN","B",.5,.5)

"BLD",5132,"KRN","B",.84,.84)

"BLD",5132,"KRN","B",3.6,3.6)

"BLD",5132,"KRN","B",3.8,3.8)

"BLD",5132,"KRN","B",9.2,9.2)

"BLD",5132,"KRN","B",9.8,9.8)

"BLD",5132,"KRN","B",19,19)

"BLD",5132,"KRN","B",19.1,19.1)

"BLD",5132,"KRN","B",101,101)

"BLD",5132,"KRN","B",409.61,409.61)

"BLD",5132,"KRN","B",771,771)

"BLD",5132,"KRN","B",870,870)

"BLD",5132,"KRN","B",8989.51,8989.51)

"BLD",5132,"KRN","B",8989.52,8989.52)

"BLD",5132,"KRN","B",8994,8994)

"BLD",5132,"QUES",0)
^9.62^^
"BLD",5132,"REQB",0)
^9.611^1^1
"BLD",5132,"REQB",1,0)
IB*2.0*235^1
"BLD",5132,"REQB","B","IB*2.0*235",1)

"INI")
IB20P248
"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
248^3031024
"PKG",200,22,1,"PAH",1,1,0)
^^6^6^3031024
"PKG",200,22,1,"PAH",1,1,1,0)
This patch corrects the unbilled amounts report from generating
"PKG",200,22,1,"PAH",1,1,2,0)
again on the first of the month with the other DM reports.  It also
"PKG",200,22,1,"PAH",1,1,3,0)
corrects the IBT RE-GENERATE UNBILLED AMOUNTS REPORT.  The end date for
"PKG",200,22,1,"PAH",1,1,4,0)
the report for months prior to September 2003 will display as the last day
"PKG",200,22,1,"PAH",1,1,5,0)
of the calendar month.  Those months after September 2003 will use the
"PKG",200,22,1,"PAH",1,1,6,0)
EOAM date for that month.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","IB20P248")
0^3^B5032059
"RTN","IB20P248",1,0)
IB20P248 ;ALB/MAF - PRE-INIT FOR PATCH IB*2.0*248 - OCT 15, 2003
"RTN","IB20P248",2,0)
 ;;2.0;INTEGRATED BILLING;**248**;21-MAR-94
"RTN","IB20P248",3,0)
 ; Check to see if the unbilled report was run for the month of Oct.2003.
"RTN","IB20P248",4,0)
 ; if so, we need to delete it from the file so it will run correctly 
"RTN","IB20P248",5,0)
 ; for the month of Oct. 2003.
"RTN","IB20P248",6,0)
 I DT>3031028 D  G END
"RTN","IB20P248",7,0)
 .D MES^XPDUTL("** WARNING....clean up will delete more data than")
"RTN","IB20P248",8,0)
 .D MES^XPDUTL("** was intended.  Clean up aborted.")
"RTN","IB20P248",9,0)
 I DT'>$$LDATE(DT) D
"RTN","IB20P248",10,0)
 .N IBFLG S IBFLG=0
"RTN","IB20P248",11,0)
 .I '$D(^IBE(351.71,3031000)) D
"RTN","IB20P248",12,0)
 ..D MES^XPDUTL("** Clean up of file IB DM EXTRACT DATA (#351.71) not needed.")
"RTN","IB20P248",13,0)
 .I '$D(^IBE(356.19,3031000)) D
"RTN","IB20P248",14,0)
 ..D MES^XPDUTL("** Clean up of file CLAIMS TRACKING UNBILLED AMOUNTS (#356.19) not needed.")
"RTN","IB20P248",15,0)
 .I $D(^IBE(351.71,3031000)) D
"RTN","IB20P248",16,0)
 ..D MES^XPDUTL("** Cleaning up file IB DM EXTRACT DATA (#351.71)")
"RTN","IB20P248",17,0)
 ..S DIK="^IBE(351.71,",DA=3031000 D ^DIK
"RTN","IB20P248",18,0)
 ..S IBFLG=1
"RTN","IB20P248",19,0)
 ..K DA,DIK
"RTN","IB20P248",20,0)
 ..Q
"RTN","IB20P248",21,0)
 .I $D(^IBE(356.19,3031000,0)) D
"RTN","IB20P248",22,0)
 ..D MES^XPDUTL("** Cleaning up file CLAIMS TRACKING UNBILLED AMOUNTS (#356.19)")
"RTN","IB20P248",23,0)
 ..S DIK="^IBE(356.19,",DA=3031000 D ^DIK
"RTN","IB20P248",24,0)
 ..S IBFLG=1
"RTN","IB20P248",25,0)
 ..K DA,DIK
"RTN","IB20P248",26,0)
 ..Q
"RTN","IB20P248",27,0)
 .I IBFLG D
"RTN","IB20P248",28,0)
 ..D MES^XPDUTL("** Your site showed that the Unbilled Amounts Report")
"RTN","IB20P248",29,0)
 ..D MES^XPDUTL("** ran unexpectedly for the month of October 2003.")
"RTN","IB20P248",30,0)
 ..D MES^XPDUTL("** This data was incorrect and needed to be deleted")
"RTN","IB20P248",31,0)
 ..D MES^XPDUTL("** from your site before the generation of this")
"RTN","IB20P248",32,0)
 ..D MES^XPDUTL("** report again on October 29th 2003")
"RTN","IB20P248",33,0)
 ..D MES^XPDUTL(" ")
"RTN","IB20P248",34,0)
 ..D MES^XPDUTL("** October 2003 data has been successfully deleted")
"RTN","IB20P248",35,0)
 ..Q
"RTN","IB20P248",36,0)
 .Q
"RTN","IB20P248",37,0)
END K X Q
"RTN","IB20P248",38,0)
LDATE(X) ; DETERMINE CUT-OFF DATE FOR THE MONTH
"RTN","IB20P248",39,0)
 S X=$E(X,1,5)_$P("31^28^31^30^31^30^31^31^30^31^30^31","^",+$E(X,4,5))
"RTN","IB20P248",40,0)
 I +$E(X,6,7)=28,$E(X,2,3)#4=0 S $E(X,6,7)=29
"RTN","IB20P248",41,0)
 S X=$$WORKPLUS^XUWORKDY(X,-3)
"RTN","IB20P248",42,0)
 Q X
"RTN","IBJDE")
0^2^B23377946
"RTN","IBJDE",1,0)
IBJDE ;ALB/RB - DM DATA EXTRACTION (MAIN ROUTINE) ; 15-APR-99
"RTN","IBJDE",2,0)
 ;;2.0;INTEGRATED BILLING;**100,118,123,235,248**;21-MAR-94
"RTN","IBJDE",3,0)
 ;
"RTN","IBJDE",4,0)
BJ ; - Entry point from IBAMTC.
"RTN","IBJDE",5,0)
 I $D(^IBE(351.7,"DISABLE")) G ENQ ; DM extraction process disabled.
"RTN","IBJDE",6,0)
 ;
"RTN","IBJDE",7,0)
 I $E(DT,6,7)=$E($$LDATE(DT)+1,6,7) S IBDT=$E($P($$M1(DT,0),"^",1),1,5)_"00"
"RTN","IBJDE",8,0)
 I '$G(IBDT) S IBDT=$$M1(DT,1)
"RTN","IBJDE",9,0)
 I $D(^IBE(351.71,"AC",3,IBDT)) G ENQ ; Extract done for this date.
"RTN","IBJDE",10,0)
 ;
"RTN","IBJDE",11,0)
 D NOW^%DTC S IBRD=%,IBS=$P(%H,",",2)
"RTN","IBJDE",12,0)
 I $D(^IBE(351.71,IBDT,0)) D  G ST ; Entry for this date already made.
"RTN","IBJDE",13,0)
 .S DIE="^IBE(351.71,",DR=".02////1;.03////"_IBRD,DA=IBDT D ^DIE
"RTN","IBJDE",14,0)
 .K DA,DIE,DR
"RTN","IBJDE",15,0)
 ;
"RTN","IBJDE",16,0)
 ; - Create entry in IB DM EXTRACT DATA ELEMENTS file (#351.71).
"RTN","IBJDE",17,0)
 S DIC="^IBE(351.71,",DIC(0)="L",DIC("DR")=".02////1;.03////"_IBRD
"RTN","IBJDE",18,0)
 S (DINUM,X)=IBDT K DD,DO D FILE^DICN K DIC,DINUM,DD,DO S IBDT=+Y
"RTN","IBJDE",19,0)
 ;
"RTN","IBJDE",20,0)
ST ; - Start extraction process.
"RTN","IBJDE",21,0)
 I '$$CHK(IBDT) G COMP ; If data from all reports extracted, E-mail file.
"RTN","IBJDE",22,0)
 ;
"RTN","IBJDE",23,0)
 I $E(DT,6,7)=$E($$LDATE(DT)+1,6,7) S IBA0=$O(^IBE(351.7,"B","UNBILLED AMOUNTS REPORT",0)) G:'IBA0 ENQ  S IBN0=^IBE(351.7,IBA0,0) D EXTRACT G ENQ
"RTN","IBJDE",24,0)
 S IBA0=0 F  S IBA0=$O(^IBE(351.7,IBA0)) Q:'IBA0  S IBN0=^(IBA0,0) I $P(IBN0,"^",1)'="UNBILLED AMOUNTS REPORT" D EXTRACT
"RTN","IBJDE",25,0)
 G ENQ
"RTN","IBJDE",26,0)
 ;
"RTN","IBJDE",27,0)
EXTRACT I $P(IBN0,U,2) Q  ;                      Report has been disabled.
"RTN","IBJDE",28,0)
 I $D(^IBE(351.71,"AD",3,IBDT,IBA0)) Q  ; Extract of report done.
"RTN","IBJDE",29,0)
 ;
"RTN","IBJDE",30,0)
 I '$D(^IBE(351.71,IBDT,1,IBA0,0)) D  ; Create REPORT sub-file entry.
"RTN","IBJDE",31,0)
 .S DIC="^IBE(351.71,"_IBDT_",1,",DIC(0)="L",DIC("DR")=".02////1"
"RTN","IBJDE",32,0)
 .S DIC("P")="351.711P",DA(1)=IBDT,(DA,DINUM,X)=IBA0 K DD,DO
"RTN","IBJDE",33,0)
 .D FILE^DICN K DA,DIC,DINUM,DD,DO
"RTN","IBJDE",34,0)
 ;
"RTN","IBJDE",35,0)
 ; - Set input variables.
"RTN","IBJDE",36,0)
 S IBA1=0 N ZTIO,ZTDESC,ZTSK,ZTDTH,ZTRTN,ZTSAVE
"RTN","IBJDE",37,0)
 F  S IBA1=$O(^IBE(351.7,IBA0,1,IBA1)) Q:'IBA1  S IBN1=$G(^(IBA1,0)) D
"RTN","IBJDE",38,0)
 .I $D(^IBE(351.7,IBA0,1,IBA1,1)) X ^(1)
"RTN","IBJDE",39,0)
 .E  S IBV=$P(IBN1,U),@(IBV)=$P(IBN1,U,2),ZTSAVE(IBV)=""
"RTN","IBJDE",40,0)
 ;
"RTN","IBJDE",41,0)
 ; - Set other ZT* variables for queueing.
"RTN","IBJDE",42,0)
 S ZTDESC=$P(IBN0,U),ZTSAVE("IBXTRACT")=1,ZTIO=""
"RTN","IBJDE",43,0)
 I $G(IBX) S ZTSAVE("IBXDATE")=IBDT ; Date from DME manual start option.
"RTN","IBJDE",44,0)
 S ZTRTN=$G(^IBE(351.7,IBA0,2)) Q:ZTRTN=""  I ZTRTN'["^" S ZTRTN=U_ZTRTN
"RTN","IBJDE",45,0)
 S IBS=IBS+300,%=IBS D S^%DTC S ZTDTH=$P(IBRD,".")_% ; Run in 5 mins.
"RTN","IBJDE",46,0)
 D ^%ZTLOAD
"RTN","IBJDE",47,0)
 Q
"RTN","IBJDE",48,0)
 ;
"RTN","IBJDE",49,0)
 ;
"RTN","IBJDE",50,0)
E(RI,J) ; - Change report extract status/load DM summary report data.
"RTN","IBJDE",51,0)
 ;   Input: RI=Report IEN from IB DM EXTRACT REPORTS file (#351.7).
"RTN","IBJDE",52,0)
 ;           J=1-Change status, 0=Load DM data
"RTN","IBJDE",53,0)
 S IBDT=$S($G(IBXDATE):IBXDATE,1:$$M1(DT,1)) I 'J G E1
"RTN","IBJDE",54,0)
 ;
"RTN","IBJDE",55,0)
 I '$D(^IBE(351.71,"AC",2,IBDT)) D  ; Change extract status to STARTED.
"RTN","IBJDE",56,0)
 .D NOW^%DTC S DIE="^IBE(351.71,",DR=".02////2;.03////"_%,DA=IBDT D ^DIE
"RTN","IBJDE",57,0)
 .K DA,DIE,DR
"RTN","IBJDE",58,0)
 ;
"RTN","IBJDE",59,0)
 ; - Change report extract status to EXTRACT STARTED.
"RTN","IBJDE",60,0)
 I '$D(^IBE(351.71,"AD",2,IBDT,RI)) D
"RTN","IBJDE",61,0)
 .D NOW^%DTC S DIE="^IBE(351.71,"_IBDT_",1,",DR=".02////2;.03////"_%
"RTN","IBJDE",62,0)
 .S DA(1)=IBDT,DA=RI D ^DIE K DA,DIE,DR
"RTN","IBJDE",63,0)
 ;
"RTN","IBJDE",64,0)
 G ENQ
"RTN","IBJDE",65,0)
 ;
"RTN","IBJDE",66,0)
E1 ; - Load DM summary report data into file #351.71.
"RTN","IBJDE",67,0)
 S IBA0=0 F  S IBA0=$O(^IBE(351.701,"C",RI,IBA0)) Q:'IBA0  D
"RTN","IBJDE",68,0)
 .S IBN0=$P($G(^IBE(351.701,IBA0,0)),U,2) Q:IBN0=""  S IBN0=@(IBN0)
"RTN","IBJDE",69,0)
 .;
"RTN","IBJDE",70,0)
 .; - Create DATA ELEMENT sub-file entry in REPORT sub-file of #351.71
"RTN","IBJDE",71,0)
 .S DIC="^IBE(351.71,"_IBDT_",1,"_RI_",1,",DIC(0)="L"
"RTN","IBJDE",72,0)
 .S DIC("DR")=".02////"_IBN0,DIC("P")="351.7111P",DA(2)=IBDT,DA(1)=RI
"RTN","IBJDE",73,0)
 .S (DA,DINUM,X)=IBA0 K DD,DO D FILE^DICN K DA,DIC,DINUM,DD,DO
"RTN","IBJDE",74,0)
 ;
"RTN","IBJDE",75,0)
 ; - Change status in REPORT sub-file of #351.71 to EXTRACT COMPLETED.
"RTN","IBJDE",76,0)
 D NOW^%DTC S DIE="^IBE(351.71,"_IBDT_",1,",DR=".02////3;.04////"_%
"RTN","IBJDE",77,0)
 S DA(1)=IBDT,DA=RI D ^DIE K DA,DIE,DR,IBXDATE,IBXTRACT
"RTN","IBJDE",78,0)
 ;
"RTN","IBJDE",79,0)
 ; - Check if all data from all reports have been extracted, then change
"RTN","IBJDE",80,0)
 ;   status in file #351.71 entry to EXTRACT COMPLETED.
"RTN","IBJDE",81,0)
 I $$CHK(IBDT) G ENQ ; All reports not completed yet.
"RTN","IBJDE",82,0)
 ;
"RTN","IBJDE",83,0)
COMP D NOW^%DTC
"RTN","IBJDE",84,0)
 S DIE="^IBE(351.71,",DR=".02////3;.04////"_%,DA=IBDT D ^DIE K DA,DIE,DR
"RTN","IBJDE",85,0)
 I '$P(^IBE(351.71,IBDT,0),U,5) D XM^IBJDE1(IBDT) ; Transmit extract.
"RTN","IBJDE",86,0)
 ;
"RTN","IBJDE",87,0)
ENQ I '$G(IBX) K IBDT
"RTN","IBJDE",88,0)
 K IBA0,IBA1,IBCT,IBN0,IBN1,IBRD,IBS,IBV,IBV1,X,Y,%
"RTN","IBJDE",89,0)
 Q
"RTN","IBJDE",90,0)
 ;
"RTN","IBJDE",91,0)
M1(X,Y) ; - Return first/last day of month (if Y=0), previous month (if Y=1),
"RTN","IBJDE",92,0)
 ;   first/last day of month in MMDDYYYY format (if Y=2), or date in
"RTN","IBJDE",93,0)
 ;   external format (if Y=3).
"RTN","IBJDE",94,0)
 N X1,X2 S:'$G(X)!(X'?7N.1".".6N) X=DT S:'$G(Y) Y=0
"RTN","IBJDE",95,0)
 S X2="31^"_$S($E(X,1,3)#4=0:29,1:28)_"^31^30^31^30^31^31^30^31^30^31"
"RTN","IBJDE",96,0)
 I 'Y S X=$E(X,1,5),X=X_"01"_U_X_$P(X2,U,+$E(X,4,5)) G M1Q
"RTN","IBJDE",97,0)
 I Y=1 S X=($E(X,1,5)_"00")-$S(+$E(X,4,5)=1:8900,1:100) G M1Q
"RTN","IBJDE",98,0)
 I Y=2 D  G M1Q
"RTN","IBJDE",99,0)
 .S X1=1700+$E(X,1,3),X=$E(X,4,5),X=X_"01"_X1_U_X_$P(X2,U,+X)_X1
"RTN","IBJDE",100,0)
 S Y=X X ^DD("DD") S X=Y
"RTN","IBJDE",101,0)
M1Q Q X
"RTN","IBJDE",102,0)
 ;
"RTN","IBJDE",103,0)
M2(X,Y,Z,R) ; - Return specific date range.
"RTN","IBJDE",104,0)
 ; Input: X=Date in Fileman format
"RTN","IBJDE",105,0)
 ;        Y=Number of months back from X
"RTN","IBJDE",106,0)
 ;        Z=Number of months ahead from date created via Y
"RTN","IBJDE",107,0)
 ;        R=0-Date range in Fileman format, 1-In MMDDYYYY format 
"RTN","IBJDE",108,0)
 N X1,X2
"RTN","IBJDE",109,0)
 S:'$G(X) X=DT S:'$G(Y) Y=1 S:'$G(Z) Z=1 S:'$G(R) R=0 I X'?7N S X=DT
"RTN","IBJDE",110,0)
 S X=$E(X,1,5)
"RTN","IBJDE",111,0)
 S X1="31^"_$S($E(X,1,3)#4=0:29,1:28)_"^31^30^31^30^31^31^30^31^30^31"
"RTN","IBJDE",112,0)
 F X2=1:1:Y S X=X-$S(+$E(X,4,5)=1:89,1:1) I X2=Y S X3=X_"01"
"RTN","IBJDE",113,0)
 F X2=1:1:Z S X=X+$S(+$E(X,4,5)=12:89,1:1)
"RTN","IBJDE",114,0)
 S X=X3_U_X_$P(X1,U,+$E(X,4,5)) I 'R G M2Q
"RTN","IBJDE",115,0)
 S X1=1700+$E(X,1,3),X2=1700+$E(X,9,11),X=$E(X,4,7)_X1_U_$E(X,12,15)_X2
"RTN","IBJDE",116,0)
M2Q Q X
"RTN","IBJDE",117,0)
 ;
"RTN","IBJDE",118,0)
M3(X) ;Beginning date 365 days prior
"RTN","IBJDE",119,0)
 N X1,X2
"RTN","IBJDE",120,0)
 S X1=X,X2=-365 D C^%DTC
"RTN","IBJDE",121,0)
 Q X
"RTN","IBJDE",122,0)
CHK(X) ; - Check if all extract reports have completed.
"RTN","IBJDE",123,0)
 ;    Input: X=Date IEN of entry in file #351.71
"RTN","IBJDE",124,0)
 ;   Output: Y=0-Completed, 1-Not completed
"RTN","IBJDE",125,0)
 N X1,X2,X3 S (X1,X2,X3,Y)=0
"RTN","IBJDE",126,0)
 F  S X1=$O(^IBE(351.7,X1)) Q:'X1  I '$P(^(X1,0),U,2) S X2=X2+1
"RTN","IBJDE",127,0)
 S X1=0 F  S X1=$O(^IBE(351.71,"AD",3,X,X1)) Q:'X1  S X3=X3+1
"RTN","IBJDE",128,0)
 I X2'=X3 S Y=1
"RTN","IBJDE",129,0)
 Q Y
"RTN","IBJDE",130,0)
LDATE(X) ; DETERMINE CUT-OFF DATE FOR THE MONTH
"RTN","IBJDE",131,0)
 S X=$E(X,1,5)_$P("31^28^31^30^31^30^31^31^30^31^30^31","^",+$E(X,4,5))
"RTN","IBJDE",132,0)
 I +$E(X,6,7)=28,$E(X,2,3)#4=0 S $E(X,6,7)=29
"RTN","IBJDE",133,0)
 S X=$$WORKPLUS^XUWORKDY(X,-3)
"RTN","IBJDE",134,0)
 Q X
"RTN","IBTUBO")
0^1^B24340382
"RTN","IBTUBO",1,0)
IBTUBO ;ALB/AAS - UNBILLED AMOUNTS - GENERATE UNBILLED REPORTS ;29-SEP-94
"RTN","IBTUBO",2,0)
 ;;2.0;INTEGRATED BILLING;**19,31,32,91,123,159,192,235,248**;21-MAR-94
"RTN","IBTUBO",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBTUBO",4,0)
 ;
"RTN","IBTUBO",5,0)
% ; - Entry point for manual option.
"RTN","IBTUBO",6,0)
 N IBBDT,IBCOMP,IBDET,IBEDT,IBOPT,IBPRT,IBTIMON,IBQUIT,IBSEL
"RTN","IBTUBO",7,0)
 S IBQUIT=0 D:'$D(DT) DT^DICRW
"RTN","IBTUBO",8,0)
 W !!,"Re-Generate Unbilled Amounts Report",!
"RTN","IBTUBO",9,0)
 ;
"RTN","IBTUBO",10,0)
 ; - Ask to re-compile Unbilled Amounts data.
"RTN","IBTUBO",11,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","IBTUBO",12,0)
 S DIR("A")="Do you want to store Unbilled Amounts figures"
"RTN","IBTUBO",13,0)
 S DIR("?",1)="Enter 'YES' if you wish to store the Unbilled Amounts summary"
"RTN","IBTUBO",14,0)
 S DIR("?",2)="figures in your system for a specific month/year in the past."
"RTN","IBTUBO",15,0)
 S DIR("?",3)="Once stored, these figures will be available for inquiry through"
"RTN","IBTUBO",16,0)
 S DIR("?",4)="the View Unbilled Amounts option [IBT VIEW UNBILLED AMOUNTS]."
"RTN","IBTUBO",17,0)
 S DIR("?",5)="These summary figures are normally calculated and stored"
"RTN","IBTUBO",18,0)
 S DIR("?",6)="automatically by the system at the beginning of each month for"
"RTN","IBTUBO",19,0)
 S DIR("?",7)="the previous month."
"RTN","IBTUBO",20,0)
 S DIR("?",8)=" "
"RTN","IBTUBO",21,0)
 S DIR("?",9)="If you enter 'NO', the Unbilled Amounts summary figures will"
"RTN","IBTUBO",22,0)
 S DIR("?",10)="NOT be stored in your system, and the report may be run for"
"RTN","IBTUBO",23,0)
 S DIR("?")="any date range."
"RTN","IBTUBO",24,0)
 D ^DIR K DIR G:$D(DIRUT) END S IBCOMP=Y
"RTN","IBTUBO",25,0)
 I IBCOMP G RDATE
"RTN","IBTUBO",26,0)
 ;
"RTN","IBTUBO",27,0)
 ; - Select date(s) to build report.
"RTN","IBTUBO",28,0)
 W ! D DT1^IBTUBOU G:IBBDT="^" END
"RTN","IBTUBO",29,0)
 ;
"RTN","IBTUBO",30,0)
 ; - Select report(s).
"RTN","IBTUBO",31,0)
 S IBPRT="Choose report type(s) to print:"
"RTN","IBTUBO",32,0)
 S IBOPT(1)="INPATIENT UNBILLED"
"RTN","IBTUBO",33,0)
 S IBOPT(2)="OUTPATIENT UNBILLED"
"RTN","IBTUBO",34,0)
 S IBOPT(3)="PRESCRIPTION UNBILLED"
"RTN","IBTUBO",35,0)
 S IBOPT(4)="ALL OF THE ABOVE"
"RTN","IBTUBO",36,0)
 S IBSEL=$$MLTP^IBJD(IBPRT,.IBOPT,1) I 'IBSEL G END
"RTN","IBTUBO",37,0)
 S $E(IBSEL,$L(IBSEL))=""
"RTN","IBTUBO",38,0)
 ;
"RTN","IBTUBO",39,0)
RDATE ; - Select re-compile date, if necessary.
"RTN","IBTUBO",40,0)
 I IBCOMP D  G END:IBTIMON="^",DET
"RTN","IBTUBO",41,0)
 . W ! D DT2("Unbilled Amounts") Q:IBTIMON="^"
"RTN","IBTUBO",42,0)
 . W !!,"NOTE: Just a reminder that by entering the above month/year this"
"RTN","IBTUBO",43,0)
 . W !,"      report will re-calculate and update the Unbilled Amounts"
"RTN","IBTUBO",44,0)
 . W !,"      data on file in your system.",*7
"RTN","IBTUBO",45,0)
 . ;
"RTN","IBTUBO",46,0)
 . ; - Initialize variables
"RTN","IBTUBO",47,0)
 . I IBTIMON<3030900 N X S X=$$M2^IBJDE(IBTIMON,11,11) D 
"RTN","IBTUBO",48,0)
 .. S IBBDT=+X,IBEDT=$P(X,U,2)+.9,IBSEL="1,2,3"
"RTN","IBTUBO",49,0)
 . I IBTIMON'<3030900 S IBBDT=$$M3^IBJDE($$LDATE^IBJDE(IBTIMON)+1),IBEDT=$$LDATE^IBJDE(IBTIMON)+.9,IBSEL="1,2,3"
"RTN","IBTUBO",50,0)
 . D MSG W !
"RTN","IBTUBO",51,0)
 ;
"RTN","IBTUBO",52,0)
 S IBTIMON=IBEDT\100*100
"RTN","IBTUBO",53,0)
 ;
"RTN","IBTUBO",54,0)
DET ; - Ask to print detail report.
"RTN","IBTUBO",55,0)
 S DIR(0)="Y",DIR("B")="NO" W !
"RTN","IBTUBO",56,0)
 S DIR("A")="Print detail report with the Unbilled Amounts summary"
"RTN","IBTUBO",57,0)
 S DIR("?",1)="Answer YES if you want a detailed listing of the patients"
"RTN","IBTUBO",58,0)
 S DIR("?",2)="and events that are unbilled. Answer NO if you just want"
"RTN","IBTUBO",59,0)
 S DIR("?")="the summary, or '^' to quit this option."
"RTN","IBTUBO",60,0)
 D ^DIR K DIR G:$D(DIRUT) END S IBDET=Y G:'IBDET QUE
"RTN","IBTUBO",61,0)
 ;
"RTN","IBTUBO",62,0)
 ; - Select device to print.
"RTN","IBTUBO",63,0)
 W !!,"This report takes a while to run, so you should queue it to run"
"RTN","IBTUBO",64,0)
 W !,"after normal business hours."
"RTN","IBTUBO",65,0)
 W !!,"You will need a 132 column printer for this report!",!
"RTN","IBTUBO",66,0)
 S %ZIS="QM" D ^%ZIS G END:POP,QUE:$D(IO("Q"))
"RTN","IBTUBO",67,0)
 ;
"RTN","IBTUBO",68,0)
 U IO G STR
"RTN","IBTUBO",69,0)
 ;
"RTN","IBTUBO",70,0)
QUE ; - Queue report/summary, if necessary.
"RTN","IBTUBO",71,0)
 W ! I 'IBDET S ZTIO=""
"RTN","IBTUBO",72,0)
 S ZTRTN="IBTUBOA",ZTSAVE("IB*")=""
"RTN","IBTUBO",73,0)
 S ZTDESC="IB - Unbilled Amounts Report"
"RTN","IBTUBO",74,0)
 D ^%ZTLOAD K IO("Q"),ZTSK
"RTN","IBTUBO",75,0)
 D HOME^%ZIS G END
"RTN","IBTUBO",76,0)
 ;
"RTN","IBTUBO",77,0)
AUTO ; - Entry point for scheduled option.
"RTN","IBTUBO",78,0)
 Q  ;;**NO LONGER USED**
"RTN","IBTUBO",79,0)
 ;
"RTN","IBTUBO",80,0)
DQ ; - Entry point for DM extract.
"RTN","IBTUBO",81,0)
 ; - If AUTO PRINT UNBILLED LIST=yes and default report printer then
"RTN","IBTUBO",82,0)
 ;   automatically requeue to device.
"RTN","IBTUBO",83,0)
 I $P(^IBE(350.9,1,6),U,24) D  G END:'$G(IBXTRACT)
"RTN","IBTUBO",84,0)
 . N X S X=$O(^IBE(353,"B","IB REPORTS",0))
"RTN","IBTUBO",85,0)
 . S ZTIO=$P($G(^IBE(353,+X,0)),U,2) Q:ZTIO=""
"RTN","IBTUBO",86,0)
 . S IBDET=1,IBXTRACT=0,ZTDTH=$H,ZTRTN="IBTUBOA",ZTSAVE("IB*")=""
"RTN","IBTUBO",87,0)
 . S ZTDESC="IB - Unbilled Amounts Report" D ^%ZTLOAD
"RTN","IBTUBO",88,0)
 . S IBDET=0,IBXTRACT=1
"RTN","IBTUBO",89,0)
 . K ZTDESC,ZTDTH,ZTRTN,ZTSAVE,ZTSK
"RTN","IBTUBO",90,0)
 ;
"RTN","IBTUBO",91,0)
STR D ^IBTUBOA ; Start report.
"RTN","IBTUBO",92,0)
 ;
"RTN","IBTUBO",93,0)
END K DIRUT Q
"RTN","IBTUBO",94,0)
 ;
"RTN","IBTUBO",95,0)
MSG ; - Compile message.
"RTN","IBTUBO",96,0)
 W !!,"NOTE: After this report is run, the Unbilled Amounts totals for"
"RTN","IBTUBO",97,0)
 W !?6,"the month of "_$$DAT2^IBOUTL(IBTIMON)_" will be updated."
"RTN","IBTUBO",98,0)
 Q
"RTN","IBTUBO",99,0)
DT2(STR) ; - Select re-compile date (returns variable IBTIMON).
"RTN","IBTUBO",100,0)
 ; Input: STR - String that describe the type of data that will be 
"RTN","IBTUBO",101,0)
 ;        re-compiled: "Unbilled Amounts", "Average Bill Amounts", etc...
"RTN","IBTUBO",102,0)
 ;
"RTN","IBTUBO",103,0)
 ; This code is very the same code as is in DT2^IBTUBOU... that is
"RTN","IBTUBO",104,0)
 ; a utility routine, so code was copied and altered to accommodate
"RTN","IBTUBO",105,0)
 ; EOAM changes. 
"RTN","IBTUBO",106,0)
 N DIRUT,DT0,DT1,DT2,Y
"RTN","IBTUBO",107,0)
 ; - AUG 1993 is the first month on file with Unbilled Amounts data
"RTN","IBTUBO",108,0)
 S DT0=2930800,DT1=$$DAT2^IBOUTL(DT0)
"RTN","IBTUBO",109,0)
 I $E(DT,6,7)'>$E($$LDATE^IBJDE(DT),6,7) S DT2=DT
"RTN","IBTUBO",110,0)
 I $E(DT,6,7)>$E($$LDATE^IBJDE(DT),6,7) S DT2=DT+100 I $E(DT2,4,5)=13 S DT2=DT+8900
"RTN","IBTUBO",111,0)
 S DT2=$$M1^IBJDE(DT2,1),DIR("B")=$$DAT2^IBOUTL(DT2)
"RTN","IBTUBO",112,0)
 S DIR(0)="DA^"_$E(DT0,1,5)_"00:"_DT2_":AE^K:$E(Y,6,7)'=""00"" X"
"RTN","IBTUBO",113,0)
 S DIR("A")="Re-compile "_$G(STR)_" through MONTH/YEAR: "
"RTN","IBTUBO",114,0)
 S DIR("?",1)="Enter a past month/year (ex. Oct 2000).",DIR("?",2)=""
"RTN","IBTUBO",115,0)
 S DIR("?",3)="NOTE: The earliest month/year that can be entered is "_DT1_", and"
"RTN","IBTUBO",116,0)
 S DIR("?")="      it is NOT possible to enter the current or a future month/year."
"RTN","IBTUBO",117,0)
 D ^DIR K DIR I $D(DIRUT) S IBTIMON="^" G DT2Q
"RTN","IBTUBO",118,0)
 I $E(Y,6,7)'="00"!($E(Y,4,7)="0000") W "  ??" G DT2
"RTN","IBTUBO",119,0)
 S IBTIMON=Y
"RTN","IBTUBO",120,0)
 ;
"RTN","IBTUBO",121,0)
DT2Q Q
"VER")
8.0^22
**END**
**END**
