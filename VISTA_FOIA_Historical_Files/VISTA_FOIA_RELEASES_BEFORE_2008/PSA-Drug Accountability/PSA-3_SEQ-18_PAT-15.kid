Released PSA*3*15 SEQ #18
Extracted from mail message
**KIDS**:PSA*3.0*15^

**INSTALL NAME**
PSA*3.0*15
"BLD",2464,0)
PSA*3.0*15^DRUG ACCOUNTABILITY^0^3000525^y
"BLD",2464,1,0)
^9.61A^4^4^3000516^^^^
"BLD",2464,1,1,0)
The set-up for device selection will not allow 80 column reports to be
"BLD",2464,1,2,0)
sent to the screen. This causes massive amounts of wasted paper
"BLD",2464,1,3,0)
to obtain information that should be readily available to the user.
"BLD",2464,1,4,0)
This patch will allow 80 column reports to be sent to the screen.
"BLD",2464,"KRN",0)
^9.67PA^^
"BLD",2464,"KRN",.4,0)
.4
"BLD",2464,"KRN",.4,"NM",0)
^9.68A^^0
"BLD",2464,"KRN",.401,0)
.401
"BLD",2464,"KRN",.401,"NM",0)
^9.68A^^0
"BLD",2464,"KRN",.402,0)
.402
"BLD",2464,"KRN",.402,"NM",0)
^9.68A^^0
"BLD",2464,"KRN",.403,0)
.403
"BLD",2464,"KRN",.5,0)
.5
"BLD",2464,"KRN",.84,0)
.84
"BLD",2464,"KRN",3.6,0)
3.6
"BLD",2464,"KRN",3.8,0)
3.8
"BLD",2464,"KRN",9.2,0)
9.2
"BLD",2464,"KRN",9.8,0)
9.8
"BLD",2464,"KRN",9.8,"NM",0)
^9.68A^37^33
"BLD",2464,"KRN",9.8,"NM",3,0)
PSACON^^0^B12576331
"BLD",2464,"KRN",9.8,"NM",4,0)
PSACON2^^0^B15301794
"BLD",2464,"KRN",9.8,"NM",5,0)
PSACONW^^0^B10964813
"BLD",2464,"KRN",9.8,"NM",6,0)
PSACOST^^0^B29210759
"BLD",2464,"KRN",9.8,"NM",7,0)
PSADAI^^0^B18002920
"BLD",2464,"KRN",9.8,"NM",8,0)
PSADJR^^0^B20776516
"BLD",2464,"KRN",9.8,"NM",9,0)
PSADRU^^0^B12771473
"BLD",2464,"KRN",9.8,"NM",10,0)
PSAHIS^^0^B23525089
"BLD",2464,"KRN",9.8,"NM",11,0)
PSALEVRP^^0^B50917737
"BLD",2464,"KRN",9.8,"NM",12,0)
PSALFA^^0^B16077100
"BLD",2464,"KRN",9.8,"NM",13,0)
PSALFS^^0^B9805018
"BLD",2464,"KRN",9.8,"NM",14,0)
PSALNA^^0^B17184229
"BLD",2464,"KRN",9.8,"NM",15,0)
PSALND^^0^B10110084
"BLD",2464,"KRN",9.8,"NM",16,0)
PSALOG^^0^B23072806
"BLD",2464,"KRN",9.8,"NM",17,0)
PSALOG2^^0^B27002713
"BLD",2464,"KRN",9.8,"NM",18,0)
PSAMON^^0^B49957996
"BLD",2464,"KRN",9.8,"NM",19,0)
PSANAC^^0^B28314130
"BLD",2464,"KRN",9.8,"NM",20,0)
PSANDC^^0^B11510883
"BLD",2464,"KRN",9.8,"NM",21,0)
PSAOP^^0^B36721516
"BLD",2464,"KRN",9.8,"NM",22,0)
PSAOP2^^0^B33216667
"BLD",2464,"KRN",9.8,"NM",23,0)
PSAPSI^^0^B35525013
"BLD",2464,"KRN",9.8,"NM",24,0)
PSAPSI2^^0^B26507609
"BLD",2464,"KRN",9.8,"NM",25,0)
PSAPV^^0^B24136699
"BLD",2464,"KRN",9.8,"NM",26,0)
PSAREPV^^0^B8786334
"BLD",2464,"KRN",9.8,"NM",27,0)
PSAREV^^0^B9323380
"BLD",2464,"KRN",9.8,"NM",28,0)
PSAREVC^^0^B12504719
"BLD",2464,"KRN",9.8,"NM",29,0)
PSAREVD^^0^B15044431
"BLD",2464,"KRN",9.8,"NM",30,0)
PSARIN^^0^B14125035
"BLD",2464,"KRN",9.8,"NM",31,0)
PSAUNI^^0^B12565718
"BLD",2464,"KRN",9.8,"NM",32,0)
PSAUNM^^0^B6663222
"BLD",2464,"KRN",9.8,"NM",33,0)
PSAVER4^^0^B8379472
"BLD",2464,"KRN",9.8,"NM",34,0)
PSAVIN^^0^B9425519
"BLD",2464,"KRN",9.8,"NM",35,0)
PSAVIN1^^0^B14411045
"BLD",2464,"KRN",9.8,"NM",36,0)
PSAVIN2^^0^B13218269
"BLD",2464,"KRN",9.8,"NM",37,0)
PSAUTL1^^0^B45253114
"BLD",2464,"KRN",9.8,"NM","B","PSACON",3)

"BLD",2464,"KRN",9.8,"NM","B","PSACON2",4)

"BLD",2464,"KRN",9.8,"NM","B","PSACONW",5)

"BLD",2464,"KRN",9.8,"NM","B","PSACOST",6)

"BLD",2464,"KRN",9.8,"NM","B","PSADAI",7)

"BLD",2464,"KRN",9.8,"NM","B","PSADJR",8)

"BLD",2464,"KRN",9.8,"NM","B","PSADRU",9)

"BLD",2464,"KRN",9.8,"NM","B","PSAHIS",10)

"BLD",2464,"KRN",9.8,"NM","B","PSALEVRP",11)

"BLD",2464,"KRN",9.8,"NM","B","PSALFA",12)

"BLD",2464,"KRN",9.8,"NM","B","PSALFS",13)

"BLD",2464,"KRN",9.8,"NM","B","PSALNA",14)

"BLD",2464,"KRN",9.8,"NM","B","PSALND",15)

"BLD",2464,"KRN",9.8,"NM","B","PSALOG",16)

"BLD",2464,"KRN",9.8,"NM","B","PSALOG2",17)

"BLD",2464,"KRN",9.8,"NM","B","PSAMON",18)

"BLD",2464,"KRN",9.8,"NM","B","PSANAC",19)

"BLD",2464,"KRN",9.8,"NM","B","PSANDC",20)

"BLD",2464,"KRN",9.8,"NM","B","PSAOP",21)

"BLD",2464,"KRN",9.8,"NM","B","PSAOP2",22)

"BLD",2464,"KRN",9.8,"NM","B","PSAPSI",23)

"BLD",2464,"KRN",9.8,"NM","B","PSAPSI2",24)

"BLD",2464,"KRN",9.8,"NM","B","PSAPV",25)

"BLD",2464,"KRN",9.8,"NM","B","PSAREPV",26)

"BLD",2464,"KRN",9.8,"NM","B","PSAREV",27)

"BLD",2464,"KRN",9.8,"NM","B","PSAREVC",28)

"BLD",2464,"KRN",9.8,"NM","B","PSAREVD",29)

"BLD",2464,"KRN",9.8,"NM","B","PSARIN",30)

"BLD",2464,"KRN",9.8,"NM","B","PSAUNI",31)

"BLD",2464,"KRN",9.8,"NM","B","PSAUNM",32)

"BLD",2464,"KRN",9.8,"NM","B","PSAUTL1",37)

"BLD",2464,"KRN",9.8,"NM","B","PSAVER4",33)

"BLD",2464,"KRN",9.8,"NM","B","PSAVIN",34)

"BLD",2464,"KRN",9.8,"NM","B","PSAVIN1",35)

"BLD",2464,"KRN",9.8,"NM","B","PSAVIN2",36)

"BLD",2464,"KRN",19,0)
19
"BLD",2464,"KRN",19.1,0)
19.1
"BLD",2464,"KRN",101,0)
101
"BLD",2464,"KRN",409.61,0)
409.61
"BLD",2464,"KRN",771,0)
771
"BLD",2464,"KRN",869.2,0)
869.2
"BLD",2464,"KRN",870,0)
870
"BLD",2464,"KRN",8994,0)
8994
"BLD",2464,"KRN","B",.4,.4)

"BLD",2464,"KRN","B",.401,.401)

"BLD",2464,"KRN","B",.402,.402)

"BLD",2464,"KRN","B",.403,.403)

"BLD",2464,"KRN","B",.5,.5)

"BLD",2464,"KRN","B",.84,.84)

"BLD",2464,"KRN","B",3.6,3.6)

"BLD",2464,"KRN","B",3.8,3.8)

"BLD",2464,"KRN","B",9.2,9.2)

"BLD",2464,"KRN","B",9.8,9.8)

"BLD",2464,"KRN","B",19,19)

"BLD",2464,"KRN","B",19.1,19.1)

"BLD",2464,"KRN","B",101,101)

"BLD",2464,"KRN","B",409.61,409.61)

"BLD",2464,"KRN","B",771,771)

"BLD",2464,"KRN","B",869.2,869.2)

"BLD",2464,"KRN","B",870,870)

"BLD",2464,"KRN","B",8994,8994)

"BLD",2464,"QUES",0)
^9.62^^
"BLD",2464,"REQB",0)
^9.611^2^2
"BLD",2464,"REQB",1,0)
PSA*3.0*3^0
"BLD",2464,"REQB",2,0)
PSA*3.0*12^0
"BLD",2464,"REQB","B","PSA*3.0*12",2)

"BLD",2464,"REQB","B","PSA*3.0*3",1)

"BLD",2464,"REQG",0)
^9.611^^
"MBREQ")
0
"PKG",287,-1)
1^1
"PKG",287,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",287,22,0)
^9.49I^1^1
"PKG",287,22,1,0)
3.0^2971024^2971030^11595
"PKG",287,22,1,"PAH",1,0)
15^3000525^11850
"PKG",287,22,1,"PAH",1,1,0)
^^4^4^3000525
"PKG",287,22,1,"PAH",1,1,1,0)
The set-up for device selection will not allow 80 column reports to be
"PKG",287,22,1,"PAH",1,1,2,0)
sent to the screen. This causes massive amounts of wasted paper
"PKG",287,22,1,"PAH",1,1,3,0)
to obtain information that should be readily available to the user.
"PKG",287,22,1,"PAH",1,1,4,0)
This patch will allow 80 column reports to be sent to the screen.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
35
"RTN","PSACON")
0^3^B12576331
"RTN","PSACON",1,0)
PSACON ;BIR/LTL-Display Connected Drug and Procurement History ;7/23/97
"RTN","PSACON",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSACON",3,0)
 ;References to $$DESCR^PRCPUX1 are covered by IA #259
"RTN","PSACON",4,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSACON",5,0)
 ;References to $$NSN^PRCPUX1 are covered by IA #259
"RTN","PSACON",6,0)
 ;References to $$UNITCODE^PRCPUX1 are covered by IA #259
"RTN","PSACON",7,0)
 ;References to $$UNITVAL^PRCPUX1 are covered by IA #259
"RTN","PSACON",8,0)
 ;References to $$VENNAME^PRCPUX1 are covered by IA #259
"RTN","PSACON",9,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSACON",10,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSACON",11,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSACON",12,0)
 ;
"RTN","PSACON",13,0)
 N DA,DIC,DTOUT,DUOUT,PSA,PSACON,PSAW,X,Y
"RTN","PSACON",14,0)
 D DT^DICRW
"RTN","PSACON",15,0)
 F  S DIC="^PSDRUG(",DIC(0)="AEMQZ",DIC("S")="I $S('$D(^(""I"")):1,+^(""I"")>DT:1,1:0)",DIC("W")="W:'$O(^(441,0)) ?65,""NOT CONNECTED""" W ! D ^DIC K DA,DIC G:Y<0 END S PSA=+Y D  G:Y<0 END G:$G(PSAW) ^PSACONW D:$G(PSACON) ^PSACON1 D ^PSACON2
"RTN","PSACON",16,0)
 .W @IOF,!!,$P($G(^PSDRUG(+PSA,0)),U),!!,?25,"** FROM THE DRUG FILE **",!!
"RTN","PSACON",17,0)
 .W "FSN: ",$P($G(^PSDRUG(+PSA,0)),U,6),?40,"NDC: ",$P($G(^PSDRUG(+PSA,2)),U,4),!!
"RTN","PSACON",18,0)
 .S PSA(5)=$S($P($G(^PSDRUG(+PSA,660)),U,5):$P($G(^(660)),U,5),1:1)
"RTN","PSACON",19,0)
 .S PSA(6)=$P($G(^DIC(51.5,+$P($G(^PSDRUG(+PSA,660)),U,2),0)),U)
"RTN","PSACON",20,0)
 .W "PACKAGING: ",PSA(5),"/",PSA(6)
"RTN","PSACON",21,0)
 .S PSA(8)=$P($G(^PSDRUG(+PSA,660)),U,8)
"RTN","PSACON",22,0)
 .W ?20,"PRICE: $",$P($G(^PSDRUG(+PSA,660)),U,3),"/",PSA(6)
"RTN","PSACON",23,0)
 .W ?40,"PRICE/DISPENSE UNIT: $",$P($G(^PSDRUG(+PSA,660)),U,6),"/",PSA(8)
"RTN","PSACON",24,0)
 .S PSA(15)=$O(^PSDRUG(+PSA,441,0)),PSA(1)=$G(^(+PSA(15),0))
"RTN","PSACON",25,0)
 .;more than one item linked
"RTN","PSACON",26,0)
 .D:$O(^PSDRUG(+PSA,441,PSA(15)))  Q:Y<0  K DIC,DA
"RTN","PSACON",27,0)
 ..W !!,"There is more than one item linked to this drug.",!
"RTN","PSACON",28,0)
 ..S DIC="^PSDRUG(+PSA,441,",DIC(0)="AEQ",DA(1)=+PSA
"RTN","PSACON",29,0)
 ..S DIC("W")="W ?10,$$DESCR^PRCPUX1(0,$G(^(0)))"
"RTN","PSACON",30,0)
 ..D ^DIC Q:Y<0  S PSA(1)=$G(^PSDRUG(+PSA,441,+Y,0)) K DIC,DA
"RTN","PSACON",31,0)
 .I 'PSA(1) S Y=-1 Q
"RTN","PSACON",32,0)
 .D:PSA(1)  Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSACON",33,0)
 ..W !!?25,"<< FROM THE ITEM MASTER FILE >>",!!
"RTN","PSACON",34,0)
 ..S PSA(11)=$G(^PRC(441,+PSA(1),0))
"RTN","PSACON",35,0)
 ..W "ITEM #: ",PSA(1),?15,$$DESCR^PRCPUX1(0,PSA(1)),!!
"RTN","PSACON",36,0)
 ..W "NSN: ",$$NSN^PRCPUX1(PSA(1))
"RTN","PSACON",37,0)
 ..I $P($G(^PRC(440,+$P(PSA(11),U,8),0)),U,11)="S" S PSAW=$O(^PRCP(445,"AC","W","")) Q
"RTN","PSACON",38,0)
 ..S PSA(3)=$O(^PRC(441,+PSA(1),2,0))
"RTN","PSACON",39,0)
 ..I PSA(3)&('$O(^PRC(441,+PSA(1),2,+PSA(3)))) D  Q
"RTN","PSACON",40,0)
 ...W ?40,"ONLY VENDOR: ",$E($$VENNAME^PRCPUX1(+PSA(3)_"PRC(440"),1,28),!!
"RTN","PSACON",41,0)
 ...S PSA(33)=$G(^PRC(441,+PSA(1),2,+PSA(3),0))
"RTN","PSACON",42,0)
 ...W "VENDOR STOCK #: ",$P(PSA(33),U,4)
"RTN","PSACON",43,0)
 ...W ?40,"NDC: ",$P(PSA(33),U,5),!!
"RTN","PSACON",44,0)
 ...W "PACKAGING: ",$$UNITVAL^PRCPUX1($P(PSA(33),U,8),$P(PSA(33),U,7))
"RTN","PSACON",45,0)
 ...W ?20,"PRICE: $",$P(PSA(33),U,2),"/",$$UNITCODE^PRCPUX1($P(PSA(33),U,7))
"RTN","PSACON",46,0)
 ...W ?40,"PRICE/DISPENSE UNIT: $",$P(PSA(33),U,2)/PSA(5)
"RTN","PSACON",47,0)
 ...W !!,"MINIMUM ORDER: ",$P(PSA(33),U,12)
"RTN","PSACON",48,0)
 ...S Y=$P(PSA(33),U,6) X ^DD("DD")
"RTN","PSACON",49,0)
 ...S Y=$E(Y,1,4)_$S($L(Y)=10:$E(Y,7,10),$L(Y)=11:$E(Y,8,11),1:"")
"RTN","PSACON",50,0)
 ...W ?20,"PRICE DATE: ",Y
"RTN","PSACON",51,0)
 ...W ?40,"REQUIRED ORDER MULTIPLE: ",$P(PSA(33),U,11),!!
"RTN","PSACON",52,0)
 ..W !!,"LAST VENDOR ORDERED: ",$$VENNAME^PRCPUX1($P(PSA(11),U,4)_"PRC(440"),!!
"RTN","PSACON",53,0)
 ..W "MANDATORY SOURCE: ",$$VENNAME^PRCPUX1($P(PSA(11),U,8)_"PRC(440"),!
"RTN","PSACON",54,0)
 ..K IO("Q") N %ZIS,IOP,POP S %ZIS="Q",%ZIS("A")="For Vendor listing, please select DEVICE: " D ^%ZIS I POP S DTOUT=1,Y=-1 W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSACON",55,0)
 ..I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="^PSACON1",ZTDESC="DRUG VENDORS",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S Y=1 Q
"RTN","PSACON",56,0)
 ..S (DTOUT,PSACON)=1 Q
"RTN","PSACON",57,0)
END K PSAOUT Q
"RTN","PSACON2")
0^4^B15301794
"RTN","PSACON2",1,0)
PSACON2 ;BIR/LTL-Display Connected Drug and Procurement History - CONT'D ;7/23/97
"RTN","PSACON2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSACON2",3,0)
 ;This routine is called by PSACON.
"RTN","PSACON2",4,0)
 ;
"RTN","PSACON2",5,0)
 ;References to $$UNITCODE^PRCPUX1 are covered by IA #259
"RTN","PSACON2",6,0)
 ;References to $$VENNAME^PRCPUX1 are covered by IA #259
"RTN","PSACON2",7,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSACON2",8,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSACON2",9,0)
 ;
"RTN","PSACON2",10,0)
 Q:'$O(^PRC(441,+PSA(1),4,0))!($G(PSAOUT))
"RTN","PSACON2",11,0)
HIS K PSACON N DIRUT,PSADT,PSAOUT,PSAB,PSAD,PSAQ S (PSA(9),PSAOUT)=0
"RTN","PSACON2",12,0)
 I PSA(1) F  S PSA(9)=$O(^PRC(441,+PSA(1),4,PSA(9))) Q:'PSA(9)  S:$O(^PRC(441,+PSA(1),4,+PSA(9),1,0)) PSA(10)=1
"RTN","PSACON2",13,0)
 I $G(PSA(10)) S DIR(0)="Y",DIR("A")="Procurement history exists, would you like to review",DIR("B")="Yes" W ! D ^DIR K DIR D:Y  I Y<1 S PSAOUT=1 G END G:$D(DIRUT) END
"RTN","PSACON2",14,0)
 .S DIR(0)="D",DIR("A")="How far back in time would you like to go",DIR("B")="T-6M" W ! D ^DIR K DIR Q:$D(DIRUT)  S PSA(13)=+Y
"RTN","PSACON2",15,0)
 .X ^DD("DD") S PSADT=Y
"RTN","PSACON2",16,0)
 .D NOW^%DTC S X1=X,X2=PSA(13) D ^%DTC S PSAD=$S(X/30>0:X/30,1:1)
"RTN","PSACON2",17,0)
 .S PSA(9)=$O(^PRC(441,+PSA(1),4,0)),Y=1
"RTN","PSACON2",18,0)
 I '$O(^PRC(441,+PSA(1),4,PSA(9))) G DEV
"RTN","PSACON2",19,0)
 S DIC="^PRC(441,+PSA(1),4,",DIC(0)="AEMQZ",DIC("W")="W:'$O(^(1,0)) ""  NO HISTORY""",DA(1)=PSA(1) W ! D ^DIC K DIC S PSA(9)=+Y I Y<0 S PSAOUT=1 G END
"RTN","PSACON2",20,0)
 I '$O(^PRC(441,+PSA(1),4,+PSA(9),1,0)) W !,"Sorry, no history for that particular Control Point.",! G END
"RTN","PSACON2",21,0)
DEV K IO("Q") N %ZIS,IOP,POP S %ZIS="Q",%ZIS("A")="For procurement history, please select DEVICE: " W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" S PSAOUT=1 G END
"RTN","PSACON2",22,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LOOP^PSACON2",ZTDESC="Drug Procurement History",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSACON2",23,0)
LOOP N PSALN,PSAPG,PSARPDT S (PSAPG,PSA(11))=0,Y=1 D HEADER
"RTN","PSACON2",24,0)
 F  S PSA(11)=$O(^PRC(441,+PSA(1),4,+PSA(9),1,PSA(11))),PSA(14)=$P($G(^PRC(442,+PSA(11),1)),U,15) Q:'PSA(11)!(PSAOUT)  D:$Y+4>IOSL HEADER G:'Y END D:PSA(14)'<PSA(13)
"RTN","PSACON2",25,0)
 .W !,$E($P($G(^PRC(442,+PSA(11),0)),U),5,10)
"RTN","PSACON2",26,0)
 .W ?8,$E($$VENNAME^PRCPUX1($P($G(^PRC(442,+PSA(11),1)),U)_"PRC(440"),1,20)
"RTN","PSACON2",27,0)
 .S Y=PSA(14) X ^DD("DD") W ?32,Y
"RTN","PSACON2",28,0)
 .S PSA(12)=$O(^PRC(442,+PSA(11),2,"AE",+PSA(1),""))
"RTN","PSACON2",29,0)
 .W ?45,$J($P($G(^PRC(442,+PSA(11),2,+PSA(12),0)),U,2),3) S PSAQ=$G(PSAQ)+$P($G(^(0)),U,2)
"RTN","PSACON2",30,0)
 .W " ",$$UNITCODE^PRCPUX1($P($G(^PRC(442,+PSA(11),2,+PSA(12),0)),U,3))
"RTN","PSACON2",31,0)
 .W ?55,"$",$J($P($G(^PRC(442,+PSA(11),2,+PSA(12),2)),U),9,2) S PSAB=$G(PSAB)+$P($G(^(2)),U)
"RTN","PSACON2",32,0)
 .W ?70,$P($G(^PRC(442,+PSA(11),2,+PSA(12),2)),U,8),! S Y=1
"RTN","PSACON2",33,0)
 .I '$O(^PRC(441,+PSA(1),4,+PSA(9),1,PSA(11))) S X=$G(PSAQ)/PSAD,X2=1,X3=5 D COMMA^%DTC W PSALN,!!,"Average ordered/month: ",X,?34,"TOTAL ORD: ",$J($G(PSAQ),3),?50,"TOTAL $: " S X=PSAB,X2="0$",X3=5 D COMMA^%DTC W X
"RTN","PSACON2",34,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSACON2",35,0)
 I $E(IOST,1,2)="C-",'PSAOUT S DIR(0)="EA",DIR("A")="END OF HISTORY!  Press <RET> to return to the option." W ! D ^DIR K DIR
"RTN","PSACON2",36,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSACON2",37,0)
 K PSA,PSACON
"RTN","PSACON2",38,0)
 Q
"RTN","PSACON2",39,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSACON2",40,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSACON2",41,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,$E($P($G(^PSDRUG(+PSA,0)),U),1,40)
"RTN","PSACON2",42,0)
 W "=> from ",$G(PSADT),?60,"PAGE: ",PSAPG,!,PSALN,!,"PO #",?10,"VENDOR",?33,"PO DATE",?45,"QTY ORD",?57,"COST",?70,"QTY RECD",!,PSALN,!
"RTN","PSACON2",43,0)
 Q
"RTN","PSACONW")
0^5^B10964813
"RTN","PSACONW",1,0)
PSACONW ;BIR/LTL-Display Connected Drug and Procurement History - CONT'D ;7/23/97
"RTN","PSACONW",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSACONW",3,0)
 ;This routine contains the history of warehoused drugs. It is called
"RTN","PSACONW",4,0)
 ;by PSACON.
"RTN","PSACONW",5,0)
 ;
"RTN","PSACONW",6,0)
 ;References to $$INVNAME^PRCPUX1 are covered by IA #259
"RTN","PSACONW",7,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSACONW",8,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSACONW",9,0)
 ;
"RTN","PSACONW",10,0)
 N PSAI,PSAD,PSAN,PSAQ S (PSAI,PSAOUT)=0
"RTN","PSACONW",11,0)
 W !!,"The Supply Warehouse is the mandatory source for this item.",!
"RTN","PSACONW",12,0)
 I '$O(^PRCP(445.2,"AD",+PSAW,+PSA(1),"")) W !!,"NO HISTORY!" Q
"RTN","PSACONW",13,0)
 W !,"There is a procurement history."
"RTN","PSACONW",14,0)
 S DIR(0)="D",DIR("A")="How far back in time would you like to view",DIR("B")="T-3M" W ! D ^DIR K DIR S PSAD=Y I $D(DIRUT) S PSAOUT=1 G QUIT
"RTN","PSACONW",15,0)
 X ^DD("DD") S PSAD(2)=Y
"RTN","PSACONW",16,0)
 D NOW^%DTC S X1=X,X2=PSAD D ^%DTC S PSAD(1)=$S(X/30>0:X/30,1:1)
"RTN","PSACONW",17,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" W ! D ^%ZIS
"RTN","PSACONW",18,0)
 I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" S PSAOUT=1 G QUIT
"RTN","PSACONW",19,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LOOP^PSACONW",ZTDESC="Drug Issue history",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSACONW",20,0)
LOOP N PSALN,PSAPG S PSAPG=0 D HEADER
"RTN","PSACONW",21,0)
 F  S PSAI=$O(^PRCP(445.2,"AD",+PSAW,+PSA(1),+PSAI)) Q:PSAOUT!('PSAI)  D:$Y+4>IOSL HEADER G:PSAOUT QUIT I $P($G(^PRCP(445.2,PSAI,0)),U,2)?1"R".N S PSAN=$G(^(0)) D:$G(PSAN)&($P($G(PSAN),U,17)'<PSAD)
"RTN","PSACONW",22,0)
 .S Y=$P($P(PSAN,U,17),".") D DD^%DT W !!,Y
"RTN","PSACONW",23,0)
 .W ?14,$P(PSAN,U,19),?33,$J(-$P(PSAN,U,7),3) S PSAQ=$G(PSAQ)-$P(PSAN,U,7)
"RTN","PSACONW",24,0)
 .W ?39,$P(PSAN,U,6)
"RTN","PSACONW",25,0)
 .S X=$P(PSAN,U,9),X2="2$",X3=5 D COMMA^%DTC S PSAN(1)=X
"RTN","PSACONW",26,0)
 .S X=$P(PSAN,U,9)*-$P(PSAN,U,7),X2="2$",X3=10 D COMMA^%DTC S PSAN(2)=X,PSAN(3)=$G(PSAN(3))+($P(PSAN,U,9)*-$P(PSAN,U,7))
"RTN","PSACONW",27,0)
 .W ?47,PSAN(1),?55,PSAN(2)
"RTN","PSACONW",28,0)
 .W ?66,$E($$INVNAME^PRCPUX1($P(PSAN,U,18)),1,14)
"RTN","PSACONW",29,0)
 S X=$G(PSAQ)/PSAD(1),X2=1,X3=5 D COMMA^%DTC W !,PSALN,!!,"Average ord/mon: ",X,?24,"TOT ORD: ",$J($G(PSAQ),3),?49,"TOTAL $: " S X=$G(PSAN(3)),X2="2$",X3=4 D COMMA^%DTC W X
"RTN","PSACONW",30,0)
QUIT W:$E(IOST)'="C" @IOF
"RTN","PSACONW",31,0)
 I $E(IOST,1,2)="C-",'PSAOUT S DIR(0)="EA",DIR("A")="END OF HISTORY!  Press <RET> to return to the option." W ! D ^DIR K DIR
"RTN","PSACONW",32,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q") D HOME^%ZIS
"RTN","PSACONW",33,0)
 Q
"RTN","PSACONW",34,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSACONW",35,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSACONW",36,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1
"RTN","PSACONW",37,0)
 W !,$E($P($G(^PSDRUG(+PSA,0)),U),1,40),"=> from ",PSAD(2),?60,"PAGE: ",PSAPG,!,PSALN,!?2,"DATE",?16,"TRANSACTION",?33,"QTY",?39,"PKG",?47,"UNIT $",?57,"TOTAL $",?66,"INVENTORY",!,PSALN
"RTN","PSACOST")
0^6^B29210759
"RTN","PSACOST",1,0)
PSACOST ;BIR/JMB-Invoice Cost Summary ;7/23/97
"RTN","PSACOST",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,15**; 10/24/97
"RTN","PSACOST",3,0)
 ;This routine prints the order number, invoice number, invoice date,
"RTN","PSACOST",4,0)
 ;total invoice cost, total adjusted cost, and cost difference for a
"RTN","PSACOST",5,0)
 ;specified invoice date range.
"RTN","PSACOST",6,0)
 ;
"RTN","PSACOST",7,0)
 I '$D(^XUSEC("PSA ORDERS",DUZ)) W !,"You do not hold the key to enter the option." Q
"RTN","PSACOST",8,0)
 I '$O(^PSD(58.811,"ADATE",0)) W !,"There are no invoices." G EXIT
"RTN","PSACOST",9,0)
 S PSAOUT=0 D BDATE^PSAPV G:PSAOUT EXIT
"RTN","PSACOST",10,0)
DEVICE ;Asks device & queueing info
"RTN","PSACOST",11,0)
 K IO("Q"),%ZIS,IOP,POP S %ZIS="Q",%ZIS("B")=""
"RTN","PSACOST",12,0)
 W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSACOST",13,0)
 I $D(IO("Q")) D  G EXIT
"RTN","PSACOST",14,0)
 .N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSACOST",15,0)
 .S ZTRTN="COMPILE^PSACOST",ZTDESC="Drug Acct. - Invoice Cost Summary Report"
"RTN","PSACOST",16,0)
 .S:$D(PSABEG) ZTSAVE("PSABEG")="" S:$D(PSAEND) ZTSAVE("PSAEND")=""
"RTN","PSACOST",17,0)
 .D ^%ZTLOAD
"RTN","PSACOST",18,0)
 ;
"RTN","PSACOST",19,0)
COMPILE ;Compiles the data into ^TMP("PSACOST",$J)
"RTN","PSACOST",20,0)
 S PSAOUT=0,PSADATE=PSABEG
"RTN","PSACOST",21,0)
 F  S PSADATE=+$O(^PSD(58.811,"ADATE",PSADATE)) Q:'PSADATE!(PSADATE>PSAEND)!(PSAOUT)  D
"RTN","PSACOST",22,0)
 .S PSAIEN=0 F  S PSAIEN=+$O(^PSD(58.811,"ADATE",PSADATE,PSAIEN)) Q:'PSAIEN!(PSAOUT)  D
"RTN","PSACOST",23,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,0))  S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),(PSAIEN1,PSAOECST)=0
"RTN","PSACOST",24,0)
 ..F  S PSAIEN1=+$O(^PSD(58.811,"ADATE",PSADATE,PSAIEN,PSAIEN1)) Q:'PSAIEN1!(PSAOUT)  D
"RTN","PSACOST",25,0)
 ...Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSACOST",26,0)
 ...S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0),PSAINV=$P(PSAIN,"^"),PSAINVDT=$E(PSADATE,4,5)_"/"_$E(PSADATE,6,7)_"/"_$E(PSADATE,2,3)
"RTN","PSACOST",27,0)
 ...S (PSAAECST,PSAIECST)=0
"RTN","PSACOST",28,0)
 ...S PSALINE=0 F  S PSALINE=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:'PSALINE!(PSAOUT)  D
"RTN","PSACOST",29,0)
 ....Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSACOST",30,0)
 ....S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0) D LINE
"RTN","PSACOST",31,0)
 ...S PSADIFF=PSAIECST-PSAAECST,PSAOECST=PSAOECST+PSAAECST
"RTN","PSACOST",32,0)
 ...S ^TMP("PSACOST",$J,PSAORD,PSAINV)=PSAINVDT_"^"_$J(PSAIECST,$L(PSAIECST),2)_"^"_$J(PSAAECST,$L($P(PSAAECST,".")),2)_"^"_$J(PSADIFF,$L(PSADIFF),2)
"RTN","PSACOST",33,0)
 ;
"RTN","PSACOST",34,0)
ORDER S PSAORD="" F  S PSAORD=$O(^TMP("PSACOST",$J,PSAORD)) Q:PSAORD=""  D
"RTN","PSACOST",35,0)
 .S (PSAACOST,PSADIFF,PSAICOST)=0,PSAINV=""
"RTN","PSACOST",36,0)
 .F  S PSAINV=$O(^TMP("PSACOST",$J,PSAORD,PSAINV)) Q:PSAINV=""  D
"RTN","PSACOST",37,0)
 ..S PSAICOST=PSAICOST+$P(^TMP("PSACOST",$J,PSAORD,PSAINV),"^",2),PSAACOST=PSAACOST+$P(^TMP("PSACOST",$J,PSAORD,PSAINV),"^",3),PSADIFF=PSADIFF+$P(^TMP("PSACOST",$J,PSAORD,PSAINV),"^",4)
"RTN","PSACOST",38,0)
 .S ^TMP("PSACOST",$J,PSAORD)=$J(PSAICOST,$L(PSAICOST),2)_"^"_$J(PSAACOST,$L($P(PSAACOST,".")),2)_"^"_$J(PSADIFF,$L(PSADIFF),2)
"RTN","PSACOST",39,0)
 ;
"RTN","PSACOST",40,0)
PRINT ;Prints invoices' totals
"RTN","PSACOST",41,0)
 S Y=PSAEND D DD^%DT S PSAENDX=Y K X,Y,%DT
"RTN","PSACOST",42,0)
 S Y=PSABEG D DD^%DT S PSABEGX=Y K X,Y,%DT
"RTN","PSACOST",43,0)
 D NOW^%DTC S PSARUN=%,PSARUN=$E(PSARUN,4,5)_"/"_$E(PSARUN,6,7)_"/"_$E(PSARUN,2,3)_"@"_$E($P(PSARUN,".",2),1,2)_":"_$E($P(PSARUN,".",2),3,4)
"RTN","PSACOST",44,0)
 S PSAPG=0,PSASLN="",$P(PSASLN,"-",80)="" K Y D HDR
"RTN","PSACOST",45,0)
 S PSAORD=$O(^TMP("PSACOST",$J,"")) I PSAORD="" W !!,"There is no invoice data in the file for the selected date range.",! D END^PSAPROC G EXIT
"RTN","PSACOST",46,0)
 S PSAORD="" F  S PSAORD=$O(^TMP("PSACOST",$J,PSAORD)) Q:PSAORD=""!(PSAOUT)  D
"RTN","PSACOST",47,0)
 .S PSAODIFF=$P(^TMP("PSACOST",$J,PSAORD),"^",2)
"RTN","PSACOST",48,0)
 .I $Y+5>IOSL D HDR Q:PSAOUT
"RTN","PSACOST",49,0)
 .W !,"ORDER#: "_PSAORD
"RTN","PSACOST",50,0)
 .S PSAINV="" F  S PSAINV=$O(^TMP("PSACOST",$J,PSAORD,PSAINV)) Q:PSAINV=""!(PSAOUT)  D
"RTN","PSACOST",51,0)
 ..S PSAINVDT=$P(^TMP("PSACOST",$J,PSAORD,PSAINV),"^"),PSAICOST=$P(^(PSAINV),"^",2),PSAACOST=$P(^(PSAINV),"^",3),PSADIFF=$P(^(PSAINV),"^",4)
"RTN","PSACOST",52,0)
 ..I $Y+4>IOSL D HDR Q:PSAOUT
"RTN","PSACOST",53,0)
 ..W !,PSAINV,?27,PSAINVDT,?39,$J(PSAICOST,9,2),?55,$J(PSAACOST,9,2),?71,$J(PSADIFF,7,2)
"RTN","PSACOST",54,0)
 .I $Y+4>IOSL D HDR Q:PSAOUT
"RTN","PSACOST",55,0)
 .S PSAOCOST=$P(^TMP("PSACOST",$J,PSAORD),"^"),PSAOACST=$P(^(PSAORD),"^",2),PSAODIFF=$P(^(PSAORD),"^",3)
"RTN","PSACOST",56,0)
 .I PSAICOST'=PSAOCOST!(PSAACOST'=PSAOACST) W !,"ORDER TOTAL" W ?39,$J(PSAOCOST,9,2),?55,$J(PSAOACST,9,2),?69 W $J(PSAODIFF,9,2),!
"RTN","PSACOST",57,0)
 .E  W !
"RTN","PSACOST",58,0)
 I $E(IOST,1,2)="C-" Q:PSAOUT  D END^PSAPROC
"RTN","PSACOST",59,0)
 E  W @IOF
"RTN","PSACOST",60,0)
 ;
"RTN","PSACOST",61,0)
EXIT D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q"),^TMP("PSACOST",$J)
"RTN","PSACOST",62,0)
 K %,%DT,%ZIS,PSAACOST,PSAAECST,PSABEG,PSABEGX,PSADATA,PSADATE,PSADIFF,PSADJ,PSADJP,PSADJQ,PSAEND,PSAENDX,PSAICOST,PSAIECST,PSAIEN
"RTN","PSACOST",63,0)
 K PSAIEN1,PSAIN,PSAINV,PSAINVDT,PSALCOST,PSALINE,PSANODE,PSAOACST,PSAOCOST,PSAODIFF,PSAOECST,PSAORD,PSAOUT,PSAPG,PSAPRICE,PSARUN,PSASLN,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSACOST",64,0)
 Q
"RTN","PSACOST",65,0)
 ;
"RTN","PSACOST",66,0)
LINE ;Get line item data
"RTN","PSACOST",67,0)
 S PSALCOST=$P(PSADATA,"^",3)*$P(PSADATA,"^",5),PSAIECST=PSAIECST+PSALCOST
"RTN","PSACOST",68,0)
PRICE S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSACOST",69,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSAPRICE=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2)),PSADJP=PSAPRICE
"RTN","PSACOST",70,0)
 I '$G(PSADJ) S PSAPRICE=$P(PSADATA,"^",5)
"RTN","PSACOST",71,0)
QTY S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSACOST",72,0)
 I $G(PSADJ) D
"RTN","PSACOST",73,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSACOST",74,0)
 .S PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSACOST",75,0)
 .S PSAACOST=PSADJQ*PSAPRICE,PSAAECST=PSAAECST+PSAACOST
"RTN","PSACOST",76,0)
 I '$G(PSADJQ) S PSAACOST=$P(PSADATA,"^",3)*PSAPRICE,PSAAECST=PSAAECST+PSAACOST
"RTN","PSACOST",77,0)
 Q
"RTN","PSACOST",78,0)
 ;
"RTN","PSACOST",79,0)
HDR ;Report header
"RTN","PSACOST",80,0)
 I $E(IOST,1,2)="C-" W:'PSAPG @IOF D:+PSAPG END^PSAPROC Q:PSAOUT
"RTN","PSACOST",81,0)
 I $E(IOST)'="C",+PSAPG W @IOF
"RTN","PSACOST",82,0)
 S PSAPG=PSAPG+1
"RTN","PSACOST",83,0)
 W !?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE",?72,"PAGE "_PSAPG
"RTN","PSACOST",84,0)
 W !?27,"INVOICE COST SUMMARY REPORT"
"RTN","PSACOST",85,0)
 I $E(IOST)'="C" W !,"RUN: "_PSARUN,?27,PSABEGX_" - "_PSAENDX
"RTN","PSACOST",86,0)
 E  W !,?27,PSABEGX_" - "_PSAENDX
"RTN","PSACOST",87,0)
 W !!?28,"INVOICE",?41,"INVOICE",?56,"ADJUSTED"
"RTN","PSACOST",88,0)
 W !,"INVOICE#",?31,"DATE",?44,"COST",?60,"COST",?68,"DIFFERENCE",!,PSASLN
"RTN","PSACOST",89,0)
 Q
"RTN","PSADAI")
0^7^B18002920
"RTN","PSADAI",1,0)
PSADAI ;BIR/LTL,JMB-Drug Balances by Location ;7/23/97
"RTN","PSADAI",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSADAI",3,0)
 ;
"RTN","PSADAI",4,0)
 ;Reference to ^PS(59.4 are covered by IA #2505
"RTN","PSADAI",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSADAI",6,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSADAI",7,0)
 ;References to ^PS(59 are covered by IA #212
"RTN","PSADAI",8,0)
 ;
"RTN","PSADAI",9,0)
LOC S (PSACNT,PSAOUT)=0 D ^PSAUTL3 G:PSAOUT EXIT1
"RTN","PSADAI",10,0)
 S PSACNT=0,PSACHK=$O(PSALOC(""))
"RTN","PSADAI",11,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT1
"RTN","PSADAI",12,0)
 I PSACHK'="",$G(PSASEL)="",PSALOC W !!,PSALOCN
"RTN","PSADAI",13,0)
 ;
"RTN","PSADAI",14,0)
DEVICE W ! K IO("Q") S %ZIS="Q" D ^%ZIS I POP S DTOUT=1,Y=-1 W !,"No Device was selected or output printed." G EXIT1
"RTN","PSADAI",15,0)
 I $D(IO("Q")) S ZTRTN="START^PSADAI",ZTDESC="Drug Accountability - Drug Location Report",ZTSAVE("PSALOC(")="" D ^%ZTLOAD,HOME^%ZIS S Y=1 G EXIT1
"RTN","PSADAI",16,0)
START S PSAOUT=0,PSALOCN="",$P(PSASLN,"-",80)=""
"RTN","PSADAI",17,0)
 S PSARPDT=$E($$HTFM^XLFDT($H),1,12),PSADT=$P(PSARPDT,".")
"RTN","PSADAI",18,0)
 S PSARPDT=$E(PSADT,4,5)_"/"_$E(PSADT,6,7)_"/"_$E(PSADT,2,3)_"@"_$P(PSARPDT,".",2)
"RTN","PSADAI",19,0)
 F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""  D  Q:PSAOUT
"RTN","PSADAI",20,0)
 .S PSAIEN=0 F  S PSAIEN=+$O(PSALOC(PSALOCN,PSAIEN)) Q:'PSAIEN  D  Q:PSAOUT
"RTN","PSADAI",21,0)
 ..S PSAISIT=+$P(PSALOC(PSALOCN,PSAIEN),"^"),PSAOSIT=+$P(PSALOC(PSALOCN,PSAIEN),"^",2)
"RTN","PSADAI",22,0)
 ..S PSAISITN=$S($P($G(^PS(59.4,PSAISIT,0)),"^")'="":$P($G(^PS(59.4,PSAISIT,0)),"^"),1:"UNKNOWN")
"RTN","PSADAI",23,0)
 ..S PSAOSITN=$S($P($G(^PS(59,PSAOSIT,0)),"^")'="":$P($G(^PS(59,PSAOSIT,0)),"^"),1:"UNKNOWN")
"RTN","PSADAI",24,0)
 ..S PSASITES=$S(PSAISIT&(PSAOSIT):PSAISITN_" (IP)  "_PSAOSITN_" (OP)",PSAISIT:PSAISITN_" (IP)",1:PSAOSITN_" (OP)")
"RTN","PSADAI",25,0)
 ..D COMPILE D:'PSAOUT DONE
"RTN","PSADAI",26,0)
EXIT D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q") W:$E(IOST,1,2)="C-" @IOF
"RTN","PSADAI",27,0)
EXIT1 K ^TMP($J,"PSADRG"),%ZIS,DIR,DIRUT,DTOUT
"RTN","PSADAI",28,0)
 K PSACHK,PSACNT,PSADRG,PSADT,PSAIEN,PSAINV,PSAISIT,PSAISITN,PSALEN,PSALINK,PSALNK,PSALOC,PSALOCA,PSALOCN,PSAOSIT,PSAOSITN
"RTN","PSADAI",29,0)
 K PSAOUT,PSAPG,PSARPDT,PSAS,PSASEL,PSASITES,PSASLN,PSASS,PSATMP,X,Y,ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSADAI",30,0)
 Q
"RTN","PSADAI",31,0)
COMPILE ;Creates ^TMP(Drug Name)= current balance ^ dispense unit ^ total inventory (current balance in 50)
"RTN","PSADAI",32,0)
 K ^TMP($J,"PSADRG")
"RTN","PSADAI",33,0)
 S PSADRG=0 F  S PSADRG=+$O(^PSD(58.8,PSAIEN,1,PSADRG)) Q:'PSADRG  D
"RTN","PSADAI",34,0)
 .Q:'$D(^PSDRUG(PSADRG,0))
"RTN","PSADAI",35,0)
 .S ^TMP($J,"PSADRG",$P(^PSDRUG(PSADRG,0),"^"))=$P($G(^PSD(58.8,PSAIEN,1,PSADRG,0)),"^",4)_"^"_$P($G(^PSDRUG(PSADRG,660)),"^",8)_"^"_$P($G(^PSDRUG(PSADRG,660.1)),"^")
"RTN","PSADAI",36,0)
PRINT ;Prints body of report
"RTN","PSADAI",37,0)
 ;Finds longest length of inventory link(s).
"RTN","PSADAI",38,0)
 S (PSALNK,PSALEN)=0 F  S PSALNK=+$O(^PSD(58.8,PSAIEN,4,PSALNK)) Q:'PSALNK  D
"RTN","PSADAI",39,0)
 .S PSALINK(+$P($G(^PSD(58.8,PSAIEN,4,PSALNK,0)),"^"))=""
"RTN","PSADAI",40,0)
 .S PSAINV="INVENTORY LINK: "_$S($P($G(^PRCP(445,PSALNK,0)),"^")'="":$P($G(^PRCP(445,PSALNK,0)),"^"),1:"NONE")
"RTN","PSADAI",41,0)
 .S:PSALEN<$L(PSAINV) PSALEN=$L(PSAINV)
"RTN","PSADAI",42,0)
 S PSAPG=0,PSADRG="" D HDR
"RTN","PSADAI",43,0)
 ;If no data in ^TMP, prints message & exit routine.
"RTN","PSADAI",44,0)
 S PSATMP=$O(^TMP($J,"PSADRG","")) I PSATMP="" W !!,"<< NO DRUGS WERE FOUND. >>",! G DONE
"RTN","PSADAI",45,0)
 ;If data is found, prints drug name, current balance, & dispense unit
"RTN","PSADAI",46,0)
 F  S PSADRG=$O(^TMP($J,"PSADRG",PSADRG)) Q:PSADRG=""  D  I PSAOUT W:$E(IOST,1,2)="C-" @IOF Q
"RTN","PSADAI",47,0)
 .D:$Y+4>IOSL HDR Q:PSAOUT
"RTN","PSADAI",48,0)
 .W !,PSADRG
"RTN","PSADAI",49,0)
 .S PSALEN=$L($P($P(^TMP($J,"PSADRG",PSADRG),"^"),".",2))
"RTN","PSADAI",50,0)
 .W ?(44+PSALEN),$J($FN($P(^TMP($J,"PSADRG",PSADRG),"^"),",",PSALEN),(10+PSALEN))
"RTN","PSADAI",51,0)
 .W:$P(^TMP($J,"PSADRG",PSADRG),"^",2)'="" ?61,$P(^TMP($J,"PSADRG",PSADRG),"^",2)
"RTN","PSADAI",52,0)
 .W ?69,$J($FN($P(^TMP($J,"PSADRG",PSADRG),"^",3),",",0),9)
"RTN","PSADAI",53,0)
 Q
"RTN","PSADAI",54,0)
DONE ;Holds screen or ejects paper if sent to printer
"RTN","PSADAI",55,0)
 I $E(IOST,1,2)="C-" D
"RTN","PSADAI",56,0)
 .S PSAS=22-$Y F PSASS=1:1:PSAS W !
"RTN","PSADAI",57,0)
 .S DIR(0)="EA",DIR("A")="End of display! Enter RETURN to continue or '^' to exit:" D ^DIR K DIR S:'Y PSAOUT=1
"RTN","PSADAI",58,0)
 W:$E(IOST)'="C" @IOF
"RTN","PSADAI",59,0)
 Q
"RTN","PSADAI",60,0)
HDR ;Print header
"RTN","PSADAI",61,0)
 S PSAPG=PSAPG+1
"RTN","PSADAI",62,0)
 I PSAPG=1,$E(IOST,1,2)="C-" W @IOF
"RTN","PSADAI",63,0)
 I PSAPG>1,$E(IOST)'="C" W @IOF
"RTN","PSADAI",64,0)
 I $E(IOST,1,2)="C-",PSAPG>1 D  Q:PSAOUT
"RTN","PSADAI",65,0)
 .S PSAS=22-$Y F PSASS=1:1:PSAS W !
"RTN","PSADAI",66,0)
 .S DIR(0)="E" D ^DIR K DIR W:'$G(DIRUT) @IOF S:'Y PSAOUT=1
"RTN","PSADAI",67,0)
 W:$E(IOST)'="C" !!,PSARPDT W:$E(IOST,1,2)="C-" !
"RTN","PSADAI",68,0)
 W ?21,"D R U G   A C C O U N T A B I L I T Y",?71,"Page ",$J(PSAPG,2)
"RTN","PSADAI",69,0)
 W !?24,"DRUG BALANCES BY LOCATION REPORT"
"RTN","PSADAI",70,0)
 W !?((80-$L(PSALOCN))/2),PSALOCN
"RTN","PSADAI",71,0)
 S PSALNK=0 F  S PSALNK=$O(PSALINK(PSALNK)) Q:'PSALNK  D
"RTN","PSADAI",72,0)
 .S PSAINV="INVENTORY LINK: "_$S($P($G(^PRCP(445,PSALNK,0)),"^")'="":$P($G(^PRCP(445,PSALNK,0)),"^"),1:"NONE")
"RTN","PSADAI",73,0)
 .W !?((80-$L(PSAINV))/2),PSAINV
"RTN","PSADAI",74,0)
 W !!?47,"CURRENT",?58,"DISPENSE",?72,"TOTAL"
"RTN","PSADAI",75,0)
 W !,"DRUG NAME",?47,"BALANCE",?60,"UNIT",?70,"INVENTORY",!,PSASLN
"RTN","PSADAI",76,0)
 Q
"RTN","PSADJR")
0^8^B20776516
"RTN","PSADJR",1,0)
PSADJR ;BIR/LTL,JMB-Balance Adjustments History ;8/21/97
"RTN","PSADJR",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSADJR",3,0)
 ;This routine reviews adjustment transactions for drugs.
"RTN","PSADJR",4,0)
 ;
"RTN","PSADJR",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSADJR",6,0)
 ;
"RTN","PSADJR",7,0)
LOOK ;Get locations to display
"RTN","PSADJR",8,0)
 S (PSACNT,PSAOUT)=0 D ^PSAUTL3 G:PSAOUT EXIT
"RTN","PSADJR",9,0)
 S PSACNT=0,PSACHK=$O(PSALOC(""))
"RTN","PSADJR",10,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT
"RTN","PSADJR",11,0)
 I '$O(^PSD(58.8,PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN S PSAOUT=1 G EXIT
"RTN","PSADJR",12,0)
 S DIC="^PSD(58.8,PSALOC,1,",DIC(0)="AEMQZ",DIC("A")="Select drug for history: ",DA(1)=PSALOC,DIC("W")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)'>DT,1:0) W $C(7),""   ***INACTIVE ***""" W !
"RTN","PSADJR",13,0)
 D ^DIC K DIC S PSA=+Y I PSA<0 S PSAOUT=1 G EXIT
"RTN","PSADJR",14,0)
 I '$O(^PSD(58.81,"F",+Y,"")) W !!,"There have been no adjustments for this drug.",!! S PSAOUT=1 G EXIT
"RTN","PSADJR",15,0)
 W ! S DIR(0)="D:AEP",DIR("A")="How far back in time do you want to go: ",DIR("B")="T-6M" D ^DIR K DIR I $D(DIRUT) S PSAOUT=1 G EXIT
"RTN","PSADJR",16,0)
 S PSAT=Y
"RTN","PSADJR",17,0)
DEV ;asks device and queueing info
"RTN","PSADJR",18,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" S PSAOUT=1 G EXIT
"RTN","PSADJR",19,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSADJR",ZTDESC="Drug Acct. - Drug adjustment review",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G EXIT
"RTN","PSADJR",20,0)
START ;compiles and prints output
"RTN","PSADJR",21,0)
 D SITES^PSAUTL1 S PSALOCN=$P(^PSD(58.8,PSALOC,0),"^")_PSACOMB
"RTN","PSADJR",22,0)
 S PSADRG=$P($G(^PSDRUG(PSA,0)),"^"),PSATAB=(80-$L(PSADRG))/2
"RTN","PSADJR",23,0)
 N %DT,PSASLN,PSAPG,PSAOUT,PSARPDT S (PSAPG,PSAOUT)=0,$P(PSASLN,"-",81)="",Y=DT D DD^%DT S PSARPDT=Y,PSAR=0 D HEADER
"RTN","PSADJR",24,0)
LOOP F  S PSAR=+$O(^PSD(58.81,"F",PSA,PSAR)) Q:'PSAR  I $P($G(^PSD(58.81,PSAR,0)),"^",4)'<PSAT,$P($G(^(0)),"^",2)=9!($P($G(^(0)),"^",2)=24),$P($G(^(0)),"^",3)=PSALOC D  Q:PSAOUT
"RTN","PSADJR",25,0)
 .I $P($G(^PSD(58.81,PSAR,0)),"^",2)=9,$Y+4>IOSL D HEADER Q:PSAOUT
"RTN","PSADJR",26,0)
 .I $P($G(^PSD(58.81,PSAR,0)),"^",2)=24,$Y+6>IOSL D HEADER Q:PSAOUT
"RTN","PSADJR",27,0)
 .S Y=$P($G(^PSD(58.81,PSAR,0)),"^",4) X ^DD("DD") W !,$E(Y,1,17)
"RTN","PSADJR",28,0)
 .W:$P($G(^PSD(58.81,PSAR,0)),"^",2)=9 ?22 W:$P($G(^PSD(58.81,PSAR,0)),"^",2)=24 ?30 W $J($P($G(^PSD(58.81,PSAR,0)),"^",6),5,0)
"RTN","PSADJR",29,0)
 .W ?37,$E($P($G(^VA(200,+$P($G(^PSD(58.81,PSAR,0)),"^",7),0)),"^"),1,20)
"RTN","PSADJR",30,0)
 .I $P($G(^PSD(58.81,PSAR,0)),"^",2)=9 W !?37,$P($G(^PSD(58.81,PSAR,0)),"^",16),! Q
"RTN","PSADJR",31,0)
 .S PSATRANL=$P($G(^PSD(58.81,+$P($G(^PSD(58.81,PSAR,0)),"^",17),0)),"^",3),PSAHOLD=PSALOC,PSAHOLDN=PSALOCN,PSALOC=PSATRANL
"RTN","PSADJR",32,0)
 .I PSALOC="" W !?37,"TRANSFER DATA MISSING",! S PSALOC=PSAHOLD,PSALOCN=PSAHOLDN Q
"RTN","PSADJR",33,0)
 .D SITES^PSAUTL1 S PSALOCN=$P(^PSD(58.8,PSALOC,0),"^")_PSACOMB
"RTN","PSADJR",34,0)
 .I $P($G(^PSD(58.81,PSAR,0)),"^",6)<0 W:$L(PSALOCN)<42 !?37,"TO "_PSALOCN,! I $L(PSALOCN)>43 S PSATF="T" W !?37,"TO " D TRAN
"RTN","PSADJR",35,0)
 .I $P($G(^PSD(58.81,PSAR,0)),"^",6)>0 W:$L(PSALOCN)<42 !?37,"FROM "_PSALOCN,! I $L(PSALOCN)>43 S PSATF="F" W !?37,"FROM " D TRAN
"RTN","PSADJR",36,0)
 .S PSALOC=PSAHOLD,PSALOCN=PSAHOLDN
"RTN","PSADJR",37,0)
EXIT W:$E(IOST)'="C" @IOF
"RTN","PSADJR",38,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) D
"RTN","PSADJR",39,0)
 .S PSASS=21-$Y F PSAKK=1:1:PSASS W !
"RTN","PSADJR",40,0)
 .S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR W @IOF
"RTN","PSADJR",41,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSADJR",42,0)
 K DA,DIC,DIR,DIRUT,DTOUT,DUOUT,PSA,PSACHK,PSACNT,PSACOMB,PSADRG,PSAHOLD,PSAHOLDN,PSAKK,PSALOC,PSALOCA,PSALOCN,PSAOUT,PSAR,PSASEL,PSASS,PSAT,PSATAB,PSATF,PSATRAN,PSATRANL,X,Y
"RTN","PSADJR",43,0)
 Q
"RTN","PSADJR",44,0)
HEADER ;prints header info
"RTN","PSADJR",45,0)
 I $E(IOST,1,2)="C-",PSAPG D  Q:PSAOUT
"RTN","PSADJR",46,0)
 .S PSASS=21-$Y F PSAKK=1:1:PSASS W !
"RTN","PSADJR",47,0)
 .S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSADJR",48,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),"^"),"." S PSAOUT=1
"RTN","PSADJR",49,0)
 W:$Y @IOF S PSAPG=PSAPG+1
"RTN","PSADJR",50,0)
 W:$E(IOST)'="C" !,PSARPDT,?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE"
"RTN","PSADJR",51,0)
 W !?22,"HISTORY OF ADJUSTMENTS AND TRANSFERS",?70,"PAGE: ",PSAPG,!
"RTN","PSADJR",52,0)
 W:$L(PSALOCN)>76 ?2,$P(PSALOCN,"(IP)",1)_"(IP)",!?19,$P(PSALOCN,"(IP)",2),! W:$L(PSALOCN)<77 ?((80-$L(PSALOCN))/2),PSALOCN,!?PSATAB,PSADRG,!
"RTN","PSADJR",53,0)
 I $P($G(^PSD(58.8,PSALOC,1,PSA,0)),"^",14),$P($G(^(0)),"^",14)'>DT W ?20,"** INACTIVE DRUG IN PHARMACY LOCATION **",!
"RTN","PSADJR",54,0)
 W !,"DATE",?22,"ADJUST",?30,"TRANS",?37,"TRANSACTOR & REASON",!,PSASLN
"RTN","PSADJR",55,0)
 Q
"RTN","PSADJR",56,0)
TRAN ;
"RTN","PSADJR",57,0)
 I $E(PSALOCN)="I" W $P($P(PSALOCN,":",2),"(IP)"),!
"RTN","PSADJR",58,0)
 I $E(PSALOCN)="O" W $P($P(PSALOCN,":",2),"(OP)"),!
"RTN","PSADJR",59,0)
 I $E(PSALOCN)="C" W "COMBINED:"_$P($P(PSALOCN,":",2),"(IP)",1)_"(IP)",! W:PSATF="T" ?49 W:PSATF="F" ?51 W $P($P(PSALOCN,":",2),"(IP)",2),!
"RTN","PSADJR",60,0)
 Q
"RTN","PSADRU")
0^9^B12771473
"RTN","PSADRU",1,0)
PSADRU ;BIR/LTL-Drugs Not Found in Linked Inventory ;7/23/97
"RTN","PSADRU",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSADRU",3,0)
 ;This routine reports the inventory/DA items.
"RTN","PSADRU",4,0)
 ;References to $$DESCR^PRCPUX1 are covered by IA #259
"RTN","PSADRU",5,0)
 ;References to $$INVNAME^PRCPUX1 are covered by IA #259
"RTN","PSADRU",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSADRU",7,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSADRU",8,0)
 ;
"RTN","PSADRU",9,0)
SETUP N D0,D1,DA,DIE,DIC,DIR,DIRUT,DLAYGO,DR,DTOUT,DUOUT,PSA,PSADRUG,PSAINV,PSAOUT,X,Y
"RTN","PSADRU",10,0)
 ;LOOK UP LOCATION
"RTN","PSADRU",11,0)
LOOK D ^PSADA I '$G(PSALOC) S PSAOUT=1 G QUIT
"RTN","PSADRU",12,0)
 I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN S PSAOUT=1 G QUIT
"RTN","PSADRU",13,0)
NOINV I '$O(^PSD(58.8,PSALOC,4,0)) W !,$G(PSALOCN)_" is not linked to an Inventory Point.",! D  G:$G(PSAOUT) QUIT
"RTN","PSADRU",14,0)
 .S DIR(0)="Y",DIR("A")="Would you like to attempt a link now",DIR("B")="Yes" D ^DIR K DIR S:Y'=1 PSAOUT=1 Q:Y'=1  D  I $D(Y) S PSAOUT=1 Q
"RTN","PSADRU",15,0)
INV ..S DIE=58.8,DA=PSALOC,DR="[PSAGIP]" D ^DIE K DIE
"RTN","PSADRU",16,0)
DEV K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G QUIT
"RTN","PSADRU",17,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSADRU",ZTDESC="DA Location items not found in Inventory",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSADRU",18,0)
START N %DT,PSALN,PSAIT,PSAL,PSAD,PSAPG,PSARPDT,X,Y S (PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y,PSAIT=0
"RTN","PSADRU",19,0)
 S PSA=0
"RTN","PSADRU",20,0)
 D HEADER
"RTN","PSADRU",21,0)
LOOP F  S PSA=$O(^PSD(58.8,+PSALOC,1,PSA)) Q:'PSA  D:$Y+6>IOSL HEADER Q:PSAOUT  D  Q:PSAOUT
"RTN","PSADRU",22,0)
 .W !!,$P($G(^PSDRUG(+PSA,0)),U)
"RTN","PSADRU",23,0)
 .S PSA(1)=$O(^PSDRUG(+PSA,441,0))
"RTN","PSADRU",24,0)
 .I 'PSA(1) W !!,"NOT CONNECTED TO THE ITEM MASTER FILE",!,PSALN Q
"RTN","PSADRU",25,0)
 .S PSA(2)=$G(^PSDRUG(+PSA,441,+PSA(1),0)),PSAINV=0
"RTN","PSADRU",26,0)
 .I '$O(^PSDRUG(+PSA,441,+PSA(1))) D  Q
"RTN","PSADRU",27,0)
 ..W !!,"CONNECTED TO: (",PSA(2),") ",$$DESCR^PRCPUX1(0,PSA(2))
"RTN","PSADRU",28,0)
 ..I '$O(^PRCP(445,"AE",+PSA(2),0)) W !!,"BUT NOT STOCKED BY AN INVENTORY POINT.",!,PSALN Q
"RTN","PSADRU",29,0)
 ..F  S PSAINV=$O(^PRCP(445,"AE",+PSA(2),PSAINV)) Q:'PSAINV  W !!,"AND STOCKED BY ",$$INVNAME^PRCPUX1(PSAINV),!,PSALN
"RTN","PSADRU",30,0)
 .W !!,"CONNECTED TO THE FOLLOWING ITEMS:"
"RTN","PSADRU",31,0)
 .S PSA(1)=0
"RTN","PSADRU",32,0)
 .F  S PSA(1)=$O(^PSDRUG(+PSA,441,PSA(1))) Q:'PSA(1)  D:$Y+6>IOSL HEADER Q:PSAOUT  D
"RTN","PSADRU",33,0)
 ..S PSA(2)=$G(^PSDRUG(+PSA,441,+PSA(1),0)),PSAINV=0
"RTN","PSADRU",34,0)
 ..W !!,"(",PSA(2),") ",$$DESCR^PRCPUX1(0,PSA(2))
"RTN","PSADRU",35,0)
 ..I '$O(^PRCP(445,"AE",+PSA(2),0)) W !!,"BUT NOT STOCKED BY AN INVENTORY POINT.",!,PSALN Q
"RTN","PSADRU",36,0)
 ..F  S PSAINV=$O(^PRCP(445,"AE",+PSA(2),PSAINV)) Q:'PSAINV  W !!,"AND STOCKED BY ",$$INVNAME^PRCPUX1(PSAINV),!,PSALN
"RTN","PSADRU",37,0)
QUIT I $E(IOST)'="C" W @IOF
"RTN","PSADRU",38,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSADRU",39,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSADRU",40,0)
 K PSAIT Q
"RTN","PSADRU",41,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSADRU",42,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSADRU",43,0)
 ;DAVE B found bug in next line while making changes for 
"RTN","PSADRU",44,0)
 ;PSA*3*25 because the value is a pointer not free text.
"RTN","PSADRU",45,0)
 D OPSITE^PSAUTL1 S PSAINV(2)=PSAOSITN
"RTN","PSADRU",46,0)
 ;S:$E(PSAINV(2),10)="(" PSAINV(2)=$E(PSAINV(2),1,8)
"RTN","PSADRU",47,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,PSAINV(2)_"'S Items Relationship to an Inventory Point",?56,PSARPDT,?70,"PAGE: "_PSAPG,!,PSALN
"RTN","PSADRU",48,0)
 Q
"RTN","PSAHIS")
0^10^B23525089
"RTN","PSAHIS",1,0)
PSAHIS ;BIR/LTL,JMB-Drug Transaction History ;7/23/97
"RTN","PSAHIS",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,15**; 10/24/97
"RTN","PSAHIS",3,0)
 ;This routine prints a report of all or specific drugs in a pharmacy
"RTN","PSAHIS",4,0)
 ;location for a user-specified number of days.
"RTN","PSAHIS",5,0)
 ;
"RTN","PSAHIS",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAHIS",7,0)
 ;
"RTN","PSAHIS",8,0)
LOC ;Gets locations & drugs to print
"RTN","PSAHIS",9,0)
 S (PSACNT,PSAOUT)=0 D ^PSAUTL3 G:PSAOUT EXIT1
"RTN","PSAHIS",10,0)
 S PSACNT=0,PSACHK=$O(PSALOC(""))
"RTN","PSAHIS",11,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT1
"RTN","PSAHIS",12,0)
 W ! S PSALOCN="" F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""!(PSAOUT)  S PSALOC=0 F  S PSALOC=$O(PSALOC(PSALOCN,PSALOC)) Q:'PSALOC!(PSAOUT)  D
"RTN","PSAHIS",13,0)
 .W @IOF W:$L(PSALOCN)>79 !,$P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<80 !,PSALOCN
"RTN","PSAHIS",14,0)
 .D DRUG Q:PSAOUT  Q:X["^A"
"RTN","PSAHIS",15,0)
 G:PSAOUT EXIT G DAYS
"RTN","PSAHIS",16,0)
DRUG ;Gets drugs to print
"RTN","PSAHIS",17,0)
 W !!,"You may select one, several, or ^ALL drugs."
"RTN","PSAHIS",18,0)
 F  S DIC="^PSD(58.8,"_+PSALOC_",1,",DIC(0)="AEMQ",DIC("A")="Select Drug: " D  Q:PSAOUT!(Y<0)!(X["^A")
"RTN","PSAHIS",19,0)
 .D ^DIC K DIC I X'["^A"&(Y<1)&('PSACNT) S PSAOUT=1 Q
"RTN","PSAHIS",20,0)
 .I X["^A" D ALL^PSAHIS1 Q
"RTN","PSAHIS",21,0)
 .Q:Y<0  I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAHIS",22,0)
 .S ^TMP("PSADRG",$J,PSALOC,$P($G(^PSDRUG(+Y,0)),"^"),+Y)="" S PSACNT=PSACNT+1
"RTN","PSAHIS",23,0)
 .I PSACNT=1,'$O(^PSD(58.81,"F",+$O(^TMP("PSADRG",$J,PSALOC,$P($G(^PSDRUG(+Y,0)),"^"),0)),0)) W !!,"There have been no transactions for this drug.",!
"RTN","PSAHIS",24,0)
 I '$D(PSALOC) W !!,"There are no drugs in all the selected location(s)." G EXIT
"RTN","PSAHIS",25,0)
 Q
"RTN","PSAHIS",26,0)
 ;
"RTN","PSAHIS",27,0)
DAYS G:$O(^TMP("PSADRG",$J,""))="" EXIT
"RTN","PSAHIS",28,0)
 S DIR(0)="D:AEP",DIR("A")="How many days back do you want to search for the drug: ",DIR("B")="T-6M",DIR("?")="I will list transactions for your selected drug(s) within the last six months if you press return" W ! D ^DIR K DIR
"RTN","PSAHIS",29,0)
 S PSABDT=Y G:$G(DIRUT) EXIT
"RTN","PSAHIS",30,0)
 ;
"RTN","PSAHIS",31,0)
DEV ;Asks device & queueing info
"RTN","PSAHIS",32,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" W !
"RTN","PSAHIS",33,0)
 D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSAHIS",34,0)
 I $D(IO("Q")) D  G EXIT
"RTN","PSAHIS",35,0)
 .N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSAHIS",36,0)
 .S ZTRTN="START^PSAHIS",ZTDESC="Drug Acct.-Drug Transaction History"
"RTN","PSAHIS",37,0)
 .S ZTSAVE("PSALOC(")="",ZTSAVE("PSABDT")="",ZTSAVE("^TMP(""PSADRG"",$J,")="" D ^%ZTLOAD
"RTN","PSAHIS",38,0)
 ;
"RTN","PSAHIS",39,0)
START ;Compiles & prints output data
"RTN","PSAHIS",40,0)
 S PSARPDT=$E($$HTFM^XLFDT($H),1,12),PSADT=$P(PSARPDT,"."),PSATM=$P(PSARPDT,".",2)
"RTN","PSAHIS",41,0)
 S PSARPDT=$E(PSADT,4,5)_"-"_$E(PSADT,6,7)_"-"_$E(PSADT,2,3),PSARUN=PSARPDT_"@"_PSATM
"RTN","PSAHIS",42,0)
 S PSADLN="=====================================|==========|=====|=====|==========|========"
"RTN","PSAHIS",43,0)
 S PSABDTR=$E(PSABDT,4,5)_"-"_$E(PSABDT,6,7)_"-"_$E(PSABDT,2,3),PSAOUT=0
"RTN","PSAHIS",44,0)
 S PSALOCN="" F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""  D  G:PSAOUT EXIT
"RTN","PSAHIS",45,0)
 .S PSALOC=0 F  S PSALOC=$O(PSALOC(PSALOCN,PSALOC)) Q:'PSALOC  D SITES^PSAUTL1,FIND Q:PSAOUT
"RTN","PSAHIS",46,0)
 ;
"RTN","PSAHIS",47,0)
EXIT W:$E(IOST,1,2)="C-" @IOF D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSAHIS",48,0)
 K IO("Q"),^TMP("PSA",$J),^TMP("PSADRG",$J),^TMP("PSAHIS",$J),PSALOC,PSALOCA,PSALOCN
"RTN","PSAHIS",49,0)
 ;G:'PSAOUT LOC
"RTN","PSAHIS",50,0)
EXIT1 K %ZIS,DIC,DIR,DIRUT,DTOUT,DUOUT,PSA50,PSABAD,PSABAD1,PSABAL,PSABDT,PSABDTR,PSACHK,PSACNT,PSACOMB,PSADJT,PSADJDT,PSADLN,PSADRG,PSADRUG,PSADT
"RTN","PSAHIS",51,0)
 K PSAFIRST,PSAHOLD,PSAHOLDN,PSAIPT,PSAISIT,PSAISITN,PSALN,PSALOC,PSALOCA,PSALOCN,PSANONE,PSAOPT,PSAOSIT,PSAOSITN,PSAOUT,PSAPC,PSAPC1,PSAPCS,PSAPG
"RTN","PSAHIS",52,0)
 K PSAREA,PSARECT,PSARPDT,PSARPDT,PSARUN,PSAS,PSASEL,PSASITES,PSASS,PSATM,PSATR,PSATR0,PSATRANL,PSATRCNT,PSAWRT,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSAHIS",53,0)
 Q
"RTN","PSAHIS",54,0)
FIND ;Finds drugs & puts in alpha order in ^TMP("PSAHIS",$J)
"RTN","PSAHIS",55,0)
 K ^TMP("PSAHIS",$J),^TMP("PSA",$J),PSAFIRST
"RTN","PSAHIS",56,0)
 S (PSACNT,PSAPG)=0,PSADRG=""
"RTN","PSAHIS",57,0)
 F  S PSADRG=$O(^TMP("PSADRG",$J,PSALOC,PSADRG)) Q:PSADRG=""  S (PSABAD,PSA50)=0 F  S PSA50=$O(^TMP("PSADRG",$J,PSALOC,PSADRG,PSA50)) Q:'PSA50  D
"RTN","PSAHIS",58,0)
 .;I '$G(PSATR),$O(^TMP("PSADRG",$J,PSALOC,PSADRG,0)) S PSA50=$O(^TMP("PSADRG",$J,PSALOC,PSADRG,0))
"RTN","PSAHIS",59,0)
 .S (PSAFIRST,PSATR)=0 F  S PSATR=+$O(^PSD(58.81,"F",PSA50,PSATR)) Q:'PSATR!(PSAOUT)  D  Q:PSAOUT
"RTN","PSAHIS",60,0)
 ..S PSATR0=$G(^PSD(58.81,PSATR,0)) Q:$P(PSATR0,"^",3)'=PSALOC
"RTN","PSAHIS",61,0)
 ..I $P(PSATR0,"^",4)'<PSABDT S ^TMP("PSAHIS",$J,PSADRG,$E($P(PSATR0,"^",4),1,7),PSATR)="" S:'PSAFIRST PSAFIRST=PSATR,^TMP("PSA",$J,PSADRG)=PSATR Q
"RTN","PSAHIS",62,0)
 ..I PSAFIRST,PSATR>PSAFIRST S PSABAD1=$S($P(PSATR0,"^",2)=2!($P(PSATR0,"^",2)=15)!($P(PSATR0,"^",2)=6):-$P(PSATR0,"^",6),1:$P(PSATR0,"^",6)) S PSABAD(PSADRG)=$G(PSABAD(PSADRG))+PSABAD1
"RTN","PSAHIS",63,0)
 I $D(^TMP("PSAHIS",$J)) D ^PSAHIS1 Q
"RTN","PSAHIS",64,0)
 I '$D(^TMP("PSAHIS",$J)) W !!,"No transactions were found for the pharmacy location." H 1
"RTN","PSAHIS",65,0)
 Q
"RTN","PSALEVRP")
0^11^B50917737
"RTN","PSALEVRP",1,0)
PSALEVRP ;BIR/LTL,JMB-Stock and Reorder Report ;7/23/97
"RTN","PSALEVRP",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSALEVRP",3,0)
 ;This routine prints a report of all drugs with their stock and reorder
"RTN","PSALEVRP",4,0)
 ;levels in a pharmacy location.
"RTN","PSALEVRP",5,0)
 ;
"RTN","PSALEVRP",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSALEVRP",7,0)
 ;
"RTN","PSALEVRP",8,0)
 D LOC G MASTER
"RTN","PSALEVRP",9,0)
 ;
"RTN","PSALEVRP",10,0)
 ;Gets locations
"RTN","PSALEVRP",11,0)
LOC S PSAOUT=0,PSALOC=+$O(^PSD(58.8,"ADISP","P",0))
"RTN","PSALEVRP",12,0)
 I 'PSALOC W !!?5,"No Drug Accountability location has been created yet." S PSAOUT=1 G MASTER
"RTN","PSALEVRP",13,0)
 ;
"RTN","PSALEVRP",14,0)
 ;Collect locations in alpha order
"RTN","PSALEVRP",15,0)
 S (PSACNT,PSALOC)=0 W !
"RTN","PSALEVRP",16,0)
 F  S PSALOC=+$O(^PSD(58.8,"ADISP","P",PSALOC)) Q:'PSALOC  D
"RTN","PSALEVRP",17,0)
 .Q:'$D(^PSD(58.8,PSALOC,0))!($P($G(^PSD(58.8,PSALOC,0)),"^")="")
"RTN","PSALEVRP",18,0)
 .I +$G(^PSD(58.8,PSALOC,"I")),+^PSD(58.8,PSALOC,"I")'>DT Q
"RTN","PSALEVRP",19,0)
 .Q:'$O(^PSD(58.8,PSALOC,1,0))  D SITES^PSAUTL1
"RTN","PSALEVRP",20,0)
 .S PSACNT=PSACNT+1
"RTN","PSALEVRP",21,0)
 .S PSALOCA($P(^PSD(58.8,PSALOC,0),"^")_PSACOMB,PSALOC)=$P(^(0),"^",3)_"^"_$P(^(0),"^",10)_"^"_+$G(^PSD(58.8,PSALOC,"I"))
"RTN","PSALEVRP",22,0)
 S PSACHK=$O(PSALOCA("")) I PSACHK="" G MASTER
"RTN","PSALEVRP",23,0)
 Q:$G(PSAHIS)&(PSACNT=1)
"RTN","PSALEVRP",24,0)
 ;
"RTN","PSALEVRP",25,0)
DISPLOC ;Displays the available pharmacy locations.
"RTN","PSALEVRP",26,0)
 W @IOF,!,"Choose one or many pharmacy locations:",!
"RTN","PSALEVRP",27,0)
 S PSACNT=0,PSALOCN=""
"RTN","PSALEVRP",28,0)
 F  S PSALOCN=$O(PSALOCA(PSALOCN)) Q:PSALOCN=""  D
"RTN","PSALEVRP",29,0)
 .S PSALOC=0 F  S PSALOC=$O(PSALOCA(PSALOCN,PSALOC)) Q:'PSALOC  D
"RTN","PSALEVRP",30,0)
 ..S PSACNT=PSACNT+1,PSAMENU(PSACNT,PSALOCN,PSALOC)=""
"RTN","PSALEVRP",31,0)
 ..W !,$J(PSACNT,2)
"RTN","PSALEVRP",32,0)
 ..W:$L(PSALOCN)>76 ?4,$P(PSALOCN,"(IP)",1)_"(IP)",!?21,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<77 ?4,PSALOCN
"RTN","PSALEVRP",33,0)
 ;
"RTN","PSALEVRP",34,0)
SELLOC W ! S DIR(0)="LO^1:"_PSACNT,DIR("A")="Select PHARMACY LOCATION",DIR("?")="Enter the number(s) of the Pharmacy Location",DIR("??")="^D HELP^PSAUTL3"
"RTN","PSALEVRP",35,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 G EXIT
"RTN","PSALEVRP",36,0)
 Q:Y=""&('$G(PSAHIS))  I Y="",$G(PSAHIS) S PSAOUT=1 Q
"RTN","PSALEVRP",37,0)
 S PSASEL=Y
"RTN","PSALEVRP",38,0)
 F PSAPC=1:1 S PSANUM=+$P(PSASEL,",",PSAPC) Q:'PSANUM  D
"RTN","PSALEVRP",39,0)
 .S PSALOCN=$O(PSAMENU(PSANUM,"")),PSALOC=$O(PSAMENU(PSANUM,PSALOCN,0))
"RTN","PSALEVRP",40,0)
 .S PSALOC(PSALOCN,PSALOC)=PSALOCA(PSALOCN,PSALOC)
"RTN","PSALEVRP",41,0)
 ;
"RTN","PSALEVRP",42,0)
 S PSACHK=$O(PSALOC(""))
"RTN","PSALEVRP",43,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT1
"RTN","PSALEVRP",44,0)
 W ! S PSALOCN="" F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""!(PSAOUT)  S PSALOC=0 F  S PSALOC=$O(PSALOC(PSALOCN,PSALOC)) Q:'PSALOC!(PSAOUT)  D
"RTN","PSALEVRP",45,0)
 .I '$O(^PSD(58.8,PSALOC,1,0)) D
"RTN","PSALEVRP",46,0)
 ..W:$L(PSALOCN)>79 !!,$P(PSALOCN,"(IP)",1)_"(IP)",!!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<80 !!,PSALOCN
"RTN","PSALEVRP",47,0)
 ..W !,"There are no drugs in the pharmacy location."
"RTN","PSALEVRP",48,0)
 Q
"RTN","PSALEVRP",49,0)
 ;
"RTN","PSALEVRP",50,0)
MASTER G:'$D(^XUSEC("PSA ORDERS",DUZ)) TEST S (PSAMVN,PSAMV)=0
"RTN","PSALEVRP",51,0)
 F  S PSAMV=+$O(^PSD(58.8,"ADISP","M",PSAMV)) Q:'PSAMV  D
"RTN","PSALEVRP",52,0)
 .I +$G(^PSD(58.8,PSAMV,"I")),+^PSD(58.8,PSAMV,"I")'>DT Q
"RTN","PSALEVRP",53,0)
 .S PSAMVN=PSAMVN+1,PSAMV($P(^PSD(58.8,PSAMV,0),"^"),PSAMV)=""
"RTN","PSALEVRP",54,0)
 G:'PSAMVN TEST
"RTN","PSALEVRP",55,0)
 ;
"RTN","PSALEVRP",56,0)
DISPMV ;Displays active master vaults
"RTN","PSALEVRP",57,0)
 W @IOF,!,"Choose one or many master vaults:",!
"RTN","PSALEVRP",58,0)
 S PSA=0,PSAMVA="" F  S PSAMVA=$O(PSAMV(PSAMVA)) Q:PSAMVA=""  D
"RTN","PSALEVRP",59,0)
 .S PSAMV=0 F  S PSAMV=$O(PSAMV(PSAMVA,PSAMV)) Q:'PSAMV  D
"RTN","PSALEVRP",60,0)
 ..S PSA=PSA+1,PSAVAULT(PSA,PSAMVA,PSAMV)="" W !,$J(PSA,2)_".",?4,PSAMVA
"RTN","PSALEVRP",61,0)
 K PSAMV
"RTN","PSALEVRP",62,0)
 ;
"RTN","PSALEVRP",63,0)
SELMV ;Select displayed master vaults
"RTN","PSALEVRP",64,0)
 W ! S DIR(0)="LO^1:"_PSA,DIR("A")="Select Master Vault",DIR("?")="Select the Master Vault that received the invoice's drugs",DIR("??")="^D MV^PSAPROC"
"RTN","PSALEVRP",65,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSALEVRP",66,0)
 G:Y="" TEST S PSASEL=Y
"RTN","PSALEVRP",67,0)
 F PSAPC=1:1 S PSA=+$P(PSASEL,",",PSAPC) Q:'PSA  D
"RTN","PSALEVRP",68,0)
 .S PSAMVA="",PSAMVA=$O(PSAVAULT(PSA,PSAMVA)) Q:PSAMVA=""
"RTN","PSALEVRP",69,0)
 .S PSAMVIEN=+$O(PSAVAULT(PSA,PSAMVA,0)) Q:'PSAMVIEN
"RTN","PSALEVRP",70,0)
 .S PSAMAST(PSAMVA,PSAMVIEN)=""
"RTN","PSALEVRP",71,0)
 K PSAVAULT
"RTN","PSALEVRP",72,0)
 ;
"RTN","PSALEVRP",73,0)
TEST G:PSAOUT EXIT
"RTN","PSALEVRP",74,0)
 S PSA=$O(PSALOC("")),PSAMV=$O(PSAMAST(""))
"RTN","PSALEVRP",75,0)
 I PSA="",PSAMV="" G EXIT
"RTN","PSALEVRP",76,0)
 ;
"RTN","PSALEVRP",77,0)
DEV ;Asks device & queueing info
"RTN","PSALEVRP",78,0)
 W !!,"Each pharmacy location can contain all drugs in the DRUG file. Therefore,",!,"this report could be very long. It is advised to queue the report to run",!,"during non-critical hours.",!
"RTN","PSALEVRP",79,0)
 K IO("Q") K %ZIS,IOP,POP S %ZIS="Q",%ZIS("B")=""
"RTN","PSALEVRP",80,0)
 D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSALEVRP",81,0)
 I $D(IO("Q")) D  G EXIT
"RTN","PSALEVRP",82,0)
 .N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSALEVRP",83,0)
 .S ZTRTN="COMPILE^PSALEVRP",ZTDESC="Drug Acct. - Stock and Reorder Report"
"RTN","PSALEVRP",84,0)
 .S:PSA'="" ZTSAVE("PSALOC(")="" S:PSAMV'="" ZTSAVE("PSAMAST(")=""
"RTN","PSALEVRP",85,0)
 .D ^%ZTLOAD
"RTN","PSALEVRP",86,0)
 ;
"RTN","PSALEVRP",87,0)
COMPILE ;Compiles data
"RTN","PSALEVRP",88,0)
 S PSA=$O(PSALOC("")) G:PSA="" MV
"RTN","PSALEVRP",89,0)
 S PSALOCN="" F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""  D
"RTN","PSALEVRP",90,0)
 .S PSALOC=0 F  S PSALOC=$O(PSALOC(PSALOCN,PSALOC)) Q:'PSALOC  D
"RTN","PSALEVRP",91,0)
 ..S PSADRG=0 F  S PSADRG=+$O(^PSD(58.8,PSALOC,1,PSADRG)) Q:'PSADRG  D
"RTN","PSALEVRP",92,0)
 ...Q:'$D(^PSD(58.8,PSALOC,1,PSADRG,0))!($P($G(^PSDRUG(PSADRG,0)),"^")="")
"RTN","PSALEVRP",93,0)
 ...S ^TMP("PSALEV",$J,1,PSALOC,$P(^PSDRUG(PSADRG,0),"^"))=+$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3)_"^"_+$P(^(0),"^",5)
"RTN","PSALEVRP",94,0)
 ;
"RTN","PSALEVRP",95,0)
MV S PSA=$O(PSAMAST("")) G:PSA="" PRINT
"RTN","PSALEVRP",96,0)
 S PSAMVN="" F  S PSAMVN=$O(PSAMAST(PSAMVN)) Q:PSAMVN=""  D
"RTN","PSALEVRP",97,0)
 .S PSAMV=0 F  S PSAMV=$O(PSAMAST(PSAMVN,PSAMV)) Q:'PSAMV  D
"RTN","PSALEVRP",98,0)
 ..S PSADRG=0 F  S PSADRG=+$O(^PSD(58.8,PSAMV,1,PSADRG)) Q:'PSADRG  D
"RTN","PSALEVRP",99,0)
 ...Q:'$D(^PSD(58.8,PSAMV,1,PSADRG,0))!($P($G(^PSDRUG(PSADRG,0)),"^")="")
"RTN","PSALEVRP",100,0)
 ...S ^TMP("PSALEV",$J,2,PSAMV,$P(^PSDRUG(PSADRG,0),"^"))=+$P(^PSD(58.8,PSAMV,1,PSADRG,0),"^",3)_"^"_+$P(^(0),"^",5)
"RTN","PSALEVRP",101,0)
 ;
"RTN","PSALEVRP",102,0)
PRINT ;Prints report
"RTN","PSALEVRP",103,0)
 D NOW^%DTC S PSARUN=%,PSARUN=$E(PSARUN,4,5)_"/"_$E(PSARUN,6,7)_"/"_$E(PSARUN,2,3)_"@"_$E($P(PSARUN,".",2),1,2)_":"_$E($P(PSARUN,".",2),3,4)
"RTN","PSALEVRP",104,0)
 S PSAPG=0,PSASLN="",$P(PSASLN,"-",80)="",PSAOUT=0 K Y
"RTN","PSALEVRP",105,0)
 S PSAFIRST=1,PSALOC=0 F  S PSALOC=+$O(^TMP("PSALEV",$J,1,PSALOC)) Q:'PSALOC!(PSAOUT)  D
"RTN","PSALEVRP",106,0)
 .D SITES^PSAUTL1 S PSALOCN=$P(^PSD(58.8,PSALOC,0),"^")_PSACOMB
"RTN","PSALEVRP",107,0)
 .I PSAFIRST D HDR Q:PSAOUT  S PSAFIRST=0
"RTN","PSALEVRP",108,0)
 .S PSADRG="" F  S PSADRG=$O(^TMP("PSALEV",$J,1,PSALOC,PSADRG)) Q:PSADRG=""!(PSAOUT)  D
"RTN","PSALEVRP",109,0)
 ..I $Y+5>IOSL D HDR Q:PSAOUT
"RTN","PSALEVRP",110,0)
 ..S PSASTOCK=$P(^TMP("PSALEV",$J,1,PSALOC,PSADRG),"^"),PSAREORD=$P(^(PSADRG),"^",2)
"RTN","PSALEVRP",111,0)
 ..W !,PSADRG
"RTN","PSALEVRP",112,0)
 ..W ?(45-$L($P(PSASTOCK,".",2))),$J(PSASTOCK,9,+$L($P(PSASTOCK,".",2)))
"RTN","PSALEVRP",113,0)
 ..W ?(67-$L($P(PSAREORD,".",2))),$J(PSAREORD,9,+$L($P(PSAREORD,".",2)))
"RTN","PSALEVRP",114,0)
 ;
"RTN","PSALEVRP",115,0)
 S PSA=$O(^TMP("PSALEV",$J,2,"")) G:PSA="" EXIT
"RTN","PSALEVRP",116,0)
 S PSAFIRST=1,PSAMV=0
"RTN","PSALEVRP",117,0)
 F  S PSAMV=+$O(^TMP("PSALEV",$J,2,PSAMV)) Q:'PSAMV!(PSAOUT)  D  S PSAFIRST=1
"RTN","PSALEVRP",118,0)
 .I PSAFIRST D HDR Q:PSAOUT  S PSAFIRST=0
"RTN","PSALEVRP",119,0)
 .S PSADRG="" F  S PSADRG=$O(^TMP("PSALEV",$J,2,PSAMV,PSADRG)) Q:PSADRG=""!(PSAOUT)  D
"RTN","PSALEVRP",120,0)
 ..I $Y+5>IOSL D HDR Q:PSAOUT
"RTN","PSALEVRP",121,0)
 ..S PSASTOCK=$P(^TMP("PSALEV",$J,2,PSAMV,PSADRG),"^"),PSAREORD=$P(^(PSADRG),"^",2)
"RTN","PSALEVRP",122,0)
 ..W !,PSADRG
"RTN","PSALEVRP",123,0)
 ..W ?(45-$L($P(PSASTOCK,".",2))),$J(PSASTOCK,9,+$L($P(PSASTOCK,".",2)))
"RTN","PSALEVRP",124,0)
 ..W ?(67-$L($P(PSAREORD,".",2))),$J(PSAREORD,9,+$L($P(PSAREORD,".",2)))
"RTN","PSALEVRP",125,0)
 I 'PSAOUT,$E(IOST,1,2)="C-" S PSAOUT=1 D END^PSAPROC G:PSAOUT EXIT1
"RTN","PSALEVRP",126,0)
 ;
"RTN","PSALEVRP",127,0)
EXIT W:$E(IOST,1,2)="C-" @IOF D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSALEVRP",128,0)
EXIT1 K IO("Q"),^TMP("PSALEV",$J)
"RTN","PSALEVRP",129,0)
 K %,%ZIS,DIR,DTOUT,DUOUT,PSA,PSACHK,PSACNT,PSACOMB,PSADRG,PSAFIRST,PSAISIT,PSAISITN,PSALOC,PSALOCA,PSALOCN,PSAMAST,PSAMENU,PSAMV,PSAMVA,PSAMVIEN,PSAMVN
"RTN","PSALEVRP",130,0)
 K PSANUM,PSAOSIT,PSAOSITN,PSAOUT,PSAPC,PSAPG,PSAREORD,PSARUN,PSASEL,PSASLN,PSASTOCK,PSAVAULT,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSALEVRP",131,0)
 Q
"RTN","PSALEVRP",132,0)
 ;
"RTN","PSALEVRP",133,0)
HDR ;Report header
"RTN","PSALEVRP",134,0)
 I $E(IOST,1,2)="C-" W:'PSAPG @IOF D:+PSAPG END^PSAPROC Q:PSAOUT
"RTN","PSALEVRP",135,0)
 I $E(IOST)'="C",+PSAPG W @IOF
"RTN","PSALEVRP",136,0)
 S PSAPG=PSAPG+1
"RTN","PSALEVRP",137,0)
 W !?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE",?72,"PAGE "_PSAPG
"RTN","PSALEVRP",138,0)
 W !?25,"STOCK AND REORDER LEVEL REPORT",!
"RTN","PSALEVRP",139,0)
 I $E(IOST)'="C" W "RUN: "_PSARUN
"RTN","PSALEVRP",140,0)
 I $G(PSALOC) W ?31,"PHARMACY LOCATION" W:$L(PSALOCN)>79 !!,$P(PSALOCN,"(IP)",1)_"(IP)",!!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<80 !!,PSALOCN
"RTN","PSALEVRP",141,0)
 I $G(PSAMV) W !,"MASTER VAULT: "_$P($G(^PSD(58.8,PSAMV,0)),"^")
"RTN","PSALEVRP",142,0)
 W !!,"DRUG",?43,"STOCK LEVEL",?63,"REORDER LEVEL",!,PSASLN
"RTN","PSALEVRP",143,0)
 Q
"RTN","PSALFA")
0^12^B16077100
"RTN","PSALFA",1,0)
PSALFA ;BIR/LTL-Automated DRUG/ITEM MASTER file Link by FSN ;7/23/97
"RTN","PSALFA",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSALFA",3,0)
 ;This routine automatically loops by FSN.
"RTN","PSALFA",4,0)
 ;References to $$DESCR^PRCPUX1 are covered by IA #259
"RTN","PSALFA",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSALFA",6,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSALFA",7,0)
 ;References to ^PSDRUG("AB" are covered by IA #2095
"RTN","PSALFA",8,0)
 ;
"RTN","PSALFA",9,0)
 D DT^DICRW
"RTN","PSALFA",10,0)
START ;sets up edit loop
"RTN","PSALFA",11,0)
 N D0,D1,DA,DIC,DIE,DLAYGO,DR,DTOUT,DUOUT,DIR,DIRUT,PSAD,PSADD,PSAF,PSAFSN,PSAIT,PSALN,PSAOUT,PSARPDT,PSAPG,X,Y
"RTN","PSALFA",12,0)
QUES S DIR(0)="Y",DIR("A")="Have you run the Report Potential FSN Matches option",DIR("??")="^D RUN^PSALFA",PSAOUT=1 D ^DIR K DIR G:$D(DIRUT) QUIT D:'Y
"RTN","PSALFA",13,0)
 .S DIR(0)="Y",DIR("A")="Would you like to run the report now",DIR("B")="Yes" D ^DIR K DIR D:Y ^PSALFS
"RTN","PSALFA",14,0)
 S DIR(0)="Y",DIR("A")="Are you ready to link ALL of the drugs that have matches in the ITEM MASTER file",DIR("B")="No" D ^DIR K DIR G:'Y QUIT
"RTN","PSALFA",15,0)
DEV ;asks device and queueing info
"RTN","PSALFA",16,0)
 W !,"I'll list each DRUG/ITEM MASTER file entry as they're linked.",!
"RTN","PSALFA",17,0)
 K IO("Q") N %ZIS,%ZIS,IOP,POP S %ZIS="Q",%ZIS("A")="Please select DEVICE for output: " D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G QUIT
"RTN","PSALFA",18,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LOOP^PSALFA",ZTDESC="Linking DRUG/ITEM FILE by FSN" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSALFA",19,0)
LOOP S (PSAD,PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y,Y=1 D HEADER
"RTN","PSALFA",20,0)
 F  S PSAD=$O(^PSDRUG(PSAD)) G:'PSAD QUIT D:$Y+4>IOSL HEADER G:PSAOUT QUIT I $P($G(^PSDRUG(PSAD,0)),U,6)]"",'$O(^PSDRUG(PSAD,441,0)),'$D(^PSDRUG(PSAD,"I")) D
"RTN","PSALFA",21,0)
FORM .S PSAFSN=$P(^PSDRUG(PSAD,0),U,6) W !,PSAFSN D
"RTN","PSALFA",22,0)
 ..I $O(^PRC(441,"BB",PSAFSN,0)) N PSADD S PSAIT=$O(^PRC(441,"BB",PSAFSN,0)) D  W !,$E($P(^PSDRUG(PSAD,0),U),1,39),?40,$E($$DESCR^PRCPUX1(0,PSAIT),1,39),! D:'$D(PSADD) LINK
"RTN","PSALFA",23,0)
USED ...I $O(^PSDRUG("AB",PSAIT,"")) S PSADD=$O(^PSDRUG("AB",PSAIT,"")) W !,"**"_$P(^PSDRUG(PSADD,0),U)_" is already linked to Item #"_PSAIT_"**"
"RTN","PSALFA",24,0)
INAC ...I $E($G(^PRC(441,PSAIT,3)),1)=1 W !,"Sorry, Item #"_PSAIT_" is INACTIVE, can't link.",! S PSADD=""
"RTN","PSALFA",25,0)
QUIT W:$E(IOST)'="C" @IOF
"RTN","PSALFA",26,0)
 I $E(IOST,1,2)="C-",'PSAOUT W !! S DIR(0)="E",DIR("A")="END OF REPORT!  Press <RET> to return to the menu" D ^DIR
"RTN","PSALFA",27,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q") Q
"RTN","PSALFA",28,0)
LINK S DIE=50,DA=PSAD,DR="441///^S X=PSAIT" D ^DIE W "Linked to Item #"_PSAIT Q
"RTN","PSALFA",29,0)
HEADER ;prints header info
"RTN","PSALFA",30,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSALFA",31,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSALFA",32,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !?2,"Linking DRUG/ITEM MASTER file by FSN",?55,PSARPDT,?70,"PAGE: "_PSAPG,!,PSALN,!,"DRUG file",?40,"ITEM MASTER file"
"RTN","PSALFA",33,0)
 Q
"RTN","PSALFA",34,0)
READY ;Extended help for 'Have you run the Report Potential FSN Matches option?'
"RTN","PSALFA",35,0)
 W !?5,"Enter YES to begin linking every drug that has been matched.",!?5,"Enter NO to exit the option."
"RTN","PSALFA",36,0)
 Q
"RTN","PSALFA",37,0)
RUN ;Extended help to 'Have you run the Report Potential FSN Matches option?'
"RTN","PSALFA",38,0)
 W !?5,"Enter YES if you have run the Report Potential FSN Matches option",!?5,"and produced a report.",!!?5,"Enter NO if you have not run the option.  You will be given the",!?5,"opportunity to run the report now."
"RTN","PSALFA",39,0)
 Q 
"RTN","PSALFS")
0^13^B9805018
"RTN","PSALFS",1,0)
PSALFS ;BIR/LTL-Report Potential FSN Matches ;7/23/97
"RTN","PSALFS",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSALFS",3,0)
 ;
"RTN","PSALFS",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSALFS",5,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSALFS",6,0)
 ;References to ^PSDRUG("AB" are covered by IA #2095
"RTN","PSALFS",7,0)
 ;
"RTN","PSALFS",8,0)
 D DT^DICRW
"RTN","PSALFS",9,0)
DEV ;asks device and queueing info
"RTN","PSALFS",10,0)
 K IO("Q") N %ZIS,DTOUT,DUOUT,IOP,POP,PSAOUT S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G QUIT
"RTN","PSALFS",11,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSALFS",ZTDESC="Unlinked DRUG/ITEM FILE matches by FSN" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSALFS",12,0)
START ;compiles and prints data for report
"RTN","PSALFS",13,0)
 N DIR,DIRUT,PSAPG,POP,PSA,PSAD,PSADD,PSAF,PSAFSN,PSAIT,PSALN,PSARPDT,X,Y S (PSA,PSAD,PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y D HEADER
"RTN","PSALFS",14,0)
LOOP F  S PSAD=$O(^PSDRUG(PSAD)) G:'PSAD QUIT D:$Y+4>IOSL HEADER G:PSAOUT QUIT I $P($G(^PSDRUG(PSAD,0)),U,6)]"",'$O(^PSDRUG(PSAD,441,0)),'$D(^PSDRUG(PSAD,"I")) D
"RTN","PSALFS",15,0)
 .W !!,$P($G(^PSDRUG(+PSAD,0)),U),!
"RTN","PSALFS",16,0)
FORM .S PSAFSN=$P(^PSDRUG(PSAD,0),U,6) W !,PSAFSN S PSAIT=$O(^PRC(441,"BB",PSAFSN,0)) W:'PSAIT ?40,"No matching NSN in ITEM MASTER file" Q:'PSAIT  D
"RTN","PSALFS",17,0)
 ..D
"RTN","PSALFS",18,0)
USED ...I $O(^PSDRUG("AB",PSAIT,"")) S PSADD=$O(^PSDRUG("AB",PSAIT,"")) W !,"**"_$P(^PSDRUG(PSADD,0),U)_" is already linked to Item #"_PSAIT_"**"
"RTN","PSALFS",19,0)
 ...W ?40,"ITEM Number:  "_PSAIT,!
"RTN","PSALFS",20,0)
 ..I $L($G(^PRC(441,+PSAIT,1,1,0)))<40,'$O(^PRC(441,+PSAIT,1,1)) W ?40,$G(^PRC(441,+PSAIT,1,1,0)),! Q
"RTN","PSALFS",21,0)
 ..K ^UTILITY($J,"W") S DIWL=40,DIWR=80,DIWF="W"
"RTN","PSALFS",22,0)
 ..F  S PSA=$O(^PRC(441,+PSAIT,1,PSA)) Q:'PSA  S X=$G(^PRC(441,+PSAIT,1,PSA,0)) D ^DIWP
"RTN","PSALFS",23,0)
 ..D ^DIWW S PSA=0
"RTN","PSALFS",24,0)
QUIT I $E(IOST)'="C" W @IOF
"RTN","PSALFS",25,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSALFS",26,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSALFS",27,0)
 Q
"RTN","PSALFS",28,0)
HEADER ;prints header info
"RTN","PSALFS",29,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSALFS",30,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSALFS",31,0)
 W:$Y @IOF S $P(PSALN,"*",81)="",PSAPG=PSAPG+1 W !?2,"Unlinked DRUG/ITEM MASTER file entries by common FSN",?55,PSARPDT,?70,"PAGE: "_PSAPG,!,PSALN,!,"DRUG file FSN",?40,"ITEM MASTER file"
"RTN","PSALFS",32,0)
 Q
"RTN","PSALNA")
0^14^B17184229
"RTN","PSALNA",1,0)
PSALNA ;BIR/LTL-Automated DRUG/ITEM MASTER file Link by NDC ;7/23/97
"RTN","PSALNA",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSALNA",3,0)
 ;
"RTN","PSALNA",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSALNA",5,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSALNA",6,0)
 ;References to ^PSDRUG("AB" are covered by IA #2095
"RTN","PSALNA",7,0)
 ;
"RTN","PSALNA",8,0)
 D DT^DICRW
"RTN","PSALNA",9,0)
START ;sets up edit loop
"RTN","PSALNA",10,0)
 N D0,D1,DA,DIC,DIE,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSAD,PSADD,PSAIT,PSALN,PSAOUT,PSAPG,PSARPDT,X,Y
"RTN","PSALNA",11,0)
QUES S DIR(0)="Y",DIR("A")="Have you run the Report Potential NDC Matches option",DIR("??")="^D RUN^PSALNA",PSAOUT=1 D ^DIR K DIR G:$D(DIRUT) QUIT D:Y<1  G:PSAOUT QUIT
"RTN","PSALNA",12,0)
 .S DIR(0)="Y",DIR("A")="Would you like to run the report now",DIR("B")="YES",DIR("??")="^D NOW^PSALNA" D ^DIR K DIR S:$G(DIRUT) PSAOUT=1 I Y D ^PSALND S PSAOUT=0
"RTN","PSALNA",13,0)
 W ! S DIR(0)="Y",DIR("A",1)="Are you ready to link ALL of the drugs",DIR("A")="that have matches in the ITEM MASTER file",DIR("B")="N",DIR("??")="^D READY^PSALNA"
"RTN","PSALNA",14,0)
 D ^DIR K DIR G:'Y!($G(DIRUT)) QUIT
"RTN","PSALNA",15,0)
DEV ;asks device and queueing info
"RTN","PSALNA",16,0)
 W !!,"I'll list each DRUG/ITEM MASTER file entry as they're linked.",!
"RTN","PSALNA",17,0)
 K IO("Q") N %ZIS,%ZIS,IOP,POP S %ZIS="Q",%ZIS("A")="Please select DEVICE for output: " D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G QUIT
"RTN","PSALNA",18,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LOOP^PSALNA",ZTDESC="Linking DRUG/ITEM FILE by NDC" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSALNA",19,0)
LOOP S (PSAD,PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y,Y=1 D HEADER
"RTN","PSALNA",20,0)
 F  K PSADD S PSAD=$O(^PSDRUG(PSAD)) G:'PSAD QUIT D:$Y+4>IOSL HEADER G:PSAOUT QUIT W:'(PSAD#100) "." I $P($G(^PSDRUG(PSAD,2)),U,4)]"" S PSAD(1)=$P($G(^(2)),U,4) D:'$D(^PSDRUG(PSAD,"I"))
"RTN","PSALNA",21,0)
 .S PSAIT=$$ITEM^PSAUTL(PSAD(1)) Q:'PSAIT  I $D(^PRC(441,+PSAIT,0)) D  Q:$D(PSADD)  W !,$E($P(^PSDRUG(PSAD,0),U),1,39),?40,$E($P(^PRC(441,PSAIT,0),U,2),1,39),!
"RTN","PSALNA",22,0)
NOT ..S:$O(^PSDRUG("AB",PSAIT,"")) PSADD="" I $D(^PRC(441,PSAIT,3)),$P(^(3),U)=1 S PSADD=""
"RTN","PSALNA",23,0)
OK .I '$D(PSADD) S DIE=50,DA=PSAD,DR="441///^S X=PSAIT" D ^DIE W "Linked to Item #"_PSAIT
"RTN","PSALNA",24,0)
QUIT I $E(IOST)'="C" W @IOF
"RTN","PSALNA",25,0)
 I $E(IOST,1,2)="C-",'PSAOUT W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSALNA",26,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q") Q
"RTN","PSALNA",27,0)
HEADER ;prints header info
"RTN","PSALNA",28,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSALNA",29,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSALNA",30,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !?2,"Linking DRUG/ITEM MASTER file by NDC",?55,PSARPDT,?70,"PAGE: "_PSAPG,!,PSALN,!,"DRUG file",?40,"ITEM MASTER file"
"RTN","PSALNA",31,0)
 Q
"RTN","PSALNA",32,0)
NOW ;Extended help to 'Would you like to run the report now?'
"RTN","PSALNA",33,0)
 W !?5,"Enter YES if you want to print the report now.",!!?5,"Enter NO if you do not want to run the report now.",!?5,"You will not exit the option."
"RTN","PSALNA",34,0)
 Q
"RTN","PSALNA",35,0)
READY ;Extended help to 'Are you ready to link ALL of the drugs that have matches in the ITEM MASTER file?'
"RTN","PSALNA",36,0)
 W !?5,"Enter YES to begin linking every drug that has been matched.",!?5,"Enter NO to exit the option."
"RTN","PSALNA",37,0)
 Q
"RTN","PSALNA",38,0)
RUN ;Extended help to 'Have you run the Report Potential NDC Matches option?'
"RTN","PSALNA",39,0)
 W !?5,"Enter YES if you have run the Report Potential NDC Matches option",!?5,"and produced a report.",!!?5,"Enter NO if you have not run the option. You will be given the",!?5,"opportunity to run the report now."
"RTN","PSALNA",40,0)
 Q 
"RTN","PSALND")
0^15^B10110084
"RTN","PSALND",1,0)
PSALND ;BIR/LTL-Report Potential NDC Matches ;7/23/97
"RTN","PSALND",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSALND",3,0)
 ;
"RTN","PSALND",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSALND",5,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSALND",6,0)
 ;References to ^PSDRUG("AB" are covered by IA #2095
"RTN","PSALND",7,0)
 D DT^DICRW
"RTN","PSALND",8,0)
DEV ;asks device and queueing info
"RTN","PSALND",9,0)
 K IO("Q") N %ZIS,DIR,DTOUT,DUOUT,IOP,POP,PSAOUT S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G QUIT
"RTN","PSALND",10,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSALND",ZTDESC="Unlinked DRUG/ITEM FILE matches by NDC" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSALND",11,0)
START ;compiles and prints data for report
"RTN","PSALND",12,0)
 N DIRUT,PSAPG,POP,PSA,PSAB,PSAD,PSADD,PSAIT,PSALN,PSARPDT,X,Y S (PSA,PSAD,PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y D HEADER
"RTN","PSALND",13,0)
LOOP F  S PSAD=$O(^PSDRUG(PSAD)) G:'PSAD QUIT D:$Y+7>IOSL HEADER G:PSAOUT QUIT W:'(PSAD#100) "." I $P($G(^PSDRUG(PSAD,2)),U,4)]"" S PSAD(1)=$P($G(^(2)),U,4) D:'$D(^PSDRUG(PSAD,"I"))  G:$G(PSAOUT) QUIT
"RTN","PSALND",14,0)
 .S PSAIT=$$ITEM^PSAUTL(PSAD(1))
"RTN","PSALND",15,0)
 .Q:'PSAIT!($O(^PSDRUG(PSAD,441,"B",+PSAIT,0)))
"RTN","PSALND",16,0)
 .I $D(^PRC(441,PSAIT,0)) D:$O(^PSDRUG("AB",PSAIT,0))
"RTN","PSALND",17,0)
USED ..S PSADD=$O(^PSDRUG("AB",PSAIT,"")) W !,"**"_$P(^PSDRUG(PSADD,0),U)_" is already linked to Item #"_PSAIT_"**"
"RTN","PSALND",18,0)
 .W !!,"NDC:  "_$P(^PSDRUG(PSAD,2),U,4),?40,"Item Number:  "_$P(^PRC(441,PSAIT,0),U),!
"RTN","PSALND",19,0)
 .W !,$E($P(^PSDRUG(PSAD,0),U),1,39)
"RTN","PSALND",20,0)
 .I $L($G(^PRC(441,+PSAIT,1,1,0)))<40,'$O(^PRC(441,+PSAIT,1,1)) W ?40,$G(^PRC(441,+PSAIT,1,1,0)) Q
"RTN","PSALND",21,0)
 .K ^UTILITY($J,"W") S DIWL=40,DIWR=80,DIWF="W"
"RTN","PSALND",22,0)
 .F  S PSA=$O(^PRC(441,+PSAIT,1,+PSA)) Q:'PSA  S X=$G(^PRC(441,+PSAIT,1,+PSA,0)) D:$Y+3>IOSL HEADER Q:$G(PSAOUT)  D ^DIWP D ^DIWW
"RTN","PSALND",23,0)
 .S PSA=0
"RTN","PSALND",24,0)
QUIT I $E(IOST)'="C" W @IOF
"RTN","PSALND",25,0)
 I $E(IOST,1,2)="C-",'PSAOUT W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSALND",26,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSALND",27,0)
 Q
"RTN","PSALND",28,0)
HEADER ;prints header info
"RTN","PSALND",29,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSALND",30,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSALND",31,0)
 W:$Y @IOF S $P(PSALN,"*",81)="",PSAPG=PSAPG+1 W !?2,"Unlinked DRUG/ITEM MASTER file entries by common NDC",?55,PSARPDT,?70,"PAGE: "_PSAPG,!,PSALN,!,"DRUG file",?40,"ITEM MASTER file"
"RTN","PSALND",32,0)
 W:$G(PSA)&($O(^PRC(441,+$G(PSAIT),1,+$G(PSA)))) !,$P(^PSDRUG(PSAD,0),U)," continued"
"RTN","PSALND",33,0)
 Q
"RTN","PSALOG")
0^16^B23072806
"RTN","PSALOG",1,0)
PSALOG ;BIR/LTL,JMB-Unposted Procurement History ;7/23/97
"RTN","PSALOG",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSALOG",3,0)
 ;This routine gets the user specifications to print the Unposted
"RTN","PSALOG",4,0)
 ;Procurement History report for a specific month, the Item Total report,
"RTN","PSALOG",5,0)
 ;and High Dollar report. It calls PSALOG0 and PSALOG1.
"RTN","PSALOG",6,0)
 ;
"RTN","PSALOG",7,0)
 ;Get month
"RTN","PSALOG",8,0)
 D DT^DICRW S %DT="AEP",%DT("A")="Select month: ",%DT("B")="T-1M"
"RTN","PSALOG",9,0)
 D ^%DT S PSAYRMO=$E(Y,1,5)*100,PSAMO=$E(PSAYRMO,4,5) G:Y<0 EXIT
"RTN","PSALOG",10,0)
 X ^DD("DD") S PSAMOYR=$E(Y,1,3)_" '"_$E(PSAYRMO,2,3)
"RTN","PSALOG",11,0)
 ;
"RTN","PSALOG",12,0)
 S DIR(0)="Y",DIR("A")="Print item totals",DIR("B")="Yes",DIR("?",1)="Enter yes to print a report of the items ordered during the selected month.",DIR("?")="Enter no if you do not want to print the report."
"RTN","PSALOG",13,0)
 S DIR("??")="^D HELPTOT^PSALOG" W ! D ^DIR K DIR G:$G(DIRUT) EXIT S PSATOTAL=Y
"RTN","PSALOG",14,0)
 ;
"RTN","PSALOG",15,0)
 S DIR(0)="Y",DIR("A")="Print a high dollar items report",DIR("B")="Yes",DIR("?",1)="Enter yes to print a list of purchased items that cost a high",DIR("?")="dollar amount. Enter no if you do not want to print the report."
"RTN","PSALOG",16,0)
 S DIR("??")="^D HELPHIGH^PSALOG" W ! D ^DIR K DIR G:$G(DIRUT) EXIT G:'Y DEVICE S PSAHIGH=Y
"RTN","PSALOG",17,0)
 ;
"RTN","PSALOG",18,0)
 S DIR(0)="N",DIR("A")="Enter the lowest dollar amount to print $",DIR("B")=1000,DIR("?",1)="Enter the lowest dollar amount to be printed.",DIR("?")="Do not enter the dollar sign($).",DIR("??")="^D HELPLOW^PSALOG"
"RTN","PSALOG",19,0)
 W ! D ^DIR K DIR G:$G(DIRUT) EXIT S:Y PSALOW=Y
"RTN","PSALOG",20,0)
 ;
"RTN","PSALOG",21,0)
DEVICE W ! K IO("Q") S %ZIS="Q" D ^%ZIS
"RTN","PSALOG",22,0)
 I POP W !,"No device selected or report printed!" G EXIT
"RTN","PSALOG",23,0)
 I $D(IO("Q")) S ZTRTN="QUE^PSALOG",ZTDESC="Drug Accountability - Unposted Pharmacy Procurement Reports",ZTSAVE("PSA*")="" D ^%ZTLOAD
"RTN","PSALOG",24,0)
 I  G:$D(ZTSK) EXIT I '$D(ZTSK) W !,"The report was not sent to the printer." G EXIT
"RTN","PSALOG",25,0)
QUE ;Calls routines to print the 3 reports.
"RTN","PSALOG",26,0)
 U IO K ^TMP("PSA",$J),^TMP("PSAB",$J),^TMP("PSAC",$J)
"RTN","PSALOG",27,0)
 S PSASTART=1
"RTN","PSALOG",28,0)
 D ^PSALOG0 G:PSAOUT EXIT
"RTN","PSALOG",29,0)
 I $G(PSATOTAL) D ^PSALOG1 G:PSAOUT EXIT
"RTN","PSALOG",30,0)
 D:$G(PSAHIGH) ^PSALOG1H
"RTN","PSALOG",31,0)
EXIT W:$G(PSASTART) @IOF
"RTN","PSALOG",32,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSALOG",33,0)
 K IO("Q"),^TMP("PSA",$J),^TMP("PSAB",$J),^TMP("PSAC",$J)
"RTN","PSALOG",34,0)
 K %DT,%ZIS,DIR,DIRUT,PSAC,PSACP,PSADATE,PSADLN,PSADT,PSAFCP,PSAHIGH,PSAIEN,PSAINVO,PSAITEM,PSAKK,PSALOW,PSAMO,PSAMORE,PSAMOYR,PSAN0,PSAN1,PSAOUT,PSAPG
"RTN","PSALOG",35,0)
 K PSAQTYO,PSAQTYP,PSARPDT,PSASLN,PSASTART,PSATMP,PSATOT,PSATOTAL,PSATOTO,PSATOTP,PSATOTR,PSATQTYO,PSAUNIT,PSAYRMO,PSASS,X,X2,X3,Y,ZTDESC,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE
"RTN","PSALOG",36,0)
 Q
"RTN","PSALOG",37,0)
HELPTOT ;Extended help for "Print item totals?"
"RTN","PSALOG",38,0)
 W !!,"Enter yes to print a report of the items purchased during the selected",!,"month. The report contains the total dollar amount per item per purchase"
"RTN","PSALOG",39,0)
 W !,"order. The report lists the purchase order number, date ordered quantity,",!,"ordered, quantity received, dollar amount per dispensed unit, dispensed"
"RTN","PSALOG",40,0)
 W !,"unit, total order cost, and total cost of items received."
"RTN","PSALOG",41,0)
 W !!,"Enter no if you do not want to print the report."
"RTN","PSALOG",42,0)
 Q
"RTN","PSALOG",43,0)
HELPHIGH ;Extended help for "Print a high dollar items report?"
"RTN","PSALOG",44,0)
 W !!,"Enter yes to choose a cut-off dollar amount and print the report.",!,"The report lists the items from highest to lowest dollar amounts."
"RTN","PSALOG",45,0)
 Q
"RTN","PSALOG",46,0)
HELPLOW ;Extended help for "Enter the lowest dollar amount to print $"
"RTN","PSALOG",47,0)
 W !!,"Enter the lowest dollar amount paid for an order of an item. The",!,"dollar amount is the total amount paid for the item on a purchase order."
"RTN","PSALOG",48,0)
 W !,"For example, if a drug cost $500 per unit and 3 units were ordered, the",!,"total dollar amount is $1500. In order to print this item on the report,",!,"the lowest dollar amount to print must be $1500 or less."
"RTN","PSALOG",49,0)
 Q
"RTN","PSALOG2")
0^17^B27002713
"RTN","PSALOG2",1,0)
PSALOG2 ;BIR/LTL-Post Drug Procurement History ;7/23/97
"RTN","PSALOG2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSALOG2",3,0)
 ;This routine compiles a report of warehouse drugs.
"RTN","PSALOG2",4,0)
 ;
"RTN","PSALOG2",5,0)
 ;References to $$DESCR^PRCPUX1 are covered by IA #259
"RTN","PSALOG2",6,0)
 ;References to $$INVNAME^PRCPUX1 are covered by IA #259
"RTN","PSALOG2",7,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSALOG2",8,0)
 ;References to ^PRCS( are covered by IA #198
"RTN","PSALOG2",9,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSALOG2",10,0)
 ;
"RTN","PSALOG2",11,0)
 N PSA,PSAB,PSAC,PSAION,PSAOUT,X,X2,X3,Y,PSAPG,DIR,DIRUT,DTOUT,DUOUT,%DT,PSALN
"RTN","PSALOG2",12,0)
 S %DT="AEP",%DT("A")="Please select month: ",%DT("B")="T-1M"
"RTN","PSALOG2",13,0)
 D ^%DT S PSA(11)=$E(Y,1,5),PSA(12)=$E(PSA(11),4,5),PSAOUT=0
"RTN","PSALOG2",14,0)
 I Y<0 S PSAOUT=1 G END
"RTN","PSALOG2",15,0)
 X ^DD("DD") S PSA(13)=$E(Y,1,3)_" '"_$E(PSA(11),2,3)
"RTN","PSALOG2",16,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" W ! D ^%ZIS S PSAION=$G(ION)
"RTN","PSALOG2",17,0)
 I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G END
"RTN","PSALOG2",18,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="GO^PSALOG2",ZTDESC="Monthly warehoused drug report",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSALOG2",19,0)
GO S PSA=$O(^PRCP(445,"AC","W","")),(PSA(1),PSAPG)=0 D HEADER
"RTN","PSALOG2",20,0)
 F  S PSA(1)=$O(^PRCP(445,+PSA,1,PSA(1))) Q:'PSA(1)  I $P($G(^PRC(441,+PSA(1),0)),U,3)=6505 W:$E($G(IOST))="C" "." S ^TMP("PSA",$J,$P($G(^PRC(441,+PSA(1),0)),U,2))=$G(^(0))
"RTN","PSALOG2",21,0)
 S PSA(2)=0
"RTN","PSALOG2",22,0)
 F  S PSA(2)=$O(^TMP("PSA",$J,PSA(2))) Q:PSA(2)']""  S PSA(3)=$P($G(^TMP("PSA",$J,PSA(2))),U) D:$O(^PRCP(445.2,"AD",PSA,PSA(3),""))
"RTN","PSALOG2",23,0)
 .S PSA(4)=0
"RTN","PSALOG2",24,0)
 .F  S PSA(4)=$O(^PRCP(445.2,"AD",+PSA,PSA(3),PSA(4))) Q:'PSA(4)  D:$P($G(^PRCP(445.2,+PSA(4),0)),U,4)?1"R"&($E($P($G(^(0)),U,17),1,5)=PSA(11))
"RTN","PSALOG2",25,0)
 ..S ^TMP("PSAB",$J,$P($G(^PRCP(445.2,+PSA(4),0)),U,18),$P($G(^(0)),U,5),PSA(4))=$G(^(0))
"RTN","PSALOG2",26,0)
 S (PSA(4),PSAB,PSAB(1))=0
"RTN","PSALOG2",27,0)
 F PSAC=0:1 S PSAB=$O(^TMP("PSAB",$J,PSAB)) Q:'PSAB  D:PSAC HEADER G:PSAOUT END W !!,"PRIMARY INVENTORY: ",$$INVNAME^PRCPUX1(PSAB) F  S PSA(4)=$O(^TMP("PSAB",$J,PSAB,PSA(4))) Q:'PSA(4)!(PSAOUT)  D  G:PSAOUT END
"RTN","PSALOG2",28,0)
 .W !!,"ITEM #: ",PSA(4),?15,$$DESCR^PRCPUX1(PSAB,PSA(4)),!!,"QTY",?9,"QTY",?19,"PKG",?29,"UNIT",?40,"TOTAL",?51,"DATE",?61,"TRANSACTION",!,"ORD",?9,"REC",?29,"COST",?40,"COST"
"RTN","PSALOG2",29,0)
 .F  S PSAB(1)=$O(^TMP("PSAB",$J,+PSAB,+PSA(4),PSAB(1))) Q:'PSAB(1)!(PSAOUT)  S PSA(5)=$G(^TMP("PSAB",$J,+PSAB,+PSA(4),+PSAB(1))) D  D:$Y+6>IOSL HEADER Q:PSAOUT
"RTN","PSALOG2",30,0)
 ..Q:'$P(PSA(5),U,19)
"RTN","PSALOG2",31,0)
 ..S PSA(22)=0,PSA(33)=$O(^PRCS(410,"B",$P(PSA(5),U,19),""))
"RTN","PSALOG2",32,0)
 ..F  S PSA(22)=$O(^PRCS(410,+PSA(33),"IT",PSA(22))) Q:'PSA(22)  S:$P($G(^PRCS(410,+PSA(33),"IT",PSA(22),0)),U,5)=PSA(4) PSA(44)=$P($G(^(0)),U,2)
"RTN","PSALOG2",33,0)
 ..W !!,$J($G(PSA(44)),3)
"RTN","PSALOG2",34,0)
 ..S PSA(99)=$G(PSA(99))+PSA(44) K PSA(44)
"RTN","PSALOG2",35,0)
 ..S PSA(8)=-$P(PSA(5),U,7),PSA(9)=$G(PSA(9))+PSA(8) W ?9,$J(PSA(8),3)
"RTN","PSALOG2",36,0)
 ..W ?18,$P(PSA(5),U,6)
"RTN","PSALOG2",37,0)
 ..S (X,PSA(7))=$P(PSA(5),U,9),X2="2$" D COMMA^%DTC W X
"RTN","PSALOG2",38,0)
 ..S X=-$P(PSA(5),U,7)*PSA(7),X2="2$",PSA(10)=$G(PSA(10))+X D COMMA^%DTC W X
"RTN","PSALOG2",39,0)
 ..S Y=$P($P(PSA(5),U,17),".") X ^DD("DD") W ?50,$S($L(Y)=11:$E(Y,1,6),$L(Y)=10:$E(Y,1,5),1:"UNKNOWN")
"RTN","PSALOG2",40,0)
 ..W ?59,$P(PSA(5),U,19)
"RTN","PSALOG2",41,0)
 ..I '$O(^TMP("PSAB",$J,+PSAB,+PSA(4),+PSAB(1))) W !,PSALN,!,$J(PSA(99),3),?9,$J(PSA(9),3) S X=$G(PSA(10)),X2="2$" D COMMA^%DTC W ?16,"<TOTALS>",?34,X S ^TMP("PSAC",$J,(999999999-PSA(10)),+PSA(4))=PSA(10)_U_PSAB K PSA(9),PSA(10),PSA(99)
"RTN","PSALOG2",42,0)
 I '$D(^TMP("PSAB",$J)) W !,"Sorry, no procurements for that month!",! S PSAOUT=1
"RTN","PSALOG2",43,0)
 I $D(ZTQUEUED),$D(^TMP("PSAB",$J)) S PSA(44)=500 D LOOP2^PSALOG3
"RTN","PSALOG2",44,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSALOG2",45,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W ! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR K DIR
"RTN","PSALOG2",46,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSALOG2",47,0)
 K ^TMP("PSA",$J),^TMP("PSAB",$J) I $G(PSAOUT) K ^TMP("PSAC",$J) Q
"RTN","PSALOG2",48,0)
 S DIR(0)="Y",DIR("A")="Would you like a list of high dollar items",DIR("B")="Yes",DIR("?")="If yes, I'll let you pick a cut-off dollar amount and sort from high to low" W ! D ^DIR K DIR I 'Y S PSAOUT=1 G END
"RTN","PSALOG2",49,0)
 S DIR(0)="N",DIR("A")="Please enter the lowest amount you are interested in listing",DIR("B")=1000,DIR("?")="Enter the lowest dollar amount that you want included, without $" W ! D ^DIR K DIR S:Y PSA(44)=Y I 'Y S PSAOUT=1 G END
"RTN","PSALOG2",50,0)
 K IO("Q") N %ZIS,IOP,POP,X3 S %ZIS="Q",%ZIS("B")=$G(PSAION) W ! D ^%ZIS
"RTN","PSALOG2",51,0)
 I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" S PSAOUT=1 G END
"RTN","PSALOG2",52,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LOOP2^PSALOG3",ZTDESC="High Dollar Drug Report",ZTSAVE("^TMP(""PSAC"",$J,")="",ZTSAVE("PSA*")="",ZTSAVE("PSALN")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSALOG2",53,0)
 D LOOP2^PSALOG3 G END
"RTN","PSALOG2",54,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSALOG2",55,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSALOG2",56,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1
"RTN","PSALOG2",57,0)
 W !,?2,"WAREHOUSE DRUG PROCUREMENTS FOR ",PSA(13),?70,"PAGE: ",PSAPG,!,PSALN
"RTN","PSALOG2",58,0)
 Q
"RTN","PSAMON")
0^18^B49957996
"RTN","PSAMON",1,0)
PSAMON ;BIR/LTL,JMB-Monthly Summary ;7/23/97
"RTN","PSAMON",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAMON",3,0)
 ;
"RTN","PSAMON",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAMON",5,0)
 ;
"RTN","PSAMON",6,0)
 ;This routine allows the user to print a report per pharmacy location
"RTN","PSAMON",7,0)
 ;of the drug, beginning balance, ending balance, total received, total
"RTN","PSAMON",8,0)
 ;dispensed, and total adjustments. Specific or all drugs can be selected
"RTN","PSAMON",9,0)
 ;for the report. The report can be sent to the screen and printer.
"RTN","PSAMON",10,0)
 ;
"RTN","PSAMON",11,0)
LOC K ^TMP("PSAD",$J) S PSAHIS=1,(PSACNT,PSAOUT)=0
"RTN","PSAMON",12,0)
 D LOC^PSALEVRP I $G(DIRUT) S PSAOUT=1 G END1
"RTN","PSAMON",13,0)
 S PSACHK=$O(PSALOC(""))
"RTN","PSAMON",14,0)
 I 'PSACNT,PSACHK="" W !,"There are no active pharmacy locations." G END1
"RTN","PSAMON",15,0)
 I PSACNT=1 D
"RTN","PSAMON",16,0)
 .S PSALOCN=$O(PSALOCA("")),PSALOC=$O(PSALOCA(PSALOCN,0)),PSALOC(PSALOCN,PSALOC)=PSALOCA(PSALOCN,PSALOC),PSAMENU(1,PSALOCN,PSALOC)="",PSASEL=1,PSATOT=0
"RTN","PSAMON",17,0)
 .W:$L(PSALOCN)>76 !,$P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<77 !,PSALOCN
"RTN","PSAMON",18,0)
 D DT^DICRW S Y=$E(DT,1,5) X ^DD("DD") S PSAMON=Y
"RTN","PSAMON",19,0)
 S DIR(0)="D:AEP",DIR("A")="Select month and year: ",DIR("B")=PSAMON D ^DIR K DIR I $D(DIRUT) S PSAOUT=1 G END1
"RTN","PSAMON",20,0)
 S PSAMON=+($E(Y,1,5)*100),PSA=0,Y=PSAMON X ^DD("DD") S PSAMONN=Y,PSACNT=0
"RTN","PSAMON",21,0)
 W ! F PSAPC=1:1 S PSAPICK=+$P(PSASEL,",",PSAPC) Q:'PSAPICK  D
"RTN","PSAMON",22,0)
 .S PSALOCN="" F  S PSALOCN=$O(PSAMENU(PSAPICK,PSALOCN)) Q:PSALOCN=""!(PSAOUT)  S PSALOC=0 F  S PSALOC=$O(PSAMENU(PSAPICK,PSALOCN,PSALOC)) Q:'PSALOC!(PSAOUT)  D
"RTN","PSAMON",23,0)
 ..S PSACNT=PSACNT+1
"RTN","PSAMON",24,0)
 ..W @IOF W:$L(PSALOCN)>79 !,$P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<80 !,PSALOCN
"RTN","PSAMON",25,0)
 ..I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",$G(PSALOCN) S PSAOUT=1 Q
"RTN","PSAMON",26,0)
 ..D DRUG Q:PSAOUT
"RTN","PSAMON",27,0)
 I PSACNT=1!(PSAOUT) S PSATOT=0 G DEV
"RTN","PSAMON",28,0)
 W ! S DIR(0)="Y",DIR("A")="Print summary report",DIR("B")="Y",DIR("?",1)="Enter YES to print a report of the total figures for each selected",DIR("?",2)="drug in all selected pharmacy locations."
"RTN","PSAMON",29,0)
 S DIR("?")="Enter NO to print only the report per pharmacy location.",DIR("??")="^D SUMHELP^PSAMON" D ^DIR K DIR G:$G(DIRUT) END1 S PSATOT=+Y
"RTN","PSAMON",30,0)
 G DEV
"RTN","PSAMON",31,0)
 ;
"RTN","PSAMON",32,0)
DRUG W !!,"Select one, several, or ^ALL drugs.",!
"RTN","PSAMON",33,0)
 S PSADONE=0,DIC="^PSD(58.8,+PSALOC,1,",DIC(0)="AEMQ",DIC("A")="Select Drug: "
"RTN","PSAMON",34,0)
 F  D ^DIC S:$G(DTOUT)!(X="^") PSAOUT=1 Q:Y=-1&(X'="^A")&(X'="^ALL")  D  Q:PSAOUT!(PSADONE)
"RTN","PSAMON",35,0)
 .I X'="^A",X'="^ALL",'+Y S PSAOUT=1 Q
"RTN","PSAMON",36,0)
 .I X="^A"!(X="^ALL") D  Q
"RTN","PSAMON",37,0)
 ..W !,"Please wait." S PSA=0 F  S PSA=$O(^PSD(58.8,+PSALOC,1,PSA)) Q:'PSA  S:$G(^PSD(58.8,+PSALOC,1,+PSA,5,PSAMON,0))'="" ^TMP("PSAD",$J,PSALOCN,PSA)="" W:(PSA#500) "."
"RTN","PSAMON",38,0)
 ..D END^PSAPROC S PSADONE=1
"RTN","PSAMON",39,0)
 .I +Y,$G(^PSD(58.8,+PSALOC,1,+Y,5,PSAMON,0))="" W !!,"Sorry, no history for that month." Q
"RTN","PSAMON",40,0)
 .S ^TMP("PSAD",$J,PSALOCN,+Y)=""
"RTN","PSAMON",41,0)
 K DIC
"RTN","PSAMON",42,0)
 Q
"RTN","PSAMON",43,0)
 ;
"RTN","PSAMON",44,0)
DEV ;asks device and queueing info
"RTN","PSAMON",45,0)
 S PSA=$O(^TMP("PSAD",$J,"")) G:PSA=""!(PSAOUT) END1
"RTN","PSAMON",46,0)
 K IO("Q") N IOP,POP S %ZIS="Q" W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" G END1
"RTN","PSAMON",47,0)
 I $D(IO("Q")) D  G END1
"RTN","PSAMON",48,0)
 .K ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSAMON",49,0)
 .S ZTRTN="START^PSAMON",ZTDESC="Drug Accountability Monthly Summary Report",ZTSAVE("PSA*")="",ZTSAVE("^TMP(""PSAD"",$J,")=""
"RTN","PSAMON",50,0)
 .D ^%ZTLOAD,HOME^%ZIS
"RTN","PSAMON",51,0)
 ;
"RTN","PSAMON",52,0)
START ;compiles and prints output
"RTN","PSAMON",53,0)
 S PSARPDT=$E($$HTFM^XLFDT($H),1,12),PSADT=$P(PSARPDT,".")
"RTN","PSAMON",54,0)
 S PSARPDT=$E(PSADT,4,5)_"/"_$E(PSADT,6,7)_"/"_$E(PSADT,2,3)_"@"_$P(PSARPDT,".",2)
"RTN","PSAMON",55,0)
 S (PSAOUT,PSAPG)=0,$P(PSADLN,"=",81)="",$P(PSASLN,"-",81)="",PSATABH=(66-($L(PSAMONN)+$L($E(PSALOCN,1,20))))/2
"RTN","PSAMON",56,0)
 K ^TMP("PSAMON",$J)
"RTN","PSAMON",57,0)
LOOP S PSALOCN="" F  S PSALOCN=$O(^TMP("PSAD",$J,PSALOCN)) Q:PSALOCN=""!(PSAOUT)  D
"RTN","PSAMON",58,0)
 .D HEADER S PSALOC=$O(PSALOC(PSALOCN,0))
"RTN","PSAMON",59,0)
 .F PSA=0:0 S PSA=+$O(^TMP("PSAD",$J,PSALOCN,PSA)) Q:'PSA  D
"RTN","PSAMON",60,0)
 ..I $D(^PSD(58.8,PSALOC,1,PSA,5,PSAMON,0)) S ^TMP("PSAMON",$J,$P($G(^PSDRUG(PSA,0)),U))=PSA
"RTN","PSAMON",61,0)
 .D PRINT K ^TMP("PSAMON",$J)
"RTN","PSAMON",62,0)
 .I 'PSAOUT D:$Y+4>IOSL HEADER Q:PSAOUT  W !,"TOTAL",?36,$J(PSATREC,6,0),?49,$J(PSATDISP,6,0),?60,$J(PSATADJ,6,0),?73,$J(PSATTF,6,0),!,PSADLN,!
"RTN","PSAMON",63,0)
 G END
"RTN","PSAMON",64,0)
 ;
"RTN","PSAMON",65,0)
PRINT ;Prints in drug order.
"RTN","PSAMON",66,0)
 S PSAX="",PSAX=$O(^TMP("PSAMON",$J,PSAX)) I PSAX="" W !!,"<< NO DATA WAS FOUND. >>" G END
"RTN","PSAMON",67,0)
 S (PSATREC,PSATDISP,PSATADJ,PSATTF)=0
"RTN","PSAMON",68,0)
 S PSADRUG="" F  S PSADRUG=$O(^TMP("PSAMON",$J,PSADRUG)) Q:PSADRUG=""  D  Q:PSAOUT
"RTN","PSAMON",69,0)
 .D:$Y+4>IOSL HEADER Q:PSAOUT  S PSA=+^TMP("PSAMON",$J,PSADRUG)
"RTN","PSAMON",70,0)
 .W !,PSADRUG
"RTN","PSAMON",71,0)
 .W !?17 W:+$P($G(^PSD(58.8,PSALOC,1,PSA,5,PSAMON,0)),U,2) $J($P($G(^PSD(58.8,PSALOC,1,PSA,5,PSAMON,0)),U,2),6,0)
"RTN","PSAMON",72,0)
 .I '+$P($G(^PSD(58.8,PSALOC,1,PSA,5,PSAMON,0)),U,2) S PSABAL=$P($G(^PSD(58.8,PSALOC,1,PSA,5,PSAMON,0)),U,4) W $J($S($G(PSABAL):PSABAL,1:0),6,0)
"RTN","PSAMON",73,0)
 .W ?26,$J($S($P($G(^PSD(58.8,PSALOC,1,PSA,5,PSAMON,0)),U,4)]"":$P($G(^(0)),U,4),1:$P($G(^PSD(58.8,PSALOC,1,PSA,0)),U,4)),6,0)
"RTN","PSAMON",74,0)
 .S PSAREC=$P($G(^PSD(58.8,PSALOC,1,PSA,5,PSAMON,0)),U,3),PSATREC=PSATREC+PSAREC W ?36,$J(PSAREC,6,0)
"RTN","PSAMON",75,0)
 .S PSADISP=$P($G(^PSD(58.8,PSALOC,1,PSA,5,PSAMON,0)),U,6),PSATDISP=PSATDISP+PSADISP W ?49,$J(PSADISP,6,0)
"RTN","PSAMON",76,0)
 .S PSADJ=$P($G(^PSD(58.8,PSALOC,1,PSA,5,PSAMON,0)),U,5),PSATADJ=PSATADJ+PSADJ W ?60,$J(PSADJ,6,0)
"RTN","PSAMON",77,0)
 .S PSATF=$P($G(^PSD(58.8,PSALOC,1,PSA,5,PSAMON,0)),U,9),PSATTF=PSATTF+PSATF W ?73,$J(PSATF,6,0),!
"RTN","PSAMON",78,0)
 .W:$O(^TMP("PSAMON",$J,PSADRUG))'="" PSASLN W:$O(^TMP("PSAMON",$J,PSADRUG))="" PSADLN
"RTN","PSAMON",79,0)
 .I PSATOT D
"RTN","PSAMON",80,0)
 ..S $P(^TMP("PSAG",$J,PSADRUG),"^")=$P($G(^TMP("PSAG",$J,PSADRUG)),"^")+PSAREC,$P(^(PSADRUG),"^",2)=$P($G(^(PSADRUG)),"^",2)+PSADISP
"RTN","PSAMON",81,0)
 ..S $P(^TMP("PSAG",$J,PSADRUG),"^",3)=$P($G(^TMP("PSAG",$J,PSADRUG)),"^",3)+PSADJ,$P(^(PSADRUG),"^",4)=$P($G(^(PSADRUG)),"^",4)+PSATF
"RTN","PSAMON",82,0)
 Q
"RTN","PSAMON",83,0)
 ;
"RTN","PSAMON",84,0)
END ;End of page
"RTN","PSAMON",85,0)
 I $E($G(IOST))="C",'$G(PSAOUT) D
"RTN","PSAMON",86,0)
 .S PSAS=22-$Y F PSASS=1:1:PSAS W !
"RTN","PSAMON",87,0)
 .S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR K DIR I $G(DIRUT) S PSAOUT=1
"RTN","PSAMON",88,0)
 W @IOF I 'PSAOUT,PSATOT D ^PSAMON1
"RTN","PSAMON",89,0)
 ;
"RTN","PSAMON",90,0)
END1 ;Kills variables at end of report
"RTN","PSAMON",91,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSAMON",92,0)
 K IO("Q"),^TMP("PSAD",$J),^TMP("PSAG",$J),^TMP("PSAMON",$J)
"RTN","PSAMON",93,0)
 K %ZIS,DIC,DIRUT,DTOUT,DUOUT,PSA,PSABAL,PSACHK,PSACNT,PSACOMB,PSAD,PSADISP,PSADJ,PSADLN,PSADONE,PSADRUG,PSADT,PSAGADJ,PSAGDISP,PSAGREC,PSAGTF,PSAHIS
"RTN","PSAMON",94,0)
 K PSAISIT,PSAISITN,PSALOC,PSALOCA,PSALOCN,PSAMENU,PSAMON,PSAMONN,PSANODE,PSANUM,PSAOSIT,PSAOSITN,PSAOUT,PSAPC,PSAPC1,PSAPCS,PSAPICK
"RTN","PSAMON",95,0)
 K PSAREC,PSAPG,PSARPDT,PSAS,PSASEL,PSASLN,PSAS,PSASS,PSASUB,PSATABH,PSATADJ,PSATDISP,PSATF,PSATOT,PSATREC,PSATTF,PSAX,X,Y,ZTDESC,ZTRTN
"RTN","PSAMON",96,0)
 Q
"RTN","PSAMON",97,0)
 ;
"RTN","PSAMON",98,0)
HEADER ;prints header info
"RTN","PSAMON",99,0)
 I $E(IOST,1,2)="C-",PSAPG S DIR(0)="E" D  Q:PSAOUT
"RTN","PSAMON",100,0)
 .S PSAS=22-$Y F PSASS=1:1:PSAS W !
"RTN","PSAMON",101,0)
 .S DIR(0)="E" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1
"RTN","PSAMON",102,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAMON",103,0)
 I $E(IOST,1,2)="C-" W @IOF
"RTN","PSAMON",104,0)
 I $E(IOST)'="C",PSAPG W @IOF
"RTN","PSAMON",105,0)
 S PSAPG=PSAPG+1 W:$E(IOST)'="C" !,PSARPDT W:$E(IOST,1,2)="C-" !
"RTN","PSAMON",106,0)
 W ?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE",?71,"PAGE: ",PSAPG
"RTN","PSAMON",107,0)
 W !?22,"MONTHLY SUMMARY REPORT FOR "_PSAMONN
"RTN","PSAMON",108,0)
 W:$L(PSALOCN)>79 !!,$P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2)
"RTN","PSAMON",109,0)
 W:$L(PSALOCN)<80 !?((80-$L(PSALOCN))/2),PSALOCN
"RTN","PSAMON",110,0)
 W !!,?14,"BEGINNING",?26,"ENDING",?36,"TOTAL",?48,"TOTAL",?60,"TOTAL",?72,"TOTAL"
"RTN","PSAMON",111,0)
 W !,"DRUG",?16,"BALANCE",?25,"BALANCE",?34,"RECEIVED",?46,"DISPENSED",?58,"ADJUSTED",?69,"TRANSFERRED"
"RTN","PSAMON",112,0)
 W !,PSADLN
"RTN","PSAMON",113,0)
 Q
"RTN","PSAMON",114,0)
 ;
"RTN","PSAMON",115,0)
SUMHELP ;Extended help to 'Print summary report?'
"RTN","PSAMON",116,0)
 W !!?5,"Enter YES to print a report with the totals for each selected drug",!?5,"in all the pharmacy locations that were selected. A total line will"
"RTN","PSAMON",117,0)
 W !?5,"print for the total dispense units received, dispensed, adjusted,",!?5,"and transferrred during the selected month."
"RTN","PSAMON",118,0)
 W !!?5,"Enter NO to print each pharmacy location's report without the",!?5,"summary report."
"RTN","PSAMON",119,0)
 Q
"RTN","PSANAC")
0^19^B28314130
"RTN","PSANAC",1,0)
PSANAC ;BIR/LTL-Populate Pharmacy Location with Inventory Items ;7/23/97
"RTN","PSANAC",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSANAC",3,0)
 ;This routine loads inventory/DA items into a pharmacy location.
"RTN","PSANAC",4,0)
 ;
"RTN","PSANAC",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSANAC",6,0)
 ;References to ^PSDRUG("AB" are covered by IA #2095
"RTN","PSANAC",7,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSANAC",8,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSANAC",9,0)
 ;References to ^PS(52.6 are covered by IA #270
"RTN","PSANAC",10,0)
 ;References to ^PS(52.7 are covered by IA #770
"RTN","PSANAC",11,0)
 ;
"RTN","PSANAC",12,0)
 ;
"RTN","PSANAC",13,0)
SETUP N DA,DIE,DIC,DIR,DIRUT,DTOUT,DUOUT,DR,PSAOUT,PSADRUG,PSAIT,PSAINV,PSAQTY,PSAY,X,Y
"RTN","PSANAC",14,0)
 ;LOOK UP LOCATION
"RTN","PSANAC",15,0)
LOOK D ^PSADA I '$G(PSALOC) S PSAOUT=1 G QUIT
"RTN","PSANAC",16,0)
NOINV I '$O(^PSD(58.8,+PSALOC,4,0)) W !,$G(PSALOCN)_" is not linked to an Inventory Point.",! S DIR(0)="Y",DIR("A")="Would you like to attempt a link now",DIR("B")="Yes" D ^DIR K DIR G:Y'=1 QUIT D  G:$D(Y)!('$G(PSAINV)) QUIT
"RTN","PSANAC",17,0)
INV .S DIE=58.8,DA=PSALOC,DR="[PSAGIP]" D ^DIE
"RTN","PSANAC",18,0)
CHEC S DIR(0)="Y",DIR("A")="Have you looked at the loadable Inventory items",DIR("B")="No" D ^DIR K DIR G:$D(DIRUT) QUIT D:Y'=1  G:$G(PSAOUT) QUIT
"RTN","PSANAC",19,0)
 .S DIR(0)="Y",DIR("A")="Would you like to look at them now",DIR("B")="Yes" D ^DIR K DIR D:Y=1 DEV^PSARIN
"RTN","PSANAC",20,0)
 .S:$D(DTOUT)!($D(DUOUT))!('$G(PSADRUG(1))) PSAOUT=1 Q:$G(PSAOUT)  S DIR(0)="Y",DIR("A")="Ready to load",DIR("B")="No" D ^DIR K DIR S:Y'=1 PSAOUT=1
"RTN","PSANAC",21,0)
 S DIR(0)="Y",DIR("A")="Load inventory quantities also",DIR("B")="Yes",DIR("?")="If yes, I'll bring over the current inventory quantity with each item." D ^DIR K DIR S:Y=1 PSAY=1 I $D(DIRUT) S PSAOUT=1 G QUIT
"RTN","PSANAC",22,0)
EXP W !,"I will display each item as it is loaded",!
"RTN","PSANAC",23,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q",%ZIS("A")="Please select DEVICE for output:  " D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G QUIT
"RTN","PSANAC",24,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSANAC",ZTDESC="Inventory items loading into DA Location",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSANAC",25,0)
START N %DT,DIC,PSAD,PSADT,PSAL,PSALN,PSAT,PSAPG,PSARPDT,X,Y S (PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y,PSAIT=0
"RTN","PSANAC",26,0)
 S PSAD="W !,PSAIT,?10,$E($$DESCR^PRCPUX1(PSAINV,PSAIT),1,34),?45,$E($P(^PSDRUG($O(^PSDRUG(""AB"",PSAIT,0)),0),U),1,34)"
"RTN","PSANAC",27,0)
 S PSAINV=$O(^PSD(58.8,+PSALOC,4,0))
"RTN","PSANAC",28,0)
 I $O(^PSD(58.8,+PSALOC,4,PSAINV)) D  S:Y<1 PSAOUT=1 G QUIT
"RTN","PSANAC",29,0)
 .S DIC="^PSD(58.8,+PSALOC,4,",DIC(0)="AEMQ",DA(1)=PSALOC D ^DIC K DIC
"RTN","PSANAC",30,0)
 .S PSAINV=+Y
"RTN","PSANAC",31,0)
 D HEADER
"RTN","PSANAC",32,0)
 S:'$D(^PSD(58.8,+PSALOC,1,0)) ^(0)="^58.8001IP^^"
"RTN","PSANAC",33,0)
LOOP F  S PSAIT=$O(^PRCP(445,PSAINV,1,PSAIT)) Q:'PSAIT  D:$Y+4>IOSL HEADER Q:PSAOUT  I '$G(^PRC(441,+PSAIT,3)),$O(^PSDRUG("AB",PSAIT,0)) S PSADRUG=$O(^PSDRUG("AB",PSAIT,0)) D:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,0))
"RTN","PSANAC",34,0)
 .I $S('$D(^PSDRUG(PSADRUG,"I")):1,+^("I")>DT:1,1:0) X PSAD D
"RTN","PSANAC",35,0)
STUFF ..S PSAQTY=$P($G(^PRCP(445,+PSAINV,1,+PSAIT,0)),U,7)*$S($P($G(^(0)),U,29):$P($G(^(0)),U,29),1:1)
"RTN","PSANAC",36,0)
 ..S:$G(PSAY) DIC("DR")="3////^S X=PSAQTY"
"RTN","PSANAC",37,0)
 ..S DIC="^PSD(58.8,+PSALOC,1,",DIC(0)="L",DA(1)=PSALOC,X=PSADRUG,DLAYGO=58.8 D ^DIC  K DIC,DLAYGO
"RTN","PSANAC",38,0)
 ..W !,"Loaded "_$P(^PSDRUG(PSADRUG,0),U)
"RTN","PSANAC",39,0)
 ..Q:'$G(PSAY)
"RTN","PSANAC",40,0)
 ..W !,"Updating beginning balance and transaction history.",!
"RTN","PSANAC",41,0)
 ..D NOW^%DTC S PSADT=+$E(%,1,12) K %
"RTN","PSANAC",42,0)
 ..S ^PSD(58.8,+PSALOC,1,+PSADRUG,5,0)="^58.801A^^"
"RTN","PSANAC",43,0)
 ..S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="L",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DIC("DR")="1////^S X=PSAQTY",DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSANAC",44,0)
 ..F  L +^PSD(58.81,0):0 I  Q
"RTN","PSANAC",45,0)
FIND ..S PSAT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSANAC",46,0)
 ..S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO L -^PSD(58.81,0)
"RTN","PSANAC",47,0)
 ..S DIE="^PSD(58.81,",DA=PSAT,DR="1////11;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRUG;5////^S X=PSAQTY;6////^S X=DUZ;9////0" D ^DIE K DIE
"RTN","PSANAC",48,0)
 ..S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSANAC",49,0)
 ..S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,4,",DIC(0)="L",(X,DINUM)=PSAT
"RTN","PSANAC",50,0)
 ..S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DA,DIC,DINUM,DLAYGO
"RTN","PSANAC",51,0)
 ..I $E(IOST,1,2)="C-"&($O(^PS(52.6,"AC",+PSADRUG,0))!($O(^PS(52.7,"AC",+PSADRUG,0)))) S PSAIT(1)=PSAIT,PSAIT(2)=$P($G(^PSDRUG(+PSADRUG,0)),U),PSAIT(4)=$G(^PSDRUG(+PSADRUG,660)),PSAIT=PSADRUG D ^PSAPSI4 S PSAIT=PSAIT(1)
"RTN","PSANAC",52,0)
QUIT I $E(IOST)'="C" W @IOF
"RTN","PSANAC",53,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSANAC",54,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSANAC",55,0)
 K %ZIS("B"),IO("Q") Q
"RTN","PSANAC",56,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSANAC",57,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSANAC",58,0)
 ;PSA*3*25 Dave B - removed single reference for OP site
"RTN","PSANAC",59,0)
 D OPSITE^PSAUTL1 S PSAINV(1)=$G(PSAOSITN)
"RTN","PSANAC",60,0)
 S:$E(PSAINV(1),10)="(" PSAINV(1)=$E(PSAINV(1),1,9)
"RTN","PSANAC",61,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,$E($P(^PRCP(445,+PSAINV,0),U),1,24)," items loading into ",PSAINV(1),?56,PSARPDT,?70,"PAGE: ",PSAPG,!,PSALN,!,"ITEM",?10,"DESCRIPTION",?50,"DRUG FILE LINK",!
"RTN","PSANAC",62,0)
 Q
"RTN","PSANDC")
0^20^B11510883
"RTN","PSANDC",1,0)
PSANDC ;BIR/LTL-NDC Duplicates Report ;7/23/97
"RTN","PSANDC",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSANDC",3,0)
 ;This routine checks the ITEM FILE for multiple NDC's.
"RTN","PSANDC",4,0)
 ;
"RTN","PSANDC",5,0)
 ;References to $$DESCR^PRCPUX1 are covered by IA #259
"RTN","PSANDC",6,0)
 ;References to $$VENNAME^PRCPUX1 are covered by IA #259
"RTN","PSANDC",7,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSANDC",8,0)
 F I=0:1:4 W !,$P($T(NAR+I),";;",2,99)
"RTN","PSANDC",9,0)
NAR ;Expanation
"RTN","PSANDC",10,0)
 ;;     This report lists each National Drug Code (NDC) that has been
"RTN","PSANDC",11,0)
 ;;     entered for more than one item.  In order for the DRUG file to
"RTN","PSANDC",12,0)
 ;;     correctly link to the ITEM MASTER file, it is recommended that the NDC
"RTN","PSANDC",13,0)
 ;;     be removed from all but the one correct entry.
"RTN","PSANDC",14,0)
 D DT^DICRW
"RTN","PSANDC",15,0)
DEV ;asks device and queueing info
"RTN","PSANDC",16,0)
 K I,IO("Q") N %ZIS,DTOUT,DUOUT,IOP,POP,PSAOUT S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G END
"RTN","PSANDC",17,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSANDC",ZTDESC="Duplicate NDC Report" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSANDC",18,0)
START ;compiles and prints data for report
"RTN","PSANDC",19,0)
 N %DT,DIR,DIRUT,PSAPG,PSANDC,PSALN,PSANDCD,PSARPDT,X,Y S (PSANDC,PSANDCD)="",(PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y D HEADER
"RTN","PSANDC",20,0)
LOOP F  S PSANDC=$O(^PRC(441,"F",PSANDC)) G:PSANDC=""!(PSAOUT) END D:$Y+10>IOSL HEADER D  G:PSAOUT END
"RTN","PSANDC",21,0)
 .S PSANDC(1)=0
"RTN","PSANDC",22,0)
 .F  S PSANDCD=$O(^PRC(441,"F",PSANDC,PSANDCD)) Q:'PSANDCD!(PSAOUT)  I $O(^PRC(441,"F",PSANDC,PSANDCD)),'$G(^PRC(441,+PSANDCD,3)),'$G(^PRC(441,+$O(^PRC(441,"F",PSANDC,PSANDCD)),3)) D  D:$Y+10>IOSL HEADER Q:PSAOUT
"RTN","PSANDC",23,0)
 ..S PSANDC(1)=PSANDC(1)+1
"RTN","PSANDC",24,0)
 ..W:PSANDC(1)=1 !,PSALN,!,?30,"NDC:  "_PSANDC,!!,"ITEM #",?10,"DESCRIPTION",?50,"VENDOR",!!,PSANDCD,?10,$E($$DESCR^PRCPUX1(0,PSANDCD),1,37),?50,$E($$VENNAME^PRCPUX1($O(^PRC(441,"F",PSANDC,PSANDCD,0))_"PRC(440"),1,30)
"RTN","PSANDC",25,0)
 ..W !!,$O(^PRC(441,"F",PSANDC,PSANDCD)),?10,$E($$DESCR^PRCPUX1(0,$O(^PRC(441,"F",PSANDC,PSANDCD))),1,37),?50,$E($$VENNAME^PRCPUX1($O(^PRC(441,"F",PSANDC,$O(^PRC(441,"F",PSANDC,PSANDCD)),0))_"PRC(440"),1,30)
"RTN","PSANDC",26,0)
END I $E(IOST)'="C" W @IOF
"RTN","PSANDC",27,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSANDC",28,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSANDC",29,0)
 Q
"RTN","PSANDC",30,0)
HEADER ;prints header info
"RTN","PSANDC",31,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSANDC",32,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSANDC",33,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !?2,"DUPLICATE NDC REPORT",?35,PSARPDT,?70,"PAGE: "_PSAPG,!,!!
"RTN","PSANDC",34,0)
 Q
"RTN","PSAOP")
0^21^B36721516
"RTN","PSAOP",1,0)
PSAOP ;BIR/LTL-Outpatient Dispensing (Single Drug) ;7/23/97
"RTN","PSAOP",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,15**; 10/24/97
"RTN","PSAOP",3,0)
 ;This routine is the gathers OP dispensing for a date range.
"RTN","PSAOP",4,0)
 ;
"RTN","PSAOP",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAOP",6,0)
 ;References to ^PSRX( are covered by IA #254
"RTN","PSAOP",7,0)
 ;
"RTN","PSAOP",8,0)
 D PSAWARN^PSAPSI I $D(PSAQUIT) K PSAQUIT Q
"RTN","PSAOP",9,0)
 ;
"RTN","PSAOP",10,0)
 N DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSADR,PSADREC,PSADT,PSAPG,PSAS,PSA,PSAOUT,PSARELDT,PSADT,DA,PSADRUG,PSADRUGN,PSALN,PSAP,PSAN,PSAQ,PSAR,X,X2,Y
"RTN","PSAOP",11,0)
LOOK D:'$G(PSALOC) OP^PSADA
"RTN","PSAOP",12,0)
 I $G(PSALOC)<0 K PSALOC G QUIT
"RTN","PSAOP",13,0)
 S:'$G(PSALOCN) PSALOCN=$P($G(^PSD(58.8,+PSALOC,0)),U)
"RTN","PSAOP",14,0)
 S DIR(0)="Y",DIR("A")="OK",DIR("B")="Yes",DIR("?")="No allows you to change Location." D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 G:$D(DIRUT) QUIT I Y=0 K PSALOC D OP^PSADA G:'$G(PSALOC) QUIT
"RTN","PSAOP",15,0)
 I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN G QUIT
"RTN","PSAOP",16,0)
 D NOW^%DTC S PSADT=X,X="T-6000" D ^%DT S PSADT(1)=Y
"RTN","PSAOP",17,0)
 S DIC="^PSD(58.8,+PSALOC,1,",DIC(0)="AEQ",DIC("A")="Please select "_PSALOCN_"'S drug: ",DIC("S")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)>DT,1:1)"
"RTN","PSAOP",18,0)
 S PSAS=$P($G(^PSD(58.8,+PSALOC,0)),U,10),PSADT(3)=0
"RTN","PSAOP",19,0)
 F  W ! S DA(1)=PSALOC D ^DIC G:Y<0 QUIT S PSADRUG=+Y D  G:$G(PSAOUT) QUIT G:$G(PSA(5)) TR D DEV Q:$G(PSAOUT)
"RTN","PSAOP",20,0)
 .D:'$G(^PSD(58.8,+PSALOC,1,+PSADRUG,6))  Q:$G(PSAOUT)
"RTN","PSAOP",21,0)
 ..W !!,"Dispensing has never been collected for this drug.",!!
"RTN","PSAOP",22,0)
 ..S DIR(0)="D^"_PSADT(1)_":"_PSADT_":AEX",DIR("A")="How far back would you like to collect",DIR("B")="T-6000"  D ^DIR K DIR S (PSADT(2),PSADT(4),PSAR,PSAP,PSAN)=Y,(PSADT(3),PSAR(1),PSAP(1),PSAN(1))=0 I Y<1 S PSAOUT=1 Q
"RTN","PSAOP",23,0)
 .S PSAG=$G(^PSD(58.8,+PSALOC,1,+PSADRUG,6))
"RTN","PSAOP",24,0)
 .S:'$G(PSADT(2)) PSADT(2)=$P(PSAG,U),PSA(7)=1
"RTN","PSAOP",25,0)
 .W !!,"Checking dispensing"
"RTN","PSAOP",26,0)
 .S:'$G(PSAR) PSAR=$P(PSAG,U,2) S:'$G(PSAP) PSAP=$P(PSAG,U,7)
"RTN","PSAOP",27,0)
 .S:'$G(PSAN) PSAN=$P(PSAG,U,9) S (PSAR(1),PSAP(1),PSAN(1))=0
"RTN","PSAOP",28,0)
 .F  S PSADT(2)=$O(^PSRX("AL",PSADT(2))) Q:'PSADT(2)  F  S PSADT(3)=$O(^PSRX("AL",+PSADT(2),PSADT(3))) Q:'PSADT(3)  W:'(PSADT(3)#10) "." D:$P($G(^PSRX(+PSADT(3),0)),U,6)=PSADRUG&($P($G(^PSRX(+PSADT(3),2)),U,9)=PSAS)
"RTN","PSAOP",29,0)
 ..S PSADT(4)="" F  S PSADT(4)=$O(^PSRX("AL",+PSADT(2),+PSADT(3),PSADT(4))) Q:PSADT(4)=""  D
"RTN","PSAOP",30,0)
 ...;
"RTN","PSAOP",31,0)
 ...;DAVE B (PSA*3*3)
"RTN","PSAOP",32,0)
 ...Q:$D(^PSRX("AR",+PSADT(2),+PSADT(3),PSADT(4)))  ;Released to CMOP, do not count
"RTN","PSAOP",33,0)
 ...S ^TMP("PSA",$J,+PSADRUG,$E(PSADT(2),1,7))=($P($G(^TMP("PSA",$J,+PSADRUG,$E(PSADT(2),1,7))),U)+$S(PSADT(4):$P($G(^PSRX(+PSADT(3),1,+PSADT(4),0)),U,4),1:$P($G(^PSRX(+PSADT(3),0)),U,7)))_U_PSADT(2)_U_PSADT(3),PSA(9)=PSADT(3)
"RTN","PSAOP",34,0)
 .W !!,"Checking refills"
"RTN","PSAOP",35,0)
 .D:$O(^PSRX("AJ",PSAR))
"RTN","PSAOP",36,0)
 ..F  S PSAR=$O(^PSRX("AJ",PSAR)) Q:'PSAR  F  S PSAR(1)=$O(^PSRX("AJ",+PSAR,+PSAR(1))) Q:'PSAR(1)  W "." D:$P($G(^PSRX(+PSAR(1),0)),U,6)=PSADRUG&($P($G(^PSRX(+PSAR(1),2)),U,9)=PSAS)
"RTN","PSAOP",37,0)
 ...S PSAR(3)="" F  S PSAR(3)=$O(^PSRX("AJ",+PSAR,+PSAR(1),PSAR(3))) Q:PSAR(3)=""  D
"RTN","PSAOP",38,0)
 ....S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAR,1,7)),U)=($P($G(^TMP("PSA",$J,+PSADRUG,$E(PSAR,1,7))),U)-$S(PSAR(3):$P($G(^PSRX(+PSAR(1),1,+PSAR(3),0)),U,4),1:$P($G(^PSRX(+PSAR(1),0)),U,7)))
"RTN","PSAOP",39,0)
 ....S $P(^TMP("PSA",$J,+PSADRUG,$E(PSAR,1,7)),U,4)=PSAR,$P(^($E(PSAR,1,7)),U,5)=PSAR(1),PSAR(2)=PSAR(1)
"RTN","PSAOP",40,0)
 .D:$O(^PSRX("AM",+PSAP))!($O(^PSRX("AN",+PSAN))) AM^PSAOP4
"RTN","PSAOP",41,0)
 .I '$D(^TMP("PSA",$J,+PSADRUG)) W !!,"Sorry, no dispensing for this drug has occurred since " S Y=$S($P(PSAG,U):$P(PSAG,U),1:$G(PSADT(4))) X ^DD("DD") W Y,".",! S PSAOUT=1 Q
"RTN","PSAOP",42,0)
 .S DIR(0)="Y",DIR("A")="Would you like a report of dispensing totals",DIR("B")="Yes" D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 S:Y'=1 PSA(5)=1
"RTN","PSAOP",43,0)
 ;
"RTN","PSAOP",44,0)
DEV K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" I Y=1 W ! D ^%ZIS
"RTN","PSAOP",45,0)
 I $G(POP) W !,"NO DEVICE SELECTED OR ACTION TAKEN!" S PSAOUT=1 G QUIT
"RTN","PSAOP",46,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LUP^PSAOP",ZTDESC="Drug Acct-OP Dispensing Log",(ZTSAVE("^TMP(""PSA"",$J,+PSADRUG,"),ZTSAVE("PSA*"))="" D ^%ZTLOAD,HOME^%ZIS G QUIT
"RTN","PSAOP",47,0)
LUP S (PSAPG,PSAOUT)=0,PSADRUG(1)=$P($G(^PSDRUG(+PSADRUG,660)),U,6),PSADRUG(2)=$P($G(^(660)),U,8)
"RTN","PSAOP",48,0)
 S X=PSADRUG(1),X2="3$" D COMMA^%DTC S PSADRUG(3)=X
"RTN","PSAOP",49,0)
 D HEADER
"RTN","PSAOP",50,0)
 S (PSA(4),PSA(6))=0 F  S PSA(4)=$O(^TMP("PSA",$J,+PSADRUG,PSA(4))) Q:'PSA(4)  S PSA(6)=PSA(6)+1,Y=PSA(4) X ^DD("DD") D
"RTN","PSAOP",51,0)
 .W !!,Y S X=$P($G(^TMP("PSA",$J,+PSADRUG,PSA(4))),U),X2=0 D COMMA^%DTC W ?14,X,PSADRUG(2),?40,PSADRUG(3),"/",PSADRUG(2),?63
"RTN","PSAOP",52,0)
 .S PSADRUG(4)=$G(PSADRUG(4))+$P($G(^TMP("PSA",$J,+PSADRUG,PSA(4))),U)
"RTN","PSAOP",53,0)
 .S X=$P($G(^TMP("PSA",$J,+PSADRUG,PSA(4))),U)*PSADRUG(1),PSADRUG(5)=$G(PSADRUG(5))+X,X2="2$" D COMMA^%DTC W ?40,X
"RTN","PSAOP",54,0)
 W !,PSALN,!,PSA(6)," DAY TOTALS: " S X=PSADRUG(4),X2=0 D COMMA^%DTC W ?5,X,PSADRUG(2)
"RTN","PSAOP",55,0)
 S X=PSADRUG(5),X2="2$" D COMMA^%DTC W ?63,X
"RTN","PSAOP",56,0)
STOP W:$E(IOST)'="C" @IOF
"RTN","PSAOP",57,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W ! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR K DIR
"RTN","PSAOP",58,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAOP",59,0)
 W !!,"Updating history and dispensing totals."
"RTN","PSAOP",60,0)
TR S ZTIO="",ZTRTN="LOOP^PSAOP",ZTDESC="Drug Acct-Dispensing Totals",ZTDTH=$H,(ZTSAVE("^TMP(""PSA"",$J,+PSADRUG,"),ZTSAVE("PSA*"))="" D ^%ZTLOAD,HOME^%ZIS
"RTN","PSAOP",61,0)
 K ^TMP("PSA",$J,+PSADRUG),PSA,PSADRUG
"RTN","PSAOP",62,0)
QUIT Q
"RTN","PSAOP",63,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAOP",64,0)
 I $$S^%ZTLOAD S PSAOUT=1 Q
"RTN","PSAOP",65,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,?2,"DAILY DISPENSING TOTALS FOR ",$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,30),?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAOP",66,0)
 W "  DATE",?23,"TOTAL",?45,"$/DISP",?67,"TOTAL",!
"RTN","PSAOP",67,0)
 W "DISPENSED",?23,"DISP",?46,"UNIT",?68,"COST",!,PSALN
"RTN","PSAOP",68,0)
 Q
"RTN","PSAOP",69,0)
LOOP S PSA(2)=0 F  S PSA(2)=$O(^TMP("PSA",$J,+PSADRUG,PSA(2))) Q:'PSA(2)  S PSA(3)=$P(^TMP("PSA",$J,+PSADRUG,PSA(2)),"^") D
"RTN","PSAOP",70,0)
 .;PSA*3*25 Dave B - Remove single reference for OP site
"RTN","PSAOP",71,0)
 .S PSA=^TMP("PSA",$J,+PSADRUG,PSA(2)),PSAOP=+$P($G(^PSD(58.8,PSALOC,0)),"^",10),PSARELDT=+$P(PSA(2),".")
"RTN","PSAOP",72,0)
 .K:$D(^XTMP("PSA",PSAOP,PSADRUG,PSARELDT)) ^XTMP("PSA",PSAOP,PSADRUG,PSARELDT)
"RTN","PSAOP",73,0)
 .D ^PSAOP1
"RTN","PSAOP",74,0)
 .S DIE="^PSD(58.8,"_+PSALOC_",1,",DA(1)=PSALOC,DA=PSADRUG
"RTN","PSAOP",75,0)
 .S DR="22////"_$P(PSA,U,2)_";22.1////"_$P(PSA,U,3)_";23////"_$P(PSA,U,4)_";23.1////"_$P(PSA,U,5)_";22.2////"_$P(PSA,U,6)_";22.3////"_$P(PSA,U,7)_";23.2////"_$P(PSA,U,8)_";23.3////"_$P(PSA,U,9)
"RTN","PSAOP",76,0)
 .D ^DIE K DA,DIE,DR
"RTN","PSAOP",77,0)
 Q
"RTN","PSAOP2")
0^22^B33216667
"RTN","PSAOP2",1,0)
PSAOP2 ;BIR/LTL-Outpatient Dispensing (All Drugs) ;7/23/97
"RTN","PSAOP2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,15**; 10/24/97
"RTN","PSAOP2",3,0)
 ;This routine gathers outpatient dispensing for all drugs in a location
"RTN","PSAOP2",4,0)
 ;from the PRESCRIPTION file. If present, the last outpatient dispensing
"RTN","PSAOP2",5,0)
 ;date is used as a starting point. Otherwise the user selected date is
"RTN","PSAOP2",6,0)
 ;used.
"RTN","PSAOP2",7,0)
 ;
"RTN","PSAOP2",8,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAOP2",9,0)
 ;References to ^PSRX( are covered by IA #254
"RTN","PSAOP2",10,0)
 ;
"RTN","PSAOP2",11,0)
 D PSAWARN^PSAPSI I $D(PSAQUIT) K PSAQUIT Q
"RTN","PSAOP2",12,0)
 D Q
"RTN","PSAOP2",13,0)
 S $P(PSALN,"-",79)="-"
"RTN","PSAOP2",14,0)
LOOK D OP^PSADA
"RTN","PSAOP2",15,0)
 G:'$G(PSALOC) Q W !,$G(PSALOCN)
"RTN","PSAOP2",16,0)
 S DIR(0)="Y",DIR("A")="OK",DIR("B")="Yes",DIR("?")="Answering no will allow you to change Location." D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 G:$D(DIRUT) Q I Y=0 K PSALOC D OP^PSADA G:'$G(PSALOC) Q
"RTN","PSAOP2",17,0)
 I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN,!! G Q
"RTN","PSAOP2",18,0)
 D NOW^%DTC S PSADT=X,X="T-6000" D ^%DT S PSADT(1)=Y,(PSAPG,PSAOUT,PSADRUG)=0
"RTN","PSAOP2",19,0)
 S DIR(0)="D^"_PSADT(1)_":"_PSADT_":AEX",DIR("A")="How far back would you like to collect",DIR("B")="T-6000"  D ^DIR K DIR S (PSADT(2),PSADT(22),PSAR,PSAP,PSAN)=Y,(PSADT(3),PSAR(1),PSAP(1),PSAN(1))=0 I Y<1 S PSAOUT=1 Q
"RTN","PSAOP2",20,0)
 S (PSAOP,PSAS)=$P($G(^PSD(58.8,+PSALOC,0)),U,10)
"RTN","PSAOP2",21,0)
 S DIR(0)="Y",DIR("A")="Would you like a report of daily dispensing totals",DIR("B")="Yes" D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 G:$D(DIRUT) STOP
"RTN","PSAOP2",22,0)
 I Y=1 S PSADAILY=1
"RTN","PSAOP2",23,0)
DEV K IO("Q") K %ZIS,IOP,POP S %ZIS="Q" I Y=1 W ! D ^%ZIS
"RTN","PSAOP2",24,0)
 I $G(POP) W !,"NO DEVICE SELECTED OR ACTION TAKEN!" S PSAOUT=1 G Q
"RTN","PSAOP2",25,0)
 I $D(IO("Q")) K ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LUP^PSAOP2",ZTDESC="Drug Acct-Daily Drug Dispensing Log",ZTSAVE("PSA*")="" D ^%ZTLOAD G Q
"RTN","PSAOP2",26,0)
 ;
"RTN","PSAOP2",27,0)
LUP ;Starting point
"RTN","PSAOP2",28,0)
 S PSADRUG=0 W @IOF
"RTN","PSAOP2",29,0)
PROCESS F PSAHOW="AL","AJ","AM","AN" S PSADT=PSADT(22)-.00001 D LOOP
"RTN","PSAOP2",30,0)
 G DONE
"RTN","PSAOP2",31,0)
 ;
"RTN","PSAOP2",32,0)
LOOP ;
"RTN","PSAOP2",33,0)
 I $E(IOST)="C" W !,"Processing ",$S(PSAHOW="AL":"dispensing",PSAHOW="AJ":"returns",PSAHOW="AM":"partials",1:"returns")
"RTN","PSAOP2",34,0)
 ;
"RTN","PSAOP2",35,0)
1 S PSADT=$O(^PSRX(PSAHOW,PSADT)) Q:PSADT'>0  K PSAIEN
"RTN","PSAOP2",36,0)
2 S PSAIEN=$S('$D(PSAIEN):$O(^PSRX(PSAHOW,PSADT,0)),1:$O(^PSRX(PSAHOW,PSADT,PSAIEN))) G 1:PSAIEN'>0 K PSARX
"RTN","PSAOP2",37,0)
3 S PSARX=$S('$D(PSARX):$O(^PSRX(PSAHOW,PSADT,PSAIEN,"")),1:$O(^PSRX(PSAHOW,PSADT,PSAIEN,PSARX))) G 2:PSARX="" W "."
"RTN","PSAOP2",38,0)
 I $D(^PSRX("AR",PSADT,PSAIEN,PSARX)) G 3
"RTN","PSAOP2",39,0)
 S PSADRUG=$P($G(^PSRX(PSAIEN,0)),"^",6) I $G(PSADRUG)="" G 3
"RTN","PSAOP2",40,0)
 S PSADRUGN=$P($G(^PSDRUG(PSADRUG,0)),"^")
"RTN","PSAOP2",41,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRUG)) G 3
"RTN","PSAOP2",42,0)
 I $P($G(^PSRX(PSAIEN,2)),"^",9)'=PSAS G 3
"RTN","PSAOP2",43,0)
 ;
"RTN","PSAOP2",44,0)
 S PSAQTY=$S(+PSARX:$P($G(^PSRX(PSAIEN,1,PSARX,0)),"^",4),1:$P($G(^PSRX(PSAIEN,0)),"^",7)) ;either refill or fill
"RTN","PSAOP2",45,0)
 ;
"RTN","PSAOP2",46,0)
 I '$D(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7))) S ^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7))=""
"RTN","PSAOP2",47,0)
 S DATA=^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7))
"RTN","PSAOP2",48,0)
 S $P(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7)),"^",1)=$S(PSAHOW="AL":$P(DATA,"^")+PSAQTY,PSAHOW="AJ":$P(DATA,"^")-PSAQTY,PSAHOW="AM":$P(DATA,"^")+$P($G(^PSRX(PSAIEN,"P",PSARX,0)),"^",4),1:$P(DATA,"^")-$P($G(^PSRX(PSAIEN,"P",PSARX,0)),"^",4))
"RTN","PSAOP2",49,0)
 ;
"RTN","PSAOP2",50,0)
 S $P(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7)),"^",$S(PSAHOW="AL":2,PSAHOW="AJ":4,PSAHOW="AM":6,1:8))=PSAIEN
"RTN","PSAOP2",51,0)
 S $P(^TMP("PSA",$J,PSADRUGN,$E(PSADT,1,7)),"^",$S(PSAHOW="AL":3,PSAHOW="AJ":5,PSAHOW="AM":7,1:9))=PSARX
"RTN","PSAOP2",52,0)
 G 3
"RTN","PSAOP2",53,0)
 ;
"RTN","PSAOP2",54,0)
DONE ;All dispensing data retrieved, print it.
"RTN","PSAOP2",55,0)
 D HEADER
"RTN","PSAOP2",56,0)
 S XX=0 F  S XX=$O(^PSD(58.88,PSALOC,1,XX)) Q:XX'>0  S XXX=$P($G(^PSDRUG,XX),"^") I '$D(^TMP("PSA",$J,XXX)) S ^TMP("PSA",$J,XXX)=0
"RTN","PSAOP2",57,0)
 S PSADRUGN=0
"RTN","PSAOP2",58,0)
4 S PSADRUGN=$O(^TMP("PSA",$J,PSADRUGN)) G STOP:PSADRUGN=""
"RTN","PSAOP2",59,0)
 S PSADRUG=$O(^PSDRUG("B",PSADRUGN,0))
"RTN","PSAOP2",60,0)
 I $Y>(IOSL+4) D HEADER G Q:$G(PSAOUT)=1
"RTN","PSAOP2",61,0)
 I '$D(^TMP("PSA",$J,PSADRUGN)) W !,PSADRUGN,?36,"has not been dispensed since: " S Y=$S($P($G(^PSD(58.8,PSALOC,1,PSADRUG,6)),"^"):$P(^PSD(58.8,PSALOC,1,PSADRUG,6),"^"),1:PSADT(22)) X ^DD("DD") W Y,"." G 4
"RTN","PSAOP2",62,0)
 W !,PSADRUGN
"RTN","PSAOP2",63,0)
 K PNTDATA,PSADATE,PSATTLP,DAYS
"RTN","PSAOP2",64,0)
5 S PSADATE=$S('$D(PSADATE):$O(^TMP("PSA",$J,PSADRUGN,0)),1:$O(^TMP("PSA",$J,PSADRUGN,PSADATE))) G PNTQ:PSADATE'>0 S DATA=^TMP("PSA",$J,PSADRUGN,PSADATE) S DAYS=$G(DAYS)+1
"RTN","PSAOP2",65,0)
 S Y=PSADATE X ^DD("DD") S PRINTDT=Y
"RTN","PSAOP2",66,0)
 S PSAQTY=$P(DATA,"^")
"RTN","PSAOP2",67,0)
 ;
"RTN","PSAOP2",68,0)
 S PSAPRICE=$P($G(^PSDRUG(PSADRUG,660)),"^",6) ;Price per dispense Unit
"RTN","PSAOP2",69,0)
 S PSADISPU=$P($G(^PSDRUG(PSADRUG,660)),"^",8) ;Dispense Unit
"RTN","PSAOP2",70,0)
 ;
"RTN","PSAOP2",71,0)
 S Y=PSAQTY,X2=0 D COMMA^%DTC S PNTQTY=Y
"RTN","PSAOP2",72,0)
 S TTLQTY=$G(TTLQTY)+PSAQTY ;total quantity
"RTN","PSAOP2",73,0)
 S PSAPRICE(2)=$G(PSAPRICE(2))+(PSAPRICE*PSAQTY) ;Total Cost
"RTN","PSAOP2",74,0)
 S Y=PSAPRICE,X2="3$" D COMMA^%DTC S PNTPRICE=Y
"RTN","PSAOP2",75,0)
 S Y=PSAPRICE*PSAQTY,X2="3$" D COMMA^%DTC S PSAQP=Y
"RTN","PSAOP2",76,0)
 I $D(PSADAILY) W !,$G(DAYS),?3,PRINTDT,?23,PNTQTY,?40,PNTPRICE,"/",PSADISPU,?63,PSAQP K PSAQP G 5
"RTN","PSAOP2",77,0)
 G 5
"RTN","PSAOP2",78,0)
 ;
"RTN","PSAOP2",79,0)
PNTQ W !,PSALN,!,DAYS," DAY TOTALS: " S Y=TTLQTY,X2="2$" D COMMA^%DTC W Y S Y=PSAPRICE(2),X2="2$" D COMMA^%DTC W ?63,Y
"RTN","PSAOP2",80,0)
 K TTLQTY,PSAPRICE,PSAQTY,PNTQTY
"RTN","PSAOP2",81,0)
 G 4
"RTN","PSAOP2",82,0)
 ;
"RTN","PSAOP2",83,0)
HEADER I $E(IOST,1,2)'="P-",$G(PSAPG) S DIR(0)="E" D ^DIR K DIR I '+Y S PSAOUT=1 Q
"RTN","PSAOP2",84,0)
 I $$S^%ZTLOAD S PSAOUT=1 Q
"RTN","PSAOP2",85,0)
 W:$Y @IOF S PSAPG=$G(PSAPG)+1 W ?2,"DAILY DISPENSING TOTALS FOR ",$E($G(PSALOCN),1,30),?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAOP2",86,0)
 W "  DATE",?23,"TOTAL",?45,"$/DISP",?67,"TOTAL",!," DISPENSED",?23,"DISP",?46,"UNIT",?68,"COST",!,PSALN
"RTN","PSAOP2",87,0)
 Q
"RTN","PSAOP2",88,0)
Q D ^%ZISC K PNTDATA,PNTDATE,PNTPRICE,PNTQTY,POP,PRINTDT,PSA,PSADAILY,PSADATE,PDADISPU,PSADR,PSADREC,PSADRUG,PSACNT,PSAPG,PSAOSIT
"RTN","PSAOP2",89,0)
 K PSADRUGN,PSADT,PSAG,PSAHOW,PSAIEN,PSALN,PSALOC,PSALOCN,PSAN,PSAOP,PSAOUT,PSAP,PSAPRICE,PSAQ,PSAQTY,PSAR,PSAREC,PSARELDT,PSARX,PSAS,PSAT,PSATTLP,TTLQTY,^TMP("PSA",$J),^TMP($J)
"RTN","PSAOP2",90,0)
 Q
"RTN","PSAOP2",91,0)
STOP W:$E(IOST)'="C" @IOF
"RTN","PSAOP2",92,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAOP2",93,0)
 I $O(^TMP("PSA",$J,0)) D ^PSAOP4
"RTN","PSAOP2",94,0)
 G Q
"RTN","PSAPSI")
0^23^B35525013
"RTN","PSAPSI",1,0)
PSAPSI ;BIR/LTL-IV Dispensing (Single Drug) ;7/23/97
"RTN","PSAPSI",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,15**; 10/24/97
"RTN","PSAPSI",3,0)
 ;This routine gathers IV dispensing data for a single drug.
"RTN","PSAPSI",4,0)
 ;
"RTN","PSAPSI",5,0)
 ;References to ^DIC(19.2 are covered by IA #1064
"RTN","PSAPSI",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAPSI",7,0)
 ;References to ^PS(50.8 are covered by IA #771
"RTN","PSAPSI",8,0)
 ;References to ^PS(52.6 are covered by IA #270
"RTN","PSAPSI",9,0)
 ;References to ^PS(52.7 are covered by IA #770
"RTN","PSAPSI",10,0)
 ;
"RTN","PSAPSI",11,0)
 K PSAQUIT D PSAWARN I $D(PSAQUIT) K PSAQUIT Q
"RTN","PSAPSI",12,0)
 N DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSAPG,PSAW,PSAIV,PSAOUT,PSADT,DA,PSADRUG,PSADRUGN,PSALN,PSAQ,PSAR,X,Y
"RTN","PSAPSI",13,0)
LOOK D ^PSADA I '$G(PSALOC) S PSAOUT=1 G QUIT
"RTN","PSAPSI",14,0)
 I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN,!! G QUIT
"RTN","PSAPSI",15,0)
 D NOW^%DTC S PSADT=X,X="T-6000" D ^%DT S PSADT(1)=Y
"RTN","PSAPSI",16,0)
 F  W ! S DIC="^PSD(58.8,+PSALOC,1,",DA(1)=PSALOC,DIC(0)="AEQ",DIC("A")="Please select "_PSALOCN_" drug: " D ^DIC G:Y<0 QUIT S PSADRUG=+Y,(PSAIV,PSADT(2))=0 D  G:$G(PSAOUT) QUIT D DEV
"RTN","PSAPSI",17,0)
 .I '$O(^PS(52.6,"AC",+PSADRUG,0))&('$O(^PS(52.7,"AC",+PSADRUG,0))) W !!,"This drug is not linked to an entry in the IV ADDITIVE or SOLUTION file.",!! S PSAOUT=1 Q
"RTN","PSAPSI",18,0)
 .S PSADRUG(1)=$O(^PS(52.6,"AC",+PSADRUG,0))
"RTN","PSAPSI",19,0)
 .S PSADRUG(2)=$O(^PS(52.7,"AC",+PSADRUG,0))
"RTN","PSAPSI",20,0)
 .D:'$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,6)),U,3)  Q:$G(PSAOUT)
"RTN","PSAPSI",21,0)
 ..W !!,"IV dispensing data has never been collected for this drug.",!!
"RTN","PSAPSI",22,0)
 ..S DIR(0)="D^"_PSADT(1)_":"_PSADT_":AEX",DIR("A")="How far back would you like to collect",DIR("B")="T-6000"  D ^DIR K DIR S (PSADT(2),PSAR)=Y,(PSADT(3),PSAR(1))=0 I Y<1 S PSAOUT=1 Q
"RTN","PSAPSI",23,0)
 .I '$G(PSADT(2)) S PSADT(2)=$P($P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,6)),U,3),","),PSADT(3)=0,PSA(7)=1
"RTN","PSAPSI",24,0)
 .S PSAW=PSADT(3)
"RTN","PSAPSI",25,0)
 .F  S PSAIV=$O(^PS(50.8,PSAIV)) Q:'PSAIV  F PSADT(4)=PSADT(2):0 S PSADT(4)=$O(^PS(50.8,+PSAIV,2,PSADT(4))) Q:'PSADT(4)  D  D:$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.7,+PSADRUG(2),0)) ^PSAPSI5
"RTN","PSAPSI",26,0)
 ..Q:'$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.6,+PSADRUG(1),0))
"RTN","PSAPSI",27,0)
 ..S PSADRUG(3)=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.6,+PSADRUG(1),0))
"RTN","PSAPSI",28,0)
 ..F  S PSAW=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW)) Q:'PSAW  S PSAW(1)=PSAW D:$O(^PSD(58.8,"AB",PSAW,0))=PSALOC
"RTN","PSAPSI",29,0)
 ...S PSAQ=$G(PSAQ)+$P($G(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW,0)),U,2)-$P($G(^(0)),U,5)
"RTN","PSAPSI",30,0)
 ..S:$G(PSAQ) ^TMP("PSA",$J,+PSADRUG,PSADT(4))=$G(^TMP("PSA",$J,+PSADRUG,PSADT(4)))+PSAQ S (PSAQ,PSAW)=0
"RTN","PSAPSI",31,0)
DEV I '$D(^TMP("PSA",$J,+PSADRUG)) W !!,"Sorry, no dispensing for this drug has been compiled since " S Y=$G(PSADT(2)) X ^DD("DD") W $S(Y]"":Y,1:"ever"),".",!! D  G QUIT
"RTN","PSAPSI",32,0)
 .W "The Compile IV Costs in Background option is scheduled to run "
"RTN","PSAPSI",33,0)
 .S Y=$P($G(^DIC(19,+$O(^DIC(19,"B","PSJI BACKGROUND JOB",0)),200)),U)
"RTN","PSAPSI",34,0)
 .X ^DD("DD") W $S(Y:Y,1:"*not scheduled*"),"."
"RTN","PSAPSI",35,0)
 S DIR(0)="Y",DIR("A")="Would you like a report of daily dispensing totals",DIR("B")="Yes" D ^DIR K DIR G:$D(DIRUT) QUIT G:Y'=1 TR
"RTN","PSAPSI",36,0)
 K IO("Q"),DIC N %ZIS,IOP,POP S %ZIS="Q" I Y=1 W ! D ^%ZIS
"RTN","PSAPSI",37,0)
 I $G(POP) W !,"NO DEVICE SELECTED OR ACTION TAKEN!" S PSAOUT=1 G QUIT
"RTN","PSAPSI",38,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="LUP^PSAPSI",ZTDESC="Daily drug dispensing log",(ZTSAVE("^TMP(""PSA"",$J,+PSADRUG,"),ZTSAVE("PSA*"))="" D ^%ZTLOAD,HOME^%ZIS G QUIT
"RTN","PSAPSI",39,0)
LUP S (PSAPG,PSAOUT)=0,PSADRUG(1)=$P($G(^PSDRUG(+PSADRUG,660)),U,6),PSADRUG(2)=$P($G(^(660)),U,8)
"RTN","PSAPSI",40,0)
 S X=PSADRUG(1),X2="3$" D COMMA^%DTC S PSADRUG(3)=X
"RTN","PSAPSI",41,0)
 D HEADER
"RTN","PSAPSI",42,0)
 S (PSA(4),PSA(6))=0 F  S PSA(4)=$O(^TMP("PSA",$J,+PSADRUG,PSA(4))) Q:'PSA(4)  D:$Y+5>IOSL HEADER G:PSAOUT STOP S PSA(6)=PSA(6)+1,Y=PSA(4) X ^DD("DD") D
"RTN","PSAPSI",43,0)
 .W !!,Y
"RTN","PSAPSI",44,0)
 .S (X,PSADRUG(6))=$G(^TMP("PSA",$J,+PSADRUG,PSA(4))),X2=0
"RTN","PSAPSI",45,0)
 .S:$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,6)),U,4) X=X/$P($G(^(6)),U,4)
"RTN","PSAPSI",46,0)
 .S PSADRUG(4)=$G(PSADRUG(4))+X
"RTN","PSAPSI",47,0)
 .D COMMA^%DTC W ?14,X,PSADRUG(2),?40,PSADRUG(3),"/",PSADRUG(2),?63
"RTN","PSAPSI",48,0)
 .S X=X*PSADRUG(1),PSADRUG(5)=$G(PSADRUG(5))+X,X2="2$" D COMMA^%DTC W ?40,X
"RTN","PSAPSI",49,0)
 W !,PSALN,!,PSA(6)," DAY TOTALS: " S X=PSADRUG(4),X2=0 D COMMA^%DTC W ?5,X,PSADRUG(2)
"RTN","PSAPSI",50,0)
 S X=PSADRUG(5),X2="2$" D COMMA^%DTC W ?63,X
"RTN","PSAPSI",51,0)
STOP W:$E(IOST)'="C" @IOF
"RTN","PSAPSI",52,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W ! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR K DIR
"RTN","PSAPSI",53,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAPSI",54,0)
 W:'$G(PSAOUT) !!,"Updating transaction history and dispensing totals."
"RTN","PSAPSI",55,0)
TR I '$G(PSAOUT) S ZTIO="",ZTRTN="^PSAPSI1",ZTDESC="Update dispensing totals",ZTDTH=$H,(ZTSAVE("^TMP(""PSA"",$J,+PSADRUG,"),ZTSAVE("PSA*"))="" D ^%ZTLOAD,HOME^%ZIS
"RTN","PSAPSI",56,0)
QUIT K:$G(PSADRUG) ^TMP("PSA",$J,+PSADRUG),PSADRUG K PSA
"RTN","PSAPSI",57,0)
 Q
"RTN","PSAPSI",58,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAPSI",59,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAPSI",60,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,?2,"DAILY DISPENSING TOTALS FOR ",$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,30),?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAPSI",61,0)
 W "  DATE",?23,"TOTAL",?45,"$/DISP",?67,"TOTAL",!
"RTN","PSAPSI",62,0)
 W "DISPENSED",?23,"DISP",?46,"UNIT",?68,"COST",!,PSALN
"RTN","PSAPSI",63,0)
 Q
"RTN","PSAPSI",64,0)
 ;
"RTN","PSAPSI",65,0)
PSAWARN ;DAVEB (PSA*3*3)
"RTN","PSAPSI",66,0)
 ;
"RTN","PSAPSI",67,0)
 W @IOF,!!,?30," ** W A R N I N G **",!!,"Execution of this option should only be done for either one of the following:",!
"RTN","PSAPSI",68,0)
 W !,"1. The ""All Location Dispense/Purge"", [PSA IV ALL LOCATIONS] nightly back-"
"RTN","PSAPSI",69,0)
 W !,"   ground option has failed to run.",!!,"2. New drugs have been added to a pharmacy location, and you would like to see",!,"   the dispensing activity that has occurred for up to the last sixty days.",!
"RTN","PSAPSI",70,0)
 W !!,"Each time this option is executed, the balances are updated in the MONTHLY",!,"ACTIVITY multiple within the DRUG ACCOUNTABILITY STATS file (#58.8)."
"RTN","PSAPSI",71,0)
 W !!,"The proram will continue to add or subtract the dispensed amount each time the ",!,"option is used.",!
"RTN","PSAPSI",72,0)
ASK S DIR(0)="Y",DIR("A")="Do you really want to run this option",DIR("B")="NO" D ^DIR K DIR I $D(DIRUT) S PSAQUIT=1 Q
"RTN","PSAPSI",73,0)
 I Y'>0 S PSAQUIT=1 Q
"RTN","PSAPSI",74,0)
 K PSAQUIT Q
"RTN","PSAPSI2")
0^24^B26507609
"RTN","PSAPSI2",1,0)
PSAPSI2 ;BIR/LTL-IV Dispensing (All Drugs) ;7/23/97
"RTN","PSAPSI2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,15**; 10/24/97
"RTN","PSAPSI2",3,0)
 ;This routine gathers IV dispensing for all drugs in a pharmacy location.
"RTN","PSAPSI2",4,0)
 ;
"RTN","PSAPSI2",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAPSI2",6,0)
 ;References to ^PS(50.8 are covered by IA #771
"RTN","PSAPSI2",7,0)
 ;References to ^PS(52.6 are covered by IA #270
"RTN","PSAPSI2",8,0)
 ;References to ^PS(52.7 are covered by IA #770
"RTN","PSAPSI2",9,0)
 ;
"RTN","PSAPSI2",10,0)
 K PSAQUIT D PSAWARN^PSAPSI I $D(PSAQUIT) K PSAQUIT Q
"RTN","PSAPSI2",11,0)
 N DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSAPG,PSALN,PSALOCN,PSAS,PSA,PSAOUT,PSADT,DA,PSADRUG,PSADRUGN,PSAQ,PSAIV,PSAW,X,X2,Y,ZTSK
"RTN","PSAPSI2",12,0)
LOOK D ^PSADA G:'$G(PSALOC) QUIT
"RTN","PSAPSI2",13,0)
 I '$O(^PSD(58.8,+PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN,!! G QUIT
"RTN","PSAPSI2",14,0)
 D NOW^%DTC S PSADT=X,X="T-6000" D ^%DT S PSADT(1)=Y,(PSAPG,PSAOUT,PSADRUG)=0
"RTN","PSAPSI2",15,0)
 S DIR(0)="D^"_PSADT(1)_":"_PSADT_":AEX",DIR("A")="How far back would you like to collect",DIR("B")="T-6000"  D ^DIR K DIR S (PSADT(2),PSAR)=Y,(PSADT(3),PSAR(1))=0 I Y<1 S PSAOUT=1 Q
"RTN","PSAPSI2",16,0)
 S (PSADT(22),PSADT(23),PSAIV)=0
"RTN","PSAPSI2",17,0)
 S DIR(0)="Y",DIR("A")="Would you like a report of daily dispensing totals",DIR("B")="Yes" D ^DIR K DIR S:$D(DIRUT) PSAOUT=1 G:$D(DIRUT) STOP
"RTN","PSAPSI2",18,0)
 I Y'=1 S PSA(5)=1,ZTIO="",ZTRTN="LUP^PSAPSI2",ZTDESC="DA drug disp",ZTSAVE("PSA*")="",ZTDTH=$H D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G STOP
"RTN","PSAPSI2",19,0)
DEV K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" I Y=1 W ! D ^%ZIS
"RTN","PSAPSI2",20,0)
 I $G(POP) W !,"NO DEVICE SELECTED OR ACTION TAKEN!" S PSAOUT=1 G QUIT
"RTN","PSAPSI2",21,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH S ZTRTN="LUP^PSAPSI2",ZTDESC="Daily drug dispensing",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G STOP
"RTN","PSAPSI2",22,0)
LUP F  S PSADRUG=$O(^PSD(58.8,+PSALOC,1,PSADRUG)) Q:'PSADRUG  D:$Y+5>$G(IOSL)&('$G(PSA(5))) HEADER G:$G(PSAOUT) STOP D:$S($P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,0)),U,14):$P($G(^(0)),U,14)>DT,1:1)  D:$D(^TMP("PSA",$J,+PSADRUG)) TASK
"RTN","PSAPSI2",23,0)
 .Q:$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,6)),U,3)
"RTN","PSAPSI2",24,0)
 .S PSADRUGN=$P($G(^PSDRUG(+PSADRUG,0)),U),PSAIV=0
"RTN","PSAPSI2",25,0)
 .I '$G(PSA(5))&('$G(PSAPG)) W @IOF D HEADER
"RTN","PSAPSI2",26,0)
 .S PSADT(3)=0,PSA(7)=1
"RTN","PSAPSI2",27,0)
 .I '$O(^PS(52.6,"AC",+PSADRUG,0))&('$O(^PS(52.7,"AC",+PSADRUG,0)))&('$G(PSA(5))) Q
"RTN","PSAPSI2",28,0)
 .S PSADRUG(1)=$O(^PS(52.6,"AC",+PSADRUG,0))
"RTN","PSAPSI2",29,0)
 .S PSADRUG(2)=$O(^PS(52.7,"AC",+PSADRUG,0))
"RTN","PSAPSI2",30,0)
 .S PSAW=PSADT(3)
"RTN","PSAPSI2",31,0)
 .F  S PSAIV=$O(^PS(50.8,PSAIV)) Q:'PSAIV  F PSADT(4)=PSADT(2):0 S PSADT(4)=$O(^PS(50.8,+PSAIV,2,PSADT(4))) Q:'PSADT(4)  D  D:$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.7,+PSADRUG(2),0)) SOL
"RTN","PSAPSI2",32,0)
 ..Q:'$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.6,+PSADRUG(1),0))
"RTN","PSAPSI2",33,0)
 ..S PSADRUG(3)=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.6,+PSADRUG(1),0))
"RTN","PSAPSI2",34,0)
 ..F  S PSAW=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW)) Q:'PSAW  S PSAW(1)=PSAW D:$O(^PSD(58.8,"AB",PSAW,0))=PSALOC
"RTN","PSAPSI2",35,0)
 ...S PSAQ=$G(PSAQ)+$P($G(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW,0)),U,2)-$P($G(^(0)),U,5)
"RTN","PSAPSI2",36,0)
 ..S:$G(PSAQ) ^TMP("PSA",$J,+PSADRUG,PSADT(4))=$G(^TMP("PSA",$J,+PSADRUG,PSADT(4)))+PSAQ S (PSAQ,PSAW)=0
"RTN","PSAPSI2",37,0)
 .Q:$G(PSA(5))
"RTN","PSAPSI2",38,0)
 .S PSADRUG(1)=$P($G(^PSDRUG(+PSADRUG,660)),U,6),PSADRUG(2)=$P($G(^(660)),U,8)
"RTN","PSAPSI2",39,0)
 .S X=PSADRUG(1),X2="3$" D COMMA^%DTC S PSADRUG(3)=X
"RTN","PSAPSI2",40,0)
 .S (PSA(4),PSA(6))=0 F  S PSA(4)=$O(^TMP("PSA",$J,+PSADRUG,PSA(4))) Q:'PSA(4)  D:$Y+4>IOSL HEADER Q:PSAOUT  S PSA(6)=PSA(6)+1,Y=PSA(4) X ^DD("DD") D
"RTN","PSAPSI2",41,0)
 ..W:$G(PSA(6))=1 !!,PSADRUGN W !!,Y
"RTN","PSAPSI2",42,0)
 ..S (X,PSADRUG(6))=$G(^TMP("PSA",$J,+PSADRUG,PSA(4))),X2=0
"RTN","PSAPSI2",43,0)
 ..S:$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,6)),U,4) X=X/$P($G(^(6)),U,4)
"RTN","PSAPSI2",44,0)
 ..D COMMA^%DTC W ?14,X,PSADRUG(2),?40,PSADRUG(3),"/",PSADRUG(2),?63
"RTN","PSAPSI2",45,0)
 ..S PSADRUG(4)=$G(PSADRUG(4))+X
"RTN","PSAPSI2",46,0)
 ..S X=X*PSADRUG(1),PSADRUG(5)=$G(PSADRUG(5))+X,X2="2$" D COMMA^%DTC W ?40,X
"RTN","PSAPSI2",47,0)
 .I PSA(6) W !,PSALN,!,PSA(6)," DAY TOTALS: " S X=$G(PSADRUG(4)),X2=0 D COMMA^%DTC W ?5,X,PSADRUG(2) S PSADRUG(4)=0 S X=$G(PSADRUG(5)),X2="2$" D COMMA^%DTC W ?63,X S PSADRUG(5)=0
"RTN","PSAPSI2",48,0)
 I 'PSADRUG&($G(PSA(5))) S PSAOUT=1
"RTN","PSAPSI2",49,0)
STOP W:$E($G(IOST),1,2)="P-" @IOF
"RTN","PSAPSI2",50,0)
 I $E($G(IOST))="C",'$G(PSAOUT) W ! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR K DIR
"RTN","PSAPSI2",51,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAPSI2",52,0)
 K ^TMP("PSA",$J),PSA
"RTN","PSAPSI2",53,0)
QUIT Q
"RTN","PSAPSI2",54,0)
HEADER I $E(IOST,1,2)'="P-",$G(PSAPG) S DIR(0)="E" D ^DIR K DIR I Y<1 S PSAOUT=1 Q
"RTN","PSAPSI2",55,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAPSI2",56,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=$G(PSAPG)+1 W !,?2,"DAILY DISPENSING TOTALS FOR ",$E($G(PSALOCN),1,30),?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAPSI2",57,0)
 W "  DATE",?23,"TOTAL",?45,"$/DISP",?67,"TOTAL",!
"RTN","PSAPSI2",58,0)
 W "DISPENSED",?23,"DISP",?46,"UNIT",?68,"COST",!,PSALN
"RTN","PSAPSI2",59,0)
 Q
"RTN","PSAPSI2",60,0)
TASK S ZTIO="",ZTRTN="^PSAPSI1",ZTDTH=$H,ZTDESC="Dispensing totals",(ZTSAVE("^TMP(""PSA"",$J,+PSADRUG,"),ZTSAVE("PSA*"))="" D ^%ZTLOAD,HOME^%ZIS
"RTN","PSAPSI2",61,0)
 W:'$G(PSA(5)) !!,"Updating transaction file and dispensing totals." Q
"RTN","PSAPSI2",62,0)
SOL S PSAW=PSADT(3),PSADRUG(3)=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,"AC",52.7,+PSADRUG(2),0))
"RTN","PSAPSI2",63,0)
 F  S PSAW=$O(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW)) Q:'PSAW  S PSAW(1)=PSAW D:$O(^PSD(58.8,"AB",PSAW,0))=PSALOC
"RTN","PSAPSI2",64,0)
 .S PSAQ=$G(PSAQ)+$P($G(^PS(50.8,+PSAIV,2,+PSADT(4),2,+PSADRUG(3),3,PSAW,0)),U,2)-$P($G(^(0)),U,5)
"RTN","PSAPSI2",65,0)
 S:PSAQ ^TMP("PSA",$J,+PSADRUG,PSADT(4))=$G(^TMP("PSA",$J,+PSADRUG,PSADT(4)))+PSAQ S (PSAQ,PSAW)=0
"RTN","PSAPSI2",66,0)
 Q
"RTN","PSAPV")
0^25^B24136699
"RTN","PSAPV",1,0)
PSAPV ;BIR/JMB-Processor and Verifier ;9/6/97
"RTN","PSAPV",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAPV",3,0)
 ;This routine prints the order number, invoice number, invoice date,
"RTN","PSAPV",4,0)
 ;processor's name, process date, verifier's name, and verification
"RTN","PSAPV",5,0)
 ;date for a specified invoice date range.
"RTN","PSAPV",6,0)
 ;
"RTN","PSAPV",7,0)
 I '$D(^XUSEC("PSA ORDERS",DUZ)) W !,"You do not hold the key to enter the option." Q
"RTN","PSAPV",8,0)
 I '$O(^PSD(58.811,"ADATE",0)) W !,"There are no invoices." G EXIT
"RTN","PSAPV",9,0)
 S PSAOUT=0 D BDATE G:PSAOUT EXIT
"RTN","PSAPV",10,0)
DEVICE ;Asks device & queueing info
"RTN","PSAPV",11,0)
 W !!,"The report must be sent to a printer that supports 132 columns.",!
"RTN","PSAPV",12,0)
DEV K IO("Q"),%ZIS,IOP,POP S %ZIS="Q",%ZIS("B")="",IOM=132
"RTN","PSAPV",13,0)
 D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSAPV",14,0)
 ;I $E(IOST)["C"!($G(IOM)<132) W !,"The printout must be sent to a 132 column printer!",! G DEV
"RTN","PSAPV",15,0)
 I $D(IO("Q")) D  G EXIT
"RTN","PSAPV",16,0)
 .N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSAPV",17,0)
 .S ZTRTN="COMPILE^PSAPV",ZTDESC="Drug Acct. - Processor and Verifier Report"
"RTN","PSAPV",18,0)
 .S:$D(PSABEG) ZTSAVE("PSABEG")="" S:$D(PSAEND) ZTSAVE("PSAEND")=""
"RTN","PSAPV",19,0)
 .D ^%ZTLOAD
"RTN","PSAPV",20,0)
 ;
"RTN","PSAPV",21,0)
COMPILE ;Compiles data
"RTN","PSAPV",22,0)
 S PSAOUT=0,X1=PSABEG,X2=-1 D C^%DTC S PSADATE=X_.239999
"RTN","PSAPV",23,0)
 F  S PSADATE=+$O(^PSD(58.811,"ADATE",PSADATE)) Q:'PSADATE!(PSADATE>PSAEND)!(PSAOUT)  D
"RTN","PSAPV",24,0)
 .S PSAIEN=0 F  S PSAIEN=+$O(^PSD(58.811,"ADATE",PSADATE,PSAIEN)) Q:'PSAIEN!(PSAOUT)  D
"RTN","PSAPV",25,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,0))  S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAIEN1=0
"RTN","PSAPV",26,0)
 ..F  S PSAIEN1=+$O(^PSD(58.811,"ADATE",PSADATE,PSAIEN,PSAIEN1)) Q:'PSAIEN1!(PSAOUT)  D
"RTN","PSAPV",27,0)
 ...Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAPV",28,0)
 ...S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0),PSAINV=$P(PSAIN,"^"),PSAINVDT=$P(PSAIN,"^",2),PSAPROC=+$P(PSAIN,"^",10),PSAVER=+$P(PSAIN,"^",11)
"RTN","PSAPV",29,0)
 ...S PSAPROC=$S($P($G(^VA(200,PSAPROC,0)),"^")'="":$P($G(^VA(200,PSAPROC,0)),"^"),1:"")
"RTN","PSAPV",30,0)
 ...S PSAVER=$S($P($G(^VA(200,PSAVER,0)),"^")'="":$P($G(^VA(200,PSAVER,0)),"^"),1:"")
"RTN","PSAPV",31,0)
 ...S (PSALINE,PSAPROCD,PSAVERD)=0
"RTN","PSAPV",32,0)
 ...Q:PSAPROC=""&(PSAVER="")
"RTN","PSAPV",33,0)
 ...F  S PSALINE=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:'PSALINE!(PSAOUT)  D
"RTN","PSAPV",34,0)
 ....Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAPV",35,0)
 ....S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0) S:PSAPROCD<$P(PSADATA,"^",6) PSAPROCD=$P(PSADATA,"^",6) S:PSAVERD<$P(PSADATA,"^",8) PSAVERD=$P(PSADATA,"^",8)
"RTN","PSAPV",36,0)
 ..S PSAINVDT=$S(+PSAINVDT:$E(PSAINVDT,4,5)_"/"_$E(PSAINVDT,6,7)_"/"_$E(PSAINVDT,2,3),1:"UNKNOWN")
"RTN","PSAPV",37,0)
 ..S PSAPROCD=$S(+PSAPROCD&(PSAPROC'=""):$E(PSAPROCD,4,5)_"/"_$E(PSAPROCD,6,7)_"/"_$E(PSAPROCD,2,3),1:"")
"RTN","PSAPV",38,0)
 ..S PSAVERD=$S(+PSAVERD&(PSAVER'=""):$E(PSAVERD,4,5)_"/"_$E(PSAVERD,6,7)_"/"_$E(PSAVERD,2,3),1:"")
"RTN","PSAPV",39,0)
 ..S ^TMP("PSAPVR",$J,PSAORD,PSAINV)=PSAINVDT_"^"_PSAPROC_"^"_PSAPROCD_"^"_PSAVER_"^"_PSAVERD
"RTN","PSAPV",40,0)
 ;
"RTN","PSAPV",41,0)
PRINT ;Print data
"RTN","PSAPV",42,0)
 S Y=PSAEND D DD^%DT S PSAENDX=Y K X,Y,%DT
"RTN","PSAPV",43,0)
 S Y=PSABEG D DD^%DT S PSABEGX=Y K X,Y,%DT
"RTN","PSAPV",44,0)
 D NOW^%DTC S PSARUN=%,PSARUN=$E(PSARUN,4,5)_"/"_$E(PSARUN,6,7)_"/"_$E(PSARUN,2,3)_"@"_$E($P(PSARUN,".",2),1,2)_":"_$E($P(PSARUN,".",2),3,4)
"RTN","PSAPV",45,0)
 S PSAPG=0,PSASLN="",$P(PSASLN,"-",123)="" K Y D HDR
"RTN","PSAPV",46,0)
 S PSAORD="" F  S PSAORD=$O(^TMP("PSAPVR",$J,PSAORD)) Q:PSAORD=""  D
"RTN","PSAPV",47,0)
 .I $Y+4>IOSL D HDR
"RTN","PSAPV",48,0)
 .W !,"Order #: "_PSAORD,?24,"|",?36,"|",?68,"|",?80,"|",?112,"|"
"RTN","PSAPV",49,0)
 .S PSAINV="" F  S PSAINV=$O(^TMP("PSAPVR",$J,PSAORD,PSAINV)) Q:PSAINV=""  D
"RTN","PSAPV",50,0)
 ..S PSADATA=^TMP("PSAPVR",$J,PSAORD,PSAINV),PSAINVDT=$P(PSADATA,"^"),PSAPROC=$P(PSADATA,"^",2),PSAPROCD=$P(PSADATA,"^",3),PSAVER=$P(PSADATA,"^",4),PSAVERD=$P(PSADATA,"^",5)
"RTN","PSAPV",51,0)
 ..W !,PSAINV,?24,"|",?26,PSAINVDT,?36,"|",?38,PSAPROC,?68,"|",?70,PSAPROCD,?80,"|",?82,PSAVER,?112,"|",?114,PSAVERD
"RTN","PSAPV",52,0)
 .W !,"                        |           |                               |           |                               |"
"RTN","PSAPV",53,0)
 W !,PSASLN,!
"RTN","PSAPV",54,0)
 ;
"RTN","PSAPV",55,0)
EXIT W @IOF
"RTN","PSAPV",56,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q"),^TMP("PSAPVR",$J)
"RTN","PSAPV",57,0)
 K %,%ZIS,DTOUT,PSABEG,PSABEG,PSABEGX,PSADATA,PSADATE,PSAEND,PSAENDX,PSAIEN,PSAIEN1,PSAIN,PSAINV,PSAINVDT
"RTN","PSAPV",58,0)
 K PSALINE,PSAORD,PSAOUT,PSAPG,PSAPROC,PSAPROCD,PSARUN,PSASLN,PSAVER,PSAVERD,X,X1,X2,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSAPV",59,0)
 Q
"RTN","PSAPV",60,0)
 ;
"RTN","PSAPV",61,0)
BDATE ;Gets beginning and ending invoice dates
"RTN","PSAPV",62,0)
 W ! S %DT="AEP",%DT("A")="Beginning Date: " D ^%DT
"RTN","PSAPV",63,0)
 I +Y<1!($D(DTOUT))!(X["^")!(X']"") S PSAOUT=1 Q
"RTN","PSAPV",64,0)
 I Y>DT K X,Y,%DT W !!,"Future dates are not permitted.",! K X,Y,%DT G BDATE
"RTN","PSAPV",65,0)
 S PSABEG=+Y
"RTN","PSAPV",66,0)
EDATE W ! S %DT="AE",%DT("A")="Ending Date   : " D ^%DT
"RTN","PSAPV",67,0)
 I +Y<1!($D(DTOUT))!(X["^")!(X']"") S PSAOUT=1 Q
"RTN","PSAPV",68,0)
 I Y<PSABEG K X,Y,%DT W !!,"Ending Date cannot be before the Start Date.",! K X,Y,%DT G EDATE
"RTN","PSAPV",69,0)
 S PSAEND=+Y
"RTN","PSAPV",70,0)
 Q
"RTN","PSAPV",71,0)
 ;
"RTN","PSAPV",72,0)
HDR ;Report header
"RTN","PSAPV",73,0)
 I $E(IOST)'="C",PSAPG W !,PSASLN,@IOF
"RTN","PSAPV",74,0)
 S PSAPG=PSAPG+1
"RTN","PSAPV",75,0)
 W !?46,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE",?114,"PAGE "_PSAPG,!?51,"PROCESSOR AND VERIFIER REPORT"
"RTN","PSAPV",76,0)
 I $E(IOST,1,2)="C-" W !,"RUN DATE: "_PSARUN,?52,PSABEGX_" - "_PSAENDX
"RTN","PSAPV",77,0)
 E  W !,?52,PSABEGX_" - "_PSAENDX
"RTN","PSAPV",78,0)
 W !!?24,"|  INVOICE",?36,"|",?68,"|   DATE",?80,"|",?112,"|   DATE"
"RTN","PSAPV",79,0)
 W !,"INVOICE#",?24,"|   DATE",?36,"| PROCESSOR",?68,"| PROCESSED",?80,"| VERIFIER",?112,"| VERIFIED"
"RTN","PSAPV",80,0)
 W !,"========================|===========|===============================|===========|===============================|========="
"RTN","PSAPV",81,0)
 Q
"RTN","PSAREPV")
0^26^B8786334
"RTN","PSAREPV",1,0)
PSAREPV ;BIR/LTL,JMB-Invoice Review ;7/23/97
"RTN","PSAREPV",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAREPV",3,0)
 ;This routine reviews prime vendor receipt transactions in GIP.
"RTN","PSAREPV",4,0)
 ;
"RTN","PSAREPV",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAREPV",6,0)
 ;
"RTN","PSAREPV",7,0)
 N DIC,DIR,DTOUT,DUOUT,PSA,PSALOC,PSAOUT,X,Y
"RTN","PSAREPV",8,0)
 D DT^DICRW
"RTN","PSAREPV",9,0)
 S DIC="^PSD(58.81,",DIC(0)="AEQS",D="PV",DIC("A")="Please select Prime Vendor Invoice number: "
"RTN","PSAREPV",10,0)
 D IX^DIC K DIC S PSA=+Y,PSA(2)=$P($G(^PSD(58.81,+Y,8)),"^") I Y<0 S PSAOUT=1 G END
"RTN","PSAREPV",11,0)
 I $P($G(^PSD(58.81,+Y,8)),"^")']"" S PSAOUT=1 G END
"RTN","PSAREPV",12,0)
DEV ;asks device and queueing info
"RTN","PSAREPV",13,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" S PSAOUT=1 G END
"RTN","PSAREPV",14,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAREPV",ZTDESC="Invoice receipt review",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSAREPV",15,0)
START ;compiles and prints output
"RTN","PSAREPV",16,0)
 N %DT,PSALN,PSAPG,PSARPDT S (PSAPG,PSAOUT)=0,Y=DT,PSA(1)="" X ^DD("DD") S PSARPDT=Y D HEADER
"RTN","PSAREPV",17,0)
LOOP F  S PSA(1)=$O(^PSD(58.81,"PV",PSA(2),PSA(1))) G:$G(PSAOUT)!('PSA(1)) END D:$Y+5>IOSL HEADER G:PSAOUT END D
"RTN","PSAREPV",18,0)
 .I '$D(PSALOC) S PSALOC=$P($G(^PSD(58.81,+PSA(1),0)),"^",3) W !,"Receiving Site: ",$P($G(^PSD(58.8,+PSALOC,0)),"^"),!
"RTN","PSAREPV",19,0)
 .I $G(PSALOC)'=$P($G(^PSD(58.81,+PSA(1),0)),"^",3) S PSALOC=$P($G(^(0)),"^",3) W !,"Receiving Site: ",$P($G(^PSD(58.8,+$P($G(^PSD(58.81,+PSA(1),0)),"^",3),0)),"^"),!
"RTN","PSAREPV",20,0)
 .S Y=$P($G(^PSD(58.81,+PSA(1),0)),"^",4) X ^DD("DD") W !,Y,"  ",$E($P($G(^PSDRUG(+$P($G(^PSD(58.81,+PSA(1),0)),"^",5),0)),"^"),1,25)," => "
"RTN","PSAREPV",21,0)
 .W $P($G(^PSD(58.81,+PSA(1),0)),"^",6)," rec'd by ",$E($P($G(^VA(200,+$P($G(^PSD(58.81,+PSA(1),0)),"^",7),0)),"^"),1,20),!
"RTN","PSAREPV",22,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSAREPV",23,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu. " D ^DIR
"RTN","PSAREPV",24,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAREPV",25,0)
 Q
"RTN","PSAREPV",26,0)
HEADER ;prints header info
"RTN","PSAREPV",27,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAREPV",28,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),"^"),"." S PSAOUT=1 Q
"RTN","PSAREPV",29,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,"History of receipts for Invoice # ",PSA(2),?57,PSARPDT,?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAREPV",30,0)
 Q
"RTN","PSAREV")
0^27^B9323380
"RTN","PSAREV",1,0)
PSAREV ;BIR/LTL-Purchase Order Review ;7/23/97
"RTN","PSAREV",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAREV",3,0)
 ;This routine reviews receipt transactions.
"RTN","PSAREV",4,0)
 ;
"RTN","PSAREV",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAREV",6,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSAREV",7,0)
 ;
"RTN","PSAREV",8,0)
 N DIC,DIR,DTOUT,DUOUT,PSALOC,PSAOUT,PSAPO,X,Y
"RTN","PSAREV",9,0)
 S DIC="^PRC(442,",DIC(0)="AEMQZ",DIC("A")="Please Select Purchase Order Number: ",DIC("S")="I $P($G(^(0)),U,5)[822400",PSAOUT=1 D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<1) END S PSAPO=+Y
"RTN","PSAREV",10,0)
 I '$O(^PSD(58.81,"C",+Y,"")) W !!,"There have been no receipts for this Purchase Order.",!! G END
"RTN","PSAREV",11,0)
DEV ;asks device and queueing info
"RTN","PSAREV",12,0)
 K IO("Q"),PSALOC N %ZIS,IOP,POP S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSAREV",13,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAREV",ZTDESC="Receipt transaction review",ZTSAVE("PSAPO")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSAREV",14,0)
START ;compiles and prints output
"RTN","PSAREV",15,0)
 N %DT,PSALN,PSAR,PSAPG,PSARPDT S (PSAPG,PSAOUT)=0,Y=DT,PSAR="" X ^DD("DD") S PSARPDT=Y D HEADER
"RTN","PSAREV",16,0)
LOOP F  S PSAR=$O(^PSD(58.81,"C",PSAPO,PSAR)) G:'PSAR END D:$Y+5>IOSL HEADER G:PSAOUT END D
"RTN","PSAREV",17,0)
 .I '$D(PSALOC) S PSALOC=$P($G(^PSD(58.81,+PSAR,0)),U,3) W !,"Receiving Site: ",$P($G(^PSD(58.8,+PSALOC,0)),U),!
"RTN","PSAREV",18,0)
 .I $G(PSALOC)'=$P($G(^PSD(58.81,+PSAR,0)),U,3) S PSALOC=$P($G(^(0)),U,3) W !,"Receiving Site: ",$P($G(^PSD(58.8,+$P($G(^PSD(58.81,+PSAR,0)),U,3),0)),U),!
"RTN","PSAREV",19,0)
 .S Y=$P($G(^PSD(58.81,+PSAR,0)),U,4) X ^DD("DD") W !,Y,"  ",$E($P($G(^PSDRUG(+$P($G(^PSD(58.81,PSAR,0)),U,5),0)),U),1,25)," -> "
"RTN","PSAREV",20,0)
 .W $P($G(^PSD(58.81,+PSAR,0)),U,6)," rec'd by ",$E($P($G(^VA(200,+$P($G(^PSD(58.81,+PSAR,0)),U,7),0)),U),1,20),!
"RTN","PSAREV",21,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSAREV",22,0)
 I $E(IOST,1,2)="C-",'PSAOUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSAREV",23,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAREV",24,0)
 Q
"RTN","PSAREV",25,0)
HEADER ;prints header info
"RTN","PSAREV",26,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAREV",27,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAREV",28,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !?2,"History of receipts for P.O.# ",$P($G(^PRC(442,+PSAPO,0)),U),?50,PSARPDT,?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAREV",29,0)
 Q
"RTN","PSAREVC")
0^28^B12504719
"RTN","PSAREVC",1,0)
PSAREVC ;BIR/LTL-Control Point Transaction Review ;7/23/97
"RTN","PSAREVC",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAREVC",3,0)
 ;
"RTN","PSAREVC",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAREVC",5,0)
 ;References to ^PRCS( are covered by IA #198
"RTN","PSAREVC",6,0)
 ;
"RTN","PSAREVC",7,0)
 W !!,"Because of the size of this file, look-ups of less than four characters",!!,"are NOT advised.  Please enter either the entire transaction number,",!!,"Station-FY-QTR-Control Point-Sequence Number, or at least the four digit"
"RTN","PSAREVC",8,0)
 W !!,"Sequence Number.",!!
"RTN","PSAREVC",9,0)
 N DIC,DIR,DTOUT,DUOUT,PSACON,PSALOC,PSAOUT,X,Y
"RTN","PSAREVC",10,0)
 S DIC="^PRCS(410,",DIC(0)="AEMQ",DIC("A")="Please select Control Point Transaction: ",DIC("S")="I $P($G(^(0)),U,2)=""O"",$P($G(^(3)),U,3)[822400",PSAOUT=1 D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<1) END S PSACON=+Y
"RTN","PSAREVC",11,0)
 I '$O(^PSD(58.81,"E",+PSACON,"")) W !!,"There are no receipts for this Transaction.",!! G END
"RTN","PSAREVC",12,0)
DEV ;asks device and queueing info
"RTN","PSAREVC",13,0)
 K IO("Q"),PSALOC N %ZIS,IOP,POP S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSAREVC",14,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAREVC",ZTDESC="Receipt transaction review",ZTSAVE("PSACON")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSAREVC",15,0)
START ;compiles and prints output
"RTN","PSAREVC",16,0)
 N %DT,PSALN,PSAR,PSAPG,PSARPDT S (PSAPG,PSAOUT)=0,Y=DT,PSAR="" X ^DD("DD") S PSARPDT=Y D HEADER
"RTN","PSAREVC",17,0)
LOOP F  S PSAR=$O(^PSD(58.81,"E",+PSACON,PSAR)) G:'PSAR END D:$Y+5>IOSL HEADER G:PSAOUT END D
"RTN","PSAREVC",18,0)
 .I '$D(PSALOC) S PSALOC=$P($G(^PSD(58.81,+PSAR,0)),U,3) W !,"Receiving Site: ",$P($G(^PSD(58.8,+PSALOC,0)),U),!
"RTN","PSAREVC",19,0)
 .I $G(PSALOC)'=$P($G(^PSD(58.81,+PSAR,0)),U,3) S PSALOC=$P($G(^(0)),U,3) W !,"Receiving Site: ",$P($G(^PSD(58.8,+$P($G(^PSD(58.81,+PSAR,0)),U,3),0)),U),!
"RTN","PSAREVC",20,0)
 .S Y=$P($G(^PSD(58.81,+PSAR,0)),U,4) X ^DD("DD") W !,Y,"  ",$E($P($G(^PSDRUG(+$P($G(^PSD(58.81,PSAR,0)),U,5),0)),U),1,25)," -> "
"RTN","PSAREVC",21,0)
 .W $P($G(^PSD(58.81,+PSAR,0)),U,6)," rec'd by ",$E($P($G(^VA(200,+$P($G(^PSD(58.81,+PSAR,0)),U,7),0)),U),1,20),!
"RTN","PSAREVC",22,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSAREVC",23,0)
 I $E(IOST,1,2)="C-",'PSAOUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSAREVC",24,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAREVC",25,0)
 Q
"RTN","PSAREVC",26,0)
HEADER ;prints header info
"RTN","PSAREVC",27,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAREVC",28,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAREVC",29,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,"History of receipts for Transaction # ",$P($G(^PRCS(410,+PSACON,0)),U),?57,PSARPDT,?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAREVC",30,0)
 Q
"RTN","PSAREVD")
0^29^B15044431
"RTN","PSAREVD",1,0)
PSAREVD ;BIR/LTL-Drug Receipt History Review ;7/23/97
"RTN","PSAREVD",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAREVD",3,0)
 ;This routine reviews receipt transactions for a drug.
"RTN","PSAREVD",4,0)
 ;
"RTN","PSAREVD",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAREVD",6,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSAREVD",7,0)
 ;References to ^PRCS( are covered by IA #198
"RTN","PSAREVD",8,0)
 ;
"RTN","PSAREVD",9,0)
 N DIC,DIR,DTOUT,DUOUT,PSA,PSACNT,PSALOCN,PSAR,PSAU,PSAOUT,PSAT,X,Y S PSAOUT=1,PSAU=0
"RTN","PSAREVD",10,0)
LOOK D ^PSADA I '$G(PSALOC) S PSAOUT=1 G END
"RTN","PSAREVD",11,0)
 I '$O(^PSD(58.8,PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN G END
"RTN","PSAREVD",12,0)
 S PSACNT=0 W !!,"You may select one, several, or ^ALL drugs.",!
"RTN","PSAREVD",13,0)
CHKD F  S DIC="^PSD(58.8,+PSALOC,1,",DIC(0)="AEMQ",DIC("A")="Please Select "_PSALOCN_"'s Drug: ",DIC("S")="I $S($G(^(""I"")):$G(^(""I""))>DT,1:1)" W ! D ^DIC K DIC G:X'="^ALL"&(Y<1)&('PSACNT) END Q:Y<0  S PSA(+Y)="",PSACNT=PSACNT+1
"RTN","PSAREVD",14,0)
 I PSACNT=1&('$O(^PSD(58.81,"F",+$O(PSA(0)),0))) W !!,"There have been no receipts for this drug.",!! G END
"RTN","PSAREVD",15,0)
 I X="^ALL" F  S PSAU=$O(^PSD(58.8,+PSALOC,1,PSAU)) Q:'PSAU  S PSA(PSAU)=""
"RTN","PSAREVD",16,0)
 S DIR(0)="D:AEP",DIR("A")="How far back in time do you want to go? ",DIR("B")="T-6M",DIR("?")="I will list receipts for your selected drug(s) within the last six months if you press return" W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSAREVD",17,0)
 S PSAT=Y
"RTN","PSAREVD",18,0)
DEV ;asks device and queueing info
"RTN","PSAREVD",19,0)
 K IO("Q"),PSALOC N %ZIS,IOP,POP S %ZIS="Q" W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSAREVD",20,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAREVD",ZTDESC="Drug receipt transaction review",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSAREVD",21,0)
START ;compiles and prints output
"RTN","PSAREVD",22,0)
 N %DT,PSALN,PSAR,PSAPG,PSARPDT S (PSAPG,PSAOUT)=0,Y=DT,PSAR="" X ^DD("DD") S PSARPDT=Y,PSAU(1)=$O(PSA(0)) D HEADER S PSAU=0
"RTN","PSAREVD",23,0)
 F  S PSAU=$O(PSA(PSAU)) Q:'PSAU  K PSAR(1) D  G:PSAOUT END I 'PSAR,$O(PSA(PSAU)) S PSAU(1)=$O(PSA(PSAU))
"RTN","PSAREVD",24,0)
LOOP .F  S PSAR=$O(^PSD(58.81,"F",PSAU,PSAR)) Q:'PSAR  D:$Y+6>IOSL HEADER Q:PSAOUT  S PSAR(2)=$G(^PSD(58.81,+PSAR,0)) D:$P(PSAR(2),U,4)'<PSAT&($P(PSAR(2),U,2)=1)
"RTN","PSAREVD",25,0)
 ..S PSAR(1)=$G(PSAR(1))+1 W:PSAR(1)=1 $P($G(^PSDRUG(+PSAU,0)),U),!
"RTN","PSAREVD",26,0)
 ..I '$D(PSALOC) S PSALOC=$P(PSAR(2),U,3) W !,"Receiving Site: ",$P($G(^PSD(58.8,+PSALOC,0)),U),!
"RTN","PSAREVD",27,0)
 ..I $G(PSALOC)'=$P(PSAR(2),U,3) S PSALOC=$P(PSAR(2),U,3) W !,"Receiving site: ",$P($G(^PSD(58.8,+PSALOC,0)),U),!
"RTN","PSAREVD",28,0)
 ..S Y=$E($P(PSAR(2),U,4),1,12) X ^DD("DD") W !,Y,"   -> "
"RTN","PSAREVD",29,0)
 ..W $P(PSAR(2),U,6)," received by ",$P($G(^VA(200,+$P(PSAR(2),U,7),0)),U),!!
"RTN","PSAREVD",30,0)
 ..W:$P($G(^PRC(442,+$P(PSAR(2),U,9),0)),U) "PO#:  ",$P($G(^(0)),U),?20
"RTN","PSAREVD",31,0)
 ..W:$P($G(^PRCS(410,+$P(PSAR(2),U,8),0)),U) "TR#:  ",$P($G(^(0)),U),"  "
"RTN","PSAREVD",32,0)
 ..W:$P($G(^PSD(58.81,+PSAR,8)),U)]"" "INV#:  ",$P($G(^(8)),U)
"RTN","PSAREVD",33,0)
 ..W !,PSALN,!
"RTN","PSAREVD",34,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSAREVD",35,0)
 I $E(IOST,1,2)="C-",'PSAOUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSAREVD",36,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAREVD",37,0)
 Q
"RTN","PSAREVD",38,0)
HEADER ;prints header info
"RTN","PSAREVD",39,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAREVD",40,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAREVD",41,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !?2,"History of Drug Receipts",?50,PSARPDT,?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAREVD",42,0)
 Q
"RTN","PSARIN")
0^30^B14125035
"RTN","PSARIN",1,0)
PSARIN ;BIR/LTL-Loadable Inventory Items Report ;7/23/97
"RTN","PSARIN",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSARIN",3,0)
 ;This routine reports the inventory/DA items.
"RTN","PSARIN",4,0)
 ;
"RTN","PSARIN",5,0)
 ;References to $$INVNAME^PRCPUX1 are covered by IA #259
"RTN","PSARIN",6,0)
 ;References to $$UNITCODE^PRCPUX1 are covered by IA #259
"RTN","PSARIN",7,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSARIN",8,0)
 ;References to ^PSDRUG("AB" are covered by IA #2095
"RTN","PSARIN",9,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSARIN",10,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSARIN",11,0)
 ;
"RTN","PSARIN",12,0)
SETUP N D0,D1,DA,DIE,DIC,DIR,DIRUT,DLAYGO,DR,DTOUT,DUOUT,PSADRUG,PSAINV,PSAOUT,X,Y
"RTN","PSARIN",13,0)
 ;LOOK UP LOCATION
"RTN","PSARIN",14,0)
LOOK D ^PSADA I '$G(PSALOC) S PSAOUT=1 G QUIT
"RTN","PSARIN",15,0)
NOINV I '$O(^PSD(58.8,+PSALOC,4,0)) W !,$G(PSALOCN)_" is not linked to an Inventory Point.",! D  G:$G(PSAOUT) QUIT
"RTN","PSARIN",16,0)
 .S DIR(0)="Y",DIR("A")="Would you like to attempt a link now",DIR("B")="Yes" D ^DIR K DIR S:Y'=1 PSAOUT=1 Q:Y'=1  D  I $D(Y)!('$G(PSAINV)) S PSAOUT=1 Q
"RTN","PSARIN",17,0)
INV ..S DIE=58.8,DA=PSALOC,DR="[PSAGIP]" D ^DIE K DIE
"RTN","PSARIN",18,0)
DEV K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G QUIT
"RTN","PSARIN",19,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSARIN",ZTDESC="Inventory items to load into DA Location",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSARIN",20,0)
START N %DT,PSALN,PSAIT,PSAL,PSAD,PSAPG,PSARPDT,X,Y S (PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y,PSAIT=0
"RTN","PSARIN",21,0)
 S PSAD="W !!,PSAIT,?10,$E($$DESCR^PRCPUX1(PSAINV,PSAIT),1,33),?45,$E($P(^PSDRUG($O(^PSDRUG(""AB"",PSAIT,0)),0),U),1,34)"
"RTN","PSARIN",22,0)
 S PSAINV=$O(^PSD(58.8,+PSALOC,4,0))
"RTN","PSARIN",23,0)
 I $O(^PSD(58.8,+PSALOC,4,+PSAINV)) D  S:Y<1 PSAOUT=1 G QUIT
"RTN","PSARIN",24,0)
 .S DIC="^PSD(58.8,+PSALOC,4,",DIC(0)="AEMQ",DA(1)=PSALOC D ^DIC K DIC
"RTN","PSARIN",25,0)
 .S PSAINV=+Y
"RTN","PSARIN",26,0)
 D HEADER
"RTN","PSARIN",27,0)
LOOP F  S PSAIT=$O(^PRCP(445,PSAINV,1,PSAIT)) Q:'PSAIT  D:$Y+4>IOSL HEADER Q:PSAOUT  I '$G(^PRC(441,PSAIT,3)),$O(^PSDRUG("AB",PSAIT,"")) S PSADRUG=$O(^PSDRUG("AB",PSAIT,"")) D:'$D(^PSD(58.8,PSALOC,1,PSADRUG,0))
"RTN","PSARIN",28,0)
 .S PSADRUG(1)=PSADRUG
"RTN","PSARIN",29,0)
 .I $S('$D(^PSDRUG(PSADRUG,"I")):1,+^("I")>DT:1,1:0) X PSAD W !!,"Inventory balance:  " S PSAIT(1)=$G(^PRCP(445,+PSAINV,1,+PSAIT,0)) D
"RTN","PSARIN",30,0)
 ..W $P(PSAIT(1),U,7)," ",$$UNITCODE^PRCPUX1($P(PSAIT(1),U,5))," times dispensing unit conv factor = ",$P(PSAIT(1),U,7)*$S($P(PSAIT(1),U,29):$P(PSAIT(1),U,29),1:1)," ",$P(PSAIT(1),U,28)
"RTN","PSARIN",31,0)
QUIT I $E(IOST)'="C" W @IOF
"RTN","PSARIN",32,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSARIN",33,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSARIN",34,0)
 K PSAIT Q
"RTN","PSARIN",35,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSARIN",36,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSARIN",37,0)
 S PSAINV(1)=$E($P(^PSD(58.8,PSALOC,0),U),1,10)
"RTN","PSARIN",38,0)
 S:$E(PSAINV(1),10)="(" PSAINV(1)=$E(PSAINV(1),1,9)
"RTN","PSARIN",39,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,$E($$INVNAME^PRCPUX1(PSAINV),1,24)_" items to load into "_PSAINV(1),?56,PSARPDT,?70,"PAGE: "_PSAPG,!,PSALN,!,"ITEM",?10,"DESCRIPTION",?50,"DRUG FILE LINK"
"RTN","PSARIN",40,0)
 Q
"RTN","PSAUNI")
0^31^B12565718
"RTN","PSAUNI",1,0)
PSAUNI ;BIR/LTL-Unlinked Drugs in the ITEM MASTER file ;7/23/97
"RTN","PSAUNI",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAUNI",3,0)
 ;
"RTN","PSAUNI",4,0)
 ;References to ^PSDRUG("AB" are covered by IA #2095
"RTN","PSAUNI",5,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSAUNI",6,0)
 ;
"RTN","PSAUNI",7,0)
 ;Check ITEM FILE for unlinked drugs
"RTN","PSAUNI",8,0)
 ;This report lists each active drug in the ITEM MASTER FILE that has not
"RTN","PSAUNI",9,0)
 ;yet been linked to an entry in the DRUG FILE. If you enter a date from
"RTN","PSAUNI",10,0)
 ;which to begin, only items that have been purchased since that date
"RTN","PSAUNI",11,0)
 ;will be listed.
"RTN","PSAUNI",12,0)
 ;
"RTN","PSAUNI",13,0)
 N DIR,PSA,PSADT,X,Y D DT^DICRW
"RTN","PSAUNI",14,0)
 S DIR(0)="D^::AEX",DIR("A")="Please enter oldest purchase date to include",DIR("B")="T-12M",DIR("?")="I will check each active drug to make sure it has been purchased since this date" W ! D ^DIR K DIR I 'Y S PSAOUT=1 G END
"RTN","PSAUNI",15,0)
 S PSADT=Y X ^DD("DD") S PSADT(1)=Y
"RTN","PSAUNI",16,0)
DEV ;asks device and queueing info
"RTN","PSAUNI",17,0)
 K I,IO("Q") N %ZIS,DTOUT,DUOUT,IOP,POP,PSAOUT S %ZIS="Q" W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G END
"RTN","PSAUNI",18,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAUNI",ZTSAVE("PSA*")="",ZTDESC="Active, Unlinked Drug Report" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSAUNI",19,0)
START ;compiles and prints data for report
"RTN","PSAUNI",20,0)
 N PSALN,PSAPG S (PSA,PSAPG,PSAOUT)=0 D HEADER
"RTN","PSAUNI",21,0)
LOOP F  S PSA=$O(^PRC(441,PSA)) G:'PSA!(PSAOUT) END D:$Y+10>IOSL HEADER I $P($G(^PRC(441,+PSA,0)),U,3)=6505,'$G(^PRC(441,+PSA,3)),$O(^PRC(441,+PSA,4,0)),'$O(^PSDRUG("AB",PSA,"")) D
"RTN","PSAUNI",22,0)
 .W:$E(IOST,1,2)="C-" "."
"RTN","PSAUNI",23,0)
 .S PSA(1)=0
"RTN","PSAUNI",24,0)
 .F  S PSA(1)=$O(^PRC(441,+PSA,4,PSA(1))) Q:'PSA(1)!('$O(^PRC(441,+PSA,4,PSA(1),1,0)))  D  Q:$G(PSA(3))
"RTN","PSAUNI",25,0)
 ..S PSA(2)=0 F  S PSA(2)=$O(^PRC(441,+PSA,4,PSA(1),1,PSA(2))) Q:'PSA(2)  I $P($G(^PRC(442,+$G(^PRC(441,+PSA,4,PSA(1),1,PSA(2),0)),1)),U,15)>PSADT D  Q
"RTN","PSAUNI",26,0)
 ...W !!,"ITEM #: ",PSA,"  ",$P($G(^PRC(441,+PSA,0)),U,2),!!,"NSN: ",$P($G(^(0)),U,5),?25,"LAST VENDOR ORDERED: ",$E($P($G(^PRC(440,+$P($G(^PRC(441,+PSA,0)),U,4),0)),U),1,30)
"RTN","PSAUNI",27,0)
 ...W !!,"NDC: ",$P($G(^PRC(441,+PSA,2,+$P($G(^PRC(441,+PSA,0)),U,4),0)),U,5)
"RTN","PSAUNI",28,0)
 ...S PSA(3)=1
"RTN","PSAUNI",29,0)
 ...W ?20,"LONG DESCRIPTION: "
"RTN","PSAUNI",30,0)
 ...I $L(^PRC(441,+PSA,1,1,0))<40,'$O(^PRC(441,+PSA,1,1)) W $G(^PRC(441,+PSA,1,1,0)),! Q
"RTN","PSAUNI",31,0)
 ...K ^UTILITY($J,"W") S DIWL=40,DIWR=80,DIWF="W"
"RTN","PSAUNI",32,0)
 ...S PSA(4)=0
"RTN","PSAUNI",33,0)
 ...F  S PSA(4)=$O(^PRC(441,+PSA,1,PSA(4))) Q:'PSA(4)  S X=$G(^PRC(441,+PSA,1,PSA(4),0)) D ^DIWP D ^DIWW
"RTN","PSAUNI",34,0)
END I $E(IOST)'="C" W @IOF
"RTN","PSAUNI",35,0)
 I $E(IOST,1,2)="C-",'PSAOUT W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSAUNI",36,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAUNI",37,0)
 Q
"RTN","PSAUNI",38,0)
HEADER ;prints header info
"RTN","PSAUNI",39,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAUNI",40,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAUNI",41,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !?2,"UNLINKED ITEM MASTER file DRUGS PURCHASED SINCE ",PSADT(1),?70,"PAGE: "_PSAPG,!,PSALN,!!
"RTN","PSAUNI",42,0)
 Q
"RTN","PSAUNM")
0^32^B6663222
"RTN","PSAUNM",1,0)
PSAUNM ;BIR/LTL-Report of Unlinked DRUG/ITEM MASTER file Entries ;7/23/97
"RTN","PSAUNM",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAUNM",3,0)
 ;
"RTN","PSAUNM",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAUNM",5,0)
 ;
"RTN","PSAUNM",6,0)
 D DT^DICRW
"RTN","PSAUNM",7,0)
DEV ;asks device and queueing info
"RTN","PSAUNM",8,0)
 K IO("Q") N %ZIS,DTOUT,DUOUT,IOP,POP,PSAOUT S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G QUIT
"RTN","PSAUNM",9,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAUNM",ZTDESC="Unlinked DRUG/ITEM FILE entries" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSAUNM",10,0)
START ;compiles and prints data for report
"RTN","PSAUNM",11,0)
 N DIR,DIRUT,POP,PSAB,PSAD,PSADD,PSAIT,PSALN,PSAPG,PSARPDT,X,Y S (PSAD,PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y D HEADER
"RTN","PSAUNM",12,0)
LOOP F  S PSAD=$O(^PSDRUG(PSAD)) G:'PSAD QUIT D:$Y+4>IOSL HEADER G:PSAOUT QUIT I '$O(^PSDRUG(PSAD,441,0)),'$D(^PSDRUG(PSAD,"I")) W !!,$E($P(^PSDRUG(PSAD,0),U),1,35),?36,$P(^(0),U,6),?56,$P($G(^(2)),U,4),?75,$S($D(^("ND")):"YES",1:"NO")
"RTN","PSAUNM",13,0)
QUIT I $E(IOST)'="C" W @IOF
"RTN","PSAUNM",14,0)
 I $E(IOST,1,2)="C-",'PSAOUT W !! S DIR(0)="E",DIR("A")="END OF REPORT!  Press <RET> to return to the menu" D ^DIR
"RTN","PSAUNM",15,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAUNM",16,0)
 Q
"RTN","PSAUNM",17,0)
HEADER ;prints header info
"RTN","PSAUNM",18,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAUNM",19,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAUNM",20,0)
 W:$Y @IOF S $P(PSALN,"*",81)="",PSAPG=PSAPG+1 W !?2,"Unlinked DRUG/ITEM MASTER file entries",?55,PSARPDT,?70,"PAGE: "_PSAPG,!,PSALN,!,"DRUG",?36,"FSN",?56,"NDC",?75,"NDF?"
"RTN","PSAUNM",21,0)
 Q
"RTN","PSAUTL1")
0^37^B45253114
"RTN","PSAUTL1",1,0)
PSAUTL1 ;BIR/JMB-Prime Vendor Invoice Data Utility ;9/19/97
"RTN","PSAUTL1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,12,15**; 10/24/97
"RTN","PSAUTL1",3,0)
 ;This routine contains utilities to get the location name, display an
"RTN","PSAUTL1",4,0)
 ;error-free item, display an item with errors, and display a line ready
"RTN","PSAUTL1",5,0)
 ;for verification. It is called by PSADJ, PSAHIS, PSALEVEL, PSALEVRP,
"RTN","PSAUTL1",6,0)
 ;PSANDF, PSAPROC, PSAPROC1, PSAPROC2, PSAPROC4, PSAPROC6, PSAPROC9,
"RTN","PSAUTL1",7,0)
 ;PSAREORD, PSAUTL3, PSAVER, PSAVER1, PSAVER2, PSAVER4, and PSAVER5.
"RTN","PSAUTL1",8,0)
 ;
"RTN","PSAUTL1",9,0)
 ;References to global ^PS(59.4, are covered under IA2505
"RTN","PSAUTL1",10,0)
 ;References to global ^DIC(51.5, are covered under IA1931
"RTN","PSAUTL1",11,0)
 ;References to global ^PS(59, are covered under IA212
"RTN","PSAUTL1",12,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAUTL1",13,0)
 ;
"RTN","PSAUTL1",14,0)
SITES ;Gets the combined IP/OP's IP & OP site names
"RTN","PSAUTL1",15,0)
 ;PSA*3*22 (DAVE B) no location defined
"RTN","PSAUTL1",16,0)
 I $G(PSALOC)'>0 S (PSAISITN,PSAOSITN)="Unknown",PSACOMB=" No location identifed" Q
"RTN","PSAUTL1",17,0)
 ;End PSA*3*22
"RTN","PSAUTL1",18,0)
 S PSAISIT=+$P($G(^PSD(58.8,PSALOC,0)),"^",3) D OPSITE
"RTN","PSAUTL1",19,0)
 I $G(PSAOSIT)="" S PSAOSIT=0
"RTN","PSAUTL1",20,0)
 S PSAISITN=$S($P($G(^PS(59.4,PSAISIT,0)),"^")'="":$P($G(^PS(59.4,PSAISIT,0)),"^"),1:"UNKNOWN")
"RTN","PSAUTL1",21,0)
 I PSAISIT,PSAOSIT S PSACOMB=": "_PSAISITN_" (IP) "_PSAOSITN_" (OP)" Q
"RTN","PSAUTL1",22,0)
 I PSAISIT S PSACOMB=": "_PSAISITN_" (IP)" Q
"RTN","PSAUTL1",23,0)
 I PSAOSIT S PSACOMB=": "_PSAOSITN_" (OP)" Q
"RTN","PSAUTL1",24,0)
 ;DAVE B (PSA*3*12) no DA sites defined
"RTN","PSAUTL1",25,0)
 S PSACOMB="No Inpatient or Outpatient Sites defined"
"RTN","PSAUTL1",26,0)
 Q
"RTN","PSAUTL1",27,0)
OPSITE ;PSA*3*25 - check for multiple OP sites
"RTN","PSAUTL1",28,0)
 K PSAOSITC
"RTN","PSAUTL1",29,0)
 Q:'$D(PSALOC)
"RTN","PSAUTL1",30,0)
 I '$D(^PSD(58.8,+PSALOC,7)),$P(^PSD(58.8,+PSALOC,0),"^",10)'="" S PSAOSIT=$P(^PSD(58.8,+PSALOC,0),"^",10),PSAOSITN=$P($G(^PS(59,PSAOSIT,0)),"^"),PSAOSITN=$S($G(PSAOSITN)="":"Unknown",1:PSAOSITN)
"RTN","PSAUTL1",31,0)
 S XX=0 F  S XX=$O(^PSD(58.8,+PSALOC,7,XX)) Q:XX'>0  S PSAOSIT=XX,PSAOSITC=$G(PSAOSITC)+1,SN=$P($G(^PS(59,XX,0)),"^") D
"RTN","PSAUTL1",32,0)
 .I PSAOSITC=1 S PSAOSITN=SN Q
"RTN","PSAUTL1",33,0)
 .S PSAOSITN=PSAOSITN_" & "_SN
"RTN","PSAUTL1",34,0)
 I $G(PSAOSITN)="",$P(^PSD(58.8,+PSALOC,0),"^",10)'="" S PSAOSIT=$P(^PSD(58.8,+PSALOC,0),"^",10),PSAOSITN=$P($G(^PS(59,+PSAOSIT,0)),"^")
"RTN","PSAUTL1",35,0)
 S PSAOSITN=$S($G(PSAOSITN)="":"unknown",1:PSAOSITN)
"RTN","PSAUTL1",36,0)
 Q
"RTN","PSAUTL1",37,0)
 ;
"RTN","PSAUTL1",38,0)
DISPLAY ;Displays an error-free line item
"RTN","PSAUTL1",39,0)
 S PSADISP=1
"RTN","PSAUTL1",40,0)
 S PSAIEN=$P(PSADATA,"^",6),PSASUB=$P($P(PSADATA,"^",7),"~"),PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~")
"RTN","PSAUTL1",41,0)
 W !,PSALINE_"  "_$S($P($G(^PSDRUG(PSAIEN,0)),"^")'="":$P(^PSDRUG(PSAIEN,0),"^"),1:"UNKNOWN")
"RTN","PSAUTL1",42,0)
 I PSAIEN D
"RTN","PSAUTL1",43,0)
 .I $P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" W " (Controlled Substance)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN MASTER VAULT **" Q
"RTN","PSAUTL1",44,0)
 .I $P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN PHARMACY LOCATION **"
"RTN","PSAUTL1",45,0)
 .I $D(^PSDRUG(PSAIEN,"I")) W !?5,"** INACTIVE IN DRUG FILE **"
"RTN","PSAUTL1",46,0)
 W !,"Qty Invoiced: "_+$P(PSADATA,"^")
"RTN","PSAUTL1",47,0)
 W:$P($P(PSADATA,"^",26),"~")'="" ?38,"UPC: "_$P($P(PSADATA,"^",26),"~")
"RTN","PSAUTL1",48,0)
 W !,"Order Unit  : "
"RTN","PSAUTL1",49,0)
 S PSAOU=$S(+$P(PSADATA,"^",12):+$P(PSADATA,"^",12),+$P($P(PSADATA,"^",2),"~",2):+$P($P(PSADATA,"^",2),"~",2),PSAIEN&(PSASUB)&(+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",5)):+$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",5),1:0)
"RTN","PSAUTL1",50,0)
 W $S(PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"UNKNOWN")
"RTN","PSAUTL1",51,0)
 W:$E(PSANDC)'="S" ?38,"NDC: "_$E(PSANDC,1,6)_"-"_$E(PSANDC,7,10)_"-"_$E(PSANDC,11,12)
"RTN","PSAUTL1",52,0)
 W !,"Unit Price  : $"_$P(PSADATA,"^",3),?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAUTL1",53,0)
 W !,"Dispense Units: "_$S(+PSAIEN&($P($G(^PSDRUG(+PSAIEN,660)),"^",8)'=""):$P($G(^PSDRUG(+PSAIEN,660)),"^",8),1:"Blank")
"RTN","PSAUTL1",54,0)
 W !,"Dispense Units Per Order Unit: "_$S($P(PSADATA,"^",20):+$P(PSADATA,"^",20),+PSASUB&(+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7),1:"Blank")
"RTN","PSAUTL1",55,0)
 S PSALOC=$S($P(PSADATA,"^",19)="":+$P(PSAIN,"^",7),1:+$P(PSAIN,"^",12))
"RTN","PSAUTL1",56,0)
 Q:'+$P($G(^PSD(58.8,+PSALOC,0)),"^",14)!('$G(PSAIEN))
"RTN","PSAUTL1",57,0)
 S PSASTOCK=$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3),1:"Blank")
"RTN","PSAUTL1",58,0)
 W !,"Stock Level   : "_PSASTOCK
"RTN","PSAUTL1",59,0)
 S PSAREORD=$S(+$P(PSADATA,"^",20):+$P(PSADATA,"^",20),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5),1:"Blank")
"RTN","PSAUTL1",60,0)
 W !,"Reorder Level : "_PSAREORD,!
"RTN","PSAUTL1",61,0)
 Q
"RTN","PSAUTL1",62,0)
 ;
"RTN","PSAUTL1",63,0)
EDITDISP ;Displays a line item with errors.
"RTN","PSAUTL1",64,0)
 W @IOF,!?23,"<<< PROCESS LINE ITEM SCREEN >>>",!,"Order#: "_$P(PSAIN,"^",4)_"  Invoice#: "_$P(PSAIN,"^",2)_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN),!,PSASLN
"RTN","PSAUTL1",65,0)
EDIT1 S PSADATA=$G(^XTMP("PSAPV",PSACTRL,"IT",PSALINE))
"RTN","PSAUTL1",66,0)
 S PSALOC=$S($P(PSADATA,"^",19)="":+$P(PSAIN,"^",7),1:+$P(PSAIN,"^",12))
"RTN","PSAUTL1",67,0)
 W !,PSALINE_"  "_$S($D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")):$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"),"^",3),PSAIEN&($P($G(^PSDRUG(PSAIEN,0)),"^")'=""):$P(^PSDRUG(PSAIEN,0),"^"),1:"UNKNOWN ITEM")
"RTN","PSAUTL1",68,0)
 I PSAIEN D
"RTN","PSAUTL1",69,0)
 .I $P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" W " (Controlled Substance)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN MASTER VAULT **" Q
"RTN","PSAUTL1",70,0)
 .I $P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN PHARMACY LOCATION **"
"RTN","PSAUTL1",71,0)
 ;
"RTN","PSAUTL1",72,0)
 W !,"Qty Invoiced: "
"RTN","PSAUTL1",73,0)
 I $P(PSADATA,"^",8)'="" W $P(PSADATA,"^",8)_" ("_$S(+PSADATA:+PSADATA,$P(PSADATA,"^")=0:0,1:"Blank")_")"
"RTN","PSAUTL1",74,0)
 I $P(PSADATA,"^",8)="" W $S(+PSADATA:+PSADATA,$P(PSADATA,"^")=0:0,1:"Blank")
"RTN","PSAUTL1",75,0)
 W:$P($P(PSADATA,"^",26),"~")'="" ?38,"UPC: "_$P($P(PSADATA,"^",26),"~")
"RTN","PSAUTL1",76,0)
 ;
"RTN","PSAUTL1",77,0)
 W !,"Order Unit  : "
"RTN","PSAUTL1",78,0)
 I +$P(PSADATA,"^",12) D
"RTN","PSAUTL1",79,0)
 .W $P($G(^DIC(51.5,+$P(PSADATA,"^",12),0)),"^")
"RTN","PSAUTL1",80,0)
 .W " ("_$S($P($P(PSADATA,"^",2),"~")'="":$P($P(PSADATA,"^",2),"~"),$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",3),0)),"^")'="":$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",3),0)),"^"),1:"Blank")_")"
"RTN","PSAUTL1",81,0)
 I '+$P(PSADATA,"^",12) D
"RTN","PSAUTL1",82,0)
 .W $S(+$P($P(PSADATA,"^",2),"~",2):$P($P(PSADATA,"^",2),"~"),PSAIEN&(PSASUB)&(+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",5)):$P($G(^DIC(51.5,+$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",5),0)),"^"),1:"Blank")
"RTN","PSAUTL1",83,0)
 ;
"RTN","PSAUTL1",84,0)
 W:$E(PSANDC)'="S" ?38,"NDC: "_$S(PSANDC'="":$E(PSANDC,1,6)_"-"_$E(PSANDC,7,10)_"-"_$E(PSANDC,11,12),1:"Blank")
"RTN","PSAUTL1",85,0)
 S PSAPRICE=$P(PSADATA,"^",3)
"RTN","PSAUTL1",86,0)
 I +PSAPRICE,$L($P(PSAPRICE,".",2))<2 S PSAPRICE=$P(PSAPRICE,".")_"."_$P(PSAPRICE,".",2)_$E("00",1,(2-$L($P(PSAPRICE,".",2))))
"RTN","PSAUTL1",87,0)
 W !,"Unit Price  : $"_$S($G(PSAPRICE):PSAPRICE,PSAPRICE=0:0,1:"Blank"),?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAUTL1",88,0)
 S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSALOC=$S($P(PSADATA,"^",19)="CS":+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",7))
"RTN","PSAUTL1",89,0)
DU W !,"Dispense Units: "_$S(+PSAIEN&($P($G(^PSDRUG(+PSAIEN,660)),"^",8)'=""):$P($G(^PSDRUG(+PSAIEN,660)),"^",8),1:"Blank")
"RTN","PSAUTL1",90,0)
DUOU W !,"Dispense Units Per Order Unit: "_$S($P(PSADATA,"^",20):+$P(PSADATA,"^",20),+PSASUB&(+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7),1:"Blank"),!
"RTN","PSAUTL1",91,0)
 ;
"RTN","PSAUTL1",92,0)
 Q:'+$P($G(^PSD(58.8,+PSALOC,0)),"^",14)
"RTN","PSAUTL1",93,0)
 ;
"RTN","PSAUTL1",94,0)
 S PSASTOCK=$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3),1:"Blank")
"RTN","PSAUTL1",95,0)
 W "Stock Level   : "_PSASTOCK
"RTN","PSAUTL1",96,0)
 S PSAREORD=$S(+$P(PSADATA,"^",15):+$P(PSADATA,"^",15),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5),1:"Blank")
"RTN","PSAUTL1",97,0)
 W !,"Reorder Level : "_PSAREORD,!
"RTN","PSAUTL1",98,0)
 Q
"RTN","PSAVER4")
0^33^B8379472
"RTN","PSAVER4",1,0)
PSAVER4 ;;BIR/JMB-Verify Invoices - CONT'D ;9/8/97
"RTN","PSAVER4",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAVER4",3,0)
 ;This routine prints the report of new drugs that will be added to
"RTN","PSAVER4",4,0)
 ;each pharmacy location or master vault.
"RTN","PSAVER4",5,0)
 ;
"RTN","PSAVER4",6,0)
 ;Asks & prints all invoices the user can verify.
"RTN","PSAVER4",7,0)
 W @IOF,!,"The verified invoices contain new drugs for the assigned pharmacy location.",!,"A report will print by pharmacy location listing the new drugs. Use the"
"RTN","PSAVER4",8,0)
 W !,"Balance Adjustment option to enter an adjustment that reflects the total",!,"dispense units on hand for each new drug.",!!,"It is suggested that you send the report to a print."
"RTN","PSAVER4",9,0)
 K IO("Q") S %ZIS="Q" W !
"RTN","PSAVER4",10,0)
 D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSAVER4",11,0)
 I $D(IO("Q")) D  G QUIT
"RTN","PSAVER4",12,0)
 .N ZTSAVE,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSAVER4",13,0)
 .S ZTDESC="Drug Acct. - Print New Drugs",ZTDTH=$H,ZTRTN="PRINT^PSAVER4"
"RTN","PSAVER4",14,0)
 .S ZTSAVE("PSANEWD(")="" D ^%ZTLOAD
"RTN","PSAVER4",15,0)
 ;
"RTN","PSAVER4",16,0)
PRINT ;Sends invoices to printer
"RTN","PSAVER4",17,0)
 S (PSALOC,PSAOUT)=0,PSAPG=1,PSADLN="",$P(PSADLN,"=",80)="",PSASLN="",$P(PSASLN,"-",80)=""
"RTN","PSAVER4",18,0)
 F  S PSALOC=+$O(PSANEWD(PSALOC)) Q:'PSALOC!(PSAOUT)  S PSADRGN=1 D HDR  Q:PSAOUT  D  Q:PSAOUT
"RTN","PSAVER4",19,0)
 .F  S PSADRGN=$O(PSANEWD(PSALOC,PSADRGN)) Q:PSADRGN=""!(PSAOUT)  D:$Y+5>IOSL HDR Q:PSAOUT  W !,PSADRGN,!,PSASLN,!
"RTN","PSAVER4",20,0)
 D:$E(IOST,1,2)="C-"&('PSAOUT) END^PSAPROC W:$E(IOST)'="C" @IOF
"RTN","PSAVER4",21,0)
 K PSANEWD(PSALOC)
"RTN","PSAVER4",22,0)
QUIT D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAVER4",23,0)
 Q
"RTN","PSAVER4",24,0)
 ;
"RTN","PSAVER4",25,0)
HDR     ;Prints the header to the New Drug Report on the screen & paper.
"RTN","PSAVER4",26,0)
 I $E(IOST,1,2)="C-" D:PSAPG'=1 END^PSAPROC Q:PSAOUT  W @IOF,!?28,"<<< NEW DRUG REPORT >>>"
"RTN","PSAVER4",27,0)
 I $E(IOST)'="C" W:PSAPG'=1 @IOF W !?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE",!?28,"<<< NEW DRUG REPORT >>>",?72,"Page "_PSAPG
"RTN","PSAVER4",28,0)
 I $P($G(^PSD(58.8,PSALOC,0)),"^",2)="M" W !?34,"MASTER VAULT",!!,$P($G(^PSD(58.8,PSALOC,0)),"^")
"RTN","PSAVER4",29,0)
 I $P($G(^PSD(58.8,PSALOC,0)),"^",2)="P" D
"RTN","PSAVER4",30,0)
 .D SITES^PSAUTL1 S PSALOCN=$P(^PSD(58.8,PSALOC,0),"^")_PSACOMB
"RTN","PSAVER4",31,0)
 .W !?31,"PHARMACY LOCATION",!!
"RTN","PSAVER4",32,0)
 .W:$L(PSALOCN)>76 $P(PSALOCN,"(IP)",1)_"(IP)",!?17,$P(PSALOCN,"(IP)",2) W:$L(PSALOCN)<77 PSALOCN
"RTN","PSAVER4",33,0)
 W !,PSADLN S PSAPG=PSAPG+1
"RTN","PSAVER4",34,0)
 Q
"RTN","PSAVIN")
0^34^B9425519
"RTN","PSAVIN",1,0)
PSAVIN ;BIR/LTL-Report of Inventory items' link to DRUG FILE ;7/23/97
"RTN","PSAVIN",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAVIN",3,0)
 ;
"RTN","PSAVIN",4,0)
 ;References to $$DESCR^PRCPUX1 are covered by IA #259
"RTN","PSAVIN",5,0)
 ;References to $$INVNAME^PRCPUX1 are covered by IA #259
"RTN","PSAVIN",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVIN",7,0)
 ;References to ^PSDRUG("AB" are covered by IA #2095
"RTN","PSAVIN",8,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSAVIN",9,0)
 ;
"RTN","PSAVIN",10,0)
 D DT^DICRW N DIR,DIRUT,X,Y,PSALOC,PSAOUT,DIC,DTOUT,DUOUT,PSAINV,PSAIT
"RTN","PSAVIN",11,0)
LOOK ;Select Inventory point
"RTN","PSAVIN",12,0)
 S DIC="^PRCP(445,",DIC(0)="AEMQ",DIC("S")="I $P($G(^(0)),U,20)=""D""",PRCPPRIV=1 D ^DIC K DIC,PRCPPRIV S PSAINV=+Y,PSAIT=0 I Y<0 S PSAOUT=1 G QUIT
"RTN","PSAVIN",13,0)
 I '$O(^PSD(58.8,"P",+PSAINV,0)) W !!,$$INVNAME^PRCPUX1(PSAINV)_" is NOT linked to a Drug Accountability Location.",!!
"RTN","PSAVIN",14,0)
 S PSALOC=$O(^PSD(58.8,"P",+PSAINV,0)) W:PSALOC !!,$$INVNAME^PRCPUX1(PSAINV)_" is linked to",!!,$P($G(^PSD(58.8,+PSALOC,0)),U),!!
"RTN","PSAVIN",15,0)
DEV ;asks device and queueing info
"RTN","PSAVIN",16,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G QUIT
"RTN","PSAVIN",17,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAVIN",ZTDESC="Inventory items link to DRUG FILE Report",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSAVIN",18,0)
START N %DT,DIR,DIRUT,PSALN,PSAD,PSAPG,PSAOUT,PSARPDT,X,Y S (PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y
"RTN","PSAVIN",19,0)
 D HEADER
"RTN","PSAVIN",20,0)
LOOP F  S PSAIT=$O(^PRCP(445,PSAINV,1,PSAIT)) Q:'PSAIT  D:$Y+4>IOSL HEADER Q:PSAOUT  D
"RTN","PSAVIN",21,0)
 .W !!,PSAIT,?10,$E($$DESCR^PRCPUX1(PSAINV,PSAIT),1,33),?45,$E($S($P($G(^PSDRUG(+$O(^PSDRUG("AB",+PSAIT,0)),0)),U)]"":$P($G(^(0)),U),1:"NONE"),1,34)
"RTN","PSAVIN",22,0)
QUIT I $E(IOST)'="C" W @IOF
"RTN","PSAVIN",23,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSAVIN",24,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAVIN",25,0)
 Q
"RTN","PSAVIN",26,0)
HEADER ;prints header info
"RTN","PSAVIN",27,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAVIN",28,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAVIN",29,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,$E($$INVNAME^PRCPUX1(PSAINV),1,23)_" Items' Link to DRUG file",?50,PSARPDT,?70,"PAGE: "_PSAPG,!,PSALN,!,"ITEM",?10,"DESCRIPTION",?45,"DRUG FILE LINK"
"RTN","PSAVIN",30,0)
 Q
"RTN","PSAVIN1")
0^35^B14411045
"RTN","PSAVIN1",1,0)
PSAVIN1 ;BIR/LTL-Physical Inventory Balance Review ;7/23/97
"RTN","PSAVIN1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAVIN1",3,0)
 ;This routine reviews balances for a drug.
"RTN","PSAVIN1",4,0)
 ;
"RTN","PSAVIN1",5,0)
 ;References to $$DESCR^PRCPUX1 are covered by IA #259
"RTN","PSAVIN1",6,0)
 ;References to $$INVNAME^PRCPUX1 are covered by IA #259
"RTN","PSAVIN1",7,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVIN1",8,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSAVIN1",9,0)
 ;
"RTN","PSAVIN1",10,0)
 N DIC,DIR,DTOUT,DUOUT,PSA,PSACNT,PSALOCN,PSAR,PSAU,PSAOUT,PSAT,X,Y S PSAOUT=1,PSAU=0
"RTN","PSAVIN1",11,0)
LOOK D ^PSADA I '$G(PSALOC) S PSAOUT=1 G END
"RTN","PSAVIN1",12,0)
 I '$O(^PSD(58.8,PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN G END
"RTN","PSAVIN1",13,0)
 W !!,"The balances displayed from a Primary Inventory Point are based on the most",!,"recent physical inventory and may NOT reflect accurate quantities when",!,"converted to the dispensing unit level."
"RTN","PSAVIN1",14,0)
 S PSACNT=0 W !!,"You may select one, several, or ^ALL drugs.",!
"RTN","PSAVIN1",15,0)
CHKD F  S DIC="^PSD(58.8,+PSALOC,1,",DIC(0)="AEMQ",DIC("A")="Please Select "_PSALOCN_"'s Drug: ",DIC("S")="I $S($G(^(""I"")):$G(^(""I""))>DT,1:1)" W ! D ^DIC K DIC G:X'="^ALL"&(Y<1)&('PSACNT) END Q:Y<0  S PSA(+Y)="",PSACNT=PSACNT+1
"RTN","PSAVIN1",16,0)
 I X="^ALL" F  S PSAU=$O(^PSD(58.8,+PSALOC,1,PSAU)) Q:'PSAU  S PSA(PSAU)=""
"RTN","PSAVIN1",17,0)
DEV ;asks device and queueing info
"RTN","PSAVIN1",18,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSAVIN1",19,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAVIN1",ZTDESC="Drug balance review",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSAVIN1",20,0)
START ;compiles and prints output
"RTN","PSAVIN1",21,0)
 N %DT,PSALN,PSAR,PSAPG,PSARPDT S (PSAPG,PSAOUT)=0,Y=DT,PSAR="" X ^DD("DD") S PSARPDT=Y,PSAU(1)=$O(PSA(0)) D HEADER S PSAU=0
"RTN","PSAVIN1",22,0)
 F  S PSAU=$O(PSA(PSAU)) Q:'PSAU  D  Q:$G(PSAOUT)
"RTN","PSAVIN1",23,0)
LOOP .D:$Y+8>IOSL HEADER  Q:$G(PSAOUT)
"RTN","PSAVIN1",24,0)
 .I $G(PSAU(5))>1 W "Total of all Primary Inventory items: ",$G(PSAU(7)),!!
"RTN","PSAVIN1",25,0)
 .W !,$P($G(^PSDRUG(+PSAU,0)),U) K PSAU(5),PSAU(7)
"RTN","PSAVIN1",26,0)
 .W !!,$G(PSALOCN),"'s balance: ",$P($G(^PSD(58.8,+PSALOC,1,+PSAU,0)),U,4)," "
"RTN","PSAVIN1",27,0)
 .W $P($G(^PSDRUG(+PSAU,660)),U,8),!!
"RTN","PSAVIN1",28,0)
 .Q:'$O(^PSDRUG(+PSAU,441,0))
"RTN","PSAVIN1",29,0)
 .F PSAU(1)=0:0 S PSAU(1)=$O(^PSDRUG(+PSAU,441,PSAU(1))) Q:'PSAU(1)  D
"RTN","PSAVIN1",30,0)
 ..S PSAU(2)=$P($G(^PSDRUG(+PSAU,441,+PSAU(1),0)),U) Q:'PSAU(2)
"RTN","PSAVIN1",31,0)
 ..Q:'$O(^PRCP(445,"AE",+PSAU(2),0))
"RTN","PSAVIN1",32,0)
 ..F PSAU(3)=0:0 S PSAU(3)=$O(^PRCP(445,"AE",+PSAU(2),PSAU(3))) Q:'PSAU(3)  D:$O(^PSD(58.8,"P",PSAU(3),0))
"RTN","PSAVIN1",33,0)
 ...S PSAU(5)=$G(PSAU(5))+1
"RTN","PSAVIN1",34,0)
 ...W $$DESCR^PRCPUX1(PSAU(3),PSAU(2))
"RTN","PSAVIN1",35,0)
 ...W !!,$$INVNAME^PRCPUX1(PSAU(3)),"'s balance: "
"RTN","PSAVIN1",36,0)
 ...S PSAU(6)=$P($G(^PRCP(445,+PSAU(3),1,+PSAU(2),0)),U,7)*$S($P($G(^(0)),U,29):$P($G(^(0)),U,29),1:1) W PSAU(6)," ",$P($G(^(0)),U,28),!!
"RTN","PSAVIN1",37,0)
 ...S PSAU(7)=$G(PSAU(7))+PSAU(6)
"RTN","PSAVIN1",38,0)
 W:$G(PSAU(5))>1 "Total of all Primary Inventory items: ",$G(PSAU(7)),!!
"RTN","PSAVIN1",39,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSAVIN1",40,0)
 I $E(IOST,1,2)="C-",'PSAOUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSAVIN1",41,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAVIN1",42,0)
 Q
"RTN","PSAVIN1",43,0)
HEADER ;prints header info
"RTN","PSAVIN1",44,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAVIN1",45,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAVIN1",46,0)
 W:$Y @IOF S $P(PSALN,"&",81)="",PSAPG=PSAPG+1 W !?2,"Physical Inventory Balance Review",?55,PSARPDT,?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAVIN1",47,0)
 Q
"RTN","PSAVIN2")
0^36^B13218269
"RTN","PSAVIN2",1,0)
PSAVIN2 ;BIR/LTL-Compares Prices (DA/GIP) ;7/23/97
"RTN","PSAVIN2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15**; 10/24/97
"RTN","PSAVIN2",3,0)
 ;This routine reviews prices for a drug.
"RTN","PSAVIN2",4,0)
 ;
"RTN","PSAVIN2",5,0)
 ;References to $$DESCR^PRCPUX1 are covered by IA #259
"RTN","PSAVIN2",6,0)
 ;References to $$INVNAME^PRCPUX1 are covered by IA #259
"RTN","PSAVIN2",7,0)
 ;References to $$UNITCODE^PRCPUX1 are covered by IA #259
"RTN","PSAVIN2",8,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVIN2",9,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSAVIN2",10,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAVIN2",11,0)
 ;
"RTN","PSAVIN2",12,0)
 N DIC,DIR,DTOUT,DUOUT,PSA,PSACNT,PSALOCN,PSAR,PSAU,PSAOUT,PSAT,X,X2,X3,Y S PSAOUT=1,PSAU=0
"RTN","PSAVIN2",13,0)
LOOK D ^PSADA I '$G(PSALOC) S PSAOUT=1 G END
"RTN","PSAVIN2",14,0)
 I '$O(^PSD(58.8,PSALOC,1,0)) W !!,"There are no drugs in ",PSALOCN G END
"RTN","PSAVIN2",15,0)
 S PSACNT=0 W !!,"You may select one, several, or ^ALL drugs.",!
"RTN","PSAVIN2",16,0)
CHKD F  S DIC="^PSD(58.8,+PSALOC,1,",DIC(0)="AEMQ",DIC("A")="Please Select "_PSALOCN_"'s Drug: ",DIC("S")="I $S($G(^(""I"")):$G(^(""I""))>DT,1:1)" W ! D ^DIC K DIC G:X'="^ALL"&(Y<1)&('PSACNT) END Q:Y<0  S PSA(+Y)="",PSACNT=PSACNT+1
"RTN","PSAVIN2",17,0)
 I X="^ALL" F  S PSAU=$O(^PSD(58.8,+PSALOC,1,PSAU)) Q:'PSAU  S PSA(PSAU)=""
"RTN","PSAVIN2",18,0)
DEV ;asks device and queueing info
"RTN","PSAVIN2",19,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q" W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSAVIN2",20,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAVIN2",ZTDESC="Drug price review",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G END
"RTN","PSAVIN2",21,0)
START ;compiles and prints output
"RTN","PSAVIN2",22,0)
 N %DT,PSALN,PSAR,PSAPG,PSARPDT S (PSAPG,PSAOUT)=0,Y=DT,PSAR="" X ^DD("DD") S PSARPDT=Y,PSAU(1)=$O(PSA(0)) D HEADER S PSAU=0
"RTN","PSAVIN2",23,0)
 F  S PSAU=$O(PSA(PSAU)) Q:'PSAU  D  Q:$G(PSAOUT)
"RTN","PSAVIN2",24,0)
LOOP .D:$Y+8>IOSL HEADER  Q:$G(PSAOUT)
"RTN","PSAVIN2",25,0)
 .W !,$P($G(^PSDRUG(+PSAU,0)),U)
"RTN","PSAVIN2",26,0)
 .S PSAU(9)=$G(^PSDRUG(+PSAU,660))
"RTN","PSAVIN2",27,0)
 .W !!,"DRUG file prices: "
"RTN","PSAVIN2",28,0)
 .S X=$P(PSAU(9),U,3),X2="2$",X3=4 D COMMA^%DTC W X,"/"
"RTN","PSAVIN2",29,0)
 .S PSAU(8)=$P($G(^DIC(51.5,+$P(PSAU(9),U,2),0)),U)
"RTN","PSAVIN2",30,0)
 .W PSAU(8),"     (",$P(PSAU(9),U,5)," ",$P(PSAU(9),U,8),"/",PSAU(8)
"RTN","PSAVIN2",31,0)
 .S X=$P(PSAU(9),U,6),X2="3$",X3=4 D COMMA^%DTC
"RTN","PSAVIN2",32,0)
 .W ")     => ",X,"/",$P(PSAU(9),U,8),!!
"RTN","PSAVIN2",33,0)
 .Q:'$O(^PSDRUG(+PSAU,441,0))
"RTN","PSAVIN2",34,0)
 .F PSAU(1)=0:0 S PSAU(1)=$O(^PSDRUG(+PSAU,441,PSAU(1))) Q:'PSAU(1)  D
"RTN","PSAVIN2",35,0)
 ..S PSAU(2)=$P($G(^PSDRUG(+PSAU,441,+PSAU(1),0)),U) Q:'PSAU(2)
"RTN","PSAVIN2",36,0)
 ..Q:'$O(^PRCP(445,"AE",+PSAU(2),0))
"RTN","PSAVIN2",37,0)
 ..F PSAU(3)=0:0 S PSAU(3)=$O(^PRCP(445,"AE",+PSAU(2),PSAU(3))) Q:'PSAU(3)  D:$O(^PSD(58.8,"P",PSAU(3),0))
"RTN","PSAVIN2",38,0)
 ...S PSAU(5)=$G(PSAU(5))+1
"RTN","PSAVIN2",39,0)
 ...W $$DESCR^PRCPUX1(PSAU(3),PSAU(2))
"RTN","PSAVIN2",40,0)
 ...W !!,$$INVNAME^PRCPUX1(PSAU(3)),"'s prices: "
"RTN","PSAVIN2",41,0)
 ...S PSAU(6)=$G(^PRCP(445,+PSAU(3),1,+PSAU(2),0))
"RTN","PSAVIN2",42,0)
 ...S X=$P(PSAU(6),U,15),X2="2$",X3=4 D COMMA^%DTC W X,"/"
"RTN","PSAVIN2",43,0)
 ...S PSAU(11)=$$UNITCODE^PRCPUX1($P(PSAU(6),U,5))
"RTN","PSAVIN2",44,0)
 ...W PSAU(11),"     (",$P(PSAU(6),U,29)
"RTN","PSAVIN2",45,0)
 ...W " ",$P(PSAU(6),U,28),"/",PSAU(11),")"
"RTN","PSAVIN2",46,0)
 ...S X=($P(PSAU(6),U,15)/($S(($P(PSAU(6),U,29)>0):$P(PSAU(6),U,29),1:1)))
"RTN","PSAVIN2",47,0)
 ...S X2="3$",X3=4 D COMMA^%DTC W "  => ",X,"/",$P(PSAU(6),U,28),!!
"RTN","PSAVIN2",48,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSAVIN2",49,0)
 I $E(IOST,1,2)="C-",'PSAOUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSAVIN2",50,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSAVIN2",51,0)
 Q
"RTN","PSAVIN2",52,0)
HEADER ;prints header info
"RTN","PSAVIN2",53,0)
 I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAVIN2",54,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSAVIN2",55,0)
 W:$Y @IOF S $P(PSALN,"&",81)="",PSAPG=PSAPG+1 W !?2,"DRUG File/Inventory Price Review",?55,PSARPDT,?70,"PAGE: ",PSAPG,!,PSALN,!
"RTN","PSAVIN2",56,0)
 Q
"VER")
8.0^22.0
**END**
**END**
