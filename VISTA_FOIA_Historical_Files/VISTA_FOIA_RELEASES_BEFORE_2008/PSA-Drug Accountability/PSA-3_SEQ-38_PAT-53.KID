Released PSA*3*53 SEQ #38
Extracted from mail message
**KIDS**:PSA*3.0*53^

**INSTALL NAME**
PSA*3.0*53
"BLD",6287,0)
PSA*3.0*53^DRUG ACCOUNTABILITY^0^3050909^y
"BLD",6287,1,0)
^^28^28^3050824^
"BLD",6287,1,1,0)
This patch addresses the following problems:
"BLD",6287,1,2,0)
  
"BLD",6287,1,3,0)
1.      68490   Editing Verified Invoices [PSA EDIT VERIFIED INVOICE]
"BLD",6287,1,4,0)
Saying 'NO" to processing the edit changes made for DISPENSE UNITS field 
"BLD",6287,1,5,0)
(#14.5) and/or DISPENSE UNITS PER ORDER UNIT field (#15) of the Drug file 
"BLD",6287,1,6,0)
(#50), does not restore those fields to their previous values.
"BLD",6287,1,7,0)
 
"BLD",6287,1,8,0)
2.      68779   Editing Verified Invoices [PSA EDIT VERIFIED INVOICE]
"BLD",6287,1,9,0)
A drug that is newly picked and added newly to a pharmacy location in the 
"BLD",6287,1,10,0)
DRUG ACCOUNTABILITY STATS file (#58.8) has several of it's indexes 
"BLD",6287,1,11,0)
scrambled and the users are not able to select the drug within that 
"BLD",6287,1,12,0)
pharmacy location for any further processing purposes. A post init 
"BLD",6287,1,13,0)
routine will scan and clean up bad indexes it finds.
"BLD",6287,1,14,0)
 
"BLD",6287,1,15,0)
3.      100058 Drug Balances by Location [PSA DISPLAY LOCATION]
"BLD",6287,1,16,0)
The report menu "Drug Balances by Location" show entries for inactive 
"BLD",6287,1,17,0)
drugs that have a zero quantity. Those items are now not to be shown.
"BLD",6287,1,18,0)
 
"BLD",6287,1,19,0)
4.      108683 Verify Invoices [PSA VERIFY INVOICES]
"BLD",6287,1,20,0)
Drugs that are new to a pharmacy location in the DRUG ACCOUNTABILITY 
"BLD",6287,1,21,0)
STATS file (#58.8) are needing more data entered to complete their being 
"BLD",6287,1,22,0)
setup for processing. Such items as current balance, stock level, and 
"BLD",6287,1,23,0)
reorder levels are needed. A separate, individual mail message is 
"BLD",6287,1,24,0)
currently sent regarding each drug that is newly added. The volume of 
"BLD",6287,1,25,0)
messages is overwhelming.
"BLD",6287,1,26,0)
 
"BLD",6287,1,27,0)
A single consolidated mail message by invoice regarding drugs that are 
"BLD",6287,1,28,0)
newly added is needed to replace the individual mail messages.
"BLD",6287,4,0)
^9.64PA^^
"BLD",6287,"INIT")
ST^PSAV3P53
"BLD",6287,"KRN",0)
^9.67PA^8989.52^19
"BLD",6287,"KRN",.4,0)
.4
"BLD",6287,"KRN",.401,0)
.401
"BLD",6287,"KRN",.402,0)
.402
"BLD",6287,"KRN",.403,0)
.403
"BLD",6287,"KRN",.5,0)
.5
"BLD",6287,"KRN",.84,0)
.84
"BLD",6287,"KRN",3.6,0)
3.6
"BLD",6287,"KRN",3.8,0)
3.8
"BLD",6287,"KRN",9.2,0)
9.2
"BLD",6287,"KRN",9.8,0)
9.8
"BLD",6287,"KRN",9.8,"NM",0)
^9.68A^4^3
"BLD",6287,"KRN",9.8,"NM",2,0)
PSAVERA^^0^B64109668
"BLD",6287,"KRN",9.8,"NM",3,0)
PSADAI^^0^B18812836
"BLD",6287,"KRN",9.8,"NM",4,0)
PSAVER6^^0^B55845889
"BLD",6287,"KRN",9.8,"NM","B","PSADAI",3)

"BLD",6287,"KRN",9.8,"NM","B","PSAVER6",4)

"BLD",6287,"KRN",9.8,"NM","B","PSAVERA",2)

"BLD",6287,"KRN",19,0)
19
"BLD",6287,"KRN",19.1,0)
19.1
"BLD",6287,"KRN",101,0)
101
"BLD",6287,"KRN",409.61,0)
409.61
"BLD",6287,"KRN",771,0)
771
"BLD",6287,"KRN",870,0)
870
"BLD",6287,"KRN",8989.51,0)
8989.51
"BLD",6287,"KRN",8989.52,0)
8989.52
"BLD",6287,"KRN",8994,0)
8994
"BLD",6287,"KRN","B",.4,.4)

"BLD",6287,"KRN","B",.401,.401)

"BLD",6287,"KRN","B",.402,.402)

"BLD",6287,"KRN","B",.403,.403)

"BLD",6287,"KRN","B",.5,.5)

"BLD",6287,"KRN","B",.84,.84)

"BLD",6287,"KRN","B",3.6,3.6)

"BLD",6287,"KRN","B",3.8,3.8)

"BLD",6287,"KRN","B",9.2,9.2)

"BLD",6287,"KRN","B",9.8,9.8)

"BLD",6287,"KRN","B",19,19)

"BLD",6287,"KRN","B",19.1,19.1)

"BLD",6287,"KRN","B",101,101)

"BLD",6287,"KRN","B",409.61,409.61)

"BLD",6287,"KRN","B",771,771)

"BLD",6287,"KRN","B",870,870)

"BLD",6287,"KRN","B",8989.51,8989.51)

"BLD",6287,"KRN","B",8989.52,8989.52)

"BLD",6287,"KRN","B",8994,8994)

"BLD",6287,"QUES",0)
^9.62^^
"BLD",6287,"REQB",0)
^9.611^3^3
"BLD",6287,"REQB",1,0)
PSA*3.0*15^1
"BLD",6287,"REQB",2,0)
PSA*3.0*40^1
"BLD",6287,"REQB",3,0)
PSA*3.0*42^1
"BLD",6287,"REQB","B","PSA*3.0*15",1)

"BLD",6287,"REQB","B","PSA*3.0*40",2)

"BLD",6287,"REQB","B","PSA*3.0*42",3)

"INIT")
ST^PSAV3P53
"MBREQ")
0
"PKG",487,-1)
1^1
"PKG",487,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",487,20,0)
^9.402P^^
"PKG",487,22,0)
^9.49I^1^1
"PKG",487,22,1,0)
3.0^2971024^2981028^66481
"PKG",487,22,1,"PAH",1,0)
53^3050909^123456966
"PKG",487,22,1,"PAH",1,1,0)
^^28^28^3050909
"PKG",487,22,1,"PAH",1,1,1,0)
This patch addresses the following problems:
"PKG",487,22,1,"PAH",1,1,2,0)
  
"PKG",487,22,1,"PAH",1,1,3,0)
1.      68490   Editing Verified Invoices [PSA EDIT VERIFIED INVOICE]
"PKG",487,22,1,"PAH",1,1,4,0)
Saying 'NO" to processing the edit changes made for DISPENSE UNITS field 
"PKG",487,22,1,"PAH",1,1,5,0)
(#14.5) and/or DISPENSE UNITS PER ORDER UNIT field (#15) of the Drug file 
"PKG",487,22,1,"PAH",1,1,6,0)
(#50), does not restore those fields to their previous values.
"PKG",487,22,1,"PAH",1,1,7,0)
 
"PKG",487,22,1,"PAH",1,1,8,0)
2.      68779   Editing Verified Invoices [PSA EDIT VERIFIED INVOICE]
"PKG",487,22,1,"PAH",1,1,9,0)
A drug that is newly picked and added newly to a pharmacy location in the 
"PKG",487,22,1,"PAH",1,1,10,0)
DRUG ACCOUNTABILITY STATS file (#58.8) has several of it's indexes 
"PKG",487,22,1,"PAH",1,1,11,0)
scrambled and the users are not able to select the drug within that 
"PKG",487,22,1,"PAH",1,1,12,0)
pharmacy location for any further processing purposes. A post init 
"PKG",487,22,1,"PAH",1,1,13,0)
routine will scan and clean up bad indexes it finds.
"PKG",487,22,1,"PAH",1,1,14,0)
 
"PKG",487,22,1,"PAH",1,1,15,0)
3.      100058 Drug Balances by Location [PSA DISPLAY LOCATION]
"PKG",487,22,1,"PAH",1,1,16,0)
The report menu "Drug Balances by Location" show entries for inactive 
"PKG",487,22,1,"PAH",1,1,17,0)
drugs that have a zero quantity. Those items are now not to be shown.
"PKG",487,22,1,"PAH",1,1,18,0)
 
"PKG",487,22,1,"PAH",1,1,19,0)
4.      108683 Verify Invoices [PSA VERIFY INVOICES]
"PKG",487,22,1,"PAH",1,1,20,0)
Drugs that are new to a pharmacy location in the DRUG ACCOUNTABILITY 
"PKG",487,22,1,"PAH",1,1,21,0)
STATS file (#58.8) are needing more data entered to complete their being 
"PKG",487,22,1,"PAH",1,1,22,0)
setup for processing. Such items as current balance, stock level, and 
"PKG",487,22,1,"PAH",1,1,23,0)
reorder levels are needed. A separate, individual mail message is 
"PKG",487,22,1,"PAH",1,1,24,0)
currently sent regarding each drug that is newly added. The volume of 
"PKG",487,22,1,"PAH",1,1,25,0)
messages is overwhelming.
"PKG",487,22,1,"PAH",1,1,26,0)
 
"PKG",487,22,1,"PAH",1,1,27,0)
A single consolidated mail message by invoice regarding drugs that are 
"PKG",487,22,1,"PAH",1,1,28,0)
newly added is needed to replace the individual mail messages.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSADAI")
0^3^B18812836
"RTN","PSADAI",1,0)
PSADAI ;BIR/LTL/,JMB/PDW-Drug Balances by Location ;7/23/97
"RTN","PSADAI",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15,53**; 10/24/97
"RTN","PSADAI",3,0)
 ;
"RTN","PSADAI",4,0)
 ;Reference to ^PS(59.4 are covered by IA #2505
"RTN","PSADAI",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSADAI",6,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSADAI",7,0)
 ;References to ^PS(59 are covered by IA #212
"RTN","PSADAI",8,0)
 ;
"RTN","PSADAI",9,0)
LOC S (PSACNT,PSAOUT)=0 D ^PSAUTL3 G:PSAOUT EXIT1
"RTN","PSADAI",10,0)
 S PSACNT=0,PSACHK=$O(PSALOC(""))
"RTN","PSADAI",11,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT1
"RTN","PSADAI",12,0)
 I PSACHK'="",$G(PSASEL)="",PSALOC W !!,PSALOCN
"RTN","PSADAI",13,0)
 ;
"RTN","PSADAI",14,0)
DEVICE W ! K IO("Q") S %ZIS="Q" D ^%ZIS I POP S DTOUT=1,Y=-1 W !,"No Device was selected or output printed." G EXIT1
"RTN","PSADAI",15,0)
 I $D(IO("Q")) S ZTRTN="START^PSADAI",ZTDESC="Drug Accountability - Drug Location Report",ZTSAVE("PSALOC(")="" D ^%ZTLOAD,HOME^%ZIS S Y=1 G EXIT1
"RTN","PSADAI",16,0)
START S PSAOUT=0,PSALOCN="",$P(PSASLN,"-",80)=""
"RTN","PSADAI",17,0)
 S PSARPDT=$E($$HTFM^XLFDT($H),1,12),PSADT=$P(PSARPDT,".")
"RTN","PSADAI",18,0)
 S PSARPDT=$E(PSADT,4,5)_"/"_$E(PSADT,6,7)_"/"_$E(PSADT,2,3)_"@"_$P(PSARPDT,".",2)
"RTN","PSADAI",19,0)
 F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""  D  Q:PSAOUT
"RTN","PSADAI",20,0)
 .S PSAIEN=0 F  S PSAIEN=+$O(PSALOC(PSALOCN,PSAIEN)) Q:'PSAIEN  D  Q:PSAOUT
"RTN","PSADAI",21,0)
 ..S PSAISIT=+$P(PSALOC(PSALOCN,PSAIEN),"^"),PSAOSIT=+$P(PSALOC(PSALOCN,PSAIEN),"^",2)
"RTN","PSADAI",22,0)
 ..S PSAISITN=$S($P($G(^PS(59.4,PSAISIT,0)),"^")'="":$P($G(^PS(59.4,PSAISIT,0)),"^"),1:"UNKNOWN")
"RTN","PSADAI",23,0)
 ..S PSAOSITN=$S($P($G(^PS(59,PSAOSIT,0)),"^")'="":$P($G(^PS(59,PSAOSIT,0)),"^"),1:"UNKNOWN")
"RTN","PSADAI",24,0)
 ..S PSASITES=$S(PSAISIT&(PSAOSIT):PSAISITN_" (IP)  "_PSAOSITN_" (OP)",PSAISIT:PSAISITN_" (IP)",1:PSAOSITN_" (OP)")
"RTN","PSADAI",25,0)
 ..D COMPILE D:'PSAOUT DONE
"RTN","PSADAI",26,0)
EXIT D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q") W:$E(IOST,1,2)="C-" @IOF
"RTN","PSADAI",27,0)
EXIT1 K ^TMP($J,"PSADRG"),%ZIS,DIR,DIRUT,DTOUT
"RTN","PSADAI",28,0)
 K PSACHK,PSACNT,PSADRG,PSADT,PSAIEN,PSAINV,PSAISIT,PSAISITN,PSALEN,PSALINK,PSALNK,PSALOC,PSALOCA,PSALOCN,PSAOSIT,PSAOSITN
"RTN","PSADAI",29,0)
 K PSAOUT,PSAPG,PSARPDT,PSAS,PSASEL,PSASITES,PSASLN,PSASS,PSATMP,X,Y,ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK
"RTN","PSADAI",30,0)
 Q
"RTN","PSADAI",31,0)
COMPILE ;Creates ^TMP(Drug Name)= current balance ^ dispense unit ^ total inventory (current balance in 50)
"RTN","PSADAI",32,0)
 K ^TMP($J,"PSADRG")
"RTN","PSADAI",33,0)
 S PSADRG=0 F  S PSADRG=+$O(^PSD(58.8,PSAIEN,1,PSADRG)) Q:'PSADRG  D
"RTN","PSADAI",34,0)
 .Q:'$D(^PSDRUG(PSADRG,0))
"RTN","PSADAI",35,0)
 .I $P($G(^PSD(58.8,PSAIEN,1,PSADRG,0)),"^",4)=0,$P($G(^PSD(58.8,PSAIEN,1,PSADRG,0)),"^",14)<DT Q  ;*53 0 QT & inactive
"RTN","PSADAI",36,0)
 .S ^TMP($J,"PSADRG",$P(^PSDRUG(PSADRG,0),"^"))=$P($G(^PSD(58.8,PSAIEN,1,PSADRG,0)),"^",4)_"^"_$P($G(^PSDRUG(PSADRG,660)),"^",8)_"^"_$P($G(^PSDRUG(PSADRG,660.1)),"^")
"RTN","PSADAI",37,0)
PRINT ;Prints body of report
"RTN","PSADAI",38,0)
 ;Finds longest length of inventory link(s).
"RTN","PSADAI",39,0)
 S (PSALNK,PSALEN)=0 F  S PSALNK=+$O(^PSD(58.8,PSAIEN,4,PSALNK)) Q:'PSALNK  D
"RTN","PSADAI",40,0)
 .S PSALINK(+$P($G(^PSD(58.8,PSAIEN,4,PSALNK,0)),"^"))=""
"RTN","PSADAI",41,0)
 .S PSAINV="INVENTORY LINK: "_$S($P($G(^PRCP(445,PSALNK,0)),"^")'="":$P($G(^PRCP(445,PSALNK,0)),"^"),1:"NONE")
"RTN","PSADAI",42,0)
 .S:PSALEN<$L(PSAINV) PSALEN=$L(PSAINV)
"RTN","PSADAI",43,0)
 S PSAPG=0,PSADRG="" D HDR
"RTN","PSADAI",44,0)
 ;If no data in ^TMP, prints message & exit routine.
"RTN","PSADAI",45,0)
 S PSATMP=$O(^TMP($J,"PSADRG","")) I PSATMP="" W !!,"<< NO DRUGS WERE FOUND. >>",! G DONE
"RTN","PSADAI",46,0)
 ;If data is found, prints drug name, current balance, & dispense unit
"RTN","PSADAI",47,0)
 F  S PSADRG=$O(^TMP($J,"PSADRG",PSADRG)) Q:PSADRG=""  D  I PSAOUT W:$E(IOST,1,2)="C-" @IOF Q
"RTN","PSADAI",48,0)
 .D:$Y+4>IOSL HDR Q:PSAOUT
"RTN","PSADAI",49,0)
 .W !,PSADRG
"RTN","PSADAI",50,0)
 .S PSALEN=$L($P($P(^TMP($J,"PSADRG",PSADRG),"^"),".",2))
"RTN","PSADAI",51,0)
 .W ?(44+PSALEN),$J($FN($P(^TMP($J,"PSADRG",PSADRG),"^"),",",PSALEN),(10+PSALEN))
"RTN","PSADAI",52,0)
 .W:$P(^TMP($J,"PSADRG",PSADRG),"^",2)'="" ?61,$P(^TMP($J,"PSADRG",PSADRG),"^",2)
"RTN","PSADAI",53,0)
 .W ?69,$J($FN($P(^TMP($J,"PSADRG",PSADRG),"^",3),",",0),9)
"RTN","PSADAI",54,0)
 Q
"RTN","PSADAI",55,0)
DONE ;Holds screen or ejects paper if sent to printer
"RTN","PSADAI",56,0)
 I $E(IOST,1,2)="C-" D
"RTN","PSADAI",57,0)
 .S PSAS=22-$Y F PSASS=1:1:PSAS W !
"RTN","PSADAI",58,0)
 .S DIR(0)="EA",DIR("A")="End of display! Enter RETURN to continue or '^' to exit:" D ^DIR K DIR S:'Y PSAOUT=1
"RTN","PSADAI",59,0)
 W:$E(IOST)'="C" @IOF
"RTN","PSADAI",60,0)
 Q
"RTN","PSADAI",61,0)
HDR ;Print header
"RTN","PSADAI",62,0)
 S PSAPG=PSAPG+1
"RTN","PSADAI",63,0)
 I PSAPG=1,$E(IOST,1,2)="C-" W @IOF
"RTN","PSADAI",64,0)
 I PSAPG>1,$E(IOST)'="C" W @IOF
"RTN","PSADAI",65,0)
 I $E(IOST,1,2)="C-",PSAPG>1 D  Q:PSAOUT
"RTN","PSADAI",66,0)
 .S PSAS=22-$Y F PSASS=1:1:PSAS W !
"RTN","PSADAI",67,0)
 .S DIR(0)="E" D ^DIR K DIR W:'$G(DIRUT) @IOF S:'Y PSAOUT=1
"RTN","PSADAI",68,0)
 W:$E(IOST)'="C" !!,PSARPDT W:$E(IOST,1,2)="C-" !
"RTN","PSADAI",69,0)
 W ?21,"D R U G   A C C O U N T A B I L I T Y",?71,"Page ",$J(PSAPG,2)
"RTN","PSADAI",70,0)
 W !?24,"DRUG BALANCES BY LOCATION REPORT"
"RTN","PSADAI",71,0)
 W !?((80-$L(PSALOCN))/2),PSALOCN
"RTN","PSADAI",72,0)
 S PSALNK=0 F  S PSALNK=$O(PSALINK(PSALNK)) Q:'PSALNK  D
"RTN","PSADAI",73,0)
 .S PSAINV="INVENTORY LINK: "_$S($P($G(^PRCP(445,PSALNK,0)),"^")'="":$P($G(^PRCP(445,PSALNK,0)),"^"),1:"NONE")
"RTN","PSADAI",74,0)
 .W !?((80-$L(PSAINV))/2),PSAINV
"RTN","PSADAI",75,0)
 W !!?47,"CURRENT",?58,"DISPENSE",?72,"TOTAL"
"RTN","PSADAI",76,0)
 W !,"DRUG NAME",?47,"BALANCE",?60,"UNIT",?70,"INVENTORY",!,PSASLN
"RTN","PSADAI",77,0)
 Q
"RTN","PSAV3P53")
0^^B5533759
"RTN","PSAV3P53",1,0)
PSAV3P53 ;VMP/PDW-POST INIT *53 FIND BAD 'C' INDEX, KILL OLD, SET PROPER  'C' & 'B' INDEXES; 8/20/05
"RTN","PSAV3P53",2,0)
 ;;3.0;DRUG ACCOUNTABILITY;**53**; 4/30/97
"RTN","PSAV3P53",3,0)
ST ;walk 'C' entries finding bad entries , pull values, kill old, set new indexes
"RTN","PSAV3P53",4,0)
 S PSASUB=3000101 ;1JAN2000
"RTN","PSAV3P53",5,0)
 ;
"RTN","PSAV3P53",6,0)
 W:$G(PSASHOW) !,"by DATES"
"RTN","PSAV3P53",7,0)
 F  S PSASUB=$O(^PSD(58.8,"C",PSASUB)) Q:PSASUB'>0  D
"RTN","PSAV3P53",8,0)
 . S PSALOC=$O(^PSD(58.8,"C",PSASUB,0))
"RTN","PSAV3P53",9,0)
 . S PSADRG=0 F  S PSADRG=$O(^PSD(58.8,"C",PSASUB,PSALOC,0)) Q:PSADRG'>0  D
"RTN","PSAV3P53",10,0)
 .. K ^PSD(58.8,"C",PSASUB,PSALOC,PSADRG) X "S X=$ZR" W:$G(PSASHOW) !,"K ",X
"RTN","PSAV3P53",11,0)
 .. K ^PSD(58.8,PSALOC,1,"B",PSASUB,PSADRG) X "S X=$ZR" W:$G(PSASHOW) !,"K ",X
"RTN","PSAV3P53",12,0)
 .. S ^PSD(58.8,"C",PSADRG,PSALOC,PSADRG)="" X "S X=$ZR" W:$G(PSASHOW) !,"S ",X
"RTN","PSAV3P53",13,0)
 .. S ^PSD(58.8,PSALOC,1,"B",PSADRG,PSADRG)="" X "S X=$ZR" W:$G(PSASHOW) !,"S ",X
"RTN","PSAV3P53",14,0)
 W:$G(PSASHOW) !,"by LOCATION"
"RTN","PSAV3P53",15,0)
 S PSALOC=0
"RTN","PSAV3P53",16,0)
 F  S PSALOC=$O(^PSD(58.8,PSALOC)) Q:PSALOC'>0  D
"RTN","PSAV3P53",17,0)
 . S PSADRG=0
"RTN","PSAV3P53",18,0)
 . F  S PSADRG=$O(^PSD(58.8,PSALOC,1,PSADRG)) Q:PSADRG'>0  D
"RTN","PSAV3P53",19,0)
 .. ;scrub B index
"RTN","PSAV3P53",20,0)
 .. S PSADRG2=0
"RTN","PSAV3P53",21,0)
 .. F  S PSADRG2=$O(^PSD(58.8,PSALOC,1,"B",PSADRG,PSADRG2)) Q:PSADRG2'>0  D
"RTN","PSAV3P53",22,0)
 ...I PSADRG2'=PSADRG K ^PSD(58.8,PSALOC,1,"B",PSADRG,PSADRG2) X "S X=$ZR" W:$G(PSASHOW) !,"K ",X
"RTN","PSAV3P53",23,0)
 .. ;check valid B index
"RTN","PSAV3P53",24,0)
 .. I '$D(^PSD(58.8,PSALOC,1,"B",PSADRG,PSADRG)) S ^PSD(58.8,PSALOC,1,"B",PSADRG,PSADRG)="" X "S X=$ZR" W:$G(PSASHOW) !,"S ",X
"RTN","PSAV3P53",25,0)
 .. ;check valid C index
"RTN","PSAV3P53",26,0)
 .. I '$D(^PSD(58.8,"C",PSADRG,PSALOC,PSADRG)) S ^PSD(58.8,"C",PSADRG,PSALOC,PSADRG)="" X "S X=$ZR" W:$G(PSASHOW) !,"S ",X
"RTN","PSAV3P53",27,0)
 W:$G(PSASHOW) !,"by C INDEX"
"RTN","PSAV3P53",28,0)
 S PSADRG=0 F  S PSADRG=$O(^PSD(58.8,"C",PSADRG)) Q:PSADRG'>0  D
"RTN","PSAV3P53",29,0)
 . S PSALOC=0 F  S PSALOC=$O(^PSD(58.8,"C",PSADRG,PSALOC)) Q:PSALOC'>0  D
"RTN","PSAV3P53",30,0)
 .. S PSADRG2=0 F  S PSADRG2=$O(^PSD(58.8,"C",PSADRG,PSALOC,PSADRG2)) Q:PSADRG2'>0  D
"RTN","PSAV3P53",31,0)
 ... I PSADRG2'=PSADRG K ^PSD(58.8,"C",PSADRG,PSALOC,PSADRG2) X "S X=$ZR" W:$G(PSASHOW) !,"K ",X
"RTN","PSAV3P53",32,0)
 K PSALOC,PSADRG,PSADRG2
"RTN","PSAV3P53",33,0)
 Q
"RTN","PSAVER6")
0^4^B55845889
"RTN","PSAVER6",1,0)
PSAVER6 ;BIR/JMB-Verify Invoices - CONT'D ;10/3/97
"RTN","PSAVER6",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**1,3,21,42,53**; 10/24/97
"RTN","PSAVER6",3,0)
 ;Background Job:
"RTN","PSAVER6",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER6",5,0)
 ;This routine increments pharmacy location and master vault balances
"RTN","PSAVER6",6,0)
 ;in 58.8 after invoices have been verified.
"RTN","PSAVER6",7,0)
 ;
"RTN","PSAVER6",8,0)
START ;|=> *42 add Post Verify variance report
"RTN","PSAVER6",9,0)
 K ^TMP($J,"PSADD")
"RTN","PSAVER6",10,0)
 K DIC,DA,DR,DIE
"RTN","PSAVER6",11,0)
 S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",12,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",13,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",14,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",15,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",16,0)
 ..S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER6",17,0)
 ..K DIC,DA,DR,DIE
"RTN","PSAVER6",18,0)
 ..I +$P(PSAIN,"^",13) K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR Q
"RTN","PSAVER6",19,0)
 ..S PSAINV=$P(PSAIN,"^"),PSAINVDT=$P(PSAIN,"^",2),PSALINE=0
"RTN","PSAVER6",20,0)
 ..F  S PSALINE=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:'PSALINE  D
"RTN","PSAVER6",21,0)
 ...Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVER6",22,0)
 ...S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0) D GETDATA I 'PSASUP,'$D(PSA0QTY) D FILE ;PSA*3*42
"RTN","PSAVER6",23,0)
 ..K DIC,DA,DR,DIE
"RTN","PSAVER6",24,0)
 ..K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR
"RTN","PSAVER6",25,0)
 S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",26,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",27,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",28,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",29,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",30,0)
 ..D SCANDIF
"RTN","PSAVER6",31,0)
 ; *42 <=|
"RTN","PSAVER6",32,0)
EXIT ;Kills variables
"RTN","PSAVER6",33,0)
 K %,DA,DD,DIC,DIE,DINUM,DLAYGO,DO,PSA,PSAA,PSABAL,PSACBAL,PSACNT,PSACNT,PSACOD,PSACOST,PSACS,PSADASH,PSADATA,PSADJ,PSADJD,PSADJO,PSADJP,PSADJQ
"RTN","PSAVER6",34,0)
 K PSADRG,PSADT,PSADUOU,PSADUQTY,PSADUREC,PSAIEN,PSAIEN1,PSAIN,PSAINV,PSAINVDT,PSALEN,PSALINE,PSALOC,PSAMSG,PSANDC,PSANODE,PSANPDU,PSANPOU
"RTN","PSAVER6",35,0)
 K PSAODASH,PSAONDC,PSAORD,PSAOU,PSAPDU,PSAPOU,PSAQTY,PSAREORD,PSASET,PSASTOCK,PSASUP,PSAT,PSATDRG,PSATEMP,PSAVBKG,PSAVDUZ,PSAVEND,PSAVSN,X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,Y
"RTN","PSAVER6",36,0)
 K PSA0QTY
"RTN","PSAVER6",37,0)
 Q
"RTN","PSAVER6",38,0)
 ;
"RTN","PSAVER6",39,0)
GETDATA ;Gets invoice data to help file the data
"RTN","PSAVER6",40,0)
 S PSAVDUZ=$P(PSADATA,"^",9),PSASUP=0
"RTN","PSAVER6",41,0)
 S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAVER6",42,0)
 I '$G(PSADJ) S PSADRG=$S(+$P(PSADATA,"^",2):+$P(PSADATA,"^",2),1:0) G CS
"RTN","PSAVER6",43,0)
 I $G(PSADJ) D
"RTN","PSAVER6",44,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVER6",45,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",46,0)
 .I PSADJD'?1.N S PSASUP=1
"RTN","PSAVER6",47,0)
 .S PSADRG=$S(PSADJ&('PSASUP):+PSADJD,PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAVER6",48,0)
 .I +PSADJD,$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" S PSADRG=+PSADJD Q
"RTN","PSAVER6",49,0)
 .I +PSADJD,$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAVER6",50,0)
CS Q:PSASUP!('PSADRG)
"RTN","PSAVER6",51,0)
 S PSACS=$S(+$P(PSADATA,"^",10):1,1:0)
"RTN","PSAVER6",52,0)
 S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAVER6",53,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",54,0)
 ;
"RTN","PSAVER6",55,0)
 ;PSA*3*1  (DAVE B)
"RTN","PSAVER6",56,0)
 S PSAQTY=$S(($G(PSADJQ)'=""&(+PSADJ)):PSADJQ,1:+$P(PSADATA,"^",3))
"RTN","PSAVER6",57,0)
 S PSAOU=$S(+$P(PSADATA,"^",4):+$P(PSADATA,"^",4),1:"")
"RTN","PSAVER6",58,0)
 ;
"RTN","PSAVER6",59,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",60,0)
 ;I +$P($P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^",5),"~",2) S PSAOU=$P($P($G(^(2)),"^",5),"~",2)
"RTN","PSAVER6",61,0)
 ;
"RTN","PSAVER6",62,0)
 S PSADJO=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAVER6",63,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",64,0)
 S:$G(PSADJO) PSAOU=$G(PSADJO)
"RTN","PSAVER6",65,0)
 S PSANDC=$P(PSADATA,"^",11) D PSANDC1^PSAHELP S PSADASH=PSANDCX K PSANDCX
"RTN","PSAVER6",66,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAVER6",67,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAVER6",68,0)
 S (PSAPOU,PSANPOU)=$S($G(PSADJP):PSADJP,1:+$P(PSADATA,"^",5)),PSALEN=$L($P(PSANPOU,".")),(PSAPOU,PSANPOU)=$J(PSANPOU,PSALEN,2)
"RTN","PSAVER6",69,0)
 S PSAVSN=$P(PSADATA,"^",12)
"RTN","PSAVER6",70,0)
 S PSALOC=$S(+PSACS:+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",5))
"RTN","PSAVER6",71,0)
TEMP S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAVER6",72,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVER6",73,0)
 S PSADUOU=$S(+PSADUOU:+PSADUOU,+PSASUB&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:1)
"RTN","PSAVER6",74,0)
 S PSADUREC=$S(PSADUOU:PSAQTY*PSADUOU,1:0)
"RTN","PSAVER6",75,0)
 ;
"RTN","PSAVER6",76,0)
 ;DAVE B (18NOV98)
"RTN","PSAVER6",77,0)
 I PSADUREC=0,$D(PSAQTY),$P($G(^PSDRUG(PSADRG,660)),"^",5)'="" S PSADUREC=(PSAQTY*($P(^PSDRUG(PSADRG,660),"^",5)))
"RTN","PSAVER6",78,0)
 Q:'+$P($G(^PSD(58.8,PSALOC,0)),"^",14)
"RTN","PSAVER6",79,0)
 S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAVER6",80,0)
 S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAVER6",81,0)
 K PSA0QTY I '$G(PSAQTY),'$G(PSADJQ) S PSA0QTY=1 Q  ;PSA*3*42 (0 QTY)
"RTN","PSAVER6",82,0)
 Q
"RTN","PSAVER6",83,0)
 ;
"RTN","PSAVER6",84,0)
FILE ;File data in 58.8
"RTN","PSAVER6",85,0)
 I $D(PSADUREC),PSADUREC'>0 S PSADUREC=$S($D(PSADJQ):PSADJQ,$D(PSAQTY):PSAQTY,1:0)
"RTN","PSAVER6",86,0)
 D NOW^%DTC S PSADT=+$E(%,1,14)
"RTN","PSAVER6",87,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSAVER6",88,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",89,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) DIC("P")=$P(^DD(58.8,10,0),"^",2)
"RTN","PSAVER6",90,0)
 .S DA(1)=PSALOC,DIC="^PSD(58.8,"_DA(1)_",1,",(DA,DINUM,X)=PSADRG,DIC(0)="L",DLAYGO=58.8
"RTN","PSAVER6",91,0)
 .F  L +^PSD(58.8,PSALOC,0):0 I  Q
"RTN","PSAVER6",92,0)
 .D FILE^DICN L -^PSD(58.8,PSALOC,0) K DIC,DA,DLAYGO
"RTN","PSAVER6",93,0)
 .D MM ;*42 send mailmessage
"RTN","PSAVER6",94,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):0 I  Q
"RTN","PSAVER6",95,0)
 S PSABAL=+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)
"RTN","PSAVER6",96,0)
 ;
"RTN","PSAVER6",97,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",98,0)
 I $P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",1)'=PSADRG S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",1)=PSADRG
"RTN","PSAVER6",99,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSADUREC+PSABAL
"RTN","PSAVER6",100,0)
 I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D
"RTN","PSAVER6",101,0)
 .I PSASTOCK'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3)=PSASTOCK
"RTN","PSAVER6",102,0)
 .I PSAREORD'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5)=PSAREORD
"RTN","PSAVER6",103,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) DIC("P")=$P(^DD(58.8001,20,0),"^",2)
"RTN","PSAVER6",104,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,$E(DT,1,5)*100,0)) D
"RTN","PSAVER6",105,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",106,0)
 .S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSABAL)"
"RTN","PSAVER6",107,0)
 .S (X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DIC("DR")
"RTN","PSAVER6",108,0)
 .S X="T-1M" D ^%DT S (X,DINUM)=$E(Y,1,5)*100,DA=PSADRG D ^DIC K DIC,DLAYGO
"RTN","PSAVER6",109,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",110,0)
 .S DA=+Y,DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAVER6",111,0)
 K DIC,DA,DR,DIE
"RTN","PSAVER6",112,0)
 S DA=$E(DT,1,5)*100
"RTN","PSAVER6",113,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DA=$E(DT,1,5)*100,DR="3////^S X=($G(PSABAL)+$G(PSADUREC));5////^S X="_($P($G(^(0)),"^",3)+PSADUREC) D ^DIE K DIE
"RTN","PSAVER6",114,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAVER6",115,0)
 G TR^PSAVER7
"RTN","PSAVER6",116,0)
MM ;
"RTN","PSAVER6",117,0)
 ;*42 Mail Message to holders of PSDMGR, PSAMGR key
"RTN","PSAVER6",118,0)
 ;*53 Consolidate messages
"RTN","PSAVER6",119,0)
 N PSACS S PSACS=$S($$GET1^DIQ(50,PSADRG,63)["N":" Controlled Substance ",1:"")
"RTN","PSAVER6",120,0)
 S ^TMP($J,"PSADD",$$GET1^DIQ(58.8,PSALOC,.01),$$GET1^DIQ(50,PSADRG,.01))=""
"RTN","PSAVER6",121,0)
 Q
"RTN","PSAVER6",122,0)
SCANDIF ;*42 inspect invoice for noted differences in OU,DUOU,PPDU,NDC
"RTN","PSAVER6",123,0)
 ;NEEDS PSAIEN, PSAIEN1
"RTN","PSAVER6",124,0)
 K ^TMP($J,"PSADIF"),PSADIFLC
"RTN","PSAVER6",125,0)
 S PSALINE=0 F  S PSALINE=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:PSALINE'>0  D CHECK^PSAPROC7 ;checks and stores differences in ^TMP($J,
"RTN","PSAVER6",126,0)
 I $D(^TMP($J,"PSADD")) D ADDMM
"RTN","PSAVER6",127,0)
 I $D(^TMP($J,"PSADIF")) D MESSAGE
"RTN","PSAVER6",128,0)
 Q
"RTN","PSAVER6",129,0)
MESSAGE ;differences found, notify user and send message to g.PSA NDC UPDATES.
"RTN","PSAVER6",130,0)
 K DIR N IENS
"RTN","PSAVER6",131,0)
 S PSAORD=$$GET1^DIQ(58.811,PSAIEN,.01),IENS=PSAIEN1_","_PSAIEN
"RTN","PSAVER6",132,0)
 S PSAINV=$$GET1^DIQ(58.8112,IENS,.01)
"RTN","PSAVER6",133,0)
 S XMSUB="POST Verify  Variance Report Ord: "_PSAORD_" Inv: "_PSAINV ;*52
"RTN","PSAVER6",134,0)
 S ^TMP($J,"PSADIF",1,0)=XMSUB,^TMP($J,"PSADIF",2,0)=" "
"RTN","PSAVER6",135,0)
 S XMTEXT="^TMP($J,""PSADIF"",",XMY("G.PSA NDC UPDATES")=""
"RTN","PSAVER6",136,0)
 S XMDUZ="Price & NDC Updater"
"RTN","PSAVER6",137,0)
 D ^XMD
"RTN","PSAVER6",138,0)
 K PSADIFLC,^TMP($J,"PSADIF")
"RTN","PSAVER6",139,0)
 Q
"RTN","PSAVER6",140,0)
ADDMM ; SEND MESSAGE REGARDING DRUGS ADDED TO PHARMACY LOCATIONS
"RTN","PSAVER6",141,0)
 K ^TMP($J,"PSADDMM")
"RTN","PSAVER6",142,0)
 S XMSUB="New Drugs Added by Order: "_$G(PSAORD)_" Invoice: "_$G(PSAINV)
"RTN","PSAVER6",143,0)
 S XMDUZ="Verified by: "_$$GET1^DIQ(200,DUZ,.01)
"RTN","PSAVER6",144,0)
 S LC=0,X=XMSUB D MMLINE S X=XMDUZ D MMLINE
"RTN","PSAVER6",145,0)
 S X="Please use DA and CS menus to populate the balances, stock and re-order levels." D MMLINE
"RTN","PSAVER6",146,0)
 S PSALOC="" F  S PSALOC=$O(^TMP($J,"PSADD",PSALOC)) Q:PSALOC=""  D
"RTN","PSAVER6",147,0)
 . S X=PSALOC D MMLINE
"RTN","PSAVER6",148,0)
 . S PSADRG="" F  S PSADRG=$O(^TMP($J,"PSADD",PSALOC,PSADRG)) Q:PSADRG=""  S X="     "_PSADRG D MMLINE
"RTN","PSAVER6",149,0)
 S XMTEXT="^TMP($J,""PSADDMM"","
"RTN","PSAVER6",150,0)
 S XMY("G.PSA NDC UPDATES")=""
"RTN","PSAVER6",151,0)
 D ^XMD
"RTN","PSAVER6",152,0)
 K ^TMP($J,"PSADD"),^TMP($J,"PSADDMM"),LC
"RTN","PSAVER6",153,0)
 Q
"RTN","PSAVER6",154,0)
MMLINE S LC=LC+1,^TMP($J,"PSADDMM",LC,0)=X W !,X Q
"RTN","PSAVERA")
0^2^B64109668
"RTN","PSAVERA",1,0)
PSAVERA ;BHM/DBM - Change verified invoice data;16AUG05
"RTN","PSAVERA",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**21,36,40,53**; 10/24/97
"RTN","PSAVERA",3,0)
 ;
"RTN","PSAVERA",4,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAVERA",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVERA",6,0)
 D Q
"RTN","PSAVERA",7,0)
 D HOME^%ZIS S XX="VERIFIED INVOICE ALTERATION SCREEN" W @IOF,!!,?((IOM/2)-($L(XX)/2)),XX,!!
"RTN","PSAVERA",8,0)
ORDR ;Get Order Number
"RTN","PSAVERA",9,0)
 S DIC(0)="AEQMZ",DIC("A")="Select Order Number: ",DIC="^PSD(58.811," D ^DIC K DIC G Q:+Y'>0 S PSAIEN=+Y,PSAORD=$P(Y,U,2)
"RTN","PSAVERA",10,0)
 ;
"RTN","PSAVERA",11,0)
INV ;Get Invoice Number
"RTN","PSAVERA",12,0)
 S DIC(0)="AEQMZ",DIC("A")="Select Invoice Number: ",DIC="^PSD(58.811,"_PSAIEN_",1,",D="ASTAT" D ^DIC K DIC G Q:+Y'>0 S PSAIEN1=+Y,PSAINV=$P(Y,U,2)
"RTN","PSAVERA",13,0)
 ;
"RTN","PSAVERA",14,0)
 S DATA=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVERA",15,0)
 S PSALOC=$S($P(DATA,"^",12)'="":$P(DATA,"^",12),1:$P(DATA,"^",5)) I $G(PSALOC)="" S PSALOC="No Location identified"
"RTN","PSAVERA",16,0)
 D ^PSAVERA1
"RTN","PSAVERA",17,0)
 ;
"RTN","PSAVERA",18,0)
 K DATA,PSAITM,LINENUM,X,X1,X2,X3,DIC,DA,DR D HDR
"RTN","PSAVERA",19,0)
DISP S PSAITM=$S('$D(PSAITM):$O(INVARRAY(PSAORD,PSAINV,0)),1:$O(INVARRAY(PSAORD,PSAINV,PSAITM))) G LINEASK:PSAITM'>0 S LINENUM=$G(LINENUM)+1
"RTN","PSAVERA",20,0)
 S DATA=$G(INVARRAY(PSAORD,PSAINV,PSAITM))
"RTN","PSAVERA",21,0)
 S PSAOU=$P(DATA,"^",4) I $G(PSAOU) S PSAOU(1)=$P($G(^DIC(51.5,$P(DATA,"^",4),0)),"^") ;Current Order Unit
"RTN","PSAVERA",22,0)
 W !,PSAITM,?10,$S($P($P(DATA,"^",1),"~",1)'>0:$P($P(DATA,"^",1),"~",1),1:$P($P(DATA,"^",1),"~",2)),?45,$S($G(PSAOU)="":"none",$G(PSAOU(1))'="":$G(PSAOU(1)),1:$G(PSAAOU)),?55,$J($P($G(DATA),"^",2),4),?61,$P(DATA,"^",5)
"RTN","PSAVERA",23,0)
 I IOST["C-",$Y>(IOSL-5) S DIR(0)="E" D ^DIR G Q:$G(DUOUT)=1 D HDR
"RTN","PSAVERA",24,0)
 G DISP
"RTN","PSAVERA",25,0)
LINEASK ;ask for line number
"RTN","PSAVERA",26,0)
 W !,"Enter the corresponding item number to edit: " R AN:DTIME I AN["^"!(AN="") G Q
"RTN","PSAVERA",27,0)
 I AN<1!(AN>LINENUM) W !,"Enter a number between 1 & ",LINENUM,! G LINEASK
"RTN","PSAVERA",28,0)
 I "?"[AN W !,"Select the number that corresponds to the line item that needs editing",! K AN G LINEASK
"RTN","PSAVERA",29,0)
 S DATA=$G(INVARRAY(PSAORD,PSAINV,AN))
"RTN","PSAVERA",30,0)
 S PSALINE=AN,PSAIN="NADA" I '$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0)) W !,"Invalid line selection." G LINEASK
"RTN","PSAVERA",31,0)
 S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),PSASUP=0
"RTN","PSAVERA",32,0)
 S PSACS=0 S:+$P(PSADATA,"^",10) PSACS=$G(PSACS)+1
"RTN","PSAVERA",33,0)
 S PSANDC=$P(PSADATA,"^",11)
"RTN","PSAVERA",34,0)
 S PSALINEN="" D VERDISP^PSAUTL4 W !,PSASLN,!
"RTN","PSAVERA",35,0)
 S PSAVEND=$P(^PSD(58.811,PSAIEN,0),"^",2)
"RTN","PSAVERA",36,0)
 ;VMP OIFO BAY PINES;VGF;PSA*3.0*40;GET ORIGINAL DISPENSE UNITS PER ORDER UNIT FOR SUBTRACTION
"RTN","PSAVERA",37,0)
 S PSAODUOU=PSADUOU
"RTN","PSAVERA",38,0)
 ;
"RTN","PSAVERA",39,0)
DRG W !,"Select (D)rug or (O)rder Unit " R AN:DTIME G Q:AN["^"!(AN="") W $S("Dd"[AN:"rug","oO"[AN:"rder Unit",1:"??") I "DdOo"'[AN W !,"Enter a 'D' to edit the Drug, or 'O' to edit the order unit",! K AN G DRG
"RTN","PSAVERA",40,0)
 I "Dd"'[AN G ^PSAVERA3
"RTN","PSAVERA",41,0)
 ;Get either new name of drug or supply item description
"RTN","PSAVERA",42,0)
 S PSABEFOR=$P(DATA,"~",1),PSABEFOR(1)=$S(PSABEFOR'?.N:PSABEFOR,1:$P($P(DATA,"^"),"~",2))
"RTN","PSAVERA",43,0)
 S PSABEFOR("NDC")=$P(PSADATA,"^",11)
"RTN","PSAVERA",44,0)
DRGAGN D
"RTN","PSAVERA",45,0)
 .S X1=0 F  S X1=$O(^PSDRUG(PSABEFOR,1,X1)) Q:X1'>0  S DATA=$G(^PSDRUG(PSABEFOR,1,X1,0)) I $P(DATA,"^",2)=PSABEFOR("NDC") S PSABEFOR("SYNNODE")=X1
"RTN","PSAVERA",46,0)
 D PSANDC1^PSAHELP S PSADASH=PSANDCX K PSANDCX
"RTN","PSAVERA",47,0)
 I $G(PSABEFOR("SYNNODE"))="",$E(PSABEFOR("NDC"))'="S" S PSABEFOR("NDC")="S"_PSABEFOR("NDC") G DRGAGN ;may be supply, try again
"RTN","PSAVERA",48,0)
 I $G(PSABEFOR("SYNNODE"))'="" S PSASUB=PSABEFOR("SYNNODE") D
"RTN","PSAVERA",49,0)
 .S DATA=$G(^PSDRUG(PSABEFOR,1,PSASUB,0)),PSAOU=$P(DATA,"^",5),PSAPOU=$P(DATA,"^",6),PSADUOU=$P(DATA,"^",7),PSAPDUOU=$P(DATA,"^",8)
"RTN","PSAVERA",50,0)
 .S PSADU=$P($G(^PSDRUG(PSABEFOR,660)),"^",8)
"RTN","PSAVERA",51,0)
 I ($G(PSAOU)=""!$G(PSAPOU)=""!$G(PSADUOU)=""!$G(PSAPDUOU)="") W !!,"Sorry, I could not find the necessary information to change the drug selection.",! G Q
"RTN","PSAVERA",52,0)
 W !,"Current Drug : ",PSABEFOR(1)
"RTN","PSAVERA",53,0)
DRG1 S PSAGAIN=0,DIC("A")="Select name of Correct Drug: ",PSABEFOR=PSADRG,DIC(0)="AEQMZ",DIC="^PSDRUG(" D ^DIC K DIC G Q:PSAOUT
"RTN","PSAVERA",54,0)
 I $G(DTOUT)!($G(DUOT)) S PSAOUT=1 Q
"RTN","PSAVERA",55,0)
 S (PSADJ,PSADRG)=+Y
"RTN","PSAVERA",56,0)
 W !!,"Comparing drug file data..."
"RTN","PSAVERA",57,0)
 S PSAODU=$P($G(^PSDRUG(PSADRG,660)),"^",8),PSAXDUOU=$P($G(^PSDRUG(PSADRG,660)),"^",5)
"RTN","PSAVERA",58,0)
 I $P($G(^PSDRUG(PSADRG,660)),"^",2)'=$G(PSAOU) W !,"The Order Units are different between these two drugs."
"RTN","PSAVERA",59,0)
 I $P($G(^PSDRUG(PSADRG,660)),"^",8)'=$G(PSADU) W !,"Please Enter an appropriate Dispense Unit" S DIE="^PSDRUG(",DA=PSADRG,DR="14.5" D ^DIE S PSADU=$P(^PSDRUG(PSADRG,660),"^",8)
"RTN","PSAVERA",60,0)
 ;VMP OIFO BAY PINES;VGF;PSA*3.0*36
"RTN","PSAVERA",61,0)
 I $P($G(^PSDRUG(PSADRG,660)),"^",5)'=$G(PSADUOU) W !,"Please enter the appropriate Dispense Units per order unit" S DIE="^PSDRUG(",DA=PSADRG,DR="15" D ^DIE S PSADUOU=$P(^PSDRUG(PSADRG,660),"^",5)
"RTN","PSAVERA",62,0)
 K DIE,DA,DR
"RTN","PSAVERA",63,0)
ASK R !!,"Are you sure about this ?  NO// ",AN:DTIME G NOCHNG:AN["^"!(AN="")
"RTN","PSAVERA",64,0)
 S AN=$E(AN) I "yYnN"'[AN W !,"Answer yes, and the data on file for the current drug will be transferred",!,"to the new drug selection.",!,"That includes Order Unit, Dispense Unit, Dispense Units per Order Unit, etc.",!! G ASK
"RTN","PSAVERA",65,0)
 I "Nn"[AN G NOCHNG ;*53
"RTN","PSAVERA",66,0)
 ;VMP OIFO BAY PINES;VGF;PSA*3.0*36
"RTN","PSAVERA",67,0)
 S PSAAFTER=PSADRG,PSADRG=PSABEFOR
"RTN","PSAVERA",68,0)
 I $D(^PSDRUG(PSADRG)) D
"RTN","PSAVERA",69,0)
 .;VMP OIFO BAY PINES;VGF;PSA*3.0*40
"RTN","PSAVERA",70,0)
 .W !,"Removing "_($G(PSAQTY)*$G(PSAODUOU))_" from "_PSABEFOR(1)
"RTN","PSAVERA",71,0)
 .S FMDATA=$P($G(^PSDRUG(PSADRG,660.1)),"^")-(PSAODUOU*PSAQTY)
"RTN","PSAVERA",72,0)
 .S DIE="^PSDRUG(",DA=PSADRG,DR="50////^S X="_FMDATA
"RTN","PSAVERA",73,0)
 .F  L +^PSDRUG(DA,0):0 I  Q
"RTN","PSAVERA",74,0)
 .D ^DIE
"RTN","PSAVERA",75,0)
 .L -^PSDRUG(DA,0)
"RTN","PSAVERA",76,0)
 .K FMDATA
"RTN","PSAVERA",77,0)
 S PSADRG=PSAAFTER
"RTN","PSAVERA",78,0)
 I $G(PSAPOU)="",$G(PSAPRICE)'="" S PSAPOU=PSAPRICE
"RTN","PSAVERA",79,0)
 W !,"Adding "_($G(PSAQTY)*$G(PSADUOU))_" to "_$P($G(^PSDRUG(PSADRG,0)),"^")
"RTN","PSAVERA",80,0)
 W !,"Entering new drug selection as an adjustment."
"RTN","PSAVERA",81,0)
 S PSAREA="",PSADJFLD="D",PSADJ=PSADRG D RECORD^PSAVER2
"RTN","PSAVERA",82,0)
 D 50^PSAVER7
"RTN","PSAVERA",83,0)
FILE ;File dispense units per order units into 58.811
"RTN","PSAVERA",84,0)
 S DIE="^PSD(58.811,"_PSAIEN_",1,"_PSAIEN1_",1,"
"RTN","PSAVERA",85,0)
 S DA=PSALINE,DA(1)=PSAIEN1,DA(2)=PSAIEN
"RTN","PSAVERA",86,0)
 S DR="10///"_PSADUOU
"RTN","PSAVERA",87,0)
 D ^DIE
"RTN","PSAVERA",88,0)
 ;File data in 58.8
"RTN","PSAVERA",89,0)
 ;PSALOC= Either PSALOC or PSALOCB
"RTN","PSAVERA",90,0)
 ;VMP OIFO BAY PINES;VGF;PSA*3.0*40;UPDATE 
"RTN","PSAVERA",91,0)
 S PSADRG=PSABEFOR
"RTN","PSAVERA",92,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):0 I  Q
"RTN","PSAVERA",93,0)
 S PSADUREC=PSAQTY*$G(PSAODUOU)
"RTN","PSAVERA",94,0)
 S PSABAL=$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)
"RTN","PSAVERA",95,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSABAL-PSADUREC
"RTN","PSAVERA",96,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAVERA",97,0)
 ;VMP OIFO BAY PINES;VGF;PSA*3.0*40;ADDED *$G(PSADUOU)
"RTN","PSAVERA",98,0)
 S PSADRG=PSAAFTER
"RTN","PSAVERA",99,0)
 S PSADUREC=PSAQTY*$G(PSADUOU)
"RTN","PSAVERA",100,0)
 D NOW^%DTC S PSADT=+$E(%,1,14)
"RTN","PSAVERA",101,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSAVERA",102,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) DIC("P")=$P(^DD(58.8,10,0),"^",2)
"RTN","PSAVERA",103,0)
 .S DA(1)=PSALOC,DIC="^PSD(58.8,"_DA(1)_",1,",(DA,DINUM,X)=PSADRG,DIC(0)="L",DLAYGO=58.8 ;*53
"RTN","PSAVERA",104,0)
 .F  L +^PSD(58.8,PSALOC,0):0 I  Q
"RTN","PSAVERA",105,0)
 .D FILE^DICN L -^PSD(58.8,PSALOC,0) K DIC,DA,DLAYGO
"RTN","PSAVERA",106,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):0 I  Q
"RTN","PSAVERA",107,0)
 S PSABAL=$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)
"RTN","PSAVERA",108,0)
 I $P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",1)'=PSADRG S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",1)=PSADRG
"RTN","PSAVERA",109,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSADUREC+PSABAL
"RTN","PSAVERA",110,0)
 I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D
"RTN","PSAVERA",111,0)
 .I PSASTOCK'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3)=PSASTOCK
"RTN","PSAVERA",112,0)
 .I PSAREORD'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5)=PSAREORD
"RTN","PSAVERA",113,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) DIC("P")=$P(^DD(58.8001,20,0),"^",2)
"RTN","PSAVERA",114,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,$E(DT,1,5)*100,0)) D
"RTN","PSAVERA",115,0)
 .S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSABAL)",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DIC
"RTN","PSAVERA",116,0)
 .S X="T-1M" D ^%DT S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100 D ^DIC K DIC,DLAYGO S DA=+Y
"RTN","PSAVERA",117,0)
 .S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAVERA",118,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DA=$E(DT,1,5)*100,DR="5////^S X="_($P($G(^(0)),"^",3)+PSADUREC) D ^DIE K DIE
"RTN","PSAVERA",119,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAVERA",120,0)
 W !,"updating pharmacy location file."
"RTN","PSAVERA",121,0)
FILE581 ;Update transaction file
"RTN","PSAVERA",122,0)
 S PSAVDUZ=DUZ
"RTN","PSAVERA",123,0)
FIND S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSAVERA",124,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO L -^PSD(58.81,0)
"RTN","PSAVERA",125,0)
 S DIE="^PSD(58.81,",DA=PSAT,DR="1////1;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRG;5////^S X=PSADUREC;6////^S X=PSAVDUZ;9////^S X=PSABAL;71////^S X=PSAINV;106////^S X=PSAORD"
"RTN","PSAVERA",126,0)
 I $G(PSACS)>0 S DR=DR_";100////^S X=PSACS"
"RTN","PSAVERA",127,0)
 F  L +^PSD(58.81,DA,0):0 I  Q
"RTN","PSAVERA",128,0)
 D ^DIE L -^PSD(58.81,DA,0) K DIE W !,"updating transaction file." Q
"RTN","PSAVERA",129,0)
 ;
"RTN","PSAVERA",130,0)
HDR W @IOF,!?25,"EDIT VERIFIED INVOICED ITEM SCREEN",!,PSASLN,!
"RTN","PSAVERA",131,0)
 W !,?44,"Order",!,"#",?10,"Drug/Item Name",?45,"Unit",?56,"Qnty.",?67,"NDC",!,PSASLN,! Q
"RTN","PSAVERA",132,0)
Q K AN,D,DA,DATA,DIC,DIR,INVARRAY,LINENUM,PSA50IEN,PSABAL,PSABEFOR,PSACS,PSADATA,PSADJ,PSADJFLD,PSADRG,PSADT,PSADUREC,PSAGAIN,PSAIEN,PSAIEN1,PSAIN,PSAINV,PSALINE,PSALINEN
"RTN","PSAVERA",133,0)
 K PSALOC,PSANDC,PSAORD,PSAOUT,PSAQTY,PSAREA,PSAREORD,PSASLN,PSASTOCK,PSASUB,PSASUP,PSASUPP,PSAT,PSAVER,X,X1,X2,X3,XX,XXX,Y,PSAODUOU
"RTN","PSAVERA",134,0)
 K PSAODU,PSAODUOU,PSAXDUOU
"RTN","PSAVERA",135,0)
 Q
"RTN","PSAVERA",136,0)
NOCHNG ;*53 said no to changes, backout the edits on the new drug choice.
"RTN","PSAVERA",137,0)
 K DIE,DR,DA
"RTN","PSAVERA",138,0)
 S DIE="^PSDRUG(",DA=PSADRG,DR="14.5////^S X=PSAODU;15////^S X=PSAXDUOU" D ^DIE
"RTN","PSAVERA",139,0)
 W !,"NO CHANGE",! G Q
"VER")
8.0^22.0
"BLD",6287,6)
^SEQ #38
**END**
**END**
