Released XU*8*434 SEQ #384
Extracted from mail message
**KIDS**:XU*8.0*434^

**INSTALL NAME**
XU*8.0*434
"BLD",972,0)
XU*8.0*434^KERNEL^0^3070322^y
"BLD",972,1,0)
^^2^2^3061012^^^
"BLD",972,1,1,0)
Please refer to the Description in the FORUM Patch Module for details.
"BLD",972,1,2,0)
XU*8*434 Set DILOCKTM in Kernel.
"BLD",972,4,0)
^9.64PA^^
"BLD",972,6.3)
6
"BLD",972,"KRN",0)
^9.67PA^8989.52^19
"BLD",972,"KRN",.4,0)
.4
"BLD",972,"KRN",.401,0)
.401
"BLD",972,"KRN",.402,0)
.402
"BLD",972,"KRN",.403,0)
.403
"BLD",972,"KRN",.5,0)
.5
"BLD",972,"KRN",.84,0)
.84
"BLD",972,"KRN",3.6,0)
3.6
"BLD",972,"KRN",3.8,0)
3.8
"BLD",972,"KRN",9.2,0)
9.2
"BLD",972,"KRN",9.8,0)
9.8
"BLD",972,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",972,"KRN",9.8,"NM",1,0)
XUS^^0^B30954416
"BLD",972,"KRN",9.8,"NM",2,0)
XUSCLEAN^^0^B13027306
"BLD",972,"KRN",9.8,"NM","B","XUS",1)

"BLD",972,"KRN",9.8,"NM","B","XUSCLEAN",2)

"BLD",972,"KRN",19,0)
19
"BLD",972,"KRN",19.1,0)
19.1
"BLD",972,"KRN",101,0)
101
"BLD",972,"KRN",409.61,0)
409.61
"BLD",972,"KRN",771,0)
771
"BLD",972,"KRN",870,0)
870
"BLD",972,"KRN",8989.51,0)
8989.51
"BLD",972,"KRN",8989.52,0)
8989.52
"BLD",972,"KRN",8994,0)
8994
"BLD",972,"KRN","B",.4,.4)

"BLD",972,"KRN","B",.401,.401)

"BLD",972,"KRN","B",.402,.402)

"BLD",972,"KRN","B",.403,.403)

"BLD",972,"KRN","B",.5,.5)

"BLD",972,"KRN","B",.84,.84)

"BLD",972,"KRN","B",3.6,3.6)

"BLD",972,"KRN","B",3.8,3.8)

"BLD",972,"KRN","B",9.2,9.2)

"BLD",972,"KRN","B",9.8,9.8)

"BLD",972,"KRN","B",19,19)

"BLD",972,"KRN","B",19.1,19.1)

"BLD",972,"KRN","B",101,101)

"BLD",972,"KRN","B",409.61,409.61)

"BLD",972,"KRN","B",771,771)

"BLD",972,"KRN","B",870,870)

"BLD",972,"KRN","B",8989.51,8989.51)

"BLD",972,"KRN","B",8989.52,8989.52)

"BLD",972,"KRN","B",8994,8994)

"BLD",972,"QUES",0)
^9.62^^
"BLD",972,"REQB",0)
^9.611^3^2
"BLD",972,"REQB",1,0)
XU*8.0*353^2
"BLD",972,"REQB",3,0)
XU*8.0*419^2
"BLD",972,"REQB","B","XU*8.0*353",1)

"BLD",972,"REQB","B","XU*8.0*419",3)

"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^3051215^2970507^.5
"PKG",3,22,1,"PAH",1,0)
434^3070322
"PKG",3,22,1,"PAH",1,1,0)
^^2^2^3070322
"PKG",3,22,1,"PAH",1,1,1,0)
Please refer to the Description in the FORUM Patch Module for details.
"PKG",3,22,1,"PAH",1,1,2,0)
XU*8*434 Set DILOCKTM in Kernel.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","XUS")
0^1^B30954416^B30134409
"RTN","XUS",1,0)
XUS ;SFISC/STAFF - SIGNON ;2/13/07  14:44
"RTN","XUS",2,0)
 ;;8.0;KERNEL;**16,26,49,59,149,180,265,337,419,434**;Jul 10, 1995;Build 6
"RTN","XUS",3,0)
 ;Sign-on message numbers are 30810.51 to 30810.99
"RTN","XUS",4,0)
 S U="^" D INTRO^XUS1A()
"RTN","XUS",5,0)
 K  K ^XUTL("ZISPARAM",$I)
"RTN","XUS",6,0)
 S U="^",XQXFLG("GUI")="^"
"RTN","XUS",7,0)
 W ! S $Y=0 D SET1(1) I POP S XUM=3 G NO ;Sets DUZ("LANG")
"RTN","XUS",8,0)
 S XUSTMP(51)=$$EZBLD^DIALOG(30810.51),XUSTMP(52)=$$EZBLD^DIALOG(30810.52)
"RTN","XUS",9,0)
 W !!,"Volume set: ",$P(XUENV,U,4),"  UCI: ",XUCI,"  Device: ",$I W:$S('$D(IO("ZIO")):0,1:$I'=IO("ZIO")) " (",IO("ZIO"),")" W !
"RTN","XUS",10,0)
RESTART ;
"RTN","XUS",11,0)
 S XUM=$$SET2 G:XUM NO
"RTN","XUS",12,0)
 I $P(XU1,U,2)]"" S XUM=$$DEVPAS() I XUM G H:XUM<0,NO
"RTN","XUS",13,0)
 ;S PGM=$P(XOPT,U,8),XUA=$P(PGM,"[",1) I XUA]"" X XUEON G NEXT^XUS1
"RTN","XUS",14,0)
A S (XUSER(0),XUSER(1),XQUR)=""
"RTN","XUS",15,0)
 ;Check for locked IP/device.
"RTN","XUS",16,0)
 I $$LKCHECK^XUSTZIP() S XUM=7,XUFAC=$P(XOPT,U,2),XUHALT=1 G NO
"RTN","XUS",17,0)
 ;Auto Sign-on check
"RTN","XUS",18,0)
 S X=$$AUTOXUS^XUS1B() I X>0 S DUZ=X D USER(DUZ) W !!,">> Auto Sign-on: ",$P(XUSER(0),U)," <<<",! G B
"RTN","XUS",19,0)
 X XUEOFF S AV=$$ASKAV() X XUEON I AV="^;^" G H ;Get out
"RTN","XUS",20,0)
 I AV["MAIL-BOX",AV[";XMR" S (XUA,PGM)="XMR",XMCHAN=$P($P(AV,";")," ",2),DUZ=.5 G XMR^XUSCLEAN
"RTN","XUS",21,0)
 S XQUR=$P(AV,";",3)
"RTN","XUS",22,0)
 S DUZ=$$CHECKAV(AV) K AV
"RTN","XUS",23,0)
 S XUM=$$UVALID() G:XUM NO
"RTN","XUS",24,0)
B K XUF,%1 S XUF=0 X XUEON
"RTN","XUS",25,0)
 I DUZ D USER^XUS1 G:XUM NO
"RTN","XUS",26,0)
 I DUZ D SEC^XUS3:($D(^%ZIS(1,XUDEV,"TIME"))!$D(^(95))) G:XUM NO
"RTN","XUS",27,0)
 G NO:'DUZ
"RTN","XUS",28,0)
 S DTIME=$P(XOPT,U,10),X=$S(DUZ("BUF"):"",1:"NO-")_"TYPE-AHEAD" X:$D(^%ZOSF(X)) ^(X)
"RTN","XUS",29,0)
 D TT^XUS3:$G(XUTT)
"RTN","XUS",30,0)
 D CLRFAC^XUS3($G(IO("IP")))
"RTN","XUS",31,0)
PGM ;
"RTN","XUS",32,0)
 S Y=+$G(^%ZIS(1,XUDEV,201)) I Y>0,$$CHK S XQY=Y G OK
"RTN","XUS",33,0)
 S Y=+$G(^VA(200,DUZ,201)) I Y>0,$$CHK S XQY=Y G OK
"RTN","XUS",34,0)
 I $D(DUZ("ASH")) S Y=$O(^DIC(19,"B","XU NOP MENU",0)) I Y>0 S XQY=Y G OK ;rwf 403
"RTN","XUS",35,0)
 S XUM=16
"RTN","XUS",36,0)
 G NO
"RTN","XUS",37,0)
 ;
"RTN","XUS",38,0)
OK D CHEK^XQ83
"RTN","XUS",39,0)
 S (XUA,PGM)="XQ"
"RTN","XUS",40,0)
 G NEXT^XUS1
"RTN","XUS",41,0)
 ;
"RTN","XUS",42,0)
CHK() ;Check that option exeist and LOCK
"RTN","XUS",43,0)
 I $D(^DIC(19,Y,0)),$S($P(^(0),U,6)="":1,1:$D(^XUSEC($P(^(0),U,6),DUZ))) Q 1
"RTN","XUS",44,0)
 Q 0
"RTN","XUS",45,0)
 ;
"RTN","XUS",46,0)
LC S X=$$UP(X)
"RTN","XUS",47,0)
 Q
"RTN","XUS",48,0)
UP(%) Q $TR(%,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","XUS",49,0)
 ;
"RTN","XUS",50,0)
FAC ;Failed access
"RTN","XUS",51,0)
 S:'DUZ XUF(.1)=$E(%1)
"RTN","XUS",52,0)
 S:XUF=2 XUF(.2)=XUF(.2)+1,XUF(XUF(.2))=%1 S %1="" Q
"RTN","XUS",53,0)
 Q
"RTN","XUS",54,0)
NO ;Tell why didn't get on
"RTN","XUS",55,0)
 S X=$$NO^XUS3() G RESTART:'X ;fall into exit
"RTN","XUS",56,0)
H ;Exit point for all applications
"RTN","XUS",57,0)
C ;CLOSE
"RTN","XUS",58,0)
 G ^XUSCLEAN
"RTN","XUS",59,0)
 ;
"RTN","XUS",60,0)
ON X ^%ZOSF("EON") Q
"RTN","XUS",61,0)
 ;
"RTN","XUS",62,0)
ASKAV(PRE) ;Ask and return Access;Verify code, Turn off echo before calling
"RTN","XUS",63,0)
 N X,Y S PRE=$G(PRE)
"RTN","XUS",64,0)
 F  W !,PRE,XUSTMP(51) S X=$$ACCEPT S:X="^" X="^;^" Q:$L(X)
"RTN","XUS",65,0)
 S X=$TR(X,$C(9),";") ;Convert TAB to ; to match GUI.
"RTN","XUS",66,0)
 I $P(X," ")="MAIL-BOX" S X=X_";XMR"
"RTN","XUS",67,0)
 I $E(X,1,7)="~~TOK~~" Q X ;Use CCOW token
"RTN","XUS",68,0)
 I '$L($P(X,";",2)) W !,PRE,XUSTMP(52) S Y=$$ACCEPT S:Y="^" X="^;" S $P(X,";",2)=Y
"RTN","XUS",69,0)
 Q X
"RTN","XUS",70,0)
 ;
"RTN","XUS",71,0)
 ;Timeout used by XUSTZ call.
"RTN","XUS",72,0)
ACCEPT(TO) ;Read A/V and echo '*' char.
"RTN","XUS",73,0)
 ;Have the Read write to flush the buffer on some systems
"RTN","XUS",74,0)
 N C,A,E K DUOUT S A="",TO=$G(TO,60),E=0
"RTN","XUS",75,0)
 F  D  Q:E
"RTN","XUS",76,0)
 . R "",*C:TO S:('$T) DUOUT=1 S:('$T)!(C=94) A="^"
"RTN","XUS",77,0)
 . I (A="^")!(C=13)!($L(A)>60) S E=1 Q
"RTN","XUS",78,0)
 . I C=127 Q:'$L(A)  S A=$E(A,1,$L(A)-1) W $C(8,32,8) Q
"RTN","XUS",79,0)
 . S A=A_$C(C) W *42
"RTN","XUS",80,0)
 . Q
"RTN","XUS",81,0)
 Q A
"RTN","XUS",82,0)
 ;
"RTN","XUS",83,0)
CHECKAV(X1) ;Check A/V code return DUZ or Zero. (Called from XUSRB)
"RTN","XUS",84,0)
 N %,%1,X,Y,IEN,DA,DIK
"RTN","XUS",85,0)
 S IEN=0
"RTN","XUS",86,0)
 ;Start CCOW
"RTN","XUS",87,0)
 I $E(X1,1,7)="~~TOK~~" D  Q:IEN>0 IEN
"RTN","XUS",88,0)
 . I $E(X1,8,9)="~1" S IEN=$$CHKASH^XUSRB4($E(X1,8,255))
"RTN","XUS",89,0)
 . I $E(X1,8,9)="~2" S IEN=$$CHKCCOW^XUSRB4($E(X1,8,255))
"RTN","XUS",90,0)
 . Q
"RTN","XUS",91,0)
 ;End CCOW
"RTN","XUS",92,0)
 S X1=$$UP(X1) S:X1[":" XUTT=1,X1=$TR(X1,":")
"RTN","XUS",93,0)
 S X=$P(X1,";") Q:X="^" -1 S:XUF %1="Access: "_X
"RTN","XUS",94,0)
 Q:X'?1.20ANP 0
"RTN","XUS",95,0)
 S X=$$EN^XUSHSH(X) I '$D(^VA(200,"A",X)) D LBAV Q 0
"RTN","XUS",96,0)
 S %1="",IEN=$O(^VA(200,"A",X,0)),XUF(.3)=IEN D USER(IEN)
"RTN","XUS",97,0)
 S X=$P(X1,";",2) S:XUF %1="Verify: "_X S X=$$EN^XUSHSH(X)
"RTN","XUS",98,0)
 I $P(XUSER(1),"^",2)'=X D LBAV Q 0
"RTN","XUS",99,0)
 I $G(XUFAC(1)) S DIK="^XUSEC(4,",DA=XUFAC(1) D ^DIK
"RTN","XUS",100,0)
 Q IEN
"RTN","XUS",101,0)
LBAV ;Log Bad AV
"RTN","XUS",102,0)
 D:XUF FAC
"RTN","XUS",103,0)
 I IEN S X=$P($G(^VA(200,IEN,1.1)),U,2)+1,$P(^(1.1),"^",2)=X
"RTN","XUS",104,0)
 Q
"RTN","XUS",105,0)
 ;
"RTN","XUS",106,0)
USER(IX) ;Build XUSER
"RTN","XUS",107,0)
 S XUSER(0)=$G(^VA(200,+IX,0)),XUSER(1)=$G(^(.1)),XUSER(1.1)=$G(^(1.1))
"RTN","XUS",108,0)
 Q
"RTN","XUS",109,0)
 ;
"RTN","XUS",110,0)
XUVOL ;Setup XUENV, XUCI,XQVOL,XUVOL
"RTN","XUS",111,0)
 S U="^" D GETENV^%ZOSV S XUENV=Y,XUCI=$P(Y,U,1),XQVOL=$P(Y,U,2)
"RTN","XUS",112,0)
 S X=$O(^XTV(8989.3,1,4,"B",XQVOL,0)),XUVOL=$S(X>0:^XTV(8989.3,1,4,X,0),1:XQVOL_"^y^1")
"RTN","XUS",113,0)
 Q
"RTN","XUS",114,0)
 ;
"RTN","XUS",115,0)
XOPT ;Setup initial XOPT
"RTN","XUS",116,0)
 S XOPT=$S($D(^XTV(8989.3,1,"XUS")):^("XUS"),1:"")
"RTN","XUS",117,0)
 F I=2:1:15 I $P(XOPT,U,I)="" S $P(XOPT,U,I)=$P("^5^900^1^1^^^^1^300^^^^N^90",U,I)
"RTN","XUS",118,0)
 Q
"RTN","XUS",119,0)
 ;
"RTN","XUS",120,0)
SET1(FLAG) ;Setup parameters (also called from XUSRB)
"RTN","XUS",121,0)
 N %
"RTN","XUS",122,0)
 S U="^",XUEON=^%ZOSF("EON"),XUEOFF=^("EOFF")
"RTN","XUS",123,0)
 D XUVOL,XOPT S DUZ("LANG")=$P(XOPT,U,7) ;S:$P(XUVOL,U,6)="y" XRTL=XUCI_","_XQVOL
"RTN","XUS",124,0)
 K ^XUTL("XQ",$J) S XUF=0,XUDEV=0,DUZ=0,DUZ(0)="@",IOS=0,ION=""
"RTN","XUS",125,0)
 I FLAG S %ZIS="L",IOP="HOME" D ^%ZIS Q:POP
"RTN","XUS",126,0)
 S XUDEV=IOS,XUIOP=ION
"RTN","XUS",127,0)
 D GETFAC^XUS3($G(IO("IP")))
"RTN","XUS",128,0)
 S %=$P(XOPT,U,14)
"RTN","XUS",129,0)
 I "N"'[% D
"RTN","XUS",130,0)
 . S XUF=(%["R")+1,XUF(.1)="",XUF(.2)=0,XUF(.3)=0
"RTN","XUS",131,0)
 . I %["D" S:$D(^XTV(8989.3,1,4.33,"B",XUDEV))[0 XUF=0
"RTN","XUS",132,0)
 S DILOCKTM=+$G(^DD("DILOCKTM"),1) ;p434 IA#4909
"RTN","XUS",133,0)
 Q
"RTN","XUS",134,0)
SET2() ;EF. Return error code (also called from XUSRB)
"RTN","XUS",135,0)
 N %,X
"RTN","XUS",136,0)
 S XUNOW=$$HTFM^XLFDT($H),DT=$P(XUNOW,".")
"RTN","XUS",137,0)
 K DUZ,XUSER
"RTN","XUS",138,0)
 S (DUZ,DUZ(2))=0,(DUZ(0),DUZ("AG"),XUSER(0),XUSER(1),XUTT,%UCI)=""
"RTN","XUS",139,0)
 S %=$$INHIBIT^XUSRB() I %>0 Q %
"RTN","XUS",140,0)
 S X=$G(^%ZIS(1,XUDEV,"XUS")),XU1=$G(^(1))
"RTN","XUS",141,0)
 I $L(X) F I=1:1:15 I $L($P(X,U,I)) S $P(XOPT,U,I)=$P(X,U,I)
"RTN","XUS",142,0)
 S DTIME=600
"RTN","XUS",143,0)
 I '$P(XOPT,U,11),$D(^%ZIS(1,XUDEV,90)),^(90)>2800000,^(90)'>DT Q 8
"RTN","XUS",144,0)
 Q 0
"RTN","XUS",145,0)
 ;
"RTN","XUS",146,0)
UVALID() ;EF. Is it valid for this user to sign on?
"RTN","XUS",147,0)
 I DUZ'>0 Q 4
"RTN","XUS",148,0)
 I $P(XUSER(1.1),U,5),$P(XUSER(1.1),U,5)>XUNOW S XUM(0)=$$FMTE^XLFDT($P(XUSER(1.1),U,5),"2PM") Q 18 ;User locked until
"RTN","XUS",149,0)
 I $P(XUSER(0),U,11),$P(XUSER(0),U,11)'>DT Q 11 ;Access Terminated
"RTN","XUS",150,0)
 I $D(DUZ("ASH")) Q 0 ;If auto handle, Allow to sign-on p434
"RTN","XUS",151,0)
 I $P(XUSER(0),U,7) Q 5 ;Disuser flag set
"RTN","XUS",152,0)
 I '$L($P(XUSER(1),U,2)) Q 21 ;p419, p434
"RTN","XUS",153,0)
 Q 0
"RTN","XUS",154,0)
 ;
"RTN","XUS",155,0)
DEVPAS() ;EF. Ask device password
"RTN","XUS",156,0)
 X XUEOFF W !,"DEVICE PASSWORD: " R X:60 X XUEON
"RTN","XUS",157,0)
 S X=$E(X,1,30) S:'$T X="^" D LC Q:X["^" -1 I $P(XU1,U,2)'=X S:XUF %1="Device: "_X D:XUF FAC Q 6
"RTN","XUS",158,0)
 Q 0
"RTN","XUS",159,0)
 ;
"RTN","XUSCLEAN")
0^2^B13027306^B12811237
"RTN","XUSCLEAN",1,0)
XUSCLEAN ;SF/STAFF - CLEANUP BEFORE EXIT ;10/26/06  08:12
"RTN","XUSCLEAN",2,0)
 ;;8.0;KERNEL;**13,59,165,353,434**;Jul 10, 1995;Build 6
"RTN","XUSCLEAN",3,0)
H ;;Exit point for all R/S applications
"RTN","XUSCLEAN",4,0)
 LOCK  ;Unlock any locks
"RTN","XUSCLEAN",5,0)
 S U="^"
"RTN","XUSCLEAN",6,0)
 ;Unwind Exit Actions
"RTN","XUSCLEAN",7,0)
 I $D(^XUTL("XQ",$J,"T")) S %XQEA=^("T") D
"RTN","XUSCLEAN",8,0)
 . F %XQEA1=%XQEA:-1:1 I $D(^XUTL("XQ",$J,%XQEA1)),$P(^(%XQEA1),U,16) S %XQEA2=+^(%XQEA1) I $D(^DIC(19,%XQEA2,15)),$L(^(15)) X ^(15)
"RTN","XUSCLEAN",9,0)
 K %XQEA,%XQEA1,%XQEA2
"RTN","XUSCLEAN",10,0)
 ;Jump if the home device was closed
"RTN","XUSCLEAN",11,0)
 G:$D(IO("C")) H2
"RTN","XUSCLEAN",12,0)
 ;Clear the screen
"RTN","XUSCLEAN",13,0)
 I $S($D(IOST)[0:1,IOST="":1,IOST["C-":1,1:0),'$D(XUERF) W !!!!!!!!!!!!!!!!!!!!!!!
"RTN","XUSCLEAN",14,0)
 I $D(XQNOLOG) W !!,"==>  Sorry, all activity on this volume set is being halted!  Try again later.",*7,*7,*7,!!!!
"RTN","XUSCLEAN",15,0)
 ;W !!,"Halting at " S X=$P($H,",",2),Y=$E(X#3600\60+100,2,3),X=X\3600,Z=0 S:X>11 Z=1 S:'X X=12 S:X>12 X=X-12 W X,":",Y," ",$S(Z:"pm",1:"am")
"RTN","XUSCLEAN",16,0)
 W !!,"Logged out at "_$$HTE^XLFDT($H,"1FMP")
"RTN","XUSCLEAN",17,0)
 D:$D(DUZ("NEWCODE")) NEWCODE
"RTN","XUSCLEAN",18,0)
 ;NON-R/S exit thru here also.
"RTN","XUSCLEAN",19,0)
H2 ;No talking after this point
"RTN","XUSCLEAN",20,0)
 D C,XUTL
"RTN","XUSCLEAN",21,0)
 ;un-comment the following line if you want FM space recall cleared
"RTN","XUSCLEAN",22,0)
 ;after each session.
"RTN","XUSCLEAN",23,0)
 ;K ^DISV($G(DUZ,0))
"RTN","XUSCLEAN",24,0)
 S:'($D(XQXFLG)#2) XQXFLG="" I $D(XQCH),XQCH="HALT" S $P(XQXFLG,U,3)=""
"RTN","XUSCLEAN",25,0)
 I ($D(XQNOHALT)#2)!($D(ZTQUEUED)#2)!($P(XQXFLG,U,3)="XUP") K XQNOHALT,XQXFLG Q  ;Return to REST^XQ12, ^XUP or Taskman.
"RTN","XUSCLEAN",26,0)
 ;This was for modem hang up code. Obsolete now
"RTN","XUSCLEAN",27,0)
 I $D(^%ZIS("H"))#2 X ^("H")
"RTN","XUSCLEAN",28,0)
 ;Go to ZU to do final halt.
"RTN","XUSCLEAN",29,0)
 G HALT^ZU
"RTN","XUSCLEAN",30,0)
 ;
"RTN","XUSCLEAN",31,0)
TOUCH ;SR. API to set the keepalive node, Only set once a day
"RTN","XUSCLEAN",32,0)
 Q:+$G(^XUTL("XQ",$J,"KEEPALIVE"))=+$H
"RTN","XUSCLEAN",33,0)
 S ^XUTL("XQ",$J,"KEEPALIVE")=$H
"RTN","XUSCLEAN",34,0)
 Q
"RTN","XUSCLEAN",35,0)
 ;
"RTN","XUSCLEAN",36,0)
C ;Do device close execute, User exit.
"RTN","XUSCLEAN",37,0)
 N XUDEV
"RTN","XUSCLEAN",38,0)
 S XUDEV=$S($D(^XUTL("XQ",$J,"IOS")):^("IOS"),1:"")
"RTN","XUSCLEAN",39,0)
 D ^%ZISC,BYE
"RTN","XUSCLEAN",40,0)
 Q
"RTN","XUSCLEAN",41,0)
 ;
"RTN","XUSCLEAN",42,0)
 ;Called from Broker, VistaLink, R/S
"RTN","XUSCLEAN",43,0)
BYE ;Set flags to show user has left. Called from anyplace the user exits
"RTN","XUSCLEAN",44,0)
 N DA,DIK,R0,%
"RTN","XUSCLEAN",45,0)
 I $G(^VA(200,+$G(DUZ),1.1)) S $P(^VA(200,DUZ,1.1),"^",3)=0
"RTN","XUSCLEAN",46,0)
 S DA=+$G(^XUTL("XQ",$J,0)) D LOUT(DA)
"RTN","XUSCLEAN",47,0)
 I $D(^XUSEC(0,DA,0)) D
"RTN","XUSCLEAN",48,0)
 . S R0=^XUSEC(0,DA,0)
"RTN","XUSCLEAN",49,0)
 . I $G(IO("IP"))]"",$P(R0,"^",13)]"" S %=$$CMD^XWBCAGNT(.R0,"XWB DELETE HANDLE",$P(R0,"^",13))
"RTN","XUSCLEAN",50,0)
 K ^XUTL("XQ",$J)
"RTN","XUSCLEAN",51,0)
 Q
"RTN","XUSCLEAN",52,0)
 ;
"RTN","XUSCLEAN",53,0)
LOUT(DA) ;Enter log-out time, in Sign-on log
"RTN","XUSCLEAN",54,0)
 N DIK
"RTN","XUSCLEAN",55,0)
 I $D(^XUSEC(0,DA,0)) D
"RTN","XUSCLEAN",56,0)
 . S R0=^(0),$P(^(0),"^",4)=$$NOW^XLFDT,DIK="^XUSEC(0,",DIK(1)="3" D EN1^DIK
"RTN","XUSCLEAN",57,0)
 Q
"RTN","XUSCLEAN",58,0)
 ;
"RTN","XUSCLEAN",59,0)
XUTL ;Cleanup JOB temporary Globals
"RTN","XUSCLEAN",60,0)
 N XQN D CLEAN^DILF ;Cleanup FM too.
"RTN","XUSCLEAN",61,0)
 K ^XUTL($J),^UTILITY($J),^TMP($J)
"RTN","XUSCLEAN",62,0)
 S XQN=" " F  S XQN=$O(^XUTL(XQN)) Q:XQN=""  K:"^XQO^XGATR^XGKB^"'[XQN ^XUTL(XQN,$J)
"RTN","XUSCLEAN",63,0)
 S XQN=" " F  S XQN=$O(^TMP(XQN)) Q:XQN=""  K ^TMP(XQN,$J)
"RTN","XUSCLEAN",64,0)
 S XQN=" " F  S XQN=$O(^UTILITY(XQN)) Q:XQN=""  K:"^ROU^GLO^LRLTR"'[XQN ^UTILITY(XQN,$J)
"RTN","XUSCLEAN",65,0)
 K ^XUTL("ZISPARAM",$I)
"RTN","XUSCLEAN",66,0)
 Q
"RTN","XUSCLEAN",67,0)
 ;
"RTN","XUSCLEAN",68,0)
NEWCODE ;Remind user they changed there VC.
"RTN","XUSCLEAN",69,0)
 W !!,*7,"But, as I recall...",!,"You've changed your VERIFY CODE during this session.",!,"Please remember it for next time." H 4
"RTN","XUSCLEAN",70,0)
 Q
"RTN","XUSCLEAN",71,0)
 ;
"RTN","XUSCLEAN",72,0)
 ;Entry point to clear symbol table
"RTN","XUSCLEAN",73,0)
KILL ;SR. This is what was requested.
"RTN","XUSCLEAN",74,0)
 K %1,%2,%3 S %3=+$G(^XUTL("XQ",$J,"T"))
"RTN","XUSCLEAN",75,0)
 ;See if Menu stack has Variable to protect.
"RTN","XUSCLEAN",76,0)
 F %1=%3:-1:1 S %2=+$G(^XUTL("XQ",$J,%1)),%2=$G(^DIC(19,%2,"NOKILL")) I %2]"" N @%2
"RTN","XUSCLEAN",77,0)
 ;Fall into next part of kill.
"RTN","XUSCLEAN",78,0)
KILL1 ;To clean up ALL but kernel variables.
"RTN","XUSCLEAN",79,0)
 I $$BROKER^XWBLIB S %2=$P($T(VARLST^XWBLIB),";;",2) I %2]"" N @%2 ;Protect Broker variables.
"RTN","XUSCLEAN",80,0)
 N XGWIN,XGDI,XGEVENT ;P434 remove KWAPI
"RTN","XUSCLEAN",81,0)
 N XQAEXIT,XQAUSER,XQX1,XQAKILL,XQAID
"RTN","XUSCLEAN",82,0)
 ;p434 add DILOCKTM, remove XRTL, %ZH0
"RTN","XUSCLEAN",83,0)
 K (DUZ,DTIME,DILOCKTM,DT,DISYS,IO,IOBS,IOF,IOM,ION,IOSL,IOST,IOT,IOS,IOXY,U,XQVOL,XQY,XQY0,XQDIC,XQPSM,XQPT,XQAUDIT,XQXFLG,ZTSTOP,ZTQUEUED,ZTREQ)
"RTN","XUSCLEAN",84,0)
 K IO("C"),IO("Q")
"RTN","XUSCLEAN",85,0)
 Q
"RTN","XUSCLEAN",86,0)
 ;
"RTN","XUSCLEAN",87,0)
XMR ;Entry point from XUS to DO xmr and cleanup after.
"RTN","XUSCLEAN",88,0)
 N XQXFLG ;p434
"RTN","XUSCLEAN",89,0)
 D NEXT^XUS1 S XQXFLG="",XQXFLG("HALT")=1 G H2
"VER")
8.0^22.0
"BLD",972,6)
^384
**END**
**END**
