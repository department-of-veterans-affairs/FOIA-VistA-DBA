Released PSA*3*8 SEQ #3
Extracted from mail message
**KIDS**:PSA*3.0*8^

**INSTALL NAME**
PSA*3.0*8
"BLD",505,0)
PSA*3.0*8^DRUG ACCOUNTABILITY^0^2980911^y
"BLD",505,1,0)
^^1^1^2980911^^^^
"BLD",505,1,1,0)
Compliance with MailMan patch XM*7.1*50 and NDF patch PSN*3.18*5
"BLD",505,"KRN",0)
^9.67PA^^
"BLD",505,"KRN",.4,0)
.4
"BLD",505,"KRN",.4,"NM",0)
^9.68A^^0
"BLD",505,"KRN",.401,0)
.401
"BLD",505,"KRN",.401,"NM",0)
^9.68A^^0
"BLD",505,"KRN",.402,0)
.402
"BLD",505,"KRN",.402,"NM",0)
^9.68A^^0
"BLD",505,"KRN",.403,0)
.403
"BLD",505,"KRN",.5,0)
.5
"BLD",505,"KRN",.84,0)
.84
"BLD",505,"KRN",3.6,0)
3.6
"BLD",505,"KRN",3.8,0)
3.8
"BLD",505,"KRN",9.2,0)
9.2
"BLD",505,"KRN",9.8,0)
9.8
"BLD",505,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",505,"KRN",9.8,"NM",1,0)
PSAGIP^^0^B22177455
"BLD",505,"KRN",9.8,"NM",2,0)
PSAGIP1^^0^B14649360
"BLD",505,"KRN",9.8,"NM",3,0)
PSANDF^^0^B48925843
"BLD",505,"KRN",9.8,"NM",4,0)
PSATI^^0^B27466544
"BLD",505,"KRN",9.8,"NM","B","PSAGIP",1)

"BLD",505,"KRN",9.8,"NM","B","PSAGIP1",2)

"BLD",505,"KRN",9.8,"NM","B","PSANDF",3)

"BLD",505,"KRN",9.8,"NM","B","PSATI",4)

"BLD",505,"KRN",19,0)
19
"BLD",505,"KRN",19.1,0)
19.1
"BLD",505,"KRN",101,0)
101
"BLD",505,"KRN",409.61,0)
409.61
"BLD",505,"KRN",771,0)
771
"BLD",505,"KRN",869.2,0)
869.2
"BLD",505,"KRN",870,0)
870
"BLD",505,"KRN",8994,0)
8994
"BLD",505,"KRN","B",.4,.4)

"BLD",505,"KRN","B",.401,.401)

"BLD",505,"KRN","B",.402,.402)

"BLD",505,"KRN","B",.403,.403)

"BLD",505,"KRN","B",.5,.5)

"BLD",505,"KRN","B",.84,.84)

"BLD",505,"KRN","B",3.6,3.6)

"BLD",505,"KRN","B",3.8,3.8)

"BLD",505,"KRN","B",9.2,9.2)

"BLD",505,"KRN","B",9.8,9.8)

"BLD",505,"KRN","B",19,19)

"BLD",505,"KRN","B",19.1,19.1)

"BLD",505,"KRN","B",101,101)

"BLD",505,"KRN","B",409.61,409.61)

"BLD",505,"KRN","B",771,771)

"BLD",505,"KRN","B",869.2,869.2)

"BLD",505,"KRN","B",870,870)

"BLD",505,"KRN","B",8994,8994)

"BLD",505,"QUES",0)
^9.62^^
"BLD",505,"REQB",0)
^9.611^1^1
"BLD",505,"REQB",1,0)
PSN*3.18*5^1
"BLD",505,"REQB","B","PSN*3.18*5",1)

"BLD",505,"REQG",0)
^9.611^^
"PKG",182,-1)
1^1
"PKG",182,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability/Inventory Interface^
"PKG",182,20,0)
^9.402P^^0
"PKG",182,22,0)
^9.49I^1^1
"PKG",182,22,1,0)
3.0^2971024^2970912^531
"PKG",182,22,1,"PAH",1,0)
8^2980911
"PKG",182,22,1,"PAH",1,1,0)
^^1^1^2980911
"PKG",182,22,1,"PAH",1,1,1,0)
Compliance with MailMan patch XM*7.1*50 and NDF patch PSN*3.18*5
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSAGIP")
0^1^B22177455
"RTN","PSAGIP",1,0)
PSAGIP ;BIR/LTL,JMB-DA receiving from GIP ;7/23/97
"RTN","PSAGIP",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**8**; 10/24/97
"RTN","PSAGIP",3,0)
 Q
"RTN","PSAGIP",4,0)
EN(PSAGIP,PSAITEM,PSAQTY,PSAISS,PSAEX,PSATR,PSACOST,PSANDC)     ; GIP passes recing data
"RTN","PSAGIP",5,0)
 ;PSAGIP=D0 from #445, PSAITEM=D0 from #441,
"RTN","PSAGIP",6,0)
 ;PSAQTY=qty rec'd converted to dispensing unit, PSAISS=D0 from #410,
"RTN","PSAGIP",7,0)
 ;PSAEX=external form of D0 from either #410 or #442,
"RTN","PSAGIP",8,0)
 ;PSATR=D0 from #445.2, PSACOST=total cost of receipt,
"RTN","PSAGIP",9,0)
 ;PSANDC=NDC with dashes
"RTN","PSAGIP",10,0)
 Q:'$G(PSAQTY)
"RTN","PSAGIP",11,0)
 Q:'$O(^PSD(58.8,"P",+$G(PSAGIP),""))  ; GIP not linked to DA location
"RTN","PSAGIP",12,0)
 ;check item linked to drug, drug stocked by DA loc, rec fail flag
"RTN","PSAGIP",13,0)
 N PSALOC S PSALOC=$O(^PSD(58.8,"P",+$G(PSAGIP),0)),PSADRUG=+$O(^PSDRUG("AB",+$G(PSAITEM),0))
"RTN","PSAGIP",14,0)
 S ^TMP("PSAC",$J,+PSALOC)=$G(PSAGIP)_U_$G(PSAEX)
"RTN","PSAGIP",15,0)
 I 'PSADRUG,$P($G(^PSD(58.8,+PSALOC,4,+$G(PSAGIP),0)),U,2) S ^TMP("PSAB",$J,+$G(PSAITEM))="#"+$G(PSAITEM)_"  "_$$DESCR^PRCPUX1($G(PSAGIP),$G(PSAITEM))_" NOT LINKED." Q
"RTN","PSAGIP",16,0)
 I '$D(^PSD(58.8,+PSALOC,1,PSADRUG,0)),$P($G(^PSD(58.8,+PSALOC,4,+$G(PSAGIP),0)),U,2) S ^TMP("PSAB",$J,+$G(PSAITEM))="#"_$G(PSAITEM)_"  "_$$DESCR^PRCPUX1($G(PSAGIP),$G(PSAITEM))_" NOT STOCKED." Q
"RTN","PSAGIP",17,0)
 Q:'$D(^PSD(58.8,+PSALOC,1,$G(PSADRUG),0))
"RTN","PSAGIP",18,0)
 S ^TMP("PSA",$J,$G(PSADRUG))=$G(PSAQTY)_U_$G(PSAISS)_U_$G(PSAEX)_U_$G(PSATR)_U_$G(PSACOST)_U_$G(PSAITEM)_U_$G(PSANDC)
"RTN","PSAGIP",19,0)
 Q
"RTN","PSAGIP",20,0)
EX N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK,PSALOC,PSADAT,PSAB,PSAT,PSAGIP
"RTN","PSAGIP",21,0)
 Q:'$O(^TMP("PSAC",$J,0))
"RTN","PSAGIP",22,0)
 Q:'$O(^TMP("PSA",$J,0))&('$O(^TMP("PSAB",$J,0)))
"RTN","PSAGIP",23,0)
 S PSALOC=$O(^TMP("PSAC",$J,0)),PSAGIP=$P($G(^TMP("PSAC",$J,+PSALOC)),U)
"RTN","PSAGIP",24,0)
 S ZTDTH=$H,ZTIO="",ZTRTN="TSK^PSAGIP",ZTDESC="GIP/DA Receiving"
"RTN","PSAGIP",25,0)
 S ZTSAVE("PSALOC")="",ZTSAVE("PSAGIP")=""
"RTN","PSAGIP",26,0)
 S:$O(^TMP("PSA",$J,0)) ZTSAVE("^TMP(""PSA"",$J,")=""
"RTN","PSAGIP",27,0)
 S:$O(^TMP("PSAB",$J,0)) ZTSAVE("^TMP(""PSAB"",$J,")=""
"RTN","PSAGIP",28,0)
 S ZTSAVE("^TMP(""PSAC"",$J,")=""
"RTN","PSAGIP",29,0)
 D ^%ZTLOAD,HOME^%ZIS
"RTN","PSAGIP",30,0)
 K IO("Q"),^TMP("PSA",$J),^TMP("PSAB",$J),^TMP("PSAC",$J)
"RTN","PSAGIP",31,0)
 Q
"RTN","PSAGIP",32,0)
TSK N PSAM
"RTN","PSAGIP",33,0)
 S:$P($G(^PSD(58.8,+PSALOC,0)),U,2)="M" PSAM=1
"RTN","PSAGIP",34,0)
 F PSADRUG=0:0 S PSADRUG=$O(^TMP("PSA",$J,PSADRUG)) Q:'PSADRUG  S PSAQTY=$P($G(^TMP("PSA",$J,PSADRUG)),U),PSAISS=$P($G(^(PSADRUG)),U,2),PSAP=$P($G(^(PSADRUG)),U,3),PSATR=$P($G(^(PSADRUG)),U,4),PSACOST=$P($G(^(PSADRUG)),U,5) D
"RTN","PSAGIP",35,0)
 .S PSANDC=$P($G(^TMP("PSA",$J,PSADRUG)),U,7) D ^PSAGIP1
"RTN","PSAGIP",36,0)
 .S:'$P(PSAP,"-",3) PSAPO=PSAP
"RTN","PSAGIP",37,0)
 .L +^PSD(58.8,+PSALOC,1,+PSADRUG):5
"RTN","PSAGIP",38,0)
 .D NOW^%DTC S PSADAT=+$E(%,1,12) K %
"RTN","PSAGIP",39,0)
 .S PSAB=$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,0)),U,4)
"RTN","PSAGIP",40,0)
 .S $P(^PSD(58.8,+PSALOC,1,+PSADRUG,0),U,4)=$G(PSAQTY)+PSAB
"RTN","PSAGIP",41,0)
 .L -^PSD(58.8,+PSALOC,1,+PSADRUG)
"RTN","PSAGIP",42,0)
MON .S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSAGIP",43,0)
 .I '$D(^PSD(58.8,+PSALOC,1,+PSADRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="LM",DIC("DR")="1////^S X=$G(PSAB)" D
"RTN","PSAGIP",44,0)
 ..S (X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO,X
"RTN","PSAGIP",45,0)
 ..S X="T-1M" D ^%DT S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO,X S DA=+Y K Y
"RTN","PSAGIP",46,0)
 ..S DIE="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DA(2)=PSALOC,DA(1)=PSADRUG
"RTN","PSAGIP",47,0)
 ..S DR="3////^S X=$G(PSAB)" D ^DIE K DIE,DR
"RTN","PSAGIP",48,0)
 .S DIE="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DA(2)=PSALOC,DA(1)=PSADRUG,DA=$E(DT,1,5)*100,DR="5////^S X=$P($G(^(0)),U,3)+$G(PSAQTY)" D ^DIE K DIE,DR
"RTN","PSAGIP",49,0)
TR .F  L +^PSD(58.81,0):0 I  Q
"RTN","PSAGIP",50,0)
FIND .D FIND1 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO L -^PSD(58.81,0)
"RTN","PSAGIP",51,0)
 .S DIE="^PSD(58.81,",DA=PSAT
"RTN","PSAGIP",52,0)
 .S DR="1////^S X=$S($E($G(PSATR))=""R"":1,1:9);2////^S X=$G(PSALOC);3////^S X=PSADAT;4////^S X=$G(PSADRUG);5////^S X=$G(PSAQTY);6////^S X=DUZ;7////^S X=$G(PSAISS);8///^S X=$G(PSAPO);9////^S X=PSAB;100////^S X=$G(PSAM)"
"RTN","PSAGIP",53,0)
 .D ^DIE K DIE,DR
"RTN","PSAGIP",54,0)
 .S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSAGIP",55,0)
 .S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,4,",DIC(0)="L",(X,DINUM)=PSAT
"RTN","PSAGIP",56,0)
 .S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DA,DIC,DLAYGO,DINUM,PSAB,PSAISS,PSANDC,PSAPO,PSAQTY,PSATR
"RTN","PSAGIP",57,0)
 K ^TMP("PSA",$J)
"RTN","PSAGIP",58,0)
 Q:'$O(^TMP("PSAB",$J,0))
"RTN","PSAGIP",59,0)
 S:'$G(PSAP) PSAP=$P($G(^TMP("PSAC",$J,PSALOC)),U,2)
"RTN","PSAGIP",60,0)
 S XMDUZ="Failed Receipt Notifier",XMSUB="Failed DA/GIP Receipts - "_PSAP
"RTN","PSAGIP",61,0)
 S XMY(DUZ)=""
"RTN","PSAGIP",62,0)
 I $P($G(^PSD(58.8,+PSALOC,4,+$G(PSAGIP),0)),U,3)'="" S XX=$P(^(0),"^",3),XXX="G."_XX,XMY(XXX)="" K XX,XXX
"RTN","PSAGIP",63,0)
 S XMTEXT="^TMP(""PSAB"",$J,"
"RTN","PSAGIP",64,0)
 G:'$D(XMY) QUIT1 D ^XMD
"RTN","PSAGIP",65,0)
QUIT1 K XMDUZ,XMSUB,XMTEXT,XMY
"RTN","PSAGIP",66,0)
 S:$D(ZTQUEUED) ZTREQ="@" K ^TMP("PSAB",$J)
"RTN","PSAGIP",67,0)
QUIT Q
"RTN","PSAGIP",68,0)
FIND1 S PSAT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND1
"RTN","PSAGIP",69,0)
 Q
"RTN","PSAGIP1")
0^2^B14649360
"RTN","PSAGIP1",1,0)
PSAGIP1 ;BIR/LTL,JMB-DA receiving from GIP - CONT'D;7/23/97
"RTN","PSAGIP1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**8**; 10/24/97
"RTN","PSAGIP1",3,0)
 N PSACOS,PSACO,PSACOD,PSAPC1,PSAPC2,PSAPC3,PSAFND,PSAONDC,PSAQT,PSAC,DA,DIE,DR,XMDUZ,XMSUB,XMY,XMTEXT
"RTN","PSAGIP1",4,0)
 G:'PSACOST!('PSAQTY) NDC
"RTN","PSAGIP1",5,0)
 S PSACOS=+$J((PSACOST/PSAQTY),0,3)
"RTN","PSAGIP1",6,0)
 S PSACO=$G(^PSDRUG(+PSADRUG,660))
"RTN","PSAGIP1",7,0)
 G:PSACOS=+$P(PSACO,U,6)!('$P(PSACO,U,5)) NDC
"RTN","PSAGIP1",8,0)
 S PSAQT=$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,0)),U,4)
"RTN","PSAGIP1",9,0)
 I PSAQT>0 S PSACOST=PSACOST+(PSAQT*+$P(PSACO,U,6)),PSAQT=PSAQTY+PSAQT,PSACOS=+$J((PSACOST/PSAQT),0,3)
"RTN","PSAGIP1",10,0)
 G:PSACOS=+$P(PSACO,U,6) NDC
"RTN","PSAGIP1",11,0)
 S PSAC=+$J((PSACOS*$P(PSACO,U,5)),0,2)
"RTN","PSAGIP1",12,0)
 S DIE="^PSDRUG(",DA=PSADRUG
"RTN","PSAGIP1",13,0)
 S PSAFND=0,PSAONDC=$P($G(^PSDRUG(PSADRUG,2)),"^",4)
"RTN","PSAGIP1",14,0)
 D:PSANDC'=PSAONDC&(PSANDC'="")
"RTN","PSAGIP1",15,0)
 .S PSAPC1=$L($P(PSANDC,"-")),PSAPC2=$L($P(PSANDC,"-",2)),PSAPC3=$L($P(PSANDC,"-",3))
"RTN","PSAGIP1",16,0)
 .I PSAPC1=4,PSAPC2=4,PSAPC3=2 S PSAFND=1 Q
"RTN","PSAGIP1",17,0)
 .I PSAPC1=5,PSAPC2=3,PSAPC3=2 S PSAFND=1 Q
"RTN","PSAGIP1",18,0)
 .I PSAPC1=5,PSAPC2=4,PSAPC3=1 S PSAFND=1 Q
"RTN","PSAGIP1",19,0)
 .I PSAPC1=5,PSAPC2=4,PSAPC3=2 S PSAFND=1 Q
"RTN","PSAGIP1",20,0)
 .I PSAPC1=6,PSAPC2=4,PSAPC3=2 S PSAFND=1
"RTN","PSAGIP1",21,0)
 S DR=$S(PSAFND:"13////"_PSAC_";31////"_PSANDC,1:"13////"_PSAC) D ^DIE K DIE,DA
"RTN","PSAGIP1",22,0)
 S ^TMP("PSAD",$J,$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,25))=$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,25)_", Item #"_$P($G(^TMP("PSA",$J,PSADRUG)),U,6)_", Old price: $"_$P(PSACO,U,6)_", New price: $"_PSACOS
"RTN","PSAGIP1",23,0)
 I PSANDC'=PSAONDC,PSANDC'="" D
"RTN","PSAGIP1",24,0)
 .S ^TMP("PSAD",$J,$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,25),1)="   Old NDC: "_$S(PSAONDC'="":PSAONDC,1:"None")_", New NDC: "_PSANDC
"RTN","PSAGIP1",25,0)
 .I 'PSAFND S ^TMP("PSAD",$J,$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,25),2)="   The new NDC was not entered in the DRUG file due to an invalid format."
"RTN","PSAGIP1",26,0)
END Q:$O(^TMP("PSA",$J,PSADRUG))
"RTN","PSAGIP1",27,0)
 N PSAMSG S PSAMSG=$O(^TMP("PSAD",$J,"")) Q:PSAMSG=""
"RTN","PSAGIP1",28,0)
 N PSADRG S PSACNT=1,PSADRG=""
"RTN","PSAGIP1",29,0)
 F  S PSADRG=$O(^TMP("PSAD",$J,PSADRG)) Q:PSADRG=""  D
"RTN","PSAGIP1",30,0)
 .S ^TMP("PSAMSG",$J,PSACNT)=^TMP("PSAD",$J,PSADRG),PSACNT=PSACNT+1
"RTN","PSAGIP1",31,0)
 .S:$D(^TMP("PSAD",$J,PSADRG,1)) ^TMP("PSAMSG",$J,PSACNT)=^TMP("PSAD",$J,PSADRG,1),PSACNT=PSACNT+1
"RTN","PSAGIP1",32,0)
 .S:$D(^TMP("PSAD",$J,PSADRG,2)) ^TMP("PSAMSG",$J,PSACNT)=^TMP("PSAD",$J,PSADRG,2),PSACNT=PSACNT+1
"RTN","PSAGIP1",33,0)
 S XMDUZ="Price & NDC Updater",XMSUB="DRUG file Price/NDC Update - "_PSAP
"RTN","PSAGIP1",34,0)
 S XMY(DUZ)="",XMTEXT="^TMP(""PSAMSG"",$J,"
"RTN","PSAGIP1",35,0)
 I $P($G(^PSD(58.8,+PSALOC,4,+$G(PSAGIP),0)),U,3)'="" S XX=$P(^(0),"^",3),XXX="G."_XX,XMY(XXX)="" K XX,XXX
"RTN","PSAGIP1",36,0)
 G:'$D(XMY) QUIT D ^XMD
"RTN","PSAGIP1",37,0)
QUIT K ^TMP("PSAD",$J),^TMP("PSAMSG",$J)
"RTN","PSAGIP1",38,0)
 Q
"RTN","PSAGIP1",39,0)
NDC ;This is called if the cost has not changed.
"RTN","PSAGIP1",40,0)
 S PSAFND=0,PSAONDC=$P($G(^PSDRUG(PSADRUG,2)),"^",4)
"RTN","PSAGIP1",41,0)
 G:PSANDC=PSAONDC!(PSANDC="") END
"RTN","PSAGIP1",42,0)
 D:PSANDC'=""
"RTN","PSAGIP1",43,0)
 .S PSAPC1=$L($P(PSANDC,"-")),PSAPC2=$L($P(PSANDC,"-",2)),PSAPC3=$L($P(PSANDC,"-",3))
"RTN","PSAGIP1",44,0)
 .I PSAPC1=4,PSAPC2=4,PSAPC3=2 S PSAFND=1
"RTN","PSAGIP1",45,0)
 .I PSAPC1=5,PSAPC2=3,PSAPC3=2 S PSAFND=1
"RTN","PSAGIP1",46,0)
 .I PSAPC1=5,PSAPC2=4,PSAPC3=1 S PSAFND=1
"RTN","PSAGIP1",47,0)
 .I PSAPC1=5,PSAPC2=4,PSAPC3=2 S PSAFND=1
"RTN","PSAGIP1",48,0)
 .I PSAPC1=6,PSAPC2=4,PSAPC3=2 S PSAFND=1
"RTN","PSAGIP1",49,0)
 .I PSAFND S DIE="^PSDRUG(",DA=PSADRUG,DR=";31////^S X=PSANDC" D ^DIE K DIE,DA
"RTN","PSAGIP1",50,0)
 S ^TMP("PSAD",$J,$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,25))=$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,25)_", Item #"_$P($G(^TMP("PSA",$J,PSADRUG)),U,6)
"RTN","PSAGIP1",51,0)
 S ^TMP("PSAD",$J,$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,25),1)="   Old NDC: "_$S(PSAONDC'="":PSAONDC,1:"None")_", New NDC: "_PSANDC
"RTN","PSAGIP1",52,0)
 I 'PSAFND S ^TMP("PSAD",$J,$E($P($G(^PSDRUG(+PSADRUG,0)),U),1,25),2)="   The new NDC was not entered in the DRUG file due to an invalid format."
"RTN","PSAGIP1",53,0)
 G END
"RTN","PSANDF")
0^3^B48925843
"RTN","PSANDF",1,0)
PSANDF ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSANDF",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**8**; 10/24/97
"RTN","PSANDF",3,0)
 ;This routine searches NDF for the NDC. If it is not found, the user
"RTN","PSANDF",4,0)
 ;is asked to select the drug from the DRUG file.
"RTN","PSANDF",5,0)
 ;
"RTN","PSANDF",6,0)
 I PSANDC="",$P(PSADATA,"^",26)'="" D  Q
"RTN","PSANDF",7,0)
 .I +$P($P(PSADATA,"^",26),"~",2) D
"RTN","PSANDF",8,0)
 ..K PSASUP S PSASUP="S"_$P(PSADATA,"^",26),(PSACNT,PSAIEN50)=0
"RTN","PSANDF",9,0)
 ..F  S PSAIEN50=$O(^PSDRUG("C",PSASUP,PSAIEN50)) Q:PSAIEN50=""  D
"RTN","PSANDF",10,0)
 ...S PSASSUB=0 F  S PSASSUB=$O(^PSDRUG("C",PSASUP,PSAIEN50,PSASSUB)) Q:'PSASSUB  S PSACNT=PSACNT+1,PSASUP(PSACNT)=PSAIEN50_"^"_PSASSUB
"RTN","PSANDF",11,0)
 ..I 'PSACNT D  Q
"RTN","PSANDF",12,0)
 ...W !,"The vendor sent no NDC or UPC for the item."
"RTN","PSANDF",13,0)
 ...D ASKDRUG S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSANDF",14,0)
 ..I PSACNT=1 D  Q
"RTN","PSANDF",15,0)
 ...S PSAIEN=$P(PSASUP(1),"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSASUP(1),"^",2),$P(^(PSALINE),"^",7)=PSASUB
"RTN","PSANDF",16,0)
 ...S PSANDC=PSASUP,$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC,PSAVSN=$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",4),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=PSAVSN
"RTN","PSANDF",17,0)
 ...S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSANDF",18,0)
 ..I PSACNT>1 S PSACNT=$O(PSASUP(0)) D:PSACNT MANYUPCS^PSAPROC5
"RTN","PSANDF",19,0)
 ;
"RTN","PSANDF",20,0)
LOOKNDF S PSACNT=0,X=$$PSA^PSNAPIS(PSANDC,.PSALIST),PSACNT=X
"RTN","PSANDF",21,0)
 I $G(PSACNT)>0 S X=0 F  S X=$O(^PSALIST(X)) Q:X'>0  I '$D(^PSDRUG(X,"I")) S ^TMP("PSANDF",$J,X)=$P(PSALIST(X),"^")
"RTN","PSANDF",22,0)
 K PSALIST,X
"RTN","PSANDF",23,0)
NONE I 'PSACNT D  Q
"RTN","PSANDF",24,0)
 .I +$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4),"~",2)!($P($P(^(PSALINE),"^",4),"~",3)'="") D ^PSAPROC4
"RTN","PSANDF",25,0)
 .E  D ASKDRUG
"RTN","PSANDF",26,0)
 I PSACNT=1 D ONE Q
"RTN","PSANDF",27,0)
 ;
"RTN","PSANDF",28,0)
MANY ;Display for selection if more than 1 drug is found for the Product Name
"RTN","PSANDF",29,0)
 W !!,"The NDC has the VA Product Name of "_PSAVAPN_".",!,"The following drugs have the same VA Product Name.",!
"RTN","PSANDF",30,0)
 S (PSACNT,PSAGET,PSAIEN50)=0 F  S PSAIEN50=+$O(^TMP("PSANDF",$J,PSAIEN50)) Q:'PSAIEN50  D  Q:PSAGET!(+$G(PSAIEN))
"RTN","PSANDF",31,0)
 .S PSACNT=PSACNT+1,^TMP("PSACNT",$J,PSACNT)=PSAIEN50
"RTN","PSANDF",32,0)
 .W !?2,PSACNT_". "_^TMP("PSANDF",$J,PSAIEN50)
"RTN","PSANDF",33,0)
 .I PSACNT#5=0 D  Q:PSAGET!($G(PSAIEN))
"RTN","PSANDF",34,0)
 ..W ! S DIR(0)="N^1:"_PSACNT,DIR("A",1)="Select the received drug or",DIR("A")="enter ""^"" to select the drug from the DRUG file.",DIR("?",1)="Choose the drug you received and assign it to the line item."
"RTN","PSANDF",35,0)
 ..S DIR("?")="To exit the list and select the drug from the DRUG file, enter ""^"".",DIR("??")="^D SELNDF^PSANDF1" D ^DIR K DIR I $G(DUOUT) S PSAGET=1 Q
"RTN","PSANDF",36,0)
 ..I $G(DTOUT) S PSAOUT=1 Q
"RTN","PSANDF",37,0)
 ..I +Y S PSAIEN=^TMP("PSACNT",$J,+Y),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)=PSAIEN,$P(^(PSALINE),"^",16)=DUZ,$P(^(PSALINE),"^",17)=DT
"RTN","PSANDF",38,0)
 I '$G(PSAIEN),'PSAOUT,PSACNT#5'=0 D  G:Y="^" ASKDRUG Q:PSAOUT!($G(PSAIEN))
"RTN","PSANDF",39,0)
 .W ! S DIR(0)="N^1:"_PSACNT,DIR("A",1)="Select the received drug or",DIR("A")="enter ""^"" to select the drug from the DRUG file."
"RTN","PSANDF",40,0)
 .S DIR("?")="Select the drug you received or enter ""^""  to select the drug from the DRUG file.",DIR("??")="^D SELNDF^PSANDF1" D ^DIR K DIR Q:Y="^"
"RTN","PSANDF",41,0)
 .I $G(DTOUT) S PSAOUT=1 Q
"RTN","PSANDF",42,0)
 .S PSAIEN=^TMP("PSACNT",$J,+Y),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)=PSAIEN,$P(^(PSALINE),"^",16)=DUZ,$P(^(PSALINE),"^",17)=DT,PSADATA=^(PSALINE) D EDITDISP^PSAUTL1
"RTN","PSANDF",43,0)
 K ^TMP("PSACNT",$J,PSACNT),^TMP("PSANDF",$J)
"RTN","PSANDF",44,0)
 Q:+$G(PSAIEN)!(PSAOUT)
"RTN","PSANDF",45,0)
 I +$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4),"~",2),$P($P(^(PSALINE),"^",4),"~",3)'="" G ^PSAPROC4
"RTN","PSANDF",46,0)
 ;
"RTN","PSANDF",47,0)
ASKDRUG ;If the NDC found by searching NDF is not correct OR if the NDC can't
"RTN","PSANDF",48,0)
 ;be found, the user is asked to select the drug.
"RTN","PSANDF",49,0)
 W !!,"If the item will never be in the DRUG, press the Return key then",!,"answer YES to the ""Is this a supply item?"" prompt. To bypass this",!,"line item, enter ""^"" then press the Return key.",!
"RTN","PSANDF",50,0)
 S (PSASKIP,PSAPASS)=0,DIC("A")="Select Drug: ",DIC(0)="AEMZQ",DIC="^PSDRUG("
"RTN","PSANDF",51,0)
 D ^DIC K DIC I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSANDF",52,0)
 S PSAREA=""
"RTN","PSANDF",53,0)
 I +Y=-1 D  Q:PSASUPP  Q:PSASKIP
"RTN","PSANDF",54,0)
 .D SUPPLY Q:PSAOUT
"RTN","PSANDF",55,0)
 .I 'PSASUPP S PSASKIP=1 Q
"RTN","PSANDF",56,0)
 .S PSAIEN=0,^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")=DUZ_"^"_DT_"^"_PSAREA,$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="P",PSADATA=^(PSALINE)
"RTN","PSANDF",57,0)
 S PSAIEN=+Y K ^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")
"RTN","PSANDF",58,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)=+Y,$P(^(PSALINE),"^",16)=DUZ,$P(^(PSALINE),"^",17)=DT,PSADATA=^(PSALINE)
"RTN","PSANDF",59,0)
 D EDITDISP^PSAUTL1
"RTN","PSANDF",60,0)
 ;
"RTN","PSANDF",61,0)
CHECK I $G(PSANDC)'="" D  Q
"RTN","PSANDF",62,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC,PSAFND=0
"RTN","PSANDF",63,0)
 .S PSASUB=0 F  S PSASUB=+$O(^PSDRUG(PSAIEN,1,PSASUB)) Q:'PSASUB  I $P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^")=PSANDC S PSAFND=1 Q
"RTN","PSANDF",64,0)
 .I PSAFND S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",7)=PSASUB
"RTN","PSANDF",65,0)
 ;
"RTN","PSANDF",66,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",7)="0~1"
"RTN","PSANDF",67,0)
 I $P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4),"~")="",$P($P(^(PSALINE),"^",26),"~")="" D
"RTN","PSANDF",68,0)
 .W !,"The vendor did not send a NDC or UPC for the drug. Enter the",!,"NDC if it is available. Enter the UPC if you do not know the NDC.",!
"RTN","PSANDF",69,0)
 .S DIR(0)="SA^N:NDC;U:UPC",DIR("A")="Will you enter the NDC or UPC? ",DIR("B")="N",DIR("??")="^D NDCUPC^PSANDF1" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSANDF",70,0)
 .I Y="N" D GETNDC Q:PSAOUT  S PSANDC=Y,$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC
"RTN","PSANDF",71,0)
 .I Y="U" D GETUPC Q:PSAOUT  S PSANDC="S"_Y,PSAUPC=Y,$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=PSANDC,$P(^(PSALINE),"^",26)=PSAUPC
"RTN","PSANDF",72,0)
 Q
"RTN","PSANDF",73,0)
 ;
"RTN","PSANDF",74,0)
ONE ;Display for selection if 1 drug is found for that Product Name.
"RTN","PSANDF",75,0)
 S PSAIEN50=$O(^TMP("PSANDF",$J,0))
"RTN","PSANDF",76,0)
 W !!,"The NDC has the VA Product Name of "_PSAVAPN_"."
"RTN","PSANDF",77,0)
 S DIR("A")="Is "_^TMP("PSANDF",$J,PSAIEN50)_" the drug you received",DIR(0)="Y",DIR("B")="N"
"RTN","PSANDF",78,0)
 S DIR("?",1)="Enter Yes if the drug is the one you received for this line item.",DIR("?")="Enter No if it is not the drug you received.",DIR("??")="^D NDFDRG^PSANDF1"
"RTN","PSANDF",79,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSANDF",80,0)
 I +Y S PSAIEN=+PSAIEN50,$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)=PSAIEN,$P(^(PSALINE),"^",16)=DUZ,$P(^(PSALINE),"^",17)=DT K ^TMP("PSANDF",$J) D EDITDISP^PSAUTL1 Q
"RTN","PSANDF",81,0)
 D ASKDRUG
"RTN","PSANDF",82,0)
 Q
"RTN","PSANDF",83,0)
 ;
"RTN","PSANDF",84,0)
GETNDC ;Gets NDC for selected drug.
"RTN","PSANDF",85,0)
 S DIR(0)="F^12:12",DIR("A")="NDC",DIR("?")="Enter the 12-digit National Drug Code. Do not enter dashes",DIR("??")="^D NDC^PSANDF1"
"RTN","PSANDF",86,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSANDF",87,0)
 I Y'?12N W !,"You must enter exactly twelve numbers." G GETNDC
"RTN","PSANDF",88,0)
 Q
"RTN","PSANDF",89,0)
GETUPC ;Gets UPC for selected drug.
"RTN","PSANDF",90,0)
 S DIR(0)="F^1:30",DIR("A")="UPC",DIR("?")="Enter the Universal Product Code",DIR("??")="^D UPC^PSANDF1"
"RTN","PSANDF",91,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSANDF",92,0)
 Q
"RTN","PSANDF",93,0)
SUPPLY ;Asks if item is a supply. If so, asks for supply info.
"RTN","PSANDF",94,0)
 S DIR(0)="Y",DIR("A")="Is this a supply item",DIR("?")="Enter YES if the item is not and will never be in the DRUG file",DIR("??")="^D SUP^PSANDF1" D ^DIR K DIR S PSASUPP=Y Q:$G(DIRUT)
"RTN","PSANDF",95,0)
 I 'PSASUPP S PSAPASS=1 Q
"RTN","PSANDF",96,0)
 W ! S DIR(0)="F^3:30",DIR("A",1)="Enter either a description of the item or",DIR("A")="the reason why the item is not in the DRUG file"
"RTN","PSANDF",97,0)
 S DIR("?",1)="If the item is a supply, enter the name of the supply",DIR("?")="or a reason why this item is not in the DRUG file.",DIR("??")="^D REA^PSANDF1" D ^DIR K DIR S PSAREA=Y I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1
"RTN","PSANDF",98,0)
 S:PSAREA="" PSAREA="SUPPLY ITEM"
"RTN","PSANDF",99,0)
 Q:$G(PSAVER)
"RTN","PSANDF",100,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",15)="",$P(^(PSALINE),"^",16)="",$P(^(PSALINE),"^",17)=""
"RTN","PSANDF",101,0)
 Q
"RTN","PSATI")
0^4^B27466544
"RTN","PSATI",1,0)
PSATI ;BIR/LTL-Single Drug Match ;7/23/97
"RTN","PSATI",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**8**; 10/24/97
"RTN","PSATI",3,0)
 ;This routine enters/edits links with the ITEM MASTER file.
"RTN","PSATI",4,0)
 ;
"RTN","PSATI",5,0)
 N PSAIT,DTOUT,DUOUT,DIE,D0,D1,DA,DIC,DIR,DLAYGO,DR,DIRUT
"RTN","PSATI",6,0)
START D DT^DICRW
"RTN","PSATI",7,0)
 ;For call by ^PSAENT & ^PSAUNL 
"RTN","PSATI",8,0)
 I $G(PSAIT) S DIC(0)="Q",X=PSAIT W !!,$P($G(^PSDRUG(+PSAIT,0)),U),!!
"RTN","PSATI",9,0)
 ;LOOK UP DRUG
"RTN","PSATI",10,0)
LOOK S:'$D(DIC(0)) DIC(0)="AEMQ" S DIC=50,DIC("S")="I $S('$D(^(""I"")):1,+^(""I"")>DT:1,1:0)" D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<0) QUIT S (PSADRUG,PSAIT)=$P(Y,U)
"RTN","PSATI",11,0)
DIS I $O(^PSDRUG(+PSADRUG,441,0)) W !,"This drug is currently linked to the following item(s):",!!  S PSAIM=0 F  S PSAIM=$O(^PSDRUG(PSADRUG,441,PSAIM)) Q:PSAIM="B"  S PSAI=$P(^PSDRUG(PSADRUG,441,PSAIM,0),U) D:$$DESCR^PRCPUX1(0,PSAI)]""
"RTN","PSATI",12,0)
 .W !,PSAI_"  "_$$DESCR^PRCPUX1(0,PSAI)_"  ",$$VENNAME^PRCPUX1($P($G(^PRC(441,+PSAI,0)),U,4)_"PRC(440"),!
"RTN","PSATI",13,0)
QUES1 I $D(PSAI) S DIR(0)="Y",DIR("A")="Would you like to alter the link(s)",DIR("B")="No" D ^DIR K DIR G:Y<1&('$D(PSALOC)) AGAIN G:Y<1 QUIT
"RTN","PSATI",14,0)
 W !!,"Current potential ITEM MASTER file links based on NDC or FSN are:",!!
"RTN","PSATI",15,0)
 ;Attempt match by NDC between #50/#441
"RTN","PSATI",16,0)
NDC I $P($G(^PSDRUG(PSADRUG,2)),U,4)]"" S PSANDC=$P(^(2),U,4),PSAI=$$ITEM^PSAUTL(PSANDC) W "DRUG file NDC:  "_PSANDC
"RTN","PSATI",17,0)
 I $D(PSAI),$D(PSANDC),PSAI W ?40,"ITEM NUMBER:  "_PSAI,!!,"DESC:  "_$$DESCR^PRCPUX1(0,PSAI),! W:$G(^PRC(441,+PSAI,3)) !?60,"* Inactive item" D:$O(^PRC(441,"F",PSANDC,PSAI))
"RTN","PSATI",18,0)
MORE .S PSAZ=1,PSAI(PSAZ)=PSAI F  S PSAI(PSAZ)=$O(^PRC(441,"F",PSANDC,PSAI(PSAZ))) Q:PSAI(PSAZ)=""  W !?40,"ITEM NUMBER:  "_PSAI(PSAZ),!!,"DESC:  ",$$DESCR^PRCPUX1(0,PSAI(PSAZ)) W:$G(^PRC(441,+PSAI(PSAZ),3)) !?60,"* Inactive item"
"RTN","PSATI",19,0)
 ;Attempt match between FSN (#50) and NSN (#441)
"RTN","PSATI",20,0)
FSN I '$G(PSAI),$P(^PSDRUG(PSADRUG,0),U,6)]"" S PSAFSN=$P(^(0),U,6) D:$D(^PRC(441,"BB",PSAFSN))
"RTN","PSATI",21,0)
 .S PSAI=$O(^PRC(441,"BB",PSAFSN,"")) W "  NO NDC MATCH IN ITEM MASTER file.",!!,"DRUG file FSN:  "_PSAFSN,?40,"ITEM NUMBER:  "_PSAI,!!,"DESC:  ",$$DESCR^PRCPUX1(0,PSAI),!
"RTN","PSATI",22,0)
FAIL S:'$D(PSAI) PSAI="" W:PSAI']"" !!,"No NDC or FSN match in the ITEM MASTER file.",!
"RTN","PSATI",23,0)
 S:'$D(^PSDRUG(+PSADRUG,441,0)) ^(0)="^50.0441P^^"
"RTN","PSATI",24,0)
CON S DIE="^PSDRUG(",DA=PSADRUG,DR="441//^S X=$G(PSAI)" D ^DIE K DIE I $D(Y)!($D(DTOUT)) S DIRUT=1 G QUIT
"RTN","PSATI",25,0)
 I '$D(^PSDRUG(PSADRUG,"ND")) W !!,"No NDF link, can't help.",!  G AGAIN
"RTN","PSATI",26,0)
 I $P(^PSDRUG(PSADRUG,"ND"),U)']"" W !!,"No NDF link, can't help.",!  K DUOUT G AGAIN
"RTN","PSATI",27,0)
 ;Check for package size or type = OTHER
"RTN","PSATI",28,0)
 I $P($G(^PSDRUG(+PSADRUG,"ND")),U,4)=2058 W !!,"No matching PACKAGE SIZE in the National Drug File." G AGAIN
"RTN","PSATI",29,0)
 I $P($G(^PSDRUG(+PSADRUG,"ND")),U,5)=623 W !!,"No matching PACKAGE TYPE in the National Drug file." G AGAIN
"RTN","PSATI",30,0)
NDF ;Offer NDF path
"RTN","PSATI",31,0)
 W !!,"This drug is linked to the NATIONAL DRUG file.",!!,"There may be an NDC there that will link to the ITEM MASTER file.",!
"RTN","PSATI",32,0)
 S DIR(0)="Y",DIR("A")="Would you like to check",DIR("B")="No" D ^DIR K DIR G:$D(DIRUT)!(Y<1) AGAIN
"RTN","PSATI",33,0)
 S PSANDF=$P(^PSDRUG(PSADRUG,"ND"),U),PSAV=$P(^("ND"),U,3),PSAP=$P(^("ND"),U,4),PSAT=$P(^("ND"),U,5)
"RTN","PSATI",34,0)
 ;
"RTN","PSATI",35,0)
 ;DAVE B (PSA*3*8)
"RTN","PSATI",36,0)
 S PSADATA=$$PROD0^PSNAPIS(PSANDF,PSAV)
"RTN","PSATI",37,0)
 S PSADO=$P($G(PSADATA),"^",2)
"RTN","PSATI",38,0)
 S PSAS=$P($G(PSADATA),"^",3)
"RTN","PSATI",39,0)
 S PSAU=$P($G(PSADATA),"^",4)
"RTN","PSATI",40,0)
 S PSAPB=$O(^PSNDF(PSANDF,2,PSADO,3,PSAS,4,PSAU,5,"B",PSAP,""))
"RTN","PSATI",41,0)
 ;
"RTN","PSATI",42,0)
 S PSATB=$O(^PSNDF(+PSANDF,2,+PSADO,3,+PSAS,4,+PSAU,5,+PSAPB,6,"B",PSAT,"")),PSA=0,PSAB="",Y=1
"RTN","PSATI",43,0)
 I PSATB+PSAPB<2 W !!,"Not enough INFO, can't find NDC, sorry.",! G AGAIN
"RTN","PSATI",44,0)
 W:$P(^PSNDF(PSANDF,2,PSADO,3,PSAS,4,PSAU,5,PSAPB,6,PSATB,7,0),U,4)>1 !,"There are "_$P(^(0),U,4)_" NDCs for this drug.",!! W:$P(^(0),U,4)=1 !,"There is one NDC for this drug",!!
"RTN","PSATI",45,0)
 F  S PSA=$O(^PSNDF(PSANDF,2,PSADO,3,PSAS,4,PSAU,5,PSAPB,6,PSATB,7,PSA)) Q:PSA=""  D  Q:Y<1  D FIND
"RTN","PSATI",46,0)
 .W !,"Going to check NDC #"_PSA,! S DIR(0)="Y",DIR("A")="OK",DIR("B")="No" D ^DIR K DIR Q:$D(DIRUT)!(Y<1)
"RTN","PSATI",47,0)
AGAIN K PSA,PSAB,PSAD,PSADO,PSADRUG,PSAF,PSAFSN,PSANDC,PSANDF,PSAI,PSAIM,PSAIQ,PSAIQT,PSAIAC,PSAILC,PSAINV,PSAINVN,PSAP,PSAPB,PSAS,PSAT,PSATB,PSAU,PSAV,PSAZ,X,Y
"RTN","PSATI",48,0)
 Q:$D(PSAS)!($D(PSALOC))  W ! S DIR(0)="Y",DIR("A")="Another drug",DIR("B")="Yes" D ^DIR K DIR I Y>0 K PSAIT,PSAI G START
"RTN","PSATI",49,0)
QUIT N:'$G(PSAIT(1)) PSAIT,Y K PSA,PSAB,PSAI,PSAD,PSADO,PSADRUG,PSAF,PSAFSN,PSANDC,PSANDF,PSAI,PSAIM,PSAIQ,PSAIQT,PSAIAC,PSAILC,PSAINV,PSAINVN,PSAP,PSAPB,PSAS,PSAT,PSATB,PSAU,PSAV,PSAZ,X,Y Q
"RTN","PSATI",50,0)
BINGO S PSAI=$O(^PRC(441,"F",PSAB,""))
"RTN","PSATI",51,0)
 Q:$O(^PSDRUG("AB",+PSAI,0))
"RTN","PSATI",52,0)
 W !!,"DRUG file:  "_$P(^PSDRUG(PSADRUG,0),U),!!,"Item #:  "_PSAI,"  Desc:  ",$$DESCR^PRCPUX1(0,PSAI),! D
"RTN","PSATI",53,0)
 .S DIR(0)="Y",DIR("A")="OK to link",DIR("B")="Yes",DIR("?")="If yes, I'll perform the link" D ^DIR K DIR K:(Y=0) Y Q:($G(Y)<1)
"RTN","PSATI",54,0)
 .S DIE=50,DA=PSADRUG,DR="441///^S X=""`""_PSAI" D ^DIE W " linked."
"RTN","PSATI",55,0)
 Q
"RTN","PSATI",56,0)
FIND K Y F PSAI=1:1 S PSAB=$O(^PRC(441,"F",PSAB)) W:PSAI#10=0 "." Q:PSAB=""  D:$G(^PSNDF(PSANDF,2,PSADO,3,PSAS,4,PSAU,5,PSAPB,6,PSATB,7,PSA,0))[$TR(PSAB,"-","") BINGO Q:$D(Y)
"RTN","PSATI",57,0)
 Q
"VER")
8.0^21.0
**END**
**END**
