Released PSD*3*45 SEQ #40
Extracted from mail message
**KIDS**:PSD*3.0*45^

**INSTALL NAME**
PSD*3.0*45
"BLD",5016,0)
PSD*3.0*45^CONTROLLED SUBSTANCES^0^3040803^y
"BLD",5016,1,0)
^^2^2^3040803^
"BLD",5016,1,1,0)
Mult Posting of Partials, Changes in two routines to reflect the usage of 
"BLD",5016,1,2,0)
DBIA 2621
"BLD",5016,4,0)
^9.64PA^^
"BLD",5016,"ABPKG")
n
"BLD",5016,"KRN",0)
^9.67PA^8989.52^19
"BLD",5016,"KRN",.4,0)
.4
"BLD",5016,"KRN",.401,0)
.401
"BLD",5016,"KRN",.402,0)
.402
"BLD",5016,"KRN",.403,0)
.403
"BLD",5016,"KRN",.5,0)
.5
"BLD",5016,"KRN",.84,0)
.84
"BLD",5016,"KRN",3.6,0)
3.6
"BLD",5016,"KRN",3.8,0)
3.8
"BLD",5016,"KRN",9.2,0)
9.2
"BLD",5016,"KRN",9.8,0)
9.8
"BLD",5016,"KRN",9.8,"NM",0)
^9.68A^4^3
"BLD",5016,"KRN",9.8,"NM",2,0)
PSDDSOR^^0^B74602772
"BLD",5016,"KRN",9.8,"NM",3,0)
PSDDSOR2^^0^B21366672
"BLD",5016,"KRN",9.8,"NM",4,0)
PSDOPT0^^0^B71140055
"BLD",5016,"KRN",9.8,"NM","B","PSDDSOR",2)

"BLD",5016,"KRN",9.8,"NM","B","PSDDSOR2",3)

"BLD",5016,"KRN",9.8,"NM","B","PSDOPT0",4)

"BLD",5016,"KRN",19,0)
19
"BLD",5016,"KRN",19.1,0)
19.1
"BLD",5016,"KRN",101,0)
101
"BLD",5016,"KRN",409.61,0)
409.61
"BLD",5016,"KRN",771,0)
771
"BLD",5016,"KRN",870,0)
870
"BLD",5016,"KRN",8989.51,0)
8989.51
"BLD",5016,"KRN",8989.52,0)
8989.52
"BLD",5016,"KRN",8994,0)
8994
"BLD",5016,"KRN","B",.4,.4)

"BLD",5016,"KRN","B",.401,.401)

"BLD",5016,"KRN","B",.402,.402)

"BLD",5016,"KRN","B",.403,.403)

"BLD",5016,"KRN","B",.5,.5)

"BLD",5016,"KRN","B",.84,.84)

"BLD",5016,"KRN","B",3.6,3.6)

"BLD",5016,"KRN","B",3.8,3.8)

"BLD",5016,"KRN","B",9.2,9.2)

"BLD",5016,"KRN","B",9.8,9.8)

"BLD",5016,"KRN","B",19,19)

"BLD",5016,"KRN","B",19.1,19.1)

"BLD",5016,"KRN","B",101,101)

"BLD",5016,"KRN","B",409.61,409.61)

"BLD",5016,"KRN","B",771,771)

"BLD",5016,"KRN","B",870,870)

"BLD",5016,"KRN","B",8989.51,8989.51)

"BLD",5016,"KRN","B",8989.52,8989.52)

"BLD",5016,"KRN","B",8994,8994)

"BLD",5016,"PRE")
PSDP345
"BLD",5016,"QUES",0)
^9.62^^
"BLD",5016,"REQB",0)
^9.611^2^2
"BLD",5016,"REQB",1,0)
PSD*3.0*39^1
"BLD",5016,"REQB",2,0)
PSD*3.0*42^1
"BLD",5016,"REQB","B","PSD*3.0*39",1)

"BLD",5016,"REQB","B","PSD*3.0*42",2)

"MBREQ")
0
"PKG",113,-1)
1^1
"PKG",113,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",113,20,0)
^9.402P^^
"PKG",113,22,0)
^9.49I^1^1
"PKG",113,22,1,0)
3.0^2970213^2970403^24
"PKG",113,22,1,"PAH",1,0)
45^3040803
"PKG",113,22,1,"PAH",1,1,0)
^^2^2^3040803
"PKG",113,22,1,"PAH",1,1,1,0)
Mult Posting of Partials, Changes in two routines to reflect the usage of 
"PKG",113,22,1,"PAH",1,1,2,0)
DBIA 2621
"PRE")
PSDP345
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSDDSOR")
0^2^B74602772
"RTN","PSDDSOR",1,0)
PSDDSOR ;BHM/MHA - Digitally signed CS Orders Report; 08/30/02
"RTN","PSDDSOR",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**40,42,45**;13 Feb 97
"RTN","PSDDSOR",3,0)
 ;Ref. to ^PSRX( supp. by IA 1977
"RTN","PSDDSOR",4,0)
 ;Ref. to ^PS(52.41, supp. by IA 3848
"RTN","PSDDSOR",5,0)
 ;Ref. to ^PS(59, supp. by IA 2621
"RTN","PSDDSOR",6,0)
 ;Ref. ^PSDRUG( supp. by IA 2621
"RTN","PSDDSOR",7,0)
 ;Ref. to GETDATA^ORWOR1 supp. by IA 3750
"RTN","PSDDSOR",8,0)
 ;
"RTN","PSDDSOR",9,0)
 N AC,BDT,CT,DFN,DP,DRG,DRUG,DV,DVN,EDT,FI,NS,OP,ORD,ORS,PAT,PG,POS,PL,PL1,PRO,PROV
"RTN","PSDDSOR",10,0)
 N PSDBD,PSDDF,PSDDV,PSDED,PSDIO,PSDPO,PSDPR,PSDPT,PSDRG,PSDSC,PSDSD
"RTN","PSDDSOR",11,0)
 N PSDXF,RX,RX0,RX2,S1,S2,S3,S4,S5,S6,SCH,SR,SRT,TDT,TY,I,J,O,X,Y,Z
"RTN","PSDDSOR",12,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDDSOR",13,0)
SITE I '$D(PSOSITE) D  Q:$D(DUOUT)!($D(DTOUT))  G:'$D(PSOSITE) SITE
"RTN","PSDDSOR",14,0)
 .W ! S DIC("A")="Division: ",DIC=59,DIC(0)="AEMQ"
"RTN","PSDDSOR",15,0)
 .S DIC("S")="I $S('$D(^PS(59,+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0)"
"RTN","PSDDSOR",16,0)
 .D ^DIC K DIC Q:$D(DUOUT)!($D(DTOUT))  I +Y>0 S PSOSITE=+Y Q
"RTN","PSDDSOR",17,0)
 .W !!,"A 'DIVISION' must be selected!  or Enter '^' to exit."
"RTN","PSDDSOR",18,0)
 S PSDDV=PSOSITE
"RTN","PSDDSOR",19,0)
 W !!?10,"You are logged on under the ",$P(^PS(59,PSDDV,0),"^")," division.",!
"RTN","PSDDSOR",20,0)
DATE ;ask date range
"RTN","PSDDSOR",21,0)
 W ! K %DT S %DT(0)=-DT,%DT="AEP",%DT("A")="Start Date: " D ^%DT
"RTN","PSDDSOR",22,0)
 I Y<0!($D(DTOUT)) G END
"RTN","PSDDSOR",23,0)
 S (%DT(0),PSDBD)=Y,%DT("A")="End Date: "
"RTN","PSDDSOR",24,0)
 W ! D ^%DT I Y<0!($D(DTOUT)) G END
"RTN","PSDDSOR",25,0)
 S PSDED=Y,PSDSD=PSDBD-.000001
"RTN","PSDDSOR",26,0)
 W ! D KV S DIR("A")="Include discontinued orders",DIR(0)="Y",DIR("B")="NO"
"RTN","PSDDSOR",27,0)
 D ^DIR K DIR G:$D(DIRUT) END S PSDDF=Y
"RTN","PSDDSOR",28,0)
 W ! S DIR("A")="Include expired orders",DIR(0)="Y",DIR("B")="NO" D ^DIR
"RTN","PSDDSOR",29,0)
 K DIR G:$D(DIRUT) END S PSDXF=Y
"RTN","PSDDSOR",30,0)
 W ! S DIR("A")="Include pending orders",DIR(0)="Y",DIR("B")="NO" D ^DIR
"RTN","PSDDSOR",31,0)
 K DIR G:$D(DIRUT) END S PSDPO=Y
"RTN","PSDDSOR",32,0)
SL S (CT,PSDRG,PSDPR,PSDPT,PSDSC)=1,DP="Within ",DIR("B")="Drug" K SRT,SR
"RTN","PSDDSOR",33,0)
 S OP="D:Drug;PR:Provider;PA:Patient;S:Schedule"
"RTN","PSDDSOR",34,0)
 F  D KV S DIR(0)="SAO^"_OP D  Q:OP=""!($D(DUOUT))!($D(DTOUT))!($D(DIRUT))
"RTN","PSDDSOR",35,0)
 .S:CT=1 DIR("B")="Drug" K:CT>1 DIR("B")
"RTN","PSDDSOR",36,0)
 .S DIR("A")=$S(CT>1:DP,1:"")_"Sort By: " D ^DIR
"RTN","PSDDSOR",37,0)
 .Q:$D(DIRUT)
"RTN","PSDDSOR",38,0)
 .S O="" F I=1:1:$L(OP,";") S J=$P(OP,";",I) I J'[Y(0) S O=O_$S(O="":"",1:";")_J
"RTN","PSDDSOR",39,0)
 .S OP=O
"RTN","PSDDSOR",40,0)
 .S SRT(CT)=Y,SR(Y)=CT S CT=CT+1,DP=DP_$S(Y="D":"Drug, ",Y="PR":"Provider, ",Y="PA":"Patient, ",1:"Schedule, ")
"RTN","PSDDSOR",41,0)
 .D @Y
"RTN","PSDDSOR",42,0)
 G:$D(DUOUT)!($D(DTOUT)) END
"RTN","PSDDSOR",43,0)
 I $D(SRT) K SR S I="" D  G:$D(DIRUT) END G:'Y SL
"RTN","PSDDSOR",44,0)
 .W !!,"You have selected the following:",!
"RTN","PSDDSOR",45,0)
 .F  S I=$O(SRT(I)) Q:I=""  D
"RTN","PSDDSOR",46,0)
 ..S J=SRT(I),SR(I)=$S(J="D":"DRUG",J="PR":"PROV",J="PA":"PAT",1:"SCH")
"RTN","PSDDSOR",47,0)
 ..W !?5,$S(J="D":"Drug",J="PR":"Provider",J="PA":"Patient",1:"Schedule")
"RTN","PSDDSOR",48,0)
 .W ! D KV S DIR("A")="Continue to print:",DIR("B")="Y",DIR(0)="YN" D ^DIR
"RTN","PSDDSOR",49,0)
 G DEV Q
"RTN","PSDDSOR",50,0)
D ;ask drug(s)
"RTN","PSDDSOR",51,0)
 W !!,?5,"You may select a single drug, several drugs,",!,?5,"or enter ^ALL to select all drugs.",!!
"RTN","PSDDSOR",52,0)
 K DRG,DIC S PSDRG=0,DIC("A")="Select DRUG: ",DIC=50,DIC(0)="QEAM"
"RTN","PSDDSOR",53,0)
 S DIC("S")="I $S('$D(^(""I"")):1,'^(""I""):1,DT'>+^(""I""):1,1:0),$P($G(^(2)),""^"",3)[""O"",$D(^PSDRUG(""ASP"",+$G(^(2)),+Y)),+$P(^PSDRUG(+Y,0),""^"",3)&(+$P(^PSDRUG(+Y,0),""^"",3)<6)"
"RTN","PSDDSOR",54,0)
 F  D ^DIC Q:Y<0  S DRG(+Y)=""
"RTN","PSDDSOR",55,0)
 K DIC I X="^ALL" S PSDRG=1 K DUOUT Q
"RTN","PSDDSOR",56,0)
 Q:($D(DUOUT))!($D(DTOUT))
"RTN","PSDDSOR",57,0)
 I '$D(DRG)&(Y<0) G D
"RTN","PSDDSOR",58,0)
 Q
"RTN","PSDDSOR",59,0)
PR ;ask provider(s)
"RTN","PSDDSOR",60,0)
 W !!,?5,"You may select a single provider, several providers,",!,?5,"or enter ^ALL to select all providers.",!!
"RTN","PSDDSOR",61,0)
 K PRO,DIC S PSDPR=0,DIC="^VA(200,",DIC(0)="QEAM",DIC("A")="Select Provider: "
"RTN","PSDDSOR",62,0)
 F  D ^DIC Q:Y<0  S PRO(+Y)=""
"RTN","PSDDSOR",63,0)
 K DIC I X="^ALL" S PSDPR=1 K DUOUT Q
"RTN","PSDDSOR",64,0)
 Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSDDSOR",65,0)
 I '$D(PRO)&(Y<0) G PR
"RTN","PSDDSOR",66,0)
 Q
"RTN","PSDDSOR",67,0)
PA ;ask provider(s)
"RTN","PSDDSOR",68,0)
 W !!,?5,"You may select a single patient, several patients,",!,?5,"or enter ^ALL to select all patients.",!!
"RTN","PSDDSOR",69,0)
 K PAT,DIC S PSDPT=0,DIC=2,DIC(0)="QEAM",DIC("A")="Select Patient: "
"RTN","PSDDSOR",70,0)
 F  D ^DIC Q:Y<0  S PAT(+Y)=""
"RTN","PSDDSOR",71,0)
 K DIC I X="^ALL" S PSDPT=1 K DUOUT Q
"RTN","PSDDSOR",72,0)
 Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSDDSOR",73,0)
 I '$D(PAT)&(Y<0) G PA
"RTN","PSDDSOR",74,0)
 Q
"RTN","PSDDSOR",75,0)
S ;
"RTN","PSDDSOR",76,0)
 W !! K SCH,PSDSC D KV S DIR("A")="Include All CS Schedules: ",DIR("B")="Y",DIR(0)="YN" D ^DIR
"RTN","PSDDSOR",77,0)
 Q:$D(DIRUT)
"RTN","PSDDSOR",78,0)
 I Y S PSDSC=1 Q
"RTN","PSDDSOR",79,0)
 F I=1:1:7 W !,?5,$S(I=1:"1 - SCHEDULE I",I=2:"2 - SCHEDULE II",I=3:"3 - SCHEDULE II NON-NARCOTICS",I=4:"4 - SCHEDULE III",I=5:"5 - SCHEDULE III NON-NARCOTICS",I=6:"6 - SCHEDULE IV NARCOTICS",1:"7 - SCHEDULE V NARCOTICS")
"RTN","PSDDSOR",80,0)
 W ! D KV
"RTN","PSDDSOR",81,0)
 S DIR(0)="L^1:7" D ^DIR Q:$D(DIRUT)
"RTN","PSDDSOR",82,0)
 I Y,$L(Y,",")-1=1 S Y=+Y,SCH($S(Y<3:Y,Y=3:"2n",Y=4:3,Y=5:"3n",1:Y-2))="" Q
"RTN","PSDDSOR",83,0)
 F I=1:1:$L(Y,",")-1 S J=+$P(Y,",",I) S SCH($S(J<3:J,J=3:"2n",J=4:3,J=5:"3n",1:J-2))=""
"RTN","PSDDSOR",84,0)
 Q
"RTN","PSDDSOR",85,0)
DEV K %ZIS,IOP,POP,ZTSK S PSDIO=ION,%ZIS="QM" D ^%ZIS K %ZIS
"RTN","PSDDSOR",86,0)
 I POP S IOP=PSDIO D ^%ZIS K IOP,PSDIO W !,"Please try later!" G END
"RTN","PSDDSOR",87,0)
 K PSDIO I $D(IO("Q")) K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK D  G END
"RTN","PSDDSOR",88,0)
 .S ZTRTN="EN^PSDDSOR",ZTDESC="Digitally Signed CS Orders Report"
"RTN","PSDDSOR",89,0)
 .F G="PSDDV","PSDSD","PSDBD","PSDED","PSDDF","PSDXF","PSDPO","PSDRG","PSDPR","PSDPT","PSDSC" S:$D(@G) ZTSAVE(G)=""
"RTN","PSDDSOR",90,0)
 .S ZTSAVE("SRT(")="",ZTSAVE("SR(")="" S:$D(PRO) ZTSAVE("PRO(")="" S:$D(DRG) ZTSAVE("DRG(")="" S:$D(PAT) ZTSAVE("PAT(")="" S:$D(SCH) ZTSAVE("SCH(")=""
"RTN","PSDDSOR",91,0)
 .D ^%ZTLOAD W:$D(ZTSK) !,"Report is Queued to print !!" K ZTSK
"RTN","PSDDSOR",92,0)
EN ;
"RTN","PSDDSOR",93,0)
 K ^TMP($J) S (I,NS)=0 F  S I=$O(SR(I)) Q:'I  S NS=I
"RTN","PSDDSOR",94,0)
 S PND=0,TY="APKI",POS=PSDSD F  S PSDSD=$O(^PSRX(TY,PSDSD)) Q:'PSDSD!(PSDSD>PSDED)  D EN1
"RTN","PSDDSOR",95,0)
 D:PSDPO EN2 D PSTR G END
"RTN","PSDDSOR",96,0)
 Q
"RTN","PSDDSOR",97,0)
EN1 S RX=0 F  S RX=$O(^PSRX(TY,PSDSD,RX)) Q:'RX  D
"RTN","PSDDSOR",98,0)
 .Q:'$D(^PSRX(RX,0))  Q:$P(^(2),"^",9)'=PSDDV  S RX0=^(0),ORD=$P($G(^("OR1")),"^",2)
"RTN","PSDDSOR",99,0)
 .Q:'$P(RX0,"^",2)!('$P(RX0,"^",4))!('$P(RX0,"^",6))!('ORD)
"RTN","PSDDSOR",100,0)
 .D GETD
"RTN","PSDDSOR",101,0)
 Q
"RTN","PSDDSOR",102,0)
EN2 S DV=0,FI=52.41,PND=1
"RTN","PSDDSOR",103,0)
 F  S POS=$O(^PS(FI,TY,POS)) Q:'POS!(POS>(PSDED_".999999"))  S DV=0 F  S DV=$O(^PS(FI,TY,POS,DV)) Q:'DV  D
"RTN","PSDDSOR",104,0)
 .S RX=0 F  S RX=$O(^PS(FI,TY,POS,DV,RX)) Q:'RX  D
"RTN","PSDDSOR",105,0)
 ..Q:'$D(^PS(FI,RX,0))  S RX0=^(0)
"RTN","PSDDSOR",106,0)
 ..I $P(RX0,"^",3)["NW"!($P(RX0,"^",3)="DC") I $P(RX0,"^",24) S ORD=$P(RX0,"^") D GETD
"RTN","PSDDSOR",107,0)
 Q
"RTN","PSDDSOR",108,0)
GETD ;
"RTN","PSDDSOR",109,0)
 I $G(PSDPT) G GETD1
"RTN","PSDDSOR",110,0)
 Q:'$D(PAT($P(RX0,"^",2)))
"RTN","PSDDSOR",111,0)
GETD1 ;
"RTN","PSDDSOR",112,0)
 D GETDATA^ORWOR1(.Y,ORD,$P(RX0,"^",2)) Q:Y<0  D:$G(PND)
"RTN","PSDDSOR",113,0)
 .S Y=Y_"^"_$P(RX0,"^",3)
"RTN","PSDDSOR",114,0)
 .I $P(RX0,"^",3)="DC",$G(^PS(52.41,RX,4))]"" D
"RTN","PSDDSOR",115,0)
 ..S Y=Y_"^"_$TR(^PS(52.41,RX,4),":",","),$P(Y,"^",4)="5;DISCONTINUED"
"RTN","PSDDSOR",116,0)
 D CONT
"RTN","PSDDSOR",117,0)
 Q
"RTN","PSDDSOR",118,0)
CONT ;
"RTN","PSDDSOR",119,0)
 S ORS=+$P(Y,"^",4) Q:'ORS!('PSDXF&(ORS=7))
"RTN","PSDDSOR",120,0)
 Q:'PSDDF&(",1,12,13,"[(","_ORS_","))
"RTN","PSDDSOR",121,0)
 S S1=$S(ORS=5:4,ORS=7:3,",1,12,13,"[(","_ORS_","):2,1:1)
"RTN","PSDDSOR",122,0)
 S PAT=$P($G(Y(1)),"^") Q:PAT=""
"RTN","PSDDSOR",123,0)
 S DRUG=$S($P($G(Y(2)),"^")]"":$P(Y(2),"^"),$P($G(Y(6)),"^")]"":$P(Y(6),"^"),1:"")
"RTN","PSDDSOR",124,0)
 G:$G(PSDRG) CT1
"RTN","PSDDSOR",125,0)
 Q:'$D(DRG($P(Y(2),"^",2)))
"RTN","PSDDSOR",126,0)
CT1 S PROV=$P($G(Y(4)),"^") Q:PROV=""
"RTN","PSDDSOR",127,0)
 G:$G(PSDPR) CT2
"RTN","PSDDSOR",128,0)
 Q:'$D(PRO($P(Y(4),"^",2)))
"RTN","PSDDSOR",129,0)
CT2 S SCH=$P($G(Y(2)),"^",5) Q:SCH=""
"RTN","PSDDSOR",130,0)
 G:$G(PSDSC) CT3
"RTN","PSDDSOR",131,0)
 Q:'$D(SCH($P(Y(2),"^",5)))
"RTN","PSDDSOR",132,0)
CT3 I NS=4 D  Q
"RTN","PSDDSOR",133,0)
 .S ^TMP($J,S1,@(SR(1)),@(SR(2)),@(SR(3)),@(SR(4)),RX,0)=Y,I=0
"RTN","PSDDSOR",134,0)
 .F  S I=$O(Y(I)) Q:'I  S ^TMP($J,S1,@(SR(1)),@(SR(2)),@(SR(3)),@(SR(4)),RX,I)=Y(I)
"RTN","PSDDSOR",135,0)
 I NS=3 D  Q
"RTN","PSDDSOR",136,0)
 .S ^TMP($J,S1,@(SR(1)),@(SR(2)),@(SR(3)),RX,0)=Y,I=0
"RTN","PSDDSOR",137,0)
 .F  S I=$O(Y(I)) Q:'I  S ^TMP($J,S1,@(SR(1)),@(SR(2)),@(SR(3)),RX,I)=Y(I)
"RTN","PSDDSOR",138,0)
 I NS=2 D  Q
"RTN","PSDDSOR",139,0)
 .S ^TMP($J,S1,@(SR(1)),@(SR(2)),RX,0)=Y,I=0
"RTN","PSDDSOR",140,0)
 .F  S I=$O(Y(I)) Q:'I  S ^TMP($J,S1,@(SR(1)),@(SR(2)),RX,I)=Y(I)
"RTN","PSDDSOR",141,0)
 S ^TMP($J,S1,@(SR(1)),RX,0)=Y,I=0
"RTN","PSDDSOR",142,0)
 F  S I=$O(Y(I)) Q:'I  S ^TMP($J,S1,@(SR(1)),RX,I)=Y(I)
"RTN","PSDDSOR",143,0)
 Q
"RTN","PSDDSOR",144,0)
 ;
"RTN","PSDDSOR",145,0)
PSTR D NOW^%DTC S TDT=$E(%,4,5)_"/"_$E(%,6,7)_"/"_$E(%,2,3)_"@"_$E(%,9,10)_":"_$E(%,11,12)
"RTN","PSDDSOR",146,0)
 N P1,P2 S $E(P1,42)="",$E(P2,12)="",PG=1,Y=PSDBD D D^DIQ S BDT=Y,Y=PSDED D D^DIQ S EDT=Y
"RTN","PSDDSOR",147,0)
 S DVN=$$GET1^DIQ(59,PSDDV,.01) S:DVN]"" DVN=$E(DVN,1,20) S:DVN="" DVN="N/A"
"RTN","PSDDSOR",148,0)
 U IO I '$D(^TMP($J)) D HD W !!,"**********    NO DATA TO PRINT   **********",!! Q
"RTN","PSDDSOR",149,0)
 D @("N"_NS)
"RTN","PSDDSOR",150,0)
 Q
"RTN","PSDDSOR",151,0)
IN K Y0,Y1,Y2,Y3,Y4,Y5,Y6 S S6=""
"RTN","PSDDSOR",152,0)
 Q
"RTN","PSDDSOR",153,0)
WR S PG=1 D HD W !,$S(AC=1:"Processed",AC=2:"Discontinued",AC=3:"Expired",1:"Pending")_" Orders:",! Q
"RTN","PSDDSOR",154,0)
N4 S AC="" F  S AC=$O(^TMP($J,AC)) Q:'AC  D WR D  Q:$D(DIRUT)  D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR",155,0)
 .S S1="" F  S S1=$O(^TMP($J,AC,S1)) Q:S1=""  S S2="" F  S S2=$O(^TMP($J,AC,S1,S2)) Q:S2=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",156,0)
 ..S S3="" F  S S3=$O(^TMP($J,AC,S1,S2,S3)) Q:S3=""  S S4="" F  S S4=$O(^TMP($J,AC,S1,S2,S3,S4)) Q:S4=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",157,0)
 ...S S5="" F  S S5=$O(^TMP($J,AC,S1,S2,S3,S4,S5)) Q:S5=""  D STR4 Q:$D(DIRUT)
"RTN","PSDDSOR",158,0)
 Q
"RTN","PSDDSOR",159,0)
STR4 ;
"RTN","PSDDSOR",160,0)
 D IN F  S S6=$O(^TMP($J,AC,S1,S2,S3,S4,S5,S6)) Q:S6=""  S Z="Y"_S6,@Z=^TMP($J,AC,S1,S2,S3,S4,S5,S6)
"RTN","PSDDSOR",161,0)
 D PRT Q
"RTN","PSDDSOR",162,0)
N3 S AC="" F  S AC=$O(^TMP($J,AC)) Q:'AC  D WR D  Q:$D(DIRUT)  D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR",163,0)
 .S S1="" F  S S1=$O(^TMP($J,AC,S1)) Q:S1=""  S S2="" F  S S2=$O(^TMP($J,AC,S1,S2)) Q:S2=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",164,0)
 ..S S3="" F  S S3=$O(^TMP($J,AC,S1,S2,S3)) Q:S3=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",165,0)
 ...S S5="" F  S S5=$O(^TMP($J,AC,S1,S2,S3,S5)) Q:S5=""  D STR3 Q:$D(DIRUT)
"RTN","PSDDSOR",166,0)
 Q
"RTN","PSDDSOR",167,0)
STR3 D IN F  S S6=$O(^TMP($J,AC,S1,S2,S3,S5,S6)) Q:S6=""  S Z="Y"_S6,@Z=^TMP($J,AC,S1,S2,S3,S5,S6)
"RTN","PSDDSOR",168,0)
 D PRT Q
"RTN","PSDDSOR",169,0)
N2 S AC="" F  S AC=$O(^TMP($J,AC)) Q:'AC  D WR D  Q:$D(DIRUT)  D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR",170,0)
 .S S1="" F  S S1=$O(^TMP($J,AC,S1)) Q:S1=""  S S2="" F  S S2=$O(^TMP($J,AC,S1,S2)) Q:S2=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",171,0)
 ..S S5="" F  S S5=$O(^TMP($J,AC,S1,S2,S5)) Q:S5=""  D STR2 Q:$D(DIRUT)
"RTN","PSDDSOR",172,0)
 Q
"RTN","PSDDSOR",173,0)
STR2 D IN F  S S6=$O(^TMP($J,AC,S1,S2,S5,S6)) Q:S6=""  S Z="Y"_S6,@Z=^TMP($J,AC,S1,S2,S5,S6)
"RTN","PSDDSOR",174,0)
 D PRT Q
"RTN","PSDDSOR",175,0)
N1 S AC="" F  S AC=$O(^TMP($J,AC)) Q:'AC  D WR D  Q:$D(DIRUT)  D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR",176,0)
 .S S1="" F  S S1=$O(^TMP($J,AC,S1)) Q:S1=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",177,0)
 ..S S5="" F  S S5=$O(^TMP($J,AC,S1,S5)) Q:S5=""  D STR1 Q:$D(DIRUT)
"RTN","PSDDSOR",178,0)
 Q
"RTN","PSDDSOR",179,0)
STR1 D IN F  S S6=$O(^TMP($J,AC,S1,S5,S6)) Q:S6=""  S Z="Y"_S6,@Z=^TMP($J,AC,S1,S5,S6)
"RTN","PSDDSOR",180,0)
 D PRT
"RTN","PSDDSOR",181,0)
 Q
"RTN","PSDDSOR",182,0)
PRT D:($Y+4)>IOSL HD Q:$D(DIRUT)  D PRT^PSDDSOR1
"RTN","PSDDSOR",183,0)
 Q
"RTN","PSDDSOR",184,0)
HD D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR",185,0)
 W @IOF,!?2,"Digitally Signed CS Orders Report for Division "_DVN,?70,"Page: ",PG
"RTN","PSDDSOR",186,0)
 W !,?8,"Date Range: "_BDT_" - "_EDT,?53,"Printed on: "_TDT,!
"RTN","PSDDSOR",187,0)
 S PG=PG+1
"RTN","PSDDSOR",188,0)
 Q
"RTN","PSDDSOR",189,0)
HD1 I PG>1,$E(IOST)="C" K DIR S DIR(0)="E",DIR("A")=" Press Return to Continue or ^ to Exit" D ^DIR K DIR
"RTN","PSDDSOR",190,0)
 Q
"RTN","PSDDSOR",191,0)
END W ! D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDDSOR",192,0)
 K ^TMP($J),PSDDV,PSDSD,PSDED,PSDDF,PSDXF,DRG,PRO,PAT,PND,SCH,SRT,PSDRG,PSDPR,PSDPT,PSDSC,VA,Y0,Y1,Y2,Y3,Y4,Y5,Y6
"RTN","PSDDSOR",193,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSDDSOR",194,0)
 Q
"RTN","PSDDSOR2")
0^3^B21366672
"RTN","PSDDSOR2",1,0)
PSDDSOR2 ;BIR/MHA-Digitally Signed OP Released Rx Report; 05/09/03
"RTN","PSDDSOR2",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**40,42,45**;13 Feb 97
"RTN","PSDDSOR2",3,0)
 ;Ref. ^PSD(58.8 supp. by IA 2711
"RTN","PSDDSOR2",4,0)
 ;Ref. ^PSD(58.81 supp. by IA 2808
"RTN","PSDDSOR2",5,0)
 ;Ref. ^PSRX( supp. by IA 1977
"RTN","PSDDSOR2",6,0)
 ;Ref. ^PS(59 supp. by IA 2621
"RTN","PSDDSOR2",7,0)
 ;Ref. ^PSDRUG( supp. by IA 2621
"RTN","PSDDSOR2",8,0)
BEG I '$D(PSDSITE) D ^PSDSET G:'$D(PSDSITE) END
"RTN","PSDDSOR2",9,0)
 N PSDV,PSDL,PSDLN,PSDB,PSDS,PSDE,PSDRG,DRG
"RTN","PSDDSOR2",10,0)
 D DT^DICRW
"RTN","PSDDSOR2",11,0)
 S PSDL=$P(PSDSITE,U,3),PSDLN=$P(PSDSITE,U,4)
"RTN","PSDDSOR2",12,0)
 S DIC="^PSD(58.8,",DIC(0)="AEQ",DIC("A")="Select Dispensing Site: "
"RTN","PSDDSOR2",13,0)
 S DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$S($P($G(^(0)),U,2)[""M"":1,$P($G(^(0)),U,2)[""S"":1,1:0),($S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0))"
"RTN","PSDDSOR2",14,0)
 S DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDDSOR2",15,0)
 W ! D ^DIC K DIC G:Y<0 END
"RTN","PSDDSOR2",16,0)
 S $P(PSDSITE,U,3)=+Y,PSDL=+Y,$P(PSDSITE,U,4)=$P(Y,U,2),PSDLN=$P(Y,U,2),PSDV=PSDSITE
"RTN","PSDDSOR2",17,0)
 W ! K %DT S %DT(0)=-DT,%DT="AEP",%DT("A")="Start Date: " D ^%DT
"RTN","PSDDSOR2",18,0)
 G:Y<0 END
"RTN","PSDDSOR2",19,0)
 S (%DT(0),PSDB)=Y,%DT("A")="End Date: "
"RTN","PSDDSOR2",20,0)
 W ! D ^%DT G:Y<0 END
"RTN","PSDDSOR2",21,0)
 S PSDE=Y,PSDS=PSDB-.000001
"RTN","PSDDSOR2",22,0)
D ;ask drug(s)
"RTN","PSDDSOR2",23,0)
 W !!,?5,"You may select a single drug, several drugs,",!,?5,"or enter ^ALL to select all drugs.",!!
"RTN","PSDDSOR2",24,0)
 K DRG,DIC S PSDRG=0,DIC="^PSD(58.8,PSDL,1,",DIC(0)="AEQM"
"RTN","PSDDSOR2",25,0)
 S DIC("A")="Please Select "_PSDLN_"'s Drug: ",DIC("S")="I $S($G(^(""I"")):$G(^(""I""))>DT,1:1)"
"RTN","PSDDSOR2",26,0)
 F  D ^DIC Q:Y<0  D
"RTN","PSDDSOR2",27,0)
 .I '$O(^PSD(58.81,"F",+Y,0)) W !!,"There have been no transactions for this drug.",!! Q
"RTN","PSDDSOR2",28,0)
 .S DRG(+Y)=""
"RTN","PSDDSOR2",29,0)
 K DIC I X="^ALL" S PSDRG=1 G DEV
"RTN","PSDDSOR2",30,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","PSDDSOR2",31,0)
 I '$D(DRG)&(Y<0) G D
"RTN","PSDDSOR2",32,0)
DEV K %ZIS,IOP,POP,ZTSK S PSDIO=ION,%ZIS="QM" D ^%ZIS K %ZIS
"RTN","PSDDSOR2",33,0)
 I POP S IOP=PSDIO D ^%ZIS K IOP,PSDIO W !,"Please try later!" G END
"RTN","PSDDSOR2",34,0)
 K PSDIO I $D(IO("Q")) K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK D  G END
"RTN","PSDDSOR2",35,0)
 .S ZTRTN="EN^PSDDSOR2",ZTDESC="Digitally Signed OP Released Rx Report"
"RTN","PSDDSOR2",36,0)
 .F G="PSDL","PSDLN","PSDV","PSDS","PSDB","PSDE","PSDRG" S:$D(@G) ZTSAVE(G)=""
"RTN","PSDDSOR2",37,0)
 .S:$D(DRG) ZTSAVE("DRG(")=""
"RTN","PSDDSOR2",38,0)
 .D ^%ZTLOAD W:$D(ZTSK) !,"Report is Queued to print !!" K ZTSK
"RTN","PSDDSOR2",39,0)
EN ;
"RTN","PSDDSOR2",40,0)
 K ^TMP($J)
"RTN","PSDDSOR2",41,0)
 N RX,RX0,RX2,ORD,DR,TDT,BDT,EDT,DFN,PL,PL1,P1,P2,PG,AC,S1,S2,S5,S6,Y0,Y1,Y2,Y3,Y4,Y5,Y6
"RTN","PSDDSOR2",42,0)
 N ST,STD,PR,DRN,DV,DVD,I,J,Z,RC
"RTN","PSDDSOR2",43,0)
 F  S PSDS=$O(^PSRX("AL",PSDS)) Q:'PSDS!(PSDS>(PSDE_".99999"))  D
"RTN","PSDDSOR2",44,0)
 .S RX=0 F  S RX=$O(^PSRX("AL",PSDS,RX)) Q:'RX  I $D(^PSRX(RX,"PKI")),$O(^PSD(58.81,"AOP",RX,0)) D
"RTN","PSDDSOR2",45,0)
 ..S RC=$O(^PSD(58.81,"AOP",RX,0)) Q:'$D(^PSD(58.81,RC))
"RTN","PSDDSOR2",46,0)
 ..Q:RX'=$P(^PSD(58.81,RC,6),U)
"RTN","PSDDSOR2",47,0)
 ..Q:PSDL'=$P(^PSD(58.81,RC,0),U,3)
"RTN","PSDDSOR2",48,0)
 ..Q:'$D(^PSRX(RX,0))  S RX0=^(0),DR=$P(RX0,U,6)
"RTN","PSDDSOR2",49,0)
 ..Q:DR'=$P(^PSD(58.81,RC,0),U,5)
"RTN","PSDDSOR2",50,0)
 ..D:$G(PSDRG)!($D(DRG(DR))) GD
"RTN","PSDDSOR2",51,0)
 D NOW^%DTC S TDT=$E(%,4,5)_"/"_$E(%,6,7)_"/"_$E(%,2,3)_"@"_$E(%,9,10)_":"_$E(%,11,12)
"RTN","PSDDSOR2",52,0)
 S AC=0,$E(P1,42)="",$E(P2,12)="",PG=1,Y=PSDB D D^DIQ S BDT=Y,Y=PSDE D D^DIQ S EDT=Y
"RTN","PSDDSOR2",53,0)
 U IO D HD I '$D(^TMP($J)) W !!,"**********    NO DATA TO PRINT   **********",!! G END
"RTN","PSDDSOR2",54,0)
 D PRD
"RTN","PSDDSOR2",55,0)
END ;
"RTN","PSDDSOR2",56,0)
 W ! D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDDSOR2",57,0)
 K ^TMP($J)
"RTN","PSDDSOR2",58,0)
 Q
"RTN","PSDDSOR2",59,0)
GD ;
"RTN","PSDDSOR2",60,0)
 S DFN=$P(RX0,U,2),RX2=^PSRX(RX,2),PR=$P(RX0,U,4),ORD=$P($G(^("OR1")),U,2),ST=+$P($G(^("STA")),U) Q:'$D(^("PKI"))
"RTN","PSDDSOR2",61,0)
 Q:'DFN!('PR)!('DR)!('ORD)
"RTN","PSDDSOR2",62,0)
 S DRN=$P($G(^PSDRUG(DR,0)),U),DRN=$S(DRN]"":DRN,1:"UNKNOWN DRUG")
"RTN","PSDDSOR2",63,0)
 S STD=$P("ERROR^ACTIVE^NON-VERIFIED^REFILL FILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^DONE^EXPIRED^DISCONTINUED^DISCONTINUED^DISCONTINUED^DISCONTINUED(EDIT)^HOLD^","^",ST+2)
"RTN","PSDDSOR2",64,0)
 S ST=ST_";"_STD D ADD^VADPT
"RTN","PSDDSOR2",65,0)
 S ^TMP($J,PSDS,DRN,RX,0)="1"_U_ORD_U_U_ST_U_$P(RX2,U)
"RTN","PSDDSOR2",66,0)
 S ^TMP($J,PSDS,DRN,RX,1)=$P(^DPT(DFN,0),U)_U_VAPA(1)_U_VAPA(2)_U_VAPA(3)_U_VAPA(4)_U_$P(VAPA(5),U,2)_U_VAPA(6)
"RTN","PSDDSOR2",67,0)
 S ^TMP($J,PSDS,DRN,RX,2)=DRN_U_DR_U_$P(RX0,U,7)_U_U_$P($G(^PSDRUG(DR,0)),U,3)
"RTN","PSDDSOR2",68,0)
 S ^TMP($J,PSDS,DRN,RX,3)=""
"RTN","PSDDSOR2",69,0)
 S ^TMP($J,PSDS,DRN,RX,4)=$P($G(^VA(200,PR,0)),U)_U_PR_U_$$DEA^XUSER(,PR)
"RTN","PSDDSOR2",70,0)
 S DV=+$P(RX2,U,9),DVD=$G(^PS(59,DV,0))
"RTN","PSDDSOR2",71,0)
 S ^TMP($J,PSDS,DRN,RX,5)=$P(DVD,U,1,2)_U_U_$P(DVD,U,7)_U_$P(^DIC(5,+$P(DVD,U,8),0),U)_U_$P(DVD,U,5)
"RTN","PSDDSOR2",72,0)
 Q
"RTN","PSDDSOR2",73,0)
PRD S S1=0 F  S S1=$O(^TMP($J,S1)) Q:'S1  D  Q:$D(DIRUT)
"RTN","PSDDSOR2",74,0)
 .S S2="" F  S S2=$O(^TMP($J,S1,S2)) Q:S2=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR2",75,0)
 ..S S5=0 F  S S5=$O(^TMP($J,S1,S2,S5)) Q:'S5  D PR  Q:$D(DIRUT)
"RTN","PSDDSOR2",76,0)
 Q
"RTN","PSDDSOR2",77,0)
PR K Y0,Y1,Y2,Y3,Y4,Y5,Y6 S S6=""
"RTN","PSDDSOR2",78,0)
 F  S S6=$O(^TMP($J,S1,S2,S5,S6)) Q:S6=""  S Z="Y"_S6,@Z=^TMP($J,S1,S2,S5,S6)
"RTN","PSDDSOR2",79,0)
 D:($Y+4)>IOSL HD Q:$D(DIRUT)  S Y6="" D PRT^PSDDSOR1
"RTN","PSDDSOR2",80,0)
 Q
"RTN","PSDDSOR2",81,0)
HD D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR2",82,0)
 W @IOF,!?2,"Digitally Signed OP Released Rx Report for Vault "_PSDLN,?70,"Page: ",PG
"RTN","PSDDSOR2",83,0)
 W !,?8,"Date Range: "_BDT_" - "_EDT,?53,"Printed on: "_TDT,!
"RTN","PSDDSOR2",84,0)
 S PG=PG+1
"RTN","PSDDSOR2",85,0)
 Q
"RTN","PSDDSOR2",86,0)
HD1 I PG>1,$E(IOST)="C" K DIR S DIR(0)="E",DIR("A")=" Press Return to Continue or ^ to Exit" D ^DIR K DIR
"RTN","PSDDSOR2",87,0)
 Q
"RTN","PSDOPT0")
0^4^B71140055
"RTN","PSDOPT0",1,0)
PSDOPT0 ;BIR/JPW,LTL,BJW-Outpatient Rx Entry (cont'd) ; 22 Jun 98
"RTN","PSDOPT0",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**10,30,37,39,45**;13 Feb 97
"RTN","PSDOPT0",3,0)
 ;Reference to PS(52.5 supported by DBIA #786
"RTN","PSDOPT0",4,0)
 ;Reference to PS(59.7 supported by DBIA #1930
"RTN","PSDOPT0",5,0)
 ;References to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDOPT0",6,0)
 ;References to file 58.81 are covered by DBIA #2808
"RTN","PSDOPT0",7,0)
 ;Reference to ^PSDRUG( supported by DBIA #221
"RTN","PSDOPT0",8,0)
 ;Reference to PSRX( supported by DBIA #986
"RTN","PSDOPT0",9,0)
 ;called by ^PSDOPT,mod.for nois#:tua-0498-32173
"RTN","PSDOPT0",10,0)
 ;08/02/2004 KAM PSD*3*45 Modification to stop posting of the same 
"RTN","PSDOPT0",11,0)
 ;                        partial multiple times
"RTN","PSDOPT0",12,0)
LOOP ;loop to find new, refills and partials
"RTN","PSDOPT0",13,0)
 W !!,"Accessing the prescription history..."
"RTN","PSDOPT0",14,0)
 N PSDOIN,PSDRXFD,PSDSUPN,PSDLBL S PSDOIN=+$P($G(^PS(59.7,1,49.99)),U,2)
"RTN","PSDOPT0",15,0)
 ;check for unposted refills not returned to stock and not in suspense
"RTN","PSDOPT0",16,0)
 S (RF,DAT)=0 F JJ=0:0 S JJ=$O(^PSRX(PSDRX,1,JJ)) Q:'JJ  I $D(^PSRX(PSDRX,1,JJ,0)),'$P(^(0),U,16),$P($G(^(0)),U)'<PSDOIN D
"RTN","PSDOPT0",17,0)
 .;checking for suspense
"RTN","PSDOPT0",18,0)
 .S PSDRXFD=$E($P(^PSRX(PSDRX,1,JJ,0),U),1,7)
"RTN","PSDOPT0",19,0)
 .S PSDSUPN=$O(^PS(52.5,"B",PSDRX,0))
"RTN","PSDOPT0",20,0)
 .I PSDSUPN,$D(^PS(52.5,"C",PSDRXFD,PSDSUPN)),$G(^PS(52.5,PSDSUPN,"P"))'=1 W !!,"Refill #",JJ," suspended." Q
"RTN","PSDOPT0",21,0)
 .S RXNUM("RF",JJ)=+^PSRX(PSDRX,1,JJ,0)_U_$P(^(0),U,4),$P(PSDSEL("RF",JJ),"^",1)=$P(RXNUM("RF",JJ),"^",1),$P(PSDSEL("RF",JJ),"^",2)=$P(RXNUM("RF",JJ),"^",2),$P(PSDSEL("RF",JJ),"^",3)=$P($G(PSDRX("RF",JJ)),"^",3) K PSDLBLP
"RTN","PSDOPT0",22,0)
 ;
"RTN","PSDOPT0",23,0)
 ;check for unposted partials not returned to stock or suspended
"RTN","PSDOPT0",24,0)
 ;
"RTN","PSDOPT0",25,0)
 S PRF=0 F JJ=0:0 S JJ=$O(^PSRX(PSDRX,"P",JJ)) Q:'JJ  I $D(^PSRX(PSDRX,"P",JJ,0)),'$P(^(0),U,16),$P($G(^(0)),U)'<PSDOIN D
"RTN","PSDOPT0",26,0)
 .;check for suspense
"RTN","PSDOPT0",27,0)
 .S PSDRXFD=$E($P(^PSRX(PSDRX,"P",JJ,0),U),1,7)
"RTN","PSDOPT0",28,0)
 .S PSDSUPN=$O(^PS(52.5,"B",PSDRX,0))
"RTN","PSDOPT0",29,0)
 .I PSDSUPN,$D(^PS(52.5,"C",PSDRXFD,PSDSUPN)),$G(^PS(52.5,PSDSUPN,"P"))'=1,($G(JJ)=$P(^PS(52.5,PSDSUPN,0),U,5)) W !!,"Partial #",JJ," suspended." Q
"RTN","PSDOPT0",30,0)
 .S RXNUM("PR",JJ)=+^PSRX(PSDRX,"P",JJ,0)_U_$P(^(0),U,4),$P(PSDSEL("PR",JJ),"^",1)=$P(RXNUM("PR",JJ),"^",1),$P(PSDSEL("PR",JJ),"^",2)=$P(RXNUM("PR",JJ),"^",2) K PSDLBL
"RTN","PSDOPT0",31,0)
 ;
"RTN","PSDOPT0",32,0)
 ;original returned to stock
"RTN","PSDOPT0",33,0)
 ;
"RTN","PSDOPT0",34,0)
 S:$P($G(^PSRX(+PSDRX,2)),U,15) PSDRX(1)=""
"RTN","PSDOPT0",35,0)
 ;Check for suspense
"RTN","PSDOPT0",36,0)
 I +$P($G(^PSRX(PSDRX,2)),U,2)'<PSDOIN S PSDRXFD=$P(^(2),U,2) D
"RTN","PSDOPT0",37,0)
 .S PSDSUPN=$O(^PS(52.5,"B",PSDRX,0))
"RTN","PSDOPT0",38,0)
 .I PSDSUPN,$D(^PS(52.5,"C",PSDRXFD,PSDSUPN)),$G(^PS(52.5,PSDSUPN,"P"))'=1 W !!,"Original suspended." S PSDRX(1)="" Q
"RTN","PSDOPT0",39,0)
PSDDAVE ;PSD*3*30 (Major overhaul, Dave B)
"RTN","PSDOPT0",40,0)
 ;PSDSEL("RF",#)=refill Date ^ QTY ^ posted (y/n) ^ released date
"RTN","PSDOPT0",41,0)
 ;PSDSEL("PR"  ''
"RTN","PSDOPT0",42,0)
 ;PSDSEL("OR"  same thing
"RTN","PSDOPT0",43,0)
 ;
"RTN","PSDOPT0",44,0)
 I '$D(PSDRX(1)) S $P(PSDSEL("OR"),"^",2)=$P(^PSRX(+PSDRX,0),"^",7) ;Quantity
"RTN","PSDOPT0",45,0)
 I $D(PSDRX("OR")) S $P(PSDSEL("OR"),"^",3)=1 ;Posted
"RTN","PSDOPT0",46,0)
 I $P($G(^PSRX(+PSDRX,2)),"^",13)'="" S Y=$P(^PSRX(+PSDRX,2),"^",13) X ^DD("DD") S $P(PSDSEL("OR"),"^",4)=Y ;released date
"RTN","PSDOPT0",47,0)
 I $D(PSDSEL("OR")),$P(PSDSEL("OR"),"^",3)'="",$P(PSDSEL("OR"),"^",4)'="" K PSDSEL("OR"),RXNUM("OR")
"RTN","PSDOPT0",48,0)
 S (PSDRF1,PSDPR1)=0
"RTN","PSDOPT0",49,0)
RFLCHK ;
"RTN","PSDOPT0",50,0)
 S PSDRF1=$O(PSDSEL("RF",PSDRF1)) G PRTLCHK:PSDRF1'>0 S DATA=PSDSEL("RF",PSDRF1)
"RTN","PSDOPT0",51,0)
 I $P($G(^PSRX(+PSDRX,1,PSDRF1,0)),"^",18)'="" S Y=$P(^(0),"^",18) X ^DD("DD") S $P(PSDSEL("RF",PSDRF1),"^",4)=Y ;Already released
"RTN","PSDOPT0",52,0)
 I $P(PSDSEL("RF",PSDRF1),"^",3)>0,$P(PSDSEL("RF",PSDRF1),"^",4)'="" K PSDSEL("RF",PSDRF1),RXNUM("RF",PSDRF1)
"RTN","PSDOPT0",53,0)
 G RFLCHK
"RTN","PSDOPT0",54,0)
 ;
"RTN","PSDOPT0",55,0)
PRTLCHK S PSDPR1=$O(PSDSEL("PR",PSDPR1)) G CHKALL:PSDPR1'>0
"RTN","PSDOPT0",56,0)
 ; 08/02/2004 PSD*3*45 Added next line
"RTN","PSDOPT0",57,0)
 I $D(PSDRX("PR",PSDPR1)) S $P(PSDSEL("PR",PSDPR1),"^",3)=1 ;Posted 
"RTN","PSDOPT0",58,0)
 I $P($G(^PSRX(+PSDRX,"P",PSDPR1,0)),"^",19)'="" S Y=$P(^(0),"^",19) X ^DD("DD") S $P(PSDSEL("PR",PSDPR1),"^",4)=Y
"RTN","PSDOPT0",59,0)
 I $P(PSDSEL("PR",PSDPR1),"^",3)>0,$P(PSDSEL("PR",PSDPR1),"^",4)'="" K PSDSEL("PR",PSDPR1),RXNUM("PR",PSDPR1)
"RTN","PSDOPT0",60,0)
 G PRTLCHK
"RTN","PSDOPT0",61,0)
 ;
"RTN","PSDOPT0",62,0)
CHKALL ;Check to see if any left to post or release
"RTN","PSDOPT0",63,0)
 I $G(PSDERR)=1 G ASKP^PSDOPT
"RTN","PSDOPT0",64,0)
 I $O(PSDSEL(0))="" W !!,"ALL FILLS FOR THIS PRESCRIPTION HAVE BEEN POSTED AND RELEASED." G ASKP^PSDOPT
"RTN","PSDOPT0",65,0)
 ;
"RTN","PSDOPT0",66,0)
 ;Check for DIR call
"RTN","PSDOPT0",67,0)
 S CNT=0 K DIR
"RTN","PSDOPT0",68,0)
 G CHK^PSDOPT
"RTN","PSDOPT0",69,0)
 ;
"RTN","PSDOPT0",70,0)
PSDRTS(PSDRX,PSDNUM,PSDSITE,PSDQTY) ; API for Outpatient Pharmacy; Patch PSD*3*30
"RTN","PSDOPT0",71,0)
 ; This subroutine is called each time an Rx is returned to stock
"RTN","PSDOPT0",72,0)
 ; in Outpatient Pharmacy. The code does the following:
"RTN","PSDOPT0",73,0)
 ; 1.Check Rx, quit if not a controlled substance.
"RTN","PSDOPT0",74,0)
 ; 2.Give the user the option to update the transaction and
"RTN","PSDOPT0",75,0)
 ;   balance details
"RTN","PSDOPT0",76,0)
 ;PSDCS = 1 is controlled subs/0 for not CS
"RTN","PSDOPT0",77,0)
 ;PSDRS = 1 they have key, ok to return to stock, 0 - no key
"RTN","PSDOPT0",78,0)
 ;Variables:
"RTN","PSDOPT0",79,0)
 ;PSDRX   = Prescription Number IEN
"RTN","PSDOPT0",80,0)
 ;PSDNUM  = O^0 = The letter O for original fill and the number0
"RTN","PSDOPT0",81,0)
 ;          R^# = The letter R for refill and # equal to refill #
"RTN","PSDOPT0",82,0)
 ;          P^# = The letter P for partial and # equal to partial #
"RTN","PSDOPT0",83,0)
 ;PSDSITE = Division
"RTN","PSDOPT0",84,0)
 ;PSDQTY  = Quantity being returned to stock
"RTN","PSDOPT0",85,0)
 ;
"RTN","PSDOPT0",86,0)
 ;PSD*3*30 Check for PSDMGR key
"RTN","PSDOPT0",87,0)
 S PSDRS=0 I $D(^XUSEC("PSDMGR",DUZ)) S PSDRS=1 ;possess key
"RTN","PSDOPT0",88,0)
1 ;begin process
"RTN","PSDOPT0",89,0)
 I $D(^PSD(58.81,"AOP",PSDRX)) D RTSCHK G RETERR:$G(PSDERR)>0
"RTN","PSDOPT0",90,0)
 S PSDOUT=0,RXNUM=$P($G(^PSRX(+PSDRX,0)),"^") ;Prescription Number
"RTN","PSDOPT0",91,0)
 S (RPDT,DAT)=$P($G(^PSRX(+PSDRX,2)),"^",2)
"RTN","PSDOPT0",92,0)
 S DFN=+$P($G(^PSRX(+PSDRX,0)),"^",2)
"RTN","PSDOPT0",93,0)
 S PSDS=$S($G(PSDSITE)["^":$P(PSDSITE,"^",3),1:PSDSITE)
"RTN","PSDOPT0",94,0)
 S PSDR=$P($G(^PSRX(+PSDRX,0)),"^",6) I $G(PSDR)'="" S PSDRN=$P($G(^PSDRUG(PSDR,0)),"^")
"RTN","PSDOPT0",95,0)
 ;Setup like balance adjustment
"RTN","PSDOPT0",96,0)
 S PSDRN=$S($G(PSDRN)="":"Unknown Drug "_PSDR,1:PSDRN)
"RTN","PSDOPT0",97,0)
 I $P($G(^PSDRUG(PSDR,2)),"^",3)'["N" S PSDCS=0 Q
"RTN","PSDOPT0",98,0)
 S PSDCS=1
"RTN","PSDOPT0",99,0)
 I $G(PSDRS)'>0 W !,"Sorry you do not possess the PSDMGR key" G RETERR
"RTN","PSDOPT0",100,0)
 ;
"RTN","PSDOPT0",101,0)
POSTED ;check to see if posted
"RTN","PSDOPT0",102,0)
 S (JJ,PSDPOST)=0
"RTN","PSDOPT0",103,0)
 F  S JJ=$O(^PSD(58.81,"AOP",+PSDRX,JJ)) Q:'JJ  I $D(^PSD(58.81,JJ,6)) D
"RTN","PSDOPT0",104,0)
 .S NODE6=$G(^PSD(58.81,JJ,6))
"RTN","PSDOPT0",105,0)
 .I $P(PSDNUM,"^",1)="R",$P(NODE6,"^",2)'="",$P(NODE6,"^",2)=$P(PSDNUM,"^",2) S PSDPOST=1 Q
"RTN","PSDOPT0",106,0)
 .I $P(PSDNUM,"^",1)="P",$P(NODE6,"^",4)'="",$P(NODE6,"^",4)=$P(PSDNUM,"^",2) S PSDPOST=1 Q
"RTN","PSDOPT0",107,0)
 .I $P(PSDNUM,"^",1)="O",$P(NODE6,"^",4)="",$P(NODE6,"^",2)="" S PSDPOST=1 Q
"RTN","PSDOPT0",108,0)
 ;
"RTN","PSDOPT0",109,0)
 ;now check to see if CMOP
"RTN","PSDOPT0",110,0)
 S X1=0 F  S X1=$O(^PSRX(+PSDRX,4,X1)) Q:X1=""  S DATA=$G(^PSRX(+PSDRX,4,X1,0)) D
"RTN","PSDOPT0",111,0)
 .I $P(PSDNUM,"^",1)="R",$P(DATA,"^",3)=$P(PSDNUM,"^",2) S PSDPOST=1 Q
"RTN","PSDOPT0",112,0)
 .I $P(PSDNUM,"^",1)="P",$P(DATA,"^",3)=$P(PSDNUM,"^",2) S PSDPOST=1 Q
"RTN","PSDOPT0",113,0)
 .I $P(PSDNUM,"^",1)="O",$P(DATA,"^",3)=$P(PSDNUM,"^",2) S PSDPOST=1 Q
"RTN","PSDOPT0",114,0)
 I $G(PSDPOST)'=1 W !!,"Could not find any posting information in the Controlled Substance package,",!,"balance cannot be updated",!
"RTN","PSDOPT0",115,0)
 ;
"RTN","PSDOPT0",116,0)
ESIG K X D SIG^XUSESIG I X["^" W !,"No signature code entered, RX not returned to stock." S RETSK=1 Q
"RTN","PSDOPT0",117,0)
 I X1="" W !,"An Electronic Signature Code is required to return a Controlled Substance RX to stock.",! G ESIG
"RTN","PSDOPT0",118,0)
ASK S DIR(0)="Y",DIR("A")="Do you want "_$G(PSDQTY)_" added to balance in the Narcotic vault",DIR("B")="Yes",DIR("?")="Answer Yes and the amount being returned to stock will be placed in inventory" D ^DIR K DIR I $D(DIRUT) G RETERR
"RTN","PSDOPT0",119,0)
 I +Y'>0 W !,"Nothing updated" G RETERR
"RTN","PSDOPT0",120,0)
LOCATION S DIC(0)="QEA",DIC="^PSD(58.8,",DIC("A")="Return Drug to which vault: "
"RTN","PSDOPT0",121,0)
 S DIC("S")="I ""MSN""[$P($G(^PSD(58.8,Y,0)),U,2)"
"RTN","PSDOPT0",122,0)
 D ^DIC K DIC
"RTN","PSDOPT0",123,0)
 I "MSN"'[$P($G(^PSD(58.8,+Y,0)),"^",2) W !,"Sorry, the location type must be a Master Vault, satellite or narcotic location." K Y G LOCATION
"RTN","PSDOPT0",124,0)
 I +Y'>0 W !,"No selection made, no balance adjusted." G RETERR
"RTN","PSDOPT0",125,0)
 S PSDS=+Y I '$D(^PSD(58.8,+PSDS,1,PSDR,0)) W !,"Sorry, the drug is not stocked in this vault." K PSDS G LOCATION
"RTN","PSDOPT0",126,0)
 S PSDBAL=$P($G(^PSD(58.8,+PSDS,1,PSDR,0)),"^",4) W !,"Previous Balance: ",$G(PSDBAL)_"    New Balance: "_($G(PSDBAL)+PSDQTY)
"RTN","PSDOPT0",127,0)
 W !,"Updating balances"
"RTN","PSDOPT0",128,0)
 F  L +^PSD(58.8,+PSDS,1,PSDR,0):0 I  Q
"RTN","PSDOPT0",129,0)
 D NOW^%DTC S PSDT=+%,BAL=+$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4),$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)=$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)+PSDQTY
"RTN","PSDOPT0",130,0)
 L -^PSD(58.8,+PSDS,1,PSDR,0) W "."
"RTN","PSDOPT0",131,0)
 F  L +^PSD(58.81,0):0 I  Q
"RTN","PSDOPT0",132,0)
FIND1 S PSDA=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDA)) S $P(^PSD(58.81,0),"^",3)=PSDA G FIND1
"RTN","PSDOPT0",133,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.81,DIC(0)="L",(X,DINUM)=PSDA D ^DIC K DIC,DLAYGO
"RTN","PSDOPT0",134,0)
 L -^PSD(58.81,0)
"RTN","PSDOPT0",135,0)
 S PSDNUM1=$P($G(PSDNUM),"^",2)
"RTN","PSDOPT0",136,0)
 S ^PSD(58.81,PSDA,0)=PSDA_"^3^"_+PSDS_"^"_PSDT_"^"_PSDR_"^"_PSDQTY_"^"_DUZ_"^^^"_BAL
"RTN","PSDOPT0",137,0)
 S ^PSD(58.81,PSDA,3)=PSDT_"^"_PSDQTY_"^"_"RX RETURNED TO STOCK"
"RTN","PSDOPT0",138,0)
 S ^PSD(58.81,PSDA,"CS")=1
"RTN","PSDOPT0",139,0)
 S ^PSD(58.81,PSDA,6)=PSDRX_"^"_$S($P(PSDNUM,"^")="R":PSDNUM1,1:"")_"^"_DAT_"^"_$S($P(PSDNUM,"^")="P":PSDNUM1,1:"")_"^"_RXNUM
"RTN","PSDOPT0",140,0)
 S DIK="^PSD(58.81,",DA=PSDA D IX^DIK K DA,DIC,DIK
"RTN","PSDOPT0",141,0)
DIE I '$D(^PSD(58.8,+PSDS,1,PSDR,4,0)) S ^(0)="^58.800119PA^^"
"RTN","PSDOPT0",142,0)
 K DA,DIC,DD,DO S DA(1)=PSDR,DA(2)=+PSDS,(X,DINUM)=PSDA,DIC(0)="L",DIC="^PSD(58.8,"_+PSDS_",1,"_PSDR_",4," D FILE^DICN K DIC,DINUM
"RTN","PSDOPT0",143,0)
 ;monthly activity
"RTN","PSDOPT0",144,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,0)) S ^(0)="^58.801A^^"
"RTN","PSDOPT0",145,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,$E(DT,1,5)*100,0)) K DA,DIC S DIC="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=+PSDS,DA(1)=PSDR D ^DIC K DA,DIC,DINUM,DLAYGO
"RTN","PSDOPT0",146,0)
 K DA,DIE,DR S DIE="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DA(2)=+PSDS,DA(1)=PSDR,DA=$E(DT,1,5)*100,DR="9////^S X=$P($G(^(0)),""^"",6)+PSDQTY" D ^DIE K DA,DIE,DR
"RTN","PSDOPT0",147,0)
RETERR Q
"RTN","PSDOPT0",148,0)
RTSCHK ;Check to see if already returned to stock.
"RTN","PSDOPT0",149,0)
 S PSDERR=0
"RTN","PSDOPT0",150,0)
 S PSD1=0 F  S PSD1=$O(^PSD(58.81,"AOP",PSDRX,PSD1)) Q:PSD1'>0  S DATA=$G(^PSD(58.81,PSD1,0)),DATA6=$G(^PSD(58.81,PSD1,6)) D
"RTN","PSDOPT0",151,0)
 .S PSDFLL=$P(PSDNUM,"^",2)
"RTN","PSDOPT0",152,0)
 .I PSDFLL>0,$D(^PSD(58.81,PSD1,6)),$P(^PSD(58.81,PSD1,6),"^",2)=PSDFLL,$D(^PSD(58.81,PSD1,3)) D ERRMSG
"RTN","PSDOPT0",153,0)
 .I $D(^PSD(58.81,PSD1,3)),PSDFLL=0,'$D(^PSD(58.81,PSD1,6)) D ERRMSG
"RTN","PSDOPT0",154,0)
 Q
"RTN","PSDOPT0",155,0)
ERRMSG S Y=$P(^PSD(58.81,PSD1,3),"^") X ^DD("DD") S PSDRTS(1)=Y,PSDUSER=$P(^PSD(58.81,PSD1,0),"^",7),PSDUSER=$P(^VA(200,PSDUSER,0),"^")
"RTN","PSDOPT0",156,0)
 W !!?8,"According to the Controlled Substances package, this fill/refill",!?8,"was returned to stock on "_PSDRTS(1)_" by "_$G(PSDUSER)_".",!?16,"Nothing updated in the Controlled Substances package."
"RTN","PSDOPT0",157,0)
 S PSDERR=1 Q
"RTN","PSDP345")
0^^B840605
"RTN","PSDP345",1,0)
PSDP345 ; BAY/KAM - Patch PSD*3*45 Install Utility Routine ; 4/21/04 9:04am
"RTN","PSDP345",2,0)
 ;;3.0;CONTROLLED SUBSTANCES;**45**;AUG 13, 1993
"RTN","PSDP345",3,0)
 ;
"RTN","PSDP345",4,0)
ENV ;Main Entry point for Environment Check
"RTN","PSDP345",5,0)
 S XPDABORT=""
"RTN","PSDP345",6,0)
 D PROGCHK(.XPDABORT) ;checks programmer variables
"RTN","PSDP345",7,0)
 I XPDABORT="" K XPDABORT
"RTN","PSDP345",8,0)
 Q
"RTN","PSDP345",9,0)
PROGCHK(XPDABORT) ; checks for necessary programmer variables
"RTN","PSDP345",10,0)
 ;
"RTN","PSDP345",11,0)
 I '$G(DUZ)!($G(DUZ(0))'="@")!('$G(DT))!($G(U)'="^")  D
"RTN","PSDP345",12,0)
 . D BMES^XPDUTL("****")
"RTN","PSDP345",13,0)
 . D MES^XPDUTL("Your programming variables are not set up properly.")
"RTN","PSDP345",14,0)
 . D MES^XPDUTL("Installation aborted.")
"RTN","PSDP345",15,0)
 . D MES^XPDUTL("*****")
"RTN","PSDP345",16,0)
 . S XPDABORT=2
"RTN","PSDP345",17,0)
 Q
"VER")
8.0^22
**END**
**END**
