Released PSO*7*207 SEQ #200
Extracted from mail message
**KIDS**:PSO*7.0*207^

**INSTALL NAME**
PSO*7.0*207
"BLD",5333,0)
PSO*7.0*207^OUTPATIENT PHARMACY^0^3051019^y
"BLD",5333,1,0)
^^20^20^3050816^
"BLD",5333,1,1,0)
This patch adds the capability of doing order checking between local VA 
"BLD",5333,1,2,0)
facilities and remote VA or Department of Defense (DoD) facilities where 
"BLD",5333,1,3,0)
veterans have received prescriptions. This Remote Data Interoperability 
"BLD",5333,1,4,0)
(RDI) functionality includes receiving data from the Health Data
"BLD",5333,1,5,0)
Repository (HDR) in order to perform the order checking against remote
"BLD",5333,1,6,0)
data.
"BLD",5333,1,7,0)
 
"BLD",5333,1,8,0)
After the release of this patch, a Computerized Patient Record System
"BLD",5333,1,9,0)
(CPRS) patch will turn on a flag which enables the remote order checking
"BLD",5333,1,10,0)
to occur. When turned on, the remote order checking includes checks for
"BLD",5333,1,11,0)
duplicate drugs, duplicate drug classes, drug interactions, and drug
"BLD",5333,1,12,0)
allergies.
"BLD",5333,1,13,0)
 
"BLD",5333,1,14,0)
In addition to the new functionality, there are several help desk tickets
"BLD",5333,1,15,0)
related to erroneous drug interactions with non-VA meds. The problem
"BLD",5333,1,16,0)
and fix have been identified as a variable being carried over from prior 
"BLD",5333,1,17,0)
drug checks that should have been killed in between. Because the routine
"BLD",5333,1,18,0)
that needs to be fixed is already being changed as part of the RDI
"BLD",5333,1,19,0)
project, the change to kill the variable at the end of the interaction 
"BLD",5333,1,20,0)
checking will be included in this RDI patch.
"BLD",5333,4,0)
^9.64PA^^
"BLD",5333,6)
4^
"BLD",5333,"KRN",0)
^9.67PA^8989.52^19
"BLD",5333,"KRN",.4,0)
.4
"BLD",5333,"KRN",.4,"NM",0)
^9.68A^^
"BLD",5333,"KRN",.401,0)
.401
"BLD",5333,"KRN",.402,0)
.402
"BLD",5333,"KRN",.403,0)
.403
"BLD",5333,"KRN",.5,0)
.5
"BLD",5333,"KRN",.84,0)
.84
"BLD",5333,"KRN",3.6,0)
3.6
"BLD",5333,"KRN",3.8,0)
3.8
"BLD",5333,"KRN",9.2,0)
9.2
"BLD",5333,"KRN",9.8,0)
9.8
"BLD",5333,"KRN",9.8,"NM",0)
^9.68A^9^9
"BLD",5333,"KRN",9.8,"NM",1,0)
PSOCPDUP^^0^B39161837
"BLD",5333,"KRN",9.8,"NM",2,0)
PSODGDGI^^0^B54723266
"BLD",5333,"KRN",9.8,"NM",3,0)
PSODRDUP^^0^B49880475
"BLD",5333,"KRN",9.8,"NM",4,0)
PSOORDRG^^0^B41745329
"BLD",5333,"KRN",9.8,"NM",5,0)
PSOORRD2^^0^B23700480
"BLD",5333,"KRN",9.8,"NM",6,0)
PSOORRDI^^0^B48531879
"BLD",5333,"KRN",9.8,"NM",7,0)
PSODRG^^0^B24416952
"BLD",5333,"KRN",9.8,"NM",8,0)
PSOVER1^^0^B48618041
"BLD",5333,"KRN",9.8,"NM",9,0)
PSOORFI4^^0^B57972101
"BLD",5333,"KRN",9.8,"NM","B","PSOCPDUP",1)

"BLD",5333,"KRN",9.8,"NM","B","PSODGDGI",2)

"BLD",5333,"KRN",9.8,"NM","B","PSODRDUP",3)

"BLD",5333,"KRN",9.8,"NM","B","PSODRG",7)

"BLD",5333,"KRN",9.8,"NM","B","PSOORDRG",4)

"BLD",5333,"KRN",9.8,"NM","B","PSOORFI4",9)

"BLD",5333,"KRN",9.8,"NM","B","PSOORRD2",5)

"BLD",5333,"KRN",9.8,"NM","B","PSOORRDI",6)

"BLD",5333,"KRN",9.8,"NM","B","PSOVER1",8)

"BLD",5333,"KRN",19,0)
19
"BLD",5333,"KRN",19,"NM",0)
^9.68A^^
"BLD",5333,"KRN",19.1,0)
19.1
"BLD",5333,"KRN",101,0)
101
"BLD",5333,"KRN",409.61,0)
409.61
"BLD",5333,"KRN",771,0)
771
"BLD",5333,"KRN",870,0)
870
"BLD",5333,"KRN",8989.51,0)
8989.51
"BLD",5333,"KRN",8989.52,0)
8989.52
"BLD",5333,"KRN",8994,0)
8994
"BLD",5333,"KRN","B",.4,.4)

"BLD",5333,"KRN","B",.401,.401)

"BLD",5333,"KRN","B",.402,.402)

"BLD",5333,"KRN","B",.403,.403)

"BLD",5333,"KRN","B",.5,.5)

"BLD",5333,"KRN","B",.84,.84)

"BLD",5333,"KRN","B",3.6,3.6)

"BLD",5333,"KRN","B",3.8,3.8)

"BLD",5333,"KRN","B",9.2,9.2)

"BLD",5333,"KRN","B",9.8,9.8)

"BLD",5333,"KRN","B",19,19)

"BLD",5333,"KRN","B",19.1,19.1)

"BLD",5333,"KRN","B",101,101)

"BLD",5333,"KRN","B",409.61,409.61)

"BLD",5333,"KRN","B",771,771)

"BLD",5333,"KRN","B",870,870)

"BLD",5333,"KRN","B",8989.51,8989.51)

"BLD",5333,"KRN","B",8989.52,8989.52)

"BLD",5333,"KRN","B",8994,8994)

"BLD",5333,"QUES",0)
^9.62^^
"BLD",5333,"REQB",0)
^9.611^5^5
"BLD",5333,"REQB",1,0)
PSO*7.0*188^2
"BLD",5333,"REQB",2,0)
PSO*7.0*192^2
"BLD",5333,"REQB",3,0)
PSO*7.0*139^2
"BLD",5333,"REQB",4,0)
PSN*4.0*104^2
"BLD",5333,"REQB",5,0)
PSO*7.0*202^2
"BLD",5333,"REQB","B","PSN*4.0*104",4)

"BLD",5333,"REQB","B","PSO*7.0*139",3)

"BLD",5333,"REQB","B","PSO*7.0*188",1)

"BLD",5333,"REQB","B","PSO*7.0*192",2)

"BLD",5333,"REQB","B","PSO*7.0*202",5)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
207^3051019^10000000010
"PKG",141,22,1,"PAH",1,1,0)
^^20^20^3051019
"PKG",141,22,1,"PAH",1,1,1,0)
This patch adds the capability of doing order checking between local VA 
"PKG",141,22,1,"PAH",1,1,2,0)
facilities and remote VA or Department of Defense (DoD) facilities where 
"PKG",141,22,1,"PAH",1,1,3,0)
veterans have received prescriptions. This Remote Data Interoperability 
"PKG",141,22,1,"PAH",1,1,4,0)
(RDI) functionality includes receiving data from the Health Data
"PKG",141,22,1,"PAH",1,1,5,0)
Repository (HDR) in order to perform the order checking against remote
"PKG",141,22,1,"PAH",1,1,6,0)
data.
"PKG",141,22,1,"PAH",1,1,7,0)
 
"PKG",141,22,1,"PAH",1,1,8,0)
After the release of this patch, a Computerized Patient Record System
"PKG",141,22,1,"PAH",1,1,9,0)
(CPRS) patch will turn on a flag which enables the remote order checking
"PKG",141,22,1,"PAH",1,1,10,0)
to occur. When turned on, the remote order checking includes checks for
"PKG",141,22,1,"PAH",1,1,11,0)
duplicate drugs, duplicate drug classes, drug interactions, and drug
"PKG",141,22,1,"PAH",1,1,12,0)
allergies.
"PKG",141,22,1,"PAH",1,1,13,0)
 
"PKG",141,22,1,"PAH",1,1,14,0)
In addition to the new functionality, there are several help desk tickets
"PKG",141,22,1,"PAH",1,1,15,0)
related to erroneous drug interactions with non-VA meds. The problem
"PKG",141,22,1,"PAH",1,1,16,0)
and fix have been identified as a variable being carried over from prior 
"PKG",141,22,1,"PAH",1,1,17,0)
drug checks that should have been killed in between. Because the routine
"PKG",141,22,1,"PAH",1,1,18,0)
that needs to be fixed is already being changed as part of the RDI
"PKG",141,22,1,"PAH",1,1,19,0)
project, the change to kill the variable at the end of the interaction 
"PKG",141,22,1,"PAH",1,1,20,0)
checking will be included in this RDI patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","PSOCPDUP")
0^1^B39161837
"RTN","PSOCPDUP",1,0)
PSOCPDUP ;BIR/SAB - Dup drug and class checker for copy orders ;1/3/05 11:34am
"RTN","PSOCPDUP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,130,132,192,207**;DEC 1997
"RTN","PSOCPDUP",3,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCPDUP",4,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOCPDUP",5,0)
 S $P(PSONULN,"-",79)="-",(STA,DNM)=""
"RTN","PSOCPDUP",6,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""  D  Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",7,0)
 .I STA="PENDING" D ^PSODRDU1 Q
"RTN","PSOCPDUP",8,0)
 .I STA="ZNONVA" D NVA^PSODRDU1 Q
"RTN","PSOCPDUP",9,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&('$D(^XUSEC("PSORPH",DUZ)))  Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",10,0)
 ..I $P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",11,0)
 ..I $P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",12,0)
 ..I '$P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",13,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&($D(^XUSEC("PSORPH",DUZ))) DUP Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",14,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(PSOSD(STA,DNM),"^",5),1,4),PSODRUG("NAME")'=$P(DNM,"^") S PSOCPCLS=1 D CLS K PSOCPCLS
"RTN","PSOCPDUP",15,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI")
"RTN","PSOCPDUP",16,0)
 I +$G(PSODRUG("NDF"))'=0 D
"RTN","PSOCPDUP",17,0)
 .Q:$G(PSORX("DFLG"))
"RTN","PSOCPDUP",18,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOCPDUP",19,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOCPDUP",20,0)
 .W !,"Now doing remote order checks. Please wait..."
"RTN","PSOCPDUP",21,0)
 .D REMOTE^PSOORRDI(PSODFN,PSODRUG("IEN"))
"RTN","PSOCPDUP",22,0)
 I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOCPDUP",23,0)
 I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOCPDUP",24,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI")
"RTN","PSOCPDUP",25,0)
 G EXIT
"RTN","PSOCPDUP",26,0)
DOSE ;I '$D(PSOCLOZ) G EXIT
"RTN","PSOCPDUP",27,0)
 S DIR(0)="N^12.5:3000:1",DIR("A")="CLOZAPINE dosage (mg/day) ? " D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) G EXIT
"RTN","PSOCPDUP",28,0)
 S PSOCD=X
"RTN","PSOCPDUP",29,0)
 I PSOCD#25=0,PSOCD'<12.5,PSOCD<900 S PSONEW("SAND")=PSOCD_"^"_$G(PSOLR)_"^"_$G(PSOLDT) G EXIT
"RTN","PSOCPDUP",30,0)
 I PSOCD#12.5 S DIR(0)="Y",DIR("B")="NO",DIR("A")=PSOCD_" is an unusual dose.  Are you sure " D ^DIR K DIR G EXIT:$D(DTOUT),EXIT:$D(DUOUT) I X'="Y" G DOSE
"RTN","PSOCPDUP",31,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" "
"RTN","PSOCPDUP",32,0)
 I PSOCD>900 S DIR(0)="Y",DIR("A")="Recommended maximum daily dose is 900. Are you sure " D ^DIR K DIR G EXIT:$D(DTOUT),EXIT:$D(DUOUT) I X'="Y" G DOSE
"RTN","PSOCPDUP",33,0)
 S PSONEW("SAND")=PSOCD_"^"_$G(PSOLR)_"^"_$G(PSOLDT)
"RTN","PSOCPDUP",34,0)
EXIT D ^PSOBUILD K CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSOCPDUP",35,0)
 Q
"RTN","PSOCPDUP",36,0)
DUP S:$P(PSOSD(STA,DNM),"^",2)<10!($P(PSOSD(STA,DNM),"^",2)=16) DUP=1 W !,PSONULN,!,$C(7),"DUPLICATE DRUG "_$P(DNM,"^")_" in Prescription: ",$P(^PSRX(+PSOSD(STA,DNM),0),"^")
"RTN","PSOCPDUP",37,0)
 S RXREC=+PSOSD(STA,DNM),MSG="Discontinued During Prescription Entry COPY - Duplicate Drug"
"RTN","PSOCPDUP",38,0)
DATA S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),SIG=$P($G(^PSRX(RXREC,"SIG")),"^"),$P(RX0,"^",15)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSOCPDUP",39,0)
 W !!,$J("Status: ",24) S J=RXREC D STAT^PSOFUNC W ST K RX0,RX2 W ?40,$J("Issued: ",24),$E(ISSD,4,5)_"/"_$E(ISSD,6,7)_"/"_$E(ISSD,2,3)
"RTN","PSOCPDUP",40,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSOCPDUP",41,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,54)
"RTN","PSOCPDUP",42,0)
 W !,$J("SIG: ",24) W $G(BSIG(1))
"RTN","PSOCPDUP",43,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSOCPDUP",44,0)
 K BSIG,PSREV
"RTN","PSOCPDUP",45,0)
 W !,$J("QTY: ",24)_$P(DUPRX0,"^",7),?40,$J("# of refills: ",24)_RFLS S PHYS=$S($D(^VA(200,+$P(DUPRX0,"^",4),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOCPDUP",46,0)
 W !,$J("Provider: ",24)_PHYS,?40,$J("Refills remaining: ",24),RFLS-$S($D(^PSRX(RXREC,1,0)):$P(^(0),"^",4),1:0)
"RTN","PSOCPDUP",47,0)
 S LSTFL=+^PSRX(RXREC,3) W !?40,$J("Last filled on: ",24)_$E(LSTFL,4,5)_"/"_$E(LSTFL,6,7)_"/"_$E(LSTFL,2,3),!?40,$J("Days Supply: ",24)_$P(DUPRX0,"^",8)
"RTN","PSOCPDUP",48,0)
 W !,PSONULN,! I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" Q
"RTN","PSOCPDUP",49,0)
ASKCAN I $P(PSOSD(STA,DNM),"^",2)>10,$P(PSOSD(STA,DNM),"^",2)'=16 Q
"RTN","PSOCPDUP",50,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR Q
"RTN","PSOCPDUP",51,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR Q
"RTN","PSOCPDUP",52,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(DUP) W !!,"Prescription "_$S(+$G(PSOSD(STA,DNM)):$P($G(^PSRX(+$G(PSOSD(STA,DNM)),0)),"^")_" ",1:"")_"is on Provider Hold, it cannot be discontinued.",! D  Q
"RTN","PSOCPDUP",53,0)
 .S PSORX("DFLG")=1 K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DUP
"RTN","PSOCPDUP",54,0)
 I $G(PSOCPCLS),$G(RXRECCOP) D PSOL^PSSLOCK(RXRECCOP) I '$G(PSOMSG) D  K PSOMSG,DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSOCPDUP",55,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2) Q
"RTN","PSOCPDUP",56,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX(RXRECCOP,0)),"^")
"RTN","PSOCPDUP",57,0)
 K PSOMSG S DIR("A")="Discontinue Rx # "_$P(^PSRX(+PSOSD(STA,DNM),0),"^"),DIR(0)="Y",DIR("?")="Enter Y to discontinue this Rx."
"RTN","PSOCPDUP",58,0)
 D ^DIR K DIR S DA=RXREC S ACT="Discontinued while entering new Rx"
"RTN","PSOCPDUP",59,0)
 I 'Y W $C(7)," -Prescription was not discontinued..." S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA="C" S:$G(DUP) PSORX("DFLG")=1 K DUP,CLS D  Q
"RTN","PSOCPDUP",60,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSOCPDUP",61,0)
 .D:$G(PSOCPCLS) ULRX
"RTN","PSOCPDUP",62,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(CLS) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! D ULRX K CLS,DUP,RXRECLOC S PSORX("DFLG")=1 H 2 Q
"RTN","PSOCPDUP",63,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New Rx Entry - DUPLICATE RX"),REA="C"
"RTN","PSOCPDUP",64,0)
 W !!,"Duplicate "_$S($G(CLS):"Class",1:"Drug")_" will be discontinued after the acceptance of the new order.",!
"RTN","PSOCPDUP",65,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D"
"RTN","PSOCPDUP",66,0)
 K CLS,DUP,PSOCPCLS Q
"RTN","PSOCPDUP",67,0)
CLS K DUP S CLS=1,MSG="Discontinued During New Prescription Entry - Duplicate Class" W !,PSONULN
"RTN","PSOCPDUP",68,0)
 W !?5,$C(7),"*** SAME CLASS *** OF DRUG IN RX #"_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" FOR "_$P(DNM,"^"),!,"CLASS: "_PSODRUG("VA CLASS")
"RTN","PSOCPDUP",69,0)
 S CAN=$P(PSOSD(STA,DNM),"^",2)'<11!($P(PSOSD(STA,DNM),"^",2)=1) S (RXREC,RXRECCOP)=+PSOSD(STA,DNM) S PSOELSE=$P(PSOPAR,"^",10) I PSOELSE D DATA
"RTN","PSOCPDUP",70,0)
 I 'PSOELSE S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DTOUT,DUOUT,DIRUT
"RTN","PSOCPDUP",71,0)
 K PSOELSE,RXRECCOP Q
"RTN","PSOCPDUP",72,0)
ULRX ;
"RTN","PSOCPDUP",73,0)
 I '$G(RXRECCOP) Q
"RTN","PSOCPDUP",74,0)
 D PSOUL^PSSLOCK(RXRECCOP)
"RTN","PSOCPDUP",75,0)
 Q
"RTN","PSODGDGI")
0^2^B54723266
"RTN","PSODGDGI",1,0)
PSODGDGI ;BIR/SAB - drug drug interaction checker ;4/14/93
"RTN","PSODGDGI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,27,48,130,144,132,188,207**;DEC 1997
"RTN","PSODGDGI",3,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSODGDGI",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSODGDGI",5,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODGDGI",6,0)
 ;External reference to DDIEX^PSNAPIS supported by DBIA 2574
"RTN","PSODGDGI",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSODGDGI",8,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSODGDGI",9,0)
 Q:$$DDIEX^PSNAPIS($P(PSODRUG("NDF"),"A"),$P(PSODRUG("NDF"),"A",2))
"RTN","PSODGDGI",10,0)
 N PSOICT S (CRIT,DRG,LSI,DGI,DGS,SER,SERS,STA,PSOICT)=""
"RTN","PSODGDGI",11,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""!($G(PSORX("DFLG")))  F  S DRG=$O(PSOSD(STA,DRG)) Q:DRG=""!($G(PSORX("DFLG")))  I $P(PSOSD(STA,DRG),"^",2)<10 D
"RTN","PSODGDGI",12,0)
 .Q:$P(PSOSD(STA,DRG),"^",7)']""
"RTN","PSODGDGI",13,0)
 .S NDF=$P(PSOSD(STA,DRG),"^",7)
"RTN","PSODGDGI",14,0)
 .;New logic to Loop All interactions and filter-up a critical if it exists
"RTN","PSODGDGI",15,0)
 .S IT=0,PSOICT=""
"RTN","PSODGDGI",16,0)
 .F  S IT=$O(^PS(56,"APD",NDF,PSODRUG("NDF"),IT)) Q:'IT  D
"RTN","PSODGDGI",17,0)
 ..Q:$$DDIEX^PSNAPIS($P(NDF,"A"),$P(NDF,"A",2))
"RTN","PSODGDGI",18,0)
 ..Q:$P(^PS(56,IT,0),"^",7)&($P(^PS(56,IT,0),"^",7)<DT)
"RTN","PSODGDGI",19,0)
 ..I 'PSOICT S PSOICT=IT Q
"RTN","PSODGDGI",20,0)
 ..I $P($G(^PS(56,IT,0)),"^",4)=1 S PSOICT=IT Q
"RTN","PSODGDGI",21,0)
 ..Q
"RTN","PSODGDGI",22,0)
 .I 'PSOICT Q
"RTN","PSODGDGI",23,0)
 .S IT=PSOICT
"RTN","PSODGDGI",24,0)
 .I STA="ZNONVA" S DNM=DRG W ! D NVA^PSODRDU1 K DNM,IT,PSOICT Q
"RTN","PSODGDGI",25,0)
 .D BLD Q:+$G(PSORX("DFLG"))
"RTN","PSODGDGI",26,0)
 .Q
"RTN","PSODGDGI",27,0)
 I '$D(^XUSEC("PSORPH",DUZ)),$G(DGI)]"" S:+CRIT PSONEW("STATUS")=4 W $C(7),!,"DRUG INTERACTON WITH RX #s: "_LSI,! K LSI,DRG,IT,NDF,PSOICT
"RTN","PSODGDGI",28,0)
 K IT
"RTN","PSODGDGI",29,0)
 I +$G(PSORX("DFLG")) Q
"RTN","PSODGDGI",30,0)
 I +$G(PSODRUG("NDF"))'=0 D
"RTN","PSODGDGI",31,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSODGDGI",32,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSODGDGI",33,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !,"Remote data not available - Only local order checks processed." D PAUSE^PSOORRD2 Q
"RTN","PSODGDGI",34,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSODGDGI",35,0)
 .K ^TMP($J,"DI"_PSODFN),^TMP($J,"DI")
"RTN","PSODGDGI",36,0)
 Q
"RTN","PSODGDGI",37,0)
TECH ;add tech entry to RX VERIFY file (#52.4)
"RTN","PSODGDGI",38,0)
 I +CRIT S PSODI=1,DIC="^PS(52.4,",DLAYGO=52.4,DIC(0)="L",(DINUM,X)=PSOX("IRXN"),DIC("DR")="1////"_PSODFN_";2////"_DUZ_";4///"_DT_";7///"_1_";7.1///"_SER_";7.2///"_DGI K DD,DO D FILE^DICN K DD,DO
"RTN","PSODGDGI",39,0)
 S:$G(DGS)'="" $P(^PSRX(PSOX("IRXN"),"DRI"),"^")=SERS,$P(^PSRX(PSOX("IRXN"),"DRI"),"^",2)=DGS  K PSODI,CRIT,DIC,DLAYGO,DINUM,DGI,DGS,SER,SERS Q
"RTN","PSODGDGI",40,0)
BLD I $D(^XUSEC("PSORPH",DUZ)) S PSORX("PHARM")=DUZ D PHARM Q
"RTN","PSODGDGI",41,0)
 S LSI=$P(^PSRX(+PSOSD(STA,DRG),0),"^")_"/"_$P(^PSDRUG($P(^(0),"^",6),0),"^")_","_LSI,DGI=$P(PSOSD(STA,DRG),"^")_","_DGI,SER=IT_","_SER I $P(PSOSD(STA,DRG),"^",9),$P(^PS(56,IT,0),"^",4)=1 S $P(^PSRX(+PSOSD(STA,DRG),"STA"),"^")=4
"RTN","PSODGDGI",42,0)
 I $P(^PS(56,IT,0),"^",4)=2 S SERS=IT_","_SERS,DGS=$P(PSOSD(STA,DRG),"^")_","_DGS
"RTN","PSODGDGI",43,0)
 S:$P(^PS(56,IT,0),"^",4)=1 CRIT=1 Q
"RTN","PSODGDGI",44,0)
PHARM ;pharmacist verification of drug interaction
"RTN","PSODGDGI",45,0)
 D PSOL^PSSLOCK($P(PSOSD(STA,DRG),"^")) I '$G(PSOMSG) D  K PSOMSG S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODGDGI",46,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2) D  Q
"RTN","PSODGDGI",47,0)
 ..W !,"Rx: "_$P($G(^PSRX($P(PSOSD(STA,DRG),"^"),0)),"^")_"    Drug: "_$P($G(^PSDRUG(+$P($G(^(0)),"^",6),0)),"^")
"RTN","PSODGDGI",48,0)
 ..W !,"which interacts with the drug you are entering!",!
"RTN","PSODGDGI",49,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX($P(PSOSD(STA,DRG),"^"),0)),"^")_",",!,"which interacts with the drug you are entering!",!
"RTN","PSODGDGI",50,0)
 S PSODGRLX=$P(PSOSD(STA,DRG),"^")
"RTN","PSODGDGI",51,0)
 S SER=^PS(56,IT,0),DIR("?",1)="Answer 'YES' if you DO want to "_$S($P(SER,"^",4)=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGI",52,0)
 S DIR("?")="       'NO' if you DON'T want to "_$S($P(SER,"^",4)=1:"continue processing",1:"enter an intervention for")_" this medication,"
"RTN","PSODGDGI",53,0)
 W $C(7),$C(7) S DIR("A",1)="***"_$S($P(SER,"^",4)=1:"CRITICAL",1:"SIGNIFICANT")_"*** "_"Drug Interaction with RX #"_$P(^PSRX($P(PSOSD(STA,DRG),"^"),0),"^"),DIR("A",2)="DRUG: "_$P(DRG,"^")
"RTN","PSODGDGI",54,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to "_$S($P(SER,"^",4)=1:"Continue? ",1:"Intervene? "),DIR("B")="Y" D ^DIR
"RTN","PSODGDGI",55,0)
 I 'Y,$P(SER,"^",4)=1 S PSORX("DFLG")=1,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODGDGI",56,0)
 I Y,$P(SER,"^",4)=1 S PSORX("INTERVENE")=1,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT G CRI Q
"RTN","PSODGDGI",57,0)
 I 'Y,$P(SER,"^",4)=2 K DIR,DTOUT,DIRUT,DIROUT,DUOUT D ULRX Q
"RTN","PSODGDGI",58,0)
 I Y,$P(SER,"^",4)=2 S PSORX("INTERVENE")=2,DGI="" K DIR,DTOUT,DIRUT,DIROUT,DUOUT
"RTN","PSODGDGI",59,0)
 D ULRX
"RTN","PSODGDGI",60,0)
 Q
"RTN","PSODGDGI",61,0)
CRI ;process new drug interactions entered by pharmacist
"RTN","PSODGDGI",62,0)
 K DIR G:$P(PSOSD(STA,DRG),"^",9) CRITN S DIR("A",1)="",DIR("A",2)="Do you want to Process medication",DIR("A")=PSODRUG("NAME")_": ",DIR(0)="SA^1:PROCESS;0:ABORT ORDER ENTRY",DIR("B")="P"
"RTN","PSODGDGI",63,0)
 S DIR("?",1)="Enter '1' or 'P' to Activate medication",DIR("?")="      '0' or 'A' to Abort Order Entry process" D ^DIR K X1,DIR I 'Y S PSORX("DFLG")=1,DGI="" K DTOUT,DIRUT,DIROUT,DUOUT,PSORX("INTERVENE") D ULRX Q
"RTN","PSODGDGI",64,0)
 I $P(SER,"^",4)=1 D
"RTN","PSODGDGI",65,0)
 .D SIG^XUSESIG I X1="" K PSORX("INTERVENE") S PSORX("DFLG")=1 Q
"RTN","PSODGDGI",66,0)
 .S PSORX("INTERVENE")=$P(SER,"^",4)
"RTN","PSODGDGI",67,0)
 K DUOUT,DTOUT,DIRUT,DIROUT D ULRX Q
"RTN","PSODGDGI",68,0)
CRITN ;process multiple new drug interactions
"RTN","PSODGDGI",69,0)
 K X1,DIR S DIR("A",1)="",DIR("A",2)="Do you want to: ",DIR("A",3)=" 1.  Delete NEW medication "_PSODRUG("NAME"),DIR("A",4)=" 2.  Cancel ACTIVE New Rx #"_$P(^PSRX($P(PSOSD(STA,DRG),"^"),0),"^")_" DRUG: "_$P(DRG,"^")
"RTN","PSODGDGI",70,0)
 S DIR("A",5)=" 3.  Delete 1 and Cancel 2",DIR("A")=" 4.  Continue ?: ",DIR(0)="SA^1:NEW MEDICATION;2:ACTIVE New Rx "_$P(DRG,"^")_";3:BOTH;4:CONTINUE"
"RTN","PSODGDGI",71,0)
 S DIR("?",1)="Enter '1' or 'N' to Delete New Medication and Dispense Rx #"_$P(^PSRX(+PSOSD(STA,DRG),0),"^")
"RTN","PSODGDGI",72,0)
 S DIR("?",2)="      '2' or 'A' to Cancel Active Rx #"_$P(^PSRX(+PSOSD(STA,DRG),0),"^")_" and Dispense New Rx"
"RTN","PSODGDGI",73,0)
 S DIR("?",3)="      '3' or 'B' to Delete 1 and Cancel 2",DIR("?")="      '4' or 'C' to do nothing to either Rx" D ^DIR K DIR
"RTN","PSODGDGI",74,0)
 I Y=1 S PSORX("DFLG")=1,DGI="",PSHLDDRG=PSODRUG("IEN") D  D ULRX Q
"RTN","PSODGDGI",75,0)
 .I $G(PSORXED) D  Q
"RTN","PSODGDGI",76,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) W $C(7)," ACTION NOT TAKEN!",! S PSORX("DFLG")=1 K PSORX("INTERVENE") Q
"RTN","PSODGDGI",77,0)
 ..S DA=$P(PSOLST(ORN),"^",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGI",78,0)
 ..K PSOSD($P(PSOLST(ORN),"^",3),PSODRUG("NAME")),DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGI",79,0)
 .S PSODRUG("IEN")=$P(^PSRX($P(PSOSD(STA,DRG),"^"),0),"^",6) D FULL^VALM1,^PSORXI
"RTN","PSODGDGI",80,0)
 .S PSODRUG("IEN")=PSHLDDRG,VALMBCK="R"
"RTN","PSODGDGI",81,0)
 .K DTOUT,DIRUT,DIROUT,DUOUT,PSHLDDRG
"RTN","PSODGDGI",82,0)
 .I $G(OR0) D
"RTN","PSODGDGI",83,0)
 ..D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGI",84,0)
 ...W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGI",85,0)
 ..D DC^PSOORFI2
"RTN","PSODGDGI",86,0)
 I Y=2 S (DA,PSOHOLDA)=+PSOSD(STA,DRG) D  D ULRX Q
"RTN","PSODGDGI",87,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGI",88,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGI",89,0)
 .D MESS,ENQ^PSORXDL
"RTN","PSODGDGI",90,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL
"RTN","PSODGDGI",91,0)
 .K PSOSD(STA,DRG),DTOUT,DIROUT,DIRUT,DUOUT,PSOHOLDA
"RTN","PSODGDGI",92,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S VALMBCK="R"
"RTN","PSODGDGI",93,0)
 I Y=3 S (DA,PSOHOLDA)=+PSOSD(STA,DRG) D  S VALMBCK="R"
"RTN","PSODGDGI",94,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) D  Q
"RTN","PSODGDGI",95,0)
 ..W $C(7)," ACTION NOT TAKEN!",! K PSORX("INTERVENE") S PSORX("DFLG")=1
"RTN","PSODGDGI",96,0)
 .S:$G(PSOSD) PSOSD=PSOSD-1 S PSORX("DFLG")=1 D MESS,ENQ^PSORXDL
"RTN","PSODGDGI",97,0)
 .I $G(OR0) D DC^PSOORFI2
"RTN","PSODGDGI",98,0)
 .S DA=PSOHOLDA D FULL^VALM1,EN1^PSORXI(.DA),PPL K PSOSD(STA,DRG),PSOHOLDA
"RTN","PSODGDGI",99,0)
 .I $G(PSORXED) D
"RTN","PSODGDGI",100,0)
 ..S DA=$P(PSOLST(ORN),"^",2) D MESS,ENQ^PSORXDL,FULL^VALM1
"RTN","PSODGDGI",101,0)
 ..K PSOSD($P(PSOLST(ORN),"^",3),PSODRUG("NAME")),DTOUT,DIROUT,DIRUT,DUOUT S:$G(PSOSD) PSOSD=PSOSD-1 S ZONE=1
"RTN","PSODGDGI",102,0)
 K DTOUT,DIROUT,DIRUT,DUOUT
"RTN","PSODGDGI",103,0)
 D ULRX
"RTN","PSODGDGI",104,0)
 Q
"RTN","PSODGDGI",105,0)
MESS W !!,"Canceling Rx: "_$P($G(^PSRX(DA,0)),"^")_"   "_"Drug: "_$P($G(^PSDRUG($P(^PSRX(DA,0),"^",6),0)),"^"),! Q
"RTN","PSODGDGI",106,0)
PPL F PSOSL=0:0 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  S PSOX2=PSOSL
"RTN","PSODGDGI",107,0)
 I $G(PSOX2) D
"RTN","PSODGDGI",108,0)
 .F PSOSL=0:1:PSOX2 S PSOSL=$O(PSORX("PSOL",PSOSL)) Q:'PSOSL  F ENT=1:1:$L(PSORX("PSOL",PSOSL),",") I $P(PSORX("PSOL",PSOSL),",",ENT)=$P(PSOSD(STA,DRG),"^") S PSOL(PSOSL,ENT)=""
"RTN","PSODGDGI",109,0)
 .F PSOL=0:0 S PSOL=$O(PSOL(PSOL)) Q:'PSOL  F ENT=0:0 S ENT=$O(PSOL(PSOL,ENT)) Q:'ENT  D
"RTN","PSODGDGI",110,0)
 ..I ENT=1,'$P(PSORX("PSOL",PSOL),",",2) K PSORX("PSOL",PSOL) Q
"RTN","PSODGDGI",111,0)
 ..I ENT=1,$P(PSORX("PSOL",PSOL),",",2) S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",2,99) Q
"RTN","PSODGDGI",112,0)
 ..S PSORX("PSOL",PSOL)=$P(PSORX("PSOL",PSOL),",",1,ENT-1)_","_$P(PSORX("PSOL",PSOL),",",ENT+1,99)
"RTN","PSODGDGI",113,0)
 K PSOX2,PSOSL,PSOL,ENT Q
"RTN","PSODGDGI",114,0)
ULRX ;
"RTN","PSODGDGI",115,0)
 I '$G(PSODGRLX) Q
"RTN","PSODGDGI",116,0)
 D PSOUL^PSSLOCK(PSODGRLX) K PSODGRLX
"RTN","PSODGDGI",117,0)
 Q
"RTN","PSODRDUP")
0^3^B49880475
"RTN","PSODRDUP",1,0)
PSODRDUP ;BIR/SAB - Dup drug class checker ;11/1/04 3:38pm
"RTN","PSODRDUP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,23,27,32,39,56,130,132,192,207**;DEC 1997
"RTN","PSODRDUP",3,0)
 ;
"RTN","PSODRDUP",4,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSODRDUP",5,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSODRDUP",6,0)
 S $P(PSONULN,"-",79)="-",(STA,DNM)="" K CLS
"RTN","PSODRDUP",7,0)
 F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""!$G(PSORX("DFLG"))  I $P(PSOSD(STA,DNM),"^")'=$G(PSORENW("OIRXN")) D  Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",8,0)
 .I STA="PENDING" D ^PSODRDU1 Q
"RTN","PSODRDUP",9,0)
 .I STA="ZNONVA" D NVA^PSODRDU1 Q
"RTN","PSODRDUP",10,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&('$D(^XUSEC("PSORPH",DUZ)))  Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",11,0)
 ..I $P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",12,0)
 ..I $P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",13,0)
 ..I '$P(PSOPAR,"^",2),'$P($G(PSOPAR),"^",16) D DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",14,0)
 .D:PSODRUG("NAME")=$P(DNM,"^")&($D(^XUSEC("PSORPH",DUZ))) DUP Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",15,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(PSOSD(STA,DNM),"^",5),1,4),PSODRUG("NAME")'=$P(DNM,"^") D CLS
"RTN","PSODRDUP",16,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI")
"RTN","PSODRDUP",17,0)
 I +$G(PSODRUG("NDF"))'=0 D
"RTN","PSODRDUP",18,0)
 .Q:$G(PSORX("DFLG"))
"RTN","PSODRDUP",19,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSODRDUP",20,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSODRDUP",21,0)
 .W !,"Now doing remote order checks. Please wait..."
"RTN","PSODRDUP",22,0)
 .D REMOTE^PSOORRDI(PSODFN,PSODRUG("IEN"))
"RTN","PSODRDUP",23,0)
 I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSODRDUP",24,0)
 I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSODRDUP",25,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI")
"RTN","PSODRDUP",26,0)
 G EXIT
"RTN","PSODRDUP",27,0)
DOSE ;I '$D(PSOCLOZ) G EXIT
"RTN","PSODRDUP",28,0)
 S DIR(0)="N^12.5:3000:1",DIR("A")="CLOZAPINE dosage (mg/day) ? " D ^DIR K DIR I $D(DIRUT) S (ANQX,ANQNO)=1 G EXIT
"RTN","PSODRDUP",29,0)
 S PSOCD=X
"RTN","PSODRDUP",30,0)
 I PSOCD#25=0,PSOCD'<12.5,PSOCD<900 S PSONEW("SAND")=PSOCD_"^"_$G(PSOLR)_"^"_$G(PSOLDT) G EXIT
"RTN","PSODRDUP",31,0)
 I PSOCD#12.5 S DIR(0)="Y",DIR("B")="NO",DIR("A")=PSOCD_" is an unusual dose.  Are you sure " D ^DIR K DIR G EXIT:$D(DIRUT) I 'Y G DOSE
"RTN","PSODRDUP",32,0)
 I PSOCD>900 S DIR(0)="Y",DIR("A")="Recommended maximum daily dose is 900. Are you sure " D ^DIR K DIR G EXIT:$D(DIRUT) I 'Y G DOSE
"RTN","PSODRDUP",33,0)
 S PSONEW("SAND")=PSOCD_"^"_$G(PSOLR)_"^"_$G(PSOLDT)
"RTN","PSODRDUP",34,0)
EXIT D ^PSOBUILD K CAN,DA,DIR,DNM,DUPRX0,ISSD,J,LSTFL,MSG,PHYS,PSOCLC,PSONULN,REA,RFLS,RX0,RX2,RXN,RXREC,ST,Y,ZZ,ACT,PSOCLOZ,PSOLR,PSOLDT,PSOCD,SIG
"RTN","PSODRDUP",35,0)
 Q
"RTN","PSODRDUP",36,0)
DUP S:$P(PSOSD(STA,DNM),"^",2)<10!($P(PSOSD(STA,DNM),"^",2)=16) DUP=1 W !,PSONULN,!,$C(7),"Duplicate Drug "_$P(DNM,"^")_" in Prescription: ",$P(^PSRX(+PSOSD(STA,DNM),0),"^")
"RTN","PSODRDUP",37,0)
 S RXREC=+PSOSD(STA,DNM),MSG="Discontinued During "_$S('$G(PSONV):"New Prescription Entry",1:"Verification")_" - Duplicate Drug"
"RTN","PSODRDUP",38,0)
DATA S DUPRX0=^PSRX(RXREC,0),RFLS=$P(DUPRX0,"^",9),ISSD=$P(^PSRX(RXREC,0),"^",13),RX0=DUPRX0,RX2=^PSRX(RXREC,2),$P(RX0,"^",15)=+$G(^PSRX(RXREC,"STA"))
"RTN","PSODRDUP",39,0)
 S RXRECLOC=$G(RXREC)
"RTN","PSODRDUP",40,0)
 W !!,$J("Status: ",24) S J=RXREC D STAT^PSOFUNC W ST K RX0,RX2 W ?40,$J("Issued: ",24),$E(ISSD,4,5)_"/"_$E(ISSD,6,7)_"/"_$E(ISSD,2,3)
"RTN","PSODRDUP",41,0)
 S DA=RXREC D ^PSOCMOPA I $G(PSOCMOP)]"" D  K CMOP,PSOTRANS,PSOREL
"RTN","PSODRDUP",42,0)
 .S PSOTRANS=$E($P(PSOCMOP,"^",2),4,5)_"/"_$E($P(PSOCMOP,"^",2),6,7)_"/"_$E($P(PSOCMOP,"^",2),2,3)
"RTN","PSODRDUP",43,0)
 .S PSOREL=$S(CMOP("L")=0:$P($G(^PSRX(DA,2)),"^",13),1:$P(^PSRX(DA,1,CMOP("L"),0),"^",18))
"RTN","PSODRDUP",44,0)
 .S PSOREL=$E(PSOREL,4,5)_"/"_$E(PSOREL,6,7)_"/"_$E(PSOREL,2,3)_"@"_$E($P(PSOREL,".",2),1,4)
"RTN","PSODRDUP",45,0)
 .W !,$J("CMOP Status: ",24)_$S($P(PSOCMOP,"^")=0!($P(PSOCMOP,"^")=2):"Transmitted to on "_PSOTRANS,$P(PSOCMOP,"^")=1:"Released by CMOP on "_PSOREL,1:"Not Dispensed")
"RTN","PSODRDUP",46,0)
 K FSIG,BSIG I $P($G(^PSRX(RXREC,"SIG")),"^",2) D FSIG^PSOUTLA("R",RXREC,54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSODRDUP",47,0)
 K FSIG,PSREV I '$P($G(^PSRX(RXREC,"SIG")),"^",2) D EN2^PSOUTLA1(RXREC,54)
"RTN","PSODRDUP",48,0)
 W !,$J("SIG: ",24) W $G(BSIG(1))
"RTN","PSODRDUP",49,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSODRDUP",50,0)
 K BSIG,PSREV
"RTN","PSODRDUP",51,0)
 W !,$J("QTY: ",24)_$P(DUPRX0,"^",7),?40,$J("# of refills: ",24)_RFLS S PHYS=$S($D(^VA(200,+$P(DUPRX0,"^",4),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSODRDUP",52,0)
 W !,$J("Provider: ",24)_PHYS,?40,$J("Refills remaining: ",24),RFLS-$S($D(^PSRX(RXREC,1,0)):$P(^(0),"^",4),1:0)
"RTN","PSODRDUP",53,0)
 S LSTFL=+^PSRX(RXREC,3) W !?40,$J("Last filled on: ",24)_$E(LSTFL,4,5)_"/"_$E(LSTFL,6,7)_"/"_$E(LSTFL,2,3),!?40,$J("Days Supply: ",24)_$P(DUPRX0,"^",8)
"RTN","PSODRDUP",54,0)
 W !,PSONULN,! I $P($G(^PS(53,+$P($G(PSORX("PATIENT STATUS")),"^"),0)),"^")["AUTH ABS"!($G(PSORX("PATIENT STATUS"))["AUTH ABS")&'$P(PSOPAR,"^",5) W !,"PATIENT ON AUTHORIZED ABSENCE!" K RXRECLOC Q
"RTN","PSODRDUP",55,0)
ASKCAN I $P(PSOSD(STA,DNM),"^",2)>10,$P(PSOSD(STA,DNM),"^",2)'=16 K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DTOUT,DUOUT,DIRUT,RXRECLOC Q
"RTN","PSODRDUP",56,0)
 I '$P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODRDUP",57,0)
 I $P(PSOPAR,"^",2),'$P(PSOPAR,"^",16),'$D(^XUSEC("PSORPH",DUZ)),'$G(CLS) S PSORX("DFLG")=1 K RXRECLOC Q
"RTN","PSODRDUP",58,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(DUP) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! K DUP,RXRECLOC S PSORX("DFLG")=1 Q
"RTN","PSODRDUP",59,0)
 D PSOL^PSSLOCK(RXRECLOC) I '$G(PSOMSG) D  K PSOMSG,DIR,DUP,RXRECLOC S DIR("A")="Press Return to continue",DIR(0)="E" D ^DIR K DIR S PSORX("DFLG")=1 Q
"RTN","PSODRDUP",60,0)
 .I $P($G(PSOMSG),"^",2)'="" W !!,$P(PSOMSG,"^",2),! Q
"RTN","PSODRDUP",61,0)
 .W !!,"Another person is editing Rx "_$P($G(^PSRX(RXRECLOC,0)),"^"),!
"RTN","PSODRDUP",62,0)
 K PSOMSG S DIR("A")=$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstate",1:"Discontinue")_" RX # "_$P(^PSRX(+PSOSD(STA,DNM),0),"^"),DIR(0)="Y",DIR("?")="Enter Y to "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstate",1:"discontinue")_" this RX."
"RTN","PSODRDUP",63,0)
 D ^DIR K DIR S DA=RXREC S ACT=$S($D(SPCANC):"Reinstated during Rx cancel.",1:$S($P(PSOSD(STA,DNM),"^",2)=12:"Reinstated",1:"Discontinued")_" while "_$S('$G(PSONV):"entering",1:"verifying")_" new RX")
"RTN","PSODRDUP",64,0)
 D CMOP^PSOUTL I $G(CMOP("S"))="L" W !,"A CMOP Rx cannot be discontinued during transmission!",! S Y=0 K CMOP
"RTN","PSODRDUP",65,0)
 I 'Y W $C(7)," -Prescription was not "_$S($P(PSOSD(STA,DNM),"^",2)=12:"reinstated",1:"discontinued")_"..." D  Q
"RTN","PSODRDUP",66,0)
 .S:'$D(PSOCLC) PSOCLC=DUZ S MSG=ACT,REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C") S:$G(DUP) PSORX("DFLG")=1 K DUP D ULRX K RXRECLOC
"RTN","PSODRDUP",67,0)
 .I $D(^TMP("PSORXDC",$J,RXREC,0)) K ^TMP("PSORXDC",$J,RXREC,0)
"RTN","PSODRDUP",68,0)
 I $P(PSOSD(STA,DNM),"^",2)=16,$G(CLS) W !!,"Prescription "_$P($G(^PSRX(+$G(RXRECLOC),0)),"^")_" is on Provider Hold, it cannot be discontinued.",! D ULRX K CLS,DUP,RXRECLOC S PSORX("DFLG")=1 H 2 Q
"RTN","PSODRDUP",69,0)
 S PSOCLC=DUZ,MSG=$S($G(MSG)]"":MSG,1:ACT_" During New RX "_$S('$G(PSONV):"Entry",1:"Verification")_" - Duplicate Rx"),REA=$S($P(PSOSD(STA,DNM),"^",2)=12:"R",1:"C")
"RTN","PSODRDUP",70,0)
 W !!,"Duplicate "_$S($G(CLS):"Class",1:"Drug")_" will be discontinued after the acceptance of the new order.",!
"RTN","PSODRDUP",71,0)
 S ^TMP("PSORXDC",$J,RXREC,0)="52^"_DA_"^"_MSG_"^"_REA_"^"_ACT_"^"_STA_"^"_DNM,PSONOOR="D"
"RTN","PSODRDUP",72,0)
 K RXRECLOC,DUP,CLS,PSONOOR Q
"RTN","PSODRDUP",73,0)
CLS K DUP
"RTN","PSODRDUP",74,0)
 I $E($G(PSODRUG("VA CLASS")),1,2)="HA",$E($P($G(PSOSD(STA,DNM)),"^",5),1,2)="HA" K PSOELSE Q
"RTN","PSODRDUP",75,0)
 S CLS=1,MSG="Discontinued During "_$S('$G(PSONV):"New Prescription Entry",1:"Verification")_" - Duplicate Class" W !,PSONULN
"RTN","PSODRDUP",76,0)
 W !?5,$C(7),"*** SAME CLASS *** OF DRUG IN RX #"_$P(^PSRX(+PSOSD(STA,DNM),0),"^")_" FOR "_$P(DNM,"^"),!,"CLASS: "_PSODRUG("VA CLASS")
"RTN","PSODRDUP",77,0)
 S CAN=$P(PSOSD(STA,DNM),"^",2)'<11!($P(PSOSD(STA,DNM),"^",2)=1) S RXREC=+PSOSD(STA,DNM) I $P($G(PSOPAR),"^",10) D DATA Q
"RTN","PSODRDUP",78,0)
 E  W !,PSONULN K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR,DTOUT,DUOUT,DIRUT
"RTN","PSODRDUP",79,0)
 K PSOELSE Q
"RTN","PSODRDUP",80,0)
ULRX ;
"RTN","PSODRDUP",81,0)
 I '$G(RXRECLOC) Q
"RTN","PSODRDUP",82,0)
 D PSOUL^PSSLOCK(RXRECLOC)
"RTN","PSODRDUP",83,0)
 Q
"RTN","PSODRDUP",84,0)
 ;
"RTN","PSODRG")
0^7^B24416952
"RTN","PSODRG",1,0)
PSODRG ;IHS/DSD/JCM-ORDER ENTRY DRUG SELECTION ;03/30/93
"RTN","PSODRG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,23,36,53,54,46,112,139,207**;DEC 1997
"RTN","PSODRG",3,0)
 ;External reference ^PSDRUG supported by DBIA 221
"RTN","PSODRG",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSODRG",5,0)
 ;External reference to PSSDIN supported by DBIA 3166
"RTN","PSODRG",6,0)
 ;----------------------------------------------------------
"RTN","PSODRG",7,0)
START ;
"RTN","PSODRG",8,0)
 S (PSONEW("DFLG"),PSONEW("FIELD"),PSODRG("QFLG"))=0
"RTN","PSODRG",9,0)
 D SELECT G:$G(PSORXED("DFLG")) END ; Select Drug
"RTN","PSODRG",10,0)
 I $G(PSORX("EDIT"))]"",'PSONEW("FIELD") D TRADE
"RTN","PSODRG",11,0)
 G:PSONEW("DFLG")!(PSODRG("QFLG"))!($G(PSORXED("DFLG"))) END
"RTN","PSODRG",12,0)
 D SET ; Set various drug information
"RTN","PSODRG",13,0)
 D NFI ; Display dispense drug/orderable item text
"RTN","PSODRG",14,0)
 D:'$G(PSOEDIT) POST I $G(PSORX("DFLG")) S PSONEW("DFLG")=1 K:'$G(PSORX("EDIT")) PSORX("DFLG") ; Do any post selection action
"RTN","PSODRG",15,0)
END ;D EOJ
"RTN","PSODRG",16,0)
 Q
"RTN","PSODRG",17,0)
 ;------------------------------------------------------------
"RTN","PSODRG",18,0)
 ;
"RTN","PSODRG",19,0)
SELECT ;
"RTN","PSODRG",20,0)
 K:'$G(PSORXED) CLOZPAT
"RTN","PSODRG",21,0)
 K DIC,X,Y,PSODRUG("TRADE NAME") S:$G(POERR)&($P($G(OR0),"^",9)) Y=$P(^PSDRUG($P(OR0,"^",9),0),"^")
"RTN","PSODRG",22,0)
 I $G(PSODRUG("IEN"))]"" S Y=PSODRUG("NAME"),PSONEW("OLD VAL")=PSODRUG("IEN")
"RTN","PSODRG",23,0)
 W !,"DRUG: "_$S($G(Y)]"":Y_"// ",1:"") R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSODRG",24,0)
 I X="",$G(Y)]"" S:Y X=Y S:'X X=$G(PSODRUG("IEN")) S:X X="`"_X
"RTN","PSODRG",25,0)
 G:X="" SELECT
"RTN","PSODRG",26,0)
 I X?1."?" W !!,"Answer with DRUG NUMBER, or GENERIC NAME, or VA PRODUCT NAME, or",!,"NATIONAL DRUG CLASS, or SYNONYM" G SELECT
"RTN","PSODRG",27,0)
 I $G(PSORXED),X["^" S PSORXED("DFLG")=1 G SELECTX
"RTN","PSODRG",28,0)
 I X="^"!(X["^^")!($D(DTOUT)) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",29,0)
 I '$G(POERR),X[U,$L(X)>1 S PSODIR("FLD")=PSONEW("FLD") D JUMP^PSODIR1 S:$G(PSODIR("FIELD")) PSONEW("FIELD")=PSODIR("FIELD") K PSODIR S PSODRG("QFLG")=1 G SELECTX
"RTN","PSODRG",30,0)
 S DIC=50,DIC(0)="EMQZVT",DIC("T")="",D="B^C^VAPN^VAC"
"RTN","PSODRG",31,0)
 S DIC("S")="I $S('$D(^PSDRUG(+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0),$S($P($G(^PSDRUG(+Y,2)),""^"",3)'[""O"":0,1:1),$D(^PSDRUG(""ASP"",+$G(^(2)),+Y))"
"RTN","PSODRG",32,0)
 D MIX^DIC1 K DIC,D
"RTN","PSODRG",33,0)
 I $D(DTOUT) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",34,0)
 I $D(DUOUT) K DUOUT G SELECT
"RTN","PSODRG",35,0)
 I Y<0 G SELECT
"RTN","PSODRG",36,0)
 S:$G(PSONEW("OLD VAL"))=+Y&('$G(PSOEDIT)) PSODRG("QFLG")=1
"RTN","PSODRG",37,0)
 K PSOY S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSODRG",38,0)
 I $P(PSOY(0),"^")="OTHER DRUG"!($P(PSOY(0),"^")="OUTSIDE DRUG") D TRADE
"RTN","PSODRG",39,0)
SELECTX K X,Y,DTOUT,DUOUT,PSONEW("OLD VAL")
"RTN","PSODRG",40,0)
 Q
"RTN","PSODRG",41,0)
 ;
"RTN","PSODRG",42,0)
TRADE ;
"RTN","PSODRG",43,0)
 K DIR,DIC,DA,X,Y
"RTN","PSODRG",44,0)
 S DIR(0)="52,6.5" S:$G(PSOTRN)]"" DIR("B")=$G(PSOTRN) D ^DIR K DIR,DIC
"RTN","PSODRG",45,0)
 I X="@" S Y=X K DIRUT
"RTN","PSODRG",46,0)
 I $D(DIRUT) S:$D(DUOUT)!$D(DTOUT)&('$D(PSORX("EDIT"))) PSONEW("DFLG")=1 G TRADEX
"RTN","PSODRG",47,0)
 S PSODRUG("TRADE NAME")=Y
"RTN","PSODRG",48,0)
TRADEX I $G(PSORXED("DFLG")),$D(DIRUT) S PSORXED("DFLG")=1
"RTN","PSODRG",49,0)
 K DIRUT,DTOUT,DUOUT,X,Y,DA,DR,DIE
"RTN","PSODRG",50,0)
 Q
"RTN","PSODRG",51,0)
SET ;
"RTN","PSODRG",52,0)
 N STAT S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2)
"RTN","PSODRG",53,0)
 S PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSODRG",54,0)
 S:+$G(^PSDRUG(+PSOY,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSODRG",55,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSODRG",56,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3)
"RTN","PSODRG",57,0)
 S PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSODRG",58,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5)
"RTN","PSODRG",59,0)
 S PSODRUG("NDC")=$P($G(^PSDRUG(+PSOY,2)),"^",4)
"RTN","PSODRG",60,0)
 S PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSODRG",61,0)
 G:$G(^PSDRUG(+PSOY,660))']"" SETX
"RTN","PSODRG",62,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660))
"RTN","PSODRG",63,0)
 S PSODRUG("COST")=$P($G(PSOX1),"^",6)
"RTN","PSODRG",64,0)
 S PSODRUG("UNIT")=$P($G(PSOX1),"^",8)
"RTN","PSODRG",65,0)
 S PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSODRG",66,0)
SETX K PSOX1,PSOY
"RTN","PSODRG",67,0)
 Q
"RTN","PSODRG",68,0)
NFI ;display restriction/guidelines
"RTN","PSODRG",69,0)
 D EN^PSSDIN(PSODRUG("OI"),PSODRUG("IEN")) S NFI=$$PROMPT^PSSDIN
"RTN","PSODRG",70,0)
 I NFI]"","ODY"[NFI D TD^PSONFI
"RTN","PSODRG",71,0)
 K NFI Q
"RTN","PSODRG",72,0)
POST ;order checks
"RTN","PSODRG",73,0)
 K PSORX("INTERVENE") N STAT,SIG,PTR,NDF,VAP S PSORX("DFLG")=0
"RTN","PSODRG",74,0)
 D ^PSOBUILD
"RTN","PSODRG",75,0)
 D @$S($G(COPY):"^PSOCPDUP",1:"^PSODRDUP") ; Set PSORX("DFLG")=1 if process to stop
"RTN","PSODRG",76,0)
 Q:$G(PSORX("DFLG"))
"RTN","PSODRG",77,0)
 W:$G(PSOFIN)']"" !,"Now doing drug interaction and allergy checks.  Please wait...",!
"RTN","PSODRG",78,0)
 D ^PSODGDGI
"RTN","PSODRG",79,0)
 I $G(PSORX("INTERVENE"))]"" D FULL^VALM1,^PSORXI S VALMBCK="R"
"RTN","PSODRG",80,0)
 G:PSORX("DFLG") POSTX
"RTN","PSODRG",81,0)
 D:$P($G(^PSDRUG(PSODRUG("IEN"),"CLOZ1")),"^")]"" CLOZ G:PSORX("DFLG") POSTX
"RTN","PSODRG",82,0)
 K PSORX("INTERVENE")
"RTN","PSODRG",83,0)
 I $D(PSODRUG("NDF")) S NDF=$P(PSODRUG("NDF"),"A"),VAP=$P(PSODRUG("NDF"),"A",2),PTR=NDF_"."_VAP
"RTN","PSODRG",84,0)
 I $G(NDF) D CHK^PSODGAL(PSODFN,"DR",PTR) K NDF,VAP,PTR
"RTN","PSODRG",85,0)
 I $P($G(PSODRUG("NDF")),"A")=0 D CHK1^PSODGAL(PSODFN)
"RTN","PSODRG",86,0)
 I $D(PSODRUG("VA CLASS")) D CLASS^PSODGAL
"RTN","PSODRG",87,0)
POSTX ;
"RTN","PSODRG",88,0)
 K PSORX("INTERVENE"),DA
"RTN","PSODRG",89,0)
 Q
"RTN","PSODRG",90,0)
 ;
"RTN","PSODRG",91,0)
EOJ ;
"RTN","PSODRG",92,0)
 K PSODRG
"RTN","PSODRG",93,0)
 Q
"RTN","PSODRG",94,0)
 ;
"RTN","PSODRG",95,0)
CLOZ ;
"RTN","PSODRG",96,0)
 S ANQRTN=$P(^PSDRUG(PSODRUG("IEN"),"CLOZ1"),"^"),ANQX=0
"RTN","PSODRG",97,0)
 S P(5)=PSODRUG("IEN"),DFN=PSODFN,X=ANQRTN
"RTN","PSODRG",98,0)
 X ^%ZOSF("TEST") I  D @("^"_ANQRTN) S:$G(ANQX) PSORX("DFLG")=1
"RTN","PSODRG",99,0)
 K P(5),ANQRTN,ANQX,X
"RTN","PSODRG",100,0)
 Q
"RTN","PSODRG",101,0)
EN(DRG) ;returns lab test identified for clozapine order checking
"RTN","PSODRG",102,0)
 K LAB I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")'="PSOCLO1" S LAB("NOT")=0 Q
"RTN","PSODRG",103,0)
 I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSODRG",104,0)
 .S (CNT,I)=0 F  S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  S CNT=$G(CNT)+1
"RTN","PSODRG",105,0)
 .I CNT'=2 S LAB("BAD TEST")=0 K CNT Q
"RTN","PSODRG",106,0)
 .K CNT F I=0:0 S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  D
"RTN","PSODRG",107,0)
 ..S LABT=$S($P(^PSDRUG(DRG,"CLOZ2",I,0),"^",4)=1:"WBC",1:"ANC"),LAB(LABT)=$P(^PSDRUG(DRG,"CLOZ2",I,0),"^")_"^"_$P(^(0),"^",3)_"^"_$P(^(0),"^",4)
"RTN","PSODRG",108,0)
 K LABT,I
"RTN","PSODRG",109,0)
 Q
"RTN","PSOORDRG")
0^4^B41745329
"RTN","PSOORDRG",1,0)
PSOORDRG ;BIR/SAB - order entry drug selection ;11/13/97
"RTN","PSOORDRG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,29,49,46,81,105,134,144,132,188,207**;DEC 1997
"RTN","PSOORDRG",3,0)
 ;External references to ^PSJORUT2 supported by DBIA 2376
"RTN","PSOORDRG",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORDRG",5,0)
 ;External reference to ^PS(50.605 supported by DBIA 696
"RTN","PSOORDRG",6,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORDRG",7,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOORDRG",8,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOORDRG",9,0)
 ;External reference to ^PS(50.416 supported by DBIA 692
"RTN","PSOORDRG",10,0)
 ;External reference to DDIEX^PSNAPIS supported by DBIA 2574
"RTN","PSOORDRG",11,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOORDRG",12,0)
EN(PSODFN,DREN) ;
"RTN","PSOORDRG",13,0)
 K ^TMP($J,"DI"),^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"_PSODFN),PSOPHI S INDX=0
"RTN","PSOORDRG",14,0)
 ;build patient's drug profile outpat/inpat/non-va
"RTN","PSOORDRG",15,0)
 D BLD,ENCHK^PSJORUT2(PSODFN,.INDX),NVA
"RTN","PSOORDRG",16,0)
 ;collect drug info
"RTN","PSOORDRG",17,0)
DRG ;S X=DREN,DIC="^PSDRUG(",DIC(0)="MQNZO" D ^DIC K DIC,PSOY Q:Y<1  S PSOY=Y,PSOY(0)=Y(0) K X,Y
"RTN","PSOORDRG",18,0)
 N PSOICT S PSOICT=""
"RTN","PSOORDRG",19,0)
 S PSOY=DREN_"^"_$P($G(^PSDRUG(DREN,0)),"^"),PSOY(0)=$G(^PSDRUG(DREN,0)) K X,Y
"RTN","PSOORDRG",20,0)
 S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2),PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSOORDRG",21,0)
 S:+$G(^PSDRUG(+PSOY,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSOORDRG",22,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORDRG",23,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOORDRG",24,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5),PSODRUG("NDC")=$P($G(^PSDRUG(+PSOY,2)),"^",4)
"RTN","PSOORDRG",25,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660)),PSODRUG("COST")=$P($G(PSOX1),"^",6),PSODRUG("UNIT")=$P($G(PSOX1),"^",8),PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSOORDRG",26,0)
 K PSOX1,PSOY Q:$G(POERR)
"RTN","PSOORDRG",27,0)
 ;dup drug/class check
"RTN","PSOORDRG",28,0)
 S DNM=0 F  S DNM=$O(^TMP($J,"ORDERS",DNM)) Q:'DNM  D
"RTN","PSOORDRG",29,0)
 .S DRNM=$P(^TMP($J,"ORDERS",DNM),"^",3)
"RTN","PSOORDRG",30,0)
 .I PSODRUG("NAME")=DRNM S DD=$G(DD)+1,^TMP($J,"DD",DD,0)=PSODRUG("IEN")_"^"_PSODRUG("NAME")_"^"_$P(^TMP($J,"ORDERS",DNM),"^",4)_"^"_$P(^(DNM),"^",5) Q:'$G(PSOPHI)
"RTN","PSOORDRG",31,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(^TMP($J,"ORDERS",DNM),"^"),1,4),DRNM'=PSODRUG("NAME") D
"RTN","PSOORDRG",32,0)
 ..I $E(PSODRUG("VA CLASS"),1,2)="HA",$E($P(^TMP($J,"ORDERS",DNM),"^"),1,2)="HA" Q
"RTN","PSOORDRG",33,0)
 ..S PSODC=$O(^PS(50.605,"B",PSODRUG("VA CLASS"),0)) Q:'PSODC
"RTN","PSOORDRG",34,0)
 ..S DC=$G(DC)+1,^TMP($J,"DC",DC,0)=PSODRUG("VA CLASS")
"RTN","PSOORDRG",35,0)
 ..S PSODC=$P(^PS(50.605,PSODC,0),"^",2),^TMP($J,"DC",DC,0)=^TMP($J,"DC",DC,0)_"^"_PSODC_"^"_$O(^PSDRUG("B",DRNM,0))_"^"_DRNM_"^"_$P(^TMP($J,"ORDERS",DNM),"^",4)_"^"_$P(^(DNM),"^",5)
"RTN","PSOORDRG",36,0)
 ;drug interaction check
"RTN","PSOORDRG",37,0)
 S DRG=0
"RTN","PSOORDRG",38,0)
 F  S DRG=$O(^TMP($J,"ORDERS",DRG)) Q:'DRG  S NDF=$P(^TMP($J,"ORDERS",DRG),"^",2) D
"RTN","PSOORDRG",39,0)
 .S IT=0,PSOICT=""
"RTN","PSOORDRG",40,0)
 .F  S IT=$O(^PS(56,"APD",NDF,PSODRUG("NDF"),IT)) Q:'IT  D
"RTN","PSOORDRG",41,0)
 ..Q:$$DDIEX^PSNAPIS($P(NDF,"A"),$P(NDF,"A",2))
"RTN","PSOORDRG",42,0)
 ..Q:$$DDIEX^PSNAPIS($P(PSODRUG("NDF"),"A"),$P(PSODRUG("NDF"),"A",2))
"RTN","PSOORDRG",43,0)
 ..Q:$P(^PS(56,IT,0),"^",7)&($P(^PS(56,IT,0),"^",7)<DT)
"RTN","PSOORDRG",44,0)
 ..I 'PSOICT S PSOICT=IT Q
"RTN","PSOORDRG",45,0)
 ..I $P($G(^PS(56,IT,0)),"^",4)=1 S PSOICT=IT Q
"RTN","PSOORDRG",46,0)
 ..Q
"RTN","PSOORDRG",47,0)
 .I 'PSOICT Q
"RTN","PSOORDRG",48,0)
 .S IT=PSOICT
"RTN","PSOORDRG",49,0)
 .S DRNM=$P(^TMP($J,"ORDERS",DRG),"^",3),ORN=$P(^(DRG),"^",4),RXN=$P(^(DRG),"^",5)
"RTN","PSOORDRG",50,0)
 .S DI=$G(DI)+1,^TMP($J,"DI",DI,0)=$O(^PSDRUG("B",DRNM,0))_"^"_DRNM_"^"_IT_"^"_$S($P(^PS(56,IT,0),"^",4)=1:"CRITICAL",1:"SIGNIFICANT")_"^"
"RTN","PSOORDRG",51,0)
 .S ^TMP($J,"DI",DI,0)=^TMP($J,"DI",DI,0)_$P(^PS(50.416,$P(^PS(56,IT,0),"^",2),0),"^")_"^"_$P(^PS(50.416,$P(^PS(56,IT,0),"^",3),0),"^")_"^"_ORN_"^"_RXN
"RTN","PSOORDRG",52,0)
 I +$G(PSODRUG("NDF"))'=0 D
"RTN","PSOORDRG",53,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOORDRG",54,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOORDRG",55,0)
 .D REMOTE^PSOORRDI(PSODFN,DREN)
"RTN","PSOORDRG",56,0)
 .K ^TMP($J,"DI"_PSODFN) ;THIS LEVEL ONLY NEEDED FOR BACKDOOR OUTPATIENT PHARMACY CHECKS
"RTN","PSOORDRG",57,0)
 Q:$G(PSOPHI)
"RTN","PSOORDRG",58,0)
EXIT K ^TMP($J,"ORDERS"),DFN,DA,DNM,DUPRX0,RX,Y,ZZ,PSOCLOZ,PSOY,DRG,DNM,DD,DI,DC,IT,PSODRUG,PSOY,ORN,DRNM
"RTN","PSOORDRG",59,0)
 K PSOX,EXPDT,PSODRUG0,PSORX0,PSORX2,PSORX3,PSOST0,PSOVACL,X,Y,X1,X2,RXN
"RTN","PSOORDRG",60,0)
 Q
"RTN","PSOORDRG",61,0)
BLD K ^TMP($J,"ORDERS") I '$D(PSODFN)!('$D(DT)) G EXIT
"RTN","PSOORDRG",62,0)
 S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X D BUILD G GETX
"RTN","PSOORDRG",63,0)
 Q
"RTN","PSOORDRG",64,0)
BUILD ;build profiles
"RTN","PSOORDRG",65,0)
 S EXPDT=PSODTCUT-1,RX=0
"RTN","PSOORDRG",66,0)
 F  S EXPDT=$O(^PS(55,PSODFN,"P","A",EXPDT)) Q:'EXPDT  F  S RX=$O(^PS(55,PSODFN,"P","A",EXPDT,RX)) Q:'RX  I $D(^PSRX(RX,0)) D GET
"RTN","PSOORDRG",67,0)
 S EN=0
"RTN","PSOORDRG",68,0)
 F PSOEN=0:0 S PSOEN=$O(^PS(52.41,"AOR",PSODFN,PSOEN)) Q:'PSOEN  D
"RTN","PSOORDRG",69,0)
 .F  S EN=$O(^PS(52.41,"AOR",PSODFN,PSOEN,EN)) Q:'EN  D
"RTN","PSOORDRG",70,0)
 ..S PSOOI=^PS(52.41,EN,0) I $P(PSOOI,"^",3)'="DC"&($P(PSOOI,"^",3)'="DE") D:'$P(^PS(52.41,EN,0),"^",9) BLDOI I $P(^PS(52.41,EN,0),"^",9) S PSODD=+$P(PSOOI,"^",9) D SETTMP
"RTN","PSOORDRG",71,0)
 D BUILDX
"RTN","PSOORDRG",72,0)
 Q
"RTN","PSOORDRG",73,0)
 ;
"RTN","PSOORDRG",74,0)
BLDOI ;If no DD/non-standard dose, get all drugs for OI
"RTN","PSOORDRG",75,0)
 N PSOI S PSOI=$P(PSOOI,"^",8) Q:'PSOOI
"RTN","PSOORDRG",76,0)
 S PSODD="" F  S PSODD=$O(^PSDRUG("ASP",PSOI,PSODD)) Q:'PSODD  D SETTMP
"RTN","PSOORDRG",77,0)
 Q
"RTN","PSOORDRG",78,0)
 ;
"RTN","PSOORDRG",79,0)
SETTMP ;Create ^TMP($J,"ORDERS"
"RTN","PSOORDRG",80,0)
 Q:$P(PSOOI,"^",3)="RF"
"RTN","PSOORDRG",81,0)
 S DRG=$S(PSODD:$P($G(^PSDRUG(PSODD,0)),"^"),1:"") Q:DRG']""
"RTN","PSOORDRG",82,0)
 S INDX=$G(INDX)+1,^TMP($J,"ORDERS",INDX)=$S(PSODD:$P(^PSDRUG(PSODD,0),"^",2),1:"")_"^"_$S($G(^PSDRUG(PSODD,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)_"^"_DRG_"^"_$P(^PS(52.41,EN,0),"^")_"^"_EN_"P;O"
"RTN","PSOORDRG",83,0)
 Q
"RTN","PSOORDRG",84,0)
 ;
"RTN","PSOORDRG",85,0)
BUILDX K EN,PSOOI,PSODD,PSOEN Q
"RTN","PSOORDRG",86,0)
 ;
"RTN","PSOORDRG",87,0)
GET ;data for profiles
"RTN","PSOORDRG",88,0)
 S PSORX0=^PSRX(RX,0),PSOST0=+^("STA") Q:PSOST0>5&(PSOST0'=16)
"RTN","PSOORDRG",89,0)
 S PSORX2=$G(^PSRX(RX,2)),PSORX3=$G(^(3)),ORN=$P($G(^("OR1")),"^",2) S:PSORX3="" PSORX3=$P(PSORX2,"^",2)
"RTN","PSOORDRG",90,0)
 S PSODRUG=+$P(PSORX0,"^",6) Q:'$D(^PSDRUG(PSODRUG,0))
"RTN","PSOORDRG",91,0)
 S PSODRUG0=^PSDRUG(PSODRUG,0),PSOVACL=$P(PSODRUG0,"^",2)
"RTN","PSOORDRG",92,0)
 ;
"RTN","PSOORDRG",93,0)
 I EXPDT<DT D
"RTN","PSOORDRG",94,0)
 .N DIE,DIC,DR,DA S STAT="SC",DIE=52,DA=RX,DR="100////11" D ^DIE K DIE,DIC,DR,DA
"RTN","PSOORDRG",95,0)
 .D ECAN^PSOUTL(RX) S DA=RX
"RTN","PSOORDRG",96,0)
 .S COMM="Prescription Expired",PHARMST="ZE" D EN^PSOHLSN1(DA,STAT,PHARMST,COMM)
"RTN","PSOORDRG",97,0)
 S INDX=$G(INDX)+1
"RTN","PSOORDRG",98,0)
 S ^TMP($J,"ORDERS",INDX)=PSOVACL_"^"_$S($G(^PSDRUG(PSODRUG,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)_"^"_$P(^PSDRUG(PSODRUG,0),"^")_"^"_ORN_"^"_RX_"R;O"
"RTN","PSOORDRG",99,0)
 Q
"RTN","PSOORDRG",100,0)
GETX ;
"RTN","PSOORDRG",101,0)
 K PSOX,EXPDT,PSODRUG,PSODRUG0,PSORX0,PSORX2,PSORX3,PSOST0,PSOVACL,X,Y,X1,X2,ORN
"RTN","PSOORDRG",102,0)
 Q
"RTN","PSOORDRG",103,0)
CLOZ ;
"RTN","PSOORDRG",104,0)
 S ANQRTN=$P(^PSDRUG(PSODRUG("IEN"),"CLOZ1"),"^"),ANQX=0,P(5)=PSODRUG("IEN"),DFN=PSODFN,X=ANQRTN
"RTN","PSOORDRG",105,0)
 X ^%ZOSF("TEST") I  D @("^"_ANQRTN) S:$G(ANQX) PSORX("DFLG")=1
"RTN","PSOORDRG",106,0)
 K P(5),ANQRTN,ANQX,X
"RTN","PSOORDRG",107,0)
 Q
"RTN","PSOORDRG",108,0)
DRGCHK(PSODFN,DREN,DDRUG)    ;Only check DREN against drug in DDRG()
"RTN","PSOORDRG",109,0)
 ;* PSODFN = Patient's DFN
"RTN","PSOORDRG",110,0)
 ;* DREN   = Dispense drug to be checked against the drug in the array
"RTN","PSOORDRG",111,0)
 ;* DDRUG  = The array of dispense drug in the buffer.
"RTN","PSOORDRG",112,0)
 ;*
"RTN","PSOORDRG",113,0)
 K ^TMP($J,"DI"),^TMP($J,"DD"),^TMP($J,"DC")
"RTN","PSOORDRG",114,0)
 NEW DDRUG0,DDRUGND,COD,PSJINX S COD="",PSJINX=0
"RTN","PSOORDRG",115,0)
 S DDRUG=0 F  S DDRUG=$O(DDRUG(DDRUG)) Q:'DDRUG  D DDRUG^PSJORUT2
"RTN","PSOORDRG",116,0)
 D DRG
"RTN","PSOORDRG",117,0)
 Q
"RTN","PSOORDRG",118,0)
OIDRG(PSODFN,PSOI) ;checks every drug tied to orderable item passed by package use
"RTN","PSOORDRG",119,0)
 K ^TMP($J,"DI"),^TMP($J,"DD"),^TMP($J,"DC"),DD,DC,DI N DREN S INDX=0,PSOPHI=1
"RTN","PSOORDRG",120,0)
 ;build patient's drug profile inpat/outpat/non-va
"RTN","PSOORDRG",121,0)
 D BLD,ENCHK^PSJORUT2(PSODFN,.INDX),NVA
"RTN","PSOORDRG",122,0)
 F DREN=0:0 S DREN=$O(^PSDRUG("ASP",PSOI,DREN)) Q:'DREN  I $D(^PSDRUG(DREN,O)) D DRG
"RTN","PSOORDRG",123,0)
 K PSOPHI D EXIT
"RTN","PSOORDRG",124,0)
 Q
"RTN","PSOORDRG",125,0)
NVA ;checks existing nva
"RTN","PSOORDRG",126,0)
 F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",I)) Q:'I  D:$D(^PS(55,PSODFN,"NVA",I,0))
"RTN","PSOORDRG",127,0)
 .Q:$P(^PS(55,PSODFN,"NVA",I,0),"^",7)
"RTN","PSOORDRG",128,0)
 .S PSOI=$P(^PS(55,PSODFN,"NVA",I,0),"^"),DRG=$P(^(0),"^",2),ORN=$P(^(0),"^",8)
"RTN","PSOORDRG",129,0)
 .I DRG,$G(^PSDRUG(DRG,0))]"" D NVA1 K DRG Q
"RTN","PSOORDRG",130,0)
 .K DRG F DRG=0:0 S DRG=$O(^PSDRUG("ASP",PSOI,DRG)) Q:'DRG  D:$D(^PSDRUG(DRG,0)) NVA1
"RTN","PSOORDRG",131,0)
 K I,PSOOTC,ORN,PSOI,DRG,DRGN,PSOY,VACL,NDF
"RTN","PSOORDRG",132,0)
 Q
"RTN","PSOORDRG",133,0)
NVA1 S PSOY=$G(^PSDRUG(DRG,0)),DRGN=$P(PSOY,"^"),VACL=$P(PSOY,"^",2)
"RTN","PSOORDRG",134,0)
 S NDF=$S($G(^PSDRUG(DRG,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORDRG",135,0)
 S INDX=$G(INDX)+1,^TMP($J,"ORDERS",INDX)=VACL_"^"_NDF_"^"_DRGN_"^"_ORN_"^"_I_"N;O"
"RTN","PSOORDRG",136,0)
 Q
"RTN","PSOORFI4")
0^9^B57972101
"RTN","PSOORFI4",1,0)
PSOORFI4 ;BIR/SAB-CPRS order checks and display con't ;10/26/00
"RTN","PSOORFI4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,74,78,99,117,131,207**;DEC 1997
"RTN","PSOORFI4",3,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORFI4",4,0)
 ;External reference to ^PS(50.607 supported by DBIA 2221
"RTN","PSOORFI4",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORFI4",6,0)
 ;External reference to ^PS(50.7 is supported by DBIA 2223
"RTN","PSOORFI4",7,0)
 ;External reference to $$PDA^PPPPDA1 is supported by DBIA 1374
"RTN","PSOORFI4",8,0)
 ;
"RTN","PSOORFI4",9,0)
ORCHK D ORCHK^PSOORNE6
"RTN","PSOORFI4",10,0)
 Q
"RTN","PSOORFI4",11,0)
INST ;displays patient instructions
"RTN","PSOORFI4",12,0)
 I $O(PSONEW("SIG",0)) G INST1
"RTN","PSOORFI4",13,0)
 S INST=0 F  S INST=$O(^PS(52.41,ORD,"INS1",INST)) Q:'INST  S (MIG,PSONEW("SIG",INST))=^PS(52.41,ORD,"INS1",INST,0) D
"RTN","PSOORFI4",14,0)
 .F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORFI4",15,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^"),$O(^PS(52.41,ORD,"INS1",0)) D
"RTN","PSOORFI4",16,0)
 .I $G(^PS(50.7,PSODRUG("OI"),"INS1"))]"" S (X,PSONEW("SINS"))=^PS(50.7,PSODRUG("OI"),"INS1") D SSIG^PSOHELP
"RTN","PSOORFI4",17,0)
 .I $G(SINS1)]"" S PSONEW("SINS")=$E(SINS1,2,250)
"RTN","PSOORFI4",18,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" Other Pat Instruct: "_$S($G(PSONEW("SINS"))]"":PSONEW("SINS"),1:"")
"RTN","PSOORFI4",19,0)
 K INST,TY,MIG,SG,SINS1
"RTN","PSOORFI4",20,0)
 Q
"RTN","PSOORFI4",21,0)
INST1 ;
"RTN","PSOORFI4",22,0)
 S INS=0 F  S INS=$O(PSONEW("SIG",INS)) Q:'INS  S MIG=PSONEW("SIG",INS) D
"RTN","PSOORFI4",23,0)
 .F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORFI4",24,0)
 K INST,TY,MIG,SG
"RTN","PSOORFI4",25,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" Other Pat Instruct: "_$S($G(PSONEW("SINS"))]"":PSONEW("SINS"),1:"")
"RTN","PSOORFI4",26,0)
 Q
"RTN","PSOORFI4",27,0)
PROVCOM ;
"RTN","PSOORFI4",28,0)
 I $G(PKI1)=1,'$G(PSORX("VERIFY")) D REA^PSOPKIV1 Q:$G(PSORX("DFLG"))
"RTN","PSOORFI4",29,0)
 I $O(PRC(0)),'$G(PSOPRC) D  D KV^PSOVER1
"RTN","PSOORFI4",30,0)
 .D KV^PSOVER1 S DIR(0)="Y",DIR("A")="Copy Provider Comments into the Patient Instructions",DIR("B")="No"
"RTN","PSOORFI4",31,0)
 .D ^DIR Q:'Y!($D(DIRUT))
"RTN","PSOORFI4",32,0)
 .S PSOPRC=1,NI=0 F I=0:0 S I=$O(PSONEW("SIG",I)) Q:'I  S NI=I
"RTN","PSOORFI4",33,0)
 .S NC=0 F I=0:0 S I=$O(PRC(I)) Q:'I  S NC=NC+1
"RTN","PSOORFI4",34,0)
 .I NI'>1,NC=1,($L($G(PSONEW("SIG",NI)))+$L(PRC(1)))'>250 D  Q
"RTN","PSOORFI4",35,0)
 ..S PSONEW("SIG",1)=$G(PSONEW("SIG",NI))_" "_PRC(1)
"RTN","PSOORFI4",36,0)
 ..S:$E(PSONEW("SIG",1))=" " PSONEW("SIG",1)=$E(PSONEW("SIG",1),2,250) S PSONEW("INS")=PSONEW("SIG",1) D EN^PSOFSIG(.PSONEW,1) K NI,NC
"RTN","PSOORFI4",37,0)
 .F I=0:0 S I=$O(PRC(I)) Q:'I  S NI=NI+1,(PSONEW("SIG",NI),PSONEW("INS",NI))=PRC(I)
"RTN","PSOORFI4",38,0)
 .I $E(PSONEW("SIG",1))=" " S PSONEW("SIG",1)=$E(PSONEW("SIG",1),2,250)
"RTN","PSOORFI4",39,0)
 .D EN^PSOFSIG(.PSONEW,1) K NI,NC
"RTN","PSOORFI4",40,0)
 Q
"RTN","PSOORFI4",41,0)
DOSE ;displays dosing info for pending orders.  called from psoorfi1
"RTN","PSOORFI4",42,0)
 K II,UNITS S DS=1
"RTN","PSOORFI4",43,0)
 I '$O(^PS(52.41,ORD,1,0)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)        *Dosage:" G DOSEX
"RTN","PSOORFI4",44,0)
 F I=0:0 S I=$O(^PS(52.41,ORD,1,I)) Q:'I  S DOSE=$G(^PS(52.41,ORD,1,I,1)),DOSE1=$G(^(2)) D  D DOSE1
"RTN","PSOORFI4",45,0)
 .S II=$G(II)+1 K PSONEW("UNITS",II)
"RTN","PSOORFI4",46,0)
 .S PSONEW("DOSE",II)=$P(DOSE1,"^"),PSONEW("DOSE ORDERED",II)=$P(DOSE1,"^",2),PSONEW("UNITS",II)=$P(DOSE,"^",9),PSONEW("NOUN",II)=$P(DOSE,"^",5)
"RTN","PSOORFI4",47,0)
 .S:$P(DOSE,"^",9) UNITS=$P(^PS(50.607,$P(DOSE,"^",9),0),"^")
"RTN","PSOORFI4",48,0)
 .S PSONEW("VERB",II)=$P(DOSE,"^",10),PSONEW("ROUTE",II)=$P(DOSE,"^",8)
"RTN","PSOORFI4",49,0)
 .S:$P(DOSE,"^",8) ROUTE=$P(^PS(51.2,$P(DOSE,"^",8),0),"^")
"RTN","PSOORFI4",50,0)
 .S PSONEW("SCHEDULE",II)=$P(DOSE,"^"),PSONEW("DURATION",II)=$P(DOSE,"^",2)
"RTN","PSOORFI4",51,0)
 .S DOENT=$G(DOENT)+1 I $P(DOSE,"^",6)]"" S PSONEW("CONJUNCTION",II)=$S($P(DOSE,"^",6)="S":"T",$P(DOSE,"^",6)="X":"X",1:"A")
"RTN","PSOORFI4",52,0)
 .I 'PSONEW("DOSE ORDERED",II),$G(PSONEW("VERB",II))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",II))
"RTN","PSOORFI4",53,0)
 .S:$G(DS) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)"
"RTN","PSOORFI4",54,0)
DOSEX S PSONEW("ENT")=+$G(II) K DOSE,DOSE1,II,I,UNITS,ROUTE,DG
"RTN","PSOORFI4",55,0)
 Q
"RTN","PSOORFI4",56,0)
DOSE1 I $G(DS)=1 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        *Dosage:" D FMD^PSOORFI3 G DU
"RTN","PSOORFI4",57,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            *Dosage:" D FMD^PSOORFI3
"RTN","PSOORFI4",58,0)
DU I 'PSONEW("DOSE ORDERED",I),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" *Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORFI4",59,0)
 I PSONEW("DOSE ORDERED",II),$G(PSONEW("VERB",II))]"" D
"RTN","PSOORFI4",60,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",II))
"RTN","PSOORFI4",61,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Dispense Units: "_$S($E(PSONEW("DOSE ORDERED",II),1)=".":"0",1:"")_PSONEW("DOSE ORDERED",II)
"RTN","PSOORFI4",62,0)
 I PSONEW("NOUN",II)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Noun: "_PSONEW("NOUN",II)
"RTN","PSOORFI4",63,0)
 I $G(ROUTE)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="             *Route: "_$G(ROUTE)
"RTN","PSOORFI4",64,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Schedule: "_PSONEW("SCHEDULE",II)
"RTN","PSOORFI4",65,0)
 I $G(PSONEW("DURATION",II))]"" D
"RTN","PSOORFI4",66,0)
 .S PSONEW("DURATION",II)=$S($E(PSONEW("DURATION",II),1)'?.N:$E(PSONEW("DURATION",II),2,99)_$E(PSONEW("DURATION",II),1),1:PSONEW("DURATION",II))
"RTN","PSOORFI4",67,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Duration: "_PSONEW("DURATION",II)_" ("_$S(PSONEW("DURATION",II)["M":"MINUTES",PSONEW("DURATION",II)["H":"HOURS",PSONEW("DURATION",II)["L":"MONTHS",PSONEW("DURATION",II)["W":"WEEKS",1:"DAYS")_")"
"RTN","PSOORFI4",68,0)
 I $G(PSONEW("CONJUNCTION",II))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       *Conjunction: "_$S(PSONEW("CONJUNCTION",II)="T":"THEN",PSONEW("CONJUNCTION",II)="X":"EXCEPT",1:"AND")
"RTN","PSOORFI4",69,0)
 Q
"RTN","PSOORFI4",70,0)
DOSE2 ;displays pending order after edits.  called from psoornew
"RTN","PSOORFI4",71,0)
 I '$O(PSONEW("DOSE",0))!($O(PSONEW("DOSE",0))="") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)        *Dosage:" Q
"RTN","PSOORFI4",72,0)
 S DS=1
"RTN","PSOORFI4",73,0)
 F I=1:1:PSONEW("ENT") Q:'I  D  D DOSE3 K COJ
"RTN","PSOORFI4",74,0)
 .S:$G(PSONEW("UNITS",I))]"" UNITS=$P(^PS(50.607,PSONEW("UNITS",I),0),"^")
"RTN","PSOORFI4",75,0)
 .I $G(PSONEW("ROUTE",I))]"",$G(^PS(51.2,PSONEW("ROUTE",I),0))]"" S ROUTE=$P(^PS(51.2,PSONEW("ROUTE",I),0),"^")
"RTN","PSOORFI4",76,0)
 .S DUR=$G(PSONEW("DURATION",I)) S:$G(PSONEW("CONJUNCTION",I))]"" COJ=PSONEW("CONJUNCTION",I)
"RTN","PSOORFI4",77,0)
 .S NOUN=$G(PSONEW("NOUN",I)),VERB=$G(PSONEW("VERB",I))
"RTN","PSOORFI4",78,0)
 .I '$G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI4",79,0)
 .S:$G(DS) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (3)"
"RTN","PSOORFI4",80,0)
 K I,UNITS,ROUTE,DUR,COJ,VERB,NOUN,DG
"RTN","PSOORFI4",81,0)
 Q
"RTN","PSOORFI4",82,0)
DOSE3 I $G(DS)=1 S II=I,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        *Dosage:" D FMD^PSOORFI3 G DO
"RTN","PSOORFI4",83,0)
 S II=I,IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            *Dosage:" D FMD^PSOORFI3
"RTN","PSOORFI4",84,0)
DO I '$G(PSONEW("DOSE ORDERED",I)),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" *Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOORFI4",85,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOORFI4",86,0)
 I $G(PSONEW("DOSE ORDERED",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Dispense Units: "_$S($E(PSONEW("DOSE ORDERED",I),1)=".":"0",1:"")_PSONEW("DOSE ORDERED",I)
"RTN","PSOORFI4",87,0)
 I $G(PSONEW("NOUN",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               NOUN: "_PSONEW("NOUN",I)
"RTN","PSOORFI4",88,0)
 I $G(ROUTE)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="             *Route: "_$G(ROUTE)
"RTN","PSOORFI4",89,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOORFI4",90,0)
 I $G(PSONEW("DURATION",I))]"" D
"RTN","PSOORFI4",91,0)
 .S PSONEW("DURATION",I)=$S($E(PSONEW("DURATION",I),1)'?.N:$E(PSONEW("DURATION",I),2,99)_$E(PSONEW("DURATION",I),1),1:PSONEW("DURATION",I))
"RTN","PSOORFI4",92,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="          *Duration: "_PSONEW("DURATION",I)_" ("_$S(PSONEW("DURATION",I)["M":"MINUTES",PSONEW("DURATION",I)["H":"HOURS",PSONEW("DURATION",I)["L":"MONTHS",PSONEW("DURATION",I)["W":"WEEKS",1:"DAYS")_")"
"RTN","PSOORFI4",93,0)
 I $G(PSONEW("CONJUNCTION",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       *Conjunction: "_$S(PSONEW("CONJUNCTION",I)="T":"THEN",PSONEW("CONJUNCTION",I)="X":"EXCEPT",1:"AND")
"RTN","PSOORFI4",94,0)
 Q
"RTN","PSOORFI4",95,0)
OBX ;formats obx section
"RTN","PSOORFI4",96,0)
 N COM,II
"RTN","PSOORFI4",97,0)
 D:$G(PKI1) L1^PSOPKIV1
"RTN","PSOORFI4",98,0)
 I $O(^PS(52.41,ORD,"OBX",0)) S (T,IEN)=0,IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="Order Checks:" F  S T=$O(^PS(52.41,ORD,"OBX",T)) Q:'T  D  S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" "
"RTN","PSOORFI4",99,0)
 .S COM=$G(^PS(52.41,ORD,"OBX",T,0))
"RTN","PSOORFI4",100,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     " F II=1:1:$L(COM," ") D
"RTN","PSOORFI4",101,0)
 ..I $L(^TMP("PSOPO",$J,IEN,0)_" "_$P(COM," ",II))>80 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     "
"RTN","PSOORFI4",102,0)
 ..S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_" "_$P(COM," ",II)
"RTN","PSOORFI4",103,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Overriding Provider: "_$G(^PS(52.41,ORD,"OBX",T,1))
"RTN","PSOORFI4",104,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="     Overriding Reason:"
"RTN","PSOORFI4",105,0)
 .F T1=0:0 S T1=$O(^PS(52.41,ORD,"OBX",T,2,T1)) Q:'T1  D
"RTN","PSOORFI4",106,0)
 ..S MIG=^PS(52.41,ORD,"OBX",T,2,T1,0)
"RTN","PSOORFI4",107,0)
 ..F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",23)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORFI4",108,0)
 Q
"RTN","PSOORFI4",109,0)
PP S PSODFN=PAT D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2),X="PPPPDA1"
"RTN","PSOORFI4",110,0)
 X ^%ZOSF("TEST") S:$T X=$$PDA^PPPPDA1(PSODFN)
"RTN","PSOORFI4",111,0)
 Q
"RTN","PSOORFI4",112,0)
SPL K PSOFIN S POERR("QFLG")=0 S PSONOLCK=1,PSOPTLOK=PAT
"RTN","PSOORFI4",113,0)
 Q
"RTN","PSOORRD2")
0^5^B23700480
"RTN","PSOORRD2",1,0)
PSOORRD2 ;BHAM-ISC/EJW - Remote Data Interoperabilty Order Checks - backdoor ;06/26/05
"RTN","PSOORRD2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**207**;DEC 1997
"RTN","PSOORRD2",3,0)
 ;
"RTN","PSOORRD2",4,0)
DUP ;Remote order - duplicate drug
"RTN","PSOORRD2",5,0)
 N PSOD0,PSOD1,PSOREMX,RDIINST,FSIG,PSOULN,PSOLF,PSORDI
"RTN","PSOORRD2",6,0)
 S $P(PSOULN,"-",79)="",PSOT="DD"
"RTN","PSOORRD2",7,0)
 S PSORDI=0 F  S PSORDI=$O(^TMP($J,"DD",PSORDI)) Q:'PSORDI  S PSOD0=^TMP($J,"DD",PSORDI,0),PSOD1=^(1),PSOREMX=$P($P(PSOD0,"^",4),";"),RDIINST=$P(PSOD0,"^",5),PSOLF=$P(PSOD1,"^",3) D
"RTN","PSOORRD2",8,0)
 .W !,PSOULN,!
"RTN","PSOORRD2",9,0)
 .W "Duplicate Drug ",$P(PSOD1,"^")," in Remote Prescription",!
"RTN","PSOORRD2",10,0)
 .W ">> ",RDIINST,!
"RTN","PSOORRD2",11,0)
 .W $J("Rx #: ",20)_$E(PSOREMX,1,$L(PSOREMX)-1),!
"RTN","PSOORRD2",12,0)
 .W $J("Status: ",20),$P(PSOD1,"^",2)
"RTN","PSOORRD2",13,0)
 .W ?44,$J("Issued: ",20),$P(PSOD1,"^",9)
"RTN","PSOORRD2",14,0)
 .D FSIG(.FSIG)
"RTN","PSOORRD2",15,0)
 .W !,$J("SIG: ",20) F I=1:1 Q:'$D(FSIG(I))  W ?20,FSIG(I),!
"RTN","PSOORRD2",16,0)
 .W $J("QTY: ",20),$P(PSOD1,"^",5),!
"RTN","PSOORRD2",17,0)
 .W $J("Provider: ",20),$P(PSOD1,"^",8)
"RTN","PSOORRD2",18,0)
 .W ?44,$J("Refills remaining: ",20),$P(PSOD1,"^",6)
"RTN","PSOORRD2",19,0)
 .W !?44,$J("Last filled on: ",20),PSOLF
"RTN","PSOORRD2",20,0)
 .W !?44,$J("Days Supply: ",20),$P(PSOD1,"^",4)
"RTN","PSOORRD2",21,0)
 .D PAUSE
"RTN","PSOORRD2",22,0)
 K PSOT
"RTN","PSOORRD2",23,0)
 Q
"RTN","PSOORRD2",24,0)
 ;
"RTN","PSOORRD2",25,0)
CLS ;Remote order - duplicate drug class
"RTN","PSOORRD2",26,0)
 N PSOD0,PSOD1,PSOREMX,RDIINST,FSIG,PSOULN,PSOLF,PSORDI
"RTN","PSOORRD2",27,0)
 S $P(PSOULN,"-",79)="",PSOT="DC"
"RTN","PSOORRD2",28,0)
 S PSORDI=0 F  S PSORDI=$O(^TMP($J,"DC",PSORDI)) Q:'PSORDI  S PSOD0=^TMP($J,"DC",PSORDI,0),PSOD1=^(1),PSOREMX=$P($P(PSOD0,"^",6),";"),RDIINST=$P(PSOD0,"^",7),PSOLF=$P(PSOD1,"^",3) D
"RTN","PSOORRD2",29,0)
 .W !,PSOULN,!
"RTN","PSOORRD2",30,0)
 .W "     *** SAME CLASS *** OF DRUG IN REMOTE RX FOR ",$P(PSOD1,"^"),!
"RTN","PSOORRD2",31,0)
 .W ">> ",RDIINST,!
"RTN","PSOORRD2",32,0)
 .W "CLASS: ",$P(PSOD0,"^"),!
"RTN","PSOORRD2",33,0)
 .W $J("Rx #: ",20)_$E(PSOREMX,1,$L(PSOREMX)-1),!
"RTN","PSOORRD2",34,0)
 .W $J("Status: ",20),$P(PSOD1,"^",2)
"RTN","PSOORRD2",35,0)
 .W ?44,$J("Issued: ",20),$P(PSOD1,"^",9)
"RTN","PSOORRD2",36,0)
 .D FSIG(.FSIG)
"RTN","PSOORRD2",37,0)
 .W !,$J("SIG: ",20) F I=1:1 Q:'$D(FSIG(I))  W ?20,FSIG(I),!
"RTN","PSOORRD2",38,0)
 .W $J("QTY: ",20),$P(PSOD1,"^",5),!
"RTN","PSOORRD2",39,0)
 .W $J("Provider: ",20),$P(PSOD1,"^",8)
"RTN","PSOORRD2",40,0)
 .W ?44,$J("Refills remaining: ",20),$P(PSOD1,"^",6)
"RTN","PSOORRD2",41,0)
 .W !?44,$J("Last filled on: ",20),PSOLF
"RTN","PSOORRD2",42,0)
 .W !?44,$J("Days Supply: ",20),$P(PSOD1,"^",4)
"RTN","PSOORRD2",43,0)
 .D PAUSE
"RTN","PSOORRD2",44,0)
 K PSOT
"RTN","PSOORRD2",45,0)
 Q
"RTN","PSOORRD2",46,0)
FSIG(FSIG) ;Format sig from remote site
"RTN","PSOORRD2",47,0)
 ;returned in the FSIG array
"RTN","PSOORRD2",48,0)
 N FFF,NNN,CNT,FVAR,FVAR1,FLIM,HSIG,II,I
"RTN","PSOORRD2",49,0)
 F I=0:1 Q:'$D(^TMP($J,PSOT,PSORDI,1,I))  S HSIG(I+1)=^(I)
"RTN","PSOORRD2",50,0)
FSTART S (FVAR,FVAR1)="",II=1
"RTN","PSOORRD2",51,0)
 F FFF=0:0 S FFF=$O(HSIG(FFF)) Q:'FFF  S CNT=0 F NNN=1:1:$L(HSIG(FFF)) I $E(HSIG(FFF),NNN)=" "!($L(HSIG(FFF))=NNN) S CNT=CNT+1 D  I $L(FVAR)>52 S FSIG(II)=FLIM_" ",II=II+1,FVAR=FVAR1
"RTN","PSOORRD2",52,0)
 .S FVAR1=$P(HSIG(FFF)," ",(CNT))
"RTN","PSOORRD2",53,0)
 .S FLIM=FVAR
"RTN","PSOORRD2",54,0)
 .S FVAR=$S(FVAR="":FVAR1,1:FVAR_" "_FVAR1)
"RTN","PSOORRD2",55,0)
 I $G(FVAR)'="" S FSIG(II)=FVAR
"RTN","PSOORRD2",56,0)
 I $G(FSIG(1))=""!($G(FSIG(1))=" ") S FSIG(1)=$G(FSIG(2)) K FSIG(2)
"RTN","PSOORRD2",57,0)
FQUIT Q
"RTN","PSOORRD2",58,0)
SIGNIF ;
"RTN","PSOORRD2",59,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Intervene? ",DIR("B")="Y" W ! D ^DIR
"RTN","PSOORRD2",60,0)
 I Y I '$D(PSORX("INTERVENE")) S PSORX("INTERVENE")=2
"RTN","PSOORRD2",61,0)
 I '$G(Y) K DIR,DTOUT,DIRUT,DIROUT,DUOUT,Y Q
"RTN","PSOORRD2",62,0)
 Q
"RTN","PSOORRD2",63,0)
 ;
"RTN","PSOORRD2",64,0)
PAUSE ;
"RTN","PSOORRD2",65,0)
 K DIR W ! S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR W ! K DIR
"RTN","PSOORRD2",66,0)
 Q
"RTN","PSOORRD2",67,0)
DRGINT ;DRUG-DRUG INTERACTION WITH ORDER FROM REMOTE SITE
"RTN","PSOORRD2",68,0)
 N PSOD0,PSOD1,PSOREMX,RDIINST,FSIG,PSOULN,PSOLF,PSOINT,PSORDI
"RTN","PSOORRD2",69,0)
 S $P(PSOULN,"-",79)="",PSOT="DI"
"RTN","PSOORRD2",70,0)
 S PSORDI=0 F  S PSORDI=$O(^TMP($J,"DI",PSORDI)) Q:'PSORDI  Q:$G(PSORX("DFLG"))  S PSOD0=^TMP($J,"DI",PSORDI,0),PSOD1=^(1),PSOREMX=$P($P(PSOD0,"^",8),";"),RDIINST=$P(PSOD0,"^",9),PSOLF=$P(PSOD1,"^",3) D
"RTN","PSOORRD2",71,0)
 .S PSOINT=$P(PSOD0,"^",4)
"RTN","PSOORRD2",72,0)
 .W !,PSOULN,!
"RTN","PSOORRD2",73,0)
 .W ">> ",RDIINST,!
"RTN","PSOORRD2",74,0)
 .W ?5,"** ",PSOINT," ** DRUG-DRUG interaction ",$P(PSOD0,"^",5)," & ",$P(PSOD0,"^",6),!
"RTN","PSOORRD2",75,0)
 .W ?5,"Remote RX # ",$E(PSOREMX,1,$L(PSOREMX)-1)," Drug: ",$P(PSOD1,"^"),!
"RTN","PSOORRD2",76,0)
 .W $J("Status: ",20),$P(PSOD1,"^",2)
"RTN","PSOORRD2",77,0)
 .W ?44,$J("Issued: ",20),$P(PSOD1,"^",9)
"RTN","PSOORRD2",78,0)
 .D FSIG(.FSIG)
"RTN","PSOORRD2",79,0)
 .W !,$J("SIG: ",20) F I=1:1 Q:'$D(FSIG(I))  W ?20,FSIG(I),!
"RTN","PSOORRD2",80,0)
 .W $J("QTY: ",20),$P(PSOD1,"^",5),!
"RTN","PSOORRD2",81,0)
 .W $J("Provider: ",20),$P(PSOD1,"^",8)
"RTN","PSOORRD2",82,0)
 .W !?44,$J("Refills remaining: ",20),$P(PSOD1,"^",6)
"RTN","PSOORRD2",83,0)
 .W !?44,$J("Last filled on: ",20),PSOLF
"RTN","PSOORRD2",84,0)
 .W !?44,$J("Days Supply: ",20),$P(PSOD1,"^",4)
"RTN","PSOORRD2",85,0)
 .I '$D(^XUSEC("PSORPH",DUZ)) Q  ; CLERK/TECH ENTRY
"RTN","PSOORRD2",86,0)
 .I PSOINT'="CRITICAL" D SIGNIF
"RTN","PSOORRD2",87,0)
 .I PSOINT="CRITICAL" D CRI
"RTN","PSOORRD2",88,0)
 K PSOT,PSORDI
"RTN","PSOORRD2",89,0)
 Q
"RTN","PSOORRD2",90,0)
 ;
"RTN","PSOORRD2",91,0)
CRI ;process new drug interactions entered by pharmacist
"RTN","PSOORRD2",92,0)
 K DIR S DIR("A",1)="",DIR("A",2)="Do you want to Process medication",DIR("A")=PSODRUG("NAME")_": ",DIR(0)="SA^1:PROCESS;0:ABORT ORDER ENTRY",DIR("B")="P"
"RTN","PSOORRD2",93,0)
 S DIR("?",1)="Enter '1' or 'P' to Activate medication",DIR("?")="      '0' or 'A' to Abort Order Entry process" D ^DIR K X1,DIR I 'Y S PSORX("DFLG")=1,DGI="" K DTOUT,DIRUT,DIROUT,DUOUT,PSORX("INTERVENE") Q
"RTN","PSOORRD2",94,0)
 D SIG^XUSESIG I X1="" K PSORX("INTERVENE") S PSORX("DFLG")=1 Q
"RTN","PSOORRD2",95,0)
 S PSORX("INTERVENE")=1
"RTN","PSOORRD2",96,0)
 K DUOUT,DTOUT,DIRUT,DIROUT
"RTN","PSOORRD2",97,0)
 Q
"RTN","PSOORRDI")
0^6^B48531879
"RTN","PSOORRDI",1,0)
PSOORRDI ;BHAM-ISC/EJW - Remote Data Interoperabilty Order Checks ;04/25/05
"RTN","PSOORRDI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**207**;DEC 1997
"RTN","PSOORRDI",3,0)
 ;
"RTN","PSOORRDI",4,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOORRDI",5,0)
 ;External reference to ^PS(50.605 supported by DBIA 696
"RTN","PSOORRDI",6,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORRDI",7,0)
 ;External reference to ^PS(56 supported by DBIA 2229
"RTN","PSOORRDI",8,0)
 ;External reference to ^PS(50.416 supported by DBIA 692
"RTN","PSOORRDI",9,0)
 ;External reference to DDIEX^PSNAPIS supported by DBIA 2574
"RTN","PSOORRDI",10,0)
REMOTE(PSODFN,DREN) ;
"RTN","PSOORRDI",11,0)
 ; Input: DFN: PATIENT file (#2) IEN
"RTN","PSOORRDI",12,0)
 ;      : DREN: DRUG file (#50) IEN of order being checked
"RTN","PSOORRDI",13,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOORRDI",14,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOORRDI",15,0)
 N PSORDI,RDIINST,RDIVUID,RDIRX,RDIDNAM,RDISTA,RDISIG,RDIDAYS,RDIQTY,RDIFILL,RDIEXP,RDIISS,RDIFILL,RDIREF,RDIPHYS,PSOPROD,PSOCLASS,DRNM,RDITMP,PSODC,IT,PSOICT,NDF,RDIDI,PSOPRODA,PSOFILE,PSOSIG
"RTN","PSOORRDI",16,0)
 S PSORDI=0
"RTN","PSOORRDI",17,0)
 I $T(GET^ORRDI1)]"" S PSORDI=$$GET^ORRDI1(PSODFN,"PSOO")
"RTN","PSOORRDI",18,0)
 I PSORDI<1 Q
"RTN","PSOORRDI",19,0)
 I '$D(^XTMP("ORRDI","PSOO",PSODFN)) Q
"RTN","PSOORRDI",20,0)
 K ^TMP($J,"PSORDI")
"RTN","PSOORRDI",21,0)
 D PARSE,FILTER
"RTN","PSOORRDI",22,0)
 I '$D(^TMP($J,"PSORDI")) Q
"RTN","PSOORRDI",23,0)
 D DRGNAME ; GET VA PRODUCT FILE NAME FOR FILE 50 DRUG BEING CHECKED
"RTN","PSOORRDI",24,0)
 S PSORDI="" F  S PSORDI=$O(^TMP($J,"PSORDI",PSORDI)) Q:'PSORDI  S RDITMP=^(PSORDI) D
"RTN","PSOORRDI",25,0)
 .S RDIINST=$P(RDITMP,"^")
"RTN","PSOORRDI",26,0)
 .S RDIVUID=$P(RDITMP,"^",2)
"RTN","PSOORRDI",27,0)
 .I RDIVUID="" Q
"RTN","PSOORRDI",28,0)
 .S RDIDNAM=$P(RDITMP,"^",3)
"RTN","PSOORRDI",29,0)
 .S RDISTA=$P(RDITMP,"^",4)
"RTN","PSOORRDI",30,0)
 .S RDIRX=$P(RDITMP,"^",5)
"RTN","PSOORRDI",31,0)
 .S RDIFILL=$P(RDITMP,"^",6)
"RTN","PSOORRDI",32,0)
 .S RDIDAYS=$P(RDITMP,"^",7) I $E(RDIDAYS)="D" S RDIDAYS=$P(RDIDAYS,"D",2)
"RTN","PSOORRDI",33,0)
 .S RDIQTY=$P(RDITMP,"^",8)
"RTN","PSOORRDI",34,0)
 .S RDIREF=$P(RDITMP,"^",9)
"RTN","PSOORRDI",35,0)
 .S RDIEXP=$P(RDITMP,"^",10)
"RTN","PSOORRDI",36,0)
 .S RDIPHYS=$P(RDITMP,"^",11)
"RTN","PSOORRDI",37,0)
 .S RDIISS=$P(RDITMP,"^",12)
"RTN","PSOORRDI",38,0)
 .S PSOFILE=50.68
"RTN","PSOORRDI",39,0)
 .K PSOPRODA
"RTN","PSOORRDI",40,0)
 .N DIC
"RTN","PSOORRDI",41,0)
 .D GETIREF^XTID(PSOFILE,.01,RDIVUID,"PSOPRODA",1) I 'PSOPRODA Q
"RTN","PSOORRDI",42,0)
 .S PSOPROD=$O(PSOPRODA(PSOFILE,.01,"")) I 'PSOPROD Q
"RTN","PSOORRDI",43,0)
 .I $P(PSOPRODA(PSOFILE,.01,PSOPROD),"^",3)'="ACTIVE" Q
"RTN","PSOORRDI",44,0)
 .S PSOPROD=+PSOPROD
"RTN","PSOORRDI",45,0)
 .D VAPROD(PSOPROD)
"RTN","PSOORRDI",46,0)
 .I DRNM'="" I PSODRUG("NAME")=DRNM S DD=$G(DD)+1,^TMP($J,"DD",DD,0)=PSODRUG("IEN")_"^"_PSODRUG("NAME")_"^"_"^"_RDIRX_"R;O"_"^"_RDIINST D  Q:'$G(PSOPHI)
"RTN","PSOORRDI",47,0)
 ..S ^TMP($J,"DD",DD,1)=RDIDNAM_"^"_RDISTA_"^"_RDIFILL_"^"_RDIDAYS_"^"_RDIQTY_"^"_RDIREF_"^"_RDIEXP_"^"_RDIPHYS_"^"_RDIISS
"RTN","PSOORRDI",48,0)
 ..M ^TMP($J,"DD",DD,1)=^TMP($J,"PSORDI",PSORDI,"SIG")
"RTN","PSOORRDI",49,0)
 .I PSODRUG("NAME")'=DRNM I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E(PSOCLASS,1,4) D
"RTN","PSOORRDI",50,0)
 ..I $E(PSODRUG("VA CLASS"),1,2)="HA",$E(PSOCLASS,1,2)="HA" Q
"RTN","PSOORRDI",51,0)
 ..S PSODC=$O(^PS(50.605,"B",PSODRUG("VA CLASS"),0)) Q:'PSODC
"RTN","PSOORRDI",52,0)
 ..S DC=$G(DC)+1,^TMP($J,"DC",DC,0)=PSODRUG("VA CLASS")
"RTN","PSOORRDI",53,0)
 ..S PSODC=$P(^PS(50.605,PSODC,0),"^",2),^TMP($J,"DC",DC,0)=^TMP($J,"DC",DC,0)_"^"_PSODC_"^"_RDIVUID_"^"_DRNM_"^"_"^"_RDIRX_"R;O"_"^"_RDIINST D
"RTN","PSOORRDI",54,0)
 ...S ^TMP($J,"DC",DC,1)=RDIDNAM_"^"_RDISTA_"^"_RDIFILL_"^"_RDIDAYS_"^"_RDIQTY_"^"_RDIREF_"^"_RDIEXP_"^"_RDIPHYS_"^"_RDIISS
"RTN","PSOORRDI",55,0)
 ...M ^TMP($J,"DC",DC,1)=^TMP($J,"PSORDI",PSORDI,"SIG")
"RTN","PSOORRDI",56,0)
 .;drug interaction check
"RTN","PSOORRDI",57,0)
 .K ^TMP($J,"PSOPROD")
"RTN","PSOORRDI",58,0)
 .D DATA^PSN50P68(PSOPROD,,"PSOPROD")
"RTN","PSOORRDI",59,0)
 .S NDF=+$G(^TMP($J,"PSOPROD",PSOPROD,.05))
"RTN","PSOORRDI",60,0)
 .I NDF=0 Q
"RTN","PSOORRDI",61,0)
 .S NDF=NDF_"A"_PSOPROD
"RTN","PSOORRDI",62,0)
 .K ^TMP($J,"PSOPROD")
"RTN","PSOORRDI",63,0)
 .S IT=0,PSOICT=""
"RTN","PSOORRDI",64,0)
 .F  S IT=$O(^PS(56,"APD",NDF,PSODRUG("NDF"),IT)) Q:'IT  D
"RTN","PSOORRDI",65,0)
 ..Q:$$DDIEX^PSNAPIS($P(NDF,"A"),$P(NDF,"A",2))
"RTN","PSOORRDI",66,0)
 ..Q:$$DDIEX^PSNAPIS($P(PSODRUG("NDF"),"A"),$P(PSODRUG("NDF"),"A",2))
"RTN","PSOORRDI",67,0)
 ..Q:$P(^PS(56,IT,0),"^",7)&($P(^PS(56,IT,0),"^",7)<DT)
"RTN","PSOORRDI",68,0)
 ..I 'PSOICT S PSOICT=IT Q
"RTN","PSOORRDI",69,0)
 ..I $P($G(^PS(56,IT,0)),"^",4)=1 S PSOICT=IT Q
"RTN","PSOORRDI",70,0)
 ..Q
"RTN","PSOORRDI",71,0)
 .I 'PSOICT Q
"RTN","PSOORRDI",72,0)
 .S IT=PSOICT
"RTN","PSOORRDI",73,0)
 .S RDIDI=$O(^TMP($J,"DI",999),-1) I 'RDIDI S RDIDI=0
"RTN","PSOORRDI",74,0)
 .S RDIDI=$G(RDIDI)+1,^TMP($J,"DI",RDIDI,0)=RDIVUID_"^"_DRNM_"^"_IT_"^"_$S($P(^PS(56,IT,0),"^",4)=1:"CRITICAL",1:"SIGNIFICANT")_"^"
"RTN","PSOORRDI",75,0)
 .S ^TMP($J,"DI",RDIDI,0)=^TMP($J,"DI",RDIDI,0)_$P(^PS(50.416,$P(^PS(56,IT,0),"^",2),0),"^")_"^"_$P(^PS(50.416,$P(^PS(56,IT,0),"^",3),0),"^")_"^"_""_"^"_RDIRX_"R;O"_"^"_RDIINST
"RTN","PSOORRDI",76,0)
 .S ^TMP($J,"DI",RDIDI,1)=RDIDNAM_"^"_RDISTA_"^"_RDIFILL_"^"_RDIDAYS_"^"_RDIQTY_"^"_RDIREF_"^"_RDIEXP_"^"_RDIPHYS_"^"_RDIISS
"RTN","PSOORRDI",77,0)
 .M ^TMP($J,"DI",RDIDI,1)=^TMP($J,"PSORDI",PSORDI,"SIG")
"RTN","PSOORRDI",78,0)
 .M ^TMP($J,"DI"_PSODFN,RDIDI)=^TMP($J,"DI",RDIDI) ; SAVE FOR OUTPATIENT PHARMACY BACKDOOR DISPLAY
"RTN","PSOORRDI",79,0)
 K ^TMP($J,"PSORDI")
"RTN","PSOORRDI",80,0)
 Q
"RTN","PSOORRDI",81,0)
 ;
"RTN","PSOORRDI",82,0)
PARSE ; PULL INFORMATION FROM ^XTMP
"RTN","PSOORRDI",83,0)
 N PSORDI,LOCAL
"RTN","PSOORRDI",84,0)
 S PSORDI=0 F  S PSORDI=$O(^XTMP("ORRDI","PSOO",PSODFN,PSORDI)) Q:'PSORDI  D
"RTN","PSOORRDI",85,0)
 .S RDISTA=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,5,0))
"RTN","PSOORRDI",86,0)
 .S RDIINST=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,1,0))
"RTN","PSOORRDI",87,0)
 .S RDIDNAM=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,2,0))
"RTN","PSOORRDI",88,0)
 .S RDIVUID=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,3,0)) I RDIVUID="" Q
"RTN","PSOORRDI",89,0)
 .S RDIRX=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,4,0))
"RTN","PSOORRDI",90,0)
 .S RDIQTY=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,6,0)),RDIDAYS=$P(RDIQTY,";",2),RDIQTY=$P(RDIQTY,";")
"RTN","PSOORRDI",91,0)
 .I $E(RDIDAYS)="D" S RDIDAYS=$P(RDIDAYS,"D",2)
"RTN","PSOORRDI",92,0)
 .S RDIEXP=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,7,0))
"RTN","PSOORRDI",93,0)
 .S RDIISS=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,8,0))
"RTN","PSOORRDI",94,0)
 .I RDIRX'="" S LOCAL=0 D CHKLOCAL I LOCAL Q
"RTN","PSOORRDI",95,0)
 .S RDIFILL=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,9,0))
"RTN","PSOORRDI",96,0)
 .S RDIREF=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,10,0))
"RTN","PSOORRDI",97,0)
 .S RDIPHYS=$G(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,11,0))
"RTN","PSOORRDI",98,0)
 .S PSOSIG="" F  S PSOSIG=$O(^XTMP("ORRDI","PSOO",PSODFN,PSORDI,14,PSOSIG)) Q:PSOSIG=""  S PSOSIG(PSOSIG)=^(PSOSIG)
"RTN","PSOORRDI",99,0)
 .S ^TMP($J,"PSORDI",PSORDI)=RDIINST_"^"_RDIVUID_"^"_RDIDNAM_"^"_RDISTA_"^"_RDIRX_"^"_RDIFILL_"^"_RDIDAYS_"^"_RDIQTY_"^"_RDIREF_"^"_RDIEXP_"^"_RDIPHYS_"^"_RDIISS
"RTN","PSOORRDI",100,0)
 .S PSOSIG="" F  S PSOSIG=$O(PSOSIG(PSOSIG)) Q:PSOSIG=""  S ^TMP($J,"PSORDI",PSORDI,"SIG",PSOSIG)=PSOSIG(PSOSIG)
"RTN","PSOORRDI",101,0)
 Q
"RTN","PSOORRDI",102,0)
 ;
"RTN","PSOORRDI",103,0)
CHKLOCAL ; IF SAME RX NUMBER AND ISSUE DATE - LOCAL RX
"RTN","PSOORRDI",104,0)
 I $D(^PSRX("B",RDIRX)) D
"RTN","PSOORRDI",105,0)
 .N PSORX,ISSUE
"RTN","PSOORRDI",106,0)
 .S PSORX=$O(^PSRX("B",RDIRX,"")) I 'PSORX Q
"RTN","PSOORRDI",107,0)
 .S PSOISS=$P($G(^PSRX(PSORX,0)),"^",13)
"RTN","PSOORRDI",108,0)
 .S ISSUE=$E(DT)_$P(RDIISS,"/",3)_$P(RDIISS,"/")_$P(RDIISS,"/",2)
"RTN","PSOORRDI",109,0)
 .I PSOISS=ISSUE S LOCAL=1 Q
"RTN","PSOORRDI",110,0)
 Q
"RTN","PSOORRDI",111,0)
 ;
"RTN","PSOORRDI",112,0)
VAPROD(PSOPROD) ; GET VA PRODUCT FILE NAME AND DRUG CLASS
"RTN","PSOORRDI",113,0)
 S PSOCLASS=$$DCLCODE^PSNAPIS(,PSOPROD)
"RTN","PSOORRDI",114,0)
 S DRNM=$P($$PROD0^PSNAPIS(,PSOPROD),"^")
"RTN","PSOORRDI",115,0)
 Q
"RTN","PSOORRDI",116,0)
 ;
"RTN","PSOORRDI",117,0)
DRGNAME ; 
"RTN","PSOORRDI",118,0)
 N PSOY
"RTN","PSOORRDI",119,0)
 S PSOY=DREN_"^"_$P($G(^PSDRUG(DREN,0)),"^"),PSOY(0)=$G(^PSDRUG(DREN,0))
"RTN","PSOORRDI",120,0)
 S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2)
"RTN","PSOORRDI",121,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORRDI",122,0)
 I PSODRUG("NDF")=0 S PSODRUG("NAME")="" Q
"RTN","PSOORRDI",123,0)
 S PSOPROD=$P(PSODRUG("NDF"),"A",2) I PSOPROD D VAPROD(PSOPROD) S PSODRUG("NAME")=DRNM
"RTN","PSOORRDI",124,0)
 Q
"RTN","PSOORRDI",125,0)
 ;
"RTN","PSOORRDI",126,0)
FILTER ; FOR SAME DRUG VUID FOR SAME SITE, KEEP 1 ENTRY - CHECK BY ACTIVE STATUS FIRST THEN BY GREATEST EXPIRATION DATE
"RTN","PSOORRDI",127,0)
 N XX,RDI,OLDEXP,RDIEXP,RDIEXP2,OLDEXP2,PSORDI,RDISTA,OLDSTA,OLDRDI,ZZ
"RTN","PSOORRDI",128,0)
 S PSORDI=0
"RTN","PSOORRDI",129,0)
 F  S PSORDI=$O(^TMP($J,"PSORDI",PSORDI)) Q:'PSORDI  D
"RTN","PSOORRDI",130,0)
 .S XX=$G(^TMP($J,"PSORDI",PSORDI)),RDIINST=$P(XX,"^"),RDIVUID=$P(XX,"^",2),RDISTA=$P(XX,"^",4),RDIEXP=$P(XX,"^",10) Q:RDIINST=""  Q:RDIVUID=""  I RDIEXP="" Q
"RTN","PSOORRDI",131,0)
 .I $D(RDI(RDIINST,RDIVUID)) S ZZ=RDI(RDIINST,RDIVUID) D  Q
"RTN","PSOORRDI",132,0)
 ..I RDISTA="ACTIVE"!(RDISTA["SUSPEN") D  Q
"RTN","PSOORRDI",133,0)
 ...S OLDSTA=$P(ZZ,"^",2) I OLDSTA["ACTIVE"!(OLDSTA["SUSPEN") D CHKEXP Q
"RTN","PSOORRDI",134,0)
 ...S OLDRDI=$P(ZZ,"^") K ^TMP($J,"PSORDI",OLDRDI) D SETRDI
"RTN","PSOORRDI",135,0)
 ..S OLDSTA=$P(ZZ,"^",2) I OLDSTA["ACTIVE"!(OLDSTA["SUSPEN") K ^TMP($J,"PSORDI",PSORDI) Q
"RTN","PSOORRDI",136,0)
 ..D CHKEXP ; ALL OTHER STATUSES - KEEP BY GREATER EXPIRATION DATE
"RTN","PSOORRDI",137,0)
 .D SETRDI
"RTN","PSOORRDI",138,0)
 Q
"RTN","PSOORRDI",139,0)
 ;
"RTN","PSOORRDI",140,0)
CHKEXP ; 
"RTN","PSOORRDI",141,0)
 S OLDEXP=$P(ZZ,"^",3) D  I OLDEXP2>RDIEXP2 K ^TMP($J,"PSORDI",PSORDI) Q
"RTN","PSOORRDI",142,0)
 .S RDIEXP2=$E(DT)_$P(RDIEXP,"/",3)_$P(RDIEXP,"/")_$P(RDIEXP,"/",2)
"RTN","PSOORRDI",143,0)
 .S OLDEXP2=$E(DT)_$P(OLDEXP,"/",3)_$P(OLDEXP,"/")_$P(OLDEXP,"/",2)
"RTN","PSOORRDI",144,0)
 S OLDRDI=$P(ZZ,"^") K ^TMP($J,"PSORDI",OLDRDI) D SETRDI
"RTN","PSOORRDI",145,0)
 Q
"RTN","PSOORRDI",146,0)
 ;
"RTN","PSOORRDI",147,0)
SETRDI S RDI(RDIINST,RDIVUID)=PSORDI_"^"_RDISTA_"^"_RDIEXP
"RTN","PSOORRDI",148,0)
 Q
"RTN","PSOORRDI",149,0)
 ;
"RTN","PSOVER1")
0^8^B48618041
"RTN","PSOVER1",1,0)
PSOVER1 ;BHAM ISC/SAB - verify one rx ;3/9/05 12:53pm
"RTN","PSOVER1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,46,90,131,202,207**;DEC 1997
"RTN","PSOVER1",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOVER1",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER1",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOVER1",6,0)
 ;External reference to PSSORPH is supported by DBIA 3234
"RTN","PSOVER1",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOVER1",8,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOVER1",9,0)
REDO S (DRG,PSODRUG("NAME"))=$P(^PSDRUG(+$P(^PSRX(PSONV,0),"^",6),0),"^"),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",10,0)
 S (STA,DNM)="",PSDPSTOP=0,$P(PSONULN,"-",79)="-" F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""  K PSZZZDUP I $P(PSOSD(STA,DNM),"^",2)<10 D
"RTN","PSOVER1",11,0)
 .I STA="ZNONVA" D NVA Q
"RTN","PSOVER1",12,0)
 .I PSODRUG("NAME")=$P(DNM,"^")&(PSONV'=$P(PSOSD(STA,DNM),"^")) S PSZZZDUP=1 K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" W ! D ^DIR K DIR S PSDTSTOP=1
"RTN","PSOVER1",13,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(PSOSD(STA,DNM),"^",5),1,4),PSODRUG("NAME")'=$P(DNM,"^") K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" W ! D ^DIR K DIR D CLS^PSODRDUP S PSDTSTOP=1
"RTN","PSOVER1",14,0)
 .I $G(PSZZZDUP),$G(PSVFLAG),$P($G(^PSRX($P(PSOSD(STA,DNM),"^"),"STA")),"^")=12,$D(^PS(52.4,$P(PSOSD(STA,DNM),"^"),0)) S DA=$P(PSOSD(STA,DNM),"^"),DIK="^PS(52.4," D ^DIK K DIK
"RTN","PSOVER1",15,0)
 .I $G(PSZZZDUP),$G(PSVFLAG),$P($G(^PSRX($P(PSOSD(STA,DNM),"^"),"STA")),"^")'=12 S PSZZQUIT=1
"RTN","PSOVER1",16,0)
 K MSG I $G(PSZZQUIT),$G(PSVFLAG) K PSZZQUIT,PSODRUG,PSODFN,PSZZZDUP,DNM,PSDTSTOP D CLEAN Q
"RTN","PSOVER1",17,0)
 D REMOTE
"RTN","PSOVER1",18,0)
 K PSODRUG,PSODFN,PSZZZDUP,DNM,PSZZQUIT
"RTN","PSOVER1",19,0)
ALLR ;Allergy check
"RTN","PSOVER1",20,0)
 G:'$P($G(^PSRX(PSONV,3)),"^",6) EDIT
"RTN","PSOVER1",21,0)
 I '$G(PSDTSTOP) K DIR S DIR(0)="E" D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) K PSDTSTOP G OUT
"RTN","PSOVER1",22,0)
 W !!,"A Drug-Allergy Reaction exists for this medication!",!!,"***SIGNIFICANT*** Allergy Reaction"
"RTN","PSOVER1",23,0)
 W !,"Drug: ",$P($G(^PSDRUG(+$P($G(^PSRX(PSONV,0)),"^",6),0)),"^")
"RTN","PSOVER1",24,0)
 I $O(^PSRX(PSONV,"DAI",0)) W !?6,"Ingredients: " D
"RTN","PSOVER1",25,0)
 .F PSPPP=0:0 S PSPPP=$O(^PSRX(PSONV,"DAI",PSPPP)) Q:'PSPPP  I $G(^(PSPPP,0))'="" W:$X+$L($G(^PSRX(PSONV,"DAI",PSPPP,0)))+2>IOM !?19 W $G(^PSRX(PSONV,"DAI",PSPPP,0))_", "
"RTN","PSOVER1",26,0)
 W ! K DIR,PSPPP S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to intervene?" D ^DIR K DIR I X["^"!($D(DTOUT))!($D(DUOUT)) K PSDTSTOP G OUT
"RTN","PSOVER1",27,0)
 I Y S PSORX("INTERVENE")=0 D EN1^PSORXI(PSONV)
"RTN","PSOVER1",28,0)
EDIT I $G(PKI1)=2 D DCV1^PSOPKIV1 G OUT
"RTN","PSOVER1",29,0)
 K PSDTSTOP S DIR("A")="EDIT",DIR("B")="N",DIR(0)="SB^Y:YES;N:NO;P:PROFILE",DIR("?")="Enter Y to change this RX, P to see a profile, or N to procede with verification"
"RTN","PSOVER1",30,0)
 D ^DIR K DIR I Y="Y",$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",31,0)
 I $D(DIRUT),$G(PSOCLK) S PSOCQ=1 G OUT
"RTN","PSOVER1",32,0)
 I $D(DIRUT),$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",33,0)
 G VERIFY:Y="N",PROF:Y="P",OUT:"YNP"'[$E(Y)
"RTN","PSOVER1",34,0)
CHANGE S DA=PSONV,(PSRX1,PSRX2)=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",35,0)
 S DEA1=1,DEA2=0,PSDOLD=+DA,DIE="^PSRX(",DR="3;7;8;9;4;5;12;1;22;11;"_$S($P(PSOPAR,"^",12):"35;",1:"")_$S($P(PSOPAR,"^",15):"10.6",1:"")_";@2" D ^DIE
"RTN","PSOVER1",36,0)
 ;I PSRX1'=PSRX2,DEA1'=DEA2 S DR="6////"_PSRX1 D ^DIE
"RTN","PSOVER1",37,0)
 D EXPIRE K DIE,DR,DEA1,DEA2,P(5),PSRX1,PSRX2
"RTN","PSOVER1",38,0)
 K PSD(PSDOLD) S PSDNEW=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV,PSD(PSDNEW)=PSONV_"^*^1^"_$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^",2)
"RTN","PSOVER1",39,0)
 S DA=PSONV D ^PSORXPR
"RTN","PSOVER1",40,0)
 G EDIT:PSDNEW=PSDOLD,REDO
"RTN","PSOVER1",41,0)
PROF I '$D(PSOSD) W !,$C(7),"This patient has no other prescriptions on file",!! G EDIT Q
"RTN","PSOVER1",42,0)
 D ^PSODSPL G EDIT Q
"RTN","PSOVER1",43,0)
 ;
"RTN","PSOVER1",44,0)
EXPIRE S RX0=^PSRX(DA,0),X1=$P($P(RX0,"^",13),"."),X2=$P(RX0,"^",9)+1*$P(RX0,"^",8),X2=$S($P(RX0,"^",8)=X2:X2,X2<181:184,X2=360:366,1:X2),X=X1 D:X1&X2 C^%DTC
"RTN","PSOVER1",45,0)
 K ^PS(55,PSDFN,"P","A",+$P(^PSRX(DA,2),"^",6),DA) S ^PS(55,PSDFN,"P","A",X,DA)="",$P(^PSRX(DA,2),"^",6)=X,$P(^PS(52.4,DA,0),"^",7)=X Q
"RTN","PSOVER1",46,0)
VERIFY G:'$P(PSOPAR,"^",2) VERY
"RTN","PSOVER1",47,0)
 S DIR("A")="VERIFY FOR "_PSONAM_" ? (Y/N/Delete/Quit): ",DIR("B")="Y",DIR(0)="SA^Y:YES;N:NO;D:DELETE;Q:QUIT"
"RTN","PSOVER1",48,0)
 S DIR("?",1)="Enter Y (or return) to verify this prescription",DIR("?",2)="N to leave this prescription non-verified and to end this session of verification",DIR("?")="D to delete this prescription"
"RTN","PSOVER1",49,0)
 D ^DIR K DIR G OUT:Y="N",QUIT:"Q^"[$E(Y),DELETE:Y="D"
"RTN","PSOVER1",50,0)
VERY I $G(PKI1)=1 D REA^PSOPKIV1 G:'$D(PKIR) VERIFY
"RTN","PSOVER1",51,0)
 K ^PSRX(PSONV,"DAI") S $P(^PSRX(PSONV,3),"^",6)=""
"RTN","PSOVER1",52,0)
 K ^PSRX(PSONV,"DRI"),SPFL
"RTN","PSOVER1",53,0)
 I '$O(^PSRX(PSONV,6,0)) D  I $D(DUOUT)!($D(DTOUT)) W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" not Verified!!",! H 2 G OUT
"RTN","PSOVER1",54,0)
 .W !!,"Dosing Instructions Missing. Please add!",!
"RTN","PSOVER1",55,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^")]"",'$P($G(^("SIG")),"^",2) W "SIG: "_$P(^PSRX(PSONV,"SIG"),"^"),!
"RTN","PSOVER1",56,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^",2),$O(^PSRX(PSONV,"SIG1",0)) D  K I
"RTN","PSOVER1",57,0)
 ..W "SIG: " F I=0:0 S I=$O(^PSRX(PSONV,"SIG1",I)) Q:'I  W ^PSRX(PSONV,"SIG1",I,0),!
"RTN","PSOVER1",58,0)
 .S DA=PSONV,PSOVER=1 K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOVER1",59,0)
 .S PSODRUG("IEN")=$P(^PSRX(DA,0),"^",6),PSODFN=$P(^(0),"^",2),PSORXED("IRXN")=DA,PSODRUG("OI")=$P(^PSRX(DA,"OR1"),"^")
"RTN","PSOVER1",60,0)
 .D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN),^PSOORED3
"RTN","PSOVER1",61,0)
 .K PSODFN,PSODRUG("IEN"),DOSE,PSOVER
"RTN","PSOVER1",62,0)
 .I '$G(ENT) S DUOUT=1
"RTN","PSOVER1",63,0)
 .Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSOVER1",64,0)
 .K DIR,DIRUT,DUOUT,DTOUT S DIE=52,DR=114 D ^DIE K DIE,DR,DTOUT
"RTN","PSOVER1",65,0)
 .I X'="" D SIG^PSOHELP D:$G(INS1)]"" EN^DDIOL($E(INS1,2,9999999)) S PSORXED("SIG",1)=$E(INS1,2,9999999)
"RTN","PSOVER1",66,0)
 .D EN^PSOFSIG(.PSORXED,1),UDSIG^PSOORED3 H 2
"RTN","PSOVER1",67,0)
 S DA=PSONV,$P(^PSRX(DA,2),"^",10)=DUZ I $P(^PSRX(DA,2),"^",2)>DT,$P(PSOPAR,"^",6) S (SPFL1,PSOVER)="",PSORX("FILL DATE")=$P(^(2),"^",2),RXF=0 D UPSUS S PSTRIVER=1 D SUS^PSORXL K PSORX("FILL DATE"),PSTRIVER G KILL
"RTN","PSOVER1",68,0)
 S PSOVER(PSONV)="" S $P(^PSRX(PSONV,"STA"),"^")=0,$P(PSOSD("NON-VERIFIED",DRG),"^",2)=0,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG)
"RTN","PSOVER1",69,0)
 I $G(PKI1)=1,$G(PKIR)]"" D ACT^PSOPKIV1(DA)
"RTN","PSOVER1",70,0)
 K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",71,0)
KILL S DA=PSONV,DIK="^PS(52.4," D ^DIK K DA,DIK D DCORD^PSONEW2
"RTN","PSOVER1",72,0)
OUT K DIRUT,DTOUT,DUOUT,UPFLAGX D CLEAN Q
"RTN","PSOVER1",73,0)
DELETE K UPFLAGX D DELETE^PSOVER2 G:$G(UPFLAGX) OUT K PSOSD("NON-VERIFIED",$G(DRG)) Q
"RTN","PSOVER1",74,0)
QUIT S PSOQUIT="" D CLEAN Q
"RTN","PSOVER1",75,0)
UPSUS S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=5,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG) K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",76,0)
 Q
"RTN","PSOVER1",77,0)
CLEAN ;cleans up tmp("psorxdc") global
"RTN","PSOVER1",78,0)
 I $O(^TMP("PSORXDC",$J,0)) F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D
"RTN","PSOVER1",79,0)
 .D PSOUL^PSSLOCK(RORD_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"S",1:""))
"RTN","PSOVER1",80,0)
 .W !,$S($P(^TMP("PSORXDC",$J,RORD,0),"^")=52:"Prescription",1:"Pending Order")_" #"_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")=52:$P(^PSRX(RORD,0),"^"),1:RORD)_" NOT Discontinued."
"RTN","PSOVER1",81,0)
 K ^TMP("PSORXDC",$J),RORD
"RTN","PSOVER1",82,0)
 Q
"RTN","PSOVER1",83,0)
KV1 ;
"RTN","PSOVER1",84,0)
 K PSOANSQD,DRET,LST,PSOQUIT,PSODRUG,PSONEW,SIG,PSODIR,PHI,PRC,ORCHK,ORDRG,PSOSIGFL,PSORX("ISSUE DATE"),PSORX("FILL DATE"),CLOZPAT
"RTN","PSOVER1",85,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOVER1",86,0)
 Q
"RTN","PSOVER1",87,0)
NVA ;
"RTN","PSOVER1",88,0)
 I $P(PSOSD(STA,DNM),"^",11) D NVA^PSODRDU1 Q
"RTN","PSOVER1",89,0)
 N PSOOI,CLASS,FLG,X,Y,RXREC,IFN
"RTN","PSOVER1",90,0)
 S (Y,FLG)=""
"RTN","PSOVER1",91,0)
 S RXREC=$P(PSOSD(STA,DNM),"^",10),PSOOI=+$G(^PS(55,DFN,"NVA",RXREC,0)),IFN=RXREC N DNM
"RTN","PSOVER1",92,0)
 F  S Y=$O(^PSDRUG("ASP",PSOOI,Y)) Q:Y=""!(FLG)  S DNM=$P(^PSDRUG(Y,0),"^"),CLASS=$P(^PSDRUG(Y,0),"^",2) I PSODRUG("NAME")=DNM!(CLASS=PSODRUG("VA CLASS")) D DSP^PSODRDU1 S FLG=1 Q
"RTN","PSOVER1",93,0)
 Q
"RTN","PSOVER1",94,0)
REMOTE ; 
"RTN","PSOVER1",95,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN) D
"RTN","PSOVER1",96,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOVER1",97,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOVER1",98,0)
 .W !,"Now doing remote order checks. Please wait..."
"RTN","PSOVER1",99,0)
 .D REMOTE^PSOORRDI(PSODFN,+$P($G(^PSRX(PSONV,0)),"^",6))
"RTN","PSOVER1",100,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !,"Remote data not available - Only local order checks processed." D PAUSE^PSOORRD2 Q
"RTN","PSOVER1",101,0)
 .I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOVER1",102,0)
 .I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOVER1",103,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSOVER1",104,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN)
"RTN","PSOVER1",105,0)
 Q
"VER")
8.0^22.0
"BLD",5333,6)
^200
**END**
**END**
