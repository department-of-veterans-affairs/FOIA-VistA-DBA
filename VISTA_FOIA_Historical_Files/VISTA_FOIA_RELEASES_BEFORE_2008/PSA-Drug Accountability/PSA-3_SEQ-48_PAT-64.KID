Released PSA*3*64 SEQ #48
Extracted from mail message
**KIDS**:PSA*3.0*64^

**INSTALL NAME**
PSA*3.0*64
"BLD",6351,0)
PSA*3.0*64^DRUG ACCOUNTABILITY^0^3070530^y
"BLD",6351,1,0)
^^13^13^3070510^
"BLD",6351,1,1,0)
With the deployment of Cache version 5, it was discovered that the short
"BLD",6351,1,2,0)
lock timeout values could generate a lock failure. Patch DI*22*147, which
"BLD",6351,1,3,0)
has already been released, provided a solution to resolve this issue and
"BLD",6351,1,4,0)
future lock issues.
"BLD",6351,1,5,0)
 
"BLD",6351,1,6,0)
This patch instituted a new default lock timeout of three seconds based on
"BLD",6351,1,7,0)
a global node setting of ^DD("DILOCKTM")=3.
"BLD",6351,1,8,0)
 
"BLD",6351,1,9,0)
In order to avoid the lock issue in Drug Accountability, this patch
"BLD",6351,1,10,0)
modifies all routines that currently use a lock timeout value of less than
"BLD",6351,1,11,0)
3 seconds to check for the node ^DD("DILOCKTM") and to use the value
"BLD",6351,1,12,0)
defined there, otherwise the lock timeout value is set to a default value
"BLD",6351,1,13,0)
of 3 seconds.
"BLD",6351,4,0)
^9.64PA^^
"BLD",6351,6.3)
4
"BLD",6351,"KRN",0)
^9.67PA^8989.52^19
"BLD",6351,"KRN",.4,0)
.4
"BLD",6351,"KRN",.401,0)
.401
"BLD",6351,"KRN",.402,0)
.402
"BLD",6351,"KRN",.403,0)
.403
"BLD",6351,"KRN",.5,0)
.5
"BLD",6351,"KRN",.84,0)
.84
"BLD",6351,"KRN",3.6,0)
3.6
"BLD",6351,"KRN",3.8,0)
3.8
"BLD",6351,"KRN",9.2,0)
9.2
"BLD",6351,"KRN",9.8,0)
9.8
"BLD",6351,"KRN",9.8,"NM",0)
^9.68A^26^23
"BLD",6351,"KRN",9.8,"NM",1,0)
PSAAOP^^0^B15158373
"BLD",6351,"KRN",9.8,"NM",2,0)
PSABRKU4^^0^B39640697
"BLD",6351,"KRN",9.8,"NM",3,0)
PSACREDR^^0^B31030103
"BLD",6351,"KRN",9.8,"NM",4,0)
PSADJ^^0^B54586571
"BLD",6351,"KRN",9.8,"NM",5,0)
PSADJI^^0^B11144937
"BLD",6351,"KRN",9.8,"NM",6,0)
PSADRUG^^0^B22959232
"BLD",6351,"KRN",9.8,"NM",7,0)
PSADRUGP^^0^B23255227
"BLD",6351,"KRN",9.8,"NM",9,0)
PSAGIP^^0^B22355632
"BLD",6351,"KRN",9.8,"NM",10,0)
PSANAC^^0^B28480859
"BLD",6351,"KRN",9.8,"NM",11,0)
PSAOP1^^0^B18529492
"BLD",6351,"KRN",9.8,"NM",12,0)
PSAOUT^^0^B52860925
"BLD",6351,"KRN",9.8,"NM",13,0)
PSAPOST^^0^B3906198
"BLD",6351,"KRN",9.8,"NM",14,0)
PSAPROC7^^0^B51722446
"BLD",6351,"KRN",9.8,"NM",15,0)
PSAPROC8^^0^B42624373
"BLD",6351,"KRN",9.8,"NM",16,0)
PSAPSI1^^0^B9754975
"BLD",6351,"KRN",9.8,"NM",17,0)
PSAREC1^^0^B27528153
"BLD",6351,"KRN",9.8,"NM",19,0)
PSARWS^^0^B17261058
"BLD",6351,"KRN",9.8,"NM",20,0)
PSATRAN1^^0^B21031652
"BLD",6351,"KRN",9.8,"NM",21,0)
PSAUDP^^0^B16486615
"BLD",6351,"KRN",9.8,"NM",23,0)
PSAVER2^^0^B49116158
"BLD",6351,"KRN",9.8,"NM",24,0)
PSAVER3^^0^B71438317
"BLD",6351,"KRN",9.8,"NM",25,0)
PSAVER6^^0^B57278289
"BLD",6351,"KRN",9.8,"NM",26,0)
PSAVER7^^0^B23378139
"BLD",6351,"KRN",9.8,"NM","B","PSAAOP",1)

"BLD",6351,"KRN",9.8,"NM","B","PSABRKU4",2)

"BLD",6351,"KRN",9.8,"NM","B","PSACREDR",3)

"BLD",6351,"KRN",9.8,"NM","B","PSADJ",4)

"BLD",6351,"KRN",9.8,"NM","B","PSADJI",5)

"BLD",6351,"KRN",9.8,"NM","B","PSADRUG",6)

"BLD",6351,"KRN",9.8,"NM","B","PSADRUGP",7)

"BLD",6351,"KRN",9.8,"NM","B","PSAGIP",9)

"BLD",6351,"KRN",9.8,"NM","B","PSANAC",10)

"BLD",6351,"KRN",9.8,"NM","B","PSAOP1",11)

"BLD",6351,"KRN",9.8,"NM","B","PSAOUT",12)

"BLD",6351,"KRN",9.8,"NM","B","PSAPOST",13)

"BLD",6351,"KRN",9.8,"NM","B","PSAPROC7",14)

"BLD",6351,"KRN",9.8,"NM","B","PSAPROC8",15)

"BLD",6351,"KRN",9.8,"NM","B","PSAPSI1",16)

"BLD",6351,"KRN",9.8,"NM","B","PSAREC1",17)

"BLD",6351,"KRN",9.8,"NM","B","PSARWS",19)

"BLD",6351,"KRN",9.8,"NM","B","PSATRAN1",20)

"BLD",6351,"KRN",9.8,"NM","B","PSAUDP",21)

"BLD",6351,"KRN",9.8,"NM","B","PSAVER2",23)

"BLD",6351,"KRN",9.8,"NM","B","PSAVER3",24)

"BLD",6351,"KRN",9.8,"NM","B","PSAVER6",25)

"BLD",6351,"KRN",9.8,"NM","B","PSAVER7",26)

"BLD",6351,"KRN",19,0)
19
"BLD",6351,"KRN",19.1,0)
19.1
"BLD",6351,"KRN",101,0)
101
"BLD",6351,"KRN",409.61,0)
409.61
"BLD",6351,"KRN",771,0)
771
"BLD",6351,"KRN",870,0)
870
"BLD",6351,"KRN",8989.51,0)
8989.51
"BLD",6351,"KRN",8989.52,0)
8989.52
"BLD",6351,"KRN",8994,0)
8994
"BLD",6351,"KRN","B",.4,.4)

"BLD",6351,"KRN","B",.401,.401)

"BLD",6351,"KRN","B",.402,.402)

"BLD",6351,"KRN","B",.403,.403)

"BLD",6351,"KRN","B",.5,.5)

"BLD",6351,"KRN","B",.84,.84)

"BLD",6351,"KRN","B",3.6,3.6)

"BLD",6351,"KRN","B",3.8,3.8)

"BLD",6351,"KRN","B",9.2,9.2)

"BLD",6351,"KRN","B",9.8,9.8)

"BLD",6351,"KRN","B",19,19)

"BLD",6351,"KRN","B",19.1,19.1)

"BLD",6351,"KRN","B",101,101)

"BLD",6351,"KRN","B",409.61,409.61)

"BLD",6351,"KRN","B",771,771)

"BLD",6351,"KRN","B",870,870)

"BLD",6351,"KRN","B",8989.51,8989.51)

"BLD",6351,"KRN","B",8989.52,8989.52)

"BLD",6351,"KRN","B",8994,8994)

"BLD",6351,"QUES",0)
^9.62^^
"BLD",6351,"REQB",0)
^9.611^8^6
"BLD",6351,"REQB",2,0)
PSA*3.0*61^2
"BLD",6351,"REQB",3,0)
PSA*3.0*51^2
"BLD",6351,"REQB",4,0)
PSA*3.0*56^2
"BLD",6351,"REQB",5,0)
PSA*3.0*37^2
"BLD",6351,"REQB",7,0)
PSA*3.0*25^2
"BLD",6351,"REQB",8,0)
PSA*3.0*60^2
"BLD",6351,"REQB","B","PSA*3.0*25",7)

"BLD",6351,"REQB","B","PSA*3.0*37",5)

"BLD",6351,"REQB","B","PSA*3.0*51",3)

"BLD",6351,"REQB","B","PSA*3.0*56",4)

"BLD",6351,"REQB","B","PSA*3.0*60",8)

"BLD",6351,"REQB","B","PSA*3.0*61",2)

"MBREQ")
0
"PKG",287,-1)
1^1
"PKG",287,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",287,22,0)
^9.49I^1^1
"PKG",287,22,1,0)
3.0^2971024^2971030^11595
"PKG",287,22,1,"PAH",1,0)
64^3070530
"PKG",287,22,1,"PAH",1,1,0)
^^13^13^3070530
"PKG",287,22,1,"PAH",1,1,1,0)
With the deployment of Cache version 5, it was discovered that the short
"PKG",287,22,1,"PAH",1,1,2,0)
lock timeout values could generate a lock failure. Patch DI*22*147, which
"PKG",287,22,1,"PAH",1,1,3,0)
has already been released, provided a solution to resolve this issue and
"PKG",287,22,1,"PAH",1,1,4,0)
future lock issues.
"PKG",287,22,1,"PAH",1,1,5,0)
 
"PKG",287,22,1,"PAH",1,1,6,0)
This patch instituted a new default lock timeout of three seconds based on
"PKG",287,22,1,"PAH",1,1,7,0)
a global node setting of ^DD("DILOCKTM")=3.
"PKG",287,22,1,"PAH",1,1,8,0)
 
"PKG",287,22,1,"PAH",1,1,9,0)
In order to avoid the lock issue in Drug Accountability, this patch
"PKG",287,22,1,"PAH",1,1,10,0)
modifies all routines that currently use a lock timeout value of less than
"PKG",287,22,1,"PAH",1,1,11,0)
3 seconds to check for the node ^DD("DILOCKTM") and to use the value
"PKG",287,22,1,"PAH",1,1,12,0)
defined there, otherwise the lock timeout value is set to a default value
"PKG",287,22,1,"PAH",1,1,13,0)
of 3 seconds.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
23
"RTN","PSAAOP")
0^1^B15158373^B15006908
"RTN","PSAAOP",1,0)
PSAAOP ;BIR/DB - Price Conversion Routine;4/3/00
"RTN","PSAAOP",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**21,64**; 10/24/97;Build 4
"RTN","PSAAOP",3,0)
 ;PSA*3*21 : 14145837
"RTN","PSAAOP",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAAOP",5,0)
Q K DA,DIE,DIR,DR,PSALOC,PSALOCN,PSAOP,PSAOSITN
"RTN","PSAAOP",6,0)
 W !!,"PSA*3*21 corrects errors in the way pricing was done in the past. The new",!,"process correctly calculates the price per dispense unit by dividing"
"RTN","PSAAOP",7,0)
 W !,"the Price per Order Unit by the Dispense Units per Order Unit.",!!,"It loops through each entry in the DRUG file (#50) and corrects any problems"
"RTN","PSAAOP",8,0)
 W !,"found in the synonym data."
"RTN","PSAAOP",9,0)
 W !!,"Please note - Because this process checks each NDC in the DRUG file (#50),"
"RTN","PSAAOP",10,0)
 W !,"it is suggested that you queue the option to run during low usage times."
"RTN","PSAAOP",11,0)
PRICE R !!,"Fix synonym entries? YES // ",AN:DTIME G NOQ:AN["^" I AN="" S AN="Y"
"RTN","PSAAOP",12,0)
 S AN=$E(AN,1) I "yYNn"'[AN W !!,"Answer 'Y' for YES, or 'N' for NO." K AN G PRICE
"RTN","PSAAOP",13,0)
 I "nN"[AN G NOQ
"RTN","PSAAOP",14,0)
 S PSADUZ=DUZ,ZTSAVE("PSADUZ")=""
"RTN","PSAAOP",15,0)
 S ZTIO=""
"RTN","PSAAOP",16,0)
 S ZTRTN="PSANDC^PSAAOP",ZTDESC="Drug Accountability Price Correction" D ^%ZTLOAD,HOME^%ZIS G EXITQ
"RTN","PSAAOP",17,0)
 ;
"RTN","PSAAOP",18,0)
PSANDC ;Entry point for price correction
"RTN","PSAAOP",19,0)
 ;
"RTN","PSAAOP",20,0)
 K PSADRG,PSACNT,PSADRG1,PSASUB,PSADATA,DRGCNT,FIXCNT
"RTN","PSAAOP",21,0)
PSADRG S PSADRG1=$S('$D(PSADRG1):$O(^PSDRUG("B",0)),1:$O(^PSDRUG("B",PSADRG1))) G QQ:PSADRG1="" K PSASUB S DRGCNT=$G(DRGCNT)+1,PSADRG=$O(^PSDRUG("B",PSADRG1,0)) I $G(^PSDRUG(PSADRG,0))="" G PSADRG
"RTN","PSAAOP",22,0)
 S PSANDC=$P($G(^PSDRUG(PSADRG,2)),"^",4) G PSADRG:$G(PSANDC)=""
"RTN","PSAAOP",23,0)
 ;
"RTN","PSAAOP",24,0)
PSASUB S PSASUB=$S('$D(PSASUB):$O(^PSDRUG(PSADRG,1,0)),1:$O(^PSDRUG(PSADRG,1,PSASUB))) G PSADRG:PSASUB'>0 S PSADATA=$G(^PSDRUG(PSADRG,1,PSASUB,0)) I $P(PSADATA,"^",2)=PSANDC G DONESUB
"RTN","PSAAOP",25,0)
 G PSASUB
"RTN","PSAAOP",26,0)
DONESUB S PSAOU=$P($G(PSADATA),"^",6),PSADUOU=$P($G(PSADATA),"^",7),PSAPDUOU=$J($P($G(PSADATA),"^",8),0,3) I $G(PSAOU)=""!($G(PSADUOU)="") G PSADRG
"RTN","PSAAOP",27,0)
 ;
"RTN","PSAAOP",28,0)
 S XX=PSAOU/PSADUOU,NEWPRICE=$J(XX,0,3) I NEWPRICE'=PSAPDUOU D
"RTN","PSAAOP",29,0)
 .S PSACNT=$S('$D(PSACNT):4,1:$G(PSACNT)+1),^TMP("PSAAOP",$J,PSACNT,0)="NDC       : "_PSANDC_"  Drug Name : "_$E($P($G(^PSDRUG(PSADRG,0)),"^"),1,35)
"RTN","PSAAOP",30,0)
 .S PSACNT=$S('$D(PSACNT):4,1:$G(PSACNT)+1),^TMP("PSAAOP",$J,PSACNT,0)="Old Price : "_$J(PSAPDUOU,8,3)_"        New Price : "_$J(NEWPRICE,8,3),PSACNT=PSACNT+1,^TMP("PSAAOP",$J,PSACNT,0)=" "
"RTN","PSAAOP",31,0)
 .S DIE="^PSDRUG(",DA=PSADRG,DR="16///^S X=NEWPRICE" D
"RTN","PSAAOP",32,0)
 ..F  L +^PSDRUG(PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAAOP",33,0)
 ..D ^DIE K DIE,DA,DR
"RTN","PSAAOP",34,0)
 ..S DA(1)=PSADRG,DIE="^PSDRUG("_DA(1)_",1,",DA=PSASUB,DR="404////^S X=NEWPRICE" D ^DIE
"RTN","PSAAOP",35,0)
 ..L -^PSDRUG(PSADRG,0)
"RTN","PSAAOP",36,0)
 .S FIXCNT=$G(FIXCNT)+1
"RTN","PSAAOP",37,0)
 G PSADRG
"RTN","PSAAOP",38,0)
QQ S ^TMP("PSAAOP",$J,2,0)=$G(DRGCNT)_" items checked, and "_$S($G(FIXCNT)="":0,1:$G(FIXCNT))_" items corrected." K PSADRG,PSAOU,PSADUOU,NEWPRICE,PSAPDUOU,DATA,PSADATA
"RTN","PSAAOP",39,0)
 S ^TMP("PSAAOP",$J,1,0)="Price correction process results"
"RTN","PSAAOP",40,0)
 S XMDUZ="Patch: PSA*3*21 price Corrector",XMSUB="Drug Accountability Synonym Fix",XMTEXT="^TMP(""PSAAOP"",$J,"
"RTN","PSAAOP",41,0)
 S XMY(PSADUZ)=""
"RTN","PSAAOP",42,0)
 G:'$D(XMY) QQ D ^XMD
"RTN","PSAAOP",43,0)
 K ^TMP("PSAAOP",$J)
"RTN","PSAAOP",44,0)
 Q
"RTN","PSAAOP",45,0)
NOQ W !,"Nothing corrected." Q
"RTN","PSAAOP",46,0)
EXITQ Q
"RTN","PSABRKU4")
0^2^B39640697^B39501736
"RTN","PSABRKU4",1,0)
PSABRKU4 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSABRKU4",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**26,64**; 10/24/97;Build 4
"RTN","PSABRKU4",3,0)
XTMP ;This modules copies the prime vendor data in ^TMP($J,"PSAPV SET") to
"RTN","PSABRKU4",4,0)
 ;^XTMP("PSAPV"). The data has passed all X12 checks.
"RTN","PSABRKU4",5,0)
 ;
"RTN","PSABRKU4",6,0)
 S X1=DT,X2=21 D C^%DTC L +^XTMP("PSAPV",0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I '$T Q
"RTN","PSABRKU4",7,0)
 S ^XTMP("PSAPV",0)=X_"^"_DT_"^Drug Accountability Prime Vendor Uploaded Invoice Data"
"RTN","PSABRKU4",8,0)
 ;
"RTN","PSABRKU4",9,0)
 ;Sets array of orders & invoices in XTMP (uploaded or processed).
"RTN","PSABRKU4",10,0)
 S PSACTRL=0 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:'PSACTRL  D
"RTN","PSABRKU4",11,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSABRKU4",12,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSABRKU4",13,0)
 .;DAVE B PSA*3*3 - Incomplete invoice deletion
"RTN","PSABRKU4",14,0)
 .I $P(PSAIN,"^",2)=""!($P(PSAIN,"^",4)="") K ^XTMP("PSAPV",PSACTRL) Q
"RTN","PSABRKU4",15,0)
 .S PSADUP($P(PSAIN,"^",4),$P(PSAIN,"^",2))=$S($P(PSAIN,"^",8)="P":"P",1:"U")
"RTN","PSABRKU4",16,0)
DUPLICAT ;
"RTN","PSABRKU4",17,0)
 ;Sets XTMP if incoming order & invoice is not a duplicate.
"RTN","PSABRKU4",18,0)
 S (PSACTRL,PSADUP)=0
"RTN","PSABRKU4",19,0)
 F  S PSACTRL=$O(^TMP($J,"PSAPV SET",PSACTRL)) S PSASET=PSACTRL Q:PSACTRL=""  D  S PSACTRL=PSASET
"RTN","PSABRKU4",20,0)
DAV .;
"RTN","PSABRKU4",21,0)
 .I $D(^XTMP("PSAPV",PSASET,"IN")) S DATA=^("IN") I $P(^TMP($J,"PSAPV SET",PSACTRL,"IN"),"^",4)'=$P(DATA,"^",4),$P(^TMP($J,"PSAPV SET",PSACTRL,"IN"),"^",2)'=$P(DATA,"^",2) S PSACHKR=1
"RTN","PSABRKU4",22,0)
 .I $D(PSACHKR) F  S PSASET=$G(PSASET)+.01 I '$D(^XTMP("PSAPV",PSASET)) K PSACHKR Q
"RTN","PSABRKU4",23,0)
 .;
"RTN","PSABRKU4",24,0)
 .S PSASEG="" F  S PSASEG=$O(^TMP($J,"PSAPV SET",PSACTRL,PSASEG)) Q:PSASEG=""  S PSADUP=0 D
"RTN","PSABRKU4",25,0)
 ..I PSASEG'="IT" D  Q
"RTN","PSABRKU4",26,0)
 ...I PSASEG="IN" S PSAIN=^TMP($J,"PSAPV SET",PSACTRL,PSASEG) D  Q
"RTN","PSABRKU4",27,0)
 ....I $P(PSAIN,"^",2)=""!($P(PSAIN,"^",4)="") K ^TMP($J,"PSAPV SET",PSACTRL) Q
"RTN","PSABRKU4",28,0)
 ....D CHKDUP Q:PSADUP
"RTN","PSABRKU4",29,0)
 ....S ^XTMP("PSAPV",PSASET,"IN")=^TMP($J,"PSAPV SET",PSACTRL,PSASEG)
"RTN","PSABRKU4",30,0)
 ....D DATES
"RTN","PSABRKU4",31,0)
 ....S PSAORD=$P($G(^TMP($J,"PSAPV SET",PSACTRL,"IN")),"^",4),PSAINV=$P($G(^("IN")),"^",2),PSAORDDT=$P($G(^("IN")),"^",3),PSAINVDT=$P($G(^("IN")),"^")
"RTN","PSABRKU4",32,0)
 ....S PSAGUI2(PSAORD)="",PSAGUI3(PSAINV)=""
"RTN","PSABRKU4",33,0)
 ....S ^TMP($J,"PSA GUI",PSAORD,PSAINV)=""
"RTN","PSABRKU4",34,0)
 ...I PSASEG'="IN" S ^XTMP("PSAPV",PSASET,PSASEG)=^TMP($J,"PSAPV SET",PSACTRL,PSASEG)
"RTN","PSABRKU4",35,0)
 ..I PSASEG="IT" S PSALINE=0 F  S PSALINE=$O(^TMP($J,"PSAPV SET",PSACTRL,PSASEG,PSALINE)) Q:'PSALINE  S ^XTMP("PSAPV",PSASET,PSASEG,PSALINE)=^TMP($J,"PSAPV SET",PSACTRL,PSASEG,PSALINE),PSAGUI4=$G(PSAGUI4)+1
"RTN","PSABRKU4",36,0)
 .K ^TMP($J,"PSAPV SET",PSACTRL)
"RTN","PSABRKU4",37,0)
 .I '$D(^XTMP("PSAPV",PSASET,"IT")) K ^XTMP("PSAPV",PSASET)
"RTN","PSABRKU4",38,0)
 L -^XTMP("PSAPV",0)
"RTN","PSABRKU4",39,0)
 Q
"RTN","PSABRKU4",40,0)
 ;
"RTN","PSABRKU4",41,0)
CHKDUP ;Checks for duplicate orders & invoices and duplicates in XTMP.
"RTN","PSABRKU4",42,0)
 I $D(PSADUP($P(PSAIN,"^",4),$P(PSAIN,"^",2))) S PSASTA=PSADUP($P(PSAIN,"^",4),$P(PSAIN,"^",2)),PSADUP=1 D  Q
"RTN","PSABRKU4",43,0)
 .S X12="** Order# "_$P(PSAIN,"^",4)_", invoice# "_$P(PSAIN,"^",2)_" has been "
"RTN","PSABRKU4",44,0)
 .I PSASTA="U" S X12=X12_"uploaded and" D SETMSG^PSABRKU8 S X12="is awaiting processing. It cannot be uploaded more than once." D SETMSG^PSABRKU8
"RTN","PSABRKU4",45,0)
 .I PSASTA'="U" S X12=X12_" processed and" D SETMSG^PSABRKU8 S X12="is being prepared for verification. It cannot be uploaded more than once." D SETMSG^PSABRKU8
"RTN","PSABRKU4",46,0)
 .K ^TMP($J,"PSAPV SET",PSACTRL) Q
"RTN","PSABRKU4",47,0)
 ;
"RTN","PSABRKU4",48,0)
 Q:'$D(^PSD(58.811,"AORD",$P(PSAIN,"^",4),$P(PSAIN,"^",2)))
"RTN","PSABRKU4",49,0)
 ;
"RTN","PSABRKU4",50,0)
 ;Checks for duplicates in 58.811
"RTN","PSABRKU4",51,0)
 S PSAORD=$P(PSAIN,"^",4),PSAINV=$P(PSAIN,"^",2),PSAORDN=$O(^PSD(58.811,"B",PSAORD,0)) Q:'PSAORDN
"RTN","PSABRKU4",52,0)
 S PSAINVN=$O(^PSD(58.811,PSAORDN,1,"B",PSAINV,0)) Q:'PSAINVN
"RTN","PSABRKU4",53,0)
 Q:'$D(^PSD(58.811,PSAORDN,1,PSAINVN,0))
"RTN","PSABRKU4",54,0)
 S PSAIN=^PSD(58.811,PSAORDN,1,PSAINVN,0),PSASTA=$P(PSAIN,"^",3),PSAPC=$S(PSASTA="P":6,PSASTA="V"!(PSASTA="C"):8,1:0)
"RTN","PSABRKU4",55,0)
 S (PSADT,PSALINE)=0 F  S PSALINE=$O(^PSD(58.811,PSAORDN,1,PSAINVN,1,PSALINE)) Q:'PSALINE!($G(PSADT))  S PSADT=+$P($G(^PSD(58.811,PSAORDN,1,PSAINVN,1,PSALINE,0)),"^",PSAPC)
"RTN","PSABRKU4",56,0)
 S X12="** Order# "_PSAORD_" Invoice# "_PSAINV
"RTN","PSABRKU4",57,0)
 S:+PSADT PSADT=$E(PSADT,4,5)_"/"_$E(PSADT,6,7)_"/"_$E(PSADT,2,3)
"RTN","PSABRKU4",58,0)
 I PSASTA="P" S X12=X12_" has been processed"_$S(+PSADT:" on "_PSADT,1:"")_" and" D SETMSG^PSABRKU8 S X12="    is awaiting verification. It cannot be uploaded more than once." D SETMSG^PSABRKU8
"RTN","PSABRKU4",59,0)
 I PSASTA="V" S X12=X12_"   has been verified"_$S(+PSADT:" on "_PSADT,1:"")_"and" D SETMSG^PSABRKU8 S X12="   is updating the pharmacy location. It cannot be uploaded more than once." D SETMSG^PSABRKU8
"RTN","PSABRKU4",60,0)
 I PSASTA="C" S X12=X12_" has been completed." D SETMSG^PSABRKU8 S X12="   It cannot be uploaded more than once." D SETMSG^PSABRKU8
"RTN","PSABRKU4",61,0)
 ;
"RTN","PSABRKU4",62,0)
KILLDUP S PSADUP=1
"RTN","PSABRKU4",63,0)
 K ^TMP($J,"PSAPV SET",PSACTRL),^XTMP("PSAPV",PSASET)
"RTN","PSABRKU4",64,0)
 Q
"RTN","PSABRKU4",65,0)
PRT2 ;Extended help to second "Print invoices?"
"RTN","PSABRKU4",66,0)
 W !?5,"Enter YES to print all invoices that are not processed and",!?5,"the invoices that were processed while you were in this option.",!!?5,"Enter NO to exit the option."
"RTN","PSABRKU4",67,0)
 Q
"RTN","PSABRKU4",68,0)
YNPRINT ;Extended help to "Print invoices?"
"RTN","PSABRKU4",69,0)
 W !?5,"Enter YES to print the uploaded invoices. You",!?5,"can check the invoices prior to processing them.",!!?5,"Enter NO to not print the invoices."
"RTN","PSABRKU4",70,0)
 Q
"RTN","PSABRKU4",71,0)
 ;
"RTN","PSABRKU4",72,0)
YNPROCES ;Extended help to "Do you want to process the invoices now?"
"RTN","PSABRKU4",73,0)
 W !?5,"Enter YES to begin processing the uploaded invoices.",!!?5,"Enter NO if you do not want to process the invoices now. You can process"
"RTN","PSABRKU4",74,0)
 W !?5,"them later by selecting the ""Process Uploaded Prime Vendor Invoice Data"" option."
"RTN","PSABRKU4",75,0)
 Q
"RTN","PSABRKU4",76,0)
 ;
"RTN","PSABRKU4",77,0)
YNUPLOAD ;Extended help to "Are you ready to upload the prime vendor invoice data?"
"RTN","PSABRKU4",78,0)
 W !?5,"Enter YES to start uploading the invoices.",!?5,"Enter NO or ""^"" to exit the option."
"RTN","PSABRKU4",79,0)
 Q
"RTN","PSABRKU4",80,0)
 ;
"RTN","PSABRKU4",81,0)
DATES ;PSA*3*12 Check for Y2K compliance of dates
"RTN","PSABRKU4",82,0)
 S DATECHK=0
"RTN","PSABRKU4",83,0)
 F X=1,3,5,6 S XX=$P(^XTMP("PSAPV",PSASET,"IN"),"^",X) I $L(XX)=8 S XXX=($E(XX,1,4)-1700)_$E(XX,5,8),$P(^XTMP("PSAPV",PSASET,"IN"),"^",X)=XXX,DATECHK=1
"RTN","PSABRKU4",84,0)
 I DATECHK Q
"RTN","PSABRKU4",85,0)
 S LWRDT=$E(DT,1,3)-70,UPPRDT=$E(DT,1,3)+30
"RTN","PSABRKU4",86,0)
 F Y=1,3,5,6 S DT1=$E(DT,1)_$E($P(^XTMP("PSAPV",PSASET,"IN"),"^",Y),1,2),$P(^XTMP("PSAPV",PSASET,"IN"),"^",Y)=$S((DT1>LWRDT&(DT1<UPPRDT)):$E(DT1)_$P(^XTMP("PSAPV",PSASET,"IN"),"^",Y),1:($E(DT1,1)+1)_$P(^XTMP("PSAPV",PSASET,"IN"),"^",Y))
"RTN","PSABRKU4",87,0)
 F X=1,3,5,6 S XX=$P(^XTMP("PSAPV",PSASET,"IN"),"^",X) I XX>(DT+300000) S XXX=$E(XX,1)-2,$P(^XTMP("PSAPV",PSASET,"IN"),"^",X)=XXX_$E(XX,2,99)
"RTN","PSABRKU4",88,0)
 F X=1,3,5,6 S XX=$P(^XTMP("PSAPV",PSASET,"IN"),"^",X) I XX'?7N S $P(^XTMP("PSAPV",PSASET,"IN"),"^",X)=DT
"RTN","PSABRKU4",89,0)
 K LWRDT,UPPRDT,DT1,X,Y,XXX,XX
"RTN","PSACREDR")
0^3^B31030103^B30767974
"RTN","PSACREDR",1,0)
PSACREDR ;BIR/JMB-Credit Resolution ;7/23/97
"RTN","PSACREDR",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,64**; 10/24/97;Build 4
"RTN","PSACREDR",3,0)
 ;This routine allows the user to apply credit memos to invoices.
"RTN","PSACREDR",4,0)
 ;
"RTN","PSACREDR",5,0)
 I '$D(^XUSEC("PSA ORDERS",DUZ)) W !,"You do not hold the key to enter the option." Q
"RTN","PSACREDR",6,0)
 I '$D(^XUSEC("PSAMGR",DUZ)) W !,"You do not hold the key to enter the option." Q
"RTN","PSACREDR",7,0)
 I '$O(^PSD(58.811,"AC",1,0)) W !!,"There are no outstanding credit memos." Q
"RTN","PSACREDR",8,0)
 S PSASLN="",$P(PSASLN,"-",80)=""
"RTN","PSACREDR",9,0)
START W ! S DIC="^PSD(58.811,",DIC(0)="AEQM",DIC("S")="I $D(^PSD(58.811,""AC"",1,+Y))" D ^DIC K DIE G:Y<0 EXIT
"RTN","PSACREDR",10,0)
 G:'$D(^PSD(58.811,+Y,0)) START
"RTN","PSACREDR",11,0)
 S PSAIEN=+Y,(PSAIEN1,PSAOUT)=0
"RTN","PSACREDR",12,0)
 F  S PSAIEN1=$O(^PSD(58.811,"AC",1,PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSACREDR",13,0)
 .Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSACREDR",14,0)
 .S (PSACRED,PSAAECST,PSAIECST)=0
"RTN","PSACREDR",15,0)
 .S PSAIEN2=0 F  S PSAIEN2=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2)) Q:'PSAIEN2!(PSAOUT)  D LINE Q:PSAOUT
"RTN","PSACREDR",16,0)
 .D CREDITS
"RTN","PSACREDR",17,0)
 D LIST
"RTN","PSACREDR",18,0)
 G:PSAOUT EXIT G START
"RTN","PSACREDR",19,0)
 ;
"RTN","PSACREDR",20,0)
EXIT ;Kills printing variables only
"RTN","PSACREDR",21,0)
 K DA,DIC,DIE,DIR,DIRUT,DR,PSA,PSAAECST,PSACIEN,PSACNT,PSACRED,PSADATA,PSADIF,PSADJ,PSADJD,PSADJDA,PSADJP,PSADJQ,PSADJSUP
"RTN","PSACREDR",22,0)
 K PSAIECST,PSAIEN,PSAIEN1,PSAIEN2,PSAINV,PSALEN,PSAMENU,PSANODE,PSAOUT,PSAPC,PSAPRICE,PSASEL,PSASLN,Y
"RTN","PSACREDR",23,0)
 Q
"RTN","PSACREDR",24,0)
 ;
"RTN","PSACREDR",25,0)
LINE ;Get line item data
"RTN","PSACREDR",26,0)
 Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,0))
"RTN","PSACREDR",27,0)
 K PSADJQ,PSADJP,PSADJD
"RTN","PSACREDR",28,0)
 S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,0),PSADJSUP=0
"RTN","PSACREDR",29,0)
 ;Next line added 4dec97 to bypass checking drug name change
"RTN","PSACREDR",30,0)
 G DAVE
"RTN","PSACREDR",31,0)
DRUG S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,"B","D",0))
"RTN","PSACREDR",32,0)
 I $G(PSADJ) D  Q:'PSADJSUP
"RTN","PSACREDR",33,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,PSADJ,0))
"RTN","PSACREDR",34,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSACREDR",35,0)
 .Q:$G(PSADJD)&($L(PSADJD)=+$L(PSADJD))
"RTN","PSACREDR",36,0)
 .S PSADJSUP=1
"RTN","PSACREDR",37,0)
DAVE S PSAIECST=PSAIECST+($P(PSADATA,"^",3)*$P(PSADATA,"^",5))
"RTN","PSACREDR",38,0)
PRICE S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,"B","P",0))
"RTN","PSACREDR",39,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,PSADJ,0)),PSAPRICE=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSACREDR",40,0)
 I '+PSADJ S PSAPRICE=$P(PSADATA,"^",5)
"RTN","PSACREDR",41,0)
QTY S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,"B","Q",0))
"RTN","PSACREDR",42,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSACREDR",43,0)
 I $G(PSADJQ) S PSAAECST=PSAAECST+(PSADJQ*PSAPRICE)
"RTN","PSACREDR",44,0)
 I '$G(PSADJQ) S PSAAECST=PSAAECST+($P(PSADATA,"^",3)*PSAPRICE)
"RTN","PSACREDR",45,0)
 Q
"RTN","PSACREDR",46,0)
 ;
"RTN","PSACREDR",47,0)
CREDITS ;Adds existing credits to adjusted extended cost.
"RTN","PSACREDR",48,0)
 S PSACIEN=0 F  S PSACIEN=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,2,PSACIEN)) Q:'PSACIEN  D
"RTN","PSACREDR",49,0)
 .Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,2,PSACIEN,0))
"RTN","PSACREDR",50,0)
 .S PSACRED=PSACRED+$P(^PSD(58.811,PSAIEN,1,PSAIEN1,2,PSACIEN,0),"^",3)
"RTN","PSACREDR",51,0)
 S:PSAAECST'=PSAIECST PSA(PSAIEN1)=PSAIECST_"^"_$J(PSAAECST,$L($P(PSAAECST,".")),2)_"^"_PSACRED
"RTN","PSACREDR",52,0)
 Q
"RTN","PSACREDR",53,0)
 ;
"RTN","PSACREDR",54,0)
LIST ;Displays the invoices with outstanding credits
"RTN","PSACREDR",55,0)
 W @IOF,!,"Order#: "_$P($G(^PSD(58.811,PSAIEN,0)),"^")
"RTN","PSACREDR",56,0)
 W !?28,"Invoice",?42,"Adjusted",?56,"Received",!?4,"Invoice#",?31,"Cost",?46,"Cost",?57,"Credits",?69,"Difference",!,PSASLN
"RTN","PSACREDR",57,0)
 S (PSACNT,PSAIEN1)=0 F  S PSAIEN1=+$O(PSA(PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSACREDR",58,0)
 .S PSAIECST=+$P(PSA(PSAIEN1),"^"),PSAAECST=+$P(PSA(PSAIEN1),"^",2),PSACRED=+$P(PSA(PSAIEN1),"^",3)
"RTN","PSACREDR",59,0)
 .S PSACNT=PSACNT+1,PSAMENU(PSACNT,PSAIEN1)=PSA(PSAIEN1)
"RTN","PSACREDR",60,0)
 .W !,($J(PSACNT,2)),".",?4,$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,0)),"^"),?26,$J(PSAIECST,9,2),?41,$J(PSAAECST,9,2)
"RTN","PSACREDR",61,0)
 .W ?55,$J(PSACRED,9,2)
"RTN","PSACREDR",62,0)
 .S PSADIF=PSAIECST-(PSAAECST+PSACRED)
"RTN","PSACREDR",63,0)
 .W ?70,$J(PSADIF,9,2)
"RTN","PSACREDR",64,0)
 I PSACNT'>0 W !!!,?10,"NO INVOICES ON THIS ORDER # FOR CREDITING PURPOSES",! Q  ;Dave Blocker 3Dec97
"RTN","PSACREDR",65,0)
 W ! K DIR S DIR(0)="LO^1:"_PSACNT,DIR("A")="Select invoices",DIR("?")="Select the invoices to which you want to apply credit memos.",DIR("??")="^D CREDHELP^PSACREDR"
"RTN","PSACREDR",66,0)
 D ^DIR K DIR Q:Y=""  I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSACREDR",67,0)
 S PSASEL=Y
"RTN","PSACREDR",68,0)
 ;
"RTN","PSACREDR",69,0)
SELECT ;Selects invoices for credit memos
"RTN","PSACREDR",70,0)
 F PSAPC=1:1 S PSACNT=+$P(PSASEL,",",PSAPC) Q:'PSACNT  D  Q:PSAOUT
"RTN","PSACREDR",71,0)
 .S PSAINV=$O(PSAMENU(PSACNT,0)),PSAIECST=$P(PSAMENU(PSACNT,PSAINV),"^"),PSAAECST=$P(PSAMENU(PSACNT,PSAINV),"^",2),PSACRED=$P(PSAMENU(PSACNT,PSAINV),"^",3)
"RTN","PSACREDR",72,0)
 .W !!,"Invoice: "_$P($G(^PSD(58.811,PSAIEN,1,PSAINV,0)),"^"),!
"RTN","PSACREDR",73,0)
 .S DA(2)=PSAIEN,DA(1)=PSAINV,DA=PSAIEN2
"RTN","PSACREDR",74,0)
 .S:'$D(^PSD(58.811,PSAIEN,1,PSAINV,2,0)) DIC("P")=$P(^DD(58.8112,6,0),"^",2)
"RTN","PSACREDR",75,0)
 .S DIC="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",2,",DIC(0)="AEMQL",DIC("A")="CREDIT MEMO: ",DR=.01,DLAYGO=58.811
"RTN","PSACREDR",76,0)
 .F  L +^PSD(58.811,PSAIEN,1,PSAINV,2,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSACREDR",77,0)
 .D ^DIC K DLAYGO I Y<0 S PSAOUT=1 K DIC Q
"RTN","PSACREDR",78,0)
 .S DIE=DIC,DR="1;2;3",(PSADJDA,DA)=+Y D ^DIE K DA,DIE,DIC L -^PSD(58.811,PSAIEN,1,PSAINV,2,0)
"RTN","PSACREDR",79,0)
 .S PSACRED=PSACRED+$P($G(^PSD(58.811,PSAIEN,1,PSAINV,2,PSADJDA,0)),"^",3)
"RTN","PSACREDR",80,0)
 .I PSAIECST=$J((PSAAECST+PSACRED),2) S DA(1)=PSAIEN,DA=PSAINV,DIE="^PSD(58.811,"_DA(1)_",1,",DR="10////0" D ^DIE K DIE
"RTN","PSACREDR",81,0)
 .W !!,"Invoice: "_$P($G(^PSD(58.811,PSAIEN,1,PSAINV,0)),"^") S PSALEN=$L($P($G(^PSD(58.811,PSAIEN,1,PSAINV,0)),"^"))+11
"RTN","PSACREDR",82,0)
 .W ?PSALEN,"Total Invoiced Cost: "_$J(PSAIECST,9,2),!?PSALEN,"Total Adjusted Cost: "_$J(PSAAECST,9,2)
"RTN","PSACREDR",83,0)
 .W !?PSALEN,"Total Credits      : "_$J(PSACRED,9,2)
"RTN","PSACREDR",84,0)
 .W !?PSALEN,"Difference         : "_$J((PSAIECST-(PSAAECST+PSACRED)),9,2),!
"RTN","PSACREDR",85,0)
 Q
"RTN","PSACREDR",86,0)
 ;
"RTN","PSACREDR",87,0)
CREDHELP ;Extended help to 'Select invoices'
"RTN","PSACREDR",88,0)
 W !?5,"Enter the numbers to the left of the invoices for which you want to",!?5,"enter credit memos. To select more than one invoice number, enter"
"RTN","PSACREDR",89,0)
 W !?5,"the numbers to the left of the invoices separated by a comma or a dash.",!!?5,"For example: Enter 1,2,3,5 or 1-3,5"
"RTN","PSACREDR",90,0)
 Q
"RTN","PSADJ")
0^4^B54586571^B54165345
"RTN","PSADJ",1,0)
PSADJ ;BIR/LTL,JMB-Balance Adjustments ;8/21/97
"RTN","PSADJ",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,12,64**; 10/24/97;Build 4
"RTN","PSADJ",3,0)
 ;This routine allows the user to review the drug history then enter
"RTN","PSADJ",4,0)
 ;adjustments.
"RTN","PSADJ",5,0)
 ;
"RTN","PSADJ",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSADJ",7,0)
 ;
"RTN","PSADJ",8,0)
 S DIR(0)="Y",DIR("A")="Review drug adjustment history",DIR("B")="No",DIR("?",1)="Enter yes to display all adjustments within a selected date range.",DIR("?")="Enter no to enter the adjustment."
"RTN","PSADJ",9,0)
 S DIR("??")="^D ADJ^PSADJ" D ^DIR K DIR G:$D(DIRUT) EXIT D:Y=1 ^PSADJR G:$G(DTOUT)!($G(DUOUT)) EXIT
"RTN","PSADJ",10,0)
 D SIG^XUSESIG G:X1="" EXIT
"RTN","PSADJ",11,0)
LOC ;Gets locations to have adjustments
"RTN","PSADJ",12,0)
 S (PSACNT,PSAOUT)=0 D ^PSAUTL3 G:PSAOUT EXIT
"RTN","PSADJ",13,0)
 S PSACNT=0,PSACHK=$O(PSALOC(""))
"RTN","PSADJ",14,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT
"RTN","PSADJ",15,0)
 S PSALOCN="" F  S PSALOCN=$O(PSALOC(PSALOCN)) Q:PSALOCN=""  S PSALOC=0 F  S PSALOC=+$O(PSALOC(PSALOCN,PSALOC)) Q:'PSALOC  D  Q:PSAOUT
"RTN","PSADJ",16,0)
 .D SITES^PSAUTL1,DRUG
"RTN","PSADJ",17,0)
 .I PSAOUT S PSAX=$O(PSALOC(PSALOCN)) I PSAX'="" S PSAOUT=0
"RTN","PSADJ",18,0)
 .K PSAX
"RTN","PSADJ",19,0)
 ;
"RTN","PSADJ",20,0)
EXIT ;Kills all variables
"RTN","PSADJ",21,0)
 K %,%DT,%ZIS,D0,D1,DA,DD,DIC,DIE,DINUM,DIR,DIRUT,DO,DR,DTOUT,DUOUT,PSA,PSACHK,PSACNT,PSACOMB,PSADJDT,PSADRUG,PSADRUGN,PSADT,PSAIEN,PSAISIT,PSAISITN
"RTN","PSADJ",22,0)
 K PSALOC,PSALOCA,PSALOCN,PSAOUT,PSAQ,PSAR,PSAREC,PSASEL,PSAT,X,X1,X2,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSADJ",23,0)
 Q
"RTN","PSADJ",24,0)
 ;
"RTN","PSADJ",25,0)
DRUG ;Selects location's drug and processes adjustment
"RTN","PSADJ",26,0)
 F  S DIC="^PSD(58.8,PSALOC,1,",DIC(0)="AEMQZ",DIC("A")="Select drug to adjust: " D  Q:PSAOUT
"RTN","PSADJ",27,0)
 .S DIC("S")="I $S($P($G(^(0)),""^"",14):$P($G(^(0)),""^"",14)>DT,1:1)",DA(1)=PSALOC
"RTN","PSADJ",28,0)
 .W !!,PSALOCN D ^DIC K DIC I (Y<0&(X="")!(X="^"))!($G(DTOUT))!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSADJ",29,0)
 .Q:Y<0&(X'="")
"RTN","PSADJ",30,0)
 .S PSADRUG=+Y,PSADRUGN=$P($G(^PSDRUG(PSADRUG,0)),"^")
"RTN","PSADJ",31,0)
 .S PSAQ=$P($G(^PSD(58.8,PSALOC,1,PSADRUG,0)),"^",4)
"RTN","PSADJ",32,0)
 .W !!,"Current Balance: ",$G(PSAQ),!
"RTN","PSADJ",33,0)
 .S DIR(0)="NO^-999999:999999:2" S DIR("A")="Adjustment quantity"
"RTN","PSADJ",34,0)
 .S DIR("?",1)="Enter the amount of the adjustment. If it is a negative",DIR("?")="number, enter a minus sign '-' before the number.",DIR("??")="^D QTY^PSADJ"
"RTN","PSADJ",35,0)
 .D ^DIR K DIR Q:Y=0!(Y="")!($G(DUOUT))  I $G(DTOUT) S PSAOUT=1 Q
"RTN","PSADJ",36,0)
 .S PSAREC=Y
"RTN","PSADJ",37,0)
 .S DIR(0)="F^1:45",DIR("A")="Adjustment reason",DIR("?")="Enter the reason why the adjustment was made",DIR("??")="^D REASON^PSADJ" D ^DIR K DIR
"RTN","PSADJ",38,0)
 .Q:$G(DUOUT)!(Y=" ")  I $G(DTOUT) S PSAOUT=1 Q
"RTN","PSADJ",39,0)
 .S PSAR=Y,Y=DT D DD^%DT S PSADJDT=Y
"RTN","PSADJ",40,0)
 .S DIR(0)="D^:"_DT_":EX",DIR("A")="Adjustment date",DIR("B")=PSADJDT,DIR("?")="Enter the date that the adjustment applies",DIR("??")="^D ADJDATE^PSADJ"
"RTN","PSADJ",41,0)
 .D ^DIR K DIR Q:$G(DUOUT)  I $G(DTOUT) S PSAOUT=1 Q
"RTN","PSADJ",42,0)
 .S PSADJDT=Y
"RTN","PSADJ",43,0)
POST .;Post adjustment if yes.
"RTN","PSADJ",44,0)
 .S DIR(0)="Y",DIR("A")="OK to post",DIR("B")="Yes",DIR("?",1)="Enter yes to add or subtract the adjustment quantity from the current",DIR("?")="balance and record this transaction. Enter no to cancel this transaction."
"RTN","PSADJ",45,0)
 .S DIR("??")="^D OK^PSADJ" D ^DIR K DIR
"RTN","PSADJ",46,0)
 .I 'Y!($G(DIRUT)) S:$G(DTOUT) PSAOUT=1 W ! Q
"RTN","PSADJ",47,0)
 .D:Y=1  K PSADRUG Q
"RTN","PSADJ",48,0)
 ..W !,"There were ",$S($P($G(^PSD(58.8,PSALOC,1,PSADRUG,0)),"^",4):$P($G(^(0)),"^",4),1:0)," on hand.  There are now ",$P($G(^(0)),"^",4)+$G(PSAREC)," on hand."
"RTN","PSADJ",49,0)
 ..W !,"Updating files. Please wait."
"RTN","PSADJ",50,0)
 ..F  L +^PSD(58.8,PSALOC,1,PSADRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSADJ",51,0)
 ..D NOW^%DTC S PSADT=+$E(%,1,12)
"RTN","PSADJ",52,0)
 ..S PSAQ=$S($P($G(^PSD(58.8,PSALOC,1,PSADRUG,0)),"^",4):$P($G(^(0)),"^",4),1:0)
"RTN","PSADJ",53,0)
 ..S $P(^PSD(58.8,PSALOC,1,PSADRUG,0),"^",4)=PSAREC+PSAQ
"RTN","PSADJ",54,0)
 ..L -^PSD(58.8,PSALOC,1,PSADRUG,0) W "."
"RTN","PSADJ",55,0)
MON ..S:'$D(^PSD(58.8,PSALOC,1,PSADRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSADJ",56,0)
 ..I '$D(^PSD(58.8,PSALOC,1,PSADRUG,5,$E(PSADJDT,1,5)*100,0)) D
"RTN","PSADJ",57,0)
 ...K DD,DO S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DIC(0)="L",DIC("DR")="1////^S X=PSAQ",(X,DINUM)=$E(PSADJDT,1,5)*100
"RTN","PSADJ",58,0)
 ...S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DLAYGO,DD,DO
"RTN","PSADJ",59,0)
 ...;S X="T-1M" D ^%DT S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DLAYGO S DA=+Y
"RTN","PSADJ",60,0)
 ...;S DIE="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DA(2)=PSALOC,DA(1)=PSADRUG,DR="3////^S X=PSAQ" D ^DIE K DIE
"RTN","PSADJ",61,0)
 ..;DAVE B (PSA*3*12)
"RTN","PSADJ",62,0)
 ..D PSA12
"RTN","PSADJ",63,0)
 ..S DIE="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DA(2)=PSALOC,DA(1)=PSADRUG,DA=$E(PSADJDT,1,5)*100
"RTN","PSADJ",64,0)
 ..S DR="7////^S X="_($P($G(^PSD(58.8,PSALOC,1,PSADRUG,5,DA,0)),"^",5)+PSAREC)_";3////^S X="_($P($G(^(0)),"^",4)+PSAREC)
"RTN","PSADJ",65,0)
 ..D ^DIE W "."
"RTN","PSADJ",66,0)
TR ..F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSADJ",67,0)
FIND ..S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT,0)) S $P(^(0),"^",3)=$P(^(0),"^",3)+1 G FIND
"RTN","PSADJ",68,0)
 ..L -^PSD(58.81,0) K DD,DIC,DO W "."
"RTN","PSADJ",69,0)
 ..S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,X=PSAT D ^DIC K DIC,DLAYGO W "."
"RTN","PSADJ",70,0)
 ..S DR="1////9;2////^S X=PSALOC;3////^S X="_$S(PSADJDT=$E(PSADT,1,7):PSADT,1:PSADJDT)_";4////^S X=PSADRUG;5////^S X=PSAREC;6////^S X=DUZ;9////^S X=PSAQ;15////^S X=PSAR"_$S(PSADJDT'=$E(PSADT,1,7):";22////^S X="_PSADT,1:"")
"RTN","PSADJ",71,0)
 ..S DIE="^PSD(58.81,",DA=PSAT D ^DIE K DIE,DD,DO W "."
"RTN","PSADJ",72,0)
 ..S:'$D(^PSD(58.8,PSALOC,1,PSADRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSADJ",73,0)
 ..S DIC="^PSD(58.8,PSALOC,1,PSADRUG,4,",DIC(0)="L",(X,DINUM)=PSAT
"RTN","PSADJ",74,0)
 ..S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DLAYGO,DA,PSADRUG W ".",!
"RTN","PSADJ",75,0)
 Q
"RTN","PSADJ",76,0)
 ;
"RTN","PSADJ",77,0)
ADJ ;Extended help for "Review drug adjustment history" at PSADJ+2
"RTN","PSADJ",78,0)
 W !,"Enter yes to print all adjustments for this drug on the screen",!,"or printer. You can enter an adjustment after the report prints."
"RTN","PSADJ",79,0)
 W !!,"Enter no to bypass the report and make an adjustment."
"RTN","PSADJ",80,0)
 Q
"RTN","PSADJ",81,0)
ADJDATE ;Extended help for "Adjustment date"
"RTN","PSADJ",82,0)
 W !,"If the adjustment pertains today, press the Return key.",!!,"If the adjustment is for a previous date, enter that date."
"RTN","PSADJ",83,0)
 W !,"Today's date will be recorded as the date the adjustment was made."
"RTN","PSADJ",84,0)
 Q
"RTN","PSADJ",85,0)
OK    ;Extended help for "OK to post?"
"RTN","PSADJ",86,0)
 W !,"Enter yes to record this adjustment. The adjustment quantity will be subtracted",!,"from or added to the drug's current balance. The transaction will be recorded"
"RTN","PSADJ",87,0)
 W !,"in the activity log and the monthly balance will be adjusted.",!!,"Enter no to abort the adjustment process and return to the menu."
"RTN","PSADJ",88,0)
 Q
"RTN","PSADJ",89,0)
QTY ;Extended help for "Adjustment quantity"
"RTN","PSADJ",90,0)
 W !,"Enter the quantity to be added or subtracted from the current balance.",!,"If the quantity should be subtracted from the balance, enter a minus"
"RTN","PSADJ",91,0)
 W !,"sign '-' before the quantity.",!!,"For example: -10 or -150 will be subtracted from the balance.",!?14,"10 or 150 will be added to the balance."
"RTN","PSADJ",92,0)
 Q
"RTN","PSADJ",93,0)
REASON ;Extended help for "Adjustment reason"
"RTN","PSADJ",94,0)
 W !,"Enter the reason you are changing the current balance."
"RTN","PSADJ",95,0)
 Q
"RTN","PSADJ",96,0)
 ;
"RTN","PSADJ",97,0)
PSA12 ;Patch PSA*3*12
"RTN","PSADJ",98,0)
 I $E(PSADJDT,1,5)=$E(DT,1,5) Q
"RTN","PSADJ",99,0)
 ;This section was added to CORRECTLY make adjustments to
"RTN","PSADJ",100,0)
 ;the monthly activity balances when an adjustment was made.
"RTN","PSADJ",101,0)
 S X="T" D ^%DT S PSAENDDT=$E(Y,1,5)
"RTN","PSADJ",102,0)
 S PSADJDT1=$E(PSADJDT,1,5)
"RTN","PSADJ",103,0)
BGN S PSADJDT1=PSADJDT1+1
"RTN","PSADJ",104,0)
 S PSADAV=$E(PSADJDT1,4,5) I PSADAV=13 S PSADAV1=$E(PSADJDT1,1,3)+1,PSADAV2="01",PSADJDT1=PSADAV1_PSADAV2
"RTN","PSADJ",105,0)
 I PSADJDT1=PSAENDDT G DONE
"RTN","PSADJ",106,0)
 W !,"Updating " S Y=PSADJDT1 X ^DD("DD") W Y
"RTN","PSADJ",107,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRUG,5,(PSADJDT1*100),0)) S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DIC(0)="L",(X,DINUM)=$E(PSADJDT1,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC S DA=+Y
"RTN","PSADJ",108,0)
 S DA=$S($G(DA)="":(PSADJDT1*100),1:DA)
"RTN","PSADJ",109,0)
 S DIE="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DA(2)=PSALOC,DA(1)=PSADRUG
"RTN","PSADJ",110,0)
 S DR="1////^S X="_($P($G(^PSD(58.8,PSALOC,1,PSADRUG,5,DA,0)),"^",2)+PSAREC)_";3////^S X="_($P($G(^(0)),"^",4)+PSAREC)
"RTN","PSADJ",111,0)
 D ^DIE
"RTN","PSADJ",112,0)
 K DA G BGN
"RTN","PSADJ",113,0)
DONE S $P(^PSD(58.8,PSALOC,1,PSADRUG,5,($E(PSADT,1,5)*100),0),"^",2)=$P($G(^PSD(58.8,PSALOC,1,PSADRUG,5,($E(PSADT,1,5)*100),0)),"^",2)+PSAREC
"RTN","PSADJ",114,0)
 S ^PSD(58.8,PSALOC,1,PSADRUG,5,"B",($E(PSADT,1,5)*100),($E(PSADT,1,5)*100))=""
"RTN","PSADJ",115,0)
 W !,"DONE" Q
"RTN","PSADJI")
0^5^B11144937^B10851547
"RTN","PSADJI",1,0)
PSADJI ;BIR/LTL-Balance Initialization ;7/23/97
"RTN","PSADJI",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**64**; 10/24/97;Build 4
"RTN","PSADJI",3,0)
 ;This routine allows the user to enter a beginning balance on hand for
"RTN","PSADJI",4,0)
 ;a drug in a pharmacy location.
"RTN","PSADJI",5,0)
 ;
"RTN","PSADJI",6,0)
 D ^PSADA G:'$G(PSALOC) QUIT
"RTN","PSADJI",7,0)
 N D1,D2,DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,PSAC,PSADT,DA,PSADRUG,PSADRUGN,PSAS,PSAQ,PSAR,PSAREC,PSAOUT,PSAT,X,Y
"RTN","PSADJI",8,0)
CHKD I '$O(^PSD(58.8,PSALOC,1,0)) W !!,"There are no drugs in ",$G(PSALOCN) G QUIT
"RTN","PSADJI",9,0)
 W !!,"Give me a second to alphabetize.",!
"RTN","PSADJI",10,0)
 S PSADRUG=0,PSADRUGN=""
"RTN","PSADJI",11,0)
 F  S PSADRUG=$O(^PSD(58.8,+PSALOC,1,PSADRUG)) Q:'PSADRUG!($P($G(^PSDRUG(+PSADRUG,0)),U)']"")  D
"RTN","PSADJI",12,0)
 .S ^TMP("PSAB",$J,$P($G(^PSDRUG(+PSADRUG,0)),U),PSADRUG)="" K Y
"RTN","PSADJI",13,0)
 W @IOF
"RTN","PSADJI",14,0)
 F PSAC=1:1 S PSADRUGN=$O(^TMP("PSAB",$J,PSADRUGN)) Q:PSADRUGN']""  S PSADRUG=$O(^TMP("PSAB",$J,PSADRUGN,0)) D  G:$D(Y) QUIT
"RTN","PSADJI",15,0)
 .I $P($G(^PSD(58.8,+PSALOC,1,PSADRUG,0)),U,4)]"" D:$Y+9>IOSL  Q:$D(DUOUT)!($D(DTOUT))  W !!,PSADRUGN," may have to be adjusted.",!!,"There's already ",$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,0)),U,4)," on hand." Q
"RTN","PSADJI",16,0)
 ..S DIR(0)="E" D ^DIR K DIR K:Y Y W @IOF
"RTN","PSADJI",17,0)
 .W !!,PSADRUGN,!!,"Dispensing Unit: "
"RTN","PSADJI",18,0)
 .W $P($G(^PSDRUG(+PSADRUG,660)),U,8),!
"RTN","PSADJI",19,0)
 .F  L +^PSD(58.8,+PSALOC,1,+PSADRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSADJI",20,0)
 .S DIR(0)="N^0:999999:2",DIR("A")="Initial Balance" D ^DIR K DIR
"RTN","PSADJI",21,0)
 .I $D(DIRUT) L -^PSD(58.8,+PSALOC,1,+PSADRUG,0) S Y=1 Q
"RTN","PSADJI",22,0)
 .S PSAREC=Y D NOW^%DTC S PSADT=+$E(%,1,12),DIE="^PSD(58.8,+PSALOC,1,"
"RTN","PSADJI",23,0)
 .S DA(1)=PSALOC,DA=PSADRUG,DR="3////"_PSAREC D ^DIE
"RTN","PSADJI",24,0)
 .L -^PSD(58.8,+PSALOC,1,+PSADRUG,0)
"RTN","PSADJI",25,0)
 .Q:$G(PSAREC)']""
"RTN","PSADJI",26,0)
MON .S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSADJI",27,0)
 .I '$D(^PSD(58.8,+PSALOC,1,+PSADRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="L",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DLAYGO
"RTN","PSADJI",28,0)
 .S DIE="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DA(2)=PSALOC,DA(1)=PSADRUG,DA=$E(DT,1,5)*100,DR="1////0;7////^S X=PSAREC" D ^DIE
"RTN","PSADJI",29,0)
 .W !!,"Updating beginning balance and transaction history.",!
"RTN","PSADJI",30,0)
TR .F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSADJI",31,0)
FIND .S PSAT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSADJI",32,0)
 .S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSADJI",33,0)
 .S DIE="^PSD(58.81,",DA=PSAT,DR="1////11;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRUG;5////^S X=PSAREC;6////^S X=DUZ;9////0" D ^DIE K DIE
"RTN","PSADJI",34,0)
 .S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSADJI",35,0)
 .S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,4,",DIC(0)="L",(X,DINUM)=PSAT
"RTN","PSADJI",36,0)
 .S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DA,DLAYGO,Y
"RTN","PSADJI",37,0)
QUIT K ^TMP("PSAB",$J) Q
"RTN","PSADRUG")
0^6^B22959232^B21853949
"RTN","PSADRUG",1,0)
PSADRUG ;BIR/LTL-Add/edit Pharmacy Location drugs ;7/23/97
"RTN","PSADRUG",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**64**; 10/24/97;Build 4
"RTN","PSADRUG",3,0)
 ;
"RTN","PSADRUG",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSADRUG",5,0)
 ;
"RTN","PSADRUG",6,0)
 N DIC,DA,DIE,DLAYGO,DINUM,DR,DIR,DIRUT,PSA,PSAINV,PSAIT,X,Y
"RTN","PSADRUG",7,0)
 D ^PSADA G:'$G(PSALOC) QUIT
"RTN","PSADRUG",8,0)
NOINV S:'$D(^PSD(58.8,PSALOC,1,0)) ^(0)="^58.8001IP^^"
"RTN","PSADRUG",9,0)
 S DA(1)=PSALOC,DIC="^PSD(58.8,PSALOC,1,",DIC(0)="AEMQL",DIC("W")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)'>DT,1:0) W $C(7),""   *** INACTIVE ***""",DLAYGO=58.8 W ! D ^DIC K DIC,DLAYGO G:Y<1 QUIT S PSAIT=+Y
"RTN","PSADRUG",10,0)
 S PSAIT(2)=$P($G(^PSDRUG(+PSAIT,0)),U)
"RTN","PSADRUG",11,0)
NOT I '$O(^PSDRUG(PSAIT,441,0)) W !?10,"**This drug is not linked to the ITEM MASTER file**",!?12,"To automate receiving, a link is needed.",! D
"RTN","PSADRUG",12,0)
 .S DIR(0)="Y",DIR("A")="Attempt link now",DIR("B")="Yes" D ^DIR K DIR Q:$D(DIRUT)!(Y<1)  D START^PSATI
"RTN","PSADRUG",13,0)
 I $O(^PSD(58.8,+PSALOC,4,0)),$O(^PSDRUG(+PSAIT,441,0)) S PSA(1)=0 D
"RTN","PSADRUG",14,0)
 .N PSAINV
"RTN","PSADRUG",15,0)
 .F  S PSA(1)=$O(^PSDRUG(+PSAIT,441,PSA(1))) Q:'PSA(1)  D
"RTN","PSADRUG",16,0)
 ..S PSAINV=0,PSA(1)=$G(^PSDRUG(+PSAIT,441,+PSA(1),0))
"RTN","PSADRUG",17,0)
 ..F  S PSAINV=$O(^PRCP(445,"AE",+PSA(1),PSAINV)) Q:'PSAINV!($O(^PSD(58.8,"P",+PSAINV,+PSALOC,0)))
"RTN","PSADRUG",18,0)
 ..I 'PSAINV W !!,"**",PSAIT(2),", from the DRUG file is linked to",!!,$$DESCR^PRCPUX1($G(PSAINV),PSA(1))," from the ITEM MASTER file",!!," but has NOT been added to a linked Inventory Point.**" Q
"RTN","PSADRUG",19,0)
 ..S PSAIT(1)=$G(PSAIT(1))+1
"RTN","PSADRUG",20,0)
 ..W:PSAIT(1)=1 !!,PSAIT(2),", from the DRUG file is linked to",!!
"RTN","PSADRUG",21,0)
 ..W $$DESCR^PRCPUX1(PSAINV,PSA(1))," from the ITEM MASTER file.",!!
"RTN","PSADRUG",22,0)
 ..W $$INVNAME^PRCPUX1(PSAINV)," shows a current balance of",!!
"RTN","PSADRUG",23,0)
 ..S PSAIT(3)=$G(^PRCP(445,+PSAINV,1,+PSA(1),0))
"RTN","PSADRUG",24,0)
 ..W $S($P(PSAIT(3),U,7):$P(PSAIT(3),U,7),1:0)," ",$$UNITCODE^PRCPUX1($P(PSAIT(3),U,5))
"RTN","PSADRUG",25,0)
 ..W " times dispensing unit conv factor = "
"RTN","PSADRUG",26,0)
 ..W $P(PSAIT(3),U,7)*$S($P(PSAIT(3),U,29):$P(PSAIT(3),U,29),1:1)
"RTN","PSADRUG",27,0)
 ..W " ",$P(PSAIT(3),U,28),!
"RTN","PSADRUG",28,0)
 S PSAIT(4)=$G(^PSDRUG(+PSAIT,660))
"RTN","PSADRUG",29,0)
 K PSA G:$P($G(^PSD(58.8,+PSALOC,1,+PSAIT,0)),U,4)]"" DISP
"RTN","PSADRUG",30,0)
DRUG S DIE="^PSD(58.8,PSALOC,1,",DA=PSAIT,DR="3Please enter total "_$P(PSAIT(4),U,8)_" currently on hand: ;S PSA(2)=X",DA(1)=PSALOC
"RTN","PSADRUG",31,0)
 D:$P(PSAIT(4),U,2)]""
"RTN","PSADRUG",32,0)
 .W !!?30,"DRUG FILE info:",!
"RTN","PSADRUG",33,0)
 .W ?20,"Order unit: "_$P(^DIC(51.5,+$P(PSAIT(4),U,2),0),U,2),!?20,"Dispense units per order unit: "_$P(PSAIT(4),U,5),!?20,"Dispense unit: "_$P(PSAIT(4),U,8)
"RTN","PSADRUG",34,0)
 .W !!,"Current Inventory from the DRUG file = "_$P($G(^PSDRUG(PSAIT,660.1)),U),!
"RTN","PSADRUG",35,0)
 W:'$P(^PSD(58.8,PSALOC,1,PSAIT,0),U,4) !,"Once an initial quantity is entered it can only be updated by receiving,",!,"dispensing or adjusting.",!!,"Updating will occur to the balance in ",$G(PSALOCN),".",!!,"The Current Inventory "
"RTN","PSADRUG",36,0)
 W "from the DRUG file is only offered as an initial balance",!,"and is NOT updated."
"RTN","PSADRUG",37,0)
 F  L +^PSD(58.8,+PSALOC,1,+PSAIT,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSADRUG",38,0)
 D ^DIE L -^PSD(58.8,+PSALOC,1,+PSAIT,0) G:$D(Y) QUIT
"RTN","PSADRUG",39,0)
DISP W !!,"Current balance:  "_$P(^PSD(58.8,PSALOC,1,PSAIT,0),U,4)," ",$P(PSAIT(4),U,8),!
"RTN","PSADRUG",40,0)
 G:$G(PSA(2))']"" AGAIN
"RTN","PSADRUG",41,0)
 N PSAT,PSADT
"RTN","PSADRUG",42,0)
 D NOW^%DTC S PSADT=+$E(%,1,12) K %
"RTN","PSADRUG",43,0)
MON S:'$D(^PSD(58.8,+PSALOC,1,+PSAIT,5,0)) ^(0)="^58.801A^^"
"RTN","PSADRUG",44,0)
 I '$D(^PSD(58.8,+PSALOC,1,+PSAIT,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSALOC,1,+PSAIT,5,",DIC(0)="LM",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSAIT,DLAYGO=58.8 D ^DIC K DIC,DLAYGO
"RTN","PSADRUG",45,0)
 S DIE="^PSD(58.8,+PSALOC,1,+PSAIT,5,",DA(2)=PSALOC,DA(1)=PSAIT,DA=$E(DT,1,5)*100,DR="1////^S X=PSA(2);7////^S X=PSA(2)" D ^DIE K DIE
"RTN","PSADRUG",46,0)
 W !,"Updating beginning balance and transaction history.",!
"RTN","PSADRUG",47,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSADRUG",48,0)
FIND S PSAT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSADRUG",49,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC
"RTN","PSADRUG",50,0)
 L -^PSD(58.81,0) K DIC,DLAYGO
"RTN","PSADRUG",51,0)
 S DIE="^PSD(58.81,",DA=PSAT,DR="1////11;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSAIT;5////^S X=PSA(2);6////^S X=DUZ;9////0" D ^DIE K DIE
"RTN","PSADRUG",52,0)
 S:'$D(^PSD(58.8,+PSALOC,1,+PSAIT,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSADRUG",53,0)
 S DIC="^PSD(58.8,+PSALOC,1,+PSAIT,4,",DIC(0)="L",(X,DINUM)=PSAT
"RTN","PSADRUG",54,0)
 S DA(2)=PSALOC,DA(1)=PSAIT,DLAYGO=58.8 D ^DIC K DA,DIC,DLAYGO
"RTN","PSADRUG",55,0)
AGAIN D:$O(^PS(52.6,"AC",+PSAIT,0))!($O(^PS(52.7,"AC",+PSAIT,0))) ^PSAPSI4 S DIR(0)="Y",DIR("A")="Another Drug",DIR("B")="No" W ! D ^DIR K DIR G:Y=1 NOINV
"RTN","PSADRUG",56,0)
QUIT Q
"RTN","PSADRUGP")
0^7^B23255227^B22701616
"RTN","PSADRUGP",1,0)
PSADRUGP ;BIR/LTL,JMB-Enter/Edit a Drug ;7/23/97
"RTN","PSADRUGP",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,21,60,64**; 10/24/97;Build 4
"RTN","PSADRUGP",3,0)
 ;
"RTN","PSADRUGP",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSADRUGP",5,0)
 ;References to ^PS(52.6, are covered by IA #270
"RTN","PSADRUGP",6,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSADRUGP",7,0)
 ;References to ^PS(52.7 are covered by IA #770
"RTN","PSADRUGP",8,0)
LOC G:+$G(PSAOUT)&($G(PSACNT)=1) EXIT
"RTN","PSADRUGP",9,0)
 S (PSADD,PSACNT,PSAOUT)=0,PSASLN="",$P(PSASLN,"-",80)=""
"RTN","PSADRUGP",10,0)
 D ^PSAUTL3 G:PSAOUT EXIT S PSACHK=$O(PSALOC(""))
"RTN","PSADRUGP",11,0)
 I PSACHK="",'PSALOC W !,"There are no active pharmacy locations." G EXIT
"RTN","PSADRUGP",12,0)
 I $O(PSALOC(PSACHK))="" W !,PSALOCN
"RTN","PSADRUGP",13,0)
 ;
"RTN","PSADRUGP",14,0)
GETDRUG S PSAQTY=0
"RTN","PSADRUGP",15,0)
 S:'$D(^PSD(58.8,PSALOC,1,0)) ^(0)="^58.8001IP^^"
"RTN","PSADRUGP",16,0)
 S DA(1)=PSALOC,DIC="^PSD(58.8,"_PSALOC_",1,",DIC(0)="AEMQL",DIC("W")="I $S($P($G(^(0)),U,14):$P($G(^(0)),U,14)'>DT,1:0) W $C(7),""   *** INACTIVE ***""",DLAYGO=58.8 W ! D ^DIC K DIC,DLAYGO
"RTN","PSADRUGP",17,0)
 I Y<0!($G(DTOUT))!($G(DUOUT)) S PSAOUT=1 Q:$G(PSAOPT)="PSALOC"  G LOC
"RTN","PSADRUGP",18,0)
 S PSADRG=+Y,PSADRGN=$P($G(^PSDRUG(PSADRG,0)),"^")
"RTN","PSADRUGP",19,0)
 I $D(^PSD(58.8,PSALOC,1,PSADRG,0)),+$P(^(0),"^",14),$P(^(0),"^",14)'>DT W !,$C(7),"   *** INACTIVE ***" G DISP ;PSA*3*21 (Allow re-activation)
"RTN","PSADRUGP",20,0)
 S PSA660=$G(^PSDRUG(PSADRG,660))
"RTN","PSADRUGP",21,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) G NOINV
"RTN","PSADRUGP",22,0)
 I $D(^PSD(58.8,PSALOC,1,PSADRG,0)),$P(^(0),"^",4)="" G DRUG
"RTN","PSADRUGP",23,0)
 G DISP
"RTN","PSADRUGP",24,0)
 ;
"RTN","PSADRUGP",25,0)
NOINV I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSADRUGP",26,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) ^(0)="^58.8001IP^^"
"RTN","PSADRUGP",27,0)
 .K DA,DD,DO S DIC="^PSD(58.8,"_PSALOC_",1,",DIC(0)="LM",DA(1)=PSALOC,(X,DINUM)=PSADRG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSADRUGP",28,0)
DRUG S DIE="^PSD(58.8,"_PSALOC_",1,",DA(1)=PSALOC,DA=PSADRG,DR="3Enter total "_$P(PSA660,"^",8)_" currently on hand: "
"RTN","PSADRUGP",29,0)
 W @IOF,!,$G(PSALOCN),!,"DRUG: "_PSADRGN
"RTN","PSADRUGP",30,0)
 D:+$P(PSA660,"^",2)
"RTN","PSADRUGP",31,0)
 .W !!?30,"DRUG FILE info:",!
"RTN","PSADRUGP",32,0)
 .W ?20,"Order unit: "_$P(^DIC(51.5,$P(PSA660,"^",2),0),"^",1),!?20,"Dispense units per order unit: "_$P(PSA660,"^",5),!?20,"Dispense unit: "_$P(PSA660,"^",8)
"RTN","PSADRUGP",33,0)
 .W !!,"Current Inventory from the DRUG file = "_$P($G(^PSDRUG(PSADRG,660.1)),"^")
"RTN","PSADRUGP",34,0)
 I '$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4) D
"RTN","PSADRUGP",35,0)
 .W !!,"Once an initial quantity is entered, it can only be updated by receiving,",!,"dispensing, adjusting, or transferring."
"RTN","PSADRUGP",36,0)
 .W:+$P(PSA660,"^",2) " The Current Inventory from the",!,"DRUG file is only offered as an initial balance and and is NOT updated."
"RTN","PSADRUGP",37,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSADRUGP",38,0)
 W ! D ^DIE L -^PSD(58.8,PSALOC,1,PSADRG,0) K DA,DIE G:$D(Y) LOC
"RTN","PSADRUGP",39,0)
 S PSAQTY=X
"RTN","PSADRUGP",40,0)
 I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D
"RTN","PSADRUGP",41,0)
 .S DIE="^PSD(58.8,"_PSALOC_",1,",DA(1)=PSALOC,DA=PSADRG,DR="2Stock Level: ;4Reorder Level: "
"RTN","PSADRUGP",42,0)
 .F  L +^PSD(58.8,PSALOC,1,PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSADRUGP",43,0)
 .D ^DIE L -^PSD(58.8,PSALOC,1,PSADRG,0) K DA,DIE
"RTN","PSADRUGP",44,0)
DISP ;
"RTN","PSADRUGP",45,0)
 S:'$D(PSA660) PSA660=$G(^PSDRUG(PSADRG,660)) ;*60
"RTN","PSADRUGP",46,0)
 W !!,"Current balance:  "_+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)," ",$P(PSA660,"^",8)
"RTN","PSADRUGP",47,0)
 ;PSA*3*21 (Give option of inactivation - Dave B)
"RTN","PSADRUGP",48,0)
 S DIE="^PSD(58.8,"_PSALOC_",1,",DA(1)=PSALOC,DA=PSADRG,DR="13;14" D ^DIE K DIE,DR
"RTN","PSADRUGP",49,0)
 S PSAIT=PSADRG,PSAIT(2)=PSADRGN,PSAIT(4)=$G(^PSDRUG(PSAIT,660)) D:$O(^PS(52.6,"AC",PSADRG,0))!($O(^PS(52.7,"AC",PSADRG,0))) ^PSAPSI4
"RTN","PSADRUGP",50,0)
 G:'$G(PSAQTY) GETDRUG
"RTN","PSADRUGP",51,0)
 D NOW^%DTC S PSADT=+$E(%,1,12)
"RTN","PSADRUGP",52,0)
MON S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) ^PSD(58.8,PSALOC,1,PSADRG,5,0)="^58.801A^^"
"RTN","PSADRUGP",53,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,+($E(DT,1,5)*100),0)) S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="LM",(X,DINUM)=($E(DT,1,5)*100),DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DA,DIC,DLAYGO
"RTN","PSADRUGP",54,0)
 S DIE="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DA(2)=PSALOC,DA(1)=PSADRG,DA=($E(DT,1,5)*100),DR="1////^S X=PSAQTY;7////^S X=PSAQTY" D ^DIE K DA,DIE
"RTN","PSADRUGP",55,0)
 W !!,"Updating beginning balance and transaction history."
"RTN","PSADRUGP",56,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSADRUGP",57,0)
FIND S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSADRUGP",58,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC
"RTN","PSADRUGP",59,0)
 L -^PSD(58.81,0) K DIC,DLAYGO
"RTN","PSADRUGP",60,0)
 S DIE="^PSD(58.81,",DA=PSAT,DR="1////11;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRG;5////^S X=PSAQTY;6////^S X=DUZ;9////0" D ^DIE K DIE,DA
"RTN","PSADRUGP",61,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,4,0)) ^PSD(58.8,PSALOC,1,PSADRG,4,0)="^58.800119PA^^"
"RTN","PSADRUGP",62,0)
 S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",4,",DIC(0)="LM",(X,DINUM)=PSAT
"RTN","PSADRUGP",63,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DA,DIC,DLAYGO
"RTN","PSADRUGP",64,0)
 G GETDRUG
"RTN","PSADRUGP",65,0)
EXIT K %,DA,DIC,DIE,DINUM,DR,DTOUT,DUOUT,PSA660,PSACHK,PSACNT,PSADD,PSADRG,PSADRGN,PSADT,PSALOC,PSALOCA,PSALOCN,PSAOUT,PSAQTY,PSASLN,PSAT,X,Y
"RTN","PSADRUGP",66,0)
 Q
"RTN","PSAGIP")
0^9^B22355632^B22177455
"RTN","PSAGIP",1,0)
PSAGIP ;BIR/LTL,JMB-DA receiving from GIP ;7/23/97
"RTN","PSAGIP",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**8,64**; 10/24/97;Build 4
"RTN","PSAGIP",3,0)
 Q
"RTN","PSAGIP",4,0)
EN(PSAGIP,PSAITEM,PSAQTY,PSAISS,PSAEX,PSATR,PSACOST,PSANDC)     ; GIP passes recing data
"RTN","PSAGIP",5,0)
 ;PSAGIP=D0 from #445, PSAITEM=D0 from #441,
"RTN","PSAGIP",6,0)
 ;PSAQTY=qty rec'd converted to dispensing unit, PSAISS=D0 from #410,
"RTN","PSAGIP",7,0)
 ;PSAEX=external form of D0 from either #410 or #442,
"RTN","PSAGIP",8,0)
 ;PSATR=D0 from #445.2, PSACOST=total cost of receipt,
"RTN","PSAGIP",9,0)
 ;PSANDC=NDC with dashes
"RTN","PSAGIP",10,0)
 Q:'$G(PSAQTY)
"RTN","PSAGIP",11,0)
 Q:'$O(^PSD(58.8,"P",+$G(PSAGIP),""))  ; GIP not linked to DA location
"RTN","PSAGIP",12,0)
 ;check item linked to drug, drug stocked by DA loc, rec fail flag
"RTN","PSAGIP",13,0)
 N PSALOC S PSALOC=$O(^PSD(58.8,"P",+$G(PSAGIP),0)),PSADRUG=+$O(^PSDRUG("AB",+$G(PSAITEM),0))
"RTN","PSAGIP",14,0)
 S ^TMP("PSAC",$J,+PSALOC)=$G(PSAGIP)_U_$G(PSAEX)
"RTN","PSAGIP",15,0)
 I 'PSADRUG,$P($G(^PSD(58.8,+PSALOC,4,+$G(PSAGIP),0)),U,2) S ^TMP("PSAB",$J,+$G(PSAITEM))="#"+$G(PSAITEM)_"  "_$$DESCR^PRCPUX1($G(PSAGIP),$G(PSAITEM))_" NOT LINKED." Q
"RTN","PSAGIP",16,0)
 I '$D(^PSD(58.8,+PSALOC,1,PSADRUG,0)),$P($G(^PSD(58.8,+PSALOC,4,+$G(PSAGIP),0)),U,2) S ^TMP("PSAB",$J,+$G(PSAITEM))="#"_$G(PSAITEM)_"  "_$$DESCR^PRCPUX1($G(PSAGIP),$G(PSAITEM))_" NOT STOCKED." Q
"RTN","PSAGIP",17,0)
 Q:'$D(^PSD(58.8,+PSALOC,1,$G(PSADRUG),0))
"RTN","PSAGIP",18,0)
 S ^TMP("PSA",$J,$G(PSADRUG))=$G(PSAQTY)_U_$G(PSAISS)_U_$G(PSAEX)_U_$G(PSATR)_U_$G(PSACOST)_U_$G(PSAITEM)_U_$G(PSANDC)
"RTN","PSAGIP",19,0)
 Q
"RTN","PSAGIP",20,0)
EX N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK,PSALOC,PSADAT,PSAB,PSAT,PSAGIP
"RTN","PSAGIP",21,0)
 Q:'$O(^TMP("PSAC",$J,0))
"RTN","PSAGIP",22,0)
 Q:'$O(^TMP("PSA",$J,0))&('$O(^TMP("PSAB",$J,0)))
"RTN","PSAGIP",23,0)
 S PSALOC=$O(^TMP("PSAC",$J,0)),PSAGIP=$P($G(^TMP("PSAC",$J,+PSALOC)),U)
"RTN","PSAGIP",24,0)
 S ZTDTH=$H,ZTIO="",ZTRTN="TSK^PSAGIP",ZTDESC="GIP/DA Receiving"
"RTN","PSAGIP",25,0)
 S ZTSAVE("PSALOC")="",ZTSAVE("PSAGIP")=""
"RTN","PSAGIP",26,0)
 S:$O(^TMP("PSA",$J,0)) ZTSAVE("^TMP(""PSA"",$J,")=""
"RTN","PSAGIP",27,0)
 S:$O(^TMP("PSAB",$J,0)) ZTSAVE("^TMP(""PSAB"",$J,")=""
"RTN","PSAGIP",28,0)
 S ZTSAVE("^TMP(""PSAC"",$J,")=""
"RTN","PSAGIP",29,0)
 D ^%ZTLOAD,HOME^%ZIS
"RTN","PSAGIP",30,0)
 K IO("Q"),^TMP("PSA",$J),^TMP("PSAB",$J),^TMP("PSAC",$J)
"RTN","PSAGIP",31,0)
 Q
"RTN","PSAGIP",32,0)
TSK N PSAM
"RTN","PSAGIP",33,0)
 S:$P($G(^PSD(58.8,+PSALOC,0)),U,2)="M" PSAM=1
"RTN","PSAGIP",34,0)
 F PSADRUG=0:0 S PSADRUG=$O(^TMP("PSA",$J,PSADRUG)) Q:'PSADRUG  S PSAQTY=$P($G(^TMP("PSA",$J,PSADRUG)),U),PSAISS=$P($G(^(PSADRUG)),U,2),PSAP=$P($G(^(PSADRUG)),U,3),PSATR=$P($G(^(PSADRUG)),U,4),PSACOST=$P($G(^(PSADRUG)),U,5) D
"RTN","PSAGIP",35,0)
 .S PSANDC=$P($G(^TMP("PSA",$J,PSADRUG)),U,7) D ^PSAGIP1
"RTN","PSAGIP",36,0)
 .S:'$P(PSAP,"-",3) PSAPO=PSAP
"RTN","PSAGIP",37,0)
 .L +^PSD(58.8,+PSALOC,1,+PSADRUG):5
"RTN","PSAGIP",38,0)
 .D NOW^%DTC S PSADAT=+$E(%,1,12) K %
"RTN","PSAGIP",39,0)
 .S PSAB=$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,0)),U,4)
"RTN","PSAGIP",40,0)
 .S $P(^PSD(58.8,+PSALOC,1,+PSADRUG,0),U,4)=$G(PSAQTY)+PSAB
"RTN","PSAGIP",41,0)
 .L -^PSD(58.8,+PSALOC,1,+PSADRUG)
"RTN","PSAGIP",42,0)
MON .S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSAGIP",43,0)
 .I '$D(^PSD(58.8,+PSALOC,1,+PSADRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="LM",DIC("DR")="1////^S X=$G(PSAB)" D
"RTN","PSAGIP",44,0)
 ..S (X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO,X
"RTN","PSAGIP",45,0)
 ..S X="T-1M" D ^%DT S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO,X S DA=+Y K Y
"RTN","PSAGIP",46,0)
 ..S DIE="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DA(2)=PSALOC,DA(1)=PSADRUG
"RTN","PSAGIP",47,0)
 ..S DR="3////^S X=$G(PSAB)" D ^DIE K DIE,DR
"RTN","PSAGIP",48,0)
 .S DIE="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DA(2)=PSALOC,DA(1)=PSADRUG,DA=$E(DT,1,5)*100,DR="5////^S X=$P($G(^(0)),U,3)+$G(PSAQTY)" D ^DIE K DIE,DR
"RTN","PSAGIP",49,0)
TR .F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAGIP",50,0)
FIND .D FIND1 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO L -^PSD(58.81,0)
"RTN","PSAGIP",51,0)
 .S DIE="^PSD(58.81,",DA=PSAT
"RTN","PSAGIP",52,0)
 .S DR="1////^S X=$S($E($G(PSATR))=""R"":1,1:9);2////^S X=$G(PSALOC);3////^S X=PSADAT;4////^S X=$G(PSADRUG);5////^S X=$G(PSAQTY);6////^S X=DUZ;7////^S X=$G(PSAISS);8///^S X=$G(PSAPO);9////^S X=PSAB;100////^S X=$G(PSAM)"
"RTN","PSAGIP",53,0)
 .D ^DIE K DIE,DR
"RTN","PSAGIP",54,0)
 .S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSAGIP",55,0)
 .S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,4,",DIC(0)="L",(X,DINUM)=PSAT
"RTN","PSAGIP",56,0)
 .S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DA,DIC,DLAYGO,DINUM,PSAB,PSAISS,PSANDC,PSAPO,PSAQTY,PSATR
"RTN","PSAGIP",57,0)
 K ^TMP("PSA",$J)
"RTN","PSAGIP",58,0)
 Q:'$O(^TMP("PSAB",$J,0))
"RTN","PSAGIP",59,0)
 S:'$G(PSAP) PSAP=$P($G(^TMP("PSAC",$J,PSALOC)),U,2)
"RTN","PSAGIP",60,0)
 S XMDUZ="Failed Receipt Notifier",XMSUB="Failed DA/GIP Receipts - "_PSAP
"RTN","PSAGIP",61,0)
 S XMY(DUZ)=""
"RTN","PSAGIP",62,0)
 I $P($G(^PSD(58.8,+PSALOC,4,+$G(PSAGIP),0)),U,3)'="" S XX=$P(^(0),"^",3),XXX="G."_XX,XMY(XXX)="" K XX,XXX
"RTN","PSAGIP",63,0)
 S XMTEXT="^TMP(""PSAB"",$J,"
"RTN","PSAGIP",64,0)
 G:'$D(XMY) QUIT1 D ^XMD
"RTN","PSAGIP",65,0)
QUIT1 K XMDUZ,XMSUB,XMTEXT,XMY
"RTN","PSAGIP",66,0)
 S:$D(ZTQUEUED) ZTREQ="@" K ^TMP("PSAB",$J)
"RTN","PSAGIP",67,0)
QUIT Q
"RTN","PSAGIP",68,0)
FIND1 S PSAT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND1
"RTN","PSAGIP",69,0)
 Q
"RTN","PSANAC")
0^10^B28480859^B28314130
"RTN","PSANAC",1,0)
PSANAC ;BIR/LTL-Populate Pharmacy Location with Inventory Items ;7/23/97
"RTN","PSANAC",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**15,64**; 10/24/97;Build 4
"RTN","PSANAC",3,0)
 ;This routine loads inventory/DA items into a pharmacy location.
"RTN","PSANAC",4,0)
 ;
"RTN","PSANAC",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSANAC",6,0)
 ;References to ^PSDRUG("AB" are covered by IA #2095
"RTN","PSANAC",7,0)
 ;References to ^PRC( are covered by IA #214
"RTN","PSANAC",8,0)
 ;References to ^PRCP( are covered by IA #214
"RTN","PSANAC",9,0)
 ;References to ^PS(52.6 are covered by IA #270
"RTN","PSANAC",10,0)
 ;References to ^PS(52.7 are covered by IA #770
"RTN","PSANAC",11,0)
 ;
"RTN","PSANAC",12,0)
 ;
"RTN","PSANAC",13,0)
SETUP N DA,DIE,DIC,DIR,DIRUT,DTOUT,DUOUT,DR,PSAOUT,PSADRUG,PSAIT,PSAINV,PSAQTY,PSAY,X,Y
"RTN","PSANAC",14,0)
 ;LOOK UP LOCATION
"RTN","PSANAC",15,0)
LOOK D ^PSADA I '$G(PSALOC) S PSAOUT=1 G QUIT
"RTN","PSANAC",16,0)
NOINV I '$O(^PSD(58.8,+PSALOC,4,0)) W !,$G(PSALOCN)_" is not linked to an Inventory Point.",! S DIR(0)="Y",DIR("A")="Would you like to attempt a link now",DIR("B")="Yes" D ^DIR K DIR G:Y'=1 QUIT D  G:$D(Y)!('$G(PSAINV)) QUIT
"RTN","PSANAC",17,0)
INV .S DIE=58.8,DA=PSALOC,DR="[PSAGIP]" D ^DIE
"RTN","PSANAC",18,0)
CHEC S DIR(0)="Y",DIR("A")="Have you looked at the loadable Inventory items",DIR("B")="No" D ^DIR K DIR G:$D(DIRUT) QUIT D:Y'=1  G:$G(PSAOUT) QUIT
"RTN","PSANAC",19,0)
 .S DIR(0)="Y",DIR("A")="Would you like to look at them now",DIR("B")="Yes" D ^DIR K DIR D:Y=1 DEV^PSARIN
"RTN","PSANAC",20,0)
 .S:$D(DTOUT)!($D(DUOUT))!('$G(PSADRUG(1))) PSAOUT=1 Q:$G(PSAOUT)  S DIR(0)="Y",DIR("A")="Ready to load",DIR("B")="No" D ^DIR K DIR S:Y'=1 PSAOUT=1
"RTN","PSANAC",21,0)
 S DIR(0)="Y",DIR("A")="Load inventory quantities also",DIR("B")="Yes",DIR("?")="If yes, I'll bring over the current inventory quantity with each item." D ^DIR K DIR S:Y=1 PSAY=1 I $D(DIRUT) S PSAOUT=1 G QUIT
"RTN","PSANAC",22,0)
EXP W !,"I will display each item as it is loaded",!
"RTN","PSANAC",23,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q",%ZIS("A")="Please select DEVICE for output:  " D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" S PSAOUT=1 G QUIT
"RTN","PSANAC",24,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSANAC",ZTDESC="Inventory items loading into DA Location",ZTSAVE("PSA*")="" D ^%ZTLOAD,HOME^%ZIS S PSAOUT=1 G QUIT
"RTN","PSANAC",25,0)
START N %DT,DIC,PSAD,PSADT,PSAL,PSALN,PSAT,PSAPG,PSARPDT,X,Y S (PSAPG,PSAOUT)=0,Y=DT D DD^%DT S PSARPDT=Y,PSAIT=0
"RTN","PSANAC",26,0)
 S PSAD="W !,PSAIT,?10,$E($$DESCR^PRCPUX1(PSAINV,PSAIT),1,34),?45,$E($P(^PSDRUG($O(^PSDRUG(""AB"",PSAIT,0)),0),U),1,34)"
"RTN","PSANAC",27,0)
 S PSAINV=$O(^PSD(58.8,+PSALOC,4,0))
"RTN","PSANAC",28,0)
 I $O(^PSD(58.8,+PSALOC,4,PSAINV)) D  S:Y<1 PSAOUT=1 G QUIT
"RTN","PSANAC",29,0)
 .S DIC="^PSD(58.8,+PSALOC,4,",DIC(0)="AEMQ",DA(1)=PSALOC D ^DIC K DIC
"RTN","PSANAC",30,0)
 .S PSAINV=+Y
"RTN","PSANAC",31,0)
 D HEADER
"RTN","PSANAC",32,0)
 S:'$D(^PSD(58.8,+PSALOC,1,0)) ^(0)="^58.8001IP^^"
"RTN","PSANAC",33,0)
LOOP F  S PSAIT=$O(^PRCP(445,PSAINV,1,PSAIT)) Q:'PSAIT  D:$Y+4>IOSL HEADER Q:PSAOUT  I '$G(^PRC(441,+PSAIT,3)),$O(^PSDRUG("AB",PSAIT,0)) S PSADRUG=$O(^PSDRUG("AB",PSAIT,0)) D:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,0))
"RTN","PSANAC",34,0)
 .I $S('$D(^PSDRUG(PSADRUG,"I")):1,+^("I")>DT:1,1:0) X PSAD D
"RTN","PSANAC",35,0)
STUFF ..S PSAQTY=$P($G(^PRCP(445,+PSAINV,1,+PSAIT,0)),U,7)*$S($P($G(^(0)),U,29):$P($G(^(0)),U,29),1:1)
"RTN","PSANAC",36,0)
 ..S:$G(PSAY) DIC("DR")="3////^S X=PSAQTY"
"RTN","PSANAC",37,0)
 ..S DIC="^PSD(58.8,+PSALOC,1,",DIC(0)="L",DA(1)=PSALOC,X=PSADRUG,DLAYGO=58.8 D ^DIC  K DIC,DLAYGO
"RTN","PSANAC",38,0)
 ..W !,"Loaded "_$P(^PSDRUG(PSADRUG,0),U)
"RTN","PSANAC",39,0)
 ..Q:'$G(PSAY)
"RTN","PSANAC",40,0)
 ..W !,"Updating beginning balance and transaction history.",!
"RTN","PSANAC",41,0)
 ..D NOW^%DTC S PSADT=+$E(%,1,12) K %
"RTN","PSANAC",42,0)
 ..S ^PSD(58.8,+PSALOC,1,+PSADRUG,5,0)="^58.801A^^"
"RTN","PSANAC",43,0)
 ..S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="L",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DIC("DR")="1////^S X=PSAQTY",DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSANAC",44,0)
 ..F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSANAC",45,0)
FIND ..S PSAT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSANAC",46,0)
 ..S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO L -^PSD(58.81,0)
"RTN","PSANAC",47,0)
 ..S DIE="^PSD(58.81,",DA=PSAT,DR="1////11;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRUG;5////^S X=PSAQTY;6////^S X=DUZ;9////0" D ^DIE K DIE
"RTN","PSANAC",48,0)
 ..S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSANAC",49,0)
 ..S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,4,",DIC(0)="L",(X,DINUM)=PSAT
"RTN","PSANAC",50,0)
 ..S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DA,DIC,DINUM,DLAYGO
"RTN","PSANAC",51,0)
 ..I $E(IOST,1,2)="C-"&($O(^PS(52.6,"AC",+PSADRUG,0))!($O(^PS(52.7,"AC",+PSADRUG,0)))) S PSAIT(1)=PSAIT,PSAIT(2)=$P($G(^PSDRUG(+PSADRUG,0)),U),PSAIT(4)=$G(^PSDRUG(+PSADRUG,660)),PSAIT=PSADRUG D ^PSAPSI4 S PSAIT=PSAIT(1)
"RTN","PSANAC",52,0)
QUIT I $E(IOST)'="C" W @IOF
"RTN","PSANAC",53,0)
 I $E(IOST,1,2)="C-",'$G(PSAOUT) W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSANAC",54,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSANAC",55,0)
 K %ZIS("B"),IO("Q") Q
"RTN","PSANAC",56,0)
HEADER I $E(IOST,1,2)'="P-",PSAPG S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSANAC",57,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSAOUT=1 Q
"RTN","PSANAC",58,0)
 ;PSA*3*25 Dave B - removed single reference for OP site
"RTN","PSANAC",59,0)
 D OPSITE^PSAUTL1 S PSAINV(1)=$G(PSAOSITN)
"RTN","PSANAC",60,0)
 S:$E(PSAINV(1),10)="(" PSAINV(1)=$E(PSAINV(1),1,9)
"RTN","PSANAC",61,0)
 W:$Y @IOF S $P(PSALN,"-",81)="",PSAPG=PSAPG+1 W !,$E($P(^PRCP(445,+PSAINV,0),U),1,24)," items loading into ",PSAINV(1),?56,PSARPDT,?70,"PAGE: ",PSAPG,!,PSALN,!,"ITEM",?10,"DESCRIPTION",?50,"DRUG FILE LINK",!
"RTN","PSANAC",62,0)
 Q
"RTN","PSAOP1")
0^11^B18529492^B17931264
"RTN","PSAOP1",1,0)
PSAOP1 ;BIR/LTL-Outpatient Dispensing (Single Drug) & (All Drugs) ;7/23/97
"RTN","PSAOP1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**64**; 10/24/97;Build 4
"RTN","PSAOP1",3,0)
 ;PSAOP,PSAOP1,PSAOP2, & PSAOP4 gathers Outpatient dispensing data.
"RTN","PSAOP1",4,0)
 ;PSAOP3 calls this routine to stuff Outpatient dispensing data in
"RTN","PSAOP1",5,0)
 ;#58.81 and update 58.8 balance. It is called by PSAOP, PSAOP2,
"RTN","PSAOP1",6,0)
 ;PSAOP3, & PSAOP4.
"RTN","PSAOP1",7,0)
 ;
"RTN","PSAOP1",8,0)
 N DIC,PSAD,PSAT,PSAB,X
"RTN","PSAOP1",9,0)
 ;Get transaction number
"RTN","PSAOP1",10,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAOP1",11,0)
FIND S PSAD=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAD)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSAOP1",12,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAD D ^DIC
"RTN","PSAOP1",13,0)
 L -^PSD(58.81,0) K DLAYGO,DINUM
"RTN","PSAOP1",14,0)
 ;Get date + current balance + update balance
"RTN","PSAOP1",15,0)
 F  L +^PSD(58.8,+PSALOC,1,+PSADRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAOP1",16,0)
 S PSAB=$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,0)),U,4)
"RTN","PSAOP1",17,0)
 S $P(^PSD(58.8,+PSALOC,1,+PSADRUG,0),U,4)=$P($G(^(0)),U,4)-PSA(3)
"RTN","PSAOP1",18,0)
EDO S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSAOP1",19,0)
 ;If no monthly activity data yet,
"RTN","PSAOP1",20,0)
 I '$D(^PSD(58.8,+PSALOC,1,+PSADRUG,5,+$E(PSA(2),1,5)*100,0)) D
"RTN","PSAOP1",21,0)
 .;Set up current month's node with beginning balance.
"RTN","PSAOP1",22,0)
 .S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="L",DIC("DR")="1////"_$G(PSAB),(X,DINUM)=$E(PSA(2),1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSAOP1",23,0)
 .;Set up last month's node with ending balance.
"RTN","PSAOP1",24,0)
 .S X="T-1M" D ^%DT S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO S DA=+Y
"RTN","PSAOP1",25,0)
 .S DIE="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DA(2)=PSALOC,DA(1)=PSADRUG
"RTN","PSAOP1",26,0)
 .S DR="3////"_$G(PSAB) D ^DIE K DIE
"RTN","PSAOP1",27,0)
 ;Stuff the Total Dispensed with itself+new dispensing data.
"RTN","PSAOP1",28,0)
 S DIE="^PSD(58.8,"_+PSALOC_",1,"_+PSADRUG_",5,",DR="9////^S X=$P($G(^(0)),U,6)+PSA(3)",DA=$E(PSA(2),1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG D ^DIE K DA
"RTN","PSAOP1",29,0)
 L -^PSD(58.8,+PSALOC,1,+PSADRUG,0)
"RTN","PSAOP1",30,0)
 ;Update transaction
"RTN","PSAOP1",31,0)
 S DIE="^PSD(58.81,",DR="1////6;2////^S X=PSALOC;3///^S X=PSA(2);4////^S X=PSADRUG;5////^S X=PSA(3);9////^S X=$G(PSAB)",DA=PSAD
"RTN","PSAOP1",32,0)
 D ^DIE K DIE,DA,DR
"RTN","PSAOP1",33,0)
 ;Update Activity
"RTN","PSAOP1",34,0)
 S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSAOP1",35,0)
 S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,4,",DIC(0)="L",(X,DINUM)=PSAD
"RTN","PSAOP1",36,0)
 S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DA,DINUM,DLAYGO
"RTN","PSAOP1",37,0)
END Q
"RTN","PSAOP1",38,0)
TMP ;TMP("PSA",$J)
"RTN","PSAOP1",39,0)
 N DIC,PSAD,PSAT,PSAB,X
"RTN","PSAOP1",40,0)
 ;Get transaction number
"RTN","PSAOP1",41,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAOP1",42,0)
FIND1 S PSAD=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAD)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND1
"RTN","PSAOP1",43,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAD D ^DIC
"RTN","PSAOP1",44,0)
 L -^PSD(58.81,0) K DLAYGO,DINUM
"RTN","PSAOP1",45,0)
 ;Get date + current balance + update balance
"RTN","PSAOP1",46,0)
 F  L +^PSD(58.8,+PSALOC,1,+PSADRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAOP1",47,0)
 S PSAB=$P($G(^PSD(58.8,+PSALOC,1,+PSADRUG,0)),U,4)
"RTN","PSAOP1",48,0)
 S $P(^PSD(58.8,+PSALOC,1,+PSADRUG,0),U,4)=$P($G(^(0)),U,4)-PSA(3)
"RTN","PSAOP1",49,0)
 S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSAOP1",50,0)
 ;;If no monthly activity data yet,
"RTN","PSAOP1",51,0)
 I '$D(^PSD(58.8,+PSALOC,1,+PSADRUG,5,+$E(PSA(2),1,5)*100,0)) D
"RTN","PSAOP1",52,0)
 .;Set up current month's node with beginning balance.
"RTN","PSAOP1",53,0)
 .S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="L",DIC("DR")="1////"_$G(PSAB),(X,DINUM)=$E(PSA(2),1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSAOP1",54,0)
 .;Set up last month's node with ending balance.
"RTN","PSAOP1",55,0)
 .S X="T-1M" D ^%DT S DIC="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO S DA=+Y
"RTN","PSAOP1",56,0)
 .S DIE="^PSD(58.8,"_+PSALOC_",1,"_+PSADRUG_",5,",DA(2)=PSALOC,DA(1)=PSADRUG
"RTN","PSAOP1",57,0)
 .S DR="3////"_$G(PSAB) D ^DIE K DIE
"RTN","PSAOP1",58,0)
 ;Stuff the Total Dispensed with itself+new dispensing data.
"RTN","PSAOP1",59,0)
 S DIE="^PSD(58.8,+PSALOC,1,+PSADRUG,5,",DR="9////^S X=$P($G(^(0)),U,6)+PSA(3)",DA=$E(PSA(2),1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG D ^DIE K DA
"RTN","PSAOP1",60,0)
 L -^PSD(58.8,+PSALOC,1,+PSADRUG,0)
"RTN","PSAOP1",61,0)
 ;Update transaction
"RTN","PSAOP1",62,0)
 S DIE="^PSD(58.81,",DR="1////6;2////^S X=PSALOC;3///^S X=PSA(2);4////^S X=PSADRUG;5////^S X=PSA(3);9////^S X=$G(PSAB)",DA=PSAD
"RTN","PSAOP1",63,0)
 D ^DIE K DIE,DA,DR
"RTN","PSAOP1",64,0)
 ;Update Activity
"RTN","PSAOP1",65,0)
 S:'$D(^PSD(58.8,+PSALOC,1,+PSADRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSAOP1",66,0)
 S DIC="^PSD(58.8,"_+PSALOC_",1,"_+PSADRUG_",4,",DIC(0)="L",(X,DINUM)=PSAD
"RTN","PSAOP1",67,0)
 S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DA,DIC,DINUM,DLAYGO
"RTN","PSAOP1",68,0)
 K ^TMP("PSA",$J,PSADRUG)
"RTN","PSAOP1",69,0)
 Q
"RTN","PSAOUT")
0^12^B52860925^B52711368
"RTN","PSAOUT",1,0)
PSAOUT ;BHM/DB - Return Drugs to Manufacturer ;23 FEB 04
"RTN","PSAOUT",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**51,64**; 10/24/97;Build 4
"RTN","PSAOUT",3,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAOUT",4,0)
 ;References to ^DIC(51.5 are covered by DBIA # 1931
"RTN","PSAOUT",5,0)
 ;References to ^PSRX( are covered by DBIA # 254
"RTN","PSAOUT",6,0)
 ;References to ^PSD(58.86 are covered by DBIA # 4472
"RTN","PSAOUT",7,0)
 S PSACNT=0
"RTN","PSAOUT",8,0)
 D Q
"RTN","PSAOUT",9,0)
 K DIR S DIR(0)="S^1:Print Report;2:Enter drugs Return to Manufacturer" D ^DIR K DIR G Q:$D(DIRUT) I +Y=1 G RPT
"RTN","PSAOUT",10,0)
 S (PSALOC,PSANUM)=0 F  S PSALOC=+$O(^PSD(58.8,"ADISP","P",PSALOC)) Q:PSALOC'>0  S PSALOCN=PSALOC
"RTN","PSAOUT",11,0)
1 ;Select Drug
"RTN","PSAOUT",12,0)
 R !!,"Scan Drug barcode or enter a drug name : ",AN:DTIME S PSACNT=$G(PSACNT)+1 G DONE:AN["^" G DONE:AN="" I AN=" " W "??" G 1
"RTN","PSAOUT",13,0)
 I $D(^PSDRUG("NDC",AN)) S PSADRG=$O(^PSDRUG("NDC",AN,0)) G FOUND
"RTN","PSAOUT",14,0)
 I $D(^PSDRUG("C",AN)) S PSADRG=$O(^PSDRUG("C",AN,0)) G FOUND
"RTN","PSAOUT",15,0)
 I AN?.AN,$D(^PSDRUG(AN,0)) S PSADRG=AN G FOUND
"RTN","PSAOUT",16,0)
 I AN["-",$P(AN,"-",3)'="" S PSANDC=$P(AN,"-")_$P(AN,"-",2)_$P(AN,"-",3) I $D(^PSDRUG("NDC",PSANDC)) S PSADRG=$O(^PSDRUG("NDC",PSANDC,0)) G FOUND
"RTN","PSAOUT",17,0)
 I AN["-",$P(AN,"-",3)="" S PSARX=$P(AN,"-",2),PSADRG=$P($G(^PSRX(PSARX,0)),"^",6) I $G(PSADRG)>0 G FOUND
"RTN","PSAOUT",18,0)
 I AN?.AE S X=AN,DIC(0)="QEZ",DIC("S")="I $S('$D(^(""I"")):1,+^(""I"")>DT:1,1:0),$P($G(^(2)),""^"",3)'[""N""",DIC="^PSDRUG(" D ^DIC K DIC G:+Y'>0 NONDRUG S PSADRG=+Y G FOUND
"RTN","PSAOUT",19,0)
 W !!,"Sorry, I could not find a match. Please enter the drug name.",!! G FM
"RTN","PSAOUT",20,0)
FOUND ;Might have match
"RTN","PSAOUT",21,0)
 S PSADRUGN=$P($G(^PSDRUG(PSADRG,0)),"^") W " ",$G(PSADRUGN) S DIC("B")=PSADRUGN
"RTN","PSAOUT",22,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N" W !!,"Sorry, Controlled Substances cannot be selected through this option." K PSADRG,PSADRUGN,X,AN G 1
"RTN","PSAOUT",23,0)
OK K DIR S DIR("A")="Is this correct",DIR(0)="Y",DIR("B")="YES" D ^DIR G DONE:$D(DIRUT)
"RTN","PSAOUT",24,0)
 I +Y>0 G PROCEED
"RTN","PSAOUT",25,0)
FM ;Fileman search
"RTN","PSAOUT",26,0)
 S DIC(0)="AEQMZ",DIC("A")="Select Drug : ",DIC("S")="I $S('$D(^(""I"")):1,+^(""I"")>DT:1,1:0),$P($G(^(2)),""^"",3)'[""N""",DIC="^PSDRUG(" D ^DIC G DONE:+Y'>0 S PSADRG=+Y K DIC G FOUND
"RTN","PSAOUT",27,0)
PROCEED ;On to the next series of questions
"RTN","PSAOUT",28,0)
CON K DIR S DIR(0)="N",DIR("A")="Number of containers " D ^DIR K DIR S PSACON=+Y I $D(DIRUT) G DONE
"RTN","PSAOUT",29,0)
 K PSAOU
"RTN","PSAOUT",30,0)
 S PSAOU=$P($G(^PSDRUG(PSADRG,"660")),"^",2) I $G(PSAOU)>0 S PSAOU(1)=$P(^DIC(51.5,PSAOU,0),"^")
"RTN","PSAOUT",31,0)
 S PSAPDUOU=$P($G(^PSDRUG(PSADRG,660)),"^",6)
"RTN","PSAOUT",32,0)
QTY K DIR S DIR(0)="N",DIR("A")="Number of Dispense units being returned: " D ^DIR G DONE:$D(DIRUT)>0 S PSAQTY=Y
"RTN","PSAOUT",33,0)
OU K DIC,Y,X S DIC(0)="QAEMZ",DIC="^DIC(51.5,",DIC("A")="Package type: ",DR=.01 S:$G(PSAOU(1))'="" DIC("B")=PSAOU(1) D ^DIC K DIC I +Y<0 G DONE
"RTN","PSAOUT",34,0)
 S PSAOU(1)=Y(0)
"RTN","PSAOUT",35,0)
 K DIR S DIR("A")="Is it ok to file the data entered",DIR(0)="Y",DIR("B")="YES" D ^DIR K DIR G Q:$D(DIRUT) I Y'>0 W !,"ok, try again,",! G CON
"RTN","PSAOUT",36,0)
 W !,"Updating Destruction holding file."
"RTN","PSAOUT",37,0)
 F  L +^PSD(58.86,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAOUT",38,0)
FIND S PSAHLD=$P(^PSD(58.86,0),"^",3)+1 I $D(^PSD(58.86,PSAHLD)) S $P(^PSD(58.86,0),"^",3)=PSAHLD G FIND
"RTN","PSAOUT",39,0)
 D NOW^%DTC S PSADT=%
"RTN","PSAOUT",40,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.86,DIC(0)="L",(X,DINUM)=PSAHLD D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSAOUT",41,0)
 L -^PSD(58.86,0)
"RTN","PSAOUT",42,0)
 W !,"Updating Drug Accountability Transaction file."
"RTN","PSAOUT",43,0)
PSTRAN S PSAIEN=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAIEN)) S $P(^PSD(58.81,0),"^",3)=PSAIEN G PSTRAN
"RTN","PSAOUT",44,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYG0=58.81,(DINUM,X)=PSAIEN D ^DIC K DIC,DLAYGO
"RTN","PSAOUT",45,0)
 S DIE="^PSD(58.81,",DA=PSAIEN,DR="1////^S X=10;3////^S X=PSADT;4////^S X=PSADRG;6////^S X=DUZ;47////^S X=PSAHLD" D ^DIE
"RTN","PSAOUT",46,0)
UPDT K DA,DIE,DR S DIE=58.86,DA=PSAHLD,DR="1////"_+PSADRG_";2////"_PSAQTY_";11////"_PSACON_";12////"_$P(PSAOU(1),U,1)_";9///^S X=DUZ;10////^S X=PSADT;6////^S X=PSALOCN;19////^S X=$G(PSAPDUOU)"
"RTN","PSAOUT",47,0)
 I +PSADRG=99999999 S ^PSD(58.86,DA,1)=PSADRUGN
"RTN","PSAOUT",48,0)
 D ^DIE K DIE,DA,DR S ^PSD(58.86,PSAHLD,2)="Returned to Manufacturer"
"RTN","PSAOUT",49,0)
 S ^XTMP("PSA",$J,PSACNT)=PSADRG_"^"_PSAQTY_"^"_PSAOU_"^"_PSACON
"RTN","PSAOUT",50,0)
 W !!!!!!! K DA,DIR S DIR(0)="E" D ^DIR K DIR I 'Y G DONE
"RTN","PSAOUT",51,0)
 G 1
"RTN","PSAOUT",52,0)
DONE I $G(PSACNT)'>0 G Q
"RTN","PSAOUT",53,0)
 K DIR S DIR("A")="Would you like to print the returns report ",DIR(0)="Y",DIR("B")="YES" D ^DIR G Q:$D(DIRUT)>0 I Y'>0 G Q
"RTN","PSAOUT",54,0)
RPT ;print report
"RTN","PSAOUT",55,0)
 W !,"If you are returning the items to the manufacturer at this time, the program",!,"will add today's date to the item to show when it was actually returned.",!
"RTN","PSAOUT",56,0)
 K DIR S DIR("A")="Are you returning items to the manufacturer at this time",DIR(0)="Y",DIR("B")="YES" D ^DIR G Q:$D(DIRUT)>0 I Y>0 S PSARET=1
"RTN","PSAOUT",57,0)
 D NOW^%DTC S X1=X,X2=-90 D C^%DTC S Y=X D DD^%DT S %DT("B")=Y
"RTN","PSAOUT",58,0)
BGNDT S %DT="AEP",%DT("A")="Beginning Date: " D ^%DT I +Y<1!($D(DTOUT))!(X["^")!(X']"") G Q
"RTN","PSAOUT",59,0)
 S PSABEG=+Y
"RTN","PSAOUT",60,0)
ENDDT D NOW^%DTC S Y=+% D DD^%DT S %DT("B")=$P(Y,"@"),%DT="AE",%DT("A")="Ending Date   : " D ^%DT I +Y<1!($D(DTOUT))!(X["^")!(X']"") S PSAOUT=1 G Q
"RTN","PSAOUT",61,0)
 I Y<PSABEG W !!,"Ending Date cannot be before the Start Date." G ENDDT
"RTN","PSAOUT",62,0)
 S PSAEND=+Y
"RTN","PSAOUT",63,0)
 K IO("Q") S %ZIS="Q" W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED.",! G Q
"RTN","PSAOUT",64,0)
 I $D(IO("Q")) K ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSAOUT",ZTDTH=$H,ZTDESC="PSA OUTDATED REPORT" F X="PSARET","PSABEG","PSAEND" S ZTSAVE(X)=""
"RTN","PSAOUT",65,0)
 I  D ^%ZTLOAD,HOME^%ZIS G Q
"RTN","PSAOUT",66,0)
 U IO
"RTN","PSAOUT",67,0)
START ;
"RTN","PSAOUT",68,0)
 K ^XTMP("PSA",$J) S PG=0
"RTN","PSAOUT",69,0)
 S Y=PSABEG,PSADT=PSABEG-.1 D DD^%DT S PSABEG(1)=Y
"RTN","PSAOUT",70,0)
 S Y=PSAEND D DD^%DT S PSAEND(1)=Y,PSAEND=PSAEND+.999999
"RTN","PSAOUT",71,0)
 D NOW^%DTC S PSARETD=$P(%,"."),^XTMP("PSA",$J,0)=PSARETD_"^"_PSARETD,Y=PSARETD
"RTN","PSAOUT",72,0)
 D DD^%DT S PSARETD=Y K Y
"RTN","PSAOUT",73,0)
LOOP ;Loop through "AC" xref
"RTN","PSAOUT",74,0)
 ;^PSD(58.86,"AC",DATE/TIME DESTROYED,DISPENSING SITE,DRUG,DA)=""
"RTN","PSAOUT",75,0)
 S PSADT=$O(^PSD(58.86,"AC",PSADT)) G BEGIN:PSADT'>0 G BEGIN:PSADT>PSAEND
"RTN","PSAOUT",76,0)
 S PSALOC1=0
"RTN","PSAOUT",77,0)
LOC S PSALOC1=$O(^PSD(58.86,"AC",PSADT,PSALOC1)) G LOOP:PSALOC1'>0 G LOOP:PSALOC1'>0 S PSADRG=0
"RTN","PSAOUT",78,0)
DRG S PSADRG=$O(^PSD(58.86,"AC",PSADT,PSALOC1,PSADRG)) G LOC:PSADRG'>0 S PSAIEN=0
"RTN","PSAOUT",79,0)
IEN S PSAIEN=$O(^PSD(58.86,"AC",PSADT,PSALOC1,PSADRG,PSAIEN)) G DRG:PSAIEN'>0
"RTN","PSAOUT",80,0)
 S PSADATA=$G(^PSD(58.86,PSAIEN,0)),PSADATA2=$G(^PSD(58.86,PSAIEN,2))
"RTN","PSAOUT",81,0)
 I $E(PSADATA2,1,3)'="Ret" G IEN
"RTN","PSAOUT",82,0)
 F X=1:1:14 S PSA(X)=$P(PSADATA,"^",X)
"RTN","PSAOUT",83,0)
 I $G(PSA(2))=99999999 S PSA(2)=$G(^PSD(58.86,PSAIEN,1))
"RTN","PSAOUT",84,0)
 S ^XTMP("PSA",$J,PSA(1))=PSA(8)_"^"_PSA(2)_"^"_PSA(3)_"^"_PSA(10)_"^"_PSA(9)_"^"_PSADT_"^"_$G(^PSD(58.86,PSAIEN,2))_"^"_PSA(12)_"^"_PSA(14)
"RTN","PSAOUT",85,0)
 I $G(PSARET)=1,$G(^PSD(58.86,PSAIEN,2))'["on" S ^PSD(58.86,PSAIEN,2)=^PSD(58.86,PSAIEN,2)_" on "_PSARETD
"RTN","PSAOUT",86,0)
 G IEN
"RTN","PSAOUT",87,0)
PRINT ;Print data
"RTN","PSAOUT",88,0)
 S PG=$G(PG)+1 W @IOF,!!!,?25,"Items to be Returned Report",?70,"Page : ",$G(PG),!,?24,PSABEG(1)," thru ",PSAEND(1),!,"Printed on: ",PSADT(1),?50,"Printed by: ",$P($G(^VA(200,DUZ,0)),"^"),! F X=1:1:((IOM/2)-2) W "- "
"RTN","PSAOUT",89,0)
 W !,?50,"Total Dispense"
"RTN","PSAOUT",90,0)
 W !,"Drug Name",?30,"Containers",?50,"Units / Cost",?66,"Entered by",! F X=1:1:(IOM-1) W "-"
"RTN","PSAOUT",91,0)
 Q
"RTN","PSAOUT",92,0)
BEGIN S PSAIEN=0 D NOW^%DTC S Y=+% D DD^%DT S PSADT(1)=Y D PRINT
"RTN","PSAOUT",93,0)
PNT1 S PSAIEN=$O(^XTMP("PSA",$J,PSAIEN)) G EORPT:PSAIEN'>0 S PSADATA=^XTMP("PSA",$J,PSAIEN),PSADRUGN=$P(PSADATA,"^",2)
"RTN","PSAOUT",94,0)
 W !,$S('$D(^PSDRUG(PSADRUGN,0)):PSADRUGN,1:$P(^PSDRUG(PSADRUGN,0),"^")) I $L(PSADRUGN)>37 W !
"RTN","PSAOUT",95,0)
 W ?38,$J($P(PSADATA,"^",1),2)," (",$P(PSADATA,"^",8),")",?50,$J($P(PSADATA,"^",3),3)
"RTN","PSAOUT",96,0)
 I $P(PSADATA,"^",9)]"",$P(PSADATA,"^",1)]"" W ?55,$J(($P(PSADATA,"^",1)*$P(PSADATA,"^",9)),5,2)
"RTN","PSAOUT",97,0)
 S PSANAME=$S($P(PSADATA,"^",4)']"":"",1:$P($G(^VA(200,$P(PSADATA,"^",4),0)),"^")) I PSANAME'="" S PSANM1=$P(PSANAME,",",1),PSANM2=$P(PSANAME,",",2),PSANAME=$E(PSANM2,1)_$E(PSANM1,1)
"RTN","PSAOUT",98,0)
 W ?64,PSANAME S DATA=$P(PSADATA,"^",6),X2=$E(DATA,1,3)+1700 W " (",$E(DATA,4,5),"/",$E(DATA,6,7),"/",$E(X2,3,4),")"
"RTN","PSAOUT",99,0)
 I $Y>(IOSL-5) D HDR G Q:$G(PSAOUT)=1
"RTN","PSAOUT",100,0)
 G PNT1
"RTN","PSAOUT",101,0)
EORPT W !!,"End of report" D ^%ZISC
"RTN","PSAOUT",102,0)
Q K AN,DA,DATA,DIC,DIR,DIE,DIRUT,DLAYG0,DR,PG,PSA,PSABEG,PSACNT,PSACON,PSADATA,PSADATA2,PSADRG
"RTN","PSAOUT",103,0)
 K PSADRUGN,PSADT,PSAEND,PSAHLD,PSAIEN,PSALOC,PSALOC1,PSALOCN,PSANAME,PSANDC,PSANM1,PSANM2,PSANUM,PSAOU
"RTN","PSAOUT",104,0)
 K PSAPDUOU,PSAOUT,PSAQTY,PSARET,PSARETD,PSARX,X,X1,X2,Y,^XTMP("PSA",$J) Q
"RTN","PSAOUT",105,0)
NONDRUG W !,"The item could not be found in the drug file.",!
"RTN","PSAOUT",106,0)
 K DIR S DIR("A")="Is this a non-va drug",DIR(0)="Y",DIR("B")="NO" D ^DIR K DIR G Q:$D(DIRUT)=1
"RTN","PSAOUT",107,0)
 I +Y'>0 G FM
"RTN","PSAOUT",108,0)
 S PSADRG=99999999,PSADRUGN=AN
"RTN","PSAOUT",109,0)
ASKD W !,PSADRUGN," //" R AN:DTIME I AN="" G CON
"RTN","PSAOUT",110,0)
 G Q:AN["^" S PSADRUGN=AN W " ok, press ENTER to confirm.",! G ASKD
"RTN","PSAOUT",111,0)
HDR I $E(IOST,1,2)="C-",PG W ! K DA,DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSAOUT=1 Q
"RTN","PSAOUT",112,0)
 D PRINT Q
"RTN","PSAPOST")
0^13^B3906198^B3787169
"RTN","PSAPOST",1,0)
PSAPOST ;BIR/JMB-Post Init ;7/23/97
"RTN","PSAPOST",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**64**; 10/24/97;Build 4
"RTN","PSAPOST",3,0)
 ;If there is a NDC in field #31, the NDC is added to the SYNONYM
"RTN","PSAPOST",4,0)
 ;multiple.
"RTN","PSAPOST",5,0)
 ;
"RTN","PSAPOST",6,0)
SYNONYM D BMES^XPDUTL("Copying the NDCs to the SYNONYM multiple in the DRUG file.")
"RTN","PSAPOST",7,0)
 S PSAIEN=0 F  S PSAIEN=$O(^PSDRUG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAPOST",8,0)
 .Q:$P($G(^PSDRUG(PSAIEN,2)),"^",4)=""
"RTN","PSAPOST",9,0)
 .S PSANDC4=$P($G(^PSDRUG(PSAIEN,2)),"^",4)
"RTN","PSAPOST",10,0)
 .S PSANDC=$E("000000",1,(6-$L($P(PSANDC4,"-"))))_$P(PSANDC4,"-")_$E("0000",1,(4-$L($P(PSANDC4,"-",2))))_$P(PSANDC4,"-",2)_$E("00",1,(2-$L($P(PSANDC4,"-",3))))_$P(PSANDC4,"-",3)
"RTN","PSAPOST",11,0)
 .S PSADASH=$E("000000",1,(6-$L($P(PSANDC4,"-"))))_$P(PSANDC4,"-")_"-"_$E("0000",1,(4-$L($P(PSANDC4,"-",2))))_$P(PSANDC4,"-",2)_"-"_$E("00",1,(2-$L($P(PSANDC4,"-",3))))_$P(PSANDC4,"-",3)
"RTN","PSAPOST",12,0)
 .I '$D(^PSDRUG(PSAIEN,1,0)) S ^PSDRUG(PSAIEN,1,0)="^50.1A^^"
"RTN","PSAPOST",13,0)
 .K DD,DO,DA S DA(1)=PSAIEN,DIC="^PSDRUG("_DA(1)_",1,",DIC(0)="LM",X=PSANDC,DLAYGO=50 D ^DIC K DIC,DLAYGO
"RTN","PSAPOST",14,0)
 .Q:$G(DA)=""
"RTN","PSAPOST",15,0)
 .S DR="2///"_PSADASH_";1///D",DA=+Y,DIE="^PSDRUG("_DA(1)_",1,"
"RTN","PSAPOST",16,0)
 .F  L +^PSDRUG(PSAIEN,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPOST",17,0)
 .D ^DIE K DIE L -^PSDRUG(PSAIEN,0)
"RTN","PSAPOST",18,0)
 K DA,DIC,DIE,DR,PSADASH,PSAIEN,PSANDC,PSANDC4,X,Y
"RTN","PSAPOST",19,0)
 D BMES^XPDUTL("Copying NDCs is complete!")
"RTN","PSAPOST",20,0)
 Q
"RTN","PSAPROC7")
0^14^B51722446^B51614865
"RTN","PSAPROC7",1,0)
PSAPROC7 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;9/6/97
"RTN","PSAPROC7",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,12,27,21,42,61,64**; 10/24/97;Build 4
"RTN","PSAPROC7",3,0)
 ;This routine takes the data in XTMP and moves it to DA ORDERS file.
"RTN","PSAPROC7",4,0)
 ;It deletes the data in XTMP after it is copies.
"RTN","PSAPROC7",5,0)
 ;
"RTN","PSAPROC7",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAPROC7",7,0)
INVOICE ;PSA*3*21 (3JAN01) - FILE INVOICE IMMEDIATELY
"RTN","PSAPROC7",8,0)
 ;
"RTN","PSAPROC7",9,0)
 S PSAIN=$G(^XTMP("PSAPV",PSACTRL,"IN")) Q:PSAIN=""
"RTN","PSAPROC7",10,0)
 Q:$P(PSAIN,"^",8)'="P"
"RTN","PSAPROC7",11,0)
 S PSAORD=$P(PSAIN,"^",4),PSAIEN=+$O(^PSD(58.811,"B",PSAORD,0)),PSACRED=0
"RTN","PSAPROC7",12,0)
 I 'PSAIEN D
"RTN","PSAPROC7",13,0)
 .F  L +^PSD(58.811,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPROC7",14,0)
 .;(PSA*3*24 - Dave B. Jun 2 00 - Improper DIC call)
"RTN","PSAPROC7",15,0)
 .;(PSA*3*61 - add N DO. DICN will use DO if defined, we do not want to use it since DIC is defined.
"RTN","PSAPROC7",16,0)
 .N DO S DIC="^PSD(58.811,",DIC(0)="L",X=PSAORD D FILE^DICN K DIC L -^PSD(58.811,0) S PSAIEN=+Y
"RTN","PSAPROC7",17,0)
 F  L +^PSD(58.811,PSAIEN,0):10 I  Q
"RTN","PSAPROC7",18,0)
 S:'$D(^PSD(58.811,PSAIEN,1,0)) DIC("P")=$P(^DD(58.811,2,0),"^",2)
"RTN","PSAPROC7",19,0)
 S DA(1)=PSAIEN,DIC="^PSD(58.811,"_DA(1)_",1,",DIC(0)="L",X=$P(PSAIN,"^",2),DLAYGO=58.811 D ^DIC K DA,DLAYGO S PSAIEN1=+Y
"RTN","PSAPROC7",20,0)
 S DA(1)=PSAIEN,DA=PSAIEN1,DIE=DIC K DIC
"RTN","PSAPROC7",21,0)
 S PSALOCDR=$P($G(PSAIN),"^",7)
"RTN","PSAPROC7",22,0)
 S PSADELDR=$P($G(PSAIN),"^",6)
"RTN","PSAPROC7",23,0)
 S PSACSDR=$S($P(PSAIN,"^",10)="ALL CS":"A",$P(PSAIN,"^",9)="CS":"S",1:"N")
"RTN","PSAPROC7",24,0)
 S PSARECD=$P($G(PSAIN),"^",11)
"RTN","PSAPROC7",25,0)
 S PSAMV=$S(+$P(PSAIN,"^",12):$P(PSAIN,"^",12),1:"")
"RTN","PSAPROC7",26,0)
 S PSASUP=$S($P(PSAIN,"^",13)="SUP":1,1:"")
"RTN","PSAPROC7",27,0)
 ;DAVE B ( PSA*3*12) Invalid Concatenation of zero node
"RTN","PSAPROC7",28,0)
 S ^PSD(58.811,DA(1),1,DA,0)=$P(^(0),"^")_"^"_$P(PSAIN,"^",1)_"^P^"_$P(PSAIN,"^",3)_"^"_$G(PSALOCDR)_"^"_$G(PSADELDR)_"^"_$G(PSARECD)_"^"_$G(PSACSDR)_"^^"_DUZ_"^^"_$G(PSAMV)_"^"_$G(PSASUP)
"RTN","PSAPROC7",29,0)
 S DIK=DIE D IX^DIK
"RTN","PSAPROC7",30,0)
 K ^TMP($J,"PSADIF"),PSADIFLC ;*42 pre verify storage for  OU, DUOU, Cost, NDC changes
"RTN","PSAPROC7",31,0)
 S PSALINE=0 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:PSALINE=""  D LINE
"RTN","PSAPROC7",32,0)
 D SCANDIF,MM ;*42 look for differences to drug file SEND EMAIL
"RTN","PSAPROC7",33,0)
 I PSACRED K DA S DA(1)=PSAIEN,DA=PSAIEN1,DIE="^PSD(58.811,"_DA(1)_",1,",DR="10///^S X=1" D ^DIE K DIE
"RTN","PSAPROC7",34,0)
 S $P(^PSD(58.811,PSAIEN,0),"^",2)=$P($G(^XTMP("PSAPV",PSACTRL,"DS")),"^")
"RTN","PSAPROC7",35,0)
 L -^PSD(58.811,PSAIEN,0)
"RTN","PSAPROC7",36,0)
 K ^XTMP("PSAPV",PSACTRL)
"RTN","PSAPROC7",37,0)
 Q
"RTN","PSAPROC7",38,0)
 ;
"RTN","PSAPROC7",39,0)
LINE ;Files line items.
"RTN","PSAPROC7",40,0)
 S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE) S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,0)) DIC("P")=$P(^DD(58.8112,5,0),"^",2)
"RTN","PSAPROC7",41,0)
 ;PSA*3*31 Dave B - Check for invoice already in file
"RTN","PSAPROC7",42,0)
 S DA(2)=PSAIEN,DA(1)=PSAIEN1,(DA,X)=PSALINE,DIC="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811 D ^DIC S PSAIEN2=+Y K DA,DIC,DLAYGO
"RTN","PSAPROC7",43,0)
 ;
"RTN","PSAPROC7",44,0)
 ;DAVEB PSA*3*3 (5may98)
"RTN","PSAPROC7",45,0)
 S PSADRG=$P($G(PSADATA),"^",6)
"RTN","PSAPROC7",46,0)
 S PSASYN=$P($G(PSADATA),"^",7)
"RTN","PSAPROC7",47,0)
 K PSAUNIT
"RTN","PSAPROC7",48,0)
 I $G(PSASYN)'="",$G(PSADRG)'="" S PSAUNIT=+$P($G(^PSDRUG(PSADRG,1,PSASYN,0)),"^",5)
"RTN","PSAPROC7",49,0)
 ;
"RTN","PSAPROC7",50,0)
 ;DAVE B (PSA*3*12) Assignment of order unit didn't take into 
"RTN","PSAPROC7",51,0)
 ;account the adjusted order unit.
"RTN","PSAPROC7",52,0)
 S PSAUNIT=$S($D(PSAUNIT):PSAUNIT,$P(PSADATA,"^",12)'="":$P(PSADATA,"^",12),+$P($P(PSADATA,"^",2),"~",2):+$P($P(PSADATA,"^",2),"~",2),1:0)
"RTN","PSAPROC7",53,0)
 S PSACS=$S($P(PSADATA,"^",19)="CS":1,1:0),PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~"),PSAUPC=$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC7",54,0)
 I PSANDC="",$P($P(PSADATA,"^",26),"~")'="" S PSANDC="S"_$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC7",55,0)
 S DA(2)=PSAIEN,DA(1)=PSAIEN1,DA=$S($D(PSAIEN2):PSAIEN2,1:PSALINE),DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,"
"RTN","PSAPROC7",56,0)
 ;DaveB (4may98) hard code filing data
"RTN","PSAPROC7",57,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",3)=+PSADATA
"RTN","PSAPROC7",58,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",11)=PSANDC
"RTN","PSAPROC7",59,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",12)=PSAVSN
"RTN","PSAPROC7",60,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",13)=PSAUPC
"RTN","PSAPROC7",61,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",10)=PSACS
"RTN","PSAPROC7",62,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",2)=PSADRG
"RTN","PSAPROC7",63,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",4)=PSAUNIT
"RTN","PSAPROC7",64,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",5)=$P(PSADATA,"^",3)
"RTN","PSAPROC7",65,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",6)=DT
"RTN","PSAPROC7",66,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",7)=DUZ
"RTN","PSAPROC7",67,0)
 S DIK=DIE D IX^DIK
"RTN","PSAPROC7",68,0)
 ;End PSA*3*7
"RTN","PSAPROC7",69,0)
 ;
"RTN","PSAPROC7",70,0)
 I +$P(PSADATA,"^",15)!($D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"))) D ADJDRUG
"RTN","PSAPROC7",71,0)
 I $P(PSADATA,"^",8)'="" D QTY
"RTN","PSAPROC7",72,0)
 I +$P(PSADATA,"^",12) D OU
"RTN","PSAPROC7",73,0)
 I +$P(PSADATA,"^",23) D PRICE
"RTN","PSAPROC7",74,0)
 ;Adds the reorder level and/or dispense units per order unit
"RTN","PSAPROC7",75,0)
 I +$P(PSADATA,"^",7)!(+$P(PSADATA,"^",20))!(+$P(PSADATA,"^",21))!(+$P(PSADATA,"^",27)) D
"RTN","PSAPROC7",76,0)
 .S ^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,2)=$P(PSADATA,"^",20)_"^"_$P(PSADATA,"^",21)_"^"_$S(+$P(PSADATA,"^",7):+$P(PSADATA,"^",7),1:0)_"^"_+$P(PSADATA,"^",27)
"RTN","PSAPROC7",77,0)
 K ^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC7",78,0)
 Q
"RTN","PSAPROC7",79,0)
ADJDRUG ;Records adjusted drug received
"RTN","PSAPROC7",80,0)
 S PSAFLD="D"
"RTN","PSAPROC7",81,0)
 I +$P(PSADATA,"^",15) S PSADJ=+$P(PSADATA,"^",15),PSADUZ=+$P(PSADATA,"^",16),PSADT=+$P(PSADATA,"^",17),PSAREA="" D RECORD Q
"RTN","PSAPROC7",82,0)
 I $D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")) S PSASNODE=^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"),PSADJ=$P(PSASNODE,"^",3),PSADUZ=+$P(PSASNODE,"^"),PSADT=+$P(PSASNODE,"^",2),PSAREA="" D RECORD
"RTN","PSAPROC7",83,0)
 Q
"RTN","PSAPROC7",84,0)
OU ;Records adjusted order unit
"RTN","PSAPROC7",85,0)
 S PSAFLD="O",PSADJ=+$P(PSADATA,"^",12),PSADUZ=+$P(PSADATA,"^",13),PSADT=+$P(PSADATA,"^",14),PSAREA=""
"RTN","PSAPROC7",86,0)
 D RECORD
"RTN","PSAPROC7",87,0)
 Q
"RTN","PSAPROC7",88,0)
PRICE ;Records adjusted price per order unit
"RTN","PSAPROC7",89,0)
 S PSAFLD="P",PSADJ=+$P(PSADATA,"^",23),PSADUZ=+$P(PSADATA,"^",24),PSADT=+$P(PSADATA,"^",25),PSAREA=""
"RTN","PSAPROC7",90,0)
 S:PSADJ'=+$P(PSADATA,"^",3) PSACRED=1
"RTN","PSAPROC7",91,0)
 D RECORD
"RTN","PSAPROC7",92,0)
 Q
"RTN","PSAPROC7",93,0)
QTY ;Records adjusted quantity received.
"RTN","PSAPROC7",94,0)
 S PSAFLD="Q",PSADJ=+$P(PSADATA,"^",8),PSADUZ=+$P(PSADATA,"^",9),PSADT=+$P(PSADATA,"^",10),PSAREA=$P(PSADATA,"^",11)
"RTN","PSAPROC7",95,0)
 S:PSADJ'=+$P(PSADATA,"^") PSACRED=1
"RTN","PSAPROC7",96,0)
 D RECORD
"RTN","PSAPROC7",97,0)
 Q
"RTN","PSAPROC7",98,0)
RECORD ;Adds adjusted data to DA ORDERS file
"RTN","PSAPROC7",99,0)
 K DA S DA(3)=PSAIEN,DA(2)=PSAIEN1,DA(1)=PSAIEN2,X=PSAFLD
"RTN","PSAPROC7",100,0)
 S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,0)) DIC("P")=$P(^DD(58.81125,9,0),"^",2)
"RTN","PSAPROC7",101,0)
 ;PSA*3*27 (DAVE B) removed killing of DA variable on next line
"RTN","PSAPROC7",102,0)
 S DIC="^PSD(58.811,"_DA(3)_",1,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811 D ^DIC S PSAIEN3=+Y K DLAYGO
"RTN","PSAPROC7",103,0)
 ;
"RTN","PSAPROC7",104,0)
 ;PSA*3*3
"RTN","PSAPROC7",105,0)
 ;DAVEB Hard code filing
"RTN","PSAPROC7",106,0)
 S DIE=DIC,DA=PSAIEN3
"RTN","PSAPROC7",107,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",2)=PSADJ
"RTN","PSAPROC7",108,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",3)=$G(PSAREA)
"RTN","PSAPROC7",109,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",4)=DT
"RTN","PSAPROC7",110,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",5)=DUZ
"RTN","PSAPROC7",111,0)
 ;
"RTN","PSAPROC7",112,0)
 ;S DIE=DIC,DA=PSAIEN3,DR="1///"_PSADJ_$S(PSAREA'="":";2////^S X=PSAREA",1:"")_";3///^S X="_PSADT_";4///^S X="_PSADUZ K DIC D ^DIE
"RTN","PSAPROC7",113,0)
 S DIK=DIE,DA=PSAIEN3 D IX1^DIK K DA,DIE,DIK,PSAFLD
"RTN","PSAPROC7",114,0)
 Q
"RTN","PSAPROC7",115,0)
 ;*42 CHANGES
"RTN","PSAPROC7",116,0)
SCANDIF ; inspect invoice for noted differences in OU,DUOU,PPDU,NDC
"RTN","PSAPROC7",117,0)
 ;NEEDS PSAIEN, PSAIEN1
"RTN","PSAPROC7",118,0)
 K ^TMP($J,"PSADIF"),PSADIFLC
"RTN","PSAPROC7",119,0)
 S PSALINE=0 F  S PSALINE=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:PSALINE'>0  D CHECK
"RTN","PSAPROC7",120,0)
 Q
"RTN","PSAPROC7",121,0)
MM ;
"RTN","PSAPROC7",122,0)
 I $D(^TMP($J,"PSADIF")) D MESSAGE
"RTN","PSAPROC7",123,0)
 Q
"RTN","PSAPROC7",124,0)
CHECK ;Check line item for differences to drug file *42
"RTN","PSAPROC7",125,0)
 N ITM,ITMI,DRG,DRIEN,DIF,ZZ,XX,XXX,PCNT,PDIF,T,IENS
"RTN","PSAPROC7",126,0)
 ; use new API call to retrieve item fields see PSAUTL6
"RTN","PSAPROC7",127,0)
 D ITEM^PSAUTL6(PSAIEN,PSAIEN1,PSALINE,.ITM)
"RTN","PSAPROC7",128,0)
 D ITEM^PSAUTL6(PSAIEN,PSAIEN1,PSALINE,.ITMI,"I")
"RTN","PSAPROC7",129,0)
 I ITM(2)'>0 Q  ;zero quantity will not be filed
"RTN","PSAPROC7",130,0)
 S ITM("OU")=ITM(3),ITM("DUOU")=ITM(10),ITM("NDC")=ITM(13),ITM("PPOU")=ITM(4),ITM("PPDU")=$J(ITM("PPOU")/ITM("DUOU"),1,4)
"RTN","PSAPROC7",131,0)
 S DRIEN=+ITMI(1)
"RTN","PSAPROC7",132,0)
 S DRG("OU")=$$GET1^DIQ(50,DRIEN,12),DRG("DUOU")=$$GET1^DIQ(50,DRIEN,15),DRG("NDC")=$$GET1^DIQ(50,DRIEN,31),DRG("PPDU")=$$GET1^DIQ(50,DRIEN,16)
"RTN","PSAPROC7",133,0)
 K DIF
"RTN","PSAPROC7",134,0)
 F XX="OU","DUOU","NDC" I ITM(XX)'=DRG(XX) S DIF(XX)=""
"RTN","PSAPROC7",135,0)
 I ITM("PPDU")'=DRG("PPDU") S PCNT=.05*DRG("PPDU"),PDIF=DRG("PPDU")-ITM("PPDU") S:PDIF<0 PDIF=-1*PDIF S:PDIF>PCNT DIF("PPDU")=""
"RTN","PSAPROC7",136,0)
 I $D(DIF) D
"RTN","PSAPROC7",137,0)
 . F ZZ=" ",$J(ITM(.01),3)_"   "_ITM(1) D SET
"RTN","PSAPROC7",138,0)
 . S XXX="" F  S XXX=$O(DIF(XXX)) Q:XXX=""  D
"RTN","PSAPROC7",139,0)
 .. S ZZ="  ",T=XXX,ZZ=$$SETSTR^VALM1(T,ZZ,4,$L(T))
"RTN","PSAPROC7",140,0)
 .. S T="Old: "_DRG(XXX),ZZ=$$SETSTR^VALM1(T,ZZ,13,$L(T))
"RTN","PSAPROC7",141,0)
 .. S T="New: "_ITM(XXX),ZZ=$$SETSTR^VALM1(T,ZZ,36,$L(T))
"RTN","PSAPROC7",142,0)
 .. D SET
"RTN","PSAPROC7",143,0)
 Q
"RTN","PSAPROC7",144,0)
SET ;set differences into ^TMP
"RTN","PSAPROC7",145,0)
 S:'$G(PSADIFLC) PSADIFLC=3
"RTN","PSAPROC7",146,0)
 S ^TMP($J,"PSADIF",PSADIFLC,0)=ZZ,PSADIFLC=PSADIFLC+1
"RTN","PSAPROC7",147,0)
 Q
"RTN","PSAPROC7",148,0)
MESSAGE ;differences found, notify user and send message to g.PSA NDC UPDATES.
"RTN","PSAPROC7",149,0)
 K DIR N IENS
"RTN","PSAPROC7",150,0)
 S PSAORD=$$GET1^DIQ(58.811,PSAIEN,.01),IENS=PSAIEN1_","_PSAIEN
"RTN","PSAPROC7",151,0)
 S PSAINV=$$GET1^DIQ(58.8112,IENS,.01)
"RTN","PSAPROC7",152,0)
 S XMSUB="PRE Verify "_PSAORD_" : "_PSAINV_" Variance Report"
"RTN","PSAPROC7",153,0)
 S ^TMP($J,"PSADIF",1,0)=XMSUB,^TMP($J,"PSADIF",2,0)=" "
"RTN","PSAPROC7",154,0)
 W !,XMSUB,!
"RTN","PSAPROC7",155,0)
 W !,"Noted differences between the invoice line items and the drug file have",!,"been found. A mail message is being sent to G.PSA NDC UPDATES."
"RTN","PSAPROC7",156,0)
 W !!,"    Please check the message for accuracy.",!
"RTN","PSAPROC7",157,0)
 K DIR S DIR(0)="E",DIR("A")="<cr> - continue" D ^DIR
"RTN","PSAPROC7",158,0)
 K DIR
"RTN","PSAPROC7",159,0)
 S XMTEXT="^TMP($J,""PSADIF"",",XMY("G.PSA NDC UPDATES")=""
"RTN","PSAPROC7",160,0)
 D ^XMD
"RTN","PSAPROC7",161,0)
 K PSADIFLC,^TMP($J,"PSADIF")
"RTN","PSAPROC7",162,0)
 Q
"RTN","PSAPROC8")
0^15^B42624373^B42292090
"RTN","PSAPROC8",1,0)
PSAPROC8 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSAPROC8",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,64**; 10/24/97;Build 4
"RTN","PSAPROC8",3,0)
 ;This routine processes uploaded invoices.
"RTN","PSAPROC8",4,0)
 ;
"RTN","PSAPROC8",5,0)
DU ;Prompts Dispense Unit if blank
"RTN","PSAPROC8",6,0)
 F  L +^PSDRUG(PSAIEN,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPROC8",7,0)
 S DIE="^PSDRUG(",DA=PSAIEN,DR=14.5 D ^DIE K DIE L -^PSDRUG(PSAIEN,0)
"RTN","PSAPROC8",8,0)
 I +$P($G(^PSDRUG(PSAIEN,660)),"^",8) D  G DU
"RTN","PSAPROC8",9,0)
 .F  L +^PSDRUG(PSAIEN,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPROC8",10,0)
 .S DIE="^PSDRUG(",DA=PSAIEN,DR="14.5///@" D ^DIE K DIE L -^PSDRUG(PSAIEN,0)
"RTN","PSAPROC8",11,0)
 I $P($G(^PSDRUG(PSAIEN,660)),"^",8)'="" S PSADU=1 Q
"RTN","PSAPROC8",12,0)
 ;
"RTN","PSAPROC8",13,0)
 W !,"The dispense units must be entered to change",!,"the status of the invoice to Processed."
"RTN","PSAPROC8",14,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to enter the dispense units now",DIR("?",1)="Enter Yes to return to the DISPENSE UNIT prompt.",DIR("?")="Enter No to bypass entering the dispense units now."
"RTN","PSAPROC8",15,0)
 S DIR("??")="^D DISPYN^PSAPROC8" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC8",16,0)
 G:+Y DU
"RTN","PSAPROC8",17,0)
 Q
"RTN","PSAPROC8",18,0)
 ;
"RTN","PSAPROC8",19,0)
DUOU ;Gets Dispense Units per Order Unit
"RTN","PSAPROC8",20,0)
 W:'$G(PSADU) !,"DISPENSE UNITS: "_$P($G(^PSDRUG(PSAIEN,660)),"^",8)
"RTN","PSAPROC8",21,0)
 S PSADU=1
"RTN","PSAPROC8",22,0)
 F  L +^PSDRUG(PSAIEN,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPROC8",23,0)
 S DIE="^PSDRUG("_PSAIEN_",1,",DA(1)=PSAIEN,DA=+PSASUB,DR=403 D ^DIE K DIE L -^PSDRUG(PSAIEN,0)
"RTN","PSAPROC8",24,0)
 I $D(Y)!($G(DTOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",25,0)
 Q:+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",7)
"RTN","PSAPROC8",26,0)
 ;
"RTN","PSAPROC8",27,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A",1)="The dispense units per order unit must be entered to change the ",DIR("A")="status of the invoice to Processed. Do you want to enter the data now"
"RTN","PSAPROC8",28,0)
 S DIR("?",1)="Enter Yes to return to the "_$P($G(^PSDRUG(PSAIEN,660)),"^",8)_"s per "_$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",2),0)),"^",2)_" prompt."
"RTN","PSAPROC8",29,0)
 S DIR("?")="Enter No to bypass entering the dispense units now.",DIR("??")="^D DUOUYN^PSAPROC8"
"RTN","PSAPROC8",30,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",31,0)
 G:+Y DUOU
"RTN","PSAPROC8",32,0)
 Q
"RTN","PSAPROC8",33,0)
OK ;
"RTN","PSAPROC8",34,0)
 S PSACNTOK=PSACNTOK+1,PSAOK(PSACNTOK)=$P(^XTMP("PSAPV",PSACTRL,"IN"),"^",4)_"^"_$P(^("IN"),"^",2)_"^"_PSACTRL_"^"_$P(^("IN"),"^",7)
"RTN","PSAPROC8",35,0)
 Q
"RTN","PSAPROC8",36,0)
PRICE ;Price per Order Unit changed
"RTN","PSAPROC8",37,0)
 S PSAIPR=$L($FN($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",3),",",2)),PSAFPR=$L($FN($P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6),",",2))
"RTN","PSAPROC8",38,0)
 S PSAJUST=$S(PSAIPR>PSAFPR:PSAIPR,1:PSAFPR)
"RTN","PSAPROC8",39,0)
 W !!,"Price per Order Unit -- Invoice's: $"_$J($FN($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",3),",",2),PSAJUST,2),!?24,"File's   : $"_$J($FN($P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6),",",2),PSAJUST,2),!
"RTN","PSAPROC8",40,0)
 S DIR(0)="Y",DIR("A")="Is the invoice's price per order unit correct",DIR("B")="Y",DIR("?",1)="Enter Yes if "_$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",3)_" is correct."
"RTN","PSAPROC8",41,0)
 S DIR("?")="Enter No to keep the file's price per order unit.",DIR("??")="^D PRICEOU^PSAPROC1" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAPROC8",42,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",22)=+Y
"RTN","PSAPROC8",43,0)
 I '+Y S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",23)=+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",6),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",24)=DUZ,$P(^(PSALINE),"^",25)=DT
"RTN","PSAPROC8",44,0)
 Q
"RTN","PSAPROC8",45,0)
 ;
"RTN","PSAPROC8",46,0)
REORDER ;Enter reorder level for drug if the field is blank.
"RTN","PSAPROC8",47,0)
 W:'$G(PSADU) !,"DISPENSE UNITS: "_$P($G(^PSDRUG(+PSAIEN,660)),"^",8)
"RTN","PSAPROC8",48,0)
 S PSADU=1,DIR(0)="NO^0:99999",DIR("A")="REORDER LEVEL IN "_$P($G(^PSD(58.8,PSALOC,0)),"^")
"RTN","PSAPROC8",49,0)
 S DIR("?")="Enter the minimum number of dispense units to keep in the "_$S($P(PSADATA,"^",19)="CS":"master vault.",1:"pharmacy location."),DIR("??")="^D REORD^PSAPROC8"
"RTN","PSAPROC8",50,0)
 S DIR("B")=$S(+$P(PSADATA,"^",21):+$P(PSADATA,"^",21),+$P($G(^PSD(58.8,PSALOC,1,PSAIEN,0)),"^",5):$P(^PSD(58.8,PSALOC,1,PSAIEN,0),"^",5),1:"")
"RTN","PSAPROC8",51,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",52,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",21)=+Y
"RTN","PSAPROC8",53,0)
 Q
"RTN","PSAPROC8",54,0)
 ;
"RTN","PSAPROC8",55,0)
STOCK ;Enter stock level for drug if the field is blank.
"RTN","PSAPROC8",56,0)
 W:'$G(PSADU) !,"DISPENSE UNITS: "_$P($G(^PSDRUG(+PSAIEN,660)),"^",8)
"RTN","PSAPROC8",57,0)
 S PSADU=1,DIR(0)="NO^0:99999",DIR("A")="STOCK LEVEL IN "_$P($G(^PSD(58.8,+PSALOC,0)),"^")
"RTN","PSAPROC8",58,0)
 S DIR("?")="Enter the minimum number of dispense units to keep on the shelf",DIR("??")="^D STKLEVEL^PSAPROC8"
"RTN","PSAPROC8",59,0)
 S DIR("B")=$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),+$P($G(^PSD(58.8,PSALOC,1,PSAIEN,0)),"^",3):$P(^PSD(58.8,PSALOC,1,PSAIEN,0),"^",3),1:"")
"RTN","PSAPROC8",60,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAPROC8",61,0)
 Q:$G(DIRUT)
"RTN","PSAPROC8",62,0)
 S:+Y $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",27)=+Y
"RTN","PSAPROC8",63,0)
 Q
"RTN","PSAPROC8",64,0)
 ;
"RTN","PSAPROC8",65,0)
DISPYN ;Extended help to enter dispense units
"RTN","PSAPROC8",66,0)
 W !?5,"Enter Yes if you want to enter the dispense units now.",!!?5,"Enter No to bypass entering the dispense units. The invoice will not",!?5,"be placed in a Processed status if the dispense units are not entered."
"RTN","PSAPROC8",67,0)
 Q
"RTN","PSAPROC8",68,0)
DUOUYN ;Extended help to enter dispense units per order units
"RTN","PSAPROC8",69,0)
 W !?5,"Enter Yes if you want to enter the dispense units per order unit now.",!!?5,"Enter No to bypass entering the dispense units per order unit. The"
"RTN","PSAPROC8",70,0)
 W !?5,"invoice will not be placed in a "_$S($D(PSABEFOR):"Verified",1:"Processed")_" status if the dispense units",!?5,"are not entered."
"RTN","PSAPROC8",71,0)
 Q
"RTN","PSAPROC8",72,0)
PRICEOU ;Extended help to 'Is invoice's price per order unit correct'
"RTN","PSAPROC8",73,0)
 W !?5,"Enter Yes if the invoice's price per order unit is correct. The",!?5,"invoice's price per order unit will be entered into the DRUG file."
"RTN","PSAPROC8",74,0)
 W !!?5,"Enter No if the invoice's price per order unit is not correct.",!?5,"The DRUG file's price per order unit will remain the same."
"RTN","PSAPROC8",75,0)
 Q
"RTN","PSAPROC8",76,0)
REORD ;Extended help for 'Reorder level'
"RTN","PSAPROC8",77,0)
 W !?5,"Enter the lowest amount of "_$P($G(^PSDRUG(PSAIEN,660)),"^",8)_"s to keep in the "_$S($P(PSADATA,"^",19)="CS":"master vault",1:"pharmacy location")_"."
"RTN","PSAPROC8",78,0)
 W !!?5,"When the amount on hand is lower than the reorder level, a mail",!?5,"message will be sent showing the drug name, reorder level, and",!?5,"quantity on hand."
"RTN","PSAPROC8",79,0)
 Q
"RTN","PSAPROC8",80,0)
STKLEVEL ;Extended help for 'Stock level'
"RTN","PSAPROC8",81,0)
 W !?5,"Enter the ideal number of dispense units to keep on the shelf. When the",!?5,"number of dispense units is equal to or less than the reorder level, the"
"RTN","PSAPROC8",82,0)
 W !?5,"amount to order is determined by subtracting the current number of dispense",!?5,"units from the stock level."
"RTN","PSAPROC8",83,0)
 Q
"RTN","PSAPSI1")
0^16^B9754975^B9513101
"RTN","PSAPSI1",1,0)
PSAPSI1 ;BIR/LTL-IV Dispensing (Single Drug) & (All Drugs) ;7/23/97
"RTN","PSAPSI1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**64**; 10/24/97;Build 4
"RTN","PSAPSI1",3,0)
 ;This routine places the IV data into files 58.8 and 58.81. It is called
"RTN","PSAPSI1",4,0)
 ;by PSAPSI, PSAPSI2, AND PSAPSI3.
"RTN","PSAPSI1",5,0)
 ;
"RTN","PSAPSI1",6,0)
 N DIC,PSAD,PSAT
"RTN","PSAPSI1",7,0)
 S (PSA(4),PSA(6))=0 F  S PSA(4)=$O(^TMP("PSA",$J,PSADRUG,PSA(4))) Q:'PSA(4)  S PSA(6)=PSA(6)+1
"RTN","PSAPSI1",8,0)
 ;get transaction numbers
"RTN","PSAPSI1",9,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPSI1",10,0)
FIND S PSAD=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAD)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSAPSI1",11,0)
 S PSAT=PSAD,DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81
"RTN","PSAPSI1",12,0)
 F PSAD=PSAT:1:(PSAT+(PSA(6)-1)) S (DINUM,X)=PSAD D ^DIC
"RTN","PSAPSI1",13,0)
 L -^PSD(58.81,0) K DIC,DINUM,DLAYGO
"RTN","PSAPSI1",14,0)
 ;loop thru array
"RTN","PSAPSI1",15,0)
LUP S PSA(4)=0 F  S PSA(4)=$O(^TMP("PSA",$J,PSADRUG,PSA(4))) Q:'PSA(4)  S PSA=$G(^TMP("PSA",$J,PSADRUG,PSA(4))) S:$P($G(^PSD(58.8,PSALOC,1,PSADRUG,6)),U,4) PSA=PSA/$P($G(^(6)),U,4) D LUP1
"RTN","PSAPSI1",16,0)
 K ^TMP("PSA",$J,PSADRUG)
"RTN","PSAPSI1",17,0)
 Q
"RTN","PSAPSI1",18,0)
LUP1 ;get date + current balance + update balance
"RTN","PSAPSI1",19,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRUG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAPSI1",20,0)
 S PSAB=$P($G(^PSD(58.8,PSALOC,1,PSADRUG,0)),U,4)
"RTN","PSAPSI1",21,0)
 G:'$G(PSA(7)) EDO
"RTN","PSAPSI1",22,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRUG,0),U,4)=$P($G(^(0)),U,4)-PSA
"RTN","PSAPSI1",23,0)
EDO L -^PSD(58.8,PSALOC,1,PSADRUG,0)
"RTN","PSAPSI1",24,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSAPSI1",25,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRUG,5,+$E(PSA(4),1,5)*100,0)) D
"RTN","PSAPSI1",26,0)
 .S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSAB)",(X,DINUM)=$E(PSA(4),1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSAPSI1",27,0)
 .S X="T-1M" D ^%DT S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO S DA=+Y
"RTN","PSAPSI1",28,0)
 .S DIE="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DA(2)=PSALOC,DA(1)=PSADRUG
"RTN","PSAPSI1",29,0)
 .S DR="3////^S X=$G(PSAB)" D ^DIE K DIE
"RTN","PSAPSI1",30,0)
 S DIE="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",5,",DR="9////^S X=$P($G(^(0)),U,6)+PSA",DA=$E(PSA(4),1,5)*100,DA(2)=PSALOC,DA(1)=PSADRUG D ^DIE K DA
"RTN","PSAPSI1",31,0)
 ;update transaction
"RTN","PSAPSI1",32,0)
 S DIE="^PSD(58.81,",DR="1////15;2////^S X=PSALOC;3///^S X=PSA(4);4////^S X=PSADRUG;5////^S X=PSA;9////^S X=$G(PSAB)",DA=PSAT
"RTN","PSAPSI1",33,0)
 D ^DIE K DIE,DA,PSAB
"RTN","PSAPSI1",34,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSAPSI1",35,0)
 S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRUG_",4,",DIC(0)="L",(X,DINUM)=PSAT
"RTN","PSAPSI1",36,0)
 S DA(2)=PSALOC,DA(1)=PSADRUG,DLAYGO=58.8 D ^DIC K DA,DIC,DINUM,DLAYGO
"RTN","PSAPSI1",37,0)
 S DIE="^PSD(58.8,"_PSALOC_",1,",DA(1)=PSALOC,DA=PSADRUG,DR="24////^S X=PSA(4)_"",""_$G(PSAW(1))" D ^DIE S PSAT=PSAT+1
"RTN","PSAPSI1",38,0)
 Q
"RTN","PSAREC1")
0^17^B27528153^B25736843
"RTN","PSAREC1",1,0)
PSAREC1 ;BIR/LTL,JMB-Receiving Directly into Drug Accountability - CONT'D  ;7/23/97
"RTN","PSAREC1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**21,37,64**; 10/24/97;Build 4
"RTN","PSAREC1",3,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAREC1",4,0)
 ;This routine posts non-prime vendor's drugs into pharmacy locations.
"RTN","PSAREC1",5,0)
 ;The balances are incremented in the pharmacy location & the DRUG file.
"RTN","PSAREC1",6,0)
 ;
"RTN","PSAREC1",7,0)
POST ;Posts the data in 58.8, 58.81, and 50
"RTN","PSAREC1",8,0)
 D NOW^%DTC S PSADT=+$E(%,1,12) K %
"RTN","PSAREC1",9,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSAREC1",10,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) DIC("P")=$P(^DD(58.8,10,0),"^",2)
"RTN","PSAREC1",11,0)
 .S DA(1)=PSALOC,DIC="^PSD(58.8,"_DA(1)_",1,",(DA,X)=PSADRG,DIC(0)="L",DLAYGO=58.8
"RTN","PSAREC1",12,0)
 .F  L +^PSD(58.8,PSALOC,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAREC1",13,0)
 .D ^DIC L -^PSD(58.8,PSALOC,0) K DIC,DA
"RTN","PSAREC1",14,0)
 W !!,"There were ",$S($P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4):$P($G(^(0)),"^",4),1:0)," on hand.",?40,"There are now ",$P($G(^(0)),"^",4)+PSAREC," on hand.",!
"RTN","PSAREC1",15,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAREC1",16,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSAREC+PSACBAL
"RTN","PSAREC1",17,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAREC1",18,0)
 ;
"RTN","PSAREC1",19,0)
MONTHLY I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,$E(DT,1,5)*100,0)) D
"RTN","PSAREC1",20,0)
 .;PSA*3*31 Set zero node to correct DD (20 not 28) Dave B.
"RTN","PSAREC1",21,0)
 .S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) DIC("P")=$P(^DD(58.8001,20,0),"^",2)
"RTN","PSAREC1",22,0)
 .S DIC="^PSD(58.8,PSALOC,1,PSADRG,5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSACBAL)",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSAREC1",23,0)
 .S X="T-1M" D ^%DT
"RTN","PSAREC1",24,0)
 .S DIC="^PSD(58.8,PSALOC,1,PSADRG,5,",DIC(0)="L",(X,DINUM)=$E(Y,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO S DA=+Y
"RTN","PSAREC1",25,0)
 .S DIE="^PSD(58.8,PSALOC,1,PSADRG,5,",DA(2)=PSALOC,DA(1)=PSADRG,DR="3////^S X=$G(PSACBAL)" D ^DIE K DIE
"RTN","PSAREC1",26,0)
 S DIE="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DA(2)=PSALOC,DA(1)=PSADRG,DA=$E(DT,1,5)*100,DR="5////^S X="_$P($G(^(0)),"^",3)+PSAREC D ^DIE
"RTN","PSAREC1",27,0)
 W !,"Updating monthly receipts and transaction history.",!
"RTN","PSAREC1",28,0)
TR F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAREC1",29,0)
FIND S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSAREC1",30,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSAREC1",31,0)
 S DIE="^PSD(58.81,",DA=PSAT,DR="1////1;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRG;5////^S X=PSAREC;6////^S X=DUZ;7////^S X=PSACON;8////^S X=PSAPO;9////^S X=PSACBAL;71////^S X=$G(PSAPV)" D ^DIE
"RTN","PSAREC1",32,0)
 L -^PSD(58.81,0)
"RTN","PSAREC1",33,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,4,0)) DIC("P")=$P(^DD(58.8001,19,0),"^",2)
"RTN","PSAREC1",34,0)
ACT S DIC="^PSD(58.8,PSALOC,1,PSADRG,4,",DIC(0)="L",(X,DINUM)=PSAT,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8
"RTN","PSAREC1",35,0)
 F  L +^PSD(58.8,PSALOC,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAREC1",36,0)
 D ^DIC
"RTN","PSAREC1",37,0)
 L -^PSD(58.8,PSALOC,0) K DA,DIC,DINUM,DLAYGO
"RTN","PSAREC1",38,0)
 ;
"RTN","PSAREC1",39,0)
50 S (PSATDRG,PSA)=0 F  S PSA=$O(^PSD(58.8,"C",PSADRG,PSA)) Q:'PSA  D
"RTN","PSAREC1",40,0)
 .I PSA=PSALOC Q:PSACBAL<0  S PSATDRG=PSATDRG+PSACBAL Q
"RTN","PSAREC1",41,0)
 .I +$G(^PSD(58.8,PSA,"I")),+^PSD(58.8,PSA,"I")'>DT Q
"RTN","PSAREC1",42,0)
 .Q:$P($G(^PSD(58.8,PSA,0)),"^",2)'="M"&($P($G(^PSD(58.8,PSA,0)),"^",2)'="P")
"RTN","PSAREC1",43,0)
 .S PSATDRG=PSATDRG+$P($G(^PSD(58.8,PSA,1,PSADRG,0)),"^",4)
"RTN","PSAREC1",44,0)
 S PSANODE=$G(^PSDRUG(PSADRG,660))
"RTN","PSAREC1",45,0)
 I PSACBAL>0!(PSATDRG>0) D
"RTN","PSAREC1",46,0)
 .S PSACOST=PSACOST+(PSATDRG*+$P(PSANODE,"^",6)),PSATDRG=PSAREC+PSATDRG,PSANPDU=+$J((PSACOST/PSATDRG),0,3),PSANPOU=PSANPDU*PSADUOU
"RTN","PSAREC1",47,0)
 .S PSALEN=$L($P(PSANPOU,".")),PSANPOU=$J(PSANPOU,(PSALEN+3),2)
"RTN","PSAREC1",48,0)
 E  S PSATDRG=PSATDRG+PSACBAL,PSANPOU=PSAPOU,PSANPDU=PSAPDU
"RTN","PSAREC1",49,0)
 S DIE="^PSDRUG(",DA=PSADRG,DR="50////^S X="_(PSAREC+$G(^PSDRUG(PSADRG,660.1)))
"RTN","PSAREC1",50,0)
 F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAREC1",51,0)
 D ^DIE L -^PSDRUG(DA,0) K DIE,DA
"RTN","PSAREC1",52,0)
 S PSAODASH=$P($G(^PSDRUG(PSADRG,2)),"^",2)
"RTN","PSAREC1",53,0)
 S PSAONDC=$S(PSAODASH'="":$E("000000",1,(6-$L($P(PSAODASH,"-"))))_$P(PSAODASH,"-")_$E("0000",1,(4-$L($P(PSAODASH,"-",2))))_$P(PSAODASH,"-",2)_$E("00",1,(2-$L($P(PSAODASH,"-",3))))_$P(PSAODASH,"-",3),1:"")
"RTN","PSAREC1",54,0)
 I +PSANPDU=+$P(PSANODE,"^",6),PSANDC=PSAONDC,PSANDC'="" G NEXT
"RTN","PSAREC1",55,0)
 I ($P(PSANODE,"^",2)=PSAOU&($P(PSANODE,"^",5)=PSADUOU))!('$P(PSANODE,"^",2)&('$P(PSANODE,"^",5))) D
"RTN","PSAREC1",56,0)
 .I PSANDC'="",PSANDC'=PSAONDC D
"RTN","PSAREC1",57,0)
 ..S DIE="^PSDRUG(",DA=PSADRG,DR="31////^S X=PSADASH"
"RTN","PSAREC1",58,0)
 ..F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAREC1",59,0)
 ..D ^DIE L -^PSDRUG(DA,0) K DIE,DA
"RTN","PSAREC1",60,0)
 .I +PSANPDU,+PSANPDU'=+$P(PSANODE,"^",6),+PSANPOU D
"RTN","PSAREC1",61,0)
 ..S DIE="^PSDRUG(",DA=PSADRG,DR="13///^S X="_PSANPOU
"RTN","PSAREC1",62,0)
 ..F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAREC1",63,0)
 ..D ^DIE L -^PSDRUG(DA,0) K DIE,DA
"RTN","PSAREC1",64,0)
 .I '$P(PSANODE,"^",2),'$P(PSANODE,"^",5),PSAOU,PSADUOU D
"RTN","PSAREC1",65,0)
 ..S DIE="^PSDRUG(",DA=PSADRG,DR="12////^S X=PSAOU;15////^S X=PSADUOU"
"RTN","PSAREC1",66,0)
 ..F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAREC1",67,0)
 ..D ^DIE L -^PSDRUG(DA,0) K DIE,DA
"RTN","PSAREC1",68,0)
NEXT Q:$G(PSANDC)=""
"RTN","PSAREC1",69,0)
SYNONYM D PSANDC1^PSAHELP S PSADASH=PSANDCX K PSANDCX
"RTN","PSAREC1",70,0)
 S PSA50SYN=+$O(^PSDRUG("C",PSANDC,PSADRG,0))
"RTN","PSAREC1",71,0)
 K DA,DR S:'$D(^PSDRUG(PSADRG,1,0)) DIC("P")=$P(^DD(50,9,0),"^",2)
"RTN","PSAREC1",72,0)
 S DA(1)=PSADRG
"RTN","PSAREC1",73,0)
 I 'PSA50SYN!(PSA50SYN&('$D(^PSDRUG(PSADRG,1,PSA50SYN,0)))) D  Q:Y<0
"RTN","PSAREC1",74,0)
 .S DIC="^PSDRUG("_DA(1)_",1,",DIC(0)="LM",X=PSANDC,DLAYGO=50
"RTN","PSAREC1",75,0)
 .F  L +^PSDRUG(PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAREC1",76,0)
 .D ^DIC L -^PSDRUG(PSADRG,0) K DIC,DLAYGO S PSA50SYN=+Y
"RTN","PSAREC1",77,0)
 S DA=PSA50SYN,DIE="^PSDRUG("_DA(1)_",1,"
"RTN","PSAREC1",78,0)
 S DR="2////^S X=PSADASH;1////D"_$S(+PSAOU:";401////^S X=PSAOU",1:"")_$S(+PSAPOU:";402////^S X=PSAPOU",1:"")_";403////^S X=PSADUOU"_$S(+$G(PSAPDU):";404////^S X=PSAPDU",1:"")_$S(PSAVEND'="":";405///^S X=PSAVEND",1:"")
"RTN","PSAREC1",79,0)
 F  L +^PSDRUG(PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAREC1",80,0)
 D ^DIE L -^PSDRUG(PSADRG,0)
"RTN","PSAREC1",81,0)
 K DIE,DR
"RTN","PSAREC1",82,0)
 Q
"RTN","PSAREC1",83,0)
PRICEHLP ;Extended help for price per order unit
"RTN","PSAREC1",84,0)
 W !?5,"Enter the cost for each order unit."
"RTN","PSAREC1",85,0)
 Q
"RTN","PSARWS")
0^19^B17261058^B16948588
"RTN","PSARWS",1,0)
PSARWS ;BIR/LTL,JMB-Collects Ward Stock Data ;7/23/97
"RTN","PSARWS",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,64**; 10/24/97;Build 4
"RTN","PSARWS",3,0)
 ;This routine gathers AR/WS dispensing data. It is called by PSGWUAS.
"RTN","PSARWS",4,0)
 ;
"RTN","PSARWS",5,0)
 N D0,DR,DA,DIC,DIE,DLAYGO,PSA,PSAB,PSAD,PSADT,PSASIT,PSAT,PSADRUG,PSALOC,PSAQTY,PSADA,PSADAL,PSAPS,X,Y S (PSAPS,PSA)=0,PSADA=""
"RTN","PSARWS",6,0)
 ;get date dispensed,site(aou),drug,qty
"RTN","PSARWS",7,0)
 F  S PSA=$O(^PSI(58.5,"AMIS",PSA)),(PSADT,PSA(1),PSASIT,PSADRUG,PSAQTY)="" Q:'PSA  S PSADT=$O(^PSI(58.5,"AMIS",PSA,PSADT)) Q:'PSADT  S PSA(1)=$O(^PSI(58.5,"AMIS",PSA,PSADT,PSA(1))) Q:PSA(1)']""  D
"RTN","PSARWS",8,0)
 .S PSASIT=$O(^PSI(58.5,"AMIS",PSA,PSADT,PSA(1),PSASIT)) Q:'PSASIT!('$P($G(^PS(59.4,+$G(^PSI(58.1,+PSASIT,"SITE")),0)),U,26))  S PSASIT(1)=$G(^PSI(58.1,PSASIT,"SITE"))
"RTN","PSARWS",9,0)
 .S PSADRUG=$O(^PSI(58.5,"AMIS",PSA,PSADT,PSA(1),PSASIT,PSADRUG))
"RTN","PSARWS",10,0)
 .;drug stocked by any primary DA location?
"RTN","PSARWS",11,0)
 .Q:'PSADRUG!('$O(^PSD(58.8,"C",+PSADRUG,0)))
"RTN","PSARWS",12,0)
 .S (PSAPS,PSADA)=0
"RTN","PSARWS",13,0)
 .;If the location is active, the drug is tracked, & it is tracked in an
"RTN","PSARWS",14,0)
 .;inpatient site, set the PSADA(PSAPS) array.
"RTN","PSARWS",15,0)
 .F  S PSADA=$O(^PSD(58.8,"C",+PSADRUG,PSADA)) Q:'PSADA  I $G(^PSD(58.8,+PSADA,"I"))="",$P($G(^PSD(58.8,+PSADA,0)),U,2)="P",+$P($G(^PSD(58.8,+PSADA,0)),U,3) S PSAPS=PSAPS+1,PSADA(PSAPS)=PSADA
"RTN","PSARWS",16,0)
 .Q:'PSAPS
"RTN","PSARWS",17,0)
 .S PSAQTY=$O(^PSI(58.5,"AMIS",PSA,PSADT,PSA(1),PSASIT,PSADRUG,0))
"RTN","PSARWS",18,0)
 .S:PSA(1)="R" PSAQTY=-PSAQTY
"RTN","PSARWS",19,0)
 .;drug stocked by only one DA location
"RTN","PSARWS",20,0)
 .I PSAPS=1 S ^TMP("PSAR",$J,PSADRUG,PSADA(PSAPS))=PSAQTY+$G(^TMP("PSAR",$J,PSADRUG,PSADA(PSAPS))) Q
"RTN","PSARWS",21,0)
 .;more than one, check site
"RTN","PSARWS",22,0)
 .;
"RTN","PSARWS",23,0)
 .;Dave B (PSA*3*3)
"RTN","PSARWS",24,0)
 .S (PSAPS,PSAPS(1))=0 F  S PSAPS(1)=$O(PSADA(PSAPS(1))) Q:'PSAPS(1)  S PSADA=PSADA(PSAPS(1)) I $D(^PSD(58.8,"ASITE",+PSASIT(1),"P",PSADA)) S ^TMP("PSAR",$J,PSADRUG,PSADA)=PSAQTY+$G(^TMP("PSAR",$J,PSADRUG,PSADA))
"RTN","PSARWS",25,0)
COUNT G:'$O(^TMP("PSAR",$J,"")) END S PSAPS(1)=0
"RTN","PSARWS",26,0)
 F PSA=0:1 S PSA=$O(^TMP("PSAR",$J,PSA)) Q:'PSA  S PSAPS(1)=$G(PSAPS(1))+1
"RTN","PSARWS",27,0)
 ;get transaction numbers
"RTN","PSARWS",28,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSARWS",29,0)
FIND S PSAD=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSAD)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSARWS",30,0)
 S PSAT=PSAD,DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(PSA,PSA(1))=""
"RTN","PSARWS",31,0)
 F PSAD=PSAT:1:(PSAT+PSAPS(1)-1) S (DINUM,X)=PSAD D ^DIC
"RTN","PSARWS",32,0)
 L -^PSD(58.81,0) K DIC,DINUM,DLAYGO
"RTN","PSARWS",33,0)
 ;loop thru array
"RTN","PSARWS",34,0)
 F  S PSA=$O(^TMP("PSAR",$J,PSA)) Q:'PSA  D
"RTN","PSARWS",35,0)
 .S PSALOC=$O(^TMP("PSAR",$J,PSA,0))
"RTN","PSARWS",36,0)
 .S PSAB(1)=$G(^TMP("PSAR",$J,PSA,PSALOC))
"RTN","PSARWS",37,0)
 .;get date + current balance + update balance
"RTN","PSARWS",38,0)
 .F  L +^PSD(58.8,+PSALOC,1,+PSA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSARWS",39,0)
 .D NOW^%DTC
"RTN","PSARWS",40,0)
 .S PSADT=+$E(%,1,12),PSAB=+$P($G(^PSD(58.8,+PSALOC,1,+PSA,0)),U,4),$P(^PSD(58.8,+PSALOC,1,+PSA,0),U,4)=PSAB-PSAB(1) K %
"RTN","PSARWS",41,0)
 .L -^PSD(58.8,+PSALOC,1,+PSA,0)
"RTN","PSARWS",42,0)
 .;update monthly activity multiple
"RTN","PSARWS",43,0)
 .S:'$D(^PSD(58.8,+PSALOC,1,+PSA,5,0)) ^(0)="^58.801A^^"
"RTN","PSARWS",44,0)
 .I '$D(^PSD(58.8,+PSALOC,1,+PSA,5,$E(DT,1,5)*100,0)) D
"RTN","PSARWS",45,0)
 ..S DIC="^PSD(58.8,+PSALOC,1,+PSA,5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSAB)",(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSA,DLAYGO=58.8 D ^DIC K DIC("DR"),DINUM,DLAYGO
"RTN","PSARWS",46,0)
 ..S X="T-1M" D ^%DT S (X,DINUM)=$E(Y,1,5)*100 D ^DIC K DINUM
"RTN","PSARWS",47,0)
 ..S DIE=DIC,DA=+Y,DR="3////^S X=$G(PSAB)" D ^DIE K DIE,DA
"RTN","PSARWS",48,0)
 .S DIE="^PSD(58.8,+PSALOC,1,+PSA,5,",DA(2)=PSALOC,DA(1)=PSA
"RTN","PSARWS",49,0)
 .S DA=$E(DT,1,5)*100,DR="9////^S X=$P($G(^PSD(58.8,+PSALOC,1,+PSA,5,+$E(DT,1,5)*100,0)),U,6)+PSAB(1)"
"RTN","PSARWS",50,0)
 .D ^DIE K DIE,DA
"RTN","PSARWS",51,0)
 .;update transaction
"RTN","PSARWS",52,0)
 .S DIE="^PSD(58.81,",DR="1////2;2////^S X=PSALOC;3///^S X=PSADT;4////^S X=PSA;5////^S X=$G(PSAB(1));9////^S X=PSAB",DA=PSAT
"RTN","PSARWS",53,0)
 .D ^DIE
"RTN","PSARWS",54,0)
 .S:'$D(^PSD(58.8,+PSALOC,1,+PSA,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSARWS",55,0)
 .S DIC="^PSD(58.8,+PSALOC,1,+PSA,4,",DIC(0)="L",(X,DINUM)=PSAT,DA(2)=PSALOC,DA(1)=PSA,DLAYGO=58.8 D ^DIC K DA,DIC,DINUM,DLAYGO S PSAT=PSAT+1
"RTN","PSARWS",56,0)
END K ^TMP("PSAR",$J)
"RTN","PSARWS",57,0)
 Q
"RTN","PSATRAN1")
0^20^B21031652^B20498296
"RTN","PSATRAN1",1,0)
PSATRAN1 ;BIR/JMB-Transfer Drugs between Pharmacies - CONT'D ;7/23/97
"RTN","PSATRAN1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**64**; 10/24/97;Build 4
"RTN","PSATRAN1",3,0)
 ;This routine updates the dispensing and receiving locations. The drug
"RTN","PSATRAN1",4,0)
 ;balance & monthly activity are updated. It creates an activity in 58.8,
"RTN","PSATRAN1",5,0)
 ;a transaction in 58.81, sends a mail message if the drug is new to the
"RTN","PSATRAN1",6,0)
 ;receiving location, and stores the data so the signature sheet can
"RTN","PSATRAN1",7,0)
 ;print. It is called by PSATRAN.
"RTN","PSATRAN1",8,0)
 ;
"RTN","PSATRAN1",9,0)
UPDATE ;update location balances
"RTN","PSATRAN1",10,0)
 D CHK Q:PSALES  W !!,"Updating pharmacy on-hand balances now..."
"RTN","PSATRAN1",11,0)
 S (PSATODA,PSAFRDA)=0
"RTN","PSATRAN1",12,0)
 F PSALCNT=1:1:2 D CALC
"RTN","PSATRAN1",13,0)
 I PSATODA,PSAFRDA D
"RTN","PSATRAN1",14,0)
 .S DIE="^PSD(58.81,",DA=PSATODA,DR="16///^S X=PSAFRDA"
"RTN","PSATRAN1",15,0)
 .F  L +^PSD(58.81,DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSATRAN1",16,0)
 .D ^DIE L -^PSD(58.81,DA,0) K DA
"RTN","PSATRAN1",17,0)
 .S DA=PSAFRDA,DR="16///^S X=PSATODA"
"RTN","PSATRAN1",18,0)
 .F  L +^PSD(58.81,DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSATRAN1",19,0)
 .D ^DIE L -^PSD(58.81,DA,0) K DA,DIE
"RTN","PSATRAN1",20,0)
 W !,"Done!" H 1 S ^TMP("PSASIG",$J,+PSAFROM,+PSATO,PSAFRDA)=""
"RTN","PSATRAN1",21,0)
 D:PSADD MSG I 'PSADD H 1
"RTN","PSATRAN1",22,0)
 S (PSADD,PSAOUT)=0
"RTN","PSATRAN1",23,0)
 Q
"RTN","PSATRAN1",24,0)
CALC ;sub/add qty from dsp sites
"RTN","PSATRAN1",25,0)
 W "." S PSATEMP=+$S(PSALCNT=1:PSAFROM,1:PSATO),PSATQTY=-PSATQTY
"RTN","PSATRAN1",26,0)
 F  L +^PSD(58.8,PSATEMP,1,PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSATRAN1",27,0)
 D NOW^%DTC S PSADT=+%
"RTN","PSATRAN1",28,0)
 S PSABAL(PSALCNT)=$P(^PSD(58.8,PSATEMP,1,PSADRG,0),"^",4),$P(^(0),"^",4)=$P(^(0),"^",4)+PSATQTY,$P(PSABAL(PSALCNT),"^",2)=(+PSABAL(PSALCNT)+PSATQTY)
"RTN","PSATRAN1",29,0)
 L -^PSD(58.8,PSATEMP,1,PSADRG,0)
"RTN","PSATRAN1",30,0)
ADD ;find entry number
"RTN","PSATRAN1",31,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSATRAN1",32,0)
FIND S PSAREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAREC)) S $P(^PSD(58.81,0),"^",3)=PSAREC G FIND
"RTN","PSATRAN1",33,0)
 K DIC,DLAYGO S DIC(0)="L",DIC="^PSD(58.81,",DLAYGO=58.81,(X,DINUM)=PSAREC D ^DIC K DIC,DINUM,DLAYGO
"RTN","PSATRAN1",34,0)
 L -^PSD(58.81,0) W "."
"RTN","PSATRAN1",35,0)
 S:PSALCNT=1 PSAFRDA=PSAREC S:PSALCNT=2 PSATODA=PSAREC
"RTN","PSATRAN1",36,0)
TRANS ;update transaction data
"RTN","PSATRAN1",37,0)
 K DA,DIE,DR S DA=PSAREC,DIE=58.81
"RTN","PSATRAN1",38,0)
 S DR="1////24;2////"_PSATEMP_";4////"_PSADRG_";3////"_PSADT_";5////"_PSATQTY_";6////"_PSADUZ_";9////"_$P(PSABAL(PSALCNT),"^")
"RTN","PSATRAN1",39,0)
 D ^DIE K DA,DIE,DR W "."
"RTN","PSATRAN1",40,0)
ACT ;update location drug info
"RTN","PSATRAN1",41,0)
 S:'$D(^PSD(58.8,PSATEMP,1,PSADRG,4,0)) ^PSD(58.8,PSATEMP,1,PSADRG,4,0)="^58.800119PA^^"
"RTN","PSATRAN1",42,0)
 I '$D(^PSD(58.8,PSATEMP,1,PSADRG,4,PSAREC,0)) K DA,DD,DO S DIC(0)="L",DIC="^PSD(58.8,"_PSATEMP_",1,"_PSADRG_",4,",DA(2)=PSATEMP,DA(1)=PSADRG,(X,DINUM)=PSAREC D ^DIC K DA,DIC,DINUM W "."
"RTN","PSATRAN1",43,0)
MON ;update monthly activity node
"RTN","PSATRAN1",44,0)
 S:'$D(^PSD(58.8,PSATEMP,1,PSADRG,5,0)) ^(0)="^58.801A^^"
"RTN","PSATRAN1",45,0)
 I '$D(^PSD(58.8,PSATEMP,1,PSADRG,5,$E(PSADT,1,5)*100,0)) D
"RTN","PSATRAN1",46,0)
 .S DIC="^PSD(58.8,"_PSATEMP_",1,"_PSADRG_",5,",DIC(0)="LM"
"RTN","PSATRAN1",47,0)
 .S DA(2)=PSATEMP,DA(1)=PSADRG,(X,DINUM)=($E(PSADT,1,5)*100),DLAYGO=58.8 D ^DIC K DIC,DINUM,DLAYGO W "." S DA=+Y
"RTN","PSATRAN1",48,0)
 .S DIE="^PSD(58.8,"_PSATEMP_",1,"_PSADRG_",5,",DA(2)=PSATEMP,DA(1)=PSADRG,DR="1////^S X="_+PSABAL(PSALCNT) D ^DIE K DIE
"RTN","PSATRAN1",49,0)
 .S X="T-1M" D ^%DT
"RTN","PSATRAN1",50,0)
 .S DIC="^PSD(58.8,"_PSATEMP_",1,"_PSADRG_",5,",DIC(0)="LM",DA(2)=PSATEMP,DA(1)=PSADRG,(X,DINUM)=($E(Y,1,5)*100),DLAYGO=58.8 D ^DIC K DINUM,DLAYGO
"RTN","PSATRAN1",51,0)
 ;.S DIE=DIC,DR="3////^S X="_($P($G(^PSD(58.8,PSATEMP,1,PSADRG,0)),"^",4)-PSATQTY) K DIC D ^DIE K DA,DIE W "."
"RTN","PSATRAN1",52,0)
 S DA=($E(PSADT,1,5)*100),PSANODE=$G(^PSD(58.8,PSATEMP,1,PSADRG,5,DA,0)) Q:'$D(PSANODE)
"RTN","PSATRAN1",53,0)
 S PSAREC=$P(PSANODE,"^",3),PSADJ=$P(PSANODE,"^",5),PSADISP=$P(PSANODE,"^",6),PSARET=$P(PSANODE,"^",7),PSATF=$P(PSANODE,"^",9)+PSATQTY
"RTN","PSATRAN1",54,0)
 S PSABAL=$P(PSANODE,"^",2)+PSAREC+PSADJ-PSADISP+PSARET+PSATF
"RTN","PSATRAN1",55,0)
 S DIE="^PSD(58.8,"_PSATEMP_",1,"_PSADRG_",5,",DA(2)=PSATEMP,DA(1)=PSADRG
"RTN","PSATRAN1",56,0)
 S DR="13////^S X="_($P($G(^PSD(58.8,PSATEMP,1,PSADRG,5,DA,0)),"^",9)+PSATQTY)_";3////^S X="_PSABAL
"RTN","PSATRAN1",57,0)
 D ^DIE K DA,DIE W "."
"RTN","PSATRAN1",58,0)
 Q
"RTN","PSATRAN1",59,0)
CHK ;check for valid bal
"RTN","PSATRAN1",60,0)
 S PSALES=0 D:PSATQTY>$P(^PSD(58.8,PSAFROM,1,PSADRG,0),"^",4)
"RTN","PSATRAN1",61,0)
 .W $C(7),!!,"=>   The drug balance is "_+$P(^PSD(58.8,PSAFROM,1,PSADRG,0),"^",4)_".  You cannot transfer "_PSATQTY_" for this drug.",! S PSALES=1
"RTN","PSATRAN1",62,0)
 .W "No action taken.",!
"RTN","PSATRAN1",63,0)
 Q
"RTN","PSATRAN1",64,0)
MSG ;send mailman message with transfer info
"RTN","PSATRAN1",65,0)
 K XMY,^TMP("PSATRAN",$J)
"RTN","PSATRAN1",66,0)
 S ^TMP("PSATRAN",$J,1,0)="Drug: "_PSADRGN
"RTN","PSATRAN1",67,0)
 S ^TMP("PSATRAN",$J,2,0)="Quantity  : "_PSATQTY_" ("_PSADU_")",^TMP("PSATRAN",$J,3,0)="Pharmacist: "_PSADUZN,^TMP("PSATRAN",$J,4,0)=" "
"RTN","PSATRAN1",68,0)
 S ^TMP("PSATRAN",$J,5,0)="Transferred from:",^TMP("PSATRAN",$J,6,0)=PSAFROMN,^TMP("PSATRAN",$J,7,0)=" "
"RTN","PSATRAN1",69,0)
 S ^TMP("PSATRAN",$J,8,0)="Transferred and Added to:",^TMP("PSATRAN",$J,9,0)=PSATON
"RTN","PSATRAN1",70,0)
 S XMSUB="Drug Transfer Between Pharmacies",XMTEXT="^TMP(""PSATRAN"",$J,",XMDUZ="Drug Accountability System"
"RTN","PSATRAN1",71,0)
 F PSAJJ=0:0 S PSAJJ=$O(^XUSEC("PSAMGR",PSAJJ)) Q:'PSAJJ  S XMY(PSAJJ)=""
"RTN","PSATRAN1",72,0)
 G:'$D(XMY) QUIT D ^XMD
"RTN","PSATRAN1",73,0)
QUIT K XMY,^TMP("PSATRAN",$J)
"RTN","PSATRAN1",74,0)
 Q
"RTN","PSAUDP")
0^21^B16486615^B16331334
"RTN","PSAUDP",1,0)
PSAUDP ;BIR/LTL,JMB-Nightly Background Job - CONT'D ;7/23/97
"RTN","PSAUDP",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**6,3,12,14,25,64**; 10/24/97;Build 4
"RTN","PSAUDP",3,0)
 ;
"RTN","PSAUDP",4,0)
 ;Reference to ^PS(57.6 are covered by IA #772
"RTN","PSAUDP",5,0)
PICKLST ;ask for parameters PSA*3*25
"RTN","PSAUDP",6,0)
 I '$D(^PSD(58.812,1,"T","B","UNIT DOSE"))!('$D(^PSD(58.812,1,"T"))) D
"RTN","PSAUDP",7,0)
 .S ^PSD(58.812,1,"T",0)="^58.8123A^1^1"
"RTN","PSAUDP",8,0)
 .S X="T-2W" D ^%DT S ^PSD(58.812,1,"T",1,0)="UNIT DOSE^"_Y_"^",X="T-1W" D ^%DT S $P(^PSD(58.812,1,"T",1,0),"^",3)=Y K X,Y
"RTN","PSAUDP",9,0)
 .S ^PSD(58.812,1,"T","B","UNIT DOSE",1)=""
"RTN","PSAUDP",10,0)
 S XX=$O(^PSD(58.812,1,"T","B","UNIT DOSE",0)) Q:XX'>0  S JOBIEN=XX D NOW^%DTC S STRTDATE=%,PARDATA=$G(^PSD(58.812,1,"T",JOBIEN,0))
"RTN","PSAUDP",11,0)
 S PSABGN=$P(PARDATA,"^",2),PSAEND=$P(PARDATA,"^",3)
"RTN","PSAUDP",12,0)
 S X="T-7" D ^%DT I Y'=PSAEND G DONE
"RTN","PSAUDP",13,0)
 S $P(^PSD(58.812,1,"T",JOBIEN,0),"^",2)=PSAEND,X1=PSAEND,X2=7 D C^%DTC S $P(^PSD(58.812,1,"T",JOBIEN,0),"^",3)=X ;Reset date parameters
"RTN","PSAUDP",14,0)
 ;Go back two weeks, gather 1 weeks worth of data
"RTN","PSAUDP",15,0)
 S PSAD0=PSABGN-.000001
"RTN","PSAUDP",16,0)
 S PSAEND=PSAEND_".2359"
"RTN","PSAUDP",17,0)
DATE ;Loop through dates
"RTN","PSAUDP",18,0)
 S PSAD0=$O(^PS(57.6,PSAD0)) G DONE:PSAD0'>0 G DONE:PSAD0>PSAEND K PSAD1
"RTN","PSAUDP",19,0)
WRD S PSAD1=$S('$D(PSAD1):$O(^PS(57.6,PSAD0,1,0)),1:$O(^PS(57.6,PSAD0,1,PSAD1))) G DATE:PSAD1'>0 K PSAD2
"RTN","PSAUDP",20,0)
PVDR ;Loop through providers
"RTN","PSAUDP",21,0)
 S PSAD2=$S('$D(PSAD2):$O(^PS(57.6,PSAD0,1,PSAD1,1,0)),1:$O(^PS(57.6,PSAD0,1,PSAD1,1,PSAD2))) G WRD:PSAD2'>0 K PSAD3
"RTN","PSAUDP",22,0)
DRG S PSAD3=$S('$D(PSAD3):$O(^PS(57.6,PSAD0,1,PSAD1,1,PSAD2,1,0)),1:$O(^PS(57.6,PSAD0,1,PSAD1,1,PSAD2,1,PSAD3))) G PVDR:PSAD3'>0 S DATA=$G(^PS(57.6,PSAD0,1,PSAD1,1,PSAD2,1,PSAD3,0))
"RTN","PSAUDP",23,0)
 S PSAIP=PSAD1,PSA50=PSAD3,PSADT=PSAD0 K PSALOC
"RTN","PSAUDP",24,0)
LOC S PSALOC=$S('$D(PSALOC):$O(^PSD(58.8,"AB",PSAD1,0)),1:$O(^PSD(58.8,"AB",PSAD1,PSALOC))) G DRG:PSALOC'>0 I $D(^PSD(58.8,PSALOC,"I")),$P($G(^PSD(58.8,PSALOC,"I")),"^")'>DT G LOC
"RTN","PSAUDP",25,0)
 S PSAQTY=$P($G(DATA),"^",2)-$P($G(DATA),"^",4)
"RTN","PSAUDP",26,0)
 I $D(^PSD(58.8,PSALOC,1,PSA50)) D PROCESS
"RTN","PSAUDP",27,0)
 G LOC
"RTN","PSAUDP",28,0)
 ;
"RTN","PSAUDP",29,0)
 Q
"RTN","PSAUDP",30,0)
DONE ;
"RTN","PSAUDP",31,0)
END K DA,DATA,DIC,DIE,DR,PSA50,PSAD0,PSAD1,PSAD2,PSAD3,PSADT,PSAIP,PSALOC,PSANUM,PSAQTY,X,Y,PSABGN,PSAEND,PARDATA,JOBIEN,X
"RTN","PSAUDP",32,0)
 Q
"RTN","PSAUDP",33,0)
PROCESS ;Stuff last UD dispensing fld with DT
"RTN","PSAUDP",34,0)
 F  L +^PSD(58.8,PSALOC,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAUDP",35,0)
 S DIE="^PSD(58.8,",DA=PSALOC,DR="27////"_PSADT D ^DIE K DIE,DA,DR
"RTN","PSAUDP",36,0)
 ;Subtract dispensing from balance
"RTN","PSAUDP",37,0)
 S PSABAL=$P($G(^PSD(58.8,PSALOC,1,PSA50,0)),"^",4)
"RTN","PSAUDP",38,0)
 S $P(^PSD(58.8,PSALOC,1,PSA50,0),"^",4)=PSABAL-$G(PSAQTY)
"RTN","PSAUDP",39,0)
 ;If no monthly activity node, add node with beginning balance.
"RTN","PSAUDP",40,0)
 I '$D(^PSD(58.8,PSALOC,1,PSA50,5,+$E(PSADT,1,5)*100,0)) D
"RTN","PSAUDP",41,0)
 .S DIC="^PSD(58.8,PSALOC,1,PSA50,5,",DIC(0)="L",DIC("P")=$P(^DD(58.8001,20,0),U,2),(X,DINUM)=$E(PSADT,1,5)*100,DA(2)=PSALOC,DA(1)=PSA50
"RTN","PSAUDP",42,0)
 .S DIC("DR")="1////^S X=$G(PSABAL)",DLAYGO=58.8 D ^DIC K DIC,DLAYGO
"RTN","PSAUDP",43,0)
 .;Add current month's node and stuff beginning & ending balance.
"RTN","PSAUDP",44,0)
 .S DIC="^PSD(58.8,PSALOC,1,PSA50,5,",DIC(0)="L",(X,DINUM)=$E(PSADT-100-(+$E(PSADT,4,5)=1*8800),1,5)*100,DA(2)=PSALOC,DA(1)=PSA50,DLAYGO=58.8 D ^DIC K DIC,DLAYGO S DA=+Y
"RTN","PSAUDP",45,0)
 .S DIE="^PSD(58.8,PSALOC,1,PSA50,5,",DA(2)=PSALOC,DA(1)=PSA50,DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAUDP",46,0)
 ;Stuff total dispensed
"RTN","PSAUDP",47,0)
 S DIE="^PSD(58.8,PSALOC,1,PSA50,5,",DA(2)=PSALOC,DA(1)=PSA50,DA=$E(PSADT,1,5)*100,DR="9////^S X=$P($G(^(0)),U,6)+PSAQTY" D ^DIE K DIE,DA
"RTN","PSAUDP",48,0)
 ;Get next transaction node number
"RTN","PSAUDP",49,0)
FIND S PSANUM=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSANUM)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSAUDP",50,0)
 ;Add next transaction node with data.
"RTN","PSAUDP",51,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSANUM D ^DIC K DIC,DLAYGO
"RTN","PSAUDP",52,0)
 S DIE="^PSD(58.81,",DA=PSANUM
"RTN","PSAUDP",53,0)
 S DR="1////2;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSA50;5////^S X=PSAQTY;9////^S X=$G(PSABAL)" D ^DIE K DIE,DA
"RTN","PSAUDP",54,0)
 ;Add activity node
"RTN","PSAUDP",55,0)
 S DIC="^PSD(58.8,PSALOC,1,PSA50,4,",DIC(0)="L",(X,DINUM)=PSANUM,DIC("P")=$P(^DD(58.8001,19,0),"^",2),DA(2)=PSALOC,DA(1)=PSA50,DLAYGO=58.8 D ^DIC K DA,DIC,DLAYGO
"RTN","PSAUDP",56,0)
 L -^PSD(58.8,PSALOC,0)
"RTN","PSAUDP",57,0)
 Q
"RTN","PSAVER2")
0^23^B49116158^B48168766
"RTN","PSAVER2",1,0)
PSAVER2 ;BIR/JMB-Verify Invoices - CONT'D ;10/7/97
"RTN","PSAVER2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,12,21,60,64**; 10/24/97;Build 4
"RTN","PSAVER2",3,0)
 ;This routine contains the prompts for the fields that the verifier
"RTN","PSAVER2",4,0)
 ;is allowed to edit.
"RTN","PSAVER2",5,0)
 ;
"RTN","PSAVER2",6,0)
 ;References to ^DIC(51.5, are covered by IA #1931
"RTN","PSAVER2",7,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER2",8,0)
 ;References to ^PSDRUG("C" are covered by IA #2095
"RTN","PSAVER2",9,0)
 ;
"RTN","PSAVER2",10,0)
ASKDRUG W !,"If the item will never be in the DRUG, press the Return key then",!,"answer YES to the ""Is this a supply item?"" prompt. To bypass this",!,"line item, enter ""^"" then press the Return key.",!
"RTN","PSAVER2",11,0)
 S PSAGAIN=0,PSABEFOR=PSADRG,DIC(0)="AEMQZ",DIC="^PSDRUG(" D ^DIC K DIC
"RTN","PSAVER2",12,0)
 I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER2",13,0)
 S PSADJFLD="D",PSAREA="",PSASUPP=0
"RTN","PSAVER2",14,0)
 I +Y=-1 D  Q:PSASUPP!(PSAOUT)
"RTN","PSAVER2",15,0)
 .S PSAVER=1 D SUPPLY^PSANDF Q:PSAOUT  I 'PSASUPP S PSAGAIN=1 Q
"RTN","PSAVER2",16,0)
 .S PSA50IEN=0,PSADJ=PSAREA,PSAREA="" K ^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)
"RTN","PSAVER2",17,0)
 .D RECORD
"RTN","PSAVER2",18,0)
 G:$G(PSAGAIN) ASKDRUG
"RTN","PSAVER2",19,0)
 S (PSA50IEN,PSADJ,PSADRG)=+Y D RECORD,HDR^PSAVER1,VERDISP^PSAUTL4
"RTN","PSAVER2",20,0)
 I PSANDC'="",$O(^PSDRUG("C",PSANDC,PSA50IEN,0)) D
"RTN","PSAVER2",21,0)
 .S PSASUB=+$O(^PSDRUG("C",PSANDC,PSA50IEN,0)),$P(^PSD(58.811,PSAIEN,1,PSAIEN1,2),"^",3)=PSASUB
"RTN","PSAVER2",22,0)
 .I '+$P($G(^PSDRUG(PSA50IEN,1,PSASUB,0)),"^",7) D DUOU Q
"RTN","PSAVER2",23,0)
 .I +$P($G(^PSDRUG(PSA50IEN,1,PSASUB,0)),"^",7),+$P($G(^PSDRUG(PSA50IEN,1,PSASUB,0)),"^",7)'=+$P($G(^PSDRUG(PSABEFOR,1,PSASUB,0)),"^",7) D DUOU
"RTN","PSAVER2",24,0)
 ;
"RTN","PSAVER2",25,0)
 I PSANDC'="",'$O(^PSDRUG("C",PSANDC,PSA50IEN,0)),PSA50IEN'=PSABEFOR D DUOU
"RTN","PSAVER2",26,0)
 ;
"RTN","PSAVER2",27,0)
 I PSANDC="",PSAUPC="" D
"RTN","PSAVER2",28,0)
 .W !,"The vendor did not send a NDC or UPC for the drug. Enter the",!,"NDC if it is available. Enter the UPC if you do not know the NDC.",!
"RTN","PSAVER2",29,0)
 .S DIR(0)="SA^N:NDC;U:UPC",DIR("A")="Will you enter the NDC or UPC? ",DIR("B")="N",DIR("??")="^D NDCUPC^PSANDF1" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAVER2",30,0)
 .I Y="N" D GETNDC^PSANDF Q:PSAOUT  S PSANDC=Y D:PSANDC'="" ADDDATA
"RTN","PSAVER2",31,0)
 .I Y="U" D GETUPC^PSANDF Q:PSAOUT  S PSANDC="S"_Y,PSAUPC=Y D:PSANDC'="" ADDDATA
"RTN","PSAVER2",32,0)
 Q
"RTN","PSAVER2",33,0)
 ;
"RTN","PSAVER2",34,0)
ADDDATA ;Adds the missing NDC and/or UPC
"RTN","PSAVER2",35,0)
 K DA S DA(2)=PSAIEN,DA(1)=PSAIEN1,DA=PSALINE,DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DR="13///^S X="_PSANDC_$S(PSAUPC'="":";15///^S X="_PSAUPC,1:"")
"RTN","PSAVER2",36,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER2",37,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER2",38,0)
 K DIE I $G(DTOUT)!($G(DUOUT)) S PSAOUT=0 Q
"RTN","PSAVER2",39,0)
 D VERDISP^PSAUTL4
"RTN","PSAVER2",40,0)
 Q
"RTN","PSAVER2",41,0)
RECORD ;Adds adjusted data to DA ORDERS file
"RTN","PSAVER2",42,0)
 S PSANEW=0
"RTN","PSAVER2",43,0)
 I '$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) S ^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)="^58.811259SA^^"
"RTN","PSAVER2",44,0)
 I $D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B",PSADJFLD)) D  Q
"RTN","PSAVER2",45,0)
 .S DA=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B",PSADJFLD,0))
"RTN","PSAVER2",46,0)
 .I '$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0)) D NEW Q
"RTN","PSAVER2",47,0)
 .D ADJ
"RTN","PSAVER2",48,0)
 ;
"RTN","PSAVER2",49,0)
NEW S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) DIC("P")=$P(^DD(58.81125,9,0),"^",2) K DA
"RTN","PSAVER2",50,0)
 S DA(3)=PSAIEN,DA(2)=PSAIEN1,DA(1)=PSALINE,X=PSADJFLD,DIC="^PSD(58.811,"_DA(3)_",1,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811
"RTN","PSAVER2",51,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER2",52,0)
 D ^DIC L -^PSD(58.811,PSAIEN,1,PSAIEN1,0) K DIC,DLAYGO S DA=+Y
"RTN","PSAVER2",53,0)
 ;
"RTN","PSAVER2",54,0)
ADJ S DA(3)=PSAIEN,DA(2)=PSAIEN1,DA(1)=PSALINE,DIE="^PSD(58.811,"_DA(3)_",1,"_DA(2)_",1,"_DA(1)_",1,"
"RTN","PSAVER2",55,0)
 ;
"RTN","PSAVER2",56,0)
 ;PSA*3*3 (DaveB 1JUN98)
"RTN","PSAVER2",57,0)
 S DR="5///^S X=PSADJ"_$S(PSAREA'="":";6////^S X=PSAREA",1:"")_";7///^S X="_DT_";8////^S X="_DUZ  ; *60
"RTN","PSAVER2",58,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER2",59,0)
 D ^DIE
"RTN","PSAVER2",60,0)
INDEX S DIK=DIE D IX1^DIK K DIE,DIK L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER2",61,0)
 Q
"RTN","PSAVER2",62,0)
 ;
"RTN","PSAVER2",63,0)
DUOU ;Gets Dispense Units Per Order Unit
"RTN","PSAVER2",64,0)
 ;DAVE B (PSA*3*12) If PSASUPP is defined, the item is supply
"RTN","PSAVER2",65,0)
 ;no need to ask for dispense units per order unit.
"RTN","PSAVER2",66,0)
 I $G(PSASUPP)=1 W !,"Item appears to be marked for supply, no need to enter Dispense Units Per Order Unit." Q
"RTN","PSAVER2",67,0)
 W !,"DISPENSE UNITS: "_$S($P($G(^PSDRUG(PSA50IEN,660)),"^",8)'="":$P($G(^PSDRUG(PSA50IEN,660)),"^",8),1:"Blank")
"RTN","PSAVER2",68,0)
 S DIR(0)="NO^::2",DIR("A")="DISPENSE UNITS PER ORDER UNIT",DIR("B")=$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^")
"RTN","PSAVER2",69,0)
 S DIR("?")="Enter the number of dispense units contained in one order unit",DIR("??")="^D DUOUHELP^PSAPROC3"
"RTN","PSAVER2",70,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER2",71,0)
 S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2),"^")=+Y S:+Y PSASET=1
"RTN","PSAVER2",72,0)
 Q:Y'=""
"RTN","PSAVER2",73,0)
 ;
"RTN","PSAVER2",74,0)
 W !!,"The dispense units per order unit must be entered",!,"to change the status of the invoice to Verified."
"RTN","PSAVER2",75,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to enter the data now"
"RTN","PSAVER2",76,0)
 S DIR("?",1)="Enter Yes to return to the DISPENSE UNITS PER ORDER UNIT prompt.",DIR("?")="Enter No to bypass entering the dispense units now."
"RTN","PSAVER2",77,0)
 S DIR("??")="^D DUOUYN^PSAPROC8" D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAVER2",78,0)
 W ! G:+Y DUOU
"RTN","PSAVER2",79,0)
 Q
"RTN","PSAVER2",80,0)
 ;
"RTN","PSAVER2",81,0)
OU ;Get order unit
"RTN","PSAVER2",82,0)
 S DIC(0)="QAEMZ",DIC="^DIC(51.5,",DIC("A")="ORDER UNIT: ",DR=.01 S:+PSAOU&($P($G(^DIC(51.5,+PSAOU,0)),"^")'="") DIC("B")=$P(^DIC(51.5,+PSAOU,0),"^") D ^DIC K DIC
"RTN","PSAVER2",83,0)
 I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER2",84,0)
 ;
"RTN","PSAVER2",85,0)
 ;PSA*3*12 Dave B, allow verifier to change OU to original if necessary
"RTN","PSAVER2",86,0)
 G:Y=-1 OU S PSADJFLD="O",PSADJ=+Y,PSAREA="" D RECORD
"RTN","PSAVER2",87,0)
 Q
"RTN","PSAVER2",88,0)
 ;
"RTN","PSAVER2",89,0)
PHARM ;Pharmacy Location/Master Vault -- DR is set prior to the call.
"RTN","PSAVER2",90,0)
 K DA S DA(1)=PSAIEN,DA=PSAIEN1,DIE="^PSD(58.811,"_DA(1)_",1," D ^DIE K DIE
"RTN","PSAVER2",91,0)
 S:$G(DTOUT)!($G(DUOUT)) PSAOUT=1
"RTN","PSAVER2",92,0)
 Q
"RTN","PSAVER2",93,0)
 ;
"RTN","PSAVER2",94,0)
QTY ;Adjust the quantity received
"RTN","PSAVER2",95,0)
 S DIR(0)="N",DIR("A")="QUANTITY RECEIVED",DIR("B")=PSAQTY
"RTN","PSAVER2",96,0)
 S DIR("?",1)="If the quantity received is different than the invoiced or",DIR("?")="adjusted quantity, enter the correct quantity received.",DIR("??")="^D QTYHELP^PSAPROC3"
"RTN","PSAVER2",97,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAVER2",98,0)
 Q:PSAQTY=+Y  S PSADJ=+Y
"RTN","PSAVER2",99,0)
 S DIR(0)="F^1:30",DIR("A")="ADJUSTMENT REASON",DIR("?")="Enter the reason you adjusted the quantity received.",DIR("??")="^D ADJREA^PSAPROC3"
"RTN","PSAVER2",100,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAVER2",101,0)
 S PSADJFLD="Q",PSAREA=Y D RECORD
"RTN","PSAVER2",102,0)
 Q
"RTN","PSAVER2",103,0)
 ;
"RTN","PSAVER2",104,0)
RECD ;Date Received
"RTN","PSAVER2",105,0)
 K PSARECD S PSAREC=$S(+$P(PSAIN,"^",7):+$P(PSAIN,"^",7),+$P(PSAIN,"^",6):+$P(PSAIN,"^",6),1:"")
"RTN","PSAVER2",106,0)
 S DIR(0)="D",DIR("A")="Date received",DIR("?")="Enter the date the drugs were received.",DIR("??")="^D RECHELP^PSAPROC3" S:PSAREC DIR("B")=$$FMTE^XLFDT(PSAREC)
"RTN","PSAVER2",107,0)
 D ^DIR K DIR I $G(DIRUT) S PSAOUT=1 Q
"RTN","PSAVER2",108,0)
 Q:'+$P(PSAIN,"^",7)&(+Y=+$P(PSAIN,"^",6))
"RTN","PSAVER2",109,0)
 Q:+$P(PSAIN,"^",6)'=+$P(PSAIN,"^",7)&(+$P(PSAIN,"^",7)=+Y)
"RTN","PSAVER2",110,0)
 S:+$P(PSAIN,"^",6)=+Y PSARECD="@"
"RTN","PSAVER2",111,0)
 S:+$P(PSAIN,"^",6)'=+Y&(+$P(PSAIN,"^",7)'=+Y) PSARECD=+Y
"RTN","PSAVER2",112,0)
 Q:'$D(PSARECD)  K DA
"RTN","PSAVER2",113,0)
 S DA(1)=PSAIEN,DA=PSAIEN1,DIE="^PSD(58.811,"_DA(1)_",1,",DR="8///"_$S(+PSARECD:"^S X="_PSARECD,1:"@")
"RTN","PSAVER2",114,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER2",115,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER2",116,0)
 K DIE
"RTN","PSAVER2",117,0)
 I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1
"RTN","PSAVER2",118,0)
 Q
"RTN","PSAVER2",119,0)
 ;
"RTN","PSAVER2",120,0)
REORDER ;Enter reorder level for drug if the field is blank.
"RTN","PSAVER2",121,0)
 S DIR(0)="NO^0:99999",DIR("A")="REORDER LEVEL (in Dispense Units)",DIR("??")="^D REORD^PSAPROC8",DIR("B")=+PSAREORD
"RTN","PSAVER2",122,0)
 S DIR("?")="Enter the minimum number of dispense units to keep in the "_$S(+$P(PSADATA,"^",10):"master vault",1:"pharmacy location")_"."
"RTN","PSAVER2",123,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER2",124,0)
 S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2),"^",2)=+Y
"RTN","PSAVER2",125,0)
 Q
"RTN","PSAVER2",126,0)
STOCK ;Enter stock level for drug if the field is blank.
"RTN","PSAVER2",127,0)
 S DIR(0)="NO^0:99999",DIR("A")="STOCK LEVEL (in Dispense Units)",DIR("??")="^D STKLEVEL^PSAPROC8",DIR("B")=+PSASTOCK
"RTN","PSAVER2",128,0)
 S DIR("?")="Enter the ideal number of dispense units to keep on the shelf."
"RTN","PSAVER2",129,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER2",130,0)
 S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2),"^",4)=+Y
"RTN","PSAVER2",131,0)
 Q
"RTN","PSAVER3")
0^24^B71438317^B70683191
"RTN","PSAVER3",1,0)
PSAVER3 ;BIR/JMB-Verify Invoices - CONT'D ;9/5/97
"RTN","PSAVER3",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,19,21,64**; 10/24/97;Build 4
"RTN","PSAVER3",3,0)
 ;This routine checks for verification errors, prints an error report,
"RTN","PSAVER3",4,0)
 ;& changes data in DA ORDERS to verification if there are no errors.
"RTN","PSAVER3",5,0)
 ;
"RTN","PSAVER3",6,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAVER3",7,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER3",8,0)
 ;
"RTN","PSAVER3",9,0)
SETLINE ;Set line as verified if all data is present.
"RTN","PSAVER3",10,0)
 K PSADRG,PSAOU,PSAQTY S (PSADJN,PSADJ)=0
"RTN","PSAVER3",11,0)
 S PSADATA=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVER3",12,0)
 I $O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) D
"RTN","PSAVER3",13,0)
 .S PSAA=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) Q:PSAA=2
"RTN","PSAVER3",14,0)
 .S PSADJ=0 F  S PSADJ=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ)) Q:'PSADJ  D
"RTN","PSAVER3",15,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVER3",16,0)
 ..S PSADJN=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)
"RTN","PSAVER3",17,0)
 ..I $P(PSADJN,"^")="D" D
"RTN","PSAVER3",18,0)
 ...I (+$P(PSADJN,"^",9)&($P(PSADJN,"^",6)'?.N))!('+$P(PSADJN,"^",9)&(+$P(PSADJN,"^",5))&($P(PSADJN,"^",2)'?.N)) S PSASUP=PSASUP+1,PSALNSU=1,PSADRG=0 Q
"RTN","PSAVER3",19,0)
 ...S PSADRG=$S($P(PSADJN,"^",6)'="":$P(PSADJN,"^",6),$P(PSADJN,"^",2)'="":$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",20,0)
 ..I $P(PSADJN,"^")="O" S PSAOU=$S(+$P(PSADJN,"^",6):+$P(PSADJN,"^",6),+$P(PSADJN,"^",2):+$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",21,0)
 ..I $P(PSADJN,"^")="Q" S PSAQTY=$S($P(PSADJN,"^",6)'="":+$P(PSADJN,"^",6),$P(PSADJN,"^",2)'="":+$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",22,0)
 S:'$G(PSADRG) PSADRG=+$P(PSADATA,"^",2) S:'$D(PSAQTY) PSAQTY=+$P(PSADATA,"^",3)
"RTN","PSAVER3",23,0)
 ;DAVE B (13SEP99) PSA*3*19 If item is supply, skip this area
"RTN","PSAVER3",24,0)
 I $G(PSALNSU)=1,$G(PSADRG)=0,$G(PSASUP)>0 G SUPPLY
"RTN","PSAVER3",25,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),PSANDC=$P(PSADATA,"^",11)
"RTN","PSAVER3",26,0)
 ;DAVE B (PSA*3*19) Check for exisitence of NDC
"RTN","PSAVER3",27,0)
 S PSASUB=$S(+$P(PSATEMP,"^",3):+$P(PSATEMP,"^",3),1:0) ;NDC may be zero
"RTN","PSAVER3",28,0)
 I $G(PSANDC)'="",$G(PSANDC)'=0,$G(PSADRG)'="",$G(PSADRG)'=0,$D(^PSDRUG("C",PSANDC,PSADRG)) S PSASUB=$S($G(PSASUB):$G(PSASUB),+$O(^PSDRUG("C",PSANDC,PSADRG,0)):+$O(^PSDRUG("C",PSANDC,PSADRG,0)),1:0)
"RTN","PSAVER3",29,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVER3",30,0)
 I '$D(PSAOU) D
"RTN","PSAVER3",31,0)
 .I +$P(PSADATA,"^",4),$P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^")'="" S PSAOU=+$P(PSADATA,"^",4) Q
"RTN","PSAVER3",32,0)
 .I PSADRG,PSASUB,$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",5) S PSAOU=$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",5) Q
"RTN","PSAVER3",33,0)
 .I $P(PSATEMP,"^",5)'="",+$P($P(PSATEMP,"^",5),"~",2) S PSAOU=+$P($P(PSATEMP,"^",5),"~",2)
"RTN","PSAVER3",34,0)
 I PSASUB D
"RTN","PSAVER3",35,0)
 .;Next line added 8APR98 (Dave B)
"RTN","PSAVER3",36,0)
 .S PSALOC=$S($G(PSALOC)'="":PSALOC,1:$S($P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",12):$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",12),$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",5):$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",5),1:0))
"RTN","PSAVER3",37,0)
 .S:'PSADUOU PSADUOU=$S(PSADRG&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:1)
"RTN","PSAVER3",38,0)
 .S:'PSASTOCK PSASTOCK=$S(PSADRG:+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAVER3",39,0)
 .S:'PSAREORD PSAREORD=$S(PSADRG:+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAVER3",40,0)
 ;
"RTN","PSAVER3",41,0)
SUPPLY ;If it is a supply, automatically verify it.
"RTN","PSAVER3",42,0)
 I '+$G(PSAERR),PSALNSU,'$G(PSAPRINT) D VERIFY,VERIFY1 Q
"RTN","PSAVER3",43,0)
 ;
"RTN","PSAVER3",44,0)
NEWDRUG ;Store in array if drug is new to location/vault
"RTN","PSAVER3",45,0)
 I +PSADRG D
"RTN","PSAVER3",46,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N",+$P(PSAIN,"^",12),'$D(^PSD(58.8,+$P(PSAIN,"^",12),1,PSADRG,0)) D
"RTN","PSAVER3",47,0)
 ..S PSAHOLD(+$P(PSAIN,"^",12),PSAIEN,PSAIEN1,$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P($G(^PSDRUG(PSADRG,0)),"^"),1:"UNKNOWN"))=PSADRG,$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=1
"RTN","PSAVER3",48,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)'["N",+$P(PSAIN,"^",5),'$D(^PSD(58.8,+$P(PSAIN,"^",5),1,PSADRG,0)) D
"RTN","PSAVER3",49,0)
 ..S PSAHOLD(+$P(PSAIN,"^",5),PSAIEN,PSAIEN1,$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P($G(^PSDRUG(PSADRG,0)),"^"),1:"UNKNOWN"))=PSADRG,$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=0
"RTN","PSAVER3",50,0)
 ;
"RTN","PSAVER3",51,0)
NOTSUP ;If it is not a supply, look for drug, qty, dispense units, dispense
"RTN","PSAVER3",52,0)
 ;units/order unit, order unit, location/master vault, & reorder level
"RTN","PSAVER3",53,0)
 I '+$P(PSADATA,"^",2)&('$G(PSADRG)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"D"
"RTN","PSAVER3",54,0)
 I $P(PSADATA,"^",3)=""&($G(PSAQTY)="") S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"Q"
"RTN","PSAVER3",55,0)
 I $P($G(^PSDRUG(PSADRG,660)),"^",8)="" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_8
"RTN","PSAVER3",56,0)
 I '+$P($G(^PSDRUG(PSADRG,1,+PSASUB,0)),"^",7)&('+$G(PSADUOU)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"U"
"RTN","PSAVER3",57,0)
 I '+$P(PSADATA,"^",4)&('$G(PSAOU)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"O"
"RTN","PSAVER3",58,0)
 ;
"RTN","PSAVER3",59,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",3)'["N" D
"RTN","PSAVER3",60,0)
 .I '+$P(PSAIN,"^",5) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"P" D CS^PSAVER5
"RTN","PSAVER3",61,0)
 .S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=0,PSADATA=^(0)
"RTN","PSAVER3",62,0)
 I $P(PSAIN,"^",8)="N"!($P(PSAIN,"^",8)="S"),'+$P(PSAIN,"^",5),$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))'["P" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"P"
"RTN","PSAVER3",63,0)
 ;
"RTN","PSAVER3",64,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N" D
"RTN","PSAVER3",65,0)
 .I '+$P(PSAIN,"^",12) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"M" D CS^PSAVER5
"RTN","PSAVER3",66,0)
 .S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=1,PSADATA=^(0)
"RTN","PSAVER3",67,0)
 I $P(PSAIN,"^",8)="A"!($P(PSAIN,"^",8)="S"),'+$P(PSAIN,"^",12),$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))'["M" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"M"
"RTN","PSAVER3",68,0)
 ;
"RTN","PSAVER3",69,0)
 S:$D(PSANOVER(PSAIEN,PSAIEN1,PSALINE)) PSAERR=PSAERR+1,PSALNERR=1
"RTN","PSAVER3",70,0)
 I 'PSAERR D GOOD Q
"RTN","PSAVER3",71,0)
 Q
"RTN","PSAVER3",72,0)
 ;
"RTN","PSAVER3",73,0)
GOOD ;If no errors found, verify invoice.
"RTN","PSAVER3",74,0)
 D VERIFY,VERIFY1
"RTN","PSAVER3",75,0)
 S PSAL=0 F  S PSAL=+$O(PSAHOLD(PSAL)) Q:'PSAL  D
"RTN","PSAVER3",76,0)
 .S PSANAME="" F  S PSANAME=$O(PSAHOLD(PSAL,PSAIEN,PSAIEN1,PSANAME)) Q:PSANAME=""  D
"RTN","PSAVER3",77,0)
 ..S PSANEWD(PSAL,PSANAME)=PSAHOLD(PSAL,PSAIEN,PSAIEN1,PSANAME)
"RTN","PSAVER3",78,0)
 K PSAHOLD
"RTN","PSAVER3",79,0)
 Q
"RTN","PSAVER3",80,0)
 ;
"RTN","PSAVER3",81,0)
PRINT ;Prints verification error list
"RTN","PSAVER3",82,0)
 S DIR(0)="Y",DIR("A")="Do you want to print the verification error report",DIR("B")="N"
"RTN","PSAVER3",83,0)
 S DIR("?",1)="Enter YES if you want to print the report just displayed.",DIR("?")="Enter NO if you do not want to print the report.",DIR("??")="^D PRINTYN^PSAVER3"
"RTN","PSAVER3",84,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER3",85,0)
 Q:Y=""!('+Y)
"RTN","PSAVER3",86,0)
 W ! S %ZIS="Q" D ^%ZIS Q:POP
"RTN","PSAVER3",87,0)
 I $D(IO("Q")) D  Q
"RTN","PSAVER3",88,0)
 .S ZTDESC="Drug Acct. - Print Prime Vendor Invoices",ZTRTN="PRN^PSAVER3"
"RTN","PSAVER3",89,0)
 .I $O(PSANOVER(0))'="" S ZTSAVE("PSANOVER(")=""
"RTN","PSAVER3",90,0)
 .F PSASAVE="PSAIN","PSASLN" S:$D(@PSASAVE) ZTSAVE(PSASAVE)=""
"RTN","PSAVER3",91,0)
 .D ^%ZTLOAD
"RTN","PSAVER3",92,0)
PRN ;Entry point to print verification errors
"RTN","PSAVER3",93,0)
 S (PSAERR,PSALINE,PSAOUT,PSAPG)=0,PSAPRINT=1
"RTN","PSAVER3",94,0)
 S PSAIEN=0 F  S PSAIEN=$O(PSANOVER(PSAIEN)) Q:'PSAIEN!(PSAOUT)  D
"RTN","PSAVER3",95,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))  S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^")
"RTN","PSAVER3",96,0)
 .S PSAIEN1=0 F  S PSAIEN1=$O(PSANOVER(PSAIEN,PSAIEN1)) Q:'PSAIEN1!(PSAOUT)  D
"RTN","PSAVER3",97,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))  S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0),PSAINV=$P(PSAIN,"^")
"RTN","PSAVER3",98,0)
 ..S PSALINE=0 F  S PSALINE=$O(PSANOVER(PSAIEN,PSAIEN1,PSALINE)) Q:'PSALINE!(PSAOUT)  D
"RTN","PSAVER3",99,0)
 ...D NOVER
"RTN","PSAVER3",100,0)
 .K PSANOVER(PSAIEN)
"RTN","PSAVER3",101,0)
 W !!,"** The invoice has not been placed in a Verified status!",!
"RTN","PSAVER3",102,0)
 D:$E(IOST,1,2)="C-" END^PSAPROC W:$E(IOST)'="C" @IOF
"RTN","PSAVER3",103,0)
 D ^%ZISC
"RTN","PSAVER3",104,0)
 Q
"RTN","PSAVER3",105,0)
 ;
"RTN","PSAVER3",106,0)
NOVER ;Prints errors
"RTN","PSAVER3",107,0)
 S PSANO=PSANOVER(PSAIEN,PSAIEN1,PSALINE),PSALEN=$L(PSANO)
"RTN","PSAVER3",108,0)
 S PSALINEN=$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0)),"^"),PSATAB=$L(PSALINEN)+8
"RTN","PSAVER3",109,0)
 I $E(IOST,1,2)="C-" D:'PSAPG HDR I $Y+(4+PSALEN)>IOSL D END^PSAPROC Q:PSAOUT  D HDR
"RTN","PSAVER3",110,0)
 I $E(IOST)'="C",$Y+(4+PSALEN)>IOSL!('PSAPG) D HDR
"RTN","PSAVER3",111,0)
 W "Line# "_PSALINEN_": "
"RTN","PSAVER3",112,0)
 W:PSANO[8 ?PSATAB,"Dispense unit",!
"RTN","PSAVER3",113,0)
 W:PSANO["U" ?PSATAB,"Dispense unit per order unit",!
"RTN","PSAVER3",114,0)
 W:PSANO["D" ?PSATAB,"Drug",!
"RTN","PSAVER3",115,0)
 I PSANO["M" W ?PSATAB,"Master Vault",!
"RTN","PSAVER3",116,0)
 W:PSANO["O" ?PSATAB,"Order unit",!
"RTN","PSAVER3",117,0)
 I PSANO["P" W ?PSATAB,"Pharmacy location",!
"RTN","PSAVER3",118,0)
 W:PSANO["Q" ?PSATAB,"Quantity",!
"RTN","PSAVER3",119,0)
 W !
"RTN","PSAVER3",120,0)
 Q
"RTN","PSAVER3",121,0)
 ;
"RTN","PSAVER3",122,0)
HDR ;Prints header
"RTN","PSAVER3",123,0)
 I $E(IOST,1,2)="C-" W @IOF,!?23,"<<< VERIFICATION ERROR REPORT >>>"
"RTN","PSAVER3",124,0)
 I $E(IOST)'="C" W:PSAPG'=1 @IOF W !?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE",!?27,"VERIFICATION ERROR REPORT",?72,"Page "_PSAPG,!
"RTN","PSAVER3",125,0)
 S PSAPG=PSAPG+1
"RTN","PSAVER3",126,0)
 W !,"Order#: "_PSAORD_"  Invoice#: "_$P(PSAIN,"^")_"  Invoice Date: "_$$FMTE^XLFDT(+$P(PSAIN,"^",2)) W:'$G(PSAERR) !,PSASLN,!
"RTN","PSAVER3",127,0)
 I $G(PSAERR) W !!,"The following line numbers' status cannot be changed to Verified.",!,"The fields that contain an error or need data are listed with the line item.",!,PSASLN,!
"RTN","PSAVER3",128,0)
 Q
"RTN","PSAVER3",129,0)
 ;
"RTN","PSAVER3",130,0)
STATUS ;Sets invoice's status to Verified
"RTN","PSAVER3",131,0)
 ;
"RTN","PSAVER3",132,0)
 ;PSA*3*3 (DAVE B)
"RTN","PSAVER3",133,0)
 S DA=PSAIEN1,DA(1)=PSAIEN,DIE="^PSD(58.811,"_DA(1)_",1,",DR="2///V;12////^S X="_DUZ
"RTN","PSAVER3",134,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER3",135,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER3",136,0)
 K DIE
"RTN","PSAVER3",137,0)
 Q
"RTN","PSAVER3",138,0)
 ;
"RTN","PSAVER3",139,0)
VERIFY ;Set line item to verified
"RTN","PSAVER3",140,0)
 I PSADRG,$P($G(^PSDRUG(PSADRG,2)),"^",3)["N" S PSACSLN=1
"RTN","PSAVER3",141,0)
 E  S PSACSLN=0
"RTN","PSAVER3",142,0)
 K DA S DA=PSALINE,DA(1)=PSAIEN1,DA(2)=PSAIEN,DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DR="7///^S X="_DT_";8////^S X="_DUZ_";12///^S X=PSACSLN"
"RTN","PSAVER3",143,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER3",144,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER3",145,0)
 K DIE
"RTN","PSAVER3",146,0)
 Q
"RTN","PSAVER3",147,0)
 ;
"RTN","PSAVER3",148,0)
VERIFY1 ;Set adjs if entire invioce was verified
"RTN","PSAVER3",149,0)
 S DA=0 F  S DA=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA)) Q:'DA  D
"RTN","PSAVER3",150,0)
 .Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0))
"RTN","PSAVER3",151,0)
 .Q:$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0),"^",9)=DUZ
"RTN","PSAVER3",152,0)
 .S PSAREA="",PSADJ=$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0),"^",2) D ADJ^PSAVER2
"RTN","PSAVER3",153,0)
 Q
"RTN","PSAVER3",154,0)
 ;
"RTN","PSAVER3",155,0)
DDQOR ;Extended help for 'Edit field'
"RTN","PSAVER3",156,0)
 W !?5,"Enter the number or range of numbers of the field you want to edit.",!?5,"For example, 1-3 or 1,3"
"RTN","PSAVER3",157,0)
 Q
"RTN","PSAVER3",158,0)
LNHELP ;Extended help for 'Line Number"
"RTN","PSAVER3",159,0)
 W !?5,"Enter the number of the item on the invoice you want to edit.",!?5,"You may enter several line item numbers separated by comas.",!!?5,"Do NOT enter a range of numbers separated by a dash."
"RTN","PSAVER3",160,0)
 Q
"RTN","PSAVER3",161,0)
PRINTYN ;Extended help for 'Print verification report'
"RTN","PSAVER3",162,0)
 W !?5,"Enter YES to print the Verification Error Report on a printer.",!?5,"Enter NO if you do not want to print the report."
"RTN","PSAVER3",163,0)
 Q
"RTN","PSAVER6")
0^25^B57278289^B56721595
"RTN","PSAVER6",1,0)
PSAVER6 ;BIR/JMB-Verify Invoices - CONT'D ;10/3/97
"RTN","PSAVER6",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**1,3,21,42,53,57,61,64**; 10/24/97;Build 4
"RTN","PSAVER6",3,0)
 ;Background Job:
"RTN","PSAVER6",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER6",5,0)
 ;This routine increments pharmacy location and master vault balances
"RTN","PSAVER6",6,0)
 ;in 58.8 after invoices have been verified.
"RTN","PSAVER6",7,0)
 ;
"RTN","PSAVER6",8,0)
START ;|=> *42 add Post Verify variance report
"RTN","PSAVER6",9,0)
 K ^TMP($J,"PSADD")
"RTN","PSAVER6",10,0)
 K DIC,DA,DR,DIE  ;|=> *52 MOVE POST VERIFY E-MAIL LOGIC FROM START+17
"RTN","PSAVER6",11,0)
 S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",12,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",13,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",14,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",15,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",16,0)
 ..D SCANDIF  ; *57 <=|
"RTN","PSAVER6",17,0)
 S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",18,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",19,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",20,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",21,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",22,0)
 ..S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER6",23,0)
 ..K DIC,DA,DR,DIE
"RTN","PSAVER6",24,0)
 ..I +$P(PSAIN,"^",13) K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR Q
"RTN","PSAVER6",25,0)
 ..S PSAINV=$P(PSAIN,"^"),PSAINVDT=$P(PSAIN,"^",2),PSALINE=0
"RTN","PSAVER6",26,0)
 ..F  S PSALINE=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:'PSALINE  D
"RTN","PSAVER6",27,0)
 ...Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVER6",28,0)
 ...S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0) D GETDATA I 'PSASUP,'$D(PSA0QTY) D FILE ;PSA*3*42
"RTN","PSAVER6",29,0)
 ..K DIC,DA,DR,DIE
"RTN","PSAVER6",30,0)
 ..K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR
"RTN","PSAVER6",31,0)
 ;;*57 => START+17 THRU START+22 MOVED TO START+3 <=|
"RTN","PSAVER6",32,0)
 ; *42 <=|
"RTN","PSAVER6",33,0)
EXIT ;Kills variables
"RTN","PSAVER6",34,0)
 K %,DA,DD,DIC,DIE,DINUM,DLAYGO,DO,PSA,PSAA,PSABAL,PSACBAL,PSACNT,PSACNT,PSACOD,PSACOST,PSACS,PSADASH,PSADATA,PSADJ,PSADJD,PSADJO,PSADJP,PSADJQ
"RTN","PSAVER6",35,0)
 K PSADRG,PSADT,PSADUOU,PSADUQTY,PSADUREC,PSAIEN,PSAIEN1,PSAIN,PSAINV,PSAINVDT,PSALEN,PSALINE,PSALOC,PSAMSG,PSANDC,PSANODE,PSANPDU,PSANPOU
"RTN","PSAVER6",36,0)
 K PSAODASH,PSAONDC,PSAORD,PSAOU,PSAPDU,PSAPOU,PSAQTY,PSAREORD,PSASET,PSASTOCK,PSASUP,PSAT,PSATDRG,PSATEMP,PSAVBKG,PSAVDUZ,PSAVEND,PSAVSN,X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,Y
"RTN","PSAVER6",37,0)
 K PSA0QTY
"RTN","PSAVER6",38,0)
 Q
"RTN","PSAVER6",39,0)
 ;
"RTN","PSAVER6",40,0)
GETDATA ;Gets invoice data to help file the data
"RTN","PSAVER6",41,0)
 S PSAVDUZ=$P(PSADATA,"^",9),PSASUP=0
"RTN","PSAVER6",42,0)
 S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAVER6",43,0)
 I '$G(PSADJ) S PSADRG=$S(+$P(PSADATA,"^",2):+$P(PSADATA,"^",2),1:0) G CS
"RTN","PSAVER6",44,0)
 I $G(PSADJ) D
"RTN","PSAVER6",45,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVER6",46,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",47,0)
 .I PSADJD'?1.N S PSASUP=1
"RTN","PSAVER6",48,0)
 .S PSADRG=$S(PSADJ&('PSASUP):+PSADJD,PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAVER6",49,0)
 .I +PSADJD,$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" S PSADRG=+PSADJD Q
"RTN","PSAVER6",50,0)
 .I +PSADJD,$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAVER6",51,0)
CS Q:PSASUP!('PSADRG)
"RTN","PSAVER6",52,0)
 S PSACS=$S(+$P(PSADATA,"^",10):1,1:0)
"RTN","PSAVER6",53,0)
 S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAVER6",54,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",55,0)
 ;
"RTN","PSAVER6",56,0)
 ;PSA*3*1  (DAVE B)
"RTN","PSAVER6",57,0)
 S PSAQTY=$S(($G(PSADJQ)'=""&(+PSADJ)):PSADJQ,1:+$P(PSADATA,"^",3))
"RTN","PSAVER6",58,0)
 S PSAOU=$S(+$P(PSADATA,"^",4):+$P(PSADATA,"^",4),1:"")
"RTN","PSAVER6",59,0)
 ;
"RTN","PSAVER6",60,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",61,0)
 ;I +$P($P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^",5),"~",2) S PSAOU=$P($P($G(^(2)),"^",5),"~",2)
"RTN","PSAVER6",62,0)
 ;
"RTN","PSAVER6",63,0)
 S PSADJO=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAVER6",64,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",65,0)
 S:$G(PSADJO) PSAOU=$G(PSADJO)
"RTN","PSAVER6",66,0)
 S PSANDC=$P(PSADATA,"^",11) D PSANDC1^PSAHELP S PSADASH=PSANDCX K PSANDCX
"RTN","PSAVER6",67,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAVER6",68,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAVER6",69,0)
 S (PSAPOU,PSANPOU)=$S($G(PSADJP):PSADJP,1:+$P(PSADATA,"^",5)),PSALEN=$L($P(PSANPOU,".")),(PSAPOU,PSANPOU)=$J(PSANPOU,PSALEN,2)
"RTN","PSAVER6",70,0)
 S PSAVSN=$P(PSADATA,"^",12)
"RTN","PSAVER6",71,0)
 S PSALOC=$S(+PSACS:+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",5))
"RTN","PSAVER6",72,0)
TEMP S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAVER6",73,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVER6",74,0)
 S PSADUOU=$S(+PSADUOU:+PSADUOU,+PSASUB&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:1)
"RTN","PSAVER6",75,0)
 S PSADUREC=$S(PSADUOU:PSAQTY*PSADUOU,1:0)
"RTN","PSAVER6",76,0)
 ;
"RTN","PSAVER6",77,0)
 ;DAVE B (18NOV98)
"RTN","PSAVER6",78,0)
 I PSADUREC=0,$D(PSAQTY),$P($G(^PSDRUG(PSADRG,660)),"^",5)'="" S PSADUREC=(PSAQTY*($P(^PSDRUG(PSADRG,660),"^",5)))
"RTN","PSAVER6",79,0)
 Q:'+$P($G(^PSD(58.8,PSALOC,0)),"^",14)
"RTN","PSAVER6",80,0)
 S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAVER6",81,0)
 S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAVER6",82,0)
 K PSA0QTY I '$G(PSAQTY),'$G(PSADJQ) S PSA0QTY=1 Q  ;PSA*3*42 (0 QTY)
"RTN","PSAVER6",83,0)
 Q
"RTN","PSAVER6",84,0)
 ;
"RTN","PSAVER6",85,0)
FILE ;File data in 58.8
"RTN","PSAVER6",86,0)
 I $D(PSADUREC),PSADUREC'>0 S PSADUREC=$S($D(PSADJQ):PSADJQ,$D(PSAQTY):PSAQTY,1:0)
"RTN","PSAVER6",87,0)
 D NOW^%DTC S PSADT=+$E(%,1,14)
"RTN","PSAVER6",88,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSAVER6",89,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",90,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) DIC("P")=$P(^DD(58.8,10,0),"^",2)
"RTN","PSAVER6",91,0)
 .S DA(1)=PSALOC,DIC="^PSD(58.8,"_DA(1)_",1,",(DA,DINUM,X)=PSADRG,DIC(0)="L",DLAYGO=58.8
"RTN","PSAVER6",92,0)
 .F  L +^PSD(58.8,PSALOC,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER6",93,0)
 .D FILE^DICN L -^PSD(58.8,PSALOC,0) K DIC,DA,DLAYGO
"RTN","PSAVER6",94,0)
 .D MM ;*42 send mailmessage
"RTN","PSAVER6",95,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER6",96,0)
 S PSABAL=+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)
"RTN","PSAVER6",97,0)
 ;
"RTN","PSAVER6",98,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",99,0)
 I $P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",1)'=PSADRG S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",1)=PSADRG
"RTN","PSAVER6",100,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSADUREC+PSABAL
"RTN","PSAVER6",101,0)
 I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D
"RTN","PSAVER6",102,0)
 .I PSASTOCK'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3)=PSASTOCK
"RTN","PSAVER6",103,0)
 .I PSAREORD'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5)=PSAREORD
"RTN","PSAVER6",104,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) DIC("P")=$P(^DD(58.8001,20,0),"^",2)
"RTN","PSAVER6",105,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,$E(DT,1,5)*100,0)) D
"RTN","PSAVER6",106,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",107,0)
 .S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSABAL)"
"RTN","PSAVER6",108,0)
 .S (X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DIC("DR")
"RTN","PSAVER6",109,0)
 .S X="T-1M" D ^%DT S (X,DINUM)=$E(Y,1,5)*100,DA=PSADRG D ^DIC K DIC,DLAYGO
"RTN","PSAVER6",110,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",111,0)
 .S DA=+Y,DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAVER6",112,0)
 K DIC,DA,DR,DIE
"RTN","PSAVER6",113,0)
 S DA=$E(DT,1,5)*100
"RTN","PSAVER6",114,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DA=$E(DT,1,5)*100,DR="3////^S X=($G(PSABAL)+$G(PSADUREC));5////^S X="_($P($G(^(0)),"^",3)+PSADUREC) D ^DIE K DIE
"RTN","PSAVER6",115,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAVER6",116,0)
 G TR^PSAVER7
"RTN","PSAVER6",117,0)
MM ;
"RTN","PSAVER6",118,0)
 ;*42 Mail Message to holders of PSDMGR, PSAMGR key
"RTN","PSAVER6",119,0)
 ;*53 Consolidate messages
"RTN","PSAVER6",120,0)
 N PSACS S PSACS=$S($$GET1^DIQ(50,PSADRG,63)["N":" Controlled Substance ",1:"")
"RTN","PSAVER6",121,0)
 S ^TMP($J,"PSADD",$$GET1^DIQ(58.8,PSALOC,.01),$$GET1^DIQ(50,PSADRG,.01))=""
"RTN","PSAVER6",122,0)
 Q
"RTN","PSAVER6",123,0)
SCANDIF ;*42 inspect invoice for noted differences in OU,DUOU,PPDU,NDC
"RTN","PSAVER6",124,0)
 ;NEEDS PSAIEN, PSAIEN1
"RTN","PSAVER6",125,0)
 K ^TMP($J,"PSADIF"),PSADIFLC
"RTN","PSAVER6",126,0)
 S PSALINE=0 F  S PSALINE=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:PSALINE'>0  D CHECK^PSAPROC7 ;checks and stores differences in ^TMP($J,
"RTN","PSAVER6",127,0)
 I $D(^TMP($J,"PSADD")) D ADDMM
"RTN","PSAVER6",128,0)
 I $D(^TMP($J,"PSADIF")) D MESSAGE
"RTN","PSAVER6",129,0)
 Q
"RTN","PSAVER6",130,0)
MESSAGE ;differences found, notify user and send message to g.PSA NDC UPDATES.
"RTN","PSAVER6",131,0)
 K DIR N IENS
"RTN","PSAVER6",132,0)
 S PSAORD=$$GET1^DIQ(58.811,PSAIEN,.01),IENS=PSAIEN1_","_PSAIEN
"RTN","PSAVER6",133,0)
 S PSAINV=$$GET1^DIQ(58.8112,IENS,.01)
"RTN","PSAVER6",134,0)
 S XMSUB="POST Verify  Variance Report Ord: "_PSAORD_" Inv: "_PSAINV ;*52
"RTN","PSAVER6",135,0)
 S ^TMP($J,"PSADIF",1,0)=XMSUB,^TMP($J,"PSADIF",2,0)=" "
"RTN","PSAVER6",136,0)
 S XMTEXT="^TMP($J,""PSADIF"",",XMY("G.PSA NDC UPDATES")=""
"RTN","PSAVER6",137,0)
 S XMDUZ="Price & NDC Updater"
"RTN","PSAVER6",138,0)
 D ^XMD
"RTN","PSAVER6",139,0)
 K PSADIFLC,^TMP($J,"PSADIF")
"RTN","PSAVER6",140,0)
 Q
"RTN","PSAVER6",141,0)
ADDMM ; SEND MESSAGE REGARDING DRUGS ADDED TO PHARMACY LOCATIONS
"RTN","PSAVER6",142,0)
 K ^TMP($J,"PSADDMM")
"RTN","PSAVER6",143,0)
 S XMSUB="New Drugs Added by Order: "_$G(PSAORD)_" Invoice: "_$G(PSAINV)
"RTN","PSAVER6",144,0)
 S XMDUZ="Verified by: "_$$GET1^DIQ(200,DUZ,.01)
"RTN","PSAVER6",145,0)
 S LC=0,X=XMSUB D MMLINE S X=XMDUZ D MMLINE
"RTN","PSAVER6",146,0)
 S X="Please use DA and CS menus to populate the balances, stock and re-order levels." D MMLINE
"RTN","PSAVER6",147,0)
 S PSALOC="" F  S PSALOC=$O(^TMP($J,"PSADD",PSALOC)) Q:PSALOC=""  D
"RTN","PSAVER6",148,0)
 . S X=PSALOC D MMLINE
"RTN","PSAVER6",149,0)
 . S PSADRG="" F  S PSADRG=$O(^TMP($J,"PSADD",PSALOC,PSADRG)) Q:PSADRG=""  S X="     "_PSADRG D MMLINE
"RTN","PSAVER6",150,0)
 S XMTEXT="^TMP($J,""PSADDMM"","
"RTN","PSAVER6",151,0)
 S XMY("G.PSA NDC UPDATES")=""
"RTN","PSAVER6",152,0)
 D ^XMD
"RTN","PSAVER6",153,0)
 K ^TMP($J,"PSADD"),^TMP($J,"PSADDMM"),LC
"RTN","PSAVER6",154,0)
 Q
"RTN","PSAVER6",155,0)
MMLINE S LC=LC+1,^TMP($J,"PSADDMM",LC,0)=X W !,X Q
"RTN","PSAVER7")
0^26^B23378139^B21998515
"RTN","PSAVER7",1,0)
PSAVER7 ;BIR/JMB-Verify Invoices - CONT'D ;7/23/97
"RTN","PSAVER7",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**12,21,42,56,64**; 10/24/97;Build 4
"RTN","PSAVER7",3,0)
 ;Background Job
"RTN","PSAVER7",4,0)
 ;This routine increments pharmacy location and master vault balances
"RTN","PSAVER7",5,0)
 ;in 58.8 after invoices have been verified. This routine is called
"RTN","PSAVER7",6,0)
 ;by PSAVER6.
"RTN","PSAVER7",7,0)
 ;
"RTN","PSAVER7",8,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER7",9,0)
TR ;File transaction data in 58.81
"RTN","PSAVER7",10,0)
 I $D(PSADUREC),'PSADUREC Q  ;*56 block '0' quantity edits
"RTN","PSAVER7",11,0)
 I $D(PSAQTY),'PSAQTY Q  ;*56 block '0' quantity edits
"RTN","PSAVER7",12,0)
 F  L +^PSD(58.81,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",13,0)
FIND S PSAT=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSAT)) S $P(^PSD(58.81,0),"^",3)=$P(^PSD(58.81,0),"^",3)+1 G FIND
"RTN","PSAVER7",14,0)
 S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSAT D ^DIC K DIC,DINUM,DLAYGO L -^PSD(58.81,0)
"RTN","PSAVER7",15,0)
 S DIE="^PSD(58.81,",DA=PSAT,DR="1////1;2////^S X=PSALOC;3////^S X=PSADT;4////^S X=PSADRG;5////^S X=PSADUREC;6////^S X=PSAVDUZ;9////^S X=PSABAL;71////^S X=PSAINV;106////^S X=PSAORD"
"RTN","PSAVER7",16,0)
 I $G(PSACS) S DR=DR_";100////^S X=PSACS"
"RTN","PSAVER7",17,0)
 F  L +^PSD(58.81,DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",18,0)
 D ^DIE L -^PSD(58.81,DA,0) K DIE
"RTN","PSAVER7",19,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,4,0)) DIC("P")=$P(^DD(58.8001,19,0),"^",2)
"RTN","PSAVER7",20,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,(X,DINUM)=PSAT,DIC="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSAVER7",21,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",22,0)
 D ^DIC L -^PSD(58.8,PSALOC,1,PSADRG,0) K DIC,DINUM,DLAYGO
"RTN","PSAVER7",23,0)
 ;
"RTN","PSAVER7",24,0)
50 S PSAODASH=$P($G(^PSDRUG(PSADRG,2)),"^",4)
"RTN","PSAVER7",25,0)
 S PSAONDC=$P(PSAODASH,"-")_$P(PSAODASH,"-",2)_$P(PSAODASH,"-",3)
"RTN","PSAVER7",26,0)
 ;(PSA*3*21) NDC & PRICING UPDATES (DAVE BLOCKER 10NOV99)
"RTN","PSAVER7",27,0)
 S PSADUOU=$S($G(PSADUOU)'>0:1,1:PSADUOU)
"RTN","PSAVER7",28,0)
 S PSADUREC=(PSAQTY*PSADUOU)
"RTN","PSAVER7",29,0)
 S DIE="^PSDRUG(",DA=PSADRG,DR="50////^S X="_(PSADUREC+$G(^PSDRUG(PSADRG,660.1)))
"RTN","PSAVER7",30,0)
 F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",31,0)
 D ^DIE L -^PSDRUG(DA,0) K DIE,DA,DR
"RTN","PSAVER7",32,0)
 ;This section replaces most of the routine
"RTN","PSAVER7",33,0)
 ;PSAOU = order unit from invoice
"RTN","PSAVER7",34,0)
 ;PSAPOU & PSANPOU = Price of Order Unit from invoice
"RTN","PSAVER7",35,0)
 ;PSADUOU=Dispense Units per OU form invoice data
"RTN","PSAVER7",36,0)
 ;PSANPDU= Price of Dispense Units per Order Unit
"RTN","PSAVER7",37,0)
 ;
"RTN","PSAVER7",38,0)
 ;Drug file Information
"RTN","PSAVER7",39,0)
 K DRUG
"RTN","PSAVER7",40,0)
 S PSANODE=$G(^PSDRUG(PSADRG,660))
"RTN","PSAVER7",41,0)
 F X=2,3,5,6 S DRUG(X)=$P($G(PSANODE),"^",X)
"RTN","PSAVER7",42,0)
 ;
"RTN","PSAVER7",43,0)
 S PSANPDU=$J(($G(PSAPOU)/$G(PSADUOU)),0,3) ;Price of Order Unit divide by Disp. Units per Order Unit
"RTN","PSAVER7",44,0)
 ;PSA*3*42 |>  (let changes happen and file, put changes into mail message)
"RTN","PSAVER7",45,0)
 S DIE="^PSDRUG(",DA=PSADRG,DR="12////^S X=PSAOU;15////^S X=PSADUOU;Q;13////^S X=PSAPOU" ;*42;*56
"RTN","PSAVER7",46,0)
 F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",47,0)
 D ^DIE K DIE,DA,DR
"RTN","PSAVER7",48,0)
 ; <| PSA*42
"RTN","PSAVER7",49,0)
PTCH21 ;PSA*3*21 (Vendor's VSN changing to 8 digits, check also)
"RTN","PSAVER7",50,0)
 ;If NDC or VSN changes should it create to synonym entry ?
"RTN","PSAVER7",51,0)
 I $G(^PSDRUG(PSADRG,1,PSASUB,0))="" G NDC
"RTN","PSAVER7",52,0)
 I $G(^PSDRUG(PSADRG,1,PSASUB,0)) S PSAEDTT=0,DATA=^PSDRUG(PSADRG,1,PSASUB,0) D
"RTN","PSAVER7",53,0)
 .I PSAVSN'=$P(DATA,"^",4) S PSAEDTT=1 ;VSN
"RTN","PSAVER7",54,0)
 .I PSAPOU'=$P(DATA,"^",6) S PSAEDTT=1 ;Price per order unit
"RTN","PSAVER7",55,0)
 .I PSADUOU'=$P(DATA,"^",7) S PSAEDTT=1 ;Dispense Units per Order Unit
"RTN","PSAVER7",56,0)
 .I PSANPDU'=$P(DATA,"^",8) S PSAEDTT=1 ;New Price per dispense unit
"RTN","PSAVER7",57,0)
 .I $G(PSAEDTT)>0 D
"RTN","PSAVER7",58,0)
 ..S DA=PSASUB,DA(1)=PSADRG,DIE="^PSDRUG("_DA(1)_",1,"
"RTN","PSAVER7",59,0)
 ..S DR="2////^S X=PSADASH"_$S(PSACS:";1////C",1:";1////D")_";400////^S X=PSAVSN;401////^S X=PSAOU"_$S(+PSAPOU:";402////^S X=PSAPOU",1:"")_";403////^S X=PSADUOU"_";404///^S X=PSANPDU"_";405///^S X=PSAVEND"
"RTN","PSAVER7",60,0)
 ..D ^DIE K DIE,DR,DA
"RTN","PSAVER7",61,0)
NDC ;NDC UPDATE
"RTN","PSAVER7",62,0)
 I PSANDC'="",PSANDC'=PSAONDC D  ;*42
"RTN","PSAVER7",63,0)
 .S DIE="^PSDRUG(",DA=PSADRG,DR="31////^S X=PSADASH"
"RTN","PSAVER7",64,0)
 .F  L +^PSDRUG(DA,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",65,0)
 .D ^DIE L -^PSDRUG(DA,0) K DIE,DA,DR
"RTN","PSAVER7",66,0)
SYNONYM ;Adds/edits the SYNONYM multiple in DRUG file
"RTN","PSAVER7",67,0)
 Q:PSANDC=""  K DA,DR S DA(1)=PSADRG
"RTN","PSAVER7",68,0)
 ;
"RTN","PSAVER7",69,0)
 S PSANPDU=$J(($G(PSAPOU)/$G(PSADUOU)),0,3) ;Price of Order Unit divide by Disp. Units per Order Unit
"RTN","PSAVER7",70,0)
 S:'$D(^PSDRUG(PSADRG,1,0)) DIC("P")="50.1A"
"RTN","PSAVER7",71,0)
 ; *56 Search for earliest best match of synonyms, start at bottom go up
"RTN","PSAVER7",72,0)
 ; if VSN use it, if several VSNs use the first, IF VSN match NDCs must match also.
"RTN","PSAVER7",73,0)
 ; if no VSN, make a new synonym
"RTN","PSAVER7",74,0)
 ; no "B" synonym index exists
"RTN","PSAVER7",75,0)
T0 N PSYNDA,PSYN0,PSTNDC,PSTVSN,PSMNDC,PSMBTH S (PSMNDC,PSMBTH)=0
"RTN","PSAVER7",76,0)
 S PSYNDA="" F  S PSYNDA=$O(^PSDRUG(PSADRG,1,PSYNDA),-1) Q:PSYNDA'>0  D
"RTN","PSAVER7",77,0)
 . S PSYN0=^PSDRUG(PSADRG,1,PSYNDA,0),PSTNDC=$P(PSYN0,U),PSTVSN=$P(PSYN0,U,4) ;zero node, test values of NDC VSN
"RTN","PSAVER7",78,0)
 . I PSTNDC'=PSANDC Q
"RTN","PSAVER7",79,0)
 . I PSTVSN=PSAVSN S PSMBTH=PSYNDA Q  ;both VSN & NDC matches
"RTN","PSAVER7",80,0)
T1 S PSASUB=$S(PSMBTH:PSMBTH,1:0) ;PSAMBTH Match both vsn,ndc
"RTN","PSAVER7",81,0)
 ;end *56
"RTN","PSAVER7",82,0)
 I 'PSASUB!(PSASUB&('$D(^PSDRUG(PSADRG,1,PSASUB,0)))) D
"RTN","PSAVER7",83,0)
 .S DIC="^PSDRUG("_DA(1)_",1,",DIC(0)="Z",X=PSANDC,DLAYGO=50
"RTN","PSAVER7",84,0)
 .F  L +^PSDRUG(PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",85,0)
 .D FILE^DICN L -^PSDRUG(PSADRG,0) K DIC,DLAYGO S PSASUB=+Y
"RTN","PSAVER7",86,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER7",87,0)
 I PSASUB,$D(^PSDRUG(PSADRG,1,PSASUB,0)) S DA=PSASUB
"RTN","PSAVER7",88,0)
 S DA(1)=PSADRG,DIE="^PSDRUG("_DA(1)_",1,"
"RTN","PSAVER7",89,0)
 S DR="2////^S X=PSADASH"_$S($G(PSACS)>0:";1////C",1:";1////D")_";400////^S X=PSAVSN;401////^S X=PSAOU"_$S(+PSAPOU:";402////^S X=PSAPOU",1:"")_";403////^S X=PSADUOU"_";404///^S X=PSANPDU;405///^S X=PSAVEND"
"RTN","PSAVER7",90,0)
 F  L +^PSDRUG(PSADRG,0):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I  Q
"RTN","PSAVER7",91,0)
 D ^DIE L -^PSDRUG(PSADRG,0)
"RTN","PSAVER7",92,0)
 K DIE,DR,X1,X2,DATA
"RTN","PSAVER7",93,0)
 Q
"VER")
8.0^22.0
"BLD",6351,6)
^48
**END**
**END**
