Released IB*2*203 SEQ #183
Extracted from mail message
**KIDS**:IB*2.0*203^

**INSTALL NAME**
IB*2.0*203
"BLD",4415,0)
IB*2.0*203^INTEGRATED BILLING^0^3030130^y
"BLD",4415,1,0)
^^1^1^3021203^
"BLD",4415,1,1,0)
Cancel ClaimsManager Bill Bug Fix
"BLD",4415,4,0)
^9.64PA^^
"BLD",4415,"INID")
^n
"BLD",4415,"INIT")
IB20P203
"BLD",4415,"KRN",0)
^9.67PA^8989.52^19
"BLD",4415,"KRN",.4,0)
.4
"BLD",4415,"KRN",.401,0)
.401
"BLD",4415,"KRN",.402,0)
.402
"BLD",4415,"KRN",.403,0)
.403
"BLD",4415,"KRN",.5,0)
.5
"BLD",4415,"KRN",.84,0)
.84
"BLD",4415,"KRN",3.6,0)
3.6
"BLD",4415,"KRN",3.8,0)
3.8
"BLD",4415,"KRN",9.2,0)
9.2
"BLD",4415,"KRN",9.8,0)
9.8
"BLD",4415,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",4415,"KRN",9.8,"NM",1,0)
IBCIADD1^^0^B33449123
"BLD",4415,"KRN",9.8,"NM","B","IBCIADD1",1)

"BLD",4415,"KRN",19,0)
19
"BLD",4415,"KRN",19.1,0)
19.1
"BLD",4415,"KRN",101,0)
101
"BLD",4415,"KRN",409.61,0)
409.61
"BLD",4415,"KRN",771,0)
771
"BLD",4415,"KRN",870,0)
870
"BLD",4415,"KRN",8989.51,0)
8989.51
"BLD",4415,"KRN",8989.52,0)
8989.52
"BLD",4415,"KRN",8989.52,"NM",0)
^9.68A^^
"BLD",4415,"KRN",8994,0)
8994
"BLD",4415,"KRN","B",.4,.4)

"BLD",4415,"KRN","B",.401,.401)

"BLD",4415,"KRN","B",.402,.402)

"BLD",4415,"KRN","B",.403,.403)

"BLD",4415,"KRN","B",.5,.5)

"BLD",4415,"KRN","B",.84,.84)

"BLD",4415,"KRN","B",3.6,3.6)

"BLD",4415,"KRN","B",3.8,3.8)

"BLD",4415,"KRN","B",9.2,9.2)

"BLD",4415,"KRN","B",9.8,9.8)

"BLD",4415,"KRN","B",19,19)

"BLD",4415,"KRN","B",19.1,19.1)

"BLD",4415,"KRN","B",101,101)

"BLD",4415,"KRN","B",409.61,409.61)

"BLD",4415,"KRN","B",771,771)

"BLD",4415,"KRN","B",870,870)

"BLD",4415,"KRN","B",8989.51,8989.51)

"BLD",4415,"KRN","B",8989.52,8989.52)

"BLD",4415,"KRN","B",8994,8994)

"BLD",4415,"QUES",0)
^9.62^^
"BLD",4415,"REQB",0)
^9.611^1^1
"BLD",4415,"REQB",1,0)
IB*2.0*161^2
"BLD",4415,"REQB","B","IB*2.0*161",1)

"INIT")
IB20P203
"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
203^3030130
"PKG",200,22,1,"PAH",1,1,0)
^^1^1^3030130
"PKG",200,22,1,"PAH",1,1,1,0)
Cancel ClaimsManager Bill Bug Fix
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","IB20P203")
0^^B24276430
"RTN","IB20P203",1,0)
IB20P203 ;DSI/ESG - CANCEL CLAIM BUG FIX ;17-OCT-2002
"RTN","IB20P203",2,0)
 ;;2.0;INTEGRATED BILLING;**203**;21-MAR-94
"RTN","IB20P203",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IB20P203",4,0)
 ;
"RTN","IB20P203",5,0)
 ; The purpose of this routine is to correctly "cancel" bills on the
"RTN","IB20P203",6,0)
 ; ClaimsManager server that have been cancelled in VistA.  A bill is
"RTN","IB20P203",7,0)
 ; considered cancelled in ClaimsManager when all of it's line items
"RTN","IB20P203",8,0)
 ; have a status of deleted.
"RTN","IB20P203",9,0)
 ;
"RTN","IB20P203",10,0)
EN ;
"RTN","IB20P203",11,0)
 NEW IBIFN,IBSTAT,CMDATA,TIFLAG,IBCISNT,IBCISTAT,IBCIREDT,IBCIERR,OK
"RTN","IB20P203",12,0)
 NEW IBCIPBCT,IBCISOCK
"RTN","IB20P203",13,0)
 ;
"RTN","IB20P203",14,0)
 ; Make sure the site is using ClaimsManager
"RTN","IB20P203",15,0)
 I '$$CK0^IBCIUT1() G EXIT
"RTN","IB20P203",16,0)
 ;
"RTN","IB20P203",17,0)
 ; If we're in the TEST account, use different ports
"RTN","IB20P203",18,0)
 I $$ENV^IBCIUT5="T" D
"RTN","IB20P203",19,0)
 . NEW PORT,DA,DIK,DIC,X,Y
"RTN","IB20P203",20,0)
 . F PORT=10040,10050,10060 D
"RTN","IB20P203",21,0)
 .. S DA=$O(^IBE(350.9,1,50.06,"B",PORT,"")) Q:'DA
"RTN","IB20P203",22,0)
 .. S DA(1)=1,DIK="^IBE(350.9,1,50.06,"
"RTN","IB20P203",23,0)
 .. D ^DIK
"RTN","IB20P203",24,0)
 .. Q
"RTN","IB20P203",25,0)
 . Q
"RTN","IB20P203",26,0)
 ;
"RTN","IB20P203",27,0)
 ; This initial loop is just to count how many bills will be sent
"RTN","IB20P203",28,0)
 ; to ClaimsManager.
"RTN","IB20P203",29,0)
 ;
"RTN","IB20P203",30,0)
 I '$D(ZTQUEUED) W !,"Counting eligible bills ... "
"RTN","IB20P203",31,0)
 S IBIFN=0,IBCIPBCT=0
"RTN","IB20P203",32,0)
 F  S IBIFN=$O(^IBA(351.9,IBIFN)) Q:'IBIFN  D
"RTN","IB20P203",33,0)
 . S IBSTAT=$P($G(^DGCR(399,IBIFN,0)),U,13)     ; IB bill status
"RTN","IB20P203",34,0)
 . I IBSTAT'=7 Q                                ; must be cancelled
"RTN","IB20P203",35,0)
 . S CMDATA=$G(^IBA(351.9,IBIFN,0))
"RTN","IB20P203",36,0)
 . I '$P(CMDATA,U,15) Q                ; must have been sent to CM
"RTN","IB20P203",37,0)
 . ;
"RTN","IB20P203",38,0)
 . ; If the bill was last sent to CM before 3/27/02, then we're OK
"RTN","IB20P203",39,0)
 . ; because the bug was not released until this date.
"RTN","IB20P203",40,0)
 . I $P(CMDATA,U,3)<3020327 Q
"RTN","IB20P203",41,0)
 . ;
"RTN","IB20P203",42,0)
 . ; update count
"RTN","IB20P203",43,0)
 . S IBCIPBCT=IBCIPBCT+1
"RTN","IB20P203",44,0)
 . Q
"RTN","IB20P203",45,0)
 ;
"RTN","IB20P203",46,0)
 I '$D(ZTQUEUED) D
"RTN","IB20P203",47,0)
 . W "Done"
"RTN","IB20P203",48,0)
 . W !!,"The number of cancelled bills that will be sent to ClaimsManager is ",IBCIPBCT,"."
"RTN","IB20P203",49,0)
 . I 'IBCIPBCT Q
"RTN","IB20P203",50,0)
 . W !!,"Note:  Each ""."" below represents 10 bills."
"RTN","IB20P203",51,0)
 . W !!,"Sending cancelled bills to ClaimsManager "
"RTN","IB20P203",52,0)
 . Q
"RTN","IB20P203",53,0)
 ;
"RTN","IB20P203",54,0)
 ; This is the main processing loop.
"RTN","IB20P203",55,0)
 ;
"RTN","IB20P203",56,0)
 S IBIFN=0,OK=1,IBCIPBCT=0
"RTN","IB20P203",57,0)
 F  S IBIFN=$O(^IBA(351.9,IBIFN)) Q:'IBIFN  D  I 'OK Q
"RTN","IB20P203",58,0)
 . S IBSTAT=$P($G(^DGCR(399,IBIFN,0)),U,13)     ; IB bill status
"RTN","IB20P203",59,0)
 . I IBSTAT'=7 Q                                ; must be cancelled
"RTN","IB20P203",60,0)
 . S CMDATA=$G(^IBA(351.9,IBIFN,0))
"RTN","IB20P203",61,0)
 . I '$P(CMDATA,U,15) Q                ; must have been sent to CM
"RTN","IB20P203",62,0)
 . ;
"RTN","IB20P203",63,0)
 . ; If the bill was last sent to CM before 3/27/02, then we're OK
"RTN","IB20P203",64,0)
 . ; because the bug was not released until this date.
"RTN","IB20P203",65,0)
 . I $P(CMDATA,U,3)<3020327 Q
"RTN","IB20P203",66,0)
 . ;
"RTN","IB20P203",67,0)
 . ; update count and display a "." every 10 bills
"RTN","IB20P203",68,0)
 . S IBCIPBCT=IBCIPBCT+1
"RTN","IB20P203",69,0)
 . I IBCIPBCT#10=0,'$D(ZTQUEUED) W "."
"RTN","IB20P203",70,0)
 . ;
"RTN","IB20P203",71,0)
 . ; temporary information flag; assume 3,4,5 nodes exist
"RTN","IB20P203",72,0)
 . S TIFLAG=1
"RTN","IB20P203",73,0)
 . I '$P($G(^IBA(351.9,IBIFN,3)),U,1) S TIFLAG=0  ; if they don't exist
"RTN","IB20P203",74,0)
 . ;
"RTN","IB20P203",75,0)
 . ; Process this bill and retrieve variable OK
"RTN","IB20P203",76,0)
 . D PROCESS(IBIFN,.OK)
"RTN","IB20P203",77,0)
 . ;
"RTN","IB20P203",78,0)
 . ; remove the 3,4,5 nodes if they were not there before
"RTN","IB20P203",79,0)
 . I 'TIFLAG D DELTI^IBCIUT4
"RTN","IB20P203",80,0)
 . Q
"RTN","IB20P203",81,0)
 ;
"RTN","IB20P203",82,0)
 I 'OK,'$D(ZTQUEUED) D
"RTN","IB20P203",83,0)
 . W !!,"The post-install routine failed due to too many tcp/ip failures with 1 bill."
"RTN","IB20P203",84,0)
 . W !,"Please check the error trap."
"RTN","IB20P203",85,0)
 . W !,"This routine will now intentionally crash."
"RTN","IB20P203",86,0)
 . W !!
"RTN","IB20P203",87,0)
 . Q
"RTN","IB20P203",88,0)
 ;
"RTN","IB20P203",89,0)
 I 'OK X "<BOOM>"    ; intentional crash
"RTN","IB20P203",90,0)
 ;
"RTN","IB20P203",91,0)
 I '$D(ZTQUEUED) W " Done"
"RTN","IB20P203",92,0)
 ;
"RTN","IB20P203",93,0)
EXIT ;
"RTN","IB20P203",94,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","IB20P203",95,0)
 Q
"RTN","IB20P203",96,0)
 ;
"RTN","IB20P203",97,0)
 ;
"RTN","IB20P203",98,0)
PROCESS(IBIFN,OK) ; Procedure to process 1 bill
"RTN","IB20P203",99,0)
 ; IBIFN is passed in as the internal bill#
"RTN","IB20P203",100,0)
 ; OK is an output parameter to determine if we can proceed
"RTN","IB20P203",101,0)
 ;
"RTN","IB20P203",102,0)
 NEW IBCIPECT,IBCIPZE
"RTN","IB20P203",103,0)
 S IBCIPECT=0,IBCIPZE=""         ; error variables
"RTN","IB20P203",104,0)
TRYAGN ;
"RTN","IB20P203",105,0)
 D SEND(IBIFN)                   ; send to ClaimsManager
"RTN","IB20P203",106,0)
 ;
"RTN","IB20P203",107,0)
 ; Control comes here after error trap processing
"RTN","IB20P203",108,0)
 ; and stack levels are unwound
"RTN","IB20P203",109,0)
 ;
"RTN","IB20P203",110,0)
 I IBCIPZE="" S OK=1 G PROCX     ; no errors, we're OK
"RTN","IB20P203",111,0)
 I IBCIPECT>5 S OK=0 G PROCX     ; too many errors, we're done
"RTN","IB20P203",112,0)
 HANG 2                          ; pause in between sendings
"RTN","IB20P203",113,0)
 G TRYAGN                        ; try again
"RTN","IB20P203",114,0)
PROCX ;
"RTN","IB20P203",115,0)
 Q
"RTN","IB20P203",116,0)
 ;
"RTN","IB20P203",117,0)
 ;
"RTN","IB20P203",118,0)
SEND(IBIFN) ; Send one bill to ClaimsManager
"RTN","IB20P203",119,0)
 NEW $ESTACK,$ETRAP
"RTN","IB20P203",120,0)
 S $ETRAP="D ERRTRP^IB20P203"
"RTN","IB20P203",121,0)
 S IBCISNT=4,IBCIPZE=""
"RTN","IB20P203",122,0)
 D ST2^IBCIST
"RTN","IB20P203",123,0)
 HANG 2
"RTN","IB20P203",124,0)
SENDX ;
"RTN","IB20P203",125,0)
 Q
"RTN","IB20P203",126,0)
 ;
"RTN","IB20P203",127,0)
 ;
"RTN","IB20P203",128,0)
ERRTRP ; Error Trap processing
"RTN","IB20P203",129,0)
 ;
"RTN","IB20P203",130,0)
 S IBCIPZE=$$EC^%ZOSV                         ; error message
"RTN","IB20P203",131,0)
 DO CLOSE^%ZISTCP                             ; close the tcp/ip port
"RTN","IB20P203",132,0)
 I $G(IBCISOCK) L -^IBCITCP(IBCISOCK)         ; unlock the port
"RTN","IB20P203",133,0)
 KILL ^TMP($J,"CMRESP2"),^TMP("IBCIMSG",$J)   ; kill scratch globals
"RTN","IB20P203",134,0)
 S IBCIPECT=IBCIPECT+1                        ; error count for this bill
"RTN","IB20P203",135,0)
 I IBCIPECT>5 D ^%ZTER                        ; log error if cascading
"RTN","IB20P203",136,0)
 I '$D(ZTQUEUED) D
"RTN","IB20P203",137,0)
 . W !!,"Error detected: ",IBCIPZE
"RTN","IB20P203",138,0)
 . W !,"       Bill ID: ",$P($G(^DGCR(399,IBIFN,0)),U,1)
"RTN","IB20P203",139,0)
 . W !,"   Error count: ",IBCIPECT
"RTN","IB20P203",140,0)
 . Q
"RTN","IB20P203",141,0)
 G UNWIND^%ZTER                               ; unwind stack levels
"RTN","IB20P203",142,0)
 ;
"RTN","IBCIADD1")
0^1^B33449123
"RTN","IBCIADD1",1,0)
IBCIADD1 ;DSI/SLM - ADD ENTRY TO FILE 351.9 ;17-JAN-2001
"RTN","IBCIADD1",2,0)
 ;;2.0;INTEGRATED BILLING;**161,203**;21-MAR-94
"RTN","IBCIADD1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCIADD1",4,0)
 ;
"RTN","IBCIADD1",5,0)
ADD ;add an entry
"RTN","IBCIADD1",6,0)
 Q:'IBIFN
"RTN","IBCIADD1",7,0)
 N FDA,IENS S IBCIADD=1
"RTN","IBCIADD1",8,0)
 S DIC="^IBA(351.9,",(X,DINUM)=IBIFN,DIC(0)="Z"
"RTN","IBCIADD1",9,0)
 D FILE^DICN I Y<0 W !!,IBIFN," NOT ADDED TO FILE 351.9" K Y Q
"RTN","IBCIADD1",10,0)
UPDT ; update an entry
"RTN","IBCIADD1",11,0)
 I $G(IBCISNT)=7 Q              ; esg - 1/3/2002
"RTN","IBCIADD1",12,0)
 ;
"RTN","IBCIADD1",13,0)
 ; esg - 3/20/02 - No need to rebuild the 3,4,5 nodes in the event of
"RTN","IBCIADD1",14,0)
 ;       a cancel because we want to send the claim lines that were
"RTN","IBCIADD1",15,0)
 ;       most recently sent to CM, not whatever Vista has now.
"RTN","IBCIADD1",16,0)
 ; esg - 10/9/02 - However, if the 3,4,5 nodes are not there, then we
"RTN","IBCIADD1",17,0)
 ;       need to rebuild them based on whatever Vista has now.
"RTN","IBCIADD1",18,0)
 ;
"RTN","IBCIADD1",19,0)
 I $G(IBCISNT)=4,$P($G(^IBA(351.9,IBIFN,3)),U,1) Q
"RTN","IBCIADD1",20,0)
 ;
"RTN","IBCIADD1",21,0)
 D CLEAN^IBCIUT2,DELTI^IBCIUT4
"RTN","IBCIADD1",22,0)
 I '$D(IBCIADD) S IBCIADD=0
"RTN","IBCIADD1",23,0)
 D INIT1
"RTN","IBCIADD1",24,0)
 S IENS=IBIFN_","
"RTN","IBCIADD1",25,0)
 S FDA(351.9,IENS,.02)=IBCIST
"RTN","IBCIADD1",26,0)
 I $P(^IBA(351.9,IBIFN,0),U,6)']"" D
"RTN","IBCIADD1",27,0)
 .S FDA(351.9,IENS,.06)=IBCIDE,FDA(351.9,IENS,.07)=IBCIEB
"RTN","IBCIADD1",28,0)
 S FDA(351.9,IENS,3.01)=IBCIPID,FDA(351.9,IENS,3.02)=IBCIPTLA
"RTN","IBCIADD1",29,0)
 S FDA(351.9,IENS,3.03)=IBCIPTMI,FDA(351.9,IENS,3.04)=IBCIPTFI
"RTN","IBCIADD1",30,0)
 S FDA(351.9,IENS,3.05)=IBCIDOB,FDA(351.9,IENS,3.06)=IBCISEX
"RTN","IBCIADD1",31,0)
 S FDA(351.9,IENS,3.07)=IBCIET
"RTN","IBCIADD1",32,0)
 D FILE^DIE("K","FDA"),UPDT1^IBCIST
"RTN","IBCIADD1",33,0)
 ;
"RTN","IBCIADD1",34,0)
 S IBCILSEG=0 F  S IBCILSEG=$O(IBXDATA(IBCILSEG)) Q:'IBCILSEG  D
"RTN","IBCIADD1",35,0)
 .I '$D(^IBA(351.9,IBIFN,5,IBCILSEG)) D ADDSUB
"RTN","IBCIADD1",36,0)
 .S DR=".06////"_IBCIBDOS(IBCILSEG)_";.02////"_IBCIXLID(IBCILSEG)
"RTN","IBCIADD1",37,0)
 .S DR=DR_";.03////"_IBCIOGID(IBCILSEG)_";.04////"_IBCIOID(IBCILSEG)
"RTN","IBCIADD1",38,0)
 .S DR=DR_";.07////"_IBCIEDOS(IBCILSEG)_";.08////"_IBCIPOS(IBCILSEG)
"RTN","IBCIADD1",39,0)
 .S DR=DR_";.09////"_IBCISPC(IBCILSEG)_";.1////"_IBCIAPC(IBCILSEG)
"RTN","IBCIADD1",40,0)
 .S DR=DR_";.11////"_IBCISAMT(IBCILSEG)_";.12////"_IBCIPAC(IBCILSEG)
"RTN","IBCIADD1",41,0)
 .S DIE="^IBA(351.9,"_IBIFN_",5,",DA=IBCILSEG,DA(1)=IBIFN D ^DIE
"RTN","IBCIADD1",42,0)
 .S DR=".13////"_IBCISPID(IBCILSEG)_";1.01////"_IBCISPLA(IBCILSEG)
"RTN","IBCIADD1",43,0)
 .S DR=DR_";1.02////"_IBCISPMI(IBCILSEG)_";1.03////"_IBCISPFI(IBCILSEG)
"RTN","IBCIADD1",44,0)
 .S DR=DR_";1.04////"_IBCISPTI(IBCILSEG)_";1.05////"_IBCISPDE(IBCILSEG)
"RTN","IBCIADD1",45,0)
 .S DIE="^IBA(351.9,"_IBIFN_",5,",DA=IBCILSEG,DA(1)=IBIFN D ^DIE
"RTN","IBCIADD1",46,0)
 .S DR="1.06////"_IBCISPSP(IBCILSEG)_";1.07////"_IBCISPDI(IBCILSEG)
"RTN","IBCIADD1",47,0)
 .S DR=DR_";1.08////"_IBCISPUP(IBCILSEG)_";1.09////"_IBCIBPID(IBCILSEG)
"RTN","IBCIADD1",48,0)
 .S DIE="^IBA(351.9,"_IBIFN_",5,",DA=IBCILSEG,DA(1)=IBIFN D ^DIE
"RTN","IBCIADD1",49,0)
 .S DR="2.01////"_IBCIBPLA(IBCILSEG)_";2.02////"_IBCIBPMI(IBCILSEG)
"RTN","IBCIADD1",50,0)
 .S DR=DR_";2.03////"_IBCIBPFI(IBCILSEG)_";2.04////"_IBCIBPTI(IBCILSEG)
"RTN","IBCIADD1",51,0)
 .S DR=DR_";2.05////"_IBCIBPDE(IBCILSEG)_";2.06////"_IBCIBPSP(IBCILSEG)
"RTN","IBCIADD1",52,0)
 .S DIE="^IBA(351.9,"_IBIFN_",5,",DA=IBCILSEG,DA(1)=IBIFN D ^DIE
"RTN","IBCIADD1",53,0)
 .S DR="2.07////"_IBCIBPDI(IBCILSEG)_";2.08////"_IBCIBPUP(IBCILSEG)
"RTN","IBCIADD1",54,0)
 .S DR=DR_";2.09////"_IBCIPPID(IBCILSEG)_";2.1////"_IBCISPAI(IBCILSEG)
"RTN","IBCIADD1",55,0)
 .S DR=DR_";2.11////"_IBCITOS(IBCILSEG)_";2.12////"_IBCIUNIT(IBCILSEG)
"RTN","IBCIADD1",56,0)
 .S DR=DR_";3.01////"_IBCICPT(IBCILSEG)
"RTN","IBCIADD1",57,0)
 .S DIE="^IBA(351.9,"_IBIFN_",5,",DA=IBCILSEG,DA(1)=IBIFN D ^DIE
"RTN","IBCIADD1",58,0)
 .Q
"RTN","IBCIADD1",59,0)
 D CLEAN^IBCIUT2 K IBCIADD
"RTN","IBCIADD1",60,0)
 Q
"RTN","IBCIADD1",61,0)
INIT1 ;initialize variables for adding entry in 351.9
"RTN","IBCIADD1",62,0)
 S IBCIDFN=$P(^DGCR(399,IBIFN,0),U,2)
"RTN","IBCIADD1",63,0)
 S IBCICL=$P(^DGCR(399,IBIFN,0),U)
"RTN","IBCIADD1",64,0)
 S IBCIST=$S(IBCIADD=1:1,1:$P(^IBA(351.9,IBIFN,0),U,2)),IBCIEB=DUZ
"RTN","IBCIADD1",65,0)
 S (IBCIDE,IBCIET)=$$NOW^XLFDT
"RTN","IBCIADD1",66,0)
 S IBCIPID=$P(^DPT(IBCIDFN,0),U,9)
"RTN","IBCIADD1",67,0)
 S X=$P(^DPT(IBCIDFN,0),U) D NAMSP^IBCIUT1
"RTN","IBCIADD1",68,0)
 S IBCIPTLA=$P(Y,U,1),IBCIPTFI=$P(Y,U,2),IBCIPTMI=$P(Y,U,3)
"RTN","IBCIADD1",69,0)
 S IBCIDOB=$P(^DPT(IBCIDFN,0),U,3),IBCISEX=$P(^DPT(IBCIDFN,0),U,2)
"RTN","IBCIADD1",70,0)
 ;
"RTN","IBCIADD1",71,0)
 ;initialize variables for line items in 351.9 and save
"RTN","IBCIADD1",72,0)
 D F^IBCEF("N-HCFA 1500 SERVICES (PRINT)",,,IBIFN)
"RTN","IBCIADD1",73,0)
 S IBCILSEG=0
"RTN","IBCIADD1",74,0)
 F  S IBCILSEG=$O(IBXDATA(IBCILSEG)) Q:'IBCILSEG  D
"RTN","IBCIADD1",75,0)
 . NEW CURRENT,DIV
"RTN","IBCIADD1",76,0)
 . S X=$P(IBXDATA(IBCILSEG),U),IBCIBDOS(IBCILSEG)=$$NOW1^IBCIUT1(X)
"RTN","IBCIADD1",77,0)
 . I $P(IBXDATA(IBCILSEG),U,2)]"" S X=$P(IBXDATA(IBCILSEG),U,2),IBCIEDOS(IBCILSEG)=$$NOW1^IBCIUT1(X)
"RTN","IBCIADD1",78,0)
 . I $P(IBXDATA(IBCILSEG),U,2)']"" S IBCIEDOS(IBCILSEG)=IBCIBDOS(IBCILSEG)
"RTN","IBCIADD1",79,0)
 . S IBCIPOS(IBCILSEG)=$P(IBXDATA(IBCILSEG),U,3)
"RTN","IBCIADD1",80,0)
 . S IBCITOS(IBCILSEG)=$P(IBXDATA(IBCILSEG),U,4)
"RTN","IBCIADD1",81,0)
 . S IBCISPC(IBCILSEG)=$P(IBXDATA(IBCILSEG),U,5)
"RTN","IBCIADD1",82,0)
 . S IBCISAMT(IBCILSEG)=$P(IBXDATA(IBCILSEG),U,8)
"RTN","IBCIADD1",83,0)
 . S IBCIUNIT(IBCILSEG)=$P(IBXDATA(IBCILSEG),U,9)
"RTN","IBCIADD1",84,0)
 . S IBCICPT(IBCILSEG)=$P(IBXDATA(IBCILSEG),U,10)
"RTN","IBCIADD1",85,0)
 . S IBCICPT(IBCILSEG)=$$GETMOD^IBCIUT5(IBCICPT(IBCILSEG))
"RTN","IBCIADD1",86,0)
 . I IBCIUNIT(IBCILSEG)>1 S IBCISAMT(IBCILSEG)=IBCISAMT(IBCILSEG)*IBCIUNIT(IBCILSEG)
"RTN","IBCIADD1",87,0)
 . S IBCIAPC(IBCILSEG)="",IBCIXLID(IBCILSEG)=IBCILSEG
"RTN","IBCIADD1",88,0)
 . S IBCIOGID(IBCILSEG)="",IBCIOID(IBCILSEG)="",IBCIPAC(IBCILSEG)=""
"RTN","IBCIADD1",89,0)
 . ;
"RTN","IBCIADD1",90,0)
 . ; capture the default division (field# .22) for the organization id
"RTN","IBCIADD1",91,0)
 . S DIV=$P($G(^DGCR(399,IBIFN,0)),U,22)
"RTN","IBCIADD1",92,0)
 . I DIV S IBCIOID(IBCILSEG)=$P($G(^DG(40.8,DIV,0)),U,2)
"RTN","IBCIADD1",93,0)
 . ;
"RTN","IBCIADD1",94,0)
 . ; Billing provider information
"RTN","IBCIADD1",95,0)
 . S IBXDAT1=$$RPHY^IBCIUT1(IBIFN)        ; Get provider information
"RTN","IBCIADD1",96,0)
 . S IBCIBPID(IBCILSEG)=$P(IBXDAT1,U,2)   ; provider ID
"RTN","IBCIADD1",97,0)
 . S X=$P(IBXDAT1,U,1) D NAMSP^IBCIUT1    ; parse full provider name
"RTN","IBCIADD1",98,0)
 . S IBCIBPLA(IBCILSEG)=$P(Y,U,1)         ; provider last name
"RTN","IBCIADD1",99,0)
 . S IBCIBPFI(IBCILSEG)=$P(Y,U,2)         ; provider first name
"RTN","IBCIADD1",100,0)
 . S IBCIBPMI(IBCILSEG)=$P(Y,U,3)         ; provider middle name
"RTN","IBCIADD1",101,0)
 . S IBCIBPDE(IBCILSEG)=$P(IBXDAT1,U,3)   ; provider department
"RTN","IBCIADD1",102,0)
 . S IBCIBPSP(IBCILSEG)=$P(IBXDAT1,U,4)   ; provider specialty
"RTN","IBCIADD1",103,0)
 . S IBCIBPDI(IBCILSEG)=""                ; provider degree ID
"RTN","IBCIADD1",104,0)
 . S IBCIBPTI(IBCILSEG)=""                ; provider title
"RTN","IBCIADD1",105,0)
 . S IBCIBPUP(IBCILSEG)=""                ; provider UPIN
"RTN","IBCIADD1",106,0)
 . KILL X,Y                               ; clean up
"RTN","IBCIADD1",107,0)
 . ;
"RTN","IBCIADD1",108,0)
 . ; Primary payer ID
"RTN","IBCIADD1",109,0)
 . S IBCIPPID(IBCILSEG)=$$FINDINS^IBCEF1(IBIFN)
"RTN","IBCIADD1",110,0)
 . ;
"RTN","IBCIADD1",111,0)
 . ; Get the secondary payer ID based on the current bill sequence
"RTN","IBCIADD1",112,0)
 . ;
"RTN","IBCIADD1",113,0)
 . S IBCISPAI(IBCILSEG)=""
"RTN","IBCIADD1",114,0)
 . S CURRENT=$$COB^IBCEF(IBIFN)
"RTN","IBCIADD1",115,0)
 . I CURRENT="P" S IBCISPAI(IBCILSEG)=$$FINDINS^IBCEF1(IBIFN,"S")
"RTN","IBCIADD1",116,0)
 . I CURRENT="S" S IBCISPAI(IBCILSEG)=$$FINDINS^IBCEF1(IBIFN,"T")
"RTN","IBCIADD1",117,0)
 . ;
"RTN","IBCIADD1",118,0)
 . S IBCISPID(IBCILSEG)="",IBCISPLA(IBCILSEG)="",IBCISPFI(IBCILSEG)=""
"RTN","IBCIADD1",119,0)
 . S IBCISPMI(IBCILSEG)="",IBCISPTI(IBCILSEG)="",IBCISPDE(IBCILSEG)=""
"RTN","IBCIADD1",120,0)
 . S IBCISPSP(IBCILSEG)="",IBCISPDI(IBCILSEG)="",IBCISPUP(IBCILSEG)=""
"RTN","IBCIADD1",121,0)
 . Q
"RTN","IBCIADD1",122,0)
 Q
"RTN","IBCIADD1",123,0)
 ;
"RTN","IBCIADD1",124,0)
ADDSUB ;create the subfile
"RTN","IBCIADD1",125,0)
 S DIC="^IBA(351.9,"_IBIFN_",5,",DA(1)=IBIFN,DIC(0)="LMN",(DA,X)=IBCILSEG
"RTN","IBCIADD1",126,0)
 D FILE^DICN
"RTN","IBCIADD1",127,0)
 Q
"VER")
8.0^22
**END**
**END**
