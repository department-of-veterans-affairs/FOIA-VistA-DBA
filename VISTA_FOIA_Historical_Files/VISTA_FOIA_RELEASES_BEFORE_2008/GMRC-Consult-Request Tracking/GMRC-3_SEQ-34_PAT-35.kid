Released GMRC*3*35 SEQ #34
Extracted from mail message
**KIDS**:GMRC*3.0*35^

**INSTALL NAME**
GMRC*3.0*35
"BLD",4509,0)
GMRC*3.0*35^CONSULT/REQUEST TRACKING^0^3030821^y
"BLD",4509,1,0)
^^2^2^3030710^
"BLD",4509,1,1,0)
Please refer to the National Patch Module for a complete list of the 
"BLD",4509,1,2,0)
enhancements included in this patch.
"BLD",4509,4,0)
^9.64PA^^
"BLD",4509,"KRN",0)
^9.67PA^8989.52^19
"BLD",4509,"KRN",.4,0)
.4
"BLD",4509,"KRN",.401,0)
.401
"BLD",4509,"KRN",.402,0)
.402
"BLD",4509,"KRN",.403,0)
.403
"BLD",4509,"KRN",.5,0)
.5
"BLD",4509,"KRN",.84,0)
.84
"BLD",4509,"KRN",3.6,0)
3.6
"BLD",4509,"KRN",3.8,0)
3.8
"BLD",4509,"KRN",9.2,0)
9.2
"BLD",4509,"KRN",9.8,0)
9.8
"BLD",4509,"KRN",9.8,"NM",0)
^9.68A^12^12
"BLD",4509,"KRN",9.8,"NM",1,0)
GMRCIAC2^^0^B37911897
"BLD",4509,"KRN",9.8,"NM",2,0)
GMRCIERR^^0^B68981625
"BLD",4509,"KRN",9.8,"NM",3,0)
GMRCIBKG^^0^B39458433
"BLD",4509,"KRN",9.8,"NM",4,0)
GMRCGUIA^^0^B46080556
"BLD",4509,"KRN",9.8,"NM",5,0)
GMRCTIUE^^0^B60104951
"BLD",4509,"KRN",9.8,"NM",6,0)
GMRCA1^^0^B31122470
"BLD",4509,"KRN",9.8,"NM",7,0)
GMRCASF^^0^B15424703
"BLD",4509,"KRN",9.8,"NM",8,0)
GMRCADC^^0^B12725980
"BLD",4509,"KRN",9.8,"NM",9,0)
GMRCAFRD^^0^B37961904
"BLD",4509,"KRN",9.8,"NM",10,0)
GMRCP5D^^0^B50959922
"BLD",4509,"KRN",9.8,"NM",11,0)
GMRCACMT^^0^B27403570
"BLD",4509,"KRN",9.8,"NM",12,0)
GMRCGUIB^^0^B39851161
"BLD",4509,"KRN",9.8,"NM","B","GMRCA1",6)

"BLD",4509,"KRN",9.8,"NM","B","GMRCACMT",11)

"BLD",4509,"KRN",9.8,"NM","B","GMRCADC",8)

"BLD",4509,"KRN",9.8,"NM","B","GMRCAFRD",9)

"BLD",4509,"KRN",9.8,"NM","B","GMRCASF",7)

"BLD",4509,"KRN",9.8,"NM","B","GMRCGUIA",4)

"BLD",4509,"KRN",9.8,"NM","B","GMRCGUIB",12)

"BLD",4509,"KRN",9.8,"NM","B","GMRCIAC2",1)

"BLD",4509,"KRN",9.8,"NM","B","GMRCIBKG",3)

"BLD",4509,"KRN",9.8,"NM","B","GMRCIERR",2)

"BLD",4509,"KRN",9.8,"NM","B","GMRCP5D",10)

"BLD",4509,"KRN",9.8,"NM","B","GMRCTIUE",5)

"BLD",4509,"KRN",19,0)
19
"BLD",4509,"KRN",19.1,0)
19.1
"BLD",4509,"KRN",101,0)
101
"BLD",4509,"KRN",409.61,0)
409.61
"BLD",4509,"KRN",771,0)
771
"BLD",4509,"KRN",870,0)
870
"BLD",4509,"KRN",8989.51,0)
8989.51
"BLD",4509,"KRN",8989.52,0)
8989.52
"BLD",4509,"KRN",8994,0)
8994
"BLD",4509,"KRN","B",.4,.4)

"BLD",4509,"KRN","B",.401,.401)

"BLD",4509,"KRN","B",.402,.402)

"BLD",4509,"KRN","B",.403,.403)

"BLD",4509,"KRN","B",.5,.5)

"BLD",4509,"KRN","B",.84,.84)

"BLD",4509,"KRN","B",3.6,3.6)

"BLD",4509,"KRN","B",3.8,3.8)

"BLD",4509,"KRN","B",9.2,9.2)

"BLD",4509,"KRN","B",9.8,9.8)

"BLD",4509,"KRN","B",19,19)

"BLD",4509,"KRN","B",19.1,19.1)

"BLD",4509,"KRN","B",101,101)

"BLD",4509,"KRN","B",409.61,409.61)

"BLD",4509,"KRN","B",771,771)

"BLD",4509,"KRN","B",870,870)

"BLD",4509,"KRN","B",8989.51,8989.51)

"BLD",4509,"KRN","B",8989.52,8989.52)

"BLD",4509,"KRN","B",8994,8994)

"BLD",4509,"QUES",0)
^9.62^^
"BLD",4509,"REQB",0)
^9.611^4^4
"BLD",4509,"REQB",1,0)
GMRC*3.0*30^2
"BLD",4509,"REQB",2,0)
GMRC*3.0*17^2
"BLD",4509,"REQB",3,0)
GMRC*3.0*18^2
"BLD",4509,"REQB",4,0)
GMRC*3.0*29^2
"BLD",4509,"REQB","B","GMRC*3.0*17",2)

"BLD",4509,"REQB","B","GMRC*3.0*18",3)

"BLD",4509,"REQB","B","GMRC*3.0*29",4)

"BLD",4509,"REQB","B","GMRC*3.0*30",1)

"MBREQ")
0
"PKG",128,-1)
1^1
"PKG",128,0)
CONSULT/REQUEST TRACKING^GMRC^13
"PKG",128,20,0)
^9.402P^^
"PKG",128,22,0)
^9.49I^1^1
"PKG",128,22,1,0)
3.0^2980101
"PKG",128,22,1,"PAH",1,0)
35^3030821
"PKG",128,22,1,"PAH",1,1,0)
^^2^2^3030821
"PKG",128,22,1,"PAH",1,1,1,0)
Please refer to the National Patch Module for a complete list of the 
"PKG",128,22,1,"PAH",1,1,2,0)
enhancements included in this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","GMRCA1")
0^6^B31122470
"RTN","GMRCA1",1,0)
GMRCA1 ;SLC/DLT,DCM - Actions taken from Review Screens ; 7/11/03 14:05
"RTN","GMRCA1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,10,12,18,35**;DEC 27, 1997
"RTN","GMRCA1",3,0)
 ; Patch 18 addS the option to Edit/Resubmit a canceled consult
"RTN","GMRCA1",4,0)
 ; This routine invokes IA #867,#2424
"RTN","GMRCA1",5,0)
 ;
"RTN","GMRCA1",6,0)
DC(GMRCO,GMRCA) ;Discontinue/Cancel(Deny) logic
"RTN","GMRCA1",7,0)
 ;GMRCO = File 123 IEN of consult
"RTN","GMRCA1",8,0)
 ;GMRCA = Action to take: 6=DISCONTINUED, 19=CANCELLED
"RTN","GMRCA1",9,0)
 ;GMRCOM=comments array
"RTN","GMRCA1",10,0)
 I '$G(GMRCA) D  Q
"RTN","GMRCA1",11,0)
 . S GMRCMSG="This Action not defined!"
"RTN","GMRCA1",12,0)
 . D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCA1",13,0)
 . D END
"RTN","GMRCA1",14,0)
 . S GMRCQUT=1
"RTN","GMRCA1",15,0)
 K GMRCQUT,GMRCQIT
"RTN","GMRCA1",16,0)
 D DC^GMRCADC(GMRCO,GMRCA)
"RTN","GMRCA1",17,0)
 D END
"RTN","GMRCA1",18,0)
 Q
"RTN","GMRCA1",19,0)
 ;
"RTN","GMRCA1",20,0)
COMMENT(GMRCO) ;Add a comment without changing the status
"RTN","GMRCA1",21,0)
 N GMRCA,GMRCLCK
"RTN","GMRCA1",22,0)
 K GMRCQUT,GMRCQIT
"RTN","GMRCA1",23,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCA1",24,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",25,0)
 I '$$LOCK(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",26,0)
 S GMRCLCK=1
"RTN","GMRCA1",27,0)
 D COMMENT^GMRCACMT(+GMRCO)
"RTN","GMRCA1",28,0)
 D END
"RTN","GMRCA1",29,0)
 Q
"RTN","GMRCA1",30,0)
 ;
"RTN","GMRCA1",31,0)
EDTSUB(GMRCO) ;Patch 18 Edit/Resubmit a canceled consult
"RTN","GMRCA1",32,0)
 N GMRCA,GMRCLCK,GMRCDFN,GMRCMSG
"RTN","GMRCA1",33,0)
 K GMRCQUT,GMRCQIT
"RTN","GMRCA1",34,0)
 S XQORM("M")=3
"RTN","GMRCA1",35,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCA1",36,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",37,0)
 ;
"RTN","GMRCA1",38,0)
 ; Check to see if Provider or Update user is doing Edit/Resubmit
"RTN","GMRCA1",39,0)
 I '$$VALPROV^GMRCEDIT(GMRCO) D
"RTN","GMRCA1",40,0)
 .S GMRCMSG="0^You are not the provider of this Consult or a Update User"
"RTN","GMRCA1",41,0)
 I $P(^GMR(123,GMRCO,0),"^",12)'=13 D     ; If not a canceled Consult
"RTN","GMRCA1",42,0)
 . S GMRCMSG="0^This consult is no longer editable."
"RTN","GMRCA1",43,0)
 I $D(GMRCMSG) D EXAC^GMRCADC($P(GMRCMSG,"^",2)) D END S GMRCQUT=1 Q
"RTN","GMRCA1",44,0)
 I '$$LOCK(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",45,0)
 S GMRCLCK=1
"RTN","GMRCA1",46,0)
 S GMRCDFN=$P(^GMR(123,GMRCO,0),"^",2) ; Get patient DFN
"RTN","GMRCA1",47,0)
 I $D(GMRCQUT) Q
"RTN","GMRCA1",48,0)
 D EN^GMRCEDIT(GMRCO,","_+GMRCDFN)  ; Bring up Edit & Resubmit screen.
"RTN","GMRCA1",49,0)
 D END
"RTN","GMRCA1",50,0)
 Q
"RTN","GMRCA1",51,0)
 ;
"RTN","GMRCA1",52,0)
RC(GMRCO,GMRCSCH) ;Service tracking request received or scheduled
"RTN","GMRCA1",53,0)
 ; GMRCSCH=1  - schedule action
"RTN","GMRCA1",54,0)
 K GMRCQUT,GMRCQIT,GMRCSEL,GMRCAGN
"RTN","GMRCA1",55,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCA1",56,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",57,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D  Q
"RTN","GMRCA1",58,0)
 . N DIR
"RTN","GMRCA1",59,0)
 . W !,"The requesting facility may not take this action on an "
"RTN","GMRCA1",60,0)
 . W "inter-facility consult."
"RTN","GMRCA1",61,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCA1",62,0)
 . D END
"RTN","GMRCA1",63,0)
 . S GMRCQUT=1
"RTN","GMRCA1",64,0)
 I '$$LOCK(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",65,0)
 ;
"RTN","GMRCA1",66,0)
 N GMRCDA,GMRCIFN,GMRCLCK,GMRCAD
"RTN","GMRCA1",67,0)
 S GMRCLCK=1
"RTN","GMRCA1",68,0)
 S GMRC(0)=^GMR(123,GMRCO,0)
"RTN","GMRCA1",69,0)
 S DFN=$P(GMRC(0),"^",2)
"RTN","GMRCA1",70,0)
 I $S($P(GMRC(0),"^",12)=2:1,$P(^(0),"^",12)=1:1,$P(^(0),"^",12)=13:1,1:0) D  S GMRCQUT=1 D END Q
"RTN","GMRCA1",71,0)
 .S GMRCMSG="This consult has already been "_$S($P(GMRC(0),"^",12)=2:"Completed",$P(^(0),"^",12)=13:"Cancelled",1:"Discontinued")_"."
"RTN","GMRCA1",72,0)
 .S GMRCMSG(1)=" This action may not be taken now."
"RTN","GMRCA1",73,0)
 .D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCA1",74,0)
 .K GMRCMSG
"RTN","GMRCA1",75,0)
 .Q
"RTN","GMRCA1",76,0)
 ;I $P(^GMR(123.5,$P(GMRC(0),"^",5),0),"^",2)=9 S GMRCMSG=$P(^(0),"^",1)_" is an INACTIVE service. No Receive action is possible",GMRCMSG(1)="for this consult on this Service!" D EXAC^GMRCADC(.GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCA1",77,0)
 I '$G(GMRCSCH),$P(GMRC(0),"^",12)'=5 D  Q
"RTN","GMRCA1",78,0)
 . S GMRCMSG="The receive action may only be taken when the consult"
"RTN","GMRCA1",79,0)
 . S GMRCMSG=GMRCMSG_" has a pending status."
"RTN","GMRCA1",80,0)
 . D EXAC^GMRCADC(GMRCMSG),END
"RTN","GMRCA1",81,0)
 . S GMRCQUT=1
"RTN","GMRCA1",82,0)
 I $G(GMRCSCH),"56"'[$P(GMRC(0),"^",12) D  Q
"RTN","GMRCA1",83,0)
 . S GMRCMSG="This consult may not be scheduled with the current status"
"RTN","GMRCA1",84,0)
 . D EXAC^GMRCADC(GMRCMSG),END
"RTN","GMRCA1",85,0)
 . S GMRCQUT=1
"RTN","GMRCA1",86,0)
 ;
"RTN","GMRCA1",87,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCA1",88,0)
 N GETPROV
"RTN","GMRCA1",89,0)
 S GETPROV=$S($G(GMRCSCH):"Who scheduled it?",1:"Who received it?")
"RTN","GMRCA1",90,0)
 D GETPROV^GMRCAU K GETPROV I $D(GMRCQIT) D END S GMRCQIT="Q",GMRCQUT=1 Q
"RTN","GMRCA1",91,0)
 I '$G(GMRCSCH) S GMRCAD=$$GETDT^GMRCUTL1("Date/Time Actually Received")
"RTN","GMRCA1",92,0)
 I $G(GMRCSCH) S GMRCAD=$$NOW^XLFDT
"RTN","GMRCA1",93,0)
 I GMRCAD="^" D  Q
"RTN","GMRCA1",94,0)
 . W !,$C(7) D EXAC^GMRCADC("Consult not updated with Received action.")
"RTN","GMRCA1",95,0)
 . D END
"RTN","GMRCA1",96,0)
 . S GMRCQUT=1
"RTN","GMRCA1",97,0)
 ;The activity date is stored in GMRCAD
"RTN","GMRCA1",98,0)
 I '$G(GMRCSCH) D
"RTN","GMRCA1",99,0)
 . S GMRCA=21 ;for "Received"
"RTN","GMRCA1",100,0)
 . I $P(GMRC(0),"^",12)=5 S GMRCSTS=6,$P(GMRC(0),"^",12)=GMRCSTS
"RTN","GMRCA1",101,0)
 . E  S GMRCSTS=$P(GMRC(0),"^",12)
"RTN","GMRCA1",102,0)
 I $G(GMRCSCH) S GMRCA=8,GMRCSTS=8
"RTN","GMRCA1",103,0)
 D STATUS^GMRCP
"RTN","GMRCA1",104,0)
 S GMRCOM=1 D AUDIT^GMRCP
"RTN","GMRCA1",105,0)
 D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCWARD),"SC",GMRCORNP,$G(GMRCVSIT),.GMRCOM,,$G(GMRCAD))
"RTN","GMRCA1",106,0)
 I $G(GMRCSCH),$P(GMRCOM,U,2)=1 D
"RTN","GMRCA1",107,0)
 . N TXT S TXT="Scheduled Consult: "
"RTN","GMRCA1",108,0)
 . D PROCALRT^GMRCACMT(TXT,"",20,GMRCO)
"RTN","GMRCA1",109,0)
 D END
"RTN","GMRCA1",110,0)
 Q
"RTN","GMRCA1",111,0)
 ;
"RTN","GMRCA1",112,0)
RT(GMRCO) ;Results Display logic
"RTN","GMRCA1",113,0)
 K GMRCQUT,GMRCQIT
"RTN","GMRCA1",114,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCA1",115,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",116,0)
 D RT^GMRCART(GMRCO)
"RTN","GMRCA1",117,0)
 D END
"RTN","GMRCA1",118,0)
 Q
"RTN","GMRCA1",119,0)
 ;
"RTN","GMRCA1",120,0)
PS(GMRCO) ;Print Service Copy (CPRS entry point)
"RTN","GMRCA1",121,0)
 K GMRCQUT,GMRCQIT,GMRCSEL
"RTN","GMRCA1",122,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCA1",123,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCA1",124,0)
 S GMRC(0)=^GMR(123,GMRCO,0)
"RTN","GMRCA1",125,0)
 D EN^GMRCP5(GMRCO)
"RTN","GMRCA1",126,0)
 D END
"RTN","GMRCA1",127,0)
 Q
"RTN","GMRCA1",128,0)
 ;
"RTN","GMRCA1",129,0)
END ;kill off variables and exit
"RTN","GMRCA1",130,0)
 I $G(GMRCLCK) D UNLOCK(GMRCO)
"RTN","GMRCA1",131,0)
 I '$D(GMRC("NMBR")) K GMRCSEL,GMRCO
"RTN","GMRCA1",132,0)
 K GMRC(0),GMRCA,GMRCACTM,GMRCAGN,GMRCDFN,GMRCENTR,GMRCFL,GMRCIEN,GMRCMSG,GMRCOM,GMRCO,GMRCORFN,GMRCORN,GMRCORTX,GMRCRTFL,GMRCSEL,GMRCSTS,GMRCTRLC,GMRCEND,GMRCSA,GMRCSR,GMRCBM,GMRCTM,GMRCADUZ,ORIFN,OREND,SF,STS
"RTN","GMRCA1",133,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCA1",134,0)
 K DTOUT,DIROUT,DUOUT
"RTN","GMRCA1",135,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCA1",136,0)
 Q
"RTN","GMRCA1",137,0)
LOCK(GMRCIFN) ;;lock a consult record using OE/RR order number
"RTN","GMRCA1",138,0)
 N GMRCORD,GMRCLOCK
"RTN","GMRCA1",139,0)
 S GMRCORD=$P($G(^GMR(123,GMRCIFN,0)),U,3) Q:'GMRCORD 1
"RTN","GMRCA1",140,0)
 S GMRCLOCK=$$LOCK1^ORX2(GMRCORD) I +GMRCLOCK Q 1
"RTN","GMRCA1",141,0)
 ;Q:$G(GMRCGUI)
"RTN","GMRCA1",142,0)
 D EXAC^GMRCADC($P(GMRCLOCK,U,2))
"RTN","GMRCA1",143,0)
 Q 0
"RTN","GMRCA1",144,0)
UNLOCK(GMRCIFN) ;unlock a consult record using OE/RR order number
"RTN","GMRCA1",145,0)
 N GMRCORD
"RTN","GMRCA1",146,0)
 S GMRCORD=$P($G(^GMR(123,GMRCIFN,0)),U,3) Q:'GMRCORD
"RTN","GMRCA1",147,0)
 D UNLK1^ORX2(GMRCORD)
"RTN","GMRCA1",148,0)
 Q
"RTN","GMRCACMT")
0^11^B27403570
"RTN","GMRCACMT",1,0)
GMRCACMT ;SLC/DLT,DCM,MA,JFR - Comment Action and alerting ;8/19/03 07:27
"RTN","GMRCACMT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,14,18,20,22,29,35**;DEC 27, 1997
"RTN","GMRCACMT",3,0)
 ; This routine invokes IA #10060
"RTN","GMRCACMT",4,0)
 ;
"RTN","GMRCACMT",5,0)
COMMENT(GMRCO) ;Add a comment without changing the status
"RTN","GMRCACMT",6,0)
 K GMRCQIT,GMRCQUT N GMRCA
"RTN","GMRCACMT",7,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCACMT",8,0)
 S GMRCNOW=$$NOW^XLFDT,GMRCAD=GMRCNOW
"RTN","GMRCACMT",9,0)
 S GMRCOM=1,GMRCA=20,GMRCPROV=$P(^GMR(123,GMRCO,0),"^",14) D AUDIT^GMRCP
"RTN","GMRCACMT",10,0)
 ; GMRCOM=1 defined the variable and tells AUDIT^GMRCP that the 
"RTN","GMRCACMT",11,0)
 ; word-processing logic should be executed. If an actual comment is 
"RTN","GMRCACMT",12,0)
 ; added, $P(GMRCOM,"^",2)=1 (send alert), if not GMRCOM=1 and no '^' 
"RTN","GMRCACMT",13,0)
 ; exists (do not send alert)
"RTN","GMRCACMT",14,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCACMT",15,0)
 ;continue if no lock problems occurred
"RTN","GMRCACMT",16,0)
 I $P(GMRCOM,"^",2) D
"RTN","GMRCACMT",17,0)
 . I $P($G(^GMR(123,GMRCO,12)),U,5)="F" D
"RTN","GMRCACMT",18,0)
 .. W !!,"The ordering provider for this inter-facility consult will"
"RTN","GMRCACMT",19,0)
 .. W " automatically be ",!,"notified.",!
"RTN","GMRCACMT",20,0)
 . D PROCALRT("",1,20,GMRCO)
"RTN","GMRCACMT",21,0)
 . ;update LAST ACTION field even though no status change
"RTN","GMRCACMT",22,0)
 . N GMRCDR,GMRCSTS
"RTN","GMRCACMT",23,0)
 . S GMRCSTS="",GMRCDR="9////20"
"RTN","GMRCACMT",24,0)
 . D STATUS^GMRCP
"RTN","GMRCACMT",25,0)
 D END
"RTN","GMRCACMT",26,0)
 Q
"RTN","GMRCACMT",27,0)
 ;
"RTN","GMRCACMT",28,0)
PROCALRT(GMRCORTX,GMRCDELR,ACTION,GMRCO) ;Process alert for comments
"RTN","GMRCACMT",29,0)
 ;If GMRCDELR=1, the ordering provider can be deleted from the list.
"RTN","GMRCACMT",30,0)
 N GMRCADUZ,GMRCANS,NOTIF,GMRCQIT,GMRCTM
"RTN","GMRCACMT",31,0)
 ;S GMRCANS=$$READ("Y","Do You Wish To Send An Alert With This Comment","N","Enter Y to continue with recipient prompts. Otherwise, enter N.",1)
"RTN","GMRCACMT",32,0)
 ;I (GMRCANS[U)!(GMRCANS=0) D END Q
"RTN","GMRCACMT",33,0)
 ;
"RTN","GMRCACMT",34,0)
 D WHOTO
"RTN","GMRCACMT",35,0)
 ;I $G(GMRCQIT) D END Q  ;User "^" at requesting provider.
"RTN","GMRCACMT",36,0)
 ;
"RTN","GMRCACMT",37,0)
 N GMRCALT
"RTN","GMRCACMT",38,0)
 S NOTIF=$S(ACTION=20:63,ACTION=8:63,1:23)
"RTN","GMRCACMT",39,0)
 ;
"RTN","GMRCACMT",40,0)
 D SENDMSG(NOTIF,+GMRCO,$G(GMRCTM))
"RTN","GMRCACMT",41,0)
 Q
"RTN","GMRCACMT",42,0)
 ;
"RTN","GMRCACMT",43,0)
SENDMSG(NOTIF,GMRCO,GMRCATM) ;Send the alert
"RTN","GMRCACMT",44,0)
 N GMRCDFN
"RTN","GMRCACMT",45,0)
 I '$D(GMRCADUZ) S GMRCADUZ=""
"RTN","GMRCACMT",46,0)
 W !,"Processing Alerts..."
"RTN","GMRCACMT",47,0)
 S GMRCDFN=$P($G(^GMR(123,+GMRCO,0)),"^",2)
"RTN","GMRCACMT",48,0)
 I '$L(GMRCORTX) D
"RTN","GMRCACMT",49,0)
 . N TXT
"RTN","GMRCACMT",50,0)
 . S TXT="Comment Added to "
"RTN","GMRCACMT",51,0)
 . I $P($G(^GMR(123,GMRCO,12)),U,5)='"P" S GMRCORTX=TXT_"consult " Q
"RTN","GMRCACMT",52,0)
 . S GMRCORTX=TXT_"remote consult "
"RTN","GMRCACMT",53,0)
 S GMRCORTX=GMRCORTX_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCACMT",54,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,NOTIF,.GMRCADUZ,$G(GMRCATM))
"RTN","GMRCACMT",55,0)
 Q
"RTN","GMRCACMT",56,0)
 ;
"RTN","GMRCACMT",57,0)
END ;kill off variables and exit
"RTN","GMRCACMT",58,0)
 K GMRC,GMRCA,GMRCMSG,GMRCOM,GMRCO,GMRCORTX,GMRCERR,GMRCERMS,GMRCQUT,GMRCUT
"RTN","GMRCACMT",59,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCACMT",60,0)
 K DTOUT,DIROUT,DUOUT,DIRUT
"RTN","GMRCACMT",61,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCACMT",62,0)
 Q
"RTN","GMRCACMT",63,0)
 ;
"RTN","GMRCACMT",64,0)
WHOTO ;Get the users who should receive an alert
"RTN","GMRCACMT",65,0)
 ;Asks about requesting provider first, then prompts for additional users
"RTN","GMRCACMT",66,0)
 ;Returns GMRCADUZ array of users to send an alert to and GMRCQIT if "^"
"RTN","GMRCACMT",67,0)
 N GMRCRP,GMRCANS,GMRCUPD
"RTN","GMRCACMT",68,0)
 S GMRCRP=+$P($G(^GMR(123,+GMRCO,0)),U,14) ;requesting provider entry
"RTN","GMRCACMT",69,0)
 S GMRCUPD=$$VALID^GMRCAU($P(^GMR(123,+GMRCO,0),U,5),GMRCO,DUZ)
"RTN","GMRCACMT",70,0)
 I GMRCRP=DUZ D  ;alert team if ord. prov. takes the action
"RTN","GMRCACMT",71,0)
 . S GMRCTM=1
"RTN","GMRCACMT",72,0)
 . W !,"Service update users will be notified.",!
"RTN","GMRCACMT",73,0)
 I GMRCUPD D  ; alert ord. prov if update users takes action
"RTN","GMRCACMT",74,0)
 . S GMRCADUZ(GMRCRP)=""
"RTN","GMRCACMT",75,0)
 . W !,"Requesting provider will be notified.",!
"RTN","GMRCACMT",76,0)
 I '$G(GMRCTM),'GMRCUPD D  ;alert both if not ord. prov or update user
"RTN","GMRCACMT",77,0)
 . S GMRCTM=1,GMRCADUZ(GMRCRP)=""
"RTN","GMRCACMT",78,0)
 . W !,"Requesting provider and service update users will be notified.",!
"RTN","GMRCACMT",79,0)
 ;
"RTN","GMRCACMT",80,0)
 ;
"RTN","GMRCACMT",81,0)
ANDTO ;Ask for additional recipients
"RTN","GMRCACMT",82,0)
 D NAMELIST("Additional alert recipients: ",.GMRCADUZ,GMRCDELR)
"RTN","GMRCACMT",83,0)
 Q
"RTN","GMRCACMT",84,0)
 ;
"RTN","GMRCACMT",85,0)
NAMELIST(GMRCP,GMRCOLD,GMRCDELR) ;manage the list of recipients
"RTN","GMRCACMT",86,0)
 ;
"RTN","GMRCACMT",87,0)
 ; GMRCP - Prompt
"RTN","GMRCACMT",88,0)
 ; GMRCOLD - Original list with ordering provider.
"RTN","GMRCACMT",89,0)
 ; GMRCDELR - 1 means the original list may have names deleted
"RTN","GMRCACMT",90,0)
 ; Returns final list in GMRCOLD array
"RTN","GMRCACMT",91,0)
 ;
"RTN","GMRCACMT",92,0)
 N GMRCNEW,GMRCNT,GMRCDUZ,GMRCUSER,GMRCQ,GMRCADD,DIC,X,Y
"RTN","GMRCACMT",93,0)
 ;
"RTN","GMRCACMT",94,0)
 M GMRCNEW=GMRCOLD
"RTN","GMRCACMT",95,0)
 I GMRCDELR=1 K GMRCOLD S GMRCOLD="" ;Remove mandatory users from GMRCOLD
"RTN","GMRCACMT",96,0)
 S GMRCNT=0 F  D  Q:(GMRCUSER[U)
"RTN","GMRCACMT",97,0)
 .S GMRCUSER=$$READ("FAO;3;46",$S(GMRCNT:"And ",1:"")_GMRCP,"","^D NAMEHELP^GMRCACMT")
"RTN","GMRCACMT",98,0)
 .S:'$L(GMRCUSER) GMRCUSER=U Q:(GMRCUSER[U)
"RTN","GMRCACMT",99,0)
 .I ($E(GMRCUSER,1)="-") S GMRCADD=0,GMRCUSER=$E(GMRCUSER,2,$L(GMRCUSER))
"RTN","GMRCACMT",100,0)
 .E  S GMRCADD=1
"RTN","GMRCACMT",101,0)
 .;
"RTN","GMRCACMT",102,0)
 .S X=GMRCUSER,DIC=200,DIC(0)="EMQ" D ^DIC
"RTN","GMRCACMT",103,0)
 .;
"RTN","GMRCACMT",104,0)
 .I (Y>0) D  I 1
"RTN","GMRCACMT",105,0)
 ..;W $E($P(Y,U,2),$L(GMRCUSER)+1,$L($P(Y,U,2)))
"RTN","GMRCACMT",106,0)
 ..;
"RTN","GMRCACMT",107,0)
 ..I GMRCADD D
"RTN","GMRCACMT",108,0)
 ...I $D(GMRCNEW(+Y)) W " already in the list." Q
"RTN","GMRCACMT",109,0)
 ...S GMRCNEW(+Y)="" W " added to the list." S GMRCNT=GMRCNT+1
"RTN","GMRCACMT",110,0)
 ..;
"RTN","GMRCACMT",111,0)
 ..I 'GMRCADD D
"RTN","GMRCACMT",112,0)
 ...I $D(GMRCOLD(+Y)) W " can't delete this name from the list." Q
"RTN","GMRCACMT",113,0)
 ...I '$D(GMRCNEW(+Y)) W " not currently in the list." Q
"RTN","GMRCACMT",114,0)
 ...K GMRCNEW(+Y) S GMRCNT=GMRCNT-1 W " deleted from the list."
"RTN","GMRCACMT",115,0)
 .;
"RTN","GMRCACMT",116,0)
 .E  I $L(GMRCUSER) W "  Name not found."
"RTN","GMRCACMT",117,0)
 ;
"RTN","GMRCACMT",118,0)
 M GMRCOLD=GMRCNEW
"RTN","GMRCACMT",119,0)
 Q
"RTN","GMRCACMT",120,0)
 ;
"RTN","GMRCACMT",121,0)
READ(GMRC0,GMRCA,GMRCB,GMRCH,GMRCL) ;read logic
"RTN","GMRCACMT",122,0)
 ;
"RTN","GMRCACMT",123,0)
 ;  GMRC0 -> DIR(0) --- Type of read
"RTN","GMRCACMT",124,0)
 ;  GMRCA -> DIR("A") - Prompt
"RTN","GMRCACMT",125,0)
 ;  GMRCB -> DIR("B") - Default Answer
"RTN","GMRCACMT",126,0)
 ;  GMRCH -> DIR("?") - Help text or ^Execute code
"RTN","GMRCACMT",127,0)
 ;  GMRCL -> Number of blank lines to put before Prompt
"RTN","GMRCACMT",128,0)
 ;
"RTN","GMRCACMT",129,0)
 ;  Returns "^" or answer
"RTN","GMRCACMT",130,0)
 ;
"RTN","GMRCACMT",131,0)
 N GMRCLINE,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCACMT",132,0)
 Q:'$L($G(GMRC0)) U
"RTN","GMRCACMT",133,0)
 S DIR(0)=GMRC0
"RTN","GMRCACMT",134,0)
 S:$L($G(GMRCA)) DIR("A")=GMRCA
"RTN","GMRCACMT",135,0)
 S:$L($G(GMRCB)) DIR("B")=GMRCB
"RTN","GMRCACMT",136,0)
 S:$L($G(GMRCH)) DIR("?")=GMRCH
"RTN","GMRCACMT",137,0)
 F GMRCLINE=1:1:($G(GMRCL)-1) W !
"RTN","GMRCACMT",138,0)
 D ^DIR
"RTN","GMRCACMT",139,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q U
"RTN","GMRCACMT",140,0)
 Q Y
"RTN","GMRCACMT",141,0)
 ;
"RTN","GMRCACMT",142,0)
 ;
"RTN","GMRCACMT",143,0)
NAMEHELP ;Help for the recipient list logic
"RTN","GMRCACMT",144,0)
 N GMRCDUZ
"RTN","GMRCACMT",145,0)
 W !,"Enter the name of the user to send the alert to,"
"RTN","GMRCACMT",146,0)
 W !," or put a '-' in front of a name to delete from the list."
"RTN","GMRCACMT",147,0)
 W !
"RTN","GMRCACMT",148,0)
 W !,"  Example:"
"RTN","GMRCACMT",149,0)
 W !,"     SMITH,FRED  ->  to add Fred to the list."
"RTN","GMRCACMT",150,0)
 W !,"     -SMITH,FRED ->  to delete Fred from the list."
"RTN","GMRCACMT",151,0)
 W !,"Already selected: "
"RTN","GMRCACMT",152,0)
 W !
"RTN","GMRCACMT",153,0)
 S GMRCDUZ=0 F  S GMRCDUZ=$O(GMRCNEW(GMRCDUZ)) Q:'GMRCDUZ  D
"RTN","GMRCACMT",154,0)
 .W !,?5,$P(^VA(200,GMRCDUZ,0),U,1)
"RTN","GMRCACMT",155,0)
 .W:$D(GMRCOLD(GMRCDUZ)) "  <mandatory>"
"RTN","GMRCACMT",156,0)
 W !
"RTN","GMRCACMT",157,0)
 Q
"RTN","GMRCACMT",158,0)
 ;
"RTN","GMRCADC")
0^8^B12725980
"RTN","GMRCADC",1,0)
GMRCADC ;SLC/DLT/DCM - DC taken from List Manager ;8/07/03 14:10
"RTN","GMRCADC",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5,10,12,35**;DEC 27, 1997
"RTN","GMRCADC",3,0)
EXAC(MSG) ;Exit message asking for user to press <ENTER>; EXAC=Exit Action
"RTN","GMRCADC",4,0)
 N ND,X
"RTN","GMRCADC",5,0)
 W $C(7),!,MSG I $O(MSG(0)) S ND=0 F  S ND=$O(MSG(ND)) Q:ND=""  D
"RTN","GMRCADC",6,0)
 . W !,MSG(ND)
"RTN","GMRCADC",7,0)
 W !,"Press <RETURN> to continue: " R X:DTIME W !!
"RTN","GMRCADC",8,0)
 Q
"RTN","GMRCADC",9,0)
DC(GMRCO,GMRCA) ;Discontinue a consult logic from DC^GMRCA1
"RTN","GMRCADC",10,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCADC",11,0)
 N GMRCDA,GMRCACTM,GMRCADUZ,GMRCSERV,GMRCAD,GMRC
"RTN","GMRCADC",12,0)
 K GMRCQUT,GMRCQIT
"RTN","GMRCADC",13,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) Q
"RTN","GMRCADC",14,0)
 I '+$G(GMRCO) S GMRCQUT=1 Q
"RTN","GMRCADC",15,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D  Q
"RTN","GMRCADC",16,0)
 . N DIR
"RTN","GMRCADC",17,0)
 . W !,"The requesting facility may not take this action on an "
"RTN","GMRCADC",18,0)
 . W "inter-facility consult."
"RTN","GMRCADC",19,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCADC",20,0)
 . S GMRCQUT=1
"RTN","GMRCADC",21,0)
 I '$$LOCK^GMRCA1(GMRCO) S GMRCQUT=1 Q
"RTN","GMRCADC",22,0)
 ;
"RTN","GMRCADC",23,0)
 S GMRC(0)=^GMR(123,GMRCO,0),GMRCDA=GMRCO
"RTN","GMRCADC",24,0)
 S (GMRCDFN,DFN)=$P(GMRC(0),"^",2)
"RTN","GMRCADC",25,0)
 I $D(GMRCA),+GMRCA S GMRCACTM=$S(GMRCA=6:"Discontinued",GMRCA=19:"Cancelled",1:$P($G(^GMR(123.1,+GMRCA,0)),"^",1))
"RTN","GMRCADC",26,0)
 ;
"RTN","GMRCADC",27,0)
 D PROC I $D(GMRCQUT) D UNLOCK^GMRCA1(GMRCO) S GMRCQUT=1 Q
"RTN","GMRCADC",28,0)
 ;send 513 back to service printer if request DC'd or Cancelled
"RTN","GMRCADC",29,0)
 I GMRCA=6,$$DCPRNT^GMRCUTL1(+GMRCO,DUZ) D
"RTN","GMRCADC",30,0)
 . D PRNT^GMRCUTL1(+$P(GMRC(0),U,5),+GMRCO)
"RTN","GMRCADC",31,0)
 S GMRCTRLC=$S(GMRCA=19:"OC",1:"OD")
"RTN","GMRCADC",32,0)
 D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCRB),GMRCTRLC,GMRCORNP,$G(GMRCVSIT),.GMRCOM,,$G(GMRCAD))
"RTN","GMRCADC",33,0)
 D UNLOCK^GMRCA1(GMRCO)
"RTN","GMRCADC",34,0)
 Q
"RTN","GMRCADC",35,0)
 ;
"RTN","GMRCADC",36,0)
PROC ;Check validity of action and if valid process the discontinue action
"RTN","GMRCADC",37,0)
 N DIROUT,DTOUT,DUOUT,GMRCMSG,GMRCFL
"RTN","GMRCADC",38,0)
 I $P(GMRC(0),"^",12)=1 S GMRCMSG="This consult has already been discontinued!" D EXAC(GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",39,0)
 I $P(GMRC(0),"^",12)=2 S GMRCMSG="This consult has already been completed!" D EXAC(GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",40,0)
 I $P(GMRC(0),"^",12)=9 S GMRCMSG="Action invalid. This consult has partial results!",GMRCMSG(1)="Remove the associated results and then discontinue." D EXAC(.GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",41,0)
 I $P(GMRC(0),"^",12)=13 S GMRCMSG="This consult has already been cancelled!" D EXAC(GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",42,0)
 ;
"RTN","GMRCADC",43,0)
 S GMRCORVP=GMRCDFN_";DPT("
"RTN","GMRCADC",44,0)
 N GETPROV
"RTN","GMRCADC",45,0)
 D GETPROV^GMRCAU I $D(DIROUT)!$D(DTOUT)!$D(DUOUT) S GMRCQUT=1 Q
"RTN","GMRCADC",46,0)
 S GMRCAD=$$GETDT^GMRCUTL1 ;Returns GMRCAD as the entered date
"RTN","GMRCADC",47,0)
 I GMRCAD="^" S GMRCQUT=1 Q
"RTN","GMRCADC",48,0)
 S GMRCSTS=$S(GMRCA=6:1,1:13),$P(GMRC(0),"^",12)=GMRCSTS
"RTN","GMRCADC",49,0)
 S GMRCOM=1
"RTN","GMRCADC",50,0)
 D STATUS^GMRCP
"RTN","GMRCADC",51,0)
 D AUDIT^GMRCP
"RTN","GMRCADC",52,0)
 ;
"RTN","GMRCADC",53,0)
 S GMRCORTX=$S($L($G(GMRCACTM)):GMRCACTM,+GMRCA:$P(^GMR(123.1,GMRCA,0),U,1),1:"ACTION UNKNOWN FOR")_" consult "_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCADC",54,0)
 S GMRCADUZ="",GMRCFL=0
"RTN","GMRCADC",55,0)
 I +$P($G(^GMR(123,+GMRCO,0)),"^",14),+$P(^(0),"^",14)'=DUZ S GMRCADUZ($P(^(0),"^",14))=""
"RTN","GMRCADC",56,0)
 ;I +$P($G(^GMR(123,+GMRCO,0)),"^",14)=DUZ S GMRCFL=1
"RTN","GMRCADC",57,0)
 I GMRCA=6 S GMRCFL=$$DCNOTE(GMRCO,DUZ) ;check NOTIFY SERVICE ON DC
"RTN","GMRCADC",58,0)
 I GMRCA=19 S GMRCFL=1
"RTN","GMRCADC",59,0)
 ;send notification info to routine to be sent to OERR
"RTN","GMRCADC",60,0)
 N NOTYPE S NOTYPE=$S(GMRCA=6:23,1:30)
"RTN","GMRCADC",61,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,NOTYPE,.GMRCADUZ,GMRCFL)
"RTN","GMRCADC",62,0)
 Q
"RTN","GMRCADC",63,0)
DCNOTE(IEN,USER) ;determine if service users receive alerts based on 1.04
"RTN","GMRCADC",64,0)
 N SERV,DCFLG
"RTN","GMRCADC",65,0)
 S SERV=$P(^GMR(123,IEN,0),U,5)
"RTN","GMRCADC",66,0)
 S DCFLG=$P($G(^GMR(123.5,SERV,1)),U,4)
"RTN","GMRCADC",67,0)
 I 'DCFLG Q 1
"RTN","GMRCADC",68,0)
 I DCFLG=2 Q 0
"RTN","GMRCADC",69,0)
 I DCFLG=1,'$$VALID^GMRCAU(SERV,IEN,USER) Q 1
"RTN","GMRCADC",70,0)
 Q 0
"RTN","GMRCAFRD")
0^9^B37961904
"RTN","GMRCAFRD",1,0)
GMRCAFRD ;SLC/DLT,DCM,JFR - LM FORWARD ACTION ;7/11/03 14:02
"RTN","GMRCAFRD",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,10,12,15,22,35**;DEC 27, 1997
"RTN","GMRCAFRD",3,0)
 ;
"RTN","GMRCAFRD",4,0)
 ; This routine invokes IA #2395
"RTN","GMRCAFRD",5,0)
 ;
"RTN","GMRCAFRD",6,0)
FR(GMRCO) ;Forward Request to a new service
"RTN","GMRCAFRD",7,0)
 N ORVP,GMRCLCK,DFN
"RTN","GMRCAFRD",8,0)
 W !!,"Forward Request To Another Service For Action."
"RTN","GMRCAFRD",9,0)
 W !,"Select the service to send the consult to.",!
"RTN","GMRCAFRD",10,0)
 S:$D(GMRCSS) GMRCSSS=GMRCSS
"RTN","GMRCAFRD",11,0)
 N GMRCPL,GMRCPR,GMRCURG,GMRCDG,GMRCFF,GMRCORNP,GMRCAD,GMRCTO,GMRCADUZ
"RTN","GMRCAFRD",12,0)
 K GMRCQUT,GMRCSEL,GMRCSSS
"RTN","GMRCAFRD",13,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) D END Q
"RTN","GMRCAFRD",14,0)
 I '+$G(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",15,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D  Q
"RTN","GMRCAFRD",16,0)
 . N DIR
"RTN","GMRCAFRD",17,0)
 . W !,"The requesting facility may not take this action on an "
"RTN","GMRCAFRD",18,0)
 . W "inter-facility consult."
"RTN","GMRCAFRD",19,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCAFRD",20,0)
 . D END
"RTN","GMRCAFRD",21,0)
 . S GMRCQUT=1
"RTN","GMRCAFRD",22,0)
 I '$$LOCK^GMRCA1(GMRCO) D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",23,0)
 S GMRCLCK=1
"RTN","GMRCAFRD",24,0)
 ;
"RTN","GMRCAFRD",25,0)
 I $P(^GMR(123,GMRCO,0),"^",12)<3 S GMRCMSG="NO ACTION POSSIBLE. This Consult Has Already Been Completed Or Discontinued." D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",26,0)
 I $P(^GMR(123,GMRCO,0),"^",12)=13 S GMRCMSG="NO ACTION POSSIBLE. This Consult Has Already Been Cancelled." D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",27,0)
 I $P(^GMR(123,GMRCO,0),"^",12)=9 D  Q:+$G(GMRCQUT)
"RTN","GMRCAFRD",28,0)
 .S GMRCMSG="Invalid action. This consult has partial results."
"RTN","GMRCAFRD",29,0)
 .S GMRCMSG(1)="Remove the associated results before forwarding."
"RTN","GMRCAFRD",30,0)
 .D EXAC^GMRCADC(.GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",31,0)
 ;
"RTN","GMRCAFRD",32,0)
 I $D(IOBM),$D(IOTM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCAFRD",33,0)
 I $P(^GMR(123,GMRCO,0),"^",16) W !!,"This is a SERVICE ENTERED order stub.  Please send the written consult to the",!,"Service, in addition to the automated forwarding!"
"RTN","GMRCAFRD",34,0)
 S DFN=+$P(^GMR(123,GMRCO,0),"^",2)
"RTN","GMRCAFRD",35,0)
 S GMRCTO=1,GMRCASV="Forward Consult To Which Service/Specialty: "
"RTN","GMRCAFRD",36,0)
 D ASRV^GMRCASV K GMRCASV I $S($D(DTOUT):1,$D(DIROUT):1,$D(GMRCQUT):1,1:0) D END Q
"RTN","GMRCAFRD",37,0)
 I 'GMRCDG S GMRCMSG="No Service Was Selected. Consult Was Not Forwarded To Any Service!" D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",38,0)
 S GMRCFF=$P(^GMR(123,GMRCO,0),"^",5) I GMRCFF=+GMRCDG S GMRCMSG="The Forwarding Service Cannot Forward A Consult To Itself!" D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",39,0)
 S GETPROV="Who is responsible for Forwarding the Consult?"
"RTN","GMRCAFRD",40,0)
 D GETPROV^GMRCAU I '$D(GMRCORNP) D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",41,0)
 S GMRCAD=$$GETDT^GMRCUTL1 I GMRCAD="^" D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",42,0)
 I '$G(GMRCAD) S GMRCAD=$$NOW^XLFDT
"RTN","GMRCAFRD",43,0)
 N GMRCSS,GMRCSSNM,GMRCA,GMRCMSG,GMRCIROL,GMRCINM,GMRCIROU,ORSTS
"RTN","GMRCAFRD",44,0)
 D DEFAULT
"RTN","GMRCAFRD",45,0)
 S GMRCSS=+GMRCDG
"RTN","GMRCAFRD",46,0)
 I +GMRCSS,'$D(^GMR(123.5,+GMRCSS,0)) S GMRCMSG="Error in Service Chosen - SERVICE Does Not Exist!" D EXAC^GMRCADC(GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",47,0)
 S GMRCSSNM=$S($L($G(^GMR(123.5,+GMRCSS,.1))):^(.1),1:$P($G(^GMR(123.5,+GMRCSS,0)),U,1))
"RTN","GMRCAFRD",48,0)
 D URG I $D(GMRCEND),GMRCEND D END S GMRCQUT=1 Q
"RTN","GMRCAFRD",49,0)
 S GMRCA=17,DR=""
"RTN","GMRCAFRD",50,0)
 I $D(^GMR(123.5,+GMRCSS,"IFC")) D  ; if fwd to IFC serv, get extra flds
"RTN","GMRCAFRD",51,0)
 . S GMRCIROU=$P(^GMR(123.5,+GMRCSS,"IFC"),U) Q:GMRCIROU=""  ;no rout fac
"RTN","GMRCAFRD",52,0)
 . S GMRCINM=$P(^GMR(123.5,+GMRCSS,"IFC"),U,2) Q:GMRCINM=""  ;no serv nm
"RTN","GMRCAFRD",53,0)
 . S GMRCA=25,GMRCIROL="P"
"RTN","GMRCAFRD",54,0)
 . S DR=".07////^S X=GMRCIROU;.125////^S X=GMRCIROL;.131///^S X=GMRCINM;"
"RTN","GMRCAFRD",55,0)
 S DIE="^GMR(123,",DA=GMRCO,ORSTS=5
"RTN","GMRCAFRD",56,0)
 S DR=DR_"1////^S X=GMRCSS;5////^S X=GMRCURGI;8////^S X=ORSTS;9////^S X=GMRCA;.1///@"
"RTN","GMRCAFRD",57,0)
 L +^GMR(123,GMRCO):2 I '$T K DIE,DA,DR S GMRCMSG="Another User Is Accessing This Record. UPDATE WAS UNSUCCESSFUL.",GMRCMSG(1)="Try Again Later." D EXAC^GMRCADC(.GMRCMSG),END S GMRCQUT=1 Q
"RTN","GMRCAFRD",58,0)
 D ^DIE L -^GMR(123,GMRCO) K DIE,DA,DR
"RTN","GMRCAFRD",59,0)
 S GMRCOM=1 D AUDIT^GMRCP ;GMRCORNP is the responsible provider here
"RTN","GMRCAFRD",60,0)
 ;
"RTN","GMRCAFRD",61,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO) ;unlk before FWD changes order #
"RTN","GMRCAFRD",62,0)
 ;
"RTN","GMRCAFRD",63,0)
FRMSG ; Common logic used by GUI and List Manager to process the HL7 message
"RTN","GMRCAFRD",64,0)
 ; to update the order in OE/RR and then forward an alert to recipients
"RTN","GMRCAFRD",65,0)
 ; is passed in as the DUZ instead of the responsible provider
"RTN","GMRCAFRD",66,0)
 D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCRB),"XX^FORWARD",$G(DUZ),$G(VISIT),.GMRCOM,,$G(GMRCAD))
"RTN","GMRCAFRD",67,0)
 S GMRCADUZ=""
"RTN","GMRCAFRD",68,0)
 S GMRCORNP=$P(^GMR(123,GMRCO,0),"^",14) ;This is the original provider that ordered the consult
"RTN","GMRCAFRD",69,0)
 I +$G(GMRCORNP) S GMRCADUZ(+GMRCORNP)="" ;alert original provider of forward
"RTN","GMRCAFRD",70,0)
 S GMRCORTX="Forwarded consult "_$$ORTX^GMRCAU(+GMRCO)_" ("_GMRCURG_")"
"RTN","GMRCAFRD",71,0)
 D MSG^GMRCP(DFN,GMRCORTX,+GMRCO,27,.GMRCADUZ,1) ;GMRCO=IEN of consult from file 123; 27 is notification entry from file ORD(100.9
"RTN","GMRCAFRD",72,0)
 K GMRCOM
"RTN","GMRCAFRD",73,0)
 S GMRCDEV=$P($G(^GMR(123.5,GMRCSS,123)),"^",9)
"RTN","GMRCAFRD",74,0)
 I GMRCDEV D PRNT^GMRCUTL1(GMRCSS,+GMRCO)
"RTN","GMRCAFRD",75,0)
 D END
"RTN","GMRCAFRD",76,0)
 Q
"RTN","GMRCAFRD",77,0)
URG ;Get the default urgency
"RTN","GMRCAFRD",78,0)
 N X,Y,XQORM,DIROUT,DTOUT,DIRUT,DUOUT
"RTN","GMRCAFRD",79,0)
 I $P(^GMR(123,+GMRCO,0),"^",18)["I" D
"RTN","GMRCAFRD",80,0)
 .I GMRCTYPE="GMRCOR CONSULT" S X="GMRCURGENCYM CSLT - INPATIENT"
"RTN","GMRCAFRD",81,0)
 .S X="GMRCURGENCYM REQ - INPATIENT"
"RTN","GMRCAFRD",82,0)
 E  S X="GMRCURGENCYM - OUTPATIENT"
"RTN","GMRCAFRD",83,0)
 I '$D(GMRCURG) S GMRCURGI=$O(^ORD(101,"B","GMRCURGENCY - ROUTINE","")) S:+GMRCURGI GMRCURG=$P($G(^ORD(101,+GMRCURGI,0)),"^",2)
"RTN","GMRCAFRD",84,0)
 S Y=$O(^ORD(101,"B",X,""))
"RTN","GMRCAFRD",85,0)
 S XQORM=+Y_";ORD(101,",XQORM(0)="1A\",XQORM("A")="Urgency: ",XQORM("NO^^")=""
"RTN","GMRCAFRD",86,0)
 S:$L(GMRCURG) XQORM("B")=GMRCURG D EN^XQORM I X="^"!($D(DIROUT)) K XQORM S GMRCEND=1 Q
"RTN","GMRCAFRD",87,0)
 K XQORM(0),XQORM("A"),XQORM("B"),XQORM("NO^^") S XQORM=""
"RTN","GMRCAFRD",88,0)
 I '$D(Y) S GMRCEND=1 Q
"RTN","GMRCAFRD",89,0)
 I $D(Y(1)) S GMRCURG=$P(Y(1),"^",3),GMRCURGI=$P(Y(1),"^",2)
"RTN","GMRCAFRD",90,0)
 Q
"RTN","GMRCAFRD",91,0)
DEFAULT ;Set up defaults for editing to be equal to the existing data.
"RTN","GMRCAFRD",92,0)
 D DEM^GMRCU
"RTN","GMRCAFRD",93,0)
 N GMRC,GMRCDIC,GMRCPLI,GMRCPRI
"RTN","GMRCAFRD",94,0)
 Q:'$D(GMRCO)  S (GMRCSS,GMRCSSNM,GMRCPL,GMRCPR,GMRCPRI,GMRCURG)=""
"RTN","GMRCAFRD",95,0)
 S GMRCOM=0,GMRC(0)=$S($D(^GMR(123,+GMRCO,0)):^(0),1:"")
"RTN","GMRCAFRD",96,0)
 S GMRCSS=$P(GMRC(0),"^",5) I +GMRCSS,$D(^GMR(123.5,+GMRCSS,0)) S GMRCSSNM=$S($L($P($G(^GMR(123.5,+GMRCSS,0)),U,1)):$P(^(0),U,1),1:"")
"RTN","GMRCAFRD",97,0)
 S GMRCPLI=$P(GMRC(0),"^",10) I GMRCPLI S GMRCPL=$P($G(^ORD(101,GMRCPLI,0)),"^",2)
"RTN","GMRCAFRD",98,0)
 S GMRCURGI=$P(GMRC(0),"^",9) I GMRCURGI S GMRCURG=$P($G(^ORD(101,GMRCURGI,0)),"^",2)
"RTN","GMRCAFRD",99,0)
 S GMRCPRI=$P(GMRC(0),"^",8) I GMRCPRI["ORD(101" D
"RTN","GMRCAFRD",100,0)
 . S GMRCPR=$$GET1^DIQ(101,+GMRCPRI,1)
"RTN","GMRCAFRD",101,0)
 I $L(GMRCPRI),GMRCPRI'["ORD(101" D  ;ZPROC
"RTN","GMRCAFRD",102,0)
 . S GMRCPR=$$GET1^DIQ(123.3,+GMRCPRI,.01)
"RTN","GMRCAFRD",103,0)
TYPE ;This entry point is used when the only default needed is the GMRCTYPE
"RTN","GMRCAFRD",104,0)
 ;Called by GMRCGUIA to get variables ready for FRMSG call.
"RTN","GMRCAFRD",105,0)
 S GMRCTYPE=$$GET1^DIQ(123,+GMRCO,13,"I") ;ZPROC (P or C)
"RTN","GMRCAFRD",106,0)
 Q
"RTN","GMRCAFRD",107,0)
END ;Kill off variables and exit
"RTN","GMRCAFRD",108,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO)
"RTN","GMRCAFRD",109,0)
 K GETPROV,GMRCDG,GMRCDEV,GMRCEND,GMRCFF,GMRCOM,GMRCIFN,GMRCO,GMRCORNP
"RTN","GMRCAFRD",110,0)
 K GMRCTYPE,GMRCORTX,GMRCPL,GMRCPR,GMRCSEL,GMRCURG,GMRCADUZ,Y
"RTN","GMRCAFRD",111,0)
 K DTOUT,DIROUT,DUOUT,GMRCURGI
"RTN","GMRCAFRD",112,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCAFRD",113,0)
 Q
"RTN","GMRCASF")
0^7^B15424703
"RTN","GMRCASF",1,0)
GMRCASF ;SLC/DLT - Significant Findings Action ;7/11/03 13:28
"RTN","GMRCASF",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,10,14,22,29,35**;DEC 27, 1997
"RTN","GMRCASF",3,0)
SF(GMRCO) ;Evaluate Significant Findings and update accordingly
"RTN","GMRCASF",4,0)
 ;GMRCO is the selected consult
"RTN","GMRCASF",5,0)
 N GMRCQIT,GMRCLCK
"RTN","GMRCASF",6,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)  I $D(GMRCQUT) D END Q
"RTN","GMRCASF",7,0)
 I '+($G(GMRCO)) D END Q
"RTN","GMRCASF",8,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D  Q
"RTN","GMRCASF",9,0)
 . N DIR
"RTN","GMRCASF",10,0)
 . W !,"The requesting facility may not take this action on an "
"RTN","GMRCASF",11,0)
 . W "inter-facility consult."
"RTN","GMRCASF",12,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCASF",13,0)
 . D END
"RTN","GMRCASF",14,0)
 I '$$LOCK^GMRCA1(GMRCO) D END Q
"RTN","GMRCASF",15,0)
 S GMRCLCK=1
"RTN","GMRCASF",16,0)
 ;
"RTN","GMRCASF",17,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCASF",18,0)
 N GMRC,GMRCSTS,GMRCSF,GMRCSFO,GMRCORTX,GMRCDR
"RTN","GMRCASF",19,0)
 S GMRC(0)=$G(^GMR(123,+GMRCO,0)) Q:GMRC(0)=""
"RTN","GMRCASF",20,0)
 ;
"RTN","GMRCASF",21,0)
 S GMRCSFO=$P(GMRC(0),"^",19)
"RTN","GMRCASF",22,0)
 W !!,"Current Significant Findings = "_$S(GMRCSFO="U":"Unknown",GMRCSFO="Y":"Yes",GMRCSFO="N":"No",1:"not entered yet"),!!
"RTN","GMRCASF",23,0)
 S GMRCSF=$$GETSIGF(GMRCSFO)
"RTN","GMRCASF",24,0)
 I GMRCSF=0 D END Q
"RTN","GMRCASF",25,0)
 ; If no change in old and new value ask if should continue
"RTN","GMRCASF",26,0)
 I GMRCSF=GMRCSFO D  I 'Y D END Q
"RTN","GMRCASF",27,0)
 . W !,"The old and new Significant Findings are the same."
"RTN","GMRCASF",28,0)
 . N DIR,DA,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCASF",29,0)
 . S DIR("A")="Do you want to proceed with this action"
"RTN","GMRCASF",30,0)
 . S DIR(0)="Y"
"RTN","GMRCASF",31,0)
 . S DIR("B")="NO"
"RTN","GMRCASF",32,0)
 . D ^DIR
"RTN","GMRCASF",33,0)
 . I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) S Y=0 Q
"RTN","GMRCASF",34,0)
 . I Y=0 Q
"RTN","GMRCASF",35,0)
 ;
"RTN","GMRCASF",36,0)
 ;Update last action and sig findings but don't change the status
"RTN","GMRCASF",37,0)
 S GMRCSTS=$P(GMRC(0),"^",12),GMRCA=4
"RTN","GMRCASF",38,0)
 S GMRCDR="8////^S X=GMRCSTS;9////^S X=GMRCA;15////^S X=GMRCSF"
"RTN","GMRCASF",39,0)
 D STATUS^GMRCP
"RTN","GMRCASF",40,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCASF",41,0)
 ;
"RTN","GMRCASF",42,0)
 ;GMRCOM=1 tells AUDIT^GMRCP to do the word-processing logic
"RTN","GMRCASF",43,0)
 ;If an actual comment is added, $P(GMRCOM,"^",2)=1 (send alert),
"RTN","GMRCASF",44,0)
 ; if not GMRCOM=1 and no '^' exists (do not send alert)
"RTN","GMRCASF",45,0)
 S GMRCOM=1 D AUDIT^GMRCP
"RTN","GMRCASF",46,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCASF",47,0)
 ;
"RTN","GMRCASF",48,0)
 I GMRCSTS=2 D EN^GMRCHL7($P(^GMR(123,GMRCO,0),U,2),GMRCO,$G(GMRCTYPE),$G(GMRCRB),"RE",GMRCORNP,$G(GMRCVSIT),,,$G(GMRCAD))
"RTN","GMRCASF",49,0)
 D SETORTX
"RTN","GMRCASF",50,0)
 I GMRCSTS=2 D SENDALRT(GMRCORTX) Q
"RTN","GMRCASF",51,0)
 I +$P(GMRCOM,"^",2) D
"RTN","GMRCASF",52,0)
 . W !,"An alert with the following text will be sent if recipients are selected: "
"RTN","GMRCASF",53,0)
 . W !,"     "_GMRCORTX_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCASF",54,0)
 . W !
"RTN","GMRCASF",55,0)
 . I GMRCSTS'=2 W !,"or the alert will be sent when the order is completed.",!
"RTN","GMRCASF",56,0)
 . I $P($G(^GMR(123,GMRCO,12)),U,5)="F" D
"RTN","GMRCASF",57,0)
 . W !!,"The ordering provider for this inter-facility consult will "
"RTN","GMRCASF",58,0)
 . W "automatically be ",!,"notified.",!
"RTN","GMRCASF",59,0)
 . D PROCALRT^GMRCACMT(GMRCORTX,1,4,GMRCO)
"RTN","GMRCASF",60,0)
 . ;For consults not completed, the original provider may be deleted from
"RTN","GMRCASF",61,0)
 . ;the recipient list for the alert.
"RTN","GMRCASF",62,0)
 D END
"RTN","GMRCASF",63,0)
 Q
"RTN","GMRCASF",64,0)
 ;
"RTN","GMRCASF",65,0)
SETORTX ;Set prefix text for the alert
"RTN","GMRCASF",66,0)
 S GMRCORTX=$S(GMRCSF="N":"No ",GMRCSF="Y":"",1:"Unknown ")
"RTN","GMRCASF",67,0)
 S GMRCORTX=GMRCORTX_"Sig Findings for "_$P($G(^ORD(100.01,+GMRCSTS,0)),"^",2)_" consult " Q
"RTN","GMRCASF",68,0)
 Q
"RTN","GMRCASF",69,0)
 ;
"RTN","GMRCASF",70,0)
SENDALRT(GMRCORTX) ;Send to the requesting provider
"RTN","GMRCASF",71,0)
 N GMRCRP,GMRCADUZ,GMRCDELR
"RTN","GMRCASF",72,0)
 S GMRCRP=$P($G(^GMR(123,+GMRCO,0)),U,14) ;requesting clinician
"RTN","GMRCASF",73,0)
 I +GMRCRP S GMRCADUZ(+GMRCRP)=""
"RTN","GMRCASF",74,0)
 W !,"Alert will be sent to Requesting Provider: "_$P($G(^VA(200,+GMRCRP,0)),U,1)
"RTN","GMRCASF",75,0)
 S GMRCDELR=0
"RTN","GMRCASF",76,0)
 D ANDTO^GMRCACMT
"RTN","GMRCASF",77,0)
 D SENDMSG^GMRCACMT(23,+GMRCO)
"RTN","GMRCASF",78,0)
 ;Sig Findings uses the CONSULT/REQUEST RESOLUTION (23) notification
"RTN","GMRCASF",79,0)
 Q
"RTN","GMRCASF",80,0)
 ;
"RTN","GMRCASF",81,0)
GETSIGF(GMRCSFO) ;Get the significant findings
"RTN","GMRCASF",82,0)
 ;GMRCSFO is the old significant findings value
"RTN","GMRCASF",83,0)
 N DIR,DA,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCASF",84,0)
 S DIR(0)="123,15"
"RTN","GMRCASF",85,0)
 S DIR("B")=GMRCSFO
"RTN","GMRCASF",86,0)
 S:DIR("B")="" DIR("B")="unknown"
"RTN","GMRCASF",87,0)
 S DIR("A")="Are there significant findings? (Y/N/U)"
"RTN","GMRCASF",88,0)
 D ^DIR
"RTN","GMRCASF",89,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q 0
"RTN","GMRCASF",90,0)
 Q Y
"RTN","GMRCASF",91,0)
 ;
"RTN","GMRCASF",92,0)
END ;cleanup variables
"RTN","GMRCASF",93,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO)
"RTN","GMRCASF",94,0)
 K GMRCO,GMRCA,GMRCMSG,GMRCOM,GMRCSEL,GMRCERR,GMRCERMS
"RTN","GMRCASF",95,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCASF",96,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCASF",97,0)
 Q
"RTN","GMRCGUIA")
0^4^B46080556
"RTN","GMRCGUIA",1,0)
GMRCGUIA ;SLC/DCM,JFR - File Consult actions from GUI  ;7/8/03 07:36
"RTN","GMRCGUIA",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,12,15,22,35**;DEC 27, 1997
"RTN","GMRCGUIA",3,0)
 ;
"RTN","GMRCGUIA",4,0)
 ; This routine invokes IA #2638,#2926
"RTN","GMRCGUIA",5,0)
 ;
"RTN","GMRCGUIA",6,0)
NEW(DFN,GMRCDA,GMRCLOC,GMRCTYPE,GMRCSVC,GMRCPROV,GMRCURG,GMRCPLI,GMRCNP,GMRCATN,GMRCINOT,GMRCDIAG,GMRCRFQ) ;Add a new consult for a patient.
"RTN","GMRCGUIA",7,0)
 ;DFN=Patient ^DPT( file number
"RTN","GMRCGUIA",8,0)
 ;GMRCRFQ=Reason For Request, why the consult is being ordered. Passed in as
"RTN","GMRCGUIA",9,0)
 ;    an array
"RTN","GMRCGUIA",10,0)
 ;GMRCDIAG=Povisional diagnosis; what is suspected to be the problem
"RTN","GMRCGUIA",11,0)
 ;GMRCTYPE=Request type -Consult or Procedure
"RTN","GMRCGUIA",12,0)
 ;GMRCLOC=Patient location.
"RTN","GMRCGUIA",13,0)
 ;GMRCDA=Date Time of Request
"RTN","GMRCGUIA",14,0)
 ;GMRCSVC=To Service; consulting service
"RTN","GMRCGUIA",15,0)
 ;GMRCLOC=Hospital Location ordering consult
"RTN","GMRCGUIA",16,0)
 ;GMRCPR=If a procedure, the procedure ordered (pointer to file 101)
"RTN","GMRCGUIA",17,0)
 ;GMRCURG=Urgency of request (stat, routine, etc) from file 101
"RTN","GMRCGUIA",18,0)
 ;GMRCPLI=Place of consultation (bedside, consultants choice, etc.) from file 101
"RTN","GMRCGUIA",19,0)
 ;GMRCPROV=Sending Provider
"RTN","GMRCGUIA",20,0)
 ;GMRCATN=if consult is to go to a specific provider, this provider is identified here.
"RTN","GMRCGUIA",21,0)
 ;GMRCINOT=Service provided as Inpatient or Outpatient
"RTN","GMRCGUIA",22,0)
 N DIC,DLAYGO,Y,DIE,GMRCADUZ,X,GMRCO,DR
"RTN","GMRCGUIA",23,0)
 S DIC="^GMR(123,",DIC(0)="L",X="""N""",DLAYGO=123 D ^DIC K DLAYGO
"RTN","GMRCGUIA",24,0)
 S (DA,GMRCO)=+Y,GMRCSTS=5,GMRCA=1,DIE=DIC
"RTN","GMRCGUIA",25,0)
 L +^GMR(123,GMRC0)
"RTN","GMRCGUIA",26,0)
 S DR=".02////^S X=DFN;.04////^S X=GMRCLOC;1////^S X=GMRCSVC;3////^S X=GMRCDA;4////^S X=GMRCPR;5////^S X=GMRCURG;6////^S X=GMRCPLI"_$S(GMRCATN]"":"7////^S X=GMRCATN",1:"")
"RTN","GMRCGUIA",27,0)
 D ^DIE
"RTN","GMRCGUIA",28,0)
 S DR="8////^S X=GMRCSTS;9////^S X=GMRCA;10////^S X=GMRCPROV;11////^S X=GMRCATN;13////^S X=GMRCTYPE;14////^S X=GMRCINOT"_$S($D(GMRCDIAG):"30:////^S X=GMRCDIAG",1:"")
"RTN","GMRCGUIA",29,0)
 D ^DIE L -^GMR(123,GMRCO)
"RTN","GMRCGUIA",30,0)
 I $O(GMRCRFQ(0)) D REASON^GMRCGUIB(GMRCO,GMRCRFQ,GMRCDA)
"RTN","GMRCGUIA",31,0)
 D EN^GMRCHL7(DFN,GMRCDA,GMRCTYPE,$G(GMRCRB),"NW",DUZ,$G(VISIT),"")
"RTN","GMRCGUIA",32,0)
 D EXIT
"RTN","GMRCGUIA",33,0)
 Q
"RTN","GMRCGUIA",34,0)
 ;
"RTN","GMRCGUIA",35,0)
RC(GMRCO,GMRCORNP,GMRCAD,GMRCMT,GMRCDUZ) ;Receive consult into service
"RTN","GMRCGUIA",36,0)
 ;
"RTN","GMRCGUIA",37,0)
 ;Input variables:
"RTN","GMRCGUIA",38,0)
 ;GMRCO - The internal file number of the consult from File 123
"RTN","GMRCGUIA",39,0)
 ;GMRCORNP - Name of the person who actually 'Received'the consult 
"RTN","GMRCGUIA",40,0)
 ;GMRCDUZ - DUZ of person entering the consult as being 'RECEIVED'.
"RTN","GMRCGUIA",41,0)
 ;GMRCAD - Actual date time that consult was received into the service.
"RTN","GMRCGUIA",42,0)
 ;GMRCMT - array of comments if entered (by reference)
"RTN","GMRCGUIA",43,0)
 ;   ARRAY(1)="FIRST LINE OF COMMENT"
"RTN","GMRCGUIA",44,0)
 ;   ARRAY(2)="SECOND LINE OF COMMENT"
"RTN","GMRCGUIA",45,0)
 ;GMRCDUZ - DUZ of person entering the consult as being 'RECEIVED'
"RTN","GMRCGUIA",46,0)
 ;
"RTN","GMRCGUIA",47,0)
 ;Output:
"RTN","GMRCGUIA",48,0)
 ;GMRCERR - Error Condition Code: 0 = NO error, 1=error
"RTN","GMRCGUIA",49,0)
 ;GMRCERMS - Error message or null
"RTN","GMRCGUIA",50,0)
 ;  returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIA",51,0)
 ;
"RTN","GMRCGUIA",52,0)
 N DFN,GMRCSTS,GMRCNOW,GMRCERR,GMRCERMS
"RTN","GMRCGUIA",53,0)
 S GMRCERR=0,GMRCERMS="",GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIA",54,0)
 S:$G(GMRCAD)="" GMRCAD=GMRCNOW
"RTN","GMRCGUIA",55,0)
 S:'$G(GMRCDUZ) GMRCDUZ=DUZ
"RTN","GMRCGUIA",56,0)
 S DFN=$P($G(^GMR(123,GMRCO,0)),"^",2) I DFN="" S GMRCERR="1",GMRCERMS="Not A Valid Consult - File Not Found." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",57,0)
 S GMRCSTS=6,GMRCA=21
"RTN","GMRCGUIA",58,0)
 D STATUS^GMRCP I $D(GMRCQUT) D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",59,0)
 I '$O(GMRCMT(0)) D AUDIT^GMRCP
"RTN","GMRCGUIA",60,0)
 I $O(GMRCMT(0)) D
"RTN","GMRCGUIA",61,0)
 . S DA=$$SETDA^GMRCGUIB
"RTN","GMRCGUIA",62,0)
 . D SETCOM^GMRCGUIB(.GMRCMT,GMRCDUZ)
"RTN","GMRCGUIA",63,0)
 D EN^GMRCHL7(DFN,GMRCO,"","","SC",GMRCORNP,"","")
"RTN","GMRCGUIA",64,0)
 D EXIT
"RTN","GMRCGUIA",65,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",66,0)
 ;
"RTN","GMRCGUIA",67,0)
DC(GMRCO,GMRCORNP,GMRCAD,GMRCACTM,GMRCOM) ;Discontinue or Deny a consult
"RTN","GMRCGUIA",68,0)
 ;
"RTN","GMRCGUIA",69,0)
 ;Input variables:
"RTN","GMRCGUIA",70,0)
 ;GMRCO - Internal file number of consult from File 123
"RTN","GMRCGUIA",71,0)
 ;GMRCORNP - Provider who Discontinued or Denied consult
"RTN","GMRCGUIA",72,0)
 ;GMRCAD - FM date/time of actual activity.
"RTN","GMRCGUIA",73,0)
 ;GMRCACTM - set to "DY" if 'CANCELLED'(old DENY)
"RTN","GMRCGUIA",74,0)
 ;           set to "DC" if consult is Discontinued 
"RTN","GMRCGUIA",75,0)
 ;GMRCOM - Comment array containing explanation of action
"RTN","GMRCGUIA",76,0)
 ;    Passed by reference in the following form :
"RTN","GMRCGUIA",77,0)
 ;     ARRAY(1)="xxx xxx xxx"
"RTN","GMRCGUIA",78,0)
 ;     ARRAY(2)="XXX XXX"
"RTN","GMRCGUIA",79,0)
 ;     ARRAY(3)="XXX XXX xx", etc.
"RTN","GMRCGUIA",80,0)
 ;  Comment is a required field when consult is denied or discontinued.
"RTN","GMRCGUIA",81,0)
 ;
"RTN","GMRCGUIA",82,0)
 ;Output:
"RTN","GMRCGUIA",83,0)
 ;GMRCERR=Error Flag: 0 if no error, 1 if error occurred 
"RTN","GMRCGUIA",84,0)
 ;GMRCERMS - Error message or null
"RTN","GMRCGUIA",85,0)
 ; returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIA",86,0)
 ;
"RTN","GMRCGUIA",87,0)
 N GMRCDUZ,DFN,GMRCNOW,GMRCSTS,GMRCERR,GMRCERMS,GMRCADUZ,GMRCTRLC
"RTN","GMRCGUIA",88,0)
 S GMRCERR=0,GMRCERMS=""
"RTN","GMRCGUIA",89,0)
 S GMRCDUZ=DUZ,GMRCERR=0,GMRCERMS="",GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIA",90,0)
 K GMRCQUT
"RTN","GMRCGUIA",91,0)
 S:$G(GMRCAD)="" GMRCAD=GMRCNOW
"RTN","GMRCGUIA",92,0)
 S DFN=$P($G(^GMR(123,GMRCO,0)),"^",2) I DFN="" S GMRCERR="1",GMRCERMS="Not A Valid Consult - File Not Found." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",93,0)
 I '$D(GMRCOM) S GMRCERR=1,GMRCERMS="Comments are required for this action." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",94,0)
 S GMRCSTS=$P(^ORD(100.01,$P(^GMR(123,GMRCO,0),"^",12),0),U,2)
"RTN","GMRCGUIA",95,0)
 I GMRCSTS="dc" S GMRCERR=1,GMRCERMS="Order Has Already Been Discontinued." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",96,0)
 I GMRCSTS="ca" S GMRCERR=1,GMRCERMS="Order Has Already Been Cancelled." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",97,0)
 I GMRCSTS="comp" S GMRCERR=1,GMRCERMS="Order Has Already Been Completed." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",98,0)
 S GMRCA=$S(GMRCACTM="DC":6,1:19),GMRCSTS=$S(GMRCA=6:1,1:13)
"RTN","GMRCGUIA",99,0)
 D STATUS^GMRCP I $D(GMRCQUT) D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",100,0)
 I GMRCACTM="DC",$$DCPRNT^GMRCUTL1(GMRCO,DUZ) D PRNT^GMRCUTL1("",GMRCO)
"RTN","GMRCGUIA",101,0)
 S DA=$$SETDA^GMRCGUIB D SETCOM^GMRCGUIB(.GMRCOM)
"RTN","GMRCGUIA",102,0)
 S GMRCOM(0)=DA
"RTN","GMRCGUIA",103,0)
 S GMRCTRLC=$S(GMRCACTM="DC":"OD",1:"OC")
"RTN","GMRCGUIA",104,0)
 D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCRB),GMRCTRLC,GMRCORNP,$G(GMRCVSIT),.GMRCOM,,GMRCAD)
"RTN","GMRCGUIA",105,0)
 S GMRCORTX=$S(GMRCACTM="DY":"Cancelled",1:"Discontinued")_" consult "
"RTN","GMRCGUIA",106,0)
 S GMRCORTX=GMRCORTX_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCGUIA",107,0)
 S GMRCADUZ="",GMRCFL=0
"RTN","GMRCGUIA",108,0)
 I GMRCACTM="DC" D
"RTN","GMRCGUIA",109,0)
 . S GMRCFL=$$DCNOTE^GMRCADC(GMRCO,DUZ) ;NOTIFY SERVICE ON DC ?
"RTN","GMRCGUIA",110,0)
 I +$P($G(^GMR(123,+GMRCO,0)),"^",14),$P(^(0),"^",14)'=DUZ D
"RTN","GMRCGUIA",111,0)
 . S GMRCADUZ($P(^(0),"^",14))=""
"RTN","GMRCGUIA",112,0)
 ;send notification
"RTN","GMRCGUIA",113,0)
 N NOTYPE S NOTYPE=$S(GMRCA=6:23,1:30)
"RTN","GMRCGUIA",114,0)
 D MSG^GMRCP(DFN,GMRCORTX,+GMRCO,NOTYPE,.GMRCADUZ,GMRCFL)
"RTN","GMRCGUIA",115,0)
 D EXIT
"RTN","GMRCGUIA",116,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",117,0)
 ;
"RTN","GMRCGUIA",118,0)
FR(GMRCO,GMRCSS,GMRCORNP,GMRCATTN,GMRCURGI,GMRCOM,GMRCAD) ;FWD consult
"RTN","GMRCGUIA",119,0)
 ;to another service
"RTN","GMRCGUIA",120,0)
 ;
"RTN","GMRCGUIA",121,0)
 ;Input variables:
"RTN","GMRCGUIA",122,0)
 ;GMRCO=File 123 IEN of the consult record
"RTN","GMRCGUIA",123,0)
 ;GMRCSS=service being forwarded to; ptr to REQUEST SERVICES (#123.5)
"RTN","GMRCGUIA",124,0)
 ;GMRCORNP=Provider Responsible for action
"RTN","GMRCGUIA",125,0)
 ;GMRCATTN=NEW PERSON to whose attention action should be directed
"RTN","GMRCGUIA",126,0)
 ;GMRCURGI=urgency from PROTOCOL(#101) file
"RTN","GMRCGUIA",127,0)
 ;GMRCOM=Comment array containing explanation of action
"RTN","GMRCGUIA",128,0)
 ;    Passed by reference in the following form :
"RTN","GMRCGUIA",129,0)
 ;     ARRAY(1)="xxx xxx xxx"
"RTN","GMRCGUIA",130,0)
 ;     ARRAY(2)="XXX XXX"
"RTN","GMRCGUIA",131,0)
 ;     ARRAY(3)="XXX XXX xx", etc.
"RTN","GMRCGUIA",132,0)
 ;GMRCAD=FM date/time of actual activity
"RTN","GMRCGUIA",133,0)
 ;
"RTN","GMRCGUIA",134,0)
 ;Output:
"RTN","GMRCGUIA",135,0)
 ;  GMRCERR=Error Flag: 0 if no error, 1 if error occurred 
"RTN","GMRCGUIA",136,0)
 ;  GMRCERMS - Error message or null
"RTN","GMRCGUIA",137,0)
 ;     returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIA",138,0)
 ;
"RTN","GMRCGUIA",139,0)
 N DR,GMRCDUZ,GMRCNOW,GMRCFF,GMRCFR,GMRCADUZ,GMRCURG
"RTN","GMRCGUIA",140,0)
 N GMRCERR,GMRCERMS,GMRCIROL,GMRCINM,GMRCIROU
"RTN","GMRCGUIA",141,0)
 S GMRCERR=0,GMRCERMS=""
"RTN","GMRCGUIA",142,0)
 S DFN=$P(^GMR(123,+GMRCO,0),U,2)
"RTN","GMRCGUIA",143,0)
 S GMRCDUZ=DUZ,GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIA",144,0)
 S:'$G(GMRCAD) GMRCAD=GMRCNOW  ;Actual FM date/time consult was FWD'd 
"RTN","GMRCGUIA",145,0)
 S:'$G(GMRCURGI) GMRCURGI=$P(^GMR(123,GMRCO,0),U,9)
"RTN","GMRCGUIA",146,0)
 S GMRCA=17,GMRCSTS=5
"RTN","GMRCGUIA",147,0)
 S GMRCFF=$P($G(^GMR(123.5,+GMRCSS,123)),U,9) ;printed to new serv
"RTN","GMRCGUIA",148,0)
 S GMRCFR=$P($G(^GMR(123,+GMRCO,0)),"^",5) ;Get current service 
"RTN","GMRCGUIA",149,0)
 S DIE="^GMR(123,",DA=GMRCO,DR=""
"RTN","GMRCGUIA",150,0)
 I $D(^GMR(123.5,+GMRCSS,"IFC")) D  ; if fwd to IFC serv, get extra flds
"RTN","GMRCGUIA",151,0)
 . S GMRCIROU=$P(^GMR(123.5,+GMRCSS,"IFC"),U) Q:GMRCIROU=""  ;no rout fac
"RTN","GMRCGUIA",152,0)
 . S GMRCINM=$P(^GMR(123.5,+GMRCSS,"IFC"),U,2) Q:GMRCINM=""  ;no serv nm
"RTN","GMRCGUIA",153,0)
 . S GMRCA=25,GMRCIROL="P"
"RTN","GMRCGUIA",154,0)
 . S DR=".07////^S X=GMRCIROU;.125////^S X=GMRCIROL;.131///^S X=GMRCINM;"
"RTN","GMRCGUIA",155,0)
 S DR=DR_"1////^S X=$G(GMRCSS);5////^S X=$G(GMRCURGI);8////^S X=$G(GMRCSTS);9////^S X=$G(GMRCA);.1///@"_$S($L($G(GMRCATTN)):";7////^S X=GMRCATTN",1:"")
"RTN","GMRCGUIA",156,0)
 L +^GMR(123,GMRCO):3 I '$T K DIE,DA,DR S GMRCERR=1,GMRCERMS="Data Not Filed - File In Use By Another User." D EXIT Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",157,0)
 D ^DIE L -^GMR(123,GMRCO) K DIE,DA,DR
"RTN","GMRCGUIA",158,0)
 S DA=$$SETDA^GMRCGUIB D SETCOM^GMRCGUIB(.GMRCOM)
"RTN","GMRCGUIA",159,0)
 S GMRCURG=$P($G(^ORD(101,+GMRCURGI,0)),"^",2)
"RTN","GMRCGUIA",160,0)
 D DEM^GMRCU ;sets GMRCRB and other variables
"RTN","GMRCGUIA",161,0)
 D TYPE^GMRCAFRD ;sets GMRCTYPE
"RTN","GMRCGUIA",162,0)
 D FRMSG^GMRCAFRD ;create XX HL7 message for OE/RR and send alert 
"RTN","GMRCGUIA",163,0)
 D EXIT
"RTN","GMRCGUIA",164,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIA",165,0)
 ;
"RTN","GMRCGUIA",166,0)
RT(GMRCO,TMPGLOB) ;Set ^TMP("GMRCR",$J,"DT", with results from med and TIU
"RTN","GMRCGUIA",167,0)
 ;GMRCO=IEN of consult from file 123
"RTN","GMRCGUIA",168,0)
 ;Set TMPGLOB to a ^TMP global other than ^TMP("GMRCR",$J,"MCAR", or ^TMP("GMRCR",$J,"RES", i.e., S TMPGLOB="^TMP(""GMRCR"",$J,""RT"")"'
"RTN","GMRCGUIA",169,0)
 Q:'$G(GMRCO)
"RTN","GMRCGUIA",170,0)
 K @TMPGLOB
"RTN","GMRCGUIA",171,0)
 S GMRCDVL="",$P(GMRCDVL,"-",41)=""
"RTN","GMRCGUIA",172,0)
 S GMRCSR=$P(^GMR(123,+GMRCO,0),"^",15),GMRCTUFN=$P(^(0),"^",20)
"RTN","GMRCGUIA",173,0)
 S GMRCRTFL=$S('+GMRCSR&('GMRCTUFN):1,1:0)
"RTN","GMRCGUIA",174,0)
 ;
"RTN","GMRCGUIA",175,0)
 D GETRSLT^GMRCART(TMPGLOB)
"RTN","GMRCGUIA",176,0)
 ;
"RTN","GMRCGUIA",177,0)
 D EXIT
"RTN","GMRCGUIA",178,0)
 Q
"RTN","GMRCGUIA",179,0)
EXIT ;kill off variables for exit from actions
"RTN","GMRCGUIA",180,0)
 K GMRCA,GMRCDVL,GMRCSR,GMRCRTFL,GMRCFL,GMRCORNP,GMRCQUT,GMRCSTS,GMRCTUFN
"RTN","GMRCGUIA",181,0)
 K GMRCRTFL,GMRCADUZ,GMRCORTX
"RTN","GMRCGUIA",182,0)
 Q
"RTN","GMRCGUIB")
0^12^B39851161
"RTN","GMRCGUIB",1,0)
GMRCGUIB ;SLC/DCM,JFR,MA - GUI actions for consults ;8/19/03 07:31
"RTN","GMRCGUIB",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,18,20,17,22,29,30,35**;DEC 27, 1997
"RTN","GMRCGUIB",3,0)
 ; This routine invokes IA #2980
"RTN","GMRCGUIB",4,0)
 ;
"RTN","GMRCGUIB",5,0)
SETDA() ;set DA of where audit actions are to be filed
"RTN","GMRCGUIB",6,0)
 S:'$D(^GMR(123,+GMRCO,40,0)) ^GMR(123,GMRCO,40,0)="^123.02DA^^"
"RTN","GMRCGUIB",7,0)
 S DA=$S($P(^GMR(123,+GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1)
"RTN","GMRCGUIB",8,0)
 S $P(^GMR(123,+GMRCO,40,0),"^",3,4)=DA_"^"_DA
"RTN","GMRCGUIB",9,0)
 Q DA
"RTN","GMRCGUIB",10,0)
REASON(GMRCFN,GMRCRQ,GMRCDT) ;Load the reason for the request into ^GMR(123,GMRCO,20
"RTN","GMRCGUIB",11,0)
 ;GMRCFN=File 123 IFN; GMRCRQ=Array containing Reason For Request
"RTN","GMRCGUIB",12,0)
 ;GMRCDT=Date time of entry
"RTN","GMRCGUIB",13,0)
 S ^GMR(123,GMRCFN,20,0)="^^^"_GMRCDT_"^"
"RTN","GMRCGUIB",14,0)
 S L=0,LN=1 F  S L=$O(GMRCRQ(L)) Q:L=""  S ^GMR(123,GMRCFN,20,LN,0)=GMRCRQ(L),LN=LN+1
"RTN","GMRCGUIB",15,0)
 S LN=LN-1,$P(^GMR(123,GMRCFN,20,0),"^",3)=LN
"RTN","GMRCGUIB",16,0)
 K LN,L
"RTN","GMRCGUIB",17,0)
 Q
"RTN","GMRCGUIB",18,0)
SETCOM(COMMENT,WHO) ;Set comment array into tracking actions
"RTN","GMRCGUIB",19,0)
 N GMRCNOW,DR,DIE
"RTN","GMRCGUIB",20,0)
 S GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIB",21,0)
 S DIE="^GMR(123,GMRCO,40,",DA(1)=GMRCO,DR=".01////^S X=GMRCNOW;1////^S X=GMRCA;2////^S X=GMRCAD;3////^S X=$G(GMRCORNP);4////^S X=$S($G(WHO):WHO,1:DUZ);6////^S X=$G(GMRCFR);8////^S X=$G(GMRCFF)"
"RTN","GMRCGUIB",22,0)
 D ^DIE
"RTN","GMRCGUIB",23,0)
 S ^GMR(123,GMRCO,40,DA,1,0)="^^^^"_GMRCAD_"^"
"RTN","GMRCGUIB",24,0)
 S (GMRCND,GMRCND1)=0 F  S GMRCND1=$O(COMMENT(GMRCND1)) Q:GMRCND1=""  S GMRCND=GMRCND+1,^GMR(123,GMRCO,40,DA,1,GMRCND,0)=COMMENT(GMRCND)
"RTN","GMRCGUIB",25,0)
 S $P(^GMR(123,GMRCO,40,DA,1,0),"^",3)=GMRCND,$P(^(0),"^",4)=GMRCND,^GMR(123,GMRCO,40,"B",GMRCNOW,DA)=""
"RTN","GMRCGUIB",26,0)
 ;
"RTN","GMRCGUIB",27,0)
 ; if an IFC, call event handler to generate a msg to remote site
"RTN","GMRCGUIB",28,0)
 I $D(^GMR(123,+GMRCO,12)),$D(^(40,DA)) D TRIGR^GMRCIEVT(GMRCO,DA)
"RTN","GMRCGUIB",29,0)
 ;
"RTN","GMRCGUIB",30,0)
 K GMRCND,GMRCND1
"RTN","GMRCGUIB",31,0)
 Q
"RTN","GMRCGUIB",32,0)
CMT(GMRCO,GMRCOM,GMRCADUZ,GMRCWHN,GMRCWHO) ;add comment to consult 
"RTN","GMRCGUIB",33,0)
 ; GMRCO = IEN from file 123
"RTN","GMRCGUIB",34,0)
 ; GMRCOM = array of comments in format GMRCOM(1)="xxxx", GMRCOM(2)="xxx"
"RTN","GMRCGUIB",35,0)
 ; GMRCADUZ = array of alert recipients as GMRCADUZ(DUZ)="" (optional)
"RTN","GMRCGUIB",36,0)
 ; GMRCWHO = IEN from file 200 who's responsible activity (optional)
"RTN","GMRCGUIB",37,0)
 ; GMRCWHN = date time of activity in FM format
"RTN","GMRCGUIB",38,0)
 ;
"RTN","GMRCGUIB",39,0)
 N DA,GMRCA,GMRCAD,GMRCORTX,GMRCDFN,GMRCTM,GMRCRP,GMRCUPD
"RTN","GMRCGUIB",40,0)
 S DA=$$SETDA ; get next activity tracking entry
"RTN","GMRCGUIB",41,0)
 S GMRCA=20,GMRCAD=GMRCWHN S:$G(GMRCWHO) GMRCORNP=GMRCWHO
"RTN","GMRCGUIB",42,0)
 D SETCOM(.GMRCOM,$G(GMRCWHO))
"RTN","GMRCGUIB",43,0)
 D  ;update LAST ACTION field even though no status change
"RTN","GMRCGUIB",44,0)
 . N GMRCDR,GMRCSTS
"RTN","GMRCGUIB",45,0)
 . S GMRCSTS="",GMRCDR="9////20"
"RTN","GMRCGUIB",46,0)
 . D STATUS^GMRCP
"RTN","GMRCGUIB",47,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCGUIB",48,0)
 S GMRCORTX="Comment Added to Consult "
"RTN","GMRCGUIB",49,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D
"RTN","GMRCGUIB",50,0)
 . S GMRCORTX="Comment Added to remote consult "
"RTN","GMRCGUIB",51,0)
 S GMRCORTX=GMRCORTX_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCGUIB",52,0)
 S GMRCRP=+$P(^GMR(123,GMRCO,0),U,14)
"RTN","GMRCGUIB",53,0)
 S GMRCUPD=$$VALID^GMRCAU($P(^GMR(123,+GMRCO,0),U,5),GMRCO,DUZ)
"RTN","GMRCGUIB",54,0)
 I GMRCRP=DUZ D  ;alert team if ord. prov. takes the action
"RTN","GMRCGUIB",55,0)
 . S GMRCTM=1
"RTN","GMRCGUIB",56,0)
 I GMRCUPD D  ; alert ord. prov if update users takes action
"RTN","GMRCGUIB",57,0)
 . S GMRCADUZ(GMRCRP)=""
"RTN","GMRCGUIB",58,0)
 I '$G(GMRCTM),'GMRCUPD D  ;alert both if not ord. prov or update user
"RTN","GMRCGUIB",59,0)
 . S GMRCTM=1,GMRCADUZ(GMRCRP)=""
"RTN","GMRCGUIB",60,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,63,.GMRCADUZ,$G(GMRCTM))
"RTN","GMRCGUIB",61,0)
 Q
"RTN","GMRCGUIB",62,0)
SFILE(GMRCO,GMRCA,GMRCSF,GMRCORNP,GMRCDUZ,GMRCOM,GMRCALF,GMRCATO,GMRCAD) ;Process various file update functions from the GUI for a consult
"RTN","GMRCGUIB",63,0)
 ; ADMIN COMPLETE or SIGNIFICANT FINDINGS
"RTN","GMRCGUIB",64,0)
 ;Input variables:
"RTN","GMRCGUIB",65,0)
 ;GMRCO=File 123 IEN of the consult record
"RTN","GMRCGUIB",66,0)
 ;GMRCA=pointer to REQUEST ACTION TYPES (#123.1) 10=complete, 4=Sig find.
"RTN","GMRCGUIB",67,0)
 ;GMRCSF=Significant Findings flag: 'Y'= significant finding
"RTN","GMRCGUIB",68,0)
 ;                                : 'N'= no significant finding
"RTN","GMRCGUIB",69,0)
 ;                                : 'U'=unknown significant finding
"RTN","GMRCGUIB",70,0)
 ;GMRCORNP=Provider Responsible for action
"RTN","GMRCGUIB",71,0)
 ;GMRCDUZ=Person actually doing the action
"RTN","GMRCGUIB",72,0)
 ;GMRCOM=An array of comments by reference ARRAY(1)="xxx",ARRAY(2)="xxx"
"RTN","GMRCGUIB",73,0)
 ;GMRCALF=Flag to signal that alerts are to be sent; 'N'=NO, 'Y'=YES
"RTN","GMRCGUIB",74,0)
 ;GMRCATO=Who alerts are to be sent to; a comma delimited string of DUZ's
"RTN","GMRCGUIB",75,0)
 ;GMRCAD =FM date/time of activity
"RTN","GMRCGUIB",76,0)
 ;
"RTN","GMRCGUIB",77,0)
 ;Output:
"RTN","GMRCGUIB",78,0)
 ; GMRCERR=Error Flag: 0 if no error, 1 if error occurred
"RTN","GMRCGUIB",79,0)
 ; GMRCERMS - Error message or null
"RTN","GMRCGUIB",80,0)
 ;    returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIB",81,0)
 ;
"RTN","GMRCGUIB",82,0)
 N GMRCERR,GMRCERMS
"RTN","GMRCGUIB",83,0)
 L +^GMR(123,GMRCO):5 I '$T S GMRCERR=1,GMRCERMS="Record Locked. File Update Not Accomplished." Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",84,0)
 S GMRCERR=0,GMRCERMS="",DR="",GMRCORTX=""
"RTN","GMRCGUIB",85,0)
 N GMRCADUZ S GMRCADUZ=""
"RTN","GMRCGUIB",86,0)
 S GMRCNOW=$$NOW^XLFDT,GMRCSTS=$P(^GMR(123,+GMRCO,0),"^",12),GMRCDFN=$P(^(0),"^",2)
"RTN","GMRCGUIB",87,0)
 I '$G(GMRCDUZ) S GMRCDUZ=DUZ
"RTN","GMRCGUIB",88,0)
 I '$G(GMRCAD) S GMRCAD=GMRCNOW
"RTN","GMRCGUIB",89,0)
 I +$G(GMRCA),GMRCA=10 D
"RTN","GMRCGUIB",90,0)
 .S GMRCSF=$G(GMRCSF,"")
"RTN","GMRCGUIB",91,0)
 .S GMRCSTS=2
"RTN","GMRCGUIB",92,0)
 .S DR="8////^S X=GMRCSTS;9////^S X=GMRCA"
"RTN","GMRCGUIB",93,0)
 .S GMRCORTX="Completed Consult "_$$ORTX^GMRCAU(+GMRCO)_$S(GMRCSF="Y":" with Sig Findings",GMRCSF="N":" with no Sig Findings",1:"")
"RTN","GMRCGUIB",94,0)
 .I $P($G(^GMR(123,+GMRCO,0)),U,14) S GMRCADUZ($P($G(^(0)),U,14))=""
"RTN","GMRCGUIB",95,0)
 .Q
"RTN","GMRCGUIB",96,0)
 I $G(GMRCALF)=1 D
"RTN","GMRCGUIB",97,0)
 .N I
"RTN","GMRCGUIB",98,0)
 .F I=1:1  S X=$P(GMRCATO,";",I) Q:X=""  S GMRCADUZ(X)=""
"RTN","GMRCGUIB",99,0)
 .Q
"RTN","GMRCGUIB",100,0)
 I $L(GMRCA),GMRCA=4 S DR=DR_$S($L(DR):";",1:"")_"9////^S X=GMRCA;15////^S X=GMRCSF" D
"RTN","GMRCGUIB",101,0)
 .S GMRCORTX=$S(GMRCSF="Y":"Sig Findings ",GMRCSF="N":"No Sig Findings ",1:"Unknown Sig Findings ")_"for consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCGUIB",102,0)
 .I $P($G(^GMR(123,+GMRCO,0)),U,14) S GMRCADUZ($P($G(^(0)),U,14))=""
"RTN","GMRCGUIB",103,0)
 .Q
"RTN","GMRCGUIB",104,0)
 I $L(DR) S DIE="^GMR(123,",DA=GMRCO D ^DIE K DIE,DR
"RTN","GMRCGUIB",105,0)
 I '$O(GMRCOM(0)) D AUDIT^GMRCP
"RTN","GMRCGUIB",106,0)
 I $D(GMRCOM),$O(GMRCOM(0)) D
"RTN","GMRCGUIB",107,0)
 .N DA
"RTN","GMRCGUIB",108,0)
 .S DA=$$SETDA()
"RTN","GMRCGUIB",109,0)
 .D SETCOM(.GMRCOM,GMRCDUZ)
"RTN","GMRCGUIB",110,0)
 .Q
"RTN","GMRCGUIB",111,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCGUIB",112,0)
 ;
"RTN","GMRCGUIB",113,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,$S(GMRCA=20:63,1:23),.GMRCADUZ,0)
"RTN","GMRCGUIB",114,0)
 ;
"RTN","GMRCGUIB",115,0)
 I $S(GMRCA=10:1,(GMRCA=4&($P(^GMR(123,GMRCO,0),U,12)=2)):1,1:0) D
"RTN","GMRCGUIB",116,0)
 . D EN^GMRCHL7($P(^GMR(123,GMRCO,0),"^",2),GMRCO,$G(GMRCTYPE),$G(GMRCRB),"RE",GMRCORNP,$G(GMRCVSIT),.GMRCOM,,GMRCAD)
"RTN","GMRCGUIB",117,0)
 K DIE,DR,DA,GMRCDT,GMRCNOW,GMRCAD,GMRCORNP,GMRCDUZ,GMRCRSLT,GMRCSTS,GMRCADUZ,GMRCORTX,GMRCDFN
"RTN","GMRCGUIB",118,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",119,0)
 ;
"RTN","GMRCGUIB",120,0)
SCH(GMRCO,GMRCORNP,GMRCAD,GMRCADUZ,GMRCMT) ;schedule a consult API
"RTN","GMRCGUIB",121,0)
 ; Input variables:
"RTN","GMRCGUIB",122,0)
 ;GMRCO - The internal file number of the consult from File 123
"RTN","GMRCGUIB",123,0)
 ;GMRCORNP - Name of the person who actually 'Received' the consult 
"RTN","GMRCGUIB",124,0)
 ;GMRCAD - Actual date time that consult was received into the service.
"RTN","GMRCGUIB",125,0)
 ;GMRCADUZ - array of alert recipients as chosen by user (by reference)
"RTN","GMRCGUIB",126,0)
 ;   ARRAY(DUZ)="" 
"RTN","GMRCGUIB",127,0)
 ;GMRCMT - array of comments if entered (by reference)
"RTN","GMRCGUIB",128,0)
 ;   ARRAY(1)="FIRST LINE OF COMMENT"
"RTN","GMRCGUIB",129,0)
 ;   ARRAY(2)="SECOND LINE OF COMMENT"
"RTN","GMRCGUIB",130,0)
 ;
"RTN","GMRCGUIB",131,0)
 ;Output:
"RTN","GMRCGUIB",132,0)
 ;GMRCERR - Error Condition Code: 0 = NO error, 1=error
"RTN","GMRCGUIB",133,0)
 ;GMRCERMS - Error message or null
"RTN","GMRCGUIB",134,0)
 ;  returned as GMRCERR^GMRCERMS
"RTN","GMRCGUIB",135,0)
        ;
"RTN","GMRCGUIB",136,0)
 N DFN,GMRCSTS,GMRCNOW,GMRCERR,GMRCERMS
"RTN","GMRCGUIB",137,0)
 S GMRCERR=0,GMRCERMS="",GMRCNOW=$$NOW^XLFDT
"RTN","GMRCGUIB",138,0)
 S:$G(GMRCAD)="" GMRCAD=GMRCNOW
"RTN","GMRCGUIB",139,0)
 S:'$G(GMRCDUZ) GMRCDUZ=DUZ
"RTN","GMRCGUIB",140,0)
 S DFN=$P($G(^GMR(123,GMRCO,0)),"^",2) I DFN="" D  Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",141,0)
 . S GMRCERR="1",GMRCERMS="Not A Valid Consult - File Not Found."
"RTN","GMRCGUIB",142,0)
 . D EXIT^GMRCGUIA
"RTN","GMRCGUIB",143,0)
 S GMRCSTS=8,GMRCA=8
"RTN","GMRCGUIB",144,0)
 D STATUS^GMRCP I $D(GMRCQUT) D EXIT^GMRCGUIA Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",145,0)
 I '$O(GMRCMT(0)) D AUDIT^GMRCP
"RTN","GMRCGUIB",146,0)
 I $O(GMRCMT(0)) D
"RTN","GMRCGUIB",147,0)
 . S DA=$$SETDA
"RTN","GMRCGUIB",148,0)
 . D SETCOM(.GMRCMT,GMRCDUZ)
"RTN","GMRCGUIB",149,0)
 D EN^GMRCHL7(DFN,GMRCO,"","","SC",GMRCORNP,"","","",GMRCAD)
"RTN","GMRCGUIB",150,0)
 D  ;send alerts
"RTN","GMRCGUIB",151,0)
 . N TXT
"RTN","GMRCGUIB",152,0)
 . S TXT="Scheduled Consult: "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCGUIB",153,0)
 . I $P(^GMR(123,+GMRCO,0),U,14) S GMRCADUZ($P(^(0),U,14))=""
"RTN","GMRCGUIB",154,0)
 . D MSG^GMRCP(DFN,TXT,GMRCO,63,.GMRCADUZ,0)
"RTN","GMRCGUIB",155,0)
 D EXIT^GMRCGUIA
"RTN","GMRCGUIB",156,0)
 Q GMRCERR_"^"_GMRCERMS
"RTN","GMRCGUIB",157,0)
DOCLIST(GMRCAR,GMRCDA,GMRCMED)  ;return list of linked results
"RTN","GMRCGUIB",158,0)
 ; Input:
"RTN","GMRCGUIB",159,0)
 ;  GMRCAR - array to return list, passed by reference
"RTN","GMRCGUIB",160,0)
 ;  GMRCDA - ien from file 123
"RTN","GMRCGUIB",161,0)
 ;  GMRCMED- 1 = include med results; 0 = only TIU docs
"RTN","GMRCGUIB",162,0)
 ;
"RTN","GMRCGUIB",163,0)
 ; Output:
"RTN","GMRCGUIB",164,0)
 ;  GMRCAR - array in format
"RTN","GMRCGUIB",165,0)
 ;       GMRCAR(0)=zero node of record
"RTN","GMRCGUIB",166,0)
 ;       GMRCAR(50,1)="ien;global ref," e.g. 5;TIU(8925, or 3;MCAR(691,
"RTN","GMRCGUIB",167,0)
 ;       GMRCAR(50,2)="ien;global ref,"
"RTN","GMRCGUIB",168,0)
 ;
"RTN","GMRCGUIB",169,0)
 I '$D(^GMR(123,GMRCDA,0)) Q
"RTN","GMRCGUIB",170,0)
 S GMRCAR(0)=^GMR(123,GMRCDA,0),$P(GMRCAR(0),U,20)=""
"RTN","GMRCGUIB",171,0)
 N RES,CNT S RES="",CNT=1
"RTN","GMRCGUIB",172,0)
 F  S RES=$O(^GMR(123,GMRCDA,50,"B",RES)) Q:RES=""  D
"RTN","GMRCGUIB",173,0)
 . I '$G(GMRCMED) Q:RES'["TIU(8925"
"RTN","GMRCGUIB",174,0)
 . S GMRCAR(50,CNT)=RES
"RTN","GMRCGUIB",175,0)
 . I RES["MCAR" D
"RTN","GMRCGUIB",176,0)
 .. N ARR,STR
"RTN","GMRCGUIB",177,0)
 .. D MEDLKUP^MCARUTL3(.ARR,+$P(RES,"MCAR(",2),+RES)
"RTN","GMRCGUIB",178,0)
 .. I '+ARR K GMRCAR(50,CNT) Q
"RTN","GMRCGUIB",179,0)
 .. S STR=$P(ARR,U,9)_U_$P(ARR,U,6)_$S($P(ARR,U,10):"^^^^^^^^1",1:"")
"RTN","GMRCGUIB",180,0)
 .. S GMRCAR(50,CNT)=GMRCAR(50,CNT)_U_STR
"RTN","GMRCGUIB",181,0)
 . S CNT=CNT+1
"RTN","GMRCGUIB",182,0)
 Q
"RTN","GMRCIAC2")
0^1^B37911897
"RTN","GMRCIAC2",1,0)
GMRCIAC2 ;SLC/JFR - FILE IFC ACTIVITIES CONT'D ;07/08/03 11:30
"RTN","GMRCIAC2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28,35**;DEC 27, 1997
"RTN","GMRCIAC2",3,0)
 Q  ;can't start here
"RTN","GMRCIAC2",4,0)
FILRES(GMRCO,GMRCOBX) ;file or delete results
"RTN","GMRCIAC2",5,0)
 N GMRCRES,GMRCFIL,GMRCSITE,GMRCROOT,RESIEN,GMRCERR
"RTN","GMRCIAC2",6,0)
 S GMRCRES=+$P(GMRCOBX,"|",5)
"RTN","GMRCIAC2",7,0)
 S GMRCFIL=$P($P(GMRCOBX,"|",3),U,3)
"RTN","GMRCIAC2",8,0)
 S GMRCROOT=$S($P($P(GMRCOBX,"|",3),U,2)["TIU":"TIU(",1:"MCAR(")
"RTN","GMRCIAC2",9,0)
 S GMRCFIL=$P(GMRCFIL,"VA",2)
"RTN","GMRCIAC2",10,0)
 S GMRCRES=GMRCRES_";"_GMRCROOT_GMRCFIL
"RTN","GMRCIAC2",11,0)
 S GMRCSITE=$$IEN^XUAF4($P($P(GMRCOBX,"|",5),U,3))
"RTN","GMRCIAC2",12,0)
 I $P(GMRCOBX,"|",11)'="D" D  ;add new result
"RTN","GMRCIAC2",13,0)
 . S FDA(1,123.051,"+1,"_GMRCO_",",.01)=$$NOW^XLFDT
"RTN","GMRCIAC2",14,0)
 . S FDA(1,123.051,"+1,"_GMRCO_",",.02)=GMRCRES
"RTN","GMRCIAC2",15,0)
 . S FDA(1,123.051,"+1,"_GMRCO_",",.03)=GMRCSITE
"RTN","GMRCIAC2",16,0)
 I $P(GMRCOBX,"|",11)="D" D  ; find and delete result
"RTN","GMRCIAC2",17,0)
 . N RESIEN
"RTN","GMRCIAC2",18,0)
 . S RESIEN=$O(^GMR(123,GMRCO,51,"AR",GMRCRES,GMRCSITE,0))
"RTN","GMRCIAC2",19,0)
 . I 'RESIEN Q
"RTN","GMRCIAC2",20,0)
 . S FDA(1,123.051,RESIEN_","_GMRCO_",",.01)="@"
"RTN","GMRCIAC2",21,0)
 I '$D(FDA) Q
"RTN","GMRCIAC2",22,0)
 D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIAC2",23,0)
 Q
"RTN","GMRCIAC2",24,0)
 ;
"RTN","GMRCIAC2",25,0)
UPDORD(GMRCDA,GMRC40) ; update CPRS order if action on placer order.
"RTN","GMRCIAC2",26,0)
 ; Input:
"RTN","GMRCIAC2",27,0)
 ;  GMRCDA   = ien from file 123
"RTN","GMRCIAC2",28,0)
 ;  GMRC40 = ien of activity in 40 multiple
"RTN","GMRCIAC2",29,0)
 ;
"RTN","GMRCIAC2",30,0)
 N GMRCDFN,GMRCAD,AC,GMRCOC,GMRCMT
"RTN","GMRCIAC2",31,0)
 S GMRCDFN=$P(^GMR(123,GMRCDA,0),U,2)
"RTN","GMRCIAC2",32,0)
 I $O(^GMR(123,GMRCDA,40,GMRC40,1,0)) D
"RTN","GMRCIAC2",33,0)
 . S GMRCMT=1,GMRCMT(0)=GMRC40
"RTN","GMRCIAC2",34,0)
 S GMRCAD=$P(^GMR(123,GMRCDA,40,GMRC40,0),U,3)
"RTN","GMRCIAC2",35,0)
 S AC=$P(^GMR(123,GMRCDA,40,GMRC40,0),U,2)
"RTN","GMRCIAC2",36,0)
 S GMRCOC=$S(AC=6:"OD",AC=19:"OC",AC=10:"RE",AC=9:"RE",AC=8:"ZC",1:"SC")
"RTN","GMRCIAC2",37,0)
 D EN^GMRCHL7(GMRCDFN,GMRCDA,"","",GMRCOC,"","",.GMRCMT,,GMRCAD)
"RTN","GMRCIAC2",38,0)
 Q
"RTN","GMRCIAC2",39,0)
FILEACT(GMRCO,GMRCLAST,GMRCFR,GMRCAR) ;file REQUEST PROCESSING ACTIVITY 
"RTN","GMRCIAC2",40,0)
 ; Input:
"RTN","GMRCIAC2",41,0)
 ;  GMRCO     = ien from file 123
"RTN","GMRCIAC2",42,0)
 ;  GMRCLAST  = last action taken on request
"RTN","GMRCIAC2",43,0)
 ;  GMRCFR    = service that consult was forwarded from
"RTN","GMRCIAC2",44,0)
 ;  GMRCAR    = name of the array containing the message
"RTN","GMRCIAC2",45,0)
 ;
"RTN","GMRCIAC2",46,0)
 N GMRCORC,GMRCFDA,GMRCRP,GMRCEP,GMRCACT,GMRCERR,FDA
"RTN","GMRCIAC2",47,0)
 M ^TMP("GMRCFIL",$J)=@GMRCAR
"RTN","GMRCIAC2",48,0)
 S GMRCORC=^TMP("GMRCFIL",$J,"ORC")
"RTN","GMRCIAC2",49,0)
 S GMRCFDA(.01)=$$NOW^XLFDT
"RTN","GMRCIAC2",50,0)
 S GMRCFDA(.25)=$$HL7TFM^XLFDT($P(GMRCORC,"|",9))
"RTN","GMRCIAC2",51,0)
 S GMRCFDA(1)=GMRCLAST
"RTN","GMRCIAC2",52,0)
 S GMRCFDA(2)=$$HL7TFM^XLFDT($P(GMRCORC,"|",15))
"RTN","GMRCIAC2",53,0)
 D  ;get entering and responsible persons
"RTN","GMRCIAC2",54,0)
 . D UNHLNAME^GMRCIUTL($P(GMRCORC,"|",10),.GMRCEP,0,U)
"RTN","GMRCIAC2",55,0)
 . D UNHLNAME^GMRCIUTL($P(GMRCORC,"|",12),.GMRCRP,0,U)
"RTN","GMRCIAC2",56,0)
 S GMRCFDA(.21)=GMRCEP
"RTN","GMRCIAC2",57,0)
 S GMRCFDA(.22)=GMRCRP
"RTN","GMRCIAC2",58,0)
 S GMRCFDA(.23)=$P($G(^TMP("GMRCFIL",$J,"OBX",5,1)),"|",5)
"RTN","GMRCIAC2",59,0)
 I $D(GMRCFR) S GMRCFDA(.31)=GMRCFR
"RTN","GMRCIAC2",60,0)
 I $D(^TMP("GMRCFIL",$J,"OBX",4)) D
"RTN","GMRCIAC2",61,0)
 . N RFIL,RSLT,DESC,GMRCOBX,ROOT,RSITE
"RTN","GMRCIAC2",62,0)
 . S GMRCOBX=^TMP("GMRCFIL",$J,"OBX",4,1)
"RTN","GMRCIAC2",63,0)
 . S RFIL=$P($P(GMRCOBX,"|",3),U,3),RFIL=$P(RFIL,"VA",2)
"RTN","GMRCIAC2",64,0)
 . S RSLT=+$P(GMRCOBX,"|",5)
"RTN","GMRCIAC2",65,0)
 . S RSITE=$$IEN^XUAF4($P($P(GMRCOBX,"|",5),U,3))
"RTN","GMRCIAC2",66,0)
 . S ROOT=$S($P($P(GMRCOBX,"|",3),U,2)["TIU":"TIU(",1:"MCAR(")
"RTN","GMRCIAC2",67,0)
 . S DESC=$P($P(GMRCOBX,"|",5),U,2)
"RTN","GMRCIAC2",68,0)
 . S GMRCFDA(.24)=RSLT_";"_ROOT_RFIL_";"_DESC_";"_RSITE
"RTN","GMRCIAC2",69,0)
 I GMRCLAST=10 D  ; overwite inc. report in last action?
"RTN","GMRCIAC2",70,0)
 . N GMRCLACT
"RTN","GMRCIAC2",71,0)
 . S GMRCLACT=$O(^GMR(123,GMRCO,40," "),-1)
"RTN","GMRCIAC2",72,0)
 . I '$G(GMRCLACT) Q
"RTN","GMRCIAC2",73,0)
 . I $P($G(^GMR(123,GMRCO,40,GMRCLACT,0)),U,2)'=9 Q
"RTN","GMRCIAC2",74,0)
 . I $$FMDIFF^XLFDT($$NOW^XLFDT,+^GMR(123,GMRCO,40,GMRCLACT,0),2)>900 Q
"RTN","GMRCIAC2",75,0)
 . I $P($G(^GMR(123,GMRCO,40,GMRCLACT,2)),U,4)=GMRCFDA(.24) D
"RTN","GMRCIAC2",76,0)
 .. S GMRCACT(1)=GMRCLACT
"RTN","GMRCIAC2",77,0)
 .. M FDA(1,123.02,GMRCACT(1)_","_GMRCO_",")=GMRCFDA
"RTN","GMRCIAC2",78,0)
 .. D UPDATE^DIE("","FDA(1)",,"GMRCERR")
"RTN","GMRCIAC2",79,0)
 . Q
"RTN","GMRCIAC2",80,0)
 I '$D(GMRCACT(1)) D  ; need to create new activity
"RTN","GMRCIAC2",81,0)
 . M FDA(1,123.02,"+1,"_GMRCO_",")=GMRCFDA
"RTN","GMRCIAC2",82,0)
 . D UPDATE^DIE("","FDA(1)","GMRCACT","GMRCERR")
"RTN","GMRCIAC2",83,0)
 K GMRCFDA,FDA
"RTN","GMRCIAC2",84,0)
 D  ; file comments if present
"RTN","GMRCIAC2",85,0)
 . I $D(^TMP("GMRCFIL",$J,"OBX",3)) D  ; general comments
"RTN","GMRCIAC2",86,0)
 .. N TMPARR
"RTN","GMRCIAC2",87,0)
 .. S TMPARR=$NA(^TMP("GMRCFIL",$J,"OBX",3))
"RTN","GMRCIAC2",88,0)
 .. D TRIMWP^GMRCIUTL(TMPARR,5)
"RTN","GMRCIAC2",89,0)
 .. D WP^DIE(123.02,GMRCACT(1)_","_GMRCO_",",5,"K",TMPARR)
"RTN","GMRCIAC2",90,0)
 . I $D(^TMP("GMRCFIL",$J,"NTE")) D  ; DC or cancel comments
"RTN","GMRCIAC2",91,0)
 .. N TMPARR
"RTN","GMRCIAC2",92,0)
 .. S TMPARR=$NA(^TMP("GMRCFIL",$J,"NTE"))
"RTN","GMRCIAC2",93,0)
 .. D TRIMWP^GMRCIUTL(TMPARR,3)
"RTN","GMRCIAC2",94,0)
 .. D WP^DIE(123.02,GMRCACT(1)_","_GMRCO_",",5,"K",TMPARR)
"RTN","GMRCIAC2",95,0)
 .. Q
"RTN","GMRCIAC2",96,0)
 D  ; update order if necessary
"RTN","GMRCIAC2",97,0)
 . I $P($G(^GMR(123,GMRCO,12)),U,5)="F" Q  ; fillers have no order
"RTN","GMRCIAC2",98,0)
 . I GMRCLAST=11!(GMRCLAST=13)!(GMRCLAST=14) Q  ;no status chg
"RTN","GMRCIAC2",99,0)
 . I GMRCLAST=4!(GMRCLAST=20) Q  ;no status chg
"RTN","GMRCIAC2",100,0)
 . D UPDORD(GMRCO,GMRCACT(1))
"RTN","GMRCIAC2",101,0)
 K ^TMP("GMRCFIL",$J)
"RTN","GMRCIAC2",102,0)
 Q
"RTN","GMRCIAC2",103,0)
 ;
"RTN","GMRCIAC2",104,0)
TST(ARRAY) ;process test message and check item ordered
"RTN","GMRCIAC2",105,0)
 ;Input:
"RTN","GMRCIAC2",106,0)
 ; ARRAY  = name of array containing message parts
"RTN","GMRCIAC2",107,0)
 ;
"RTN","GMRCIAC2",108,0)
 N GMRCFDA,GMRCORC,GMRCDA,GMRCITM,GMRCITER
"RTN","GMRCIAC2",109,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC2",110,0)
 M ^TMP("GMRCIN",$J)=@ARRAY
"RTN","GMRCIAC2",111,0)
 D  ;get ordered item and service
"RTN","GMRCIAC2",112,0)
 . S GMRCITM=$P(^TMP("GMRCIN",$J,"OBR"),"|",4)
"RTN","GMRCIAC2",113,0)
 . I GMRCITM["VA1233" D  ; proc
"RTN","GMRCIAC2",114,0)
 .. N PROC
"RTN","GMRCIAC2",115,0)
 .. S PROC=$$GETPROC^GMRCIUTL(GMRCITM)
"RTN","GMRCIAC2",116,0)
 .. I +PROC'>0!('$P(PROC,U,2)) S GMRCITER=$P(PROC,U,3) Q
"RTN","GMRCIAC2",117,0)
 . I GMRCITM["VA1235" D
"RTN","GMRCIAC2",118,0)
 .. N SERV
"RTN","GMRCIAC2",119,0)
 .. S SERV=$$GETSERV^GMRCIUTL(GMRCITM) ;consult
"RTN","GMRCIAC2",120,0)
 .. I +SERV'>0 S GMRCITER=$P(SERV,U,3)
"RTN","GMRCIAC2",121,0)
 I $D(GMRCITER) D  ;error in procedure or service, reject new order
"RTN","GMRCIAC2",122,0)
 . N GMRCRSLT
"RTN","GMRCIAC2",123,0)
 . D RESP^GMRCIUTL("AR",HL("MID"),,,GMRCITER) ;build HLA(
"RTN","GMRCIAC2",124,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIAC2",125,0)
 I '$D(GMRCITER) D
"RTN","GMRCIAC2",126,0)
 . N GMRCRSLT
"RTN","GMRCIAC2",127,0)
 . D RESP^GMRCIUTL("AA",HL("MID")) ;build HLA(
"RTN","GMRCIAC2",128,0)
 . D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIAC2",129,0)
 K ^TMP("GMRCIN",$J)
"RTN","GMRCIAC2",130,0)
 Q
"RTN","GMRCIAC2",131,0)
 ;
"RTN","GMRCIAC2",132,0)
GETDA(GMRCORC) ; determine what local Consult ien to work on
"RTN","GMRCIAC2",133,0)
 ; Input:
"RTN","GMRCIAC2",134,0)
 ;  GMRCORC = ORC seg from incoming message
"RTN","GMRCIAC2",135,0)
 ; Output:
"RTN","GMRCIAC2",136,0)
 ;  ien from file 123
"RTN","GMRCIAC2",137,0)
 ;
"RTN","GMRCIAC2",138,0)
 N GMRCORC2,GMRCORC3
"RTN","GMRCIAC2",139,0)
 S GMRCORC2=$P(GMRCORC,"|",2),GMRCORC3=$P(GMRCORC,"|",3)
"RTN","GMRCIAC2",140,0)
 I $$IEN^XUAF4($P(GMRCORC2,U,2))=$$KSP^XUPARAM("INST") Q +GMRCORC2
"RTN","GMRCIAC2",141,0)
 Q +GMRCORC3
"RTN","GMRCIAC2",142,0)
 ;
"RTN","GMRCIAC2",143,0)
DUPACT(GMRCO,ACTVT,ORC,OBX) ;check to see if activity is a dup transmission
"RTN","GMRCIAC2",144,0)
 ;Input:
"RTN","GMRCIAC2",145,0)
 ;  GMRCO = ien of consult
"RTN","GMRCIAC2",146,0)
 ;  ACTVT = ien of activity from file 123.1
"RTN","GMRCIAC2",147,0)
 ;  ORC   = ORC segment from message
"RTN","GMRCIAC2",148,0)
 ;  OBX   = OBX segment containing result
"RTN","GMRCIAC2",149,0)
 ;
"RTN","GMRCIAC2",150,0)
 ;Output:
"RTN","GMRCIAC2",151,0)
 ;  0  = activity is not a duplicate of one on file already
"RTN","GMRCIAC2",152,0)
 ;  1  = duplicate, activity already on file
"RTN","GMRCIAC2",153,0)
 ;
"RTN","GMRCIAC2",154,0)
 N GMRCIADT,GMRCIFDT,DUP
"RTN","GMRCIAC2",155,0)
 S GMRCIFDT=+$$HL7TFM^XLFDT($P(ORC,"|",9))
"RTN","GMRCIAC2",156,0)
 S GMRCIADT=+$$HL7TFM^XLFDT($P(ORC,"|",15))
"RTN","GMRCIAC2",157,0)
 S DUP=0
"RTN","GMRCIAC2",158,0)
 I $D(^GMR(123,GMRCO,40,"AC",ACTVT,GMRCIFDT,GMRCIADT)) D  Q DUP ;dupl.
"RTN","GMRCIAC2",159,0)
 . N RSLT,RFIL,RSITE,ROOT
"RTN","GMRCIAC2",160,0)
 . I $L($G(OBX)) D  Q:'$G(DUP)
"RTN","GMRCIAC2",161,0)
 .. S RFIL=$P($P(OBX,"|",3),U,3),RFIL=$P(RFIL,"VA",2)
"RTN","GMRCIAC2",162,0)
 .. S RSLT=+$P(OBX,"|",5)
"RTN","GMRCIAC2",163,0)
 .. S RSITE=$$IEN^XUAF4($P($P(OBX,"|",5),U,3))
"RTN","GMRCIAC2",164,0)
 .. S ROOT=$S($P($P(OBX,"|",3),U,2)["TIU":"TIU(",1:"MCAR(")
"RTN","GMRCIAC2",165,0)
 .. S RSLT=RSLT_";"_ROOT_RFIL
"RTN","GMRCIAC2",166,0)
 .. I ACTVT=12,$D(^GMR(123,GMRCO,51,"AR",RSLT,RSITE)) Q  ;no dup
"RTN","GMRCIAC2",167,0)
 .. I ACTVT'=12,'$D(^GMR(123,GMRCO,51,"AR",RSLT,RSITE)) Q  ;no dup
"RTN","GMRCIAC2",168,0)
 .. S DUP=1
"RTN","GMRCIAC2",169,0)
 . S DUP=1
"RTN","GMRCIAC2",170,0)
 . D APPACK(GMRCO,"AR",802) ;send app. ACK and unlock record
"RTN","GMRCIAC2",171,0)
 Q 0
"RTN","GMRCIAC2",172,0)
 ;
"RTN","GMRCIAC2",173,0)
APPACK(GMRCO,ACK,ERR) ;send application acknowledgement for all cases
"RTN","GMRCIAC2",174,0)
 ;Input:
"RTN","GMRCIAC2",175,0)
 ;  GMRCO = ien from file 123
"RTN","GMRCIAC2",176,0)
 ;  ACK   = ACK code to include  ("AA"=accept or "AR"=reject)
"RTN","GMRCIAC2",177,0)
 ;  ERR   = error code to return if there is one (optional)
"RTN","GMRCIAC2",178,0)
 ;
"RTN","GMRCIAC2",179,0)
 ; Output: none
"RTN","GMRCIAC2",180,0)
 ;
"RTN","GMRCIAC2",181,0)
 ;send appl ACK
"RTN","GMRCIAC2",182,0)
 N GMRCRSLT
"RTN","GMRCIAC2",183,0)
 I '$G(ERR) S ERR=""
"RTN","GMRCIAC2",184,0)
 D RESP^GMRCIUTL(ACK,HL("MID"),,,ERR) ;build HLA("HLA", array
"RTN","GMRCIAC2",185,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.GMRCRSLT)
"RTN","GMRCIAC2",186,0)
 ;
"RTN","GMRCIAC2",187,0)
 D UNLKREC^GMRCUTL1(GMRCO) ;unlock record
"RTN","GMRCIAC2",188,0)
 Q
"RTN","GMRCIBKG")
0^3^B39458433
"RTN","GMRCIBKG",1,0)
GMRCIBKG ;SLC/JFR - IFC BACKGROUND ERROR PROCESSOR; 07/02/03 13:54
"RTN","GMRCIBKG",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28,30,35**;DEC 27, 1997
"RTN","GMRCIBKG",3,0)
 ;
"RTN","GMRCIBKG",4,0)
 ; This routine invokes IA# 3335
"RTN","GMRCIBKG",5,0)
 ;
"RTN","GMRCIBKG",6,0)
EN ;process file 123.6 and take action
"RTN","GMRCIBKG",7,0)
 ;Start background process
"RTN","GMRCIBKG",8,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","GMRCIBKG",9,0)
 ;
"RTN","GMRCIBKG",10,0)
 ; OK to run?
"RTN","GMRCIBKG",11,0)
 I '$$GONOGO Q
"RTN","GMRCIBKG",12,0)
 ;
"RTN","GMRCIBKG",13,0)
 ; set start param to NOW and run
"RTN","GMRCIBKG",14,0)
 D EN^XPAR("SYS","GMRC IFC BACKGROUND START",1,$$NOW^XLFDT)
"RTN","GMRCIBKG",15,0)
 ;
"RTN","GMRCIBKG",16,0)
 N GMRCLOG,GMRCTIM,GMRCLOG0
"RTN","GMRCIBKG",17,0)
 S GMRCLOG=0
"RTN","GMRCIBKG",18,0)
 S GMRCTIM=$$FMADD^XLFDT($$NOW^XLFDT,,-1)
"RTN","GMRCIBKG",19,0)
 F  S GMRCLOG=$O(^GMR(123.6,GMRCLOG)) Q:'GMRCLOG  D
"RTN","GMRCIBKG",20,0)
 . S GMRCLOG0=$G(^GMR(123.6,GMRCLOG,0))
"RTN","GMRCIBKG",21,0)
 . ;
"RTN","GMRCIBKG",22,0)
 . ;  v-- resend if couldn't update file immediately
"RTN","GMRCIBKG",23,0)
 . I $P(GMRCLOG0,U,6),$P(GMRCLOG0,U,8)=901 D  Q
"RTN","GMRCIBKG",24,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",25,0)
 . ;  v-- wait at least 1 hour on all other errors
"RTN","GMRCIBKG",26,0)
 . I $P(GMRCLOG0,U)>GMRCTIM Q
"RTN","GMRCIBKG",27,0)
 . ;  v-- if incomplete activity is now the earliest, resend it
"RTN","GMRCIBKG",28,0)
 . I $P(GMRCLOG0,U,6),$P(GMRCLOG0,U,8)=902 D  Q
"RTN","GMRCIBKG",29,0)
 .. Q:$O(^GMR(123.6,"AC",$P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)),-1)
"RTN","GMRCIBKG",30,0)
 .. D DELALRT(GMRCLOG)
"RTN","GMRCIBKG",31,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",32,0)
 . ; v-- delete complete entries after # in GMRC RETAIN IFC ACTIVITY DAYS
"RTN","GMRCIBKG",33,0)
 . I '$P(GMRCLOG0,U,6) D  Q
"RTN","GMRCIBKG",34,0)
 .. N DIK,DA,GMRCRETN
"RTN","GMRCIBKG",35,0)
 .. S GMRCRETN=$$GET^XPAR("SYS","GMRC RETAIN IFC ACTIVITY DAYS",1)
"RTN","GMRCIBKG",36,0)
 .. I 'GMRCRETN S GMRCRETN=7
"RTN","GMRCIBKG",37,0)
 .. I $P(GMRCLOG0,U)>$$FMADD^XLFDT(GMRCTIM,(0-GMRCRETN)) Q  ;don't delete
"RTN","GMRCIBKG",38,0)
 .. S DIK="^GMR(123.6,",DA=GMRCLOG
"RTN","GMRCIBKG",39,0)
 .. D ^DIK ;remove old completed entries
"RTN","GMRCIBKG",40,0)
 . ;
"RTN","GMRCIBKG",41,0)
 . ;  v-- resend unknown patient errors after 3 hours
"RTN","GMRCIBKG",42,0)
 . I $P(GMRCLOG0,U,8)=201,GMRCLOG0<$$FMADD^XLFDT($$NOW^XLFDT,,-3) D  Q
"RTN","GMRCIBKG",43,0)
 .. N GMRCSND,GMRCPAR,DOW
"RTN","GMRCIBKG",44,0)
 .. S GMRCPAR=$$GET^XPAR("SYS","GMRC IFC SKIP WEEKEND RE-TRANS",1)
"RTN","GMRCIBKG",45,0)
 .. S DOW=$$DOW^XLFDT(DT,1)
"RTN","GMRCIBKG",46,0)
 .. S GMRCSND=$S('GMRCPAR:1,(+DOW&(DOW<6)):1,1:0)
"RTN","GMRCIBKG",47,0)
 .. I GMRCSND D  ;re-send based on parameter and day of week
"RTN","GMRCIBKG",48,0)
 ... D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",49,0)
 ... D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5))
"RTN","GMRCIBKG",50,0)
 .. I '($P(GMRCLOG0,U,7)#8),GMRCSND D
"RTN","GMRCIBKG",51,0)
 ... ;alert CAC's about errors every 24 hrs.
"RTN","GMRCIBKG",52,0)
 ... D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",53,0)
 ... D SNDALRT^GMRCIERR(GMRCLOG,"C") ; alert CAC's to patient errors
"RTN","GMRCIBKG",54,0)
 ... D  ; send mail to remote CAC group
"RTN","GMRCIBKG",55,0)
 .... N GMRCLNK,GMRCIQT,HL,HLECH,HLFS,HLQ,PID,DOM,STA,GMRCLNK,OBR
"RTN","GMRCIBKG",56,0)
 .... D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIBKG",57,0)
 .... D  I $D(GMRCIQT) Q  ;build PID seg if nat'l ICN
"RTN","GMRCIBKG",58,0)
 ..... N GMRCDFN S GMRCDFN=$P(^GMR(123,+$P(GMRCLOG0,U,4),0),U,2)
"RTN","GMRCIBKG",59,0)
 ..... I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIBKG",60,0)
 ..... I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIBKG",61,0)
 ..... I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIBKG",62,0)
 ..... S PID=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIBKG",63,0)
 ..... S PID=$P(PID,"|",2,999)
"RTN","GMRCIBKG",64,0)
 .... D LINK^HLUTIL3($P(GMRCLOG0,U,2),.GMRCLNK)
"RTN","GMRCIBKG",65,0)
 .... S GMRCLNK=$O(GMRCLNK(0)) I 'GMRCLNK Q  ;no link set up
"RTN","GMRCIBKG",66,0)
 .... S DOM=$$GET1^DIQ(870,+GMRCLNK,.03)
"RTN","GMRCIBKG",67,0)
 .... S STA=$$STA^XUAF4($P(GMRCLOG0,U,2))
"RTN","GMRCIBKG",68,0)
 .... S OBR=$E($$OBR^GMRCISG1(+$P(GMRCLOG0,U,4),+$P(GMRCLOG0,U,5)),5,999)
"RTN","GMRCIBKG",69,0)
 .... D PTERRMSG^GMRCIERR(PID,STA,DOM,OBR)
"RTN","GMRCIBKG",70,0)
 . ;
"RTN","GMRCIBKG",71,0)
 . ;  v-- resend local ICN errors after 3 hours
"RTN","GMRCIBKG",72,0)
 . I $P(GMRCLOG0,U,8)=202,GMRCLOG0<$$FMADD^XLFDT($$NOW^XLFDT,,-3) D  Q
"RTN","GMRCIBKG",73,0)
 .. ;re-send based on parameter and day of week
"RTN","GMRCIBKG",74,0)
 .. N GMRCSND,GMRCPAR,DOW
"RTN","GMRCIBKG",75,0)
 .. S GMRCPAR=$$GET^XPAR("SYS","GMRC IFC SKIP WEEKEND RE-TRANS",1)
"RTN","GMRCIBKG",76,0)
 .. S DOW=$$DOW^XLFDT(DT,1)
"RTN","GMRCIBKG",77,0)
 .. S GMRCSND=$S('GMRCPAR:1,(+DOW&(DOW<6)):1,1:0)
"RTN","GMRCIBKG",78,0)
 .. I 'GMRCSND Q  ;don't re-send activity
"RTN","GMRCIBKG",79,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",80,0)
 .. I '($P(GMRCLOG0,U,7)#8) D  ;alert CAC's about errors every 24 hrs 
"RTN","GMRCIBKG",81,0)
 ... D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",82,0)
 ... D SNDALRT^GMRCIERR(GMRCLOG,"C") ; alert CAC's to patient errors
"RTN","GMRCIBKG",83,0)
 . ;  v-- re-process implementation errors
"RTN","GMRCIBKG",84,0)
 . I $P(GMRCLOG0,U,8)>300,$P(GMRCLOG0,U,8)<702 D  Q
"RTN","GMRCIBKG",85,0)
 .. D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",86,0)
 .. D TRIGR^GMRCIEVT($P(GMRCLOG0,U,4),$P(GMRCLOG0,U,5)) ;re-send activity
"RTN","GMRCIBKG",87,0)
 . ;  v-- if incomplete and no error, alert tech group
"RTN","GMRCIBKG",88,0)
 . I '$P(GMRCLOG0,U,8)!($P(GMRCLOG0,U,8)>902) D  Q
"RTN","GMRCIBKG",89,0)
 .. D DELALRT(GMRCLOG) ;delete previous alerts on same transaction
"RTN","GMRCIBKG",90,0)
 .. D SNDALRT^GMRCIERR(GMRCLOG,"T")
"RTN","GMRCIBKG",91,0)
 . Q
"RTN","GMRCIBKG",92,0)
 ;
"RTN","GMRCIBKG",93,0)
 ;  v-- set finish param 
"RTN","GMRCIBKG",94,0)
 D EN^XPAR("SYS","GMRC IFC BACKGROUND FINISH",1,$$NOW^XLFDT)
"RTN","GMRCIBKG",95,0)
 ;  v-- start it again one hour after completing
"RTN","GMRCIBKG",96,0)
 D REQUEUE
"RTN","GMRCIBKG",97,0)
 Q
"RTN","GMRCIBKG",98,0)
 ;
"RTN","GMRCIBKG",99,0)
REQUEUE ;task job to start up again one hour after completing
"RTN","GMRCIBKG",100,0)
 N ZTRTN,ZTSK,ZTIO,ZTDESC,ZTDTH
"RTN","GMRCIBKG",101,0)
 S ZTDESC="IF Consults background error processor"
"RTN","GMRCIBKG",102,0)
 S ZTIO=""
"RTN","GMRCIBKG",103,0)
 S ZTRTN="EN^GMRCIBKG"
"RTN","GMRCIBKG",104,0)
 S ZTDTH=$$FMTH^XLFDT($$FMADD^XLFDT($$NOW^XLFDT,,1))
"RTN","GMRCIBKG",105,0)
 D ^%ZTLOAD
"RTN","GMRCIBKG",106,0)
 Q
"RTN","GMRCIBKG",107,0)
DELALRT(MSGLOG) ;delete obsolete alerts for an entry
"RTN","GMRCIBKG",108,0)
 ; Input:
"RTN","GMRCIBKG",109,0)
 ;   MSGLOG = ien from file 123.6
"RTN","GMRCIBKG",110,0)
 ;
"RTN","GMRCIBKG",111,0)
 N XQAID,XQAKILL
"RTN","GMRCIBKG",112,0)
 S XQAID="GMRCIFC,trans error,"_MSGLOG,XQAKILL=0
"RTN","GMRCIBKG",113,0)
 D DELETEA^XQALERT
"RTN","GMRCIBKG",114,0)
 Q
"RTN","GMRCIBKG",115,0)
 ;
"RTN","GMRCIBKG",116,0)
OVERDUE ; write message for alert to tell IRM job is overdue
"RTN","GMRCIBKG",117,0)
 W @IOF
"RTN","GMRCIBKG",118,0)
 W !,"The Inter-facility Consults background job is overdue."
"RTN","GMRCIBKG",119,0)
 W !,"This is likely due to an error while the job runs. It is suggested"
"RTN","GMRCIBKG",120,0)
 W !,"that you check the systems for errors. If the errors are resolved"
"RTN","GMRCIBKG",121,0)
 W !,"the background job will catch up and run normally. There is a "
"RTN","GMRCIBKG",122,0)
 W !,"remote possibility that the GMRC IFC BACKGROUND... parameters have"
"RTN","GMRCIBKG",123,0)
 W !,"been edited and are out of synch."
"RTN","GMRCIBKG",124,0)
 S XQAKILL=0
"RTN","GMRCIBKG",125,0)
 Q
"RTN","GMRCIBKG",126,0)
 ;
"RTN","GMRCIBKG",127,0)
GONOGO() ; determine if background job should run or not
"RTN","GMRCIBKG",128,0)
 ;Output: 
"RTN","GMRCIBKG",129,0)
 ;  1 = go ahead and run
"RTN","GMRCIBKG",130,0)
 ;  0 = don't run for some reason
"RTN","GMRCIBKG",131,0)
 N GMRCQT
"RTN","GMRCIBKG",132,0)
 S GMRCQT=1
"RTN","GMRCIBKG",133,0)
 D
"RTN","GMRCIBKG",134,0)
 . N GMRCBST,GMRCNOW,GMRCBFI
"RTN","GMRCIBKG",135,0)
 . S GMRCBST=$$GET^XPAR("SYS","GMRC IFC BACKGROUND START",1)
"RTN","GMRCIBKG",136,0)
 . I 'GMRCBST Q  ; has never run or needs to
"RTN","GMRCIBKG",137,0)
 . S GMRCNOW=$$NOW^XLFDT
"RTN","GMRCIBKG",138,0)
 . I GMRCBST>GMRCNOW S GMRCQT=0 Q  ;set to future date/time - don't run
"RTN","GMRCIBKG",139,0)
 . S GMRCBFI=$$GET^XPAR("SYS","GMRC IFC BACKGROUND FINISH",1)
"RTN","GMRCIBKG",140,0)
 . I $$FMDIFF^XLFDT(GMRCNOW,GMRCBFI,2)<3600,GMRCBFI>GMRCBST S GMRCQT=0 Q
"RTN","GMRCIBKG",141,0)
 . ;                 ^--ran < 1 hr ago
"RTN","GMRCIBKG",142,0)
 . I $$FMDIFF^XLFDT(GMRCBST,GMRCBFI,2)>4500 D  Q
"RTN","GMRCIBKG",143,0)
 .. ; >1.5 hrs and job not finishing for some reason, alert techies
"RTN","GMRCIBKG",144,0)
 .. N XQA,XQAMSG,XQAROU,XQAID,XQAKILL
"RTN","GMRCIBKG",145,0)
 .. S XQAID="GMRC IFC BKG",XQAKILL=0 D DELETEA^XQALERT
"RTN","GMRCIBKG",146,0)
 .. S XQA("G.IFC TECH ERRORS")=""
"RTN","GMRCIBKG",147,0)
 .. S XQAMSG="IFC Background job overdue."
"RTN","GMRCIBKG",148,0)
 .. S XQAID="GMRC IFC BKG"
"RTN","GMRCIBKG",149,0)
 .. S XQAROU="OVERDUE^GMRCIBKG"
"RTN","GMRCIBKG",150,0)
 .. D SETUP^XQALERT
"RTN","GMRCIBKG",151,0)
 .. Q
"RTN","GMRCIBKG",152,0)
 . Q
"RTN","GMRCIBKG",153,0)
 Q GMRCQT
"RTN","GMRCIERR")
0^2^B68981625
"RTN","GMRCIERR",1,0)
GMRCIERR ;SLC/JFR - process IFC message error alert ;07/08/03 11:16
"RTN","GMRCIERR",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28,30,35**;DEC 27, 1997
"RTN","GMRCIERR",3,0)
 Q
"RTN","GMRCIERR",4,0)
EN(GMRCLOG,GMRCDA,GMRCACT,GMRCRPT) ;start here
"RTN","GMRCIERR",5,0)
 ;Build ^TMP array for processing alert
"RTN","GMRCIERR",6,0)
 ;
"RTN","GMRCIERR",7,0)
 K ^TMP("GMRCIERR",$J)
"RTN","GMRCIERR",8,0)
 N GMRCPNM,GMRCACTV,GMRCERR,GMRCRP,GMRCEP,GMRCACTM,GMRCCOM,GMRCSS
"RTN","GMRCIERR",9,0)
 N GMRCPROC,GMRCSITE,GMRCFCN,GMRCPT,GMRCSSN,VAHOW,VAROOT
"RTN","GMRCIERR",10,0)
 I '$D(^GMR(123.6,GMRCLOG,0)) D  Q
"RTN","GMRCIERR",11,0)
 . S ^TMP("GMRCIERR",$J,1,0)="Message log entry no longer exists"
"RTN","GMRCIERR",12,0)
 I $P(^GMR(123.6,GMRCLOG,0),U,4)'=GMRCDA D  Q
"RTN","GMRCIERR",13,0)
 . S ^TMP("GMRCIERR",$J,1,0)="Message log entry and Consult# don't match"
"RTN","GMRCIERR",14,0)
 I $P(^GMR(123.6,GMRCLOG,0),U,5)'=GMRCACT D  Q
"RTN","GMRCIERR",15,0)
 . S ^TMP("GMRCIERR",$J,1,0)="Message log entry & activity# don't match"
"RTN","GMRCIERR",16,0)
 S DFN=$P(^GMR(123,GMRCDA,0),U,2),VAROOT="GMRCPT",VAHOW=1
"RTN","GMRCIERR",17,0)
 D DEM^VADPT
"RTN","GMRCIERR",18,0)
 S GMRCPNM=GMRCPT("NM")
"RTN","GMRCIERR",19,0)
 S GMRCSSN=$P(GMRCPT("SS"),U,2)
"RTN","GMRCIERR",20,0)
 S GMRCACTV=$G(^GMR(123,GMRCDA,40,GMRCACT,0))
"RTN","GMRCIERR",21,0)
 S GMRCRP=$$GET1^DIQ(200,+$P(GMRCACTV,U,4),.01)
"RTN","GMRCIERR",22,0)
 S GMRCEP=$$GET1^DIQ(200,+$P(GMRCACTV,U,5),.01)
"RTN","GMRCIERR",23,0)
 S GMRCACTM=$$FMTE^XLFDT($P(GMRCACTV,U,3))
"RTN","GMRCIERR",24,0)
 S GMRCACTV=$$GET1^DIQ(123.1,$P(GMRCACTV,U,2),.01)
"RTN","GMRCIERR",25,0)
 S GMRCCOM=$O(^GMR(123,GMRCDA,40,GMRCACT,1,0))
"RTN","GMRCIERR",26,0)
 S GMRCSS=$$GET1^DIQ(123.5,+$P(^GMR(123,GMRCDA,0),U,5),.01)
"RTN","GMRCIERR",27,0)
 S GMRCPROC=$$GET1^DIQ(123.3,+$P(^GMR(123,GMRCDA,0),U,8),.01)
"RTN","GMRCIERR",28,0)
 S GMRCFCN=$P(^GMR(123,GMRCDA,0),U,22)
"RTN","GMRCIERR",29,0)
 D F4^XUAF4($$STA^XUAF4($P(^GMR(123,GMRCDA,0),U,23)),.GMRCSITE)
"RTN","GMRCIERR",30,0)
 N LN S LN=1
"RTN","GMRCIERR",31,0)
 S ^TMP("GMRCIERR",$J,LN,0)="An error occurred transmitting the following inter-facility consult ",LN=LN+1
"RTN","GMRCIERR",32,0)
 S ^TMP("GMRCIERR",$J,LN,0)="activity to "_GMRCSITE("NAME")_":",LN=LN+1
"RTN","GMRCIERR",33,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",34,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Consult #: "_GMRCDA,LN=LN+1
"RTN","GMRCIERR",35,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Remote Consult #: "_GMRCFCN,LN=LN+1
"RTN","GMRCIERR",36,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Patient Name: "_GMRCPNM,LN=LN+1
"RTN","GMRCIERR",37,0)
 S ^TMP("GMRCIERR",$J,LN,0)="SSN: "_GMRCSSN,LN=LN+1
"RTN","GMRCIERR",38,0)
 S ^TMP("GMRCIERR",$J,LN,0)="To Service: "_GMRCSS,LN=LN+1
"RTN","GMRCIERR",39,0)
 I $L(GMRCPROC) S ^TMP("GMRCIERR",$J,LN,0)="Procedure: "_GMRCPROC,LN=LN+1
"RTN","GMRCIERR",40,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",41,0)
 I '$D(GMRCRPT) D ACTLG(GMRCDA,GMRCACT,GMRCLOG,.LN)
"RTN","GMRCIERR",42,0)
 Q
"RTN","GMRCIERR",43,0)
ACTLG(GMRCDA,GMRCACT,LOG,LN) ;build activity log entry
"RTN","GMRCIERR",44,0)
 N GMRCCT,TAB,GMRCERR,GMRCDIF
"RTN","GMRCIERR",45,0)
 S TAB="",$P(TAB," ",30)=""
"RTN","GMRCIERR",46,0)
 S GMRCERR=$T(@("ERR"_$P(^GMR(123.6,LOG,0),U,8)_"^GMRCIUTL"))
"RTN","GMRCIERR",47,0)
 S GMRCERR=$S($L(GMRCERR):$P(GMRCERR,";",2),1:"Technical error")
"RTN","GMRCIERR",48,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Activity #: "_GMRCACT,LN=LN+1
"RTN","GMRCIERR",49,0)
 S ^TMP("GMRCIERR",$J,LN,0)="Activity"_$E(TAB,1,17)_"Date/Time/Zone"_$E(TAB,1,6)_"Responsible Person"_$E(TAB,1,2)_"Entered By",LN=LN+1
"RTN","GMRCIERR",50,0)
 S GMRCCT=LN
"RTN","GMRCIERR",51,0)
 D BLDALN^GMRCSLM4(GMRCDA,GMRCACT)
"RTN","GMRCIERR",52,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",53,0)
 S ^TMP("GMRCIERR",$J,LN,0)="",LN=LN+1
"RTN","GMRCIERR",54,0)
 S ^TMP("GMRCIERR",$J,LN,0)="The error was: "_GMRCERR
"RTN","GMRCIERR",55,0)
 M ^TMP("GMRCIERR",$J)=^TMP("GMRCR",$J,"DT")
"RTN","GMRCIERR",56,0)
 K ^TMP("GMRCR",$J,"DT")
"RTN","GMRCIERR",57,0)
 Q
"RTN","GMRCIERR",58,0)
 ;
"RTN","GMRCIERR",59,0)
DIALOG(GMRCDATA) ;ask user what to do based on error and activity
"RTN","GMRCIERR",60,0)
 ;Input:
"RTN","GMRCIERR",61,0)
 ;  GMRCDATA  = XQADATA from alert handler
"RTN","GMRCIERR",62,0)
 ;      in form:   IFC_msg_log#|consult#|activity#
"RTN","GMRCIERR",63,0)
 ;
"RTN","GMRCIERR",64,0)
 ;Output:
"RTN","GMRCIERR",65,0)
 ;  value to set XQAKILL to
"RTN","GMRCIERR",66,0)
 N DIR,X,Y,LN,DUOUT,DTOUT
"RTN","GMRCIERR",67,0)
 D EN($P(GMRCDATA,"|"),$P(GMRCDATA,"|",2),$P(GMRCDATA,"|",3))
"RTN","GMRCIERR",68,0)
 W @IOF
"RTN","GMRCIERR",69,0)
 S LN=0 F  S LN=$O(^TMP("GMRCIERR",$J,LN)) Q:'LN  W !,^(LN,0)
"RTN","GMRCIERR",70,0)
 W !
"RTN","GMRCIERR",71,0)
 I $O(^TMP("GMRCIERR",$J," "),-1)<2 Q 0 ;some problem so delete alert
"RTN","GMRCIERR",72,0)
 S DIR(0)="E" D ^DIR
"RTN","GMRCIERR",73,0)
 I $D(DTOUT)!($D(DUOUT)) Q "@"
"RTN","GMRCIERR",74,0)
 W !
"RTN","GMRCIERR",75,0)
 I $O(^GMR(123.6,"AC",$P(GMRCDATA,"|",2),$P(GMRCDATA,"|",3)),-1) D  Q "@"
"RTN","GMRCIERR",76,0)
 . W !,"There is at least one earlier incomplete transaction for this"
"RTN","GMRCIERR",77,0)
 . W !,"consult, all incomplete transactions should be processed in "
"RTN","GMRCIERR",78,0)
 . W !,"order.",!
"RTN","GMRCIERR",79,0)
 . W !,"You can use the List incomplete IFC transactions option to"
"RTN","GMRCIERR",80,0)
 . W !,"locate and process the incomplete transactions for this consult."
"RTN","GMRCIERR",81,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCIERR",82,0)
 S DIR(0)="YA",DIR("B")="N"
"RTN","GMRCIERR",83,0)
 S DIR("A",1)="If you have corrected this problem you may resend this activity!"
"RTN","GMRCIERR",84,0)
 S DIR("A",2)=" "
"RTN","GMRCIERR",85,0)
 S DIR("A")="Do you want to retransmit this? " D ^DIR
"RTN","GMRCIERR",86,0)
 I $G(Y)=1 D  Q 0
"RTN","GMRCIERR",87,0)
 . D TRIGR^GMRCIEVT($P(GMRCDATA,"|",2),$P(GMRCDATA,"|",3)) ; re-transmit
"RTN","GMRCIERR",88,0)
 K DIR
"RTN","GMRCIERR",89,0)
 W !
"RTN","GMRCIERR",90,0)
 S DIR(0)="YA",DIR("B")="N"
"RTN","GMRCIERR",91,0)
 S DIR("A")="Do you want to delete this alert for all recipients? "
"RTN","GMRCIERR",92,0)
 D ^DIR
"RTN","GMRCIERR",93,0)
 I $G(Y)=1 Q 0
"RTN","GMRCIERR",94,0)
 W !
"RTN","GMRCIERR",95,0)
 S DIR(0)="YA",DIR("B")="N"
"RTN","GMRCIERR",96,0)
 S DIR("A")="Do you want to delete this alert for yourself only? "
"RTN","GMRCIERR",97,0)
 D ^DIR
"RTN","GMRCIERR",98,0)
 I $G(Y)=1 Q 1
"RTN","GMRCIERR",99,0)
 Q "@"
"RTN","GMRCIERR",100,0)
 ;
"RTN","GMRCIERR",101,0)
FOLLUP ;action to take from alert
"RTN","GMRCIERR",102,0)
 S XQAKILL=$$DIALOG(XQADATA)
"RTN","GMRCIERR",103,0)
 I XQAKILL="@" K XQAKILL
"RTN","GMRCIERR",104,0)
 K ^TMP("GMRCIERR",$J)
"RTN","GMRCIERR",105,0)
 Q
"RTN","GMRCIERR",106,0)
 ;
"RTN","GMRCIERR",107,0)
SNDALRT(GMRCLOG,TYPE,XQAMSG) ; send an alert on some errors
"RTN","GMRCIERR",108,0)
 ;Input:
"RTN","GMRCIERR",109,0)
 ; GMRCLOG = IFC MESSAGE LOG entry
"RTN","GMRCIERR",110,0)
 ; TYPE    = "C" for a clinical error, "T" for a technical error
"RTN","GMRCIERR",111,0)
 ;
"RTN","GMRCIERR",112,0)
 N XQA,XQAROU,XQADATA,XQAID,GROUP,GMRCACT,GMRCDA,GMRCLOG0
"RTN","GMRCIERR",113,0)
 S GMRCLOG0=$G(^GMR(123.6,GMRCLOG,0)) Q:'$L(GMRCLOG0)
"RTN","GMRCIERR",114,0)
 S GMRCDA=$P(GMRCLOG0,U,4) Q:'GMRCDA
"RTN","GMRCIERR",115,0)
 S GMRCACT=$P(GMRCLOG0,U,5) Q:'GMRCACT
"RTN","GMRCIERR",116,0)
 S GROUP=$S(TYPE="C":"G.IFC CLIN ERRORS",1:"G.IFC TECH ERRORS")
"RTN","GMRCIERR",117,0)
 S XQA(GROUP)=""
"RTN","GMRCIERR",118,0)
 I '$D(XQAMSG) S XQAMSG="Failed IFC transaction"
"RTN","GMRCIERR",119,0)
 S XQAROU="FOLLUP^GMRCIERR"
"RTN","GMRCIERR",120,0)
 S XQAID="GMRCIFC,trans error,"_GMRCLOG
"RTN","GMRCIERR",121,0)
 S XQADATA=GMRCLOG_"|"_GMRCDA_"|"_GMRCACT
"RTN","GMRCIERR",122,0)
 D SETUP^XQALERT
"RTN","GMRCIERR",123,0)
 Q
"RTN","GMRCIERR",124,0)
PTERRMSG(GMRCPID,GMRCSTA,GMRCDOM,GMRCOBR) ;send IFC pt err to mail group
"RTN","GMRCIERR",125,0)
 ;Input:
"RTN","GMRCIERR",126,0)
 ;  GMRCPID = PID seg from IFC message
"RTN","GMRCIERR",127,0)
 ;  GMRCSTA = station # of site where message originated
"RTN","GMRCIERR",128,0)
 ;  GMRCDOM = domain to send the message to, if defined   (optional)
"RTN","GMRCIERR",129,0)
 ;  GMRCOBR = OBR segment from IFC msg  (optional)
"RTN","GMRCIERR",130,0)
 ;
"RTN","GMRCIERR",131,0)
 ;Output:
"RTN","GMRCIERR",132,0)
 ;  mail message containing patient demographics
"RTN","GMRCIERR",133,0)
 ;
"RTN","GMRCIERR",134,0)
 N GMRCGRP,GMRCMSG,GMRCNM,GMRCNAM,GMRCDOB
"RTN","GMRCIERR",135,0)
 N XMERR,GMRCSUB,GMRCSITE,GMRCERR,GMRCICN
"RTN","GMRCIERR",136,0)
 N XMTEXT,XMY,XMDUZ,XMSUB,XMZ,XMMG
"RTN","GMRCIERR",137,0)
 S GMRCNAM=$P(GMRCPID,"|",5)
"RTN","GMRCIERR",138,0)
 S GMRCNM("FAMILY")=$P(GMRCNAM,U),GMRCNM("GIVEN")=$P(GMRCNAM,U,2)
"RTN","GMRCIERR",139,0)
 S GMRCNM("MIDDLE")=$P(GMRCNAM,U,3),GMRCNM("SUFFIX")=$P(GMRCNAM,U,4)
"RTN","GMRCIERR",140,0)
 S GMRCNAM=$$NAMEFMT^XLFNAME(.GMRCNM,"F","CL56Xc")
"RTN","GMRCIERR",141,0)
 S GMRCDOB=$$HL7TFM^XLFDT($P(GMRCPID,"|",7))
"RTN","GMRCIERR",142,0)
 S GMRCDOB=$$FMTE^XLFDT(GMRCDOB)
"RTN","GMRCIERR",143,0)
 S GMRCICN=+$P(GMRCPID,"|",2)
"RTN","GMRCIERR",144,0)
 D F4^XUAF4(GMRCSTA,.GMRCSITE)
"RTN","GMRCIERR",145,0)
 S GMRCMSG(1,0)="An Inter-facility Consult for the following patient has been requested."
"RTN","GMRCIERR",146,0)
 S GMRCMSG(2,0)="The patient has either never been registered at your facility or the national"
"RTN","GMRCIERR",147,0)
 S GMRCMSG(3,0)="MPI ICN for this patient at your site does not match that from the requesting"
"RTN","GMRCIERR",148,0)
 S GMRCMSG(4,0)="site. Please refer to the Master Patient Index/Patient Demographics (MPI/PD)"
"RTN","GMRCIERR",149,0)
 S GMRCMSG(5,0)="User Manual and Master Patient Index/Patient Demographics Exception"
"RTN","GMRCIERR",150,0)
 S GMRCMSG(6,0)="Handling Manuals to resolve this error so the request may be processed."
"RTN","GMRCIERR",151,0)
 S GMRCMSG(7,0)=" ",GMRCMSG(8,0)=" "
"RTN","GMRCIERR",152,0)
 S GMRCMSG(9,0)="Patient demographics from "_GMRCSITE("NAME")
"RTN","GMRCIERR",153,0)
 S GMRCMSG(10,0)="   Patient name: "_GMRCNAM
"RTN","GMRCIERR",154,0)
 S GMRCMSG(11,0)="            SSN: "_$P(GMRCPID,"|",19)
"RTN","GMRCIERR",155,0)
 S GMRCMSG(12,0)="  Date of birth: "_GMRCDOB
"RTN","GMRCIERR",156,0)
 S GMRCMSG(13,0)="            Sex: "_$P(GMRCPID,"|",8)
"RTN","GMRCIERR",157,0)
 S GMRCMSG(14,0)="     Remote ICN: "_GMRCICN
"RTN","GMRCIERR",158,0)
 S GMRCMSG(15,0)=" "
"RTN","GMRCIERR",159,0)
 I $L($G(GMRCOBR)) D
"RTN","GMRCIERR",160,0)
 . N GMRCITM
"RTN","GMRCIERR",161,0)
 . S GMRCITM=$P(GMRCOBR,"|",4)
"RTN","GMRCIERR",162,0)
 . I GMRCITM["VA1235" S GMRCITM="Ordered service: "_$P(GMRCITM,U,2)
"RTN","GMRCIERR",163,0)
 . I GMRCITM["VA1233" S GMRCITM="  Ordered proc.: "_$P(GMRCITM,U,2)
"RTN","GMRCIERR",164,0)
 . S GMRCMSG(16,0)=GMRCITM
"RTN","GMRCIERR",165,0)
 S GMRCMSG(17,0)=" "
"RTN","GMRCIERR",166,0)
 S GMRCMSG(18,0)="   The error is: Unknown Patient (201)"
"RTN","GMRCIERR",167,0)
 ;
"RTN","GMRCIERR",168,0)
 D  ; set XMY to local group or remote group
"RTN","GMRCIERR",169,0)
 . I $D(GMRCDOM) S XMY("G.IFC CLIN ERRORS@"_GMRCDOM)="" Q
"RTN","GMRCIERR",170,0)
 . S XMY("G.IFC PATIENT ERROR MESSAGES")=""
"RTN","GMRCIERR",171,0)
 S XMSUB="Incoming IFC patient error, "_GMRCNAM
"RTN","GMRCIERR",172,0)
 S XMDUZ="Consult/Request Tracking Package"
"RTN","GMRCIERR",173,0)
 S XMTEXT="GMRCMSG("
"RTN","GMRCIERR",174,0)
 D ^XMD
"RTN","GMRCIERR",175,0)
 Q
"RTN","GMRCIERR",176,0)
 ;
"RTN","GMRCIERR",177,0)
PTMPIER(GMRCDFN) ;send IFC local MPI error to MAS mail group
"RTN","GMRCIERR",178,0)
 ;Input:
"RTN","GMRCIERR",179,0)
 ;  GMRCDFN = DFN from file 2 of patient with MPI problem
"RTN","GMRCIERR",180,0)
 ;
"RTN","GMRCIERR",181,0)
 ;Output:
"RTN","GMRCIERR",182,0)
 ;  mail message containing patient demographics
"RTN","GMRCIERR",183,0)
 ;
"RTN","GMRCIERR",184,0)
 N DFN,GMRCPT,GMRCMSG,VAHOW,VAROOT
"RTN","GMRCIERR",185,0)
 N XMTEXT,XMY,XMDUZ,XMSUB,XMZ,XMMG
"RTN","GMRCIERR",186,0)
 S DFN=GMRCDFN,VAHOW=1,VAROOT="GMRCPT"
"RTN","GMRCIERR",187,0)
 D DEM^VADPT
"RTN","GMRCIERR",188,0)
 S GMRCMSG(1,0)="An Inter-facility Consult for the following patient has been requested."
"RTN","GMRCIERR",189,0)
 S GMRCMSG(2,0)="The PATIENT file is either missing an ICN or contains a local ICN."
"RTN","GMRCIERR",190,0)
 S GMRCMSG(3,0)="Please refer to the Master Patient Index/Patient Demographics(MPI/PD) User"
"RTN","GMRCIERR",191,0)
 S GMRCMSG(4,0)="and Master Patient Index/Patient Demographics Exception Handling Manuals"
"RTN","GMRCIERR",192,0)
 S GMRCMSG(5,0)="to resolve this error so request may be processed."
"RTN","GMRCIERR",193,0)
 S GMRCMSG(6,0)=" "
"RTN","GMRCIERR",194,0)
 S GMRCMSG(7,0)="   Patient name: "_GMRCPT("NM")
"RTN","GMRCIERR",195,0)
 S GMRCMSG(8,0)="            SSN: "_$P(GMRCPT("SS"),U,2)
"RTN","GMRCIERR",196,0)
 S GMRCMSG(9,0)="  Date of birth: "_$P(GMRCPT("DB"),U,2)
"RTN","GMRCIERR",197,0)
 S GMRCMSG(10,0)="            Sex: "_$P(GMRCPT("SX"),U,2)
"RTN","GMRCIERR",198,0)
 S GMRCMSG(11,0)="  "
"RTN","GMRCIERR",199,0)
 S GMRCMSG(12,0)="   The error is: Local or unknown MPI identifiers (202)"
"RTN","GMRCIERR",200,0)
 ;
"RTN","GMRCIERR",201,0)
 S XMY("G.IFC PATIENT ERROR MESSAGES")=""
"RTN","GMRCIERR",202,0)
 S XMSUB="Outgoing IFC patient error, "_GMRCPT("NM")
"RTN","GMRCIERR",203,0)
 S XMDUZ="Consult/Request Tracking Package"
"RTN","GMRCIERR",204,0)
 S XMTEXT="GMRCMSG("
"RTN","GMRCIERR",205,0)
 D ^XMD
"RTN","GMRCIERR",206,0)
 Q
"RTN","GMRCP5D")
0^10^B50959922
"RTN","GMRCP5D",1,0)
GMRCP5D ;SLC/DCM,RJS,JFR - Print Consult form 513 (Gather Data - Addendums, Headers, Service reports and Comments) ;8/19/03 15:31
"RTN","GMRCP5D",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,12,15,22,29,35**;Dec 27, 1997
"RTN","GMRCP5D",3,0)
 ;
"RTN","GMRCP5D",4,0)
FORMAT(GMRCIFN,GMRCRD,PAGEWID) ;
"RTN","GMRCP5D",5,0)
 ;
"RTN","GMRCP5D",6,0)
 I $L($P(GMRCRD,U,15)) D
"RTN","GMRCP5D",7,0)
 .I $O(^TMP("GMRCR",$J,"MCAR",0)) D
"RTN","GMRCP5D",8,0)
 ..N GMRCSVC
"RTN","GMRCP5D",9,0)
 ..S GMRCSVC=$P($G(^GMR(123.5,+$P(GMRCRD,U,5),0)),U,1)
"RTN","GMRCP5D",10,0)
 ..S:$L(GMRCSVC) GMRCSVC=GMRCSVC_" "
"RTN","GMRCP5D",11,0)
 ..;
"RTN","GMRCP5D",12,0)
 ..; Medicine Results?
"RTN","GMRCP5D",13,0)
 ..S GMRCR0=0 F  S GMRCR0=$O(^TMP("GMRCR",$J,"MCAR",GMRCR0)) Q:'GMRCR0  D
"RTN","GMRCP5D",14,0)
 ...D SUB("H","SREP",GMRCR0,$$CENTER(GMRCSVC_"Service Report #"_GMRCR0_" continued."))
"RTN","GMRCP5D",15,0)
 ...D SUB("H","SREP",GMRCR0," ")
"RTN","GMRCP5D",16,0)
 ...D BLD("SREP",GMRCR0,1,0,$$CENTER("Medicine Package Report"))
"RTN","GMRCP5D",17,0)
 ...D BLD("SREP",GMRCR0,1,0,"")
"RTN","GMRCP5D",18,0)
 ...N LN
"RTN","GMRCP5D",19,0)
 ...S LN=0 F  S LN=$O(^TMP("GMRCR",$J,"MCAR",GMRCR0,LN)) Q:'LN  D
"RTN","GMRCP5D",20,0)
 ....D BLD("SREP",GMRCR0,1,0,$G(^TMP("GMRCR",$J,"MCAR",GMRCR0,LN,0)))
"RTN","GMRCP5D",21,0)
 ;
"RTN","GMRCP5D",22,0)
 ; Build Processing Activities
"RTN","GMRCP5D",23,0)
 S GMRCR0=0 F  S GMRCR0=$O(^GMR(123,GMRCIFN,40,GMRCR0)) Q:'GMRCR0  D
"RTN","GMRCP5D",24,0)
 .N GMRCR1,GMRC400,CMT,USER,GMRCDT,RPRV,GMRC402,GMRCISIT
"RTN","GMRCP5D",25,0)
 .S GMRCR1=+$O(^GMR(123,GMRCIFN,40,GMRCR0,0)) Q:GMRCR1'=1
"RTN","GMRCP5D",26,0)
 .S GMRC400=$G(^GMR(123,GMRCIFN,40,GMRCR0,0))
"RTN","GMRCP5D",27,0)
 .S GMRC402=$G(^GMR(123,GMRCIFN,40,GMRCR0,2))
"RTN","GMRCP5D",28,0)
 .S CMT=$$PRCMT^GMRCP5B(+$P(GMRC400,U,2)) Q:'$L(CMT)
"RTN","GMRCP5D",29,0)
 .S GMRCDT=$P(GMRC400,U,3) S:'GMRCDT GMRCDT=$P(GMRC400,U,1)
"RTN","GMRCP5D",30,0)
 .S GMRCDT=$$EXDT(GMRCDT)_" "_$P(GMRC402,U,3)
"RTN","GMRCP5D",31,0)
 .;
"RTN","GMRCP5D",32,0)
 .I $P(^GMR(123,GMRCIFN,0),U,23) D
"RTN","GMRCP5D",33,0)
 ..S GMRCISIT=$$GET1^DIQ(4,$P(^GMR(123,GMRCIFN,0),U,23),.01)
"RTN","GMRCP5D",34,0)
 ..S GMRCISIT="Entered at: "_GMRCISIT
"RTN","GMRCP5D",35,0)
 .S RPRV=$$GET1^DIQ(200,+$P(GMRC400,U,4),.01)
"RTN","GMRCP5D",36,0)
 .I '$L(RPRV) S RPRV=$P(GMRC402,U,2)
"RTN","GMRCP5D",37,0)
 .S:($L(RPRV)) RPRV="Responsible Person: "_RPRV
"RTN","GMRCP5D",38,0)
 .S USER=$$GET1^DIQ(200,+$P(GMRC400,U,5),.01)
"RTN","GMRCP5D",39,0)
 .I '$L(USER) S USER=$P(GMRC402,U)
"RTN","GMRCP5D",40,0)
 .S USER="Entered by: "_USER_" - "_GMRCDT
"RTN","GMRCP5D",41,0)
 .D SUB("H","COM",GMRCR0,CMT_" Comment ("_USER_") continued.")
"RTN","GMRCP5D",42,0)
 .D SUB("H","COM",GMRCR0," ")
"RTN","GMRCP5D",43,0)
 .D BLD("COM",GMRCR0,1,0,"")
"RTN","GMRCP5D",44,0)
 .D BLD("COM",GMRCR0,1,0,$$CENTER("("_CMT_" Comment)"))
"RTN","GMRCP5D",45,0)
 .I $P(GMRC400,U,2)=17!($P(GMRC400,U,2)=25) D
"RTN","GMRCP5D",46,0)
 .. N FWDLN,FWDRS
"RTN","GMRCP5D",47,0)
 .. S FWDLN="Forwarded from: "
"RTN","GMRCP5D",48,0)
 .. S FWDRS=$P($G(^GMR(123,GMRCIFN,40,GMRCR0,3)),U)
"RTN","GMRCP5D",49,0)
 .. I $L(FWDRS) S FWDLN=FWDLN_FWDRS
"RTN","GMRCP5D",50,0)
 .. I '$L(FWDRS) S FWDLN=FWDLN_$$GET1^DIQ(123.5,+$P(GMRC400,U,6),.01)
"RTN","GMRCP5D",51,0)
 .. D BLD("COM",GMRCR0,1,5,FWDLN)
"RTN","GMRCP5D",52,0)
 .D BLD("COM",GMRCR0,1,5,USER)
"RTN","GMRCP5D",53,0)
 .D:($L(RPRV)) BLD("COM",GMRCR0,1,5,RPRV)
"RTN","GMRCP5D",54,0)
 .D:($L($G(GMRCISIT))) BLD("COM",GMRCR0,1,5,GMRCISIT)
"RTN","GMRCP5D",55,0)
 .;
"RTN","GMRCP5D",56,0)
 .N GMRCR2 S GMRCR2=0
"RTN","GMRCP5D",57,0)
 .F  S GMRCR2=$O(^GMR(123,GMRCIFN,40,GMRCR0,GMRCR1,GMRCR2)) Q:'GMRCR2  D
"RTN","GMRCP5D",58,0)
 ..D BLD("COM",GMRCR0,1,0,$G(^GMR(123,GMRCIFN,40,GMRCR0,GMRCR1,GMRCR2,0)))
"RTN","GMRCP5D",59,0)
 ;
"RTN","GMRCP5D",60,0)
 Q
"RTN","GMRCP5D",61,0)
 ;
"RTN","GMRCP5D",62,0)
ADDEND(GMRCIFN,GMRCR0,GMRCNDX,GMRCRD,PAGEWID) ;
"RTN","GMRCP5D",63,0)
 ;
"RTN","GMRCP5D",64,0)
 N GMRCADD,GMRCNDX,GMRCR1,GMRCV,TEXT,GMRCX
"RTN","GMRCP5D",65,0)
 ;
"RTN","GMRCP5D",66,0)
 S GMRCADD=0 F  S GMRCADD=$O(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",GMRCADD)) Q:'GMRCADD  D
"RTN","GMRCP5D",67,0)
 .N GMRCSGNM,GMRCNMDT,GMRCTIT,GMRCMODE,GMRCCSDT,GMRCCTIT,GMRCCSGM
"RTN","GMRCP5D",68,0)
 .;
"RTN","GMRCP5D",69,0)
 .F GMRCV="GMRCSGNM","GMRCNMDT","GMRCTIT","GMRCMODE" D
"RTN","GMRCP5D",70,0)
 ..S @GMRCV=$G(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",GMRCADD,GMRCV))
"RTN","GMRCP5D",71,0)
 .;
"RTN","GMRCP5D",72,0)
 . F GMRCV="GMRCCSDT","GMRCCTIT","GMRCCSGM","GMRCCSIG" D
"RTN","GMRCP5D",73,0)
 .. S @GMRCV=$G(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",GMRCADD,GMRCV))
"RTN","GMRCP5D",74,0)
 .S GMRCNDX=$O(^TMP("GMRC",$J,"OUTPUT","RES"," "),-1)+1
"RTN","GMRCP5D",75,0)
 .I $L($G(GMRCRPT)) D SUB("H","RES",GMRCNDX,"Addendum #"_GMRCADD_" To Consult Note #"_GMRCR0_" for "_GMRCRPT_" continued.")
"RTN","GMRCP5D",76,0)
 .I '$L($G(GMRCRPT)) D SUB("H","RES",GMRCNDX,"Addendum #"_GMRCADD_" To Consult Note #"_GMRCR0_" continued.")
"RTN","GMRCP5D",77,0)
 .D SUB("H","RES",GMRCNDX," ")
"RTN","GMRCP5D",78,0)
 .I $L($G(GMRCSGNM)) D
"RTN","GMRCP5D",79,0)
 ..D SUB("F","RES",GMRCNDX," ")
"RTN","GMRCP5D",80,0)
 ..I (GMRCMODE="electronic") S GMRCX=" Addendum Signature: "_GMRCSGNM_" /es/ "_$$EXDT($G(GMRCNMDT))
"RTN","GMRCP5D",81,0)
 ..I '(GMRCMODE="electronic") S GMRCX=" Addendum Author: "_GMRCSGNM S:$L($G(GMRCNMDT)) GMRCX=GMRCX_" Last edited: "_$$EXDT(GMRCNMDT)
"RTN","GMRCP5D",82,0)
 ..D SUB("F","RES",GMRCNDX,GMRCX)
"RTN","GMRCP5D",83,0)
 ..D:$L($G(GMRCTIT)) SUB("F","RES",GMRCNDX,"                     "_GMRCTIT)
"RTN","GMRCP5D",84,0)
 .I $L($G(GMRCCSDT)) D
"RTN","GMRCP5D",85,0)
 ..D SUB("F","RES",GMRCNDX," ")
"RTN","GMRCP5D",86,0)
 ..I (GMRCCSGM="electronic") S GMRCX=" Addendum CoSignature: "_GMRCCSIG_" /es/ "_$$EXDT(GMRCCSDT)
"RTN","GMRCP5D",87,0)
 ..I '(GMRCCSGM="electronic") S GMRCX=" Addendum CoSignature: "_GMRCCSIG_" /chart/ "_$$EXDT(GMRCCSDT)
"RTN","GMRCP5D",88,0)
 ..D SUB("F","RES",GMRCNDX,GMRCX)
"RTN","GMRCP5D",89,0)
 ..D:$L($G(GMRCCTIT)) SUB("F","RES",GMRCNDX,"                       "_GMRCCTIT)
"RTN","GMRCP5D",90,0)
 .D BLD("RES",GMRCNDX,1,0," ")
"RTN","GMRCP5D",91,0)
 .I $L($G(GMRCRPT)) D BLD("RES",GMRCNDX,1,0,$$CENTER("ADDENDUM #"_GMRCADD_" TO CONSULT NOTE #"_GMRCR0_" FOR "_GMRCRPT))
"RTN","GMRCP5D",92,0)
 .I '$L($G(GMRCRPT)) D BLD("RES",GMRCNDX,1,0,$$CENTER("ADDENDUM #"_GMRCADD_" TO CONSULT NOTE #"_GMRCR0))
"RTN","GMRCP5D",93,0)
 .D BLD("RES",GMRCNDX,1,0," ")
"RTN","GMRCP5D",94,0)
 .S GMRCR1=0 F  S GMRCR1=$O(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",GMRCADD,GMRCR1)) Q:'GMRCR1  D
"RTN","GMRCP5D",95,0)
 ..D BLD("RES",GMRCNDX,1,0,$G(^TMP("GMRCR",$J,"RES",GMRCR0,"ADD",GMRCADD,GMRCR1,0)))
"RTN","GMRCP5D",96,0)
 Q
"RTN","GMRCP5D",97,0)
 ;
"RTN","GMRCP5D",98,0)
HDR ; Header code for form 513
"RTN","GMRCP5D",99,0)
 ;
"RTN","GMRCP5D",100,0)
 N PG,GMRCFROM
"RTN","GMRCP5D",101,0)
 ;
"RTN","GMRCP5D",102,0)
 F PG=0,1 D
"RTN","GMRCP5D",103,0)
 .D BLD("HDR",PG,1,0,GMRCDVL)
"RTN","GMRCP5D",104,0)
 .D BLD("HDR",PG,1,6,"MEDICAL RECORD")
"RTN","GMRCP5D",105,0)
 .D BLD("HDR",PG,0,29,"|")
"RTN","GMRCP5D",106,0)
 .D BLD("HDR",PG,0,36,"CONSULTATION SHEET")
"RTN","GMRCP5D",107,0)
 .I PG D BLD("HDR",PG,0,60,"Page ","GMRCPG,65") I 1
"RTN","GMRCP5D",108,0)
 .E  I '$G(GMRCGUI) D BLD("HDR",PG,0,60,"Page ","GMRCPG,65")
"RTN","GMRCP5D",109,0)
 .;
"RTN","GMRCP5D",110,0)
 .D BLD("HDR",PG,1,0,GMRCDVL)
"RTN","GMRCP5D",111,0)
 .D BLD("HDR",PG,1,0,"Consult Request: "_$$CONSRQ(GMRCIFN))
"RTN","GMRCP5D",112,0)
 .D BLD("HDR",PG,0,55,"|Consult No.: "_GMRCIFN)
"RTN","GMRCP5D",113,0)
 .;
"RTN","GMRCP5D",114,0)
 D BLD("HDR",1,1,0,GMRCEQL)
"RTN","GMRCP5D",115,0)
 D BLD("HDR",0,1,0,GMRCDVL)
"RTN","GMRCP5D",116,0)
 ;
"RTN","GMRCP5D",117,0)
 I $G(CMT) D BLD("HDR",0,1,27,"("_$$PRCMT^GMRCP5B(CMT)_")") Q
"RTN","GMRCP5D",118,0)
 ;
"RTN","GMRCP5D",119,0)
 S GMRCFROM=$P($G(^SC(+$P(GMRCRD,U,6),0)),U,1)
"RTN","GMRCP5D",120,0)
 ;
"RTN","GMRCP5D",121,0)
 I '$L(GMRCFROM) D
"RTN","GMRCP5D",122,0)
 .N VAIN
"RTN","GMRCP5D",123,0)
 .D INP^VADPT
"RTN","GMRCP5D",124,0)
 .S GMRCFROM=$P($G(VAIN(4)),U,2)
"RTN","GMRCP5D",125,0)
 .I $L($G(VAIN(5))) S GMRCFROM=GMRCFROM_" (Rm/Bd: "_$G(VAIN(5))_" )"
"RTN","GMRCP5D",126,0)
 ;No location, IFC - consulting site
"RTN","GMRCP5D",127,0)
 I '$L(GMRCFROM),$P(GMRCRD,U,23),$P($G(GMRCRD(12)),U,5)="F" D
"RTN","GMRCP5D",128,0)
 .I $P(GMRCRD,U,21) S GMRCFROM=$$GET1^DIQ(4,$P(GMRCRD,U,21),.01)
"RTN","GMRCP5D",129,0)
 .E  S GMRCFROM=$$GET1^DIQ(4,$P(GMRCRD,U,23),.01)
"RTN","GMRCP5D",130,0)
 ;
"RTN","GMRCP5D",131,0)
 D BLD("HDR",0,1,0,"To: "_$P($G(^GMR(123.5,+$P(GMRCRD,U,5),0)),U,1))
"RTN","GMRCP5D",132,0)
 D BLD("HDR",0,1,5,"From: "_GMRCFROM)
"RTN","GMRCP5D",133,0)
 D BLD("HDR",0,0,49,"|Requested: "_$$EXDT($P(GMRCRD,U,7)))
"RTN","GMRCP5D",134,0)
 ;
"RTN","GMRCP5D",135,0)
 D BLD("HDR",0,1,0,GMRCDVL)
"RTN","GMRCP5D",136,0)
 D BLD("HDR",0,1,0,"Requesting Facility: "_$E(GMRCFAC,1,22))
"RTN","GMRCP5D",137,0)
 I $P(GMRCRD,U,11) D BLD("HDR",0,0,45,"|ATTENTION: "_$E($P($G(^VA(200,+$P(GMRCRD,U,11),0)),U,1),1,21))
"RTN","GMRCP5D",138,0)
 I $P(GMRCRD,U,23) D
"RTN","GMRCP5D",139,0)
 . D BLD("HDR",0,1,0,"Remote Consult No.: "_GMRCINO)
"RTN","GMRCP5D",140,0)
 . D BLD("HDR",0,1,0,"Role: "_GMRCIRL)
"RTN","GMRCP5D",141,0)
 D BLD("HDR",0,1,0,GMRCEQL)
"RTN","GMRCP5D",142,0)
 ;
"RTN","GMRCP5D",143,0)
 Q
"RTN","GMRCP5D",144,0)
 ;
"RTN","GMRCP5D",145,0)
CENTER(X) ;
"RTN","GMRCP5D",146,0)
 ;
"RTN","GMRCP5D",147,0)
 N TEXT,COL
"RTN","GMRCP5D",148,0)
 S COL=35-($L(X)\2) Q:(COL<1) X
"RTN","GMRCP5D",149,0)
 S $E(TEXT,COL)=X
"RTN","GMRCP5D",150,0)
 Q TEXT
"RTN","GMRCP5D",151,0)
 ;
"RTN","GMRCP5D",152,0)
BLD(SUB,NDX,LINE,TAB,TEXT,RUNTIME) ;
"RTN","GMRCP5D",153,0)
 ;
"RTN","GMRCP5D",154,0)
 Q:'$L($G(SUB))
"RTN","GMRCP5D",155,0)
 N LINECNT
"RTN","GMRCP5D",156,0)
 ;
"RTN","GMRCP5D",157,0)
 F LINECNT=1:1:+LINE S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX)+1,0)=""
"RTN","GMRCP5D",158,0)
 ;
"RTN","GMRCP5D",159,0)
 S $E(^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX),0),TAB+1)=TEXT
"RTN","GMRCP5D",160,0)
 I $L($G(RUNTIME)) S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,$$LASTLN(SUB,NDX),1)=RUNTIME
"RTN","GMRCP5D",161,0)
 ;
"RTN","GMRCP5D",162,0)
 S GMRCLAST=SUB
"RTN","GMRCP5D",163,0)
 Q
"RTN","GMRCP5D",164,0)
 ;
"RTN","GMRCP5D",165,0)
SUB(ZONE,SUB,NDX,TEXT) ;
"RTN","GMRCP5D",166,0)
 ;
"RTN","GMRCP5D",167,0)
 N NEXT
"RTN","GMRCP5D",168,0)
 S NEXT=$O(^TMP("GMRC",$J,"OUTPUT",SUB,NDX,ZONE," "),-1)+1
"RTN","GMRCP5D",169,0)
 S ^TMP("GMRC",$J,"OUTPUT",SUB,NDX,ZONE,NEXT,0)=TEXT
"RTN","GMRCP5D",170,0)
 Q
"RTN","GMRCP5D",171,0)
 ;
"RTN","GMRCP5D",172,0)
LASTLN(SUB,NDX) ;
"RTN","GMRCP5D",173,0)
 Q +$O(^TMP("GMRC",$J,"OUTPUT",SUB,NDX," "),-1)
"RTN","GMRCP5D",174,0)
 ;
"RTN","GMRCP5D",175,0)
CONSRQ(IFN) ;
"RTN","GMRCP5D",176,0)
 ;
"RTN","GMRCP5D",177,0)
 N PTR,LINK,REF,GMRCRQ
"RTN","GMRCP5D",178,0)
 I +$P(^GMR(123,+IFN,0),U,8) D
"RTN","GMRCP5D",179,0)
 . S GMRCRQ=$P(^GMR(123,+IFN,0),U,8)
"RTN","GMRCP5D",180,0)
 . S GMRCRQ=$$GET1^DIQ(123.3,+GMRCRQ,.01)
"RTN","GMRCP5D",181,0)
 . I '$L(GMRCRQ) S GMRCRQ="Procedure"
"RTN","GMRCP5D",182,0)
 I $L($G(GMRCRQ)) Q GMRCRQ
"RTN","GMRCP5D",183,0)
 I $L($G(^GMR(123,IFN,1.11))) D
"RTN","GMRCP5D",184,0)
 . N SERV,TYPE
"RTN","GMRCP5D",185,0)
 . S SERV=$$UP^XLFSTR($$GET1^DIQ(123.5,$P(^GMR(123,IFN,0),U,5),.01))
"RTN","GMRCP5D",186,0)
 . S TYPE=$$UP^XLFSTR(^GMR(123,IFN,1.11)) I TYPE'=SERV D
"RTN","GMRCP5D",187,0)
 . I TYPE'=SERV S GMRCRQ=$E(^GMR(123,IFN,1.11),1,36)
"RTN","GMRCP5D",188,0)
 Q:$L($G(GMRCRQ)) GMRCRQ Q "Consult"
"RTN","GMRCP5D",189,0)
 ;
"RTN","GMRCP5D",190,0)
EXDT(X) ;EXTERNAL DATE FORMAT
"RTN","GMRCP5D",191,0)
 ;
"RTN","GMRCP5D",192,0)
 N DATE,TIME,HR,MN,PD,Y,%DT
"RTN","GMRCP5D",193,0)
 Q:'$L(X) ""
"RTN","GMRCP5D",194,0)
 I '(X?7N.1".".6N) S %DT="PTS" D ^%DT S X=Y
"RTN","GMRCP5D",195,0)
 Q $$FMTE^XLFDT(X,"5PMZ")
"RTN","GMRCP5D",196,0)
 ;
"RTN","GMRCTIUE")
0^5^B60104951
"RTN","GMRCTIUE",1,0)
GMRCTIUE ;SLC/DCM,DLT,JFR - Complete/Update TIU notes ;07/10/03 15:26
"RTN","GMRCTIUE",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,10,14,12,15,17,35**;DEC 27, 1997
"RTN","GMRCTIUE",3,0)
 ;
"RTN","GMRCTIUE",4,0)
 ; This routine invokes IA #2410,#2694,#2833,#2699,#2700
"RTN","GMRCTIUE",5,0)
 ;
"RTN","GMRCTIUE",6,0)
 Q
"RTN","GMRCTIUE",7,0)
ENTER(GMRCO) ; Enter a note in TIU for the consult result
"RTN","GMRCTIUE",8,0)
 ;If consult from list is defined in GMRCO, then use it.
"RTN","GMRCTIUE",9,0)
 K GMRCQUT N TIUDA,TIUCLASS,GMRCLCK
"RTN","GMRCTIUE",10,0)
 N GMRCMC
"RTN","GMRCTIUE",11,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)
"RTN","GMRCTIUE",12,0)
 Q:$D(GMRCQUT)!'$L($G(GMRCO))
"RTN","GMRCTIUE",13,0)
 I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D  D EDEX Q
"RTN","GMRCTIUE",14,0)
 . N DIR
"RTN","GMRCTIUE",15,0)
 . W !,"The requesting facility may not complete an inter-facility "
"RTN","GMRCTIUE",16,0)
 . W "consult."
"RTN","GMRCTIUE",17,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCTIUE",18,0)
 I '$$LOCK^GMRCA1(GMRCO) D EDEX Q
"RTN","GMRCTIUE",19,0)
 S GMRCLCK=1
"RTN","GMRCTIUE",20,0)
 D CHKSTS I $G(GMRCQUT) D EDEX Q
"RTN","GMRCTIUE",21,0)
 I $D(VALM) D FULL^VALM1
"RTN","GMRCTIUE",22,0)
 ;
"RTN","GMRCTIUE",23,0)
 ;Find out access if a Clinical Procedure request
"RTN","GMRCTIUE",24,0)
 N GMRCCP
"RTN","GMRCTIUE",25,0)
 S GMRCCP=$$CPACTM^GMRCCP(+GMRCO)
"RTN","GMRCTIUE",26,0)
 ;
"RTN","GMRCTIUE",27,0)
 ;If service administrative user, then use administrative complete logic
"RTN","GMRCTIUE",28,0)
 N GMRCAU
"RTN","GMRCTIUE",29,0)
 S GMRCAU=$$VALID^GMRCAU($P(^GMR(123,GMRCO,0),U,5))
"RTN","GMRCTIUE",30,0)
 I GMRCAU=3 D  Q
"RTN","GMRCTIUE",31,0)
 . I $P(^GMR(123,+GMRCO,0),U,12)'=2,'GMRCCP S GMRCMC=$$MED(GMRCO)
"RTN","GMRCTIUE",32,0)
 . I $G(GMRCMC),$P(^GMR(123,+GMRCO,0),U,12)=2 D EDEX Q
"RTN","GMRCTIUE",33,0)
 . W !,$$CJ^XLFSTR("- Proceeding with Administrative Complete -",80)
"RTN","GMRCTIUE",34,0)
 . D COMP^GMRCAAC(+GMRCO)
"RTN","GMRCTIUE",35,0)
 . D EDEX
"RTN","GMRCTIUE",36,0)
 ;
"RTN","GMRCTIUE",37,0)
 I GMRCAU=4 D  I $G(GMRCQIT)=1 D EDEX Q
"RTN","GMRCTIUE",38,0)
 . N DIRUT
"RTN","GMRCTIUE",39,0)
 . I $P(^GMR(123,+GMRCO,0),U,12)'=2,'GMRCCP S GMRCMC=$$MED(GMRCO)
"RTN","GMRCTIUE",40,0)
 . I $G(GMRCMC),$P(^GMR(123,+GMRCO,0),U,12)=2 Q
"RTN","GMRCTIUE",41,0)
 . S DIR(0)="YA",DIR("A")="Administratively complete this request? "
"RTN","GMRCTIUE",42,0)
 . D ^DIR I $D(DIRUT) S GMRCQIT=1 Q
"RTN","GMRCTIUE",43,0)
 . I Y<1 Q
"RTN","GMRCTIUE",44,0)
 . W !,$$CJ^XLFSTR("- Proceeding with Administrative Complete -",80)
"RTN","GMRCTIUE",45,0)
 . D COMP^GMRCAAC(+GMRCO) S GMRCQIT=1
"RTN","GMRCTIUE",46,0)
 . Q 
"RTN","GMRCTIUE",47,0)
 ;
"RTN","GMRCTIUE",48,0)
 ;Assume the user is a clinical user
"RTN","GMRCTIUE",49,0)
 I GMRCCP=0 S GMRCMC=$$MED(GMRCO) ;only go med if not a CP
"RTN","GMRCTIUE",50,0)
 ;If a Procedure, allow Medicine or fall through to a note
"RTN","GMRCTIUE",51,0)
 I $G(GMRCMC) D  I $G(GMRCQIT)=1 D EDEX Q
"RTN","GMRCTIUE",52,0)
 . N DUOUT,DTOUT,DIROUT,DIRUT,X,Y,DIR
"RTN","GMRCTIUE",53,0)
 . W !
"RTN","GMRCTIUE",54,0)
 . S DIR(0)="YA",DIR("B")="Y",DIR("A")="Continue with Note Entry? "
"RTN","GMRCTIUE",55,0)
 . D ^DIR I Y<1 S GMRCQIT=1
"RTN","GMRCTIUE",56,0)
 . W !
"RTN","GMRCTIUE",57,0)
 . Q
"RTN","GMRCTIUE",58,0)
 ;
"RTN","GMRCTIUE",59,0)
 ;Get list of notes If no new notes, add new then quit
"RTN","GMRCTIUE",60,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCTIUE",61,0)
 I $D(VALM) D FULL^VALM1
"RTN","GMRCTIUE",62,0)
 I '$$GETLIST(GMRCDFN,GMRCO,.GMRCTIUC) D  D EDEX Q
"RTN","GMRCTIUE",63,0)
 . I GMRCCP>1,GMRCCP'=4 D CPGUI Q
"RTN","GMRCTIUE",64,0)
 . D NEW
"RTN","GMRCTIUE",65,0)
 ;
"RTN","GMRCTIUE",66,0)
 ;If TIU Document already exists, use single record edit, and quit
"RTN","GMRCTIUE",67,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",68,0)
 I GMRCTIUC(GMRCVF)=1 D  Q
"RTN","GMRCTIUE",69,0)
 . I GMRCCP=3 D CPGUI Q  ;incomplete CP document, must go to GUI
"RTN","GMRCTIUE",70,0)
 . N DIR,X,Y,DTOUT,DUOUT,DIROUT,DIRUT
"RTN","GMRCTIUE",71,0)
 . D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",72,0)
 . S DIR(0)="YA",DIR("B")="Yes",DIR("A")="Edit/Review this note? "
"RTN","GMRCTIUE",73,0)
 . D ^DIR I Y>0 D
"RTN","GMRCTIUE",74,0)
 .. S GMRCTUFN=$$SINGLE(GMRCVF)
"RTN","GMRCTIUE",75,0)
 .. I +GMRCTUFN D EDITNOTE(GMRCTUFN)
"RTN","GMRCTIUE",76,0)
 . S DIR(0)="YA"
"RTN","GMRCTIUE",77,0)
 . S DIR("B")="No",DIR("A")="Would you like to enter a new note? "
"RTN","GMRCTIUE",78,0)
 . W ! D ^DIR I Y>0 D NEW
"RTN","GMRCTIUE",79,0)
 . D EDEX
"RTN","GMRCTIUE",80,0)
 . Q
"RTN","GMRCTIUE",81,0)
 ;
"RTN","GMRCTIUE",82,0)
 ;Show the list of multiple tiu results for selection
"RTN","GMRCTIUE",83,0)
 D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",84,0)
 ;
"RTN","GMRCTIUE",85,0)
 ;Select a note from the list and then get the TIU internal entry
"RTN","GMRCTIUE",86,0)
 S GMRCSELR=$$SELR^GMRCTIUL(.GMRCTIUC)
"RTN","GMRCTIUE",87,0)
 I $D(GMRCQUT) D EDEX Q
"RTN","GMRCTIUE",88,0)
 I '+(GMRCSELR) D  D EDEX Q
"RTN","GMRCTIUE",89,0)
 . ;didn't select existing note, allow a new entry
"RTN","GMRCTIUE",90,0)
 . N DIR,X,Y
"RTN","GMRCTIUE",91,0)
 . S DIR(0)="Y",DIR("A")="Would you like to enter a new note"
"RTN","GMRCTIUE",92,0)
 . S DIR("B")="N" D ^DIR
"RTN","GMRCTIUE",93,0)
 . I Y<1 K DTOUT,DUOUT,X,Y Q
"RTN","GMRCTIUE",94,0)
 . D NEW
"RTN","GMRCTIUE",95,0)
 S GMRCTUFN=$$GETTUFN(GMRCSELR)
"RTN","GMRCTIUE",96,0)
 ;
"RTN","GMRCTIUE",97,0)
 I +GMRCTUFN D EDITNOTE(GMRCTUFN)
"RTN","GMRCTIUE",98,0)
 ;
"RTN","GMRCTIUE",99,0)
 D EDEX
"RTN","GMRCTIUE",100,0)
 Q
"RTN","GMRCTIUE",101,0)
 ;
"RTN","GMRCTIUE",102,0)
MED(GMRCO) ;allow med results if appropriate
"RTN","GMRCTIUE",103,0)
 ;If a Procedure and setu properly, allow Medicine
"RTN","GMRCTIUE",104,0)
 N GMRCMED,GMRCQIT S GMRCMED=0
"RTN","GMRCTIUE",105,0)
 I $P(^GMR(123,+GMRCO,0),U,17)="P" D
"RTN","GMRCTIUE",106,0)
 . Q:'$P(^GMR(123.3,+$P(^GMR(123,+GMRCO,0),U,8),0),U,5)
"RTN","GMRCTIUE",107,0)
 . D FULL^VALM1
"RTN","GMRCTIUE",108,0)
 . N DIR,DIROUT,DTOUT,DUOUT,X,Y
"RTN","GMRCTIUE",109,0)
 . S DIR(0)="YA",DIR("B")="Y"
"RTN","GMRCTIUE",110,0)
 . S DIR("A",1)="  ",DIR("A")="Attach Medicine Results? "
"RTN","GMRCTIUE",111,0)
 . D ^DIR Q:Y<1
"RTN","GMRCTIUE",112,0)
 . K DIR
"RTN","GMRCTIUE",113,0)
 . S GMRCMED=1
"RTN","GMRCTIUE",114,0)
 . D ARMED^GMRCAR
"RTN","GMRCTIUE",115,0)
 Q GMRCMED
"RTN","GMRCTIUE",116,0)
 ;
"RTN","GMRCTIUE",117,0)
SAUSER() ; admin user?
"RTN","GMRCTIUE",118,0)
 N GMRCSS,GMRCADUS
"RTN","GMRCTIUE",119,0)
 S GMRCSS=+$P($G(^GMR(123,+GMRCO,0)),"^",5) Q:'+GMRCSS 0
"RTN","GMRCTIUE",120,0)
 I $D(^GMR(123.5,+$P($G(^GMR(123,+GMRCO,0)),"^",5),123.33,"B",DUZ)) Q 1
"RTN","GMRCTIUE",121,0)
 I '$L($TEXT(VALIDU^GMRCAU)) Q 0
"RTN","GMRCTIUE",122,0)
 S GMRCADUS=0
"RTN","GMRCTIUE",123,0)
 I $L($TEXT(VALIDU^GMRCAU)) D TEAM^GMRCAU(.GMRCADUS,123.34,DUZ)
"RTN","GMRCTIUE",124,0)
 Q +GMRCADUS
"RTN","GMRCTIUE",125,0)
 ;
"RTN","GMRCTIUE",126,0)
CHKSTS ;Check the order status before allowing entry of a note
"RTN","GMRCTIUE",127,0)
 N STATUS S STATUS=$P($G(^GMR(123,+GMRCO,0)),"^",12)
"RTN","GMRCTIUE",128,0)
 I $S(STATUS=1:1,STATUS=13:1,1:0) D
"RTN","GMRCTIUE",129,0)
 . W !,"This order has been "
"RTN","GMRCTIUE",130,0)
 . W $S(STATUS=1:"DISCONTINUED",1:"CANCELLED")
"RTN","GMRCTIUE",131,0)
 . W ".  A note cannot be entered."
"RTN","GMRCTIUE",132,0)
 . D PAUSE S GMRCQUT=1
"RTN","GMRCTIUE",133,0)
 Q
"RTN","GMRCTIUE",134,0)
 ;
"RTN","GMRCTIUE",135,0)
EDITNOTE(GMRCTUFN) ;use TIU LM for an existing note
"RTN","GMRCTIUE",136,0)
 I +$D(^TIU(8925,+GMRCTUFN,0)) D  Q
"RTN","GMRCTIUE",137,0)
 . D EXSTNOTE^TIUBR1(+GMRCDFN,+GMRCTUFN)
"RTN","GMRCTIUE",138,0)
 ;
"RTN","GMRCTIUE",139,0)
 ; link is missing
"RTN","GMRCTIUE",140,0)
 W !,"A note #"_+GMRCTUFN_" is linked to the consult,"
"RTN","GMRCTIUE",141,0)
 W !,"  but the note is no longer in TIU!"
"RTN","GMRCTIUE",142,0)
 D PAUSE
"RTN","GMRCTIUE",143,0)
 Q
"RTN","GMRCTIUE",144,0)
 ;
"RTN","GMRCTIUE",145,0)
SINGLE(GMRCVF) ;Get the single result entry from the list for the file type
"RTN","GMRCTIUE",146,0)
 N RSLT,GMRCVP
"RTN","GMRCTIUE",147,0)
 S RSLT="",GMRCVP=0
"RTN","GMRCTIUE",148,0)
 F  S RSLT=$O(^TMP("GMRC50",$J,RSLT)) Q:RSLT=""  D  Q:+GMRCVP
"RTN","GMRCTIUE",149,0)
 . I $P(RSLT,";",2)=GMRCVF S GMRCVP=RSLT
"RTN","GMRCTIUE",150,0)
 Q +GMRCVP
"RTN","GMRCTIUE",151,0)
 ;
"RTN","GMRCTIUE",152,0)
GETTUFN(GMRCSELR) ;Get the result entry from the selected entry
"RTN","GMRCTIUE",153,0)
 N RSLT
"RTN","GMRCTIUE",154,0)
 S RSLT=$O(^TMP("GMRC50R",$J,GMRCSELR,""))
"RTN","GMRCTIUE",155,0)
 Q RSLT
"RTN","GMRCTIUE",156,0)
 ;
"RTN","GMRCTIUE",157,0)
NEW ;Enter a new result through TIU if implemented or old Completion logic
"RTN","GMRCTIUE",158,0)
 S TIUCLASS=+$$CLASS(+$$CPACTM^GMRCCP(+GMRCO))
"RTN","GMRCTIUE",159,0)
 I TIUCLASS'>0 D  Q
"RTN","GMRCTIUE",160,0)
 . W !!,$C(7),"Consult Resulting through TIU is not yet implemented."
"RTN","GMRCTIUE",161,0)
 . W !,"Proceeding with Administrative Complete."
"RTN","GMRCTIUE",162,0)
 . D COMP^GMRCAAC(+GMRCO)
"RTN","GMRCTIUE",163,0)
 ;
"RTN","GMRCTIUE",164,0)
 N GMRCTIDA
"RTN","GMRCTIUE",165,0)
 D MAIN^TIUEDIT(TIUCLASS,.GMRCTIDA,GMRCDFN,"","","","",1)
"RTN","GMRCTIUE",166,0)
 ;
"RTN","GMRCTIUE",167,0)
 Q
"RTN","GMRCTIUE",168,0)
 ;
"RTN","GMRCTIUE",169,0)
CLASS(CPSTAT) ; Get TIU doc def for CONSULTS OR clinical procedures
"RTN","GMRCTIUE",170,0)
 N GMRCY,GMRCDTYP,ERR
"RTN","GMRCTIUE",171,0)
 I 'CPSTAT D
"RTN","GMRCTIUE",172,0)
 . S GMRCY=$$FIND1^DIC(8925.1,,"X","CONSULTS","B",,"ERR")
"RTN","GMRCTIUE",173,0)
 I '$D(GMRCY) D
"RTN","GMRCTIUE",174,0)
 . S GMRCY=$$FIND1^DIC(8925.1,,"X","CLINICAL PROCEDURES","B",,"ERR")
"RTN","GMRCTIUE",175,0)
 S GMRCDTYP=$$GET1^DIQ(8925.1,+GMRCY,.04,"I")
"RTN","GMRCTIUE",176,0)
 I +GMRCY>0,$S(GMRCDTYP="CL":0,GMRCDTYP="DC":0,1:1) S GMRCY=0
"RTN","GMRCTIUE",177,0)
 Q GMRCY
"RTN","GMRCTIUE",178,0)
 ;
"RTN","GMRCTIUE",179,0)
GETLIST(GMRCDFN,GMRCO,GMRCLIST) ;
"RTN","GMRCTIUE",180,0)
 ;
"RTN","GMRCTIUE",181,0)
 N GMRCVF
"RTN","GMRCTIUE",182,0)
 ;
"RTN","GMRCTIUE",183,0)
 D GETLIST^GMRCTIUL(GMRCO,2,1,.GMRCTIUC)
"RTN","GMRCTIUE",184,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",185,0)
 Q +$G(GMRCTIUC(GMRCVF))
"RTN","GMRCTIUE",186,0)
 ;
"RTN","GMRCTIUE",187,0)
ADDEND(GMRCO) ; Make an addendum action for a selected consult
"RTN","GMRCTIUE",188,0)
 N TIUDA,GMRCTX,GMRCDFN,GMRCADUZ,RSLTINFO,GMRCACT,GMRCTIUC
"RTN","GMRCTIUE",189,0)
 N GMRCLCK,RSLTIEN
"RTN","GMRCTIUE",190,0)
 K GMRCQUT
"RTN","GMRCTIUE",191,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)
"RTN","GMRCTIUE",192,0)
 Q:$D(GMRCQUT)!'+($G(GMRCO))
"RTN","GMRCTIUE",193,0)
 ;
"RTN","GMRCTIUE",194,0)
 ;If service administrative user, then QUIT.
"RTN","GMRCTIUE",195,0)
 I $$VALID^GMRCAU($P(^GMR(123,+GMRCO,0),U,5))=3 D  Q
"RTN","GMRCTIUE",196,0)
 . D EXAC^GMRCADC("You do not have the ability to edit this note.")
"RTN","GMRCTIUE",197,0)
 ;
"RTN","GMRCTIUE",198,0)
 ;Assume the user is a clinical user
"RTN","GMRCTIUE",199,0)
 ;
"RTN","GMRCTIUE",200,0)
 ;Get list of notes for this consult. if no notes, then quit.
"RTN","GMRCTIUE",201,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCTIUE",202,0)
 I '$$GETLIST(GMRCDFN,+GMRCO,.GMRCTIUC) D  Q
"RTN","GMRCTIUE",203,0)
 . W !,"This consult does not yet have an associated note."
"RTN","GMRCTIUE",204,0)
 . W !,"  Use the Complete action to enter a new note."
"RTN","GMRCTIUE",205,0)
 . D PAUSE,EDEX
"RTN","GMRCTIUE",206,0)
 ;
"RTN","GMRCTIUE",207,0)
 I '$$LOCK^GMRCA1(GMRCO) D EDEX Q
"RTN","GMRCTIUE",208,0)
 S GMRCLCK=1
"RTN","GMRCTIUE",209,0)
 ;If TIU Document already exists, use single record edit, and quit
"RTN","GMRCTIUE",210,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",211,0)
 I GMRCTIUC(GMRCVF)=1 D  D EDEX Q
"RTN","GMRCTIUE",212,0)
 . S GMRCTUFN=$$SINGLE(GMRCVF)
"RTN","GMRCTIUE",213,0)
 . Q:'+GMRCTUFN
"RTN","GMRCTIUE",214,0)
 . D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",215,0)
 . N GMRCVP,RSLTINFO,AUTHOR
"RTN","GMRCTIUE",216,0)
 . S GMRCVP=+GMRCTUFN_";"_GMRCVF
"RTN","GMRCTIUE",217,0)
 . S RSLTIEN=$O(^TMP("GMRC50",$J,GMRCVP,0))
"RTN","GMRCTIUE",218,0)
 . S RSLTINFO=$G(^TMP("GMRC50",$J,GMRCVP,RSLTIEN))
"RTN","GMRCTIUE",219,0)
 . I $P(RSLTINFO,"^",6)="completed" D ADDEND1(+GMRCTUFN) Q
"RTN","GMRCTIUE",220,0)
 . I (DUZ=+$P(RSLTINFO,"^",4)) D EDITNOTE(+GMRCTUFN) Q
"RTN","GMRCTIUE",221,0)
 . W !,"You may not addend to the incomplete associated note."
"RTN","GMRCTIUE",222,0)
 . W !,"You are not the author of the existing note."
"RTN","GMRCTIUE",223,0)
 . I $$READ^GMRCACMT("Y","Do you want to add a new note ","YES") D NEW
"RTN","GMRCTIUE",224,0)
 . Q
"RTN","GMRCTIUE",225,0)
 ;
"RTN","GMRCTIUE",226,0)
 ;Show the list of multiple tiu results for selection
"RTN","GMRCTIUE",227,0)
 D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",228,0)
 ;
"RTN","GMRCTIUE",229,0)
 ;Select a note from the list and then get the TIU internal entry
"RTN","GMRCTIUE",230,0)
 S GMRCSELR=$$SELR^GMRCTIUL(.GMRCTIUC)
"RTN","GMRCTIUE",231,0)
 I $D(GMRCQUT)!'+(GMRCSELR) D EDEX Q
"RTN","GMRCTIUE",232,0)
 S GMRCTUFN=$$GETTUFN(GMRCSELR)
"RTN","GMRCTIUE",233,0)
 ;
"RTN","GMRCTIUE",234,0)
 I +GMRCTUFN D ADDEND1(+GMRCTUFN),EDEX Q
"RTN","GMRCTIUE",235,0)
 ;
"RTN","GMRCTIUE",236,0)
 D EDEX
"RTN","GMRCTIUE",237,0)
 Q
"RTN","GMRCTIUE",238,0)
ADDEND1(TIUDA) ;Add an addendum
"RTN","GMRCTIUE",239,0)
 ;
"RTN","GMRCTIUE",240,0)
 D FULL^VALM1,ADDEND1^TIURA1
"RTN","GMRCTIUE",241,0)
 Q
"RTN","GMRCTIUE",242,0)
 ;
"RTN","GMRCTIUE",243,0)
EDEX ;
"RTN","GMRCTIUE",244,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO)
"RTN","GMRCTIUE",245,0)
 K GMRCDFN,GMRCO,GMRCQUT,GMRCTUFN,GMRCSEL,GMRCQIT
"RTN","GMRCTIUE",246,0)
 Q
"RTN","GMRCTIUE",247,0)
 ;
"RTN","GMRCTIUE",248,0)
PAUSE ; Pause for user
"RTN","GMRCTIUE",249,0)
 ;
"RTN","GMRCTIUE",250,0)
 N X W !,"Press <RETURN> to continue: " R X:DTIME E  W " (timeout)"
"RTN","GMRCTIUE",251,0)
 Q
"RTN","GMRCTIUE",252,0)
 ;
"RTN","GMRCTIUE",253,0)
CPGUI ;it's GUI way or no way
"RTN","GMRCTIUE",254,0)
 N MSG
"RTN","GMRCTIUE",255,0)
 S MSG="You must use the CPRS GUI to complete this Clinical Procedure"
"RTN","GMRCTIUE",256,0)
 D EXAC^GMRCADC(MSG)
"RTN","GMRCTIUE",257,0)
 Q
"VER")
8.0^22.0
**END**
**END**
