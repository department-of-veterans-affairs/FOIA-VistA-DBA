Released PSD*3*63 SEQ #51
Extracted from mail message
**KIDS**:PSD*3.0*63^

**INSTALL NAME**
PSD*3.0*63
"BLD",6923,0)
PSD*3.0*63^CONTROLLED SUBSTANCES^0^3061205^y
"BLD",6923,1,0)
^^2^2^3060919^
"BLD",6923,1,1,0)
Modifies PSD COST REPORTS, PSD NAOU BALANCE REPORT and PSD NURSE TRANSFER 
"BLD",6923,1,2,0)
GS.
"BLD",6923,4,0)
^9.64PA^^
"BLD",6923,6)
2^
"BLD",6923,6.3)
1
"BLD",6923,"ABPKG")
n
"BLD",6923,"KRN",0)
^9.67PA^8989.52^19
"BLD",6923,"KRN",.4,0)
.4
"BLD",6923,"KRN",.401,0)
.401
"BLD",6923,"KRN",.402,0)
.402
"BLD",6923,"KRN",.403,0)
.403
"BLD",6923,"KRN",.5,0)
.5
"BLD",6923,"KRN",.84,0)
.84
"BLD",6923,"KRN",3.6,0)
3.6
"BLD",6923,"KRN",3.8,0)
3.8
"BLD",6923,"KRN",9.2,0)
9.2
"BLD",6923,"KRN",9.8,0)
9.8
"BLD",6923,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",6923,"KRN",9.8,"NM",1,0)
PSDBAN^^0^B16836508
"BLD",6923,"KRN",9.8,"NM",2,0)
PSDCOSM^^0^B4039119
"BLD",6923,"KRN",9.8,"NM",3,0)
PSDCOSN^^0^B24950351
"BLD",6923,"KRN",9.8,"NM",4,0)
PSDNTF^^0^B32429867
"BLD",6923,"KRN",9.8,"NM","B","PSDBAN",1)

"BLD",6923,"KRN",9.8,"NM","B","PSDCOSM",2)

"BLD",6923,"KRN",9.8,"NM","B","PSDCOSN",3)

"BLD",6923,"KRN",9.8,"NM","B","PSDNTF",4)

"BLD",6923,"KRN",19,0)
19
"BLD",6923,"KRN",19.1,0)
19.1
"BLD",6923,"KRN",101,0)
101
"BLD",6923,"KRN",409.61,0)
409.61
"BLD",6923,"KRN",771,0)
771
"BLD",6923,"KRN",870,0)
870
"BLD",6923,"KRN",8989.51,0)
8989.51
"BLD",6923,"KRN",8989.52,0)
8989.52
"BLD",6923,"KRN",8994,0)
8994
"BLD",6923,"KRN","B",.4,.4)

"BLD",6923,"KRN","B",.401,.401)

"BLD",6923,"KRN","B",.402,.402)

"BLD",6923,"KRN","B",.403,.403)

"BLD",6923,"KRN","B",.5,.5)

"BLD",6923,"KRN","B",.84,.84)

"BLD",6923,"KRN","B",3.6,3.6)

"BLD",6923,"KRN","B",3.8,3.8)

"BLD",6923,"KRN","B",9.2,9.2)

"BLD",6923,"KRN","B",9.8,9.8)

"BLD",6923,"KRN","B",19,19)

"BLD",6923,"KRN","B",19.1,19.1)

"BLD",6923,"KRN","B",101,101)

"BLD",6923,"KRN","B",409.61,409.61)

"BLD",6923,"KRN","B",771,771)

"BLD",6923,"KRN","B",870,870)

"BLD",6923,"KRN","B",8989.51,8989.51)

"BLD",6923,"KRN","B",8989.52,8989.52)

"BLD",6923,"KRN","B",8994,8994)

"BLD",6923,"QUES",0)
^9.62^^
"BLD",6923,"REQB",0)
^9.611^2^2
"BLD",6923,"REQB",1,0)
PSD*3.0*17^2
"BLD",6923,"REQB",2,0)
PSD*3.0*56^2
"BLD",6923,"REQB","B","PSD*3.0*17",1)

"BLD",6923,"REQB","B","PSD*3.0*56",2)

"MBREQ")
0
"PKG",276,-1)
1^1
"PKG",276,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",276,20,0)
^9.402P^^
"PKG",276,22,0)
^9.49I^1^1
"PKG",276,22,1,0)
3.0^2970213^2970728^1271
"PKG",276,22,1,"PAH",1,0)
63^3061205^33259
"PKG",276,22,1,"PAH",1,1,0)
^^2^2^3061205
"PKG",276,22,1,"PAH",1,1,1,0)
Modifies PSD COST REPORTS, PSD NAOU BALANCE REPORT and PSD NURSE TRANSFER 
"PKG",276,22,1,"PAH",1,1,2,0)
GS.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSDBAN")
0^1^B16836508^B16651142
"RTN","PSDBAN",1,0)
PSDBAN ;BIR/JPW,LTL-Nurse BAL Report ; 8 Aug 94
"RTN","PSDBAN",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**63**;13 Feb 97;Build 1
"RTN","PSDBAN",3,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDBAN",4,0)
 S OK=$S($D(^XUSEC("PSJ RPHARM",DUZ)):1,$D(^XUSEC("PSJ PHARM TECH",DUZ)):1,$D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,1:0)
"RTN","PSDBAN",5,0)
 ;I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to",!,?12,"print this report.",! K OK Q
"RTN","PSDBAN",6,0)
 ;G:$G(NAOU)&($G(NAOUN)]"") ALL
"RTN","PSDBAN",7,0)
ASKN ;ask naou
"RTN","PSDBAN",8,0)
 K DA,DIC
"RTN","PSDBAN",9,0)
 S DIC=58.8,DIC(0)="QEA",DIC("A")="Select NAOU: ",DIC("B")=$G(NAOUN)
"RTN","PSDBAN",10,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)" D ^DIC K DIC G:Y<0 END
"RTN","PSDBAN",11,0)
 S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDBAN",12,0)
ALL ;asks for all orders
"RTN","PSDBAN",13,0)
 ;W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Do you want to print this report for all drugs",DIR("B")="YES"
"RTN","PSDBAN",14,0)
 W ! K DA,DIR,DIRUT
"RTN","PSDBAN",15,0)
 S DIR(0)="S^A:All Drugs;S:Single Drug;C:Contingency Report;G:All drugs (including green sheets)"
"RTN","PSDBAN",16,0)
 S DIR("A")="Please select type of report",DIR("B")="All Drugs"
"RTN","PSDBAN",17,0)
 S DIR("?",1)="Answer 'A' to list all balances for this NAOU,",DIR("?")="answer 'S' to show the balance for a specific drug or '^' to quit."
"RTN","PSDBAN",18,0)
 D ^DIR K DIR G:$D(DIRUT) END S ALL=Y
"RTN","PSDBAN",19,0)
 G:ALL="A"!(ALL="G") DEV G:ALL="C" DEV^PSDBAN1
"RTN","PSDBAN",20,0)
DRUG ;select drugs
"RTN","PSDBAN",21,0)
 W ! K DA,DIC S DIC("W")="W:$P(^PSDRUG(Y,0),""^"",9) ""   N/F"" I $P(^PSD(58.8,NAOU,1,Y,0),""^"",14)]"""",$P(^(0),""^"",14)'>DT W $C(7),""  *** INACTIVE ***"""
"RTN","PSDBAN",22,0)
 S DA(1)=+NAOU,DIC(0)="QEAM",DIC="^PSD(58.8,"_NAOU_",1," D ^DIC K DIC G:Y<0 END W !!,"Balance:  ",$P($G(^PSD(58.8,NAOU,1,+Y,0)),U,4)," ",$S($P($G(^PSD(58.8,NAOU,1,+Y,0)),U,8)]"":$P($G(^(0)),U,8),1:$P($G(^PSDRUG(+Y,660)),U,8)),!! Q
"RTN","PSDBAN",23,0)
DEV ;ask device and queue info
"RTN","PSDBAN",24,0)
 W !!,"You may queue this report to print at a later time.",!!
"RTN","PSDBAN",25,0)
 K %ZIS,IOP,IO("Q"),POP S %ZIS="QM",%ZIS("B")="HOME" D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G END
"RTN","PSDBAN",26,0)
 I $D(IO("Q")) K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDBAN",ZTDESC="Balance of NAOU drugs" D SAVE,^%ZTLOAD,HOME^%ZIS K ZTSK G END
"RTN","PSDBAN",27,0)
 ;U IO
"RTN","PSDBAN",28,0)
START ;loops thru DRUGS
"RTN","PSDBAN",29,0)
 U 0
"RTN","PSDBAN",30,0)
 W !!,"Give me a second or two to alphabetize.",!
"RTN","PSDBAN",31,0)
 U IO
"RTN","PSDBAN",32,0)
 N PSDRUG,PSDRUGN S PSDRUG=0,PSDRUGN="" K ^TMP("PSDNST",$J)
"RTN","PSDBAN",33,0)
 F  S PSDRUG=$O(^PSD(58.8,NAOU,1,PSDRUG)) Q:'PSDRUG  D:$P($G(^PSD(58.8,NAOU,1,PSDRUG,0)),U,4)
"RTN","PSDBAN",34,0)
 .S ^TMP("PSDNST",$J,$P($G(^PSDRUG(+PSDRUG,0)),U))=$P($G(^PSD(58.8,NAOU,1,PSDRUG,0)),U,4)_" "_$S($P($G(^(0)),U,8)]"":$P($G(^(0)),U,8),1:$P($G(^PSDRUG(PSDRUG,660)),U,8))
"RTN","PSDBAN",35,0)
PRINT ;prints the report
"RTN","PSDBAN",36,0)
 S (PG,PSDOUT)=0,RPDT=$$HTE^XLFDT($H)
"RTN","PSDBAN",37,0)
 K LN S $P(LN,"-",80)="" D HDR I '$D(^TMP("PSDNST",$J)) W !!,?10,"****  NO BALANCES TO REPORT  ****" G END
"RTN","PSDBAN",38,0)
 S PSDR="" F  S PSDR=$O(^TMP("PSDNST",$J,PSDR)) Q:PSDR=""!(PSDOUT)  W !,?2,"=>  ",PSDR,?62,$G(^TMP("PSDNST",$J,PSDR)),! Q:PSDOUT
"RTN","PSDBAN",39,0)
 G:PSDOUT END
"RTN","PSDBAN",40,0)
 ;W:$O(^TMP("PSDNSU",$J,0))]"" !!,"The following drugs have Green Sheets:",!!
"RTN","PSDBAN",41,0)
 ;F  S PSDR=$O(^TMP("PSDNSU",$J,PSDR)) Q:PSDR=""!(PSDOUT)  W ?2,"=>  ",PSDR,?62,$G(^TMP("PSDNSU",$J,PSDR)),! Q:PSDOUT
"RTN","PSDBAN",42,0)
DONE I $E(IOST)'="C" W @IOF
"RTN","PSDBAN",43,0)
 I $E(IOST,1,2)="C-",'PSDOUT W ! K DIR,DIRUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu" D ^DIR K DIR
"RTN","PSDBAN",44,0)
END D:$G(ALL)="G"&($D(ZTQUEUED)) START^PSDNSCG K %,%H,%I,%ZIS,ALL,DA,DIC,DIR,DIROUT,DIRUT,DTOUT,DUOUT,LN,NODE,OK,ORD
"RTN","PSDBAN",45,0)
 K PG,POP,PSDOUT,PSDPN,PSDR,PSDRN,PSDST,PSDT,QTY,REQ,RPDT,STAT,STATN,X,X1,X2,Y,ZTDESC,ZTDTH,ZTRTN,ZTSAVE,ZTSK,^TMP("PSDNST",$J),^TMP("PSDNSU",$J)
"RTN","PSDBAN",46,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDBAN",47,0)
 Q
"RTN","PSDBAN",48,0)
HDR ;header for log
"RTN","PSDBAN",49,0)
 I $E(IOST,1,2)="C-",PG W ! K DA,DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSDOUT=1 Q
"RTN","PSDBAN",50,0)
 S PG=PG+1 W:$Y @IOF W !,?25,"Controlled Substance Balances",?70,"Page: ",PG,!,?35,NAOUN,!,?25,RPDT,!
"RTN","PSDBAN",51,0)
 W !,?2,"=> DRUG",?62,"QUANTITY",!
"RTN","PSDBAN",52,0)
 W !,LN,!
"RTN","PSDBAN",53,0)
 Q
"RTN","PSDBAN",54,0)
SAVE S (ZTSAVE("ALL"),ZTSAVE("NAOU"),ZTSAVE("NAOUN"))="" S:$D(PSDR) ZTSAVE("PSDR")=""
"RTN","PSDBAN",55,0)
 Q
"RTN","PSDCOSM")
0^2^B4039119^B4145309
"RTN","PSDCOSM",1,0)
PSDCOSM ;BIR/LTL-Send MM about 0$ in DRUG file (#50), PSDCOST (cont'd) ; 9 Nov 93
"RTN","PSDCOSM",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**17,63**;13 Feb 97;Build 1
"RTN","PSDCOSM",3,0)
 K PSD,PSDM,PSDM1,PSDN D KILL^XM
"RTN","PSDCOSM",4,0)
 S XMSUB="DRUG file cost missing",XMDUZ=PSDCHO(1)_" messenger" D XMZ^XMA2
"RTN","PSDCOSM",5,0)
 I XMZ<1 D KILL^XM Q
"RTN","PSDCOSM",6,0)
 S XMY(DUZ)=""
"RTN","PSDCOSM",7,0)
 S PSD(1)=$S($P($G(^VA(200,DUZ,.1)),U,4)]"":$P($G(^(.1)),U,4),1:$P($P($G(^VA(200,DUZ,0)),U),",",2))_", when you ran the "_PSDCHO(1)_" on "_PSDT(1)_","
"RTN","PSDCOSM",8,0)
 ;
"RTN","PSDCOSM",9,0)
 ;DAVE B (PSD*3*17 29APR99) - more detailed report
"RTN","PSDCOSM",10,0)
 S PSD(2)="either the PRICE PER DISPENSE UNIT from the DRUG file (#50), or the quantity"
"RTN","PSDCOSM",11,0)
 S PSD(3)="recorded for the transaction, had a value of zero for the drug(s) listed below:"
"RTN","PSDCOSM",12,0)
 S PSD(4)=" "
"RTN","PSDCOSM",13,0)
 S $P(PSD(5)," ",65)="Price"
"RTN","PSDCOSM",14,0)
 S $P(PSD(6)," ",65)="Per"
"RTN","PSDCOSM",15,0)
 S $P(PSD(7)," ",52)="Transaction  Disp."
"RTN","PSDCOSM",16,0)
 S PSD(8)="Drug Name                       Date/Time            Number     Unit      Qnty"
"RTN","PSDCOSM",17,0)
 S $P(PSD(9),"-",79)=""
"RTN","PSDCOSM",18,0)
 S PSDM=0,PSDN=10
"RTN","PSDCOSM",19,0)
 ;
"RTN","PSDCOSM",20,0)
 F  S PSDM=$O(^TMP("PSDM",$J,PSDM)) Q:PSDM=""  D
"RTN","PSDCOSM",21,0)
 .S DATE=""
"RTN","PSDCOSM",22,0)
 .F  S DATE=$O(^TMP("PSDM",$J,PSDM,DATE)) Q:DATE=""  D
"RTN","PSDCOSM",23,0)
 ..S DATA=^TMP("PSDM",$J,PSDM,DATE)
"RTN","PSDCOSM",24,0)
 ..Q:DATA=""
"RTN","PSDCOSM",25,0)
 ..S PSDM1=$P($G(^PSDRUG(PSDM,0)),"^"),DATE=$$FMTE^XLFDT(DATE)
"RTN","PSDCOSM",26,0)
 ..S XX=$E(PSDM1,1,25),XXX=XX F X=$L(XX):1:29 S XXX=XXX_" "
"RTN","PSDCOSM",27,0)
 ..S XXX=XXX_DATE_$J($P(DATA,"^",1),9)_$J($P(DATA,"^",2),8,2)_$J($P(DATA,"^",3)+0,8)
"RTN","PSDCOSM",28,0)
 ..S PSD(PSDN)=XXX,PSDN=PSDN+1,PSD(PSDN)=" ",PSDN=PSDN+1
"RTN","PSDCOSM",29,0)
 D DONE
"RTN","PSDCOSM",30,0)
 Q
"RTN","PSDCOSM",31,0)
 ;
"RTN","PSDCOSM",32,0)
DONE ;
"RTN","PSDCOSM",33,0)
 S XMTEXT="PSD(" D ^XMD,KILL^XM Q
"RTN","PSDCOSN")
0^3^B24950351^B23348931
"RTN","PSDCOSN",1,0)
PSDCOSN ;BIR/LTL-Cost Report by NAOUs, PSDCOST (cont'd) ; 2 Aug 94
"RTN","PSDCOSN",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**63**;13 Feb 97;Build 1
"RTN","PSDCOSN",3,0)
 N PSDN,LN,PG,X2 S PSDSD(1)=PSDSD S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDCOSN",4,0)
 F  S PSDSD=$O(^PSD(58.81,"ACT",PSDSD)) W:$E(IOST)="C" "." Q:'PSDSD!(PSDSD>PSDED)  S PSDN=$O(^PSD(58.81,"ACT",PSDSD,0)) D:$P($G(^PSD(58.8,+PSDN,0)),U,3)=+PSDSITE
"RTN","PSDCOSN",5,0)
 .S PSDN(1)=$O(^PSD(58.81,"ACT",PSDSD,PSDN,0))
"RTN","PSDCOSN",6,0)
 .S PSDN(2)=$O(^PSD(58.81,"ACT",PSDSD,PSDN,PSDN(1),0))
"RTN","PSDCOSN",7,0)
 .Q:PSDN(2)<2!(PSDN(2)>5)&(PSDN(2)'=9)
"RTN","PSDCOSN",8,0)
 .S PSDN(3)=$P($G(^PSDRUG(+PSDN(1),0)),U)
"RTN","PSDCOSN",9,0)
 .S PSDN(4)=$O(^PSD(58.81,"ACT",PSDSD,PSDN,PSDN(1),PSDN(2),0))
"RTN","PSDCOSN",10,0)
 .S PSDN(8)=$G(^PSD(58.81,+PSDN(4),0))
"RTN","PSDCOSN",11,0)
 .Q:'$D(LOC(+$P(PSDN(8),U,18)))&(PSDN(2)'=9)!('$D(LOC(+PSDN))&(PSDN(2)=9))
"RTN","PSDCOSN",12,0)
 .;get NAOU for everything including adjustments
"RTN","PSDCOSN",13,0)
 .S PSDN(9)=$S(PSDN(2)=9:PSDN,1:$P(PSDN(8),U,18))
"RTN","PSDCOSN",14,0)
 .;qty rec'd by NAOU w/green sheet
"RTN","PSDCOSN",15,0)
 .S PSDN(5)=$P($G(^PSD(58.81,+PSDN(4),1)),U,8)
"RTN","PSDCOSN",16,0)
 .S PSDN(11)=$P($G(^PSDRUG(PSDN(1),660)),U,6)
"RTN","PSDCOSN",17,0)
 .I $D(PSDN) I 'PSDN(11) D GETDTA
"RTN","PSDCOSN",18,0)
 .;qty dispensed by Master Vault w/o green sheet
"RTN","PSDCOSN",19,0)
 .S:$P(PSDN(8),U,17)']"" PSDN(5)=$P(PSDN(8),U,6)
"RTN","PSDCOSN",20,0)
 .;Returned to Stock
"RTN","PSDCOSN",21,0)
 .S:PSDN(2)=3 PSDN(5)=-$P($G(^PSD(58.81,+PSDN(4),3)),U,2)
"RTN","PSDCOSN",22,0)
 .;Destroyed
"RTN","PSDCOSN",23,0)
 .S:PSDN(2)=4 PSDN(5)=-$P($G(^PSD(58.81,+PSDN(4),3)),U,5)
"RTN","PSDCOSN",24,0)
 .;include transfer ins with dispensed
"RTN","PSDCOSN",25,0)
 .S:PSDN(2)=5 PSDN(2)=2
"RTN","PSDCOSN",26,0)
 .;Check for transfers
"RTN","PSDCOSN",27,0)
 .S PSDN(6)=$G(^PSD(58.81,+PSDN(4),7))
"RTN","PSDCOSN",28,0)
 .D:$P(PSDN(6),U)>PSDSD(1)&($P(PSDN(6),U)<PSDED)
"RTN","PSDCOSN",29,0)
 ..S PSDN(5)=PSDN(5)-$P(PSDN(6),U,7),PSDN(2)=5
"RTN","PSDCOSN",30,0)
 .S PSDN(7)=$G(^TMP("PSD",$J,PSDN(9),PSDN(3)))
"RTN","PSDCOSN",31,0)
 .;total dispensed
"RTN","PSDCOSN",32,0)
 .S $P(^TMP("PSD",$J,PSDN(9),PSDN(3)),U)=$P(PSDN(7),U)+PSDN(5)
"RTN","PSDCOSN",33,0)
 .;DA for drug
"RTN","PSDCOSN",34,0)
 .S:'$P(PSDN(7),U,2) $P(^TMP("PSD",$J,PSDN(9),PSDN(3)),U,2)=PSDN(1)
"RTN","PSDCOSN",35,0)
 .;total returned to stock
"RTN","PSDCOSN",36,0)
 .S:PSDN(2)=3 $P(^TMP("PSD",$J,PSDN(9),PSDN(3)),U,3)=PSDN(5)+$P(PSDN(7),U,3)
"RTN","PSDCOSN",37,0)
 .;total destroyed
"RTN","PSDCOSN",38,0)
 .S:PSDN(2)=4 $P(^TMP("PSD",$J,PSDN(9),PSDN(3)),U,4)=PSDN(5)+$P(PSDN(7),U,4)
"RTN","PSDCOSN",39,0)
 .;total transferred
"RTN","PSDCOSN",40,0)
 .S:PSDN(2)=5 $P(^TMP("PSD",$J,PSDN(9),PSDN(3)),U,5)=-$P(PSDN(6),U,7)+$P(PSDN(7),U,5)
"RTN","PSDCOSN",41,0)
 .;total adjusted by NAOU
"RTN","PSDCOSN",42,0)
 .S:PSDN(2)=9 $P(^TMP("PSD",$J,PSDN(9),PSDN(3)),U,6)=PSDN(5)+$P(PSDN(7),U,6)
"RTN","PSDCOSN",43,0)
 .K PSDN
"RTN","PSDCOSN",44,0)
 ;
"RTN","PSDCOSN",45,0)
PRTQUE ;queues print after data is compiled
"RTN","PSDCOSN",46,0)
 I $D(ZTQUEUED) K ZTSAVE,ZTSK S ZTIO=PSDIO,ZTDESC="CS Cost Report by NAOU",ZTRTN="START^PSDCOSN",ZTSAVE("PSD*")="",ZTSAVE("^TMP(""PSD"",$J,")="",ZTSAVE("SUM")="",ZTDTH=$H D ^%ZTLOAD,HOME^%ZIS G QUIT
"RTN","PSDCOSN",47,0)
START S (PG,PSDN)=0 D HEADER
"RTN","PSDCOSN",48,0)
 F  S PSDN=$O(^TMP("PSD",$J,PSDN)) Q:'PSDN  D:$Y+6>IOSL HEADER G:$G(PSDOUT) END S PSDN(8)=$G(PSDN(8))+1 K PG(PSDN) D  G:$G(PSDOUT) END
"RTN","PSDCOSN",49,0)
 .W ?8,"NAOU ==> ",$P($G(^PSD(58.8,+PSDN,0)),U),!! S PSDN(1)=0
"RTN","PSDCOSN",50,0)
 .F  S PSDN(1)=$O(^TMP("PSD",$J,PSDN,PSDN(1))) Q:PSDN(1)']""  D:$Y+6>IOSL HEADER Q:$G(PSDOUT)  S PSDN(9)=$G(PSDN(9))+1 D
"RTN","PSDCOSN",51,0)
 ..I $D(PG(PSDN)) W ?8,"NAOU ==> ",$P($G(^PSD(58.8,+PSDN,0)),U)," (continued)",!! K PG(PSDN)
"RTN","PSDCOSN",52,0)
 ..W:'$G(SUM) $E(PSDN(1),1,34),?36
"RTN","PSDCOSN",53,0)
 ..S PSDN(2)=$G(^TMP("PSD",$J,PSDN,PSDN(1))),PSDN(3)=$G(PSDN(3))+PSDN(2)
"RTN","PSDCOSN",54,0)
 ..W:'$G(SUM) $J($P(PSDN(2),U),10),?62
"RTN","PSDCOSN",55,0)
 ..S PSDN(11)=$P($G(^PSDRUG(+$P(PSDN(2),U,2),660)),U,6)
"RTN","PSDCOSN",56,0)
 ..S (X,PSDN(4))=$P(PSDN(2),U)*PSDN(11),X2="2$",PSDN(5)=$G(PSDN(5))+PSDN(4) D COMMA^%DTC W:'$G(SUM) X,!!
"RTN","PSDCOSN",57,0)
 ..S PSDN(10)=" (Subtracted from total)"
"RTN","PSDCOSN",58,0)
 ..W:'$G(SUM)&($P(PSDN(2),U,3)) "Doses Returned to Stock: ",$P(PSDN(2),U,3),PSDN(10),!!
"RTN","PSDCOSN",59,0)
 ..W:'$G(SUM)&($P(PSDN(2),U,4)) "Doses Destroyed: ",$P(PSDN(2),U,4),PSDN(10),!!
"RTN","PSDCOSN",60,0)
 ..W:'$G(SUM)&($P(PSDN(2),U,5)) "Doses Transferred: ",$P(PSDN(2),U,5),PSDN(10),!!
"RTN","PSDCOSN",61,0)
 ..W:'$G(SUM)&($P(PSDN(2),U,6)) "Doses Adjusted by NAOU: ",$P(PSDN(2),U,6)," (Not affecting total)",!!
"RTN","PSDCOSN",62,0)
 ..;S:'PSDN(11) ^TMP("PSDM",$J,PSDN(1))=""
"RTN","PSDCOSN",63,0)
 .Q:$G(PSDOUT)  W LN,!?28,"Total:  ",$J($G(PSDN(3)),10),?62
"RTN","PSDCOSN",64,0)
 .S X=$G(PSDN(5)) D COMMA^%DTC W X,!! S PSDN(6)=$G(PSDN(6))+PSDN(3)
"RTN","PSDCOSN",65,0)
 .S PSDN(7)=$G(PSDN(7))+PSDN(5) K PSDN(3),PSDN(5),PSDN(9)
"RTN","PSDCOSN",66,0)
 I $G(PSDN(8))>1 W LN,!?14,"Total for all NAOUs:  ",$J($G(PSDN(6)),10) S X=$G(PSDN(7)) D COMMA^%DTC W ?62,X,!!
"RTN","PSDCOSN",67,0)
 ;I DUZ=33238 I $D(^TMP("PSDM")) D ^PSDCOSM
"RTN","PSDCOSN",68,0)
 I $D(^TMP("PSDM",$J)) S ZTRTN="^PSDCOSM",ZTIO="",ZTDTH=$H,ZTDESC="Mailman notification of 0 DRUG file cost",ZTSAVE("PSD*")="",ZTSAVE("^TMP(""PSDM"",$J,")="" D ^%ZTLOAD
"RTN","PSDCOSN",69,0)
 W:'$O(^TMP("PSD",$J,0)) !!,"Sorry, nothing to report for selected NAOU(s).",!!
"RTN","PSDCOSN",70,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSDCOSN",71,0)
 I $E(IOST)="C",'$G(PSDOUT) W !! S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSDCOSN",72,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDCOSN",73,0)
QUIT K ^TMP("PSD",$J),^TMP("PSDM",$J),IO("Q") Q
"RTN","PSDCOSN",74,0)
HEADER ;prints header info
"RTN","PSDCOSN",75,0)
 I $E(IOST,1,2)'="P-",PG S DIR(0)="E" D ^DIR K DIR I 'Y S PSDOUT=1 Q
"RTN","PSDCOSN",76,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSDOUT=1
"RTN","PSDCOSN",77,0)
 W:$Y @IOF S $P(LN,"-",80)="",PG=PG+1,PG(PSDN)="" W !?2,PSDCHO(1)," From "
"RTN","PSDCOSN",78,0)
 W $P(PSDATE,U)," To ",$P(PSDATE,U,2),?72,"Page ",PG,!!
"RTN","PSDCOSN",79,0)
 W ?45,"Report Date:  ",PSDT(1),!!?40,"Quantity",!,"Drug",?40,"Dispensed"
"RTN","PSDCOSN",80,0)
 W ?70,"Cost",!,LN,!!
"RTN","PSDCOSN",81,0)
 Q
"RTN","PSDCOSN",82,0)
GETDTA ;
"RTN","PSDCOSN",83,0)
 N DTE
"RTN","PSDCOSN",84,0)
 Q:'$D(PSDN)
"RTN","PSDCOSN",85,0)
 S DTE=$P(PSDN(8),U,4)
"RTN","PSDCOSN",86,0)
 S ^TMP("PSDM",$J,PSDN(1),DTE)=PSDN(4)_"^"_PSDN(11)_"^"_PSDN(5)
"RTN","PSDCOSN",87,0)
 Q
"RTN","PSDCOSN",88,0)
 ;
"RTN","PSDNTF")
0^4^B32429867^B32078580
"RTN","PSDNTF",1,0)
PSDNTF ;BIR/JPW-Transfer Green Sheet - From this NAOU ; 1 Mar 98
"RTN","PSDNTF",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,56,63**;13 Feb 97;Build 1
"RTN","PSDNTF",3,0)
 ;**Y2K compliance**;display 4 digit year on va forms
"RTN","PSDNTF",4,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNTF",5,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):1,1:0)
"RTN","PSDNTF",6,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to",!,?12,"transfer narcotic orders.",!!,"PSJ RNURSE, PSD NURSE, or PSJ RPHARM security key required.",! K OK Q
"RTN","PSDNTF",7,0)
 W !!,"Transfer a Green Sheet from this NAOU" S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDNTF",8,0)
ASKN ;ask transfer from naou
"RTN","PSDNTF",9,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer from NAOU: "
"RTN","PSDNTF",10,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTF",11,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNTF",12,0)
GS ;select green sheet #
"RTN","PSDNTF",13,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNTF",14,0)
 S DIC("S")="I $P(^(0),""^"",11)=4!($P(^(0),U,11)=13),$P(^(0),""^"",18)=AOU",DIC("W")="W "" "",$P($G(^PSDRUG($P(^(0),U,5),0)),U),"" => "",$P($G(^DPT(+$P($G(^PSD(58.81,Y,9)),U),0)),U)"
"RTN","PSDNTF",15,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDNTF",16,0)
 S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNTF",17,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^")
"RTN","PSDNTF",18,0)
 S MFG=$P(Y(0),"^",13),LOT=$P(Y(0),"^",14),EXP=$P(Y(0),"^",15),QTY=+$P(Y(0),"^",6),PSDS=+$P(Y(0),"^",3)
"RTN","PSDNTF",19,0)
 S NBKU=$P($G(^PSD(58.8,+PSDS,1,+PSDR,0)),"^",8)
"RTN","PSDNTF",20,0)
 I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=+$P(^(4),"^",3)
"RTN","PSDNTF",21,0)
 I AOU'=NAOU W !!,"The Green Sheet # ",PSDPN," does not reside on ",AOUN,".",!,"Please select another Green Sheet.",! G ASKN
"RTN","PSDNTF",22,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTF",23,0)
 I STAT'=4,STAT'=13 W !!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTF",24,0)
ASKT ;ask transfer to naou
"RTN","PSDNTF",25,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer To NAOU: "
"RTN","PSDNTF",26,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTF",27,0)
 D ^DIC K DIC G:Y<0 END S NAOUT=+Y,NAOUTN=$P(Y,"^",2)
"RTN","PSDNTF",28,0)
 I NAOUT=AOU W !!,"You may not transfer a Green Sheet to your NAOU!",!,"Please select another NAOU.",!! G ASKT
"RTN","PSDNTF",29,0)
 I QTY=1 S RQTY=1 W !,"Quantity to Transfer (",NBKU,"/1)",! G OK
"RTN","PSDNTF",30,0)
QTY ;
"RTN","PSDNTF",31,0)
 W !,"Quantity to Transfer ("_NBKU_"/"_QTY_"): " R X:DTIME I '$T!(X="^")!(X="") S PSDOUT=1 W !!,"**** No action taken. ****",!! G END
"RTN","PSDNTF",32,0)
 ;I X'?1.6N!(X=0) W !!,"Enter a whole number between 1 and ",QTY,! G QTY
"RTN","PSDNTF",33,0)
 I +X'=X!(X>999999)!(X'>0)!(X?.E1"."4N.N) D  G QTY
"RTN","PSDNTF",34,0)
 . W !!,"Enter a number between .01 and ",QTY,!
"RTN","PSDNTF",35,0)
 I X>QTY W $C(7),!!,"The quantity returned must not exceed "_QTY_"!",! G QTY
"RTN","PSDNTF",36,0)
 S RQTY=X
"RTN","PSDNTF",37,0)
OK ;if perpetual NAOU and not ordered for patient
"RTN","PSDNTF",38,0)
 D:QTY=1&('$P($G(^PSD(58.81,PSDA,9)),U))  G:$G(PSDOUT) END
"RTN","PSDNTF",39,0)
 .W !,PSDRN," Current Balance:  ",$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)," ",NBKU,!
"RTN","PSDNTF",40,0)
 .S DIR(0)="Y",DIR("A")="Is this a PCA syringe that has already been signed out for a patient",DIR("B")="Y",DIR("?")="If you answer no, your balance will be subtracted by one" D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDNTF",41,0)
 .Q:Y'=1
"RTN","PSDNTF",42,0)
 .S RQTY(1)=1
"RTN","PSDNTF",43,0)
 .S DIC="^DPT(",DIC(0)="AEMQ",DIC("A")="Scan/Enter Patient: "
"RTN","PSDNTF",44,0)
 .W ! D ^DIC K DIC I Y<1 S PSDOUT=1 W !!,"No action taken.",!! Q
"RTN","PSDNTF",45,0)
 .S PAT=+Y
"RTN","PSDNTF",46,0)
 ;ask ok to transfer
"RTN","PSDNTF",47,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Are you sure",DIR("B")="NO"
"RTN","PSDNTF",48,0)
 S DIR("?",1)="Answer 'YES' to transfer this Green Sheet to another NAOU or",DIR("?")="answer 'NO' to leave the Green Sheet status active on your NAOU."
"RTN","PSDNTF",49,0)
 D ^DIR K DIR G:$D(DIRUT) END G:'Y GS
"RTN","PSDNTF",50,0)
 D NOW^%DTC S (RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNTF",51,0)
COM ;complete at order level in 58.8
"RTN","PSDNTF",52,0)
 W !!,"Accessing ",PSDRN," information...",!!
"RTN","PSDNTF",53,0)
 S BQTY=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),"^",22):$P(^(0),"^",22)-RQTY,1:QTY-RQTY)
"RTN","PSDNTF",54,0)
 W !!,"Updating your records now..."
"RTN","PSDNTF",55,0)
 ;update transaction file (58.81)
"RTN","PSDNTF",56,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81,DR="64////"_RECD_";65////"_PSDUZ_";66////"_NAOUT_";70////"_RQTY_";10////10;73////"_$G(PAT) D ^DIE K DA,DIE,DR
"RTN","PSDNTF",57,0)
 I $D(Y)!$D(DTOUT) W $C(7),!!,"** THIS GREEN SHEET HAS NOT BEEN TRANSFERRED **",!!,"The status remains "_STATN,! G END
"RTN","PSDNTF",58,0)
 ;update order
"RTN","PSDNTF",59,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////10;22////"_BQTY D ^DIE K DA,DIE,DR
"RTN","PSDNTF",60,0)
 ;update naou bal
"RTN","PSDNTF",61,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):0 I  Q
"RTN","PSDNTF",62,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDNTF",63,0)
 S:'$G(RQTY(1)) $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)-RQTY
"RTN","PSDNTF",64,0)
 W:$P($G(^PSD(58.8,NAOU,2)),U,5) !,PSDRN," Remaining Balance:  ",$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)," ",NBKU,!
"RTN","PSDNTF",65,0)
 L -^PSD(58.8,NAOU,PSDR,0)
"RTN","PSDNTF",66,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11)
"RTN","PSDNTF",67,0)
 W ?2,!,"*** The status of your Green Sheet #"_PSDPN_" is now",!,$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNTF",68,0)
PRINT ;print 2321
"RTN","PSDNTF",69,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! Q
"RTN","PSDNTF",70,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G PRINT
"RTN","PSDNTF",71,0)
 S Y=RECD X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDNTF",72,0)
 S (PG,PSDOUT)=0,REAS="",COMP=999,RECDT=$E(RECD,4,5)_"/"_$E(RECD,6,7)_"/"_PSDYR
"RTN","PSDNTF",73,0)
 I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3) S EXP=EXPD
"RTN","PSDNTF",74,0)
 D ^PSDGSRV2
"RTN","PSDNTF",75,0)
END K %,%DT,%H,%I,AOU,AOUN,BQTY,COMP,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXP1,EXPD,LOT,MFG
"RTN","PSDNTF",76,0)
 K NAOU,NAOUN,NAOUT,NAOUTN,NBKU,NUM,OK,ORD,PG,PSDA,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDUZ,PSDUZN,PSDYR,QTY,REAS,RECD,RECDT,RQTY,STAT,STATN,X,Y
"RTN","PSDNTF",77,0)
 Q
"VER")
8.0^22.0
"BLD",6923,6)
^51
**END**
**END**
