Released TIU*1*167 SEQ #156
Extracted from mail message
**KIDS**:TIU*1.0*167^

**INSTALL NAME**
TIU*1.0*167
"BLD",4439,0)
TIU*1.0*167^TEXT INTEGRATION UTILITIES^0^3030611^y
"BLD",4439,1,0)
^^2^2^3030611^^^^
"BLD",4439,1,1,0)
The description of this patch may be found under the National Patch Module 
"BLD",4439,1,2,0)
under TIU*1.0*167.
"BLD",4439,4,0)
^9.64PA^^
"BLD",4439,"KRN",0)
^9.67PA^8989.52^19
"BLD",4439,"KRN",.4,0)
.4
"BLD",4439,"KRN",.401,0)
.401
"BLD",4439,"KRN",.402,0)
.402
"BLD",4439,"KRN",.403,0)
.403
"BLD",4439,"KRN",.5,0)
.5
"BLD",4439,"KRN",.84,0)
.84
"BLD",4439,"KRN",3.6,0)
3.6
"BLD",4439,"KRN",3.8,0)
3.8
"BLD",4439,"KRN",9.2,0)
9.2
"BLD",4439,"KRN",9.8,0)
9.8
"BLD",4439,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",4439,"KRN",9.8,"NM",1,0)
TIUSRVP^^0^B62308440
"BLD",4439,"KRN",9.8,"NM",2,0)
TIUSRVP1^^0^B37897256
"BLD",4439,"KRN",9.8,"NM",3,0)
TIUPEFIX^^0^B39777414
"BLD",4439,"KRN",9.8,"NM",4,0)
TIUCPFIX^^0^B56248436
"BLD",4439,"KRN",9.8,"NM","B","TIUCPFIX",4)

"BLD",4439,"KRN",9.8,"NM","B","TIUPEFIX",3)

"BLD",4439,"KRN",9.8,"NM","B","TIUSRVP",1)

"BLD",4439,"KRN",9.8,"NM","B","TIUSRVP1",2)

"BLD",4439,"KRN",19,0)
19
"BLD",4439,"KRN",19.1,0)
19.1
"BLD",4439,"KRN",101,0)
101
"BLD",4439,"KRN",409.61,0)
409.61
"BLD",4439,"KRN",771,0)
771
"BLD",4439,"KRN",870,0)
870
"BLD",4439,"KRN",8989.51,0)
8989.51
"BLD",4439,"KRN",8989.52,0)
8989.52
"BLD",4439,"KRN",8994,0)
8994
"BLD",4439,"KRN","B",.4,.4)

"BLD",4439,"KRN","B",.401,.401)

"BLD",4439,"KRN","B",.402,.402)

"BLD",4439,"KRN","B",.403,.403)

"BLD",4439,"KRN","B",.5,.5)

"BLD",4439,"KRN","B",.84,.84)

"BLD",4439,"KRN","B",3.6,3.6)

"BLD",4439,"KRN","B",3.8,3.8)

"BLD",4439,"KRN","B",9.2,9.2)

"BLD",4439,"KRN","B",9.8,9.8)

"BLD",4439,"KRN","B",19,19)

"BLD",4439,"KRN","B",19.1,19.1)

"BLD",4439,"KRN","B",101,101)

"BLD",4439,"KRN","B",409.61,409.61)

"BLD",4439,"KRN","B",771,771)

"BLD",4439,"KRN","B",870,870)

"BLD",4439,"KRN","B",8989.51,8989.51)

"BLD",4439,"KRN","B",8989.52,8989.52)

"BLD",4439,"KRN","B",8994,8994)

"BLD",4439,"QUES",0)
^9.62^^
"BLD",4439,"REQB",0)
^9.611^3^3
"BLD",4439,"REQB",1,0)
TEXT INTEGRATION UTILITIES 1.0^2
"BLD",4439,"REQB",2,0)
TIU*1.0*109^2
"BLD",4439,"REQB",3,0)
TIU*1.0*100^2
"BLD",4439,"REQB","B","TEXT INTEGRATION UTILITIES 1.0",1)

"BLD",4439,"REQB","B","TIU*1.0*100",3)

"BLD",4439,"REQB","B","TIU*1.0*109",2)

"MBREQ")
0
"PKG",193,-1)
1^1
"PKG",193,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",193,20,0)
^9.402P^^
"PKG",193,22,0)
^9.49I^1^1
"PKG",193,22,1,0)
1.0^3010321^3010321^11
"PKG",193,22,1,"PAH",1,0)
167^3030611
"PKG",193,22,1,"PAH",1,1,0)
^^2^2^3030611
"PKG",193,22,1,"PAH",1,1,1,0)
The description of this patch may be found under the National Patch Module 
"PKG",193,22,1,"PAH",1,1,2,0)
under TIU*1.0*167.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","TIUCPFIX")
0^4^B56248436
"RTN","TIUCPFIX",1,0)
TIUCPFIX ; SLC/JER,RMO - Resolve Filing errors for CP Documents ;10/30/01
"RTN","TIUCPFIX",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**109,167**;Jun 20, 1997
"RTN","TIUCPFIX",3,0)
 ; This routine is a modified version of TIUPEFIX
"RTN","TIUCPFIX",4,0)
MAKE(SUCCESS,DFN,TITLE,TIU,TIUBUF,TIUPLDA) ; File new TIU Document
"RTN","TIUCPFIX",5,0)
 ; SUCCESS = (by ref) SUCCESS Returns TIU DOCUMENT # (PTR to 8925)
"RTN","TIUCPFIX",6,0)
 ;         = 0^Explanatory message if no SUCCESS
"RTN","TIUCPFIX",7,0)
 ; DFN     = Patient (#2)
"RTN","TIUCPFIX",8,0)
 ; TITLE   = Pointer to TIU Document Definition (#8925.1)
"RTN","TIUCPFIX",9,0)
 ; TIU     = Array of demographic and visit attributes
"RTN","TIUCPFIX",10,0)
 ; TIUBUF  = Record number (ien) of entry in TIU Buffer file (#8925.2)
"RTN","TIUCPFIX",11,0)
 ; TIUPLDA = Record number (ien) of entry in TIU Document file (#8925)  (Optional)
"RTN","TIUCPFIX",12,0)
 ;
"RTN","TIUCPFIX",13,0)
 ; -- first, get TIU Document record --
"RTN","TIUCPFIX",14,0)
 ;
"RTN","TIUCPFIX",15,0)
 N TIUDA,LDT,NEWREC,TIUX,TIUTYP,TIUDPRM,HAPPY,TIUCLASS,TIUDTYP,TIUPOST
"RTN","TIUCPFIX",16,0)
 N TIUDFLT,TIUREC,TIUCNNBR,TIUDNB,TIUDTP,TIUPSC,TIUQUIT
"RTN","TIUCPFIX",17,0)
 S SUCCESS=0 ; Initialize SUCCESS to false
"RTN","TIUCPFIX",18,0)
 I '$G(TIUPLDA) D  G MAKEQ:$G(TIUQUIT)
"RTN","TIUCPFIX",19,0)
 . I $S($D(TIU)'>9:1,+$G(DFN)'>0:1,+$G(TIUTYPE)'>0:1,1:0) S SUCCESS="0^"_$$EZBLD^DIALOG(89250001) S TIUQUIT=1 Q
"RTN","TIUCPFIX",20,0)
 . ; If target file is not 8925 QUIT
"RTN","TIUCPFIX",21,0)
 . I +$G(^TIU(8925.1,+TIUTYPE,1))'=8925 S TIUQUIT=1 Q
"RTN","TIUCPFIX",22,0)
 . S TIUDTYP=$P($G(^TIU(8925.1,+TIUTYPE,0)),U,4)
"RTN","TIUCPFIX",23,0)
 . S TIUCLASS=$S(TIUDTYP="CL":+TIUTYPE,1:38)
"RTN","TIUCPFIX",24,0)
 . S TIUDFLT=$S(TIUCLASS'=TIUTYPE:TIUTYPE,1:"")
"RTN","TIUCPFIX",25,0)
 . I +$G(TITLE)'>0 S TITLE=$$ASKTITLE^TIULA3(TIUCLASS,TIUDFLT)
"RTN","TIUCPFIX",26,0)
 . I +TITLE'>0 S TIUQUIT=1 Q
"RTN","TIUCPFIX",27,0)
 ELSE  D
"RTN","TIUCPFIX",28,0)
 . S TITLE=+$G(^TIU(8925,+TIUPLDA,0))
"RTN","TIUCPFIX",29,0)
 S TIUTYP=TITLE,TIUTYP(1)=1_U_TITLE
"RTN","TIUCPFIX",30,0)
 D DOCPRM^TIULC1(TITLE,.TIUDPRM)
"RTN","TIUCPFIX",31,0)
 ;
"RTN","TIUCPFIX",32,0)
 ; -- second, load the header elements & text into TIUX array
"RTN","TIUCPFIX",33,0)
 ;
"RTN","TIUCPFIX",34,0)
 D LOADTIUX(.TIUX,TIUBUF)
"RTN","TIUCPFIX",35,0)
 ;
"RTN","TIUCPFIX",36,0)
 ;Set variables
"RTN","TIUCPFIX",37,0)
 I $G(TIUPLDA) D
"RTN","TIUCPFIX",38,0)
 . S TIUCNNBR=+$P($G(^TIU(8925,+TIUPLDA,14)),U,5)
"RTN","TIUCPFIX",39,0)
 ELSE  D
"RTN","TIUCPFIX",40,0)
 . S TIUCNNBR=$S(+$P($G(TIUX(1405)),"C.",2):+$P($G(TIUX(1405)),"C.",2),1:"")
"RTN","TIUCPFIX",41,0)
 . S:$G(TIUX(.001)) TIUPLDA=$G(TIUX(.001))
"RTN","TIUCPFIX",42,0)
 S TIUPSC=$G(TIUX(70201))
"RTN","TIUCPFIX",43,0)
 S TIUDTP=$G(TIUX(70202))
"RTN","TIUCPFIX",44,0)
 ;
"RTN","TIUCPFIX",45,0)
 ;Check consult associated with document
"RTN","TIUCPFIX",46,0)
 I '$$CHKCN^TIUPUTCP(TIUCNNBR,DFN,$G(TIUPLDA),.TIUDNB) S SUCCESS="0^"_$$EZBLD^DIALOG($G(TIUDNB)) G MAKEQ
"RTN","TIUCPFIX",47,0)
 ;
"RTN","TIUCPFIX",48,0)
 ;Check consult as it related to CP
"RTN","TIUCPFIX",49,0)
 I '$$CHKCP^TIUPUTCP(TIUCNNBR,$G(TIUPLDA),.TIUDNB) S SUCCESS="0^"_$$EZBLD^DIALOG($G(TIUDNB)) G MAKEQ
"RTN","TIUCPFIX",50,0)
 ;
"RTN","TIUCPFIX",51,0)
 ;If TIU document IEN is defined use it, otherwise call TIUEDI3
"RTN","TIUCPFIX",52,0)
 I $G(TIUPLDA) D
"RTN","TIUCPFIX",53,0)
 . S TIUDA=TIUPLDA
"RTN","TIUCPFIX",54,0)
 ELSE  D
"RTN","TIUCPFIX",55,0)
 . S TIUDA=$$GETRECNW^TIUEDI3(DFN,.TIU,TIUTYP(1),.NEWREC,.TIUDPRM)
"RTN","TIUCPFIX",56,0)
 I +TIUDA'>0 S SUCCESS="0^"_$$EZBLD^DIALOG(89250002) G MAKEQ
"RTN","TIUCPFIX",57,0)
 I +$$CANEDIT^TIUPUTU(TIUDA)'>0 D  G MAKEX
"RTN","TIUCPFIX",58,0)
 . D MAKEADD(.TIUADD,+TIUDA,TIUBUF) S SUCCESS=TIUADD
"RTN","TIUCPFIX",59,0)
 S SUCCESS=1
"RTN","TIUCPFIX",60,0)
 ;
"RTN","TIUCPFIX",61,0)
 D STUFREC(TIUDA,$G(DFN),,.TIU,$G(TIUPSC),$G(TIUDTP),$G(TIUPLDA))
"RTN","TIUCPFIX",62,0)
 ;
"RTN","TIUCPFIX",63,0)
 ; -- third, file the data in TIU Document record --
"RTN","TIUCPFIX",64,0)
 ;
"RTN","TIUCPFIX",65,0)
 K ^TIU(8925,+TIUDA,"TEMP"),TIUX(.01),TIUX(.02),TIUX(.03),TIUX(.05)
"RTN","TIUCPFIX",66,0)
 K TIUX(.13),TIUX(1205),TIUX(1211),TIUX(.001),TIUX(70201),TIUX(70202)
"RTN","TIUCPFIX",67,0)
 M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUCPFIX",68,0)
 D FILE(.HAPPY,+TIUDA,.TIUX,TIUTYP)
"RTN","TIUCPFIX",69,0)
 D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUCPFIX",70,0)
 S TIUPOST=$$POSTFILE^TIULC1(TITLE)
"RTN","TIUCPFIX",71,0)
 S TIUREC("#")=TIUDA
"RTN","TIUCPFIX",72,0)
 I TIUPOST]"" X TIUPOST
"RTN","TIUCPFIX",73,0)
MAKEX D ALERTDEL^TIUPEVNT(+TIUBUF)
"RTN","TIUCPFIX",74,0)
 D RESOLVE^TIUPEVNT($S($D(XQADATA):+$P(XQADATA,";",3),1:$G(ERRDA)),1)
"RTN","TIUCPFIX",75,0)
 D BUFPURGE^TIUPUTC(+TIUBUF)
"RTN","TIUCPFIX",76,0)
 K ^TIU(8925,+TIUDA,"TEMP") W "Done."
"RTN","TIUCPFIX",77,0)
 I +$G(TIUDA),+$D(^TIU(8925,+$G(TIUDA),0)) D
"RTN","TIUCPFIX",78,0)
 . N TIU D GETTIU^TIULD(.TIU,+TIUDA)
"RTN","TIUCPFIX",79,0)
 . D EN^VALM("TIU BROWSE FOR MRT")
"RTN","TIUCPFIX",80,0)
MAKEQ Q
"RTN","TIUCPFIX",81,0)
LOADTIUX(TIUARR,TIUBUF) ; Load TIUX array with header and text
"RTN","TIUCPFIX",82,0)
 N TIUI,TIUHSIG,TIUBGN,TIULINE,X,Y,TYPE I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIUCPFIX",83,0)
 S TIUHSIG=$P(TIUPRM0,U,10),TIUBGN=$P(TIUPRM0,U,12)
"RTN","TIUCPFIX",84,0)
 S TIUI=0 F  S TIUI=$O(^TIU(8925.2,+TIUBUF,"TEXT",TIUI)) Q:+TIUI'>0  D
"RTN","TIUCPFIX",85,0)
 . S TIULINE=$G(^TIU(8925.2,+TIUBUF,"TEXT",TIUI,0))
"RTN","TIUCPFIX",86,0)
 . I TIULINE[TIUHSIG D
"RTN","TIUCPFIX",87,0)
 . . N TIUD1,TIUD4
"RTN","TIUCPFIX",88,0)
 . . S X=$$STRIP^TIULS($P(TIULINE,":",2)),Y=$$WHATYPE^TIUPUTU(X)
"RTN","TIUCPFIX",89,0)
 . . I +Y'>0 D MAIN^TIUPEVNT(TIUBUF,1,3,X) Q
"RTN","TIUCPFIX",90,0)
 . . S TIUD1=$G(^TIU(8925.1,+Y,1)),TIUD4=$G(^TIU(8925.1,+Y,4))
"RTN","TIUCPFIX",91,0)
 . . S TYPE=+Y
"RTN","TIUCPFIX",92,0)
 . . F  D  Q:TIULINE[TIUBGN!(+TIUI'>0)
"RTN","TIUCPFIX",93,0)
 . . . N TIUN,TIUCAP,TIUFLD,TIUREQ S TIUREQ=0
"RTN","TIUCPFIX",94,0)
 . . . S TIUI=$O(^TIU(8925.2,+TIUBUF,"TEXT",TIUI)) Q:+TIUI'>0
"RTN","TIUCPFIX",95,0)
 . . . S TIULINE=$G(^TIU(8925.2,+TIUBUF,"TEXT",TIUI,0)) Q:TIULINE[TIUBGN
"RTN","TIUCPFIX",96,0)
 . . . S TIUCAP=$P(TIULINE,":") Q:TIUCAP']""
"RTN","TIUCPFIX",97,0)
 . . . S TIUN=$O(^TIU(8925.1,+TYPE,"HEAD","B",TIUCAP,0))
"RTN","TIUCPFIX",98,0)
 . . . Q:+TIUN'>0
"RTN","TIUCPFIX",99,0)
 . . . S TIUFLD=$P(^TIU(8925.1,+TYPE,"HEAD",+TIUN,0),U,3)
"RTN","TIUCPFIX",100,0)
 . . . Q:TIUFLD']""
"RTN","TIUCPFIX",101,0)
 . . . S TIUREQ=$P(^TIU(8925.1,+TYPE,"HEAD",+TIUN,0),U,7)
"RTN","TIUCPFIX",102,0)
 . . . S TIUARR(TIUFLD)=$$STRIP^TIULS($P(TIULINE,":",2,99))
"RTN","TIUCPFIX",103,0)
 . . . S:TIUFLD'=.001 TIUARR(TIUFLD)=$$TRNSFRM(+TYPE,TIUFLD,TIUARR(TIUFLD))
"RTN","TIUCPFIX",104,0)
 . . . I +TIUREQ,TIUARR(TIUFLD)="" S TIUARR(TIUFLD)="** REQUIRED FIELD MISSING FROM UPLOAD **"
"RTN","TIUCPFIX",105,0)
 . . . I $S(TIUFLD=.01:1,TIUFLD=.02:1,TIUFLD=.07:1,TIUFLD=1301:1,1:0) K TIUARR(TIUFLD)
"RTN","TIUCPFIX",106,0)
 . . I TIULINE[TIUBGN D
"RTN","TIUCPFIX",107,0)
 . . . N TIUJ S TIUJ=0
"RTN","TIUCPFIX",108,0)
 . . . F  D  Q:+TIUI'>0
"RTN","TIUCPFIX",109,0)
 . . . . S TIUI=$O(^TIU(8925.2,+TIUBUF,"TEXT",TIUI)) Q:+TIUI'>0
"RTN","TIUCPFIX",110,0)
 . . . . S TIUJ=TIUJ+1
"RTN","TIUCPFIX",111,0)
 . . . . S TIUARR("TEXT",TIUJ,0)=$G(^TIU(8925.2,+TIUBUF,"TEXT",TIUI,0))
"RTN","TIUCPFIX",112,0)
 Q
"RTN","TIUCPFIX",113,0)
STUFREC(DA,DFN,PARENT,TIU,TIUPSC,TIUDTP,TIUPLDA) ; Stuff fixed field data
"RTN","TIUCPFIX",114,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG,TIURDT,TIUPSCI,TIUDTPI
"RTN","TIUCPFIX",115,0)
 S IENS=""""_DA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS="K"
"RTN","TIUCPFIX",116,0)
 I +$G(PARENT)'>0 D
"RTN","TIUCPFIX",117,0)
 . I '$G(TIUPLDA) D
"RTN","TIUCPFIX",118,0)
 . . S @FDARR@(.02)=$G(DFN),@FDARR@(.03)=$P($G(TIU("VISIT")),U)
"RTN","TIUCPFIX",119,0)
 . . S @FDARR@(.07)=$P(TIU("EDT"),U)
"RTN","TIUCPFIX",120,0)
 . . S @FDARR@(1401)=$P($G(TIU("AD#")),U),@FDARR@(1402)=$P($G(TIU("TS")),U)
"RTN","TIUCPFIX",121,0)
 . . S @FDARR@(1201)=$$NOW^TIULC
"RTN","TIUCPFIX",122,0)
 . . S @FDARR@(1205)=$S(+$P($G(TIU("LOC")),U):$P($G(TIU("LOC")),U),1:$P($G(TIU("VLOC")),U))
"RTN","TIUCPFIX",123,0)
 . . S @FDARR@(1404)=$P($G(TIU("SVC")),U)
"RTN","TIUCPFIX",124,0)
 . S @FDARR@(.05)=$S(+$$REQVER(+$P($G(TIUDPRM(0)),U,3)):4,1:5)
"RTN","TIUCPFIX",125,0)
 . S @FDARR@(.08)=$P(TIU("LDT"),U)
"RTN","TIUCPFIX",126,0)
 I +$G(PARENT)>0 D
"RTN","TIUCPFIX",127,0)
 . S @FDARR@(.02)=+$P(^TIU(8925,+PARENT,0),U,2)
"RTN","TIUCPFIX",128,0)
 . S @FDARR@(.03)=$P(^TIU(8925,+PARENT,0),U,3)
"RTN","TIUCPFIX",129,0)
 . S @FDARR@(.05)=$S(+$$REQVER(+$P($G(TIUDPRM(0)),U,3)):4,1:5)
"RTN","TIUCPFIX",130,0)
 . S @FDARR@(.06)=PARENT
"RTN","TIUCPFIX",131,0)
 . S @FDARR@(.07)=$P($G(TIU("EDT")),U),@FDARR@(.08)=$P($G(TIU("LDT")),U)
"RTN","TIUCPFIX",132,0)
 . S @FDARR@(1205)=$P($G(^TIU(8925,+PARENT,12)),U,5)
"RTN","TIUCPFIX",133,0)
 . S @FDARR@(1401)=$P($G(^TIU(8925,+PARENT,14)),U)
"RTN","TIUCPFIX",134,0)
 . S @FDARR@(1402)=$P($G(^TIU(8925,+PARENT,14)),U,2)
"RTN","TIUCPFIX",135,0)
 . S @FDARR@(1404)=$P($G(^TIU(8925,+PARENT,14)),U,4)
"RTN","TIUCPFIX",136,0)
 . S @FDARR@(1201)=$$NOW^XLFDT
"RTN","TIUCPFIX",137,0)
 I +$G(TIU("LDT")) S TIURDT=+$G(TIU("LDT"))
"RTN","TIUCPFIX",138,0)
 I +$G(TIU("LDT"))'>0 D
"RTN","TIUCPFIX",139,0)
 . S TIUDICDT=+$$IDATE^TIULC($G(TIUDICDT))
"RTN","TIUCPFIX",140,0)
 . I +TIUDICDT,($P(TIUDICDT,".",2)'>0) D
"RTN","TIUCPFIX",141,0)
 . . S TIUDICDT=$S($P(TIU("VSTR"),";",3)'="H":$P($G(TIU("EDT")),U),1:"")
"RTN","TIUCPFIX",142,0)
 . S TIURDT=$S(+$G(TIUDICDT)>0:+$G(TIUDICDT),1:+$$NOW^TIULC)
"RTN","TIUCPFIX",143,0)
 . S:+$G(TIUTYPE)=1 @FDARR@(.12)=1
"RTN","TIUCPFIX",144,0)
 . K TIUDICDT
"RTN","TIUCPFIX",145,0)
 I '$G(TIUPLDA) S @FDARR@(1301)=TIURDT
"RTN","TIUCPFIX",146,0)
 S @FDARR@(1303)="U"
"RTN","TIUCPFIX",147,0)
 I $G(TIUPSC)]"" D VAL^DIE(8925,DA,70201,,TIUPSC,.TIUPSCI)
"RTN","TIUCPFIX",148,0)
 S @FDARR@(70201)=$S($G(TIUPSCI):TIUPSCI,1:"")
"RTN","TIUCPFIX",149,0)
 I '$G(TIUPLDA)!($P($G(^TIU(8925,+$G(TIUPLDA),702)),U,2))="" D
"RTN","TIUCPFIX",150,0)
 . I $G(TIUDTP)]"" D VAL^DIE(8925,DA,70202,,TIUDTP,.TIUDTPI)
"RTN","TIUCPFIX",151,0)
 . S @FDARR@(70202)=$S($G(TIUDTPI):TIUDTPI,1:"")
"RTN","TIUCPFIX",152,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG")
"RTN","TIUCPFIX",153,0)
 Q
"RTN","TIUCPFIX",154,0)
REQVER(VPARM) ; Evaluate whether verification is required
"RTN","TIUCPFIX",155,0)
 Q $S(VPARM=1:1,VPARM=2:1,1:0)
"RTN","TIUCPFIX",156,0)
MAKEADD(TIUDADD,TIUDA,TIUBUF) ; Create an addendum record
"RTN","TIUCPFIX",157,0)
 N DIE,DR,DA,DIC,X,Y,DLAYGO,TIUATYP,TIUCAN,TIUFPRIV,TIU,TIUX S TIUFPRIV=1
"RTN","TIUCPFIX",158,0)
 N TIUDTTL,TIUPOST,TIUREC
"RTN","TIUCPFIX",159,0)
 S TIUDTTL=+$G(^TIU(8925,+TIUDA,0))
"RTN","TIUCPFIX",160,0)
 S TIUATYP=+$$WHATITLE^TIUPUTU("ADDENDUM")
"RTN","TIUCPFIX",161,0)
 S (DIC,DLAYGO)=8925,DIC(0)="L",X=""""_"`"_TIUATYP_""""
"RTN","TIUCPFIX",162,0)
 D ^DIC
"RTN","TIUCPFIX",163,0)
 S TIUDADD=+Y
"RTN","TIUCPFIX",164,0)
 I +Y'>0 S TIUDADD=TIUDADD_"^Could not create addendum." Q
"RTN","TIUCPFIX",165,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUCPFIX",166,0)
 S TIU("DOCTYP")=TIUATYP_U_$$PNAME^TIULC1(TIUATYP)
"RTN","TIUCPFIX",167,0)
 D STUFREC(TIUDADD,DFN,+TIUDA,.TIU)
"RTN","TIUCPFIX",168,0)
 D LOADTIUX(.TIUX,TIUBUF)
"RTN","TIUCPFIX",169,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUCPFIX",170,0)
 M ^TIU(8925,+TIUDADD,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUCPFIX",171,0)
 D FILE(.SUCCESS,+TIUDADD,.TIUX,TIUATYP)
"RTN","TIUCPFIX",172,0)
 D MERGTEXT^TIUEDI1(+TIUDADD,.TIU)
"RTN","TIUCPFIX",173,0)
 S TIUPOST=$$POSTFILE^TIULC1(TIUDTTL)
"RTN","TIUCPFIX",174,0)
 S TIUREC("#")=TIUDADD
"RTN","TIUCPFIX",175,0)
 I TIUPOST]"" X TIUPOST
"RTN","TIUCPFIX",176,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUCPFIX",177,0)
 Q
"RTN","TIUCPFIX",178,0)
FILE(SUCCESS,TIUDA,TIUX,RTYPE) ; Call FM Filer to commit updates to DB
"RTN","TIUCPFIX",179,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG
"RTN","TIUCPFIX",180,0)
 S IENS=""""_TIUDA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS="KE"
"RTN","TIUCPFIX",181,0)
 M @FDARR=TIUX
"RTN","TIUCPFIX",182,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG") ; File record
"RTN","TIUCPFIX",183,0)
 I $D(TIUMSG)>9 D
"RTN","TIUCPFIX",184,0)
 . S SUCCESS=0_U_$G(TIUMSG("DIERR",1,"TEXT",1))
"RTN","TIUCPFIX",185,0)
 . D MAIN^TIUPEVNT(TIUBUF,2,"",$P($G(^TIU(8925.1,+RTYPE,0)),U),.FDA,.TIUMSG)
"RTN","TIUCPFIX",186,0)
 E  S SUCCESS=TIUDA
"RTN","TIUCPFIX",187,0)
 Q
"RTN","TIUCPFIX",188,0)
TRNSFRM(RTYPE,FLD,X) ; Executes Transform code for a given header field
"RTN","TIUCPFIX",189,0)
 N XFORM
"RTN","TIUCPFIX",190,0)
 S FLD=$O(^TIU(8925.1,+RTYPE,"HEAD","D",+FLD,0))
"RTN","TIUCPFIX",191,0)
 I +FLD'>0 G TRNSFRMX
"RTN","TIUCPFIX",192,0)
 S XFORM=$G(^TIU(8925.1,+RTYPE,"HEAD",+FLD,1))
"RTN","TIUCPFIX",193,0)
 I XFORM']"" G TRNSFRMX
"RTN","TIUCPFIX",194,0)
 X XFORM
"RTN","TIUCPFIX",195,0)
TRNSFRMX Q X
"RTN","TIUPEFIX")
0^3^B39777414
"RTN","TIUPEFIX",1,0)
TIUPEFIX ; SLC/JER - Resolve Filing errors for TIU Documents ;10/27/00
"RTN","TIUPEFIX",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**1,21,100,167**;Jun 20, 1997
"RTN","TIUPEFIX",3,0)
MAKE(SUCCESS,DFN,TITLE,TIU,TIUBUF) ; File new TIU Document
"RTN","TIUPEFIX",4,0)
 ; SUCCESS = (by ref) SUCCESS Returns TIU DOCUMENT # (PTR to 8925)
"RTN","TIUPEFIX",5,0)
 ;         = 0^Explanatory message if no SUCCESS
"RTN","TIUPEFIX",6,0)
 ; DFN     = Patient (#2)
"RTN","TIUPEFIX",7,0)
 ; TITLE   = Pointer to TIU Document Definition (#8925.1)
"RTN","TIUPEFIX",8,0)
 ; TIU     = Array of demographic and visit attributes
"RTN","TIUPEFIX",9,0)
 ; TIUBUF  = Record number (ien) of entry in TIU Buffer file (#8925.2)
"RTN","TIUPEFIX",10,0)
 ;
"RTN","TIUPEFIX",11,0)
 ; -- first, get TIU Document record --
"RTN","TIUPEFIX",12,0)
 ;
"RTN","TIUPEFIX",13,0)
 N TIUDA,LDT,NEWREC,TIUX,TIUTYP,TIUDPRM,HAPPY,TIUCLASS,TIUDTYP,TIUPOST
"RTN","TIUPEFIX",14,0)
 N TIUDFLT,TIUREC
"RTN","TIUPEFIX",15,0)
 S SUCCESS=0 ; Initialize SUCCESS to false
"RTN","TIUPEFIX",16,0)
 I $S($D(TIU)'>9:1,+$G(DFN)'>0:1,+$G(TIUTYPE)'>0:1,1:0) S SUCCESS="0^"_$$EZBLD^DIALOG(89250001) Q
"RTN","TIUPEFIX",17,0)
 ; If target file is not 8925 QUIT
"RTN","TIUPEFIX",18,0)
 I +$G(^TIU(8925.1,+TIUTYPE,1))'=8925 Q
"RTN","TIUPEFIX",19,0)
 S TIUDTYP=$P($G(^TIU(8925.1,+TIUTYPE,0)),U,4)
"RTN","TIUPEFIX",20,0)
 S TIUCLASS=$S(TIUDTYP="CL":+TIUTYPE,1:38)
"RTN","TIUPEFIX",21,0)
 S TIUDFLT=$S(TIUCLASS'=TIUTYPE:TIUTYPE,1:"")
"RTN","TIUPEFIX",22,0)
 I +$G(TITLE)'>0 S TITLE=$$ASKTITLE^TIULA3(TIUCLASS,TIUDFLT)
"RTN","TIUPEFIX",23,0)
 Q:+TITLE'>0
"RTN","TIUPEFIX",24,0)
 S TIUTYP=TITLE,TIUTYP(1)=1_U_TITLE
"RTN","TIUPEFIX",25,0)
 D DOCPRM^TIULC1(TITLE,.TIUDPRM)
"RTN","TIUPEFIX",26,0)
 ;S TIUDA=$$GETREC^TIUEDI1(DFN,.TIU,1,.NEWREC,.TIUDPRM) ;10/27/00
"RTN","TIUPEFIX",27,0)
 S TIUDA=$$GETRECNW^TIUEDI3(DFN,.TIU,TIUTYP(1),.NEWREC,.TIUDPRM)
"RTN","TIUPEFIX",28,0)
 I +TIUDA'>0 S SUCCESS="0^"_$$EZBLD^DIALOG(89250002) Q
"RTN","TIUPEFIX",29,0)
 I +$$CANEDIT^TIUPUTU(TIUDA)'>0 D  G MAKEX
"RTN","TIUPEFIX",30,0)
 . D MAKEADD(.TIUADD,+TIUDA,TIUBUF) S SUCCESS=TIUADD
"RTN","TIUPEFIX",31,0)
 S SUCCESS=1
"RTN","TIUPEFIX",32,0)
 ;
"RTN","TIUPEFIX",33,0)
 ; -- second, load the header elements & text into TIUX array
"RTN","TIUPEFIX",34,0)
 ;
"RTN","TIUPEFIX",35,0)
 D STUFREC(TIUDA,$G(DFN),,.TIU)
"RTN","TIUPEFIX",36,0)
 D LOADTIUX(.TIUX,TIUBUF)
"RTN","TIUPEFIX",37,0)
 ;
"RTN","TIUPEFIX",38,0)
 ; -- third, file the data in TIU Document record --
"RTN","TIUPEFIX",39,0)
 ;
"RTN","TIUPEFIX",40,0)
 K ^TIU(8925,+TIUDA,"TEMP"),TIUX(.01),TIUX(.02),TIUX(.03),TIUX(.05)
"RTN","TIUPEFIX",41,0)
 K TIUX(.13),TIUX(1205),TIUX(1211)
"RTN","TIUPEFIX",42,0)
 M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUPEFIX",43,0)
 D FILE(.HAPPY,+TIUDA,.TIUX,TIUTYP)
"RTN","TIUPEFIX",44,0)
 D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUPEFIX",45,0)
 S TIUPOST=$$POSTFILE^TIULC1(TITLE)
"RTN","TIUPEFIX",46,0)
 S TIUREC("#")=TIUDA
"RTN","TIUPEFIX",47,0)
 I TIUPOST]"" X TIUPOST
"RTN","TIUPEFIX",48,0)
MAKEX D ALERTDEL^TIUPEVNT(+TIUBUF)
"RTN","TIUPEFIX",49,0)
 D RESOLVE^TIUPEVNT($S($D(XQADATA):+$P(XQADATA,";",3),1:$G(ERRDA)),1)
"RTN","TIUPEFIX",50,0)
 D BUFPURGE^TIUPUTC(+TIUBUF)
"RTN","TIUPEFIX",51,0)
 K ^TIU(8925,+TIUDA,"TEMP") W "Done."
"RTN","TIUPEFIX",52,0)
 I +$G(TIUDA),+$D(^TIU(8925,+$G(TIUDA),0)) D
"RTN","TIUPEFIX",53,0)
 . N TIU D GETTIU^TIULD(.TIU,+TIUDA)
"RTN","TIUPEFIX",54,0)
 . D EN^VALM("TIU BROWSE FOR MRT")
"RTN","TIUPEFIX",55,0)
 Q
"RTN","TIUPEFIX",56,0)
LOADTIUX(TIUARR,TIUBUF) ; Load TIUX array with header and text
"RTN","TIUPEFIX",57,0)
 N TIUI,TIUHSIG,TIUBGN,TIULINE,X,Y,TYPE I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIUPEFIX",58,0)
 S TIUHSIG=$P(TIUPRM0,U,10),TIUBGN=$P(TIUPRM0,U,12)
"RTN","TIUPEFIX",59,0)
 S TIUI=0 F  S TIUI=$O(^TIU(8925.2,+TIUBUF,"TEXT",TIUI)) Q:+TIUI'>0  D
"RTN","TIUPEFIX",60,0)
 . S TIULINE=$G(^TIU(8925.2,+TIUBUF,"TEXT",TIUI,0))
"RTN","TIUPEFIX",61,0)
 . I TIULINE[TIUHSIG D
"RTN","TIUPEFIX",62,0)
 . . N TIUD1,TIUD4
"RTN","TIUPEFIX",63,0)
 . . S X=$$STRIP^TIULS($P(TIULINE,":",2)),Y=$$WHATYPE^TIUPUTU(X)
"RTN","TIUPEFIX",64,0)
 . . I +Y'>0 D MAIN^TIUPEVNT(TIUBUF,1,3,X) Q
"RTN","TIUPEFIX",65,0)
 . . S TIUD1=$G(^TIU(8925.1,+Y,1)),TIUD4=$G(^TIU(8925.1,+Y,4))
"RTN","TIUPEFIX",66,0)
 . . S TYPE=+Y
"RTN","TIUPEFIX",67,0)
 . . F  D  Q:TIULINE[TIUBGN!(+TIUI'>0)
"RTN","TIUPEFIX",68,0)
 . . . N TIUN,TIUCAP,TIUFLD,TIUREQ S TIUREQ=0
"RTN","TIUPEFIX",69,0)
 . . . S TIUI=$O(^TIU(8925.2,+TIUBUF,"TEXT",TIUI)) Q:+TIUI'>0
"RTN","TIUPEFIX",70,0)
 . . . S TIULINE=$G(^TIU(8925.2,+TIUBUF,"TEXT",TIUI,0)) Q:TIULINE[TIUBGN
"RTN","TIUPEFIX",71,0)
 . . . S TIUCAP=$P(TIULINE,":") Q:TIUCAP']""
"RTN","TIUPEFIX",72,0)
 . . . S TIUN=$O(^TIU(8925.1,+TYPE,"HEAD","B",TIUCAP,0))
"RTN","TIUPEFIX",73,0)
 . . . Q:+TIUN'>0
"RTN","TIUPEFIX",74,0)
 . . . S TIUFLD=$P(^TIU(8925.1,+TYPE,"HEAD",+TIUN,0),U,3)
"RTN","TIUPEFIX",75,0)
 . . . Q:TIUFLD']""
"RTN","TIUPEFIX",76,0)
 . . . S TIUREQ=$P(^TIU(8925.1,+TYPE,"HEAD",+TIUN,0),U,7)
"RTN","TIUPEFIX",77,0)
 . . . S TIUARR(TIUFLD)=$$STRIP^TIULS($P(TIULINE,":",2,99))
"RTN","TIUPEFIX",78,0)
 . . . S:TIUFLD'=.001 TIUARR(TIUFLD)=$$TRNSFRM(+TYPE,TIUFLD,TIUARR(TIUFLD))
"RTN","TIUPEFIX",79,0)
 . . . I +TIUREQ,TIUARR(TIUFLD)="" S TIUARR(TIUFLD)="** REQUIRED FIELD MISSING FROM UPLOAD **"
"RTN","TIUPEFIX",80,0)
 . . . I $S(TIUFLD=.01:1,TIUFLD=.02:1,TIUFLD=.07:1,TIUFLD=1301:1,1:0) K TIUARR(TIUFLD)
"RTN","TIUPEFIX",81,0)
 . . I TIULINE[TIUBGN D
"RTN","TIUPEFIX",82,0)
 . . . N TIUJ S TIUJ=0
"RTN","TIUPEFIX",83,0)
 . . . F  D  Q:+TIUI'>0
"RTN","TIUPEFIX",84,0)
 . . . . S TIUI=$O(^TIU(8925.2,+TIUBUF,"TEXT",TIUI)) Q:+TIUI'>0
"RTN","TIUPEFIX",85,0)
 . . . . S TIUJ=TIUJ+1
"RTN","TIUPEFIX",86,0)
 . . . . S TIUARR("TEXT",TIUJ,0)=$G(^TIU(8925.2,+TIUBUF,"TEXT",TIUI,0))
"RTN","TIUPEFIX",87,0)
 Q
"RTN","TIUPEFIX",88,0)
STUFREC(DA,DFN,PARENT,TIU) ; Stuff fixed field data
"RTN","TIUPEFIX",89,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG,TIURDT
"RTN","TIUPEFIX",90,0)
 S IENS=""""_DA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS="K"
"RTN","TIUPEFIX",91,0)
 I +$G(PARENT)'>0 D
"RTN","TIUPEFIX",92,0)
 . S @FDARR@(.02)=$G(DFN),@FDARR@(.03)=$P($G(TIU("VISIT")),U)
"RTN","TIUPEFIX",93,0)
 . S @FDARR@(.05)=$S(+$$REQVER(+$P($G(TIUDPRM(0)),U,3)):4,1:5)
"RTN","TIUPEFIX",94,0)
 . S @FDARR@(.07)=$P(TIU("EDT"),U)
"RTN","TIUPEFIX",95,0)
 . S @FDARR@(.08)=$P(TIU("LDT"),U),@FDARR@(1401)=$P($G(TIU("AD#")),U)
"RTN","TIUPEFIX",96,0)
 . S @FDARR@(1402)=$P($G(TIU("TS")),U),@FDARR@(1201)=$$NOW^TIULC
"RTN","TIUPEFIX",97,0)
 . S @FDARR@(1205)=$S(+$P($G(TIU("LOC")),U):$P($G(TIU("LOC")),U),1:$P($G(TIU("VLOC")),U))
"RTN","TIUPEFIX",98,0)
 . S @FDARR@(1404)=$P($G(TIU("SVC")),U)
"RTN","TIUPEFIX",99,0)
 I +$G(PARENT)>0 D
"RTN","TIUPEFIX",100,0)
 . S @FDARR@(.02)=+$P(^TIU(8925,+PARENT,0),U,2)
"RTN","TIUPEFIX",101,0)
 . S @FDARR@(.03)=$P(^TIU(8925,+PARENT,0),U,3)
"RTN","TIUPEFIX",102,0)
 . S @FDARR@(.05)=$S(+$$REQVER(+$P($G(TIUDPRM(0)),U,3)):4,1:5)
"RTN","TIUPEFIX",103,0)
 . S @FDARR@(.06)=PARENT
"RTN","TIUPEFIX",104,0)
 . S @FDARR@(.07)=$P($G(TIU("EDT")),U),@FDARR@(.08)=$P($G(TIU("LDT")),U)
"RTN","TIUPEFIX",105,0)
 . S @FDARR@(1205)=$P($G(^TIU(8925,+PARENT,12)),U,5)
"RTN","TIUPEFIX",106,0)
 . S @FDARR@(1401)=$P($G(^TIU(8925,+PARENT,14)),U)
"RTN","TIUPEFIX",107,0)
 . S @FDARR@(1402)=$P($G(^TIU(8925,+PARENT,14)),U,2)
"RTN","TIUPEFIX",108,0)
 . S @FDARR@(1404)=$P($G(^TIU(8925,+PARENT,14)),U,4)
"RTN","TIUPEFIX",109,0)
 S @FDARR@(1201)=$$NOW^XLFDT
"RTN","TIUPEFIX",110,0)
 I +$G(TIU("LDT")) S TIURDT=+$G(TIU("LDT"))
"RTN","TIUPEFIX",111,0)
 I +$G(TIU("LDT"))'>0 D
"RTN","TIUPEFIX",112,0)
 . S TIUDICDT=+$$IDATE^TIULC($G(TIUDICDT))
"RTN","TIUPEFIX",113,0)
 . I +TIUDICDT,($P(TIUDICDT,".",2)'>0) D
"RTN","TIUPEFIX",114,0)
 . . S TIUDICDT=$S($P(TIU("VSTR"),";",3)'="H":$P($G(TIU("EDT")),U),1:"")
"RTN","TIUPEFIX",115,0)
 . S TIURDT=$S(+$G(TIUDICDT)>0:+$G(TIUDICDT),1:+$$NOW^TIULC)
"RTN","TIUPEFIX",116,0)
 . S:+$G(TIUTYPE)=1 @FDARR@(.12)=1
"RTN","TIUPEFIX",117,0)
 . K TIUDICDT
"RTN","TIUPEFIX",118,0)
 S @FDARR@(1301)=TIURDT,@FDARR@(1303)="U"
"RTN","TIUPEFIX",119,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG")
"RTN","TIUPEFIX",120,0)
 Q
"RTN","TIUPEFIX",121,0)
REQVER(VPARM) ; Evaluate whether verification is required
"RTN","TIUPEFIX",122,0)
 Q $S(VPARM=1:1,VPARM=2:1,1:0)
"RTN","TIUPEFIX",123,0)
MAKEADD(TIUDADD,TIUDA,TIUBUF) ; Create an addendum record
"RTN","TIUPEFIX",124,0)
 N DIE,DR,DA,DIC,X,Y,DLAYGO,TIUATYP,TIUCAN,TIUFPRIV,TIU,TIUX S TIUFPRIV=1
"RTN","TIUPEFIX",125,0)
 N TIUDTTL,TIUPOST,TIUREC
"RTN","TIUPEFIX",126,0)
 S TIUDTTL=+$G(^TIU(8925,+TIUDA,0))
"RTN","TIUPEFIX",127,0)
 S TIUATYP=+$$WHATITLE^TIUPUTU("ADDENDUM")
"RTN","TIUPEFIX",128,0)
 S (DIC,DLAYGO)=8925,DIC(0)="L",X=""""_"`"_TIUATYP_""""
"RTN","TIUPEFIX",129,0)
 D ^DIC
"RTN","TIUPEFIX",130,0)
 S TIUDADD=+Y
"RTN","TIUPEFIX",131,0)
 I +Y'>0 S TIUDADD=TIUDADD_"^Could not create addendum." Q
"RTN","TIUPEFIX",132,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUPEFIX",133,0)
 S TIU("DOCTYP")=TIUATYP_U_$$PNAME^TIULC1(TIUATYP)
"RTN","TIUPEFIX",134,0)
 D STUFREC(TIUDADD,DFN,+TIUDA,.TIU)
"RTN","TIUPEFIX",135,0)
 D LOADTIUX(.TIUX,TIUBUF)
"RTN","TIUPEFIX",136,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUPEFIX",137,0)
 M ^TIU(8925,+TIUDADD,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUPEFIX",138,0)
 D FILE(.SUCCESS,+TIUDADD,.TIUX,TIUATYP)
"RTN","TIUPEFIX",139,0)
 D MERGTEXT^TIUEDI1(+TIUDADD,.TIU)
"RTN","TIUPEFIX",140,0)
 S TIUPOST=$$POSTFILE^TIULC1(TIUDTTL)
"RTN","TIUPEFIX",141,0)
 S TIUREC("#")=TIUDADD
"RTN","TIUPEFIX",142,0)
 I TIUPOST]"" X TIUPOST
"RTN","TIUPEFIX",143,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUPEFIX",144,0)
 Q
"RTN","TIUPEFIX",145,0)
FILE(SUCCESS,TIUDA,TIUX,RTYPE) ; Call FM Filer to commit updates to DB
"RTN","TIUPEFIX",146,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG
"RTN","TIUPEFIX",147,0)
 S IENS=""""_TIUDA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS="KE"
"RTN","TIUPEFIX",148,0)
 M @FDARR=TIUX
"RTN","TIUPEFIX",149,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG") ; File record
"RTN","TIUPEFIX",150,0)
 I $D(TIUMSG)>9 D
"RTN","TIUPEFIX",151,0)
 . S SUCCESS=0_U_$G(TIUMSG(1,"TEXT",1))
"RTN","TIUPEFIX",152,0)
 . D MAIN^TIUPEVNT(TIUBUF,2,"",$P($G(^TIU(8925.1,+RTYPE,0)),U),.FDA,.TIUMSG)
"RTN","TIUPEFIX",153,0)
 E  S SUCCESS=TIUDA
"RTN","TIUPEFIX",154,0)
 Q
"RTN","TIUPEFIX",155,0)
TRNSFRM(RTYPE,FLD,X) ; Executes Transform code for a given header field
"RTN","TIUPEFIX",156,0)
 N XFORM
"RTN","TIUPEFIX",157,0)
 S FLD=$O(^TIU(8925.1,+RTYPE,"HEAD","D",+FLD,0))
"RTN","TIUPEFIX",158,0)
 I +FLD'>0 G TRNSFRMX
"RTN","TIUPEFIX",159,0)
 S XFORM=$G(^TIU(8925.1,+RTYPE,"HEAD",+FLD,1))
"RTN","TIUPEFIX",160,0)
 I XFORM']"" G TRNSFRMX
"RTN","TIUPEFIX",161,0)
 X XFORM
"RTN","TIUPEFIX",162,0)
TRNSFRMX Q X
"RTN","TIUSRVP")
0^1^B62308440
"RTN","TIUSRVP",1,0)
TIUSRVP ; SLC/JER - RPCs for CREATE & UPDATE ;17-OCT-2001 09:21:50
"RTN","TIUSRVP",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**1,7,19,28,47,89,104,100,115,109,167**;Jun 20, 1997
"RTN","TIUSRVP",3,0)
MAKE(SUCCESS,DFN,TITLE,VDT,VLOC,VSIT,TIUX,VSTR,SUPPRESS,NOASF) ; New Document
"RTN","TIUSRVP",4,0)
 ; moved comments to TIUSRVP1
"RTN","TIUSRVP",5,0)
 ; -- first, get visit record and demographics (if not provided) --
"RTN","TIUSRVP",6,0)
 N TIU,TIUDA,LDT,NEWREC S SUCCESS=0
"RTN","TIUSRVP",7,0)
 I +$G(VSIT) S VSTR=$$VSTRBLD(+VSIT)
"RTN","TIUSRVP",8,0)
 I $L($G(VSTR)) D
"RTN","TIUSRVP",9,0)
 . S VDT=$S(+$G(VDT):+$G(VDT),1:$P(VSTR,";",2)),LDT=$S(+$G(VDT):$$FMADD^XLFDT(VDT,"","",1),1:"")
"RTN","TIUSRVP",10,0)
 . S VLOC=$S(+$G(VLOC):+$G(VLOC),1:$P(VSTR,";"))
"RTN","TIUSRVP",11,0)
 . ; If the note is for a Ward Location, call MAIN^TIUMOVE
"RTN","TIUSRVP",12,0)
 . I $P($G(^SC(+VLOC,0)),U,3)="W" D MAIN^TIUMOVE(.TIU,DFN,"",VDT,LDT,1,"LAST",0,+VLOC) Q
"RTN","TIUSRVP",13,0)
 . ; Otherwise, call PATVADPT^TIULV
"RTN","TIUSRVP",14,0)
 . D PATVADPT^TIULV(.TIU,DFN,"",VSTR)
"RTN","TIUSRVP",15,0)
 I '+$G(VSIT),'$L($G(VSTR)),+$G(VDT),+$G(VLOC) D
"RTN","TIUSRVP",16,0)
 . S VDT=$G(VDT),LDT=$S(+$G(VDT):$$FMADD^XLFDT(VDT,"","",1),1:"")
"RTN","TIUSRVP",17,0)
 . ; If the note is for a Ward Location, call MAIN^TIUMOVE
"RTN","TIUSRVP",18,0)
 . I $P($G(^SC(+VLOC,0)),U,3)="W" D MAIN^TIUMOVE(.TIU,DFN,"",VDT,LDT,1,"LAST",0,+VLOC) Q
"RTN","TIUSRVP",19,0)
 . ; Otherwise, call MAIN^TIUVSIT
"RTN","TIUSRVP",20,0)
 . D MAIN^TIUVSIT(.TIU,DFN,"",VDT,LDT,"LAST",0,VLOC)
"RTN","TIUSRVP",21,0)
 I '+$G(TIU("VSTR")) D
"RTN","TIUSRVP",22,0)
 . D EVENT^TIUSRVP1(.TIU,DFN)
"RTN","TIUSRVP",23,0)
 I $S($D(TIU)'>9:1,+$G(DFN)'>0:1,1:0) S SUCCESS="0^"_$$EZBLD^DIALOG(89250001) Q
"RTN","TIUSRVP",24,0)
 ; -- second, get/create TIU Document record --
"RTN","TIUSRVP",25,0)
 S TIUDA=$$GETREC(DFN,.TIU,TITLE,.NEWREC) I +TIUDA'>0 S SUCCESS="0^"_$$EZBLD^DIALOG(89250002) Q
"RTN","TIUSRVP",26,0)
 S SUCCESS=+TIUDA
"RTN","TIUSRVP",27,0)
 ; -- third, file data in TIU Document record --
"RTN","TIUSRVP",28,0)
 D STUFREC^TIUSRVP1(+TIUDA,.TIUX,DFN,,TITLE,.TIU)
"RTN","TIUSRVP",29,0)
 S:'+$G(NOASF) ^TIU(8925,"ASAVE",DUZ,TIUDA)=""
"RTN","TIUSRVP",30,0)
 K ^TIU(8925,+TIUDA,"TEMP") M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUSRVP",31,0)
 D SETXT0(TIUDA),FILE(.SUCCESS,+TIUDA,.TIUX,+$G(SUPPRESS))
"RTN","TIUSRVP",32,0)
 I +SUCCESS'>0 D DIK^TIURB2(TIUDA) Q
"RTN","TIUSRVP",33,0)
 I +$O(^TIU(8925,+TIUDA,"TEMP",0)) D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVP",34,0)
 I +$G(TIU("STOP")) D DEFER^TIUVSIT(TIUDA,TIU("STOP")) I 1
"RTN","TIUSRVP",35,0)
 E  D QUE^TIUPXAP1
"RTN","TIUSRVP",36,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",37,0)
 . D RELEASE^TIUT(TIUDA,1),UPDTIRT^TIUDIRT(.TIU,TIUDA)
"RTN","TIUSRVP",38,0)
 K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",39,0)
 Q
"RTN","TIUSRVP",40,0)
VSTRBLD(VSIT) ; Given a Visit Record, build Visit-Descriptor String
"RTN","TIUSRVP",41,0)
 N TIUY,VSIT0,VLOC,VDT,VSVCAT
"RTN","TIUSRVP",42,0)
 S VSIT0=$G(^AUPNVSIT(+VSIT,0)),VDT=+$P(VSIT0,U),VLOC=+$P(VSIT0,U,22)
"RTN","TIUSRVP",43,0)
 S VSVCAT=$P(VSIT0,U,7),TIUY=VLOC_";"_VDT_";"_VSVCAT
"RTN","TIUSRVP",44,0)
 Q TIUY
"RTN","TIUSRVP",45,0)
SETXT0(TIUDA) ; Set root node of "TEMP" WP-field
"RTN","TIUSRVP",46,0)
 N TIUC,TIUI S (TIUC,TIUI)=0
"RTN","TIUSRVP",47,0)
 F  S TIUI=$O(^TIU(8925,TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVP",48,0)
 . S:$D(^TIU(8925,TIUDA,"TEMP",TIUI,0)) TIUC=TIUC+1
"RTN","TIUSRVP",49,0)
 S ^TIU(8925,TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVP",50,0)
 Q
"RTN","TIUSRVP",51,0)
MAKEADD(TIUDADD,TIUDA,TIUX,SUPPRESS) ; Create addendum record
"RTN","TIUSRVP",52,0)
 N DIE,DR,DA,DIC,X,Y,DLAYGO,TIUATYP,TIUCAN,TIUFPRIV,TIU S TIUFPRIV=1
"RTN","TIUSRVP",53,0)
 S TIUCAN=$$CANDO^TIULP(TIUDA,"MAKE ADDENDUM")
"RTN","TIUSRVP",54,0)
 I TIUCAN'>0 S TIUDADD="0^You may not MAKE AN ADDENDUM for this "_$$STATUS^TIULC(TIUDA)_" "_$$PNAME^TIULC1(+$G(^TIU(8925,+TIUDA,0))) Q
"RTN","TIUSRVP",55,0)
 S TIUATYP=+$$WHATITLE^TIUPUTU("ADDENDUM"),(DIC,DLAYGO)=8925,DIC(0)="L",X=""""_"`"_TIUATYP_""""
"RTN","TIUSRVP",56,0)
 D ^DIC S TIUDADD=+Y
"RTN","TIUSRVP",57,0)
 I +Y'>0 S TIUDADD=TIUDADD_"^Could not create addendum." Q
"RTN","TIUSRVP",58,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUSRVP",59,0)
 S TIU("DOCTYP")=TIUATYP_U_$$PNAME^TIULC1(TIUATYP)
"RTN","TIUSRVP",60,0)
 D STUFREC^TIUSRVP1(+TIUDADD,.TIUX,DFN,+$G(TIUDA),TIUATYP,.TIU)
"RTN","TIUSRVP",61,0)
 K ^TIU(8925,+TIUDADD,"TEMP") M ^TIU(8925,+TIUDADD,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUSRVP",62,0)
 D SETXT0(+TIUDADD),FILE(.SUCCESS,+TIUDADD,.TIUX,+$G(SUPPRESS))
"RTN","TIUSRVP",63,0)
 I +SUCCESS'>0 D DIK^TIURB2(TIUDADD) Q
"RTN","TIUSRVP",64,0)
 I +$O(^TIU(8925,+TIUDADD,"TEMP",0)) D MERGTEXT^TIUEDI1(+TIUDADD,.TIU)
"RTN","TIUSRVP",65,0)
 I '+$G(SUPPRESS) D RELEASE^TIUT(+TIUDADD,1)
"RTN","TIUSRVP",66,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUSRVP",67,0)
 Q
"RTN","TIUSRVP",68,0)
UPDATE(SUCCESS,TIUDA,TIUX,SUPPRESS) ; Update existing TIU Document
"RTN","TIUSRVP",69,0)
 N TIU,TIUI,TIUC,TIUD0,TIUD12,TIUD15,TIUCPF,TITLE
"RTN","TIUSRVP",70,0)
 I $S(+$G(TIUDA)'>0:1,'$D(^TIU(8925,+TIUDA,0)):1,1:0) D  Q
"RTN","TIUSRVP",71,0)
 . S SUCCESS="0^ Cannot update a non-existent document..."
"RTN","TIUSRVP",72,0)
 I +$P($G(^TIU(8925,+TIUDA,0)),U,5)>6 D  Q
"RTN","TIUSRVP",73,0)
 . S SUCCESS="0^ TIU Document #"_TIUDA_" is already signed..."
"RTN","TIUSRVP",74,0)
 I $D(TIUX("TEXT")) D
"RTN","TIUSRVP",75,0)
 . K ^TIU(8925,+TIUDA,"TEMP") M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT")
"RTN","TIUSRVP",76,0)
 . S (TIUC,TIUI)=0
"RTN","TIUSRVP",77,0)
 . F  S TIUI=$O(^TIU(8925,+TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVP",78,0)
 . . S TIUC=TIUC+1
"RTN","TIUSRVP",79,0)
 . I +TIUC>0 S ^TIU(8925,+TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVP",80,0)
 . K TIUX("TEXT")
"RTN","TIUSRVP",81,0)
 I +$O(TIUX(""))'>0 S:+$G(SUPPRESS) SUCCESS=+TIUDA Q
"RTN","TIUSRVP",82,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUD12=$G(^(12)),TITLE=+TIUD0
"RTN","TIUSRVP",83,0)
 ;Set a flag to indicate whether or not a Title is a member of the
"RTN","TIUSRVP",84,0)
 ;Clinical Procedures Class (1=Yes and 0=No)
"RTN","TIUSRVP",85,0)
 S TIUCPF=+$$ISA^TIULX(TITLE,+$$CLASS^TIUCP)
"RTN","TIUSRVP",86,0)
 D SETCOS(TIUDA,.TIUX,TIUD0,TIUD12)
"RTN","TIUSRVP",87,0)
 ; Title changed? Refile DC
"RTN","TIUSRVP",88,0)
 I +$G(TIUX(.01))>0,(+$G(TIUX(.01))'=+TIUD0) D
"RTN","TIUSRVP",89,0)
 . S TIUX(.04)=$$DOCCLASS^TIULC1(+$G(TIUX(.01)))
"RTN","TIUSRVP",90,0)
 D FILE(.SUCCESS,+TIUDA,.TIUX,+$G(SUPPRESS),TIUCPF)
"RTN","TIUSRVP",91,0)
 I +SUCCESS'>0 K ^TIU(8925,+TIUDA,"TEMP") Q
"RTN","TIUSRVP",92,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUSRVP",93,0)
 I $D(^TIU(8925,+TIUDA,"TEMP")) D
"RTN","TIUSRVP",94,0)
 . K ^TIU(8925,+TIUDA,"TEXT")
"RTN","TIUSRVP",95,0)
 . D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVP",96,0)
 . K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",97,0)
 . S:'+$G(SUCCESS) SUCCESS=+TIUDA
"RTN","TIUSRVP",98,0)
 ; If document is signed re-file /ES/
"RTN","TIUSRVP",99,0)
 S TIUD15=$G(^TIU(8925,+TIUDA,15))
"RTN","TIUSRVP",100,0)
 I +TIUD15 D
"RTN","TIUSRVP",101,0)
 . N TIUBY,DR,DIE,DA,X,Y S TIUBY=$P(TIUD15,U,2) Q:+TIUBY'>0
"RTN","TIUSRVP",102,0)
 . S DR="1503///^S X=$$SIGNAME^TIULS("_TIUBY_");1504///^S X=$$SIGTITL^TIULS("_TIUBY_")"
"RTN","TIUSRVP",103,0)
 . S DA=TIUDA,DIE=8925 D ^DIE
"RTN","TIUSRVP",104,0)
 ; Evaluate/send alerts
"RTN","TIUSRVP",105,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",106,0)
 . I +$P(TIUD0,U,5)<5,'$D(TIUX(.05)) D UPDSTAT(TIUDA,+$G(TIUD0))
"RTN","TIUSRVP",107,0)
 . D SEND^TIUALRT(TIUDA),SENDID^TIUALRT1(TIUDA):+$G(^TIU(8925,+TIUDA,21))
"RTN","TIUSRVP",108,0)
 . D UPDTIRT^TIUDIRT(.TIU,TIUDA)
"RTN","TIUSRVP",109,0)
 Q
"RTN","TIUSRVP",110,0)
SETCOS(TIUDA,TIUX,TIUD0,TIUD12) ; Evaluate/set cosig req
"RTN","TIUSRVP",111,0)
 N TIUDAD,TIUEXS,TIUNCS,TIUEXCS,TIURCS,TIUATT,TIUTTL,TIUDAD0
"RTN","TIUSRVP",112,0)
 S TIUEXS=$S(+$G(TIUX(1202)):+$G(TIUX(1202)),1:$P(TIUD12,U,4))
"RTN","TIUSRVP",113,0)
 S TIUNCS=$S(+$G(TIUX(1208)):+$G(TIUX(1208)),+$G(TIUX(1209)):+$G(TIUX(1209)),1:0)
"RTN","TIUSRVP",114,0)
 I TIUNCS S TIUX(1506)=$S(TIUNCS=TIUEXS:0,1:1) G SETCOSX
"RTN","TIUSRVP",115,0)
 S TIUEXCS=$P(TIUD12,U,8),TIUATT=$P(TIUD12,U,9)
"RTN","TIUSRVP",116,0)
 S TIUDAD=+$P(TIUD0,U,6),TIUDAD0=$G(^TIU(8925,+TIUDAD,0))
"RTN","TIUSRVP",117,0)
 I +$$ISDS^TIULX($S(+TIUDAD:+TIUDAD0,1:+TIUD0)) D  G SETCOSX
"RTN","TIUSRVP",118,0)
 . S TIUX(1506)=$S(TIUEXS=TIUEXCS:0,1:1)
"RTN","TIUSRVP",119,0)
 S TIUTTL=$S(+$G(TIUX(.01)):+$G(TIUX(.01)),1:+TIUD0)
"RTN","TIUSRVP",120,0)
 S TIUX(1506)=+$$REQCOSIG^TIULP(TIUTTL,TIUDA,TIUEXS)
"RTN","TIUSRVP",121,0)
SETCOSX S:'TIUX(1506) TIUX(1208)="@"
"RTN","TIUSRVP",122,0)
 Q
"RTN","TIUSRVP",123,0)
UPDSTAT(DA,TITLE) ; Update the status on commitment
"RTN","TIUSRVP",124,0)
 N DR,DIE S DR=".05////"_$$STATUS^TIUSRVP1(DA,0,TITLE)
"RTN","TIUSRVP",125,0)
 I '+$P($G(^TIU(8925,DA,13)),U,4) S DR=DR_";1304////^S X=$$NOW^XLFDT"
"RTN","TIUSRVP",126,0)
 S DIE=8925 D ^DIE
"RTN","TIUSRVP",127,0)
 Q
"RTN","TIUSRVP",128,0)
GETREC(DFN,TIU,TITLE,TIUNEW) ; Get or create document record
"RTN","TIUSRVP",129,0)
 N DA,DIC,DIE,DLAYGO,DR,X,Y,TIUDPRM,TIUFPRIV,TIUHIT,TIUSCAT
"RTN","TIUSRVP",130,0)
 S (TIUHIT,DA)=0,TIUFPRIV=1,(DIC,DLAYGO)=8925,DIC(0)="FL"
"RTN","TIUSRVP",131,0)
 ; S DIC("S")="I +$G(DFN)=+$P(^TIU(8925,+Y,0),U,2),(+$G(TIU(""VISIT""))=+$P(^TIU(8925,+Y,0),U,3))"
"RTN","TIUSRVP",132,0)
 S X=""""_"`"_+TITLE_"""" D ^DIC K DIC("S")
"RTN","TIUSRVP",133,0)
 I +Y'>0 Q Y_U_" Insufficient data to create a new record."
"RTN","TIUSRVP",134,0)
 S DA=+Y,TIUNEW=+$P(Y,U,3) N DIE,DR,TIUVISIT S DIE=8925
"RTN","TIUSRVP",135,0)
 S TIUVISIT=$S(+$G(TIU("VISIT")):+$G(TIU("VISIT")),1:"")
"RTN","TIUSRVP",136,0)
 S TIUSCAT=$S(+$L($P($G(TIU("CAT")),U)):$P($G(TIU("CAT")),U),+$L($P($G(TIU("VSTR")),";",3)):$P($G(TIU("VSTR")),";",3),1:"")
"RTN","TIUSRVP",137,0)
 S DR=".04////"_$$DOCCLASS^TIULC1(+$P(Y,U,2))_";.13////"_TIUSCAT_";1205////"_$P($G(TIU("LOC")),U)_";1211////"_$P($G(TIU("VLOC")),U)
"RTN","TIUSRVP",138,0)
 D ^DIE
"RTN","TIUSRVP",139,0)
 Q +$G(DA)
"RTN","TIUSRVP",140,0)
FILE(SUCCESS,TIUDA,TIUX,SUPPRESS,TIUCPF) ; Call FM Filer & commit updates
"RTN","TIUSRVP",141,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG,TIUCMMTX
"RTN","TIUSRVP",142,0)
 S IENS=""""_TIUDA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS=""
"RTN","TIUSRVP",143,0)
 I +$G(TIUX(1202)) S TIUX(1204)=+$G(TIUX(1202))
"RTN","TIUSRVP",144,0)
 I +$G(TIUX(1209)) S TIUX(1208)=+$G(TIUX(1209))
"RTN","TIUSRVP",145,0)
 ;If the document is a member of the Clinical Procedures Class, set the
"RTN","TIUSRVP",146,0)
 ;Entered By field to the Author/Dictator field
"RTN","TIUSRVP",147,0)
 I $G(TIUCPF),+$G(TIUX(1202)) S TIUX(1302)=+$G(TIUX(1202))
"RTN","TIUSRVP",148,0)
 M @FDARR=TIUX
"RTN","TIUSRVP",149,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG") ; File record
"RTN","TIUSRVP",150,0)
 I $D(TIUMSG)>9 S SUCCESS=0_U_$G(TIUMSG("DIERR",1,"TEXT",1)) Q
"RTN","TIUSRVP",151,0)
 S SUCCESS=TIUDA
"RTN","TIUSRVP",152,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",153,0)
 . N DA
"RTN","TIUSRVP",154,0)
 . S DA=TIUDA
"RTN","TIUSRVP",155,0)
 . S TIUCMMTX=$$COMMIT^TIULC1(+$G(^TIU(8925,+TIUDA,0)))
"RTN","TIUSRVP",156,0)
 . I TIUCMMTX]"" X TIUCMMTX
"RTN","TIUSRVP",157,0)
 . K ^TIU(8925,"ASAVE",DUZ,TIUDA)
"RTN","TIUSRVP",158,0)
 Q
"RTN","TIUSRVP",159,0)
SIGN(ERR,TIUDA,TIUX) ; API for /es/
"RTN","TIUSRVP",160,0)
 N X,TIUACT,TIUSIGN,TIUD0,TIUD12,TIUSTAT,SIGNER,COSIGNER,VALID,XTRASGNR
"RTN","TIUSRVP",161,0)
 N TIUES S ERR=0
"RTN","TIUSRVP",162,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD12=$G(^TIU(8925,+TIUDA,12))
"RTN","TIUSRVP",163,0)
 S SIGNER=$P(TIUD12,U,4),COSIGNER=$P(TIUD12,U,8)
"RTN","TIUSRVP",164,0)
 I (DUZ'=SIGNER),(DUZ'=COSIGNER) S XTRASGNR=+$O(^TIU(8925.7,"AE",+TIUDA,+DUZ,0))
"RTN","TIUSRVP",165,0)
 S TIUSTAT=+$P(TIUD0,U,5)
"RTN","TIUSRVP",166,0)
 S TIUACT=$S(TIUSTAT'>5:"SIGNATURE",+$G(XTRASGNR):"SIGNATURE",1:"COSIGNATURE")
"RTN","TIUSRVP",167,0)
 S TIUSIGN=$$CANDO^TIULP(TIUDA,TIUACT)
"RTN","TIUSRVP",168,0)
 I +TIUSIGN'>0 S ERR="89250004^"_$P(TIUSIGN,U,2) Q
"RTN","TIUSRVP",169,0)
 S VALID=$$VALIDATE($$DECRYP^XUSRB1(TIUX))
"RTN","TIUSRVP",170,0)
 I +VALID'>0 S ERR="89250005^"_$$EZBLD^DIALOG(89250005) Q
"RTN","TIUSRVP",171,0)
 S TIUES=1_U_$P($G(^VA(200,+DUZ,20)),U,2,3)
"RTN","TIUSRVP",172,0)
 I '+$G(XTRASGNR) D ES^TIURS(TIUDA,TIUES)
"RTN","TIUSRVP",173,0)
 I +$G(XTRASGNR) D ADDSIG^TIURS1(TIUDA,XTRASGNR)
"RTN","TIUSRVP",174,0)
 I +$G(^TIU(8925,TIUDA,21)),(TIUACT="SIGNATURE") D AUDLINK^TIUGR1(TIUDA,"a",+$G(^(21)))
"RTN","TIUSRVP",175,0)
 Q
"RTN","TIUSRVP",176,0)
VALIDATE(X) ; Validate /es/-code
"RTN","TIUSRVP",177,0)
 N TIUY S TIUY=0
"RTN","TIUSRVP",178,0)
 D HASH^XUSHSHP I X]"",(X=$P($G(^VA(200,+DUZ,20)),U,4)) S TIUY=1
"RTN","TIUSRVP",179,0)
 Q TIUY
"RTN","TIUSRVP",180,0)
DELETE(ERR,TIUDA,TIURSN) ; API for record deletion
"RTN","TIUSRVP",181,0)
 N TIUDEL,TIUD0 S ERR=0,TIUDEL=$$CANDO^TIULP(TIUDA,"DELETE RECORD")
"RTN","TIUSRVP",182,0)
 I TIUDEL'>0 S ERR="89250003^"_$$EZBLD^DIALOG(89250003) Q
"RTN","TIUSRVP",183,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0))
"RTN","TIUSRVP",184,0)
 I +$P(TIUD0,U,5)'<6 D  Q
"RTN","TIUSRVP",185,0)
 . S TIURSN=$G(TIURSN,"A")
"RTN","TIUSRVP",186,0)
 . D DELTEXT^TIURB2(TIUDA,TIURSN)
"RTN","TIUSRVP",187,0)
 D DIK^TIURB2(TIUDA),DELAUDIT^TIUEDI1(TIUDA)
"RTN","TIUSRVP",188,0)
 Q
"RTN","TIUSRVP",189,0)
LOCK(ERR,TIUDA) ; Bid for lock on a TIU Document record
"RTN","TIUSRVP",190,0)
 L +^TIU(8925,+TIUDA):1 I  S ERR=0
"RTN","TIUSRVP",191,0)
 E  S ERR="1^ Another session has this record locked."
"RTN","TIUSRVP",192,0)
 Q
"RTN","TIUSRVP",193,0)
UNLOCK(ERR,TIUDA) ; Decrement Lock on a TIU Document record
"RTN","TIUSRVP",194,0)
 L -^TIU(8925,+TIUDA) S ERR=0
"RTN","TIUSRVP",195,0)
 Q
"RTN","TIUSRVP1")
0^2^B37897256
"RTN","TIUSRVP1",1,0)
TIUSRVP1 ; SLC/JER - More API's in support of PUT ;17-OCT-2001 12:00:00
"RTN","TIUSRVP1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**19,59,89,100,109,167**;Jun 20, 1997
"RTN","TIUSRVP1",3,0)
 ; SUCCESS = (by ref) SUCCESS Returns TIU DOCUMENT # (PTR to 8925)
"RTN","TIUSRVP1",4,0)
 ;         = 0^Explanatory message if no SUCCESS
"RTN","TIUSRVP1",5,0)
 ; DFN     = Patient (#2)
"RTN","TIUSRVP1",6,0)
 ; TITLE   = Pointer to TIU Document Definition (#8925.1)
"RTN","TIUSRVP1",7,0)
 ; [VDT]   = Date(/Time) of Visit
"RTN","TIUSRVP1",8,0)
 ; [VLOC]  = Visit Location (pointer to HOSPITAL LOCATION
"RTN","TIUSRVP1",9,0)
 ; [VSIT]  = Pointer to visit file (#9000010)
"RTN","TIUSRVP1",10,0)
 ; [VSTR]  = Visit string (i.e., VLOC;VDT;VTYPE)
"RTN","TIUSRVP1",11,0)
 ; [NOASF] = Flag if set to 1=Do Not Set ASAVE cross-reference
"RTN","TIUSRVP1",12,0)
 ; TIUX    = (by ref) array containing identifying fields, as
"RTN","TIUSRVP1",13,0)
 ;           well as the body of the document
"RTN","TIUSRVP1",14,0)
SITEPARM(TIUY) ; Get site parameters for GUI
"RTN","TIUSRVP1",15,0)
 N TIUPRM0,TIUPRM1
"RTN","TIUSRVP1",16,0)
 D SETPARM^TIULE
"RTN","TIUSRVP1",17,0)
 S TIUY=TIUPRM0
"RTN","TIUSRVP1",18,0)
 Q
"RTN","TIUSRVP1",19,0)
DEFDOC(TIUY,HLOC,USER,TIUDT,TIUIEN) ; Get default primary provider
"RTN","TIUSRVP1",20,0)
 N TIUSPRM,TIUDDOC,TIUAUTH
"RTN","TIUSRVP1",21,0)
 D SITEPARM(.TIUSPRM)
"RTN","TIUSRVP1",22,0)
 S TIUDDOC=+$P(TIUSPRM,U,8)
"RTN","TIUSRVP1",23,0)
 S TIUAUTH=$S((+$G(USER)!('+$G(TIUIEN))):0,1:+$P($G(^TIU(8925,+$G(TIUIEN),12)),U,2))
"RTN","TIUSRVP1",24,0)
 S USER=$S(+$G(USER):+$G(USER),+$G(TIUAUTH):+$G(TIUAUTH),1:DUZ)
"RTN","TIUSRVP1",25,0)
 S TIUDT=$S(+$G(TIUDT):+$G(TIUDT),1:DT)
"RTN","TIUSRVP1",26,0)
 S TIUY=$S(TIUDDOC=1:$$DFLTDOC^TIUPXAPI(HLOC),TIUDDOC=2:$$CURDOC(USER),1:"0^")
"RTN","TIUSRVP1",27,0)
 Q
"RTN","TIUSRVP1",28,0)
CURDOC(USER,TIUDT) ; Is the current user a known Provider?
"RTN","TIUSRVP1",29,0)
 N TIUY,TIUPROV S TIUY="0^"
"RTN","TIUSRVP1",30,0)
 S USER=$S(+$G(USER):+$G(USER),1:DUZ)
"RTN","TIUSRVP1",31,0)
 S TIUDT=$S(+$G(TIUDT):+$G(TIUDT),1:DT)
"RTN","TIUSRVP1",32,0)
 S TIUPROV=$$PROVIDER^TIUPXAP1(USER,TIUDT)
"RTN","TIUSRVP1",33,0)
 I +TIUPROV S TIUY=USER_U_$$PERSNAME^TIULC1(USER)
"RTN","TIUSRVP1",34,0)
 Q TIUY
"RTN","TIUSRVP1",35,0)
ISAPROV(TIUY,USER,DATE) ; Is user a provider?
"RTN","TIUSRVP1",36,0)
 S USER=$G(USER,DUZ)
"RTN","TIUSRVP1",37,0)
 S DATE=$G(DATE,DT)
"RTN","TIUSRVP1",38,0)
 S TIUY=$$PROVIDER^TIUPXAP1(USER,DATE)
"RTN","TIUSRVP1",39,0)
 Q
"RTN","TIUSRVP1",40,0)
DOCPARM(TIUY,TIUDA,TIUTYP) ; Get document parameters for GUI
"RTN","TIUSRVP1",41,0)
 I '+$G(TIUTYP),+$G(TIUDA) S TIUTYP=+$G(^TIU(8925,+TIUDA,0))
"RTN","TIUSRVP1",42,0)
 I '+$G(TIUTYP) S TIUY(0)="" Q
"RTN","TIUSRVP1",43,0)
 D DOCPRM^TIULC1(TIUTYP,.TIUY,$G(TIUDA))
"RTN","TIUSRVP1",44,0)
 I '$D(TIUY) S TIUY(0)=""
"RTN","TIUSRVP1",45,0)
 Q
"RTN","TIUSRVP1",46,0)
CONSTUB(TIUDA,GMRCVP,DFN) ; Create a stub for a Consult Report
"RTN","TIUSRVP1",47,0)
 N DIE,DR,DA
"RTN","TIUSRVP1",48,0)
 D STUB(.TIUDA,"CONSULT REPORT",DFN)
"RTN","TIUSRVP1",49,0)
 I +TIUDA'>0 Q
"RTN","TIUSRVP1",50,0)
 S DIE=8925,DA=+TIUDA,DR="1405////^S X=GMRCVP"
"RTN","TIUSRVP1",51,0)
 D ^DIE
"RTN","TIUSRVP1",52,0)
 Q
"RTN","TIUSRVP1",53,0)
STUB(TIUDA,TIUTITL,DFN) ; Create a stub
"RTN","TIUSRVP1",54,0)
 N TIUVSIT,TIUFPRIV,DIC,DIE,DR,DA,DLAYGO,X,Y S TIUFPRIV=1
"RTN","TIUSRVP1",55,0)
 I +$G(TIUTITL)'>0 S TIUTITL=$$WHATITLE^TIUPUTU(TIUTITL)
"RTN","TIUSRVP1",56,0)
 I +TIUTITL'>0 S TIUDA=-1 Q
"RTN","TIUSRVP1",57,0)
 S (DIC,DLAYGO)=8925,DIC(0)="LF"
"RTN","TIUSRVP1",58,0)
 S X=""""_"`"_+TIUTITL_""""
"RTN","TIUSRVP1",59,0)
 D ^DIC S TIUDA=+Y Q:+Y'>0
"RTN","TIUSRVP1",60,0)
 D EVENT(.TIU,DFN) I $L($G(TIU("VSTR")))'>0 S TIUDA=-1 Q
"RTN","TIUSRVP1",61,0)
 S DIE=DIC,DA=TIUDA
"RTN","TIUSRVP1",62,0)
 S DR=".02////"_+DFN_";.03////"_$P($G(TIU("VISIT")),U)_";.04////"_+$$DOCCLASS^TIULC1(TIUTITL)_";.05///UNDICTATED;.13////E;1301////"_+$$NOW^XLFDT
"RTN","TIUSRVP1",63,0)
 D ^DIE
"RTN","TIUSRVP1",64,0)
 Q
"RTN","TIUSRVP1",65,0)
EVENT(TIUY,DFN) ; Create an Event-type Visit Entry
"RTN","TIUSRVP1",66,0)
 N VDT,VSTR,DGPM
"RTN","TIUSRVP1",67,0)
 S DGPM=$G(^DPT(DFN,.105))
"RTN","TIUSRVP1",68,0)
 I +DGPM'>0 D
"RTN","TIUSRVP1",69,0)
 . S VDT=$$NOW^XLFDT
"RTN","TIUSRVP1",70,0)
 . S VSTR=";"_VDT_";"_"E"
"RTN","TIUSRVP1",71,0)
 D PATVADPT^TIULV(.TIUY,+DFN,DGPM,$G(VSTR))
"RTN","TIUSRVP1",72,0)
 I $G(TIUY("LOC"))="",+DUZ D
"RTN","TIUSRVP1",73,0)
 .N TIUPREF,IDX
"RTN","TIUSRVP1",74,0)
 .S TIUPREF=$$PERSPRF^TIULE(DUZ)
"RTN","TIUSRVP1",75,0)
 .S IDX=+$P(TIUPREF,U,2)
"RTN","TIUSRVP1",76,0)
 .I IDX S TIUY("LOC")=IDX_U_$P($G(^SC(IDX,0)),U,1)
"RTN","TIUSRVP1",77,0)
 Q
"RTN","TIUSRVP1",78,0)
GETPNAME(TIUY,TIUTYPE) ; Get Print Name of a Document
"RTN","TIUSRVP1",79,0)
 S TIUY=$$PNAME^TIULC1(TIUTYPE)
"RTN","TIUSRVP1",80,0)
 Q
"RTN","TIUSRVP1",81,0)
SAVED(TIUY,TIUDA) ; Was the document committed to the database?
"RTN","TIUSRVP1",82,0)
 N TIUD12,TIUD13,TIUEBY,TIUAUT,TIUECS S TIUY=1
"RTN","TIUSRVP1",83,0)
 S TIUD12=$G(^TIU(8925,TIUDA,12)),TIUD13=$G(^(13))
"RTN","TIUSRVP1",84,0)
 S TIUEBY=$P(TIUD13,U,2),TIUAUT=$P(TIUD12,U,2),TIUECS=$P(TIUD12,U,8)
"RTN","TIUSRVP1",85,0)
 I $D(^TIU(8925,"ASAVE",+DUZ,TIUDA)) D  Q
"RTN","TIUSRVP1",86,0)
 . S TIUY="0^You appear to have been disconnected..."
"RTN","TIUSRVP1",87,0)
 I DUZ'=TIUEBY,(TIUEBY'=TIUAUT),$D(^TIU(8925,"ASAVE",+TIUEBY,TIUDA)) D  Q
"RTN","TIUSRVP1",88,0)
 . S TIUY="0^The transcriber appears to have been disconnected..."
"RTN","TIUSRVP1",89,0)
 I DUZ'=TIUAUT,$D(^TIU(8925,"ASAVE",+TIUAUT,TIUDA)) D  Q
"RTN","TIUSRVP1",90,0)
 . S TIUY="0^The author appears to have been disconnected..."
"RTN","TIUSRVP1",91,0)
 I DUZ'=TIUECS,$D(^TIU(8925,"ASAVE",+TIUECS,TIUDA)) D  Q
"RTN","TIUSRVP1",92,0)
 . S TIUY="0^The expected cosigner appears to have been disconnected..."
"RTN","TIUSRVP1",93,0)
 Q
"RTN","TIUSRVP1",94,0)
STUFREC(TIUDA,TIUREC,DFN,PARENT,TITLE,TIU) ; load TIUREC for create
"RTN","TIUSRVP1",95,0)
 N TIUREQCS,TIUSCAT,TIUSTAT,TIUCPF
"RTN","TIUSRVP1",96,0)
 ;Set a flag to indicate whether or not a Title is a member of the
"RTN","TIUSRVP1",97,0)
 ;Clinical Procedures Class (1=Yes and 0=No)
"RTN","TIUSRVP1",98,0)
 S TIUCPF=+$$ISA^TIULX(TITLE,+$$CLASS^TIUCP)
"RTN","TIUSRVP1",99,0)
 S TIUSTAT=$$STATUS(TIUDA,+$G(SUPPRESS),$G(TITLE))
"RTN","TIUSRVP1",100,0)
 D REQCOS^TIUSRVA(.TIUREQCS,+TITLE,"",$S(+$G(TIUREC(1202)):+$G(TIUREC(1202)),1:DUZ))
"RTN","TIUSRVP1",101,0)
 I +$G(PARENT)'>0 D
"RTN","TIUSRVP1",102,0)
 . S TIUREC(.02)=$G(DFN),TIUREC(.03)=$P($G(TIU("VISIT")),U)
"RTN","TIUSRVP1",103,0)
 . S TIUREC(.05)=$S(+$G(TIUREC(.05)):+$G(TIUREC(.05)),+TIUSTAT:TIUSTAT,1:5)
"RTN","TIUSRVP1",104,0)
 . S TIUREC(.07)=$P($G(TIU("EDT")),U),TIUREC(.08)=$P($G(TIU("LDT")),U)
"RTN","TIUSRVP1",105,0)
 . S TIUREC(1401)=$P($G(TIU("AD#")),U)
"RTN","TIUSRVP1",106,0)
 . S TIUREC(1402)=$P($G(TIU("TS")),U)
"RTN","TIUSRVP1",107,0)
 . S TIUREC(1404)=$P($G(TIU("SVC")),U)
"RTN","TIUSRVP1",108,0)
 I +$G(PARENT)>0 D
"RTN","TIUSRVP1",109,0)
 . S TIUREC(.02)=+$P($G(^TIU(8925,+PARENT,0)),U,2)
"RTN","TIUSRVP1",110,0)
 . S TIUREC(.03)=+$P($G(^TIU(8925,+PARENT,0)),U,3)
"RTN","TIUSRVP1",111,0)
 . S TIUREC(.05)=$S(+$G(TIUREC(.05)):+$G(TIUREC(.05)),+TIUSTAT:TIUSTAT,1:5)
"RTN","TIUSRVP1",112,0)
 . S TIUREC(.06)=PARENT,TIUREC(.07)=$P(TIU("EDT"),U)
"RTN","TIUSRVP1",113,0)
 . S TIUREC(.08)=$P(TIU("LDT"),U)
"RTN","TIUSRVP1",114,0)
 . S TIUREC(1401)=$P($G(^TIU(8925,+PARENT,14)),U)
"RTN","TIUSRVP1",115,0)
 . S TIUREC(1402)=$P($G(^TIU(8925,+PARENT,14)),U,2)
"RTN","TIUSRVP1",116,0)
 . S TIUREC(1404)=$P($G(^TIU(8925,+PARENT,14)),U,4)
"RTN","TIUSRVP1",117,0)
 S TIUREC(.04)=$$DOCCLASS^TIULC1(TITLE)
"RTN","TIUSRVP1",118,0)
 S TIUSCAT=$S(+$L($P($G(TIU("CAT")),U)):$P($G(TIU("CAT")),U),+$L($P($G(TIU("VSTR")),";",3)):$P($G(TIU("VSTR")),";",3),1:"")
"RTN","TIUSRVP1",119,0)
 S TIUREC(.13)=TIUSCAT
"RTN","TIUSRVP1",120,0)
 ;If the document is a member of the Clinical Procedures Class, set the
"RTN","TIUSRVP1",121,0)
 ;Author/Dictator and the Expected Signer fields to Null
"RTN","TIUSRVP1",122,0)
 S (TIUREC(1202),TIUREC(1204))=$S(+$G(TIUREC(1202)):+$G(TIUREC(1202)),TIUCPF:"",1:+$G(DUZ))
"RTN","TIUSRVP1",123,0)
 S TIUREC(1205)=$P($G(TIU("LOC")),U)
"RTN","TIUSRVP1",124,0)
 S TIUREC(1211)=$P($G(TIU("VLOC")),U)
"RTN","TIUSRVP1",125,0)
 S TIUREC(1201)=$$NOW^XLFDT
"RTN","TIUSRVP1",126,0)
 S TIUREC(1301)=$S($G(TIUREC(1301))]"":$P(TIUREC(1301),U),1:$$NOW^XLFDT)
"RTN","TIUSRVP1",127,0)
 I +$$ISDS^TIULX(TITLE) D
"RTN","TIUSRVP1",128,0)
 . I +$G(TIU("LDT"))'>0 S TIUREC(.12)=1
"RTN","TIUSRVP1",129,0)
 . S TIUREC(.13)="H"
"RTN","TIUSRVP1",130,0)
 . D REFDT(.TIUREC)
"RTN","TIUSRVP1",131,0)
 ;If the document is a member of the Clinical Procedures Class, set the
"RTN","TIUSRVP1",132,0)
 ;Entered By field to Null
"RTN","TIUSRVP1",133,0)
 S TIUREC(1303)="R",TIUREC(1302)=$S(TIUCPF:"",1:$G(DUZ))
"RTN","TIUSRVP1",134,0)
 I $S(+$G(TIUREC(1208)):1,+$G(TIUREQCS):1,1:0) S TIUREC(1506)=1
"RTN","TIUSRVP1",135,0)
 Q
"RTN","TIUSRVP1",136,0)
REFDT(TIUX) ; Hack Ref Date/time for DS's
"RTN","TIUSRVP1",137,0)
 S TIUX(1301)=$S(+$G(TIU("LDT")):+$G(TIU("LDT")),1:$G(TIUX(1301)))
"RTN","TIUSRVP1",138,0)
 Q
"RTN","TIUSRVP1",139,0)
STATUS(TIUDA,SUPPRESS,TITLE) ; Compute the status of the current record
"RTN","TIUSRVP1",140,0)
 N TIUDPRM,TIUY
"RTN","TIUSRVP1",141,0)
 ; If the document is an addendum, compute status based on processing
"RTN","TIUSRVP1",142,0)
 ; requirements of the Parent document or its ancestors
"RTN","TIUSRVP1",143,0)
 I +$$ISADDNDM^TIULC1(TIUDA) D
"RTN","TIUSRVP1",144,0)
 . S TIUDA=$S(+$P(^TIU(8925,TIUDA,0),U,6):$P(^(0),U,6),1:TIUDA)
"RTN","TIUSRVP1",145,0)
 . S TITLE=+$G(^TIU(8925,TIUDA,0))
"RTN","TIUSRVP1",146,0)
 D DOCPRM^TIULC1(TITLE,.TIUDPRM,$G(TIUDA))
"RTN","TIUSRVP1",147,0)
 I +$P(TIUDPRM(0),U,2),+$G(SUPPRESS) S TIUY=3 G STATUX
"RTN","TIUSRVP1",148,0)
 S TIUY=$S(+$$REQVER^TIULC(+TIUDA,+$P($G(TIUDPRM(0)),U,3)):4,1:5)
"RTN","TIUSRVP1",149,0)
STATUX Q TIUY
"RTN","TIUSRVP1",150,0)
IDATTCH(TIUY,TIUDA,TIUDAD) ; Attach TIUDA as ID Child entry to TIUDAD
"RTN","TIUSRVP1",151,0)
 N TIUX
"RTN","TIUSRVP1",152,0)
 S TIUX(2101)=TIUDAD
"RTN","TIUSRVP1",153,0)
 D FILE^TIUSRVP(.TIUY,TIUDA,.TIUX,1)
"RTN","TIUSRVP1",154,0)
 D AUDLINK^TIUGR1(TIUDA,"a",TIUDAD)
"RTN","TIUSRVP1",155,0)
 D SENDID^TIUALRT1(TIUDA)
"RTN","TIUSRVP1",156,0)
 Q
"RTN","TIUSRVP1",157,0)
IDDTCH(TIUY,TIUDA) ; Detach TIUDA from its ID Parent
"RTN","TIUSRVP1",158,0)
 N TIUX,IDDAD
"RTN","TIUSRVP1",159,0)
 I '+$G(^TIU(8925,TIUDA,21)) D  Q
"RTN","TIUSRVP1",160,0)
 . S TIUY="0^Record #"_TIUDA_" is NOT an ID Entry."
"RTN","TIUSRVP1",161,0)
 S IDDAD=+$G(^TIU(8925,TIUDA,21))
"RTN","TIUSRVP1",162,0)
 S TIUX(2101)="@"
"RTN","TIUSRVP1",163,0)
 D FILE^TIUSRVP(.TIUY,TIUDA,.TIUX,1)
"RTN","TIUSRVP1",164,0)
 D AUDLINK^TIUGR1(TIUDA,"d",IDDAD)
"RTN","TIUSRVP1",165,0)
 D IDDEL^TIUALRT1(TIUDA)
"RTN","TIUSRVP1",166,0)
 Q
"VER")
8.0^22.0
**END**
**END**
