EMERGENCY Released DG*5.3*576 SEQ #497
Extracted from mail message
**KIDS**:DG*5.3*576^

**INSTALL NAME**
DG*5.3*576
"BLD",4633,0)
DG*5.3*576^REGISTRATION^0^3040218^y
"BLD",4633,4,0)
^9.64PA^^
"BLD",4633,"ABNS",0)
^9.66A^^
"BLD",4633,"ABPKG")
n^n
"BLD",4633,"KRN",0)
^9.67PA^8989.52^19
"BLD",4633,"KRN",.4,0)
.4
"BLD",4633,"KRN",.401,0)
.401
"BLD",4633,"KRN",.402,0)
.402
"BLD",4633,"KRN",.403,0)
.403
"BLD",4633,"KRN",.5,0)
.5
"BLD",4633,"KRN",.84,0)
.84
"BLD",4633,"KRN",3.6,0)
3.6
"BLD",4633,"KRN",3.8,0)
3.8
"BLD",4633,"KRN",9.2,0)
9.2
"BLD",4633,"KRN",9.8,0)
9.8
"BLD",4633,"KRN",9.8,"NM",0)
^9.68A^4^3
"BLD",4633,"KRN",9.8,"NM",2,0)
DGCV^^0^B31234185
"BLD",4633,"KRN",9.8,"NM",3,0)
DPTLK^^0^B61582167
"BLD",4633,"KRN",9.8,"NM",4,0)
DGCVEXP^^0^B505672
"BLD",4633,"KRN",9.8,"NM","B","DGCV",2)
 
"BLD",4633,"KRN",9.8,"NM","B","DGCVEXP",4)
 
"BLD",4633,"KRN",9.8,"NM","B","DPTLK",3)
 
"BLD",4633,"KRN",19,0)
19
"BLD",4633,"KRN",19,"NM",0)
^9.68A^^
"BLD",4633,"KRN",19.1,0)
19.1
"BLD",4633,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",4633,"KRN",101,0)
101
"BLD",4633,"KRN",409.61,0)
409.61
"BLD",4633,"KRN",771,0)
771
"BLD",4633,"KRN",870,0)
870
"BLD",4633,"KRN",8989.51,0)
8989.51
"BLD",4633,"KRN",8989.52,0)
8989.52
"BLD",4633,"KRN",8994,0)
8994
"BLD",4633,"KRN","B",.4,.4)
 
"BLD",4633,"KRN","B",.401,.401)
 
"BLD",4633,"KRN","B",.402,.402)
 
"BLD",4633,"KRN","B",.403,.403)
 
"BLD",4633,"KRN","B",.5,.5)
 
"BLD",4633,"KRN","B",.84,.84)
 
"BLD",4633,"KRN","B",3.6,3.6)
 
"BLD",4633,"KRN","B",3.8,3.8)
 
"BLD",4633,"KRN","B",9.2,9.2)
 
"BLD",4633,"KRN","B",9.8,9.8)
 
"BLD",4633,"KRN","B",19,19)
 
"BLD",4633,"KRN","B",19.1,19.1)
 
"BLD",4633,"KRN","B",101,101)
 
"BLD",4633,"KRN","B",409.61,409.61)
 
"BLD",4633,"KRN","B",771,771)
 
"BLD",4633,"KRN","B",870,870)
 
"BLD",4633,"KRN","B",8989.51,8989.51)
 
"BLD",4633,"KRN","B",8989.52,8989.52)
 
"BLD",4633,"KRN","B",8994,8994)
 
"BLD",4633,"QUES",0)
^9.62^^
"BLD",4633,"REQB",0)
^9.611^2^2
"BLD",4633,"REQB",1,0)
DG*5.3*528^2
"BLD",4633,"REQB",2,0)
DG*5.3*541^2
"BLD",4633,"REQB","B","DG*5.3*528",1)
 
"BLD",4633,"REQB","B","DG*5.3*541",2)
 
"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
576^3040218
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","DGCV")
0^2^B31234185
"RTN","DGCV",1,0)
DGCV ;ALB/DW,ERC - COMBAT VET ELIGIBILTY; 06/05/2003
"RTN","DGCV",2,0)
 ;;5.3;Registration;**528,576**; Aug 13, 1993
"RTN","DGCV",3,0)
 ;
"RTN","DGCV",4,0)
CVELIG(DFN) ;
"RTN","DGCV",5,0)
 ;API will determine whether or not this vetern needs to have CV End
"RTN","DGCV",6,0)
 ;Date set.  If this determination cannot be done due to imprecise
"RTN","DGCV",7,0)
 ;or missing dates, it returns which dates need editing.
"RTN","DGCV",8,0)
 ;Input:
"RTN","DGCV",9,0)
 ;  DFN - Patient file IEN
"RTN","DGCV",10,0)
 ;Output
"RTN","DGCV",11,0)
 ;  RESULT
"RTN","DGCV",12,0)
 ;    0 - CV End Date should not be updated
"RTN","DGCV",13,0)
 ;    1 - CV End Date should be updated
"RTN","DGCV",14,0)
 ;  If critical dates are imprecise return the following
"RTN","DGCV",15,0)
 ;    A - CV End Date should not be updated, imprecise Service Sep date
"RTN","DGCV",16,0)
 ;    B - CV End Date should not be updated, imprecise Combat To date
"RTN","DGCV",17,0)
 ;    C - CV End Date should not be updated, imprecise Yugoslavia To date
"RTN","DGCV",18,0)
 ;    D - CV End Date should not be updated, imprecise Somalia To date
"RTN","DGCV",19,0)
 ;    E - CV End Date should not be updated, imprecise Pers Gulf To date
"RTN","DGCV",20,0)
 ;  If the Service Sep Date is missing, return the following so that it 
"RTN","DGCV",21,0)
 ;  will appear on the Imprecise/Missing Date Report
"RTN","DGCV",22,0)
 ;    F - missing Service Sep Date
"RTN","DGCV",23,0)
 ;  If critical dates are missing but the corresponding indicator fields
"RTN","DGCV",24,0)
 ;  are set to 'YES' return the following
"RTN","DGCV",25,0)
 ;    G - missing Combat To Date, but Combat Indicated? = 'Yes'
"RTN","DGCV",26,0)
 ;    H - missing PG To Date, but PG Indicated? = 'Yes'
"RTN","DGCV",27,0)
 ;    I - missing Somalia To Date, but Somalia Indicator = 'Yes'
"RTN","DGCV",28,0)
 ;    J - missing Yugoslavia To Date, but Yugoslavia Indicator = 'Yes'
"RTN","DGCV",29,0)
 ;
"RTN","DGCV",30,0)
 N DG1,DG2,I,RESULT
"RTN","DGCV",31,0)
 N DGCOM,DGCVDT,DGCVFLG,DGGULF,DGSOM,DGSRV,DGYUG
"RTN","DGCV",32,0)
 S (DG1,DG2,RESULT)=0
"RTN","DGCV",33,0)
 I $G(DFN)']"" Q RESULT
"RTN","DGCV",34,0)
 I '$D(^DPT(DFN)) Q RESULT
"RTN","DGCV",35,0)
 ;
"RTN","DGCV",36,0)
 ;get combat related data from VistA
"RTN","DGCV",37,0)
 N DGARR,DGERR
"RTN","DGCV",38,0)
 D GETS^DIQ(2,DFN_",",".327;.322012;.322018;.322021;.5294;.5295","I","DGARR","DGERR")
"RTN","DGCV",39,0)
 D PARSE
"RTN","DGCV",40,0)
 ;
"RTN","DGCV",41,0)
 S DG1=$$CHKSSD(DFN) ;check SSD for imprecise or missing
"RTN","DGCV",42,0)
 ;
"RTN","DGCV",43,0)
 S DGDATE=$G(DGCOM)_"^"_$G(DGYUG)_"^"_$G(DGSOM)_"^"_$G(DGGULF)
"RTN","DGCV",44,0)
 S DG2=$$CHKREST(DGDATE) ;check other "TO" dates for imprecise or missing
"RTN","DGCV",45,0)
 S RESULT=$$RES(DG1,$G(DG2))
"RTN","DGCV",46,0)
 Q RESULT
"RTN","DGCV",47,0)
 ;
"RTN","DGCV",48,0)
RES(DG1,DG2) ;determine the final RESULT code from DGRES1 & DGRES2
"RTN","DGCV",49,0)
 ;if SSD evaluates to earlier than 11/11/98, can't set CV End Date
"RTN","DGCV",50,0)
 I DG1=0!($G(DG2)=0) Q 0
"RTN","DGCV",51,0)
 ;if SSD is 1
"RTN","DGCV",52,0)
 I DG1=1,($G(DG2)=1!($G(DG2)']"")) Q 1
"RTN","DGCV",53,0)
 I DG1=1,($G(DG2)=0) Q 0
"RTN","DGCV",54,0)
 I DG1=1 Q DG2
"RTN","DGCV",55,0)
 ;if SSD is imprecise or missing
"RTN","DGCV",56,0)
 I DG1'=1,($G(DG2)=1) S DG2=""
"RTN","DGCV",57,0)
 Q DG1_DG2
"RTN","DGCV",58,0)
 ;
"RTN","DGCV",59,0)
CHKDATE(DGDATE,I) ;check to see if date is imprecise or missing
"RTN","DGCV",60,0)
 ;if imprecise check to see if the imprecision prevents CV evaluation
"RTN","DGCV",61,0)
 ;if not imprecise check to see if after 11/11/98
"RTN","DGCV",62,0)
 N RES
"RTN","DGCV",63,0)
 S RES=0
"RTN","DGCV",64,0)
 I $G(DGDATE)']"" D  Q RES
"RTN","DGCV",65,0)
 . S RES=$S(I=0:"F",I=1:"G",I=2:"H",I=3:"I",I=4:"J",1:"")
"RTN","DGCV",66,0)
 I $E(DGDATE,6,7)="00" D
"RTN","DGCV",67,0)
 . I I=0 I DGDATE>2981111 S RES="A" Q
"RTN","DGCV",68,0)
 . I DGDATE=2980000!(DGDATE=2981100) D  Q
"RTN","DGCV",69,0)
 . . S RES=$S(I=0:"A",I=1:"B",I=2:"C",I=3:"D",I=4:"E",1:"")
"RTN","DGCV",70,0)
 Q:RES="A" RES
"RTN","DGCV",71,0)
 I DGDATE>2981111 S RES=1
"RTN","DGCV",72,0)
 Q RES
"RTN","DGCV",73,0)
 ;
"RTN","DGCV",74,0)
SETCV(DFN,DGSRV) ;calculate CV end date
"RTN","DGCV",75,0)
 K DGCVEDT
"RTN","DGCV",76,0)
 N DGFDA
"RTN","DGCV",77,0)
 I $G(DFN)']""!($G(DGSRV)']"") Q
"RTN","DGCV",78,0)
 I '$D(^DPT(DFN)) Q
"RTN","DGCV",79,0)
 S DGCVEDT=$P($$SCH^XLFDT("24M",DGSRV),".")
"RTN","DGCV",80,0)
 I DGCVEDT=$G(DGCVDT) Q
"RTN","DGCV",81,0)
 S DGFDA(2,DFN_",",.5295)=DGCVEDT
"RTN","DGCV",82,0)
 S DGFDA(2,DFN_",",.5296)=DT ;stuff DT into CV Date Edited field
"RTN","DGCV",83,0)
 D FILE^DIE(,"DGFDA")
"RTN","DGCV",84,0)
 Q
"RTN","DGCV",85,0)
 ;
"RTN","DGCV",86,0)
CVEDT(DFN,DGDT) ;Provide Combat Vet Eligibility End Date, if eligible
"RTN","DGCV",87,0)
 ;Supported DBIA #4156
"RTN","DGCV",88,0)
 ;Input:  DFN - Patient file IEN
"RTN","DGCV",89,0)
 ;        DGDT - Treatment date (optional), 
"RTN","DGCV",90,0)
 ;               DT is default
"RTN","DGCV",91,0)
 ;Output :RESULT=(1,0,-1)^End Date (if populated, otherwise null)^CV
"RTN","DGCV",92,0)
 ;               Eligible on DGDT(1,0)^is patient eligible on input date?
"RTN","DGCV",93,0)
 ;      (piece 1)  1 - qualifies as a CV
"RTN","DGCV",94,0)
 ;                 0 - does not qualify as a CV
"RTN","DGCV",95,0)
 ;                -1 - bad DFN or date
"RTN","DGCV",96,0)
 ;      (piece 3)  1 - vet was eligible on date specified (or DT)      
"RTN","DGCV",97,0)
 ;                 0 - vet was not eligible on date specified (or DT)
"RTN","DGCV",98,0)
 ;
"RTN","DGCV",99,0)
 N RESULT
"RTN","DGCV",100,0)
 S RESULT=""
"RTN","DGCV",101,0)
 I $G(DFN)="" Q -1
"RTN","DGCV",102,0)
 I '$D(^DPT(DFN)) Q -1
"RTN","DGCV",103,0)
 ;if time sent in, drop time
"RTN","DGCV",104,0)
 I $G(DGDT)']"" S DGDT=DT
"RTN","DGCV",105,0)
 I DGDT?7N1"."1.6N S DGDT=$E(DGDT,1,7)
"RTN","DGCV",106,0)
 I DGDT'?7N Q -1
"RTN","DGCV",107,0)
 S RESULT=$$GET1^DIQ(2,DFN_",",.5295,"I")
"RTN","DGCV",108,0)
 I $G(RESULT)']"" Q 0
"RTN","DGCV",109,0)
 S RESULT=$S(DGDT'>RESULT:RESULT_"^1",1:RESULT_"^0") ; if treatment date is earlier or equal to end date, veteran is eligible
"RTN","DGCV",110,0)
 S RESULT=$S($G(RESULT):1_"^"_RESULT,1:0)
"RTN","DGCV",111,0)
 Q RESULT
"RTN","DGCV",112,0)
 ;
"RTN","DGCV",113,0)
PARSE ;GETS^DIQ called in CVELIG - in this subroutine stuff results into array
"RTN","DGCV",114,0)
 S DGSRV=$G(DGARR(2,DFN_",",.327,"I"))
"RTN","DGCV",115,0)
 S DGCOM=$G(DGARR(2,DFN_",",.5294,"I")) ;Combat To Date
"RTN","DGCV",116,0)
 S DGGULF=$G(DGARR(2,DFN_",",.322012,"I")) ;Persian Gulf To Date
"RTN","DGCV",117,0)
 S DGSOM=$G(DGARR(2,DFN_",",.322018,"I")) ;Somalia To Date
"RTN","DGCV",118,0)
 S DGYUG=$G(DGARR(2,DFN_",",.322021,"I")) ;Yugoslavia To Date
"RTN","DGCV",119,0)
 S DGCVDT=$G(DGARR(2,DFN_",",.5295,"I")) ;CV End Date
"RTN","DGCV",120,0)
 Q
"RTN","DGCV",121,0)
 ;
"RTN","DGCV",122,0)
CHKSSD(DFN) ;check the Serv Sep Date [Last]
"RTN","DGCV",123,0)
 ;
"RTN","DGCV",124,0)
 ;  Output - RESULT
"RTN","DGCV",125,0)
 ;    1 - Date is present and after 11/11/1998
"RTN","DGCV",126,0)
 ;    0 - Date is present but before 11/11/1998
"RTN","DGCV",127,0)
 ;    A - Date is imprecise & either is or potentially is after 11/11/98
"RTN","DGCV",128,0)
 ;    F - Date is missing
"RTN","DGCV",129,0)
 N DG1
"RTN","DGCV",130,0)
 I $G(DGSRV)']"" Q "F"
"RTN","DGCV",131,0)
 S DG1=$$CHKDATE(DGSRV,0)
"RTN","DGCV",132,0)
 I $G(DG1)']"" S DG1=0
"RTN","DGCV",133,0)
 Q DG1
"RTN","DGCV",134,0)
 ;
"RTN","DGCV",135,0)
CHKREST(DGDATE) ;
"RTN","DGCV",136,0)
 N DG3,DG4,DGDT,DGFLG,DGLEN,DGQ,DGR,DGRES,DGX
"RTN","DGCV",137,0)
 S (DG3,DG4,DGR,DGRES)=""
"RTN","DGCV",138,0)
 S DGQ=0 ;loop terminator
"RTN","DGCV",139,0)
 S DGFLG=0 ;flag to indicate that one of the dates is missing
"RTN","DGCV",140,0)
 F DGX=1:1:4 D
"RTN","DGCV",141,0)
 . S DGDT=$P(DGDATE,U,DGX) D
"RTN","DGCV",142,0)
 . . I $G(DGDT)']"" S DGFLG=1 ;Q
"RTN","DGCV",143,0)
 . . S DG4=$$CHKDATE(DGDT,DGX)
"RTN","DGCV",144,0)
 . . I $G(DG4)'=0 S DG3=$G(DG3)_$G(DG4)
"RTN","DGCV",145,0)
 S DGLEN=$L(DG3)
"RTN","DGCV",146,0)
 S DGQ=0
"RTN","DGCV",147,0)
 F DGX=1:1:DGLEN S DGCHAR=$E(DG3,DGX) D  Q:DGQ=1
"RTN","DGCV",148,0)
 . I DGCHAR=1 S DG3=DGCHAR,DGQ=1 Q
"RTN","DGCV",149,0)
 . I "BCDE"[DGCHAR S DGR=DGR_DGCHAR,DGQ=2
"RTN","DGCV",150,0)
 I DGQ=1 Q 1
"RTN","DGCV",151,0)
 I DGQ=2 Q $E(DGR)
"RTN","DGCV",152,0)
 I DGFLG=1 S DGRES=$$MISS(DFN,DGLEN,DG3)
"RTN","DGCV",153,0)
 Q DGRES
"RTN","DGCV",154,0)
 ;
"RTN","DGCV",155,0)
MISS(DFN,DGLEN,DGRES) ;there is at least one missing date, and in order to 
"RTN","DGCV",156,0)
 ;return a RESULT of a missing date, need to check to see if the 
"RTN","DGCV",157,0)
 ;corresponding indicator field is set to 'YES'
"RTN","DGCV",158,0)
 N DGARR,DGCHAR,DGERR,DGQ,DGR,DGX
"RTN","DGCV",159,0)
 N DGCIND,DGPGIND,DGSIND,DGYIND
"RTN","DGCV",160,0)
 S (DGCHAR,DGQ,DGR)=0
"RTN","DGCV",161,0)
 D GETS^DIQ(2,DFN_",",".32201;.322019;.322016;.5291","I","DGARR","DGERR")
"RTN","DGCV",162,0)
 S DGCIND=$G(DGARR(2,DFN_",",.5291,"I")) ;Combat Service Indicated
"RTN","DGCV",163,0)
 S DGYIND=$G(DGARR(2,DFN_",",.322019,"I")) ;Yugo service indicated
"RTN","DGCV",164,0)
 S DGSIND=$G(DGARR(2,DFN_",",.322016,"I")) ;Somalia service indicated
"RTN","DGCV",165,0)
 S DGPGIND=$G(DGARR(2,DFN_",",.32201,"I")) ;Pers Gulf service indicated
"RTN","DGCV",166,0)
 F DGX=1:1:DGLEN S DGCHAR=$E(DGRES,DGX) D  Q:DGQ=1
"RTN","DGCV",167,0)
 . I DGCHAR="G",($G(DGCIND)="Y") S DGR="G",DGQ=1 Q
"RTN","DGCV",168,0)
 . I DGCHAR="H",($G(DGYIND)="Y") S DGR="H",DGQ=1 Q
"RTN","DGCV",169,0)
 . I DGCHAR="I",($G(DGSIND)="Y") S DGR="I",DGQ=1 Q
"RTN","DGCV",170,0)
 . I DGCHAR="J",($G(DGPGIND)="Y") S DGR="J"
"RTN","DGCV",171,0)
 Q DGR
"RTN","DGCV",172,0)
DELCV(DFN) ;called by the Kill logic of the ACVCOM cross reference
"RTN","DGCV",173,0)
 ;if $$CVELIG^DGCV returns a 0 the CV End Date should be deleted
"RTN","DGCV",174,0)
 ;because this would indicate that fields have been changed and
"RTN","DGCV",175,0)
 ;CV eligibility is no longer appropriate
"RTN","DGCV",176,0)
 N DGCV,DGFDA
"RTN","DGCV",177,0)
 K DGCVFLG
"RTN","DGCV",178,0)
 S DGCVFLG=0
"RTN","DGCV",179,0)
 I $G(DFN)']"" Q
"RTN","DGCV",180,0)
 I '$D(^DPT(DFN)) Q
"RTN","DGCV",181,0)
 S DGCV=$$GET1^DIQ(2,DFN_",",.5295,"I")
"RTN","DGCV",182,0)
 I $G(DGCV)']"" Q
"RTN","DGCV",183,0)
 S DGCVFLG=1
"RTN","DGCV",184,0)
 S DGFDA(2,DFN_",",.5295)="@"
"RTN","DGCV",185,0)
 S DGFDA(2,DFN_",",.5296)=DT ;stuffs date into CV Date Edited field
"RTN","DGCV",186,0)
 D FILE^DIE(,"DGFDA")
"RTN","DGCV",187,0)
 Q
"RTN","DGCVEXP")
0^4^B505672
"RTN","DGCVEXP",1,0)
DGCVEXP ;ALB/ERC - FIND VETS WIITH EXPIRED CV STATUS; 12/11/02
"RTN","DGCVEXP",2,0)
 ;;5.3;Registration;**576**; Aug 13, 1993
"RTN","DGCVEXP",3,0)
 ;
"RTN","DGCVEXP",4,0)
 ;this API will list any veterans who have Combat Vet status that has
"RTN","DGCVEXP",5,0)
 ;expired.  This API will be called by IB to look for any vets who have
"RTN","DGCVEXP",6,0)
 ;been billed for treatment on the last day of their CV eligibility.
"RTN","DGCVEXP",7,0)
 ;
"RTN","DGCVEXP",8,0)
EN ;
"RTN","DGCVEXP",9,0)
 N DGC,DGE,DGEX,DGFILE
"RTN","DGCVEXP",10,0)
 K ^TMP("DGCVEX")
"RTN","DGCVEXP",11,0)
 S DGC=""
"RTN","DGCVEXP",12,0)
 S DGFILE=2
"RTN","DGCVEXP",13,0)
 F  S DGC=$O(^DPT("E",DGC)) Q:DGC'>0  D
"RTN","DGCVEXP",14,0)
 . S DGE=""
"RTN","DGCVEXP",15,0)
 . F  S DGE=$O(^DPT("E",DGC,DGE)) Q:DGE'>0  D
"RTN","DGCVEXP",16,0)
 . . S DGEX=$$GET1^DIQ(DGFILE,DGE_",",.5295,"I")
"RTN","DGCVEXP",17,0)
 . . I $G(DGEX)']"" Q
"RTN","DGCVEXP",18,0)
 . . I DT'>DGEX Q
"RTN","DGCVEXP",19,0)
 . . S ^TMP("DGCVEX",$J,DGE,DGEX)=""
"RTN","DGCVEXP",20,0)
 Q
"RTN","DPTLK")
0^3^B61582167
"RTN","DPTLK",1,0)
DPTLK ;ALB/RMO,RTK - MAS Patient Look-up Main Routine ; 05/13/2003  2:20 PM
"RTN","DPTLK",2,0)
 ;;5.3;Registration;**32,72,93,73,136,157,197,232,265,277,223,327,244,513,528,541,576**;Aug 13, 1993
"RTN","DPTLK",3,0)
 ;
"RTN","DPTLK",4,0)
 ; mods made for magstripe read 12/96 - JFP
"RTN","DPTLK",5,0)
 ;
"RTN","DPTLK",6,0)
 ;Optional input: DPTNOFZY='1' to suppress fuzzy lookups implemented
"RTN","DPTLK",7,0)
 ;                by patch DG*5.3*244
"RTN","DPTLK",8,0)
 ;
"RTN","DPTLK",9,0)
EN ; -- Entry point
"RTN","DPTLK",10,0)
 K DPTX,DPTDFN,DPTSAVX I $D(DIC(0)) G QK:DIC(0)["I"!(DIC(0)'["A"&('$D(X)))
"RTN","DPTLK",11,0)
 I '$D(^DD("VERSION")) W !!?3,"Unable to proceed. Fileman version node ^DD(""VERSION"") is undefined." G QK
"RTN","DPTLK",12,0)
 I '$D(^DPT(0))!(^DD("VERSION")<17.2) W !!?3,"Unable to proceed. ",$S('$D(^DPT(0)):"0th node of ^DPT missing",^DD("VERSION")<17.2:"Fileman version must be at least 17.2",1:""),"." G QK
"RTN","DPTLK",13,0)
EN2 K DO,DUOUT,DTOUT S U="^",DIC="^DPT(",DIC(0)=$S($D(DIC(0)):DIC(0),1:"AELMQ") S:DIC(0)'["A" (DPTX,DPTSAVX)=X
"RTN","DPTLK",14,0)
 S DPTSZ=1000 I $D(^DD("OS"))#2 S DPTSZ=$S(+$P(^DD("OS",^("OS"),0),U,2):$P(^(0),U,2),1:DPTSZ)
"RTN","DPTLK",15,0)
 ;
"RTN","DPTLK",16,0)
ASKPAT ; -- Prompt for patient
"RTN","DPTLK",17,0)
 I DIC(0)["A" D   G QK:'$T!($E(DPTX)["^")!(DPTX="")
"RTN","DPTLK",18,0)
 .K DTOUT,DUOUT
"RTN","DPTLK",19,0)
 .W !,$S($D(DIC("A")):DIC("A"),1:"Select PATIENT NAME: ") W:$D(DIC("B")) DIC("B"),"// "
"RTN","DPTLK",20,0)
 .R X:DTIME
"RTN","DPTLK",21,0)
 .S DPTX=X S:'$T DTOUT=1 S:$T&(DPTX="")&($D(DIC("B"))) DPTX=DIC("B") S:DPTX["^" DUOUT=1
"RTN","DPTLK",22,0)
 ; -- Check for the IATA magnetic stripe input
"RTN","DPTLK",23,0)
 N MAG,GCHK
"RTN","DPTLK",24,0)
 S MAG=0
"RTN","DPTLK",25,0)
 I $E(DPTX)="%"!($E(DPTX)=";"),DPTX["?" S MAG=1,(X,DPTX)=$$IATA(DPTX)
"RTN","DPTLK",26,0)
 ;
"RTN","DPTLK",27,0)
CHKPAT ; -- Custom Patient Lookup
"RTN","DPTLK",28,0)
 D DO^DIC1
"RTN","DPTLK",29,0)
 S DIC("W")=$S($D(DIC("W")):DIC("W"),1:"")
"RTN","DPTLK",30,0)
 K DPTIFNS,DPTS,DPTSEL
"RTN","DPTLK",31,0)
 S DPTCNT=0
"RTN","DPTLK",32,0)
 ; -- Check input for format an length
"RTN","DPTLK",33,0)
 G CHKDFN:DPTX?1A!(DPTX'?.ANP)!($L(DPTX)>30)
"RTN","DPTLK",34,0)
 ; -- Check for null response or abort
"RTN","DPTLK",35,0)
 I DPTX=""!(DPTX["^") G ASKPAT:DIC(0)["A",QK
"RTN","DPTLK",36,0)
 ; -- Check for question mark
"RTN","DPTLK",37,0)
 I DPTX["?" D  G ASKPAT:DIC(0)["A",QK
"RTN","DPTLK",38,0)
 .S D="B"
"RTN","DPTLK",39,0)
 .S DZ=$S(DPTX?1"?":"",1:"??")
"RTN","DPTLK",40,0)
 .G CHKPAT1:DZ="??"
"RTN","DPTLK",41,0)
 .N %
"RTN","DPTLK",42,0)
 .W !,?1,"Answer with PATIENT NAME, or SOCIAL SECURITY NUMBER, or last 4 digits",!,?4,"of SOCIAL SECURITY NUMBER, or first initial of"
"RTN","DPTLK",43,0)
 .W " last name with last",!,?4,"4 digits of SOCIAL SECURITY NUMBER"
"RTN","DPTLK",44,0)
 .W !,?1,"Do you want the entire ",+$P($G(^DPT(0)),"^",4),"-Entry PATIENT List" S %=0 D YN^DICN
"RTN","DPTLK",45,0)
 .Q:%'=1
"RTN","DPTLK",46,0)
 .S DZ="??"
"RTN","DPTLK",47,0)
CHKPAT1 .S X=DPTX
"RTN","DPTLK",48,0)
 .D DQ^DICQ
"RTN","DPTLK",49,0)
 ; -- Check for space bar, return
"RTN","DPTLK",50,0)
 I DPTX=" " D  G CHKDFN
"RTN","DPTLK",51,0)
 .S Y=$S('($D(DUZ)#2):-1,$D(^DISV(DUZ,"^DPT(")):^("^DPT("),1:-1)
"RTN","DPTLK",52,0)
 .D SETDPT^DPTLK1:Y>0
"RTN","DPTLK",53,0)
 .S DPTDFN=$S($D(DPTS(Y)):Y,1:-1)
"RTN","DPTLK",54,0)
 ; -- Check for DFN look up
"RTN","DPTLK",55,0)
 I $E(DPTX)="`" D  G CHKDFN
"RTN","DPTLK",56,0)
 .S Y=$S($D(^DPT(+$P(DPTX,"`",2),0)):+$P(DPTX,"`",2),1:-1)
"RTN","DPTLK",57,0)
 .D SETDPT^DPTLK1:Y>0
"RTN","DPTLK",58,0)
 .S DPTDFN=$S($D(DPTS(Y)):Y,1:-1)
"RTN","DPTLK",59,0)
 ; -- Puts input in correct format
"RTN","DPTLK",60,0)
 G CHKDFN:DPTX=""
"RTN","DPTLK",61,0)
 ; -- Force new entry
"RTN","DPTLK",62,0)
 I $E(DPTX)="""",$E(DPTX,$L(DPTX))="""" G NOPAT
"RTN","DPTLK",63,0)
 ; -- Check for index lookups
"RTN","DPTLK",64,0)
 D ^DPTLK1 G QK:$D(DTOUT)!($D(DUOUT)&(DIC(0)'["A")),ASKPAT:$D(DUOUT),CHKPAT:DPTDFN<0,CHKDFN:DPTDFN>0 I DIC(0)["N",$D(^DPT(DPTX,0)) S Y=X D SETDPT^DPTLK1 S DPTDFN=$S($D(DPTS(Y)):Y,1:-1) G CHKDFN
"RTN","DPTLK",65,0)
MAG ; -- No patient found, check for mag stripe input, create stub
"RTN","DPTLK",66,0)
 I 'MAG G NOPAT
"RTN","DPTLK",67,0)
 ; -- Check for ADT option(s) only
"RTN","DPTLK",68,0)
 N DGOPT
"RTN","DPTLK",69,0)
 S DGOPT=$P($G(XQY0),"^",2)
"RTN","DPTLK",70,0)
 I DGOPT'="Load/Edit Patient Data",DGOPT'="Register a Patient" D  G EN2
"RTN","DPTLK",71,0)
 .W !,"    ...Patient not in database, use ADT options to load patient" D Q1
"RTN","DPTLK",72,0)
 ; -- Prompt for creation of stub
"RTN","DPTLK",73,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="Patient not found...Create stub entry: "
"RTN","DPTLK",74,0)
 S GCHK=$D(^TMP("DGVIC"))
"RTN","DPTLK",75,0)
 D ^DIR
"RTN","DPTLK",76,0)
 K DIR
"RTN","DPTLK",77,0)
 I 'Y D Q1 G EN2
"RTN","DPTLK",78,0)
 ; -- Parse IATA fields
"RTN","DPTLK",79,0)
 D FIELDS(IATA)
"RTN","DPTLK",80,0)
 ; -- Check for Duplicates
"RTN","DPTLK",81,0)
 D EP2^DPTLK3
"RTN","DPTLK",82,0)
 I DPTDFN<0 D Q1 G EN2
"RTN","DPTLK",83,0)
 ; -- Creates Stub entry in patient file
"RTN","DPTLK",84,0)
 S Y=$$FILE^DPTLK4(DGFLDS)
"RTN","DPTLK",85,0)
 I $P(Y,"^",3)'=1 W !,"Could not add patient to patient file" D QK1 Q
"RTN","DPTLK",86,0)
 D QK1
"RTN","DPTLK",87,0)
 Q
"RTN","DPTLK",88,0)
 ;
"RTN","DPTLK",89,0)
NOPAT ; -- No patient found, ask to add new
"RTN","DPTLK",90,0)
 I DIC(0)["L" D ^DPTLK2 S Y=DPTDFN G ASKPAT:DIC(0)["A"&(Y<0)&('$G(DTOUT)),QK1
"RTN","DPTLK",91,0)
 ;
"RTN","DPTLK",92,0)
CHKDFN ; -- 
"RTN","DPTLK",93,0)
 S:'$D(DPTDFN) DPTDFN=-1 I DPTDFN'>0!('$D(DPTS(+DPTDFN))) W:DIC(0)["Q" *7," ??" G ASKPAT:DIC(0)["A",QK
"RTN","DPTLK",94,0)
 I DIC(0)["E" D  W $S('$D(DPTSEL)&('$D(DIVP)):$P(DPTS(DPTDFN),U,2)_"  "_$P(DPTS(DPTDFN),U)_"  ",$D(^DPT(DPTDFN,0)):"  "_$P(^(0),U)_"  ",1:"") S Y=DPTDFN X:$D(^DPT(DPTDFN,0)) "N DDS X DIC(""W"")"
"RTN","DPTLK",95,0)
 .I $D(DDS) D CLRMSG^DDS S DX=0,DY=DDSHBX+1 X DDXY
"RTN","DPTLK",96,0)
 ;
"RTN","DPTLK",97,0)
 ; check for other patients in "BS5" xref on Patient file
"RTN","DPTLK",98,0)
 I '$G(DICR),DPTDFN>0,DIC(0)["E",$$BS5^DPTLK5(+DPTDFN) D  G ASKPAT:DIC(0)["A"&(%'=1),QK:DPTDFN<0
"RTN","DPTLK",99,0)
 .N DPTZERO,DPTLSNME,DPTSSN S DPTZERO=$G(^DPT(+DPTDFN,0)),DPTLSNME=$P($P(DPTZERO,U),","),DPTSSN=$E($P(DPTZERO,U,9),6,9)
"RTN","DPTLK",100,0)
 .W $C(7),!!,"There is more than one patient whose last name is '",DPTLSNME,"' and"
"RTN","DPTLK",101,0)
 .W !,"whose social security number ends with '",DPTSSN,"'."
"RTN","DPTLK",102,0)
 .W !,"Are you sure you wish to continue (Y/N)" S %=0 D YN^DICN
"RTN","DPTLK",103,0)
 .I %'=1 S DPTDFN=-1
"RTN","DPTLK",104,0)
 ;
"RTN","DPTLK",105,0)
 I '$G(DICR),DPTDFN>0 S Y=DPTDFN D ^DGSEC S DPTDFN=Y G ASKPAT:DIC(0)["A"&(DPTDFN<0),QK:DPTDFN<0
"RTN","DPTLK",106,0)
 S DPTX=DPTX_$P(DPTS(DPTDFN),U,2),DPTDFN=DPTDFN_U_$P(^DPT(DPTDFN,0),U)
"RTN","DPTLK",107,0)
 ;
"RTN","DPTLK",108,0)
Q ; -- 
"RTN","DPTLK",109,0)
 S Y=$S('$D(DPTDFN):-1,'$D(DPTS(+DPTDFN)):-1,1:DPTDFN),X=$S($D(DPTX)&(+Y>0):DPTX,$D(DPTSAVX):DPTSAVX,$D(DPTX):DPTX,1:"")
"RTN","DPTLK",110,0)
 I Y>0 S:DIC(0)'["F" ^DISV($S($D(DUZ)#2:DUZ,1:0),"^DPT(")=+Y S:DIC(0)["Z" Y(0)=^DPT(+Y,0),Y(0,0)=$P(^(0),U,1)
"RTN","DPTLK",111,0)
 I DIC(0)["E",$P($G(^DPT(+Y,0)),U,21) W *7,!,"Warning : You have selected a test patient."
"RTN","DPTLK",112,0)
 ;Display enrollment information
"RTN","DPTLK",113,0)
 I Y>0,DIC(0)["E" D ENR
"RTN","DPTLK",114,0)
 ;
"RTN","DPTLK",115,0)
 ;Call Combat Vet check
"RTN","DPTLK",116,0)
 I Y>0,DIC(0)["E" D CV
"RTN","DPTLK",117,0)
 ;
"RTN","DPTLK",118,0)
 ; check whether to display Means Test Required message
"RTN","DPTLK",119,0)
 D
"RTN","DPTLK",120,0)
 .N DPTDIV
"RTN","DPTLK",121,0)
 .I '$G(DUZ(2)) Q
"RTN","DPTLK",122,0)
 .I Y>0,DIC(0)["E" S DPTDIV=$$DMT^DPTLK5(+Y,DUZ(2)) I DPTDIV D
"RTN","DPTLK",123,0)
 ..W $C(7),!!,"MEANS TEST REQUIRED"
"RTN","DPTLK",124,0)
 ..W !,?3,$P($G(^DG(40.8,DPTDIV,"MT")),U,2)
"RTN","DPTLK",125,0)
 ..H 2
"RTN","DPTLK",126,0)
 ;
"RTN","DPTLK",127,0)
Q1 ; -- Clean up variables
"RTN","DPTLK",128,0)
 K D,DIC("W"),DO,DPTCNT,DPTDFN,DPTIFNS,DPTIX,DPTS
"RTN","DPTLK",129,0)
 K DPTSAVX,DPTSEL,DPTSZ,DPTX
"RTN","DPTLK",130,0)
 ;
"RTN","DPTLK",131,0)
 K:$D(IATA) IATA
"RTN","DPTLK",132,0)
 K:$D(DGFLDS) @DGFLDS,DGFLDS
"RTN","DPTLK",133,0)
 Q
"RTN","DPTLK",134,0)
 ;
"RTN","DPTLK",135,0)
QK K:'$D(DPTNOFZK) DPTNOFZY G Q
"RTN","DPTLK",136,0)
 ;
"RTN","DPTLK",137,0)
QK1 K:'$D(DPTNOFZK) DPTNOFZY G Q1
"RTN","DPTLK",138,0)
 ;
"RTN","DPTLK",139,0)
IX ; --
"RTN","DPTLK",140,0)
 I $D(D),$D(^DD(2,0,"IX",D)),($E(D)'="A") S DPTIX=D
"RTN","DPTLK",141,0)
 G DPTLK
"RTN","DPTLK",142,0)
 ;
"RTN","DPTLK",143,0)
IATA(X) ; --
"RTN","DPTLK",144,0)
 ;This function pulls off ssn from the IATA track
"RTN","DPTLK",145,0)
 ;
"RTN","DPTLK",146,0)
 ;Input:  X   -  what was read in
"RTN","DPTLK",147,0)
 ;Output: SSN -  social security number
"RTN","DPTLK",148,0)
 ;          Q -  quit
"RTN","DPTLK",149,0)
 ;
"RTN","DPTLK",150,0)
 ; Track            Start Sent     End Sent      Field Separator
"RTN","DPTLK",151,0)
 ; -----            ----------     --------      ---------------
"RTN","DPTLK",152,0)
 ;  IATA (alphanum)      %             ?          {   (Note: VA used ^)
"RTN","DPTLK",153,0)
 ;  ABA (numeric)        ;             ?          =    
"RTN","DPTLK",154,0)
 ;
"RTN","DPTLK",155,0)
 ;N IATA
"RTN","DPTLK",156,0)
 S (IATA)=""
"RTN","DPTLK",157,0)
 I $E(X)'="%" Q X ; no start sentinel
"RTN","DPTLK",158,0)
 I X'["?" Q "Q"
"RTN","DPTLK",159,0)
 ; -- Extract data from track
"RTN","DPTLK",160,0)
 S IATA=$$TRACK(X,"%","?")
"RTN","DPTLK",161,0)
 ; -- checks for no data
"RTN","DPTLK",162,0)
 I IATA="" Q "Q"
"RTN","DPTLK",163,0)
 ; -- Returns SSN
"RTN","DPTLK",164,0)
 I IATA'="" Q $P(IATA,"^")
"RTN","DPTLK",165,0)
 Q "Q"
"RTN","DPTLK",166,0)
 ;
"RTN","DPTLK",167,0)
TRACK(X,START,END) ; find track where start/end are sentinels
"RTN","DPTLK",168,0)
 ;
"RTN","DPTLK",169,0)
 Q $P($P($G(X),START,2),END,1)
"RTN","DPTLK",170,0)
 ;
"RTN","DPTLK",171,0)
FIELDS(IATA) ; -- Sets fields
"RTN","DPTLK",172,0)
 Q:'$D(IATA)
"RTN","DPTLK",173,0)
 N CNT,FIELD
"RTN","DPTLK",174,0)
 S DGFLDS="^TMP(""DGVIC"","_$J_")",CNT=1
"RTN","DPTLK",175,0)
 K @DGFLDS
"RTN","DPTLK",176,0)
 F  S FIELD=$P($G(IATA),"^",CNT)  Q:FIELD=""  D
"RTN","DPTLK",177,0)
 .S @DGFLDS@(CNT)=FIELD
"RTN","DPTLK",178,0)
 .S CNT=CNT+1
"RTN","DPTLK",179,0)
 ; -- Define fields for duplicate checker
"RTN","DPTLK",180,0)
 S DPTX=$G(@DGFLDS@(2)) ;NAME
"RTN","DPTLK",181,0)
 S DPTIDS(.03)=$G(@DGFLDS@(3)) ;DOB
"RTN","DPTLK",182,0)
 S DPTIDS(.09)=$G(@DGFLDS@(1)) ;SSN
"RTN","DPTLK",183,0)
 Q
"RTN","DPTLK",184,0)
ENR ;Display Enrollment information after patient selection
"RTN","DPTLK",185,0)
 N DGENCAT,DGENDFN,DGENR,DGEGTIEN,DGEGT
"RTN","DPTLK",186,0)
 I '$$GET^DGENA($$FINDCUR^DGENA(+DPTDFN),.DGENR) Q
"RTN","DPTLK",187,0)
 S DGENCAT=$$CATEGORY^DGENA4(+DPTDFN)
"RTN","DPTLK",188,0)
 S DGENCAT=$$EXTERNAL^DILFD(27.15,.02,"",DGENCAT)
"RTN","DPTLK",189,0)
 W !?1,"Enrollment Priority: ",$S($G(DGENR("PRIORITY")):$$EXT^DGENU("PRIORITY",DGENR("PRIORITY")),1:""),$S($G(DGENR("SUBGRP"))="":"",1:$$EXT^DGENU("SUBGRP",$G(DGENR("SUBGRP"))))
"RTN","DPTLK",190,0)
 W ?33,"Category: ",DGENCAT
"RTN","DPTLK",191,0)
 W ?57,"End Date: ",$S($G(DGENR("END")):$$FMTE^XLFDT(DGENR("END"),"5DZ"),1:""),!
"RTN","DPTLK",192,0)
 ;If patient is NOT ELIGIBLE, display Enrollment Status (Ineligible Project Phase I)
"RTN","DPTLK",193,0)
 I $G(DGENR("STATUS"))=10!($G(DGENR("STATUS"))=19)!($G(DGENR("STATUS"))=20) D
"RTN","DPTLK",194,0)
 . W ?1,"Enrollment Status: ",$S($G(DGENR("STATUS")):$$EXT^DGENU("STATUS",DGENR("STATUS")),1:"") ;H 5
"RTN","DPTLK",195,0)
 ;check for Combat Veteran Eligibility, if elig do not display EGT info
"RTN","DPTLK",196,0)
 I $$CVEDT^DGCV(+DPTDFN) Q
"RTN","DPTLK",197,0)
 ;Get Enrollment Group Threshold Priority and Subgroup
"RTN","DPTLK",198,0)
 S DGEGTIEN=$$FINDCUR^DGENEGT
"RTN","DPTLK",199,0)
 S DGEGT=$$GET^DGENEGT(DGEGTIEN,.DGEGT)
"RTN","DPTLK",200,0)
 Q:$G(DGENR("PRIORITY"))=""!($G(DGEGT("PRIORITY"))="")
"RTN","DPTLK",201,0)
 ;Compare Patient's Enrollment Priority to Enrollment Group Threshold
"RTN","DPTLK",202,0)
 I '$$ABOVE^DGENEGT1(+DPTDFN,DGENR("PRIORITY"),$G(DGENR("SUBGRP")),DGEGT("PRIORITY"),DGEGT("SUBGRP")) D
"RTN","DPTLK",203,0)
 .N X,IORVOFF,IORVON
"RTN","DPTLK",204,0)
 .S X="IORVOFF;IORVON"
"RTN","DPTLK",205,0)
 .D ENDR^%ZISS
"RTN","DPTLK",206,0)
 .W !?32 W:$D(IORVON) IORVON  W "*** WARNING ***" W:$D(IORVOFF) IORVOFF
"RTN","DPTLK",207,0)
 .I DGENR("END")'="" W !?14 W:$D(IORVON) IORVON W "*** PATIENT ENROLLMENT END",$S(DT>+DGENR("END"):"ED",1:"S")," EFFECTIVE ",$$FMTE^XLFDT(DGENR("END"),"5DZ")," ***" W:$D(IORVOFF) IORVOFF Q
"RTN","DPTLK",208,0)
 .W !?5 W:$D(IORVON) IORVON W "*** PATIENT ENROLLMENT ENDING.  ENROLLMENT END DATE IS NOT KNOWN. ***" W:$D(IORVOFF) IORVOFF
"RTN","DPTLK",209,0)
 Q
"RTN","DPTLK",210,0)
CV ;check for Combat Vet status
"RTN","DPTLK",211,0)
 N DGCV
"RTN","DPTLK",212,0)
 S DGCV=$$CVEDT^DGCV(+DPTDFN)
"RTN","DPTLK",213,0)
 I $P(DGCV,U)=1 D  Q
"RTN","DPTLK",214,0)
 . I '$$GET^DGENA($$FINDCUR^DGENA(+DPTDFN),.DGENR) W !
"RTN","DPTLK",215,0)
 . W ?3,"Combat Vet Status: "_$S($P(DGCV,U,3)=1:"ELIGIBLE",1:"EXPIRED"),?57,"End Date: "_$$FMTE^XLFDT($P(DGCV,U,2),"5DZ")
"RTN","DPTLK",216,0)
 Q
"VER")
8.0^22
**END**
**END**
