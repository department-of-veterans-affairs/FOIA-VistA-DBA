Released RG*1*31 SEQ #32
Extracted from mail message
**KIDS**:RG*1.0*31^

**INSTALL NAME**
RG*1.0*31
"BLD",1793,0)
RG*1.0*31^CLINICAL INFO RESOURCE NETWORK^0^3031024^y
"BLD",1793,1,0)
^^3^3^3031024^
"BLD",1793,1,1,0)
MONITORING, PDAT & ZPD SEGMENT
"BLD",1793,1,2,0)
Refer to patch RG*1*31 in the FORUM Patch Module for a complete
"BLD",1793,1,3,0)
description.
"BLD",1793,4,0)
^9.64PA^^
"BLD",1793,"ABNS",0)
^9.66A^^
"BLD",1793,"ABPKG")
^^
"BLD",1793,"KRN",0)
^9.67PA^8989.52^19
"BLD",1793,"KRN",.4,0)
.4
"BLD",1793,"KRN",.401,0)
.401
"BLD",1793,"KRN",.402,0)
.402
"BLD",1793,"KRN",.403,0)
.403
"BLD",1793,"KRN",.5,0)
.5
"BLD",1793,"KRN",.84,0)
.84
"BLD",1793,"KRN",3.6,0)
3.6
"BLD",1793,"KRN",3.8,0)
3.8
"BLD",1793,"KRN",9.2,0)
9.2
"BLD",1793,"KRN",9.8,0)
9.8
"BLD",1793,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",1793,"KRN",9.8,"NM",1,0)
RGADT1^^0^B41036585
"BLD",1793,"KRN",9.8,"NM",2,0)
RGMTMONX^^0^B66458164
"BLD",1793,"KRN",9.8,"NM",3,0)
RGMTMONT^^0^B37731232
"BLD",1793,"KRN",9.8,"NM",4,0)
RGEX05^^0^B6586293
"BLD",1793,"KRN",9.8,"NM",5,0)
RGRPDAT^^0^B52100073
"BLD",1793,"KRN",9.8,"NM",6,0)
RGMTUT01^^0^B78431432
"BLD",1793,"KRN",9.8,"NM","B","RGADT1",1)

"BLD",1793,"KRN",9.8,"NM","B","RGEX05",4)

"BLD",1793,"KRN",9.8,"NM","B","RGMTMONT",3)

"BLD",1793,"KRN",9.8,"NM","B","RGMTMONX",2)

"BLD",1793,"KRN",9.8,"NM","B","RGMTUT01",6)

"BLD",1793,"KRN",9.8,"NM","B","RGRPDAT",5)

"BLD",1793,"KRN",19,0)
19
"BLD",1793,"KRN",19,"NM",0)
^9.68A^^
"BLD",1793,"KRN",19.1,0)
19.1
"BLD",1793,"KRN",101,0)
101
"BLD",1793,"KRN",409.61,0)
409.61
"BLD",1793,"KRN",771,0)
771
"BLD",1793,"KRN",870,0)
870
"BLD",1793,"KRN",8989.51,0)
8989.51
"BLD",1793,"KRN",8989.52,0)
8989.52
"BLD",1793,"KRN",8994,0)
8994
"BLD",1793,"KRN",8994,"NM",0)
^9.68A^^
"BLD",1793,"KRN","B",.4,.4)

"BLD",1793,"KRN","B",.401,.401)

"BLD",1793,"KRN","B",.402,.402)

"BLD",1793,"KRN","B",.403,.403)

"BLD",1793,"KRN","B",.5,.5)

"BLD",1793,"KRN","B",.84,.84)

"BLD",1793,"KRN","B",3.6,3.6)

"BLD",1793,"KRN","B",3.8,3.8)

"BLD",1793,"KRN","B",9.2,9.2)

"BLD",1793,"KRN","B",9.8,9.8)

"BLD",1793,"KRN","B",19,19)

"BLD",1793,"KRN","B",19.1,19.1)

"BLD",1793,"KRN","B",101,101)

"BLD",1793,"KRN","B",409.61,409.61)

"BLD",1793,"KRN","B",771,771)

"BLD",1793,"KRN","B",870,870)

"BLD",1793,"KRN","B",8989.51,8989.51)

"BLD",1793,"KRN","B",8989.52,8989.52)

"BLD",1793,"KRN","B",8994,8994)

"BLD",1793,"QUES",0)
^9.62^^
"BLD",1793,"REQB",0)
^9.611^2^2
"BLD",1793,"REQB",1,0)
RG*1.0*28^2
"BLD",1793,"REQB",2,0)
RG*1.0*30^2
"BLD",1793,"REQB","B","RG*1.0*28",1)

"BLD",1793,"REQB","B","RG*1.0*30",2)

"MBREQ")
0
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^^0
"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
31^3031024
"PKG",272,22,1,"PAH",1,1,0)
^^3^3^3031024
"PKG",272,22,1,"PAH",1,1,1,0)
MONITORING, PDAT & ZPD SEGMENT
"PKG",272,22,1,"PAH",1,1,2,0)
Refer to patch RG*1*31 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","RGADT1")
0^1^B41036585
"RTN","RGADT1",1,0)
RGADT1 ;HIRMFO/GJC-BUILD ADT MESSAGES (A01/A03) ;09/21/99
"RTN","RGADT1",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4,14,17,27,28,31**;30 Apr 99
"RTN","RGADT1",3,0)
 Q  ; quit if called from the top
"RTN","RGADT1",4,0)
 ;
"RTN","RGADT1",5,0)
EN ; entry point to build/transmit ADT messages
"RTN","RGADT1",6,0)
 ; Messages built by this software are fired off by server protocols:
"RTN","RGADT1",7,0)
 ; RG ADT-A01 SERVER -or- RG ADT-A03 SERVER
"RTN","RGADT1",8,0)
 ;
"RTN","RGADT1",9,0)
 ; This code is called from the RG ADT INPATIENT ENCOUNTER DRIVER &
"RTN","RGADT1",10,0)
 ; RG ADT OUTPATIENT ENCOUNTER DRIVER protocols.
"RTN","RGADT1",11,0)
 ;
"RTN","RGADT1",12,0)
 ; RG ADT OUTPATIENT ENCOUNTER DRIVER is an item protocol under the
"RTN","RGADT1",13,0)
 ; SDAM APPOINTMENTS EVENTS protocol & RG ADT INPATIENT ENCOUNTER DRIVER
"RTN","RGADT1",14,0)
 ; hangs off of the DGPM MOVEMENT EVENTS protocol.
"RTN","RGADT1",15,0)
 ;
"RTN","RGADT1",16,0)
 ; RG ADT OUTPATIENT ENCOUNTER DRIVER hangs off of SDAM APPOINTMENTS
"RTN","RGADT1",17,0)
 ; EVENTS because of DBIA: 1320; RG ADT INPATIENT ENCOUNTER DRIVER
"RTN","RGADT1",18,0)
 ; hangs off of DGPM MOVEMENT EVENTS because of DBIA: 1181.
"RTN","RGADT1",19,0)
 ;
"RTN","RGADT1",20,0)
 ; Integration Agreements (IAs) utilized in this application:
"RTN","RGADT1",21,0)
 ; #1181-subscribers for the DGPM MOVEMENT EVENTS event driver
"RTN","RGADT1",22,0)
 ; #1320-subscribers for the SDAM APPOINTMENT EVENTS event driver
"RTN","RGADT1",23,0)
 ; #2070-check for a national ICN 1st piece, "MPI" node (global read)
"RTN","RGADT1",24,0)
 ; #2161-INIT^HLFNC2
"RTN","RGADT1",25,0)
 ; #2164-GENERATE^HLMA
"RTN","RGADT1",26,0)
 ; #2171-$$WHAT^XUAF4 (Name_"^"_Station Number, we're after Station #)
"RTN","RGADT1",27,0)
 ; #2541-$$KSP^XUPARAM (facility ien, file 4)
"RTN","RGADT1",28,0)
 ; #2624-$$SEND^VAFHUTL()
"RTN","RGADT1",29,0)
 ; #3015-PID segment generation (CIRN PD)
"RTN","RGADT1",30,0)
 ; #3016-EVN segment generation (CIRN PD)
"RTN","RGADT1",31,0)
 ; #3017-PD1 segment generator (CIRN PD)
"RTN","RGADT1",32,0)
 ; #3018-PV1 segment generator (CIRN PD)
"RTN","RGADT1",33,0)
 ; #3072-assign a local ICN to a patient
"RTN","RGADT1",34,0)
 ; #3630-BLDEVN^VAFCQRY, BLDPD1^VAFCQRY & BLDPID^VAFCQRY
"RTN","RGADT1",35,0)
 ; #2988-FILE^VAFCTFU
"RTN","RGADT1",36,0)
 ;
"RTN","RGADT1",37,0)
 ; I $D(RGDG101) then we know we've dropped into this software
"RTN","RGADT1",38,0)
 ; from the DGPM MOVEMENT EVENTS protocol (RG ADT INPATIENT
"RTN","RGADT1",39,0)
 ; ENCOUNTER DRIVER)
"RTN","RGADT1",40,0)
 ;
"RTN","RGADT1",41,0)
 ; Note: DFN is a supported variable in the case of admissions and
"RTN","RGADT1",42,0)
 ; discharges within the Registration package. (part of the discovery
"RTN","RGADT1",43,0)
 ; in the development of RG*1.0*14)
"RTN","RGADT1",44,0)
 ;
"RTN","RGADT1",45,0)
 ; first check if HL7 2.3 messaging has been disabled.  DBIA: 2624
"RTN","RGADT1",46,0)
 I '$P($$SEND^VAFHUTL(),"^",2) Q
"RTN","RGADT1",47,0)
 S RGOK=0,RGDATE=""
"RTN","RGADT1",48,0)
 I $D(RGDG101) D
"RTN","RGADT1",49,0)
 . I $G(DFN)'=+$G(DFN) Q  ; DFN must be valid
"RTN","RGADT1",50,0)
 .; if an national ICN is missing, assign a local then quit
"RTN","RGADT1",51,0)
 . I '$P($G(^DPT(DFN,"MPI")),"^") S RGLOCAL=$$ICNLC^MPIF001(DFN) Q
"RTN","RGADT1",52,0)
 . Q:$$IFLOCAL^MPIF001(DFN)  ; IA 2701, patient has local icn, quit
"RTN","RGADT1",53,0)
 . N %,VAERR,VAIP
"RTN","RGADT1",54,0)
 . S VAIP("D")="LAST" D IN5^VADPT ; dfn should be defined at this point
"RTN","RGADT1",55,0)
 . S RGTYPE=+$G(VAIP(2)) ; RGTYPE=movement type
"RTN","RGADT1",56,0)
 . I RGTYPE'=1&(RGTYPE'=3) Q  ; admission or discharges only
"RTN","RGADT1",57,0)
 . S RGENVR=$S(RGTYPE=1:"A1",1:"A2") ; A1=admission, A2=discharge
"RTN","RGADT1",58,0)
 . S RGDATE=$P($G(VAIP(3)),"^"),RGMOV=$G(VAIP(1))
"RTN","RGADT1",59,0)
 . ; RGDATE=movement date/time, RGMOV=ien #405
"RTN","RGADT1",60,0)
 . S:RGDATE]"" RGOK=1
"RTN","RGADT1",61,0)
 . Q
"RTN","RGADT1",62,0)
 ;
"RTN","RGADT1",63,0)
 ; I $D(RGSD101) then we know we've dropped into this software
"RTN","RGADT1",64,0)
 ; from the SDAM APPOINTMENT EVENTS protocol (RG ADT OUTPATIENT
"RTN","RGADT1",65,0)
 ; ENCOUNTER DRIVER)
"RTN","RGADT1",66,0)
 ;
"RTN","RGADT1",67,0)
 ; Check SDAMEVT for values between five and nine inclusive.  See if
"RTN","RGADT1",68,0)
 ; this particular outpatient encounter has a status of CHECKED OUT.
"RTN","RGADT1",69,0)
 ; gjc@Hines OI for patch 14
"RTN","RGADT1",70,0)
 ;
"RTN","RGADT1",71,0)
 ; Note: DFN is not a supported variable in the case of clinic
"RTN","RGADT1",72,0)
 ; appointments and workload crediting for count clinics within the
"RTN","RGADT1",73,0)
 ; Scheduling package. (part of the discovery in the development of
"RTN","RGADT1",74,0)
 ; RG*1.0*14)
"RTN","RGADT1",75,0)
 ;
"RTN","RGADT1",76,0)
 ; check-out, stop code add/edit, disp add/edit?
"RTN","RGADT1",77,0)
 N I
"RTN","RGADT1",78,0)
 I $D(RGSD101),($D(SDAMEVT))#2 N DFN D
"RTN","RGADT1",79,0)
 . ; Note: DFN is unstable; it's up to us to define it...
"RTN","RGADT1",80,0)
 . ;chk-out, stop code add, stop code change, disp add & disp change
"RTN","RGADT1",81,0)
 . I SDAMEVT<5!(SDAMEVT>9) Q
"RTN","RGADT1",82,0)
 . S RGTYPE=SDAMEVT,RGENVR="A3"
"RTN","RGADT1",83,0)
 . N RGSDOE,RGPARSE,RGPROC,RGTMP S RGPROC=0
"RTN","RGADT1",84,0)
 . F  S RGPROC=$O(^TMP("SDEVT",$J,SDHDL,RGPROC)) Q:'RGPROC  D
"RTN","RGADT1",85,0)
 .. S RGSDOE=0
"RTN","RGADT1",86,0)
 .. F  S RGSDOE=$O(^TMP("SDEVT",$J,SDHDL,RGPROC,"SDOE",RGSDOE)) Q:'RGSDOE  D
"RTN","RGADT1",87,0)
 ... S RGSDOE(0)=$G(^TMP("SDEVT",$J,SDHDL,RGPROC,"SDOE",RGSDOE,0,"AFTER"))
"RTN","RGADT1",88,0)
 ... ; Note: RGSDOE(0)=zero node of 409.68, DFN is the second piece 
"RTN","RGADT1",89,0)
 ... S DFN=$P(RGSDOE(0),"^",2) Q:'DFN  ; DFN must exist
"RTN","RGADT1",90,0)
 ... ; ignore current inpatients
"RTN","RGADT1",91,0)
 ... Q:$L($G(^DPT(DFN,.1)))  ; ward location check IA: 10035
"RTN","RGADT1",92,0)
 ...; if an national ICN is missing, assign a local then quit
"RTN","RGADT1",93,0)
 ... I '$P($G(^DPT(DFN,"MPI")),"^") S RGLOCAL=$$ICNLC^MPIF001(DFN) Q
"RTN","RGADT1",94,0)
 ... Q:$$IFLOCAL^MPIF001(DFN)  ; IA 2701, patient has local icn, quit
"RTN","RGADT1",95,0)
 ... K RGPARSE D PARSE^SDOE(.RGSDOE,"EXTERNAL","RGPARSE")
"RTN","RGADT1",96,0)
 ... I $G(RGPARSE(.12))="CHECKED OUT" S RGTMP=$P(RGSDOE(0),U)
"RTN","RGADT1",97,0)
 ... S:$G(RGTMP)>RGDATE RGDATE=RGTMP
"RTN","RGADT1",98,0)
 ... Q
"RTN","RGADT1",99,0)
 .. Q
"RTN","RGADT1",100,0)
 . S:$G(RGDATE)]"" RGOK=1
"RTN","RGADT1",101,0)
 . Q
"RTN","RGADT1",102,0)
 ; S ^TMP("RGTRACE",$J)=1
"RTN","RGADT1",103,0)
 I 'RGOK K RGLOCAL,RGTYPE,RGMOV,RGDATE,RGENVR,RGOK Q  ; quit if not A01 or A03
"RTN","RGADT1",104,0)
 I '($G(DGQUIET)) S:$D(^TMP("RGTRACE",$J)) RGTRACE=1
"RTN","RGADT1",105,0)
 N RGSITE S RGSITE=+$$SITE^VASITE
"RTN","RGADT1",106,0)
 ;before updating and broadcasting check to see if the date and/or event changed
"RTN","RGADT1",107,0)
 N LIST,X,OUT,RGCHNG,RGDLT,RGEVN D TFL^VAFCTFU1(.LIST,DFN) S (RGCHNG,OUT,X)=0 F  S X=$O(LIST(X)) Q:'X!(OUT=1)  D
"RTN","RGADT1",108,0)
 . S RGDATE=$P(RGDATE,"."),RGDLT=$P(LIST(X),"^",3),RGDLT=$P(RGDLT,"."),RGEVN=$P(LIST(X),"^",4)
"RTN","RGADT1",109,0)
 . I $P(LIST(X),"^")=$P($$SITE^VASITE,"^",3) S OUT=1 D
"RTN","RGADT1",110,0)
 .. I RGDATE'=RGDLT D  Q
"RTN","RGADT1",111,0)
 ... I RGDATE>RGDLT S RGCHNG=1
"RTN","RGADT1",112,0)
 .. I RGDATE=RGDLT D
"RTN","RGADT1",113,0)
 .. I $E(RGENVR,2)'=RGEVN D
"RTN","RGADT1",114,0)
 ... I RGENVR="A3" S RGCHNG=0
"RTN","RGADT1",115,0)
 ... I RGENVR="A1" S RGCHNG=1
"RTN","RGADT1",116,0)
 ... I RGENVR="A2" S RGCHNG=1
"RTN","RGADT1",117,0)
 ;if no change in DLT or Event Reason quit
"RTN","RGADT1",118,0)
 Q:RGCHNG=0
"RTN","RGADT1",119,0)
 D FILE^VAFCTFU(DFN,RGSITE_"^"_$G(RGDATE)_"^"_$G(RGENVR),1)
"RTN","RGADT1",120,0)
 ;do FILE^VAFCTFU to update DLT and event reason
"RTN","RGADT1",121,0)
 I $D(RGTRACE) D EVENT,EXIT Q
"RTN","RGADT1",122,0)
 N ZTDESC,ZTRTN,ZTSAVE,ZTIO,ZTDTH
"RTN","RGADT1",123,0)
 S ZTDESC="CIRN HL7 ADT-"_$S(RGTYPE=1:"A01",1:"A03")_" Messaging"
"RTN","RGADT1",124,0)
 S ZTRTN="EVENT^RGADT1",ZTIO="",ZTDTH=$H
"RTN","RGADT1",125,0)
 F I="DFN","RGDATE","RGTYPE","RGENVR" S ZTSAVE(I)=""
"RTN","RGADT1",126,0)
 ; check for $D of RGDG101 & RGSD101 need to know protocol executed
"RTN","RGADT1",127,0)
 S:$D(RGDG101) ZTSAVE("RGDG101")="" S:$D(RGSD101) ZTSAVE("RGSD101")=""
"RTN","RGADT1",128,0)
 S:$D(RGMOV) ZTSAVE("RGMOV")="" ; defined for admissions & discharges
"RTN","RGADT1",129,0)
 S:$D(SDOE) ZTSAVE("SDOE")="" ; file ien: 409.68, clinic check out
"RTN","RGADT1",130,0)
 D ^%ZTLOAD,EXIT
"RTN","RGADT1",131,0)
 K DGQUIET
"RTN","RGADT1",132,0)
 Q
"RTN","RGADT1",133,0)
 ;
"RTN","RGADT1",134,0)
EVENT ; build the HL7 message
"RTN","RGADT1",135,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","RGADT1",136,0)
 S RGEVT=$S(RGTYPE=1:"A01",1:"A03") K HL
"RTN","RGADT1",137,0)
 D INIT^HLFNC2("RG ADT-"_RGEVT_" 2.4 SERVER",.HL)
"RTN","RGADT1",138,0)
 I $G(HL) Q  ; error
"RTN","RGADT1",139,0)
 D BUILD
"RTN","RGADT1",140,0)
 D GENERATE^HLMA("RG ADT-"_RGEVT_" 2.4 SERVER","LM",1,.RGRSLT,"",.HL)
"RTN","RGADT1",141,0)
 D KILL^HLTRANS
"RTN","RGADT1",142,0)
 K HLA("HLS"),RGDATE,RGDG101,RGENVR,RGEVT,RGSD101,RGTYPE
"RTN","RGADT1",143,0)
 Q
"RTN","RGADT1",144,0)
EXIT ; kill and quit
"RTN","RGADT1",145,0)
 K ^TMP("RGTRACE",$J),RGDATE,RGENVR,RGEVT,RGOK,RGLOCAL,RGMOV,RGPAT
"RTN","RGADT1",146,0)
 K RGRSLT,RGFSTR,RGTRACE,RGTYPE
"RTN","RGADT1",147,0)
 Q
"RTN","RGADT1",148,0)
BUILD ; build the ADT message
"RTN","RGADT1",149,0)
 ; EVN segment
"RTN","RGADT1",150,0)
 N CNT,ERR,EVN,RGCNT,SEQ
"RTN","RGADT1",151,0)
 S RGCNT=1
"RTN","RGADT1",152,0)
 D BLDEVN^VAFCQRY(DFN,"1,2,4,5,6,7",.EVN,.HL,$G(HL("ETN")))
"RTN","RGADT1",153,0)
 S HLA("HLS",RGCNT)=$G(EVN(1)) S RGCNT=RGCNT+1
"RTN","RGADT1",154,0)
 N PID S SEQ="1,3,5,6,7,8,11,29" D BLDPID^VAFCQRY(DFN,1,.SEQ,.PID,.HL,.ERR) S HLA("HLS",RGCNT)=PID(1) S X=1,CNT=1 F  S X=$O(PID(X)) Q:'X  I $D(PID(X)) S HLA("HLS",RGCNT,CNT)=PID(X),CNT=CNT+1
"RTN","RGADT1",155,0)
 S RGCNT=RGCNT+1
"RTN","RGADT1",156,0)
 ; PD1 segment
"RTN","RGADT1",157,0)
 N PD1
"RTN","RGADT1",158,0)
 S SEQ="3" D BLDPD1^VAFCQRY(DFN,.SEQ,.PD1,.HL,.ERR) S HLA("HLS",RGCNT)=PD1(1)
"RTN","RGADT1",159,0)
 S RGCNT=RGCNT+1
"RTN","RGADT1",160,0)
 ; PV1 segment
"RTN","RGADT1",161,0)
 S RGFSTR="2,3,4,5,"_$$COMMANUM(7,45)
"RTN","RGADT1",162,0)
 ;for admission/discharges (registration)
"RTN","RGADT1",163,0)
 I RGTYPE=1!(RGTYPE=3) S HLA("HLS",4)=$$IN^VAFHLPV1(DFN,RGDATE,RGFSTR,RGMOV,"","")
"RTN","RGADT1",164,0)
 ;for scheduling events: checkout
"RTN","RGADT1",165,0)
 I RGTYPE'=1&(RGTYPE'=3) S HLA("HLS",4)=$$EN^VAFHLPV1("",,RGFSTR,,HL("Q"),HL("FS"))
"RTN","RGADT1",166,0)
 S HLA("HLS",4)=$$FAC(HLA("HLS",4))
"RTN","RGADT1",167,0)
 ; adding ZPD segment for POW Status - patch P
"RTN","RGADT1",168,0)
 S HLA("HLS",5)=$$EN^VAFHLZPD(DFN,17)
"RTN","RGADT1",169,0)
 Q
"RTN","RGADT1",170,0)
COMMANUM(FROM,TO) ;Build comma seperated list of numbers
"RTN","RGADT1",171,0)
 ;Input  : FROM - Starting number (default = 1)
"RTN","RGADT1",172,0)
 ;                   TO - Ending number (default = FROM)
"RTN","RGADT1",173,0)
 ;Output : Comma separated list of numbers between FROM and TO
"RTN","RGADT1",174,0)
 ;             (Ex: 1,2,3)
"RTN","RGADT1",175,0)
 ;Notes  : Call assumes FROM <= TO
"RTN","RGADT1",176,0)
 ;             copied from COMMANUM^VAFCADT2
"RTN","RGADT1",177,0)
 ;
"RTN","RGADT1",178,0)
 S FROM=$G(FROM) S:(FROM="") FROM=1
"RTN","RGADT1",179,0)
 S TO=$G(TO) S:(TO="") TO=FROM
"RTN","RGADT1",180,0)
 N OUTPUT,X
"RTN","RGADT1",181,0)
 S OUTPUT=FROM
"RTN","RGADT1",182,0)
 F X=(FROM+1):1:TO S OUTPUT=(OUTPUT_","_X)
"RTN","RGADT1",183,0)
 Q OUTPUT
"RTN","RGADT1",184,0)
 ;
"RTN","RGADT1",185,0)
FAC(X) ; set facility information, in the form of the Station Number, into
"RTN","RGADT1",186,0)
 ; PV1(3).
"RTN","RGADT1",187,0)
 ; input: the entire PV1 segment
"RTN","RGADT1",188,0)
 ; yield: updated PV1 segment; PV1(3) has facility information (Sta. #)
"RTN","RGADT1",189,0)
 N Y0,Y1 S Y0=$E(HL("ECH"),$L(HL("ECH")))_$$WHAT^XUAF4(+$$KSP^XUPARAM("INST"),99)
"RTN","RGADT1",190,0)
 S Y1=$P(X,HL("FS"),4),$P(Y1,$E(HL("ECH")),4)=Y0,$P(X,HL("FS"),4)=Y1
"RTN","RGADT1",191,0)
 Q X
"RTN","RGEX05")
0^4^B6586293
"RTN","RGEX05",1,0)
RGEX05 ;BAY/ALS-LISTMANAGER ROUTINE FOR REMOTE PDAT IN EXCEPTION HANDLER ;10/04/01
"RTN","RGEX05",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**23,20,31**;30 Apr 99
"RTN","RGEX05",3,0)
 ;Reference to RPCCHK^XWB2HL7 supported by IA #3144
"RTN","RGEX05",4,0)
 ;Reference to RTNDATA^XWBDRPC supported by IA #3149
"RTN","RGEX05",5,0)
EN(ICN) ;main entry point for RG EXCPT REMOTE PDAT
"RTN","RGEX05",6,0)
 D EN^VALM("RG EXCPT RPDAT")
"RTN","RGEX05",7,0)
 Q
"RTN","RGEX05",8,0)
HDR ;header code
"RTN","RGEX05",9,0)
 S VALMHDR(1)="MPI/PD REMOTE PATIENT DATA"
"RTN","RGEX05",10,0)
 S VALMHDR(2)=""
"RTN","RGEX05",11,0)
 Q
"RTN","RGEX05",12,0)
INIT ;
"RTN","RGEX05",13,0)
 K ^TMP("RGEXC5",$J)
"RTN","RGEX05",14,0)
 K @VALMAR
"RTN","RGEX05",15,0)
 I '$D(ICN) G EXIT
"RTN","RGEX05",16,0)
 S LIN=1,X=0,STR="",TXT=""
"RTN","RGEX05",17,0)
 S TXT="-> For ICN "_$P(ICN,"V",1) S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP
"RTN","RGEX05",18,0)
 S L=0 F  S L=$O(TFARR(L)) Q:'L  D
"RTN","RGEX05",19,0)
 . S SL=$P(TFARR(L),"^",1)
"RTN","RGEX05",20,0)
 . S STATUS=$P(TFL(SL),"^",3)
"RTN","RGEX05",21,0)
 . I STATUS["Handle" S STATUS="Error in Process"
"RTN","RGEX05",22,0)
 . E  I STATUS["New" S STATUS="Request Sent"
"RTN","RGEX05",23,0)
 . E  I STATUS["Running" S STATUS="Awaiting Response"
"RTN","RGEX05",24,0)
 . E  I STATUS["Done" S STATUS="Response Received"
"RTN","RGEX05",25,0)
 . S TXT="  "_$P(TFL(SL),"^")_"  status: ("_STATUS_")"
"RTN","RGEX05",26,0)
 . D ADDTMP
"RTN","RGEX05",27,0)
 . S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP D
"RTN","RGEX05",28,0)
 . S LOC=$P(TFL(SL),"^",2)
"RTN","RGEX05",29,0)
 . N STATUS,RETURN,RESULT,RET,RESULT
"RTN","RGEX05",30,0)
 . I '$D(^XTMP("RGPDAT"_ICN,0)) S TXT=" - No patient data query exists for this patient." S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP
"RTN","RGEX05",31,0)
 . I $D(^XTMP("RGPDAT"_ICN,LOC,0)) D
"RTN","RGEX05",32,0)
 .. S RETURN(0)=$P(^XTMP("RGPDAT"_ICN,LOC,0),"^")
"RTN","RGEX05",33,0)
 .. D RPCCHK^XWB2HL7(.RESULT,RETURN(0)) I +RESULT(0)=1 D
"RTN","RGEX05",34,0)
 ... D RTNDATA^XWBDRPC(.RET,RETURN(0)) D
"RTN","RGEX05",35,0)
 ... I $G(RET(0))<0 S TXT="No Data Returned Due To: "_$P(RET(0),"^",2,99) S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP Q
"RTN","RGEX05",36,0)
 ... I $G(RET)'="",$D(@RET) S GLO=RET F  S GLO=$Q(@GLO) Q:$QS(GLO,1)'=$J  S TXT=@GLO S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP
"RTN","RGEX05",37,0)
 ... S R="" F  S R=$O(RET(R)) Q:R=""  S TXT=RET(R) S STR=$$SETSTR^VALM1(TXT,STR,2,78) D ADDTMP ;**31
"RTN","RGEX05",38,0)
 K ICNARR,R,L,SL,LOC,TFL,GLO
"RTN","RGEX05",39,0)
 S VALMCNT=LIN-1
"RTN","RGEX05",40,0)
 Q
"RTN","RGEX05",41,0)
ADDTMP ;
"RTN","RGEX05",42,0)
 S ^TMP("RGEXC5",$J,LIN,0)=STR
"RTN","RGEX05",43,0)
 S ^TMP("RGEXC5",$J,"IDX",LIN,LIN)=""
"RTN","RGEX05",44,0)
 S LIN=LIN+1,STR=""
"RTN","RGEX05",45,0)
 Q
"RTN","RGEX05",46,0)
HELP ;
"RTN","RGEX05",47,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","RGEX05",48,0)
 Q
"RTN","RGEX05",49,0)
EXIT ;
"RTN","RGEX05",50,0)
 S VALMBCK=""
"RTN","RGEX05",51,0)
 K ^TMP("RGEXC5",$J),LIN,X,STR,TXT
"RTN","RGEX05",52,0)
 S VALMBCK="R"
"RTN","RGEX05",53,0)
 Q
"RTN","RGMTMONT")
0^3^B37731232
"RTN","RGMTMONT",1,0)
RGMTMONT ;BIR/CML,PTD-MPI/PD Monitor HL7 Messaging/Filers and Setups ;07/30/02
"RTN","RGMTMONT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**20,30,31**;30 Apr 99
"RTN","RGMTMONT",3,0)
 ;
"RTN","RGMTMONT",4,0)
 ;Reference to OPTION SCHEDULING (#19.2) file supported by IA #3599
"RTN","RGMTMONT",5,0)
 ;Reference to ^DPT("AICNL" supported by IA #2070
"RTN","RGMTMONT",6,0)
 ;Reference to $$SEND^VAFHUTL for file DG(43 supported by IA #2624
"RTN","RGMTMONT",7,0)
 ;Reference to ^HLCS(870 supported by IA #3335
"RTN","RGMTMONT",8,0)
 ;Reference to $$STAT^HLCSLM supported by IA #3574
"RTN","RGMTMONT",9,0)
 ;Reference to ^DIA(2 and data derived from the AUDIT file (#1.1)
"RTN","RGMTMONT",10,0)
 ;supported by IA #2097 and #2602.
"RTN","RGMTMONT",11,0)
 ;
"RTN","RGMTMONT",12,0)
EN1 ;Call this routine from the top to do extended checks that include:
"RTN","RGMTMONT",13,0)
 ;- D HLMA1^RGMTUT98
"RTN","RGMTMONT",14,0)
 ;- D EN2^RGMTMONT
"RTN","RGMTMONT",15,0)
 ;- D ^RGMTMONX
"RTN","RGMTMONT",16,0)
 ;
"RTN","RGMTMONT",17,0)
 I $D(RGHLMQ) Q
"RTN","RGMTMONT",18,0)
 ;
"RTN","RGMTMONT",19,0)
 S DEV=0,EN=1 G START
"RTN","RGMTMONT",20,0)
 ;
"RTN","RGMTMONT",21,0)
DEV ;call used by developers to display ^RGMTMONX call
"RTN","RGMTMONT",22,0)
 S DEV=1,EN=2
"RTN","RGMTMONT",23,0)
 ;
"RTN","RGMTMONT",24,0)
START ;
"RTN","RGMTMONT",25,0)
 S CLUP=1
"RTN","RGMTMONT",26,0)
 W @IOF,"Logical Link Monitor:",!,"=====================",!
"RTN","RGMTMONT",27,0)
 D HLMA1^RGMTUT98
"RTN","RGMTMONT",28,0)
 S DIR(0)="E" D  D ^DIR K DIR
"RTN","RGMTMONT",29,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","RGMTMONT",30,0)
 I $D(DIRUT) G QUIT
"RTN","RGMTMONT",31,0)
 ;
"RTN","RGMTMONT",32,0)
 D EN2
"RTN","RGMTMONT",33,0)
 S DIR(0)="E" D  D ^DIR K DIR
"RTN","RGMTMONT",34,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","RGMTMONT",35,0)
 I $D(DIRUT) G QUIT
"RTN","RGMTMONT",36,0)
 ;
"RTN","RGMTMONT",37,0)
 I $G(EN)'=1 D ^RGMTMONX
"RTN","RGMTMONT",38,0)
 ;
"RTN","RGMTMONT",39,0)
 K EN,DEV G QUIT
"RTN","RGMTMONT",40,0)
 ;
"RTN","RGMTMONT",41,0)
EN2 ;Monitor Background Job - VAFC BATCH UPDATE
"RTN","RGMTMONT",42,0)
 ;Monitor Background Job - MPIF LOC/MIS ICN RES
"RTN","RGMTMONT",43,0)
 ;Check MAS PARAMETER file, field SEND PIMS HL7 V2.3 MESSAGES
"RTN","RGMTMONT",44,0)
 ;if call is being made from HL7 query, variable RGHLMQ will be defined
"RTN","RGMTMONT",45,0)
 S ^XTMP("RGMT",0)=$$FMADD^XLFDT(DT,30)_"^"_$$NOW^XLFDT_"^MPI/PD Maintenance Data"
"RTN","RGMTMONT",46,0)
 K ^XTMP("RGMT","HLMQMONT")
"RTN","RGMTMONT",47,0)
 I '$D(DEV) S DEV=0
"RTN","RGMTMONT",48,0)
 S LOCSITE=$P($$SITE^VASITE(),"^",3)
"RTN","RGMTMONT",49,0)
 I $D(RGHLMQ) D
"RTN","RGMTMONT",50,0)
 .D NOW^%DTC
"RTN","RGMTMONT",51,0)
 .S ^XTMP("RGMT","HLMQMONT",LOCSITE,"@@ RUNDATE")=$$FMTE^XLFDT($E(%,1,12))
"RTN","RGMTMONT",52,0)
 I '$D(RGHLMQ) W @IOF,"MPI/PD Process Monitor:",!,"======================="
"RTN","RGMTMONT",53,0)
 S TXTCNT=0
"RTN","RGMTMONT",54,0)
 N BKDA,CUR,MSG,SCHDA,SEND,TIME
"RTN","RGMTMONT",55,0)
CHK1 ;
"RTN","RGMTMONT",56,0)
 S TXT="Checking VAFC BATCH UPDATE background job..." D TXT
"RTN","RGMTMONT",57,0)
 D PIV^RGMTUT98
"RTN","RGMTMONT",58,0)
 S TXTCNT=3
"RTN","RGMTMONT",59,0)
 ;
"RTN","RGMTMONT",60,0)
 S DIC="^DIC(19,",X="VAFC BATCH UPDATE" D ^DIC K DIC S BKDA=+Y
"RTN","RGMTMONT",61,0)
 I BKDA<0 S TXT="=> VAFC BATCH UPDATE does not exist in OPTION file." D TXT K BKDA G CHK2
"RTN","RGMTMONT",62,0)
 S TXT="=> VAFC BATCH UPDATE is not currently scheduled to run."
"RTN","RGMTMONT",63,0)
 S DIC="^DIC(19.2,",X="VAFC BATCH UPDATE" D ^DIC K DIC S SCHDA=+Y
"RTN","RGMTMONT",64,0)
 I SCHDA<0 D TXT K BKDA,TXT,SCHDA G CHK2
"RTN","RGMTMONT",65,0)
 S TIME=$$GET1^DIQ(19.2,SCHDA_",",2)
"RTN","RGMTMONT",66,0)
 I TIME="" D TXT K BKDA,TXT,SCHDA,TIME G CHK2
"RTN","RGMTMONT",67,0)
 S TXT="=> VAFC BATCH UPDATE scheduled to run "_$$FMTE^XLFDT(TIME)_"."
"RTN","RGMTMONT",68,0)
 D TXT
"RTN","RGMTMONT",69,0)
 D NOW^%DTC
"RTN","RGMTMONT",70,0)
 S DAY=$E(%,1,7)
"RTN","RGMTMONT",71,0)
 ;
"RTN","RGMTMONT",72,0)
CHK2 ;
"RTN","RGMTMONT",73,0)
 S TXT="" D TXT
"RTN","RGMTMONT",74,0)
 ;
"RTN","RGMTMONT",75,0)
 S ICN=0,CNT=0
"RTN","RGMTMONT",76,0)
 F  S ICN=$O(^DPT("AICNL",1,ICN)) Q:'ICN  S CNT=CNT+1
"RTN","RGMTMONT",77,0)
 S TXT="Checking MPIF LOC/MIS ICN RES background job...  (Total Local ICNs = "_CNT_")"
"RTN","RGMTMONT",78,0)
 D TXT
"RTN","RGMTMONT",79,0)
 ;
"RTN","RGMTMONT",80,0)
 S DIC="^DIC(19,",X="MPIF LOC/MIS ICN RES" D ^DIC K DIC S BKDA=+Y
"RTN","RGMTMONT",81,0)
 I BKDA<0 S TXT="=> MPIF LOC/MIS ICN RES does not exist in OPTION file." D TXT K BKDA G CHK2A
"RTN","RGMTMONT",82,0)
 S TXT="=> MPIF LOC/MIS ICN RES is not currently scheduled to run."
"RTN","RGMTMONT",83,0)
 S DIC="^DIC(19.2,",X="MPIF LOC/MIS ICN RES" D ^DIC K DIC S SCHDA=+Y
"RTN","RGMTMONT",84,0)
 I SCHDA<0 D TXT K BKDA,SCHDA G CHK2A
"RTN","RGMTMONT",85,0)
 S TIME=$$GET1^DIQ(19.2,SCHDA_",",2)
"RTN","RGMTMONT",86,0)
 I TIME="" D TXT K BKDA,SCHDA,TIME G CHK2A
"RTN","RGMTMONT",87,0)
 S TXT="=> MPIF LOC/MIS ICN RES is scheduled to run "_$$FMTE^XLFDT(TIME)_"."
"RTN","RGMTMONT",88,0)
 D TXT
"RTN","RGMTMONT",89,0)
 ;
"RTN","RGMTMONT",90,0)
CHK2A ;check for time local/missing job was last run
"RTN","RGMTMONT",91,0)
 S TIME=$P($G(^RGSITE(991.8,1,0)),"^",4) I TIME'="" D
"RTN","RGMTMONT",92,0)
 .S TIME=$$FMTE^XLFDT(TIME)
"RTN","RGMTMONT",93,0)
 .S TXT="=> MPIF LOC/MIS ICN RES was last run "_TIME_"."
"RTN","RGMTMONT",94,0)
 .D TXT
"RTN","RGMTMONT",95,0)
 ;
"RTN","RGMTMONT",96,0)
CHK3 ;Check to see if .01 field in patient file has auditing turned on
"RTN","RGMTMONT",97,0)
 S TXT="" D TXT
"RTN","RGMTMONT",98,0)
 D FIELD^DID(2,.01,"","AUDIT","PATAUD")
"RTN","RGMTMONT",99,0)
 S PATAUD=$G(PATAUD("AUDIT")) I PATAUD="" S PATAUD="NOT SET"
"RTN","RGMTMONT",100,0)
 S PATAUD="<<"_PATAUD_">>"
"RTN","RGMTMONT",101,0)
 S TXT="=> Audit on NAME (#.01) field of PATIENT (#2) file set to "_PATAUD
"RTN","RGMTMONT",102,0)
 D TXT
"RTN","RGMTMONT",103,0)
 K PATAUD
"RTN","RGMTMONT",104,0)
 ;
"RTN","RGMTMONT",105,0)
CHK5 ;
"RTN","RGMTMONT",106,0)
 S TXT="" D TXT
"RTN","RGMTMONT",107,0)
 ;
"RTN","RGMTMONT",108,0)
 S TXT="Checking SEND Parameters for HL7 messaging..."
"RTN","RGMTMONT",109,0)
 D TXT
"RTN","RGMTMONT",110,0)
 ;
"RTN","RGMTMONT",111,0)
 S SEND=$P($$SEND^VAFHUTL,"^",2)
"RTN","RGMTMONT",112,0)
 S CUR=$S(SEND=1:"SEND MESSAGES",SEND=0:"STOP MESSAGES",SEND=2:"SUSPEND MESSAGES",1:"NULL")
"RTN","RGMTMONT",113,0)
 S TXT="=> SEND PIMS HL7 V2.3 MESSAGES currently set to << "_CUR_" >>."
"RTN","RGMTMONT",114,0)
 D TXT
"RTN","RGMTMONT",115,0)
 ;
"RTN","RGMTMONT",116,0)
 S TXT="=> STOP MPI/PD MESSAGING currently set to "
"RTN","RGMTMONT",117,0)
 S SEND=$P($G(^RGSITE(991.8,1,1)),"^",6)
"RTN","RGMTMONT",118,0)
 S CUR=$S(SEND=1:"SEND MESSAGES",SEND=0:"STOP MESSAGES",SEND=2:"SUSPEND MESSAGES",1:"NULL")
"RTN","RGMTMONT",119,0)
 S TXT="=> STOP MPI/PD MESSAGING currently set to << "_CUR_" >>."
"RTN","RGMTMONT",120,0)
 D TXT
"RTN","RGMTMONT",121,0)
 ;
"RTN","RGMTMONT",122,0)
CHK6 ;
"RTN","RGMTMONT",123,0)
 K RGMT
"RTN","RGMTMONT",124,0)
 S LOC=$P($$SITE^VASITE(),"^")
"RTN","RGMTMONT",125,0)
 D LINK^HLUTIL3(LOC,.RGMT)
"RTN","RGMTMONT",126,0)
 S LOCIEN=$O(RGMT(0))
"RTN","RGMTMONT",127,0)
 I 'LOCIEN D  G QUIT
"RTN","RGMTMONT",128,0)
 .S TXT="^DIC(4,""AC"" xref problem.  Check ^DIC(4,""AC"",,"_LOC
"RTN","RGMTMONT",129,0)
 .D TXT
"RTN","RGMTMONT",130,0)
 S LOCLINK=RGMT(LOCIEN)
"RTN","RGMTMONT",131,0)
 ;
"RTN","RGMTMONT",132,0)
 S TXT="" D TXT
"RTN","RGMTMONT",133,0)
 ;
"RTN","RGMTMONT",134,0)
 S TXT="Checking SHUTDOWN LLP? field and TCP/IP SERVICE TYPE for "_LOCLINK_"..."
"RTN","RGMTMONT",135,0)
 D TXT
"RTN","RGMTMONT",136,0)
 ;
"RTN","RGMTMONT",137,0)
 S CUR=$$GET1^DIQ(870,LOCIEN_",",14)
"RTN","RGMTMONT",138,0)
 S TXT="=> SHUTDOWN LLP? currently set to << "_CUR_" >>."
"RTN","RGMTMONT",139,0)
 D TXT
"RTN","RGMTMONT",140,0)
 ;
"RTN","RGMTMONT",141,0)
 S CUR=$$GET1^DIQ(870,LOCIEN_",",400.03)
"RTN","RGMTMONT",142,0)
 S TXT="=> TCP/IP SERVICE TYPE currently set to << "_CUR_" >>."
"RTN","RGMTMONT",143,0)
 D TXT
"RTN","RGMTMONT",144,0)
 ;
"RTN","RGMTMONT",145,0)
 ;check MPIVA for LLP TYPE
"RTN","RGMTMONT",146,0)
 S DIC="^HLCS(870,",X="MPIVA" D ^DIC K DIC S MPILL=+Y
"RTN","RGMTMONT",147,0)
 S CUR=$$GET1^DIQ(870,MPILL_",",2)
"RTN","RGMTMONT",148,0)
 S TXT="=> Logical Link MPIVA currently set to << "_CUR_" >>."
"RTN","RGMTMONT",149,0)
 D TXT
"RTN","RGMTMONT",150,0)
 ;
"RTN","RGMTMONT",151,0)
 ;check to see if Link Manager is running
"RTN","RGMTMONT",152,0)
 S LMSTAT=$$STAT^HLCSLM
"RTN","RGMTMONT",153,0)
 S CUR=$S('LMSTAT:"NOT RUNNING",1:"RUNNING")
"RTN","RGMTMONT",154,0)
 S TXT="=> HL LINK MANAGER is currently << "_CUR_" >>."
"RTN","RGMTMONT",155,0)
 D TXT
"RTN","RGMTMONT",156,0)
 ;
"RTN","RGMTMONT",157,0)
FLDLIST ;capture fields being audited
"RTN","RGMTMONT",158,0)
 I $D(RGHLMQ) D
"RTN","RGMTMONT",159,0)
 .S AUDCNT=0
"RTN","RGMTMONT",160,0)
 .S ^XTMP("RGMT","HLMQMONT",LOCSITE,"AUDIT",0)="Compiled: "_$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","RGMTMONT",161,0)
 .S FLDLP=0 F  S FLDLP=$O(^DD(2,"AUDIT",FLDLP)) Q:'FLDLP  D
"RTN","RGMTMONT",162,0)
 ..S AUDCNT=AUDCNT+1
"RTN","RGMTMONT",163,0)
 ..K RGARR D FIELD^DID(2,FLDLP,"","LABEL","RGARR")
"RTN","RGMTMONT",164,0)
 ..S FLDNM=$G(RGARR("LABEL")) Q:FLDNM=""
"RTN","RGMTMONT",165,0)
 ..S ^XTMP("RGMT","HLMQMONT",LOCSITE,"AUDIT",AUDCNT)=FLDLP_"^"_FLDNM
"RTN","RGMTMONT",166,0)
 ;
"RTN","RGMTMONT",167,0)
 I $D(RGHLMQ) D ^RGMTMONX
"RTN","RGMTMONT",168,0)
 ;
"RTN","RGMTMONT",169,0)
 I $D(CLUP),$D(DIRUT) Q
"RTN","RGMTMONT",170,0)
 ;
"RTN","RGMTMONT",171,0)
QUIT ;
"RTN","RGMTMONT",172,0)
 K %,BKDA,CLUP,CNT,CUR,DAY,DIR,DIRUT,ICN,JJ,LMSTAT,LOC,LOCIEN,LOCLINK
"RTN","RGMTMONT",173,0)
 K LOCSITE,MPILL,MSG,PATAUD,RGHLMQ,RGMT,SCHDA,SEND,SS,TIME,TXT,TXTCNT,X,Y
"RTN","RGMTMONT",174,0)
 K AUDCNT,FLDLP,RGARR,FLDNM
"RTN","RGMTMONT",175,0)
 Q
"RTN","RGMTMONT",176,0)
 ;
"RTN","RGMTMONT",177,0)
TXT ;
"RTN","RGMTMONT",178,0)
 S TXTCNT=TXTCNT+1
"RTN","RGMTMONT",179,0)
 I '$D(RGHLMQ) W !,TXT
"RTN","RGMTMONT",180,0)
 I $D(RGHLMQ) S ^XTMP("RGMT","HLMQMONT",LOCSITE,TXTCNT)=TXT
"RTN","RGMTMONT",181,0)
 Q
"RTN","RGMTMONX")
0^2^B66458164
"RTN","RGMTMONX",1,0)
RGMTMONX ;BIR/CML,PTD-MPI/PD Monitor HL7 Messaging/Filers and Setups (CONT) ;07/30/02
"RTN","RGMTMONX",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**20,30,31**;30 Apr 99
"RTN","RGMTMONX",3,0)
 ;
"RTN","RGMTMONX",4,0)
 ;Reference to ^DIC(4,"D", supported by IA #3627
"RTN","RGMTMONX",5,0)
 ;Reference to ^HLCS(870 supported by IA #3335
"RTN","RGMTMONX",6,0)
 ;Reference to ^DGCN(391.91, supported by IA #2911
"RTN","RGMTMONX",7,0)
 ;
"RTN","RGMTMONX",8,0)
START ;
"RTN","RGMTMONX",9,0)
 I DEV,'$D(RGHLMQ) W @IOF,"Logical Link Monitor:",!,"=====================",!
"RTN","RGMTMONX",10,0)
 ;
"RTN","RGMTMONX",11,0)
 K ^XTMP("RGMT","MONT")
"RTN","RGMTMONX",12,0)
 I '$D(TXTCNT) S TXTCNT=0
"RTN","RGMTMONX",13,0)
 I '$D(LOCSITE) S LOCSITE=$P($$SITE^VASITE(),"^")
"RTN","RGMTMONX",14,0)
 ;
"RTN","RGMTMONX",15,0)
 ;MULTID=# of multiple "D" xrefs in ^DIC(4 for Station #
"RTN","RGMTMONX",16,0)
 ;NOINST=# of VAxxx Links with no INSTITUTION defined
"RTN","RGMTMONX",17,0)
 ;BADINST=# of VAxxx Links that have an incorrect INSTITUTION defined
"RTN","RGMTMONX",18,0)
 ;BADTF=# of patients with invalid Treating Facilities
"RTN","RGMTMONX",19,0)
 ;NONVA=# of non-VAxxx Logical Links with INSTITUTION defined
"RTN","RGMTMONX",20,0)
 ;CNT=# of VAxxx Logical Links processed
"RTN","RGMTMONX",21,0)
 ;
"RTN","RGMTMONX",22,0)
 S (NOINST,BADINST,BADTF,MULTID,NONVA,CNT,DODHOST)=0
"RTN","RGMTMONX",23,0)
 ;
"RTN","RGMTMONX",24,0)
1 ;
"RTN","RGMTMONX",25,0)
 I DEV,'$D(RGHLMQ) W !,"=> Checks 1-3: Checking Link Setups..."
"RTN","RGMTMONX",26,0)
 K LINKARR
"RTN","RGMTMONX",27,0)
 S LINK=""
"RTN","RGMTMONX",28,0)
 F  S LINK=$O(^HLCS(870,"B",LINK)) Q:LINK=""  D
"RTN","RGMTMONX",29,0)
 .I LINK'="MPIVA"&($E(LINK,1,2)'="VA") Q
"RTN","RGMTMONX",30,0)
 .I $E(LINK,1,2)="VA"&($L(LINK," ")>1) Q
"RTN","RGMTMONX",31,0)
 .Q:LINK["-"
"RTN","RGMTMONX",32,0)
 .I $T(@LINK)']"" Q
"RTN","RGMTMONX",33,0)
 .S CNT=CNT+1
"RTN","RGMTMONX",34,0)
 .S VALSTA=$P($P($T(@LINK),";;",2),"^",2)
"RTN","RGMTMONX",35,0)
 .;build array of links with valid station numbers to do check 5
"RTN","RGMTMONX",36,0)
 .S LINKARR(VALSTA)=LINK
"RTN","RGMTMONX",37,0)
2 .;check for multiple "D" xrefs in ^DIC(4 for this station #)
"RTN","RGMTMONX",38,0)
 .S (XCNT,QQ)=0
"RTN","RGMTMONX",39,0)
 .F  S QQ=$O(^DIC(4,"D",VALSTA,QQ)) Q:'QQ  D
"RTN","RGMTMONX",40,0)
 ..S XCNT=XCNT+1
"RTN","RGMTMONX",41,0)
 ..I QQ["." D
"RTN","RGMTMONX",42,0)
 ...S ^XTMP("RGMT","MONT","DECIMEL INST IEN",VALSTA,QQ)=""
"RTN","RGMTMONX",43,0)
 .I XCNT>1 D
"RTN","RGMTMONX",44,0)
 ..S LINKIEN=$O(^HLCS(870,"B",LINK,0))
"RTN","RGMTMONX",45,0)
 ..S MULTID=MULTID+1
"RTN","RGMTMONX",46,0)
 ..S (XCNT,QQ)=0
"RTN","RGMTMONX",47,0)
 ..F  S QQ=$O(^DIC(4,"D",VALSTA,QQ)) Q:'QQ  D
"RTN","RGMTMONX",48,0)
 ...S ^XTMP("RGMT","MONT","MULTI DXREF",VALSTA,QQ)=$$GET1^DIQ(4,QQ_",",.01)_"^"_$$GET1^DIQ(870,LINKIEN_",",.01)_"^"_$$GET1^DIQ(870,LINKIEN_",",.02,"I")
"RTN","RGMTMONX",49,0)
3 .;check for defined INSTITUTION and set (if necessary) AUTOSTART and RESTART for links in file 870
"RTN","RGMTMONX",50,0)
 .S LINKIEN=$O(^HLCS(870,"B",LINK,0))
"RTN","RGMTMONX",51,0)
 .S LINKINST=$$GET1^DIQ(870,LINKIEN_",",.02,"I")
"RTN","RGMTMONX",52,0)
 .I 'LINKINST D  Q
"RTN","RGMTMONX",53,0)
 ..S NOINST=NOINST+1
"RTN","RGMTMONX",54,0)
 ..S ^XTMP("RGMT","MONT","NO INST",LINK)=LINKIEN_"^"_$P($P($T(@LINK),";;",2),"^",1,2)
"RTN","RGMTMONX",55,0)
 ..S TXT="   ** No INSTITUTION defined for "_LINK D TXT
"RTN","RGMTMONX",56,0)
4 .;check for incorrect INSTITUTION
"RTN","RGMTMONX",57,0)
 .S LOCSTA=$P($$NS^XUAF4(LINKINST),"^",2)
"RTN","RGMTMONX",58,0)
 .I LOCSTA'=VALSTA D
"RTN","RGMTMONX",59,0)
 ..S BADINST=BADINST+1
"RTN","RGMTMONX",60,0)
 ..S ^XTMP("RGMT","MONT","BAD INST",LINK)=LOCSTA
"RTN","RGMTMONX",61,0)
 ..S TXT="   ** Bad INSTITUTION of Station #"_LOCSTA_" defined for "_LINK_" - should be Station #"_VALSTA D TXT
"RTN","RGMTMONX",62,0)
 ;
"RTN","RGMTMONX",63,0)
5 ;
"RTN","RGMTMONX",64,0)
 I DEV,'$D(RGHLMQ) W !,"=> Check 4   : Checking for patients with invalid Treating Facilities..."
"RTN","RGMTMONX",65,0)
 S TFIEN=0
"RTN","RGMTMONX",66,0)
 F  S TFIEN=$O(^DGCN(391.91,"C",TFIEN)) Q:'TFIEN  D
"RTN","RGMTMONX",67,0)
 .S TF=$P($$NS^XUAF4(TFIEN),"^",2)
"RTN","RGMTMONX",68,0)
 .I TF="" D  Q
"RTN","RGMTMONX",69,0)
 ..S TFIFN=0 F  S TFIFN=$O(^DGCN(391.91,"C",TFIEN,TFIFN)) Q:'TFIFN  D
"RTN","RGMTMONX",70,0)
 ...S BADTF=BADTF+1
"RTN","RGMTMONX",71,0)
 ...S DFN=$$GET1^DIQ(391.91,TFIFN_",",.01,"I")
"RTN","RGMTMONX",72,0)
 ...I DEV,'$D(RGHLMQ) D
"RTN","RGMTMONX",73,0)
 ....W !?3,"** TF with no station # for ",$P(^DIC(4,TFIEN,0),"^")," for DFN #",DFN," - (TF IEN #",TFIFN,")"
"RTN","RGMTMONX",74,0)
 .I '$D(LINKARR(TF)) D
"RTN","RGMTMONX",75,0)
 ..S IEN=0 F  S IEN=$O(^DGCN(391.91,"C",TFIEN,IEN)) Q:'IEN  D
"RTN","RGMTMONX",76,0)
 ...I TF=200 S DODHOST=DODHOST+1 Q
"RTN","RGMTMONX",77,0)
 ...S DFN=$$GET1^DIQ(391.91,IEN_",",.01,"I")
"RTN","RGMTMONX",78,0)
 ...S BADTF=BADTF+1
"RTN","RGMTMONX",79,0)
 ...S ^XTMP("RGMT","MONT","BAD TF",DFN)=$$GET1^DIQ(4,TFIEN_",",.01)_"^"_IEN
"RTN","RGMTMONX",80,0)
 ...I DEV,'$D(RGHLMQ) W !?3,"** Bad TF of ",$P(^DIC(4,TFIEN,0),"^")," for DFN #",DFN," - (TF IEN #",IEN,")"
"RTN","RGMTMONX",81,0)
 ;
"RTN","RGMTMONX",82,0)
6 ;
"RTN","RGMTMONX",83,0)
 I DEV,'$D(RGHLMQ) W !,"=> Check 5   : Checking for non-VAxxx links with INSTITUTION defined..."
"RTN","RGMTMONX",84,0)
 S LINK=""
"RTN","RGMTMONX",85,0)
 F  S LINK=$O(^HLCS(870,"B",LINK)) Q:LINK=""  I $E(LINK,1,2)'="VA"!($E(LINK,1,4)="VAFC") D
"RTN","RGMTMONX",86,0)
 .Q:LINK="MPIVA"
"RTN","RGMTMONX",87,0)
 .S LINKIEN=$O(^HLCS(870,"B",LINK,0))
"RTN","RGMTMONX",88,0)
 .S LINKINST=$$GET1^DIQ(870,LINKIEN_",",.02,"I")
"RTN","RGMTMONX",89,0)
 .Q:'LINKINST
"RTN","RGMTMONX",90,0)
 .Q:LINKINST'=+$$SITE^VASITE()
"RTN","RGMTMONX",91,0)
 .S NONVA=NONVA+1
"RTN","RGMTMONX",92,0)
 .S ^XTMP("RGMT","MONT","NONVA LINK WITH INSTITUTION",LINK)=""
"RTN","RGMTMONX",93,0)
 .S TXT="   ** Non-VA Link with LOCAL INSTITUTION defined - "_LINK D TXT
"RTN","RGMTMONX",94,0)
 ;
"RTN","RGMTMONX",95,0)
DONE ;
"RTN","RGMTMONX",96,0)
 S TXT="" D TXT
"RTN","RGMTMONX",97,0)
 ;
"RTN","RGMTMONX",98,0)
 S TXT="==============================" D TXT
"RTN","RGMTMONX",99,0)
 S TXT="Check 1: "_MULTID_" VA MPI/PD Links with multiple ""D"" xref in ^DIC(4 for Station #." D TXT
"RTN","RGMTMONX",100,0)
 S TXT="Check 2: "_NOINST_" VA MPI/PD Links without an INSTITUTION defined." D TXT
"RTN","RGMTMONX",101,0)
 S TXT="Check 3: "_BADINST_" VA MPI/PD Links with incorrect INSTITUTION defined."  D TXT
"RTN","RGMTMONX",102,0)
 S TXT="Check 4: "_BADTF_" patients with invalid Treating Facilities. => FHIE Pts: "_DODHOST D TXT
"RTN","RGMTMONX",103,0)
 S TXT="Check 5: "_NONVA_" non-VA MPI/PD Links with an INSTITUTION of local site defined." D TXT
"RTN","RGMTMONX",104,0)
 ;
"RTN","RGMTMONX",105,0)
 K BADINST,BADTF,CNT,DEV,DFN,IEN,LINK,LINKARR,LINKIEN,LINKINST,LOCSITE,LOCSTA,MULTID
"RTN","RGMTMONX",106,0)
 K NOINST,NONVA,QQ,TF,TFIEN,TFIFN,TXT,TXTCNT,VALSTA,XCNT,DODHOST
"RTN","RGMTMONX",107,0)
 Q
"RTN","RGMTMONX",108,0)
 ;
"RTN","RGMTMONX",109,0)
TXT ;
"RTN","RGMTMONX",110,0)
 S TXTCNT=TXTCNT+1
"RTN","RGMTMONX",111,0)
 I DEV,'$D(RGHLMQ) W !,TXT
"RTN","RGMTMONX",112,0)
 I $D(RGHLMQ) S ^XTMP("RGMT","HLMQMONT",LOCSITE,TXTCNT)=TXT
"RTN","RGMTMONX",113,0)
 Q
"RTN","RGMTMONX",114,0)
 ;
"RTN","RGMTMONX",115,0)
LINKS ;
"RTN","RGMTMONX",116,0)
MPIVA ;;MPI^200M
"RTN","RGMTMONX",117,0)
VAALX ;;ALEXANDRIA^502
"RTN","RGMTMONX",118,0)
VAALT ;;ALTOONA^503
"RTN","RGMTMONX",119,0)
VAAMA ;;AMARILLO HCS^504
"RTN","RGMTMONX",120,0)
VAANC ;;ANCHORAGE^463
"RTN","RGMTMONX",121,0)
VAANN ;;ANN ARBOR^506
"RTN","RGMTMONX",122,0)
VAASH ;;ASHEVILLE^637
"RTN","RGMTMONX",123,0)
VAATG ;;ATLANTA^508
"RTN","RGMTMONX",124,0)
VAAUG ;;AUGUSTA^509
"RTN","RGMTMONX",125,0)
VABAC ;;BATTLE CREEK^515
"RTN","RGMTMONX",126,0)
VABAY ;;BAY PINES^516
"RTN","RGMTMONX",127,0)
VABEC ;;BECKLEY^517
"RTN","RGMTMONX",128,0)
VABED ;;BEDFORD^518
"RTN","RGMTMONX",129,0)
VABIL ;;BILOXI^520
"RTN","RGMTMONX",130,0)
VABIR ;;BIRMINGHAM^521
"RTN","RGMTMONX",131,0)
VABHH ;;BLACK HILLS HCS^568
"RTN","RGMTMONX",132,0)
VABOI ;;BOISE^531
"RTN","RGMTMONX",133,0)
VABOS ;;BOSTON HCS^523
"RTN","RGMTMONX",134,0)
VABRX ;;BRONX^526
"RTN","RGMTMONX",135,0)
VABUT ;;BUTLER^529
"RTN","RGMTMONX",136,0)
VACAH ;;CENTRAL ALABAMA HCS^619
"RTN","RGMTMONX",137,0)
VALIT ;;CENTRAL ARKANSAS HCS^598
"RTN","RGMTMONX",138,0)
VAFRE ;;CENTRAL CALIFORNIA HCS^570
"RTN","RGMTMONX",139,0)
VAOMA ;;CENTRAL PLAINS HCS^636
"RTN","RGMTMONX",140,0)
VACTX ;;CENTRAL TEXAS HCS^674
"RTN","RGMTMONX",141,0)
VACHA ;;CHARLESTON^534
"RTN","RGMTMONX",142,0)
VACHY ;;CHEYENNE^442
"RTN","RGMTMONX",143,0)
VACHS ;;CHICAGO HCS^537
"RTN","RGMTMONX",144,0)
VACLL ;;CHILLICOTHE^538
"RTN","RGMTMONX",145,0)
VACIN ;;CINCINNATI^539
"RTN","RGMTMONX",146,0)
VACLA ;;CLARKSBURG^540
"RTN","RGMTMONX",147,0)
VACLE ;;CLEVELAND^541
"RTN","RGMTMONX",148,0)
VACOA ;;COATESVILLE^542
"RTN","RGMTMONX",149,0)
VACMS ;;COLUMBIA^544
"RTN","RGMTMONX",150,0)
VACOS ;;COLUMBUS^757
"RTN","RGMTMONX",151,0)
VACON ;;CONNECTICUT HCS^689
"RTN","RGMTMONX",152,0)
VADAY ;;DAYTON^552
"RTN","RGMTMONX",153,0)
VADEN ;;DENVER^554
"RTN","RGMTMONX",154,0)
VADET ;;DETROIT^553
"RTN","RGMTMONX",155,0)
VADUB ;;DUBLIN^557
"RTN","RGMTMONX",156,0)
VADUR ;;DURHAM^558
"RTN","RGMTMONX",157,0)
VAELP ;;EL PASO^756
"RTN","RGMTMONX",158,0)
VAERI ;;ERIE^562
"RTN","RGMTMONX",159,0)
VAFAR ;;FARGO^437
"RTN","RGMTMONX",160,0)
VAFNC ;;FAYETTEVILLE^565
"RTN","RGMTMONX",161,0)
VAFAV ;;FAYETTEVILLE^564
"RTN","RGMTMONX",162,0)
VAJAC ;;G. V. (SONNY) MONTGOMERY^586
"RTN","RGMTMONX",163,0)
VAGRJ ;;GRAND JUNCTION^575
"RTN","RGMTMONX",164,0)
VAHAM ;;HAMPTON^590
"RTN","RGMTMONX",165,0)
VAHIN ;;HINES^578
"RTN","RGMTMONX",166,0)
VAHON ;;HONOLULU VAMROC^459
"RTN","RGMTMONX",167,0)
VAHOU ;;HOUSTON^580
"RTN","RGMTMONX",168,0)
VAHVH ;;HUDSON VALLEY HCS^620
"RTN","RGMTMONX",169,0)
VAHUN ;;HUNTINGTON^581
"RTN","RGMTMONX",170,0)
VADAN ;;ILLIANA HEALTH CARE SYSTEM^550
"RTN","RGMTMONX",171,0)
VAIND ;;INDIANAPOLIS^583
"RTN","RGMTMONX",172,0)
VAIRO ;;IRON MOUNTAIN^585
"RTN","RGMTMONX",173,0)
VALAS ;;LAS VEGAS^593
"RTN","RGMTMONX",174,0)
VALEB ;;LEBANON^595
"RTN","RGMTMONX",175,0)
VALEX ;;LEXINGTON^596
"RTN","RGMTMONX",176,0)
VALOM ;;LOMA LINDA^605
"RTN","RGMTMONX",177,0)
VALON ;;LONG BEACH HCS^600
"RTN","RGMTMONX",178,0)
VALOU ;;LOUISVILLE^603
"RTN","RGMTMONX",179,0)
VAMAD ;;MADISON^607
"RTN","RGMTMONX",180,0)
VAMAN ;;MANCHESTER^608
"RTN","RGMTMONX",181,0)
VAMPI ;;MANILA^358
"RTN","RGMTMONX",182,0)
VAMWV ;;MARTINSBURG^613
"RTN","RGMTMONX",183,0)
VAMAR ;;MARYLAND HCS^512
"RTN","RGMTMONX",184,0)
VAMEM ;;MEMPHIS^614
"RTN","RGMTMONX",185,0)
VAMIA ;;MIAMI^546
"RTN","RGMTMONX",186,0)
VAMIW ;;MILWAUKEE^695
"RTN","RGMTMONX",187,0)
VAMIN ;;MINNEAPOLIS^618
"RTN","RGMTMONX",188,0)
VAFHM ;;MONTANA HCS^436
"RTN","RGMTMONX",189,0)
VAMOU ;;MOUNTAIN HOME^621
"RTN","RGMTMONX",190,0)
VAMUS ;;MUSKOGEE^623
"RTN","RGMTMONX",191,0)
VAGAI ;;N. FLORIDA/S. GEORGIA HCS^573
"RTN","RGMTMONX",192,0)
VANJH ;;NEW JERSEY HCS^561
"RTN","RGMTMONX",193,0)
VAALB ;;NEW MEXICO HCS^501
"RTN","RGMTMONX",194,0)
VANOL ;;NEW ORLEANS^629
"RTN","RGMTMONX",195,0)
VANYN ;;NEW YORK HARBOR HCS^630
"RTN","RGMTMONX",196,0)
VANCH ;;NORTH CHICAGO^556
"RTN","RGMTMONX",197,0)
VANTH ;;NORTH TEXAS HCS^549
"RTN","RGMTMONX",198,0)
VANHM ;;NORTHAMPTON^631
"RTN","RGMTMONX",199,0)
VAPRE ;;NORTHERN ARIZONA HCS^649
"RTN","RGMTMONX",200,0)
VAMAC ;;NORTHERN CALIFORNIA HCS^612
"RTN","RGMTMONX",201,0)
VANIN ;;NORTHERN INDIANA HCS^610
"RTN","RGMTMONX",202,0)
VANOP ;;NORTHPORT^632
"RTN","RGMTMONX",203,0)
VAOKL ;;OKLAHOMA CITY^635
"RTN","RGMTMONX",204,0)
VAPAL ;;PALO ALTO HCS^640
"RTN","RGMTMONX",205,0)
VAPHI ;;PHILADELPHIA^642
"RTN","RGMTMONX",206,0)
VAPHO ;;PHOENIX^644
"RTN","RGMTMONX",207,0)
VAPTH ;;PITTSBURGH HCS^646
"RTN","RGMTMONX",208,0)
VAPOR ;;PORTLAND^648
"RTN","RGMTMONX",209,0)
VAPRO ;;PROVIDENCE^650
"RTN","RGMTMONX",210,0)
VAPUG ;;PUGET SOUND HCS^663
"RTN","RGMTMONX",211,0)
VARIC ;;RICHMOND^652
"RTN","RGMTMONX",212,0)
VAROS ;;ROSEBURG^653
"RTN","RGMTMONX",213,0)
VASAG ;;SAGINAW^655
"RTN","RGMTMONX",214,0)
VASAM ;;SALEM^658
"RTN","RGMTMONX",215,0)
VASBY ;;SALISBURY^659
"RTN","RGMTMONX",216,0)
VASLC ;;SALT LAKE CITY HCS^660
"RTN","RGMTMONX",217,0)
VASDC ;;SAN DIEGO HCS^664
"RTN","RGMTMONX",218,0)
VASFC ;;SAN FRANCISCO^662
"RTN","RGMTMONX",219,0)
VASAJ ;;SAN JUAN^672
"RTN","RGMTMONX",220,0)
VASHE ;;SHERIDAN^666
"RTN","RGMTMONX",221,0)
VASHR ;;SHREVEPORT^667
"RTN","RGMTMONX",222,0)
VAREN ;;SIERRA NEVADA HCS^654
"RTN","RGMTMONX",223,0)
VASUX ;;SIOUX FALLS^438
"RTN","RGMTMONX",224,0)
VASTX ;;SOUTH TEXAS HCS^671
"RTN","RGMTMONX",225,0)
VATUC ;;SOUTHERN ARIZONA HCS^678
"RTN","RGMTMONX",226,0)
VASPO ;;SPOKANE^668
"RTN","RGMTMONX",227,0)
VASTC ;;ST. CLOUD^656
"RTN","RGMTMONX",228,0)
VATAM ;;TAMPA^673
"RTN","RGMTMONX",229,0)
VANAS ;;TENNESSEE VALLEY HCS^626
"RTN","RGMTMONX",230,0)
VATOG ;;TOGUS^402
"RTN","RGMTMONX",231,0)
VATOM ;;TOMAH^676
"RTN","RGMTMONX",232,0)
VATUA ;;TUSCALOOSA^679
"RTN","RGMTMONX",233,0)
VAWNY ;;UPSTATE NEW YORK HCS^528
"RTN","RGMTMONX",234,0)
VASTL ;;VA HEARTLAND - EAST, VISN 15^657
"RTN","RGMTMONX",235,0)
VAKAN ;;VA HEARTLAND - WEST, VISN 15^589
"RTN","RGMTMONX",236,0)
VAWWW ;;WALLA WALLA^687
"RTN","RGMTMONX",237,0)
VAWAS ;;WASHINGTON^688
"RTN","RGMTMONX",238,0)
VAWLA ;;WEST LA VAMC^691
"RTN","RGMTMONX",239,0)
VAWPB ;;WEST PALM BEACH^548
"RTN","RGMTMONX",240,0)
VABIG ;;WEST TEXAS HCS^519
"RTN","RGMTMONX",241,0)
VAWCO ;;WHITE CITY^692
"RTN","RGMTMONX",242,0)
VAWRJ ;;WHITE RIVER JCT^405
"RTN","RGMTMONX",243,0)
VAWBP ;;WILKES BARRE^693
"RTN","RGMTMONX",244,0)
VAWIM ;;WILMINGTON^460
"RTN","RGMTMONX",245,0)
 ;;***
"RTN","RGMTUT01")
0^6^B78431432
"RTN","RGMTUT01",1,0)
RGMTUT01 ;BIR/CML-MPI/PD Compile and Correct Data Validation Data for Local Sites ;08/12/02
"RTN","RGMTUT01",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**20,31**;30 Apr 99
"RTN","RGMTUT01",3,0)
 ;
"RTN","RGMTUT01",4,0)
 ;Reference to $$UPDATE^MPIFAPI supported by IA #2706
"RTN","RGMTUT01",5,0)
 ;Reference to VAFCTFU supported by IA #2988
"RTN","RGMTUT01",6,0)
 ;Reference to ^DPT( supported by IA #2070
"RTN","RGMTUT01",7,0)
 ;Reference to ^DGCN(391.91,"APAT" supported by IA #2911
"RTN","RGMTUT01",8,0)
 ;Reference to ^%ZTSCH("TASK" supported by IA #3520
"RTN","RGMTUT01",9,0)
 ;
"RTN","RGMTUT01",10,0)
EN1 ;Use this entry point to get only display diagnostics for development team
"RTN","RGMTUT01",11,0)
 ;BYPASS=0 means prohibit times are enforced
"RTN","RGMTUT01",12,0)
 ;SITEOPT=0 means CMOR, TF, and diagnostics are included in report
"RTN","RGMTUT01",13,0)
 ;SITEOPT=1 means diagnostics are omitted from report (this is the report for the site)
"RTN","RGMTUT01",14,0)
 ;SITEOPT=2 means only diagnostics are in report
"RTN","RGMTUT01",15,0)
 ;
"RTN","RGMTUT01",16,0)
 S BYPASS=0,SITEOPT=2 G BEGIN
"RTN","RGMTUT01",17,0)
 ;
"RTN","RGMTUT01",18,0)
EN2 ;Use this entry point from remote query
"RTN","RGMTUT01",19,0)
 S BYPASS=0,SITEOPT=0 G BEGIN
"RTN","RGMTUT01",20,0)
 ;
"RTN","RGMTUT01",21,0)
EN3 ;Use this entry point for site menu option [RG NATIONAL ICN STATISTICS] to omit
"RTN","RGMTUT01",22,0)
 ;diagnostic section from report
"RTN","RGMTUT01",23,0)
 S BYPASS=0,SITEOPT=1 G BEGIN
"RTN","RGMTUT01",24,0)
 ;
"RTN","RGMTUT01",25,0)
BY ;use this call to bypass check to prohibit primetime run
"RTN","RGMTUT01",26,0)
 S BYPASS=1,SITEOPT=2
"RTN","RGMTUT01",27,0)
 ;
"RTN","RGMTUT01",28,0)
BEGIN ;
"RTN","RGMTUT01",29,0)
 S PRT=0,QFLG=0 K RGROU
"RTN","RGMTUT01",30,0)
 I $D(^XTMP("RGMT","UT01","@@","COMPILE STARTED"))&('$D(^XTMP("RGMT","UT01","@@","COMPILE STOPPED"))) D  I QFLG G QUIT
"RTN","RGMTUT01",31,0)
 .;check running tasks to see if compile is running
"RTN","RGMTUT01",32,0)
 .S TASK=0 F  S TASK=$O(^%ZTSCH("TASK",TASK)) Q:'TASK  D
"RTN","RGMTUT01",33,0)
 ..S RGROU=$P(^%ZTSCH("TASK",TASK),"^",2)
"RTN","RGMTUT01",34,0)
 ..I RGROU="RGMTSTAT" D
"RTN","RGMTUT01",35,0)
 ...I TASK=$G(ZTSK) Q
"RTN","RGMTUT01",36,0)
 ...S QFLG=1
"RTN","RGMTUT01",37,0)
 ...I '$D(RGHLMQ) W !!,"The Stat Report is currently being compiled."
"RTN","RGMTUT01",38,0)
 .I 'QFLG K ^XTMP("RGMT","UT01"),^XTMP("RGMT","REINDDT")
"RTN","RGMTUT01",39,0)
 ;
"RTN","RGMTUT01",40,0)
 I $D(RGHLMQ) G STARTQ
"RTN","RGMTUT01",41,0)
 W !!,"This option provides the following statistics:"
"RTN","RGMTUT01",42,0)
 W !?3,"1.  Total patients assigned to each unique COORDINATING MASTER OF"
"RTN","RGMTUT01",43,0)
 W !?3,"    RECORD (CMOR)."
"RTN","RGMTUT01",44,0)
 W !?3,"2.  Total patients shared with each unique entry in the TREATING"
"RTN","RGMTUT01",45,0)
 W !?3,"    FACILITY LIST (#391.91) file."
"RTN","RGMTUT01",46,0)
 W !?3,"3.  Totals for national ICNs, local ICNs, and patients with no ICN."
"RTN","RGMTUT01",47,0)
 I SITEOPT=1 G START
"RTN","RGMTUT01",48,0)
 W !?3,"4.  Total CMOR assignments missing a matching Treating Facility."
"RTN","RGMTUT01",49,0)
 W !?3,"5.  Total patients with NATIONAL ICN and missing local Treating Facility."
"RTN","RGMTUT01",50,0)
 W !?3,"6.  Total number of patients with duplicate entries in the TREATING"
"RTN","RGMTUT01",51,0)
 W !?3,"    FACILITY LIST file (#391.91)."
"RTN","RGMTUT01",52,0)
 W !?3,"7.  Patient File xref problems for ""AICN"", ""AICNL"", and ""SSN""."
"RTN","RGMTUT01",53,0)
 W !?3,"8.  Total number of patients with a no ICN but have a CMOR assignment."
"RTN","RGMTUT01",54,0)
 W !?3,"9.  Total number of patients with a no ICN but have TF assignments."
"RTN","RGMTUT01",55,0)
 W !?3,"10. Total number of patients with a local ICN but have remote TFs."
"RTN","RGMTUT01",56,0)
 ;
"RTN","RGMTUT01",57,0)
START ;
"RTN","RGMTUT01",58,0)
 S QFLG=0
"RTN","RGMTUT01",59,0)
 I '$D(^XTMP("RGMT","UT01","@@","COMPILE STARTED")) W !!,"No data is currently available." I SITEOPT=1 G QUIT
"RTN","RGMTUT01",60,0)
 ;
"RTN","RGMTUT01",61,0)
 W !!,"===> NOTE <==="
"RTN","RGMTUT01",62,0)
 I SITEOPT=1 D
"RTN","RGMTUT01",63,0)
 .W !,"This data is compiled by a remote process initiated from the MPI in Austin"
"RTN","RGMTUT01",64,0)
 .W !,"on a regular basis for reporting purposes.  It is not compiled by the local"
"RTN","RGMTUT01",65,0)
 .W !,"site, however, the local site can view the last report that was compiled.",!
"RTN","RGMTUT01",66,0)
 ;
"RTN","RGMTUT01",67,0)
 I $D(^XTMP("RGMT","UT01","@@","COMPILE STOPPED")) D  G:QFLG QUIT I PRT D ^RGMTUT03 G QUIT
"RTN","RGMTUT01",68,0)
 .S PRT=0
"RTN","RGMTUT01",69,0)
 .S LAST=^XTMP("RGMT","UT01","@@","COMPILE STOPPED")
"RTN","RGMTUT01",70,0)
 .S LAST=$$FMTE^XLFDT(LAST)
"RTN","RGMTUT01",71,0)
 .W !,"This data was last compiled on ",LAST,"."
"RTN","RGMTUT01",72,0)
 .I SITEOPT=1 S PRT=1 Q
"RTN","RGMTUT01",73,0)
 .S DIR(0)="Y",DIR("B")="YES",DIR("A")="Do you just want a reprint of that data"
"RTN","RGMTUT01",74,0)
 .S DIR("?",1)="Enter:"
"RTN","RGMTUT01",75,0)
 .S DIR("?",2)=" ""YES"" or <RET> to reprint current data and NOT recompile."
"RTN","RGMTUT01",76,0)
 .S DIR("?",3)=" ""NO"" to recompile new data (this may take several hours)."
"RTN","RGMTUT01",77,0)
 .S DIR("?")=" ""^"" to HALT."
"RTN","RGMTUT01",78,0)
 .D ^DIR K DIR
"RTN","RGMTUT01",79,0)
 .I Y="^" S QFLG=1 Q
"RTN","RGMTUT01",80,0)
 .I +Y=1 S PRT=1 Q
"RTN","RGMTUT01",81,0)
 ;
"RTN","RGMTUT01",82,0)
STARTQ ;pick up here for queued job
"RTN","RGMTUT01",83,0)
 D NOW^%DTC
"RTN","RGMTUT01",84,0)
 ;
"RTN","RGMTUT01",85,0)
 ;check to be sure stat report not being run during prime time
"RTN","RGMTUT01",86,0)
 S TODAY=$$DOW^XLFDT($$NOW^XLFDT()) I TODAY="Saturday"!(TODAY="Sunday") S BYPASS=1
"RTN","RGMTUT01",87,0)
 S QUIT=0
"RTN","RGMTUT01",88,0)
 I 'BYPASS D  I QUIT G QUIT
"RTN","RGMTUT01",89,0)
 .S CHKTIME=$E($P(%,".",2),1,4)
"RTN","RGMTUT01",90,0)
 .I CHKTIME>"0700"&(CHKTIME<"1700") S QUIT=1 I '$D(RGHLMQ) D
"RTN","RGMTUT01",91,0)
 ..W !!,"<< STAT report cannot be compiled between 7:00am and 5:00pm! >>"
"RTN","RGMTUT01",92,0)
 ;
"RTN","RGMTUT01",93,0)
 I '$D(RGHLMQ) W !!,"Recompiling data..."
"RTN","RGMTUT01",94,0)
 ;
"RTN","RGMTUT01",95,0)
 S ^XTMP("RGMT",0)=$$FMADD^XLFDT(DT,30)_"^"_$$NOW^XLFDT_"^MPI/PD Maintenance Data"
"RTN","RGMTUT01",96,0)
 K ^XTMP("RGMT","UT01")
"RTN","RGMTUT01",97,0)
 S ^XTMP("RGMT","UT01","@@","COMPILE STARTED")=%
"RTN","RGMTUT01",98,0)
 ;
"RTN","RGMTUT01",99,0)
 D REIND^RGMTUT02
"RTN","RGMTUT01",100,0)
 D CMOR,TF,TFCHK
"RTN","RGMTUT01",101,0)
 ;
"RTN","RGMTUT01",102,0)
 I 'PRT D
"RTN","RGMTUT01",103,0)
 .D NOW^%DTC
"RTN","RGMTUT01",104,0)
 .S ^XTMP("RGMT","UT01","@@","COMPILE STOPPED")=%
"RTN","RGMTUT01",105,0)
 D ^RGMTUT03
"RTN","RGMTUT01",106,0)
 ;
"RTN","RGMTUT01",107,0)
QUIT ;
"RTN","RGMTUT01",108,0)
 K %,BYPASS,CHKTIME,LAST,LOC,PRT,QFLG,QUIT,SITEOPT,TODAY,Y,RGROU,TASK
"RTN","RGMTUT01",109,0)
 Q
"RTN","RGMTUT01",110,0)
 ;
"RTN","RGMTUT01",111,0)
CMOR ; Check "ACMOR" xref for:
"RTN","RGMTUT01",112,0)
 ; - existence of a TF entry for the CMOR in the TF file #391.91
"RTN","RGMTUT01",113,0)
 ; - existence of a TF for the local site (if not the CMOR)
"RTN","RGMTUT01",114,0)
 ; - CMOR totals by site
"RTN","RGMTUT01",115,0)
 ;
"RTN","RGMTUT01",116,0)
 I '$D(RGHLMQ) D
"RTN","RGMTUT01",117,0)
 .W !!,"Check #1 for:"
"RTN","RGMTUT01",118,0)
 .W !,"- Patients missing Treating Facility entries for their CMOR."
"RTN","RGMTUT01",119,0)
 .W !,"- Patients missing Treating Facility entries for their local site."
"RTN","RGMTUT01",120,0)
 .W !,"- Unique CMOR totals."
"RTN","RGMTUT01",121,0)
 ;
"RTN","RGMTUT01",122,0)
 K ^XTMP("RGMT","UT01","CMOR")
"RTN","RGMTUT01",123,0)
 K ^XTMP("RGMT","UT01","TOT CMOR MISS TF")
"RTN","RGMTUT01",124,0)
 K ^XTMP("RGMT","UT01","TOT LOC SITE MISS TF")
"RTN","RGMTUT01",125,0)
 K ^XTMP("RGMT","UT01","CMOR WITH NO ICN")
"RTN","RGMTUT01",126,0)
 S (CNT,NOICN,TOTMISSC,TOTMISSL)=0
"RTN","RGMTUT01",127,0)
 S SITESTA=$P($$SITE^VASITE(),"^",3),SITEDA=$P($$SITE^VASITE(),"^")
"RTN","RGMTUT01",128,0)
 ;
"RTN","RGMTUT01",129,0)
 S CMOR=0 F  S CMOR=$O(^DPT("ACMOR",CMOR)) Q:'CMOR  D
"RTN","RGMTUT01",130,0)
 .I '$D(CMOR(CMOR)) S CMOR(CMOR)=0
"RTN","RGMTUT01",131,0)
 .S DFN=0 F  S DFN=$O(^DPT("ACMOR",CMOR,DFN)) Q:'DFN  D
"RTN","RGMTUT01",132,0)
 ..S CNT=CNT+1 I '$D(RGHLMQ) W:'(CNT#10000) "."
"RTN","RGMTUT01",133,0)
 ..S ICN=$P($G(^DPT(DFN,"MPI")),"^")
"RTN","RGMTUT01",134,0)
 ..I $E(ICN,1,3)=SITESTA Q
"RTN","RGMTUT01",135,0)
 ..I ICN="" D  Q
"RTN","RGMTUT01",136,0)
 ...S NOICN=NOICN+1
"RTN","RGMTUT01",137,0)
 ...I '$D(RGHLMQ) W !?3,"DFN #",DFN," has no ICN and a CMOR of ",$P($$NS^XUAF4(CMOR),"^")
"RTN","RGMTUT01",138,0)
 ...S ^XTMP("RGMT","UT01","CMOR WITH NO ICN",DFN)=""
"RTN","RGMTUT01",139,0)
 ...S LOC(991.03)="@" W $$UPDATE^MPIFAPI(DFN,"LOC")
"RTN","RGMTUT01",140,0)
 ..S CMOR(CMOR)=CMOR(CMOR)+1
"RTN","RGMTUT01",141,0)
 ..I '$D(^DGCN(391.91,"APAT",DFN,CMOR)) D
"RTN","RGMTUT01",142,0)
 ...S TOTMISSC=TOTMISSC+1
"RTN","RGMTUT01",143,0)
 ...S SSN=$P($G(^DPT(DFN,0)),"^",9)
"RTN","RGMTUT01",144,0)
 ...S NAME=$P($G(^DPT(DFN,0)),"^")
"RTN","RGMTUT01",145,0)
 ...S ^XTMP("RGMT","UT01","CMOR","ZZMISSC",CMOR,DFN)="DFN/"_DFN_"^NAME/"_NAME_"^SSN/"_SSN_"^ICN/"_ICN
"RTN","RGMTUT01",146,0)
 ...D FILE^VAFCTFU(DFN,CMOR,1)
"RTN","RGMTUT01",147,0)
 ..I SITEDA'=CMOR,'$D(^DGCN(391.91,"APAT",DFN,SITEDA)) D
"RTN","RGMTUT01",148,0)
 ...S TOTMISSL=TOTMISSL+1
"RTN","RGMTUT01",149,0)
 ...S SSN=$P($G(^DPT(DFN,0)),"^",9)
"RTN","RGMTUT01",150,0)
 ...S NAME=$P($G(^DPT(DFN,0)),"^")
"RTN","RGMTUT01",151,0)
 ...S ^XTMP("RGMT","UT01","CMOR","ZZMISSL",CMOR,DFN)="DFN/"_DFN_"^NAME/"_NAME_"^SSN/"_SSN_"^ICN/"_ICN
"RTN","RGMTUT01",152,0)
 ...D FILE^VAFCTFU(DFN,SITEDA,1)
"RTN","RGMTUT01",153,0)
 ;
"RTN","RGMTUT01",154,0)
 S CMOR=0 F  S CMOR=$O(CMOR(CMOR)) Q:'CMOR  D
"RTN","RGMTUT01",155,0)
 .S CMORNM=$P($$NS^XUAF4(CMOR),"^"),CMORSTA=$P($$NS^XUAF4(CMOR),"^",2) Q:CMORSTA=""
"RTN","RGMTUT01",156,0)
 .S ^XTMP("RGMT","UT01","CMOR",CMORNM,CMORSTA)=CMOR(CMOR)
"RTN","RGMTUT01",157,0)
 S ^XTMP("RGMT","UT01","TOT CMOR MISS TF")=TOTMISSC
"RTN","RGMTUT01",158,0)
 S ^XTMP("RGMT","UT01","TOT LOC SITE MISS TF")=TOTMISSL
"RTN","RGMTUT01",159,0)
 S ^XTMP("RGMT","UT01","CMOR WITH NO ICN")=NOICN
"RTN","RGMTUT01",160,0)
 I '$D(RGHLMQ) W !,"Check #1 - Complete"
"RTN","RGMTUT01",161,0)
 K CMOR,CMORNM,CMORSTA,CNT,DFN,ICN,NAME,NOICN,SITEDA,SITESTA,SSN,TOTMISSC,TOTMISSL
"RTN","RGMTUT01",162,0)
 Q
"RTN","RGMTUT01",163,0)
 ;
"RTN","RGMTUT01",164,0)
TF ; Get totals for unique sites in the TF file (#391.91)
"RTN","RGMTUT01",165,0)
 I '$D(RGHLMQ) D
"RTN","RGMTUT01",166,0)
 .W !!,"Check #2 for:"
"RTN","RGMTUT01",167,0)
 .W !,"- Unique Treating Facility totals."
"RTN","RGMTUT01",168,0)
 K ^XTMP("RGMT","UT01","TF"),TFCNT S CNT=0
"RTN","RGMTUT01",169,0)
 S SITE=$P($$SITE^VASITE(),"^",3)
"RTN","RGMTUT01",170,0)
 S TF=0 F  S TF=$O(^DGCN(391.91,"AINST",TF)) Q:'TF  D
"RTN","RGMTUT01",171,0)
 .S CNT=CNT+1 I '$D(RGHLMQ) W:'(CNT#10000) "."
"RTN","RGMTUT01",172,0)
 .I '$D(TFCNT(TF)) S TFCNT(TF)=0
"RTN","RGMTUT01",173,0)
 .S TFIEN=0 F  S TFIEN=$O(^DGCN(391.91,"AINST",TF,TFIEN)) Q:'TFIEN  S TFCNT(TF)=TFCNT(TF)+1
"RTN","RGMTUT01",174,0)
 S TF=0 F  S TF=$O(TFCNT(TF)) Q:'TF  D
"RTN","RGMTUT01",175,0)
 .S TFNM=$P($$NS^XUAF4(TF),"^"),TFSTA=$P($$NS^XUAF4(TF),"^",2) Q:TFSTA=""
"RTN","RGMTUT01",176,0)
 .S ^XTMP("RGMT","UT01","TF",TFNM,TFSTA)=TFCNT(TF)
"RTN","RGMTUT01",177,0)
 I '$D(RGHLMQ) W !,"Check #2 - Complete"
"RTN","RGMTUT01",178,0)
 K CNT,SITE,TF,TFCNT,TFIEN,TFNM,TFSTA
"RTN","RGMTUT01",179,0)
 Q
"RTN","RGMTUT01",180,0)
 ;
"RTN","RGMTUT01",181,0)
TFCHK ; Get totals for duplicates in TF file (#391.91)
"RTN","RGMTUT01",182,0)
 ;NOICN=# of patients found with remote TFs and no ICN
"RTN","RGMTUT01",183,0)
 ;LOCICN=# of patients found with remote TFs and a local ICN
"RTN","RGMTUT01",184,0)
 ;
"RTN","RGMTUT01",185,0)
 I '$D(RGHLMQ) D
"RTN","RGMTUT01",186,0)
 .W !!,"Check #3 for:"
"RTN","RGMTUT01",187,0)
 .W !,"- Duplicate Treating Facility assignments."
"RTN","RGMTUT01",188,0)
 .W !,"- Patients with Treating Facilities and no ICN."
"RTN","RGMTUT01",189,0)
 .W !,"- Patients remote treating Facilities and Local ICN."
"RTN","RGMTUT01",190,0)
 ;
"RTN","RGMTUT01",191,0)
 K ^XTMP("RGMT","UT01","TOT TFDUP"),^XTMP("RGMT","UT01","TOT NO ICN W/TF"),^XTMP("RGMT","UT01","TOT LOC ICN W/REMOTE TF")
"RTN","RGMTUT01",192,0)
 S (PTCNT,DUPCNT,NOICN,LOCICN)=0
"RTN","RGMTUT01",193,0)
 S SITESTA=$P($$SITE^VASITE(),"^",3),SITEDA=$P($$SITE^VASITE(),"^")
"RTN","RGMTUT01",194,0)
 S DFN=0 F  S DFN=$O(^DGCN(391.91,"APAT",DFN)) Q:'DFN  D
"RTN","RGMTUT01",195,0)
 .S PTCNT=PTCNT+1 I '$D(RGHLMQ) W:'(PTCNT#10000) "."
"RTN","RGMTUT01",196,0)
 .S TF=0 F  S TF=$O(^DGCN(391.91,"APAT",DFN,TF)) Q:'TF  D
"RTN","RGMTUT01",197,0)
 ..S MPI0=$G(^DPT(DFN,"MPI")),ICN=$P(MPI0,"^")
"RTN","RGMTUT01",198,0)
 ..;delete all TFs for patients with no ICN
"RTN","RGMTUT01",199,0)
 ..I ICN="" D  Q
"RTN","RGMTUT01",200,0)
 ...S NOICN=NOICN+1
"RTN","RGMTUT01",201,0)
 ...S TFIEN=0 F  S TFIEN=$O(^DGCN(391.91,"APAT",DFN,TF,TFIEN)) Q:'TFIEN  D
"RTN","RGMTUT01",202,0)
 ....S ^XTMP("RGMT","UT01","NO ICN WITH REMOTE OR LOCAL TF",DFN,TFIEN)=""
"RTN","RGMTUT01",203,0)
 ....D DELETE^VAFCTFU(TFIEN)
"RTN","RGMTUT01",204,0)
 ..;delete all remote TFs for patients with local ICNs
"RTN","RGMTUT01",205,0)
 ..I $E(ICN,1,3)=SITESTA,TF'=SITEDA D  Q
"RTN","RGMTUT01",206,0)
 ...S TFIEN=0 F  S TFIEN=$O(^DGCN(391.91,"APAT",DFN,TF,TFIEN)) Q:'TFIEN  D
"RTN","RGMTUT01",207,0)
 ....S LOCICN=LOCICN+1
"RTN","RGMTUT01",208,0)
 ....S ^XTMP("RGMT","UT01","LOCAL ICN WITH REMOTE TF",DFN,TFIEN)=""
"RTN","RGMTUT01",209,0)
 ....D DELETE^VAFCTFU(TFIEN)
"RTN","RGMTUT01",210,0)
 ..;look for TF dups
"RTN","RGMTUT01",211,0)
 ..S (TFCNT,TFIEN)=0 F  S TFIEN=$O(^DGCN(391.91,"APAT",DFN,TF,TFIEN)) Q:'TFIEN  D
"RTN","RGMTUT01",212,0)
 ...S TFCNT=TFCNT+1 I TFCNT>1 D
"RTN","RGMTUT01",213,0)
 ....S DUPCNT=DUPCNT+1
"RTN","RGMTUT01",214,0)
 ....S SSN=$P($G(^DPT(DFN,0)),"^",9)
"RTN","RGMTUT01",215,0)
 ....S NM=$P($G(^(0)),"^")
"RTN","RGMTUT01",216,0)
 ....S ^XTMP("RGMT","UT01","TFDUP",DFN,TFIEN)=TF_"^"_NM_"^"_SSN
"RTN","RGMTUT01",217,0)
 ....D DELETE^VAFCTFU(TFIEN)
"RTN","RGMTUT01",218,0)
 ;
"RTN","RGMTUT01",219,0)
 S ^XTMP("RGMT","UT01","TOT TFDUP")=DUPCNT
"RTN","RGMTUT01",220,0)
 S ^XTMP("RGMT","UT01","TOT NO ICN W/TF")=NOICN
"RTN","RGMTUT01",221,0)
 S ^XTMP("RGMT","UT01","TOT LOC ICN W/REMOTE TF")=LOCICN
"RTN","RGMTUT01",222,0)
 I '$D(RGHLMQ) W !,"Check #3 - Complete"
"RTN","RGMTUT01",223,0)
 K DFN,DUPCNT,ICN,LOCICN,MPI0,NM,NOICN,PTCNT,SITEDA,SITESTA,SSN,TF,TFCNT,TFIEN
"RTN","RGMTUT01",224,0)
 Q
"RTN","RGRPDAT")
0^5^B52100073
"RTN","RGRPDAT",1,0)
RGRPDAT ;BAY/ALS-ROUTINE TO CALL REMOTE PDAT ;09/14/01
"RTN","RGRPDAT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**23,27,31**;30 Apr 99
"RTN","RGRPDAT",3,0)
 ;Reference to ^DGCN(391.91 supported by IA #2911
"RTN","RGRPDAT",4,0)
 ;Reference to EN1^XWB2HL7 supported by IA #3144
"RTN","RGRPDAT",5,0)
 ;Reference to RPCCHK^XWB2HL7 supported by IA #3144
"RTN","RGRPDAT",6,0)
 ;Reference to RTNDATA^XWBDRPC supported by IA #3149
"RTN","RGRPDAT",7,0)
 ;Reference to VAFC REMOTE PDAT supported by IA #3496
"RTN","RGRPDAT",8,0)
ASK ;Ask For Patient
"RTN","RGRPDAT",9,0)
 K DIRUT
"RTN","RGRPDAT",10,0)
 W !!,"Patient lookup can be done by Patient Name, SSN or by ICN.",!
"RTN","RGRPDAT",11,0)
 S DFN="",ICN=""
"RTN","RGRPDAT",12,0)
 S DIC="^DPT(",DIC(0)="QEAM",DIC("A")="Select PATIENT: ",D="SSN^AICN^B^BS^BS5"
"RTN","RGRPDAT",13,0)
 D MIX^DIC1 K DIC,D
"RTN","RGRPDAT",14,0)
 I Y<0 S REXIT=1 G QUIT
"RTN","RGRPDAT",15,0)
 S DFN=+Y
"RTN","RGRPDAT",16,0)
 S ICN=+$$GETICN^MPIF001(DFN) I ICN<1 W !,"There is no Integration Control Number assigned to this patient,",!,"no treating facilities to query." G ASK
"RTN","RGRPDAT",17,0)
 Q
"RTN","RGRPDAT",18,0)
SEND ;
"RTN","RGRPDAT",19,0)
 N TFL,X,Y,SNTDT,MPIDIR
"RTN","RGRPDAT",20,0)
 D GETTFL(ICN,.TFL)
"RTN","RGRPDAT",21,0)
 I $D(^XTMP("RGPDAT"_ICN,0)) S SNTDT=$$FMTE^XLFDT($P(^XTMP("RGPDAT"_ICN,0),"^",2)) W !,"Query last sent for this ICN on "_SNTDT,!
"RTN","RGRPDAT",22,0)
 I $P($G(TFL(0)),"^",1)=1 D
"RTN","RGRPDAT",23,0)
 . D SELTF Q:((Y="")!(Y="^"))
"RTN","RGRPDAT",24,0)
 . W !,"Remote patient data queries will be sent to: "
"RTN","RGRPDAT",25,0)
 . S CNT=0,X=0 F  S X=$O(TFARR(X)) Q:'X  S CNT=CNT+1
"RTN","RGRPDAT",26,0)
 . I CNT>22 D D2
"RTN","RGRPDAT",27,0)
 . I CNT<23 D D1
"RTN","RGRPDAT",28,0)
 . W ! K DIR S DIR(0)="Y",DIR("B")="Yes",DIR("A")="Do you want to continue" D ^DIR S MPIDIR=+Y K DIR
"RTN","RGRPDAT",29,0)
 . I MPIDIR=1 S X=0 F  S X=$O(TFL(X)) Q:'X  D
"RTN","RGRPDAT",30,0)
 .. W !?3,"Sending Remote Query to: ",X,"  ",$P(TFL(X),"^")
"RTN","RGRPDAT",31,0)
 .. I $D(^XTMP("RGPDAT"_ICN,X)) K ^XTMP("RGPDAT"_ICN,X)
"RTN","RGRPDAT",32,0)
 .. D REQ(ICN,.TFL,X)
"RTN","RGRPDAT",33,0)
 I '$D(TFL(0)) W !!?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query will be sent."
"RTN","RGRPDAT",34,0)
 K ICNARR,X,Y,CNT,TFARR,TFL
"RTN","RGRPDAT",35,0)
 Q
"RTN","RGRPDAT",36,0)
SEND2 ;
"RTN","RGRPDAT",37,0)
 N REXIT S REXIT=0
"RTN","RGRPDAT",38,0)
 W !!,"This option sends a remote query to selected treating"
"RTN","RGRPDAT",39,0)
 W !,"facility site(s) for MPI/PD data for a patient."
"RTN","RGRPDAT",40,0)
 F  D  Q:REXIT=1
"RTN","RGRPDAT",41,0)
 . D ASK
"RTN","RGRPDAT",42,0)
 . I $D(Y) D SEND
"RTN","RGRPDAT",43,0)
 K ICN,DFN
"RTN","RGRPDAT",44,0)
 Q
"RTN","RGRPDAT",45,0)
CHKSTAT ;check on the status for a given ICN or SSN
"RTN","RGRPDAT",46,0)
 N TFL,L,Y,ICNARR,STATUS,SL
"RTN","RGRPDAT",47,0)
 W !!,"Checking the status of remote patient data query.",!
"RTN","RGRPDAT",48,0)
 I '$D(^XTMP("RGPDAT"_ICN)) W !!,"No remote query sent for this patient." Q
"RTN","RGRPDAT",49,0)
 D GETTFL(ICN,.TFL)
"RTN","RGRPDAT",50,0)
 W !!,"-> For ICN ",$P(ICN,"V",1),!
"RTN","RGRPDAT",51,0)
 I $D(TFL(0)) D
"RTN","RGRPDAT",52,0)
 . S X=0 F  S X=$O(TFL(X)) Q:'X  I '$D(^XTMP("RGPDAT"_ICN,X)) K TFL(X)
"RTN","RGRPDAT",53,0)
 D SELTF
"RTN","RGRPDAT",54,0)
 I '$D(TFARR) W !,"No remote query sent for this patient." Q
"RTN","RGRPDAT",55,0)
 Q:((Y="")!(Y="^"))
"RTN","RGRPDAT",56,0)
 S L=0 F  S L=$O(TFARR(L)) Q:'L  D
"RTN","RGRPDAT",57,0)
 . S SL=$P(TFARR(L),"^",1)
"RTN","RGRPDAT",58,0)
 . S STATUS=$P(TFL(SL),"^",3)
"RTN","RGRPDAT",59,0)
 . I STATUS["Handle" S STATUS="Error in Process"
"RTN","RGRPDAT",60,0)
 . E  I STATUS["New" S STATUS="Request Sent"
"RTN","RGRPDAT",61,0)
 . E  I STATUS["Running" S STATUS="Awaiting Response"
"RTN","RGRPDAT",62,0)
 . E  I STATUS["Done" S STATUS="Response Received"
"RTN","RGRPDAT",63,0)
 . W !?3,"  ",$P(TFL(SL),"^"),"  status: (",STATUS,")"
"RTN","RGRPDAT",64,0)
 I '$D(TFL(0)) W !!?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query sent for this patient."
"RTN","RGRPDAT",65,0)
 K ICNARR,L,SL,TFARR,TFL
"RTN","RGRPDAT",66,0)
 Q
"RTN","RGRPDAT",67,0)
CHKSTAT2 ;
"RTN","RGRPDAT",68,0)
 N REXIT S REXIT=0
"RTN","RGRPDAT",69,0)
 W !!,"This option checks the status of an existing remote patient data query."
"RTN","RGRPDAT",70,0)
 F  D  Q:REXIT=1
"RTN","RGRPDAT",71,0)
 . D ASK
"RTN","RGRPDAT",72,0)
 . I $D(Y) D CHKSTAT
"RTN","RGRPDAT",73,0)
 K ICN,DFN
"RTN","RGRPDAT",74,0)
 Q
"RTN","RGRPDAT",75,0)
DISP    ;display returned PDAT queries
"RTN","RGRPDAT",76,0)
 W !!,"Display data returned from remote patient data queries."
"RTN","RGRPDAT",77,0)
 W !,"(Be sure HISTORY is enabled to capture data!)",!
"RTN","RGRPDAT",78,0)
 N TFL,L,Y,ICNARR,STATUS
"RTN","RGRPDAT",79,0)
 I '$D(^XTMP("RGPDAT"_ICN)) W !!,"No remote query sent for this patient." Q
"RTN","RGRPDAT",80,0)
 D GETTFL(ICN,.TFL)
"RTN","RGRPDAT",81,0)
 W !!,"-> For ICN ",$P(ICN,"V",1),!
"RTN","RGRPDAT",82,0)
 I $D(TFL(0)) D
"RTN","RGRPDAT",83,0)
 . S X=0 F  S X=$O(TFL(X)) Q:'X  I '$D(^XTMP("RGPDAT"_ICN,X)) K TFL(X)
"RTN","RGRPDAT",84,0)
 D SELTF
"RTN","RGRPDAT",85,0)
 I '$D(TFARR) W !,"No remote query sent for this patient." Q
"RTN","RGRPDAT",86,0)
 Q:((Y="")!(Y="^"))
"RTN","RGRPDAT",87,0)
 S L=0 F  S L=$O(TFARR(L)) Q:'L  D
"RTN","RGRPDAT",88,0)
 . S SL=$P(TFARR(L),"^",1)
"RTN","RGRPDAT",89,0)
 . S STATUS=$P(TFL(SL),"^",3)
"RTN","RGRPDAT",90,0)
 . I STATUS["Handle" S STATUS="Error in Process"
"RTN","RGRPDAT",91,0)
 . E  I STATUS["New" S STATUS="Request Sent"
"RTN","RGRPDAT",92,0)
 . E  I STATUS["Running" S STATUS="Awaiting Response"
"RTN","RGRPDAT",93,0)
 . E  I STATUS["Done" S STATUS="Response Received"
"RTN","RGRPDAT",94,0)
 . W !?3,"  ",$P(TFL(SL),"^"),"  status: (",STATUS,")",!
"RTN","RGRPDAT",95,0)
 . D DISPLAY(ICN,$P(TFL(SL),"^",2))
"RTN","RGRPDAT",96,0)
 I '$D(TFL(0)) W !?3,"There are no remote treating facilities listed for this patient.",!?3,"No remote query exists for this patient."
"RTN","RGRPDAT",97,0)
 K ICNARR,L,SL,TFARR,TFL
"RTN","RGRPDAT",98,0)
 Q
"RTN","RGRPDAT",99,0)
DISP2 ;
"RTN","RGRPDAT",100,0)
 N REXIT S REXIT=0
"RTN","RGRPDAT",101,0)
 F  D  Q:REXIT=1
"RTN","RGRPDAT",102,0)
 . D ASK
"RTN","RGRPDAT",103,0)
 . I $D(Y) D DISP
"RTN","RGRPDAT",104,0)
 K ICN,DFN
"RTN","RGRPDAT",105,0)
 Q
"RTN","RGRPDAT",106,0)
DISPLAY(ICN,LOC) ;display a remote pdat report
"RTN","RGRPDAT",107,0)
 N STATUS,RETURN,RESULT,RET,R
"RTN","RGRPDAT",108,0)
 I '$D(^XTMP("RGPDAT"_ICN,0)) W !?15," - No patient data query exists for this record."
"RTN","RGRPDAT",109,0)
 I $D(^XTMP("RGPDAT"_ICN,LOC,0)) S RETURN(0)=$P(^XTMP("RGPDAT"_ICN,LOC,0),"^") D
"RTN","RGRPDAT",110,0)
 . D RPCCHK^XWB2HL7(.RESULT,RETURN(0)) I +RESULT(0)=1 D
"RTN","RGRPDAT",111,0)
 .. D RTNDATA^XWBDRPC(.RET,RETURN(0))
"RTN","RGRPDAT",112,0)
 .. I $D(RET(0)) I RET(0)<0 W !!,"No data returned due to: "_$P(RET(0),"^",2) Q  ;**31
"RTN","RGRPDAT",113,0)
 .. I $G(RET)'="",$D(@RET) S GLO=RET F  S GLO=$Q(@GLO) Q:$QS(GLO,1)'=$J  S TXT=@GLO W !,TXT I $Y>22 S DIR(0)="E" D ^DIR K DIR W @IOF S $Y=1 ;**31
"RTN","RGRPDAT",114,0)
 .. S R="" F  S R=$O(RET(R)) Q:R=""  W !,RET(R) I $Y>22 S DIR(0)="E" D ^DIR K DIR W @IOF S $Y=1 ;**31
"RTN","RGRPDAT",115,0)
 Q
"RTN","RGRPDAT",116,0)
GETTFL(ICN,TFL) ;Check for existing Treating Facilities
"RTN","RGRPDAT",117,0)
 N LOC,HOME
"RTN","RGRPDAT",118,0)
 S HOME=$$SITE^VASITE()
"RTN","RGRPDAT",119,0)
 S TF=0 F  S TF=$O(^DGCN(391.91,"APAT",DFN,TF)) Q:'TF  D
"RTN","RGRPDAT",120,0)
 . S LOC=$$NNT^XUAF4(TF)
"RTN","RGRPDAT",121,0)
 . I $P(LOC,"^",2)'=$E($P(HOME,"^",3),1,3) D
"RTN","RGRPDAT",122,0)
 .. S TFL($P(LOC,"^",2))=LOC
"RTN","RGRPDAT",123,0)
 .. S LOC=$P(LOC,"^",2)
"RTN","RGRPDAT",124,0)
 .. D MONITOR(ICN,LOC,.RESULT)
"RTN","RGRPDAT",125,0)
 .. S $P(TFL(LOC),"^",3)=$P(RESULT(0),"^",2)
"RTN","RGRPDAT",126,0)
 I $O(TFL(0)) S TFL(0)=1
"RTN","RGRPDAT",127,0)
 K TF
"RTN","RGRPDAT",128,0)
 Q
"RTN","RGRPDAT",129,0)
SELTF ;Allow the user to select treating facilites from a list
"RTN","RGRPDAT",130,0)
 K TFARR,TFARR1
"RTN","RGRPDAT",131,0)
 S I=0 F  S I=$O(TFL(I)) Q:'I  D
"RTN","RGRPDAT",132,0)
 . S TFARR1($P(TFL(I),"^",1))=$P(TFL(I),"^",2)_"^"_$P(TFL(I),"^",1)
"RTN","RGRPDAT",133,0)
 S I="",CNT=0 F  S I=$O(TFARR1(I)) Q:I=""  D
"RTN","RGRPDAT",134,0)
 . S CNT=CNT+1 S TFARR(CNT)=TFARR1(I)
"RTN","RGRPDAT",135,0)
 I CNT=1 S Y=1 Q
"RTN","RGRPDAT",136,0)
 K DIR,Y
"RTN","RGRPDAT",137,0)
 S CNT=CNT+1,TFARR(CNT)="ALL"
"RTN","RGRPDAT",138,0)
 S DIR(0)="LA^1:"_CNT
"RTN","RGRPDAT",139,0)
 S DIR("A")="Select site(s) 1-"_(CNT-1)_" or "_CNT_" for all: "
"RTN","RGRPDAT",140,0)
 W !,"Select one or more of the following: "
"RTN","RGRPDAT",141,0)
 I CNT>22 D D2
"RTN","RGRPDAT",142,0)
 I CNT<23 D D1
"RTN","RGRPDAT",143,0)
 D ^DIR K DIR
"RTN","RGRPDAT",144,0)
 I Y<1 K TFARR,TFARR1,L,I,A,CNT Q
"RTN","RGRPDAT",145,0)
 S Y=","_Y
"RTN","RGRPDAT",146,0)
 I Y[(","_CNT_",") K TFARR(CNT),TFARR1,CNT,I Q
"RTN","RGRPDAT",147,0)
 S I=0,A="" F  S I=$O(TFARR(I)) Q:'I  I Y'[(","_I_",") S A=$P(TFARR(I),"^",1) K TFL(A) K TFARR(I)
"RTN","RGRPDAT",148,0)
 K L,I,A,TFARR(CNT),CNT,TFARR1
"RTN","RGRPDAT",149,0)
 Q
"RTN","RGRPDAT",150,0)
MONITOR(ICN,LOC,RESULT) ;
"RTN","RGRPDAT",151,0)
 N STATUS,RETURN
"RTN","RGRPDAT",152,0)
 I '$D(^XTMP("RGPDAT"_ICN,0)) S RESULT(0)="-1^Unknown" Q
"RTN","RGRPDAT",153,0)
 I '$D(^XTMP("RGPDAT"_ICN,LOC,0)) S RESULT(0)="-1^Unknown" Q
"RTN","RGRPDAT",154,0)
 I $D(^XTMP("RGPDAT"_ICN,LOC,0)) S RETURN(0)=$P(^XTMP("RGPDAT"_ICN,LOC,0),"^",1) D RPCCHK^XWB2HL7(.RESULT,RETURN(0))
"RTN","RGRPDAT",155,0)
 Q
"RTN","RGRPDAT",156,0)
REQ(ICN,TFL,LOC)        ;request a remote pdat report
"RTN","RGRPDAT",157,0)
 ;LOC - STATION# OF THE INSTITUTION file entry
"RTN","RGRPDAT",158,0)
 I +LOC>0 D EN1^XWB2HL7(.RETURN,LOC,"VAFC REMOTE PDAT",1,ICN,"")
"RTN","RGRPDAT",159,0)
 S ^XTMP("RGPDAT"_ICN,0)=$$FMADD^XLFDT(DT,2)_"^"_DT_"^"_"REMOTE PDAT QUERY"
"RTN","RGRPDAT",160,0)
 S ^XTMP("RGPDAT"_ICN,LOC,0)=RETURN(0)_"^"_$$NOW^XLFDT
"RTN","RGRPDAT",161,0)
 Q
"RTN","RGRPDAT",162,0)
SENS ;Check for patient sensitivity
"RTN","RGRPDAT",163,0)
 N RESULT
"RTN","RGRPDAT",164,0)
 D PTSEC^DGSEC4(.RESULT,DFN,0,"RPC - VAFC REMOTE PDAT^Remote Patient Data Query")
"RTN","RGRPDAT",165,0)
 I RESULT(1)>0 D
"RTN","RGRPDAT",166,0)
 . I '$D(^XUSEC("DG SENSITIVITY",DUZ)) D
"RTN","RGRPDAT",167,0)
 . W !!,"PATIENT MARKED SENSITIVE."
"RTN","RGRPDAT",168,0)
 . W !,"You do not have proper security to view this record."
"RTN","RGRPDAT",169,0)
 Q
"RTN","RGRPDAT",170,0)
D1 ;
"RTN","RGRPDAT",171,0)
 S C1=1,I=0 F  S I=$O(TFARR(I)) Q:'I  D
"RTN","RGRPDAT",172,0)
 . W !,C1_".",?4,"("_$P(TFARR(I),"^",1)_") "_$P(TFARR(I),"^",2) S C1=C1+1
"RTN","RGRPDAT",173,0)
 K C1,I
"RTN","RGRPDAT",174,0)
 Q
"RTN","RGRPDAT",175,0)
D2 ;
"RTN","RGRPDAT",176,0)
 S I2=23 F I=1:1:22 D
"RTN","RGRPDAT",177,0)
 . W !,I_".",?4,"("_$P(TFARR(I),"^",1)_") "_$P(TFARR(I),"^",2)
"RTN","RGRPDAT",178,0)
 . I $D(TFARR(I2)) W ?41,I2_". ",?44,"("_$P(TFARR(I2),"^",1)_") "_$P(TFARR(I2),"^",2) S I2=I2+1
"RTN","RGRPDAT",179,0)
 K I,I2
"RTN","RGRPDAT",180,0)
 Q
"RTN","RGRPDAT",181,0)
QUIT ;
"RTN","RGRPDAT",182,0)
 K Y
"RTN","RGRPDAT",183,0)
 Q
"VER")
8.0^22.0
**END**
**END**
