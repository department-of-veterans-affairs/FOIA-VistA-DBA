Released MPIF*1*34 SEQ #31
Extracted from mail message
**KIDS**:MPIF*1.0*34^

**INSTALL NAME**
MPIF*1.0*34
"BLD",1979,0)
MPIF*1.0*34^MASTER PATIENT INDEX VISTA^0^3040505^y
"BLD",1979,1,0)
^^3^3^3040505^
"BLD",1979,1,1,0)
CMOR CHANGE REQUEST AND INSTITUTIONS
"BLD",1979,1,2,0)
Refer to patch MPIF*1.0*34 in the FORUM Patch Module for a complete
"BLD",1979,1,3,0)
description.
"BLD",1979,4,0)
^9.64PA^^
"BLD",1979,"ABNS",0)
^9.66A^^
"BLD",1979,"ABPKG")
n^n^
"BLD",1979,"KRN",0)
^9.67PA^8989.52^19
"BLD",1979,"KRN",.4,0)
.4
"BLD",1979,"KRN",.401,0)
.401
"BLD",1979,"KRN",.402,0)
.402
"BLD",1979,"KRN",.403,0)
.403
"BLD",1979,"KRN",.5,0)
.5
"BLD",1979,"KRN",.84,0)
.84
"BLD",1979,"KRN",3.6,0)
3.6
"BLD",1979,"KRN",3.8,0)
3.8
"BLD",1979,"KRN",9.2,0)
9.2
"BLD",1979,"KRN",9.8,0)
9.8
"BLD",1979,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",1979,"KRN",9.8,"NM",1,0)
MPIFREQ^^0^B28321938
"BLD",1979,"KRN",9.8,"NM",2,0)
MPIFEDIT^^0^B30690550
"BLD",1979,"KRN",9.8,"NM","B","MPIFEDIT",2)

"BLD",1979,"KRN",9.8,"NM","B","MPIFREQ",1)

"BLD",1979,"KRN",19,0)
19
"BLD",1979,"KRN",19.1,0)
19.1
"BLD",1979,"KRN",101,0)
101
"BLD",1979,"KRN",409.61,0)
409.61
"BLD",1979,"KRN",771,0)
771
"BLD",1979,"KRN",870,0)
870
"BLD",1979,"KRN",8989.51,0)
8989.51
"BLD",1979,"KRN",8989.52,0)
8989.52
"BLD",1979,"KRN",8994,0)
8994
"BLD",1979,"KRN","B",.4,.4)

"BLD",1979,"KRN","B",.401,.401)

"BLD",1979,"KRN","B",.402,.402)

"BLD",1979,"KRN","B",.403,.403)

"BLD",1979,"KRN","B",.5,.5)

"BLD",1979,"KRN","B",.84,.84)

"BLD",1979,"KRN","B",3.6,3.6)

"BLD",1979,"KRN","B",3.8,3.8)

"BLD",1979,"KRN","B",9.2,9.2)

"BLD",1979,"KRN","B",9.8,9.8)

"BLD",1979,"KRN","B",19,19)

"BLD",1979,"KRN","B",19.1,19.1)

"BLD",1979,"KRN","B",101,101)

"BLD",1979,"KRN","B",409.61,409.61)

"BLD",1979,"KRN","B",771,771)

"BLD",1979,"KRN","B",870,870)

"BLD",1979,"KRN","B",8989.51,8989.51)

"BLD",1979,"KRN","B",8989.52,8989.52)

"BLD",1979,"KRN","B",8994,8994)

"BLD",1979,"QUES",0)
^9.62^^
"BLD",1979,"REQB",0)
^9.611^1^1
"BLD",1979,"REQB",1,0)
MPIF*1.0*30^1
"BLD",1979,"REQB","B","MPIF*1.0*30",1)

"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
34^3040505
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3040505
"PKG",282,22,1,"PAH",1,1,1,0)
CMOR CHANGE REQUEST AND INSTITUTIONS
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1.0*34 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","MPIFEDIT")
0^2^B30690550
"RTN","MPIFEDIT",1,0)
MPIFEDIT ;BHM/RGY-Request a CMOR for patient ;FEB 20, 1998
"RTN","MPIFEDIT",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**11,22,30,34**;30 Apr 99
"RTN","MPIFEDIT",3,0)
 ;
"RTN","MPIFEDIT",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFEDIT",5,0)
 ;
"RTN","MPIFEDIT",6,0)
 ;   EXC^RGHLLOG     IA #2796
"RTN","MPIFEDIT",7,0)
 ;   START^RGHLLOG   IA #2796
"RTN","MPIFEDIT",8,0)
 ;   STOP^RGHLLOG    IA #2796
"RTN","MPIFEDIT",9,0)
 ;   $$EN^VAFCPID    IA #3015
"RTN","MPIFEDIT",10,0)
 ;
"RTN","MPIFEDIT",11,0)
NEW ;
"RTN","MPIFEDIT",12,0)
 ;Entry point for option: MPIF NEW REQUEST - create a new request
"RTN","MPIFEDIT",13,0)
 ; to change CMOR.  No input or output variables.
"RTN","MPIFEDIT",14,0)
 ;
"RTN","MPIFEDIT",15,0)
 ;Only if the site is not the CMOR can this option be used
"RTN","MPIFEDIT",16,0)
 N DIC,X,Y,DTOUT,DUOUT,PAT
"RTN","MPIFEDIT",17,0)
 S DIC="^DPT(",DIC(0)="QEAMZ",DIC("A")="Select PATIENT: "
"RTN","MPIFEDIT",18,0)
 D ^DIC
"RTN","MPIFEDIT",19,0)
 Q:$D(DTOUT)!$D(DUOUT)!(Y=-1)
"RTN","MPIFEDIT",20,0)
 S PAT=+Y
"RTN","MPIFEDIT",21,0)
 I +$$GETICN^MPIF001(PAT)<0 W !!,"Patient doesn't have ICN, try again" G NEW
"RTN","MPIFEDIT",22,0)
 I $$GETVCCI^MPIF001(PAT)<0 W !!,"Patient doesn't have a CMOR, try again" G NEW
"RTN","MPIFEDIT",23,0)
 I $$GETVCCI^MPIF001(PAT)=$P($$SITE^VASITE(),"^",3) W !!,"You are the CMOR, to push the CMOR to another site use option: PUSH CMOR REQUEST" G NEW
"RTN","MPIFEDIT",24,0)
 ; CHECK IF ALREADY OPEN/PENDING REQUEST
"RTN","MPIFEDIT",25,0)
 N ENT,STOP
"RTN","MPIFEDIT",26,0)
 S ENT=0,STOP=0 F  S ENT=$O(^MPIF(984.9,"C",PAT,ENT)) Q:ENT=""!(STOP)  D
"RTN","MPIFEDIT",27,0)
 .I $P($G(^MPIF(984.9,ENT,0)),"^",6)<4 S STOP=1
"RTN","MPIFEDIT",28,0)
 I STOP W !!,"Already have request for this patient" G NEW
"RTN","MPIFEDIT",29,0)
 ;
"RTN","MPIFEDIT",30,0)
 N N0,PHONE,DA,DIE,DR,DIR,ERROR,DIK,Y,DIRUT,REQ,CMOR,MPIFREQ,CMORI
"RTN","MPIFEDIT",31,0)
 S DA=$$ADD^MPIFNEW()
"RTN","MPIFEDIT",32,0)
 S DIE="^MPIF(984.9,",DR=".04///`"_PAT D ^DIE
"RTN","MPIFEDIT",33,0)
 S REQ=$P($G(^MPIF(984.9,DA,0)),"^")
"RTN","MPIFEDIT",34,0)
 W !,"REQUEST NUMBER:",REQ
"RTN","MPIFEDIT",35,0)
 S CMOR=$$HL7CMOR^MPIF001($P($G(^MPIF(984.9,DA,0)),"^",4),"^")
"RTN","MPIFEDIT",36,0)
 ;station # ^ Station Name
"RTN","MPIFEDIT",37,0)
 S CMORI=$$IEN^XUAF4($P(CMOR,"^"))
"RTN","MPIFEDIT",38,0)
 W !,"*** Current CMOR: "_$P(CMOR,"^",2)_" ("_$P(CMOR,"^")_") ***"
"RTN","MPIFEDIT",39,0)
 S DIE="^MPIF(984.9,",DR=".07///`"_CMORI_";1.03///1;.09///`"_+$$SITE^VASITE() D ^DIE
"RTN","MPIFEDIT",40,0)
 ; ^ update site, type of action, and cmor after approval
"RTN","MPIFEDIT",41,0)
 ;
"RTN","MPIFEDIT",42,0)
 S REQ=DA
"RTN","MPIFEDIT",43,0)
EDIT I $D(DUZ) D
"RTN","MPIFEDIT",44,0)
 .S PHONE=$P($G(^MPIF(984.9,+$O(^MPIF(984.9,"AD",DUZ,""),-1),0)),"^",5)
"RTN","MPIFEDIT",45,0)
 .N DA,DIC,DIQ S DIQ="MPIFREQ",DR=".01",DIQ(0)="E",DIC="^VA(200,",DA=DUZ
"RTN","MPIFEDIT",46,0)
 .D EN^DIQ1
"RTN","MPIFEDIT",47,0)
 .S MPIFREQ=MPIFREQ(200,DUZ,.01,"E")
"RTN","MPIFEDIT",48,0)
 I '$D(DUZ) S (MPIFREQ,PHONE)=""
"RTN","MPIFEDIT",49,0)
 ;
"RTN","MPIFEDIT",50,0)
REASON S DIR("A")="Reason for Request",DIR("?")="Answer must be 3-60 characters in length.",DIR(0)="F^3:60" D ^DIR
"RTN","MPIFEDIT",51,0)
 I Y="" W !,"Answer must be 3-60 characters in length." G REASON
"RTN","MPIFEDIT",52,0)
 I Y="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFEDIT",53,0)
 S DIE="^MPIF(984.9,",DR="1.02///"_X D ^DIE
"RTN","MPIFEDIT",54,0)
REQNM S DIR("A")="Requestor's Name:",DIR("B")=MPIFREQ,DIR("?")="Answer must be a valid user",DIR(0)="P^200:EQZ" D ^DIR K DIR("B")
"RTN","MPIFEDIT",55,0)
 I Y="" W !,"Must pick valid user" G REQNM
"RTN","MPIFEDIT",56,0)
 I Y="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFEDIT",57,0)
 S DIE="^MPIF(984.9,",DR=".02///`"_+Y D ^DIE
"RTN","MPIFEDIT",58,0)
PHONE S DIR("A")="Requestor Phone:",DIR("B")=PHONE,DIR("?")="Answer must be 4-20 charaters in length.",DIR(0)="F" D ^DIR K DIR("B")
"RTN","MPIFEDIT",59,0)
 I Y="" W !,"Answer must be 4-20 charaters in length."  G PHONE
"RTN","MPIFEDIT",60,0)
 I Y="^" S DIK="^MPIF(984.9," D ^DIK W "... Request deleted" Q
"RTN","MPIFEDIT",61,0)
 S DIE="^MPIF(984.9,",DR=".05///"_X D ^DIE
"RTN","MPIFEDIT",62,0)
 I $$CHK^MPIFEDIT(DA) W !,"This request is missing required data." G EDIT
"RTN","MPIFEDIT",63,0)
 ;
"RTN","MPIFEDIT",64,0)
APP S DIR("A")="Select Request Action (SEND/EDIT/DELETE)? ",DIR("B")="SEND",DIR(0)="SAO^SEND:SEND;EDIT:EDIT;DELETE:DELETE"
"RTN","MPIFEDIT",65,0)
 D ^DIR K DIR
"RTN","MPIFEDIT",66,0)
 I $E(Y)="D"!$D(DIRUT) D  Q
"RTN","MPIFEDIT",67,0)
 .S DIK="^MPIF(984.9," D ^DIK W "... Request deleted"
"RTN","MPIFEDIT",68,0)
 .Q
"RTN","MPIFEDIT",69,0)
 I $E(Y)="E" G REASON
"RTN","MPIFEDIT",70,0)
 S DR=".08////^S X=2;.06////^S X=2",DIE="^MPIF(984.9," D ^DIE W !,"... Request will be sent"
"RTN","MPIFEDIT",71,0)
 ;
"RTN","MPIFEDIT",72,0)
 I '$D(REQ) S REQ=DA
"RTN","MPIFEDIT",73,0)
 S N0=$G(^MPIF(984.9,REQ,0)),CNT=0
"RTN","MPIFEDIT",74,0)
 I N0="" S ERROR="Node for request #"_REQ_" is not defined" Q
"RTN","MPIFEDIT",75,0)
 S INST=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFEDIT",76,0)
 N X,Y,DIC
"RTN","MPIFEDIT",77,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(N0,"^",2)
"RTN","MPIFEDIT",78,0)
 D ^DIC
"RTN","MPIFEDIT",79,0)
 I $G(Y)<1 S USER=""
"RTN","MPIFEDIT",80,0)
 I $G(Y)>0 S USER=$G(Y(0,0))
"RTN","MPIFEDIT",81,0)
 S REASON=$P($G(^MPIF(984.9,REQ,1)),"^",2)
"RTN","MPIFEDIT",82,0)
 S NDATE=$P(N0,"^",3)
"RTN","MPIFEDIT",83,0)
 S ICN=$$ICN^MPIFNQ(+$P(N0,"^",4))
"RTN","MPIFEDIT",84,0)
 S PHONE=$P(N0,"^",5)
"RTN","MPIFEDIT",85,0)
 S ID=$P(N0,"^")
"RTN","MPIFEDIT",86,0)
 K HLA
"RTN","MPIFEDIT",87,0)
 D INIT^HLFNC2("MPIF CMOR REQUEST",.HL)
"RTN","MPIFEDIT",88,0)
 I $O(HL(""))="" D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQ_" FOR ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG() D RESET^MPIFREQ(REQ) Q
"RTN","MPIFEDIT",89,0)
 K HLL("LINKS") N MPILK
"RTN","MPIFEDIT",90,0)
 S MPILK=$$MPILINK^MPIFAPI ;routing all messages through the MPI
"RTN","MPIFEDIT",91,0)
 I +MPILK<0 D  Q
"RTN","MPIFEDIT",92,0)
 .D START^RGHLLOG()
"RTN","MPIFEDIT",93,0)
 .D EXC^RGHLLOG(224,"No MPI link found for Change CMOR Request # "_REQ_" for ICN="_ICN,$P(N0,"^",4))
"RTN","MPIFEDIT",94,0)
 .D STOP^RGHLLOG()
"RTN","MPIFEDIT",95,0)
 .D RESET^MPIFREQ(REQ)
"RTN","MPIFEDIT",96,0)
 .S ERROR="-1^No Links found"
"RTN","MPIFEDIT",97,0)
 ;Broadcast new CMOR to MPI which will send it out to all sites
"RTN","MPIFEDIT",98,0)
 S HLL("LINKS",1)="MPIF CMOR RESPONSE^"_MPILK
"RTN","MPIFEDIT",99,0)
 S CNT=CNT+1,PID=$$EN^VAFCPID(+$P(N0,"^",4),"1,2,4,5,6,7,8,11,12,13,14,16,17,19")
"RTN","MPIFEDIT",100,0)
 S HLA("HLS",CNT)=PID
"RTN","MPIFEDIT",101,0)
 S CNT=CNT+1
"RTN","MPIFEDIT",102,0)
 S CMOR=$P($$HL7CMOR^MPIF001($P($G(^MPIF(984.9,DA,0)),"^",4),"^"),"^")
"RTN","MPIFEDIT",103,0)
 S HLA("HLS",CNT)="NTE"_HL("FS")_HL("FS")_"P"_HL("FS")_PHONE_HL("FS")_REASON_HL("FS")_HL("FS")_ID_HL("FS")_INST_HL("FS")_HL("FS")_CMOR
"RTN","MPIFEDIT",104,0)
 S CNT=CNT+1
"RTN","MPIFEDIT",105,0)
 S HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_USER
"RTN","MPIFEDIT",106,0)
 N RLST
"RTN","MPIFEDIT",107,0)
 D GENERATE^HLMA("MPIF CMOR REQUEST","LM",1,.RLST,"",.HL)
"RTN","MPIFEDIT",108,0)
 I 'RLST D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQ_" for ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG(),RESET^MPIFREQ(REQ)
"RTN","MPIFEDIT",109,0)
 K CNT,ICN,INST,NDATE,PID,REASON,RGL,USER,XX,ID
"RTN","MPIFEDIT",110,0)
 Q
"RTN","MPIFEDIT",111,0)
 ;
"RTN","MPIFEDIT",112,0)
CHK(IEN) ;
"RTN","MPIFEDIT",113,0)
 N N0,X,ERROR
"RTN","MPIFEDIT",114,0)
 S ERROR=0
"RTN","MPIFEDIT",115,0)
 S N0=$G(^MPIF(984.9,IEN,0))
"RTN","MPIFEDIT",116,0)
 F X=1:1:7 I $P(N0,"^",X)="" S ERROR=1 Q
"RTN","MPIFEDIT",117,0)
 I $P($G(^MPIF(984.9,IEN,1)),"^",2)="" S ERROR=1
"RTN","MPIFEDIT",118,0)
 Q ERROR
"RTN","MPIFREQ")
0^1^B28321938
"RTN","MPIFREQ",1,0)
MPIFREQ ;SF/TN/CMC-CMOR CHANGE REQUEST ;FEB 20, 1998
"RTN","MPIFREQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,6,11,26,30,34**;30 Apr 99
"RTN","MPIFREQ",3,0)
 ;
"RTN","MPIFREQ",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFREQ",5,0)
 ;
"RTN","MPIFREQ",6,0)
 ;   EXC^RGHLLOG     IA #2796
"RTN","MPIFREQ",7,0)
 ;   START^RGHLLOG   IA #2796
"RTN","MPIFREQ",8,0)
 ;   STOP^RGHLLOG    IA #2796
"RTN","MPIFREQ",9,0)
 ;   $$EN^VAFCPID    IA #3015
"RTN","MPIFREQ",10,0)
 ;
"RTN","MPIFREQ",11,0)
EN(TYPE,REQNO,ERROR,HL7) ;
"RTN","MPIFREQ",12,0)
 ; Create HL7 message for Change of CMOR Request
"RTN","MPIFREQ",13,0)
 N RGL,INST,USER,REASON,NDATE,ICN,PHONE,N0,CNT,HLA,HL,ID,XX,PID
"RTN","MPIFREQ",14,0)
 S CNT=0,HL=0
"RTN","MPIFREQ",15,0)
 S N0=$G(^MPIF(984.9,REQNO,0))
"RTN","MPIFREQ",16,0)
 I N0="" S ERROR="Node for request #"_REQNO_" is not defined" Q
"RTN","MPIFREQ",17,0)
 S INST=$P($$SITE^VASITE(),"^",3) ;station number
"RTN","MPIFREQ",18,0)
 N X,Y,DIC
"RTN","MPIFREQ",19,0)
 S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(N0,"^",2)
"RTN","MPIFREQ",20,0)
 D ^DIC
"RTN","MPIFREQ",21,0)
 I $G(Y)<1 S USER=""
"RTN","MPIFREQ",22,0)
 I $G(Y)>0 S USER=$G(Y(0,0))
"RTN","MPIFREQ",23,0)
 S REASON=$P($G(^MPIF(984.9,REQNO,1)),"^",2)
"RTN","MPIFREQ",24,0)
 S NDATE=$P(N0,"^",3)
"RTN","MPIFREQ",25,0)
 S ICN=$$ICN^MPIFNQ(+$P(N0,"^",4))
"RTN","MPIFREQ",26,0)
 S PHONE=$P(N0,"^",5)
"RTN","MPIFREQ",27,0)
 S ID=$P(N0,"^")
"RTN","MPIFREQ",28,0)
 D INIT^HLFNC2("MPIF CMOR REQUEST",.HL)
"RTN","MPIFREQ",29,0)
 I HL D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQNO_" FOR ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG() D RESET(REQNO) Q
"RTN","MPIFREQ",30,0)
 K HLL("LINKS") N MPILK
"RTN","MPIFREQ",31,0)
 S MPILK=$$MPILINK^MPIFAPI ;routing all messages through the MPI
"RTN","MPIFREQ",32,0)
 I +MPILK<0 D  Q
"RTN","MPIFREQ",33,0)
 .D START^RGHLLOG()
"RTN","MPIFREQ",34,0)
 .D EXC^RGHLLOG(224,"No MPI link found for Change CMOR Request # "_REQNO_" for ICN="_ICN,$P(N0,"^",4))
"RTN","MPIFREQ",35,0)
 .D STOP^RGHLLOG()
"RTN","MPIFREQ",36,0)
 .D RESET^MPIFREQ(REQNO)
"RTN","MPIFREQ",37,0)
 .S ERROR="-1^No Links found"
"RTN","MPIFREQ",38,0)
 ;Broadcast new CMOR to MPI which will send it out to all sites
"RTN","MPIFREQ",39,0)
 S HLL("LINKS",1)="MPIF CMOR RESPONSE^"_MPILK
"RTN","MPIFREQ",40,0)
 S CNT=CNT+1,PID=$$EN^VAFCPID(+$P(N0,"^",4),"1,2,4,5,6,7,8,11,12,13,14,16,17,19")
"RTN","MPIFREQ",41,0)
 S HLA("HLS",CNT)=PID
"RTN","MPIFREQ",42,0)
 S CNT=CNT+1
"RTN","MPIFREQ",43,0)
 S CMOR=$P(^MPIF(984.9,REQNO,0),"^",9),CMOR=$$STA^XUAF4(CMOR)
"RTN","MPIFREQ",44,0)
 S HLA("HLS",CNT)="NTE"_HL("FS")_HL("FS")_"P"_HL("FS")_PHONE_HL("FS")_REASON_HL("FS")_HL("FS")_ID_HL("FS")_INST_HL("FS")_HL("FS")_CMOR
"RTN","MPIFREQ",45,0)
 S CNT=CNT+1
"RTN","MPIFREQ",46,0)
 S HLA("HLS",CNT)="EVN"_HL("FS")_"A31"_HL("FS")_NDATE_HL("FS")_HL("FS")_""_HL("FS")_USER
"RTN","MPIFREQ",47,0)
 N RLST
"RTN","MPIFREQ",48,0)
 D GENERATE^HLMA("MPIF CMOR REQUEST","LM",1,.RLST,"",.HL)
"RTN","MPIFREQ",49,0)
 I 'RLST D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to setup HL7 for sending Change of CMOR Request # "_REQNO_" for ICN= "_ICN,$P(N0,"^",4)),STOP^RGHLLOG(),RESET(REQNO)
"RTN","MPIFREQ",50,0)
 Q
"RTN","MPIFREQ",51,0)
 ;
"RTN","MPIFREQ",52,0)
RESET(REQNO) ; reset status to Open
"RTN","MPIFREQ",53,0)
 S DIE="^MPIF(984.9,",DA=REQNO,DR=".06///1" D ^DIE
"RTN","MPIFREQ",54,0)
 K DIE,DA,DR
"RTN","MPIFREQ",55,0)
 Q
"RTN","MPIFREQ",56,0)
 ;
"RTN","MPIFREQ",57,0)
IN(INST,USER,REASON,NDATE,ICN,PHONE,ID) ;Process an incoming CMOR request
"RTN","MPIFREQ",58,0)
 N INSTN,PATIEN,MAIL,MPIF,TYPE,N0,IEN,XMCHAN,XMDUZ,XMTEXT,XMSUB,XMY,TEXT,X
"RTN","MPIFREQ",59,0)
 S PATIEN=$$GETDFN^MPIF001(ICN)
"RTN","MPIFREQ",60,0)
 I PATIEN<1 D  Q
"RTN","MPIFREQ",61,0)
 . D START^RGHLLOG()
"RTN","MPIFREQ",62,0)
 . D EXC^RGHLLOG(210,"Received CMOR Change Request for ICN "_ICN_" ICN not Found. Request # "_ID)
"RTN","MPIFREQ",63,0)
 . D STOP^RGHLLOG()
"RTN","MPIFREQ",64,0)
 S IEN=$$ADD^MPIFNEW(ID) ;add request to request file
"RTN","MPIFREQ",65,0)
 S TYPE=2 ;type of action to Request Received From
"RTN","MPIFREQ",66,0)
 S INSTN=$G(HL("SFN")) ; site that sent this message - station #
"RTN","MPIFREQ",67,0)
 S INST=$$IEN^XUAF4(INSTN),INST="`"_INST ; institution ien
"RTN","MPIFREQ",68,0)
 S DIE="^MPIF(984.9,",DA=IEN,DR="[MPIF REQUEST INCOMING]" D ^DIE
"RTN","MPIFREQ",69,0)
 I $$IFVCCI^MPIF001(+PATIEN)=-1 D PUSH(IEN) Q
"RTN","MPIFREQ",70,0)
 ; ^ your site isn't the CMOR, so this is a push to make you the CMOR
"RTN","MPIFREQ",71,0)
 S DIE="^MPIF(984.9,",DA=IEN,DR=".09///"_INST D ^DIE
"RTN","MPIFREQ",72,0)
 ; ^ update CMOR AFTER APPROVAL field
"RTN","MPIFREQ",73,0)
 I $$AUTO^MPIFNQ() D AUTO(IEN) Q
"RTN","MPIFREQ",74,0)
 S MAIL=$$MAIL^MPIFUTL()
"RTN","MPIFREQ",75,0)
 I MAIL="" S MAIL="MPIF EXCEPTIONS"
"RTN","MPIFREQ",76,0)
 S XMDUZ="MPI VISTA Package",XMTEXT="MPIF(1,",MPIF(1,1)="New Coordinating Master Of Record (CMOR) request received for patient "_$S($P($G(^DPT(+PATIEN,0)),U)]"":$P(^DPT(PATIEN,0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",1:"UNKNOWN")
"RTN","MPIFREQ",77,0)
 I MAIL="MPIF EXCEPTIONS" S XMTEXT=XMTEXT_" no mail group defined for CMOR requests"
"RTN","MPIFREQ",78,0)
 S XMSUB="CMOR Change Request #"_$P(^MPIF(984.9,IEN,0),"^"),XMY("G."_MAIL)="" D ^XMD
"RTN","MPIFREQ",79,0)
 Q
"RTN","MPIFREQ",80,0)
 ;
"RTN","MPIFREQ",81,0)
AUTO(REQNO) ;Process a request automatically
"RTN","MPIFREQ",82,0)
 N DFN,MPIFERR,DIE,DR,DA,CMOR,RES,CMORN
"RTN","MPIFREQ",83,0)
 S MPIFERR=0
"RTN","MPIFREQ",84,0)
 S DIE="^MPIF(984.9,",DR="[MPIF REVIEW AUTO]",DA=REQNO D ^DIE
"RTN","MPIFREQ",85,0)
 S DFN=$P($G(^MPIF(984.9,REQNO,0)),"^",4)
"RTN","MPIFREQ",86,0)
 S CMORN=$P($G(^MPIF(984.9,REQNO,0)),"^",7)
"RTN","MPIFREQ",87,0)
 S CMOR=$$CMORNAME^MPIF001(CMORN)
"RTN","MPIFREQ",88,0)
 I +CMOR=-1 D START^RGHLLOG(),EXC^RGHLLOG(220,"CMOR not sent in Change CMOR message for patient DFN= "_DFN_" Request # "_REQNO,DFN),STOP^RGHLLOG(),RESET2(REQNO)
"RTN","MPIFREQ",89,0)
 Q:+CMOR=-1      ;No CMOR defined
"RTN","MPIFREQ",90,0)
 I $P($G(^MPIF(984.9,REQNO,1)),"^",3)=2 D
"RTN","MPIFREQ",91,0)
 .S RES=1,RES=$$CHANGE^MPIF001(DFN,CMORN)
"RTN","MPIFREQ",92,0)
 .I +RES<1 I +RES<1 D START^RGHLLOG(),EXC^RGHLLOG(220,"Unable to Change CMOR to "_CMOR_" in a CMOR Change Message for Patient DFN= "_DFN_" Request # "+REQNO,DFN),STOP^RGHLLOG(),RESET2(REQNO)
"RTN","MPIFREQ",93,0)
 .Q:+RES<1
"RTN","MPIFREQ",94,0)
 .D BROAD^MPIFCMOR(REQNO,.MPIFERR)
"RTN","MPIFREQ",95,0)
 .I +MPIFERR=0 D EN^MPIFRESS(REQNO)
"RTN","MPIFREQ",96,0)
 .; ^ trigger approval msg
"RTN","MPIFREQ",97,0)
 Q
"RTN","MPIFREQ",98,0)
 ;
"RTN","MPIFREQ",99,0)
RESET2(REQNO) ; reset status to Pending Approval
"RTN","MPIFREQ",100,0)
 S DIE="^MPIF(984.9,",DA=REQNO,DR=".06///3" D ^DIE
"RTN","MPIFREQ",101,0)
 K DIE,DA,DR
"RTN","MPIFREQ",102,0)
 Q
"RTN","MPIFREQ",103,0)
 ;
"RTN","MPIFREQ",104,0)
PUSH(IEN) ;Change of CMOR Request is a Push
"RTN","MPIFREQ",105,0)
 ; just want to get request into 984.9 for
"RTN","MPIFREQ",106,0)
 ; tracking purposes, marking it as approved
"RTN","MPIFREQ",107,0)
 N DA,DIE,X,Y,TEXT
"RTN","MPIFREQ",108,0)
 S DIE="^MPIF(984.9,",DA=IEN,TEXT="Auto change - CMOR pushed here"
"RTN","MPIFREQ",109,0)
 S DR=".06///4;1.03///4;3.01///"_TEXT_";.09///`"_+$$SITE^VASITE()
"RTN","MPIFREQ",110,0)
 D ^DIE
"RTN","MPIFREQ",111,0)
 Q
"VER")
8.0^22.0
**END**
**END**
