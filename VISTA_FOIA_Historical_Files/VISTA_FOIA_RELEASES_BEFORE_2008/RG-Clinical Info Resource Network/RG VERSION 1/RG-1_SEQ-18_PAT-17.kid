Released RG*1*17 SEQ #18
Extracted from mail message
**KIDS**:RG*1.0*17^

**INSTALL NAME**
RG*1.0*17
"BLD",1231,0)
RG*1.0*17^CLINICAL INFO RESOURCE NETWORK^0^3010605^y
"BLD",1231,1,0)
^^5^5^3010605^
"BLD",1231,1,1,0)
INVALID DATE LAST TREATED EXCEPTION MESSAGES & HL7 MESSAGE ROUTING
"BLD",1231,1,2,0)
ENHANCEMENT
"BLD",1231,1,3,0)
 
"BLD",1231,1,4,0)
Refer to patch RG*1.0*17 in the FORUM Patch Module for a complete
"BLD",1231,1,5,0)
description.
"BLD",1231,4,0)
^9.64PA^991.8^1
"BLD",1231,4,991.8,0)
991.8
"BLD",1231,4,991.8,2,0)
^9.641^991.8^1
"BLD",1231,4,991.8,2,991.8,0)
CIRN SITE PARAMETER  (File-top level)
"BLD",1231,4,991.8,2,991.8,1,0)
^9.6411^14^1
"BLD",1231,4,991.8,2,991.8,1,14,0)
MPI/PD DATE LAST TREATED
"BLD",1231,4,991.8,222)
y^y^p^^^^n
"BLD",1231,4,"APDD",991.8,991.8)
 
"BLD",1231,4,"APDD",991.8,991.8,14)
 
"BLD",1231,4,"B",991.8,991.8)
 
"BLD",1231,"ABNS",0)
^9.66A^^
"BLD",1231,"ABPKG")
n^y^G.CIRN DEV@DEVCRN.ISC-ALBANY.VA.GOV
"BLD",1231,"INID")
^
"BLD",1231,"INIT")
 
"BLD",1231,"KRN",0)
^9.67PA^19^17
"BLD",1231,"KRN",.4,0)
.4
"BLD",1231,"KRN",.401,0)
.401
"BLD",1231,"KRN",.402,0)
.402
"BLD",1231,"KRN",.403,0)
.403
"BLD",1231,"KRN",.5,0)
.5
"BLD",1231,"KRN",.84,0)
.84
"BLD",1231,"KRN",3.6,0)
3.6
"BLD",1231,"KRN",3.8,0)
3.8
"BLD",1231,"KRN",9.2,0)
9.2
"BLD",1231,"KRN",9.8,0)
9.8
"BLD",1231,"KRN",9.8,"NM",0)
^9.68A^6^5
"BLD",1231,"KRN",9.8,"NM",1,0)
RGADT1^^0^B33623044
"BLD",1231,"KRN",9.8,"NM",2,0)
RGRSDYN^^0^B5803854
"BLD",1231,"KRN",9.8,"NM",4,0)
RGADTUT^^0^B12502120
"BLD",1231,"KRN",9.8,"NM",5,0)
RGADT2^^0^B25180459
"BLD",1231,"KRN",9.8,"NM",6,0)
RGADT^^0^B12663397
"BLD",1231,"KRN",9.8,"NM","B","RGADT",6)
 
"BLD",1231,"KRN",9.8,"NM","B","RGADT1",1)
 
"BLD",1231,"KRN",9.8,"NM","B","RGADT2",5)
 
"BLD",1231,"KRN",9.8,"NM","B","RGADTUT",4)
 
"BLD",1231,"KRN",9.8,"NM","B","RGRSDYN",2)
 
"BLD",1231,"KRN",19,0)
19
"BLD",1231,"KRN",19.1,0)
19.1
"BLD",1231,"KRN",101,0)
101
"BLD",1231,"KRN",101,"NM",0)
^9.68A^5^5
"BLD",1231,"KRN",101,"NM",1,0)
RG ADT ENCOUNTER DRIVER^^1^
"BLD",1231,"KRN",101,"NM",2,0)
RG ADT INPATIENT ENCOUNTER DRIVER^^0
"BLD",1231,"KRN",101,"NM",3,0)
RG ADT OUTPATIENT ENCOUNTER DRIVER^^0
"BLD",1231,"KRN",101,"NM",4,0)
SDAM APPOINTMENT EVENTS^^2
"BLD",1231,"KRN",101,"NM",5,0)
DGPM MOVEMENT EVENTS^^2
"BLD",1231,"KRN",101,"NM","B","DGPM MOVEMENT EVENTS",5)
 
"BLD",1231,"KRN",101,"NM","B","RG ADT ENCOUNTER DRIVER",1)
 
"BLD",1231,"KRN",101,"NM","B","RG ADT INPATIENT ENCOUNTER DRIVER",2)
 
"BLD",1231,"KRN",101,"NM","B","RG ADT OUTPATIENT ENCOUNTER DRIVER",3)
 
"BLD",1231,"KRN",101,"NM","B","SDAM APPOINTMENT EVENTS",4)
 
"BLD",1231,"KRN",409.61,0)
409.61
"BLD",1231,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",1231,"KRN",771,0)
771
"BLD",1231,"KRN",870,0)
870
"BLD",1231,"KRN",8994,0)
8994
"BLD",1231,"KRN","B",.4,.4)
 
"BLD",1231,"KRN","B",.401,.401)
 
"BLD",1231,"KRN","B",.402,.402)
 
"BLD",1231,"KRN","B",.403,.403)
 
"BLD",1231,"KRN","B",.5,.5)
 
"BLD",1231,"KRN","B",.84,.84)
 
"BLD",1231,"KRN","B",3.6,3.6)
 
"BLD",1231,"KRN","B",3.8,3.8)
 
"BLD",1231,"KRN","B",9.2,9.2)
 
"BLD",1231,"KRN","B",9.8,9.8)
 
"BLD",1231,"KRN","B",19,19)
 
"BLD",1231,"KRN","B",19.1,19.1)
 
"BLD",1231,"KRN","B",101,101)
 
"BLD",1231,"KRN","B",409.61,409.61)
 
"BLD",1231,"KRN","B",771,771)
 
"BLD",1231,"KRN","B",870,870)
 
"BLD",1231,"KRN","B",8994,8994)
 
"BLD",1231,"QUES",0)
^9.62^^
"BLD",1231,"REQB",0)
^9.611^3^3
"BLD",1231,"REQB",1,0)
RG*1.0*14^2
"BLD",1231,"REQB",2,0)
RG*1.0*15^2
"BLD",1231,"REQB",3,0)
RG*1.0*8^2
"BLD",1231,"REQB","B","RG*1.0*14",1)
 
"BLD",1231,"REQB","B","RG*1.0*15",2)
 
"BLD",1231,"REQB","B","RG*1.0*8",3)
 
"FIA",991.8)
CIRN SITE PARAMETER
"FIA",991.8,0)
^RGSITE(991.8,
"FIA",991.8,0,0)
991.8
"FIA",991.8,0,1)
y^y^p^^^^n
"FIA",991.8,0,10)
 
"FIA",991.8,0,11)
 
"FIA",991.8,0,"RLRO")
 
"FIA",991.8,0,"VR")
1.0^RG
"FIA",991.8,991.8)
1
"FIA",991.8,991.8,14)
 
"KRN",101,47,-1)
2^5
"KRN",101,47,0)
DGPM MOVEMENT EVENTS^MOVEMENT EVENTS v 5.0^^X^12553^^^^^^^5
"KRN",101,47,10,0)
^101.01PA^13^12
"KRN",101,47,10,13,0)
1814^^^
"KRN",101,47,10,13,"^")
RG ADT INPATIENT ENCOUNTER DRIVER
"KRN",101,86,-1)
2^4
"KRN",101,86,0)
SDAM APPOINTMENT EVENTS^Appointment Event Driver^^X^12553^^^^^^^16
"KRN",101,86,10,0)
^101.01PA^16^15
"KRN",101,86,10,16,0)
1815^^^
"KRN",101,86,10,16,"^")
RG ADT OUTPATIENT ENCOUNTER DRIVER
"KRN",101,1814,-1)
0^2
"KRN",101,1814,0)
RG ADT INPATIENT ENCOUNTER DRIVER^CIRN ADT Inpatient Data Capture^^X^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",101,1814,1,0)
^^7^7^3010313^
"KRN",101,1814,1,1,0)
The addition of the RG ADT INPATIENT ENCOUNTER DRIVER protocol will allow
"KRN",101,1814,1,2,0)
tracking of patient admissions and discharges on the Registration (PIMS)
"KRN",101,1814,1,3,0)
side.
"KRN",101,1814,1,4,0)
 
"KRN",101,1814,1,5,0)
This protocol builds HL7 messages that update the TREATING FACILITY LIST
"KRN",101,1814,1,6,0)
(#391.91) file, tracking the DATE LAST TREATED (#.03) and ADT/HL7 EVENT
"KRN",101,1814,1,7,0)
REASON (#.07) fields for a particular patient at a given facility.
"KRN",101,1814,15)
K RGDG101
"KRN",101,1814,20)
S RGDG101="" D EN^RGADT1
"KRN",101,1814,99)
58511,39902
"KRN",101,1815,-1)
0^3
"KRN",101,1815,0)
RG ADT OUTPATIENT ENCOUNTER DRIVER^CIRN ADT Outpatient Data Capture^^X^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",101,1815,1,0)
^101.06^7^7^3010314^^
"KRN",101,1815,1,1,0)
The addition of the RG ADT OUTPATIENT ENCOUNTER DRIVER protocol will 
"KRN",101,1815,1,2,0)
allow the tracking of patient information during clinic checkout 
"KRN",101,1815,1,3,0)
events initiated by the Scheduling (PIMS) module.
"KRN",101,1815,1,4,0)
 
"KRN",101,1815,1,5,0)
This protocol builds HL7 messages that update the TREATING FACILITY LIST
"KRN",101,1815,1,6,0)
(#391.91) file, tracking the DATE LAST TREATED (#.03) and ADT/HL7 EVENT
"KRN",101,1815,1,7,0)
REASON (#.07) fields for a particular patient at a given facility.
"KRN",101,1815,15)
K RGSD101
"KRN",101,1815,20)
S RGSD101="" D EN^RGADT1
"KRN",101,1815,99)
58511,40125
"KRN",101,1835,-1)
1^1
"KRN",101,1835,0)
RG ADT ENCOUNTER DRIVER
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^^0
"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
17^3010605
"PKG",272,22,1,"PAH",1,1,0)
^^5^5^3010605
"PKG",272,22,1,"PAH",1,1,1,0)
INVALID DATE LAST TREATED EXCEPTION MESSAGES & HL7 MESSAGE ROUTING
"PKG",272,22,1,"PAH",1,1,2,0)
ENHANCEMENT
"PKG",272,22,1,"PAH",1,1,3,0)
 
"PKG",272,22,1,"PAH",1,1,4,0)
Refer to patch RG*1.0*17 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,5,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","RGADT")
0^6^B12663397
"RTN","RGADT",1,0)
RGADT ;HIRMFO/GJC-ADT MESSAGE PROCESSING/ROUTING ;09/21/99
"RTN","RGADT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4,8,14,17**;30 Apr 99
"RTN","RGADT",3,0)
 Q  ; quit if called from the top
"RTN","RGADT",4,0)
 ;
"RTN","RGADT",5,0)
EN ;entry point to process local ADT messages.
"RTN","RGADT",6,0)
 ;
"RTN","RGADT",7,0)
 ;This is call by the following clients:
"RTN","RGADT",8,0)
 ; RG ADT-A01 CLIENT & RG ADT-A03 CLIENT (Generate/Process
"RTN","RGADT",9,0)
 ; Routine(771) & Routing Logic(774) field definitions
"RTN","RGADT",10,0)
 ;
"RTN","RGADT",11,0)
 ; Integration Agreements (IAs) utilized in this application:
"RTN","RGADT",12,0)
 ; #2051-$$FIND1^DIC
"RTN","RGADT",13,0)
 ; #2165-GENACK^HLMA1
"RTN","RGADT",14,0)
 ; #2171-$$LKUP^XUAF4
"RTN","RGADT",15,0)
 ; #2541-$$KSP^XUPARAM
"RTN","RGADT",16,0)
 ; #2701-$$GETDFN^MPIF001
"RTN","RGADT",17,0)
 ; #2702-$$MPINODE^MPIFAPI
"RTN","RGADT",18,0)
 ; #2988-IAs for VAFCTFU utilities
"RTN","RGADT",19,0)
 ; #3037-ADT/HL7 EVENT REASON (#391.72) file access
"RTN","RGADT",20,0)
 ; #10106-$$FMDATE^HLFNC
"RTN","RGADT",21,0)
 ;
"RTN","RGADT",22,0)
 Q:$G(HL("MTN"))="ACK"  ; quit if a ACK message type is passed here
"RTN","RGADT",23,0)
 K RGDC,RGDCDFN,RGDCERR,RGDCEVN,RGDCEVT1,RGDCPID,RGDCSFN,RGDCV,RGFLG
"RTN","RGADT",24,0)
 S RGFLG=0,U="^" D INITIZE^RGRSUTIL ; copy HL7 message into local RGDC
"RTN","RGADT",25,0)
 ; array
"RTN","RGADT",26,0)
 S RGDCV=$$EN^RGRSMSH() ;return: dt rec'd^event dt^sending fac.(xternal)
"RTN","RGADT",27,0)
 ; note: the above dates are in FileMan internal format
"RTN","RGADT",28,0)
 S RGDCFROM=$$LKUP^XUAF4(+$P(RGDCV,U,3)) ; facility that sent the
"RTN","RGADT",29,0)
 ; message.  Could differ from the facility where the event occurred 
"RTN","RGADT",30,0)
 ; if inbound data is sent from a site running RG*1.0*17
"RTN","RGADT",31,0)
 S RGDCPID=$$SEG1^RGRSUTIL("PID",1,"PID")
"RTN","RGADT",32,0)
 S RGDCPV1=$$SEG1^RGRSUTIL("PV1",1,"PV1")
"RTN","RGADT",33,0)
 S RGFLG=$S($P($P(RGDCPV1,HL("FS"),3),$E(HL("ECH")),4)["&":1,1:0)
"RTN","RGADT",34,0)
 ; if RGFLG, the inbound message is from a patch 17 site and this
"RTN","RGADT",35,0)
 ; site has patch 17 installed, so the message can be processed using
"RTN","RGADT",36,0)
 ; TF data off the PV1 segment
"RTN","RGADT",37,0)
 S RGDCEVN=$P($$SEG1^RGRSUTIL("EVN",1,"EVN"),HL("FS"),5)
"RTN","RGADT",38,0)
 ; RGDCEVN is the event reason code
"RTN","RGADT",39,0)
 S RGDCEVN=$$FIND1^DIC(391.72,"","AXM",RGDCEVN) ; event reason(internal)
"RTN","RGADT",40,0)
 S RGDCEVT1=$P($$SEG1^RGRSUTIL("EVN",1,"EVN"),HL("FS"),2) ; event type
"RTN","RGADT",41,0)
 S RGDCDFN=$$GETDFN^MPIF001(+$P(RGDCPID,HL("FS"),3))
"RTN","RGADT",42,0)
 ; Note: $P(RGDCPID,HL("FS"),3) is: ICN_"V"_ICN checksum
"RTN","RGADT",43,0)
 I RGFLG S RGDCSFN=$$SFN(RGDCPV1),RGDCSFN=$$LKUP^XUAF4(RGDCSFN)
"RTN","RGADT",44,0)
 S:'RGFLG RGDCSFN=RGDCFROM ; TF from MSH segment
"RTN","RGADT",45,0)
 ; RGDCSFN - obtain treating facility ien (file 4) from station #
"RTN","RGADT",46,0)
 ;
"RTN","RGADT",47,0)
 ; input variables to FILE^VAFCTFU
"RTN","RGADT",48,0)
 ; RGDCDFN - patient ien ; RGDCSFN - treating facility
"RTN","RGADT",49,0)
 ; $P(RGDCV,U,2) - date last treated ; RGDCEVN - event reason
"RTN","RGADT",50,0)
 D FILE^VAFCTFU(RGDCDFN,RGDCSFN_U_$P(RGDCV,U,2)_U_RGDCEVN,$$SFCMOR(RGDCDFN,RGDCFROM))
"RTN","RGADT",51,0)
 ; call to the TFL utility routine VAFCTFU.  Centrally located code
"RTN","RGADT",52,0)
 ; to add or edit to the TFL file. If $$SFCMOR(RGDCDFN,RGDCFROM)
"RTN","RGADT",53,0)
 ; returns 1, let the Pivot file handle updates (MFUs) to subscribers.
"RTN","RGADT",54,0)
 ; If 0, file data and do not re-broadcast.
"RTN","RGADT",55,0)
 ;
"RTN","RGADT",56,0)
 D GENACK ; generate the 'ack' message
"RTN","RGADT",57,0)
 ;
"RTN","RGADT",58,0)
KILL ; kill and exit
"RTN","RGADT",59,0)
 K HLINKP,HLINKX,HLL,RGDC,RGDCDFN,RGDCERR,RGDCEVN,RGDCEVT1,RGDCFROM,RGDCPID,RGDCPV1,RGDCSFN,RGDCV,RGFLG
"RTN","RGADT",60,0)
 Q
"RTN","RGADT",61,0)
 ;
"RTN","RGADT",62,0)
DYNROU(RGDCEVT) ; dynamic message routing, but first need to update the
"RTN","RGADT",63,0)
 ; TREATING FACILITY LIST (TFL-391.91) file at the local site
"RTN","RGADT",64,0)
 ; input-{RGDCEVT=event type
"RTN","RGADT",65,0)
 K RGDCEDT,RGDCEVTR,RGDCSITE
"RTN","RGADT",66,0)
 S RGDCSITE=$$KSP^XUPARAM("INST"),U="^"
"RTN","RGADT",67,0)
 S RGDCEDT=$$FMDATE^HLFNC($P($$EVN(),U,3)) ; determine event date/time
"RTN","RGADT",68,0)
 S RGDCEVTR=$$FIND1^DIC(391.72,"","AXM",$P($$EVN(),U,5)) ; event reason
"RTN","RGADT",69,0)
 ;
"RTN","RGADT",70,0)
 ; input variables to FILE^VAFCTFU
"RTN","RGADT",71,0)
 ; DFN - patient ien ; RGDCSITE - treating facility
"RTN","RGADT",72,0)
 ; RGDCEDT - date last treated ; RGDCEVTR - event reason
"RTN","RGADT",73,0)
 D FILE^VAFCTFU(DFN,RGDCSITE_U_RGDCEDT_U_RGDCEVTR,1)
"RTN","RGADT",74,0)
 ; call to the TFL utility routine VAFCTFU.  Centrally located code
"RTN","RGADT",75,0)
 ; to add or edit to the TFL file.
"RTN","RGADT",76,0)
 ;
"RTN","RGADT",77,0)
 ; route the message
"RTN","RGADT",78,0)
 D EN^RGRSDYN("RG ADT-"_RGDCEVT_" CLIENT",0)
"RTN","RGADT",79,0)
 K RGDCEDT,RGDCEVTR,RGDCSITE
"RTN","RGADT",80,0)
 Q
"RTN","RGADT",81,0)
EVN() ; pass back the EVN segment.
"RTN","RGADT",82,0)
 N I,X S I=0
"RTN","RGADT",83,0)
 F  S I=$O(HLA("HLS",I)) Q:I'>0  D  Q:$D(X)
"RTN","RGADT",84,0)
 . S:$P(HLA("HLS",I),U)="EVN" X=$G(HLA("HLS",I))
"RTN","RGADT",85,0)
 . Q
"RTN","RGADT",86,0)
 Q $G(X)
"RTN","RGADT",87,0)
GENACK ; Compile the 'ACK' segment, generate the 'ACK' message.
"RTN","RGADT",88,0)
 S HLA("HLA",1)="MSA"_HL("FS")_$S($G(RGDCERR)]"":"AE",1:"AA")_HL("FS")_HL("MID")_$S($G(RGDCERR)]"":HL("FS")_$G(RGDCERR),1:"")
"RTN","RGADT",89,0)
 S HLEID=HL("EID"),HLEIDS=HL("EIDS"),HLARYTYP="LM",HLFORMAT=1
"RTN","RGADT",90,0)
 D GENACK^HLMA1(HLEID,HLMTIENS,HLEIDS,HLARYTYP,HLFORMAT,.HLRESTLA)
"RTN","RGADT",91,0)
 Q
"RTN","RGADT",92,0)
 ;
"RTN","RGADT",93,0)
SFCMOR(DFN,SFAC) ; sent from CMOR?  Determine if the patient's CMOR sent
"RTN","RGADT",94,0)
 ; this VistA HL7 message
"RTN","RGADT",95,0)
 ; input: DFN (patient dfn); SFAC (sending facility, ptr file 4)
"RTN","RGADT",96,0)
 ; yield: 1 if sent from CMOR of patient, else 0
"RTN","RGADT",97,0)
 Q $S(SFAC=$P($$MPINODE^MPIFAPI(DFN),"^",3):1,1:0)
"RTN","RGADT",98,0)
 ;
"RTN","RGADT",99,0)
SFN(X) ; return the station number of the sending facility; PV1(3)
"RTN","RGADT",100,0)
 ; input: PV1 segment
"RTN","RGADT",101,0)
 ; yield: station number of sending facility
"RTN","RGADT",102,0)
 N Y S Y=$P(X,HL("FS"),4) ; pnt_of_care~room~bed~&fac. station #
"RTN","RGADT",103,0)
 S Y=$P(Y,$E(HL("ECH")),4) ; &fac. station #
"RTN","RGADT",104,0)
 Q $P(Y,$E(HL("ECH"),4),2) ; fac. station #
"RTN","RGADT1")
0^1^B33623044
"RTN","RGADT1",1,0)
RGADT1 ;HIRMFO/GJC-BUILD ADT MESSAGES (A01/A03) ;09/21/99
"RTN","RGADT1",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4,14,17**;30 Apr 99
"RTN","RGADT1",3,0)
 Q  ; quit if called from the top
"RTN","RGADT1",4,0)
 ;
"RTN","RGADT1",5,0)
EN ; entry point to build/transmit ADT messages
"RTN","RGADT1",6,0)
 ; Messages built by this software are fired off by server protocols:
"RTN","RGADT1",7,0)
 ; RG ADT-A01 SERVER -or- RG ADT-A03 SERVER
"RTN","RGADT1",8,0)
 ;
"RTN","RGADT1",9,0)
 ; This code is called from the RG ADT INPATIENT ENCOUNTER DRIVER &
"RTN","RGADT1",10,0)
 ; RG ADT OUTPATIENT ENCOUNTER DRIVER protocols.
"RTN","RGADT1",11,0)
 ;
"RTN","RGADT1",12,0)
 ; RG ADT OUTPATIENT ENCOUNTER DRIVER is an item protocol under the
"RTN","RGADT1",13,0)
 ; SDAM APPOINTMENTS EVENTS protocol & RG ADT INPATIENT ENCOUNTER DRIVER
"RTN","RGADT1",14,0)
 ; hangs off of the DGPM MOVEMENT EVENTS protocol.
"RTN","RGADT1",15,0)
 ;
"RTN","RGADT1",16,0)
 ; RG ADT OUTPATIENT ENCOUNTER DRIVER hangs off of SDAM APPOINTMENTS
"RTN","RGADT1",17,0)
 ; EVENTS because of DBIA: 1320; RG ADT INPATIENT ENCOUNTER DRIVER
"RTN","RGADT1",18,0)
 ; hangs off of DGPM MOVEMENT EVENTS because of DBIA: 1181.
"RTN","RGADT1",19,0)
 ;
"RTN","RGADT1",20,0)
 ; Integration Agreements (IAs) utilized in this application:
"RTN","RGADT1",21,0)
 ; #1181-subscribers for the DGPM MOVEMENT EVENTS event driver
"RTN","RGADT1",22,0)
 ; #1320-subscribers for the SDAM APPOINTMENT EVENTS event driver
"RTN","RGADT1",23,0)
 ; #2070-check for a national ICN 1st piece, "MPI" node (global read)
"RTN","RGADT1",24,0)
 ; #2161-INIT^HLFNC2
"RTN","RGADT1",25,0)
 ; #2164-GENERATE^HLMA
"RTN","RGADT1",26,0)
 ; #2171-$$WHAT^XUAF4 (Name_"^"_Station Number, we're after Station #)
"RTN","RGADT1",27,0)
 ; #2541-$$KSP^XUPARAM (facility ien, file 4)
"RTN","RGADT1",28,0)
 ; #2624-$$SEND^VAFHUTL()
"RTN","RGADT1",29,0)
 ; #3015-PID segment generation (CIRN PD)
"RTN","RGADT1",30,0)
 ; #3016-EVN segment generation (CIRN PD)
"RTN","RGADT1",31,0)
 ; #3017-PD1 segment generator (CIRN PD)
"RTN","RGADT1",32,0)
 ; #3018-PV1 segment generator (CIRN PD)
"RTN","RGADT1",33,0)
 ; #3072-assign a local ICN to a patient
"RTN","RGADT1",34,0)
 ;
"RTN","RGADT1",35,0)
 ; I $D(RGDG101) then we know we've dropped into this software
"RTN","RGADT1",36,0)
 ; from the DGPM MOVEMENT EVENTS protocol (RG ADT INPATIENT
"RTN","RGADT1",37,0)
 ; ENCOUNTER DRIVER)
"RTN","RGADT1",38,0)
 ;
"RTN","RGADT1",39,0)
 ; Note: DFN is a supported variable in the case of admissions and
"RTN","RGADT1",40,0)
 ; discharges within the Registration package. (part of the discovery
"RTN","RGADT1",41,0)
 ; in the development of RG*1.0*14)
"RTN","RGADT1",42,0)
 ;
"RTN","RGADT1",43,0)
 ; first check if HL7 2.3 messaging has been disabled.  DBIA: 2624
"RTN","RGADT1",44,0)
 I '$P($$SEND^VAFHUTL(),"^",2) Q
"RTN","RGADT1",45,0)
 S RGOK=0,RGDATE=""
"RTN","RGADT1",46,0)
 I $D(RGDG101) D
"RTN","RGADT1",47,0)
 . I $G(DFN)'=+$G(DFN) Q  ; DFN must be valid
"RTN","RGADT1",48,0)
 .; if an national ICN is missing, assign a local then quit
"RTN","RGADT1",49,0)
 . I '$P($G(^DPT(DFN,"MPI")),"^") S RGLOCAL=$$ICNLC^MPIF001(DFN) Q
"RTN","RGADT1",50,0)
 . Q:$$IFLOCAL^MPIF001(DFN)  ; IA 2701, patient has local icn, quit
"RTN","RGADT1",51,0)
 . N %,VAERR,VAIP
"RTN","RGADT1",52,0)
 . S VAIP("D")="LAST" D IN5^VADPT ; dfn should be defined at this point
"RTN","RGADT1",53,0)
 . S RGTYPE=+$G(VAIP(2)) ; RGTYPE=movement type
"RTN","RGADT1",54,0)
 . I RGTYPE'=1&(RGTYPE'=3) Q  ; admission or discharges only
"RTN","RGADT1",55,0)
 . S RGENVR=$S(RGTYPE=1:"A1",1:"A2") ; A1=admission, A2=discharge
"RTN","RGADT1",56,0)
 . S RGDATE=$P($G(VAIP(3)),"^"),RGMOV=$G(VAIP(1))
"RTN","RGADT1",57,0)
 . ; RGDATE=movement date/time, RGMOV=ien #405
"RTN","RGADT1",58,0)
 . S:RGDATE]"" RGOK=1
"RTN","RGADT1",59,0)
 . Q
"RTN","RGADT1",60,0)
 ;
"RTN","RGADT1",61,0)
 ; I $D(RGSD101) then we know we've dropped into this software
"RTN","RGADT1",62,0)
 ; from the SDAM APPOINTMENT EVENTS protocol (RG ADT OUTPATIENT
"RTN","RGADT1",63,0)
 ; ENCOUNTER DRIVER)
"RTN","RGADT1",64,0)
 ;
"RTN","RGADT1",65,0)
 ; Check SDAMEVT for values between five and nine inclusive.  See if
"RTN","RGADT1",66,0)
 ; this particular outpatient encounter has a status of CHECKED OUT.
"RTN","RGADT1",67,0)
 ; gjc@Hines OI for patch 14
"RTN","RGADT1",68,0)
 ;
"RTN","RGADT1",69,0)
 ; Note: DFN is not a supported variable in the case of clinic
"RTN","RGADT1",70,0)
 ; appointments and workload crediting for count clinics within the
"RTN","RGADT1",71,0)
 ; Scheduling package. (part of the discovery in the development of
"RTN","RGADT1",72,0)
 ; RG*1.0*14)
"RTN","RGADT1",73,0)
 ;
"RTN","RGADT1",74,0)
 ; check-out, stop code add/edit, disp add/edit?
"RTN","RGADT1",75,0)
 I $D(RGSD101),($D(SDAMEVT))#2 N DFN D
"RTN","RGADT1",76,0)
 . ; Note: DFN is unstable; it's up to us to define it...
"RTN","RGADT1",77,0)
 . ;chk-out, stop code add, stop code change, disp add & disp change
"RTN","RGADT1",78,0)
 . I SDAMEVT<5!(SDAMEVT>9) Q
"RTN","RGADT1",79,0)
 . S RGTYPE=SDAMEVT,RGENVR="A3"
"RTN","RGADT1",80,0)
 . N RGSDOE,RGPARSE,RGPROC,RGTMP S RGPROC=0
"RTN","RGADT1",81,0)
 . F  S RGPROC=$O(^TMP("SDEVT",$J,SDHDL,RGPROC)) Q:'RGPROC  D
"RTN","RGADT1",82,0)
 .. S RGSDOE=0
"RTN","RGADT1",83,0)
 .. F  S RGSDOE=$O(^TMP("SDEVT",$J,SDHDL,RGPROC,"SDOE",RGSDOE)) Q:'RGSDOE  D
"RTN","RGADT1",84,0)
 ... S RGSDOE(0)=$G(^TMP("SDEVT",$J,SDHDL,RGPROC,"SDOE",RGSDOE,0,"AFTER"))
"RTN","RGADT1",85,0)
 ... ; Note: RGSDOE(0)=zero node of 409.68, DFN is the second piece 
"RTN","RGADT1",86,0)
 ... S DFN=$P(RGSDOE(0),"^",2) Q:'DFN  ; DFN must exist
"RTN","RGADT1",87,0)
 ... ; ignore current inpatients
"RTN","RGADT1",88,0)
 ... Q:$L($G(^DPT(DFN,.1)))  ; ward location check IA: 10035
"RTN","RGADT1",89,0)
 ...; if an national ICN is missing, assign a local then quit
"RTN","RGADT1",90,0)
 ... I '$P($G(^DPT(DFN,"MPI")),"^") S RGLOCAL=$$ICNLC^MPIF001(DFN) Q
"RTN","RGADT1",91,0)
 ... Q:$$IFLOCAL^MPIF001(DFN)  ; IA 2701, patient has local icn, quit
"RTN","RGADT1",92,0)
 ... K RGPARSE D PARSE^SDOE(.RGSDOE,"EXTERNAL","RGPARSE")
"RTN","RGADT1",93,0)
 ... I $G(RGPARSE(.12))="CHECKED OUT" S RGTMP=$P(RGSDOE(0),U)
"RTN","RGADT1",94,0)
 ... I  S:RGTMP>RGDATE RGDATE=RGTMP
"RTN","RGADT1",95,0)
 ... Q
"RTN","RGADT1",96,0)
 .. Q
"RTN","RGADT1",97,0)
 . S:$G(RGDATE)]"" RGOK=1
"RTN","RGADT1",98,0)
 . Q
"RTN","RGADT1",99,0)
 ; S ^TMP("RGTRACE",$J)=1
"RTN","RGADT1",100,0)
 I 'RGOK K RGLOCAL,RGTYPE,RGMOV,RGDATE,RGENVR,RGOK Q  ; quit if not A01 or A03
"RTN","RGADT1",101,0)
 I '($G(DGQUIET)) S:$D(^TMP("RGTRACE",$J)) RGTRACE=1
"RTN","RGADT1",102,0)
 I $D(RGTRACE) D EVENT,EXIT Q
"RTN","RGADT1",103,0)
 N ZTDESC,ZTRTN,ZTSAVE,ZTIO,ZTDTH
"RTN","RGADT1",104,0)
 S ZTDESC="CIRN HL7 ADT-"_$S(RGTYPE=1:"A01",1:"A03")_" Messaging"
"RTN","RGADT1",105,0)
 S ZTRTN="EVENT^RGADT1",ZTIO="",ZTDTH=$H
"RTN","RGADT1",106,0)
 F I="DFN","RGDATE","RGTYPE","RGENVR" S ZTSAVE(I)=""
"RTN","RGADT1",107,0)
 S:$D(RGMOV) ZTSAVE("RGMOV")="" ; defined for admissions & discharges
"RTN","RGADT1",108,0)
 S:$D(SDOE) ZTSAVE("SDOE")="" ; file ien: 409.68, clinic check out
"RTN","RGADT1",109,0)
 D ^%ZTLOAD,EXIT
"RTN","RGADT1",110,0)
 Q
"RTN","RGADT1",111,0)
 ;
"RTN","RGADT1",112,0)
EVENT ; build the HL7 message
"RTN","RGADT1",113,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","RGADT1",114,0)
 S RGEVT=$S(RGTYPE=1:"A01",1:"A03") K HL
"RTN","RGADT1",115,0)
 D INIT^HLFNC2("RG ADT-"_RGEVT_" SERVER",.HL)
"RTN","RGADT1",116,0)
 I $G(HL) Q  ; error
"RTN","RGADT1",117,0)
 I RGTYPE=1!(RGTYPE=3) D  ; admission -or- discharge
"RTN","RGADT1",118,0)
 . D IN Q
"RTN","RGADT1",119,0)
 ;
"RTN","RGADT1",120,0)
 E  D OUT ; chkout, stop code add/edit, disp add/edit
"RTN","RGADT1",121,0)
 D:$$SHARE^RGADTUT(DFN_"^"_RGDATE_"^"_RGEVT) GENERATE^HLMA("RG ADT-"_RGEVT_" SERVER","LM",1,.RGRSLT,"",.HL)
"RTN","RGADT1",122,0)
 D KILL^HLTRANS K HLA("HLS")
"RTN","RGADT1",123,0)
 Q
"RTN","RGADT1",124,0)
EXIT ; kill and quit
"RTN","RGADT1",125,0)
 K ^TMP("RGTRACE",$J),RGDATE,RGENVR,RGEVT,RGOK,RGLOCAL,RGMOV,RGPAT
"RTN","RGADT1",126,0)
 K RGRSLT,RGFSTR,RGTRACE,RGTYPE
"RTN","RGADT1",127,0)
 Q
"RTN","RGADT1",128,0)
IN ; build the ADT message for admission/discharges (registration)
"RTN","RGADT1",129,0)
 ; EVN segment
"RTN","RGADT1",130,0)
 S HLA("HLS",1)=$$EVN^VAFHLEVN(RGEVT,RGENVR)
"RTN","RGADT1",131,0)
 S $P(HLA("HLS",1),HL("FS"),3)=$$HLDATE^HLFNC(RGDATE,"TS")
"RTN","RGADT1",132,0)
 ; PID segment
"RTN","RGADT1",133,0)
 S RGFSTR=$$COMMANUM(1,30)
"RTN","RGADT1",134,0)
 S HLA("HLS",2)=$$EN^VAFCPID(DFN,RGFSTR,1)
"RTN","RGADT1",135,0)
 ; PD1 segment
"RTN","RGADT1",136,0)
 S RGFSTR=$$COMMANUM(1,12)
"RTN","RGADT1",137,0)
 S HLA("HLS",3)=$$EN^VAFHLPD1(DFN,RGFSTR)
"RTN","RGADT1",138,0)
 ; PV1 segment
"RTN","RGADT1",139,0)
 S RGFSTR="2,3,4,5,"_$$COMMANUM(7,45)
"RTN","RGADT1",140,0)
 S HLA("HLS",4)=$$IN^VAFHLPV1(DFN,RGDATE,RGFSTR,RGMOV,"","")
"RTN","RGADT1",141,0)
 S HLA("HLS",4)=$$FAC(HLA("HLS",4))
"RTN","RGADT1",142,0)
 Q
"RTN","RGADT1",143,0)
OUT ; build the ADT message for scheduling events: checkout
"RTN","RGADT1",144,0)
 ; EVN segment
"RTN","RGADT1",145,0)
 S HLA("HLS",1)=$$EVN^VAFHLEVN(RGEVT,RGENVR)
"RTN","RGADT1",146,0)
 S $P(HLA("HLS",1),HL("FS"),3)=$$HLDATE^HLFNC(RGDATE,"TS")
"RTN","RGADT1",147,0)
 ; PID segment
"RTN","RGADT1",148,0)
 S RGFSTR=$$COMMANUM(1,30)
"RTN","RGADT1",149,0)
 S HLA("HLS",2)=$$EN^VAFCPID(DFN,RGFSTR,1)
"RTN","RGADT1",150,0)
 ; PD1 segment
"RTN","RGADT1",151,0)
 S RGFSTR=$$COMMANUM(1,12)
"RTN","RGADT1",152,0)
 S HLA("HLS",3)=$$EN^VAFHLPD1(DFN,RGFSTR)
"RTN","RGADT1",153,0)
 ; PV1 segment
"RTN","RGADT1",154,0)
 S RGFSTR="2,3,4,5,"_$$COMMANUM(7,45)
"RTN","RGADT1",155,0)
 S HLA("HLS",4)=$$EN^VAFHLPV1("",,RGFSTR,,HL("Q"),HL("FS"))
"RTN","RGADT1",156,0)
 S HLA("HLS",4)=$$FAC(HLA("HLS",4))
"RTN","RGADT1",157,0)
 Q
"RTN","RGADT1",158,0)
COMMANUM(FROM,TO) ;Build comma seperated list of numbers
"RTN","RGADT1",159,0)
 ;Input  : FROM - Starting number (default = 1)
"RTN","RGADT1",160,0)
 ;         TO - Ending number (default = FROM)
"RTN","RGADT1",161,0)
 ;Output : Comma seperated list of numbers between FROM and TO
"RTN","RGADT1",162,0)
 ;         (Ex: 1,2,3)
"RTN","RGADT1",163,0)
 ;Notes  : Call assumes FROM <= TO
"RTN","RGADT1",164,0)
 ;         copied from COMMANUM^VAFCADT2
"RTN","RGADT1",165,0)
 ;
"RTN","RGADT1",166,0)
 S FROM=$G(FROM) S:(FROM="") FROM=1
"RTN","RGADT1",167,0)
 S TO=$G(TO) S:(TO="") TO=FROM
"RTN","RGADT1",168,0)
 N OUTPUT,X
"RTN","RGADT1",169,0)
 S OUTPUT=FROM
"RTN","RGADT1",170,0)
 F X=(FROM+1):1:TO S OUTPUT=(OUTPUT_","_X)
"RTN","RGADT1",171,0)
 Q OUTPUT
"RTN","RGADT1",172,0)
 ;
"RTN","RGADT1",173,0)
FAC(X) ; set facility information, in the form of the Station Number, into
"RTN","RGADT1",174,0)
 ; PV1(3).
"RTN","RGADT1",175,0)
 ; input: the entire PV1 segment
"RTN","RGADT1",176,0)
 ; yield: updated PV1 segment; PV1(3) has facility information (Sta. #)
"RTN","RGADT1",177,0)
 N Y0,Y1 S Y0=$E(HL("ECH"),$L(HL("ECH")))_$$WHAT^XUAF4(+$$KSP^XUPARAM("INST"),99)
"RTN","RGADT1",178,0)
 S Y1=$P(X,HL("FS"),4),$P(Y1,$E(HL("ECH")),4)=Y0,$P(X,HL("FS"),4)=Y1
"RTN","RGADT1",179,0)
 Q X
"RTN","RGADT2")
0^5^B25180459
"RTN","RGADT2",1,0)
RGADT2 ;HIRMFO/GJC-TFL FILE SEEDING ROUTINE (PD-MPI LOAD) ;09/21/99
"RTN","RGADT2",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4,17**;30 Apr 99
"RTN","RGADT2",3,0)
 Q  ; quit if called from the top
"RTN","RGADT2",4,0)
 ;
"RTN","RGADT2",5,0)
EN ; entry point to check the TREATING FACILITY LIST (TFL-391.91) file
"RTN","RGADT2",6,0)
 ; for the proper LAST TREATMENT DATE.  This code is part of the post
"RTN","RGADT2",7,0)
 ; init for RG*1*4.  This can also be called from the EN1 entry point
"RTN","RGADT2",8,0)
 ; to determine the LAST TREATMENT DATE for a specific patient.
"RTN","RGADT2",9,0)
 ; Closely linked to the MFU event message broadcasts used to update
"RTN","RGADT2",10,0)
 ; the TFL (#391.91) file.
"RTN","RGADT2",11,0)
 ;
"RTN","RGADT2",12,0)
 ;IA: 2053 - FILE^DIE
"RTN","RGADT2",13,0)
 ;IA: 2070 - check for national ICN, 1st piece "MPI" node (global read)
"RTN","RGADT2",14,0)
 ;IA: 2701 - $$IFLOCAL^MPIF001
"RTN","RGADT2",15,0)
 ;IA: 2546 - GETGEN/PARSE^SDOE
"RTN","RGADT2",16,0)
 ;IA: 2988 - FILE^VAFCTFU
"RTN","RGADT2",17,0)
 ;IA: 2541 - $$KSP^XUPARAM
"RTN","RGADT2",18,0)
 ;IA: 2953 - ^SCE("ADFN"
"RTN","RGADT2",19,0)
 ;IA: 10061 - IN5^VADPT
"RTN","RGADT2",20,0)
 ;IA: 10103 - $$FMDIFF/$$NOW^XLFDT
"RTN","RGADT2",21,0)
 ;IA: 10104 - $$STRIP^XLFSTR
"RTN","RGADT2",22,0)
 ;IA: 10070 - ^XMD
"RTN","RGADT2",23,0)
 ;IA: 10141 - $$PARCP/$$UPCP^XPDUTL
"RTN","RGADT2",24,0)
 ;
"RTN","RGADT2",25,0)
 Q:$P($G(^RGSITE(991.8,1,1)),"^",2)  ; seeding process ran in the past
"RTN","RGADT2",26,0)
 ;
"RTN","RGADT2",27,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","RGADT2",28,0)
 S U="^",RGSITE=$$KSP^XUPARAM("INST") ;defines the local facility
"RTN","RGADT2",29,0)
 S RGSTRT=$$NOW^XLFDT(),RGCNT=0
"RTN","RGADT2",30,0)
 ; check to see if software is part of an KIDS install.  If not, no
"RTN","RGADT2",31,0)
 ; checkpoints needed.
"RTN","RGADT2",32,0)
 S RGICN=$S($D(XPDNM):+$$PARCP^XPDUTL("POST2"),1:0)
"RTN","RGADT2",33,0)
 ; check ALL patients with an Integration Control Number (ICN) for a
"RTN","RGADT2",34,0)
 ; given facility, make sure the DATE LAST TREATED field in the TFL
"RTN","RGADT2",35,0)
 ; file is correct.
"RTN","RGADT2",36,0)
 F  S RGICN=$O(^DPT("AICN",RGICN)) Q:RGICN'>0  D
"RTN","RGADT2",37,0)
 . S RGDFN=0
"RTN","RGADT2",38,0)
 . F  S RGDFN=$O(^DPT("AICN",RGICN,RGDFN)) Q:RGDFN'>0  D EN1(RGDFN)
"RTN","RGADT2",39,0)
 . S RGCNT=RGCNT+1 ; increment record counter
"RTN","RGADT2",40,0)
 . S:$D(XPDNM) RGSAVE=$$UPCP^XPDUTL("POST2",RGICN)
"RTN","RGADT2",41,0)
 . Q
"RTN","RGADT2",42,0)
 S RGFIN=$$NOW^XLFDT() D EMAIL^RGADT2 ; send completion message to user
"RTN","RGADT2",43,0)
 ; populate the 'MPI/PD SEEDING COMP DATE/TIME' (#12) field in the CIRN
"RTN","RGADT2",44,0)
 ; SITE PARAMETER FILE (#991.8)  (do not re-seed a facility)
"RTN","RGADT2",45,0)
 K RGFDA S RGFDA(991.8,"1,",12)=$$NOW^XLFDT()
"RTN","RGADT2",46,0)
 D FILE^DIE("K","RGFDA"),KILL
"RTN","RGADT2",47,0)
 QUIT
"RTN","RGADT2",48,0)
 ;
"RTN","RGADT2",49,0)
EN1(RGDFN,RGSUP) ; determine the LAST TREATMENT DATE for a single
"RTN","RGADT2",50,0)
 ; patient called from our seeding process above.
"RTN","RGADT2",51,0)
 ; input: RGDFN - the dfn of the patient
"RTN","RGADT2",52,0)
 ;        RGSUP - if 1, suppress add entries to the ADT HL7 PIVOT
"RTN","RGADT2",53,0)
 ;                (#391.71) file for TF messaging - VAFCTFMF (optional)
"RTN","RGADT2",54,0)
 ; output: RGDATE - patient's DATE LAST TREATED
"RTN","RGADT2",55,0)
 ;         RGENVR - event reason
"RTN","RGADT2",56,0)
 ;
"RTN","RGADT2",57,0)
 Q:$$LOCICN(RGDFN,$G(RGICN))  ; local ICN
"RTN","RGADT2",58,0)
 S U="^"
"RTN","RGADT2",59,0)
 S:'$D(RGSITE) RGSITE=$$KSP^XUPARAM("INST") ;defines the local facility
"RTN","RGADT2",60,0)
 S (RGLAST,RGADMDIS)=$$ADMDIS(RGDFN) ; dt_"^"_event type or ""
"RTN","RGADT2",61,0)
 S RGADMDIS=$S(RGADMDIS]"":$P(RGADMDIS,"^"),1:"") ; event dt or null
"RTN","RGADT2",62,0)
 S:$P(RGLAST,"^",2)=3!(RGLAST="") RGENCDT=$$ENCDT(RGDFN,RGADMDIS)
"RTN","RGADT2",63,0)
 ; patient has been discharged or has never been admitted.  Has this
"RTN","RGADT2",64,0)
 ; individual been checked out of a clinic? 
"RTN","RGADT2",65,0)
 I $D(RGENCDT)#2,($P(RGLAST,U)) S RGLAST=$S(+RGENCDT>+RGLAST:RGENCDT,1:RGLAST)
"RTN","RGADT2",66,0)
 I $D(RGENCDT)#2,('$P(RGLAST,U)) S RGLAST=RGENCDT
"RTN","RGADT2",67,0)
 S RGTYPE=$P(RGLAST,"^",2),RGDATE=+RGLAST
"RTN","RGADT2",68,0)
 ; input variables to FILE^VAFCTFU
"RTN","RGADT2",69,0)
 ; RGDFN - patient ien ; RGSITE - treating facility
"RTN","RGADT2",70,0)
 ; RGDATE - date last treated ; RGENVR - event reason
"RTN","RGADT2",71,0)
 ;
"RTN","RGADT2",72,0)
 I RGDATE D SETMSG,FILE^VAFCTFU(RGDFN,RGSITE_U_RGDATE_U_RGENVR,$G(RGSUP))
"RTN","RGADT2",73,0)
 ; update the TFL file for the site running the seeding process,
"RTN","RGADT2",74,0)
 ; then build the HL7 message with the new DATE LAST TREATED &
"RTN","RGADT2",75,0)
 ; ADT/HL7 EVENT REASON values & send them to our CMOR/subscribers.
"RTN","RGADT2",76,0)
 ;
"RTN","RGADT2",77,0)
 D:$G(XPDNM)'="RG*1.0*4" KILL ; single patient operation, kill all
"RTN","RGADT2",78,0)
 ; variables (EN1 re-entrant when running post-install for RG*1.0*4)
"RTN","RGADT2",79,0)
 Q
"RTN","RGADT2",80,0)
 ;
"RTN","RGADT2",81,0)
KILL ; kill and quit
"RTN","RGADT2",82,0)
 K DFN,RGADMDIS,RGCNT,RGDATE,RGDFN,RGENCDT,RGENVR,RGFDA,RGFIN,RGICN
"RTN","RGADT2",83,0)
 K RGLAST,RGSAVE,RGSITE,RGSTRT,RGTYPE
"RTN","RGADT2",84,0)
 Q
"RTN","RGADT2",85,0)
 ;
"RTN","RGADT2",86,0)
ADMDIS(DFN) ; find the patient's last admission and discharge dates if
"RTN","RGADT2",87,0)
 ; they exist.
"RTN","RGADT2",88,0)
 ; Input: DFN - ien of the patient (file 2)
"RTN","RGADT2",89,0)
 ;Output: a valid discharge/admission date/time concatenated with
"RTN","RGADT2",90,0)
 ;        the event type (1=admission, 3=discharge) -or- null
"RTN","RGADT2",91,0)
 N %,VAERR,VAIP S VAIP("D")="LAST" D IN5^VADPT
"RTN","RGADT2",92,0)
 I '+$G(VAIP(17,1)),('+$G(VAIP(13,1))) Q ""
"RTN","RGADT2",93,0)
 ; no discharge date, no admission date, return null
"RTN","RGADT2",94,0)
 I '+$G(VAIP(17,1)) Q $P($G(VAIP(13,1)),U)_"^1"
"RTN","RGADT2",95,0)
 ; no discharge date, return admission date
"RTN","RGADT2",96,0)
 I '+$G(VAIP(13,1)) Q $P($G(VAIP(17,1)),U)_"^3"
"RTN","RGADT2",97,0)
 ; no admission date, return discharge date
"RTN","RGADT2",98,0)
 I +$G(VAIP(17,1))>(+$G(VAIP(13,1))) Q +$G(VAIP(17,1))_"^3"
"RTN","RGADT2",99,0)
 ; return discharge date
"RTN","RGADT2",100,0)
 Q +$G(VAIP(13,1))_"^1" ; return admission date
"RTN","RGADT2",101,0)
 ;
"RTN","RGADT2",102,0)
ENCDT(DFN,INPDT) ; find the last patient check out date/time.  'ADFN'
"RTN","RGADT2",103,0)
 ; cross-reference accessed through DBIA: 2953
"RTN","RGADT2",104,0)
 ; Input: DFN  - ien of the patient (file 2)
"RTN","RGADT2",105,0)
 ;        INPDT - date (if any) returned from the inpatient admission/
"RTN","RGADT2",106,0)
 ;               discharge subroutine     
"RTN","RGADT2",107,0)
 ;Output: a valid discharge/admission date/time concatenated with
"RTN","RGADT2",108,0)
 ;        the event type (5=check out) -or- null
"RTN","RGADT2",109,0)
 Q:'DFN "" ; we need dfn defined
"RTN","RGADT2",110,0)
 K RGDATA,RGPURGE,RGX,RGX1,RGX2 N RGX3
"RTN","RGADT2",111,0)
 S RGX=9999999.9999999,RGX2=0,RGX3=""
"RTN","RGADT2",112,0)
 F  S RGX=$O(^SCE("ADFN",DFN,RGX),-1) Q:'RGX!(INPDT>RGX)  D  Q:RGX2
"RTN","RGADT2",113,0)
 . S RGX1=0 F  S RGX1=$O(^SCE("ADFN",DFN,RGX,RGX1)) Q:'RGX1  D  Q:RGX2
"RTN","RGADT2",114,0)
 .. D GETGEN^SDOE(RGX1,"RGDATA")
"RTN","RGADT2",115,0)
 .. D PARSE^SDOE(.RGDATA,"EXTERNAL","RGPARSE")
"RTN","RGADT2",116,0)
 .. I $G(RGPARSE(.12))="CHECKED OUT" S RGX2=1,RGX3=RGX
"RTN","RGADT2",117,0)
 .. K RGDATA,RGPARSE
"RTN","RGADT2",118,0)
 .. Q
"RTN","RGADT2",119,0)
 . Q
"RTN","RGADT2",120,0)
 K RGDATA,RGPURGE,RGX,RGX1,RGX2
"RTN","RGADT2",121,0)
 Q RGX3_"^5" ; X is either null or the date/time of the check out
"RTN","RGADT2",122,0)
 ;
"RTN","RGADT2",123,0)
SETMSG ; define the variables used to build a HL7 message (RGADT1)
"RTN","RGADT2",124,0)
 S DFN=RGDFN
"RTN","RGADT2",125,0)
 S RGENVR=$S(RGTYPE=1:"A1",RGTYPE=3:"A2",1:"A3") ;A1=adm;A2=dis;A3=CO 
"RTN","RGADT2",126,0)
 Q
"RTN","RGADT2",127,0)
 ;
"RTN","RGADT2",128,0)
EMAIL ; Send a completion email message to the user who installed this patch,
"RTN","RGADT2",129,0)
 ; RG*1*4.  Show the number of records processed, elapsed time and the
"RTN","RGADT2",130,0)
 ; number of records processed per minute.
"RTN","RGADT2",131,0)
 N RGELAPS,RGARY,RGMIN
"RTN","RGADT2",132,0)
 S XMDUZ=.5,XMY(DUZ)="",XMTEXT="RGARY(1,"
"RTN","RGADT2",133,0)
 S XMSUB="CIRN-CPRS DATE LAST TREATED seeding (#391.91 ; .03) results"
"RTN","RGADT2",134,0)
 S RGMIN=$$FMDIFF^XLFDT(RGFIN,RGSTRT,2)/60 ; # of sec x (1 min/60 sec)
"RTN","RGADT2",135,0)
 S:RGMIN=0 RGMIN=1 ; avoid a possible divide by zero
"RTN","RGADT2",136,0)
 S RGELAPS=$$FMDIFF^XLFDT(RGFIN,RGSTRT,3)
"RTN","RGADT2",137,0)
 S RGARY(1,1)="# of processed patients, in the PATIENT (#2) file"
"RTN","RGADT2",138,0)
 S RGARY(1,2)="with an ICN: "_RGCNT
"RTN","RGADT2",139,0)
 S RGARY(1,3)="TFL seeding process run time: "_RGELAPS_" (DD HH:MM:SS format)"
"RTN","RGADT2",140,0)
 S RGARY(1,4)="# of records processed per minute: "_$$STRIP^XLFSTR($J((RGCNT/RGMIN),8,2)," ")
"RTN","RGADT2",141,0)
 D ^XMD K XMDUZ,XMSUB,XMTEXT,XMY
"RTN","RGADT2",142,0)
 Q
"RTN","RGADT2",143,0)
 ;
"RTN","RGADT2",144,0)
LOCICN(DFN,ICN) ; check if this patient has a national ICN without having a
"RTN","RGADT2",145,0)
 ; local ICN.  This function is used when an entire site (all patients)
"RTN","RGADT2",146,0)
 ; is seeding, or for individual patient seeding.
"RTN","RGADT2",147,0)
 ; note: IA 2070 covers the hit on the 'MPI' node
"RTN","RGADT2",148,0)
 ;       IA 2701 covers the call to $$IFLOCAL^MPIF001
"RTN","RGADT2",149,0)
 ;input variables:
"RTN","RGADT2",150,0)
 ; DFN(required)-Patient ien (PATIENT file #2)
"RTN","RGADT2",151,0)
 ; ICN(optional)-Integration Control Number(fld: 991.01, file 2)
"RTN","RGADT2",152,0)
 ;output variable:
"RTN","RGADT2",153,0)
 ; FLAG-0 if the patient has a national ICN and not a local ICN, else 1
"RTN","RGADT2",154,0)
 N FLAG S FLAG=1
"RTN","RGADT2",155,0)
 I +$G(ICN) D
"RTN","RGADT2",156,0)
 . I $P($G(^DPT(DFN,"MPI")),"^")=ICN,('$$IFLOCAL^MPIF001(DFN)) S FLAG=0
"RTN","RGADT2",157,0)
 . Q
"RTN","RGADT2",158,0)
 E  D
"RTN","RGADT2",159,0)
 . I $P($G(^DPT(DFN,"MPI")),"^"),('$$IFLOCAL^MPIF001(DFN)) S FLAG=0
"RTN","RGADT2",160,0)
 . Q
"RTN","RGADT2",161,0)
 Q FLAG
"RTN","RGADTUT")
0^4^B12502120
"RTN","RGADTUT",1,0)
RGADTUT ;HIRMFO/GJC-utility; determine pat. subscriptions (A01/A03) ;09/21/99
"RTN","RGADTUT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**17**;30 Apr 99
"RTN","RGADTUT",3,0)
 ;
"RTN","RGADTUT",4,0)
 ; Integration Agreements (IAs) utilized in this application:
"RTN","RGADTUT",5,0)
 ; #2270-call to HLSUB (ACT, GET & UPDATE)
"RTN","RGADTUT",6,0)
 ; #2271-call to LINK^HLUTIL3
"RTN","RGADTUT",7,0)
 ; #2541-call to $$KSP^XUPARAM
"RTN","RGADTUT",8,0)
 ; #2706-call to $$UPDATE^MPIFAPI
"RTN","RGADTUT",9,0)
 ; #2796-call to RGHLLOG (EXC, START & STOP)
"RTN","RGADTUT",10,0)
 ; #2988-call to FILE^VAFCTFU
"RTN","RGADTUT",11,0)
 ;
"RTN","RGADTUT",12,0)
 ; Note: SHARE function is called from RGADT1 to determine if VistA HL7
"RTN","RGADTUT",13,0)
 ; messages are to be built (is GENERATE^HLMA to be called?)
"RTN","RGADTUT",14,0)
 ;
"RTN","RGADTUT",15,0)
SHARE(RGZSTR) ; determine if the patient is shared:
"RTN","RGADTUT",16,0)
 ; a) If shared, return one to RGADT1 and call GENERATE^HLMA
"RTN","RGADTUT",17,0)
 ; b) If not shared and the host facility is the CMOR, update
"RTN","RGADTUT",18,0)
 ;    host TFL record, do not call GENERATE^HLMA
"RTN","RGADTUT",19,0)
 ; c) If not shared and the host facility is not the CMOR, add
"RTN","RGADTUT",20,0)
 ;    the CMOR to the subscription list, return one to RGADT1
"RTN","RGADTUT",21,0)
 ;    and call GENERATE^HLMA
"RTN","RGADTUT",22,0)
 ;
"RTN","RGADTUT",23,0)
 ; input=> RGZSTR-patient_dfn^date_last_treated^event_type
"RTN","RGADTUT",24,0)
 ; yield=> 0 to prevent calling GENERATE^HLMA, else make the call
"RTN","RGADTUT",25,0)
 ;
"RTN","RGADTUT",26,0)
 ; note: 1) Event Type will equal A01 or A03.  This needs to be
"RTN","RGADTUT",27,0)
 ;          converted a valid ADT/HL7 EVENT REASON (#391.72) entry.
"RTN","RGADTUT",28,0)
 ;       2) RGSD101 & RGDG101 are assumed to have a global scope
"RTN","RGADTUT",29,0)
 ;
"RTN","RGADTUT",30,0)
 N HLDT,HLINKP,HLINKX,RGZCMOR,RGZDFN,RGZDT,RGZEVT,RGZFLG,RGZHLL,RGZMPI
"RTN","RGADTUT",31,0)
 N RGZSF,RGZSUB
"RTN","RGADTUT",32,0)
 S RGZDFN=$P(RGZSTR,"^"),RGZDT=$P(RGZSTR,"^",2),RGZEVT=$P(RGZSTR,"^",3)
"RTN","RGADTUT",33,0)
 S RGZMPI=$$MPINODE^MPIFAPI(RGZDFN),RGZSF=$$KSP^XUPARAM("INST")
"RTN","RGADTUT",34,0)
 ; note to myself: missing MPI node, update TFL & return 0
"RTN","RGADTUT",35,0)
 ;I +RGZMPI=-1 D TFL Q 0 <= should never occur, RGADT1 checks for ICN
"RTN","RGADTUT",36,0)
 S RGZCMOR=$P($G(RGZMPI),"^",3),RGZSUB=$P($G(RGZMPI),"^",5)
"RTN","RGADTUT",37,0)
 D:RGZSUB GET^HLSUB(RGZSUB,0,,.RGZHLL) ; find shared sites
"RTN","RGADTUT",38,0)
 S RGZFLG=+$O(RGZHLL("LINKS",$C(32)),-1)
"RTN","RGADTUT",39,0)
 ; at this point if RGZFLG>0 yield RGZFLG, else evaluate the conditions
"RTN","RGADTUT",40,0)
 ; listed above (b & c)
"RTN","RGADTUT",41,0)
 I 'RGZFLG D  ; no shared sites, take action (RGZFLG may be reset)
"RTN","RGADTUT",42,0)
 .I 'RGZCMOR D TFL Q  ;CMOR not found, subsequent conditions not met
"RTN","RGADTUT",43,0)
 .;
"RTN","RGADTUT",44,0)
 .;b) the host site is the CMOR, update local TFL record, quit
"RTN","RGADTUT",45,0)
 .I RGZSF,(RGZSF=RGZCMOR) D TFL Q
"RTN","RGADTUT",46,0)
 .;
"RTN","RGADTUT",47,0)
 .;c) if we're not the CMOR, we'll add the CMOR to the subscription list
"RTN","RGADTUT",48,0)
 .I RGZSF,(RGZSF'=RGZCMOR) D
"RTN","RGADTUT",49,0)
 ..N RGZ774,RGZERR,RGZLL
"RTN","RGADTUT",50,0)
 ..D LINK^HLUTIL3(RGZCMOR,.RGZLL)
"RTN","RGADTUT",51,0)
 ..;log. link for CMOR missing, log exception, file data in TFL & quit
"RTN","RGADTUT",52,0)
 ..I '$O(RGZLL(0)) D  Q
"RTN","RGADTUT",53,0)
 ...D EXC("Cannot add CMOR (#4): "_RGZCMOR_", as a subscriber to: "_RGZSF_" (#4)")
"RTN","RGADTUT",54,0)
 ...D TFL
"RTN","RGADTUT",55,0)
 ...Q
"RTN","RGADTUT",56,0)
 ..;found the CMOR's logical link, add the subscription
"RTN","RGADTUT",57,0)
 ..S RGZLL=RGZLL($O(RGZLL(0))),RGZ774=$$ACT^HLSUB
"RTN","RGADTUT",58,0)
 ..D UPD^HLSUB(RGZ774,RGZLL,1,"","","",.RGZERR)
"RTN","RGADTUT",59,0)
 ..; if update errored: log exception, file data into TFL & quit
"RTN","RGADTUT",60,0)
 ..I $O(RGZERR(0)) D  Q
"RTN","RGADTUT",61,0)
 ...D EXC("Subscription add (#774) failed for DFN: "_RGZDFN_", subscriber: "_RGZLL)
"RTN","RGADTUT",62,0)
 ...D TFL
"RTN","RGADTUT",63,0)
 ...Q
"RTN","RGADTUT",64,0)
 ..;subscription added, set flag (HL7 message can be generated)
"RTN","RGADTUT",65,0)
 ..E  S RGZFLG=1
"RTN","RGADTUT",66,0)
 ..;update the SUBSCRIPTION CONTROL NUMBER (#991.05) field, file #2
"RTN","RGADTUT",67,0)
 ..K RGZERR N RGZARR
"RTN","RGADTUT",68,0)
 ..S RGZARR(991.05)=RGZ774,RGZERR=$$UPDATE^MPIFAPI(RGZDFN,"RGZARR")
"RTN","RGADTUT",69,0)
 ..;if error updating field, file an exception
"RTN","RGADTUT",70,0)
 ..I +RGZERR=-1 D EXC("Subscription add (fld: 991.05, file: #2) failed for DFN: "_RGZDFN_", subscriber: "_RGZLL)
"RTN","RGADTUT",71,0)
 ..Q
"RTN","RGADTUT",72,0)
 .Q
"RTN","RGADTUT",73,0)
 Q RGZFLG ;shared site(s) found/added? 0=no, else yes...
"RTN","RGADTUT",74,0)
 ;
"RTN","RGADTUT",75,0)
EXC(RGX) ; log an exception because:
"RTN","RGADTUT",76,0)
 ;a) logical link not found for CMOR
"RTN","RGADTUT",77,0)
 ;b) new subscription not added to Subscription Control (#774) file
"RTN","RGADTUT",78,0)
 ;c) subscription control pointer not added to "MPI" node (fld: 991.05)
"RTN","RGADTUT",79,0)
 ; input: RGX-exception text
"RTN","RGADTUT",80,0)
 D START^RGHLLOG(),EXC^RGHLLOG(224,RGX,RGZDFN),STOP^RGHLLOG(0)
"RTN","RGADTUT",81,0)
 Q
"RTN","RGADTUT",82,0)
TFL ; update the Treating Facility List file on:
"RTN","RGADTUT",83,0)
 ; an exception -or- no subscribers CMOR data missing -or-
"RTN","RGADTUT",84,0)
 ; "MPI" node missing -or- no subscribers & host is the CMOR
"RTN","RGADTUT",85,0)
 ; Note: RGZSF is global in scope
"RTN","RGADTUT",86,0)
 N RGZEVR I RGZEVT="A01" S RGZEVR="A1"
"RTN","RGADTUT",87,0)
 E  S RGZEVR=$S(($D(RGSD101))#2:"A3",1:"A2")
"RTN","RGADTUT",88,0)
 D:RGZSF FILE^VAFCTFU(RGZDFN,RGZSF_"^"_RGZDT_"^"_RGZEVR,1)
"RTN","RGADTUT",89,0)
 ;3rd param=1, do not involve the ADT/HL7 PIVOT (#391.71) file
"RTN","RGADTUT",90,0)
 Q
"RTN","RGRSDYN")
0^2^B5803854
"RTN","RGRSDYN",1,0)
RGRSDYN ;ALB/RJS-BUILD DYNAMIC LINK LIST FOR A PATIENT ;03/21/97
"RTN","RGRSDYN",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4,8,17**;30 Apr 99
"RTN","RGRSDYN",3,0)
EN(CLIENT,CLASS) ;
"RTN","RGRSDYN",4,0)
 ;CLIENT=HL7 CLIENT PROTOCOL AT TARGET SYSTEM
"RTN","RGRSDYN",5,0)
 ;DATA CLASS (Opt.) = Pull from Subs. Registry ONLY
"RTN","RGRSDYN",6,0)
 ;For now, anything else is both DESCRIPTIVE AND CLINICAL
"RTN","RGRSDYN",7,0)
 ; IAs used in this application
"RTN","RGRSDYN",8,0)
 ; #2701-$$GETDFN^MPIF001
"RTN","RGRSDYN",9,0)
 ; #2779-$$SEND2^VAFCUTL1
"RTN","RGRSDYN",10,0)
 S CLASS=$G(CLASS),CLIENT=$G(CLIENT)
"RTN","RGRSDYN",11,0)
 Q:CLIENT=""  ;No receiver
"RTN","RGRSDYN",12,0)
 N PPF,DFN,HERE,ICN,RGRS,PPFIEN
"RTN","RGRSDYN",13,0)
PARS ;Parse local outbound message
"RTN","RGRSDYN",14,0)
 N RGDC
"RTN","RGRSDYN",15,0)
 D INITIZE^RGRSUTIL,EN^RGRSPARS("RGRS")
"RTN","RGRSDYN",16,0)
 ;Get patients owner site
"RTN","RGRSDYN",17,0)
 S PPF=$G(RGRS("SITENUM"))\1 Q:PPF'>0
"RTN","RGRSDYN",18,0)
 S PPFIEN=$$LKUP^XUAF4(PPF)
"RTN","RGRSDYN",19,0)
 ;get ICN
"RTN","RGRSDYN",20,0)
 S ICN=$G(RGRS(991.01)) Q:$G(ICN)']""
"RTN","RGRSDYN",21,0)
 ;Get DFN
"RTN","RGRSDYN",22,0)
 S DFN=$$GETDFN^MPIF001(ICN) Q:$G(DFN)'>0
"RTN","RGRSDYN",23,0)
 Q:+$$SEND2^VAFCUTL1(DFN,"T")  ;quit if test patient
"RTN","RGRSDYN",24,0)
 Q:$$IFLOCAL^MPIF001(DFN)
"RTN","RGRSDYN",25,0)
 ;Where we're at
"RTN","RGRSDYN",26,0)
 S HERE=$P($$SITE^VASITE,"^",3)\1
"RTN","RGRSDYN",27,0)
NOTPPF ; if not ppf send only to ppf
"RTN","RGRSDYN",28,0)
 I PPF'=HERE D  Q
"RTN","RGRSDYN",29,0)
 . N PPFLINK,INDEX
"RTN","RGRSDYN",30,0)
 . D LINK^HLUTIL3(PPFIEN,.PPFLINK)
"RTN","RGRSDYN",31,0)
 . S INDEX=$O(PPFLINK(0))
"RTN","RGRSDYN",32,0)
 . I INDEX]"" S HLL("LINKS",1)=CLIENT_"^"_PPFLINK(INDEX)
"RTN","RGRSDYN",33,0)
ISPPF ;
"RTN","RGRSDYN",34,0)
 I PPF=HERE D  Q
"RTN","RGRSDYN",35,0)
 . N PARENT,INDEX,SUBCONTL,CHILDREN,INDEX1,NODE
"RTN","RGRSDYN",36,0)
 . S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","RGRSDYN",37,0)
 . S SUBCONTL=$P($G(NODE),"^",5)
"RTN","RGRSDYN",38,0)
 . ;Get subscribers, return updated HLL array
"RTN","RGRSDYN",39,0)
 . I SUBCONTL]"" D GET^HLSUB(SUBCONTL,+CLASS,CLIENT,.HLL)
"RTN","RGRSDYN",40,0)
 . ;LAST MINUTE CHANGE MARILYN REQUESTED
"RTN","RGRSDYN",41,0)
 . ;Get MPI link from SITE PARAMETER (when non A01/A03 event, ADT
"RTN","RGRSDYN",42,0)
 . ;message) part of the DG*5.3*261/RG*1.0*4 bundle gjc@2/4/99
"RTN","RGRSDYN",43,0)
 . I '$$ADT0103() D
"RTN","RGRSDYN",44,0)
 . . N MPI S MPI=$$MPILINK^MPIFAPI() D
"RTN","RGRSDYN",45,0)
 . . . I $P($G(MPI),U)'=-1 S HLL("LINKS",9999999999)=CLIENT_"^"_MPI
"RTN","RGRSDYN",46,0)
 . . . I $P($G(MPI),U)=-1 D
"RTN","RGRSDYN",47,0)
 . . . . N RGLOG,RGMTXT
"RTN","RGRSDYN",48,0)
 . . . . D START^RGHLLOG(HLMTIEN,"","")
"RTN","RGRSDYN",49,0)
 . . . . S RGMTXT=""
"RTN","RGRSDYN",50,0)
 . . . . D EXC^RGHLLOG(224,"No MPI link identified in CIRN SITE PARAMETER file (#991.8)"_RGMTXT)
"RTN","RGRSDYN",51,0)
 . . . . D STOP^RGHLLOG(0)
"RTN","RGRSDYN",52,0)
 ;
"RTN","RGRSDYN",53,0)
 ;the following was commented out because we're not updating all sites
"RTN","RGRSDYN",54,0)
 ;in the VISN anymore
"RTN","RGRSDYN",55,0)
 ;
"RTN","RGRSDYN",56,0)
 ;. ;Get owners PARENT
"RTN","RGRSDYN",57,0)
 ;. D PARENT^XUAF4("PARENT",PPF)
"RTN","RGRSDYN",58,0)
 ;. S INDEX=""
"RTN","RGRSDYN",59,0)
 ;. S INDEX=$O(PARENT("P",INDEX))
"RTN","RGRSDYN",60,0)
 ;. Q:INDEX']""
"RTN","RGRSDYN",61,0)
 ;. D LINK^HLUTIL3(INDEX,.CHILDREN)
"RTN","RGRSDYN",62,0)
 ;. S INDEX=$O(HLL("LINKS",9999999999999),-1)
"RTN","RGRSDYN",63,0)
 ;. Q:INDEX']""
"RTN","RGRSDYN",64,0)
 ;. S INDEX1=0
"RTN","RGRSDYN",65,0)
 ;. F  S INDEX1=$O(CHILDREN(INDEX1)) Q:INDEX1'>0  D
"RTN","RGRSDYN",66,0)
 ;. . S INDEX=INDEX+1
"RTN","RGRSDYN",67,0)
 ;. . S HLL("LINKS",INDEX)=CLIENT_"^"_CHILDREN(INDEX1)
"RTN","RGRSDYN",68,0)
 ;
"RTN","RGRSDYN",69,0)
ADT0103() ; check to see if this is an ADT message type with an
"RTN","RGRSDYN",70,0)
 ; event of A01 -or- A03.  If true, do not broadcast the message
"RTN","RGRSDYN",71,0)
 ; to the MPI.  Part of the DG*5.3*261/RG*1.0*4 bundle.  gjc@2/4/99
"RTN","RGRSDYN",72,0)
 S HL("MTN")=$G(HL("MTN")),HL("ETN")=$G(HL("ETN")) ; just in case
"RTN","RGRSDYN",73,0)
 Q $S(HL("MTN")="ADT"&(HL("ETN")="A01"!(HL("ETN")="A03")):1,1:0)
"VER")
8.0^22.0
"^DD",991.8,991.8,14,0)
MPI/PD DATE LAST TREATED^D^^1;4^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",991.8,991.8,14,3)
Enter the evaluated date/time the Date Last Treated process was complete.
"^DD",991.8,991.8,14,21,0)
^.001^3^3^3010418^^
"^DD",991.8,991.8,14,21,1,0)
'MPI/PD DATE LAST TREATED' is used to track the completion date/time
"^DD",991.8,991.8,14,21,2,0)
of the Date Last Treated process. This field is used to ensure that this
"^DD",991.8,991.8,14,21,3,0)
Date Last Treated process is run only once at a facility.
"^DD",991.8,991.8,14,23,0)
^.001^8^8^3010418^^
"^DD",991.8,991.8,14,23,1,0)
'MPI/PD DATE LAST TREATED' is used to track the completion date/time of
"^DD",991.8,991.8,14,23,2,0)
the Date Last Treated process. This field is used to ensure that this Date
"^DD",991.8,991.8,14,23,3,0)
Last Treated process is run only once at a facility.
"^DD",991.8,991.8,14,23,4,0)
 
"^DD",991.8,991.8,14,23,5,0)
The RGRSDYN routine had to be modified to handle routing of VistA HL7
"^DD",991.8,991.8,14,23,6,0)
messages that are detached from the ADT/HL7 PIVOT (#391.71) file.  This
"^DD",991.8,991.8,14,23,7,0)
field was added to the CIRN SITE PARAMETER (#991.8) as a data dictionary
"^DD",991.8,991.8,14,23,8,0)
component of patch RG*1.0*17.
"^DD",991.8,991.8,14,"DT")
3010329
**END**
**END**
