Released XU*8*275 SEQ #285
Extracted from mail message
**KIDS**:XU*8.0*275^

**INSTALL NAME**
XU*8.0*275
"BLD",642,0)
XU*8.0*275^KERNEL^0^3040628^y
"BLD",642,1,0)
^^4^4^3030122^
"BLD",642,1,1,0)
Please refer to the Description in the FORUM Patch Module for details.
"BLD",642,1,2,0)
Patch XU*8*275.
"BLD",642,1,3,0)

"BLD",642,1,4,0)

"BLD",642,4,0)
^9.64PA^9.8^2
"BLD",642,4,9.8,0)
9.8
"BLD",642,4,9.8,2,0)
^9.641^9.8^1
"BLD",642,4,9.8,2,9.8,0)
ROUTINE  (File-top level)
"BLD",642,4,9.8,2,9.8,1,0)
^9.6411^7.3^2
"BLD",642,4,9.8,2,9.8,1,7.3,0)
PATCH LIST AT CHECKSUM TIME
"BLD",642,4,9.8,2,9.8,1,7.4,0)
KIDS INSTALL DATE
"BLD",642,4,9.8,222)
y^y^p^^^^n
"BLD",642,4,14.4,0)
14.4
"BLD",642,4,14.4,2,0)
^9.641^14.4^1
"BLD",642,4,14.4,2,14.4,0)
TASKS  (File-top level)
"BLD",642,4,14.4,2,14.4,1,0)
^9.6411^54^2
"BLD",642,4,14.4,2,14.4,1,33,0)
Hop Count
"BLD",642,4,14.4,2,14.4,1,54,0)
Job
"BLD",642,4,14.4,222)
y^y^p^^^^n
"BLD",642,4,"APDD",9.8,9.8)

"BLD",642,4,"APDD",9.8,9.8,7.3)

"BLD",642,4,"APDD",9.8,9.8,7.4)

"BLD",642,4,"APDD",14.4,14.4)

"BLD",642,4,"APDD",14.4,14.4,33)

"BLD",642,4,"APDD",14.4,14.4,54)

"BLD",642,4,"B",9.8,9.8)

"BLD",642,4,"B",14.4,14.4)

"BLD",642,"INI")
PRE^XUINP275
"BLD",642,"INIT")
POST^XUINP275
"BLD",642,"KRN",0)
^9.67PA^8989.52^19
"BLD",642,"KRN",.4,0)
.4
"BLD",642,"KRN",.401,0)
.401
"BLD",642,"KRN",.402,0)
.402
"BLD",642,"KRN",.403,0)
.403
"BLD",642,"KRN",.5,0)
.5
"BLD",642,"KRN",.84,0)
.84
"BLD",642,"KRN",3.6,0)
3.6
"BLD",642,"KRN",3.8,0)
3.8
"BLD",642,"KRN",9.2,0)
9.2
"BLD",642,"KRN",9.8,0)
9.8
"BLD",642,"KRN",9.8,"NM",0)
^9.68A^66^49
"BLD",642,"KRN",9.8,"NM",1,0)
ZOSFGTM^^0^B21430649
"BLD",642,"KRN",9.8,"NM",2,0)
ZOSFGUX^^0^B22086501
"BLD",642,"KRN",9.8,"NM",3,0)
ZTMGRSET^^0^B48565811
"BLD",642,"KRN",9.8,"NM",5,0)
ZOSV2GTM^^0^B4861009
"BLD",642,"KRN",9.8,"NM",6,0)
ZOSVGTM^^0^B17497229
"BLD",642,"KRN",9.8,"NM",7,0)
ZOSVGUX^^0^B42854824
"BLD",642,"KRN",9.8,"NM",10,0)
XUCIGTM^^0^B3044514
"BLD",642,"KRN",9.8,"NM",11,0)
ZIS4GTM^^0^B17859253
"BLD",642,"KRN",9.8,"NM",13,0)
ZISFGTM^^0^B9168627
"BLD",642,"KRN",9.8,"NM",15,0)
ZISHGTM^^0^B38709489
"BLD",642,"KRN",9.8,"NM",16,0)
ZISHGUX^^0^B38047424
"BLD",642,"KRN",9.8,"NM",17,0)
ZISTCP^^0^B27837637
"BLD",642,"KRN",9.8,"NM",18,0)
ZISTCPS^^0^B11979690
"BLD",642,"KRN",9.8,"NM",20,0)
ZUSET^^0^B1836388
"BLD",642,"KRN",9.8,"NM",24,0)
ZUGTM^^0^B10091845
"BLD",642,"KRN",9.8,"NM",28,0)
ZFOO^^0^B288700
"BLD",642,"KRN",9.8,"NM",29,0)
ZJFOO^^0^B289360
"BLD",642,"KRN",9.8,"NM",30,0)
ZIS^^0^B16647233
"BLD",642,"KRN",9.8,"NM",32,0)
ZTER^^0^B40614789
"BLD",642,"KRN",9.8,"NM",33,0)
ZTER1^^0^B6756504
"BLD",642,"KRN",9.8,"NM",34,0)
ZTLOAD1^^0^B22232897
"BLD",642,"KRN",9.8,"NM",35,0)
ZTLOAD2^^0^B9040975
"BLD",642,"KRN",9.8,"NM",36,0)
ZTMB^^0^B18416099
"BLD",642,"KRN",9.8,"NM",38,0)
ZTMON1^^0^B20323739
"BLD",642,"KRN",9.8,"NM",39,0)
ZISC^^0^B22304846
"BLD",642,"KRN",9.8,"NM",40,0)
ZTMS^^0^B15851747
"BLD",642,"KRN",9.8,"NM",41,0)
ZTM0^^0^B15924444
"BLD",642,"KRN",9.8,"NM",43,0)
ZISUTL^^0^B10918305
"BLD",642,"KRN",9.8,"NM",44,0)
ZTM^^0^B34894883
"BLD",642,"KRN",9.8,"NM",45,0)
ZTM1^^0^B20977172
"BLD",642,"KRN",9.8,"NM",46,0)
ZTM2^^0^B12942741
"BLD",642,"KRN",9.8,"NM",47,0)
ZTM3^^0^B8882007
"BLD",642,"KRN",9.8,"NM",49,0)
ZTM5^^0^B14928719
"BLD",642,"KRN",9.8,"NM",50,0)
ZTMS1^^0^B26930044
"BLD",642,"KRN",9.8,"NM",51,0)
ZTMS2^^0^B23098676
"BLD",642,"KRN",9.8,"NM",52,0)
ZTMS3^^0^B23747001
"BLD",642,"KRN",9.8,"NM",53,0)
ZTMS4^^0^B5923868
"BLD",642,"KRN",9.8,"NM",54,0)
ZTMS7^^0^B3559512
"BLD",642,"KRN",9.8,"NM",55,0)
XUSCNT^^0^B10246308
"BLD",642,"KRN",9.8,"NM",56,0)
XPDIJ^^0^B20798007
"BLD",642,"KRN",9.8,"NM",57,0)
XPDUTL^^0^B19386445
"BLD",642,"KRN",9.8,"NM",58,0)
XTER^^0^B29070818
"BLD",642,"KRN",9.8,"NM",59,0)
XUTMDEVQ^^0^B13760584
"BLD",642,"KRN",9.8,"NM",60,0)
XUSRB1^^0^B20693023
"BLD",642,"KRN",9.8,"NM",61,0)
ZTMKU^^0^B19402170
"BLD",642,"KRN",9.8,"NM",62,0)
ZTMS0^^0^B6894133
"BLD",642,"KRN",9.8,"NM",63,0)
ZTMS5^^0^B927042
"BLD",642,"KRN",9.8,"NM",64,0)
XUTMK^^0^B30883527
"BLD",642,"KRN",9.8,"NM",66,0)
XPDI1^^0^B17756592
"BLD",642,"KRN",9.8,"NM","B","XPDI1",66)

"BLD",642,"KRN",9.8,"NM","B","XPDIJ",56)

"BLD",642,"KRN",9.8,"NM","B","XPDUTL",57)

"BLD",642,"KRN",9.8,"NM","B","XTER",58)

"BLD",642,"KRN",9.8,"NM","B","XUCIGTM",10)

"BLD",642,"KRN",9.8,"NM","B","XUSCNT",55)

"BLD",642,"KRN",9.8,"NM","B","XUSRB1",60)

"BLD",642,"KRN",9.8,"NM","B","XUTMDEVQ",59)

"BLD",642,"KRN",9.8,"NM","B","XUTMK",64)

"BLD",642,"KRN",9.8,"NM","B","ZFOO",28)

"BLD",642,"KRN",9.8,"NM","B","ZIS",30)

"BLD",642,"KRN",9.8,"NM","B","ZIS4GTM",11)

"BLD",642,"KRN",9.8,"NM","B","ZISC",39)

"BLD",642,"KRN",9.8,"NM","B","ZISFGTM",13)

"BLD",642,"KRN",9.8,"NM","B","ZISHGTM",15)

"BLD",642,"KRN",9.8,"NM","B","ZISHGUX",16)

"BLD",642,"KRN",9.8,"NM","B","ZISTCP",17)

"BLD",642,"KRN",9.8,"NM","B","ZISTCPS",18)

"BLD",642,"KRN",9.8,"NM","B","ZISUTL",43)

"BLD",642,"KRN",9.8,"NM","B","ZJFOO",29)

"BLD",642,"KRN",9.8,"NM","B","ZOSFGTM",1)

"BLD",642,"KRN",9.8,"NM","B","ZOSFGUX",2)

"BLD",642,"KRN",9.8,"NM","B","ZOSV2GTM",5)

"BLD",642,"KRN",9.8,"NM","B","ZOSVGTM",6)

"BLD",642,"KRN",9.8,"NM","B","ZOSVGUX",7)

"BLD",642,"KRN",9.8,"NM","B","ZTER",32)

"BLD",642,"KRN",9.8,"NM","B","ZTER1",33)

"BLD",642,"KRN",9.8,"NM","B","ZTLOAD1",34)

"BLD",642,"KRN",9.8,"NM","B","ZTLOAD2",35)

"BLD",642,"KRN",9.8,"NM","B","ZTM",44)

"BLD",642,"KRN",9.8,"NM","B","ZTM0",41)

"BLD",642,"KRN",9.8,"NM","B","ZTM1",45)

"BLD",642,"KRN",9.8,"NM","B","ZTM2",46)

"BLD",642,"KRN",9.8,"NM","B","ZTM3",47)

"BLD",642,"KRN",9.8,"NM","B","ZTM5",49)

"BLD",642,"KRN",9.8,"NM","B","ZTMB",36)

"BLD",642,"KRN",9.8,"NM","B","ZTMGRSET",3)

"BLD",642,"KRN",9.8,"NM","B","ZTMKU",61)

"BLD",642,"KRN",9.8,"NM","B","ZTMON1",38)

"BLD",642,"KRN",9.8,"NM","B","ZTMS",40)

"BLD",642,"KRN",9.8,"NM","B","ZTMS0",62)

"BLD",642,"KRN",9.8,"NM","B","ZTMS1",50)

"BLD",642,"KRN",9.8,"NM","B","ZTMS2",51)

"BLD",642,"KRN",9.8,"NM","B","ZTMS3",52)

"BLD",642,"KRN",9.8,"NM","B","ZTMS4",53)

"BLD",642,"KRN",9.8,"NM","B","ZTMS5",63)

"BLD",642,"KRN",9.8,"NM","B","ZTMS7",54)

"BLD",642,"KRN",9.8,"NM","B","ZUGTM",24)

"BLD",642,"KRN",9.8,"NM","B","ZUSET",20)

"BLD",642,"KRN",19,0)
19
"BLD",642,"KRN",19,"NM",0)
^9.68A^6^6
"BLD",642,"KRN",19,"NM",1,0)
XUROUTINE IN^^0
"BLD",642,"KRN",19,"NM",2,0)
XUROUTINE OUT^^0
"BLD",642,"KRN",19,"NM",3,0)
XUPR RTN EDIT^^0
"BLD",642,"KRN",19,"NM",4,0)
XUPRGL^^0
"BLD",642,"KRN",19,"NM",5,0)
XU PROC CNT CLUP^^0
"BLD",642,"KRN",19,"NM",6,0)
XUINDEX^^0
"BLD",642,"KRN",19,"NM","B","XU PROC CNT CLUP",5)

"BLD",642,"KRN",19,"NM","B","XUINDEX",6)

"BLD",642,"KRN",19,"NM","B","XUPR RTN EDIT",3)

"BLD",642,"KRN",19,"NM","B","XUPRGL",4)

"BLD",642,"KRN",19,"NM","B","XUROUTINE IN",1)

"BLD",642,"KRN",19,"NM","B","XUROUTINE OUT",2)

"BLD",642,"KRN",19.1,0)
19.1
"BLD",642,"KRN",101,0)
101
"BLD",642,"KRN",409.61,0)
409.61
"BLD",642,"KRN",771,0)
771
"BLD",642,"KRN",870,0)
870
"BLD",642,"KRN",8989.51,0)
8989.51
"BLD",642,"KRN",8989.52,0)
8989.52
"BLD",642,"KRN",8994,0)
8994
"BLD",642,"KRN","B",.4,.4)

"BLD",642,"KRN","B",.401,.401)

"BLD",642,"KRN","B",.402,.402)

"BLD",642,"KRN","B",.403,.403)

"BLD",642,"KRN","B",.5,.5)

"BLD",642,"KRN","B",.84,.84)

"BLD",642,"KRN","B",3.6,3.6)

"BLD",642,"KRN","B",3.8,3.8)

"BLD",642,"KRN","B",9.2,9.2)

"BLD",642,"KRN","B",9.8,9.8)

"BLD",642,"KRN","B",19,19)

"BLD",642,"KRN","B",19.1,19.1)

"BLD",642,"KRN","B",101,101)

"BLD",642,"KRN","B",409.61,409.61)

"BLD",642,"KRN","B",771,771)

"BLD",642,"KRN","B",870,870)

"BLD",642,"KRN","B",8989.51,8989.51)

"BLD",642,"KRN","B",8989.52,8989.52)

"BLD",642,"KRN","B",8994,8994)

"BLD",642,"QUES",0)
^9.62^^
"BLD",642,"REQB",0)
^9.611^8^8
"BLD",642,"REQB",1,0)
XU*8.0*120^2
"BLD",642,"REQB",2,0)
XU*8.0*135^2
"BLD",642,"REQB",3,0)
XU*8.0*175^2
"BLD",642,"REQB",4,0)
XU*8.0*181^2
"BLD",642,"REQB",5,0)
XU*8.0*191^2
"BLD",642,"REQB",6,0)
XU*8.0*216^2
"BLD",642,"REQB",7,0)
XU*8.0*225^2
"BLD",642,"REQB",8,0)
XU*8.0*229^2
"BLD",642,"REQB","B","XU*8.0*120",1)

"BLD",642,"REQB","B","XU*8.0*135",2)

"BLD",642,"REQB","B","XU*8.0*175",3)

"BLD",642,"REQB","B","XU*8.0*181",4)

"BLD",642,"REQB","B","XU*8.0*191",5)

"BLD",642,"REQB","B","XU*8.0*216",6)

"BLD",642,"REQB","B","XU*8.0*225",7)

"BLD",642,"REQB","B","XU*8.0*229",8)

"FIA",9.8)
ROUTINE
"FIA",9.8,0)
^DIC(9.8,
"FIA",9.8,0,0)
9.8
"FIA",9.8,0,1)
y^y^p^^^^n
"FIA",9.8,0,10)

"FIA",9.8,0,11)

"FIA",9.8,0,"RLRO")

"FIA",9.8,0,"VR")
8.0^XU
"FIA",9.8,9.8)
1
"FIA",9.8,9.8,7.3)

"FIA",9.8,9.8,7.4)

"FIA",14.4)
TASKS
"FIA",14.4,0)
^%ZTSK(
"FIA",14.4,0,0)
14.4
"FIA",14.4,0,1)
y^y^p^^^^n
"FIA",14.4,0,10)

"FIA",14.4,0,11)

"FIA",14.4,0,"RLRO")

"FIA",14.4,0,"VR")
8.0^XU
"FIA",14.4,14.4)
1
"FIA",14.4,14.4,33)

"FIA",14.4,14.4,54)

"INI")
PRE^XUINP275
"INIT")
POST^XUINP275
"KRN",19,273,-1)
0^6
"KRN",19,273,0)
XUINDEX^%Index of Routines^^R^^^^5^^^^^^
"KRN",19,273,1,0)
^^1^1^2880401^^
"KRN",19,273,1,1,0)
This option runs the %INDEX routine.
"KRN",19,273,25)
XINDEX
"KRN",19,273,99.1)
56665,39870
"KRN",19,273,"U")
%INDEX OF ROUTINES
"KRN",19,490,-1)
0^4
"KRN",19,490,0)
XUPRGL^List Global^^A^^XUPROGMODE^^^^^^^^1
"KRN",19,490,1,0)
^^2^2^2920710^^
"KRN",19,490,1,1,0)
This option runs the operating system routine to list specified globals.
"KRN",19,490,1,2,0)
For MSM this is %GL for other systems it is %G.
"KRN",19,490,20)
D @($S(^%ZOSF("OS")["MSM":"^%GL",^%ZOSF("OS")["DTM":"^%g",1:"^%G"))
"KRN",19,490,99.1)
54829,39174
"KRN",19,490,"U")
LIST GLOBAL
"KRN",19,491,-1)
0^2
"KRN",19,491,0)
XUROUTINE OUT^Output routines^^A^^^^^^^^^n^1^^
"KRN",19,491,1,0)
^^3^3^3020808^^^^
"KRN",19,491,1,1,0)
This routine will output routines to an external device such as a host file.
"KRN",19,491,1,2,0)

"KRN",19,491,1,3,0)

"KRN",19,491,20)
N % S %=$G(^%ZOSF("OS")) D @$S(%["GT.M":"^ZRO",%["OpenM":"^%RO",%["DTM":"^%rsave",1:"^%RS")
"KRN",19,491,"U")
OUTPUT ROUTINES
"KRN",19,492,-1)
0^1
"KRN",19,492,0)
XUROUTINE IN^Input routines^^A^^XUPROG^^^^^^^n^1^^
"KRN",19,492,1,0)
^^3^3^3020808^^^^
"KRN",19,492,1,1,0)
Loads routines from an external device, like a host file.
"KRN",19,492,1,2,0)
**DO NOT USE THIS OPTION IF YOU AREN'T SURE HOW TO RUN IT!!**
"KRN",19,492,1,3,0)

"KRN",19,492,20)
N % S %=$G(^%ZOSF("OS")) D @$S(%["OpenM":"^%RI",%["DTM":"^%rload",%["GT.M":"^%RI",1:"^%RR")
"KRN",19,492,"U")
INPUT ROUTINES
"KRN",19,498,-1)
0^3
"KRN",19,498,0)
XUPR RTN EDIT^Routine Edit^^A^^XUPROGMODE^^^^^^^n^1^^
"KRN",19,498,1,0)
^^2^2^2880401^^
"KRN",19,498,1,1,0)
This allows programmers on the site manager's staff to edit MUMPS
"KRN",19,498,1,2,0)
routines.  ONLY FOR PROGRAMMERS
"KRN",19,498,20)
R !,"ROUTINE: ",X:DTIME I X?1A1.7AN X ^%ZOSF("TEST") I  X "ZL @X X ^%Z"
"KRN",19,498,"U")
ROUTINE EDIT
"KRN",19,909,-1)
0^5
"KRN",19,909,0)
XU PROC CNT CLUP^XUS Process count cleanup^^R^^^^^^^^KERNEL^n
"KRN",19,909,1,0)
^^5^5^3040218^
"KRN",19,909,1,1,0)
This Option is only needed for GT.M sites.
"KRN",19,909,1,2,0)
For a GT.M site it should be scheduled to run between every 1 to 8 hours.
"KRN",19,909,1,3,0)
This is the Kernel process count cleanup routine.
"KRN",19,909,1,4,0)
It checks the entries in XUTL("XUSYS",$J) to see if they are still active
"KRN",19,909,1,5,0)
and if not remove the entry.
"KRN",19,909,25)
CLEAR^XUSCNT(0)
"KRN",19,909,200.9)
y
"KRN",19,909,"U")
XUS PROCESS COUNT CLEANUP
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
275^3040628^2
"PKG",3,22,1,"PAH",1,1,0)
^^4^4^3040628
"PKG",3,22,1,"PAH",1,1,1,0)
Please refer to the Description in the FORUM Patch Module for details.
"PKG",3,22,1,"PAH",1,1,2,0)
Patch XU*8*275.
"PKG",3,22,1,"PAH",1,1,3,0)

"PKG",3,22,1,"PAH",1,1,4,0)

"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
50
"RTN","XPDI1")
0^66^B17756592
"RTN","XPDI1",1,0)
XPDI1 ;SFISC/RSD - Cont of Install Process ;10/28/2002  17:14
"RTN","XPDI1",2,0)
 ;;8.0;KERNEL;**58,61,95,108,229,275**;Jul 10, 1995
"RTN","XPDI1",3,0)
 ;lookup into file 9.7, XPDS=DIC("S") for lookup
"RTN","XPDI1",4,0)
 ;return 0-fail or ien, XPDT=array of linked builds
"RTN","XPDI1",5,0)
LOOK(XPDS,XPDL) ;lookup Install
"RTN","XPDI1",6,0)
 N DIC,Y,XPD,XPDIT,%
"RTN","XPDI1",7,0)
 S DIC(0)="QEAMZ",DIC="^XPD(9.7,"
"RTN","XPDI1",8,0)
 S:$L($G(XPDS)) DIC("S")=XPDS
"RTN","XPDI1",9,0)
 D ^DIC Q:Y<0 0
"RTN","XPDI1",10,0)
 I '$G(XPDL) L +^XPD(9.7,+Y,0):0 E  W !,"Being accessed by another user" Q 0
"RTN","XPDI1",11,0)
 S XPD=+Y,XPDIT=0
"RTN","XPDI1",12,0)
 W !!,"This Distribution was loaded on ",$$FMTE^XLFDT($P(Y(0),U,3))," with header of ",!?3,$G(^XPD(9.7,XPD,2)),!?3,"It consisted of the following Install(s):",!
"RTN","XPDI1",13,0)
 ;build XPDT array
"RTN","XPDI1",14,0)
 I '$D(^XPD(9.7,"ASP",XPD)) D XPDT(1,XPD) Q XPD
"RTN","XPDI1",15,0)
 F  S XPDIT=$O(^XPD(9.7,"ASP",XPD,XPDIT)) Q:'XPDIT  S Y=+$O(^(XPDIT,0)) D XPDT(XPDIT,Y)
"RTN","XPDI1",16,0)
 I '$O(XPDT(0)) S XPDQUIT=1 D QUIT(XPD)
"RTN","XPDI1",17,0)
 Q XPD
"RTN","XPDI1",18,0)
 ;
"RTN","XPDI1",19,0)
QUIT(Y) ;unlock ien Y
"RTN","XPDI1",20,0)
 L -^XPD(9.7,+Y) Q
"RTN","XPDI1",21,0)
 ;
"RTN","XPDI1",22,0)
XPDT(P1,P2) ;Build XPDT array
"RTN","XPDI1",23,0)
 N % S %=$P($G(^XPD(9.7,P2,0)),U)
"RTN","XPDI1",24,0)
 I %="" W:$X ! W "**ERROR in Install, You need to remove the Distribution and reload it**",!  S XPDQUIT=1 Q
"RTN","XPDI1",25,0)
 S XPDT(P1)=P2_U_%,(XPDT("DA",P2),XPDT("NM",%))=P1 W:$X>64 ! W $J(%,15)
"RTN","XPDI1",26,0)
 Q
"RTN","XPDI1",27,0)
 ;
"RTN","XPDI1",28,0)
QUES(XPDA) ;install questions; XPDA=ien in file 9.7
"RTN","XPDI1",29,0)
 N XPDANS,XPDFIL,XPDFILN,XPDFILO,XPDFLG,XPDNM,XPDQUES,X,Y
"RTN","XPDI1",30,0)
 S XPDNM=$P(^XPD(9.7,XPDA,0),U) W !!,"Install Questions for ",XPDNM,!
"RTN","XPDI1",31,0)
 ;pre-init questions
"RTN","XPDI1",32,0)
 D DIR^XPDIQ("PRE") I $D(XPDQUIT) D ASKABRT^XPDI Q
"RTN","XPDI1",33,0)
 ;file install questions
"RTN","XPDI1",34,0)
 S (XPDFIL,XPDFLG)=0
"RTN","XPDI1",35,0)
 F  S XPDFIL=$O(^XTMP("XPDI",XPDA,"FIA",XPDFIL)) Q:'XPDFIL  S X=^(XPDFIL),X(0)=^(XPDFIL,0),X(1)=^(XPDFIL),XPDFILO=^(0,1) D  Q:$D(XPDQUIT)
"RTN","XPDI1",36,0)
 .;check for DD screening logic
"RTN","XPDI1",37,0)
 .I $G(^(10))]"" N XPDSCR S XPDSCR=^(10) ;^(10) is ref to ^XTMP("XPDI",XPDA,"FIA",XPDFIL,0,10) from prev line
"RTN","XPDI1",38,0)
 .;XPDFILN=file name^global ref^partial DD
"RTN","XPDI1",39,0)
 .;XPDANS=new file^DD screen failed^Data exists^update file name^user
"RTN","XPDI1",40,0)
 .;doesn't want to update data  1=yes,0=no
"RTN","XPDI1",41,0)
 .S XPDFILN=X_X(0)_U_X(1),XPDANS='($D(^DIC(XPDFIL,0))#2)_"^^"_''$O(@(X(0)_"0)"))
"RTN","XPDI1",42,0)
 .I 'XPDFLG W !,"Incoming Files:" S XPDFLG=1
"RTN","XPDI1",43,0)
 .W ! D DIR^XPDIQ("XPF",XPDFIL_"#") Q:$D(XPDQUIT)
"RTN","XPDI1",44,0)
 .S:$G(XPDQUES("XPF"_XPDFIL_"#2"))=0 $P(XPDANS,U,5)=1
"RTN","XPDI1",45,0)
 .S ^XTMP("XPDI",XPDA,"FIA",XPDFIL,0,2)=XPDANS
"RTN","XPDI1",46,0)
 .;kill the answers so we can re-ask for next file
"RTN","XPDI1",47,0)
 .F I=1:1:2 K XPDQUES("XPF"_XPDFIL_"#"_I)
"RTN","XPDI1",48,0)
 ;XPDQUIT is by file questions in previous do loop, set in XPDIQ
"RTN","XPDI1",49,0)
 I $D(XPDQUIT) D ASKABRT^XPDI Q
"RTN","XPDI1",50,0)
 ;ask for coordinators to incoming mail groups
"RTN","XPDI1",51,0)
 S (XPDFIL,XPDFLG)=0
"RTN","XPDI1",52,0)
 F  S XPDFIL=$O(^XTMP("XPDI",XPDA,"KRN",3.8,XPDFIL)) Q:'XPDFIL  S X=^(XPDFIL,0),Y=$G(^(-1)) D  Q:$D(XPDQUIT)
"RTN","XPDI1",53,0)
 .;XPDANS=Mail Group name
"RTN","XPDI1",54,0)
 .Q:$P(Y,U)=1  ;Don't ask if deleting
"RTN","XPDI1",55,0)
 .S XPDANS=$P(X,U)
"RTN","XPDI1",56,0)
 .I 'XPDFLG W !!,"Incoming Mail Groups:" S XPDFLG=1
"RTN","XPDI1",57,0)
 .W ! D DIR^XPDIQ("XPM",XPDFIL_"#") Q:$D(XPDQUIT)
"RTN","XPDI1",58,0)
 .;kill the answers so we can re-ask for next MG
"RTN","XPDI1",59,0)
 .K XPDQUES("XPM"_XPDFIL_"#1")
"RTN","XPDI1",60,0)
 .Q
"RTN","XPDI1",61,0)
 I $D(XPDQUIT) D ASKABRT^XPDI Q
"RTN","XPDI1",62,0)
 ;ask to rebuild menus if Option is added
"RTN","XPDI1",63,0)
 S (XPDFIL,XPDFLG)=0
"RTN","XPDI1",64,0)
 S XPDFIL=$O(^XTMP("XPDI",XPDA,"KRN",19,XPDFIL))  D:XPDFIL
"RTN","XPDI1",65,0)
 .S X=^XTMP("XPDI",XPDA,"KRN",19,XPDFIL,0)
"RTN","XPDI1",66,0)
 .;XPDANS=Menu Rebuild Answer
"RTN","XPDI1",67,0)
 .S XPDANS=$P(X,U)
"RTN","XPDI1",68,0)
 .W ! D DIR^XPDIQ("XPO") Q:$D(XPDQUIT)
"RTN","XPDI1",69,0)
 I $D(XPDQUIT) D ASKABRT^XPDI Q
"RTN","XPDI1",70,0)
 ;post-init questions
"RTN","XPDI1",71,0)
 W ! D DIR^XPDIQ("POS") I $D(DIRUT)!$D(XPDQUIT) D ASKABRT^XPDI Q
"RTN","XPDI1",72,0)
 Q
"RTN","XPDI1",73,0)
 ;
"RTN","XPDI1",74,0)
XQSET(XPDA) ;get options & protocols to disable
"RTN","XPDI1",75,0)
 ;put in ^TMP($J,"XQOO",starting build name)
"RTN","XPDI1",76,0)
 N A,I,X,Y
"RTN","XPDI1",77,0)
 S I=0 F  S I=$O(^XTMP("XPDI",XPDA,"KRN",19,I)) Q:'I  S X=^(I,0),A=^(-1) D
"RTN","XPDI1",78,0)
 .S Y=$O(^DIC(19,"B",$P(X,U),0))
"RTN","XPDI1",79,0)
 .;check that option exist and 0=send,1=delete,3=merge or 5=disable
"RTN","XPDI1",80,0)
 .I Y,$D(^DIC(19,Y,0)),$S('A:1,1:A#2) S ^TMP($J,"XQOO",XPDSET,19,Y)=$P(^(0),U,1,2)
"RTN","XPDI1",81,0)
 S I=0 F  S I=$O(^XTMP("XPDI",XPDA,"KRN",101,I)) Q:'I  S X=^(I,0),A=^(-1) D
"RTN","XPDI1",82,0)
 .S Y=$O(^ORD(101,"B",$P(X,U),0))
"RTN","XPDI1",83,0)
 .I Y,$D(^ORD(101,Y,0)),$S(A=3:1,A=5:1,1:'A) S ^TMP($J,"XQOO",XPDSET,101,Y)=$P(^(0),U,1,2)
"RTN","XPDI1",84,0)
 Q
"RTN","XPDI1",85,0)
 ;XPDIJ need to install XPDIJ now & set routine flag to skip
"RTN","XPDI1",86,0)
XPDIJ N DIE,XPDA,XCM,XCN,XCS,X
"RTN","XPDI1",87,0)
 S XPDA=XPDIJ,DIE="^XTMP(""XPDI"",XPDIJ,""RTN"",""XPDIJ"",",XCN=0,X="XPDIJ"
"RTN","XPDI1",88,0)
 X ^%ZOSF("SAVE") D RTNLOG^XPDUTL("XPDIJ") ;Save and update ROUTINE file
"RTN","XPDI1",89,0)
 S XCN=$$RTNUP^XPDUTL("XPDIJ",2)
"RTN","XPDI1",90,0)
 Q
"RTN","XPDIJ")
0^56^B20798007
"RTN","XPDIJ",1,0)
XPDIJ ;SFISC/RSD - Install Job ;06/01/2004  15:10
"RTN","XPDIJ",2,0)
 ;;8.0;KERNEL;**2,21,28,41,44,68,81,95,108,124,229,275**;Jul 10, 1995
"RTN","XPDIJ",3,0)
EN ;install all packages
"RTN","XPDIJ",4,0)
 ;XPDA=ien of first package
"RTN","XPDIJ",5,0)
 ;this is needed to restore XPDIJ1
"RTN","XPDIJ",6,0)
 D LNRF("XPDUTL") ;p275 SAVE calls RTNLOG^XPDUTL
"RTN","XPDIJ",7,0)
 D LNRF("XPDIJ1") ;See that XPDIJ1 is loaded befor it is called
"RTN","XPDIJ",8,0)
 N IEN,XPDI,XPD0,XPDSET,XPDABORT,XPDMENU,XPDQUIT,XPDVOL,X,Y,ZTRTN,ZTDTH,ZTIO,ZTDESC,ZTSK
"RTN","XPDIJ",9,0)
 M X=DUZ N DUZ M DUZ=X S DUZ(0)="@" ;See that install has full FM priv.
"RTN","XPDIJ",10,0)
 I $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^XPDIJ"
"RTN","XPDIJ",11,0)
 E  S X="ERR^XPDIJ",@^%ZOSF("TRAP")
"RTN","XPDIJ",12,0)
 Q:'$D(^XPD(9.7,+$G(XPDA),0))  S XPD0=^(0)
"RTN","XPDIJ",13,0)
 D INIT^XPDID
"RTN","XPDIJ",14,0)
 ;See if need to Inhibit Logons
"RTN","XPDIJ",15,0)
 I $$ANSWER^XPDIQ("XPI1") D INHIBIT^XPDIJ1("Y")
"RTN","XPDIJ",16,0)
 ;disable options & protocols for setname, XPDSET=1/0^setname^out of order msg.
"RTN","XPDIJ",17,0)
 S Y=$P(XPD0,U,8),XPDSET=+Y_U_$E(Y,2,99)_U_$S($L(Y):$P($G(^XTMP("XQOO",$E(Y,2,99),0)),U),1:"")
"RTN","XPDIJ",18,0)
 ;hang the number of seconds given in 0;10
"RTN","XPDIJ",19,0)
 I XPDSET D OFF^XQOO1($P(XPDSET,U,2)) I $P(XPD0,U,10) H ($P(XPD0,U,10)*60)
"RTN","XPDIJ",20,0)
 S Y=0
"RTN","XPDIJ",21,0)
 ;XPDABORT can be set in pre or post install to abort install
"RTN","XPDIJ",22,0)
 F  S Y=$O(^XPD(9.7,"ASP",XPDA,Y)) Q:'Y  S %=$O(^(Y,0)) D:%  Q:$D(XPDABORT)
"RTN","XPDIJ",23,0)
 .N XPD,XPDA,XPDNM,XPDV,XPDV0,XPDVOL,XPDX,XPDY,Y
"RTN","XPDIJ",24,0)
 .;Now do the Install
"RTN","XPDIJ",25,0)
 .S XPDA=%,XPDNM=$P($G(^XPD(9.7,XPDA,0)),U) D IN^XPDIJ1 Q:$D(XPDABORT)
"RTN","XPDIJ",26,0)
 ;
"RTN","XPDIJ",27,0)
 ;Now do Master Build Post INIT.
"RTN","XPDIJ",28,0)
 I '$D(XPDABORT),$D(XPDT("MASTER")) D
"RTN","XPDIJ",29,0)
 .S XPDBLD=$O(^XTMP("XPDI",XPDA,"BLD",0))
"RTN","XPDIJ",30,0)
 .D POST^XPDIJ1
"RTN","XPDIJ",31,0)
 ;ZTREQ tells taskman to delete task
"RTN","XPDIJ",32,0)
 I $G(ZTSK) S ZTREQ="@" D
"RTN","XPDIJ",33,0)
 .;remove task # from Install File
"RTN","XPDIJ",34,0)
 .N XPD S XPD(9.7,XPDA_",",5)="@"
"RTN","XPDIJ",35,0)
 .D FILE^DIE("","XPD")
"RTN","XPDIJ",36,0)
 ;quit if install was aborted
"RTN","XPDIJ",37,0)
 I $D(XPDABORT) D EXIT^XPDID("Install Aborted!!"),^%ZISC Q
"RTN","XPDIJ",38,0)
 ;put option back in order
"RTN","XPDIJ",39,0)
 I $P(XPDSET,U,2)]"" D ON^XQOO1($P(XPDSET,U,2)) K ^XTMP("XQOO",$P(XPDSET,U,2))
"RTN","XPDIJ",40,0)
 ;check if menu rebuild is wanted (only if option has been added)
"RTN","XPDIJ",41,0)
 I $$ANSWER^XPDIQ("XPO1") D
"RTN","XPDIJ",42,0)
 .D BMES^XPDUTL(" Call MENU rebuild"),KIDS^XQ81
"RTN","XPDIJ",43,0)
 .;check if need to queue menu rebuild on other CPUs
"RTN","XPDIJ",44,0)
 .D:$O(^XPD(9.7,XPDA,"VOL",0))
"RTN","XPDIJ",45,0)
 ..N XPDU,XPDY,XPDV,XPDV0,ZTUCI,ZTCPU
"RTN","XPDIJ",46,0)
 ..X ^%ZOSF("UCI") S XPDU=$P(Y,","),XPDY=$P(Y,",",2),XPDV=0
"RTN","XPDIJ",47,0)
 ..;loop thru VOLUMES SET and don't do current volume set
"RTN","XPDIJ",48,0)
 ..F  S XPDV=$O(^XPD(9.7,XPDA,"VOL",XPDV)) Q:'XPDV  S XPDV0=$P(^(XPDV,0),U) D:XPDV0'=XPDY
"RTN","XPDIJ",49,0)
 ...S ZTUCI=XPDU,ZTDTH=$H,ZTIO="",ZTDESC="Install Menu Rebuild",ZTCPU=XPDV0,ZTRTN="KIDS^XQ81" D ^%ZTLOAD
"RTN","XPDIJ",50,0)
 ;
"RTN","XPDIJ",51,0)
 ;See if need to reset inhibit logons
"RTN","XPDIJ",52,0)
 I $$ANSWER^XPDIQ("XPI1") D INHIBIT^XPDIJ1("N")
"RTN","XPDIJ",53,0)
 ;
"RTN","XPDIJ",54,0)
 ;clean up globals
"RTN","XPDIJ",55,0)
 S Y=0
"RTN","XPDIJ",56,0)
 F  S Y=$O(^XPD(9.7,"ASP",XPDA,Y)) Q:'Y  S XPDI=$O(^(Y,0)) D:XPDI
"RTN","XPDIJ",57,0)
 . N %,Y,XPD,X
"RTN","XPDIJ",58,0)
 . ;See if need to delete Env,Pre,Post routines.
"RTN","XPDIJ",59,0)
 . S %=$O(^XTMP("XPDI",XPDI,"BLD",0)),XPD=$G(^XTMP("XPDI",XPDI,"BLD",%,"INID"))
"RTN","XPDIJ",60,0)
 . I '$$GET^XUPARAM("XPD NO_EPP_DELETE") F %=1:1:3 I $P(XPD,U,%)="y" D
"RTN","XPDIJ",61,0)
 . . S X=^XTMP("XPDI",XPDI,$P("PRE^INIT^INI",U,%)) S:X[U X=$P(X,U,2) X:X]"" ^%ZOSF("DEL")
"RTN","XPDIJ",62,0)
 . ;kill transport global
"RTN","XPDIJ",63,0)
 . K ^XTMP("XPDI",XPDI)
"RTN","XPDIJ",64,0)
 . ;update the status field
"RTN","XPDIJ",65,0)
 . S XPD(9.7,XPDI_",",.02)=3
"RTN","XPDIJ",66,0)
 . D FILE^DIE("","XPD")
"RTN","XPDIJ",67,0)
 D EXIT^XPDID("Install Completed"),^%ZISC
"RTN","XPDIJ",68,0)
 Q
"RTN","XPDIJ",69,0)
 ;
"RTN","XPDIJ",70,0)
SAVE(X) ;restore routine X
"RTN","XPDIJ",71,0)
 N %,DIE,XCM,XCN,XCS
"RTN","XPDIJ",72,0)
 S DIE="^XTMP(""XPDI"",XPDA,""RTN"",X,",XCN=0
"RTN","XPDIJ",73,0)
 X ^%ZOSF("SAVE") D RTNLOG^XPDUTL(X)
"RTN","XPDIJ",74,0)
 Q
"RTN","XPDIJ",75,0)
RTN(XPDA) ;restore all routines for package XPDA
"RTN","XPDIJ",76,0)
 ;^XPD("XPDI",XPDA,"RTN",routine name)=0-install, 1-delete, 2-skip^checksum
"RTN","XPDIJ",77,0)
 Q:$G(XPDA)=""
"RTN","XPDIJ",78,0)
 N X,XPDI,XPDJ S XPDI=""
"RTN","XPDIJ",79,0)
 F  S XPDI=$O(^XTMP("XPDI",XPDA,"RTN",XPDI)) Q:XPDI=""  S XPDJ=^(XPDI) D
"RTN","XPDIJ",80,0)
 .;if we are doing VT graphic display, set counter
"RTN","XPDIJ",81,0)
 .I $D(XPDIDVT) S XPDIDCNT=XPDIDCNT+1 D:'(XPDIDCNT#XPDIDMOD) UPDATE^XPDID(XPDIDCNT)
"RTN","XPDIJ",82,0)
 .I 'XPDJ D SAVE(XPDI) Q
"RTN","XPDIJ",83,0)
 .;set checksum to null, since routine wasn't loaded
"RTN","XPDIJ",84,0)
 .I $P(XPDJ,U,2) S $P(^XTMP("XPDI",XPDA,"BLD",XPDBLD,"KRN",9.8,"NM",$P(XPDJ,U,2),0),U,4)=""
"RTN","XPDIJ",85,0)
 .I $P(XPDJ,U)=1 S X=XPDI X ^%ZOSF("DEL")
"RTN","XPDIJ",86,0)
 ;if graphic display, update full count
"RTN","XPDIJ",87,0)
 I $D(XPDIDVT) D UPDATE^XPDID(XPDIDCNT)
"RTN","XPDIJ",88,0)
 Q
"RTN","XPDIJ",89,0)
 ;
"RTN","XPDIJ",90,0)
VOLERR(V,F) ;volume set not updated,V=volume set, F=flag
"RTN","XPDIJ",91,0)
 N XQA,XQAMSG,XPDMES
"RTN","XPDIJ",92,0)
 S XPDMES(1)=" ",XPDMES(2)=" ** Job on VOLUME SET "_V_$S(F:" never started **",1:" has been idle for an hour.")
"RTN","XPDIJ",93,0)
 S XPDMES(3)=" ** "_V_" has NOT been updated! **"
"RTN","XPDIJ",94,0)
 S XQA(DUZ)="",XQAMSG="VOLUME SET "_V_" NOT updated for Install "_$E($P($G(^XPD(9.7,+$G(XPDA),0)),"^"),1,30)
"RTN","XPDIJ",95,0)
 D MES^XPDUTL(.XPDMES),SETUP^XQALERT
"RTN","XPDIJ",96,0)
 Q
"RTN","XPDIJ",97,0)
 ;come here on error, record error in Install file and cleanup var.
"RTN","XPDIJ",98,0)
ERR N XPDERROR,XQA,XQAMSG
"RTN","XPDIJ",99,0)
 S XPDERROR=$$EC^%ZOSV
"RTN","XPDIJ",100,0)
 ;record error, write message, reset terminal
"RTN","XPDIJ",101,0)
 D ^%ZTER,BMES^XPDUTL(XPDERROR),EXIT^XPDID()
"RTN","XPDIJ",102,0)
 S XQA(DUZ)="",XQAMSG="Install "_$E($P($G(^XPD(9.7,+$G(XPDA),0)),"^"),1,30)_" has encountered an Error."
"RTN","XPDIJ",103,0)
 D SETUP^XQALERT G UNWIND^%ZTER
"RTN","XPDIJ",104,0)
 ;
"RTN","XPDIJ",105,0)
LNRF(RN) ;Load needed routines first
"RTN","XPDIJ",106,0)
 I $D(^XTMP("XPDI",XPDA,"RTN",RN)) D
"RTN","XPDIJ",107,0)
 .N X
"RTN","XPDIJ",108,0)
 .D SAVE(RN)
"RTN","XPDIJ",109,0)
 .S XCN=$$RTNUP^XPDUTL(RN,2)
"RTN","XPDIJ",110,0)
 Q
"RTN","XPDUTL")
0^57^B19386445
"RTN","XPDUTL",1,0)
XPDUTL ;SFISC/RSD - KIDS utilities ;03/25/2003  15:00
"RTN","XPDUTL",2,0)
 ;;8.0;KERNEL;**21,28,39,81,100,108,137,181,275**;Jul 10, 1995
"RTN","XPDUTL",3,0)
 Q
"RTN","XPDUTL",4,0)
VERSION(X) ;Get current version from Package file, X=package name or
"RTN","XPDUTL",5,0)
 ;package namespace
"RTN","XPDUTL",6,0)
 N I
"RTN","XPDUTL",7,0)
 S I=$O(^DIC(9.4,"C",X,0)) S:I'>0 I=$O(^DIC(9.4,"B",X,0))
"RTN","XPDUTL",8,0)
 Q $P($G(^DIC(9.4,+I,"VERSION")),"^")
"RTN","XPDUTL",9,0)
 ;
"RTN","XPDUTL",10,0)
VER(X) ;returns version number from Build file, X=build name
"RTN","XPDUTL",11,0)
 Q:X["*" $P(X,"*",2)
"RTN","XPDUTL",12,0)
 Q $P(X," ",$L(X," "))
"RTN","XPDUTL",13,0)
 ;
"RTN","XPDUTL",14,0)
STATUS(IEN) ;returns build status from Build File, IEN=Build File IEN
"RTN","XPDUTL",15,0)
 I '$D(^XPD(9.7,IEN,0)) Q -1
"RTN","XPDUTL",16,0)
 Q $P(^XPD(9.7,IEN,0),U,9)
"RTN","XPDUTL",17,0)
 ;
"RTN","XPDUTL",18,0)
PKG(X) ;returns package name from Build file, X=build name
"RTN","XPDUTL",19,0)
 Q $S(X["*":$P(X,"*"),1:$P(X," ",1,$L(X," ")-1))
"RTN","XPDUTL",20,0)
 ;
"RTN","XPDUTL",21,0)
LAST(PKG,VER) ;returns last patch applied for a Package, PATCH^DATE
"RTN","XPDUTL",22,0)
 ;        Patch includes Seq # if Released
"RTN","XPDUTL",23,0)
 N PKGIEN,VERIEN,LATEST,PATCH,SUBIEN
"RTN","XPDUTL",24,0)
 I $G(VER)="" S VER=$$VERSION^XPDUTL(PKG) Q:'VER -1
"RTN","XPDUTL",25,0)
 S PKGIEN=$O(^DIC(9.4,"B",PKG,"")) Q:'PKGIEN -1
"RTN","XPDUTL",26,0)
 S VERIEN=$O(^DIC(9.4,PKGIEN,22,"B",VER,"")) Q:'VERIEN -1
"RTN","XPDUTL",27,0)
 S LATEST=-1,PATCH=-1,SUBIEN=0
"RTN","XPDUTL",28,0)
 F  S SUBIEN=$O(^DIC(9.4,PKGIEN,22,VERIEN,"PAH",SUBIEN)) Q:SUBIEN'>0  D
"RTN","XPDUTL",29,0)
 . I $P(^DIC(9.4,PKGIEN,22,VERIEN,"PAH",SUBIEN,0),U,2)>LATEST S LATEST=$P(^(0),U,2),PATCH=$P(^(0),U)
"RTN","XPDUTL",30,0)
 Q PATCH_U_LATEST
"RTN","XPDUTL",31,0)
 ;
"RTN","XPDUTL",32,0)
PATCH(X) ;return 1 if patch X was installed, X=aaaa*nn.nn*nnn
"RTN","XPDUTL",33,0)
 Q:X'?1.4UN1"*"1.2N1"."1.2N.1(1"V",1"T").2N1"*"1.3N 0
"RTN","XPDUTL",34,0)
 N %,I,J
"RTN","XPDUTL",35,0)
 S I=$O(^DIC(9.4,"C",$P(X,"*"),0)) Q:'I 0
"RTN","XPDUTL",36,0)
 S J=$O(^DIC(9.4,I,22,"B",$P(X,"*",2),0)),X=$P(X,"*",3) Q:'J 0
"RTN","XPDUTL",37,0)
 ;check if patch is just a number
"RTN","XPDUTL",38,0)
 Q:$O(^DIC(9.4,I,22,J,"PAH","B",X,0)) 1
"RTN","XPDUTL",39,0)
 S %=$O(^DIC(9.4,I,22,J,"PAH","B",X_" SEQ"))
"RTN","XPDUTL",40,0)
 Q (X=+%)
"RTN","XPDUTL",41,0)
 ;
"RTN","XPDUTL",42,0)
NEWCP(XPD,XPDC,XPDP) ;create new check point, returns 0=error or ien
"RTN","XPDUTL",43,0)
 ;XPD=name, XPDC=call back, XPDP=parameters
"RTN","XPDUTL",44,0)
 Q:$G(XPD)="" 0
"RTN","XPDUTL",45,0)
 N %,XPDI,XPDJ,XPDF,XPDY
"RTN","XPDUTL",46,0)
 ;XPDCP="INI"=Pre-init, "INIT"=Post-init
"RTN","XPDUTL",47,0)
 S XPDI=$S(XPDCP="INIT":9.716,1:9.713)
"RTN","XPDUTL",48,0)
 S %=$$FIND1^DIC(XPDI,","_XPDA_",","X",XPD) Q:% %
"RTN","XPDUTL",49,0)
 S XPDF="+1,"_XPDA_",",XPDJ(XPDI,XPDF,.01)=XPD
"RTN","XPDUTL",50,0)
 S:$D(XPDC) XPDJ(XPDI,XPDF,2)=XPDC
"RTN","XPDUTL",51,0)
 S:$D(XPDP) XPDJ(XPDI,XPDF,3)=XPDP
"RTN","XPDUTL",52,0)
 D UPDATE^DIE("","XPDJ","XPDY")
"RTN","XPDUTL",53,0)
 Q $G(XPDY(1))
"RTN","XPDUTL",54,0)
 ;
"RTN","XPDUTL",55,0)
UPCP(XPD,XPDP) ;update check point, returns 0=error or ien
"RTN","XPDUTL",56,0)
 ;XPD=name, XPDP=parameters
"RTN","XPDUTL",57,0)
 N XPDI,XPDJ,XPDF,XPDY
"RTN","XPDUTL",58,0)
 ;XPDCP="INI"=Pre-init, "INIT"=Post-init
"RTN","XPDUTL",59,0)
 S XPDI=$S(XPDCP="INIT":9.716,1:9.713),XPDY=$$DICCP($G(XPD))
"RTN","XPDUTL",60,0)
 Q:'XPDY 0
"RTN","XPDUTL",61,0)
 S XPDF=XPDY_","_XPDA_","
"RTN","XPDUTL",62,0)
 S:$D(XPDP) XPDJ(XPDI,XPDF,3)=XPDP
"RTN","XPDUTL",63,0)
 D FILE^DIE("","XPDJ")
"RTN","XPDUTL",64,0)
 Q XPDY
"RTN","XPDUTL",65,0)
 ;
"RTN","XPDUTL",66,0)
COMCP(XPD) ;complete check point, returns 0=error or date/time
"RTN","XPDUTL",67,0)
 ;XPD=name
"RTN","XPDUTL",68,0)
 N XPDD,XPDI,XPDJ,XPDY
"RTN","XPDUTL",69,0)
 S XPDI=$S(XPDCP="INIT":9.716,1:9.713),XPDY=$$DICCP($G(XPD))
"RTN","XPDUTL",70,0)
 Q:'XPDY 0
"RTN","XPDUTL",71,0)
 S XPDD=$$NOW^XLFDT,XPDJ(XPDI,XPDY_","_XPDA_",",1)=XPDD
"RTN","XPDUTL",72,0)
 D FILE^DIE("","XPDJ")
"RTN","XPDUTL",73,0)
 Q XPDD
"RTN","XPDUTL",74,0)
 ;
"RTN","XPDUTL",75,0)
VERCP(XPD) ;verify check point, returns 1=completed, 0=not
"RTN","XPDUTL",76,0)
 ;-1=doesn't exist
"RTN","XPDUTL",77,0)
 ;XPD=name
"RTN","XPDUTL",78,0)
 N XPDI,XPDY
"RTN","XPDUTL",79,0)
 S XPDI=$S(XPDCP="INIT":9.716,1:9.713),XPDY=$$DICCP($G(XPD))
"RTN","XPDUTL",80,0)
 Q:'XPDY -1
"RTN","XPDUTL",81,0)
 Q ''$$GET1^DIQ(XPDI,XPDY_","_XPDA_",",1,"I")
"RTN","XPDUTL",82,0)
 ;
"RTN","XPDUTL",83,0)
PARCP(XPD,XPDF) ;returns parameters of check point
"RTN","XPDUTL",84,0)
 ;XPD=name, XPDF="PRE"
"RTN","XPDUTL",85,0)
 N XPDI,XPDY
"RTN","XPDUTL",86,0)
 I $G(XPDF)="PRE" N XPDCP S XPDCP="INI"
"RTN","XPDUTL",87,0)
 S XPDI=$S(XPDCP="INIT":9.716,1:9.713),XPDY=$$DICCP($G(XPD))
"RTN","XPDUTL",88,0)
 Q:'XPDY 0
"RTN","XPDUTL",89,0)
 Q $$GET1^DIQ(XPDI,XPDY_","_XPDA_",",3,"I")
"RTN","XPDUTL",90,0)
 ;
"RTN","XPDUTL",91,0)
CURCP(XPDF) ;returns current check point
"RTN","XPDUTL",92,0)
 ;XPDF flag - 0=externel, 1=internal
"RTN","XPDUTL",93,0)
 Q $S($G(XPDF):XPDCHECK,1:XPDCHECK(0))
"RTN","XPDUTL",94,0)
 ;
"RTN","XPDUTL",95,0)
WP(X) ;X=global ref
"RTN","XPDUTL",96,0)
 N %
"RTN","XPDUTL",97,0)
 Q:'$D(@X)
"RTN","XPDUTL",98,0)
 F %=1:1 Q:'$D(@X@(%))  W !,@X@(%)
"RTN","XPDUTL",99,0)
 Q:'$G(XPDA)  D WP^DIE(9.7,XPDA_",",20,"A",X)
"RTN","XPDUTL",100,0)
 Q
"RTN","XPDUTL",101,0)
MES(X) ;record message, X=message or an array passed by reference
"RTN","XPDUTL",102,0)
 N %
"RTN","XPDUTL",103,0)
 I $D(X)#2 S %=X K X S X(1)=%
"RTN","XPDUTL",104,0)
 ;write message
"RTN","XPDUTL",105,0)
 F %=1:1 Q:'$D(X(%))  W !,X(%)
"RTN","XPDUTL",106,0)
 Q:'$G(XPDA)  D WP^DIE(9.7,XPDA_",",20,"A","X")
"RTN","XPDUTL",107,0)
 Q
"RTN","XPDUTL",108,0)
BMES(X) ;add blank line before message
"RTN","XPDUTL",109,0)
 N %
"RTN","XPDUTL",110,0)
 I $D(X)#2 S %=X K X S X(1)=" ",X(2)=%
"RTN","XPDUTL",111,0)
 D MES(.X)
"RTN","XPDUTL",112,0)
 Q
"RTN","XPDUTL",113,0)
RTNUP(X,Y) ;update routine action, X=routine, Y=action
"RTN","XPDUTL",114,0)
 ;actions:  1=delete, 2=skip
"RTN","XPDUTL",115,0)
 N %
"RTN","XPDUTL",116,0)
 ;set action to Y
"RTN","XPDUTL",117,0)
 Q:'$G(Y)!'$D(^XTMP("XPDI",$G(XPDA),"RTN",X)) 0 S $P(^(X),U)=+Y
"RTN","XPDUTL",118,0)
 Q 1
"RTN","XPDUTL",119,0)
 ;get Build ien
"RTN","XPDUTL",120,0)
 S Y=$O(^XTMP("XPDI",XPDA,"BLD",0))
"RTN","XPDUTL",121,0)
 ;remove checksum when updating action, since action can only be
"RTN","XPDUTL",122,0)
 ;delete or skip, not sure if we want to do this
"RTN","XPDUTL",123,0)
 S:$P(%,U,2) $P(^XTMP("XPDI",XPDA,"BLD",Y,"KRN",9.8,"NM",$P(%,U,2),0),U,4)=""
"RTN","XPDUTL",124,0)
 Q 1
"RTN","XPDUTL",125,0)
 ;
"RTN","XPDUTL",126,0)
RTNLOG(X) ;Enter/Update routine in the Routine File
"RTN","XPDUTL",127,0)
 N Y,FDA,IEN
"RTN","XPDUTL",128,0)
 S Y=$O(^DIC(9.8,"B",X,0))
"RTN","XPDUTL",129,0)
 I Y'>0 S IEN="?+1,",FDA(9.8,IEN,1)="R"
"RTN","XPDUTL",130,0)
 I Y>0 S IEN=(+Y)_","
"RTN","XPDUTL",131,0)
 S FDA(9.8,IEN,.01)=X,FDA(9.8,IEN,7.4)=$$NOW^XLFDT
"RTN","XPDUTL",132,0)
 D UPDATE^DIE("","FDA","IEN")
"RTN","XPDUTL",133,0)
 Q
"RTN","XPDUTL",134,0)
 ;
"RTN","XPDUTL",135,0)
DICCP(X) ;lookup check point, returns ien or 0
"RTN","XPDUTL",136,0)
 Q:$G(X)="" 0
"RTN","XPDUTL",137,0)
 ;if they pass ien, fail if can't find
"RTN","XPDUTL",138,0)
 I X=+X S Y=X Q:'$D(^XPD(9.7,XPDA,XPDCP,Y,0)) 0
"RTN","XPDUTL",139,0)
 E  S Y=$$FIND1^DIC(XPDI,","_XPDA_",","X",X)
"RTN","XPDUTL",140,0)
 Q Y
"RTN","XPDUTL",141,0)
 ;
"RTN","XPDUTL",142,0)
PRODE(XPDN,XPD) ;enable/disable protocols, return 1 for success
"RTN","XPDUTL",143,0)
 ;XPDN=protocol name, XPD=1-enable, 0-disable
"RTN","XPDUTL",144,0)
 Q:$G(XPDN)="" 0
"RTN","XPDUTL",145,0)
 S XPD=+$G(XPD)
"RTN","XPDUTL",146,0)
 D KIDS^XQOO1($P(XPDSET,U,2),101,XPDN,.XPD)
"RTN","XPDUTL",147,0)
 Q $S(XPD<0:0,1:1)
"RTN","XPDUTL",148,0)
 ;
"RTN","XPDUTL",149,0)
OPTDE(XPDN,XPD) ;enable/disable options, return 1 for success
"RTN","XPDUTL",150,0)
 ;XPDN=protocol name, XPD=1-enable, 0-disable
"RTN","XPDUTL",151,0)
 Q:$G(XPDN)="" 0
"RTN","XPDUTL",152,0)
 S XPD=+$G(XPD)
"RTN","XPDUTL",153,0)
 D KIDS^XQOO1($P(XPDSET,U,2),19,XPDN,.XPD)
"RTN","XPDUTL",154,0)
 Q $S(XPD<0:0,1:1)
"RTN","XPDUTL",155,0)
 ;
"RTN","XPDUTL",156,0)
BUILD(XPDN,XPD) ;check if a build exists, return 1 for success
"RTN","XPDUTL",157,0)
 ;XPDN=build name, XPD=1-exist, 0-been removed
"RTN","XPDUTL",158,0)
 S XPD=$D(XPDT("NM",XPDN))
"RTN","XPDUTL",159,0)
 Q XPD
"RTN","XPDUTL",160,0)
 ;
"RTN","XPDUTL",161,0)
MAILGRP(X) ;Return mail group for package, X=package name or namespace
"RTN","XPDUTL",162,0)
 N XD,DIC,DR,DA,DIQ
"RTN","XPDUTL",163,0)
 S DA=$O(^DIC(9.4,"C",X,0)) S:DA'>0 DA=$O(^DIC(9.4,"B",X,0)) Q:'DA ""
"RTN","XPDUTL",164,0)
 S DIC="^DIC(9.4,",DR=1938,DIQ="XD" D EN^DIQ1
"RTN","XPDUTL",165,0)
 Q $S($G(XD(9.4,DA,1938))="":"",1:"G."_XD(9.4,DA,1938))
"RTN","XTER")
0^58^B29070818
"RTN","XTER",1,0)
XTER ;ISC-SF.SEA/JLI - Error Trap Display option [XUERTRAP] ;16 Jul 2003 10:15 am
"RTN","XTER",2,0)
 ;;8.0;KERNEL;**63,275**;Jul 10, 1995
"RTN","XTER",3,0)
 ;
"RTN","XTER",4,0)
 N %,%XTZDAT,XTX,XTPRNT,XTOUT,XTMES,DIR,I
"RTN","XTER",5,0)
 K XTX,^TMP($J,"XTER"),^TMP($J,"XTERSCR"),XTPRNT,XTMES
"RTN","XTER",6,0)
 S U="^"
"RTN","XTER",7,0)
 F I=0:0 S I=$O(^%ZTER(2,"AC",1,I)) Q:I'>0  S %=$P(^%ZTER(2,I,0),U),%=$S($G(^(2))]"":^(2),1:%),^TMP($J,"XTERSCR",%)=""
"RTN","XTER",8,0)
 S U="^",IOP="HOME" D ^%ZIS K IOP S:'$D(DTIME) DTIME=9999 S XTOUT=0
"RTN","XTER",9,0)
 W !!,"In response to the DATE prompt you can enter:" S XTF="" D 11 W !!
"RTN","XTER",10,0)
 ;
"RTN","XTER",11,0)
%XTZDAT U IO(0) S XTOUT=0 S:'($D(XTX)#2) XTX="T" S:XTX="^" XTX="" I 1 R:XTX="" !!,"Which date? > ",XTX:300 G END:'$T!(XTX="^")!(XTX=""),END:XTX="^Q"!(XTX="^q") S X=XTX,XTX="" G:X["?" DIS
"RTN","XTER",12,0)
 I "Ss"[X D SLIST^XTER2 G %XTZDAT
"RTN","XTER",13,0)
 S %XTZDAT=X D UDD^XTER2 I $D(XTERR),XTERR=1 D IR G %XTZDAT
"RTN","XTER",14,0)
 S %XTZDAT=$S(XTDTH<0:-XTDTH,1:XTDTH) K XTDTH G DO
"RTN","XTER",15,0)
DIS W !,"Errors have been logged on: "
"RTN","XTER",16,0)
 S XTFST=0,XTH=+$H,X=""
"RTN","XTER",17,0)
 S XTJJ=$O(^%ZTER(1,0)) Q:XTJJ'>0  F XTJ=$H:-1 Q:XTJJ>XTJ  I $D(^%ZTER(1,XTJ,0)) W $S(XTFST:", ",1:""),"T" S XTFST=1 W:XTJ'=XTH "-",XTH-XTJ W "(",$P(^%ZTER(1,XTJ,0),U,2),")"
"RTN","XTER",18,0)
 S XTF="3,4,11" D HELP
"RTN","XTER",19,0)
 G %XTZDAT
"RTN","XTER",20,0)
DO S XTNE=$D(^%ZTER(1,%XTZDAT)) I 'XTNE D E1 G %XTZDAT
"RTN","XTER",21,0)
 S XTNE=$P($G(^%ZTER(1,%XTZDAT,0)),U,2) D E1 S XTX="??"
"RTN","XTER",22,0)
XTERR S:'($D(XTX)#2) XTX="" S:XTX="^" XTX="" I 1 R:XTX="" !!,"Which error? >  ",XTX:300 G END:'$T!(XTX="^Q")!(XTX="^q"),%XTZDAT:XTX'?1N.N&($E(XTX)'="?") S X=XTX,XTX=""
"RTN","XTER",23,0)
 I X?1"???".E S XTD=0 D LST^XTER1A G XTERR
"RTN","XTER",24,0)
 I X?1"??".E S XTD=1 D LST^XTER1A G XTERR
"RTN","XTER",25,0)
 I X="?" D E1 S XTF="1,2,6,5,12,16" D HELP G XTERR
"RTN","XTER",26,0)
 I (X="?L")!(X="?l") D ALL^XUTMKE1 G XTERR
"RTN","XTER",27,0)
 I X'?1N.N D E1,IR G XTERR
"RTN","XTER",28,0)
 S %XTZNUM=X
"RTN","XTER",29,0)
 K %XTZLIN I '($D(^%ZTER(1,%XTZDAT,1,%XTZNUM,0))#2) W !,"Error not on File." W:%XTZNUM>$P(^%ZTER(1,%XTZDAT,0),U,2) "  Last error logged is ",$P(^%ZTER(1,%XTZDAT,0),U,2),"." G XTERR
"RTN","XTER",30,0)
 G ^XTER1
"RTN","XTER",31,0)
IR W !!,"Incorrect response - enter '?' for more information" Q
"RTN","XTER",32,0)
HELP ;
"RTN","XTER",33,0)
 W !!,"Enter:" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",34,0)
1 W !?5,"^Q to EXIT" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",35,0)
2 W !?5,"'^' to return to the last question" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",36,0)
3 W !?5,"'^Q'  or  '^'  or <RETURN> to quit" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",37,0)
4 W !?5,"Date as 'DD' or 'MM/DD' or 'MM/DD/YY' or 'T'  or 'T-1'",!?15,"(note: 'T' as in Today)" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",38,0)
12 W !?5,"??? to list all errors with $ZE, $I, $J, and Time" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",39,0)
6 W !?5,"Number of error desired" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",40,0)
7 W !?5,"^L to obtain a list of all symbols" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",41,0)
8 X ^%ZOSF("PROGMODE") W:Y !?5,"^R to restore the symbol table and ... and enter direct mode" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",42,0)
9 W !?5,"$ to get a display of the $ system variables" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",43,0)
10 W !?5,"Leading character(s) of symbol(s) you wish to examine" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",44,0)
11 W !?5,"'S' to specify text to be matched in error or routine name" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",45,0)
5 W !?5,"?? to list only those errors which are NOT SCREENED with $ZE, $I, $J,",!?15,"and Time" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",46,0)
13 W !?5,"^P to select a printer and print this error" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",47,0)
14 W !?5,"^M to capture the current error in a mail message" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",48,0)
15 W !?5,"^I to obtain information on key package variables" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",49,0)
16 W !?5,"?L to obtain a list of error screens that are in place" S XTFI=$P(XTF,","),XTF=$P(XTF,",",2,99) G:XTFI="" EHELP G @XTFI
"RTN","XTER",50,0)
EHELP K XTF,XTFI
"RTN","XTER",51,0)
 Q
"RTN","XTER",52,0)
E1 W !,$S(XTNE:XTNE,1:"No")," error",$S(XTNE>1:"s",1:"")," logged on ",XTDTE
"RTN","XTER",53,0)
 Q
"RTN","XTER",54,0)
END D ^%ZISC
"RTN","XTER",55,0)
 K %XT,%XTZE,%XTZ,%XTJOB,%XTZH,%XTIO,%XTUCI,%XTERR,%XTZDAT,%XTZNUM,%XTZLIN,%XTZO,XTA,XTB,XTC,XTD,%XTX,%XTY,XTFST,XTH,%XTZGR,XTJJ,%,%H
"RTN","XTER",56,0)
 K %XTA,%XTB,%XTC,%XTF,%XTG,%XTI,%XTJ,%XTL,%XTD,%XTM,%XTN,XTI,XTJ,XTK,XTDTE,XTOUT,XTX,XTNE,XTP,XTQ,XTSYM,XTZ,%XTZZZ,XTERR,X,Y,%XTYL,%XTZH1,C,XTBLNK,XTDV1,XTA1,XTC1,XTMES,XTPRNT
"RTN","XTER",57,0)
 ; GT.M doesn't have a vendor-specific error trap lister
"RTN","XTER",58,0)
 N XTROU S XTROU=$G(^%ZOSF("OS"))  Q:XTROU=""  Q:XTROU["GT.M"
"RTN","XTER",59,0)
 I XTROU["OpenM" W !,"Use SYSLOG in the %SYS namespace" Q
"RTN","XTER",60,0)
 W !! S DIR(0)="Y",DIR("A")="Do you want to check the OPERATING SYSTEM ERROR TRAP too",DIR("B")="NO" D ^DIR K DIR Q:'Y
"RTN","XTER",61,0)
 S XTROU=U_$S(XTROU["DTM":"%errdump",1:"%ER") D:XTROU'="" @XTROU
"RTN","XTER",62,0)
 Q
"RTN","XTER",63,0)
 ;
"RTN","XTER",64,0)
MORE S XTOUT=0 I $D(IOST)#2,IOST["C-" R !?15,"Enter '^' to quit listing, <RETURN> to continue...",XTX:DTIME S:'$T XTX="^" I XTX="^" S XTOUT=1 Q
"RTN","XTER",65,0)
 Q
"RTN","XUCIGTM")
0^10^B3044514
"RTN","XUCIGTM",1,0)
%XUCI ;SFISC/STAFF,PUG/TOAD - SWAP UCIs GT.M ;20 May 2003 8:43 am
"RTN","XUCIGTM",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995;
"RTN","XUCIGTM",3,0)
 ; for GT.M for Unix & VMS, version 4.3--based on single UCI model
"RTN","XUCIGTM",4,0)
 ;
"RTN","XUCIGTM",5,0)
1 W !,"GT.M doesn't have an equivlent to UCI's.",!,"You will remain in this enviroment."
"RTN","XUCIGTM",6,0)
 R !,"What UCI: ",%UCI:$S($D(DTIME):DTIME,1:10),"  " Q:%UCI=""!(%UCI["^")
"RTN","XUCIGTM",7,0)
 G 2
"RTN","XUCIGTM",8,0)
 ;
"RTN","XUCIGTM",9,0)
2 ;For GT.M this is a NOP, Return Y.
"RTN","XUCIGTM",10,0)
 X ^%ZOSF("UCI")
"RTN","XUCIGTM",11,0)
U I '($D(XUSLNT)!$D(ZTQUEUED)) W *7,!,"YOU'RE IN UCI: ",Y,!
"RTN","XUCIGTM",12,0)
 S %=$D(^%ZOSF("OS"))
"RTN","XUCIGTM",13,0)
K K %,%UCI S Y=1 Q
"RTN","XUCIGTM",14,0)
 ;
"RTN","XUCIGTM",15,0)
SWAP ;
"RTN","XUCIGTM",16,0)
 ; X ^%ZOSF("PROGMODE") I 'Y S X=$S(X[",":$ZC(%SETUCI,$P(X,","),$P(X,",",2)),1:$ZC(%SETUCI,$P(X,","))),X=$ZC(%PGMSET),X=$ZC(%SECMAP)
"RTN","XUCIGTM",17,0)
 Q
"RTN","XUCIGTM",18,0)
 ;
"RTN","XUCIGTM",19,0)
ENT G 2:$D(%UCI)#2,1
"RTN","XUCIGTM",20,0)
 ;
"RTN","XUCIGTM",21,0)
GO ;GOTO some routine
"RTN","XUCIGTM",22,0)
 D 2 Q:0[Y
"RTN","XUCIGTM",23,0)
 S X=PGM I PGM'?1"%".E X ^%ZOSF("TEST") I '$T W !?9,"'"_X_"' DOES NOT EXIST IN "_%UCI,! HALT
"RTN","XUCIGTM",24,0)
 K ^XUTL("XQ",$J),^UTILITY($J) G @(U_PGM)
"RTN","XUCIGTM",25,0)
 ;
"RTN","XUCIGTM",26,0)
DO ;Do some routine and return
"RTN","XUCIGTM",27,0)
 S %UCI=$P(XQZ,"[",2,9),PGM=$P(XQZ,"[",1),%UCI=$E(%UCI,1,$L(%UCI)-1)
"RTN","XUCIGTM",28,0)
 D SAV,D S %UCI=Y D 2,RES Q
"RTN","XUCIGTM",29,0)
D N Y,%XUCI D 2 Q:0[Y  G @PGM Q
"RTN","XUCIGTM",30,0)
 ;
"RTN","XUCIGTM",31,0)
SAV S %XUCI="" F %="DUZ","DUZ(0)","DT","DTIME","IO","IO(0)","IOF","IOM","IOST","IOST(0)" S %XUCI=%XUCI_$S($D(@%)#2:@%,1:"")_"^"
"RTN","XUCIGTM",32,0)
 Q
"RTN","XUCIGTM",33,0)
RES F %=1:1:10 S @($P("DUZ^DUZ(0)^DT^DTIME^IO^IO(0)^IOF^IOM^IOST^IOST(0)","^",%))=$P(%XUCI,"^",%)
"RTN","XUCIGTM",34,0)
 Q
"RTN","XUCIGTM",35,0)
 ;
"RTN","XUCIGTM",36,0)
ERR W !?9,"'"_X_"' IS AN INVALID UCI!",!
"RTN","XUINP275")
0^^B3930987
"RTN","XUINP275",1,0)
XUINP275 ;ISF/RWF - PATCH 275 PRE/POST INSTALL ;06/28/2004  14:26
"RTN","XUINP275",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","XUINP275",3,0)
PRE ;PRE-init
"RTN","XUINP275",4,0)
 Q
"RTN","XUINP275",5,0)
POST ;POST-INIT
"RTN","XUINP275",6,0)
 D ALT1,ALT2
"RTN","XUINP275",7,0)
 Q
"RTN","XUINP275",8,0)
ALT1 ;ALTERNATE EDITOR GTM/VMS
"RTN","XUINP275",9,0)
 Q:$G(^%ZOSF("OS"))'["GT.M"
"RTN","XUINP275",10,0)
 N FDA,WP
"RTN","XUINP275",11,0)
 S WP(1)="Call to the VAX VMS EDT editor to process FileMan wordprocessing fields."
"RTN","XUINP275",12,0)
 S WP(2)="Creates a temporary VMS file in the default directory with a name of"
"RTN","XUINP275",13,0)
 S WP(3)="'DIWE$'_$JOB_'.TMP'.  This version will remove the two copies of the file"
"RTN","XUINP275",14,0)
 S WP(4)="that EDT leaves behind."
"RTN","XUINP275",15,0)
 S FDA(1.2,"?+1,",.01)="VMSEDT - GTM",FDA(1.2,"?+1,",1)="G GTMVMS^XTEDTVXD"
"RTN","XUINP275",16,0)
 S FDA(1.2,"?+1,",2)="I $ZV[""VMS""",FDA(1.2,"?+1,",7)="WP"
"RTN","XUINP275",17,0)
 D UPDATE^DIE("","FDA","IEN")
"RTN","XUINP275",18,0)
 Q
"RTN","XUINP275",19,0)
ALT2 ;ALTERNATE EDITOR Cache/VMS
"RTN","XUINP275",20,0)
 Q:$G(^%ZOSF("OS"))'["OpenM"
"RTN","XUINP275",21,0)
 Q:$ZV'["VMS"
"RTN","XUINP275",22,0)
 N FDA,WP
"RTN","XUINP275",23,0)
 S WP(1)="Call to the VAX VMS EDT editor to process FileMan wordprocessing fields."
"RTN","XUINP275",24,0)
 S WP(2)="Creates a temporary VMS file in the default directory with a name of"
"RTN","XUINP275",25,0)
 S WP(3)="'DIWE$'_$JOB_'.TMP'.  This version will remove the two copies of the file"
"RTN","XUINP275",26,0)
 S WP(4)="that EDT leaves behind."
"RTN","XUINP275",27,0)
 S FDA(1.2,"?+1,",.01)="VMSEDT - CACHE",FDA(1.2,"?+1,",1)="G CACHE^XTEDTVXD"
"RTN","XUINP275",28,0)
 S FDA(1.2,"?+1,",2)="I $ZV[""VMS""",FDA(1.2,"?+1,",7)="WP"
"RTN","XUINP275",29,0)
 D UPDATE^DIE("","FDA","IEN")
"RTN","XUINP275",30,0)
 Q
"RTN","XUSCNT")
0^55^B10246308
"RTN","XUSCNT",1,0)
XUSCNT ;ISF/RWF - Job counting for GTM ;6/24/04  15:22
"RTN","XUSCNT",2,0)
 ;;8.0;KERNEL;**275**;July 10, 1995;
"RTN","XUSCNT",3,0)
 ;0 return CNT
"RTN","XUSCNT",4,0)
 ;1 inc CNT
"RTN","XUSCNT",5,0)
 ;-1 dec CNT
"RTN","XUSCNT",6,0)
COUNT(INC,JOB) ;Keep count of jobs
"RTN","XUSCNT",7,0)
 N XUCNT,X
"RTN","XUSCNT",8,0)
 S JOB=$G(JOB,$J)
"RTN","XUSCNT",9,0)
 ;Return Current Count
"RTN","XUSCNT",10,0)
 I INC=0 D TOUCH Q +$G(^XUTL("XUSYS","CNT"))
"RTN","XUSCNT",11,0)
 ;Increment Count
"RTN","XUSCNT",12,0)
 I INC>0 D  Q
"RTN","XUSCNT",13,0)
 . S X=$G(^XUTL("XUSYS",JOB,"NM")) K ^XUTL("XUSYS",JOB) S ^XUTL("XUSYS",JOB,"NM")=X
"RTN","XUSCNT",14,0)
 . D TOUCH
"RTN","XUSCNT",15,0)
 . L +^XUTL("XUSYS","CNT"):5
"RTN","XUSCNT",16,0)
 . S XUCNT=$G(^XUTL("XUSYS","CNT"))+1,^XUTL("XUSYS","CNT")=XUCNT
"RTN","XUSCNT",17,0)
 . L -^XUTL("XUSYS","CNT")
"RTN","XUSCNT",18,0)
 . Q
"RTN","XUSCNT",19,0)
 ;Decrement Count
"RTN","XUSCNT",20,0)
 I INC<0 D  Q
"RTN","XUSCNT",21,0)
 . L +^XUTL("XUSYS","CNT"):5
"RTN","XUSCNT",22,0)
 . S XUCNT=$G(^XUTL("XUSYS","CNT"))-1,^XUTL("XUSYS","CNT")=$S(XUCNT>0:XUCNT,1:0)
"RTN","XUSCNT",23,0)
 . L -^XUTL("XUSYS","CNT")
"RTN","XUSCNT",24,0)
 . K ^XUTL("XUSYS",JOB)
"RTN","XUSCNT",25,0)
 Q
"RTN","XUSCNT",26,0)
 ;
"RTN","XUSCNT",27,0)
CHECK(JOB) ;Check if job number active
"RTN","XUSCNT",28,0)
 ; 0 = Job doesn't seem to be running
"RTN","XUSCNT",29,0)
 ; 1 = Job maybe running
"RTN","XUSCNT",30,0)
 ; 2 = Job still has Lock out.
"RTN","XUSCNT",31,0)
 Q:$G(JOB)'>0 0
"RTN","XUSCNT",32,0)
 I '$D(^XUTL("XUSYS",JOB)) Q 0
"RTN","XUSCNT",33,0)
 N LK,%T
"RTN","XUSCNT",34,0)
 S %T=0,LK=$$GETLOCK()
"RTN","XUSCNT",35,0)
 I $L(LK) L +@LK:0 S %T=$T L:%T -@LK
"RTN","XUSCNT",36,0)
 Q $S(%T:2,1:1)
"RTN","XUSCNT",37,0)
 ;
"RTN","XUSCNT",38,0)
SETLOCK(NLK) ;Set the Lock we will keep
"RTN","XUSCNT",39,0)
 I $L($G(NLK)) S ^XUTL("XUSYS",$J,"LOCK")=NLK
"RTN","XUSCNT",40,0)
 E  K ^XUTL("XUSYS",$J,"LOCK")
"RTN","XUSCNT",41,0)
 D TOUCH ;Update the time
"RTN","XUSCNT",42,0)
 Q
"RTN","XUSCNT",43,0)
 ;
"RTN","XUSCNT",44,0)
TOUCH ;Update the time
"RTN","XUSCNT",45,0)
 S ^XUTL("XUSYS",$J,0)=$H
"RTN","XUSCNT",46,0)
 Q
"RTN","XUSCNT",47,0)
 ;
"RTN","XUSCNT",48,0)
GETLOCK() ;Get the node to Lock
"RTN","XUSCNT",49,0)
 Q $G(^XUTL("XUSYS",$J,"LOCK"))
"RTN","XUSCNT",50,0)
 ;
"RTN","XUSCNT",51,0)
CLEAR(DB) ;Check for locks and time clear old ones.
"RTN","XUSCNT",52,0)
 N %J,%T,CNT,CT,LK,IM,IMAGE,H K ^TMP($J)
"RTN","XUSCNT",53,0)
 D TOUCH ;See that we are current
"RTN","XUSCNT",54,0)
 ;S %J=0 F  S %J=$ZPID(%J) Q:%J'>0  S ^TMP($J,%J)="",^TMP($J,%J,1)=$ZGETJPI(%J,"IMAGNAME")
"RTN","XUSCNT",55,0)
 S DB=+$G(DB),IMAGE="mumps" ;$ZGETJPI($J,"IMAGNAME") ; ours
"RTN","XUSCNT",56,0)
 S %J=0,CNT=0,H=$H,CT=$$H3($H)
"RTN","XUSCNT",57,0)
 I DB W !,"Current Job Count: ",$$COUNT(0)
"RTN","XUSCNT",58,0)
 F  S %J=$O(^XUTL("XUSYS",%J)) Q:%J'>0  D
"RTN","XUSCNT",59,0)
 . S CNT=CNT+1
"RTN","XUSCNT",60,0)
 . I DB W !,CNT," Job: ",%J
"RTN","XUSCNT",61,0)
 . S LK=$G(^XUTL("XUSYS",%J,"LOCK")) ;Get lock name
"RTN","XUSCNT",62,0)
 . I '$L(LK) W:DB " No Lock node"
"RTN","XUSCNT",63,0)
 . I $L(LK) L +@LK:0 S %T=$T D  Q:'%T  L -@LK ;Quit if lock still held
"RTN","XUSCNT",64,0)
 . . I '%T,DB W " Lock Held"
"RTN","XUSCNT",65,0)
 . . I %T,DB W " Lock Fail"
"RTN","XUSCNT",66,0)
 . S IM=$G(^TMP($J,%J,1))
"RTN","XUSCNT",67,0)
 . I IM=IMAGE W:DB " Image Match: ",IM  Q
"RTN","XUSCNT",68,0)
 . I IM["ZFOO.EXE" W:DB " ZFOO Image" Q  ;Quit if in same image
"RTN","XUSCNT",69,0)
 . S H=$G(^XUTL("XUSYS",%J,0)) I H>0 S H=$$H3(H)
"RTN","XUSCNT",70,0)
 . I H+60>CT D  Q  ;Updated in last 30 seconds.
"RTN","XUSCNT",71,0)
 . .  I DB W " Current TimeStamp"
"RTN","XUSCNT",72,0)
 . S NM=$G(^XUTL("XUSYS",%J,"NM"))
"RTN","XUSCNT",73,0)
 . I NM["Task " S TM=+$P(NM,"Task ",2) I TM>0 D  Q:%
"RTN","XUSCNT",74,0)
 . . S TM(1)=$G(^%ZTSK(TM,.1)),%=(TM(1)=5)
"RTN","XUSCNT",75,0)
 . . I DB,% W " Running Task"
"RTN","XUSCNT",76,0)
 . . Q
"RTN","XUSCNT",77,0)
 . ;More checks
"RTN","XUSCNT",78,0)
 . D COUNT(-1,%J) I DB W " Not Active: Removed" ;Not Active
"RTN","XUSCNT",79,0)
 . Q
"RTN","XUSCNT",80,0)
 L +^XUTL("XUSYS","CNT"):3
"RTN","XUSCNT",81,0)
 S CNT=0,%J=0 F  S %J=$O(^XUTL("XUSYS",%J)) Q:%J'>0  S CNT=CNT+1
"RTN","XUSCNT",82,0)
 S ^XUTL("XUSYS","CNT")=CNT
"RTN","XUSCNT",83,0)
 L -^XUTL("XUSYS","CNT")
"RTN","XUSCNT",84,0)
 I DB W !,"New JOB count: ",CNT
"RTN","XUSCNT",85,0)
 Q
"RTN","XUSCNT",86,0)
 ;
"RTN","XUSCNT",87,0)
H3(%H) ;Just seconds
"RTN","XUSCNT",88,0)
 Q %H*86400+$P(%H,",",2)
"RTN","XUSCNT",89,0)
 ;
"RTN","XUSCNT",90,0)
 ;Called from the X-REF both the volume and Max signon from file 8989.3
"RTN","XUSCNT",91,0)
XREF(X1,V) ;V="S" or "K"
"RTN","XUSCNT",92,0)
 N %,N
"RTN","XUSCNT",93,0)
 S %=$G(^XTV(8989.3,1,4,X1,0)),N=$P(%,"^") Q:%=""
"RTN","XUSCNT",94,0)
 I V="K" K ^XTV(8989.3,"AMAX",N) Q
"RTN","XUSCNT",95,0)
 S ^XTV(8989.3,"AMAX",N)=$P(%,"^",3)
"RTN","XUSCNT",96,0)
 Q
"RTN","XUSRB1")
0^60^B20693023
"RTN","XUSRB1",1,0)
XUSRB1 ;iscSF/RWF - More Request Broker ;6/8/04  16:41
"RTN","XUSRB1",2,0)
 ;;8.0;KERNEL;**28,82,135,275**;Jul 10, 1995
"RTN","XUSRB1",3,0)
 Q  ;No entry from top
"RTN","XUSRB1",4,0)
 ;
"RTN","XUSRB1",5,0)
DECRYP(S) ;decrypt passed string
"RTN","XUSRB1",6,0)
 ;VYD 5/19/95
"RTN","XUSRB1",7,0)
 N ASSOCIX,IDIX,ASSOCSTR,IDSTR
"RTN","XUSRB1",8,0)
 Q:$L(S)'>2 "" ;Bad call
"RTN","XUSRB1",9,0)
 S ASSOCIX=$A($E(S,$L(S)))-31           ;get associator string index
"RTN","XUSRB1",10,0)
 S IDIX=$A($E(S))-31                    ;get identifier string index
"RTN","XUSRB1",11,0)
 S ASSOCSTR=$P($T(Z+ASSOCIX),";",3,9)   ;get associator string
"RTN","XUSRB1",12,0)
 S IDSTR=$P($T(Z+IDIX),";",3,9)         ;get identifier string
"RTN","XUSRB1",13,0)
 Q $TR($E(S,2,$L(S)-1),ASSOCSTR,IDSTR)  ;translated result
"RTN","XUSRB1",14,0)
 ;
"RTN","XUSRB1",15,0)
ENCRYP(S) ;RWF 2/5/96
"RTN","XUSRB1",16,0)
 N %,ASSOCIX,IDIX,ASSOCSTR,IDSTR
"RTN","XUSRB1",17,0)
 S ASSOCIX=$R(20)+1                     ;get associator index
"RTN","XUSRB1",18,0)
 F  S IDIX=$R(20)+1 Q:ASSOCIX'=IDIX     ;get different identifier index
"RTN","XUSRB1",19,0)
 S ASSOCSTR=$P($T(Z+ASSOCIX),";",3,9)   ;get associator string
"RTN","XUSRB1",20,0)
 S IDSTR=$P($T(Z+IDIX),";",3,9)         ;get identifier string
"RTN","XUSRB1",21,0)
 ;translated result
"RTN","XUSRB1",22,0)
 Q $C(IDIX+31)_$TR(S,IDSTR,ASSOCSTR)_$C(ASSOCIX+31)
"RTN","XUSRB1",23,0)
 ;
"RTN","XUSRB1",24,0)
SENDKEYS(RESULT) ;send encryption keys to the client
"RTN","XUSRB1",25,0)
 ;VYD 5/19/95
"RTN","XUSRB1",26,0)
 N %,X
"RTN","XUSRB1",27,0)
 S %=1
"RTN","XUSRB1",28,0)
 F  S X=$P($T(Z+%),";",3,9) Q:X=""  S RESULT(%)=X,%=%+1
"RTN","XUSRB1",29,0)
 Q
"RTN","XUSRB1",30,0)
 ;
"RTN","XUSRB1",31,0)
BLDDRUM Q  ;don't run this tag
"RTN","XUSRB1",32,0)
 N I,%,ALLCHARS,RNDMSTR,CHAR
"RTN","XUSRB1",33,0)
 X "ZP Z"                      ;position insertion point
"RTN","XUSRB1",34,0)
 F I=1:1:20 D
"RTN","XUSRB1",35,0)
 . S ALLCHARS="" F %=32:1:126 S:$C(%)'="^" ALLCHARS=ALLCHARS_$C(%)
"RTN","XUSRB1",36,0)
 . S RNDMSTR=""
"RTN","XUSRB1",37,0)
 . F %=1:1:94 D
"RTN","XUSRB1",38,0)
 . . S POS=$R($L(ALLCHARS))+1,CHAR=$E(ALLCHARS,POS)
"RTN","XUSRB1",39,0)
 . . S RNDMSTR=RNDMSTR_CHAR
"RTN","XUSRB1",40,0)
 . . S ALLCHARS=$P(ALLCHARS,CHAR,1)_$P(ALLCHARS,CHAR,2) ;compress by 1
"RTN","XUSRB1",41,0)
 . X "ZI "" ;;""_RNDMSTR"      ;save random string in routine
"RTN","XUSRB1",42,0)
 X "ZS"                        ;save routine
"RTN","XUSRB1",43,0)
 Q
"RTN","XUSRB1",44,0)
 ;
"RTN","XUSRB1",45,0)
 ;
"RTN","XUSRB1",46,0)
Z ;;
"RTN","XUSRB1",47,0)
 ;;wkEo-ZJt!dG)49K{nX1BS$vH<&:Myf*>Ae0jQW=;|#PsO`'%+rmb[gpqN,l6/hFC@DcUa ]z~R}"V\iIxu?872.(TYL5_3
"RTN","XUSRB1",48,0)
 ;;rKv`R;M/9BqAF%&tSs#Vh)dO1DZP> *fX'u[.4lY=-mg_ci802N7LTG<]!CWo:3?{+,5Q}(@jaExn$~p\IyHwzU"|k6Jeb
"RTN","XUSRB1",49,0)
 ;;\pV(ZJk"WQmCn!Y,y@1d+~8s?[lNMxgHEt=uw|X:qSLjAI*}6zoF{T3#;ca)/h5%`P4$r]G'9e2if_>UDKb7<v0&- RBO.
"RTN","XUSRB1",50,0)
 ;;depjt3g4W)qD0V~NJar\B "?OYhcu[<Ms%Z`RIL_6:]AX-zG.#}$@vk7/5x&*m;(yb2Fn+l'PwUof1K{9,|EQi>H=CT8S!
"RTN","XUSRB1",51,0)
 ;;NZW:1}K$byP;jk)7'`x90B|cq@iSsEnu,(l-hf.&Y_?J#R]+voQXU8mrV[!p4tg~OMez CAaGFD6H53%L/dT2<*>"{\wI=
"RTN","XUSRB1",52,0)
 ;;vCiJ<oZ9|phXVNn)m K`t/SI%]A5qOWe\&?;jT~M!fz1l>[D_0xR32c*4.P"G{r7}E8wUgyudF+6-:B=$(sY,LkbHa#'@Q
"RTN","XUSRB1",53,0)
 ;;hvMX,'4Ty;[a8/{6l~F_V"}qLI\!@x(D7bRmUH]W15J%N0BYPkrs&9:$)Zj>u|zwQ=ieC-oGA.#?tfdcO3gp`S+En K2*<
"RTN","XUSRB1",54,0)
 ;;jd!W5[];4'<C$/&x|rZ(k{>?ghBzIFN}fAK"#`p_TqtD*1E37XGVs@0nmSe+Y6Qyo-aUu%i8c=H2vJ\) R:MLb.9,wlO~P
"RTN","XUSRB1",55,0)
 ;;2ThtjEM+!=xXb)7,ZV{*ci3"8@_l-HS69L>]\AUF/Q%:qD?1~m(yvO0e'<#o$p4dnIzKP|`NrkaGg.ufCRB[; sJYwW}5&
"RTN","XUSRB1",56,0)
 ;;vB\5/zl-9y:Pj|=(R'7QJI *&CTX"p0]_3.idcuOefVU#omwNZ`$Fs?L+1Sk<,b)hM4A6[Y%aDrg@~KqEW8t>H};n!2xG{
"RTN","XUSRB1",57,0)
 ;;sFz0Bo@_HfnK>LR}qWXV+D6`Y28=4Cm~G/7-5A\b9!a#rP.l&M$hc3ijQk;),TvUd<[:I"u1'NZSOw]*gxtE{eJp|y (?%
"RTN","XUSRB1",58,0)
 ;;M@,D}|LJyGO8`$*ZqH .j>c~h<d=fimszv[#-53F!+a;NC'6T91IV?(0x&/{B)w"]Q\YUWprk4:ol%g2nE7teRKbAPuS_X
"RTN","XUSRB1",59,0)
 ;;.mjY#_0*H<B=Q+FML6]s;r2:e8R}[ic&KA 1w{)vV5d,$u"~xD/Pg?IyfthO@CzWp%!`N4Z'3-(o|J9XUE7k\TlqSb>anG
"RTN","XUSRB1",60,0)
 ;;xVa1']_GU<X`|\NgM?LS9{"jT%s$}y[nvtlefB2RKJW~(/cIDCPow4,>#zm+:5b@06O3Ap8=*7ZFY!H-uEQk; .q)i&rhd
"RTN","XUSRB1",61,0)
 ;;I]Jz7AG@QX."%3Lq>METUo{Pp_ |a6<0dYVSv8:b)~W9NK`(r'4fs&wim\kReC2hg=HOj$1B*/nxt,;c#y+![?lFuZ-5D}
"RTN","XUSRB1",62,0)
 ;;Rr(Ge6F Hx>q$m&C%M~Tn,:"o'tX/*yP.{lZ!YkiVhuw_<KE5a[;}W0gjsz3]@7cI2\QN?f#4p|vb1OUBD9)=-LJA+d`S8
"RTN","XUSRB1",63,0)
 ;;I~k>y|m};d)-7DZ"Fe/Y<B:xwojR,Vh]O0Sc[`$sg8GXE!1&Qrzp._W%TNK(=J 3i*2abuHA4C'?Mv\Pq{n#56LftUl@9+
"RTN","XUSRB1",64,0)
 ;;~A*>9 WidFN,1KsmwQ)GJM{I4:C%}#Ep(?HB/r;t.&U8o|l['Lg"2hRDyZ5`nbf]qjc0!zS-TkYO<_=76a\X@$Pe3+xVvu
"RTN","XUSRB1",65,0)
 ;;yYgjf"5VdHc#uA,W1i+v'6|@pr{n;DJ!8(btPGaQM.LT3oe?NB/&9>Z`-}02*%x<7lsqz4OS ~E$\R]KI[:UwC_=h)kXmF
"RTN","XUSRB1",66,0)
 ;;5:iar.{YU7mBZR@-K|2 "+~`M%8sq4JhPo<_X\Sg3WC;Tuxz,fvEQ1p9=w}FAI&j/keD0c?)LN6OHV]lGy'$*>nd[(tb!#
"RTN","XUTMDEVQ")
0^59^B13760584
"RTN","XUTMDEVQ",1,0)
XUTMDEVQ ;ISCSF/RWF - Device call and Queue in one place ;06/11/99  10:33
"RTN","XUTMDEVQ",2,0)
 ;;8.0;KERNEL;**20,120,275**;Jul 10, 1995
"RTN","XUTMDEVQ",3,0)
 ;  this routine has four entry points:  EN, DEV, NODEV, QQ
"RTN","XUTMDEVQ",4,0)
 ;  usage:
"RTN","XUTMDEVQ",5,0)
 ;D EN^XUTMDEVQ(ZTRTN,ZTDESC,.ZTSAVE,[.]%ZIS,[FLAG])
"RTN","XUTMDEVQ",6,0)
 ;S X=$$DEV^XUTMQUE(ZTRTN,ZTDESC,[.]%VAR,.%VOTH,[.]%ZIS,IOP,%WR)
"RTN","XUTMDEVQ",7,0)
 ;S X=$$NODEV^XUTMQUE(ZTRTN,ZTDESC,[.]%VAR,.%VOTH,%WR)
"RTN","XUTMDEVQ",8,0)
 ;S X=$$QQ(%RTN,%DESC,[.]%VAR1,.%VOTH1,.%ZIS,IOP,%WR,%RTN2,%DESC2,[.]%VAR2,.%VOTH2)
"RTN","XUTMDEVQ",9,0)
 ;EN
"RTN","XUTMDEVQ",10,0)
 ;Call with %ZTLOAD parameters and it will call $ZIS and
"RTN","XUTMDEVQ",11,0)
 ;run or queue the output.
"RTN","XUTMDEVQ",12,0)
 ;
"RTN","XUTMDEVQ",13,0)
EN(ZTRTN,ZTDESC,ZTSAVE,%ZIS,%) ;ZTSAVE AND %ZIS pass by reference.
"RTN","XUTMDEVQ",14,0)
 Q:$G(ZTRTN)=""
"RTN","XUTMDEVQ",15,0)
 N ZTIO,ZTDTH,ZTSYNC,ZTCPU,ZTUCI N:'$G(%) ZTSK K IO("Q")
"RTN","XUTMDEVQ",16,0)
 D ZIS I POP G KILL
"RTN","XUTMDEVQ",17,0)
 I '$D(IO("Q")) D RUN G KILL
"RTN","XUTMDEVQ",18,0)
 D ZTLOAD
"RTN","XUTMDEVQ",19,0)
KILL K ZTDTH,ZTSAVE
"RTN","XUTMDEVQ",20,0)
 Q
"RTN","XUTMDEVQ",21,0)
ZIS ;
"RTN","XUTMDEVQ",22,0)
 S:$G(%ZIS)'["Q" %ZIS=$G(%ZIS)_"Q"
"RTN","XUTMDEVQ",23,0)
 D ^%ZIS:'$D(XGWIN),^ZISG:$D(XGWIN)
"RTN","XUTMDEVQ",24,0)
 Q
"RTN","XUTMDEVQ",25,0)
ZTLOAD ;
"RTN","XUTMDEVQ",26,0)
 K IO("Q")
"RTN","XUTMDEVQ",27,0)
 D ^%ZTLOAD
"RTN","XUTMDEVQ",28,0)
 D HOME^%ZIS
"RTN","XUTMDEVQ",29,0)
 Q
"RTN","XUTMDEVQ",30,0)
RUN ;
"RTN","XUTMDEVQ",31,0)
 U IO
"RTN","XUTMDEVQ",32,0)
 D @ZTRTN
"RTN","XUTMDEVQ",33,0)
 D ^%ZISC
"RTN","XUTMDEVQ",34,0)
 Q
"RTN","XUTMDEVQ",35,0)
 ;
"RTN","XUTMDEVQ",36,0)
DEV(ZTRTN,ZTDESC,%VAR,%VOTH,%ZIS,IOP,%WR) ;  single que ask for device
"RTN","XUTMDEVQ",37,0)
 ;  ZTRTN - required - [tag]^routine that taskman will run
"RTN","XUTMDEVQ",38,0)
 ; ZTDESC - optional - default to name of [tag]~routine
"RTN","XUTMDEVQ",39,0)
 ;   %VAR - optional - single value or passed by reference
"RTN","XUTMDEVQ",40,0)
 ;          this will be used to S ZTSAVE()
"RTN","XUTMDEVQ",41,0)
 ;          can be a string of variable names separated by ';'
"RTN","XUTMDEVQ",42,0)
 ;            each ;-piece will be used as a subscript in ztsave
"RTN","XUTMDEVQ",43,0)
 ;  %VOTH - optional - passed by reference
"RTN","XUTMDEVQ",44,0)
 ;          %voth(sub)="" or explicit value
"RTN","XUTMDEVQ",45,0)
 ;             sub - this is any other %ZTLOAD variable besides 
"RTN","XUTMDEVQ",46,0)
 ;                   ZTRTN,ZTDESC,ZTIO,ZTSAVE
"RTN","XUTMDEVQ",47,0)
 ;                   example:  %VOTH("ZTDTH")=$H
"RTN","XUTMDEVQ",48,0)
 ;   %ZIS - optional - default value "MQ" - passed by reference
"RTN","XUTMDEVQ",49,0)
 ;          standard %ZIS variable array for calling device handler
"RTN","XUTMDEVQ",50,0)
 ;    IOP - optional - IOP variable as defined in Kernel device handler
"RTN","XUTMDEVQ",51,0)
 ;    %WR - optional - if %WR>0 then write text to the screen as to
"RTN","XUTMDEVQ",52,0)
 ;                     whether or not the queueing was successful
"RTN","XUTMDEVQ",53,0)
 ;
"RTN","XUTMDEVQ",54,0)
 ;  return: ZTSK value if successfully queued
"RTN","XUTMDEVQ",55,0)
 ;          0 if run ztrtn without queuing
"RTN","XUTMDEVQ",56,0)
 ;         -1 if unsuccessful device call or failed %ztload call
"RTN","XUTMDEVQ",57,0)
 ;
"RTN","XUTMDEVQ",58,0)
 N ZTIO,ZTDTH,ZTSYNC,ZTCPU,ZTUCI,ZTSAVE,ZTSK,ZTPRI,ZTKIL,%RET,POP
"RTN","XUTMDEVQ",59,0)
 S %RET=-1 I $G(ZTRTN)="" G OUT
"RTN","XUTMDEVQ",60,0)
 D SETUP,ZIS I POP G OUT
"RTN","XUTMDEVQ",61,0)
 I '$D(IO("Q")) D RUN S %RET=0
"RTN","XUTMDEVQ",62,0)
 D ZTLOAD
"RTN","XUTMDEVQ",63,0)
OUT I $G(%WR),%RET'=0,'$D(XGWIN),'$D(ZTQUEUED) D
"RTN","XUTMDEVQ",64,0)
 .W !! I %RET<0 W "Request Aborted",!
"RTN","XUTMDEVQ",65,0)
 .E  W "Task queued ["_(+%RET)_"]",!
"RTN","XUTMDEVQ",66,0)
 .I $P(%RET,U,2) W !,"Second task queued ["_$P(%RET,U,2)_"]",!
"RTN","XUTMDEVQ",67,0)
 .Q
"RTN","XUTMDEVQ",68,0)
 Q %RET
"RTN","XUTMDEVQ",69,0)
 ;
"RTN","XUTMDEVQ",70,0)
NODEV(ZTRTN,ZTDESC,%VAR,%VOTH,%WR) ;  single que no device needed
"RTN","XUTMDEVQ",71,0)
 ;  see DEV for parameter descriptions and return values
"RTN","XUTMDEVQ",72,0)
 N ZTIO,ZTDTH,ZTSYNC,ZTCPU,ZTUCI,ZTSAVE,ZTSK,ZTKIL,ZTPRI,%RET,POP
"RTN","XUTMDEVQ",73,0)
 S %RET=-1 I $G(ZTRTN)]"" S ZTIO="" D SETUP,ZTLOAD
"RTN","XUTMDEVQ",74,0)
 G OUT
"RTN","XUTMDEVQ",75,0)
 ;
"RTN","XUTMDEVQ",76,0)
QQ(%RTN,%DESC,%VAR1,%VOTH1,%ZIS,IOP,%WR,%RTN2,%DESC2,%VAR2,%VOTH2) ;
"RTN","XUTMDEVQ",77,0)
 ;  double queuing - queue up the second routine to device, but do not
"RTN","XUTMDEVQ",78,0)
 ;                   schedule the task in Taskman
"RTN","XUTMDEVQ",79,0)
 ;    queue up the first job to ZTIO="" and schedule it
"RTN","XUTMDEVQ",80,0)
 ;  %RTN - required - [tag]^routine for the 1st job to be run (usually a
"RTN","XUTMDEVQ",81,0)
 ;                    search and build sorted data type process)
"RTN","XUTMDEVQ",82,0)
 ; %DESC - optional - ZTDESC value for 1st job (default [tag]~routine)
"RTN","XUTMDEVQ",83,0)
 ; %VAR1 - optional - ZTSAVE values for 1st job - see %VAR descript above
"RTN","XUTMDEVQ",84,0)
 ;%VOTH1 - optional - 1st job - see %VOTH description above
"RTN","XUTMDEVQ",85,0)
 ;  %ZIS - optional - see %ZIS description above, except for one diff
"RTN","XUTMDEVQ",86,0)
 ;         the 2nd job will be tasked to this device call
"RTN","XUTMDEVQ",87,0)
 ;         exception: IF $D(%ZIS)=0 then default value is "MQ" and call
"RTN","XUTMDEVQ",88,0)
 ;                    device handler
"RTN","XUTMDEVQ",89,0)
 ;                    IF $D(%ZIS)=1,%ZIS="" then queue 2nd job also with
"RTN","XUTMDEVQ",90,0)
 ;                       ZTIO=""  i.e., do not do device handler call
"RTN","XUTMDEVQ",91,0)
 ;   IOP - optional - see above - default value "Q" - if IOP is passed
"RTN","XUTMDEVQ",92,0)
 ;                    and IOP does not start with "Q;" then "Q;" will
"RTN","XUTMDEVQ",93,0)
 ;                    be added
"RTN","XUTMDEVQ",94,0)
 ;   %WR - optional - see above
"RTN","XUTMDEVQ",95,0)
 ; %RTN2 - required - [tag]^routine for the 2nd job to be run (usually a
"RTN","XUTMDEVQ",96,0)
 ;                    print job)
"RTN","XUTMDEVQ",97,0)
 ;%DESC2 - optional - ZTDESC value for 2nd job (default [tag]~routine)
"RTN","XUTMDEVQ",98,0)
 ; %VAR2 - optional - ZTSAVE values for 2nd job - see %VAR descript above
"RTN","XUTMDEVQ",99,0)
 ;         if %VAR1 is not passed and $D(%VAR) then also send %VAR
"RTN","XUTMDEVQ",100,0)
 ;         data to 2nd tasked job.  If $D(%VAR1) then do not send %VAR
"RTN","XUTMDEVQ",101,0)
 ;         data to 2nd tasked job.
"RTN","XUTMDEVQ",102,0)
 ;%VOTH2 - optional - 2nd job - see %VOTH description above - usually not
"RTN","XUTMDEVQ",103,0)
 ;         needed - note: if %VOTH1("ZTDTH") is passed it will be ignored
"RTN","XUTMDEVQ",104,0)
 ;         as it is necessary to S ZTDTH="@" for the 2nd job - this will
"RTN","XUTMDEVQ",105,0)
 ;          create the task but not schedule it
"RTN","XUTMDEVQ",106,0)
 ;
"RTN","XUTMDEVQ",107,0)
 ;  return: if successfully queued, return ztsk1^ztsk2 where
"RTN","XUTMDEVQ",108,0)
 ;           ztsk1 = ZTSK value of 1st job, ztsk2 = ZTSK value of 2nd job
"RTN","XUTMDEVQ",109,0)
 ;         -1 if unsuccessful device call or failed %ztload call
"RTN","XUTMDEVQ",110,0)
 ;
"RTN","XUTMDEVQ",111,0)
 N ZTIO,ZTDTH,ZTSYNC,ZTCPU,ZTUCI,ZTSAVE,ZTSK,ZTPRI,ZTKIL,ZTDESC,%RET,POP
"RTN","XUTMDEVQ",112,0)
 N %VAR,%VOTH,%TMP S %RET=-1
"RTN","XUTMDEVQ",113,0)
 I $G(%RTN)=""!($G(%RTN2)="") G OUT
"RTN","XUTMDEVQ",114,0)
 ;  setup 2nd job to %ZIS
"RTN","XUTMDEVQ",115,0)
 S ZTRTN=%RTN2
"RTN","XUTMDEVQ",116,0)
 I $D(%VAR2) M %VAR=%VAR2
"RTN","XUTMDEVQ",117,0)
 I '$D(%VAR),$D(%VAR1) M %VAR=%VAR1
"RTN","XUTMDEVQ",118,0)
 I $D(%VOTH2) M %VOTH=%VOTH2
"RTN","XUTMDEVQ",119,0)
 I $G(%DESC2)]"" S ZTDESC=%DESC2
"RTN","XUTMDEVQ",120,0)
 I $D(%ZIS)=1,%ZIS="" S ZTIO=""
"RTN","XUTMDEVQ",121,0)
 E  D
"RTN","XUTMDEVQ",122,0)
 .I $D(IOP),IOP'?1"Q;".E S IOP="Q;"_IOP
"RTN","XUTMDEVQ",123,0)
 .I '$D(IOP) S IOP="Q"
"RTN","XUTMDEVQ",124,0)
 .Q
"RTN","XUTMDEVQ",125,0)
 D SETUP,ZIS:'$D(ZTIO) I $G(POP) G OUT
"RTN","XUTMDEVQ",126,0)
 S ZTDTH="@" D ZTLOAD
"RTN","XUTMDEVQ",127,0)
 K %VAR,%VOTH,%ZIS,IOP S %TMP=%RET
"RTN","XUTMDEVQ",128,0)
 S ZTRTN=%RTN
"RTN","XUTMDEVQ",129,0)
 I $D(%VAR1) M %VAR=%VAR1
"RTN","XUTMDEVQ",130,0)
 I $D(%VOTH1) M %VOTH=%VOTH1
"RTN","XUTMDEVQ",131,0)
 I $G(%DESC)]"" S ZTDESC=%DESC
"RTN","XUTMDEVQ",132,0)
 D SETUP S ZTIO="",%RET=-1 D ZTLOAD I %RET>0 S %RET=%RET_U_%TMP
"RTN","XUTMDEVQ",133,0)
 G OUT
"RTN","XUTMDEVQ",134,0)
 ;
"RTN","XUTMDEVQ",135,0)
SETUP ;  setup %ztload variables
"RTN","XUTMDEVQ",136,0)
 K ZTIO,ZTDTH,ZTSYNC,ZTCPU,ZTUCI,ZTSAVE,ZTPRI,ZTKIL,ZTSK,IO("Q") N I,X,Y
"RTN","XUTMDEVQ",137,0)
 I $D(%VAR)#2 F I=1:1:$L(%VAR,";") S X=$P(%VAR,";",I),ZTSAVE(X)=""
"RTN","XUTMDEVQ",138,0)
 S X="" F  S X=$O(%VAR(X)) Q:X=""  S ZTSAVE(X)=%VAR(X)
"RTN","XUTMDEVQ",139,0)
 I $D(%VOTH) F  S X=$O(%VOTH(X)) Q:X=""  S:$D(@X) @X=%VOTH(X)
"RTN","XUTMDEVQ",140,0)
 I '$D(ZTDESC) S ZTDESC=$TR($P(ZTRTN,"("),U,"~")
"RTN","XUTMDEVQ",141,0)
 Q
"RTN","XUTMDEVQ",142,0)
 ;
"RTN","XUTMDEVQ",143,0)
 ;
"RTN","XUTMDEVQ",144,0)
ZTLOAD2 K IO("Q"),ZTSK D ^%ZTLOAD,HOME^%ZIS S:$D(ZTSK) %RET=ZTSK Q
"RTN","XUTMK")
0^64^B30883527
"RTN","XUTMK",1,0)
XUTMK ;SEA/RDS - Taskman: Option, ZTMCLEAN/ZTMQCLEAN ;01/13/2004  16:39
"RTN","XUTMK",2,0)
 ;;8.0;KERNEL;**49,67,118,169,222,275**;Jul 10, 1995
"RTN","XUTMK",3,0)
 ;
"RTN","XUTMK",4,0)
SETUP ;Setup Variables And Synchronize ^%ZTSK With ^%ZTSCH
"RTN","XUTMK",5,0)
 S ZTDTH=0
"RTN","XUTMK",6,0)
 F  S ZTDTH=$O(^%ZTSCH(ZTDTH)) Q:'ZTDTH  F ZTS=0:0 S ZTS=$O(^%ZTSCH(ZTDTH,ZTS)) Q:'ZTS  D
"RTN","XUTMK",7,0)
 . L +^%ZTSK(ZTS):2 Q:'$T  K:$D(^%ZTSK(ZTS,0))[0 ^%ZTSK(ZTS),^%ZTSCH(ZTDTH,ZTS)
"RTN","XUTMK",8,0)
 . S:$D(^%ZTSK(ZTS,0))#2 $P(^(0),U,6)=$$H0^%ZTM(ZTDTH)
"RTN","XUTMK",9,0)
 . L -^%ZTSK(ZTS) Q
"RTN","XUTMK",10,0)
 I $D(ZTKEEP)#2 G SX
"RTN","XUTMK",11,0)
 S ZTKEEP="",ZTV=^%ZOSF("VOL"),ZTI=$O(^%ZIS(14.5,"B",ZTV,""))
"RTN","XUTMK",12,0)
 I ZTI]"",$D(^%ZIS(14.5,ZTI,0))#2 S ZTKEEP=$P(^(0),U,9)
"RTN","XUTMK",13,0)
SX S:ZTKEEP="" ZTKEEP=7 S ZTKEEP=$H-ZTKEEP,ZTCNT=0,ZTMAX=100,ZTS=.9
"RTN","XUTMK",14,0)
 ;
"RTN","XUTMK",15,0)
CLEAN ;Delete Obsolete Entries
"RTN","XUTMK",16,0)
 I '(ZTCNT#20),$$S^%ZTLOAD S ZTSTOP=1 Q
"RTN","XUTMK",17,0)
 S ZTS=$O(^%ZTSK(ZTS)) I 'ZTS G FINAL
"RTN","XUTMK",18,0)
 S ZTMAX=ZTS,ZTCNT=ZTCNT+1
"RTN","XUTMK",19,0)
 L +^%ZTSK(ZTS):0 I '$T G CLEAN
"RTN","XUTMK",20,0)
 I $D(^%ZTSK(ZTS,0))[0 K ^%ZTSK(ZTS) W:'$D(ZTQUEUED) "." G NEXT
"RTN","XUTMK",21,0)
 ;
"RTN","XUTMK",22,0)
1 ;keep active tasks
"RTN","XUTMK",23,0)
 I $D(^%ZTSCH("TASK",ZTS)) G NEXT
"RTN","XUTMK",24,0)
 S ZTREC=^%ZTSK(ZTS,0),ZTDTH=$P(ZTREC,U,6) I ZTDTH="" G 2
"RTN","XUTMK",25,0)
 S:ZTDTH'["," ZTDTH=$$H0^%ZTM(ZTDTH) S ZTDTH3=$$H3^%ZTM(ZTDTH)
"RTN","XUTMK",26,0)
 I $D(^%ZTSCH(ZTDTH3,ZTS)) G NEXT
"RTN","XUTMK",27,0)
 I $D(^%ZTSCH("JOB",ZTDTH3,ZTS)) G NEXT
"RTN","XUTMK",28,0)
 S ZTCNTPU=$P(ZTREC,U,14),ZTIO=$P($G(^%ZTSK(ZTS,.2)),U,2)
"RTN","XUTMK",29,0)
 I ZTCNTPU]"",$D(^%ZTSCH("LINK",ZTCNTPU,ZTDTH3,ZTS)) G NEXT
"RTN","XUTMK",30,0)
 I ZTIO]"",$D(^%ZTSCH("IO",ZTIO,ZTDTH3,ZTS)) G NEXT
"RTN","XUTMK",31,0)
 ;
"RTN","XUTMK",32,0)
2 ;keep young inactive tasks
"RTN","XUTMK",33,0)
 S Z1=$G(^%ZTSK(ZTS,.1))
"RTN","XUTMK",34,0)
 I Z1]"",$P(Z1,U,8),$H'>$P(Z1,U,8) G NEXT ;Remember Until
"RTN","XUTMK",35,0)
 S ZTF=$S($P(Z1,U)="":0,"135AG"[$P(Z1,U):0,1:$P(Z1,U,2)'<ZTKEEP) ;Last status update
"RTN","XUTMK",36,0)
 S ZTF=$S(ZTF:ZTF,ZTDTH="":0,1:ZTDTH'<+ZTKEEP) ;Run time
"RTN","XUTMK",37,0)
 S ZTF=$S(ZTF:ZTF,$P(ZTREC,U,5)="":0,1:$P(ZTREC,U,5)'<+ZTKEEP) ;creation date
"RTN","XUTMK",38,0)
 I ZTF G NEXT
"RTN","XUTMK",39,0)
 ;
"RTN","XUTMK",40,0)
3 ;delete old inactive tasks
"RTN","XUTMK",41,0)
 K ^%ZTSK(ZTS) W:'$D(ZTQUEUED) "."
"RTN","XUTMK",42,0)
 ;
"RTN","XUTMK",43,0)
NEXT L -^%ZTSK(ZTS)
"RTN","XUTMK",44,0)
 G CLEAN
"RTN","XUTMK",45,0)
 ;
"RTN","XUTMK",46,0)
FINAL ;Final Steps.
"RTN","XUTMK",47,0)
 L +^%ZTSK(-1) ;lock top
"RTN","XUTMK",48,0)
 S $P(^%ZTSK(0),"^",3,4)=ZTMAX_"^"_ZTCNT
"RTN","XUTMK",49,0)
 I ^%ZTSK(-1)>9000000 S ^%ZTSK(-1)=100
"RTN","XUTMK",50,0)
 L -^%ZTSK(-1)
"RTN","XUTMK",51,0)
 D CLIST,TASK,SUB,CLEARIO,MONITOR
"RTN","XUTMK",52,0)
 ;Call TM error purge
"RTN","XUTMK",53,0)
 S %=$$PURGE^XUTMKE(0,ZTKEEP,"")
"RTN","XUTMK",54,0)
 ;Clear bad time
"RTN","XUTMK",55,0)
 K ^%ZTSCH(0)
"RTN","XUTMK",56,0)
 K ZT,ZTDTH,ZTF,ZTI,ZTKEEP,ZTS,ZTV
"RTN","XUTMK",57,0)
 Q
"RTN","XUTMK",58,0)
 ;
"RTN","XUTMK",59,0)
CLIST ;Clean up the C list
"RTN","XUTMK",60,0)
 S ZT1=""
"RTN","XUTMK",61,0)
 F  S ZT1=$O(^%ZTSCH("C",ZT1)),ZT2="" Q:ZT1=""  F  S ZT2=$O(^%ZTSCH("C",ZT1,ZT2)),ZT3="" Q:ZT2=""  D
"RTN","XUTMK",62,0)
 . F  S ZT3=$O(^%ZTSCH("C",ZT1,ZT2,ZT3)) Q:ZT3=""  I $D(^%ZTSK(ZT3,0))[0 K ^%ZTSCH("C",ZT1,ZT2,ZT3)
"RTN","XUTMK",63,0)
 . Q
"RTN","XUTMK",64,0)
 Q
"RTN","XUTMK",65,0)
TASK ;Clean the TASK nodes.
"RTN","XUTMK",66,0)
 N ZT1,ZT2
"RTN","XUTMK",67,0)
 F ZT1=0:0 S ZT1=$O(^%ZTSCH("TASK",ZT1)) Q:ZT1'>0  D
"RTN","XUTMK",68,0)
 . L +^%ZTSCH("TASK",ZT1):0 Q:'$T
"RTN","XUTMK",69,0)
 . S ZT2=$G(^%ZTSCH("TASK",ZT1)),$P(ZT2,U,5)=$G(^(ZT1,1))
"RTN","XUTMK",70,0)
 . L -^%ZTSCH("TASK",ZT1)
"RTN","XUTMK",71,0)
 . I ZT2="^^^^" K ^%ZTSCH("TASK",ZT1) Q
"RTN","XUTMK",72,0)
 . I $D(^%ZTSCH("TASK",ZT1,"P")) Q  ;Persistent tasks
"RTN","XUTMK",73,0)
 . I "^XMAD^"[(U_$E($P(ZT2,U,2),1,4)_U) Q
"RTN","XUTMK",74,0)
 . I $H-$P(ZT2,U,5)>4  K ^%ZTSCH("TASK",ZT1)
"RTN","XUTMK",75,0)
 . Q
"RTN","XUTMK",76,0)
 Q
"RTN","XUTMK",77,0)
 ;
"RTN","XUTMK",78,0)
SUB ;Sync the SUB nodes
"RTN","XUTMK",79,0)
 D SUBCHK^%ZTMS5
"RTN","XUTMK",80,0)
 Q
"RTN","XUTMK",81,0)
CLEARIO ;Clear any empty IO lists
"RTN","XUTMK",82,0)
 L +^%ZTSCH("IO"):2 Q:'$T
"RTN","XUTMK",83,0)
 S ^%ZTSCH("WAIT","MGR")="XUTMK",^%ZTSCH("WAIT","SUB")="XUTMK"
"RTN","XUTMK",84,0)
 L -^%ZTSCH("IO")
"RTN","XUTMK",85,0)
 N %ZTIO,%ZTPAIR S %ZTIO="" H 10 ;Let jobs see flag
"RTN","XUTMK",86,0)
 F  S %ZTIO=$O(^%ZTSCH("IO",%ZTIO)) Q:%ZTIO=""  D
"RTN","XUTMK",87,0)
 . I $D(^%ZTSCH("IO",%ZTIO))=1 D
"RTN","XUTMK",88,0)
 . . K ^%ZTSCH("DEVTRY",%ZTIO)
"RTN","XUTMK",89,0)
 . . I $G(^%ZTSCH("IO",%ZTIO))="RES" Q  ;Leave Resource devices
"RTN","XUTMK",90,0)
 . . K ^%ZTSCH("IO",%ZTIO)
"RTN","XUTMK",91,0)
 . Q
"RTN","XUTMK",92,0)
 ;Now Clear and empty "C" lists
"RTN","XUTMK",93,0)
 S %ZTPAIR=""
"RTN","XUTMK",94,0)
 F  S %ZTPAIR=$O(^%ZTSCH("C",%ZTPAIR)) Q:%ZTPAIR=""  D
"RTN","XUTMK",95,0)
 . I $O(^%ZTSCH("C",%ZTPAIR,0))="" K ^%ZTSCH("C",%ZTPAIR)
"RTN","XUTMK",96,0)
 . Q
"RTN","XUTMK",97,0)
 K ^%ZTSCH("WAIT","MGR"),^%ZTSCH("WAIT","SUB")
"RTN","XUTMK",98,0)
 Q
"RTN","XUTMK",99,0)
 ;
"RTN","XUTMK",100,0)
MONITOR ;Move any Monitor data,
"RTN","XUTMK",101,0)
 N ZT1,ZT2,ZR,ZR2,IEN,ZFDA,X
"RTN","XUTMK",102,0)
 S ZT1="",IEN=0,ZR=$NA(^%ZTSCH("MON"))
"RTN","XUTMK",103,0)
 F  S ZT1=$O(@ZR@(ZT1)),ZT2=0 Q:ZT1=""  D
"RTN","XUTMK",104,0)
 . F  S ZT2=$O(@ZR@(ZT1,ZT2)) Q:ZT2=""  D
"RTN","XUTMK",105,0)
 . . S IEN=IEN+1,ZR2=$NA(ZFDA(14.71,"+"_IEN_","))
"RTN","XUTMK",106,0)
 . . S Y=@ZR@(ZT1,ZT2)
"RTN","XUTMK",107,0)
 . . S @ZR2@(.01)=$$HTFM^XLFDT(ZT2),@ZR2@(2)=ZT1
"RTN","XUTMK",108,0)
 . . F I=3:1:26 S @ZR2@(I)=$P(Y,U,I-2)
"RTN","XUTMK",109,0)
 . . D UPDATE^DIE("","ZFDA")
"RTN","XUTMK",110,0)
 . . K @ZR@(ZT1,ZT2),ZFDA ;Clear Global and Local.
"RTN","XUTMK",111,0)
 . . Q
"RTN","XUTMK",112,0)
 . Q
"RTN","XUTMK",113,0)
 Q
"RTN","XUTMK",114,0)
 ;
"RTN","XUTMK",115,0)
OPTION ;Entry Point For ZTMCLEAN Option
"RTN","XUTMK",116,0)
 W !!,"This option queues a task to clean up the Task file."
"RTN","XUTMK",117,0)
 W !,"All tasks that have been inactive for a certain number of days are deleted.",!
"RTN","XUTMK",118,0)
 ;
"RTN","XUTMK",119,0)
ZTKEEP ;ask user how long to keep inactive tasks
"RTN","XUTMK",120,0)
 S DIR(0)="NA^0:365",DIR("A")="Number of days to save inactive tasks: ",DIR("B")=""
"RTN","XUTMK",121,0)
 S ZTV=^%ZOSF("VOL"),ZTI=$O(^%ZIS(14.5,"B",ZTV,""))
"RTN","XUTMK",122,0)
 I ZTI]"",$D(^%ZIS(14.5,ZTI,0))#2 S DIR("B")=$P(^(0),U,9)
"RTN","XUTMK",123,0)
 I DIR("B")="" S DIR("B")=7
"RTN","XUTMK",124,0)
 S DIR("?")="     Answer must be an integer between 0 and 365",DIR("??")="^D HELP1^XUTMK"
"RTN","XUTMK",125,0)
 D ^DIR W:$D(DTOUT) $C(7)
"RTN","XUTMK",126,0)
 K DIR,DIRUT,DTOUT,DUOUT,ZTI,ZTV
"RTN","XUTMK",127,0)
 I Y'=0&'Y K %,X,Y D NOTQED Q
"RTN","XUTMK",128,0)
 S ZTKEEP=Y
"RTN","XUTMK",129,0)
 ;
"RTN","XUTMK",130,0)
ZTDTH ;ask user when to start the cleanup
"RTN","XUTMK",131,0)
 S DIR(0)="DA^::AERSX",DIR("A")="Start time for cleanup task: ",DIR("B")="NOW"
"RTN","XUTMK",132,0)
 S DIR("?")="     Answer must be a date and time",DIR("??")="^D HELP2^XUTMK"
"RTN","XUTMK",133,0)
 D ^DIR W:$D(DTOUT) $C(7)
"RTN","XUTMK",134,0)
 K DIR,DIRUT,DTOUT,DUOUT
"RTN","XUTMK",135,0)
 I 'Y K %,X,Y D NOTQED Q
"RTN","XUTMK",136,0)
 S ZTDTH=Y
"RTN","XUTMK",137,0)
 ;
"RTN","XUTMK",138,0)
QUEUE ;queue the cleanup task
"RTN","XUTMK",139,0)
 S ZTRTN="XUTMK",ZTIO="",ZTDESC="TaskMan: clean the Task file",ZTSAVE("ZTKEEP")=""
"RTN","XUTMK",140,0)
 D ^%ZTLOAD
"RTN","XUTMK",141,0)
 W !!?5,"Task file cleanup queued!" H 1
"RTN","XUTMK",142,0)
 K ZTSK Q
"RTN","XUTMK",143,0)
 ;
"RTN","XUTMK",144,0)
HELP1 ;ZTKEEP--?? help for first prompt
"RTN","XUTMK",145,0)
 W !!?5,"Answer how many days inactive tasks should be kept."
"RTN","XUTMK",146,0)
 W !?5,"Any task currently scheduled, waiting, or running is still active."
"RTN","XUTMK",147,0)
 Q
"RTN","XUTMK",148,0)
 ;
"RTN","XUTMK",149,0)
HELP2 ;ZTDTH--?? help for second prompt
"RTN","XUTMK",150,0)
 W !!?5,"Answer exactly when the task should begin the cleanup."
"RTN","XUTMK",151,0)
 Q
"RTN","XUTMK",152,0)
 ;
"RTN","XUTMK",153,0)
NOTQED ;OPTION--feedback when task is canceled
"RTN","XUTMK",154,0)
 W !!?5,"Task file cleanup NOT queued!" H 1
"RTN","XUTMK",155,0)
 Q
"RTN","XUTMK",156,0)
 ;
"RTN","ZFOO")
0^28^B288700
"RTN","ZFOO",1,0)
ZFOO ;ISF/RWF - GTM Routine to invoke an arbitrary entry point ;5/9/2002
"RTN","ZFOO",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","ZFOO",3,0)
 ;To run under VMS,
"RTN","ZFOO",4,0)
 ;  mumps ZFOO.M
"RTN","ZFOO",5,0)
 ;  link ZFOO.OBJ
"RTN","ZFOO",6,0)
 ;  In a com file
"RTN","ZFOO",7,0)
 ;  $ forfoo="$" + f$parse("user$:[gtmmgr.r]ZFOO.exe")
"RTN","ZFOO",8,0)
 ;  $ forfoo "argument"
"RTN","ZFOO",9,0)
 ;To run under Linux
"RTN","ZFOO",10,0)
 ;  mumps ZFOO.m
"RTN","ZFOO",11,0)
 ;  chmod u+x,g+x ZFOO.o
"RTN","ZFOO",12,0)
 ;  In shell script
"RTN","ZFOO",13,0)
 ;  $gtm_dist/mumps -run ZFOO "argument"
"RTN","ZFOO",14,0)
 ;
"RTN","ZFOO",15,0)
 ;Set the interupt
"RTN","ZFOO",16,0)
 S $ETRAP="D ^%ZTER HALT",$ZINTERRUPT="I $$JOBEXAM^ZU($ZPOSITION)"
"RTN","ZFOO",17,0)
 I $L($ZCMDLINE) D @$ZCMDLINE Q
"RTN","ZFOO",18,0)
 Q
"RTN","ZIS")
0^30^B16647233
"RTN","ZIS",1,0)
%ZIS ;SFISC/AC,RWF -- DEVICE HANDLER ;07/18/2002  07:53
"RTN","ZIS",2,0)
 ;;8.0;KERNEL;**18,23,69,112,199,191,275**;JUL 10, 1995
"RTN","ZIS",3,0)
 N %ZISOS,%ZISV
"RTN","ZIS",4,0)
 S U="^",%ZISOS=$G(^%ZOSF("OS")),%ZISV=$G(^%ZOSF("VOL"))
"RTN","ZIS",5,0)
 ;Check SPOOLER special case first
"RTN","ZIS",6,0)
INIT I $D(ZTQUEUED),$G(IOT)="SPL",$D(IO)#2,$D(IO(0))#2,IO]"",IO=IO(0),$D(IO(1,IO))#2,%ZISOS["VAX DSM"!(%ZISOS["M/VX"),$G(IOP)[ION!(IOP[IO) K %ZIS,%IS,IOP Q
"RTN","ZIS",7,0)
 ;
"RTN","ZIS",8,0)
 I '$D(%ZIS),$D(%IS) M %ZIS=%IS
"RTN","ZIS",9,0)
 S:$D(%ZIS)[0 %ZIS="M" M %IS=%ZIS ;update %IS for now
"RTN","ZIS",10,0)
 ;
"RTN","ZIS",11,0)
 I $D(ZTQUEUED) D  I '$D(IOP) S POP=1 G EXIT^%ZIS1
"RTN","ZIS",12,0)
 .I $D(ZTIO)#2,ZTIO="" S:%IS'[0 %IS=%IS_"0",%ZIS=%ZIS_"0"
"RTN","ZIS",13,0)
 I '$D(ZTQUEUED),%IS["T",$P($G(IOP),";")="Q" S POP=1 G EXIT^%ZIS1
"RTN","ZIS",14,0)
 N %,%A,%E,%H,%I,%X,%Y,%Z,%Z1,%Z9,%Z90,%Z91,%Z95,%ZISB,%ZTIME,%ZTYPE,%ZISOLD,DTOUT,DUOUT
"RTN","ZIS",15,0)
 ;Save symbols to restore if don't open a device
"RTN","ZIS",16,0)
 D SYMBOL^%ZISUTL(0,$NA(%ZISOLD))
"RTN","ZIS",17,0)
 K IO("CLOSE"),IO("HFSIO"),IO("T")
"RTN","ZIS",18,0)
A K IO("P"),IO("Q"),IO("S"),IO("DOC"),IO("HFSIO")
"RTN","ZIS",19,0)
K2 D K2^%ZIS1
"RTN","ZIS",20,0)
 S %ZISB=%ZIS'["N",(%E,%H,POP)=0,%Y="" S:'$D(IO(0)) IO(0)=$I
"RTN","ZIS",21,0)
 I %ZISOS["VAX DSM",$I["SYS$INPUT:.;" S:%ZIS'[0 %IS=%IS_"0",%ZIS=%ZIS_"0"
"RTN","ZIS",22,0)
 ;I %IS["T"&(%IS["0") S (%H,%E)=0 G ^%ZIS1
"RTN","ZIS",23,0)
 I $D(IOP),IOP=$I!(IOP="HOME")!(0[IOP),$D(^XUTL("XQ",$J,"IO")) D HOME K %IS,%Y,%ZIS,%ZISB,%ZISV,IOP Q
"RTN","ZIS",24,0)
 ;Don't worry about HOME if %ZIS[0
"RTN","ZIS",25,0)
 D:%ZIS'[0 GETHOME G EXIT^%ZIS1:POP,^%ZIS1 ;Jump to next part
"RTN","ZIS",26,0)
 ;
"RTN","ZIS",27,0)
GETHOME I $D(IO("HOME")),$P(IO("HOME"),"^",2)=IO(0) S (%E,%H)=+IO("HOME") Q
"RTN","ZIS",28,0)
 I $D(^XUTL("XQ",$J,"IOS")),$D(^("IO")),IO(0)=^("IO") S (%E,%H)=^("IOS") Q
"RTN","ZIS",29,0)
 ;CALL LINEPORT CODE HERE---
"RTN","ZIS",30,0)
 S %=$$LINEPORT^%ZISUTL I % S (%E,%H)=% Q
"RTN","ZIS",31,0)
 S %ZISVT=$I D VTLKUP I '%E S %ZISVT=$I D VIRTUAL
"RTN","ZIS",32,0)
 I %ZISVT=""!(%E'>0) I %IS'[0 O IO(0)::0 I $T U IO(0) W !,"HOME DEVICE DOES NOT EXIST IN THE DEVICE FILE",!,"PLEASE CONTACT YOUR SYSTEM MANAGER!",*7
"RTN","ZIS",33,0)
 S %H=%E S:'%H&(%IS'[0) POP=1 S:(%H>0)&('$D(IO("HOME"))) IO("HOME")=%H_"^"_$I
"RTN","ZIS",34,0)
 Q
"RTN","ZIS",35,0)
VIRTUAL ;See if a Virtual Terminal (LAT, TELNET)
"RTN","ZIS",36,0)
 ;Change the MSM check for telnet to work with v4.4
"RTN","ZIS",37,0)
 I %ZISOS["MSM" X "I $P($ZV,""Version "",2)'<3 S %ZISVT=$ZDE(+%ZISVT) I %ZISVT?.E1""~""4.5N.E S %ZISVT=""TELNET"""
"RTN","ZIS",38,0)
 F %ZISI=$L(%ZISVT):-1 D:$D(^%ZIS(1,"C",%ZISVT))  Q:$S('%E:0,'$D(^%ZIS(1,%E,"TYPE")):0,^("TYPE")="VTRM":1,1:0)  S %ZISVT=$E(%ZISVT,1,%ZISI) Q:%ZISVT=""
"RTN","ZIS",39,0)
 .D VTLKUP Q:$S('%E:0,'$D(^%ZIS(1,%E,"TYPE")):0,^("TYPE")="VTRM":1,1:0)
"RTN","ZIS",40,0)
 .S %X=0 F %ZISX=%ZISV,"" Q:%X>0  S %X=0 F  S %E=+$O(^%ZIS(1,"CPU",%ZISX_"."_%ZISVT,%X)) S %X=%E Q:%E'>0  I $G(^%ZIS(1,+%E,"TYPE"))="VTRM" Q
"RTN","ZIS",41,0)
 Q
"RTN","ZIS",42,0)
VTLKUP F %ZISX=%ZISV,"" S %E=+$O(^%ZIS(1,"G","SYS."_%ZISX_"."_%ZISVT,0)) Q:%E  S %E=+$O(^%ZIS(1,"CPU",%ZISX_"."_%ZISVT,0)) Q:%E
"RTN","ZIS",43,0)
 Q
"RTN","ZIS",44,0)
 ;
"RTN","ZIS",45,0)
CURRENT N POP,%ZIS,%IS,%E,%H
"RTN","ZIS",46,0)
 S FF="#",SL=24,BS="*8",RM=80,(SUB,XY)="",%IS=0,%ZISOS=$G(^%ZOSF("OS")),%ZISV=$G(^("VOL")),POP=0
"RTN","ZIS",47,0)
 D GETHOME K %E,%IS,%ZISI,%ZISOS,%ZISV,%ZISVT,%ZISX Q:POP
"RTN","ZIS",48,0)
 I $D(^%ZIS(1,%H,"SUBTYPE")) S SUB=+^("SUBTYPE") K %H
"RTN","ZIS",49,0)
 I $D(SUB),SUB,$D(^%ZIS(2,SUB,1)) S SUB=$S($D(^(0)):$P(^(0),"^"),1:""),FF=$P(^(1),"^",2),SL=$P(^(1),"^",3),BS=$P(^(1),"^",4),XY=$P(^(1),"^",5),RM=+^(1)
"RTN","ZIS",50,0)
 E  S SUB=""
"RTN","ZIS",51,0)
 I $D(^%ZOSF("RM")) N X S X=RM X ^("RM") K %A
"RTN","ZIS",52,0)
 Q
"RTN","ZIS",53,0)
HOME ;Entry point to establish IO* variables for home device.
"RTN","ZIS",54,0)
 N X I '$D(^XUTL("XQ",$J,"IO")) S IOP="HOME" D ^%ZIS Q
"RTN","ZIS",55,0)
 D RESETVAR
"RTN","ZIS",56,0)
 I '$D(IO("C")),$D(IOM),IO=$I,$D(IO(1,IO)),$D(^%ZOSF("RM")) S X=+IOM X ^("RM") Q
"RTN","ZIS",57,0)
 Q
"RTN","ZIS",58,0)
RESETVAR ;Reset home IO* variables.
"RTN","ZIS",59,0)
 I '$D(^XUTL("XQ",$J,"IO")) Q
"RTN","ZIS",60,0)
 N % F %="IO","IOBS","IOF","IOM","ION","IOS","IOSL","IOST","IOST(0)","IOT","IOXY" I $D(^XUTL("XQ",$J,%))#2 S @%=^(%)
"RTN","ZIS",61,0)
 S POP=0,IO(0)=IO,(IOPAR,IOUPAR)=""
"RTN","ZIS",62,0)
 Q
"RTN","ZIS",63,0)
SAVEVAR ;Save home IO* variables, called from XUS1
"RTN","ZIS",64,0)
 N % F %="IO","IOBS","IOF","IOM","ION","IOS","IOSL","IOST","IOST(0)","IOT","IOXY" I $D(@%) S ^XUTL("XQ",$J,%)=@%
"RTN","ZIS",65,0)
 Q
"RTN","ZIS",66,0)
ZISLPC Q  ;No longer called in Kernel v8.
"RTN","ZIS",67,0)
 ;
"RTN","ZIS",68,0)
HLP1 G EN1^%ZIS7
"RTN","ZIS",69,0)
HLP2 N %E,%H,%X,%ZISV,X S %ZISV=$S($D(^%ZOSF("VOL")):^("VOL"),1:"") G EN2^%ZIS7
"RTN","ZIS",70,0)
 ;
"RTN","ZIS",71,0)
REWIND(IO2,IOT,IOPAR) ;Rewind Device
"RTN","ZIS",72,0)
 N %,X,Y,$ES,$ET S $ET="D REWERR^%ZIS Q 0"
"RTN","ZIS",73,0)
 S %=$I
"RTN","ZIS",74,0)
 I '($D(IO2)#2)!'$D(IOT)!'$D(IOPAR) Q 0
"RTN","ZIS",75,0)
 I "MT^SDP^HFS"'[IOT Q 0
"RTN","ZIS",76,0)
 S @("Y=$$REW"_IOT_"^%ZIS4(IO2,IOPAR)")
"RTN","ZIS",77,0)
 U %
"RTN","ZIS",78,0)
 Q Y
"RTN","ZIS",79,0)
REWERR ;Error encountered
"RTN","ZIS",80,0)
 S IO("ERROR")=$EC
"RTN","ZIS",81,0)
 S $EC="",$ET="Q:$ES>1  S $EC="""" Q 0" S $EC=",U1,"
"RTN","ZIS",82,0)
 Q 0
"RTN","ZIS",83,0)
 ;
"RTN","ZIS4GTM")
0^11^B17859253
"RTN","ZIS4GTM",1,0)
%ZIS4 ;SFISC/AC,RWF,MVB - DEVICE HANDLER SPECIFIC CODE (GT.M 4.3 for Unix/VMS) ;29 Jan 2003 2:59 pm
"RTN","ZIS4GTM",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995;
"RTN","ZIS4GTM",3,0)
 ;
"RTN","ZIS4GTM",4,0)
OPEN G OPN2:$D(IO(1,IO))
"RTN","ZIS4GTM",5,0)
 S POP=0 D OP1 G NOPEN:'$D(IO(1,IO))
"RTN","ZIS4GTM",6,0)
OPN2 I $D(%ZISHP),'$D(IOP) W !,*7," Routing to device "_$P(^%ZIS(1,%E,0),"^",1)_$S($D(^(1)):" "_$P(^(1),"^",1)_" ",1:"")
"RTN","ZIS4GTM",7,0)
 Q
"RTN","ZIS4GTM",8,0)
NOPEN I %IS'["D",$D(%ZISHP)!(%ZISHG]"") S POP=1 Q
"RTN","ZIS4GTM",9,0)
 I '$D(IOP) W *7,"  [BUSY]" W "  ...  RETRY" S %=2,U="^" D YN^%ZIS1 G OPEN:%=1
"RTN","ZIS4GTM",10,0)
 S POP=1 Q
"RTN","ZIS4GTM",11,0)
 Q
"RTN","ZIS4GTM",12,0)
OP1 S X="OPNERR^%ZIS4",@^%ZOSF("TRAP"),$ZE=""
"RTN","ZIS4GTM",13,0)
 L:$D(%ZISLOCK) +@%ZISLOCK:60
"RTN","ZIS4GTM",14,0)
 O IO::%ZISTO S:$T IO(1,IO)="" S:'$T POP=1 L:$D(%ZISLOCK) -@%ZISLOCK
"RTN","ZIS4GTM",15,0)
 Q
"RTN","ZIS4GTM",16,0)
OPNERR S POP=1,IO("LASTERR")=$G(IO("ERROR")),IO("ERROR")=$$EC^%ZOSV,$EC="" Q
"RTN","ZIS4GTM",17,0)
 ;
"RTN","ZIS4GTM",18,0)
O D:%IS["L" ZIO
"RTN","ZIS4GTM",19,0)
LCKGBL ;Lock Global
"RTN","ZIS4GTM",20,0)
 I %ZTYPE="CHAN" N % S %=$G(^%ZIS(1,+%E,"GBL")) I $L(%) L @("+^"_%_":0") S:'$T POP=1 I POP W:'$D(IOP) !,?5,*7,"[DEVICE IS BUSY]" Q
"RTN","ZIS4GTM",21,0)
 I $D(IO("S")),$D(^%ZIS(2,IO("S"),10)),^(10)]"" U IO(0) D X10^ZISX
"RTN","ZIS4GTM",22,0)
OPAR I $D(IOP),%ZTYPE="HFS",$D(%IS("HFSIO")),$D(%IS("IOPAR")),%IS("HFSIO")]"" S IO=%IS("HFSIO"),%ZISOPAR=%IS("IOPAR")
"RTN","ZIS4GTM",23,0)
 I %ZTYPE="CHAN",IO["::""TASK="!(IO["SYS$NET") D ODECNET Q:POP  G OXECUTE^%ZIS6
"RTN","ZIS4GTM",24,0)
 S %A=%ZISOPAR_$S(%ZISOPAR["):":"",%ZTYPE["CHAN"&($P(%ZTIME,"^",3)="n"):"",1:":"_%ZISTO)
"RTN","ZIS4GTM",25,0)
 N % S %(IO)="",%=$P($P($NA(%(IO)),"(",2),")")
"RTN","ZIS4GTM",26,0)
 S %A=%_$E(":",%A]"")_%A
"RTN","ZIS4GTM",27,0)
 D O1 I POP D  Q
"RTN","ZIS4GTM",28,0)
 .I %ZTYPE="HFS",'$D(IOP),$G(IO("ERROR"))["file not found" W !,?5,*7,"[File Not Found]" Q
"RTN","ZIS4GTM",29,0)
 .W:'$D(IOP) !,?5,*7,"[DEVICE IS BUSY]" Q
"RTN","ZIS4GTM",30,0)
 ;S IO(1,IO)="" U IO S:'(IO=IO(0)&'$D(IO("S"))&'$D(ZTQUEUED)) $X=0,$Y=0 I %ZTYPE["TRM" U IO:(WIDTH=+%Z91)
"RTN","ZIS4GTM",31,0)
 U IO S $X=0,$Y=0 I %ZTYPE["TRM" U IO:(WIDTH=+%Z91)
"RTN","ZIS4GTM",32,0)
 I %ZISUPAR]"" S %A1=""""_IO_""":"_%ZISUPAR U @%A1
"RTN","ZIS4GTM",33,0)
 ;U:%IS'[0 IO(0)
"RTN","ZIS4GTM",34,0)
 G OXECUTE^%ZIS6
"RTN","ZIS4GTM",35,0)
 ;
"RTN","ZIS4GTM",36,0)
O1 N $ES,$ET S $ET="G OPNERR^%ZIS4"
"RTN","ZIS4GTM",37,0)
 L:$D(%ZISLOCK) +@%ZISLOCK:60
"RTN","ZIS4GTM",38,0)
 O @%A S:'$T&(%A?.E1":".N) POP=1 S:'POP IO(1,IO)="" L:$D(%ZISLOCK) -@%ZISLOCK
"RTN","ZIS4GTM",39,0)
 S IO("ERROR")="" Q
"RTN","ZIS4GTM",40,0)
 ;
"RTN","ZIS4GTM",41,0)
 ;Need to find out how to get IP address
"RTN","ZIS4GTM",42,0)
ZIO N %,%1 S (%,%1)=$ZIO
"RTN","ZIS4GTM",43,0)
 I $ZV["VMS",%["_TNA" D
"RTN","ZIS4GTM",44,0)
 . S (%,%1)=$ZGETDVI($I,"TT_ACCPORNAM")
"RTN","ZIS4GTM",45,0)
 . S %=$S(%["Host:":$P($P(%,"Host: ",2)," ")_":"_$P(%,"Port: ",2),1:%) S:%[" " %=$TR(%," ")
"RTN","ZIS4GTM",46,0)
 I $ZV'["VMS" D
"RTN","ZIS4GTM",47,0)
 . S (%,%1)=$ZTRNLNM("REMOTEHOST") S:$L(%) %1="Host:"_% S:'$L(%) %=$ZIO
"RTN","ZIS4GTM",48,0)
 S IO("ZIO")=% S:(%1["Host:")&'$D(IO("IP")) IO("IP")=$P(%,":")
"RTN","ZIS4GTM",49,0)
 Q
"RTN","ZIS4GTM",50,0)
 ;
"RTN","ZIS4GTM",51,0)
ODECNET Q  ; fill me in later
"RTN","ZIS4GTM",52,0)
SPOOL ;%ZDA=pointer to ^XMB(3.51, %ZFN=spool file name.
"RTN","ZIS4GTM",53,0)
 I $D(ZISDA) W:'$D(IOP) !?5,*7,"You may not Spool the printing of a Spool document" G N
"RTN","ZIS4GTM",54,0)
 I $D(DUZ)[0 W:'$D(IOP) !,"Must be a valid user." G N
"RTN","ZIS4GTM",55,0)
R S %ZY=-1 D NEWDOC^ZISPL1 G N:%ZY'>0 S %ZDA=+%ZY,%ZFN=$P(%ZY(0),U,2),IO("DOC")=$P(%ZY(0),U,1) G OK:$D(IO("Q"))
"RTN","ZIS4GTM",56,0)
 G:'%ZISB OK I '$P(%ZY,"^",3),%ZFN]"" D SPL3 G N:%ZFN']"",DOC
"RTN","ZIS4GTM",57,0)
 S %ZFN=IO_"SPOOL_no_"_%ZDA_".TMP" D SPL2 G:%ZFN']"" N S $P(^XMB(3.51,%ZDA,0),U,2)=%ZFN,^XMB(3.51,"C",%ZFN,%ZDA)=""
"RTN","ZIS4GTM",58,0)
DOC S IO=%ZFN,IO("SPOOL")=%ZDA,^XUTL("XQ",$J,"SPOOL")=%ZDA,IOF="#"
"RTN","ZIS4GTM",59,0)
 I $D(^%ZIS(1,%ZISIOS,1)),$P(^(1),"^",8),$O(^("SPL",0)) S ^XUTL("XQ",$J,"ADSPL")=%ZISIOS,ZISPLAD=%ZISIOS
"RTN","ZIS4GTM",60,0)
OK K %ZDA,%ZFN Q
"RTN","ZIS4GTM",61,0)
N K %ZDA,%ZFN,IO("DOC") S POP=1 Q
"RTN","ZIS4GTM",62,0)
SPL2 O %ZFN:(NEWVERSION:WORLD=RWD) G:$ZA<0 SPL4 S IO(1,%ZFN)="" Q
"RTN","ZIS4GTM",63,0)
SPL3 N X S X="SPL4^%ZIS4",@^%ZOSF("TRAP")
"RTN","ZIS4GTM",64,0)
 O %ZFN:READONLY:1 S:'$T ZISPLQ=1 G:$ZA<0!('$T) SPL4 S IO(1,%ZFN)="" Q
"RTN","ZIS4GTM",65,0)
SPL4 W:'$D(IOP)&'$D(ZTQUEUED) !?5,*7,"Couldn't open the spool file." S %ZFN="" Q
"RTN","ZIS4GTM",66,0)
CLOSE N %Z1 C:IO]"" IO K:IO]"" IO(1,IO) D FILE^ZISPL1 I %ZDA'>0 K ZISPLAD Q
"RTN","ZIS4GTM",67,0)
 S %ZFN=$P(%ZS,"^",2) D SPL3 Q:%ZFN']""  U %ZFN S %ZCR=$C(13),%Y="",X="SPLEOF^%ZIS4",@^%ZOSF("TRAP")
"RTN","ZIS4GTM",68,0)
 S %Z1=+$G(^XTV(8989.3,1,"SPL"))
"RTN","ZIS4GTM",69,0)
 F %=0:0 R %X#255:5 Q:$ZA<0  S %2=%X D CL2 G:%Z1<% SPLEX
"RTN","ZIS4GTM",70,0)
SPLEOF I $ZE'["ENDO" Q  ;Send error up
"RTN","ZIS4GTM",71,0)
SPLEX C %ZFN:(DELETE) K:%ZFN]"" IO(1,%ZFN) D CLOSE^ZISPL1 K %Y,%X,%1,%ZFN Q
"RTN","ZIS4GTM",72,0)
 ;
"RTN","ZIS4GTM",73,0)
CL2 S %=%+1 I %Z1<% S ^XMBS(3.519,XS,2,%,0)="*** INCOMPLETE REPORT  -- SPOOL DOCUMENT LINE LIMIT EXCEEDED ***",$P(^XMB(3.51,%ZDA,0),"^",11)=1 Q
"RTN","ZIS4GTM",74,0)
 I %2[$C(12) S ^XMBS(3.519,XS,2,%,0)="|TOP|" Q
"RTN","ZIS4GTM",75,0)
 S ^XMBS(3.519,XS,2,%,0)=%2 Q
"RTN","ZIS4GTM",76,0)
 ;
"RTN","ZIS4GTM",77,0)
HFS G HFS^%ZISF
"RTN","ZIS4GTM",78,0)
REWMT(IO,IOPAR) ;Rewind Magtape
"RTN","ZIS4GTM",79,0)
 S X="REWERR^%ZIS4",@^%ZOSF("TRAP")
"RTN","ZIS4GTM",80,0)
 U IO W *5
"RTN","ZIS4GTM",81,0)
 Q 1
"RTN","ZIS4GTM",82,0)
REWSDP(IO,IOPAR) ;Rewind SDP
"RTN","ZIS4GTM",83,0)
 G REW1
"RTN","ZIS4GTM",84,0)
REWHFS(IO,IOPAR) ;Rewind Host File.
"RTN","ZIS4GTM",85,0)
REW1 S X="REWERR^%ZIS4",@^%ZOSF("TRAP")
"RTN","ZIS4GTM",86,0)
 U IO:(REWIND)
"RTN","ZIS4GTM",87,0)
 Q 1
"RTN","ZIS4GTM",88,0)
REWERR ;Error encountered
"RTN","ZIS4GTM",89,0)
 Q 0
"RTN","ZISC")
0^39^B22304846
"RTN","ZISC",1,0)
%ZISC ;SFISC/GFT,AC,MUS - CLOSE LOGIC FOR DEVICES  ;01/14/2002  09:06
"RTN","ZISC",2,0)
 ;;8.0;KERNEL;**24,36,49,69,199,216,275**;JUL 10, 1995
"RTN","ZISC",3,0)
C0 ;
"RTN","ZISC",4,0)
 N %,%ZISOS,%ZISV
"RTN","ZISC",5,0)
 ;Clear IO var we will use for reporting
"RTN","ZISC",6,0)
 K IO("ERROR"),IO("LASTERR"),IO("CLOSE")
"RTN","ZISC",7,0)
 ;Protect ourself from calls with incomplete setup.
"RTN","ZISC",8,0)
 S:$D(IO)[0 IO=$I S:'$D(IO(0)) IO(0)=$P
"RTN","ZISC",9,0)
 S U="^",%ZISOS=$G(^%ZOSF("OS")),%ZISV=$G(^("VOL"))
"RTN","ZISC",10,0)
 S %=$S(+$G(IOS):IOS,$L($G(ION)):ION,1:IO)
"RTN","ZISC",11,0)
 I (%="")!(IO="") G SETIO:IO(0)]"" G END
"RTN","ZISC",12,0)
 I $G(IOT)="RES" D RES G SETIO ;Handle a resource device
"RTN","ZISC",13,0)
 ;
"RTN","ZISC",14,0)
 ;Define subtype info if not already defined.
"RTN","ZISC",15,0)
 D SUBTYPE
"RTN","ZISC",16,0)
 ;
"RTN","ZISC",17,0)
 I $G(IOST(0))>0 D
"RTN","ZISC",18,0)
 . I $G(^%ZIS(2,+IOST(0),3))]"",$D(IO(1,IO)) D
"RTN","ZISC",19,0)
 . . U IO S:$X $X=1 D X3^ZISX:'$D(IO("T")) ;perform close execute
"RTN","ZISC",20,0)
 ;
"RTN","ZISC",21,0)
 I $D(IO(1,IO)) D  ;Perform the following if the device is open.
"RTN","ZISC",22,0)
 . I $G(IO("P"))["B" D  ;Return to normal intensity
"RTN","ZISC",23,0)
 . . S %=$P($G(^%ZIS(2,+IOST(0),7)),"^",3) I %]"" W @%
"RTN","ZISC",24,0)
 . I $G(IO("P"))["P" D  ;Return to default pitch
"RTN","ZISC",25,0)
 . . S %=$G(^%ZIS(2,+IOST(0),12.11)) I %]"" W @%
"RTN","ZISC",26,0)
 . ;
"RTN","ZISC",27,0)
 . W:$$FF @IOF ;form feed issued at close
"RTN","ZISC",28,0)
 . I $$CLOSPP D X11^ZISX:'$D(IO("T")) K IO("S") ;Close printer port
"RTN","ZISC",29,0)
 . Q
"RTN","ZISC",30,0)
 ;
"RTN","ZISC",31,0)
 ;I '$D(IOCPU)&(IO'=IO(0)!$D(IO("C"))),$D(IO(1,IO)) D
"RTN","ZISC",32,0)
 ;Don't use IOCPU as we now use IO(1,IO)
"RTN","ZISC",33,0)
 I (IO'=IO(0)!$D(IO("C"))),$D(IO(1,IO)) D
"RTN","ZISC",34,0)
 . U:$S($D(ZTQUEUED):0,'$L($G(IO(0))):0,$D(IO(1,IO(0)))#2:1,1:0) IO(0)
"RTN","ZISC",35,0)
 . C IO K IO(1,IO) S IO("CLOSE")=IO ;close device
"RTN","ZISC",36,0)
 ;
"RTN","ZISC",37,0)
 ;I $G(^%ZIS(2,+IOST(0),3.1))]"" D X31^ZISX:'$D(IO("T"))
"RTN","ZISC",38,0)
 ;
"RTN","ZISC",39,0)
 D:IO'=IO(0) RESETP
"RTN","ZISC",40,0)
 I $D(IOT),IOT="CHAN",$D(IOS) D
"RTN","ZISC",41,0)
 .S %=$G(^%ZIS(1,+IOS,"GBL"))
"RTN","ZISC",42,0)
 .I %]"" L @("-^"_%) ;unlock global used to control access to network channels.
"RTN","ZISC",43,0)
 I $D(IO("SPOOL")) D CLOSE^%ZIS4 ;Special close for spool device
"RTN","ZISC",44,0)
SETIO ;
"RTN","ZISC",45,0)
 ;See if old device has PCX code
"RTN","ZISC",46,0)
 I $G(IOS),$G(^%ZIS(1,+IOS,"PCX"))]"" S %ZISPCX=^("PCX")
"RTN","ZISC",47,0)
 ;Setup the IO(0) device, should be the home device
"RTN","ZISC",48,0)
 S IO=IO(0),(IOPAR,IOUPAR)="" K IO("T") D CIOS(IO(0))
"RTN","ZISC",49,0)
 G END:'IOS S ION=$P(^%ZIS(1,IOS,0),"^",1),IOT=$G(^("TYPE")),IOST(0)=$S(IOT["TRM"&($D(^XUTL("XQ",$J,"IOST(0)"))):^("IOST(0)"),1:$G(^%ZIS(1,IOS,"SUBTYPE")))
"RTN","ZISC",50,0)
 I IOT["TRM",$D(^XUTL("XQ",$J,"IOST(0)")) D HOME^%ZIS G END
"RTN","ZISC",51,0)
 S %="Y"
"RTN","ZISC",52,0)
 I IOST(0),$D(^%ZIS(2,IOST(0),1)) S %=^(1),IOM=+%,IOF=$P(%,"^",2),IOSL=$P(%,"^",3),IOBS=$P(%,"^",4)
"RTN","ZISC",53,0)
 I $D(^%ZIS(1,IOS,91)) S %=^%ZIS(1,IOS,91) S:+% IOM=+% S:$P(%,"^",3) IOSL=$P(%,"^",3)
"RTN","ZISC",54,0)
 ;Don't know the subtype so set some defaults
"RTN","ZISC",55,0)
 I %="Y" S IOM=80,IOSL=24,IOF="#",IOST="C-OTHER",IOBS="$C(8)"
"RTN","ZISC",56,0)
S1 S:IOST(0) IOST=$P($G(^%ZIS(2,+IOST(0),0)),"^"),IOXY=$G(^("XY"))
"RTN","ZISC",57,0)
 I '$D(ZTQUEUED),'$D(IO("C")),IOT["TRM" D RM:$D(IO(1,IO))
"RTN","ZISC",58,0)
 ;With home device set, Do Post-close execute code of Device closed.
"RTN","ZISC",59,0)
END I '$D(IO("T")),$G(%ZISPCX)]"" S %Y=%ZISPCX D %Y^ZISX
"RTN","ZISC",60,0)
 ;See that any extra IO variables are cleaned up
"RTN","ZISC",61,0)
 K %,%E,%H,%ZISI,%ZISOS,%ZISPCX,%ZISV,%ZISVT,%ZISX
"RTN","ZISC",62,0)
 K IO("P"),IO("DOC"),IO("HFSIO"),IO("SPOOL"),IOC,IONOFF
"RTN","ZISC",63,0)
 ;IOCPU should not be changed.
"RTN","ZISC",64,0)
 Q
"RTN","ZISC",65,0)
 ;
"RTN","ZISC",66,0)
SUBTYPE ;Find a subtype
"RTN","ZISC",67,0)
 N %S
"RTN","ZISC",68,0)
 S IOST=$G(IOST),IOST(0)=+$G(IOST(0))
"RTN","ZISC",69,0)
 I $L(IOST)&$L(IOST(0)) Q  ;Have a subtype
"RTN","ZISC",70,0)
 S %S=$G(^%ZIS(2,+IOST(0),0)) I $L(%S) S IOST=$P(%S,U) Q
"RTN","ZISC",71,0)
 I $L(IOST) S %S=$O(^%ZIS(2,"B",$G(IOST,"X"),0)) I %S>0 S IOST(0)=+%S Q
"RTN","ZISC",72,0)
 S IOST="",IOST(0)=0 D CIOS($I) Q:IOS'>0
"RTN","ZISC",73,0)
 S IOST(0)=$G(^%ZIS(1,+IOS,"SUBTYPE")),IOST=$P($G(^%ZIS(2,+IOST(0),0)),"^")
"RTN","ZISC",74,0)
 Q
"RTN","ZISC",75,0)
 ;
"RTN","ZISC",76,0)
CIOS(%I) ;Find a value for IOS (IEN into device file)
"RTN","ZISC",77,0)
 I $D(^XUTL("XQ",$J,"IOS")) S IOS=+^("IOS") Q
"RTN","ZISC",78,0)
 I $D(%ZISV) S %ZISVT=%I D VTLKUP^%ZIS S IOS=+%E
"RTN","ZISC",79,0)
 E  S IOS=+$O(^%ZIS(1,"C",%I,0))
"RTN","ZISC",80,0)
 Q:$G(IOS)>0
"RTN","ZISC",81,0)
 S %ZISVT=%I D VIRTUAL^%ZIS
"RTN","ZISC",82,0)
 I $D(%ZISVT) S %H=%E I %ZISVT]"",%H>0,$D(^%ZIS(1,%H,0)),$D(^("TYPE")),^("TYPE")="VTRM" K %ZISVT S IOS=%H
"RTN","ZISC",83,0)
 Q
"RTN","ZISC",84,0)
 ;
"RTN","ZISC",85,0)
RESETP I IO]"" K ^XUTL("ZISPARAM",IO) Q
"RTN","ZISC",86,0)
 Q
"RTN","ZISC",87,0)
RM N X S X=+IOM X ^%ZOSF("RM") Q
"RTN","ZISC",88,0)
RES ;Close resource device.
"RTN","ZISC",89,0)
 Q:'$D(IO(1,IO))&'$D(^%ZISL(3.54,"AJ",$J))
"RTN","ZISC",90,0)
 S %ZISJOB=$J
"RTN","ZISC",91,0)
 ;
"RTN","ZISC",92,0)
RES1 G RQ:'$D(IOS),RQ:'$D(^%ZIS(1,+IOS,1)) S %ZISRL=+$P(^(1),"^",10),%ZISRL=$S(%ZISRL:%ZISRL,1:1)
"RTN","ZISC",93,0)
 S %X=$O(^%ZISL(3.54,"B",IO,0)) G RQ:'%X
"RTN","ZISC",94,0)
 G RQ:'$D(^%ZISL(3.54,+%X,0)) S %ZISD0=+%X,%ZISY0=^(0)
"RTN","ZISC",95,0)
 S %X=$O(^%ZISL(3.54,"AJ",%ZISJOB,%ZISD0,0)) S %ZISD1=%X G RQ:'%X
"RTN","ZISC",96,0)
 S %Y=$G(^%ZISL(3.54,%ZISD0,1,+%ZISD1,0)) G RQ:$P(%Y,"^",3)'=%ZISJOB
"RTN","ZISC",97,0)
 D KILLRES(+%ZISD0,+%ZISD1)
"RTN","ZISC",98,0)
RQ K IO(1,IO),%X,%Y,%ZISD0,%ZISD1,%ZISJOB,%ZISRES,%ZISRL,%ZISY0,%ZTRTN,ZTSAVE,ZTIO Q
"RTN","ZISC",99,0)
KILLRES(D0,D1) ;Kill one resource use
"RTN","ZISC",100,0)
 Q:(D0'>0)!(D1'>0)  N %X,%Y,%J,%ZISRL L +^%ZISL(3.54,D0,0)
"RTN","ZISC",101,0)
 S %Y=$G(^%ZISL(3.54,D0,0)) G KRX:%Y=""
"RTN","ZISC",102,0)
 S %X=$G(^%ZISL(3.54,D0,1,D1,0)),%J=$P(%X,"^",3) S:%J="" %J=" "
"RTN","ZISC",103,0)
 K ^%ZISL(3.54,D0,1,D1,0),^%ZISL(3.54,D0,1,"B",D1,D1),^%ZISL(3.54,"AJ",%J,D0,D1)
"RTN","ZISC",104,0)
 S %X=$P(%Y,"^",2)+1,$P(^%ZISL(3.54,D0,0),"^",2)=%X
"RTN","ZISC",105,0)
 ;I '$D(^%ZISL(3.54,%ZISD0,1,0)) S ^(0)="^3.542A^^" G RQ
"RTN","ZISC",106,0)
 S %Y=$G(^%ZISL(3.54,D0,1,0)),%X=$P(%Y,"^",4),$P(^%ZISL(3.54,D0,1,0),"^",3,4)="^"_$S(%X>0:(%X-1),1:0)
"RTN","ZISC",107,0)
KRX L -^%ZISL(3.54,D0,0) Q
"RTN","ZISC",108,0)
DQCRES ;Tasked entry point to close resource device.
"RTN","ZISC",109,0)
 S IO=%ZISRES G RES1
"RTN","ZISC",110,0)
 ;
"RTN","ZISC",111,0)
FF() ;Issue form feed
"RTN","ZISC",112,0)
 I $E(IOST,1,2)'["C-",$D(IO(1,IO)),$G(IOT)="TRM"!($G(IOT)="SPL"),'$D(IO("T"))&$Y&'$D(IONOFF)&'$D(IO(1,IO,"NOFF")) Q 1
"RTN","ZISC",113,0)
 Q 0
"RTN","ZISC",114,0)
 ;
"RTN","ZISC",115,0)
CLOSPP() ;Close printer port
"RTN","ZISC",116,0)
 I $D(IO("S")),$D(^%ZIS(2,+IO("S"),11))&$D(IO(1,IO)) Q 1
"RTN","ZISC",117,0)
 Q 0
"RTN","ZISFGTM")
0^13^B9168627
"RTN","ZISFGTM",1,0)
%ZISF ;SFISC/AC - HOST FILES FOR GT.M on Unix/VMS  ;10 Feb 2003 6:35 pm
"RTN","ZISFGTM",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","ZISFGTM",3,0)
HFS ;Host File Server
"RTN","ZISFGTM",4,0)
 Q:$D(IOP)&$D(%IS("HFSIO"))&$D(%IS("IOPAR"))
"RTN","ZISFGTM",5,0)
 I $D(%ZIS("HFSNAME")) S IO=%ZIS("HFSNAME"),%X=IO ;
"RTN","ZISFGTM",6,0)
 E  D ASKHFS
"RTN","ZISFGTM",7,0)
H S:$D(%ZIS("HFSMODE")) %ZISOPAR=$$MODE(%ZIS("HFSMODE"))
"RTN","ZISFGTM",8,0)
H1 I $D(IO("Q"))!(%IS["Z") S IO("HFSIO")=""
"RTN","ZISFGTM",9,0)
 S IO=$S(%X]"":%X,1:IO),IO=$$CHKNM(IO) ;See that we have a directory
"RTN","ZISFGTM",10,0)
 S:$D(IO("HFSIO")) IO("HFSIO")=IO
"RTN","ZISFGTM",11,0)
 W:'$D(IOP)&$D(%ZIS("HFSNAME")) "    HOST FILE TO USE:  "_%ZIS("HFSNAME"),!
"RTN","ZISFGTM",12,0)
 D ASKPAR^%ZIS6,SETPAR^%ZIS3
"RTN","ZISFGTM",13,0)
HFSIOO I '$D(IOP),%ZTYPE="HFS",'$D(%ZIS("HFSMODE")),'$P(^%ZIS(1,%E,0),"^",4),%ZISOPAR="",$D(^%ZIS(1,%E,1)),$P(^(1),"^",6) W ?45,"INPUT/OUTPUT OPERATION: R//"
"RTN","ZISFGTM",14,0)
 Q:'$T  D SBR^%ZIS1 I $D(DTOUT)!$D(DFOUT)!$D(DUOUT) S POP=1 Q
"RTN","ZISFGTM",15,0)
 D HOPT:%X="?"!'$$CHECK(%X),HOPT1:%X="??" G HFSIOO:%X="?"!'$$CHECK(%X)
"RTN","ZISFGTM",16,0)
 S:%X]"" %ZISOPAR="("""_%X_""")" Q
"RTN","ZISFGTM",17,0)
 ;
"RTN","ZISFGTM",18,0)
CHECK(X) ;Check that we have valid option
"RTN","ZISFGTM",19,0)
 N Y,%
"RTN","ZISFGTM",20,0)
 Q:(X["R")&(X["W") 0 ;Can't have both
"RTN","ZISFGTM",21,0)
 S Y=1 F %=1:1:$L(X) I "AFNRSVW"'[$E(X) S Y=0
"RTN","ZISFGTM",22,0)
 Q Y
"RTN","ZISFGTM",23,0)
 ;
"RTN","ZISFGTM",24,0)
ASKHFS ;---Ask host file name here---
"RTN","ZISFGTM",25,0)
 I $D(%IS("B","HFS"))#2,%IS("B","HFS")]"" D
"RTN","ZISFGTM",26,0)
 .S IO=%IS("B","HFS") ;Set default host file name
"RTN","ZISFGTM",27,0)
 S %X='$P($G(^%ZIS(1,%E,1)),"^",5)
"RTN","ZISFGTM",28,0)
 S:'%X %X=""
"RTN","ZISFGTM",29,0)
 I $D(IOP)!%X!$D(%ZIS("HFSNAME")) S %X="" Q
"RTN","ZISFGTM",30,0)
ASKAGN W !,"HOST FILE NAME: "_IO_"//" D SBR^%ZIS1
"RTN","ZISFGTM",31,0)
 I %X?1."?".E W !,"ENTER HOST FILE NAME" G ASKAGN
"RTN","ZISFGTM",32,0)
 S:$D(DTOUT)!$D(DUOUT) POP=1
"RTN","ZISFGTM",33,0)
 Q
"RTN","ZISFGTM",34,0)
CHKNM(H) ;Check the HFS name
"RTN","ZISFGTM",35,0)
 N N S N=H
"RTN","ZISFGTM",36,0)
 I $ZV["VMS" D
"RTN","ZISFGTM",37,0)
 . I (H'[":")&(H'["[") S N=$$DEFDIR^%ZISH("")_H
"RTN","ZISFGTM",38,0)
 E  D
"RTN","ZISFGTM",39,0)
 . I (H'["/") S N=$$DEFDIR^%ZISH("")_H
"RTN","ZISFGTM",40,0)
 Q N
"RTN","ZISFGTM",41,0)
 ;
"RTN","ZISFGTM",42,0)
MODE(X) ;Return %ZISOPAR in Y.
"RTN","ZISFGTM",43,0)
 N Y,Q S Q=$C(34)
"RTN","ZISFGTM",44,0)
 S Y=$S(X["R"&(X["W"):"(VARIABLE)",X="N":"(NEWVERSION:NOREADONLY:VARIABLE)",X="W":"(NEWVERSION:NOREADONLY:VARIABLE)",X="A":"(APPEND:NOREADONLY:VARIABLE)",1:"(READONLY:VARIABLE)")
"RTN","ZISFGTM",45,0)
 Q Y
"RTN","ZISFGTM",46,0)
 ;
"RTN","ZISFGTM",47,0)
HOPT W !,"You may enter a string of codes that represents",!,"the following host file input/ouput operation:"
"RTN","ZISFGTM",48,0)
 W !?16,"R = READ ACCESS",!?16,"W = WRITE ACCESS",!?16,"N = NEWVERSION",!?16,"S = FIXED FORMAT",!?16,"V = VARIABLE FORMAT",!?16,"A = APPEND"
"RTN","ZISFGTM",49,0)
 W !,"Example valid groupings 'RV', 'NW', 'AWV'"
"RTN","ZISFGTM",50,0)
 Q
"RTN","ZISFGTM",51,0)
HOPT1 S %ZISI=$O(^DIC(9.2,"B","XUHFSPARAM-GUX",0)) Q:'%ZISI  Q:'$D(^DIC(9.2,+%ZISI,0))  Q:$P(^(0),"^",1)'="XUHFSPARAM-GUX"
"RTN","ZISFGTM",52,0)
 Q:$D(^DIC(9.2,+%ZISI,1))'>9  F %X=0:0 S %X=$O(^DIC(9.2,+%ZISI,1,%X)) Q:%X'>0  I $D(^(%X,0)) W !,^(0)
"RTN","ZISFGTM",53,0)
 W ! S %X="??" Q
"RTN","ZISHGTM")
0^15^B38709489
"RTN","ZISHGTM",1,0)
%ZISH ;ISF/AC,RWF - GT.M for VMS Host file Control ;05/12/2004  10:44
"RTN","ZISHGTM",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995;
"RTN","ZISHGTM",3,0)
 ; for GT.M for Unix/VMS, version 4.3
"RTN","ZISHGTM",4,0)
 ;
"RTN","ZISHGTM",5,0)
OPENERR ;
"RTN","ZISHGTM",6,0)
 Q 0
"RTN","ZISHGTM",7,0)
 ;
"RTN","ZISHGTM",8,0)
OPEN(X1,X2,X3,X4,X5,X6) ;SR. Open file
"RTN","ZISHGTM",9,0)
 ;D OPEN^%ZISH([handlename],[directory],filename,[accessmode],[recsize])
"RTN","ZISHGTM",10,0)
 ;X1=handle name
"RTN","ZISHGTM",11,0)
 ;X2=directory, X3=filename, X4=access mode
"RTN","ZISHGTM",12,0)
 ;X5=new file max record size, X6=Subtype
"RTN","ZISHGTM",13,0)
 ;
"RTN","ZISHGTM",14,0)
 N %,%1,%2,%IO,%I2,%P,%T,X,Y,$ETRAP
"RTN","ZISHGTM",15,0)
 S $ETRAP="D OPNERR^%ZISH"
"RTN","ZISHGTM",16,0)
 S U="^",X2=$$DEFDIR($G(X2)),X4=$$UP^XLFSTR(X4)
"RTN","ZISHGTM",17,0)
 S Y=$S(X4["A":"append",X4["R":"readonly",X4["W":"newversion",1:"readonly")
"RTN","ZISHGTM",18,0)
 S Y=Y_$S(X4["B":":fixed:nowrap:recordsize=512",$G(X5)&(X4["W"):":WIDTH="_+X5,1:"")
"RTN","ZISHGTM",19,0)
 S:$E(Y)=":" Y=$E(Y,2,999) S %IO=X2_X3,%I2="%IO:"_$S($L(Y):"("_Y_")",1:"")_":3"
"RTN","ZISHGTM",20,0)
 O @%I2 S %T=$T
"RTN","ZISHGTM",21,0)
 I '%T S POP=1 Q
"RTN","ZISHGTM",22,0)
 S IO=%IO,IO(1,IO)="",IOT="HFS",POP=0 D SUBTYPE^%ZIS3($G(X6))
"RTN","ZISHGTM",23,0)
 I $G(X1)]"" D SAVDEV^%ZISUTL(X1)
"RTN","ZISHGTM",24,0)
 U IO U $P ;Enable use of $ZA to test EOF condition.
"RTN","ZISHGTM",25,0)
 Q
"RTN","ZISHGTM",26,0)
OPNERR ;error on open
"RTN","ZISHGTM",27,0)
 S POP=1,$ECODE=""
"RTN","ZISHGTM",28,0)
 U:$G(%P)]"" %P
"RTN","ZISHGTM",29,0)
 Q
"RTN","ZISHGTM",30,0)
 ;
"RTN","ZISHGTM",31,0)
CLOSE(X) ;SR. Close HFS device not opened by %ZIS.
"RTN","ZISHGTM",32,0)
 ;X1=Handle name, IO=device
"RTN","ZISHGTM",33,0)
 I IO]"" C IO K IO(1,IO)
"RTN","ZISHGTM",34,0)
 I $G(X)]"" D RMDEV^%ZISUTL(X)
"RTN","ZISHGTM",35,0)
 D HOME^%ZIS
"RTN","ZISHGTM",36,0)
 Q
"RTN","ZISHGTM",37,0)
DEL(%ZX1,%ZX2) ;ef,SR. Del fl(s)
"RTN","ZISHGTM",38,0)
 ;S Y=$$DEL^ZISH("/dir/",namevalue)
"RTN","ZISHGTM",39,0)
 ;Rtn 0=Err, 1=Ok
"RTN","ZISHGTM",40,0)
 N %ZISH,%ZISHLGR,%ZXIT,%ZX,X
"RTN","ZISHGTM",41,0)
 N $ETRAP,$ESTACK S $ETRAP="D DELERR^%ZISH"
"RTN","ZISHGTM",42,0)
 S %ZX1=$$DEFDIR($G(%ZX1))
"RTN","ZISHGTM",43,0)
 ;Get fls to act on
"RTN","ZISHGTM",44,0)
 ;No '*' allowed
"RTN","ZISHGTM",45,0)
 S %ZISH="" F  S %ZISH=$O(@%ZX2@(%ZISH)) Q:'%ZISH  I %ZISH["*" S %ZXIT=1 Q
"RTN","ZISHGTM",46,0)
 Q:$D(%ZXIT) 0
"RTN","ZISHGTM",47,0)
 S %ZISH="",%ZXIT=0
"RTN","ZISHGTM",48,0)
 F  S %ZISH=$O(@%ZX2@(%ZISH)) Q:%ZISH=""  S %ZX=$ZPARSE(%ZISH,,%ZX1) D  Q:%ZXIT
"RTN","ZISHGTM",49,0)
 . S X=$ZSEARCH("") ;Flush $ZSEARCH context
"RTN","ZISHGTM",50,0)
 . S %ZX=$ZSEARCH(%ZX)
"RTN","ZISHGTM",51,0)
 . I %ZX]"" O %ZX:readonly:0 S:'$T %ZXIT=1 Q:%ZXIT  C %ZX:delete
"RTN","ZISHGTM",52,0)
 Q '%ZXIT
"RTN","ZISHGTM",53,0)
 ;
"RTN","ZISHGTM",54,0)
DELERR ;Trap any $ETRAP error, unwind and return.
"RTN","ZISHGTM",55,0)
 Q:$ESTACK>1  S $ECODE="" Q:'$QUIT  Q 0
"RTN","ZISHGTM",56,0)
 ;
"RTN","ZISHGTM",57,0)
LIST(%ZX1,%ZX2,%ZX3) ;ef,SR. Set local array holding fl names
"RTN","ZISHGTM",58,0)
 ;S Y=$$LIST^ZISH("/dir/","list_root","return_root")
"RTN","ZISHGTM",59,0)
 ;list_root can have XX("A*"), XX("test.com")...
"RTN","ZISHGTM",60,0)
 ;Both arrays passed as $NA values (closed roots).
"RTN","ZISHGTM",61,0)
 N %IO,%X,%ZISH,%ZISH1,%ZISHIO,%ZX,POP,X,%ZISHDL1,%ZISHDL2,%ZISHDN1,%ZISHDN2
"RTN","ZISHGTM",62,0)
 N $ETRAP,$ESTACK S $ETRAP="",%ZX1=$$DEFDIR($G(%ZX1))
"RTN","ZISHGTM",63,0)
 S %IO=$I,%ZISHDN1="ZISH"_$J_".TMPA",%ZISHDN2="ZISH"_$J_".TMPB"
"RTN","ZISHGTM",64,0)
 S %ZISHDL1=%ZX1_%ZISHDN1,%ZISHDL2=%ZX1_%ZISHDN2
"RTN","ZISHGTM",65,0)
 S $ZT="G SPAWNERR^%ZISH"
"RTN","ZISHGTM",66,0)
 ;Init %ZISHDL1, %ZISHDL2 by deleteing them
"RTN","ZISHGTM",67,0)
 I $ZSEARCH(%ZISHDL1)["ZISH" ZSYSTEM "DEL "_%ZISHDL1_";*"
"RTN","ZISHGTM",68,0)
 I $ZSEARCH(%ZISHDL2)["ZISH" ZSYSTEM "DEL "_%ZISHDL2_";*"
"RTN","ZISHGTM",69,0)
 ;Get fls to act on, Build listing in ZISH_$J_.TMPA (%ZISHDL1)
"RTN","ZISHGTM",70,0)
 S %ZISH1=0,%ZISH=""
"RTN","ZISHGTM",71,0)
 F  S %ZISH=$O(@%ZX2@(%ZISH)) Q:%ZISH=""  D
"RTN","ZISHGTM",72,0)
 . S %ZISH=$S(%ZISH["*.*":%ZISH,%ZISH'["*":%ZISH,%ZISH'[".":%ZISH_".*",1:%ZISH)
"RTN","ZISHGTM",73,0)
 . S X=$$LIST1(%ZX1_%ZISH,%ZX1)
"RTN","ZISHGTM",74,0)
 ;Open %ZISHDL1 to read list backin.
"RTN","ZISHGTM",75,0)
 S $ZT="G LSTEOF^%ZISH"
"RTN","ZISHGTM",76,0)
LSTEOF S $ZT=""
"RTN","ZISHGTM",77,0)
 I $L(%IO) U:$D(IO(1,%IO)) IO
"RTN","ZISHGTM",78,0)
 ;C %ZISHDL1 ;:DELETE
"RTN","ZISHGTM",79,0)
 ;I $L($ZSEARCH(%ZISHDL2)) ZSYSTEM "DEL "_%ZISHDL2_";*"
"RTN","ZISHGTM",80,0)
 ;I $L($ZSEARCH(%ZISHDL1)) ZSYSTEM "DEL "_%ZISHDL1_";*"
"RTN","ZISHGTM",81,0)
 S $ECODE=""
"RTN","ZISHGTM",82,0)
 Q ($Q(@%ZX3)]"")
"RTN","ZISHGTM",83,0)
 ;
"RTN","ZISHGTM",84,0)
LIST1(%ZX,%ZD) ;Get one part of the list
"RTN","ZISHGTM",85,0)
 S $ZT="LSTERR^%ZISH"
"RTN","ZISHGTM",86,0)
 N %ZY,%ZI
"RTN","ZISHGTM",87,0)
 S %ZY=$ZSEARCH("*.X") ;Clear vector
"RTN","ZISHGTM",88,0)
 S %ZY=$P(%ZX,"*")
"RTN","ZISHGTM",89,0)
 F  S %ZI=$ZSEARCH(%ZX) Q:'$L(%ZI)!(%ZI'[%ZY)  S @%ZX3@($P(%ZI,%ZD,2))=""
"RTN","ZISHGTM",90,0)
 Q 1
"RTN","ZISHGTM",91,0)
LSTERR ;Error in list
"RTN","ZISHGTM",92,0)
 I $ZSEARCH(%ZISHDL2)["ZISH" ZSYSTEM "DEL "_%ZISHDL2_";*"
"RTN","ZISHGTM",93,0)
 Q 0
"RTN","ZISHGTM",94,0)
 ;
"RTN","ZISHGTM",95,0)
SPAWNERR ;TRAP ERROR OF SPAWN
"RTN","ZISHGTM",96,0)
 O %ZISHDL1:READONLY:1 I $T C %ZISHDL1:DELETE
"RTN","ZISHGTM",97,0)
 S $ECODE=""
"RTN","ZISHGTM",98,0)
 Q 0
"RTN","ZISHGTM",99,0)
 ;
"RTN","ZISHGTM",100,0)
MV(X1,X2,Y1,Y2) ;ef,SR. Rename a fl
"RTN","ZISHGTM",101,0)
 ;S Y=$$MV^ZISH("/dir/","fl","/dir/","fl")
"RTN","ZISHGTM",102,0)
 N X,Y,%ZISHDL1
"RTN","ZISHGTM",103,0)
 S %ZISHDL1="ZISH"_$J_".TMPA",X1=$$DEFDIR($G(X1)),Y1=$$DEFDIR($G(Y1))
"RTN","ZISHGTM",104,0)
 S $ZT="SPAWNERR^%ZISH"
"RTN","ZISHGTM",105,0)
 ;Pbv or qit
"RTN","ZISHGTM",106,0)
 I (X2="")!(Y2="") Q 0
"RTN","ZISHGTM",107,0)
 ZSYSTEM "RENAME "_X1_X2_" "_Y1_Y2 ;Use system rename
"RTN","ZISHGTM",108,0)
 S Y=$ZSEARCH(Y1_Y2)
"RTN","ZISHGTM",109,0)
 Q $L(Y)>0
"RTN","ZISHGTM",110,0)
 ;
"RTN","ZISHGTM",111,0)
PWD() ;ef,SR. Print working directory
"RTN","ZISHGTM",112,0)
 N Y
"RTN","ZISHGTM",113,0)
 S Y=$$DEFDIR("")
"RTN","ZISHGTM",114,0)
 S:Y="" Y=$ZDIR
"RTN","ZISHGTM",115,0)
 Q Y
"RTN","ZISHGTM",116,0)
 ;
"RTN","ZISHGTM",117,0)
DEFDIR(DF) ;ef. Default Dir and frmt
"RTN","ZISHGTM",118,0)
 S DF=$G(DF) Q:DF="." "" ;Special way to get current dir.
"RTN","ZISHGTM",119,0)
 S:DF="" DF=$G(^XTV(8989.3,1,"DEV"))
"RTN","ZISHGTM",120,0)
 ;Check syntax, VMS needs : or [ ]
"RTN","ZISHGTM",121,0)
 I ^%ZOSF("OS")["VMS" D  Q DF ;***EXIT FOR VMS/GTM
"RTN","ZISHGTM",122,0)
 . N P1,P2
"RTN","ZISHGTM",123,0)
 . I DF[":" S P1=$P(DF,":")_":",P2=$P(DF,":",2)
"RTN","ZISHGTM",124,0)
 . E  S P1="",P2=DF
"RTN","ZISHGTM",125,0)
 . I P1="",P2["$" S DF=P2 Q  ;Assume a logical
"RTN","ZISHGTM",126,0)
 . I $L(P2) S:P2'["[" P2="["_P2 S:P2'["]" P2=P2_"]"
"RTN","ZISHGTM",127,0)
 . S DF=P1_P2
"RTN","ZISHGTM",128,0)
 . Q
"RTN","ZISHGTM",129,0)
 ;
"RTN","ZISHGTM",130,0)
 ;Check syntax, Unix check leading & trailing "/"
"RTN","ZISHGTM",131,0)
 I "./"'[$E(DF) S DF="/"_DF
"RTN","ZISHGTM",132,0)
 I $E(DF,$L(DF))'="/" S DF=DF_"/"
"RTN","ZISHGTM",133,0)
 Q DF
"RTN","ZISHGTM",134,0)
STATUS() ;ef,SR. Return EOF status
"RTN","ZISHGTM",135,0)
 U $I
"RTN","ZISHGTM",136,0)
 Q $ZEOF
"RTN","ZISHGTM",137,0)
 ;
"RTN","ZISHGTM",138,0)
EOF(X) ;Eof flag, Pass in $ZA
"RTN","ZISHGTM",139,0)
 Q X
"RTN","ZISHGTM",140,0)
QL(X) ;Qlfrs
"RTN","ZISHGTM",141,0)
 Q:X=""
"RTN","ZISHGTM",142,0)
 S:$E(X)'="-" X="-"_X
"RTN","ZISHGTM",143,0)
 Q
"RTN","ZISHGTM",144,0)
FL(X) ;Fl len
"RTN","ZISHGTM",145,0)
 N ZOSHP1,ZOSHP2
"RTN","ZISHGTM",146,0)
 S ZOSHP1=$P(X,"."),ZOSHP2=$P(X,".",2)
"RTN","ZISHGTM",147,0)
 I $L(ZOSHP1)>14 S X=4 Q
"RTN","ZISHGTM",148,0)
 I $L(ZOSHP2)>8 S X=4 Q
"RTN","ZISHGTM",149,0)
 Q
"RTN","ZISHGTM",150,0)
 ;
"RTN","ZISHGTM",151,0)
MAKEREF(HF,IX,OVF) ;Internal call to rebuild global ref.
"RTN","ZISHGTM",152,0)
 ;Return %ZISHF,%ZISHO,%ZISHI,%ZISUB
"RTN","ZISHGTM",153,0)
 N I,F,MX
"RTN","ZISHGTM",154,0)
 S OVF=$G(OVF,"%ZISHOF")
"RTN","ZISHGTM",155,0)
 S %ZISHI=$$QS^DDBRAP(HF,IX),MX=$$QL^DDBRAP(HF) ;
"RTN","ZISHGTM",156,0)
 S F=$NA(@HF,IX-1) ;Get first part
"RTN","ZISHGTM",157,0)
 I IX=1 S %ZISHF=F_"(%ZISHI" ;Build root, IX=1
"RTN","ZISHGTM",158,0)
 I IX>1 S %ZISHF=$E(F,1,$L(F)-1)_",%ZISHI" ;Build root
"RTN","ZISHGTM",159,0)
 S %ZISHO=%ZISHF_","_OVF_",%OVFCNT)" ;Make overflow
"RTN","ZISHGTM",160,0)
 F I=IX+1:1:MX S %ZISHF=%ZISHF_",%ZISUB("_I_")",%ZISUB(I)=$$QS^DDBRAP(HF,I)
"RTN","ZISHGTM",161,0)
 S %ZISHF=%ZISHF_")"
"RTN","ZISHGTM",162,0)
 Q
"RTN","ZISHGTM",163,0)
FTG(%ZX1,%ZX2,%ZX3,%ZX4,%ZX5) ;ef,SR. Unload contents of host file into global
"RTN","ZISHGTM",164,0)
 ;p1=host file directory
"RTN","ZISHGTM",165,0)
 ;p2=host file name
"RTN","ZISHGTM",166,0)
 ;p3= $NAME REFERENCE INCLUDING STARTING SUBSCRIPT
"RTN","ZISHGTM",167,0)
 ;p4=INCREMENT SUBSCRIPT
"RTN","ZISHGTM",168,0)
 ;p5=Overflow subscript, defaults to "OVF"
"RTN","ZISHGTM",169,0)
 N %ZA,%ZB,%ZC,%ZL,X,%OVFCNT,%CONT
"RTN","ZISHGTM",170,0)
 N I,%ZISH,%ZISH1,%ZISHI,%ZISHL,%ZISHLGR,%ZISHOF,%ZISHOX,%ZISHS,%ZX,%ZISHY,POP,%ZISUB
"RTN","ZISHGTM",171,0)
 S %ZX1=$$DEFDIR($G(%ZX1)),%ZISHOF=$G(%ZX5,"OVF")
"RTN","ZISHGTM",172,0)
 D MAKEREF(%ZX3,%ZX4,"%ZISHOF")
"RTN","ZISHGTM",173,0)
 D OPEN^%ZISH(,%ZX1,%ZX2,"R")
"RTN","ZISHGTM",174,0)
 I POP Q 0
"RTN","ZISHGTM",175,0)
 N $ETRAP S $ETRAP="",X="ERREOF^%ZISH",@^%ZOSF("TRAP")
"RTN","ZISHGTM",176,0)
 U IO F  K %XX D READNXT(.%XX) Q:$$EOF(%ZA)  D
"RTN","ZISHGTM",177,0)
 . S @%ZISHF=%XX
"RTN","ZISHGTM",178,0)
 . I $D(%XX)>2 F %OVFCNT=1:1 Q:'$D(%XX(%OVFCNT))  S @%ZISHO=%XX(%OVFCNT)
"RTN","ZISHGTM",179,0)
 . S %ZISHI=%ZISHI+1
"RTN","ZISHGTM",180,0)
 . Q
"RTN","ZISHGTM",181,0)
 D CLOSE() ;Normal exit
"RTN","ZISHGTM",182,0)
 Q 1
"RTN","ZISHGTM",183,0)
 ;
"RTN","ZISHGTM",184,0)
ERREOF D CLOSE() ;Got error Reading file
"RTN","ZISHGTM",185,0)
 Q 0
"RTN","ZISHGTM",186,0)
 ;
"RTN","ZISHGTM",187,0)
READNXT(REC) ;
"RTN","ZISHGTM",188,0)
 N T,I,X,%
"RTN","ZISHGTM",189,0)
 U IO R X:2 S %ZA=$ZEOF,REC=$E(X,1,255)
"RTN","ZISHGTM",190,0)
 Q:$L(X)<256
"RTN","ZISHGTM",191,0)
 S %=256 F I=1:1 Q:$L(X)<%  S REC(I)=$E(X,%,%+254),%=%+255
"RTN","ZISHGTM",192,0)
 Q
"RTN","ZISHGTM",193,0)
GTF(%ZX1,%ZX2,%ZX3,%ZX4) ;ef,SR. Load contents of global to host file.
"RTN","ZISHGTM",194,0)
 ;Previously name LOAD
"RTN","ZISHGTM",195,0)
 ;p1=$NAME of global reference
"RTN","ZISHGTM",196,0)
 ;p2=incrementing subscript
"RTN","ZISHGTM",197,0)
 ;p3=host file directory
"RTN","ZISHGTM",198,0)
 ;p4=host file name
"RTN","ZISHGTM",199,0)
 N %ZISHY,%ZISHLGR,%ZISHOX
"RTN","ZISHGTM",200,0)
 S %ZISHY=$$MGTF(%ZX1,%ZX2,$G(%ZX3),%ZX4,"W")
"RTN","ZISHGTM",201,0)
 Q %ZISHY
"RTN","ZISHGTM",202,0)
 ;
"RTN","ZISHGTM",203,0)
GATF(%ZX1,%ZX2,%ZX3,%ZX4) ;ef,SR. Append to host file.
"RTN","ZISHGTM",204,0)
 ;
"RTN","ZISHGTM",205,0)
 ;p1=$NAME of global reference
"RTN","ZISHGTM",206,0)
 ;p2=incrementing subscript
"RTN","ZISHGTM",207,0)
 ;p3=host file directory
"RTN","ZISHGTM",208,0)
 ;p4=host file name
"RTN","ZISHGTM",209,0)
 N %ZISHY
"RTN","ZISHGTM",210,0)
 S %ZISHY=$$MGTF(%ZX1,%ZX2,$G(%ZX3),%ZX4,"A")
"RTN","ZISHGTM",211,0)
 Q %ZISHY
"RTN","ZISHGTM",212,0)
 ;
"RTN","ZISHGTM",213,0)
MGTF(%ZX1,%ZX2,%ZX3,%ZX4,%ZX5) ;
"RTN","ZISHGTM",214,0)
 ;p1=$NAME of global reference
"RTN","ZISHGTM",215,0)
 ;p2=incrementing subscript
"RTN","ZISHGTM",216,0)
 ;p3=host file directory
"RTN","ZISHGTM",217,0)
 ;p4=host file name
"RTN","ZISHGTM",218,0)
 N %ZISH,%ZISH1,%ZISHI,%ZISHL,%ZISHLGR,%ZISHS,%ZISHOX,IO,%ZX,Y
"RTN","ZISHGTM",219,0)
 D MAKEREF(%ZX1,%ZX2)
"RTN","ZISHGTM",220,0)
 D OPEN^%ZISH(,%ZX3,%ZX4,%ZX5) ;Default dir set in open
"RTN","ZISHGTM",221,0)
 I POP Q 0
"RTN","ZISHGTM",222,0)
 N X
"RTN","ZISHGTM",223,0)
 N $ETRAP S $ETRAP="S $EC="""" D CLOSE^%ZISH() Q 0"
"RTN","ZISHGTM",224,0)
 F  Q:'($D(@%ZISHF)#2)  S %ZX=@%ZISHF,%ZISHI=%ZISHI+1 U IO W %ZX,!
"RTN","ZISHGTM",225,0)
 D CLOSE() ;Normal Exit
"RTN","ZISHGTM",226,0)
 Q 1
"RTN","ZISHGTM",227,0)
 ;
"RTN","ZISHGUX")
0^16^B38047424
"RTN","ZISHGUX",1,0)
%ZISH ;ISF/AC,RWF - GT.M for UNIX Host file Control ;02/03/2004  08:13
"RTN","ZISHGUX",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995;
"RTN","ZISHGUX",3,0)
 ; for GT.M for Unix/VMS, version 4.3
"RTN","ZISHGUX",4,0)
 ;
"RTN","ZISHGUX",5,0)
OPENERR ;
"RTN","ZISHGUX",6,0)
 Q 0
"RTN","ZISHGUX",7,0)
 ;
"RTN","ZISHGUX",8,0)
OPEN(X1,X2,X3,X4,X5,X6) ;SR. Open file
"RTN","ZISHGUX",9,0)
 ;D OPEN^%ZISH([handlename],[directory],filename,[accessmode],[recsize])
"RTN","ZISHGUX",10,0)
 ;X1=handle name
"RTN","ZISHGUX",11,0)
 ;X2=directory, X3=filename, X4=access mode
"RTN","ZISHGUX",12,0)
 ;X5=new file max record size, X6=Subtype
"RTN","ZISHGUX",13,0)
 ;
"RTN","ZISHGUX",14,0)
 N %,%1,%2,%IO,%I2,%P,%T,X,Y,$ETRAP
"RTN","ZISHGUX",15,0)
 S $ETRAP="D OPNERR^%ZISH"
"RTN","ZISHGUX",16,0)
 S U="^",X2=$$DEFDIR($G(X2)),X4=$$UP^XLFSTR(X4)
"RTN","ZISHGUX",17,0)
 S Y=$S(X4["A":"append",X4["R":"readonly",X4["W":"newversion",1:"readonly")
"RTN","ZISHGUX",18,0)
 S Y=Y_$S(X4["B":":fixed:nowrap:recordsize=512",$G(X5)&(X4["W"):":WIDTH="_+X5,1:"")
"RTN","ZISHGUX",19,0)
 S:$E(Y)=":" Y=$E(Y,2,999) S %IO=X2_X3,%I2="%IO:"_$S($L(Y):"("_Y_")",1:"")_":3"
"RTN","ZISHGUX",20,0)
 O @%I2 S %T=$T
"RTN","ZISHGUX",21,0)
 I '%T S POP=1 Q
"RTN","ZISHGUX",22,0)
 S IO=%IO,IO(1,IO)="",IOT="HFS",POP=0 D SUBTYPE^%ZIS3($G(X6))
"RTN","ZISHGUX",23,0)
 I $G(X1)]"" D SAVDEV^%ZISUTL(X1)
"RTN","ZISHGUX",24,0)
 U IO U $P ;Enable use of $ZA to test EOF condition.
"RTN","ZISHGUX",25,0)
 Q
"RTN","ZISHGUX",26,0)
OPNERR ;error on open
"RTN","ZISHGUX",27,0)
 S POP=1,$ECODE=""
"RTN","ZISHGUX",28,0)
 U:$G(%P)]"" %P
"RTN","ZISHGUX",29,0)
 Q
"RTN","ZISHGUX",30,0)
 ;
"RTN","ZISHGUX",31,0)
CLOSE(X) ;SR. Close HFS device not opened by %ZIS.
"RTN","ZISHGUX",32,0)
 ;X1=Handle name, IO=device
"RTN","ZISHGUX",33,0)
 I IO]"" C IO K IO(1,IO)
"RTN","ZISHGUX",34,0)
 I $G(X)]"" D RMDEV^%ZISUTL(X)
"RTN","ZISHGUX",35,0)
 D HOME^%ZIS
"RTN","ZISHGUX",36,0)
 Q
"RTN","ZISHGUX",37,0)
DEL(%ZX1,%ZX2) ;ef,SR. Del fl(s)
"RTN","ZISHGUX",38,0)
 ;S Y=$$DEL^ZISH("/dir/",namevalue)
"RTN","ZISHGUX",39,0)
 ;Rtn 0=Err, 1=Ok
"RTN","ZISHGUX",40,0)
 N %ZISH,%ZISHLGR,%ZXIT,%ZX,X
"RTN","ZISHGUX",41,0)
 N $ETRAP,$ESTACK S $ETRAP="D DELERR^%ZISH"
"RTN","ZISHGUX",42,0)
 S %ZX1=$$DEFDIR($G(%ZX1))
"RTN","ZISHGUX",43,0)
 ;Get fls to act on
"RTN","ZISHGUX",44,0)
 ;No '*' allowed
"RTN","ZISHGUX",45,0)
 S %ZISH="" F  S %ZISH=$O(@%ZX2@(%ZISH)) Q:'%ZISH  I %ZISH["*" S %ZXIT=1 Q
"RTN","ZISHGUX",46,0)
 Q:$D(%ZXIT) 0
"RTN","ZISHGUX",47,0)
 S %ZISH="",%ZXIT=0
"RTN","ZISHGUX",48,0)
 F  S %ZISH=$O(@%ZX2@(%ZISH)) Q:%ZISH=""  S %ZX=$ZPARSE(%ZISH,,%ZX1) D  Q:%ZXIT
"RTN","ZISHGUX",49,0)
 . S X=$ZSEARCH("") ;Flush $ZSEARCH context
"RTN","ZISHGUX",50,0)
 . S %ZX=$ZSEARCH(%ZX)
"RTN","ZISHGUX",51,0)
 . I %ZX]"" O %ZX:readonly:0 S:'$T %ZXIT=1 Q:%ZXIT  C %ZX:DELETE
"RTN","ZISHGUX",52,0)
 Q '%ZXIT
"RTN","ZISHGUX",53,0)
 ;
"RTN","ZISHGUX",54,0)
DELERR ;Trap any $ETRAP error, unwind and return.
"RTN","ZISHGUX",55,0)
 Q:$ESTACK>1  S $ECODE="" Q:'$QUIT  Q 0
"RTN","ZISHGUX",56,0)
 ;
"RTN","ZISHGUX",57,0)
LIST(%ZX1,%ZX2,%ZX3) ;ef,SR. Set local array holding fl names
"RTN","ZISHGUX",58,0)
 ;S Y=$$LIST^ZISH("/dir/","list_root","return_root")
"RTN","ZISHGUX",59,0)
 ;list_root can have XX("A*"), XX("test.com")...
"RTN","ZISHGUX",60,0)
 ;Both arrays passed as $NA values (closed roots).
"RTN","ZISHGUX",61,0)
 N %IO,%X,%ZISH,%ZISH1,%ZISHIO,%ZX,POP,X,%ZISHDL1,%ZISHDL2,%ZISHDN1,%ZISHDN2
"RTN","ZISHGUX",62,0)
 N $ETRAP,$ESTACK S $ETRAP="G LSTEOF^%ZISH",%ZX1=$$DEFDIR($G(%ZX1))
"RTN","ZISHGUX",63,0)
 S %IO=$I,%ZISHDN1="_ZISH"_$J_".TMPA",%ZISHDN2="ZISH"_$J_".TMPB"
"RTN","ZISHGUX",64,0)
 S %ZISHDL1=%ZX1_%ZISHDN1,%ZISHDL2=%ZX1_%ZISHDN2
"RTN","ZISHGUX",65,0)
 S $ZT="G SPAWNERR^%ZISH"
"RTN","ZISHGUX",66,0)
 ;Init %ZISHDL1, %ZISHDL2 by deleteing them
"RTN","ZISHGUX",67,0)
 ;I $ZSEARCH(%ZISHDL1)["ZISH" ZSYSTEM "rm "_%ZISHDL1
"RTN","ZISHGUX",68,0)
 ;I $ZSEARCH(%ZISHDL2)["ZISH" ZSYSTEM "rm "_%ZISHDL2_";*"
"RTN","ZISHGUX",69,0)
 ;Get fls, Build listing in %ZISHDL1 with ls
"RTN","ZISHGUX",70,0)
 S %ZISH1=0,%ZISH=""
"RTN","ZISHGUX",71,0)
 F  S %ZISH=$O(@%ZX2@(%ZISH)) Q:%ZISH=""  D
"RTN","ZISHGUX",72,0)
 . S X=$$LIST1(%ZX1_%ZISH,%ZX1)
"RTN","ZISHGUX",73,0)
LSTEOF S $ZT=""
"RTN","ZISHGUX",74,0)
 I $L(%IO) U:$D(IO(1,%IO)) IO
"RTN","ZISHGUX",75,0)
 ;C %ZISHDL1 ;:DELETE
"RTN","ZISHGUX",76,0)
 ;I $L($ZSEARCH(%ZISHDL2)) ZSYSTEM "DEL "_%ZISHDL2
"RTN","ZISHGUX",77,0)
 ;I $L($ZSEARCH(%ZISHDL1)) ZSYSTEM "DEL "_%ZISHDL1_";*"
"RTN","ZISHGUX",78,0)
 S $ECODE=""
"RTN","ZISHGUX",79,0)
 Q ($Q(@%ZX3)]"")
"RTN","ZISHGUX",80,0)
 ;
"RTN","ZISHGUX",81,0)
LIST1(%ZX,%ZD) ;Get one part of the list
"RTN","ZISHGUX",82,0)
 N $ET,$ES S $ET="D LSTERR^%ZISH"
"RTN","ZISHGUX",83,0)
 ;ZSYSTEM "ls -1 "_%ZX_" > "_%ZISHDL1
"RTN","ZISHGUX",84,0)
 ;O %ZISHDL1:readonly:1 U %ZISHDL1
"RTN","ZISHGUX",85,0)
 ;F  R %X:1 Q:$ZEOF  S @%ZX3@(%X)=""
"RTN","ZISHGUX",86,0)
 ;C %ZISHDL1:DELETE
"RTN","ZISHGUX",87,0)
 N %ZY,%ZI,%ZJ
"RTN","ZISHGUX",88,0)
 S %ZY=$ZSEARCH("*.X") ;Clear vector
"RTN","ZISHGUX",89,0)
 S %ZY=$P(%ZX,"*")
"RTN","ZISHGUX",90,0)
 F  S %ZI=$ZSEARCH(%ZX) Q:'$L(%ZI)!(%ZI'[%ZY)  S %ZJ=$P(%ZI,%ZD,2),@%ZX3@(%ZJ)=""
"RTN","ZISHGUX",91,0)
 Q 1
"RTN","ZISHGUX",92,0)
LSTERR ;Error in list
"RTN","ZISHGUX",93,0)
 I $ZSEARCH(%ZISHDL2)["ZISH" ZSYSTEM "DEL "_%ZISHDL2_";*"
"RTN","ZISHGUX",94,0)
 Q 0
"RTN","ZISHGUX",95,0)
 ;
"RTN","ZISHGUX",96,0)
SPAWNERR ;TRAP ERROR OF SPAWN
"RTN","ZISHGUX",97,0)
 O %ZISHDL1:READONLY:1 I $T C %ZISHDL1:DELETE
"RTN","ZISHGUX",98,0)
 S $ECODE=""
"RTN","ZISHGUX",99,0)
 Q 0
"RTN","ZISHGUX",100,0)
 ;
"RTN","ZISHGUX",101,0)
MV(X1,X2,Y1,Y2) ;ef,SR. Rename a fl
"RTN","ZISHGUX",102,0)
 ;S Y=$$MV^ZISH("/dir/","fl","/dir/","fl")
"RTN","ZISHGUX",103,0)
 N X,Y,%ZISHDL1
"RTN","ZISHGUX",104,0)
 S %ZISHDL1="ZISH"_$J_".TMPA",X1=$$DEFDIR($G(X1)),Y1=$$DEFDIR($G(Y1))
"RTN","ZISHGUX",105,0)
 S $ZT="SPAWNERR^%ZISH"
"RTN","ZISHGUX",106,0)
 ;Pbv or qit
"RTN","ZISHGUX",107,0)
 I (X2="")!(Y2="") Q 0
"RTN","ZISHGUX",108,0)
 ZSYSTEM "mv "_X1_X2_" "_Y1_Y2 ;Use system command
"RTN","ZISHGUX",109,0)
 S Y=$ZSEARCH(Y1_Y2)
"RTN","ZISHGUX",110,0)
 Q $L(Y)>0
"RTN","ZISHGUX",111,0)
 ;
"RTN","ZISHGUX",112,0)
PWD() ;ef,SR. Print working directory
"RTN","ZISHGUX",113,0)
 N Y
"RTN","ZISHGUX",114,0)
 S Y=$$DEFDIR("")
"RTN","ZISHGUX",115,0)
 S:Y="" Y=$ZDIR
"RTN","ZISHGUX",116,0)
 Q Y
"RTN","ZISHGUX",117,0)
 ;
"RTN","ZISHGUX",118,0)
DEFDIR(DF) ;ef. Default Dir and frmt
"RTN","ZISHGUX",119,0)
 S DF=$G(DF) Q:DF="." "" ;Special way to get current dir.
"RTN","ZISHGUX",120,0)
 S:DF="" DF=$G(^XTV(8989.3,1,"DEV"))
"RTN","ZISHGUX",121,0)
 ;Check syntax, VMS needs : or [ ]
"RTN","ZISHGUX",122,0)
 I ^%ZOSF("OS")["VMS" D  Q DF ;***EXIT FOR VMS/GTM
"RTN","ZISHGUX",123,0)
 . N P1,P2
"RTN","ZISHGUX",124,0)
 . I DF[":" S P1=$P(DF,":")_":",P2=$P(DF,":",2)
"RTN","ZISHGUX",125,0)
 . E  S P1="",P2=DF
"RTN","ZISHGUX",126,0)
 . I P1="",P2["$" S DF=P2 Q  ;Assume a logical
"RTN","ZISHGUX",127,0)
 . I $L(P2) S:P2'["[" P2="["_P2 S:P2'["]" P2=P2_"]"
"RTN","ZISHGUX",128,0)
 . S DF=P1_P2
"RTN","ZISHGUX",129,0)
 . Q
"RTN","ZISHGUX",130,0)
 ;
"RTN","ZISHGUX",131,0)
 ;Check syntax, Unix check leading & trailing "/"
"RTN","ZISHGUX",132,0)
 I "./"'[$E(DF) S DF="/"_DF
"RTN","ZISHGUX",133,0)
 I $E(DF,$L(DF))'="/" S DF=DF_"/"
"RTN","ZISHGUX",134,0)
 Q DF
"RTN","ZISHGUX",135,0)
STATUS() ;ef,SR. Return EOF status
"RTN","ZISHGUX",136,0)
 U $I
"RTN","ZISHGUX",137,0)
 Q $ZEOF
"RTN","ZISHGUX",138,0)
 ;
"RTN","ZISHGUX",139,0)
EOF(X) ;Eof flag, Pass in $ZA
"RTN","ZISHGUX",140,0)
 Q X
"RTN","ZISHGUX",141,0)
QL(X) ;Qlfrs
"RTN","ZISHGUX",142,0)
 Q:X=""
"RTN","ZISHGUX",143,0)
 S:$E(X)'="-" X="-"_X
"RTN","ZISHGUX",144,0)
 Q
"RTN","ZISHGUX",145,0)
FL(X) ;Fl len
"RTN","ZISHGUX",146,0)
 N ZOSHP1,ZOSHP2
"RTN","ZISHGUX",147,0)
 S ZOSHP1=$P(X,"."),ZOSHP2=$P(X,".",2)
"RTN","ZISHGUX",148,0)
 I $L(ZOSHP1)>14 S X=4 Q
"RTN","ZISHGUX",149,0)
 I $L(ZOSHP2)>8 S X=4 Q
"RTN","ZISHGUX",150,0)
 Q
"RTN","ZISHGUX",151,0)
 ;
"RTN","ZISHGUX",152,0)
MAKEREF(HF,IX,OVF) ;Internal call to rebuild global ref.
"RTN","ZISHGUX",153,0)
 ;Return %ZISHF,%ZISHO,%ZISHI,%ZISUB
"RTN","ZISHGUX",154,0)
 N I,F,MX
"RTN","ZISHGUX",155,0)
 S OVF=$G(OVF,"%ZISHOF")
"RTN","ZISHGUX",156,0)
 S %ZISHI=$$QS^DDBRAP(HF,IX),MX=$$QL^DDBRAP(HF) ;
"RTN","ZISHGUX",157,0)
 S F=$NA(@HF,IX-1) ;Get first part
"RTN","ZISHGUX",158,0)
 I IX=1 S %ZISHF=F_"(%ZISHI" ;Build root, IX=1
"RTN","ZISHGUX",159,0)
 I IX>1 S %ZISHF=$E(F,1,$L(F)-1)_",%ZISHI" ;Build root
"RTN","ZISHGUX",160,0)
 S %ZISHO=%ZISHF_","_OVF_",%OVFCNT)" ;Make overflow
"RTN","ZISHGUX",161,0)
 F I=IX+1:1:MX S %ZISHF=%ZISHF_",%ZISUB("_I_")",%ZISUB(I)=$$QS^DDBRAP(HF,I)
"RTN","ZISHGUX",162,0)
 S %ZISHF=%ZISHF_")"
"RTN","ZISHGUX",163,0)
 Q
"RTN","ZISHGUX",164,0)
FTG(%ZX1,%ZX2,%ZX3,%ZX4,%ZX5) ;ef,SR. Unload contents of host file into global
"RTN","ZISHGUX",165,0)
 ;p1=host file directory
"RTN","ZISHGUX",166,0)
 ;p2=host file name
"RTN","ZISHGUX",167,0)
 ;p3= $NAME REFERENCE INCLUDING STARTING SUBSCRIPT
"RTN","ZISHGUX",168,0)
 ;p4=INCREMENT SUBSCRIPT
"RTN","ZISHGUX",169,0)
 ;p5=Overflow subscript, defaults to "OVF"
"RTN","ZISHGUX",170,0)
 N %ZA,%ZB,%ZC,%ZL,X,%OVFCNT,%CONT
"RTN","ZISHGUX",171,0)
 N I,%ZISH,%ZISH1,%ZISHI,%ZISHL,%ZISHLGR,%ZISHOF,%ZISHOX,%ZISHS,%ZX,%ZISHY,POP,%ZISUB,%EXIT
"RTN","ZISHGUX",172,0)
 S %ZX1=$$DEFDIR($G(%ZX1)),%ZISHOF=$G(%ZX5,"OVF")
"RTN","ZISHGUX",173,0)
 D MAKEREF(%ZX3,%ZX4,"%ZISHOF")
"RTN","ZISHGUX",174,0)
 D OPEN^%ZISH(,%ZX1,%ZX2,"R")
"RTN","ZISHGUX",175,0)
 I POP Q 0
"RTN","ZISHGUX",176,0)
 N $ETRAP S %EXIT=0,$ETRAP="S %ZA=1,%EXIT=1,$ECODE="""" Q"
"RTN","ZISHGUX",177,0)
 U IO F  K %XX D READNXT(.%XX) Q:$$EOF(%ZA)  D
"RTN","ZISHGUX",178,0)
 . S @%ZISHF=%XX
"RTN","ZISHGUX",179,0)
 . I $D(%XX)>2 F %OVFCNT=1:1 Q:'$D(%XX(%OVFCNT))  S @%ZISHO=%XX(%OVFCNT)
"RTN","ZISHGUX",180,0)
 . S %ZISHI=%ZISHI+1
"RTN","ZISHGUX",181,0)
 . Q
"RTN","ZISHGUX",182,0)
 D CLOSE() ;Normal exit
"RTN","ZISHGUX",183,0)
 Q '%EXIT
"RTN","ZISHGUX",184,0)
 ;
"RTN","ZISHGUX",185,0)
ERREOF D CLOSE() ;Got error Reading file
"RTN","ZISHGUX",186,0)
 Q 0
"RTN","ZISHGUX",187,0)
 ;
"RTN","ZISHGUX",188,0)
READNXT(REC) ;
"RTN","ZISHGUX",189,0)
 N T,I,X,%
"RTN","ZISHGUX",190,0)
 U IO R X:2 S %ZA=$ZEOF,REC=$E(X,1,255)
"RTN","ZISHGUX",191,0)
 Q:$L(X)<256
"RTN","ZISHGUX",192,0)
 S %=256 F I=1:1 Q:$L(X)<%  S REC(I)=$E(X,%,%+254),%=%+255
"RTN","ZISHGUX",193,0)
 Q
"RTN","ZISHGUX",194,0)
GTF(%ZX1,%ZX2,%ZX3,%ZX4) ;ef,SR. Load contents of global to host file.
"RTN","ZISHGUX",195,0)
 ;Previously name LOAD
"RTN","ZISHGUX",196,0)
 ;p1=$NAME of global reference
"RTN","ZISHGUX",197,0)
 ;p2=incrementing subscript
"RTN","ZISHGUX",198,0)
 ;p3=host file directory
"RTN","ZISHGUX",199,0)
 ;p4=host file name
"RTN","ZISHGUX",200,0)
 N %ZISHY,%ZISHLGR,%ZISHOX
"RTN","ZISHGUX",201,0)
 S %ZISHY=$$MGTF(%ZX1,%ZX2,$G(%ZX3),%ZX4,"W")
"RTN","ZISHGUX",202,0)
 Q %ZISHY
"RTN","ZISHGUX",203,0)
 ;
"RTN","ZISHGUX",204,0)
GATF(%ZX1,%ZX2,%ZX3,%ZX4) ;ef,SR. Append to host file.
"RTN","ZISHGUX",205,0)
 ;
"RTN","ZISHGUX",206,0)
 ;p1=$NAME of global reference
"RTN","ZISHGUX",207,0)
 ;p2=incrementing subscript
"RTN","ZISHGUX",208,0)
 ;p3=host file directory
"RTN","ZISHGUX",209,0)
 ;p4=host file name
"RTN","ZISHGUX",210,0)
 N %ZISHY
"RTN","ZISHGUX",211,0)
 S %ZISHY=$$MGTF(%ZX1,%ZX2,$G(%ZX3),%ZX4,"A")
"RTN","ZISHGUX",212,0)
 Q %ZISHY
"RTN","ZISHGUX",213,0)
 ;
"RTN","ZISHGUX",214,0)
MGTF(%ZX1,%ZX2,%ZX3,%ZX4,%ZX5) ;
"RTN","ZISHGUX",215,0)
 ;p1=$NAME of global reference
"RTN","ZISHGUX",216,0)
 ;p2=incrementing subscript
"RTN","ZISHGUX",217,0)
 ;p3=host file directory
"RTN","ZISHGUX",218,0)
 ;p4=host file name
"RTN","ZISHGUX",219,0)
 N %ZISH,%ZISH1,%ZISHI,%ZISHL,%ZISHLGR,%ZISHS,%ZISHOX,IO,%ZX,Y
"RTN","ZISHGUX",220,0)
 D MAKEREF(%ZX1,%ZX2)
"RTN","ZISHGUX",221,0)
 D OPEN^%ZISH(,%ZX3,%ZX4,%ZX5) ;Default dir set in open
"RTN","ZISHGUX",222,0)
 I POP Q 0
"RTN","ZISHGUX",223,0)
 N X
"RTN","ZISHGUX",224,0)
 N $ETRAP S $ETRAP="",X="ERREOF^%ZISH",@^%ZOSF("TRAP")
"RTN","ZISHGUX",225,0)
 F  Q:'($D(@%ZISHF)#2)  S %ZX=@%ZISHF,%ZISHI=%ZISHI+1 U IO W %ZX,!
"RTN","ZISHGUX",226,0)
 D CLOSE() ;Normal Exit
"RTN","ZISHGUX",227,0)
 Q 1
"RTN","ZISHGUX",228,0)
 ;
"RTN","ZISTCP")
0^17^B27837637
"RTN","ZISTCP",1,0)
%ZISTCP ;ISC-SF/RWF - DEVICE HANDLER TCP/IP CALLS ;06/23/2004  09:09
"RTN","ZISTCP",2,0)
 ;;8.0;KERNEL;**36,34,59,69,118,225,275**;Jul 10, 1995
"RTN","ZISTCP",3,0)
 Q
"RTN","ZISTCP",4,0)
 ;
"RTN","ZISTCP",5,0)
CALL(IP,SOCK,TO) ;Open a socket to the IP address <procedure>
"RTN","ZISTCP",6,0)
 N %A,ZISOS,X,NIO
"RTN","ZISTCP",7,0)
 S ZISOS=^%ZOSF("OS"),TO=$G(TO,30)
"RTN","ZISTCP",8,0)
 N $ETRAP S $ETRAP="G OPNERR^%ZISTCP"
"RTN","ZISTCP",9,0)
 S POP=1
"RTN","ZISTCP",10,0)
 I IP'?1.3N1P1.3N1P1.3N1P1.3N S IP=$$ADDRESS^XLFNSLK(IP)  ;Lookup the name
"RTN","ZISTCP",11,0)
 I IP'?1.3N1P1.3N1P1.3N1P1.3N Q  ;Not in the IP format
"RTN","ZISTCP",12,0)
 I (SOCK<1)!(SOCK>65535) Q
"RTN","ZISTCP",13,0)
 G CVXD:ZISOS["VAX",CONT:ZISOS["OpenM",CGTM:ZISOS["GT.M",CMSM:ZISOS["MSM"
"RTN","ZISTCP",14,0)
 S POP=1
"RTN","ZISTCP",15,0)
 Q
"RTN","ZISTCP",16,0)
CVXD ;Open VAX DSM Socket
"RTN","ZISTCP",17,0)
 S NIO=SOCK
"RTN","ZISTCP",18,0)
 O NIO:(TCPCHAN,ADDRESS=IP):TO G:'$T NOOPN
"RTN","ZISTCP",19,0)
 U NIO:NOECHO D VAR(NIO)
"RTN","ZISTCP",20,0)
 Q
"RTN","ZISTCP",21,0)
CMSM ;Open MSM Socket
"RTN","ZISTCP",22,0)
 S NIO=56 O NIO::TO G:'$T NOOPN
"RTN","ZISTCP",23,0)
 U NIO::"TCP" W /SOCKET(IP,SOCK) I $KEY="" C NIO G NOOPN
"RTN","ZISTCP",24,0)
 D VAR(NIO)
"RTN","ZISTCP",25,0)
 Q
"RTN","ZISTCP",26,0)
CONT ;Open OpenM socket
"RTN","ZISTCP",27,0)
 I $$VERSION^%ZOSV'<5 S %A=$ZUTIL(68,55,1)
"RTN","ZISTCP",28,0)
 S NIO="|TCP|"_SOCK
"RTN","ZISTCP",29,0)
 O NIO:(IP:SOCK:"-M"::512:512):TO G:'$T NOOPN ;Make work like DSM
"RTN","ZISTCP",30,0)
 U NIO D VAR(NIO)
"RTN","ZISTCP",31,0)
 Q
"RTN","ZISTCP",32,0)
CGTM ;Open GT.M Socket
"RTN","ZISTCP",33,0)
 S NIO="SCK$"_$P($H,",",2) ;Just needs to be unique for job
"RTN","ZISTCP",34,0)
 O NIO:(CONNECT=IP_":"_SOCK_":TCP":ATTACH="client"):TO:"SOCKET"
"RTN","ZISTCP",35,0)
 I '$T S POP=1 Q
"RTN","ZISTCP",36,0)
 U NIO S NIO("KEY")=$KEY
"RTN","ZISTCP",37,0)
 S NIO("SOCKET")=$P(NIO("KEY"),"|",2)
"RTN","ZISTCP",38,0)
 I $P(NIO("KEY"),"|")'="ESTABLISHED" D LOG("** ="_NIO("KEY")_"= **") W 1/0 ; PROTOCOL ERROR
"RTN","ZISTCP",39,0)
 ;U NIO:(SOCKET=NIO("SOCKET"):WIDTH=512:NOWRAP:IOERROR="TRAP":EXCEPT="G GTMERR^%ZISTCP")
"RTN","ZISTCP",40,0)
 U NIO:(SOCKET=NIO("SOCKET"):WIDTH=512:NOWRAP:EXCEPT="G GTMERR^%ZISTCP")
"RTN","ZISTCP",41,0)
 D VAR(NIO) S IOF="#" ;Set buffer flush
"RTN","ZISTCP",42,0)
 Q
"RTN","ZISTCP",43,0)
 ;
"RTN","ZISTCP",44,0)
VAR(%IO) ;Setup IO variables
"RTN","ZISTCP",45,0)
 S:'$D(IO(0)) IO(0)=$I
"RTN","ZISTCP",46,0)
 S IO=%IO,IO(1,IO)=$G(IP),POP=0
"RTN","ZISTCP",47,0)
 ;Set IOF to the normal buffer flush. W @IOF.
"RTN","ZISTCP",48,0)
 S IOT="TCP",IOST="P-TCP",IOST(0)=0
"RTN","ZISTCP",49,0)
 S IOF=$$FLUSHCHR
"RTN","ZISTCP",50,0)
 Q
"RTN","ZISTCP",51,0)
NOOPN ;Didn't make the conection
"RTN","ZISTCP",52,0)
 S POP=1
"RTN","ZISTCP",53,0)
 Q
"RTN","ZISTCP",54,0)
OPNERR ;
"RTN","ZISTCP",55,0)
 ;D ^%ZTER
"RTN","ZISTCP",56,0)
 S POP=1
"RTN","ZISTCP",57,0)
 D ERRCLR
"RTN","ZISTCP",58,0)
 Q
"RTN","ZISTCP",59,0)
UCXOPEN(NIO) ;This call only applies to SERVER jobs tied to UCX/VMS
"RTN","ZISTCP",60,0)
 N $ETRAP,%ZISV,%ZISOS S $ETRAP="G OPNERR^%ZISTCP"
"RTN","ZISTCP",61,0)
 S %ZISV=$$VERSION^%ZOSV,%ZISOS=^%ZOSF("OS"),POP=1
"RTN","ZISTCP",62,0)
 I %ZISOS["DSM",%ZISV<7 O NIO:(SHARE):5 D:$T VAR(NIO)
"RTN","ZISTCP",63,0)
 I %ZISOS["DSM",%ZISV'<7 S NIO="SYS$NET" O NIO:(TCPDEV):5 D:$T VAR(NIO)
"RTN","ZISTCP",64,0)
 Q
"RTN","ZISTCP",65,0)
 ;
"RTN","ZISTCP",66,0)
CLOSE ;Close and reset
"RTN","ZISTCP",67,0)
 N NIO,$ETRAP S $ETRAP="G CLOSEX^%ZISTCP"
"RTN","ZISTCP",68,0)
 S NIO=IO,IO=$S($G(IO(0))]"":IO(0),1:$P)
"RTN","ZISTCP",69,0)
 I NIO]"" C NIO K IO(1,NIO) S IO("CLOSE")=NIO
"RTN","ZISTCP",70,0)
CLOSEX D HOME^%ZIS
"RTN","ZISTCP",71,0)
 D ERRCLR
"RTN","ZISTCP",72,0)
 Q
"RTN","ZISTCP",73,0)
ERRCLR ;
"RTN","ZISTCP",74,0)
 S:$ECODE]"" IO("LASTERR")=$G(IO("ERROR")),IO("ERROR")=$ECODE,$ECODE=""
"RTN","ZISTCP",75,0)
 Q
"RTN","ZISTCP",76,0)
 ;
"RTN","ZISTCP",77,0)
FLUSHCHR() ;Return the value to write @ of to flush the TCP buffer
"RTN","ZISTCP",78,0)
 N OS S OS=$P(^%ZOSF("OS"),"^")
"RTN","ZISTCP",79,0)
 Q $S(OS["GT.M":"#",1:"!")
"RTN","ZISTCP",80,0)
 ;
"RTN","ZISTCP",81,0)
 ;In ZRULE, set ZISQUIT=1 to quit
"RTN","ZISTCP",82,0)
LISTEN(SOCK,RTN,ZRULE) ;Listen on socket, run routine, single thread.
"RTN","ZISTCP",83,0)
 N %A,ZISOS,X,NIO,EXIT,IOF,IP
"RTN","ZISTCP",84,0)
 N $ES,$ET S $ET="D OPNERR^%ZISTCP"
"RTN","ZISTCP",85,0)
 S ZISOS=^%ZOSF("OS"),ZRULE=$G(ZRULE)
"RTN","ZISTCP",86,0)
 D GETENV^%ZOSV S U="^",XUENV=Y,XQVOL=$P(Y,U,2)
"RTN","ZISTCP",87,0)
 S POP=1
"RTN","ZISTCP",88,0)
 I $G(^%ZIS(14.5,"LOGON",XQVOL)) Q
"RTN","ZISTCP",89,0)
LOOP S POP=1 D LVXD:ZISOS["DSM",LONT:ZISOS["OpenM",LGTM:ZISOS["GT.M",LMSM:ZISOS["MSM"
"RTN","ZISTCP",90,0)
 I POP Q  ;Quit Server
"RTN","ZISTCP",91,0)
 S EXIT=0,EXIT=$$LAUNCH(NIO,RTN)
"RTN","ZISTCP",92,0)
 I $G(^%ZIS(14.5,"LOGON",XQVOL)) S EXIT=1
"RTN","ZISTCP",93,0)
 I ZISOS["DSM" X "U NIO:DISCONNECT"
"RTN","ZISTCP",94,0)
 E  C NIO ;
"RTN","ZISTCP",95,0)
 Q:EXIT  ;Quit server, App set IO("C"), Logon inhibit.
"RTN","ZISTCP",96,0)
 G LOOP
"RTN","ZISTCP",97,0)
 ;
"RTN","ZISTCP",98,0)
LMSM ;MSM
"RTN","ZISTCP",99,0)
 ;For multi thread use MSM's MSERVER process.
"RTN","ZISTCP",100,0)
 ;This is the listener for  TCP connects.
"RTN","ZISTCP",101,0)
 S NIO=56 O NIO::30 Q:'$T  S POP=0
"RTN","ZISTCP",102,0)
 U NIO::"TCP" W /SOCKET("",SOCK)
"RTN","ZISTCP",103,0)
 S POP=$$EXIT
"RTN","ZISTCP",104,0)
 Q
"RTN","ZISTCP",105,0)
 ;
"RTN","ZISTCP",106,0)
LONT ;Open port in Accept mode with standard terminators, standard buffers.
"RTN","ZISTCP",107,0)
 N %ZA,%ZB
"RTN","ZISTCP",108,0)
 S NIO="|TCP|"_SOCK,%A=0
"RTN","ZISTCP",109,0)
 ;(adr:sock:term:ibuf:obuf:queue)
"RTN","ZISTCP",110,0)
 O NIO:(:SOCK:"AT"::512:512:3):30 Q:'$T  S POP=0
"RTN","ZISTCP",111,0)
 ;Wait on read for a connect
"RTN","ZISTCP",112,0)
 U NIO F  D  Q:%A!POP
"RTN","ZISTCP",113,0)
 . R *NEWCHAR:60 S %ZA=$ZA,%ZB=$ZB S:$T %A=1 Q:%A
"RTN","ZISTCP",114,0)
 . S POP=$$EXIT
"RTN","ZISTCP",115,0)
 I POP C NIO Q
"RTN","ZISTCP",116,0)
 U NIO:(::"-M") ;Work like DSM
"RTN","ZISTCP",117,0)
 Q
"RTN","ZISTCP",118,0)
 ;
"RTN","ZISTCP",119,0)
LVXD ;Open port and listen
"RTN","ZISTCP",120,0)
 ;Use UCX for multiple listeners
"RTN","ZISTCP",121,0)
 S NIO=SOCK O NIO:(TCPCHAN):30 Q:'$T  S POP=0
"RTN","ZISTCP",122,0)
 U NIO ;Let application wait at the read for a connect.
"RTN","ZISTCP",123,0)
 Q
"RTN","ZISTCP",124,0)
 ;
"RTN","ZISTCP",125,0)
LGTM ;GT.M single thread server
"RTN","ZISTCP",126,0)
 N %A K ^TMP("ZISTCP",$J)
"RTN","ZISTCP",127,0)
 S $ZINTERRUPT="I $$JOBEXAM^ZU($ZPOSITION)"
"RTN","ZISTCP",128,0)
 S NIO="SCK$"_$S($J>86400:$J,1:84600+$J) ;Construct a dummy, but "unique" devicename for job
"RTN","ZISTCP",129,0)
 D LOG("Open for Listen "_NIO)
"RTN","ZISTCP",130,0)
 ;Open the device
"RTN","ZISTCP",131,0)
 O NIO:(ZLISTEN=SOCK_":TCP":ATTACH="listener"):30:"SOCKET"
"RTN","ZISTCP",132,0)
 I '$T D LOG("Can't Open Socket: "_SOCK) Q
"RTN","ZISTCP",133,0)
 U NIO S NIO("ZISTCP",0)=$KEY D LOG("Have port.")
"RTN","ZISTCP",134,0)
 ;Start Listening
"RTN","ZISTCP",135,0)
 W /LISTEN(1) S NIO("ZISTCP",1)=$KEY D LOG("Start Listening. "_NIO("ZISTCP",1))
"RTN","ZISTCP",136,0)
 ;Wait for connection
"RTN","ZISTCP",137,0)
 S %A=0,POP=0 F  D  Q:%A!POP
"RTN","ZISTCP",138,0)
 . W /WAIT(30) ;Wait for connect
"RTN","ZISTCP",139,0)
 . I $P($KEY,"|",1)="CONNECT" S NIO("ZISTCP",2)=$KEY,%A=1
"RTN","ZISTCP",140,0)
 . S POP=$$EXIT
"RTN","ZISTCP",141,0)
 . Q
"RTN","ZISTCP",142,0)
 I POP C NIO Q
"RTN","ZISTCP",143,0)
 ;
"RTN","ZISTCP",144,0)
 S NIO("SOCK")=$P($G(NIO("ZISTCP",2)),"|",2)
"RTN","ZISTCP",145,0)
 D LOG("Got connection on "_NIO("SOCK"))
"RTN","ZISTCP",146,0)
 ;Close the main socket
"RTN","ZISTCP",147,0)
 C NIO:(SOCKET="listener")
"RTN","ZISTCP",148,0)
 ;Use the new socket
"RTN","ZISTCP",149,0)
 ;U NIO:(SOCKET=NIO("SOCK"):WIDTH=512:NOWRAP:IOERROR="TRAP":EXCEPT="G GTMERR^%ZISTCP")
"RTN","ZISTCP",150,0)
 U NIO:(SOCKET=NIO("SOCK"):WIDTH=512:NOWRAP:EXCEPT="G GTMERR^%ZISTCP")
"RTN","ZISTCP",151,0)
 S POP=0
"RTN","ZISTCP",152,0)
 Q
"RTN","ZISTCP",153,0)
 ;
"RTN","ZISTCP",154,0)
GTMERR ;The use will set this as a place to go on a IO error
"RTN","ZISTCP",155,0)
 S $ECODE=",U911,"
"RTN","ZISTCP",156,0)
 Q
"RTN","ZISTCP",157,0)
 ;
"RTN","ZISTCP",158,0)
EXIT() ;See if time to exit
"RTN","ZISTCP",159,0)
 I $$S^%ZTLOAD Q 1
"RTN","ZISTCP",160,0)
 N ZISQUIT S ZISQUIT=0
"RTN","ZISTCP",161,0)
 I $L(ZRULE) X ZRULE I $G(ZISQUIT) Q 1
"RTN","ZISTCP",162,0)
 Q 0
"RTN","ZISTCP",163,0)
 ;
"RTN","ZISTCP",164,0)
LAUNCH(IO,RTN) ;Run job for this conncetion.
"RTN","ZISTCP",165,0)
 N NIO,SOCK,EXIT,XQVOL
"RTN","ZISTCP",166,0)
 D VAR(IO)
"RTN","ZISTCP",167,0)
 S ^XUTL("XQ",$J,0)=$$DT^XLFDT
"RTN","ZISTCP",168,0)
 D LOG("Run "_RTN)
"RTN","ZISTCP",169,0)
 D @RTN
"RTN","ZISTCP",170,0)
 D LOG("Return from call, Exit="_$D(IO("C")))
"RTN","ZISTCP",171,0)
 Q $D(IO("C")) ;Use IO("C") to quit server
"RTN","ZISTCP",172,0)
 ;
"RTN","ZISTCP",173,0)
LOG(MSG) ;LOG STATUS
"RTN","ZISTCP",174,0)
 N CNT
"RTN","ZISTCP",175,0)
 S CNT=$G(^TMP("ZISTCP",$J))+1,^TMP("ZISTCP",$J)=CNT,^($J,CNT)=MSG
"RTN","ZISTCP",176,0)
 Q
"RTN","ZISTCP",177,0)
 ;
"RTN","ZISTCPS")
0^18^B11979690
"RTN","ZISTCPS",1,0)
%ZISTCPS ;ISF/RWF - DEVICE HANDLER TCP/IP SERVER CALLS ;06/23/2004  09:11
"RTN","ZISTCPS",2,0)
 ;;8.0;KERNEL;**78,118,127,225,275**;Jul 10, 1995
"RTN","ZISTCPS",3,0)
 Q
"RTN","ZISTCPS",4,0)
 ;
"RTN","ZISTCPS",5,0)
CLOSE ;Close and reset
"RTN","ZISTCPS",6,0)
 G CLOSE^%ZISTCP
"RTN","ZISTCPS",7,0)
 Q
"RTN","ZISTCPS",8,0)
 ;
"RTN","ZISTCPS",9,0)
 ;In ZRULE, set ZISQUIT=1 to quit
"RTN","ZISTCPS",10,0)
LISTEN(SOCK,RTN,ZRULE) ;Listen on socket, start routine
"RTN","ZISTCPS",11,0)
 N %A,ZISOS,X,NIO,EXIT
"RTN","ZISTCPS",12,0)
 N $ES,$ET S $ETRAP="D OPNERR^%ZISTCPS"
"RTN","ZISTCPS",13,0)
 S ZISOS=^%ZOSF("OS"),ZRULE=$G(ZRULE)
"RTN","ZISTCPS",14,0)
 S POP=1
"RTN","ZISTCPS",15,0)
 D GETENV^%ZOSV S U="^",XUENV=Y,XQVOL=$P(Y,U,2)
"RTN","ZISTCPS",16,0)
 S POP=1 D LONT:ZISOS["OpenM",LGTM:ZISOS["GT.M"
"RTN","ZISTCPS",17,0)
 I 'POP C NIO ;Close port
"RTN","ZISTCPS",18,0)
 Q
"RTN","ZISTCPS",19,0)
 ;
"RTN","ZISTCPS",20,0)
 ;
"RTN","ZISTCPS",21,0)
LONT ;Open port in Accept mode with standard terminators.
"RTN","ZISTCPS",22,0)
 N %ZA,NEWCHAR
"RTN","ZISTCPS",23,0)
 S NIO="|TCP|"_SOCK,EXIT=0
"RTN","ZISTCPS",24,0)
 ;(adr:sock:term:ibuf:obuf:queue)
"RTN","ZISTCPS",25,0)
 O NIO:(:SOCK:"AT"::512:512:10):30 Q:'$T  S POP=0 U NIO
"RTN","ZISTCPS",26,0)
 ;Wait on read for a connect
"RTN","ZISTCPS",27,0)
LONT2 F  U NIO R *NEWCHAR:30 S EXIT=$$EXIT Q:$T!EXIT
"RTN","ZISTCPS",28,0)
 I EXIT C NIO Q
"RTN","ZISTCPS",29,0)
 ;JOB params (:Concurrent Server bit:principal input:principal output)
"RTN","ZISTCPS",30,0)
 J CHILDONT^%ZISTCPS(NIO,RTN):(:4:NIO:NIO):10 S %ZA=$ZA
"RTN","ZISTCPS",31,0)
 I %ZA\8196#2=1 W *-2 ;Job failed to clear bit
"RTN","ZISTCPS",32,0)
 G LONT2
"RTN","ZISTCPS",33,0)
 ;
"RTN","ZISTCPS",34,0)
CHILDONT(IO,RTN) ;Child process for OpenM
"RTN","ZISTCPS",35,0)
 S $ETRAP="D ^%ZTER L  HALT",IO=$P
"RTN","ZISTCPS",36,0)
 U IO:(::"-M") ;Work like DSM
"RTN","ZISTCPS",37,0)
 S NEWJOB=$$NEWOK
"RTN","ZISTCPS",38,0)
 I 'NEWJOB W "421 Service temporarily down.",$C(13,10),!
"RTN","ZISTCPS",39,0)
 I NEWJOB K NEWJOB D VAR,@RTN
"RTN","ZISTCPS",40,0)
 HALT
"RTN","ZISTCPS",41,0)
 ;
"RTN","ZISTCPS",42,0)
VAR ;Setup IO variables
"RTN","ZISTCPS",43,0)
 S IO(0)=IO,IO(1,IO)="",POP=0
"RTN","ZISTCPS",44,0)
 S IOT="TCP",IOST="P-TCP",IOST(0)=0
"RTN","ZISTCPS",45,0)
 S IOF=$$FLUSHCHR^%ZISTCP
"RTN","ZISTCPS",46,0)
 S ^XUTL("XQ",$J,0)=$$DT^XLFDT
"RTN","ZISTCPS",47,0)
 Q
"RTN","ZISTCPS",48,0)
NEWOK() ;Is it OK to start a new process
"RTN","ZISTCPS",49,0)
 I $G(^%ZIS(14.5,"LOGON",^%ZOSF("VOL"))) Q 0
"RTN","ZISTCPS",50,0)
 I $$AVJ^%ZOSV()<3 Q 0
"RTN","ZISTCPS",51,0)
 Q 1
"RTN","ZISTCPS",52,0)
OPNERR ;
"RTN","ZISTCPS",53,0)
 S POP=1,EXIT=1,IO("ERROR")=$ECODE,$ECODE=""
"RTN","ZISTCPS",54,0)
 Q
"RTN","ZISTCPS",55,0)
EXIT() ;See if time to exit
"RTN","ZISTCPS",56,0)
 I $$S^%ZTLOAD Q 1
"RTN","ZISTCPS",57,0)
 N ZISQUIT S ZISQUIT=0
"RTN","ZISTCPS",58,0)
 I $L(ZRULE) X ZRULE I $G(ZISQUIT) Q 1
"RTN","ZISTCPS",59,0)
 Q 0
"RTN","ZISTCPS",60,0)
 ;
"RTN","ZISTCPS",61,0)
LGTM ;GT.M multi thread server
"RTN","ZISTCPS",62,0)
 N %A K ^TMP("ZISTCP",$J)
"RTN","ZISTCPS",63,0)
 S $ZINTERRUPT="I $$JOBEXAM^ZU($ZPOSITION)"
"RTN","ZISTCPS",64,0)
 S NIO="SCK$"_$S($J>86400:$J,1:84600+$J) ;Construct a dummy, but "unique" devicename for job
"RTN","ZISTCPS",65,0)
 D LOG("Open for Listen "_NIO)
"RTN","ZISTCPS",66,0)
 ;Open the device
"RTN","ZISTCPS",67,0)
 O NIO:(ZLISTEN=SOCK_":TCP":ATTACH="listener"):30:"SOCKET"
"RTN","ZISTCPS",68,0)
 I '$T D LOG("Can't Open Socket: "_SOCK) Q
"RTN","ZISTCPS",69,0)
 U NIO S NIO("ZISTCP",0)=$KEY D LOG("Have port.")
"RTN","ZISTCPS",70,0)
 ;Start Listening
"RTN","ZISTCPS",71,0)
 W /LISTEN(1) S NIO("ZISTCP",1)=$KEY D LOG("Start Listening. "_NIO("ZISTCP",1))
"RTN","ZISTCPS",72,0)
 ;Wait for connection
"RTN","ZISTCPS",73,0)
LG2 S %A=0,EXIT=0 F  D  Q:%A!EXIT
"RTN","ZISTCPS",74,0)
 . W /WAIT(30) ;Wait for connect
"RTN","ZISTCPS",75,0)
 . I $P($KEY,"|",1)="CONNECT" S NIO("ZISTCP",2)=$KEY,%A=1
"RTN","ZISTCPS",76,0)
 . S EXIT=$$EXIT
"RTN","ZISTCPS",77,0)
 . Q
"RTN","ZISTCPS",78,0)
 I EXIT C NIO Q
"RTN","ZISTCPS",79,0)
 ;
"RTN","ZISTCPS",80,0)
 S NIO("SOCK")=$P($G(NIO("ZISTCP",2)),"|",2)
"RTN","ZISTCPS",81,0)
 D LOG("Got connection on "_NIO("SOCK"))
"RTN","ZISTCPS",82,0)
 I '$$NEWOK D  G LG2
"RTN","ZISTCPS",83,0)
 . U NIO:(SOCKET=NIO("SOCK")) W "421 Service temporarily down.",$C(13,10),#
"RTN","ZISTCPS",84,0)
 . C NIO:(SOCKET=NIO("SOCK")) K NIO("ZISTCP",2)
"RTN","ZISTCPS",85,0)
 . Q
"RTN","ZISTCPS",86,0)
 ;Close the main socket
"RTN","ZISTCPS",87,0)
 C NIO:(SOCKET="listener")
"RTN","ZISTCPS",88,0)
 ;Start a new listener
"RTN","ZISTCPS",89,0)
 J LISTEN^%ZISTCPS(SOCK,RTN,ZRULE)
"RTN","ZISTCPS",90,0)
 ;Use the new socket
"RTN","ZISTCPS",91,0)
 ;U NIO:(SOCKET=NIO("SOCK"):WIDTH=512:NOWRAP:IOERROR="TRAP")
"RTN","ZISTCPS",92,0)
 U NIO:(SOCKET=NIO("SOCK"):WIDTH=512:NOWRAP)
"RTN","ZISTCPS",93,0)
 ;Run the job
"RTN","ZISTCPS",94,0)
 D GTMLNCH(NIO,RTN)
"RTN","ZISTCPS",95,0)
 S POP=0
"RTN","ZISTCPS",96,0)
 Q
"RTN","ZISTCPS",97,0)
 ;
"RTN","ZISTCPS",98,0)
GTMLNCH(IO,RTN) ;Run gt.m job for this conncetion.
"RTN","ZISTCPS",99,0)
 N NIO,SOCK,ZISOS,EXIT,XQVOL,$ETRAP
"RTN","ZISTCPS",100,0)
 S U="^",$ETRAP="D ^%ZTER L  HALT"
"RTN","ZISTCPS",101,0)
 S IO(0)=IO,IO(1,IO)=""
"RTN","ZISTCPS",102,0)
 D VAR,@RTN
"RTN","ZISTCPS",103,0)
 Q $D(IO("C")) ;Use IO("C") to quit server
"RTN","ZISTCPS",104,0)
 ;
"RTN","ZISTCPS",105,0)
LOG(MSG) ;LOG STATUS
"RTN","ZISTCPS",106,0)
 N CNT
"RTN","ZISTCPS",107,0)
 S CNT=$G(^TMP("ZISTCP",$J))+1,^TMP("ZISTCP",$J)=CNT,^($J,CNT)=MSG
"RTN","ZISTCPS",108,0)
 Q
"RTN","ZISTCPS",109,0)
 ;
"RTN","ZISUTL")
0^43^B10918305
"RTN","ZISUTL",1,0)
%ZISUTL ;Device Handler Utility routine ;3 Apr 2003 3:32 pm
"RTN","ZISUTL",2,0)
 ;;8.0;KERNEL;**18,24,34,69,118,127,199,275**;JUL 10, 1995
"RTN","ZISUTL",3,0)
 Q  ;No entry from top
"RTN","ZISUTL",4,0)
GETDEV(X) ;Return IO variables
"RTN","ZISUTL",5,0)
 I '$D(^TMP("XUDEVICE",$J,X)) S POP=1 Q
"RTN","ZISUTL",6,0)
 ;Cleanup first
"RTN","ZISUTL",7,0)
 N % K IO("S")
"RTN","ZISUTL",8,0)
 D SYMBOL("K") ;Kill first
"RTN","ZISUTL",9,0)
 D SYMBOL(1,$NA(^TMP("XUDEVICE",$J,X)))
"RTN","ZISUTL",10,0)
 ;F %="IO","IO(""S"")","IOS","IOT","IOBS","IOF","IOM","ION","IOSL","IOST","IOST(0)","IOXY" I $D(^TMP("XUDEVICE",$J,X,%))#2 S @%=^(%)
"RTN","ZISUTL",11,0)
 Q
"RTN","ZISUTL",12,0)
 ;
"RTN","ZISUTL",13,0)
SAVDEV(NM) ;Save IO variables
"RTN","ZISUTL",14,0)
 ;NM=Handle name
"RTN","ZISUTL",15,0)
 N %,Y,R
"RTN","ZISUTL",16,0)
 I $G(IO)="" Q
"RTN","ZISUTL",17,0)
 S Y=$$FINDEV(NM) I 'Y S Y=$$NEXTDEV(NM)
"RTN","ZISUTL",18,0)
 S R=$NA(^TMP("XUDEVICE",$J,Y)) K @R ;Clear
"RTN","ZISUTL",19,0)
 S @R@(0)=NM
"RTN","ZISUTL",20,0)
 D SYMBOL(0,R)
"RTN","ZISUTL",21,0)
 ;F %="IO","IO(""S"")","IOS","IOT","IOBS","IOF","IOM","ION","IOSL","IOST","IOST(0)","IOXY" I $D(@%)#2 S ^TMP("XUDEVICE",$J,Y,%)=@%
"RTN","ZISUTL",22,0)
 Q
"RTN","ZISUTL",23,0)
 ;
"RTN","ZISUTL",24,0)
SYMBOL(MODE,ROOT) ;0=Save, 1=Restore, K=Kill IO variables
"RTN","ZISUTL",25,0)
 N %
"RTN","ZISUTL",26,0)
 ;Handle IO as special case.  Don't want to kill all of IO.
"RTN","ZISUTL",27,0)
 I MODE=0 S:$D(IO)#2 @ROOT@("IO")=IO
"RTN","ZISUTL",28,0)
 I MODE=1 S:$D(@ROOT@("IO")) IO=@ROOT@("IO")
"RTN","ZISUTL",29,0)
 F %="IO(""DOC"")","IO(""HFSIO"")","IO(""Q"")","IO(""S"")","IO(""SPOOL"")","IO(""ZIO"")","IOBS","IOCPU","IOF","IOHG","IOM","ION","IOPAR","IOUPAR","IOS","IOSL","IOST","IOST(0)","IOT","IOXY" D
"RTN","ZISUTL",30,0)
 . I MODE=0 S:$D(@%)#2 @ROOT@(%)=@% Q
"RTN","ZISUTL",31,0)
 . I MODE=1 S:$D(@ROOT@(%)) @%=@ROOT@(%) Q
"RTN","ZISUTL",32,0)
 . I MODE="K" K @%
"RTN","ZISUTL",33,0)
 . Q
"RTN","ZISUTL",34,0)
 Q
"RTN","ZISUTL",35,0)
 ;
"RTN","ZISUTL",36,0)
RMDEV(X) ;Remove saved IO variables.
"RTN","ZISUTL",37,0)
 N Y
"RTN","ZISUTL",38,0)
 S Y=$$FINDEV(X)
"RTN","ZISUTL",39,0)
 Q:'Y
"RTN","ZISUTL",40,0)
 K ^TMP("XUDEVICE",$J,"B",X),^TMP("XUDEVICE",$J,+Y)
"RTN","ZISUTL",41,0)
 Q
"RTN","ZISUTL",42,0)
 ;
"RTN","ZISUTL",43,0)
RMALLDEV() ;Remove saved IO variables for all devices saved in table.
"RTN","ZISUTL",44,0)
 K ^TMP("XUDEVICE",$J)
"RTN","ZISUTL",45,0)
 Q 1
"RTN","ZISUTL",46,0)
 ;
"RTN","ZISUTL",47,0)
FINDEV(NM) ;Find Device name and return IEN.
"RTN","ZISUTL",48,0)
 Q $O(^TMP("XUDEVICE",$J,"B",NM,0))
"RTN","ZISUTL",49,0)
 ;
"RTN","ZISUTL",50,0)
NEXTDEV(NM) ;Return next available device.
"RTN","ZISUTL",51,0)
 N Y
"RTN","ZISUTL",52,0)
 F Y=1:1 Q:'$D(^TMP("XUDEVICE",$J,Y))
"RTN","ZISUTL",53,0)
 S ^TMP("XUDEVICE",$J,"B",NM,Y)=""
"RTN","ZISUTL",54,0)
 Q Y
"RTN","ZISUTL",55,0)
 ;
"RTN","ZISUTL",56,0)
OPEN(HNDL,IOP,%ZIS) ;Open extrinsic function
"RTN","ZISUTL",57,0)
 ;Parameters
"RTN","ZISUTL",58,0)
 ;HNDL=Handle name
"RTN","ZISUTL",59,0)
 ;IOP string--optional
"RTN","ZISUTL",60,0)
 ;%ZIS string--optional
"RTN","ZISUTL",61,0)
 N %
"RTN","ZISUTL",62,0)
 I $G(IOP)="" K IOP ;Remove IOP if null.
"RTN","ZISUTL",63,0)
 D ^%ZIS,SAVDEV(HNDL):POP=0
"RTN","ZISUTL",64,0)
 Q
"RTN","ZISUTL",65,0)
 ;
"RTN","ZISUTL",66,0)
CLOSE(X1) ;Close extrinsic functionsl
"RTN","ZISUTL",67,0)
 ;X1=Handle
"RTN","ZISUTL",68,0)
 N %,Y
"RTN","ZISUTL",69,0)
 S Y=$$FINDEV(X1)
"RTN","ZISUTL",70,0)
 Q:'Y
"RTN","ZISUTL",71,0)
 D GETDEV(Y)
"RTN","ZISUTL",72,0)
 D ^%ZISC,RMDEV(X1)
"RTN","ZISUTL",73,0)
 Q
"RTN","ZISUTL",74,0)
 ;
"RTN","ZISUTL",75,0)
USE(X1) ;Restore IO* variables pertaining to the device.
"RTN","ZISUTL",76,0)
 ;X1=Handle name
"RTN","ZISUTL",77,0)
 N %,Y
"RTN","ZISUTL",78,0)
 S Y=$$FINDEV^%ZISUTL(X1)
"RTN","ZISUTL",79,0)
 Q:'Y
"RTN","ZISUTL",80,0)
 D GETDEV^%ZISUTL(Y) U $S($D(IO(1,IO)):IO,1:IO(0))
"RTN","ZISUTL",81,0)
 Q
"RTN","ZISUTL",82,0)
 ;
"RTN","ZISUTL",83,0)
LINEPORT() ;Return device name for line port.
"RTN","ZISUTL",84,0)
 ;
"RTN","ZISUTL",85,0)
 N %,%1,Y
"RTN","ZISUTL",86,0)
 S Y=0
"RTN","ZISUTL",87,0)
 S %=$$LNPRTIEN^%ZISUTL($$LNPRTNAM^%ZISUTL)
"RTN","ZISUTL",88,0)
 S Y=+$P($G(^%ZIS(3.23,+%,0)),"^",3)
"RTN","ZISUTL",89,0)
 Q Y
"RTN","ZISUTL",90,0)
LNPRTSUB() ;Return line port subtype pointer.
"RTN","ZISUTL",91,0)
 N %
"RTN","ZISUTL",92,0)
 S %=$$LNPRTIEN^%ZISUTL($$LNPRTNAM^%ZISUTL)
"RTN","ZISUTL",93,0)
 Q +$P($G(^%ZIS(3.23,+%,0)),"^",4)
"RTN","ZISUTL",94,0)
 ;
"RTN","ZISUTL",95,0)
LNPRTNAM() ;Return Line port name
"RTN","ZISUTL",96,0)
 N Y,%
"RTN","ZISUTL",97,0)
 S Y="",%=$G(^%ZOSF("OS"))
"RTN","ZISUTL",98,0)
 I %["VAX DSM"!(%["OpenM-NT") D
"RTN","ZISUTL",99,0)
 .S Y=$ZIO
"RTN","ZISUTL",100,0)
 E  I %["MSM" X "S Y=$ZDEV($I)"
"RTN","ZISUTL",101,0)
 Q Y
"RTN","ZISUTL",102,0)
LNPRTIEN(X) ;Return internal entry number of Line/port
"RTN","ZISUTL",103,0)
 Q:X'?1AN.29ANP 0
"RTN","ZISUTL",104,0)
 Q $O(^%ZIS(3.23,"B",X,0))
"RTN","ZISUTL",105,0)
LNPRTADR(X) ;Returns Line/Port name of a fixed device.
"RTN","ZISUTL",106,0)
 N %,Y
"RTN","ZISUTL",107,0)
 S Y=""
"RTN","ZISUTL",108,0)
 S %=$O(^%ZIS(1,"B",X,0))
"RTN","ZISUTL",109,0)
 S %=$O(^%ZIS(3.23,"C",+%,0))
"RTN","ZISUTL",110,0)
 I %,$G(^%ZIS(3.23,+%,0))]"" S Y=$P(^(0),"^")
"RTN","ZISUTL",111,0)
 Q Y
"RTN","ZISUTL",112,0)
 ;
"RTN","ZISUTL",113,0)
FIND(IOP) ;e.f. Get the IEN of a device
"RTN","ZISUTL",114,0)
 N %XX,%YY,%ZIS,%ZISV
"RTN","ZISUTL",115,0)
 S %ZISV=^%ZOSF("VOL"),%XX=$$UP^%ZIS1(IOP) D 1^%ZIS5
"RTN","ZISUTL",116,0)
 Q %YY
"RTN","ZISUTL",117,0)
NOQ(IOP) ;e.f. Return queueing status
"RTN","ZISUTL",118,0)
 ;Call with Device name, Return 1 if NO QUEUE, Else 0.
"RTN","ZISUTL",119,0)
 N %X,%Y S %X=$$FIND(IOP) Q:%X'>0 0
"RTN","ZISUTL",120,0)
 S %Y=$P($G(^%ZIS(1,%X,0)),U,12)
"RTN","ZISUTL",121,0)
 Q %Y=2
"RTN","ZISUTL",122,0)
 ;
"RTN","ZISUTL",123,0)
UNIQUE(ZISNA) ;Build a unque number to add to a device name
"RTN","ZISUTL",124,0)
 ;If passed a name put the number before the last dot.
"RTN","ZISUTL",125,0)
 N %,%1
"RTN","ZISUTL",126,0)
 S %=$H,%=$H_"-"_$J,%=$$CRC32^XLFCRC(%)
"RTN","ZISUTL",127,0)
 I '$L($G(ZISNA)) Q %
"RTN","ZISUTL",128,0)
 S %1=$L(ZISNA,"."),%="_"_%
"RTN","ZISUTL",129,0)
 S:%1=1 %=ZISNA_% S:%1>1 %=$P(ZISNA,".",1,%1-1)_%_"."_$P(ZISNA,".",%1)
"RTN","ZISUTL",130,0)
 Q %
"RTN","ZJFOO")
0^29^B289360
"RTN","ZJFOO",1,0)
ZJFOO ;ISF/RWF - GTM Routine to JOB an arbitrary entry point ;5/9/2002
"RTN","ZJFOO",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","ZJFOO",3,0)
 ;To run under VMS,
"RTN","ZJFOO",4,0)
 ;  mumps ZJFOO.M
"RTN","ZJFOO",5,0)
 ;  link ZJFOO.OBJ
"RTN","ZJFOO",6,0)
 ;  In a com file
"RTN","ZJFOO",7,0)
 ;  $ forfoo="$" + f$parse("user$:[gtmmgr.r]ZJFOO.exe")
"RTN","ZJFOO",8,0)
 ;  $ forfoo "argument"
"RTN","ZJFOO",9,0)
 ;To run under Linux
"RTN","ZJFOO",10,0)
 ;  mumps ZJFOO.m
"RTN","ZJFOO",11,0)
 ;  chmod u+x,g+x ZJFOO.o
"RTN","ZJFOO",12,0)
 ;  In shell script
"RTN","ZJFOO",13,0)
 ;  $gtm_dist/mumps -run ZJFOO "argument"
"RTN","ZJFOO",14,0)
 ;
"RTN","ZJFOO",15,0)
 ;Set the interupt
"RTN","ZJFOO",16,0)
 S $ETRAP="D ^%ZTER HALT",$ZINTERRUPT="I $$JOBEXAM^ZU($ZPOSITION)"
"RTN","ZJFOO",17,0)
 I $L($ZCMDLINE) J @$ZCMDLINE Q
"RTN","ZJFOO",18,0)
 Q
"RTN","ZOSFGTM")
0^1^B21430649
"RTN","ZOSFGTM",1,0)
ZOSFGTM ;ISF/staff - ZOSF Table for GT.M for VMS ;10 Feb 2003 6:36 pm
"RTN","ZOSFGTM",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","ZOSFGTM",3,0)
 ; for GT.M for VMS, version 4.3
"RTN","ZOSFGTM",4,0)
 ;
"RTN","ZOSFGTM",5,0)
 S %Y=1,DTIME=$G(DTIME,600)
"RTN","ZOSFGTM",6,0)
 K ^%ZOSF("MASTER"),^%ZOSF("SIGNOFF")
"RTN","ZOSFGTM",7,0)
 I '$D(^%ZOSF("VOL")) S ^%ZOSF("VOL")="ROU"
"RTN","ZOSFGTM",8,0)
 K ZO F I="MGR","PROD","VOL" S:$D(^%ZOSF(I)) ZO(I)=^%ZOSF(I)
"RTN","ZOSFGTM",9,0)
 F I=1:2 S Z=$P($T(Z+I),";;",2) Q:Z=""  D
"RTN","ZOSFGTM",10,0)
 . S X=$P($T(Z+1+I),";;",2,99)
"RTN","ZOSFGTM",11,0)
 . S ^%ZOSF(Z)=$S($D(ZO(Z)):ZO(Z),1:X)
"RTN","ZOSFGTM",12,0)
 . Q
"RTN","ZOSFGTM",13,0)
 ;
"RTN","ZOSFGTM",14,0)
OS S ^%ZOSF("OS")="GT.M (VMS)^17"
"RTN","ZOSFGTM",15,0)
MGR W !,"NAME OF MANAGER'S UCI,VOLUME SET: "_^%ZOSF("MGR")_"// " R X:DTIME I X]"" X ^("UCICHECK") G MGR:0[Y S ^%ZOSF("MGR")=X
"RTN","ZOSFGTM",16,0)
PROD ;
"RTN","ZOSFGTM",17,0)
 W !,"The value of PRODUCTION will be used in the GETENV api."
"RTN","ZOSFGTM",18,0)
 W !,"PRODUCTION (SIGN-ON) UCI,VOLUME SET: "_^%ZOSF("PROD")_"// " R X:DTIME I X]"" X ^("UCICHECK") G PROD:0[Y S ^%ZOSF("PROD")=X
"RTN","ZOSFGTM",19,0)
 ;See that VOL and PROD agree.
"RTN","ZOSFGTM",20,0)
 I ^%ZOSF("PROD")'[^%ZOSF("VOL") S ^%ZOSF("VOL")=$P(^%ZOSF("PROD"),",",2)
"RTN","ZOSFGTM",21,0)
VOL W !,"The VOLUME name must match the one in PRODUCTION."
"RTN","ZOSFGTM",22,0)
 W !,"NAME OF VOLUME SET: "_^%ZOSF("VOL")_"//" R X:DTIME
"RTN","ZOSFGTM",23,0)
 I X]"" D  I X'?3U W "MUST BE 3 Upper case." G VOL
"RTN","ZOSFGTM",24,0)
 . I ^%ZOSF("PROD")'[X W !,"Must match PRODUCTION"
"RTN","ZOSFGTM",25,0)
 . S:X?3U ^%ZOSF("VOL")=X
"RTN","ZOSFGTM",26,0)
 W !,"^%ZOSF setup"
"RTN","ZOSFGTM",27,0)
 Q
"RTN","ZOSFGTM",28,0)
 ;
"RTN","ZOSFGTM",29,0)
Z ;
"RTN","ZOSFGTM",30,0)
 ;;ACTJ
"RTN","ZOSFGTM",31,0)
 ;;S Y=$$ACTJ^%ZOSV()
"RTN","ZOSFGTM",32,0)
 ;;AVJ
"RTN","ZOSFGTM",33,0)
 ;;S Y=$$AVJ^%ZOSV()
"RTN","ZOSFGTM",34,0)
 ;;BRK
"RTN","ZOSFGTM",35,0)
 ;;U $I:(CENABLE)
"RTN","ZOSFGTM",36,0)
 ;;DEL
"RTN","ZOSFGTM",37,0)
 ;;D DEL^%ZOSV2(X) ;N %DIR S %DIR=$P($ZRO,",") ZSYSTEM "DEL "_%DIR_X_".m;*" ZSYSTEM "DEL "_%DIR_X_".obj;*"
"RTN","ZOSFGTM",38,0)
 ;;EOFF
"RTN","ZOSFGTM",39,0)
 ;;U $I:(NOECHO)
"RTN","ZOSFGTM",40,0)
 ;;EON
"RTN","ZOSFGTM",41,0)
 ;;U $I:(ECHO)
"RTN","ZOSFGTM",42,0)
 ;;EOT
"RTN","ZOSFGTM",43,0)
 ;;S Y=$ZA\1024#2 ; <=====
"RTN","ZOSFGTM",44,0)
 ;;ERRTN
"RTN","ZOSFGTM",45,0)
 ;;^%ZTER
"RTN","ZOSFGTM",46,0)
 ;;ETRP
"RTN","ZOSFGTM",47,0)
 ;;Q
"RTN","ZOSFGTM",48,0)
 ;;GD
"RTN","ZOSFGTM",49,0)
 ;;G ^%GD
"RTN","ZOSFGTM",50,0)
 ;;$INC
"RTN","ZOSFGTM",51,0)
 ;;0
"RTN","ZOSFGTM",52,0)
 ;;JOBPARAM
"RTN","ZOSFGTM",53,0)
 ;;G JOBPAR^%ZOSV
"RTN","ZOSFGTM",54,0)
 ;;LABOFF
"RTN","ZOSFGTM",55,0)
 ;;U IO:(NOECHO)
"RTN","ZOSFGTM",56,0)
 ;;LOAD
"RTN","ZOSFGTM",57,0)
 ;;D LOAD^%ZOSV2(X) ;N % S %N=0 F XCNP=XCNP+1:1 S %N=%N+1,%=$T(+%N^@X) Q:$L(%)=0  S @(DIF_XCNP_",0)")=%
"RTN","ZOSFGTM",58,0)
 ;;LPC;;Longitudinal Parity Check (Exclusive OR of the 8-bit bytes)
"RTN","ZOSFGTM",59,0)
 ;;S Y=$$LPC^%ZOSV(X)
"RTN","ZOSFGTM",60,0)
 ;;MAGTAPE
"RTN","ZOSFGTM",61,0)
 ;;S %MT("BS")="*1",%MT("FS")="*2",%MT("WTM")="*3",%MT("WB")="*4",%MT("REW")="*5",%MT("RB")="*6",%MT("REL")="*7",%MT("WHL")="*8",%MT("WEL")="*9" ; <=====
"RTN","ZOSFGTM",62,0)
 ;;MAXSIZ
"RTN","ZOSFGTM",63,0)
 ;;Q
"RTN","ZOSFGTM",64,0)
 ;;MGR
"RTN","ZOSFGTM",65,0)
 ;;VAH,ROU
"RTN","ZOSFGTM",66,0)
 ;;MTBOT
"RTN","ZOSFGTM",67,0)
 ;;S Y=$ZA\32#2 ; <=====
"RTN","ZOSFGTM",68,0)
 ;;MTERR
"RTN","ZOSFGTM",69,0)
 ;;S Y=$ZA\32768#2 ; <=====
"RTN","ZOSFGTM",70,0)
 ;;MTONLINE
"RTN","ZOSFGTM",71,0)
 ;;S Y=$ZA\64#2 ; <=====
"RTN","ZOSFGTM",72,0)
 ;;MTWPROT
"RTN","ZOSFGTM",73,0)
 ;;S Y=$ZA\4#2 ; <=====
"RTN","ZOSFGTM",74,0)
 ;;NBRK
"RTN","ZOSFGTM",75,0)
 ;;U $I:(NOCENABLE)
"RTN","ZOSFGTM",76,0)
 ;;NO-PASSALL
"RTN","ZOSFGTM",77,0)
 ;;U $I:(NOPASTHRU)
"RTN","ZOSFGTM",78,0)
 ;;NO-TYPE-AHEAD
"RTN","ZOSFGTM",79,0)
 ;;U $I:(NOTYPEAHEAD)
"RTN","ZOSFGTM",80,0)
 ;;PASSALL
"RTN","ZOSFGTM",81,0)
 ;;U $I:(PASTHRU)
"RTN","ZOSFGTM",82,0)
 ;;PRIINQ
"RTN","ZOSFGTM",83,0)
 ;;S Y=$$PRIINQ^%ZOSV()
"RTN","ZOSFGTM",84,0)
 ;;PRIORITY
"RTN","ZOSFGTM",85,0)
 ;;Q  ;G PRIORITY^%ZOSV
"RTN","ZOSFGTM",86,0)
 ;;PROD
"RTN","ZOSFGTM",87,0)
 ;;VAH,ROU
"RTN","ZOSFGTM",88,0)
 ;;PROGMODE
"RTN","ZOSFGTM",89,0)
 ;;S Y=$$PROGMODE^%ZOSV()
"RTN","ZOSFGTM",90,0)
 ;;RD
"RTN","ZOSFGTM",91,0)
 ;;G ^%RD
"RTN","ZOSFGTM",92,0)
 ;;RESJOB
"RTN","ZOSFGTM",93,0)
 ;;Q:'$D(DUZ)  Q:'$D(^XUSEC("XUMGR",+DUZ))  W !!,"From VMS use: mupip stop /id=pid",!
"RTN","ZOSFGTM",94,0)
 ;;RM
"RTN","ZOSFGTM",95,0)
 ;;U $I:WIDTH=$S(X<256:X,1:0)
"RTN","ZOSFGTM",96,0)
 ;;RSEL
"RTN","ZOSFGTM",97,0)
 ;;N %ZR,X K ^UTILITY($J) D ^%RSEL S X="" X "F  S X=$O(%ZR(X)) Q:X=""""  S ^UTILITY($J,X)="""""
"RTN","ZOSFGTM",98,0)
 ;;RSUM
"RTN","ZOSFGTM",99,0)
 ;;S Y=0 F %=1,3:1 S %1=$T(+%^@X),%3=$F(%1," ") Q:'%3  S %3=$S($E(%1,%3)'=";":$L(%1),$E(%1,%3+1)=";":$L(%1),1:%3-2) F %2=1:1:%3 S Y=$A(%1,%2)*%2+Y
"RTN","ZOSFGTM",100,0)
 ;;SS
"RTN","ZOSFGTM",101,0)
 ;;D ^ZSY
"RTN","ZOSFGTM",102,0)
 ;;SAVE
"RTN","ZOSFGTM",103,0)
 ;;D SAVE^%ZOSV2(X) ;N %I,%F,SP S %I=$I,SP=" ",%F=$P($ZRO,",")_X_".m" O %F:(NEWVERSION) U %F X "F  S XCN=$O(@(DIE_XCN_"")"")) Q:XCN'>0  S %=@(DIE_XCN_"",0)"") Q:$E(%,1)=""$""  I $E(%)'="";"" W $P(%,SP)_$C(9)_$P(%,SP,2,99999),!" C %F U %I
"RTN","ZOSFGTM",104,0)
 ;;SIZE
"RTN","ZOSFGTM",105,0)
 ;;N %,I S Y=0 F I=1:1 S %=$T(+I^@X) Q:%=""  S Y=Y+$L(%)+2
"RTN","ZOSFGTM",106,0)
 ;;TEST
"RTN","ZOSFGTM",107,0)
 ;;I X]"",$L($$TEST^%ZOSV2(X))
"RTN","ZOSFGTM",108,0)
 ;;TMK
"RTN","ZOSFGTM",109,0)
 ;;S Y=$ZA\16384#2
"RTN","ZOSFGTM",110,0)
 ;;TRAP
"RTN","ZOSFGTM",111,0)
 ;;$ZT="G "_X
"RTN","ZOSFGTM",112,0)
 ;;TRMOFF
"RTN","ZOSFGTM",113,0)
 ;;U $I:(TERMINATOR="":NOPASTHRU:ESCAPE)
"RTN","ZOSFGTM",114,0)
 ;;TRMON
"RTN","ZOSFGTM",115,0)
 ;;U $I:(TERMINATOR=$C(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,127):NOESCAPE:PASTHRU)
"RTN","ZOSFGTM",116,0)
 ;;TRMRD
"RTN","ZOSFGTM",117,0)
 ;;S Y=$A($ZB)
"RTN","ZOSFGTM",118,0)
 ;;TYPE-AHEAD
"RTN","ZOSFGTM",119,0)
 ;;U $I:(TYPEAHEAD)
"RTN","ZOSFGTM",120,0)
 ;;UCI
"RTN","ZOSFGTM",121,0)
 ;;S Y=^%ZOSF("PROD")
"RTN","ZOSFGTM",122,0)
 ;;UCICHECK
"RTN","ZOSFGTM",123,0)
 ;;S Y=1
"RTN","ZOSFGTM",124,0)
 ;;UPPERCASE
"RTN","ZOSFGTM",125,0)
 ;;S Y=$TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","ZOSFGTM",126,0)
 ;;XY
"RTN","ZOSFGTM",127,0)
 ;;S $X=DX,$Y=DY
"RTN","ZOSFGTM",128,0)
 ;;VOL
"RTN","ZOSFGTM",129,0)
 ;;ROU
"RTN","ZOSFGTM",130,0)
 ;;ZD;;Input X, output Y.
"RTN","ZOSFGTM",131,0)
 ;;S Y=$ZDATE(X) ;$$HTE^XLFDT(X,2) I $L($P(Y,"/"))=1 S Y=0_Y
"RTN","ZOSFGUX")
0^2^B22086501
"RTN","ZOSFGUX",1,0)
ZOSFGUX ;SFISC/MVB,PUG/TOAD - ZOSF Table for GT.M for Unix ;10 Feb 2003 6:37 pm
"RTN","ZOSFGUX",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","ZOSFGUX",3,0)
 ;; for GT.M for Unix, version 4.3
"RTN","ZOSFGUX",4,0)
 ;
"RTN","ZOSFGUX",5,0)
 S %Y=1,DTIME=$G(DTIME,600)
"RTN","ZOSFGUX",6,0)
 K ^%ZOSF("MASTER"),^%ZOSF("SIGNOFF")
"RTN","ZOSFGUX",7,0)
 I '$D(^%ZOSF("VOL")) S ^%ZOSF("VOL")="ROU"
"RTN","ZOSFGUX",8,0)
 K ZO F I="MGR","PROD","VOL","TMP" S:$D(^%ZOSF(I)) ZO(I)=^%ZOSF(I)
"RTN","ZOSFGUX",9,0)
 F I=1:2 S Z=$P($T(Z+I),";;",2) Q:Z=""  S X=$P($T(Z+1+I),";;",2,99) S:Z="OS" $P(^%ZOSF(Z),"^")=X I Z'="OS" S ^%ZOSF(Z)=$S($D(ZO(Z)):ZO(Z),1:X)
"RTN","ZOSFGUX",10,0)
 ;
"RTN","ZOSFGUX",11,0)
OS S ^%ZOSF("OS")="GT.M (Unix)^19"
"RTN","ZOSFGUX",12,0)
 ;
"RTN","ZOSFGUX",13,0)
MGR W !,"NAME OF MANAGER'S UCI,VOLUME SET: "_^%ZOSF("MGR")_"// " R X:DTIME I X]"" X ^("UCICHECK") G MGR:0[Y S ^%ZOSF("MGR")=X
"RTN","ZOSFGUX",14,0)
PROD ;
"RTN","ZOSFGUX",15,0)
 W !,"The value of PRODUCTION will be used in the GETENV api."
"RTN","ZOSFGUX",16,0)
 W !,"PRODUCTION (SIGN-ON) UCI,VOLUME SET: "_^%ZOSF("PROD")_"// " R X:DTIME I X]"" X ^("UCICHECK") G PROD:0[Y S ^%ZOSF("PROD")=X
"RTN","ZOSFGUX",17,0)
 ;See that VOL and PROD agree.
"RTN","ZOSFGUX",18,0)
 I ^%ZOSF("PROD")'[^%ZOSF("VOL") S ^%ZOSF("VOL")=$P(^%ZOSF("PROD"),",",2)
"RTN","ZOSFGUX",19,0)
VOL W !,"The VOLUME name must match the one in PRODUCTION."
"RTN","ZOSFGUX",20,0)
 W !,"NAME OF VOLUME SET: "_^%ZOSF("VOL")_"//" R X:DTIME
"RTN","ZOSFGUX",21,0)
 I X]"" D  I X'?3U W "MUST BE 3 Upper case." G VOL
"RTN","ZOSFGUX",22,0)
 . I ^%ZOSF("PROD")'[X W !,"Must match PRODUCTION"
"RTN","ZOSFGUX",23,0)
 . S:X?3U ^%ZOSF("VOL")=X
"RTN","ZOSFGUX",24,0)
TMP ;Get the temp directory
"RTN","ZOSFGUX",25,0)
 W !,"The temp directory for the system: '"_^%ZOSF("TMP")_"'//"
"RTN","ZOSFGUX",26,0)
 R X:DTIME I $L(X),X'?1"/".E G TMP
"RTN","ZOSFGUX",27,0)
 I $L(X) S ^%ZOSF("TMP")=X
"RTN","ZOSFGUX",28,0)
 W !,"^%ZOSF setup"
"RTN","ZOSFGUX",29,0)
 Q
"RTN","ZOSFGUX",30,0)
 ;
"RTN","ZOSFGUX",31,0)
Z ;
"RTN","ZOSFGUX",32,0)
 ;;ACTJ
"RTN","ZOSFGUX",33,0)
 ;;S Y=$$ACTJ^%ZOSV()
"RTN","ZOSFGUX",34,0)
 ;;AVJ
"RTN","ZOSFGUX",35,0)
 ;;S Y=$$AVJ^%ZOSV()
"RTN","ZOSFGUX",36,0)
 ;;BRK
"RTN","ZOSFGUX",37,0)
 ;;U $I:(CENABLE)
"RTN","ZOSFGUX",38,0)
 ;;DEL
"RTN","ZOSFGUX",39,0)
 ;;N %RD,%OD S %RD=$P($S($ZRO["(":$P($P($ZRO,"(",2),")"),1:$ZRO)," ")_"/",%OD=$S($ZRO["(":$P($ZRO,"(",1)_"/",1:%RD) ZSYSTEM "rm -f "_%RD_X_".m" ZSYSTEM "rm -f "_%OD_X_".o"
"RTN","ZOSFGUX",40,0)
 ;;EOFF
"RTN","ZOSFGUX",41,0)
 ;;U $I:(NOECHO)
"RTN","ZOSFGUX",42,0)
 ;;EON
"RTN","ZOSFGUX",43,0)
 ;;U $I:(ECHO)
"RTN","ZOSFGUX",44,0)
 ;;EOT
"RTN","ZOSFGUX",45,0)
 ;;S Y=$ZA\1024#2 ; <=====
"RTN","ZOSFGUX",46,0)
 ;;ERRTN
"RTN","ZOSFGUX",47,0)
 ;;^%ZTER
"RTN","ZOSFGUX",48,0)
 ;;ETRP
"RTN","ZOSFGUX",49,0)
 ;;Q
"RTN","ZOSFGUX",50,0)
 ;;GD
"RTN","ZOSFGUX",51,0)
 ;;G ^%GD
"RTN","ZOSFGUX",52,0)
 ;;$INC
"RTN","ZOSFGUX",53,0)
 ;;0
"RTN","ZOSFGUX",54,0)
 ;;JOBPARAM
"RTN","ZOSFGUX",55,0)
 ;;G JOBPAR^%ZOSV
"RTN","ZOSFGUX",56,0)
 ;;LABOFF
"RTN","ZOSFGUX",57,0)
 ;;U IO:(NOECHO) ; <=====
"RTN","ZOSFGUX",58,0)
 ;;LOAD
"RTN","ZOSFGUX",59,0)
 ;;D LOAD^%ZOSV2(X) ;S %N=0 F XCNP=XCNP+1:1 S %N=%N+1,%=$T(+%N^@X) Q:$L(%)=0  S @(DIF_XCNP_",0)")=%
"RTN","ZOSFGUX",60,0)
 ;;LPC
"RTN","ZOSFGUX",61,0)
 ;;S Y="" ; <=====
"RTN","ZOSFGUX",62,0)
 ;;MAGTAPE
"RTN","ZOSFGUX",63,0)
 ;;S %MT("BS")="*1",%MT("FS")="*2",%MT("WTM")="*3",%MT("WB")="*4",%MT("REW")="*5",%MT("RB")="*6",%MT("REL")="*7",%MT("WHL")="*8",%MT("WEL")="*9" ; <=====
"RTN","ZOSFGUX",64,0)
 ;;MAXSIZ
"RTN","ZOSFGUX",65,0)
 ;;Q
"RTN","ZOSFGUX",66,0)
 ;;MGR
"RTN","ZOSFGUX",67,0)
 ;;VAH,ROU
"RTN","ZOSFGUX",68,0)
 ;;MTBOT
"RTN","ZOSFGUX",69,0)
 ;;S Y=$ZA\32#2 ; <=====
"RTN","ZOSFGUX",70,0)
 ;;MTERR
"RTN","ZOSFGUX",71,0)
 ;;S Y=$ZA\32768#2 ; <=====
"RTN","ZOSFGUX",72,0)
 ;;MTONLINE
"RTN","ZOSFGUX",73,0)
 ;;S Y=$ZA\64#2 ; <=====
"RTN","ZOSFGUX",74,0)
 ;;MTWPROT
"RTN","ZOSFGUX",75,0)
 ;;S Y=$ZA\4#2 ; <=====
"RTN","ZOSFGUX",76,0)
 ;;NBRK
"RTN","ZOSFGUX",77,0)
 ;;U $I:(NOCENABLE)
"RTN","ZOSFGUX",78,0)
 ;;NO-PASSALL
"RTN","ZOSFGUX",79,0)
 ;;U $I:(NOPASSTHRU)
"RTN","ZOSFGUX",80,0)
 ;;NO-TYPE-AHEAD
"RTN","ZOSFGUX",81,0)
 ;;U $I:(NOTYPEAHEAD)
"RTN","ZOSFGUX",82,0)
 ;;PASSALL
"RTN","ZOSFGUX",83,0)
 ;;U $I:(PASSTHRU)
"RTN","ZOSFGUX",84,0)
 ;;PRIINQ
"RTN","ZOSFGUX",85,0)
 ;;S Y=$$PRIINQ^%ZOSV()
"RTN","ZOSFGUX",86,0)
 ;;PRIORITY
"RTN","ZOSFGUX",87,0)
 ;;Q  ;G PRIORITY^%ZOSV
"RTN","ZOSFGUX",88,0)
 ;;PROD
"RTN","ZOSFGUX",89,0)
 ;;VAH,ROU
"RTN","ZOSFGUX",90,0)
 ;;PROGMODE
"RTN","ZOSFGUX",91,0)
 ;;S Y=$$PROGMODE^%ZOSV()
"RTN","ZOSFGUX",92,0)
 ;;RD
"RTN","ZOSFGUX",93,0)
 ;;G ^%RD
"RTN","ZOSFGUX",94,0)
 ;;RESJOB
"RTN","ZOSFGUX",95,0)
 ;;Q:'$D(DUZ)  Q:'$D(^XUSEC("XUMGR",+DUZ))  N XQZ S XQZ="^FORCEX[MGR]" D DO^%XUCI ; <=====
"RTN","ZOSFGUX",96,0)
 ;;RM
"RTN","ZOSFGUX",97,0)
 ;;U $I:WIDTH=$S(X<256:X,1:0)
"RTN","ZOSFGUX",98,0)
 ;;RSEL
"RTN","ZOSFGUX",99,0)
 ;;K ^UTILITY($J) D ^%RSEL S X="" X "F  S X=$O(%ZR(X)) Q:X=""""  S ^UTILITY($J,X)=""""" K %ZR
"RTN","ZOSFGUX",100,0)
 ;;RSUM
"RTN","ZOSFGUX",101,0)
 ;;S Y=0 F %=1,3:1 S %1=$T(+%^@X),%3=$F(%1," ") Q:'%3  S %3=$S($E(%1,%3)'=";":$L(%1),$E(%1,%3+1)=";":$L(%1),1:%3-2) F %2=1:1:%3 S Y=$A(%1,%2)*%2+Y
"RTN","ZOSFGUX",102,0)
 ;;SS
"RTN","ZOSFGUX",103,0)
 ;;D ^ZSY
"RTN","ZOSFGUX",104,0)
 ;;SAVE
"RTN","ZOSFGUX",105,0)
 ;;D SAVE^%ZOSV2(X) ;N %I,%F S %I=$I,%F=$P($S($ZRO["(":$P($P($ZRO,"(",2),")"),1:$ZRO)," ")_"/"_X_".m" O %F:(NEWVERSION) U %F X "F  S XCN=$O(@(DIE_XCN_"")"")) Q:+XCN'=XCN  S %=@(DIE_XCN_"",0)"") Q:$E(%,1)=""$""  I $E(%)'="";"" W %,!" C %F U %I
"RTN","ZOSFGUX",106,0)
 ;;SIZE
"RTN","ZOSFGUX",107,0)
 ;;S Y=0 F I=1:1 S %=$T(+I) Q:%=""  S Y=Y+$L(%)+2 ; <=====
"RTN","ZOSFGUX",108,0)
 ;;TEST
"RTN","ZOSFGUX",109,0)
 ;;I X]"",$T(^@X)]""
"RTN","ZOSFGUX",110,0)
 ;;TMK
"RTN","ZOSFGUX",111,0)
 ;;S Y=$ZA\16384#2
"RTN","ZOSFGUX",112,0)
 ;;TMP
"RTN","ZOSFGUX",113,0)
 ;;/tmp/
"RTN","ZOSFGUX",114,0)
 ;;TRAP
"RTN","ZOSFGUX",115,0)
 ;;$ZT="G "_X
"RTN","ZOSFGUX",116,0)
 ;;TRMOFF
"RTN","ZOSFGUX",117,0)
 ;;U $I:(TERMINATOR="")
"RTN","ZOSFGUX",118,0)
 ;;TRMON
"RTN","ZOSFGUX",119,0)
 ;;U $I:(TERMINATOR=$C(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,127))
"RTN","ZOSFGUX",120,0)
 ;;TRMRD
"RTN","ZOSFGUX",121,0)
 ;;S Y=$A($ZB)
"RTN","ZOSFGUX",122,0)
 ;;TYPE-AHEAD
"RTN","ZOSFGUX",123,0)
 ;;U $I:(TYPEAHEAD)
"RTN","ZOSFGUX",124,0)
 ;;UCI
"RTN","ZOSFGUX",125,0)
 ;;S Y=^%ZOSF("PROD")
"RTN","ZOSFGUX",126,0)
 ;;UCICHECK
"RTN","ZOSFGUX",127,0)
 ;;S Y=1
"RTN","ZOSFGUX",128,0)
 ;;UPPERCASE
"RTN","ZOSFGUX",129,0)
 ;;S Y=$TR(X,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","ZOSFGUX",130,0)
 ;;XY
"RTN","ZOSFGUX",131,0)
 ;;S $X=DX,$Y=DY ; <=====
"RTN","ZOSFGUX",132,0)
 ;;VOL
"RTN","ZOSFGUX",133,0)
 ;;ROU
"RTN","ZOSFGUX",134,0)
 ;;ZD
"RTN","ZOSFGUX",135,0)
 ;;S Y=$$HTE^XLFDT(X,2) I $L($P(Y,"/"))=1 S Y=0_Y
"RTN","ZOSV2GTM")
0^5^B4861009
"RTN","ZOSV2GTM",1,0)
%ZOSV2 ;ISF/RWF - More GT.M support routines ;11/06/2003  07:50
"RTN","ZOSV2GTM",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","ZOSV2GTM",3,0)
 Q
"RTN","ZOSV2GTM",4,0)
 ;SAVE: DIE open array reference.
"RTN","ZOSV2GTM",5,0)
 ;      XCN is the starting value to $O from.
"RTN","ZOSV2GTM",6,0)
SAVE(RN) ;Save a routine
"RTN","ZOSV2GTM",7,0)
 N %,%F,%I,%N,SP,$ETRAP
"RTN","ZOSV2GTM",8,0)
 S $ETRAP="S $ECODE="""" Q"
"RTN","ZOSV2GTM",9,0)
 S %I=$I,SP=" ",%F=$$RTNDIR^%ZOSV()_RN_".m"
"RTN","ZOSV2GTM",10,0)
 O %F:(newversion:noreadonly:blocksize=2048:recordsize=2044) U %F
"RTN","ZOSV2GTM",11,0)
 F  S XCN=$O(@(DIE_XCN_")")) Q:XCN'>0  S %=@(DIE_XCN_",0)") Q:$E(%,1)="$"  I $E(%)'=";" W $P(%,SP)_$C(9)_$P(%,SP,2,99999),!
"RTN","ZOSV2GTM",12,0)
 C %F ;S %N=$$NULL
"RTN","ZOSV2GTM",13,0)
 ZLINK RN
"RTN","ZOSV2GTM",14,0)
 ;C %N
"RTN","ZOSV2GTM",15,0)
 U %I
"RTN","ZOSV2GTM",16,0)
 Q
"RTN","ZOSV2GTM",17,0)
NULL() ;Open and use null to hide talking.  Return open name
"RTN","ZOSV2GTM",18,0)
 ;Doesn't work for compile errors
"RTN","ZOSV2GTM",19,0)
 N %N S %N=$S($ZV["VMS":"NLA0:",1:"/dev/nul")
"RTN","ZOSV2GTM",20,0)
 O %N U %N
"RTN","ZOSV2GTM",21,0)
 Q %N
"RTN","ZOSV2GTM",22,0)
 ;
"RTN","ZOSV2GTM",23,0)
DEL(RN) ;Delete a routine file, both source and object.
"RTN","ZOSV2GTM",24,0)
 N %N,%DIR,%I,$ETRAP
"RTN","ZOSV2GTM",25,0)
 S $ETRAP="S $ECODE="""" Q"
"RTN","ZOSV2GTM",26,0)
 S %I=$I,%DIR=$$RTNDIR^%ZOSV
"RTN","ZOSV2GTM",27,0)
 I $L($ZSEARCH(%DIR_RN_".m",244)) ZSYSTEM "DEL "_%DIR_X_".m;*"
"RTN","ZOSV2GTM",28,0)
 I $L($ZSEARCH(%DIR_RN_".obj",244)) ZSYSTEM "DEL "_%DIR_X_".obj;*"
"RTN","ZOSV2GTM",29,0)
 Q
"RTN","ZOSV2GTM",30,0)
 ;LOAD: DIF open array to receive the routine lines.
"RTN","ZOSV2GTM",31,0)
 ;      XCNP The starting index -1.
"RTN","ZOSV2GTM",32,0)
LOAD(RN) ;Load a routine
"RTN","ZOSV2GTM",33,0)
 N %
"RTN","ZOSV2GTM",34,0)
 S %N=0 F XCNP=XCNP+1:1 S %N=%N+1,%=$T(+%N^@RN) Q:$L(%)=0  S @(DIF_XCNP_",0)")=%
"RTN","ZOSV2GTM",35,0)
 Q
"RTN","ZOSV2GTM",36,0)
 ;
"RTN","ZOSV2GTM",37,0)
LOAD2(RN) ;Load a routine
"RTN","ZOSV2GTM",38,0)
 N %,%1,%F,%N,$ETRAP
"RTN","ZOSV2GTM",39,0)
 S %I=$I,%F=$$RTNDIR^%ZOSV()_$TR(RN,"%","_")_".m"
"RTN","ZOSV2GTM",40,0)
 O %F:(readonly):1 Q:'$T  U %F
"RTN","ZOSV2GTM",41,0)
 F XCNP=XCNP+1:1 R %1:1 Q:'$T!$ZEOF  S @(DIF_XCNP_",0)")=$TR(%1,$C(9)," ")
"RTN","ZOSV2GTM",42,0)
 C %F I $L(%I) U %I
"RTN","ZOSV2GTM",43,0)
 Q
"RTN","ZOSV2GTM",44,0)
 ;
"RTN","ZOSV2GTM",45,0)
RSUM(RN) ;Calculate a RSUM value
"RTN","ZOSV2GTM",46,0)
 N %,DIF,XCNP,%N,Y,$ETRAP K ^TMP("RSUM",$J)
"RTN","ZOSV2GTM",47,0)
 S $ETRAP="S $ECODE="""" Q"
"RTN","ZOSV2GTM",48,0)
 S Y=0,DIF="^TMP(""RSUM"",$J,",XCNP=0 D LOAD2(RN)
"RTN","ZOSV2GTM",49,0)
 F %=1,3:1 S %1=$G(^TMP("RSUM",$J,%,0)),%3=$F(%1," ") Q:'%3  S %3=$S($E(%1,%3)'=";":$L(%1),$E(%1,%3+1)=";":$L(%1),1:%3-2) F %2=1:1:%3 S Y=$A(%1,%2)*%2+Y
"RTN","ZOSV2GTM",50,0)
 K ^TMP("RSUM",$J)
"RTN","ZOSV2GTM",51,0)
 Q Y
"RTN","ZOSV2GTM",52,0)
 ;
"RTN","ZOSV2GTM",53,0)
TEST(RN) ;Special GT.M Test to see if routine is here.
"RTN","ZOSV2GTM",54,0)
 N %F,%X
"RTN","ZOSV2GTM",55,0)
 S %F=$$RTNDIR^%ZOSV()_$TR(RN,"%","_")_".m"
"RTN","ZOSV2GTM",56,0)
 S %X=$ZSEARCH("X.X",245),%X=$ZSEARCH(%F,245)
"RTN","ZOSV2GTM",57,0)
 Q %X
"RTN","ZOSVGTM")
0^6^B17497229
"RTN","ZOSVGTM",1,0)
%ZOSV ;ISF/STAFF - View commands & special functions (GT.M). ;05 Feb 2004 10:44 am
"RTN","ZOSVGTM",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","ZOSVGTM",3,0)
 ; for GT.M for VMS, version 4.3
"RTN","ZOSVGTM",4,0)
 ;
"RTN","ZOSVGTM",5,0)
ACTJ() ; # active jobs
"RTN","ZOSVGTM",6,0)
 ;Keep active count in global
"RTN","ZOSVGTM",7,0)
 Q $G(^XUTL("XUSYS","CNT"))
"RTN","ZOSVGTM",8,0)
 ;Long way that would work
"RTN","ZOSVGTM",9,0)
 ;N %IMAGE S %IMAGE=$ZGETJPI($J,"IMAGNAME")
"RTN","ZOSVGTM",10,0)
 ;N Y S Y=0
"RTN","ZOSVGTM",11,0)
 ;N %PID S %PID=0
"RTN","ZOSVGTM",12,0)
 ;F  S %PID=$ZPID(%PID) Q:'%PID  I $ZGETJPI(%PID,"IMAGNAME")=%IMAGE S Y=Y+1
"RTN","ZOSVGTM",13,0)
 ;Q Y
"RTN","ZOSVGTM",14,0)
 ;
"RTN","ZOSVGTM",15,0)
AVJ() ; # available jobs, Limit is in the OS.
"RTN","ZOSVGTM",16,0)
 N V,J
"RTN","ZOSVGTM",17,0)
 S V=^%ZOSF("VOL"),J=$G(^XTV(8989.3,"AMAX",V),100)
"RTN","ZOSVGTM",18,0)
 Q J-$$ACTJ ;Use signon Max
"RTN","ZOSVGTM",19,0)
 ;
"RTN","ZOSVGTM",20,0)
PASSALL ;
"RTN","ZOSVGTM",21,0)
 U $I:(PASTHRU) Q
"RTN","ZOSVGTM",22,0)
NOPASS ;
"RTN","ZOSVGTM",23,0)
 U $I:(NOPASTHRU) Q
"RTN","ZOSVGTM",24,0)
 ;
"RTN","ZOSVGTM",25,0)
GETPEER() ;Get the IP address of a connection peer
"RTN","ZOSVGTM",26,0)
 N PEER
"RTN","ZOSVGTM",27,0)
 S PEER=$ZTRNLNM("VISTA$IP")
"RTN","ZOSVGTM",28,0)
 Q $S($L(PEER):PEER,$L($G(IO("GTM-IP"))):IO("GTM-IP"),1:"")
"RTN","ZOSVGTM",29,0)
 ;
"RTN","ZOSVGTM",30,0)
PRGMODE ;
"RTN","ZOSVGTM",31,0)
 W ! S ZTPAC=$S($D(^VA(200,+DUZ,.1))#10:$P(^(.1),"^",5),1:""),XUVOL=^%ZOSF("VOL")
"RTN","ZOSVGTM",32,0)
 S X="" X ^%ZOSF("EOFF") R:ZTPAC]"" !,"PAC: ",X:60 D LC^XUS X ^%ZOSF("EON") I X'=ZTPAC W "??",*7 Q
"RTN","ZOSVGTM",33,0)
 K XMB,XMTEXT,XMY S XMB="XUPROGMODE",XMB(1)=DUZ,XMB(2)=$I D ^XMB:$L($T(^XMB)) D BYE^XUSCLEAN K ZTPAC,X,XMB
"RTN","ZOSVGTM",34,0)
 D UCI S XUCI=Y,XQZ="PRGM^ZUA[MGR]",XUSLNT=1 D DO^%XUCI
"RTN","ZOSVGTM",35,0)
 F  BREAK
"RTN","ZOSVGTM",36,0)
 HALT
"RTN","ZOSVGTM",37,0)
 ;
"RTN","ZOSVGTM",38,0)
PROGMODE() ;
"RTN","ZOSVGTM",39,0)
 Q 1 ; until we fix this, we're never in application mode
"RTN","ZOSVGTM",40,0)
 ;
"RTN","ZOSVGTM",41,0)
UCI ;
"RTN","ZOSVGTM",42,0)
 S Y="VAH,"_^%ZOSF("VOL") Q
"RTN","ZOSVGTM",43,0)
 ;
"RTN","ZOSVGTM",44,0)
UCICHECK(X) ;
"RTN","ZOSVGTM",45,0)
 Q 1
"RTN","ZOSVGTM",46,0)
 ;
"RTN","ZOSVGTM",47,0)
JOBPAR ;is job X valid on system, return UCI in Y.
"RTN","ZOSVGTM",48,0)
 N $ES,$ET,J S $ET="Q:$ES>0  S Y="""" G JOBPX^%ZOSV"
"RTN","ZOSVGTM",49,0)
 S Y=""
"RTN","ZOSVGTM",50,0)
 S J=$ZGETJPI(X,"PRI")
"RTN","ZOSVGTM",51,0)
 I $L(J) S Y=$P(^%ZOSF("PROD"),",")
"RTN","ZOSVGTM",52,0)
JOBPX S $EC=""
"RTN","ZOSVGTM",53,0)
 Q
"RTN","ZOSVGTM",54,0)
 ;
"RTN","ZOSVGTM",55,0)
SHARELIC(TYPE) ;Used by Cache implementations
"RTN","ZOSVGTM",56,0)
 Q
"RTN","ZOSVGTM",57,0)
 ;
"RTN","ZOSVGTM",58,0)
PRIORITY ;The VA has this disabled in general.
"RTN","ZOSVGTM",59,0)
 Q
"RTN","ZOSVGTM",60,0)
 ;
"RTN","ZOSVGTM",61,0)
PRIINQ() ;
"RTN","ZOSVGTM",62,0)
 N PRI S PRI=$ZGETJPI($J,"PRI")
"RTN","ZOSVGTM",63,0)
 Q $S(PRI=0:1,PRI=1:3,PRI=2:5,PRI=3:7,PRI=4:9,1:10)
"RTN","ZOSVGTM",64,0)
 ;
"RTN","ZOSVGTM",65,0)
BAUD S X="UNKNOWN" Q
"RTN","ZOSVGTM",66,0)
 ;
"RTN","ZOSVGTM",67,0)
LGR() Q $R ; Last global reference ($REFERENCE)
"RTN","ZOSVGTM",68,0)
 ;
"RTN","ZOSVGTM",69,0)
EC() ; Error Code: returning $ZS in format more like $ZE from DSM
"RTN","ZOSVGTM",70,0)
 N %ZE
"RTN","ZOSVGTM",71,0)
 I $ZS="" Q ""
"RTN","ZOSVGTM",72,0)
 S %ZE=$P($ZS,",",2)_","_$P($ZS,",",4)_","_$P($ZS,",")_",-"_$P($ZS,",",3)
"RTN","ZOSVGTM",73,0)
 Q %ZE
"RTN","ZOSVGTM",74,0)
 ;
"RTN","ZOSVGTM",75,0)
DOLRO ;SAVE ENTIRE SYMBOL TABLE IN LOCATION SPECIFIED BY X
"RTN","ZOSVGTM",76,0)
 S Y="%" F  S Y=$O(@Y) Q:Y=""  D
"RTN","ZOSVGTM",77,0)
 . I $D(@Y)#2 S @(X_"Y)="_Y)
"RTN","ZOSVGTM",78,0)
 . I $D(@Y)>9 S %X=Y_"(",%Y=X_"Y," D %XY^%RCR
"RTN","ZOSVGTM",79,0)
 K %X,%Y,Y Q
"RTN","ZOSVGTM",80,0)
 ;
"RTN","ZOSVGTM",81,0)
ORDER ;SAVE PARTS OF SYMBOL TABLE IN LOCATION SPECIFIED BY X
"RTN","ZOSVGTM",82,0)
 ;PARTS INDICATED BY X1("NAMESPACE*")="" ARRAY
"RTN","ZOSVGTM",83,0)
 I $D(X1("*"))#2 D DOLRO Q
"RTN","ZOSVGTM",84,0)
 S X1="" F  S X1=$O(X1(X1)) Q:X1=""  D
"RTN","ZOSVGTM",85,0)
 . S (Y,Y1)=$P(X1,"*") I $D(@Y)=0 F  S Y=$O(@Y) Q:Y=""!(Y[Y1)
"RTN","ZOSVGTM",86,0)
 . Q:Y=""  S %=$D(@Y) S:%#2 @(X_"Y)="_Y) I %>9 S %X=Y_"(",%Y=X_"Y," D %XY^%RCR
"RTN","ZOSVGTM",87,0)
 . F  S Y=$O(@Y) Q:Y=""!(Y'[Y1)  S %=$D(@Y) S:%#2 @(X_"Y)="_Y) I %>9 S %X=Y_"(",%Y=X_"Y," D %XY^%RCR
"RTN","ZOSVGTM",88,0)
 K %,%X,%Y,Y,Y1
"RTN","ZOSVGTM",89,0)
 Q
"RTN","ZOSVGTM",90,0)
 ;
"RTN","ZOSVGTM",91,0)
PARSIZ ;
"RTN","ZOSVGTM",92,0)
 S X=3 Q
"RTN","ZOSVGTM",93,0)
 ;
"RTN","ZOSVGTM",94,0)
NOLOG ;
"RTN","ZOSVGTM",95,0)
 S Y=0 Q
"RTN","ZOSVGTM",96,0)
 ;
"RTN","ZOSVGTM",97,0)
GETENV ;Get environment Return Y='UCI^VOL^NODE^BOX LOOKUP'
"RTN","ZOSVGTM",98,0)
 N %V,%HOST S %HOST=$ZGETSYI("NODENAME"),%V=^%ZOSF("PROD")
"RTN","ZOSVGTM",99,0)
 S Y=$TR(%V,",","^")_"^"_%HOST_"^"_$P(%V,",",2)_":"_%HOST
"RTN","ZOSVGTM",100,0)
 Q
"RTN","ZOSVGTM",101,0)
 ;
"RTN","ZOSVGTM",102,0)
VERSION(X) ;return OS version, X=1 - return OS
"RTN","ZOSVGTM",103,0)
 Q $S($G(X):$P($ZV," V"),1:+$P($ZV," V",2))
"RTN","ZOSVGTM",104,0)
 ;
"RTN","ZOSVGTM",105,0)
RTNDIR() ;
"RTN","ZOSVGTM",106,0)
 Q $P($ZRO,",")
"RTN","ZOSVGTM",107,0)
 ;
"RTN","ZOSVGTM",108,0)
SETNM(X) ;Set name, Trap dup's, Fall into SETENV
"RTN","ZOSVGTM",109,0)
 N $ETRAP S $ETRAP="S $ECODE="""" Q"
"RTN","ZOSVGTM",110,0)
 ;
"RTN","ZOSVGTM",111,0)
SETENV ;Set environment X='PROCESS NAME^ '
"RTN","ZOSVGTM",112,0)
 ;workaround for GT.M
"RTN","ZOSVGTM",113,0)
 S ^XUTL("XUSYS",$J,0)=$H,^("NM")=X,^("PID")=$$FUNC^%DH($J)
"RTN","ZOSVGTM",114,0)
 Q
"RTN","ZOSVGTM",115,0)
 ;
"RTN","ZOSVGTM",116,0)
SID() ;System ID
"RTN","ZOSVGTM",117,0)
 N J1,T S T="~"
"RTN","ZOSVGTM",118,0)
 S J1(1)=$ZROUTINES
"RTN","ZOSVGTM",119,0)
 S J1(2)=$ZGBLDIR
"RTN","ZOSVGTM",120,0)
 Q "1~"_J1(1)_T_J1(2)
"RTN","ZOSVGTM",121,0)
 ;
"RTN","ZOSVGTM",122,0)
T0 ; start RT clock <=====
"RTN","ZOSVGTM",123,0)
 Q  ; we don't have $ZH on GT.M
"RTN","ZOSVGTM",124,0)
 ;
"RTN","ZOSVGTM",125,0)
T1 ; store RT datum w/ZHDIF <=====
"RTN","ZOSVGTM",126,0)
 Q  ; we don't have $ZH on GT.M
"RTN","ZOSVGTM",127,0)
 ;
"RTN","ZOSVGTM",128,0)
ZHDIF ;Display dif of two $ZH's <=====
"RTN","ZOSVGTM",129,0)
 W !," CPU=",$J($P(%ZH1,",")-$P(%ZH0,","),6,2)
"RTN","ZOSVGTM",130,0)
 W ?14," ET=",$J($P(%ZH1,",",2)-$P(%ZH0,",",2),6,1)
"RTN","ZOSVGTM",131,0)
 W ?27," DIO=",$J($P(%ZH1,",",7)-$P(%ZH0,",",7),5)
"RTN","ZOSVGTM",132,0)
 W ?40," BIO=",$J($P(%ZH1,",",8)-$P(%ZH0,",",8),5),! ; so far this won't be called
"RTN","ZOSVGTM",133,0)
 Q
"RTN","ZOSVGTM",134,0)
 ;
"RTN","ZOSVGTM",135,0)
 ;Code moved to %ZOSVKR, Comment out if needed.
"RTN","ZOSVGTM",136,0)
LOGRSRC(OPT,TYPE,STATUS) ;record resource usage in ^XTMP("KMPR"
"RTN","ZOSVGTM",137,0)
 Q:'$G(^%ZTSCH("LOGRSRC"))  ; quit if RUM not turned on.
"RTN","ZOSVGTM",138,0)
 ; call to RUM routine.
"RTN","ZOSVGTM",139,0)
 D RU^%ZOSVKR($G(OPT),$G(TYPE),$G(STATUS))
"RTN","ZOSVGTM",140,0)
 Q
"RTN","ZOSVGTM",141,0)
 ;
"RTN","ZOSVGTM",142,0)
SETTRM(X) ;Turn on specified terminators.
"RTN","ZOSVGTM",143,0)
 U $I:TERM=X
"RTN","ZOSVGTM",144,0)
 Q 1
"RTN","ZOSVGTM",145,0)
 ;
"RTN","ZOSVGTM",146,0)
DEVOK ;
"RTN","ZOSVGTM",147,0)
 ;INPUT:  X=Device $I, X1=IOT -- X1 needed for resources
"RTN","ZOSVGTM",148,0)
 ;OUTPUT: Y=0 if available, Y=job # if owned
"RTN","ZOSVGTM",149,0)
 ; Y=-1 if device does not exists.
"RTN","ZOSVGTM",150,0)
 ; return Y=0 if not owned, Y=$J of owning job, Y=999 if dev cycling
"RTN","ZOSVGTM",151,0)
 ;
"RTN","ZOSVGTM",152,0)
 S Y=0,X1=$G(X1) Q:(X1="HFS")!(X1="MT")!(X1="CHAN")
"RTN","ZOSVGTM",153,0)
 I X1="RES" G RESOK^%ZIS6
"RTN","ZOSVGTM",154,0)
 S Y=0
"RTN","ZOSVGTM",155,0)
 Q  ;Let ZIS deal with it.
"RTN","ZOSVGTM",156,0)
 ;
"RTN","ZOSVGTM",157,0)
 Q
"RTN","ZOSVGTM",158,0)
LPC(X) ;ZCRC(X)
"RTN","ZOSVGTM",159,0)
 N R,I
"RTN","ZOSVGTM",160,0)
 S R=$ZBITSTR(8,0)
"RTN","ZOSVGTM",161,0)
 F I=1:1:$L(X) S R=$ZBITXOR(R,$C(0)_$E(X,I))
"RTN","ZOSVGTM",162,0)
 Q $A(R,2)
"RTN","ZOSVGUX")
0^7^B42854824
"RTN","ZOSVGUX",1,0)
%ZOSV ;SFISC/AC,PUG/TOAD,HOU/DHW - View commands & special functions. ;09/03/2003  15:34
"RTN","ZOSVGUX",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","ZOSVGUX",3,0)
 ;
"RTN","ZOSVGUX",4,0)
ACTJ() ; # active jobs
"RTN","ZOSVGUX",5,0)
 Q $G(^XUTL("XUSYS",0))
"RTN","ZOSVGUX",6,0)
 ;This would also work
"RTN","ZOSVGUX",7,0)
 N %FILE S %FILE=$$TEMP_"zosv_actj_"_$J_".tmp"
"RTN","ZOSVGUX",8,0)
 ZSYSTEM "ps cef -C mumps|wc>"_%FILE
"RTN","ZOSVGUX",9,0)
 N %I S %I=$I
"RTN","ZOSVGUX",10,0)
 O %FILE
"RTN","ZOSVGUX",11,0)
 U %FILE R Y U %I
"RTN","ZOSVGUX",12,0)
 C %FILE:DELETE
"RTN","ZOSVGUX",13,0)
 F  Q:$E(Y)'=" "  S $E(Y)=""
"RTN","ZOSVGUX",14,0)
 S Y=Y-1
"RTN","ZOSVGUX",15,0)
 Q Y
"RTN","ZOSVGUX",16,0)
 ;
"RTN","ZOSVGUX",17,0)
RTNDIR() ; primary routine source directory
"RTN","ZOSVGUX",18,0)
 ;Assume /home/xxx/o(/home/xxx/r /home/gtm)
"RTN","ZOSVGUX",19,0)
 Q $P($S($ZRO["(":$P($P($ZRO,"(",2),")"),1:$ZRO)," ")_"/"
"RTN","ZOSVGUX",20,0)
 ;
"RTN","ZOSVGUX",21,0)
TEMP() ; Return path to temp directory
"RTN","ZOSVGUX",22,0)
 ;N %TEMP S %TEMP=$P($$RTNDIR," "),%TEMP=$P(%TEMP,"/",1,$L(%TEMP,"/")-2)_"/t/"
"RTN","ZOSVGUX",23,0)
 Q $G(^%ZOSF("TMP"),"/tmp/")
"RTN","ZOSVGUX",24,0)
 ;
"RTN","ZOSVGUX",25,0)
AVJ() ; # available jobs
"RTN","ZOSVGUX",26,0)
 Q $G(^%ZTSCH("MAXJOBS"),1000)-$$ACTJ
"RTN","ZOSVGUX",27,0)
 ;
"RTN","ZOSVGUX",28,0)
PASSALL ;
"RTN","ZOSVGUX",29,0)
 U $I:(PASTHRU) Q  ; <=====
"RTN","ZOSVGUX",30,0)
NOPASS ;
"RTN","ZOSVGUX",31,0)
 U $I:(NOPASTHRU) Q  ; <=====
"RTN","ZOSVGUX",32,0)
 ;
"RTN","ZOSVGUX",33,0)
GETPEER() ;Get the IP address of a connection peer
"RTN","ZOSVGUX",34,0)
 Q $S($L($G(IO("GTM-IP"))):IO("GTM-IP"),1:"")
"RTN","ZOSVGUX",35,0)
 ;
"RTN","ZOSVGUX",36,0)
PRGMODE ; <=====
"RTN","ZOSVGUX",37,0)
 W ! S ZTPAC=$S($D(^VA(200,+DUZ,.1))#10:$P(^(.1),"^",5),1:""),XUVOL=^%ZOSF("VOL")
"RTN","ZOSVGUX",38,0)
 S X="" X ^%ZOSF("EOFF") R:ZTPAC]"" !,"PAC: ",X:60 D LC^XUS X ^%ZOSF("EON") I X'=ZTPAC W "??",*7 Q
"RTN","ZOSVGUX",39,0)
 K XMB,XMTEXT,XMY S XMB="XUPROGMODE",XMB(1)=DUZ,XMB(2)=$I D ^XMB:$L($T(^XMB)) D BYE^XUSCLEAN K ZTPAC,X,XMB
"RTN","ZOSVGUX",40,0)
 D UCI S XUCI=Y,XQZ="PRGM^ZUA[MGR]",XUSLNT=1 D DO^%XUCI B  ; then this used to ZESCAPE, but we need something new
"RTN","ZOSVGUX",41,0)
 E  S $ECODE=",<<PROG>>,"
"RTN","ZOSVGUX",42,0)
 ;
"RTN","ZOSVGUX",43,0)
PROGMODE() ; <=====
"RTN","ZOSVGUX",44,0)
 Q 1 ; until we fix this, we're never in application mode
"RTN","ZOSVGUX",45,0)
 ;
"RTN","ZOSVGUX",46,0)
UCI ;
"RTN","ZOSVGUX",47,0)
 S Y=^%ZOSF("PROD") Q
"RTN","ZOSVGUX",48,0)
 ;
"RTN","ZOSVGUX",49,0)
UCICHECK(X) ;
"RTN","ZOSVGUX",50,0)
 Q X
"RTN","ZOSVGUX",51,0)
 ;
"RTN","ZOSVGUX",52,0)
JOBPAR ; <=====
"RTN","ZOSVGUX",53,0)
 N %FILE S %FILE=$$PWD^%ZISH_"zosv_jobpar_"_$J_".tmp"
"RTN","ZOSVGUX",54,0)
 ZSYSTEM "ps c -p "_X_"|tail -1>"_%FILE
"RTN","ZOSVGUX",55,0)
 N %I S %I=$I
"RTN","ZOSVGUX",56,0)
 O %FILE
"RTN","ZOSVGUX",57,0)
 U %FILE R Y U %I
"RTN","ZOSVGUX",58,0)
 C %FILE:DELETE
"RTN","ZOSVGUX",59,0)
 F  Q:$E(Y)'=" "  S $E(Y)=""
"RTN","ZOSVGUX",60,0)
 I +Y=X,$E(Y,$L(Y)-4,$L(Y))="mumps" S Y="VAH,ROU"
"RTN","ZOSVGUX",61,0)
 E  S Y=""
"RTN","ZOSVGUX",62,0)
 Q
"RTN","ZOSVGUX",63,0)
 ;
"RTN","ZOSVGUX",64,0)
PRIORITY ; <=====
"RTN","ZOSVGUX",65,0)
 K Y ; Wally has this disabled in general, but I'd like to bring it back
"RTN","ZOSVGUX",66,0)
 Q
"RTN","ZOSVGUX",67,0)
 ;
"RTN","ZOSVGUX",68,0)
PRIINQ() ; <=====
"RTN","ZOSVGUX",69,0)
 Q 5 ; for now, we're always middle of the road
"RTN","ZOSVGUX",70,0)
 ;
"RTN","ZOSVGUX",71,0)
BAUD S X="UNKNOWN" Q
"RTN","ZOSVGUX",72,0)
 ;
"RTN","ZOSVGUX",73,0)
LGR() ; Last global reference ($REFERENCE)
"RTN","ZOSVGUX",74,0)
 Q $R
"RTN","ZOSVGUX",75,0)
 ;
"RTN","ZOSVGUX",76,0)
EC() ; Error Code: returning $ZS in format more like $ZE from DSM
"RTN","ZOSVGUX",77,0)
 N %ZE
"RTN","ZOSVGUX",78,0)
 I $ZS="" S %ZE=""
"RTN","ZOSVGUX",79,0)
 S %ZE=$P($ZS,",",2)_","_$P($ZS,",",4)_","_$P($ZS,",")_",-"_$P($ZS,",",3)
"RTN","ZOSVGUX",80,0)
 Q %ZE
"RTN","ZOSVGUX",81,0)
 ;
"RTN","ZOSVGUX",82,0)
DOLRO ;SAVE ENTIRE SYMBOL TABLE IN LOCATION SPECIFIED BY X
"RTN","ZOSVGUX",83,0)
 S Y="%" F  S Y=$O(@Y) Q:Y=""  D  ;code from DEC
"RTN","ZOSVGUX",84,0)
 . I $D(@Y)#2 S @(X_"Y)="_Y)
"RTN","ZOSVGUX",85,0)
 . I $D(@Y)>9 S %X=Y_"(",%Y=X_"Y," D %XY^%RCR
"RTN","ZOSVGUX",86,0)
 K %X,%Y,Y Q
"RTN","ZOSVGUX",87,0)
 ;
"RTN","ZOSVGUX",88,0)
ORDER ;SAVE PARTS OF SYMBOL TABLE IN LOCATION SPECIFIED BY X
"RTN","ZOSVGUX",89,0)
 ;PARTS INDICATED BY X1("NAMESPACE*")="" ARRAY
"RTN","ZOSVGUX",90,0)
 I $D(X1("*"))#2 D DOLRO Q
"RTN","ZOSVGUX",91,0)
 S X1="" F  S X1=$O(X1(X1)) Q:X1=""  D
"RTN","ZOSVGUX",92,0)
 . S (Y,Y1)=$P(X1,"*") I $D(@Y)=0 F  S Y=$O(@Y) Q:Y=""!(Y[Y1)
"RTN","ZOSVGUX",93,0)
 . Q:Y=""  S %=$D(@Y) S:%#2 @(X_"Y)="_Y) I %>9 S %X=Y_"(",%Y=X_"Y," D %XY^%RCR
"RTN","ZOSVGUX",94,0)
 . F  S Y=$O(@Y) Q:Y=""!(Y'[Y1)  S %=$D(@Y) S:%#2 @(X_"Y)="_Y) I %>9 S %X=Y_"(",%Y=X_"Y," D %XY^%RCR
"RTN","ZOSVGUX",95,0)
 K %,%X,%Y,Y,Y1
"RTN","ZOSVGUX",96,0)
 Q
"RTN","ZOSVGUX",97,0)
 ;
"RTN","ZOSVGUX",98,0)
PARSIZ ;
"RTN","ZOSVGUX",99,0)
 S X=3 Q
"RTN","ZOSVGUX",100,0)
 ;
"RTN","ZOSVGUX",101,0)
NOLOG ;
"RTN","ZOSVGUX",102,0)
 S Y=0 Q
"RTN","ZOSVGUX",103,0)
 ;
"RTN","ZOSVGUX",104,0)
GETENV ;Get environment Return Y='UCI^VOL^NODE^BOX LOOKUP'
"RTN","ZOSVGUX",105,0)
 N %HOST,%V S %V=^%ZOSF("PROD"),%HOST=$$RETURN("hostname -s")
"RTN","ZOSVGUX",106,0)
 S Y=$TR(%V,",","^")_"^"_%HOST_"^"_$P(%V,",",2)_":"_%HOST
"RTN","ZOSVGUX",107,0)
 Q
"RTN","ZOSVGUX",108,0)
 ;
"RTN","ZOSVGUX",109,0)
VERSION(X) ;return OS version, X=1 - return OS
"RTN","ZOSVGUX",110,0)
 Q $S($G(X):$P($ZV," V"),1:+$P($ZV," V",2))
"RTN","ZOSVGUX",111,0)
 ;
"RTN","ZOSVGUX",112,0)
SETNM(X) ;Set name, Trap dup's, Fall into SETENV
"RTN","ZOSVGUX",113,0)
 N $ETRAP S $ETRAP="S $ECODE="""" Q"
"RTN","ZOSVGUX",114,0)
 ;
"RTN","ZOSVGUX",115,0)
SETENV ;Set environment X='PROCESS NAME^ '
"RTN","ZOSVGUX",116,0)
 S ^XUTL("XUSYS",$J,0)=$H,^("NM")=X ; workaround
"RTN","ZOSVGUX",117,0)
 Q
"RTN","ZOSVGUX",118,0)
 ;
"RTN","ZOSVGUX",119,0)
SID() ;System ID
"RTN","ZOSVGUX",120,0)
 N J1,T S T="~"
"RTN","ZOSVGUX",121,0)
 S J1(1)=$ZROUTINES,J1(1)=$P(J1(1)," ")
"RTN","ZOSVGUX",122,0)
 S J1(2)=$ZGBLDIR
"RTN","ZOSVGUX",123,0)
 Q "1~"_J1(1)_T_J1(2)
"RTN","ZOSVGUX",124,0)
 ;
"RTN","ZOSVGUX",125,0)
T0 ; start RT clock <=====
"RTN","ZOSVGUX",126,0)
 Q  ; we don't have $ZH on GT.M
"RTN","ZOSVGUX",127,0)
 ;
"RTN","ZOSVGUX",128,0)
T1 ; store RT datum w/ZHDIF <=====
"RTN","ZOSVGUX",129,0)
 Q  ; we don't have $ZH on GT.M
"RTN","ZOSVGUX",130,0)
 ;
"RTN","ZOSVGUX",131,0)
ZHDIF ;Display dif of two $ZH's <=====
"RTN","ZOSVGUX",132,0)
 W !," CPU=",$J($P(%ZH1,",")-$P(%ZH0,","),6,2)
"RTN","ZOSVGUX",133,0)
 W ?14," ET=",$J($P(%ZH1,",",2)-$P(%ZH0,",",2),6,1)
"RTN","ZOSVGUX",134,0)
 W ?27," DIO=",$J($P(%ZH1,",",7)-$P(%ZH0,",",7),5)
"RTN","ZOSVGUX",135,0)
 W ?40," BIO=",$J($P(%ZH1,",",8)-$P(%ZH0,",",8),5),! ; so far this won't be called
"RTN","ZOSVGUX",136,0)
 Q
"RTN","ZOSVGUX",137,0)
 ;
"RTN","ZOSVGUX",138,0)
 ;Code moved to %ZOSVKR, Comment out if needed.
"RTN","ZOSVGUX",139,0)
LOGRSRC(OPT,TYPE,STATUS) ;record resource usage in ^XTMP("KMPR"
"RTN","ZOSVGUX",140,0)
 Q:'$G(^%ZTSCH("LOGRSRC"))  ; quit if RUM not turned on.
"RTN","ZOSVGUX",141,0)
 ; call to RUM routine.
"RTN","ZOSVGUX",142,0)
 D RU^%ZOSVKR($G(OPT),$G(TYPE),$G(STATUS))
"RTN","ZOSVGUX",143,0)
 Q
"RTN","ZOSVGUX",144,0)
 ;
"RTN","ZOSVGUX",145,0)
SETTRM(X) ;Turn on specified terminators.
"RTN","ZOSVGUX",146,0)
 U $I:(TERM=X)
"RTN","ZOSVGUX",147,0)
 Q 1
"RTN","ZOSVGUX",148,0)
 ;
"RTN","ZOSVGUX",149,0)
DEVOK ;
"RTN","ZOSVGUX",150,0)
 ;use lsof (list open files)
"RTN","ZOSVGUX",151,0)
 ; given a device name in X
"RTN","ZOSVGUX",152,0)
 ;INPUT:  X=Device $I, X1=IOT -- X1 needed for resources
"RTN","ZOSVGUX",153,0)
 ;OUTPUT: Y=0 if available, Y=job # if owned
"RTN","ZOSVGUX",154,0)
 ; Y=-1 if device does not exists.
"RTN","ZOSVGUX",155,0)
 ; return Y=0 if not owned, Y=$J of owning job, Y=999 if dev cycling
"RTN","ZOSVGUX",156,0)
 ;
"RTN","ZOSVGUX",157,0)
 I $G(X1)="RES" G RESOK^%ZIS6
"RTN","ZOSVGUX",158,0)
 S Y=0
"RTN","ZOSVGUX",159,0)
 Q  ;Let ZIS deal with it.
"RTN","ZOSVGUX",160,0)
 ;
"RTN","ZOSVGUX",161,0)
 N %FILE S %FILE=$$TEMP_"zosv_devok_"_$J_".tmp"
"RTN","ZOSVGUX",162,0)
 ZSYSTEM "/usr/sbin/lsof -F Pc "_X_" >"_%FILE
"RTN","ZOSVGUX",163,0)
 N %I,%X,%Y S %I=$I
"RTN","ZOSVGUX",164,0)
 O %FILE
"RTN","ZOSVGUX",165,0)
 N %I,%X,%Y S %I=$I
"RTN","ZOSVGUX",166,0)
 U %FILE
"RTN","ZOSVGUX",167,0)
 F %Y=0:1 R %X Q:%X=""  Q:%X["lsof: status error"  D
"RTN","ZOSVGUX",168,0)
 . S %Y(%Y\2,$S($E(%X)="p":"PID",$E(%X)="c":"CMD",1:"?"))=$E(%X,2,$L(%X))
"RTN","ZOSVGUX",169,0)
 U %I
"RTN","ZOSVGUX",170,0)
 C %FILE:(DELETE)
"RTN","ZOSVGUX",171,0)
 I %X["lsof: status error" S Y=-1 Q
"RTN","ZOSVGUX",172,0)
 S %X="",Y=0
"RTN","ZOSVGUX",173,0)
 F  S %X=$O(%Y(%X)) Q:%X=""  I %Y(%X,"CMD")="mumps" S Y=%Y(%X,"PID") Q
"RTN","ZOSVGUX",174,0)
 Q
"RTN","ZOSVGUX",175,0)
 ;
"RTN","ZOSVGUX",176,0)
PIDOPN ; give a list of of all JOBS that have the current device open
"RTN","ZOSVGUX",177,0)
 ; returns comma separated in Y
"RTN","ZOSVGUX",178,0)
 N %FILE S %FILE=$$TEMP_"zosv_pidopn_"_$J_".tmp"
"RTN","ZOSVGUX",179,0)
 ZSYSTEM "lsof -F Pc "_$I_" >"_%FILE
"RTN","ZOSVGUX",180,0)
 N %I,%X,%Y S %I=$I
"RTN","ZOSVGUX",181,0)
 O %FILE
"RTN","ZOSVGUX",182,0)
 N %I,%X,%Y S %I=$I
"RTN","ZOSVGUX",183,0)
 U %FILE
"RTN","ZOSVGUX",184,0)
 F %Y=0:1 R %X Q:%X=""  S %Y(%Y\2,$S($E(%X)="p":"PID",$E(%X)="c":"CMD",1:"?"))=$E(%X,2,$L(%X))
"RTN","ZOSVGUX",185,0)
 U %I
"RTN","ZOSVGUX",186,0)
 C %FILE:(DELETE)
"RTN","ZOSVGUX",187,0)
 S (Y,%X)="" F  S %X=$O(%Y(%X)) Q:%X=""  I %Y(%X,"CMD")="mumps" S Y=Y_","_%Y(%X,"PID")
"RTN","ZOSVGUX",188,0)
 Q
"RTN","ZOSVGUX",189,0)
 ;
"RTN","ZOSVGUX",190,0)
DEVOPN ;List of Devices opened
"RTN","ZOSVGUX",191,0)
 ;Returns variable Y. Y=Devices owned separated by a comma
"RTN","ZOSVGUX",192,0)
 ; ZSHOW "D":Y
"RTN","ZOSVGUX",193,0)
 N %FILE S %FILE=$$TEMP_"zosv_devopn_"_$J_".tmp"
"RTN","ZOSVGUX",194,0)
 ZSYSTEM "lsof -F n -p "_$J_" >"_%FILE
"RTN","ZOSVGUX",195,0)
 N %I,%X,%Y S %I=$I
"RTN","ZOSVGUX",196,0)
 O %FILE
"RTN","ZOSVGUX",197,0)
 U %FILE
"RTN","ZOSVGUX",198,0)
 F %Y=0:1 R %X Q:%X=""  S %Y($S($E(%X)="p":"PID",$E(%X)="n":%Y,1:"?"))=$E(%X,2,$L(%X))
"RTN","ZOSVGUX",199,0)
 U %I
"RTN","ZOSVGUX",200,0)
 C %FILE:(DELETE)
"RTN","ZOSVGUX",201,0)
 I %Y("PID")'=$J S Y="" Q
"RTN","ZOSVGUX",202,0)
 I $D(%Y("?")) S Y="" Q
"RTN","ZOSVGUX",203,0)
 K %Y("PID"),%Y("?")
"RTN","ZOSVGUX",204,0)
 S (Y,%X)="" F  S %X=$O(%Y(%X)) Q:%X=""  S Y=Y_","_%Y(%X)
"RTN","ZOSVGUX",205,0)
 Q
"RTN","ZOSVGUX",206,0)
 ;
"RTN","ZOSVGUX",207,0)
RETURN(%COMMAND) ; ** Private Entry Point: execute a shell command & return the resulting value **
"RTN","ZOSVGUX",208,0)
 ;
"RTN","ZOSVGUX",209,0)
 ; %COMMAND is the string value of the Linux command
"RTN","ZOSVGUX",210,0)
 N %VALUE S %VALUE="" ; value to return
"RTN","ZOSVGUX",211,0)
 N %FILE S %FILE=$$TEMP_"RET"_$J_".txt" ; temporary results file
"RTN","ZOSVGUX",212,0)
 ZSYSTEM %COMMAND_" > "_%FILE ; execute command & save result
"RTN","ZOSVGUX",213,0)
 O %FILE:(REWIND) U %FILE R:'$ZEOF %VALUE C %FILE:(DELETE) ; fetch value & delete file
"RTN","ZOSVGUX",214,0)
 ;
"RTN","ZOSVGUX",215,0)
 QUIT %VALUE ; return value
"RTN","ZOSVGUX",216,0)
 ;
"RTN","ZOSVGUX",217,0)
 ;
"RTN","ZOSVGUX",218,0)
STRIPCR(%DIRECTORY) ; ** Private Entry Point: strip extraneous CR from end of lines of all
"RTN","ZOSVGUX",219,0)
 ; routines in %DIRECTORY Linux directory
"RTN","ZOSVGUX",220,0)
 ;
"RTN","ZOSVGUX",221,0)
 ZSYSTEM "perl -pi -e 's/\r\n$/\n/' "_%DIRECTORY_"[A-K]*.m"
"RTN","ZOSVGUX",222,0)
 ZSYSTEM "perl -pi -e 's/\r\n$/\n/' "_%DIRECTORY_"[L-S]*.m"
"RTN","ZOSVGUX",223,0)
 ZSYSTEM "perl -pi -e 's/\r\n$/\n/' "_%DIRECTORY_"[T-z]*.m"
"RTN","ZOSVGUX",224,0)
 ZSYSTEM "perl -pi -e 's/\r\n$/\n/' "_%DIRECTORY_"[_]*.m"
"RTN","ZOSVGUX",225,0)
 Q
"RTN","ZOSVGUX",226,0)
 ;
"RTN","ZTER")
0^32^B40614789
"RTN","ZTER",1,0)
%ZTER ; ISC-SF.SEA/JLI - ERROR TRAP TO LOG ERRORS ;06/28/2004  12:57
"RTN","ZTER",2,0)
 ;;8.0;KERNEL;**8,18,32,24,36,63,73,79,86,112,118,162,275**;JUL 10, 1995
"RTN","ZTER",3,0)
 S ^TMP("$ZE",$J,1)=$$LGR^%ZOSV
"RTN","ZTER",4,0)
 S ^TMP("$ZE",$J,0)=$$EC^%ZOSV ;$S(^%ZOSF("OS")["GT.M":$ZS,1:$ZE)
"RTN","ZTER",5,0)
 S ^TMP("$ZE",$J,2)=$ETRAP,$ETRAP="D ERR^%ZTER"
"RTN","ZTER",6,0)
 I (^TMP("$ZE",$J,0)["-ALLOC,")!(^TMP("$ZE",$J,0)["<STORE>")!(^TMP("$ZE",$J,0)["-MEMORY") D
"RTN","ZTER",7,0)
 . I '$D(XUALLOC) D
"RTN","ZTER",8,0)
 . . K (%ZTERLGR,DUZ,DT,DISYS,IO,IOBS,IOF,IOM,ION,IOSL,IOST,IOT,IOS,IOXY,U,XRTL,XQVOL,XQY,XQY0,XQDIC,XQPSM,XQPT,XQAUDIT,XQXFLG,ZTSTOP,ZTQUEUED,ZTREQ,DA,D0,DI,DIC,DIE)
"RTN","ZTER",9,0)
 . S %ZTER12A="ALLOC"
"RTN","ZTER",10,0)
 K XUALLOC
"RTN","ZTER",11,0)
 S %ZTERZE=^TMP("$ZE",$J,0),%ZT("^XUTL(""XQ"",$J)")="" S:'$D(%ZTERLGR) %ZTERLGR=^TMP("$ZE",$J,1)
"RTN","ZTER",12,0)
 G:$$SCREEN(%ZTERZE,1) EXIT ;Let site screen errors, count don't show
"RTN","ZTER",13,0)
 ;Get a record.
"RTN","ZTER",14,0)
 S %ZTERH1=+$H L +^%ZTER(1,%ZTERH1,0):15
"RTN","ZTER",15,0)
 S %ZTER11N=$P($G(^%ZTER(1,%ZTERH1,0)),"^",2)+1,^%ZTER(1,%ZTERH1,0)=%ZTERH1_"^"_%ZTER11N,^(1,0)="^3.0751^"_%ZTER11N_"^"_%ZTER11N
"RTN","ZTER",16,0)
 I %ZTER11N=1 S ^%ZTER(1,0)=$P(^%ZTER(1,0),"^",1,2)_"^"_%ZTERH1_"^"_($P(^%ZTER(1,0),"^",4)+1)
"RTN","ZTER",17,0)
 L -^%ZTER(1,%ZTERH1,0)
"RTN","ZTER",18,0)
 S %ZTERRT=$NA(^%ZTER(1,%ZTERH1,1,%ZTER11N))
"RTN","ZTER",19,0)
 S @%ZTERRT@(0)=%ZTER11N,^("ZE")=%ZTERZE S:$D(%ZTERLGR) ^("GR")=%ZTERLGR K %ZTERLGR
"RTN","ZTER",20,0)
 S %ZTER11B="" F %ZTER11I=1:1:$L($ZB) S %ZTER11A=$E($ZB,%ZTER11I),%ZTER11B=%ZTER11B_$S(%ZTER11A?1C:$C($A(%ZTER11A)+32#128),1:%ZTER11A)
"RTN","ZTER",21,0)
 S %ZTER11I="" I $D(^%ZOSF("UCI")) K %ZTER11A S:$D(Y) %ZTER11A="" S:($D(Y)#2) %ZTER11A=Y X ^%ZOSF("UCI") S %ZTER11I=Y K:'$D(%ZTER11A) Y S:$D(%ZTER11A) Y=%ZTER11A
"RTN","ZTER",22,0)
 S @%ZTERRT@("H")=$H,^("J")=$J_"^^^"_%ZTER11I_"^"_$J
"RTN","ZTER",23,0)
 S @%ZTERRT@("I")=$I_"^"_$S($I[":":$ZA,1:"")_"^"_%ZTER11B_"^"_$G(IO("ZIO"))_"^"_$X_"^"_$Y
"RTN","ZTER",24,0)
 S %ZTERROR=$$ETXT
"RTN","ZTER",25,0)
 S %ZTERCNT=0 D STACK^%ZTER1
"RTN","ZTER",26,0)
 D SAVE("$X $Y",$X_" "_$Y)
"RTN","ZTER",27,0)
 D SAVE("$DEVICE",$DEVICE)
"RTN","ZTER",28,0)
 D SAVE("$ZV",$ZV)
"RTN","ZTER",29,0)
 I ^%ZOSF("OS")["OpenM" D SAVE("$ZU(56,2)",$ZU(56,2))
"RTN","ZTER",30,0)
 I ^%ZOSF("OS")["VAX DSM" K %ZTER11A,%ZTER11B D VXD^%ZTER1 I 1
"RTN","ZTER",31,0)
 E  D
"RTN","ZTER",32,0)
 . S %ZTERVAR="%" D:$D(%) VAR:$D(%)#2,SUBS:$D(%)>9
"RTN","ZTER",33,0)
 . F %ZTER11Z=0:0 S %ZTERVAR=$O(@%ZTERVAR) Q:%ZTERVAR=""  D VAR:$D(@%ZTERVAR)#2,SUBS:$D(@%ZTERVAR)>9
"RTN","ZTER",34,0)
 D GLOB
"RTN","ZTER",35,0)
 S:%ZTERCNT>0 @%ZTERRT@("ZV",0)="^3.0752^"_%ZTERCNT_"^"_%ZTERCNT
"RTN","ZTER",36,0)
 S:'$D(^%ZTER(1,"B",%ZTERH1)) ^(%ZTERH1,%ZTERH1)=""
"RTN","ZTER",37,0)
 S ^%ZTER(1,%ZTERH1,1,"B",%ZTER11N,%ZTER11N)=""
"RTN","ZTER",38,0)
LIN ;Find the line of the error
"RTN","ZTER",39,0)
 S %ZTERY=$P(%ZTERZE,","),%ZTERX=$P(%ZTERY,"^") S:%ZTERX[">" %ZTERX=$P(%ZTERX,">",2)
"RTN","ZTER",40,0)
 I %ZTERX'="" D
"RTN","ZTER",41,0)
 . N X,XCNP,DIF K ^TMP($J,"XTER1")
"RTN","ZTER",42,0)
 . S X=$P($P(%ZTERY,"^",2),":") Q:X=""  X ^%ZOSF("TEST") Q:'$T
"RTN","ZTER",43,0)
 . S XCNP=0,DIF="^TMP($J,""XTER1""," X ^%ZOSF("LOAD") S %ZTERY=$P(%ZTERX,"+",1)
"RTN","ZTER",44,0)
 . I %ZTERY'="" F X=0:0 S X=$O(^TMP($J,"XTER1",X)) Q:X'>0  I $P(^(X,0)," ")=%ZTERY S X=X+$P(%ZTERX,"+",2),%ZTZLIN=$G(^TMP($J,"XTER1",X,0)) Q
"RTN","ZTER",45,0)
 . I %ZTERY="" S X=+$P(%ZTERX,"+",2) Q:X'>0  S %ZTZLIN=$G(^TMP($J,"XTER1",X,0))
"RTN","ZTER",46,0)
 K ^TMP($J,"XTER1")
"RTN","ZTER",47,0)
 S:$D(%ZTZLIN) @%ZTERRT@("LINE")=%ZTZLIN K %ZTZLIN
"RTN","ZTER",48,0)
 I %ZTERROR'="",$D(^%ZTER(2,"B",%ZTERROR)) S %ZTERROR=%ZTERROR_"^"_$P(^%ZTER(2,+$O(^(%ZTERROR,0)),0),"^",2)
"RTN","ZTER",49,0)
EXIT ;
"RTN","ZTER",50,0)
 I $G(%ZTER12A)["ALLOC" HALT  ;Don't allow job to go on.
"RTN","ZTER",51,0)
 S $EC="",$ET=$G(^TMP("$ZE",$J,2))
"RTN","ZTER",52,0)
 K ^TMP("$ZE",$J)
"RTN","ZTER",53,0)
 K %ZTER11A,%ZTER11B,%ZTERCNT,%ZTER11S,%ZTER11Z,%ZTERVAP,%ZTERVAR,%ZTERSUB,%ZTER11I,%ZTER11D,%ZTER11L,%ZTER11Q,%,%ZTER111,%ZTER112,%ZTER11N
"RTN","ZTER",54,0)
 K %ZTERRT,%ZTERH1
"RTN","ZTER",55,0)
 Q
"RTN","ZTER",56,0)
 ;
"RTN","ZTER",57,0)
VAR I "%ZTER"'=$E(%ZTERVAR,1,5) S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)=%ZTERVAR D
"RTN","ZTER",58,0)
 . I $L(@%ZTERVAR)'>255 S @%ZTERRT@("ZV",%ZTERCNT,"D")=@%ZTERVAR Q
"RTN","ZTER",59,0)
 . S @%ZTERRT@("ZV",%ZTERCNT,"D")=" **** VALUE IS GREATER THAN 255 CHARACTERS (SEE SUBNODES FOR DATA) *** "
"RTN","ZTER",60,0)
 . N %ZTER11,%ZTER12
"RTN","ZTER",61,0)
 . F %ZTER11=1:1 S %ZTER12=$E(@%ZTERVAR,1,245) Q:%ZTER12=""  S @%ZTERVAR=$E(@%ZTERVAR,246,$L(@%ZTERVAR)),@%ZTERRT@("ZV",%ZTERCNT,"D",%ZTER11)=%ZTER12
"RTN","ZTER",62,0)
 . Q
"RTN","ZTER",63,0)
 Q
"RTN","ZTER",64,0)
 ;
"RTN","ZTER",65,0)
SAVE(%n,%v) ;Save name and value into global, use special variables
"RTN","ZTER",66,0)
 S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)=%n,@%ZTERRT@("ZV",%ZTERCNT,"D")=%v
"RTN","ZTER",67,0)
 Q
"RTN","ZTER",68,0)
 ;
"RTN","ZTER",69,0)
SUBS S %ZTER11S="" Q:"%ZT("=$E(%ZTERVAR,1,4)  Q:",%ZTER11S,%ZTER11L,"[(","_%ZTERVAR_",")  S %ZTERVAP=%ZTERVAR_"(",%ZTERSUB="%ZTER11S)"
"RTN","ZTER",70,0)
 ;
"RTN","ZTER",71,0)
DESC S %ZTER11I=%ZTER11I+1,%ZTER11S(%ZTER11I)=%ZTER11S,%ZTER11S="",%ZTER11L(%ZTER11I)=$L(%ZTERSUB)-9 F %ZTER11Z=0:0 S %ZTER11S=$O(@(%ZTERVAP_%ZTERSUB)) Q:%ZTER11S=""  D SUBX
"RTN","ZTER",72,0)
 S %ZTER11S=%ZTER11S(%ZTER11I) K %ZTER11S(%ZTER11I),%ZTER11L(%ZTER11I) S %ZTER11I=%ZTER11I-1
"RTN","ZTER",73,0)
 Q
"RTN","ZTER",74,0)
 ;
"RTN","ZTER",75,0)
SUBX I $D(@(%ZTERVAP_%ZTERSUB))#10 S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)=$P(%ZTERVAP_%ZTERSUB,"%ZTER11S",1)_""""_%ZTER11S_""""_$P(%ZTERVAP_%ZTERSUB,"%ZTER11S",2),^("D")=@(%ZTERVAP_%ZTERSUB)
"RTN","ZTER",76,0)
 I $D(@(%ZTERVAP_%ZTERSUB))\10 S %ZTERSUB=$E(%ZTERSUB,1,%ZTER11L(%ZTER11I))_""""_%ZTER11S_""""_",%ZTER11S)" D DESC S %ZTERSUB=$E(%ZTERSUB,1,%ZTER11L(%ZTER11I))_"%ZTER11S)"
"RTN","ZTER",77,0)
 Q
"RTN","ZTER",78,0)
 ;
"RTN","ZTER",79,0)
GLOB ; save off a list of global subtrees, %ZT is passed in subscripted by name
"RTN","ZTER",80,0)
 ; %ZTERCNT passed in to count the nodes we traverse
"RTN","ZTER",81,0)
 ; %ZTERNOD the nodes through which we $QUERY
"RTN","ZTER",82,0)
 ; %ZTERNAM the names of the global subtrees we're saving
"RTN","ZTER",83,0)
 ; %ZTEROPN is %ZTERNAM, evaluated, without close paren for $PIECEing
"RTN","ZTER",84,0)
 N %ZTERNOD,%ZTERNAM,%ZTEROPN
"RTN","ZTER",85,0)
 S %ZTERNAM="" ; the names of the global subtrees we're saving
"RTN","ZTER",86,0)
 F  S %ZTERNAM=$O(%ZT(%ZTERNAM)) Q:%ZTERNAM=""  D
"RTN","ZTER",87,0)
 . S %ZTERNOD=$NA(@%ZTERNAM) ; fully evaluate all the subscripts (incl. $J)
"RTN","ZTER",88,0)
 . S %ZTEROPN=$E(%ZTERNOD,1,$L(%ZTERNOD)-1) ; save %ZTERNOD w/o close paren
"RTN","ZTER",89,0)
 . ;S %ZTERSUB=$QL(%ZTERNOD) ; how many subscripts in the subtree root's name
"RTN","ZTER",90,0)
 . F  S %ZTERNOD=$Q(@%ZTERNOD) Q:%ZTERNOD=""  Q:%ZTERNOD'[%ZTEROPN  D  ; traverse subtree
"RTN","ZTER",91,0)
 . . S %ZTERCNT=%ZTERCNT+1 ; count each node
"RTN","ZTER",92,0)
 . . S @%ZTERRT@("ZV",%ZTERCNT,0)=$P(%ZTERNAM,")")_$P(%ZTERNOD,%ZTEROPN,2) ; unevaluated name
"RTN","ZTER",93,0)
 . . S @%ZTERRT@("ZV",%ZTERCNT,"D")=$G(@%ZTERNOD) ; value of node
"RTN","ZTER",94,0)
 Q
"RTN","ZTER",95,0)
 ;
"RTN","ZTER",96,0)
ETXT() ;Return the Text of the error
"RTN","ZTER",97,0)
 Q $S(%ZTERZE["%DSM-E":$P($P(%ZTERZE,"%DSM-E-",2),","),1:$P($P(%ZTERZE,"<",2),">"))
"RTN","ZTER",98,0)
ERR ;Handle an error in %ZTER
"RTN","ZTER",99,0)
 I $D(%ZTERH1),$D(%ZTER11N) S ^%ZTER(1,%ZTERH1,1,%ZTER11N,"ZE2")="%ZTER caused an error: "_$ET
"RTN","ZTER",100,0)
 ;Should ^TMP("$ZE",$J) be killed here
"RTN","ZTER",101,0)
 HALT
"RTN","ZTER",102,0)
 ;
"RTN","ZTER",103,0)
SCREEN(ERR,%ZT3) ;Screen out certain errors.
"RTN","ZTER",104,0)
 N %ZTE,%ZTI,%ZTJ S:'$D(ERR) ERR=$$EC^%ZOSV
"RTN","ZTER",105,0)
 S %ZTE="",%ZTI=0
"RTN","ZTER",106,0)
 F %ZTJ=2,1 D  Q:%ZTI>0
"RTN","ZTER",107,0)
 . F %ZTI=0:0 S %ZTI=$O(^%ZTER(2,"AC",%ZTJ,%ZTI)) Q:%ZTI=""  S %ZTE=$S($G(^%ZTER(2,%ZTI,2))]"":^(2),1:$P(^(0),"^")) Q:ERR[%ZTE
"RTN","ZTER",108,0)
 . Q
"RTN","ZTER",109,0)
 ;Next see if we should count the error
"RTN","ZTER",110,0)
 I %ZTI>0 S %ZTE=$G(^%ZTER(2,%ZTI,0)) D  Q $P(%ZTE,"^",3)=2 ;See if we skip the recording of the error.
"RTN","ZTER",111,0)
 . Q:(%ZTJ=1)&('$G(%ZT3))
"RTN","ZTER",112,0)
 . I $P(%ZTE,"^",4) L +^%ZTER(2,%ZTI) S ^(3)=$G(^%ZTER(2,%ZTI,3))+1 L -^%ZTER(2,%ZTI)
"RTN","ZTER",113,0)
 . Q
"RTN","ZTER",114,0)
 Q 0 ;record error
"RTN","ZTER",115,0)
 ;
"RTN","ZTER",116,0)
UNWIND ;Unwind stack for new error trap. Called by app code.
"RTN","ZTER",117,0)
 Q:'$$NEWERR()
"RTN","ZTER",118,0)
 S $ECODE="" S $ETRAP="D UNW^%ZTER Q:'$QUIT  Q -9" S $ECODE=",U1,"
"RTN","ZTER",119,0)
UNW Q:$ESTACK>1  S $ECODE="" Q
"RTN","ZTER",120,0)
 ;
"RTN","ZTER",121,0)
NEWERR() ;Does this OS support the M95 error trapping
"RTN","ZTER",122,0)
 Q 1 ;All current M system now support 95 error trapping
"RTN","ZTER",123,0)
 N % S %=$G(^%ZOSF("OS")) Q:%="" 0
"RTN","ZTER",124,0)
 I %["VAX DSM" Q 1
"RTN","ZTER",125,0)
 I %["GT.M" Q 1
"RTN","ZTER",126,0)
 I %["MSM",$P($ZV,"Version ",2)'<4.3 Q 1
"RTN","ZTER",127,0)
 I %["OpenM" Q 1 ;For version >7.0 or NexGen or Cache
"RTN","ZTER",128,0)
 Q 0
"RTN","ZTER",129,0)
ABORT ;Pop the stack all the way.
"RTN","ZTER",130,0)
 S $ETRAP="Q:$ST>1  S $ECODE="""" Q"
"RTN","ZTER",131,0)
 Q
"RTN","ZTER1")
0^33^B6756504
"RTN","ZTER1",1,0)
%ZTER1 ;ISC-SF.SEA/JLI - ERROR TRAP TO LOG ERRORS (VAX LOCAL SYMBOL TABLE) ;03/27/2003  12:26
"RTN","ZTER1",2,0)
 ;;8.0;KERNEL;**18,24,36,49,112,162,275**;JUL 10, 1995
"RTN","ZTER1",3,0)
VXD ;Record VAX DSM variables
"RTN","ZTER1",4,0)
 S @%ZTERRT@("J")=$J_"^"_$ZC(%GETJPI,0,"PRCNAM")_"^"_$ZC(%GETJPI,0,"USERNAME")_"^"_%ZTER11I_"^"_$ZC(%SYSFAO,"!XL",$J),@%ZTERRT@("I")=$IO_"^"_$ZA_"^"_$ZB_"^"_$ZIO K %ZTER11I
"RTN","ZTER1",5,0)
 S @%ZTERRT@("ZH")=$TR($ZH,",","^")
"RTN","ZTER1",6,0)
 S %ZTER111="%" F  D  S %ZTER111=$ZSORT(@%ZTER111) Q:%ZTER111=""  ;Code from DEC
"RTN","ZTER1",7,0)
 . Q:$E(%ZTER111,1,5)="%ZTER"
"RTN","ZTER1",8,0)
 . I $D(@%ZTER111)#2 D VNXT2
"RTN","ZTER1",9,0)
 . I $D(@%ZTER111)>9 D VNXT3
"RTN","ZTER1",10,0)
 . Q
"RTN","ZTER1",11,0)
 Q
"RTN","ZTER1",12,0)
 ;
"RTN","ZTER1",13,0)
VNXT2 S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)=%ZTER111,^("D")=$E(@%ZTER111,1,255)
"RTN","ZTER1",14,0)
 Q
"RTN","ZTER1",15,0)
VNXT3 S %ZTER11Q=%ZTER111
"RTN","ZTER1",16,0)
 F  S %ZTER11Q=$Q(@%ZTER11Q) Q:%ZTER11Q=""  S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)=%ZTER11Q,^("D")=$E(@%ZTER11Q,1,255)
"RTN","ZTER1",17,0)
 Q
"RTN","ZTER1",18,0)
 ;
"RTN","ZTER1",19,0)
STACK ;Record the new $STACK variable
"RTN","ZTER1",20,0)
 I $ECODE]"" S $ZE=""
"RTN","ZTER1",21,0)
 N %ZTER35 S %ZTER35=$S($D(^TMP("$ZE",$J,2)):^(2),1:$ETRAP)
"RTN","ZTER1",22,0)
 S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)="$ECODE",^("D")=$E($ECODE,1,255)
"RTN","ZTER1",23,0)
 S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)="$ESTACK",^("D")=$ESTACK
"RTN","ZTER1",24,0)
 S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)="$ETRAP",^("D")=%ZTER35
"RTN","ZTER1",25,0)
 S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)="$STACK",^("D")=$STACK
"RTN","ZTER1",26,0)
 S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)="$QUIT",^("D")=$QUIT
"RTN","ZTER1",27,0)
 N %,%1,%2 S %2=$ST
"RTN","ZTER1",28,0)
 F %=0:1:$ST S %1=$E(1000+%,2,4) Q:$ST(%,"PLACE")["^%ZTER"  D
"RTN","ZTER1",29,0)
 . S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)="$STACK("_%1_")",^("D")=$STACK(%)
"RTN","ZTER1",30,0)
 . S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)="$STACK("_%1_",""ECODE"")",^("D")=$STACK(%,"ECODE")
"RTN","ZTER1",31,0)
 . S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)="$STACK("_%1_",""PLACE"")",^("D")=$STACK(%,"PLACE")
"RTN","ZTER1",32,0)
 . S %ZTERCNT=%ZTERCNT+1,@%ZTERRT@("ZV",%ZTERCNT,0)="$STACK("_%1_",""MCODE"")",^("D")=$STACK(%,"MCODE")
"RTN","ZTER1",33,0)
 . S:$STACK(%,"ECODE")]"" %2=%
"RTN","ZTER1",34,0)
 S @%ZTERRT@("LINE")=$STACK(%2,"MCODE")
"RTN","ZTER1",35,0)
 S $ECODE=""
"RTN","ZTER1",36,0)
 Q
"RTN","ZTER1",37,0)
 ;
"RTN","ZTER1",38,0)
VERR ;
"RTN","ZTER1",39,0)
 S @%ZTERRT@("ZE2")="%DSM-E-ET, Error occurred in %ZTER, "_$ECODE
"RTN","ZTER1",40,0)
 HALT
"RTN","ZTLOAD1")
0^34^B22232897
"RTN","ZTLOAD1",1,0)
%ZTLOAD1 ;SEA/RDS-TaskMan: P I: Queue ;6/8/04  16:43
"RTN","ZTLOAD1",2,0)
 ;;8.0;KERNEL;**112,118,127,162,275**;Jul 10, 1995
"RTN","ZTLOAD1",3,0)
 ;
"RTN","ZTLOAD1",4,0)
GET ;get task data
"RTN","ZTLOAD1",5,0)
 N X1,ZT,ZTC1,ZTA1,ZTA4,ZTA5,ZTINC,ZTGOT
"RTN","ZTLOAD1",6,0)
 K %ZTLOAD
"RTN","ZTLOAD1",7,0)
 I ("^"[$G(ZTRTN))!($L($G(ZTRTN),"^")>2) D REJECT^%ZTLOAD2("Bad Routine") G EXIT
"RTN","ZTLOAD1",8,0)
 S U="^" I ZTRTN'[U S ZTRTN=U_ZTRTN
"RTN","ZTLOAD1",9,0)
 S ZTC1=$G(DUZ)
"RTN","ZTLOAD1",10,0)
 ;Check Date/Time
"RTN","ZTLOAD1",11,0)
1 I $D(ZTDTH)[0 S ZTDTH=""
"RTN","ZTLOAD1",12,0)
 I ZTDTH?7N.".".N S ZTDTH=$$FMTH^%ZTLOAD7(ZTDTH)
"RTN","ZTLOAD1",13,0)
 I $P($G(XQY0),U,18) D RESTRCT^%ZTLOAD2
"RTN","ZTLOAD1",14,0)
 I ZTDTH'="@",ZTDTH'?1.5N1","1.5N D ASK^%ZTLOAD2 I ZTDTH'>0 D REJECT^%ZTLOAD2("Bad Date/Time") G EXIT
"RTN","ZTLOAD1",15,0)
 ;
"RTN","ZTLOAD1",16,0)
 S ZTA1="R",ZTA4="",ZTA5=""
"RTN","ZTLOAD1",17,0)
 I ZTRTN="ZTSK^XQ1" D OPTION^%ZTLOAD2 I ZTA1="" D REJECT^%ZTLOAD2("Bad Option") G EXIT
"RTN","ZTLOAD1",18,0)
 I ZTA1="R" D
"RTN","ZTLOAD1",19,0)
 . S ZTSAVE("XQY")="",ZTSAVE("XQY0")="",ZTA4=$G(XQY),ZTA5=$P($G(XQY0),U)
"RTN","ZTLOAD1",20,0)
 ;
"RTN","ZTLOAD1",21,0)
 S ZTC2=ZTC1 I ZTC2]"" S ZTC2=$P($G(^VA(200,ZTC2,0)),U)
"RTN","ZTLOAD1",22,0)
 D GETENV^%ZOSV S ZTC34P=Y
"RTN","ZTLOAD1",23,0)
 ;Description
"RTN","ZTLOAD1",24,0)
2 I $D(ZTDESC)[0 S ZTDESC="No Description (%ZTLOAD)"
"RTN","ZTLOAD1",25,0)
 ;
"RTN","ZTLOAD1",26,0)
 I $G(ZTKIL)]"" D ZTKIL^%ZTLOAD2
"RTN","ZTLOAD1",27,0)
 S:$G(ZTUCI)["," ZTUCI=$P(ZTUCI,",") S:$G(ZTCPU)["," ZTCPU=$P(ZTCPU,",",2)
"RTN","ZTLOAD1",28,0)
DEVICE ;get device data
"RTN","ZTLOAD1",29,0)
 I $D(ZTIO)#2,$G(ION)=$P(ZTIO,";"),$G(IOT)="SPL" D SPOOL^%ZTLOAD2
"RTN","ZTLOAD1",30,0)
 ;If no ZTIO, build from symbol table
"RTN","ZTLOAD1",31,0)
 I $D(ZTIO)[0 S ZTIO=$G(ION) I ZTIO]"" D
"RTN","ZTLOAD1",32,0)
 . S:$G(IOST)]"" $P(ZTIO,";",2)=IOST
"RTN","ZTLOAD1",33,0)
 . I $G(IO("DOC"))]"" S ZTIO=ZTIO_";"_IO("DOC")
"RTN","ZTLOAD1",34,0)
 . E  I $G(IOM)]"" S ZTIO=ZTIO_";"_IOM I $G(IOSL)]"" S ZTIO=ZTIO_";"_IOSL
"RTN","ZTLOAD1",35,0)
 . S ZTIO("H")=$G(IO("HFSIO"))
"RTN","ZTLOAD1",36,0)
 . S ZTIO("P")=$G(IOPAR)
"RTN","ZTLOAD1",37,0)
 . I $G(IO("P"))]"",ZTIO'[";/" S ZTIO=ZTIO_";/"_IO("P")
"RTN","ZTLOAD1",38,0)
 . Q
"RTN","ZTLOAD1",39,0)
 I $E(ZTIO,1)="`" S $P(ZTIO,";")=$P(^%ZIS(1,+$E(ZTIO,2,99),0),"^") ;Convert `IEN format
"RTN","ZTLOAD1",40,0)
 S ZTIO(1)=$S($G(ZTIO(1))'="D":"Q",1:"DIRECT")
"RTN","ZTLOAD1",41,0)
 I $$NOQ^%ZISUTL($P(ZTIO,";")) D BADDEV^%ZTLOAD2("Restricted Device") G EXIT
"RTN","ZTLOAD1",42,0)
 I $E(ZTIO,1,9)="P-MESSAGE" S ZTSAVE("^TMP(""XM-MESS"",$J,")=""
"RTN","ZTLOAD1",43,0)
 ;
"RTN","ZTLOAD1",44,0)
 ;See that ^%ZTSK(-1) is set
"RTN","ZTLOAD1",45,0)
 I $D(^%ZTSK(-1))[0 S ^%ZTSK(-1)=$S($P($G(^%ZTSK(0)),U,3):$P(^(0),U,3),1:1000)
"RTN","ZTLOAD1",46,0)
RECORD ;build record
"RTN","ZTLOAD1",47,0)
 S ZTINC=$G(^%ZOSF("$INC"),1) ;Set to 1 if this system has $INCREMENT, otherwise 0.
"RTN","ZTLOAD1",48,0)
 S ZTGOT=0
"RTN","ZTLOAD1",49,0)
 I 'ZTINC D  ;For System that don't have $INC (GT.M, DTM, MSM)
"RTN","ZTLOAD1",50,0)
 . ;Find a free entry, Claim it and Lock it.
"RTN","ZTLOAD1",51,0)
 . L +^%ZTSK(-1):0 S ZTSK=^%ZTSK(-1) ;This is just a starting point
"RTN","ZTLOAD1",52,0)
 . F  S ZTSK=ZTSK+1 I '$D(^%ZTSK(ZTSK)) D  Q:ZTGOT
"RTN","ZTLOAD1",53,0)
 . . L +^%ZTSK(ZTSK):0 Q:'$T  ;Can we lock it
"RTN","ZTLOAD1",54,0)
 . . I $D(^%ZTSK(ZTSK)) L -^%ZTSK(ZTSK) ;Already claimed
"RTN","ZTLOAD1",55,0)
 . . S ^%ZTSK(ZTSK,.1)=0,^%ZTSK(-1)=ZTSK,ZTGOT=1 ;Claim it
"RTN","ZTLOAD1",56,0)
 . . Q
"RTN","ZTLOAD1",57,0)
 . L -^%ZTSK(-1) ;
"RTN","ZTLOAD1",58,0)
 . Q
"RTN","ZTLOAD1",59,0)
 I ZTINC D  ;For DSM and OpenM. Faster over network(DDP)
"RTN","ZTLOAD1",60,0)
 . S ZTSK=$INCREMENT(^%ZTSK(-1))
"RTN","ZTLOAD1",61,0)
 . L +^%ZTSK(ZTSK):0 S ZTGOT=$T
"RTN","ZTLOAD1",62,0)
 I 'ZTGOT!($D(^%ZTSK(ZTSK,0))) L -^%ZTSK(ZTSK) G RECORD
"RTN","ZTLOAD1",63,0)
 S ^%ZTSK(ZTSK,0)=ZTRTN_U_ZTC1_U_$G(ZTUCI)_U_$H_U_ZTDTH_U_ZTA1_U_ZTA4_U_ZTA5_U_ZTC2_U_$P(ZTC34P,U,1,2)_U_"ZTDESC"_U_$G(ZTCPU)_U_$G(ZTPRI)
"RTN","ZTLOAD1",64,0)
 S ^%ZTSK(ZTSK,.1)=0,^%ZTSK(ZTSK,.03)=ZTDESC
"RTN","ZTLOAD1",65,0)
 S ^%ZTSK(ZTSK,.2)=ZTIO_"^^^^"_ZTIO(1)_U_$G(ZTIO("H")) S:$D(ZTSYNC) $P(^%ZTSK(ZTSK,.2),U,7)=ZTSYNC
"RTN","ZTLOAD1",66,0)
 I $G(ZTIO("P"))]"" S ^%ZTSK(ZTSK,.25)=ZTIO("P")
"RTN","ZTLOAD1",67,0)
 ;
"RTN","ZTLOAD1",68,0)
 D ZTSAVE
"RTN","ZTLOAD1",69,0)
 ;
"RTN","ZTLOAD1",70,0)
SCHED ;schedule task and quit
"RTN","ZTLOAD1",71,0)
 S ZTSTAT=$S(ZTDTH'="@":1,1:"K")_"^"_$H,$P(ZTSTAT,U,8)=$G(ZTKIL)
"RTN","ZTLOAD1",72,0)
 S ^%ZTSK(ZTSK,.1)=ZTSTAT
"RTN","ZTLOAD1",73,0)
 I ZTDTH'="@" S ZT=$$H3(ZTDTH),^%ZTSK(ZTSK,.04)=ZT,^%ZTSCH(ZT,ZTSK)=""
"RTN","ZTLOAD1",74,0)
 L -^%ZTSK(ZTSK) S ZTSK("D")=ZTDTH
"RTN","ZTLOAD1",75,0)
EXIT I $E($G(ZTIO),1,9)="P-MESSAGE" K ^TMP("XM-MESS",$J) ;Clean up the Global
"RTN","ZTLOAD1",76,0)
 K X1,ZT,ZT1,ZTDTH,ZTKIL,ZTSAVE,ZTSTAT,ZTIO
"RTN","ZTLOAD1",77,0)
 ;K ZTA1,ZTA4,ZTC1,ZTCPU,ZTDESC,ZTDTH,ZTIO,ZTKIL,ZTNOGO,ZTPRI,ZTRTN,ZTSAVE,ZTSK,ZTUCI
"RTN","ZTLOAD1",78,0)
 Q
"RTN","ZTLOAD1",79,0)
 ;
"RTN","ZTLOAD1",80,0)
ZTSAVE ;save variables
"RTN","ZTLOAD1",81,0)
 N ZTIO
"RTN","ZTLOAD1",82,0)
 K %H,%T,ZTA1,ZTA4,ZTA5,ZTC1,ZTC2,ZTC34P,ZTCPU,ZTDESC,ZTIO,ZTNOGO,ZTPRI,ZTRTN,ZTUCI,ZTSYNC
"RTN","ZTLOAD1",83,0)
 S ZTSAVE("DUZ(")=""
"RTN","ZTLOAD1",84,0)
 I ^%ZOSF("OS")'["VAX DSM" S ZT1="" F  S ZT1=$O(ZTSAVE(ZT1)) Q:ZT1=""  D EVAL
"RTN","ZTLOAD1",85,0)
 I ^%ZOSF("OS")["VAX DSM" K X1 S ZT1="" F  S ZT1=$O(ZTSAVE(ZT1)) Q:ZT1=""  S:ZT1["*" X1(ZT1)="" I ZT1'["*" D EVAL
"RTN","ZTLOAD1",86,0)
 I ^%ZOSF("OS")["VAX DSM",$D(X1) S X="^%ZTSK(ZTSK,.3," D ORDER^%ZOSV
"RTN","ZTLOAD1",87,0)
 K ^%ZTSK(ZTSK,.3,"DUZ(","NEWCODE")
"RTN","ZTLOAD1",88,0)
 K ^%ZTSK(ZTSK,.3,"ZTSK"),^("ZTSAVE"),^("ZTDTH")
"RTN","ZTLOAD1",89,0)
 K ^%ZTSK(ZTSK,.3,"XQNOGO")
"RTN","ZTLOAD1",90,0)
 Q
"RTN","ZTLOAD1",91,0)
 ;
"RTN","ZTLOAD1",92,0)
EVAL ;ZTSAVE--evaluate expression
"RTN","ZTLOAD1",93,0)
 I ZT1="*" S X="^%ZTSK(ZTSK,.3," D DOLRO^%ZOSV Q
"RTN","ZTLOAD1",94,0)
 I ZT1["*",$P(ZT1,"*")'["(" S X="^%ZTSK(ZTSK,.3,",Y=ZT1 D ORDER^%ZOSV Q
"RTN","ZTLOAD1",95,0)
 I $S($E(ZT1)="""":1,+ZT1'=ZT1:0,1:ZT1]0),$D(ZTSAVE(ZT1))#2 S @("^%ZTSK(ZTSK,"_ZT1_")=ZTSAVE(ZT1)") Q
"RTN","ZTLOAD1",96,0)
 I $S(ZT1'["(":1,1:$E(ZT1,$L(ZT1))=")"),$S($D(@ZT1)#2:1,1:ZTSAVE(ZT1)]"") S ^%ZTSK(ZTSK,.3,ZT1)=$S(ZTSAVE(ZT1)]"":ZTSAVE(ZT1),1:@ZT1) Q
"RTN","ZTLOAD1",97,0)
 I ZT1["(" S %X=ZT1,%Y="^%ZTSK(ZTSK,.3,ZT1," D %XY^%RCR
"RTN","ZTLOAD1",98,0)
 Q
"RTN","ZTLOAD1",99,0)
 ;
"RTN","ZTLOAD1",100,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTLOAD1",101,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTLOAD1",102,0)
H0(%) ;Covert from seconds to $H
"RTN","ZTLOAD1",103,0)
 Q (%\86400)_","_(%#86400)
"RTN","ZTLOAD2")
0^35^B9040975
"RTN","ZTLOAD2",1,0)
%ZTLOAD2 ;SEA/RDS-TaskMan:  Queue, Part 2 ;06/17/2004  12:20
"RTN","ZTLOAD2",2,0)
 ;;8.0;KERNEL;**1,67,118,275**;Jul 10, 1995
"RTN","ZTLOAD2",3,0)
 ;
"RTN","ZTLOAD2",4,0)
REJECT(MSG) ;GET--reject bad task
"RTN","ZTLOAD2",5,0)
 I '$D(ZTQUEUED) W !,"QUEUE INFORMATION MISSING - NOT QUEUED",!,MSG
"RTN","ZTLOAD2",6,0)
 G EXIT
"RTN","ZTLOAD2",7,0)
 ;
"RTN","ZTLOAD2",8,0)
BADDEV(MSG) ;GET--Reject task because of device issue.
"RTN","ZTLOAD2",9,0)
 I '$D(ZTQUEUED) W !,"Queueing not allowed to device -- NOT QUEUED",!,MSG
"RTN","ZTLOAD2",10,0)
EXIT S %ZTLOAD("ERROR")=MSG
"RTN","ZTLOAD2",11,0)
 Q
"RTN","ZTLOAD2",12,0)
 ;
"RTN","ZTLOAD2",13,0)
RESTRCT ;GET--flag tasks with output restricted from certain times; check.
"RTN","ZTLOAD2",14,0)
 I $D(ZTQUEUED) Q
"RTN","ZTLOAD2",15,0)
 S ZTNOGO=0
"RTN","ZTLOAD2",16,0)
 I ZTDTH="@" Q
"RTN","ZTLOAD2",17,0)
 I ZTDTH'?1.5N1","1.5N Q
"RTN","ZTLOAD2",18,0)
 S X=$$HTFM^%ZTLOAD7(ZTDTH) D ^XQ92 I X="" S ZTDTH="" W !,"Sorry--that time is restricted!",!,$C(7)
"RTN","ZTLOAD2",19,0)
 Q
"RTN","ZTLOAD2",20,0)
 ;
"RTN","ZTLOAD2",21,0)
ASK ;GET--ask for start time
"RTN","ZTLOAD2",22,0)
 N %DT,Y
"RTN","ZTLOAD2",23,0)
 I $D(ZTQUEUED) D:ZTDTH]""  Q
"RTN","ZTLOAD2",24,0)
 . S %DT="FRS",X=ZTDTH D ^%DT
"RTN","ZTLOAD2",25,0)
 . S ZTDTH=$$FMTH^%ZTLOAD7(+Y) I Y'>0 S ZTDTH=""
"RTN","ZTLOAD2",26,0)
 . Q
"RTN","ZTLOAD2",27,0)
 S ZTDTH="",%DT="AERSX",%DT("A")="Requested Start Time: ",%DT("B")="NOW",%DT(0)="NOW"
"RTN","ZTLOAD2",28,0)
 I $D(ZTNOGO) D  I X="" Q
"RTN","ZTLOAD2",29,0)
 . S Y=+XQY D NEXT^XQ92 I X="" W !,"Output is never allowed from this option!",$C(7),$C(7) Q
"RTN","ZTLOAD2",30,0)
 . S %DT("B")=$$FMTE^%ZTLOAD7(X),%DT="AERSX"
"RTN","ZTLOAD2",31,0)
 . Q
"RTN","ZTLOAD2",32,0)
 I $D(ZTNOGO),'$D(XQNOGO) W !,"Output from this option is restricted during certain times."
"RTN","ZTLOAD2",33,0)
 F ZT=0:0 D ^%DT Q:(Y<0)!'$D(ZTNOGO)  S ZT=Y,X=Y D ^XQ92 S Y=ZT Q:X]""  W !!,"That is a restricted time!",!,$C(7)
"RTN","ZTLOAD2",34,0)
 S:Y>0 ZTDTH=$$FMTH^%ZTLOAD7(+Y)
"RTN","ZTLOAD2",35,0)
 K %DT,%T,X5,ZT
"RTN","ZTLOAD2",36,0)
 Q
"RTN","ZTLOAD2",37,0)
 ;
"RTN","ZTLOAD2",38,0)
OPTION ;GET--get option data
"RTN","ZTLOAD2",39,0)
 S ZTA4=$G(ZTSAVE("XQY")) I 'ZTA4 S ZTA4=$G(XQY) I 'ZTA4 S ZTA4=""
"RTN","ZTLOAD2",40,0)
 S ZTA1="O" I 'ZTA4 S ZTA1="" Q
"RTN","ZTLOAD2",41,0)
 S ZTA5=$P($G(^DIC(19,ZTA4,0)),U)
"RTN","ZTLOAD2",42,0)
 Q
"RTN","ZTLOAD2",43,0)
 ;
"RTN","ZTLOAD2",44,0)
ZTKIL ;GET--convert forget time
"RTN","ZTLOAD2",45,0)
 S ZTKIL=$S(ZTKIL?5N:ZTKIL,ZTKIL?5N1","1.5N:ZTKIL,ZTKIL?7N.".".N:$$FMTH^%ZTLOAD7(ZTKIL),1:"")
"RTN","ZTLOAD2",46,0)
 Q
"RTN","ZTLOAD2",47,0)
 ;
"RTN","ZTLOAD2",48,0)
SPOOL ;DEVICE--for predefined ZTIO spool device, pick up IO("DOC") if missing
"RTN","ZTLOAD2",49,0)
 I $G(IO("DOC"))="" Q
"RTN","ZTLOAD2",50,0)
 I ZTIO[IO("DOC") Q
"RTN","ZTLOAD2",51,0)
 I $P(ZTIO,";",2)?.N D
"RTN","ZTLOAD2",52,0)
 .S ZTIO=$P(ZTIO,";")_";"_IO("DOC")_";"_$P(ZTIO,";",2,999)
"RTN","ZTLOAD2",53,0)
 E  I $P(ZTIO,";",2)?1.2A1"-"1.ANP,$P(ZTIO,";",3)?.N D
"RTN","ZTLOAD2",54,0)
 .S ZTIO=$P(ZTIO,";",1,2)_";"_IO("DOC")_";"_$P(ZTIO,";",3,999)
"RTN","ZTLOAD2",55,0)
 Q
"RTN","ZTLOAD2",56,0)
 ;
"RTN","ZTLOAD2",57,0)
ASKSTOP ;e.f. Called from ASKSTOP^%ZTLOAD
"RTN","ZTLOAD2",58,0)
 ;Ask a task to stop. Unschedule if not started.
"RTN","ZTLOAD2",59,0)
 N ZT1,ZT2,ZTDTH,%ZTIO
"RTN","ZTLOAD2",60,0)
 L +^%ZTSK(ZTSK):10 I '$T Q "0^Busy"
"RTN","ZTLOAD2",61,0)
 S ZTSK(0)=$G(^%ZTSK(ZTSK,0)),ZTSK(.1)=$G(^(.1))
"RTN","ZTLOAD2",62,0)
 I ZTSK(0)="" Q "1^Task missing"
"RTN","ZTLOAD2",63,0)
 S $P(^%ZTSK(ZTSK,.1),U,10)=$S($D(ZTNAME)#2:ZTNAME,1:$G(DUZ,.5))
"RTN","ZTLOAD2",64,0)
 I +ZTSK(.1)=6 Q "1^Finished running"
"RTN","ZTLOAD2",65,0)
 I +ZTSK(.1)=5 Q "2^Asked to stop"
"RTN","ZTLOAD2",66,0)
 S ZTDTH=$$H3^%ZTM($P(ZTSK(0),U,6))
"RTN","ZTLOAD2",67,0)
 K ^%ZTSCH(ZTDTH,ZTSK) ;Remove from schedule
"RTN","ZTLOAD2",68,0)
 S %ZTIO=$O(^%ZTSK(ZTSK,.26,"")) I %ZTIO]"" D DQ^%ZTM4 ;Remove from device lists.
"RTN","ZTLOAD2",69,0)
 L -^%ZTSK(ZTSK)
"RTN","ZTLOAD2",70,0)
 Q "2^Unscheduled"
"RTN","ZTM")
0^44^B34894883
"RTN","ZTM",1,0)
%ZTM ;SEA/RDS-TaskMan: Manager, Part 1 (Main Loop) ;22 May 2003 2:08 pm
"RTN","ZTM",2,0)
 ;;8.0;KERNEL;**24,36,64,67,118,127,136,275**;JUL 10, 1995;
"RTN","ZTM",3,0)
 ;
"RTN","ZTM",4,0)
 ;%ZTCHK is set to 1 @ top of SCHQ, set to 0 if send a task to SM
"RTN","ZTM",5,0)
LOOP ;Taskman's Main Loop
"RTN","ZTM",6,0)
 F %ZTLOOP=0:1 S %ZTLOOP=%ZTLOOP#16 D CHECK,SCHQ,IDLE:%ZTCHK
"RTN","ZTM",7,0)
 S %ZTFALL="" G LOOP
"RTN","ZTM",8,0)
 ;
"RTN","ZTM",9,0)
CHECK ;LOOP--Check Status And Update Loop Data
"RTN","ZTM",10,0)
 ;Do CHECK if sent a new job or %ZTLOOP=0.
"RTN","ZTM",11,0)
 Q:%ZTLOOP&$G(%ZTCHK)
"RTN","ZTM",12,0)
 I $D(^%ZTSCH("STOP","MGR",%ZTPAIR)) G HALT^%ZTM0
"RTN","ZTM",13,0)
 S ^%ZTSCH("RUN")=$H,ZTPAIR="",%ZTIME=$$H3($H)
"RTN","ZTM",14,0)
 I $D(^%ZTSCH("WAIT","MGR"))#2 D STATUS("WAIT","Taskman Waiting") H 5 G CHECK
"RTN","ZTM",15,0)
 ;
"RTN","ZTM",16,0)
 I $D(^%ZTSCH("UPDATE",$J))[0 D UPDATE^%ZTM5
"RTN","ZTM",17,0)
 I %ZTVLI D STATUS("PAUSE","Logons Inhibited") H 60 G CHECK ;Set in %ZTM5
"RTN","ZTM",18,0)
 I @%ZTNLG D INHIBIT^%ZTM5(1),STATUS("PAUSE","No Signons Allowed") H 60 G CHECK
"RTN","ZTM",19,0)
 I $G(^%ZIS(14.5,"LOGON",%ZTVOL)) D INHIBIT^%ZTM5(0) ;Check field
"RTN","ZTM",20,0)
 I $D(ZTREQUIR)#2 D STATUS("PAUSE","Required link to "_ZTREQUIR_" is down.") H 60 D REQUIR^%ZTM5 G CHECK
"RTN","ZTM",21,0)
 ;
"RTN","ZTM",22,0)
 I $D(^%ZTSCH("LINK"))#2,$$DIFF($H,^("LINK"))>900 D LINK^%ZTM3
"RTN","ZTM",23,0)
 ;
"RTN","ZTM",24,0)
 S %ZTRUN=%ZTVMJ>$$ACTJ^%ZOSV ;Check for job limit
"RTN","ZTM",25,0)
 ;
"RTN","ZTM",26,0)
 I %ZTPFLG("BAL")]"" D  I ZTOVERLD G CHECK
"RTN","ZTM",27,0)
 . S ZTOVERLD=0
"RTN","ZTM",28,0)
 . Q:%ZTPFLG("LBT")>%ZTIME  S %ZTPFLG("LBT")=%ZTIME+%ZTPFLG("BI")
"RTN","ZTM",29,0)
 . D BALANCE^%ZTM6 Q:'ZTOVERLD
"RTN","ZTM",30,0)
 . D STATUS("BALANCE","Waiting to balance the load.")
"RTN","ZTM",31,0)
 . ;Start submanagers for C list work
"RTN","ZTM",32,0)
 . I $D(^%ZTSCH("C",%ZTPAIR))>9,%ZTRUN D NEWJOB(%ZTUCI,%ZTVOL,"")
"RTN","ZTM",33,0)
 . N T F T=1:1:%ZTPFLG("BI") H 1 Q:$$STOPWT^%ZTM6()
"RTN","ZTM",34,0)
 . Q
"RTN","ZTM",35,0)
 ;
"RTN","ZTM",36,0)
 I %ZTRUN D STATUS("RUN","Main Loop")
"RTN","ZTM",37,0)
 I '%ZTRUN D STATUS("RUN","Taskman Job Limit Reached"),CHECK^%ZTM6
"RTN","ZTM",38,0)
 Q
"RTN","ZTM",39,0)
 ;
"RTN","ZTM",40,0)
STATUS(ST,MSG) ;Record TM status
"RTN","ZTM",41,0)
 S ^%ZTSCH("STATUS",$J)=$H_"^"_ST_"^"_$G(%ZTPAIR)_"^"_MSG
"RTN","ZTM",42,0)
 Q
"RTN","ZTM",43,0)
 ;
"RTN","ZTM",44,0)
TLOCK(M,T) ;Lock a time node
"RTN","ZTM",45,0)
 I M>0 L +^%ZTSCH(ZTDTH):0 Q $T
"RTN","ZTM",46,0)
 L -^%ZTSCH(ZTDTH) Q
"RTN","ZTM",47,0)
 ;
"RTN","ZTM",48,0)
SCHQ ;LOOP--Check Schedule List
"RTN","ZTM",49,0)
 S %ZTIME=$$H3($H),ZTDTH=0,%ZTCHK=1,IO=""
"RTN","ZTM",50,0)
S1 S ZTDTH=$O(^%ZTSCH(ZTDTH)),ZTSK=0 Q:(ZTDTH>%ZTIME)  Q:('ZTDTH)!(ZTDTH'?1.N)  I +ZTDTH<0 K ^%ZTSCH(ZTDTH) G S1
"RTN","ZTM",51,0)
 I '$$TLOCK(1,ZTDTH) G S1
"RTN","ZTM",52,0)
S2 S ZTSK=$O(^%ZTSCH(ZTDTH,ZTSK)) I ZTSK="" D TLOCK(-1,ZTDTH) G S1
"RTN","ZTM",53,0)
 S ZTST=$G(^%ZTSCH(ZTDTH,ZTSK))
"RTN","ZTM",54,0)
 ;Get task lock then release time lock
"RTN","ZTM",55,0)
 L +^%ZTSK(ZTSK):0 G S2:'$T
"RTN","ZTM",56,0)
 K ^%ZTSCH(ZTDTH,ZTSK) D TLOCK(-1,ZTDTH)
"RTN","ZTM",57,0)
 ;Count tasks
"RTN","ZTM",58,0)
 S %ZTMON(%ZTMON)=$G(%ZTMON(%ZTMON))+1
"RTN","ZTM",59,0)
 I $D(^%ZTSK(ZTSK,0))[0 D TSKSTAT("I") L -^%ZTSK(ZTSK) G S2
"RTN","ZTM",60,0)
 I $L($P($G(^%ZTSK(ZTSK,.1)),U,10)) D TSKSTAT("D","Stopped") L -^%ZTSK(ZTSK) G S2
"RTN","ZTM",61,0)
 D ^%ZTM1
"RTN","ZTM",62,0)
 I %ZTREJCT L -^%ZTSK(ZTSK) G S2
"RTN","ZTM",63,0)
 ;
"RTN","ZTM",64,0)
SEND ;Send Task To Submanager
"RTN","ZTM",65,0)
 S %ZTCHK=0,ZTPAIR=""
"RTN","ZTM",66,0)
 I ZTDVOL'=%ZTVOL D XLINK^%ZTM2 G:'ZTJOBIT SCHX
"RTN","ZTM",67,0)
 ;Clear before job cmd
"RTN","ZTM",68,0)
 I (ZTYPE'="C")&(%ZTNODE[ZTNODE) D
"RTN","ZTM",69,0)
 . D TSKSTAT(3,"Placed on JOB List")
"RTN","ZTM",70,0)
 . S ^%ZTSCH("JOB",ZTDTH,ZTSK)=IO ;No other lock on JOB
"RTN","ZTM",71,0)
 E  D
"RTN","ZTM",72,0)
 . D TSKSTAT("M","Placed on C List")
"RTN","ZTM",73,0)
 . S ZTPAIR=ZTDVOL_$S(ZTNODE]"":":"_ZTNODE,1:"")
"RTN","ZTM",74,0)
 . S ^%ZTSCH("C",ZTPAIR,ZTDTH,ZTSK)=IO
"RTN","ZTM",75,0)
 ;
"RTN","ZTM",76,0)
 L -^%ZTSK(ZTSK)
"RTN","ZTM",77,0)
 ;
"RTN","ZTM",78,0)
 ;I '$D(^%ZTSCH("STOP","SUB",%ZTPAIR)),'$$OOS(ZTPAIR) D NEWJOB(ZTUCI,ZTDVOL,ZTNODE,ZTYPE,ZTPAIR)
"RTN","ZTM",79,0)
 ;I '$D(^%ZTSCH("STOP","SUB",%ZTPAIR)),(ZTYPE="C"!(%ZTRUN&$$NEWSUB)),'$$OOS(ZTPAIR) D
"RTN","ZTM",80,0)
 ;. I 1 X %ZTJOB H %ZTSLO I '$T X %ZTJOB H %ZTSLO
"RTN","ZTM",81,0)
 ;. Q
"RTN","ZTM",82,0)
 I (ZTYPE="C"!(%ZTRUN&$$NEWSUB)),'$$OOS(ZTPAIR) D NEWJOB(ZTUCI,ZTDVOL,ZTNODE)
"RTN","ZTM",83,0)
SCHX L  K ZTREP Q
"RTN","ZTM",84,0)
 ;
"RTN","ZTM",85,0)
IDLE ;LOOP--DEV Node Maintenance; Backup JOB Commands
"RTN","ZTM",86,0)
 S (ZTREC,ZTCVOL)="" H 1 ;This is the main hang
"RTN","ZTM",87,0)
 I %ZTMON("NEXT")'>%ZTIME D MON ;See if time to update %ZTMON
"RTN","ZTM",88,0)
 Q:'%ZTRUN  ;Only do IDLE work if not at job limit
"RTN","ZTM",89,0)
 I $D(^%ZTSCH("STOP","MGR",%ZTPAIR)) Q
"RTN","ZTM",90,0)
 ;job off a new submanager if MIN count < # SUBs
"RTN","ZTM",91,0)
 I $$NEWSUB D NEWJOB(%ZTUCI,%ZTVOL,"")
"RTN","ZTM",92,0)
 L +^%ZTSCH("IDLE",%ZTPAIR):0 Q:'$T  D IDLE1 L -^%ZTSCH("IDLE",%ZTPAIR)
"RTN","ZTM",93,0)
 Q
"RTN","ZTM",94,0)
IDLE1 ;only proceed with idle work if 60 seconds since last check
"RTN","ZTM",95,0)
 I $$DIFF(%ZTIME,^%ZTSCH("IDLE"),1)<60 Q
"RTN","ZTM",96,0)
 I %ZTPFLG("XUSCNT") D TOUCH^XUSCNT
"RTN","ZTM",97,0)
 D I1,I2,I5,I6
"RTN","ZTM",98,0)
 S ^%ZTSCH("IDLE")=%ZTIME
"RTN","ZTM",99,0)
 Q
"RTN","ZTM",100,0)
 ;
"RTN","ZTM",101,0)
I1 ;clear out old DEV nodes
"RTN","ZTM",102,0)
 N X,%ZTIO S %ZTIO=""
"RTN","ZTM",103,0)
 F  S %ZTIO=$O(^%ZTSCH("DEV",%ZTIO)) Q:%ZTIO=""  L ^%ZTSCH("DEV",%ZTIO):0 I $T D  L -^%ZTSCH("DEV",%ZTIO)
"RTN","ZTM",104,0)
 . S X=$G(^%ZTSCH("DEV",%ZTIO)) Q:'$L(X)
"RTN","ZTM",105,0)
 . I $$DIFF(%ZTIME,X,1)>120 K ^%ZTSCH("DEV",%ZTIO)
"RTN","ZTM",106,0)
 . Q
"RTN","ZTM",107,0)
 Q
"RTN","ZTM",108,0)
 ;
"RTN","ZTM",109,0)
I2 ;job new submanagers cross-volume for each unfinished C list
"RTN","ZTM",110,0)
 I $D(^%ZTSCH("C")) D
"RTN","ZTM",111,0)
 . N ZTUCI,ZTVOL,ZTNODE,$ETRAP,$ESTACK S $ET="S $EC="""" D ERCL^%ZTM2"
"RTN","ZTM",112,0)
 . S ZTVOL="" F  S ZTVOL=$O(^%ZTSCH("C",ZTVOL)) Q:ZTVOL=""  D
"RTN","ZTM",113,0)
 .. I $O(^%ZTSCH("C",ZTVOL,0))="" Q
"RTN","ZTM",114,0)
 .. S ZTNODE="",ZTDVOL=ZTVOL S:ZTDVOL[":" ZTNODE=$P(ZTDVOL,":",2),ZTDVOL=$P(ZTDVOL,":")
"RTN","ZTM",115,0)
 .. S X=$G(^%ZTSCH("C",ZTVOL))
"RTN","ZTM",116,0)
 .. I $D(^%ZTSCH("LINK",ZTDVOL))!(X>9)!$$OOS(ZTVOL) Q
"RTN","ZTM",117,0)
 .. S ^%ZTSCH("C",ZTVOL)=X+1
"RTN","ZTM",118,0)
 .. S ZTUCI=$O(^%ZIS(14.6,"AV",ZTDVOL,""))
"RTN","ZTM",119,0)
 .. D NEWJOB(ZTUCI,ZTDVOL,ZTNODE)
"RTN","ZTM",120,0)
 .. Q
"RTN","ZTM",121,0)
 . Q
"RTN","ZTM",122,0)
 Q
"RTN","ZTM",123,0)
 ;
"RTN","ZTM",124,0)
I4 ;job off a new submanager if the Job List still has tasks
"RTN","ZTM",125,0)
 I $D(^%ZTSCH("JOB"))>9 D NEWJOB(%ZTUCI,%ZTVOL,"")
"RTN","ZTM",126,0)
 Q
"RTN","ZTM",127,0)
 ;
"RTN","ZTM",128,0)
I5 ;Clean up %ZTSCH
"RTN","ZTM",129,0)
 S ZTDTH="0,0" F  S ZTDTH=$O(^%ZTSCH(ZTDTH)) Q:ZTDTH'[","  D
"RTN","ZTM",130,0)
 . N ZTSK,X L +^%ZTSCH(ZTDTH):0 Q:'$T
"RTN","ZTM",131,0)
 . S ZTSK=$O(^%ZTSCH(ZTDTH,0)) I ZTSK>0 S X=^(ZTSK),^%ZTSCH($$H3(ZTDTH),ZTSK)=X K ^%ZTSCH(ZTDTH,ZTSK)
"RTN","ZTM",132,0)
 . L -^%ZTSCH(ZTDTH)
"RTN","ZTM",133,0)
 . Q
"RTN","ZTM",134,0)
 Q
"RTN","ZTM",135,0)
 ;
"RTN","ZTM",136,0)
I6 ;Check on persistent jobs.
"RTN","ZTM",137,0)
 S ZTSK=0 F  S ZTSK=$O(^%ZTSCH("TASK",ZTSK)) Q:ZTSK'>0  D:$D(^%ZTSCH("TASK",ZTSK,"P"))
"RTN","ZTM",138,0)
 . L +^%ZTSCH("TASK",ZTSK):0 E  Q  ;Still running
"RTN","ZTM",139,0)
 . L -^%ZTSCH("TASK",ZTSK)
"RTN","ZTM",140,0)
 . D REQP^%ZTLOAD3(ZTSK) ;START NEW TASK.
"RTN","ZTM",141,0)
 K %ZTVS Q
"RTN","ZTM",142,0)
 ;
"RTN","ZTM",143,0)
MON ;Set Next %ZTMON each Hour
"RTN","ZTM",144,0)
 S %ZTMON=$P($H,",",2)\3600,%ZTMON(%ZTMON)=0
"RTN","ZTM",145,0)
 S %ZTMON("NEXT")=($H*86400)+(%ZTMON+1*3600)
"RTN","ZTM",146,0)
 D HOUR^%ZTM5
"RTN","ZTM",147,0)
 I %ZTMON("DAY")<+$H D DAY^%ZTM5
"RTN","ZTM",148,0)
 Q
"RTN","ZTM",149,0)
 ;
"RTN","ZTM",150,0)
NEWJOB(ZTUCI,ZTDVOL,ZTNODE) ;Start a new Job
"RTN","ZTM",151,0)
 S ZTUCI=$G(ZTUCI),ZTDVOL=$G(ZTDVOL),ZTNODE=$G(ZTNODE)
"RTN","ZTM",152,0)
 X %ZTJOB H %ZTSLO ;If job doesn't work, will catch next time.
"RTN","ZTM",153,0)
 Q
"RTN","ZTM",154,0)
 ;
"RTN","ZTM",155,0)
DIFF(N,O,T) ;Diff in sec.
"RTN","ZTM",156,0)
 Q:$G(T) N-O ;For new seconds times
"RTN","ZTM",157,0)
 Q N-O*86400-$P(O,",",2)+$P(N,",",2)
"RTN","ZTM",158,0)
 ;
"RTN","ZTM",159,0)
OOS(BV) ;Check if Box-Volume is Out Of Service, Return 1 if OOS.
"RTN","ZTM",160,0)
 Q:BV="" 0 N %
"RTN","ZTM",161,0)
 S %=$O(^%ZIS(14.7,"B",BV,0)),%=$G(^%ZIS(14.7,+%,0))
"RTN","ZTM",162,0)
 Q:%="" 1 Q $P(%,U,11)=1
"RTN","ZTM",163,0)
 ;
"RTN","ZTM",164,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTM",165,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTM",166,0)
H0(%) ;Covert from seconds to $H
"RTN","ZTM",167,0)
 Q (%\86400)_","_(%#86400)
"RTN","ZTM",168,0)
SUBOK() ;Check if sub's are starting, return 1 if OK
"RTN","ZTM",169,0)
 S ^%ZTSCH("SUB",%ZTPAIR,0)=($G(^%ZTSCH("SUB",%ZTPAIR,0))+1)_"^"_$H
"RTN","ZTM",170,0)
 Q ^%ZTSCH("SUB",%ZTPAIR,0)<10
"RTN","ZTM",171,0)
 ;
"RTN","ZTM",172,0)
NEWSUB() ;See if we need a new submanager
"RTN","ZTM",173,0)
 N SUBS
"RTN","ZTM",174,0)
 L +^%ZTSCH("SUB",%ZTPAIR):0 S SUBS=^%ZTSCH("SUB",%ZTPAIR)
"RTN","ZTM",175,0)
 L -^%ZTSCH("SUB",%ZTPAIR)
"RTN","ZTM",176,0)
 I SUBS<%ZTPFLG("MINSUB") Q 1
"RTN","ZTM",177,0)
 Q 0
"RTN","ZTM",178,0)
 ;
"RTN","ZTM",179,0)
TSKSTAT(CODE,MSG) ; Update task's status
"RTN","ZTM",180,0)
 S $P(^%ZTSK(ZTSK,.1),U,1,3)=$G(CODE)_U_$H_U_$G(MSG)
"RTN","ZTM",181,0)
 Q
"RTN","ZTM0")
0^41^B15924444
"RTN","ZTM0",1,0)
%ZTM0 ;SEA/RDS-TaskMan: Manager, Part 2 (Begin) ;22 Jan 2003 6:07 pm
"RTN","ZTM0",2,0)
 ;;8.0;KERNEL;**42,36,67,88,118,127,136,175,275**;JUL 10, 1995;
"RTN","ZTM0",3,0)
 ;
"RTN","ZTM0",4,0)
START ;Entry Point--start Task Manager at system startup
"RTN","ZTM0",5,0)
 S $ETRAP="D ER^%ZTM5",^%ZTSCH("ER")="",U="^"
"RTN","ZTM0",6,0)
 D STATUS^%ZTM("RUN","Startup")
"RTN","ZTM0",7,0)
 L ^%ZTSCH:10 G:'$T RESTART ;Someone already running
"RTN","ZTM0",8,0)
 K ^%ZTSCH("DEV"),^("DEVOPEN"),^("LOAD"),^("LOADA"),^("STATUS"),^("STOP"),^("UPDATE")
"RTN","ZTM0",9,0)
 D I6^%ZTM ;Handle Persistent Jobs
"RTN","ZTM0",10,0)
 S ZTSK=0 F  S ZTSK=$O(^%ZTSCH("TASK",ZTSK)) Q:'ZTSK  D
"RTN","ZTM0",11,0)
 . D TSKSTAT^%ZTM1("E","Interrupted While Running")
"RTN","ZTM0",12,0)
 . K ^%ZTSCH("TASK",ZTSK)
"RTN","ZTM0",13,0)
 D SETUP
"RTN","ZTM0",14,0)
 K ^%ZTSCH("TASK"),^%ZTSCH("SUB")
"RTN","ZTM0",15,0)
 S ^%ZTSCH("IDLE")=0,^%ZTSCH("SUB",%ZTPAIR)=0,^(%ZTPAIR,0)=0
"RTN","ZTM0",16,0)
 D STATUS^%ZTM("RUN","Startup Hang")
"RTN","ZTM0",17,0)
 I "CFO"[%ZTYPE G BADTYPE
"RTN","ZTM0",18,0)
 H %ZTPFLG("TM-DELAY") ;Wait for system stability.
"RTN","ZTM0",19,0)
S1 ;
"RTN","ZTM0",20,0)
 D STATUS^%ZTM("RUN","Startup jobs")
"RTN","ZTM0",21,0)
 S %ZTLOOP=0 D CHECK^%ZTM
"RTN","ZTM0",22,0)
 D STRTUP
"RTN","ZTM0",23,0)
 S ZTU="" F  S ZTU=$O(^%ZTSCH("C",ZTU)) Q:ZTU=""  S ^%ZTSCH("C",ZTU)=0 ;Reset VS counts in C list.
"RTN","ZTM0",24,0)
 K %ZTI,%ZTY,ZTIO,ZTO,ZTP,ZTSK,ZTU
"RTN","ZTM0",25,0)
 I %ZTPFLG("XUSCNT") D COUNT^XUSCNT(1)
"RTN","ZTM0",26,0)
 G ^%ZTM
"RTN","ZTM0",27,0)
 ;
"RTN","ZTM0",28,0)
RESTART ;Entry Point--restart Task Manager
"RTN","ZTM0",29,0)
 S $ETRAP="D ER^%ZTM5",^%ZTSCH("ER")="",U="^"
"RTN","ZTM0",30,0)
 D STATUS^%ZTM("RUN","Restart")
"RTN","ZTM0",31,0)
 K ^%ZTSCH("STATUS"),^("STOP")
"RTN","ZTM0",32,0)
 D SETUP
"RTN","ZTM0",33,0)
 I '$D(^%ZTSCH("IDLE")) S ^%ZTSCH("IDLE")=0
"RTN","ZTM0",34,0)
 I '$D(^%ZTSCH("SUB",%ZTPAIR)) S ^%ZTSCH("SUB",%ZTPAIR)=0
"RTN","ZTM0",35,0)
 I "CFO"[%ZTYPE G BADTYPE
"RTN","ZTM0",36,0)
 I %ZTPFLG("XUSCNT") D COUNT^XUSCNT(1)
"RTN","ZTM0",37,0)
 G ^%ZTM
"RTN","ZTM0",38,0)
 ;
"RTN","ZTM0",39,0)
 ;
"RTN","ZTM0",40,0)
SETUP ;Setup Task Manager's Environment
"RTN","ZTM0",41,0)
 N X,Y,Z,ZT
"RTN","ZTM0",42,0)
ST2 S ^%ZTSCH("RUN")=$H,%ZTPAIR="ROU"
"RTN","ZTM0",43,0)
 D STATUS^%ZTM("RUN","Setup")
"RTN","ZTM0",44,0)
 D ZOSF I Y]"" D STATUS^%ZTM("PAUSE","The following required ^%ZOSF nodes are undefined: "_Y_".") H 60 G ST2
"RTN","ZTM0",45,0)
 D UPDATE^%ZTM5 I $D(ZTREQUIR)#2 D STATUS^%ZTM("PAUSE","Required link to "_ZTREQUIR_" is down.") H 60 G ST2
"RTN","ZTM0",46,0)
 ;Clear the NOT Responding count
"RTN","ZTM0",47,0)
 S X="" F  S X=$O(^%ZTSCH("C",X)) Q:X=""  S ^%ZTSCH("C",X)=0
"RTN","ZTM0",48,0)
 D JOB,NOLOG^%ZOSV S %ZTNLG=Y,DTIME=0,DUZ=0,DUZ(0)="@"
"RTN","ZTM0",49,0)
 K Z D NAME K X,Y,Z,ZT
"RTN","ZTM0",50,0)
 Q
"RTN","ZTM0",51,0)
STRTUP ;Queue the entries from the STARTUP X-ref
"RTN","ZTM0",52,0)
 ;After talking with the DBA, All STARTUP jobs will have DUZ=.5
"RTN","ZTM0",53,0)
 N ZTU,ZTO,ZTSAVE,ZTRTN,DUZ
"RTN","ZTM0",54,0)
 S DUZ=.5,DUZ(0)="@"
"RTN","ZTM0",55,0)
 S ZTU="" F  S ZTU=$O(^%ZTSCH("STARTUP",ZTU)),ZTO="" Q:ZTU=""  F  S ZTO=$O(^%ZTSCH("STARTUP",ZTU,ZTO)) Q:ZTO=""  D
"RTN","ZTM0",56,0)
 . S ZTSAVE("XQY")=$P(ZTO,"Q",2) ;This must be set for %ZTLOAD
"RTN","ZTM0",57,0)
 . S ZTDTH=$H,ZTIO=$P(^%ZTSCH("STARTUP",ZTU,ZTO),"^",2),ZTRTN="ZTSK^XQ1",ZTSAVE($S(ZTO["Q":"XQSCH",1:"XQY"))=+ZTO,ZTUCI=$P(ZTU,","),ZTCPU=$P(ZTU,",",2)
"RTN","ZTM0",58,0)
 . D ^%ZTLOAD
"RTN","ZTM0",59,0)
 . Q
"RTN","ZTM0",60,0)
 Q
"RTN","ZTM0",61,0)
 ;
"RTN","ZTM0",62,0)
ZOSF ;SETUP--determine whether any required ^%ZOSF nodes are missing
"RTN","ZTM0",63,0)
 S Y=""
"RTN","ZTM0",64,0)
 F X="ACTJ","OS","PROD","UCI","UCICHECK","VOL" I $D(^%ZOSF(X))[0 S Y=Y_","_X
"RTN","ZTM0",65,0)
 S:$T(ACTJ^%ZOSV)="" Y=Y_",ACTJ^%ZOSV"
"RTN","ZTM0",66,0)
 I Y]"" S Y=$E(Y,2,$L(Y))
"RTN","ZTM0",67,0)
 Q
"RTN","ZTM0",68,0)
 ;
"RTN","ZTM0",69,0)
JOB ;SETUP--setup JOB command
"RTN","ZTM0",70,0)
 I %ZTOS["VAX DSM" D  Q
"RTN","ZTM0",71,0)
 . S:'$L(%ZTPFLG("DCL")) %ZTJOB="J ^%ZTMS:(OPTION=""/UCI=""_$P(ZTUCI,"","")_""/VOL=""_ZTDVOL):5"
"RTN","ZTM0",72,0)
 . S:$L(%ZTPFLG("DCL")) %ZTJOB="D ^%ZTMDCL"
"RTN","ZTM0",73,0)
 . Q
"RTN","ZTM0",74,0)
 I %ZTOS["OpenM" S %ZTJOB="J ^%ZTMS::5" Q  ;"J ^%ZTMS:ZTUCI:5"
"RTN","ZTM0",75,0)
 I %ZTOS["GT.M" S %ZTJOB="J GTM^%ZTMS::5",$ZINTERRUPT="I $$JOBEXAM^ZU($ZPOSITION)" Q
"RTN","ZTM0",76,0)
 I %ZTOS["M/SQL" S %ZTJOB="J ^%ZTMS:ZTUCI" Q
"RTN","ZTM0",77,0)
 I %ZTOS["MSM" S %ZTJOB="J ^%ZTMS[ZTUCI,ZTDVOL]:%ZTSIZ:5" Q  ;Set Maxpartsiz
"RTN","ZTM0",78,0)
 I %ZTOS["DTM" S %ZTJOB="J ^%ZTMS:(NSPACE=ZTUCI)" Q
"RTN","ZTM0",79,0)
 S %ZTJOB="J ^%ZTMS::5"
"RTN","ZTM0",80,0)
 Q
"RTN","ZTM0",81,0)
 ;
"RTN","ZTM0",82,0)
NAME ;Give a name to process.
"RTN","ZTM0",83,0)
 N $ETRAP,ZQ S $ETRAP="S ZQ=0,$EC="""" Q"
"RTN","ZTM0",84,0)
 F Z=1:1:9 S X="Taskman "_%ZTVOL_" "_Z,ZQ=1 D SETENV^%ZOSV Q:ZQ
"RTN","ZTM0",85,0)
 Q
"RTN","ZTM0",86,0)
BADTYPE ;Taskman should not run on this type of node.
"RTN","ZTM0",87,0)
 K ^%ZTSCH("STATUS")
"RTN","ZTM0",88,0)
 S ^%ZTSCH("RUN")=%ZTPAIR_" is the wrong type in taskman site parameters."
"RTN","ZTM0",89,0)
 Q
"RTN","ZTM0",90,0)
 ;
"RTN","ZTM0",91,0)
HALT ;Cleanup and halt
"RTN","ZTM0",92,0)
 I %ZTPFLG("XUSCNT") D COUNT^XUSCNT(-1)
"RTN","ZTM0",93,0)
 K ^%ZTSCH("STATUS",$J),^%ZTSCH("RUN"),^%ZTSCH("UPDATE",$J)
"RTN","ZTM0",94,0)
 K ^%ZTSCH("LOADA",%ZTPAIR)
"RTN","ZTM0",95,0)
 HALT
"RTN","ZTM1")
0^45^B20977172
"RTN","ZTM1",1,0)
%ZTM1 ;SEA/RDS-TaskMan: Manager, Part 3 (Validate Task) ;04 Jun 2003 2:54 pm
"RTN","ZTM1",2,0)
 ;;8.0;KERNEL;**118,127,275**;JUL 10, 1995;
"RTN","ZTM1",3,0)
MAIN ;
"RTN","ZTM1",4,0)
 ;SCHQ^%ZTM--examine task, determine device and destination, ^%ZTSK(ZTSK) lock at call.
"RTN","ZTM1",5,0)
 D LOOKUP D  D STORE
"RTN","ZTM1",6,0)
 .D ZIS I %ZTREJCT Q
"RTN","ZTM1",7,0)
 .D VOLUME I %ZTREJCT Q
"RTN","ZTM1",8,0)
 .D UCI I %ZTREJCT Q
"RTN","ZTM1",9,0)
 .Q
"RTN","ZTM1",10,0)
 Q  ;Un-lock back in %ZTM
"RTN","ZTM1",11,0)
LOOKUP ;
"RTN","ZTM1",12,0)
 ;MAIN--Unload Task Variables For Validation
"RTN","ZTM1",13,0)
 S %ZTREJCT=0
"RTN","ZTM1",14,0)
 D TSKSTAT(2,"Inspected")
"RTN","ZTM1",15,0)
 S ZTREC=^%ZTSK(ZTSK,0)
"RTN","ZTM1",16,0)
 S ZTREC02="",ZTREC1=$G(^%ZTSK(ZTSK,.1)),ZTREC2=$G(^%ZTSK(ZTSK,.2))
"RTN","ZTM1",17,0)
 S ZTREC25=$G(^%ZTSK(ZTSK,.25)) ;,$P(ZTREC,U,6)=ZTDTH
"RTN","ZTM1",18,0)
 K ^%ZTSK(ZTSK,.02)
"RTN","ZTM1",19,0)
 Q
"RTN","ZTM1",20,0)
ZIS ;
"RTN","ZTM1",21,0)
 ;MAIN--Determine Output Device
"RTN","ZTM1",22,0)
 S ZTIO=$S($P(ZTREC2,U)]"":$P(ZTREC2,U),1:ZTST)
"RTN","ZTM1",23,0)
 I ZTIO="" S (IO,ZTREC2,ZTREC21,ZTREC25)="" G ZISX
"RTN","ZTM1",24,0)
 S $P(ZTREC2,U)=ZTIO,%ZIS="NQRST0",IOP=ZTIO,ZTIO(1)=$P(ZTREC2,U,5)
"RTN","ZTM1",25,0)
 I ZTIO(1)="DIRECT" S %ZIS=%ZIS_"D"
"RTN","ZTM1",26,0)
 D ^%ZIS K IO(1)
"RTN","ZTM1",27,0)
 I $S($G(IOT)="VTRM":1,IO="":1,1:POP) D REJCT("INVALID OUTPUT DEVICE") G ZISX
"RTN","ZTM1",28,0)
 I IOT="HG" S IO=""
"RTN","ZTM1",29,0)
 ;Check for IO queue at end
"RTN","ZTM1",30,0)
 S $P(ZTREC2,U,1,4)=ZTIO_U_IO_U_IOT_U_IOST
"RTN","ZTM1",31,0)
 S:'$D(IOCPU) IOCPU=$P($G(^%ZIS(1,+$G(IOS),0)),U,9) ;need IOCPU
"RTN","ZTM1",32,0)
 S ZTREC21=$G(IOS)
"RTN","ZTM1",33,0)
ZISX Q
"RTN","ZTM1",34,0)
VOLUME ;
"RTN","ZTM1",35,0)
 ;determine destination volume set
"RTN","ZTM1",36,0)
 S ZTDVOL(1)="",A=$P($G(IOCPU),":",2) ;device node
"RTN","ZTM1",37,0)
 S ZTNODE=$S(A]"":A,1:$P($P(ZTREC,U,14),":",2))
"RTN","ZTM1",38,0)
 S A=$S(ZTIO="":"",1:$P($G(IOCPU),":")) ;device cpu
"RTN","ZTM1",39,0)
 S ZTDVOL=$S(A]"":A,1:$P($P(ZTREC,U,14),":")) ;Destination
"RTN","ZTM1",40,0)
 S ZTCVOL=$P(ZTREC,U,12),ZTCVT=$$VSTYP(ZTCVOL) ;Creation
"RTN","ZTM1",41,0)
 I ZTDVOL="" D
"RTN","ZTM1",42,0)
 . I ZTCVT="C" S ZTDVOL=$S(%ZTYPE="P":%ZTVOL,ZTCVOL]"":ZTCVOL,1:%ZTVOL),ZTDVOL(1)=1 Q
"RTN","ZTM1",43,0)
 . S ZTDVOL=$S(ZTCVOL]"":ZTCVOL,1:%ZTVOL) Q
"RTN","ZTM1",44,0)
 S ZTREC02=U_ZTDVOL_U_ZTNODE_U_ZTDVOL(1)
"RTN","ZTM1",45,0)
V1 ;
"RTN","ZTM1",46,0)
 ;reject tasks with destination volume sets not in Volume Set file
"RTN","ZTM1",47,0)
 S ZT1=$O(^%ZIS(14.5,"B",ZTDVOL,""))
"RTN","ZTM1",48,0)
 I ZT1="" D REJCT("Task's volume set not listed in index.") Q
"RTN","ZTM1",49,0)
 S ZTS=$G(^%ZIS(14.5,ZT1,0))
"RTN","ZTM1",50,0)
 I ZTS="" D REJCT("Task's volume set not listed in file.") Q
"RTN","ZTM1",51,0)
V2 ;
"RTN","ZTM1",52,0)
 ;lookup type of volume set, and reject tasks to F or O types
"RTN","ZTM1",53,0)
 S ZTYPE=$P(ZTS,U,10)
"RTN","ZTM1",54,0)
 I ZTYPE="F"!(ZTYPE="O") D REJCT("Task's volume set can't accept tasks.") Q
"RTN","ZTM1",55,0)
V3 ;
"RTN","ZTM1",56,0)
 ;accept tasks with the current volume set as the destination
"RTN","ZTM1",57,0)
 I ZTDVOL=%ZTVOL Q
"RTN","ZTM1",58,0)
V4 ;
"RTN","ZTM1",59,0)
 ;reject tasks whose destination volume sets lack link access
"RTN","ZTM1",60,0)
 I $P(ZTS,U,3)="N" D REJCT("Task's volume set has no link access.") Q
"RTN","ZTM1",61,0)
 Q
"RTN","ZTM1",62,0)
VSTYP(VS) ;Get a VS's type
"RTN","ZTM1",63,0)
 Q:VS="" VS N %
"RTN","ZTM1",64,0)
 S %=$O(^%ZIS(14.5,"B",VS,0)),%=$G(^%ZIS(14.5,+%,0))
"RTN","ZTM1",65,0)
 Q $P(%,U,10)
"RTN","ZTM1",66,0)
UCI ;
"RTN","ZTM1",67,0)
 ;MAIN--determine destination UCI
"RTN","ZTM1",68,0)
 S ZTUCI=$P($P(ZTREC,U,4),",")
"RTN","ZTM1",69,0)
 S ZTUCI=$S(ZTUCI]"":ZTUCI,1:$P(ZTREC,U,11))
"RTN","ZTM1",70,0)
 ;
"RTN","ZTM1",71,0)
 ;reject tasks that lack a destination UCI
"RTN","ZTM1",72,0)
U1 ;
"RTN","ZTM1",73,0)
 ;reject tasks with no UCI of origin or requested destination
"RTN","ZTM1",74,0)
 I ZTUCI="" D REJCT("Task has no destination UCI listed.") Q
"RTN","ZTM1",75,0)
U2 ;
"RTN","ZTM1",76,0)
 ;handle tasks whose destination volume set is the current one
"RTN","ZTM1",77,0)
 ;if UCI is here, accept the task; if not, reject it
"RTN","ZTM1",78,0)
 I ZTDVOL=%ZTVOL D  Q
"RTN","ZTM1",79,0)
 . S X=ZTUCI_","_ZTDVOL X ^%ZOSF("UCICHECK")
"RTN","ZTM1",80,0)
 . I 0[Y D REJCT("Task's UCI does not exist here.") Q
"RTN","ZTM1",81,0)
 . S ZTUCI=$P(Y,",")
"RTN","ZTM1",82,0)
 . S $P(ZTREC02,U)=ZTUCI
"RTN","ZTM1",83,0)
 . I $E($P(ZTREC,U,2))'="%" Q
"RTN","ZTM1",84,0)
 . S X=$P(ZTREC,U,2) X ^%ZOSF("TEST")
"RTN","ZTM1",85,0)
 . I $T Q
"RTN","ZTM1",86,0)
 . D REJCT("Task's entry routine does not exist here.")
"RTN","ZTM1",87,0)
 .Q
"RTN","ZTM1",88,0)
U3 ;
"RTN","ZTM1",89,0)
 ;accept tasks whose dest. UCIs are listed under their dest. volume sets
"RTN","ZTM1",90,0)
 I $O(^%ZIS(14.6,"AV",ZTDVOL,ZTUCI,"")) S $P(ZTREC02,U)=ZTUCI Q
"RTN","ZTM1",91,0)
U4 ;
"RTN","ZTM1",92,0)
 ;otherwise, the destination UCI must be a valid one here...
"RTN","ZTM1",93,0)
 S X=ZTUCI X ^%ZOSF("UCICHECK")
"RTN","ZTM1",94,0)
 I 0[Y D REJCT("Task's destination UCI failed check.") Q
"RTN","ZTM1",95,0)
U5 ;
"RTN","ZTM1",96,0)
 ;...and it must be changed to the associated UCI over there
"RTN","ZTM1",97,0)
 S ZT1=$O(^%ZIS(14.6,"AT",ZTUCI,%ZTVOL,ZTDVOL,""))
"RTN","ZTM1",98,0)
 I ZT1]"" S ZTUCI=ZT1
"RTN","ZTM1",99,0)
 S $P(ZTREC02,U)=ZTUCI
"RTN","ZTM1",100,0)
 Q
"RTN","ZTM1",101,0)
STORE ;Store Validated Data In Task Log, Quit If Needn't Do WAIT
"RTN","ZTM1",102,0)
 I %ZTREJCT S $P(ZTREC1,U,1,2)="B^"_$H ;Rejected
"RTN","ZTM1",103,0)
 I $D(^%ZTSK(ZTSK,0))[0 D TSKSTAT("I") S %ZTREJCT=1 Q
"RTN","ZTM1",104,0)
 S ^%ZTSK(ZTSK,0)=ZTREC
"RTN","ZTM1",105,0)
 S ^%ZTSK(ZTSK,.02)=ZTREC02
"RTN","ZTM1",106,0)
 S ^%ZTSK(ZTSK,.1)=$P(ZTREC1,U,1,9)_U_$P(^(.1),U,10,11)
"RTN","ZTM1",107,0)
 S ^%ZTSK(ZTSK,.2)=ZTREC2,^(.21)=ZTREC21,^(.25)=ZTREC25
"RTN","ZTM1",108,0)
 K %ZTF,IOCPU
"RTN","ZTM1",109,0)
 I ZTIO="" Q
"RTN","ZTM1",110,0)
 I %ZTREJCT Q
"RTN","ZTM1",111,0)
 I ZTDVOL'=%ZTVOL Q
"RTN","ZTM1",112,0)
 I IOT'="TRM",IOT'="RES" Q
"RTN","ZTM1",113,0)
 I $D(^%ZTSCH("IO",IO))>9 D IOWAIT
"RTN","ZTM1",114,0)
 K X,Y
"RTN","ZTM1",115,0)
 Q
"RTN","ZTM1",116,0)
 ;
"RTN","ZTM1",117,0)
IOWAIT ;If Device has a queue, Put Task On IO Queue.
"RTN","ZTM1",118,0)
 S %ZTREJCT=1 D TSKSTAT("A","Put On The IO List")
"RTN","ZTM1",119,0)
 S %ZTIO=IO,ZTIOS=ZTREC21,ZTIOT=IOT
"RTN","ZTM1",120,0)
 D NQ^%ZTM4
"RTN","ZTM1",121,0)
 Q
"RTN","ZTM1",122,0)
 ;
"RTN","ZTM1",123,0)
REJCT(MSG) ;Save reject msg, set flag
"RTN","ZTM1",124,0)
 S %ZTREJCT=1,$P(ZTREC1,U,3)=MSG
"RTN","ZTM1",125,0)
 I $G(DUZ)>.9 D
"RTN","ZTM1",126,0)
 . N XQA,XQAMSG,XQADATA,XQAROU,ZTUCI
"RTN","ZTM1",127,0)
 . S XQA(DUZ)="",XQAMSG="Your task #"_ZTSK_" rejected because: "_MSG,XQADATA=ZTSK,XQAROU="XQA^XUTMUTL"
"RTN","ZTM1",128,0)
 . S ZTUCI=$P($P(ZTREC,U,4),","),ZTUCI=$S(ZTUCI]"":ZTUCI,1:$P(ZTREC,U,11))
"RTN","ZTM1",129,0)
 . N ZTSK,ZTIO,ZTDTH,ZTCPU,ZTREC
"RTN","ZTM1",130,0)
 . S ZTRTN="ALERT^%ZTMS4",ZTDTH=$H,ZTIO="",ZTSAVE("XQA*")=""
"RTN","ZTM1",131,0)
 . D ^%ZTLOAD Q
"RTN","ZTM1",132,0)
 Q
"RTN","ZTM1",133,0)
 ;
"RTN","ZTM1",134,0)
TSKSTAT(CODE,MSG) ; Update task's status
"RTN","ZTM1",135,0)
 S $P(^%ZTSK(ZTSK,.1),"^",1,3)=$G(CODE)_U_$H_U_$G(MSG)
"RTN","ZTM1",136,0)
 Q
"RTN","ZTM1",137,0)
 ;
"RTN","ZTM1",138,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTM1",139,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTM2")
0^46^B12942741
"RTN","ZTM2",1,0)
%ZTM2 ;SEA/RDS-TaskMan: Manager, Part 4 (Link Handling 1) ;22 May 2003 10:17 am
"RTN","ZTM2",2,0)
 ;;8.0;KERNEL;**23,118,275**;JUL 10, 1995
"RTN","ZTM2",3,0)
 ;
"RTN","ZTM2",4,0)
XLINK ;SEND^%ZTM--determine routing of XCPU task
"RTN","ZTM2",5,0)
 S ZTJOBIT=0
"RTN","ZTM2",6,0)
 S ZTI=$O(^%ZIS(14.5,"B",ZTDVOL,""))
"RTN","ZTM2",7,0)
 S ZTS=^%ZIS(14.5,ZTI,0)
"RTN","ZTM2",8,0)
 I $P(ZTS,U,4)="Y" G DOWN
"RTN","ZTM2",9,0)
 S ZTM=$P(ZTS,U,6)
"RTN","ZTM2",10,0)
 S ZTN=$P(ZTS,U,7) I ZTN S ZTN=$P(^%ZIS(14.5,ZTN,0),U)
"RTN","ZTM2",11,0)
 I ZTN="" S ZTN=ZTDVOL
"RTN","ZTM2",12,0)
 I ZTN=%ZTVOL S ZTJOBIT=1 Q
"RTN","ZTM2",13,0)
 I $D(^%ZTSCH("LINK",ZTDVOL)) G DOWN
"RTN","ZTM2",14,0)
 I ZTYPE="C" S ZTJOBIT=1 Q
"RTN","ZTM2",15,0)
 ;
"RTN","ZTM2",16,0)
OCPU ;XLINK--send task to manager on another volume set
"RTN","ZTM2",17,0)
 ;First check how many jumps to other volume sets we have done.
"RTN","ZTM2",18,0)
 I $P(^%ZTSK(ZTSK,.02),"^",3)>2 D REJCT^%ZTM1("Too many hops") Q
"RTN","ZTM2",19,0)
 S $P(^%ZTSK(ZTSK,.02),"^",3)=$P($G(^%ZTSK(ZTSK,.02)),"^",3)+1
"RTN","ZTM2",20,0)
 S X="EROCPU^%ZTM2",@^%ZOSF("TRAP")
"RTN","ZTM2",21,0)
 I '$D(^[ZTM,ZTN]%ZTSCH("RUN")) S ZTT=$H G O1
"RTN","ZTM2",22,0)
 S ZTT=^[ZTM,ZTN]%ZTSCH("RUN")
"RTN","ZTM2",23,0)
 ;
"RTN","ZTM2",24,0)
O1 L +^[ZTM,ZTN]%ZTSK(-1):5
"RTN","ZTM2",25,0)
 S ZTS=^[ZTM,ZTN]%ZTSK(-1)+1
"RTN","ZTM2",26,0)
 F ZT=0:0 Q:'$D(^[ZTM,ZTN]%ZTSK(ZTS))  S ZTS=ZTS+1
"RTN","ZTM2",27,0)
 S ^[ZTM,ZTN]%ZTSK(-1)=ZTS
"RTN","ZTM2",28,0)
 ;
"RTN","ZTM2",29,0)
 L -^[ZTM,ZTN]%ZTSK(-1),+^[ZTM,ZTN]%ZTSK(ZTS)
"RTN","ZTM2",30,0)
 D TSKSTAT^%ZTM1(1,"Ready to Move") ;S $P(^%ZTSK(ZTSK,.1),U,1,3)=1_U_ZTT_U
"RTN","ZTM2",31,0)
 S %X="^%ZTSK(ZTSK,",%Y="^[ZTM,ZTN]%ZTSK(ZTS," D %XY^%RCR
"RTN","ZTM2",32,0)
 ;Now schedule task.
"RTN","ZTM2",33,0)
 S $P(^[ZTM,ZTN]%ZTSK(ZTS,0),U,6)=ZTT,^[ZTM,ZTN]%ZTSCH($$H3^%ZTM(ZTT),ZTS)=""
"RTN","ZTM2",34,0)
 L -^[ZTM,ZTN]%ZTSK(ZTS)
"RTN","ZTM2",35,0)
 ;
"RTN","ZTM2",36,0)
 S X="",@^%ZOSF("TRAP")
"RTN","ZTM2",37,0)
 K ^%ZTSK(ZTSK,.3)
"RTN","ZTM2",38,0)
 D TSKSTAT^%ZTM1(6,"^Moved to "_ZTM_","_ZTN_" as task number "_ZTS)
"RTN","ZTM2",39,0)
 K ZT,ZT1,ZTD,ZTI,ZTM,ZTN,ZTR,ZTS,ZTT,ZTREP Q
"RTN","ZTM2",40,0)
 ;
"RTN","ZTM2",41,0)
EROCPU ;OCPU--trap dropped link and reroute task
"RTN","ZTM2",42,0)
 S X="",@^%ZOSF("TRAP")
"RTN","ZTM2",43,0)
 I $D(^%ZTSCH("LINK"))[0 S ^("LINK")=$H
"RTN","ZTM2",44,0)
 S ^%ZTSCH("LINK",ZTDVOL)=1
"RTN","ZTM2",45,0)
 ;
"RTN","ZTM2",46,0)
DOWN ;XLINK/EROCPU--reroute XCPU task whose link is down
"RTN","ZTM2",47,0)
 D REQRD I $D(ZTREQUIR) G ORIGNL
"RTN","ZTM2",48,0)
 I ZTIO]"",$D(IOCPU)#2,IOCPU]"" G LIST
"RTN","ZTM2",49,0)
 S ZTREP(ZTDVOL)=""
"RTN","ZTM2",50,0)
 S ZTREP=$P(^%ZIS(14.5,ZTI,0),U,8)
"RTN","ZTM2",51,0)
 I ZTREP S ZTREP=$P(^%ZIS(14.5,ZTREP,0),U)
"RTN","ZTM2",52,0)
 I ZTREP="" G ORIGNL
"RTN","ZTM2",53,0)
 I $D(ZTREP(ZTREP))#2 G ORIGNL
"RTN","ZTM2",54,0)
D1 ;
"RTN","ZTM2",55,0)
 I $D(^%ZTSK(ZTSK,.01))[0 S ^%ZTSK(ZTSK,.01)=ZTUCI_U_ZTDVOL
"RTN","ZTM2",56,0)
 S Y=$O(^%ZIS(14.6,"AT",ZTUCI,ZTDVOL,ZTREP,""))
"RTN","ZTM2",57,0)
 I Y="" S Y=ZTUCI
"RTN","ZTM2",58,0)
 S ZTUCI=Y,ZTDVOL=ZTREP
"RTN","ZTM2",59,0)
 I ZTDVOL=%ZTVOL S X=ZTUCI_","_ZTDVOL X ^%ZOSF("UCICHECK") S:0'[Y ZTUCI=Y I 0[Y S %ZTREJCT=1
"RTN","ZTM2",60,0)
 S $P(^%ZTSK(ZTSK,.02),U)=ZTUCI
"RTN","ZTM2",61,0)
 I ZTDVOL'=%ZTVOL S $P(^%ZTSK(ZTSK,.02),U,2)=ZTDVOL
"RTN","ZTM2",62,0)
 E  S $P(^%ZTSK(ZTSK,.02),U,2)=""
"RTN","ZTM2",63,0)
 I %ZTREJCT D TSKSTAT^%ZTM1("B","BAD DESTINATION UCI") Q
"RTN","ZTM2",64,0)
 I ZTDVOL=%ZTVOL G SEND^%ZTM
"RTN","ZTM2",65,0)
 G XLINK
"RTN","ZTM2",66,0)
 ;
"RTN","ZTM2",67,0)
REQRD ;DOWN--is dropped link required?
"RTN","ZTM2",68,0)
 S ZTI=$O(^%ZIS(14.5,"B",ZTDVOL,""))
"RTN","ZTM2",69,0)
 I ZTI="" Q
"RTN","ZTM2",70,0)
 I $D(^%ZIS(14.5,ZTI,0))#2 S ZTS=^(0)
"RTN","ZTM2",71,0)
 E  Q
"RTN","ZTM2",72,0)
 I $P(ZTS,U,5)="Y" S ZTREQUIR=ZTDVOL
"RTN","ZTM2",73,0)
 Q
"RTN","ZTM2",74,0)
 ;
"RTN","ZTM2",75,0)
ORIGNL ;DOWN--give up trying to reroute; make it wait for original destination
"RTN","ZTM2",76,0)
 I $D(^%ZTSK(ZTSK,.01))[0 G LIST
"RTN","ZTM2",77,0)
 S ZTORIGNL=^%ZTSK(ZTSK,.01)
"RTN","ZTM2",78,0)
 S ZTUCI=$P(ZTORIGNL,U)
"RTN","ZTM2",79,0)
 S ZTDVOL=$P(ZTORIGNL,U,2)
"RTN","ZTM2",80,0)
 S $P(^%ZTSK(ZTSK,.02),U)=ZTUCI
"RTN","ZTM2",81,0)
 I ZTDVOL'=%ZTVOL S $P(^%ZTSK(ZTSK,.02),U,2)=ZTDVOL
"RTN","ZTM2",82,0)
 E  S $P(^%ZTSK(ZTSK,.02),U,2)=""
"RTN","ZTM2",83,0)
 ;
"RTN","ZTM2",84,0)
LIST ;DOWN/ORIGNL--place task on waiting list for down volume
"RTN","ZTM2",85,0)
 I $D(^%ZTSCH("LINK"))[0 S ^("LINK")=$H
"RTN","ZTM2",86,0)
 I ZTYPE'="C" S ^%ZTSCH("LINK",ZTDVOL,ZTDTH,ZTSK)=""
"RTN","ZTM2",87,0)
 E  D
"RTN","ZTM2",88,0)
 .S ^%ZTSCH("LINK",ZTDVOL)=1
"RTN","ZTM2",89,0)
 .L +^%ZTSCH("C",ZTDVOL):5
"RTN","ZTM2",90,0)
 .S ^%ZTSCH("C",ZTDVOL,ZTDTH,ZTSK)=""
"RTN","ZTM2",91,0)
 .L -^%ZTSCH("C",ZTDVOL)
"RTN","ZTM2",92,0)
 .Q
"RTN","ZTM2",93,0)
 D TSKSTAT^%ZTM1("G","Link Wait")
"RTN","ZTM2",94,0)
 L  K ZT,ZT1,ZTD,ZTI,ZTM,ZTN,ZTORIGNL,ZTR,ZTS,ZTT,ZTREP Q
"RTN","ZTM2",95,0)
 ;
"RTN","ZTM2",96,0)
ERCL ;I2^%ZTM - error in C list
"RTN","ZTM2",97,0)
 Q:$$OOS^%ZTM(ZTVOL)  N %
"RTN","ZTM2",98,0)
 S %=$O(^%ZIS(14.7,"B",ZTVOL,0))
"RTN","ZTM2",99,0)
 I %>0 S $P(^%ZIS(14.7,%,0),U,11)=1
"RTN","ZTM2",100,0)
 Q
"RTN","ZTM2",101,0)
LKUP(VS) ;Lookup a VS and place in ZTVS
"RTN","ZTM2",102,0)
 N %,%1
"RTN","ZTM2",103,0)
 S %=$O(^%ZIS(14.5,"B",VS,0)),%1=$G(^%ZIS(14.5,+%,0))
"RTN","ZTM2",104,0)
 S %ZTVS(VS)=%1,%ZTVS(VS,"IFN")=% Q
"RTN","ZTM3")
0^47^B8882007
"RTN","ZTM3",1,0)
%ZTM3 ;SEA/RDS-TaskMan: Manager, Part 5 (Link Handling 2) ;22 May 2003 10:21 am
"RTN","ZTM3",2,0)
 ;;8.0;KERNEL;**275**;JUL 10, 1995
"RTN","ZTM3",3,0)
 ;
"RTN","ZTM3",4,0)
LINK ;CHECK^%ZTM/LOOKUP^%ZTM0--test dropped links for recovery
"RTN","ZTM3",5,0)
 L ^%ZTSCH("LINK") S ^%ZTSCH("LINK")=""
"RTN","ZTM3",6,0)
 S ZTDVOL=""
"RTN","ZTM3",7,0)
L0 F ZT=0:0 S ZTDVOL=$O(^%ZTSCH("LINK",ZTDVOL)) Q:ZTDVOL=""  D TEST
"RTN","ZTM3",8,0)
 I $D(^%ZTSCH("LINK"))#2,$O(^%ZTSCH("LINK",""))="" K ^%ZTSCH("LINK")
"RTN","ZTM3",9,0)
 L  K %ZTX,ZT,ZTDVOL,ZTD,ZTDTH,ZTH,ZTI,ZTM,ZTN,ZTR,ZTS,ZTSK,ZTT
"RTN","ZTM3",10,0)
 Q
"RTN","ZTM3",11,0)
 ;
"RTN","ZTM3",12,0)
TEST ;LINK--test dropped link and send tasks if restored
"RTN","ZTM3",13,0)
 S ZTI=$O(^%ZIS(14.5,"B",ZTDVOL,""))
"RTN","ZTM3",14,0)
 S ZTS=^%ZIS(14.5,ZTI,0)
"RTN","ZTM3",15,0)
 I $P(ZTS,U,3)="N" D REJECT Q
"RTN","ZTM3",16,0)
 I $P(ZTS,U,4)="Y" Q
"RTN","ZTM3",17,0)
 S ZTM=$P(ZTS,U,6)
"RTN","ZTM3",18,0)
 S ZTN=$P(ZTS,U,7)
"RTN","ZTM3",19,0)
 I ZTN S ZTNS=^%ZIS(14.5,ZTN,0),ZTN=$P(ZTNS,U)
"RTN","ZTM3",20,0)
 I ZTN="" S ZTN=ZTDVOL
"RTN","ZTM3",21,0)
 E  S ZTS=ZTNS
"RTN","ZTM3",22,0)
T1 ;
"RTN","ZTM3",23,0)
 S X="ERTEST^%ZTM3",@^%ZOSF("TRAP")
"RTN","ZTM3",24,0)
 S X=$D(^[ZTM,ZTN]%ZTSK)
"RTN","ZTM3",25,0)
 S X="",@^%ZOSF("TRAP")
"RTN","ZTM3",26,0)
 I $P(ZTS,U,10)="C" K ^%ZTSCH("LINK",ZTDVOL) Q
"RTN","ZTM3",27,0)
 D XCPU I $O(^%ZTSCH("LINK",ZTDVOL,""))="" K ^%ZTSCH("LINK",ZTDVOL)
"RTN","ZTM3",28,0)
 Q
"RTN","ZTM3",29,0)
 ;
"RTN","ZTM3",30,0)
REJECT ;TEST--reject waiting tasks whose volume set's link access is removed
"RTN","ZTM3",31,0)
 S ZTDTH=""
"RTN","ZTM3",32,0)
R3 S ZTDTH=$O(^%ZTSCH("LINK",ZTDVOL,ZTDTH)) I ZTDTH="" K ^%ZTSCH("LINK",ZTDVOL) Q
"RTN","ZTM3",33,0)
 S ZTSK=""
"RTN","ZTM3",34,0)
R4 S ZTSK=$O(^%ZTSCH("LINK",ZTDVOL,ZTDTH,ZTSK)) I ZTSK="" G R3
"RTN","ZTM3",35,0)
 K ^%ZTSCH("LINK",ZTDVOL,ZTDTH,ZTSK)
"RTN","ZTM3",36,0)
 I '$D(^%ZTSK(ZTSK)) G R4
"RTN","ZTM3",37,0)
 D TSKSTAT^%ZTM1("B","NO LINK ACCESS TO VOLUME SET")
"RTN","ZTM3",38,0)
 G R4
"RTN","ZTM3",39,0)
 ;
"RTN","ZTM3",40,0)
ERTEST ;TEST--trap if dropped link is still down
"RTN","ZTM3",41,0)
 S X="",@^%ZOSF("TRAP")
"RTN","ZTM3",42,0)
 S ^%ZTSCH("LINK")=$H
"RTN","ZTM3",43,0)
 Q
"RTN","ZTM3",44,0)
 ;
"RTN","ZTM3",45,0)
XCPU ;TEST--send saved tasks across reestablished link
"RTN","ZTM3",46,0)
 S X="ERXCPU^%ZTM3",@^%ZOSF("TRAP")
"RTN","ZTM3",47,0)
 I '$D(^[ZTM,ZTN]%ZTSCH("RUN")) S ZTT=$H G X1
"RTN","ZTM3",48,0)
 S ZTR=^[ZTM,ZTN]%ZTSCH("RUN"),ZTH=$H
"RTN","ZTM3",49,0)
 S ZTD=$P(ZTDTH,",",2)+(ZTR-ZTH*86400)+$P(ZTR,",",2)-$P(ZTH,",",2)
"RTN","ZTM3",50,0)
 S ZTT=ZTDTH+ZTR-ZTH+(ZTD\86400)-(ZTD<0)_","_$S(ZTD<0:0,1:ZTD#86400)
"RTN","ZTM3",51,0)
 ;
"RTN","ZTM3",52,0)
X1 S ZTDTH=""
"RTN","ZTM3",53,0)
X3 S ZTDTH=$O(^%ZTSCH("LINK",ZTDVOL,ZTDTH)) I ZTDTH="" Q
"RTN","ZTM3",54,0)
 S ZTSK=""
"RTN","ZTM3",55,0)
X4 S ZTSK=$O(^%ZTSCH("LINK",ZTDVOL,ZTDTH,"")) I ZTSK="" G X3
"RTN","ZTM3",56,0)
 K ^%ZTSCH("LINK",ZTDVOL,ZTDTH,ZTSK)
"RTN","ZTM3",57,0)
 I $D(^%ZTSK(ZTSK,0))[0 G X4
"RTN","ZTM3",58,0)
 I $L($P($G(^%ZTSK(ZTSK,.1)),U,10)) D TSKSTAT^%ZTM1("D","Stopped while waiting for Link") G X4
"RTN","ZTM3",59,0)
 ;
"RTN","ZTM3",60,0)
 L ^[ZTM,ZTN]%ZTSK(-1)
"RTN","ZTM3",61,0)
 S ZTS=^[ZTM,ZTN]%ZTSK(-1)+1
"RTN","ZTM3",62,0)
 F ZTI=0:0 Q:'$D(^[ZTM,ZTN]%ZTSK(ZTS))  S ZTS=ZTS+1
"RTN","ZTM3",63,0)
 S ^[ZTM,ZTN]%ZTSK(-1)=ZTS
"RTN","ZTM3",64,0)
 ;
"RTN","ZTM3",65,0)
 L (^%ZTSK(ZTSK),^[ZTM,ZTN]%ZTSK(ZTS))
"RTN","ZTM3",66,0)
 D TSKSTAT^%ZTM1(1,"Link")
"RTN","ZTM3",67,0)
 S %X="^%ZTSK(ZTSK,",%Y="^[ZTM,ZTN]%ZTSK(ZTS," D %XY^%RCR
"RTN","ZTM3",68,0)
 S $P(^[ZTM,ZTN]%ZTSK(ZTS,0),U,6)=ZTT
"RTN","ZTM3",69,0)
 S ^[ZTM,ZTN]%ZTSCH(ZTT,ZTS)=""
"RTN","ZTM3",70,0)
 ;
"RTN","ZTM3",71,0)
 K ^%ZTSK(ZTSK)
"RTN","ZTM3",72,0)
 L ^%ZTSCH("LINK")
"RTN","ZTM3",73,0)
 G X4
"RTN","ZTM3",74,0)
 ;
"RTN","ZTM3",75,0)
ERXCPU ;XCPU--trap if link drops again while a task is being sent
"RTN","ZTM3",76,0)
 S X="",@^%ZOSF("TRAP")
"RTN","ZTM3",77,0)
 I ^%ZTSCH("LINK")="" S ^("LINK")=$H
"RTN","ZTM3",78,0)
 I ZTSK]"",$D(^%ZTSK(ZTSK,0))#2 D TSKSTAT^%ZTM1("G","Link Error")
"RTN","ZTM3",79,0)
 L ^%ZTSCH("LINK")
"RTN","ZTM3",80,0)
 Q
"RTN","ZTM3",81,0)
 ;
"RTN","ZTM5")
0^49^B14928719
"RTN","ZTM5",1,0)
%ZTM5 ;SEA/RDS-TaskMan: Manager, Part 5 (Short Subroutines) ;10/29/2003  22:07
"RTN","ZTM5",2,0)
 ;;8.0;KERNEL;**24,36,118,127,136,162,275**;JUL 10, 1995;
"RTN","ZTM5",3,0)
 ;
"RTN","ZTM5",4,0)
ER ;primary error trap for manager
"RTN","ZTM5",5,0)
 S %ZTERLGR=$$LGR^%ZOSV
"RTN","ZTM5",6,0)
 S $ETRAP="D ER2^%ZTM5"
"RTN","ZTM5",7,0)
 L  S ^%ZTSCH("RUN")=$H
"RTN","ZTM5",8,0)
 S ^%ZTSCH("STATUS",$J)=$H_"^ERROR^Recording A Trapped Error."
"RTN","ZTM5",9,0)
 ;
"RTN","ZTM5",10,0)
 S ZTERCODE=$$EC^%ZOSV,ZTE=""
"RTN","ZTM5",11,0)
 I '$$SCREEN^%ZTER(ZTERCODE) D
"RTN","ZTM5",12,0)
 . L ^%ZTSCH("ER") H 1 S ZT=$H
"RTN","ZTM5",13,0)
 . S ^%ZTSCH("ER",+ZT,$P(ZT,",",2))=ZTERCODE
"RTN","ZTM5",14,0)
 . S ^($P(ZT,",",2),1)="Caused by the manager." L
"RTN","ZTM5",15,0)
 . Q
"RTN","ZTM5",16,0)
 ;
"RTN","ZTM5",17,0)
 D ^%ZTER K ZTERCODE
"RTN","ZTM5",18,0)
 ;Lets wait before restarting.
"RTN","ZTM5",19,0)
ER2 H 10 S $ET="Q:$STACK  S $EC="""" G RESTART^%ZTM0" S $EC=",U99,"
"RTN","ZTM5",20,0)
 ;
"RTN","ZTM5",21,0)
UPDATE ;CHECK^%ZTM/LOOKUP^%ZTM0--update TaskMan site parameters
"RTN","ZTM5",22,0)
 L ^%ZTSCH("UPDATE",$J)
"RTN","ZTM5",23,0)
 S %ZTOS=^%ZOSF("OS"),U="^"
"RTN","ZTM5",24,0)
 D GETENV^%ZOSV
"RTN","ZTM5",25,0)
 S %ZTUCI=$P(Y,U),%ZTVOL=$P(Y,U,2),%ZTNODE=$P(Y,U,3),%ZTPAIR=$P(Y,U,4)
"RTN","ZTM5",26,0)
 S %ZTVSN=+$O(^%ZIS(14.5,"B",%ZTVOL,"")),%ZTVSS=$G(^%ZIS(14.5,%ZTVSN,0))
"RTN","ZTM5",27,0)
 S %ZTVLI=($P(%ZTVSS,U,2)="Y") ;Did site set Inhibit.
"RTN","ZTM5",28,0)
 S %ZTYPE("V")=$P(%ZTVSS,U,10) ;get vol set type
"RTN","ZTM5",29,0)
U1 ;
"RTN","ZTM5",30,0)
 S %ZTPN=+$O(^%ZIS(14.7,"B",%ZTPAIR,"")),%ZTPS=$G(^%ZIS(14.7,%ZTPN,0))
"RTN","ZTM5",31,0)
 S %ZTPT=+$P(%ZTPS,U,4)
"RTN","ZTM5",32,0)
 S %ZTSIZ=+$P(%ZTPS,U,5) ;par size
"RTN","ZTM5",33,0)
 I '%ZTSIZ,%ZTOS'["VAX DSM",%ZTOS["DSM" S %ZTSIZ=32
"RTN","ZTM5",34,0)
 S %ZTRET=+$P(%ZTPS,U,6)
"RTN","ZTM5",35,0)
 S %ZTVMJ=+$P(%ZTPS,U,7) ;TM job limit
"RTN","ZTM5",36,0)
 S %ZTSLO=+$P(%ZTPS,U,8) ;TM slow down
"RTN","ZTM5",37,0)
 S %ZTYPE=$P(%ZTPS,U,9),%ZTPFLG("DCL")=$P(%ZTPS,U,10) ;TM mode, VAX DCL
"RTN","ZTM5",38,0)
 S %ZTPFLG("BAL")=$E($G(^%ZIS(14.7,%ZTPN,2)),1,40)
"RTN","ZTM5",39,0)
 S %ZTPFLG("MINSUB")=$S($P(%ZTPS,U,12):$P(%ZTPS,U,12),1:1)
"RTN","ZTM5",40,0)
 S %ZTPFLG("LBT")=0,%ZTPFLG("BI")=$S($P(%ZTPS,U,14):$P(%ZTPS,U,14),1:30) ;Balance Interval
"RTN","ZTM5",41,0)
 S %ZTPFLG("TM-DELAY")=$P($G(^%ZIS(14.7,%ZTPN,3),"^60"),U,2)
"RTN","ZTM5",42,0)
 S %ZTPFLG("START")=+$H
"RTN","ZTM5",43,0)
 S %ZTPFLG("XUSCNT")=0 I %ZTOS["GT.M" S %ZTPFLG("XUSCNT")=$L($T(^XUSCNT))
"RTN","ZTM5",44,0)
 S ^%ZTSCH("UPDATE",$J)=$H
"RTN","ZTM5",45,0)
 S %ZTMON("DAY")=+$H D MON^%ZTM
"RTN","ZTM5",46,0)
 K ^%ZTSCH("LOADA",%ZTPAIR) ;Clear LB in case we stop doing LB.
"RTN","ZTM5",47,0)
 L
"RTN","ZTM5",48,0)
 I "GP"'[%ZTYPE D  HALT
"RTN","ZTM5",49,0)
 . K ^%ZTSCH("STATUS")
"RTN","ZTM5",50,0)
 . S ^%ZTSCH("RUN")=%ZTNODE_" is the wrong type of volume set for TaskMan."
"RTN","ZTM5",51,0)
 . Q
"RTN","ZTM5",52,0)
 Q
"RTN","ZTM5",53,0)
 ;
"RTN","ZTM5",54,0)
HOUR ;Run once an hour for each taskman
"RTN","ZTM5",55,0)
 D SUBCHK
"RTN","ZTM5",56,0)
 Q
"RTN","ZTM5",57,0)
 ;
"RTN","ZTM5",58,0)
DAY ;Run once a DAY for each Taskman
"RTN","ZTM5",59,0)
 D MON
"RTN","ZTM5",60,0)
 Q
"RTN","ZTM5",61,0)
 ;
"RTN","ZTM5",62,0)
MON ;Save off the monitor data
"RTN","ZTM5",63,0)
 N X S X=""
"RTN","ZTM5",64,0)
 F I=0:1:23 S X=X_$G(%ZTMON(I))_"^",%ZTMON(I)=0
"RTN","ZTM5",65,0)
 S ^%ZTSCH("MON",%ZTPAIR,%ZTMON("DAY"))=X
"RTN","ZTM5",66,0)
 S %ZTMON("DAY")=+$H
"RTN","ZTM5",67,0)
 Q
"RTN","ZTM5",68,0)
 ;
"RTN","ZTM5",69,0)
SUBCHK ;Job the SUB check routine
"RTN","ZTM5",70,0)
 J SUBCHK^%ZTMS5
"RTN","ZTM5",71,0)
 Q
"RTN","ZTM5",72,0)
 ;
"RTN","ZTM5",73,0)
REQUIR ;UPDATE/CHECK^%ZTM--ensure required links are available
"RTN","ZTM5",74,0)
 K ZTREQUIR N ZT1,ZTN,ZTS,ZTU S ZT1=0
"RTN","ZTM5",75,0)
 F  S ZT1=$O(^%ZIS(14.5,ZT1)) Q:'ZT1  I $D(^%ZIS(14.5,ZT1,0))#2 S ZTS=^(0) I $P(ZTS,U,5)="Y" D TEST I $D(ZTREQUIR)#2 Q
"RTN","ZTM5",76,0)
 K ZT,ZT1,ZTN,ZTS,ZTU
"RTN","ZTM5",77,0)
 Q
"RTN","ZTM5",78,0)
 ;
"RTN","ZTM5",79,0)
TEST ;REQUIR--test a required volume set
"RTN","ZTM5",80,0)
 N $ET,$ES,NULL
"RTN","ZTM5",81,0)
 S ZTN=$P(ZTS,U),NULL="" I ZTN="" Q
"RTN","ZTM5",82,0)
 I ZTN=%ZTVOL Q
"RTN","ZTM5",83,0)
 I $P(ZTS,U,3)="N" S ZTREQUIR=ZTN Q
"RTN","ZTM5",84,0)
 I $P(ZTS,U,4)="Y" S ZTREQUIR=ZTN Q
"RTN","ZTM5",85,0)
 S ZTU=$O(^%ZIS(14.6,"AV",ZTN,"")) I ZTU="" Q
"RTN","ZTM5",86,0)
 S $ET="S ZTREQUIR=ZTN,$EC=NULL Q"
"RTN","ZTM5",87,0)
 S X=$D(^[ZTU,ZTN]DIC(0))
"RTN","ZTM5",88,0)
 L +^%ZTSCH("LINK",ZTN)
"RTN","ZTM5",89,0)
 I $D(^%ZTSCH("LINK",ZTN)) S ^%ZTSCH("LINK")=0
"RTN","ZTM5",90,0)
 L -^%ZTSCH("LINK",ZTN)
"RTN","ZTM5",91,0)
 Q
"RTN","ZTM5",92,0)
 ;
"RTN","ZTM5",93,0)
LINK(ZTVOL) ;internal Kernel extrinsic function
"RTN","ZTM5",94,0)
 ;input--volume set where task should run
"RTN","ZTM5",95,0)
 ;output--UCI,volume set where record must be created
"RTN","ZTM5",96,0)
 ;after call check 1--if value is "", the input or file is bad
"RTN","ZTM5",97,0)
 ;after call check 2--if $P(value,",",2) is current volume set then
"RTN","ZTM5",98,0)
 ;...no extended reference should be used
"RTN","ZTM5",99,0)
 ;
"RTN","ZTM5",100,0)
L0 ;was a volume set passed in?
"RTN","ZTM5",101,0)
 N ZTN,ZTU,ZTV,ZTVD,ZTVN
"RTN","ZTM5",102,0)
 I $G(ZTVOL)'?2.7U Q ""
"RTN","ZTM5",103,0)
 ;
"RTN","ZTM5",104,0)
L1 ;is this volume set on file?
"RTN","ZTM5",105,0)
 S ZTVN=$O(^%ZIS(14.5,"B",ZTVOL,""))
"RTN","ZTM5",106,0)
 I ZTVN="" Q ""
"RTN","ZTM5",107,0)
 I $D(^%ZIS(14.5,ZTVN,0))[0 Q ""
"RTN","ZTM5",108,0)
 S ZTVD=^%ZIS(14.5,ZTVN,0)
"RTN","ZTM5",109,0)
 ;
"RTN","ZTM5",110,0)
L2 ;is there a TaskMan Files Volume Set?  if not, skip next section
"RTN","ZTM5",111,0)
 S ZTN=$P(ZTVD,"^",7)
"RTN","ZTM5",112,0)
 I ZTN="" S ZTV=ZTVOL G L4
"RTN","ZTM5",113,0)
 ;
"RTN","ZTM5",114,0)
L3 ;if there is a separate TaskMan Files Volume Set, is it on file?
"RTN","ZTM5",115,0)
 I $D(^%ZIS(14.5,ZTN,0))[0 Q ""
"RTN","ZTM5",116,0)
 S ZTVD=^%ZIS(14.5,ZTN,0)
"RTN","ZTM5",117,0)
 S ZTV=$P(ZTVD,"^")
"RTN","ZTM5",118,0)
 I ZTV="" Q ""
"RTN","ZTM5",119,0)
 ;
"RTN","ZTM5",120,0)
L4 ;if there is a TaskMan Files UCI, return UCI,volume set
"RTN","ZTM5",121,0)
 S ZTU=$P(ZTVD,"^",6)
"RTN","ZTM5",122,0)
 I ZTU="" Q ""
"RTN","ZTM5",123,0)
 Q ZTU_","_ZTV
"RTN","ZTM5",124,0)
 ;
"RTN","ZTM5",125,0)
 ;
"RTN","ZTM5",126,0)
INHIBIT(Y) ;Set/Clear the Inhibit logon field
"RTN","ZTM5",127,0)
 I Y=1 S $P(^%ZIS(14.5,%ZTVSN,0),U,2)="S",^%ZIS(14.5,"LOGON",%ZTVOL)=1 Q
"RTN","ZTM5",128,0)
 I Y=0 S $P(^%ZIS(14.5,%ZTVSN,0),U,2)="N" K ^%ZIS(14.5,"LOGON",%ZTVOL) Q
"RTN","ZTM5",129,0)
 Q
"RTN","ZTMB")
0^36^B18416099
"RTN","ZTMB",1,0)
ZTMB ;SEA/RDS-Taskman: Manager, Boot/ Option, ZTMRESTART ;28 May 2003 2:18 pm
"RTN","ZTMB",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","ZTMB",3,0)
 ;
"RTN","ZTMB",4,0)
 ;NOTE:  On DataTree systems:
"RTN","ZTMB",5,0)
 ;For automatic startup of TaskMan at boot, save as %ustart in SYS.
"RTN","ZTMB",6,0)
 ;In %ustart, remove ';' from the next two lines:
"RTN","ZTMB",7,0)
 ;I $P($ZVER,"/",2)>4.0,$P($ZVER,"/",2)<4.3 VIEW 1:296:$C(2) ;increase name table allocation
"RTN","ZTMB",8,0)
 ;I  ZZSWITCH 256 ;display current namespace
"RTN","ZTMB",9,0)
 ;
"RTN","ZTMB",10,0)
START ;Start Taskmanager
"RTN","ZTMB",11,0)
 D INIT S ZTMB="START"
"RTN","ZTMB",12,0)
 I ZTOS["M/SQL-PDP" J START^%ZTM0:ZTUCI Q
"RTN","ZTMB",13,0)
 I ZTOS["DTM" G DTM
"RTN","ZTMB",14,0)
 I ZTOS["GT.M" J START^%ZTM0 Q
"RTN","ZTMB",15,0)
 I ZTOS'["VAX DSM" J START^%ZTM0[ZTUCI] Q
"RTN","ZTMB",16,0)
 I ZTOS["VAX DSM" G VXD
"RTN","ZTMB",17,0)
 W !,"Taskman NOT Started"
"RTN","ZTMB",18,0)
 Q
"RTN","ZTMB",19,0)
VXD X "S %=($ZC(%GETJPI,$J,""CURPRIV"")[""SHARE"")" I % W !,"Don't start TaskMan with the SHARE privilege" Q
"RTN","ZTMB",20,0)
 S Z=0,%=$O(^%ZIS(14.7,"B",ZTPAIR,0)),ZTMODE=$P($G(^%ZIS(14.7,+%,0)),U,10)
"RTN","ZTMB",21,0)
VXD2 I Z,$$EC^%ZOSV["access not authorized"!($$EC^%ZOSV["no privilege") W !!,"You lack the system privilege to start TaskMan." H 2 Q
"RTN","ZTMB",22,0)
 I Z,$$EC^%ZOSV'["duplicate name" W !!,"The following error has prevented TaskMan from starting:",!,$$EC^%ZOSV H 2 Q
"RTN","ZTMB",23,0)
 S X="VXD2",@^%ZOSF("TRAP"),Z=Z+1
"RTN","ZTMB",24,0)
 I ZTMODE="" S %=ZTMB_"^%ZTM0:(OPTION=""/UCI=""_ZTUCI,NAME=""TaskMan ""_$E(^%ZOSF(""VOL""),1,3)_"" ""_Z)" J @% Q
"RTN","ZTMB",25,0)
 ;Remove the '/NOLOG' if you want a log file for trouble shouting
"RTN","ZTMB",26,0)
 I ZTMODE]"" S %SPAWN="SUBMIT/NOPRINT/NOLOG/USER=TASKMAN/QUEUE=TM$"_ZTNODE_" DHCP$TASKMAN:ZTMWDCL/PARAM=("_ZTMODE_","_(ZTMB["RE")_")" D ^%SPAWN
"RTN","ZTMB",27,0)
 Q
"RTN","ZTMB",28,0)
 ;
"RTN","ZTMB",29,0)
DTM I ZTMB="START" D NULLDEV F DEV=10:1:19 O DEV:("W":NULLDEV):0 C DEV
"RTN","ZTMB",30,0)
 S Z=0
"RTN","ZTMB",31,0)
DTM2 S X="DTM2",@^%ZOSF("TRAP"),Z=Z+1,%=ZTMB_"^%ZTM0:(NSPACE="""_ZTUCI_""":STRSTK=8000:LVMEM=12000:NAME=""TaskMan "_$E(^%ZOSF("VOL"),1,3)_" "_Z_""")" J @% Q
"RTN","ZTMB",32,0)
 ;
"RTN","ZTMB",33,0)
RESTART ;Restart Taskmanager
"RTN","ZTMB",34,0)
 D INIT
"RTN","ZTMB",35,0)
 I $D(^%ZOSF("SIGNOFF")) X ^("SIGNOFF") I  D  Q
"RTN","ZTMB",36,0)
 . W $C(7),!,"NOTE THAT THE SYSTEM IS IN A 'SIGNOFF' STATE,",!?4,"WHICH PROBABLY EXPLAINS WHY TASKS ARE NOT RUNNING!!",!
"RTN","ZTMB",37,0)
 S ZTMULT=0
"RTN","ZTMB",38,0)
 I $S($D(^%ZTSCH("RUN"))[0:0,^("RUN")-$H:0,1:$P($H,",",2)-150'>$P(^("RUN"),",",2)) W !,"TASKMAN IS ALREADY RUNNING" S ZTMULT=1
"RTN","ZTMB",39,0)
 I ZTOS["VAX DSM" I $ZC(%GETJPI,$J,"CURPRIV")["SHARE" D  Q
"RTN","ZTMB",40,0)
 . W !,"Don't start TaskMan with the SHARE privilege" Q
"RTN","ZTMB",41,0)
 F %ZTI=0:0 D  Q:"YESyes^NOno"[%Y
"RTN","ZTMB",42,0)
 . W !,"ARE YOU SURE YOU WANT TO RESTART ",$S(ZTMULT:"ANOTHER ",1:""),"TASKMAN? NO//"
"RTN","ZTMB",43,0)
 . R %Y:$S($D(DTIME)#2:DTIME,1:60) S:'$T %Y="^" Q:"YESyes^NOno"[%Y
"RTN","ZTMB",44,0)
 . W:'$T "*TIMEOUT*" W:%Y'["?" *7 D HELP1:%Y'["??",HELP2:%Y["??"
"RTN","ZTMB",45,0)
 I %Y=""!("YESyes"'[%Y) W "  (NO)",!,*7,"<NO ACTION TAKEN>",! Q
"RTN","ZTMB",46,0)
 W "  (YES)",!,"Restarting..."
"RTN","ZTMB",47,0)
 S ZTMB="RESTART"
"RTN","ZTMB",48,0)
 I ZTOS["M/SQL-PDP" J RESTART^%ZTM0:ZTUCI D DONE Q
"RTN","ZTMB",49,0)
 I ZTOS["DTM" G DTM
"RTN","ZTMB",50,0)
 I ZTOS["GT.M" J RESTART^%ZTM0 D DONE Q
"RTN","ZTMB",51,0)
 I ZTOS'["VAX DSM" J RESTART^%ZTM0[ZTUCI] D DONE Q
"RTN","ZTMB",52,0)
 I ZTOS["VAX DSM" G VXD
"RTN","ZTMB",53,0)
 W !!,$C(7),"Taskman NOT Restared",!
"RTN","ZTMB",54,0)
 Q
"RTN","ZTMB",55,0)
INIT S U="^",ZTOS=^%ZOSF("OS"),ZTUCI=$P(^%ZOSF("MGR"),",")
"RTN","ZTMB",56,0)
 D GETENV^%ZOSV S ZTVOL=$P(Y,U,2),ZTNODE=$P(Y,U,3),ZTPAIR=$P(Y,U,4)
"RTN","ZTMB",57,0)
 Q
"RTN","ZTMB",58,0)
 ;
"RTN","ZTMB",59,0)
NULLDEV ;SELECT NULL DEVICE (DTM OS Dependent)
"RTN","ZTMB",60,0)
 D HWTYPE S NULLDEV="NUL" I %HW'="PC" S NULLDEV="[NUL]"
"RTN","ZTMB",61,0)
 K %HW,%HW Q
"RTN","ZTMB",62,0)
 ;
"RTN","ZTMB",63,0)
HWTYPE ;HARDWARE TYPE(DTM OS Dependent)
"RTN","ZTMB",64,0)
 K %HW S %H=$S($P($ZVER,"/",2)<4:$V(4,3,-1),1:$V(1,3,-1)) ;get hardware type number
"RTN","ZTMB",65,0)
 S %HW=$S(%H<10:"WS",%H<20:"MF",%H<64:"?",%H<129:"PC",1:"?")
"RTN","ZTMB",66,0)
 Q
"RTN","ZTMB",67,0)
 ;
"RTN","ZTMB",68,0)
HELP1 ;RESTART--improved help for the confirmation prompt.
"RTN","ZTMB",69,0)
 W !!?5,"Answer must be YES or NO."
"RTN","ZTMB",70,0)
 W !?5,"Answer YES to restart ",$S(ZTMULT:"another ",1:""),"TaskMan.",!
"RTN","ZTMB",71,0)
 Q
"RTN","ZTMB",72,0)
 ;
"RTN","ZTMB",73,0)
HELP2 ;RESTART--??-help for confirmation prompt
"RTN","ZTMB",74,0)
 W !!?5,"TaskMan must be running in each library uci on the system for tasks to run."
"RTN","ZTMB",75,0)
 W !?5,"One TaskMan per library uci should be enough for all but the busiest sites."
"RTN","ZTMB",76,0)
 W !?5,"The System Status option and the Monitor TaskMan option can help determine"
"RTN","ZTMB",77,0)
 W !?5,"whether a TaskMan is running on this volume set."
"RTN","ZTMB",78,0)
 W !!?5,"If you are still uncertain how to respond, answer NO and consult your"
"RTN","ZTMB",79,0)
 W !?5,"documentation or your support ISC.",!
"RTN","ZTMB",80,0)
 Q
"RTN","ZTMB",81,0)
 ;
"RTN","ZTMB",82,0)
DONE ;RESTART--feedback after restarting TaskMan
"RTN","ZTMB",83,0)
 W "TaskMan restarted!",! Q
"RTN","ZTMB",84,0)
 ;
"RTN","ZTMGRSET")
0^3^B48565811
"RTN","ZTMGRSET",1,0)
ZTMGRSET ;SF/RWF,PUG/TOAD - SET UP THE MGR ACCOUNT FOR THE SYSTEM ;10/29/2003  10:19
"RTN","ZTMGRSET",2,0)
 ;;8.0;KERNEL;**34,36,69,94,121,127,136,191,275**;JUL 10, 1995;
"RTN","ZTMGRSET",3,0)
 ;
"RTN","ZTMGRSET",4,0)
 N %D,%S,I,OSMAX,U,X,X1,X2,Y,Z1,Z2,ZTOS,ZTMODE,SCR
"RTN","ZTMGRSET",5,0)
 S ZTMODE=0
"RTN","ZTMGRSET",6,0)
A W !!,"ZTMGRSET Version ",$P($T(+2),";",3)," ",$P($T(+2),";",5)
"RTN","ZTMGRSET",7,0)
 W !,"HELLO! I exist to assist you in correctly initializing the current account."
"RTN","ZTMGRSET",8,0)
 I $D(^%ZOSF("UCI")) X ^%ZOSF("UCI") I Y'["MG" W $C(7),!!,"THIS MAY NOT BE THE MANAGER UCI.",!," I think it is ",Y,". Should I continue anyway? N//" R X:120 G A:"YNyn"'[$E(X) Q:"Nn"[$E(X)
"RTN","ZTMGRSET",9,0)
 S ZTOS=$$OS() I ZTOS'>0 W !,"Can't determine the OS type. Exiting ZTMGRSET." Q
"RTN","ZTMGRSET",10,0)
 I ZTMODE D  I (PCNM<1)!(PCNM>999) W !,"Need a Patch number to load." Q
"RTN","ZTMGRSET",11,0)
 . R !!,"Patch number to load: ",PCNM:120 Q:(PCNM<1)!(PCNM>999)
"RTN","ZTMGRSET",12,0)
 . S SCR="I $P($T(+2^@X),"";"",5)?.E1P1"_$C(34)_PCNM_$C(34)_"1P.E"
"RTN","ZTMGRSET",13,0)
 ;
"RTN","ZTMGRSET",14,0)
 K ^%ZOSF("MASTER"),^("SIGNOFF") ;Remove old nodes.
"RTN","ZTMGRSET",15,0)
DOIT W !!,"I will now rename a group of routines specific to your operating system."
"RTN","ZTMGRSET",16,0)
 D @ZTOS,ALL,GLOBALS:'ZTMODE W !,"ALL DONE"
"RTN","ZTMGRSET",17,0)
 Q
"RTN","ZTMGRSET",18,0)
 ;
"RTN","ZTMGRSET",19,0)
RELOAD ;Reload any patched routines
"RTN","ZTMGRSET",20,0)
 N %D,%S,I,OSMAX,U,X,X1,X2,Y,Z1,Z2,ZTOS,ZTMODE,SCR
"RTN","ZTMGRSET",21,0)
 S ZTMODE=1 G A
"RTN","ZTMGRSET",22,0)
 Q
"RTN","ZTMGRSET",23,0)
 ;
"RTN","ZTMGRSET",24,0)
OS() ;Select the OS
"RTN","ZTMGRSET",25,0)
 N Y,X1,X
"RTN","ZTMGRSET",26,0)
 S U="^",SCR="I 1" F I=1:1:20 S X=$T(@I) Q:X=""  S OSMAX=I
"RTN","ZTMGRSET",27,0)
B S Y=0,ZTOS=0 I $D(^%ZOSF("OS")) D
"RTN","ZTMGRSET",28,0)
 . S X1=$P(^%ZOSF("OS"),U),ZTOS=$$OSNUM W !,"I think you are using ",X1
"RTN","ZTMGRSET",29,0)
 W !,"Which MUMPS system should I install?",!
"RTN","ZTMGRSET",30,0)
 F I=1:1:OSMAX W !,I," = ",$P($T(@I),";",3)
"RTN","ZTMGRSET",31,0)
 W !,"System: " W:ZTOS ZTOS,"//"
"RTN","ZTMGRSET",32,0)
 R X:300 S:X="" X=ZTOS
"RTN","ZTMGRSET",33,0)
 I X<1!(X>OSMAX) W !,"NOT A VALID CHOICE" Q:X[U 0 G B
"RTN","ZTMGRSET",34,0)
 Q X
"RTN","ZTMGRSET",35,0)
 ;
"RTN","ZTMGRSET",36,0)
OSNUM() ;Return the OS number
"RTN","ZTMGRSET",37,0)
 N I,X1,X2,Y S Y=0,X1=$P($G(^%ZOSF("OS")),"^")
"RTN","ZTMGRSET",38,0)
 F I=1:1 S X2=$T(@I) Q:X2=""  I X2[X1 S Y=I Q
"RTN","ZTMGRSET",39,0)
 Q Y
"RTN","ZTMGRSET",40,0)
 ;
"RTN","ZTMGRSET",41,0)
ALL W !!,"Now to load routines common to all systems."
"RTN","ZTMGRSET",42,0)
 D TM,ETRAP,DEV,OTHER,FM
"RTN","ZTMGRSET",43,0)
 I ZTOS=7!(ZTOS=8) D
"RTN","ZTMGRSET",44,0)
 . S ^%ZE="D ^ZE"
"RTN","ZTMGRSET",45,0)
 E  D  ;With ZLoad, ZSave, ZInsert
"RTN","ZTMGRSET",46,0)
 . W !,"Installing ^%Z editor"
"RTN","ZTMGRSET",47,0)
 . D ^ZTEDIT
"RTN","ZTMGRSET",48,0)
 I 'ZTMODE W !,"Setting ^%ZIS('C')" K ^%ZIS("C") S ^%ZIS("C")="G ^%ZISC"
"RTN","ZTMGRSET",49,0)
 Q
"RTN","ZTMGRSET",50,0)
 ;
"RTN","ZTMGRSET",51,0)
TM ;Taskman
"RTN","ZTMGRSET",52,0)
 S %S="ZTLOAD^ZTLOAD1^ZTLOAD2^ZTLOAD3^ZTLOAD4^ZTLOAD5^ZTLOAD6^ZTLOAD7"
"RTN","ZTMGRSET",53,0)
 S %D="%ZTLOAD^%ZTLOAD1^%ZTLOAD2^%ZTLOAD3^%ZTLOAD4^%ZTLOAD5^%ZTLOAD6^%ZTLOAD7"
"RTN","ZTMGRSET",54,0)
 D MOVE
"RTN","ZTMGRSET",55,0)
 S %S="ZTM^ZTM0^ZTM1^ZTM2^ZTM3^ZTM4^ZTM5^ZTM6"
"RTN","ZTMGRSET",56,0)
 S %D="%ZTM^%ZTM0^%ZTM1^%ZTM2^%ZTM3^%ZTM4^%ZTM5^%ZTM6"
"RTN","ZTMGRSET",57,0)
 D MOVE
"RTN","ZTMGRSET",58,0)
 S %S="ZTMS^ZTMS0^ZTMS1^ZTMS2^ZTMS3^ZTMS4^ZTMS5^ZTMS7^ZTMSH"
"RTN","ZTMGRSET",59,0)
 ;I ZTOS=7!(ZTOS=8) S $P(%S,U,1)="ZTMSGTM"
"RTN","ZTMGRSET",60,0)
 S %D="%ZTMS^%ZTMS0^%ZTMS1^%ZTMS2^%ZTMS3^%ZTMS4^%ZTMS5^%ZTMS7^%ZTMSH"
"RTN","ZTMGRSET",61,0)
 D MOVE
"RTN","ZTMGRSET",62,0)
 Q
"RTN","ZTMGRSET",63,0)
FM ;Rename the FileMan routines
"RTN","ZTMGRSET",64,0)
 I ZTMODE=1 Q  ;Only ask on full install
"RTN","ZTMGRSET",65,0)
 R !,"Want to rename the FileMan routines: No//",X:600 Q:"Yy"'[$E(X_"N")
"RTN","ZTMGRSET",66,0)
 S %S="DIDT^DIDTC^DIRCR",%D="%DT^%DTC^%RCR"
"RTN","ZTMGRSET",67,0)
 D MOVE
"RTN","ZTMGRSET",68,0)
 Q
"RTN","ZTMGRSET",69,0)
 ;
"RTN","ZTMGRSET",70,0)
ETRAP ;Error Trap
"RTN","ZTMGRSET",71,0)
 S %S="ZTER^ZTER1",%D="%ZTER^%ZTER1"
"RTN","ZTMGRSET",72,0)
 D MOVE
"RTN","ZTMGRSET",73,0)
 Q
"RTN","ZTMGRSET",74,0)
OTHER S %S="ZTPP^ZTP1^ZTPTCH^ZTRDEL^ZTMOVE"
"RTN","ZTMGRSET",75,0)
 S %D="%ZTPP^%ZTP1^%ZTPTCH^%ZTRDEL^%ZTMOVE"
"RTN","ZTMGRSET",76,0)
 D MOVE
"RTN","ZTMGRSET",77,0)
 Q
"RTN","ZTMGRSET",78,0)
DEV S %S="ZIS^ZIS1^ZIS2^ZIS3^ZIS5^ZIS6^ZIS7^ZISC^ZISP^ZISS^ZISS1^ZISS2^ZISTCP^ZISUTL"
"RTN","ZTMGRSET",79,0)
 S %D="%ZIS^%ZIS1^%ZIS2^%ZIS3^%ZIS5^%ZIS6^%ZIS7^%ZISC^%ZISP^%ZISS^%ZISS1^%ZISS2^%ZISTCP^%ZISUTL"
"RTN","ZTMGRSET",80,0)
 D MOVE
"RTN","ZTMGRSET",81,0)
 Q
"RTN","ZTMGRSET",82,0)
RUM ;Build the routines for Capacity Management (CM)
"RTN","ZTMGRSET",83,0)
 S %S=""
"RTN","ZTMGRSET",84,0)
 I ZTOS=1 S %S="ZOSVKRV^ZOSVKSVE^ZOSVKSVS^ZOSVKSD" ;DSM
"RTN","ZTMGRSET",85,0)
 I ZTOS=2 S %S="ZOSVKRM^ZOSVKSME^ZOSVKSMS^ZOSVKSD" ;MSM
"RTN","ZTMGRSET",86,0)
 I ZTOS=3 S %S="ZOSVKRO^ZOSVKSOE^ZOSVKSOS^ZOSVKSD" ;OpenM
"RTN","ZTMGRSET",87,0)
 I ZTOS=7!(ZTOS=8) S %S="ZOSVKRG^ZOSVKSGE^ZOSVKSGS^ZOSVKSD" ;GT.M
"RTN","ZTMGRSET",88,0)
 S %D="%ZOSVKR^%ZOSVKSE^%ZOSVKSS^%ZOSVKSD"
"RTN","ZTMGRSET",89,0)
 D MOVE
"RTN","ZTMGRSET",90,0)
 Q
"RTN","ZTMGRSET",91,0)
ZOSF(X) ;
"RTN","ZTMGRSET",92,0)
 X SCR I $T W ! D @(U_X) W !
"RTN","ZTMGRSET",93,0)
 Q
"RTN","ZTMGRSET",94,0)
1 ;;VAX DSM(V6), VAX DSM(V7)
"RTN","ZTMGRSET",95,0)
 S %S="ZOSVVXD^ZTBKCVXD^ZIS4VXD^ZISFVXD^ZISHVXD^XUCIVXD^ZISETVXD"
"RTN","ZTMGRSET",96,0)
 D DES,MOVE
"RTN","ZTMGRSET",97,0)
 S %S="ZOSV2VXD^ZTMDCL",%D="%ZOSV2^%ZTMDCL"
"RTN","ZTMGRSET",98,0)
 D MOVE,RUM,ZOSF("ZOSFVXD")
"RTN","ZTMGRSET",99,0)
 Q
"RTN","ZTMGRSET",100,0)
2 ;;MSM-PC/PLUS, MSM for NT or UNIX
"RTN","ZTMGRSET",101,0)
 W !,"- Use autostart to do ZTMB don't resave as STUSER."
"RTN","ZTMGRSET",102,0)
 S %S="ZOSVMSM^ZTBKCMSM^ZIS4MSM^ZISFMSM^ZISHMSM^XUCIMSM^ZISETMSM"
"RTN","ZTMGRSET",103,0)
 D DES,MOVE
"RTN","ZTMGRSET",104,0)
 S %S="ZOSV2MSM",%D="%ZOSV2"
"RTN","ZTMGRSET",105,0)
 D MOVE,RUM,ZOSF("ZOSFMSM")
"RTN","ZTMGRSET",106,0)
 I $$VERSION^%ZOSV(1)["UNIX" S %S="ZISHMSU",%D="%ZISH" D MOVE
"RTN","ZTMGRSET",107,0)
 Q
"RTN","ZTMGRSET",108,0)
3 ;;OpenM for NT, Cache/NT, Cache/VMS
"RTN","ZTMGRSET",109,0)
 S %S="ZOSVONT^^ZIS4ONT^ZISFONT^ZISHONT^XUCIONT"
"RTN","ZTMGRSET",110,0)
 D DES,MOVE
"RTN","ZTMGRSET",111,0)
 S %S="ZISTCPS",%D="%ZISTCPS"
"RTN","ZTMGRSET",112,0)
 D MOVE,RUM,ZOSF("ZOSFONT")
"RTN","ZTMGRSET",113,0)
 Q
"RTN","ZTMGRSET",114,0)
4 ;;Datatree, DTM-PC, DT-MAX
"RTN","ZTMGRSET",115,0)
 S %S="ZOSVDTM^ZTBKCDTM^ZIS4DTM^ZISFDTM^ZISHDTM^XUCIDTM^ZISETDTM"
"RTN","ZTMGRSET",116,0)
 D DES,MOVE
"RTN","ZTMGRSET",117,0)
 S %S="ZOSV1DTM^ZTMB",%D="%ZOSV1^%ustart"
"RTN","ZTMGRSET",118,0)
 D MOVE,ZOSF("ZOSFDTM")
"RTN","ZTMGRSET",119,0)
 Q
"RTN","ZTMGRSET",120,0)
5 ;;MVX,ISM VAX
"RTN","ZTMGRSET",121,0)
 S %S="ZOSVMSQ^ZTBKCMSQ^ZIS4MSQ^ZISFMSQ^ZISHMSQ^XUCIMSQ^ZISETMSQ"
"RTN","ZTMGRSET",122,0)
 D DES,MOVE
"RTN","ZTMGRSET",123,0)
 S %S="ZTMB",%D="ZSTU"
"RTN","ZTMGRSET",124,0)
 D MOVE,ZOSF("ZOSFMSQ")
"RTN","ZTMGRSET",125,0)
 Q
"RTN","ZTMGRSET",126,0)
6 ;;ISM (UNIX, Open VMS)
"RTN","ZTMGRSET",127,0)
 S %S="ZOSVIS2^^ZIS4IS2^ZISFIS2^ZISHIS2^XUCIIS2^ZISETIS2"
"RTN","ZTMGRSET",128,0)
 D DES,MOVE
"RTN","ZTMGRSET",129,0)
 S %S="ZTMB",%D="ZSTU"
"RTN","ZTMGRSET",130,0)
 D MOVE,ZOSF("ZOSFIS2")
"RTN","ZTMGRSET",131,0)
 Q
"RTN","ZTMGRSET",132,0)
7 ;;GT.M (VMS)
"RTN","ZTMGRSET",133,0)
 S %S="ZOSVGTM^ZTBKCGTM^ZIS4GTM^ZISFGTM^ZISHGTM^XUCIGTM^ZISETGTM"
"RTN","ZTMGRSET",134,0)
 D DES,MOVE
"RTN","ZTMGRSET",135,0)
 S %S="ZOSV2GTM^ZISTCPS",%D="%ZOSV2^%ZISTCPS"
"RTN","ZTMGRSET",136,0)
 D MOVE,ZOSF("ZOSFGTM")
"RTN","ZTMGRSET",137,0)
 Q
"RTN","ZTMGRSET",138,0)
8 ;;GT.M (Unix)
"RTN","ZTMGRSET",139,0)
 S %S="ZOSVGUX^ZTBKCGUX^ZIS4GTM^ZISFGUX^ZISHGUX^XUCIGTM^ZISETGUX"
"RTN","ZTMGRSET",140,0)
 D DES,MOVE
"RTN","ZTMGRSET",141,0)
 S %S="ZOSV2GTM^ZISTCPS",%D="%ZOSV2^%ZISTCPS"
"RTN","ZTMGRSET",142,0)
 D MOVE,ZOSF("ZOSFGUX")
"RTN","ZTMGRSET",143,0)
 Q
"RTN","ZTMGRSET",144,0)
10 ;;NOT SUPPORTED
"RTN","ZTMGRSET",145,0)
 Q
"RTN","ZTMGRSET",146,0)
MOVE ; rename % routines
"RTN","ZTMGRSET",147,0)
 N %,X,Y
"RTN","ZTMGRSET",148,0)
 F %=1:1:$L(%D,"^") D
"RTN","ZTMGRSET",149,0)
 . S X=$P(%S,U,%) ; from
"RTN","ZTMGRSET",150,0)
 . S Y=$P(%D,U,%) ; to
"RTN","ZTMGRSET",151,0)
 . W !,"Routine: ",X
"RTN","ZTMGRSET",152,0)
 . Q:X=""  Q:Y=""  I $T(^@X)=""  W ?20,"  Missing" Q
"RTN","ZTMGRSET",153,0)
 . X SCR Q:'$T
"RTN","ZTMGRSET",154,0)
 . W ?20,"  Loaded, "
"RTN","ZTMGRSET",155,0)
 . D COPY(X,Y)
"RTN","ZTMGRSET",156,0)
 . W ?20,"Saved as ",Y
"RTN","ZTMGRSET",157,0)
 Q
"RTN","ZTMGRSET",158,0)
 ;
"RTN","ZTMGRSET",159,0)
COPY(FROM,TO) ;
"RTN","ZTMGRSET",160,0)
 I ZTOS'=7,ZTOS'=8 X "ZL @FROM ZS @TO" Q
"RTN","ZTMGRSET",161,0)
 ;For GT.M below
"RTN","ZTMGRSET",162,0)
 N PATH,COPY S PATH=$$R
"RTN","ZTMGRSET",163,0)
 S FROM=PATH_FROM_".m"
"RTN","ZTMGRSET",164,0)
 S TO=PATH_$TR(TO,"%","_")_".m"
"RTN","ZTMGRSET",165,0)
 S COPY=$S(ZTOS=7:"COPY",1:"cp")
"RTN","ZTMGRSET",166,0)
 ZSYSTEM COPY_" "_FROM_" "_TO
"RTN","ZTMGRSET",167,0)
 Q
"RTN","ZTMGRSET",168,0)
 ;
"RTN","ZTMGRSET",169,0)
R() ; routine directory for GT.M
"RTN","ZTMGRSET",170,0)
 I ZTOS=7 Q $P($ZRO,",")
"RTN","ZTMGRSET",171,0)
 I ZTOS=8 Q $P($S($ZRO["(":$P($P($ZRO,"(",2),")"),1:$ZRO)," ")_"/"
"RTN","ZTMGRSET",172,0)
 E  Q ""
"RTN","ZTMGRSET",173,0)
 ;
"RTN","ZTMGRSET",174,0)
DES S %D="%ZOSV^%ZTBKC1^%ZIS4^%ZISF^%ZISH^%XUCI^ZISETUP" Q
"RTN","ZTMGRSET",175,0)
 ;
"RTN","ZTMGRSET",176,0)
GLOBALS ;Set node zero of file #3.05 & #3.07
"RTN","ZTMGRSET",177,0)
 W !!,"Now, I will check your % globals."
"RTN","ZTMGRSET",178,0)
 W ".........."
"RTN","ZTMGRSET",179,0)
 F %="^%ZIS","^%ZISL","^%ZTER","^%ZUA" S:'$D(@%) @%=""
"RTN","ZTMGRSET",180,0)
 S:$D(^%ZTSK(0))[0 ^%ZTSK(-1)=100,^%ZTSCH=""
"RTN","ZTMGRSET",181,0)
 S Z1=$G(^%ZTSK(-1),-1),Z2=$G(^%ZTSK(0))
"RTN","ZTMGRSET",182,0)
 I Z1'=$P(Z2,"^",3) S:Z1'>0 ^%ZTSK(-1)=+Z2 S ^%ZTSK(0)="TASK'S^14.4^"_^%ZTSK(-1)
"RTN","ZTMGRSET",183,0)
 S:$D(^%ZUA(3.05,0))[0 ^%ZUA(3.05,0)="FAILED ACCESS ATTEMPTS LOG^3.05^^"
"RTN","ZTMGRSET",184,0)
 S:$D(^%ZUA(3.07,0))[0 ^%ZUA(3.07,0)="PROGRAMMER MODE LOG^3.07^^"
"RTN","ZTMGRSET",185,0)
 Q
"RTN","ZTMGRSET",186,0)
NAME ;Setup the static names for this system
"RTN","ZTMGRSET",187,0)
MGR W !,"NAME OF MANAGER'S UCI,VOLUME SET: "_^%ZOSF("MGR")_"// " R X:$S($G(DTIME):DTIME,1:9999) I X]"" X ^("UCICHECK") G MGR:0[Y S ^%ZOSF("MGR")=X
"RTN","ZTMGRSET",188,0)
PROD W !,"PRODUCTION (SIGN-ON) UCI,VOLUME SET: "_^%ZOSF("PROD")_"// " R X:$S($G(DTIME):DTIME,1:9999) I X]"" X ^("UCICHECK") G PROD:0[Y S ^%ZOSF("PROD")=X
"RTN","ZTMGRSET",189,0)
VOL W !,"NAME OF VOLUME SET: "_^%ZOSF("VOL")_"//" R X:$S($G(DTIME):DTIME,1:9999) I X]"" S:X?3U ^%ZOSF("VOL")=X I X'?3U W "MUST BE 3 Upper case." G VOL
"RTN","ZTMGRSET",190,0)
 W ! Q
"RTN","ZTMKU")
0^61^B19402170
"RTN","ZTMKU",1,0)
ZTMKU ;SEA/RDS-Taskman: Option, ZTMWAIT/RUN/STOP ;11/04/99  15:05
"RTN","ZTMKU",2,0)
 ;;8.0;KERNEL;**118,127,275**;Jul 10, 1995
"RTN","ZTMKU",3,0)
 ;
"RTN","ZTMKU",4,0)
 Q
"RTN","ZTMKU",5,0)
SSUB(NODE) ;Stop sub-managers
"RTN","ZTMKU",6,0)
 D SS(1,"SUB",NODE) Q
"RTN","ZTMKU",7,0)
SMAN(NODE) ;stop managers
"RTN","ZTMKU",8,0)
 D SS(1,"MGR",NODE) Q
"RTN","ZTMKU",9,0)
 ;
"RTN","ZTMKU",10,0)
SS(MD,GR,NODE) ;Set/clear STOP nodes.
"RTN","ZTMKU",11,0)
 S GR=$G(GR,"MGR") S:"MGR_SUB_"'[GR GR="MGR"
"RTN","ZTMKU",12,0)
 I MD=1 S ^%ZTSCH("STOP",GR,NODE)=$H D WS(0,GR)
"RTN","ZTMKU",13,0)
 I MD=0 K ^%ZTSCH("STOP",GR,NODE)
"RTN","ZTMKU",14,0)
 Q
"RTN","ZTMKU",15,0)
 ;
"RTN","ZTMKU",16,0)
WS(MD,GR) ;Set/Clear Wait state
"RTN","ZTMKU",17,0)
 S GR=$G(GR,"MGR") S:"MGR_SUB_"'[GR GR="MGR"
"RTN","ZTMKU",18,0)
 I MD=1 S ^%ZTSCH("WAIT",GR)=$H ;set wait state
"RTN","ZTMKU",19,0)
 I MD=0 K ^%ZTSCH("WAIT",GR) ;Clear wait
"RTN","ZTMKU",20,0)
 Q
"RTN","ZTMKU",21,0)
 ;
"RTN","ZTMKU",22,0)
GROUP(CALL) ;Do CALL for each node, use NODE as the parameter
"RTN","ZTMKU",23,0)
 N J,ND,NODE
"RTN","ZTMKU",24,0)
 F J=0:0 S J=$O(^%ZTSCH("STATUS",J)) Q:J=""  S ND=$G(^(J)),NODE=$P(ND,"^",3) D @CALL
"RTN","ZTMKU",25,0)
 Q
"RTN","ZTMKU",26,0)
 ;
"RTN","ZTMKU",27,0)
OPT(MD) ;Disable/Enable option prosessing
"RTN","ZTMKU",28,0)
 I MD=1 S ^%ZTSCH("NO-OPTION")=""
"RTN","ZTMKU",29,0)
 I MD=0 K ^%ZTSCH("NO-OPTION")
"RTN","ZTMKU",30,0)
 Q
"RTN","ZTMKU",31,0)
 ;
"RTN","ZTMKU",32,0)
RUN ;Remove Task Managers From WAIT State
"RTN","ZTMKU",33,0)
 D WS(0,"MGR"),WS(0,"SUB") K ^%ZTSCH("STOP") W !,"Done!",!
"RTN","ZTMKU",34,0)
 Q
"RTN","ZTMKU",35,0)
 ;
"RTN","ZTMKU",36,0)
UPDATE ;Have Managers Do an parameter Update
"RTN","ZTMKU",37,0)
 K ^%ZTSCH("UPDATE") W !,"Done!",!
"RTN","ZTMKU",38,0)
 Q
"RTN","ZTMKU",39,0)
 ;
"RTN","ZTMKU",40,0)
WAIT ;Put Task Managers In WAIT State
"RTN","ZTMKU",41,0)
 D WS(1,"MGR") W !,"TaskMan now in 'WAIT STATE'",$C(7)
"RTN","ZTMKU",42,0)
 D QSUB
"RTN","ZTMKU",43,0)
 Q
"RTN","ZTMKU",44,0)
 ;
"RTN","ZTMKU",45,0)
STOP ;Shut Down Task Managers
"RTN","ZTMKU",46,0)
 N ZTX,ND,J
"RTN","ZTMKU",47,0)
 F  R !!,"Are you sure you want to stop TaskMan? NO// ",ZTX:$S($D(DTIME)#2:DTIME,1:60) Q:'$T!("^YESyesNOno"[ZTX)  W:ZTX'["?" $C(7) W !,"Answer YES to shut down all Task Managers on current the volume set."
"RTN","ZTMKU",48,0)
 I "^NOno"[ZTX W !,"TaskMan NOT shut down." Q
"RTN","ZTMKU",49,0)
 W !,"Shutting down TaskMan." D GROUP("SMAN(NODE)")
"RTN","ZTMKU",50,0)
 ;. F J=0:0 S J=$O(^%ZTSCH("STATUS",J)) Q:J=""  S ND=$G(^(J)) D SMAN($P(ND,U,3))
"RTN","ZTMKU",51,0)
 ;. Q
"RTN","ZTMKU",52,0)
 D QSUB
"RTN","ZTMKU",53,0)
 Q
"RTN","ZTMKU",54,0)
 ;
"RTN","ZTMKU",55,0)
QSUB N ZTX,ND
"RTN","ZTMKU",56,0)
 F  R !!,"Should active submanagers shut down after finishing their current tasks? NO// ",ZTX:$S($D(DTIME)#2:DTIME,1:60) Q:'$T!("^"[ZTX)!("YESyesNOno"[ZTX)  W:ZTX'["?" $C(7) W !,"Please answer YES or NO."
"RTN","ZTMKU",57,0)
 D:"YESyes"[ZTX&(ZTX]"") GROUP("SSUB(NODE)") W !,"Okay!",!
"RTN","ZTMKU",58,0)
 Q
"RTN","ZTMKU",59,0)
 ;
"RTN","ZTMKU",60,0)
QUERY ;Query Status Of A Task Manager
"RTN","ZTMKU",61,0)
 Q:$D(%ZTX)[0  Q:%ZTX=""  S %ZTY=0
"RTN","ZTMKU",62,0)
 I $D(^%ZTSCH("STATUS",%ZTX))#2 S %ZTY=^%ZTSCH("STATUS",%ZTX)
"RTN","ZTMKU",63,0)
 K %ZTX Q
"RTN","ZTMKU",64,0)
 ;
"RTN","ZTMKU",65,0)
NODES ;Return Task Manager Status Nodes
"RTN","ZTMKU",66,0)
 S %ZTX="" F %ZTY=0:0 S %ZTX=$O(^%ZTSCH("STATUS",%ZTX)) Q:%ZTX=""  S %ZTY=%ZTY+1,%ZTY(%ZTY)=%ZTX
"RTN","ZTMKU",67,0)
 K %ZTX Q
"RTN","ZTMKU",68,0)
 ;
"RTN","ZTMKU",69,0)
LIVE ;Return Whether A Task Manager Is Live
"RTN","ZTMKU",70,0)
 Q:$D(%ZTX)[0  Q:%ZTX=""  S %ZTY=0,U="^",%ZTX1=$H,%ZTX2=$P(%ZTX,U)
"RTN","ZTMKU",71,0)
 S %ZTX3=%ZTX1-%ZTX2*86400+$P(%ZTX1,",",2)-$P(%ZTX2,",",2)
"RTN","ZTMKU",72,0)
 I %ZTX3'<0 S %ZTY=$S($D(^%ZTSCH("RUN"))[0&(%ZTX'["WAIT"):0,%ZTX3<30:1,%ZTX3<120&(%ZTX["PAUSE"):1,1:0)
"RTN","ZTMKU",73,0)
 K %ZTX,%ZTX1,%ZTX2,%ZTX3 Q
"RTN","ZTMKU",74,0)
 ;
"RTN","ZTMKU",75,0)
TABLE ;Display Task Manager Table
"RTN","ZTMKU",76,0)
 W !,"NUMBER",?15,"STATUS",?25,"DESCRIPTION",?55,"LAST UPDATED",?75,"LIVE"
"RTN","ZTMKU",77,0)
 W !,"------",?15,"------",?25,"-----------",?55,"------------",?75,"----"
"RTN","ZTMKU",78,0)
 D NODES S %ZTZ=%ZTY,%ZTZ1=0,U="^",%H=$H D YMD^%DTC S DT=X
"RTN","ZTMKU",79,0)
 F %ZTI=1:1:%ZTZ S %ZTX=%ZTY(%ZTI) D QUERY I %ZTY'=0 W !,%ZTY(%ZTI),?15,$P(%ZTY,U,2),?25,$P(%ZTY,U,3),?55 S %ZTT=$P(%ZTY,U) D T S %ZTX=%ZTY D LIVE W ?75,$S(%ZTY:"YES",1:"NO") I %ZTY S %ZTZ1=%ZTZ1+1
"RTN","ZTMKU",80,0)
 W !?6,"Total:",$J(%ZTZ,3),!?6,"Live :",$J(%ZTZ1,3)
"RTN","ZTMKU",81,0)
 K %ZTI,%ZTT,%ZTY,%ZTZ Q
"RTN","ZTMKU",82,0)
 ;
"RTN","ZTMKU",83,0)
CLEAN ;Cleanup Status Node
"RTN","ZTMKU",84,0)
 K ^%ZTSCH("STATUS") W !,"Done!",! Q
"RTN","ZTMKU",85,0)
PURGE ;Purge the TASK list of running tasks.
"RTN","ZTMKU",86,0)
 N TSK S TSK=0
"RTN","ZTMKU",87,0)
 F  S TSK=$O(^%ZTSCH("TASK",TSK)) Q:TSK'>0  I '$D(^%ZTSCH("TASK",TSK,"P")) K ^%ZTSCH("TASK",TSK)
"RTN","ZTMKU",88,0)
 W !,"Done!",! Q
"RTN","ZTMKU",89,0)
 ;
"RTN","ZTMKU",90,0)
ZTM ;Return Number Of Live Task Managers
"RTN","ZTMKU",91,0)
 D NODES S %ZTZ=%ZTY,%ZTZ1=0 F %ZTI=1:1:%ZTZ S %ZTX=%ZTY(%ZTI) D QUERY I %ZTY'=0 S %ZTX=%ZTY D LIVE I %ZTY S %ZTZ1=%ZTZ1+1
"RTN","ZTMKU",92,0)
 S %ZTY=%ZTZ1 K %ZTI,%ZTZ,%ZTZ1 Q
"RTN","ZTMKU",93,0)
 ;
"RTN","ZTMKU",94,0)
T ;Print Informal-format Conversion Of $H-format Date ; Input: %ZTT, DT.
"RTN","ZTMKU",95,0)
 S %H=%ZTT D 7^%DTC W $S(DT=X:"TODAY",DT+1=X:"TOMORROW",1:$E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3))_" AT " S X=$P(%ZTT,",",2)\60,%H=X\60 W $E(%H+100,2,3)_":"_$E(X#60+100,2,3)
"RTN","ZTMKU",96,0)
 K %,%D,%H,%M,%Y,X Q  ; Output: %ZTT, DT.
"RTN","ZTMKU",97,0)
 ;
"RTN","ZTMON1")
0^38^B20323739
"RTN","ZTMON1",1,0)
ZTMON1 ;SEA/RDS-TaskMan: Option, ZTMON, Part 2 (Main Loop) ;11/03/2003  13:42
"RTN","ZTMON1",2,0)
 ;;8.0;KERNEL;**36,118,127,275**;Jul 10, 1995
"RTN","ZTMON1",3,0)
MON D IO:MODE,JOB,SUB
"RTN","ZTMON1",4,0)
 G DONE
"RTN","ZTMON1",5,0)
 ;
"RTN","ZTMON1",6,0)
IO ;Evaluate Waiting Lists
"RTN","ZTMON1",7,0)
 N X,X1
"RTN","ZTMON1",8,0)
 S ZT1=$$H3($H),ZT2=$G(^%ZTSCH("IO")),ZT=$$DIFF^%ZTMS1(ZT1,+ZT2,1)
"RTN","ZTMON1",9,0)
 W !!,"Checking the IO Lists:" I $D(^%ZTSCH("IO"))>2 W:+ZT2 "  Last TM scan: ",ZT," sec, " W:$P(ZT2,"^",2)]"" "Last Dev: ",$P(ZT2,"^",2)
"RTN","ZTMON1",10,0)
 S ZT1="",ZTT=0
"RTN","ZTMON1",11,0)
I1 S ZT1=$O(^%ZTSCH("IO",ZT1)) I ZT1="" W:ZTT=0 !?5,"There are no tasks waiting for devices." Q
"RTN","ZTMON1",12,0)
 I $D(^%ZTSCH("IO",ZT1))<9 G I1 ;Skip devices without tasks
"RTN","ZTMON1",13,0)
 W !?5,"Device: ",ZT1 S Y=1 I ZT1'=$I S X=ZT1,X1=$G(^%ZTSCH("IO",ZT1)) D DEVOK^%ZOSV
"RTN","ZTMON1",14,0)
 W $S(Y:" is not available,",$D(^%ZTSCH("DEV",ZT1)):" is allocated,",1:" is AVAILABLE,")
"RTN","ZTMON1",15,0)
 S ZTC=0,ZT2="" F ZT=0:0 S ZT2=$O(^%ZTSCH("IO",ZT1,ZT2)),ZT3="" Q:'ZT2  F ZT=0:0 S ZT3=$O(^%ZTSCH("IO",ZT1,ZT2,ZT3)) Q:ZT3=""  S ZTC=ZTC+1,ZTT=1
"RTN","ZTMON1",16,0)
 W " with ",$S(ZTC=1:"one task",1:ZTC_" tasks")," waiting." W:ZTC>50 $C(7)
"RTN","ZTMON1",17,0)
 G I1
"RTN","ZTMON1",18,0)
 ;
"RTN","ZTMON1",19,0)
JOB ;Evaluate Job List
"RTN","ZTMON1",20,0)
 W !!,"Checking the Job List:"
"RTN","ZTMON1",21,0)
 S ZTC=0,ZT1="" F ZT=0:0 S ZT1=$O(^%ZTSCH("JOB",ZT1)),ZT2=0 Q:ZT1=""  F ZT=0:0 S ZT2=$O(^%ZTSCH("JOB",ZT1,ZT2)) Q:'ZT2  S ZTC=ZTC+1
"RTN","ZTMON1",22,0)
 W !?5,"There ",$S(ZTC=0:"are no tasks",ZTC=1:"is 1 task",1:"are "_ZTC_" tasks")," waiting for ",$S(ZTC'=1:"partitions.",1:"a partition.") W:ZTC>20 $C(7)
"RTN","ZTMON1",23,0)
 ;
"RTN","ZTMON1",24,0)
C ;Evaluate Cross CPU list
"RTN","ZTMON1",25,0)
 S ZT1=""
"RTN","ZTMON1",26,0)
 F  S ZT1=$O(^%ZTSCH("C",ZT1)) Q:ZT1=""  S ZTC=+$G(^(ZT1)) D
"RTN","ZTMON1",27,0)
 . S ZTCO=0,ZT2=""
"RTN","ZTMON1",28,0)
 . F  S ZT2=$O(^%ZTSCH("C",ZT1,ZT2)),ZT3=0 Q:ZT2=""  F  S ZT3=$O(^%ZTSCH("C",ZT1,ZT2,ZT3)) Q:ZT3=""  S ZTCO=ZTCO+1
"RTN","ZTMON1",29,0)
 . W !?5,"For ",ZT1," there ",$S(ZTCO=1:"is ",1:"are "),ZTCO," tasks.  "
"RTN","ZTMON1",30,0)
 . W $S(ZTC>8:"Not responding",$$OOS^%ZTM(ZT1):"Out Of Service",'$D(^%ZIS(14.7,"B",ZT1)):"Not defined",1:"")
"RTN","ZTMON1",31,0)
 . Q
"RTN","ZTMON1",32,0)
TASK ;Evaluate Task List
"RTN","ZTMON1",33,0)
 W !!,"Checking the Task List:"
"RTN","ZTMON1",34,0)
 S ZTC=0 F ZT1=0:0 S ZT1=$O(^%ZTSCH("TASK",ZT1)) Q:'ZT1  S ZTC=ZTC+1
"RTN","ZTMON1",35,0)
 W !?5,"There ",$S(ZTC=0:"are no tasks",ZTC=1:"is 1 task",1:"are "_ZTC_" tasks")," currently running."
"RTN","ZTMON1",36,0)
 Q
"RTN","ZTMON1",37,0)
 ;
"RTN","ZTMON1",38,0)
SUB ;Look for idle submanagers
"RTN","ZTMON1",39,0)
 D SUBCHK^%ZTMS5
"RTN","ZTMON1",40,0)
 N %N,ZT1,ZT2,ZT3,ZT4 L +^%ZTSCH("SUB"):1
"RTN","ZTMON1",41,0)
 I $D(^%ZTSCH("WAIT","SUB")) W !,"Sub-Managers told to Wait."
"RTN","ZTMON1",42,0)
 S %N=""
"RTN","ZTMON1",43,0)
 F  S %N=$O(^%ZTSCH("SUB",%N)) Q:%N=""  D
"RTN","ZTMON1",44,0)
 . S %=$G(^(%N)),ZT4=+$G(^%ZTSCH("LOADA",%N))
"RTN","ZTMON1",45,0)
 . W !?5,"On node ",%N," there ",$S('%:"are no",%=1:"is  1",1:"are "_$J(%,2))," free Sub-Manager(s)."
"RTN","ZTMON1",46,0)
 . W " Status: ",$S($D(^%ZTSCH("STOP","SUB",%N)):"Stop",ZT4:"BWait",1:"Run")
"RTN","ZTMON1",47,0)
 . I $G(^%ZTSCH("SUB",%N,0))>5 W !?10,"SUB-MANAGERS ARE NOT STARTING."
"RTN","ZTMON1",48,0)
 . Q
"RTN","ZTMON1",49,0)
 L -^%ZTSCH("SUB")
"RTN","ZTMON1",50,0)
 Q
"RTN","ZTMON1",51,0)
 ;
"RTN","ZTMON1",52,0)
DONE ;Prompt to Quit Or Continue
"RTN","ZTMON1",53,0)
 W !!,"Enter monitor action: UPDATE// "
"RTN","ZTMON1",54,0)
 R ZTR:$S($D(DTIME)#2:DTIME,1:60) S:ZTR="" ZTR="U"
"RTN","ZTMON1",55,0)
 I "Uu"[$E(ZTR) G MON^ZTMON
"RTN","ZTMON1",56,0)
 I "Ee"[$E(ZTR) Q:$$CALL("LIST^XUTMKE")  G DONE
"RTN","ZTMON1",57,0)
 I "Ss"[$E(ZTR) W @IOF X ^%ZOSF("SS") G DONE
"RTN","ZTMON1",58,0)
 I "Pp"[$E(ZTR) W @IOF D PARAMS^ZTMCHK G DONE
"RTN","ZTMON1",59,0)
 I "Rr"[$E(ZTR) W @IOF D RES G DONE
"RTN","ZTMON1",60,0)
 I "Tt"[$E(ZTR) S MODE='MODE W !,"Mode set to ",$S(MODE:"normal",1:"short") G DONE
"RTN","ZTMON1",61,0)
 I ZTR="^"!(ZTR="@") Q
"RTN","ZTMON1",62,0)
 I ZTR'["?" G MON^ZTMON
"RTN","ZTMON1",63,0)
 I ZTR="??" Q:$$CALL("SELECT^XUTMONH")  G MON^ZTMON
"RTN","ZTMON1",64,0)
 W !!?5,"Enter <RETURN> to update the monitor screen."
"RTN","ZTMON1",65,0)
 W !?5,"Enter ^ to exit the monitor."
"RTN","ZTMON1",66,0)
 W !?5,"Enter E to inspect the TaskMan Error file."
"RTN","ZTMON1",67,0)
 W !?5,"Enter P to see taskman parameters."
"RTN","ZTMON1",68,0)
 W !?5,"Enter R to see busy Resource slots."
"RTN","ZTMON1",69,0)
 W !?5,"Enter S to see a system status listing."
"RTN","ZTMON1",70,0)
 W !?5,"Enter ? to see this message."
"RTN","ZTMON1",71,0)
 W !?5,"Enter ?? to inspect the tasks in the monitor's lists."
"RTN","ZTMON1",72,0)
 G DONE
"RTN","ZTMON1",73,0)
 ;
"RTN","ZTMON1",74,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTMON1",75,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTMON1",76,0)
 ;
"RTN","ZTMON1",77,0)
CALL(RTN) ;Check for called routine
"RTN","ZTMON1",78,0)
 N DUOUT
"RTN","ZTMON1",79,0)
 I $D(^DIC(19,0))[0 W !,"In the wrong account." Q 0
"RTN","ZTMON1",80,0)
 D @RTN Q $D(DUOUT)
"RTN","ZTMON1",81,0)
 ;
"RTN","ZTMON1",82,0)
RES ;Check on resource devices
"RTN","ZTMON1",83,0)
 N ZT1,ZT2,ZT3,ZTIM,X
"RTN","ZTMON1",84,0)
 S ZT1=""
"RTN","ZTMON1",85,0)
 F  S ZT1=$O(^%ZTSCH("IO",ZT1)) Q:ZT1=""  I ^%ZTSCH("IO",ZT1)="RES" D
"RTN","ZTMON1",86,0)
 . ;Q:$D(^%ZTSCH("IO",ZT1))<9
"RTN","ZTMON1",87,0)
 . S ZT2=$O(^%ZISL(3.54,"B",ZT1,0)),ZT3=0 Q:ZT2'>0
"RTN","ZTMON1",88,0)
 . S X=$G(^%ZISL(3.54,ZT2,0))
"RTN","ZTMON1",89,0)
 . W !,"Resource ",ZT1,"  Aval. Slots: ",$P(X,U,2)
"RTN","ZTMON1",90,0)
 . F  S ZT3=$O(^%ZISL(3.54,ZT2,1,ZT3)) Q:ZT3'>0  D
"RTN","ZTMON1",91,0)
 . . S X=^%ZISL(3.54,ZT2,1,ZT3,0),ZTIM=$P(X,U,5) I ZTIM]"",ZTIM'["," S ZTIM=$$H0^%ZTM(ZTIM)
"RTN","ZTMON1",92,0)
 . . W !,?10,"Slot: ",$J(ZT3,2)," Job: ",$P(X,U,3)," Task: ",$P(X,U,4)
"RTN","ZTMON1",93,0)
 . . W "  time: ",$$HDIFF^%ZTLOAD7($H,ZTIM,2)
"RTN","ZTMON1",94,0)
 . . Q
"RTN","ZTMON1",95,0)
 . Q
"RTN","ZTMON1",96,0)
 Q
"RTN","ZTMS")
0^40^B15851747
"RTN","ZTMS",1,0)
%ZTMS ;SEA/RDS-TaskMan: Submanager, (Entry & Trap) ;11/3/03  13:46
"RTN","ZTMS",2,0)
 ;;8.0;KERNEL;**2,18,24,36,67,94,118,127,136,162,275**;Jul 10, 1995
"RTN","ZTMS",3,0)
 ;
"RTN","ZTMS",4,0)
START ;Bottom level of submanager
"RTN","ZTMS",5,0)
 S $ETRAP="D ERROR^%ZTMS HALT"
"RTN","ZTMS",6,0)
 D NOW^%DTC S ZTQUEUED=0,U="^",DT=X
"RTN","ZTMS",7,0)
 D KMPR("$STRT ZTMS$")
"RTN","ZTMS",8,0)
 D PARAMS G:$D(ZTOUT) QUIT
"RTN","ZTMS",9,0)
 I ZTPFLG("XUSCNT") D COUNT^XUSCNT(1)
"RTN","ZTMS",10,0)
 D SETNM^%ZOSV("Sub "_$J)
"RTN","ZTMS",11,0)
 S ^%ZTSCH("SUB",ZTPFLG("HOME"),0)=0
"RTN","ZTMS",12,0)
 I $D(^%ZTSCH("STOP","SUB",ZTPAIR)) G QUIT
"RTN","ZTMS",13,0)
 I ZTPFLG("XUSCNT") D SETLOCK^XUSCNT($NA(^%ZTSCH("SUBLK",ZTPFLG("HOME"),$J)))
"RTN","ZTMS",14,0)
 G SUBMGR^%ZTMS1
"RTN","ZTMS",15,0)
 ;
"RTN","ZTMS",16,0)
KMPR(TAG) ;Call KMPR to log data
"RTN","ZTMS",17,0)
 N Y
"RTN","ZTMS",18,0)
 I +$G(^%ZTSCH("LOGRSRC")) S Y="" X $G(^%ZOSF("UCI")) I Y[^%ZOSF("PROD") D LOGRSRC^%ZOSV(TAG)
"RTN","ZTMS",19,0)
 Q
"RTN","ZTMS",20,0)
QUIT D KMPR("$STOP ZTMS$")
"RTN","ZTMS",21,0)
 I ZTPFLG("XUSCNT") D COUNT^XUSCNT(-1)
"RTN","ZTMS",22,0)
 Q
"RTN","ZTMS",23,0)
PARAMS ;
"RTN","ZTMS",24,0)
 ;START--lookup parameters
"RTN","ZTMS",25,0)
 X ^%ZOSF("PRIINQ") S %ZTMS("PRIO")=Y ;Get starting priority
"RTN","ZTMS",26,0)
 D GETENV^%ZOSV
"RTN","ZTMS",27,0)
 S ZTCPU=$P(Y,U,2),ZTNODE=$P(Y,U,3),ZTPAIR=$P(Y,U,4),ZTUCI=$P(Y,U)_$S(ZTCPU]"":","_ZTCPU,1:"") S:ZTPAIR[":" ZTNODE=$P(ZTPAIR,":",2)
"RTN","ZTMS",28,0)
 S ZTPFLG("RT")=0,ZTPFLG("MIN")=1,ZTYPE="",ZTPFLG("ZTREQ")=0
"RTN","ZTMS",29,0)
 S ZTPN=$O(^%ZIS(14.7,"B",ZTPAIR,0)),ZTPFLG("ZTPN")=ZTPN
"RTN","ZTMS",30,0)
 I ZTPN>0 S %=$G(^%ZIS(14.7,ZTPN,0)) D
"RTN","ZTMS",31,0)
 . S ZTPFLG("RT")=+$P(%,U,6),ZTYPE=$P(%,U,9) S:$P(%,U,12)>1 ZTPFLG("MIN")=$P(%,U,12)
"RTN","ZTMS",32,0)
 . S ZTPFLG("HOME")=$S($P(%,U,13):$P(^%ZIS(14.7,+$P(%,U,13),0),U),1:ZTPAIR)
"RTN","ZTMS",33,0)
 . S ZTPFLG("ZTREQ")=+$G(^%ZIS(14.7,ZTPN,3))
"RTN","ZTMS",34,0)
 . Q
"RTN","ZTMS",35,0)
 S ZTPFLG("XUSCNT")=0 I ^%ZOSF("OS")["GT.M" S ZTPFLG("XUSCNT")=$L($T(^XUSCNT))
"RTN","ZTMS",36,0)
 K ZTMLOG ;Set to log msg about locks
"RTN","ZTMS",37,0)
 I "FO"[ZTYPE S ZTOUT=1 Q  ;SM only run on C,P,G types
"RTN","ZTMS",38,0)
 Q
"RTN","ZTMS",39,0)
ERROR ;START--trap
"RTN","ZTMS",40,0)
 I $S(^%ZOSF("OS")["GT.M":$ZS["STACKO",1:$ZE["STKOVR"!($ZE["STACK")) S $ET="Q:$ST>"_($ST-8)_"  D ERR2^%ZTMS" Q
"RTN","ZTMS",41,0)
 ;set backup trap, prepare to handle error.
"RTN","ZTMS",42,0)
ERR2 S $ETRAP="D ERROR2^%ZTMS0 HALT"
"RTN","ZTMS",43,0)
 S %ZTERLGR=$$LGR^%ZOSV
"RTN","ZTMS",44,0)
 S %ZTME=$$EC^%ZOSV,ZTERROH=$H
"RTN","ZTMS",45,0)
 S %ZTMETSK=$S($D(%ZTTV)#2:$P(%ZTTV,"^",4),$G(ZTSK)>0:ZTSK,1:0)
"RTN","ZTMS",46,0)
 I %ZTMETSK L ^%ZTSK(%ZTMETSK) ;Unlock all other locks
"RTN","ZTMS",47,0)
 I $G(IO)]"" L +^%ZTSCH("DEV",IO) ;Keep other tasks from IO device.
"RTN","ZTMS",48,0)
 ;Check if to record error
"RTN","ZTMS",49,0)
 I '$$SCREEN^%ZTER(%ZTME) D
"RTN","ZTMS",50,0)
 . D ^%ZTER ;Kernel error file
"RTN","ZTMS",51,0)
 . ;log error and context in TaskMan Error file
"RTN","ZTMS",52,0)
 . L +^%ZTSCH("ER") H 1 S ZTERROH=$H
"RTN","ZTMS",53,0)
 . S ^%ZTSCH("ER",+ZTERROH,$P(ZTERROH,",",2))=%ZTME
"RTN","ZTMS",54,0)
 . D XREF^%ZTMS0
"RTN","ZTMS",55,0)
 . S ^%ZTSCH("ER",+ZTERROH,$P(ZTERROH,",",2),1)=ZTERROX1
"RTN","ZTMS",56,0)
 . L -^%ZTSCH("ER")
"RTN","ZTMS",57,0)
 . Q
"RTN","ZTMS",58,0)
 ;
"RTN","ZTMS",59,0)
 I $D(ZTDEVOK) S $P(^%ZTSCH("IO"),U,2)=ZTDEVOK ;Have others skip dev.
"RTN","ZTMS",60,0)
 ;Update Task file entry
"RTN","ZTMS",61,0)
 I $G(ZTQUEUED),%ZTMETSK,$D(^%ZTSK(%ZTMETSK)) D STATUS^%ZTMS0
"RTN","ZTMS",62,0)
 ;
"RTN","ZTMS",63,0)
 ;D KMPR("$ETRP ZTMS$")
"RTN","ZTMS",64,0)
 I ZTPFLG("XUSCNT") D COUNT^XUSCNT(-1)
"RTN","ZTMS",65,0)
 I ZTQUEUED>.9,%ZTMETSK>0,$G(DUZ)>.9,$D(^DD(8992,.01,0)) D
"RTN","ZTMS",66,0)
 . S XQA(DUZ)="",XQAMSG="Your task #"_%ZTMETSK_" stopped because of an error",XQADATA=%ZTMETSK,XQAROU="XQA^XUTMUTL"
"RTN","ZTMS",67,0)
 . D SETUP^XQALERT Q
"RTN","ZTMS",68,0)
 ;
"RTN","ZTMS",69,0)
CLEAN ;clean up global data related to this process
"RTN","ZTMS",70,0)
 I $G(ZTQUEUED)>.9,'$D(^%ZTSCH("TASK",ZTQUEUED,"P")) K ^%ZTSCH("TASK",ZTQUEUED)
"RTN","ZTMS",71,0)
 K ^TMP($J),^UTILITY($J),^XUTL("XQ",$J)
"RTN","ZTMS",72,0)
 I '$G(ZTQUEUED) D SUB^%ZTMS1(-1)
"RTN","ZTMS",73,0)
 I $D(ZTDEVN)#2,$D(%ZTIO)#2,%ZTIO]"" D DEVLK^%ZTMS1(-1,%ZTIO)
"RTN","ZTMS",74,0)
 I $D(ZTDEVOK)#2 D DEVBAD^%ZTMS0
"RTN","ZTMS",75,0)
 I $G(ZTSYNCFL)]"" S X=$$SYNCFLG^%ZTMS2("S",ZTSYNCFL,"","Stopped because of an error")
"RTN","ZTMS",76,0)
 ;
"RTN","ZTMS",77,0)
CLOSE ;close i/o device after error
"RTN","ZTMS",78,0)
 D ERCLOZ^%ZTMS0
"RTN","ZTMS",79,0)
 I $G(IO)]"" C IO H 5 ;In case of a port problem give it time to reset.
"RTN","ZTMS",80,0)
 ;
"RTN","ZTMS",81,0)
 D KMPR("$STOP ZTMS$")
"RTN","ZTMS",82,0)
 I ZTQUEUED=.5,%ZTMETSK>0,$P($G(^%ZTSK(%ZTMETSK,.12)),"^")<5 D  ;Only try 5 times
"RTN","ZTMS",83,0)
 . S $P(^(.12),"^")=^%ZTSK(%ZTMETSK,.12)+1
"RTN","ZTMS",84,0)
 . S ^%ZTSCH($$NEWH^%ZTMS2($H,600),%ZTMETSK)=""
"RTN","ZTMS",85,0)
 HALT  ;Start a new process to continue
"RTN","ZTMS",86,0)
 ;
"RTN","ZTMS",87,0)
GTM ;Special entry point for GT.M
"RTN","ZTMS",88,0)
 S $ZINTERRUPT="I $$JOBEXAM^ZU($ZPOSITION)"
"RTN","ZTMS",89,0)
 G START
"RTN","ZTMS0")
0^62^B6894133
"RTN","ZTMS0",1,0)
%ZTMS0 ;SEA/RDS-TaskMan: Submanager, Part 2 (Trap Functions) ;18 Jun 2003 6:40 pm
"RTN","ZTMS0",2,0)
 ;;8.0;KERNEL;**24,118,275**;JUL 10, 1995
"RTN","ZTMS0",3,0)
 ;
"RTN","ZTMS0",4,0)
ERROR2 ;ERROR--trap
"RTN","ZTMS0",5,0)
 L ^%ZTSCH("ER") H 1 S ZTH=$H
"RTN","ZTMS0",6,0)
 S ^%ZTSCH("ER",+ZTH,$P(ZTH,",",2))=$$EC^%ZOSV
"RTN","ZTMS0",7,0)
 S ^%ZTSCH("ER",+ZTH,$P(ZTH,",",2),1)="Caused by the submanager while trapping an error."
"RTN","ZTMS0",8,0)
 L
"RTN","ZTMS0",9,0)
 HALT
"RTN","ZTMS0",10,0)
 ;
"RTN","ZTMS0",11,0)
STATUS ;ERROR--update task's status in Task File, Call w/ ^%ZTSK locked
"RTN","ZTMS0",12,0)
 S ZTE=$E(%ZTME,1,70)
"RTN","ZTMS0",13,0)
 S ZTE=$TR(ZTE,"^","~")
"RTN","ZTMS0",14,0)
 S $P(^%ZTSK(%ZTMETSK,.1),"^",1,3)=$S(ZTQUEUED>.5:"C^",1:"L^")_$H_"^"_ZTE
"RTN","ZTMS0",15,0)
 S $P(^%ZTSK(%ZTMETSK,.12),"^",2,9)=ZTERROH_"^"_%ZTME
"RTN","ZTMS0",16,0)
 S ^%ZTSK(%ZTMETSK,.12,ZTERROH)=%ZTME
"RTN","ZTMS0",17,0)
 Q
"RTN","ZTMS0",18,0)
 ;
"RTN","ZTMS0",19,0)
DEVBAD ;ERROR--dequeue all entries for a bad device
"RTN","ZTMS0",20,0)
 N ZT,ZT1,ZT2,ZT3,ZT4
"RTN","ZTMS0",21,0)
 Q:'$$DEVLK^%ZTMS1(1,ZTDEVOK)
"RTN","ZTMS0",22,0)
 L +^%ZTSCH("IO"):5 G DBX:'$T  S $P(^%ZTSCH("IO"),"^")=$$H3^%ZTM($H)
"RTN","ZTMS0",23,0)
 S ZT2=ZTDEVOK,ZT3=""
"RTN","ZTMS0",24,0)
 F  S ZT3=$O(^%ZTSCH("IO",ZT2,ZT3)),ZT4="" Q:ZT3=""  F  S ZT4=$O(^%ZTSCH("IO",ZT2,ZT3,ZT4)) Q:ZT4=""  L +^%ZTSK(ZT4) D DQ L -^%ZTSK(ZT4)
"RTN","ZTMS0",25,0)
 K ^%ZTSCH("IO",ZTDEVOK)
"RTN","ZTMS0",26,0)
 I $O(^%ZTSCH("IO",""))="" K ^%ZTSCH("IO")
"RTN","ZTMS0",27,0)
 L -^%ZTSCH("IO")
"RTN","ZTMS0",28,0)
DBX D DEVLK^%ZTMS1(-1,ZTDEVOK)
"RTN","ZTMS0",29,0)
 Q
"RTN","ZTMS0",30,0)
 ;
"RTN","ZTMS0",31,0)
DQ ;DEVBAD--remove a task from the waiting list for a bad device
"RTN","ZTMS0",32,0)
 K ^%ZTSCH("IO",ZT2,ZT3,ZT4)
"RTN","ZTMS0",33,0)
 S $P(^%ZTSK(ZT4,.1),"^",1,3)="B^"_$H_"^BAD IO DEVICE "_ZT2
"RTN","ZTMS0",34,0)
 K ^%ZTSK(ZT4,.26,ZT2)
"RTN","ZTMS0",35,0)
 I $O(^%ZTSK(ZT4,.26,""))]"" Q
"RTN","ZTMS0",36,0)
 K ^%ZTSK(ZT4,.26)
"RTN","ZTMS0",37,0)
 Q
"RTN","ZTMS0",38,0)
 ;
"RTN","ZTMS0",39,0)
ERCLOZ ;ERROR--close device after error
"RTN","ZTMS0",40,0)
 N %ZT1 S %ZT1=(IO=$G(^XUTL("XQ",$J,"IO")))
"RTN","ZTMS0",41,0)
 I 0[$I D ERC1
"RTN","ZTMS0",42,0)
 I $G(^XUTL("XQ",$J,"IO"))'=$I D ERC2
"RTN","ZTMS0",43,0)
 Q
"RTN","ZTMS0",44,0)
ERC1 ;Close current device
"RTN","ZTMS0",45,0)
 I %ZTME["data set hang-up" Q
"RTN","ZTMS0",46,0)
 I %ZTME["CLOSERR" Q
"RTN","ZTMS0",47,0)
 I %ZTME["DSCON" Q
"RTN","ZTMS0",48,0)
 I '$D(ZTQUEUED) Q:$D(IO)[0  Q:IO=""  C:$O(^%ZISL(3.54,"B",IO,""))="" IO Q
"RTN","ZTMS0",49,0)
 I '$D(IO)&'($D(IOT)) Q
"RTN","ZTMS0",50,0)
 S IO("C")="" D ^%ZISC
"RTN","ZTMS0",51,0)
 Q
"RTN","ZTMS0",52,0)
ERC2 ;Close original Device
"RTN","ZTMS0",53,0)
 N POP
"RTN","ZTMS0",54,0)
 S POP=1 D RESETVAR^%ZIS Q:POP
"RTN","ZTMS0",55,0)
 ;S IOS=$P(%ZTTV,"^",2),(IO,IO(0))=$P(%ZTTV,"^",5),IOT=$P(%ZTTV,"^",6),IOF=$P(%ZTTV,"^",11),IOST=$P(%ZTTV,"^",12),IO("C")=""
"RTN","ZTMS0",56,0)
 I $D(IO(1,IO)) S IO("C")="" D ^%ZISC
"RTN","ZTMS0",57,0)
 Q
"RTN","ZTMS0",58,0)
 ;
"RTN","ZTMS0",59,0)
XREF ;ERROR--cross-reference TaskMan Error file entry by context of error
"RTN","ZTMS0",60,0)
 S ZTERROX=$S('%ZTMETSK:"an unknown task.",1:"Task # "_%ZTMETSK_".")
"RTN","ZTMS0",61,0)
 S ZTQUEUED=$G(ZTQUEUED)
"RTN","ZTMS0",62,0)
 I ZTQUEUED=0 S ZTERROX1="Caused by the submanager." Q
"RTN","ZTMS0",63,0)
 I ZTQUEUED=.5 S ZTERROX1="Caused by the submanager while preparing "_ZTERROX Q
"RTN","ZTMS0",64,0)
 I ZTQUEUED=.6 S ZTERROX1="Caused by submanager after "_ZTERROX Q
"RTN","ZTMS0",65,0)
 S ZTERROX1="Caused by "_ZTERROX
"RTN","ZTMS0",66,0)
 Q
"RTN","ZTMS0",67,0)
 ;
"RTN","ZTMS1")
0^50^B26930044
"RTN","ZTMS1",1,0)
%ZTMS1 ;SEA/RDS-TaskMan: Submanager, (Loop & Get Task) ;11/03/2003  13:31
"RTN","ZTMS1",2,0)
 ;;8.0;KERNEL;**36,49,104,118,127,136,275**;JUL 10, 1995;
"RTN","ZTMS1",3,0)
 ;
"RTN","ZTMS1",4,0)
SUBMGR ;START--outer submanager loop
"RTN","ZTMS1",5,0)
 D GETTASK G:ZTSK'>0 QUIT^%ZTMS ;task locked
"RTN","ZTMS1",6,0)
 I $L($P($G(^%ZTSK(ZTSK,.1)),U,10)) D  G SUBMGR
"RTN","ZTMS1",7,0)
 . D TSKSTAT("D","Stopped by User") S (ZTSK,ZTQUEUED)=0
"RTN","ZTMS1",8,0)
 . Q
"RTN","ZTMS1",9,0)
 D PROCESS^%ZTMS2 G:$D(ZTQUIT) QUIT^%ZTMS
"RTN","ZTMS1",10,0)
 G SUBMGR
"RTN","ZTMS1",11,0)
 ;
"RTN","ZTMS1",12,0)
GETTASK ;SUBMGR--retain the partition; check Waiting Lists every 1 seconds
"RTN","ZTMS1",13,0)
 D SUB(1) S ZTSK=0
"RTN","ZTMS1",14,0)
 ;
"RTN","ZTMS1",15,0)
 F ZRT=0:0 D  Q:$$EXIT  S %=$S($O(^%ZTSCH("JOB",0))>0:1,1:$R(1+$$SUB(0))+1),ZRT=ZRT+% H % ;Space out the SM loop
"RTN","ZTMS1",16,0)
 . I $D(^%ZTSCH("WAIT","SUB")) H 5 Q  ;Wait
"RTN","ZTMS1",17,0)
 . S %ZTIME=$$H3($H),ZTSK=0 I $D(^%ZTSCH("STOP","SUB",ZTPAIR)) Q
"RTN","ZTMS1",18,0)
 . D C Q:ZTSK!(ZTYPE="C")  ;Do directed work before check for balance
"RTN","ZTMS1",19,0)
 . I $$BALANCE S ZRT=ZRT-.4 Q  ;Wait for balance, Slow ZRT rise.
"RTN","ZTMS1",20,0)
 . D JOB,IOQ:'ZTSK ;Look at last 2 lists
"RTN","ZTMS1",21,0)
 . Q
"RTN","ZTMS1",22,0)
 Q
"RTN","ZTMS1",23,0)
 ;
"RTN","ZTMS1",24,0)
EXIT() ;GETTASK--decide whether to exit retention loop
"RTN","ZTMS1",25,0)
 I ZTSK,$D(^%ZTSCH("NO-OPTION")),$P(^%ZTSK(ZTSK,0),"^",1,2)="ZTSK^XQ1" D
"RTN","ZTMS1",26,0)
 . D SCHTM^%ZTMS2(ZTDTH+60) S ZTSK=0
"RTN","ZTMS1",27,0)
 . Q
"RTN","ZTMS1",28,0)
 I ZTSK G YES
"RTN","ZTMS1",29,0)
 I $D(^%ZTSCH("STOP","SUB",ZTPAIR)) G YES
"RTN","ZTMS1",30,0)
 I ZTPFLG("RT")>ZRT G NO ;Retention time check
"RTN","ZTMS1",31,0)
 I $$SUB(0)>ZTPFLG("MIN") G YES ;Let extras go
"RTN","ZTMS1",32,0)
NO ;EXIT--Don't exit
"RTN","ZTMS1",33,0)
 S ^%ZTSCH("SUB",ZTPFLG("HOME"),$J)=$H ;Keep our node current
"RTN","ZTMS1",34,0)
 I ZTPFLG("XUSCNT") D SETLOCK^XUSCNT($NA(^%ZTSCH("SUBLK",ZTPFLG("HOME"),$J)))
"RTN","ZTMS1",35,0)
 L ^%ZTSCH("SUBLK",ZTPFLG("HOME"),$J) Q 0
"RTN","ZTMS1",36,0)
 ;
"RTN","ZTMS1",37,0)
YES ;EXIT--adjust counter and set flags
"RTN","ZTMS1",38,0)
 D SUB(-1)
"RTN","ZTMS1",39,0)
 Q 1
"RTN","ZTMS1",40,0)
 ;
"RTN","ZTMS1",41,0)
C ;GETTASK--On C type volume sets, get tasks from Cross-Volume Job List
"RTN","ZTMS1",42,0)
 I $O(^%ZTSCH("C",ZTPAIR,0))="" Q
"RTN","ZTMS1",43,0)
 L +^%ZTSCH("C",ZTPAIR):1 I '$T D:$D(ZTMLOG) LOG^%ZTMS7("No Lock C")
"RTN","ZTMS1",44,0)
 S ZTDTH="",^%ZTSCH("C",ZTPAIR)=0
"RTN","ZTMS1",45,0)
 F  S ZTDTH=$O(^%ZTSCH("C",ZTPAIR,ZTDTH)),ZTSK=0 Q:ZTDTH=""  D  Q:ZTSK
"RTN","ZTMS1",46,0)
 . F  S ZTSK=$O(^%ZTSCH("C",ZTPAIR,ZTDTH,ZTSK)),ZX=0 Q:ZTSK=""  D  Q:ZX
"RTN","ZTMS1",47,0)
 .. I $D(^%ZTSK(ZTSK,0))[0!'ZTSK D  Q
"RTN","ZTMS1",48,0)
 ... I ZTSK'=0,$D(^%ZTSK(ZTSK)) D TSKSTAT("I")
"RTN","ZTMS1",49,0)
 ... K ^%ZTSCH("C",ZTPAIR,ZTDTH,ZTSK) S ZTSK=0
"RTN","ZTMS1",50,0)
 ... Q
"RTN","ZTMS1",51,0)
 .. L +^%ZTSK(ZTSK):0 Q:'$T
"RTN","ZTMS1",52,0)
 .. S %ZTIO=^%ZTSCH("C",ZTPAIR,ZTDTH,ZTSK),ZTQUEUED=.5
"RTN","ZTMS1",53,0)
 .. I %ZTIO]"" S ZTDEVN=1
"RTN","ZTMS1",54,0)
 .. K ^%ZTSCH("C",ZTPAIR,ZTDTH,ZTSK)
"RTN","ZTMS1",55,0)
 .. S ZX=1
"RTN","ZTMS1",56,0)
 .. Q
"RTN","ZTMS1",57,0)
 . Q
"RTN","ZTMS1",58,0)
 ;I $D(^%ZTSCH("C",ZTPAIR))=1 K ^%ZTSCH("C",ZTPAIR)
"RTN","ZTMS1",59,0)
 L -^%ZTSCH("C",ZTPAIR)
"RTN","ZTMS1",60,0)
 Q
"RTN","ZTMS1",61,0)
 ;
"RTN","ZTMS1",62,0)
BALANCE() ;GETTASK--check load balance, and wait while Manager waits
"RTN","ZTMS1",63,0)
 Q:ZTPAIR="" 0
"RTN","ZTMS1",64,0)
 I $G(^%ZTSCH("LOADA",ZTPAIR)) Q 1
"RTN","ZTMS1",65,0)
 Q 0
"RTN","ZTMS1",66,0)
 ;
"RTN","ZTMS1",67,0)
JOB ;GETTASK--search Partition Waiting List
"RTN","ZTMS1",68,0)
 S ZTSK=0,ZTDTH=0,ZTQUEUED=0
"RTN","ZTMS1",69,0)
 L +^%ZTSCH("JOBQ"):1 I '$T D:$D(ZTMLOG) LOG^%ZTMS7("No Lock JOBQ") Q
"RTN","ZTMS1",70,0)
J2 S ZTDTH=$O(^%ZTSCH("JOB",ZTDTH)),ZTSK=0 I ZTDTH="" L -^%ZTSCH("JOBQ") Q
"RTN","ZTMS1",71,0)
J3 S ZTSK=$O(^%ZTSCH("JOB",ZTDTH,ZTSK)),ZTQUEUED=0 I ZTSK'>0 G J2
"RTN","ZTMS1",72,0)
 L +^%ZTSK(ZTSK):0 G J3:'$T
"RTN","ZTMS1",73,0)
 I $D(^%ZTSCH("JOB",ZTDTH,ZTSK))[0 L -^%ZTSK(ZTSK) G J3
"RTN","ZTMS1",74,0)
 I $D(^%ZTSK(ZTSK,0))[0 D BADTASK L -^%ZTSK(ZTSK) G J3
"RTN","ZTMS1",75,0)
 S %ZTIO=^%ZTSCH("JOB",ZTDTH,ZTSK),ZTQUEUED=.5
"RTN","ZTMS1",76,0)
 K ^%ZTSCH("JOB",ZTDTH,ZTSK) L -^%ZTSCH("JOBQ") ;Now can release JOBQ
"RTN","ZTMS1",77,0)
 ;try and only pick up work for this node.
"RTN","ZTMS1",78,0)
 S ZTREC=$G(^%ZTSK(ZTSK,0)),%=$P(ZTREC,U,14) I %[":",%'[ZTNODE D  G J3
"RTN","ZTMS1",79,0)
 . S ^%ZTSCH("C",%,ZTDTH,ZTSK)=%ZTIO
"RTN","ZTMS1",80,0)
 . Q
"RTN","ZTMS1",81,0)
 I %ZTIO]"" S ZTDEVN=1
"RTN","ZTMS1",82,0)
 Q
"RTN","ZTMS1",83,0)
 ;
"RTN","ZTMS1",84,0)
BADTASK ;JOB--unschedule tasks with bad numbers or incomplete records
"RTN","ZTMS1",85,0)
 S %ZTIO=^%ZTSCH("JOB",ZTDTH,ZTSK) I %ZTIO]"" S ZTDEVN=1
"RTN","ZTMS1",86,0)
 I ZTSK'=0,$D(^%ZTSK(ZTSK)) D TSKSTAT("I",3)
"RTN","ZTMS1",87,0)
 K ^%ZTSCH("JOB",ZTDTH,ZTSK)
"RTN","ZTMS1",88,0)
 S ZTQUEUED=0
"RTN","ZTMS1",89,0)
 I %ZTIO]"" D DEVLK(-1,%ZTIO)
"RTN","ZTMS1",90,0)
 Q
"RTN","ZTMS1",91,0)
 ;
"RTN","ZTMS1",92,0)
IOQ ;GETTASK--search Device Waiting List, Lock IO then DEV.
"RTN","ZTMS1",93,0)
 S ZTSK=0 I '$D(^%ZTSCH("IO")) Q
"RTN","ZTMS1",94,0)
 ;Lock to just to get last scan
"RTN","ZTMS1",95,0)
 L +^%ZTSCH("IO"):0 I '$T D:$D(ZTMLOG) LOG^%ZTMS7("No Lock IO")
"RTN","ZTMS1",96,0)
 S ZTI=$G(^%ZTSCH("IO")),ZTH=%ZTIME
"RTN","ZTMS1",97,0)
 ;Keep 5 sec apart
"RTN","ZTMS1",98,0)
 I $TR($$DIFF(%ZTIME,+ZTI,1),"-")'>5 L -^%ZTSCH("IO") D:$D(ZTMLOG) LOG^%ZTMS7("IO TIME") Q
"RTN","ZTMS1",99,0)
 S $P(^%ZTSCH("IO"),"^")=%ZTIME,%ZTIO=$P(ZTI,"^",2)
"RTN","ZTMS1",100,0)
 L -^%ZTSCH("IO")
"RTN","ZTMS1",101,0)
I2 S %ZTIO=$O(^%ZTSCH("IO",%ZTIO)),ZTDTH="" I %ZTIO="" G IOX
"RTN","ZTMS1",102,0)
 I $D(^%ZTSCH("IO",%ZTIO))<9 G I2
"RTN","ZTMS1",103,0)
 S IOT=^%ZTSCH("IO",%ZTIO)
"RTN","ZTMS1",104,0)
 I IOT'["RES" G I2:'$$DEVLK(1,%ZTIO) ;lock device if not RES.
"RTN","ZTMS1",105,0)
 I '$D(^%ZTSCH("DEVTRY",%ZTIO)) S ^%ZTSCH("DEVTRY",%ZTIO)=%ZTIME ;Set problem device check
"RTN","ZTMS1",106,0)
 S X=%ZTIO,X1=IOT,ZTDEVOK=X D DEVOK^%ZOSV I Y D DEVLK(-1,%ZTIO) G I2
"RTN","ZTMS1",107,0)
I3 S ZTDTH=$O(^%ZTSCH("IO",%ZTIO,ZTDTH)),ZTSK=0 I ZTDTH="" D DEVLK(-1,%ZTIO) G I2
"RTN","ZTMS1",108,0)
I5 S ZTSK=$O(^%ZTSCH("IO",%ZTIO,ZTDTH,ZTSK)) I ZTSK'>0 G I3
"RTN","ZTMS1",109,0)
 L +^%ZTSK(ZTSK):0 G I5:('$T)
"RTN","ZTMS1",110,0)
 S ZTQUEUED=.5 D DQ^%ZTM4 I $G(^%ZTSK(ZTSK,0))="" L -^%ZTSK(ZTSK) G I5
"RTN","ZTMS1",111,0)
 S ZTH=%ZTIME-20 ;Leave ^%ZTSCH("DEV",io) locked, Released in %ZTMS2
"RTN","ZTMS1",112,0)
IOX L +^%ZTSCH("IO"):0 S ^%ZTSCH("IO")=ZTH_"^"_%ZTIO L -^%ZTSCH("IO") ;Update anyway
"RTN","ZTMS1",113,0)
 K ZTDEVOK,%ZISCHK
"RTN","ZTMS1",114,0)
 Q
"RTN","ZTMS1",115,0)
 ;
"RTN","ZTMS1",116,0)
DEVLK(X,ZIO,TO) ;1=Lock/-1=unlock the ^%ZTSCH("DEV",ZIO) node.
"RTN","ZTMS1",117,0)
 I X<0 L -^%ZTSCH("DEV",ZIO) Q
"RTN","ZTMS1",118,0)
 L +^%ZTSCH("DEV",ZIO):(+$G(TO)) I '$T Q 0
"RTN","ZTMS1",119,0)
 Q 1
"RTN","ZTMS1",120,0)
 ;
"RTN","ZTMS1",121,0)
SUB(X) ;Inc/Dec SUB or return SUB count
"RTN","ZTMS1",122,0)
 N % L +^%ZTSCH("SUB",ZTPFLG("HOME")):5
"RTN","ZTMS1",123,0)
 S %=+$G(^%ZTSCH("SUB",ZTPFLG("HOME"))) S:%<1 %=0
"RTN","ZTMS1",124,0)
 I X>0 S ^%ZTSCH("SUB",ZTPFLG("HOME"))=%+1,^%ZTSCH("SUB",ZTPFLG("HOME"),$J)=$H
"RTN","ZTMS1",125,0)
 I X<0 S ^%ZTSCH("SUB",ZTPFLG("HOME"))=$S(%>0:%-1,1:0) K ^%ZTSCH("SUB",ZTPFLG("HOME"),$J)
"RTN","ZTMS1",126,0)
 L -^%ZTSCH("SUB",ZTPFLG("HOME"))
"RTN","ZTMS1",127,0)
 Q:X=0 % Q
"RTN","ZTMS1",128,0)
 ;
"RTN","ZTMS1",129,0)
DIFF(N,O,T) ;Diff in sec.
"RTN","ZTMS1",130,0)
 Q:$G(T) N-O ;For new seconds times
"RTN","ZTMS1",131,0)
 Q N-O*86400-$P(O,",",2)+$P(N,",",2)
"RTN","ZTMS1",132,0)
 ;
"RTN","ZTMS1",133,0)
TSKSTAT(CODE,MSG) ;Update task's status
"RTN","ZTMS1",134,0)
 S $P(^%ZTSK(ZTSK,.1),U,1,3)=$G(CODE)_U_$H_U_$G(MSG)
"RTN","ZTMS1",135,0)
 Q
"RTN","ZTMS1",136,0)
 ;
"RTN","ZTMS1",137,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTMS1",138,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTMS1",139,0)
H0(%) ;Covert from seconds to $H
"RTN","ZTMS1",140,0)
 Q (%\86400)_","_(%#86400)
"RTN","ZTMS1",141,0)
 ;
"RTN","ZTMS2")
0^51^B23098676
"RTN","ZTMS2",1,0)
%ZTMS2 ;SEA/RDS-TaskMan: Submanager, Part 4 (Unload, Get Device) ;11/12/2003  12:59
"RTN","ZTMS2",2,0)
 ;;8.0;KERNEL;**2,18,23,36,67,118,127,163,167,175,199,275**;Jul 10, 1995
"RTN","ZTMS2",3,0)
 ;^%ZTSK(ZTSK),^%ZTSCH("DEV",IO) is locked on entry or return from GETNEXT
"RTN","ZTMS2",4,0)
PROCESS ;SUBMGR--process task and all others waiting for same device
"RTN","ZTMS2",5,0)
 L +^%ZTSCH("TASK",ZTSK):1 I '$T Q  ;Only allow one copy of a task at one time
"RTN","ZTMS2",6,0)
 D LOOKUP I $D(ZTREJECT) Q
"RTN","ZTMS2",7,0)
 D DEVICE
"RTN","ZTMS2",8,0)
 I POP L  Q  ;Release all locks
"RTN","ZTMS2",9,0)
 I ZTSYNCFL]"",'$$SYNCFLG("A",ZTSYNCFL,%ZTIO) D  Q
"RTN","ZTMS2",10,0)
 . D SYNCQ(ZTSYNCFL,%ZTIO,ZTDTH,ZTSK),^%ZISC L  ;Release all locks
"RTN","ZTMS2",11,0)
 . Q
"RTN","ZTMS2",12,0)
 ;Go run task
"RTN","ZTMS2",13,0)
 D TASK^%ZTMS3 I ZTYPE="C"!$D(ZTNONEXT) Q
"RTN","ZTMS2",14,0)
 D GETNEXT^%ZTMS7 I $D(ZTNONEXT)!$D(ZTQUIT) Q
"RTN","ZTMS2",15,0)
 G PROCESS
"RTN","ZTMS2",16,0)
 ;
"RTN","ZTMS2",17,0)
LOOKUP ;PROCESS--unload task, switch ucis, and test entry routine
"RTN","ZTMS2",18,0)
 K (%ZTIME,%ZTIO,DT,IO,U,ZTCPU,ZTDEVN,ZTDTH,ZTNODE,ZTPAIR,ZTPFLG,ZTQUEUED,ZTSK,ZTUCI,ZTYPE)
"RTN","ZTMS2",19,0)
 D TSKSTAT(4,"")
"RTN","ZTMS2",20,0)
 S ZTREC=^%ZTSK(ZTSK,0),ZTREC02=^(.02)
"RTN","ZTMS2",21,0)
 S ZTREC2=^%ZTSK(ZTSK,.2),ZTREC21=^(.21),ZTREC25=^(.25)
"RTN","ZTMS2",22,0)
 S ZTSYNCFL=$P(ZTREC2,"^",7),DUZ=+$P(ZTREC,U,3),DUZ(0)="@"
"RTN","ZTMS2",23,0)
 S X=$P(ZTREC02,U)_","_$P(ZTREC02,U,2)
"RTN","ZTMS2",24,0)
 I $P(ZTREC02,U,4) S $P(X,",",2)=ZTCPU
"RTN","ZTMS2",25,0)
 ;should do a check to see if X is OK, Should check UCI mapping.
"RTN","ZTMS2",26,0)
 I X'=ZTUCI S ZTUCI=X D SWAP^%XUCI
"RTN","ZTMS2",27,0)
 S X=$P($P(ZTREC,U,2),"("),ZTRTN=$P(ZTREC,U,1,2)
"RTN","ZTMS2",28,0)
 I $E(X)'="%",$L(X) X ^%ZOSF("TEST") I X=""!'$T D REJECT S ZTREJECT=""
"RTN","ZTMS2",29,0)
 Q
"RTN","ZTMS2",30,0)
 ;
"RTN","ZTMS2",31,0)
REJECT ;LOOKUP--entry routine isn't here; reject task
"RTN","ZTMS2",32,0)
 N Y X ^%ZOSF("UCI")
"RTN","ZTMS2",33,0)
 D TSKSTAT("B","No routine at destination "_Y_".")
"RTN","ZTMS2",34,0)
 I $D(ZTDEVN) D DEVLK^%ZTMS1(-1,%ZTIO) K ZTDEVN
"RTN","ZTMS2",35,0)
 L  Q  ;Clear all locks
"RTN","ZTMS2",36,0)
 ;
"RTN","ZTMS2",37,0)
DEVICE ;PROCESS--prepare requested device; if can't, make task wait
"RTN","ZTMS2",38,0)
 ;First clean-up all IO variables that could influence the device
"RTN","ZTMS2",39,0)
 K %ZIS,IO,IOCPU,IOHG,IOPAR,IOUPAR,IOS
"RTN","ZTMS2",40,0)
 ;If don't need a device, Setup minimum.
"RTN","ZTMS2",41,0)
 S ZTIO=$P(ZTREC2,U),ZTIOT=$P(ZTREC2,U,3)
"RTN","ZTMS2",42,0)
 I ZTIO="" S (IO,IO(0),IOF,IOM,ION,IOS,IOSL,IOST,IOT)="",POP=0 Q
"RTN","ZTMS2",43,0)
 ;
"RTN","ZTMS2",44,0)
 ;setup call
"RTN","ZTMS2",45,0)
 S %ZIS="LRS0"_$S($P(ZTREC2,U,5)="DIRECT":"D",1:"")
"RTN","ZTMS2",46,0)
 S:ZTIOT="HFS" %ZIS("HFSIO")=$P(ZTREC2,U,6),%ZIS("IOPAR")=ZTREC25
"RTN","ZTMS2",47,0)
 S:ZTIOT="MT" %ZIS("IOPAR")=ZTREC25
"RTN","ZTMS2",48,0)
 S (IO,IO(0))=%ZTIO,IOP=ZTIO
"RTN","ZTMS2",49,0)
 S:'$D(^%ZTSCH("DEVTRY",$P(ZTIO,";"))) ^($P(ZTIO,";"))=%ZTIME ;Set problem device check
"RTN","ZTMS2",50,0)
 K ^XUTL("XQ",$J),IO("ERROR")
"RTN","ZTMS2",51,0)
 ;
"RTN","ZTMS2",52,0)
 S:$P(ZTREC2,U,4)["MINIOUT" %ZISLOCK="^%ZTSCH(""NETMAIL"",IO)" ;The hang is on the close
"RTN","ZTMS2",53,0)
 ;call
"RTN","ZTMS2",54,0)
 S %ZISTO=3 D ^%ZIS K %ZISTO,%ZISLOCK ;See that we use a timeout.
"RTN","ZTMS2",55,0)
 I %ZTIO]"" D DEVLK^%ZTMS1(-1,%ZTIO) K ZTDEVN
"RTN","ZTMS2",56,0)
 I 'POP K ^%ZTSCH("DEVTRY",IO),^($P(ZTIO,";")) ;Clear problem device check
"RTN","ZTMS2",57,0)
 ;Reset %ZTIO if IO doesn't match
"RTN","ZTMS2",58,0)
 I 'POP,%ZTIO]"",IO'=%ZTIO C %ZTIO K IO(1,%ZTIO),^%ZTSCH("DEVTRY",$P(%ZTIO,";")) S %ZTIO=IO
"RTN","ZTMS2",59,0)
 ;
"RTN","ZTMS2",60,0)
 ;results
"RTN","ZTMS2",61,0)
 I POP,(ZTYPE'="C"),(ZTIOT="TRM")!(ZTIOT="RES")!(ZTIOT="HG") D IONQ Q  ;only add to IO queue if not type C.
"RTN","ZTMS2",62,0)
 I POP D SCHNQ Q
"RTN","ZTMS2",63,0)
 I IOT'="RES",IOT'="HG" U IO
"RTN","ZTMS2",64,0)
 S IO(0)=IO
"RTN","ZTMS2",65,0)
 I $P(^%ZIS(1,+IOS,0),U,7)="y" D ^%ZTMSH
"RTN","ZTMS2",66,0)
 Q
"RTN","ZTMS2",67,0)
 ;
"RTN","ZTMS2",68,0)
IONQ ;DEVICE--put task on Device Waiting List
"RTN","ZTMS2",69,0)
 I $D(^%ZTSK(ZTSK,0))[0 D TSKSTAT("I",4) G IOQX
"RTN","ZTMS2",70,0)
 D TSKSTAT("A","")
"RTN","ZTMS2",71,0)
 N %ZTIO S %ZTIO=IO
"RTN","ZTMS2",72,0)
 S ZTIO(1)=$P(ZTREC2,U,5),ZTIOS=ZTREC21
"RTN","ZTMS2",73,0)
 D NQ^%ZTM4 ;Uses %ZTIO as the Device $I value
"RTN","ZTMS2",74,0)
IOQX L  Q  ;Clear all Locks
"RTN","ZTMS2",75,0)
 ;
"RTN","ZTMS2",76,0)
SCHNQ ;DEVICE--if HFS or SPL or TYPE'=C, reschedule task 10 min in future (try later)
"RTN","ZTMS2",77,0)
 S ZTH=$$NEWH($H,300)
"RTN","ZTMS2",78,0)
 D TSKSTAT(1,"rescheduled for busy device")
"RTN","ZTMS2",79,0)
 S $P(^%ZTSK(ZTSK,.2),U,8)=$P(^%ZTSK(ZTSK,.2),U,8)+1 ;ReQ count
"RTN","ZTMS2",80,0)
 D SCHTM(ZTH)
"RTN","ZTMS2",81,0)
 I $L($G(IO("ERROR"))) S $P(^%ZTSK(ZTSK,.12),U,2,9)=$H_U_IO("ERROR") ;May tell why couldn't get device
"RTN","ZTMS2",82,0)
 L  Q  ;Clear all locks
"RTN","ZTMS2",83,0)
 ;
"RTN","ZTMS2",84,0)
SCHTM(ZTDTH) ;Set a new schedule time, See that task is updated
"RTN","ZTMS2",85,0)
 S $P(^%ZTSK(ZTSK,0),U,6)=$$H0^%ZTM(ZTDTH),^%ZTSK(ZTSK,.04)=ZTDTH,^%ZTSCH(ZTDTH,ZTSK)=""
"RTN","ZTMS2",86,0)
 Q
"RTN","ZTMS2",87,0)
NEWH(%H,%Y) ;Build a new schedule time, Return $H3 time.
"RTN","ZTMS2",88,0)
 N %
"RTN","ZTMS2",89,0)
 I %H["," S %H=$$H3^%ZTM(%H)
"RTN","ZTMS2",90,0)
 Q (%H+%Y)
"RTN","ZTMS2",91,0)
 ;
"RTN","ZTMS2",92,0)
SYNCFLG(ACT,FLAG,ZIO,STAT) ;Allocate/deallocate sync flag
"RTN","ZTMS2",93,0)
 N X,DA,SYNC
"RTN","ZTMS2",94,0)
 L +^%ZISL(14.8):30 E  Q 0
"RTN","ZTMS2",95,0)
 S X=0,SYNC=FLAG_"~"_ZIO,DA=$O(^%ZISL(14.8,"B",SYNC,0))
"RTN","ZTMS2",96,0)
 I ACT["A" D
"RTN","ZTMS2",97,0)
 . I DA S X=0 Q
"RTN","ZTMS2",98,0)
 . ;I $D(^%ZTSCH("SYNC",ZIO,FLAG)) S X=0 Q
"RTN","ZTMS2",99,0)
 . S X=$P(^%ZISL(14.8,0),"^",3)+1 F  Q:'$D(^%ZISL(14.8,X))  S X=X+1
"RTN","ZTMS2",100,0)
 . S $P(^(0),"^",3,4)=X_"^"_($P(^%ZISL(14.8,0),"^",4)+1),^%ZISL(14.8,X,0)=SYNC,^%ZISL(14.8,"B",SYNC,X)=""
"RTN","ZTMS2",101,0)
 . S X=1 Q
"RTN","ZTMS2",102,0)
 I ACT["D" D  S X=1
"RTN","ZTMS2",103,0)
 . Q:DA'>0
"RTN","ZTMS2",104,0)
 . K ^%ZISL(14.8,DA),^%ZISL(14.8,"B",SYNC,DA)
"RTN","ZTMS2",105,0)
 . S $P(^(0),"^",3,4)=(DA-1)_"^"_($P(^%ZISL(14.8,0),"^",4)-1)
"RTN","ZTMS2",106,0)
 . Q
"RTN","ZTMS2",107,0)
 I ACT["S" D  S X=1
"RTN","ZTMS2",108,0)
 . Q:DA'>0
"RTN","ZTMS2",109,0)
 . S ^%ZISL(14.8,DA,1)=$G(STAT)
"RTN","ZTMS2",110,0)
 . Q
"RTN","ZTMS2",111,0)
 I ACT["?" S X=(DA)!($D(^%ZTSCH("SYNC",ZIO,FLAG)))
"RTN","ZTMS2",112,0)
 L -^%ZISL(14.8)
"RTN","ZTMS2",113,0)
 Q X
"RTN","ZTMS2",114,0)
 ;
"RTN","ZTMS2",115,0)
SYNCQ(FLAG,ZIO,ZTH,ZTSK) ;Put task on sync flag waiting list
"RTN","ZTMS2",116,0)
 L +^%ZTSCH("SYNC")
"RTN","ZTMS2",117,0)
 S ^%ZTSCH("SYNC",ZIO,FLAG,ZTSK)=ZTH
"RTN","ZTMS2",118,0)
 L -^%ZTSCH("SYNC")
"RTN","ZTMS2",119,0)
 Q
"RTN","ZTMS2",120,0)
SCHSYNC(FLAG,ZIO) ;put a waiting task in IO queue
"RTN","ZTMS2",121,0)
 L +^%ZTSCH("SYNC") I $D(^%ZTSCH("SYNC",ZIO,FLAG)) N ZTH,ZTSK D
"RTN","ZTMS2",122,0)
 . S ZTSK=$O(^(FLAG,0)),ZTH=$G(^(+ZTSK)) Q:ZTSK=""  S:$D(^%ZTSCH("IO",ZIO))[0 ^(ZIO)=IOT
"RTN","ZTMS2",123,0)
 . S ^%ZTSCH("IO",ZIO,ZTH,ZTSK)=""
"RTN","ZTMS2",124,0)
 . K ^%ZTSCH("SYNC",ZIO,FLAG,ZTSK)
"RTN","ZTMS2",125,0)
 . Q
"RTN","ZTMS2",126,0)
 L -^%ZTSCH("SYNC")
"RTN","ZTMS2",127,0)
 Q
"RTN","ZTMS2",128,0)
TSKSTAT(CODE,MSG) ;Record status
"RTN","ZTMS2",129,0)
 S $P(^%ZTSK(ZTSK,.1),U,1,3)=$G(CODE)_U_$H_U_$G(MSG)
"RTN","ZTMS2",130,0)
 Q
"RTN","ZTMS2",131,0)
 ;
"RTN","ZTMS2",132,0)
POST ;Post INIT cleanup for patch XU*8*167
"RTN","ZTMS2",133,0)
 N T S T=0
"RTN","ZTMS2",134,0)
 F  S T=$O(^%ZTSCH(T)) Q:T'>0  I $D(^%ZTSCH(T,0)) K ^%ZTSCH(T,0)
"RTN","ZTMS2",135,0)
 Q
"RTN","ZTMS3")
0^52^B23747001
"RTN","ZTMS3",1,0)
%ZTMS3 ;SEA/RDS-TaskMan: Submanager, Part 5 (Run Task) ;6/8/04  16:44
"RTN","ZTMS3",2,0)
 ;;8.0;KERNEL;**1,18,36,49,64,67,94,118,127,136,175,275**;Jul 10, 1995
"RTN","ZTMS3",3,0)
 ;
"RTN","ZTMS3",4,0)
TASK ;SUBMGR--prepare and run task; cleanup after
"RTN","ZTMS3",5,0)
 ;
"RTN","ZTMS3",6,0)
BEFORE ;prepare task
"RTN","ZTMS3",7,0)
 ;submanager's variables
"RTN","ZTMS3",8,0)
 S ZTDEF=""
"RTN","ZTMS3",9,0)
 S X=$O(^%ZIS(14.7,"B",ZTPAIR,""))
"RTN","ZTMS3",10,0)
 I X]"",$D(^%ZIS(14.7,X,0))#2 S ZTDEF=^(0)
"RTN","ZTMS3",11,0)
 S DUZ=+$P(ZTREC,U,3)
"RTN","ZTMS3",12,0)
 S %ZTTV=ZTUCI_U_IOS_U_U_ZTSK_U_IO_U_IOT_U_ZTCPU_U_ZTNODE_U_DUZ_U_U_IOF_U_IOST_U_ZTPAIR_U_ZTYPE_U
"RTN","ZTMS3",13,0)
 S %ZTTV(0)=ZTRTN_U_$P(ZTREC,U,8,9)_U_$P(ZTREC,U,6)_U_ION_U_ZTUCI_U_$P(ZTREC,U,5)_U_$S($L($P(ZTREC,U,10)):$P(ZTREC,U,10),1:$P(ZTREC,U,3))_U_$J_U_ZTSYNCFL_U_ZTPAIR_U
"RTN","ZTMS3",14,0)
 ;
"RTN","ZTMS3",15,0)
 I +$G(^%ZTSCH("LOGRSRC")) S %ZTTV(1)="!"_$S($P(ZTREC,U,9)="":$P(ZTREC,U,2),1:$P(ZTREC,U,9))
"RTN","ZTMS3",16,0)
 ;
"RTN","ZTMS3",17,0)
 ;external calls
"RTN","ZTMS3",18,0)
 D NOW^%DTC S DT=% ;DT is Date.time at this point.
"RTN","ZTMS3",19,0)
1 D SETNM^%ZOSV($E("BTask ",(ZTIO]"")+1,6)_(ZTSK#100000000))
"RTN","ZTMS3",20,0)
 ;
"RTN","ZTMS3",21,0)
 ;priority (Not done in the VA)
"RTN","ZTMS3",22,0)
 ;S X=$P(ZTREC,U,15)
"RTN","ZTMS3",23,0)
 ;S X=$S(+X'=X:0,X'<1&(X'>10):X\1,1:0)
"RTN","ZTMS3",24,0)
 ;S Y=$S(IOS="":0,$D(^%ZIS(1,+IOS,0))[0:0,1:+$P(^(0),U,5))
"RTN","ZTMS3",25,0)
 ;S Y=$S(Y'<1&(Y'>10):Y\1,1:0)
"RTN","ZTMS3",26,0)
 ;S X=$S(Y:Y,X:X,$P(ZTDEF,U,4):$P(ZTDEF,U,4),1:10)
"RTN","ZTMS3",27,0)
 ;X ^%ZOSF("PRIORITY")
"RTN","ZTMS3",28,0)
 ;
"RTN","ZTMS3",29,0)
2 ;restore saved variables
"RTN","ZTMS3",30,0)
 S X=$O(^XTV(8989.3,1,4,"B",ZTCPU,0)) S:$P($G(^XTV(8989.3,1,4,+X,0)),U,6)="y" XRTL=ZTUCI
"RTN","ZTMS3",31,0)
 K %,%H,%I,%ZTI,%ZTIO,IO("C"),IO("T"),X,Y,ZTCPU,ZTDEF,ZTIOST,ZTIOT,ZTNODE,ZTPAIR,ZTREC,ZTREC2,ZTREC21,ZTREC25,ZTUCI
"RTN","ZTMS3",32,0)
 K ^TMP($J),^UTILITY($J),^XUTL("XQ",$J)
"RTN","ZTMS3",33,0)
 S DUZ(0)="" D RESTORE^%ZTMS4
"RTN","ZTMS3",34,0)
 ;
"RTN","ZTMS3",35,0)
 ;force values
"RTN","ZTMS3",36,0)
 S DUZ=+DUZ,DTIME=0,ZTDESC=$G(^%ZTSK(ZTSK,.03)),ZTDTH=$H
"RTN","ZTMS3",37,0)
 I DUZ(0)="" S DUZ(0)=$S($D(^VA(200,DUZ,0))#2:$P(^(0),U,4),1:"")
"RTN","ZTMS3",38,0)
 I $D(DUZ(2))[0 S DUZ(2)=$S($D(^VA(200,DUZ,2,0)):$O(^(0)),1:0)
"RTN","ZTMS3",39,0)
 S ^XUTL("XQ",$J,0)=DT,^("ZTSK")=ZTDESC,^("ZTSKNUM")=ZTSK
"RTN","ZTMS3",40,0)
 S X="DUZ" F  S X=$Q(@X) Q:X=""  I $D(@X) S ^XUTL("XQ",$J,$TR(X,""""))=@X
"RTN","ZTMS3",41,0)
 F X="DUZ","IO","IOBS","IOF","IOM","ION","IOS","IOSL","IOST","IOST(0)","IOT","IOXY","XQVOL" I $D(@X) S ^XUTL("XQ",$J,X)=@X
"RTN","ZTMS3",42,0)
3 ;
"RTN","ZTMS3",43,0)
 ;final checks & sets
"RTN","ZTMS3",44,0)
 I '$D(^%ZTSK(ZTSK)) S ZTTASK=0 D AFTER Q
"RTN","ZTMS3",45,0)
 I $L($P($G(^%ZTSK(ZTSK,.1)),U,10)) D  Q
"RTN","ZTMS3",46,0)
 . D TSKSTAT("D","Stopped by User")
"RTN","ZTMS3",47,0)
 . S ZTTASK=0
"RTN","ZTMS3",48,0)
 . D AFTER
"RTN","ZTMS3",49,0)
 D TSKSTAT(5,"Started Running",$J)
"RTN","ZTMS3",50,0)
 S ZTQUEUED=ZTSK,ZTSTAT="1 General error"
"RTN","ZTMS3",51,0)
 S ^%ZTSCH("TASK",ZTSK)=%ZTTV(0)_$H,^(ZTSK,2)=%ZTTV
"RTN","ZTMS3",52,0)
 ;
"RTN","ZTMS3",53,0)
4 ;run task
"RTN","ZTMS3",54,0)
 I ^%ZOSF("OS")["MSM" D
"RTN","ZTMS3",55,0)
 . I $P($ZV,"Version ",2)]]"4.3.0" D PURGELST^%MSMOPS Q
"RTN","ZTMS3",56,0)
 . Q
"RTN","ZTMS3",57,0)
 L
"RTN","ZTMS3",58,0)
 I ZTPFLG("XUSCNT") D SETLOCK^XUSCNT($NA(^%ZTSCH("TASK",ZTSK)))
"RTN","ZTMS3",59,0)
 L +^%ZTSCH("TASK",ZTSK) ;establish a lock on the task to be used to indicate that it is active
"RTN","ZTMS3",60,0)
 ;Persistent task get set in ZTSK^XQ1
"RTN","ZTMS3",61,0)
 I $P(^%ZIS(14.7,ZTPFLG("ZTPN"),0),U,3)="Y" S %ZTTV("LOG")=1 D LOGIN^%ZTMS4
"RTN","ZTMS3",62,0)
 I $D(%ZTTV(1)) D:+$G(^%ZTSCH("LOGRSRC")) LOGRSRC^%ZOSV(%ZTTV(1))
"RTN","ZTMS3",63,0)
 S DT=DT\1 S:ZTPFLG("ZTREQ") ZTREQ="@"
"RTN","ZTMS3",64,0)
 D RUN
"RTN","ZTMS3",65,0)
 I $D(%ZTTV(1)) D:+$G(^%ZTSCH("LOGRSRC")) LOGRSRC^%ZOSV("$AFTR ZTMS$")
"RTN","ZTMS3",66,0)
 I $G(%ZTTV("LOG")) D LOGOUT^%ZTMS4
"RTN","ZTMS3",67,0)
 ;
"RTN","ZTMS3",68,0)
AFTER ;cleanup after task; reset partition
"RTN","ZTMS3",69,0)
 S U="^",ZTSK=$P(%ZTTV,U,4) D PCLEAR^%ZTLOAD(ZTSK) ;Clear persistent flag
"RTN","ZTMS3",70,0)
 D TSKSTAT(6,"Finished")
"RTN","ZTMS3",71,0)
 I ZTPFLG("XUSCNT") D SETLOCK^XUSCNT()
"RTN","ZTMS3",72,0)
 L  ;Clear all user locks.
"RTN","ZTMS3",73,0)
 L +^%ZTSK(ZTSK)
"RTN","ZTMS3",74,0)
 I $D(ZTTASK)[0 K ^%ZTSCH("TASK",ZTSK) S ZTQUEUED=.6,ZTTASK=1
"RTN","ZTMS3",75,0)
 ;S X=10 X ^%ZOSF("PRIORITY")
"RTN","ZTMS3",76,0)
 D SETNM^%ZOSV("Sub "_$J) ;Change name back
"RTN","ZTMS3",77,0)
 S ZTUCI=$P(%ZTTV,U),IOS=$P(%ZTTV,U,2),(IO,IO(0),%ZTIO)=$P(%ZTTV,U,5),IOT=$P(%ZTTV,U,6),ZTCPU=$P(%ZTTV,U,7),ZTNODE=$P(%ZTTV,U,8)
"RTN","ZTMS3",78,0)
 S IOF=$P(%ZTTV,U,11),IOST=$P(%ZTTV,U,12),ZTPAIR=$P(%ZTTV,U,13),ZTYPE=$P(%ZTTV,U,14),ZTSYNCFL=$P(%ZTTV(0),U,11)
"RTN","ZTMS3",79,0)
 I $G(ZTSYNCFL)]"" S X=$$SYNCFLG^%ZTMS2($S($G(ZTSTAT):"S",1:"D"),ZTSYNCFL,IO,$G(ZTSTAT)) D SCHSYNC^%ZTMS2(ZTSYNCFL,IO):'$G(ZTSTAT)
"RTN","ZTMS3",80,0)
 D POST^%ZTMS4:ZTTASK,CLOSE
"RTN","ZTMS3",81,0)
 K ^TMP($J),^UTILITY($J),^XUTL("XQ",$J) I $T(XUTL^XUSCLEAN)]"" D XUTL^XUSCLEAN
"RTN","ZTMS3",82,0)
 K (%ZTIO,%ZTTV,DT,IO,IOF,ION,IOS,IOST,IOT,U,ZTCPU,ZTNODE,ZTNONEXT,ZTPAIR,ZTPFLG,ZTQUEUED,ZTREQ,ZTSTOP,ZTUCI,ZTYPE)
"RTN","ZTMS3",83,0)
 K IO("C"),IO("T"),IO("ERROR"),IO("LASTERR"),IO("DOC"),IO("P"),IO("HFSIO")
"RTN","ZTMS3",84,0)
 S DUZ=0,DUZ(0)="@",ZTQUEUED=0
"RTN","ZTMS3",85,0)
 L  ;Clear all locks, -^%ZTSK(ZTSK)
"RTN","ZTMS3",86,0)
 Q
"RTN","ZTMS3",87,0)
 ;
"RTN","ZTMS3",88,0)
RUN ;
"RTN","ZTMS3",89,0)
 N %,%ZTTV,ZTPFLG,XUALLOC
"RTN","ZTMS3",90,0)
 F %=1:1:12 S $P(XUALLOC(%)," ",250)=""
"RTN","ZTMS3",91,0)
 D @ZTRTN
"RTN","ZTMS3",92,0)
 Q
"RTN","ZTMS3",93,0)
 ;
"RTN","ZTMS3",94,0)
CLOSE ;RUN--close &/or close execute
"RTN","ZTMS3",95,0)
 I %ZTIO="" S ZTNONEXT=1 G CLX
"RTN","ZTMS3",96,0)
 N ZTUCI,ZTCPU,ZTNODE,IOCPU,%IO
"RTN","ZTMS3",97,0)
 I IOT="HFS"!(IOT="SPL") S ZTNONEXT=1
"RTN","ZTMS3",98,0)
 K IO("C") S:IOT'="TRM" IO("C")=1
"RTN","ZTMS3",99,0)
 S:$D(IO("CLOSE")) IO("T")=1
"RTN","ZTMS3",100,0)
 I IOT="RES" K ZTNONEXT Q  ;For a Resource, don't close.
"RTN","ZTMS3",101,0)
 ;Here is the Lock and hang to allow IDCU ports to reset. See %ZTMS2.
"RTN","ZTMS3",102,0)
 I IOST["MINIOUT" S IO("C")=1,%IO=1 L +^%ZTSCH("NETMAIL",%ZTIO):8
"RTN","ZTMS3",103,0)
 I $D(IO(1,IO))#2 D ^%ZISC
"RTN","ZTMS3",104,0)
 I $G(%IO) H 6 ;Wait for terminal server to reset.
"RTN","ZTMS3",105,0)
 ;Unlock of all locks is done in clean
"RTN","ZTMS3",106,0)
 ;See that all devices are closed.
"RTN","ZTMS3",107,0)
CLX S %IO="" F  S %IO=$O(IO(1,%IO)) Q:%IO=""  I %IO'=IO K IO(1,%IO) C %IO
"RTN","ZTMS3",108,0)
 Q
"RTN","ZTMS3",109,0)
 ;
"RTN","ZTMS3",110,0)
TSKSTAT(CODE,MSG,JOB) ; Update task's status
"RTN","ZTMS3",111,0)
 S $P(^%ZTSK(ZTSK,.1),U,1,3)=$G(CODE)_U_$H_U_$G(MSG)
"RTN","ZTMS3",112,0)
 I $G(JOB)>0 S $P(^%ZTSK(ZTSK,.1),U,4)=JOB
"RTN","ZTMS3",113,0)
 Q
"RTN","ZTMS3",114,0)
 ;
"RTN","ZTMS4")
0^53^B5923868
"RTN","ZTMS4",1,0)
%ZTMS4 ;SEA/RDS-TaskMan: Submanager, Part 6 (Setup, Cleanup) ;10 Feb 2003 3:01 pm
"RTN","ZTMS4",2,0)
 ;;8.0;KERNEL;**136,275**;JUL 10, 1995
"RTN","ZTMS4",3,0)
 ;
"RTN","ZTMS4",4,0)
RESTORE ;RUN--restore saved variables
"RTN","ZTMS4",5,0)
 ;prepare for restore, Call w/ task locked.
"RTN","ZTMS4",6,0)
 N %ZTTV,DT,IO,IOBS,IOHG,IOM,ION,IOPAR,IOS,IOSL,IOST,IOT,IOUPAR,IOXY,POP,U,XY,ZTDTH,ZTIO,ZTQUEUED,ZTRTN
"RTN","ZTMS4",7,0)
 ;
"RTN","ZTMS4",8,0)
 ;restore from old node
"RTN","ZTMS4",9,0)
 K ^%ZTSK(ZTSK,0,"ZTSK"),^("ZT3")
"RTN","ZTMS4",10,0)
 S ZT3=""
"RTN","ZTMS4",11,0)
 F ZT=0:0 S ZT3=$O(^%ZTSK(ZTSK,0,ZT3)) Q:ZT3=""  I +ZT3'=ZT3 S:$D(^(ZT3))#2 @ZT3=^(ZT3) I $D(^(ZT3))>9 S %X="^%ZTSK(ZTSK,0,ZT3,",%Y=ZT3_$E("(",ZT3'["(") D %XY^%RCR
"RTN","ZTMS4",12,0)
 ;
"RTN","ZTMS4",13,0)
A ;restore from new node
"RTN","ZTMS4",14,0)
 K ^%ZTSK(ZTSK,.3,"ZTSK"),^("ZT3")
"RTN","ZTMS4",15,0)
 S ZT3=""
"RTN","ZTMS4",16,0)
 F ZT=0:0 S ZT3=$O(^%ZTSK(ZTSK,.3,ZT3)) Q:ZT3=""  I +ZT3'=ZT3 S:$D(^(ZT3))#2 @ZT3=^(ZT3) I $D(^(ZT3))>9 S %X="^%ZTSK(ZTSK,.3,ZT3,",%Y=ZT3_$E("(",ZT3'["(") D %XY^%RCR
"RTN","ZTMS4",17,0)
 ;
"RTN","ZTMS4",18,0)
 ;cleanup
"RTN","ZTMS4",19,0)
 K %A,%B,%C,%X,%Y,%Z,ZT,ZT3
"RTN","ZTMS4",20,0)
 Q
"RTN","ZTMS4",21,0)
 ;
"RTN","ZTMS4",22,0)
POST ;RUN--post-execution commands, Call w/ task locked.
"RTN","ZTMS4",23,0)
 I $G(ZTSTOP)=1 D TSKSTAT^%ZTMS3("D","Job asked to stop") Q
"RTN","ZTMS4",24,0)
 S X=^%ZTSK(ZTSK,.1) ;Get keep till.
"RTN","ZTMS4",25,0)
 I $S($P(X,U,8)>$H:0,$D(^%ZTSK(ZTSK,0))[0:1,$G(ZTREQ)="@":1,1:0) D KILL^%ZTM4 Q
"RTN","ZTMS4",26,0)
 N ZTUCI,ZTCPU,ZTNODE,ZTPAIR,ZTYPE,ZTRTN,ZTDESC,ZTIO,ZTDTH ;Protect current values.
"RTN","ZTMS4",27,0)
 I $D(ZTREQ)#2 S ZTDTH=$P(ZTREQ,U),ZTIO=$P(ZTREQ,U,2),ZTDESC=$P(ZTREQ,U,3),ZTRTN=$P(ZTREQ,U,4,5),ZTIO(1)=$P(ZTREQ,U,6) S:$P(ZTRTN,U,2)="" ZTRTN=$P(ZTRTN,U) D REQ^%ZTLOAD Q
"RTN","ZTMS4",28,0)
 Q
"RTN","ZTMS4",29,0)
 ;
"RTN","ZTMS4",30,0)
 ;
"RTN","ZTMS4",31,0)
LOGIN ;RUN--enter task in signon log
"RTN","ZTMS4",32,0)
 I '$L($T(SLOG^XUS1)) Q  ;No Sign-on Log
"RTN","ZTMS4",33,0)
 N XL1
"RTN","ZTMS4",34,0)
 S XL1=$$SLOG^XUS1($P(%ZTTV,U,7),1,IOS,$P($P(%ZTTV,U),","),$P(%ZTTV,U,8))
"RTN","ZTMS4",35,0)
 S $P(%ZTTV,U,10)=XL1
"RTN","ZTMS4",36,0)
 Q
"RTN","ZTMS4",37,0)
 ;
"RTN","ZTMS4",38,0)
LOGOUT ;RUN--set signoff time for task in signon log
"RTN","ZTMS4",39,0)
 N ZT
"RTN","ZTMS4",40,0)
 S ZT=$P(%ZTTV,"^",10) Q:ZT'>0  D LOUT^XUSCLEAN(ZT)
"RTN","ZTMS4",41,0)
 Q
"RTN","ZTMS4",42,0)
 ;
"RTN","ZTMS4",43,0)
ALERT ;Send a alert for rejected tasks.
"RTN","ZTMS4",44,0)
 I $G(DUZ)>.9,$D(^DD(8992,.01,0)) D
"RTN","ZTMS4",45,0)
 . D SETUP^XQALERT
"RTN","ZTMS4",46,0)
 ;S ZTREQ="@"
"RTN","ZTMS4",47,0)
 Q
"RTN","ZTMS5")
0^63^B927042
"RTN","ZTMS5",1,0)
%ZTMS5 ;ISF/RWF - SubManager Utilities ;10/29/2003 ;11/03/2003  13:45
"RTN","ZTMS5",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995;
"RTN","ZTMS5",3,0)
 Q
"RTN","ZTMS5",4,0)
 ;Lock and time are set in EXIT^%ZTMS1.
"RTN","ZTMS5",5,0)
SUBCHK ;Check for lost submanagers, Update Count
"RTN","ZTMS5",6,0)
 N %C,%N,%J,ZT2,ZT3
"RTN","ZTMS5",7,0)
 S %N=""
"RTN","ZTMS5",8,0)
 F  S %N=$O(^%ZTSCH("SUB",%N)) Q:%N=""  D
"RTN","ZTMS5",9,0)
 . L +^%ZTSCH("SUB",%N):5
"RTN","ZTMS5",10,0)
 . S %C=0,%J=0,ZT3=$$H3^%ZTM($H)
"RTN","ZTMS5",11,0)
 . F  S %J=$O(^%ZTSCH("SUB",%N,%J)) Q:%J'>0  D
"RTN","ZTMS5",12,0)
 . . S ZT2=$$H3^%ZTM($G(^(%J)))
"RTN","ZTMS5",13,0)
 . . ;Check for not locked.
"RTN","ZTMS5",14,0)
 . . L +^%ZTSCH("SUBLK",%N,%J):0 I $T L -^%ZTSCH("SUBLK",%N,%J) K ^%ZTSCH("SUB",%N,%J) Q
"RTN","ZTMS5",15,0)
 . . ;Check for old
"RTN","ZTMS5",16,0)
 . . I (ZT2+30)<ZT3 K ^%ZTSCH("SUB",%N,%J) Q
"RTN","ZTMS5",17,0)
 . . S %C=%C+1
"RTN","ZTMS5",18,0)
 . . Q
"RTN","ZTMS5",19,0)
 . S ^%ZTSCH("SUB",%N)=%C
"RTN","ZTMS5",20,0)
 . L -^%ZTSCH("SUB",%N)
"RTN","ZTMS5",21,0)
 . Q
"RTN","ZTMS5",22,0)
 Q
"RTN","ZTMS7")
0^54^B3559512
"RTN","ZTMS7",1,0)
%ZTMS7 ;SEA/RDS-TaskMan: Submanager, (GetNext) ;10 Feb 2003 3:17 pm
"RTN","ZTMS7",2,0)
 ;;8.0;KERNEL;**1,118,127,136,275**;Jul 10, 1995;
"RTN","ZTMS7",3,0)
 ;
"RTN","ZTMS7",4,0)
GETNEXT ;PROCESS--search Device Waiting List for next task waiting for %ZTIO
"RTN","ZTMS7",5,0)
 ;check stop node, and claim ownership of Device Waiting List
"RTN","ZTMS7",6,0)
 S %ZTIME=$$H3^%ZTM($H)
"RTN","ZTMS7",7,0)
 I $D(^%ZTSCH("STOP","SUB",ZTPAIR)) S ZTQUIT=1 G DEALOC8
"RTN","ZTMS7",8,0)
 I $D(^%ZTSCH("WAIT","SUB")) G DEALOC8
"RTN","ZTMS7",9,0)
 I $O(^%ZTSCH("IO",%ZTIO,0))<1 G DEALOC8
"RTN","ZTMS7",10,0)
 S %=$G(^%ZTSCH("IO",%ZTIO))
"RTN","ZTMS7",11,0)
 I %'["RES" S X=$$DEVLK^%ZTMS1(1,%ZTIO,3) D:$D(ZTMLOG) LOG("No Lock "_%ZTIO) I 'X G DEALOC8
"RTN","ZTMS7",12,0)
 I %["RES" D ^%ZISC ;If a RES close now so open will update
"RTN","ZTMS7",13,0)
 S ZTDTH=""
"RTN","ZTMS7",14,0)
 ;
"RTN","ZTMS7",15,0)
 ;look for task
"RTN","ZTMS7",16,0)
G3 S ZTDTH=$O(^%ZTSCH("IO",%ZTIO,ZTDTH)),ZTSK="" I ZTDTH="" G DEALOC8
"RTN","ZTMS7",17,0)
G5 S ZTSK=$O(^%ZTSCH("IO",%ZTIO,ZTDTH,ZTSK)) I ZTSK="" G G3
"RTN","ZTMS7",18,0)
 L +^%ZTSK(ZTSK):0 G G5:'$T
"RTN","ZTMS7",19,0)
 I $D(^%ZTSCH("IO",%ZTIO,ZTDTH,ZTSK))[0 L -^%ZTSK(ZTSK) G G5
"RTN","ZTMS7",20,0)
 D DQ^%ZTM4 ;Remove from lists
"RTN","ZTMS7",21,0)
 I $D(^%ZTSK(ZTSK,0))[0!'ZTSK D  G G5
"RTN","ZTMS7",22,0)
 . I ZTSK>0,$D(^%ZTSK(ZTSK)) D TSKSTAT("I","Discarded Because Incomplete")
"RTN","ZTMS7",23,0)
 . L -^%ZTSK(ZTSK)
"RTN","ZTMS7",24,0)
 I $L($P($G(^%ZTSK(ZTSK,.1)),U,10)) D  G G5
"RTN","ZTMS7",25,0)
 . D TSKSTAT("D","Stopped by User")
"RTN","ZTMS7",26,0)
 . L -^%ZTSK(ZTSK)
"RTN","ZTMS7",27,0)
 S ZTQUEUED=.5
"RTN","ZTMS7",28,0)
 D:$D(ZTMLOG) LOG("Got "_%ZTIO)
"RTN","ZTMS7",29,0)
 Q  ;Quit w/ ^%ZTSK(ZTSK) locked
"RTN","ZTMS7",30,0)
 ;
"RTN","ZTMS7",31,0)
DEALOC8 ;GETNEXT--deallocate device, and set ZTNONEXT
"RTN","ZTMS7",32,0)
 D DEVLK^%ZTMS1(-1,%ZTIO)
"RTN","ZTMS7",33,0)
 S IO("C")="",IO("T")=1 D ^%ZISC K IO("T"),IO("C")
"RTN","ZTMS7",34,0)
 S ZTNONEXT=1,%ZTIO=""
"RTN","ZTMS7",35,0)
 L  ;Quit w/ all locks clear.
"RTN","ZTMS7",36,0)
 Q
"RTN","ZTMS7",37,0)
 ;
"RTN","ZTMS7",38,0)
LOG(M) ;Log a msg
"RTN","ZTMS7",39,0)
 N % S %=$G(^%ZTSCH("L",$J))+1,^($J)=%
"RTN","ZTMS7",40,0)
 S ^%ZTSCH("L",$J,%)=M_" ^"_$H
"RTN","ZTMS7",41,0)
 Q
"RTN","ZTMS7",42,0)
TSKSTAT(CODE,MSG) ; Update task's status
"RTN","ZTMS7",43,0)
 S $P(^%ZTSK(ZTSK,.1),U,1,3)=$G(CODE)_U_$H_U_$G(MSG)
"RTN","ZTMS7",44,0)
 Q
"RTN","ZUGTM")
0^24^B10091845
"RTN","ZUGTM",1,0)
ZU ;SF/JLI,RWF - For GT.M, TIE ALL TERMINALS TO THIS ROUTINE!! ;11/24/2003  11:34
"RTN","ZUGTM",2,0)
 ;;8.0;KERNEL;**275**;Jul 10, 1995
"RTN","ZUGTM",3,0)
 ; for GT.M for VMS & Unix, version 4.3
"RTN","ZUGTM",4,0)
 ;
"RTN","ZUGTM",5,0)
 ;The env var ZINTRRUPT should be set to catch all interrupts.
"RTN","ZUGTM",6,0)
EN ;See that escape processing is off, Conflict with Screenman
"RTN","ZUGTM",7,0)
 U $P:(NOCENABLE:NOESCAPE)
"RTN","ZUGTM",8,0)
 D:+$G(^%ZTSCH("LOGRSRC")) LOGRSRC^%ZOSV("$LOGIN$")
"RTN","ZUGTM",9,0)
 N $ESTACK,$ETRAP S $ETRAP="D ERR^ZU Q:$QUIT -9 Q"
"RTN","ZUGTM",10,0)
 S $ZINTERRUPT="I $$JOBEXAM^ZU($ZPOSITION)"
"RTN","ZUGTM",11,0)
 D COUNT^XUSCNT(1)
"RTN","ZUGTM",12,0)
 G ^XUS
"RTN","ZUGTM",13,0)
 ;
"RTN","ZUGTM",14,0)
G ;Entry point for GUI device.
"RTN","ZUGTM",15,0)
 Q
"RTN","ZUGTM",16,0)
 ;
"RTN","ZUGTM",17,0)
ERR ;Come here on error
"RTN","ZUGTM",18,0)
 ; handle stack overflow errors specially
"RTN","ZUGTM",19,0)
 I $P($ZS,",",3)["STACKOFLOW" S $ET="Q:$ST>"_($ST-8)_"  D ERR2^ZU" Q
"RTN","ZUGTM",20,0)
 ;
"RTN","ZUGTM",21,0)
ERR2 S $ETRAP="D UNWIND^ZU" L  U $P:NOCENABLE
"RTN","ZUGTM",22,0)
 ;
"RTN","ZUGTM",23,0)
 Q:$ECODE["<PROG>"
"RTN","ZUGTM",24,0)
 I $P($ZS,",",2,3)["^XUS1A:2, %GTM-E-IOWRITERR" G HALT
"RTN","ZUGTM",25,0)
 ;
"RTN","ZUGTM",26,0)
 I $G(IO)]"",$D(IO(1,IO)),$E($G(IOST))="P" D
"RTN","ZUGTM",27,0)
 . U IO
"RTN","ZUGTM",28,0)
 . W @$S($D(IOF):IOF,1:"#")
"RTN","ZUGTM",29,0)
 I $G(IO(0))]"" D
"RTN","ZUGTM",30,0)
 . U IO(0)
"RTN","ZUGTM",31,0)
 . W !!,"RECORDING THAT AN ERROR OCCURRED ---"
"RTN","ZUGTM",32,0)
 . W !!?15,"Sorry 'bout that"
"RTN","ZUGTM",33,0)
 . W !,*7
"RTN","ZUGTM",34,0)
 . W !?10,"$STACK=",$STACK,"  $ECODE=",$ECODE
"RTN","ZUGTM",35,0)
 . W !?10,"$ZSTATUS=",$ZSTATUS
"RTN","ZUGTM",36,0)
 ;
"RTN","ZUGTM",37,0)
 D ^%ZTER K %ZT S XUERF="" ; Capture symbol table first!
"RTN","ZUGTM",38,0)
 ;
"RTN","ZUGTM",39,0)
 I $G(DUZ)'>0 G HALT
"RTN","ZUGTM",40,0)
 ;
"RTN","ZUGTM",41,0)
CTRLC I $D(IO)=11 U IO(0) C:IO'=IO(0) IO S IO=IO(0)
"RTN","ZUGTM",42,0)
 W:$P($ZS,",",3)["-CTRLC" !,"--Interrupt Acknowledged",!
"RTN","ZUGTM",43,0)
 D KILL1^XUSCLEAN ;Clean up symbol table
"RTN","ZUGTM",44,0)
 S $ECODE=",<<POP>>,"
"RTN","ZUGTM",45,0)
 Q
"RTN","ZUGTM",46,0)
 ;
"RTN","ZUGTM",47,0)
UNWIND ;Unwind the stack
"RTN","ZUGTM",48,0)
 Q:$ESTACK>1  G CONT:$ECODE["<<HALT>>",CTRLC2:$ECODE["<<POP>>"
"RTN","ZUGTM",49,0)
 S $ECODE=""
"RTN","ZUGTM",50,0)
 Q
"RTN","ZUGTM",51,0)
 ;
"RTN","ZUGTM",52,0)
CTRLC2 S $ECODE="" G:$G(^XUTL("XQ",$J,"T"))<2 ^XUSCLEAN
"RTN","ZUGTM",53,0)
 S ^XUTL("XQ",$J,"T")=1,XQY=$G(^(1)),XQY0=$P(XQY,"^",2,99)
"RTN","ZUGTM",54,0)
 G:$P(XQY0,"^",4)'="M" CTRLC2
"RTN","ZUGTM",55,0)
 S XQPSM=$P(XQY,"^",1),XQY=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3)
"RTN","ZUGTM",56,0)
 G:'XQY ^XUSCLEAN
"RTN","ZUGTM",57,0)
 S $ECODE="",$ETRAP="D ERR^ZU Q:$QUIT 0 Q"
"RTN","ZUGTM",58,0)
 U $P:NOESCAPE G M1^XQ
"RTN","ZUGTM",59,0)
 ;
"RTN","ZUGTM",60,0)
HALT I $D(^XUTL("XQ",$J)) D:$G(DUZ)>0 BYE^XUSCLEAN
"RTN","ZUGTM",61,0)
 D COUNT^XUSCNT(-1)
"RTN","ZUGTM",62,0)
 I '$ESTACK G CONT
"RTN","ZUGTM",63,0)
 S $ETRAP="D UNWIND^ZU" ;Set new trap
"RTN","ZUGTM",64,0)
 S $ECODE=",<<HALT>>," ;Cause error to unwind stack
"RTN","ZUGTM",65,0)
 D:+$G(^%ZTSCH("LOGRSRC")) LOGRSRC^%ZOSV("$LOGOUT$")
"RTN","ZUGTM",66,0)
 Q
"RTN","ZUGTM",67,0)
CONT ;
"RTN","ZUGTM",68,0)
 S $ECODE="",$ETRAP=""
"RTN","ZUGTM",69,0)
 D:+$G(^%ZTSCH("LOGRSRC")) LOGRSRC^%ZOSV("$LOGOUT$")
"RTN","ZUGTM",70,0)
 I $D(XQXFLG("HALT")) HALT
"RTN","ZUGTM",71,0)
 I ($PRINCIPAL["_TNA") HALT  ;Check for TelNet
"RTN","ZUGTM",72,0)
 S X="Waiting "_($J#1000000) D SETENV^%ZOSV ;Change VMS name
"RTN","ZUGTM",73,0)
 ;For sites that want to retain the connection, uncomment the next line
"RTN","ZUGTM",74,0)
 ;U $P:NOCENABLE R !,"Enter return to continue: ",X:600 S:'$T X="^" G:X'="^" ^ZU
"RTN","ZUGTM",75,0)
 HALT
"RTN","ZUGTM",76,0)
 ;
"RTN","ZUGTM",77,0)
JOBEXAM(%ZPOS) ;
"RTN","ZUGTM",78,0)
 N %reference S %reference=$REFERENCE
"RTN","ZUGTM",79,0)
 S ^XUTL("XUSYS",$J,0)=$H,^XUTL("XUSYS",$J,"INTERRUPT")=$G(%ZPOS)
"RTN","ZUGTM",80,0)
 I %ZPOS["^" S ^XUTL("XUSYS",$J,"codeline")=$T(@%ZPOS)
"RTN","ZUGTM",81,0)
 K ^XUTL("XUSYS",$J,"JE")
"RTN","ZUGTM",82,0)
 I $G(^XUTL("XUSYS","COMMAND"))'="EXAM" ZSHOW "SD":^XUTL("XUSYS",$J,"JE")
"RTN","ZUGTM",83,0)
 I $G(^XUTL("XUSYS","COMMAND"))="EXAM" ZSHOW "*":^XUTL("XUSYS",$J,"JE")
"RTN","ZUGTM",84,0)
 I $G(^XUTL("XUSYS",$J,"CMD"))="HALT" ;To do.
"RTN","ZUGTM",85,0)
 Q 1
"RTN","ZUGTM",86,0)
 ;
"RTN","ZUSET")
0^20^B1836388
"RTN","ZUSET",1,0)
ZUSET ;ISF/RWF - Used to rename the correct routine to ZU ;06/03/2002  14:30
"RTN","ZUSET",2,0)
 ;;8.0;KERNEL;**162,170,225,275**;Jul 10, 1995
"RTN","ZUSET",3,0)
 N RTN
"RTN","ZUSET",4,0)
 W !,"This routine will rename the correct routine to ZU for you."
"RTN","ZUSET",5,0)
 S RTN=$$CHK() I '$L(RTN) W !,"Don't know what to do." Q
"RTN","ZUSET",6,0)
 W !!,"Rename ",RTN," to ZU, OK? No//" R X:$G(DTIME,60) S:'$L(X) X="N"
"RTN","ZUSET",7,0)
 I "yY"'[$E(X) D BMES^XPDUTL("No routine renamed") Q
"RTN","ZUSET",8,0)
 D DO(RTN),BMES^XPDUTL("Routine "_RTN_" was renamed to ZU")
"RTN","ZUSET",9,0)
 Q
"RTN","ZUSET",10,0)
CHK() ;Check what routine to use
"RTN","ZUSET",11,0)
 N % S %=^%ZOSF("OS")
"RTN","ZUSET",12,0)
 I %["DSM" Q "ZUVXD"
"RTN","ZUSET",13,0)
 I %["OpenM" Q "ZUONT"
"RTN","ZUSET",14,0)
 I %["MSM" Q "ZUMSM"
"RTN","ZUSET",15,0)
 I %["GT.M" Q "ZUGTM"
"RTN","ZUSET",16,0)
 Q ""
"RTN","ZUSET",17,0)
DO(%) ;Do the rename
"RTN","ZUSET",18,0)
 N DIF,XCNT,X
"RTN","ZUSET",19,0)
 K ^TMP($J)
"RTN","ZUSET",20,0)
 S DIF="^TMP($J,",XCNP=0,X=% X ^%ZOSF("LOAD")
"RTN","ZUSET",21,0)
 S DIE="^TMP($J,",XCN=0,X="ZU" X ^%ZOSF("SAVE")
"RTN","ZUSET",22,0)
 K ^TMP($J)
"RTN","ZUSET",23,0)
 Q
"RTN","ZUSET",24,0)
POST ;Called as a post init
"RTN","ZUSET",25,0)
 N RTN S RTN=$$CHK()
"RTN","ZUSET",26,0)
 I '$L(RTN) D BMES^XPDUTL("No routine renamed") Q
"RTN","ZUSET",27,0)
 D DO(RTN),BMES^XPDUTL("Routine "_RTN_" was renamed to ZU")
"RTN","ZUSET",28,0)
 Q
"SEC","^DD",9.8,9.8,7.4,8.5)
#
"SEC","^DD",9.8,9.8,7.4,9)
#
"VER")
8.0^22.0
"^DD",9.8,9.8,7.3,0)
PATCH LIST AT CHECKSUM TIME^F^^4;3^K:$L(X)>200!($L(X)<2) X
"^DD",9.8,9.8,7.3,3)
Answer must be 2-200 characters in length.
"^DD",9.8,9.8,7.3,21,0)
^^2^2^3021217^
"^DD",9.8,9.8,7.3,21,1,0)
This field holds the patch list from the second line of the routine at the
"^DD",9.8,9.8,7.3,21,2,0)
time the checksum was updated by the XTRUTL routine.
"^DD",9.8,9.8,7.3,21,3,0)
in new code on the fly.
"^DD",9.8,9.8,7.3,"DT")
3021217
"^DD",9.8,9.8,7.4,0)
KIDS INSTALL DATE^D^^4.1;1^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",9.8,9.8,7.4,3)

"^DD",9.8,9.8,7.4,21,0)
^^3^3^3021217^
"^DD",9.8,9.8,7.4,21,1,0)
This field will be updated by KIDS when a package is installed. 
"^DD",9.8,9.8,7.4,21,2,0)
 
"^DD",9.8,9.8,7.4,21,3,0)
 
"^DD",9.8,9.8,7.4,"DT")
3021217
"^DD",14.4,14.4,33,0)
Hop Count^NJ2,0^^.02;3^K:+X'=X!(X>99)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.4,14.4,33,3)
Type a Number between 0 and 99, 0 Decimal Digits
"^DD",14.4,14.4,33,21,0)
^^5^5^3030123^
"^DD",14.4,14.4,33,21,1,0)
This field is used by Taskmanager to keep track of the number of times that 
"^DD",14.4,14.4,33,21,2,0)
a task is moved to a new system trying to start it.
"^DD",14.4,14.4,33,21,3,0)
After 3 hops taskman will reject the task.  This will help keep it from 
"^DD",14.4,14.4,33,21,4,0)
filling up a disk.
"^DD",14.4,14.4,33,21,5,0)

"^DD",14.4,14.4,33,"DT")
3030123
"^DD",14.4,14.4,54,0)
Job^NJ9,0^^.1;4^K:+X'=X!(X>999999999)!(X<0)!(X?.E1"."1N.N) X
"^DD",14.4,14.4,54,3)
Type a Number between 0 and 999999999, 0 Decimal Digits
"^DD",14.4,14.4,54,21,0)
^^2^2^3030123^
"^DD",14.4,14.4,54,21,1,0)
This field holds the $JOB value for the process that ran the task.
"^DD",14.4,14.4,54,21,2,0)

"^DD",14.4,14.4,54,"DT")
3030123
**END**
**END**
