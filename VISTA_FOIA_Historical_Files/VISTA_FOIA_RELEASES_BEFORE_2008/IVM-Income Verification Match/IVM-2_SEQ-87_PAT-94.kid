Released IVM*2*94 SEQ #87
Extracted from mail message
**KIDS**:IVM*2.0*94^

**INSTALL NAME**
IVM*2.0*94
"BLD",5392,0)
IVM*2.0*94^INCOME VERIFICATION MATCH^0^3050105^y
"BLD",5392,4,0)
^9.64PA^^
"BLD",5392,"INID")
n^n^n
"BLD",5392,"KRN",0)
^9.67PA^8989.52^19
"BLD",5392,"KRN",.4,0)
.4
"BLD",5392,"KRN",.401,0)
.401
"BLD",5392,"KRN",.402,0)
.402
"BLD",5392,"KRN",.403,0)
.403
"BLD",5392,"KRN",.5,0)
.5
"BLD",5392,"KRN",.84,0)
.84
"BLD",5392,"KRN",3.6,0)
3.6
"BLD",5392,"KRN",3.8,0)
3.8
"BLD",5392,"KRN",9.2,0)
9.2
"BLD",5392,"KRN",9.8,0)
9.8
"BLD",5392,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",5392,"KRN",9.8,"NM",1,0)
IVMLINS^^0^B20978402
"BLD",5392,"KRN",9.8,"NM",2,0)
IVMPINS^^0^B2768606
"BLD",5392,"KRN",9.8,"NM",3,0)
IVMUFNC^^0^B32620541
"BLD",5392,"KRN",9.8,"NM",4,0)
IVMLINS1^^0^B27648745
"BLD",5392,"KRN",9.8,"NM","B","IVMLINS",1)

"BLD",5392,"KRN",9.8,"NM","B","IVMLINS1",4)

"BLD",5392,"KRN",9.8,"NM","B","IVMPINS",2)

"BLD",5392,"KRN",9.8,"NM","B","IVMUFNC",3)

"BLD",5392,"KRN",19,0)
19
"BLD",5392,"KRN",19.1,0)
19.1
"BLD",5392,"KRN",101,0)
101
"BLD",5392,"KRN",409.61,0)
409.61
"BLD",5392,"KRN",771,0)
771
"BLD",5392,"KRN",870,0)
870
"BLD",5392,"KRN",8989.51,0)
8989.51
"BLD",5392,"KRN",8989.52,0)
8989.52
"BLD",5392,"KRN",8994,0)
8994
"BLD",5392,"KRN","B",.4,.4)

"BLD",5392,"KRN","B",.401,.401)

"BLD",5392,"KRN","B",.402,.402)

"BLD",5392,"KRN","B",.403,.403)

"BLD",5392,"KRN","B",.5,.5)

"BLD",5392,"KRN","B",.84,.84)

"BLD",5392,"KRN","B",3.6,3.6)

"BLD",5392,"KRN","B",3.8,3.8)

"BLD",5392,"KRN","B",9.2,9.2)

"BLD",5392,"KRN","B",9.8,9.8)

"BLD",5392,"KRN","B",19,19)

"BLD",5392,"KRN","B",19.1,19.1)

"BLD",5392,"KRN","B",101,101)

"BLD",5392,"KRN","B",409.61,409.61)

"BLD",5392,"KRN","B",771,771)

"BLD",5392,"KRN","B",870,870)

"BLD",5392,"KRN","B",8989.51,8989.51)

"BLD",5392,"KRN","B",8989.52,8989.52)

"BLD",5392,"KRN","B",8994,8994)

"BLD",5392,"QUES",0)
^9.62^^
"BLD",5392,"REQB",0)
^9.611^6^5
"BLD",5392,"REQB",1,0)
IVM*2.0*9^2
"BLD",5392,"REQB",2,0)
IVM*2.0*14^2
"BLD",5392,"REQB",4,0)
IB*2.0*267^2
"BLD",5392,"REQB",5,0)
IVM*2.0*95^2
"BLD",5392,"REQB",6,0)
DG*5.3*570^2
"BLD",5392,"REQB","B","DG*5.3*570",6)

"BLD",5392,"REQB","B","IB*2.0*267",4)

"BLD",5392,"REQB","B","IVM*2.0*14",2)

"BLD",5392,"REQB","B","IVM*2.0*9",1)

"BLD",5392,"REQB","B","IVM*2.0*95",5)

"MBREQ")
0
"PKG",120,-1)
1^1
"PKG",120,0)
INCOME VERIFICATION MATCH^IVM^IVM Software for interface with the IVM Center
"PKG",120,20,0)
^9.402P^^
"PKG",120,22,0)
^9.49I^1^1
"PKG",120,22,1,0)
2.0^2941021^2960823
"PKG",120,22,1,"PAH",1,0)
94^3050105
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","IVMLINS")
0^1^B20978402
"RTN","IVMLINS",1,0)
IVMLINS ;ALB/KCL,PHH - IVM INSURANCE UPLOAD ; 14-JAN-94
"RTN","IVMLINS",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**14,94**; 21-OCT-94
"RTN","IVMLINS",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMLINS",4,0)
 ;
"RTN","IVMLINS",5,0)
 ;
"RTN","IVMLINS",6,0)
EN ; - main entry point for IVM INSURANCE UPLOAD
"RTN","IVMLINS",7,0)
 D BLD
"RTN","IVMLINS",8,0)
 ;
"RTN","IVMLINS",9,0)
 ; - if no patients in ASEG x-ref goto EXIT
"RTN","IVMLINS",10,0)
 I IVMCTR=0 G EXIT
"RTN","IVMLINS",11,0)
 ;
"RTN","IVMLINS",12,0)
 S IVMINSUP=1
"RTN","IVMLINS",13,0)
 ;
"RTN","IVMLINS",14,0)
 ; - call list manager
"RTN","IVMLINS",15,0)
 D EN^VALM("IVM INSURANCE UPLOAD")
"RTN","IVMLINS",16,0)
 ;
"RTN","IVMLINS",17,0)
 K IVMINSUP
"RTN","IVMLINS",18,0)
 Q
"RTN","IVMLINS",19,0)
 ;
"RTN","IVMLINS",20,0)
 ;
"RTN","IVMLINS",21,0)
BLD ; - build an array of patients with uploadable insurance data
"RTN","IVMLINS",22,0)
 K ^TMP("IVMIUPL",$J)
"RTN","IVMLINS",23,0)
 W !,"Building patient list for display..."
"RTN","IVMLINS",24,0)
 ;
"RTN","IVMLINS",25,0)
 ; - change (HLFS) if HL7 segment sep ever changes!
"RTN","IVMLINS",26,0)
 S IVMCTR=0,HLFS="^"
"RTN","IVMLINS",27,0)
 ;
"RTN","IVMLINS",28,0)
 ; - get records from ASEG x-ref
"RTN","IVMLINS",29,0)
 S IVMI=0 F  S IVMI=$O(^IVM(301.5,"ASEG","IN1",IVMI)) Q:'IVMI  D
"RTN","IVMLINS",30,0)
 .S IVMJ=0 F  S IVMJ=$O(^IVM(301.5,"ASEG","IN1",IVMI,IVMJ)) Q:'IVMJ  D
"RTN","IVMLINS",31,0)
 ..;
"RTN","IVMLINS",32,0)
 ..S IVMCTR=IVMCTR+1 W:'(IVMCTR#15) "."
"RTN","IVMLINS",33,0)
 ..;
"RTN","IVMLINS",34,0)
 ..; - get node from IVM Patient (#301.5) file
"RTN","IVMLINS",35,0)
 ..S IVM0NOD=$G(^IVM(301.5,IVMI,0)) I IVM0NOD']"" Q
"RTN","IVMLINS",36,0)
 ..S DFN=+IVM0NOD
"RTN","IVMLINS",37,0)
 ..;
"RTN","IVMLINS",38,0)
 ..; - get HL7 segment string from (#301.511) sub-file
"RTN","IVMLINS",39,0)
 ..S IVMSEG=$G(^IVM(301.5,IVMI,"IN",IVMJ,"ST")) I IVMSEG']"" Q
"RTN","IVMLINS",40,0)
 ..S:$D(^IVM(301.5,IVMI,"IN",IVMJ,"ST1")) IVMSEG=IVMSEG_$G(^IVM(301.5,IVMI,"IN",IVMJ,"ST1"))
"RTN","IVMLINS",41,0)
 ..;
"RTN","IVMLINS",42,0)
 ..; - check for zeroth node Patient (#2) file
"RTN","IVMLINS",43,0)
 ..I $G(^DPT(+DFN,0))']"" Q
"RTN","IVMLINS",44,0)
 ..;
"RTN","IVMLINS",45,0)
 ..; - get patient name and ssn
"RTN","IVMLINS",46,0)
 ..S IVMNAME=$P($$PT^IVMUFNC4(DFN),"^"),IVMSSN=$P($$PT^IVMUFNC4(DFN),"^",2)
"RTN","IVMLINS",47,0)
 ..;
"RTN","IVMLINS",48,0)
 ..; - check for date of death from IVM
"RTN","IVMLINS",49,0)
 ..S IVMDOD=$S($P($P($G(^IVM(301.5,IVMI,"IN",IVMJ,0)),"^",7),"/",2)]"":$P($P($G(^IVM(301.5,IVMI,"IN",IVMJ,0)),"^",7),"/",2),1:"")
"RTN","IVMLINS",50,0)
 ..;
"RTN","IVMLINS",51,0)
 ..; - check if patient has active insurance
"RTN","IVMLINS",52,0)
 ..S IVMINS=$$INSUR^IBBAPI(DFN,DT),IVMINS=$S(IVMINS=1:"YES",1:"NO")
"RTN","IVMLINS",53,0)
 ..;
"RTN","IVMLINS",54,0)
 ..; - build line for list manager display
"RTN","IVMLINS",55,0)
 ..D BLDLINE
"RTN","IVMLINS",56,0)
 ;
"RTN","IVMLINS",57,0)
 I IVMCTR=0 W !!,"There is no IVM insurance data to be uploaded at this time.",!,*7
"RTN","IVMLINS",58,0)
 ;
"RTN","IVMLINS",59,0)
BLDQ ; - clean up variables
"RTN","IVMLINS",60,0)
 K DFN,IVM0NOD,IVMDOD,IVMINS,IVMNAME,IVMREC,IVMSEG,IVMSSN
"RTN","IVMLINS",61,0)
 Q
"RTN","IVMLINS",62,0)
 ;
"RTN","IVMLINS",63,0)
 ;
"RTN","IVMLINS",64,0)
BLDLINE ; - build storage array with data for list manager (called from BLD)
"RTN","IVMLINS",65,0)
 S ^TMP("IVMIUPL",$J,IVMNAME,IVMI,IVMJ)=DFN_"^"_IVMSSN_"^"_IVMINS_"^"_$P(IVMSEG,HLFS,4)_"^"_$P(IVMSEG,HLFS,36)_"^"_IVMDOD
"RTN","IVMLINS",66,0)
 ;
"RTN","IVMLINS",67,0)
 ; ^tmp("ivmiupl",$j,pat name, ivm ien, ivm sub ien)=dfn^ssn^active insurance^ins company^subscriber id^ivm date of death
"RTN","IVMLINS",68,0)
 Q
"RTN","IVMLINS",69,0)
 ;
"RTN","IVMLINS",70,0)
 ;
"RTN","IVMLINS",71,0)
HDR ; - header code for list manager display
"RTN","IVMLINS",72,0)
 S VALMHDR(1)="HEC has identified insurance for the following patients:"
"RTN","IVMLINS",73,0)
 S VALMHDR(2)="   (*) - Indicates Death Reported  Act"
"RTN","IVMLINS",74,0)
 Q
"RTN","IVMLINS",75,0)
 ;
"RTN","IVMLINS",76,0)
 ;
"RTN","IVMLINS",77,0)
INIT ; - init variables and list array
"RTN","IVMLINS",78,0)
 K ^TMP("IVMLST",$J)
"RTN","IVMLINS",79,0)
 ;
"RTN","IVMLINS",80,0)
 ; - set up blank line for padding display fields and init counter
"RTN","IVMLINS",81,0)
 S IVMBL="",$P(IVMBL," ",40)="",IVMCTR=0
"RTN","IVMLINS",82,0)
 ;
"RTN","IVMLINS",83,0)
 S IVMNAME="" F  S IVMNAME=$O(^TMP("IVMIUPL",$J,IVMNAME)) Q:IVMNAME']""  S IVMI1="" D
"RTN","IVMLINS",84,0)
 .F  S IVMI1=$O(^TMP("IVMIUPL",$J,IVMNAME,IVMI1)) Q:'IVMI1  S IVMJ1="" D
"RTN","IVMLINS",85,0)
 ..F  S IVMJ1=$O(^TMP("IVMIUPL",$J,IVMNAME,IVMI1,IVMJ1)) Q:'IVMJ1  D
"RTN","IVMLINS",86,0)
 ...;
"RTN","IVMLINS",87,0)
 ...; - node from the data storage array
"RTN","IVMLINS",88,0)
 ...S IVMLN=$G(^TMP("IVMIUPL",$J,IVMNAME,IVMI1,IVMJ1))
"RTN","IVMLINS",89,0)
 ...;
"RTN","IVMLINS",90,0)
 ...S IVMSTAR=$S($P(IVMLN,"^",6)]"":"*",$P($G(^DPT(+$P(IVMLN,"^"),.35)),"^")]"":"*",1:" ")
"RTN","IVMLINS",91,0)
 ...;
"RTN","IVMLINS",92,0)
 ...; - line for display
"RTN","IVMLINS",93,0)
 ...S DFN=$P(IVMLN,"^"),IVMLN=$E(IVMNAME,1,25)_"^"_$P(IVMLN,"^",2,99)
"RTN","IVMLINS",94,0)
 ...;
"RTN","IVMLINS",95,0)
 ...; - increment counter and write line
"RTN","IVMLINS",96,0)
 ...S IVMCTR=IVMCTR+1 D WRLN(IVMLN,IVMCTR)
"RTN","IVMLINS",97,0)
 ...;
"RTN","IVMLINS",98,0)
 ...; - create index array for look up
"RTN","IVMLINS",99,0)
 ...S ^TMP("IVMLST",$J,"IDX",IVMCTR,IVMCTR)=IVMNAME_"^"_$P(IVMLN,"^",2)_"^"_IVMI1_"^"_IVMJ1
"RTN","IVMLINS",100,0)
 ...; ^tmp("ivmlst",$j,"idx",counter,counter)=pat name^pat ssn^ien (#301.5) file^ien (#301.501) sub file
"RTN","IVMLINS",101,0)
 ;
"RTN","IVMLINS",102,0)
 ; - VALMCNT as the number of lines in the list
"RTN","IVMLINS",103,0)
 S VALMCNT=IVMCTR
"RTN","IVMLINS",104,0)
 ;
"RTN","IVMLINS",105,0)
INTQ ; - clean up variables
"RTN","IVMLINS",106,0)
 K DFN,IVMBL,IVMCTR,IVMI,IVMI1,IVMJ,IVMJ1,IVMLN,IVMNAME,IVMSSN,IVMSTAR,LINE,NUMBER
"RTN","IVMLINS",107,0)
 Q
"RTN","IVMLINS",108,0)
 ;
"RTN","IVMLINS",109,0)
 ;
"RTN","IVMLINS",110,0)
WRLN(LINE,NUMBER) ; - write line out for list manager display
"RTN","IVMLINS",111,0)
 ;
"RTN","IVMLINS",112,0)
 ;  Input:    LINE  --  as pat name^pat ssn^active ins^ins carrier^subscriber id
"RTN","IVMLINS",113,0)
 ;          NUMBER  --  as line number
"RTN","IVMLINS",114,0)
 ;
"RTN","IVMLINS",115,0)
 ; Output:  None
"RTN","IVMLINS",116,0)
 ;
"RTN","IVMLINS",117,0)
 N IVMLN
"RTN","IVMLINS",118,0)
 S IVMLN=$E(IVMSTAR_$P(LINE,"^",1)_IVMBL,1,16)_"  "_$E($P(LINE,"^",2)_IVMBL,1,11)_"  "_$E($P(LINE,"^",3)_IVMBL,1,3)_"  "_$E($P(LINE,"^",4)_IVMBL,1,24)_"  "_$P(LINE,"^",5)
"RTN","IVMLINS",119,0)
 S @VALMAR@(NUMBER,0)=$E(NUMBER_"     ",1,4)_IVMLN
"RTN","IVMLINS",120,0)
 Q
"RTN","IVMLINS",121,0)
 ;
"RTN","IVMLINS",122,0)
 ;
"RTN","IVMLINS",123,0)
HELP ; - help code
"RTN","IVMLINS",124,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","IVMLINS",125,0)
 Q
"RTN","IVMLINS",126,0)
 ;
"RTN","IVMLINS",127,0)
 ;
"RTN","IVMLINS",128,0)
EXIT ; - exit code
"RTN","IVMLINS",129,0)
 K ^TMP("IVMLST",$J),^TMP("IVMIUPL",$J)
"RTN","IVMLINS",130,0)
 Q
"RTN","IVMLINS1")
0^4^B27648745
"RTN","IVMLINS1",1,0)
IVMLINS1 ;ALB/KCL - IVM INSURANCE DISPLAY POLICY ; 01-FEB-94
"RTN","IVMLINS1",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**14,94**; 21-OCT-94
"RTN","IVMLINS1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMLINS1",4,0)
 ;
"RTN","IVMLINS1",5,0)
 ;
"RTN","IVMLINS1",6,0)
DE ; - select patient for insurance information upload/purge
"RTN","IVMLINS1",7,0)
 ;
"RTN","IVMLINS1",8,0)
 ;  Input:   - ^TMP("IVMLST",$J,"IDX",CTR,CTR)=pat name_pat ssn_ivm ien_ivm sub ien
"RTN","IVMLINS1",9,0)
 ;
"RTN","IVMLINS1",10,0)
 ;
"RTN","IVMLINS1",11,0)
 ;
"RTN","IVMLINS1",12,0)
 S IVMDONE=0
"RTN","IVMLINS1",13,0)
 ;
"RTN","IVMLINS1",14,0)
 ; - generic seletor used within a list manager action call
"RTN","IVMLINS1",15,0)
 D EN^VALM2($G(XQORNOD(0)),"S")
"RTN","IVMLINS1",16,0)
 Q:'$D(VALMY)
"RTN","IVMLINS1",17,0)
 S IVMENT=0 F  S IVMENT=$O(VALMY(IVMENT)) Q:'IVMENT  D
"RTN","IVMLINS1",18,0)
 .;
"RTN","IVMLINS1",19,0)
 .; - get index for look-up
"RTN","IVMLINS1",20,0)
 .S IVMIDX=$G(^TMP("IVMLST",$J,"IDX",IVMENT,IVMENT)) I IVMIDX']"" Q
"RTN","IVMLINS1",21,0)
 .;
"RTN","IVMLINS1",22,0)
 .; - change if HL7 segment sep ever changes!
"RTN","IVMLINS1",23,0)
 .S HLFS="^",HLECH="~"
"RTN","IVMLINS1",24,0)
 .;
"RTN","IVMLINS1",25,0)
 .; - get patient name, ssn, da(1), da
"RTN","IVMLINS1",26,0)
 .S IVMNAME=$P(IVMIDX,"^",1),IVMSSN=$P(IVMIDX,"^",2),IVMI=$P(IVMIDX,"^",3),IVMJ=$P(IVMIDX,"^",4)
"RTN","IVMLINS1",27,0)
 .;
"RTN","IVMLINS1",28,0)
 .; - get data node from list manager storage array
"RTN","IVMLINS1",29,0)
 .S IVMDND=$G(^TMP("IVMIUPL",$J,IVMNAME,IVMI,IVMJ)),DFN=$P(IVMDND,"^",1)
"RTN","IVMLINS1",30,0)
 .;
"RTN","IVMLINS1",31,0)
 .; - get IN1 segment from (#301.5) file containing insurance data
"RTN","IVMLINS1",32,0)
 .S IVMIN1=$G(^IVM(301.5,IVMI,"IN",IVMJ,"ST"))
"RTN","IVMLINS1",33,0)
 .;
"RTN","IVMLINS1",34,0)
 .; - set if IN1 segment exceeds 245 chars
"RTN","IVMLINS1",35,0)
 .S:$D(^("ST1")) IVMIN1=IVMIN1_(^("ST1"))
"RTN","IVMLINS1",36,0)
 .;
"RTN","IVMLINS1",37,0)
 .; - alert user if date of death
"RTN","IVMLINS1",38,0)
 .I $P(IVMDND,"^",6)]""!($P($G(^DPT(+DFN,.35)),"^")]"") D DOD^IVMLINS2
"RTN","IVMLINS1",39,0)
 .;
"RTN","IVMLINS1",40,0)
 .; - display all insurance currently on file in DHCP
"RTN","IVMLINS1",41,0)
 .D CLEAR^VALM1,ALL
"RTN","IVMLINS1",42,0)
 .; - display insurance information received from IVM IN1 segment
"RTN","IVMLINS1",43,0)
 .D HDR,DISP1
"RTN","IVMLINS1",44,0)
 .S DIR(0)="E",DIR("A")="Press RETURN to continue or '^' to return to display screen" D ^DIR K DIR Q:'Y
"RTN","IVMLINS1",45,0)
 .;
"RTN","IVMLINS1",46,0)
 .; - ask user to add or purge
"RTN","IVMLINS1",47,0)
 .D ASK^IVMLINS2
"RTN","IVMLINS1",48,0)
 ;
"RTN","IVMLINS1",49,0)
DEQ ; - clean up variables
"RTN","IVMLINS1",50,0)
 D IVMQ
"RTN","IVMLINS1",51,0)
 Q
"RTN","IVMLINS1",52,0)
 ;
"RTN","IVMLINS1",53,0)
 ;
"RTN","IVMLINS1",54,0)
ALL ; - display all insurance company information for patient in DHCP
"RTN","IVMLINS1",55,0)
 ;
"RTN","IVMLINS1",56,0)
 W !,?22,"INSURANCE POLICIES CURRENTLY ON FILE"
"RTN","IVMLINS1",57,0)
 ; - write dashed line
"RTN","IVMLINS1",58,0)
 W !,?7,$TR($J("",66)," ","*")
"RTN","IVMLINS1",59,0)
 ;
"RTN","IVMLINS1",60,0)
 ; - IB call to display all DHCP ins co. information
"RTN","IVMLINS1",61,0)
 D DISP^DGIBDSP
"RTN","IVMLINS1",62,0)
 W !
"RTN","IVMLINS1",63,0)
 Q
"RTN","IVMLINS1",64,0)
 ;
"RTN","IVMLINS1",65,0)
 ;
"RTN","IVMLINS1",66,0)
HDR ; - header for insurance data received from HEC
"RTN","IVMLINS1",67,0)
 W !,?23,"INSURANCE POLICY RECEIVED FROM HEC"
"RTN","IVMLINS1",68,0)
 ; - write dashed line
"RTN","IVMLINS1",69,0)
 W !,?7,$TR($J("",66)," ","*")
"RTN","IVMLINS1",70,0)
 Q
"RTN","IVMLINS1",71,0)
 ;
"RTN","IVMLINS1",72,0)
 ;
"RTN","IVMLINS1",73,0)
DISP1 ; - display insurance fields from IN1 segment
"RTN","IVMLINS1",74,0)
 ;
"RTN","IVMLINS1",75,0)
 ; - ins effec and exp dates in FM format
"RTN","IVMLINS1",76,0)
 S IVMEFF=$$FMDATE^HLFNC($P(IVMIN1,HLFS,12)),IVMEXP=$$FMDATE^HLFNC($P(IVMIN1,HLFS,13))
"RTN","IVMLINS1",77,0)
 ;
"RTN","IVMLINS1",78,0)
 S IVMADD=$P(IVMIN1,"^",5)
"RTN","IVMLINS1",79,0)
 S IVMPLAN=$P(IVMIN1,HLFS,15),IVMPLAN=$P($G(^IBE(355.1,+IVMPLAN,0)),"^")
"RTN","IVMLINS1",80,0)
 ;
"RTN","IVMLINS1",81,0)
 ; - display insurance policy fields from IVM
"RTN","IVMLINS1",82,0)
 W !,?2,"Company: ",?9,$E($P(IVMIN1,HLFS,4),1,32),?45,"Effective Date: ",?62,$$DAT2^IVMUFNC4(IVMEFF)
"RTN","IVMLINS1",83,0)
 W !,?2,"Phone #: ",?9,$E($P(IVMIN1,HLFS,7),1,25),?45,"Expiration Date: ",?62,$$DAT2^IVMUFNC4(IVMEXP)
"RTN","IVMLINS1",84,0)
 W !,?2,"Address: ",?45,"Subscriber ID: " W:$P(IVMIN1,HLFS,36)]"" ?59,$E($P(IVMIN1,HLFS,36),1,20) W !
"RTN","IVMLINS1",85,0)
 W:$P(IVMADD,HLECH,1)]"" ?4,$E($P(IVMADD,HLECH,1),1,35) W ?45,"Policy Holder: " W:$P(IVMIN1,HLFS,17)]"" ?59,$S($P(IVMIN1,HLFS,17)="v":"SELF",$P(IVMIN1,HLFS,17)="s":"SPOUSE",1:"OTHER")
"RTN","IVMLINS1",86,0)
 W:$P(IVMADD,HLECH,1)']"" !
"RTN","IVMLINS1",87,0)
 W:$P(IVMADD,HLECH,2)]"" !,?4,$E($P(IVMADD,HLECH,2),1,35)
"RTN","IVMLINS1",88,0)
 W:$P(IVMADD,HLECH,3)]""!($P(IVMADD,HLECH,4)]"")!($P(IVMADD,HLECH,5)]"") !,?4,$P(IVMADD,HLECH,3) W:$P(IVMADD,HLECH,3)]""&($P(IVMADD,HLECH,4)]"") ", ",$E($P(IVMADD,HLECH,4),1,2)
"RTN","IVMLINS1",89,0)
 W:$P(IVMADD,HLECH,5)]""&($P(IVMADD,HLECH,3)]""!($P(IVMADD,HLECH,4)]"")) " "
"RTN","IVMLINS1",90,0)
 W $P(IVMADD,HLECH,5)
"RTN","IVMLINS1",91,0)
 I $P(IVMADD,HLECH,2)']"" D
"RTN","IVMLINS1",92,0)
 .W !,?45,"Group Name: " W:$P(IVMIN1,HLFS,9)]"" ?59,$E($P(IVMIN1,HLFS,9),1,20)
"RTN","IVMLINS1",93,0)
 W:$P(IVMADD,HLECH,2)]"" ?45,"Group Name: " W:$P(IVMADD,HLECH,2)]""&($P(IVMIN1,HLFS,9)]"") ?59,$E($P(IVMIN1,HLFS,9),1,20)
"RTN","IVMLINS1",94,0)
 W !,?45,"Group Number: " W:$P(IVMIN1,HLFS,8)]"" ?59,$E($P(IVMIN1,HLFS,8),1,20)
"RTN","IVMLINS1",95,0)
 W !,?2,"Name of Insured: " W:$P(IVMIN1,HLFS,16)]"" ?9,$E($$FMNAME^HLFNC($P(IVMIN1,HLFS,16)),1,23) W:$P(IVMIN1,HLFS,16)']"" ?9,$E(IVMNAME,1,23)
"RTN","IVMLINS1",96,0)
 W ?45,"Pre-Cert. Req?: " W:$P(IVMIN1,HLFS,28)]"" ?60,$S($P(IVMIN1,HLFS,28)=1:"YES",$P(IVMIN1,HLFS,28)=0:"NO",1:"")
"RTN","IVMLINS1",97,0)
 I $P(IVMIN1,HLFS,16)]"" S $P(IVMIN1,HLFS,16)=$$FMNAME^HLFNC($P(IVMIN1,HLFS,16))
"RTN","IVMLINS1",98,0)
 W !,?45,"Plan Type: ",?55,$E(IVMPLAN,1,23) W !
"RTN","IVMLINS1",99,0)
 Q
"RTN","IVMLINS1",100,0)
 ;
"RTN","IVMLINS1",101,0)
 ;
"RTN","IVMLINS1",102,0)
DISP2 ; - display ins co. name and address
"RTN","IVMLINS1",103,0)
 W !,?4,"Insurance Company: ",$E($P(IVMIN1,HLFS,4),1,45),!
"RTN","IVMLINS1",104,0)
 W !,?4,"Company Address:   " W:$P(IVMADD,HLECH,1)]"" ?23,$E($P(IVMADD,HLECH,1),1,35) ; address line1
"RTN","IVMLINS1",105,0)
 W:$P(IVMADD,HLECH,2)]"" !?23,$E($P(IVMADD,HLECH,2),1,35) ; address line2
"RTN","IVMLINS1",106,0)
 W:$P(IVMADD,HLECH,3)]""!($P(IVMADD,HLECH,4)]"")!($P(IVMADD,HLECH,5)]"") !?23
"RTN","IVMLINS1",107,0)
 W $P(IVMADD,HLECH,3) W:$P(IVMADD,HLECH,3)]""&($P(IVMADD,HLECH,4)]"") ", " ; city
"RTN","IVMLINS1",108,0)
 W $E($P(IVMADD,HLECH,4),1,2) ; state
"RTN","IVMLINS1",109,0)
 W:$P(IVMADD,HLECH,5)]""&($P(IVMADD,HLECH,3)]""!($P(IVMADD,HLECH,4)]"")) " "
"RTN","IVMLINS1",110,0)
 W $P(IVMADD,HLECH,5) ; zip
"RTN","IVMLINS1",111,0)
 Q
"RTN","IVMLINS1",112,0)
 ;
"RTN","IVMLINS1",113,0)
 ;
"RTN","IVMLINS1",114,0)
IVMQ ; - kill variables used from all protocols
"RTN","IVMLINS1",115,0)
 ;
"RTN","IVMLINS1",116,0)
 ; - if action completed reset List Man array for display
"RTN","IVMLINS1",117,0)
 I IVMDONE D INIT^IVMLINS
"RTN","IVMLINS1",118,0)
 ;
"RTN","IVMLINS1",119,0)
 S VALMBCK="R"
"RTN","IVMLINS1",120,0)
 K DA,DFN,IVM0NOD,IVMADD,IVMDND,IVMDONE,IVMEFF,IVMENT,IVMEXP
"RTN","IVMLINS1",121,0)
 K IVMI,IVMIDX,IVMIN1,IVMJ,IVMNAME,IVMPLAN,IVMSSN,Y
"RTN","IVMLINS1",122,0)
 Q
"RTN","IVMPINS")
0^2^B2768606
"RTN","IVMPINS",1,0)
IVMPINS ;ALB/CPM,PHH - INSURANCE EVENT DRIVER INTERFACE ; 01-MAY-94
"RTN","IVMPINS",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**9,94**; 21-OCT-94
"RTN","IVMPINS",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMPINS",4,0)
 ;
"RTN","IVMPINS",5,0)
EN ; Queue transmission if an IVM patient's insurance status changes.
"RTN","IVMPINS",6,0)
 ;  Input:  DFN -- Pointer to the patient in file #2
"RTN","IVMPINS",7,0)
 ;
"RTN","IVMPINS",8,0)
 N EVENTS
"RTN","IVMPINS",9,0)
 S EVENTS("IVM")=1
"RTN","IVMPINS",10,0)
 ;
"RTN","IVMPINS",11,0)
 I '$G(DFN) G ENQ
"RTN","IVMPINS",12,0)
 ;
"RTN","IVMPINS",13,0)
 ; - quit if invoked by the IVM insurance upload process
"RTN","IVMPINS",14,0)
 I $G(IVMINSUP) G ENQ
"RTN","IVMPINS",15,0)
 ;
"RTN","IVMPINS",16,0)
 ; - quit if the patient is not Cat C or Cat A
"RTN","IVMPINS",17,0)
 S IVMMT=$$LST^DGMTU(DFN)
"RTN","IVMPINS",18,0)
 I $P(IVMMT,"^",4)'="A",$P(IVMMT,"^",4)'="C" G ENQ
"RTN","IVMPINS",19,0)
 ;
"RTN","IVMPINS",20,0)
 ; - find the latest IVM case record, if it exists
"RTN","IVMPINS",21,0)
 S (IVMDA,IVMDT,X)=0
"RTN","IVMPINS",22,0)
 F  S X=$O(^IVM(301.5,"APT",DFN,X)) Q:'X  S IVMDT=X
"RTN","IVMPINS",23,0)
 I IVMDT S IVMDA=+$O(^IVM(301.5,"APT",DFN,IVMDT,0))
"RTN","IVMPINS",24,0)
 S IVMNEW='IVMDA
"RTN","IVMPINS",25,0)
 ;
"RTN","IVMPINS",26,0)
 ; - determine changes in insurance status
"RTN","IVMPINS",27,0)
 S IVMINSP=$$PRIOR(IVMDA)
"RTN","IVMPINS",28,0)
 S IVMINSA=$$INSUR^IBBAPI(DFN)
"RTN","IVMPINS",29,0)
 ;
"RTN","IVMPINS",30,0)
 ; - queue transmission if status has changed
"RTN","IVMPINS",31,0)
 I IVMDA,(IVMINSP&'IVMINSA)!('IVMINSP&IVMINSA=1) I $$SETSTAT^IVMPLOG(IVMDA,.EVENTS)
"RTN","IVMPINS",32,0)
 ;
"RTN","IVMPINS",33,0)
 ; - queue transmission if Cat C pt w/o a case record has no insurance
"RTN","IVMPINS",34,0)
 I 'IVMDA,'IVMINSA,$P(IVMMT,"^",4)="C" S IVMDT=$$LYR^DGMTSCU1(+$P(IVMMT,"^",2)) I $$LOG^IVMPLOG(DFN,IVMDT,.EVENTS)
"RTN","IVMPINS",35,0)
 ;
"RTN","IVMPINS",36,0)
ENQ K IVMDA,IVMDT,IVMINSA,IVMINSP,IVMMT,IVMNEW,X
"RTN","IVMPINS",37,0)
 Q
"RTN","IVMPINS",38,0)
 ;
"RTN","IVMPINS",39,0)
 ;
"RTN","IVMPINS",40,0)
PRIOR(DA) ; Find insurance status from last transmission
"RTN","IVMPINS",41,0)
 ;  Input:  DA -- Pointer to the case record in file #301.5
"RTN","IVMPINS",42,0)
 ; Output:   0 -- No active insurance at last transmission
"RTN","IVMPINS",43,0)
 ;                (or could not identify last transmission)
"RTN","IVMPINS",44,0)
 ;           1 -- Had active insurance at last transmission
"RTN","IVMPINS",45,0)
 ;
"RTN","IVMPINS",46,0)
 N X,Y S (X,Y)=0
"RTN","IVMPINS",47,0)
 I $G(DA) F  S Y=$O(^IVM(301.6,"B",DA,Y)) Q:'Y  S X=Y
"RTN","IVMPINS",48,0)
 Q $S(X:+$P($G(^IVM(301.6,X,1)),"^",2),1:0)
"RTN","IVMUFNC")
0^3^B32620541
"RTN","IVMUFNC",1,0)
IVMUFNC ;ALB/MLI/PHH/SCK - IVM GENERIC FUNCTIONS ; 10/15/2004 1:10pm
"RTN","IVMUFNC",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**3,11,17,34,95,94**;21-OCT-94
"RTN","IVMUFNC",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMUFNC",4,0)
 ;
"RTN","IVMUFNC",5,0)
 ; This routine contains generic calls for use throughout IVM
"RTN","IVMUFNC",6,0)
 ;
"RTN","IVMUFNC",7,0)
INIT(EID,HL,INT) ; initialize variables for 1.6 HL7/IVM
"RTN","IVMUFNC",8,0)
 S EID=$G(EID),INT=$G(INT)
"RTN","IVMUFNC",9,0)
 S HLDAP="IVM" D INIT^HLFNC2(EID,.HL,INT)
"RTN","IVMUFNC",10,0)
 S (HLEVN,IVMCT)=0 ; initialize segment and message counters
"RTN","IVMUFNC",11,0)
 ;;D NOW^%DTC S HLSDT=%
"RTN","IVMUFNC",12,0)
 Q
"RTN","IVMUFNC",13,0)
 ;
"RTN","IVMUFNC",14,0)
 ;
"RTN","IVMUFNC",15,0)
CLEAN ; clean-up variables for HL7/IVM (as defined by call to INIT)
"RTN","IVMUFNC",16,0)
 D KILL^HLTRANS
"RTN","IVMUFNC",17,0)
 K HLEVN,HLMTN,HLSDT,IVMCT
"RTN","IVMUFNC",18,0)
 Q
"RTN","IVMUFNC",19,0)
 ;
"RTN","IVMUFNC",20,0)
 ;
"RTN","IVMUFNC",21,0)
BATCH ; put BHS and BTS segments into TMP global
"RTN","IVMUFNC",22,0)
 ;
"RTN","IVMUFNC",23,0)
 ;  Input - HLMTN as HL7 message type being sent in this batch (REQUIRED)
"RTN","IVMUFNC",24,0)
 ;          HLEVN as number of HL7 messages in batch (REQUIRED)
"RTN","IVMUFNC",25,0)
 ;          IVMCT as subscript in TMP global where BTS segment goes (REQ)
"RTN","IVMUFNC",26,0)
 ;          HLSEC (optional) as security (see BHS^HLFNC1)
"RTN","IVMUFNC",27,0)
 ;          HLMSA (optional) as message ack variables (see BHS^HLFNC1)
"RTN","IVMUFNC",28,0)
 ;
"RTN","IVMUFNC",29,0)
 ;      ****Also assumes all HL7 variables returned from****
"RTN","IVMUFNC",30,0)
 ;          INIT^HLTRANS are defined
"RTN","IVMUFNC",31,0)
 ;
"RTN","IVMUFNC",32,0)
 Q  ; LINE ADDED FOR HL7 1.6
"RTN","IVMUFNC",33,0)
 S HLSEC=$G(HLSEC),HLMSA=$G(HLMSA)
"RTN","IVMUFNC",34,0)
 S ^TMP("HLS",$J,HLSDT,0)=$$BHS^HLFNC1(HLMTN,HLSEC,HLMSA)
"RTN","IVMUFNC",35,0)
 S ^TMP("HLS",$J,HLSDT,IVMCT)="BTS"_HLFS_HLEVN ; trailer
"RTN","IVMUFNC",36,0)
 Q
"RTN","IVMUFNC",37,0)
 ;
"RTN","IVMUFNC",38,0)
 ;
"RTN","IVMUFNC",39,0)
IVM(DFN,IVMDT) ; extrinsic function - should this pt be transmitted to IVM?
"RTN","IVMUFNC",40,0)
 ;
"RTN","IVMUFNC",41,0)
 ;  Input - DFN as internal entry number of PATIENT file
"RTN","IVMUFNC",42,0)
 ;          IVMDT as date of test (default DT)
"RTN","IVMUFNC",43,0)
 ;
"RTN","IVMUFNC",44,0)
 ; Output - 1 if pt should be sent to IVM, 0 otherwise
"RTN","IVMUFNC",45,0)
 ;
"RTN","IVMUFNC",46,0)
 N X,Y
"RTN","IVMUFNC",47,0)
 S DFN=$G(DFN) I '$D(^DPT(+DFN,0)) G IVMQ
"RTN","IVMUFNC",48,0)
 S IVMDT=$S($G(IVMDT):IVMDT,1:DT)
"RTN","IVMUFNC",49,0)
 S X=$$LST^DGMTU(DFN,IVMDT)
"RTN","IVMUFNC",50,0)
 I $E($P(X,"^",2),1,3)'=$E(IVMDT,1,3) K IVMDT G IVMQ ; not in same year
"RTN","IVMUFNC",51,0)
 S X=$G(^DGMT(408.31,+X,0)) I 'X G IVMQ ; can't find MT entry for date
"RTN","IVMUFNC",52,0)
 I $P(X,"^",3)=6 S:'$$INS(DFN,IVMDT) Y=1 G IVMQ ; C/no insurance...send
"RTN","IVMUFNC",53,0)
 I $P(X,"^",3)'=4 G IVMQ ; not cat A
"RTN","IVMUFNC",54,0)
 I ($P(X,"^",4)-$P(X,"^",15)>$P(X,"^",12))!$P(X,"^",10) G IVMQ ; income-deduct expenses>threshold (hardship) or adjudicated
"RTN","IVMUFNC",55,0)
 S Y=1
"RTN","IVMUFNC",56,0)
IVMQ Q +$G(Y)
"RTN","IVMUFNC",57,0)
 ;
"RTN","IVMUFNC",58,0)
 ;
"RTN","IVMUFNC",59,0)
INS(DFN,IVMDT) ; extrinsic function to see if pt has active insurance
"RTN","IVMUFNC",60,0)
 ;
"RTN","IVMUFNC",61,0)
 ;  Input - DFN as internal entry number of PATIENT file
"RTN","IVMUFNC",62,0)
 ;          IVMDT [optional] as date to compute ins coverage for
"RTN","IVMUFNC",63,0)
 ;
"RTN","IVMUFNC",64,0)
 ; Output - 1 if yes, 0 if no
"RTN","IVMUFNC",65,0)
 ;
"RTN","IVMUFNC",66,0)
 Q $S($$INSUR^IBBAPI(DFN,$G(IVMDT))=1:1,1:0)
"RTN","IVMUFNC",67,0)
 ;
"RTN","IVMUFNC",68,0)
 ;
"RTN","IVMUFNC",69,0)
MAIL(IVMGRP) ; Transmit to members of Mail Group. Before D MAIL^IVMUFNC()
"RTN","IVMUFNC",70,0)
 ; set XMSUB = to subject   and  set IVMTEXT array to message.
"RTN","IVMUFNC",71,0)
 ;
"RTN","IVMUFNC",72,0)
 ;Input:
"RTN","IVMUFNC",73,0)
 ;  IVMGRP - optional parameter, = to name of a mailgroup to send the
"RTN","IVMUFNC",74,0)
 ;           message to.  If not sent, the IVM Site Parameter file is
"RTN","IVMUFNC",75,0)
 ;           used to determine the mailgroup.
"RTN","IVMUFNC",76,0)
 ;
"RTN","IVMUFNC",77,0)
 N DIFROM,XMDUZ,XMTEXT,XMSTRIP,XMROU,XMY,XMZ,XMDF
"RTN","IVMUFNC",78,0)
 S XMDF=""
"RTN","IVMUFNC",79,0)
 S XMDUZ="IVM PACKAGE"
"RTN","IVMUFNC",80,0)
 S XMTEXT="IVMTEXT("
"RTN","IVMUFNC",81,0)
 I '$L($G(IVMGRP)) D
"RTN","IVMUFNC",82,0)
 .S IVMGRP=$P($G(^XMB(3.8,+$P($G(^IVM(301.9,1,0)),"^",2),0)),"^")
"RTN","IVMUFNC",83,0)
 S XMY("G."_IVMGRP_"@"_^XMB("NETNAME"))=""
"RTN","IVMUFNC",84,0)
 D ^XMD
"RTN","IVMUFNC",85,0)
 K IVMTEXT,XMDUZ,XMSUB,XMTEXT,XMY
"RTN","IVMUFNC",86,0)
 Q
"RTN","IVMUFNC",87,0)
 ;
"RTN","IVMUFNC",88,0)
 ;
"RTN","IVMUFNC",89,0)
LTD(DFN,IVMQUERY) ; Find Last Treatment Date
"RTN","IVMUFNC",90,0)
 ;  Input:       DFN -- pointer to the patient in file #2
"RTN","IVMUFNC",91,0)
 ;          IVMQUERY("LTD") -- # of the QUERY that is currently open or
"RTN","IVMUFNC",92,0)
 ;                      undefined, zero, or null if no QUERY opened for
"RTN","IVMUFNC",93,0)
 ;                      last treatment date
"RTN","IVMUFNC",94,0)
 ; Output:  LTD -- Last Treatment Date (really last date seen at
"RTN","IVMUFNC",95,0)
 ;                                      the facility)
"RTN","IVMUFNC",96,0)
 ;
"RTN","IVMUFNC",97,0)
 N LTD,SDSTOP,X,Z,IVMQ
"RTN","IVMUFNC",98,0)
 ;
"RTN","IVMUFNC",99,0)
 ; - need a patient
"RTN","IVMUFNC",100,0)
 S IVMQ=$G(IVMQUERY("LTD"))
"RTN","IVMUFNC",101,0)
 I '$G(DFN) S LTD=0 G LTDQ
"RTN","IVMUFNC",102,0)
 ;
"RTN","IVMUFNC",103,0)
 ; - if current inpatient, set LTD = today and quit
"RTN","IVMUFNC",104,0)
 I $G(^DPT(DFN,.105)) S LTD=DT G LTDQ
"RTN","IVMUFNC",105,0)
 ;
"RTN","IVMUFNC",106,0)
 ; - get the last discharge date
"RTN","IVMUFNC",107,0)
 S LTD=+$O(^DGPM("ATID3",DFN,"")) S:LTD LTD=9999999.9999999-LTD\1 S:LTD>DT LTD=DT
"RTN","IVMUFNC",108,0)
 ;
"RTN","IVMUFNC",109,0)
 ; - get the last registration date and compare to LTD
"RTN","IVMUFNC",110,0)
 S X=+$O(^DPT(DFN,"DIS",0)) I X S X=9999999-X\1 S:X>LTD LTD=X
"RTN","IVMUFNC",111,0)
 ;
"RTN","IVMUFNC",112,0)
 ; - get the last appointment or stop after LTD (if any)
"RTN","IVMUFNC",113,0)
 K ^TMP("DIERR",$J)
"RTN","IVMUFNC",114,0)
 I $G(IVMQ) D ACTIVE^SDQ(.IVMQ,"FALSE","SET") ;clear QUERY results
"RTN","IVMUFNC",115,0)
 I '$G(IVMQ) D
"RTN","IVMUFNC",116,0)
 .D OPEN^SDQ(.IVMQ) Q:'$G(IVMQ)
"RTN","IVMUFNC",117,0)
 .D INDEX^SDQ(.IVMQ,"PATIENT/DATE","SET")
"RTN","IVMUFNC",118,0)
 .D SCANCB^SDQ(.IVMQ,"I $S($P(SDOE0,U,8)=2:1,$P(SDOE0,U,8)=1:$$APPT^IVMUFNC(SDOE0),1:0) S LTD=SDOE0\1,SDSTOP=1","SET")
"RTN","IVMUFNC",119,0)
 .S IVMQUERY("LTD")=IVMQ
"RTN","IVMUFNC",120,0)
 ;
"RTN","IVMUFNC",121,0)
 D PAT^SDQ(.IVMQ,DFN,"SET")
"RTN","IVMUFNC",122,0)
 D DATE^SDQ(.IVMQ,LTD+.000001,9999999,"SET")
"RTN","IVMUFNC",123,0)
 D ACTIVE^SDQ(.IVMQ,"TRUE","SET")
"RTN","IVMUFNC",124,0)
 D SCAN^SDQ(.IVMQ,"BACKWARD")
"RTN","IVMUFNC",125,0)
 K ^TMP("DIERR",$J)
"RTN","IVMUFNC",126,0)
 ;
"RTN","IVMUFNC",127,0)
LTDQ ;
"RTN","IVMUFNC",128,0)
 Q $S(LTD:$$HLDATE^HLFNC(LTD),1:HLQ)
"RTN","IVMUFNC",129,0)
 ;
"RTN","IVMUFNC",130,0)
APPT(SDOE0) ;Determine if appt associated with encounter is in a valid state
"RTN","IVMUFNC",131,0)
 ; Quit when Outpatient Encounter STATUS is CHECKED OUT
"RTN","IVMUFNC",132,0)
 Q:$P(SDOE0,U,12)=2 1
"RTN","IVMUFNC",133,0)
 ; Quit when Outpatient Encounter STATUS is ACTION REQUIRED and the
"RTN","IVMUFNC",134,0)
 ; Appointment Status is SCHEDULED/KEPT
"RTN","IVMUFNC",135,0)
 N DGARRAY,SDCNT,SDSTAT,SDDTTM S DGARRAY("FLDS")=3,DGARRAY(4)=+$P(SDOE0,U,2)
"RTN","IVMUFNC",136,0)
 S DGARRAY(1)=$P(SDOE0,U),DGARRAY("SORT")="P",DGARRAY("MAX")=1
"RTN","IVMUFNC",137,0)
 S SDCNT=$$SDAPI^SDAMA301(.DGARRAY),SDSTAT=""
"RTN","IVMUFNC",138,0)
 I SDCNT>0 D
"RTN","IVMUFNC",139,0)
 .S SDDTTM=$O(^TMP($J,"SDAMA301",DGARRAY(4),0))
"RTN","IVMUFNC",140,0)
 .I SDDTTM S SDSTAT=$P($P($G(^TMP($J,"SDAMA301",DGARRAY(4),SDDTTM)),U,3),";")
"RTN","IVMUFNC",141,0)
 K ^TMP($J,"SDAMA301")
"RTN","IVMUFNC",142,0)
 Q:(($P(SDOE0,U,12)=14)&(SDSTAT="R")) 1
"RTN","IVMUFNC",143,0)
 Q 0
"RTN","IVMUFNC",144,0)
 ;
"RTN","IVMUFNC",145,0)
OUTTR(IVMINT,IVMPAR,IVMST) ; - Transform IVMINT to a displayable value
"RTN","IVMUFNC",146,0)
 ;  Input:   IVMINT  --  internal value of demographic element
"RTN","IVMUFNC",147,0)
 ;                       received from IVM
"RTN","IVMUFNC",148,0)
 ;           IVMPAR  --  Zeroth node of the entry in file #301.92
"RTN","IVMUFNC",149,0)
 ;                       for the demographic element IVMINT
"RTN","IVMUFNC",150,0)
 ;            IVMST  --  [optional] pointer to the STATE (#5) file
"RTN","IVMUFNC",151,0)
 ;                       Required to transform the county code
"RTN","IVMUFNC",152,0)
 ;  Output:  IVMOUT  --  Displayable value for IVMINT
"RTN","IVMUFNC",153,0)
 ;
"RTN","IVMUFNC",154,0)
 N IVMOUT,Z S IVMOUT=IVMINT
"RTN","IVMUFNC",155,0)
 I $G(IVMINT)=""!($G(IVMPAR)="") S IVMOUT="" G OUTTRQ
"RTN","IVMUFNC",156,0)
 ;
"RTN","IVMUFNC",157,0)
 ; - use special transform for county
"RTN","IVMUFNC",158,0)
 I $G(IVMST),$P(IVMPAR,"^",2)="PID12" S IVMOUT=$P($G(^DIC(5,IVMST,1,IVMINT,0)),"^")
"RTN","IVMUFNC",159,0)
 ;
"RTN","IVMUFNC",160,0)
 ; - transform the internal value if necessary
"RTN","IVMUFNC",161,0)
 I $P(IVMPAR,"^",6) S IVMOUT=$$EXPAND($P(IVMPAR,"^",4),$P(IVMPAR,"^",5),IVMINT)
"RTN","IVMUFNC",162,0)
 ;
"RTN","IVMUFNC",163,0)
OUTTRQ Q IVMOUT
"RTN","IVMUFNC",164,0)
 ;
"RTN","IVMUFNC",165,0)
 ;
"RTN","IVMUFNC",166,0)
EXPAND(FILE,FIELD,VALUE) ; - returns internal data in an output format
"RTN","IVMUFNC",167,0)
 N Y,C S Y=VALUE
"RTN","IVMUFNC",168,0)
 I 'FILE!('FIELD)!(VALUE="") G EXPQ
"RTN","IVMUFNC",169,0)
 S Y=VALUE,C=$P(^DD(FILE,FIELD,0),"^",2) D Y^DIQ
"RTN","IVMUFNC",170,0)
EXPQ Q Y
"RTN","IVMUFNC",171,0)
 ;
"RTN","IVMUFNC",172,0)
 ;
"RTN","IVMUFNC",173,0)
GETPAT(DFN,IVMPAT) ;
"RTN","IVMUFNC",174,0)
 ; Description: Used to obtain identifying information for a patient
"RTN","IVMUFNC",175,0)
 ; in the PATIENT file and place it in the IVMPAT() array.
"RTN","IVMUFNC",176,0)
 ;
"RTN","IVMUFNC",177,0)
 ;  Input:
"RTN","IVMUFNC",178,0)
 ;   DFN - ien of patient in PATIENT file
"RTN","IVMUFNC",179,0)
 ;
"RTN","IVMUFNC",180,0)
 ; Output:
"RTN","IVMUFNC",181,0)
 ;  Function Value - 1 on success, 0 on failure
"RTN","IVMUFNC",182,0)
 ;   IVMPAT - (pass by reference) On success, this array will contain
"RTN","IVMUFNC",183,0)
 ;    the patient identifing information. Array subscripts are:
"RTN","IVMUFNC",184,0)
 ;      "DFN"  - ien PATIENT file
"RTN","IVMUFNC",185,0)
 ;      "NAME" - patient name
"RTN","IVMUFNC",186,0)
 ;      "SSN"  - patient Social Security Number
"RTN","IVMUFNC",187,0)
 ;      "DOB"  - patient date of birth (FM format)
"RTN","IVMUFNC",188,0)
 ;      "SEX"  - patient sex
"RTN","IVMUFNC",189,0)
 ;
"RTN","IVMUFNC",190,0)
 N IVMNODE
"RTN","IVMUFNC",191,0)
 Q:'$G(DFN) 0
"RTN","IVMUFNC",192,0)
 K IVMPAT S IVMPAT=""
"RTN","IVMUFNC",193,0)
 ;
"RTN","IVMUFNC",194,0)
 ; obtain patient record
"RTN","IVMUFNC",195,0)
 S IVMNODE=$G(^DPT(DFN,0))
"RTN","IVMUFNC",196,0)
 Q:IVMNODE="" 0
"RTN","IVMUFNC",197,0)
 ;
"RTN","IVMUFNC",198,0)
 S IVMPAT("DFN")=DFN
"RTN","IVMUFNC",199,0)
 S IVMPAT("NAME")=$P(IVMNODE,"^")
"RTN","IVMUFNC",200,0)
 S IVMPAT("SEX")=$P(IVMNODE,"^",2)
"RTN","IVMUFNC",201,0)
 S IVMPAT("DOB")=$P(IVMNODE,"^",3)
"RTN","IVMUFNC",202,0)
 S IVMPAT("SSN")=$P(IVMNODE,"^",9)
"RTN","IVMUFNC",203,0)
 Q 1
"RTN","IVMUFNC",204,0)
 ;
"RTN","IVMUFNC",205,0)
LOOKUP(SSN,DOB,SEX,ERROR) ;
"RTN","IVMUFNC",206,0)
 ;Description: This function will do a search for the patient based on
"RTN","IVMUFNC",207,0)
 ;the identifying information provided. The function will be successful
"RTN","IVMUFNC",208,0)
 ;only if a single patient is found matching the identifiers provided.
"RTN","IVMUFNC",209,0)
 ;
"RTN","IVMUFNC",210,0)
 ;Inputs:
"RTN","IVMUFNC",211,0)
 ;  SSN - patient Social Security Number
"RTN","IVMUFNC",212,0)
 ;  DOB - patient date of birth (FM format)
"RTN","IVMUFNC",213,0)
 ;  SEX - patient sex
"RTN","IVMUFNC",214,0)
 ;Outputs:
"RTN","IVMUFNC",215,0)
 ;  Function Value - patient DFN if successful, 0 otherwise
"RTN","IVMUFNC",216,0)
 ;  ERROR - if unsuccessful, an error message is returned (optional, pass by reference)
"RTN","IVMUFNC",217,0)
 ;
"RTN","IVMUFNC",218,0)
 N DFN,NODE
"RTN","IVMUFNC",219,0)
 ;
"RTN","IVMUFNC",220,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","IVMUFNC",221,0)
 I 'DFN S ERROR="SSN NOT FOUND" Q 0
"RTN","IVMUFNC",222,0)
 I $O(^DPT("SSN",SSN,DFN)) S ERROR="MULTIPLE PATIENTS MATCHING SSN" Q 0
"RTN","IVMUFNC",223,0)
 S NODE=$G(^DPT(DFN,0))
"RTN","IVMUFNC",224,0)
 I $P(NODE,"^",2)'=SEX S ERROR="SEX DOES NOT MATCH" Q 0
"RTN","IVMUFNC",225,0)
 I $E($P(NODE,"^",3),1,3)'=$E(DOB,1,3) S ERROR="DOB DOES NOT MATCH" Q 0
"RTN","IVMUFNC",226,0)
 I $E($P(NODE,"^",3),4,5),$E($P(NODE,"^",3),4,5)'=$E(DOB,4,5) S ERROR="DOB DOES NOT MATCH" Q 0
"RTN","IVMUFNC",227,0)
 Q DFN
"VER")
8.0^22.0
**END**
**END**
