Released PSB*3*23 SEQ #17
Extracted from mail message
**KIDS**:PSB*3.0*23^

**INSTALL NAME**
PSB*3.0*23
"BLD",6498,0)
PSB*3.0*23^BAR CODE MED ADMIN^0^3060308^y
"BLD",6498,1,0)
^^32^32^3060308^
"BLD",6498,1,1,0)
This patch addresses three Remedy tickets, HD68121, HD113034, and HD90393.
"BLD",6498,1,2,0)
 
"BLD",6498,1,3,0)
 
"BLD",6498,1,4,0)
The first issue, HD68121, is the result of a file locking problem with 
"BLD",6498,1,5,0)
the routine PSBMD.  This error only appeared after the site converted to 
"BLD",6498,1,6,0)
Cache' version 5.  There is an undefined variable error created with 
"BLD",6498,1,7,0)
Missing Dose reports in Pharmacy, even though a record is created in 
"BLD",6498,1,8,0)
^PSB(53.68).  By attempting to lock the ^PSB(53.68) file before 
"BLD",6498,1,9,0)
attempting to print the report, it will ensure that the file exists so 
"BLD",6498,1,10,0)
the undefined error will not occur.  This locking fix was created by the 
"BLD",6498,1,11,0)
Minneapolis IRM staff, and has been working in their production area for 
"BLD",6498,1,12,0)
months.  The fix is being brought back to the VMP group so it can become 
"BLD",6498,1,13,0)
part of a national patch release, and other sites can avoid this error in 
"BLD",6498,1,14,0)
the future.
"BLD",6498,1,15,0)
 
"BLD",6498,1,16,0)
The second issue, HD113034, happens when a medication PATCH (such as 
"BLD",6498,1,17,0)
Fentanyl) is marked as REMOVED after initially being given to the 
"BLD",6498,1,18,0)
patient.  If you right-click the mouse on the order in BCMA and mark the 
"BLD",6498,1,19,0)
patch as "REMOVED", when you subsequently check the med log, the units 
"BLD",6498,1,20,0)
given remains 1.  However, if you use the BCMA menu option FILE/EDIT Med 
"BLD",6498,1,21,0)
Log and mark it "REMOVED", the units given becomes 0, and the audit trail 
"BLD",6498,1,22,0)
shows "Doses given '1' deleted".  The correct value for units given is 
"BLD",6498,1,23,0)
actually 1 (as right-clicking the mouse shows), because the medication 
"BLD",6498,1,24,0)
was indeed given, but the patch was subsequently removed, not deleted or 
"BLD",6498,1,25,0)
refused.
"BLD",6498,1,26,0)
 
"BLD",6498,1,27,0)
The third issue in this patch, HD90393, addresses a printing problem with 
"BLD",6498,1,28,0)
the PRN Effectiveness report when it is printed by Ward/Room-Bed.  When 
"BLD",6498,1,29,0)
this printing filter is applied, the report prints in patient DFN order, 
"BLD",6498,1,30,0)
not Ward/Room-Bed order.  This fix corrects a problem in the BCMA code so 
"BLD",6498,1,31,0)
that when the Ward/Room-bed filter is applied, the report will print 
"BLD",6498,1,32,0)
properly.
"BLD",6498,4,0)
^9.64PA^^
"BLD",6498,6)
2^
"BLD",6498,"KRN",0)
^9.67PA^8989.52^19
"BLD",6498,"KRN",.4,0)
.4
"BLD",6498,"KRN",.401,0)
.401
"BLD",6498,"KRN",.402,0)
.402
"BLD",6498,"KRN",.403,0)
.403
"BLD",6498,"KRN",.5,0)
.5
"BLD",6498,"KRN",.84,0)
.84
"BLD",6498,"KRN",3.6,0)
3.6
"BLD",6498,"KRN",3.8,0)
3.8
"BLD",6498,"KRN",9.2,0)
9.2
"BLD",6498,"KRN",9.8,0)
9.8
"BLD",6498,"KRN",9.8,"NM",0)
^9.68A^4^3
"BLD",6498,"KRN",9.8,"NM",1,0)
PSBMD^^0^72605670
"BLD",6498,"KRN",9.8,"NM",3,0)
PSBML2^^0^77106883
"BLD",6498,"KRN",9.8,"NM",4,0)
PSBOPE^^0^17297866
"BLD",6498,"KRN",9.8,"NM","B","PSBMD",1)

"BLD",6498,"KRN",9.8,"NM","B","PSBML2",3)

"BLD",6498,"KRN",9.8,"NM","B","PSBOPE",4)

"BLD",6498,"KRN",19,0)
19
"BLD",6498,"KRN",19.1,0)
19.1
"BLD",6498,"KRN",101,0)
101
"BLD",6498,"KRN",409.61,0)
409.61
"BLD",6498,"KRN",771,0)
771
"BLD",6498,"KRN",870,0)
870
"BLD",6498,"KRN",8989.51,0)
8989.51
"BLD",6498,"KRN",8989.52,0)
8989.52
"BLD",6498,"KRN",8994,0)
8994
"BLD",6498,"KRN","B",.4,.4)

"BLD",6498,"KRN","B",.401,.401)

"BLD",6498,"KRN","B",.402,.402)

"BLD",6498,"KRN","B",.403,.403)

"BLD",6498,"KRN","B",.5,.5)

"BLD",6498,"KRN","B",.84,.84)

"BLD",6498,"KRN","B",3.6,3.6)

"BLD",6498,"KRN","B",3.8,3.8)

"BLD",6498,"KRN","B",9.2,9.2)

"BLD",6498,"KRN","B",9.8,9.8)

"BLD",6498,"KRN","B",19,19)

"BLD",6498,"KRN","B",19.1,19.1)

"BLD",6498,"KRN","B",101,101)

"BLD",6498,"KRN","B",409.61,409.61)

"BLD",6498,"KRN","B",771,771)

"BLD",6498,"KRN","B",870,870)

"BLD",6498,"KRN","B",8989.51,8989.51)

"BLD",6498,"KRN","B",8989.52,8989.52)

"BLD",6498,"KRN","B",8994,8994)

"BLD",6498,"QUES",0)
^9.62^^
"BLD",6498,"REQB",0)
^9.611^3^2
"BLD",6498,"REQB",1,0)
PSB*3.0*5^1
"BLD",6498,"REQB",3,0)
PSB*3.0*22^1
"BLD",6498,"REQB","B","PSB*3.0*22",3)

"BLD",6498,"REQB","B","PSB*3.0*5",1)

"MBREQ")
0
"PKG",537,-1)
1^1
"PKG",537,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",537,20,0)
^9.402P^^
"PKG",537,22,0)
^9.49I^1^1
"PKG",537,22,1,0)
3.0^3040224^3040504^22979
"PKG",537,22,1,"PAH",1,0)
23^3060308^33270
"PKG",537,22,1,"PAH",1,1,0)
^^32^32^3060308
"PKG",537,22,1,"PAH",1,1,1,0)
This patch addresses three Remedy tickets, HD68121, HD113034, and HD90393.
"PKG",537,22,1,"PAH",1,1,2,0)
 
"PKG",537,22,1,"PAH",1,1,3,0)
 
"PKG",537,22,1,"PAH",1,1,4,0)
The first issue, HD68121, is the result of a file locking problem with 
"PKG",537,22,1,"PAH",1,1,5,0)
the routine PSBMD.  This error only appeared after the site converted to 
"PKG",537,22,1,"PAH",1,1,6,0)
Cache' version 5.  There is an undefined variable error created with 
"PKG",537,22,1,"PAH",1,1,7,0)
Missing Dose reports in Pharmacy, even though a record is created in 
"PKG",537,22,1,"PAH",1,1,8,0)
^PSB(53.68).  By attempting to lock the ^PSB(53.68) file before 
"PKG",537,22,1,"PAH",1,1,9,0)
attempting to print the report, it will ensure that the file exists so 
"PKG",537,22,1,"PAH",1,1,10,0)
the undefined error will not occur.  This locking fix was created by the 
"PKG",537,22,1,"PAH",1,1,11,0)
Minneapolis IRM staff, and has been working in their production area for 
"PKG",537,22,1,"PAH",1,1,12,0)
months.  The fix is being brought back to the VMP group so it can become 
"PKG",537,22,1,"PAH",1,1,13,0)
part of a national patch release, and other sites can avoid this error in 
"PKG",537,22,1,"PAH",1,1,14,0)
the future.
"PKG",537,22,1,"PAH",1,1,15,0)
 
"PKG",537,22,1,"PAH",1,1,16,0)
The second issue, HD113034, happens when a medication PATCH (such as 
"PKG",537,22,1,"PAH",1,1,17,0)
Fentanyl) is marked as REMOVED after initially being given to the 
"PKG",537,22,1,"PAH",1,1,18,0)
patient.  If you right-click the mouse on the order in BCMA and mark the 
"PKG",537,22,1,"PAH",1,1,19,0)
patch as "REMOVED", when you subsequently check the med log, the units 
"PKG",537,22,1,"PAH",1,1,20,0)
given remains 1.  However, if you use the BCMA menu option FILE/EDIT Med 
"PKG",537,22,1,"PAH",1,1,21,0)
Log and mark it "REMOVED", the units given becomes 0, and the audit trail 
"PKG",537,22,1,"PAH",1,1,22,0)
shows "Doses given '1' deleted".  The correct value for units given is 
"PKG",537,22,1,"PAH",1,1,23,0)
actually 1 (as right-clicking the mouse shows), because the medication 
"PKG",537,22,1,"PAH",1,1,24,0)
was indeed given, but the patch was subsequently removed, not deleted or 
"PKG",537,22,1,"PAH",1,1,25,0)
refused.
"PKG",537,22,1,"PAH",1,1,26,0)
 
"PKG",537,22,1,"PAH",1,1,27,0)
The third issue in this patch, HD90393, addresses a printing problem with 
"PKG",537,22,1,"PAH",1,1,28,0)
the PRN Effectiveness report when it is printed by Ward/Room-Bed.  When 
"PKG",537,22,1,"PAH",1,1,29,0)
this printing filter is applied, the report prints in patient DFN order, 
"PKG",537,22,1,"PAH",1,1,30,0)
not Ward/Room-Bed order.  This fix corrects a problem in the BCMA code so 
"PKG",537,22,1,"PAH",1,1,31,0)
that when the Ward/Room-bed filter is applied, the report will print 
"PKG",537,22,1,"PAH",1,1,32,0)
properly.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSBMD")
0^1^B72605670^B70799803
"RTN","PSBMD",1,0)
PSBMD ;BIRMINGHAM/EFC-BCMA MISSING DOSE FUNCTIONS ;Mar 2004 [5/17/05 8:39am]
"RTN","PSBMD",2,0)
 ;;3.0;BAR CODE MED ADMIN;**23**;Mar 2004
"RTN","PSBMD",3,0)
 ;
"RTN","PSBMD",4,0)
 ; Reference/IA
"RTN","PSBMD",5,0)
 ; ^DIC(42/10039
"RTN","PSBMD",6,0)
 ; ^DPT(/10035
"RTN","PSBMD",7,0)
 ; IN5^VADPT/10061
"RTN","PSBMD",8,0)
 ; ^XMB/10070
"RTN","PSBMD",9,0)
 ; 52.6/436
"RTN","PSBMD",10,0)
 ; 52.7/437
"RTN","PSBMD",11,0)
 ;
"RTN","PSBMD",12,0)
RPC(RESULTS,PSBDFN,PSBDRUG,PSBDOSE,PSBRSN,PSBADMIN,PSBNEED,PSBUID,PSBON,PSBSCHD) ;
"RTN","PSBMD",13,0)
 ;
"RTN","PSBMD",14,0)
 ; RPC: PSB SUBMIT MISSING DOSE
"RTN","PSBMD",15,0)
 ;
"RTN","PSBMD",16,0)
 ; Description:
"RTN","PSBMD",17,0)
 ; Allows the client to submit a missing dose interactively
"RTN","PSBMD",18,0)
 ;
"RTN","PSBMD",19,0)
 N DFN,PSBNOW,PSBFDA,PSBIENS,PSBMD,PSBMSG
"RTN","PSBMD",20,0)
 D NEW(.PSBMD)
"RTN","PSBMD",21,0)
 I +PSBMD(0)<1 S RESULTS(0)="-1^Unable to create missing dose request"  Q
"RTN","PSBMD",22,0)
 S PSBIENS=+PSBMD(0)_","
"RTN","PSBMD",23,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBMD",24,0)
 S PSBFDA(53.68,PSBIENS,.02)=PSBNOW
"RTN","PSBMD",25,0)
 S PSBFDA(53.68,PSBIENS,.03)=DUZ
"RTN","PSBMD",26,0)
 S PSBFDA(53.68,PSBIENS,.04)=DUZ(2)
"RTN","PSBMD",27,0)
 S PSBFDA(53.68,PSBIENS,.11)=PSBDFN
"RTN","PSBMD",28,0)
 S X=$G(^DPT(PSBDFN,.1)) I X]"" S X=$O(^DIC(42,"B",X,0)) S:X PSBFDA(53.68,PSBIENS,.12)=X
"RTN","PSBMD",29,0)
 S PSBFDA(53.68,PSBIENS,.13)=PSBDRUG
"RTN","PSBMD",30,0)
 S PSBFDA(53.68,PSBIENS,.14)=PSBDOSE
"RTN","PSBMD",31,0)
 S PSBFDA(53.68,PSBIENS,.15)=PSBRSN
"RTN","PSBMD",32,0)
 S PSBFDA(53.68,PSBIENS,.16)=PSBADMIN
"RTN","PSBMD",33,0)
 S PSBFDA(53.68,PSBIENS,.17)=PSBNEED
"RTN","PSBMD",34,0)
 S PSBFDA(53.68,PSBIENS,.19)=PSBSCHD
"RTN","PSBMD",35,0)
 S PSBFDA(53.68,PSBIENS,.25)=PSBUID
"RTN","PSBMD",36,0)
 S DFN=PSBDFN D IN5^VADPT S PSBFDA(53.68,PSBIENS,.18)=$P(VAIP(6),U,1)
"RTN","PSBMD",37,0)
 D FILE^DIE("","PSBFDA","PSBMSG")
"RTN","PSBMD",38,0)
 L +^PSB(53.68,+PSBIENS)  ; PSB*3*23
"RTN","PSBMD",39,0)
 I $G(PSBUID)'="" D
"RTN","PSBMD",40,0)
 .D PSJ1^PSBVT(PSBDFN,PSBON) K PSBADA,PSBSOLA
"RTN","PSBMD",41,0)
 .I '$D(PSBUIDA(PSBUID)) F  D PSJ1^PSBVT(PSBDFN,PSBPONX) K PSBADA,PSBSOLA Q:$D(PSBUIDA(PSBUID))  Q:PSBPONX=""
"RTN","PSBMD",42,0)
 .F I=1:1 S PSBAD=$P(PSBUIDA(PSBUID),U,I) Q:PSBAD=""  I PSBAD["ADD" S PSBADA($P(PSBAD,";",2))=""
"RTN","PSBMD",43,0)
 .I $D(PSBADA) S X="" F I=1:1 S X=$O(PSBADA(X)) Q:X=""  S PSBFDA(53.686,I_","_PSBIENS,.01)=X,^PSB(53.68,+PSBIENS,.6,I,0)=I
"RTN","PSBMD",44,0)
 .F I=1:1 S PSBSOL=$P(PSBUIDA(PSBUID),U,I) Q:PSBSOL=""  I PSBSOL["SOL" S PSBSOLA($P(PSBSOL,";",2))=""
"RTN","PSBMD",45,0)
 .I $D(PSBSOLA) S X="" F I=1:1 S X=$O(PSBSOLA(X)) Q:X=""  S PSBFDA(53.687,I_","_PSBIENS,.01)=X,^PSB(53.68,+PSBIENS,.7,I,0)=I
"RTN","PSBMD",46,0)
 I $G(PSBUID)="",$G(PSBDRUG)="" D
"RTN","PSBMD",47,0)
 .D PSJ1^PSBVT(PSBDFN,PSBON)
"RTN","PSBMD",48,0)
 .I $D(PSBADA) S X="" F I=1:1 S X=$O(PSBADA(X)) Q:X=""  S PSBFDA(53.686,I_","_PSBIENS,.01)=$P(PSBADA(X),U,2),^PSB(53.68,+PSBIENS,.6,I,0)=X
"RTN","PSBMD",49,0)
 .I $D(PSBSOLA) S X="" F I=1:1 S X=$O(PSBSOLA(X)) Q:X=""  S PSBFDA(53.687,I_","_PSBIENS,.01)=$P(PSBSOLA(X),U,2),^PSB(53.68,+PSBIENS,.7,I,0)=X
"RTN","PSBMD",50,0)
 D FILE^DIE("","PSBFDA","PSBMSG")
"RTN","PSBMD",51,0)
 L -^PSB(53.68,+PSBIENS) ; PSB83*23
"RTN","PSBMD",52,0)
 D SUBMIT(+PSBIENS)
"RTN","PSBMD",53,0)
 S RESULTS(0)="1^Missing Dose Submitted^"_+PSBIENS
"RTN","PSBMD",54,0)
 D CLEAN^PSBVT
"RTN","PSBMD",55,0)
 Q
"RTN","PSBMD",56,0)
 ;
"RTN","PSBMD",57,0)
XQ ; Called via Kernel Menus
"RTN","PSBMD",58,0)
 N PSBMD,PSBSAVE,DA,DIK,DR,DDSFILE,XMY,XMTEXT,XMSUB
"RTN","PSBMD",59,0)
 D NEW(.PSBMD)
"RTN","PSBMD",60,0)
 I +PSBMD(0)<1 W !,"Error: ",$P(PSBMD(0),U,2) S DIR(0)="E" D ^DIR Q
"RTN","PSBMD",61,0)
 S DA=+PSBMD(0),DR="[PSB MISSING DOSE REQUEST]",DDSFILE=53.68 D ^DDS
"RTN","PSBMD",62,0)
 W @IOF
"RTN","PSBMD",63,0)
 I 'PSBSAVE W !,"Cancelling Request..." S DIK="^PSB(53.68," D ^DIK W "Cancelled!"
"RTN","PSBMD",64,0)
 D:PSBSAVE SUBMIT(DA)
"RTN","PSBMD",65,0)
 Q
"RTN","PSBMD",66,0)
 ;
"RTN","PSBMD",67,0)
SUBMIT(DA) ; Submit Request to Pharmacy
"RTN","PSBMD",68,0)
 N PSBWRD,PSBMG,PSBPRT
"RTN","PSBMD",69,0)
 S PSBWRD=$P(^PSB(53.68,DA,.1),U,2)
"RTN","PSBMD",70,0)
 S PSBWRD=+$G(^DIC(42,+PSBWRD,44))
"RTN","PSBMD",71,0)
 ;
"RTN","PSBMD",72,0)
 ; Get Mail Group
"RTN","PSBMD",73,0)
 ;
"RTN","PSBMD",74,0)
 S PSBMG=$$GET^XPAR(PSBWRD_";SC(","PSB MG MISSING DOSE",,"E")
"RTN","PSBMD",75,0)
 S:PSBMG="" PSBMG=$$GET^XPAR("DIV","PSB MG MISSING DOSE",,"E")
"RTN","PSBMD",76,0)
 S $P(^PSB(53.68,DA,0),U,5)=PSBMG ; Add MG to notification
"RTN","PSBMD",77,0)
 ;
"RTN","PSBMD",78,0)
 ; Get Printer
"RTN","PSBMD",79,0)
 ;
"RTN","PSBMD",80,0)
 S PSBPRT=$$GET^XPAR(PSBWRD_";SC(","PSB PRINTER MISSING DOSE",,"E")
"RTN","PSBMD",81,0)
 S:PSBPRT="" PSBPRT=$$GET^XPAR("DIV","PSB PRINTER MISSING DOSE",,"E")
"RTN","PSBMD",82,0)
 S $P(^PSB(53.68,DA,0),U,6)=PSBPRT ; Add MG to notification
"RTN","PSBMD",83,0)
 ;
"RTN","PSBMD",84,0)
 ; Send the report to the specified printer
"RTN","PSBMD",85,0)
 ;
"RTN","PSBMD",86,0)
 D:PSBPRT]""
"RTN","PSBMD",87,0)
 .W !,"Submitting Request To Pharmacy on device ",PSBPRT,"..."
"RTN","PSBMD",88,0)
 .D NOW^%DTC
"RTN","PSBMD",89,0)
 .S ZTIO=PSBPRT
"RTN","PSBMD",90,0)
 .S ZTDTH=%
"RTN","PSBMD",91,0)
 .S ZTDESC="BCMA - MISSING DOSE REQUEST"
"RTN","PSBMD",92,0)
 .S ZTRTN="DQ^PSBMD("_DA_")"
"RTN","PSBMD",93,0)
 .D ^%ZTLOAD
"RTN","PSBMD",94,0)
 .W "Done!"
"RTN","PSBMD",95,0)
 ;
"RTN","PSBMD",96,0)
 ; Send the same stuff to the mail group
"RTN","PSBMD",97,0)
 ;
"RTN","PSBMD",98,0)
 D:PSBMG]""
"RTN","PSBMD",99,0)
 .W !,"Notifying Pharmacy via Mail Group ",PSBMG,"..."
"RTN","PSBMD",100,0)
 .D HFSOPEN^PSBUTL("MISSING DOSE")
"RTN","PSBMD",101,0)
 .U IO D DQ(DA,1)
"RTN","PSBMD",102,0)
 .D HFSCLOSE^PSBUTL("MISSING DOSE")
"RTN","PSBMD",103,0)
 .S XMY("G."_PSBMG)="",XMTEXT="^TMP(""PSBO"",$J,"
"RTN","PSBMD",104,0)
 .S XMSUB="BCMA - Missing Dose Request"
"RTN","PSBMD",105,0)
 .D ^XMD
"RTN","PSBMD",106,0)
 .W "Done!"
"RTN","PSBMD",107,0)
 Q
"RTN","PSBMD",108,0)
 ;
"RTN","PSBMD",109,0)
DQ(PSBMD,PSBMM) ; Dequeue report from Taskman
"RTN","PSBMD",110,0)
 N PSBFLD,PSBRET
"RTN","PSBMD",111,0)
 Q:'$D(^PSB(53.68,PSBMD,0))
"RTN","PSBMD",112,0)
 L +^PSB(53.68,PSBMD) ; PSB*3*23
"RTN","PSBMD",113,0)
 S PSBCFLD=$P(^PSB(53.68,PSBMD,.1),U,3)
"RTN","PSBMD",114,0)
 L -^PSB(53.68,PSBMD) ; PSB*3*23
"RTN","PSBMD",115,0)
 D:'$G(PSBMM)  ; It is not a mail message
"RTN","PSBMD",116,0)
 .W !,$TR($J("",75)," ","=")
"RTN","PSBMD",117,0)
 .W !,"Report:       MISSING DOSE REQUEST"
"RTN","PSBMD",118,0)
 .W !,"Date Created: " D NOW^%DTC S Y=% D D^DIQ W Y
"RTN","PSBMD",119,0)
 .W !,$TR($J("",75)," ","="),!
"RTN","PSBMD",120,0)
 I $G(PSBCFLD)'="" F PSBFLD=.01,.02,.03,.04,.05,.06,.11,.12,.18,.13,.14,.19,.15,.16,.17 D OUT
"RTN","PSBMD",121,0)
 I $G(PSBCFLD)="" F PSBFLD=.01,.02,.03,.04,.05,.06,.11,.12,.18,.25,.15,.19,.16,.17 D OUT
"RTN","PSBMD",122,0)
 I $D(^PSB(53.68,PSBMD,.6)) S X=0 F  S X=$O(^PSB(53.68,PSBMD,.6,X)) Q:'X  W !?3,"ADDITIVE:  ",$$GET1^DIQ(52.6,+^PSB(53.68,PSBMD,.6,X,0),.01)
"RTN","PSBMD",123,0)
 I $D(^PSB(53.68,PSBMD,.7)) S X=0 F  S X=$O(^PSB(53.68,PSBMD,.7,X)) Q:'X  W !?3,"SOLUTION:  ",$$GET1^DIQ(52.7,+^PSB(53.68,PSBMD,.7,X,0),.01)
"RTN","PSBMD",124,0)
 Q
"RTN","PSBMD",125,0)
OUT ;
"RTN","PSBMD",126,0)
 D FIELD^DID(53.68,PSBFLD,"","LABEL","PSBRET")
"RTN","PSBMD",127,0)
 W !?3,PSBRET("LABEL"),":" F  Q:$X>30  W "."
"RTN","PSBMD",128,0)
 W $$GET1^DIQ(53.68,PSBMD_",",PSBFLD)
"RTN","PSBMD",129,0)
 I PSBFLD=.11 D
"RTN","PSBMD",130,0)
 .S PSBDFN=$$GET1^DIQ(53.68,PSBMD_",",.11,"I")
"RTN","PSBMD",131,0)
 .W !?3,"SSN (LAST 4 NUMBERS):" F  Q:$X>30  W "."
"RTN","PSBMD",132,0)
 .W $E($$GET1^DIQ(2,PSBDFN_",",.09),6,9)
"RTN","PSBMD",133,0)
 W:PSBFLD=.13 " ("_$P($G(^PSB(53.68,PSBMD,.1)),U,3)_")"
"RTN","PSBMD",134,0)
 S ZTREQ="@"
"RTN","PSBMD",135,0)
 Q
"RTN","PSBMD",136,0)
 ;
"RTN","PSBMD",137,0)
NEW(RESULTS) ; Create a new missing dose request
"RTN","PSBMD",138,0)
 ; Called interactively and via RPCBroker
"RTN","PSBMD",139,0)
 N DIC
"RTN","PSBMD",140,0)
 K RESULTS
"RTN","PSBMD",141,0)
 I '+$G(DUZ) S RESULTS(0)="-1^Undefined User" Q
"RTN","PSBMD",142,0)
 I '$G(DUZ(2)) S RESULTS(0)="-1^Undefined Division" Q
"RTN","PSBMD",143,0)
 ; Lock Log
"RTN","PSBMD",144,0)
 L +^PSB(53.68,0):3
"RTN","PSBMD",145,0)
 E  S RESULTS(0)="-1^Request Log Locked" Q
"RTN","PSBMD",146,0)
 ; Generate Unique Entry and Create
"RTN","PSBMD",147,0)
 F  D NOW^%DTC S X=$E(%_"000000",1,14),X=(1700+$E(X,1,3))_$E(X,4,14),X="MD-"_$TR(X,".","-") Q:'$D(^PSB(53.68,"B",X))
"RTN","PSBMD",148,0)
 S DIC="^PSB(53.68,",DIC(0)="L"
"RTN","PSBMD",149,0)
 S DIC("DR")=".02///N;.03////^S X=DUZ;.04////^S X=DUZ(2);.07///1"
"RTN","PSBMD",150,0)
 K D0         ;VRN
"RTN","PSBMD",151,0)
 D FILE^DICN
"RTN","PSBMD",152,0)
 L -^PSB(53.68,0)
"RTN","PSBMD",153,0)
 ; Okay, setup return and Boogie
"RTN","PSBMD",154,0)
 I +Y<1 S RESULTS(0)="-1^Error Creating Request"
"RTN","PSBMD",155,0)
 E  S RESULTS(0)=Y
"RTN","PSBMD",156,0)
 Q
"RTN","PSBMD",157,0)
 ;
"RTN","PSBMD",158,0)
VAL(PSBFLDS) ; Validate that fields in PSBFLDS are filled in
"RTN","PSBMD",159,0)
 N PSB,PSBFLD,PSBMSG
"RTN","PSBMD",160,0)
 F PSB=1:1 Q:$P(PSBFLDS,";",PSB)=""  S PSBFLD=$P(PSBFLDS,";",PSB),PSBFLD(PSBFLD)=$$GET^DDSVAL(53.68,DA,PSBFLD)
"RTN","PSBMD",161,0)
 I $D(PSBFLD(.21)) K:PSBFLD(.21)="N" PSBFLD(.22),PSBFLD(.23)
"RTN","PSBMD",162,0)
 S PSB=""  F  S PSB=$O(PSBFLD(PSB)) Q:PSB=""  D:PSBFLD(PSB)=""
"RTN","PSBMD",163,0)
 .I '$D(PSBMSG) S PSBMSG(0)="UNABLE TO FILE REQUEST",PSBMSG(1)=" ",PSBMSG(2)="ERROR: MISSING DATA - ALL FIELDS ARE REQUIRED"
"RTN","PSBMD",164,0)
 .D FIELD^DID(53.68,PSB,"","TITLE;LABEL","PSB")
"RTN","PSBMD",165,0)
 .S X="  Missing Field: "_$S(PSB("TITLE")]"":PSB("TITLE"),1:PSB("LABEL")),PSBMSG($O(PSBMSG(""),-1)+1)=X
"RTN","PSBMD",166,0)
 Q:'$D(PSBMSG)  ; All is well
"RTN","PSBMD",167,0)
 D MSG^DDSUTL(.PSBMSG)
"RTN","PSBMD",168,0)
 S DDSERROR=1
"RTN","PSBMD",169,0)
 Q
"RTN","PSBMD",170,0)
 ;
"RTN","PSBMD",171,0)
FLWUP ; Follow-Up on missing dose
"RTN","PSBMD",172,0)
 N DIR,PSBIEN,PSBX,DA,DR,DDSFILE,PSBHDR,PSBDRUG
"RTN","PSBMD",173,0)
 S Y="" F  Q:Y="^"  D
"RTN","PSBMD",174,0)
 .K ^TMP("PSB",$J) S X=""
"RTN","PSBMD",175,0)
 .F  S X=$O(^PSB(53.68,"AS",1,X),-1) Q:'X  S Y=$O(^TMP("PSB",$J,""),-1)+1,^TMP("PSB",$J,Y)=X,^TMP("PSB",$J,0)=Y
"RTN","PSBMD",176,0)
 .I '$O(^TMP("PSB",$J,0)) W !!,"No Unresolved Missing Dose Requests Found." S Y="^" Q
"RTN","PSBMD",177,0)
 .S PSBHDR="Currently Unresolved Missing Dose Requests"
"RTN","PSBMD",178,0)
 .W @IOF,PSBHDR,!,$TR($J("",IOM)," ","-")
"RTN","PSBMD",179,0)
 .F PSBX=0:0 S PSBX=$O(^TMP("PSB",$J,PSBX)) Q:'PSBX!(Y="^")  S PSBIEN=^(PSBX)_"," D
"RTN","PSBMD",180,0)
 ..W !,$J(PSBX,2),". ",$$GET1^DIQ(53.68,PSBIEN,.01)
"RTN","PSBMD",181,0)
 ..W ?25,$$GET1^DIQ(53.68,PSBIEN,.11)
"RTN","PSBMD",182,0)
 ..W ?57,$$GET1^DIQ(53.68,PSBIEN,.12)
"RTN","PSBMD",183,0)
 ..S PSBDRUG=$$GET1^DIQ(53.68,PSBIEN,.13)
"RTN","PSBMD",184,0)
 ..I PSBDRUG]"" W !?5,PSBDRUG
"RTN","PSBMD",185,0)
 ..I PSBDRUG="" D
"RTN","PSBMD",186,0)
 ...W !?5,"UNIQUE ID: ",$$GET1^DIQ(53.68,PSBIEN,.25)
"RTN","PSBMD",187,0)
 ...S X=0 F  S X=$O(^PSB(53.68,+PSBIEN,.6,X)) Q:'X  W !?10,"ADDITIVES:  ",$$GET1^DIQ(52.6,+^PSB(53.68,+PSBIEN,.6,X,0),.01)
"RTN","PSBMD",188,0)
 ...S X=0 F  S X=$O(^PSB(53.68,+PSBIEN,.7,X)) Q:'X  W !?10,"SOLUTIONS:  ",$$GET1^DIQ(52.7,+^PSB(53.68,+PSBIEN,.7,X,0),.01)
"RTN","PSBMD",189,0)
 ..S:$Y>(IOSL-4) Y=$$PAGE(PSBX)
"RTN","PSBMD",190,0)
 .S:Y'="^" Y=$$PAGE(PSBX)
"RTN","PSBMD",191,0)
 Q
"RTN","PSBMD",192,0)
PAGE(PSBIX) ;
"RTN","PSBMD",193,0)
 ;
"RTN","PSBMD",194,0)
 N X,X1,PSBCX,PSBDX
"RTN","PSBMD",195,0)
 S DIR("A")="Select Missing Dose Request # (<RET> to continue, '^' to quit)"
"RTN","PSBMD",196,0)
 I PSBIX="" S DIR("A")="Select Missing Dose Request # (<RET> or '^' to quit)"
"RTN","PSBMD",197,0)
 S DIR(0)="NO^1:"_$S(PSBIX="":$O(^TMP("PSB",$J,PSBX),-1),1:PSBIX)_":0"
"RTN","PSBMD",198,0)
 D ^DIR S PSBDX=+Y
"RTN","PSBMD",199,0)
 I PSBIX="",Y="" S Y="^" Q Y
"RTN","PSBMD",200,0)
 I $G(DTOUT) S Y="^" Q Y
"RTN","PSBMD",201,0)
 I Y="^" Q Y
"RTN","PSBMD",202,0)
 I Y="" W @IOF,PSBHDR,!,$TR($J("",IOM)," ","-") Q Y
"RTN","PSBMD",203,0)
 S (DA,PSBCX)=^TMP("PSB",$J,+Y),DR="[PSB MISSING DOSE FOLLOWUP]",DDSFILE=53.68
"RTN","PSBMD",204,0)
 D  Q Y
"RTN","PSBMD",205,0)
 .D ^DDS
"RTN","PSBMD",206,0)
 .I $D(^PSB(53.68,"AS",0,PSBCX)) K ^TMP("PSB",$J) S X="" F  S X=$O(^PSB(53.68,"AS",1,X),-1) Q:'X  S X1=$O(^TMP("PSB",$J,""),-1)+1,^TMP("PSB",$J,X1)=X,^TMP("PSB",$J,0)=X1
"RTN","PSBMD",207,0)
 .S PSBX=0 W @IOF,PSBHDR,!,$TR($J("",IOM)," ","-")
"RTN","PSBMD",208,0)
 ;
"RTN","PSBMD",209,0)
POST ;call from 'Patient' field of screenman form PSB MISSING DOSE REQUEST
"RTN","PSBMD",210,0)
 ; 
"RTN","PSBMD",211,0)
 N DFN
"RTN","PSBMD",212,0)
 S DFN=X D IN5^VADPT
"RTN","PSBMD",213,0)
 D PUT^DDSVAL(DIE,.DA,.12,$P(VAIP(5),U,2))  ; value of DIE is 53.68, BCMA MISSING DOSE REQUEST FILE called from ScreenMan
"RTN","PSBMD",214,0)
 D PUT^DDSVAL(DIE,.DA,.18,$P(VAIP(6),U,1),"","I")  ; value of DIE is 53.68, BCMA MISSING DOSE REQUEST FILE called from ScreenMan
"RTN","PSBMD",215,0)
 D REFRESH^DDSUTL
"RTN","PSBMD",216,0)
 Q
"RTN","PSBML2")
0^3^B77106883^B76832649
"RTN","PSBML2",1,0)
PSBML2 ;BIRMINGHAM/TEJ-BCMA UTILITY TO EDIT THE PSB MED LOG  ;18 Apr 2005  10:13 AM
"RTN","PSBML2",2,0)
 ;;3.0;BAR CODE MED ADMIN;**3,18,22,23**;Mar 2004
"RTN","PSBML2",3,0)
 ;
"RTN","PSBML2",4,0)
 ; Reference/IA
"RTN","PSBML2",5,0)
 ; EN^PSJBCMA3/3320
"RTN","PSBML2",6,0)
 ; ENE^PSJBCMA4/3416
"RTN","PSBML2",7,0)
 ; ENR^PSJBCMA4/3416
"RTN","PSBML2",8,0)
 ;
"RTN","PSBML2",9,0)
APATCH ;
"RTN","PSBML2",10,0)
 S PSBX1=0 F  S PSBX1=$O(^PSB(53.79,+PSBIEN,.5,PSBX1)) Q:'(+PSBX1)  Q
"RTN","PSBML2",11,0)
 I $G(PSBTRAN)["UPDATE",(+PSBX1)'=0 D
"RTN","PSBML2",12,0)
 .S PSBX3=0 F  S PSBX3=$O(^PSB(53.79,+PSBIEN,.5,PSBX3)) Q:+PSBX3=0  I $P(^PSB(53.79,+PSBIEN,.5,PSBX3,0),U,4)="PATCH" D
"RTN","PSBML2",13,0)
 ..I PSBOLSTS="G",PSBREC(0)="N" S PSB1="K ^PSB(53.79,""APATCH"","_$P(^PSB(53.79,+PSBIEN,0),U)_","_$P(^PSB(53.79,+PSBIEN,0),U,6)_","_+PSBIEN_")"
"RTN","PSBML2",14,0)
 ..I PSBFDA(53.79,+PSBIEN_",",.09)="G" S PSB1="S ^PSB(53.79,""APATCH"","_$P(^PSB(53.79,+PSBIEN,0),U)_","_$G(PSBFDA(53.79,+PSBIEN_",",.06))_","_+PSBIEN_")"_"="""""
"RTN","PSBML2",15,0)
 I $G(PSBTRAN)["EDIT",(+PSBX1)'=0 D
"RTN","PSBML2",16,0)
 .S PSBX3=0 F  S PSBX3=$O(^PSB(53.79,+PSBIEN,.5,PSBX3)) Q:+PSBX3=0  I $P(^PSB(53.79,+PSBIEN,.5,PSBX3,0),U,4)="PATCH",((PSBREC(0)="G")!(PSBREC(0)="RM")) D
"RTN","PSBML2",17,0)
 ..S PSB1="S ^PSB(53.79,""APATCH"","_$P(^PSB(53.79,+PSBIEN,0),U)_","_$G(PSBFDA(53.79,+PSBIEN_",",.06))_","_+PSBIEN_")"_"="""""
"RTN","PSBML2",18,0)
 ..I $D(PSBREC(4,0)) S PSB2="K ^PSB(53.79,""APATCH"","_$P(^PSB(53.79,+PSBIEN,0),U)_","_$G(PSBREC(4,0))_","_+PSBIEN_")"
"RTN","PSBML2",19,0)
 Q
"RTN","PSBML2",20,0)
 ;
"RTN","PSBML2",21,0)
EDIT ;
"RTN","PSBML2",22,0)
 K RESULTS S PSBEDIEN=PSBIEN_",",RESULTS(0)=0
"RTN","PSBML2",23,0)
 I $G(PSBREC(7))']"" S RESULTS(0)=1,RESULTS(1)="-1^Data NOT filed - Comment is required" Q
"RTN","PSBML2",24,0)
 D
"RTN","PSBML2",25,0)
 .S PSBEDTFL=1,PSBMODS=0,PSBREC(1)=""
"RTN","PSBML2",26,0)
 .D:PSBREC(4)]"" VAL^PSBML(53.79,PSBEDIEN,.06,PSBREC(4))
"RTN","PSBML2",27,0)
 .I (PSBREC(0)="N") D
"RTN","PSBML2",28,0)
 ..I ($$GET1^DIQ(53.79,PSBEDIEN,.11)["V") F PSBX=1:1:6 S PSBREC(PSBX)=""
"RTN","PSBML2",29,0)
 .I ("NHR"[PSBREC(0)),$D(^PSB(53.79,+PSBEDIEN,.2)) D
"RTN","PSBML2",30,0)
 ..; Audit PRN
"RTN","PSBML2",31,0)
 ..D:$P(^PSB(53.79,+PSBEDIEN,.2),U,2)]"" AUDIT^PSBUTL(+PSBEDIEN,53.79,.22,$P(^PSB(53.79,+PSBEDIEN,.2),U,2),"K")
"RTN","PSBML2",32,0)
 ..I ($P(^PSB(53.79,+PSBEDIEN,0),U,9)="G")!($P(^PSB(53.79,+PSBEDIEN,0),U,9)="I") D
"RTN","PSBML2",33,0)
 ...I $D(^PSB(53.79,"APRN",$P(^PSB(53.79,+PSBEDIEN,0),U,1),$P(^PSB(53.79,+PSBEDIEN,0),U,6),+PSBEDIEN)) D
"RTN","PSBML2",34,0)
 ....K ^PSB(53.79,"APRN",$P(^PSB(53.79,+PSBEDIEN,0),U,1),$P(^PSB(53.79,+PSBEDIEN,0),U,6),+PSBEDIEN) K ^PSB(53.79,+PSBEDIEN,.2)
"RTN","PSBML2",35,0)
 .I ("NHR"'[PSBREC(0)) D:$G(PSBREC(5))]"" VAL^PSBML(53.79,PSBEDIEN,.21,$G(PSBREC(5))) D:$G(PSBREC(6))]"" VAL^PSBML(53.79,PSBEDIEN,.22,$G(PSBREC(6)))
"RTN","PSBML2",36,0)
 .I +$G(RESULTS(0))<0 S RESULTS(1)="-1^Data NOT filed - "_$P(RESULTS(0),U,2),RESULTS(0)=1 Q
"RTN","PSBML2",37,0)
 .D:$D(^PSB(53.79,+PSBEDIEN,.2)) VAL^PSBML(53.79,PSBEDIEN,.21,$G(PSBREC(5))),VAL^PSBML(53.79,PSBEDIEN,.22,$G(PSBREC(6)))
"RTN","PSBML2",38,0)
 .D VAL^PSBML(53.793,"+2,"_PSBIEN,.01,PSBREC(7))
"RTN","PSBML2",39,0)
 .D VAL^PSBML(53.793,"+2,"_PSBIEN,.02,"`"_DUZ)
"RTN","PSBML2",40,0)
 .D VAL^PSBML(53.793,"+2,"_PSBIEN,.03,PSBNOW)
"RTN","PSBML2",41,0)
 Q:+$G(RESULTS(1))<0
"RTN","PSBML2",42,0)
 S PSBMODS=$$CHANGE^PSBML3(.PSBREC,PSBEDIEN)
"RTN","PSBML2",43,0)
 D:PSBMODS UPDATED
"RTN","PSBML2",44,0)
 D:('$G(PSBERR))&('$G(PSBMODS)) FILEIT^PSBML
"RTN","PSBML2",45,0)
 ; Audit DD
"RTN","PSBML2",46,0)
 I $D(PSBORDMD) S (PSBXY,PSBXZ)="" D
"RTN","PSBML2",47,0)
 .F  S PSBXY=$O(PSBORDMD(PSBXY)) Q:PSBXY=""  S PSBFDAX=$S(PSBXY=.6:53.796,PSBXY=.7:53.797,1:53.795) F  S PSBXZ=$O(PSBORDMD(PSBXY,PSBXZ)) Q:PSBXZ=""  D
"RTN","PSBML2",48,0)
 ..S PSBXACT="",PSBXACT=$G(PSBORDMD(PSBXY,PSBXZ,0))
"RTN","PSBML2",49,0)
 ..D:PSBXACT["ADD" AUDIT^PSBUTL(+PSBEDIEN,PSBFDAX,.01,PSBXZ,"S") D:PSBXACT["DELETE" AUDIT^PSBUTL(+PSBEDIEN,PSBFDAX,.01,PSBXZ,"K")
"RTN","PSBML2",50,0)
 ;
"RTN","PSBML2",51,0)
 K PSBORDMD,PSBCHNG,PSBDDX,PSBEDTFL,PSBEDIEN,PSBFILED
"RTN","PSBML2",52,0)
 Q
"RTN","PSBML2",53,0)
 ;
"RTN","PSBML2",54,0)
UPDATED ;
"RTN","PSBML2",55,0)
 N PSBADD
"RTN","PSBML2",56,0)
 S PSBIEN=PSBIEN_",",PSBXPTCH=0
"RTN","PSBML2",57,0)
 S PSBRECNO=$S(PSBEDTFL:8,1:4)
"RTN","PSBML2",58,0)
 I "^G^N^H^R^RM^S^C^I^M^"[(U_PSBREC(0)_U) D
"RTN","PSBML2",59,0)
 .D:('PSBEDTFL) VAL^PSBML(53.79,PSBIEN,.06,PSBNOW)
"RTN","PSBML2",60,0)
 .D:$D(PSBREC(4,0)) VAL^PSBML(53.79,PSBIEN,.06,PSBREC(4))
"RTN","PSBML2",61,0)
 .D VAL^PSBML(53.79,PSBIEN,.07,"`"_DUZ)
"RTN","PSBML2",62,0)
 .D:('PSBEDTFL)!($G(PSBREC(0,0))) VAL^PSBML(53.79,PSBIEN,.09,PSBREC(0))
"RTN","PSBML2",63,0)
 .I $G(PSBREC(3))]"" D VAL^PSBML(53.79,PSBIEN,.26,PSBREC(3))
"RTN","PSBML2",64,0)
 I $D(PSBREC(PSBRECNO)) D:($G(PSBREC(0))="G")&($P(PSBREC(PSBRECNO),U,5)["PATCH")  Q:+$G(RESULTS(1))<0 
"RTN","PSBML2",65,0)
 .S PSBXDFN=$$GET1^DIQ(53.79,PSBIEN,.01,"I")
"RTN","PSBML2",66,0)
 .S PSBXORN=$$GET1^DIQ(53.79,+PSBIEN,.11,"I")
"RTN","PSBML2",67,0)
 .S PSBXDT="" F  S PSBXDT=$O(^PSB(53.79,"AORDX",PSBXDFN,PSBXORN,PSBXDT)) Q:PSBXDT=""  D  Q:+$G(RESULTS(1))<0
"RTN","PSBML2",68,0)
 ..S PSBYZ="" F  S PSBYZ=$O(^PSB(53.79,"AORDX",PSBXDFN,PSBXORN,PSBXDT,PSBYZ)) Q:'PSBYZ  I ($$GET1^DIQ(53.79,PSBYZ,.09,"I")="G"),(PSBYZ'=+PSBIEN) S RESULTS(0)=1,RESULTS(1)="-1^Previous Patch has not been removed. Administration canceled." Q
"RTN","PSBML2",69,0)
 D:$G(PSBREC(0))="N"
"RTN","PSBML2",70,0)
 .I (PSBREC(0)="N"),($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="G") S PSBREC(1)="Undo Given: "_$G(PSBREC(1))
"RTN","PSBML2",71,0)
 .I ((PSBREC(0)="N")!(PSBREC(0)="G")),($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="RM") S PSBREC(1)="Undo Remove: "_$G(PSBREC(1))
"RTN","PSBML2",72,0)
 .; Undo PRN
"RTN","PSBML2",73,0)
 .I $D(^PSB(53.79,+PSBIEN,.2)) D
"RTN","PSBML2",74,0)
 ..D:$P(^PSB(53.79,+PSBIEN,.2),U,2)]"" AUDIT^PSBUTL(+PSBIEN,53.79,.22,$P(^PSB(53.79,+PSBIEN,.2),U,2),"K")
"RTN","PSBML2",75,0)
 ..I ($P(^PSB(53.79,+PSBIEN,0),U,9)="G")!($P(^PSB(53.79,+PSBIEN,0),U,9)="I") K ^PSB(53.79,"APRN",$P(^PSB(53.79,+PSBIEN,0),U,1),$P(^PSB(53.79,+PSBIEN,0),U,6),+PSBIEN),^PSB(53.79,+PSBIEN,.2)
"RTN","PSBML2",76,0)
 D:$G(PSBREC(1))]""
"RTN","PSBML2",77,0)
 .S:PSBREC(0)="H" PSBREC(1)="Held: "_PSBREC(1)
"RTN","PSBML2",78,0)
 .S:PSBREC(0)="R" PSBREC(1)="Refused: "_PSBREC(1)
"RTN","PSBML2",79,0)
 .S:PSBREC(0)="RM" PSBREC(1)="Removed: "_PSBREC(1)
"RTN","PSBML2",80,0)
 .I $D(PSBFDA(53.793,"+2,"_PSBIEN,.01)) S PSBREC(1)=PSBREC(1)_(PSBFDA(53.793,"+2,"_PSBIEN,.01))
"RTN","PSBML2",81,0)
 .D VAL^PSBML(53.793,"+2,"_PSBIEN,.01,PSBREC(1)),VAL^PSBML(53.793,"+2,"_PSBIEN,.02,"`"_DUZ),VAL^PSBML(53.793,"+2,"_PSBIEN,.03,PSBNOW)
"RTN","PSBML2",82,0)
 S PSBXDFN=$$GET1^DIQ(53.79,PSBIEN,.01,"I")
"RTN","PSBML2",83,0)
 I ($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="RM"),((PSBREC(0)="N")!(PSBREC(0)="G")) D
"RTN","PSBML2",84,0)
 .I '(($D(^XUSEC("PSB MANAGER",DUZ)))!($$GET1^DIQ(53.79,+PSBIEN,.07,"I")=DUZ)) S RESULTS(0)=1,RESULTS(1)="-1^Verify PSB MANAGER allocation" Q
"RTN","PSBML2",85,0)
 .S PSBXPTCH=1,PSBYY="",PSBGIVEN=0 F  S PSBYY=$O(^PSB(53.79,+PSBIEN,.9,PSBYY),-1) Q:'PSBYY  Q:(+$G(RESULTS(0))<0)  Q:PSBGIVEN  S PSBXDAT=$G(^(PSBYY,0))  D
"RTN","PSBML2",86,0)
 ..I PSBXDAT["ACTION STATUS 'GIVEN'" D
"RTN","PSBML2",87,0)
 ...S PSBXDATE=$P(^PSB(53.79,+PSBIEN,.9,PSBYY,0),U)
"RTN","PSBML2",88,0)
 ...S PSBXORN=$$GET1^DIQ(53.79,+PSBIEN,.11,"I")
"RTN","PSBML2",89,0)
 ...S PSBYX=(PSBYY-2) I (PSBYX)>0 I ^PSB(53.79,+PSBIEN,.9,PSBYX,0)["ACTION DATE/TIME '" S PSBXDATE=$P(^PSB(53.79,+PSBIEN,.9,PSBYX,0),"'",2),X=$P(PSBXDATE,"@"),%DT="" D ^%DT S PSBXDATE=Y_"."_$TR($P(PSBXDATE,"@",2),":")
"RTN","PSBML2",90,0)
 ...S PSBXDT="" F  S PSBXDT=$O(^PSB(53.79,"AORDX",PSBXDFN,PSBXORN,PSBXDT)) Q:PSBXDT=""  D  Q:+$G(RESULTS(1))<0
"RTN","PSBML2",91,0)
 ....S PSBYZ="" F  S PSBYZ=$O(^PSB(53.79,"AORDX",PSBXDFN,PSBXORN,PSBXDT,PSBYZ)) Q:'PSBYZ  I ($$GET1^DIQ(53.79,PSBYZ,.09,"I")="G"),(PSBYZ'=+PSBIEN) S RESULTS(0)=1,RESULTS(1)="-1^Cannot UNDO! Order has GIVEN patch" Q
"RTN","PSBML2",92,0)
 ...I '(+$G(RESULTS(1))<0) D  S PSBGIVEN=1
"RTN","PSBML2",93,0)
 ....D VAL^PSBML(53.79,PSBIEN,.06,PSBXDATE),VAL^PSBML(53.79,PSBIEN,.07,"`"_$P(PSBXDAT,U,2)),VAL^PSBML(53.79,PSBIEN,.09,"G")
"RTN","PSBML2",94,0)
 ..D:('(+$G(RESULTS(1))<0))&('PSBGIVEN)&($G(PSBXPTCH))&(PSBYY'>1)
"RTN","PSBML2",95,0)
 ...S PSBXDATE=$P(^PSB(53.79,+PSBIEN,.9,PSBYY,0),"'",2),X=$P(PSBXDATE,"@"),%DT="" D ^%DT S PSBXDATE=Y_"."_$TR($P(PSBXDATE,"@",2),":")
"RTN","PSBML2",96,0)
 ...D VAL^PSBML(53.79,PSBIEN,.06,PSBXDATE),VAL^PSBML(53.79,PSBIEN,.07,"`"_$$GET1^DIQ(53.79,+PSBIEN,.07,"I")),VAL^PSBML(53.79,PSBIEN,.09,"G") S PSBGIVEN=1
"RTN","PSBML2",97,0)
 Q:(+$G(RESULTS(1))<0)
"RTN","PSBML2",98,0)
 I PSBEDTFL,$G(PSBGIVEN),PSBXPTCH S PSBREC(0)="G",PSBUNTSG=$P(PSBREC(8),U,4) D VAL^PSBML(53.795,(1_","_PSBIEN),.03,$S(PSBUNTSG'=0:PSBUNTSG,1:1)) K PSBXPTCH
"RTN","PSBML2",99,0)
 I $G(PSBREC(2))]"" D VAL^PSBML(53.79,PSBIEN,.16,PSBREC(2))
"RTN","PSBML2",100,0)
 S PSBOLDUZ=$P(^PSB(53.79,+PSBIEN,0),U,7),PSBOLSTS=$P(^PSB(53.79,+PSBIEN,0),U,9)
"RTN","PSBML2",101,0)
 I $G(PSBREC(PSBRECNO))]"" D  ; DD/SOL/ADD
"RTN","PSBML2",102,0)
 .I PSBREC(0)="G"!(PSBREC(0)="I")!(PSBREC(0)="H")!(PSBREC(0)="R")!(PSBREC(0)="M") D  ; Only if gvn or infus
"RTN","PSBML2",103,0)
 ..Q:(PSBEDTFL)&('$G(PSBCHNG))
"RTN","PSBML2",104,0)
 ..F PSBCNT=PSBRECNO:1 Q:'$D(PSBREC(PSBCNT))  D
"RTN","PSBML2",105,0)
 ...S Y=$P(PSBREC(PSBCNT),U)
"RTN","PSBML2",106,0)
 ...S PSBDD=$S(Y="DD":53.795,Y="ADD":53.796,Y="SOL":53.797,1:0)
"RTN","PSBML2",107,0)
 ...Q:'PSBDD
"RTN","PSBML2",108,0)
 ...I $G(PSBCHNG) D
"RTN","PSBML2",109,0)
 ....I $D(PSBFIND(PSBCNT)) S PSBIENS=$QS($Q(PSBFIND(PSBCNT)),2)_","_PSBIEN
"RTN","PSBML2",110,0)
 ....I '$D(PSBFIND(PSBCNT)) S PSBIENS="+1,"_PSBIEN
"RTN","PSBML2",111,0)
 ....D VAL^PSBML(PSBDD,PSBIENS,.01,"`"_$P(PSBREC(PSBCNT),U,2))
"RTN","PSBML2",112,0)
 ....D VAL^PSBML(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,3))
"RTN","PSBML2",113,0)
 ....D VAL^PSBML(PSBDD,PSBIENS,.03,$P(PSBREC(PSBCNT),U,4))
"RTN","PSBML2",114,0)
 ....D:Y="DD" VAL^PSBML(PSBDD,PSBIENS,.04,$P(PSBREC(PSBCNT),U,5))
"RTN","PSBML2",115,0)
 .I ('PSBEDTFL)!((PSBREC(0)'="G")&($$GET1^DIQ(53.79,PSBIEN,.09,"I")="G")) D
"RTN","PSBML2",116,0)
 ..S (PSBDCNT,PSBACNT,PSBSCNT)=0,PSBADD=3 F PSBCNT=PSBRECNO:1 Q:'$D(PSBREC(PSBCNT))  D
"RTN","PSBML2",117,0)
 ...S Y=$P(PSBREC(PSBCNT),U)
"RTN","PSBML2",118,0)
 ...S PSBDD=$S(Y="DD":53.795,Y="ADD":53.796,Y="SOL":53.797,1:0)
"RTN","PSBML2",119,0)
 ...Q:'PSBDD
"RTN","PSBML2",120,0)
 ...S @("PSB"_$E(Y)_"CNT")=@("PSB"_$E(Y)_"CNT")+1
"RTN","PSBML2",121,0)
 ...S PSBIENS=(@("PSB"_$E(Y)_"CNT"))_","_PSBIEN
"RTN","PSBML2",122,0)
 ...I '$$GET1^DIQ(PSBDD,PSBIENS,.01,"I") S PSBIENS="+"_PSBADD_","_PSBIEN,PSBADD=PSBADD+1
"RTN","PSBML2",123,0)
 ...D VAL^PSBML(PSBDD,PSBIENS,.01,"`"_$P(PSBREC(PSBCNT),U,2))
"RTN","PSBML2",124,0)
 ...D VAL^PSBML(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,3))
"RTN","PSBML2",125,0)
 ...D:Y="DD" VAL^PSBML(PSBDD,PSBIENS,.03,$S(PSBREC(0)="G"!(PSBREC(0)="RM"):$P(PSBREC(PSBCNT),U,4),1:0)),VAL^PSBML(PSBDD,PSBIENS,.04,$P(PSBREC(PSBCNT),U,5))
"RTN","PSBML2",126,0)
 I ($G(PSBREC(PSBRECNO))']""),(PSBREC(0)="N"),($$GET1^DIQ(53.79,PSBIEN,.09,"I")="G") D
"RTN","PSBML2",127,0)
 .S PSBX=0 F  S PSBX=$O(^PSB(53.79,+PSBIEN,.5,PSBX)) Q:'+PSBX  D VAL^PSBML(53.795,(PSBX_","_PSBIEN),.03,0)
"RTN","PSBML2",128,0)
 D FILEIT^PSBML
"RTN","PSBML2",129,0)
 I $P($G(RESULTS(1)),U,1)=1 D
"RTN","PSBML2",130,0)
 .S PSBUID=$P(^PSB(53.79,+PSBIEN,0),U,10) I PSBUID]"",PSBUID'["WS" D
"RTN","PSBML2",131,0)
 ..S PSBTS=PSBREC(0)
"RTN","PSBML2",132,0)
 ..S PSBON=$P(^PSB(53.79,+PSBIEN,.1),U,1)
"RTN","PSBML2",133,0)
 ..S PSBDFN=$P(^PSB(53.79,+PSBIEN,0),U,1)
"RTN","PSBML2",134,0)
 ..I PSBREC(0)="N" S PSBTS="" D
"RTN","PSBML2",135,0)
 ...M PSBAR=^PSB(53.79,+PSBIEN,.9)
"RTN","PSBML2",136,0)
 ...S (PSBDN,X)="" F  S X=$O(PSBAR(X),-1) Q:X=0!(PSBDN=1)  D
"RTN","PSBML2",137,0)
 ....I PSBAR(X,0)["ACTION STATUS",PSBAR(X,0)["deleted",PSBAR(X,0)'["GIVEN" D
"RTN","PSBML2",138,0)
 .....S PSBTS=$P($P(PSBAR(X,0),"'",2),"'",1)
"RTN","PSBML2",139,0)
 .....S PSBTS=$S(PSBTS="HELD":"H",PSBTS="REFUSED":"R",PSBTS="REMOVED":"RM",PSBTS="MISSING":"M",1:""),PSBDN=1
"RTN","PSBML2",140,0)
 ...D VAL^PSBML(53.79,PSBIEN,.26,"") D CLEAN^DILF,UPDATE^DIE("","PSBFDA","PSBIEN","PSBMSG")
"RTN","PSBML2",141,0)
 ..D EN^PSJBCMA3(PSBDFN,+PSBON,PSBUID,PSBTS,PSBNOW)
"RTN","PSBML2",142,0)
 I ($$GET1^DIQ(53.79,+PSBIEN,.12,"I")="O")&($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="N") S PSBDFN=$$GET1^DIQ(53.79,+PSBIEN,.01,"I") D ENR^PSJBCMA4(PSBDFN,$$GET1^DIQ(53.79,+PSBIEN,.11))
"RTN","PSBML2",143,0)
 I ($$GET1^DIQ(53.79,+PSBIEN,.12,"I")="O")&($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="G") S PSBDFN=$$GET1^DIQ(53.79,+PSBIEN,.01,"I") D ENE^PSJBCMA4(PSBDFN,$$GET1^DIQ(53.79,+PSBIEN,.11))
"RTN","PSBML2",144,0)
 I (PSBREC(0)="N")&($$GET1^DIQ(53.79,+PSBIEN,.09,"I")="N") D NGRESET^PSBML3(.PSBREC,PSBIEN)
"RTN","PSBML2",145,0)
 Q
"RTN","PSBML2",146,0)
 ;
"RTN","PSBOPE")
0^4^B17297866^B17071023
"RTN","PSBOPE",1,0)
PSBOPE ;BIRMINGHAM/EFC-PRN EFFECTIVENESS WORKSHEET ;Mar 2004
"RTN","PSBOPE",2,0)
 ;;3.0;BAR CODE MED ADMIN;**5,23**;Mar 2004
"RTN","PSBOPE",3,0)
 ;
"RTN","PSBOPE",4,0)
 ; Reference/IA
"RTN","PSBOPE",5,0)
 ; ^DPT/10035
"RTN","PSBOPE",6,0)
 ; EN^PSJBCMA/2828
"RTN","PSBOPE",7,0)
 ;
"RTN","PSBOPE",8,0)
EN ; Called from DQ^PSBO
"RTN","PSBOPE",9,0)
 N PSBSTRT,PSBSTOP,DFN
"RTN","PSBOPE",10,0)
 K ^TMP("PSB",$J)
"RTN","PSBOPE",11,0)
 S PSBSTRT=$P(PSBRPT(.1),U,6)+$P(PSBRPT(.1),U,7)
"RTN","PSBOPE",12,0)
 S PSBSTOP=$P(PSBRPT(.1),U,8)+$P(PSBRPT(.1),U,9)
"RTN","PSBOPE",13,0)
 F DFN=0:0 S DFN=$O(^TMP("PSBO",$J,DFN)) Q:'DFN  D EN1
"RTN","PSBOPE",14,0)
 D PRINT
"RTN","PSBOPE",15,0)
 K ^TMP("PSJ",$J),^TMP("PSB",$J)
"RTN","PSBOPE",16,0)
 Q
"RTN","PSBOPE",17,0)
 ;
"RTN","PSBOPE",18,0)
EN1 ; Expects DFN,PSBSTRT,PSBSTOP from EN
"RTN","PSBOPE",19,0)
 N PSBGBL,PSBHDR,PSBX,PSBADMIN,PSBDFN,PSBDT,PSBMED,PSBORD,PSBOSTRT,PSBSCHED
"RTN","PSBOPE",20,0)
 K ^TMP("PSJ",$J)
"RTN","PSBOPE",21,0)
 S PSBDT=PSBSTRT-.0000001
"RTN","PSBOPE",22,0)
 F  S PSBDT=$O(^PSB(53.79,"AADT",DFN,PSBDT)) Q:'PSBDT!(PSBDT>PSBSTOP)  D
"RTN","PSBOPE",23,0)
 .S PSBIEN=0
"RTN","PSBOPE",24,0)
 .F  S PSBIEN=$O(^PSB(53.79,"AADT",DFN,PSBDT,PSBIEN)) Q:'PSBIEN  D
"RTN","PSBOPE",25,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,.1)),U,2)'="P"  ; Not a PRN Administration
"RTN","PSBOPE",26,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,.2)),U,2)]""  ; Effectiveness entered
"RTN","PSBOPE",27,0)
 ..Q:($P($G(^PSB(53.79,PSBIEN,0)),U,9)'="G")&($P($G(^PSB(53.79,PSBIEN,0)),U,9)'="RM")  ;Allow only entries with at status of "GIVEN" and "REMOVED"
"RTN","PSBOPE",28,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,0)),U,6)<PSBDT
"RTN","PSBOPE",29,0)
 ..Q:$P($G(^PSB(53.79,PSBIEN,0)),U,6)>PSBSTOP
"RTN","PSBOPE",30,0)
 ..S ^TMP("PSB",$J,DFN,PSBIEN)=""
"RTN","PSBOPE",31,0)
 Q
"RTN","PSBOPE",32,0)
PRINT ; Print meds stored in ^TMP("PSB",$J,DFN,....
"RTN","PSBOPE",33,0)
 N PSBHDR,PSBDT,PSBMED,DFN
"RTN","PSBOPE",34,0)
 ;
"RTN","PSBOPE",35,0)
 ; Print by Patient
"RTN","PSBOPE",36,0)
 ;
"RTN","PSBOPE",37,0)
 D:$P(PSBRPT(.1),U,1)="P"
"RTN","PSBOPE",38,0)
 .S PSBHDR(1)="PRN EFFECTIVENESS LIST from "_$$FMTE^XLFDT(PSBSTRT)_" thru "_$$FMTE^XLFDT(PSBSTOP)
"RTN","PSBOPE",39,0)
 .S DFN=$P(PSBRPT(.1),U,2)
"RTN","PSBOPE",40,0)
 .W $$PTHDR()
"RTN","PSBOPE",41,0)
 .I '$O(^TMP("PSB",$J,DFN,0)) W !,"No PRN Medications Found",$$PTFTR^PSBOHDR() Q
"RTN","PSBOPE",42,0)
 .W !  ; Line Break Between Admin Times
"RTN","PSBOPE",43,0)
 .S PSBIEN=""
"RTN","PSBOPE",44,0)
 .F  S PSBIEN=$O(^TMP("PSB",$J,DFN,PSBIEN)) Q:PSBIEN=""  D
"RTN","PSBOPE",45,0)
 ..S PSBIENS=PSBIEN_","
"RTN","PSBOPE",46,0)
 ..I $Y>(IOSL-5) W $$PTFTR^PSBOHDR(),$$PTHDR()
"RTN","PSBOPE",47,0)
 ..W !,$$GET1^DIQ(53.79,PSBIENS,.06),?30,$$GET1^DIQ(53.79,PSBIENS,.08),?72,$$GET1^DIQ(53.79,PSBIENS,"ACTION BY")
"RTN","PSBOPE",48,0)
 ..W !,?5,"PRN Reason: ",$$GET1^DIQ(53.79,PSBIENS,.21)
"RTN","PSBOPE",49,0)
 .W $$PTFTR^PSBOHDR()
"RTN","PSBOPE",50,0)
 .Q
"RTN","PSBOPE",51,0)
 ;
"RTN","PSBOPE",52,0)
 ; Print by Ward
"RTN","PSBOPE",53,0)
 ;
"RTN","PSBOPE",54,0)
 D:$P(PSBRPT(.1),U,1)="W"
"RTN","PSBOPE",55,0)
 .S PSBHDR(1)="PRN EFFECTIVENESS LIST  from "_$$FMTE^XLFDT(PSBSTRT)_" thru "_$$FMTE^XLFDT(PSBSTOP)
"RTN","PSBOPE",56,0)
 .S PSBWARD=$P(PSBRPT(.1),U,3)
"RTN","PSBOPE",57,0)
 .W $$WRDHDR()
"RTN","PSBOPE",58,0)
 .I '$O(^TMP("PSB",$J,0)) W !,"No PRN Medications Found" Q
"RTN","PSBOPE",59,0)
 .S PSBSORT=$P(PSBRPT(.1),U,5)
"RTN","PSBOPE",60,0)
 .F DFN=0:0 S DFN=$O(^TMP("PSB",$J,DFN)) Q:'DFN  D
"RTN","PSBOPE",61,0)
 ..S PSBINDX=$S(PSBSORT="P":$P(^DPT(DFN,0),U),1:$G(^DPT(DFN,.1))_" "_$G(^DPT(DFN,.101)))  ;PSB*3*23
"RTN","PSBOPE",62,0)
 ..S:PSBINDX="" PSBINDX=$P(^DPT(DFN,0),U)
"RTN","PSBOPE",63,0)
 ..S ^TMP("PSB",$J,"B",PSBINDX,DFN)=""
"RTN","PSBOPE",64,0)
 .S PSBINDX=""
"RTN","PSBOPE",65,0)
 .F  S PSBINDX=$O(^TMP("PSB",$J,"B",PSBINDX)) Q:PSBINDX=""  D
"RTN","PSBOPE",66,0)
 ..F DFN=0:0 S DFN=$O(^TMP("PSB",$J,"B",PSBINDX,DFN)) Q:'DFN  D
"RTN","PSBOPE",67,0)
 ...W ! ; Line Break Between Pt's
"RTN","PSBOPE",68,0)
 ...W:$P(PSBRPT(.1),U,5)="P" !,$$GET1^DIQ(2,DFN_",",.01),?32,$$GET1^DIQ(2,DFN_",",.1),"  ",$$GET1^DIQ(2,DFN_",",.101)
"RTN","PSBOPE",69,0)
 ...W:$P(PSBRPT(.1),U,5)="B" !,$$GET1^DIQ(2,DFN_",",.1),"  ",$$GET1^DIQ(2,DFN_",",.101),?20,$$GET1^DIQ(2,DFN_",",.01)
"RTN","PSBOPE",70,0)
 ...W !  ; Line Break Between Admin Times
"RTN","PSBOPE",71,0)
 ...S PSBIEN=""
"RTN","PSBOPE",72,0)
 ...F  S PSBIEN=$O(^TMP("PSB",$J,DFN,PSBIEN)) Q:PSBIEN=""  D
"RTN","PSBOPE",73,0)
 ....I $Y>(IOSL-5) W $$WRDHDR()
"RTN","PSBOPE",74,0)
 ....W !?5,$$GET1^DIQ(53.79,PSBIEN_",",.06),?35,$$GET1^DIQ(53.79,PSBIEN_",",.08),?77,$$GET1^DIQ(53.79,PSBIEN_",","ACTION BY")
"RTN","PSBOPE",75,0)
 ....W !?10,"PRN Reason: ",$$GET1^DIQ(53.79,PSBIEN_",",.21)
"RTN","PSBOPE",76,0)
 Q
"RTN","PSBOPE",77,0)
 ;
"RTN","PSBOPE",78,0)
WRDHDR() ; Ward Header
"RTN","PSBOPE",79,0)
 D WARD^PSBOHDR(PSBWRD,.PSBHDR)
"RTN","PSBOPE",80,0)
 W:$P(PSBRPT(.1),U,5)="B" !,"Ward Rm-Bed",?20,"Patient"
"RTN","PSBOPE",81,0)
 W:$P(PSBRPT(.1),U,5)="P" !,"Patient",?32,"Ward Rm-Bed"
"RTN","PSBOPE",82,0)
 W !?5,"Administration Date/Time",?35,"Medication",?77,"Administered By"
"RTN","PSBOPE",83,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOPE",84,0)
 Q ""
"RTN","PSBOPE",85,0)
 ;
"RTN","PSBOPE",86,0)
PTHDR() ; Patient Header
"RTN","PSBOPE",87,0)
 D PT^PSBOHDR(DFN,.PSBHDR)
"RTN","PSBOPE",88,0)
 W !,"Administration Date/Time",?30,"Medication",?72,"Administered By"
"RTN","PSBOPE",89,0)
 W !,$TR($J("",IOM)," ","-")
"RTN","PSBOPE",90,0)
 Q ""
"RTN","PSBOPE",91,0)
 ;
"VER")
8.0^22.0
"BLD",6498,6)
^17
**END**
**END**
