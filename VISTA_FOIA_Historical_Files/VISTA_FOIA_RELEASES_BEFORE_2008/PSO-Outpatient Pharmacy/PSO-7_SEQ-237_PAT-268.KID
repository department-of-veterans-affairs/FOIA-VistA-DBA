Released PSO*7*268 SEQ #237
Extracted from mail message
**KIDS**:PSO*7.0*268^

**INSTALL NAME**
PSO*7.0*268
"BLD",6316,0)
PSO*7.0*268^OUTPATIENT PHARMACY^0^3070629^y
"BLD",6316,1,0)
^^155^155^3070525^
"BLD",6316,1,1,0)
This patch is part of the third quarter enhancements release for the
"BLD",6316,1,2,0)
Outpatient Pharmacy V. 7.0 package.
"BLD",6316,1,3,0)
 
"BLD",6316,1,4,0)
1. With the deployment of Cache version 5, it was discovered that the
"BLD",6316,1,5,0)
   short lock timeout values could generate a lock failure. Patch
"BLD",6316,1,6,0)
   DI*22*147, which has already been released, provided a solution to
"BLD",6316,1,7,0)
   resolve this issue and future lock issues.
"BLD",6316,1,8,0)
 
"BLD",6316,1,9,0)
   This patch instituted a new default lock timeout of three seconds based
"BLD",6316,1,10,0)
   on a global node setting of ^DD("DILOCKTM")=3.
"BLD",6316,1,11,0)
 
"BLD",6316,1,12,0)
   In order to avoid the lock issue in Outpatient Pharmacy, this patch
"BLD",6316,1,13,0)
   modifies all routines that currently use a lock timeout value of less
"BLD",6316,1,14,0)
   than 3 seconds to check for the node ^DD("DILOCKTM") and to use the
"BLD",6316,1,15,0)
   value defined there, otherwise the lock timeout value is set to a
"BLD",6316,1,16,0)
   default value of 3 seconds.
"BLD",6316,1,17,0)
 
"BLD",6316,1,18,0)
2. PSI-06-186  - Changing dispense drug and SIG
"BLD",6316,1,19,0)
   When finishing a new order using the Patient Prescription Processing
"BLD",6316,1,20,0)
   [PSO LM BACKDOOR ORDERS] option, and answering "NO" to the prompt
"BLD",6316,1,21,0)
   "Is this correct? YES//", the software allows the option to edit
"BLD",6316,1,22,0)
   the dispense drug. It allows you to select any active drug from the
"BLD",6316,1,23,0)
   DRUG file (#50) and accept the order even though the entered SIG is
"BLD",6316,1,24,0)
   incorrect. This patch will not list all the active drugs for selection
"BLD",6316,1,25,0)
   during dispense drug edit, but will list only those drugs that are tied
"BLD",6316,1,26,0)
   to that orderable item in the DRUG file (#50).
"BLD",6316,1,27,0)
 
"BLD",6316,1,28,0)
   When the dispense drug is changed the software prompts "Do You want to
"BLD",6316,1,29,0)
   Edit the SIG?  NO//." To read the current SIG you may have to scroll
"BLD",6316,1,30,0)
   the screen up. This patch will now display the current SIG along with
"BLD",6316,1,31,0)
   the prompt "Do You want to Edit the SIG? YES//."
"BLD",6316,1,32,0)
 
"BLD",6316,1,33,0)
   A similar modification is also done in this patch for editing an
"BLD",6316,1,34,0)
   existing prescription and the dispense drug is changed, to display the
"BLD",6316,1,35,0)
   current SIG along with the prompt "Do You want to Edit the SIG? YES//."
"BLD",6316,1,36,0)
 
"BLD",6316,1,37,0)
   When finishing a pending order through the backdoor, the software
"BLD",6316,1,38,0)
   allows the option to edit the orderable item and select a different
"BLD",6316,1,39,0)
   dispense drug, but does not prompt you to change the SIG. This can
"BLD",6316,1,40,0)
   lead to incorrect SIG. This patch will now prompt the question
"BLD",6316,1,41,0)
   "Do You want to Edit the SIG? YES//."
"BLD",6316,1,42,0)
 
"BLD",6316,1,43,0)
3. This patch adds SERVICE REJECT to the current list of selection for
"BLD",6316,1,44,0)
   the Nature of Order prompt.
"BLD",6316,1,45,0)
   Example:
"BLD",6316,1,46,0)
 
"BLD",6316,1,47,0)
   Nature of Order: WRITTEN// ?
"BLD",6316,1,48,0)
   Choose from:
"BLD",6316,1,49,0)
   1            WRITTEN     W
"BLD",6316,1,50,0)
   2            VERBAL     V
"BLD",6316,1,51,0)
   3            TELEPHONED     P
"BLD",6316,1,52,0)
   4            SERVICE CORRECTION     S
"BLD",6316,1,53,0)
   5            POLICY     I
"BLD",6316,1,54,0)
   6            DUPLICATE     D
"BLD",6316,1,55,0)
   12           SERVICE REJECT     R
"BLD",6316,1,56,0)
 
"BLD",6316,1,57,0)
4. PSI-06-184 - Enhancements for No Allergy Assessment
"BLD",6316,1,58,0)
   The following changes are included to make the pharmacist aware/act on
"BLD",6316,1,59,0)
   prescriptions if they're being entered/finished for a patient with no
"BLD",6316,1,60,0)
   allergy assessment:
"BLD",6316,1,61,0)
   a. Within the profile information, display "No Allergy Assessment"
"BLD",6316,1,62,0)
      next to the allergy header (like "NKA" currently shows)
"BLD",6316,1,63,0)
 
"BLD",6316,1,64,0)
   b. At the same spot where checking for bad address, add a check for
"BLD",6316,1,65,0)
      no allergy assessment and provide a message to the user. (When the
"BLD",6316,1,66,0)
      user continues on, he could choose EA to enter allergy information,
"BLD",6316,1,67,0)
      stop with that patient, or continue on with ordering or finishing).
"BLD",6316,1,68,0)
 
"BLD",6316,1,69,0)
   c. On the profile header, on the right side of the line with patient
"BLD",6316,1,70,0)
      name where <A> currently shows in reverse video if the patient has
"BLD",6316,1,71,0)
      any allergy/adverse reaction information on file, show  <NO ALLERGY
"BLD",6316,1,72,0)
      ASSESSMENT> in reverse video if no assessment has been done.
"BLD",6316,1,73,0)
 
"BLD",6316,1,74,0)
   d. If the pharmacist proceeds with drug entry for a patient with no
"BLD",6316,1,75,0)
      allergy assessment, prompt to intervene just as if there had been an
"BLD",6316,1,76,0)
      allergy reaction and treat this like a critical interaction. (i.e.
"BLD",6316,1,77,0)
      require them to choose to continue processing and if so, prompt for
"BLD",6316,1,78,0)
      an intervention.
"BLD",6316,1,79,0)
 
"BLD",6316,1,80,0)
      Note: When flagging is available in backdoor Outpatient Pharmacy for
"BLD",6316,1,81,0)
      pending orders, procedurally sites can choose to flag pending orders
"BLD",6316,1,82,0)
      for patients awaiting an allergy assessment.
"BLD",6316,1,83,0)
 
"BLD",6316,1,84,0)
5. The patient's eligibility will be displayed before prompting for
"BLD",6316,1,85,0)
   patient status when finishing prescriptions or entering new orders (to
"BLD",6316,1,86,0)
   ensure that the proper entry from the RX PATIENT STATUS file (#53) is
"BLD",6316,1,87,0)
   being selected. This is stored in the PATIENT STATUS field (#3) of the
"BLD",6316,1,88,0)
   PHARMACY PATIENT file (#55)):
"BLD",6316,1,89,0)
   a. In the Patient Prescription Processing [PSO LM BACKDOOR ORDERS]
"BLD",6316,1,90,0)
      option, redisplay the eligibility just before prompting for patient
"BLD",6316,1,91,0)
      status.
"BLD",6316,1,92,0)
 
"BLD",6316,1,93,0)
   b. In the Complete Orders from OERR [PSO LMOE FINISH] option, after
"BLD",6316,1,94,0)
      displaying patient name, display eligibility and prompt for patient
"BLD",6316,1,95,0)
      status.
"BLD",6316,1,96,0)
 
"BLD",6316,1,97,0)
   c. In both options, use RX PATIENT STATUS: for the prompt instead of
"BLD",6316,1,98,0)
      PATIENT STATUS:
"BLD",6316,1,99,0)
 
"BLD",6316,1,100,0)
 
"BLD",6316,1,101,0)
Example 1 - Patient Prescription Processing:
"BLD",6316,1,102,0)
Select Action: Next Screen// NO   New Order
"BLD",6316,1,103,0)
 
"BLD",6316,1,104,0)
Eligibility: SERVICE CONNECTED 50% to 100%     SC%: 60
"BLD",6316,1,105,0)
RX PATIENT STATUS: AUTH ABS -96//
"BLD",6316,1,106,0)
 
"BLD",6316,1,107,0)
Example 2 - Complete Orders from OERR:
"BLD",6316,1,108,0)
Select By:  (PA/RT/PR/CL/E): PATIENT// ROUTE
"BLD",6316,1,109,0)
Route:  (W/M/C/E): WINDOW// MAIL
"BLD",6316,1,110,0)
 
"BLD",6316,1,111,0)
 
"BLD",6316,1,112,0)
 
"BLD",6316,1,113,0)
          OPPATIENT,ONE (666-00-0777)
"BLD",6316,1,114,0)
     No Allergy Assessment!
"BLD",6316,1,115,0)
 
"BLD",6316,1,116,0)
Eligibility: NSC
"BLD",6316,1,117,0)
RX PATIENT STATUS: OPT NSC//
"BLD",6316,1,118,0)
 
"BLD",6316,1,119,0)
6. In the Patient Prescription Processing [PSO LM BACKDOOR ORDERS]
"BLD",6316,1,120,0)
   option, if the Patient Update "PU" action is chosen and the PATIENT
"BLD",6316,1,121,0)
   STATUS is changed to a new one, when returning to the option and
"BLD",6316,1,122,0)
   choosing "NO" for New Order, the default PATIENT STATUS displayed is
"BLD",6316,1,123,0)
   the one before the PU change was done. This patch makes a correction
"BLD",6316,1,124,0)
   to refresh the PATIENT STATUS before displaying the default.
"BLD",6316,1,125,0)
 
"BLD",6316,1,126,0)
7. When selecting a patient in the Patient Prescription Processing [PSO
"BLD",6316,1,127,0)
   LM BACKDOOR ORDERS] option or the Complete Orders from OERR [PSO LMOE
"BLD",6316,1,128,0)
   FINISH] option, if Remote Data Interoperability (RDI) is turned on, a
"BLD",6316,1,129,0)
   check has been added to check for the ability to access remote data.
"BLD",6316,1,130,0)
   If a problem has been detected with accessing remote data, the patient
"BLD",6316,1,131,0)
   selection will display "Remote data not available - Only local order
"BLD",6316,1,132,0)
   checks processed." once per patient rather than for each individual
"BLD",6316,1,133,0)
   order.
"BLD",6316,1,134,0)
 
"BLD",6316,1,135,0)
8. If the MAIL STATUS EXPIRATION DATE field (#.05) in the PHARMACY PATIENT
"BLD",6316,1,136,0)
   file (#55) is less than today, the MAIL field (#.03) displays on
"BLD",6316,1,137,0)
   the patient profile as if it is still active. This patch adds the
"BLD",6316,1,138,0)
   display of the MAIL STATUS EXPIRATION DATE field next to the MAIL
"BLD",6316,1,139,0)
   field on the patient profile for MAIL settings of Do Not Mail, Local -
"BLD",6316,1,140,0)
   Regular Mail and Local - Certified Mail if the mail status is expired.
"BLD",6316,1,141,0)
 
"BLD",6316,1,142,0)
9. Following the installation of patch PSO*7*200, a site noticed that 6
"BLD",6316,1,143,0)
   digits of the social security number were printing when using the new
"BLD",6316,1,144,0)
   hidden "RS" action to reprint the signature log. This patch changes it
"BLD",6316,1,145,0)
   to 4 digits to match the rest of the labels.
"BLD",6316,1,146,0)
 
"BLD",6316,1,147,0)
10. In patch PSO*7*200, functionality was provided to use the new
"BLD",6316,1,148,0)
    commercial warning label to send prescriptions to the automated
"BLD",6316,1,149,0)
    filling equipment. One site reported a problem when using the old
"BLD",6316,1,150,0)
    warning labels, that the HEALTH LEVEL SEVEN (HL7) message sent to
"BLD",6316,1,151,0)
    Optifill was causing an error. This happens when the label text length
"BLD",6316,1,152,0)
    is greater than 512 characters. To prevent this error, this patch
"BLD",6316,1,153,0)
    ensures that the label text length sent does not exceed 245 
"BLD",6316,1,154,0)
    characters. If the label text length exceeds 245 characters, then the
"BLD",6316,1,155,0)
    additional text will be parsed and sent in additional messages.
"BLD",6316,4,0)
^9.64PA^^
"BLD",6316,6.3)
9
"BLD",6316,"KRN",0)
^9.67PA^8989.52^19
"BLD",6316,"KRN",.4,0)
.4
"BLD",6316,"KRN",.401,0)
.401
"BLD",6316,"KRN",.402,0)
.402
"BLD",6316,"KRN",.403,0)
.403
"BLD",6316,"KRN",.5,0)
.5
"BLD",6316,"KRN",.84,0)
.84
"BLD",6316,"KRN",3.6,0)
3.6
"BLD",6316,"KRN",3.8,0)
3.8
"BLD",6316,"KRN",9.2,0)
9.2
"BLD",6316,"KRN",9.2,"NM",0)
^9.68A^^
"BLD",6316,"KRN",9.8,0)
9.8
"BLD",6316,"KRN",9.8,"NM",0)
^9.68A^81^55
"BLD",6316,"KRN",9.8,"NM",5,0)
PSOBAI^^0^B9583572
"BLD",6316,"KRN",9.8,"NM",6,0)
PSOBGMG1^^0^B16960246
"BLD",6316,"KRN",9.8,"NM",7,0)
PSOBGMG2^^0^B37417581
"BLD",6316,"KRN",9.8,"NM",8,0)
PSOBGMGR^^0^B62041438
"BLD",6316,"KRN",9.8,"NM",9,0)
PSOBING1^^0^B55027504
"BLD",6316,"KRN",9.8,"NM",10,0)
PSOBINGO^^0^B61813575
"BLD",6316,"KRN",9.8,"NM",11,0)
PSOBSET^^0^B10859246
"BLD",6316,"KRN",9.8,"NM",12,0)
PSOBSET1^^0^B9659651
"BLD",6316,"KRN",9.8,"NM",17,0)
PSOCLUTL^^0^B30326336
"BLD",6316,"KRN",9.8,"NM",24,0)
PSOCPE^^0^B80510322
"BLD",6316,"KRN",9.8,"NM",26,0)
PSODEDT^^0^B14865431
"BLD",6316,"KRN",9.8,"NM",27,0)
PSODELI^^0^B2912116
"BLD",6316,"KRN",9.8,"NM",28,0)
PSODIR1^^0^B72033927
"BLD",6316,"KRN",9.8,"NM",29,0)
PSODLKP^^0^B26284279
"BLD",6316,"KRN",9.8,"NM",30,0)
PSODUE^^0^B7809336
"BLD",6316,"KRN",9.8,"NM",31,0)
PSOELPS2^^0^B39664791
"BLD",6316,"KRN",9.8,"NM",32,0)
PSOEN145^^0^B8700479
"BLD",6316,"KRN",9.8,"NM",33,0)
PSOHELP^^0^B51249011
"BLD",6316,"KRN",9.8,"NM",35,0)
PSOLMPAT^^0^B3240520
"BLD",6316,"KRN",9.8,"NM",36,0)
PSON52^^0^B60158603
"BLD",6316,"KRN",9.8,"NM",37,0)
PSONEW^^0^B28071554
"BLD",6316,"KRN",9.8,"NM",38,0)
PSONRXN^^0^B15266741
"BLD",6316,"KRN",9.8,"NM",39,0)
PSOORED1^^0^B67901232
"BLD",6316,"KRN",9.8,"NM",40,0)
PSOORNE5^^0^B59982805
"BLD",6316,"KRN",9.8,"NM",41,0)
PSOPAT^^0^B4781637
"BLD",6316,"KRN",9.8,"NM",47,0)
PSOPRVW^^0^B35375521
"BLD",6316,"KRN",9.8,"NM",49,0)
PSORN52A^^0^B18015106
"BLD",6316,"KRN",9.8,"NM",50,0)
PSORX1^^0^B60587964
"BLD",6316,"KRN",9.8,"NM",52,0)
PSORXI^^0^B6810533
"BLD",6316,"KRN",9.8,"NM",53,0)
PSOSITED^^0^B6167263
"BLD",6316,"KRN",9.8,"NM",54,0)
PSOSUP^^0^B7482949
"BLD",6316,"KRN",9.8,"NM",55,0)
PSOTEXP1^^0^B64584695
"BLD",6316,"KRN",9.8,"NM",56,0)
PSOTPCEE^^0^B8343556
"BLD",6316,"KRN",9.8,"NM",58,0)
PSOTPRX1^^0^B52223271
"BLD",6316,"KRN",9.8,"NM",60,0)
PSOTALK3^^0^B21440926
"BLD",6316,"KRN",9.8,"NM",61,0)
PSOARCCO^^0^B10741351
"BLD",6316,"KRN",9.8,"NM",62,0)
PSOARCF4^^0^B24899131
"BLD",6316,"KRN",9.8,"NM",63,0)
PSOARCSV^^0^B24597034
"BLD",6316,"KRN",9.8,"NM",64,0)
PSOCPBAK^^0^B43547187
"BLD",6316,"KRN",9.8,"NM",65,0)
PSOPOST7^^0^B43103725
"BLD",6316,"KRN",9.8,"NM",66,0)
PSOPOST8^^0^B28809794
"BLD",6316,"KRN",9.8,"NM",68,0)
PSODRG^^0^B35387370
"BLD",6316,"KRN",9.8,"NM",69,0)
PSOBKDED^^0^B80833683
"BLD",6316,"KRN",9.8,"NM",70,0)
PSODRGN^^0^B12292884
"BLD",6316,"KRN",9.8,"NM",71,0)
PSODIAG^^0^B63073470
"BLD",6316,"KRN",9.8,"NM",72,0)
PSOORNW1^^0^B42982549
"BLD",6316,"KRN",9.8,"NM",73,0)
PSOLMUTL^^0^B10324003
"BLD",6316,"KRN",9.8,"NM",74,0)
PSOORUT2^^0^B61773265
"BLD",6316,"KRN",9.8,"NM",75,0)
PSOVER1^^0^B59047654
"BLD",6316,"KRN",9.8,"NM",76,0)
PSOCAN4^^0^B42203941
"BLD",6316,"KRN",9.8,"NM",77,0)
PSOORED6^^0^B61440766
"BLD",6316,"KRN",9.8,"NM",78,0)
PSOHLD^^0^B49126582
"BLD",6316,"KRN",9.8,"NM",79,0)
PSOHLDI1^^0^B12451392
"BLD",6316,"KRN",9.8,"NM",80,0)
PSOLLLHN^^0^B9172755
"BLD",6316,"KRN",9.8,"NM",81,0)
PSOHLDS2^^0^B67611416
"BLD",6316,"KRN",9.8,"NM","B","PSOARCCO",61)

"BLD",6316,"KRN",9.8,"NM","B","PSOARCF4",62)

"BLD",6316,"KRN",9.8,"NM","B","PSOARCSV",63)

"BLD",6316,"KRN",9.8,"NM","B","PSOBAI",5)

"BLD",6316,"KRN",9.8,"NM","B","PSOBGMG1",6)

"BLD",6316,"KRN",9.8,"NM","B","PSOBGMG2",7)

"BLD",6316,"KRN",9.8,"NM","B","PSOBGMGR",8)

"BLD",6316,"KRN",9.8,"NM","B","PSOBING1",9)

"BLD",6316,"KRN",9.8,"NM","B","PSOBINGO",10)

"BLD",6316,"KRN",9.8,"NM","B","PSOBKDED",69)

"BLD",6316,"KRN",9.8,"NM","B","PSOBSET",11)

"BLD",6316,"KRN",9.8,"NM","B","PSOBSET1",12)

"BLD",6316,"KRN",9.8,"NM","B","PSOCAN4",76)

"BLD",6316,"KRN",9.8,"NM","B","PSOCLUTL",17)

"BLD",6316,"KRN",9.8,"NM","B","PSOCPBAK",64)

"BLD",6316,"KRN",9.8,"NM","B","PSOCPE",24)

"BLD",6316,"KRN",9.8,"NM","B","PSODEDT",26)

"BLD",6316,"KRN",9.8,"NM","B","PSODELI",27)

"BLD",6316,"KRN",9.8,"NM","B","PSODIAG",71)

"BLD",6316,"KRN",9.8,"NM","B","PSODIR1",28)

"BLD",6316,"KRN",9.8,"NM","B","PSODLKP",29)

"BLD",6316,"KRN",9.8,"NM","B","PSODRG",68)

"BLD",6316,"KRN",9.8,"NM","B","PSODRGN",70)

"BLD",6316,"KRN",9.8,"NM","B","PSODUE",30)

"BLD",6316,"KRN",9.8,"NM","B","PSOELPS2",31)

"BLD",6316,"KRN",9.8,"NM","B","PSOEN145",32)

"BLD",6316,"KRN",9.8,"NM","B","PSOHELP",33)

"BLD",6316,"KRN",9.8,"NM","B","PSOHLD",78)

"BLD",6316,"KRN",9.8,"NM","B","PSOHLDI1",79)

"BLD",6316,"KRN",9.8,"NM","B","PSOHLDS2",81)

"BLD",6316,"KRN",9.8,"NM","B","PSOLLLHN",80)

"BLD",6316,"KRN",9.8,"NM","B","PSOLMPAT",35)

"BLD",6316,"KRN",9.8,"NM","B","PSOLMUTL",73)

"BLD",6316,"KRN",9.8,"NM","B","PSON52",36)

"BLD",6316,"KRN",9.8,"NM","B","PSONEW",37)

"BLD",6316,"KRN",9.8,"NM","B","PSONRXN",38)

"BLD",6316,"KRN",9.8,"NM","B","PSOORED1",39)

"BLD",6316,"KRN",9.8,"NM","B","PSOORED6",77)

"BLD",6316,"KRN",9.8,"NM","B","PSOORNE5",40)

"BLD",6316,"KRN",9.8,"NM","B","PSOORNW1",72)

"BLD",6316,"KRN",9.8,"NM","B","PSOORUT2",74)

"BLD",6316,"KRN",9.8,"NM","B","PSOPAT",41)

"BLD",6316,"KRN",9.8,"NM","B","PSOPOST7",65)

"BLD",6316,"KRN",9.8,"NM","B","PSOPOST8",66)

"BLD",6316,"KRN",9.8,"NM","B","PSOPRVW",47)

"BLD",6316,"KRN",9.8,"NM","B","PSORN52A",49)

"BLD",6316,"KRN",9.8,"NM","B","PSORX1",50)

"BLD",6316,"KRN",9.8,"NM","B","PSORXI",52)

"BLD",6316,"KRN",9.8,"NM","B","PSOSITED",53)

"BLD",6316,"KRN",9.8,"NM","B","PSOSUP",54)

"BLD",6316,"KRN",9.8,"NM","B","PSOTALK3",60)

"BLD",6316,"KRN",9.8,"NM","B","PSOTEXP1",55)

"BLD",6316,"KRN",9.8,"NM","B","PSOTPCEE",56)

"BLD",6316,"KRN",9.8,"NM","B","PSOTPRX1",58)

"BLD",6316,"KRN",9.8,"NM","B","PSOVER1",75)

"BLD",6316,"KRN",19,0)
19
"BLD",6316,"KRN",19.1,0)
19.1
"BLD",6316,"KRN",101,0)
101
"BLD",6316,"KRN",409.61,0)
409.61
"BLD",6316,"KRN",771,0)
771
"BLD",6316,"KRN",870,0)
870
"BLD",6316,"KRN",8989.51,0)
8989.51
"BLD",6316,"KRN",8989.52,0)
8989.52
"BLD",6316,"KRN",8994,0)
8994
"BLD",6316,"KRN","B",.4,.4)

"BLD",6316,"KRN","B",.401,.401)

"BLD",6316,"KRN","B",.402,.402)

"BLD",6316,"KRN","B",.403,.403)

"BLD",6316,"KRN","B",.5,.5)

"BLD",6316,"KRN","B",.84,.84)

"BLD",6316,"KRN","B",3.6,3.6)

"BLD",6316,"KRN","B",3.8,3.8)

"BLD",6316,"KRN","B",9.2,9.2)

"BLD",6316,"KRN","B",9.8,9.8)

"BLD",6316,"KRN","B",19,19)

"BLD",6316,"KRN","B",19.1,19.1)

"BLD",6316,"KRN","B",101,101)

"BLD",6316,"KRN","B",409.61,409.61)

"BLD",6316,"KRN","B",771,771)

"BLD",6316,"KRN","B",870,870)

"BLD",6316,"KRN","B",8989.51,8989.51)

"BLD",6316,"KRN","B",8989.52,8989.52)

"BLD",6316,"KRN","B",8994,8994)

"BLD",6316,"QUES",0)
^9.62^^
"BLD",6316,"REQB",0)
^9.611^16^7
"BLD",6316,"REQB",2,0)
PSO*7.0*65^2
"BLD",6316,"REQB",4,0)
PSO*7.0*129^2
"BLD",6316,"REQB",12,0)
PSO*7.0*249^2
"BLD",6316,"REQB",13,0)
PSO*7.0*250^2
"BLD",6316,"REQB",14,0)
PSO*7.0*258^2
"BLD",6316,"REQB",15,0)
PSO*7.0*263^2
"BLD",6316,"REQB",16,0)
PSO*7.0*261^2
"BLD",6316,"REQB","B","PSO*7.0*129",4)

"BLD",6316,"REQB","B","PSO*7.0*249",12)

"BLD",6316,"REQB","B","PSO*7.0*250",13)

"BLD",6316,"REQB","B","PSO*7.0*258",14)

"BLD",6316,"REQB","B","PSO*7.0*261",16)

"BLD",6316,"REQB","B","PSO*7.0*263",15)

"BLD",6316,"REQB","B","PSO*7.0*65",2)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
268^3070629
"PKG",141,22,1,"PAH",1,1,0)
^^155^155^3070629
"PKG",141,22,1,"PAH",1,1,1,0)
This patch is part of the third quarter enhancements release for the
"PKG",141,22,1,"PAH",1,1,2,0)
Outpatient Pharmacy V. 7.0 package.
"PKG",141,22,1,"PAH",1,1,3,0)
 
"PKG",141,22,1,"PAH",1,1,4,0)
1. With the deployment of Cache version 5, it was discovered that the
"PKG",141,22,1,"PAH",1,1,5,0)
   short lock timeout values could generate a lock failure. Patch
"PKG",141,22,1,"PAH",1,1,6,0)
   DI*22*147, which has already been released, provided a solution to
"PKG",141,22,1,"PAH",1,1,7,0)
   resolve this issue and future lock issues.
"PKG",141,22,1,"PAH",1,1,8,0)
 
"PKG",141,22,1,"PAH",1,1,9,0)
   This patch instituted a new default lock timeout of three seconds based
"PKG",141,22,1,"PAH",1,1,10,0)
   on a global node setting of ^DD("DILOCKTM")=3.
"PKG",141,22,1,"PAH",1,1,11,0)
 
"PKG",141,22,1,"PAH",1,1,12,0)
   In order to avoid the lock issue in Outpatient Pharmacy, this patch
"PKG",141,22,1,"PAH",1,1,13,0)
   modifies all routines that currently use a lock timeout value of less
"PKG",141,22,1,"PAH",1,1,14,0)
   than 3 seconds to check for the node ^DD("DILOCKTM") and to use the
"PKG",141,22,1,"PAH",1,1,15,0)
   value defined there, otherwise the lock timeout value is set to a
"PKG",141,22,1,"PAH",1,1,16,0)
   default value of 3 seconds.
"PKG",141,22,1,"PAH",1,1,17,0)
 
"PKG",141,22,1,"PAH",1,1,18,0)
2. PSI-06-186  - Changing dispense drug and SIG
"PKG",141,22,1,"PAH",1,1,19,0)
   When finishing a new order using the Patient Prescription Processing
"PKG",141,22,1,"PAH",1,1,20,0)
   [PSO LM BACKDOOR ORDERS] option, and answering "NO" to the prompt
"PKG",141,22,1,"PAH",1,1,21,0)
   "Is this correct? YES//", the software allows the option to edit
"PKG",141,22,1,"PAH",1,1,22,0)
   the dispense drug. It allows you to select any active drug from the
"PKG",141,22,1,"PAH",1,1,23,0)
   DRUG file (#50) and accept the order even though the entered SIG is
"PKG",141,22,1,"PAH",1,1,24,0)
   incorrect. This patch will not list all the active drugs for selection
"PKG",141,22,1,"PAH",1,1,25,0)
   during dispense drug edit, but will list only those drugs that are tied
"PKG",141,22,1,"PAH",1,1,26,0)
   to that orderable item in the DRUG file (#50).
"PKG",141,22,1,"PAH",1,1,27,0)
 
"PKG",141,22,1,"PAH",1,1,28,0)
   When the dispense drug is changed the software prompts "Do You want to
"PKG",141,22,1,"PAH",1,1,29,0)
   Edit the SIG?  NO//." To read the current SIG you may have to scroll
"PKG",141,22,1,"PAH",1,1,30,0)
   the screen up. This patch will now display the current SIG along with
"PKG",141,22,1,"PAH",1,1,31,0)
   the prompt "Do You want to Edit the SIG? YES//."
"PKG",141,22,1,"PAH",1,1,32,0)
 
"PKG",141,22,1,"PAH",1,1,33,0)
   A similar modification is also done in this patch for editing an
"PKG",141,22,1,"PAH",1,1,34,0)
   existing prescription and the dispense drug is changed, to display the
"PKG",141,22,1,"PAH",1,1,35,0)
   current SIG along with the prompt "Do You want to Edit the SIG? YES//."
"PKG",141,22,1,"PAH",1,1,36,0)
 
"PKG",141,22,1,"PAH",1,1,37,0)
   When finishing a pending order through the backdoor, the software
"PKG",141,22,1,"PAH",1,1,38,0)
   allows the option to edit the orderable item and select a different
"PKG",141,22,1,"PAH",1,1,39,0)
   dispense drug, but does not prompt you to change the SIG. This can
"PKG",141,22,1,"PAH",1,1,40,0)
   lead to incorrect SIG. This patch will now prompt the question
"PKG",141,22,1,"PAH",1,1,41,0)
   "Do You want to Edit the SIG? YES//."
"PKG",141,22,1,"PAH",1,1,42,0)
 
"PKG",141,22,1,"PAH",1,1,43,0)
3. This patch adds SERVICE REJECT to the current list of selection for
"PKG",141,22,1,"PAH",1,1,44,0)
   the Nature of Order prompt.
"PKG",141,22,1,"PAH",1,1,45,0)
   Example:
"PKG",141,22,1,"PAH",1,1,46,0)
 
"PKG",141,22,1,"PAH",1,1,47,0)
   Nature of Order: WRITTEN// ?
"PKG",141,22,1,"PAH",1,1,48,0)
   Choose from:
"PKG",141,22,1,"PAH",1,1,49,0)
   1            WRITTEN     W
"PKG",141,22,1,"PAH",1,1,50,0)
   2            VERBAL     V
"PKG",141,22,1,"PAH",1,1,51,0)
   3            TELEPHONED     P
"PKG",141,22,1,"PAH",1,1,52,0)
   4            SERVICE CORRECTION     S
"PKG",141,22,1,"PAH",1,1,53,0)
   5            POLICY     I
"PKG",141,22,1,"PAH",1,1,54,0)
   6            DUPLICATE     D
"PKG",141,22,1,"PAH",1,1,55,0)
   12           SERVICE REJECT     R
"PKG",141,22,1,"PAH",1,1,56,0)
 
"PKG",141,22,1,"PAH",1,1,57,0)
4. PSI-06-184 - Enhancements for No Allergy Assessment
"PKG",141,22,1,"PAH",1,1,58,0)
   The following changes are included to make the pharmacist aware/act on
"PKG",141,22,1,"PAH",1,1,59,0)
   prescriptions if they're being entered/finished for a patient with no
"PKG",141,22,1,"PAH",1,1,60,0)
   allergy assessment:
"PKG",141,22,1,"PAH",1,1,61,0)
   a. Within the profile information, display "No Allergy Assessment"
"PKG",141,22,1,"PAH",1,1,62,0)
      next to the allergy header (like "NKA" currently shows)
"PKG",141,22,1,"PAH",1,1,63,0)
 
"PKG",141,22,1,"PAH",1,1,64,0)
   b. At the same spot where checking for bad address, add a check for
"PKG",141,22,1,"PAH",1,1,65,0)
      no allergy assessment and provide a message to the user. (When the
"PKG",141,22,1,"PAH",1,1,66,0)
      user continues on, he could choose EA to enter allergy information,
"PKG",141,22,1,"PAH",1,1,67,0)
      stop with that patient, or continue on with ordering or finishing).
"PKG",141,22,1,"PAH",1,1,68,0)
 
"PKG",141,22,1,"PAH",1,1,69,0)
   c. On the profile header, on the right side of the line with patient
"PKG",141,22,1,"PAH",1,1,70,0)
      name where <A> currently shows in reverse video if the patient has
"PKG",141,22,1,"PAH",1,1,71,0)
      any allergy/adverse reaction information on file, show  <NO ALLERGY
"PKG",141,22,1,"PAH",1,1,72,0)
      ASSESSMENT> in reverse video if no assessment has been done.
"PKG",141,22,1,"PAH",1,1,73,0)
 
"PKG",141,22,1,"PAH",1,1,74,0)
   d. If the pharmacist proceeds with drug entry for a patient with no
"PKG",141,22,1,"PAH",1,1,75,0)
      allergy assessment, prompt to intervene just as if there had been an
"PKG",141,22,1,"PAH",1,1,76,0)
      allergy reaction and treat this like a critical interaction. (i.e.
"PKG",141,22,1,"PAH",1,1,77,0)
      require them to choose to continue processing and if so, prompt for
"PKG",141,22,1,"PAH",1,1,78,0)
      an intervention.
"PKG",141,22,1,"PAH",1,1,79,0)
 
"PKG",141,22,1,"PAH",1,1,80,0)
      Note: When flagging is available in backdoor Outpatient Pharmacy for
"PKG",141,22,1,"PAH",1,1,81,0)
      pending orders, procedurally sites can choose to flag pending orders
"PKG",141,22,1,"PAH",1,1,82,0)
      for patients awaiting an allergy assessment.
"PKG",141,22,1,"PAH",1,1,83,0)
 
"PKG",141,22,1,"PAH",1,1,84,0)
5. The patient's eligibility will be displayed before prompting for
"PKG",141,22,1,"PAH",1,1,85,0)
   patient status when finishing prescriptions or entering new orders (to
"PKG",141,22,1,"PAH",1,1,86,0)
   ensure that the proper entry from the RX PATIENT STATUS file (#53) is
"PKG",141,22,1,"PAH",1,1,87,0)
   being selected. This is stored in the PATIENT STATUS field (#3) of the
"PKG",141,22,1,"PAH",1,1,88,0)
   PHARMACY PATIENT file (#55)):
"PKG",141,22,1,"PAH",1,1,89,0)
   a. In the Patient Prescription Processing [PSO LM BACKDOOR ORDERS]
"PKG",141,22,1,"PAH",1,1,90,0)
      option, redisplay the eligibility just before prompting for patient
"PKG",141,22,1,"PAH",1,1,91,0)
      status.
"PKG",141,22,1,"PAH",1,1,92,0)
 
"PKG",141,22,1,"PAH",1,1,93,0)
   b. In the Complete Orders from OERR [PSO LMOE FINISH] option, after
"PKG",141,22,1,"PAH",1,1,94,0)
      displaying patient name, display eligibility and prompt for patient
"PKG",141,22,1,"PAH",1,1,95,0)
      status.
"PKG",141,22,1,"PAH",1,1,96,0)
 
"PKG",141,22,1,"PAH",1,1,97,0)
   c. In both options, use RX PATIENT STATUS: for the prompt instead of
"PKG",141,22,1,"PAH",1,1,98,0)
      PATIENT STATUS:
"PKG",141,22,1,"PAH",1,1,99,0)
 
"PKG",141,22,1,"PAH",1,1,100,0)
 
"PKG",141,22,1,"PAH",1,1,101,0)
Example 1 - Patient Prescription Processing:
"PKG",141,22,1,"PAH",1,1,102,0)
Select Action: Next Screen// NO   New Order
"PKG",141,22,1,"PAH",1,1,103,0)
 
"PKG",141,22,1,"PAH",1,1,104,0)
Eligibility: SERVICE CONNECTED 50% to 100%     SC%: 60
"PKG",141,22,1,"PAH",1,1,105,0)
RX PATIENT STATUS: AUTH ABS -96//
"PKG",141,22,1,"PAH",1,1,106,0)
 
"PKG",141,22,1,"PAH",1,1,107,0)
Example 2 - Complete Orders from OERR:
"PKG",141,22,1,"PAH",1,1,108,0)
Select By:  (PA/RT/PR/CL/E): PATIENT// ROUTE
"PKG",141,22,1,"PAH",1,1,109,0)
Route:  (W/M/C/E): WINDOW// MAIL
"PKG",141,22,1,"PAH",1,1,110,0)
 
"PKG",141,22,1,"PAH",1,1,111,0)
 
"PKG",141,22,1,"PAH",1,1,112,0)
 
"PKG",141,22,1,"PAH",1,1,113,0)
          OPPATIENT,ONE (666-00-0777)
"PKG",141,22,1,"PAH",1,1,114,0)
     No Allergy Assessment!
"PKG",141,22,1,"PAH",1,1,115,0)
 
"PKG",141,22,1,"PAH",1,1,116,0)
Eligibility: NSC
"PKG",141,22,1,"PAH",1,1,117,0)
RX PATIENT STATUS: OPT NSC//
"PKG",141,22,1,"PAH",1,1,118,0)
 
"PKG",141,22,1,"PAH",1,1,119,0)
6. In the Patient Prescription Processing [PSO LM BACKDOOR ORDERS]
"PKG",141,22,1,"PAH",1,1,120,0)
   option, if the Patient Update "PU" action is chosen and the PATIENT
"PKG",141,22,1,"PAH",1,1,121,0)
   STATUS is changed to a new one, when returning to the option and
"PKG",141,22,1,"PAH",1,1,122,0)
   choosing "NO" for New Order, the default PATIENT STATUS displayed is
"PKG",141,22,1,"PAH",1,1,123,0)
   the one before the PU change was done. This patch makes a correction
"PKG",141,22,1,"PAH",1,1,124,0)
   to refresh the PATIENT STATUS before displaying the default.
"PKG",141,22,1,"PAH",1,1,125,0)
 
"PKG",141,22,1,"PAH",1,1,126,0)
7. When selecting a patient in the Patient Prescription Processing [PSO
"PKG",141,22,1,"PAH",1,1,127,0)
   LM BACKDOOR ORDERS] option or the Complete Orders from OERR [PSO LMOE
"PKG",141,22,1,"PAH",1,1,128,0)
   FINISH] option, if Remote Data Interoperability (RDI) is turned on, a
"PKG",141,22,1,"PAH",1,1,129,0)
   check has been added to check for the ability to access remote data.
"PKG",141,22,1,"PAH",1,1,130,0)
   If a problem has been detected with accessing remote data, the patient
"PKG",141,22,1,"PAH",1,1,131,0)
   selection will display "Remote data not available - Only local order
"PKG",141,22,1,"PAH",1,1,132,0)
   checks processed." once per patient rather than for each individual
"PKG",141,22,1,"PAH",1,1,133,0)
   order.
"PKG",141,22,1,"PAH",1,1,134,0)
 
"PKG",141,22,1,"PAH",1,1,135,0)
8. If the MAIL STATUS EXPIRATION DATE field (#.05) in the PHARMACY PATIENT
"PKG",141,22,1,"PAH",1,1,136,0)
   file (#55) is less than today, the MAIL field (#.03) displays on
"PKG",141,22,1,"PAH",1,1,137,0)
   the patient profile as if it is still active. This patch adds the
"PKG",141,22,1,"PAH",1,1,138,0)
   display of the MAIL STATUS EXPIRATION DATE field next to the MAIL
"PKG",141,22,1,"PAH",1,1,139,0)
   field on the patient profile for MAIL settings of Do Not Mail, Local -
"PKG",141,22,1,"PAH",1,1,140,0)
   Regular Mail and Local - Certified Mail if the mail status is expired.
"PKG",141,22,1,"PAH",1,1,141,0)
 
"PKG",141,22,1,"PAH",1,1,142,0)
9. Following the installation of patch PSO*7*200, a site noticed that 6
"PKG",141,22,1,"PAH",1,1,143,0)
   digits of the social security number were printing when using the new
"PKG",141,22,1,"PAH",1,1,144,0)
   hidden "RS" action to reprint the signature log. This patch changes it
"PKG",141,22,1,"PAH",1,1,145,0)
   to 4 digits to match the rest of the labels.
"PKG",141,22,1,"PAH",1,1,146,0)
 
"PKG",141,22,1,"PAH",1,1,147,0)
10. In patch PSO*7*200, functionality was provided to use the new
"PKG",141,22,1,"PAH",1,1,148,0)
    commercial warning label to send prescriptions to the automated
"PKG",141,22,1,"PAH",1,1,149,0)
    filling equipment. One site reported a problem when using the old
"PKG",141,22,1,"PAH",1,1,150,0)
    warning labels, that the HEALTH LEVEL SEVEN (HL7) message sent to
"PKG",141,22,1,"PAH",1,1,151,0)
    Optifill was causing an error. This happens when the label text length
"PKG",141,22,1,"PAH",1,1,152,0)
    is greater than 512 characters. To prevent this error, this patch
"PKG",141,22,1,"PAH",1,1,153,0)
    ensures that the label text length sent does not exceed 245 
"PKG",141,22,1,"PAH",1,1,154,0)
    characters. If the label text length exceeds 245 characters, then the
"PKG",141,22,1,"PAH",1,1,155,0)
    additional text will be parsed and sent in additional messages.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
55
"RTN","PSOARCCO")
0^61^B10741351^B10341300
"RTN","PSOARCCO",1,0)
PSOARCCO ;BHAM ISC/LGH - find rxs that to be archived ; 07/07/92
"RTN","PSOARCCO",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**268**;DEC 1997;Build 9
"RTN","PSOARCCO",3,0)
 S X1=DT,X2=-121 D C^%DTC S %DT(0)=-X
"RTN","PSOARCCO",4,0)
AC S PSOAPG=1,PG=1,X2=-360,X1=DT D C^%DTC S Y=X X ^DD("DD") S %DT("B")=Y
"RTN","PSOARCCO",5,0)
 L +^PSOARC:$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !!,"Archive global locked by another user!",! K PSOALAST,PSOAC,Y,PSOAPG Q 
"RTN","PSOARCCO",6,0)
 W !! S %DT("A")="Archive all scripts which expired on or before: "
"RTN","PSOARCCO",7,0)
DT S %DT="AEXP" D ^%DT G:Y=-1 EXIT S PSOAC=Y
"RTN","PSOARCCO",8,0)
ST G:$D(PSOACRS) RST^PSOARCSV
"RTN","PSOARCCO",9,0)
 S LC=0,LC=$O(^PSOARC(LC)) I $G(LC) W !!,"WARNING!!  There are entries in the ",$P(^PSOARC(0),"^")," file!",! S DIR("?")="^D STQ^ZPSOARCC"
"RTN","PSOARCCO",10,0)
 I $G(LC) S DIR("A")="Do you want to delete these entries ",DIR(0)="YO",DIR("B")="No" D ^DIR G:$D(DIRUT)!('Y) EXIT
"RTN","PSOARCCO",11,0)
 D:$G(LC) KILLARC W !!,"Collecting Rx Information",!
"RTN","PSOARCCO",12,0)
 S ZI=0 F J=1:1 S ZI=$O(^PSRX(ZI)) Q:+ZI'>0  I $D(^PSRX(ZI,0)),$P($G(^(2)),"^",6)]"",$P($G(^(2)),"^",6)'>PSOAC,$P(^(0),"^",2)'="" D COLLECT W "."
"RTN","PSOARCCO",13,0)
 S LC=0,LC=$O(^PSOARC(LC))
"RTN","PSOARCCO",14,0)
 W !!,$S($G(LC):"I'm finished finding things!!",1:"I didn't find anything!!"),$C(7) G EXIT
"RTN","PSOARCCO",15,0)
 ;
"RTN","PSOARCCO",16,0)
COLLECT S PSDFN=+$P(^PSRX(ZI,0),"^",2) I '$D(^DPT(PSDFN,0))#2 Q
"RTN","PSOARCCO",17,0)
 S SSN=$P(^DPT(PSDFN,0),"^",9) Q:SSN=""  S $P(^PSOARC(0),"^",4)=($P(^PSOARC(0),"^",4)+1),$P(^PSOARC(0),"^",3)=ZI
"RTN","PSOARCCO",18,0)
 S ^PSOARC(ZI,0)=ZI_"^"_PSDFN,^PSOARC("B",$P(^DPT(PSDFN,0),"^"),SSN,ZI)="",^PSOARC("C",PSDFN,ZI)=""
"RTN","PSOARCCO",19,0)
 Q
"RTN","PSOARCCO",20,0)
KILLARC ;delete all entries in ^PSOARC
"RTN","PSOARCCO",21,0)
 S DIK="^PSOARC(",DA=0 F  S DA=$O(^PSOARC(DA)) Q:'DA   D ^DIK
"RTN","PSOARCCO",22,0)
 K ^PSOARC("B"),^PSOARC("C"),DA,DIK
"RTN","PSOARCCO",23,0)
 Q
"RTN","PSOARCCO",24,0)
STQ W !,"The entries that are currently in the file should probably be archived before",!,"continuing.  Use the archive 'SAVE' option to write the entries to file or"
"RTN","PSOARCCO",25,0)
 W !,"tape and then return to this option.  If you delete the entries now, this"
"RTN","PSOARCCO",26,0)
 W !,"archive 'FIND' option will re-enter them and then you should use the 'SAVE'",!,"option to archive them.",!
"RTN","PSOARCCO",27,0)
 Q
"RTN","PSOARCCO",28,0)
CONT S DIR("A")="Do you want to continue? ",DIR(0)="Y",DIR("T")=DTIME D ^DIR K DIR G:'Y EXIT ;G:Y EN01^PSOARCS1
"RTN","PSOARCCO",29,0)
 ;
"RTN","PSOARCCO",30,0)
EXIT K PSABS,PSOAC,PSOACP,PSOACT,PSOAF,PSOAM,PSOAPAR,PSOAT,IOP,PSOACPF,X,X1,X2,Y,PSOACPL,PSOACPM,PSPRNP,RFDATE,RFL,RM,ST,ST0,PSOACRS,PSPRCNT,RFL1,PSOAPG,PSOAP,D,J,K,PG,PSDFN,SSZ,Z,ZI,DIR,PSOAC1,%DT,PSOALAST,LC
"RTN","PSOARCCO",31,0)
 K DIRUT,DUOUT,DTOUT
"RTN","PSOARCCO",32,0)
 L -^PSOARC
"RTN","PSOARCCO",33,0)
 Q 
"RTN","PSOARCF4")
0^62^B24899131^B24473080
"RTN","PSOARCF4",1,0)
PSOARCF4 ;BIR/SAB/LGH/LC-ARCHIVING SAVE OPTION ;07/07/92
"RTN","PSOARCF4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**27,130,268**;DEC 1997;Build 9
"RTN","PSOARCF4",3,0)
 ;External reference to ^DPT("SSN" supported by DBIA 10035
"RTN","PSOARCF4",4,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOARCF4",5,0)
AC L +^PSOARC:$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !!!,$C(7),"Archiving is currently in progress on another terminal!...",!!! Q
"RTN","PSOARCF4",6,0)
 G:'+$P($G(^PSOARC(0)),"^",4) EX S PSOACRS="",PG=1,PSOAPG=1,PSOION=ION
"RTN","PSOARCF4",7,0)
 W !!! S DIR("A")=$P(^PSOARC(0),"^",4)_" Rx'S will be archived. Ok to continue Y/N",DIR(0)="YO",DIR("B")="NO" D ^DIR K DIR G EX1:$G(DIRUT),EX1:'Y
"RTN","PSOARCF4",8,0)
EN01 S DIR("A",1)="",DIR("A")="Do you want a hardcopy of your archived prescriptions",DIR("B")="NO",DIR(0)="YO" D ^DIR K DIR G:$D(DIRUT) EX1 G:'Y TDV
"RTN","PSOARCF4",9,0)
PDV S STOP=0 K PSOAP,PSOACPF,PSOACPL,PSOACPM,PSOATNM
"RTN","PSOARCF4",10,0)
 K IOP,POP,%ZIS S %ZIS("A")="Printer Device: ",%ZIS="M" D ^%ZIS I POP S IOP=PSOION D ^%ZIS K PSOION G EX1
"RTN","PSOARCF4",11,0)
 D:$E(IOST)'["P" PDVQ G:STOP END1 S PSOAP=IO,PSOACPF=IOF,PSOACPL=IOSL,PSOACPM=IOM,PSOATNM=1
"RTN","PSOARCF4",12,0)
PDV1 I $D(PSOAP) D  G:$D(DUOUT) END1 G:$D(DTOUT) EX1
"RTN","PSOARCF4",13,0)
 .K DIR S DIR("A")="PRINTOUT HEADER LABEL: ",DIR(0)="FO^1:64",DIR("?",1)="  ...Enter 1 to 64 characters.",DIR("?")="These characters will appear at top of every page of your printout." D ^DIR K DIR S PSOACDS=$G(X) K X
"RTN","PSOARCF4",14,0)
TDV W !! K %ZIS S %ZIS("A")="Host File Server Device: ",%ZIS("B")="",%ZIS("HFSMODE")="RW" D ^%ZIS K %ZIS("A")
"RTN","PSOARCF4",15,0)
 I POP S IOP=PSOION D ^%ZIS K IOP,%ZIS,POP G EX1
"RTN","PSOARCF4",16,0)
 I IOT'="HFS" D ^%ZISC W !,"Must select a HFS device" G TDV
"RTN","PSOARCF4",17,0)
 S PSOAT=IO,PSOABS=IOBS,PSOAF=IOF,PSOAM=IOM,PSOAIO=IO,PSOAIOT=IOT,PSOAPAR=IOPAR,PSOATNM=1
"RTN","PSOARCF4",18,0)
RST ;Invoked from ^PSOARCCO
"RTN","PSOARCF4",19,0)
 W !!,"Recording information" D:$D(PSOAP) HD D:$D(PSOAT) HDT S ZI="" F  S ZI=$O(^PSOARC("B",ZI)) Q:ZI=""  S SSN=0 F PSOK=0:0 S SSN=$O(^PSOARC("B",ZI,SSN)) Q:SSN'>0  D GAT
"RTN","PSOARCF4",20,0)
FILE1 S ZI=0 F J=0:0 S ZI=$O(^PSOARC("B",ZI)) Q:ZI=""  S SSN=0 F PSOK=0:0 S SSN=$O(^PSOARC("B",$G(ZI),SSN)) Q:+SSN'>0  D ARC
"RTN","PSOARCF4",21,0)
 W "!"
"RTN","PSOARCF4",22,0)
 K DA,DFN,I,I1,LMI,PSOABS,PSOAEOT,PSOK,RX0,TA,VAR1,XAR1,XTYPE
"RTN","PSOARCF4",23,0)
 G ^PSOARCF5
"RTN","PSOARCF4",24,0)
 Q
"RTN","PSOARCF4",25,0)
END1 S DIR("A")="Do you wish to continue? Y/N",DIR(0)="YO" D ^DIR K DIR G:$D(DIRUT)!('Y) EXIT^PSOARCCO S STOP=0 G EN01
"RTN","PSOARCF4",26,0)
PDVQ S DIR("A",1)="Are you sure you want to print archived information",DIR("A")="to the device that you are currently on (...this device)",DIR(0)="YO" D ^DIR K DIR S:'Y!($D(DIRUT)) STOP=1 Q
"RTN","PSOARCF4",27,0)
ARC S DA=$O(^DPT("SSN",SSN,0)) Q:+DA'>0  D:$D(PSOAT) ^PSOARCTG D:$D(PSOAT) TAPE1^PSOARCF5 S ZII=0 F JJ=0:0 S ZII=$O(^PSOARC("B",ZI,SSN,ZII)) Q:ZII'>""  D RX,ARCRX
"RTN","PSOARCF4",28,0)
 Q
"RTN","PSOARCF4",29,0)
RX Q:'($D(^PSRX(+ZII,0))#2)  S (RX0,DA)=ZII U IO(0) W "." I $D(PSOAP) U PSOAP D:$Y>(PSOACPL-20) HD1 D ^PSOARX
"RTN","PSOARCF4",30,0)
 I $D(PSOAT) D ^PSOARCCV,TAPE^PSOARCF6
"RTN","PSOARCF4",31,0)
 Q
"RTN","PSOARCF4",32,0)
ARCRX ;Mark Rx as archived in 52 by setting field 36
"RTN","PSOARCF4",33,0)
 N DA,DR,DIE
"RTN","PSOARCF4",34,0)
 S (DA,PSOARCRX,PSOARCDA)=RX0,DR="36////1",DIE="^PSRX(" D PSOL^PSSLOCK(PSOARCRX) S DA=PSOARCDA K PSOARCDA I '$G(PSOMSG) W !!,$C(7),$S($P($G(PSOMSG),"^",2)'="":$P(PSOMSG,"^",2),1:"Entry is being edited by another user!"),! K PSOARCRX,PSOMSG Q
"RTN","PSOARCF4",35,0)
 D ^DIE K DIE D PSOUL^PSSLOCK(PSOARCRX) K PSOMSG,PSOARCRX
"RTN","PSOARCF4",36,0)
 Q
"RTN","PSOARCF4",37,0)
 ;
"RTN","PSOARCF4",38,0)
GAT S NM=ZI,ZII=0,SS=SSN,LL=$L(NM)+$L(SS)+6
"RTN","PSOARCF4",39,0)
 K ^TMP($J,"ZRX") F KK=0:0 S ZII=$O(^PSOARC("B",ZI,SSN,ZII)) Q:+ZII'>0  S ^TMP($J,"ZRX",ZII)="",LL=LL+$L(ZII)+1
"RTN","PSOARCF4",40,0)
 I $D(PSOAP) D
"RTN","PSOARCF4",41,0)
 .U PSOAP D:($Y+(LL\132))>PSOACPL HD W !,NM_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_") - " S ZII=0
"RTN","PSOARCF4",42,0)
 .F KK=1:1 S ZII=$O(^TMP($J,"ZRX",ZII)) Q:+ZII'>0  W:($X+$L(ZII)+1)>(PSOACPM-5) !?($L(NM)+3) W $P(^PSRX(ZII,0),"^"),","
"RTN","PSOARCF4",43,0)
 D:$D(PSOAT) TAP0 Q
"RTN","PSOARCF4",44,0)
HD U PSOAP W @PSOACPF,!!?58,"ARCHIVING INDEX",?120,"PAGE ",PG,!,?62,$E(DT,4,5),"/",$E(DT,6,7),"/",$E(DT,2,3),!! S PG=PG+1
"RTN","PSOARCF4",45,0)
 Q
"RTN","PSOARCF4",46,0)
HD1 ;Invoked from ^PSOARCF3,PSOARCF2
"RTN","PSOARCF4",47,0)
 W @PSOACPF,?(66-($L(PSOACDS)\2)),PSOACDS,?112,$E(DT,4,5),"/",$E(DT,6,7),"/",$E(DT,2,3),?122,"PAGE ",PSOAPG S PSOAPG=PSOAPG+1 W !
"RTN","PSOARCF4",48,0)
 Q
"RTN","PSOARCF4",49,0)
HDT U PSOAT W "&^NEW",! Q
"RTN","PSOARCF4",50,0)
DEVICE W !!,?10,"Device not available, try again later"
"RTN","PSOARCF4",51,0)
 D ^%ZISC G EXIT^PSOARCCO
"RTN","PSOARCF4",52,0)
 Q
"RTN","PSOARCF4",53,0)
TAP0 ; PRINTS INDEX TO FILE
"RTN","PSOARCF4",54,0)
 U PSOAT S VAR1=NM_"%"_SS_"^",ZII=0 F KK=1:1 S ZII=$O(^TMP($J,"ZRX",ZII)) Q:+ZII'>0  D TAP1
"RTN","PSOARCF4",55,0)
 I $L(VAR1)>0 U PSOAT W VAR1,!
"RTN","PSOARCF4",56,0)
 S XAR1="" Q
"RTN","PSOARCF4",57,0)
TAP1 ;PRINT "NAME-RX LIST"
"RTN","PSOARCF4",58,0)
 I ($L(VAR1)+$L($P(^PSRX(ZII,0),"^"))+1)<255 S VAR1=VAR1_$P(^PSRX(ZII,0),"^")_"," Q
"RTN","PSOARCF4",59,0)
 U PSOAT W VAR1,! S VAR1="^"_$P(^PSRX(ZII,0),"^")_"," Q
"RTN","PSOARCF4",60,0)
EX W !!,"THE ",$P(^PSOARC(0),"^",1)," File is empty. Archiving will not be done."
"RTN","PSOARCF4",61,0)
EX1 K PSOACRS,PSOAPG,PG,%MT,DA,DFN,DIR,DIRUT,DTOUT,DUOUT,I,I1,J,JJ,KK,LL,LMI,NM,PG,PSOABS,PSOACDS,PSOACPF,PSOACPL,PSOACPM,PSOACRS,PSOACEOT,PSOAF
"RTN","PSOARCF4",62,0)
 K PSOAM,PSOAP,PSOAPAR,PSOAT,PSOAIO,PSOAIOT,PSOATNM,PSOION,PSOK,RX0,SS,SSN,STOP,TA,VAR1,X,XAR1,XTYPE,Y,ZI,ZII D KVA^VADPT
"RTN","PSOARCF4",63,0)
 L -^PSOARC
"RTN","PSOARCF4",64,0)
 Q
"RTN","PSOARCSV")
0^63^B24597034^B24170983
"RTN","PSOARCSV",1,0)
PSOARCSV ;BIR/SAB/LGH-archiving save option ;07/07/92
"RTN","PSOARCSV",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**27,130,268**;DEC 1997;Build 9
"RTN","PSOARCSV",3,0)
 ;External reference to ^DPT("SSN" supported by DBIA 10035
"RTN","PSOARCSV",4,0)
 ;External references PSOL and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOARCSV",5,0)
AC L +^PSOARC:$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !!!,$C(7),"Archiving is currently in progress on another terminal!...",!!! Q
"RTN","PSOARCSV",6,0)
 G:'+$P($G(^PSOARC(0)),"^",4) EX S PSOACRS="",PG=1,PSOAPG=1,PSOION=ION
"RTN","PSOARCSV",7,0)
 W !!! S DIR("A")=$P(^PSOARC(0),"^",4)_" Rx's will be archived. Ok to continue Y/N",DIR(0)="YO",DIR("B")="NO" D ^DIR K DIR G EX1:$G(DIRUT),EX1:'Y
"RTN","PSOARCSV",8,0)
EN01 S DIR("A",1)="",DIR("A")="Do you want a hardcopy of your archived prescriptions",DIR("B")="NO",DIR(0)="YO" D ^DIR K DIR G:$D(DIRUT) EX1 G:'Y TDV
"RTN","PSOARCSV",9,0)
PDV S STOP=0 K PSOAP,PSOACPF,PSOACPL,PSOACPM,PSOATNM
"RTN","PSOARCSV",10,0)
 K IOP,POP,%ZIS S %ZIS("A")="Printer: ",%ZIS="M" D ^%ZIS I POP S IOP=PSOION D ^%ZIS K PSOION G EX1
"RTN","PSOARCSV",11,0)
 D:$E(IOST)'["P" PDVQ G:STOP END1 S PSOAP=IO,PSOACPF=IOF,PSOACPL=IOSL,PSOACPM=IOM,PSOATNM=1
"RTN","PSOARCSV",12,0)
PDV1 I $D(PSOAP) D  G:$D(DUOUT) END1 G:$D(DTOUT) EX1
"RTN","PSOARCSV",13,0)
 .K DIR S DIR("A")="PRINTOUT HEADER LABEL: ",DIR(0)="FO^1:64",DIR("?",1)="  ...Enter 1 to 64 characters.",DIR("?")="These characters will appear at top of every page of your printout." D ^DIR K DIR S PSOACDS=$G(X) K X
"RTN","PSOARCSV",14,0)
TDV W !! K %ZIS S %ZIS("A")="Tape Drive Device:",%ZIS("B")="" D ^%ZIS K %ZIS("A")
"RTN","PSOARCSV",15,0)
 I POP S IOP=PSOION D ^%ZIS K IOP,%ZIS,POP G EX1
"RTN","PSOARCSV",16,0)
 I IOST'["MAGTAPE" D ^%ZISC W !,"Must select a MAGTAPE device" G TDV
"RTN","PSOARCSV",17,0)
 X ^%ZOSF("MAGTAPE") S PSOAT=IO,PSOABS=IOBS,PSOAF=IOF,PSOAM=IOM,PSOAPAR=IOPAR,PSOATNM=1
"RTN","PSOARCSV",18,0)
RST ;Invoked from ^PSOARCCO
"RTN","PSOARCSV",19,0)
 W !!,"Recording Information" D:$D(PSOAP) HD D:$D(PSOAT) HDT S ZI="" F  S ZI=$O(^PSOARC("B",ZI)) Q:ZI=""  S SSN=0 F PSOK=0:0 S SSN=$O(^PSOARC("B",ZI,SSN)) Q:SSN'>0  D GAT
"RTN","PSOARCSV",20,0)
FILE1 S ZI=0 F J=0:0 S ZI=$O(^PSOARC("B",ZI)) Q:ZI=""  S SSN=0 F PSOK=0:0 S SSN=$O(^PSOARC("B",$G(ZI),SSN)) Q:+SSN'>0  D ARC
"RTN","PSOARCSV",21,0)
 W "!",@%MT("WEL")
"RTN","PSOARCSV",22,0)
 K DA,DFN,I,I1,LMI,PSOABS,PSOAEOT,PSOK,RX0,TA,VAR1,XAR1,XTYPE
"RTN","PSOARCSV",23,0)
 G ^PSOARCS2
"RTN","PSOARCSV",24,0)
 Q
"RTN","PSOARCSV",25,0)
END1 S DIR("A")="Do you wish to continue? Y/N",DIR(0)="YO" D ^DIR K DIR G:$D(DIRUT)!('Y) EXIT^PSOARCCO S STOP=0 G EN01
"RTN","PSOARCSV",26,0)
PDVQ S DIR("A",1)="Are you sure you want to print archived information",DIR("A")="to the device that you are currently on (...this device)",DIR(0)="YO" D ^DIR K DIR S:'Y!($D(DIRUT)) STOP=1 Q
"RTN","PSOARCSV",27,0)
ARC S DA=$O(^DPT("SSN",SSN,0)) Q:+DA'>0  D:$D(PSOAT) ^PSOARCTG D:$D(PSOAT) TAPE1^PSOARCS2 S ZII=0 F JJ=0:0 S ZII=$O(^PSOARC("B",ZI,SSN,ZII)) Q:ZII'>""  D RX,ARCRX
"RTN","PSOARCSV",28,0)
 Q
"RTN","PSOARCSV",29,0)
RX Q:'($D(^PSRX(+ZII,0))#2)  S (RX0,DA)=ZII U IO(0) W "." I $D(PSOAP) U PSOAP D:$Y>(PSOACPL-20) HD1 D ^PSOARX
"RTN","PSOARCSV",30,0)
 I $D(PSOAT) D ^PSOARCCV,TAPE^PSOARCTP
"RTN","PSOARCSV",31,0)
 Q
"RTN","PSOARCSV",32,0)
ARCRX ;Mark Rx as archived in 52 by setting field 36
"RTN","PSOARCSV",33,0)
 N DA,DR,DIE
"RTN","PSOARCSV",34,0)
 S (DA,PSOARCRX,PSOARCDA)=RX0,DR="36////1",DIE="^PSRX(" D PSOL^PSSLOCK(PSOARCRX) S DA=PSOARCDA K PSOARCDA I '$G(PSOMSG) W !!,$C(7),$S($P($G(PSOMSG),"^",2)'="":$P(PSOMSG,"^",2),1:"Entry is being edited by another user!"),! K PSOARCRX,PSOMSG Q
"RTN","PSOARCSV",35,0)
 D ^DIE K DIE D PSOUL^PSSLOCK(PSOARCRX) K PSOMSG,PSOARCRX
"RTN","PSOARCSV",36,0)
 Q
"RTN","PSOARCSV",37,0)
 ;
"RTN","PSOARCSV",38,0)
GAT S NM=ZI,ZII=0,SS=SSN,LL=$L(NM)+$L(SS)+6
"RTN","PSOARCSV",39,0)
 K ^TMP($J,"ZRX") F KK=0:0 S ZII=$O(^PSOARC("B",ZI,SSN,ZII)) Q:+ZII'>0  S ^TMP($J,"ZRX",ZII)="",LL=LL+$L(ZII)+1
"RTN","PSOARCSV",40,0)
 I $D(PSOAP) D
"RTN","PSOARCSV",41,0)
 .U PSOAP D:($Y+(LL\132))>PSOACPL HD W !,NM_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_") - " S ZII=0
"RTN","PSOARCSV",42,0)
 .F KK=1:1 S ZII=$O(^TMP($J,"ZRX",ZII)) Q:+ZII'>0  W:($X+$L(ZII)+1)>(PSOACPM-5) !?($L(NM)+3) W $P(^PSRX(ZII,0),"^"),","
"RTN","PSOARCSV",43,0)
 D:$D(PSOAT) TAP0 Q
"RTN","PSOARCSV",44,0)
HD U PSOAP W @PSOACPF,!!?58,"Archiving Index",?120,"Page "_PG,!,?62,$E(DT,4,5),"/",$E(DT,6,7),"/",$E(DT,2,3),!! S PG=PG+1
"RTN","PSOARCSV",45,0)
 Q
"RTN","PSOARCSV",46,0)
HD1 ;Invoked from ^PSOARCRR,PSOARCR1
"RTN","PSOARCSV",47,0)
 W @PSOACPF,?(66-($L(PSOACDS)\2)),PSOACDS,?112,$E(DT,4,5),"/",$E(DT,6,7),"/",$E(DT,2,3),?122,"Page "_PSOAPG S PSOAPG=PSOAPG+1 W !
"RTN","PSOARCSV",48,0)
 Q
"RTN","PSOARCSV",49,0)
HDT U PSOAT W "&^NEW" Q
"RTN","PSOARCSV",50,0)
DEVICE W !!,?10,"Device not available, try again later!"
"RTN","PSOARCSV",51,0)
 D ^%ZISC G EXIT^PSOARCCO
"RTN","PSOARCSV",52,0)
 Q
"RTN","PSOARCSV",53,0)
TAP0 ;prints index to tape
"RTN","PSOARCSV",54,0)
 U PSOAT S VAR1=NM_"%"_SS_"^",ZII=0 F KK=1:1 S ZII=$O(^TMP($J,"ZRX",ZII)) Q:+ZII'>0  D TAP1
"RTN","PSOARCSV",55,0)
 I $L(VAR1)>0 U PSOAT W VAR1,!
"RTN","PSOARCSV",56,0)
 S XAR1="" Q
"RTN","PSOARCSV",57,0)
TAP1 ;print "name-rx list"
"RTN","PSOARCSV",58,0)
 I ($L(VAR1)+$L($P(^PSRX(ZII,0),"^"))+1)<255 S VAR1=VAR1_$P(^PSRX(ZII,0),"^")_"," Q
"RTN","PSOARCSV",59,0)
 U PSOAT W VAR1,! S VAR1="^"_$P(^PSRX(ZII,0),"^")_"," Q
"RTN","PSOARCSV",60,0)
EX W !!,"THE "_$P(^PSOARC(0),"^",1)_" file is empty.  Archiving will not be done."
"RTN","PSOARCSV",61,0)
EX1 K PSOACRS,PSOAPG,PG,%MT,DA,DFN,DIR,DIRUT,DTOUT,DUOUT,I,I1,J,JJ,KK,LL,LMI,NM,PG,PSOABS,PSOACDS,PSOACPF,PSOACPL,PSOACPM,PSOACRS,PSOACEOT,PSOAF
"RTN","PSOARCSV",62,0)
 K PSOAM,PSOAP,PSOAPAR,PSOAT,PSOATNM,PSOION,PSOK,RX0,SS,SSN,STOP,TA,VAR1,X,XAR1,XTYPE,Y,ZI,ZII D KVA^VADPT
"RTN","PSOARCSV",63,0)
 L -^PSOARC
"RTN","PSOARCSV",64,0)
 Q
"RTN","PSOBAI")
0^5^B9583572^B9257882
"RTN","PSOBAI",1,0)
PSOBAI ;BIR/EJW - BAD ADDRESS PROCESSING ;02/02/2006
"RTN","PSOBAI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**233,258,268**;DEC 1997;Build 9
"RTN","PSOBAI",3,0)
 ;
"RTN","PSOBAI",4,0)
 ;External reference EN^DGREGAED supported by DBIA 4198
"RTN","PSOBAI",5,0)
 ;External reference UPDATE^DGADDUTL supported by DBIA 4886
"RTN","PSOBAI",6,0)
 ;
"RTN","PSOBAI",7,0)
CHKADDR(PSODFN,WARN,UPDATE) ; CHECK ADDRESS BY PATIENT
"RTN","PSOBAI",8,0)
 ;Input: PSODFN - PATIENT file (#2) IEN
"RTN","PSOBAI",9,0)
 ;       WARN - Display warning (optional)
"RTN","PSOBAI",10,0)
 ;       UPDATE - If bad address flagged, prompt to update patient address (optional)
"RTN","PSOBAI",11,0)
 ;If calling from patient selection, if bad, even if there is an active temporary address, prompt to update the address
"RTN","PSOBAI",12,0)
 N PSOBADR,PSOTEMP
"RTN","PSOBAI",13,0)
 I PSODFN="" Q
"RTN","PSOBAI",14,0)
 S PSOBADR=$$BADADR^DGUTL3(PSODFN)
"RTN","PSOBAI",15,0)
 I PSOBADR D
"RTN","PSOBAI",16,0)
 .S PSOTEMP=$$CHKTEMP(PSODFN)
"RTN","PSOBAI",17,0)
 .I $G(WARN) D
"RTN","PSOBAI",18,0)
 ..D WARN1
"RTN","PSOBAI",19,0)
 ..I $G(UPDATE) D UPDATE Q
"RTN","PSOBAI",20,0)
 ..D PAUSE
"RTN","PSOBAI",21,0)
 Q
"RTN","PSOBAI",22,0)
 ;
"RTN","PSOBAI",23,0)
CHKRX(PSORX) ;CHECK ADDRESS BY RX
"RTN","PSOBAI",24,0)
 ;Input: PSORX - PRESCRIPTION file (#52) IEN
"RTN","PSOBAI",25,0)
 ;Output: PSOBADR - Bad Address Indicator_"^"_temporary address or not
"RTN","PSOBAI",26,0)
 N PSOBADR,PSODFN,PSOTEMP
"RTN","PSOBAI",27,0)
 S PSOBADR=""
"RTN","PSOBAI",28,0)
 I PSORX="" Q 0
"RTN","PSOBAI",29,0)
 S PSODFN=$P($G(^PSRX(PSORX,0)),"^",2) I PSODFN="" Q 0
"RTN","PSOBAI",30,0)
 S PSOBADR=$$BADADR^DGUTL3(PSODFN)
"RTN","PSOBAI",31,0)
 I PSOBADR S PSOTEMP=$$CHKTEMP(PSODFN)
"RTN","PSOBAI",32,0)
 S PSOBADR=PSOBADR_"^"_$G(PSOTEMP)
"RTN","PSOBAI",33,0)
 Q PSOBADR
"RTN","PSOBAI",34,0)
 ;
"RTN","PSOBAI",35,0)
WARN1 ;
"RTN","PSOBAI",36,0)
 W !!,?8,"WARNING: The patient address is indicated as a bad"
"RTN","PSOBAI",37,0)
 W !,?17,"address (",$S(PSOBADR=1:"UNDELIVERABLE",PSOBADR=2:"HOMELESS",1:"OTHER"),")."
"RTN","PSOBAI",38,0)
 I $G(PSOTEMP) W !,?17,"* Temporary address is active *" Q
"RTN","PSOBAI",39,0)
 W !,?17,"Medication will not be mailed to"
"RTN","PSOBAI",40,0)
 W !,?17,"the patient until the address has been"
"RTN","PSOBAI",41,0)
 W !,?17,"corrected.",!
"RTN","PSOBAI",42,0)
 Q
"RTN","PSOBAI",43,0)
CHKTEMP(PSODFN) ; see if active temporary address
"RTN","PSOBAI",44,0)
 ;Input: PSODFN - PATIENT file (#2) IEN
"RTN","PSOBAI",45,0)
 N DFN,VAPA
"RTN","PSOBAI",46,0)
 S DFN=PSODFN,PSOTEMP=0
"RTN","PSOBAI",47,0)
 D 6^VADPT I +VAPA(9) S PSOTEMP=1
"RTN","PSOBAI",48,0)
 Q PSOTEMP
"RTN","PSOBAI",49,0)
 ;
"RTN","PSOBAI",50,0)
UPDATE ;
"RTN","PSOBAI",51,0)
 N PSOSEL
"RTN","PSOBAI",52,0)
 I '$D(PSOPAR) D ^PSOLSET
"RTN","PSOBAI",53,0)
 I '$P($G(PSOPAR),"^",22),'$D(^XUSEC("PSO ADDRESS UPDATE",+$G(DUZ))) D PAUSE Q
"RTN","PSOBAI",54,0)
 K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to update the address/phone"
"RTN","PSOBAI",55,0)
 D ^DIR K DIR
"RTN","PSOBAI",56,0)
 I Y'=1 Q
"RTN","PSOBAI",57,0)
 L +^DPT(PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T D MSG,PAUSE Q
"RTN","PSOBAI",58,0)
 K DIR S DIR(0)="SAO^P:PERMANENT;T:TEMPORARY;B:BOTH"
"RTN","PSOBAI",59,0)
 S DIR("A")=" Update (P)ermanent address, (T)emporary, or (B)oth: "
"RTN","PSOBAI",60,0)
 S DIR("B")="BOTH" D ^DIR
"RTN","PSOBAI",61,0)
 I $D(DIRUT) G ULK
"RTN","PSOBAI",62,0)
 S PSOSEL=Y
"RTN","PSOBAI",63,0)
 I PSOSEL="P"!(PSOSEL="B") D
"RTN","PSOBAI",64,0)
 .;D UPDATE^DGADDUTL(PSODFN,"PERM") - THIS CALL CLEARS BAI FLAG INAPPROPRIATELY SO USE FOLLOWING TO UPDATE PERMANENT ADDRESS/PHONE INSTEAD 5/29/06
"RTN","PSOBAI",65,0)
 .N PSOFLG
"RTN","PSOBAI",66,0)
 .S PSOFLG(1)=1 D EN^DGREGAED(PSODFN,.PSOFLG) W !
"RTN","PSOBAI",67,0)
 I PSOSEL="P" D ULK Q
"RTN","PSOBAI",68,0)
 I PSOSEL="B"!(PSOSEL="T") D UPDATE^DGADDUTL(PSODFN,"TEMP"),ULK,PAUSE
"RTN","PSOBAI",69,0)
 Q
"RTN","PSOBAI",70,0)
ULK ;
"RTN","PSOBAI",71,0)
 L -^DPT(PSODFN)
"RTN","PSOBAI",72,0)
 Q
"RTN","PSOBAI",73,0)
 ;
"RTN","PSOBAI",74,0)
PAUSE ;
"RTN","PSOBAI",75,0)
 W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOBAI",76,0)
 Q
"RTN","PSOBAI",77,0)
 ;
"RTN","PSOBAI",78,0)
MSG ;
"RTN","PSOBAI",79,0)
 S VALMSG="Patient Data is being edited by another user!"
"RTN","PSOBAI",80,0)
 Q
"RTN","PSOBAI",81,0)
 ;
"RTN","PSOBGMG1")
0^6^B16960246^B16058926
"RTN","PSOBGMG1",1,0)
PSOBGMG1 ;BHAM ISC/LC - BINGO BOARD MANAGER (CONT'D) ; 12/06/94
"RTN","PSOBGMG1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,22,60,268**;DEC 1997;Build 9
"RTN","PSOBGMG1",3,0)
INDX ;Re-index "ANAM" & "BA" X-REF
"RTN","PSOBGMG1",4,0)
 N DA,DIE,DR,MNY,MRX,NNM,ONM,PTR
"RTN","PSOBGMG1",5,0)
 F EN=0:0  S EN=$O(^PS(52.11,"ANAM",ADA,NAME,EN)) Q:'EN  D
"RTN","PSOBGMG1",6,0)
 .I '$D(^PS(52.11,EN)) K ^PS(52.11,"ANAM",ADA,NAME,EN) Q
"RTN","PSOBGMG1",7,0)
 .S ONM=$P(^PS(52.11,EN,1),"^"),MNY=$P(^PS(52.11,EN,1),"^",3),MRX=$P(^PS(52.11,EN,1),"^",4)
"RTN","PSOBGMG1",8,0)
 .S PTR=$P(^PS(52.11,EN,0),"^"),NNM=$P(^DPT(PTR,0),"^") I NNM'=ONM D
"RTN","PSOBGMG1",9,0)
 ..K ^PS(52.11,"ANAM",ADA,NAME,EN)
"RTN","PSOBGMG1",10,0)
 ..S ^PS(52.11,"ANAM",ADA,MNY_MRX_" "_NNM,EN)=""
"RTN","PSOBGMG1",11,0)
 ..S DA=EN,DR="8////"_NNM_"",DIE="^PS(52.11," L +^PS(52.11,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  W !!,$C(7),ONM_" is being edited!",! Q
"RTN","PSOBGMG1",12,0)
 ..D ^DIE K DIE L -^PS(52.11,DA)
"RTN","PSOBGMG1",13,0)
 Q
"RTN","PSOBGMG1",14,0)
WAIT ;compute/compare avg and normal wait times
"RTN","PSOBGMG1",15,0)
 S AWT=0
"RTN","PSOBGMG1",16,0)
 I $G(^PS(59.2,DT,1,PSOSITE,0)) D NOW^%DTC S BBH=$E($P(%,".",2),1,2),BBM=$E($P(%,".",2),3,4) D
"RTN","PSOBGMG1",17,0)
 .S:$G(BBM)>30 BBH=BBH+1 S:BBH'>9 AWT=0
"RTN","PSOBGMG1",18,0)
 .I $G(BBH)=10 S WTT=($P(^PS(59.2,DT,1,PSOSITE,0),"^",5)+$P(^(0),"^",7)),NUM=($P(^(0),"^",4)+$P(^(0),"^",6)) S:$G(NUM) AWT=WTT/NUM
"RTN","PSOBGMG1",19,0)
 .I $G(BBH)=11 S WTT=($P(^PS(59.2,DT,1,PSOSITE,0),"^",7)+$P(^(0),"^",9)),NUM=($P(^(0),"^",6)+$P(^(0),"^",8)) S:$G(NUM) AWT=WTT/NUM
"RTN","PSOBGMG1",20,0)
 .I $G(BBH)=12 S WTT=($P(^PS(59.2,DT,1,PSOSITE,0),"^",9)+$P(^(0),"^",11)),NUM=($P(^(0),"^",8)+$P(^(0),"^",10)) S:$G(NUM) AWT=WTT/NUM
"RTN","PSOBGMG1",21,0)
 .I $G(BBH)=13 S WTT=($P(^PS(59.2,DT,1,PSOSITE,0),"^",11)+$P(^(0),"^",13)),NUM=($P(^(0),"^",10)+$P(^(0),"^",12)) S:$G(NUM) AWT=WTT/NUM
"RTN","PSOBGMG1",22,0)
 .I $G(BBH)=14 S WTT=($P(^PS(59.2,DT,1,PSOSITE,0),"^",13)+$P(^(0),"^",15)),NUM=($P(^(0),"^",12)+$P(^(0),"^",14)) S:$G(NUM) AWT=WTT/NUM
"RTN","PSOBGMG1",23,0)
 .I $G(BBH)=15 S WTT=($P(^PS(59.2,DT,1,PSOSITE,0),"^",15)+$P(^(0),"^",17)),NUM=$P(^(0),"^",14)+$P(^(0),"^",16) S:$G(NUM) AWT=WTT/NUM
"RTN","PSOBGMG1",24,0)
 .I $G(BBH)=16 S WTT=($P(^PS(59.2,DT,1,PSOSITE,0),"^",17)+$P(^(0),"^",19)),NUM=($P(^(0),"^",16)+$P(^(0),"^",18)) S:$G(NUM) AWT=WTT/NUM
"RTN","PSOBGMG1",25,0)
 .I $G(BBH)=17 S WTT=($P(^PS(59.2,DT,1,PSOSITE,0),"^",19)+$P(^(0),"^",21)),NUM=($P(^(0),"^",18)+$P(^(0),"^",20)) S:$G(NUM) AWT=WTT/NUM
"RTN","PSOBGMG1",26,0)
 .S:$G(BBH)>18 AWT=0
"RTN","PSOBGMG1",27,0)
 S:AWT["." AWT2=$P(AWT,".",2),AWT=$P(AWT,".") S:$E($G(AWT2))'<5 AWT=AWT+1
"RTN","PSOBGMG1",28,0)
 S TTX=$S($G(AWT)'>$G(NWT):"NORMAL WAITING TIME IS "_NWT_" MINUTES",$G(AWT)>$G(NWT):"AVERAGE WAITING TIME IS "_AWT_" MINUTES",1:"")
"RTN","PSOBGMG1",29,0)
 Q
"RTN","PSOBGMG1",30,0)
DEV ;select device
"RTN","PSOBGMG1",31,0)
 K NODV N DA,DR,DIC I '$D(DEV),($P($G(^PS(59.3,ADA,0)),"^",4)'="") D
"RTN","PSOBGMG1",32,0)
 .S DEV=$P($G(^PS(59.3,ADA,0)),"^",4)
"RTN","PSOBGMG1",33,0)
 .S DIC="^%ZIS(1,",DA=DEV,DR=".01;3",DIQ="DPTR",DIQ(0)="I" D EN^DIQ1
"RTN","PSOBGMG1",34,0)
 .S DEV=$G(DPTR(3.5,DA,.01,DIQ(0))),DEVSB=$G(DPTR(3.5,DA,3,DIQ(0)))
"RTN","PSOBGMG1",35,0)
 .S DIC="^%ZIS(2,",DA=DEVSB,DR=".01",DIQ="DEVSB1",DIQ(0)="I" D EN^DIQ1
"RTN","PSOBGMG1",36,0)
 I $D(DEV) S %ZIS("B")=DEV,%ZIS("S")="I $E($G(DEVSB1(3.2,DA,.01,DIQ(0))),1,4)=""C-VT""",%ZIS="Q" D ^%ZIS S DV=ION I POP S NODV=1 Q
"RTN","PSOBGMG1",37,0)
 I '$D(DEV) S %ZIS="LQ",%ZIS("S")="I $E($G(^%ZIS(2,+$G(^(""SUBTYPE"")),0)),1,4)=""C-VT""" D ^%ZIS S DV=ION I POP S NODV=1 Q
"RTN","PSOBGMG1",38,0)
 I $G(IOST)'["C-VT" W !,$C(7),"Improper device selected. Try again!",! G DEV
"RTN","PSOBGMG1",39,0)
 K DPTR,DEVSB,DEVSB1,DIQ
"RTN","PSOBGMG1",40,0)
 I $D(IO("Q")) D QUE,^%ZISC Q
"RTN","PSOBGMG1",41,0)
 U IO D:$G(TCK)'="T" ANAME^PSOBGMGR D:$G(TCK)="T" TICKET^PSOBGMGR D ^%ZISC
"RTN","PSOBGMG1",42,0)
 Q
"RTN","PSOBGMG1",43,0)
QUE ;que job
"RTN","PSOBGMG1",44,0)
 S (ZTSAVE("PSOSITE"),ZTSAVE("DEV"),ZTSAVE("ZV"),ZTSAVE("ZH"),ZTSAVE("PSOUT"),ZTSAVE("FLG"),ZTSAVE("TOP"),ZTSAVE("BOT"),ZTSAVE("VOFF"))=""
"RTN","PSOBGMG1",45,0)
 S (ZTSAVE("VON"),ZTSAVE("COLM"),ZTSAVE("DWT"),ZTSAVE("NWT"),ZTSAVE("ADA"),ZTSAVE("FTX"),ZTSAVE("STOP"),ZTSAVE("TCK"))=""
"RTN","PSOBGMG1",46,0)
 S ZTIO=DV,ZTRTN=$S($G(TCK)'="T":"ANAME^PSOBGMGR",1:"TICKET^PSOBGMGR"),ZTDESC="Run Bingo Board Display"
"RTN","PSOBGMG1",47,0)
 D ^%ZTLOAD
"RTN","PSOBGMG1",48,0)
 I $D(ZTSK) S TASK=ZTSK D
"RTN","PSOBGMG1",49,0)
 .S DA=ADA,DR="15////"_TASK_"",DIE="^PS(59.3," L +^PS(59.3,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  W !!,$C(7),"File is being edited!",! Q
"RTN","PSOBGMG1",50,0)
 .D ^DIE K DIE,DR L -^PS(59.3,DA)
"RTN","PSOBGMG1",51,0)
 I $D(ZTSK)[0 W !!?5,"Auto-start aborted!"
"RTN","PSOBGMG1",52,0)
 E  W !!?5,"Bingo Board has been queued!"
"RTN","PSOBGMG1",53,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOBGMG1",54,0)
 D HOME^%ZIS
"RTN","PSOBGMG1",55,0)
 Q
"RTN","PSOBGMG2")
0^7^B37417581^B35327901
"RTN","PSOBGMG2",1,0)
PSOBGMG2 ;BHAM ISC/LC - bingo board manager (cont'd) ; 06/19/96
"RTN","PSOBGMG2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,268**;DEC 1997;Build 9
"RTN","PSOBGMG2",3,0)
 ;
"RTN","PSOBGMG2",4,0)
ASTART ;
"RTN","PSOBGMG2",5,0)
 S DGP=0 F  S DGP=$O(^PS(59.3,DGP)) Q:'DGP  I $P($G(^PS(59.3,DGP,3)),"^")=1,$P($G(^(3)),"^",3)'="" D
"RTN","PSOBGMG2",6,0)
 .S X=DT_"."_$P($P(^PS(59.3,DGP,3),"^",3),".",2) D H^%DTC S ZTDTH=%H_","_%T D ASTART1
"RTN","PSOBGMG2",7,0)
 K BOT,COLM,DEV,DEV1,DEVSB,DGP,DWT,FLG,FTX,NWT,PSOUT,STOP,TASK,TCK,TOP,VOFF,VON,DIC,DIQ,DA,DR,DPTR
"RTN","PSOBGMG2",8,0)
 K ZH,ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTRTN,ZTSAVE,ZTSK,ZV,%H,%T,%Y
"RTN","PSOBGMG2",9,0)
 Q
"RTN","PSOBGMG2",10,0)
ASTART1 ;start via Taskman
"RTN","PSOBGMG2",11,0)
 S (ASTRT,ZV,ZH,PSOUT,FLG)=0,PSOSITE=$P(^PS(59.3,DGP,3),"^",8)
"RTN","PSOBGMG2",12,0)
 S:$P($G(^PS(59.3,DGP,0)),"^",4)'="" DEV=$P($G(^PS(59.3,DGP,0)),"^",4) I '$D(DEV) S ASTRT=3 Q
"RTN","PSOBGMG2",13,0)
 S DIC="^%ZIS(1,",DA=DEV,DR=".01;3",DIQ="DPTR",DIQ(0)="I" D EN^DIQ1
"RTN","PSOBGMG2",14,0)
 S DEV1=$G(DPTR(3.5,DA,.01,DIQ(0))),DEVSB=$G(DPTR(3.5,DA,3,DIQ(0))) I '$D(DEV1) S ASTRT=3 Q
"RTN","PSOBGMG2",15,0)
 S DEL2=1 D DEL
"RTN","PSOBGMG2",16,0)
 S IOST(0)=$G(DEVSB) S X="IODHLT;IODHLB;IORVOFF;IORVON" D ENDR^%ZISS S TOP=IODHLT,BOT=IODHLB,VOFF=IORVOFF,VON=IORVON K IODHLT,IODHLB,IORVOFF,IORVON,DIC
"RTN","PSOBGMG2",17,0)
 S COLM=$P($G(^PS(59.3,DGP,3)),"^",5),DWT=$P($G(^(3)),"^",6),NWT=$P($G(^(3)),"^",7)
"RTN","PSOBGMG2",18,0)
 S ADA=DGP,FTX="PRESCRIPTIONS ARE READY FOR:"
"RTN","PSOBGMG2",19,0)
 S ^PS(59.3,DGP,"STOP")=0,STOP=0 S TCK=$P(^PS(59.3,DGP,0),"^",2)
"RTN","PSOBGMG2",20,0)
 S (ZTSAVE("PSOSITE"),ZTSAVE("DEV1"),ZTSAVE("DGP"),ZTSAVE("ASTRT"),ZTSAVE("ZV"),ZTSAVE("ZH"),ZTSAVE("PSOUT"),ZTSAVE("FLG"),ZTSAVE("TOP"),ZTSAVE("BOT"),ZTSAVE("VOFF"))=""
"RTN","PSOBGMG2",21,0)
 S (ZTSAVE("VON"),ZTSAVE("COLM"),ZTSAVE("DWT"),ZTSAVE("NWT"),ZTSAVE("ADA"),ZTSAVE("FTX"),ZTSAVE("STOP"),ZTSAVE("TCK"))=""
"RTN","PSOBGMG2",22,0)
 S ZTIO=DEV1,ZTRTN=$S($G(TCK)'="T":"ANAME^PSOBGMGR",1:"TICKET^PSOBGMGR"),ZTDESC="Run Bingo Board Display"
"RTN","PSOBGMG2",23,0)
 D ^%ZTLOAD I $D(ZTSK) S TASK=ZTSK D
"RTN","PSOBGMG2",24,0)
 .S DA=ADA,DR="15////"_TASK_"",DIE="^PS(59.3," L +^PS(59.3,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  W !!,$C(7),"File is being edited!",! Q
"RTN","PSOBGMG2",25,0)
 .D ^DIE K DIE,DR L -^PS(59.3,DA)
"RTN","PSOBGMG2",26,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOBGMG2",27,0)
 Q
"RTN","PSOBGMG2",28,0)
ASTOP ;
"RTN","PSOBGMG2",29,0)
 ;stop and purge
"RTN","PSOBGMG2",30,0)
 S ZTSK=$P(^PS(59.3,ADA,3),"^",9) D DQ^%ZTLOAD S $P(^PS(59.3,ADA,3),"^",9)=""
"RTN","PSOBGMG2",31,0)
 Q
"RTN","PSOBGMG2",32,0)
DEL ;Del T-1's in 52.11
"RTN","PSOBGMG2",33,0)
 I $G(DEL2) D
"RTN","PSOBGMG2",34,0)
 .S DIK="^PS(52.11,",DA=0 F  S DA=$O(^PS(52.11,DA)) Q:'DA  D:$P($G(^PS(52.11,DA,0)),"^",3)=DGP ^DIK
"RTN","PSOBGMG2",35,0)
 .K DIK,DA
"RTN","PSOBGMG2",36,0)
 S DIK="^PS(52.11," F DEL=0:0 S DEL=$O(^PS(52.11,DEL)) Q:'DEL  D
"RTN","PSOBGMG2",37,0)
 .S DEL1=$P($P($G(^(DEL,0)),"^",5),".") I $G(DEL1)<DT S DA=DEL D ^DIK
"RTN","PSOBGMG2",38,0)
 K DIK,DEL,DEL1,DEL2
"RTN","PSOBGMG2",39,0)
 Q
"RTN","PSOBGMG2",40,0)
INIT ;init auto-start
"RTN","PSOBGMG2",41,0)
 S LL=0 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOSITE) Q
"RTN","PSOBGMG2",42,0)
 W ! S DIR(0)="Y",DIR("A")="You want to edit Display Group(s) Start/Stop times",DIR("?")="Enter 'Y' for Yes or 'N' for No.",DIR("B")="NO"
"RTN","PSOBGMG2",43,0)
 D ^DIR G:$G(DIRUT) INIX I $G(Y)'=1 G INIJB1
"RTN","PSOBGMG2",44,0)
INIT1 S DIC="^PS(59.3,",DIC(0)="AEQOZ",DIC("S")="I $P($G(^(0)),U,4)'="""""
"RTN","PSOBGMG2",45,0)
 D ^DIC G:$D(DTOUT)!$D(DUOUT) INIX
"RTN","PSOBGMG2",46,0)
 G:$G(LL)=0&($G(Y)<0) INIX G:$G(LL)>0&($G(Y)<0) INIJ
"RTN","PSOBGMG2",47,0)
 S DA=+Y K Y,DIC
"RTN","PSOBGMG2",48,0)
STRTM S BSTRT=$P(^PS(59.3,DA,3),"^",3) I $G(BSTRT) D
"RTN","PSOBGMG2",49,0)
 .S BSTRT=$P(BSTRT,".",2),APM=$S($G(BSTRT)>1200:"PM",1:"AM")
"RTN","PSOBGMG2",50,0)
 .I $G(BSTRT)'<1300 S BSTRT1=+$E(BSTRT,1,2)-12_":"_$E(BSTRT,3,4)_APM
"RTN","PSOBGMG2",51,0)
 .I $G(BSTRT)>1200,$G(BSTRT)<1300 S BSTRT1=+$E(BSTRT,1,2)_":"_$E(BSTRT,3,4)_"PM"
"RTN","PSOBGMG2",52,0)
 .I $G(BSTRT)<1200 S BSTRT1=+$E(BSTRT,1,2)_":"_$E(BSTRT,3,4)_APM
"RTN","PSOBGMG2",53,0)
 S DIR(0)="F^1:7^K:X'?1.2N1"":""2N.A X"
"RTN","PSOBGMG2",54,0)
 S DIR("A")="Enter Start Time" S:$G(BSTRT1) DIR("B")=BSTRT1
"RTN","PSOBGMG2",55,0)
 S DIR("?",1)="Enter time as HH:MM in 12 hour format (For example, '8:00' or '8:00AM)"
"RTN","PSOBGMG2",56,0)
 S DIR("?")="You must enter 'PM' for time that is after 12:00 noon."
"RTN","PSOBGMG2",57,0)
 D ^DIR G:$D(DIRUT) INIX
"RTN","PSOBGMG2",58,0)
 I $P(Y,":")>12 W !?5,$C(7),"Time must be in 12 hour format",! G STRTM
"RTN","PSOBGMG2",59,0)
 I $L($P(Y,":"))=1 S Y="0"_Y
"RTN","PSOBGMG2",60,0)
 I $G(Y)["AM" S YY=$E(Y,1,5),STRTM1=DT_"."_$P(YY,":")_$E($P(YY,":",2),1,2)
"RTN","PSOBGMG2",61,0)
 I $G(Y)["PM" S YY=$E(Y,1,5),STRTM=$P(YY,":")_$E($P(YY,":",2),1,2) S:STRTM'<1200 STRTM1=DT_"."_STRTM S:STRTM<1200 STRTM=STRTM+1200,STRTM1=DT_"."_STRTM
"RTN","PSOBGMG2",62,0)
 I $G(Y)'["AM"&($G(Y)'["PM") S YY=$E(Y,1,5),STRTM1=DT_"."_$P(YY,":")_$E($P(YY,":",2),1,2)
"RTN","PSOBGMG2",63,0)
 I $G(EDT) S DIE="^PS(59.3,",DR="9////"_STRTM1_"" L +^PS(59.3,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  W !!,$C(7),Y(0,0)," is being edited!",! K EDT Q
"RTN","PSOBGMG2",64,0)
 I $G(EDT) D ^DIE L -^PS(59.3,DA) I $G(DIRUT)!($G(X)="") K EDT G EDTEX
"RTN","PSOBGMG2",65,0)
STPTM K DIR("B"),Y,YY S BSTOP=$P(^PS(59.3,DA,3),"^",4) I $G(BSTOP) D
"RTN","PSOBGMG2",66,0)
 .S BSTOP=$P(BSTOP,".",2),APM=$S($G(BSTOP)>1200:"PM",1:"AM")
"RTN","PSOBGMG2",67,0)
 .I $G(BSTOP)'<1300 S BSTOP1=+$E(BSTOP,1,2)-12_":"_$E(BSTOP,3,4)_APM
"RTN","PSOBGMG2",68,0)
 .I $G(BSTOP)>1200,$G(BSTOP)<1300 S BSTOP1=+$E(BSTOP,1,2)_":"_$E(BSTOP,3,4)_"PM"
"RTN","PSOBGMG2",69,0)
 .I $G(BSTOP)<1200 S BSTOP1=+$E(BSTOP,1,2)_":"_$E(BSTOP,3,4)_APM
"RTN","PSOBGMG2",70,0)
 S DIR(0)="F^1:7^K:X'?1.2N1"":""2N.A X"
"RTN","PSOBGMG2",71,0)
 S DIR("A")="Enter Stop Time" S:$G(BSTOP1) DIR("B")=BSTOP1
"RTN","PSOBGMG2",72,0)
 S DIR("?",1)="Enter time as HH:MM in 12 hour format (For example, '8:00' or '8:00AM)"
"RTN","PSOBGMG2",73,0)
 S DIR("?")="You must enter 'AM' for time that is before 12:00 noon."
"RTN","PSOBGMG2",74,0)
 D ^DIR G:$D(DIRUT) INIX
"RTN","PSOBGMG2",75,0)
 I $P(Y,":")>12 W !?5,$C(7),"Time must be in 12 hour format",! G STPTM
"RTN","PSOBGMG2",76,0)
 I $L($P(Y,":"))=1 S Y="0"_Y
"RTN","PSOBGMG2",77,0)
 I $G(Y)["AM" S YY=$E(Y,1,5),STPTM1=DT_"."_$P(YY,":")_$E($P(YY,":",2),1,2)
"RTN","PSOBGMG2",78,0)
 I $G(Y)["PM" S YY=$E(Y,1,5),STPTM=$P(YY,":")_$E($P(YY,":",2),1,2) S:STPTM'<1200 STPTM1=DT_"."_STPTM S:STPTM<1200 STPTM=STPTM+1200,STPTM1=DT_"."_STPTM
"RTN","PSOBGMG2",79,0)
 I $G(Y)'["AM"&($G(Y)'["PM") S YY=$E(Y,1,5),STPTM=$P(YY,":")_$E($P(YY,":",2),1,2) S:STPTM'<1200 STPTM1=DT_"."_STPTM S:STPTM<1200 STPTM=STPTM+1200,STPTM1=DT_"."_STPTM
"RTN","PSOBGMG2",80,0)
 I $G(EDT) S DIE="^PS(59.3,",DR="10////"_STPTM1_"" L +^PS(59.3,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  W !!,$C(7),Y(0,0)," is being edited!",! K EDT Q
"RTN","PSOBGMG2",81,0)
 I $G(EDT) D ^DIE L -^PS(59.3,DA) I $G(DIRUT)!($G(X)="") K EDT G EDTEX
"RTN","PSOBGMG2",82,0)
EDTEX I $G(EDT) K BSTRT,BSTRT1,BSTOP,BSTOP1,STRTM,STRTM1,STPTM,STPTM1,Y,YY Q
"RTN","PSOBGMG2",83,0)
 S DIE="^PS(59.3,",DR="8///1;14////"_PSOSITE_";9////"_STRTM1_";10////"_STPTM1_""
"RTN","PSOBGMG2",84,0)
 L +^PS(59.3,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  W !!,$C(7),Y(0,0)," is being edited!",! Q
"RTN","PSOBGMG2",85,0)
 D ^DIE L -^PS(59.3,DA) I $G(DIRUT)!($G(X)="") G INIX
"RTN","PSOBGMG2",86,0)
 W ! S LL=LL+1 K BSTRT,BSTRT1,BSTOP,BSTOP1,STRTM,STRTM1,STPTM,STPTM1 G INIT1
"RTN","PSOBGMG2",87,0)
INIJ S BTDV=$P(^PS(59.3,DA,0),"^",4),BTST=$P(^PS(59.3,DA,3),"^",3),BTSP=$P(^(3),"^",4) I $G(BTDV)&$G(BTST) D INIJB1
"RTN","PSOBGMG2",88,0)
INIX K APM,BTDV,BTDV1,BTSP,BTSP1,BTST,BTST1,DA,DIC,DIE,DIR,DUOUT,DTOUT,LL,STRTM,STRTM,STPTM,STPTM1,BSTRT,BSTRT1,BSTOP,BSTOP1,X,Y,YY,EDT
"RTN","PSOBGMG2",89,0)
 Q
"RTN","PSOBGMG2",90,0)
INIJB1 ;
"RTN","PSOBGMG2",91,0)
 K %DT,DIC,DTOUT S DIC(0)="XZM",DIC="^DIC(19,",X="PSO BINGO AUTOSTART" D ^DIC
"RTN","PSOBGMG2",92,0)
 I $O(^DIC(19.2,"B",+Y,0)) D EDIT^XUTMOPT("PSO BINGO AUTOSTART") G OUT1
"RTN","PSOBGMG2",93,0)
 D RESCH^XUTMOPT("PSO BINGO AUTOSTART","","","24H","L"),EDIT^XUTMOPT("PSO BINGO AUTOSTART")
"RTN","PSOBGMG2",94,0)
OUT1 K Y,DIC,X,PSOTM,PSOOPTN,PSOPTN,%DT,DTOUT
"RTN","PSOBGMG2",95,0)
 Q
"RTN","PSOBGMGR")
0^8^B62041438^B61535737
"RTN","PSOBGMGR",1,0)
PSOBGMGR ;BHAM ISC/LC - BINGO BOARD MANAGER ;2/15/06 1:03pm
"RTN","PSOBGMGR",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**12,232,268**;DEC 1997;Build 9
"RTN","PSOBGMGR",3,0)
 ;
"RTN","PSOBGMGR",4,0)
 ;PSO*232 add check for bad ATIC xref and cleanup
"RTN","PSOBGMGR",5,0)
 ;
"RTN","PSOBGMGR",6,0)
CODE D:'$D(PSOPAR) ^PSOLSET G:'$D(PSOPAR) END
"RTN","PSOBGMGR",7,0)
 S:$P($G(^PS(59,PSOSITE,1)),"^",20)'="" DGP=$P($G(^PS(59,PSOSITE,1)),"^",20)
"RTN","PSOBGMGR",8,0)
 G ERASE:$G(FLAG)=3,STOPIT:$G(FLAG)=2,DISP:$G(FLAG)=1
"RTN","PSOBGMGR",9,0)
TEST S DIK="^PS(52.11," F TEST=0:0 S TEST=$O(^PS(52.11,TEST)) Q:'TEST  D
"RTN","PSOBGMGR",10,0)
 .S TEST1=$P($P($G(^(TEST,0)),"^",5),".") I $G(TEST1)<DT S DA=TEST D ^DIK
"RTN","PSOBGMGR",11,0)
 K DIK,TEST,TEST1
"RTN","PSOBGMGR",12,0)
BEGI S ROLL=1,(ZV,ZH,PSOUT,FLG)=0 I $G(IOST(0))']"" W !,"Please check Device Type and try again" Q
"RTN","PSOBGMGR",13,0)
 S X="IODHLT;IODHLB;IORVOFF;IORVON" D ENDR^%ZISS S TOP=IODHLT,BOT=IODHLB,VOFF=IORVOFF,VON=IORVON K IODHLT,IODHLB,IORVOFF,IORVON,DIC
"RTN","PSOBGMGR",14,0)
 S:$G(DGP) DIC("B")=DGP S (DIC,DIE)=59.3,DIC(0)="AEQMZ" D ^DIC K DIC Q:+Y'>0  S (ADA,DA)=+Y
"RTN","PSOBGMGR",15,0)
 I $P($G(^PS(59.3,ADA,3)),"^")=1,'$G(^PS(59.3,ADA,"STOP")) W !,"Board has already been started!",$C(7) G END
"RTN","PSOBGMGR",16,0)
 S COLM=$P($G(^PS(59.3,ADA,3)),"^",5),DWT=$P($G(^(3)),"^",6),NWT=$P($G(^(3)),"^",7)
"RTN","PSOBGMGR",17,0)
 S FTX="PRESCRIPTIONS ARE READY FOR:"
"RTN","PSOBGMGR",18,0)
 S ^PS(59.3,ADA,"STOP")=0,STOP=0 S TCK=$P(^PS(59.3,ADA,0),"^",2) I $G(TCK)="T" D TICKDV G END
"RTN","PSOBGMGR",19,0)
 D DEV^PSOBGMG1 W:$G(NODV) !,"No device selected." G END
"RTN","PSOBGMGR",20,0)
ANAME G:$G(^PS(59.3,ADA,"STOP")) END H:ZV 20
"RTN","PSOBGMGR",21,0)
 I $P($G(^PS(59.3,ADA,3)),"^")=1&($P($G(^PS(59.3,ADA,3)),"^",4)'="") D
"RTN","PSOBGMGR",22,0)
 .D NOW^%DTC S:$E($P($G(%),".",2),1,4)'<$E($P($P($G(^PS(59.3,ADA,3)),"^",4),".",2),1,4) ^PS(59.3,ADA,"STOP")=1,STOP=1 D:STOP ASTOP^PSOBGMG2
"RTN","PSOBGMGR",23,0)
 D:$G(DWT) WAIT^PSOBGMG1
"RTN","PSOBGMGR",24,0)
 W @IOF F NOTE=0:0 S NOTE=$O(^PS(59.3,ADA,2,NOTE)) Q:'NOTE!($G(^PS(59.3,ADA,"STOP")))  S NOTES=^PS(59.3,ADA,2,NOTE,0) W !?2,TOP,NOTES,!?2,BOT,NOTES H 3
"RTN","PSOBGMGR",25,0)
 G:$G(^PS(59.3,ADA,"STOP")) END W @IOF
"RTN","PSOBGMGR",26,0)
 I $G(DWT) S DX=1,DY=1 X IOXY W TOP,TTX,!?1,BOT,TTX,!
"RTN","PSOBGMGR",27,0)
 S DX=1,DY=1 S:$G(DWT) DY=3 X IOXY W TOP,FTX S DY=DY+1 X IOXY W BOT,FTX,!
"RTN","PSOBGMGR",28,0)
 S ZH=$S($G(COLM):1,1:10),ZV=4 S:$G(DWT) ZV=6
"RTN","PSOBGMGR",29,0)
 S NAME="" F  S NAME=$O(^PS(52.11,"ANAM",ADA,NAME)) Q:""[NAME!($G(^PS(59.3,ADA,"STOP")))  D
"RTN","PSOBGMGR",30,0)
 .I '$G(COLM) D INDX^PSOBGMG1 I ZV>18 D
"RTN","PSOBGMGR",31,0)
 ..H 20 W @IOF I $G(DWT) S DX=1,DY=1 X IOXY W TOP,TTX,!?1,BOT,TTX,!
"RTN","PSOBGMGR",32,0)
 ..S DX=1,DY=1 S:$G(DWT) DY=3 X IOXY W TOP,FTX S DY=DY+1 X IOXY W BOT,FTX,! S ZV=4,ZH=10 S:$G(DWT) ZV=6
"RTN","PSOBGMGR",33,0)
 .I $G(COLM) D INDX^PSOBGMG1 I ZV>18,ZH>39 D
"RTN","PSOBGMGR",34,0)
 ..H 20 W @IOF I $G(DWT) S DX=1,DY=1 X IOXY W TOP,TTX,!?1,BOT,TTX,!
"RTN","PSOBGMGR",35,0)
 ..S DX=1,DY=1 S:$G(DWT) DY=3 X IOXY W TOP,FTX S DY=DY+1 X IOXY W BOT,FTX,! S ZV=4,ZH=1 S:$G(DWT) ZV=6
"RTN","PSOBGMGR",36,0)
 .I $G(COLM),ZH>39 S ZV=ZV+2,ZH=1
"RTN","PSOBGMGR",37,0)
 .S DX=ZH,DY=ZV X IOXY W TOP,$E(NAME,1,18) S DY=DY+1 X IOXY W BOT,$E(NAME,1,18),! S:'$G(COLM) ZV=ZV+2 S:$G(COLM) ZH=ZH+20 Q:$G(^PS(59.3,ADA,"STOP"))
"RTN","PSOBGMGR",38,0)
 G:$G(^PS(59.3,ADA,"STOP")) END Q:STOP  G ANAME
"RTN","PSOBGMGR",39,0)
TICKDV D DEV^PSOBGMG1 W:$G(NODV) !,"No device selected." G END
"RTN","PSOBGMGR",40,0)
TICKET G:$G(^PS(59.3,ADA,"STOP")) END H:ZV 20
"RTN","PSOBGMGR",41,0)
 I $P($G(^PS(59.3,ADA,3)),"^")=1&($P($G(^PS(59.3,ADA,3)),"^",4)'="") D
"RTN","PSOBGMGR",42,0)
 .D NOW^%DTC S:$E($P($G(%),".",2),1,4)'<$E($P($P($G(^PS(59.3,ADA,3)),"^",4),".",2),1,4) ^PS(59.3,ADA,"STOP")=1,STOP=1 D:STOP ASTOP^PSOBGMG2
"RTN","PSOBGMGR",43,0)
 D:$G(DWT) WAIT^PSOBGMG1
"RTN","PSOBGMGR",44,0)
 W @IOF F NOTE=0:0 S NOTE=$O(^PS(59.3,ADA,2,NOTE)) Q:'NOTE!($G(^PS(59.3,ADA,"STOP")))  S NOTES=^PS(59.3,ADA,2,NOTE,0) W !?2,TOP,NOTES,!?2,BOT,NOTES H 3
"RTN","PSOBGMGR",45,0)
 G:$G(^PS(59.3,ADA,"STOP")) END W @IOF
"RTN","PSOBGMGR",46,0)
 I $G(DWT) S DX=1,DY=1 X IOXY W TOP,TTX,!?1,BOT,TTX,!
"RTN","PSOBGMGR",47,0)
 S DX=1,DY=1 S:$G(DWT) DY=3 X IOXY W TOP,FTX S DY=DY+1 X IOXY W BOT,FTX,!
"RTN","PSOBGMGR",48,0)
 S ZH=$S($G(COLM):1,1:15),ZV=4 S:$G(DWT) ZV=6
"RTN","PSOBGMGR",49,0)
 S TICK="" F  S TICK=$O(^PS(52.11,"ATIC",ADA,TICK)) Q:'TICK!($G(^PS(59.3,ADA,"STOP")))  D
"RTN","PSOBGMGR",50,0)
 .;check for Bad records and kill orphaned xrefs             PSO*232
"RTN","PSOBGMGR",51,0)
 .I $$ATICCHK(ADA,TICK) Q
"RTN","PSOBGMGR",52,0)
 .I ZV>20 D
"RTN","PSOBGMGR",53,0)
 ..H 20 W @IOF I $G(DWT) S DX=1,DY=1 X IOXY W TOP,TTX,!?1,BOT,TTX,!
"RTN","PSOBGMGR",54,0)
 ..S DX=1,DY=1 S:$G(DWT) DY=3 X IOXY W TOP,FTX S DY=DY+1 X IOXY W BOT,FTX,! S ZV=4,ZH=$S($G(COLM):1,1:15) S:$G(DWT) ZV=6
"RTN","PSOBGMGR",55,0)
 .I $G(COLM),ZH>16 S ZV=ZV+2,ZH=1
"RTN","PSOBGMGR",56,0)
 .S DX=ZH,DY=ZV X IOXY W TOP,TICK S DY=DY+1 X IOXY W BOT,TICK,! S:'$G(COLM) ZV=ZV+2 S:$G(COLM) ZH=ZH+8
"RTN","PSOBGMGR",57,0)
 G:$G(^PS(59.3,ADA,"STOP")) END I '$G(COLM),ZV<6 H 20
"RTN","PSOBGMGR",58,0)
 I ($G(COLM))&(ZV<6)&(ZH<39) H 20
"RTN","PSOBGMGR",59,0)
 G TICKET
"RTN","PSOBGMGR",60,0)
STOPIT K DIC S:$G(DGP) DIC("B")=DGP S (DIC,DIE)=59.3,DIC(0)="AEQMZ" D ^DIC K DIC Q:+Y'>0  S (ADA,DA)=+Y
"RTN","PSOBGMGR",61,0)
 I $G(^PS(59.3,ADA,"STOP")) W !!,$C(7),"Board has already been stopped."
"RTN","PSOBGMGR",62,0)
 I  S DIR("A")="Do you want to purge the remaining entries for this display group",DIR(0)="YO",DIR("B")="N" D ^DIR K DIR G:$G(DIRUT) STOPEX G:Y PRG I 'Y W !!,"No data purged." G STOPEX
"RTN","PSOBGMGR",63,0)
 S ^PS(59.3,ADA,"STOP")=1,STOP=1 W !!,"Board Stopped!!",!!
"RTN","PSOBGMGR",64,0)
CNT S CNT1=0 F CNT=0:0 S CNT=$O(^PS(52.11,CNT)) Q:'CNT  S:$P($G(^PS(52.11,CNT,0)),"^",3)=ADA CNT1=CNT1+1
"RTN","PSOBGMGR",65,0)
 I 'CNT1 W !!,"There are no entries to purge from the display group.",! G STOPEX
"RTN","PSOBGMGR",66,0)
 W !!,$C(7),CNT1," entries still remain in the display group.",!
"RTN","PSOBGMGR",67,0)
PRG K DIR S DIR(0)="YO",DIR("A")="Purge this display's data now",DIR("B")="N" D ^DIR K DIR G:$D(DIRUT) STOPEX I 'Y W !!,"No data purged." G STOPEX
"RTN","PSOBGMGR",68,0)
 W !!,"Purging data. Please wait."
"RTN","PSOBGMGR",69,0)
 S DIK="^PS(52.11,",DA=0 F  S DA=$O(^PS(52.11,DA)) Q:'DA  D:$P($G(^PS(52.11,DA,0)),"^",3)=ADA ^DIK
"RTN","PSOBGMGR",70,0)
 W "   Purge complete!",!
"RTN","PSOBGMGR",71,0)
STOPEX K ADA,AS,CNT,CNT1,DA,DIK,DIRUT,FLAG,STOP,Y Q
"RTN","PSOBGMGR",72,0)
DISP W !! K DIC,DA,DR
"RTN","PSOBGMGR",73,0)
 S (DIC,DIE,DLAYGO)=59.3,DIC(0)="AELQMZ" D ^DIC K DIC G:+Y'>0 DISPEX S (ADA,DA)=+Y I $G(^PS(59.3,ADA,"STOP"))=0 W !!,$C(7),"This display group has been started.",!,"It must be stopped before you can edit it." G DISPEX
"RTN","PSOBGMGR",74,0)
 W !! S DR="[PSO DISPLAY EDIT]",DIE("NO^")="BACKOUTOK" L +^PS(59.3,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) G:'$T DISPEX1
"RTN","PSOBGMGR",75,0)
 D ^DIE G:'$D(DA) DISP L -^PS(59.3,DA) G:'$D(^PS(59.3,DA,2,0)) DISP G:$G(DIRUT) DISPEX1
"RTN","PSOBGMGR",76,0)
 ;
"RTN","PSOBGMGR",77,0)
 I '$D(Y),$P($G(^PS(59.3,DA,0)),"^",4),$P($G(^PS(59.3,DA,3)),"^") K DIR S DIR(0)="Y",DIR("A")="Do you want to initialize auto-start now",DIR("B")="NO" D ^DIR K DIR G:$D(DIRUT) DISPEX1 S EDT=Y
"RTN","PSOBGMGR",78,0)
 I $G(EDT) D STRTM^PSOBGMG2 G:'$G(EDT) DISPEX1 D INIJ^PSOBGMG2
"RTN","PSOBGMGR",79,0)
DISPEX1 K EDT,DIE,DIR,DR Q
"RTN","PSOBGMGR",80,0)
 ;
"RTN","PSOBGMGR",81,0)
ATICCHK(DV,TK) ;check ATIC xref if points to non-existent recs, then cleanup
"RTN","PSOBGMGR",82,0)
 ; Return 0 - if no cleanup
"RTN","PSOBGMGR",83,0)
 ;        1 - if had to cleanup
"RTN","PSOBGMGR",84,0)
 ;       
"RTN","PSOBGMGR",85,0)
 Q:($G(DV)="")!($G(TK)="") 0
"RTN","PSOBGMGR",86,0)
 N QT,P52 S P52=$O(^PS(52.11,"ATIC",DV,TK,"")),QT=0
"RTN","PSOBGMGR",87,0)
 ;if record pointed to is no longer on file (probably deleted),
"RTN","PSOBGMGR",88,0)
 ;then insure no orphanned xrefs
"RTN","PSOBGMGR",89,0)
 I '$D(^PS(52.11,P52)) D  S QT=1
"RTN","PSOBGMGR",90,0)
 . K ^PS(52.11,"ATIC",DV,TK,P52)
"RTN","PSOBGMGR",91,0)
 . K ^PS(52.11,"ANAMK",P52)
"RTN","PSOBGMGR",92,0)
 . K ^PS(52.11,"ANAM",DV,TK,P52)
"RTN","PSOBGMGR",93,0)
 . K ^PS(52.11,"C",TK,P52)
"RTN","PSOBGMGR",94,0)
 . K ^PS(52.11,"AD",DV,P52)
"RTN","PSOBGMGR",95,0)
 . N PA,PAI
"RTN","PSOBGMGR",96,0)
 . S PA="" F  S PA=$O(^PS(52.11,"ANAM",DV,PA)) Q:PA=""  D
"RTN","PSOBGMGR",97,0)
 . . S PAI="" F  S PAI=$O(^PS(52.11,"ANAM",DV,PA,PAI)) Q:PAI=""  D
"RTN","PSOBGMGR",98,0)
 . . . I PAI=P52 K ^PS(52.11,"ANAM",DV,PA,PAI)
"RTN","PSOBGMGR",99,0)
 Q QT
"RTN","PSOBGMGR",100,0)
 ;
"RTN","PSOBGMGR",101,0)
TEXT ;display text about setting up dedicated device
"RTN","PSOBGMGR",102,0)
 W !!,"In order to automatically start and stop the bingo board monitor,"
"RTN","PSOBGMGR",103,0)
 W !,"a dedicated device must be setup by your IRM Service.",!!
"RTN","PSOBGMGR",104,0)
 W "Once a dedicated device is setup, the bingo board can be scheduled"
"RTN","PSOBGMGR",105,0)
 W !,"to automatically start and/or stop at user-defined times."
"RTN","PSOBGMGR",106,0)
 W !!,"Enter 'NO' at the DISPLAY SETUP HELP TEXT prompt to not display this help text.",!
"RTN","PSOBGMGR",107,0)
 Q
"RTN","PSOBGMGR",108,0)
 ;
"RTN","PSOBGMGR",109,0)
 K ^UTILITY($J,"W") S DIWL=1,DIWR=40,DIWF="C40" F NODE=0:0 S NODE=$O(^PS(59.3,DA,2,NODE)) Q:'NODE  S X=^(NODE,0) D ^DIWP
"RTN","PSOBGMGR",110,0)
 F NODE=0:0 S NODE=$O(^UTILITY($J,"W",1,NODE)) Q:'NODE  S NODE1=^(NODE,0) S ^PS(59.3,DA,2,NODE,0)=NODE1,$P(^PS(59.3,DA,2,0),"^",3)=NODE,$P(^(0),"^",4)=NODE S LNODE=NODE
"RTN","PSOBGMGR",111,0)
 N LAST F NODE=0:0 S NODE=$O(^PS(59.3,DA,2,NODE)) Q:'NODE  S LAST=NODE
"RTN","PSOBGMGR",112,0)
 I LAST>LNODE S DA(1)=DA,DIK="^PS(59.3,"_DA(1)_",2,",DA=LNODE F  S DA=$O(^PS(59.3,DA(1),2,DA)) Q:'DA  D ^DIK
"RTN","PSOBGMGR",113,0)
 G DISP
"RTN","PSOBGMGR",114,0)
DISPEX K ADA,DA,FLAG,LAST,LNODE,NODE,NODE1,^UTILITY($J,"W"),X,Y Q
"RTN","PSOBGMGR",115,0)
ERASE S REC=$O(^PS(52.11,0)) I 'REC W !!,"All data has been purged!" K REC Q
"RTN","PSOBGMGR",116,0)
 W !! K DIR S DIR("A")="Purge patient data for all or a specific display group",DIR(0)="SBO^A:All display groups;S:Specific display group"
"RTN","PSOBGMGR",117,0)
 S DIR("?")="Enter 'A' to delete all patient data from all display groups.",DIR("?",1)="Enter 'S' to delete all patient data from a specific display group." D ^DIR K DIR G:$G(DIRUT) END1 S AS=Y K Y
"RTN","PSOBGMGR",118,0)
 S:$G(DGP) DIC("B")=DGP
"RTN","PSOBGMGR",119,0)
 G:AS="A" ALL S DIC=59.3,DIC(0)="AEQMZ" D ^DIC K DIC G:+Y'>0 ERASE S ADA=+Y K Y D CNT G ERASE
"RTN","PSOBGMGR",120,0)
ALL W !!,$C(7),"*** THIS WILL PURGE ALL BINGO BOARD PATIENT DATA FOR ALL DISPLAY GROUPS. ***",!!
"RTN","PSOBGMGR",121,0)
 S DIR(0)="YO",DIR("A")="Purge now",DIR("B")="N" D ^DIR K DIR G:$G(DIRUT) ERASE W:Y !!,"Purging data.  Please wait..." I 'Y W !!,"No data purged!" G ERASE
"RTN","PSOBGMGR",122,0)
PUR S DIK="^PS(52.11,",DA=0 F  S DA=$O(^PS(52.11,DA)) Q:'DA  D ^DIK
"RTN","PSOBGMGR",123,0)
 K DIR,DIK,DA W "   Purge complete.",! G ERASE
"RTN","PSOBGMGR",124,0)
END S ZTREQ="@" I $G(ADA)'="" S:$G(^PS(59.3,ADA,"STOP")) STOP=1
"RTN","PSOBGMGR",125,0)
END1 K ADA,AGROUP,BIG,BIGO,BOT,CNT,CNT1,DA,DGP,DR,FLAG,GROUP,NOTE,NAME,NOTES,PSOUT,ROLL,TICK,TOP,X,X1,Y,ZV,ZH,TCK,FTX,COLM,DIWF,DIWL,DIWR,FLG,VOFF,VON
"RTN","PSOBGMGR",126,0)
 K %,%ZIS,AWT,AWT1,AWT2,BBH,BBM,DEV,DLAYGO,DTOUT,DV,DWT,DX,DY,EN,IOXY,NTXT,NUM,NWT,POP,TASK,TTX,WTT
"RTN","PSOBGMGR",127,0)
 I $G(STOP) K STOP W @IOF D ^%ZISC G H^XUS
"RTN","PSOBGMGR",128,0)
 K STOP Q
"RTN","PSOBING1")
0^9^B55027504^B54041634
"RTN","PSOBING1",1,0)
PSOBING1 ;BHAM ISC/LC - bingo board utility routine ;6/29/06 11:46am
"RTN","PSOBING1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,28,56,135,244,268**;DEC 1997;Build 9
"RTN","PSOBING1",3,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOBING1",4,0)
 ;External reference to DD(52.11 and DD(59.2 supported by DBIA 999
"RTN","PSOBING1",5,0)
 ;
"RTN","PSOBING1",6,0)
 ;*244 don't store to file 52.11 if Rx Status > 11
"RTN","PSOBING1",7,0)
 ;
"RTN","PSOBING1",8,0)
BEG D:'$D(PSOPAR) ^PSOLSET G:'$D(PSOPAR) END
"RTN","PSOBING1",9,0)
NEW K DD,DO S (DIC,DIE)="^PS(52.11,",(NDA,X,DA)=PSODFN,DIC(0)="LMNQZ" D FILE^DICN K DIC G:Y'>0 NEW S (ODA,DA)=+Y,BNGSUS=0 S:$D(SUSROUTE) BNGSUS=1
"RTN","PSOBING1",10,0)
NEW1 S GRTP=$P($G(^PS(59.3,DISGROUP,0)),"^",2),NAM=$P($G(^DPT(PSODFN,0)),"^"),SSN=$P($G(^DPT(PSODFN,0)),"^",9) I GRTP="T" D  G:'$D(DA) END
"RTN","PSOBING1",11,0)
 .K TFLAG S DR="1;2////"_DISGROUP_";3////"_PSOSITE_";4////"_TM_";5////"_$E(TM1_"0000",1,4)_";8////"_NAM_";9////"_SSN_";13////"_BNGSUS_"" D STO  Q:'$D(DA)
"RTN","PSOBING1",12,0)
 .W !! S TIC=$P(^PS(52.11,DA,0),"^",2) D
"RTN","PSOBING1",13,0)
 ..F TIEN=0:0 S TIEN=$O(^PS(52.11,"C",TIC,TIEN)) Q:'TIEN  I DA'=TIEN,($P(^PS(52.11,DA,0),"^",4)=+$P(^PS(52.11,TIEN,0),"^",4)) D
"RTN","PSOBING1",14,0)
 ...S TDFN=$P(^PS(52.11,TIEN,0),"^"),TSSN=$P(^PS(52.11,TIEN,1),"^",2),TFLAG=0 W !,$C(7),$P(^DPT(TDFN,0),"^")_" ("_TSSN_") was issued ticket # "_TIC,". Try again!",!
"RTN","PSOBING1",15,0)
 ..K TDFN,TIEN,TSSN Q:'TFLAG
"RTN","PSOBING1",16,0)
 I $G(GRTP)="T" G:'TFLAG NEW1 G:TFLAG END
"RTN","PSOBING1",17,0)
 S DR="2////"_DISGROUP_";3////"_PSOSITE_";4////"_TM_";5////"_$E(TM1_"0000",1,4)_";8////"_NAM_";9////"_SSN_";13////"_BNGSUS_""
"RTN","PSOBING1",18,0)
STO S NFLAG=1 L +^PS(52.11,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  W !!,$C(7),Y(0,0)," is being edited!",! S DA=NDA D WARN Q:$G(GRTP)="T"  G END
"RTN","PSOBING1",19,0)
 S XDA=DA D ^DIE I $G(DUOUT)!($G(DTOUT))!(X="") S DA=ODA D WARN G END
"RTN","PSOBING1",20,0)
 S DA=XDA D STORX S DA=XDA L -^PS(52.11,DA)
"RTN","PSOBING1",21,0)
 S TFLAG=1 D:$G(GRTP)="N" CHKUP^PSOBINGO,NOTE G:$G(GRTP)="N" END
"RTN","PSOBING1",22,0)
 Q
"RTN","PSOBING1",23,0)
NOTE S DFN=$P($G(^PS(52.11,DA,0)),"^"),NFLAG=1 W !!,?5,"NAME",?30,"SSN",?45,"ID",?50,"ORDER"
"RTN","PSOBING1",24,0)
 F Z=0:0 S Z=$O(^PS(52.11,"B",DFN,Z)) Q:'Z  S ZDA=Z S NODE=^PS(52.11,ZDA,1),Z1=$P($G(NODE),"^"),Z2=$P($G(NODE),"^",3),Z3=$P($G(NODE),"^",4),Z4=$P($G(NODE),"^",2) W !,?5,Z1,?30,Z4,?46,Z2,?52,Z3
"RTN","PSOBING1",25,0)
 W !!,"Please advise the patient that the above ID # and/or ORDER Letter"
"RTN","PSOBING1",26,0)
 W !,"will be displayed with his/her name on the Bingo Display",!!
"RTN","PSOBING1",27,0)
 I $G(^PS(55,"ASTALK",DFN)) W !,$C(7),"** ",Z1," is enrolled for ScripTalk.",!,"  Please use label(s) from ScripTalk printer." D  W !
"RTN","PSOBING1",28,0)
 .I $P($G(^PS(59,+PSOSITE,"STALK")),"^")="" W !,"  ** NO SCRIPTALK PRINTER DEFINED FOR THIS DIVISION!",! Q
"RTN","PSOBING1",29,0)
 .I $P($G(^PS(59,+PSOSITE,"STALK")),"^",2)'="A" W !,"  ** SCRIPTALK PRINTER IS NOT DEFINED FOR AUTO-PRINT",!,"You must manually queue the ScripTalk label(s) to print.",!
"RTN","PSOBING1",30,0)
 K NODE,Z1,Z2,Z3
"RTN","PSOBING1",31,0)
 Q
"RTN","PSOBING1",32,0)
HELP W !!,"Wand the barcode of the Rx or manually key in",!,"the number below the barcode, the Rx number, or the",!,"patient name in the format - 'LASTNAME,FIRSTNAME'"
"RTN","PSOBING1",33,0)
 W !!,"The barcode # should be of the format - 'NNN-NNNNNNN'"
"RTN","PSOBING1",34,0)
 Q
"RTN","PSOBING1",35,0)
BCRMV W !! K DIR S DIR("A")="Enter/Wand Rx # or Enter PATIENT NAME",DIR("?")="^D HELP^PSOBING1",DIR(0)="FO^1:45" D ^DIR
"RTN","PSOBING1",36,0)
 G:$D(DIRUT) END
"RTN","PSOBING1",37,0)
 I X'["-" D BCI^PSODISP Q:'$G(RXP)  G BCRMV1
"RTN","PSOBING1",38,0)
 I X["-",$P(X,"-")'=$P($$SITE^VASITE(),"^",3) W !?7,$C(7)," INVALID STATION # !",! G BCRMV
"RTN","PSOBING1",39,0)
 I X["-" S RXP=$P(X,"-",2) I '$D(^PSRX(+$G(RXP),0))!($G(RXP)']"") W !?7,$C(7)," NON-EXISTENT RX #" G BCRMV
"RTN","PSOBING1",40,0)
 G:$D(^PSRX(RXP,0)) BCRMV1
"RTN","PSOBING1",41,0)
 W !?7,$C(7)," IMPROPER BARCODE FORMAT" G BCRMV
"RTN","PSOBING1",42,0)
BCRMV1 S NME=$P($G(^PSRX(RXP,0)),"^",2),BNAME=$P($G(^DPT(NME,0)),"^"),BDA="",CNT1=0
"RTN","PSOBING1",43,0)
 F XX=0:0 S XX=$O(^PS(52.11,"B",NME,XX)) Q:'XX  D
"RTN","PSOBING1",44,0)
 .F BRX=0:0 S BRX=$O(^PS(52.11,XX,2,"B",BRX)) Q:'BRX  D
"RTN","PSOBING1",45,0)
 ..I BRX=RXP S DA=XX
"RTN","PSOBING1",46,0)
 I '$D(DA) W !!,BNAME," isn't in the Bingo Board file.",$C(7) G BCRMV
"RTN","PSOBING1",47,0)
 I $D(^PS(52.11,"ANAMK",DA)) W !!,BNAME," has already been removed from the display.",$C(7) G BCRMV
"RTN","PSOBING1",48,0)
 D REMOVE1^PSOBINGO
"RTN","PSOBING1",49,0)
 K BRX,DIK,DA,XX W !!,BNAME," is removed from the display."
"RTN","PSOBING1",50,0)
 G BCRMV
"RTN","PSOBING1",51,0)
WARN W !!,$C(7),"Bingo record is incomplete!" S DIK="^PS(52.11," D ^DIK K DIK,DA W !!,"Bingo record removed.",!
"RTN","PSOBING1",52,0)
 Q
"RTN","PSOBING1",53,0)
STORX ;Sto Rx # for each entry in 52.11
"RTN","PSOBING1",54,0)
 Q:'$D(BBRX(1))  N DIC,DIE,NUM,BB,BBN,DR,FL,FLN,I
"RTN","PSOBING1",55,0)
 S DA(1)=DA,(DIC,DIE)="^PS(52.11,"_DA(1)_",2,",DIC(0)="L",DIC("P")=$P(^DD(52.11,12,0),"^",2),DLAYGO=52.11
"RTN","PSOBING1",56,0)
 F BBN=0:0 S BBN=$O(BBRX(BBN)) Q:'BBN  F NUM=1:1 S BB=$P(BBRX(BBN),",",NUM) Q:'BB  D
"RTN","PSOBING1",57,0)
 .Q:$G(^PSRX(BB,"STA"))>11                            ;*244
"RTN","PSOBING1",58,0)
 .I $D(RXPR(BB)) S FL="P",FLN=$G(RXPR(BB))
"RTN","PSOBING1",59,0)
 .I '$D(RXPR(BB)) F I=0:0 S I=$O(^PSRX(BB,1,I)) Q:'I  S FL="F",FLN=I
"RTN","PSOBING1",60,0)
 .I '$D(FL) S FL="F",FLN=0
"RTN","PSOBING1",61,0)
 .S X=$P(^PSRX(BB,0),"^") D ^DIC
"RTN","PSOBING1",62,0)
 .S DA=$P(Y,"^"),DR="1////"_FL_";2////"_FLN_"" D ^DIE K FL,FLN
"RTN","PSOBING1",63,0)
 Q
"RTN","PSOBING1",64,0)
 ;
"RTN","PSOBING1",65,0)
WTIME ;sto bingo wait time in 52
"RTN","PSOBING1",66,0)
 Q:'$D(DA)!'$D(DIF)  S BDA=DA
"RTN","PSOBING1",67,0)
 N DIE,XX,BRX1,BRXFL,BRXFLN,DR
"RTN","PSOBING1",68,0)
 S DA(1)=DA,DIE="^PS(52.11,"_DA(1)_",2,"
"RTN","PSOBING1",69,0)
 F XX=0:0 S XX=$O(^PS(52.11,BDA,2,XX)) Q:'XX  S DA=XX,BRX=$G(^PS(52.11,BDA,2,DA,0)),BRX1=$P(^(0),"^"),BRXFL=$P(^(0),"^",2),BRXFLN=$P(^(0),"^",3) D
"RTN","PSOBING1",70,0)
 .S DR="3////"_DIF_"" D ^DIE D
"RTN","PSOBING1",71,0)
 ..N DA,DIE S DA=BRX1
"RTN","PSOBING1",72,0)
 ..I $G(BRXFLN)=0 S DIE="^PSRX(",DR="32.3////"_DIF_"" D ^DIE K DIE
"RTN","PSOBING1",73,0)
 ..I $G(BRXFLN)>0,$G(BRXFL)="F",$G(^PSRX(DA,1,BRXFLN,0)) S DA(1)=DA,DIE="^PSRX("_DA(1)_",1,",DA=BRXFLN,DR="18////"_DIF_"" D ^DIE K DIE
"RTN","PSOBING1",74,0)
 ..I $G(BRXFLN)>0,$G(BRXFL)="P",$G(^PSRX(DA,"P",BRXFLN,0)) S DA(1)=DA,DIE="^PSRX("_DA(1)_",""P"",",DA=BRXFLN,DR="9////"_DIF_"" D ^DIE K DIE
"RTN","PSOBING1",75,0)
 S DA=BDA K DIE,XX,BRX,BRX1,BRXFL,BRXFLN,DR,DA(1)
"RTN","PSOBING1",76,0)
 Q
"RTN","PSOBING1",77,0)
 ;
"RTN","PSOBING1",78,0)
CREF ;check for deleted refills
"RTN","PSOBING1",79,0)
 S BDA=DA,XX=0,BRB="" F  S XX=$O(^PS(52.11,BDA,2,XX)) Q:'XX  S DA=XX D
"RTN","PSOBING1",80,0)
 .S BRX0=$G(^PS(52.11,BDA,2,DA,0)),BRX1=$P(BRX0,"^"),BRXFL=$P(BRX0,"^",2),BRXFLN=$P(BRX0,"^",3)
"RTN","PSOBING1",81,0)
 .I BRXFLN,BRXFL="F",$G(^PSRX(BRX1,1,BRXFLN,0))']"" D
"RTN","PSOBING1",82,0)
 ..S DA(1)=BDA,DIK="^PS(52.11,"_DA(1)_",2," D ^DIK K DIK,DA(1)
"RTN","PSOBING1",83,0)
 ..S BRB=BRB_$S(BRB="":"",1:"; ")_BRX1_","_BRXFLN
"RTN","PSOBING1",84,0)
 S DA=BDA I BRB]"",$P($G(^PS(52.11,BDA,2,0)),"^",4)=0 D
"RTN","PSOBING1",85,0)
 .W !!,$C(7),"Refill(s) "_BRB_" does not exist.",!,"It can't be displayed and is now deleted."
"RTN","PSOBING1",86,0)
 .S DIK="^PS(52.11," D ^DIK S PSODRF=1
"RTN","PSOBING1",87,0)
 K BDA,BRB,BRX0,BRX1,BRXFL,BRXFLN
"RTN","PSOBING1",88,0)
 Q
"RTN","PSOBING1",89,0)
 ;
"RTN","PSOBING1",90,0)
REL S BNGRXP=RXP N NAM,NAME,RXO,SSN
"RTN","PSOBING1",91,0)
 S NAM=$P($G(^DPT(BINGNAM,0)),"^"),ADA="",BNGRXP=RXP
"RTN","PSOBING1",92,0)
 F XX=0:0 S XX=$O(^PS(52.11,"B",BINGNAM,XX)) Q:'XX  D
"RTN","PSOBING1",93,0)
 .F BRX=0:0 S BRX=$O(^PS(52.11,XX,2,"B",BRX)) Q:'BRX  D
"RTN","PSOBING1",94,0)
 ..I BRX=BNGRXP S (DA,ODA)=XX
"RTN","PSOBING1",95,0)
 I '$D(DA) W !!,"The Rx for ",NAM," isn't in the Bingo Board",!,"file and must be entered manually.",$C(7) G END
"RTN","PSOBING1",96,0)
 I $P($G(^PS(52.11,DA,0)),"^",7)]"" W !!,NAM,"  is already in the display queue.",$C(7) G END
"RTN","PSOBING1",97,0)
 I $P($P($G(^PS(52.11,DA,0)),"^",5),".")'=DT S Y=$P($P($G(^PS(52.11,DA,0)),"^",5),".") D DD^%DT W !!,$C(7),NAM," was entered on "_Y_".",!,"It can't be displayed and is now deleted." S DIK="^PS(52.11," D ^DIK K DIK G END
"RTN","PSOBING1",98,0)
 G:$P($G(^PS(52.11,DA,0)),"^",9) REL1
"RTN","PSOBING1",99,0)
 I $P($G(^PS(52.11,DA,0)),"^",4)'=PSOSITE W !!,NAM," is from another division",!,"and must be displayed manually.",$C(7) G END
"RTN","PSOBING1",100,0)
 I $D(BINGRO),$D(BINGDIV) S BDIV=BINGDIV G REL1
"RTN","PSOBING1",101,0)
 I $D(BINGRPR),$D(BNGPDV) S BDIV=BNGPDV G REL1
"RTN","PSOBING1",102,0)
 I $D(BINGRPR),$D(BNGRDV) S BDIV=BNGRDV G REL1
"RTN","PSOBING1",103,0)
REL1 N TM,TM1 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2)
"RTN","PSOBING1",104,0)
 S NM=$P(^DPT($P(^PS(52.11,DA,0),"^"),0),"^"),DR="6////"_$E(TM1_"0000",1,4)_";8////"_NM_"",DIE="^PS(52.11,"
"RTN","PSOBING1",105,0)
 L +^PS(52.11,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  W !!,$C(7),NM," is being edited!",! D WARN G END
"RTN","PSOBING1",106,0)
 D ^DIE L -^PS(52.11,DA) I $G(DUOUT)!($G(DTOUT))!(X="") D WARN G END
"RTN","PSOBING1",107,0)
 S RX0=^PS(52.11,DA,0),JOES=$P(RX0,"^",4),TICK=+$P($G(RX0),"^",2),GRP=$P($G(^PS(59.3,$P($G(^PS(52.11,DA,0)),"^",3),0)),"^",2) D:GRP="T"&('$G(TICK)) WARN G:'$D(DA) END
"RTN","PSOBING1",108,0)
 W !!,NAM," added to the "_$P($G(^PS(59.3,$P(RX0,"^",3),0)),"^")_" display."
"RTN","PSOBING1",109,0)
 I +$G(^PS(55,"ASTALK",$P(^PS(52.11,DA,0),"^"))) W !,$C(7),"This patient is enrolled in ScripTalk and may benefit from",!,"a non-visual announcement that prescriptions are ready."
"RTN","PSOBING1",110,0)
 S PSZ=0 I '$D(^PS(59.2,DT,0)) K DD,DIC,DO,DA S X=DT,DIC="^PS(59.2,",DIC(0)="",DINUM=X D FILE^DICN S PSZ=1 Q:Y'>0 
"RTN","PSOBING1",111,0)
 I PSZ=1 S DA(1)=+Y,DIC=DIC_DA(1)_",1,",(DINUM,X)=JOES,DIC(0)="",DIC("P")=$P(^DD(59.2,1,0),"^",2) K DD,DO D FILE^DICN K DIC,DA Q:Y'>0
"RTN","PSOBING1",112,0)
 I PSZ=0 K DD,DIC,DO,DA S DA(1)=DT,(DINUM,X)=JOES,DIC="^PS(59.2,"_DT_",1,",DIC(0)="LZ" D FILE^DICN K DIC,DA,DO
"RTN","PSOBING1",113,0)
 S DA=ODA D STATS1^PSOBRPRT,WTIME
"RTN","PSOBING1",114,0)
END K ADA,BDA,BDIV,BNGRXP,BNGSUS,BNAME,BRX,CNT1,CT,DA,DD,DIC,DIE,DIK,DIR,DO,DR,DTOUT,DUOUT,GRP,GRTP,JOES
"RTN","PSOBING1",115,0)
 K NAM,NDA,NFLAG,NME,ODA,PSZ,RXO,SSN,TDFN,TFLAG,TIC,TICK,TIEN,TM,TM1,TSSN,X,Y,XX
"RTN","PSOBING1",116,0)
 Q
"RTN","PSOBINGO")
0^10^B61813575^B61437280
"RTN","PSOBINGO",1,0)
PSOBINGO ;BHAM ISC/LC - BINGO BOARD OPTION DRIVER ;1/18/06 9:09am
"RTN","PSOBINGO",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**12,28,56,125,152,232,268**;DEC 1997;Build 9
"RTN","PSOBINGO",3,0)
 ;External Ref. to ^PS(55 is supp. by DBIA# 2228
"RTN","PSOBINGO",4,0)
 ;External Ref. to ^PSDRUG(, is supp. by DBIA# 221
"RTN","PSOBINGO",5,0)
 ;
"RTN","PSOBINGO",6,0)
 ;PSO*7*232 add ATIC xref set/kill code here
"RTN","PSOBINGO",7,0)
 ;
"RTN","PSOBINGO",8,0)
 S (FLAG,FLAG1)=0,(TRIPS,JOES,ADV,DGP)="" G:'$G(PSOAP) END D:'$D(PSOPAR) ^PSOLSET G:'$D(PSOPAR) END
"RTN","PSOBINGO",9,0)
BEG ;PSOAP=1 NEW ENTRY; 2=DISPLAY; 3=REMOVE
"RTN","PSOBINGO",10,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) G:PSOAP=1 NEW I PSOAP=3 D BCRMV^PSOBING1 G:'$D(X) END
"RTN","PSOBINGO",11,0)
 I PSOAP=3 S DIC=52.11,DIC(0)="EMQZ",DIC("S")="I '$P($G(^PS(52.11,Y,0)),U,8)" D ^DIC K DIC G:+Y'>0 BEG G:($G(DTOUT))!($G(DUOUT)) END S DA=+Y,NAM=Y(0,0)
"RTN","PSOBINGO",12,0)
 I PSOAP=2 W !! K DIC,DIE,DLAYGO S (DIC,DIE)=52.11,DIC(0)="AEMQZ",DIC("A")="Enter Patient Name to Display: ",DIC("S")="I $P($G(^PS(52.11,Y,0)),U,4)=PSOSITE&'$P($G(^PS(52.11,Y,0)),U,7)"
"RTN","PSOBINGO",13,0)
 I PSOAP=2 D ^DIC K DIC G:+Y'>0!($G(DTOUT))!($G(DUOUT)) END S (DA,ODA)=+Y,NAM=Y(0,0)
"RTN","PSOBINGO",14,0)
 I PSOAP=3 D STUF,REMOVE1 G BEG
"RTN","PSOBINGO",15,0)
 I PSOAP=2,($P($G(^PS(52.11,DA,0)),"^",7)]"") W !!,NAM,"  is already in the display queue.",$C(7) G BEG
"RTN","PSOBINGO",16,0)
 I PSOAP=2,$P($P($G(^PS(52.11,DA,0)),"^",5),".")'=DT S Y=$P($P($G(^PS(52.11,DA,0)),"^",5),".") D DD^%DT W !!,$C(7),NAM," was entered on "_Y_".",!,"It can't be displayed and is now deleted." S DIK="^PS(52.11," D ^DIK K DIK G BEG
"RTN","PSOBINGO",17,0)
 I PSOAP=2&($P(^PS(52.11,ODA,0),"^",4)'=+PSOSITE) W !!,$C(7),NAM," was entered under the "_$P(^PS(59,$P(^(0),"^",4),0),"^")_" division." G BEG
"RTN","PSOBINGO",18,0)
 I PSOAP=2 S PSODRF=0 D CREF^PSOBING1 G:PSODRF BEG D  G BEG
"RTN","PSOBINGO",19,0)
 .S NM=$P(^DPT($P(^PS(52.11,ODA,0),"^"),0),"^"),DR="6////"_$E(TM1_"0000",1,4)_";8////"_NM_""
"RTN","PSOBINGO",20,0)
 .D PASS,SETUP S DA=ODA D STATS1^PSOBRPRT,WTIME^PSOBING1
"RTN","PSOBINGO",21,0)
NEW ;Init lookup
"RTN","PSOBINGO",22,0)
 W !! K DIC S DIC=2,DIC(0)="AEMQZ",DIC("A")="Enter Patient Name : " D ^DIC K DIC G:Y<0!($G(DUOUT))!($G(DTOUT)) END S (DA,ADA,DFN)=+Y D DEM^VADPT Q:VAERR  S NAM=VADM(1),SSN=$P(VADM(2),"^")
"RTN","PSOBINGO",23,0)
 K DD,DO S:$D(DISGROUP) DGP=$P($G(^PS(59.3,DISGROUP,0)),"^") S (DIC,DIE)="^PS(52.11,",X=ADA,DIC("DR")=$S($G(GROUPCNT)=1&($G(DISGROUP)):"2////"_DISGROUP_"",1:"2//^S X=DGP")
"RTN","PSOBINGO",24,0)
 S DIC(0)="LMNQZ",DLAYGO=59.3 D FILE^DICN K DD,DO,DIC G:Y'>0 NEW
"RTN","PSOBINGO",25,0)
 S JOES=$P(Y(0),"^",3),ADV=$P($G(^PS(59.3,JOES,0)),"^",2),DA=+Y
"RTN","PSOBINGO",26,0)
 I $G(DTOUT)!($G(DUOUT))!(X="") D WARN G NEW
"RTN","PSOBINGO",27,0)
TIC K TFLAG I ADV="T" S DIR(0)="NA^1:999999:0",DIR("A")="TICKET #:",DIR("?")="Ticket # must be numeric and unique" D ^DIR I $D(DUOUT)!($D(DTOUT))!($D(DIRUT)) D WARN G BEG
"RTN","PSOBINGO",28,0)
 S TFLAG=1 I PSOAP=1,$G(ADV)="T" W !! S TIC=+Y D
"RTN","PSOBINGO",29,0)
 .F TIEN=0:0 S TIEN=$O(^PS(52.11,"C",TIC,TIEN)) Q:'TIEN  I DA'=TIEN,($G(PSOSITE)=+$P(^PS(52.11,TIEN,0),"^",4)) D
"RTN","PSOBINGO",30,0)
 ..S TDFN=$P(^PS(52.11,TIEN,0),"^"),TSSN=$P(^PS(52.11,TIEN,1),"^",2),TFLAG=0 W !,$C(7),$P(^DPT(TDFN,0),"^")_" ("_TSSN_") was issued ticket # "_TIC,". Try again!",!
"RTN","PSOBINGO",31,0)
 .K TDFN,TIEN,TSSN Q:'TFLAG
"RTN","PSOBINGO",32,0)
 G:'TFLAG TIC I ADV="T" S DR="1////"_TIC_";3////"_PSOSITE_";4////"_TM_";5////"_$E(TM1_"0000",1,4)_";8////"_NAM_";9////"_SSN_";13////0",FLAG1=1 G PASS
"RTN","PSOBINGO",33,0)
 S DR="3////"_PSOSITE_";4////"_TM_";5////"_$E(TM1_"0000",1,4)_";8////"_NAM_";9////"_SSN_";13////0"
"RTN","PSOBINGO",34,0)
PASS S NFLAG=1 L +^PS(52.11,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  W !!,$C(7),Y(0,0)," is being edited!",! Q
"RTN","PSOBINGO",35,0)
 D ^DIE L -^PS(52.11,DA) I $G(DUOUT)!($G(DTOUT))!(X="") D WARN G BEG
"RTN","PSOBINGO",36,0)
 S:$G(PSOAP)=1 FLGG=0 G:$G(PSOAP)'=1 STRX1
"RTN","PSOBINGO",37,0)
STRX ;sto Rx #'s IN 52.11
"RTN","PSOBINGO",38,0)
 N BRXNUM,BBFTYP,BBFNUM,BBMW,MWDIR,II,FL,FLN,PR,PRN,PRNDT,FLNDT,Y
"RTN","PSOBINGO",39,0)
STRX0 S DIR(0)="FO^1:11",DIR("A")="Enter Rx #",DIR("?")="^D HELP^PSOBINGO",DIR("??")="^D HELP2^PSOBINGO" D ^DIR G:X=""&($G(FLGG)) STRX1 I $D(DIRUT) D WARN G BEG
"RTN","PSOBINGO",40,0)
 S DIC=52,DIC(0)="EQM",DIC("S")="I $P($G(^PSRX(Y,0)),U,2)=ADA" D ^DIC K DIC I $D(DUOUT)!($D(DTOUT)) D WARN G BEG
"RTN","PSOBINGO",41,0)
 G:Y=-1 STRX0
"RTN","PSOBINGO",42,0)
 I $G(Y)<0&('$G(FLGG)) D WARN G BEG
"RTN","PSOBINGO",43,0)
 I $G(Y)<0&($G(FLGG)) G STRX1
"RTN","PSOBINGO",44,0)
 S BRXNUM=$P(Y,"^")
"RTN","PSOBINGO",45,0)
 I $D(^PSRX(BRXNUM,1,0)) F II=0:0 S II=$O(^PSRX(BRXNUM,1,II)) Q:'II  S FLN=II
"RTN","PSOBINGO",46,0)
 I $D(FLN) S FLNDT=$P(^PSRX(BRXNUM,1,FLN,0),"^"),FL="F"
"RTN","PSOBINGO",47,0)
 I $D(^PSRX(BRXNUM,"P",0)) F II=0:0 S II=$O(^PSRX(BRXNUM,"P",II)) Q:'II  S PRN=II
"RTN","PSOBINGO",48,0)
 I $D(PRN) S PRNDT=$P(^PSRX(BRXNUM,"P",PRN,0),"^"),PR="P"
"RTN","PSOBINGO",49,0)
 S:$D(FLN)!($D(PRN)) BBFTYP=$S($G(PRNDT)>$G(FLNDT):PR,1:"F")
"RTN","PSOBINGO",50,0)
 I $G(BBFTYP)="P" S BBFNUM=PRN,BBMW=$P(^PSRX(BRXNUM,"P",PRN,0),"^",2)
"RTN","PSOBINGO",51,0)
 I $G(BBFTYP)="F" S BBFNUM=FLN,BBMW=$P(^PSRX(BRXNUM,1,FLN,0),"^",2)
"RTN","PSOBINGO",52,0)
 I '$D(BBFTYP) S BBFTYP="F",BBFNUM=0,BBMW=$P(^PSRX(BRXNUM,0),"^",11)
"RTN","PSOBINGO",53,0)
MW ;
"RTN","PSOBINGO",54,0)
 I $G(BBMW)="M" W !?5,$C(7),"Routing is set for Mail" D DIR
"RTN","PSOBINGO",55,0)
 I $D(MWDIR) K BRXNUM,BBFTYP,BBFNUM,BBMW,MWDIR,II,FL,FLN,PR,PRN,PRNDT,FLNDT,Y G STRX
"RTN","PSOBINGO",56,0)
 ;
"RTN","PSOBINGO",57,0)
 S X=BRXNUM,DIC("DR")="1////"_BBFTYP_";2////"_BBFNUM_"",DLAYGO=52.11
"RTN","PSOBINGO",58,0)
 S DA(1)=DA,DIC="^PS(52.11,"_DA(1)_",2,",DIC(0)="L",DIC("P")=$P(^DD(52.11,12,0),"^",2) K DD,DO D FILE^DICN K Y,DD,DO,X,BRXNUM,BBFTYP,BBFNUM,II,FL,PR,PRNDT,FLNDT S FLGG=1 G STRX
"RTN","PSOBINGO",59,0)
 ;
"RTN","PSOBINGO",60,0)
STRX1 D:PSOAP=1&($G(ADV)="N") CHKUP,NOTE G:'NFLAG BEG D STUF G:FLAG BEG Q:PSOAP=2
"RTN","PSOBINGO",61,0)
SETUP S ZZZ=0 I '$D(^PS(59.2,DT,0)) K DD,DIC,DO,DA S X=DT,DIC="^PS(59.2,",DIC(0)="",DINUM=X,DLAYGO=59.2 D FILE^DICN K DD,DO S ZZZ=1 Q:Y'>0
"RTN","PSOBINGO",62,0)
 I ZZZ=1 K DD,DO S DLAYGO=59.2,DA(1)=+Y,DIC=DIC_DA(1)_",1,",(DINUM,X)=PSOSITE,DIC(0)="",DIC("P")=$P(^DD(59.2,1,0),"^",2) D FILE^DICN K DD,DO,DIC,DA Q:Y'>0
"RTN","PSOBINGO",63,0)
 Q:PSOAP=2&($P($G(^PS(59.2,DT,1,PSOSITE,0)),"^"))  I ZZZ=0 K DD,DIC,DO,DA S DA(1)=DT,(DINUM,X)=PSOSITE,DIC="^PS(59.2,"_DT_",1,",DIC(0)="LZ",DLAYGO=59.2 D FILE^DICN K DD,DIC,DA,DO Q:PSOAP=2  G NEW
"RTN","PSOBINGO",64,0)
 G BEG
"RTN","PSOBINGO",65,0)
STUF S RX0=^PS(52.11,DA,0),JOES=$P(RX0,"^",4),TICK=$P($G(RX0),"^",2) Q:PSOAP=3  G:ADV="T"&($G(FLAG1)=1)&('$G(TICK)) WARN G:'$G(JOES)!($G(NAM)']"") WARN
"RTN","PSOBINGO",66,0)
 W:PSOAP=2 !!,"Patient added in display queue." W:PSOAP=1 !!,"Record is added." Q
"RTN","PSOBINGO",67,0)
WARN W !!!,$C(7),"Patient record incomplete!" S FLAG=1,DIK="^PS(52.11," D ^DIK G SHOW Q
"RTN","PSOBINGO",68,0)
REMOVE S DIK="^PS(52.11," D ^DIK
"RTN","PSOBINGO",69,0)
SHOW K DIK,DA,ADA W !!,"Record is removed."
"RTN","PSOBINGO",70,0)
 Q
"RTN","PSOBINGO",71,0)
REMOVE1 ;
"RTN","PSOBINGO",72,0)
 Q:'$D(^PS(52.11,"ANAM",$P(^PS(52.11,DA,0),"^",3),$P(^(1),"^",3)_$P(^(1),"^",4)_" "_$P(^DPT(+$P(^PS(52.11,DA,0),"^"),0),"^"),DA))
"RTN","PSOBINGO",73,0)
 N DIE,DR I $D(^PS(52.11,"ANAM",$P(^PS(52.11,DA,0),"^",3),$P(^(1),"^",3)_$P(^(1),"^",4)_" "_$P(^DPT(+$P(^PS(52.11,DA,0),"^"),0),"^"),DA)) S DIE="^PS(52.11,",DR="7////1" D
"RTN","PSOBINGO",74,0)
 .D ^DIE
"RTN","PSOBINGO",75,0)
 .K ^PS(52.11,"ANAM",$P(^PS(52.11,DA,0),"^",3),$P(^(1),"^",3)_$P(^(1),"^",4)_" "_$P(^DPT(+$P(^PS(52.11,DA,0),"^"),0),"^"),DA)
"RTN","PSOBINGO",76,0)
 I $D(^PS(52.11,"ATIC",+$P(^PS(52.11,DA,0),"^",3),+$P(^(0),"^",2),DA)) S DIE="^PS(52.11,",DR="7////1" D
"RTN","PSOBINGO",77,0)
 .D ^DIE
"RTN","PSOBINGO",78,0)
 .K ^PS(52.11,"ATIC",+$P(^PS(52.11,DA,0),"^",3),+$P(^(0),"^",2),DA)
"RTN","PSOBINGO",79,0)
 Q
"RTN","PSOBINGO",80,0)
CHKUP ;Multi & dupe names
"RTN","PSOBINGO",81,0)
 S SDA=DA S:'$D(DFN) DFN=PSODFN G:$O(^PS(52.11,"B",DFN,0))=DA BROW F P=0:0 S P=$O(^PS(52.11,"B",DFN,P)) Q:'P!(P=DA)  S LAST=P
"RTN","PSOBINGO",82,0)
 Q:'$G(LAST)  S TRIPS=$P($G(^PS(52.11,LAST,1)),"^",4) I TRIPS]"" S TRIPS=$A(TRIPS),TRIPS=TRIPS+1,TRIPS=$C(TRIPS) S DR="11////"_TRIPS_"" D ^DIE S F1=1 G BROW
"RTN","PSOBINGO",83,0)
 K TRIPS
"RTN","PSOBINGO",84,0)
FIRST ;Set 1st dup
"RTN","PSOBINGO",85,0)
 S DR="11////A" D ^DIE K DR,CNT
"RTN","PSOBINGO",86,0)
BROW S DA=SDA,NOPE=0,CNT=0 F NIEN=0:0 S NIEN=$O(^PS(52.11,"BA",NAM,NIEN)) Q:'NIEN!(NIEN=$G(DA))  D:$D(^PS(52.11,"BI")) BICK Q:CNT>0  D SETNEW Q:NOPE
"RTN","PSOBINGO",87,0)
 Q
"RTN","PSOBINGO",88,0)
SETNEW S SSN1=$O(^PS(52.11,"BA",NAM,NIEN,0)),ADFN=$P(^PS(52.11,NIEN,0),"^"),CNT=1 I SSN1=SSN S NOPE=1 Q
"RTN","PSOBINGO",89,0)
 S DR="10////1" D ^DIE S F1=1 Q
"RTN","PSOBINGO",90,0)
BICK ;Chks "BI" Xref & assigns seq#
"RTN","PSOBINGO",91,0)
 S SSN1=$O(^PS(52.11,"BA",NAM,NIEN,0)) I SSN1=SSN&('$P($G(^PS(52.11,SDA,1)),"^",3)) S NOPE=1 Q
"RTN","PSOBINGO",92,0)
 S CNT=0 I $D(^PS(52.11,"BI",DFN)) S CNT=$O(^(DFN,0)),DA=SDA,DR="10////"_CNT_"" D ^DIE S F1=1 Q
"RTN","PSOBINGO",93,0)
 F NDFN=0:0 S NDFN=$O(^PS(52.11,"BI",NDFN)) Q:'NDFN  S CNT=$O(^(NDFN,0))+1
"RTN","PSOBINGO",94,0)
 S DR="10////"_CNT_"" D ^DIE S F1=1 Q
"RTN","PSOBINGO",95,0)
NOTE S DFN=$P($G(^PS(52.11,DA,0)),"^"),NFLAG=1 W !!,?5,"NAME",?30,"SSN",?45,"ID",?50,"ORDER"
"RTN","PSOBINGO",96,0)
 F Z=0:0 S Z=$O(^PS(52.11,"B",DFN,Z)) Q:'Z  S ZDA=Z S NODE=$G(^PS(52.11,ZDA,1)),Z1=$P(NODE,"^"),Z2=$P(NODE,"^",3),Z3=$P(NODE,"^",4),Z4=$P(NODE,"^",2) W:NODE'="" !,?5,Z1,?30,Z4,?46,Z2,?52,Z3
"RTN","PSOBINGO",97,0)
 W !! S DIR(0)="F,O",DIR("A")="Press return to add the last prescription or '^' to remove it."
"RTN","PSOBINGO",98,0)
 S DIR("A",1)="Please advise the patient that the above ID # or ORDER Letter",DIR("A",2)="or both will be displayed with his/her name on the Bingo Display",DIR("A",3)=" "
"RTN","PSOBINGO",99,0)
 D ^DIR K DIR K NODE,Z1,Z2,Z3 I $G(DTOUT)!(Y="^") S NFLAG=0 D REMOVE
"RTN","PSOBINGO",100,0)
 Q
"RTN","PSOBINGO",101,0)
DIR K DIR,X,Y S DIR(0)="Y",DIR("A")="Continue ",DIR("B")="N",DIR("?")="Answer YES to continue, NO to bypass"
"RTN","PSOBINGO",102,0)
 D ^DIR K DIR S:$D(DIRUT)!('Y) MWDIR=1 K DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSOBINGO",103,0)
 Q
"RTN","PSOBINGO",104,0)
HELP2 S (PA,PD)="",PL=0 F  S PA=$O(^PS(55,ADA,"P","A",PA)) Q:'PA  D:DT-1<PA
"RTN","PSOBINGO",105,0)
 .F  S PD=$O(^PS(55,ADA,"P","A",PA,PD)) Q:'PD  S PL=PL+1 W !,$P(^PSRX(PD,0),"^"),"      ",$P(^PSDRUG($P(^PSRX(PD,0),"^",6),0),"^")
"RTN","PSOBINGO",106,0)
 .I $G(PL)>15 N DIR S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR S PL=0
"RTN","PSOBINGO",107,0)
 Q
"RTN","PSOBINGO",108,0)
HELP W !,"Enter the patient's Rx number.",!
"RTN","PSOBINGO",109,0)
 Q
"RTN","PSOBINGO",110,0)
ATICSET ;Set ATIC xref                                                PSO*232
"RTN","PSOBINGO",111,0)
 Q:'+$P(^PS(52.11,DA,0),"^",3)
"RTN","PSOBINGO",112,0)
 Q:'+$P(^PS(52.11,DA,0),"^",2)
"RTN","PSOBINGO",113,0)
 I $P(^PS(59.3,$P(^PS(52.11,DA,0),"^",3),0),"^",2)["T" D
"RTN","PSOBINGO",114,0)
 .S ^PS(52.11,"ATIC",+$P(^PS(52.11,DA,0),"^",3),+$P(^(0),"^",2),DA)=""
"RTN","PSOBINGO",115,0)
 Q
"RTN","PSOBINGO",116,0)
ATICKIL ;Kill ATIC xref                                               PSO*232
"RTN","PSOBINGO",117,0)
 Q:'+$P(^PS(52.11,DA,0),"^",3)
"RTN","PSOBINGO",118,0)
 Q:'+$P(^PS(52.11,DA,0),"^",2)
"RTN","PSOBINGO",119,0)
 I $P(^PS(59.3,$P(^PS(52.11,DA,0),"^",3),0),"^",2)["T" D
"RTN","PSOBINGO",120,0)
 .K ^PS(52.11,"ATIC",+$P(^PS(52.11,DA,0),"^",3),+$P(^(0),"^",2),DA)
"RTN","PSOBINGO",121,0)
 Q
"RTN","PSOBINGO",122,0)
 ;
"RTN","PSOBINGO",123,0)
END K %,ADA,ADFN,ADV,CNT,DA,DATE,DFN,DINUM,DLAYGO,DR,DTOUT,DUOUT,F1,FLAG,FLAG1,FLGG,JOES,LAST,NAM,NDFN,NIEN,NFLAG,NODE,NOPE,NM
"RTN","PSOBINGO",124,0)
 K PSODRF,ODA,P,PSOAP,RX0,TM,TM1,SDA,SSN,SSN1,RX0,TIC,TICK,TFLAG,VADM,X,Y,Z,Z1,Z2,Z3,Z4,ZDA,ZZZ,PL,PD,PA
"RTN","PSOBINGO",125,0)
 Q
"RTN","PSOBKDED")
0^69^B80833683^B80276763
"RTN","PSOBKDED",1,0)
PSOBKDED ;BIR/SAB - Edit backdoor Rx Order entry ;04/17/95
"RTN","PSOBKDED",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,46,91,78,99,117,133,143,268**;DEC 1997;Build 9
"RTN","PSOBKDED",3,0)
 ;Ref PS(50.607 IA 2221
"RTN","PSOBKDED",4,0)
 ;Ref PS(50.7 IA 2223
"RTN","PSOBKDED",5,0)
 ;Ref PS(51.2 IA 2226
"RTN","PSOBKDED",6,0)
 ;Ref PSDRUG( IA 221
"RTN","PSOBKDED",7,0)
 ;Ref DOSE^PSSORPH IA 3234
"RTN","PSOBKDED",8,0)
 ;Ref PS(55 IA 2228
"RTN","PSOBKDED",9,0)
1 S %DT="AEX",%DT(0)=-PSONEW("FILL DATE"),Y=PSONEW("ISSUE DATE") X ^DD("DD") S %DT("A")="ISSUE DATE: ",%DT("B")=Y D ^%DT
"RTN","PSOBKDED",10,0)
 I "^"[$E(X) D KX K %DT Q
"RTN","PSOBKDED",11,0)
 G:Y=-1 1 S (PSOID,PSONEW("ISSUE DATE"))=Y D KX K %DT
"RTN","PSOBKDED",12,0)
 Q
"RTN","PSOBKDED",13,0)
2 S PSONEW("FLD")=2 D FILLDT^PSODIR2(.PSONEW) ;Fdt
"RTN","PSOBKDED",14,0)
 Q
"RTN","PSOBKDED",15,0)
3 S:$G(POERR) PSONEW("ISSUE DATE")=PSOID
"RTN","PSOBKDED",16,0)
 S PSONEW("FLD")=3 D PTSTAT^PSODIR1(.PSONEW) ;Sta
"RTN","PSOBKDED",17,0)
 Q
"RTN","PSOBKDED",18,0)
4 S PSONEW("FLD")=4 D PROV^PSODIR(.PSONEW) ;Pro
"RTN","PSOBKDED",19,0)
 Q
"RTN","PSOBKDED",20,0)
5 S PSONEW("FLD")=5 D CLINIC^PSODIR2(.PSONEW) ;Cli
"RTN","PSOBKDED",21,0)
 Q
"RTN","PSOBKDED",22,0)
6 S PSONEW("FLD")=6 D ^PSODRG,EN^PSODIAG ;Drg/ICD
"RTN","PSOBKDED",23,0)
 D 6^PSODRGN
"RTN","PSOBKDED",24,0)
 Q
"RTN","PSOBKDED",25,0)
7 S PSONEW("FLD")=7 D QTY^PSODIR1(.PSONEW) ;Qty
"RTN","PSOBKDED",26,0)
 Q
"RTN","PSOBKDED",27,0)
8 S PSONEW("FLD")=8 D DAYS^PSODIR1(.PSONEW) ;Day
"RTN","PSOBKDED",28,0)
 K PSMAX,PSTMAX D REF^PSOORNEW S PSONEW("N# REF")=PSONEW("# OF REFILLS")
"RTN","PSOBKDED",29,0)
 Q
"RTN","PSOBKDED",30,0)
9 S PSONEW("FLD")=9 D REFILL^PSODIR1(.PSONEW) ;Ref
"RTN","PSOBKDED",31,0)
 K PSMAX,PSTMAX
"RTN","PSOBKDED",32,0)
 Q
"RTN","PSOBKDED",33,0)
10 S PSONEW("FLD")="3A" D DOSE^PSODIR(.PSONEW) ;Dose
"RTN","PSOBKDED",34,0)
 Q
"RTN","PSOBKDED",35,0)
 ;
"RTN","PSOBKDED",36,0)
 Q  I $G(COPY),$G(SIGOK) S PSOFDR=1 K PSONEW("SIG")
"RTN","PSOBKDED",37,0)
 S PSONEW("FLD")=10 D SIG^PSODIR1(.PSONEW) ;Sig
"RTN","PSOBKDED",38,0)
 I $G(COPY) K PSOFDR
"RTN","PSOBKDED",39,0)
 S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR D KV
"RTN","PSOBKDED",40,0)
 Q
"RTN","PSOBKDED",41,0)
INS S PSONEW("FLD")="3B" D INS^PSODIR(.PSONEW) ;Ins
"RTN","PSOBKDED",42,0)
 Q
"RTN","PSOBKDED",43,0)
11 S PSONEW("FLD")=11 D COPIES^PSODIR1(.PSONEW) ;Cop
"RTN","PSOBKDED",44,0)
 Q
"RTN","PSOBKDED",45,0)
12 S PSONEW("FLD")=12 D MW^PSODIR2(.PSONEW) ;M/W
"RTN","PSOBKDED",46,0)
 Q
"RTN","PSOBKDED",47,0)
13 S PSONEW("FLD")=13 D RMK^PSODIR2(.PSONEW) ;Rem
"RTN","PSOBKDED",48,0)
 Q
"RTN","PSOBKDED",49,0)
DOSE ;backdoor
"RTN","PSOBKDED",50,0)
 I '$G(PSONEW("ENT")) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (5) Dosage Ordered: " G INS1
"RTN","PSOBKDED",51,0)
 S SD=1 F I=1:1:PSONEW("ENT") D 
"RTN","PSOBKDED",52,0)
 .I '$G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOBKDED",53,0)
 .S:$G(SD)=1 IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (5)",DS=1 K SD
"RTN","PSOBKDED",54,0)
 .D DOSE1
"RTN","PSOBKDED",55,0)
INS1 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  (6)Pat Instruction:"
"RTN","PSOBKDED",56,0)
INS2 I $O(PSONEW("SIG",0)) F D=0:0 S D=$O(PSONEW("SIG",D)) Q:'D  D
"RTN","PSOBKDED",57,0)
 .F SG=1:1:$L(PSONEW("SIG",D)) S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(PSONEW("SIG",D)," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",21)=" " D
"RTN","PSOBKDED",58,0)
 ..S:$P(PSONEW("SIG",D)," ",SG)'="" ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(PSONEW("SIG",D)," ",SG)
"RTN","PSOBKDED",59,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") D  Q
"RTN","PSOBKDED",60,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" Other Patient Inst.: "
"RTN","PSOBKDED",61,0)
 .I $G(^PSRX(+$G(PSONEW("OIRXN")),"INSS"))]"" S PSONEW("SINS")=^PSRX(PSONEW("OIRXN"),"INSS")
"RTN","PSOBKDED",62,0)
 .S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_$G(PSONEW("SINS"))
"RTN","PSOBKDED",63,0)
 Q
"RTN","PSOBKDED",64,0)
 ;
"RTN","PSOBKDED",65,0)
DOSE1 I $G(DS)=1 D  K DS G DU
"RTN","PSOBKDED",66,0)
 .S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_" Dosage Ordered: "_$S($E(PSONEW("DOSE",I),1)="."&($G(PSONEW("DOSE ORDERED",I))):"0",1:"")_PSONEW("DOSE",I)_$S($G(PSONEW("UNITS",I))'="":" ("_$P(^PS(50.607,PSONEW("UNITS",I),0),"^")_")",1:"")
"RTN","PSOBKDED",67,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Dosage Ordered: "_$S($E(PSONEW("DOSE",I),1)="."&($G(PSONEW("DOSE ORDERED",I))):"0",1:"")_PSONEW("DOSE",I)_$S($G(PSONEW("UNITS",I))'="":" ("_$P(^PS(50.607,PSONEW("UNITS",I),0),"^")_")",1:"")
"RTN","PSOBKDED",68,0)
DU I '$G(PSONEW("DOSE ORDERED",I)),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Oth. Lang. Dosage: "_$G(PSONEW("ODOSE",I))
"RTN","PSOBKDED",69,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("VERB",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Verb: "_$G(PSONEW("VERB",I))
"RTN","PSOBKDED",70,0)
 S:$G(PSONEW("DOSE ORDERED",I)) IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="      Dispense Units: "_$S($E($G(PSONEW("DOSE ORDERED",I)),1)=".":"0",1:"")_$G(PSONEW("DOSE ORDERED",I))
"RTN","PSOBKDED",71,0)
 I $G(PSONEW("DOSE ORDERED",I)),$G(PSONEW("NOUN",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                Noun: "_PSONEW("NOUN",I)
"RTN","PSOBKDED",72,0)
 I $G(PSONEW("ROUTE",I)) S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="               Route: "_$P(^PS(51.2,PSONEW("ROUTE",I),0),"^")
"RTN","PSOBKDED",73,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="            Schedule: "_PSONEW("SCHEDULE",I)
"RTN","PSOBKDED",74,0)
 I $G(PSONEW("DURATION",I))]"" D
"RTN","PSOBKDED",75,0)
 .S IEN=IEN+1
"RTN","PSOBKDED",76,0)
 .S ^TMP("PSOPO",$J,IEN,0)="           *Duration: "_PSONEW("DURATION",I)_" ("_$S(PSONEW("DURATION",I)["M":"MINUTES",PSONEW("DURATION",I)["W":"WEEKS",PSONEW("DURATION",I)["L":"MONTHS",PSONEW("DURATION",I)["H":"HOURS",1:"DAYS")_")"
"RTN","PSOBKDED",77,0)
 I $G(PSONEW("CONJUNCTION",I))]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="         Conjunction: "_$S($G(PSONEW("CONJUNCTION",I))="A":"AND",$G(PSONEW("CONJUNCTION",I))="T":"THEN",$G(PSONEW("CONJUNCTION",I))="X":"EXCEPT",1:"")
"RTN","PSOBKDED",78,0)
 Q
"RTN","PSOBKDED",79,0)
RTE I $G(DRET) S PSORXED("ROUTE",ENT)=""
"RTN","PSOBKDED",80,0)
 I $G(RTE) K RTE
"RTN","PSOBKDED",81,0)
 K DIR,DIRUT S DIR(0)="FO^2:45",DIR("A")="ROUTE",DIR("?")="^D HLP^PSOORED4"
"RTN","PSOBKDED",82,0)
 S DIR("B")=$S($G(PSORXED("ROUTE",ENT)):$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^"),$G(RTE)]"":RTE,$G(DRET):"",1:"PO") K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",83,0)
 ;I '$G(PSORXED("ROUTE",ENT)),$G(PSOREEDT) K DIR("B")
"RTN","PSOBKDED",84,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="RTE",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOBKDED",85,0)
 Q:$D(DTOUT)!($D(DUOUT))
"RTN","PSOBKDED",86,0)
 I X="@"!(X="") K RTE,ERTE S DRET=1,PSORXED("ROUTE",ENT)="" Q
"RTN","PSOBKDED",87,0)
 K DRET I X=$P($G(^PS(51.2,+$G(PSORXED("ROUTE",ENT)),0)),"^") S RTE=$P(^PS(51.2,PSORXED("ROUTE",ENT),0),"^") W X_" "_$G(ERTE) Q
"RTN","PSOBKDED",88,0)
 S DIC=51.2,DIC(0)="QEZM",DIC("S")="I $P(^(0),""^"",4)" D ^DIC Q:X[U  G:Y=-1 RTE W "  "_$P(Y(0),"^",2)
"RTN","PSOBKDED",89,0)
 S:X'="" PSORXED("ROUTE",ENT)=+Y,RTE=Y(0,0),ERTE=$P(Y(0),"^",2)
"RTN","PSOBKDED",90,0)
 Q
"RTN","PSOBKDED",91,0)
ASK K JUMP,UNITN,DOSE D KV D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN)
"RTN","PSOBKDED",92,0)
 I $D(DOSE("DD")) I $G(PSOFROM)="PENDING"!($G(PSOREEDQ)) D LST2^PSOBKDE1 G ASK1
"RTN","PSOBKDED",93,0)
 D:$G(PSOFROM)="NEW"&($G(PSORX("EDIT"))']"")!($G(PSOFROM1))!($G(COPY)) LST^PSOBKDE1:$O(DOSE(0))
"RTN","PSOBKDED",94,0)
ASK1 S STRE=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",5),UNITN=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",6),DOSE("LD")=$P($G(DOSE("DD",PSODRUG("IEN"))),"^",11)
"RTN","PSOBKDED",95,0)
 W ! S DIR(0)="F^1:60",DIR("A",1)="Select from list of Available Dosages, Enter Free Text Dose",DIR("?")="^D LST1^PSOBKDE1",DIR("A")="or Enter a Question Mark (?) to view list"
"RTN","PSOBKDED",96,0)
 I $G(PSORXED("DOSE",ENT))]"" S DIR("B")=PSORXED("DOSE",ENT) D
"RTN","PSOBKDED",97,0)
 .I $G(PSORXED("UNITS",ENT))]"",DIR("B")'[($P($G(^PS(50.607,PSORXED("UNITS",ENT),0)),"^")) S DIR("B")=DIR("B")_$P($G(^PS(50.607,PSORXED("UNITS",ENT),0)),"^")
"RTN","PSOBKDED",98,0)
 K:$G(PSOREEDQ)!($G(PSOBDRG)) DIR("B")
"RTN","PSOBKDED",99,0)
 D ^DIR
"RTN","PSOBKDED",100,0)
 I X[U,$L(X)>1 S FIELD="ASK",JUMP=1 K DIRUT,DTOUT Q
"RTN","PSOBKDED",101,0)
 I $D(DIRUT) S:$G(ORD) PSODSPL=1 Q
"RTN","PSOBKDED",102,0)
 I X=$G(PSORXED("DOSE",ENT)),$D(DOSE(Y)) G GD1
"RTN","PSOBKDED",103,0)
 I X=$G(PSORXED("DOSE",ENT)) D  G DOS
"RTN","PSOBKDED",104,0)
 .S DOSE=X,UNITS=$G(PSORXED("UNITS",ENT))
"RTN","PSOBKDED",105,0)
 .I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("DOSE ORDERED",ENT),DUPD,PSORXED("NOUN",ENT)
"RTN","PSOBKDED",106,0)
GD1 N PSORXTE
"RTN","PSOBKDED",107,0)
 I $D(DOSE(Y)) D  G DOS ;from list
"RTN","PSOBKDED",108,0)
 .S DOSE=$S($P(DOSE(Y),"^"):$P(DOSE(Y),"^"),$P(DOSE(Y),"^",3)]"":$P(DOSE(Y),"^",3),1:1),DOLST=Y
"RTN","PSOBKDED",109,0)
 .I $P(DOSE(Y),"^") S UNITS=$P(DOSE(Y),"^",2),DUPD=$P(DOSE(Y),"^",3),UNITN=$P(DOSE("DD",PSODRUG("IEN")),"^",6),PSORXTE("DOSE ORDERED",ENT)=DUPD
"RTN","PSOBKDED",110,0)
 .S PSORXTE("NOUN",ENT)=$P(DOSE(Y),"^",6),PSORXTE("VERB",ENT)=$P(DOSE(Y),"^",8)
"RTN","PSOBKDED",111,0)
 .I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") D  Q
"RTN","PSOBKDED",112,0)
 ..S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("DOSE ORDERED",ENT),DUPD,PSORXED("NOUN",ENT)
"RTN","PSOBKDED",113,0)
 ..I $P($G(^PS(55,PSODFN,"LAN")),"^"),$G(PSOFROM)="PENDING" D LAN^PSOORED5 Q
"RTN","PSOBKDED",114,0)
 ..I $P($G(^PS(55,PSODFN,"LAN")),"^"),$G(PSOFROM)="NEW" D LAN^PSOORED5
"RTN","PSOBKDED",115,0)
 .S PSORXTE("UNITS",ENT)=$G(UNITS)
"RTN","PSOBKDED",116,0)
 S DOSE=Y,DOLST=0 ;non-numeric and numeric not in list
"RTN","PSOBKDED",117,0)
 I DOSE("LD") D
"RTN","PSOBKDED",118,0)
 .F I=1:1:$L(DOSE)  I $E(DOSE,I)'?.N&($E(DOSE,I)'?1" ")&($E(DOSE,I)'?1".") S DCHK=$G(DCHK)_$E(DOSE,I)
"RTN","PSOBKDED",119,0)
 .I $G(DCHK)]"" D
"RTN","PSOBKDED",120,0)
 ..S DCHK=$TR(DCHK,"qwertyuioplkjhgfdsazxcvbnm","QWERTYUIOPLKJHGFDSAZXCVBNM")
"RTN","PSOBKDED",121,0)
 ..I DCHK=UNITN S DOSE=+DOSE
"RTN","PSOBKDED",122,0)
 K I,DCHK
"RTN","PSOBKDED",123,0)
 S PSOINDT=$$GET1^DIQ(50,PSODRUG("IEN"),100,"I") I PSOINDT,DT>PSOINDT G DOS
"RTN","PSOBKDED",124,0)
 S PSORXTE("NOUN",ENT)=$P(DOSE("DD",PSODRUG("IEN")),"^",9),PSORXTE("VERB",ENT)=$P(DOSE("DD",PSODRUG("IEN")),"^",10)
"RTN","PSOBKDED",125,0)
 I DOSE'?.N&(DOSE'?.N1".".N)!'DOSE("LD") S (UNITN,UNITS,PSORXED("UNITS",ENT))="" K PSORXED("NOUN",ENT),PSORXED("ODOSE",ENT) G DOS
"RTN","PSOBKDED",126,0)
 S:$P(DOSE("DD",PSODRUG("IEN")),"^",6)]"" (PSORXTE("UNITS",ENT),UNITS)=$O(^PS(50.607,"B",$P(DOSE("DD",PSODRUG("IEN")),"^",6),0)),UNITN=$P(DOSE("DD",PSODRUG("IEN")),"^",6)
"RTN","PSOBKDED",127,0)
 S:$P(DOSE("DD",PSODRUG("IEN")),"^",5) DUPD=DOSE/$P(DOSE("DD",PSODRUG("IEN")),"^",5),PSORXTE("DOSE ORDERED",ENT)=DUPD
"RTN","PSOBKDED",128,0)
DOS W " "_$S($E(DOSE,1)="."&($G(UNITN)'=""):"0",1:"")_DOSE W:$G(UNITN)'="" UNITN
"RTN","PSOBKDED",129,0)
 W ! K DIR,DIRUT S DIR(0)="Y",DIR("A")="You entered "_$S($E(DOSE,1)="."&($G(UNITN)'=""):"0",1:"")_DOSE_$S($G(UNITN)'="":UNITN,1:"")_" is this correct",DIR("B")="Yes"
"RTN","PSOBKDED",130,0)
 D ^DIR I 'Y D KX K DOSE,UNITS,PSORXTE,PSOINDT G ASK
"RTN","PSOBKDED",131,0)
 S PSORXED("DOSE",ENT)=DOSE
"RTN","PSOBKDED",132,0)
 S:$G(PSORXTE("DOSE ORDERED",ENT))]"" PSORXED("DOSE ORDERED",ENT)=PSORXTE("DOSE ORDERED",ENT)
"RTN","PSOBKDED",133,0)
 S:$G(PSORXTE("NOUN",ENT))]"" PSORXED("NOUN",ENT)=PSORXTE("NOUN",ENT)
"RTN","PSOBKDED",134,0)
 S:$G(PSORXTE("VERB",ENT))]"" PSORXED("VERB",ENT)=PSORXTE("VERB",ENT)
"RTN","PSOBKDED",135,0)
 S:$G(PSORXTE("UNITS",ENT))]"" PSORXED("UNITS",ENT)=PSORXTE("UNITS",ENT)
"RTN","PSOBKDED",136,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD"),$P($G(^PS(55,PSODFN,"LAN")),"^") D
"RTN","PSOBKDED",137,0)
 .K OTHDOS(ENT) D KX S DIR(0)="52.0113,9"
"RTN","PSOBKDED",138,0)
 .I '$G(OTHDOS(ENT)),$G(PSORXED("ODOSE",ENT))']"" D LAN^PSOORED5
"RTN","PSOBKDED",139,0)
 .I $G(PSORXED("ODOSE",ENT))]"" S DIR("B")=PSORXED("ODOSE",ENT) K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",140,0)
 .K DTOUT,DUOUT,DIRUT,Y,X D ^DIR K DIR K:$G(X)="@"!($G(X)="") DIRUT I $D(DIRUT) Q
"RTN","PSOBKDED",141,0)
 .I X="@" S OTHDOS(ENT)=1 D KX K PSORXED("ODOSE",ENT) Q
"RTN","PSOBKDED",142,0)
 .S:X'="" PSORXED("ODOSE",ENT)=X
"RTN","PSOBKDED",143,0)
 Q
"RTN","PSOBKDED",144,0)
 ;
"RTN","PSOBKDED",145,0)
SCH D KX
"RTN","PSOBKDED",146,0)
 S DIR("?")="^D SCHLP^PSOORED4",DIR("A")="Schedule: ",DIR(0)="FA^1:20^I X[""""""""!(X?.E1C.E)!($A(X)=45)!($L(X,"" "")>3)!($L(X)>20)!($L(X)<1) K X"
"RTN","PSOBKDED",147,0)
 I '$D(PSOSCH),'$D(PSORXED("SCHEDULE",ENT)),$P(^PS(50.7,PSODRUG("OI"),0),"^",8)]"" S PSOSCH=$P(^PS(50.7,PSODRUG("OI"),0),"^",8)
"RTN","PSOBKDED",148,0)
 S DIR("B")=$S($D(PSOSCH)&('$D(PSORXED("SCHEDULE",ENT))):PSOSCH,$G(PSORXED("SCHEDULE",ENT))]"":PSORXED("SCHEDULE",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOBKDED",149,0)
 I $G(PSORXED("SCHEDULE",ENT))']"",$G(PSOREEDT) K DIR("B")
"RTN","PSOBKDED",150,0)
 D ^DIR
"RTN","PSOBKDED",151,0)
 Q
"RTN","PSOBKDED",152,0)
KX K X,Y
"RTN","PSOBKDED",153,0)
KV K DTOUT,DUOUT,DIR,DIRUT
"RTN","PSOBKDED",154,0)
 Q
"RTN","PSOBSET")
0^11^B10859246^B10572334
"RTN","PSOBSET",1,0)
PSOBSET ;BHAM ISC/CCG - BLACK LINE RESOLVER ; 10/24/92 13:23
"RTN","PSOBSET",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,268**;DEC 1997;Build 9
"RTN","PSOBSET",3,0)
ENLBL ;SET UP ^PS(52.9 ENTRY FROM ^PSOLBL
"RTN","PSOBSET",4,0)
 K ^PSOBPPL($J)
"RTN","PSOBSET",5,0)
 S ^PSOBPPL($J)=PPL,PSOBPC="," G:^PSOBPPL($J)="" Q^PSOBSET1 S ZZX=0 D IO G:ZZX Q^PSOBSET1 S PSOBPS=PSOSITE G:PSOBPS="" Q^PSOBSET1 G:'$D(^PS(59,PSOBPS,0)) Q^PSOBSET1
"RTN","PSOBSET",6,0)
 S PSOBVR1=$G(RXP),PSOBCP=$G(COPIES),PSOBVR2=$G(SIDE),PSOBR="L"
"RTN","PSOBSET",7,0)
LP S P=P+1,PSOBRX=$P(^PSOBPPL($J),",",P),PSOBVR1=$P(PSOBRX,"*",2),PSOBRX=$P(PSOBRX,"*",1) G:PSOBRX="" Q^PSOBSET1 G:'$D(^PSRX(PSOBRX,0)) LP S PSOBDPT=$P(^PSRX(PSOBRX,0),"^",2) G ^PSOBSET1
"RTN","PSOBSET",8,0)
NWIO L +^PS(52.9,0):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) G:'$T NWIO S Z=$P(^PS(52.9,0),"^",3),ZX=$P(^(0),"^",4)
"RTN","PSOBSET",9,0)
LP3 S Z=Z+1,ZX=ZX+1 G:$D(^PS(52.9,Z,0)) LP3 S ^PS(52.9,0)=$P(^PS(52.9,0),"^",1,2)_"^"_Z_"^"_ZX L -^PS(52.9,0) S ^PS(52.9,Z,0)=PSOBIO,^PS(52.9,Z,1,0)="^52.9001PI^^",^PS(52.9,"B",PSOBIO,Z)="" Q
"RTN","PSOBSET",10,0)
IO I $D(IOS),IOS]"" G IO1
"RTN","PSOBSET",11,0)
 S IOP=IO,%ZIS="N",ZZX=1 D ^%ZIS K IOP Q:ION=""
"RTN","PSOBSET",12,0)
IO1 S PSOBIO=IOS
"RTN","PSOBSET",13,0)
 D:'$D(^PS(52.9,"B",PSOBIO)) NWIO S PSOBIO=$O(^PS(52.9,"B",PSOBIO,0)),(ZZX,P)=0,(PSOBVR1,PSOBCP,PSOBVR2)="" Q
"RTN","PSOBSET",14,0)
GP S PSOBR="P" G ^PSOBSET1
"RTN","PSOBSET",15,0)
EN1P S ZZX=0 D IO G:ZZX Q^PSOBSET1 S PSOBPC=",",PSOBPS=PSOSITE,PSOBDPT=DFN,(^PSOBPPL($J),PSOBPPL1)="" S:$D(PSODTCUT) PSOBVR1=PSODTCUT S:$D(PSOPRPAS) PSOBVR2=PSOPRPAS S:$D(NEW1) ^PSOBPPL($J)=NEW1 S:$D(NEW11) PSOBPPL1=NEW11 G GP
"RTN","PSOBSET",16,0)
SSUS S ZZX=0 D IO G:ZZX Q^PSOBSET1 S PSOBPS=PSOSITE,PSOBR="L",PSOBS="",PSOBII=0,PSOBPC="," K ZRXP
"RTN","PSOBSET",17,0)
 F ZII=0:0 S ZII=$O(^TMP($J,"PSOSU",XAK,ZII)) Q:'ZII  S RX=^(ZII),PSOBVR1=$P(RX,"^",5),ZZRXP=$P(RX,"^",3),RX=+RX D S1
"RTN","PSOBSET",18,0)
S0 I 'PSOBII F ZII=0:0 S ZII=$O(^PSOBPPL($J,ZII)) Q:'ZII  S:^PSOBPPL($J,ZII)'="" PSOBVR1=^PSOBPPL($J,ZII) S ^PSOBPPL($J)=^PSOBPPL($J,ZII,1),P=0 D LP
"RTN","PSOBSET",19,0)
 K ZRXP,ZZRXP,PSOBII,RX,PSOBPS,PSOBS G Q^PSOBSET1
"RTN","PSOBSET",20,0)
S1 I $D(ZRXP),ZZRXP=ZRXP G S2
"RTN","PSOBSET",21,0)
 S PSOBII=PSOBII+1,^PSOBPPL($J,PSOBII,1)="",^PSOBPPL($J,PSOBII)=ZZRXP
"RTN","PSOBSET",22,0)
S2 S ZRXP=ZZRXP,^PSOBPPL($J,PSOBII,1)=^PSOBPPL($J,PSOBII,1)_RX_"*"_PSOBVR1_"," Q
"RTN","PSOBSET",23,0)
SUS S ZZX=0 D IO G:ZZX Q^PSOBSET1 S PSOBPS=PSOSITE,PSOBR="L",PSOBS="",PSOBII=0,PSOBPC="," K ZRXP
"RTN","PSOBSET",24,0)
 F ZII=0:0 S ZII=$O(^PS(52.5,"C",ZI,ZII)) Q:'ZII  I $D(^PS(52.5,ZII,0)),+$P(^(0),"^",6)=PSOSITE,'$D(^("P")) S RX=^(0),ZZRXP=$P(RX,"^",3),PSOBVR1=$P(RX,"^",5),RX=+RX D S1
"RTN","PSOBSET",25,0)
 G S0
"RTN","PSOBSET1")
0^12^B9659651^B9338827
"RTN","PSOBSET1",1,0)
PSOBSET1 ;BHAM ISC/CCG - BLACK LINE RESOLVER ; 10/24/92 13:23
"RTN","PSOBSET1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**268**;DEC 1997;Build 9
"RTN","PSOBSET1",3,0)
 S PSOBMX=$P(^PS(59,PSOBPS,0),"^",9) S:+PSOBMX<1000 PSOBMX=1000,^PS(59,PSOBPS,0)=$P(^(0),"^",1,8)_"^1000^"_$P(^(0),"^",10,255)
"RTN","PSOBSET1",4,0)
LCK L +^PS(52.9,PSOBIO,1,0):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) G:'$T LCK S Z=$P(^PS(52.9,PSOBIO,1,0),"^",3),ZX=$P(^(0),"^",4)
"RTN","PSOBSET1",5,0)
LP S Z=Z+1,ZX=ZX+1 G:$D(^PS(52.9,PSOBIO,1,Z,0)) LP D:(ZX>PSOBMX)&($D(^PS(52.9,PSOBIO,1,Z-PSOBMX))) DEL S ^PS(52.9,PSOBIO,1,0)=$P(^PS(52.9,PSOBIO,1,0),"^",1,2)_"^"_Z_"^"_ZX L -^PS(52.9,PSOBIO,1,0) S %DT="T",X="N" D ^%DT
"RTN","PSOBSET1",6,0)
 S ^PS(52.9,PSOBIO,1,Z,0)=PSOBDPT_"^"_PSOBR_"^"_Y_"^"_$G(RXP)_"^"_PSOBCP_"^"_PSOBVR2_"^"_PSOBPS,^PS(52.9,PSOBIO,1,"B",PSOBDPT,Z)="",PSOB=0
"RTN","PSOBSET1",7,0)
 S PSOBPCZ=PSOBPC F P=1:1:$L(^PSOBPPL($J)) I $E(^PSOBPPL($J),P)'?.AN,$E(^($J),P)'="*" S PSOBPC=$E(^($J),P) Q
"RTN","PSOBSET1",8,0)
PPL F P=1:1 Q:($P(^PSOBPPL($J),PSOBPC,P)="")&(P'=1)  S PSOBRX=$P($P(^PSOBPPL($J),PSOBPC,P),"*",1) D:PSOBRX'="" C
"RTN","PSOBSET1",9,0)
 I $D(PSOBPPL1),PSOBPPL1'="" S ^PSOBPPL($J)=PSOBPPL1 K PSOBPPL1 G PPL
"RTN","PSOBSET1",10,0)
 I PSOB S ^PS(52.9,PSOBIO,1,Z,2,0)="^52.9002P^"_PSOB_"^"_PSOB
"RTN","PSOBSET1",11,0)
 I +$P(^PS(52.9,PSOBIO,1,0),"^",3)=0 K ^PS(52.9,"B",^PS(52.9,PSOBIO,0),PSOBIO),^PS(52.9,PSOBIO) S ^PS(52.9,0)=$P(^PS(52.9,0),"^",1,2)_"^"_($P(^(0),"^",3)-1)_"^"_($P(^(0),"^",4)-1)
"RTN","PSOBSET1",12,0)
Q S:$D(PSOBPCZ) PSOBPC=PSOBPCZ K PSOBPCZ K:'$D(PSOBS) I,IOP,PSOBPPL1,PSOBR,PSOBPC,PSOBPS,^PSOBPPL($J),PSOB,PSOBIO,PSOBRX,PSOBDPT,PSOBCP,PSOBVR2,PSOBVR1,PSOBZ,PSOBMX,X,Y,Z,ZZX,ZX,P,%ZIS,%ZIS("B")
"RTN","PSOBSET1",13,0)
 Q
"RTN","PSOBSET1",14,0)
C Q:'$D(^PSRX(PSOBRX,0))  S PSOB=PSOB+1,^PS(52.9,PSOBIO,1,Z,2,PSOB,0)=PSOBRX,^PS(52.9,PSOBIO,1,"C",PSOBRX,Z,PSOB)="" S:$G(RXPR(PSOBRX)) $P(^PS(52.9,PSOBIO,1,Z,2,PSOB,0),"^",2)=$G(RXPR(PSOBRX))
"RTN","PSOBSET1",15,0)
 S:$D(RXFL(PSOBRX)) $P(^PS(52.9,PSOBIO,1,Z,2,PSOB,0),"^",3)=$G(RXFL(PSOBRX)) Q
"RTN","PSOBSET1",16,0)
DEL S ZZX=Z-PSOBMX F I=0:0 S I=$O(^PS(52.9,PSOBIO,1,ZZX,2,I)) Q:'I  K ^PS(52.9,PSOBIO,1,"C",^PS(52.9,PSOBIO,1,ZZX,2,I,0),ZZX)
"RTN","PSOBSET1",17,0)
 S PSOBZ=$P(^PS(52.9,PSOBIO,1,ZZX,0),"^") K ^PS(52.9,PSOBIO,1,"B",+PSOBZ,ZZX),^PS(52.9,PSOBIO,1,ZZX) S ZX=ZX-1 Q
"RTN","PSOCAN4")
0^76^B42203941^B42089158
"RTN","PSOCAN4",1,0)
PSOCAN4 ;BIR/SAB-rx speed dc listman ; 10/23/06 11:50am
"RTN","PSOCAN4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,24,27,63,88,117,131,259,268**;DEC 1997;Build 9
"RTN","PSOCAN4",3,0)
 ;External reference to File #200 supported by DBIA 224
"RTN","PSOCAN4",4,0)
 ;External reference NA^ORX1 supported by DBIA 2186
"RTN","PSOCAN4",5,0)
 ;External references to L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN4",6,0)
 ;External reference to PSDRUG supported by DBIA 221
"RTN","PSOCAN4",7,0)
 ;External reference to PS(50.7 supported by DBIA 2223
"RTN","PSOCAN4",8,0)
 ;External reference to PS(50.606 supported by DBIA 2174
"RTN","PSOCAN4",9,0)
SEL I '$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Unauthorized Action Selection.",VALMBCK="" Q
"RTN","PSOCAN4",10,0)
 N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!" S VALMBCK="" Q
"RTN","PSOCAN4",11,0)
 S DFNHLD=PSODFN
"RTN","PSOCAN4",12,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOCAN4",13,0)
 K PSOPLCK S RXCNT=0 K PSOFDR,DIR,DUOUT,DIRUT S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR S LST=Y I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" D ULP Q
"RTN","PSOCAN4",14,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +LST S (SPEED,PSOOELSE)=1 D  D KCAN^PSOCAN3
"RTN","PSOCAN4",15,0)
 .S PSOCANRA=1 D RQTEST
"RTN","PSOCAN4",16,0)
 .D FULL^VALM1,COM^PSOCAN1 I '$D(INCOM)!($D(DIRUT)) K SPEED S VALMBCK="R" Q
"RTN","PSOCAN4",17,0)
 .D FULL^VALM1 F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD) D @$S(+PSOLST(ORN)=52:"RX",1:"PEN")
"RTN","PSOCAN4",18,0)
 .S VALMBCK="R"
"RTN","PSOCAN4",19,0)
 I '$G(PSOOELSE) S VALMBCK=""
"RTN","PSOCAN4",20,0)
 D ^PSOBUILD,BLD^PSOORUT1 K PSOMSG,RXCNT,DIR,DIRUT,DTOUT,DUOUT,LST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,PSORNW,PSORENW,PSONO,PSOCO,PSOCU,PSODIR,DSMSG,SAVORD,SAVORN,SPEED,DIRUT,PSONOOR
"RTN","PSOCAN4",21,0)
 D INVALD^PSOCAN1 K PSINV,PSOOELSE,INCOM,COM S PSODFN=DFNHLD K DFNHLD D ULP
"RTN","PSOCAN4",22,0)
 Q
"RTN","PSOCAN4",23,0)
ULP D UL^PSSLOCK(+$G(PSODFN)) Q
"RTN","PSOCAN4",24,0)
 ;
"RTN","PSOCAN4",25,0)
RX Q:'$D(^XUSEC("PSORPH",DUZ))
"RTN","PSOCAN4",26,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D  D PAUSE^VALM1 K PSOMSG Q
"RTN","PSOCAN4",27,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P($G(PSOMSG),"^",2),!,"Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),! Q
"RTN","PSOCAN4",28,0)
 .W $C(7),!!,"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),!
"RTN","PSOCAN4",29,0)
 S RXSP=1 K PSCAN S (EN,X)=$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^") S Y=$P(PSOLST(ORN),"^",2)_"^"_X,Y(0,0)=X,Y(0)=$G(^PSRX($P(PSOLST(ORN),"^",2),0)) D
"RTN","PSOCAN4",30,0)
 .I $P(^PSRX(+Y,"STA"),"^")=1!($P(^("STA"),"^")=4) D  Q
"RTN","PSOCAN4",31,0)
 ..I $P($G(^PSRX(+Y,"PKI")),"^") N PKI,PKI1,PKIR,PKIE,DA S DA=+Y D CER^PSOPKIV1
"RTN","PSOCAN4",32,0)
 ..S:$G(PSONOOR)'="" PSONOORA=$G(PSONOOR) D DEL S:$G(PSONOORA)'="" PSONOOR=$G(PSONOORA) K PSONOORA Q
"RTN","PSOCAN4",33,0)
 .S YY=Y,YY(0,0)=Y(0,0),(PSODFN,DFN)=$P(Y(0),"^",2) D:$G(DFN) CHK^PSOCAN I DEAD!($P(^PSRX(+YY,"STA"),"^")>11),$P(^("STA"),"^")<16 S PSINV(EN)="" Q
"RTN","PSOCAN4",34,0)
 .S DA=+YY I $P($G(^PSRX(DA,"STA")),"^")=11!($P($G(^(2)),"^",6)<DT) D EXP^PSOCAN
"RTN","PSOCAN4",35,0)
 .S RX=YY(0,0) D:$D(^PSRX(DA,0)) SPEED1^PSOCAN1
"RTN","PSOCAN4",36,0)
 K YY I '$D(PSCAN) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN4",37,0)
 S RX="",RXCNT=0 F  S RX=$O(PSCAN(RX)) Q:RX=""  S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),RXCNT=RXCNT+1 D SHOW^PSOCAN1
"RTN","PSOCAN4",38,0)
 S RX="" F  S RX=$O(PSCAN(RX)) Q:RX=""  D ACT
"RTN","PSOCAN4",39,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOCAN4",40,0)
 Q
"RTN","PSOCAN4",41,0)
ACT S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),II=RX,PSODFN=$P(^PSRX(DA,0),"^",2) I REA="R" D REINS^PSOCAN2 Q
"RTN","PSOCAN4",42,0)
 D CAN1^PSOCAN3 Q
"RTN","PSOCAN4",43,0)
PEN ;discontinue pending orders
"RTN","PSOCAN4",44,0)
 S SAVORD=ORD,SAVORN=ORN
"RTN","PSOCAN4",45,0)
 S ORD=$P(PSOLST(ORN),"^",2) D PSOL^PSSLOCK(+ORD_"S") I '$G(PSOMSG) D  D MEDDIS K PSOMSG G OK
"RTN","PSOCAN4",46,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P($G(PSOMSG),"^",2)_"  (Pending order)",! Q
"RTN","PSOCAN4",47,0)
 .W $C(7),!!,"Another person is editing this Pending order.",!
"RTN","PSOCAN4",48,0)
 I $P(^PS(52.41,ORD,0),"^",3)="RF" S DA=ORD,DIK="^PS(52.41," D ^DIK K DA,DIK D PSOUL^PSSLOCK(ORD_"S") Q
"RTN","PSOCAN4",49,0)
 K ^PS(52.41,"AOR",$P(^PS(52.41,ORD,0),"^",2),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD) S $P(^PS(52.41,ORD,0),"^",3)="DC"
"RTN","PSOCAN4",50,0)
 D EN^PSOHLSN(+^PS(52.41,ORD,0),"OC",INCOM,PSONOOR)
"RTN","PSOCAN4",51,0)
 D PSOUL^PSSLOCK(ORD_"S")
"RTN","PSOCAN4",52,0)
OK S ORD=SAVORD,ORN=SAVORN Q
"RTN","PSOCAN4",53,0)
NOOR ;ask nature of order
"RTN","PSOCAN4",54,0)
 D FULL^VALM1
"RTN","PSOCAN4",55,0)
 K DIR,DTOUT,DTOUT,DIRUT I $T(NA^ORX1)]"" D  Q:$D(DIRUT)  G NOORXP
"RTN","PSOCAN4",56,0)
 .S PSONOOR=$$NA^ORX1("S",0,"B","Nature of Order",0,"WPSDIVR"_$S(+$G(^VA(200,DUZ,"PS")):"E",1:""))
"RTN","PSOCAN4",57,0)
 .I +PSONOOR S PSONOOR=$P(PSONOOR,"^",3) Q
"RTN","PSOCAN4",58,0)
 .S DIRUT=1 K PSONOOR
"RTN","PSOCAN4",59,0)
 S DIR("A")="Nature of Order: ",DIR("B")=$S($G(DODR):"SERVICE CORRECTED",1:"WRITTEN")
"RTN","PSOCAN4",60,0)
 S DIR(0)="SA^W:WRITTEN;V:VERBAL;P:TELEPHONE;S:SERVICE CORRECTED;D:DUPLICATE;I:POLICY;R:SERVICE REJECTED"_$S(+$G(^VA(200,DUZ,"PS")):";E:PROVIDER ENTERED",1:"")
"RTN","PSOCAN4",61,0)
 D ^DIR K DIR,DTOUT,DTOUT Q:$D(DIRUT)  S PSONOOR=Y
"RTN","PSOCAN4",62,0)
NOORXP I $G(PSOCANRA),'$G(PSOCANRZ) D REQ
"RTN","PSOCAN4",63,0)
NOORX S:$D(DIRUT)&($G(SPEED)) VALMBCK="Q"
"RTN","PSOCAN4",64,0)
 Q
"RTN","PSOCAN4",65,0)
DEL ;deletes non-verified Rxs
"RTN","PSOCAN4",66,0)
 D FULL^VALM1
"RTN","PSOCAN4",67,0)
 W ! K DIR,DIRUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A",1)="Rx # "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")_" is in a Non-Verified Status.",DIR("A")="Are sure you want to mark the Rx as deleted" D ^DIR I 'Y!($D(DIRUT)) S VALMBCK="R" G EX
"RTN","PSOCAN4",68,0)
 I '$G(SPEED) D  I $D(DIRUT) G EX
"RTN","PSOCAN4",69,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) S VALMSG="No Action Taken!",VALMBCK="R" Q
"RTN","PSOCAN4",70,0)
 .K DIR S DIR("A")="Comments",DIR("B")="Per Pharmacy Request",DIR(0)="F^5:100" D ^DIR K DIR I $D(DIRUT) S VALMSG="No Action Taken!" Q
"RTN","PSOCAN4",71,0)
 K PSDEL,PSORX("INTERVENE") S PSOZVER=1,DA=$P(PSOLST(ORN),"^",2)
"RTN","PSOCAN4",72,0)
 I $G(PKI1) N INCOM S INCOM=Y D DCV^PSOPKIV1 Q
"RTN","PSOCAN4",73,0)
 D ENQ^PSORXDL
"RTN","PSOCAN4",74,0)
EX Q
"RTN","PSOCAN4",75,0)
REQ ;prompt for requesting provider
"RTN","PSOCAN4",76,0)
 I '$G(PSOCANRD),$G(PSOCANRP),$G(ORD),$D(^PS(52.41,ORD,0)) S PSOCANRD=+$P($G(^PS(52.41,ORD,0)),"^",5)
"RTN","PSOCAN4",77,0)
 I $G(PSOCANRD) D
"RTN","PSOCAN4",78,0)
 .I $D(^VA(200,PSOCANRD,"PS")),$P($G(^("PS")),"^"),$S('$P(^("PS"),"^",4):1,1:$P(^("PS"),"^",4)'<DT) Q
"RTN","PSOCAN4",79,0)
 .K PSOCANRD
"RTN","PSOCAN4",80,0)
 W ! K DIC S DIC=200,DIC(0)="AEQMZ",DIC("A")="Requesting PROVIDER: ",DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)" I $G(PSOCANRD) S DIC("B")=PSOCANRD
"RTN","PSOCAN4",81,0)
 D ^DIC K DIC S:$G(Y)<0!($D(DTOUT))!($D(DUOUT)) DIRUT=1 I $G(Y) S PSOCANRC=+$G(Y),PSOCANRN=$P($G(Y),"^",2),PSOCANRZ=1
"RTN","PSOCAN4",82,0)
 Q
"RTN","PSOCAN4",83,0)
RQTEST ;
"RTN","PSOCAN4",84,0)
 N PMIN,PMINZ,PMINFLAG
"RTN","PSOCAN4",85,0)
 S PMINFLAG=0 F PMIN=1:1:$L(LST,",") Q:$P(LST,",",PMIN)']""  S PMINZ=$P(LST,",",PMIN) D
"RTN","PSOCAN4",86,0)
 .I $P($G(PSOLST(PMINZ)),"^")=52 I $P($G(^PSRX(+$P($G(PSOLST(PMINZ)),"^",2),"STA")),"^")'=12,'$G(PMINFLAG) S PSOCANRD=+$P($G(^PSRX(+$P($G(PSOLST(PMINZ)),"^",2),0)),"^",4) S PMINFLAG=1
"RTN","PSOCAN4",87,0)
 .I $P($G(PSOLST(PMINZ)),"^")=52.41,'$G(PMINFLAG) S PSOCANRD=$P($G(^PS(52.41,+$P($G(PSOLST(PMINZ)),"^",2),0)),"^",5) S PMINFLAG=1
"RTN","PSOCAN4",88,0)
 I '$G(PMINFLAG) S PSOCANRZ=1
"RTN","PSOCAN4",89,0)
 Q
"RTN","PSOCAN4",90,0)
MEDDIS ;
"RTN","PSOCAN4",91,0)
 N PSOFMMD
"RTN","PSOCAN4",92,0)
 Q:'$G(ORD)
"RTN","PSOCAN4",93,0)
 Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOCAN4",94,0)
 I $P(^PS(52.41,ORD,0),"^",9) W "Drug: "_$P($G(^PSDRUG(+$P(^PS(52.41,ORD,0),"^",9),0)),"^") D PAUSE^VALM1 Q
"RTN","PSOCAN4",95,0)
 I $P(^PS(52.41,ORD,0),"^",8) S PSOFMMD=$P(^(0),"^",8) W "Orderable Item: "_$P($G(^PS(50.7,PSOFMMD,0)),"^")_"  "_$P($G(^PS(50.606,+$P($G(^PS(50.7,PSOFMMD,0)),"^",2),0)),"^") D PAUSE^VALM1
"RTN","PSOCAN4",96,0)
 Q
"RTN","PSOCAN4",97,0)
 ;
"RTN","PSOCAN4",98,0)
REF ;CONT. FROM REF^PSOCAN2; PSO*7*259
"RTN","PSOCAN4",99,0)
 N PSOSIEN S PSOSIEN=0
"RTN","PSOCAN4",100,0)
 F  S PSOSIEN=$O(^PS(52.5,"B",DA,PSOSIEN)) Q:'PSOSIEN  D  Q:PSONODEL
"RTN","PSOCAN4",101,0)
 .I $P($G(^PS(52.5,PSOSIEN,0)),"^",13)'=IFN Q  ;NOT SAME REFILL
"RTN","PSOCAN4",102,0)
 .I '$P($G(^PS(52.5,PSOSIEN,"P")),"^") Q  ;SUSPENSE LABEL PRINT
"RTN","PSOCAN4",103,0)
 .S PSONODEL=1   ;REFILL NODE SHOULD NOT BE DELETED
"RTN","PSOCAN4",104,0)
 Q
"RTN","PSOCLUTL")
0^17^B30326336^B29603769
"RTN","PSOCLUTL",1,0)
PSOCLUTL ;BHAM ISC/DMA - utilities for clozapine reporting system ; 12/22/92
"RTN","PSOCLUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**28,56,122,222,268**;DEC 1997;Build 9
"RTN","PSOCLUTL",3,0)
 ;External reference ^YSCL(603.01 supported by DBIA 2697
"RTN","PSOCLUTL",4,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOCLUTL",5,0)
 ;
"RTN","PSOCLUTL",6,0)
REG ; register patient
"RTN","PSOCLUTL",7,0)
 S DIC=55,DLAYGO=55,DIC(0)="AEQL",DIC("A")="Select patient to register: " D ^DIC K DIC G END:Y<0 S PSO1=+Y,PSONAME=$P(^DPT(PSO1,0),"^") K DLAYGO
"RTN","PSOCLUTL",8,0)
 D:$P($G(^PS(55,PSO1,0)),"^",6)'=2 EN^PSOHLUP(PSO1)
"RTN","PSOCLUTL",9,0)
 I '$D(^YSCL(603.01,"C",PSO1)) W !!,PSONAME_" has not been authorized for Clozapine",!,"by the NCCC in Dallas.  Contact the NCCC in Dallas for authorization." D OVER G:'$G(%) REG S JADOVER=""
"RTN","PSOCLUTL",10,0)
 I $P($G(^PS(55,PSO1,"SAND")),"^")]"" S PSO4=^("SAND") W !!,PSONAME_" is already registered with number "_$P(PSO4,"^"),!!,"Use the edit option to change registration data, or",!,"contact your supervisor",! G REG
"RTN","PSOCLUTL",11,0)
NUMBER S DIR(0)="55,53" D ^DIR S PSO2=Y K DIR I $D(DIRUT) W !,"Not registered",! D END G REG
"RTN","PSOCLUTL",12,0)
 I $D(^PS(55,"ASAND1",PSO2)),$O(^(PSO2,0))'=PSO1 W !,PSO2," is already assigned to ",$P(^DPT(+$O(^(0)),0),"^") W !,"Please contact your supervisor" D END G REG
"RTN","PSOCLUTL",13,0)
 I '$D(JADOVER),'$D(^YSCL(603.01,"B",PSO2)) W !!,"The NCCC in Dallas has not authorized "_PSO2_" for useage",!,"at this facility.  Contact the NCCC in Dallas for authorization." D OVER G:'$G(%) END
"RTN","PSOCLUTL",14,0)
 S DIR("A")="Pre-treatment or Active treatment? ",DIR(0)="S^P:PRE-TREATMENT;A:ACTIVE TREATMENT;",DIR("?")="Is this patient new to the Clozapine program, or has s/he been receiving treatment?" D ^DIR K DIR S PSO3=Y
"RTN","PSOCLUTL",15,0)
 I $D(DIRUT) W !!,"Not registered" R X:10 K X G END
"RTN","PSOCLUTL",16,0)
PHY S DIC="^VA(200,",DIC(0)="AEQMZ",DIC("A")="Provider responsible: ",DIC("S")="I $G(^VA(200,+Y,""PS""))]""""" D ^DIC K DIC I Y<0 W !!,"Not registered",!! R X:10 K X G END
"RTN","PSOCLUTL",17,0)
 I $P($G(^VA(200,+Y,"PS")),"^",2)']"" W !!,"Only providers with DEA numbers entered in the New Person",!,"file can register patients in this program.",!! G PHY
"RTN","PSOCLUTL",18,0)
 S PSO4=+Y K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOCLUTL",19,0)
 S DIR("A",1)="OK to register "_PSONAME_" with number "_PSO2,DIR("A")="as a"_$S('PSO3:" new",1:"n ongoing")_" patient in this program "
"RTN","PSOCLUTL",20,0)
 S DIR(0)="Y",DIR("B")="NO" D ^DIR K DIR I Y=0 G END
"RTN","PSOCLUTL",21,0)
SAVE S DA=PSO1,DIE=55,DR="53////"_PSO2_";54////"_PSO3_";57////"_PSO4_";56////0;58////"_DT L +^PS(55,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !!,$C(7),"Patient "_PSONAME_" is being edited by another user!  Try Later." G END
"RTN","PSOCLUTL",22,0)
 D ^DIE L -^PS(55,DA)
"RTN","PSOCLUTL",23,0)
END K %,%Y,C,D,D0,DA,DI,DQ,DFN,DIC,DIE,DR,PSO,PSO1,PSO2,PSO3,PSO4,PSOC,PSOLN,PSONAME,PSONO,PSOT,R,VAERR,XMDUZ,XMSUB,XMTEXT,Y,^TMP($J),^TMP("PSO",$J) Q
"RTN","PSOCLUTL",24,0)
 Q
"RTN","PSOCLUTL",25,0)
 ;
"RTN","PSOCLUTL",26,0)
FACILITY ;Enter facility DEA number to set up clozapine system
"RTN","PSOCLUTL",27,0)
 ;this entry point is no longer used.  this functionality was taken over
"RTN","PSOCLUTL",28,0)
 ;by the mental health package with the release of YS*5.01*18
"RTN","PSOCLUTL",29,0)
 ;W ! S DIC=59,DIC(0)="AEQM",DIC("A")="Select site to participate in clozapine program : " D ^DIC G END:Y<0
"RTN","PSOCLUTL",30,0)
 ;S DIE=DIC,DA=+Y,DR="1R;2R;" L +^PS(59,DA) D ^DIE L -^PS(59,DA) G FACILITY
"RTN","PSOCLUTL",31,0)
 Q
"RTN","PSOCLUTL",32,0)
 ;
"RTN","PSOCLUTL",33,0)
 ;
"RTN","PSOCLUTL",34,0)
AGAIN ; re-enter patient - new number, status and provider
"RTN","PSOCLUTL",35,0)
 S DIC=55,DIC(0)="AEQM",DIC("A")="Select clozapine patient : " D ^DIC K DIC G END:Y<0 S DA=+Y,PSO1=DA,PSONAME=$P(^DPT(DA,0),"^")
"RTN","PSOCLUTL",36,0)
 I $P($G(^PS(55,DA,"SAND")),"^")="" W !,PSONAME_" is not registered.  Use the register option." G AGAIN
"RTN","PSOCLUTL",37,0)
 I '$D(^YSCL(603.01,"C",PSO1)) W !!,PSONAME_" has not been authorized for Clozapine",!,"by the NCCC in Dallas.  Contact the NCCC in Dallas for authorization." D OVER G:'$G(%) AGAIN S JADOVER=""
"RTN","PSOCLUTL",38,0)
 S DIR(0)="55,53" D ^DIR G END:$D(DIRUT) S PSO2=Y I $D(^PS(55,"ASAND1",PSO2)),$O(^(PSO2,0))'=PSO1 W !,PSO2," already assigned to ",$P(^DPT($O(^(0)),0),"^") G END
"RTN","PSOCLUTL",39,0)
 I '$D(JADOVER),'$D(^YSCL(603.01,"B",PSO2)) W !!,"The NCCC in Dallas has not authorized "_PSO2_" for usage",!,"at this facility.  Contact the NCCC in Dallas for authorization." D OVER G:'$G(%) END
"RTN","PSOCLUTL",40,0)
 ;S DIR(0)="55,54" D ^DIR G END:$D(DIRUT) S PSO3=Y
"RTN","PSOCLUTL",41,0)
 S PSO3=$P(^PS(55,DA,"SAND"),"^",2)
"RTN","PSOCLUTL",42,0)
 W !,$P(^DD(55,54,0),"^")_": "_$S(PSO3="A":"ACTIVE TREATMENT",PSO3="D":"DISCONTINUED",PSO3="H":"TREATMENT ON HOLD",1:"PRE-TREATMENT")
"RTN","PSOCLUTL",43,0)
PHY1 ;
"RTN","PSOCLUTL",44,0)
 S PSO4=$P(^PS(55,DA,"SAND"),"^",5),DIR(0)="55,57" D ^DIR G END:$D(DIRUT) I Y S PSO4=+Y
"RTN","PSOCLUTL",45,0)
 I $P($G(^VA(200,PSO4,"PS")),"^",2)="" W !!,"Only providers with DEA numbers entered in the New Person",!,"file can register patients in this program.",!! G PHY1
"RTN","PSOCLUTL",46,0)
 G SAVE
"RTN","PSOCLUTL",47,0)
 ;
"RTN","PSOCLUTL",48,0)
OVER ;allow registration of patients and clozapine numbers not yet authorized by the NCCC.
"RTN","PSOCLUTL",49,0)
 K DIR W ! S DIR("A")="Do you want to over-ride this warning",DIR(0)="Y",DIR("B")="No" D ^DIR
"RTN","PSOCLUTL",50,0)
 I Y D  S %=1
"RTN","PSOCLUTL",51,0)
 .Q  S YSCLDATA(1)="An over-ride was authorize at "_$G(DUZ(2))_" for "_$S($D(PSONAME):PSONAME,1:$G(PSO2))_" by "_$P($G(^VA(200,DUZ,0)),"^")
"RTN","PSOCLUTL",52,0)
 .S %H=$H D YMD^%DTC S XMDUN="NCC LOGGER",XMDUZ=.5,XMSUB=$G(DUZ(2))_" NCC ENROLLER ("_X_%_")",XMTEXT="YSCLDATA(",XMY("G.CLOZAPINE ROLL-UP@FORUM.VA.GOV")=""
"RTN","PSOCLUTL",53,0)
 .D ^XMD K XMDUN,XMDUZ,XMER,XMREC,XRG,XMSUB,XMTEXT,XMY,XMZ,YSCLDATA
"RTN","PSOCLUTL",54,0)
 K DIR,DIRUT,DUOUT Q
"RTN","PSOCPBAK")
0^64^B43547187^B43099557
"RTN","PSOCPBAK",1,0)
PSOCPBAK ;BIR/EJW-Tally unbilled NON-SERVICE CONNECTED copays ;03/28/03
"RTN","PSOCPBAK",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**137,268**;DEC 1997;Build 9
"RTN","PSOCPBAK",3,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSOCPBAK",4,0)
 ;External reference to IBARX supported by DBIA 125
"RTN","PSOCPBAK",5,0)
 S ZTDTH=""
"RTN","PSOCPBAK",6,0)
 I $D(ZTQUEUED) S ZTDTH=$H
"RTN","PSOCPBAK",7,0)
 L +^XTMP("PSOCPBAK"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T D  Q
"RTN","PSOCPBAK",8,0)
 . I ZTDTH="" D BMES^XPDUTL("Tally job is already running.  Halting...")
"RTN","PSOCPBAK",9,0)
 L -^XTMP("PSOCPBAK")
"RTN","PSOCPBAK",10,0)
 I ZTDTH="" D
"RTN","PSOCPBAK",11,0)
 .D BMES^XPDUTL("Tally unbilled, released NON-SERVICE CONNECTED prescription fills.")
"RTN","PSOCPBAK",12,0)
 .D BMES^XPDUTL("If no start date/time is entered when prompted, the background job will be ")
"RTN","PSOCPBAK",13,0)
 .D MES^XPDUTL("queued to run NOW.")
"RTN","PSOCPBAK",14,0)
 .D GETDATE
"RTN","PSOCPBAK",15,0)
 .D BMES^XPDUTL("Queuing background job to tally unbilled NON-SERVICE CONNECTED fills...")
"RTN","PSOCPBAK",16,0)
 S ZTRTN="EN^PSOCPBAK",ZTIO="",ZTDESC="Background job to tally NON-SERVICE CONNECTED unbilled copays" D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOCPBAK",17,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOCPBAK",18,0)
 Q
"RTN","PSOCPBAK",19,0)
EN ;
"RTN","PSOCPBAK",20,0)
 L +^XTMP("PSOCPBAK"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOCPBAK",21,0)
 N PSODT,RXP,PSOTEXT,YY,PSOCNT,PSOSTART,PSOEND,PSOVETS
"RTN","PSOCPBAK",22,0)
 S PSOCNT=0
"RTN","PSOCPBAK",23,0)
 D NOW^%DTC S (Y,PSOS1)=% D DD^%DT S PSOSTART=Y
"RTN","PSOCPBAK",24,0)
 S PSOSTRT2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCPBAK",25,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOCPBAK",26,0)
 I '$D(^XTMP("PSOCPBAK")) S X1=DT,X2=+90 D C^%DTC S ^XTMP("PSOCPBAK",0)=$G(X)_"^"_DT
"RTN","PSOCPBAK",27,0)
 S PSODT=3020203.235959 ; START WITH DATE $7 COPAY WENT INTO EFFECT
"RTN","PSOCPBAK",28,0)
 F  S PSODT=$O(^PSRX("AL",PSODT)) Q:'PSODT  S RXP="" F  S RXP=$O(^PSRX("AL",PSODT,RXP)) Q:'RXP  D
"RTN","PSOCPBAK",29,0)
 .S PSODFN=$P($G(^PSRX(RXP,0)),"^",2) Q:PSODFN=""  I '$D(^DPT(PSODFN,0)) Q
"RTN","PSOCPBAK",30,0)
 .I $G(^XTMP("PSOCPBAK",$J,PSODFN)) Q  ; EXEMPT OR SC QUESTION APPLIES-- NOTHING TO REPROCESS FOR THIS PATIENT
"RTN","PSOCPBAK",31,0)
 .S BADDT=$G(^XTMP("PSOCPBAK",$J,PSODFN,RXP))
"RTN","PSOCPBAK",32,0)
 .I 'BADDT D CHKLOG
"RTN","PSOCPBAK",33,0)
 .I BADDT,BADDT'>$P(PSODT,".") D
"RTN","PSOCPBAK",34,0)
 ..I '$D(^XTMP("PSOCPBAK",$J,PSODFN)) D XTYPE S ^XTMP("PSOCPBAK",$J,PSODFN)=$S(PSOSCMX=1:"",1:1) I PSOSCMX'=1 Q  ; QUIT IF SC QUESTION APPLIES -- NOTHING TO REPROCESS
"RTN","PSOCPBAK",35,0)
 ..S YY="" F  S YY=$O(^PSRX("AL",PSODT,RXP,YY)) Q:YY=""  D
"RTN","PSOCPBAK",36,0)
 ...S PSOREL=$S(YY=0:$P(^PSRX(RXP,2),"^",13),1:$P($G(^PSRX(RXP,1,YY,0)),"^",18)) I 'PSOREL Q  ; RELEASED DATE WON'T BE PRESENT IF RETURNED TO STOCK
"RTN","PSOCPBAK",37,0)
 ...I 'YY I $P($G(^PSRX(RXP,"IB")),"^",2)'="" Q  ; ALREADY BILLED
"RTN","PSOCPBAK",38,0)
 ...I 'YY I $P($G(^PSRX(RXP,"IB")),"^",4)'="" Q  ; ALREADY BILLED (POTENTIAL BILL - EXCEEDED ANNUAL CAP)
"RTN","PSOCPBAK",39,0)
 ...I YY,$P($G(^PSRX(RXP,1,YY,"IB")),"^",1)'="" Q  ; REFILL ALREADY BILLED
"RTN","PSOCPBAK",40,0)
 ...I YY,$P($G(^PSRX(RXP,1,YY,"IB")),"^",2)'="" Q  ; REFILL ALREADY BILLED (POTENTIAL BILL - EXCEEDED ANNUAL CAP)
"RTN","PSOCPBAK",41,0)
 ...S PSOXIN=$$RXST^IBARXEU(PSODFN,$P(PSOREL,".")) I $P($G(PSOXIN),"^")=1 Q  ; INCOME EXEMPT ON RELEASE DATE
"RTN","PSOCPBAK",42,0)
 ...I '$D(^XTMP("PSOCPBAK",$J,PSODFN,RXP)) S ^XTMP("PSOCPBAK",$J,PSODFN,RXP)=BADDT
"RTN","PSOCPBAK",43,0)
 ...S ^XTMP("PSOCPBAK",$J,PSODFN,RXP,YY)=$P(PSOREL,".") ; SAVE TO PROCESS IN "BILL" SECTION
"RTN","PSOCPBAK",44,0)
 D TALLY^PSOCPBA2
"RTN","PSOCPBAK",45,0)
 D TOTAL
"RTN","PSOCPBAK",46,0)
 D MAIL
"RTN","PSOCPBAK",47,0)
 D MAIL2
"RTN","PSOCPBAK",48,0)
 L -^XTMP("PSOCPBAK")
"RTN","PSOCPBAK",49,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCPBAK",50,0)
 Q
"RTN","PSOCPBAK",51,0)
 ;
"RTN","PSOCPBAK",52,0)
MAIL ;
"RTN","PSOCPBAK",53,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCPBAK",54,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","PSOCPBAK",55,0)
 S XMDUZ="Outpatient Pharmacy",XMSUB="Outpatient Pharmacy Copay Tally"
"RTN","PSOCPBAK",56,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSO COPAY",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOCPBAK",57,0)
 I $O(XMY(""))="" Q  ; no recipients for mail message
"RTN","PSOCPBAK",58,0)
 S PSOTEXT(1)="The Rx copay tally job for the Outpatient Pharmacy patch (PSO*7*137)"
"RTN","PSOCPBAK",59,0)
 S PSOTEXT(2)="started "_PSOSTART_" and completed "_PSOEND_"."
"RTN","PSOCPBAK",60,0)
 I PSOCNT>0 S PSOTEXT(3)="Released non-service connected prescriptions have now been reprocessed."
"RTN","PSOCPBAK",61,0)
 I PSOCNT>0 S PSOTEXT(4)="There were "_PSOCNT_" fills successfully tallied for "_$G(PSOVETS)_" veterans." D
"RTN","PSOCPBAK",62,0)
 .S PSOTEXT(5)=" "
"RTN","PSOCPBAK",63,0)
 .S PSOTEXT(6)="Fills eligible for back-billing by year:"
"RTN","PSOCPBAK",64,0)
 .S PSOTEXT(7)="2002  30-DAY EQUIVALENT FILLS: "_PSOCNT("YR2002",1)
"RTN","PSOCPBAK",65,0)
 .S PSOTEXT(8)="2002  60-DAY EQUIVALENT FILLS: "_PSOCNT("YR2002",2)
"RTN","PSOCPBAK",66,0)
 .S PSOTEXT(9)="2002  90-DAY EQUIVALENT FILLS: "_PSOCNT("YR2002",3)
"RTN","PSOCPBAK",67,0)
 .S PSOTEXT(10)=""
"RTN","PSOCPBAK",68,0)
 .S PSOTEXT(11)="2003  30-DAY EQUIVALENT FILLS: "_PSOCNT("YR2003",1)
"RTN","PSOCPBAK",69,0)
 .S PSOTEXT(12)="2003  60-DAY EQUIVALENT FILLS: "_PSOCNT("YR2003",2)
"RTN","PSOCPBAK",70,0)
 .S PSOTEXT(13)="2003  90-DAY EQUIVALENT FILLS: "_PSOCNT("YR2003",3)
"RTN","PSOCPBAK",71,0)
 I PSOCNT=0 S PSOTEXT(3)="No released unbilled copay fills were found."
"RTN","PSOCPBAK",72,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBAK",73,0)
 Q
"RTN","PSOCPBAK",74,0)
 ;
"RTN","PSOCPBAK",75,0)
MAIL2 ;
"RTN","PSOCPBAK",76,0)
 N I,COUNTS
"RTN","PSOCPBAK",77,0)
 D NOW^%DTC S PSOTIME=$$FMDIFF^XLFDT(%,PSOS1,2)
"RTN","PSOCPBAK",78,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCPBAK",79,0)
 K PSOTEXT
"RTN","PSOCPBAK",80,0)
 S COUNTS=""
"RTN","PSOCPBAK",81,0)
 F J="YR2002","YR2003" F I=1:1:3 S COUNTS=COUNTS_"^"_PSOCNT(J,I)
"RTN","PSOCPBAK",82,0)
 K XMY(DUZ)
"RTN","PSOCPBAK",83,0)
 S XMY("WHITE.ELAINE@FORUM.VA.GOV")=""
"RTN","PSOCPBAK",84,0)
 S XMY("CARROLL.DAN@FORUM.VA.GOV")=""
"RTN","PSOCPBAK",85,0)
 S XMDUZ="PSO*7*137 TALLY",XMSUB=$G(PSOINST)_" - COUNTS"
"RTN","PSOCPBAK",86,0)
 S PSOTEXT(1)=PSOSTRT2_"^"_PSOTIME_"^"_$G(PSOVETS)_"^"_PSOCNT_COUNTS
"RTN","PSOCPBAK",87,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCPBAK",88,0)
 Q
"RTN","PSOCPBAK",89,0)
 ;
"RTN","PSOCPBAK",90,0)
CHKLOG ;
"RTN","PSOCPBAK",91,0)
 S BADDT=""
"RTN","PSOCPBAK",92,0)
 S PSOSQ=0 F  S PSOSQ=$O(^PSRX(RXP,"COPAY",PSOSQ)) Q:'PSOSQ  S PSOLOG=$G(^PSRX(RXP,"COPAY",PSOSQ,0)) I PSOLOG["Service Connected" S BADDT=$P(PSOLOG,".") Q
"RTN","PSOCPBAK",93,0)
 Q
"RTN","PSOCPBAK",94,0)
 ;
"RTN","PSOCPBAK",95,0)
GETDATE ; GET DATE/TIME OF WHEN BACKGROUND JOB SHOULD BE RUN
"RTN","PSOCPBAK",96,0)
 S ZTDTH=""
"RTN","PSOCPBAK",97,0)
 S NOW=0
"RTN","PSOCPBAK",98,0)
 D NOW^%DTC S (Y,TODAY)=% D DD^%DT
"RTN","PSOCPBAK",99,0)
 D BMES^XPDUTL("At the following prompt, enter a starting date@time")
"RTN","PSOCPBAK",100,0)
 D MES^XPDUTL("or enter NOW to queue the job immediately.")
"RTN","PSOCPBAK",101,0)
 D BMES^XPDUTL("If this prompting is during patch installation, you will not see what you type.")
"RTN","PSOCPBAK",102,0)
 W ! K %DT D NOW^%DTC S %DT="RAEX",%DT(0)=%,%DT("A")="Queue copay tally Job to run Date@Time: "
"RTN","PSOCPBAK",103,0)
 D ^%DT K %DT I $D(DTOUT)!(Y<0) W "Task will be queued to run NOW" S ZTDTH=$H,NOW=1
"RTN","PSOCPBAK",104,0)
 I 'NOW,Y>0 D
"RTN","PSOCPBAK",105,0)
 .S SAVEY=Y
"RTN","PSOCPBAK",106,0)
 .D DD^%DT
"RTN","PSOCPBAK",107,0)
 .S X=Y
"RTN","PSOCPBAK",108,0)
 .S Y=SAVEY
"RTN","PSOCPBAK",109,0)
ASK D BMES^XPDUTL("Task will be queued to run "_$S(NOW:"NOW",1:X)_". Is that correct?  :")
"RTN","PSOCPBAK",110,0)
 R XX:300 S:'$T XX="Y" I XX'="Y",XX'="y",XX'="N",XX'="n" W " Enter Y or N" G ASK
"RTN","PSOCPBAK",111,0)
 I XX'="Y",XX'="y" G GETDATE
"RTN","PSOCPBAK",112,0)
 I Y>0,ZTDTH="" S ZTDTH=Y
"RTN","PSOCPBAK",113,0)
 I ZTDTH="" S ZTDTH=$H
"RTN","PSOCPBAK",114,0)
 Q
"RTN","PSOCPBAK",115,0)
 ;
"RTN","PSOCPBAK",116,0)
XTYPE ;
"RTN","PSOCPBAK",117,0)
 N Y,I,J,X,SAVY,DFN
"RTN","PSOCPBAK",118,0)
 S DFN=PSODFN D DEM^VADPT I +$G(VADM(6)) S PSOSCMX="" Q  ; DECEASED
"RTN","PSOCPBAK",119,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCPBAK",120,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCPBAK",121,0)
 I 'X Q
"RTN","PSOCPBAK",122,0)
 S X=X_"^"_PSODFN D XTYPE^IBARX
"RTN","PSOCPBAK",123,0)
 I $G(Y)'=1 Q
"RTN","PSOCPBAK",124,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCPBAK",125,0)
 I PSOSCMX="",SAVY=0 Q  ; INCOME EXEMPT OR SERVICE-CONNECTED
"RTN","PSOCPBAK",126,0)
 I PSOSCMX=2 Q  ; NEED TO ASK SC QUESTION
"RTN","PSOCPBAK",127,0)
 Q
"RTN","PSOCPBAK",128,0)
 ;
"RTN","PSOCPBAK",129,0)
TOTAL ;
"RTN","PSOCPBAK",130,0)
 N COUNT,COUNTED
"RTN","PSOCPBAK",131,0)
 I '$D(PSOVETS) S PSOVETS=0
"RTN","PSOCPBAK",132,0)
 N I,J
"RTN","PSOCPBAK",133,0)
 F I=1:1:3 S (PSOCNT("YR2002",I),PSOCNT("YR2003",I))=0
"RTN","PSOCPBAK",134,0)
 S PSODFN=0 F  S PSODFN=$O(^XTMP("PSOCPBAK",$J,PSODFN)) Q:'PSODFN  D
"RTN","PSOCPBAK",135,0)
 .S COUNTED=0
"RTN","PSOCPBAK",136,0)
 .F J="YR2002","YR2003" F I=1:1:3 S COUNT=$G(^XTMP("PSOCPBAK",$J,PSODFN,J,I)) I COUNT>0 S:'$G(COUNTED) COUNTED=1,PSOVETS=PSOVETS+1 S PSOCNT(J,I)=PSOCNT(J,I)+COUNT
"RTN","PSOCPBAK",137,0)
 F I=1:1:3 S PSOCNT=PSOCNT+PSOCNT("YR2002",I)+PSOCNT("YR2003",I)
"RTN","PSOCPBAK",138,0)
 Q
"RTN","PSOCPBAK",139,0)
 ;
"RTN","PSOCPE")
0^24^B80510322^B79963827
"RTN","PSOCPE",1,0)
PSOCPE ;BIR/BAB - PHARMACY COPAY APPLICATION UTILITIES FOR IB ;10/26/92
"RTN","PSOCPE",2,0)
 ;;7.0;OUTPATPSOCT PHARMACY;**26,71,85,114,157,219,268**;DEC 1997;Build 9
"RTN","PSOCPE",3,0)
 ;
"RTN","PSOCPE",4,0)
 ;REF/IA
"RTN","PSOCPE",5,0)
 ;^XUSEC/10076
"RTN","PSOCPE",6,0)
 ;^PSDRUG(/221
"RTN","PSOCPE",7,0)
 ;Routine initially released as part of the copayment enhancement.
"RTN","PSOCPE",8,0)
 ;called from PSOLBL
"RTN","PSOCPE",9,0)
INV ;         Entry point from PSOCP - Prints one copay invoice
"RTN","PSOCPE",10,0)
 I '$D(PSOCPN)!($G(RXP)) Q
"RTN","PSOCPE",11,0)
 S PSOCPBAR=0
"RTN","PSOCPE",12,0)
 I $D(PSOBARS),PSOBARS S PSOCPBAR=1
"RTN","PSOCPE",13,0)
 D DEM^VADPT S Y=DT X ^DD("DD") S EDT=Y
"RTN","PSOCPE",14,0)
 W ?54,"PRESCRIPTION COPAYMENT INFORMATION"
"RTN","PSOCPE",15,0)
 W !!,?54,VADM(1)," ",VA("PID")," ",EDT
"RTN","PSOCPE",16,0)
 S PSZ1=0,PSZ2="",PSOCPBN=$P(VADM(2),"^"),PSOCPBN=$S(PSOCPBN]"":PSOCPBN,1:"Unavailable")
"RTN","PSOCPE",17,0)
 ;I '$G(PSOCPN) S PSOCPN=$P(^PSRX(RX,0),U,2)
"RTN","PSOCPE",18,0)
 I PSOCPBAR,(PSOCPBN]"") S X="S",X2=PSOCPBN W !,?54,@PSOBAR1,PSOCPBN,@PSOBAR0
"RTN","PSOCPE",19,0)
 E  W !
"RTN","PSOCPE",20,0)
 W !,?54,"The following prescriptions are"
"RTN","PSOCPE",21,0)
 W !,?54,"eligible for prescription copayment.",!!
"RTN","PSOCPE",22,0)
DRUG S PSZ2="" F  S PSZ2=$O(^TMP($J,"PSOCP",PSOCPN,PSZ2)) Q:PSZ2']""  S PSZ=^(PSZ2) D PRT
"RTN","PSOCPE",23,0)
NAR ; Print narrative from site parameter file
"RTN","PSOCPE",24,0)
 K ^UTILITY($J,"W") S DIWL=55,DIWR=99,DIWF="" W !
"RTN","PSOCPE",25,0)
 G:'$D(^PS(59,PSOSITE,4,0)) END
"RTN","PSOCPE",26,0)
 G:$P(^PS(59,PSOSITE,4,0),"^",3)'>0 END
"RTN","PSOCPE",27,0)
 F PSO9=0:0 S PSO9=$O(^PS(59,PSOSITE,4,PSO9)) G:'PSO9 P1 I $D(^PS(59,PSOSITE,4,PSO9,0)) S X=^(0) D ^DIWP
"RTN","PSOCPE",28,0)
P1 D ^DIWW
"RTN","PSOCPE",29,0)
 K DIWF,DIWL,DIWR,PSO9
"RTN","PSOCPE",30,0)
END ;
"RTN","PSOCPE",31,0)
 W @IOF
"RTN","PSOCPE",32,0)
 K ^TMP($J,"PSOCP",PSOCPN),PSOCPBAR,PSOCPBN,PSZ1,PSZ2,PSOCPN,DIWF,DIWL,DIWR,PSO9
"RTN","PSOCPE",33,0)
 Q
"RTN","PSOCPE",34,0)
PRT ;
"RTN","PSOCPE",35,0)
 W ?54,PSZ2
"RTN","PSOCPE",36,0)
 W ?72," ",$P(^TMP($J,"PSOCP",PSOCPN,PSZ2),"^",3)," ","Days Supply",!
"RTN","PSOCPE",37,0)
 W ?56,$E($P(^TMP($J,"PSOCP",PSOCPN,PSZ2),U,2),1,45),!
"RTN","PSOCPE",38,0)
 Q
"RTN","PSOCPE",39,0)
XMPT ;   Entry point for menu option to select copay exemption
"RTN","PSOCPE",40,0)
 N PSORXPNM,PSORXPRE,PSOCPEDA
"RTN","PSOCPE",41,0)
 I '$D(PSOPAR) D ^PSOLSET G XMPT
"RTN","PSOCPE",42,0)
 W ! S (DIC,DIE)="^PS(53,",DIC(0)="AEQMZ" D ^DIC K DIC G:Y<0 QUIT
"RTN","PSOCPE",43,0)
 G:$D(DTOUT) QUIT
"RTN","PSOCPE",44,0)
 S PSORXPRE=$P($G(^PS(53,+$G(Y),0)),"^",7)
"RTN","PSOCPE",45,0)
 S PSORXPNM=$P($G(^PS(53,+$G(Y),0)),"^")
"RTN","PSOCPE",46,0)
 S DA=+Y,DR="15" L +^PS(53,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !!,PSORXPNM_" is locked by another user. Try Later!" W ! D PAGE G QUIT
"RTN","PSOCPE",47,0)
 W ! D ^DIE
"RTN","PSOCPE",48,0)
 I PSORXPRE,$P($G(^PS(53,DA,0)),"^",7) W !!,"All Rx's entered with this Rx Patient Status will be EXEMPT from Copayment.",! D PAGE L -^PS(53,DA) G QUIT
"RTN","PSOCPE",49,0)
 I 'PSORXPRE,'$P($G(^PS(53,DA,0)),"^",7) W !!,"All Rx's entered with this Rx Patient Status will NOT be exempt from Copayment.",! D PAGE L -^PS(53,DA) G QUIT
"RTN","PSOCPE",50,0)
 D WARN L -^PS(53,DA)
"RTN","PSOCPE",51,0)
QUIT K PSORXPRE,DIE,DIC,DA,DR,X,C,Y
"RTN","PSOCPE",52,0)
 Q
"RTN","PSOCPE",53,0)
PAGE ;
"RTN","PSOCPE",54,0)
 I '$G(DUZ("AUTO")) K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOCPE",55,0)
 Q
"RTN","PSOCPE",56,0)
WARN ;
"RTN","PSOCPE",57,0)
 S PSOCPEDA=$G(DA)
"RTN","PSOCPE",58,0)
 W !!?28,"**** WARNING ****",!
"RTN","PSOCPE",59,0)
 I 'PSORXPRE W !,"By setting the Exempt from Copayment for the Rx Patient Status of",!,PSORXPNM," to 'YES', every prescription entered",!,"with this Rx Patient Status will NOT be charged a Copayment.",!
"RTN","PSOCPE",60,0)
 I PSORXPRE W !,"By setting the EXEMPT FROM COPAYMENT for the Rx Patient Status of ",!,PSORXPNM," to 'NO', prescriptions entered with this Rx",!,"Patient Status from this point on will NOT be exempt from Copayment.",!
"RTN","PSOCPE",61,0)
 W !,"A mail message will be sent to PSORPH and PSO COPAY Key holders informing",!,"them of your change."
"RTN","PSOCPE",62,0)
 W ! K DIR S DIR(0)="Y",DIR("A")="Are you sure you want to do this",DIR("B")="Y" D ^DIR K DIR
"RTN","PSOCPE",63,0)
 I $G(Y) D  D MAIL G WARNX
"RTN","PSOCPE",64,0)
 .I 'PSORXPRE W !!,"Setting ",PSORXPNM," Rx Patient Status to Exempt from Copayment." Q
"RTN","PSOCPE",65,0)
 .W !!,"Setting Exempt from Copayment to 'NO' for the ",PSORXPNM,!,"Rx Patient Status."
"RTN","PSOCPE",66,0)
 I 'PSORXPRE W !!,"No action taken." S $P(^PS(53,PSOCPEDA,0),"^",7)=0 H 1
"RTN","PSOCPE",67,0)
 I PSORXPRE W !!,"No action taken." S $P(^PS(53,PSOCPEDA,0),"^",7)=1 H 1
"RTN","PSOCPE",68,0)
WARNX W ! D PAGE
"RTN","PSOCPE",69,0)
 S DA=$G(PSOCPEDA) K PSOCPEDA
"RTN","PSOCPE",70,0)
 Q
"RTN","PSOCPE",71,0)
MAIL ;
"RTN","PSOCPE",72,0)
 K PSOTXT,PSOCFN,PSODCPA
"RTN","PSOCPE",73,0)
 I $G(DUZ) S DIC=200,DR=".01",DA=DUZ,DIQ(0)="E",DIQ="PSODCPA(" D EN^DIQ1 S PSOCFN=$G(PSODCPA(200,DA,.01,"E")) K PSODCPA,DIC,DIQ,DR
"RTN","PSOCPE",74,0)
 I 'PSORXPRE S PSOTXT(1,0)="The "_PSORXPNM_" Rx Patient Status has been marked as",PSOTXT(2,0)="Exempt from Copayment by "_$G(PSOCFN)_".",PSOTXT(3,0)="Every prescription with this Rx Patient Status will not be charged a Copayment."
"RTN","PSOCPE",75,0)
 I PSORXPRE S PSOTXT(1,0)="The Exempt from Copayment status has been removed from the",PSOTXT(2,0)=PSORXPNM_" Rx Patient Status by "_$G(PSOCFN)_".",PSOTXT(3,0)="Prescriptions entered with this Rx Patient Status will not be exempt from"
"RTN","PSOCPE",76,0)
 I PSORXPRE S PSOTXT(4,0)="Copayment."
"RTN","PSOCPE",77,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSORPH",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOCPE",78,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSO COPAY",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOCPE",79,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","PSOCPE",80,0)
 S XMSUB="Exempt from Copayment",XMTEXT="PSOTXT(",XMDUZ="Outpatient Pharmacy" D ^XMD
"RTN","PSOCPE",81,0)
 K PSOTXT,PSOCXPDA,XMDUZ,PSOCFN,XMTEXT,XMSUB,XMY
"RTN","PSOCPE",82,0)
 Q
"RTN","PSOCPE",83,0)
 ;
"RTN","PSOCPE",84,0)
MAIL2 ; SEND MAIL TO PHARMACIST, PROVIDER, AND HOLDERS OF PSO COPAY KEY
"RTN","PSOCPE",85,0)
 N PSOC,PSOTXT,X
"RTN","PSOCPE",86,0)
 K XMY
"RTN","PSOCPE",87,0)
 S XMSUB="PRESCRIPTION QUESTIONS REVIEW NEEDED"
"RTN","PSOCPE",88,0)
 S XMDUZ="Outpatient Pharmacy Package"
"RTN","PSOCPE",89,0)
 S PSOTXT(1)=" "
"RTN","PSOCPE",90,0)
 S DFN=+$P($G(^PSRX(RXP,0)),"^",2) D PID^VADPT
"RTN","PSOCPE",91,0)
 S PSODIV=$P($G(^PSRX(RXP,2)),"^",9) S:PSODIV'="" XMSUB=XMSUB_" ("_$P($G(^PS(59,PSODIV,0)),"^",6)_")",PSODIV=$P($G(^PS(59,PSODIV,0)),"^",1) ; ADDED DIVISION NUMBER TO SUBJECT LINE - PATCH 85
"RTN","PSOCPE",92,0)
 S PSOTXT(2)=$P($G(^DPT($P(^PSRX(RXP,0),"^",2),0)),"^",1)_"  ("_$G(VA("BID"))_")"_"    "_PSODIV
"RTN","PSOCPE",93,0)
 D ELIG
"RTN","PSOCPE",94,0)
 S PSOTXT(PSOC)="Rx# "_$P(^PSRX(RXP,0),"^",1)_" ("_PSOREF_")    "_$S('$G(^PSRX(RXP,"IB")):"NO COPAY",1:"COPAY")
"RTN","PSOCPE",95,0)
 S PSOC=PSOC+1
"RTN","PSOCPE",96,0)
 S DRG=+$P(^PSRX(RXP,0),"^",6)
"RTN","PSOCPE",97,0)
 S PSOC=PSOC+1
"RTN","PSOCPE",98,0)
 S PSOTXT(PSOC)=$P($G(^PSDRUG(DRG,0)),"^",1)
"RTN","PSOCPE",99,0)
 S PSOC=PSOC+1
"RTN","PSOCPE",100,0)
 S PSOTXT(PSOC)=" "
"RTN","PSOCPE",101,0)
 S PSOC=PSOC+1
"RTN","PSOCPE",102,0)
 S PSOTXT(PSOC)="Due to a change in criteria, additional information listed below is needed"
"RTN","PSOCPE",103,0)
 S PSOC=PSOC+1
"RTN","PSOCPE",104,0)
 S PSOTXT(PSOC)="to determine the final VA copay and/or insurance billable status for this Rx"
"RTN","PSOCPE",105,0)
 S PSOC=PSOC+1
"RTN","PSOCPE",106,0)
 S PSOTXT(PSOC)="so that appropriate action can be taken by pharmacy personnel."
"RTN","PSOCPE",107,0)
 S PSOC=PSOC+1
"RTN","PSOCPE",108,0)
 S PSOTXT(PSOC)=" "
"RTN","PSOCPE",109,0)
 S PSOC=PSOC+1
"RTN","PSOCPE",110,0)
 F EXMT="SC","CV","AO","IR","EC","MST","HNC" I $D(PSOTG(EXMT)) D
"RTN","PSOCPE",111,0)
 . I PSOTG(EXMT)'="" Q
"RTN","PSOCPE",112,0)
 . S PSOLTAG="REL"_EXMT
"RTN","PSOCPE",113,0)
 . S PSOQUES=$P($T(@PSOLTAG),";",2) I PSOQUES="" Q
"RTN","PSOCPE",114,0)
 . S PSOC=PSOC+1,PSOTXT(PSOC)=PSOQUES
"RTN","PSOCPE",115,0)
 . S PSOQUES=$P($T(@PSOLTAG),";",2) I PSOQUES="" Q
"RTN","PSOCPE",116,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)=" "
"RTN","PSOCPE",117,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="This message has been sent to the provider of record, the pharmacist who"
"RTN","PSOCPE",118,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="finished the prescription order, and all holders of the PSO COPAY key."
"RTN","PSOCPE",119,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)=" "
"RTN","PSOCPE",120,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="Providers:"
"RTN","PSOCPE",121,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="Please respond with your answer to the question(s) as a reply to this"
"RTN","PSOCPE",122,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="message. The prescription will be updated by the appropriate staff."
"RTN","PSOCPE",123,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)=" "
"RTN","PSOCPE",124,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="Staff assigned to update the Prescription responses:"
"RTN","PSOCPE",125,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="Please use the RESET COPAY STATUS/CANCEL CHARGES option to enter the responses"
"RTN","PSOCPE",126,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="to the questions above, which may result in a Rx copay status change and/or"
"RTN","PSOCPE",127,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="the need to remove VA copay charges or may result in a charge to the patient's"
"RTN","PSOCPE",128,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="insurance carrier."
"RTN","PSOCPE",129,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)=" "
"RTN","PSOCPE",130,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="Note: The SC question is now asked for Veterans who are SC>49% in order to"
"RTN","PSOCPE",131,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="determine if the Rx can be billed to a third party insurance. These Veterans"
"RTN","PSOCPE",132,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="will NOT be charged a VA copay."
"RTN","PSOCPE",133,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)=" "
"RTN","PSOCPE",134,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="Supply and investigational drugs are not charged a VA copay but could be"
"RTN","PSOCPE",135,0)
 S PSOC=PSOC+1,PSOTXT(PSOC)="reimbursable by third party insurance."
"RTN","PSOCPE",136,0)
 ; S XMY() TO ALL THE RECIPIENTS
"RTN","PSOCPE",137,0)
 I '$G(PSOREF) S XMY(+$P(^PSRX(RXP,0),"^",4))="" ; ORIGINAL
"RTN","PSOCPE",138,0)
 I $G(PSOREF) S XMY(+$P(^PSRX(RXP,1,PSOREF,0),"^",17))="" ; REFILL
"RTN","PSOCPE",139,0)
 I $G(^PSRX(RXP,"OR1")) I $P(^PSRX(RXP,"OR1"),"^",5)'="" S XMY($P(^PSRX(RXP,"OR1"),"^",5))=""
"RTN","PSOCPE",140,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSO COPAY",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOCPE",141,0)
 S XMTEXT="PSOTXT("
"RTN","PSOCPE",142,0)
 D ^XMD K XMSUB,XMY,XMDUZ,XMTEXT,PSODIV,PSOCXPDA,PSOLTAG,PSOC,PSOQUES,PSOTG
"RTN","PSOCPE",143,0)
 Q
"RTN","PSOCPE",144,0)
 ;
"RTN","PSOCPE",145,0)
ELIG D ELIG^VADPT S PSOC=3,PSOTXT(PSOC)="Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:""),PSOC=PSOC+1
"RTN","PSOCPE",146,0)
 N N,I,I1,PSDIS,PSCNT
"RTN","PSOCPE",147,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  S $P(PSOTXT(PSOC)," ",14)=$P(VAEL(1,N),"^",2),PSOC=PSOC+1
"RTN","PSOCPE",148,0)
 S PSOTXT(PSOC)=" ",PSOC=PSOC+1,PSOTXT(PSOC)="Disabilities: "
"RTN","PSOCPE",149,0)
 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSOCPE",150,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSOCPE",151,0)
 .S:$L(PSOTXT(PSOC)_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 PSOC=PSOC+1,$P(PSOTXT(PSOC)," ",14)=" "
"RTN","PSOCPE",152,0)
 .S PSOTXT(PSOC)=$G(PSOTXT(PSOC))_PSDIS_"-"_PSCNT_"%("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSOCPE",153,0)
 S PSOC=PSOC+1 S PSOTXT(PSOC)=" ",PSOC=PSOC+1
"RTN","PSOCPE",154,0)
 Q
"RTN","PSOCPE",155,0)
 ;
"RTN","PSOCPE",156,0)
 ;EXEMPTION QUESTIONS - MAIL MESSAGE POSITION;SUBSCRIPT IN "IBQ" NODE
"RTN","PSOCPE",157,0)
RELSC ;Is this Rx for a Service Connected Condition?;1
"RTN","PSOCPE",158,0)
RELMST ;Is this Rx related to the treatment of Military Sexual Trauma?;2
"RTN","PSOCPE",159,0)
RELAO ;Is this Rx for treatment of Vietnam-Era Herbicide (Agent Orange) exposure?;3
"RTN","PSOCPE",160,0)
RELIR ;Is this Rx for treatment of Ionizing Radiation exposure?;4
"RTN","PSOCPE",161,0)
RELEC ;Is this Rx for treatment of Environmental Contaminants exposure?;5
"RTN","PSOCPE",162,0)
RELHNC ;Is this Rx related to treatment of Head and/or Neck Cancer?;6
"RTN","PSOCPE",163,0)
RELCV ;Is this Rx potentially for treatment related to Combat?;7
"RTN","PSOCPE",164,0)
 ;
"RTN","PSODEDT")
0^26^B14865431^B14313886
"RTN","PSODEDT",1,0)
PSODEDT ;BHAM ISC/SAB - edit due answer sheet ; 06/03/92 17:26
"RTN","PSODEDT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**2,268**;DEC 1997;Build 9
"RTN","PSODEDT",3,0)
SEQNUM K DIC S DIC="^PS(50.0731,",DIC("A")="Select DUE ANSWER SEQUENCE NUMBER ('^S' to Search): ",DIC(0)="QEAM" D ^DIC K DIC
"RTN","PSODEDT",4,0)
 G:(X="^")!($D(DTOUT))!(X="") EXIT
"RTN","PSODEDT",5,0)
 S PSA=+Y
"RTN","PSODEDT",6,0)
 I (PSA<1)&($E(X,1,2)="^S") D SEARCH G:PSA<1 SEQNUM
"RTN","PSODEDT",7,0)
 I PSA<1 W "  ??",$C(7) G SEQNUM
"RTN","PSODEDT",8,0)
EDIT S DIE="^PS(50.0731,",(DA,PSODUEL)=PSA,DR=".01" L +^PS(50.0731,PSODUEL):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!" G EXIT
"RTN","PSODEDT",9,0)
 D ^DIE L -^PS(50.0731,PSODUEL) K DIE,DA,DR,PSODUEL
"RTN","PSODEDT",10,0)
 G:$D(Y) EXIT
"RTN","PSODEDT",11,0)
 D:$D(^PS(50.0731,PSA,0)) DIE^PSODLKP
"RTN","PSODEDT",12,0)
 G PSODEDT
"RTN","PSODEDT",13,0)
EXIT K ^TMP("PSOD",$J)
"RTN","PSODEDT",14,0)
 K DA,DIC,DIE,DIQ,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,DX,DY,FLD,I,ID,IX,IXN
"RTN","PSODEDT",15,0)
 K IXS,N,PID,PSDPOP,PSA,PSCH,PSDIG,PSEED,PSFLAG,PSHI,PSHIT,PSIX,PSL,PSLEN
"RTN","PSODEDT",16,0)
 K PSLO,PSMARG,PSQ,PSQN,PSQNUM,PSQP,PSTXT,PSTYP,PSWRAP,X,Y
"RTN","PSODEDT",17,0)
 QUIT
"RTN","PSODEDT",18,0)
 ;
"RTN","PSODEDT",19,0)
SEARCH K DIR,DUOUT,DTOUT,PSCH,PSIX,PID,^TMP("PSOD",$J)
"RTN","PSODEDT",20,0)
 W !!!!!,"If you do not know the Sequence Number, you may search by any or all of the",!,"following fields: "
"RTN","PSODEDT",21,0)
 W !!?5,"QUESTIONNAIRE",!?5,"DRUG",!?5,"PROVIDER",!!?5,"Type '^' to exit.",!
"RTN","PSODEDT",22,0)
 S PSFLAG=0
"RTN","PSODEDT",23,0)
 F FLD=1,2,4 Q:$D(DTOUT)!$D(DUOUT)  S DIR(0)="50.0731,"_FLD_"O" D ASK
"RTN","PSODEDT",24,0)
 Q:'PSFLAG
"RTN","PSODEDT",25,0)
 S IXS=""
"RTN","PSODEDT",26,0)
 F FLD=1,2,4 I $D(PSCH(FLD)),PSCH(FLD) S IXS=$S(FLD=1:"Q",FLD=2:"D",1:"P")_IXS
"RTN","PSODEDT",27,0)
 I $L(IXS)>1 S PSEED=$E(IXS) F N=0:0 S IX=PSEED D GETIXN S N=$O(^PS(50.0731,PSEED,PSCH(IXN),N)) Q:'N  S PSHIT=1 D GETN I PSHIT S ^TMP("PSOD",$J,N)=""
"RTN","PSODEDT",28,0)
 I $L(IXS)=1 S IX=IXS D GETIXN F N=0:0 S N=$O(^PS(50.0731,IXS,PSCH(IXN),N)) Q:'N  S ^TMP("PSOD",$J,N)=""
"RTN","PSODEDT",29,0)
 I '$D(^TMP("PSOD",$J)) W !!?5,"No Matches Found!!!",!! Q
"RTN","PSODEDT",30,0)
 I '$O(^TMP("PSOD",$J,$O(^TMP("PSOD",$J,0)))) S PSA=$O(^TMP("PSOD",$J,0)) W !! Q
"RTN","PSODEDT",31,0)
 S PSDPOP=0
"RTN","PSODEDT",32,0)
CHOICES W !!?2,"CHOOSE FROM...",!!
"RTN","PSODEDT",33,0)
 S DIC="^PS(50.0731,",DR="1:9",DIQ="PID",DIQ(0)="E"
"RTN","PSODEDT",34,0)
 S PSL=$S($D(IOSL):IOSL-3,1:21),(DX,DY)=0 X ^%ZOSF("XY")
"RTN","PSODEDT",35,0)
 F N=0:0 S N=$O(^TMP("PSOD",$J,N)) Q:'N  D DISPLAY Q:PSDPOP
"RTN","PSODEDT",36,0)
 K DIC,DIQ
"RTN","PSODEDT",37,0)
 S PSA=0
"RTN","PSODEDT",38,0)
 Q
"RTN","PSODEDT",39,0)
ASK K DA
"RTN","PSODEDT",40,0)
 D ^DIR K DIR
"RTN","PSODEDT",41,0)
 S PSCH(FLD)=+Y,PSFLAG=PSFLAG+Y
"RTN","PSODEDT",42,0)
 Q
"RTN","PSODEDT",43,0)
GETN F I=2:1:$L(IXS) S IX=$E(IXS,I) D GETIXN S PSHIT=PSHIT*$D(^PS(50.0731,IX,PSCH(IXN),N))
"RTN","PSODEDT",44,0)
 Q
"RTN","PSODEDT",45,0)
GETIXN S IXN=$S(IX="Q":1,IX="D":2,1:4)
"RTN","PSODEDT",46,0)
 Q
"RTN","PSODEDT",47,0)
DISPLAY I $Y,$Y>PSL S (DX,DY)=0 X ^%ZOSF("XY") S DIR(0)="E" D ^DIR W $C(13),$J("",45),$C(13) I 'Y S PSDPOP=1 Q
"RTN","PSODEDT",48,0)
 S (PSQNUM,DA)=N,PSQ=""
"RTN","PSODEDT",49,0)
 D EN^DIQ1
"RTN","PSODEDT",50,0)
 F ID=.01:0 S ID=$O(PID(50.0731,DA,ID)) Q:'ID  S PSQ=PSQ_PID(50.0731,DA,ID,"E")_$S($L(PID(50.0731,DA,ID,"E")):"/",1:"")
"RTN","PSODEDT",51,0)
 D WRAP
"RTN","PSODEDT",52,0)
 Q
"RTN","PSODEDT",53,0)
WRAP ;Enter here from PSODACT,PSODLKP,PSODEDT to format Question
"RTN","PSODEDT",54,0)
 ;Needs PSQ=text, PSQNUM=question number
"RTN","PSODEDT",55,0)
 NEW I,K
"RTN","PSODEDT",56,0)
 S PSTXT=$P(PSQ,"^") W !,PSQNUM,"."
"RTN","PSODEDT",57,0)
 S PSWRAP=1,PSMARG=$S('$G(PSORM):80,$D(IOM):IOM,1:80)-5
"RTN","PSODEDT",58,0)
W1 S:$L(PSTXT)<PSMARG PSWRAP(PSWRAP)=PSTXT I $L(PSTXT)'<PSMARG F I=PSMARG:-1:0 I $E(PSTXT,I)?1P S PSWRAP(PSWRAP)=$E(PSTXT,1,I),PSTXT=$E(PSTXT,I+1,999),PSWRAP=PSWRAP+1 G W1
"RTN","PSODEDT",59,0)
 F K=1:1:PSWRAP W ?($L(PSQNUM)+2),PSWRAP(K),!
"RTN","PSODEDT",60,0)
 Q
"RTN","PSODEDT",61,0)
QUES2 I PSTYP=1 W !!,?5,"Enter Y for YES, N for NO, U for UNKNOWN."
"RTN","PSODEDT",62,0)
 I PSTYP=2 W !!,?5,"Enter a FREE TEXT answer from 1 to ",PSLEN," characters."
"RTN","PSODEDT",63,0)
 I PSTYP=3 W !!,?5,"Enter a number between ",PSLO," and ",PSHI,!,?5,"with a maximum of ",PSDIG," decimal digits."
"RTN","PSODEDT",64,0)
 W !?5,"Enter carriage return to bypass."
"RTN","PSODEDT",65,0)
 W !?5,"Enter '^' to exit."
"RTN","PSODEDT",66,0)
 D WRAP
"RTN","PSODEDT",67,0)
 Q
"RTN","PSODELI")
0^27^B2912116^B2674483
"RTN","PSODELI",1,0)
PSODELI ;IHS/DSD/JCM - DELETE ENTRIES IN APSP INTERVENTION FILE ; 03/28/93 21:15
"RTN","PSODELI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,268**;DEC 1997;Build 9
"RTN","PSODELI",3,0)
 ;
"RTN","PSODELI",4,0)
 ; This routine is called by the option that delete entries in
"RTN","PSODELI",5,0)
 ; the APSP INTERVENTION file.
"RTN","PSODELI",6,0)
 ; These options are locked with the PSZMGR key.
"RTN","PSODELI",7,0)
 ; 
"RTN","PSODELI",8,0)
 ; External Calls : ^DIE,^DIC,^DIR
"RTN","PSODELI",9,0)
 ;-----------------------------------------------------------------
"RTN","PSODELI",10,0)
START ;
"RTN","PSODELI",11,0)
 K DIC,DR,DIE,DA
"RTN","PSODELI",12,0)
 D INTERV ; Sets up DIC and DIE calls for files
"RTN","PSODELI",13,0)
END D EOJ ; Cleans up variables
"RTN","PSODELI",14,0)
 Q
"RTN","PSODELI",15,0)
 ;------------------------------------------------------------------
"RTN","PSODELI",16,0)
INTERV ; Deletes entries from APSP INTERVENTION file
"RTN","PSODELI",17,0)
 W !,"You may only delete entries entered on the current day.",!
"RTN","PSODELI",18,0)
 S PSODELI("QFLG")=0,APSP("LOG DEL FLG")="INTERV"
"RTN","PSODELI",19,0)
 F PSODELI=0:0 S DIC(0)="QEAM",(PSODELI("DIC"),DIC)="^APSPQA(32.4,",DIC("S")="I DT=$P(^(0),U,1)" Q:PSODELI("QFLG")  D DEL
"RTN","PSODELI",20,0)
 Q
"RTN","PSODELI",21,0)
DEL ; Does actual lookup and deletion of entries
"RTN","PSODELI",22,0)
 K PSODELI("DA")
"RTN","PSODELI",23,0)
 D ^DIC K DIC,DA,DR
"RTN","PSODELI",24,0)
 I Y=-1 S PSODELI("QFLG")=1 G DELX
"RTN","PSODELI",25,0)
 S PSODELI("DA")=+Y
"RTN","PSODELI",26,0)
 S DIR(0)="Y",Y=0,DIR("A")="SURE YOU WANT TO DELETE THE ENTIRE ENTRY"
"RTN","PSODELI",27,0)
 D ^DIR K DIR
"RTN","PSODELI",28,0)
 G:$D(DIRUT)!('Y) DELX
"RTN","PSODELI",29,0)
 S DIE=PSODELI("DIC"),DA=PSODELI("DA"),DR=".01///@",DIDEL=9009032.4
"RTN","PSODELI",30,0)
 L +^APSPQA(32.4,PSODELI("DA")):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSODELI",31,0)
 D ^DIE K DIE,DA,DR
"RTN","PSODELI",32,0)
 L -^APSPQA(32.4,PSODELI("DA"))
"RTN","PSODELI",33,0)
DELX ; Exit point from DEL
"RTN","PSODELI",34,0)
 K DIC,DIR,DA,X,Y,PSODELI("DIC")
"RTN","PSODELI",35,0)
 Q
"RTN","PSODELI",36,0)
EOJ ; Clean up variables
"RTN","PSODELI",37,0)
 K PSODELI,APSP("LOG DEL FLG"),X,Y,DIRUT,DTOUT,DUOUT
"RTN","PSODELI",38,0)
 K DIC,DIK,DA,DR,DIDEL
"RTN","PSODELI",39,0)
 Q
"RTN","PSODIAG")
0^71^B63073470^B62418422
"RTN","PSODIAG",1,0)
PSODIAG ;BIR/LE - Diagnosis code prompts ;02/27/04
"RTN","PSODIAG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,219,239,268**;DEC 1997;Build 9
"RTN","PSODIAG",3,0)
 ;Ext ref to ^XUSEC sup by DBIA 10076
"RTN","PSODIAG",4,0)
 ;Ext ref to $$ICDDX^ICDCODE sup DBIA 3990
"RTN","PSODIAG",5,0)
 ;Ext ref to $$STATCHK^ICDAPIU sup DBIA 3991
"RTN","PSODIAG",6,0)
EN ;
"RTN","PSODIAG",7,0)
 ;don't ask icd's if user doesn't hold provider key
"RTN","PSODIAG",8,0)
 Q:$T(CIDC^IBBAPI)']""
"RTN","PSODIAG",9,0)
 Q:'$D(^XUSEC("PROVIDER",DUZ))
"RTN","PSODIAG",10,0)
 N PSODDFN S PSODDFN=$S($D(DFN):DFN,$D(PSODFN):PSODFN,1:"")  ;need to do this since PU patient update deletes DFN and in case some other function does
"RTN","PSODIAG",11,0)
 I PSODDFN'="" I '$$CIDC^IBBAPI(PSODDFN) S:(+$G(PSONEW("DFLG")))&(+$G(PSOEDIT)=1)&('$D(DA)) PSONEW("DFLG")=0 Q  ;is CIDC activated; does patient have insurance
"RTN","PSODIAG",12,0)
 ;new variables and initialize variables based on CPRS or backdoor order.
"RTN","PSODIAG",13,0)
 N DX,POP,I,J,X,Y,Z,OLD,OLDI,SOLDI,NEW,TNEW,RAR,CPRS,FILDAT,STATCHK,STATCHK2
"RTN","PSODIAG",14,0)
 I '$G(PSOX("IRXN")) N PSOX S:$G(PSORXED("IRXN")) PSOX("IRXN")=PSORXED("IRXN")
"RTN","PSODIAG",15,0)
 K DIC
"RTN","PSODIAG",16,0)
 S CPRS=0
"RTN","PSODIAG",17,0)
 I $G(PSORXED) S RAR="PSORXED",@RAR@("DFLG")=0,PSORXED("FLD",39.3)=""
"RTN","PSODIAG",18,0)
 E  S RAR="PSONEW",@RAR@("DFLG")=0 I $G(ORD) D
"RTN","PSODIAG",19,0)
 . I $D(^PS(52.41,ORD)) S CPRS=1 M PSONEW("ICD")=PSORXED("ICD") K PSORXED("ICD"),PSORXED("FLD",39.3)
"RTN","PSODIAG",20,0)
 ;
"RTN","PSODIAG",21,0)
 S FILDAT="",FILDAT=DT I $G(PSOX("IRXN")) S FILDAT=$$GET1^DIQ(52,PSOX("IRXN")_",","22","I")
"RTN","PSODIAG",22,0)
 ;display any previously entered ICD's
"RTN","PSODIAG",23,0)
 W !!,"Previously entered ICD-9 diagnosis codes: "
"RTN","PSODIAG",24,0)
 I 'CPRS D  ;&(RAR="PSORXED"!(RAR="PSONEW")) D
"RTN","PSODIAG",25,0)
 . I $D(PSOX("IRXN")) I '$D(PSORXED("ICD")) I $D(^PSRX(PSOX("IRXN"),"ICD")) F I=1:1:8 Q:'$D(^PSRX(PSOX("IRXN"),"ICD",I,0))  D
"RTN","PSODIAG",26,0)
 .. S OLD(I)=$$GET1^DIQ(52.052311,I_","_PSOX("IRXN")_",",".01")
"RTN","PSODIAG",27,0)
 .. S OLDI(I)=$$GET1^DIQ(52.052311,I_","_PSOX("IRXN")_",",".01","I")
"RTN","PSODIAG",28,0)
 . I ($D(@RAR@("ICD"))&('$D(OLD)))!($G(PSOCOPY)) D
"RTN","PSODIAG",29,0)
 .. F I=1:1:8 Q:'$D(@RAR@("ICD",I))  I @RAR@("ICD",I)'="" S OLDI(I)=@RAR@("ICD",I) D
"RTN","PSODIAG",30,0)
 ... S OLD(I)=$P(^ICD9(OLDI(I),0),"^",1)
"RTN","PSODIAG",31,0)
 ... S J=I-1 I I=1 W OLD(I) Q
"RTN","PSODIAG",32,0)
 . F I=1:1:8 Q:'$D(OLD(I))  D WRITE
"RTN","PSODIAG",33,0)
 E  I CPRS D
"RTN","PSODIAG",34,0)
 . I '$G(PSONEW("ICD")) F I=1:1:8 Q:'$D(^PS(52.41,ORD,"ICD",I,0))  D
"RTN","PSODIAG",35,0)
 .. S OLD(I)=$$GET1^DIQ(52.41311,I_","_ORD_",",".01")
"RTN","PSODIAG",36,0)
 .. S OLDI(I)=$$GET1^DIQ(52.41311,I_","_ORD_",",".01","I")
"RTN","PSODIAG",37,0)
 . I $D(PSONEW("ICD")) K OLD,OLDI D
"RTN","PSODIAG",38,0)
 .. F I=1:1:8 Q:'$D(PSONEW("ICD",I))  S OLDI(I)=PSONEW("ICD",I) D
"RTN","PSODIAG",39,0)
 ... S OLD(I)=$P(^ICD9(OLDI(I),0),"^",1)
"RTN","PSODIAG",40,0)
 . F I=1:1:8 Q:'$D(OLD(I))  D WRITE
"RTN","PSODIAG",41,0)
 M SOLDI=OLDI
"RTN","PSODIAG",42,0)
 ;
"RTN","PSODIAG",43,0)
EN2 ;ask for ICD's or display previously entered ones for editing
"RTN","PSODIAG",44,0)
 ;note: because ICD's are not longer required, could not use standard
"RTN","PSODIAG",45,0)
 ;       FileMan calls everywhere because of need to control deleted
"RTN","PSODIAG",46,0)
 ;       entries and cross-references.
"RTN","PSODIAG",47,0)
 W !
"RTN","PSODIAG",48,0)
 F I=1:1:8 D  Q:+$G(Y)=-1!(@RAR@("DFLG")) 
"RTN","PSODIAG",49,0)
 . I '$G(PSORXED)&('$G(CPRS)) S RAR="PSONEW"
"RTN","PSODIAG",50,0)
 .K DIC S DIC("A")=$S(I=1:"Select Primary ICD-9 Code: ",1:"Select Secondary ICD-9 Code: ")
"RTN","PSODIAG",51,0)
 . I $D(OLD(I)),(OLD(I)'="") S DIC("B")=OLD(I)
"RTN","PSODIAG",52,0)
 . S X="" W !,DIC("A") D  R X:60   ;did this so that I have control of the deletes
"RTN","PSODIAG",53,0)
 .. I $D(OLD(I)),(OLD(I)'="") W OLD(I)_"// "
"RTN","PSODIAG",54,0)
 . I $D(OLD(I)) S:X="" X=OLD(I)
"RTN","PSODIAG",55,0)
 . I X="" S Y=-1 Q
"RTN","PSODIAG",56,0)
 . I X["?" W !,"Enter a valid ICD-9 diagnosis code." S I=1-1 Q
"RTN","PSODIAG",57,0)
 . I X="@" D DELETE Q
"RTN","PSODIAG",58,0)
 . I X="^" S Y=-1 Q
"RTN","PSODIAG",59,0)
 . K DIC S DIC=80,DIC(0)="EMZQ"
"RTN","PSODIAG",60,0)
 . ;S DIC("S")="I $P($$ICDDX^ICDCODE(Y,FILDAT),U,10)&($P($$ICDDX^ICDCODE(Y,FILDAT),U,17)>$P($$ICDDX^ICDCODE(Y,FILDAT),U,12))"
"RTN","PSODIAG",61,0)
 . S DIC("S")="I $$STATCHK^PSODIAG(Y,FILDAT)"
"RTN","PSODIAG",62,0)
 . K DTOUT,DUOUT D ^DIC K DIC
"RTN","PSODIAG",63,0)
 . I X="^" S I=I-1,Y="" Q
"RTN","PSODIAG",64,0)
 . I $G(DUOUT)!($G(DTOUT)) S Y=-1,X="^" Q
"RTN","PSODIAG",65,0)
 . I +Y=-1&(X'=""!(X'="^")) I $D(^ICD9("BA",X)) S I=I-1,(X,Y)="" Q  ;user said No to are you sure ?.
"RTN","PSODIAG",66,0)
 . I Y=-1&(X?1A.A) S I=I-1,Y="" Q  ;user said not to Yes? question.
"RTN","PSODIAG",67,0)
 . I Y'=-1 D  I STATCHK2=1 S I=I-1,Y="" Q
"RTN","PSODIAG",68,0)
 .. S (STATCHK,STATCHK2)="",STATCHK=$$STATCHK^ICDAPIU($P(Y,U,2),FILDAT) D
"RTN","PSODIAG",69,0)
 ... I $P(STATCHK,"^",2)=-1 W !!,"Invalid ICD-9 diagnosis code.  Please choose another.",! S STATCHK2=1 Q
"RTN","PSODIAG",70,0)
 ... I +STATCHK=0 W !!,"Inactivated ICD-9 Diagnosis Code.  Please choose another.",! S STATCHK2=1 Q
"RTN","PSODIAG",71,0)
 . I +Y=-1 S I=I-1,Y="" W !!,"Invalid or inactivated ICD-9 diagnosis code.  Please choose another.",! Q
"RTN","PSODIAG",72,0)
 . S (POP,J)=0 F J=1:1:I D
"RTN","PSODIAG",73,0)
 ..I $G(DX(J))=+Y W $C(7),!," Duplicate entry.  Please select a different ICD-9 diagnosis code.",! S I=I-1,(Y,X)="",POP=1
"RTN","PSODIAG",74,0)
 . Q:POP
"RTN","PSODIAG",75,0)
 . S NEW("ICD",I)=$P(Y,U,1),DX(I)=+Y
"RTN","PSODIAG",76,0)
 ;
"RTN","PSODIAG",77,0)
 ;resequence entered ICD's and removed deleted ones from file
"RTN","PSODIAG",78,0)
 ;I X="^"&(RAR="PSONEW")&('CPRS) S @RAR@("DFLG")=0 K DUOUT,DTOUT,Y,X Q
"RTN","PSODIAG",79,0)
 ;
"RTN","PSODIAG",80,0)
 I '$D(NEW("ICD")) I $D(OLDI) M NEW("ICD")=OLDI ;if user ^ out on first icd
"RTN","PSODIAG",81,0)
 K PSOICDD I '$D(NEW("ICD"))&($G(PSOCOPY)) S PSOICDD=1
"RTN","PSODIAG",82,0)
 ;
"RTN","PSODIAG",83,0)
 S J=0 F I=1:1:8 Q:'$D(NEW("ICD",I))  I NEW("ICD",I)'="" S J=J+1,@RAR@("ICD",J)=NEW("ICD",I)
"RTN","PSODIAG",84,0)
 S TNEW=I
"RTN","PSODIAG",85,0)
 I X="^" D  ;if up arrow out, set all icd's past ^ point into array
"RTN","PSODIAG",86,0)
 . ;S Y=TNEW-1 F  S Y=$O(OLDI(Y)) Q:Y=""  S J=J+1,@RAR@("ICD",J)=OLDI(Y)
"RTN","PSODIAG",87,0)
 . K @RAR@("ICD") S Y="" F  S Y=$O(SOLDI(Y)) Q:Y=""  S @RAR@("ICD",Y)=SOLDI(Y)
"RTN","PSODIAG",88,0)
 . K PSORXED("FLD",39.3)  ;7/12/04
"RTN","PSODIAG",89,0)
 I $G(CPRS) K PSORX("ICD") M PSORXED("ICD")=@RAR@("ICD"),PSORX("ICD")=@RAR@("ICD")
"RTN","PSODIAG",90,0)
 I $G(PSORXED) K PSORX("ICD") M PSORX("ICD")=@RAR@("ICD")
"RTN","PSODIAG",91,0)
 I '$D(@RAR@("ICD"))&(CPRS) S PSONEW("IDFLG")=1 ;user deleted all in finish/complete order
"RTN","PSODIAG",92,0)
 Q:(RAR="PSONEW")
"RTN","PSODIAG",93,0)
 I '$D(@RAR@("ICD"))&('CPRS)&($D(^PSRX(PSOX("IRXN"),"ICD",1,0))) S PSORXED("IDFLG")=1  ;user deleted all
"RTN","PSODIAG",94,0)
 Q
"RTN","PSODIAG",95,0)
 ;
"RTN","PSODIAG",96,0)
 ;called from above to write previously entered ICD's to screen.
"RTN","PSODIAG",97,0)
WRITE S J=I-1 I I=1 W !,?10,"Primary: ",OLD(I),?30,$P($$ICDDX^ICDCODE(OLD(I),FILDAT),U,4) Q
"RTN","PSODIAG",98,0)
WRITE2 I I=2 W !,?3,"Secondaries #"_J_": ",OLD(I),?30,$P($$ICDDX^ICDCODE(OLD(I),FILDAT),U,4) Q
"RTN","PSODIAG",99,0)
 I I>2 W !,?15,"#"_J_": ",OLD(I),?30,$P($$ICDDX^ICDCODE(OLD(I),FILDAT),U,4)
"RTN","PSODIAG",100,0)
 Q
"RTN","PSODIAG",101,0)
STATCHK(ICDIEN,FILDAT) ;called from above to check active/inactive date during FileMan call.
"RTN","PSODIAG",102,0)
 N X S X=""
"RTN","PSODIAG",103,0)
 S ICDIEN=$P(^ICD9(ICDIEN,0),"^",1) S X=$$STATCHK^ICDAPIU(ICDIEN,FILDAT)
"RTN","PSODIAG",104,0)
 Q +X
"RTN","PSODIAG",105,0)
DELETE ;called from above to verify delete with user and to delete said entries
"RTN","PSODIAG",106,0)
 W !,"SURE YOU WANT TO DELETE? " S X="" R X:30 S X=$TR(X,"yn","YN")
"RTN","PSODIAG",107,0)
 I X'="Y"&(X'="N") W !,"Enter Y or N" G DELETE
"RTN","PSODIAG",108,0)
 I X="N" S I=I-1 Q
"RTN","PSODIAG",109,0)
 F J=I:1:8 Q:'$D(OLDI(J))  D
"RTN","PSODIAG",110,0)
 . I $D(OLDI(J+1)) S OLDI(J)=OLDI(J+1),OLD(J)=OLD(J+1) D
"RTN","PSODIAG",111,0)
 .. I CPRS&($D(PSONEW("ICD",J+1))) S PSONEW("ICD",J)=PSONEW("ICD",J+1)
"RTN","PSODIAG",112,0)
 .. E  I CPRS&('$D(PSONEW("ICD",J+1))) S PSONEW("ICD",J)=OLDI(J+1)
"RTN","PSODIAG",113,0)
 .. I $G(PSOCOPY) D
"RTN","PSODIAG",114,0)
 ... I ($D(PSONEW("ICD",J+1))) S PSONEW("ICD",J)=PSONEW("ICD",J+1)
"RTN","PSODIAG",115,0)
 ... I ($D(PSORXED("ICD",J+1))) S PSORXED("ICD",J)=PSORXED("ICD",J+1)
"RTN","PSODIAG",116,0)
 . E  K OLD(J),OLDI(J),PSONEW("ICD",J),PSORXED("ICD",J)
"RTN","PSODIAG",117,0)
 . ;I CPRS!($G(PSOCOPY)) K PSONEW("ICD",J),PSORXED("ICD",J)
"RTN","PSODIAG",118,0)
 S I=I-1,(X,Y)=""
"RTN","PSODIAG",119,0)
 Q
"RTN","PSODIAG",120,0)
 ;
"RTN","PSODIAG",121,0)
ICD ;called from PSON52 cause PSON52'S too large.  Stores ICD info for new Rx's (CPRS and backdoor) using variables from copy function and new order functions.
"RTN","PSODIAG",122,0)
 N D,DDATA,ICD,II
"RTN","PSODIAG",123,0)
 I $G(PSOCOPY)&('$D(PSOX("ICD")))&('$G(PSOICDD)) D
"RTN","PSODIAG",124,0)
 . S D=0 F D=1:1 Q:'$D(PSOX("ICD",D))
"RTN","PSODIAG",125,0)
 . F D=D:1:8 K ^PSRX(PSOX("IRXN"),"ICD",D,0)  ;remove any icd's del
"RTN","PSODIAG",126,0)
 . I $D(^PSRX(PSOX("OIRXN"),"ICD",0)) F D=1:1:8 Q:'$D(^PSRX(PSOX("OIRXN"),"ICD",D,0))  S PSOX("ICD",D)=$P(^PSRX(PSOX("OIRXN"),"ICD",D,0),U,1)
"RTN","PSODIAG",127,0)
 I $G(ORD) I $D(^PS(52.41,ORD,0))&($D(PSORX("ICD"))) M PSOX("ICD")=PSONEW("ICD")
"RTN","PSODIAG",128,0)
 I $D(PSOX("ICD")) F D=1:1:8 Q:'$D(PSOX("ICD",D))  S ICD=$G(PSOX("ICD",D)) D
"RTN","PSODIAG",129,0)
 . S DDATA="",DDATA=ICD_"^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$S(PSOSCP>49:$G(PSOANSQ("SC>50")),PSOSCP<50&(PSOSCP'=""):$G(PSOANSQ("SC")),1:"")_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))
"RTN","PSODIAG",130,0)
 . I $P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1 I PSOSCP<50&($D(PSOANSQ("SC>50"))) S $P(DDATA,"^",4)=PSOANSQ("SC>50")  ;for times when sc has no % defined.
"RTN","PSODIAG",131,0)
 . S ^PSRX(PSOX("IRXN"),"ICD",D,0)=DDATA,II=D
"RTN","PSODIAG",132,0)
 E  S D=1 D
"RTN","PSODIAG",133,0)
 . S DDATA="",DDATA="^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$S(PSOSCP>49:$G(PSOANSQ("SC>50")),PSOSCP<50&(PSOSCP'=""):$G(PSOANSQ("SC")),1:"")
"RTN","PSODIAG",134,0)
 . S DDATA=DDATA_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))
"RTN","PSODIAG",135,0)
 . S ^PSRX(PSOX("IRXN"),"ICD",D,0)=DDATA,II=D
"RTN","PSODIAG",136,0)
 . I $P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1 I PSOSCP<50&($D(PSOANSQ("SC>50"))) S $P(^PSRX(PSOX("IRXN"),"ICD",D,0),"^",4)=PSOANSQ("SC>50")
"RTN","PSODIAG",137,0)
 S ^PSRX(PSOX("IRXN"),"ICD",0)="^52.052311P^"_II_"^"_II
"RTN","PSODIAG",138,0)
 K PSOX("ICD"),PSORXED("ICD"),PSONEW("ICD"),PSORX("ICD")
"RTN","PSODIAG",139,0)
 Q
"RTN","PSODIAG",140,0)
 ;
"RTN","PSODIAG",141,0)
UPDATE ;was in PSOORED6; now called from PSOORED6; removes deletes for edits and stores data.
"RTN","PSODIAG",142,0)
 ;
"RTN","PSODIAG",143,0)
 N TNEW,DA,DIK,SCEI,I,II
"RTN","PSODIAG",144,0)
 S DA=PSORXED("IRXN")
"RTN","PSODIAG",145,0)
 I '$D(PSORXED("ICD"))&($G(PSORXED("IDFLG"))) D  K PSORXED("IDFLG") Q
"RTN","PSODIAG",146,0)
 . I $D(^PSRX(PSORXED("IRXN"),"ICD",1,0)) D
"RTN","PSODIAG",147,0)
 .. S TNEW=2 K ^PSRX(PSORXED("IRXN"),"ICD","B") S $P(^PSRX(PSORXED("IRXN"),"ICD",1,0),U,1)=""
"RTN","PSODIAG",148,0)
 .. F I=TNEW:1:8 Q:'$D(^PSRX(PSORXED("IRXN"),"ICD",I,0))  S DIK="^PSRX("_PSORXED("IRXN")_","_$C(34)_"ICD"_$C(34)_",",DA=I,DA(1)=PSORXED("IRXN") D ^DIK K DA,DIK
"RTN","PSODIAG",149,0)
 ;
"RTN","PSODIAG",150,0)
 I $D(PSORXED("ICD")) D
"RTN","PSODIAG",151,0)
 . S SCEI=$G(^PSRX(DA,"ICD",1,0)),$P(SCEI,"^")=""
"RTN","PSODIAG",152,0)
 . K ^PSRX(DA,"ICD")
"RTN","PSODIAG",153,0)
 . F I=1:1:8 Q:'$D(PSORXED("ICD",I))  S $P(SCEI,"^")=PSORXED("ICD",I),^PSRX(DA,"ICD",I,0)=SCEI,^PSRX(DA,"ICD","B",$P(SCEI,"^"),I)="",II=I
"RTN","PSODIAG",154,0)
 . S ^PSRX(DA,"ICD",0)="^52.052311P^"_II_U_II
"RTN","PSODIAG",155,0)
 Q
"RTN","PSODIAG",156,0)
 ;
"RTN","PSODIAG",157,0)
CSET ;Called from PSOHLNEW due to it's routine size.  Requires PSOICD & PENDING variable.  Sets ICD node for orders passed from CPRS.
"RTN","PSODIAG",158,0)
 N EE,EEE
"RTN","PSODIAG",159,0)
 S (EE,EEE)=0 F  S EE=$O(PSOICD(EE)) Q:EE=""  D
"RTN","PSODIAG",160,0)
 .S EEE=EEE+1,^PS(52.41,PENDING,"ICD",EEE,0)=PSOICD(EE) S:$P(PSOICD(EE),"^")'="" ^PS(52.41,PENDING,"ICD","B",$P(PSOICD(EE),"^"),EEE)=""
"RTN","PSODIAG",161,0)
 .S ^PS(52.41,PENDING,"ICD",0)="^52.41311PA"_U_EEE_U_EEE
"RTN","PSODIAG",162,0)
 Q
"RTN","PSODIR1")
0^28^B72033927^B69320145
"RTN","PSODIR1",1,0)
PSODIR1 ;IHS/DSD - ASKS DATA FOR RX ORDER ENTRY CONT. ;02/17/93 17:03
"RTN","PSODIR1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,46,78,102,121,131,146,166,184,222,268**;DEC 1997;Build 9
"RTN","PSODIR1",3,0)
 ;Ext ref ^PS(55-DBIA 2228, ^PSDRUG(-DBIA 221
"RTN","PSODIR1",4,0)
PTSTAT(PSODIR) ;
"RTN","PSODIR1",5,0)
PTSTATEN K DIC,DR,DIE S PSODIR("FIELD")=0
"RTN","PSODIR1",6,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" K PSORX("PATIENT STATUS"),PSODIR("PATIENT STATUS") N PSOFNDRX,PSOFNDFL,PSOFNDPS D
"RTN","PSODIR1",7,0)
 .S PSOFNDFL=0 F PSOFNDPS=0:0 S PSOFNDPS=$O(^PS(53,PSOFNDPS)) Q:'PSOFNDPS!(PSOFNDFL)  D
"RTN","PSODIR1",8,0)
 ..S PSOFNDRX=$P($G(^PS(53,PSOFNDPS,0)),"^") S PSOFNDRX=$$UP^XLFSTR(PSOFNDRX) I PSOFNDRX="NON-VA" S PSOFNDFL=1 S (PSORX("PATIENT STATUS"),DIC("B"))=$P($G(^PS(53,PSOFNDPS,0)),"^")
"RTN","PSODIR1",9,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW",$G(PSORX("PATIENT STATUS"))="" W !,"Could not find a 'NON-VA' Patient Status in the RX PATIENT STATUS file (#53)!" D PSTPB D  S PSODIR("DFLG")=1 G PTSTATX
"RTN","PSODIR1",10,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSODIR1",11,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" G TPBB
"RTN","PSODIR1",12,0)
 N PSOX
"RTN","PSODIR1",13,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^"),DIC("B")=PSORX("PATIENT STATUS")
"RTN","PSODIR1",14,0)
 S:$G(PSODIR("PATIENT STATUS"))]"" DIC("B")=PSODIR("PATIENT STATUS")
"RTN","PSODIR1",15,0)
TPBB ;
"RTN","PSODIR1",16,0)
 D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"")
"RTN","PSODIR1",17,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSODIR1",18,0)
 S DIC("A")="RX PATIENT STATUS: "
"RTN","PSODIR1",19,0)
 S DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSODIR1",20,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" N PSOPSDIR,PSOFNDZZ,PSOPSUPA S (PSOPSDIR,PSOPSUPA)=0 D  I PSOPSDIR S:PSOPSUPA PSODIR("DFLG")=1 G:PSOPSUPA PTSTATX W ! D PSTPB G PTSTATEN
"RTN","PSODIR1",21,0)
 .I +Y'>0!($D(DTOUT))!($D(DUOUT)) S (PSOPSDIR,PSOPSUPA)=1 Q
"RTN","PSODIR1",22,0)
 .S (PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"))=+Y,PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",23,0)
 .S PSOFNDZZ=$P($G(^PS(53,+Y,0)),"^") S PSOFNDZZ=$$UP^XLFSTR(PSOFNDZZ) I PSOFNDZZ'="NON-VA" S PSOPSDIR=1 K PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"),PSODIR("PTST NODE")
"RTN","PSODIR1",24,0)
 I $G(PSOTPBFG),$G(PSOFROM)="NEW" G TPBSC
"RTN","PSODIR1",25,0)
 I X[U,$L(X)>1 D:'$G(PSOEDIT) JUMP G PTSTATX
"RTN","PSODIR1",26,0)
 I $D(DUOUT)!$D(DTOUT) S PSODIR("DFLG")=1 G PTSTATX
"RTN","PSODIR1",27,0)
 I Y=-1 W $C(7)," Required" G PTSTATEN
"RTN","PSODIR1",28,0)
 N PSOFNDX,PSOFNDXY,PSOFNDXX,PSOFNDYY
"RTN","PSODIR1",29,0)
 S PSOFNDXY=$G(Y),PSOFNDYY=$G(Y(0))
"RTN","PSODIR1",30,0)
 I '$G(PSOTPBFG),$G(PSOFROM)="NEW" S PSOFNDX=$P($G(^PS(53,+Y,0)),"^") S PSOFNDXX=$$UP^XLFSTR(PSOFNDX) I PSOFNDXX="NON-VA" K PSOFNDX,PSOFNDXY,PSOFNDYY,PSOFNDXX,Y W !!,"Cannot select 'NON-VA' Rx Patient Status!",! G PTSTATEN
"RTN","PSODIR1",31,0)
 S Y=$G(PSOFNDXY),Y(0)=$G(PSOFNDYY)
"RTN","PSODIR1",32,0)
 K PSOFNDXY,PSOFNDYY,PSOFNDX,PSOFNDXX
"RTN","PSODIR1",33,0)
 S (PSODIR("PATIENT STATUS"),PSORX("PATIENT STATUS"))=+Y
"RTN","PSODIR1",34,0)
 S PSODIR("PTST NODE")=Y(0)
"RTN","PSODIR1",35,0)
TPBSC ;
"RTN","PSODIR1",36,0)
 I $G(PSOFDR),$P($G(OR0),"^",17)="C" G PTSTATX
"RTN","PSODIR1",37,0)
 L +^PS(55,PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T G PTSTATX
"RTN","PSODIR1",38,0)
 S DIE="55",DR="3////"_+Y,DA=PSODFN D ^DIE K DIE,DA,D0
"RTN","PSODIR1",39,0)
 L -^PS(55,PSODFN)
"RTN","PSODIR1",40,0)
PTSTATX K DTOUT,DUOUT,X,Y,DA
"RTN","PSODIR1",41,0)
 Q
"RTN","PSODIR1",42,0)
SIG(PSODIR) ;
"RTN","PSODIR1",43,0)
 I $G(PSOFDR),$G(PSODIR("SIG"))']"" D SIGOK G:$G(SIGOK)!($G(PSODIR("DFLG"))) SIGX
"RTN","PSODIR1",44,0)
 K DIR,DIC
"RTN","PSODIR1",45,0)
 S DIR(0)="52,10"
"RTN","PSODIR1",46,0)
 S:$G(PSODRUG("SIG"))]"" DIR("B")=PSODRUG("SIG")
"RTN","PSODIR1",47,0)
 S:$G(PSODIR("SIG"))]"" DIR("B")=PSODIR("SIG")
"RTN","PSODIR1",48,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") SIGX
"RTN","PSODIR1",49,0)
 S PSODIR("SIG")=Y,SIGOK=0 K SIG
"RTN","PSODIR1",50,0)
SIGX K X,Y
"RTN","PSODIR1",51,0)
 Q
"RTN","PSODIR1",52,0)
QTY(PSODIR) ;
"RTN","PSODIR1",53,0)
QTYA K DIR,DIC
"RTN","PSODIR1",54,0)
 I $G(CLOZPAT)=1 S DIR("A",1)="Patient Eligible for 14 day supply or 7 day supply with 1 refill"
"RTN","PSODIR1",55,0)
 I $G(CLOZPAT)=2 S DIR("A",1)="Patient Eligible 28 day supply or 14 day supply with 1 refill or 7 day supply with 3 refill"
"RTN","PSODIR1",56,0)
 S DIR(0)="52,7" S:$G(PSODRUG("IEN")) DIR("A")="QTY ( "_$G(PSODRUG("UNIT"))_" ) "_$S($P($G(^PSDRUG(+PSODRUG("IEN"),5)),"^")]"":$P(^PSDRUG(+PSODRUG("IEN"),5),"^"),1:"")
"RTN","PSODIR1",57,0)
 K QTYHLD I $G(PSODIR("QTY"))]"" S QTYHLD=PSODIR("QTY") K PSODIR("QTY")
"RTN","PSODIR1",58,0)
 D:'$G(PSOQTY) QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",59,0)
 I '$G(SPEED),$G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",60,0)
 K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",61,0)
 I $G(SPEED),$G(PSODIR("QTY"))']"" S PSODIR("QTY")=$P(^PSRX(PSORENW("OIRXN"),0),"^",7)
"RTN","PSODIR1",62,0)
 S:$G(PSODIR("QTY"))]"" DIR("B")=PSODIR("QTY")
"RTN","PSODIR1",63,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") QTYX
"RTN","PSODIR1",64,0)
 I $G(Y),$G(PSODRUG("MAXDOSE"))]"",$G(PSODIR("DAYS SUPPLY")),(Y/+PSODIR("DAYS SUPPLY")>PSODRUG("MAXDOSE")) D  G:$G(PSODIR("DFLG")) QTYX  G QTYA
"RTN","PSODIR1",65,0)
 .W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day" D DAYSEN
"RTN","PSODIR1",66,0)
 S PSODIR("QTY")=Y
"RTN","PSODIR1",67,0)
QTYX K X,Y
"RTN","PSODIR1",68,0)
 Q
"RTN","PSODIR1",69,0)
COPIES(PSODIR) ;
"RTN","PSODIR1",70,0)
 K DIR,DIC
"RTN","PSODIR1",71,0)
 S DIR(0)="52,10.6"
"RTN","PSODIR1",72,0)
 S DIR("B")=$S($G(PSODIR("COPIES"))]"":PSODIR("COPIES"),1:1)
"RTN","PSODIR1",73,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") COPIESX
"RTN","PSODIR1",74,0)
 S PSODIR("COPIES")=Y
"RTN","PSODIR1",75,0)
COPIESX K X,Y
"RTN","PSODIR1",76,0)
 Q
"RTN","PSODIR1",77,0)
DAYS(PSODIR) ;
"RTN","PSODIR1",78,0)
DAYSEN K DIR,DIC
"RTN","PSODIR1",79,0)
 S DIR(0)="N^1:"_$S($G(CLOZPAT)=2:28,$G(CLOZPAT)=1:14,$G(CLOZPAT)=0:7,1:90)
"RTN","PSODIR1",80,0)
 S DIR("B")=$S($D(CLOZPAT)&('$G(PSODIR("DAYS SUPPLY"))):7,$G(PSODIR("DAYS SUPPLY"))]"":PSODIR("DAYS SUPPLY"),$P($G(PSODIR("PTST NODE")),"^",3):$P(PSODIR("PTST NODE"),"^",3),1:30)
"RTN","PSODIR1",81,0)
 S DIR("A")="DAYS SUPPLY",DIR("?")="Enter a whole number between 1 and "_$S($G(CLOZPAT)=2:28,$G(CLOZPAT)=1:14,$G(CLOZPAT)=0:7,1:90)
"RTN","PSODIR1",82,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") DAYSX
"RTN","PSODIR1",83,0)
 I $G(Y),$G(PSODRUG("MAXDOSE"))]"",$G(PSODIR("QTY"))]"",(+PSODIR("QTY")/Y>PSODRUG("MAXDOSE")) W !,$C(7)," Greater than Maximum dose of "_PSODRUG("MAXDOSE")_" per day" G DAYSEN
"RTN","PSODIR1",84,0)
 S PSODIR("DAYS SUPPLY")=Y D:$G(PSOFROM)="NEW"
"RTN","PSODIR1",85,0)
 .K QTYHLD S:$G(PSODIR("QTY")) QTYHLD=PSODIR("QTY") D QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",86,0)
 .I $G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",87,0)
 .K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",88,0)
 S:$G(CLOZPAT)=0 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",89,0)
 D:$G(CLOZPAT)=2
"RTN","PSODIR1",90,0)
 .S:PSODIR("DAYS SUPPLY")=28 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",91,0)
 .S:PSODIR("DAYS SUPPLY")=14 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=1
"RTN","PSODIR1",92,0)
 .S:PSODIR("DAYS SUPPLY")=7 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=3
"RTN","PSODIR1",93,0)
 D:$G(CLOZPAT)=1
"RTN","PSODIR1",94,0)
 .S:PSODIR("DAYS SUPPLY")=14 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=0
"RTN","PSODIR1",95,0)
 .S:PSODIR("DAYS SUPPLY")=7 (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=1
"RTN","PSODIR1",96,0)
 K QTYHLD S:$G(PSODIR("QTY")) QTYHLD=PSODIR("QTY") D QTY^PSOSIG(.PSODIR)
"RTN","PSODIR1",97,0)
 I $G(QTYHLD),'$G(PSODIR("QTY")) S PSODIR("QTY")=QTYHLD
"RTN","PSODIR1",98,0)
 K QTYHLD K:'$G(PSODIR("QTY")) PSODIR("QTY")
"RTN","PSODIR1",99,0)
DAYSX K X,Y
"RTN","PSODIR1",100,0)
 Q
"RTN","PSODIR1",101,0)
REFILL(PSODIR) ;
"RTN","PSODIR1",102,0)
 I $G(OR0) G REFOR
"RTN","PSODIR1",103,0)
 S PSODIR("CS")=0 K DIR,DIC,PSOX
"RTN","PSODIR1",104,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSODIR("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSODIR("CS"),"^",2)=1
"RTN","PSODIR1",105,0)
 I PSODIR("CS") D
"RTN","PSODIR1",106,0)
 .S PSOX=5,PSOX1=$S($P($G(PSODIR("PTST NODE")),"^",4)>PSOX:PSOX,1:$P($G(PSODIR("PTST NODE")),"^",4)),PSOX=$S(PSOX1=5:PSOX,1:PSOX1)
"RTN","PSODIR1",107,0)
 .S PSOX=$S('PSOX:0,PSODIR("DAYS SUPPLY")=90:1,1:PSOX),PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR1",108,0)
 E  D
"RTN","PSODIR1",109,0)
 .S PSOX=11,PSOX1=$S($P($G(PSODIR("PTST NODE")),"^",4)>PSOX:PSOX,1:$P($G(PSODIR("PTST NODE")),"^",4)),PSOX=$S(PSOX1=11:PSOX,1:PSOX1)
"RTN","PSODIR1",110,0)
 .S PSDY=PSODIR("DAYS SUPPLY"),PSDY1=$S(PSDY<60:11,PSDY'<60&(PSDY'>89):5,PSDY=90:3,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSODIR1",111,0)
 I '$D(CLOZPAT) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F") D  G REFILLX
"RTN","PSODIR1",112,0)
 .I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!'$O(^PSRX(+$G(PSODIR("IRXN")),1,0))!('$G(PSOLOKED)) D  Q
"RTN","PSODIR1",113,0)
 ..S VALMSG="No refills allowed on "_$S(PSODRUG("DEA")["F":"this drug.",1:"Narcotics.") W !,VALMSG,!
"RTN","PSODIR1",114,0)
 ..S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0
"RTN","PSODIR1",115,0)
 ..Q
"RTN","PSODIR1",116,0)
 .;reset refills to the # given
"RTN","PSODIR1",117,0)
 .D RFRSET^PSODIR2
"RTN","PSODIR1",118,0)
 .Q
"RTN","PSODIR1",119,0)
 I $P($G(PSODIR("CS")),"^",2)=1 W !,"No refills allowed on Schedule 2 drugs...",! S:$D(PSODIR("FIELD")) PSODIR("FIELD")=0 S PSODIR("# OF REFILLS")=0 G REFILLX
"RTN","PSODIR1",120,0)
 I $D(CLOZPAT) S PSOX=$S($G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSODIR("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSODIR("DAYS SUPPLY")=7):1,1:0)
"RTN","PSODIR1",121,0)
 S DIR(0)="N^"_$S($G(RFTT):RFTT,1:0)_":"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSODIR1",122,0)
 S DIR("B")=$S($G(COPY):PSODIR("# OF REFILLS"),$G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSODIR("# OF REFILLS"))]"":PSODIR("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSODIR1",123,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the DAYS SUPPLY field."
"RTN","PSODIR1",124,0)
 D DIR G:PSODIR("DFLG")!PSODIR("FIELD") REFILLX
"RTN","PSODIR1",125,0)
 S (PSODIR("N# REF"),PSODIR("# OF REFILLS"))=Y
"RTN","PSODIR1",126,0)
REFILLX S:$G(PSODIR("# OF REFILLS"))']"" PSODIR("# OF REFILLS")=$S($G(PSODIR("N# REF"))]"":PSODIR("N# REF"),$G(PSOX1)]""&($G(PSOX)>PSOX1):PSOX1,1:PSOX)
"RTN","PSODIR1",127,0)
 K X,Y,PSOX,PSOX1,PSDY,PSDY1,DEA,PSOCS
"RTN","PSODIR1",128,0)
 Q
"RTN","PSODIR1",129,0)
 ;OERR CALL
"RTN","PSODIR1",130,0)
REFOR ;
"RTN","PSODIR1",131,0)
 D REFOR^PSODIR3
"RTN","PSODIR1",132,0)
 G REFILLX
"RTN","PSODIR1",133,0)
 Q
"RTN","PSODIR1",134,0)
DIR ;
"RTN","PSODIR1",135,0)
 S (PSODIR("FIELD"),PSODIR("DFLG"))=0
"RTN","PSODIR1",136,0)
 G:$G(DIR(0))']"" DIRX
"RTN","PSODIR1",137,0)
 D ^DIR K DIR,DIE,DIC,DA
"RTN","PSODIR1",138,0)
 I $D(DUOUT)!($D(DTOUT))!($D(DIROUT)),$L($G(X))'>1!(Y="") S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR1",139,0)
 I $D(DIRUT)!($D(DIROUT)),$G(SPEED) S PSODIR("DFLG")=1 G DIRX
"RTN","PSODIR1",140,0)
 I X[U,$L(X)>1 D JUMP
"RTN","PSODIR1",141,0)
DIRX K DIRUT,DTOUT,DUOUT,DIROUT
"RTN","PSODIR1",142,0)
 Q
"RTN","PSODIR1",143,0)
JUMP ;
"RTN","PSODIR1",144,0)
 I $G(PSOEDIT)!($G(OR0)) S PSODIR("DFLG")=1 Q
"RTN","PSODIR1",145,0)
 S X=$P(X,"^",2),DIC="^DD(52,",DIC(0)="QM" D ^DIC K DIC
"RTN","PSODIR1",146,0)
 I Y=-1 S PSODIR("FIELD")=PSODIR("FLD") G JUMPX
"RTN","PSODIR1",147,0)
 I $G(PSONEW1)=0 D JUMP^PSONEW1 G JUMPX
"RTN","PSODIR1",148,0)
 I $G(PSOREF1)=0 D JUMP^PSOREF1 G JUMPX
"RTN","PSODIR1",149,0)
 I $G(PSONEW3)=0 D JUMP^PSONEW3 G JUMPX
"RTN","PSODIR1",150,0)
 I $G(PSORENW3)=0 D JUMP^PSORENW3 G JUMPX
"RTN","PSODIR1",151,0)
JUMPX S X="^"_X
"RTN","PSODIR1",152,0)
 Q
"RTN","PSODIR1",153,0)
SIGOK ;review and decide on oerr sig
"RTN","PSODIR1",154,0)
 I '$O(SIG(0)) S SIGOK=0 Q
"RTN","PSODIR1",155,0)
 K SIGOK W !,"SIG: "
"RTN","PSODIR1",156,0)
 F SIG=0:0 S SIG=$O(SIG(SIG)) W SIG(SIG)_" ",!?5 Q:'$O(SIG(SIG))
"RTN","PSODIR1",157,0)
 K DIR,DIRUT,DUOUT,DTOUT S DIR("B")="YES",DIR(0)="Y",DIR("A")="Is this SIG correct" D ^DIR K DIR I $D(DIRUT) S PSODIR("DFLG")=1 K DIRUT,DUOUT,DTOUT Q
"RTN","PSODIR1",158,0)
 S SIGOK=Y I Y K PSODIR("SIG")
"RTN","PSODIR1",159,0)
 Q
"RTN","PSODIR1",160,0)
PSTPB ;
"RTN","PSODIR1",161,0)
 W !,"New orders entered through this option must have a Patient Status of 'NON-VA'!",!
"RTN","PSODIR1",162,0)
 Q
"RTN","PSODLKP")
0^29^B26284279^B25295257
"RTN","PSODLKP",1,0)
PSODLKP ;BHAM ISC/JrR - CREATE/EDIT DUE ANSWER FILE ENTRY ; 11/17/92 10:19
"RTN","PSODLKP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**268**;DEC 1997;Build 9
"RTN","PSODLKP",3,0)
 Q
"RTN","PSODLKP",4,0)
CREATE ;Create a new DUE ANSWER entry
"RTN","PSODLKP",5,0)
 W !!
"RTN","PSODLKP",6,0)
 D NEW
"RTN","PSODLKP",7,0)
 S PSA=+Y W !,"SEQUENCE NUMBER: ",PSA
"RTN","PSODLKP",8,0)
 S DIC="^PSRX(",DIC("A")="RX #: ",DIC(0)="QEAMZ"
"RTN","PSODLKP",9,0)
 D ^DIC K DIC
"RTN","PSODLKP",10,0)
 I $D(DUOUT)!$D(DTOUT) D DELETE G EXIT
"RTN","PSODLKP",11,0)
 S RXN=+Y,RX0=$S($D(Y(0)):Y(0),1:""),RXM=$S($D(Y(0,0)):Y(0,0),1:"")
"RTN","PSODLKP",12,0)
 D STUFF,QAIRE
"RTN","PSODLKP",13,0)
 I '$D(PSQA) D DELETE G EXIT
"RTN","PSODLKP",14,0)
 D DIE
"RTN","PSODLKP",15,0)
EXIT K CNT,D,DA,DIC,DIE,DIK,DINUM,DIR,DIRUT,DIROUT,DLAYGO,DR,DTOUT,DUOUT
"RTN","PSODLKP",16,0)
 K DZ,FLAG,I,K,L,LL,PZPOP,PSA,PSDFN,PSDIG,PSDRUG,PSHI,PSLEN,PSLO,PSMARG
"RTN","PSODLKP",17,0)
 K PSPROV,PSQ,PSQA,PSQN,PSQNUM,PSQP,PSTXT,PSTYP,PSWRAP,RX0,RXM,RXN,X,Y
"RTN","PSODLKP",18,0)
 K PSKIP,PID
"RTN","PSODLKP",19,0)
 W !! Q
"RTN","PSODLKP",20,0)
 ;
"RTN","PSODLKP",21,0)
DIE ;Enter here from PSODLKP,PSODEDT. Edit the DUE Answer sheet
"RTN","PSODLKP",22,0)
 S DIE="^PS(50.0731,",DA=PSA,DR="[PSOD DUE EDIT]" L +^PS(50.0731,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!" K DA,DR,DIE,PSA Q
"RTN","PSODLKP",23,0)
 D ^DIE K DIE,DR L -^PS(50.0731,DA) K DA
"RTN","PSODLKP",24,0)
GETQUES F PSQNUM=0:0 S PSQNUM=$O(^PS(50.0731,PSA,1,"B",PSQNUM)) Q:'PSQNUM  S PSQN=$O(^(PSQNUM,0)),PSQP=$P(^PS(50.0731,PSA,1,PSQN,0),"^",2) I $D(^PS(50.0732,PSQP,0)) S PSQ=^(0) D ASK Q:PZPOP
"RTN","PSODLKP",25,0)
 Q
"RTN","PSODLKP",26,0)
ASK S PZPOP=0
"RTN","PSODLKP",27,0)
 D WRAP^PSODEDT
"RTN","PSODLKP",28,0)
 S PSTYP=$S($P(PSQ,"^",2):$P(PSQ,"^",2),1:1),PSLO=$S($P(PSQ,"^",3)]"":$P(PSQ,"^",3),1:-999),PSHI=$S($P(PSQ,"^",4)]"":$P(PSQ,"^",4),1:999)
"RTN","PSODLKP",29,0)
 S PSDIG=$S($P(PSQ,"^",5)]"":$P(PSQ,"^",5),1:2),PSLEN=$S($P(PSQ,"^",6)]"":$P(PSQ,"^",6),1:70)
"RTN","PSODLKP",30,0)
 S DIR("??")="^D QUES2^PSODEDT",DIR("A")="    ANSWER: "
"RTN","PSODLKP",31,0)
 S DIR(0)=$S(PSTYP=1:"S^Y:YES;N:NO;U:UNKNOWN",PSTYP=2:"F^1:"_PSLEN,PSTYP=3:"N^"_PSLO_":"_PSHI_":"_PSDIG,1:"Y")
"RTN","PSODLKP",32,0)
 S $P(DIR(0),"^")=$P(DIR(0),"^")_"AO"
"RTN","PSODLKP",33,0)
 K DIR("B")
"RTN","PSODLKP",34,0)
 I $D(^PS(50.0731,PSA,1,PSQN,1)),^(1)]"" S DIR("B")=^(1)
"RTN","PSODLKP",35,0)
 D ^DIR K DIR
"RTN","PSODLKP",36,0)
 I $D(DUOUT)!$D(DTOUT) S PZPOP=1 Q
"RTN","PSODLKP",37,0)
 S X=$S($D(Y(0)):Y(0),1:Y)
"RTN","PSODLKP",38,0)
 S ^PS(50.0731,PSA,1,PSQN,1)=X
"RTN","PSODLKP",39,0)
 Q
"RTN","PSODLKP",40,0)
 ;
"RTN","PSODLKP",41,0)
NEW L +^PS(50.0731,0):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  W $C(7),!,"Trying to Lock ^PS(50.0731,0)" G NEW
"RTN","PSODLKP",42,0)
 S X=$P(^PS(50.0731,0),"^",3)
"RTN","PSODLKP",43,0)
LOOP S X=X+1 G:$D(^PS(50.0731,X)) LOOP
"RTN","PSODLKP",44,0)
 K DIC,DD,DO S DIC="^PS(50.0731,",DIC(0)="XL",DIC("DR")="6///NOW"_$S($D(DUZ)#2:";5////"_DUZ,1:""),DLAYGO=50.0731,DINUM=X D FILE^DICN L -^PS(50.0731,0)
"RTN","PSODLKP",45,0)
 K DIC,DLAYGO,DINUM
"RTN","PSODLKP",46,0)
 Q:$P(Y,"^",3)
"RTN","PSODLKP",47,0)
 G NEW
"RTN","PSODLKP",48,0)
 ;
"RTN","PSODLKP",49,0)
QAIRE K PSQA,DA S DIR(0)="50.0731,1" D ^DIR K DIR
"RTN","PSODLKP",50,0)
 Q:$D(DUOUT)!$D(DTOUT)
"RTN","PSODLKP",51,0)
 I 'Y W !,$C(7),"   REQUIRED!" G QAIRE
"RTN","PSODLKP",52,0)
 I $S('$D(^PS(50.073,+Y,2,0)):1,'$O(^(0)):1,1:0) W !!,"  Sorry, that Questionnaire is incomplete.",!,"  Please review it before proceeding!" Q
"RTN","PSODLKP",53,0)
 S PSQA=+Y,$P(^PS(50.0731,PSA,0),"^",2)=PSQA
"RTN","PSODLKP",54,0)
MOVE S FLAG=0
"RTN","PSODLKP",55,0)
 F I=0:0 S I=$O(^PS(50.073,PSQA,2,I)) Q:'I  S:$D(^PS(50.0732,$P(^(I,0),"^",2),0)) ^PS(50.0731,PSA,1,I,0)=^PS(50.073,PSQA,2,I,0),$P(^PS(50.0732,$P(^(0),"^",2),0),"^",7)=1,FLAG=1
"RTN","PSODLKP",56,0)
 S:FLAG $P(^PS(50.073,PSQA,0),"^",4)=1,^PS(50.0731,PSA,1,0)="^50.07311IA^"_$P(^PS(50.073,PSQA,2,0),"^",3,4)
"RTN","PSODLKP",57,0)
 ;S DIK="^PS(50.0731,"_PSA_",1,",DA(1)=PSA D IXALL^DIK K DIK,DA
"RTN","PSODLKP",58,0)
 S DIK="^PS(50.0731,",DA=PSA D IX^DIK K DIK,DA
"RTN","PSODLKP",59,0)
 K FLAG
"RTN","PSODLKP",60,0)
 Q
"RTN","PSODLKP",61,0)
STUFF K PSKIP
"RTN","PSODLKP",62,0)
 Q:RXN<1
"RTN","PSODLKP",63,0)
 S PSKIP=""
"RTN","PSODLKP",64,0)
 S PSDRUG=$P(RX0,"^",6),PSPROV=$P(RX0,"^",4),PSDFN=$P(RX0,"^",2)
"RTN","PSODLKP",65,0)
 S DIE="^PS(50.0731,",DA=PSA,DR="2////"_PSDRUG_";3////"_RXN_";4////"_PSPROV_";7////"_PSDFN_";10////"_PSOSITE D ^DIE K DIE,DA,DR
"RTN","PSODLKP",66,0)
 S Y=PSDRUG,C=$P(^DD(50.0731,2,0),"^",2) D Y^DIQ W:Y]"" !,"DRUG: ",Y
"RTN","PSODLKP",67,0)
 S Y=PSDFN,C=$P(^DD(50.0731,7,0),"^",2) D Y^DIQ W:Y]"" !,"PATIENT: ",Y
"RTN","PSODLKP",68,0)
 Q:'$D(^PS(50.073,"AD",PSDRUG))
"RTN","PSODLKP",69,0)
 S CNT=0 F L=0:0 S L=$O(^PS(50.073,"AD",PSDRUG,L)) Q:'L  I $P(^PS(50.073,L,0),"^",3) S CNT=CNT+1,LL=L
"RTN","PSODLKP",70,0)
 I CNT=1 S DIR("B")=$P(^PS(50.073,LL,0),"^") Q
"RTN","PSODLKP",71,0)
 W !?5,"This Drug requires the following Active Questionnaires:"
"RTN","PSODLKP",72,0)
 S DIC="^PS(50.073,",DIC(0)="QEM",D="B",DZ="??",DIC("S")="I $D(^PS(50.073,""AD"",PSDRUG,Y))&($P(^PS(50.073,Y,0),""^"",3))" D DQ^DICQ K DIC,D,DZ
"RTN","PSODLKP",73,0)
 Q
"RTN","PSODLKP",74,0)
DELETE W $C(7),!,"Deleting SEQUENCE NUMBER: ",PSA
"RTN","PSODLKP",75,0)
 S DA=PSA,DIK="^PS(50.0731," D ^DIK
"RTN","PSODLKP",76,0)
 Q
"RTN","PSODLKP",77,0)
QUES2 Q  I PSTYP=1 W !!,?5,"Enter Y for YES, N for NO, U for UNKNOWN."
"RTN","PSODLKP",78,0)
 I PSTYP=2 W !!,?5,"Enter a FREE TEXT answer from 1 to ",PSLEN," characters."
"RTN","PSODLKP",79,0)
 I PSTYP=3 W !!,?5,"Enter a number between ",PSLO," and ",PSHI,!,?5,"with a maximum of ",PSDIG," decimal digits."
"RTN","PSODLKP",80,0)
 W !?5,"Enter '^' to bypass."
"RTN","PSODLKP",81,0)
 D WRAP^PSODEDT
"RTN","PSODLKP",82,0)
 Q
"RTN","PSODLKP",83,0)
CHECK ;CHECK FOR DRUG MATCH FROM ORDER ENTRY
"RTN","PSODLKP",84,0)
 F PSODDRG=0:0 S PSODDRG=$O(^PS(50.073,"AD",PSODDRG)) Q:'PSODDRG  I PSODDRG=$P(^PSRX(PSONEW("IRXN"),0),"^",6) D CHECK1
"RTN","PSODLKP",85,0)
 Q
"RTN","PSODLKP",86,0)
CHECK1 F PSOST=0:0 S PSOST=$O(^PS(50.073,"AD",PSODDRG,PSOST)) Q:'PSOST  S PSOSTE=$P(^PS(50.073,PSOST,0),"^",5) Q:PSOSITE'=PSOSTE  S RXN=PSONEW("IRXN"),RX0=^PSRX(RXN,0) D CREATE1,EXIT
"RTN","PSODLKP",87,0)
 Q
"RTN","PSODLKP",88,0)
CREATE1 ;Create a new DUE ANSWER entry
"RTN","PSODLKP",89,0)
 W !!
"RTN","PSODLKP",90,0)
 D NEW
"RTN","PSODLKP",91,0)
 S PSA=+Y W !,"SEQUENCE NUMBER: ",PSA
"RTN","PSODLKP",92,0)
 S (RX0,RXM)=$S($D(^PSRX(RXN,0)):^(0),1:"")
"RTN","PSODLKP",93,0)
 D STUFF,QAIRE
"RTN","PSODLKP",94,0)
 I '$D(PSQA) D DELETE G EXIT
"RTN","PSODLKP",95,0)
 D DIE
"RTN","PSODLKP",96,0)
 Q
"RTN","PSODRG")
0^68^B35387370^B30705564
"RTN","PSODRG",1,0)
PSODRG ;IHS/DSD/JCM-ORDER ENTRY DRUG SELECTION ;03/30/93
"RTN","PSODRG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,23,36,53,54,46,112,139,207,148,243,268**;DEC 1997;Build 9
"RTN","PSODRG",3,0)
 ;Reference ^PSDRUG supported by DBIA 221
"RTN","PSODRG",4,0)
 ;Reference ^PS(50.7 supported by DBIA 2223
"RTN","PSODRG",5,0)
 ;Reference to PSSDIN supported by DBIA 3166
"RTN","PSODRG",6,0)
 ;Reference to $$NDCFMT^PSSNDCUT supported by IA 4707
"RTN","PSODRG",7,0)
 ;----------------------------------------------------------
"RTN","PSODRG",8,0)
START ;
"RTN","PSODRG",9,0)
 S (PSONEW("DFLG"),PSONEW("FIELD"),PSODRG("QFLG"))=0
"RTN","PSODRG",10,0)
 D @($S(+$G(PSOEDIT)=1&('$D(DA)):"SELECT^PSODRGN",1:"SELECT"))
"RTN","PSODRG",11,0)
 G:$G(PSORXED("DFLG")) END ; Select Drug
"RTN","PSODRG",12,0)
 I $G(PSORX("EDIT")),$G(PSOY),$G(PSODRUG("IEN"))=+PSOY D  G:$G(PSORXED("DFLG")) END
"RTN","PSODRG",13,0)
 . N NDC D NDC(+$G(PSORXED("IRXN")),0,+PSOY,.NDC) I $G(NDC)="^" S PSORXED("DFLG")=1 Q
"RTN","PSODRG",14,0)
 . I $G(NDC)'="" S (PSODRUG("NDC"),PSORXED("FLD",27))=NDC
"RTN","PSODRG",15,0)
 ;
"RTN","PSODRG",16,0)
 I $G(PSORX("EDIT"))]"",'PSONEW("FIELD") D TRADE
"RTN","PSODRG",17,0)
 G:PSONEW("DFLG")!(PSODRG("QFLG"))!($G(PSORXED("DFLG"))) END
"RTN","PSODRG",18,0)
 D SET ; Set various drug information
"RTN","PSODRG",19,0)
 D NFI ; Display dispense drug/orderable item text
"RTN","PSODRG",20,0)
 D:'$G(PSOEDIT) POST I $G(PSORX("DFLG")) S PSONEW("DFLG")=1 K:'$G(PSORX("EDIT")) PSORX("DFLG") ; Do any post selection action
"RTN","PSODRG",21,0)
END ;D EOJ
"RTN","PSODRG",22,0)
 Q
"RTN","PSODRG",23,0)
 ;------------------------------------------------------------
"RTN","PSODRG",24,0)
 ;
"RTN","PSODRG",25,0)
SELECT ;
"RTN","PSODRG",26,0)
 K:'$G(PSORXED) CLOZPAT
"RTN","PSODRG",27,0)
 K DIC,X,Y,PSODRUG("TRADE NAME"),PSODRUG("NDC"),PSODRUG("DAW") S:$G(POERR)&($P($G(OR0),"^",9)) Y=$P(^PSDRUG($P(OR0,"^",9),0),"^")
"RTN","PSODRG",28,0)
 I $G(PSODRUG("IEN"))]"" S Y=PSODRUG("NAME"),PSONEW("OLD VAL")=PSODRUG("IEN")
"RTN","PSODRG",29,0)
 W !,"DRUG: "_$S($G(Y)]"":Y_"// ",1:"") R X:$S($D(DTIME):DTIME,1:300) I '$T S DTOUT=1
"RTN","PSODRG",30,0)
 I X="",$G(Y)]"" S:Y X=Y S:'X X=$G(PSODRUG("IEN")) S:X X="`"_X
"RTN","PSODRG",31,0)
 G:X="" SELECT
"RTN","PSODRG",32,0)
 I X?1."?" W !!,"Answer with DRUG NUMBER, or GENERIC NAME, or VA PRODUCT NAME, or",!,"NATIONAL DRUG CLASS, or SYNONYM" G SELECT
"RTN","PSODRG",33,0)
 I $G(PSORXED),X["^" S PSORXED("DFLG")=1 G SELECTX
"RTN","PSODRG",34,0)
 I X="^"!(X["^^")!($D(DTOUT)) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",35,0)
 I '$G(POERR),X[U,$L(X)>1 S PSODIR("FLD")=PSONEW("FLD") D JUMP^PSODIR1 S:$G(PSODIR("FIELD")) PSONEW("FIELD")=PSODIR("FIELD") K PSODIR S PSODRG("QFLG")=1 G SELECTX
"RTN","PSODRG",36,0)
 S DIC=50,DIC(0)="EMQZVT",DIC("T")="",D="B^C^VAPN^VAC"
"RTN","PSODRG",37,0)
 S DIC("S")="I $S('$D(^PSDRUG(+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0),$S($P($G(^PSDRUG(+Y,2)),""^"",3)'[""O"":0,1:1),$D(^PSDRUG(""ASP"",+$G(^(2)),+Y))"
"RTN","PSODRG",38,0)
 D MIX^DIC1 K DIC,D
"RTN","PSODRG",39,0)
 I $D(DTOUT) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRG",40,0)
 I $D(DUOUT) K DUOUT G SELECT
"RTN","PSODRG",41,0)
 I Y<0 G SELECT
"RTN","PSODRG",42,0)
 S:$G(PSONEW("OLD VAL"))=+Y&('$G(PSOEDIT)) PSODRG("QFLG")=1
"RTN","PSODRG",43,0)
 K PSOY S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSODRG",44,0)
 I $P(PSOY(0),"^")="OTHER DRUG"!($P(PSOY(0),"^")="OUTSIDE DRUG") D TRADE
"RTN","PSODRG",45,0)
SELECTX K X,Y,DTOUT,DUOUT,PSONEW("OLD VAL")
"RTN","PSODRG",46,0)
 Q
"RTN","PSODRG",47,0)
 ;
"RTN","PSODRG",48,0)
NDC(RX,RFL,DRG,NDC) ; Editing NDC for ECME Released Rx's
"RTN","PSODRG",49,0)
 S NDC=$S($G(NDC)'="":$G(NDC),1:$$GETNDC^PSONDCUT(RX,.RFL))
"RTN","PSODRG",50,0)
 I $$STATUS^PSOBPSUT(RX,RFL)="" Q
"RTN","PSODRG",51,0)
 I '$$RXRLDT^PSOBPSUT(RX,RFL) Q
"RTN","PSODRG",52,0)
 ;
"RTN","PSODRG",53,0)
 S NDC=$S($G(NDC)'="":$G(NDC),1:$$GETNDC^PSONDCUT(RX,.RFL))
"RTN","PSODRG",54,0)
 D NDCEDT^PSONDCUT(RX,.RFL,$G(DRG),$G(PSOSITE),.NDC)
"RTN","PSODRG",55,0)
 Q
"RTN","PSODRG",56,0)
 ;
"RTN","PSODRG",57,0)
TRADE ;
"RTN","PSODRG",58,0)
 K DIR,DIC,DA,X,Y
"RTN","PSODRG",59,0)
 S DIR(0)="52,6.5" S:$G(PSOTRN)]"" DIR("B")=$G(PSOTRN) D ^DIR K DIR,DIC
"RTN","PSODRG",60,0)
 I X="@" S Y=X K DIRUT
"RTN","PSODRG",61,0)
 I $D(DIRUT) S:$D(DUOUT)!$D(DTOUT)&('$D(PSORX("EDIT"))) PSONEW("DFLG")=1 G TRADEX
"RTN","PSODRG",62,0)
 S PSODRUG("TRADE NAME")=Y
"RTN","PSODRG",63,0)
TRADEX I $G(PSORXED("DFLG")),$D(DIRUT) S PSORXED("DFLG")=1
"RTN","PSODRG",64,0)
 K DIRUT,DTOUT,DUOUT,X,Y,DA,DR,DIE
"RTN","PSODRG",65,0)
 Q
"RTN","PSODRG",66,0)
SET ;
"RTN","PSODRG",67,0)
 N STAT S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2)
"RTN","PSODRG",68,0)
 S PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSODRG",69,0)
 S:+$G(^PSDRUG(+PSOY,2)) PSODRUG("OI")=+$G(^(2)),PSODRUG("OIN")=$P(^PS(50.7,+$G(^(2)),0),"^")
"RTN","PSODRG",70,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSODRG",71,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3)
"RTN","PSODRG",72,0)
 S PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSODRG",73,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5)
"RTN","PSODRG",74,0)
 I $G(PSODRUG("NDC"))="" S PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSOY,$G(PSOSITE))
"RTN","PSODRG",75,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSOY,81)
"RTN","PSODRG",76,0)
 S PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSODRG",77,0)
 G:$G(^PSDRUG(+PSOY,660))']"" SETX
"RTN","PSODRG",78,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660))
"RTN","PSODRG",79,0)
 S PSODRUG("COST")=$P($G(PSOX1),"^",6)
"RTN","PSODRG",80,0)
 S PSODRUG("UNIT")=$P($G(PSOX1),"^",8)
"RTN","PSODRG",81,0)
 S PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSODRG",82,0)
SETX K PSOX1,PSOY
"RTN","PSODRG",83,0)
 Q
"RTN","PSODRG",84,0)
NFI ;display restriction/guidelines
"RTN","PSODRG",85,0)
 D EN^PSSDIN(PSODRUG("OI"),PSODRUG("IEN")) S NFI=$$PROMPT^PSSDIN
"RTN","PSODRG",86,0)
 I NFI]"","ODY"[NFI D TD^PSONFI
"RTN","PSODRG",87,0)
 K NFI Q
"RTN","PSODRG",88,0)
POST ;order checks
"RTN","PSODRG",89,0)
 K PSORX("INTERVENE") N STAT,SIG,PTR,NDF,VAP S PSORX("DFLG")=0
"RTN","PSODRG",90,0)
 D ^PSOBUILD
"RTN","PSODRG",91,0)
 D @$S($G(COPY):"^PSOCPDUP",1:"^PSODRDUP") ; Set PSORX("DFLG")=1 if process to stop
"RTN","PSODRG",92,0)
 Q:$G(PSORX("DFLG"))
"RTN","PSODRG",93,0)
 W:$G(PSOFIN)']"" !,"Now doing drug interaction and allergy checks.  Please wait...",!
"RTN","PSODRG",94,0)
 D ^PSODGDGI
"RTN","PSODRG",95,0)
 I $G(PSORX("INTERVENE"))]"" D FULL^VALM1,^PSORXI S VALMBCK="R"
"RTN","PSODRG",96,0)
 G:PSORX("DFLG") POSTX
"RTN","PSODRG",97,0)
 D:$P($G(^PSDRUG(PSODRUG("IEN"),"CLOZ1")),"^")]"" CLOZ G:PSORX("DFLG") POSTX
"RTN","PSODRG",98,0)
 K PSORX("INTERVENE")
"RTN","PSODRG",99,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D:PSONOAL'="" NOALRGY K PSONOAL
"RTN","PSODRG",100,0)
 G:PSORX("DFLG") POSTX
"RTN","PSODRG",101,0)
 I $D(PSODRUG("NDF")) S NDF=$P(PSODRUG("NDF"),"A"),VAP=$P(PSODRUG("NDF"),"A",2),PTR=NDF_"."_VAP
"RTN","PSODRG",102,0)
 I $G(NDF) D CHK^PSODGAL(PSODFN,"DR",PTR) K NDF,VAP,PTR
"RTN","PSODRG",103,0)
 I $P($G(PSODRUG("NDF")),"A")=0 D CHK1^PSODGAL(PSODFN)
"RTN","PSODRG",104,0)
 I $D(PSODRUG("VA CLASS")) D CLASS^PSODGAL(PSODFN)
"RTN","PSODRG",105,0)
POSTX ;
"RTN","PSODRG",106,0)
 K ^TMP($J,"DI"_PSODFN),^TMP($J,"DI")
"RTN","PSODRG",107,0)
 K PSORX("INTERVENE"),DA
"RTN","PSODRG",108,0)
 Q
"RTN","PSODRG",109,0)
 ;
"RTN","PSODRG",110,0)
EOJ ;
"RTN","PSODRG",111,0)
 K PSODRG
"RTN","PSODRG",112,0)
 Q
"RTN","PSODRG",113,0)
 ;
"RTN","PSODRG",114,0)
CLOZ ;
"RTN","PSODRG",115,0)
 S ANQRTN=$P(^PSDRUG(PSODRUG("IEN"),"CLOZ1"),"^"),ANQX=0
"RTN","PSODRG",116,0)
 S P(5)=PSODRUG("IEN"),DFN=PSODFN,X=ANQRTN
"RTN","PSODRG",117,0)
 X ^%ZOSF("TEST") I  D @("^"_ANQRTN) S:$G(ANQX) PSORX("DFLG")=1
"RTN","PSODRG",118,0)
 K P(5),ANQRTN,ANQX,X
"RTN","PSODRG",119,0)
 Q
"RTN","PSODRG",120,0)
 ;
"RTN","PSODRG",121,0)
EN(DRG) ;returns lab test identified for clozapine order checking
"RTN","PSODRG",122,0)
 K LAB I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")'="PSOCLO1" S LAB("NOT")=0 Q
"RTN","PSODRG",123,0)
 I $P($G(^PSDRUG(DRG,"CLOZ1")),"^")="PSOCLO1" D
"RTN","PSODRG",124,0)
 .S (CNT,I)=0 F  S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  S CNT=$G(CNT)+1
"RTN","PSODRG",125,0)
 .I CNT'=2 S LAB("BAD TEST")=0 K CNT Q
"RTN","PSODRG",126,0)
 .K CNT F I=0:0 S I=$O(^PSDRUG(DRG,"CLOZ2",I)) Q:'I  D
"RTN","PSODRG",127,0)
 ..S LABT=$S($P(^PSDRUG(DRG,"CLOZ2",I,0),"^",4)=1:"WBC",1:"ANC"),LAB(LABT)=$P(^PSDRUG(DRG,"CLOZ2",I,0),"^")_"^"_$P(^(0),"^",3)_"^"_$P(^(0),"^",4)
"RTN","PSODRG",128,0)
 K LABT,I
"RTN","PSODRG",129,0)
 Q
"RTN","PSODRG",130,0)
NOALRGY ;
"RTN","PSODRG",131,0)
 W $C(7),!,"There is no allergy assessment on file for this patient."
"RTN","PSODRG",132,0)
 W !,"You will be prompted to intervene if you continue with this prescription"
"RTN","PSODRG",133,0)
 K DIR
"RTN","PSODRG",134,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue?: ",DIR("B")="N" D ^DIR
"RTN","PSODRG",135,0)
 I 'Y S PSORX("DFLG")=1 Q
"RTN","PSODRG",136,0)
 D ^PSORXI
"RTN","PSODRG",137,0)
 Q
"RTN","PSODRGN")
0^70^B12292884^n/a
"RTN","PSODRGN",1,0)
PSODRGN ;BIR/SJA-ORDER ENTRY DRUG SELECTION ;02/15/07
"RTN","PSODRGN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**268**;DEC 1997;Build 9
"RTN","PSODRGN",3,0)
 ;Reference ^PSDRUG supported by DBIA 221
"RTN","PSODRGN",4,0)
 ;
"RTN","PSODRGN",5,0)
SELECT ;
"RTN","PSODRGN",6,0)
 K:'$G(PSORXED) CLOZPAT
"RTN","PSODRGN",7,0)
 K DIC,X,Y,PSODRUG("TRADE NAME"),PSODRUG("NDC"),PSODRUG("DAW") S:$G(POERR)&($P($G(OR0),"^",9)) Y=$P(^PSDRUG($P(OR0,"^",9),0),"^")
"RTN","PSODRGN",8,0)
 I $G(PSODRUG("IEN"))]"" S Y=PSODRUG("NAME"),PSONEW("OLD VAL")=PSODRUG("IEN")
"RTN","PSODRGN",9,0)
 S (PSDC,PSI)=0 W !!!,"The following Drug(s) are available for selection:"
"RTN","PSODRGN",10,0)
 F PSI=0:0 S PSI=$O(^PSDRUG("ASP",PSODRUG("OI"),PSI)) Q:'PSI  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) D
"RTN","PSODRGN",11,0)
 .S PSDC=PSDC+1 W !,PSDC_". "_$P(^PSDRUG(PSI,0),"^")_$S($P(^(0),"^",9):"     (N/F)",1:"")
"RTN","PSODRGN",12,0)
 .S PSDC(PSDC)=PSI
"RTN","PSODRGN",13,0)
 I PSDC=0 D
"RTN","PSODRGN",14,0)
 .N X,DRG
"RTN","PSODRGN",15,0)
 .S DRG=+$P($G(^PSRX(DA,0)),"^",6)
"RTN","PSODRGN",16,0)
 .S X=$$GET1^DIQ(50,DRG,100)
"RTN","PSODRGN",17,0)
 .I X'="",(DT>X) D
"RTN","PSODRGN",18,0)
 .. W !!,"   This Dispense Drug is now Inactive. You may select a"
"RTN","PSODRGN",19,0)
 .. W !,"    new Orderable Item, or you can enter a new Order with"
"RTN","PSODRGN",20,0)
 .. W !,"    an Active Drug.",!
"RTN","PSODRGN",21,0)
 .E  W !!,"No drugs available!",!
"RTN","PSODRGN",22,0)
 .K DIR S DIR(0)="E",DIR("A")="Press return to continue"
"RTN","PSODRGN",23,0)
 .D ^DIR K DIR
"RTN","PSODRGN",24,0)
 G:'PSDC ETX K PSOBDR S PSOBDR("NAME")=PSODRUG("NAME")
"RTN","PSODRGN",25,0)
 I PSDC'=1 D
"RTN","PSODRGN",26,0)
 .I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),2)),"^")=$G(PSODRUG("OI")) Q
"RTN","PSODRGN",27,0)
 .K PSODRUG("NAME"),PSODRUG("IEN")
"RTN","PSODRGN",28,0)
 W ! D KV S DIR(0)="N^1:"_PSDC,DIR("A")="Select Drug by number" D ^DIR
"RTN","PSODRGN",29,0)
 I $G(PSORXED),X["^" S PSORXED("DFLG")=1 G SELECTX
"RTN","PSODRGN",30,0)
 I +$G(PSOEDIT)=1,X="^"!(X["^^")!($D(DTOUT)) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRGN",31,0)
 I '$G(POERR),X[U,$L(X)>1 S PSODIR("FLD")=PSONEW("FLD") D JUMP^PSODIR1 S:$G(PSODIR("FIELD")) PSONEW("FIELD")=PSODIR("FIELD") K PSODIR S PSODRG("QFLG")=1 G SELECTX
"RTN","PSODRGN",32,0)
 I +$G(PSOEDIT)=1,$D(DTOUT) S PSONEW("DFLG")=1 G SELECTX
"RTN","PSODRGN",33,0)
 I $D(DUOUT) K DUOUT G SELECT
"RTN","PSODRGN",34,0)
 I Y<0 G SELECT
"RTN","PSODRGN",35,0)
 S:$G(PSONEW("OLD VAL"))=+Y&('$G(PSOEDIT)) PSODRG("QFLG")=1
"RTN","PSODRGN",36,0)
 D KV K PSOY S PSOY(0)=^PSDRUG(PSDC(Y),0),PSOY=PSDC(Y)_"^"_$P(PSOY(0),"^")
"RTN","PSODRGN",37,0)
 I $P(PSOY(0),"^")="OTHER DRUG"!($P(PSOY(0),"^")="OUTSIDE DRUG") D TRADE
"RTN","PSODRGN",38,0)
SELECTX K X,Y,DTOUT,DUOUT,PSDC,PSI,PSONEW("OLD VAL")
"RTN","PSODRGN",39,0)
 Q
"RTN","PSODRGN",40,0)
TRADE ;
"RTN","PSODRGN",41,0)
 K DIR,DIC,DA,X,Y
"RTN","PSODRGN",42,0)
 S DIR(0)="52,6.5" S:$G(PSOTRN)]"" DIR("B")=$G(PSOTRN) D ^DIR K DIR,DIC
"RTN","PSODRGN",43,0)
 I X="@" S Y=X K DIRUT
"RTN","PSODRGN",44,0)
 I $D(DIRUT) S:$D(DUOUT)!$D(DTOUT)&('$D(PSORX("EDIT"))) PSONEW("DFLG")=1 G TRADEX
"RTN","PSODRGN",45,0)
 S PSODRUG("TRADE NAME")=Y
"RTN","PSODRGN",46,0)
TRADEX I $G(PSORXED("DFLG")),$D(DIRUT) S PSORXED("DFLG")=1
"RTN","PSODRGN",47,0)
 K DIRUT,DTOUT,DUOUT,X,Y,DA,DR,DIE
"RTN","PSODRGN",48,0)
 Q
"RTN","PSODRGN",49,0)
ETX S VALMBCK="R" I 'PSDC S VALMSG="NO dispense drugs tied to this orderable item!"
"RTN","PSODRGN",50,0)
TX D KV K PSDC,PSI,X,Y
"RTN","PSODRGN",51,0)
 Q
"RTN","PSODRGN",52,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSODRGN",53,0)
 Q
"RTN","PSODRGN",54,0)
6 ;Called from PSOBKDED due to it's routine size.
"RTN","PSODRGN",55,0)
 I $G(PSOEDIT),$G(PSODRUG("NAME"))'=$G(PSOBDR("NAME")) D
"RTN","PSODRGN",56,0)
 .S DIR(0)="Y",DIR("B")="YES"
"RTN","PSODRGN",57,0)
 .S DIR("A",1)="You have changed the dispense drug from"
"RTN","PSODRGN",58,0)
 .S DIR("A",2)=$P(PSOBDR("NAME"),"^")_" to "_$P(PSODRUG("NAME"),"^")_".",DIR("A",3)=""
"RTN","PSODRGN",59,0)
 .F I=0:0 S I=$O(SIG(I)) Q:'I  S DIR("A",3+I)=$S(I=1:"Current SIG: ",1:"")_$G(SIG(I))
"RTN","PSODRGN",60,0)
 .S DIR("A")="Do You want to Edit the SIG"
"RTN","PSODRGN",61,0)
 .D ^DIR K DIR I $D(DIRUT) S PSORX("DFLG")=1 D M1^PSOOREDX Q
"RTN","PSODRGN",62,0)
 .Q:$D(DIRUT)!('Y)
"RTN","PSODRGN",63,0)
 .K PSOBDR D 10^PSOBKDED ;Dose
"RTN","PSODRGN",64,0)
 Q
"RTN","PSODUE")
0^30^B7809336^B7233085
"RTN","PSODUE",1,0)
PSODUE ;BHAM ISC/JRR - DUE BUILD A QUESTIONNAIRE ; 11/17/92 10:20
"RTN","PSODUE",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**268**;DEC 1997;Build 9
"RTN","PSODUE",3,0)
 Q
"RTN","PSODUE",4,0)
BUILD ;Build/Edit a DUE Survey Questionnaire
"RTN","PSODUE",5,0)
B2 S DIC="^PS(50.073,",DIC(0)="AEQLM",DLAYGO=50.073 D ^DIC K DIC G:Y<1 EXITB
"RTN","PSODUE",6,0)
 S (DA,PSODUEL)=+Y,DIE=50.073,DR="[PSOD DUE BUILD QUESTIONNAIRE]" L +^PS(50.073,PSODUEL):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G B2
"RTN","PSODUE",7,0)
 D ^DIE L -^PS(50.073,PSODUEL) K PSODUEL,PSRC
"RTN","PSODUE",8,0)
 G B2
"RTN","PSODUE",9,0)
EXITB K DIC,DIE,DA,DR,PSLOCK,PSQTYP,PSQUEST,X,Y
"RTN","PSODUE",10,0)
 QUIT
"RTN","PSODUE",11,0)
 ;
"RTN","PSODUE",12,0)
PRINT ;Batch print a Due Questionnaire
"RTN","PSODUE",13,0)
 S DIC="^PS(50.073,",DIC(0)="QEAM" D ^DIC K DIC
"RTN","PSODUE",14,0)
 G:Y=-1 EXITP
"RTN","PSODUE",15,0)
 S PSOQAIR=+Y
"RTN","PSODUE",16,0)
 S DIR(0)="NO^1:999",DIR("A")="NUMBER OF COPIES",DIR("?")="Enter the number of copies of this DUE Questionnaire to print" D ^DIR K DIR
"RTN","PSODUE",17,0)
 G:Y<1 EXITP
"RTN","PSODUE",18,0)
 S PSQCNT=Y
"RTN","PSODUE",19,0)
 K %ZIS,ZTDTH,ZTSAVE,IOP,ZTSK S PSOION=ION,%ZIS="QM" D ^%ZIS K %ZIS I POP S IOP=PSOION D ^%ZIS K IOP,PSOION G EXITP
"RTN","PSODUE",20,0)
 K PSOION I $D(IO("Q")) S ZTDESC="Print Due Questionnaires",ZTRTN="START^PSODUE" S ZTSAVE("PSQCNT")="",ZTSAVE("PSOQAIR")="",ZTSAVE("ZTREQ")="@" D ^%ZTLOAD W:$D(ZTSK) "queued..." K ZTSK,IO("Q") G EXITP
"RTN","PSODUE",21,0)
 ;
"RTN","PSODUE",22,0)
START ;Start here when print is queued
"RTN","PSODUE",23,0)
 U IO
"RTN","PSODUE",24,0)
 F PSI=1:1:PSQCNT S PSOQ=PSOQAIR D OUT
"RTN","PSODUE",25,0)
EXITP D ^%ZISC
"RTN","PSODUE",26,0)
 K DUOUT,DTOUT,PSDASH,PSQ,PSQA,PSQCNT,PSIGN,PSOQAIR,PSOQN,PSOQM,PSTXT,PSWRAP,PSQNUM
"RTN","PSODUE",27,0)
 K POP,TAB,DIRUT,DIROUT,PSLOCK,PSQUEST,PSQTYP,PSOQL,PSMARG,PSI,X,Y
"RTN","PSODUE",28,0)
 QUIT
"RTN","PSODUE",29,0)
 ;
"RTN","PSODUE",30,0)
OUT S PSOQM=$P(^PS(50.073,PSOQ,0),"^")
"RTN","PSODUE",31,0)
 W @IOF,?(IOM\2-($L(PSOQM)\2)-4),"*** ",PSOQM," ***",!
"RTN","PSODUE",32,0)
 W !,"DRUG: __________________________"
"RTN","PSODUE",33,0)
 S X="RX #: ______________" D X
"RTN","PSODUE",34,0)
 S X="PROVIDER: ______________________" D X
"RTN","PSODUE",35,0)
 S X="PATIENT: _______________________" D X
"RTN","PSODUE",36,0)
 S X="SECTION: _______________________" D X
"RTN","PSODUE",37,0)
 S X="SEQ. # __________________" D X
"RTN","PSODUE",38,0)
 D QOUT^PSODACT
"RTN","PSODUE",39,0)
 K PSDASH,PSOQM,PSOQ
"RTN","PSODUE",40,0)
 Q
"RTN","PSODUE",41,0)
X W:(IOM-$X)<($L(X)+4) !! S TAB=$S($X:$X+3,1:0) W ?(TAB),X
"RTN","PSOELPS2")
0^31^B39664791^B39367755
"RTN","PSOELPS2",1,0)
PSOELPS2 ;BIR/EJW-CPRS and Outpatient Pharmacy Status Update ;12/04/02
"RTN","PSOELPS2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**119,268**;DEC 1997;Build 9
"RTN","PSOELPS2",3,0)
 ;External reference to STATUS^ORQOR2 supported by DBIA 3458
"RTN","PSOELPS2",4,0)
 ;External reference to ^OR(100 supported by DBIA 3463
"RTN","PSOELPS2",5,0)
 ;CPRS/Outpatient status update
"RTN","PSOELPS2",6,0)
 ;PSOCPRS = CPRS number (Placer)
"RTN","PSOELPS2",7,0)
 ;PSORXNUM = Outpatient number (52 ien)
"RTN","PSOELPS2",8,0)
 N PSOPACRF
"RTN","PSOELPS2",9,0)
 D GETPACRF
"RTN","PSOELPS2",10,0)
 I '$D(PSOPACRF) Q
"RTN","PSOELPS2",11,0)
 D BMES^XPDUTL("This post-install job searches for Outpatient Pharmacy orders")
"RTN","PSOELPS2",12,0)
 D MES^XPDUTL("that are deleted but are Active in CPRS. If any are found")
"RTN","PSOELPS2",13,0)
 D MES^XPDUTL("the order in CPRS will be updated with the appropriate status.")
"RTN","PSOELPS2",14,0)
 D BMES^XPDUTL("The job also looks for Outpatient Pharmacy orders that are marked")
"RTN","PSOELPS2",15,0)
 D MES^XPDUTL("as DC'd by provider and if they really were deleted instead")
"RTN","PSOELPS2",16,0)
 D MES^XPDUTL("of discontinued, the CPRS order will be updated with the")
"RTN","PSOELPS2",17,0)
 D MES^XPDUTL("correct Stop Date.")
"RTN","PSOELPS2",18,0)
 D BMES^XPDUTL("This post-install also attempts to clean up a bad node in the")
"RTN","PSOELPS2",19,0)
 D MES^XPDUTL("PRESCRIPTION file (#52) caused if an up-arrow (^) was entered for")
"RTN","PSOELPS2",20,0)
 D MES^XPDUTL("the LOT# when editing a prescription.")
"RTN","PSOELPS2",21,0)
 D GETDATE
"RTN","PSOELPS2",22,0)
 S ZTRTN="EN^PSOELPS2",ZTDESC="Pharmacy/CPRS status clean up",ZTIO="",ZTSAVE("PSOPACRF")="" D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOELPS2",23,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOELPS2",24,0)
 Q
"RTN","PSOELPS2",25,0)
EN ;
"RTN","PSOELPS2",26,0)
 L +^XTMP("PSOELPS2"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOELPS2",27,0)
 N PSOCPRS,PSORXNUM,PSOXCOM,PSOXDT,PSOIJ,PSOJJ,PSOREAS,PSOACRL,PSOPHR,PSOALC,PSOADT,PSONAT,PSOCOMM,PSOZDUZ,PSOSTART,PSOEND,PSOETEXT,PSOECT,PSOCSTAT,PSOSTA
"RTN","PSOELPS2",28,0)
 I '$D(PSOPACRF) D GETPACRF I '$D(PSOPACRF) Q
"RTN","PSOELPS2",29,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOELPS2",30,0)
 D NOW^%DTC S PSOSTART=%
"RTN","PSOELPS2",31,0)
 S PSOECT=0,PSORX2=0
"RTN","PSOELPS2",32,0)
 S PSOCPRS="" F  S PSOCPRS=$O(^PSRX("APL",PSOCPRS)) Q:PSOCPRS=""  S PSORXNUM="" F  S PSORXNUM=$O(^PSRX("APL",PSOCPRS,PSORXNUM)) Q:PSORXNUM=""  D
"RTN","PSOELPS2",33,0)
 .I PSOCPRS'=$P($G(^PSRX(PSORXNUM,"OR1")),"^",2) Q
"RTN","PSOELPS2",34,0)
 .I '$D(^PSRX(PSORXNUM,0)) Q
"RTN","PSOELPS2",35,0)
 .D CHKARROW ; SEE IF AN EXTRA UP-ARROW IN ^PSRX(PSORXNUM,2) NODE
"RTN","PSOELPS2",36,0)
 .S PSOSTA=+$$STATUS^ORQOR2(PSOCPRS) I PSOSTA'=6,PSOSTA'=1 Q
"RTN","PSOELPS2",37,0)
 .I PSORXNUM'=$P($G(^OR(100,PSOCPRS,4)),"^") Q
"RTN","PSOELPS2",38,0)
 .I PSOPACRF'=$P($G(^OR(100,PSOCPRS,0)),"^",14) Q
"RTN","PSOELPS2",39,0)
 .S PSOCSTAT=$P($G(^PSRX(PSORXNUM,"STA")),"^")
"RTN","PSOELPS2",40,0)
 .I PSOSTA=6,PSOCSTAT=13 D  ; MARKED AS ACTIVE IN CPRS, DELETED IN O/P PHARMACY
"RTN","PSOELPS2",41,0)
 ..D GETDEL
"RTN","PSOELPS2",42,0)
 ..I 'PSOJJ Q
"RTN","PSOELPS2",43,0)
 ..D UPDCPRS
"RTN","PSOELPS2",44,0)
 .I PSOSTA=1,PSOCSTAT=14 D  ; MARKED AS 'DISCONTINUED BY PROVIDER' IN CPRS - CHECK FOR PREVIOUSLY DELETED IN O/P PHARMACY
"RTN","PSOELPS2",45,0)
 ..D GETDEL
"RTN","PSOELPS2",46,0)
 ..I 'PSOJJ Q
"RTN","PSOELPS2",47,0)
 ..D ACT
"RTN","PSOELPS2",48,0)
 ..D UPDCPRS
"RTN","PSOELPS2",49,0)
 ..S $P(^PSRX(PSORXNUM,"STA"),"^",1)=13
"RTN","PSOELPS2",50,0)
MAIL ;Send MailMan message upon job completion
"RTN","PSOELPS2",51,0)
 K PSOPACRF
"RTN","PSOELPS2",52,0)
 I $G(DUZ) D
"RTN","PSOELPS2",53,0)
 .S XMDUZ="Patch PSO*7*119 Post-Install",XMSUB="Outpatient/CPRS Status clean-up",XMY(DUZ)=""
"RTN","PSOELPS2",54,0)
 .D NOW^%DTC S PSOEND=%
"RTN","PSOELPS2",55,0)
 .S PSOETEXT(1)="The clean-up job for patch PSO*7*119 is complete."
"RTN","PSOELPS2",56,0)
 .S PSOETEXT(2)="The total number of mismatched statuses found were "_+$G(PSOECT)_"."
"RTN","PSOELPS2",57,0)
 .S PSOETEXT(3)="The total number of missing divisions were "_PSORX2_"."
"RTN","PSOELPS2",58,0)
 .S Y=$G(PSOSTART) D DD^%DT S PSOSTART=$G(Y)
"RTN","PSOELPS2",59,0)
 .S Y=$G(PSOEND) D DD^%DT S PSOEND=$G(Y)
"RTN","PSOELPS2",60,0)
 .S PSOETEXT(4)="The job started on "_$G(PSOSTART)_"."
"RTN","PSOELPS2",61,0)
 .S PSOETEXT(5)="The job ended on "_$G(PSOEND)_"."
"RTN","PSOELPS2",62,0)
 .S XMTEXT="PSOETEXT(" N DIFROM D ^XMD K Y,XMDUZ,XMTEXT,XMSUB
"RTN","PSOELPS2",63,0)
 L -^XTMP("PSOELPS2")
"RTN","PSOELPS2",64,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOELPS2",65,0)
 Q
"RTN","PSOELPS2",66,0)
 ;
"RTN","PSOELPS2",67,0)
GETDEL ;
"RTN","PSOELPS2",68,0)
 S PSOCOMM=""
"RTN","PSOELPS2",69,0)
 S (PSOIJ,PSOJJ,PSOPHR,PSOADT)=0 F  S PSOIJ=$O(^PSRX(PSORXNUM,"A",PSOIJ)) Q:'PSOIJ  S PSOREAS=$P($G(^(PSOIJ,0)),"^",2) I PSOREAS="D" I $P($G(^PSRX(PSORXNUM,"A",PSOIJ,0)),"^",4)=0 S PSOJJ=PSOIJ
"RTN","PSOELPS2",70,0)
 I 'PSOJJ Q
"RTN","PSOELPS2",71,0)
 S PSOACRL=$G(^PSRX(PSORXNUM,"A",PSOJJ,0)) D
"RTN","PSOELPS2",72,0)
 .S PSOPHR=$P(PSOACRL,"^",3),PSOALC=$P(PSOACRL,"^",5),PSOADT=$P(PSOACRL,"^"),(PSONAT,PSOCOMM)=""
"RTN","PSOELPS2",73,0)
 .I PSOALC["DELETED" S PSOCOMM=PSOALC
"RTN","PSOELPS2",74,0)
 Q
"RTN","PSOELPS2",75,0)
 ;
"RTN","PSOELPS2",76,0)
UPDCPRS ; UPDATE CPRS ENTRY WITH CORRECT STATUS AND DATE
"RTN","PSOELPS2",77,0)
 S PSOZDUZ=$G(DUZ) S:$G(PSOPHR) DUZ=PSOPHR D EN^PSOHLSN1(PSORXNUM,"OC","",PSOCOMM,PSONAT) S PSOECT=PSOECT+1 S DUZ=PSOZDUZ
"RTN","PSOELPS2",78,0)
 I '$G(PSOADT) S PSOADT=DT_".2200"
"RTN","PSOELPS2",79,0)
 I '$D(^XTMP("PSOELPS2")) S X1=DT,X2=+30 D C^%DTC S ^XTMP("PSOELPS2",0)=$G(X)_"^"_DT
"RTN","PSOELPS2",80,0)
 I $D(^OR(100,PSOCPRS,6)) S ^XTMP("PSOELPS2",$J,PSOCPRS,6)=^(6),$P(^OR(100,PSOCPRS,6),"^",3)=$E(PSOADT,1,12)
"RTN","PSOELPS2",81,0)
 I $D(^OR(100,PSOCPRS,3)) S ^XTMP("PSOELPS2",$J,PSOCPRS,3)=^(3),$P(^OR(100,PSOCPRS,3),"^")=$E(PSOADT,1,12)
"RTN","PSOELPS2",82,0)
 Q
"RTN","PSOELPS2",83,0)
 ;
"RTN","PSOELPS2",84,0)
ACT ; SET ENTRY IN ACTIVITY LOG
"RTN","PSOELPS2",85,0)
 N IR,J
"RTN","PSOELPS2",86,0)
 S IR=0 F J=0:0 S J=$O(^PSRX(PSORXNUM,"A",J)) Q:'J  S IR=J
"RTN","PSOELPS2",87,0)
 S IR=IR+1,^PSRX(PSORXNUM,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOELPS2",88,0)
 D NOW^%DTC S ^PSRX(PSORXNUM,"A",IR,0)=%_"^"_"E^"_$G(DUZ)_"^0^Dc'd by mistake, resetting back to deleted"
"RTN","PSOELPS2",89,0)
 Q
"RTN","PSOELPS2",90,0)
 ;
"RTN","PSOELPS2",91,0)
CHKARROW ;
"RTN","PSOELPS2",92,0)
 N RX2
"RTN","PSOELPS2",93,0)
 S RX2=$G(^PSRX(PSORXNUM,2)) I RX2="" Q
"RTN","PSOELPS2",94,0)
 I $P(RX2,"^",9)="" D
"RTN","PSOELPS2",95,0)
 .I $P(RX2,"^",5)'?7N,$P(RX2,"^",6)?7N,$P(RX2,"^",7)?7N D
"RTN","PSOELPS2",96,0)
 ..S ^XTMP("PSOELPS2",$J,"RX2",PSORXNUM)=RX2
"RTN","PSOELPS2",97,0)
 ..S RX2=$P(RX2,"^",1,3)_"^"_$P(RX2,"^",5,99)
"RTN","PSOELPS2",98,0)
 ..S PSORX2=PSORX2+1
"RTN","PSOELPS2",99,0)
 ..S ^PSRX(PSORXNUM,2)=RX2
"RTN","PSOELPS2",100,0)
 Q
"RTN","PSOELPS2",101,0)
 ;
"RTN","PSOELPS2",102,0)
GETPACRF ;
"RTN","PSOELPS2",103,0)
 S DIC=9.4,DIC(0)="Z",X="OUTPATIENT PHARMACY" D ^DIC K DIC
"RTN","PSOELPS2",104,0)
 I +Y'>0 D  Q
"RTN","PSOELPS2",105,0)
 .D BMES^XPDUTL("A problem was found when trying to identify a valid Outpatient Pharmacy")
"RTN","PSOELPS2",106,0)
 .D BMES^XPDUTL("package reference from the PACKAGE (#9.4) file.")
"RTN","PSOELPS2",107,0)
 .D BMES^XPDUTL("This post-install job cannot be run until this problem is resolved.")
"RTN","PSOELPS2",108,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSOELPS2",109,0)
 S PSOPACRF=+Y
"RTN","PSOELPS2",110,0)
 Q
"RTN","PSOELPS2",111,0)
 ;
"RTN","PSOELPS2",112,0)
GETDATE ; GET DATE/TIME OF WHEN BACKGROUND JOB SHOULD BE RUN
"RTN","PSOELPS2",113,0)
 S ZTDTH=""
"RTN","PSOELPS2",114,0)
 S NOW=0
"RTN","PSOELPS2",115,0)
 D NOW^%DTC S (Y,TODAY)=% D DD^%DT
"RTN","PSOELPS2",116,0)
 D BMES^XPDUTL("At the following prompt, enter a starting date@time or enter NOW to")
"RTN","PSOELPS2",117,0)
 D MES^XPDUTL("queue the job immediately.")
"RTN","PSOELPS2",118,0)
 D MES^XPDUTL("If this prompting is during patch installation, you will not see what you type.")
"RTN","PSOELPS2",119,0)
 W ! K %DT D NOW^%DTC S %DT="RAEX",%DT(0)=%,%DT("A")="Queue clean-up Job to run Date@Time: "
"RTN","PSOELPS2",120,0)
 D ^%DT K %DT I $D(DTOUT)!(Y<0) D MES^XPDUTL("Task will be queued to run NOW") S ZTDTH=$H,NOW=1
"RTN","PSOELPS2",121,0)
 I 'NOW,Y>0 D
"RTN","PSOELPS2",122,0)
 .S SAVEY=Y
"RTN","PSOELPS2",123,0)
 .D DD^%DT
"RTN","PSOELPS2",124,0)
 .S X=Y
"RTN","PSOELPS2",125,0)
 .S Y=SAVEY
"RTN","PSOELPS2",126,0)
ASK D BMES^XPDUTL("Task will be queued to run "_$S(NOW:"NOW",1:X)_". Is that correct?  :")
"RTN","PSOELPS2",127,0)
 R XX:300 S:'$T XX="Y" I $E(XX)'="Y",$E(XX)'="y",$E(XX)'="N",$E(XX)'="n" D BMES^XPDUTL(" Enter Y or N") G ASK
"RTN","PSOELPS2",128,0)
 I $E(XX)'="Y",$E(XX)'="y" G GETDATE
"RTN","PSOELPS2",129,0)
 I Y>0,ZTDTH="" S ZTDTH=Y
"RTN","PSOELPS2",130,0)
 I ZTDTH="" S ZTDTH=$H
"RTN","PSOELPS2",131,0)
 Q
"RTN","PSOEN145")
0^32^B8700479^B7868890
"RTN","PSOEN145",1,0)
PSOEN145 ;BIR/RTR-Patch 145 Environment check routine ;08/15/03
"RTN","PSOEN145",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**145,268**;DEC 1997;Build 9
"RTN","PSOEN145",3,0)
 Q:'XPDENV
"RTN","PSOEN145",4,0)
 N X1,X2,Y
"RTN","PSOEN145",5,0)
 L +^XTMP("SDPSO145"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !!,"Cannot load this build, someone else is either installing it now,",!,"or the Post-Init for this build is currently running from another install.",! S XPDABORT=2 Q
"RTN","PSOEN145",6,0)
 I $G(^XTMP("SDPSO145","PSOTINIT")) W !!,"Cannot load this build, the Post-Init has already been",!,"queued by another process.",! S XPDABORT=2 L -^XTMP("SDPSO145") Q
"RTN","PSOEN145",7,0)
 W !,"This build contains a post-install that will populate the TPB ELIGIBILITY",!,"(#52.91) File, and the TPB INSTITUTION LETTERS (#52.92) File.",!
"RTN","PSOEN145",8,0)
 K %DT D NOW^%DTC S %DT="RAEX",%DT(0)=%,%DT("A")="Queue the Post-Install to run at what Date@Time: "
"RTN","PSOEN145",9,0)
 D ^%DT K %DT I $D(DTOUT)!(Y<0) W !!,"Cannot install patch without queuing the post-install, install aborted!",! S XPDABORT=2 L -^XTMP("SDPSO145") Q
"RTN","PSOEN145",10,0)
 S ^XTMP("SDPSO145","PSOTINIT")=Y
"RTN","PSOEN145",11,0)
 S X1=DT,X2=+60 D C^%DTC S ^XTMP("SDPSO145",0)=$G(X)_"^"_DT
"RTN","PSOEN145",12,0)
 L -^XTMP("SDPSO145")
"RTN","PSOEN145",13,0)
 Q
"RTN","PSOEN145",14,0)
TEST ;
"RTN","PSOEN145",15,0)
 Q:'$G(XPDENV)
"RTN","PSOEN145",16,0)
 W !,"This build contains a post-install that will populate the TPB ELIGIBILITY",!,"(#52.91) File, and the TPB INSTITUTION LETTERS (#52.92) File.",!
"RTN","PSOEN145",17,0)
 K %DT D NOW^%DTC S %DT="RAEX",%DT(0)=%,%DT("A")="Queue the Post-Install to run at what Date@Time: "
"RTN","PSOEN145",18,0)
 D ^%DT K %DT I $D(DTOUT)!(Y<0) W !!,"Cannot install patch without queuing the post-install, install aborted!",! S XPDABORT=2 Q
"RTN","PSOEN145",19,0)
 S @XPDGREF@("PSOPINIT")=Y
"RTN","PSOEN145",20,0)
 Q
"RTN","PSOHELP")
0^33^B51249011^B49925355
"RTN","PSOHELP",1,0)
PSOHELP ;BHAM ISC/SAB-outpatient utility routine ; 2/17/93 18:00:36
"RTN","PSOHELP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,23,29,48,46,117,131,222,268**;DEC 1997;Build 9
"RTN","PSOHELP",3,0)
 ;External reference ^PS(51 supported by DBIA 2224
"RTN","PSOHELP",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOHELP",5,0)
 ;External reference ^PS(56 supported by DBIA 2229
"RTN","PSOHELP",6,0)
 ;External reference ^PSNPPIP supported by DBIA 2261
"RTN","PSOHELP",7,0)
 ;
"RTN","PSOHELP",8,0)
XREF D XREF^PSOHELP3
"RTN","PSOHELP",9,0)
 Q
"RTN","PSOHELP",10,0)
SIG ;checks PI for RXs
"RTN","PSOHELP",11,0)
 K VALMSG
"RTN","PSOHELP",12,0)
 I $E(X)=" " D EN^DDIOL("Leading spaces should not entered in the Patient Instructions! ","","$C(7),!") S VALMSG="There are leading spaces in Patient Instructions!"
"RTN","PSOHELP",13,0)
SIGONE K INS1 Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" EN S Z1=$P(X," ",Z0) D  G:'$D(X) EN
"RTN","PSOHELP",14,0)
 .I $L(Z1)>32 W $C(7),!?5,"MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES.",! K X Q
"RTN","PSOHELP",15,0)
 .D:$D(X)&($G(Z1)]"")  S INS1=$G(INS1)_" "_Z1
"RTN","PSOHELP",16,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2)
"RTN","PSOHELP",17,0)
 ..I $G(^PS(51,+Y,9))]"" S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOHELP",18,0)
EN K Z1,Z0
"RTN","PSOHELP",19,0)
 Q
"RTN","PSOHELP",20,0)
SSIG ;other lang. mods
"RTN","PSOHELP",21,0)
 K VALMSG
"RTN","PSOHELP",22,0)
 I $E(X)=" " D EN^DDIOL("Leading spaces should not entered in the Patient Instructions! ","","$C(7),!") S VALMSG="There are leading spaces in Patient Instructions!"
"RTN","PSOHELP",23,0)
 K SINS1 Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" EX S Z1=$P(X," ",Z0) D  G:'$D(X) EX
"RTN","PSOHELP",24,0)
 .I $L(Z1)>32 W $C(7),!?5,"MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES.",! K X Q
"RTN","PSOHELP",25,0)
 .D:$D(X)&($G(Z1)]"")  S SINS1=$G(SINS1)_" "_Z1
"RTN","PSOHELP",26,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y  S Z1=$P(^PS(51,Y,0),"^",2)
"RTN","PSOHELP",27,0)
 ..I $G(^PS(51,+Y,4))]"" S Z1=^PS(51,+Y,4) ;,Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOHELP",28,0)
EX K Z1,Z0
"RTN","PSOHELP",29,0)
 Q
"RTN","PSOHELP",30,0)
QTY ;Check quantity dispensed against inventory
"RTN","PSOHELP",31,0)
 Q:'$G(PSODRUG("IEN"))
"RTN","PSOHELP",32,0)
 S Z0=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),$G(PSXYES):$P(^PSRX(ZRX,0),"^",6),$D(^PSRX(DA,0)):+$P(^(0),"^",6),1:0)
"RTN","PSOHELP",33,0)
 I $D(^PSDRUG("AQ",Z0)),(+X'=X) K X,Z0 Q
"RTN","PSOHELP",34,0)
 S Z1=$S($D(^PSDRUG(Z0,660.1)):^(660.1),1:0)+(+X) D:X>Z1 EN^DDIOL("  Greater Than Current Inventory!","","$C(7)") K Z1
"RTN","PSOHELP",35,0)
 S ZX=X,ZZ0=$G(D0),D0=Z0
"RTN","PSOHELP",36,0)
 S Y(18,2)=$S($D(^PSDRUG(D0,660)):^(660),1:""),Y(18,1)=$S($D(^(660.1)):^(660.1),1:"")
"RTN","PSOHELP",37,0)
 S X=$P(Y(18,1),"^",1),X=$S($P(Y(18,2),"^",5):X/$P(Y(18,2),"^",5),1:"*******")
"RTN","PSOHELP",38,0)
 S X=$J(X,0,2)
"RTN","PSOHELP",39,0)
 D:X<$S($D(^PSDRUG(Z0,660)):+^(660),1:1) EN^DDIOL("  Below Reorder Level.","","$C(7)") S X=ZX,D0=$G(ZZ0) K ZZ0,Z0,ZX
"RTN","PSOHELP",40,0)
 Q
"RTN","PSOHELP",41,0)
HELP ;qty help
"RTN","PSOHELP",42,0)
 G:$G(PSOFDR) HLP
"RTN","PSOHELP",43,0)
 S Z0=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),$G(PSXYES):$P(^PSRX(ZRX,0),"^",6),$D(^PSRX(DA,0)):$P(^PSRX(DA,0),"^",6),1:0)
"RTN","PSOHELP",44,0)
HLP S Z0=+$G(PSODRUG("IEN"))  I $D(^PSDRUG("AQ",Z0)) D EN^DDIOL("This is a CMOP drug. The quantity may not contain alpha characters (i.e.; ML)","","!!") D EN^DDIOL("or more than two fractional decimal places (i.e.; .01).","","!") D  K Z0 Q
"RTN","PSOHELP",45,0)
 .D EN^DDIOL("Enter a number between 0 and 99999999 inclusive. The total entry cannot","","!") D EN^DDIOL("exceed 11 characters.","","!")
"RTN","PSOHELP",46,0)
 D EN^DDIOL("Enter a whole number between 0 and 99999999 inclusive.  Alpha characters are","","!!")
"RTN","PSOHELP",47,0)
 D EN^DDIOL("not allowed, and the entry cannot exceed 11 characters, or contain more than","","!") D EN^DDIOL("two fractional decimal places (i.e.; .01).","","!")
"RTN","PSOHELP",48,0)
 K Z0
"RTN","PSOHELP",49,0)
 Q
"RTN","PSOHELP",50,0)
ADD ;add/edited local drug/drug interactions
"RTN","PSOHELP",51,0)
 W ! S DIC("A")="Select Drug Interaction: ",DIC(0)="AEMQL",DLAYGO=56
"RTN","PSOHELP",52,0)
 S (DIC,DIE)="^PS(56,",DIC("S")="I '$P(^(0),""^"",5)" D ^DIC G:"^"[X QU G:Y<0 ADD S DA=+Y,DR="[PSO INTERACT]" L +^PS(56,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G ADD
"RTN","PSOHELP",53,0)
 D ^DIE L:$G(DA) -^PS(56,DA) K DA G ADD
"RTN","PSOHELP",54,0)
QU L -^PS(56,DA) K X,DIC,DIE,DA
"RTN","PSOHELP",55,0)
 Q
"RTN","PSOHELP",56,0)
CRI ;change drug interaction severity to critical from significant
"RTN","PSOHELP",57,0)
 W ! S DIC("A")="Select Drug Interaction: ",DIC(0)="AEQM",(DIC,DIE)="^PS(56,",DIC("S")="I $P(^(0),""^"",4)=2" D ^DIC G:"^"[X QU G:Y<0 CRI S DA=+Y,DR=3
"RTN","PSOHELP",58,0)
 L +^PS(56,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Entry is being edited by another user. Try Later!",! G CRI
"RTN","PSOHELP",59,0)
 D ^DIE L -^PS(56,DA) K DA G CRI
"RTN","PSOHELP",60,0)
 G QU
"RTN","PSOHELP",61,0)
 Q
"RTN","PSOHELP",62,0)
MAX S:$G(EXH) P(7)=$P(^PSRX(DA,0),"^",8),P(5)=$P(^(0),"^",6),P(2)=+$P(^(0),"^",3) S:P(2) PTST=$G(^PS(53,P(2),0)),PTDY=$P($G(^(0)),"^",3),PTRF=$P($G(^(0)),"^",4)
"RTN","PSOHELP",63,0)
 S PSODEA=$P(^PSDRUG(P(5),0),"^",3),CS=0
"RTN","PSOHELP",64,0)
 I $D(CLOZPAT) S MAX=$S(CLOZPAT=2&($P(^PSRX(DA,0),"^",8)=14):1,CLOZPAT=2&($P(^PSRX(DA,0),"^",8)=7):3,CLOZPAT=1&($P(^PSRX(DA,0),"^",8)=7):1,1:0),MIN=0 Q
"RTN","PSOHELP",65,0)
 I PSODEA["A"&(PSODEA'["B")!(PSODEA["F") D EN^DDIOL("No refills allowed on "_$S(PSODEA["F":"this drug.",1:"Narcotics .."),"","!") D EN^DDIOL(" ","","!") S $P(^PSRX(DA,0),"^",9)=0 K X,Y,PSODEA,CS,PTST Q
"RTN","PSOHELP",66,0)
 F DEA=1:1 Q:$E(PSODEA,DEA)=""  I $E(+PSODEA,DEA)>1,$E(+PSODEA,DEA)<6 S CS=1
"RTN","PSOHELP",67,0)
 S PSOELSE=CS I PSOELSE D
"RTN","PSOHELP",68,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOT=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOHELP",69,0)
 .S PSOT=$S('PSOT:0,P(7)=90:1,1:PSOT),PSDY1=$S(P(7)<60:5,P(7)'<60&(P(7)'>89):2,P(7)=90:1,1:0) S MAX=$S(PSOT'>PSDY1:PSOT,1:PSDY1)
"RTN","PSOHELP",70,0)
 I 'PSOELSE D
"RTN","PSOHELP",71,0)
 .S PSOX1=PTRF,PSOT=$S(PSOX1=11:11,1:PSOX1),PSOT=$S('PSOT:0,P(7)=90:3,1:PSOT)
"RTN","PSOHELP",72,0)
 .S PSDY1=$S(P(7)<60:11,P(7)'<60&(P(7)'>89):5,P(7)=90:3,1:0) S MAX=$S(PSOT'>PSDY1:PSOT,1:PSDY1)
"RTN","PSOHELP",73,0)
 K PSODEA,PSOELSE,PSOT,PSOX1,PSDY,PSDY1,DEA,CS
"RTN","PSOHELP",74,0)
 I $D(X) S MIN=0 I $D(DA) F REF=0:0 S REF=$O(^PSRX(DA,1,REF)) Q:'REF  I $D(^(REF,0)) S MIN=MIN+1
"RTN","PSOHELP",75,0)
 I $G(EXH) D EN^DDIOL("Enter a number Between "_MIN_" AND "_MAX_".","","!?10") K P(2),P(5),P(7),MAX,MAX1,MIN,REF
"RTN","PSOHELP",76,0)
 Q
"RTN","PSOHELP",77,0)
 ;
"RTN","PSOHELP",78,0)
REF S PSRF=X,P(7)=$P(^PSRX(DA,0),"^",8),P(5)=$P(^(0),"^",6),P(2)=+$P(^(0),"^",3) S:P(2) PTST=$G(^PS(53,P(2),0)) S PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOHELP",79,0)
 D MAX Q:'$D(X)  I (+X'=X)!(X<0)!(X>MAX)!(X?.E1"."1N.N) D EN^DDIOL(" ** MAX REFILLS ALLOWED ARE "_MAX_" ** ","","$C(7)") K X
"RTN","PSOHELP",80,0)
 I $D(X),X<MIN D EN^DDIOL(" ** PATIENT HAS ALREADY RECEIVED "_MIN_" REFILLS ** ","","$C(7)") K X
"RTN","PSOHELP",81,0)
 D DAYS^PSOUTLA
"RTN","PSOHELP",82,0)
 K PTDY,PTRF,MAX,DAYS,PSDAYS,PSODEA,PSOX,PSOX1,PSDY,PSDY1,DEA,CS,PTST,PSRF,MIN,REF,P(2),P(7),P(5),MAX1
"RTN","PSOHELP",83,0)
 Q
"RTN","PSOHELP",84,0)
PAT ;patient field screen in file 52
"RTN","PSOHELP",85,0)
 N DIC,DIE S DFN=X D INP^VADPT,DEM^VADPT
"RTN","PSOHELP",86,0)
 I $P(VADM(6),"^") D EN^DDIOL("PATIENT DIED "_$P(VADM(6),"^",2),"","$C(7),!?10") D EN^DDIOL(" ","","!") K X,DFN Q
"RTN","PSOHELP",87,0)
 I $P(VAIN(4),"^") D EN^DDIOL("PATIENT IS AN INPATIENT ON WARD "_$P(VAIN(4),"^",2)_" !!","","$C(7),!?10") K DIR D DIR K VA,VADN,VAIN Q
"RTN","PSOHELP",88,0)
 E  S X=DFN K DFN,DIRUT,DTOUT,DUOUT
"RTN","PSOHELP",89,0)
 Q
"RTN","PSOHELP",90,0)
DIR S DIR(0)="Y",DIR("B")="YES",DIR("A")="DO YOU WISH TO CONTINUE" D ^DIR K DIR
"RTN","PSOHELP",91,0)
 K:'Y X S:Y X=DFN K DFN,DIRUT,DTOUT,DUOUT,VA,VADM,VAIN
"RTN","PSOHELP",92,0)
 Q
"RTN","PSOHELP",93,0)
BG ;prevents editing of display groups with patients from name to ticket
"RTN","PSOHELP",94,0)
 S $P(^PS(59.3,DA,0),"^",2)=PDP W !,$C(7),"The display cannot be changed from NAME to TICKET when patients are",!,"already in the Display Group.  All patients must be purged and re-entered.",!,"Ticket numbers must be issued !!",! K Y,PDP
"RTN","PSOHELP",95,0)
 Q
"RTN","PSOHELP",96,0)
CLNAP ;quits action profile
"RTN","PSOHELP",97,0)
 Q
"RTN","PSOHELP",98,0)
PRMI ;prints medication instruction sheets.  select drug.
"RTN","PSOHELP",99,0)
 S X="PSNPPIP" X ^%ZOSF("TEST") I '$T S VALMBCK="",VALMSG="Medication Instruction Sheets Not Installed!" Q
"RTN","PSOHELP",100,0)
 I $G(PSODFN) N PSNDFN S PSNDFN=PSODFN
"RTN","PSOHELP",101,0)
 W !! K PSNPPI("MESSAGE") D FULL^VALM1,^PSNPPIP S VALMBCK="R"
"RTN","PSOHELP",102,0)
 I $G(PSNPPI("MESSAGE"))]"" D
"RTN","PSOHELP",103,0)
 .K DIR W PSNPPI("MESSAGE"),! S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DIRUT,PSNPPI("MESSGAE")
"RTN","PSOHELP",104,0)
 Q
"RTN","PSOHELP",105,0)
PRMID ;prints medication instruction sheets.  pass in drug.
"RTN","PSOHELP",106,0)
 I $T(ENOP^PSNPPIP)']"" S VALMBCK="",VALMSG="Medication Instruction Sheets Not Installed!" Q
"RTN","PSOHELP",107,0)
 K PSNPPI("MESSAGE") D FULL^VALM1
"RTN","PSOHELP",108,0)
 W !! D ENOP^PSNPPIP($P(RX0,"^",6),$G(^PSRX(RXN,"TN")),$P(RX0,"^"),PSODFN)
"RTN","PSOHELP",109,0)
 S VALMBCK="R" I $G(PSNPPI("MESSAGE"))]"" D
"RTN","PSOHELP",110,0)
 .K DIR W PSNPPI("MESSAGE"),! S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,DIRUT,DIRUT,PSNPPI("MESSGAE")
"RTN","PSOHELP",111,0)
 Q
"RTN","PSOHLD")
0^78^B49126582^B48797916
"RTN","PSOHLD",1,0)
PSOHLD ;BIR/SAB - hold unhold functionality ;07/15/96
"RTN","PSOHLD",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,16,21,24,27,32,55,82,114,130,166,148,268**;DEC 1997;Build 9
"RTN","PSOHLD",3,0)
 ;External reference to ^DD(52-DBIA 999,  VA(200-DBIA 224, NA^ORX1-DBIA 2186,
"RTN","PSOHLD",4,0)
 ; L, UL, PSOL, and PSOUL^PSSLOCK-DBIA 2789, ^%DTC-DBIA 10000, ^DIE-DBIA 10018, ^DIR-DBIA 10026,
"RTN","PSOHLD",5,0)
 ; ^DIK-DBIA 10013, ^VALM1-DBIA 10016, ^XUSEC(-DBIA 10076
"RTN","PSOHLD",6,0)
UHLD I '$D(PSOPAR) D ^PSOLSET G:'$D(PSOPAR) EX
"RTN","PSOHLD",7,0)
 I $G(PSOBEDT) W $C(7),$C(7) S VALMSG="Invalid Action at this time !",VALMBCK="" Q
"RTN","PSOHLD",8,0)
 I $G(PSONACT) W $C(7),$C(7) S VALMSG="No Pharmacy Orderable Item !",VALMBCK="" Q
"RTN","PSOHLD",9,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOHLD",10,0)
 ;W !! S DIC("A")="Unhold Prescription #: ",(DIE,DIC)="^PSRX(",DIC(0)="AEMQZ",DIC("S")="I $G(^PSRX(+Y,""H""))]"""",$P(^(""STA""),""^"")'=16" D ^DIC G:"^"[$E(X) EX G:Y<0 UHLD S (DA,PPL)=+Y,DFN=$P(Y(0),"^",2)
"RTN","PSOHLD",11,0)
 K PSOPLCK D PSOL^PSSLOCK(DA) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULP Q
"RTN","PSOHLD",12,0)
 S Y(0)=^PSRX(DA,0),STA=+$G(^("STA"))
"RTN","PSOHLD",13,0)
 I STA=16 S VALMSG="Placed on HOLD by Provider!" K Y,STA D PSOUL^PSSLOCK(DA) D ULP S VALMBCK="" Q
"RTN","PSOHLD",14,0)
 I STA'=3!('$D(^XUSEC("PSORPH",DUZ))) S VALMSG="Invalid Action Selection!",VALMBCK="" K Y,STA D PSOUL^PSSLOCK(DA) D ULP Q
"RTN","PSOHLD",15,0)
 D FULL^VALM1 K DIR,DTOUT,DUOUT,DIRUT D NOOR I $D(DIRUT) D ULP G EX
"RTN","PSOHLD",16,0)
 I DT>$P(^PSRX(DA,2),"^",6) D  D ULP G EX
"RTN","PSOHLD",17,0)
 .S VALMSG="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"-"_$E($P(^(2),"^",6),6,7)_"-"_$E($P(^(2),"^",6),2,3) I $P(^PSRX(DA,"STA"),"^")<11 S $P(^PSRX(DA,"STA"),"^")=11
"RTN","PSOHLD",18,0)
 .S ^PSRX(DA,"H")="",COMM="Medication Expired on "_$E($P(^(2),"^",6),4,5)_"-"_$E($P(^(2),"^",6),6,7)_"-"_$E($P(^(2),"^",6),2,3) D EN^PSOHLSN1(DA,"SC","ZE",COMM,"") K COMM
"RTN","PSOHLD",19,0)
EN S RXF=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I,RSDT=$P(^(0),"^")
"RTN","PSOHLD",20,0)
 I RXF D  I $D(Y) D ULP G EX
"RTN","PSOHLD",21,0)
 .S (PSDA,DA(1))=DA,DA=RXF,DIE="^PSRX("_DA(1)_",1,"
"RTN","PSOHLD",22,0)
 .S RLDT=$P(^PSRX(DA(1),1,DA,0),"^",18)
"RTN","PSOHLD",23,0)
 .S DR=$S('RLDT:".01R;2;",1:"")_"3COMMENTS"
"RTN","PSOHLD",24,0)
 .S PSOUNHLD=1 D ^DIE K PSOUNHLD
"RTN","PSOHLD",25,0)
 .S ZD(PSDA)=$P(^PSRX(DA(1),1,DA,0),"^")
"RTN","PSOHLD",26,0)
 .Q:$D(Y)  S PSORX("FILL DATE")=$P(^PSRX(DA(1),1,DA,0),"^"),DA=PSDA K DA(1)
"RTN","PSOHLD",27,0)
 ;
"RTN","PSOHLD",28,0)
 S ACT=1,DIE="^PSRX(",FDT=$S($P(^PSRX(DA,2),"^",2):$P(^PSRX(DA,2),"^",2),1:DT)
"RTN","PSOHLD",29,0)
 S RLDT=$P(^PSRX(DA,2),"^",13),DR="",RLDTP1=$P(RLDT,".",1)
"RTN","PSOHLD",30,0)
 I 'RXF&'RLDT S DR="22//^S X=FDT;11;Q;"
"RTN","PSOHLD",31,0)
 I RLDT&($P(^PSRX(DA,2),"^",2)="") S DR="22//^S X=RLDTP1;11;Q;"
"RTN","PSOHLD",32,0)
 S DR=DR_"100///0;101///^S X=$S(RXF:$G(ZD(PSDA)),1:$P(^PSRX(PSDA,2),""^"",2))"
"RTN","PSOHLD",33,0)
 ;
"RTN","PSOHLD",34,0)
 D ^DIE K FDT I $D(Y) S VALMBCK="R" D ULP G EX
"RTN","PSOHLD",35,0)
 S COMM="Medication Removed from Hold by Pharmacy" D EN^PSOHLSN1(DA,"OE","",COMM,PSONOOR) K COMM,PSONOOR
"RTN","PSOHLD",36,0)
 S PSORX("FILL DATE")=$S('RXF:$P(^PSRX(DA,2),"^",2),1:ZD(PSDA)) K ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA) S ^PSRX(DA,"H")="" D ACT^PSOHLDA S (NEW1,NEW11)="^^"
"RTN","PSOHLD",37,0)
 S (RXF,RXFL(DA))=0 F JJ=0:0 S JJ=$O(^PSRX(DA,1,JJ)) Q:'JJ  S (RXFL(DA),RXF)=JJ
"RTN","PSOHLD",38,0)
 I $G(PSXSYS) D UNHOLD^PSOCMOPA I $G(XFLAG) D ULP G EX
"RTN","PSOHLD",39,0)
 I $G(DA) D RELC I $G(PSOHRL) D ULP G EX
"RTN","PSOHLD",40,0)
 I PSORX("FILL DATE")>DT,$P(PSOPAR,"^",6) D S^PSORXL,EX,ULP Q
"RTN","PSOHLD",41,0)
 S PCOMH(DA)="Medication Removed from Hold by Pharmacy"
"RTN","PSOHLD",42,0)
 I $G(DA) S RXRH(DA)=DA
"RTN","PSOHLD",43,0)
 I $P($G(^PSRX(DA,2)),"^",15)'="" S $P(^PSRX(DA,2),"^",14)=1,RXRP(DA)=1,$P(RXRP(DA),"^",2)=$P($G(^PSRX(DA,0)),"^",18) ; MARK PRESCRIPTION AND LABEL AS BEING REPRINTED WHEN UNHOLDING A RETURNED TO SOTCK PRESCRIPTION
"RTN","PSOHLD",44,0)
 ;
"RTN","PSOHLD",45,0)
 ; - Submitting Rx to ECME
"RTN","PSOHLD",46,0)
 N ACTION
"RTN","PSOHLD",47,0)
 I $$SUBMIT^PSOBPSUT(DA,+$G(RXFL(DA))) D  I ACTION="Q"!(ACTION="^") D ULP G EX
"RTN","PSOHLD",48,0)
 . N RX,RFL S RX=DA,RFL=+$G(RXFL(DA))
"RTN","PSOHLD",49,0)
 . N DA S ACTION=""
"RTN","PSOHLD",50,0)
 . D ECMESND^PSOBPSU1(RX,RFL,,$S(RFL:"RF",1:"OF"))
"RTN","PSOHLD",51,0)
 . I $$FIND^PSOREJUT(RX,RFL) D
"RTN","PSOHLD",52,0)
 . . S ACTION=$$HDLG^PSOREJU1(RX,RFL,"79,88","ED","IOQ","I")
"RTN","PSOHLD",53,0)
 ;
"RTN","PSOHLD",54,0)
 I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=DA_"," D ULP G EX
"RTN","PSOHLD",55,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSOHLD",56,0)
 I $L(PSORX("PSOL",PSOX2))+$L(DA)<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_DA_","
"RTN","PSOHLD",57,0)
 E  S PSORX("PSOL",PSOX2+1)=DA_","
"RTN","PSOHLD",58,0)
 ; 
"RTN","PSOHLD",59,0)
 D ULP
"RTN","PSOHLD",60,0)
EX D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) D ^PSOBUILD
"RTN","PSOHLD",61,0)
 K PSOHRL,PSOMSG,PSOPLCK,ST,PSL,PSNP,IR,NOW,DR,NEW1,NEW11,RTN,DA,PPL,RXN,RX0,RXS,DIK,RXP,FLD,ACT,DIE,DIC,DIR,DIE,X,Y,DIRUT,DUOUT,SUSPT,C,D0,LFD,I,PSDA,RFDATE,DI,DQ,%,RFN,XFLAG
"RTN","PSOHLD",62,0)
 K HRX,PSHLD,PSOLIST,PSORX("FILL DATE"),STA,QTY,RFDT,PSORX0,PSRXN,RXF,JJ Q
"RTN","PSOHLD",63,0)
 ;
"RTN","PSOHLD",64,0)
HLD ;
"RTN","PSOHLD",65,0)
 I $G(PSOBEDT) W $C(7),$C(7) S VALMSG="Invalid Action at this time !",VALMBCK="" Q
"RTN","PSOHLD",66,0)
 I $G(PSONACT) W $C(7),$C(7) S VALMSG="No Pharmacy Orderable Item !",VALMBCK="" Q
"RTN","PSOHLD",67,0)
 I '$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOHLD",68,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient."),VALMBCK="" K PSOPLCK Q
"RTN","PSOHLD",69,0)
 K PSOPLCK D PSOL^PSSLOCK(DA) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D ULP Q
"RTN","PSOHLD",70,0)
 S Y(0)=^PSRX(DA,0),STA=+$G(^("STA")) I DT>$P(^PSRX(DA,2),"^",6) D  D ULP G D1
"RTN","PSOHLD",71,0)
 .S VALMSG="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"-"_$E($P(^(2),"^",6),6,7)_"-"_$E($P(^(2),"^",6),2,3),VALMBCK="R"
"RTN","PSOHLD",72,0)
 .I $P(^PSRX(DA,"STA"),"^")<11 S $P(^PSRX(DA,"STA"),"^")=11 D
"RTN","PSOHLD",73,0)
 ..S COMM="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"-"_$E($P(^(2),"^",6),6,7)_"-"_$E($P(^(2),"^",6),2,3) D EN^PSOHLSN1(DA,"SC","ZE",COMM) K COMM
"RTN","PSOHLD",74,0)
 S ST=$P("ERROR^ACTIVE^NON-VERIFIED^REFILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^DONE^EXPIRED^DISCONTINUED^DELETED^DISCONTINUED^DISCONTINUED (EDIT)^PROVIDER HOLD^","^",STA+2)
"RTN","PSOHLD",75,0)
 I STA,STA'>4!(STA>11) D  D ULP G D1
"RTN","PSOHLD",76,0)
 .S VALMSG="Rx: "_$P(Y(0),"^")_" is currently in a status of "_ST,VALMBCK="R" K ST,Y Q
"RTN","PSOHLD",77,0)
 D FULL^VALM1 D NOOR I $D(DIRUT) D ULP G D1
"RTN","PSOHLD",78,0)
 D HLD^PSOCMOPA I $G(XFLAG) K XFLAG D ULP G D1
"RTN","PSOHLD",79,0)
 K DIR S DIR("A")=$P(^DD(52,99,0),"^"),DIR(0)="52,99" D ^DIR S FLD(99)=Y I $D(DUOUT)!($D(DIRUT)) K DIRUT,DUOUT,DIR D ULP G D1
"RTN","PSOHLD",80,0)
 I $G(FLD(99))=99 K DIR S DIR("A")=$P(^DD(52,99.1,0),"^"),DIR(0)="52,99.1" D ^DIR S FLD(99.1)=Y G AR
"RTN","PSOHLD",81,0)
 E  K DIR S DIR(0)="FO^10:100",DIR("A")="HOLD COMMENTS" D ^DIR S FLD(99.1)=Y
"RTN","PSOHLD",82,0)
AR I $D(DUOUT)!($D(DTOUT)) K DIRUT,DUOUT,DIR S VALMBCK="R" D ULP G D1
"RTN","PSOHLD",83,0)
 F PI=1:1 Q:$P(PPL,",",PI)=""  S DA=$P(PPL,",",PI) D H S DA=PSDA K PSDA D:$D(PSORX("PSOL")) RMP^PSOHLDA
"RTN","PSOHLD",84,0)
 K PI D ^PSOBUILD
"RTN","PSOHLD",85,0)
 D ULP
"RTN","PSOHLD",86,0)
D1 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) K PSOMSG,PSOPLCK,RFN,DIR,RSDT,FLD,DA,ACT,X,Y,DIRUT,DUOUT,DTOUT,DIROUT
"RTN","PSOHLD",87,0)
 Q
"RTN","PSOHLD",88,0)
 ;
"RTN","PSOHLD",89,0)
H ; - Rx HOLD update
"RTN","PSOHLD",90,0)
 D HOLD^PSOHLDA
"RTN","PSOHLD",91,0)
 Q
"RTN","PSOHLD",92,0)
 ;
"RTN","PSOHLD",93,0)
FLD N DA K DIR S DIR("A")=$P(^DD(52,99,0),"^"),DIR(0)="52,99" D ^DIR Q:$D(DUOUT)!($D(DIRUT))  S FLD(99)=Y
"RTN","PSOHLD",94,0)
 S COMM=Y(0)
"RTN","PSOHLD",95,0)
 I $G(FLD(99))=99 K DIR S DIR("A")=$P(^DD(52,99.1,0),"^"),DIR(0)="52,99.1" D ^DIR Q:$D(DUOUT)!($D(DIRUT))  S (FLD(99.1),COMM)=Y Q
"RTN","PSOHLD",96,0)
 E  S FLD(99.1)=""
"RTN","PSOHLD",97,0)
 Q
"RTN","PSOHLD",98,0)
NOOR ;ask nature of order
"RTN","PSOHLD",99,0)
 K DIR,DTOUT,DTOUT,DIRUT I $T(NA^ORX1)]""  D  Q
"RTN","PSOHLD",100,0)
 .S PSONOOR=$$NA^ORX1("W",0,"B","Nature of Order",0,"WPSDIVR"_$S(+$G(^VA(200,DUZ,"PS")):"E",1:""))
"RTN","PSOHLD",101,0)
 .I +PSONOOR S PSONOOR=$P(PSONOOR,"^",3) Q
"RTN","PSOHLD",102,0)
 .S DIRUT=1 K PSONOOR
"RTN","PSOHLD",103,0)
 S DIR("A")="Nature of Order: ",DIR("B")="WRITTEN"
"RTN","PSOHLD",104,0)
 S DIR(0)="SA^W:WRITTEN;V:VERBAL;P:TELEPHONE;S:SERVICE CORRECTED;D:DUPLICATE;I:POLICY;R:SERVICE REJECTED"_$S(+$G(^VA(200,DUZ,"PS")):";E:PROVIDER ENTERED",1:"")
"RTN","PSOHLD",105,0)
NOORX D ^DIR K DIR,DTOUT,DTOUT Q:$D(DIRUT)  S PSONOOR=Y
"RTN","PSOHLD",106,0)
 Q
"RTN","PSOHLD",107,0)
ULP ;
"RTN","PSOHLD",108,0)
 D UL^PSSLOCK(+$G(PSODFN))
"RTN","PSOHLD",109,0)
 Q
"RTN","PSOHLD",110,0)
RELC ;
"RTN","PSOHLD",111,0)
 S (PSOHRL,PSOHTX)=0  F PSOHT=0:0 S PSOHT=$O(^PSRX(DA,1,PSOHT)) Q:'PSOHT  S:$D(^PSRX(DA,1,PSOHT,0)) PSOHTX=PSOHT
"RTN","PSOHLD",112,0)
 I $G(PSOHTX) S PSOHRL=$S($P($G(^PSRX(DA,1,PSOHTX,0)),"^",18):1,1:0)
"RTN","PSOHLD",113,0)
 I '$G(PSOHTX) S PSOHRL=$S($P($G(^PSRX(DA,2)),"^",13):1,1:0)
"RTN","PSOHLD",114,0)
 K PSOHTX,PSOHT
"RTN","PSOHLD",115,0)
 Q
"RTN","PSOHLDI1")
0^79^B12451392^B12265819
"RTN","PSOHLDI1",1,0)
PSOHLDI1 ;BIR/PWC,SAB - Automated Dispense Completion HL7 v.2.4 cont. ;10/25/06 10:04am
"RTN","PSOHLDI1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**259,268**;DEC 1997;Build 9
"RTN","PSOHLDI1",3,0)
 ;Reference to ^PSD(58.8 supported by DBIA 1036
"RTN","PSOHLDI1",4,0)
 ;Reference to ^XTMP("PSA" supported by DBIA 1036
"RTN","PSOHLDI1",5,0)
 ;This routine is called by PSOHLDIS
"RTN","PSOHLDI1",6,0)
 ;
"RTN","PSOHLDI1",7,0)
 ;*259 create routine to hold DRGACCT, psohldis exceeded 10k, also
"RTN","PSOHLDI1",8,0)
 ;     add MAIL tag for Email Alert to mail group.
"RTN","PSOHLDI1",9,0)
 ;
"RTN","PSOHLDI1",10,0)
 Q
"RTN","PSOHLDI1",11,0)
 ;
"RTN","PSOHLDI1",12,0)
BINGREL ;displays to bingo board
"RTN","PSOHLDI1",13,0)
 N NAM,NAME,RXO,SSN S ADA="",BRXP=RXID
"RTN","PSOHLDI1",14,0)
 F XX=0:0 S XX=$O(^PS(52.11,"B",BNAM,XX)) Q:'XX  D
"RTN","PSOHLDI1",15,0)
 .F BRX=0:0 S BRX=$O(^PS(52.11,XX,2,"B",BRX)) Q:'BRX  I BRX=BRXP S (DA,ODA)=XX
"RTN","PSOHLDI1",16,0)
 Q:'$D(DA)
"RTN","PSOHLDI1",17,0)
 I $P($G(^PS(52.11,DA,0)),"^",7)]"" Q
"RTN","PSOHLDI1",18,0)
 I $P($P($G(^PS(52.11,DA,0)),"^",5),".")'=DT S DIK="^PS(52.11," D ^DIK K DIK Q
"RTN","PSOHLDI1",19,0)
 N TM,TM1 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2)
"RTN","PSOHLDI1",20,0)
 S NM=$P(^DPT($P(^PS(52.11,DA,0),"^"),0),"^"),DR="6////"_$E(TM1_"0000",1,4)_";8////"_NM_"",DIE="^PS(52.11,"
"RTN","PSOHLDI1",21,0)
 L +^PS(52.11,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) E  Q
"RTN","PSOHLDI1",22,0)
 D ^DIE L -^PS(52.11,DA) I $G(X)="" S DIK="^PS(52.11," D ^DIK K DIK Q
"RTN","PSOHLDI1",23,0)
 S RX0=^PS(52.11,DA,0),JOES=$P(RX0,"^",4),TICK=+$P($G(RX0),"^",2),GRP=$P($G(^PS(59.3,$P($G(^PS(52.11,DA,0)),"^",3),0)),"^",2)
"RTN","PSOHLDI1",24,0)
 I GRP="T",'$G(TICK) S DIK="^PS(52.11," D ^DIK K DIK
"RTN","PSOHLDI1",25,0)
 Q:'$G(DA)
"RTN","PSOHLDI1",26,0)
 S PSZ=0 I '$D(^PS(59.2,DT,0)) K DD,DIC,DO,DA S X=DT,DIC="^PS(59.2,",DIC(0)="",DINUM=X D FILE^DICN S PSZ=1 Q:Y'>0 
"RTN","PSOHLDI1",27,0)
 I PSZ=1 S DA(1)=+Y,DIC=DIC_DA(1)_",1,",(DINUM,X)=JOES,DIC(0)="",DIC("P")=$P(^DD(59.2,1,0),"^",2) K DD,DO D FILE^DICN K DIC,DA Q:Y'>0
"RTN","PSOHLDI1",28,0)
 I PSZ=0 K DD,DIC,DO,DA S DA(1)=DT,(DINUM,X)=JOES,DIC="^PS(59.2,"_DT_",1,",DIC(0)="LZ" D FILE^DICN K DIC,DA,DO
"RTN","PSOHLDI1",29,0)
 S DA=ODA D STATS1^PSOBRPRT,WTIME^PSOBING1
"RTN","PSOHLDI1",30,0)
 Q
"RTN","PSOHLDI1",31,0)
 ;
"RTN","PSOHLDI1",32,0)
DRGACCT(RXP) ;update Drug Accountability Package                      ;PSO*209
"RTN","PSOHLDI1",33,0)
 S RXP=+$G(RXP) Q:'RXP
"RTN","PSOHLDI1",34,0)
 N PSA,DIC,DA,DR,X,Y,DIQ,PSODA,PSOSITE,QDRUG,QTY,JOB192
"RTN","PSOHLDI1",35,0)
 S (JOB192,PSODA)=0
"RTN","PSOHLDI1",36,0)
 ;check for Drug Acct background job
"RTN","PSOHLDI1",37,0)
 S X="PSA IV ALL LOCATIONS",DIC(0)="MZ",DIC=19.2 D ^DIC S JOB192=Y
"RTN","PSOHLDI1",38,0)
 I JOB192>0,$P($G(Y(0)),U,2)>DT D
"RTN","PSOHLDI1",39,0)
 . S PSODA=1
"RTN","PSOHLDI1",40,0)
 . S:'$P($G(^XTMP("PSA",0)),U,2) $P(^(0),U,2)=DT
"RTN","PSOHLDI1",41,0)
 I JOB192'>0 D             ;check old way of scheduling
"RTN","PSOHLDI1",42,0)
 . S X="PSA IV ALL LOCATIONS",DIC(0)="MZ",DIC=19 D ^DIC
"RTN","PSOHLDI1",43,0)
 . K DIQ,PSA S DA=+Y,DIC=19,DIQ="PSA",DR=200,DIQ(0)="IN" D EN^DIQ1
"RTN","PSOHLDI1",44,0)
 . I $G(PSA(19,DA,200,"I"))>DT D
"RTN","PSOHLDI1",45,0)
 . . S PSODA=1
"RTN","PSOHLDI1",46,0)
 . . S:'$P($G(^XTMP("PSA",0)),U,2) $P(^(0),U,2)=DT
"RTN","PSOHLDI1",47,0)
 ;drug stocked in Drug Acct Location?
"RTN","PSOHLDI1",48,0)
 S PSOSITE=+$O(^PS(59,0))
"RTN","PSOHLDI1",49,0)
 S PSODA(1)=$S($D(^PSD(58.8,+$O(^PSD(58.8,"AOP",PSOSITE,0)),1,+$P(^PSRX(RXP,0),U,6))):1,1:0)
"RTN","PSOHLDI1",50,0)
 ;if appropriate update ^XTMP("PSA", for Drug Acct
"RTN","PSOHLDI1",51,0)
 S QTY=$P($G(^PSRX(RXP,0)),"^",7)
"RTN","PSOHLDI1",52,0)
 S QDRUG=+$P($G(^PSRX(RXP,0)),"^",6)
"RTN","PSOHLDI1",53,0)
 Q:'QDRUG
"RTN","PSOHLDI1",54,0)
 I $G(PSODA),$G(PSODA(1)),'$D(^PSRX("AR",$$NOW^XLFDT,RXP,0)) S ^XTMP("PSA",PSOSITE,QDRUG,DT)=$G(^XTMP("PSA",PSOSITE,QDRUG,DT))+QTY
"RTN","PSOHLDI1",55,0)
 Q
"RTN","PSOHLDI1",56,0)
 ;
"RTN","PSOHLDI1",57,0)
MAIL ;Send mail message
"RTN","PSOHLDI1",58,0)
 S:'$G(DUZ) DUZ=.5
"RTN","PSOHLDI1",59,0)
 N PSOTTEXT,PSOIEN,PSOKEYN,XMY,XMDUZ,XMSUB,XMTEXT
"RTN","PSOHLDI1",60,0)
 S XMY("G.PSO EXTERNAL DISPENSE ALERTS")=""
"RTN","PSOHLDI1",61,0)
 ;if no members in group, then send to PSXCMOPMGR key holders
"RTN","PSOHLDI1",62,0)
 S PSOIEN=$O(^XMB(3.8,"B","PSO EXTERNAL DISPENSE ALERTS",0))
"RTN","PSOHLDI1",63,0)
 I '$O(^XMB(3.8,PSOIEN,1,0)) D
"RTN","PSOHLDI1",64,0)
 . S PSOKEYN=0
"RTN","PSOHLDI1",65,0)
 . F  S PSOKEYN=$O(^XUSEC("PSXCMOPMGR",PSOKEYN)) Q:'PSOKEYN  D
"RTN","PSOHLDI1",66,0)
 . . S XMY(PSOKEYN)=""
"RTN","PSOHLDI1",67,0)
 S XMDUZ="PSO EXTERNAL DISPENSE"
"RTN","PSOHLDI1",68,0)
 S XMSUB="External Dispense - Rx Release Attempted"
"RTN","PSOHLDI1",69,0)
 S PSOTTEXT(1)="Patient: "_NAME_"   SSN: "_PSSN
"RTN","PSOHLDI1",70,0)
 S PSOTTEXT(2)="   Rx #: "_PSORX_"   Fill: "_FLLN
"RTN","PSOHLDI1",71,0)
 S PSOTTEXT(3)="   Drug: "_$P(GIVECOD,"~",2)
"RTN","PSOHLDI1",72,0)
 S PSOTTEXT(4)=""
"RTN","PSOHLDI1",73,0)
 S PSOTTEXT(5)=ATXT
"RTN","PSOHLDI1",74,0)
 S PSOTTEXT(6)=""
"RTN","PSOHLDI1",75,0)
 S:ACTN]"" PSOTTEXT(7)=ACTN
"RTN","PSOHLDI1",76,0)
 S XMTEXT="PSOTTEXT(" D ^XMD
"RTN","PSOHLDI1",77,0)
 Q
"RTN","PSOHLDS2")
0^81^B67611416^B62771501
"RTN","PSOHLDS2",1,0)
PSOHLDS2 ;BHAM ISC/PWC,SAB-Build HL7 Segments for automated interface ;11/22/06 3:24pm
"RTN","PSOHLDS2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,198,255,200,268**;DEC 1997;Build 9
"RTN","PSOHLDS2",3,0)
 ;DIWP supported by DBIA 10011
"RTN","PSOHLDS2",4,0)
 ;^PS(50.606 supported by DBIA 2174
"RTN","PSOHLDS2",5,0)
 ;^PS(50.7 supported by DBIA #2223
"RTN","PSOHLDS2",6,0)
 ;^PS(51 supported by DBIA 2224
"RTN","PSOHLDS2",7,0)
 ;^PS(51.2 supported by DBIA 2226
"RTN","PSOHLDS2",8,0)
 ;^PS(55 supported by DBIA 2228
"RTN","PSOHLDS2",9,0)
 ;^PSDRUG supported by DBIA 221
"RTN","PSOHLDS2",10,0)
 ;^PS(54 supported by DBIA 2227
"RTN","PSOHLDS2",11,0)
 ;Cont'd build HL7 segments
"RTN","PSOHLDS2",12,0)
 ;
"RTN","PSOHLDS2",13,0)
 ;*198 add check to insert spaces into PMI segments
"RTN","PSOHLDS2",14,0)
 ;*255 add 2 new fields to RXE.21 (label name & VA PRINT NAME)
"RTN","PSOHLDS2",15,0)
 ;     and move NTEPMI tag to PSOHLDS4
"RTN","PSOHLDS2",16,0)
 ;
"RTN","PSOHLDS2",17,0)
RXE(PSI) ;pharmacy encoded order segment
"RTN","PSOHLDS2",18,0)
 Q:'$D(DFN)  N RXE S RXE="" S $P(RXE,"|",1)=""""""
"RTN","PSOHLDS2",19,0)
 S $P(RXE,"|",2)=$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_$G(PSND2)_CS_"99PSNDF"_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",20,0)
 S $P(RXE,"|",3)="" I $G(PSOXN)="" S PSOXN=""""""
"RTN","PSOHLDS2",21,0)
 S $P(RXE,"|",5)=PSOXN_CS_$S($G(UNIT)'="":$G(UNIT),1:"""""")_CS_"99PSU"
"RTN","PSOHLDS2",22,0)
 S POIPTR=$P($G(^PSRX(IRXN,"OR1")),"^") I POIPTR S PODOSE=$P($G(^PS(50.7,POIPTR,0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",23,0)
 I '$G(POIPTR) S PODOSE=$P($G(^PS(50.7,$P($G(^PSDRUG(IDGN,2)),"^"),0)),"^",2),PODOSENM=$P($G(^PS(50.606,PODOSE,0)),"^")
"RTN","PSOHLDS2",24,0)
 S TRADENM=$G(^PSRX(IRXN,"TN")),$P(RXE,"|",6)=PODOSE_CS_PODOSENM_CS_"99PSF"
"RTN","PSOHLDS2",25,0)
 S $P(RXE,"|",8)=MP,$P(RXE,"|",9)=TRADENM,$P(RXE,"|",10)=QTY
"RTN","PSOHLDS2",26,0)
 S $P(RXE,"|",11)=CS_$P($G(^PSDRUG(IDGN,660)),"^",8),$P(RXE,"|",12)=NRFL
"RTN","PSOHLDS2",27,0)
 S $P(RXE,"|",13)=DEAID,$P(RXE,"|",14)=VPHARMID_CS_$P(VPHARM,",",1)_CS_$P(VPHARM,",",2)
"RTN","PSOHLDS2",28,0)
 S $P(RXE,"|",15)=$P(^PSRX(IRXN,0),"^"),$P(RXE,"|",16)=RFRM,$P(RXE,"|",17)=NFLD
"RTN","PSOHLDS2",29,0)
 S $P(RXE,"|",18)=PRIORDT,$P(RXE,"|",31)=CSUB_RS_SCTALK_RS_OTLAN
"RTN","PSOHLDS2",30,0)
 S $P(RXE,"|",21)=CS_DRUG_RS_CS_$G(VANAME)                       ;*255
"RTN","PSOHLDS2",31,0)
 S ^TMP("PSO",$J,PSI)="RXE|"_RXE,PSI=PSI+1
"RTN","PSOHLDS2",32,0)
 K PODOSE,PODOSENM,POIPTR,TRADENM,UU
"RTN","PSOHLDS2",33,0)
 Q
"RTN","PSOHLDS2",34,0)
RXD(PSI) ;pharmacy dispense segment
"RTN","PSOHLDS2",35,0)
 Q:'$D(DFN)  N RXD,I
"RTN","PSOHLDS2",36,0)
 S WNS="" I $G(WARN) F I=1:1 S WW=$P(WARN,",",I) Q:WW=""  S WNS=WNS_WW_CS_$S(WW'["N":^PS(54,WW,0),1:"")_RS
"RTN","PSOHLDS2",37,0)
 S RXD="RXD"_FS_$S($G(NFLD):NFLD,1:0)_FS_$S($P($G(^PSDRUG(IDGN,"ND")),"^",10)'="":$P(^("ND"),"^",10),($G(PSND1)&$G(PSND3)):$P($G(PSOXN2),"^",2),1:"""""")_CS_PSND2_CS_"99PSNDF"
"RTN","PSOHLDS2",38,0)
 S RXD=RXD_CS_PSND1_"."_PSND3_"."_$G(IDGN)_CS_$P($G(^PSDRUG(IDGN,0)),"^")_CS_"99PSD"
"RTN","PSOHLDS2",39,0)
 S RXD=RXD_FS_DISPDT_FS_FS_FS_FS_$P(^PSRX(IRXN,0),"^")_FS_NRFL
"RTN","PSOHLDS2",40,0)
 S RXD=RXD_FS_DEA_RS_PSONDC_FS_$S(FIN'="":FIN_CS_FIN1,1:"")_FS
"RTN","PSOHLDS2",41,0)
 S RXD=RXD_FS_DASPLY_FS_MW_FS_FS_CS_$S($G(CAP):"NON-SAFETY",1:"SAFETY")
"RTN","PSOHLDS2",42,0)
 S RXD=RXD_FS_FS_FS_FS_EXDT_FS_FS_FS_FS_FS_FS_WNS_FS_FS
"RTN","PSOHLDS2",43,0)
 S ^TMP("PSO",$J,PSI)=RXD,PSI=PSI+1
"RTN","PSOHLDS2",44,0)
 Q
"RTN","PSOHLDS2",45,0)
RXR(PSI) ;pharmacy route segment
"RTN","PSOHLDS2",46,0)
 Q:'$D(DFN)  N RXR S (PSROUTE,RTNAME)=""""""
"RTN","PSOHLDS2",47,0)
 F PSRTLP=0:0 S PSRTLP=$O(^PSRX(IRXN,6,PSRTLP)) Q:'PSRTLP  D
"RTN","PSOHLDS2",48,0)
 .S PSROUTE=$P($G(^PSRX(IRXN,6,PSRTLP,0)),"^",7)
"RTN","PSOHLDS2",49,0)
 .I PSROUTE,$D(^PS(51.2,PSROUTE,0))  S RTNAME=$P(^PS(51.2,PSROUTE,0),"^")
"RTN","PSOHLDS2",50,0)
 I RTNAME="" K PSROUTE,RTNAME,PSRTLP Q
"RTN","PSOHLDS2",51,0)
 S RXR="RXR"_FS_$G(PSROUTE)_CS_$G(RTNAME)_CS_"99PSR"_FS_FS_FS_FS
"RTN","PSOHLDS2",52,0)
 S ^TMP("PSO",$J,PSI)=RXR,PSI=PSI+1
"RTN","PSOHLDS2",53,0)
 K PSROUTE,RTNAME,PSRTLP
"RTN","PSOHLDS2",54,0)
 Q
"RTN","PSOHLDS2",55,0)
SIG K OT S SGY="" F P=1:1:$L(SIG," ") S X=$P(SIG," ",P) D:X]""
"RTN","PSOHLDS2",56,0)
 .I $D(^PS(51,"A",X)) D
"RTN","PSOHLDS2",57,0)
 ..I $P($G(^PS(55,DFN,"LAN")),"^") S OT=$O(^PS(51,"B",X,0)) I OT,$P($G(^PS(51,OT,4)),"^")]"" S X=$P(^PS(51,OT,4),"^") K OT Q
"RTN","PSOHLDS2",58,0)
 ..;S %=^PS(51,"A",X),X=$P(%,"^") I $P(%,"^",2)]"" S Y=$P(SIG," ",P-1),Y=$E(Y,$L(Y)) S:Y>1 X=$P(%,"^",2)
"RTN","PSOHLDS2",59,0)
 .S SGY=SGY_X_" "
"RTN","PSOHLDS2",60,0)
 S X="",SGC=1 F J=1:1 S Z=$P(SGY," ",J) S:Z="" SGY(SGC)=X Q:Z=""  S:$L(X)+$L(Z)'<$S($P(PSOPAR,"^",28):46,1:34) SGY(SGC)=X,SGC=SGC+1,X="" S X=X_Z_" "
"RTN","PSOHLDS2",61,0)
SIGOLD I '$P(PSOPAR,"^",28) D  K NHC
"RTN","PSOHLDS2",62,0)
 .K DIC,DR,DIQ,NHC S DIC=2,DA=DFN,DR=148,DIQ="NHC",DIQ(0)="I"
"RTN","PSOHLDS2",63,0)
 .D EN^DIQ1 K DIC,DR,DIQ
"RTN","PSOHLDS2",64,0)
 .I NHC(2,DFN,148,"I")="Y"!($P($G(^PS(55,DFN,40)),"^")) S SGC=SGC+1,SGY(SGC)="Expiration:________ Mfg:_________"
"RTN","PSOHLDS2",65,0)
 Q
"RTN","PSOHLDS2",66,0)
 ;
"RTN","PSOHLDS2",67,0)
PSOLBL3 ;RX must be defined (Internal), Check already done for OERR SIG
"RTN","PSOHLDS2",68,0)
 ;Format OERR Sig for New and Old label stock
"RTN","PSOHLDS2",69,0)
 N CTCT,FFFF,LLIM,LLLL,LVAR,LVAR1,PPP,PPPP,SGCT,SIG9,ZZZZ,PSLONG,PPPP
"RTN","PSOHLDS2",70,0)
 S RX=IRXN
"RTN","PSOHLDS2",71,0)
 I $P($G(^PS(55,DFN,"LAN")),"^") N II D OTHL^PSOLBL3 G:$G(FND) FMSIG
"RTN","PSOHLDS2",72,0)
 S PSLONG=$S($P(PSOPAR,"^",28):46,1:34)
"RTN","PSOHLDS2",73,0)
 ; NEXT LINE IF SIG IS MOVED BACK TO MULTIPLE
"RTN","PSOHLDS2",74,0)
 S PPPP=1 F PPP=0:0 S PPP=$O(^PSRX(RX,"SIG1",PPP)) Q:'PPP  I $G(^PSRX(RX,"SIG1",PPP,0))'="" S SIG9(PPPP)=^(0) S PPPP=PPPP+1
"RTN","PSOHLDS2",75,0)
 ;NEXT LINE IF 1ST FRONT DOOR SIG LINE LIVES IN BACK DOOR SPOT
"RTN","PSOHLDS2",76,0)
FMSIG S (LVAR,LVAR1)="",LLLL=1
"RTN","PSOHLDS2",77,0)
 F FFFF=0:0 S FFFF=$O(SIG9(FFFF)) Q:'FFFF  S SGCT=0 F ZZZZ=1:1:$L(SIG9(FFFF)) I $E(SIG9(FFFF),ZZZZ)=" "!($L(SIG9(FFFF))=ZZZZ) S SGCT=SGCT+1 D  I $L(LVAR)>PSLONG S SGY(LLLL)=LLIM_" ",LLLL=LLLL+1,LVAR=LVAR1
"RTN","PSOHLDS2",78,0)
 .S LVAR1=$P(SIG9(FFFF)," ",(SGCT)),LLIM=LVAR,LVAR=$S(LVAR="":LVAR1,1:LVAR_" "_LVAR1)
"RTN","PSOHLDS2",79,0)
 I $G(LVAR)'="" S SGY(LLLL)=LVAR
"RTN","PSOHLDS2",80,0)
 I '$P(PSOPAR,"^",28) S SGC=0 F CTCT=0:0 S CTCT=$O(SGY(CTCT)) Q:'CTCT  S SGC=SGC+1
"RTN","PSOHLDS2",81,0)
 I $O(OSGY(0)) D
"RTN","PSOHLDS2",82,0)
 .F I=0:0 S I=$O(SGY(I)) Q:'I  I $G(OSGY(I))']"" S OSGY(I)=" "
"RTN","PSOHLDS2",83,0)
 .F I=0:0 S I=$O(OSGY(I)) Q:'I  I $G(SGY(I))']"" S SGY(I)=" "
"RTN","PSOHLDS2",84,0)
 Q
"RTN","PSOHLDS2",85,0)
NTE ;build NTE segment for SIG
"RTN","PSOHLDS2",86,0)
 ;
"RTN","PSOHLDS2",87,0)
 Q:'$D(DFN)
"RTN","PSOHLDS2",88,0)
 ; 1 = SIG
"RTN","PSOHLDS2",89,0)
 ; 2 = PI Narrative
"RTN","PSOHLDS2",90,0)
 ; 3 = Drug Warning
"RTN","PSOHLDS2",91,0)
 ; 4 = Profile
"RTN","PSOHLDS2",92,0)
 ; 5 = Drug Interaction
"RTN","PSOHLDS2",93,0)
 ; 6 = Drug Allergy
"RTN","PSOHLDS2",94,0)
 ;
"RTN","PSOHLDS2",95,0)
 K FLDX
"RTN","PSOHLDS2",96,0)
 D NTE1(.PSI) K FLDX D NTE2(.PSI) K FLDX D NTE3(.PSI) K FLDX
"RTN","PSOHLDS2",97,0)
 D NTE4(.PSI) K FLDX D NTE5(.PSI) K FLDX D NTE6(.PSI) K FLDX
"RTN","PSOHLDS2",98,0)
 Q
"RTN","PSOHLDS2",99,0)
 ;
"RTN","PSOHLDS2",100,0)
NTE1(PSI) ;SIG
"RTN","PSOHLDS2",101,0)
 S SIG=$P($G(^PSRX(IRXN,"SIG")),"^")
"RTN","PSOHLDS2",102,0)
 I $P($G(^PSRX(IRXN,"SIG")),"^",2) D PSOLBL3,SIGOLD
"RTN","PSOHLDS2",103,0)
 I '$P($G(^PSRX(IRXN,"SIG")),"^",2) D SIG
"RTN","PSOHLDS2",104,0)
 I $O(OSGY(0)) D  G KNTE
"RTN","PSOHLDS2",105,0)
 .K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",106,0)
 .S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions (LANGUAGE PREFERENCE)"
"RTN","PSOHLDS2",107,0)
 .K DRR F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",108,0)
 .S DRR=DRR+1,OSGY(DRR)=FS_"Medication Instructions (ENGLISH)"
"RTN","PSOHLDS2",109,0)
 .K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",110,0)
 .S CLD=1 F DR=0:0 S DR=$O(OSGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",111,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_OSGY(DR)
"RTN","PSOHLDS2",112,0)
 .S PSI=PSI+1,^TMP("PSO",$J,PSI)="NTE"_FS_8_FS_FS
"RTN","PSOHLDS2",113,0)
 .S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",114,0)
 ..S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",115,0)
 K DRR F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  S DRR=$G(DRR)+1
"RTN","PSOHLDS2",116,0)
 S DRR=DRR+1,SGY(DRR)=FS_"Medication Instructions"
"RTN","PSOHLDS2",117,0)
 K DRR S ^TMP("PSO",$J,PSI)="NTE"_FS_1_FS_FS
"RTN","PSOHLDS2",118,0)
 S CLD=1 F DR=0:0 S DR=$O(SGY(DR)) Q:'DR  D
"RTN","PSOHLDS2",119,0)
 .S:$L($G(^TMP("PSO",$J,PSI,CLD))_SGY(DR))>245 CLD=CLD+1 S ^TMP("PSO",$J,PSI,CLD)=$G(^TMP("PSO",$J,PSI,CLD))_SGY(DR)
"RTN","PSOHLDS2",120,0)
KNTE S PSI=PSI+1 K DR,CLD,DRR,SIG,E,F,S,FLD1,X,Y,SGY,SGC,Z,DR,%,J,P,NT1,ST,EN,LTH
"RTN","PSOHLDS2",121,0)
 Q
"RTN","PSOHLDS2",122,0)
LENGTH(NT1) ; compensate for length > 245
"RTN","PSOHLDS2",123,0)
 I $L(NT1)>245 S LTH=$E($L(NT1)/245,1) S:$L(NT1)#245>0 LTH=LTH+1 F WW=1:1:LTH D
"RTN","PSOHLDS2",124,0)
 . S:WW=1 ST=1,EN=245 S:WW>1 ST=(ST+245),EN=(EN+245) S NT11=$E(NT1,ST,EN)
"RTN","PSOHLDS2",125,0)
 . S:WW=1 ^TMP("PSO",$J,PSI)=NT11 S:WW>1 ^TMP("PSO",$J,PSI,WW-1)=NT11
"RTN","PSOHLDS2",126,0)
 S:'$D(LTH) ^TMP("PSO",$J,PSI)=NT1 S PSI=PSI+1
"RTN","PSOHLDS2",127,0)
 Q
"RTN","PSOHLDS2",128,0)
NTE2(PSI) ; Patient Narrative
"RTN","PSOHLDS2",129,0)
 K ^UTILITY($J,"W") S (DIWL,PSNACNT)=1,DIWR=45,DIWF="",(PSSIXFL,PSSEVFL)=0 F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,6,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",130,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSIXFL=1
"RTN","PSOHLDS2",131,0)
 I PSSIXFL S ^TMP("PSO",$J,PSI)="NTE"_FS_2_FS_FS,^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1,FLDX=1
"RTN","PSOHLDS2",132,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,7,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",133,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1,PSSEVFL=1
"RTN","PSOHLDS2",134,0)
 I PSSEVFL S ^TMP("PSO",$J,PSI,PSNACNT)=" " S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",135,0)
 S DIWL=1,DIWR=45,DIWF="" K ^UTILITY($J,"W") F ZZ=0:0 S ZZ=$O(^PS(59,PSOSITE,4,ZZ)) Q:'ZZ  I $D(^(ZZ,0)) S X=^(0) D ^DIWP
"RTN","PSOHLDS2",136,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"W",DIWL,LLL)) Q:'LLL  S ^TMP("PSO",$J,PSI,PSNACNT)=^UTILITY($J,"W",DIWL,LLL,0) S PSNACNT=PSNACNT+1
"RTN","PSOHLDS2",137,0)
 S:$D(FLDX) ^TMP("PSO",$J,PSI,PSNACNT-1)=^TMP("PSO",$J,PSI,PSNACNT-1)_FS_"Patient Narrative",PSI=PSI+1
"RTN","PSOHLDS2",138,0)
 K DIWF,DIWL,DIWR,LLL,PSNACNT,PSSEVFL,PSSIXFL,ZZ
"RTN","PSOHLDS2",139,0)
 Q
"RTN","PSOHLDS2",140,0)
NTE3(PSI) ;Drug Warning Narrative
"RTN","PSOHLDS2",141,0)
 N NTE3,J,TEXT,W,CNT,PSSWSITE
"RTN","PSOHLDS2",142,0)
 S WARN=$P($G(^PSDRUG(IDGN,0)),"^",8)
"RTN","PSOHLDS2",143,0)
 S PSSWSITE=+$O(^PS(59.7,0))
"RTN","PSOHLDS2",144,0)
 I $P($G(^PS(59.7,PSSWSITE,10)),"^",11)="N" D
"RTN","PSOHLDS2",145,0)
 .S WARN=$$DRUG^PSSWRNA(IDGN,DFN)
"RTN","PSOHLDS2",146,0)
 I WARN="" Q
"RTN","PSOHLDS2",147,0)
 S NTE3="NTE"_FS_3_FS_FS,^TMP("PSO",$J,PSI)=NTE3,CNT=1
"RTN","PSOHLDS2",148,0)
 F J=1:1:5 S W=$P(WARN,",",J) Q:W=""  D
"RTN","PSOHLDS2",149,0)
 . S TEXT=$$WTEXT^PSSWRNA(W,$G(OLAN)) I TEXT'="" S FLDX=1 D
"RTN","PSOHLDS2",150,0)
 . . I $L(TEXT)<245 S ^TMP("PSO",$J,PSI,CNT)=TEXT,CNT=CNT+1 Q
"RTN","PSOHLDS2",151,0)
 . . N LTH,ST,EN,TXT,WW
"RTN","PSOHLDS2",152,0)
 . . S LTH=$E($L(TEXT)/245,1) S:$L(TEXT)#245>0 LTH=LTH+1
"RTN","PSOHLDS2",153,0)
 . . F WW=1:1:LTH D
"RTN","PSOHLDS2",154,0)
 . . . S:WW=1 ST=1,EN=245 S:WW>1 ST=(ST+245),EN=(EN+245) S TXT=$E(TEXT,ST,EN)
"RTN","PSOHLDS2",155,0)
 . . . S ^TMP("PSO",$J,PSI,CNT)=TXT,CNT=CNT+1
"RTN","PSOHLDS2",156,0)
 I $G(FLDX) D  S PSI=PSI+1
"RTN","PSOHLDS2",157,0)
 . I $L(^TMP("PSO",$J,PSI,CNT-1)_FS_"Drug Warning Narrative")<245 S ^TMP("PSO",$J,PSI,CNT-1)=$G(^TMP("PSO",$J,PSI,CNT-1))_FS_"Drug Warning Narrative"
"RTN","PSOHLDS2",158,0)
 . E  S ^TMP("PSO",$J,PSI,CNT)=FS_"Drug Warning Narrative"
"RTN","PSOHLDS2",159,0)
 Q
"RTN","PSOHLDS2",160,0)
NTE4(PSI) ;Profile information
"RTN","PSOHLDS2",161,0)
 S PSODFN=DFN N NTE4
"RTN","PSOHLDS2",162,0)
 I $P(PSOPAR,"^",8) D START^PSOHLDS3
"RTN","PSOHLDS2",163,0)
 S:$D(NTE4) PSI=PSI+1
"RTN","PSOHLDS2",164,0)
 Q
"RTN","PSOHLDS2",165,0)
NTE5(PSI) ;Drug Interactions
"RTN","PSOHLDS2",166,0)
 N NTE5 D:$D(DRI) START2^PSOHLDS3
"RTN","PSOHLDS2",167,0)
 S:$D(NTE5) ^TMP("PSO",$J,PSI)=NTE5_FS_"Drug Interactions",PSI=PSI+1
"RTN","PSOHLDS2",168,0)
 Q
"RTN","PSOHLDS2",169,0)
NTE6(PSI) ;Drug Allergy Indications
"RTN","PSOHLDS2",170,0)
 N NTE6
"RTN","PSOHLDS2",171,0)
 Q:'$G(DAW)
"RTN","PSOHLDS2",172,0)
 D START3^PSOHLDS3
"RTN","PSOHLDS2",173,0)
 Q:NTE6=""
"RTN","PSOHLDS2",174,0)
 S ^TMP("PSO",$J,PSI)=NTE6_FS_"Drug Allergy Indications",PSI=PSI+1
"RTN","PSOHLDS2",175,0)
 Q
"RTN","PSOLLLHN")
0^80^B9172755^B9199678
"RTN","PSOLLLHN",1,0)
PSOLLLHN ;BIR/SJA - HIPAA/NCPDP LASER LABELS ;2/21/07 10:21am
"RTN","PSOLLLHN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**200,268**;DEC 1997;Build 9
"RTN","PSOLLLHN",3,0)
 ;
"RTN","PSOLLLHN",4,0)
 ;*244 ignore Rx status > 11
"RTN","PSOLLLHN",5,0)
 ;
"RTN","PSOLLLHN",6,0)
ST ; ENTRY POINT TO SPEED SIGNATURE LOG REPRINT
"RTN","PSOLLLHN",7,0)
 I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) Q
"RTN","PSOLLLHN",8,0)
 N REPRINT,PS,STATE,PS2,PSOHZIP,PSODISP,PSOOELSE,PSOIEN,VALMCNT
"RTN","PSOLLLHN",9,0)
 S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOLLLHN",10,0)
 S PS2=$P(PS,"^")_"^"_$P(PS,"^",6)
"RTN","PSOLLLHN",11,0)
 I $P(PSOSYS,"^",4),$D(^PS(59,+$P($G(PSOSYS),"^",4),0)) S PS=^PS(59,$P($G(PSOSYS),"^",4),0)
"RTN","PSOLLLHN",12,0)
 S VAADDR1=$P(PS,"^"),VASTREET=$P(PS,"^",2),STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLLHN",13,0)
 S PSZIP=$P(PS,"^",5),PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLLLHN",14,0)
 D 6^VADPT,PID^VADPT6 S SSNP=$G(VA("BID"))
"RTN","PSOLLLHN",15,0)
 S REPRINT=1
"RTN","PSOLLLHN",16,0)
 I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!" S VALMBCK="" Q
"RTN","PSOLLLHN",17,0)
OS K DIR,DUOUT,DIRUT S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR S LST=Y I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" Q
"RTN","PSOLLLHN",18,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,PSOREPX I '+LST D KILL S VALMBCK="" Q
"RTN","PSOLLLHN",19,0)
 S PSOOELSE=1 D FULL^VALM1
"RTN","PSOLLLHN",20,0)
Q1 K POP,ZTSK S %ZIS("B")="",%ZIS="MNQ",%ZIS("A")="Select LABEL DEVICE: " D ^%ZIS S PSLION=ION K %ZIS("A")
"RTN","PSOLLLHN",21,0)
 I $G(POP) S VALMBCK="R",VALMSG="No Labels Reprinted." Q
"RTN","PSOLLLHN",22,0)
 I $G(IOST(0)),'$D(^%ZIS(2,IOST(0),55,"B","LL")) W !,"Must specify a laser labels printer for Signature Log Reprint" G Q1
"RTN","PSOLLLHN",23,0)
 I '$G(IOST(0)) S VALMBCK="R",VALMSG="Nothing queued to print." Q
"RTN","PSOLLLHN",24,0)
 D DEM^VADPT S PNM=VADM(1)
"RTN","PSOLLLHN",25,0)
 I $P(VADM(6),"^",2)]"" D  G OS
"RTN","PSOLLLHN",26,0)
 .W $C(7),!!,PNM_" Died "_$P(VADM(6),"^",2)_".",!
"RTN","PSOLLLHN",27,0)
 S PPL="" F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD),PSOIEN=$P(PSOLST(ORN),"^",2) D
"RTN","PSOLLLHN",28,0)
 .I '$P($G(^PSRX(PSOIEN,0)),"^",2)!($G(^("STA"),"^")>11) Q
"RTN","PSOLLLHN",29,0)
 .I $P($G(^PSRX(PSOIEN,0)),"^",2) S PPL=$S(PPL:PPL_",",1:"")_PSOIEN
"RTN","PSOLLLHN",30,0)
 .S VALMBCK="R"
"RTN","PSOLLLHN",31,0)
 I +PPL D QUEUE W:$D(ZTSK) !!,"Signature Log Reprint queued",!! H 1
"RTN","PSOLLLHN",32,0)
 I '$G(PSOOELSE) S VALMBCK=""
"RTN","PSOLLLHN",33,0)
 D ^PSOBUILD
"RTN","PSOLLLHN",34,0)
 D KILL D KVA^VADPT
"RTN","PSOLLLHN",35,0)
 Q
"RTN","PSOLLLHN",36,0)
QUEUE D NOW^%DTC S Y=$P(%,"."),PSOFNOW=% X ^DD("DD") S PSONOW=Y
"RTN","PSOLLLHN",37,0)
 F G="PPL","REPRINT","PNM","STATE","PS2","PSOHZIP","PSOPAR","PSOSITE","PS","PSONOW","PSOSYS","RX","SSNP" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOLLLHN",38,0)
 S ZTRTN="DQ^PSOLLLH",ZTIO=PSLION,ZTDESC="Outpatient Pharmacy Signature Log Reprint",ZTDTH=$H,PDUZ=DUZ
"RTN","PSOLLLHN",39,0)
 D ^%ZISC,^%ZTLOAD K G
"RTN","PSOLLLHN",40,0)
 Q
"RTN","PSOLLLHN",41,0)
 ;
"RTN","PSOLLLHN",42,0)
KILL ; CLEAN UP VARIABLES
"RTN","PSOLLLHN",43,0)
 K DIC,LST,ORD,ORN,PSOIEN,PNM,PPL,PSZIP,RX,SSNP,VA,VADDR1,VADM,VAEL,VAPA,VASTREET
"RTN","PSOLLLHN",44,0)
 Q
"RTN","PSOLMPAT")
0^35^B3240520^B2889666
"RTN","PSOLMPAT",1,0)
PSOLMPAT ;BHAM ISC/SAB - update pharmacy patient data using listman ;03/08/93 8:35
"RTN","PSOLMPAT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,117,149,233,268**;DEC 1997;Build 9
"RTN","PSOLMPAT",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOLMPAT",4,0)
 ;
"RTN","PSOLMPAT",5,0)
EN I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) S VALMSG="Site Parameters must be Defined!" G EX
"RTN","PSOLMPAT",6,0)
 D HLDHDR^PSOLMUTL S DA=DFN,PI=""
"RTN","PSOLMPAT",7,0)
 I '$P($G(PSOPAR),"^",22),'$D(^XUSEC("PSO ADDRESS UPDATE",+$G(DUZ))) G P55
"RTN","PSOLMPAT",8,0)
 L +^PS(55,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T D MSG G EX
"RTN","PSOLMPAT",9,0)
 S PSODFN=DA D UPDATE^PSOBAI S DA=PSODFN
"RTN","PSOLMPAT",10,0)
 W !
"RTN","PSOLMPAT",11,0)
 L +^DPT(DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T D MSG G EX
"RTN","PSOLMPAT",12,0)
 S DIE="^DPT(",DR="[PSO OUTPT]"
"RTN","PSOLMPAT",13,0)
 D FULL^VALM1,^DIE L -^DPT(DA)
"RTN","PSOLMPAT",14,0)
P55 I '$D(^PS(55,DFN)) K DIC S DIC="^PS(55,",DIC(0)="LZ",(X,DINUM)=DFN K DD,DO D FILE^DICN K DIC
"RTN","PSOLMPAT",15,0)
 I $G(DFN),$P($G(^PS(55,DFN,0)),"^")="" S $P(^PS(55,DFN,0),"^")=DFN K DIK S DA=DFN,DIK="^PS(55,",DIK(1)=.01 D EN^DIK K DIK S DA=DFN
"RTN","PSOLMPAT",16,0)
 S DIE="^PS(55,",DR=".02;.03;.05;.04;1;3;40:41.1;106;106.1" W !!?5,">>PHARMACY PATIENT DATA<<",! D ^DIE
"RTN","PSOLMPAT",17,0)
EX L -^PS(55,DA),-^DPT(DA) D ^PSOORUT2 S VALMBCK="R"
"RTN","PSOLMPAT",18,0)
 K DIC,X,Y,DIE,D0,DA,DFN,PI,DR,%,%Y,%X,C,DI,DIPGM,DQ,PSOFROM
"RTN","PSOLMPAT",19,0)
 Q
"RTN","PSOLMPAT",20,0)
MSG S VALMSG="Patient Data is Being Edited by Another User!" Q
"RTN","PSOLMUTL")
0^73^B10324003^B9324541
"RTN","PSOLMUTL",1,0)
PSOLMUTL ;BIR/SAB - listman utilities ;03/07/95
"RTN","PSOLMUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**19,46,84,99,131,132,148,268**;DEC 1997;Build 9
"RTN","PSOLMUTL",3,0)
 ;External reference FULL^VALM1 supported by dbia 10116
"RTN","PSOLMUTL",4,0)
 ;External reference $$SETSTR^VALM1 supported by dbia 10116
"RTN","PSOLMUTL",5,0)
 ;External reference EN2^GMRAPEMO supported by dbia 190
"RTN","PSOLMUTL",6,0)
 ;External reference to ^ORD(101 supported by DBIA 872
"RTN","PSOLMUTL",7,0)
 ;
"RTN","PSOLMUTL",8,0)
EN W @IOF S VALMCNT=0
"RTN","PSOLMUTL",9,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!?5,"Site parameter must be defined!",! G INITQ
"RTN","PSOLMUTL",10,0)
 D EN^PSOLMPI
"RTN","PSOLMUTL",11,0)
INITQ Q
"RTN","PSOLMUTL",12,0)
HDR ;patient med profile display
"RTN","PSOLMUTL",13,0)
 K VALMHDR S HDR=^TMP("PSOHDR",$J,1,0)
"RTN","PSOLMUTL",14,0)
 S:^TMP("PSOHDR",$J,8,0) X=IORVON_"<A>"_IORVOFF,HDR=$$SETSTR^VALM1(X,HDR,80-$L(X),80) S VALMHDR(1)=HDR
"RTN","PSOLMUTL",15,0)
 I '(^TMP("PSOHDR",$J,8,0)) S PSONOAL="" D ALLERGY^PSOORUT2 I PSONOAL'="" D  K PSONOAL
"RTN","PSOLMUTL",16,0)
 .S X=IORVON_"<NO ALLERGY ASSESSMENT>"_IORVOFF,HDR=$$SETSTR^VALM1(X,HDR,80-$L(X),80) S VALMHDR(1)=HDR
"RTN","PSOLMUTL",17,0)
 S HDR="  PID: "_^TMP("PSOHDR",$J,2,0)
"RTN","PSOLMUTL",18,0)
 S VALMHDR(2)=$$SETSTR^VALM1("Ht(cm): "_^TMP("PSOHDR",$J,7,0),HDR,52,27)
"RTN","PSOLMUTL",19,0)
 S HDR="  DOB: "_^TMP("PSOHDR",$J,3,0)_" ("_^TMP("PSOHDR",$J,4,0)_")"
"RTN","PSOLMUTL",20,0)
 S VALMHDR(3)=$$SETSTR^VALM1(" Wt(kg): "_^TMP("PSOHDR",$J,6,0),HDR,51,28)
"RTN","PSOLMUTL",21,0)
 S HDR="  SEX: "_$E(^TMP("PSOHDR",$J,5,0),1,44)
"RTN","PSOLMUTL",22,0)
 S VALMHDR(4)=HDR
"RTN","PSOLMUTL",23,0)
 S $P(VALMHDR(4)," ",30)="  "_$E(^TMP("PSOHDR",$J,5,0),48,80)
"RTN","PSOLMUTL",24,0)
 Q:$G(PS)="VIEW"!($G(PS)="DELETE")
"RTN","PSOLMUTL",25,0)
 S VALMHDR(5)=$G(^TMP("PSOHDR",$J,9,0))
"RTN","PSOLMUTL",26,0)
 S VALMHDR(6)=$G(^TMP("PSOHDR",$J,10,0))
"RTN","PSOLMUTL",27,0)
 Q
"RTN","PSOLMUTL",28,0)
 ;
"RTN","PSOLMUTL",29,0)
NEWALL(DFN) ; Enter Allergy info.
"RTN","PSOLMUTL",30,0)
 N PSOID D FULL^VALM1,EN2^GMRAPEM0,^PSOORUT2 S VALMBCK="R"
"RTN","PSOLMUTL",31,0)
 Q
"RTN","PSOLMUTL",32,0)
NEWSEL ;allows order selection by number instead of action
"RTN","PSOLMUTL",33,0)
 S Y=$P(XQORNOD(0),"=",2) N VALMCNT D NEWSEL^PSOORNE2
"RTN","PSOLMUTL",34,0)
 Q
"RTN","PSOLMUTL",35,0)
EDTSEL ;allows edit selection by number instead of action - active orders
"RTN","PSOLMUTL",36,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2) D EDTSEL^PSOOREDT
"RTN","PSOLMUTL",37,0)
 Q
"RTN","PSOLMUTL",38,0)
SELAL ;selection of allergy by number instead of action - select allergy
"RTN","PSOLMUTL",39,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2) D SELAL^PSOORDA
"RTN","PSOLMUTL",40,0)
 Q
"RTN","PSOLMUTL",41,0)
EDTNEW ;allows edit selection by number instead of action - new orders
"RTN","PSOLMUTL",42,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2) D EDTSEL^PSOORNE1
"RTN","PSOLMUTL",43,0)
 Q
"RTN","PSOLMUTL",44,0)
EDTRNEW ;allows edit selection by number instead of action - renew orders
"RTN","PSOLMUTL",45,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2) D EDTSEL^PSOORNE4
"RTN","PSOLMUTL",46,0)
 Q
"RTN","PSOLMUTL",47,0)
EDTPEN ;allows edit selection by number instead of action - pending orders
"RTN","PSOLMUTL",48,0)
 N VALMCNT S Y=$P(XQORNOD(0),"=",2),SEDT=1 G EDTSEL^PSOORNEW
"RTN","PSOLMUTL",49,0)
 Q
"RTN","PSOLMUTL",50,0)
HLDHDR ;keeps patient's header info
"RTN","PSOLMUTL",51,0)
 S IOTM=VALM("TM"),IOBM=IOSL W IOSC W @IOSTBM W IORC
"RTN","PSOLMUTL",52,0)
 Q
"RTN","PSOLMUTL",53,0)
 ;
"RTN","PSOLMUTL",54,0)
BYPASS S:$G(PSOFDR) SIGOK=1 S Y=-1,VALMBCK="Q"
"RTN","PSOLMUTL",55,0)
 Q
"RTN","PSOLMUTL",56,0)
ACTIONS() ;screen actions on active orders
"RTN","PSOLMUTL",57,0)
 Q:$G(PKI1)=2 0
"RTN","PSOLMUTL",58,0)
 N DIC,X,Y K DIC,Y S DIC="^ORD(101,"_DA(1)_",10,",X=DA,DIC(0)="ZN" D ^DIC Q:Y<0 0
"RTN","PSOLMUTL",59,0)
 S Y=Y(0,0)
"RTN","PSOLMUTL",60,0)
 I Y="PSO REFILL" Q $S(PSOACT["R":1,1:0)
"RTN","PSOLMUTL",61,0)
 I Y="PSO RENEW" Q $S(PSOACT["N":1,1:0)
"RTN","PSOLMUTL",62,0)
 I Y="PSO REPRINT" Q $S(PSOACT["P":1,1:0)
"RTN","PSOLMUTL",63,0)
 I Y="PSO EDIT ORDERS" Q $S(PSOACT["E":1,1:0)
"RTN","PSOLMUTL",64,0)
 I Y="PSO RELEASE" Q $S(PSOACT["L":1,1:0)
"RTN","PSOLMUTL",65,0)
 I Y="PSO PARTIAL" Q $S(PSOACT["T":1,1:0)
"RTN","PSOLMUTL",66,0)
 I Y="PSO CANCEL" Q $S(PSOACT["D":1,1:0)
"RTN","PSOLMUTL",67,0)
 I Y="PSO HOLD" Q $S(PSOACT["H":1,1:0)
"RTN","PSOLMUTL",68,0)
 I Y="PSO UNHOLD" Q $S(PSOACT["U":1,1:0)
"RTN","PSOLMUTL",69,0)
 I Y="PSO LM BACKDOOR COPY" Q $S(PSOACT["C":1,1:0)
"RTN","PSOLMUTL",70,0)
 I Y="PSO VERIFY" Q $S(PSOACT["V":1,1:0)
"RTN","PSOLMUTL",71,0)
 I Y="PSO ACTIVITY LOGS" Q 1
"RTN","PSOLMUTL",72,0)
 Q 1
"RTN","PSOLMUTL",73,0)
ACTIONS1() ;screen actions on pending orders
"RTN","PSOLMUTL",74,0)
 Q:$G(PKI1)=2 0
"RTN","PSOLMUTL",75,0)
 N DIC,X,Y K DIC,Y S DIC="^ORD(101,"_DA(1)_",10,",X=DA,DIC(0)="ZN" D ^DIC Q:Y<0 0
"RTN","PSOLMUTL",76,0)
 S Y=Y(0,0)
"RTN","PSOLMUTL",77,0)
 I Y="PSO LM DISCONTINUE" Q $S(PSOACT["D":1,1:0)
"RTN","PSOLMUTL",78,0)
 I Y="PSO LM EDIT" Q $S(PSOACT["E":1,1:0)
"RTN","PSOLMUTL",79,0)
 I Y="PSO LM FINISH" Q $S(PSOACT["F":1,1:0)
"RTN","PSOLMUTL",80,0)
 Q 1
"RTN","PSOLMUTL",81,0)
PKIACT() ;screen actions on pending orders DEA/PKI proj.
"RTN","PSOLMUTL",82,0)
 Q:$G(PKI1)=2 0
"RTN","PSOLMUTL",83,0)
 Q 1
"RTN","PSON52")
0^36^B60158603^B59816394
"RTN","PSON52",1,0)
PSON52 ;BIR/DSD - files new entries in prescription file ;08/09/93
"RTN","PSON52",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,16,23,27,32,46,71,111,124,117,131,139,157,143,219,148,239,201,268**;DEC 1997;Build 9
"RTN","PSON52",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSON52",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSON52",5,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSON52",6,0)
 ;External reference SWSTAT^IBBAPI supported by DBIA 4663
"RTN","PSON52",7,0)
EN(PSOX) ;Entry Point
"RTN","PSON52",8,0)
START ;
"RTN","PSON52",9,0)
 D:$D(XRTL) T0^%ZOSV ; Start RT Monitor
"RTN","PSON52",10,0)
 D INIT G:PSON52("QFLG") END D NFILE Q:$G(PSONEW("DFLG"))  D PS55,DIK
"RTN","PSON52",11,0)
 S:$D(XRT0) XRTN=$T(+0) D:$D(XRT0) T1^%ZOSV ; Stop RT Monitor
"RTN","PSON52",12,0)
 D FINISH
"RTN","PSON52",13,0)
 I $P(^PSRX(PSOX("IRXN"),0),"^",11)="W",$G(^("IB")) S ^PSRX("ACP",$P(^PSRX(PSOX("IRXN"),0),"^",2),$P(^(2),"^",2),0,PSOX("IRXN"))=""
"RTN","PSON52",14,0)
END D EOJ
"RTN","PSON52",15,0)
 Q
"RTN","PSON52",16,0)
INIT ;
"RTN","PSON52",17,0)
 K X,%DT S:$G(PSOID) PSOX("ISSUE DATE")=PSOID
"RTN","PSON52",18,0)
 S PSOX("CS")=0
"RTN","PSON52",19,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSOX("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSOX("CS"),"^",2)=1
"RTN","PSON52",20,0)
 S PSON52("QFLG")=0,X1=PSOX("ISSUE DATE"),X2=PSOX("DAYS SUPPLY")*(PSOX("# OF REFILLS")+1)\1
"RTN","PSON52",21,0)
 I $D(CLOZPAT) S X2=$S(X2=14:14,X2=7:7,1:X2) G DT
"RTN","PSON52",22,0)
 S X2=$S(PSOX("DAYS SUPPLY")=X2:X2,+$G(PSOX("CS")):184,+$G(DEA("CS")):184,1:366)
"RTN","PSON52",23,0)
 I X2<30 D
"RTN","PSON52",24,0)
 . N % S %=$P($G(PSORX("PATIENT STATUS")),"^"),X2=30
"RTN","PSON52",25,0)
 . S:%?.N %=$P($G(^PS(53,+%,0)),"^") I %["AUTH ABS" S X2=5
"RTN","PSON52",26,0)
DT D C^%DTC S PSOX("STOP DATE")=$P(X,".") K X
"RTN","PSON52",27,0)
 I PSOX("# OF REFILLS")>0 S X1=PSOX("FILL DATE"),X2=$S((PSOX("DAYS SUPPLY")-10\1)<1:1,1:PSOX("DAYS SUPPLY")-10\1) D C^%DTC S PSOX("NEXT POSSIBLE REFILL")=$P(X,".") K X
"RTN","PSON52",28,0)
 S PSOX("TYPE OF RX")=0,PSOX("DISPENSED DATE")=PSOX("FILL DATE") D NOW^%DTC S PSOX("LOGIN DATE")=$S($P($G(OR0),"^",12):$P($G(OR0),"^",12),1:%) K %,X
"RTN","PSON52",29,0)
 S PSOX("STATUS")=$S($G(PSOX("STATUS"))]"":PSOX("STATUS"),$D(PSORX("VERIFY")):1,1:0)
"RTN","PSON52",30,0)
 S PSOX("COPIES")=$S($G(PSOX("COPIES"))]"":PSOX("COPIES"),1:1)
"RTN","PSON52",31,0)
 I $G(PSORX("PHARM"))]"" S PSOX("PHARMACIST")=PSORX("PHARM") K PSORX("PHARM")
"RTN","PSON52",32,0)
INITX Q
"RTN","PSON52",33,0)
 ;
"RTN","PSON52",34,0)
NFILE I $G(OR0) D  Q:$G(PSONEW("DFLG"))
"RTN","PSON52",35,0)
 .D NOOR^PSONEW Q:$G(PSONEW("DFLG"))
"RTN","PSON52",36,0)
 .I $G(PSOSIGFL)!($G(PSODRUG("OI"))'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSONEW("REMARKS")=$G(PSONEW("REMARKS"))_" CPRS Order #"_$P(OR0,"^")_" Edited."
"RTN","PSON52",37,0)
 S DIC="^PSRX(",DLAYGO=52,DIC(0)="L",X=PSOX("RX #") K DD,DO D FILE^DICN S PSOX("IRXN")=+Y K DLAYGO,X,Y,DIC,DD,DO D:+$G(DGI) TECH^PSODGDGI
"RTN","PSON52",38,0)
 F PSOX1=0:1 S PSON52=$P($T(DD+PSOX1),";;",2,4) Q:PSON52=""  K PSOY S PSOY=$P(PSON52,";;") I $G(@PSOY)]"" S $P(PSON52(PSOX("IRXN"),$P(PSON52,";;",2)),"^",$P(PSON52,";;",3))=@PSOY
"RTN","PSON52",39,0)
 F I=1:1:PSOX("ENT") S ^PSRX(PSOX("IRXN"),6,I,0)=PSOX("DOSE",I)_"^"_$G(PSOX("DOSE ORDERED",I))_"^"_$G(PSOX("UNITS",I))_"^"_$G(PSOX("NOUN",I))_"^" D
"RTN","PSON52",40,0)
 .S ^PSRX(PSOX("IRXN"),6,I,0)=^PSRX(PSOX("IRXN"),6,I,0)_$G(PSOX("DURATION",I))_"^"_$G(PSOX("CONJUNCTION",I))_"^"_$G(PSOX("ROUTE",I))_"^"_$G(PSOX("SCHEDULE",I))_"^"_$G(PSOX("VERB",I))
"RTN","PSON52",41,0)
 .I $G(PSOX("ODOSE",I))]"" S ^PSRX(PSOX("IRXN"),6,I,1)=PSOX("ODOSE",I)
"RTN","PSON52",42,0)
 S ^PSRX(PSOX("IRXN"),6,0)="^52.0113^"_PSOX("ENT")_"^"_PSOX("ENT")
"RTN","PSON52",43,0)
 K PSOX1,PSOY
"RTN","PSON52",44,0)
 S PSOX1="" F  S PSOX1=$O(PSON52(PSOX("IRXN"),PSOX1)) Q:PSOX1=""  S ^PSRX(PSOX("IRXN"),PSOX1)=$G(PSON52(PSOX("IRXN"),PSOX1))
"RTN","PSON52",45,0)
 I $O(PSOX("SIG",0)) D
"RTN","PSON52",46,0)
 .S D=0 F  S D=$O(PSOX("SIG",D)) Q:'D  S ^PSRX(PSOX("IRXN"),"INS1",D,0)=PSOX("SIG",D),TP=$G(TP)+1
"RTN","PSON52",47,0)
 .S ^PSRX(PSOX("IRXN"),"INS1",0)="^52.0115^"_TP_"^"_TP_"^"_DT_"^^" K TP,D
"RTN","PSON52",48,0)
 I $G(PSOX("SINS"))]"" S ^PSRX(PSOX("IRXN"),"INSS")=PSOX("SINS")
"RTN","PSON52",49,0)
 I $G(SIGOK) D
"RTN","PSON52",50,0)
 .S $P(^PSRX(PSOX("IRXN"),"SIG"),"^",2)=1,^PSRX(PSOX("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSON52",51,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSOX("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSOX("IRXN"),"SIG1",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"SIG1",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSON52",52,0)
 .K SIG
"RTN","PSON52",53,0)
 I $D(PSOINSFL) S ^PSRX(PSOX("IRXN"),"A",0)="^52.3DA^1^1",^PSRX(PSOX("IRXN"),"A",1,0)=DT_"^G^^0^Patient Instructions "_$S(PSOINSFL=1:"",1:"Not ")_"Sent By Provider."
"RTN","PSON52",54,0)
 I $G(OR0) S:$P(OR0,"^",24) ^PSRX(PSOX("IRXN"),"PKI")=1
"RTN","PSON52",55,0)
 K PSOX1,PSOFINFL,HLDSIG,D,PSOINSFL,D
"RTN","PSON52",56,0)
 D:$G(^TMP("PSODAI",$J,0))
"RTN","PSON52",57,0)
 .S $P(^PSRX(PSOX("IRXN"),3),"^",6)=1
"RTN","PSON52",58,0)
 .I $O(^TMP("PSODAI",$J,0)) S DAI=0 F  S DAI=$O(^TMP("PSODAI",$J,DAI)) Q:'DAI  D
"RTN","PSON52",59,0)
 ..S:'$D(^PSRX(PSOX("IRXN"),"DAI",0)) ^PSRX(PSOX("IRXN"),"DAI",0)="^52.03^^" S ^PSRX(PSOX("IRXN"),"DAI",DAI,0)=^TMP("PSODAI",$J,DAI,0)
"RTN","PSON52",60,0)
 ..S $P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1
"RTN","PSON52",61,0)
 .K ^TMP("PSODAI",$J),DAI
"RTN","PSON52",62,0)
 I $G(PSOX("CHCS NUMBER"))'="" S $P(^PSRX(PSOX("IRXN"),"EXT"),"^")=$G(PSOX("CHCS NUMBER"))
"RTN","PSON52",63,0)
 I $G(PSOX("EXTERNAL SYSTEM"))'="" S $P(^PSRX(PSOX("IRXN"),"EXT"),"^",2)=$G(PSOX("EXTERNAL SYSTEM"))
"RTN","PSON52",64,0)
 I $G(PSOX("NEWCOPAY")) S ^PSRX(PSOX("IRXN"),"IB")=$G(PSOX("NEWCOPAY"))
"RTN","PSON52",65,0)
 ;Next line, set SC question based on Copay status?
"RTN","PSON52",66,0)
IBQ ;I $G(PSOBILL)=2 S ^PSRX(PSOX("IRXN"),"IBQ")=$S($G(PSOX("NEWCOPAY")):0,1:1)
"RTN","PSON52",67,0)
 N PSOSCFLD S PSOSCFLD=$S(PSOSCP'="":$G(PSOANSQ("SC")),1:"")_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))
"RTN","PSON52",68,0)
 I PSOSCP<50&($TR(PSOSCFLD,"^")'="")&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1) D
"RTN","PSON52",69,0)
 . S ^PSRX(PSOX("IRXN"),"IBQ")=PSOSCFLD K PSOSCFLD  ;don't set if SC % is null or 0, just set it in ICD node
"RTN","PSON52",70,0)
 D ICD^PSODIAG
"RTN","PSON52",71,0)
 D:$$SWSTAT^IBBAPI() GACT^PSOPFSU0(PSOX("IRXN"),0)
"RTN","PSON52",72,0)
 K PSOANSQ,PSOANSQD,PSOX("NEWCOPAY")
"RTN","PSON52",73,0)
 L -^PSRX("B",PSOX("IRXN"))
"RTN","PSON52",74,0)
 Q
"RTN","PSON52",75,0)
 ;
"RTN","PSON52",76,0)
PS55 ;
"RTN","PSON52",77,0)
 L +^PS(55,PSODFN,"P"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSON52",78,0)
 S:'$D(^PS(55,PSODFN,"P",0)) ^(0)="^55.03PA^^"
"RTN","PSON52",79,0)
 F PSOX1=$P(^PS(55,PSODFN,"P",0),"^",3):1 Q:'$D(^PS(55,PSODFN,"P",PSOX1))
"RTN","PSON52",80,0)
 S PSOX("55 IEN")=PSOX1
"RTN","PSON52",81,0)
 S ^PS(55,PSODFN,"P",PSOX1,0)=PSOX("IRXN"),$P(^PS(55,PSODFN,"P",0),"^",3,4)=PSOX1_"^"_($P(^PS(55,PSODFN,"P",0),"^",4)+1)
"RTN","PSON52",82,0)
 S ^PS(55,PSODFN,"P","A",PSONEW("STOP DATE"),PSOX("IRXN"))=""
"RTN","PSON52",83,0)
PS55X L -^PS(55,PSODFN,"P")
"RTN","PSON52",84,0)
 K PSOX1
"RTN","PSON52",85,0)
 Q
"RTN","PSON52",86,0)
DIK ;
"RTN","PSON52",87,0)
 I $D(^XUSEC("PSORPH",DUZ)) S DA=PSOX("IRXN"),DIE=52,DR="41////"_PSOCOU_";S:'X Y=""@1"";42////"_PSOCOUU_";@1" D ^DIE K DIE,DR
"RTN","PSON52",88,0)
 K DIK,DA S DIK="^PSRX(",DA=PSOX("IRXN") D IX1^DIK K DIK
"RTN","PSON52",89,0)
 S DA=PSOX("IRXN") D ORC^PSORN52C
"RTN","PSON52",90,0)
 Q
"RTN","PSON52",91,0)
FINISH ;
"RTN","PSON52",92,0)
ANQ I $G(ANQDATA)]"" D NOW^%DTC G:$D(^PS(52.52,"B",%)) ANQ D
"RTN","PSON52",93,0)
 .K DD,DO S DIC="^PS(52.52,",DIC(0)="L",DLAYGO=52.52,X=% D FILE^DICN K DIC,DLAYGO,DD,DO
"RTN","PSON52",94,0)
 .S ^PS(52.52,+Y,0)=$P(Y,"^",2)_"^"_PSOX("IRXN")_"^"_ANQDATA,^PS(52.52,"A",PSOX("IRXN"),+Y)="" K ANQDATA,X,Y,%,ANQREM
"RTN","PSON52",95,0)
 G:PSOX("STATUS")=4 FINISHP
"RTN","PSON52",96,0)
 I $D(PSORX("VERIFY")) D  G FINISHX
"RTN","PSON52",97,0)
 .K DIC,DLAYGO,DINUM,DIADD,X,DD,DO S DIC="^PS(52.4,",DLAYGO=52.4,DINUM=PSOX("IRXN"),DIC(0)="ML",X=PSOX("IRXN")
"RTN","PSON52",98,0)
 .D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM S ^PS(52.4,PSOX("IRXN"),0)=PSOX("IRXN")_"^"_PSODFN_"^"_DUZ_"^"_"^"_$E(PSOX("LOGIN DATE"),1,7)_"^"_PSOX("IRXN")_"^"_PSOX("STOP DATE")
"RTN","PSON52",99,0)
 .K DIK,DA S DIK="^PS(52.4,",DA=PSOX("IRXN") D IX^DIK K DIK,DA
"RTN","PSON52",100,0)
 ;
"RTN","PSON52",101,0)
 I PSOX("FILL DATE")>DT,$P(PSOPAR,"^",6) S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=0 D SUS^PSORXL K DA G FINISHX
"RTN","PSON52",102,0)
 ;
"RTN","PSON52",103,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSON52",104,0)
 N ACTION
"RTN","PSON52",105,0)
 I $$SUBMIT^PSOBPSUT(PSOX("IRXN"),0) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSON52",106,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSOX("IRXN"),0,PSOX("FILL DATE"),"OF")
"RTN","PSON52",107,0)
 . I $$FIND^PSOREJUT(PSOX("IRXN"),0) D
"RTN","PSON52",108,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSOX("IRXN"),0,"79,88","OF","IOQ","I")
"RTN","PSON52",109,0)
 ;
"RTN","PSON52",110,0)
FINISHP ;
"RTN","PSON52",111,0)
 I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSOX("IRXN")_",",RXFL(PSOX("IRXN"))=0 G FINISHX
"RTN","PSON52",112,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSON52",113,0)
 I $L(PSORX("PSOL",PSOX2))+$L(PSOX("IRXN"))<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSOX("IRXN")_","
"RTN","PSON52",114,0)
 E  S PSORX("PSOL",PSOX2+1)=PSOX("IRXN")_","
"RTN","PSON52",115,0)
 S RXFL(PSOX("IRXN"))=0
"RTN","PSON52",116,0)
FINISHX ;call to build Rx array for bingo board
"RTN","PSON52",117,0)
 I $G(PSORX("MAIL/WINDOW"))["W" S BINGCRT=1,BINGRTE="W",BBFLG=1 D BBRX^PSORN52C
"RTN","PSON52",118,0)
 K PSOX1,PSOX2
"RTN","PSON52",119,0)
 Q
"RTN","PSON52",120,0)
EOJ ;
"RTN","PSON52",121,0)
 ;B xref locked in routine PSONRXN
"RTN","PSON52",122,0)
 L -^PSRX("B",PSOX("IRXN")) K OTHDOS,DA,PSON52,PSOPRC,RTE,SCH,PSOX("INS"),PSONEW("INS"),PSORXED("INS"),PSONEW("ENT"),PSORXED("ENT"),OLENT
"RTN","PSON52",123,0)
 D PSOUL^PSSLOCK(PSOX("IRXN"))
"RTN","PSON52",124,0)
 Q
"RTN","PSON52",125,0)
 ;
"RTN","PSON52",126,0)
 ;;PSOX("SIG");;SIG;;1
"RTN","PSON52",127,0)
DD ;;PSOX("RX #");;0;;1
"RTN","PSON52",128,0)
 ;;PSOX("ISSUE DATE");;0;;13
"RTN","PSON52",129,0)
 ;;PSODFN;;0;;2
"RTN","PSON52",130,0)
 ;;PSOX("PATIENT STATUS");;0;;3
"RTN","PSON52",131,0)
 ;;PSOX("PROVIDER");;0;;4
"RTN","PSON52",132,0)
 ;;PSOX("CLINIC");;0;;5
"RTN","PSON52",133,0)
 ;;PSODRUG("IEN");;0;;6
"RTN","PSON52",134,0)
 ;;PSODRUG("TRADE NAME");;TN;;1
"RTN","PSON52",135,0)
 ;;PSOX("QTY");;0;;7
"RTN","PSON52",136,0)
 ;;PSOX("DAYS SUPPLY");;0;;8
"RTN","PSON52",137,0)
 ;;PSOX("# OF REFILLS");;0;;9
"RTN","PSON52",138,0)
 ;;PSOX("COPIES");;0;;18
"RTN","PSON52",139,0)
 ;;PSOX("MAIL/WINDOW");;0;;11
"RTN","PSON52",140,0)
 ;;PSOX("REMARKS");;3;;7
"RTN","PSON52",141,0)
 ;;PSOX("CLERK CODE");;0;;16
"RTN","PSON52",142,0)
 ;;PSODRUG("COST");;0;;17
"RTN","PSON52",143,0)
 ;;PSOSITE;;2;;9
"RTN","PSON52",144,0)
 ;;PSOX("LOGIN DATE");;2;;1
"RTN","PSON52",145,0)
 ;;PSOX("FILL DATE");;2;;2
"RTN","PSON52",146,0)
 ;;PSOX("PHARMACIST");;2;;3
"RTN","PSON52",147,0)
 ;;PSOX("LOT #");;2;;4
"RTN","PSON52",148,0)
 ;;PSOX("DISPENSED DATE");;2;;5
"RTN","PSON52",149,0)
 ;;PSOX("STOP DATE");;2;;6
"RTN","PSON52",150,0)
 ;;PSODRUG("NDC");;2;;7
"RTN","PSON52",151,0)
 ;;PSODRUG("DAW");;EPH;;1
"RTN","PSON52",152,0)
 ;;PSODRUG("MANUFACTURER");;2;;8
"RTN","PSON52",153,0)
 ;;PSOX("EXPIRATION DATE");;2;;11
"RTN","PSON52",154,0)
 ;;PSOX("GENERIC PROVIDER");;2;;12
"RTN","PSON52",155,0)
 ;;PSOX("RELEASED DATE/TIME");;2;;13
"RTN","PSON52",156,0)
 ;;PSOX("METHOD OF PICK-UP");;MP;;1
"RTN","PSON52",157,0)
 ;;PSOX("STATUS");;STA;;1
"RTN","PSON52",158,0)
 ;;PSOX("LAST DISPENSED DATE");;3;;1
"RTN","PSON52",159,0)
 ;;PSOX("NEXT POSSIBLE REFILL");;3;;2
"RTN","PSON52",160,0)
 ;;PSOX("COSIGNING PROVIDER");;3;;3
"RTN","PSON52",161,0)
 ;;PSOX("TYPE OF RX");;TYPE;;1
"RTN","PSON52",162,0)
 ;;PSOX("SAND");;SAND;;1
"RTN","PSON52",163,0)
 ;;PSOX("POE");;POE;;1
"RTN","PSON52",164,0)
 ;;PSOX("INS");;INS;;1
"RTN","PSONEW")
0^37^B28071554^B27548056
"RTN","PSONEW",1,0)
PSONEW ;BIR/SAB-new rx order main driver ;07/26/96
"RTN","PSONEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,46,94,130,268**;DEC 1997;Build 9
"RTN","PSONEW",3,0)
 ;External references L and UL^PSSLOCK supported by DBIA 2789
"RTN","PSONEW",4,0)
 ;External reference to ^VA(200 supported by DBIA 224
"RTN","PSONEW",5,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSONEW",6,0)
 ;External reference to ^ORX1 supported by DBIA 2186
"RTN","PSONEW",7,0)
 ;External reference to ^ORX2 supported by DBIA 867
"RTN","PSONEW",8,0)
 ;External reference to ^TIUEDIT supported by DBIA 2410
"RTN","PSONEW",9,0)
 ;---------------------------------------------------------------
"RTN","PSONEW",10,0)
OERR ;backdoor new rx for v7
"RTN","PSONEW",11,0)
 K PSOREEDT,COPY,SPEED,PSOEDIT,DUR,DRET
"RTN","PSONEW",12,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSONEW",13,0)
 K PSOPLCK S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" D UL^PSSLOCK(PSODFN) Q
"RTN","PSONEW",14,0)
AGAIN N VALMCNT K PSODRUG,PSOCOU,PSOCOUU,PSONOOR,PSORX("FN") W ! D HLDHDR^PSOLMUTL S (PSONEW("QFLG"),PSONEW("DFLG"))=0,PSOFROM="NEW",PSONOEDT=1
"RTN","PSONEW",15,0)
 K ORD D FULL^VALM1,^PSONEW1 ; Continue order entry
"RTN","PSONEW",16,0)
 I PSONEW("QFLG") G END
"RTN","PSONEW",17,0)
 I PSONEW("DFLG") W !,$C(7),"RX DELETED",! S:$G(POERR) POERR("DFLG")=1,VALMBCK="Q" G END
"RTN","PSONEW",18,0)
 D:$P($G(PSOPAR),"^",7)=1 AUTO^PSONRXN I $P($G(PSOPAR),"^",7)'=1 S PSOX=PSONEW("RX #") D CHECK^PSONRXN
"RTN","PSONEW",19,0)
 I PSONEW("DFLG")!PSONEW("QFLG") D DEL S:$G(POERR) POERR("DFLG")=1,VALMBCK="R" G END
"RTN","PSONEW",20,0)
 D NOOR I PSONEW("DFLG") D DEL G END
"RTN","PSONEW",21,0)
 D ^PSONEW2 I PSONEW("DFLG") D DEL S:$G(POERR) POERR("DFLG")=1,VALMBCK="R" G END ; Asks if correct
"RTN","PSONEW",22,0)
 G:$G(PSORX("FN")) END
"RTN","PSONEW",23,0)
 D EN^PSON52(.PSONEW) ; Files entry in File 52
"RTN","PSONEW",24,0)
 D NPSOSD^PSOUTIL(.PSONEW) ; Adds newly added rx to PSOSD array
"RTN","PSONEW",25,0)
 S VALMBCK="R"
"RTN","PSONEW",26,0)
END D EOJ ; Clean up          
"RTN","PSONEW",27,0)
 I '$G(PSORX("FN")) W ! K DIR,DIRUT,DUOUT,DTOUT S DIR(0)="Y",DIR("B")="YES",DIR("A")="Another New Order for "_PSORX("NAME") D ^DIR K DIR,DIRUT,DUOUT,DTOUT I Y K PSONEW,PSDRUG,ORD G AGAIN
"RTN","PSONEW",28,0)
 D ^PSOBUILD,BLD^PSOORUT1 S X=PSODFN_";DPT(" D ULK^ORX2 D UL^PSSLOCK(PSODFN)
"RTN","PSONEW",29,0)
 S VALMBCK="R" K PSORX("FN") Q
"RTN","PSONEW",30,0)
 ;----------------------------------------------------------------
"RTN","PSONEW",31,0)
DEL ;
"RTN","PSONEW",32,0)
 W !,$C(7),"RX DELETED",!
"RTN","PSONEW",33,0)
 I $P($G(PSOPAR),"^",7)=1 D
"RTN","PSONEW",34,0)
 . S DIE="^PS(59,",DA=PSOSITE,PSOY=$O(PSONEW("OLD LAST RX#",""))
"RTN","PSONEW",35,0)
 . S PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSONEW",36,0)
 . L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSONEW",37,0)
 . S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSONEW",38,0)
 . D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y
"RTN","PSONEW",39,0)
 . L -^PS(59,+PSOSITE,PSOY)
"RTN","PSONEW",40,0)
 . K PSOX,PSOY Q
"RTN","PSONEW",41,0)
EOJ ;
"RTN","PSONEW",42,0)
 I $D(PSONEW("RX #")) L -^PSRX("B",PSONEW("RX #")) ; +Lock set in PSONRXN
"RTN","PSONEW",43,0)
 K PSONOEDT,PSONEW,PSODRUG,ANQDATA,LSI,C,MAX,MIN,NDF,REF,SIG,SER,PSOFLAG,PSOHI,PSOLO,PSONOOR,PSOCOUU,PSOCOU,PSORX("EDIT")
"RTN","PSONEW",44,0)
 D CLEAN^PSOVER1
"RTN","PSONEW",45,0)
 K ^TMP("PSORXDC",$J),RORD,ACOM,ACNT,CRIT,DEF,F1,GG,I1,IEN,INDT,LAST,MSG,NIEN,STA,DUR,DRET,PSOPRC
"RTN","PSONEW",46,0)
 S RXN=$O(^TMP("PSORXN",$J,0)) I RXN D
"RTN","PSONEW",47,0)
 .S RXN1=^TMP("PSORXN",$J,RXN) D EN^PSOHLSN1(RXN,$P(RXN1,"^"),$P(RXN1,"^",2),"",$P(RXN1,"^",3))
"RTN","PSONEW",48,0)
 .I $P(^PSRX(RXN,"STA"),"^")=5 D EN^PSOHLSN1(RXN,"SC","ZS","")
"RTN","PSONEW",49,0)
 K RXN,RXN1,^TMP("PSORXN",$J)
"RTN","PSONEW",50,0)
 I $G(PSONOTE) D FULL^VALM1,MAIN^TIUEDIT(3,.TIUDA,PSODFN,"","","","",1)
"RTN","PSONEW",51,0)
 K PSONOTE
"RTN","PSONEW",52,0)
 Q
"RTN","PSONEW",53,0)
NOOR ;asks nature of order
"RTN","PSONEW",54,0)
 N PSONOODF
"RTN","PSONEW",55,0)
 S PSONOODF=0
"RTN","PSONEW",56,0)
 I $G(OR0) D  G NOORX ;front door
"RTN","PSONEW",57,0)
 .S PSOI=$S($G(PSOSIGFL):1,$G(PSODRUG("OI"))'=$P(OR0,"^",8):1,1:0) I 'PSOI S PSONOOR="" D:$D(^XUSEC("PSORPH",DUZ)) COUN Q  ;NoO $P(OR0,"^",7)
"RTN","PSONEW",58,0)
 .S PSONOODF=1
"RTN","PSONEW",59,0)
 .D DIR I $D(DIRUT) S PSONEW("DFLG")=1 Q
"RTN","PSONEW",60,0)
 .S PSONOOR=Y D:$D(^XUSEC("PSORPH",DUZ)) COUN K DIR,DTOUT,DTOUT,DIRUT
"RTN","PSONEW",61,0)
 ;backdoor order
"RTN","PSONEW",62,0)
 D DIR I $D(DIRUT) S PSONEW("DFLG")=1 Q
"RTN","PSONEW",63,0)
 S PSONOOR=Y K DIK,DA,DIE,DR,PSOI,DIR,DUOUT,DTOUT,DIRUT
"RTN","PSONEW",64,0)
 G:'$D(^XUSEC("PSORPH",DUZ)) NOORX
"RTN","PSONEW",65,0)
COUN ;patient counseling
"RTN","PSONEW",66,0)
 G:$G(PSORX("EDIT"))&('$G(PSOSIGFL)) NOORX K DIR,DUOUT,DTOUT,DIRUT
"RTN","PSONEW",67,0)
 S DIR("B")="NO",DIR(0)="52,41" D ^DIR S PSOCOU=$S(Y:Y,1:0)
"RTN","PSONEW",68,0)
 I $D(DIRUT)!('PSOCOU) S PSOCOUU=0 D:'$G(SPEED) PRONTE Q
"RTN","PSONEW",69,0)
 K:'$G(PSOCOU) PSOCOUU K DIR,DUOUT,DTOUT,DIRUT I Y S DIR(0)="52,42",DIR("B")="NO" D ^DIR S PSOCOUU=$S(Y:Y,1:0)
"RTN","PSONEW",70,0)
PRONTE K PSONOTE,DIR,DIRUT,DUOUT
"RTN","PSONEW",71,0)
 I $T(MAIN^TIUEDIT)]"",'$G(SPEED) D  K DIR,DIRUT,DUOUT
"RTN","PSONEW",72,0)
 .S DIR(0)="Y",DIR("B")="No",DIR("A")="Do you want to enter a Progress Note",DIR("A",1)="" D ^DIR K DIR
"RTN","PSONEW",73,0)
 .S PSONOTE=+Y Q  ;I 'Y!($D(DIRUT)) Q
"RTN","PSONEW",74,0)
NOORX K X,Y,DIR,DUOUT,DTOUT,DIRUT
"RTN","PSONEW",75,0)
 Q
"RTN","PSONEW",76,0)
DIR ;ask nature of order
"RTN","PSONEW",77,0)
 K DIR,DTOUT,DTOUT,DIRUT I $T(NA^ORX1)]""  D  Q
"RTN","PSONEW",78,0)
 .S PSONOOR=$$NA^ORX1($S($G(PSONOODF)!($G(PSONOBCK)):"S",1:"W"),0,"B","Nature of Order",0,"WPSDIVR"_$S(+$G(^VA(200,DUZ,"PS")):"E",1:""))
"RTN","PSONEW",79,0)
 .I +PSONOOR S (Y,PSONOOR)=$P(PSONOOR,"^",3) Q
"RTN","PSONEW",80,0)
 .S DIRUT=1 K PSONOOR
"RTN","PSONEW",81,0)
 I $D(PSONOOR) S DF=PSONOOR,PSONODF=$S(DF="E":"PROVIDER ENTERED",DF="V":"VERBAL",DF="P":"TELEPHONE",DF="D":"DUPLICATE",DF="S":"SERVICE CORRECTED",DF="I":"POLICY",DF="R":"SERVICE REJECTED",1:"WRITTEN")
"RTN","PSONEW",82,0)
 K DIR,DTOUT,DTOUT,DIRUT S DIR("A")="Nature of Order: ",DIR("B")=$S($D(PSONOOR):PSONODF,1:"WRITTEN")
"RTN","PSONEW",83,0)
 S DIR(0)="SA^W:WRITTEN;V:VERBAL;P:TELEPHONE;S:SERVICE CORRECTED;D:DUPLICATE;I:POLICY;R:SERVICE REJECTED"_$S(+$G(^VA(200,DUZ,"PS")):";E:PROVIDER ENTERED",1:"")
"RTN","PSONEW",84,0)
 D ^DIR K DF,PSONODF Q:$D(DIRUT)  S PSONOOR=Y
"RTN","PSONEW",85,0)
DIRX Q
"RTN","PSONEW",86,0)
 ;
"RTN","PSONEW",87,0)
NOORE(PSONEW) ;entry point for renew
"RTN","PSONEW",88,0)
 D NOOR I $D(DIRUT) S PSONEW("DFLG")=1 Q
"RTN","PSONEW",89,0)
 S PSONEW("NOO")=PSONOOR
"RTN","PSONEW",90,0)
 Q
"RTN","PSONRXN")
0^38^B15266741^B14211330
"RTN","PSONRXN",1,0)
PSONRXN ;IHS/DSD/JCM - GETS NEXT VALID RX NUMBER ;08/09/93 9:17
"RTN","PSONRXN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,25,166,268**;DEC 1997;Build 9
"RTN","PSONRXN",3,0)
 ;
"RTN","PSONRXN",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSONRXN",5,0)
 ;External reference to ^DIC supported by DBIA 10006
"RTN","PSONRXN",6,0)
 ;External reference to ^DIE supported by DBIA 10018
"RTN","PSONRXN",7,0)
 ;External reference to ^DIR supported by DBIA 10026
"RTN","PSONRXN",8,0)
 ;External reference to ^VALM1 supported by DBIA 10016
"RTN","PSONRXN",9,0)
 ;External reference to ^DPT( supported by DBIA 10035
"RTN","PSONRXN",10,0)
 ;
"RTN","PSONRXN",11,0)
 ; This routine asks for the next rx # if manually assigning rx#
"RTN","PSONRXN",12,0)
 ; and gets next rx# if auto numbering.
"RTN","PSONRXN",13,0)
 ;
"RTN","PSONRXN",14,0)
 ;-------------------------------------------------------------------
"RTN","PSONRXN",15,0)
 ;
"RTN","PSONRXN",16,0)
MANUAL ; Entry Point to ask user for new rx #
"RTN","PSONRXN",17,0)
 ;
"RTN","PSONRXN",18,0)
 S PSONEW("DFLG")=0
"RTN","PSONRXN",19,0)
 K DIR S DIR(0)="52,.01O"
"RTN","PSONRXN",20,0)
 S DIR("A")="Select New Rx # for "_$S($G(PSORX("NAME"))]"":PSORX("NAME"),1:"")
"RTN","PSONRXN",21,0)
 I $G(PSONEW("RX #"))]"",'$G(COPY) S DIR("B")=PSONEW("RX #")
"RTN","PSONRXN",22,0)
 D DIR^PSODIR2 K DIR,DIC,DIE,DA
"RTN","PSONRXN",23,0)
 I X="" S PSONEW("QFLG")=1 G MANUALX
"RTN","PSONRXN",24,0)
 I "Pp"[Y K Y D ^PSODSPL G MANUAL
"RTN","PSONRXN",25,0)
 I "Rr"[Y K Y S (PSONEW("QFLG"),PSORX("DO REFILL"))=1 G MANUALX
"RTN","PSONRXN",26,0)
 I $G(PSODIR("DFLG"))=1 S (PSONEW("QFLG"),PSORX("QFLG"))=1 G MANUALX
"RTN","PSONRXN",27,0)
 G:$G(PSONEW("FIELD")) MANUALX
"RTN","PSONRXN",28,0)
 S PSOX=Y
"RTN","PSONRXN",29,0)
 ;
"RTN","PSONRXN",30,0)
CHECK ; Entry Point to check if valid new rx number
"RTN","PSONRXN",31,0)
 S:'$D(PSOX) PSOX=$G(PSONEW("RX #"))
"RTN","PSONRXN",32,0)
 S PSONRXN("ERR FLG")=0
"RTN","PSONRXN",33,0)
 S DIC="^PSRX(",DIC(0)="XZ",X=PSOX D ^DIC K DIC
"RTN","PSONRXN",34,0)
 I Y'<0 D  G MANUALX
"RTN","PSONRXN",35,0)
 . W $C(7),!!,?10,"Not a new prescription number!!!",!,"Rxn: ",Y(0,0),!,"Patient: ",$S($D(^DPT(+$P(Y(0),"^",2),0)):$P(^(0),"^"),1:"UNKNOWN"),!,"Drug: ",$S($D(^PSDRUG(+$P(Y(0),"^",6),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSONRXN",36,0)
 . S PSONRXN("ID")=$P(Y(0),"^",13)
"RTN","PSONRXN",37,0)
 . I PSONRXN("ID") W !,"Issued: ",$E(PSONRXN("ID"),4,5),"-",$E(PSONRXN("ID"),6,7),"-",$E(PSONRXN("ID"),2,3)
"RTN","PSONRXN",38,0)
 . K PSONRXN("ID"),Y
"RTN","PSONRXN",39,0)
 . W:$G(PSODRUG("NAME")) !,"RX DELETED",!
"RTN","PSONRXN",40,0)
 . S PSONRXN("ERR FLG")=1
"RTN","PSONRXN",41,0)
 . I $G(PSOFIN)!($G(PSOFINFL)),'$G(PSOAC) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR
"RTN","PSONRXN",42,0)
 . Q
"RTN","PSONRXN",43,0)
 L +^PSRX("B",PSOX):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T L -^PSRX("B",PSOX) D  G MANUALX
"RTN","PSONRXN",44,0)
 . W $C(7),?10,"Prescription Rx# "_PSOX_" already being processed."
"RTN","PSONRXN",45,0)
 . W:$G(PSODRUG("NAME")) !,"Rx Deleted",!
"RTN","PSONRXN",46,0)
 . S PSONRXN("ERR FLG")=1
"RTN","PSONRXN",47,0)
 . Q
"RTN","PSONRXN",48,0)
 S PSONEW("RX #")=PSOX
"RTN","PSONRXN",49,0)
MANUALX I $G(PSONRXN("ERR FLG"))=1 S (PSONEW("DFLG"),PSONEW("QFLG"))=1
"RTN","PSONRXN",50,0)
 K PSONRXN,X,Y,DIRUT,DTOUT,DUOUT,DIC,DIE,DR,PSOX,PSODIR,PSOX1
"RTN","PSONRXN",51,0)
 Q
"RTN","PSONRXN",52,0)
 ;
"RTN","PSONRXN",53,0)
AUTO ; Entry point for getting next rx # if autonumbering
"RTN","PSONRXN",54,0)
 S PSONEW("QFLG")=0
"RTN","PSONRXN",55,0)
 S PSONRXN("TYPE")=$S('+$G(^PS(59,+PSOSITE,2)):8,PSODRUG("DEA")[2&(+$G(^PS(59,+PSOSITE,2))):3,1:8)
"RTN","PSONRXN",56,0)
 L +^PS(59,+PSOSITE,PSONRXN("TYPE")):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSONRXN",57,0)
 S PSOX1=^PS(59,+PSOSITE,PSONRXN("TYPE")),PSONRXN("LO")=$P(PSOX1,"^")
"RTN","PSONRXN",58,0)
 S PSONRXN("HI")=$P(PSOX1,"^",2),PSOI=$P(PSOX1,"^",3),PSONEW("OLD LAST RX#",PSONRXN("TYPE"))=PSOI
"RTN","PSONRXN",59,0)
 S:PSOI<PSONRXN("LO") PSOI=PSONRXN("LO")
"RTN","PSONRXN",60,0)
LOOP2 F  S PSOI=PSOI+1 D:PSOI>PSONRXN("HI") FATAL Q:'$D(^PSRX("B",PSOI))!PSONEW("QFLG")
"RTN","PSONRXN",61,0)
 G:PSONEW("QFLG") AUTOX
"RTN","PSONRXN",62,0)
 K DUP L +^PSRX("B",PSOI):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) D  I $G(DUP) K DUP,I G LOOP2
"RTN","PSONRXN",63,0)
 .I $D(^PSRX("B",PSOI))!'$T L -^PSRX("B",PSOI) S DUP=1 Q
"RTN","PSONRXN",64,0)
 .F I=65:1:90 I $D(^PSRX("B",PSOI_$C(I))) L -^PSRX("B",PSOI) S DUP=1 Q
"RTN","PSONRXN",65,0)
 K DIC,DIE,DA,DUP,I
"RTN","PSONRXN",66,0)
 S DIE=59,DA=PSOSITE
"RTN","PSONRXN",67,0)
 S DR=$S(PSONRXN("TYPE")=8:"2003////"_PSOI,PSONRXN("TYPE")=3:"1002.1////"_PSOI,1:"2003////"_PSOI)
"RTN","PSONRXN",68,0)
 S PSONEW("RX #")=PSOI
"RTN","PSONRXN",69,0)
 D ^DIE K DIE,DIC,DR,DA
"RTN","PSONRXN",70,0)
 L -^PS(59,+PSOSITE,PSONRXN("TYPE"))
"RTN","PSONRXN",71,0)
AUTOX K PSOX1,PSONRXN,PSOI,X,Y
"RTN","PSONRXN",72,0)
 Q
"RTN","PSONRXN",73,0)
 ;
"RTN","PSONRXN",74,0)
FATAL ;error in autonum queue if necessary and quit
"RTN","PSONRXN",75,0)
 W !!,$C(7),"Fatal error in Autonumbering - No Numbers Left!",!,"See Application Package Coordinator!",!,$C(7)
"RTN","PSONRXN",76,0)
 S PSONEW("QFLG")=1 S DIR("A")="Enter RETURN to continue" D PAUSE^VALM1
"RTN","PSONRXN",77,0)
 Q
"RTN","PSOORED1")
0^39^B67901232^B67707631
"RTN","PSOORED1",1,0)
PSOORED1 ;ISC-BHAM/SAB - edit orders from backdoor ;6/30/06 10:21am
"RTN","PSOORED1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,23,46,78,114,117,131,146,223,148,244,249,268**;DEC 1997;Build 9
"RTN","PSOORED1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORED1",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED1",5,0)
 ;
"RTN","PSOORED1",6,0)
 ;*244 call to remove DC'd Rx's from Rx ien strings
"RTN","PSOORED1",7,0)
 ;
"RTN","PSOORED1",8,0)
EN(PSORENW) ;
"RTN","PSOORED1",9,0)
 N LST,ORD,ORN K VALMBCK,PSORX("FN") S PSOAC=1,(PSORX("QFLG"),PSORX("DFLG"))=0 ;D DREN^PSOORNW2,INIT
"RTN","PSOORED1",10,0)
 D INIT
"RTN","PSOORED1",11,0)
 D @$S($P(PSOPAR,"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN")
"RTN","PSOORED1",12,0)
 I '$D(PSONEW("RX #")),'$P(PSOPAR,"^",7) D PAUSE^VALM1 K VALMSG,PSONEW("QFLG") S VALMBCK="Q" Q
"RTN","PSOORED1",13,0)
 I '$D(PSONEW("RX #")) K VALMSG D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" Q
"RTN","PSOORED1",14,0)
 S PSORENW("RX #")=PSONEW("RX #") I '$P(PSOPAR,"^",7) D  Q:$G(PSONEW("DFLG"))!($G(PSONEW("QFLG")))
"RTN","PSOORED1",15,0)
 .S PSOX=PSORENW("RX #") D CHECK^PSONRXN
"RTN","PSOORED1",16,0)
 I $G(PSONEW("DFLG"))!$G(PSONEW("QFLG")) D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" K PSORENW Q
"RTN","PSOORED1",17,0)
 D EN^PSOORNE1(.PSORENW) I '$G(PSORX("FN")) D:$P($G(PSOPAR),"^",7)=1  S VALMBCK="Q" Q
"RTN","PSOORED1",18,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOY=$O(PSONEW("OLD LAST RX#","")),PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORED1",19,0)
 .L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORED1",20,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORED1",21,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORED1",22,0)
 .I $D(PSONEW("RX #")) L -^PSRX("B",PSONEW("RX #"))
"RTN","PSOORED1",23,0)
 .K PSOX,PSOY Q
"RTN","PSOORED1",24,0)
 Q:$G(COPY)
"RTN","PSOORED1",25,0)
TRY S $P(^PSRX(PSORENW("OIRXN"),"STA"),"^")=15,DA=PSORENW("OIRXN")
"RTN","PSOORED1",26,0)
 S $P(^PSRX(DA,3),"^",5)=DT,$P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^")
"RTN","PSOORED1",27,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7),CAN^PSOTPCAN(DA)
"RTN","PSOORED1",28,0)
 D RMP^PSOCAN3                ;*244
"RTN","PSOORED1",29,0)
 ;cancel/discontinue action
"RTN","PSOORED1",30,0)
 S PHARM="",STAT="RP",COMM="Prescription discontinued due to editing." D EN^PSOHLSN1(DA,STAT,PHARM,COMM,PSONOOR) K STAT,PHARM,COMM
"RTN","PSOORED1",31,0)
 S ACOM="Discontinued due to editing. New Rx created "_$P(^PSRX(PSORENW("IRXN"),0),"^")_"."
"RTN","PSOORED1",32,0)
 I $G(^PSRX(DA,"H"))]"" D
"RTN","PSOORED1",33,0)
 .I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")=16) D
"RTN","PSOORED1",34,0)
 ..S DIE=52,DR="22///"_$P(^PSRX(DA,3),"^") D ^DIE S ACOM="Discontinued due to editing while on hold. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)
"RTN","PSOORED1",35,0)
 ..S ^PSRX(DA,"H")=""
"RTN","PSOORED1",36,0)
 S RXDA=DA,(DA,SUSDA)=$O(^PS(52.5,"B",RXDA,0)) D:DA
"RTN","PSOORED1",37,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOORED1",38,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM="Discontinued due to editing while suspended."
"RTN","PSOORED1",39,0)
 .I $O(^PSRX(RXDA,1,0)) S DA=RXDA D:'$G(^PS(52.5,+SUSDA,"P")) REF^PSOCAN2
"RTN","PSOORED1",40,0)
 .S DA=SUSDA,DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORED1",41,0)
 K SUSD,SUSDA S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) D
"RTN","PSOORED1",42,0)
 .S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOORED1",43,0)
 .S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOORED1",44,0)
 .D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1),^PSRX(DA,"A",ACNT+1,0)=%_"^C^"_DUZ_"^"_RFCNT_"^"_$G(ACOM)
"RTN","PSOORED1",45,0)
 .I $G(PSOOIFLG),'$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item Edited."
"RTN","PSOORED1",46,0)
 .I '$G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Medication Route/Schedule Edited."
"RTN","PSOORED1",47,0)
 .I $G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item and Medication Route/Schedule Edited."
"RTN","PSOORED1",48,0)
 .S REA="C" D EXP^PSOHELP1
"RTN","PSOORED1",49,0)
 I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOORED1",50,0)
 Q
"RTN","PSOORED1",51,0)
INS K X,QUIT,Y,DIR,DIRUT,DUOUT,DTOUT,DIC,INSDEL,UPMI,^TMP($J,"INS1")
"RTN","PSOORED1",52,0)
 I '$O(^PSRX(PSORXED("IRXN"),6,0)),'$O(PSORXED("DOSE",0)) D UPMI Q:$G(QUIT)  ;G INS1
"RTN","PSOORED1",53,0)
 I $G(^PSRX(PSORXED("IRXN"),"INS"))]"" S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS") K UPMI G INS1
"RTN","PSOORED1",54,0)
 K DD,GG F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S DD=$G(DD)+1
"RTN","PSOORED1",55,0)
 I $G(DD)=1 S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS1",$O(^PSRX(PSORXED("IRXN"),"INS1",0)),0) K UPMI,DD G INS1
"RTN","PSOORED1",56,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D  G INSX
"RTN","PSOORED1",57,0)
 .F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S ^TMP($J,"INS1",I,0)=^PSRX(PSORXED("IRXN"),"INS1",I,0)
"RTN","PSOORED1",58,0)
 .S ^TMP($J,"INS1",0)=^PSRX(PSORXED("IRXN"),"INS1",0)
"RTN","PSOORED1",59,0)
 .S DIC="^TMP($J,""INS1"",",DWPK=2,DWLW=80 D EN^DIWE I $G(X)="^" K ^TMP($J,"INS1") Q
"RTN","PSOORED1",60,0)
 .I '$O(^TMP($J,"INS1",0)) S INSDEL=1
"RTN","PSOORED1",61,0)
 .S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED1",62,0)
INS1 K Y,DIR,DIRUT,DUOUT,DTOUT,DIC,X
"RTN","PSOORED1",63,0)
 I $G(UPMI) K UPMI I $G(^PS(50.7,PSODRUG("OI"),"INS"))]"" S PSORXED("FLD",114)=^PS(50.7,PSODRUG("OI"),"INS")
"RTN","PSOORED1",64,0)
 S:$G(PSORXED("FLD",114))]"" DIR("B")=PSORXED("FLD",114)
"RTN","PSOORED1",65,0)
 S DIR("?")="Enter Quick codes or Free Text",DIR(0)="52,114" D ^DIR
"RTN","PSOORED1",66,0)
 I $D(DTOUT)!($D(DUOUT))!($G(PSORXED("FLD",114))=X) K PSORXED("FLD",114) G INSX
"RTN","PSOORED1",67,0)
 I X'="",X'="@" D SIG^PSOHELP G INS1:'$D(X)
"RTN","PSOORED1",68,0)
 S PSORXED("FLD",114)=X
"RTN","PSOORED1",69,0)
 I $G(INS1)]"" W " ("_$E(INS1,2,9999999)_")"
"RTN","PSOORED1",70,0)
 G:(X']""!(X="@")) INSX
"RTN","PSOORED1",71,0)
 S (PSORXED("INS"),PSORXED("SIG",1))=$E(INS1,2,9999999) D EN^PSOFSIG(.PSORXED)
"RTN","PSOORED1",72,0)
INSX I $P($G(^PS(55,PSODFN,"LAN")),"^") K DIR D
"RTN","PSOORED1",73,0)
 .I $G(^PSRX(PSORXED("IRXN"),"INSS"))]"" S PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORED1",74,0)
 .D SINS^PSODIR(.PSORXED) I $G(PSORXED("SINS"))']"" K ^PSRX(PSORXED("IRXN"),"INSS") Q
"RTN","PSOORED1",75,0)
 .S PSORXED("FLD",114.1)=PSORXED("SINS")
"RTN","PSOORED1",76,0)
 K DIRUT,DUOUT,DTOUT,DIR,X,Y,DIC,DWPK
"RTN","PSOORED1",77,0)
 Q
"RTN","PSOORED1",78,0)
INIT ;setup psorenw array
"RTN","PSOORED1",79,0)
 S PSORENW("RX0")=^PSRX(PSORENW("IRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN"))
"RTN","PSOORED1",80,0)
 I $G(PSOSIGFL),$G(PSORX("SIG"))]"" S PSORENW("SIG")=PSORX("SIG"),SIGOK=0
"RTN","PSOORED1",81,0)
 E  D
"RTN","PSOORED1",82,0)
 .I '$P($G(^PSRX(PSORENW("IRXN"),"SIG")),"^",2) S PSORENW("SIG")=$P($G(^("SIG")),"^")
"RTN","PSOORED1",83,0)
 .E  D
"RTN","PSOORED1",84,0)
 ..S SIGOK=1 Q:$O(SIG(0))
"RTN","PSOORED1",85,0)
 ..S D=0 F I=0:0 S D=D+1,I=$O(^PSRX(PSORENW("IRXN"),"SIG1",I)) Q:'I  S SIG(D)=^PSRX(PSORENW("IRXN"),"SIG1",I,0)
"RTN","PSOORED1",86,0)
 ..K PSOX1,D
"RTN","PSOORED1",87,0)
 S PSORENW("OIRXN")=PSORENW("IRXN")
"RTN","PSOORED1",88,0)
 S PSORENW("PROVIDER")=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:$P(PSORENW("RX0"),"^",4))
"RTN","PSOORED1",89,0)
 S (PSORENW("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSOORED1",90,0)
 I $P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",7),$P($G(^("PS")),"^",8) S PSORENW("COSIGNING PROVIDER")=$P($G(^("PS")),"^",8)
"RTN","PSOORED1",91,0)
 S PSORENW("CLINIC")=$S($G(PSORENW("CLINIC")):PSORENW("CLINIC"),1:$P(PSORENW("RX0"),"^",5))
"RTN","PSOORED1",92,0)
 S PSORENW("REMARKS")="New Order Created by "_$S($G(COPY)&('$G(PSOEDIT)):"copying",1:"editing")_" Rx # "_$P(PSORENW("RX0"),"^")_"."
"RTN","PSOORED1",93,0)
 S PSORENW("COSIGNER")=$S($G(PSORENW("COSIGNER")):PSORENW("COSIGNER"),$P(PSORENW("RX3"),"^",3):$P(PSORENW("RX3"),"^",3),1:"")
"RTN","PSOORED1",94,0)
 K:PSORENW("COSIGNER")="" PSORENW("COSIGNER")
"RTN","PSOORED1",95,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSOORED1",96,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSOORED1",97,0)
 S:$G(PSODRUG("IEN")) PSORENW("DRUG IEN")=PSODRUG("IEN")
"RTN","PSOORED1",98,0)
 I $G(PSORENW("DAYS SUPPLY")) G QTY
"RTN","PSOORED1",99,0)
 S PSORENW("DAYS SUPPLY")=$S($D(CLOZPAT):7,1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",100,0)
QTY S PSORENW("QTY")=$S($G(PSORENW("QTY")):PSORENW("QTY"),1:$P(PSORENW("RX0"),"^",7))
"RTN","PSOORED1",101,0)
RFN S PSORENW("# OF REFILLS")=$S($D(CLOZPAT):0,$G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSOORED1",102,0)
 S (PSOID,Y,PSORENW("FILL DATE"),PSORENW("ISSUE DATE"))=DT
"RTN","PSOORED1",103,0)
 S:PSORENW("CLINIC") PSORX("CLINIC")=$P(^SC(+PSORENW("CLINIC"),0),"^")
"RTN","PSOORED1",104,0)
 S PSORENW("PATIENT STATUS")=$S($G(PSORENW("PATIENT STATUS")):PSORENW("PATIENT STATUS"),'$P(PSORENW("RX0"),"^",3):$G(^PS(55,PSORENW("PSODFN"),"PS")),1:$P(PSORENW("RX0"),"^",3))
"RTN","PSOORED1",105,0)
 S PSORENW("PTST NODE")=$G(^PS(53,PSORENW("PATIENT STATUS"),0))
"RTN","PSOORED1",106,0)
 S PSDAYS=$S($G(PSORENW("DAYS SUPPLY")):PSORENW("DAYS SUPPLY"),'$P(PSORENW("RX0"),"^",8):$P(PSORENW("PTST NODE"),"^",3),1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",107,0)
 I $G(PSODRUG("IEN")) S DREN=PSODRUG("IEN"),POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORED1",108,0)
 D:$G(PSORENW("# OF REFILLS"))']"" RF
"RTN","PSOORED1",109,0)
 S PSORENW("MAIL/WINDOW")=$S($G(PSORENW("MAIL/WINDOW"))]"":PSORENW("MAIL/WINDOW"),1:$P(PSORENW("RX0"),"^",11))
"RTN","PSOORED1",110,0)
 S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="W":"WINDOW",1:"MAIL")
"RTN","PSOORED1",111,0)
 S PSORENW("COPIES")=$S($G(PSORENW("COPIES")):PSORENW("COPIES"),$P(PSORENW("RX0"),"^",18):$P(PSORENW("RX0"),"^",18),1:1)
"RTN","PSOORED1",112,0)
 S PSORENW("CLERK CODE")=DUZ
"RTN","PSOORED1",113,0)
 S:$G(PSORX("CLERK CODE"))']"" PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^")
"RTN","PSOORED1",114,0)
 Q:$D(COPY)  S PSORENW("ENT")=0 ;Q:$G(PSOSIGFL)!($D(COPY))
"RTN","PSOORED1",115,0)
 K PSORENW("ENT") F I=0:0 S I=$O(PSORENW("DOSE",I)) Q:'I  S PSORENW("ENT")=$G(PSORENW("ENT"))+1
"RTN","PSOORED1",116,0)
 I $O(^TMP($J,"INS1",0)) D
"RTN","PSOORED1",117,0)
 .K PSORXED("SIG"),DD
"RTN","PSOORED1",118,0)
 .F I=0:0 S I=$O(^TMP($J,"INS1",I)) Q:'I  S PSORENW("SIG",I)=^TMP($J,"INS1",I,0)
"RTN","PSOORED1",119,0)
 .K ^TMP($J,"INS1")
"RTN","PSOORED1",120,0)
 I $G(^PSRX(PSORENW("IRXN"),"INS"))]"" S PSORENW("INS")=^PSRX(PSORENW("IRXN"),"INS")
"RTN","PSOORED1",121,0)
 I $G(^PSRX(PSORENW("IRXN"),"INSS"))]"" S PSORENW("SINS")=^PSRX(PSORENW("IRXN"),"INSS")
"RTN","PSOORED1",122,0)
 I '$G(PSORENW("ENT")),'$G(PSOSIGFL) D DOLST1^PSOORED3(.PSORENW) S PSORENW("ENT")=+$G(OLENT)
"RTN","PSOORED1",123,0)
 Q
"RTN","PSOORED1",124,0)
RF ;# of refills
"RTN","PSOORED1",125,0)
 S PTRF=$S($P(PSORENW("PTST NODE"),"^",4)]"":$P(PSORENW("PTST NODE"),"^",4),1:11)
"RTN","PSOORED1",126,0)
 S CS=0 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S CS=1
"RTN","PSOORED1",127,0)
 I CS D
"RTN","PSOORED1",128,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOX=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOORED1",129,0)
 .S PSOX=$S('PSOX:0,PSDAYS=90:1,1:PSOX),PSDY1=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0) S PSORENW("# OF REFILLS")=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORED1",130,0)
 E  D
"RTN","PSOORED1",131,0)
 .S PSOX1=PTRF,PSOX=$S(PSOX1=11:11,1:PSOX1),PSOX=$S('PSOX:0,PSDAYS=90:3,1:PSOX)
"RTN","PSOORED1",132,0)
 .S PSDY1=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0) S PSORENW("# OF REFILLS")=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORED1",133,0)
 I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F") S PSORENW("# OF REFILLS")=0
"RTN","PSOORED1",134,0)
 K PSDY,PSDY1,PTRF,PSOX,PSOX1,PSDAYS,CS
"RTN","PSOORED1",135,0)
 Q
"RTN","PSOORED1",136,0)
UPMI ;add dosing data for pre-poe rxs
"RTN","PSOORED1",137,0)
 W !! K PSONEW("DFLG"),DIR,DIRUT,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Dosing Instructions Are Missing!! Do You Want to Add Them"
"RTN","PSOORED1",138,0)
 D ^DIR I 'Y!($D(DIRUT)) S QUIT=1 K DIR,DIRUT,DUOT,DUOUT Q
"RTN","PSOORED1",139,0)
 S UPMI=1,EDTHLD=$G(PSORX("EDIT")) K PSORX("EDIT")
"RTN","PSOORED1",140,0)
 D DOSE1^PSOORED5(.PSORXED) S (PSORXED,PSORX("EDIT"))=EDTHLD K EDTHLD I $G(PSONEW("DFLG")) S QUIT=1
"RTN","PSOORED1",141,0)
 Q
"RTN","PSOORED6")
0^77^B61440766^B59169980
"RTN","PSOORED6",1,0)
PSOORED6 ;BIR/SAB - edit orders from backdoor ;03/06/96
"RTN","PSOORED6",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**78,104,117,133,143,219,148,247,268**;DEC 1997;Build 9
"RTN","PSOORED6",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORED6",4,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED6",5,0)
 ;External reference ^PS(50.606 supported by DBIA 2174
"RTN","PSOORED6",6,0)
DRG ;select drug
"RTN","PSOORED6",7,0)
 S PSORX("EDIT")=1,RX0HLD=RX0
"RTN","PSOORED6",8,0)
 S PSODRUG("IEN")=$S($G(PSODRUG("IEN"))]"":PSODRUG("IEN"),1:$P(RX0,"^",6)),PSODRUG("NAME")=$S($G(PSODRUG("NAME"))]"":PSODRUG("NAME"),1:$P(^PSDRUG($P(RX0,"^",6),0),"^"))
"RTN","PSOORED6",9,0)
 D ^PSODRG I PSODRUG("IEN")=$P(RX0,"^",6) K PSORXED("FLD",6)
"RTN","PSOORED6",10,0)
 D:PSODRUG("IEN")'=$P(RX0,"^",6)  I $G(PSORX("DFLG")) K PSORXED("FLD",6) S PSORXED("DFLG")=1 Q
"RTN","PSOORED6",11,0)
 .D POST^PSODRG
"RTN","PSOORED6",12,0)
 .I '$O(^PSRX(PSORXED("IRXN"),1,0)) S PSORXED("FLD",17)=$G(PSODRUG("COST"))
"RTN","PSOORED6",13,0)
 .I $G(PSORX("DFLG")) K PSORXED("FLD",6),PSODRUG,PSOOIFLG,PSOSIGFL,VALMSG Q
"RTN","PSOORED6",14,0)
 .D KV S DIR(0)="Y",DIR("B")="YES"
"RTN","PSOORED6",15,0)
 .S DIR("A",1)="You have changed the dispense drug from"
"RTN","PSOORED6",16,0)
 .S DIR("A",2)=$P(^PSDRUG($P(PSORXED("RX0"),"^",6),0),"^")_" to "_$P(^PSDRUG(PSODRUG("IEN"),0),"^")_"."
"RTN","PSOORED6",17,0)
 .I $P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^",2),$O(^PSRX(PSORXED("IRXN"),"SIG1",0)) S DIR("A",3)="" D
"RTN","PSOORED6",18,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S DIR("A",3+I)=$S(I=1:"Current SIG: ",1:"")_$G(^PSRX(PSORXED("IRXN"),"SIG1",I,0))
"RTN","PSOORED6",19,0)
 .S DIR("A")="Do You want to Edit the SIG"
"RTN","PSOORED6",20,0)
 .D ^DIR K DIR I $D(DIRUT) S PSORX("DFLG")=1 D M1
"RTN","PSOORED6",21,0)
 .Q:$D(DIRUT)!('Y)
"RTN","PSOORED6",22,0)
 .S PSOREEDQ=1 D DOLST^PSOORED3,DOSE^PSOORED3 K PSOREEDQ
"RTN","PSOORED6",23,0)
 .I '$O(PSORXED("DOSE",0)) S PSORX("DFLG")=1 Q
"RTN","PSOORED6",24,0)
 .D:$G(PSOSIGFL) M2
"RTN","PSOORED6",25,0)
 S RX0=RX0HLD K RX0HLD I $G(PSODRUG("OI"))=$G(PSOI) D  Q
"RTN","PSOORED6",26,0)
 .D:$O(^TMP("PSORXDC",$J,0))
"RTN","PSOORED6",27,0)
 ..W !!,"This edit will discontinue the duplicate Rx & change the dispensed drug!"
"RTN","PSOORED6",28,0)
 ..K DIR,X,Y S DIR("A")="Do You Want to Proceed",DIR("B")="NO",DIR(0)="Y"
"RTN","PSOORED6",29,0)
 ..D ^DIR K DIR S:'Y!($D(DIRUT)) PSORXED("DFLG")=1 D:Y DCORD^PSONEW2
"RTN","PSOORED6",30,0)
 .Q:$G(PSORXED("DFLG"))
"RTN","PSOORED6",31,0)
 .I PSODRUG("IEN")'=$P(RX0,"^",6) D
"RTN","PSOORED6",32,0)
 ..S PSORXED("FLD",6)=PSODRUG("IEN"),PSORXED("FLD",39.2)=PSOI
"RTN","PSOORED6",33,0)
 .S:$G(PSODRUG("TRADE NAME"))]"" PSORXED("FLD",6.5)=PSODRUG("TRADE NAME")
"RTN","PSOORED6",34,0)
 .S:$G(PSODRUG("NDC"))]"" PSORXED("FLD",27)=PSODRUG("NDC")
"RTN","PSOORED6",35,0)
 .S:$G(PSODRUG("DAW"))]"" PSORXED("FLD",81)=PSODRUG("DAW")
"RTN","PSOORED6",36,0)
 W !!,"New Orderable Item selected. This edit will create a new prescription!",! D PAUSE^VALM1 S VALMSG="New Orderable Item selected. This edit will create a new prescription!" S (PSOOIFLG,PSOSIGFL)=1
"RTN","PSOORED6",37,0)
 Q
"RTN","PSOORED6",38,0)
PSOCOU ;patient counseling
"RTN","PSOORED6",39,0)
 K DIC,DIQ S DIC=52,DA=PSORXED("IRXN"),DIQ="PSORXED",DR=41 D EN^DIQ1 K DIC,DIQ
"RTN","PSOORED6",40,0)
 D KV S DIR(0)="52,41" S:$G(PSORXED(52,DA,DR))]"" DIR("B")=PSORXED(52,DA,DR) D ^DIR K DIR,PSORXED(52,DA,DR)
"RTN","PSOORED6",41,0)
 I $D(DIRUT) K PSORXED("FLD",41) D KV Q
"RTN","PSOORED6",42,0)
 S PSORXED("FLD",DR)=Y D  K DIRUT
"RTN","PSOORED6",43,0)
 .I Y D  Q
"RTN","PSOORED6",44,0)
 ..K DIC,DIQ S DIC=52,DA=PSORXED("IRXN"),DIQ="PSORXED",DR=42 D EN^DIQ1 K DIC,DIQ
"RTN","PSOORED6",45,0)
 ..K DIR,DIRUT S DIR(0)="52,42" S:$G(PSORXED(52,DA,DR))]"" DIR("B")=PSORXED(52,DA,DR) D ^DIR K DIR,PSORXED(52,DA,DR)
"RTN","PSOORED6",46,0)
 ..I $D(DIRUT) K PSORXED("FLD",41),DUOUT,DTOUT Q
"RTN","PSOORED6",47,0)
 ..S PSORXED("FLD",42)=Y
"RTN","PSOORED6",48,0)
 .S PSORXED("FLD",41)=0,PSORXED("FLD",42)="@"
"RTN","PSOORED6",49,0)
 Q
"RTN","PSOORED6",50,0)
PSOI ;select orderable item
"RTN","PSOORED6",51,0)
 W !!,"Current Orderable Item: "_$P(^PS(50.7,PSOI,0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")
"RTN","PSOORED6",52,0)
 S DIC("B")=$P(^PS(50.7,PSOI,0),"^"),DIC="^PS(50.7,",DIC(0)="AEMQZ"
"RTN","PSOORED6",53,0)
 S DIC("S")="I '$P(^PS(50.7,+Y,0),""^"",4)!($P(^(0),""^"",4)'<DT) N PSOF,PSOL S (PSOF,PSOL)=0 F  S PSOL=$O(^PSDRUG(""ASP"",+Y,PSOL)) Q:PSOF!'PSOL  "
"RTN","PSOORED6",54,0)
 S DIC("S")=DIC("S")_"I $P($G(^PSDRUG(PSOL,2)),U,3)[""O"",'$G(^(""I""))!($G(^(""I""))'<DT) S PSOF=1" D ^DIC I "^"[X S PSORXED("DFLG")=1 Q
"RTN","PSOORED6",55,0)
 G:Y<1 PSOI Q:PSOI=+Y
"RTN","PSOORED6",56,0)
 S PSODRUG("OI")=+Y,PSODRUG("OIN")=Y(0,0) K DIC
"RTN","PSOORED6",57,0)
 I PSOI'=PSODRUG("OI") W !!,"New Orderable Item selected. This edit will create a new prescription!",! D  K PSHOLDD Q
"RTN","PSOORED6",58,0)
 .D PAUSE^VALM1,M2
"RTN","PSOORED6",59,0)
 .S PSHOLDD=$G(PSODRUG("IEN")) K PSODRUG("IEN"),PSODRUG("NAME") S PSODRUG("DEA")="",(PSOOIFLG,PSOSIGFL)=1
"RTN","PSOORED6",60,0)
 .D DREN^PSOORNW2
"RTN","PSOORED6",61,0)
 .I $G(PSHOLDD),$G(PSODRUG("IEN")),$G(PSHOLDD)'=$G(PSODRUG("IEN")) D  Q:$G(PSORX("DFLG"))
"RTN","PSOORED6",62,0)
 ..D FULL^VALM1,POST^PSODRG S VALMBCK="R"
"RTN","PSOORED6",63,0)
 ..I $G(PSORX("DFLG")) K PSODRUG S PSODRUG("IEN")=$G(PSHOLDD),PSODRUG("NAME")=$P($G(^PSDRUG(PSODRUG("IEN"),0)),"^") K PSOOIFLG,PSOSIGFL S VALMSG=""
"RTN","PSOORED6",64,0)
 .I '$G(PSODRUG("IEN")) W !!,"DRUG NAME REQUIRED!" D 2^PSOORNW1
"RTN","PSOORED6",65,0)
 .I '$G(PSODRUG("IEN")) K PSORXED("FLD"),INDEL,^TMP($J,"INS1"),PSOSIGFL,VALMSG S PSORXED("DFLG")=1,VALMSG="Dispense Drug NOT Selected!" Q
"RTN","PSOORED6",66,0)
 .D KV S DIR(0)="Y",DIR("B")="NO",DIR("A",1)="You have changed the Orderable Item from",DIR("A",2)=$P(^PS(50.7,PSOI,0),"^")_" to "_PSODRUG("OIN")_".",DIR("A")="Do You want to Edit the SIG"
"RTN","PSOORED6",67,0)
 .D ^DIR K DIR I $D(DIRUT) K PSODRUG("OIN"),PSOOIFLG,PSOSIGFL S PSODRUG("OI")=PSOI,VALMSG="",PSORX("DFLG")=1 Q
"RTN","PSOORED6",68,0)
 .I 'Y S PSORX("DFLG")=1 Q
"RTN","PSOORED6",69,0)
 .S PSOREEDQ=1 D DOLST^PSOORED3,DOSE^PSOORED3 K PSOREEDQ
"RTN","PSOORED6",70,0)
 .I '$O(PSORXED("DOSE",0)) S PSORX("DFLG")=1 Q
"RTN","PSOORED6",71,0)
 .D:$G(PSOSIGFL) M2
"RTN","PSOORED6",72,0)
 S PSORXED("FLD",39.2)=PSOI
"RTN","PSOORED6",73,0)
 Q
"RTN","PSOORED6",74,0)
NCPDP ;Reverse previously billed Rx on an edited orderable item or drug. 
"RTN","PSOORED6",75,0)
 N RX,NPSOY
"RTN","PSOORED6",76,0)
 S RX=$G(PSORXED("IRXN")) I RX="" D
"RTN","PSOORED6",77,0)
 . S NPSOY=$O(PSONEW("OLD LAST RX#","")),NPSOY=$G(PSONEW("OLD LAST RX#",NPSOY)),RX=$O(^PSRX("B",NPSOY,RX))
"RTN","PSOORED6",78,0)
 I 'RX Q
"RTN","PSOORED6",79,0)
 D REVERSE^PSOBPSU1(RX,,"DC",7) S NCPDPFLG=0
"RTN","PSOORED6",80,0)
 Q
"RTN","PSOORED6",81,0)
UPDATE ;add new data to file
"RTN","PSOORED6",82,0)
 N RXREF,UPDATE,FLDS,CHGNDC
"RTN","PSOORED6",83,0)
 Q:'$G(PSORXED("IRXN"))
"RTN","PSOORED6",84,0)
 I $O(PSORXED("FLD",0))!($G(^TMP($J,"INS1",0))]"")!($G(INSDEL))!($O(PSORXED("ODOSE",0))) D  G:'Y UPDX
"RTN","PSOORED6",85,0)
 .K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED6",86,0)
 .S DIR(0)="Y",DIR("A")="Are You Sure You Want to Update Rx "_$P(^PSRX(PSORXED("IRXN"),0),"^"),DIR("B")="Yes"
"RTN","PSOORED6",87,0)
 .D ^DIR K DIR I 'Y D M1 Q
"RTN","PSOORED6",88,0)
 .I $D(^PSRX(PSORXED("IRXN"),1,0))  D
"RTN","PSOORED6",89,0)
 ..S RXREF=$P(^PSRX(PSORXED("IRXN"),0),"^",9)-$P(^PSRX(PSORXED("IRXN"),1,0),"^",4)
"RTN","PSOORED6",90,0)
 .E  S RXREF=0
"RTN","PSOORED6",91,0)
 .K X,DIRUT,DUOUT,DTOUT
"RTN","PSOORED6",92,0)
 I $D(PSORXED("FLD",39.3)) D UPDATE^PSODIAG  ;update ICD's after edit
"RTN","PSOORED6",93,0)
 ; - Retrieving fields before changes that are relevant for 3rd Party Billing
"RTN","PSOORED6",94,0)
 D GETS^DIQ(52,PSORXED("IRXN")_",","4;7;8;20;22;27;81","I","FLDS")
"RTN","PSOORED6",95,0)
 K Y S DA=PSORXED("IRXN"),DIE="^PSRX(",FLD=0
"RTN","PSOORED6",96,0)
 F  S FLD=$O(PSORXED("FLD",FLD)) Q:'FLD  D
"RTN","PSOORED6",97,0)
 .I FLD=12!(FLD=24)!(FLD=35) D  Q
"RTN","PSOORED6",98,0)
 ..I FLD=12,PSORXED("FLD",12)="@" S $P(^PSRX(DA,3),"^",7)="" Q
"RTN","PSOORED6",99,0)
 ..I FLD=12,PSORXED("FLD",12)]"" S $P(^PSRX(DA,3),"^",7)=PSORXED("FLD",12) Q
"RTN","PSOORED6",100,0)
 ..I FLD=24,PSORXED("FLD",24)="@" S $P(^PSRX(DA,2),"^",4)="" Q
"RTN","PSOORED6",101,0)
 ..I FLD=24,PSORXED("FLD",24)]"" S $P(^PSRX(DA,2),"^",4)=PSORXED("FLD",24) Q
"RTN","PSOORED6",102,0)
 ..I FLD=35,PSORXED("FLD",35)="@" S $P(^PSRX(DA,"MP"),"^")="" Q
"RTN","PSOORED6",103,0)
 ..I FLD=35,PSORXED("FLD",35)]"" S $P(^PSRX(DA,"MP"),"^")=PSORXED("FLD",35) Q
"RTN","PSOORED6",104,0)
 .I FLD=114 D  Q
"RTN","PSOORED6",105,0)
 ..I PSORXED("FLD",114)="@" K ^PSRX(DA,"INS"),^PSRX(DA,"INS1")
"RTN","PSOORED6",106,0)
 ..I PSORXED("FLD",114)'="@" D
"RTN","PSOORED6",107,0)
 ...S ^PSRX(DA,"INS")=PSORXED("FLD",114)
"RTN","PSOORED6",108,0)
 ...S X=PSORXED("FLD",114) D SIG^PSOHELP Q:$G(INS1)']""
"RTN","PSOORED6",109,0)
 ...S PSORXED("SIG",1)=$E(INS1,2,9999999) K ^PSRX(DA,"INS1")
"RTN","PSOORED6",110,0)
 ...S ^PSRX(DA,"INS1",0)="^52.0115^1^1^"_DT_"^^"
"RTN","PSOORED6",111,0)
 ...S ^PSRX(DA,"INS1",1,0)=PSORXED("SIG",1)
"RTN","PSOORED6",112,0)
 ..D DOLST^PSOORED3 K:PSORXED("FLD",114)="@" PSORXED("SIG") D EN^PSOFSIG(.PSORXED),UPDSIG^PSOORED3
"RTN","PSOORED6",113,0)
 .I FLD=27 D  Q
"RTN","PSOORED6",114,0)
 ..I PSORXED("FLD",27)'=$$GETNDC^PSONDCUT(DA,0) S CHGNDC=1
"RTN","PSOORED6",115,0)
 ..D SAVNDC^PSONDCUT(DA,0,PSORXED("FLD",27),0,1)
"RTN","PSOORED6",116,0)
 .I FLD=81 D SAVDAW^PSODAWUT(DA,0,PSORXED("FLD",81)) Q
"RTN","PSOORED6",117,0)
 .S DR=FLD_"////"_PSORXED("FLD",FLD) D ^DIE
"RTN","PSOORED6",118,0)
 .I FLD=4 D UDPROV^PSOOREDT Q
"RTN","PSOORED6",119,0)
 ;
"RTN","PSOORED6",120,0)
 ; - Re-submitting Rx to ECME due to edits
"RTN","PSOORED6",121,0)
 D RESUB^PSOORED7
"RTN","PSOORED6",122,0)
 ;
"RTN","PSOORED6",123,0)
 I $G(INSDEL) K ^PSRX(DA,"INS"),^PSRX(DA,"INS1") D DOLST^PSOORED3 K PSORXED("SIG") D EN^PSOFSIG(.PSORXED),UPDSIG^PSOORED3 G UPDX
"RTN","PSOORED6",124,0)
 I $O(^TMP($J,"INS1",0)) D
"RTN","PSOORED6",125,0)
 .K ^PSRX(DA,"INS"),^PSRX(DA,"INS1"),DD,PSORXED("SIG")
"RTN","PSOORED6",126,0)
 .F I=0:0 S I=$O(^TMP($J,"INS1",I)) Q:'I  S (PSORXED("SIG",I),^PSRX(DA,"INS1",I,0))=^TMP($J,"INS1",I,0),DD=$G(DD)+1
"RTN","PSOORED6",127,0)
 .S ^PSRX(DA,"INS1",0)=^TMP($J,"INS1",0)
"RTN","PSOORED6",128,0)
 .I DD=1 S ^PSRX(DA,"INS")=^PSRX(DA,"INS1",1,0)
"RTN","PSOORED6",129,0)
 .D DOLST^PSOORED3,EN^PSOFSIG(.PSORXED),UPDSIG^PSOORED3
"RTN","PSOORED6",130,0)
 ;
"RTN","PSOORED6",131,0)
UPDX ;
"RTN","PSOORED6",132,0)
 K DIE,DA,DR,FLD,X,Y,PSORXED("FLD"),DD,^TMP($J,"INS1")
"RTN","PSOORED6",133,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOORED6",134,0)
 Q
"RTN","PSOORED6",135,0)
UPD ;updates dosing array
"RTN","PSOORED6",136,0)
 S HENT=ENT
"RTN","PSOORED6",137,0)
UPD1 ;
"RTN","PSOORED6",138,0)
 I $G(PSORXED("CONJUNCTION",(HENT+1)))]"" S PSORXED("CONJUNCTION",HENT)=PSORXED("CONJUNCTION",(HENT+1)) D  G UPD
"RTN","PSOORED6",139,0)
 .K PSORXED("CONJUNCTION",(HENT+1))
"RTN","PSOORED6",140,0)
 .I $D(PSORXED("DOSE",(HENT+2))) D
"RTN","PSOORED6",141,0)
 ..S PSORXED("DOSE",(HENT+1))=PSORXED("DOSE",(HENT+2))
"RTN","PSOORED6",142,0)
 ..S PSORXED("ODOSE",(HENT+1))=$G(PSORXED("ODOSE",(HENT+2)))
"RTN","PSOORED6",143,0)
 ..S PSORXED("DOSE ORDERED",(HENT+1))=$G(PSORXED("DOSE ORDERED",(HENT+2)))
"RTN","PSOORED6",144,0)
 ..S PSORXED("UNITS",(HENT+1))=$G(PSORXED("UNITS",(HENT+2)))
"RTN","PSOORED6",145,0)
 ..S PSORXED("NOUN",(HENT+1))=$G(PSORXED("NOUN",(HENT+2)))
"RTN","PSOORED6",146,0)
 ..S PSORXED("DURATION",(HENT+1))=$G(PSORXED("DURATION",(HENT+2)))
"RTN","PSOORED6",147,0)
 ..S PSORXED("CONJUNCTION",(HENT+1))=$G(PSORXED("CONJUNCTION",(HENT+2)))
"RTN","PSOORED6",148,0)
 ..S PSORXED("ROUTE",(HENT+1))=$G(PSORXED("ROUTE",(HENT+2)))
"RTN","PSOORED6",149,0)
 ..S PSORXED("SCHEDULE",(HENT+1))=$G(PSORXED("SCHEDULE",(HENT+2)))
"RTN","PSOORED6",150,0)
 ..S PSORXED("VERB",(HENT+1))=$G(PSORXED("VERB",(HENT+2)))
"RTN","PSOORED6",151,0)
 ..K PSORXED("DOSE",(HENT+2)),PSORXED("ODOSE",(HENT+2)),PSORXED("DOSE ORDERED",(HENT+2))
"RTN","PSOORED6",152,0)
 ..K PSORXED("UNITS",(HENT+2)),PSORXED("NOUN",(HENT+2)),PSORXED("DURATION",(HENT+2)),PSORXED("ROUTE",(HENT+2)),PSORXED("SCHEDULE",(HENT+2)),PSORXED("VERB",(HENT+2))
"RTN","PSOORED6",153,0)
 .S HENT=HENT+1
"RTN","PSOORED6",154,0)
 F I=0:0 S I=$O(PSORXED("DOSE",I)) Q:'I  S SENT=$G(SENT)+1
"RTN","PSOORED6",155,0)
 Q
"RTN","PSOORED6",156,0)
 ;
"RTN","PSOORED6",157,0)
M1 D M1^PSOOREDX
"RTN","PSOORED6",158,0)
 Q
"RTN","PSOORED6",159,0)
M2 D M2^PSOOREDX
"RTN","PSOORED6",160,0)
 Q
"RTN","PSOORNE5")
0^40^B59982805^B59135982
"RTN","PSOORNE5",1,0)
PSOORNE5 ;BIR/SAB - display orders from backdoor con't ;5/23/05 1:46pm
"RTN","PSOORNE5",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,32,46,78,99,117,131,146,171,180,210,222,268**;DEC 1997;Build 9
"RTN","PSOORNE5",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOORNE5",4,0)
 ;External references L and UL^PSSLOCK supported by DBIA 2789
"RTN","PSOORNE5",5,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOORNE5",6,0)
 ;External reference to ^PS(50.607 supported by DBIA 2221
"RTN","PSOORNE5",7,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORNE5",8,0)
 ;called from PSOORNE2
"RTN","PSOORNE5",9,0)
 ;PSO*210 add call to WORDWRAP api
"RTN","PSOORNE5",10,0)
 ;
"RTN","PSOORNE5",11,0)
PEN ;pending orders
"RTN","PSOORNE5",12,0)
 K ^TMP("PSOPO",$J),PSORX("ISSUE DATE"),PSORX("FILL DATE") S ORSV=ORD,ORD=$P(PSOLST(ORN),"^",2)
"RTN","PSOORNE5",13,0)
 I $P($G(^PS(52.41,ORD,0)),"^",3)="DC"!($P($G(^(0)),"^",3)="DE") S VALMBCK="R" Q
"RTN","PSOORNE5",14,0)
 I $G(PSODFN)'=$P($G(^PS(52.41,ORD,0)),"^",2) S VALMBCK="" Q
"RTN","PSOORNE5",15,0)
 I $G(PSOTPBFG) N PSOTPPEN,PSOTPPEX S PSOTPPEN=ORD,PSOTPPEX=0 D VOPNR^PSOTPCAN I PSOTPPEX K PSOTPPEX,PSOTPPEN S VALMBCK="R" Q
"RTN","PSOORNE5",16,0)
 K PSOTPPEX,PSOTPPEN
"RTN","PSOORNE5",17,0)
 ;I '$G(PSOTPBFG) D DSPL^PSOTPCAN(ORD)
"RTN","PSOORNE5",18,0)
 ;S X=PSODFN_";DPT(" D LK^ORX2 I 'Y S VALMSG="Another person is entering orders for this patient.",VALMBCK="" Q
"RTN","PSOORNE5",19,0)
 I '$G(PSOFIN) S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient."),VALMBCK="" K PSOPLCK Q
"RTN","PSOORNE5",20,0)
 K PSOPLCK ; D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)_"S") I '$G(PSOMSG) S VAMLSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),PSOACT="" K PSOMSG G OK ;VALMBCK="" Q
"RTN","PSOORNE5",21,0)
 S PSODRG=+$P($G(^PS(52.41,ORD,0)),"^",9) I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S VALMSG="This Drug has been Inactivated."
"RTN","PSOORNE5",22,0)
 K PSOMSG S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEF",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORNE5",23,0)
OK S PAT=PSODFN,PSORNSV=ORN,PSORNLT=PSLST D ORD^PSOORFIN S PSLST=PSORNLT,ORD=ORSV,ORN=PSORNSV K ORSV,PSORNSV,PSORNLT,PSODRUG S VALMBCK="R"
"RTN","PSOORNE5",24,0)
 K ORCHK,ORDRG,PSOFDR,SIGOK,PSONEW,PSORX("ISSUE DATE"),PSORX("FILL DATE"),PSORX("FN")
"RTN","PSOORNE5",25,0)
 K:'$G(MEDP) PAT
"RTN","PSOORNE5",26,0)
 D CLEAN^PSOVER1 ;S X=PSODFN_";DPT(" D ULK^ORX2
"RTN","PSOORNE5",27,0)
 I '$G(PSOFIN) D UL^PSSLOCK(PSODFN)
"RTN","PSOORNE5",28,0)
 Q
"RTN","PSOORNE5",29,0)
RXNCHK S PSOY=$O(PSONEW("OLD LAST RX#","")) I PSOY="" D AUTO^PSONRXN Q
"RTN","PSOORNE5",30,0)
 S PSONRXN("TYPE")=$S('+$G(^PS(59,+PSOSITE,2)):8,PSODRUG("DEA")["A"&(+$G(^PS(59,+PSOSITE,2))):3,1:8)
"RTN","PSOORNE5",31,0)
 S PSONEW("QFLG")=0 I PSOY'=PSONRXN("TYPE"),$P($G(PSOPAR),"^",7)=1 D
"RTN","PSOORNE5",32,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORNE5",33,0)
 .L +^PS(59,+PSOSITE,PSOY):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORNE5",34,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORNE5",35,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORNE5",36,0)
 .L +^PS(59,+PSOSITE,PSONRXN("TYPE")):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOORNE5",37,0)
 .S PSOX1=^PS(59,+PSOSITE,PSONRXN("TYPE")),PSONRXN("LO")=$P(PSOX1,"^")
"RTN","PSOORNE5",38,0)
 .S PSONRXN("HI")=$P(PSOX1,"^",2),PSOI=$P(PSOX1,"^",3),PSONEW("OLD LAST RX#",PSONRXN("TYPE"))=PSOI
"RTN","PSOORNE5",39,0)
 .S:PSOI<PSONRXN("LO") PSOI=PSONRXN("LO")
"RTN","PSOORNE5",40,0)
 .D LOOP2 I PSONEW("QFLG") L -^PS(59,+PSOSITE,PSONRXN("TYPE")),-^PSRX("B",PSOI) Q
"RTN","PSOORNE5",41,0)
 .K DIC,DIE,DA S DIE=59,DA=PSOSITE
"RTN","PSOORNE5",42,0)
 .S DR=$S(PSONRXN("TYPE")=8:"2003////"_PSOI,PSONRXN("TYPE")=3:"1002.1////"_PSOI,1:"2003////"_PSOI)
"RTN","PSOORNE5",43,0)
 .S PSONEW("RX #")=PSOI D ^DIE K DIE,DIC,DR,DA L -^PS(59,+PSOSITE,PSONRXN("TYPE"))
"RTN","PSOORNE5",44,0)
 .K PSOX1,PSONRXN,PSOI,X,Y
"RTN","PSOORNE5",45,0)
 Q
"RTN","PSOORNE5",46,0)
LOOP2 F  S PSOI=PSOI+1 D:PSOI>PSONRXN("HI") FATAL^PSONRXN Q:'$D(^PSRX("B",PSOI))!PSONEW("QFLG")
"RTN","PSOORNE5",47,0)
 L +^PSRX("B",PSOI):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I $D(^PSRX("B",PSOI))!'$T G LOOP2
"RTN","PSOORNE5",48,0)
 L -^PSRX("B",PSOI)
"RTN","PSOORNE5",49,0)
 Q
"RTN","PSOORNE5",50,0)
RDSPL S PSODIR("CS")=0
"RTN","PSOORNE5",51,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSODIR("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSODIR("CS"),"^",2)=1
"RTN","PSOORNE5",52,0)
 I $P($G(PSODIR("CS")),"^",2)=1 S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=0 Q
"RTN","PSOORNE5",53,0)
 I '$D(CLOZPAT) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F") S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=0 Q
"RTN","PSOORNE5",54,0)
 I $D(CLOZPAT) S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=$S($G(CLOZPAT)=2&(PSONEW("DAYS SUPPLY")=14):1,$G(CLOZPAT)=2&(PSONEW("DAYS SUPPLY")=7):3,$G(CLOZPAT)=1&(PSONEW("DAYS SUPPLY")=7):1,1:0) Q
"RTN","PSOORNE5",55,0)
 I PSODIR("CS") D
"RTN","PSOORNE5",56,0)
 .S PSOX=5,PSOX1=$S($P($G(PSONEW("PTST NODE")),"^",4)>PSOX:PSOX,1:$P($G(PSONEW("PTST NODE")),"^",4)),PSOX=$S(PSOX1=5:PSOX,1:PSOX1)
"RTN","PSOORNE5",57,0)
 .S PSOX=$S('PSOX:0,PSONEW("DAYS SUPPLY")=90:1,1:PSOX),PSDY=PSONEW("DAYS SUPPLY"),PSDY1=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORNE5",58,0)
 .I PSONEW("# OF REFILLS")>PSOX S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=PSOX
"RTN","PSOORNE5",59,0)
 E  D
"RTN","PSOORNE5",60,0)
 .S PSOX=11,PSOX1=$S($P($G(PSONEW("PTST NODE")),"^",4)>PSOX:PSOX,1:$P($G(PSONEW("PTST NODE")),"^",4)),PSOX=$S(PSOX1=11:PSOX,1:PSOX1)
"RTN","PSOORNE5",61,0)
 .S PSDY=PSONEW("DAYS SUPPLY"),PSDY1=$S(PSDY<60:11,PSDY'<60&(PSDY'>89):5,PSDY=90:3,1:0) S PSOX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORNE5",62,0)
 .I PSONEW("# OF REFILLS")>PSOX S (PSONEW("# OF REFILLS"),PSONEW("N# REF"))=PSOX
"RTN","PSOORNE5",63,0)
 Q
"RTN","PSOORNE5",64,0)
GET ;
"RTN","PSOORNE5",65,0)
 I $P(PSODRUG0,"^",3)["2" S (ACTREF,ACTREN)=0 Q
"RTN","PSOORNE5",66,0)
 S (ACTREF,ACTREN)=1
"RTN","PSOORNE5",67,0)
 ;refills
"RTN","PSOORNE5",68,0)
 I ST S ACTREF=0
"RTN","PSOORNE5",69,0)
 I '$P(PSOPAR,"^",11),$G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S ACTREF=0,VALMSG="Inactive Drug, Non Refillable!"
"RTN","PSOORNE5",70,0)
 ;I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" S ACTREF=0
"RTN","PSOORNE5",71,0)
 S PSORFRM=$P(RX0,"^",9) F PSOJ=0:0 S PSOJ=$O(^PSRX(RXN,1,PSOJ)) Q:'PSOJ  S PSORFRM=PSORFRM-1
"RTN","PSOORNE5",72,0)
 S:PSORFRM<0 PSORFRM=0 S:PSORFRM=0 ACTREF=0
"RTN","PSOORNE5",73,0)
 I $G(RXFL(RXN))]"",'$P(PSOPAR,"^",6) S ACTREF=0
"RTN","PSOORNE5",74,0)
 I $P(PSODRUG0,"^",3)["A"&($P(PSODRUG0,"^",3)'["B")!($P(PSODRUG0,"^",3)["F") S ACTREF=0
"RTN","PSOORNE5",75,0)
 ;renews
"RTN","PSOORNE5",76,0)
 I $P(PSOPAR,"^",4)=0 S ACTREN=0 Q
"RTN","PSOORNE5",77,0)
 I $P($G(^PSDRUG(PSODRG,2)),"^",3)'["O" S ACTREN=0
"RTN","PSOORNE5",78,0)
 I $G(^PSDRUG(PSODRG,"I"))]"",DT>$G(^("I")) S ACTREN=0,VALMSG="This Drug has been Inactivated."
"RTN","PSOORNE5",79,0)
 I '$P($G(^PSDRUG(PSODRG,2)),"^"),'$P($G(^PSRX(RXN,"OR1")),"^") S ACTREN=0,VALMSG="Drug must be Matched to an Orderable Item!"
"RTN","PSOORNE5",80,0)
 I $P(PSODRUG0,"^",3)["A",$P(PSODRUG0,"^",3)'["B" S ACTREN=0
"RTN","PSOORNE5",81,0)
 I $P(PSODRUG0,"^",3)["W" S ACTREN=0
"RTN","PSOORNE5",82,0)
 I $D(^PS(53,+$P(RX0,"^",3),0)),'$P(^(0),"^",5) S ACTREN=0
"RTN","PSOORNE5",83,0)
 S PSOLC=$P(RX0,"^"),PSOLC=$E(PSOLC,$L(PSOLC)) I $A(PSOLC)'<90 S ACTREN=0
"RTN","PSOORNE5",84,0)
 I ST,ST'=2,ST'=5,ST'=6,ST'=11,ST'=12 S ACTREN=0
"RTN","PSOORNE5",85,0)
 K PSORFRM,PSOLC,PSODRG,PSODRUG0
"RTN","PSOORNE5",86,0)
 Q
"RTN","PSOORNE5",87,0)
INST ;formats instruction from front door
"RTN","PSOORNE5",88,0)
 D INST^PSOORNE6 Q
"RTN","PSOORNE5",89,0)
PC ;displays provider comments
"RTN","PSOORNE5",90,0)
 D PC^PSOORNE6 Q
"RTN","PSOORNE5",91,0)
INST1 ;formats instruction from front door
"RTN","PSOORNE5",92,0)
 D INST1^PSOORNE6 Q
"RTN","PSOORNE5",93,0)
PC1 ;displays provider comments
"RTN","PSOORNE5",94,0)
 D PC1^PSOORNE6 Q
"RTN","PSOORNE5",95,0)
DOSE ;displays dosing instruction for both simple and complex backdoor Rxs.
"RTN","PSOORNE5",96,0)
 I '$O(^PSRX(RXN,6,0))  S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (3)          Dosage: " Q
"RTN","PSOORNE5",97,0)
 S DS=1 F I=0:0 S I=$O(^PSRX(RXN,6,I)) Q:'I  S DOSE=^PSRX(RXN,6,I,0) D
"RTN","PSOORNE5",98,0)
 .I '$P(DOSE,"^",2),$P(DOSE,"^",9)]"" S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Verb: "_$P(DOSE,"^",9)
"RTN","PSOORNE5",99,0)
 .I $G(DS)=1 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)=" (3)"
"RTN","PSOORNE5",100,0)
 .D DOSE1 S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORNE5",101,0)
 K DOSE,I
"RTN","PSOORNE5",102,0)
 Q
"RTN","PSOORNE5",103,0)
DOSE1 ;
"RTN","PSOORNE5",104,0)
 I $G(DS)=1 S ^TMP("PSOAO",$J,IEN,0)=^TMP("PSOAO",$J,IEN,0)_"         *Dosage: "_$S($E($P(DOSE,"^"),1)="."&($P(DOSE,"^",2)):"0",1:"")_$P(DOSE,"^")_$S($P(DOSE,"^",3)]"":" ("_$P(^PS(50.607,$P(DOSE,"^",3),0),"^")_")",1:"") K DS G DU
"RTN","PSOORNE5",105,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="             *Dosage: "_$S($E($P(DOSE,"^"),1)="."&($P(DOSE,"^",2)):"0",1:"")_$P(DOSE,"^")_$S($P(DOSE,"^",3)]"":" ("_$P(^PS(50.607,$P(DOSE,"^",3),0),"^")_")",1:"")
"RTN","PSOORNE5",106,0)
DU I '$P(DOSE,"^",2),$P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="   Oth. Lang. Dosage: "_$G(^PSRX(RXN,6,I,1))
"RTN","PSOORNE5",107,0)
 I $P(DOSE,"^",2),$P(DOSE,"^",9)]"" D
"RTN","PSOORNE5",108,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Verb: "_$P(DOSE,"^",9)
"RTN","PSOORNE5",109,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="      Dispense Units: "_$S($E($P(DOSE,"^",2),1)=".":"0",1:"")_$P(DOSE,"^",2)
"RTN","PSOORNE5",110,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="                Noun: "_$P(DOSE,"^",4)
"RTN","PSOORNE5",111,0)
 I $P(DOSE,"^",7) S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="              *Route: "_$P(^PS(51.2,$P(DOSE,"^",7),0),"^")
"RTN","PSOORNE5",112,0)
 S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="           *Schedule: "_$P(DOSE,"^",8)
"RTN","PSOORNE5",113,0)
 I $P(DOSE,"^",5)]"" D
"RTN","PSOORNE5",114,0)
 .S DUR=$S($E($P(DOSE,"^",5),1)'?.N:$E($P(DOSE,"^",5),2,99)_$E($P(DOSE,"^",5),1),1:$P(DOSE,"^",5))
"RTN","PSOORNE5",115,0)
 .S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="           *Duration: "_DUR_" ("_$S($P(DOSE,"^",5)["M":"MINUTES",$P(DOSE,"^",5)["H":"HOURS",$P(DOSE,"^",5)["L":"MONTHS",$P(DOSE,"^",5)["W":"WEEKS",1:"DAYS")_")" K DUR
"RTN","PSOORNE5",116,0)
 I $P(DOSE,"^",6)]"" S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="        *Conjunction: "_$S($P(DOSE,"^",6)="A":"AND",$P(DOSE,"^",6)="T":"THEN",$P(DOSE,"^",6)="X":"EXCEPT",1:"")
"RTN","PSOORNE5",117,0)
 Q
"RTN","PSOORNE5",118,0)
INS ;patient instructions                                        ;PSO*210
"RTN","PSOORNE5",119,0)
 I $G(^PSRX(RXN,"INS"))]"",'$O(^PSRX(RXN,"INS1",0)) D  K SG G SPINS
"RTN","PSOORNE5",120,0)
 .S PSORXED("SIG",1)=^PSRX(RXN,"INS")
"RTN","PSOORNE5",121,0)
 .D WORDWRAP^PSOUTLA2(^PSRX(RXN,"INS"),.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE5",122,0)
 ;
"RTN","PSOORNE5",123,0)
 I $O(^PSRX(RXN,"INS1",0)) D
"RTN","PSOORNE5",124,0)
 .S T=0 F  S T=$O(^PSRX(RXN,"INS1",T)) Q:'T  D
"RTN","PSOORNE5",125,0)
 .. S (PSORXED("SIG",T),MIG)=^PSRX(RXN,"INS1",T,0)
"RTN","PSOORNE5",126,0)
 .. D WORDWRAP^PSOUTLA2(MIG,.IEN,$NA(^TMP("PSOAO",$J)),21)
"RTN","PSOORNE5",127,0)
SPINS K T,SG,MIG
"RTN","PSOORNE5",128,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") S IEN=IEN+1,^TMP("PSOAO",$J,IEN,0)="  Other Pat. Instruc: "_$S($G(^PSRX(RXN,"INSS"))]"":^PSRX(RXN,"INSS"),1:"")
"RTN","PSOORNE5",129,0)
 Q
"RTN","PSOORNE5",130,0)
SV S VALMSG="Pre-POE Rx. Please Compare Dosing Fields with SIG!"
"RTN","PSOORNE5",131,0)
 Q
"RTN","PSOORNW1")
0^72^B42982549^B42999566
"RTN","PSOORNW1",1,0)
PSOORNW1 ;ISC BHAM/SAB - continuation of finish of new order ;07/19/96 12:58 PM
"RTN","PSOORNW1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,46,78,117,131,133,172,148,222,268**;DEC 1997;Build 9
"RTN","PSOORNW1",3,0)
 ;Reference ^YSCL(603.01 supported by DBIA 2697
"RTN","PSOORNW1",4,0)
 ;Reference ^PS(55 supported by DBIA 2228
"RTN","PSOORNW1",5,0)
 ;Reference ^PSDRUG( supported by DBIA 221
"RTN","PSOORNW1",6,0)
 ;Reference to $$GETNDC^PSSNDCUT supported by IA 4707
"RTN","PSOORNW1",7,0)
 ;
"RTN","PSOORNW1",8,0)
2 I $G(ORD) W !!,"Instructions: " D
"RTN","PSOORNW1",9,0)
 .S INST=0 F  S INST=$O(^PS(52.41,ORD,2,INST)) Q:'INST  S (MIG,INST(INST))=^PS(52.41,ORD,2,INST,0) D
"RTN","PSOORNW1",10,0)
 ..F SG=1:1:$L(MIG," ") W:$X+$L($P(MIG," ",SG)_" ")>IOM !?14 W $P(MIG," ",SG)_" "
"RTN","PSOORNW1",11,0)
 .S:'$D(PSODRUG("OI")) PSODRUG("OI")=$P(OR0,"^",8)
"RTN","PSOORNW1",12,0)
 .K INST,TY,MIG,SG
"RTN","PSOORNW1",13,0)
 S (PSDC,PSI)=0 W !!,"The following Drug(s) are available for selection:"
"RTN","PSOORNW1",14,0)
 F PSI=0:0 S PSI=$O(^PSDRUG("ASP",PSODRUG("OI"),PSI)) Q:'PSI  I $S('$D(^PSDRUG(PSI,"I")):1,'^("I"):1,DT'>^("I"):1,1:0),$S($P($G(^PSDRUG(PSI,2)),"^",3)'["O":0,1:1) D
"RTN","PSOORNW1",15,0)
 .S PSDC=PSDC+1 W !,PSDC_". "_$P(^PSDRUG(PSI,0),"^")_$S($P(^(0),"^",9):"     (N/F)",1:"")
"RTN","PSOORNW1",16,0)
 .S PSDC(PSDC)=PSI
"RTN","PSOORNW1",17,0)
 I PSDC=0 D
"RTN","PSOORNW1",18,0)
 . N X,DRG
"RTN","PSOORNW1",19,0)
 . S DRG=+$P($G(^PS(52.41,+$G(ORD),0)),"^",9)
"RTN","PSOORNW1",20,0)
 . S X=$$GET1^DIQ(50,DRG,100)
"RTN","PSOORNW1",21,0)
 . I X'="",(DT>X) D
"RTN","PSOORNW1",22,0)
 . . W !!,"   This Dispense Drug is now Inactive. You may select a"
"RTN","PSOORNW1",23,0)
 . . W !,"    new Orderable Item, or you can enter a new Order with"
"RTN","PSOORNW1",24,0)
 . . W !,"    an Active Drug.",!
"RTN","PSOORNW1",25,0)
 . E  W !!,"No drugs available!",!
"RTN","PSOORNW1",26,0)
 . K DIR S DIR(0)="E",DIR("A")="Press return to continue"
"RTN","PSOORNW1",27,0)
 . D ^DIR K DIR
"RTN","PSOORNW1",28,0)
 G:'PSDC ETX I $G(PSOBDRG),'$D(PSOBDR) M PSOBDR=PSODRUG
"RTN","PSOORNW1",29,0)
 I PSDC'=1 D
"RTN","PSOORNW1",30,0)
 .I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),2)),"^")=$G(PSODRUG("OI")) Q
"RTN","PSOORNW1",31,0)
 .K PSODRUG("NAME"),PSODRUG("IEN")
"RTN","PSOORNW1",32,0)
 W ! D KV S DIR(0)="N^1:"_PSDC,DIR("A")="Select Drug by number" D ^DIR
"RTN","PSOORNW1",33,0)
 I $D(DIRUT) S OUT=1 G EX
"RTN","PSOORNW1",34,0)
 D KV K PSOY S PSOY=PSDC(Y),PSOY(0)=^PSDRUG(PSOY,0),PSOCSIG=0
"RTN","PSOORNW1",35,0)
 I $G(PSOBDR("IEN")),PSOBDR("IEN")'=+PSOY D:$G(ORD)  G:$D(DIRUT) EX
"RTN","PSOORNW1",36,0)
 .D KV S DIR(0)="Y",DIR("B")="YES",DIR("A",1)="You have changed the dispense drug from",DIR("A",2)=PSOBDR("NAME")_" to "_$P(^PSDRUG(+PSOY,0),"^")_".",DIR("A")="Do You want to Edit the SIG"
"RTN","PSOORNW1",37,0)
 .D ^DIR I $D(DIRUT) S OUT=1 Q
"RTN","PSOORNW1",38,0)
 .S:Y PSOCSIG=1
"RTN","PSOORNW1",39,0)
 .I 'Y D URX I $D(DIRUT) S OUT=1 Q
"RTN","PSOORNW1",40,0)
 D KV
"RTN","PSOORNW1",41,0)
CT1 I $P($G(^PSDRUG(PSOY,"CLOZ1")),"^")="PSOCLO1",'$O(^YSCL(603.01,"C",PSODFN,0)) S VALMSG="Patient Not Registered in Clozapine Program",VALMBCK="Q" K PSOY,PSDC Q
"RTN","PSOORNW1",42,0)
 S PSODRUG("IEN")=+PSOY,PSODRUG("VA CLASS")=$P(PSOY(0),"^",2),PSODRUG("NAME")=$P(PSOY(0),"^")
"RTN","PSOORNW1",43,0)
 S PSODRUG("NDF")=$S($G(^PSDRUG(+PSOY,"ND"))]"":+^("ND")_"A"_$P(^("ND"),"^",3),1:0)
"RTN","PSOORNW1",44,0)
 S PSODRUG("MAXDOSE")=$P(PSOY(0),"^",4),PSODRUG("DEA")=$P(PSOY(0),"^",3),PSODRUG("CLN")=$S($D(^PSDRUG(+PSOY,"ND")):+$P(^("ND"),"^",6),1:0)
"RTN","PSOORNW1",45,0)
 S PSODRUG("SIG")=$P(PSOY(0),"^",5),PSODRUG("NDC")=$$GETNDC^PSSNDCUT(+PSOY,$G(PSOSITE)),PSODRUG("STKLVL")=$G(^PSDRUG(+PSOY,660.1))
"RTN","PSOORNW1",46,0)
 S PSODRUG("DAW")=+$$GET1^DIQ(50,+PSOY,81)
"RTN","PSOORNW1",47,0)
 I $G(^PSDRUG(+PSOY,660))']"" D:'$G(PSOFIN)&('$G(PSOCOPY)) POST^PSODRG G ETX
"RTN","PSOORNW1",48,0)
 S PSOX1=$G(^PSDRUG(+PSOY,660)),PSODRUG("COST")=$P($G(PSOX1),"^",6),PSODRUG("UNIT")=$P($G(PSOX1),"^",8),PSODRUG("EXPIRATION DATE")=$P($G(PSOX1),"^",9)
"RTN","PSOORNW1",49,0)
 D:'$G(PSOFIN)&('$G(PSOCOPY)) POST^PSODRG
"RTN","PSOORNW1",50,0)
 I $G(PSORX("DFLG")) K PSODRUG N LST Q:$G(PSOAC)!($G(NEWEDT))  D DSPL^PSOORFI1 S VALMBCK="Q" Q
"RTN","PSOORNW1",51,0)
ETX D REF S VALMBCK="R" I 'PSDC S VALMSG="NO dispense drugs tied to this orderable item!" S PSOQFLG=1
"RTN","PSOORNW1",52,0)
TX D KV K PSDC,PSI,X,Y,PSOX1,PSOY
"RTN","PSOORNW1",53,0)
 Q
"RTN","PSOORNW1",54,0)
EX M PSODRUG=PSOBDR K PSOBDR,PSOBDRG S PSOQFLG=1,VALMBCK="R" D MP1^PSOOREDX
"RTN","PSOORNW1",55,0)
 D TX Q
"RTN","PSOORNW1",56,0)
URX D KV S DIR(0)="Y",DIR("A")="Are You Sure You Want to Update Rx",DIR("B")="Yes"
"RTN","PSOORNW1",57,0)
 D ^DIR S:$D(DIRUT)!('Y) DIRUT=1
"RTN","PSOORNW1",58,0)
 Q
"RTN","PSOORNW1",59,0)
REF Q:'$D(PSODRUG("DEA"))!('$G(PSODRUG("IEN")))!('$G(^PS(55,PSODFN,"PS")))
"RTN","PSOORNW1",60,0)
 S PSONEW("CS")=0,PTRF=$S(+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",4)]""):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",4),1:5)
"RTN","PSOORNW1",61,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSONEW("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSONEW("CS"),"^",2)=1
"RTN","PSOORNW1",62,0)
 I $P($G(PSONEW("CS")),"^",2)=1 S PSONEW("# OF REFILLS")=0 Q
"RTN","PSOORNW1",63,0)
 I +PSONEW("CS") D
"RTN","PSOORNW1",64,0)
 .S PSOX=$S($P($G(OR0),"^",11)>5:5,1:+$P($G(OR0),"^",11))
"RTN","PSOORNW1",65,0)
 .S PSOX=$S(PSOX>PTRF:PTRF,1:PSOX)
"RTN","PSOORNW1",66,0)
 .S PSONEW("# OF REFILLS")=PSOX
"RTN","PSOORNW1",67,0)
 E  D
"RTN","PSOORNW1",68,0)
 .S PSOX=$S($P($G(OR0),"^",11)'>PTRF&($P($G(OR0),"^",11)'>11):11,1:PTRF)
"RTN","PSOORNW1",69,0)
 I '$D(CLOZPAT) I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F") S PSOX=0,PSONEW("# OF REFILLS")=0 K PSDY,PSDY1,PTRF Q
"RTN","PSOORNW1",70,0)
 I $D(CLOZPAT) S (PSOX,PSONEW("N# REF"),PSONEW("# OF REFILLS"))=$S(CLOZPAT=2&($G(PSONEW("# OF REFILLS"))>2):3,CLOZPAT&($G(PSONEW("# OF REFILLS"))>1):1,1:0),PSONEW("DAYS SUPPLY")=7,ORCHK=1 K PSDY,PSDY1,PTRF Q
"RTN","PSOORNW1",71,0)
 S PSONEW("# OF REFILLS")=$S($G(PSONEW("# OF REFILLS"))'="":$G(PSONEW("# OF REFILLS")),1:PSOX) K PSDY,PSDY1,PTRF
"RTN","PSOORNW1",72,0)
 Q
"RTN","PSOORNW1",73,0)
EDNEW K PSMAX,PSFMAX F DEA=1:1 Q:$E(PSODEA,DEA)=""  I $E(+PSODEA,DEA)>1,$E(+PSODEA,DEA)<6 S CS=1
"RTN","PSOORNW1",74,0)
 I CS D
"RTN","PSOORNW1",75,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOX=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOORNW1",76,0)
 .S PSOX=$S('PSOX:0,PSDAYS=90:1,1:PSOX),PSDY1=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0) S MAX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORNW1",77,0)
 E  D
"RTN","PSOORNW1",78,0)
 .S PSOX1=PTRF,PSOX=$S(PSOX1=11:11,1:PSOX1),PSOX=$S('PSOX:0,PSDAYS=90:3,1:PSOX)
"RTN","PSOORNW1",79,0)
 .S PSDY1=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0) S MAX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORNW1",80,0)
 I PSRF>MAX D
"RTN","PSOORNW1",81,0)
 .W $C(7),!!,PSRF_" refills are not correct for a "_PSDAYS_" day supply.",!,"Please enter correct # of refills for a "_PSDAYS_" day supply. Max refills allowed is "_MAX_".",!
"RTN","PSOORNW1",82,0)
 .S (PSMAX("MAX"),PSFMAX("MAX"))=MAX,(PSMAX("RF"),PSFMAX("RF"))=PSRF,(PSMAX("DAYS"),PSFMAX("DAYS"))=PSDAYS,(PSMAX,PSFMAX)=1
"RTN","PSOORNW1",83,0)
 K PSTMAX D EDSTAT
"RTN","PSOORNW1",84,0)
 Q
"RTN","PSOORNW1",85,0)
STATDAY K PSMAX,PSRMAX,PSFMAX,PSTMAX S PSDAYS=$P(^PSRX(DA,0),"^",8),PSRF=$P(^PSRX(DA,0),"^",9),PTST=$P(^PS(53,X,0),"^"),PTDY=$P(^(0),"^",3),PTRF=$P(^(0),"^",4)
"RTN","PSOORNW1",86,0)
EDSTAT I PSRF>PTRF W !,$C(7),PSRF_" refills are greater than "_PTRF_" allowed for "_$P(PTST,"^")_" Rx Patient Status.",! S PSTMAX=1,PSTMAX("PTRF")=PTRF,PSTMAX("PSRF")=PSRF,PSTMAX("PT")=$P(PTST,"^")
"RTN","PSOORNW1",87,0)
 Q
"RTN","PSOORNW1",88,0)
OERF S DIR(0)="N^0:"_PSOX,DIR("A")="# OF REFILLS"
"RTN","PSOORNW1",89,0)
 S DIR("B")=$S($G(POERR):PSONEW("# OF REFILLS"),$G(PSONEW("N# REF"))]"":PSONEW("N# REF"),$G(PSONEW("# OF REFILLS"))]"":PSONEW("# OF REFILLS"),$G(PSOX1)]""&(PSOX>PSOX1):PSOX1,1:PSOX)
"RTN","PSOORNW1",90,0)
 S DIR("?")="Enter a whole number.  The maximum is set by the Rx Patient Status because there is no Dispense Drug."
"RTN","PSOORNW1",91,0)
 D ^DIR G:$D(DIRUT) REFX
"RTN","PSOORNW1",92,0)
 S (PSONEW("N# REF"),PSONEW("# OF REFILLS"))=Y
"RTN","PSOORNW1",93,0)
REFX S:'$D(PSONEW("# OF REFILLS")) PSONEW("# OF REFILLS")=$S($G(PSONEW("N# REF"))]"":PSONEW("N# REF"),$G(PSOX1)]""&($G(PSOX)>PSOX1):PSOX1,1:PSOX)
"RTN","PSOORNW1",94,0)
 K X,Y,PSOX,PSOX1,PSDY,PSDY1,DEA
"RTN","PSOORNW1",95,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORNW1",96,0)
 Q
"RTN","PSOORUT2")
0^74^B61773265^B33163050
"RTN","PSOORUT2",1,0)
PSOORUT2 ;ISC BHAM/SAB - build listman screen ; 3/20/07 9:47am
"RTN","PSOORUT2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,146,132,182,233,243,261,268**;DEC 1997;Build 9
"RTN","PSOORUT2",3,0)
 ;External reference to SDPHARM1 supported by DBIA 4196
"RTN","PSOORUT2",4,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORUT2",5,0)
 ;External reference ^DIC(31 supported by DBIA 658
"RTN","PSOORUT2",6,0)
 ;External reference ^DPT(D0,.372 supported by DBIA 1476
"RTN","PSOORUT2",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOORUT2",8,0)
 ;External references to ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOORUT2",9,0)
 ;
"RTN","PSOORUT2",10,0)
 K ^TMP("PSOHDR",$J),^TMP("PSOPI",$J) S DFN=PSODFN D ^VADPT,ADD^VADPT
"RTN","PSOORUT2",11,0)
 S ^TMP("PSOHDR",$J,1,0)=VADM(1),^TMP("PSOHDR",$J,2,0)=$P(VADM(2),"^",2)
"RTN","PSOORUT2",12,0)
 S ^TMP("PSOHDR",$J,3,0)=$P(VADM(3),"^",2),^TMP("PSOHDR",$J,4,0)=VADM(4),^TMP("PSOHDR",$J,5,0)=$P(VADM(5),"^",2)
"RTN","PSOORUT2",13,0)
 D NVA
"RTN","PSOORUT2",14,0)
 S POERR=1 D RE^PSODEM K POERR
"RTN","PSOORUT2",15,0)
 S ^TMP("PSOHDR",$J,6,0)=$S($P(WT,"^",8):$P(WT,"^",9)_" ("_$P(WT,"^")_")",1:"_______ (______)")
"RTN","PSOORUT2",16,0)
 S ^TMP("PSOHDR",$J,7,0)=$S($P(HT,"^",8):$P(HT,"^",9)_" ("_$P(HT,"^")_")",1:"_______ (______)") K VM,WT,HT S PSOHD=7
"RTN","PSOORUT2",17,0)
 S GMRA="0^0^111" D ^GMRADPT S ^TMP("PSOHDR",$J,8,0)=+$G(GMRAL)
"RTN","PSOORUT2",18,0)
 S $P(^TMP("PSOHDR",$J,9,0)," ",62)="ISSUE  LAST REF DAY"
"RTN","PSOORUT2",19,0)
 S ^TMP("PSOHDR",$J,10,0)=" #  RX #         DRUG                                 QTY ST  DATE  FILL REM SUP"
"RTN","PSOORUT2",20,0)
 D ELIG^VADPT S IEN=1,^TMP("PSOPI",$J,IEN,0)="Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:""),IEN=IEN+1
"RTN","PSOORUT2",21,0)
 S N=0 F  S N=$O(VAEL(1,N)) Q:'N  S $P(^TMP("PSOPI",$J,IEN,0)," ",14)=$P(VAEL(1,N),"^",2),IEN=IEN+1
"RTN","PSOORUT2",22,0)
 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Disabilities: "
"RTN","PSOORUT2",23,0)
 F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSOORUT2",24,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSOORUT2",25,0)
 .S:$L(^TMP("PSOPI",$J,IEN,0)_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 IEN=IEN+1,$P(^TMP("PSOPI",$J,IEN,0)," ",14)=" "
"RTN","PSOORUT2",26,0)
 .S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSOORUT2",27,0)
 S IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1
"RTN","PSOORUT2",28,0)
 I +VAPA(9) S ^TMP("PSOPI",$J,IEN,0)="      (Temp Address from "_$P(VAPA(9),"^",2)_" till "_$S($P(VAPA(10),"^",2)]"":$P(VAPA(10),"^",2),1:"(no end date)")_")",IEN=IEN+1
"RTN","PSOORUT2",29,0)
 S ^TMP("PSOPI",$J,IEN,0)=VAPA(1) S:VAPA(2)]"" IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(2) S:VAPA(3)]"" IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(3)
"RTN","PSOORUT2",30,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=VAPA(4),$P(^TMP("PSOPI",$J,IEN,0)," ",40)="PHONE: "_VAPA(8)
"RTN","PSOORUT2",31,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=$P(VAPA(5),"^",2)_"  "_$S(VAPA(11)]"":$P(VAPA(11),"^",2),1:VAPA(6))
"RTN","PSOORUT2",32,0)
 S MAILD=+$P($G(^PS(55,DFN,0)),"^",3) D  K MAILD
"RTN","PSOORUT2",33,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Prescription Mail Delivery: "_$S(MAILD=1:"Certified Mail",MAILD=2:"DO NOT MAIL",MAILD=3:"Local - Regular Mail",MAILD=4:"Local - Certified Mail",1:"Regular Mail")
"RTN","PSOORUT2",34,0)
 .I MAILD<2!(MAILD>4) Q  ;ONLY FOR MAIL DELIVERIES 2,3,4
"RTN","PSOORUT2",35,0)
 .N PSOMDEXP,Y
"RTN","PSOORUT2",36,0)
 .S Y=$P($G(^PS(55,DFN,0)),"^",5)
"RTN","PSOORUT2",37,0)
 .I Y'>DT D
"RTN","PSOORUT2",38,0)
 ..D DD^%DT S PSOMDEXP=Y
"RTN","PSOORUT2",39,0)
 ..S ^TMP("PSOPI",$J,IEN,0)=^TMP("PSOPI",$J,IEN,0)_" Expire Date: "_PSOMDEXP
"RTN","PSOORUT2",40,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=$S($P($G(^PS(55,DFN,0)),"^",2):"Cannot use safety caps.",1:"") S $P(^TMP("PSOPI",$J,IEN,0)," ",40)=$S($P($G(^PS(55,DFN,0)),"^",4):"Dialysis Patient.",1:"")
"RTN","PSOORUT2",41,0)
 I $G(^PS(55,DFN,1))]"" S PSON=^(1),IEN=IEN+1 D
"RTN","PSOORUT2",42,0)
 .S ^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="     Outpatient Narrative: "
"RTN","PSOORUT2",43,0)
 .F I=1:1 Q:$P(PSON," ",I,99)=""  S:$L(^TMP("PSOPI",$J,IEN,0)_$P(PSON," ",I)_" ")>80 IEN=IEN+1 S ^TMP("PSOPI",$J,IEN,0)=$G(^TMP("PSOPI",$J,IEN,0))_$P(PSON," ",I)_" "
"RTN","PSOORUT2",44,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",45,0)
 I $D(^PS(52.91,DFN,0)) I '$P(^(0),"^",3)!($P(^(0),"^",3)>DT) D
"RTN","PSOORUT2",46,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Primary Care Appointment: "_$$PRIAPT^SDPHARM1(DFN)
"RTN","PSOORUT2",47,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",48,0)
 I 'GMRAL D
"RTN","PSOORUT2",49,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Allergies: "_$S(GMRAL=0:"NKA",1:"")
"RTN","PSOORUT2",50,0)
 .I GMRAL'=0 S PSONOAL="" D ALLERGY I PSONOAL'="" S ^TMP("PSOPI",$J,IEN,0)="Allergies: "_PSONOAL K PSONOAL
"RTN","PSOORUT2",51,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" "
"RTN","PSOORUT2",52,0)
 .D REMOTE
"RTN","PSOORUT2",53,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Adverse Reactions:"
"RTN","PSOORUT2",54,0)
 D:$G(GMRAL) ^PSOORUT3
"RTN","PSOORUT2",55,0)
 K ^UTILITY("VASD",$J),VASD S DFN=PSODFN,VASD("F")=DT,VASD("T")=9999999,VASD("W")="123456789" D SDA^VADPT K VASD I $D(^UTILITY("VASD",$J)) D
"RTN","PSOORUT2",56,0)
 .S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=" ",IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="Pending Clinic Appointments:"
"RTN","PSOORUT2",57,0)
 .F PSOAPP=0:0 S PSOAPP=$O(^UTILITY("VASD",$J,PSOAPP)) Q:'PSOAPP  S PSOAPPE=$G(^UTILITY("VASD",$J,PSOAPP,"E")),PSOAPPI=$G(^("I")) D
"RTN","PSOORUT2",58,0)
 ..K X S X2=DT,X1=$P($P($G(PSOAPPI),"^"),".") I $G(X1) D ^%DTC
"RTN","PSOORUT2",59,0)
 ..S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="    "_$P(PSOAPPE,"^")_"  "_$P(PSOAPPE,"^",2)_$S($P(PSOAPPI,"^",3)["C":"   *** Canceled ***",1:" ("_$G(X)_" days)")
"RTN","PSOORUT2",60,0)
 K ^UTILITY("VASD",$J),X,PSOAPPI,PSOAPPE,PSOAPP,N
"RTN","PSOORUT2",61,0)
 S PSOPI=IEN K IEN
"RTN","PSOORUT2",62,0)
 Q
"RTN","PSOORUT2",63,0)
NVA ;
"RTN","PSOORUT2",64,0)
 Q:'$O(^PS(55,PSODFN,"NVA",0))
"RTN","PSOORUT2",65,0)
 K LSTDT F I=0:0 S I=$O(^PS(55,PSODFN,"NVA",I)) Q:'I  D
"RTN","PSOORUT2",66,0)
 .Q:$P(^PS(55,PSODFN,"NVA",I,0),"^",7)  Q:'$P(^PS(55,PSODFN,"NVA",I,0),"^")
"RTN","PSOORUT2",67,0)
 .I $P(^PS(55,PSODFN,"NVA",I,0),"^",10)>+$G(LSTDT) S LSTDT=$P(^(0),"^",10)
"RTN","PSOORUT2",68,0)
 I $G(LSTDT)]"" D
"RTN","PSOORUT2",69,0)
 .S LSTDT="Non-VA Meds on File - Last entry on "_$E(LSTDT,4,5)_"/"_$E(LSTDT,6,7)_"/"_$E(LSTDT,2,3)
"RTN","PSOORUT2",70,0)
 .I $G(^TMP("PSOHDR",$J,5,0))="MALE" S $P(^TMP("PSOHDR",$J,5,0)," ",22)=LSTDT K LSTDT Q
"RTN","PSOORUT2",71,0)
 .S $P(^TMP("PSOHDR",$J,5,0)," ",20)=LSTDT K LSTDT
"RTN","PSOORUT2",72,0)
 K I
"RTN","PSOORUT2",73,0)
 Q
"RTN","PSOORUT2",74,0)
REMOTE ;
"RTN","PSOORUT2",75,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOORUT2",76,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOORUT2",77,0)
 N PSORALG,REAC,S1,A,FILE,LEN,I
"RTN","PSOORUT2",78,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",79,0)
 S PSORALG=1,PSORALG(1)="No remote data available"
"RTN","PSOORUT2",80,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) G REMOTE2
"RTN","PSOORUT2",81,0)
 I $T(GET^ORRDI1)]"" S PSOSIEN=$G(IEN) D GET^ORRDI1(DFN,"ART") S IEN=PSOSIEN K PSOSIEN D
"RTN","PSOORUT2",82,0)
 .I $P($G(^XTMP("ORRDI","ART",DFN,0)),"^",3)=0 S PSORALG(1)="No remote allergies"
"RTN","PSOORUT2",83,0)
 .S S1=0,LEN=65,PSORALG=1,PSORALG(1)="" F  S S1=$O(^XTMP("ORRDI","ART",DFN,S1)) Q:'S1  D
"RTN","PSOORUT2",84,0)
 ..S A=$G(^XTMP("ORRDI","ART",DFN,S1,"REACTANT",0)),REAC=$P(A,"^",2),FILE=$P($P(A,"^",3),"99VA",2)
"RTN","PSOORUT2",85,0)
 ..I FILE'=50.6,FILE'=120.82,FILE'=50.605,FILE'=50.416 Q
"RTN","PSOORUT2",86,0)
 ..S ^TMP($J,"PSOART",REAC)=""
"RTN","PSOORUT2",87,0)
 .S REAC="" F  S REAC=$O(^TMP($J,"PSOART",REAC)) Q:REAC=""  D
"RTN","PSOORUT2",88,0)
 ..I $L(PSORALG(PSORALG))+$L(REAC)<LEN S PSORALG(PSORALG)=PSORALG(PSORALG)_REAC_", " Q
"RTN","PSOORUT2",89,0)
 ..S PSORALG=PSORALG+1,PSORALG(PSORALG)="              "_REAC_", ",LEN=76
"RTN","PSOORUT2",90,0)
 .I PSORALG(PSORALG)]"",$E(PSORALG(PSORALG),$L(PSORALG(PSORALG)))="," S PSORALG(PSORALG)=$E(PSORALG(PSORALG),1,$L(PSORALG(PSORALG))-1)
"RTN","PSOORUT2",91,0)
REMOTE2 ;
"RTN","PSOORUT2",92,0)
 S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)="      Remote: "_$G(PSORALG(1)) D
"RTN","PSOORUT2",93,0)
 .F I=2:1:PSORALG S IEN=IEN+1,^TMP("PSOPI",$J,IEN,0)=PSORALG(I)
"RTN","PSOORUT2",94,0)
 K ^TMP($J,"PSOART")
"RTN","PSOORUT2",95,0)
 Q
"RTN","PSOORUT2",96,0)
  ;
"RTN","PSOORUT2",97,0)
ALLERGY ;ALLERGIES & REACTIONS
"RTN","PSOORUT2",98,0)
 N GMRA,GMRAL,PSORY,ALCNT,EEE,PSOLG,PSOLGA,TEXT,CCC,CCC2
"RTN","PSOORUT2",99,0)
 K ^TMP($J,"PSOALWA")
"RTN","PSOORUT2",100,0)
 I '$D(DFN) S DFN=PSODFN
"RTN","PSOORUT2",101,0)
 S GMRA="0^0^111" D ^GMRADPT
"RTN","PSOORUT2",102,0)
 I $G(GMRAL) S PSORY=0 F  S PSORY=$O(GMRAL(PSORY)) Q:'PSORY  S ^TMP($J,"PSOALWA",$S($P(GMRAL(PSORY),"^",4):1,1:2),$S('$P(GMRAL(PSORY),"^",5):1,1:2),$P(GMRAL(PSORY),"^",7),$P(GMRAL(PSORY),"^",2))=""
"RTN","PSOORUT2",103,0)
 S ^TMP($J,"PSOAPT",1)=$G(PNM)_"  "_$G(SSNP),^(2)="Verified Allergies"
"RTN","PSOORUT2",104,0)
 S ALCNT=0,EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)=PSOLGA
"RTN","PSOORUT2",105,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",2,ALCNT)="NKA"
"RTN","PSOORUT2",106,0)
 S ALCNT=0,^TMP($J,"PSOAPT",3)="Non-Verified Allergies"
"RTN","PSOORUT2",107,0)
 S EEE=0,(PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,1,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,1,PSOLG,PSOLGA)) Q:PSOLGA=""  S EEE=EEE+1,ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)=PSOLGA
"RTN","PSOORUT2",108,0)
 I 'EEE,$G(GMRAL)=0 S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",3,ALCNT)="NKA"
"RTN","PSOORUT2",109,0)
 S ALCNT=0,^TMP($J,"PSOAPT",4)="Verified Adverse Reactions"
"RTN","PSOORUT2",110,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",1,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",1,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",4,ALCNT)=PSOLGA
"RTN","PSOORUT2",111,0)
 S ALCNT=0,^TMP($J,"PSOAPT",5)="Non-Verified Adverse Reactions"
"RTN","PSOORUT2",112,0)
 S (PSOLG,PSOLGA)="" F  S PSOLG=$O(^TMP($J,"PSOALWA",2,2,PSOLG)) Q:PSOLG=""  F  S PSOLGA=$O(^TMP($J,"PSOALWA",2,2,PSOLG,PSOLGA)) Q:PSOLGA=""  S ALCNT=ALCNT+1,^TMP($J,"PSOAPT",5,ALCNT)=PSOLGA
"RTN","PSOORUT2",113,0)
 S TEXT=^TMP($J,"PSOAPT",1) D CHKNO(TEXT)
"RTN","PSOORUT2",114,0)
 F CCC=3,4,5 I '$O(^TMP($J,"PSOAPT",CCC,0)) K ^TMP($J,"PSOAPT",CCC)
"RTN","PSOORUT2",115,0)
 D PSONOAL
"RTN","PSOORUT2",116,0)
 I CCC="NKA" S ^TMP($J,"PSOAPT",2,1)="No Known Allergies" K ^TMP($J,"PSOAPT",3)
"RTN","PSOORUT2",117,0)
 S CCC=1,OUT=0
"RTN","PSOORUT2",118,0)
 F  S CCC=$O(^TMP($J,"PSOAPT",CCC)) Q:CCC=""  D  Q:OUT
"RTN","PSOORUT2",119,0)
 .S TEXT=$G(^TMP($J,"PSOAPT",CCC))
"RTN","PSOORUT2",120,0)
 .I TEXT="No Allergy Assessment" S PSONOAL=TEXT Q
"RTN","PSOORUT2",121,0)
 .S (TEXT,CCC2)="",LENGTH=0
"RTN","PSOORUT2",122,0)
 .F  S CCC2=$O(^TMP($J,"PSOAPT",CCC,CCC2)) Q:CCC2=""  S TEXT=^(CCC2) D CHKNO(TEXT)
"RTN","PSOORUT2",123,0)
 K ^TMP($J,"PSOALWA"),^TMP($J,"PSOAPT")
"RTN","PSOORUT2",124,0)
 Q
"RTN","PSOORUT2",125,0)
CHKNO(T) ;
"RTN","PSOORUT2",126,0)
 I T="No Allergy Assessment" S PSONOAL=T
"RTN","PSOORUT2",127,0)
 Q
"RTN","PSOORUT2",128,0)
PSONOAL   ;
"RTN","PSOORUT2",129,0)
 N FLG3,FLG4,FLG5
"RTN","PSOORUT2",130,0)
 S CCC=$G(^TMP($J,"PSOAPT",2,1))
"RTN","PSOORUT2",131,0)
 S FLG3=$G(^TMP($J,"PSOAPT",3,1))
"RTN","PSOORUT2",132,0)
 S FLG4=$G(^TMP($J,"PSOAPT",4,1))
"RTN","PSOORUT2",133,0)
 S FLG5=$G(^TMP($J,"PSOAPT",5,1))
"RTN","PSOORUT2",134,0)
 I CCC="",FLG3="",FLG4="",FLG5="" S ^TMP($J,"PSOAPT",2,1)="No Allergy Assessment" K ^TMP($J,"PSOAPT",3)
"RTN","PSOORUT2",135,0)
 Q
"RTN","PSOPAT")
0^41^B4781637^B4414039
"RTN","PSOPAT",1,0)
PSOPAT ;BHAM ISC/SAB - update pharmacy patient data ;03/08/93 8:35
"RTN","PSOPAT",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**74,117,149,233,268**;DEC 1997;Build 9
"RTN","PSOPAT",3,0)
 ;Reference to ^PS(55, is supported by IA 2228
"RTN","PSOPAT",4,0)
 I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) W $C(7),!,"Site Parameters must be Defined!",! G EX
"RTN","PSOPAT",5,0)
2 W ! S PSOFROM=1,DIC("A")="Select Patient: ",DIC=2,DIC(0)="AEQMZ" D ^DIC G:"^"[X EX G:Y<0 2 S DFN=+Y S PSOLOUD=1 D:$P($G(^PS(55,DFN,0)),"^",6)'=2 EN^PSOHLUP(DFN) K PSOLOUD
"RTN","PSOPAT",6,0)
 S DA=DFN,PI="" D ^PSODEM G 2:PI="^"
"RTN","PSOPAT",7,0)
 I '$P($G(PSOPAR),"^",22),'$D(^XUSEC("PSO ADDRESS UPDATE",+$G(DUZ))) G P55
"RTN","PSOPAT",8,0)
 L +^PS(55,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T D MSG D EX G 2
"RTN","PSOPAT",9,0)
 S PSODFN=DA D UPDATE^PSOBAI S DA=PSODFN
"RTN","PSOPAT",10,0)
 W !
"RTN","PSOPAT",11,0)
 L +^DPT(DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T D MSG D EX G 2
"RTN","PSOPAT",12,0)
 S DIE="^DPT(",DR="[PSO OUTPT]" D ^DIE L -^DPT(DA)
"RTN","PSOPAT",13,0)
P55 I '$D(^PS(55,DFN)) K DIC S DIC="^PS(55,",DIC(0)="LZ",(X,DINUM)=DFN K DD,DO D FILE^DICN D:$G(DFN)&($P($G(^PS(55,DFN,0)),"^",6)'=2) EN^PSOHLUP(DFN) K DIC
"RTN","PSOPAT",14,0)
 I $G(DFN),$P($G(^PS(55,DFN,0)),"^")="" S $P(^PS(55,DFN,0),"^")=DFN K DIK S DA=DFN,DIK="^PS(55,",DIK(1)=".01^B" D EN^DIK K DIK S DA=DFN
"RTN","PSOPAT",15,0)
 S DIE="^PS(55,",DR=".02;.03;.05;.04;1;D ELIG^PSORX1;3;40:41.1;106;106.1" W !!?5,">>PHARMACY PATIENT DATA<<",!
"RTN","PSOPAT",16,0)
 D ^DIE,EX W !! G 2
"RTN","PSOPAT",17,0)
 Q
"RTN","PSOPAT",18,0)
EX L -^PS(55,+$G(DA)),-^DPT(+$G(DA))
"RTN","PSOPAT",19,0)
 K DIC,X,Y,DIE,D0,DA,DFN,PI,DR,%,%Y,%X,C,DI,DIPGM,DQ,PSOFROM
"RTN","PSOPAT",20,0)
 Q
"RTN","PSOPAT",21,0)
MSG W $C(7),!,"Patient Data is Being Edited by Another User!",! Q
"RTN","PSOPOST7")
0^65^B43103725^B42217710
"RTN","PSOPOST7",1,0)
PSOPOST7 ;BIR/EJW,JLC-Post install routine ;10/04/02
"RTN","PSOPOST7",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**115,268**;DEC 1997;Build 9
"RTN","PSOPOST7",3,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSOPOST7",4,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOPOST7",5,0)
 ; POST-INSTALL ROUTINE FOR PATCH PSO*7*115 - TO RESET MISSING ENTRIES INTO THE PHARMACY PATIENT FILE (#55)
"RTN","PSOPOST7",6,0)
 S ZTDTH=""
"RTN","PSOPOST7",7,0)
 I $D(ZTQUEUED) S ZTDTH=$H
"RTN","PSOPOST7",8,0)
 L +^XTMP("PSOPOST7"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T D  Q
"RTN","PSOPOST7",9,0)
 . I ZTDTH="" W !,"Clean up job is already running.  Halting..."
"RTN","PSOPOST7",10,0)
 L -^XTMP("PSOPOST7")
"RTN","PSOPOST7",11,0)
 I ZTDTH="" D
"RTN","PSOPOST7",12,0)
 .W !,"The background job to search for missing ^PS(55 entries must be queued."
"RTN","PSOPOST7",13,0)
 .W !,"If no start date/time is entered when prompted, the background job will be"
"RTN","PSOPOST7",14,0)
 .W !,"queued to run NOW."
"RTN","PSOPOST7",15,0)
 .W !
"RTN","PSOPOST7",16,0)
 .D BMES^XPDUTL("Queuing background job to search for missing ^PS(55 entries")
"RTN","PSOPOST7",17,0)
 S ZTRTN="RES^PSOPOST7",ZTIO="",ZTDESC="Background job to search for missing ^PS(55 entries" D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOPOST7",18,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOPOST7",19,0)
 Q
"RTN","PSOPOST7",20,0)
RES ;
"RTN","PSOPOST7",21,0)
 L +^XTMP("PSOPOST7"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOPOST7",22,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOPOST7",23,0)
 I '$D(^XTMP("PSOPOST7")) S X1=DT,X2=+30 D C^%DTC S ^XTMP("PSOPOST7",0)=$G(X)_"^"_DT
"RTN","PSOPOST7",24,0)
 S PSODT2=DT-20000
"RTN","PSOPOST7",25,0)
 D NOW^%DTC S ^XTMP("PSOTIMEX","START")=%
"RTN","PSOPOST7",26,0)
 D BMES^XPDUTL("Searching for missing ^PS(55 entries...")
"RTN","PSOPOST7",27,0)
SRCH ; SEARCH THROUGH PRESCRIPTIONS
"RTN","PSOPOST7",28,0)
 N RXP,RX0,PSODFN,PSODT,PSOCTP,PSOCTPA
"RTN","PSOPOST7",29,0)
 S (PSOCTP,PSOCTPA)=0
"RTN","PSOPOST7",30,0)
 S RXP=0 F  S RXP=$O(^PSRX(RXP)) Q:'RXP  S RX0=$G(^PSRX(RXP,0)),PSODT=$P(RX0,"^",13) I PSODT>PSODT2 S PSODFN=$P(RX0,"^",2) I PSODFN D
"RTN","PSOPOST7",31,0)
 .I '$D(^DPT(PSODFN,0)) Q
"RTN","PSOPOST7",32,0)
 .D PS55P
"RTN","PSOPOST7",33,0)
 .D PS55PA
"RTN","PSOPOST7",34,0)
 I $O(^XTMP("PSOPOST7",$J,""))'="" D RESET
"RTN","PSOPOST7",35,0)
 N DFN,PSJORD,PSSTART,PSSTOP,PSSTATUS,A
"RTN","PSOPOST7",36,0)
 S DFN=0
"RTN","PSOPOST7",37,0)
 F  S DFN=$O(^PS(55,DFN)) Q:'DFN  D
"RTN","PSOPOST7",38,0)
 . S PSJORD=0 F  S PSJORD=$O(^PS(55,DFN,5,PSJORD)) Q:'PSJORD  D
"RTN","PSOPOST7",39,0)
 .. S PSSTATUS=$P($G(^PS(55,DFN,5,PSJORD,0)),U,9),PSSTART=$P($G(^PS(55,DFN,5,PSJORD,2)),U,2),PSSTOP=$P($G(^(2)),U,4) I PSSTOP]"",$D(^PS(55,"AUD",PSSTOP,DFN,PSJORD)) Q
"RTN","PSOPOST7",40,0)
 .. K DR S DIE="^PS(55,"_DFN_",5,",DA=PSJORD,DA(1)=DFN,DR="10////^S X=PSSTART;28////^S X=PSSTATUS;34////^S X=PSSTOP"
"RTN","PSOPOST7",41,0)
 .. D ^DIE
"RTN","PSOPOST7",42,0)
 .. S ^XTMP("PSOPOST7",$J,"UD",DFN,PSJORD)="" K DIE,DR,DA
"RTN","PSOPOST7",43,0)
 . S PSJORD=0 F  S PSJORD=$O(^PS(55,DFN,"IV",PSJORD)) Q:'PSJORD  D
"RTN","PSOPOST7",44,0)
 .. S A=$G(^PS(55,DFN,"IV",PSJORD,0)) Q:A=""
"RTN","PSOPOST7",45,0)
 .. S PSSTART=$P(A,"^",2),PSSTOP=$P(A,"^",3),PSSTATUS=$P(A,"^",17)
"RTN","PSOPOST7",46,0)
 .. I PSSTOP]"",$D(^PS(55,"AIV",PSSTOP,DFN,PSJORD)) Q
"RTN","PSOPOST7",47,0)
 .. K DR S DIE="^PS(55,"_DFN_",""IV"",",DA=PSJORD,DA(1)=DFN,DR=".02////^S X=PSSTART;.03////^S X=PSSTOP;100////S X=PSSTATUS"
"RTN","PSOPOST7",48,0)
 .. D ^DIE
"RTN","PSOPOST7",49,0)
 .. S ^XTMP("PSOPOST7",$J,"IV",DFN,PSJORD)="" K DIE,DR,DA
"RTN","PSOPOST7",50,0)
MAIL ;
"RTN","PSOPOST7",51,0)
 N CNT
"RTN","PSOPOST7",52,0)
 D NOW^%DTC S PSOTIMEB=%
"RTN","PSOPOST7",53,0)
 S Y=$G(^XTMP("PSOTIMEX","START")) D DD^%DT S PSOTIMEA=Y
"RTN","PSOPOST7",54,0)
 S Y=$G(PSOTIMEB) D DD^%DT S PSOTIMEB=Y
"RTN","PSOPOST7",55,0)
 S XMDUZ="Patch PSO*7*115",XMY(DUZ)="",XMSUB="PHARMACY PATIENT File (#55) search for missing entries"
"RTN","PSOPOST7",56,0)
 K PSOTEXT S PSOTEXT(1)="Patch PSO*7*115 PHARMACY PATIENT File (#55) search and clean-up is complete.",PSOTEXT(2)="It started on "_$G(PSOTIMEA)_".",PSOTEXT(3)="It ended on "_$G(PSOTIMEB)_"."
"RTN","PSOPOST7",57,0)
 S PSOTEXT(4)=" "
"RTN","PSOPOST7",58,0)
 S PSOTEXT(5)=PSOCTP_" patients had missing ""P"" cross-references"_$S(PSOCTP>0:" and have been reset.",1:".")
"RTN","PSOPOST7",59,0)
 S PSOTEXT(6)=PSOCTPA_" ^PS(55,PSODFN,""P"",""A"" cross-references were missing"_$S(PSOCTPA>0:" and have been reset.",1:".")
"RTN","PSOPOST7",60,0)
 S PSOTEXT(7)=" "
"RTN","PSOPOST7",61,0)
 S CNT=7
"RTN","PSOPOST7",62,0)
 I PSOCTP S CNT=CNT+1,PSOTEXT(CNT)="The global ^XTMP(""PSOPOST7"","_$J_",PSODFN,ISSUE DATE,RXIEN) contains" D
"RTN","PSOPOST7",63,0)
 .S CNT=CNT+1,PSOTEXT(CNT)="the missing ""P"" cross-reference entries. "_"("_$J_" is the job number.)"
"RTN","PSOPOST7",64,0)
 S CNT=CNT+1,PSOTEXT(CNT)=" "
"RTN","PSOPOST7",65,0)
 I PSOCTPA S CNT=CNT+1,PSOTEXT(CNT)="The global ^XTMP(""PSOPOST7"","_$J_",PSODFN,""P,A"",EXP. DATE,RXIEN) contains" D
"RTN","PSOPOST7",66,0)
 .S CNT=CNT+1,PSOTEXT(CNT)="the missing ""P"",""A"" cross-reference entries. "_"("_$J_" is the job number.)"
"RTN","PSOPOST7",67,0)
 I $D(^XTMP("PSOPOST7",$J,"UD")) D
"RTN","PSOPOST7",68,0)
 . S CNT=CNT+1,PSOTEXT(CNT)="The global ^XTMP(""PSOPOST7"","_$J_",""UD"",DFN,PSJORD) contains"
"RTN","PSOPOST7",69,0)
 . S CNT=CNT+1,PSOTEXT(CNT)="the unit dose orders missing stop dates."
"RTN","PSOPOST7",70,0)
 I $D(^XTMP("PSOPOST7",$J,"IV")) D
"RTN","PSOPOST7",71,0)
 . S CNT=CNT+1,PSOTEXT(CNT)="The global ^XTMP(""PSOPOST7"","_$J_",""IV"",DFN,PSJORD) contains"
"RTN","PSOPOST7",72,0)
 . S CNT=CNT+1,PSOTEXT(CNT)="the IV orders missing stop dates."
"RTN","PSOPOST7",73,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD
"RTN","PSOPOST7",74,0)
 K PSOTIMEA,PSOTIMEB,XMDUZ,XMSUB,PSOTEXT,XMTEXT,PSODT2
"RTN","PSOPOST7",75,0)
 L -^XTMP("PSOPOST7")
"RTN","PSOPOST7",76,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOPOST7",77,0)
 Q
"RTN","PSOPOST7",78,0)
 ;
"RTN","PSOPOST7",79,0)
PS55P ; CHECK FOR MISSING "P" CROSS=REFERENCES
"RTN","PSOPOST7",80,0)
 N PSOSQ
"RTN","PSOPOST7",81,0)
 S PSOSQ=0 F  S PSOSQ=$O(^PS(55,PSODFN,"P",PSOSQ)) Q:'PSOSQ  I $G(^PS(55,PSODFN,"P",PSOSQ,0))=RXP Q
"RTN","PSOPOST7",82,0)
 I PSOSQ Q
"RTN","PSOPOST7",83,0)
 S ^XTMP("PSOPOST7",$J,PSODFN,PSODT,RXP)=""
"RTN","PSOPOST7",84,0)
 Q
"RTN","PSOPOST7",85,0)
 ;
"RTN","PSOPOST7",86,0)
PS55PA ; CHECK FOR MISSING "P","A" CROSS-REFERENCES
"RTN","PSOPOST7",87,0)
 N PSODT
"RTN","PSOPOST7",88,0)
 S PSODT="" F  S PSODT=$O(^PS(55,PSODFN,"P","A",PSODT)) Q:'PSODT  I $D(^PS(55,PSODFN,"P","A",PSODT,RXP)) Q
"RTN","PSOPOST7",89,0)
 I 'PSODT D
"RTN","PSOPOST7",90,0)
 . N PSOEXP
"RTN","PSOPOST7",91,0)
 . S PSOEXP=$P($G(^PSRX(RXP,2)),"^",6) I PSOEXP="" S PSOEXP=$P($G(^PSRX(RXP,3)),"^",5)
"RTN","PSOPOST7",92,0)
 .I PSOEXP="" Q
"RTN","PSOPOST7",93,0)
 .S ^XTMP("PSOPOST7",$J,PSODFN,"P,A",PSOEXP,RXP)=""
"RTN","PSOPOST7",94,0)
 .D CHKPS
"RTN","PSOPOST7",95,0)
 .S ^PS(55,PSODFN,"P","A",PSOEXP,RXP)="",PSOCTPA=PSOCTPA+1
"RTN","PSOPOST7",96,0)
 Q
"RTN","PSOPOST7",97,0)
 ;
"RTN","PSOPOST7",98,0)
CHKPS ; SEE IF ^PS(55,PSODFN EXISTS - IF NOT SET TOP LEVEL AT LEAST
"RTN","PSOPOST7",99,0)
 I '$D(^PS(55,PSODFN,0)) S ^PS(55,PSODFN,0)=PSODFN_"^^^^^2"
"RTN","PSOPOST7",100,0)
 Q
"RTN","PSOPOST7",101,0)
 ;
"RTN","PSOPOST7",102,0)
RESET ; RESET "P" CROSS-REFERENCE BY BUILDING ^TMP GLOBAL IN ISSUE DATE SEQUENCE FOR ALL ENTRIES, THEN RESETTING THE "P" SUBSCRIPT
"RTN","PSOPOST7",103,0)
 N PSOIDT,PSOSQ,CNT
"RTN","PSOPOST7",104,0)
 S PSODFN="" F  S PSODFN=$O(^XTMP("PSOPOST7",$J,PSODFN)) Q:'PSODFN  S PSOCTP=PSOCTP+1 D
"RTN","PSOPOST7",105,0)
 .K ^TMP("PSOPOST7",$J)
"RTN","PSOPOST7",106,0)
 .S CNT=0
"RTN","PSOPOST7",107,0)
 .I '$O(^XTMP("PSOPOST7",$J,PSODFN,"")) Q  ; quit if only "P,A" entries
"RTN","PSOPOST7",108,0)
 .L +^PS(55,PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOPOST7",109,0)
 .S PSODT="" F  S PSODT=$O(^XTMP("PSOPOST7",$J,PSODFN,PSODT)) Q:'PSODT    S RXP="" F  S RXP=$O(^XTMP("PSOPOST7",$J,PSODFN,PSODT,RXP)) Q:'RXP  D
"RTN","PSOPOST7",110,0)
 ..S PSOIDT=$P($G(^PSRX(RXP,0)),"^",13) I PSOIDT'="" I '$D(^TMP("PSOPOST7",$J,PSOIDT,RXP)) S ^TMP("PSOPOST7",$J,PSOIDT,RXP)="",CNT=CNT+1
"RTN","PSOPOST7",111,0)
 .S PSOSQ=0 F  S PSOSQ=$O(^PS(55,PSODFN,"P",PSOSQ)) Q:'PSOSQ  D  ; NOW ADD ALL EXISTING ENRIES TO ^TMP GLOBAL
"RTN","PSOPOST7",112,0)
 ..S RXP=$G(^PS(55,PSODFN,"P",PSOSQ,0)) I RXP="" Q
"RTN","PSOPOST7",113,0)
 ..S PSOIDT=$P($G(^PSRX(RXP,0)),"^",13) I PSOIDT'=""  I '$D(^TMP("PSOPOST7",$J,PSOIDT,RXP)) S ^TMP("PSOPOST7",$J,PSOIDT,RXP)="",CNT=CNT+1
"RTN","PSOPOST7",114,0)
 .I $O(^PS(55,PSODFN,"P",CNT)) D
"RTN","PSOPOST7",115,0)
 ..S PSOSQ=CNT F  S PSOSQ=$O(^PS(55,PSODFN,"P",PSOSQ)) Q:'PSOSQ  K ^PS(55,PSODFN,"P",PSOSQ) ; REMOVE SEQUENCE NUMBERS THAT ARE GREATER THAN THE NUMBER OF "P" ENTRIES
"RTN","PSOPOST7",116,0)
 .S CNT=0,PSOIDT="" F  S PSOIDT=$O(^TMP("PSOPOST7",$J,PSOIDT)) Q:'PSOIDT  S RXP=""  F  S RXP=$O(^TMP("PSOPOST7",$J,PSOIDT,RXP)) Q:'RXP  S CNT=CNT+1,^PS(55,PSODFN,"P",CNT,0)=RXP
"RTN","PSOPOST7",117,0)
 .I CNT>0 S ^PS(55,PSODFN,"P",0)="^55.03PA^"_CNT_"^"_CNT
"RTN","PSOPOST7",118,0)
 .L -^PS(55,PSODFN)
"RTN","PSOPOST7",119,0)
 K ^TMP("PSOPOST7",$J)
"RTN","PSOPOST7",120,0)
 Q
"RTN","PSOPOST7",121,0)
 ;
"RTN","PSOPOST8")
0^66^B28809794^B28635339
"RTN","PSOPOST8",1,0)
PSOPOST8 ;BIR/EJW-Post install routine - patch PSO*7*129 ;11/14/02
"RTN","PSOPOST8",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**129,268**;DEC 1997;Build 9
"RTN","PSOPOST8",3,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSOPOST8",4,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSOPOST8",5,0)
 ; POST-INSTALL ROUTINE FOR PATCH PSO*7*129 - TO LIST ENTRIES THAT WERE RESET INTO THE PHARMACY PATIENT FILE (#55) BY PATCH PSO*7*115
"RTN","PSOPOST8",6,0)
 S ZTDTH=""
"RTN","PSOPOST8",7,0)
 I $D(ZTQUEUED) S ZTDTH=$H
"RTN","PSOPOST8",8,0)
 L +^XTMP("PSOPOST7"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T D  Q
"RTN","PSOPOST8",9,0)
 .I ZTDTH="" D BMES^XPDUTL("** The clean up job from patch PSO*7*115 is still running. **")
"RTN","PSOPOST8",10,0)
 .D BMES^XPDUTL("A MailMan message is now being generated with instructions on running this")
"RTN","PSOPOST8",11,0)
 .D BMES^XPDUTL("post-install at a later date/time.  Halting...")
"RTN","PSOPOST8",12,0)
 .S MSG="LIST IN USE" D MAIL2
"RTN","PSOPOST8",13,0)
 L -^XTMP("PSOPOST7")
"RTN","PSOPOST8",14,0)
 I ZTDTH="" D
"RTN","PSOPOST8",15,0)
 .D BMES^XPDUTL("The background job to list reset ^PS(55 entries must be queued.")
"RTN","PSOPOST8",16,0)
 .D BMES^XPDUTL("If no start date/time is entered when prompted, the background job will be")
"RTN","PSOPOST8",17,0)
 .D BMES^XPDUTL("queued to run NOW.")
"RTN","PSOPOST8",18,0)
 .D BMES^XPDUTL(" ")
"RTN","PSOPOST8",19,0)
 .D BMES^XPDUTL("Queuing background job to list entries reset into ^PS(55")
"RTN","PSOPOST8",20,0)
 S ZTRTN="RES^PSOPOST8",ZTIO="",ZTDESC="Background job to list entries reset into PS(55" D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOPOST8",21,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOPOST8",22,0)
 Q
"RTN","PSOPOST8",23,0)
RES ;
"RTN","PSOPOST8",24,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOPOST8",25,0)
 I '$D(^XTMP("PSOPOST7")) S MSG="NO ENTRIES TO LIST" D MAIL2 Q
"RTN","PSOPOST8",26,0)
 D NOW^%DTC S ^XTMP("PSOTIMEX","START")=%
"RTN","PSOPOST8",27,0)
 D BMES^XPDUTL("Creating list of reset ^PS(55 entries...")
"RTN","PSOPOST8",28,0)
GETLIST ; PROCESS ENTRIES FROM ^XTMP("PSOPOST7" GLOBAL
"RTN","PSOPOST8",29,0)
 K ^TMP($J,"PSOPOST8")
"RTN","PSOPOST8",30,0)
 S PSOJOB="" F  S PSOJOB=$O(^XTMP("PSOPOST7",PSOJOB)) Q:PSOJOB=""  D
"RTN","PSOPOST8",31,0)
 .S PSOSQ="" F  S PSOSQ=$O(^XTMP("PSOPOST7",PSOJOB,PSOSQ)) Q:PSOSQ=""  D
"RTN","PSOPOST8",32,0)
 ..I PSOSQ="IV"!(PSOSQ="UD") D GETIVUD Q
"RTN","PSOPOST8",33,0)
 ..S NAM=$P($G(^DPT(PSOSQ,0)),"^",1) I NAM="" S NAM="UNKNOWN"
"RTN","PSOPOST8",34,0)
 ..S PSOSQ1="" F  S PSOSQ1=$O(^XTMP("PSOPOST7",PSOJOB,PSOSQ,PSOSQ1)) Q:PSOSQ1=""  D
"RTN","PSOPOST8",35,0)
 ...I PSOSQ1="P,A" D GETPA Q
"RTN","PSOPOST8",36,0)
 ...S PSORX="" F  S PSORX=$O(^XTMP("PSOPOST7",PSOJOB,PSOSQ,PSOSQ1,PSORX)) Q:PSORX=""  S PSORXP=$P($G(^PSRX(PSORX,0)),"^",1) I PSORXP'="" S ^TMP($J,"PSOPOST8",NAM,PSOSQ,"P",PSORXP)=""
"RTN","PSOPOST8",37,0)
 ;
"RTN","PSOPOST8",38,0)
MAIL ;
"RTN","PSOPOST8",39,0)
 D NOW^%DTC S PSOTIMEB=%
"RTN","PSOPOST8",40,0)
 S Y=$G(^XTMP("PSOTIMEX","START")) D DD^%DT S PSOTIMEA=Y
"RTN","PSOPOST8",41,0)
 S Y=$G(PSOTIMEB) D DD^%DT S PSOTIMEB=Y
"RTN","PSOPOST8",42,0)
 S XMDUZ="Patch PSO*7*129",XMY(DUZ)="",XMSUB="PHARMACY PATIENT File (#55) listing of rebuilt entries"
"RTN","PSOPOST8",43,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSNMGR",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOPOST8",44,0)
 K PSOTEXT S PSOTEXT(1)="Patch PSO*7*129 PHARMACY PATIENT File (#55) job is complete.",PSOTEXT(2)="It started on "_$G(PSOTIMEA)_".",PSOTEXT(3)="It ended on "_$G(PSOTIMEB)_"."
"RTN","PSOPOST8",45,0)
 S PSOTEXT(4)=" "
"RTN","PSOPOST8",46,0)
 S PSOTEXT(5)="Listing of cross-references reset by patch PSO*7*115"
"RTN","PSOPOST8",47,0)
 S CNT=5
"RTN","PSOPOST8",48,0)
 S NAM="" F  S NAM=$O(^TMP($J,"PSOPOST8",NAM)) Q:NAM=""  D
"RTN","PSOPOST8",49,0)
 .S DFN="" F  S DFN=$O(^TMP($J,"PSOPOST8",NAM,DFN)) Q:DFN=""  D
"RTN","PSOPOST8",50,0)
 ..D GETPT S CNT=CNT+1,PSOTEXT(CNT)=" ",CNT=CNT+1,PSOTEXT(CNT)=PSOTXT
"RTN","PSOPOST8",51,0)
 ..S PSOSQ="" F  S PSOSQ=$O(^TMP($J,"PSOPOST8",NAM,DFN,PSOSQ)) Q:PSOSQ=""  D
"RTN","PSOPOST8",52,0)
 ...I PSOSQ="UD" S CNT=CNT+1,PSOTEXT(CNT)="  UNIT DOSE STOP DATE CROSS-REFERENCE REBUILT" Q
"RTN","PSOPOST8",53,0)
 ...I PSOSQ="IV" S CNT=CNT+1,PSOTEXT(CNT)="  IV STOP DATE CROSS-REFERENCE REBUILT" Q
"RTN","PSOPOST8",54,0)
 ...I PSOSQ="P" S PSORX="" F  S PSORX=$O(^TMP($J,"PSOPOST8",NAM,DFN,PSOSQ,PSORX)) Q:PSORX=""  S CNT=CNT+1 S PSOTEXT(CNT)="  ""P"" CROSS-REFERENCE REBUILT FOR RX#: "_PSORX
"RTN","PSOPOST8",55,0)
 ...I PSOSQ="P,A" S PSORX="" F  S PSORX=$O(^TMP($J,"PSOPOST8",NAM,DFN,PSOSQ,PSORX)) Q:PSORX=""  S CNT=CNT+1 S PSOTEXT(CNT)="  ""P"",""A"" CROSS-REFERENCE REBUILT FOR RX#: "_PSORX
"RTN","PSOPOST8",56,0)
 S CNT=CNT+1,PSOTEXT(CNT)=" ",PSOTEXT(CNT+1)="**  END OF LIST **"
"RTN","PSOPOST8",57,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD
"RTN","PSOPOST8",58,0)
 G END
"RTN","PSOPOST8",59,0)
 Q
"RTN","PSOPOST8",60,0)
 ;
"RTN","PSOPOST8",61,0)
MAIL2 ;
"RTN","PSOPOST8",62,0)
 S XMDUZ="Patch PSO*7*129",XMY(DUZ)="",XMSUB="PHARMACY PATIENT File (#55)   "_$G(MSG)
"RTN","PSOPOST8",63,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSNMGR",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOPOST8",64,0)
 K PSOTEXT
"RTN","PSOPOST8",65,0)
 S PSOTEXT(1)="Patch PSO*7*129 PHARMACY PATIENT File (#55) - nothing to list.",PSOTEXT(2)=" "
"RTN","PSOPOST8",66,0)
 I $G(MSG)["IN USE" D
"RTN","PSOPOST8",67,0)
 .S PSOTEXT(3)="The post-install job for patch PSO*7*115 is still running."
"RTN","PSOPOST8",68,0)
 .S PSOTEXT(4)="Please run this job later by running ^PSOPOST8 from programmers mode."
"RTN","PSOPOST8",69,0)
 I MSG["NO ENT" D
"RTN","PSOPOST8",70,0)
 .S PSOTEXT(3)="No ^XTMP(""PSOPOST7"" entries exist from post-install job for PSO*7*115."
"RTN","PSOPOST8",71,0)
 S PSOTEXT(5)=" "
"RTN","PSOPOST8",72,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD
"RTN","PSOPOST8",73,0)
 G END
"RTN","PSOPOST8",74,0)
 Q
"RTN","PSOPOST8",75,0)
 ;
"RTN","PSOPOST8",76,0)
GETPT ; GET PATIENT INFORMATION
"RTN","PSOPOST8",77,0)
 D PID^VADPT
"RTN","PSOPOST8",78,0)
 S PSOTXT=$P($G(^DPT(DFN,0)),"^",1)_"  ("_$G(VA("BID"))_")"
"RTN","PSOPOST8",79,0)
 Q
"RTN","PSOPOST8",80,0)
 ;
"RTN","PSOPOST8",81,0)
GETPA ;
"RTN","PSOPOST8",82,0)
 S PSODT="" F  S PSODT=$O(^XTMP("PSOPOST7",PSOJOB,PSOSQ,PSOSQ1,PSODT)) Q:PSODT=""  D
"RTN","PSOPOST8",83,0)
 .S PSORX="" F  S PSORX=$O(^XTMP("PSOPOST7",PSOJOB,PSOSQ,PSOSQ1,PSODT,PSORX)) Q:PSORX=""  S PSORXP=$P($G(^PSRX(PSORX,0)),"^",1) I PSORXP'="" S ^TMP($J,"PSOPOST8",NAM,PSOSQ,"P,A",PSORXP)=""
"RTN","PSOPOST8",84,0)
 Q
"RTN","PSOPOST8",85,0)
 ;
"RTN","PSOPOST8",86,0)
GETIVUD ;
"RTN","PSOPOST8",87,0)
 S PSOSQ1="" F  S PSOSQ1=$O(^XTMP("PSOPOST7",PSOJOB,PSOSQ,PSOSQ1)) Q:PSOSQ1=""  D
"RTN","PSOPOST8",88,0)
 .S NAM=$P($G(^DPT(PSOSQ1,0)),"^",1) I NAM="" S NAM="UNKNOWN"
"RTN","PSOPOST8",89,0)
 .S ^TMP($J,"PSOPOST8",NAM,PSOSQ1,PSOSQ)=""
"RTN","PSOPOST8",90,0)
 Q
"RTN","PSOPOST8",91,0)
 ;
"RTN","PSOPOST8",92,0)
END ;
"RTN","PSOPOST8",93,0)
 K ^TMP($J,"PSOPOST8")
"RTN","PSOPOST8",94,0)
 K PSOTIMEA,PSOTIMEB,XMDUZ,XMSUB,PSOTEXT,XMTEXT,PSOCXPDA,CNT,DFN,MSG,NAM,PSODT,PSOJOB,PSOSQ,PSOSQ1,PSOTXT
"RTN","PSOPOST8",95,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOPOST8",96,0)
 Q
"RTN","PSOPOST8",97,0)
 ;
"RTN","PSOPRVW")
0^47^B35375521^B34650289
"RTN","PSOPRVW",1,0)
PSOPRVW ;BIR/SAB,MHA-enter/edit/view provider ; 2/9/07 10:39am
"RTN","PSOPRVW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,146,153,263,268**;DEC 1997;Build 9
"RTN","PSOPRVW",3,0)
 ;Ref. to ^VA(200 supp. by IA 224
"RTN","PSOPRVW",4,0)
 ;Ref. to ^DIC(7 supp. by IA 491
"RTN","PSOPRVW",5,0)
START W ! S DIC("A")="Select Provider: ",DIC("S")="I $D(^VA(200,+Y,""PS""))",DIC="^VA(200,",DIC(0)="AEQMZ" D ^DIC G:"^"[X EX G:Y<0 START K DIC S PRNO=+Y
"RTN","PSOPRVW",6,0)
 W @IOF,"Name: "_$P(^VA(200,PRNO,0),"^")
"RTN","PSOPRVW",7,0)
 I +$P(^VA(200,PRNO,"PS"),"^",4),$P(^("PS"),"^",4)'>DT W ?40,$C(7),"* * * INACTIVE AS OF ",$E($P(^("PS"),"^",4),4,5),"/",$E($P(^("PS"),"^",4),6,7),"/",$E($P(^("PS"),"^",4),2,3)," * * *"
"RTN","PSOPRVW",8,0)
 ;W !,"SSN#: " S T=$S($P(^VA(200,PRNO,1),"^",9)]"":$P(^(1),"^",9),1:"") W:T $E(T,1,3),"-",$E(T,4,5),"-",$E(T,6,9)
"RTN","PSOPRVW",9,0)
 W !,"Initials: "_$P(^VA(200,PRNO,0),"^",2)
"RTN","PSOPRVW",10,0)
 W !,"NON-VA Prescriber: "
"RTN","PSOPRVW",11,0)
 I $P($G(^VA(200,PRNO,"TPB")),"^")]"" W $S($P(^("TPB"),"^"):"Yes",1:"No")
"RTN","PSOPRVW",12,0)
 W ?40,"Tax ID: "_$P($G(^VA(200,PRNO,"TPB")),"^",2)
"RTN","PSOPRVW",13,0)
 W !,"Exclusionary Check Performed: " I $P($G(^VA(200,PRNO,"TPB")),"^",3)]"" W $S($P(^("TPB"),"^",3):"Yes",1:"No")
"RTN","PSOPRVW",14,0)
 W ?40,"Date Exclusionary List Checked: "
"RTN","PSOPRVW",15,0)
 S Y=$P($G(^VA(200,PRNO,"TPB")),"^",4) I Y W $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)
"RTN","PSOPRVW",16,0)
 W !,"On Exclusionary List: " I $P($G(^VA(200,PRNO,"TPB")),"^",5)]"" W $S($P(^("TPB"),"^",5):"Yes",1:"No")
"RTN","PSOPRVW",17,0)
 W !,"Exclusionary Checked By: "
"RTN","PSOPRVW",18,0)
 I $P($G(^VA(200,PRNO,"TPB")),"^",6) W $P($G(^VA(200,$P(^("TPB"),"^",6),0)),"^")
"RTN","PSOPRVW",19,0)
 W !,"Authorized to Write Orders: "_$S($P(^VA(200,PRNO,"PS"),"^"):"Yes",1:"No"),!,"Requires Cosigner: "_$S($P(^("PS"),"^",7):"Yes",1:"No") I $P(^("PS"),"^",7),$D(^VA(200,+$P(^("PS"),"^",8),0)) W !,"Usual Cosigner: "_$P(^(0),"^")
"RTN","PSOPRVW",20,0)
 W !,"Class: " S PRCLS=+$P(^VA(200,PRNO,"PS"),"^",5),PRCLS=$S(PRCLS>0&$D(^DIC(7,PRCLS,0)):$P(^(0),"^"),1:"") W PRCLS
"RTN","PSOPRVW",21,0)
 W ?40,"DEA# "_$P(^VA(200,PRNO,"PS"),"^",2),!," Type: " S T=+$P(^("PS"),"^",6),L=$P(^DD(200,53.6,0),"^",3)_";"_T_":Unknown" F I=1:1 I $P($P(L,";",I),":",1)=T W $P($P(L,";",I),":",2) Q
"RTN","PSOPRVW",22,0)
 W ?40,"VA#  "_$P(^VA(200,PRNO,"PS"),"^",3),!,"Remarks: "_$P(^("PS"),"^",9),!,"Synonym(s):  "_$S($P($G(^VA(200,PRNO,.1)),"^",4)]"":$P(^(.1),"^",4)_",",1:"")_$S($P(^(0),"^",2)]"":" "_$P(^(0),"^",2),1:"")
"RTN","PSOPRVW",23,0)
 W !,"Service/Section: " S PSOSSDA=$G(DA) I $P($G(^VA(200,PRNO,5)),"^") K DIQ S DIC="^DIC(49,",DA=$P(^VA(200,PRNO,5),"^"),DR=.01,DIQ="PSOSECT",DIQ(0)="E" D EN^DIQ1 W $G(PSOSECT(49,DA,.01,"E")) S DA=$G(PSOSSDA) K DR,DIC,DIQ,PSOSSDA,PSOSECT
"RTN","PSOPRVW",24,0)
 I $TR($G(^VA(200,PRNO,.11)),"^","")="" G NUM
"RTN","PSOPRVW",25,0)
 W !!,"Address: ",?10,$P(^VA(200,PRNO,.11),"^") W:$P(^(.11),"^",2)'="" !?10,$P(^(.11),"^",2) W:$P(^(.11),"^",3)'="" !?10,$P(^(.11),"^",3)
"RTN","PSOPRVW",26,0)
 W !?10,$P(^VA(200,PRNO,.11),"^",4) W:$P(^(.11),"^",4)]"" ", " S STAT=+$P($G(^(.11)),"^",5) W $S($D(^DIC(5,STAT,0)):$P(^(0),"^"),1:"")_"  "_$P(^VA(200,PRNO,.11),"^",6)
"RTN","PSOPRVW",27,0)
NUM G:'$D(^VA(200,PRNO,.13)) START
"RTN","PSOPRVW",28,0)
 W !,"Phone:    "_$P(^VA(200,PRNO,.13),"^"),! W:$P(^(.13),"^",2)]"" "Office:   ",$P(^(.13),"^",2),!
"RTN","PSOPRVW",29,0)
 W:$P(^VA(200,PRNO,.13),"^",3)]"" "Phone #3: "_$P(^(.13),"^",3),?40 W:$P(^(.13),"^",7)]"" "Voice Pager  #: "_$P(^(.13),"^",7) W !
"RTN","PSOPRVW",30,0)
 W:$P(^VA(200,PRNO,.13),"^",4)]"" "Phone #4: "_$P(^(.13),"^",4),?40 W:$P(^(.13),"^",8)]"" "Digital Pager#: "_$P(^(.13),"^",8)
"RTN","PSOPRVW",31,0)
 W:$P(^VA(200,PRNO,.13),"^",6)]"" !,"Fax #:    "_$P(^(.13),"^",6)
"RTN","PSOPRVW",32,0)
 W:$P($G(^VA(200,PRNO,.14)),"^")]"" !,"Room Loc: "_$P(^(.14),"^")
"RTN","PSOPRVW",33,0)
 G START
"RTN","PSOPRVW",34,0)
EX K DIC,DIE,DA,DR,D0,PRNO,PRCLS,STAT,T,Y,X,L,LF,I,DIR,DIROUT,DUOUT,DTOUT,DIRUT,%,%Y,%W,%Z,C,DDH,DI,DIH,DLAYGO,DQ,X1,XMDT,XMN
"RTN","PSOPRVW",35,0)
 Q
"RTN","PSOPRVW",36,0)
ASK ;edit providers
"RTN","PSOPRVW",37,0)
 K DIR,DTOUT,DUOUT,DIROUT,DIRUT
"RTN","PSOPRVW",38,0)
 W !! S DIC("A")="Select Provider: ",(DIC,DIE)=200,DIC(0)="AEQMZ" D ^DIC G:"^"[X EX G:Y<0 ASK S (FADA,DA)=+Y
"RTN","PSOPRVW",39,0)
 I '$D(^VA(200,DA,"PS")) G NPRV
"RTN","PSOPRVW",40,0)
ASK1 W @IOF,?25,"Provider: "_$P(^VA(200,DA,0),"^"),! F DR="TPB","PS",".11",".13",".14" D EN^DIQ
"RTN","PSOPRVW",41,0)
 K DIC,Y
"RTN","PSOPRVW",42,0)
EDT W ! L +^VA(200,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3)
"RTN","PSOPRVW",43,0)
 I '$T W $C(7),!!,"Provider Data is Being Edited by Another User!",! G QX
"RTN","PSOPRVW",44,0)
 N RTPB S RTPB=$G(^VA(200,DA,"TPB"))
"RTN","PSOPRVW",45,0)
 S DR="53.91" D ^DIE I $D(Y)!$D(DTOUT) G QX
"RTN","PSOPRVW",46,0)
 I 'X,$G(PSOTPBFG) G QX
"RTN","PSOPRVW",47,0)
 I X S DR="53.92R;53.93R;53.94R;53.95R"
"RTN","PSOPRVW",48,0)
 E  S DR="53.92;53.93;53.94;53.95"
"RTN","PSOPRVW",49,0)
 S DR=DR_";D:X MS^PSOPRVW",DIE("NO^")="OUTOK" D ^DIE K DIE("NO^")
"RTN","PSOPRVW",50,0)
 I '$D(^VA(200,DA,"TPB")),$G(PSOTPBFG) G QX
"RTN","PSOPRVW",51,0)
 I $D(Y)!$D(DTOUT) D:$P($G(^VA(200,DA,"TPB")),"^",3)  G QX
"RTN","PSOPRVW",52,0)
 .I RTPB=""!('$P(RTPB,"^",3)) S DR="53.96////"_DUZ D ^DIE
"RTN","PSOPRVW",53,0)
 I $P($G(^VA(200,DA,"TPB")),"^",3) D
"RTN","PSOPRVW",54,0)
 .I RTPB=""!('$P(RTPB,"^",3)) S DR="53.96////"_DUZ D ^DIE
"RTN","PSOPRVW",55,0)
 G:$G(PSOTPBFG) QX
"RTN","PSOPRVW",56,0)
ED1 S DR="53.1:53.6;I X'=4 S Y=""@1"";29;8932.1;@1;53.7;I 'X S Y=""@2"";53.8;@2;53.9;.111:.116;.131:.134;.136;.137;.138;.141",DR(2,200.05)=".01;2;3"
"RTN","PSOPRVW",57,0)
 D ^DIE S FADA=DA D:'$D(Y) KEY
"RTN","PSOPRVW",58,0)
QX K FADA,RTPB L -^VA(200,DA) Q:$G(PSOTPBFG)  G:+$G(VADA) ADD G ASK
"RTN","PSOPRVW",59,0)
 Q
"RTN","PSOPRVW",60,0)
 G:'$D(^VA(200,DA,"TPB")) ED1
"RTN","PSOPRVW",61,0)
ADD ;add new providers (kernel 7)
"RTN","PSOPRVW",62,0)
 W !
"RTN","PSOPRVW",63,0)
 S VADA=$$ADD^XUSERNEW("53.91;S:'X Y=""@2"";53.92R;53.93R;53.94R;53.95R;D:X MS^PSOPRVW;@2;53.1;53.2;53.3;53.4;53.5;53.6;53.7;S:'X Y=""@1"";53.8;@1;53.9;.111:.116;.131:.134;.136;.141")
"RTN","PSOPRVW",64,0)
 S (FADA,DA)=+VADA,(DIC,DIE)="^VA(200,"
"RTN","PSOPRVW",65,0)
 I VADA>0,$P(VADA,"^",3),$P($G(^VA(200,DA,"TPB")),"^") D
"RTN","PSOPRVW",66,0)
 .S DR="53.96////"_DUZ D ^DIE
"RTN","PSOPRVW",67,0)
 I VADA>0,'$P(VADA,"^",3) S DIC(0)="AEQMZ" G:'$D(^VA(200,+VADA,"PS")) NPRV G:$D(^VA(200,+VADA,"PS")) ASK1
"RTN","PSOPRVW",68,0)
 D:VADA>0 KEY K DIK,DIC,Y,X,VADA,VA,DEA Q:$G(PSOTPBFG)  K DA G EX
"RTN","PSOPRVW",69,0)
 Q
"RTN","PSOPRVW",70,0)
NPRV W ! S DIR("A",1)=$P(^VA(200,DA,0),"^")_" is NOT currently indicated as being a provider.",DIR("A")="Do you want to make "_$P(^VA(200,DA,0),"^")_" a provider? (Y/N): ",DIR(0)="SA^1:YES;0:NO",DIR("B")="NO"
"RTN","PSOPRVW",71,0)
 S DIR("?",1)="Answer with '1' or 'Yes' if "_$P(^VA(200,DA,0),"^")_" is to become a provider",DIR("?")="otherwise press return for 'No' and re-enter name." D ^DIR G:$D(DTOUT) EX
"RTN","PSOPRVW",72,0)
 G:'Y!($D(DIRUT))&('+$G(VADA)) ASK G:'$P(+$G(VADA),"^",3)&('Y) ADD
"RTN","PSOPRVW",73,0)
 G EDT
"RTN","PSOPRVW",74,0)
 Q
"RTN","PSOPRVW",75,0)
KEY I $D(^VA(200,DA,"PS")) D
"RTN","PSOPRVW",76,0)
 .I '$P(^VA(200,DA,"PS"),"^",4)!($P(^("PS"),"^",4)>DT) S PSOPDA=DA K DIC S DIC="^DIC(19.1,",DIC(0)="MZ",X="PROVIDER" D ^DIC K DIC S DA=PSOPDA K PSOPDA I +Y>0 S X=+Y D
"RTN","PSOPRVW",77,0)
 ..S:'$D(^VA(200,FADA,51,0)) ^VA(200,FADA,51,0)="^"_$P(^DD(200,51,0),"^",2)_"^^"
"RTN","PSOPRVW",78,0)
 ..S DIC="^VA(200,"_FADA_",51,",DIC(0)="LM",DIC("DR")="1////"_$S($G(DUZ):DUZ,1:"")_";2///"_DT,DLAYGO=200.051,DINUM=X,DA(1)=FADA
"RTN","PSOPRVW",79,0)
 ..L +^VA(200,FADA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) K DD,DO D FILE^DICN L -^VA(200,FADA) K DIC,DR,X,Y
"RTN","PSOPRVW",80,0)
 Q
"RTN","PSOPRVW",81,0)
MS ;
"RTN","PSOPRVW",82,0)
 W !!,$C(7),"This provider will not be selectable during TPB medication order entry!!",!
"RTN","PSOPRVW",83,0)
 Q
"RTN","PSORN52A")
0^49^B18015106^B17618155
"RTN","PSORN52A",1,0)
PSORN52A ;IHS/DSD/JCM/SAB/FLS-Break up of PSORN52 ;08/09/93
"RTN","PSORN52A",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**157,148,268**;DEC 1997;Build 9
"RTN","PSORN52A",3,0)
 Q  ; Call from tag
"RTN","PSORN52A",4,0)
 ;
"RTN","PSORN52A",5,0)
IBHLD ;
"RTN","PSORN52A",6,0)
 I $P(PSOIBHLD,"^",2)="" S $P(PSOIBHLD,"^",2)=$S($P(PSOLDIBQ,"^",2)=1:1,$P(PSOLDIBQ,"^",2)=0:0,1:"")
"RTN","PSORN52A",7,0)
 I $P(PSOIBHLD,"^",3)="" S $P(PSOIBHLD,"^",3)=$S($P(PSOLDIBQ,"^",3)=1:1,$P(PSOLDIBQ,"^",3)=0:0,1:"")
"RTN","PSORN52A",8,0)
 I $P(PSOIBHLD,"^",4)="" S $P(PSOIBHLD,"^",4)=$S($P(PSOLDIBQ,"^",4)=1:1,$P(PSOLDIBQ,"^",4)=0:0,1:"")
"RTN","PSORN52A",9,0)
 I $P(PSOIBHLD,"^",5)="" S $P(PSOIBHLD,"^",5)=$S($P(PSOLDIBQ,"^",5)=1:1,$P(PSOLDIBQ,"^",5)=0:0,1:"")
"RTN","PSORN52A",10,0)
 I $P(PSOIBHLD,"^",6)="" S $P(PSOIBHLD,"^",6)=$S($P(PSOLDIBQ,"^",6)=1:1,$P(PSOLDIBQ,"^",6)=0:0,1:"")
"RTN","PSORN52A",11,0)
 I $P(PSOIBHLD,"^",7)="" S $P(PSOIBHLD,"^",7)=$S($P(PSOLDIBQ,"^",7)=1:1,$P(PSOLDIBQ,"^",7)=0:0,1:"")
"RTN","PSORN52A",12,0)
 Q
"RTN","PSORN52A",13,0)
 ;
"RTN","PSORN52A",14,0)
FILE ; - Filling ^PSRX and ^PS(55 entries
"RTN","PSORN52A",15,0)
 S PSOX("NRX0")=PSORENW("RX0"),PSOX("NRX2")=PSORENW("RX2"),PSOX("NRX3")=PSORENW("RX3"),$P(PSOX("NRX3"),"^",5)=""
"RTN","PSORN52A",16,0)
 S $P(PSOX("NRX0"),"^")=PSOX("NRX #") S:$G(PSOX("PROVIDER"))]"" $P(PSOX("NRX0"),"^",4)=PSOX("PROVIDER")
"RTN","PSORN52A",17,0)
 I $G(PSORNSPD),$G(PSOX("PATIENT STATUS")),$G(PSOX("PATIENT STATUS"))?.N S $P(PSOX("NRX0"),"^",3)=PSOX("PATIENT STATUS")
"RTN","PSORN52A",18,0)
 S:$G(PSOX("COSIGNING PROVIDER"))]"" $P(PSOX("NRX3"),"^",3)=PSOX("COSIGNING PROVIDER")
"RTN","PSORN52A",19,0)
 S $P(PSOX("NRX0"),"^",5)=PSOX("CLINIC"),$P(PSOX("NRX0"),"^",9)=PSOX("# OF REFILLS")
"RTN","PSORN52A",20,0)
 I $G(PSOX("DAYS SUPPLY")) S $P(PSOX("NRX0"),"^",8)=PSOX("DAYS SUPPLY")
"RTN","PSORN52A",21,0)
 I $G(PSOX("QTY")) S $P(PSOX("NRX0"),"^",7)=PSOX("QTY")
"RTN","PSORN52A",22,0)
 S $P(PSOX("NRX0"),"^",11)=$S(PSOX("FILL DATE")>DT&($P(PSOPAR,"^",6)):"M",$D(PSOX("MAIL/WINDOW")):PSOX("MAIL/WINDOW"),1:$P(PSOX("NRX0"),"^",11))
"RTN","PSORN52A",23,0)
 S $P(PSOX("NRX0"),"^",13)=PSOX("ISSUE DATE"),$P(PSOX("STA"),"^")=PSOX("STATUS"),$P(PSOX("NRX0"),"^",16)=$S($G(PSOX("CLERK CODE"))]"":PSOX("CLERK CODE"),1:DUZ)
"RTN","PSORN52A",24,0)
 S $P(PSOX("NRX0"),"^",17)=$G(PSODRUG("COST"))
"RTN","PSORN52A",25,0)
 S $P(PSOX("NRX2"),"^")=PSOX("LOGIN DATE"),$P(PSOX("NRX2"),"^",2)=PSOX("FILL DATE"),$P(PSOX("NRX2"),"^",3)="",$P(PSOX("NRX2"),"^",5)=PSOX("DISPENSED DATE")
"RTN","PSORN52A",26,0)
 S $P(PSOX("NRX2"),"^",6)=PSOX("STOP DATE"),$P(PSOX("NRX2"),"^",7)=$S($G(PSOX("NDC"))]"":PSOX("NDC"),1:$G(PSODRUG("NDC")))
"RTN","PSORN52A",27,0)
 S $P(PSOX("NRX2"),"^",8)=$S($G(PSOX("MANUFACTURER"))]"":PSOX("MANUFACTURER"),1:$G(PSODRUG("MANUFACTURER")))
"RTN","PSORN52A",28,0)
 S $P(PSOX("NRX2"),"^",9)=+PSOSITE,$P(PSOX("NRX2"),"^",10)=""
"RTN","PSORN52A",29,0)
 S $P(PSOX("NRX2"),"^",11)=$S($G(PSOX("EXPIRATION DATE"))]"":PSOX("EXPIRATION DATE"),1:$G(PSODRUG("EXPIRATION DATE")))
"RTN","PSORN52A",30,0)
 S:$G(PSOX("GENERIC PROVIDER"))]"" $P(PSOX("NRX2"),"^",12)=PSOX("GENERIC PROVIDER")
"RTN","PSORN52A",31,0)
 S $P(PSOX("NRX2"),"^",13)="",$P(PSOX("NRX2"),"^",15)="",$P(PSOX("NRX3"),"^",4)=$P(PSOX("NRX3"),"^")
"RTN","PSORN52A",32,0)
 S $P(PSOX("EPH"),"^")=$S($G(PSOX("DAW"))]"":PSOX("DAW"),1:$G(PSODRUG("DAW")))
"RTN","PSORN52A",33,0)
 ;S PSOX("LAST DISPENSED DATE")=$P(PSOX("NRX3"),"^")
"RTN","PSORN52A",34,0)
 S PSOX("LAST DISPENSED DATE")=PSOX("DISPENSED DATE")
"RTN","PSORN52A",35,0)
 S $P(PSOX("NRX3"),"^")=PSOX("LAST DISPENSED DATE")
"RTN","PSORN52A",36,0)
 S:$G(PSOX("NEXT POSSIBLE REFILL"))]"" $P(PSOX("NRX3"),"^",2)=PSOX("NEXT POSSIBLE REFILL")
"RTN","PSORN52A",37,0)
 S:'$P(^VA(200,$P(PSOX("NRX0"),"^",4),"PS"),"^",7) $P(PSOX("NRX3"),"^",3)=""
"RTN","PSORN52A",38,0)
 S:$G(PSOX("REMARKS"))']"" PSOX("REMARKS")="RENEWED FROM RX # "_$P(PSOX("RX0"),"^")
"RTN","PSORN52A",39,0)
 S $P(PSOX("NRX3"),"^",7)=PSOX("REMARKS"),$P(PSOX("NRX3"),"^",8)=""
"RTN","PSORN52A",40,0)
 ;
"RTN","PSORN52A",41,0)
 ; - File OTHER PATIENT INSTRUCTIONS into ^PSRX
"RTN","PSORN52A",42,0)
 I $G(PSOFXRNX) S PSOFXRN=1
"RTN","PSORN52A",43,0)
 D ^PSORN52C,FILE^PSORN52D
"RTN","PSORN52A",44,0)
 I $G(^PSRX(PSOX("OIRXN"),"INSS"))]"" S ^PSRX(PSOX("IRXN"),"INSS")=^PSRX(PSOX("OIRXN"),"INSS") K PSOX1 G F55
"RTN","PSORN52A",45,0)
 I $G(PSOX("SINS"))]"" S ^PSRX(PSOX("IRXN"),"INSS")=PSOX("SINS")
"RTN","PSORN52A",46,0)
 K PSOX1
"RTN","PSORN52A",47,0)
 ;
"RTN","PSORN52A",48,0)
 ; - File data into ^PS(55)
"RTN","PSORN52A",49,0)
F55 L +^PS(55,PSODFN,"P"):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) S:'$D(^PS(55,PSODFN,"P",0)) ^(0)="^55.03PA^^"
"RTN","PSORN52A",50,0)
 F PSOX1=$P(^PS(55,PSODFN,"P",0),"^",3):1 Q:'$D(^PS(55,PSODFN,"P",PSOX1))
"RTN","PSORN52A",51,0)
 S PSOX("55 IEN")=PSOX1
"RTN","PSORN52A",52,0)
 S ^PS(55,PSODFN,"P",PSOX1,0)=PSOX("IRXN"),$P(^PS(55,PSODFN,"P",0),"^",3,4)=PSOX1_"^"_($P(^PS(55,PSODFN,"P",0),"^",4)+1)
"RTN","PSORN52A",53,0)
 S ^PS(55,PSODFN,"P","A",PSOX("STOP DATE"),PSOX("IRXN"))=""
"RTN","PSORN52A",54,0)
 L -^PS(55,PSODFN,"P")
"RTN","PSORN52A",55,0)
 K PSOX1
"RTN","PSORN52A",56,0)
 ;
"RTN","PSORN52A",57,0)
 ; - Patient Counseling questions
"RTN","PSORN52A",58,0)
 I $G(OR0) D FULL^VALM1,COUN^PSONEW S PSONOOR=""
"RTN","PSORN52A",59,0)
 I $D(^XUSEC("PSORPH",DUZ)) S DA=PSOX("IRXN"),DIE=52,DR="41////"_PSOCOU_";S:'X Y=""@1"";42////"_PSOCOUU_";@1" D ^DIE K DIE,DR
"RTN","PSORN52A",60,0)
 ;
"RTN","PSORN52A",61,0)
 ; - Re-indexing file 52 entry
"RTN","PSORN52A",62,0)
 K DIK,DA S DIK="^PSRX(",DA=PSOX("IRXN") D IX1^DIK K DIK
"RTN","PSORN52A",63,0)
 S DA=PSOX("IRXN") D ORC^PSORN52C
"RTN","PSORN52A",64,0)
 Q
"RTN","PSORX1")
0^50^B60587964^B48416353
"RTN","PSORX1",1,0)
PSORX1 ;BIR/SAB-medication processing driver ;3/28/05 1:14pm
"RTN","PSORX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,22,23,57,62,46,74,71,90,95,115,117,146,139,135,182,195,233,268**;DEC 1997;Build 9
"RTN","PSORX1",3,0)
 ;External reference PDA^PPPPDA1 supported by DBIA 1374
"RTN","PSORX1",4,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSORX1",5,0)
 ;External reference ^DIC(31 supported by DBIA 658
"RTN","PSORX1",6,0)
 ;External reference ^DPT(D0,.372 supported by DBIA 1476
"RTN","PSORX1",7,0)
 ;External reference DISPPRF^DGPFAPI supported by DBIA #4563
"RTN","PSORX1",8,0)
 ;External reference ^ORRDI1 is supported by DBIA 4659
"RTN","PSORX1",9,0)
 ;External reference ^XTMP("ORRDI" is supported by DBIA 4660
"RTN","PSORX1",10,0)
 ;
"RTN","PSORX1",11,0)
 ;PSO*195 add call to display Patient Record Flag (DISPPRF^DGPFAPI)
"RTN","PSORX1",12,0)
 ;
"RTN","PSORX1",13,0)
START K PSOQFLG,PSOID,PSOFIN,PSOQUIT,PSODRUG S (PSOBCK,PSOERR)=1 D INIT G:PSORX("QFLG") END
"RTN","PSORX1",14,0)
 D PT G:$G(PSORX("QFLG")) END D FULL^VALM1 I $G(NOPROC) K NOPROC G NX
"RTN","PSORX1",15,0)
 ;call to add bingo board data to file 52.11
"RTN","PSORX1",16,0)
 F SLPPL=0:0 S SLPPL=$O(RXRS(SLPPL)) Q:'SLPPL  D
"RTN","PSORX1",17,0)
 .I $P($G(^PSRX(SLPPL,"STA")),"^")'=5 K RXRS(SLPPL) Q
"RTN","PSORX1",18,0)
 .S RXREC=SLPPL D WIND^PSOSUPOE I $G(PBINGRTE) D BBADD^PSOSUPOE S (BINGCRT,BINGRTE)=1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL"
"RTN","PSORX1",19,0)
 K TM,TM1 I $G(PSORX("PSOL",1))]""!($D(RXRS)) D ^PSORXL K PSORX S PSOPBM1=1
"RTN","PSORX1",20,0)
 G:$G(NOBG) NX
"RTN","PSORX1",21,0)
 S TM=$P(^TMP("PSOBB",$J),"^"),TM1=$P(^TMP("PSOBB",$J),"^",2) K ^TMP("PSOBB",$J)
"RTN","PSORX1",22,0)
 I $G(PSOFROM)="NEW"!($G(PSOFROM)="REFILL")!($G(PSOFROM)="PARTIAL") D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BINGCRT,BINGRTE,BBRX,BBFLG
"RTN","PSORX1",23,0)
 I $G(PSOPBM),$G(PSOPBM1) S $P(^PS(55,PSODFN,0),"^",7)=PSOPBM,$P(^(0),"^",8)="A" K PSOPBM,PSOPBM1
"RTN","PSORX1",24,0)
NX I $G(POERR("DEAD"))!$G(PSOQFLG) D EOJ G START
"RTN","PSORX1",25,0)
 D EOJ G START
"RTN","PSORX1",26,0)
END Q
"RTN","PSORX1",27,0)
 ;---------------------------------------------------------
"RTN","PSORX1",28,0)
INIT ;
"RTN","PSORX1",29,0)
 S PSORX("QFLG")=0
"RTN","PSORX1",30,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) S PSORX("QFLG")=1
"RTN","PSORX1",31,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSORX1",32,0)
INITX Q
"RTN","PSORX1",33,0)
 ;
"RTN","PSORX1",34,0)
PT ;
"RTN","PSORX1",35,0)
 K ^TMP("PSORXDC",$J),CLOZPAT,DIC,PSODFN,PSOPBM,PSOPBM1 S PSORX("QFLG")=0,DIC=2,DIC(0)="QEAM" D ^DIC K DIC,DA
"RTN","PSORX1",36,0)
 I +Y'>0 S PSORX("QFLG")=1 G PTX
"RTN","PSORX1",37,0)
OERR N:$G(MEDP) PAT,POERR K PSOXFLG S (DFN,PSODFN)=+Y,PSORX("NAME")=$P(Y,"^",2)
"RTN","PSORX1",38,0)
 K NPPROC,PSOQFLG,DIC,DR,DIQ S DIC=2,DA=PSODFN,DR=.351,DIQ="PSOPTPST" D EN^DIQ1 K DIC,DA,DR,DIQ D DEAD^PSOPTPST I $G(PSOQFLG) S NOPROC=1 Q
"RTN","PSORX1",39,0)
 ;PSO*195 move SSN write to here and add DISPPRF call
"RTN","PSORX1",40,0)
 S SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")
"RTN","PSORX1",41,0)
 W " ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")" K SSN
"RTN","PSORX1",42,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D  I PSONOAL'="" D PAUSE
"RTN","PSORX1",43,0)
 .I PSONOAL'="" W !,$C(7),"     No Allergy Assessment!"
"RTN","PSORX1",44,0)
 D REMOTE
"RTN","PSORX1",45,0)
 N PSOUPDT
"RTN","PSORX1",46,0)
 S PSOUPDT=1
"RTN","PSORX1",47,0)
 I XQY0["PSO LMOE FINISH" S PSOUPDT=0
"RTN","PSORX1",48,0)
 D CHKADDR^PSOBAI(PSODFN,1,PSOUPDT)
"RTN","PSORX1",49,0)
 D:(XQY0["PSO LMOE FINISH")&('$G(SNGLPAT)) DISPPRF^DGPFAPI(PSODFN)
"RTN","PSORX1",50,0)
 ;
"RTN","PSORX1",51,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") W !?10,"Patient has another language preference!",! H 3
"RTN","PSORX1",52,0)
 I $G(^PS(55,"ASTALK",PSODFN)) W !,"Patient is enrolled to receive ScripTalk 'talking' prescription labels.",! H 2 D MAIL
"RTN","PSORX1",53,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSORX1",54,0)
 I '$G(MEDP) S X="PPPPDA1" X ^%ZOSF("TEST") S:$T X=$$PDA^PPPPDA1(PSODFN)
"RTN","PSORX1",55,0)
 S PSOQFLG=0,DIC="^PS(55,",DLAYGO=55
"RTN","PSORX1",56,0)
 K PSOPBM ; KILL SO THAT WON'T CARRY OVER PRIOR PATIENT'S VALUE
"RTN","PSORX1",57,0)
 I '$D(^PS(55,PSODFN,0)) D
"RTN","PSORX1",58,0)
 .S PSOPBM=$P(TM,".")
"RTN","PSORX1",59,0)
 .K DD,DO S DIC(0)="L",(DINUM,X)=PSODFN D FILE^DICN D:Y<1  K DIC,DA,DR,DD,DO
"RTN","PSORX1",60,0)
 ..S $P(^PS(55,PSODFN,0),"^")=PSODFN K DIK S DA=PSODFN,DIK="^PS(55,",DIK(1)=.01 D EN^DIK K DIK
"RTN","PSORX1",61,0)
 D RXSTA
"RTN","PSORX1",62,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSORX1",63,0)
 I $G(^PS(55,PSODFN,"PS"))']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSORX1",64,0)
 .L +^PS(55,PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W $C(7),!!,"Patient Data is Being Edited by Another User!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1 Q
"RTN","PSORX1",65,0)
 .S PSOXFLG=1,SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")",! K SSN
"RTN","PSORX1",66,0)
 .S DIE=55,DR=".02;.03;.04;.05;1;D ELIG^PSORX1;3;50;106;106.1",DA=PSODFN W !!,?5,">>PHARMACY PATIENT DATA<<",! D ^DIE L -^PS(55,PSODFN)
"RTN","PSORX1",67,0)
 S PSOX=$G(^PS(55,PSODFN,"PS")) I PSOX]"" S PSORX("PATIENT STATUS")=$P($G(^PS(53,PSOX,0)),"^")
"RTN","PSORX1",68,0)
 I $G(^PS(55,PSODFN,"PS"))']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSORX1",69,0)
 .W !!,"Patient Status Required!!",! D ELIG
"RTN","PSORX1",70,0)
 .W ! K POERR("QFLG"),DIC,DR,DIE S DIC("A")="RX PATIENT STATUS: ",DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSORX1",71,0)
 .I $D(DIRUT)!(Y=-1) D  Q
"RTN","PSORX1",72,0)
 ..W $C(7),"Required Data!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1
"RTN","PSORX1",73,0)
 ..I $G(PSOPBM) D  K PSOPBM
"RTN","PSORX1",74,0)
 ...I $O(^PS(55,PSODFN,0))="" S DA=PSODFN,DIK="^PS(55," D ^DIK
"RTN","PSORX1",75,0)
 .S ^PS(55,PSODFN,"PS")=+Y,PSORX("PATIENT STATUS")=$P(^PS(53,+Y,0),"^")
"RTN","PSORX1",76,0)
 .K DIRUT,DTOUT,DUOUT,X,Y,DA
"RTN","PSORX1",77,0)
 Q:$G(PSOFIN)
"RTN","PSORX1",78,0)
 I '$G(PSOPBM),'$P(^PS(55,PSODFN,0),"^",7),$P(^(0),"^",8)']"" S PSOPBM=$P(TM,".")
"RTN","PSORX1",79,0)
 D ^PSOBUILD
"RTN","PSORX1",80,0)
 F PT="GET","DEAD","INP","CNH","TPB","ADDRESS","COPAY" S RTN=PT_"^PSOPTPST" D @RTN Q:$G(POERR("DEAD"))!($G(PSOQFLG))
"RTN","PSORX1",81,0)
 I $G(POERR("DEAD")) S POERR("QFLG")=1 F II=0:0 S II=$O(^PS(52.41,"P",PSODFN,II)) D:$P($G(^PS(52.41,II,0)),"^",3)'="DC"&($P($G(^(0)),"^",3)'="DE") DC^PSOORFI2
"RTN","PSORX1",82,0)
 K PSOERR("DEAD"),II I $G(PSOQFLG) S POERR("QFLG")=1 G EOJ Q
"RTN","PSORX1",83,0)
 S (PAT,PSOXXDFN)=PSODFN,POERR=1 D ^PSOORUT2,BLD^PSOORUT1,EN^PSOLMUTL
"RTN","PSORX1",84,0)
 D CLEAR^VALM1 G:$G(PSOQUIT) PTX D EN^PSOLMAO
"RTN","PSORX1",85,0)
 S (DFN,PSODFN)=PSOXXDFN K DIE,DIC,DLAYGO,DR,DA,PSOX,PSORXED
"RTN","PSORX1",86,0)
PTX ;
"RTN","PSORX1",87,0)
 K X,Y,^TMP("PS",$J),C,DEA,PRC,PSCNT,PSOACT,PSOCLC,PSOCS,PSOCT,PSOFINFL,PSOHD,PSOLST,PSOOPT,PSOPF,PSOX,PSOX1,PSOXXDFN,SIGOK,STP,STR
"RTN","PSORX1",88,0)
 Q
"RTN","PSORX1",89,0)
EOJ ;
"RTN","PSORX1",90,0)
 K PSOERR,PSOMED,PSORX,PSOSD,PSODRUG,PSODFN,PSOOPT,PSOBILL,PSOIBQS,PSOCPAY,PSOPF,PSOPI,COMM,DGI,DGS,PT,PTDY,PTRF,RN,RTN,SERS,ST0,STAT,DFN,STOP,SLPPL,RXREC,PSOPBM
"RTN","PSORX1",91,0)
 K:'$G(MEDP) PSOQFLG
"RTN","PSORX1",92,0)
 D KVA^VADPT,FULL^VALM1 K PSOLST,PSOXFLG,PSCNT,PSDIS,PSOAL,P1,LOG,%,%DT,%I,D0,DAT,DFN,DRG,ORX,PSON,PSOPTPST,PSORX,PTST,PSOBCK,PSOID,PSOBXPUL
"RTN","PSORX1",93,0)
 K INCOM,SIG,SG,STP,RX0,RXN,RX2,RX3,RTS,C,DEAD,PS,PSOCLC,PSOCNT,PSOCT,PSODA,PSOFROM,PSOHD,R3,REA,RF,RFD,RFM,RLD,RXNUM,RXP,RXPR,RXRP,RXRS,STR,POERR,VALMSG
"RTN","PSORX1",94,0)
 K ^TMP("PSORXDC",$J),^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J) I '$G(MEDP),'$G(PSOQUIT) K PAT
"RTN","PSORX1",95,0)
 K PSORX,RFN,PSOXXDFN,VALM,VALMKEY,PSOBCK,SPOERR,PSOFLAG,VALMBCK,D,GMRA,GMRAL,GMRAREC,PSOSTA,PSODT,RXFL,NOBG,BBRX,BBFLG
"RTN","PSORX1",96,0)
 Q
"RTN","PSORX1",97,0)
ELIG ; shows eligibility and disabilities
"RTN","PSORX1",98,0)
 D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"") S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSORX1",99,0)
 W !,"Disabilities: " F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSORX1",100,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSORX1",101,0)
 .W:$L(PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 !,?15
"RTN","PSORX1",102,0)
 .W $S($G(PSDIS)]"":PSDIS_"-",1:"")_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSORX1",103,0)
 K N
"RTN","PSORX1",104,0)
 Q
"RTN","PSORX1",105,0)
PROFILE ;
"RTN","PSORX1",106,0)
 S (PSORX("REFILL"),PSORX("RENEW"))=0,PSOX="" D ^PSOBUILD
"RTN","PSORX1",107,0)
 I '$G(PSOSD) W !,"This patient has no prescriptions" S:'$D(DFN) DFN=PSODFN D GMRA^PSODEM G PROFILEX
"RTN","PSORX1",108,0)
 S (PSODRG,PSOX)="" F  S PSODRG=$O(PSOSD(PSODRG)) Q:PSODRG=""  F  S PSOX=$O(PSOSD(PSODRG,PSOX)) Q:PSOX=""  S:$P(PSOSD(PSODRG,PSOX),"^",3)="" PSORX("RENEW")=1 S:$P(PSOSD(PSODRG,PSOX),"^",4)="" PSORX("REFILL")=1
"RTN","PSORX1",109,0)
 K PSOX
"RTN","PSORX1",110,0)
PROFILEX Q
"RTN","PSORX1",111,0)
 ;
"RTN","PSORX1",112,0)
MAIL ; MAKE SURE MAIL STATUS IS COMPATIBLE WITH SCRIPTALK PATIENT
"RTN","PSORX1",113,0)
 I $P($G(^PS(59,PSOSITE,"STALK")),"^")="" Q  ; NO SCRIPTALK PRINTER SET UP FOR THIS DIVISION
"RTN","PSORX1",114,0)
 N MAIL
"RTN","PSORX1",115,0)
 S MAIL=$G(^PS(55,PSODFN,0)) I $P(MAIL,"^",3)>1 Q
"RTN","PSORX1",116,0)
MAILP W !!,"REMINDER: CMOP does not fill ScripTalk prescriptions.Please select mail"
"RTN","PSORX1",117,0)
 W !,"status:  2 (DO NOT MAIL), 3 (LOCAL REGULAR MAIL) or 4 (LOCAL CERTFIED MAIL)."
"RTN","PSORX1",118,0)
 R !,"MAIL: ",MAIL:120
"RTN","PSORX1",119,0)
 I MAIL?1"^".E Q
"RTN","PSORX1",120,0)
 I MAIL<2!(MAIL>4) W !,"INVALID MAIL SETTING - ENTER 2,3, OR 4" G MAILP
"RTN","PSORX1",121,0)
 W "  ",$S(MAIL=2:"DO NOT MAIL",MAIL=3:"LOCAL REGULAR MAIL",1:"LOCAL CERTIFIED MAIL")
"RTN","PSORX1",122,0)
 S $P(^PS(55,PSODFN,0),"^",3)=MAIL
"RTN","PSORX1",123,0)
 Q
"RTN","PSORX1",124,0)
REMOTE ; 
"RTN","PSORX1",125,0)
 I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSORX1",126,0)
 I '$$HAVEHDR^ORRDI1 Q
"RTN","PSORX1",127,0)
 I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) W !,"Remote data not available - Only local order checks processed." D  Q
"RTN","PSORX1",128,0)
 .K DIR W ! S DIR(0)="EA",DIR("A")="Press Return to continue..." D ^DIR W ! K DIR
"RTN","PSORX1",129,0)
 Q
"RTN","PSORX1",130,0)
PAUSE ;
"RTN","PSORX1",131,0)
 W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSORX1",132,0)
 Q
"RTN","PSORX1",133,0)
 ;
"RTN","PSORX1",134,0)
RXSTA ; DISPLAY ELIGIBILITY & PROMPT FOR RX PATIENT STATUS
"RTN","PSORX1",135,0)
 N DA,PSOSTA
"RTN","PSORX1",136,0)
 I '$G(PSODFN) Q
"RTN","PSORX1",137,0)
 S DA=PSODFN,PSOSTA=$G(^PS(55,PSODFN,"PS"))
"RTN","PSORX1",138,0)
 I XQY0["PSO LMOE FINISH"!(XQY0["PSO LM BACKDOOR ORDERS") I PSOSTA]"" D
"RTN","PSORX1",139,0)
 .D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"")
"RTN","PSORX1",140,0)
 .S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSORX1",141,0)
 .S DIC("A")="RX PATIENT STATUS: ",DIC("B")=PSOSTA,DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSORX1",142,0)
 .I +Y>0,+Y'=PSOSTA S DIE="^PS(55,",DR="3////"_+Y D ^DIE
"RTN","PSORX1",143,0)
 Q
"RTN","PSORXI")
0^52^B6810533^B6406998
"RTN","PSORXI",1,0)
PSORXI ;IHS/DSD/JCM - logs pharmacy interventions ; 03/19/93 11:56
"RTN","PSORXI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**268**;DEC 1997;Build 9
"RTN","PSORXI",3,0)
 ; This routine is used to create entries in the APSP INTERVENTION file.
"RTN","PSORXI",4,0)
START ;   
"RTN","PSORXI",5,0)
 D INIT,DIC G:PSORXI("QFLG") END
"RTN","PSORXI",6,0)
 D EDIT
"RTN","PSORXI",7,0)
 S:'$D(PSONEW("PROVIDER")) PSONEW("PROVIDER")=$P(^APSPQA(32.4,PSORXI("DA"),0),"^",3)
"RTN","PSORXI",8,0)
END D EOJ
"RTN","PSORXI",9,0)
 Q
"RTN","PSORXI",10,0)
INIT ;
"RTN","PSORXI",11,0)
 W !!,"Now creating Pharmacy Intervention",!
"RTN","PSORXI",12,0)
 I $G(PSODRUG("IEN")) W "for  "_$P($G(^PSDRUG(PSODRUG("IEN"),0)),"^"),!
"RTN","PSORXI",13,0)
 K PSORXI S PSORXI("QFLG")=0
"RTN","PSORXI",14,0)
 Q
"RTN","PSORXI",15,0)
DIC ;
"RTN","PSORXI",16,0)
 K DIC,DR,DA,X,Y,DD,DO S DIC="^APSPQA(32.4,",DLAYGO=9009032.4,DIC(0)="L",X=DT
"RTN","PSORXI",17,0)
 S DIC("DR")=".02////"_+PSODFN_";.04////"_DUZ_";.05////"_PSODRUG("IEN")_";.06///PHARMACY"
"RTN","PSORXI",18,0)
 S DIC("DR")=DIC("DR")_";.07"_$S($G(PSORX("INTERVENE"))=1:"////18",$G(PSORX("INTERVENE"))=2:"////19",1:"////6")_";.14////0"_";.16////"_$S($G(PSOSITE)]"":PSOSITE,1:"")
"RTN","PSORXI",19,0)
 D FILE^DICN K DIC,DR,DA
"RTN","PSORXI",20,0)
 I Y>0 S PSORXI("DA")=+Y
"RTN","PSORXI",21,0)
 E  S PSORXI("QFLG")=1 G DICX
"RTN","PSORXI",22,0)
 D DIE
"RTN","PSORXI",23,0)
DICX K X,Y
"RTN","PSORXI",24,0)
 Q
"RTN","PSORXI",25,0)
DIE ;
"RTN","PSORXI",26,0)
 K DIE,DIC,DR,DA
"RTN","PSORXI",27,0)
 S DIE="^APSPQA(32.4,",DA=PSORXI("DA"),DR=$S($G(PSORXI("EDIT"))]"":".03:1600",1:".03;.08")
"RTN","PSORXI",28,0)
 L +^APSPQA(32.4,PSORXI("DA")):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) D ^DIE K DIE,DIC,DR,X,Y,DA L -^APSPQA(32.4,PSORXI("DA"))
"RTN","PSORXI",29,0)
 W $C(7),!!,"See 'Pharmacy Intervention Menu' if you want to delete this",!,"intervention or for more options.",!
"RTN","PSORXI",30,0)
 Q
"RTN","PSORXI",31,0)
EDIT ;
"RTN","PSORXI",32,0)
 K DIR W ! S DIR(0)="Y",DIR("A")="Would you like to edit this intervention ",DIR("B")="N" D ^DIR K DIR I $D(DIRUT)!'Y G EDITX
"RTN","PSORXI",33,0)
 S PSORXI("EDIT")=1 D DIE G EDIT
"RTN","PSORXI",34,0)
EDITX K X,Y
"RTN","PSORXI",35,0)
 Q
"RTN","PSORXI",36,0)
EOJ ;
"RTN","PSORXI",37,0)
 K PSORXI
"RTN","PSORXI",38,0)
 Q
"RTN","PSORXI",39,0)
EN1(PSOX) ; Entry Point if have internal rx #
"RTN","PSORXI",40,0)
 N PSODFN,PSONEW,PSODRUG,PSOY
"RTN","PSORXI",41,0)
 I $G(^PSRX(+$G(PSOX),0))']"" W !,$C(7),"No prescription data" G EN1X
"RTN","PSORXI",42,0)
 S PSORXI("IRXN")=PSOX K PSOY S PSOY=^PSRX(PSORXI("IRXN"),0)
"RTN","PSORXI",43,0)
 S PSODFN=$P(PSOY,"^",2),PSONEW("PROVIDER")=$P(PSOY,"^",4),PSODRUG("IEN")=$P(PSOY,"^",6)
"RTN","PSORXI",44,0)
 D START
"RTN","PSORXI",45,0)
EN1X Q
"RTN","PSOSITED")
0^53^B6167263^B5520744
"RTN","PSOSITED",1,0)
PSOSITED ;BHAM ISC/SAB - ENTER/EDIT OUTPATIENT SITE PARAMETERS ; 09/18/92 9:11
"RTN","PSOSITED",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**24,65,268**;DEC 1997;Build 9
"RTN","PSOSITED",3,0)
 ;External reference to ^PS(59.7 supported by DBIA 694
"RTN","PSOSITED",4,0)
 I $G(PSOPAR)']"" D ^PSOLSET
"RTN","PSOSITED",5,0)
1 W ! K DIC S DIC("A")="Select SITE NAME: ",(DIC,DIE)="^PS(59,",DIC(0)="QEALM",DLAYGO=59
"RTN","PSOSITED",6,0)
 K PSOSITEX D ^DIC G:"^"[X EX K DIC("A") G:Y<0 1 S DA=+Y D FLDQ G:$D(PSOSITEX) EX S DR="[PSO SITE]" W ! D ^DIE
"RTN","PSOSITED",7,0)
 W !!,"Outpatient System Parameters",! S DA=1,DIE=59.7,DR="40;40.1;40.19;40.14;40.15" L +^PS(59.7,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W !,"Another person is editing this entry.  Try Later!",! K DA,DIE,DR G 1
"RTN","PSOSITED",8,0)
 D ^DIE L -^PS(59.7,DA)
"RTN","PSOSITED",9,0)
 N CNT,TOT S (TOT,CNT)=0 F  S CNT=$O(^PS(59,CNT)) Q:'CNT  S TOT=TOT+1
"RTN","PSOSITED",10,0)
 D:TOT>1 ^PSODIV K CNT,TOT
"RTN","PSOSITED",11,0)
 S:$G(PSOSITE)=DA PSOPAR=$G(^PS(59,DA,1)),PSOPAR7=$G(^PS(59,DA,"IB")),PSOSYS=$G(^PS(59.7,1,40.1)) D EX G 1
"RTN","PSOSITED",12,0)
EX K DIC,DA,DIE,DIR,DIV,DR,I,PS1,PS11,PSIX,PSOCNT,PSOSITEX,X,Y,%,%X,%Y,D0,DI,DQ,DX,S Q
"RTN","PSOSITED",13,0)
 Q
"RTN","PSOSITED",14,0)
FLDQ S DIR("?",1)="Press <RETURN> if you want to see a list of all outpatient",DIR("?")="pharmacy answered site fields.  Enter 'N' if you don't want to see the list."
"RTN","PSOSITED",15,0)
 S DIR(0)="Y",DIR("A")="Would you like to see all site parameters for this division",DIR("B")="Y" D ^DIR K DIR S:$D(DTOUT) PSOSITEX="" I Y,'$D(PSOSITEX) W @IOF D EN^DIQ
"RTN","PSOSITED",16,0)
 K DIR Q
"RTN","PSOSUP")
0^54^B7482949^B6881424
"RTN","PSOSUP",1,0)
PSOSUP ;BHAM ISC/SAB-ENTER PHARMACISTS ; 07/13/92 16:43
"RTN","PSOSUP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,268**;DEC 1997;Build 9
"RTN","PSOSUP",3,0)
 W @IOF
"RTN","PSOSUP",4,0)
 I DUZ(0)'="@",'$D(^XUSEC("XUMGR",DUZ)),'$D(^XUSEC("PSORPH",DUZ)) W !,$C(7),"You Must Hold the 'PSORPH' key in order to be able to use this option!",! G EX
"RTN","PSOSUP",5,0)
ASK R !!,"Select PHARMACIST: ",X:DTIME S:'$T X="^" G:"^"[X EX D PHASK:X["?" S DIC=200,DIC(0)="EQMZ" D ^DIC G PSOSUP:X="?"!(Y<0) S PHARM=$P(Y(0),"^"),PSN=+Y
"RTN","PSOSUP",6,0)
 S DA=PSN,DIC(0)="EQMZ",(DIE,DIC)=200 D ^DIC I Y>0 S DA=+Y,DIE=DIC,DR="51///PSORPH",DR(51,200.051)=".01///PSORPH;1////"_$S($G(DUZ):DUZ,1:"")_";2///"_DT L +^VA(200,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) D ^DIE L -^VA(200,DA)
"RTN","PSOSUP",7,0)
 I $D(Y)!('$D(^XUSEC("PSORPH",PSN))) W !,$P(^VA(200,PSN,0),"^")_" DOES NOT hold the 'PSORPH' Security Key",! D EX G ASK
"RTN","PSOSUP",8,0)
 W !,$P(^VA(200,PSN,0),"^")_" now holds the 'PSORPH' Security Key",! G ASK
"RTN","PSOSUP",9,0)
EX K %,X,Y,%Y,C,D0,D1,DA,DI,DIE,DIQ,DIH,DIU,DIV,DLAYGO,DQ,DR,I,PSN,PHARM,Z,DIC,DIG
"RTN","PSOSUP",10,0)
 Q
"RTN","PSOSUP",11,0)
PHASK W !,"The pharmacist is an entry in the NEW PERSON file and holds the PSORPH",!,"key in the SECURITY KEY file.",!,"To delete a pharmacist, enter the name at the Select Pharmacist prompt and"
"RTN","PSOSUP",12,0)
 W !,"when the key PSORPH is shown as a default enter @ press return.",!,"The current list of PSORPH holders are:"
"RTN","PSOSUP",13,0)
 S A="",C=0,G=18
"RTN","PSOSUP",14,0)
 ;F J=0:0 S J=$O(^XUSEC("PSORPH",J)) Q:'J  W !?5,$P($G(^VA(200,J,0)),"^") S C=C+1 I C>G R !,"Enter '^' to stop",A:DTIME S:'$T A="^" S C=0
"RTN","PSOSUP",15,0)
 F J=0:0 S J=$O(^XUSEC("PSORPH",J)) Q:'J  W !?5,$P($G(^VA(200,J,0)),"^") D:$Y+4>IOSL
"RTN","PSOSUP",16,0)
 .R !,"Enter '^' to stop",A:DTIME S:'$T A="^" S C=0
"RTN","PSOSUP",17,0)
 K A,H,J,C,G Q
"RTN","PSOTALK3")
0^60^B21440926^B20856163
"RTN","PSOTALK3",1,0)
PSOTALK3 ;BIR/EJW - SCRIPTALK UTILITIES ;02 Oct 2003  7:31 AM
"RTN","PSOTALK3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**135,200,268**;DEC 1997;Build 9
"RTN","PSOTALK3",3,0)
 ;External reference to ^PS(59.7 controlled subscription by DBIA 694
"RTN","PSOTALK3",4,0)
TTRANS ;RE-INITIALIZE SCRIPTALK PRINTER
"RTN","PSOTALK3",5,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! Q
"RTN","PSOTALK3",6,0)
 S ZTIO="`"_$P($G(^PS(59,PSOSITE,"STALK")),U)
"RTN","PSOTALK3",7,0)
 I ZTIO="`" W !,"No ScripTalk printer defined for division." Q
"RTN","PSOTALK3",8,0)
 S ZTDTH=$$NOW^XLFDT,ZTDESC="Scriptalk Printer Re-initialize"
"RTN","PSOTALK3",9,0)
 S ZTRTN="TINIT^PSOTALK3",ZTSAVE("*")=""
"RTN","PSOTALK3",10,0)
 D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOTALK3",11,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOTALK3",12,0)
 Q
"RTN","PSOTALK3",13,0)
 ;
"RTN","PSOTALK3",14,0)
TINIT ;
"RTN","PSOTALK3",15,0)
 W !,"^XA ^MD30 ^XZ"
"RTN","PSOTALK3",16,0)
 W !,"^XA ^MD30 ^XZ"
"RTN","PSOTALK3",17,0)
 W !,"^XA ~SD30 ^XZ"
"RTN","PSOTALK3",18,0)
 W !,"^XA ^MFF,F ^XZ"
"RTN","PSOTALK3",19,0)
 W !,"^XA ^LT20 ^XZ"
"RTN","PSOTALK3",20,0)
 W !,"^XA ^MTT ^XZ"
"RTN","PSOTALK3",21,0)
 W !,"^XA ^JUS ^XZ"
"RTN","PSOTALK3",22,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTALK3",23,0)
 Q
"RTN","PSOTALK3",24,0)
 ;
"RTN","PSOTALK3",25,0)
TEST ;
"RTN","PSOTALK3",26,0)
 I $G(PSOTEST)?."?" R !,"Enter a Zebra Print Language test command to be sent",!,"to the ScripTalk printer: ",PSOTEST:DTIME
"RTN","PSOTALK3",27,0)
 I $G(PSOTEST)="" Q
"RTN","PSOTALK3",28,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! Q
"RTN","PSOTALK3",29,0)
 S ZTIO="`"_$P($G(^PS(59,PSOSITE,"STALK")),U),ZTDTH=$$NOW^XLFDT,ZTDESC="Scriptalk Interface Test"
"RTN","PSOTALK3",30,0)
 I ZTIO="`" W !,"No ScripTalk printer defined for division." Q
"RTN","PSOTALK3",31,0)
 S ZTRTN="TPUT^PSOTALK3",ZTSAVE("*")=""
"RTN","PSOTALK3",32,0)
 D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOTALK3",33,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOTALK3",34,0)
 K PSOTEST
"RTN","PSOTALK3",35,0)
 Q
"RTN","PSOTALK3",36,0)
TPUT ;SET VARIABLE 'PSOTEST' TO OUTPUT STRING
"RTN","PSOTALK3",37,0)
 W !,PSOTEST
"RTN","PSOTALK3",38,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTALK3",39,0)
 Q
"RTN","PSOTALK3",40,0)
 ;
"RTN","PSOTALK3",41,0)
TESTLAB ;
"RTN","PSOTALK3",42,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) W $C(7),!!,"Pharmacy Division Must be Selected!",! Q
"RTN","PSOTALK3",43,0)
 S ZTIO="`"_$P($G(^PS(59,PSOSITE,"STALK")),U),ZTDTH=$$NOW^XLFDT,ZTDESC="Scriptalk Sample Label"
"RTN","PSOTALK3",44,0)
 I ZTIO="`" W !,"No ScripTalk printer defined for division." Q
"RTN","PSOTALK3",45,0)
 S ZTRTN="TLABEL^PSOTALK3",ZTSAVE("*")=""
"RTN","PSOTALK3",46,0)
 W !,"The following test data will be sent to the ScripTalk printer:",! D TLABEL W !
"RTN","PSOTALK3",47,0)
 D ^%ZTLOAD K ZTDTH,ZTRTN,ZTIO,ZTDESC
"RTN","PSOTALK3",48,0)
 W:$D(ZTSK)&('$D(ZTQUEUED)) !!,"Task Queued !",!
"RTN","PSOTALK3",49,0)
 Q
"RTN","PSOTALK3",50,0)
TLABEL ;
"RTN","PSOTALK3",51,0)
 W !,"^XA"
"RTN","PSOTALK3",52,0)
 W !,"^FO250,700^XGE:RX.GRF^FS"
"RTN","PSOTALK3",53,0)
 W !,"^FO250,700^XGE:RX.GRF^FS"
"RTN","PSOTALK3",54,0)
 W !,"^AFR,20,10^FO531,50^FR^CI0^FD7305 N. MILITARY TRL  Exp: January 01,2002^FS"
"RTN","PSOTALK3",55,0)
 W !,"^AFR,20,10^FO503,50^FR^CI0^FDRX#82382787 January 01,2001  Fill 01 OF 01^FS"
"RTN","PSOTALK3",56,0)
 W !,"^AFR,20,10^FO475,50^FR^CI0^FDJOE VETERAN^FS"
"RTN","PSOTALK3",57,0)
 W !,"^AFR,20,10^FO447,50^FR^CI0^FDTAKE 1 CAPSULE THREE TIMES DAILY^FS"
"RTN","PSOTALK3",58,0)
 W !,"^AFR,20,10^FO419,50^FR^CI0^FD^FS"
"RTN","PSOTALK3",59,0)
 W !,"^AFR,20,10^FO391,50^FR^CI0^FD^FS"
"RTN","PSOTALK3",60,0)
 W !,"^AFR,20,10^FO363,50^FR^CI0^FD^FS"
"RTN","PSOTALK3",61,0)
 W !,"^AFR,20,10^FO335,50^FR^CI0^FDDr. BEN CASEY MD^FS"
"RTN","PSOTALK3",62,0)
 W !,"^AFR,20,10^FO279,50^FR^CI0^FDQTY: 24 TABS^FS"
"RTN","PSOTALK3",63,0)
 W !,"^AFR,20,10^FO251,50^FR^CI0^FDAMOXICILLIN 500MG CAP^FS"
"RTN","PSOTALK3",64,0)
 W !,"^RX01,JOE VETERAN^FS"
"RTN","PSOTALK3",65,0)
 W !,"^RX02,AMOXICILLIN 500MG CAP^FS"
"RTN","PSOTALK3",66,0)
 W !,"^RX03,TAKE 1 CAPSULE THREE TIMES DAILY ^FS"
"RTN","PSOTALK3",67,0)
 W !,"^RX04,010101^FS"
"RTN","PSOTALK3",68,0)
 W !,"^RX05,00^FS"
"RTN","PSOTALK3",69,0)
 W !,"^RX06,020000^FS"
"RTN","PSOTALK3",70,0)
 W !,"^RX07,BEN CASEY^FS"
"RTN","PSOTALK3",71,0)
 W !,"^RX08,2928993888^FS"
"RTN","PSOTALK3",72,0)
 W !,"^RX09,82382787^FS"
"RTN","PSOTALK3",73,0)
 W !,"^RX10, ^FS"
"RTN","PSOTALK3",74,0)
 W !,"^PQ1,0,1,Y"
"RTN","PSOTALK3",75,0)
 W !,"^XZ"
"RTN","PSOTALK3",76,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTALK3",77,0)
 Q
"RTN","PSOTALK3",78,0)
 ;
"RTN","PSOTALK3",79,0)
STDEV ;Define ScripTalk printer for a Division or map another print device to the ScripTalk Printer
"RTN","PSOTALK3",80,0)
 N PSOSITE,PSOTYPE
"RTN","PSOTALK3",81,0)
STDEV1 ;
"RTN","PSOTALK3",82,0)
 W !!!
"RTN","PSOTALK3",83,0)
 K DIC,DIR,DIE,DA,DR
"RTN","PSOTALK3",84,0)
 S DIR(0)="SBO^D:Division;P:Printer",DIR("A")="Define ScripTalk Printer by (D)ivision or (P)rinter mapping?"
"RTN","PSOTALK3",85,0)
 S DIR("?")=" "
"RTN","PSOTALK3",86,0)
 S DIR("?",1)="Enter D to define ScripTalk printer by Division or enter P to tie a ScripTalk"
"RTN","PSOTALK3",87,0)
 S DIR("?",2)="printer to regular Pharmacy label printer(s) to control where the ScripTalk"
"RTN","PSOTALK3",88,0)
 S DIR("?",3)="labels print for multi-divisions."
"RTN","PSOTALK3",89,0)
 S PSOSITE=""
"RTN","PSOTALK3",90,0)
 D ^DIR G:$D(DIRUT)!(Y<0) STDEVQ S PSOTYPE=Y
"RTN","PSOTALK3",91,0)
 D STDEVM:PSOTYPE="P"
"RTN","PSOTALK3",92,0)
 D STDEVD:PSOTYPE="D"
"RTN","PSOTALK3",93,0)
 G STDEV1
"RTN","PSOTALK3",94,0)
STDEVQ ;
"RTN","PSOTALK3",95,0)
 K DIC,DIR,DIE,DA,DR,DIRUT,Y
"RTN","PSOTALK3",96,0)
 Q
"RTN","PSOTALK3",97,0)
 ;
"RTN","PSOTALK3",98,0)
STDEVD ;Define ScripTalk device by division
"RTN","PSOTALK3",99,0)
 W ! S DIC("A")="Division: ",DIC=59,DIC(0)="AEMQ"
"RTN","PSOTALK3",100,0)
 S:$G(PSOVEX)'=1 DIC("S")="I $S('$D(^PS(59,+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0)"
"RTN","PSOTALK3",101,0)
 D ^DIC K DIC Q:$D(DIRUT)!(Y<0)
"RTN","PSOTALK3",102,0)
 Q:+Y<0
"RTN","PSOTALK3",103,0)
 S PSOSITE=+Y
"RTN","PSOTALK3",104,0)
 S DIE="^PS(59,",DA=PSOSITE,DR="107;107.1" D ^DIE
"RTN","PSOTALK3",105,0)
 Q
"RTN","PSOTALK3",106,0)
 ;
"RTN","PSOTALK3",107,0)
STDEVM ;Map a printer to a ScripTalk printer
"RTN","PSOTALK3",108,0)
 S DIE="^PS(59.7,",DA=1,DR="47" L +^PS(59.7,1,47):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) D  I $T D ^DIE L -^PS(59.7,1,47)
"RTN","PSOTALK3",109,0)
 . I '$T W !?5,"Another user is editing this entry."
"RTN","PSOTALK3",110,0)
 Q
"RTN","PSOTALK3",111,0)
 ;
"RTN","PSOTEXP1")
0^55^B64584695^B64487464
"RTN","PSOTEXP1",1,0)
PSOTEXP1 ;BIR/LE-Tally Missing Expiration Dates ;06/14/06
"RTN","PSOTEXP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**250,268**;DEC 1997;Build 9
"RTN","PSOTEXP1",3,0)
 ;External references ^DPT supported by DBIA 10035
"RTN","PSOTEXP1",4,0)
 N NAMSP,PATCH,JOBN,DTOUT,DUOUT,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC,QUIT,Y,ZTQUEUED,ZTREQ,ZTSAVE
"RTN","PSOTEXP1",5,0)
 S NAMSP=$$NAMSP
"RTN","PSOTEXP1",6,0)
 S JOBN="TALLY MISSING EXPIRATION DATES"
"RTN","PSOTEXP1",7,0)
 S PATCH="PSO*7*250"
"RTN","PSOTEXP1",8,0)
 ;
"RTN","PSOTEXP1",9,0)
 L +^XTMP(NAMSP):$S($G(DILOCKTM)>0:DILOCKTM,1:3) I '$T D  Q
"RTN","PSOTEXP1",10,0)
 . D BMES^XPDUTL(JOBN_" job is already running.  Halting...")
"RTN","PSOTEXP1",11,0)
 . D MES^XPDUTL("")
"RTN","PSOTEXP1",12,0)
 . D QUIT
"RTN","PSOTEXP1",13,0)
 ;
"RTN","PSOTEXP1",14,0)
 I '$D(^XTMP(NAMSP)) D INITXTMP(NAMSP,JOBN_", "_PATCH,90)        ;90 day life
"RTN","PSOTEXP1",15,0)
 S QUIT=0
"RTN","PSOTEXP1",16,0)
 ;
"RTN","PSOTEXP1",17,0)
 I $G(^XTMP(NAMSP,0,"LAST"))["COMPLETED" D  Q
"RTN","PSOTEXP1",18,0)
 . W !!,*7,"This job has been run before to completion on "
"RTN","PSOTEXP1",19,0)
 . W $$FMTE^XLFDT($P($G(^XTMP(NAMSP,0,"LAST")),"^",2)),!!
"RTN","PSOTEXP1",20,0)
 . W "If you want to run it again, the global subscript ^XTMP('PSOTEXP1') must be",!
"RTN","PSOTEXP1",21,0)
 . W "deleted prior to doing so.",!!
"RTN","PSOTEXP1",22,0)
 . D QUIT
"RTN","PSOTEXP1",23,0)
 ;
"RTN","PSOTEXP1",24,0)
 ;ques 2, if running from mumps prompt
"RTN","PSOTEXP1",25,0)
 I '$D(XPDQUES("POS2")) D  I 'ZTDTH D QUIT Q
"RTN","PSOTEXP1",26,0)
 . K DIR
"RTN","PSOTEXP1",27,0)
 . S DIR("A")="  Enter when to Queue the "_JOBN_" job to run in date@time   format "
"RTN","PSOTEXP1",28,0)
 . S DIR("B")="NOW"
"RTN","PSOTEXP1",29,0)
 . S DIR(0)="D^::%DT"
"RTN","PSOTEXP1",30,0)
 . S DIR("?")="Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 021506@3:30p"
"RTN","PSOTEXP1",31,0)
 . D ^DIR I $D(DUOUT) W !,"Halting..." S ZTDTH="" Q
"RTN","PSOTEXP1",32,0)
 . S:$D(DTOUT) Y=$$NOW^XLFDT S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSOTEXP1",33,0)
 ;
"RTN","PSOTEXP1",34,0)
 ;ques 2, if running from kids install
"RTN","PSOTEXP1",35,0)
 I $D(XPDQUES("POS2")) S ZTDTH=$$FMTH^XLFDT(XPDQUES("POS2"))
"RTN","PSOTEXP1",36,0)
 ;
"RTN","PSOTEXP1",37,0)
 D BMES^XPDUTL("=============================================================")
"RTN","PSOTEXP1",38,0)
 D MES^XPDUTL("Queuing background job for "_JOBN_"...")
"RTN","PSOTEXP1",39,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSOTEXP1",40,0)
 D MES^XPDUTL("==============================================================")
"RTN","PSOTEXP1",41,0)
 I ZTDTH="" D BMES^XPDUTL(JOBN_" NOT QUEUED") D QUIT Q
"RTN","PSOTEXP1",42,0)
 ;
"RTN","PSOTEXP1",43,0)
 S:$D(^XTMP(NAMSP,0,"LAST")) ^XTMP(NAMSP,0,"ZAUDIT",$H)="RE-STARTED ON"_"^"_$$NOW^XLFDT_"^"_$P(^XTMP(NAMSP,0,"LAST"),"^",2,5)
"RTN","PSOTEXP1",44,0)
 ;
"RTN","PSOTEXP1",45,0)
 I $P($G(^XTMP(NAMSP,0,"LAST")),"^")="STOP" D
"RTN","PSOTEXP1",46,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="RUN^"_$$NOW^XLFDT
"RTN","PSOTEXP1",47,0)
 E  D
"RTN","PSOTEXP1",48,0)
 . S ^XTMP(NAMSP,0,"LAST")="RUN^"_$$NOW^XLFDT_"^^^"
"RTN","PSOTEXP1",49,0)
 ;
"RTN","PSOTEXP1",50,0)
 S ZTRTN="EN^PSOTEXP1",ZTIO=""
"RTN","PSOTEXP1",51,0)
 S ZTDESC="Background job for "_JOBN_" on prescriptions updated via "_PATCH
"RTN","PSOTEXP1",52,0)
 S ZTSAVE("JOBN")=""
"RTN","PSOTEXP1",53,0)
 L -^XTMP(NAMSP)
"RTN","PSOTEXP1",54,0)
 D ^%ZTLOAD
"RTN","PSOTEXP1",55,0)
 D:$D(ZTSK)
"RTN","PSOTEXP1",56,0)
 . D MES^XPDUTL("*** Task #"_ZTSK_" Queued! ***")
"RTN","PSOTEXP1",57,0)
 . D BMES^XPDUTL("")
"RTN","PSOTEXP1",58,0)
 D BMES^XPDUTL("")
"RTN","PSOTEXP1",59,0)
 K XPDQUES
"RTN","PSOTEXP1",60,0)
 Q
"RTN","PSOTEXP1",61,0)
QUIT ;
"RTN","PSOTEXP1",62,0)
 L -^XTMP(NAMSP)
"RTN","PSOTEXP1",63,0)
 Q
"RTN","PSOTEXP1",64,0)
EN ;
"RTN","PSOTEXP1",65,0)
 N PATCH,NAMSP S NAMSP=$$NAMSP,PATCH="PSO*7*250",JOBN="TALLY MISSING EXPIRATION DATES"
"RTN","PSOTEXP1",66,0)
 ;if can't get Lock, then already running.
"RTN","PSOTEXP1",67,0)
 L +^XTMP(NAMSP):3 I '$T D  Q
"RTN","PSOTEXP1",68,0)
 . S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTEXP1",69,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="LOCKED^"_$$NOW^XLFDT
"RTN","PSOTEXP1",70,0)
 ;
"RTN","PSOTEXP1",71,0)
 N PSOSTART,Y,PSOS1,RXP,PSOV7,PSOARR,PSOISS,PSOEXP,PSOSTA,PSOACT,PSOINST,CC,RXE,DFN,PSODRUG,PSOINACT
"RTN","PSOTEXP1",72,0)
 ;
"RTN","PSOTEXP1",73,0)
 D NOW^%DTC S (Y,PSOS1)=% D DD^%DT S PSOSTART=Y
"RTN","PSOTEXP1",74,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOTEXP1",75,0)
 S RXP=+$P($G(^XTMP(NAMSP,0,"LAST")),"^",4)
"RTN","PSOTEXP1",76,0)
 ;get date that PSO v7 was installed
"RTN","PSOTEXP1",77,0)
 S PSOV7=$S($P($G(^PS(59.7,1,49.99)),"^",7):$P(^PS(59.7,1,49.99),"^",7),1:$P($G(^PS(59.7,1,49.99)),"^",4))
"RTN","PSOTEXP1",78,0)
 S:PSOV7["." PSOV7=$P(PSOV7,".",1)
"RTN","PSOTEXP1",79,0)
 ;
"RTN","PSOTEXP1",80,0)
 ;^XTMP(NAMSP,INSTITUTION)=tot missing expiration dates on or before v7 install^tot missing expiration dates after v7 install^total missing expiration dates^tot past expiration date minus 1 day
"RTN","PSOTEXP1",81,0)
 ;
"RTN","PSOTEXP1",82,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOTEXP1",83,0)
 S:'$G(PSOINST) PSOINST="9999999999"
"RTN","PSOTEXP1",84,0)
 S PSOACT=",0,1,2,3,4,5,10,16,",PSOINACT=",11,12,13,14,15,"
"RTN","PSOTEXP1",85,0)
 N STOP K ^XTMP(NAMSP,0,"STOP") S STOP=0 S:RXP="" RXP=0
"RTN","PSOTEXP1",86,0)
 F CC=1:1 S RXP=$O(^PSRX(RXP)) Q:'RXP!(RXP'?1N.NN)  D  Q:STOP
"RTN","PSOTEXP1",87,0)
 . I $D(^XTMP(NAMSP,0,"STOP")) D  Q
"RTN","PSOTEXP1",88,0)
 . . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="STOP^"_$$NOW^XLFDT,STOP=1
"RTN","PSOTEXP1",89,0)
 . K PSOARR D GETS^DIQ(52,RXP_",",".01;2;6;1;20;26;100","I","PSOARR")
"RTN","PSOTEXP1",90,0)
 . S DFN=$G(PSOARR(52,RXP_",",2,"I")),PSODRUG=$G(PSOARR(52,RXP_",",6,"I")),PSOSTA=$G(PSOARR(52,RXP_",",100,"I"))
"RTN","PSOTEXP1",91,0)
 . S PSOISS=$G(PSOARR(52,RXP_",",1,"I"))
"RTN","PSOTEXP1",92,0)
 . ;--- eliminate bad Rx's
"RTN","PSOTEXP1",93,0)
 . Q:DFN=""!(PSODRUG="")
"RTN","PSOTEXP1",94,0)
 . Q:'$D(^DPT(DFN))!('$D(^PSDRUG(PSODRUG)))
"RTN","PSOTEXP1",95,0)
 . Q:$G(PSOISS)=""
"RTN","PSOTEXP1",96,0)
 . ;--- 
"RTN","PSOTEXP1",97,0)
 . S RXE=$G(PSOARR(52,RXP_",",".01","I")),PSOEXP=$G(PSOARR(52,RXP_",",26,"I"))
"RTN","PSOTEXP1",98,0)
 . ;save last date & fill info
"RTN","PSOTEXP1",99,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",3,5)=$G(PSOISS)_"^"_RXP
"RTN","PSOTEXP1",100,0)
 . D SET
"RTN","PSOTEXP1",101,0)
 G STP:STOP
"RTN","PSOTEXP1",102,0)
 S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="COMPLETED^"_$$NOW^XLFDT
"RTN","PSOTEXP1",103,0)
 D MAIL
"RTN","PSOTEXP1",104,0)
STP ;
"RTN","PSOTEXP1",105,0)
 L -^XTMP(NAMSP)
"RTN","PSOTEXP1",106,0)
 I $D(^XTMP(NAMSP,0,"STOP")) S ^XTMP(NAMSP,0,"ZAUDIT",$H)="STOPPED ON"_"^"_$P(^XTMP(NAMSP,0,"LAST"),"^",2,5)
"RTN","PSOTEXP1",107,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTEXP1",108,0)
 K JOBN
"RTN","PSOTEXP1",109,0)
 ;I '$D(^XTMP(NAMSP,0,"STOP")) K ^XTMP(NAMSP)
"RTN","PSOTEXP1",110,0)
 Q
"RTN","PSOTEXP1",111,0)
 ;
"RTN","PSOTEXP1",112,0)
SET ;Data collected and stored:
"RTN","PSOTEXP1",113,0)
 ; Piece 1 - Pre-install v7 active Rx's with null expiration date
"RTN","PSOTEXP1",114,0)
 ; Piece 2 - Pre-install v7 inactive Rx's with null expiration date
"RTN","PSOTEXP1",115,0)
 ; Piece 3 - Post-install v7 active Rx's with null expiration
"RTN","PSOTEXP1",116,0)
 ; Piece 4 - Post-install v7 inactive Rx's with null expiration
"RTN","PSOTEXP1",117,0)
 ; Piece 5 - total Rx's with null expiration date
"RTN","PSOTEXP1",118,0)
 ; Piece 6 - total active Rx's with expire date of t-1 day
"RTN","PSOTEXP1",119,0)
 ;
"RTN","PSOTEXP1",120,0)
 I PSOEXP="" D  Q
"RTN","PSOTEXP1",121,0)
 . I PSOISS'>PSOV7 D
"RTN","PSOTEXP1",122,0)
 . . S:PSOACT[(","_PSOSTA_",") $P(^XTMP(NAMSP,PSOINST),"^",1)=$P($G(^XTMP(NAMSP,PSOINST)),"^",1)+1
"RTN","PSOTEXP1",123,0)
 . . S:PSOINACT[(","_PSOSTA_",") $P(^XTMP(NAMSP,PSOINST),"^",2)=$P($G(^XTMP(NAMSP,PSOINST)),"^",2)+1
"RTN","PSOTEXP1",124,0)
 . I PSOISS>PSOV7 D 
"RTN","PSOTEXP1",125,0)
 . . S:PSOACT[(","_PSOSTA_",") $P(^XTMP(NAMSP,PSOINST),"^",3)=$P($G(^XTMP(NAMSP,PSOINST)),"^",3)+1
"RTN","PSOTEXP1",126,0)
 . . S:PSOINACT[(","_PSOSTA_",") $P(^XTMP(NAMSP,PSOINST),"^",4)=$P($G(^XTMP(NAMSP,PSOINST)),"^",4)+1
"RTN","PSOTEXP1",127,0)
 . S $P(^XTMP(NAMSP,PSOINST),"^",5)=$P($G(^XTMP(NAMSP,PSOINST)),"^",5)+1
"RTN","PSOTEXP1",128,0)
 .;S ^XTMP("PSOTEXP1","MISS",RXP)=PSOINST_"^"_PSOISS_"^"_PSOV7_"^"_PSOEXP_"^"_$S($G(PSOSTA)'="":PSOSTA,1:"*")_"^"_$P($G(^PSRX(RXP,0)),"^")
"RTN","PSOTEXP1",129,0)
 ; normal daily job expires all rx's with yesterday's date, so looking for anything before yesterday.
"RTN","PSOTEXP1",130,0)
 I (PSOEXP<(DT-1))&(PSOACT[(","_PSOSTA_",")) S $P(^XTMP(NAMSP,PSOINST),"^",6)=$P($G(^XTMP(NAMSP,PSOINST)),"^",6)+1
"RTN","PSOTEXP1",131,0)
 ;.S ^XTMP("PSOTEXP1","PAST",$S($G(PSOSTA)'="":PSOSTA,1:"*"),PSOEXP,RXP)=PSOINST_"^"_PSOISS_"^"_PSOV7_"^"_PSOEXP_"^"_PSOSTA_"^"_$P($G(^PSRX(RXP,0)),"^")
"RTN","PSOTEXP1",132,0)
 Q
"RTN","PSOTEXP1",133,0)
 ;
"RTN","PSOTEXP1",134,0)
STATUS ;show status of job running
"RTN","PSOTEXP1",135,0)
 I $$ST D
"RTN","PSOTEXP1",136,0)
 . W !,"Currently processing:"
"RTN","PSOTEXP1",137,0)
 . I $G(^XTMP($$NAMSP,0,"LAST"))["COMPLETED" D
"RTN","PSOTEXP1",138,0)
 . . W !,"COMPLETED ON ",$$FMTE^XLFDT($P($G(^XTMP($$NAMSP,0,"LAST")),"^",2)),!
"RTN","PSOTEXP1",139,0)
 . W !?5,"Date being processed > ",$$FMTE^XLFDT($P(^XTMP($$NAMSP,0,"LAST"),"^",3))
"RTN","PSOTEXP1",140,0)
 . W !?5,"                RX # > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",4)
"RTN","PSOTEXP1",141,0)
 . ;W !?5,"          TOTAL RX's > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",5),!
"RTN","PSOTEXP1",142,0)
 E  D
"RTN","PSOTEXP1",143,0)
 .I $G(^XTMP($$NAMSP,0,"LAST"))["COMPLETED" D
"RTN","PSOTEXP1",144,0)
 .. W !,"COMPLETED ON ",$$FMTE^XLFDT($P($G(^XTMP($$NAMSP,0,"LAST")),"^",2)),!
"RTN","PSOTEXP1",145,0)
 Q
"RTN","PSOTEXP1",146,0)
 ;
"RTN","PSOTEXP1",147,0)
STOP ;stop job command
"RTN","PSOTEXP1",148,0)
 I $$ST S ^XTMP($$NAMSP,0,"STOP")="" D
"RTN","PSOTEXP1",149,0)
 . W !,"TALLY MISSING EXPIRATION DATES Job - set to STOP Soon"
"RTN","PSOTEXP1",150,0)
 . W !!,"Check Status to be sure it has stopped and is not running..."
"RTN","PSOTEXP1",151,0)
 . W !,"     (D STATUS^PSOTEXP1)"
"RTN","PSOTEXP1",152,0)
 Q
"RTN","PSOTEXP1",153,0)
ST() ;status
"RTN","PSOTEXP1",154,0)
 L +^XTMP($$NAMSP):3 I $T D  Q 0
"RTN","PSOTEXP1",155,0)
 . L -^XTMP($$NAMSP)
"RTN","PSOTEXP1",156,0)
 . W !,"*** NOT CURRENTLY RUNNING! ***",!
"RTN","PSOTEXP1",157,0)
 Q 1
"RTN","PSOTEXP1",158,0)
INITXTMP(NAMSP,TITLE,LIFE) ;create ^Xtmp according to SAC std
"RTN","PSOTEXP1",159,0)
 N BEGDT,PURGDT
"RTN","PSOTEXP1",160,0)
 S BEGDT=$$NOW^XLFDT()
"RTN","PSOTEXP1",161,0)
 S PURGDT=$$FMADD^XLFDT(BEGDT,LIFE)
"RTN","PSOTEXP1",162,0)
 S ^XTMP(NAMSP,0)=PURGDT_"^"_BEGDT_"^"_TITLE
"RTN","PSOTEXP1",163,0)
 Q
"RTN","PSOTEXP1",164,0)
NAMSP() ;
"RTN","PSOTEXP1",165,0)
 Q $T(+0)
"RTN","PSOTEXP1",166,0)
 ;
"RTN","PSOTEXP1",167,0)
MAIL ;
"RTN","PSOTEXP1",168,0)
 N PSOEND,PSOEND2,PSOTEXT,XMY,LIN,DATA,J,L,PSOINST,M,LEN
"RTN","PSOTEXP1",169,0)
 S LIN="",$P(LIN," ",80)="",LEN=80
"RTN","PSOTEXP1",170,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOTEXP1",171,0)
 S PSOEND2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOTEXP1",172,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","PSOTEXP1",173,0)
 S XMDUZ=PATCH_" "_JOBN
"RTN","PSOTEXP1",174,0)
 S XMSUB="Outpatient Pharmacy "_PATCH_" "_JOBN
"RTN","PSOTEXP1",175,0)
 S XMY("ELLZEY.LINDA@FORUM.VA.GOV")=""
"RTN","PSOTEXP1",176,0)
 S XMY("WHITE.ELAINE@FORUM.VA.GOV")=""
"RTN","PSOTEXP1",177,0)
 S XMY("WILLIAMSON.ERIC@FORUM.VA.GOV")=""
"RTN","PSOTEXP1",178,0)
 I $O(XMY(""))="" Q  ; no recipients for mail message
"RTN","PSOTEXP1",179,0)
 S PSOTEXT(1)="The "_JOBN_" job for the Outpatient Pharmacy"
"RTN","PSOTEXP1",180,0)
 S PSOTEXT(2)="patch ("_PATCH_") started "_PSOSTART
"RTN","PSOTEXP1",181,0)
 S PSOTEXT(3)="and completed "_PSOEND_"."
"RTN","PSOTEXP1",182,0)
 S PSOTEXT(4)=" "
"RTN","PSOTEXP1",183,0)
 S PSOTEXT(5)="Excel comma delimited data below, five headings, one data line"
"RTN","PSOTEXP1",184,0)
 S PSOTEXT(6)="Note that an institution of 999999999 denotes one was not found during run."
"RTN","PSOTEXP1",185,0)
 S PSOTEXT(7)=",,,,,,Total Active Rx's"
"RTN","PSOTEXP1",186,0)
 S PSOTEXT(8)=",Before v7 Install,Before v7 Install,After v7 Install,After v7 Install,,With"
"RTN","PSOTEXP1",187,0)
 S PSOTEXT(9)=",Tot Active Rx's,Tot Inactive,Tot Active,Tot Inactive,Total Rx's,Expiration"
"RTN","PSOTEXP1",188,0)
 S PSOTEXT(10)=",Missing Expired,Rx's Missing,Rx's Missing,Rx's Missing,Missing,Date of T-1"
"RTN","PSOTEXP1",189,0)
 S PSOTEXT(11)="Institution,Date,Expired Date,Expired Date,Expired Date,Expired Date,Day"
"RTN","PSOTEXP1",190,0)
 S PSOINST=0,L=12
"RTN","PSOTEXP1",191,0)
 F  S PSOINST=$O(^XTMP(NAMSP,PSOINST)) Q:PSOINST=""!(PSOINST'?1N.NN)  D
"RTN","PSOTEXP1",192,0)
 . S DATA=^XTMP(NAMSP,PSOINST),DATA=$TR(DATA,"^",",")
"RTN","PSOTEXP1",193,0)
 . S PSOTEXT(L)=$E((PSOINST_","_DATA_LIN),1,LEN),L=L+1
"RTN","PSOTEXP1",194,0)
 S L=L+1,PSOTEXT(L)=" "
"RTN","PSOTEXP1",195,0)
 ;
"RTN","PSOTEXP1",196,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOTEXP1",197,0)
 Q
"RTN","PSOTPCEE")
0^56^B8343556^B7950417
"RTN","PSOTPCEE",1,0)
PSOTPCEE ;BIR/MHA-transitional pharmacy benefit enter/edit ;07/01/03
"RTN","PSOTPCEE",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**145,153,227,268**;DEC 1997;Build 9
"RTN","PSOTPCEE",3,0)
 ;;External reference to SDPHARM1 supported by DBIA 4196
"RTN","PSOTPCEE",4,0)
 ;;External reference ^DIC(4 supported by DBIA 2251
"RTN","PSOTPCEE",5,0)
 Q  ;placed out of order by PSO87*227
"RTN","PSOTPCEE",6,0)
ST N PSODFN,FLG,PSODF,FI,INST,SNO,CDT,UL S FI=52.91,$P(UL,"=",79)="="
"RTN","PSOTPCEE",7,0)
PT K DIC,DIE,PSODFN,FLG,PSODF,REC,INST,SNO,CDT
"RTN","PSOTPCEE",8,0)
 W ! S (DIC,DIE)=52.91,DIC(0)="QEALM",DLAYGO=FI
"RTN","PSOTPCEE",9,0)
 ;S DIC("W")="W ?15,$$GET1^DIQ(2,+Y,.01)"
"RTN","PSOTPCEE",10,0)
 D ^DIC G:+Y'>0 PTX S FLG=$P(Y,"^",3)
"RTN","PSOTPCEE",11,0)
 S (PSODFN,DA)=+Y,DR=.351,DIC=2,DIQ="PSODF" D EN^DIQ1 K DIC,DR,DIQ
"RTN","PSOTPCEE",12,0)
 I $G(PSODF(2,DA,.351))]"",FLG D  G PT
"RTN","PSOTPCEE",13,0)
 .W !!?10,$C(7),"Patient died on "_PSODF(2,PSODFN,.351)_" - Cannot be added to file!!",!
"RTN","PSOTPCEE",14,0)
 .S DIK="^PS(52.91," D ^DIK K DIK
"RTN","PSOTPCEE",15,0)
 L +^PS(FI,DA):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W $C(7),!!,"Patient Data is Being Edited by Another User!",! G PT
"RTN","PSOTPCEE",16,0)
 S (INST,SNO)="" D:FLG
"RTN","PSOTPCEE",17,0)
 .S X=$$DEF^SDPHARM1(DA) S:X INST=$P(X,"^"),SNO=$P(X,"^",2)
"RTN","PSOTPCEE",18,0)
 .S DR="1////"_DT_";5////M;6////"_SNO_";7////"_INST D ^DIE
"RTN","PSOTPCEE",19,0)
INS S REC=$G(^PS(FI,DA,0))
"RTN","PSOTPCEE",20,0)
 S DR="7" D ^DIE I $D(Y)!($D(DTOUT)) D:FLG RM L -^PS(FI,DA) G PT
"RTN","PSOTPCEE",21,0)
 I X,X'=$P(REC,"^",8) S $P(REC,"^",7)=$P($G(^DIC(4,X,99)),"^"),DR="6////"_$P($G(^DIC(4,X,99)),"^") D ^DIE
"RTN","PSOTPCEE",22,0)
 S DR="6" D ^DIE I $D(Y)!($D(DTOUT)) D:FLG RM L -^PS(52.91,DA) G PT
"RTN","PSOTPCEE",23,0)
 I X,X'=$P(REC,"^",7),$$IEN^XUAF4(X) S DR="7////"_$$IEN^XUAF4(X) D ^DIE G INS
"RTN","PSOTPCEE",24,0)
 S CDT=$P(REC,"^",3)
"RTN","PSOTPCEE",25,0)
 S DR="2" D ^DIE I $D(Y)!($D(DTOUT)) L -^PS(FI,DA) G PT
"RTN","PSOTPCEE",26,0)
 I CDT,X="" S DR="3////@" D ^DIE W !,"INACTIVATION REASON CODE: " G CONT
"RTN","PSOTPCEE",27,0)
 I X S DR="3R",DIE("NO^")="" D ^DIE I $D(DTOUT) S DR="3////3" D ^DIE L -^PS(FI,DA) G PT
"RTN","PSOTPCEE",28,0)
CONT L -^PS(FI,DA)
"RTN","PSOTPCEE",29,0)
 S Y=$S(FLG:DT,1:$P(REC,"^",2)) X ^DD("DD")
"RTN","PSOTPCEE",30,0)
 W !!,UL,!,"DATE PHARMACY BENEFIT BEGAN: "_Y
"RTN","PSOTPCEE",31,0)
 S Y=$P(REC,"^",6),Y=$S(Y="E":"EWL",Y="S":"SCHEDULED APPOINTMENT",Y="X":"EWL & SCHEDULED APPOINTMENT",Y="M":"MANUAL",1:"")
"RTN","PSOTPCEE",32,0)
 W ?42,"WAIT TYPE: "_Y
"RTN","PSOTPCEE",33,0)
 S Y=$P(REC,"^",5) I Y X ^DD("DD")
"RTN","PSOTPCEE",34,0)
 W !,"DESIRED APPOINTMENT DATE: "_Y
"RTN","PSOTPCEE",35,0)
 W !,"EXCLUSION REASON: " S Y=$P(REC,"^",9)
"RTN","PSOTPCEE",36,0)
 W:Y=1 "ACTIVE RX"
"RTN","PSOTPCEE",37,0)
 W:Y=2 "ACTUAL APPT. < 30 DAYS FROM DATE APPT. MADE"
"RTN","PSOTPCEE",38,0)
 W:Y=3 "ACTIVE RX & ACTUAL APPT. < 30 DAYS FROM DATE APPT. MADE"
"RTN","PSOTPCEE",39,0)
 S Y=$P(REC,"^",10) I Y X ^DD("DD")
"RTN","PSOTPCEE",40,0)
 W !,"PRIMARY CARE SCHEDULE APT DATE: "_Y_"   "_"RX #: "_$P(REC,"^",11)
"RTN","PSOTPCEE",41,0)
 S Y=$P(REC,"^",12) I Y X ^DD("DD")
"RTN","PSOTPCEE",42,0)
 W !,"DATE LETTER PRINTED: "_Y,!,UL
"RTN","PSOTPCEE",43,0)
 G PT
"RTN","PSOTPCEE",44,0)
PTX K DIC,DIE,%DT,DR,DA Q
"RTN","PSOTPCEE",45,0)
RM ;
"RTN","PSOTPCEE",46,0)
 ;W !?10,$C(7),"Required Data - Setting patient as Inactive"
"RTN","PSOTPCEE",47,0)
 ;S DR="2////"_DT_";3////3" D ^DIE
"RTN","PSOTPCEE",48,0)
 W !!,$C(7),"Required Data - deleting patient entry from TPB ELIGIBILITY (#52.91) File."
"RTN","PSOTPCEE",49,0)
 K DIK S DIK="^PS(52.91,",DA=PSODFN D ^DIK K DIK,^PS(52.91,"AX",DT,DA)
"RTN","PSOTPCEE",50,0)
 Q
"RTN","PSOTPRX1")
0^58^B52223271^B51610518
"RTN","PSOTPRX1",1,0)
PSOTPRX1 ;BIR/MHA-TPB medication procesing driver ;08/21/03
"RTN","PSOTPRX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**146,182,227,268**;DEC 1997;Build 9
"RTN","PSOTPRX1",3,0)
 ;External reference PDA^PPPPDA1 supported by DBIA 1374
"RTN","PSOTPRX1",4,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOTPRX1",5,0)
 ;External reference ^DIC(31 supported by DBIA 658
"RTN","PSOTPRX1",6,0)
 ;External reference EN2^GMRAPEM0 supported by DBIA 190
"RTN","PSOTPRX1",7,0)
 Q  ;placed out of order by patch PSO*7*227
"RTN","PSOTPRX1",8,0)
START K PSOQFLG,PSOID,PSOFIN,PSOQUIT,PSODRUG S (PSOBCK,PSOERR)=1 D INIT
"RTN","PSOTPRX1",9,0)
 W:'$D(PSOTPBFG) !!,"*** Transitional Pharmacy Benefit Flag Undefined - Quitting ***"
"RTN","PSOTPRX1",10,0)
 G:PSORX("QFLG")!('$D(PSOTPBFG)) END
"RTN","PSOTPRX1",11,0)
 D PT G:$G(PSORX("QFLG")) END D FULL^VALM1 I $G(NOPROC) K NOPROC G NX
"RTN","PSOTPRX1",12,0)
 ;call to add bingo board data to file 52.11
"RTN","PSOTPRX1",13,0)
 F SLPPL=0:0 S SLPPL=$O(RXRS(SLPPL)) Q:'SLPPL  D
"RTN","PSOTPRX1",14,0)
 .I $P($G(^PSRX(SLPPL,"STA")),"^")'=5 K RXRS(SLPPL) Q
"RTN","PSOTPRX1",15,0)
 .S RXREC=SLPPL D WIND^PSOSUPOE I $G(PBINGRTE) D BBADD^PSOSUPOE S (BINGCRT,BINGRTE)=1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL"
"RTN","PSOTPRX1",16,0)
 K TM,TM1 I $G(PSORX("PSOL",1))]""!($D(RXRS)) D ^PSORXL K PSORX S PSOPBM1=1
"RTN","PSOTPRX1",17,0)
 G:$G(NOBG) NX
"RTN","PSOTPRX1",18,0)
 S TM=$P(^TMP("PSOBB",$J),"^"),TM1=$P(^TMP("PSOBB",$J),"^",2) K ^TMP("PSOBB",$J)
"RTN","PSOTPRX1",19,0)
 I $G(PSOFROM)="NEW"!($G(PSOFROM)="REFILL")!($G(PSOFROM)="PARTIAL") D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BINGCRT,BINGRTE,BBRX,BBFLG
"RTN","PSOTPRX1",20,0)
 I $G(PSOPBM),$G(PSOPBM1) S $P(^PS(55,PSODFN,0),"^",7)=PSOPBM,$P(^(0),"^",8)="A" K PSOPBM,PSOPBM1
"RTN","PSOTPRX1",21,0)
NX D:$G(PSODFN) EXFLAG^PSOTPCAN(PSODFN) D EOJ G START
"RTN","PSOTPRX1",22,0)
END Q
"RTN","PSOTPRX1",23,0)
 ;---------------------------------------------------------
"RTN","PSOTPRX1",24,0)
INIT ;
"RTN","PSOTPRX1",25,0)
 S PSORX("QFLG")=0
"RTN","PSOTPRX1",26,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) S PSORX("QFLG")=1
"RTN","PSOTPRX1",27,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSOTPRX1",28,0)
INITX Q
"RTN","PSOTPRX1",29,0)
 ;
"RTN","PSOTPRX1",30,0)
PT ;
"RTN","PSOTPRX1",31,0)
 K ^TMP("PSORXDC",$J),CLOZPAT,DIC,PSODFN,PSOPBM,PSOPBM1 S PSORX("QFLG")=0
"RTN","PSOTPRX1",32,0)
 S DIC("S")="I '$P(^PS(52.91,+Y,0),""^"",3)!($P(^(0),""^"",3)>DT)"
"RTN","PSOTPRX1",33,0)
 S DIC=52.91,DIC(0)="QEAM" D ^DIC K DIC,DA
"RTN","PSOTPRX1",34,0)
 I +Y'>0 S PSORX("QFLG")=1 G PTX
"RTN","PSOTPRX1",35,0)
OERR N:$G(MEDP) PAT,POERR K PSOXFLG S (DFN,PSODFN)=+Y,PSORX("NAME")=$P($G(^DPT(PSODFN,0)),"^")
"RTN","PSOTPRX1",36,0)
 K NPPROC,PSOQFLG,DIC,DR,DIQ S DIC=2,DA=PSODFN,DR=.351,DIQ="PSOPTPST" D EN^DIQ1 K DIC,DA,DR,DIQ D DEAD^PSOPTPST I $G(PSOQFLG) S NOPROC=1 Q
"RTN","PSOTPRX1",37,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") W !,"Patient has another language preference!",! H 3
"RTN","PSOTPRX1",38,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSOTPRX1",39,0)
 I '$G(MEDP) S X="PPPPDA1" X ^%ZOSF("TEST") S:$T X=$$PDA^PPPPDA1(PSODFN)
"RTN","PSOTPRX1",40,0)
 S PSOQFLG=0,DIC="^PS(55,",DLAYGO=55
"RTN","PSOTPRX1",41,0)
 I $G(PSOFIN) S SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")" K SSN
"RTN","PSOTPRX1",42,0)
 K PSOPBM ; KILL SO THAT WON'T CARRY OVER PRIOR PATIENT'S VALUE
"RTN","PSOTPRX1",43,0)
 I '$D(^PS(55,PSODFN,0)) D
"RTN","PSOTPRX1",44,0)
 .S PSOPBM=$P(TM,".")
"RTN","PSOTPRX1",45,0)
 .K DD,DO S DIC(0)="L",(DINUM,X)=PSODFN D FILE^DICN D:Y<1  K DIC,DA,DR,DD,DO
"RTN","PSOTPRX1",46,0)
 ..S $P(^PS(55,PSODFN,0),"^")=PSODFN K DIK S DA=PSODFN,DIK="^PS(55,",DIK(1)=.01 D EN^DIK K DIK
"RTN","PSOTPRX1",47,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSOTPRX1",48,0)
 I $G(^PS(55,PSODFN,"PS"))']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSOTPRX1",49,0)
 .L +^PS(55,PSODFN):$S(+$G(^DD("DILOCKTM"))>0:+^DD("DILOCKTM"),1:3) I '$T W $C(7),!!,"Patient Data is Being Edited by Another User!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1 Q
"RTN","PSOTPRX1",50,0)
 .S PSOXFLG=1,SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")",! K SSN
"RTN","PSOTPRX1",51,0)
 .S DIE=55,DR=".02;.03;.04;.05;1;D ELIG^PSORX1;@1;3//NON-VA;D CHK^PSOTPRX1;50;106;106.1"
"RTN","PSOTPRX1",52,0)
 .S DA=PSODFN W !!,?5,">>PHARMACY PATIENT DATA<<",! D ^DIE L -^PS(55,PSODFN)
"RTN","PSOTPRX1",53,0)
 .I $D(Y)!($D(DTOUT)) S PSOX=$G(^PS(55,PSODFN,"PS")) D:+$P(PSOX,"^")
"RTN","PSOTPRX1",54,0)
 ..I $$UP^XLFSTR($P(^PS(53,$P(PSOX,"^"),0),"^"))'="NON-VA" S DR="3////@" D ^DIE
"RTN","PSOTPRX1",55,0)
 S PSOX=$G(^PS(55,PSODFN,"PS"))
"RTN","PSOTPRX1",56,0)
 I PSOX]"" S (X,PSORX("PATIENT STATUS"))=$$UP^XLFSTR($P(^PS(53,$P(PSOX,"^"),0),"^")) D:X'="NON-VA" WRN
"RTN","PSOTPRX1",57,0)
 I PSOX']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSOTPRX1",58,0)
 .W !!,"Patient Status Required!!",! D ELIG
"RTN","PSOTPRX1",59,0)
 .W ! K POERR("QFLG"),DIC,DR,DIE S DIC("B")="NON-VA"
"RTN","PSOTPRX1",60,0)
 .S DIC("A")="PATIENT STATUS: ",DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSOTPRX1",61,0)
 .I $D(DIRUT)!(Y=-1) D  Q
"RTN","PSOTPRX1",62,0)
 ..W $C(7),"Required Data!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1
"RTN","PSOTPRX1",63,0)
 ..I $G(PSOPBM) D  K PSOPBM
"RTN","PSOTPRX1",64,0)
 ...I $O(^PS(55,PSODFN,0))="" S DA=PSODFN,DIK="^PS(55," D ^DIK
"RTN","PSOTPRX1",65,0)
 .I $$UP^XLFSTR($P(^PS(53,+Y,0),"^"))'="NON-VA" D MES S POERR("QFLG")=1 Q
"RTN","PSOTPRX1",66,0)
 .S ^PS(55,PSODFN,"PS")=+Y,PSORX("PATIENT STATUS")=$P(^PS(53,+Y,0),"^")
"RTN","PSOTPRX1",67,0)
 .D KV
"RTN","PSOTPRX1",68,0)
 Q:$G(PSOFIN)
"RTN","PSOTPRX1",69,0)
PROV ;
"RTN","PSOTPRX1",70,0)
 D ST^PSOTPPRV G:'$G(DA) NX
"RTN","PSOTPRX1",71,0)
 S PSORX("PROVIDER NAME")=$P(^VA(200,DA,0),"^")
"RTN","PSOTPRX1",72,0)
 D KV S DIR("A")="Do you want to enter allergies or adverse reactions at this time?"
"RTN","PSOTPRX1",73,0)
 S DIR("B")="Y",DIR(0)="YN" W !! D ^DIR I Y W !
"RTN","PSOTPRX1",74,0)
 D:Y EN2^GMRAPEM0
"RTN","PSOTPRX1",75,0)
 I '$G(PSOPBM),'$P(^PS(55,PSODFN,0),"^",7),$P(^(0),"^",8)']"" S PSOPBM=$P(TM,".")
"RTN","PSOTPRX1",76,0)
 D ^PSOBUILD
"RTN","PSOTPRX1",77,0)
 F PT="GET","DEAD","INP","CNH","ADDRESS","COPAY" S RTN=PT_"^PSOPTPST" D @RTN Q:$G(POERR("DEAD"))!($G(PSOQFLG))
"RTN","PSOTPRX1",78,0)
 I $G(POERR("DEAD")) S POERR("QFLG")=1 F II=0:0 S II=$O(^PS(52.41,"P",PSODFN,II)) D:$P($G(^PS(52.41,II,0)),"^",3)'="DC"&($P($G(^(0)),"^",3)'="DE") DC^PSOORFI2
"RTN","PSOTPRX1",79,0)
 K PSOERR("DEAD"),II I $G(PSOQFLG) S POERR("QFLG")=1 G EOJ Q
"RTN","PSOTPRX1",80,0)
 S (PAT,PSOXXDFN)=PSODFN,POERR=1 D ^PSOORUT2,BLD^PSOORUT1,EN^PSOLMUTL
"RTN","PSOTPRX1",81,0)
 D CLEAR^VALM1 G:$G(PSOQUIT) PTX D EN^PSOLMAO
"RTN","PSOTPRX1",82,0)
 S (DFN,PSODFN)=PSOXXDFN K DIE,DIC,DLAYGO,DR,DA,PSOX,PSORXED
"RTN","PSOTPRX1",83,0)
PTX ;
"RTN","PSOTPRX1",84,0)
 K X,Y,^TMP("PS",$J),C,DEA,PRC,PSCNT,PSOACT,PSOCLC,PSOCS,PSOCT,PSOFINFL,PSOHD,PSOLST,PSOOPT,PSOPF,PSOX,PSOX1,PSOXXDFN,SIGOK,STP,STR
"RTN","PSOTPRX1",85,0)
 Q
"RTN","PSOTPRX1",86,0)
CHK ;
"RTN","PSOTPRX1",87,0)
 Q:'X
"RTN","PSOTPRX1",88,0)
 I $$UP^XLFSTR($P(^PS(53,+X,0),"^"))'="NON-VA" D MES S Y="@1",$P(^PS(55,PSODFN,"PS"),"^")=""
"RTN","PSOTPRX1",89,0)
 Q
"RTN","PSOTPRX1",90,0)
MES W $C(7),!!,"Invalid Selection - Only 'NON-VA' patient status can be processed through"
"RTN","PSOTPRX1",91,0)
 W !,"this option. For all other statuses use the regular Patient Prescription"
"RTN","PSOTPRX1",92,0)
 W !,"Processing option"
"RTN","PSOTPRX1",93,0)
 Q
"RTN","PSOTPRX1",94,0)
WRN W $C(7),!!?15,"*** Current RX Patient Status is "_X_" ***"
"RTN","PSOTPRX1",95,0)
 W !,"Only 'NON-VA' patient status should be processed through this option."
"RTN","PSOTPRX1",96,0)
 W !,"For all other statuses use the regular Patient Prescription Processing option."
"RTN","PSOTPRX1",97,0)
 Q
"RTN","PSOTPRX1",98,0)
EOJ ;
"RTN","PSOTPRX1",99,0)
 K PSOERR,PSOMED,PSORX,PSOSD,PSODRUG,PSODFN,PSOOPT,PSOBILL,PSOIBQS,PSOCPAY,PSOPF,PSOPI,COMM,DGI,DGS,PT,PTDY,PTRF,RN,RTN,SERS,ST0,STAT,DFN,STOP,SLPPL,RXREC,PSOPBM
"RTN","PSOTPRX1",100,0)
 K:'$G(MEDP) PSOQFLG
"RTN","PSOTPRX1",101,0)
 D KVA^VADPT,FULL^VALM1 K PSOLST,PSOXFLG,PSCNT,PSDIS,PSOAL,P1,LOG,%,%DT,%I,D0,DAT,DFN,DRG,ORX,PSON,PSOPTPST,PTST,PSOBCK,PSOID,PSOBXPUL
"RTN","PSOTPRX1",102,0)
 K INCOM,SIG,SG,STP,RX0,RXN,RX2,RX3,RTS,C,DEAD,PS,PSOCLC,PSOCNT,PSOCT,PSODA,PSOFROM,PSOHD,R3,REA,RF,RFD,RFM,RLD,RXNUM,RXP,RXPR,RXRP,RXRS,STR,POERR,VALMSG
"RTN","PSOTPRX1",103,0)
 K ^TMP("PSORXDC",$J),^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J) I '$G(MEDP),'$G(PSOQUIT) K PAT
"RTN","PSOTPRX1",104,0)
 K RFN,PSOXXDFN,VALM,VALMKEY,PSOBCK,SPOERR,PSOFLAG,VALMBCK,D,GMRA,GMRAL,GMRAREC,PSOSTA,PSODT,RXFL,NOBG,BBRX,BBFLG
"RTN","PSOTPRX1",105,0)
KV K DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSOTPRX1",106,0)
 Q
"RTN","PSOTPRX1",107,0)
ELIG ; shows eligibility and disabilities
"RTN","PSOTPRX1",108,0)
 D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"") S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSOTPRX1",109,0)
 W !,"Disabilities: " F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSOTPRX1",110,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSOTPRX1",111,0)
 .W:$L(PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 !,?15
"RTN","PSOTPRX1",112,0)
 .W $S($G(PSDIS)]"":PSDIS_"-",1:"")_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSOTPRX1",113,0)
 K N
"RTN","PSOTPRX1",114,0)
 Q
"RTN","PSOTPRX1",115,0)
PROFILE ;
"RTN","PSOTPRX1",116,0)
 S (PSORX("REFILL"),PSORX("RENEW"))=0,PSOX="" D ^PSOBUILD
"RTN","PSOTPRX1",117,0)
 I '$G(PSOSD) W !,"This patient has no prescriptions" S:'$D(DFN) DFN=PSODFN D GMRA^PSODEM G PROFILEX
"RTN","PSOTPRX1",118,0)
 S (PSODRG,PSOX)="" F  S PSODRG=$O(PSOSD(PSODRG)) Q:PSODRG=""  F  S PSOX=$O(PSOSD(PSODRG,PSOX)) Q:PSOX=""  S:$P(PSOSD(PSODRG,PSOX),"^",3)="" PSORX("RENEW")=1 S:$P(PSOSD(PSODRG,PSOX),"^",4)="" PSORX("REFILL")=1
"RTN","PSOTPRX1",119,0)
 K PSOX
"RTN","PSOTPRX1",120,0)
PROFILEX ;
"RTN","PSOTPRX1",121,0)
 Q
"RTN","PSOVER1")
0^75^B59047654^B53965789
"RTN","PSOVER1",1,0)
PSOVER1 ;BHAM ISC/SAB - verify one rx ;3/9/05 12:53pm
"RTN","PSOVER1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,46,90,131,202,207,148,243,268**;DEC 1997;Build 9
"RTN","PSOVER1",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOVER1",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOVER1",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOVER1",6,0)
 ;External reference to PSSORPH is supported by DBIA 3234
"RTN","PSOVER1",7,0)
 ;External references to ^ORRDI1 supported by DBIA 4659
"RTN","PSOVER1",8,0)
 ;External reference ^XTMP("ORRDI" supported by DBIA 4660
"RTN","PSOVER1",9,0)
REDO ;
"RTN","PSOVER1",10,0)
 S (DRG,PSODRUG("NAME"))=$P(^PSDRUG(+$P(^PSRX(PSONV,0),"^",6),0),"^"),PSODRUG("VA CLASS")=$P(^(0),"^",2)
"RTN","PSOVER1",11,0)
 I '$D(PSODFN) S PSODFN=$P(^PSRX(PSONV,0),"^",2)
"RTN","PSOVER1",12,0)
 S (STA,DNM)="",PSDPSTOP=0,$P(PSONULN,"-",79)="-" F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S DNM=$O(PSOSD(STA,DNM)) Q:DNM=""  K PSZZZDUP I $P(PSOSD(STA,DNM),"^",2)<10 D
"RTN","PSOVER1",13,0)
 .I STA="ZNONVA" D NVA Q
"RTN","PSOVER1",14,0)
 .I PSODRUG("NAME")=$P(DNM,"^")&(PSONV'=$P(PSOSD(STA,DNM),"^")) S PSZZZDUP=1 K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" W ! D ^DIR K DIR S PSDTSTOP=1
"RTN","PSOVER1",15,0)
 .I PSODRUG("VA CLASS")]"",$E(PSODRUG("VA CLASS"),1,4)=$E($P(PSOSD(STA,DNM),"^",5),1,4),PSODRUG("NAME")'=$P(DNM,"^") K DIR S DIR(0)="E",DIR("A")="Press RETURN to continue" W ! D ^DIR K DIR D CLS^PSODRDUP S PSDTSTOP=1
"RTN","PSOVER1",16,0)
 .I $G(PSZZZDUP),$G(PSVFLAG),$P($G(^PSRX($P(PSOSD(STA,DNM),"^"),"STA")),"^")=12,$D(^PS(52.4,$P(PSOSD(STA,DNM),"^"),0)) S DA=$P(PSOSD(STA,DNM),"^"),DIK="^PS(52.4," D ^DIK K DIK
"RTN","PSOVER1",17,0)
 .I $G(PSZZZDUP),$G(PSVFLAG),$P($G(^PSRX($P(PSOSD(STA,DNM),"^"),"STA")),"^")'=12 S PSZZQUIT=1
"RTN","PSOVER1",18,0)
 K MSG I $G(PSZZQUIT),$G(PSVFLAG) K PSZZQUIT,PSODRUG,PSODFN,PSZZZDUP,DNM,PSDTSTOP D CLEAN Q
"RTN","PSOVER1",19,0)
 D REMOTE
"RTN","PSOVER1",20,0)
 K PSODRUG,PSODFN,PSZZZDUP,DNM,PSZZQUIT
"RTN","PSOVER1",21,0)
ALLR ;Allergy check
"RTN","PSOVER1",22,0)
 S PSONOAL="" D ALLERGY^PSOORUT2 D:PSONOAL'="" NOALRGY K PSONOAL I $G(PSZZQUIT) K MSG,PSZZQUIT,PSODRUG,PSODFN,PSZZZDUP,DNM,PSDTSTOP D CLEAN Q
"RTN","PSOVER1",23,0)
 G:'$P($G(^PSRX(PSONV,3)),"^",6) EDIT
"RTN","PSOVER1",24,0)
 I '$G(PSDTSTOP) K DIR S DIR(0)="E" D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) K PSDTSTOP G OUT
"RTN","PSOVER1",25,0)
 W !!,"A Drug-Allergy Reaction exists for this medication!",!!,"***SIGNIFICANT*** Allergy Reaction"
"RTN","PSOVER1",26,0)
 W !,"Drug: ",$P($G(^PSDRUG(+$P($G(^PSRX(PSONV,0)),"^",6),0)),"^")
"RTN","PSOVER1",27,0)
 I $O(^PSRX(PSONV,"DAI",0)) W !?6,"Ingredients: " D
"RTN","PSOVER1",28,0)
 .F PSPPP=0:0 S PSPPP=$O(^PSRX(PSONV,"DAI",PSPPP)) Q:'PSPPP  I $G(^(PSPPP,0))'="" W:$X+$L($G(^PSRX(PSONV,"DAI",PSPPP,0)))+2>IOM !?19 W $G(^PSRX(PSONV,"DAI",PSPPP,0))_", "
"RTN","PSOVER1",29,0)
 W ! K DIR,PSPPP S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to intervene?" D ^DIR K DIR I X["^"!($D(DTOUT))!($D(DUOUT)) K PSDTSTOP G OUT
"RTN","PSOVER1",30,0)
 I Y S PSORX("INTERVENE")=0 D EN1^PSORXI(PSONV)
"RTN","PSOVER1",31,0)
EDIT I $G(PKI1)=2 D DCV1^PSOPKIV1 G OUT
"RTN","PSOVER1",32,0)
 K PSDTSTOP S DIR("A")="EDIT",DIR("B")="N",DIR(0)="SB^Y:YES;N:NO;P:PROFILE",DIR("?")="Enter Y to change this RX, P to see a profile, or N to procede with verification"
"RTN","PSOVER1",33,0)
 D ^DIR K DIR I Y="Y",$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",34,0)
 I $D(DIRUT),$G(PSOCLK) S PSOCQ=1 G OUT
"RTN","PSOVER1",35,0)
 I $D(DIRUT),$G(PSOACT)]"" S VALMBCK="R" G OUT
"RTN","PSOVER1",36,0)
 G VERIFY:Y="N",PROF:Y="P",OUT:"YNP"'[$E(Y)
"RTN","PSOVER1",37,0)
CHANGE S DA=PSONV,(PSRX1,PSRX2)=$P(^PSRX(PSONV,0),"^",6)
"RTN","PSOVER1",38,0)
 S DEA1=1,DEA2=0,PSDOLD=+DA,DIE="^PSRX(",DR="3;7;8;9;4;5;12;1;22;11;"_$S($P(PSOPAR,"^",12):"35;",1:"")_$S($P(PSOPAR,"^",15):"10.6",1:"")_";@2" D ^DIE
"RTN","PSOVER1",39,0)
 ;I PSRX1'=PSRX2,DEA1'=DEA2 S DR="6////"_PSRX1 D ^DIE
"RTN","PSOVER1",40,0)
 D EXPIRE K DIE,DR,DEA1,DEA2,P(5),PSRX1,PSRX2
"RTN","PSOVER1",41,0)
 K PSD(PSDOLD) S PSDNEW=$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^")_"^"_PSONV,PSD(PSDNEW)=PSONV_"^*^1^"_$P(^PSDRUG($P(^PSRX(PSONV,0),"^",6),0),"^",2)
"RTN","PSOVER1",42,0)
 S DA=PSONV D ^PSORXPR
"RTN","PSOVER1",43,0)
 G EDIT:PSDNEW=PSDOLD,REDO
"RTN","PSOVER1",44,0)
PROF I '$D(PSOSD) W !,$C(7),"This patient has no other prescriptions on file",!! G EDIT Q
"RTN","PSOVER1",45,0)
 D ^PSODSPL G EDIT Q
"RTN","PSOVER1",46,0)
 ;
"RTN","PSOVER1",47,0)
EXPIRE S RX0=^PSRX(DA,0),X1=$P($P(RX0,"^",13),"."),X2=$P(RX0,"^",9)+1*$P(RX0,"^",8),X2=$S($P(RX0,"^",8)=X2:X2,X2<181:184,X2=360:366,1:X2),X=X1 D:X1&X2 C^%DTC
"RTN","PSOVER1",48,0)
 K ^PS(55,PSDFN,"P","A",+$P(^PSRX(DA,2),"^",6),DA) S ^PS(55,PSDFN,"P","A",X,DA)="",$P(^PSRX(DA,2),"^",6)=X,$P(^PS(52.4,DA,0),"^",7)=X Q
"RTN","PSOVER1",49,0)
VERIFY G:'$P(PSOPAR,"^",2) VERY
"RTN","PSOVER1",50,0)
 S DIR("A")="VERIFY FOR "_PSONAM_" ? (Y/N/Delete/Quit): ",DIR("B")="Y",DIR(0)="SA^Y:YES;N:NO;D:DELETE;Q:QUIT"
"RTN","PSOVER1",51,0)
 S DIR("?",1)="Enter Y (or return) to verify this prescription",DIR("?",2)="N to leave this prescription non-verified and to end this session of verification",DIR("?")="D to delete this prescription"
"RTN","PSOVER1",52,0)
 D ^DIR K DIR G OUT:Y="N",QUIT:"Q^"[$E(Y),DELETE:Y="D"
"RTN","PSOVER1",53,0)
VERY I $G(PKI1)=1 D REA^PSOPKIV1 G:'$D(PKIR) VERIFY
"RTN","PSOVER1",54,0)
 K ^PSRX(PSONV,"DAI") S $P(^PSRX(PSONV,3),"^",6)=""
"RTN","PSOVER1",55,0)
 K ^PSRX(PSONV,"DRI"),SPFL
"RTN","PSOVER1",56,0)
 I '$O(^PSRX(PSONV,6,0)) D  I $D(DUOUT)!($D(DTOUT)) W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" not Verified!!",! H 2 G OUT
"RTN","PSOVER1",57,0)
 .W !!,"Dosing Instructions Missing. Please add!",!
"RTN","PSOVER1",58,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^")]"",'$P($G(^("SIG")),"^",2) W "SIG: "_$P(^PSRX(PSONV,"SIG"),"^"),!
"RTN","PSOVER1",59,0)
 .I $P($G(^PSRX(PSONV,"SIG")),"^",2),$O(^PSRX(PSONV,"SIG1",0)) D  K I
"RTN","PSOVER1",60,0)
 ..W "SIG: " F I=0:0 S I=$O(^PSRX(PSONV,"SIG1",I)) Q:'I  W ^PSRX(PSONV,"SIG1",I,0),!
"RTN","PSOVER1",61,0)
 .S DA=PSONV,PSOVER=1 K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOVER1",62,0)
 .S PSODRUG("IEN")=$P(^PSRX(DA,0),"^",6),PSODFN=$P(^(0),"^",2),PSORXED("IRXN")=DA,PSODRUG("OI")=$P(^PSRX(DA,"OR1"),"^")
"RTN","PSOVER1",63,0)
 .D DOSE^PSSORPH(.DOSE,PSODRUG("IEN"),"O",PSODFN),^PSOORED3
"RTN","PSOVER1",64,0)
 .K PSODFN,PSODRUG("IEN"),DOSE,PSOVER
"RTN","PSOVER1",65,0)
 .I '$G(ENT) S DUOUT=1
"RTN","PSOVER1",66,0)
 .Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSOVER1",67,0)
 .K DIR,DIRUT,DUOUT,DTOUT S DIE=52,DR=114 D ^DIE K DIE,DR,DTOUT
"RTN","PSOVER1",68,0)
 .I X'="" D SIG^PSOHELP D:$G(INS1)]"" EN^DDIOL($E(INS1,2,9999999)) S PSORXED("SIG",1)=$E(INS1,2,9999999)
"RTN","PSOVER1",69,0)
 .D EN^PSOFSIG(.PSORXED,1),UDSIG^PSOORED3 H 2
"RTN","PSOVER1",70,0)
 S DA=PSONV,$P(^PSRX(DA,2),"^",10)=DUZ I $P(^PSRX(DA,2),"^",2)>DT,$P(PSOPAR,"^",6) S (SPFL1,PSOVER)="",PSORX("FILL DATE")=$P(^(2),"^",2),RXF=0 D UPSUS S PSTRIVER=1 D SUS^PSORXL K PSORX("FILL DATE"),PSTRIVER G KILL
"RTN","PSOVER1",71,0)
 S PSOVER(PSONV)="" S $P(^PSRX(PSONV,"STA"),"^")=0,$P(PSOSD("NON-VERIFIED",DRG),"^",2)=0,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG)
"RTN","PSOVER1",72,0)
 I $G(PKI1)=1,$G(PKIR)]"" D ACT^PSOPKIV1(DA)
"RTN","PSOVER1",73,0)
 K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",74,0)
 ;
"RTN","PSOVER1",75,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSOVER1",76,0)
 N ACTION
"RTN","PSOVER1",77,0)
 I $$SUBMIT^PSOBPSUT(PSONV) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSOVER1",78,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSONV,,,$S($O(^PSRX(PSONV,1,0)):"RF",1:"OF"))
"RTN","PSOVER1",79,0)
 . I $$FIND^PSOREJUT(PSONV) D
"RTN","PSOVER1",80,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSONV,0,"79,88","OF","IOQ","I")
"RTN","PSOVER1",81,0)
 ;
"RTN","PSOVER1",82,0)
KILL S DA=PSONV,DIK="^PS(52.4," D ^DIK K DA,DIK D DCORD^PSONEW2
"RTN","PSOVER1",83,0)
OUT K DIRUT,DTOUT,DUOUT,UPFLAGX D CLEAN Q
"RTN","PSOVER1",84,0)
DELETE K UPFLAGX D DELETE^PSOVER2 G:$G(UPFLAGX) OUT K PSOSD("NON-VERIFIED",$G(DRG)) Q
"RTN","PSOVER1",85,0)
QUIT S PSOQUIT="" D CLEAN Q
"RTN","PSOVER1",86,0)
UPSUS S $P(PSOSD("NON-VERIFIED",DRG),"^",2)=5,PSOSD("ACTIVE",DRG)=PSOSD("NON-VERIFIED",DRG) K PSOSD("NON-VERIFIED",DRG) D EN^PSOHLSN1(PSONV,"SC","CM","")
"RTN","PSOVER1",87,0)
 Q
"RTN","PSOVER1",88,0)
CLEAN ;cleans up tmp("psorxdc") global
"RTN","PSOVER1",89,0)
 I $O(^TMP("PSORXDC",$J,0)) F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D
"RTN","PSOVER1",90,0)
 .D PSOUL^PSSLOCK(RORD_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"S",1:""))
"RTN","PSOVER1",91,0)
 .W !,$S($P(^TMP("PSORXDC",$J,RORD,0),"^")=52:"Prescription",1:"Pending Order")_" #"_$S($P(^TMP("PSORXDC",$J,RORD,0),"^")=52:$P(^PSRX(RORD,0),"^"),1:RORD)_" NOT Discontinued."
"RTN","PSOVER1",92,0)
 K ^TMP("PSORXDC",$J),RORD
"RTN","PSOVER1",93,0)
 Q
"RTN","PSOVER1",94,0)
KV1 ;
"RTN","PSOVER1",95,0)
 K PSOANSQD,DRET,LST,PSOQUIT,PSODRUG,PSONEW,SIG,PSODIR,PHI,PRC,ORCHK,ORDRG,PSOSIGFL,PSORX("ISSUE DATE"),PSORX("FILL DATE"),CLOZPAT
"RTN","PSOVER1",96,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSOVER1",97,0)
 Q
"RTN","PSOVER1",98,0)
NVA ;
"RTN","PSOVER1",99,0)
 I $P(PSOSD(STA,DNM),"^",11) D NVA^PSODRDU1 Q
"RTN","PSOVER1",100,0)
 N PSOOI,CLASS,FLG,X,Y,RXREC,IFN
"RTN","PSOVER1",101,0)
 S (Y,FLG)=""
"RTN","PSOVER1",102,0)
 S RXREC=$P(PSOSD(STA,DNM),"^",10),PSOOI=+$G(^PS(55,DFN,"NVA",RXREC,0)),IFN=RXREC N DNM
"RTN","PSOVER1",103,0)
 F  S Y=$O(^PSDRUG("ASP",PSOOI,Y)) Q:Y=""!(FLG)  S DNM=$P(^PSDRUG(Y,0),"^"),CLASS=$P(^PSDRUG(Y,0),"^",2) I PSODRUG("NAME")=DNM!(CLASS=PSODRUG("VA CLASS")) D DSP^PSODRDU1 S FLG=1 Q
"RTN","PSOVER1",104,0)
 Q
"RTN","PSOVER1",105,0)
REMOTE ; 
"RTN","PSOVER1",106,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN) D
"RTN","PSOVER1",107,0)
 .I $T(HAVEHDR^ORRDI1)']"" Q
"RTN","PSOVER1",108,0)
 .I '$$HAVEHDR^ORRDI1 Q
"RTN","PSOVER1",109,0)
 .I $D(^XTMP("ORRDI","OUTAGE INFO","DOWN")) D  Q
"RTN","PSOVER1",110,0)
 ..I $T(REMOTE^PSORX1)]"" Q
"RTN","PSOVER1",111,0)
 ..W !,"Remote data not available - Only local order checks processed." D PAUSE^PSOORRD2
"RTN","PSOVER1",112,0)
 .W !,"Now doing remote order checks. Please wait..."
"RTN","PSOVER1",113,0)
 .D REMOTE^PSOORRDI(PSODFN,+$P($G(^PSRX(PSONV,0)),"^",6))
"RTN","PSOVER1",114,0)
 .I $P($G(^XTMP("ORRDI","PSOO",PSODFN,0)),"^",3)<0 W !,"Remote data not available - Only local order checks processed." D PAUSE^PSOORRD2 Q
"RTN","PSOVER1",115,0)
 .I $D(^TMP($J,"DD")) D DUP^PSOORRD2
"RTN","PSOVER1",116,0)
 .I $D(^TMP($J,"DC")) D CLS^PSOORRD2
"RTN","PSOVER1",117,0)
 .I $D(^TMP($J,"DI"_PSODFN)) K ^TMP($J,"DI") M ^TMP($J,"DI")=^TMP($J,"DI"_PSODFN) D DRGINT^PSOORRD2
"RTN","PSOVER1",118,0)
 K ^TMP($J,"DD"),^TMP($J,"DC"),^TMP($J,"DI"),^TMP($J,"DI"_PSODFN)
"RTN","PSOVER1",119,0)
 Q
"RTN","PSOVER1",120,0)
NOALRGY ;
"RTN","PSOVER1",121,0)
 W $C(7),!,"There is no allergy assessment on file for this patient."
"RTN","PSOVER1",122,0)
 W !,"You will be prompted to intervene if you continue with this prescription"
"RTN","PSOVER1",123,0)
 K DIR
"RTN","PSOVER1",124,0)
 S DIR(0)="SA^1:YES;0:NO",DIR("A")="Do you want to Continue?: ",DIR("B")="N" D ^DIR
"RTN","PSOVER1",125,0)
 I 'Y S PSZZQUIT=1 Q
"RTN","PSOVER1",126,0)
 S PSORX("INTERVENE")=0
"RTN","PSOVER1",127,0)
 D EN1^PSORXI(PSONV)
"RTN","PSOVER1",128,0)
 Q
"VER")
8.0^22.0
"BLD",6316,6)
^237
**END**
**END**
