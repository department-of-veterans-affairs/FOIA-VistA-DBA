Released GMRA*4*13 SEQ #13
Extracted from mail message
**KIDS**:GMRA*4.0*13^

**INSTALL NAME**
GMRA*4.0*13
"BLD",1322,0)
GMRA*4.0*13^ADVERSE REACTION TRACKING^0^2980927^y
"BLD",1322,1,0)
^^2^2^2980927^
"BLD",1322,1,1,0)
This patch will make the ARTS software compatible with the National Drug
"BLD",1322,1,2,0)
File regardless of version.
"BLD",1322,4,0)
^9.64PA^^
"BLD",1322,"ABPKG")
n
"BLD",1322,"KRN",0)
^9.67PA^19^18
"BLD",1322,"KRN",.4,0)
.4
"BLD",1322,"KRN",.401,0)
.401
"BLD",1322,"KRN",.402,0)
.402
"BLD",1322,"KRN",.403,0)
.403
"BLD",1322,"KRN",.5,0)
.5
"BLD",1322,"KRN",.84,0)
.84
"BLD",1322,"KRN",3.6,0)
3.6
"BLD",1322,"KRN",3.8,0)
3.8
"BLD",1322,"KRN",9.2,0)
9.2
"BLD",1322,"KRN",9.8,0)
9.8
"BLD",1322,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",1322,"KRN",9.8,"NM",1,0)
GMRAOR^^0^B11288382
"BLD",1322,"KRN",9.8,"NM",2,0)
GMRAOR3^^0^B5802670
"BLD",1322,"KRN",9.8,"NM",3,0)
GMRAOR5^^0^B22224784
"BLD",1322,"KRN",9.8,"NM",4,0)
GMRAOR9^^0^B5707065
"BLD",1322,"KRN",9.8,"NM",5,0)
GMRAPES0^^0^B26589941
"BLD",1322,"KRN",9.8,"NM",6,0)
GMRAPES1^^0^B11000887
"BLD",1322,"KRN",9.8,"NM",7,0)
GMRARAD1^^0^B1211565
"BLD",1322,"KRN",9.8,"NM","B","GMRAOR",1)

"BLD",1322,"KRN",9.8,"NM","B","GMRAOR3",2)

"BLD",1322,"KRN",9.8,"NM","B","GMRAOR5",3)

"BLD",1322,"KRN",9.8,"NM","B","GMRAOR9",4)

"BLD",1322,"KRN",9.8,"NM","B","GMRAPES0",5)

"BLD",1322,"KRN",9.8,"NM","B","GMRAPES1",6)

"BLD",1322,"KRN",9.8,"NM","B","GMRARAD1",7)

"BLD",1322,"KRN",19,0)
19
"BLD",1322,"KRN",19.1,0)
19.1
"BLD",1322,"KRN",101,0)
101
"BLD",1322,"KRN",409.61,0)
409.61
"BLD",1322,"KRN",771,0)
771
"BLD",1322,"KRN",869.2,0)
869.2
"BLD",1322,"KRN",870,0)
870
"BLD",1322,"KRN",8994,0)
8994
"BLD",1322,"KRN","B",.4,.4)

"BLD",1322,"KRN","B",.401,.401)

"BLD",1322,"KRN","B",.402,.402)

"BLD",1322,"KRN","B",.403,.403)

"BLD",1322,"KRN","B",.5,.5)

"BLD",1322,"KRN","B",.84,.84)

"BLD",1322,"KRN","B",3.6,3.6)

"BLD",1322,"KRN","B",3.8,3.8)

"BLD",1322,"KRN","B",9.2,9.2)

"BLD",1322,"KRN","B",9.8,9.8)

"BLD",1322,"KRN","B",19,19)

"BLD",1322,"KRN","B",19.1,19.1)

"BLD",1322,"KRN","B",101,101)

"BLD",1322,"KRN","B",409.61,409.61)

"BLD",1322,"KRN","B",771,771)

"BLD",1322,"KRN","B",869.2,869.2)

"BLD",1322,"KRN","B",870,870)

"BLD",1322,"KRN","B",8994,8994)

"BLD",1322,"QUES",0)
^9.62^^
"BLD",1322,"REQB",0)
^9.611^4^4
"BLD",1322,"REQB",1,0)
PSN*3.18*7^2
"BLD",1322,"REQB",2,0)
GMRA*4.0*2^2
"BLD",1322,"REQB",3,0)
GMRA*4.0*4^2
"BLD",1322,"REQB",4,0)
GMRA*4.0*12^2
"BLD",1322,"REQB","B","GMRA*4.0*12",4)

"BLD",1322,"REQB","B","GMRA*4.0*2",2)

"BLD",1322,"REQB","B","GMRA*4.0*4",3)

"BLD",1322,"REQB","B","PSN*3.18*7",1)

"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
13^2980927
"PKG",140,22,1,"PAH",1,1,0)
^^2^2^2980929
"PKG",140,22,1,"PAH",1,1,1,0)
This patch will make the ARTS software compatible with the National Drug
"PKG",140,22,1,"PAH",1,1,2,0)
File regardless of version.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","GMRAOR")
0^1^B11288382
"RTN","GMRAOR",1,0)
GMRAOR ;HIRMFO/WAA,RM-OERR UTILITIES ;11/30/95  10:30
"RTN","GMRAOR",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,13**;Mar 29, 1996
"RTN","GMRAOR",3,0)
ORCHK(DFN,TYP,PTR) ; Given a patient IEN (DFN), this function will
"RTN","GMRAOR",4,0)
 ; return 1 (true) if the patient has an allergy to an agent defined
"RTN","GMRAOR",5,0)
 ; by TYP and PTR, else it returns 0 (false). See table below.
"RTN","GMRAOR",6,0)
 ; The Contrast Media Reaction check will return a null if the patient
"RTN","GMRAOR",7,0)
 ; is not in the ART database.
"RTN","GMRAOR",8,0)
 ; 
"RTN","GMRAOR",9,0)
 ;    Contrast Media Reaction:  TYP="CM", PTR (undefined)
"RTN","GMRAOR",10,0)
 ;              Drug Reaction:  TYP="DR", PTR=IEN in ^PSNDF(.
"RTN","GMRAOR",11,0)
 ;           Drug Ingredients:  TYP="IN", PTR=IEN in ^PS(50.416,
"RTN","GMRAOR",12,0)
 ;                 Drug Class:  TYP="CL", PTR=IEN in ^PS(50.605,
"RTN","GMRAOR",13,0)
 ;
"RTN","GMRAOR",14,0)
 N GMRAFLG
"RTN","GMRAOR",15,0)
 S GMRAFLG=0
"RTN","GMRAOR",16,0)
 I $G(DFN)<1!("^CM^DR^IN^CL^"'[("^"_$G(TYP)_"^"))!($G(TYP)'="CM"&($G(PTR)<1)) S GMRAFLG=""
"RTN","GMRAOR",17,0)
 E  D
"RTN","GMRAOR",18,0)
 .I TYP="CM" S GMRAFLG=$$RAD(DFN) ; check for Contrast Media Reaction
"RTN","GMRAOR",19,0)
 .I TYP="DR" S GMRAFLG=$$DRUG(DFN,PTR) ; check for Drug Reaction
"RTN","GMRAOR",20,0)
 .I TYP="IN" S GMRAFLG=$$ING(DFN,PTR) ; Check for Drug Ingredients
"RTN","GMRAOR",21,0)
 .I TYP="CL" S GMRAFLG=$$CLASS(DFN,PTR) ; Check for Drug Class
"RTN","GMRAOR",22,0)
 .Q
"RTN","GMRAOR",23,0)
 Q GMRAFLG
"RTN","GMRAOR",24,0)
RAD(DFN) ; Subroutine checks for Contrast Media Reaction, returns 1 or 0.
"RTN","GMRAOR",25,0)
 N FLG,GMRAL,GMRAPA
"RTN","GMRAOR",26,0)
 D EN1^GMRADPT S FLG=GMRAL
"RTN","GMRAOR",27,0)
 I GMRAL S GMRAPA=0 F  S GMRAPA=$O(GMRAL(GMRAPA)) Q:GMRAPA<1  D  Q:FLG
"RTN","GMRAOR",28,0)
 .S FLG=$$RALLG^GMRARAD(GMRAPA)
"RTN","GMRAOR",29,0)
 .Q
"RTN","GMRAOR",30,0)
 Q FLG
"RTN","GMRAOR",31,0)
DRUG(DFN,PTR) ; Subroutine checks for Drug Reaction, returns 1 or 0.
"RTN","GMRAOR",32,0)
 N %,FLG,GMRAC,GMRADR,GMRAI,PSNVPN,PSNDA S FLG=0
"RTN","GMRAOR",33,0)
 K GMRAING,GMRADRCL
"RTN","GMRAOR",34,0)
 S PSNDA=$P(PTR,"."),PSNVPN=$P(PTR,".",2)
"RTN","GMRAOR",35,0)
 I $G(@($$NDFREF_PSNDA_",0)"))'="" D
"RTN","GMRAOR",36,0)
 .; Check for rxn to ingredients.
"RTN","GMRAOR",37,0)
 .; If use the new entry point if there.
"RTN","GMRAOR",38,0)
 .I $T(DISPDRG^PSNNGR)]"",PSNVPN]"" D
"RTN","GMRAOR",39,0)
 ..K ^TMP("PSNDD",$J) D DISPDRG^PSNNGR ; get ingredients
"RTN","GMRAOR",40,0)
 ..S GMRAI=0,%=1 F  S GMRAI=$O(^TMP("PSNDD",$J,GMRAI)) Q:GMRAI<1  I $D(^GMR(120.8,"API",DFN,GMRAI)) S FLG=1,GMRAING(%)=^TMP("PSNDD",$J,GMRAI),%=%+1
"RTN","GMRAOR",41,0)
 ..K ^TMP("PSNDD",$J)
"RTN","GMRAOR",42,0)
 ..Q
"RTN","GMRAOR",43,0)
 .E  D  ; get ingredients
"RTN","GMRAOR",44,0)
 ..K ^TMP("PSN",$J) D ^PSNNGR
"RTN","GMRAOR",45,0)
 ..S GMRAI=0,%=1 F  S GMRAI=$O(^TMP("PSN",$J,GMRAI)) Q:GMRAI<1  I $D(^GMR(120.8,"API",DFN,GMRAI)) S FLG=1,GMRAING(%)=^TMP("PSN",$J,GMRAI),%=%+1
"RTN","GMRAOR",46,0)
 ..K ^TMP("PSN",$J)
"RTN","GMRAOR",47,0)
 ..Q
"RTN","GMRAOR",48,0)
 .Q:FLG  ; Rxn to ingredient, quit now.
"RTN","GMRAOR",49,0)
 .; Check for rxn to VA Drug Class
"RTN","GMRAOR",50,0)
 .S PSNDA=$P(PTR,"."),PSNVPN=$P(PTR,".",2)
"RTN","GMRAOR",51,0)
 .N CLASS
"RTN","GMRAOR",52,0)
 .I PSNVPN S CLASS=$$DCLCODE^PSNAPIS(PSNDA,PSNVPN) D DRCL(CLASS) Q
"RTN","GMRAOR",53,0)
 .N CLASS,LIST
"RTN","GMRAOR",54,0)
 .S LIST=$$CLIST^PSNAPIS(PSNDA,.LIST) Q:'$G(LIST)
"RTN","GMRAOR",55,0)
 .S LIST=0 F  S LIST=$O(LIST(LIST)) Q:'LIST  D DRCL($P(LIST(LIST),U,2))
"RTN","GMRAOR",56,0)
 .Q
"RTN","GMRAOR",57,0)
 Q FLG
"RTN","GMRAOR",58,0)
DRCL(CODE) ;return any rxn's in GMRADRCL(
"RTN","GMRAOR",59,0)
 I '$D(^GMR(120.8,"APC",DFN,CODE)) Q
"RTN","GMRAOR",60,0)
 N J S J=$S('$D(GMRADRCL):1,1:$O(GMRADRCL(999),-1)+1)
"RTN","GMRAOR",61,0)
 ;S GMRADRCL(J)=$$CLASS2^PSNAPIS(CODE)
"RTN","GMRAOR",62,0)
 N CLSFN
"RTN","GMRAOR",63,0)
 S CLSFN=$P(^PS(50.605,+$O(^PS(50.605,"B",CODE,0)),0),U,2)
"RTN","GMRAOR",64,0)
 S GMRADRCL(J)=CODE_"^"_CLSFN
"RTN","GMRAOR",65,0)
 S FLG=2
"RTN","GMRAOR",66,0)
 Q 
"RTN","GMRAOR",67,0)
ING(DFN,PTR) ; Subroutine checks for Drug Ingredients, returns:
"RTN","GMRAOR",68,0)
 ;                  If found FLG= 1 with GMRAIEN Array Drug Ingredients
"RTN","GMRAOR",69,0)
 ;                 Not found FLG= 0
"RTN","GMRAOR",70,0)
 N GMRAX K GMRAIEN
"RTN","GMRAOR",71,0)
 S FLG=0
"RTN","GMRAOR",72,0)
 S GMRAX=0
"RTN","GMRAOR",73,0)
 F  S GMRAX=$O(^GMR(120.8,"API",DFN,PTR,GMRAX)) Q:GMRAX<1  S FLG=1,GMRAIEN(GMRAX)=""
"RTN","GMRAOR",74,0)
 Q FLG
"RTN","GMRAOR",75,0)
CLASS(DFN,PTR) ; Subroutine checks for Drug Class, returns:
"RTN","GMRAOR",76,0)
 ;                  If found FLG= 1 with GMRAIEN Array Drug Class
"RTN","GMRAOR",77,0)
 ;                 Not found FLG= 0
"RTN","GMRAOR",78,0)
 N GMRAC,GMRAX K GMRAIEN
"RTN","GMRAOR",79,0)
 S GMRAX=0,FLG=0,GMRAC=$P($G(^PS(50.605,PTR,0)),U)
"RTN","GMRAOR",80,0)
 I GMRAC'="" F  S GMRAX=$O(^GMR(120.8,"APC",DFN,GMRAC,GMRAX)) Q:GMRAX<1  S FLG=1,GMRAIEN(GMRAX)=""
"RTN","GMRAOR",81,0)
 Q FLG
"RTN","GMRAOR",82,0)
NDFREF() ;get version dependent NDF reference
"RTN","GMRAOR",83,0)
 I $$VERSION^XPDUTL("PSN")<4 Q "^PSNDF("
"RTN","GMRAOR",84,0)
 Q "^PSNDF(50.6," ; new reference for ver 4.0
"RTN","GMRAOR3")
0^2^B5802670
"RTN","GMRAOR3",1,0)
GMRAOR3 ;HIRMFO/RM,WAA-ORDERABLE LIST UTILITIES ; 2/2/95
"RTN","GMRAOR3",2,0)
 ;;4.0;Adverse Reaction Tracking;**13**;Mar 29, 1996
"RTN","GMRAOR3",3,0)
EN1(START,NUM,ARRAY) ; ENTRY POINT WHERE ALL VARIABLES ARE OPTIONAL.
"RTN","GMRAOR3",4,0)
 ;  START IS THE STARTING POINT OF LIST TO BE RETURNED, NUM IS
"RTN","GMRAOR3",5,0)
 ;  THE NUMBER OF ENTRIES FROM STARTING POINT TO INCLUDE IN LIST,
"RTN","GMRAOR3",6,0)
 ;  AND ARRAY IS THE ADDRESS OF THE ARRAY LIST IS TO BE RETURNED.
"RTN","GMRAOR3",7,0)
 ;
"RTN","GMRAOR3",8,0)
 K:$G(START)="" START ; Force list to start at "A" and skip num./punc.
"RTN","GMRAOR3",9,0)
 S START=$G(START,"A"),NUM=$G(NUM),ARRAY=$G(ARRAY,"GMRALST")
"RTN","GMRAOR3",10,0)
 K ^TMP($J,"GMRALST")
"RTN","GMRAOR3",11,0)
NODE ;Loop through each file in order of X-ref.
"RTN","GMRAOR3",12,0)
 ;
"RTN","GMRAOR3",13,0)
 ; Loop through GMR Allergies file.
"RTN","GMRAOR3",14,0)
 S GMRAST=START
"RTN","GMRAOR3",15,0)
 F GMRACNT=1:1 Q:NUM&(GMRACNT>NUM)  S GMRAST=$O(^GMRD(120.82,"B",GMRAST)) Q:GMRAST=""  S GMRAIEN=$O(^(GMRAST,"")) I GMRAIEN>0 D FILE("ALL",0)
"RTN","GMRAOR3",16,0)
 ;
"RTN","GMRAOR3",17,0)
 ; Loop through VA Drug Class file.
"RTN","GMRAOR3",18,0)
 S GMRAST=START
"RTN","GMRAOR3",19,0)
 F GMRACNT=1:1 Q:NUM&(GMRACNT>NUM)  S GMRAST=$O(^PS(50.605,"C",GMRAST)) Q:GMRAST=""  S GMRAIEN=$O(^(GMRAST,"")) I GMRAIEN>0 D FILE("PSC",0)
"RTN","GMRAOR3",20,0)
 ;
"RTN","GMRAOR3",21,0)
 ; Loop through NDF File (B X-ref)
"RTN","GMRAOR3",22,0)
 ; $$B^PSNAPIS returns NDF version dependent root of "B" x-ref
"RTN","GMRAOR3",23,0)
 S GMRAST=START
"RTN","GMRAOR3",24,0)
 F GMRACNT=1:1 Q:NUM&(GMRACNT>NUM)  S GMRAST=$O(@($$B^PSNAPIS)@(GMRAST)) Q:GMRAST=""  S GMRAIEN=$O(^(GMRAST,"")) I GMRAIEN>0 D FILE("NDF",0)
"RTN","GMRAOR3",25,0)
 ;
"RTN","GMRAOR3",26,0)
 ; Loop through NDF file (T X-ref)
"RTN","GMRAOR3",27,0)
 ; $$T^PSNAPIS returns NDF version dependent root of "T" x-ref
"RTN","GMRAOR3",28,0)
 S GMRAST=START K ^TMP($J,"GMRAT")
"RTN","GMRAOR3",29,0)
 F GMRACNT=1:1 Q:NUM&(GMRACNT>NUM)  S GMRAST=$O(@($$T^PSNAPIS)@(GMRAST))  Q:GMRAST=""  S GMRAIEN=$$TGTOG^PSNAPIS(GMRAST) I GMRAIEN>0 D FILE("NDF",1)
"RTN","GMRAOR3",30,0)
 ; Set the return array.
"RTN","GMRAOR3",31,0)
 S GMRACNT=1,GMRAST="" F  S GMRAST=$O(^TMP($J,"GMRALST",GMRAST)) Q:GMRAST=""  D  I NUM'="" Q:GMRACNT>NUM
"RTN","GMRAOR3",32,0)
 .S @ARRAY@(GMRACNT)=^TMP($J,"GMRALST",GMRAST),GMRACNT=GMRACNT+1
"RTN","GMRAOR3",33,0)
 .Q
"RTN","GMRAOR3",34,0)
 K ^TMP($J,"GMRALST"),^TMP($J,"GMRAT"),GMRACNT,GMRAIEN,GMRAST
"RTN","GMRAOR3",35,0)
 Q
"RTN","GMRAOR3",36,0)
FILE(GMRATAB,GMRAT) ;File away a found entry
"RTN","GMRAOR3",37,0)
 ;    GMRATAB is the table entry in from OE3 HL7 spec.
"RTN","GMRAOR3",38,0)
 ;    GMRAT is (0/1) indicating whether to check for dups of same entry.
"RTN","GMRAOR3",39,0)
 ;
"RTN","GMRAOR3",40,0)
 I GMRAT Q:$D(^TMP($J,"GMRAT",GMRAIEN))  S ^(GMRAIEN)=""
"RTN","GMRAOR3",41,0)
 I '$D(^TMP($J,"GMRALST",GMRAST)) S ^(GMRAST)=GMRAIEN_U_GMRAST_U_"99"_GMRATAB
"RTN","GMRAOR3",42,0)
 K GMRAT,GMRATAB
"RTN","GMRAOR3",43,0)
 Q
"RTN","GMRAOR5")
0^3^B22224784
"RTN","GMRAOR5",1,0)
GMRAOR5 ;HIRMFO/WAA,FPT-OERR HL7 UTILITY ;7/8/97  10:25
"RTN","GMRAOR5",2,0)
 ;;4.0;Adverse Reaction Tracking;**4,12,13**;Mar 29, 1996
"RTN","GMRAOR5",3,0)
 ;MSG = HL7 Message array
"RTN","GMRAOR5",4,0)
 ;GMRANODE = IEN of MSG array
"RTN","GMRAOR5",5,0)
 ;GMRAND = Date from MSG(GMRANODE)
"RTN","GMRAOR5",6,0)
 ;GMRAMTP = Message type
"RTN","GMRAOR5",7,0)
 ;Allergy Loader
"RTN","GMRAOR5",8,0)
 ;building GMRAL Array to be used to stuff only new data
"RTN","GMRAOR5",9,0)
 ;GMRAID=sequence number of allergy
"RTN","GMRAOR5",10,0)
 ;~=continuation
"RTN","GMRAOR5",11,0)
 ;GMRAIDO = Sequence # OBSERVED
"RTN","GMRAOR5",12,0)
 ;GMRAIDS = Sequence # SIGN
"RTN","GMRAOR5",13,0)
 ;GMRAIDN = Sequence # NOTES
"RTN","GMRAOR5",14,0)
 ;   GMRADFN=DFN of patient in ^DPT(DFN) Patient (2) file
"RTN","GMRAOR5",15,0)
 ;   GMRAL(GMRAID)=type^file ien^VA Free text drug^file^OERR entry date
"RTN","GMRAOR5",16,0)
 ;                 ^NKA Status^Originator Pt to 200^Observed/Historical
"RTN","GMRAOR5",17,0)
 ;   GMRAL(GMRAID,"O",GMRAIDO)=Observed date^Severity^Observer's DUZ
"RTN","GMRAOR5",18,0)
 ;   GMRAL(GMRAID,"S",GMRAIDS)=IEN of file^Free Text of entry^File of SS
"RTN","GMRAOR5",19,0)
 ;                             ^Date/Time of the SS
"RTN","GMRAOR5",20,0)
 ;   GMRAL(GMRAID,"N",GMRAIDN)=Source of comments(Originator always)
"RTN","GMRAOR5",21,0)
 ;----------------------------------------------------------------------
"RTN","GMRAOR5",22,0)
 ;             Example of data
"RTN","GMRAOR5",23,0)
 ;   GMRADFN=270
"RTN","GMRAOR5",24,0)
 ;   GMRAL(1)="D^5^SHELL FISH^99ALL^2940415.06^n^1270^o"
"RTN","GMRAOR5",25,0)
 ;   GMRAL(1,"O",1)="2940401.1^3^1234"
"RTN","GMRAOR5",26,0)
 ;   GMRAL(1,"S",1)="32^SEVERE RASH^99ALS^2951211.1120"
"RTN","GMRAOR5",27,0)
 ;   GMRAL(1,"N",1)="n"
"RTN","GMRAOR5",28,0)
 ;   GMRAL(1,"N",1,1)=FREE TEXT
"RTN","GMRAOR5",29,0)
 ;******************************************************************
"RTN","GMRAOR5",30,0)
EN1 ;Main entry point to file data
"RTN","GMRAOR5",31,0)
 N %,GMRADUP,GMRAFDN,GMRANKA,GNRAY,X,Y
"RTN","GMRAOR5",32,0)
 Q:'$G(GMRADFN)
"RTN","GMRAOR5",33,0)
 S GMRAL=0
"RTN","GMRAOR5",34,0)
 S GMRAPA=0,GMRADUP=0
"RTN","GMRAOR5",35,0)
 ; See if the patient has been ask about allergies
"RTN","GMRAOR5",36,0)
 S (GMRAYN,GMRANKA)=0,GMRAYN=$P($G(^GMR(120.86,GMRADFN,0)),U,2)
"RTN","GMRAOR5",37,0)
 ;Loop through for each allergy
"RTN","GMRAOR5",38,0)
 F  S GMRAL=$O(GMRAL(GMRAL)) Q:GMRAL<1  D
"RTN","GMRAOR5",39,0)
 .;If GMRANKA="" add the entry into the file
"RTN","GMRAOR5",40,0)
 .I '$D(^GMR(120.86,GMRADFN,0)) K DD,DO,DIC,DINUM,DLAYGO S DIC="^GMR(120.86,",DLAYGO=120.86,DIC(0)="L",(DINUM,X)=GMRADFN D FILE^DICN K DD,DO,DIC,DINUM,DLAYGO D
"RTN","GMRAOR5",41,0)
 ..Q:Y=-1
"RTN","GMRAOR5",42,0)
 ..S GMRAYN=$S($P(GMRAL(GMRAL),U,6)="y":1,1:0)
"RTN","GMRAOR5",43,0)
 ..S $P(^GMR(120.86,GMRADFN,0),U,2,4)=GMRAYN_U_$P(GMRAL(GMRAL),U,7)_U_$P(GMRAL(GMRAL),U,5)
"RTN","GMRAOR5",44,0)
 ..Q
"RTN","GMRAOR5",45,0)
 .N GMRALL,GMRAFN,%
"RTN","GMRAOR5",46,0)
 .S GMRALL=$P(GMRAL(GMRAL),U,3)
"RTN","GMRAOR5",47,0)
 .I $P(GMRAL(GMRAL),U,6)="n" D  Q:GMRALL'=""
"RTN","GMRAOR5",48,0)
 ..; Change to no for allergies
"RTN","GMRAOR5",49,0)
 ..Q:GMRAYN="1"!$D(^GMR(120.86,GMRADFN,0))
"RTN","GMRAOR5",50,0)
 ..S $P(^GMR(120.86,GMRADFN,0),U,2,4)="0"_U_$P(GMRAL(GMRAL),U,7)_U_$P(GMRAL(GMRAL),U,5)
"RTN","GMRAOR5",51,0)
 ..S:'$D(^GMR(120.86,"B",GMRADFN,GMRADFN)) ^(GMRADFN)=""
"RTN","GMRAOR5",52,0)
 ..Q
"RTN","GMRAOR5",53,0)
 .I GMRAYN="0",$P(GMRAL(GMRAL),U,6)="n" Q
"RTN","GMRAOR5",54,0)
 .; see If the entry needs to be added
"RTN","GMRAOR5",55,0)
 .; If the entry is an allergy set 120.86 to "y"
"RTN","GMRAOR5",56,0)
 .I GMRALL'="",$D(^GMR(120.86,GMRADFN,0)) S GMRAYN=1 D
"RTN","GMRAOR5",57,0)
 ..; Change to yes for allergies
"RTN","GMRAOR5",58,0)
 ..S $P(^GMR(120.86,GMRADFN,0),U,2,4)=GMRAYN_U_$P(GMRAL(GMRAL),U,7)_U_$P(GMRAL(GMRAL),U,5)
"RTN","GMRAOR5",59,0)
 ..S:'$D(^GMR(120.86,"B",GMRADFN,GMRADFN)) ^(GMRADFN)=""
"RTN","GMRAOR5",60,0)
 ..Q
"RTN","GMRAOR5",61,0)
 .; Quit if the reaction is a Dup
"RTN","GMRAOR5",62,0)
 .Q:$$DUPCHK^GMRAOR0(GMRADFN,GMRALL)>0
"RTN","GMRAOR5",63,0)
 .S GMRAPA=0
"RTN","GMRAOR5",64,0)
 .K DD,DO,DIC,DINUM,DLAYGO S DIC="^GMR(120.8,",DLAYGO=120.8,DIC(0)="L",X=GMRADFN D FILE^DICN
"RTN","GMRAOR5",65,0)
 .K DD,DO,DIC,DINUM,DLAYGO
"RTN","GMRAOR5",66,0)
 .Q:Y=-1  S GMRAPA=+Y
"RTN","GMRAOR5",67,0)
 .Q:$G(^GMR(120.8,GMRAPA,0))=""
"RTN","GMRAOR5",68,0)
 .F  Q:$$LOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAOR5",69,0)
 .N GMRALN,GMRAVR
"RTN","GMRAOR5",70,0)
 .S GMRALN=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAOR5",71,0)
 .S $P(GMRALN,U,4)=$P(GMRAL(GMRAL),U,5) ; Orig. DT
"RTN","GMRAOR5",72,0)
 .S $P(GMRALN,U,5)=$P(GMRAL(GMRAL),U,7) ; Originator
"RTN","GMRAOR5",73,0)
 .S %=$P(GMRAL(GMRAL),U,4),%=$S(%="99ALL"!(%="99OTH"):"GMRD(120.82,",%="99NDF":$P($$NDFREF^GMRAOR,U,2),%="99PSC":"PS(50.605,",1:"") Q:%=""  ;Bad entry
"RTN","GMRAOR5",74,0)
 .S:$P(GMRAL(GMRAL),U,2)="NOS" $P(GMRAL(GMRAL),U,2)=$S($O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0))>0:$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0)),1:1)
"RTN","GMRAOR5",75,0)
 .S GMRAAR=$P(GMRAL(GMRAL),U,2)_";"_%,$P(GMRALN,U,3)=GMRAAR ;File Ptr
"RTN","GMRAOR5",76,0)
 .I $P(GMRAL(GMRAL),U,3)'="" S $P(GMRALN,U,2)=$P(GMRAL(GMRAL),U,3) ;Free text
"RTN","GMRAOR5",77,0)
 .E  D  ; This code will resolve the free text pointer for the reaction
"RTN","GMRAOR5",78,0)
 ..N GMRALOC,GMRADATA
"RTN","GMRAOR5",79,0)
 ..S GMRALOC="^"_$P($P(GMRALN,U,3),";",2)_+$P(GMRALN,U,3)_",0)"
"RTN","GMRAOR5",80,0)
 ..S GMRADATA=@GMRALOC
"RTN","GMRAOR5",81,0)
 ..S $P(GMRALN,U,2)=$P(GMRADATA,U)
"RTN","GMRAOR5",82,0)
 ..Q
"RTN","GMRAOR5",83,0)
 .S $P(GMRALN,U,20)=$P(GMRAL(GMRAL),U) ;Type of reaction
"RTN","GMRAOR5",84,0)
 .S $P(GMRALN,U,6)=$P(GMRAL(GMRAL),U,8) ;Obs/Hist
"RTN","GMRAOR5",85,0)
 .S $P(GMRALN,U,14)="U" ;Mechanism
"RTN","GMRAOR5",86,0)
 .S $P(GMRALN,U,12)=1 ;Sign-off the reaction
"RTN","GMRAOR5",87,0)
 .; auto-verify?
"RTN","GMRAOR5",88,0)
 .S GMRAVR="",GMRAVR(0)=GMRALN
"RTN","GMRAOR5",89,0)
 .S $P(GMRALN,U,16)=$$VFY^GMRASIGN(.GMRAVR)
"RTN","GMRAOR5",90,0)
 .I $P(GMRALN,U,16) S $P(GMRALN,U,17)=$$NOW^XLFDT
"RTN","GMRAOR5",91,0)
 .; save
"RTN","GMRAOR5",92,0)
 .S ^GMR(120.8,GMRAPA,0)=GMRALN
"RTN","GMRAOR5",93,0)
 .I $D(GMRAL(GMRAL,"S",1)) D SIGN^GMRAOR6(120.8,GMRAPA,.GMRAL) ; S/S
"RTN","GMRAOR5",94,0)
 .; Comments
"RTN","GMRAOR5",95,0)
 .I $D(GMRAL(GMRAL,"N",1)) D COMM^GMRAOR8(GMRAPA,.GMRAL) ; Add comments
"RTN","GMRAOR5",96,0)
 .D EN1^GMRAOR9 K GMRAAR ;stuff ingredients & classes
"RTN","GMRAOR5",97,0)
 .;Re-Index Whole file entry
"RTN","GMRAOR5",98,0)
 .K DIK,DA S DIK="^GMR(120.8,",DA=GMRAPA D IX^DIK K DIK,DA
"RTN","GMRAOR5",99,0)
 .D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAOR5",100,0)
 .Q:($P(GMRAL(GMRAL),U,1)'["D"!($P(GMRAL(GMRAL),U,8)'["o"))  ;quit if not an observed drug reaction
"RTN","GMRAOR5",101,0)
 .; add Adverse Reaction report.
"RTN","GMRAOR5",102,0)
 .I $G(GMRAL(GMRAL,"O",1))'="" D ADVERSE^GMRAOR7(GMRAPA,.GMRAL)
"RTN","GMRAOR5",103,0)
 .Q
"RTN","GMRAOR5",104,0)
 Q
"RTN","GMRAOR9")
0^4^B5707065
"RTN","GMRAOR9",1,0)
GMRAOR9 ;HIRMFO/RM,WAA,FPT-Stuff Drug Ingredients/Classes ;7/21/96  16:31
"RTN","GMRAOR9",2,0)
 ;;4.0;Adverse Reaction Tracking;**4,13**;Mar 29, 1996
"RTN","GMRAOR9",3,0)
 ; <Copied from GMRAPES1>
"RTN","GMRAOR9",4,0)
EN1 ; Auto stuff Ingredients and VA Drug Classes
"RTN","GMRAOR9",5,0)
 ; GMRAING() will have all the ingredients for the reaction
"RTN","GMRAOR9",6,0)
 ; GMRADRCL() will have all the drug classes for the reaction.
"RTN","GMRAOR9",7,0)
 ;
"RTN","GMRAOR9",8,0)
 K GMRADRCL,GMRAING
"RTN","GMRAOR9",9,0)
 ; If the Reactant is a Drug Ingredient
"RTN","GMRAOR9",10,0)
 I GMRAAR[50.416 S GMRAING(+GMRAAR)="" G STING
"RTN","GMRAOR9",11,0)
 ;If the Reactant is a Drug Class
"RTN","GMRAOR9",12,0)
 I GMRAAR[50.605 S GMRADRCL(+GMRAAR)=""
"RTN","GMRAOR9",13,0)
 ;If the Reactant is an entry in the GMR ALLERGY file
"RTN","GMRAOR9",14,0)
 I GMRAAR[120.82 D
"RTN","GMRAOR9",15,0)
 .S Y=0 F  S Y=$O(^GMRD(120.82,+GMRAAR,"ING",Y)) Q:Y'>0  I $D(^GMRD(120.82,+GMRAAR,"ING",Y,0)),+^(0)>0 S GMRAING(+^(0))=""
"RTN","GMRAOR9",16,0)
 .S Y=0 F  S Y=$O(^GMRD(120.82,+GMRAAR,"CLASS",Y)) Q:Y'>0  I $D(^GMRD(120.82,+GMRAAR,"CLASS",Y,0)),+^(0)>0 S GMRADRCL(+^(0))=""
"RTN","GMRAOR9",17,0)
 .Q
"RTN","GMRAOR9",18,0)
 I GMRAAR["PSDRUG" D
"RTN","GMRAOR9",19,0)
 .N PSODA
"RTN","GMRAOR9",20,0)
 .S PSODA=+GMRAAR K ^TMP("PSO",$J) D ^PSONGR F Y=0:0 S Y=$O(^TMP("PSO",$J,Y)) Q:Y'>0  S GMRAING(Y)=""
"RTN","GMRAOR9",21,0)
 .N GMRAX,GMRAY
"RTN","GMRAOR9",22,0)
 .S GMRAX=$P($G(^PSDRUG(+GMRAAR,"ND")),U,6) S:GMRAX>0 GMRADRCL(GMRAX)="" Q
"RTN","GMRAOR9",23,0)
 .S GMRAX=$P($G(^PSDRUG(+GMRAAR,0)),U,2) Q:GMRAX=""
"RTN","GMRAOR9",24,0)
 .S GMRAY=$O(^PS(50.605,"B",GMRAX,"")) S:GMRAY>0 GMRADRCL(GMRAY)=""
"RTN","GMRAOR9",25,0)
 .Q
"RTN","GMRAOR9",26,0)
 I GMRAAR["PSNDF" D
"RTN","GMRAOR9",27,0)
 .N PSNDA
"RTN","GMRAOR9",28,0)
 .S PSNDA=+GMRAAR K ^TMP("PSN",$J) D ^PSNNGR F Y=0:0 S Y=$O(^TMP("PSN",$J,Y)) Q:Y'>0  S GMRAING(Y)=""
"RTN","GMRAOR9",29,0)
 .; all classes for NDF entry returned in GMRADRCL
"RTN","GMRAOR9",30,0)
 .N CLASS
"RTN","GMRAOR9",31,0)
 .S CLASS=$$CLIST^PSNAPIS(+GMRAAR,.GMRADRCL)
"RTN","GMRAOR9",32,0)
 K ^TMP("PSO",$J),^TMP("PSN",$J),PSODA,PSNID
"RTN","GMRAOR9",33,0)
STING ;Stuffing Drug Ing & VA Drug Classes into file 120.8
"RTN","GMRAOR9",34,0)
 I $D(GMRAING) D
"RTN","GMRAOR9",35,0)
 .S DA(1)=+GMRAPA,DIC="^GMR(120.8,"_+GMRAPA_",2,",DLAYGO=120.8,DIC(0)="L",DIC("P")="120.802PA"
"RTN","GMRAOR9",36,0)
 .F X=0:0 S X=$O(GMRAING(X)) Q:X'>0  I '$D(^GMR(120.8,GMRAPA,2,"B",X)) K DD,DO,DINUM D FILE^DICN
"RTN","GMRAOR9",37,0)
 .K DIC,DLAYGO
"RTN","GMRAOR9",38,0)
 .Q
"RTN","GMRAOR9",39,0)
 I $D(GMRADRCL) D
"RTN","GMRAOR9",40,0)
 .S DA(1)=+GMRAPA,DIC="^GMR(120.8,"_+GMRAPA_",3,",DIC(0)="L",DIC("P")="120.803PA"
"RTN","GMRAOR9",41,0)
 .F X=0:0 S X=$O(GMRADRCL(X)) Q:X'>0  I '$D(^GMR(120.8,GMRAPA,3,"B",X)) K DD,DO,DINUM D FILE^DICN
"RTN","GMRAOR9",42,0)
 .K DIC
"RTN","GMRAOR9",43,0)
 .Q
"RTN","GMRAOR9",44,0)
 K GMRADRCL,GMRAING
"RTN","GMRAOR9",45,0)
 Q
"RTN","GMRAPES0")
0^5^B26589941
"RTN","GMRAPES0",1,0)
GMRAPES0 ;HIRMFO/RM-SELECT PATIENT ALLERGY TO EDIT ; 2/14/92
"RTN","GMRAPES0",2,0)
 ;;4.0;Adverse Reaction Tracking;**13**;Mar 29, 1996
"RTN","GMRAPES0",3,0)
EN1 ; GIVEN DFN, SELECT PATIENT ALLERGY
"RTN","GMRAPES0",4,0)
 N GMRAGOUT S GMRARET=0
"RTN","GMRAPES0",5,0)
 S GMRAPA=-1,GMRANEW=0 R !!,"Enter Causative Agent: ",GMRALAR:DTIME S:'$T GMRALAR="^^" S:GMRALAR="" GMRARET=1 I "^^"[GMRALAR S GMRAOUT='$L(GMRALAR)+1 G Q1
"RTN","GMRAPES0",6,0)
 I GMRALAR?1P.E!($L(GMRALAR)<3)!($L(GMRALAR)>30) S GMRAHLP=1 D EN1^GMRAHLP0 G EN1:'GMRAOUT,Q1
"RTN","GMRAPES0",7,0)
 I GMRALAR?.E1L.E F X=1:1:$L(GMRALAR) I $E(GMRALAR,X)?1L S GMRALAR=$E(GMRALAR,1,X-1)_$C($A($E(GMRALAR,X))-32)_$E(GMRALAR,X+1,$L(GMRALAR))
"RTN","GMRAPES0",8,0)
PAL K Y,DTOUT,DUOUT S DGSENFLG="",DIC="^GMR(120.8,",DIC(0)="SEZ",X=GMRANAM,DIC("S")="I '+$G(^(""ER"")),$P(^(0),U,2)?@(""1""""""_GMRALAR_"""""".E""),$D(^GMR(120.8,""B"",DFN,+Y))",DIC("W")="W $P(^(0),U,2)"
"RTN","GMRAPES0",9,0)
 D ^DIC S X=$P($G(Y(0)),"^",2) K DIC,DGSENFLG,DTOUT,DUOUT D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",10,0)
 S:+Y>0 GMRAPA=+Y G Q1:+Y>0!GMRAOUT,PAL:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",11,0)
 G Q1:'GMRALAGO
"RTN","GMRAPES0",12,0)
NPA K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 X=$P(Y,"^",2) D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",13,0)
 I +Y>0 S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",14,0)
 G Q1:GMRAOUT,NPA:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",15,0)
ING K Y,DTOUT,DUOUT S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",X=GMRALAR D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",16,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",17,0)
 G Q1:GMRAOUT,ING:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",18,0)
CLASS K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",D="C" D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",19,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",20,0)
 G Q1:GMRAOUT,CLASS:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",21,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAPES0",22,0)
 K Y,DTOUT,DUOUT
"RTN","GMRAPES0",23,0)
 N CNT,LST
"RTN","GMRAPES0",24,0)
 S CNT=$$TGTOG2^PSNAPIS(GMRALAR,.LST)
"RTN","GMRAPES0",25,0)
 I 'CNT S Y=-1
"RTN","GMRAPES0",26,0)
 I CNT=1 S Y=+$O(LST(0)),Y(0)=LST(Y)
"RTN","GMRAPES0",27,0)
 I CNT>1 D  I $D(DTOUT)!($D(DUOUT)) S Y=-1
"RTN","GMRAPES0",28,0)
 . N CHOICES,DIR
"RTN","GMRAPES0",29,0)
 . D MATCHES
"RTN","GMRAPES0",30,0)
 . S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",31,0)
 . S DIR("?")="Select the number of the desired causative agent"
"RTN","GMRAPES0",32,0)
 . D ^DIR S Y=$S(+Y:+CHOICES(Y),1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",33,0)
 D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",34,0)
 I +Y>0 S GMRAAR=+Y_";"_$P($$NDFREF^GMRAOR,U,2),GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",35,0)
 G Q1:GMRAOUT,NDF:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",36,0)
DRUG K Y,DTOUT,DUOUT S DIC="^PSDRUG(",DIC(0)="EMZ",X=GMRALAR D ^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",37,0)
 I +Y>0 S GMRAAR=+Y_";PSDRUG(",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",38,0)
 G Q1:GMRAOUT,DRUG:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",39,0)
 I GMRALAR["," W !,?4,$C(7),"YOU CANNOT ENTER MULTIPLE REACTANTS." G EN1
"RTN","GMRAPES0",40,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files.",!,"Would you like to still add it as a causative agent" S %=1 D YN^DICN S:%=-1 GMRAOUT=1 G Q1:GMRAOUT,EN1:%=2
"RTN","GMRAPES0",41,0)
 I '% W !?3,$C(7),"ANSWER YES IF YOU WOULD LIKE TO ADD THIS CAUSATIVE AGENT,",!?3,"ELSE ANSWER NO." G YNOTH
"RTN","GMRAPES0",42,0)
YNDRG S GMRAY=$P($G(^GMR(120.8,GMRAPA,0)),U,20)
"RTN","GMRAPES0",43,0)
 D EDTTYPE^GMRAUTL(.GMRAY) S:"^^"[GMRAY GMRAOUT=1 G:GMRAOUT Q1
"RTN","GMRAPES0",44,0)
 S GMRAAR=+$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",""))_";GMRD(120.82,",GMRAAR(0)=GMRALAR,GMRAAR("O")=GMRAY D ADAR^GMRAPES1 I GMRAPA'>0 K GMRAAR,GMRAY G EN1
"RTN","GMRAPES0",45,0)
Q1 ;
"RTN","GMRAPES0",46,0)
 S:GMRAPA>0 GMRAPA(0)=$S($D(^GMR(120.8,+GMRAPA,0)):^(0),1:"")
"RTN","GMRAPES0",47,0)
 K %,D,DA,DIC,DTOUT,DUOUT,GMRAAR,GMRAHLP,GMRAING,GMRALAGO,GMRALAR,PSNDA,PSODA,X,Y
"RTN","GMRAPES0",48,0)
 Q
"RTN","GMRAPES0",49,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAPES0",50,0)
 I Y[","
"RTN","GMRAPES0",51,0)
 S:$D(DTOUT) X="^^" I X="^^" S GMRAOUT=1 Q
"RTN","GMRAPES0",52,0)
 S:$D(DUOUT) Y=0 Q:+Y'>0
"RTN","GMRAPES0",53,0)
YNOK W !?3,X,"   OK" S %=1 D YN^DICN S:%=-1 GMRAOUT=1,Y=-1 Q:GMRAOUT  S:%=2 Y=-1 S:$$DUPCHK(X,DFN,Y) Y=-1 Q:GMRAOUT  I % W ! Q
"RTN","GMRAPES0",54,0)
 W !?5,$C(7),"ANSWER YES IF THIS IS THE CORRECT ALLERGY/ADVERSE REACTION,",!?5,"ELSE ANSWER NO."
"RTN","GMRAPES0",55,0)
 G YNOK
"RTN","GMRAPES0",56,0)
DUPCHK(X,Y,Z) ;CHECK FOR ENTERED IN ERROR
"RTN","GMRAPES0",57,0)
 N GMRAPA,GMRAGOUT,%,%Y S GMRAGOUT=0
"RTN","GMRAPES0",58,0)
 I $P($G(^GMR(120.8,+Z,0)),U,2)=X Q GMRAGOUT
"RTN","GMRAPES0",59,0)
 I $O(^GMR(120.8,"B",Y,0)) S GMRAPA=0 F  S GMRAPA=$O(^GMR(120.8,"B",Y,GMRAPA)) Q:GMRAPA<1  D  Q:GMRAOUT!(GMRAGOUT)
"RTN","GMRAPES0",60,0)
 .I $P(^GMR(120.8,GMRAPA,0),U,2)'=X Q
"RTN","GMRAPES0",61,0)
 .I $D(^GMR(120.8,GMRAPA,"ER")) D
"RTN","GMRAPES0",62,0)
 ..F  S %=2 W !,?5,$C(7),"This Agent has been Entered in Error once before.",!,?5,"Are you sure you want to select this Agent again" D  Q:%
"RTN","GMRAPES0",63,0)
 ...D YN^DICN S:%=-1 %=2,GMRAOUT=1  S:%Y?2"^" GMRAOUT=2
"RTN","GMRAPES0",64,0)
 ...Q:%  W !,?10,"ENTER 'Y' FOR YES OR 'N' FOR NO"
"RTN","GMRAPES0",65,0)
 ...Q
"RTN","GMRAPES0",66,0)
 ..S GMRAGOUT=%
"RTN","GMRAPES0",67,0)
 ..Q
"RTN","GMRAPES0",68,0)
 .Q
"RTN","GMRAPES0",69,0)
 I GMRAGOUT=0 S GMRAGOUT=1
"RTN","GMRAPES0",70,0)
 Q (GMRAGOUT-1)
"RTN","GMRAPES0",71,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAPES0",72,0)
 N I,J,K,QUIT
"RTN","GMRAPES0",73,0)
 S CHOICES=1,K=0
"RTN","GMRAPES0",74,0)
 F  S K=$O(LST(K)) Q:'K  S CHOICES(CHOICES)=LST(K),CHOICES=CHOICES+1
"RTN","GMRAPES0",75,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAPES0",76,0)
 S (I,J,QUIT)=0 F  S I=$O(CHOICES(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAPES0",77,0)
 . S J=J+1 I J>(IOSL-5) S:'$$MORE QUIT=1 Q:QUIT  S J=1
"RTN","GMRAPES0",78,0)
 . W !,J,"  ",$P(CHOICES(I),"^",2)
"RTN","GMRAPES0",79,0)
 Q
"RTN","GMRAPES0",80,0)
        ;
"RTN","GMRAPES0",81,0)
MORE()  ; -- show more matches
"RTN","GMRAPES0",82,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAPES0",83,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAPES0",84,0)
 D ^DIR
"RTN","GMRAPES0",85,0)
 Q +Y
"RTN","GMRAPES1")
0^6^B11000887
"RTN","GMRAPES1",1,0)
GMRAPES1 ;HIRMFO/RM,WAA-SELECT PATIENT ALLERGY TO EDIT ; 4/2/93
"RTN","GMRAPES1",2,0)
 ;;4.0;Adverse Reaction Tracking;**13**;Mar 29, 1996
"RTN","GMRAPES1",3,0)
ADAR ; ADD A NEW A/AR FOR THIS PATIENT
"RTN","GMRAPES1",4,0)
 S GMRAPA="" F X=0:0 S X=$O(^GMR(120.8,"B",DFN,X)) Q:X'>0  I $S('$D(^GMR(120.8,X,0)):0,$P(^(0),"^",2)=GMRAAR(0):1,1:0),$S('$D(^("ER")):1,1:'+^("ER")) S GMRAPA=X Q
"RTN","GMRAPES1",5,0)
 Q:GMRAPA>0
"RTN","GMRAPES1",6,0)
 I $D(XRTL) D T0^%ZOSV ; START RT
"RTN","GMRAPES1",7,0)
 D NOW^%DTC
"RTN","GMRAPES1",8,0)
 S GMRAAR(1)=+$E(%,1,12),DIC="^GMR(120.8,",DIC(0)="LQ",DLAYGO=120.8
"RTN","GMRAPES1",9,0)
 S DIC("DR")=".02////"_GMRAAR(0)_";1////^S X=GMRAAR;4////"_GMRAAR(1)_";5////"_DUZ_";15///0;17///U;3.1////"_$S($G(GMRAAR("O"))'="":GMRAAR("O"),1:"O"),X=DFN
"RTN","GMRAPES1",10,0)
 K DD,DO D FILE^DICN
"RTN","GMRAPES1",11,0)
 K DIC,DLAYGO S GMRAPA=+Y,GMRANEW=Y>0
"RTN","GMRAPES1",12,0)
 S GMRACAUS="RADIOLOGICAL/CONTRAST MEDIA",GMRADRCL=$O(^PS(50.605,"B","DX100",0))_";PS(50.605,"
"RTN","GMRAPES1",13,0)
 I $$RALLG^GMRARAD(GMRAPA) D:($$VERSION^XPDUTL("RA")'>4.5)&($$VERSION^XPDUTL("RA")'<4) ALLERGY^RAUTL3(DFN,"Y")  ; This call is being phased out in version 5 of RAD.
"RTN","GMRAPES1",14,0)
 K GMRACAUS,GMRADRCL
"RTN","GMRAPES1",15,0)
 I GMRAPA'>0 D  Q  ;Entry is not added
"RTN","GMRAPES1",16,0)
 .   I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV ; STOP RT IF EXITING HERE
"RTN","GMRAPES1",17,0)
 .   Q
"RTN","GMRAPES1",18,0)
 ;Start of New code to support Drug Classes
"RTN","GMRAPES1",19,0)
 ;This code section will auto stuff Ings and VA Drug Classes
"RTN","GMRAPES1",20,0)
 ;GMRAING() will have all the Ing for the selected reaction
"RTN","GMRAPES1",21,0)
 ;GMRADRCL() will have all the drug classes for the selected
"RTN","GMRAPES1",22,0)
 ;reaction.
"RTN","GMRAPES1",23,0)
 ;If the Reactant is a Drug Ingrediant
"RTN","GMRAPES1",24,0)
 I GMRAAR[50.416 S GMRAING(+GMRAAR)="" G STING
"RTN","GMRAPES1",25,0)
 ;If the Reacant is a Drug Class
"RTN","GMRAPES1",26,0)
 I GMRAAR[50.605 S GMRADRCL(+GMRAAR)=""
"RTN","GMRAPES1",27,0)
 ;If the Reactant is a entry in the GMR ALLERGY file
"RTN","GMRAPES1",28,0)
 I GMRAAR[120.82 D
"RTN","GMRAPES1",29,0)
 .S Y=0 F  S Y=$O(^GMRD(120.82,+GMRAAR,"ING",Y)) Q:Y'>0  I $D(^GMRD(120.82,+GMRAAR,"ING",Y,0)),+^(0)>0 S GMRAING(+^(0))=""
"RTN","GMRAPES1",30,0)
 .S Y=0 F  S Y=$O(^GMRD(120.82,+GMRAAR,"CLASS",Y)) Q:Y'>0  I $D(^GMRD(120.82,+GMRAAR,"CLASS",Y,0)),+^(0)>0 S GMRADRCL(+^(0))=""
"RTN","GMRAPES1",31,0)
 .Q
"RTN","GMRAPES1",32,0)
 I GMRAAR["PSDRUG" D
"RTN","GMRAPES1",33,0)
 .N PSODA
"RTN","GMRAPES1",34,0)
 .S PSODA=+GMRAAR K ^TMP("PSO",$J) D ^PSONGR F Y=0:0 S Y=$O(^TMP("PSO",$J,Y)) Q:Y'>0  S GMRAING(Y)=""
"RTN","GMRAPES1",35,0)
 .N GMRAX,GMRAY
"RTN","GMRAPES1",36,0)
 .S GMRAX=$P($G(^PSDRUG(+GMRAAR,"ND")),U,6) S:GMRAX>0 GMRADRCL(GMRAX)="" Q
"RTN","GMRAPES1",37,0)
 .S GMRAX=$P($G(^PSDRUG(+GMRAAR,0)),U,2) Q:GMRAX=""
"RTN","GMRAPES1",38,0)
 .S GMRAY=$O(^PS(50.605,"B",GMRAX,"")) S:GMRAY>0 GMRADRCL(GMRAY)=""
"RTN","GMRAPES1",39,0)
 .Q
"RTN","GMRAPES1",40,0)
 I GMRAAR["PSNDF" D
"RTN","GMRAPES1",41,0)
 .N PSNDA
"RTN","GMRAPES1",42,0)
 .S PSNDA=+GMRAAR K ^TMP("PSN",$J) D ^PSNNGR F Y=0:0 S Y=$O(^TMP("PSN",$J,Y)) Q:Y'>0  S GMRAING(Y)=""
"RTN","GMRAPES1",43,0)
 .; all classes for NDF entry returned in GMRADRCL
"RTN","GMRAPES1",44,0)
 .N CLASS
"RTN","GMRAPES1",45,0)
 .S CLASS=$$CLIST^PSNAPIS(+GMRAAR,.GMRADRCL)
"RTN","GMRAPES1",46,0)
 .Q
"RTN","GMRAPES1",47,0)
 K ^TMP("PSO",$J),^TMP("PSN",$J),PSOID,PSNID
"RTN","GMRAPES1",48,0)
STING ;Stuffing Drug Ing & VA Drug Classes into file 120.8
"RTN","GMRAPES1",49,0)
 I $D(GMRAING) D
"RTN","GMRAPES1",50,0)
 .S DA(1)=+GMRAPA,DIC="^GMR(120.8,"_+GMRAPA_",2,",DLAYGO=120.8,DIC(0)="L",DIC("P")="120.802PA"
"RTN","GMRAPES1",51,0)
 .F X=0:0 S X=$O(GMRAING(X)) Q:X'>0  I '$D(^GMR(120.8,GMRAPA,2,"B",X)) K DD,DO,DINUM D FILE^DICN
"RTN","GMRAPES1",52,0)
 .K DIC,DLAYGO
"RTN","GMRAPES1",53,0)
 .Q
"RTN","GMRAPES1",54,0)
 I $D(GMRADRCL) D
"RTN","GMRAPES1",55,0)
 .S DA(1)=+GMRAPA,DIC="^GMR(120.8,"_+GMRAPA_",3,",DIC(0)="L",DIC("P")="120.803PA"
"RTN","GMRAPES1",56,0)
 .F X=0:0 S X=$O(GMRADRCL(X)) Q:X'>0  I '$D(^GMR(120.8,GMRAPA,3,"B",X)) K DD,DO,DINUM D FILE^DICN
"RTN","GMRAPES1",57,0)
 .K DIC
"RTN","GMRAPES1",58,0)
 .Q
"RTN","GMRAPES1",59,0)
 I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV ; STOP RT IF EXITING HERE
"RTN","GMRAPES1",60,0)
 K GMRADRCL,GMRAING
"RTN","GMRAPES1",61,0)
 Q
"RTN","GMRARAD1")
0^7^B1211565
"RTN","GMRARAD1",1,0)
GMRARAD1 ;HIRMFO/WAA-RADIOLOGY ALLERGY INTERFACE ; 10/1/92
"RTN","GMRARAD1",2,0)
 ;;4.0;Adverse Reaction Tracking;**13**;Mar 29, 1996
"RTN","GMRARAD1",3,0)
PSCHK(GMRAVAR) ; This function will return a 1 (true) if the variable ptr
"RTN","GMRARAD1",4,0)
 ; passed in (GMRAVAR) has a RADIOLOGICAL CONTRAST/MEDIA VA Drug
"RTN","GMRARAD1",5,0)
 ; Class associated with it.
"RTN","GMRARAD1",6,0)
 N CHK,GMRAX,GMRAY
"RTN","GMRARAD1",7,0)
 S CHK=0,GMRAX=$P(GMRAVAR,";")
"RTN","GMRARAD1",8,0)
 I $P(GMRAVAR,";",2)="PSDRUG(" S:"^DX100^DX101^DX102^"[("^"_$P($G(^PSDRUG(GMRAX,0)),U,2)_"^") CHK=1
"RTN","GMRARAD1",9,0)
 I $P(GMRAVAR,";",2)=$P($$NDFREF^GMRAOR,U,2) D:$D(@($$NDFREF^GMRAOR_GMRAX_",0)"))
"RTN","GMRARAD1",10,0)
 .N CLASS,GMRACL
"RTN","GMRARAD1",11,0)
 .S CLASS=$$CLIST^PSNAPIS(GMRAX,.GMRACL) I $O(GMRACL(0)) D  Q:CHK
"RTN","GMRARAD1",12,0)
 ..S CLASS=0 F  S CLASS=$O(GMRACL(CLASS)) Q:'CLASS  D
"RTN","GMRARAD1",13,0)
 ...I "^DX100^DX101^DX102^"[("^"_$P(GMRACL(CLASS),U,2)_"^") S CHK=1
"RTN","GMRARAD1",14,0)
 ..Q
"RTN","GMRARAD1",15,0)
 .Q
"RTN","GMRARAD1",16,0)
 Q CHK
"VER")
8.0^21.0
**END**
**END**
