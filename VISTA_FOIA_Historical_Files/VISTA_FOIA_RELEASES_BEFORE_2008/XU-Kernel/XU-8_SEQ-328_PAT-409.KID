Released XU*8*409 SEQ #328
Extracted from mail message
**KIDS**:XU*8.0*409^

**INSTALL NAME**
XU*8.0*409
"BLD",924,0)
XU*8.0*409^KERNEL^0^3060201^y
"BLD",924,1,0)
^^2^2^3060112^
"BLD",924,1,1,0)
Please refer to the Description in the FORUM Patch Module for details.
"BLD",924,1,2,0)
XU*8*409   Fix when close execute changes IO.
"BLD",924,4,0)
^9.64PA^^
"BLD",924,6.3)
3
"BLD",924,"KRN",0)
^9.67PA^8989.52^19
"BLD",924,"KRN",.4,0)
.4
"BLD",924,"KRN",.401,0)
.401
"BLD",924,"KRN",.402,0)
.402
"BLD",924,"KRN",.403,0)
.403
"BLD",924,"KRN",.5,0)
.5
"BLD",924,"KRN",.84,0)
.84
"BLD",924,"KRN",3.6,0)
3.6
"BLD",924,"KRN",3.8,0)
3.8
"BLD",924,"KRN",9.2,0)
9.2
"BLD",924,"KRN",9.8,0)
9.8
"BLD",924,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",924,"KRN",9.8,"NM",1,0)
ZISC^^0^22818610
"BLD",924,"KRN",9.8,"NM",2,0)
ZTLOAD1^^0^23654226
"BLD",924,"KRN",9.8,"NM","B","ZISC",1)

"BLD",924,"KRN",9.8,"NM","B","ZTLOAD1",2)

"BLD",924,"KRN",19,0)
19
"BLD",924,"KRN",19.1,0)
19.1
"BLD",924,"KRN",101,0)
101
"BLD",924,"KRN",409.61,0)
409.61
"BLD",924,"KRN",771,0)
771
"BLD",924,"KRN",870,0)
870
"BLD",924,"KRN",8989.51,0)
8989.51
"BLD",924,"KRN",8989.52,0)
8989.52
"BLD",924,"KRN",8994,0)
8994
"BLD",924,"KRN","B",.4,.4)

"BLD",924,"KRN","B",.401,.401)

"BLD",924,"KRN","B",.402,.402)

"BLD",924,"KRN","B",.403,.403)

"BLD",924,"KRN","B",.5,.5)

"BLD",924,"KRN","B",.84,.84)

"BLD",924,"KRN","B",3.6,3.6)

"BLD",924,"KRN","B",3.8,3.8)

"BLD",924,"KRN","B",9.2,9.2)

"BLD",924,"KRN","B",9.8,9.8)

"BLD",924,"KRN","B",19,19)

"BLD",924,"KRN","B",19.1,19.1)

"BLD",924,"KRN","B",101,101)

"BLD",924,"KRN","B",409.61,409.61)

"BLD",924,"KRN","B",771,771)

"BLD",924,"KRN","B",870,870)

"BLD",924,"KRN","B",8989.51,8989.51)

"BLD",924,"KRN","B",8989.52,8989.52)

"BLD",924,"KRN","B",8994,8994)

"BLD",924,"QUES",0)
^9.62^^
"BLD",924,"REQB",0)
^9.611^1^1
"BLD",924,"REQB",1,0)
XU*8.0*363^2
"BLD",924,"REQB","B","XU*8.0*363",1)

"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^3051215^2970507^.5
"PKG",3,22,1,"PAH",1,0)
409^3060201
"PKG",3,22,1,"PAH",1,1,0)
^^2^2^3060201
"PKG",3,22,1,"PAH",1,1,1,0)
Please refer to the Description in the FORUM Patch Module for details.
"PKG",3,22,1,"PAH",1,1,2,0)
XU*8*409   Fix when close execute changes IO.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","ZISC")
0^1^B22818610
"RTN","ZISC",1,0)
%ZISC ;SFISC/GFT,AC,MUS - CLOSE LOGIC FOR DEVICES  ;01/14/2002  09:06
"RTN","ZISC",2,0)
 ;;8.0;KERNEL;**24,36,49,69,199,216,275,409**;JUL 10, 1995;Build 3
"RTN","ZISC",3,0)
C0 ;
"RTN","ZISC",4,0)
 N %,%E,%H,%ZISI,%ZISOS,%ZISX,%ZISV
"RTN","ZISC",5,0)
 ;Clear IO var we will use for reporting
"RTN","ZISC",6,0)
 K IO("ERROR"),IO("LASTERR"),IO("CLOSE")
"RTN","ZISC",7,0)
 ;Protect ourself from calls with incomplete setup.
"RTN","ZISC",8,0)
 S:$D(IO)[0 IO=$I S:'$D(IO(0)) IO(0)=$P
"RTN","ZISC",9,0)
 S U="^",%ZISOS=$G(^%ZOSF("OS")),%ZISV=$G(^("VOL"))
"RTN","ZISC",10,0)
 ;S %=$S(+$G(IOS):IOS,$L($G(ION)):ION,1:IO)
"RTN","ZISC",11,0)
 S %=$S($L($G(ION)):ION,1:IO) ;p409
"RTN","ZISC",12,0)
 I (%="")!(IO="") G SETIO:IO(0)]"",END
"RTN","ZISC",13,0)
 I $G(IOT)="RES" D RES G SETIO ;Handle a resource device
"RTN","ZISC",14,0)
 ;
"RTN","ZISC",15,0)
 ;Define subtype info if not already defined.
"RTN","ZISC",16,0)
 D SUBTYPE
"RTN","ZISC",17,0)
 ;
"RTN","ZISC",18,0)
 ;perform close execute
"RTN","ZISC",19,0)
 I $G(IOST(0))>0 D
"RTN","ZISC",20,0)
 . I $G(^%ZIS(2,+IOST(0),3))]"",$D(IO(1,IO)) D
"RTN","ZISC",21,0)
 . . U IO S:$X $X=1 D X3^ZISX:'$D(IO("T"))
"RTN","ZISC",22,0)
 ;
"RTN","ZISC",23,0)
 ;Incase the Close execute changed IO, Open IO("HOME") or NULL.
"RTN","ZISC",24,0)
 I '$L($G(IO)) D  Q
"RTN","ZISC",25,0)
 . S IOP=$S($L($G(IO("HOME"))):"`"_(+IO("HOME")),1:"NULL") D ^%ZIS
"RTN","ZISC",26,0)
 . Q
"RTN","ZISC",27,0)
 ;
"RTN","ZISC",28,0)
 ;Perform the following if the device is open.
"RTN","ZISC",29,0)
 I $D(IO(1,IO)) D
"RTN","ZISC",30,0)
 . I $G(IO("P"))["B" D  ;Return to normal intensity
"RTN","ZISC",31,0)
 . . S %=$P($G(^%ZIS(2,+IOST(0),7)),"^",3) I %]"" W @%
"RTN","ZISC",32,0)
 . I $G(IO("P"))["P" D  ;Return to default pitch
"RTN","ZISC",33,0)
 . . S %=$G(^%ZIS(2,+IOST(0),12.11)) I %]"" W @%
"RTN","ZISC",34,0)
 . ;
"RTN","ZISC",35,0)
 . W:$$FF @IOF ;Issue form feed at close
"RTN","ZISC",36,0)
 . I $$CLOSPP D X11^ZISX:'$D(IO("T")) K IO("S") ;Close printer port
"RTN","ZISC",37,0)
 . Q
"RTN","ZISC",38,0)
 ;
"RTN","ZISC",39,0)
 ;Don't use IOCPU as we now use IO(1,IO)
"RTN","ZISC",40,0)
 I (IO'=IO(0)!$D(IO("C"))),$D(IO(1,IO)) D
"RTN","ZISC",41,0)
 . U:$S($D(ZTQUEUED):0,'$L($G(IO(0))):0,$D(IO(1,IO(0)))#2:1,1:0) IO(0)
"RTN","ZISC",42,0)
 . C IO K IO(1,IO) S IO("CLOSE")=IO ;close device
"RTN","ZISC",43,0)
 ;
"RTN","ZISC",44,0)
 ;
"RTN","ZISC",45,0)
 I $D(IOT),IOT="CHAN",$D(IOS) D
"RTN","ZISC",46,0)
 .S %=$G(^%ZIS(1,+IOS,"GBL"))
"RTN","ZISC",47,0)
 .I %]"" L @("-^"_%) ;unlock global used to control access to network channels.
"RTN","ZISC",48,0)
 I $D(IO("SPOOL")) D CLOSE^%ZIS4 ;Special close for spool device
"RTN","ZISC",49,0)
 ;
"RTN","ZISC",50,0)
SETIO ;
"RTN","ZISC",51,0)
 ;See if old device has PCX code
"RTN","ZISC",52,0)
 I $G(IOS),$G(^%ZIS(1,+IOS,"PCX"))]"" S %ZISPCX=^("PCX")
"RTN","ZISC",53,0)
 ;Setup the IO(0) device, should be the home device
"RTN","ZISC",54,0)
 S IO=IO(0),(IOPAR,IOUPAR)="" K IO("T") D CIOS(IO(0))
"RTN","ZISC",55,0)
 I 'IOS S IOT="TRM" G END
"RTN","ZISC",56,0)
 S ION=$P(^%ZIS(1,IOS,0),"^",1),IOT=$G(^("TYPE")),IOST(0)=$S(IOT["TRM"&($D(^XUTL("XQ",$J,"IOST(0)"))):^("IOST(0)"),1:$G(^%ZIS(1,IOS,"SUBTYPE")))
"RTN","ZISC",57,0)
 I IOT["TRM",$D(^XUTL("XQ",$J,"IO")) D HOME^%ZIS G END
"RTN","ZISC",58,0)
 S %="Y"
"RTN","ZISC",59,0)
 I IOST(0),$D(^%ZIS(2,IOST(0),1)) S %=^(1),IOM=+%,IOF=$P(%,"^",2),IOSL=$P(%,"^",3),IOBS=$P(%,"^",4)
"RTN","ZISC",60,0)
 I $D(^%ZIS(1,IOS,91)) S %=^%ZIS(1,IOS,91) S:+% IOM=+% S:$P(%,"^",3) IOSL=$P(%,"^",3)
"RTN","ZISC",61,0)
 ;Don't know the subtype so set some defaults
"RTN","ZISC",62,0)
 I %="Y" S IOM=80,IOSL=24,IOF="#",IOST="C-OTHER",IOBS="$C(8)"
"RTN","ZISC",63,0)
S1 S:IOST(0) IOST=$P($G(^%ZIS(2,+IOST(0),0)),"^"),IOXY=$G(^("XY"))
"RTN","ZISC",64,0)
 I '$D(ZTQUEUED),'$D(IO("C")),IOT["TRM" D RM:$D(IO(1,IO))
"RTN","ZISC",65,0)
 ;With home device set, Do Post-close execute code of Device closed.
"RTN","ZISC",66,0)
END I '$D(IO("T")),$G(%ZISPCX)]"" S %Y=%ZISPCX D %Y^ZISX
"RTN","ZISC",67,0)
 ;See that any extra IO variables are cleaned up
"RTN","ZISC",68,0)
 K IO("P"),IO("DOC"),IO("HFSIO"),IO("SPOOL"),IOC,IONOFF
"RTN","ZISC",69,0)
 ;IOCPU should not be changed.
"RTN","ZISC",70,0)
 Q
"RTN","ZISC",71,0)
 ;
"RTN","ZISC",72,0)
SUBTYPE ;Find a subtype
"RTN","ZISC",73,0)
 N %S
"RTN","ZISC",74,0)
 S IOST=$G(IOST),IOST(0)=+$G(IOST(0))
"RTN","ZISC",75,0)
 I $L(IOST)&$L(IOST(0)) Q  ;Have a subtype
"RTN","ZISC",76,0)
 S %S=$G(^%ZIS(2,+IOST(0),0)) I $L(%S) S IOST=$P(%S,U) Q
"RTN","ZISC",77,0)
 I $L(IOST) S %S=$O(^%ZIS(2,"B",$G(IOST,"X"),0)) I %S>0 S IOST(0)=+%S Q
"RTN","ZISC",78,0)
 S IOST="",IOST(0)=0 D CIOS($I) Q:IOS'>0
"RTN","ZISC",79,0)
 S IOST(0)=$G(^%ZIS(1,+IOS,"SUBTYPE")),IOST=$P($G(^%ZIS(2,+IOST(0),0)),"^")
"RTN","ZISC",80,0)
 Q
"RTN","ZISC",81,0)
 ;
"RTN","ZISC",82,0)
CIOS(%I) ;Find a value for IOS (IEN into device file)
"RTN","ZISC",83,0)
 N %ZISVT
"RTN","ZISC",84,0)
 I $D(^XUTL("XQ",$J,"IOS")) S IOS=+^("IOS") Q
"RTN","ZISC",85,0)
 I $D(%ZISV) S %ZISVT=%I D VTLKUP^%ZIS S IOS=+%E
"RTN","ZISC",86,0)
 E  S IOS=+$O(^%ZIS(1,"C",%I,0))
"RTN","ZISC",87,0)
 Q:$G(IOS)>0
"RTN","ZISC",88,0)
 S %ZISVT=%I D VIRTUAL^%ZIS
"RTN","ZISC",89,0)
 I $D(%ZISVT) S %H=%E I %ZISVT]"",%H>0,$D(^%ZIS(1,%H,0)),$D(^("TYPE")),^("TYPE")="VTRM" S IOS=%H
"RTN","ZISC",90,0)
 Q
"RTN","ZISC",91,0)
 ;
"RTN","ZISC",92,0)
RM N X S X=+IOM X ^%ZOSF("RM")
"RTN","ZISC",93,0)
 Q
"RTN","ZISC",94,0)
 ;
"RTN","ZISC",95,0)
RES ;Close resource device.
"RTN","ZISC",96,0)
 Q:'$D(IO(1,IO))&'$D(^%ZISL(3.54,"AJ",$J))
"RTN","ZISC",97,0)
 N %ZISJOB,%X,%Y,%ZISD0,%ZISD1,%ZISRES,%ZISRL,%ZISY0,%ZTRTN,ZTSAVE,ZTIO
"RTN","ZISC",98,0)
 S %ZISJOB=$J
"RTN","ZISC",99,0)
 ;
"RTN","ZISC",100,0)
RES1 G RQ:'$D(IOS),RQ:'$D(^%ZIS(1,+IOS,1)) S %ZISRL=+$P(^(1),"^",10),%ZISRL=$S(%ZISRL:%ZISRL,1:1)
"RTN","ZISC",101,0)
 S %X=$O(^%ZISL(3.54,"B",IO,0)) G RQ:'%X
"RTN","ZISC",102,0)
 G RQ:'$D(^%ZISL(3.54,+%X,0)) S %ZISD0=+%X,%ZISY0=^(0)
"RTN","ZISC",103,0)
 S %X=$O(^%ZISL(3.54,"AJ",%ZISJOB,%ZISD0,0)) S %ZISD1=%X G RQ:'%X
"RTN","ZISC",104,0)
 S %Y=$G(^%ZISL(3.54,%ZISD0,1,+%ZISD1,0)) G RQ:$P(%Y,"^",3)'=%ZISJOB
"RTN","ZISC",105,0)
 D KILLRES(+%ZISD0,+%ZISD1)
"RTN","ZISC",106,0)
RQ K IO(1,IO)
"RTN","ZISC",107,0)
 Q
"RTN","ZISC",108,0)
 ;
"RTN","ZISC",109,0)
KILLRES(D0,D1) ;Kill one resource use
"RTN","ZISC",110,0)
 Q:(D0'>0)!(D1'>0)
"RTN","ZISC",111,0)
 N %X,%Y,%J,%ZISRL
"RTN","ZISC",112,0)
 L +^%ZISL(3.54,D0,0)
"RTN","ZISC",113,0)
 S %Y=$G(^%ZISL(3.54,D0,0)) G KRX:%Y=""
"RTN","ZISC",114,0)
 S %X=$G(^%ZISL(3.54,D0,1,D1,0)),%J=$P(%X,"^",3) S:%J="" %J=" "
"RTN","ZISC",115,0)
 K ^%ZISL(3.54,D0,1,D1,0),^%ZISL(3.54,D0,1,"B",D1,D1),^%ZISL(3.54,"AJ",%J,D0,D1)
"RTN","ZISC",116,0)
 S %X=$P(%Y,"^",2)+1,$P(^%ZISL(3.54,D0,0),"^",2)=%X
"RTN","ZISC",117,0)
 ;I '$D(^%ZISL(3.54,%ZISD0,1,0)) S ^(0)="^3.542A^^" G RQ
"RTN","ZISC",118,0)
 S %Y=$G(^%ZISL(3.54,D0,1,0)),%X=$P(%Y,"^",4),$P(^%ZISL(3.54,D0,1,0),"^",3,4)="^"_$S(%X>0:(%X-1),1:0)
"RTN","ZISC",119,0)
KRX L -^%ZISL(3.54,D0,0)
"RTN","ZISC",120,0)
 Q
"RTN","ZISC",121,0)
 ;
"RTN","ZISC",122,0)
DQCRES ;Tasked entry point to close resource device.
"RTN","ZISC",123,0)
 S IO=%ZISRES G RES1
"RTN","ZISC",124,0)
 ;
"RTN","ZISC",125,0)
FF() ;Issue form feed
"RTN","ZISC",126,0)
 I $E(IOST,1,2)'["C-",$D(IO(1,IO)),$G(IOT)="TRM"!($G(IOT)="SPL"),'$D(IO("T"))&$Y&'$D(IONOFF)&'$D(IO(1,IO,"NOFF")) Q 1
"RTN","ZISC",127,0)
 Q 0
"RTN","ZISC",128,0)
 ;
"RTN","ZISC",129,0)
CLOSPP() ;Close printer port
"RTN","ZISC",130,0)
 I $D(IO("S")),$D(^%ZIS(2,+IO("S"),11))&$D(IO(1,IO)) Q 1
"RTN","ZISC",131,0)
 Q 0
"RTN","ZTLOAD1")
0^2^B23654226
"RTN","ZTLOAD1",1,0)
%ZTLOAD1 ;SEA/RDS-TaskMan: P I: Queue ;02/02/2006
"RTN","ZTLOAD1",2,0)
 ;;8.0;KERNEL;**112,118,127,162,275,363,409**;Jul 10, 1995;Build 3
"RTN","ZTLOAD1",3,0)
 ;
"RTN","ZTLOAD1",4,0)
GET ;get task data
"RTN","ZTLOAD1",5,0)
 N X1,ZT,ZTC1,ZTA1,ZTA4,ZTA5,ZTINC,ZTGOT
"RTN","ZTLOAD1",6,0)
 K %ZTLOAD
"RTN","ZTLOAD1",7,0)
 I ("^"[$G(ZTRTN))!($L($G(ZTRTN),"^")>2) D REJECT^%ZTLOAD2("Bad Routine") G EXIT
"RTN","ZTLOAD1",8,0)
 S U="^" I ZTRTN'[U S ZTRTN=U_ZTRTN
"RTN","ZTLOAD1",9,0)
 S ZTC1=$G(DUZ)
"RTN","ZTLOAD1",10,0)
 ;Check Date/Time
"RTN","ZTLOAD1",11,0)
1 I $D(ZTDTH)[0 S ZTDTH=""
"RTN","ZTLOAD1",12,0)
 I ZTDTH?7N.".".N S ZTDTH=$$FMTH^%ZTLOAD7(ZTDTH)
"RTN","ZTLOAD1",13,0)
 I $P($G(XQY0),U,18) D RESTRCT^%ZTLOAD2
"RTN","ZTLOAD1",14,0)
 I ZTDTH'="@",ZTDTH'?1.5N1","1.5N D ASK^%ZTLOAD2 I ZTDTH'>0 D REJECT^%ZTLOAD2("Bad Date/Time") G EXIT
"RTN","ZTLOAD1",15,0)
 ;
"RTN","ZTLOAD1",16,0)
 S ZTA1="R",ZTA4="",ZTA5=""
"RTN","ZTLOAD1",17,0)
 I ZTRTN="ZTSK^XQ1" D OPTION^%ZTLOAD2 I ZTA1="" D REJECT^%ZTLOAD2("Bad Option") G EXIT
"RTN","ZTLOAD1",18,0)
 I ZTA1="R" D
"RTN","ZTLOAD1",19,0)
 . S ZTSAVE("XQY")="",ZTSAVE("XQY0")="",ZTA4=$G(XQY),ZTA5=$P($G(XQY0),U)
"RTN","ZTLOAD1",20,0)
 ;
"RTN","ZTLOAD1",21,0)
 S ZTC2=ZTC1 I ZTC2]"" S ZTC2=$P($G(^VA(200,ZTC2,0)),U)
"RTN","ZTLOAD1",22,0)
 D GETENV^%ZOSV S ZTC34P=Y
"RTN","ZTLOAD1",23,0)
 ;Description
"RTN","ZTLOAD1",24,0)
2 I $D(ZTDESC)[0 S ZTDESC="No Description (%ZTLOAD)"
"RTN","ZTLOAD1",25,0)
 ;
"RTN","ZTLOAD1",26,0)
 I $G(ZTKIL)]"" D ZTKIL^%ZTLOAD2
"RTN","ZTLOAD1",27,0)
 S:$G(ZTUCI)["," ZTUCI=$P(ZTUCI,",") S:$G(ZTCPU)["," ZTCPU=$P(ZTCPU,",",2)
"RTN","ZTLOAD1",28,0)
DEVICE ;get device data
"RTN","ZTLOAD1",29,0)
 I $D(ZTIO)#2,$G(ION)=$P(ZTIO,";"),$G(IOT)="SPL" D SPOOL^%ZTLOAD2
"RTN","ZTLOAD1",30,0)
 ;If no ZTIO, build from symbol table
"RTN","ZTLOAD1",31,0)
 I $D(ZTIO)[0 S ZTIO=$G(ION) I $L(ZTIO) D
"RTN","ZTLOAD1",32,0)
 . S:$G(IOST)]"" $P(ZTIO,";",2)=IOST
"RTN","ZTLOAD1",33,0)
 . I $G(IO("DOC"))]"" S ZTIO=ZTIO_";"_IO("DOC")
"RTN","ZTLOAD1",34,0)
 . E  I $G(IOM)]"" S ZTIO=ZTIO_";"_IOM I $G(IOSL)]"" S ZTIO=ZTIO_";"_IOSL
"RTN","ZTLOAD1",35,0)
 . Q
"RTN","ZTLOAD1",36,0)
 I $E(ZTIO,1)="`" S $P(ZTIO,";")=$P(^%ZIS(1,+$E(ZTIO,2,99),0),"^") ;Convert `IEN format
"RTN","ZTLOAD1",37,0)
 S ZTIO(1)=$S($G(ZTIO(1))'="D":"Q",1:"DIRECT")
"RTN","ZTLOAD1",38,0)
 I $L(ZTIO) D  ;Skip if no device
"RTN","ZTLOAD1",39,0)
 . ;IO("HFSIO") and IOPAR are how %ZIS reports the user selected
"RTN","ZTLOAD1",40,0)
 . ;to enter a file name for the HFS device.
"RTN","ZTLOAD1",41,0)
 . S:'$D(ZTIO("H")) ZTIO("H")=$G(IO("HFSIO"))
"RTN","ZTLOAD1",42,0)
 . S:'$D(ZTIO("P")) ZTIO("P")=$G(IOPAR)
"RTN","ZTLOAD1",43,0)
 . I $G(IO("P"))]"",ZTIO'[";/" S ZTIO=ZTIO_";/"_IO("P")
"RTN","ZTLOAD1",44,0)
 . I $$NOQ^%ZISUTL($P(ZTIO,";")) D BADDEV^%ZTLOAD2("Restricted Device") G EXIT
"RTN","ZTLOAD1",45,0)
 . I $E(ZTIO,1,9)="P-MESSAGE" S ZTSAVE("^TMP(""XM-MESS"",$J,")=""
"RTN","ZTLOAD1",46,0)
 ;
"RTN","ZTLOAD1",47,0)
 ;See that ^%ZTSK(-1) is set
"RTN","ZTLOAD1",48,0)
 I $D(^%ZTSK(-1))[0 S ^%ZTSK(-1)=$S($P($G(^%ZTSK(0)),U,3):$P(^(0),U,3),1:1000)
"RTN","ZTLOAD1",49,0)
RECORD ;build record
"RTN","ZTLOAD1",50,0)
 S ZTINC=$G(^%ZOSF("$INC"),1) ;Set to 1 if this system has $INCREMENT, otherwise 0.
"RTN","ZTLOAD1",51,0)
 S ZTGOT=0
"RTN","ZTLOAD1",52,0)
 I 'ZTINC D  ;For System that don't have $INC (GT.M, DTM, MSM)
"RTN","ZTLOAD1",53,0)
 . ;Find a free entry, Claim it and Lock it.
"RTN","ZTLOAD1",54,0)
 . L +^%ZTSK(-1):0 S ZTSK=^%ZTSK(-1) ;This is just a starting point
"RTN","ZTLOAD1",55,0)
 . F  S ZTSK=ZTSK+1 I '$D(^%ZTSK(ZTSK)) D  Q:ZTGOT
"RTN","ZTLOAD1",56,0)
 . . L +^%ZTSK(ZTSK):0 Q:'$T  ;Can we lock it
"RTN","ZTLOAD1",57,0)
 . . I $D(^%ZTSK(ZTSK)) L -^%ZTSK(ZTSK) ;Already claimed
"RTN","ZTLOAD1",58,0)
 . . S ^%ZTSK(ZTSK,.1)=0,^%ZTSK(-1)=ZTSK,ZTGOT=1 ;Claim it
"RTN","ZTLOAD1",59,0)
 . . Q
"RTN","ZTLOAD1",60,0)
 . L -^%ZTSK(-1) ;
"RTN","ZTLOAD1",61,0)
 . Q
"RTN","ZTLOAD1",62,0)
 I ZTINC D  ;For DSM and OpenM. Faster over network(DDP)
"RTN","ZTLOAD1",63,0)
 . S ZTSK=$INCREMENT(^%ZTSK(-1))
"RTN","ZTLOAD1",64,0)
 . L +^%ZTSK(ZTSK):0 S ZTGOT=$T
"RTN","ZTLOAD1",65,0)
 I 'ZTGOT!($D(^%ZTSK(ZTSK,0))) L -^%ZTSK(ZTSK) G RECORD
"RTN","ZTLOAD1",66,0)
 S ^%ZTSK(ZTSK,0)=ZTRTN_U_ZTC1_U_$G(ZTUCI)_U_$H_U_ZTDTH_U_ZTA1_U_ZTA4_U_ZTA5_U_ZTC2_U_$P(ZTC34P,U,1,2)_U_"ZTDESC"_U_$G(ZTCPU)_U_$G(ZTPRI)
"RTN","ZTLOAD1",67,0)
 S ^%ZTSK(ZTSK,.1)=0,^%ZTSK(ZTSK,.03)=ZTDESC
"RTN","ZTLOAD1",68,0)
 S ^%ZTSK(ZTSK,.2)=ZTIO_"^^^^"_ZTIO(1)_U_$G(ZTIO("H")) S:$D(ZTSYNC) $P(^%ZTSK(ZTSK,.2),U,7)=ZTSYNC
"RTN","ZTLOAD1",69,0)
 I $G(ZTIO("P"))]"" S ^%ZTSK(ZTSK,.25)=ZTIO("P")
"RTN","ZTLOAD1",70,0)
 ;
"RTN","ZTLOAD1",71,0)
 D ZTSAVE
"RTN","ZTLOAD1",72,0)
 ;
"RTN","ZTLOAD1",73,0)
SCHED ;schedule task and quit
"RTN","ZTLOAD1",74,0)
 S ZTSTAT=$S(ZTDTH'="@":1,1:"K")_"^"_$H,$P(ZTSTAT,U,8)=$G(ZTKIL)
"RTN","ZTLOAD1",75,0)
 S ^%ZTSK(ZTSK,.1)=ZTSTAT
"RTN","ZTLOAD1",76,0)
 I ZTDTH'="@" S ZT=$$H3(ZTDTH),^%ZTSK(ZTSK,.04)=ZT,^%ZTSCH(ZT,ZTSK)=""
"RTN","ZTLOAD1",77,0)
 L -^%ZTSK(ZTSK) S ZTSK("D")=ZTDTH
"RTN","ZTLOAD1",78,0)
EXIT I $E($G(ZTIO),1,9)="P-MESSAGE" K ^TMP("XM-MESS",$J) ;Clean up the Global
"RTN","ZTLOAD1",79,0)
 K X1,ZT,ZT1,ZTDTH,ZTKIL,ZTSAVE,ZTSTAT,ZTIO
"RTN","ZTLOAD1",80,0)
 ;K ZTA1,ZTA4,ZTC1,ZTCPU,ZTDESC,ZTDTH,ZTIO,ZTKIL,ZTNOGO,ZTPRI,ZTRTN,ZTSAVE,ZTSK,ZTUCI
"RTN","ZTLOAD1",81,0)
 Q
"RTN","ZTLOAD1",82,0)
 ;
"RTN","ZTLOAD1",83,0)
ZTSAVE ;save variables
"RTN","ZTLOAD1",84,0)
 N ZTIO
"RTN","ZTLOAD1",85,0)
 K %H,%T,ZTA1,ZTA4,ZTA5,ZTC1,ZTC2,ZTC34P,ZTCPU,ZTDESC,ZTIO,ZTNOGO,ZTPRI,ZTRTN,ZTUCI,ZTSYNC
"RTN","ZTLOAD1",86,0)
 S ZTSAVE("DUZ(")=""
"RTN","ZTLOAD1",87,0)
 I ^%ZOSF("OS")'["VAX DSM" S ZT1="" F  S ZT1=$O(ZTSAVE(ZT1)) Q:ZT1=""  D EVAL
"RTN","ZTLOAD1",88,0)
 I ^%ZOSF("OS")["VAX DSM" K X1 S ZT1="" F  S ZT1=$O(ZTSAVE(ZT1)) Q:ZT1=""  S:ZT1["*" X1(ZT1)="" I ZT1'["*" D EVAL
"RTN","ZTLOAD1",89,0)
 I ^%ZOSF("OS")["VAX DSM",$D(X1) S X="^%ZTSK(ZTSK,.3," D ORDER^%ZOSV
"RTN","ZTLOAD1",90,0)
 K ^%ZTSK(ZTSK,.3,"DUZ(","NEWCODE")
"RTN","ZTLOAD1",91,0)
 K ^%ZTSK(ZTSK,.3,"ZTSK"),^("ZTSAVE"),^("ZTDTH")
"RTN","ZTLOAD1",92,0)
 K ^%ZTSK(ZTSK,.3,"XQNOGO")
"RTN","ZTLOAD1",93,0)
 Q
"RTN","ZTLOAD1",94,0)
 ;
"RTN","ZTLOAD1",95,0)
EVAL ;ZTSAVE--evaluate expression
"RTN","ZTLOAD1",96,0)
 I ZT1="*" S X="^%ZTSK(ZTSK,.3," D DOLRO^%ZOSV Q
"RTN","ZTLOAD1",97,0)
 I ZT1["*",$P(ZT1,"*")'["(" S X="^%ZTSK(ZTSK,.3,",Y=ZT1 D ORDER^%ZOSV Q
"RTN","ZTLOAD1",98,0)
 I $S($E(ZT1)="""":1,+ZT1'=ZT1:0,1:ZT1]0),$D(ZTSAVE(ZT1))#2 S @("^%ZTSK(ZTSK,"_ZT1_")=ZTSAVE(ZT1)") Q
"RTN","ZTLOAD1",99,0)
 I $S(ZT1'["(":1,1:$E(ZT1,$L(ZT1))=")"),$S($D(@ZT1)#2:1,1:ZTSAVE(ZT1)]"") S ^%ZTSK(ZTSK,.3,ZT1)=$S(ZTSAVE(ZT1)]"":ZTSAVE(ZT1),1:@ZT1) Q
"RTN","ZTLOAD1",100,0)
 I ZT1["(" S %X=ZT1,%Y="^%ZTSK(ZTSK,.3,ZT1," D %XY^%RCR
"RTN","ZTLOAD1",101,0)
 Q
"RTN","ZTLOAD1",102,0)
 ;
"RTN","ZTLOAD1",103,0)
H3(%) ;Convert $H to seconds.
"RTN","ZTLOAD1",104,0)
 Q 86400*%+$P(%,",",2)
"RTN","ZTLOAD1",105,0)
H0(%) ;Covert from seconds to $H
"RTN","ZTLOAD1",106,0)
 Q (%\86400)_","_(%#86400)
"VER")
8.0^22.0
"BLD",924,6)
^328
**END**
**END**
