Released ECX*3*44 SEQ #44
Extracted from mail message
**KIDS**:ECX*3.0*44^

**INSTALL NAME**
ECX*3.0*44
"BLD",3702,0)
ECX*3.0*44^DSS EXTRACTS^0^3020628^y
"BLD",3702,1,0)
^^2^2^3020522^
"BLD",3702,1,1,0)
Please see the patch description in the NPM for complete details of this
"BLD",3702,1,2,0)
patch.
"BLD",3702,4,0)
^9.64PA^727.812^1
"BLD",3702,4,727.812,0)
727.812
"BLD",3702,4,727.812,2,0)
^9.641^727.812^1
"BLD",3702,4,727.812,2,727.812,0)
MENTAL HEALTH EXTRACT  (File-top level)
"BLD",3702,4,727.812,2,727.812,1,0)
^9.6411^32^1
"BLD",3702,4,727.812,2,727.812,1,32,0)
CLASS FOR ASI
"BLD",3702,4,727.812,222)
y^n^p^^^^n
"BLD",3702,4,"APDD",727.812,727.812)

"BLD",3702,4,"APDD",727.812,727.812,32)

"BLD",3702,4,"B",727.812,727.812)

"BLD",3702,"ABPKG")
n
"BLD",3702,"KRN",0)
^9.67PA^19^17
"BLD",3702,"KRN",.4,0)
.4
"BLD",3702,"KRN",.4,"NM",0)
^9.68A^^
"BLD",3702,"KRN",.401,0)
.401
"BLD",3702,"KRN",.402,0)
.402
"BLD",3702,"KRN",.403,0)
.403
"BLD",3702,"KRN",.5,0)
.5
"BLD",3702,"KRN",.84,0)
.84
"BLD",3702,"KRN",3.6,0)
3.6
"BLD",3702,"KRN",3.8,0)
3.8
"BLD",3702,"KRN",9.2,0)
9.2
"BLD",3702,"KRN",9.8,0)
9.8
"BLD",3702,"KRN",9.8,"NM",0)
^9.68A^5^3
"BLD",3702,"KRN",9.8,"NM",1,0)
ECXASUR^^0^B36233284
"BLD",3702,"KRN",9.8,"NM",4,0)
ECXAMTL^^0^B32177564
"BLD",3702,"KRN",9.8,"NM",5,0)
ECXAECQ^^0^B46660004
"BLD",3702,"KRN",9.8,"NM","B","ECXAECQ",5)

"BLD",3702,"KRN",9.8,"NM","B","ECXAMTL",4)

"BLD",3702,"KRN",9.8,"NM","B","ECXASUR",1)

"BLD",3702,"KRN",19,0)
19
"BLD",3702,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",3702,"KRN",19,"NM",1,0)
ECXDEFINE^^0
"BLD",3702,"KRN",19,"NM","B","ECXDEFINE",1)

"BLD",3702,"KRN",19.1,0)
19.1
"BLD",3702,"KRN",101,0)
101
"BLD",3702,"KRN",409.61,0)
409.61
"BLD",3702,"KRN",771,0)
771
"BLD",3702,"KRN",870,0)
870
"BLD",3702,"KRN",8994,0)
8994
"BLD",3702,"KRN","B",.4,.4)

"BLD",3702,"KRN","B",.401,.401)

"BLD",3702,"KRN","B",.402,.402)

"BLD",3702,"KRN","B",.403,.403)

"BLD",3702,"KRN","B",.5,.5)

"BLD",3702,"KRN","B",.84,.84)

"BLD",3702,"KRN","B",3.6,3.6)

"BLD",3702,"KRN","B",3.8,3.8)

"BLD",3702,"KRN","B",9.2,9.2)

"BLD",3702,"KRN","B",9.8,9.8)

"BLD",3702,"KRN","B",19,19)

"BLD",3702,"KRN","B",19.1,19.1)

"BLD",3702,"KRN","B",101,101)

"BLD",3702,"KRN","B",409.61,409.61)

"BLD",3702,"KRN","B",771,771)

"BLD",3702,"KRN","B",870,870)

"BLD",3702,"KRN","B",8994,8994)

"BLD",3702,"QUES",0)
^9.62^^
"BLD",3702,"REQB",0)
^9.611^2^2
"BLD",3702,"REQB",1,0)
ECX*3.0*39^2
"BLD",3702,"REQB",2,0)
ECX*3.0*43^2
"BLD",3702,"REQB","B","ECX*3.0*39",1)

"BLD",3702,"REQB","B","ECX*3.0*43",2)

"FIA",727.812)
MENTAL HEALTH EXTRACT
"FIA",727.812,0)
^ECX(727.812,
"FIA",727.812,0,0)
727.812
"FIA",727.812,0,1)
y^n^p^^^^n
"FIA",727.812,0,10)

"FIA",727.812,0,11)

"FIA",727.812,0,"RLRO")

"FIA",727.812,0,"VR")
3.0^ECX
"FIA",727.812,727.812)
1
"FIA",727.812,727.812,32)

"KRN",19,10158,-1)
0^1
"KRN",19,10158,0)
ECXDEFINE^Define Extract Schedule^Option has been disabled from use.^R^^ECXMGR^^^^^^DSS EXTRACTS
"KRN",19,10158,1,0)
^19.06^8^8^3020628^^^^
"KRN",19,10158,1,1,0)
This option allows the extract manager to create schedules for
"KRN",19,10158,1,2,0)
running the extracts. Each extract may be scheduled to run daily,
"KRN",19,10158,1,3,0)
weekly, or monthly. For daily and weekly extracts, the offset
"KRN",19,10158,1,4,0)
between the run time and the date range to be extracted may be
"KRN",19,10158,1,5,0)
selected. Monthly extracts extract data for the month previous to
"KRN",19,10158,1,6,0)
the run time. Once the extracts are scheduled through this option,
"KRN",19,10158,1,7,0)
careful attention must be used in trying to change this schedule.
"KRN",19,10158,1,8,0)
Changing this schedule can lead to missing data.
"KRN",19,10158,25)
EN^ECXDEFIN
"KRN",19,10158,"U")
DEFINE EXTRACT SCHEDULE
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^3010618^2980112^11714
"PKG",513,22,1,"PAH",1,0)
44^3020628
"PKG",513,22,1,"PAH",1,1,0)
^^2^2^3020628
"PKG",513,22,1,"PAH",1,1,1,0)
Please see the patch description in the NPM for complete details of this
"PKG",513,22,1,"PAH",1,1,2,0)
patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","ECXAECQ")
0^5^B46660004
"RTN","ECXAECQ",1,0)
ECXAECQ ;ALB/JAP - ECQ Extract Audit Report ; 5/22/02 3:47pm
"RTN","ECXAECQ",2,0)
 ;;3.0;DSS EXTRACTS;**8,33,35,43,44**;Dec 22, 1997
"RTN","ECXAECQ",3,0)
 ;
"RTN","ECXAECQ",4,0)
EN ;entry point for ECQ extract audit report
"RTN","ECXAECQ",5,0)
 N %X,%Y,X,Y,DIC,DA,DR,DIQ,DIR,ECXQV,ECXPOS,ECXYR,ECXMTH,ECXPFLG,ECXOPT,QFLG,Q2FLG
"RTN","ECXAECQ",6,0)
 S (ECXERR,QFLG)=0
"RTN","ECXAECQ",7,0)
 ;ecxaud=0 for 'extract' audit
"RTN","ECXAECQ",8,0)
 S ECXHEAD="ECQ",ECXAUD=0
"RTN","ECXAECQ",9,0)
 W !!,"Setup for ",ECXHEAD," Extract Audit Report --",!!
"RTN","ECXAECQ",10,0)
 ;select extract
"RTN","ECXAECQ",11,0)
 D AUDIT^ECXUTLA(ECXHEAD,.ECXERR,.ECXARRAY,ECXAUD)
"RTN","ECXAECQ",12,0)
 Q:ECXERR
"RTN","ECXAECQ",13,0)
 ;determine if version 3 and using EC National Procedure Codes for current fiscal year
"RTN","ECXAECQ",14,0)
 D FILE^DID(509850.6,,"VERSION","ARR","ERR")
"RTN","ECXAECQ",15,0)
 S ECXQV=$G(ARR("VERSION"))
"RTN","ECXAECQ",16,0)
 S ECXPOS=29
"RTN","ECXAECQ",17,0)
 I +ECXQV=3 D 
"RTN","ECXAECQ",18,0)
 .S ECXYR=$E($P(ECXARRAY("START"),",",2),4,5)
"RTN","ECXAECQ",19,0)
 .S ECXMTH=$E(ECXARRAY("START"),1,3)
"RTN","ECXAECQ",20,0)
 .I (ECXMTH="OCT")!(ECXMTH="NOV")!(ECXMTH="DEC") S ECXYR=ECXYR+1
"RTN","ECXAECQ",21,0)
 .S ECDA=0 F  S ECDA=$O(^ACK(509850.8,ECDA)) Q:'ECDA!QFLG  S ECDIV=0 F  S ECDIV=$O(^ACK(509850.8,ECDA,2,ECDIV)) Q:'ECDIV!QFLG  D
"RTN","ECXAECQ",22,0)
 ..S ECCL=0 F  S ECCL=$O(^ACK(509850.8,ECDA,2,ECDIV,2,"B",ECXYR,ECCL)) Q:'ECCL!QFLG  D
"RTN","ECXAECQ",23,0)
 ...S ECXPFLG=$P($G(^ACK(509850.8,ECDA,2,ECDIV,2,ECCL,0)),U,2)
"RTN","ECXAECQ",24,0)
 ...I ECXPFLG D  S QFLG=1
"RTN","ECXAECQ",25,0)
 ....W !!,"Your site has division(s) which are using EC National Procedure Codes for the",!,"fiscal year covering the time period of this extract."
"RTN","ECXAECQ",26,0)
 ....W !!,"You have the option to display either EC National Procedure Codes or CPT Codes",!,"for these division(s)."
"RTN","ECXAECQ",27,0)
 ....F  D  Q:Q2FLG
"RTN","ECXAECQ",28,0)
 .....S Q2FLG=1
"RTN","ECXAECQ",29,0)
 .....S DIR(0)="S^1:EC National Procedure Codes;2:CPT Codes",DIR("A")="Selection",DIR("B")=1 D ^DIR K DIR S ECXOPT=Y
"RTN","ECXAECQ",30,0)
 .....I X["^" W !!,"This is a required response" S Q2FLG=0
"RTN","ECXAECQ",31,0)
 ....I ECXOPT=1 S ECXPOS=12
"RTN","ECXAECQ",32,0)
 ;currently, quasar does not accommodate multi-divisional sites
"RTN","ECXAECQ",33,0)
 S ECXALL=0
"RTN","ECXAECQ",34,0)
 D ECQ^ECXDVSN1(.ECXDIV,ECXALL,.ECXERR)
"RTN","ECXAECQ",35,0)
 I ECXERR=1 D  Q
"RTN","ECXAECQ",36,0)
 .W !!,?5,"Try again later... exiting.",!
"RTN","ECXAECQ",37,0)
 .D AUDIT^ECXKILL
"RTN","ECXAECQ",38,0)
 ;determine output device and queue if requested
"RTN","ECXAECQ",39,0)
 W !
"RTN","ECXAECQ",40,0)
 S ECXPGM="PROCESS^ECXAECQ",ECXDESC="ECQ Extract Audit Report"
"RTN","ECXAECQ",41,0)
 S ECXSAVE("ECXHEAD")="",ECXSAVE("ECXALL")="",ECXSAVE("ECXDIV(")="",ECXSAVE("ECXARRAY(")="",ECXSAVE("ECXPOS")=""
"RTN","ECXAECQ",42,0)
 W !
"RTN","ECXAECQ",43,0)
 D DEVICE^ECXUTLA(ECXPGM,ECXDESC,.ECXSAVE)
"RTN","ECXAECQ",44,0)
 I ECXSAVE("POP")=1 D  Q
"RTN","ECXAECQ",45,0)
 .W !!,?5,"Try again later... exiting.",!
"RTN","ECXAECQ",46,0)
 .D AUDIT^ECXKILL
"RTN","ECXAECQ",47,0)
 I ECXSAVE("ZTSK")=0 D
"RTN","ECXAECQ",48,0)
 .K ECXSAVE,ECXPGM,ECXDESC
"RTN","ECXAECQ",49,0)
 .D PROCESS^ECXAECQ
"RTN","ECXAECQ",50,0)
 I IO'=IO(0) D ^%ZISC
"RTN","ECXAECQ",51,0)
 D HOME^%ZIS
"RTN","ECXAECQ",52,0)
 D AUDIT^ECXKILL
"RTN","ECXAECQ",53,0)
 Q
"RTN","ECXAECQ",54,0)
 ;
"RTN","ECXAECQ",55,0)
PROCESS ;process data in file #727.825
"RTN","ECXAECQ",56,0)
 N X,Y,W,ADIV,DATA,DATE,DIV,DIVACK,IEN,LOC,ECNIEN
"RTN","ECXAECQ",57,0)
 N UNIT,UNITN,VOL,PROC,PROCN,SDIV,QQFLG,CNT
"RTN","ECXAECQ",58,0)
 K ^TMP($J,"ECXAUD"),^TMP($J,"ECXPROC")
"RTN","ECXAECQ",59,0)
 S (CNT,QQFLG)=0,ECXEXT=ECXARRAY("EXTRACT"),ECXDEF=ECXARRAY("DEF")
"RTN","ECXAECQ",60,0)
 S X=ECXARRAY("START") D ^%DT S ECXSTART=Y,X=ECXARRAY("END")
"RTN","ECXAECQ",61,0)
 D ^%DT S ECXEND=Y
"RTN","ECXAECQ",62,0)
 ;get run date in external format
"RTN","ECXAECQ",63,0)
 D NOW^%DTC S Y=$E(%,1,12) D DD^%DT S ECXRUN=Y
"RTN","ECXAECQ",64,0)
 ;get the dss unit links for this division/site
"RTN","ECXAECQ",65,0)
 S DIV=0
"RTN","ECXAECQ",66,0)
 F  S DIV=$O(ECXDIV(DIV)) Q:DIV=""  D
"RTN","ECXAECQ",67,0)
 .S DIVACK=$P(ECXDIV(DIV),U,1),ECXLINK(DIV)=^ACK(509850.8,DIVACK,"DSS")
"RTN","ECXAECQ",68,0)
 ;get extract records in date range
"RTN","ECXAECQ",69,0)
 S IEN=""
"RTN","ECXAECQ",70,0)
 F  S IEN=$O(^ECX(727.825,"AC",ECXEXT,IEN)) Q:IEN=""  D  Q:QQFLG
"RTN","ECXAECQ",71,0)
 .S DATA=^ECX(727.825,IEN,0),DIV=$P(DATA,U,4),DATE=$P(DATA,U,9)
"RTN","ECXAECQ",72,0)
 .S ADIV=$P(^ECX(727.825,IEN,1),U,11) S:ADIV="" ADIV="UNK"
"RTN","ECXAECQ",73,0)
 .I +ADIV S X=^DG(40.8,ADIV,0),ADIV=$P(X,U)_" ("_$P(X,U,2)_")"
"RTN","ECXAECQ",74,0)
 .;convert free text date to fm internal format date
"RTN","ECXAECQ",75,0)
 .S $E(DATE,1,2)=$E(DATE,1,2)-17
"RTN","ECXAECQ",76,0)
 .Q:$L(DATE)<7  Q:(DATE<ECXSTART)  Q:(DATE>ECXEND)
"RTN","ECXAECQ",77,0)
 .;if location is among those selected, then tally event capture data
"RTN","ECXAECQ",78,0)
 .I $D(ECXDIV(DIV)) D  Q:QQFLG
"RTN","ECXAECQ",79,0)
 ..;any quasar site that doesn't have links to dss is identified by "xx"
"RTN","ECXAECQ",80,0)
 ..S UNIT=$P(DATA,U,10)
"RTN","ECXAECQ",81,0)
 ..S LOC=$S(UNIT=$P(ECXLINK(DIV),U,1):"A",UNIT=$P(ECXLINK(DIV),U,2):"S",1:"XX")
"RTN","ECXAECQ",82,0)
 ..;any invalid cpt code is identified as "xxxxx"
"RTN","ECXAECQ",83,0)
 ..S PROC=$E($P(DATA,U,ECXPOS),1,5),VOL=$P(DATA,U,13),PROCN=""
"RTN","ECXAECQ",84,0)
 ..I ECXPOS=12 D
"RTN","ECXAECQ",85,0)
 ...S ECNIEN=0,ECNIEN=$O(^EC(725,"D",PROC,ECNIEN)) Q:'ECNIEN
"RTN","ECXAECQ",86,0)
 ...S PROCN=$P($G(^EC(725,+ECNIEN,0)),U)
"RTN","ECXAECQ",87,0)
 ..I PROCN="" D
"RTN","ECXAECQ",88,0)
 ...S ECNIEN=0,ECNIEN=$O(^ICPT("B",PROC,ECNIEN)) Q:'ECNIEN
"RTN","ECXAECQ",89,0)
 ...S PROCN=$P($G(^ICPT(ECNIEN,0)),U,2)
"RTN","ECXAECQ",90,0)
 ..S PROC="A"_PROC S:VOL="" VOL=1
"RTN","ECXAECQ",91,0)
 ..S:PROCN="" PROCN="Unknown"
"RTN","ECXAECQ",92,0)
 ..I '$D(^TMP($J,"ECXAUD",DIV,ADIV,LOC,PROC)) S ^TMP($J,"ECXAUD",DIV,ADIV,LOC,PROC)=0_U_PROCN
"RTN","ECXAECQ",93,0)
 ..S $P(^(PROC),U,1)=$P(^TMP($J,"ECXAUD",DIV,ADIV,LOC,PROC),U,1)+VOL,CNT=CNT+1
"RTN","ECXAECQ",94,0)
 ..I $D(ZTQUEUED),(CNT>499),'(CNT#500),$$S^%ZTLOAD S QQFLG=1,ZTSTOP=1 K ZTREQ
"RTN","ECXAECQ",95,0)
 ;print the report
"RTN","ECXAECQ",96,0)
 D PRINT
"RTN","ECXAECQ",97,0)
 D AUDIT^ECXKILL
"RTN","ECXAECQ",98,0)
 Q
"RTN","ECXAECQ",99,0)
 ;
"RTN","ECXAECQ",100,0)
PRINT ;print quasar data by site and dss unit order
"RTN","ECXAECQ",101,0)
 N JJ,SS,LN,P,LOC,UNITN,PG,QFLG,GTOT,STOT,TOT,PROC,PROCN
"RTN","ECXAECQ",102,0)
 N DIR,DIRUT,DIV,DIVNM,DTOUT,DUOUT
"RTN","ECXAECQ",103,0)
 U IO
"RTN","ECXAECQ",104,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXAECQ",105,0)
 S (QFLG,PG)=0,$P(LN,"-",80)="",DIV=""
"RTN","ECXAECQ",106,0)
 F  S DIV=$O(ECXDIV(DIV)) Q:DIV=""  D  Q:QFLG
"RTN","ECXAECQ",107,0)
 .S DIVNM=$P(ECXDIV(DIV),U,2)_" ("_$P(ECXDIV(DIV),U,3)_")"
"RTN","ECXAECQ",108,0)
 .D HEADER Q:QFLG
"RTN","ECXAECQ",109,0)
 .S GTOT=0,STOT("A")=0,STOT("S")=0,STOT("XX")=0
"RTN","ECXAECQ",110,0)
 .I '$D(^TMP($J,"ECXAUD",DIV)) D  Q
"RTN","ECXAECQ",111,0)
 ..W !!,?5,"No data available for this QUASAR site.",!!
"RTN","ECXAECQ",112,0)
 .I $D(^TMP($J,"ECXAUD",DIV)) S ADIV="" D
"RTN","ECXAECQ",113,0)
 ..F  S ADIV=$O(^TMP($J,"ECXAUD",DIV,ADIV)) Q:ADIV=""  S LOC="" D  Q:QFLG
"RTN","ECXAECQ",114,0)
 ...F  S LOC=$O(^TMP($J,"ECXAUD",DIV,ADIV,LOC)) Q:LOC=""  D  Q:QFLG
"RTN","ECXAECQ",115,0)
 ....;write the unit name
"RTN","ECXAECQ",116,0)
 ....S UNITN=$S(LOC="A":"Audiology",LOC="S":"Speech Pathology",1:"Unknown"),PROC=""
"RTN","ECXAECQ",117,0)
 ....D:($Y+2>IOSL) HEADER Q:QFLG  W !,"Division: ("_ADIV_")",!?20,UNITN
"RTN","ECXAECQ",118,0)
 ....F  S PROC=$O(^TMP($J,"ECXAUD",DIV,ADIV,LOC,PROC)) Q:PROC=""  D  Q:QFLG
"RTN","ECXAECQ",119,0)
 .....S TOT=+^TMP($J,"ECXAUD",DIV,ADIV,LOC,PROC),PROCN=$P(^(PROC),U,2),P=$E(PROC,2,99)
"RTN","ECXAECQ",120,0)
 .....S SDIV(ADIV,LOC)=$G(SDIV(ADIV,LOC))+TOT
"RTN","ECXAECQ",121,0)
 .....S STOT(LOC)=STOT(LOC)+TOT,GTOT=GTOT+TOT
"RTN","ECXAECQ",122,0)
 .....D:($Y+3>IOSL) HEADER Q:QFLG  W !,?25,P,?35,$E(PROCN,1,30),?68,$$RJ^XLFSTR(TOT,5," ")
"RTN","ECXAECQ",123,0)
 ....;write the unit subtotal
"RTN","ECXAECQ",124,0)
 ....D:($Y+4>IOSL) HEADER Q:QFLG
"RTN","ECXAECQ",125,0)
 ....W !,?25,$E(LN,1,54)
"RTN","ECXAECQ",126,0)
 ....W !,"Volume for "_UNITN_":",?68,$$RJ^XLFSTR(+$G(SDIV(ADIV,LOC)),5," "),!!
"RTN","ECXAECQ",127,0)
 .;write the division grandtotal
"RTN","ECXAECQ",128,0)
 .D:($Y+5>IOSL) HEADER Q:QFLG
"RTN","ECXAECQ",129,0)
 .W !!,"Total Volume for Audiology:",?68,$$RJ^XLFSTR(STOT("A"),5," ")
"RTN","ECXAECQ",130,0)
 .W !,"Total Volume for Speech Pathology:",?68,$$RJ^XLFSTR(STOT("S"),5," ")
"RTN","ECXAECQ",131,0)
 .W !!,"Grand Total for Site "_DIVNM_":",?68,$$RJ^XLFSTR(GTOT,5," ")
"RTN","ECXAECQ",132,0)
 ;print the audit descriptive narrative
"RTN","ECXAECQ",133,0)
 I $E(IOST)'="C" D
"RTN","ECXAECQ",134,0)
 .W @IOF S PG=PG+1
"RTN","ECXAECQ",135,0)
 .W !,ECXARRAY("TYPE")_" ("_ECXHEAD_") Extract Audit Report"
"RTN","ECXAECQ",136,0)
 .W !,"DSS Extract Log #:       "_ECXEXT
"RTN","ECXAECQ",137,0)
 .W !,"Date Range of Audit:     "_ECXARRAY("START")_" to "_ECXARRAY("END")
"RTN","ECXAECQ",138,0)
 .W !,"Report Run Date/Time:    "_ECXRUN,?68,"Page: ",PG
"RTN","ECXAECQ",139,0)
 .W !!,LN,!!
"RTN","ECXAECQ",140,0)
 .S DIC="^ECX(727.1,",DA=ECXARRAY("DEF"),DR="1" D EN^DIQ
"RTN","ECXAECQ",141,0)
 I ($E(IOST)="C"),('QFLG) D
"RTN","ECXAECQ",142,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXAECQ",143,0)
 .S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXAECQ",144,0)
 Q
"RTN","ECXAECQ",145,0)
 ;
"RTN","ECXAECQ",146,0)
HEADER ;header and page control
"RTN","ECXAECQ",147,0)
 N JJ,SS
"RTN","ECXAECQ",148,0)
 I ($E(IOST)="C"),('QFLG) D
"RTN","ECXAECQ",149,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXAECQ",150,0)
 .I PG>0 S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXAECQ",151,0)
 Q:QFLG
"RTN","ECXAECQ",152,0)
 W:$Y!($E(IOST)="C") @IOF S PG=PG+1
"RTN","ECXAECQ",153,0)
 W !,ECXARRAY("TYPE")_" ("_ECXHEAD_") Extract Audit Report"
"RTN","ECXAECQ",154,0)
 W !,"DSS Extract Log #:    "_ECXARRAY("EXTRACT")
"RTN","ECXAECQ",155,0)
 W !,"Date Range of Audit:  "_ECXARRAY("START")_" to "_ECXARRAY("END")
"RTN","ECXAECQ",156,0)
 W !,"Report Run Date/Time: "_ECXRUN
"RTN","ECXAECQ",157,0)
 W !,"QUASAR Site:         "_$P(ECXDIV(DIV),U,2)_"("_$P(ECXDIV(DIV),U,3)_")",?68,"Page: "_PG
"RTN","ECXAECQ",158,0)
 W !!,"DSS Unit",?25,"Procedure",?68,"Volume"
"RTN","ECXAECQ",159,0)
 W !,LN
"RTN","ECXAECQ",160,0)
 Q
"RTN","ECXAMTL")
0^4^B32177564
"RTN","ECXAMTL",1,0)
ECXAMTL ;ALB/JAM - MTL Extract Audit Report; May 24, 1999
"RTN","ECXAMTL",2,0)
 ;;3.0;DSS EXTRACTS;**24,44**;May 24, 1999
"RTN","ECXAMTL",3,0)
EN ;entry point for MTL extract audit report
"RTN","ECXAMTL",4,0)
 N %X,%Y
"RTN","ECXAMTL",5,0)
 ;ecxaud=0 for 'extract' audit
"RTN","ECXAMTL",6,0)
 S ECXERR=0
"RTN","ECXAMTL",7,0)
 S ECXHEAD="MTL",ECXAUD=0
"RTN","ECXAMTL",8,0)
 W !!,"Setup for ",ECXHEAD," Extract Audit Report --",!!
"RTN","ECXAMTL",9,0)
 ;select extract
"RTN","ECXAMTL",10,0)
 D AUDIT^ECXUTLA(ECXHEAD,.ECXERR,.ECXARRAY,ECXAUD) I ECXERR D  Q
"RTN","ECXAMTL",11,0)
 . K ECXHEAD,ECXAUD,ECXERR
"RTN","ECXAMTL",12,0)
 ;get facility/division
"RTN","ECXAMTL",13,0)
 S ECXALL=1
"RTN","ECXAMTL",14,0)
 D MTL^ECXDVSN2(.ECXDIV,ECXALL,.ECXERR) I ECXERR D AUDIT^ECXKILL Q
"RTN","ECXAMTL",15,0)
 ;select output device and queue report if requested
"RTN","ECXAMTL",16,0)
 S ECXPGM="PROCESS^ECXAMTL",ECXDESC="MTL Extract Audit Report"
"RTN","ECXAMTL",17,0)
 S ECXSAVE("ECXHEAD")="",ECXSAVE("ECXALL")="",ECXSAVE("ECXDIV(")=""
"RTN","ECXAMTL",18,0)
 S ECXSAVE("ECXARRAY(")="" W !
"RTN","ECXAMTL",19,0)
 D DEVICE^ECXUTLA(ECXPGM,ECXDESC,.ECXSAVE)
"RTN","ECXAMTL",20,0)
 I ECXSAVE("POP")=1 D  Q
"RTN","ECXAMTL",21,0)
 . W !!,?5,"Try again later... exiting.",!
"RTN","ECXAMTL",22,0)
 . D AUDIT^ECXKILL
"RTN","ECXAMTL",23,0)
 I ECXSAVE("ZTSK")=0 D
"RTN","ECXAMTL",24,0)
 . K ECXSAVE,ECXPGM,ECXDESC
"RTN","ECXAMTL",25,0)
 . D PROCESS^ECXAMTL
"RTN","ECXAMTL",26,0)
 I IO'=IO(0) D ^%ZISC
"RTN","ECXAMTL",27,0)
 D HOME^%ZIS
"RTN","ECXAMTL",28,0)
 D AUDIT^ECXKILL
"RTN","ECXAMTL",29,0)
 Q
"RTN","ECXAMTL",30,0)
PROCESS ;process data in file #727.812
"RTN","ECXAMTL",31,0)
 N DAY,MTLDAT,MTLDAT1,SSN,NAME,EXN,IEN,ASI,SPC,TSTNAM,PROV,DATND,TSTSC
"RTN","ECXAMTL",32,0)
 N NODE
"RTN","ECXAMTL",33,0)
 K ^TMP($J,"ECXMTL") S EXN=ECXARRAY("EXTRACT")
"RTN","ECXAMTL",34,0)
 ;set start and end date in interal format
"RTN","ECXAMTL",35,0)
 S X=ECXARRAY("START") S %DT="" D ^%DT S ECXSTART=Y
"RTN","ECXAMTL",36,0)
 S X=ECXARRAY("END") D ^%DT S ECXEND=Y
"RTN","ECXAMTL",37,0)
 ;get run date in external format
"RTN","ECXAMTL",38,0)
 D NOW^%DTC S Y=$E(%,1,12) D DD^%DT S ECXRUN=Y
"RTN","ECXAMTL",39,0)
 ;get records for specified date range within extract
"RTN","ECXAMTL",40,0)
 S IEN=0 F  S IEN=$O(^ECX(727.812,"AC",EXN,IEN)) Q:'IEN  D
"RTN","ECXAMTL",41,0)
 . S MTLDAT=^ECX(727.812,IEN,0),MTLDAT1=$G(^ECX(727.812,IEN,1))
"RTN","ECXAMTL",42,0)
 . ;convert date to fileman internal format
"RTN","ECXAMTL",43,0)
 . S DAY=$P(MTLDAT,U,9),$E(DAY,1,2)=$E(DAY,1,2)-17 Q:$L(DAY)<7
"RTN","ECXAMTL",44,0)
 . I DAY<ECXSTART!(DAY>ECXEND) Q
"RTN","ECXAMTL",45,0)
 . S SSN=$P(MTLDAT,U,6),NAME=$P(MTLDAT,U,7),TSTNAM=$P(MTLDAT,U,21)
"RTN","ECXAMTL",46,0)
 . S PROV=$P(MTLDAT,U,18)
"RTN","ECXAMTL",47,0)
 . S:PROV'="" PROV=$$GET1^DIQ(200,$E(PROV,2,999),.01,"I")
"RTN","ECXAMTL",48,0)
 . S TSTSC=$P(MTLDAT,U,25),ASI=$P(MTLDAT1,U,5),SPC=$P(MTLDAT1,U,6)
"RTN","ECXAMTL",49,0)
 . ;determine next level for ^TMP($J,"ECXMTL",
"RTN","ECXAMTL",50,0)
 . Q:TSTNAM=""  S NODE=TSTNAM I TSTNAM'="ASI",TSTNAM'="GAF" S NODE="PI"
"RTN","ECXAMTL",51,0)
 . ;data to be stored at node in ^TMP($J,"ECXMTL,NODE
"RTN","ECXAMTL",52,0)
 . S DATND=$S(NODE="ASI":ASI_U_SPC,NODE="GAF":TSTSC_U_PROV,1:"")
"RTN","ECXAMTL",53,0)
 . ;store data in ^TMP($J,"ECXMTL",NODE
"RTN","ECXAMTL",54,0)
 . I NODE="PI" D  Q
"RTN","ECXAMTL",55,0)
 . . I '$D(^TMP($J,"ECXMTL",NODE,TSTNAM,NAME,SSN,DAY)) D
"RTN","ECXAMTL",56,0)
 . . . S ^TMP($J,"ECXMTL",NODE,TSTNAM,NAME,SSN,DAY)=DATND
"RTN","ECXAMTL",57,0)
 . . . S ^TMP($J,"ECXMTL",NODE,TSTNAM)=$G(^TMP($J,"ECXMTL",NODE,TSTNAM))+1
"RTN","ECXAMTL",58,0)
 . I '$D(^TMP($J,"ECXMTL",NODE,NAME,SSN,DAY)) D
"RTN","ECXAMTL",59,0)
 . . S ^TMP($J,"ECXMTL",NODE,NAME,SSN,DAY)=DATND
"RTN","ECXAMTL",60,0)
 D PRINT,AUDIT^ECXKILL
"RTN","ECXAMTL",61,0)
 Q
"RTN","ECXAMTL",62,0)
PRINT ;print the MTL audit report
"RTN","ECXAMTL",63,0)
 N ND,NAM,SSN,DAY,PITOT,GAFTOT,ASI,INSTOT,CNT,DIV,QFL,LN,I,CLS,SPC,ASISP
"RTN","ECXAMTL",64,0)
 N PG,ASITOT,ASISPTOT
"RTN","ECXAMTL",65,0)
 U IO
"RTN","ECXAMTL",66,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXAMTL",67,0)
 S (ASITOT,ASISPTOT,QFL,PG,CNT)=0,$P(LN,"-",74)="",DIV=$O(ECXDIV(""))
"RTN","ECXAMTL",68,0)
 ;
"RTN","ECXAMTL",69,0)
 ;- Added new class, ASI-MV, per MH patch YS*5.01*67
"RTN","ECXAMTL",70,0)
 F I=1:1:4,999 S (ASI(I),ASISP(I))=0 D
"RTN","ECXAMTL",71,0)
 . S ASI(I,0)=$S(I=1:"Full",I=2:"Lite",I=3:"Follow-up",I=4:"For ASI-MV",1:"Unspecified")
"RTN","ECXAMTL",72,0)
 . S ASISP(I,0)=$S(I=1:"Terminated",I=2:"Refused",I=3:"Unable",1:"Unspecified")
"RTN","ECXAMTL",73,0)
 S ASISP(0)=0,ASISP(0,0)="Completed" D HEADER
"RTN","ECXAMTL",74,0)
 S ND="" F  S ND=$O(^TMP($J,"ECXMTL",ND)) Q:ND=""  D  I QFL Q
"RTN","ECXAMTL",75,0)
 . S CNT=CNT+1 D H1 S NAM="" I ($Y+3)>IOSL D HEADER I QFL Q
"RTN","ECXAMTL",76,0)
 . I ND="PI" D  Q
"RTN","ECXAMTL",77,0)
 . . F  S NAM=$O(^TMP($J,"ECXMTL",ND,NAM)) Q:NAM=""  D  I QFL Q
"RTN","ECXAMTL",78,0)
 . . . S INSTOT=^TMP($J,"ECXMTL",ND,NAM)
"RTN","ECXAMTL",79,0)
 . . . D:($Y+3)>IOSL HEADER Q:QFL  W ?5,NAM,?32,$J(INSTOT,8),!
"RTN","ECXAMTL",80,0)
 . . . S PITOT=$G(PITOT)+INSTOT
"RTN","ECXAMTL",81,0)
 . . I ($Y+3)>IOSL D HEADER I QFL Q
"RTN","ECXAMTL",82,0)
 . . W ?5,LN,!,?5,"Total",?30,$J(PITOT,10),!
"RTN","ECXAMTL",83,0)
 . F  S NAM=$O(^TMP($J,"ECXMTL",ND,NAM)) Q:NAM=""  S SSN="" D  I QFL Q
"RTN","ECXAMTL",84,0)
 . .F  S SSN=$O(^TMP($J,"ECXMTL",ND,NAM,SSN)) Q:SSN=""  S DAY="" D  Q:QFL
"RTN","ECXAMTL",85,0)
 . . . F  S DAY=$O(^TMP($J,"ECXMTL",ND,NAM,SSN,DAY)) Q:DAY=""  D P1 Q:QFL
"RTN","ECXAMTL",86,0)
 . I QFL Q
"RTN","ECXAMTL",87,0)
 . ;print GAF total
"RTN","ECXAMTL",88,0)
 . I ND="GAF" D  Q
"RTN","ECXAMTL",89,0)
 . . D:($Y+3)>IOSL HEADER Q:QFL  W ?5,LN,!,?5,"Total: ",GAFTOT,!
"RTN","ECXAMTL",90,0)
 . ;print ASI totals
"RTN","ECXAMTL",91,0)
 . I ND="ASI" D  Q
"RTN","ECXAMTL",92,0)
 . . D:($Y+3)>IOSL HEADER Q:QFL  W ?5,LN,! S (CLS,SPC)=-1
"RTN","ECXAMTL",93,0)
 . . F I=1:1:5 D  Q:(CLS="")&(SPC="")  I QFL Q
"RTN","ECXAMTL",94,0)
 . . . I ($Y+3)>IOSL D HEADER I QFL Q
"RTN","ECXAMTL",95,0)
 . . . I CLS'="" S CLS=$O(ASI(CLS)) D:CLS'=""
"RTN","ECXAMTL",96,0)
 . . . . W ?29,$J(ASI(CLS),8)," ",ASI(CLS,0)
"RTN","ECXAMTL",97,0)
 . . . . S ASITOT=ASITOT+ASI(CLS)
"RTN","ECXAMTL",98,0)
 . . . I SPC'="" S SPC=$O(ASISP(SPC)) D:SPC'=""
"RTN","ECXAMTL",99,0)
 . . . . W ?50,$J(ASISP(SPC),8)," ",ASISP(SPC,0) D
"RTN","ECXAMTL",100,0)
 . . . . S ASISPTOT=ASISPTOT+ASISP(SPC)
"RTN","ECXAMTL",101,0)
 . . . W !
"RTN","ECXAMTL",102,0)
 . . Q:QFL  W ?5,LN,!,?27,$J(ASITOT,10),?48,$J(ASISPTOT,10)," ","Total"
"RTN","ECXAMTL",103,0)
 Q
"RTN","ECXAMTL",104,0)
P1 ;print ASI and GAF records
"RTN","ECXAMTL",105,0)
 N DATND,DATE
"RTN","ECXAMTL",106,0)
 S DATND=^TMP($J,"ECXMTL",ND,NAM,SSN,DAY)
"RTN","ECXAMTL",107,0)
 S DATE=$E(DAY,4,5)_"/"_$E(DAY,6,7)_"/"_($E(DAY)+17)_$E(DAY,2,3)
"RTN","ECXAMTL",108,0)
 D:($Y+3)>IOSL HEADER Q:QFL  W ?5,NAM,?14,$E(SSN,$L(SSN)-3,$L(SSN))
"RTN","ECXAMTL",109,0)
 I ND="ASI" D  Q
"RTN","ECXAMTL",110,0)
 . S CLS=$P(DATND,U),SPC=$P(DATND,U,2)
"RTN","ECXAMTL",111,0)
 . W ?21,DATE,?36,$S(CLS=1:"Full",CLS=2:"Lite",CLS=3:"F-up",CLS=4:"ASI-MV",1:""),?57,SPC,!
"RTN","ECXAMTL",112,0)
 . S:CLS="" CLS=999 S:SPC="" SPC=999 S:SPC="N" SPC=0
"RTN","ECXAMTL",113,0)
 . S ASI(CLS)=$G(ASI(CLS))+1,ASISP(SPC)=$G(ASISP(SPC))+1
"RTN","ECXAMTL",114,0)
 I ND="GAF" D  Q
"RTN","ECXAMTL",115,0)
 . W ?21,DATE,?36,$P(DATND,U,2),!
"RTN","ECXAMTL",116,0)
 . S GAFTOT=$G(GAFTOT)+1
"RTN","ECXAMTL",117,0)
 Q
"RTN","ECXAMTL",118,0)
HEADER ;header and page control
"RTN","ECXAMTL",119,0)
 N JJ,SS
"RTN","ECXAMTL",120,0)
 I $E(IOST)="C" D  I QFL Q
"RTN","ECXAMTL",121,0)
 . S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXAMTL",122,0)
 . I PG S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFL=1
"RTN","ECXAMTL",123,0)
 W:PG!($E(IOST)="C") @IOF S PG=PG+1
"RTN","ECXAMTL",124,0)
 W !,ECXARRAY("TYPE")_" ("_ECXHEAD_") Extract Audit Report"
"RTN","ECXAMTL",125,0)
 W !,"DSS Extract Log #:    "_ECXARRAY("EXTRACT")
"RTN","ECXAMTL",126,0)
 W !,"Date Range of Audit:  "_ECXARRAY("START")_" to "_ECXARRAY("END")
"RTN","ECXAMTL",127,0)
 W !,"Report Run Date/Time: "_ECXRUN
"RTN","ECXAMTL",128,0)
 I $P(ECXDIV(DIV),U)="" D
"RTN","ECXAMTL",129,0)
 . S $P(ECXDIV(DIV),U)=$P(ECXDIV(DIV),U,3)
"RTN","ECXAMTL",130,0)
 . I $P(ECXDIV(DIV),U)="" S $P(ECXDIV(DIV),U)="Unknown"
"RTN","ECXAMTL",131,0)
 W !,"Facility:             "_$P(ECXDIV(DIV),U)
"RTN","ECXAMTL",132,0)
 W " ("_$P(ECXDIV(DIV),U,4)_")",?68,"Page: "_PG
"RTN","ECXAMTL",133,0)
H1 I $G(ND)'="" D
"RTN","ECXAMTL",134,0)
 . W !!,CNT,".",?5
"RTN","ECXAMTL",135,0)
 . I ND="PI" W "Psych Instruments segment",!! Q
"RTN","ECXAMTL",136,0)
 . W ND," segment",!!
"RTN","ECXAMTL",137,0)
 . W ?5,"Name",?14,"SSN",?21
"RTN","ECXAMTL",138,0)
 . I ND="ASI" W "Interview",?36,"Class",?54,"Special"
"RTN","ECXAMTL",139,0)
 . I ND="GAF" W "Date",?36,"Clinician"
"RTN","ECXAMTL",140,0)
 . W !,?5,LN,!
"RTN","ECXAMTL",141,0)
 Q
"RTN","ECXASUR")
0^1^B36233284
"RTN","ECXASUR",1,0)
ECXASUR ;ALB/JAP - SUR Extract Audit Report ; 4/26/02 11:16am
"RTN","ECXASUR",2,0)
 ;;3.0;DSS EXTRACTS;**8,33,44**;Dec 22, 1997
"RTN","ECXASUR",3,0)
 ;
"RTN","ECXASUR",4,0)
EN ;entry point for SUR extract audit report
"RTN","ECXASUR",5,0)
 ;select extract
"RTN","ECXASUR",6,0)
 N %X,%Y,X,Y,DIC,DA,DR,DIQ,DIR,SITES,ECX
"RTN","ECXASUR",7,0)
 ;ecxaud=0 for 'extract' audit
"RTN","ECXASUR",8,0)
 S ECXERR=0
"RTN","ECXASUR",9,0)
 S ECXHEAD="SUR",ECXAUD=0
"RTN","ECXASUR",10,0)
 W !!,"Setup for ",ECXHEAD," Extract Audit Report --",!!
"RTN","ECXASUR",11,0)
 D AUDIT^ECXUTLA(ECXHEAD,.ECXERR,.ECXARRAY,ECXAUD)
"RTN","ECXASUR",12,0)
 Q:ECXERR
"RTN","ECXASUR",13,0)
 ;determine if facility is multidivisional
"RTN","ECXASUR",14,0)
 K ECX D FILE^DID(133,,"ENTRIES","ECX") S SITES=ECX("ENTRIES") K ECX
"RTN","ECXASUR",15,0)
 I SITES=1 S ECXALL=1
"RTN","ECXASUR",16,0)
 I SITES>1 D
"RTN","ECXASUR",17,0)
 .W !!
"RTN","ECXASUR",18,0)
 .S DIR(0)="Y",DIR("A")="Do you want the "_ECXHEAD_" extract audit report for all divisions"
"RTN","ECXASUR",19,0)
 .S DIR("B")="NO" D ^DIR K DIR
"RTN","ECXASUR",20,0)
 .I $G(DIRUT) S ECXERR=1 Q
"RTN","ECXASUR",21,0)
 .;if y=0 i.e., 'no', then ecxall=0 i.e., 'selected'
"RTN","ECXASUR",22,0)
 .S ECXALL=Y
"RTN","ECXASUR",23,0)
 I ECXERR=1 D  Q
"RTN","ECXASUR",24,0)
 .W !!,?5,"Try again later... exiting.",!
"RTN","ECXASUR",25,0)
 .D AUDIT^ECXKILL
"RTN","ECXASUR",26,0)
 ;select divisions/sites; all divisions if ecxall=1
"RTN","ECXASUR",27,0)
 W !
"RTN","ECXASUR",28,0)
 S ECXSTART=ECXARRAY("START"),ECXEND=ECXARRAY("END")
"RTN","ECXASUR",29,0)
 D SUR^ECXDVSN2(.ECXDIV,ECXALL,.ECXERR)
"RTN","ECXASUR",30,0)
 I ECXERR=1 D  Q
"RTN","ECXASUR",31,0)
 .W !!,?5,"Try again later... exiting.",!
"RTN","ECXASUR",32,0)
 .D AUDIT^ECXKILL
"RTN","ECXASUR",33,0)
 ;determine output device and queue if requested
"RTN","ECXASUR",34,0)
 S ECXPGM="PROCESS^ECXASUR",ECXDESC="SUR Extract Audit Report"
"RTN","ECXASUR",35,0)
 S ECXSAVE("ECXHEAD")="",ECXSAVE("ECXALL")="",ECXSAVE("ECXDIV(")="",ECXSAVE("ECXARRAY(")=""
"RTN","ECXASUR",36,0)
 W !
"RTN","ECXASUR",37,0)
 D DEVICE^ECXUTLA(ECXPGM,ECXDESC,.ECXSAVE)
"RTN","ECXASUR",38,0)
 I ECXSAVE("POP")=1 D  Q
"RTN","ECXASUR",39,0)
 .W !!,?5,"Try again later... exiting.",!
"RTN","ECXASUR",40,0)
 .D AUDIT^ECXKILL
"RTN","ECXASUR",41,0)
 I ECXSAVE("ZTSK")=0 D
"RTN","ECXASUR",42,0)
 .K ECXSAVE,ECXPGM,ECXDESC
"RTN","ECXASUR",43,0)
 .D PROCESS^ECXASUR
"RTN","ECXASUR",44,0)
 I IO'=IO(0) D ^%ZISC
"RTN","ECXASUR",45,0)
 D HOME^%ZIS
"RTN","ECXASUR",46,0)
 D AUDIT^ECXKILL
"RTN","ECXASUR",47,0)
 Q
"RTN","ECXASUR",48,0)
 ;
"RTN","ECXASUR",49,0)
PROCESS ;process data in file #727.811
"RTN","ECXASUR",50,0)
 N X,Y,JJ,DIV,IEN,DATA,DATE,CASE,CASES,OR,LOC,PROC,PROCN,PSI,CAN,CPT,DIC,QQFLG,CNT
"RTN","ECXASUR",51,0)
 K ^TMP($J,"ECXAUD"),^TMP($J,"ECXS")
"RTN","ECXASUR",52,0)
 S (CNT,QQFLG)=0
"RTN","ECXASUR",53,0)
 S ECXEXT=ECXARRAY("EXTRACT"),ECXDEF=ECXARRAY("DEF")
"RTN","ECXASUR",54,0)
 S X=ECXARRAY("START") D ^%DT S ECXSTART=Y S X=ECXARRAY("END") D ^%DT S ECXEND=Y
"RTN","ECXASUR",55,0)
 ;get run date in external format
"RTN","ECXASUR",56,0)
 D NOW^%DTC S Y=$E(%,1,12) D DD^%DT S ECXRUN=Y
"RTN","ECXASUR",57,0)
 ;get records within date range and surgery site(s)
"RTN","ECXASUR",58,0)
 S IEN="" F  S IEN=$O(^ECX(727.811,"AC",ECXEXT,IEN)) Q:IEN=""  D  Q:QQFLG
"RTN","ECXASUR",59,0)
 .S DATA=^ECX(727.811,IEN,0),DATA1=^(1),DATE=$P(DATA,U,9)
"RTN","ECXASUR",60,0)
 .S DIV=$P(DATA,U,4)
"RTN","ECXASUR",61,0)
 .;convert free text date to fm internal format date
"RTN","ECXASUR",62,0)
 .S $E(DATE,1,2)=$E(DATE,1,2)-17
"RTN","ECXASUR",63,0)
 .Q:$L(DATE)<7  Q:(DATE<ECXSTART)  Q:(DATE>ECXEND)
"RTN","ECXASUR",64,0)
 .Q:'$D(ECXDIV(DIV))
"RTN","ECXASUR",65,0)
 .Q:$P(DATA,U,17)="I"
"RTN","ECXASUR",66,0)
 .S CASE=$P(DATA,U,10),OR=$P(DATA,U,12),PSI=$P(DATA,U,17)
"RTN","ECXASUR",67,0)
 .S CAN=$P(DATA,U,28)
"RTN","ECXASUR",68,0)
 .S PROC=$E($P(DATA1,U,11),1,5)
"RTN","ECXASUR",69,0)
 .Q:(PROC="")&(PSI="I")
"RTN","ECXASUR",70,0)
 .S (CPT,PROCN)="" I PROC]"" D
"RTN","ECXASUR",71,0)
 ..;from cpt code get procedure name; variable cpt should be same as variable proc
"RTN","ECXASUR",72,0)
 ..K Y S DIC="^ICPT(",DIC(0)="XZ",X=PROC D ^DIC
"RTN","ECXASUR",73,0)
 ..S CPT=$P($G(Y(0)),U,1),PROCN=$P($G(Y(0)),U,2)
"RTN","ECXASUR",74,0)
 .S:CPT="" CPT="Unknown" S:PROCN="" PROCN="Unknown" S CPT="A"_CPT
"RTN","ECXASUR",75,0)
 .S LOC=$S(OR="":2,1:1)
"RTN","ECXASUR",76,0)
 .I CAN'="" S LOC=3
"RTN","ECXASUR",77,0)
 .;tally procedures by location and division
"RTN","ECXASUR",78,0)
 .I '$D(^TMP($J,"ECXAUD",DIV,LOC,CPT)) S ^TMP($J,"ECXAUD",DIV,LOC,CPT)=0_U_PROCN
"RTN","ECXASUR",79,0)
 .S $P(^(CPT),U,1)=$P(^TMP($J,"ECXAUD",DIV,LOC,CPT),U,1)+1,CNT=CNT+1
"RTN","ECXASUR",80,0)
 .I $D(ZTQUEUED),(CNT>499),'(CNT#500),$$S^%ZTLOAD S QQFLG=1,ZTSTOP=1 K ZTREQ Q
"RTN","ECXASUR",81,0)
 .I '$D(^TMP($J,"ECXS",DIV,LOC,CASE)) S ^TMP($J,"ECXS",DIV,LOC,CASE)=""
"RTN","ECXASUR",82,0)
 ;total cases for each division and location
"RTN","ECXASUR",83,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXASUR",84,0)
 S DIV="" F  S DIV=$O(^TMP($J,"ECXS",DIV)) Q:DIV=""  F LOC=1:1:3 S CASES(DIV,LOC)=0,CASE="" D
"RTN","ECXASUR",85,0)
 .F  S CASE=$O(^TMP($J,"ECXS",DIV,LOC,CASE)) Q:CASE=""  S CASES(DIV,LOC)=CASES(DIV,LOC)+1
"RTN","ECXASUR",86,0)
 K ^TMP($J,"ECXS")
"RTN","ECXASUR",87,0)
 ;print the report
"RTN","ECXASUR",88,0)
 D PRINT
"RTN","ECXASUR",89,0)
 D AUDIT^ECXKILL
"RTN","ECXASUR",90,0)
 Q
"RTN","ECXASUR",91,0)
 ;
"RTN","ECXASUR",92,0)
PRINT ;print the SUR audit report by location and division
"RTN","ECXASUR",93,0)
 N LN,PG,QFLG,TOT,GTOT,DIVNM,CPT,CPTN,PROCN,LOCNM,LOCNMC,SS,DIR,DR,DIRUT,DTOUT,DUOUT
"RTN","ECXASUR",94,0)
 U IO
"RTN","ECXASUR",95,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ Q
"RTN","ECXASUR",96,0)
 S (QFLG,PG)=0,$P(LN,"-",80)="",DIV=""
"RTN","ECXASUR",97,0)
 F  S DIV=$O(ECXDIV(DIV)) Q:DIV=""  F LOC=1:1:3 D  Q:QFLG
"RTN","ECXASUR",98,0)
 .S DIVNM=$P(ECXDIV(DIV),U,2)_" ("_DIV_")",GTOT(LOC)=0
"RTN","ECXASUR",99,0)
 .S LOCNM=$S(LOC=1:"O.R. Surgical Procedures",LOC=2:"Non-O.R. Surgical Procedures",1:"Cancelled/Aborted Procedures")
"RTN","ECXASUR",100,0)
 .D HEADER
"RTN","ECXASUR",101,0)
 .I '$D(^TMP($J,"ECXAUD",DIV,LOC)) D
"RTN","ECXASUR",102,0)
 ..W !!,?3,"No data available for "_LOCNM_".",!!
"RTN","ECXASUR",103,0)
 .I $D(^TMP($J,"ECXAUD",DIV,LOC)) S CPT="" F  S CPT=$O(^TMP($J,"ECXAUD",DIV,LOC,CPT)) Q:CPT=""  S TOT(LOC)=$P(^(CPT),U,1),PROCN=$P(^(CPT),U,2),CPTN=$E(CPT,2,99) D  Q:QFLG
"RTN","ECXASUR",104,0)
 ..S GTOT(LOC)=GTOT(LOC)+TOT(LOC)
"RTN","ECXASUR",105,0)
 ..;write procedure and total
"RTN","ECXASUR",106,0)
 ..D:($Y+3>IOSL) HEADER Q:QFLG  W !,?3,CPTN,?14,$E(PROCN,1,40),?63,$$RJ^XLFSTR(TOT(LOC),5," ")
"RTN","ECXASUR",107,0)
 .;write the division totals
"RTN","ECXASUR",108,0)
 .D:($Y+3>IOSL) HEADER Q:QFLG  W !,?3,$E(LN,1,65)
"RTN","ECXASUR",109,0)
 .D:($Y+3>IOSL) HEADER Q:QFLG  W !!,"For Division "_DIVNM_"--"
"RTN","ECXASUR",110,0)
 .D:($Y+3>IOSL) HEADER Q:QFLG  W !,?3,"Total "_LOCNM_":",?63,$$RJ^XLFSTR(GTOT(LOC),5," ")
"RTN","ECXASUR",111,0)
 .S LOCNMC=$P(LOCNM,"Pro",1) S:'$D(CASES(DIV,LOC)) CASES(DIV,LOC)=0
"RTN","ECXASUR",112,0)
 .D:($Y+3>IOSL) HEADER Q:QFLG  W !,?3,"Total "_LOCNMC_"Cases:",?63,$$RJ^XLFSTR(CASES(DIV,LOC),5," ")
"RTN","ECXASUR",113,0)
 ;print the audit descriptive narrative
"RTN","ECXASUR",114,0)
 I $E(IOST)'="C" D
"RTN","ECXASUR",115,0)
 .W @IOF S PG=PG+1
"RTN","ECXASUR",116,0)
 .W !,ECXARRAY("TYPE")_" ("_ECXHEAD_") Extract Audit Report"
"RTN","ECXASUR",117,0)
 .W !,"DSS Extract Log #:    "_ECXEXT
"RTN","ECXASUR",118,0)
 .W !,"Date Range of Audit:  "_ECXARRAY("START")_" to "_ECXARRAY("END")
"RTN","ECXASUR",119,0)
 .W !,"Report Run Date/Time: "_ECXRUN,?68,"Page: ",PG
"RTN","ECXASUR",120,0)
 .W !!,LN,!!
"RTN","ECXASUR",121,0)
 .S DIC="^ECX(727.1,",DA=ECXARRAY("DEF"),DR="1" D EN^DIQ
"RTN","ECXASUR",122,0)
 I $E(IOST)="C",'QFLG D
"RTN","ECXASUR",123,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXASUR",124,0)
 .S DIR(0)="E" W ! D ^DIR K DIR
"RTN","ECXASUR",125,0)
 Q
"RTN","ECXASUR",126,0)
 ;
"RTN","ECXASUR",127,0)
HEADER ;header and page control
"RTN","ECXASUR",128,0)
 N JJ,SS
"RTN","ECXASUR",129,0)
 I $E(IOST)="C" D
"RTN","ECXASUR",130,0)
 .S SS=22-$Y F JJ=1:1:SS W !
"RTN","ECXASUR",131,0)
 .I PG>0 S DIR(0)="E" W ! D ^DIR K DIR S:'Y QFLG=1
"RTN","ECXASUR",132,0)
 Q:QFLG
"RTN","ECXASUR",133,0)
 W:$Y!($E(IOST)="C") @IOF S PG=PG+1
"RTN","ECXASUR",134,0)
 W !,ECXARRAY("TYPE")_" ("_ECXHEAD_") Extract Audit Report"
"RTN","ECXASUR",135,0)
 W !,"DSS Extract Log #:    "_ECXARRAY("EXTRACT")
"RTN","ECXASUR",136,0)
 W !,"Date Range of Audit:  "_ECXARRAY("START")_" to "_ECXARRAY("END")
"RTN","ECXASUR",137,0)
 W !,"Report Run Date/Time: "_ECXRUN
"RTN","ECXASUR",138,0)
 W !,"Surgery Division:     "_$P(ECXDIV(DIV),U,2)_" ("_DIV_")",?63,"Page: "_PG
"RTN","ECXASUR",139,0)
 W !!,LOCNM
"RTN","ECXASUR",140,0)
 W !,?3,"CPT Code",?14,"Procedure",?63,"# of Procedures"
"RTN","ECXASUR",141,0)
 W !,LN,!
"RTN","ECXASUR",142,0)
 Q
"VER")
8.0^22.0
"^DD",727.812,727.812,32,0)
CLASS FOR ASI^S^1:FULL;2:LITE;3:FOLLOW-UP;4:ASI-MV;^1;5^Q
"^DD",727.812,727.812,32,21,0)
^^5^5^3020522^
"^DD",727.812,727.812,32,21,1,0)
Classification for ASI data only.
"^DD",727.812,727.812,32,21,2,0)
1 = FULL
"^DD",727.812,727.812,32,21,3,0)
2 = LITE
"^DD",727.812,727.812,32,21,4,0)
3 = FOLLOW-UP
"^DD",727.812,727.812,32,21,5,0)
4 = ASI-MV
"^DD",727.812,727.812,32,23,0)
^^1^1^3020522^^^
"^DD",727.812,727.812,32,23,1,0)
CLASS field (#.04) of the ADDICTION SEVERITY INDEX file (#604).
"^DD",727.812,727.812,32,"DT")
3020522
**END**
**END**
