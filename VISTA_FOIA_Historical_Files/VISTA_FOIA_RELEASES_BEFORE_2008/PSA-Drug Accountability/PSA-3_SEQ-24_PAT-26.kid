Released PSA*3*26 SEQ #24
Extracted from mail message
**KIDS**:PSA*3.0*26^

**INSTALL NAME**
PSA*3.0*26
"BLD",3921,0)
PSA*3.0*26^DRUG ACCOUNTABILITY^0^3030619^y
"BLD",3921,1,0)
^9.61A^7^7^3030429^^^^
"BLD",3921,1,1,0)
This enhancement provides a DELPHI based redesign of the Upload Invoices 
"BLD",3921,1,2,0)
process currently in the Drug Accountability/Inventory Interface Version 
"BLD",3921,1,3,0)
3.0 software. This option is used to upload invoice data from the Prime 
"BLD",3921,1,4,0)
Vendor and update VISTA Drug Accountability files.  The redesigned 
"BLD",3921,1,5,0)
function, using DELPHI instead of ProComm script files will make 
"BLD",3921,1,6,0)
uploading invoices simpler and faster.  
"BLD",3921,1,7,0)
 
"BLD",3921,"KRN",0)
^9.67PA^^
"BLD",3921,"KRN",.4,0)
.4
"BLD",3921,"KRN",.4,"NM",0)
^9.68A^^0
"BLD",3921,"KRN",.401,0)
.401
"BLD",3921,"KRN",.401,"NM",0)
^9.68A^^0
"BLD",3921,"KRN",.402,0)
.402
"BLD",3921,"KRN",.402,"NM",0)
^9.68A^^0
"BLD",3921,"KRN",.403,0)
.403
"BLD",3921,"KRN",.5,0)
.5
"BLD",3921,"KRN",.84,0)
.84
"BLD",3921,"KRN",3.6,0)
3.6
"BLD",3921,"KRN",3.8,0)
3.8
"BLD",3921,"KRN",9.2,0)
9.2
"BLD",3921,"KRN",9.8,0)
9.8
"BLD",3921,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",3921,"KRN",9.8,"NM",1,0)
PSABRKU1^^0^B22294169
"BLD",3921,"KRN",9.8,"NM",2,0)
PSABRKU2^^0^B8092424
"BLD",3921,"KRN",9.8,"NM",3,0)
PSABRKU3^^0^B17399936
"BLD",3921,"KRN",9.8,"NM",4,0)
PSABRKU4^^0^B39501736
"BLD",3921,"KRN",9.8,"NM",5,0)
PSABRKU5^^0^B2524103
"BLD",3921,"KRN",9.8,"NM",6,0)
PSABRKU6^^0^B63560640
"BLD",3921,"KRN",9.8,"NM",7,0)
PSABRKU8^^0^B14875027
"BLD",3921,"KRN",9.8,"NM","B","PSABRKU1",1)

"BLD",3921,"KRN",9.8,"NM","B","PSABRKU2",2)

"BLD",3921,"KRN",9.8,"NM","B","PSABRKU3",3)

"BLD",3921,"KRN",9.8,"NM","B","PSABRKU4",4)

"BLD",3921,"KRN",9.8,"NM","B","PSABRKU5",5)

"BLD",3921,"KRN",9.8,"NM","B","PSABRKU6",6)

"BLD",3921,"KRN",9.8,"NM","B","PSABRKU8",7)

"BLD",3921,"KRN",19,0)
19
"BLD",3921,"KRN",19,"NM",0)
^9.68A^10^10
"BLD",3921,"KRN",19,"NM",1,0)
PSA UPLOAD PRIME VENDOR DATA^^0^
"BLD",3921,"KRN",19,"NM",2,0)
PSA ORDERS MENU^^2
"BLD",3921,"KRN",19,"NM",3,0)
PSA PROCESS PRIME VENDOR DATA^^0
"BLD",3921,"KRN",19,"NM",4,0)
PSA VERIFY INVOICES^^0
"BLD",3921,"KRN",19,"NM",5,0)
PSA PRINT ORDERS^^0
"BLD",3921,"KRN",19,"NM",6,0)
PSA CREDIT RESOLUTION^^0
"BLD",3921,"KRN",19,"NM",7,0)
PSA EDIT VERIFIED INVOICE^^0
"BLD",3921,"KRN",19,"NM",8,0)
PSA DELETE INVOICES^^0
"BLD",3921,"KRN",19,"NM",9,0)
PSA MSG RECIPIENTS^^0
"BLD",3921,"KRN",19,"NM",10,0)
PSA GUI UPLOAD^^0
"BLD",3921,"KRN",19,"NM","B","PSA CREDIT RESOLUTION",6)

"BLD",3921,"KRN",19,"NM","B","PSA DELETE INVOICES",8)

"BLD",3921,"KRN",19,"NM","B","PSA EDIT VERIFIED INVOICE",7)

"BLD",3921,"KRN",19,"NM","B","PSA GUI UPLOAD",10)

"BLD",3921,"KRN",19,"NM","B","PSA MSG RECIPIENTS",9)

"BLD",3921,"KRN",19,"NM","B","PSA ORDERS MENU",2)

"BLD",3921,"KRN",19,"NM","B","PSA PRINT ORDERS",5)

"BLD",3921,"KRN",19,"NM","B","PSA PROCESS PRIME VENDOR DATA",3)

"BLD",3921,"KRN",19,"NM","B","PSA UPLOAD PRIME VENDOR DATA",1)

"BLD",3921,"KRN",19,"NM","B","PSA VERIFY INVOICES",4)

"BLD",3921,"KRN",19.1,0)
19.1
"BLD",3921,"KRN",101,0)
101
"BLD",3921,"KRN",409.61,0)
409.61
"BLD",3921,"KRN",771,0)
771
"BLD",3921,"KRN",869.2,0)
869.2
"BLD",3921,"KRN",870,0)
870
"BLD",3921,"KRN",8994,0)
8994
"BLD",3921,"KRN",8994,"NM",0)
^9.68A^1^1
"BLD",3921,"KRN",8994,"NM",1,0)
PSA UPLOAD^^0
"BLD",3921,"KRN",8994,"NM","B","PSA UPLOAD",1)

"BLD",3921,"KRN","B",.4,.4)

"BLD",3921,"KRN","B",.401,.401)

"BLD",3921,"KRN","B",.402,.402)

"BLD",3921,"KRN","B",.403,.403)

"BLD",3921,"KRN","B",.5,.5)

"BLD",3921,"KRN","B",.84,.84)

"BLD",3921,"KRN","B",3.6,3.6)

"BLD",3921,"KRN","B",3.8,3.8)

"BLD",3921,"KRN","B",9.2,9.2)

"BLD",3921,"KRN","B",9.8,9.8)

"BLD",3921,"KRN","B",19,19)

"BLD",3921,"KRN","B",19.1,19.1)

"BLD",3921,"KRN","B",101,101)

"BLD",3921,"KRN","B",409.61,409.61)

"BLD",3921,"KRN","B",771,771)

"BLD",3921,"KRN","B",869.2,869.2)

"BLD",3921,"KRN","B",870,870)

"BLD",3921,"KRN","B",8994,8994)

"BLD",3921,"QUES",0)
^9.62^^
"BLD",3921,"REQG",0)
^9.611^^
"KRN",19,10583,-1)
2^2
"KRN",19,10583,0)
PSA ORDERS MENU^Orders Menu^^M^11595^PSA ORDERS^^^^^^287^^1
"KRN",19,10583,10,0)
^19.01IP^11^11
"KRN",19,10583,10,2,0)
10585^1^10
"KRN",19,10583,10,2,"^")
PSA PROCESS PRIME VENDOR DATA
"KRN",19,10583,10,5,0)
10587^3^30
"KRN",19,10583,10,5,"^")
PSA PRINT ORDERS
"KRN",19,10583,10,6,0)
10586^2^20
"KRN",19,10583,10,6,"^")
PSA VERIFY INVOICES
"KRN",19,10583,10,7,0)
10588^4^40
"KRN",19,10583,10,7,"^")
PSA CREDIT RESOLUTION
"KRN",19,10583,10,8,0)
11664^5^50
"KRN",19,10583,10,8,"^")
PSA EDIT VERIFIED INVOICE
"KRN",19,10583,10,9,0)
11810^6^60
"KRN",19,10583,10,9,"^")
PSA DELETE INVOICES
"KRN",19,10583,10,11,0)
11826^7^70
"KRN",19,10583,10,11,"^")
PSA MSG RECIPIENTS
"KRN",19,10583,"U")
ORDERS MENU
"KRN",19,10584,-1)
0^1
"KRN",19,10584,0)
PSA UPLOAD PRIME VENDOR DATA^Upload and Process Prime Vendor Invoice Data^^R^^PSA ORDERS^^^^^^DRUG ACCOUNTABILITY
"KRN",19,10584,1,0)
^19.06^4^4^3030429^^^^
"KRN",19,10584,1,1,0)
The Upload and Process Prime Vendor Invoice Data option uploads invoice
"KRN",19,10584,1,2,0)
data received from the prime vendor. The invoice data may be processed
"KRN",19,10584,1,3,0)
after the data is uploaded. It also allows the user to print the invoices
"KRN",19,10584,1,4,0)
immediately following the upload and immediately following the processing.
"KRN",19,10584,25)
PSAUP
"KRN",19,10584,"U")
UPLOAD AND PROCESS PRIME VENDO
"KRN",19,10585,-1)
0^3
"KRN",19,10585,0)
PSA PROCESS PRIME VENDOR DATA^Process Uploaded Prime Vendor Invoice Data^^R^^PSA ORDERS^^^^^^DRUG ACCOUNTABILITY^^1^
"KRN",19,10585,1,0)
^^2^2^2970507^
"KRN",19,10585,1,1,0)
The Process Uploaded Prime Vendor Invoice Data option processes uploaded
"KRN",19,10585,1,2,0)
prime vendor invoice data.
"KRN",19,10585,15)

"KRN",19,10585,20)
S PSAENTRY=1
"KRN",19,10585,25)
PSAPROC
"KRN",19,10585,99)
56873,44873
"KRN",19,10585,"U")
PROCESS UPLOADED PRIME VENDOR 
"KRN",19,10586,-1)
0^4
"KRN",19,10586,0)
PSA VERIFY INVOICES^Verify Invoices^^R^^PSA ORDERS^^^^^^DRUG ACCOUNTABILITY^^1
"KRN",19,10586,1,0)
^^3^3^2970722^
"KRN",19,10586,1,1,0)
The Verify Invoices option validates processed invoices. The verifier and
"KRN",19,10586,1,2,0)
processor cannot be the same person. When the invoices are verified, the
"KRN",19,10586,1,3,0)
drug balances are updated in the pharmacy location and/or master vault.
"KRN",19,10586,20)
Q
"KRN",19,10586,25)
PSAVER
"KRN",19,10586,"U")
VERIFY INVOICES
"KRN",19,10587,-1)
0^5
"KRN",19,10587,0)
PSA PRINT ORDERS^Print Orders^^R^^PSA ORDERS^^^^^^DRUG ACCOUNTABILITY^^
"KRN",19,10587,1,0)
^^4^4^2970507^
"KRN",19,10587,1,1,0)
The Print Orders option generates invoices by entering the order number,
"KRN",19,10587,1,2,0)
invoice number, or invoice status. If the invoice has not been processed, 
"KRN",19,10587,1,3,0)
the PRIME VENDOR UPLOAD REPORT prints. If the invoice has been processed,
"KRN",19,10587,1,4,0)
the PRIME VENDOR ORDER REPORT prints.
"KRN",19,10587,20)

"KRN",19,10587,25)
PSAORDP
"KRN",19,10587,"U")
PRINT ORDERS
"KRN",19,10588,-1)
0^6
"KRN",19,10588,0)
PSA CREDIT RESOLUTION^Credit Resolution^^R^^PSAMGR^^^^^^DRUG ACCOUNTABILITY^^1
"KRN",19,10588,1,0)
^^1^1^2970507^
"KRN",19,10588,1,1,0)
The Credit Resolution option enters credit memo data.
"KRN",19,10588,20)
Q
"KRN",19,10588,25)
PSACREDR
"KRN",19,10588,"U")
CREDIT RESOLUTION
"KRN",19,11664,-1)
0^7
"KRN",19,11664,0)
PSA EDIT VERIFIED INVOICE^Edit Verified Invoices^^R^^^^^^^^
"KRN",19,11664,1,0)
^19.06^2^2^3000425^^
"KRN",19,11664,1,1,0)
 This option allows the user to change elements of a verified invoice.
"KRN",19,11664,1,2,0)
 
"KRN",19,11664,25)
PSAVERA
"KRN",19,11664,"U")
EDIT VERIFIED INVOICES
"KRN",19,11810,-1)
0^8
"KRN",19,11810,0)
PSA DELETE INVOICES^Delete Un-processed Invoices^^R^^PSAMGR^^^^^^
"KRN",19,11810,1,0)
^19.06^3^3^3001114^^
"KRN",19,11810,1,1,0)
This option deletes any un-processed invoices older than the date the
"KRN",19,11810,1,2,0)
user specifies. Only personnel who hold the PSAMGR key will have access
"KRN",19,11810,1,3,0)
to this process.
"KRN",19,11810,25)
PSAOLD^PSAPTCH
"KRN",19,11810,"U")
DELETE UN-PROCESSED INVOICES
"KRN",19,11826,-1)
0^9
"KRN",19,11826,0)
PSA MSG RECIPIENTS^Setup Mail Message Recipients^^R^^PSAMGR^^^^^^
"KRN",19,11826,1,0)
^^3^3^3010215^
"KRN",19,11826,1,1,0)
 This option is used to enter/delete personnel from the two mail groups
"KRN",19,11826,1,2,0)
 used for notifying personnel of a change in NDC and/or Drug Price, and
"KRN",19,11826,1,3,0)
 when drugs are below reorder levels.
"KRN",19,11826,25)
PSA10^PSALOCO
"KRN",19,11826,"U")
SETUP MAIL MESSAGE RECIPIENTS
"KRN",19,12270,-1)
0^10
"KRN",19,12270,0)
PSA GUI UPLOAD^UPLOAD UTILITY^^B^^PSA ORDERS^^^^^^
"KRN",19,12270,1,0)
^^2^2^3030429^
"KRN",19,12270,1,1,0)
This broker option is assigned to personnel authorized to upload
"KRN",19,12270,1,2,0)
invoice data from the prime vendor.
"KRN",19,12270,25)
PSAUPLD^PSABRKU1
"KRN",19,12270,99.1)
59296,29674
"KRN",19,12270,"RPC",0)
^19.05P^1^1
"KRN",19,12270,"RPC",1,0)
PSA UPLOAD
"KRN",19,12270,"U")
UPLOAD UTILITY
"KRN",8994,740,-1)
0^1
"KRN",8994,740,0)
PSA UPLOAD^PSAUPLD^PSABRKU1^2^P^^^1
"KRN",8994,740,1,0)
^8994.01^1^1^3021118^^^^
"KRN",8994,740,1,1,0)
This is the primary entry point for the Drug Accountability Upload GUI.
"KRN",8994,740,2,0)
^8994.02A^1^1
"KRN",8994,740,2,1,0)
TMP^2^^1
"KRN",8994,740,2,"B","TMP",1)

"MBREQ")
0
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",287,-1)
1^1
"PKG",287,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",287,22,0)
^9.49I^1^1
"PKG",287,22,1,0)
3.0^3010830^2971030^11595
"PKG",287,22,1,"PAH",1,0)
26^3030619
"PKG",287,22,1,"PAH",1,1,0)
^^7^7^3030619
"PKG",287,22,1,"PAH",1,1,1,0)
This enhancement provides a DELPHI based redesign of the Upload Invoices 
"PKG",287,22,1,"PAH",1,1,2,0)
process currently in the Drug Accountability/Inventory Interface Version 
"PKG",287,22,1,"PAH",1,1,3,0)
3.0 software. This option is used to upload invoice data from the Prime 
"PKG",287,22,1,"PAH",1,1,4,0)
Vendor and update VISTA Drug Accountability files.  The redesigned 
"PKG",287,22,1,"PAH",1,1,5,0)
function, using DELPHI instead of ProComm script files will make 
"PKG",287,22,1,"PAH",1,1,6,0)
uploading invoices simpler and faster.  
"PKG",287,22,1,"PAH",1,1,7,0)
 
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","PSABRKU1")
0^1^B22294169
"RTN","PSABRKU1",1,0)
PSABRKU1 ;BIR/DB-Upload and Process Prime Vendor Invoice Data ;8/19/99
"RTN","PSABRKU1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**26**; 10/24/97
"RTN","PSABRKU1",3,0)
 ;
"RTN","PSABRKU1",4,0)
 ;Under the 'Authority to Operate' agreement dated May 30, 2003,
"RTN","PSABRKU1",5,0)
 ;this routine should not be modified.
"RTN","PSABRKU1",6,0)
 ;
"RTN","PSABRKU1",7,0)
PSAUPLD(RET,TMP) ;uploads data in VISTA
"RTN","PSABRKU1",8,0)
 D NOW^%DTC
"RTN","PSABRKU1",9,0)
 S X=0
"RTN","PSABRKU1",10,0)
 I $G(TMP(0))="******" S PSAOUT=0 D STRT S RET="OK" Q
"RTN","PSABRKU1",11,0)
 I $G(TMP(0))="KEY" G LOGON
"RTN","PSABRKU1",12,0)
 S X=0,CNT=1 F  S X=$O(^TMP($J,"PSAX12",X)) Q:X'>0  S CNT=$G(CNT)+1
"RTN","PSABRKU1",13,0)
 S X=-1 F  S X=$O(TMP(X)) Q:X=""  S DATA=$G(TMP(X)) I $G(DATA)'="" S DATA=$P(DATA,"^",2,99) S ^TMP($J,"PSAX12",CNT,0)=$$DECRYP^XUSRB1(DATA),CNT=$G(CNT)+1
"RTN","PSABRKU1",14,0)
 ;
"RTN","PSABRKU1",15,0)
 ;
"RTN","PSABRKU1",16,0)
 S RET="OK"
"RTN","PSABRKU1",17,0)
 Q
"RTN","PSABRKU1",18,0)
STRT S (PSABBC,PSACNT,PSAISA,PSALINE,PSASEGD,PSALND)=0 K TMP
"RTN","PSABRKU1",19,0)
 D NOW^%DTC S Y=% X ^DD("DD")
"RTN","PSABRKU1",20,0)
 S ^TMP($J,"PSA UPLOAD",.3,0)="Results  : "
"RTN","PSABRKU1",21,0)
 S ^TMP($J,"PSA UPLOAD",.5,0)="Finished                : "_Y
"RTN","PSABRKU1",22,0)
 D NOW^%DTC S DT=$P(%,".")
"RTN","PSABRKU1",23,0)
 F  S PSALINE=$O(^TMP($J,"PSAX12",PSALINE)) Q:'PSALINE  D  Q:PSABBC&(PSAISA)
"RTN","PSABRKU1",24,0)
 .I $E($G(^TMP($J,"PSAX12",PSALINE,0)),1,3)="ISA" S PSADB=^TMP($J,"PSAX12",PSALINE,0) S PSASEGD=$E(^(0),4,4),PSALND=$E(^(0),106,106),PSAISA=1 Q
"RTN","PSABRKU1",25,0)
 ;
"RTN","PSABRKU1",26,0)
 I PSASEGD=""!(PSALND="") D  G KILL
"RTN","PSABRKU1",27,0)
 .S PSASTAR="",$P(PSASTAR,"*",80)=""
"RTN","PSABRKU1",28,0)
 G:PSASEGD="~"&(PSALND="^") LINE
"RTN","PSABRKU1",29,0)
 ;
"RTN","PSABRKU1",30,0)
 ;Changes the data element and segment delimiters to ^ and ~.
"RTN","PSABRKU1",31,0)
 S (PSACNT,PSALINE)=0 F  S PSALINE=$O(^TMP($J,"PSAX12",PSALINE)) Q:'PSALINE  D  Q:PSAOUT
"RTN","PSABRKU1",32,0)
 .S PSADATA=^TMP($J,"PSAX12",PSALINE,0)
"RTN","PSABRKU1",33,0)
 .I PSALND'="~" S PSADATA=$TR(PSADATA,PSALND,"~")
"RTN","PSABRKU1",34,0)
 .I PSASEGD'="^" S PSADATA=$TR(PSADATA,PSASEGD,"^")
"RTN","PSABRKU1",35,0)
 .S ^TMP($J,"PSAX12",PSALINE,0)=PSADATA
"RTN","PSABRKU1",36,0)
 ;
"RTN","PSABRKU1",37,0)
LINE ;Places each segment on a node to itself.
"RTN","PSABRKU1",38,0)
 K ^TMP($J,"PSAPV")
"RTN","PSABRKU1",39,0)
 S PSAHOLD="",(PSACNT,PSALINE)=0
"RTN","PSABRKU1",40,0)
 F  S PSALINE=$O(^TMP($J,"PSAX12",PSALINE)) Q:'PSALINE  D
"RTN","PSABRKU1",41,0)
 .S PSADATA=^TMP($J,"PSAX12",PSALINE,0),PSADATA=PSAHOLD_PSADATA
"RTN","PSABRKU1",42,0)
 .I PSADATA'["~" S PSAHOLD=PSADATA Q
"RTN","PSABRKU1",43,0)
 .S PSASTOP=0 F  S PSASEG=$P(PSADATA,"~") Q:PSASEG=""  D  Q:PSASTOP
"RTN","PSABRKU1",44,0)
 ..S PSACNT=PSACNT+1,^TMP($J,"PSAPV",PSACNT,0)=PSASEG
"RTN","PSABRKU1",45,0)
 ..S PSADATA=$P(PSADATA,"~",2,99) I PSADATA'["~" S PSASTOP=1,PSAHOLD=PSADATA Q
"RTN","PSABRKU1",46,0)
 ..S PSAHOLD=""
"RTN","PSABRKU1",47,0)
 ;
"RTN","PSABRKU1",48,0)
SPACES ;remove all leading spaces in all data elements
"RTN","PSABRKU1",49,0)
 S (PSACNT,PSALINE)=0 F  S PSALINE=$O(^TMP($J,"PSAPV",PSALINE)) Q:'PSALINE  D
"RTN","PSABRKU1",50,0)
 .S PSASEG=^TMP($J,"PSAPV",PSALINE,0)
"RTN","PSABRKU1",51,0)
 .I $E(PSASEG,1,3)="ISA" S ^TMP($J,"PSAPVS",PSALINE)=^TMP($J,"PSAPV",PSALINE,0) Q
"RTN","PSABRKU1",52,0)
 .S PSACNT=0,PSASEGL=$L(PSASEG)
"RTN","PSABRKU1",53,0)
 .F PSAEX=1:1:PSASEGL S PSAX=$E(PSASEG,PSAEX,PSAEX) S:PSAX="^" PSACNT=PSACNT+1
"RTN","PSABRKU1",54,0)
 .F PSAPC=1:1:(PSACNT+1) S PSADE=$P(PSASEG,"^",PSAPC) D
"RTN","PSABRKU1",55,0)
 ..F  Q:$E(PSADE,1,1)'=" "  S PSADE=$E(PSADE,2,999)
"RTN","PSABRKU1",56,0)
 ..S $P(PSASEG,"^",PSAPC)=PSADE
"RTN","PSABRKU1",57,0)
 .S ^TMP($J,"PSAPVS",PSALINE)=PSASEG
"RTN","PSABRKU1",58,0)
 K ^TMP($J,"PSAPV")
"RTN","PSABRKU1",59,0)
 ;
"RTN","PSABRKU1",60,0)
CHECK ;Looks for X12 errors. If no errors, loads data into ^TMP($J,"PSAPV SET")
"RTN","PSABRKU1",61,0)
 D ^PSABRKU3
"RTN","PSABRKU1",62,0)
 D XTMP^PSABRKU4
"RTN","PSABRKU1",63,0)
 S PSANEXT=$O(^XTMP("PSAPV",0))
"RTN","PSABRKU1",64,0)
 D ^PSABRKU6
"RTN","PSABRKU1",65,0)
 ;
"RTN","PSABRKU1",66,0)
KILL K ^TMP($J,"PSAPVS"),^TMP($J,"PSAPV SET"),^TMP($J,"PSAX12")
"RTN","PSABRKU1",67,0)
 K %,DIR,DIRUT,DWLC,PSABBC,PSACNT,PSACTN1,PSACOMB,PSACS,PSACTRL,PSACTRL2,PSADATA,PSADE,PSADT,PSADUP,PSAENTRY,PSAERR,PSAEX,PSAEXPEC,PSAFND1,PSAGS,PSAHOLD,PSAIEN,PSAIN,PSAINV,PSAINVDT,PSAINVN,PSAISA,PSAISIT,PSAISITN,PSAITCNT,PSAITEM
"RTN","PSABRKU1",68,0)
 K PSALAST,PSALINE,PSALLCS,PSALLOK,PSALND,PSALOC,PSANDC,PSANEW,PSANEXT,PSANTYPE,PSAOK,PSAORD,PSAORDDT,PSAORDN,PSAOSIT,PSAOSITN,PSAOUT,PSAPC
"RTN","PSABRKU1",69,0)
 K PSAS,PSASEG,PSASEGL,PSASEGD,PSASS,PSAST,PSASTA,PSASTAR,PSASTCNT,PSASUB,PSASYN,PSAUOM,PSAUOM1,PSAUOMH,PSAUOMH1,PSAVSN,PSAX,X,X1,X2,XTKDIC,XTKERR,XTKMODE,Y
"RTN","PSABRKU1",70,0)
 S (X,CNT)=0 F  S X=$O(PSAGUI2(X)) Q:X=""  S CNT=$G(CNT)+1
"RTN","PSABRKU1",71,0)
 I $G(CNT)>0 S ^TMP($J,"PSA UPLOAD",1.6,0)="Orders Uploaded         : "_$G(CNT)
"RTN","PSABRKU1",72,0)
 S (X,CNTR)=0 F  S X=$O(PSAGUI3(X)) Q:X=""  S CNTR=$G(CNTR)+1
"RTN","PSABRKU1",73,0)
 I $G(CNTR)>0 S ^TMP($J,"PSA UPLOAD",1.7,0)="Invoices Uploaded       : "_$G(CNTR)
"RTN","PSABRKU1",74,0)
 S ^TMP($J,"PSA UPLOAD",1.8,0)="Line Items Uploaded     : "_$G(PSAGUI4)
"RTN","PSABRKU1",75,0)
 S RET=$G(CNT)_"^"_$G(CNTR)_"^"_$G(PSAGUI4) K CNT,CNTR
"RTN","PSABRKU1",76,0)
 K PSAGUI1
"RTN","PSABRKU1",77,0)
 I $D(^TMP($J,"PSA UPLOAD")) S XMSUB="Upload Status Report",XMDUZ="DRUG ACCOUNTABILITY UPLOAD INTERFACE",XMY(DUZ)="",XMTEXT="^TMP($J,"_"""PSA UPLOAD"""_"," D ^XMD
"RTN","PSABRKU1",78,0)
 K ^TMP($J,"PSA UPLOAD"),^TMP($J,"PSAX12"),^TMP($J,"PSAPVS")
"RTN","PSABRKU1",79,0)
 Q
"RTN","PSABRKU1",80,0)
LOGON ;Check security key
"RTN","PSABRKU1",81,0)
 S (PSAGUI2,PSAGUI3,PSAGUI4)=0
"RTN","PSABRKU1",82,0)
 K ^TMP($J,"PSAX12"),^TMP($J,"PSA UPLOAD"),PSACNT,CNT
"RTN","PSABRKU1",83,0)
 I '$D(^XUSEC("PSA ORDERS",DUZ)) S RET(0)="0" Q
"RTN","PSABRKU1",84,0)
 D NOW^%DTC S Y=% X ^DD("DD") S ^TMP($J,"PSA UPLOAD",.4,0)="Upload Started          : "_Y,RET(0)=1 Q
"RTN","PSABRKU1",85,0)
 Q
"RTN","PSABRKU2")
0^2^B8092424
"RTN","PSABRKU2",1,0)
PSABRKU2 ;BHM/DB - Automatic processing of invoices;16 DEC 99
"RTN","PSABRKU2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**26**; 10/24/97
"RTN","PSABRKU2",3,0)
 ;This routine is a continuation of the Upload GUI
"RTN","PSABRKU2",4,0)
 ;the program will attempt to process as much of the invoice
"RTN","PSABRKU2",5,0)
 ;data as it can.
"RTN","PSABRKU2",6,0)
 ;
"RTN","PSABRKU2",7,0)
 ;Order Unit matching, supply item identification, and location
"RTN","PSABRKU2",8,0)
 ;assignment are attempted.
"RTN","PSABRKU2",9,0)
 ;
"RTN","PSABRKU2",10,0)
 K PSACTRL,PSALOC,PSAMV,PSACS,PSANCS
"RTN","PSABRKU2",11,0)
 I '$D(^XTMP("PSAPV")) G Q
"RTN","PSABRKU2",12,0)
CNT ;Count invoices that need a pharm location or master vault assigned.
"RTN","PSABRKU2",13,0)
 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""  D
"RTN","PSABRKU2",14,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSABRKU2",15,0)
 .I $G(PSASORT)'=0,$G(PSASORT)'="",$D(^XTMP("PSAPV",PSACTRL,"ST")),$P(^XTMP("PSAPV",PSACTRL,"ST"),"^",1)'=PSASORT Q
"RTN","PSABRKU2",16,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSABRKU2",17,0)
 .I $P(PSAIN,"^",10)="ALL CS",$P(PSAIN,"^",12)="" S PSACNT=PSACNT+1,PSACS(PSACTRL)="" Q
"RTN","PSABRKU2",18,0)
 .I $P(PSAIN,"^",10)'="ALL CS" D
"RTN","PSABRKU2",19,0)
 ..I $P(PSAIN,"^",9)="CS" S:$P(PSAIN,"^",7)="" PSANCS(PSACTRL)="" S:$P(PSAIN,"^",12)="" PSACS(PSACTRL)="" S:$P(PSAIN,"^",7)=""!($P(PSAIN,"^",12)="") PSACNT=PSACNT+1 Q
"RTN","PSABRKU2",20,0)
 ..I $P(PSAIN,"^",9)="",$P(PSAIN,"^",7)="" S PSACNT=PSACNT+1,PSANCS(PSACTRL)=""
"RTN","PSABRKU2",21,0)
 I 'PSACNT G Q
"RTN","PSABRKU2",22,0)
 ;
"RTN","PSABRKU2",23,0)
 ;Gets pharmacy locations
"RTN","PSABRKU2",24,0)
 S (PSALOC,PSANUM)=0 F  S PSALOC=+$O(^PSD(58.8,"ADISP","P",PSALOC)) Q:'PSALOC  D
"RTN","PSABRKU2",25,0)
 .Q:'$D(^PSD(58.8,PSALOC,0))!($P($G(^PSD(58.8,PSALOC,0)),"^")="")
"RTN","PSABRKU2",26,0)
 .I +$G(^PSD(58.8,PSALOC,"I")),+^PSD(58.8,PSALOC,"I")'>DT Q
"RTN","PSABRKU2",27,0)
 .S PSANUM=PSANUM+1,PSAONE=PSALOC,PSAISIT=+$P(^PSD(58.8,PSALOC,0),"^",3),PSAOSIT=+$P(^(0),"^",10)
"RTN","PSABRKU2",28,0)
 .D SITES^PSAUTL1 S PSACOMB=$S('$D(PSACOMB):"NO COMBINED IP/OP",1:PSACOMB),PSALOCA($P(^PSD(58.8,PSALOC,0),"^")_PSACOMB,PSALOC)=PSAISIT_"^"_PSAOSIT
"RTN","PSABRKU2",29,0)
 ;
"RTN","PSABRKU2",30,0)
 ;Gets master vaults
"RTN","PSABRKU2",31,0)
 S (PSAMVN,PSAMV)=0 F  S PSAMV=+$O(^PSD(58.8,"ADISP","M",PSAMV)) Q:'PSAMV  D
"RTN","PSABRKU2",32,0)
 .Q:'$D(^PSD(58.8,PSAMV,0))!($P($G(^PSD(58.8,PSAMV,0)),"^")="")
"RTN","PSABRKU2",33,0)
 .I +$G(^PSD(58.8,PSAMV,"I")),+^PSD(58.8,PSAMV,"I")'>DT Q
"RTN","PSABRKU2",34,0)
 .S PSAMVN=PSAMVN+1,PSAONEMV=PSAMV,PSAMV($P(^PSD(58.8,PSAMV,0),"^"),PSAMV)=""
"RTN","PSABRKU2",35,0)
 I 'PSANUM G 2
"RTN","PSABRKU2",36,0)
 I PSANUM=1 D ONE
"RTN","PSABRKU2",37,0)
 G 2
"RTN","PSABRKU2",38,0)
ONE ;Only one location
"RTN","PSABRKU2",39,0)
 S PSACNT=0,PSALOC=PSAONE,PSALOCN=$O(PSALOCA(""))
"RTN","PSABRKU2",40,0)
 S PSACTRL="" F  S PSACTRL=$O(PSANCS(PSACTRL)) Q:PSACTRL=""  D
"RTN","PSABRKU2",41,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSABRKU2",42,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",7)=PSALOC,PSACNT=1
"RTN","PSABRKU2",43,0)
 S PSA=$O(PSACS("")) D:PSA'="" MASTER
"RTN","PSABRKU2",44,0)
 Q
"RTN","PSABRKU2",45,0)
 ;
"RTN","PSABRKU2",46,0)
MASTER ;Assigns invoice to Master Vault
"RTN","PSABRKU2",47,0)
 I 'PSAMVN G 2
"RTN","PSABRKU2",48,0)
 ;
"RTN","PSABRKU2",49,0)
 I PSAMVN=1 D
"RTN","PSABRKU2",50,0)
 .S PSACTRL=$O(PSACS(""))
"RTN","PSABRKU2",51,0)
 .S PSACTRL="" F  S PSACTRL=$O(PSACS(PSACTRL)) Q:PSACTRL=""  D
"RTN","PSABRKU2",52,0)
 ..Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSABRKU2",53,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",12)=PSAONEMV
"RTN","PSABRKU2",54,0)
2 ;Match order units
"RTN","PSABRKU2",55,0)
 K X1,X2,X3,X4
"RTN","PSABRKU2",56,0)
 ;Loop through TMP("PSA ORDER",CMT,0)
"RTN","PSABRKU2",57,0)
 Q
"RTN","PSABRKU2",58,0)
Q Q
"RTN","PSABRKU3")
0^3^B17399936
"RTN","PSABRKU3",1,0)
PSABRKU3 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data - CONT'D ;8/13/97
"RTN","PSABRKU3",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**26**; 10/24/97
"RTN","PSABRKU3",3,0)
 ;Checking the X12 invoice data.
"RTN","PSABRKU3",4,0)
 S (PSASTCNT,PSAITCNT)=0
"RTN","PSABRKU3",5,0)
 K ^TMP($J,"PSAPV SET"),PSAERR
"RTN","PSABRKU3",6,0)
 S PSALAST=""
"RTN","PSABRKU3",7,0)
 S PSALINE=0 F  S PSALINE=$O(^TMP($J,"PSAPVS",PSALINE)) Q:PSALINE=""  S PSADATA=^(PSALINE) D
"RTN","PSABRKU3",8,0)
 .;check segment order
"RTN","PSABRKU3",9,0)
 .D ^PSABRKU5 S PSALAST=$P(PSADATA,"^")
"RTN","PSABRKU3",10,0)
ISA .;control header
"RTN","PSABRKU3",11,0)
 .I PSALAST="ISA" D  Q
"RTN","PSABRKU3",12,0)
 ..S PSAISA=PSADATA,PSACTRL="" I $L($P(PSADATA,"^",14))'=9 S PSASEG="ISA" D MSG^PSABRKU8
"RTN","PSABRKU3",13,0)
 .;
"RTN","PSABRKU3",14,0)
IEA .;control trailer
"RTN","PSABRKU3",15,0)
 .I PSALAST="IEA" D  Q
"RTN","PSABRKU3",16,0)
 ..I $P(PSADATA,"^",3)'=$P(PSAISA,"^",14) S PSASEG="IEA" D MSG^PSABRKU8
"RTN","PSABRKU3",17,0)
 .;
"RTN","PSABRKU3",18,0)
GS .;group header
"RTN","PSABRKU3",19,0)
 .I PSALAST="GS" S PSAGS=PSADATA D  Q
"RTN","PSABRKU3",20,0)
 ..F %=3,4 S PSAPC=$S(%=3:7,1:9) I $P(PSADATA,"^",%)'=$TR($P(PSAISA,"^",PSAPC)," ") S PSASEG="GS" D MSG^PSABRKU8
"RTN","PSABRKU3",21,0)
 .;
"RTN","PSABRKU3",22,0)
GE .;group trailer
"RTN","PSABRKU3",23,0)
 .I PSALAST="GE" D  Q
"RTN","PSABRKU3",24,0)
 ..I $P(PSADATA,"^",3)'=$P($G(PSAGS),"^",7) S PSASEG="GE" D MSG^PSABRKU8
"RTN","PSABRKU3",25,0)
 .;
"RTN","PSABRKU3",26,0)
ST .;set header
"RTN","PSABRKU3",27,0)
 .I PSALAST="ST" D  Q
"RTN","PSABRKU3",28,0)
 ..S PSAST=PSADATA,PSACTRL=$P(PSADATA,"^",3),PSASTCNT=1,PSAITCNT=0,PSANTYPE=""
"RTN","PSABRKU3",29,0)
 ..I $L(PSACTRL)>3,$L(PSACTRL)<10 Q
"RTN","PSABRKU3",30,0)
 ..S PSASEG="ST" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",31,0)
 .;
"RTN","PSABRKU3",32,0)
SE .;set trailer
"RTN","PSABRKU3",33,0)
 .I PSALAST="SE" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSABRKU3",34,0)
 ..I $P(PSADATA,"^",3)'=PSACTRL S PSASEG="SE1" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",35,0)
 ..I PSASTCNT'=$P(PSADATA,"^",2) S PSASEG="SE2" D MSG^PSABRKU8
"RTN","PSABRKU3",36,0)
 .;
"RTN","PSABRKU3",37,0)
BIG .;beginning segment for invoice
"RTN","PSABRKU3",38,0)
 .I PSALAST="BIG" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSABRKU3",39,0)
 ..I $P(PSADATA,"^",4)="" S $P(PSADATA,"^",4)=$P(PSADATA,"^",2)
"RTN","PSABRKU3",40,0)
 ..S $P(PSADATA,"^",5)=$TR($P(PSADATA,"^",5)," ")
"RTN","PSABRKU3",41,0)
 ..S ^TMP($J,"PSAPV SET",PSACTRL,"IN")=$P(PSADATA,"^",2,5)
"RTN","PSABRKU3",42,0)
 .;
"RTN","PSABRKU3",43,0)
REF .;(not used)
"RTN","PSABRKU3",44,0)
 .I PSALAST="REF" S PSASTCNT=PSASTCNT+1 Q
"RTN","PSABRKU3",45,0)
 .;
"RTN","PSABRKU3",46,0)
 .;buyer, seller, shipping addresses
"RTN","PSABRKU3",47,0)
N1 .I PSALAST="N1" S PSASTCNT=PSASTCNT+1,PSANTYPE=$P(PSADATA,"^",2) D  Q
"RTN","PSABRKU3",48,0)
 ..I PSANTYPE'="BY",PSANTYPE'="DS",PSANTYPE'="ST" S PSASEG="N1" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",49,0)
 ..S ^TMP($J,"PSAPV SET",PSACTRL,PSANTYPE)=$P(PSADATA,"^",3)
"RTN","PSABRKU3",50,0)
 .;
"RTN","PSABRKU3",51,0)
N2 .I PSALAST="N2" D  Q
"RTN","PSABRKU3",52,0)
 ..D:PSANTYPE="" NTYPE
"RTN","PSABRKU3",53,0)
 ..S $P(^TMP($J,"PSAPV SET",PSACTRL,PSANTYPE),"^",2)=$P(PSADATA,"^",2) S PSASTCNT=PSASTCNT+1
"RTN","PSABRKU3",54,0)
 .;
"RTN","PSABRKU3",55,0)
N3 .I PSALAST="N3" D  Q
"RTN","PSABRKU3",56,0)
 ..D:PSANTYPE="" NTYPE
"RTN","PSABRKU3",57,0)
 ..S $P(^TMP($J,"PSAPV SET",PSACTRL,PSANTYPE),"^",3)=$P(PSADATA,"^",2) S PSASTCNT=PSASTCNT+1
"RTN","PSABRKU3",58,0)
 .;
"RTN","PSABRKU3",59,0)
N4 .I PSALAST="N4" D  Q
"RTN","PSABRKU3",60,0)
 ..D:PSANTYPE="" NTYPE
"RTN","PSABRKU3",61,0)
 ..S $P(^TMP($J,"PSAPV SET",PSACTRL,PSANTYPE),"^",4,6)=$P(PSADATA,"^",2,4) S PSASTCNT=PSASTCNT+1,PSANTYPE=""
"RTN","PSABRKU3",62,0)
 .;
"RTN","PSABRKU3",63,0)
DTM .;date time reference
"RTN","PSABRKU3",64,0)
 .I PSALAST="DTM" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSABRKU3",65,0)
 ..S %=$S($P(PSADATA,"^",2)="002":5,$P(PSADATA,"^",2)="035":6,1:0) I '% Q
"RTN","PSABRKU3",66,0)
 ..S $P(^TMP($J,"PSAPV SET",PSACTRL,"IN"),"^",%)=$P(PSADATA,"^",3)
"RTN","PSABRKU3",67,0)
 .;
"RTN","PSABRKU3",68,0)
IT1 .;invoice line item
"RTN","PSABRKU3",69,0)
 .I PSALAST="IT1" S PSASTCNT=PSASTCNT+1,PSAITCNT=PSAITCNT+1 D ITEM Q
"RTN","PSABRKU3",70,0)
CTT .;item count
"RTN","PSABRKU3",71,0)
 .I PSALAST="CTT" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSABRKU3",72,0)
 ..I PSAITCNT'=$P(PSADATA,"^",2) S PSASEG="CTT" D MSG^PSABRKU8
"RTN","PSABRKU3",73,0)
 .;
"RTN","PSABRKU3",74,0)
UNKNOWN .;Segment we don't use
"RTN","PSABRKU3",75,0)
 .S PSASTCNT=PSASTCNT+1
"RTN","PSABRKU3",76,0)
 ;
"RTN","PSABRKU3",77,0)
ERROR S PSASEG=$O(PSAERR("")) D:PSASEG'="" ERROR^PSABRKU8
"RTN","PSABRKU3",78,0)
 Q
"RTN","PSABRKU3",79,0)
 ;
"RTN","PSABRKU3",80,0)
NTYPE S PSASEG="NONTYPE" D NONTYPE^PSABRKU8
"RTN","PSABRKU3",81,0)
 Q
"RTN","PSABRKU3",82,0)
 ;
"RTN","PSABRKU3",83,0)
ITEM ;check line item
"RTN","PSABRKU3",84,0)
 I '$P(PSADATA,"^",2) S PSASEG="IT1-1" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",85,0)
 I $P(PSADATA,"^",6)'="DS" S PSASEG="IT1-2" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",86,0)
 I $P(PSADATA,"^",8)="",$P(PSADATA,"^",10)="",$P(PSADATA,"^",12)="" S PSASEG="IT1-3" D MSG^PSABRKU8 Q
"RTN","PSABRKU3",87,0)
 ;"IT1" Seg=Qty Invoiced ^ Unit of Measure ^ Unit Price ^ Basic Unit Code "DS" ^ NDC ^ VSN
"RTN","PSABRKU3",88,0)
 S PSAITEM=+$P(PSADATA,"^",2),^TMP($J,"PSAPV SET",PSACTRL,"IT",PSAITEM)=+$P(PSADATA,"^",3)_"^"_$P(PSADATA,"^",4)_"^"_$P(PSADATA,"^",5)_"^"_$P(PSADATA,"^",8)_"^"_$P(PSADATA,"^",10)
"RTN","PSABRKU3",89,0)
 I $P(PSADATA,"^",12)'="",$P(PSADATA,"^",11)="UP" S $P(^TMP($J,"PSAPV SET",PSACTRL,"IT",PSAITEM),"^",26)=$P(PSADATA,"^",12)
"RTN","PSABRKU3",90,0)
 Q
"RTN","PSABRKU4")
0^4^B39501736
"RTN","PSABRKU4",1,0)
PSABRKU4 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSABRKU4",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**26**; 10/24/97
"RTN","PSABRKU4",3,0)
XTMP ;This modules copies the prime vendor data in ^TMP($J,"PSAPV SET") to
"RTN","PSABRKU4",4,0)
 ;^XTMP("PSAPV"). The data has passed all X12 checks.
"RTN","PSABRKU4",5,0)
 ;
"RTN","PSABRKU4",6,0)
 S X1=DT,X2=21 D C^%DTC L +^XTMP("PSAPV",0):2 I '$T Q
"RTN","PSABRKU4",7,0)
 S ^XTMP("PSAPV",0)=X_"^"_DT_"^Drug Accountability Prime Vendor Uploaded Invoice Data"
"RTN","PSABRKU4",8,0)
 ;
"RTN","PSABRKU4",9,0)
 ;Sets array of orders & invoices in XTMP (uploaded or processed).
"RTN","PSABRKU4",10,0)
 S PSACTRL=0 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:'PSACTRL  D
"RTN","PSABRKU4",11,0)
 .Q:'$D(^XTMP("PSAPV",PSACTRL,"IN"))
"RTN","PSABRKU4",12,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN")
"RTN","PSABRKU4",13,0)
 .;DAVE B PSA*3*3 - Incomplete invoice deletion
"RTN","PSABRKU4",14,0)
 .I $P(PSAIN,"^",2)=""!($P(PSAIN,"^",4)="") K ^XTMP("PSAPV",PSACTRL) Q
"RTN","PSABRKU4",15,0)
 .S PSADUP($P(PSAIN,"^",4),$P(PSAIN,"^",2))=$S($P(PSAIN,"^",8)="P":"P",1:"U")
"RTN","PSABRKU4",16,0)
DUPLICAT ;
"RTN","PSABRKU4",17,0)
 ;Sets XTMP if incoming order & invoice is not a duplicate.
"RTN","PSABRKU4",18,0)
 S (PSACTRL,PSADUP)=0
"RTN","PSABRKU4",19,0)
 F  S PSACTRL=$O(^TMP($J,"PSAPV SET",PSACTRL)) S PSASET=PSACTRL Q:PSACTRL=""  D  S PSACTRL=PSASET
"RTN","PSABRKU4",20,0)
DAV .;
"RTN","PSABRKU4",21,0)
 .I $D(^XTMP("PSAPV",PSASET,"IN")) S DATA=^("IN") I $P(^TMP($J,"PSAPV SET",PSACTRL,"IN"),"^",4)'=$P(DATA,"^",4),$P(^TMP($J,"PSAPV SET",PSACTRL,"IN"),"^",2)'=$P(DATA,"^",2) S PSACHKR=1
"RTN","PSABRKU4",22,0)
 .I $D(PSACHKR) F  S PSASET=$G(PSASET)+.01 I '$D(^XTMP("PSAPV",PSASET)) K PSACHKR Q
"RTN","PSABRKU4",23,0)
 .;
"RTN","PSABRKU4",24,0)
 .S PSASEG="" F  S PSASEG=$O(^TMP($J,"PSAPV SET",PSACTRL,PSASEG)) Q:PSASEG=""  S PSADUP=0 D
"RTN","PSABRKU4",25,0)
 ..I PSASEG'="IT" D  Q
"RTN","PSABRKU4",26,0)
 ...I PSASEG="IN" S PSAIN=^TMP($J,"PSAPV SET",PSACTRL,PSASEG) D  Q
"RTN","PSABRKU4",27,0)
 ....I $P(PSAIN,"^",2)=""!($P(PSAIN,"^",4)="") K ^TMP($J,"PSAPV SET",PSACTRL) Q
"RTN","PSABRKU4",28,0)
 ....D CHKDUP Q:PSADUP
"RTN","PSABRKU4",29,0)
 ....S ^XTMP("PSAPV",PSASET,"IN")=^TMP($J,"PSAPV SET",PSACTRL,PSASEG)
"RTN","PSABRKU4",30,0)
 ....D DATES
"RTN","PSABRKU4",31,0)
 ....S PSAORD=$P($G(^TMP($J,"PSAPV SET",PSACTRL,"IN")),"^",4),PSAINV=$P($G(^("IN")),"^",2),PSAORDDT=$P($G(^("IN")),"^",3),PSAINVDT=$P($G(^("IN")),"^")
"RTN","PSABRKU4",32,0)
 ....S PSAGUI2(PSAORD)="",PSAGUI3(PSAINV)=""
"RTN","PSABRKU4",33,0)
 ....S ^TMP($J,"PSA GUI",PSAORD,PSAINV)=""
"RTN","PSABRKU4",34,0)
 ...I PSASEG'="IN" S ^XTMP("PSAPV",PSASET,PSASEG)=^TMP($J,"PSAPV SET",PSACTRL,PSASEG)
"RTN","PSABRKU4",35,0)
 ..I PSASEG="IT" S PSALINE=0 F  S PSALINE=$O(^TMP($J,"PSAPV SET",PSACTRL,PSASEG,PSALINE)) Q:'PSALINE  S ^XTMP("PSAPV",PSASET,PSASEG,PSALINE)=^TMP($J,"PSAPV SET",PSACTRL,PSASEG,PSALINE),PSAGUI4=$G(PSAGUI4)+1
"RTN","PSABRKU4",36,0)
 .K ^TMP($J,"PSAPV SET",PSACTRL)
"RTN","PSABRKU4",37,0)
 .I '$D(^XTMP("PSAPV",PSASET,"IT")) K ^XTMP("PSAPV",PSASET)
"RTN","PSABRKU4",38,0)
 L -^XTMP("PSAPV",0)
"RTN","PSABRKU4",39,0)
 Q
"RTN","PSABRKU4",40,0)
 ;
"RTN","PSABRKU4",41,0)
CHKDUP ;Checks for duplicate orders & invoices and duplicates in XTMP.
"RTN","PSABRKU4",42,0)
 I $D(PSADUP($P(PSAIN,"^",4),$P(PSAIN,"^",2))) S PSASTA=PSADUP($P(PSAIN,"^",4),$P(PSAIN,"^",2)),PSADUP=1 D  Q
"RTN","PSABRKU4",43,0)
 .S X12="** Order# "_$P(PSAIN,"^",4)_", invoice# "_$P(PSAIN,"^",2)_" has been "
"RTN","PSABRKU4",44,0)
 .I PSASTA="U" S X12=X12_"uploaded and" D SETMSG^PSABRKU8 S X12="is awaiting processing. It cannot be uploaded more than once." D SETMSG^PSABRKU8
"RTN","PSABRKU4",45,0)
 .I PSASTA'="U" S X12=X12_" processed and" D SETMSG^PSABRKU8 S X12="is being prepared for verification. It cannot be uploaded more than once." D SETMSG^PSABRKU8
"RTN","PSABRKU4",46,0)
 .K ^TMP($J,"PSAPV SET",PSACTRL) Q
"RTN","PSABRKU4",47,0)
 ;
"RTN","PSABRKU4",48,0)
 Q:'$D(^PSD(58.811,"AORD",$P(PSAIN,"^",4),$P(PSAIN,"^",2)))
"RTN","PSABRKU4",49,0)
 ;
"RTN","PSABRKU4",50,0)
 ;Checks for duplicates in 58.811
"RTN","PSABRKU4",51,0)
 S PSAORD=$P(PSAIN,"^",4),PSAINV=$P(PSAIN,"^",2),PSAORDN=$O(^PSD(58.811,"B",PSAORD,0)) Q:'PSAORDN
"RTN","PSABRKU4",52,0)
 S PSAINVN=$O(^PSD(58.811,PSAORDN,1,"B",PSAINV,0)) Q:'PSAINVN
"RTN","PSABRKU4",53,0)
 Q:'$D(^PSD(58.811,PSAORDN,1,PSAINVN,0))
"RTN","PSABRKU4",54,0)
 S PSAIN=^PSD(58.811,PSAORDN,1,PSAINVN,0),PSASTA=$P(PSAIN,"^",3),PSAPC=$S(PSASTA="P":6,PSASTA="V"!(PSASTA="C"):8,1:0)
"RTN","PSABRKU4",55,0)
 S (PSADT,PSALINE)=0 F  S PSALINE=$O(^PSD(58.811,PSAORDN,1,PSAINVN,1,PSALINE)) Q:'PSALINE!($G(PSADT))  S PSADT=+$P($G(^PSD(58.811,PSAORDN,1,PSAINVN,1,PSALINE,0)),"^",PSAPC)
"RTN","PSABRKU4",56,0)
 S X12="** Order# "_PSAORD_" Invoice# "_PSAINV
"RTN","PSABRKU4",57,0)
 S:+PSADT PSADT=$E(PSADT,4,5)_"/"_$E(PSADT,6,7)_"/"_$E(PSADT,2,3)
"RTN","PSABRKU4",58,0)
 I PSASTA="P" S X12=X12_" has been processed"_$S(+PSADT:" on "_PSADT,1:"")_" and" D SETMSG^PSABRKU8 S X12="    is awaiting verification. It cannot be uploaded more than once." D SETMSG^PSABRKU8
"RTN","PSABRKU4",59,0)
 I PSASTA="V" S X12=X12_"   has been verified"_$S(+PSADT:" on "_PSADT,1:"")_"and" D SETMSG^PSABRKU8 S X12="   is updating the pharmacy location. It cannot be uploaded more than once." D SETMSG^PSABRKU8
"RTN","PSABRKU4",60,0)
 I PSASTA="C" S X12=X12_" has been completed." D SETMSG^PSABRKU8 S X12="   It cannot be uploaded more than once." D SETMSG^PSABRKU8
"RTN","PSABRKU4",61,0)
 ;
"RTN","PSABRKU4",62,0)
KILLDUP S PSADUP=1
"RTN","PSABRKU4",63,0)
 K ^TMP($J,"PSAPV SET",PSACTRL),^XTMP("PSAPV",PSASET)
"RTN","PSABRKU4",64,0)
 Q
"RTN","PSABRKU4",65,0)
PRT2 ;Extended help to second "Print invoices?"
"RTN","PSABRKU4",66,0)
 W !?5,"Enter YES to print all invoices that are not processed and",!?5,"the invoices that were processed while you were in this option.",!!?5,"Enter NO to exit the option."
"RTN","PSABRKU4",67,0)
 Q
"RTN","PSABRKU4",68,0)
YNPRINT ;Extended help to "Print invoices?"
"RTN","PSABRKU4",69,0)
 W !?5,"Enter YES to print the uploaded invoices. You",!?5,"can check the invoices prior to processing them.",!!?5,"Enter NO to not print the invoices."
"RTN","PSABRKU4",70,0)
 Q
"RTN","PSABRKU4",71,0)
 ;
"RTN","PSABRKU4",72,0)
YNPROCES ;Extended help to "Do you want to process the invoices now?"
"RTN","PSABRKU4",73,0)
 W !?5,"Enter YES to begin processing the uploaded invoices.",!!?5,"Enter NO if you do not want to process the invoices now. You can process"
"RTN","PSABRKU4",74,0)
 W !?5,"them later by selecting the ""Process Uploaded Prime Vendor Invoice Data"" option."
"RTN","PSABRKU4",75,0)
 Q
"RTN","PSABRKU4",76,0)
 ;
"RTN","PSABRKU4",77,0)
YNUPLOAD ;Extended help to "Are you ready to upload the prime vendor invoice data?"
"RTN","PSABRKU4",78,0)
 W !?5,"Enter YES to start uploading the invoices.",!?5,"Enter NO or ""^"" to exit the option."
"RTN","PSABRKU4",79,0)
 Q
"RTN","PSABRKU4",80,0)
 ;
"RTN","PSABRKU4",81,0)
DATES ;PSA*3*12 Check for Y2K compliance of dates
"RTN","PSABRKU4",82,0)
 S DATECHK=0
"RTN","PSABRKU4",83,0)
 F X=1,3,5,6 S XX=$P(^XTMP("PSAPV",PSASET,"IN"),"^",X) I $L(XX)=8 S XXX=($E(XX,1,4)-1700)_$E(XX,5,8),$P(^XTMP("PSAPV",PSASET,"IN"),"^",X)=XXX,DATECHK=1
"RTN","PSABRKU4",84,0)
 I DATECHK Q
"RTN","PSABRKU4",85,0)
 S LWRDT=$E(DT,1,3)-70,UPPRDT=$E(DT,1,3)+30
"RTN","PSABRKU4",86,0)
 F Y=1,3,5,6 S DT1=$E(DT,1)_$E($P(^XTMP("PSAPV",PSASET,"IN"),"^",Y),1,2),$P(^XTMP("PSAPV",PSASET,"IN"),"^",Y)=$S((DT1>LWRDT&(DT1<UPPRDT)):$E(DT1)_$P(^XTMP("PSAPV",PSASET,"IN"),"^",Y),1:($E(DT1,1)+1)_$P(^XTMP("PSAPV",PSASET,"IN"),"^",Y))
"RTN","PSABRKU4",87,0)
 F X=1,3,5,6 S XX=$P(^XTMP("PSAPV",PSASET,"IN"),"^",X) I XX>(DT+300000) S XXX=$E(XX,1)-2,$P(^XTMP("PSAPV",PSASET,"IN"),"^",X)=XXX_$E(XX,2,99)
"RTN","PSABRKU4",88,0)
 F X=1,3,5,6 S XX=$P(^XTMP("PSAPV",PSASET,"IN"),"^",X) I XX'?7N S $P(^XTMP("PSAPV",PSASET,"IN"),"^",X)=DT
"RTN","PSABRKU4",89,0)
 K LWRDT,UPPRDT,DT1,X,Y,XXX,XX
"RTN","PSABRKU5")
0^5^B2524103
"RTN","PSABRKU5",1,0)
PSABRKU5 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data - CONT'D ;7/23/97
"RTN","PSABRKU5",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**26**; 10/24/97
"RTN","PSABRKU5",3,0)
 ;This routine checks for correct X12 formating.
"RTN","PSABRKU5",4,0)
 ;
"RTN","PSABRKU5",5,0)
ORDER ;  check order of code sheets
"RTN","PSABRKU5",6,0)
 ;  isa   <--------------+
"RTN","PSABRKU5",7,0)
 ;    gs    <----------+ |
"RTN","PSABRKU5",8,0)
 ;      st    <------+ | |
"RTN","PSABRKU5",9,0)
 ;      | big        | | |
"RTN","PSABRKU5",10,0)
 ;      | it1   <--+ | | |
"RTN","PSABRKU5",11,0)
 ;      | ...      | | | |--repeats
"RTN","PSABRKU5",12,0)
 ;      | it1   <--+ | | |
"RTN","PSABRKU5",13,0)
 ;      | ctt        | | |
"RTN","PSABRKU5",14,0)
 ;      se    <------+ | |
"RTN","PSABRKU5",15,0)
 ;    ge    <----------+ |
"RTN","PSABRKU5",16,0)
 ;  iea   <--------------+
"RTN","PSABRKU5",17,0)
 S PSANEXT=$P(PSADATA,"^")
"RTN","PSABRKU5",18,0)
 ;
"RTN","PSABRKU5",19,0)
 I PSALAST="GE",PSANEXT="GS" Q
"RTN","PSABRKU5",20,0)
 I PSALAST="GE",PSANEXT'="IEA" D ORDERROR("GE",PSANEXT,"IEA") Q
"RTN","PSABRKU5",21,0)
 ;
"RTN","PSABRKU5",22,0)
 I PSALAST="ISA",PSANEXT'="GS" D ORDERROR("ISA",PSANEXT,"GS") Q
"RTN","PSABRKU5",23,0)
 ;
"RTN","PSABRKU5",24,0)
 I PSALAST="SE",PSANEXT="ST" Q
"RTN","PSABRKU5",25,0)
 I PSALAST="SE",PSANEXT'="GE" D ORDERROR("SE",PSANEXT,"GE") Q
"RTN","PSABRKU5",26,0)
 ;
"RTN","PSABRKU5",27,0)
 I PSALAST="GS",PSANEXT'="ST" D ORDERROR("GS",PSANEXT,"ST") Q
"RTN","PSABRKU5",28,0)
 ;
"RTN","PSABRKU5",29,0)
 I PSALAST="CTT",PSANEXT'="SE" D ORDERROR("CTT",PSANEXT,"SE") Q
"RTN","PSABRKU5",30,0)
 ;
"RTN","PSABRKU5",31,0)
 I PSALAST="ST",PSANEXT'="BIG" D ORDERROR("ST",PSANEXT,"BIG") Q
"RTN","PSABRKU5",32,0)
 ;
"RTN","PSABRKU5",33,0)
 I PSALAST="IT1",PSANEXT="IT1" Q
"RTN","PSABRKU5",34,0)
 I PSALAST="IT1",PSANEXT'="CTT"&(PSANEXT'="TDS") D ORDERROR("IT1",PSANEXT,"CTT") Q
"RTN","PSABRKU5",35,0)
 Q
"RTN","PSABRKU5",36,0)
 ;
"RTN","PSABRKU5",37,0)
ORDERROR(PSALAST,PSANEW,PSAEXPEC) ;Segments out of order
"RTN","PSABRKU5",38,0)
 ;ISA segment should be first
"RTN","PSABRKU5",39,0)
 I PSALAST="" S PSASEG="ORDER1" D MSG^PSABRKU8 Q
"RTN","PSABRKU5",40,0)
 ;Segments other than ISA
"RTN","PSABRKU5",41,0)
 S PSASEG="ORDER2" D MSG^PSABRKU8
"RTN","PSABRKU5",42,0)
 Q
"RTN","PSABRKU6")
0^6^B63560640
"RTN","PSABRKU6",1,0)
PSABRKU6 ;BIR/DB-Upload and Process Prime Vendor Invoice Data - CONT'D ;10/9/97
"RTN","PSABRKU6",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**26**; 10/24/97
"RTN","PSABRKU6",3,0)
 ;This routine looks in the DRUG file for each line item on the order.
"RTN","PSABRKU6",4,0)
 ;It looks for the NDC then VSN. If it is not found, no data is stored.
"RTN","PSABRKU6",5,0)
 ;
"RTN","PSABRKU6",6,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSABRKU6",7,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSABRKU6",8,0)
 S PSAGUI1=0 ;Counter for Order Unit conversions
"RTN","PSABRKU6",9,0)
 S PSAGUI5=0 ;matched NDC counter
"RTN","PSABRKU6",10,0)
 S PSAGUI6=0 ;matched VSN counter
"RTN","PSABRKU6",11,0)
 S PSAGUI7=0 ;matched Supply Item counter
"RTN","PSABRKU6",12,0)
 S PSACTRL=0 F  S PSACTRL=$O(^XTMP("PSAPV",PSACTRL)) Q:PSACTRL=""  D
"RTN","PSABRKU6",13,0)
 .I '$D(^XTMP("PSAPV",PSACTRL,"IN"))!($P($G(^XTMP("PSAPV",PSACTRL,"IN")),"^",8)="P") Q
"RTN","PSABRKU6",14,0)
 .S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSAORD=$P(PSAIN,"^",4),PSAINV=$P(PSAIN,"^",2),PSACS=0
"RTN","PSABRKU6",15,0)
 .S PSALINE=0 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  D
"RTN","PSABRKU6",16,0)
 ..Q:'$D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE))  Q:$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="P"
"RTN","PSABRKU6",17,0)
 ..S PSAOK=1,PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE),PSANDC=$P(PSADATA,"^",4),PSAVSN=$P(PSADATA,"^",5)
"RTN","PSABRKU6",18,0)
 ..DO GETDRUG ;W "."
"RTN","PSABRKU6",19,0)
 ..S:PSAOK $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="OK"
"RTN","PSABRKU6",20,0)
 .S (PSACNT,PSALLCS,PSALLOK,PSASUP)=0
"RTN","PSABRKU6",21,0)
 .S:PSACS $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",9)="CS"
"RTN","PSABRKU6",22,0)
 .S PSALINE=0 F  S PSALINE=+$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:'PSALINE  D
"RTN","PSABRKU6",23,0)
 ..S PSACNT=PSACNT+1
"RTN","PSABRKU6",24,0)
 ..S:$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="CS" PSALLCS=PSALLCS+1
"RTN","PSABRKU6",25,0)
 ..S:$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",18)="OK" PSALLOK=PSALLOK+1
"RTN","PSABRKU6",26,0)
 ..S:'+$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6) PSASUP=PSASUP+1
"RTN","PSABRKU6",27,0)
 .I PSACNT=PSASUP S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",13)="SUP"
"RTN","PSABRKU6",28,0)
 .I PSACNT=PSALLCS S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",10)="ALL CS"
"RTN","PSABRKU6",29,0)
 .I PSACNT=PSALLOK S $P(^XTMP("PSAPV",PSACTRL,"IN"),"^",8)="OK"
"RTN","PSABRKU6",30,0)
 Q
"RTN","PSABRKU6",31,0)
 ;
"RTN","PSABRKU6",32,0)
GETDRUG ;Looks for NDC then VSNs in DRUG file.
"RTN","PSABRKU6",33,0)
 I $D(PSANDC) S PSANDC=$P(PSANDC,"~")
"RTN","PSABRKU6",34,0)
 I $D(PSAVSN) S PSAVSN=$P(PSAVSN,"~")
"RTN","PSABRKU6",35,0)
 G:PSANDC=0 GETVSN
"RTN","PSABRKU6",36,0)
 I PSANDC'="" S PSAIEN=+$O(^PSDRUG("C",PSANDC,0)) I PSAIEN S PSASUB=+$O(^PSDRUG("C",PSANDC,PSAIEN,0)) G FOUND
"RTN","PSABRKU6",37,0)
 ;
"RTN","PSABRKU6",38,0)
GETVSN ;Looks for Vendor Stock Number then NDC.
"RTN","PSABRKU6",39,0)
 I PSAVSN'="" S PSAIEN=+$O(^PSDRUG("AVSN",PSAVSN,0)) I PSAIEN S PSASUB=+$O(^PSDRUG("AVSN",PSAVSN,PSAIEN,0)) G FOUND
"RTN","PSABRKU6",40,0)
 I $G(PSAVSN)'="" S PSAMTCH=0,PSASUPPL=0 D
"RTN","PSABRKU6",41,0)
 .F  S PSAMTCH=$O(^XTMP("PSA SUPPLY",PSAMTCH)) Q:PSAMTCH'>0  S DATA=^XTMP("PSA SUPPLY",PSAMTCH,0) I $P(DATA,"^",2)=PSAVSN D
"RTN","PSABRKU6",42,0)
 ..;Found match on supply item
"RTN","PSABRKU6",43,0)
 ..S ^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")="UPLOAD GUI"_"^"_DT_"^"_$P(DATA,"^",1)
"RTN","PSABRKU6",44,0)
 ..S PSAGUI7=$G(PSAGUI7)+1,PSASUPPL=1
"RTN","PSABRKU6",45,0)
 I $G(PSASUPPL)>0 G VSN
"RTN","PSABRKU6",46,0)
 ;
"RTN","PSABRKU6",47,0)
 I (PSANDC=""&PSAVSN=""),$P(PSADATA,"^",26)'="" D ^PSAUP6
"RTN","PSABRKU6",48,0)
 ;
"RTN","PSABRKU6",49,0)
 S:'+$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6) PSAOK=0
"RTN","PSABRKU6",50,0)
 G UOM
"RTN","PSABRKU6",51,0)
 ;
"RTN","PSABRKU6",52,0)
FOUND ;Store line item data if ordered item was found in DRUG file.
"RTN","PSABRKU6",53,0)
 I $P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" S PSACS=1,$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="CS"
"RTN","PSABRKU6",54,0)
 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,$P(^(PSALINE),"^",7)=PSASUB
"RTN","PSABRKU6",55,0)
 ;
"RTN","PSABRKU6",56,0)
NDC ;If >1 NDC in DRUG file, store how many.
"RTN","PSABRKU6",57,0)
 ;^XTMP $P4=NDC ~ # of nodes with same VSN (if >1 NDC) ~ VSN if different
"RTN","PSABRKU6",58,0)
 ;          than one on SYNONYM multiple (if 1 NDC)
"RTN","PSABRKU6",59,0)
 I PSANDC'="",$O(^PSDRUG("C",PSANDC,0)) D
"RTN","PSABRKU6",60,0)
 .S (PSACNT,PSACNT1,PSAFND,PSAFND1,PSAIEN50)=0
"RTN","PSABRKU6",61,0)
 .;
"RTN","PSABRKU6",62,0)
 .F  S PSAIEN50=+$O(^PSDRUG("C",PSANDC,PSAIEN50)) Q:'PSAIEN50  I '$D(^PSDRUG(PSAIEN50,"I")) S PSASYN=0 F  S PSASYN=+$O(^PSDRUG("C",PSANDC,PSAIEN50,PSASYN)) Q:'PSASYN  D
"RTN","PSABRKU6",63,0)
 ..Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSABRKU6",64,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^",4)=PSAVSN S PSAFND=PSAFND+1,PSAFND1=PSAIEN50_"^"_PSASYN Q
"RTN","PSABRKU6",65,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^",4)'=PSAVSN S PSACNT=PSACNT+1,PSACNT1=PSAIEN50_"^"_PSASYN
"RTN","PSABRKU6",66,0)
 .;
"RTN","PSABRKU6",67,0)
 .;If NDC & VSN match, set ^XTMP
"RTN","PSABRKU6",68,0)
 .I PSAFND=1 S PSAIEN=$P(PSAFND1,"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSAFND1,"^",2),$P(^(PSALINE),"^",7)=PSASUB,$P(^(PSALINE),"^",4)=PSANDC Q
"RTN","PSABRKU6",69,0)
 .;
"RTN","PSABRKU6",70,0)
 .;If >1 with same NDC & VSN, set # with same NDC & VSN in ^XTMP & flag
"RTN","PSABRKU6",71,0)
 .I PSAFND>1 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)_"~"_PSAFND,PSAOK=0 Q
"RTN","PSABRKU6",72,0)
 .;
"RTN","PSABRKU6",73,0)
 .;If 1 NDC and ...
"RTN","PSABRKU6",74,0)
 .I PSACNT=1 S PSAIEN=$P(PSACNT1,"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSACNT1,"^",2),$P(^(PSALINE),"^",7)=PSASUB D  Q
"RTN","PSABRKU6",75,0)
 ..;VSN is null, accept as found & set ^XTMP
"RTN","PSABRKU6",76,0)
 ..I $P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",4)="" S PSAIEN=$P(PSACNT1,"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSACNT1,"^",2),$P(^(PSALINE),"^",7)=PSASUB,$P(^(PSALINE),"^",4)=PSANDC Q
"RTN","PSABRKU6",77,0)
 ..;Different VSN, set VSN in NDC piece in ^XTMP
"RTN","PSABRKU6",78,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)_"~~"_$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",4),PSAOK=0
"RTN","PSABRKU6",79,0)
 .;
"RTN","PSABRKU6",80,0)
 .;If >1 NDC with differnt VSN, set flag in NDC piece of ^XTMP
"RTN","PSABRKU6",81,0)
 .I PSACNT>1 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)_"~"_PSACNT,PSAOK=0
"RTN","PSABRKU6",82,0)
 ;
"RTN","PSABRKU6",83,0)
VSN ;If there >1 VSN with same VSN, store how many.
"RTN","PSABRKU6",84,0)
 ;^XTMP $P5=VSN ~ # of nodes with same UOM (if >1 VSN) ~ NDC if different
"RTN","PSABRKU6",85,0)
 ;          than one on SYNONYM multiple (if 1 VSN)
"RTN","PSABRKU6",86,0)
 I PSAVSN'="",$O(^PSDRUG("AVSN",PSAVSN,0))  D
"RTN","PSABRKU6",87,0)
 .S (PSACNT,PSACNT1,PSAFND,PSAFND1,PSAIEN50)=0
"RTN","PSABRKU6",88,0)
 .;
"RTN","PSABRKU6",89,0)
 .;DAVE B (PSA*3*2)
"RTN","PSABRKU6",90,0)
 .F  S PSAIEN50=+$O(^PSDRUG("AVSN",PSAVSN,PSAIEN50)) Q:'PSAIEN50  I '$D(^PSDRUG(PSAIEN50,"I")) S PSASYN=0 F  S PSASYN=+$O(^PSDRUG("AVSN",PSAVSN,PSAIEN50,PSASYN)) Q:'PSASYN  D
"RTN","PSABRKU6",91,0)
 ..Q:'$D(^PSDRUG(PSAIEN50,1,PSASYN,0))
"RTN","PSABRKU6",92,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^")=PSANDC S PSAFND=PSAFND+1,PSAFND1=PSAIEN50_"^"_PSASYN Q
"RTN","PSABRKU6",93,0)
 ..I $P(^PSDRUG(PSAIEN50,1,PSASYN,0),"^")'=PSANDC S PSACNT=PSACNT+1,PSACNT1=PSAIEN50_"^"_PSASYN
"RTN","PSABRKU6",94,0)
 .;
"RTN","PSABRKU6",95,0)
 .;If VSN & NDC match, set ^XTMP
"RTN","PSABRKU6",96,0)
 .I PSAFND=1 D  Q
"RTN","PSABRKU6",97,0)
 ..I '+$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6) D
"RTN","PSABRKU6",98,0)
 ...S PSAIEN=$P(PSAFND1,"^"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSAFND1,"^",2),$P(^(PSALINE),"^",7)=PSASUB
"RTN","PSABRKU6",99,0)
 ...S:$P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="CS",PSACS=1
"RTN","PSABRKU6",100,0)
 ...S:$P($G(^PSDRUG(PSAIEN,2)),"^",3)'["N" $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",19)="",PSACS=0
"RTN","PSABRKU6",101,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=PSAVSN
"RTN","PSABRKU6",102,0)
 .;
"RTN","PSABRKU6",103,0)
 .;If >1 with same VSN & NDC, set # with same NDC & VSN in ^XTMP & flag
"RTN","PSABRKU6",104,0)
 .I PSAFND>1 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)_"~"_PSAFND,PSAOK=0 Q
"RTN","PSABRKU6",105,0)
 .;
"RTN","PSABRKU6",106,0)
 .;If 1 VSN and ...
"RTN","PSABRKU6",107,0)
 .I PSACNT=1 D  Q
"RTN","PSABRKU6",108,0)
 ..I '+$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6) S PSAIEN=$P(PSACNT1,"^"),$P(^(PSALINE),"^",6)=PSAIEN,PSASUB=$P(PSACNT1,"^",2),$P(^(PSALINE),"^",7)=PSASUB
"RTN","PSABRKU6",109,0)
 ..;NDC is null, accept as found & set ^XTMP
"RTN","PSABRKU6",110,0)
 ..I $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)="" S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=PSAVSN,$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",4)=$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^") Q
"RTN","PSABRKU6",111,0)
 ..;Different VSN, set VSN in NDC piece in ^XTMP
"RTN","PSABRKU6",112,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)_"~~"_$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^"),PSAOK=0
"RTN","PSABRKU6",113,0)
 .;
"RTN","PSABRKU6",114,0)
 .;If >1 VSN with different NDC, set flag in NDC piece of ^XTMP
"RTN","PSABRKU6",115,0)
 .I PSACNT>1 S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",5)_"~"_PSACNT,PSAOK=0
"RTN","PSABRKU6",116,0)
 ;
"RTN","PSABRKU6",117,0)
UOM ;Locates X12 Unit of Measure Code in ORDER UNIT file.
"RTN","PSABRKU6",118,0)
 ;^XTMP $P2=Alpha OU ~ 51.5 IEN
"RTN","PSABRKU6",119,0)
 K PSAUOM,PSAGUI I $P(PSADATA,"^",2)="" S PSAOK=0 G QTY
"RTN","PSABRKU6",120,0)
 ;
"RTN","PSABRKU6",121,0)
 S PSAUOM=$P($P(PSADATA,"^",2),"~") I $G(PSAUOM)'="",'$D(^DIC(51.5,"B",PSAUOM)),$D(^PSD(58.812,1,"OU","C",PSALINE)) D
"RTN","PSABRKU6",122,0)
 .S XIEN=$O(^PSD(58.812,1,"OU","C",PSALINE,0)) I $P($G(^PSD(58.812,1,"OU",XIEN,0)),"^",1)=PSAUOM S PSAUOMN=$P(^PSD(58.812,1,"OU",XIEN,0),"^",2),PSAUOM=$P($G(^DIC(51.5,PSAUOMN,0)),"^",1),PSAGUI1=$G(PSAGUI1)+1,PSAGUI=1
"RTN","PSABRKU6",123,0)
 I $G(PSAGUI)=1 D
"RTN","PSABRKU6",124,0)
 .;found unit of measure match i GUI file
"RTN","PSABRKU6",125,0)
 .S PSAUOMN=$O(^DIC(51.5,"B",PSAUOM,0)),PSAGUI=1
"RTN","PSABRKU6",126,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",2)=PSAUOM_"~"_PSAUOMN
"RTN","PSABRKU6",127,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",12)=PSAUOM
"RTN","PSABRKU6",128,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",13)=.5 ;Assign to POSTMASTER
"RTN","PSABRKU6",129,0)
 .S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",14)=DT
"RTN","PSABRKU6",130,0)
 I $G(PSAGUI)=1 K PSAGUI G QTY
"RTN","PSABRKU6",131,0)
 ;If order unit is standard order unit, set IEN in ^XTMP
"RTN","PSABRKU6",132,0)
 S PSAUOM=$O(^DIC(51.5,"B",$P($P(PSADATA,"^",2),"~"),0))
"RTN","PSABRKU6",133,0)
 I 'PSAUOM D  Q:'PSAOK
"RTN","PSABRKU6",134,0)
 .I +$P(PSADATA,"^",6),+$P(PSADATA,"^",7),+$P($G(^PSDRUG(PSAIEN,1,+$P(PSADATA,"^",7),0)),"^",5) D
"RTN","PSABRKU6",135,0)
 ..S PSAUOM=+$P($G(^PSDRUG(PSAIEN,1,+$P(PSADATA,"^",7),0)),"^",5),PSAUOMN=$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",2),"~")
"RTN","PSABRKU6",136,0)
 ..S $P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",2)=PSAUOMN_"~"_PSAUOM K PSAUOMN
"RTN","PSABRKU6",137,0)
 .S:'PSAUOM PSAOK=0
"RTN","PSABRKU6",138,0)
 I PSAUOM S PSAUOMN=$P($P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",2),"~"),$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",2)=PSAUOMN_"~"_PSAUOM K PSAUOMN
"RTN","PSABRKU6",139,0)
 ;
"RTN","PSABRKU6",140,0)
QTY ;If qty is 0 or blank, set flag
"RTN","PSABRKU6",141,0)
 I '+$P(PSADATA,"^") S PSAOK=0 Q
"RTN","PSABRKU6",142,0)
 ;
"RTN","PSABRKU6",143,0)
DUOU ;If no dispense units per order unit, set flag.
"RTN","PSABRKU6",144,0)
 S PSADRG=$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE),"^",6),PSASYN=$P(^(PSALINE),"^",7)
"RTN","PSABRKU6",145,0)
 S:'PSASYN PSAOK=0
"RTN","PSABRKU6",146,0)
 I PSASYN,'$P($G(^PSDRUG(PSADRG,1,PSASYN,0)),"^",7) S PSAOK=0
"RTN","PSABRKU6",147,0)
 Q
"RTN","PSABRKU8")
0^7^B14875027
"RTN","PSABRKU8",1,0)
PSABRKU8 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data Utility ;9/19/97
"RTN","PSABRKU8",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**26**; 10/24/97
"RTN","PSABRKU8",3,0)
 ;This routine is a utility that writes X12 errors to the screen. It is
"RTN","PSABRKU8",4,0)
 ;used during the uploading of prime vendor invoices. It is called by
"RTN","PSABRKU8",5,0)
 ;PSAUP2 and PSAUP3.
"RTN","PSABRKU8",6,0)
 ;
"RTN","PSABRKU8",7,0)
ERROR ;Writes X12 error messages.
"RTN","PSABRKU8",8,0)
 S PSASLN="",$P(PSASLN,"-",80)=""
"RTN","PSABRKU8",9,0)
 S X12="The format of the invoice file is incorrect." D SETMSG
"RTN","PSABRKU8",10,0)
 S X12="Call your IRM staff and relay the error messages listed below." D SETMSG
"RTN","PSABRKU8",11,0)
 S X12="  " D SETMSG S X12="ERROR MESSAGES:" D SETMSG S X12=PSASLN D SETMSG
"RTN","PSABRKU8",12,0)
 S PSACTRL2="" F  S PSACTRL2=$O(PSAERR(PSACTRL2)) Q:PSACTRL2=""  S X12="Control# "_PSACTRL2_":" D SETMSG D
"RTN","PSABRKU8",13,0)
 .S PSASEG="" F  S PSASEG=$O(PSAERR(PSACTRL2,PSASEG)) Q:PSASEG=""  S X12=PSAERR(PSACTRL2,PSASEG) D SETMSG
"RTN","PSABRKU8",14,0)
 Q
"RTN","PSABRKU8",15,0)
MSG S:$G(PSACTRL)="" PSACTRL="UNKNOWN"
"RTN","PSABRKU8",16,0)
 I PSASEG="ISA" S PSAERR(PSACTRL,PSASEG)="The ISA control# (piece 14) should be 9 characters in length." Q
"RTN","PSABRKU8",17,0)
 I PSASEG="IEA" S PSAERR(PSACTRL,PSASEG)="The IEA control# (piece 3) should equal the ISA control# (piece 14 = "_$P($G(PSAISA),"^",14)_")" Q
"RTN","PSABRKU8",18,0)
 I PSASEG="GS" S PSAERR(PSACTRL,PSASEG)="GS piece "_%_" should equal ISA's piece "_$G(PSAPC)_" ("_$TR($P($G(PSAISA),"^",$G(PSAPC))," ")_")." Q
"RTN","PSABRKU8",19,0)
 I PSASEG="GE" S PSAERR(PSACTRL,PSASEG)="The GE control# (piece 3) should equal GS's control# piece 7 ("_$P($G(PSAGS),"^",7)_")." Q
"RTN","PSABRKU8",20,0)
 I PSASEG="ST" S PSAERR(PSACTRL,PSASEG)="The ST control# (piece 3) should be 4 to 9 characters in length." Q
"RTN","PSABRKU8",21,0)
 I $E(PSASEG,1,2)="SE" D  Q
"RTN","PSABRKU8",22,0)
 .I PSASEG="SE1" S PSAERR(PSACTRL,PSASEG)="The SE control# (piece 3) should be equal to ST's control# (piece 3 = "_PSACTRL_")" Q
"RTN","PSABRKU8",23,0)
 .I PSASEG="SE2" S PSAERR(PSACTRL,PSASEG)="SE's count of segments (piece 2) should equal the number of segments ("_$G(PSASTCNT)_")."
"RTN","PSABRKU8",24,0)
 I PSASEG="N1" S PSAERR(PSACTRL,PSASEG)="N1's piece 2 should equal 'BY', 'DS' OR 'ST'."
"RTN","PSABRKU8",25,0)
 I PSASEG="NONTYPE" S PSAERR(PSACTRL,PSASEG)="The identifier segment 'N1' needs to come before the '"_$P($G(PSADATA),"^")_"' segment." Q
"RTN","PSABRKU8",26,0)
 I PSASEG="CTT" S PSAERR(PSACTRL,PSASEG)="CTT's line item count (piece 2) should equal the number of line items ("_$G(PSAITCNT)_")."
"RTN","PSABRKU8",27,0)
 I $E(PSASEG,1,3)="IT1" D  Q
"RTN","PSABRKU8",28,0)
 .I PSASEG="IT1-1" S PSAERR(PSACTRL,PSASEG)="The IT1 invoice line number "_$G(PSAITEM)_" (piece 2) is not defined." Q
"RTN","PSABRKU8",29,0)
 .I PSASEG="IT1-2" S PSAERR(PSACTRL,PSASEG)="The IT1 unit price code (piece 6) should equal 'DS' for discount." Q
"RTN","PSABRKU8",30,0)
 .I PSASEG="IT1-3" S PSAERR(PSACTRL,PSASEG)="The IT1 does not contain a NDC (piece 8) or an UPC (piece 12)."
"RTN","PSABRKU8",31,0)
 I PSASEG="ORDER1" S PSAERR(PSACTRL,PSASEG)="Segments are out of order. The starting segment should be 'ISA', not '"_$G(PSANEW)_"'." Q
"RTN","PSABRKU8",32,0)
 I PSASEG="ORDER2" S PSAERR(PSACTRL,PSASEG)="Segments are out of order. The segment following '"_$G(PSALAST)_"' should be '"_$G(PSAEXPEC)_"', not '"_$G(PSANEW)_"'."
"RTN","PSABRKU8",33,0)
 Q
"RTN","PSABRKU8",34,0)
NONTYPE ;
"RTN","PSABRKU8",35,0)
 I PSANTYPE="" S PSASEG="NONTYPE" D ERROR
"RTN","PSABRKU8",36,0)
 Q
"RTN","PSABRKU8",37,0)
SETMSG S PSAMCNT=$G(PSAMCNT)+1,^TMP($J,"PSA UPLOAD",PSAMCNT,0)=$G(X12) Q
"VER")
8.0^22.0
**END**
**END**
