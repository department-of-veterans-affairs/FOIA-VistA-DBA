Released GMRA*4*19 SEQ #17
Extracted from mail message
**KIDS**:GMRA*4.0*19^

**INSTALL NAME**
GMRA*4.0*19
"BLD",4922,0)
GMRA*4.0*19^ADVERSE REACTION TRACKING^0^3040518^y
"BLD",4922,1,0)
^^4^4^3040504^^^
"BLD",4922,1,1,0)
Update to allergy tracking package consisting of changes to the free text 
"BLD",4922,1,2,0)
utility distributed in patch GMRA*4*17 as well as updates to send 
"BLD",4922,1,3,0)
bulletins from CPRS GUI upon new allergy entry.  Please see the FORUM 
"BLD",4922,1,4,0)
module for complete details.
"BLD",4922,4,0)
^9.64PA^^
"BLD",4922,"ABPKG")
n
"BLD",4922,"INIT")
Q^GMRAY19
"BLD",4922,"KRN",0)
^9.67PA^8989.52^19
"BLD",4922,"KRN",.4,0)
.4
"BLD",4922,"KRN",.401,0)
.401
"BLD",4922,"KRN",.402,0)
.402
"BLD",4922,"KRN",.403,0)
.403
"BLD",4922,"KRN",.5,0)
.5
"BLD",4922,"KRN",.84,0)
.84
"BLD",4922,"KRN",3.6,0)
3.6
"BLD",4922,"KRN",3.8,0)
3.8
"BLD",4922,"KRN",9.2,0)
9.2
"BLD",4922,"KRN",9.8,0)
9.8
"BLD",4922,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",4922,"KRN",9.8,"NM",1,0)
GMRAFX1^^0^B31454366
"BLD",4922,"KRN",9.8,"NM",2,0)
GMRAFX2^^0^B25571771
"BLD",4922,"KRN",9.8,"NM",3,0)
GMRAFX3^^0^B35679551
"BLD",4922,"KRN",9.8,"NM",4,0)
GMRAPES0^^0^B70524740
"BLD",4922,"KRN",9.8,"NM",5,0)
GMRAOR5^^0^B25377225
"BLD",4922,"KRN",9.8,"NM",6,0)
GMRAY19^^0^B9980438
"BLD",4922,"KRN",9.8,"NM",7,0)
GMRAFX^^0^B89148529
"BLD",4922,"KRN",9.8,"NM",8,0)
GMRASIGN^^0^B37583197
"BLD",4922,"KRN",9.8,"NM",9,0)
GMRASEND^^0^B8913389
"BLD",4922,"KRN",9.8,"NM",10,0)
GMRASEN2^^0^B8074289
"BLD",4922,"KRN",9.8,"NM","B","GMRAFX",7)

"BLD",4922,"KRN",9.8,"NM","B","GMRAFX1",1)

"BLD",4922,"KRN",9.8,"NM","B","GMRAFX2",2)

"BLD",4922,"KRN",9.8,"NM","B","GMRAFX3",3)

"BLD",4922,"KRN",9.8,"NM","B","GMRAOR5",5)

"BLD",4922,"KRN",9.8,"NM","B","GMRAPES0",4)

"BLD",4922,"KRN",9.8,"NM","B","GMRASEN2",10)

"BLD",4922,"KRN",9.8,"NM","B","GMRASEND",9)

"BLD",4922,"KRN",9.8,"NM","B","GMRASIGN",8)

"BLD",4922,"KRN",9.8,"NM","B","GMRAY19",6)

"BLD",4922,"KRN",19,0)
19
"BLD",4922,"KRN",19.1,0)
19.1
"BLD",4922,"KRN",101,0)
101
"BLD",4922,"KRN",409.61,0)
409.61
"BLD",4922,"KRN",771,0)
771
"BLD",4922,"KRN",870,0)
870
"BLD",4922,"KRN",8989.51,0)
8989.51
"BLD",4922,"KRN",8989.52,0)
8989.52
"BLD",4922,"KRN",8994,0)
8994
"BLD",4922,"KRN","B",.4,.4)

"BLD",4922,"KRN","B",.401,.401)

"BLD",4922,"KRN","B",.402,.402)

"BLD",4922,"KRN","B",.403,.403)

"BLD",4922,"KRN","B",.5,.5)

"BLD",4922,"KRN","B",.84,.84)

"BLD",4922,"KRN","B",3.6,3.6)

"BLD",4922,"KRN","B",3.8,3.8)

"BLD",4922,"KRN","B",9.2,9.2)

"BLD",4922,"KRN","B",9.8,9.8)

"BLD",4922,"KRN","B",19,19)

"BLD",4922,"KRN","B",19.1,19.1)

"BLD",4922,"KRN","B",101,101)

"BLD",4922,"KRN","B",409.61,409.61)

"BLD",4922,"KRN","B",771,771)

"BLD",4922,"KRN","B",870,870)

"BLD",4922,"KRN","B",8989.51,8989.51)

"BLD",4922,"KRN","B",8989.52,8989.52)

"BLD",4922,"KRN","B",8994,8994)

"BLD",4922,"QUES",0)
^9.62^^
"BLD",4922,"REQB",0)
^9.611^2^1
"BLD",4922,"REQB",2,0)
GMRA*4.0*17^1
"BLD",4922,"REQB","B","GMRA*4.0*17",2)

"INIT")
Q^GMRAY19
"MBREQ")
0
"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
19^3040518^1326
"PKG",140,22,1,"PAH",1,1,0)
^^4^4^3040518
"PKG",140,22,1,"PAH",1,1,1,0)
Update to allergy tracking package consisting of changes to the free text 
"PKG",140,22,1,"PAH",1,1,2,0)
utility distributed in patch GMRA*4*17 as well as updates to send 
"PKG",140,22,1,"PAH",1,1,3,0)
bulletins from CPRS GUI upon new allergy entry.  Please see the FORUM 
"PKG",140,22,1,"PAH",1,1,4,0)
module for complete details.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","GMRAFX")
0^7^B89148529
"RTN","GMRAFX",1,0)
GMRAFX ;SLC/DAN Fix existing free text entries ;5/4/04  12:40
"RTN","GMRAFX",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19**;Mar 29, 1996
"RTN","GMRAFX",3,0)
 ;DBIA SECTION
"RTN","GMRAFX",4,0)
 ;10118 - VALM
"RTN","GMRAFX",5,0)
 ;2056  - DIQ
"RTN","GMRAFX",6,0)
 ;3744  - $$TESTPAT^VADPT
"RTN","GMRAFX",7,0)
 ;10006 - DIC
"RTN","GMRAFX",8,0)
 ;10103 - XLFDT
"RTN","GMRAFX",9,0)
 ;10102 - XQORM1
"RTN","GMRAFX",10,0)
 ;10104 - XLFSTR
"RTN","GMRAFX",11,0)
 ;10117 - VALM10
"RTN","GMRAFX",12,0)
 ;10116 - VALM1
"RTN","GMRAFX",13,0)
 ;10026 - DIR
"RTN","GMRAFX",14,0)
 ;10018 - DIE
"RTN","GMRAFX",15,0)
 ;10013 - DIK
"RTN","GMRAFX",16,0)
 ;10061 - VADPT
"RTN","GMRAFX",17,0)
 ;10101 - XQOR
"RTN","GMRAFX",18,0)
 ;
"RTN","GMRAFX",19,0)
EN ; -- main entry point for GMRA FIX
"RTN","GMRAFX",20,0)
 N NMBR,REBLD,Y,DIR,I
"RTN","GMRAFX",21,0)
 I $D(^XTMP("GMRAFX","B")) W !,"The list is currently being built by another user so this option is",!,"temporarily unavailable.  Please try again in a few minutes." Q
"RTN","GMRAFX",22,0)
 I $D(^XTMP("GMRAFX","INUSE")) D
"RTN","GMRAFX",23,0)
 .W !,"The utility is currently in use by the following people:",!
"RTN","GMRAFX",24,0)
 .S I=0 F  S I=$O(^XTMP("GMRAFX","INUSE",I)) Q:'+I  W !,$$GET1^DIQ(200,I,.01)
"RTN","GMRAFX",25,0)
 .W !!,"As a result, the existing free text list will be used." D WAIT^GMRAFX3
"RTN","GMRAFX",26,0)
 I $D(^XTMP("GMRAFX")),'$D(^XTMP("GMRAFX","INUSE")) D
"RTN","GMRAFX",27,0)
 .W !,"The free text list was last built on ",$$FMTE^XLFDT($P(^XTMP("GMRAFX",0),U,2)),!
"RTN","GMRAFX",28,0)
 .S DIR(0)="Y",DIR("A")="Do you want to rebuild the list",DIR("B")="NO",DIR("?")="Enter yes to rebuild the list of free text entries.  Enter NO to use the currently existing list"
"RTN","GMRAFX",29,0)
 .D ^DIR I Y=1 K ^XTMP("GMRAFX") S REBLD=1
"RTN","GMRAFX",30,0)
 I $G(REBLD)!('$D(^XTMP("GMRAFX"))) W !,"Building list of free text allergies...this may take a few minutes",!
"RTN","GMRAFX",31,0)
 S ^XTMP("GMRAFX","INUSE",+$G(DUZ))=""
"RTN","GMRAFX",32,0)
 D EN^VALM("GMRA FIX")
"RTN","GMRAFX",33,0)
 K ^XTMP("GMRAFX","INUSE",+$G(DUZ))
"RTN","GMRAFX",34,0)
 Q
"RTN","GMRAFX",35,0)
 ;
"RTN","GMRAFX",36,0)
HDR ; -- header code
"RTN","GMRAFX",37,0)
 S VALMHDR(1)="Allergy Tracking Free Text Entries"
"RTN","GMRAFX",38,0)
 Q
"RTN","GMRAFX",39,0)
PHDR ;
"RTN","GMRAFX",40,0)
 S VALMSG="Select one or more entries"
"RTN","GMRAFX",41,0)
 S XQORM("#")=$$FIND1^DIC(101,,"BX","GMRA FIX FREE TEXT LIST") ;19
"RTN","GMRAFX",42,0)
 D SHOW^VALM
"RTN","GMRAFX",43,0)
 Q
"RTN","GMRAFX",44,0)
 ;
"RTN","GMRAFX",45,0)
INIT ;Initialize variables, etc
"RTN","GMRAFX",46,0)
 S VALMBCK="",VALMBG=$S($G(VALMBG)'="":VALMBG,1:1),VALMCNT=$S($D(^XTMP("GMRAFX",0)):$P(^(0),U,3),1:0),VALMWD=80
"RTN","GMRAFX",47,0)
 Q
"RTN","GMRAFX",48,0)
LIST ; -- obtain and display list of free text allergies
"RTN","GMRAFX",49,0)
 N GMRAIEN,GMRAOTH,GMRATXT,GMRAUTXT,SP1,SP2,SP3,UP,TXT
"RTN","GMRAFX",50,0)
 S VALMBCK="R",VALMCNT=0
"RTN","GMRAFX",51,0)
 K ^XTMP("GMRAFX") S ^XTMP("GMRAFX","B")="",^XTMP("GMRAFX","INUSE",+$G(DUZ))=""
"RTN","GMRAFX",52,0)
 S GMRAOTH=$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0))_";GMRD(120.82," ;Gets IEN;FILE ENTRY for free text entries
"RTN","GMRAFX",53,0)
 S GMRAIEN=0 F  S GMRAIEN=$O(^GMR(120.8,GMRAIEN)) Q:'+GMRAIEN  I $P($G(^(GMRAIEN,0)),U,3)=GMRAOTH D
"RTN","GMRAFX",54,0)
 .Q:+$G(^GMR(120.8,GMRAIEN,"ER"))  ;Quit if reactant entered in error
"RTN","GMRAFX",55,0)
 .Q:$$DECEASED(+$P($G(^GMR(120.8,GMRAIEN,0)),U))  ;Don't report expired patients
"RTN","GMRAFX",56,0)
 .Q:$$TESTPAT^VADPT($P($G(^GMR(120.8,GMRAIEN,0)),U))  ;Don't report test patients
"RTN","GMRAFX",57,0)
 .S GMRATXT=$E($P($G(^GMR(120.8,GMRAIEN,0)),U,2),1,75) ;Get "reactant" text entry, no more than 75 characters
"RTN","GMRAFX",58,0)
 .S GMRATXT=$TR(GMRATXT,"""","") ;19 remove quote marks from text
"RTN","GMRAFX",59,0)
 .S GMRAUTXT=$$UP^XLFSTR(GMRATXT) ;Convert to upper case
"RTN","GMRAFX",60,0)
 .S ^XTMP("GMRAFX","GMRAR",GMRAUTXT,GMRATXT)=$G(^XTMP("GMRAFX","GMRAR",GMRAUTXT,GMRATXT))+1 ;Local array of free text entries = active
"RTN","GMRAFX",61,0)
 .S ^XTMP("GMRAFX","GMRAR",GMRAUTXT,GMRATXT,GMRAIEN)="" ;Store entry number
"RTN","GMRAFX",62,0)
 .Q
"RTN","GMRAFX",63,0)
 S UP="" F  S UP=$O(^XTMP("GMRAFX","GMRAR",UP)) Q:UP=""  S TXT="" F  S TXT=$O(^XTMP("GMRAFX","GMRAR",UP,TXT)) Q:TXT=""  D
"RTN","GMRAFX",64,0)
 .S VALMCNT=VALMCNT+1
"RTN","GMRAFX",65,0)
 .S SP1=4-$L(VALMCNT),SP2=40-$L(TXT),SP3=16-$L(^XTMP("GMRAFX","GMRAR",UP,TXT))\2 ;Set up spacing before storing
"RTN","GMRAFX",66,0)
 .D SET^VALM10(VALMCNT,VALMCNT_$$REPEAT^XLFSTR(" ",SP1)_TXT_$$REPEAT^XLFSTR(" ",SP2)_$$REPEAT^XLFSTR(" ",SP3)_^XTMP("GMRAFX","GMRAR",UP,TXT))
"RTN","GMRAFX",67,0)
 .S ^XTMP("GMRAFX","IDX",VALMCNT)=UP_"^"_TXT
"RTN","GMRAFX",68,0)
 K ^XTMP("GMRAFX","B") ;Done building
"RTN","GMRAFX",69,0)
 S ^XTMP("GMRAFX",0)=$$FMADD^XLFDT(DT,30)_U_DT_U_$G(VALMCNT)
"RTN","GMRAFX",70,0)
 Q
"RTN","GMRAFX",71,0)
 ;
"RTN","GMRAFX",72,0)
HELP ; -- help code
"RTN","GMRAFX",73,0)
 D FULL^VALM1
"RTN","GMRAFX",74,0)
 W !!,"Use AE to add local allergies to the GMR ALLERGY file.  This",!,"should only be done if you're sure no existing reactant matches your needs."
"RTN","GMRAFX",75,0)
 W !!,"Use EE to mark all entries within the selected group as entered",!,"in error.  You may select multiple groups if you like."
"RTN","GMRAFX",76,0)
 W !!,"Use DD to get a detailed display.  It's highly recommended that you",!,"use the detailed display menu to make all changes."
"RTN","GMRAFX",77,0)
 W !!,"Use UR to update the reactant.  Extreme caution should be used when doing",!,"mass updates.  It would be better to do the updates from within",!,"the detailed display menu.",!
"RTN","GMRAFX",78,0)
 D WAIT^GMRAFX3 S VALMBCK="R"
"RTN","GMRAFX",79,0)
 Q
"RTN","GMRAFX",80,0)
 ;
"RTN","GMRAFX",81,0)
EXIT ; -- exit code
"RTN","GMRAFX",82,0)
 D FULL^VALM1
"RTN","GMRAFX",83,0)
 D DESELECT  ;Clear any remaining items
"RTN","GMRAFX",84,0)
 Q
"RTN","GMRAFX",85,0)
 ;
"RTN","GMRAFX",86,0)
EXPND ; -- expand code
"RTN","GMRAFX",87,0)
 Q
"RTN","GMRAFX",88,0)
 ;
"RTN","GMRAFX",89,0)
CHKSEL ;Evaluate selection if done by number
"RTN","GMRAFX",90,0)
 N J,TMP,DIR,NUM,X,Y,TNMBR
"RTN","GMRAFX",91,0)
 S VALMBCK="R"
"RTN","GMRAFX",92,0)
 S NUM=$P($G(XQORNOD(0)),"=",2) ;get currently selected entries
"RTN","GMRAFX",93,0)
 I NUM'="" D
"RTN","GMRAFX",94,0)
 .I NUM=$G(NMBR) D DESELECT Q  ;If user selects same entry without taking an entry, unhighlight and stop processing
"RTN","GMRAFX",95,0)
 .D DESELECT:$G(NMBR) ;If user previously selected entries but took no action, unhighlight before highlighting new choices
"RTN","GMRAFX",96,0)
 .S NMBR=$P(XQORNOD(0),"=",2),DIR(0)="L^"_"1:"_VALMCNT,X=NMBR,DIR("V")="" D ^DIR K DIR
"RTN","GMRAFX",97,0)
 .I Y="" D FULL^VALM1 W !,"Invalid selection." D WAIT^GMRAFX3 K NMBR Q  ;Selection out of range, stop processing
"RTN","GMRAFX",98,0)
 .S TNMBR=""
"RTN","GMRAFX",99,0)
 .F J=1:1:$L(NMBR,",")-1 S TMP=$P(NMBR,",",J) I $$LOCK^GMRAFX3(TMP) S TNMBR=TNMBR_TMP_"," D CNTRL^VALM10(TMP,1,+$G(VALMWD),IORVON,IORVOFF)
"RTN","GMRAFX",100,0)
 .I TNMBR="" K NMBR Q
"RTN","GMRAFX",101,0)
 .S NMBR=TNMBR
"RTN","GMRAFX",102,0)
 Q
"RTN","GMRAFX",103,0)
 ;
"RTN","GMRAFX",104,0)
DESELECT ;Un-highlight selected choices
"RTN","GMRAFX",105,0)
 N J,TMP
"RTN","GMRAFX",106,0)
 F J=1:1:$L($G(NMBR),",")-1 S TMP=$P(NMBR,",",J) D CNTRL^VALM10(TMP,1,+$G(VALMWD),IORVOFF,IORVOFF) L -^XTMP("GMRAFX","IDX",TMP)
"RTN","GMRAFX",107,0)
 K NMBR
"RTN","GMRAFX",108,0)
 Q
"RTN","GMRAFX",109,0)
 ;
"RTN","GMRAFX",110,0)
AEA ; Entry for GMRA LOCAL ALLERGIES EDIT option
"RTN","GMRAFX",111,0)
 N DLAYGO,DIC,Y,GMRAIEN,DA,GMRALN,DIE,GMRACT,DR,GMRAX,GMRAY,X
"RTN","GMRAFX",112,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX",113,0)
 W ! S DLAYGO=120.82,DIC="^GMRD(120.82,",DIC("A")="Select a LOCAL ALLERGY/ADVERSE REACTION: ",DIC(0)="AEQML",DIC("DR")="1" D ^DIC K DIC,DLAYGO Q:+Y'>0  S (DA,GMRAIEN)=+Y
"RTN","GMRAFX",114,0)
 L +^GMRD(120.82,GMRAIEN):1 I '$T W !,"THIS ENTRY IS BEING EDITED BY SOMEONE ELSE" Q
"RTN","GMRAFX",115,0)
 S GMRALN=$G(^GMRD(120.82,GMRAIEN,0))
"RTN","GMRAFX",116,0)
 S DIE="^GMRD(120.82,",DR="",GMRACT=1
"RTN","GMRAFX",117,0)
 I +$P(GMRALN,U,3) S DR(1,120.82,1)="@1;W !!,$C(7),""CANNOT EDIT NAME FIELD OF A NATIONAL ALLERGY."",!;3;"
"RTN","GMRAFX",118,0)
 E  D
"RTN","GMRAFX",119,0)
 .S DR(1,120.82,1)=".01;3;"
"RTN","GMRAFX",120,0)
 .S DR(1,120.82,2)="S (GMRAY,GMRAX)=$P(GMRALN,U,2) D EDTTYPE^GMRAUTL(.GMRAX);"
"RTN","GMRAFX",121,0)
 .S DR(1,120.82,3)="S:GMRAX=GMRAY!(""^^""[GMRAX) X=GMRAX,Y=$S(""^^""[GMRAX:""@3"",1:""@4"");1///^S X=GMRAX;@4;4;5;@3;"
"RTN","GMRAFX",122,0)
 .Q
"RTN","GMRAFX",123,0)
 D ^DIE
"RTN","GMRAFX",124,0)
 L -^GMRD(120.82,GMRAIEN)
"RTN","GMRAFX",125,0)
 Q
"RTN","GMRAFX",126,0)
 ;
"RTN","GMRAFX",127,0)
PROCESS(TYPE) ;API to mark all entries as entered in error or update entries to new reactant
"RTN","GMRAFX",128,0)
 N GMRAPA,GMRAI,GMRAJ,DIR,Y,ROOT,NUM,ENTRY,GMRADONE,STOP,J,TNMBR,GMRAAR
"RTN","GMRAFX",129,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX",130,0)
 I '$G(NMBR) S NMBR=$$GETNUM^GMRAFX3("") Q:'+NMBR  D  Q:'+$G(NMBR)
"RTN","GMRAFX",131,0)
 .S TNMBR=""
"RTN","GMRAFX",132,0)
 .F J=1:1:$L(NMBR,",")-1 S TMP=$P(NMBR,",",J) I $$LOCK^GMRAFX3(TMP) S TNMBR=TNMBR_TMP_","
"RTN","GMRAFX",133,0)
 .I TNMBR="" K NMBR Q
"RTN","GMRAFX",134,0)
 .S NMBR=TNMBR
"RTN","GMRAFX",135,0)
 I TYPE="U" W !!,"You should use the detailed display option to review entries in",!,"this group before doing a mass update.  CHANGES CANNOT BE UN-DONE!" D WAIT^GMRAFX3
"RTN","GMRAFX",136,0)
 W !!,"You are about to ",$S(TYPE="E":"mark",1:"update")," ALL allergies with the selected reactant ",!,$S(TYPE="E":"as entered in error.",1:"to a new reactant."),!
"RTN","GMRAFX",137,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="ARE YOU SURE"
"RTN","GMRAFX",138,0)
 S DIR("?")="If you're unsure, use the 'detailed display' option to get a list of individual patients."
"RTN","GMRAFX",139,0)
 S DIR("?",1)="Answering YES to this prompt will cause all allergies associated with"
"RTN","GMRAFX",140,0)
 S DIR("?",2)="the selected reactant to be "_$S(TYPE="E":"marked as entered in error.",1:"updated to the new reactant.")
"RTN","GMRAFX",141,0)
 S DIR("?",3)=""
"RTN","GMRAFX",142,0)
 S DIR("?",4)="Be SURE this is what you want to do."
"RTN","GMRAFX",143,0)
 D ^DIR Q:Y'=1  ;Stop if user doesn't answer yes
"RTN","GMRAFX",144,0)
 F GMRAI=1:1:($L(NMBR,",")-1) D
"RTN","GMRAFX",145,0)
 .S NUM=$P(NMBR,",",GMRAI),ENTRY=^XTMP("GMRAFX","IDX",NUM),STOP=0
"RTN","GMRAFX",146,0)
 .S ROOT="^XTMP(""GMRAFX"",""GMRAR"","_""""_$P(ENTRY,"^")_""""_","_""""_$P(ENTRY,"^",2)_""""_")",GMRAJ=0 Q:'@ROOT
"RTN","GMRAFX",147,0)
 .I TYPE="U" W !!,"Updating ",$P(ENTRY,U)," reactions"
"RTN","GMRAFX",148,0)
 .F  S GMRAJ=$O(@ROOT@(GMRAJ)) Q:GMRAJ=""!($G(STOP))  I GMRAJ D
"RTN","GMRAFX",149,0)
 ..S GMRAPA=GMRAJ,GMRADONE=1 D @$S(TYPE="E":"EIE",1:"UIE^GMRAFX3")
"RTN","GMRAFX",150,0)
 ..D:GMRADONE UPDATE^GMRAFX3
"RTN","GMRAFX",151,0)
 Q
"RTN","GMRAFX",152,0)
 ;
"RTN","GMRAFX",153,0)
EIE ;Mark individual entry as entered in error
"RTN","GMRAFX",154,0)
 N DIE,DA,DR,Y,DIK,DFN,OROLD,VAIN,X,GMRAOUT
"RTN","GMRAFX",155,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR="22///1;23///NOW;24////"_$G(DUZ,.5)
"RTN","GMRAFX",156,0)
 D ^DIE ;Entered in error on date/time by user
"RTN","GMRAFX",157,0)
 D ADCOM(GMRAPA,"E","Marked Entered in Error during clean up process")
"RTN","GMRAFX",158,0)
 I $$NKASCR^GMRANKA($P(^GMR(120.8,GMRAPA,0),U)) D
"RTN","GMRAFX",159,0)
 .S DIK="^GMR(120.86,",DA=$P(^GMR(120.8,GMRAPA,0),U)
"RTN","GMRAFX",160,0)
 .D ^DIK ;If patient's last allergy marked as entered in error then delete assessment
"RTN","GMRAFX",161,0)
 .W !!,"**NOTE: By marking this reaction as entered in error, ",$$GET1^DIQ(2,DA,.01,"E"),!,"no longer has an assessment on file.  You may reassess this patient",!
"RTN","GMRAFX",162,0)
 .W "now by answering the following prompt or hit return to do it later.",!
"RTN","GMRAFX",163,0)
 .D NKAASK^GMRANKA(DA)
"RTN","GMRAFX",164,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAFX",165,0)
 S GMRAOUT=0
"RTN","GMRAFX",166,0)
 D EN1^GMRAEAB ;Sends entered in error bulletin to appropriate mail groups
"RTN","GMRAFX",167,0)
 S DFN=$P(GMRAPA(0),U)
"RTN","GMRAFX",168,0)
 D INP^VADPT S X=$$FIND1^DIC(101,,"BX","GMRA ENTERED IN ERROR")_";ORD(101," ;19
"RTN","GMRAFX",169,0)
 D:X EN^XQOR ;Process protocols hanging off of "entered in error" protocol
"RTN","GMRAFX",170,0)
 Q
"RTN","GMRAFX",171,0)
 ;
"RTN","GMRAFX",172,0)
DECEASED(GMRAIFN) ;Function returns 1 if patient is deceased, 0 if living
"RTN","GMRAFX",173,0)
 N DFN,VADM
"RTN","GMRAFX",174,0)
 Q:GMRAIFN=0 1  ;If no patient entry return true
"RTN","GMRAFX",175,0)
 S DFN=GMRAIFN
"RTN","GMRAFX",176,0)
 D DEM^VADPT
"RTN","GMRAFX",177,0)
 Q $S(+VADM(6):1,1:0)  ;VADM(6) holds date of death
"RTN","GMRAFX",178,0)
 ;
"RTN","GMRAFX",179,0)
ADCOM(ENTRY,TYPE,COM) ;Add comment to allergy
"RTN","GMRAFX",180,0)
 N DIC,DIE,DR,DA,Y,X
"RTN","GMRAFX",181,0)
 S DA(1)=ENTRY
"RTN","GMRAFX",182,0)
 S DIC="^GMR(120.8,"_DA(1)_",26,",DIC(0)="L",X=$$NOW^XLFDT
"RTN","GMRAFX",183,0)
 D ^DIC Q:Y=-1  ;add new comment multiple
"RTN","GMRAFX",184,0)
 S DA=+Y
"RTN","GMRAFX",185,0)
 S DIE=DIC K DIC
"RTN","GMRAFX",186,0)
 S DR="1////"_$G(DUZ,.5)_";1.5///"_TYPE_";2///"_$TR(COM,";"," ") ;remove semi-colon from free text
"RTN","GMRAFX",187,0)
 D ^DIE ;Comment added by user
"RTN","GMRAFX",188,0)
 Q
"RTN","GMRAFX1")
0^1^B31454366
"RTN","GMRAFX1",1,0)
GMRAFX1 ;SLC/DAN Fix existing free text entries-continued ;5/4/04  12:31
"RTN","GMRAFX1",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19**;Mar 29, 1996
"RTN","GMRAFX1",3,0)
 ;DBIA SECTION
"RTN","GMRAFX1",4,0)
 ;10116 - VALM1
"RTN","GMRAFX1",5,0)
 ;10102 - XQORM1
"RTN","GMRAFX1",6,0)
 ;10104 - XLFSTR
"RTN","GMRAFX1",7,0)
 ;10061 - VADPT
"RTN","GMRAFX1",8,0)
 ;10017 - VALM10
"RTN","GMRAFX1",9,0)
 ;10118 - VALM
"RTN","GMRAFX1",10,0)
 ;10026 - DIR
"RTN","GMRAFX1",11,0)
 ;
"RTN","GMRAFX1",12,0)
DET ;Detailed listing of selected group
"RTN","GMRAFX1",13,0)
 N DIR,Y,DTOUT,DUOUT,DIRUT,J,GMRAT,GMRAUT,DFN,GMRA,GMRAL,VADM,CNT,VAERR,K,LEN,NAME,ENTRY,NMBR2,ENMBR,GMRAR
"RTN","GMRAFX1",14,0)
 S VALMBCK="R",CNT=0
"RTN","GMRAFX1",15,0)
 K ^TMP($J,"GMRADET"),^TMP($J,"IDX2")
"RTN","GMRAFX1",16,0)
 S ENMBR=+NMBR ;get number portion of entry
"RTN","GMRAFX1",17,0)
 S ENTRY=0
"RTN","GMRAFX1",18,0)
 S GMRAUT=$P(^XTMP("GMRAFX","IDX",ENMBR),"^"),GMRAT=$P(^XTMP("GMRAFX","IDX",ENMBR),"^",2)
"RTN","GMRAFX1",19,0)
 S J=0 F  S J=$O(^XTMP("GMRAFX","GMRAR",GMRAUT,GMRAT,J)) Q:'+J  D
"RTN","GMRAFX1",20,0)
 .S DFN=$P($G(^GMR(120.8,J,0)),"^"),GMRA="0^0^111" D ^GMRADPT ;Get patient allergies
"RTN","GMRAFX1",21,0)
 .D DEM^VADPT ;Get patient information
"RTN","GMRAFX1",22,0)
 .Q:$G(VAERR)  ;Quit if patient lookup produces an error
"RTN","GMRAFX1",23,0)
 .S CNT=CNT+1,ENTRY=ENTRY+1
"RTN","GMRAFX1",24,0)
 .S GMRAR(CNT)=VADM(1)_$$REPEAT^XLFSTR(" ",(32-$L(VADM(1))))_$E(VADM(2),6,9)_" "
"RTN","GMRAFX1",25,0)
 .D SET^VALM10(CNT,ENTRY_$$REPEAT^XLFSTR(" ",(4-$L(ENTRY)))_GMRAR(CNT)) K GMRAR(CNT) ;19
"RTN","GMRAFX1",26,0)
 .S ^TMP($J,"IDX2",ENTRY)=CNT_"^"_J
"RTN","GMRAFX1",27,0)
 .S CNT=CNT+1,LEN=0,GMRAR(CNT)="Allergies: "
"RTN","GMRAFX1",28,0)
 .S K=0 F  S K=$O(GMRAL(K)) Q:'+K  D
"RTN","GMRAFX1",29,0)
 ..S NAME=$P(GMRAL(K),"^",2) ;Allergy name
"RTN","GMRAFX1",30,0)
 ..S LEN=LEN+$L(NAME)+1
"RTN","GMRAFX1",31,0)
 ..I LEN>70 D SET^VALM10(CNT,GMRAR(CNT)) K GMRAR(CNT) S CNT=CNT+1,LEN=$L(NAME)+1,GMRAR(CNT)="   " ;19
"RTN","GMRAFX1",32,0)
 ..S GMRAR(CNT)=$G(GMRAR(CNT))_NAME_$S($O(GMRAL(K)):"~",1:"") D:'$O(GMRAL(K)) SET^VALM10(CNT,GMRAR(CNT)) ;19
"RTN","GMRAFX1",33,0)
 S VALMCNT=CNT,^TMP($J,"IDX2",0)=ENTRY
"RTN","GMRAFX1",34,0)
 Q
"RTN","GMRAFX1",35,0)
 ;
"RTN","GMRAFX1",36,0)
HDR ; -- header code
"RTN","GMRAFX1",37,0)
 S VALMHDR(1)="Patient listing for reactant "_$S(+$G(NMBR):$P(^XTMP("GMRAFX","IDX",+NMBR),"^"),1:"")
"RTN","GMRAFX1",38,0)
 Q
"RTN","GMRAFX1",39,0)
 ;
"RTN","GMRAFX1",40,0)
PHDR ;
"RTN","GMRAFX1",41,0)
 S VALMSG="Select a patient"
"RTN","GMRAFX1",42,0)
 S XQORM("#")=$$FIND1^DIC(101,,"BX","GMRA FIX DETAIL MENU") ;19
"RTN","GMRAFX1",43,0)
 D SHOW^VALM
"RTN","GMRAFX1",44,0)
 Q
"RTN","GMRAFX1",45,0)
 ;
"RTN","GMRAFX1",46,0)
INIT ; -- init variables and list array
"RTN","GMRAFX1",47,0)
 N DIR
"RTN","GMRAFX1",48,0)
 I '$G(NMBR) S NMBR=$$GETNUM^GMRAFX3("DET") S:'+NMBR VALMQUIT="" Q:'+NMBR  I '$$LOCK^GMRAFX3(+NMBR) S VALMQUIT="" Q
"RTN","GMRAFX1",49,0)
 I $L($G(NMBR),",")>2 D FULL^VALM1 W !,"Please select",$S('$G(NMBR):"",1:" only")," one entry from the list." S DIR(0)="E",DIR("A")="Press enter to continue" D ^DIR S VALMQUIT=1 Q
"RTN","GMRAFX1",50,0)
 K ^TMP($J,"GMRADET"),^TMP($J,"IDX2")
"RTN","GMRAFX1",51,0)
 S VALMBCK="",VALMBG=$G(VALMBG,1),VALMCNT=0,VALMWD=80
"RTN","GMRAFX1",52,0)
 Q
"RTN","GMRAFX1",53,0)
 ;
"RTN","GMRAFX1",54,0)
CHKSEL ;Evaluate selection if done by number
"RTN","GMRAFX1",55,0)
 N J,TMP,DIR,NUM,X,Y
"RTN","GMRAFX1",56,0)
 S NUM=$P($G(XQORNOD(0)),"=",2) ;get currently selected entries
"RTN","GMRAFX1",57,0)
 I NUM'="" D
"RTN","GMRAFX1",58,0)
 .I NUM=$G(NMBR2) D DESELECT Q  ;If user selects same entry without taking an entry, unhighlight and stop processing
"RTN","GMRAFX1",59,0)
 .D DESELECT:$G(NMBR2) ;If user previously selected entries but took no action, unhighlight before highlighting new choices
"RTN","GMRAFX1",60,0)
 .S NMBR2=$P(XQORNOD(0),"=",2),DIR(0)="L^"_"1:"_$G(^TMP($J,"IDX2",0)),X=NMBR2,DIR("V")="" D ^DIR K DIR
"RTN","GMRAFX1",61,0)
 .I Y="" D FULL^VALM1 W !,"Invalid selection." D WAIT^GMRAFX3 K NMBR2 Q  ;Selection out of range, stop processing
"RTN","GMRAFX1",62,0)
 .F J=1:1:$L(NMBR2,",")-1 S TMP=$P(NMBR2,",",J) D CNTRL^VALM10(+^TMP($J,"IDX2",TMP),1,+$G(VALMWD),IORVON,IORVOFF)
"RTN","GMRAFX1",63,0)
 Q
"RTN","GMRAFX1",64,0)
 ;
"RTN","GMRAFX1",65,0)
DESELECT ;Un-highlight selected choices
"RTN","GMRAFX1",66,0)
 N J,TMP
"RTN","GMRAFX1",67,0)
 F J=1:1:$L($G(NMBR2),",")-1 S TMP=$P(NMBR2,",",J) D CNTRL^VALM10(+^TMP($J,"IDX2",TMP),1,+$G(VALMWD),IORVOFF,IORVOFF)
"RTN","GMRAFX1",68,0)
 K NMBR2
"RTN","GMRAFX1",69,0)
 Q
"RTN","GMRAFX1",70,0)
HELP ; -- help code
"RTN","GMRAFX1",71,0)
 D FULL^VALM1
"RTN","GMRAFX1",72,0)
 W !!,"Use AE to add local allergies to the GMR ALLERGY file.  This",!,"should only be done if you're sure no existing reactant matches your needs."
"RTN","GMRAFX1",73,0)
 W !!,"Use EE to mark all selected entries as entered",!,"in error.  You may select multiple patients if you like."
"RTN","GMRAFX1",74,0)
 W !!,"Use UR to update the reactant.  Extreme caution should be used when updating",!,"reactants.  You may select multiple patients if you like,"
"RTN","GMRAFX1",75,0)
 W !!,"Use PR to add new allergies for the selected patient in",!,"addition to the ones listed here."
"RTN","GMRAFX1",76,0)
 W !!,"Use DD to get details about the free text entry that you're",!,"currently working on for this patient.",!
"RTN","GMRAFX1",77,0)
 D WAIT^GMRAFX3 S VALMBCK="R"
"RTN","GMRAFX1",78,0)
 Q
"RTN","GMRAFX1",79,0)
 ;
"RTN","GMRAFX1",80,0)
EXIT ; -- exit code
"RTN","GMRAFX1",81,0)
 K ^TMP($J,"IDX2"),^TMP($J,"GMRADET")
"RTN","GMRAFX1",82,0)
 Q
"RTN","GMRAFX1",83,0)
 ;
"RTN","GMRAFX1",84,0)
EXPND ; -- expand code
"RTN","GMRAFX1",85,0)
 Q
"RTN","GMRAFX1",86,0)
 ;
"RTN","GMRAFX1",87,0)
PROCESS(TYPE) ;API to mark selected entries from the detailed listing as entered in error or update to new reactant
"RTN","GMRAFX1",88,0)
 N GMRAPA,GMRAJ,DIR,Y,NUM,GMRADONE,ENTRY,GMRAI,STOP,NUM2,GMRAAR
"RTN","GMRAFX1",89,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX1",90,0)
 I '$G(NMBR2) S NMBR2=$$GETNUM^GMRAFX3("") Q:'+NMBR2
"RTN","GMRAFX1",91,0)
 W !!,"You are about to ",$S(TYPE="E":"mark",1:"update")," the selected patient",$S($L(NMBR2,",")>2:"s'",1:"'s"),!
"RTN","GMRAFX1",92,0)
 S ENTRY=$G(^XTMP("GMRAFX","IDX",+NMBR))
"RTN","GMRAFX1",93,0)
 W $P(ENTRY,"^",2)," allergy ",$S(TYPE="E":"as entered in error.",1:"to a new reactant."),!
"RTN","GMRAFX1",94,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="ARE YOU SURE"
"RTN","GMRAFX1",95,0)
 S DIR("?")="Once allergies are updated or marked as entered in error it cannot be undone!"
"RTN","GMRAFX1",96,0)
 S DIR("?",1)="Be sure this is what you want to do."
"RTN","GMRAFX1",97,0)
 D ^DIR Q:Y'=1  ;Stop if user doesn't answer yes
"RTN","GMRAFX1",98,0)
 S NUM=+NMBR
"RTN","GMRAFX1",99,0)
 F GMRAI=1:1:($L(NMBR2,",")-1) D  Q:$G(STOP)
"RTN","GMRAFX1",100,0)
 .S GMRADONE=1
"RTN","GMRAFX1",101,0)
 .S NUM2=$P(NMBR2,",",GMRAI)
"RTN","GMRAFX1",102,0)
 .S (GMRAPA,GMRAJ)=$P(^TMP($J,"IDX2",NUM2),U,2) Q:'GMRAPA
"RTN","GMRAFX1",103,0)
 .D @$S(TYPE="E":"EIE^GMRAFX",1:"UIE^GMRAFX3")
"RTN","GMRAFX1",104,0)
 .D:$G(GMRADONE) UPDATE^GMRAFX3
"RTN","GMRAFX1",105,0)
 Q
"RTN","GMRAFX2")
0^2^B25571771
"RTN","GMRAFX2",1,0)
GMRAFX2 ;SLC/DAN Select reactant for update ;1/30/04  12:39
"RTN","GMRAFX2",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19**;Mar 29, 1996
"RTN","GMRAFX2",3,0)
 ;DBIA SECTION
"RTN","GMRAFX2",4,0)
 ;10026 - DIR
"RTN","GMRAFX2",5,0)
 ;2056  - DIQ
"RTN","GMRAFX2",6,0)
 ;221   - PSDRUG("B", and PSDRUG("C", cross references
"RTN","GMRAFX2",7,0)
 ;10104 - XLFSTR
"RTN","GMRAFX2",8,0)
 ;10006 - DIC
"RTN","GMRAFX2",9,0)
 ;2531  - $$T^PSNAPIS
"RTN","GMRAFX2",10,0)
 ;2574  - $$TGTOG^PSNAPIS
"RTN","GMRAFX2",11,0)
 ;
"RTN","GMRAFX2",12,0)
EN1 ; Select new reactant
"RTN","GMRAFX2",13,0)
 N DIR,Y,DIRUT,X,DTOUT,DUOUT,DIC,GMRALAR,D,ENTRY,OK,CNT,LST,ROOT,NAM,DIROUT
"RTN","GMRAFX2",14,0)
 S DIR(0)="FO^3:30",DIR("A")="Enter Causative Agent",DIR("?")="^D HELP^GMRAFX2" D ^DIR S:$D(DIROUT) STOP=1 Q:$D(DIRUT)  S GMRALAR=$$UP^XLFSTR(Y)
"RTN","GMRAFX2",15,0)
NPA W !!,"Checking GMR ALLERGIES (#120.82) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",16,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) Q
"RTN","GMRAFX2",17,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAFX2",18,0)
 K Y,DTOUT,DUOUT,ENTRY
"RTN","GMRAFX2",19,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAFX2",20,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM" D ^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",21,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" Q
"RTN","GMRAFX2",22,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAFX2",23,0)
 K DUOUT,DTOUT,Y,ENTRY
"RTN","GMRAFX2",24,0)
 S ROOT=$$T^PSNAPIS,CNT=0,X=GMRALAR
"RTN","GMRAFX2",25,0)
 I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAFX2",26,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAFX2",27,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAFX2",28,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAFX2",29,0)
 I CNT=1 S Y(0)=LST(1),ENTRY=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAFX2",30,0)
 I CNT>1 D
"RTN","GMRAFX2",31,0)
 .D MATCHES
"RTN","GMRAFX2",32,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAFX2",33,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAFX2",34,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),(ENTRY,X)=$P(Y(0),U,2)
"RTN","GMRAFX2",35,0)
 D DIC
"RTN","GMRAFX2",36,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" Q
"RTN","GMRAFX2",37,0)
DRUG W !!,"Now checking the DRUG (#50) file for matches...",! K Y,DTOUT,DUOUT,ENTRY
"RTN","GMRAFX2",38,0)
 S CNT=0,X=GMRALAR K LST
"RTN","GMRAFX2",39,0)
 F ROOT="^PSDRUG(""B"")","^PSDRUG(""C"")" D
"RTN","GMRAFX2",40,0)
 .I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$O(@ROOT@(X,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(X,0)),.01)_" <"_X_">",1:X) ;Exact match stores IEN in 50
"RTN","GMRAFX2",41,0)
 .S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAFX2",42,0)
 ..S CNT=CNT+1,LST(CNT)=$O(@ROOT@(NAM,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(NAM,0)),.01)_" <"_NAM_">",1:NAM)
"RTN","GMRAFX2",43,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAFX2",44,0)
 I CNT=1 S Y(0)=LST(1),ENTRY=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAFX2",45,0)
 I CNT>1 D
"RTN","GMRAFX2",46,0)
 .D MATCHES
"RTN","GMRAFX2",47,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAFX2",48,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAFX2",49,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),(ENTRY,X)=$P(Y(0),U,2)
"RTN","GMRAFX2",50,0)
 D DIC
"RTN","GMRAFX2",51,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y(0)_";PSDRUG(",GMRAAR(0)=$$GET1^DIQ(50,+Y(0),.01),GMRAAR("O")="D" Q
"RTN","GMRAFX2",52,0)
 ;19 - Moved ING and CLASS code here from above
"RTN","GMRAFX2",53,0)
ING W !!,"Now checking INGREDIENT (#50.416) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",X=GMRALAR D IX^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",54,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" Q
"RTN","GMRAFX2",55,0)
CLASS W !!,"Now checking VA DRUG CLASS (#50.605) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",D="C" D IX^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",56,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" Q
"RTN","GMRAFX2",57,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files.",!,"Please try again (check spelling, etc).",!,"If you need to add a new reactant, use the AE option." G EN1
"RTN","GMRAFX2",58,0)
 Q
"RTN","GMRAFX2",59,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAFX2",60,0)
 N DIR,X,Y
"RTN","GMRAFX2",61,0)
 Q:'$D(ENTRY)
"RTN","GMRAFX2",62,0)
 K OK
"RTN","GMRAFX2",63,0)
 W !!,"You selected ",ENTRY
"RTN","GMRAFX2",64,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Is this correct",DIR("?")="Answer yes if this is the correct reactant" D ^DIR S:Y=1 OK=1
"RTN","GMRAFX2",65,0)
 Q
"RTN","GMRAFX2",66,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAFX2",67,0)
 N I,J,QUIT
"RTN","GMRAFX2",68,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAFX2",69,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAFX2",70,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAFX2",71,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAFX2",72,0)
 Q
"RTN","GMRAFX2",73,0)
        ;
"RTN","GMRAFX2",74,0)
MORE()  ; -- show more matches
"RTN","GMRAFX2",75,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAFX2",76,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAFX2",77,0)
 D ^DIR
"RTN","GMRAFX2",78,0)
 Q +Y
"RTN","GMRAFX2",79,0)
 ;
"RTN","GMRAFX2",80,0)
HELP ;Display help for selection of causative agent
"RTN","GMRAFX2",81,0)
 W !,"Enter new causative agent to be assigned to the selected entries."
"RTN","GMRAFX2",82,0)
 W !,"Enter between 3 and 30 characters.  The entered text will then be"
"RTN","GMRAFX2",83,0)
 W !,"searched for in a number of different files.  Select the appropriate"
"RTN","GMRAFX2",84,0)
 W !,"entry from the appropriate file to update the selected patient."
"RTN","GMRAFX2",85,0)
 W !!,"Enter ^ to skip the current patient or ^^ to exit the entire process."
"RTN","GMRAFX2",86,0)
 Q
"RTN","GMRAFX3")
0^3^B35679551
"RTN","GMRAFX3",1,0)
GMRAFX3 ;SLC/DAN Update existing entries to new reactant ;1/30/04  12:38
"RTN","GMRAFX3",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19**;Mar 29, 1996
"RTN","GMRAFX3",3,0)
 ;DBIA SECTION
"RTN","GMRAFX3",4,0)
 ;10018 - DIE
"RTN","GMRAFX3",5,0)
 ;2056  - DIQ
"RTN","GMRAFX3",6,0)
 ;3154  - ORQ1
"RTN","GMRAFX3",7,0)
 ;4134  - ORCHECK
"RTN","GMRAFX3",8,0)
 ;4135  - ORKCHK
"RTN","GMRAFX3",9,0)
 ;10026 - DIR
"RTN","GMRAFX3",10,0)
 ;
"RTN","GMRAFX3",11,0)
UIE ;Update individual entries
"RTN","GMRAFX3",12,0)
 N DFN,GMRAOUT,GMRAING,GMRADRCL,DIE,DA,DR,AIFN,SIGN,TIME,SUB,ORX,GMRAORX,GMRAOC,GI,FND,COM,SIEN,DIR,Y
"RTN","GMRAFX3",13,0)
 S GMRADONE=0 ;Flag to keep track of updated entries
"RTN","GMRAFX3",14,0)
 S DFN=$P($G(^GMR(120.8,GMRAPA,0)),U) Q:'+DFN
"RTN","GMRAFX3",15,0)
 W !!,"For patient ",$$GET1^DIQ(2,DFN_",",.01),!
"RTN","GMRAFX3",16,0)
 I $D(GMRAAR) D
"RTN","GMRAFX3",17,0)
 .S DIR(0)="Y",DIR("A")="Use reactant "_GMRAAR(0),DIR("B")="Y" D ^DIR
"RTN","GMRAFX3",18,0)
 .K:'Y GMRAAR
"RTN","GMRAFX3",19,0)
 .Q
"RTN","GMRAFX3",20,0)
 D:'$D(GMRAAR) ^GMRAFX2 Q:'$D(GMRAAR)  ;Get new reactant
"RTN","GMRAFX3",21,0)
 S GMRAOUT=0
"RTN","GMRAFX3",22,0)
 I $$DUP W !,"Patient already has an active allergy for this reactant.",!,"Duplicate not allowed.",! D WAIT Q
"RTN","GMRAFX3",23,0)
 I $$DUPCHK^GMRAPES0(GMRAAR(0),DFN,GMRAPA) Q  ;Checks to see if reactant previously entered in error.
"RTN","GMRAFX3",24,0)
 ;Update reactant, allergy and signed off fields
"RTN","GMRAFX3",25,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR=".02////"_GMRAAR(0)_";1////^S X=GMRAAR"_";3.1////"_GMRAAR("O")_";15///1" D ^DIE
"RTN","GMRAFX3",26,0)
 I $D(^GMR(120.85,"C",GMRAPA)) D  ;Observed reaction, need to update data
"RTN","GMRAFX3",27,0)
 .S AIFN=0
"RTN","GMRAFX3",28,0)
 .F  S AIFN=$O(^GMR(120.85,"C",GMRAPA,AIFN)) Q:'+AIFN  D
"RTN","GMRAFX3",29,0)
 ..S SIEN=$O(^GMR(120.85,AIFN,3,"B",$P(^XTMP("GMRAFX","IDX",+NMBR),"^"),0)) Q:'+SIEN  ;Was previous reactant stored as "suspected agent"
"RTN","GMRAFX3",30,0)
 ..S DA(1)=AIFN,DA=SIEN
"RTN","GMRAFX3",31,0)
 ..S DIE="^GMR(120.85,DA(1),3,",DR=".01////^S X=GMRAAR(0)" D ^DIE ;Update suspected agent to new value
"RTN","GMRAFX3",32,0)
 D DELMUL(2),DELMUL(3) ;Delete drug ingredient/drug classes multiples
"RTN","GMRAFX3",33,0)
 I GMRAAR("O")["D" D UPDATE^GMRAPES1 ;If reactant type is Drug then add appropriate ingredients and classes
"RTN","GMRAFX3",34,0)
 S GMRADONE=1 ;Update complete
"RTN","GMRAFX3",35,0)
 S COM="Updated using clean up process.  Changed reactant from "_$P(^XTMP("GMRAFX","IDX",+NMBR),"^",2)_" (free text) "_"to "_GMRAAR(0)_"(file - "_$P(GMRAAR,";",2)_")"
"RTN","GMRAFX3",36,0)
 D ADCOM^GMRAFX(GMRAPA,"O",COM) ;Add a comment for this update
"RTN","GMRAFX3",37,0)
 ;Do order checking here - compare existing orders against new allergy information.
"RTN","GMRAFX3",38,0)
 W !,"Performing order checking..."
"RTN","GMRAFX3",39,0)
 K ^TMP("ORR",$J),GMRAOC,ORX
"RTN","GMRAFX3",40,0)
 D EN^ORQ1(DFN_";DPT(") ;Retrieve active orders
"RTN","GMRAFX3",41,0)
 S TIME=$O(^TMP("ORR",$J,0))
"RTN","GMRAFX3",42,0)
 Q:'^TMP("ORR",$J,TIME,"TOT")  ;No orders found
"RTN","GMRAFX3",43,0)
 S SUB=0 F  S SUB=$O(^TMP("ORR",$J,TIME,SUB)) Q:'+SUB  D
"RTN","GMRAFX3",44,0)
 .D BLD^ORCHECK(+^TMP("ORR",$J,TIME,SUB)) ;Get "order" information in order checking format
"RTN","GMRAFX3",45,0)
 M GMRAORX=ORX K ORX ;19
"RTN","GMRAFX3",46,0)
 D EN^ORKCHK(.GMRAOC,DFN,.GMRAORX,"ACCEPT")
"RTN","GMRAFX3",47,0)
 S GI=0,FND=0 F  S GI=$O(GMRAOC(GI)) Q:'+GI  D
"RTN","GMRAFX3",48,0)
 .Q:$P(GMRAOC(GI),U,2)'=3  ;Quit if not allergy related
"RTN","GMRAFX3",49,0)
 .W !,"Patient has a(n) ",$P($$STATUS^ORQOR2($P(GMRAOC(GI),U)),U,2)," order for",$P($P(GMRAOC(GI),U,4),":",2),", order #",$P(GMRAOC(GI),U)
"RTN","GMRAFX3",50,0)
 .S FND=1
"RTN","GMRAFX3",51,0)
 W:'FND "No problems found"
"RTN","GMRAFX3",52,0)
 D WAIT
"RTN","GMRAFX3",53,0)
 Q
"RTN","GMRAFX3",54,0)
 ;
"RTN","GMRAFX3",55,0)
DELMUL(FIELD) ;Delete multiple FIELD from GMR ALLERGY file
"RTN","GMRAFX3",56,0)
 N MIEN,DA,DIE,DR
"RTN","GMRAFX3",57,0)
 S MIEN=0 F  S MIEN=$O(^GMR(120.8,GMRAPA,FIELD,MIEN)) Q:'+MIEN  D
"RTN","GMRAFX3",58,0)
 .S DA(1)=GMRAPA,DA=MIEN
"RTN","GMRAFX3",59,0)
 .S DIE="^GMR(120.8,DA(1),FIELD,",DR=".01///@" D ^DIE ;Delete entry
"RTN","GMRAFX3",60,0)
 Q
"RTN","GMRAFX3",61,0)
 ;
"RTN","GMRAFX3",62,0)
DUP() ;Function returns true (1) if selected reactant is a duplicate
"RTN","GMRAFX3",63,0)
 N LOOP,FND
"RTN","GMRAFX3",64,0)
 S LOOP=0,FND=0
"RTN","GMRAFX3",65,0)
 F  S LOOP=$O(^GMR(120.8,"B",DFN,LOOP)) Q:'+LOOP!(FND)  D
"RTN","GMRAFX3",66,0)
 .I $P(^GMR(120.8,LOOP,0),U,3)=GMRAAR&('$D(^GMR(120.8,LOOP,"ER"))) S FND=1
"RTN","GMRAFX3",67,0)
 Q FND
"RTN","GMRAFX3",68,0)
 ;
"RTN","GMRAFX3",69,0)
WAIT ;Issues press enter to return prompt
"RTN","GMRAFX3",70,0)
 N DIR
"RTN","GMRAFX3",71,0)
 S DIR(0)="E",DIR("A")="Press enter to continue" D ^DIR
"RTN","GMRAFX3",72,0)
 Q
"RTN","GMRAFX3",73,0)
 ;
"RTN","GMRAFX3",74,0)
GETNUM(ACTION) ; -- Return numbers to act on, if action chosen first
"RTN","GMRAFX3",75,0)
 N X,Y,DIR,MAX
"RTN","GMRAFX3",76,0)
 S MAX=$S($D(^TMP($J,"IDX2")):$G(^TMP($J,"IDX2",0)),1:$G(VALMCNT)) Q:MAX'>0 ""
"RTN","GMRAFX3",77,0)
 I ACTION="DET" W !!,"Please choose only one entry for the detailed display."
"RTN","GMRAFX3",78,0)
 S DIR(0)="LAO^1:"_MAX,DIR("A")="Select Entries from list: "
"RTN","GMRAFX3",79,0)
 S DIR("?")="Enter the items you wish to act on, as a range or list of numbers."
"RTN","GMRAFX3",80,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","GMRAFX3",81,0)
 I $D(Y(1)) W !,">>>Too many entries selected, try using smaller ranges" H 2 S Y="^"
"RTN","GMRAFX3",82,0)
 I $L($G(Y),",")>2,ACTION="DET" W !,">>You may only choose ONE group for detailed display." H 2 S Y="^"
"RTN","GMRAFX3",83,0)
 Q Y
"RTN","GMRAFX3",84,0)
 ;
"RTN","GMRAFX3",85,0)
UPDATE ;Update display to account for changes to the list
"RTN","GMRAFX3",86,0)
 N CNT,SP1,SP2,SP3
"RTN","GMRAFX3",87,0)
 I VALMAR["GMRADET" N VALMAR S VALMAR="^XTMP(""GMRAFX"")"
"RTN","GMRAFX3",88,0)
 S CNT=^XTMP("GMRAFX","GMRAR",$P(ENTRY,U),$P(ENTRY,U,2))-1
"RTN","GMRAFX3",89,0)
 S ^XTMP("GMRAFX","GMRAR",$P(ENTRY,U),$P(ENTRY,U,2))=CNT K ^($P(ENTRY,U,2),GMRAJ)
"RTN","GMRAFX3",90,0)
 S SP1=4-$L(+NUM),SP2=40-$L($P(ENTRY,U)),SP3=$S(CNT:16-$L(CNT)\2,1:2)
"RTN","GMRAFX3",91,0)
 D SET^VALM10(+NUM,+NUM_$$REPEAT^XLFSTR(" ",SP1)_$P(ENTRY,U,2)_$$REPEAT^XLFSTR(" ",(SP2+SP3))_$S(CNT:CNT,1:"** FIXED **"))
"RTN","GMRAFX3",92,0)
 Q
"RTN","GMRAFX3",93,0)
 ;
"RTN","GMRAFX3",94,0)
LOCK(ENTRY) ;Lock entry in 120.8
"RTN","GMRAFX3",95,0)
 N LOCK
"RTN","GMRAFX3",96,0)
 S LOCK=1
"RTN","GMRAFX3",97,0)
 L +^XTMP("GMRAFX","IDX",ENTRY):1
"RTN","GMRAFX3",98,0)
 I '$T D FULL^VALM1 S VALMBCK="R" W !,"The ",$P(^XTMP("GMRAFX","IDX",ENTRY),U)," group is being edited by another user" D WAIT S LOCK=0
"RTN","GMRAFX3",99,0)
 Q LOCK
"RTN","GMRAFX3",100,0)
 ;
"RTN","GMRAFX3",101,0)
AR ;Add/edit patient reactions
"RTN","GMRAFX3",102,0)
 N LCV,DFN,SUB
"RTN","GMRAFX3",103,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX3",104,0)
 W !!,"You should use this option to add NEW reactions only.  If you mark"
"RTN","GMRAFX3",105,0)
 W !,"existing free text entries as entered in error from within this option it will"
"RTN","GMRAFX3",106,0)
 W !,"not update the utility's display until the list is rebuilt upon re-entry"
"RTN","GMRAFX3",107,0)
 W !,"of this option.  This could cause confusion as the list will no longer"
"RTN","GMRAFX3",108,0)
 W !,"be accurate.",!
"RTN","GMRAFX3",109,0)
 I '$G(NMBR2) D WAIT,EN1^GMRAPEM0 Q
"RTN","GMRAFX3",110,0)
 F LCV=1:1:$L(NMBR2,",")-1 S SUB=$P(NMBR2,",",LCV) S DFN=+$P($G(^GMR(120.8,+$P($G(^TMP($J,"IDX2",SUB)),U,2),0)),U) I DFN W !!,"Now working with patient ",$$GET1^DIQ(2,DFN,.01),! D WAIT D EN2^GMRAPEM0
"RTN","GMRAFX3",111,0)
 Q
"RTN","GMRAFX3",112,0)
 ;
"RTN","GMRAFX3",113,0)
DSPREACT ;Display detailed information about the free text reactant
"RTN","GMRAFX3",114,0)
 N DIC,DA,GMRAI,STOP,NUM2,DIR,Y
"RTN","GMRAFX3",115,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX3",116,0)
 I '$G(NMBR2) S NMBR2=$$GETNUM("") Q:'+NMBR2
"RTN","GMRAFX3",117,0)
 F GMRAI=1:1:($L(NMBR2,",")-1) D  Q:$G(STOP)
"RTN","GMRAFX3",118,0)
 .S NUM2=$P(NMBR2,",",GMRAI)
"RTN","GMRAFX3",119,0)
 .S DA=$P(^TMP($J,"IDX2",NUM2),U,2) Q:'DA
"RTN","GMRAFX3",120,0)
 .S DIC="^GMR(120.8,"
"RTN","GMRAFX3",121,0)
 .W ! D EN^DIQ
"RTN","GMRAFX3",122,0)
 .S DIR(0)="E",DIR("A")="Press return to continue or '^' to stop" D ^DIR
"RTN","GMRAFX3",123,0)
 .S:$D(DIRUT) STOP=1
"RTN","GMRAFX3",124,0)
 .Q
"RTN","GMRAFX3",125,0)
 Q
"RTN","GMRAOR5")
0^5^B25377225
"RTN","GMRAOR5",1,0)
GMRAOR5 ;HIRMFO/WAA,FPT-OERR HL7 UTILITY ;3/5/04  14:02
"RTN","GMRAOR5",2,0)
 ;;4.0;Adverse Reaction Tracking;**4,12,13,19**;Mar 29, 1996
"RTN","GMRAOR5",3,0)
 ;MSG = HL7 Message array
"RTN","GMRAOR5",4,0)
 ;GMRANODE = IEN of MSG array
"RTN","GMRAOR5",5,0)
 ;GMRAND = Date from MSG(GMRANODE)
"RTN","GMRAOR5",6,0)
 ;GMRAMTP = Message type
"RTN","GMRAOR5",7,0)
 ;Allergy Loader
"RTN","GMRAOR5",8,0)
 ;building GMRAL Array to be used to stuff only new data
"RTN","GMRAOR5",9,0)
 ;GMRAID=sequence number of allergy
"RTN","GMRAOR5",10,0)
 ;~=continuation
"RTN","GMRAOR5",11,0)
 ;GMRAIDO = Sequence # OBSERVED
"RTN","GMRAOR5",12,0)
 ;GMRAIDS = Sequence # SIGN
"RTN","GMRAOR5",13,0)
 ;GMRAIDN = Sequence # NOTES
"RTN","GMRAOR5",14,0)
 ;   GMRADFN=DFN of patient in ^DPT(DFN) Patient (2) file
"RTN","GMRAOR5",15,0)
 ;   GMRAL(GMRAID)=type^file ien^VA Free text drug^file^OERR entry date
"RTN","GMRAOR5",16,0)
 ;                 ^NKA Status^Originator Pt to 200^Observed/Historical
"RTN","GMRAOR5",17,0)
 ;   GMRAL(GMRAID,"O",GMRAIDO)=Observed date^Severity^Observer's DUZ
"RTN","GMRAOR5",18,0)
 ;   GMRAL(GMRAID,"S",GMRAIDS)=IEN of file^Free Text of entry^File of SS
"RTN","GMRAOR5",19,0)
 ;                             ^Date/Time of the SS
"RTN","GMRAOR5",20,0)
 ;   GMRAL(GMRAID,"N",GMRAIDN)=Source of comments(Originator always)
"RTN","GMRAOR5",21,0)
 ;----------------------------------------------------------------------
"RTN","GMRAOR5",22,0)
 ;             Example of data
"RTN","GMRAOR5",23,0)
 ;   GMRADFN=270
"RTN","GMRAOR5",24,0)
 ;   GMRAL(1)="D^5^SHELL FISH^99ALL^2940415.06^n^1270^o"
"RTN","GMRAOR5",25,0)
 ;   GMRAL(1,"O",1)="2940401.1^3^1234"
"RTN","GMRAOR5",26,0)
 ;   GMRAL(1,"S",1)="32^SEVERE RASH^99ALS^2951211.1120"
"RTN","GMRAOR5",27,0)
 ;   GMRAL(1,"N",1)="n"
"RTN","GMRAOR5",28,0)
 ;   GMRAL(1,"N",1,1)=FREE TEXT
"RTN","GMRAOR5",29,0)
 ;******************************************************************
"RTN","GMRAOR5",30,0)
EN1 ;Main entry point to file data
"RTN","GMRAOR5",31,0)
 N %,GMRADUP,GMRAFDN,GMRANKA,GNRAY,X,Y
"RTN","GMRAOR5",32,0)
 Q:'$G(GMRADFN)
"RTN","GMRAOR5",33,0)
 S GMRAL=0
"RTN","GMRAOR5",34,0)
 S GMRAPA=0,GMRADUP=0
"RTN","GMRAOR5",35,0)
 ; See if the patient has been ask about allergies
"RTN","GMRAOR5",36,0)
 S (GMRAYN,GMRANKA)=0,GMRAYN=$P($G(^GMR(120.86,GMRADFN,0)),U,2)
"RTN","GMRAOR5",37,0)
 ;Loop through for each allergy
"RTN","GMRAOR5",38,0)
 F  S GMRAL=$O(GMRAL(GMRAL)) Q:GMRAL<1  D
"RTN","GMRAOR5",39,0)
 .;If GMRANKA="" add the entry into the file
"RTN","GMRAOR5",40,0)
 .I '$D(^GMR(120.86,GMRADFN,0)) K DD,DO,DIC,DINUM,DLAYGO S DIC="^GMR(120.86,",DLAYGO=120.86,DIC(0)="L",(DINUM,X)=GMRADFN D FILE^DICN K DD,DO,DIC,DINUM,DLAYGO D
"RTN","GMRAOR5",41,0)
 ..Q:Y=-1
"RTN","GMRAOR5",42,0)
 ..S GMRAYN=$S($P(GMRAL(GMRAL),U,6)="y":1,1:0)
"RTN","GMRAOR5",43,0)
 ..S $P(^GMR(120.86,GMRADFN,0),U,2,4)=GMRAYN_U_$P(GMRAL(GMRAL),U,7)_U_$P(GMRAL(GMRAL),U,5)
"RTN","GMRAOR5",44,0)
 ..Q
"RTN","GMRAOR5",45,0)
 .N GMRALL,GMRAFN,%
"RTN","GMRAOR5",46,0)
 .S GMRALL=$P(GMRAL(GMRAL),U,3)
"RTN","GMRAOR5",47,0)
 .I $P(GMRAL(GMRAL),U,6)="n" D  Q:GMRALL'=""
"RTN","GMRAOR5",48,0)
 ..; Change to no for allergies
"RTN","GMRAOR5",49,0)
 ..Q:GMRAYN="1"!$D(^GMR(120.86,GMRADFN,0))
"RTN","GMRAOR5",50,0)
 ..S $P(^GMR(120.86,GMRADFN,0),U,2,4)="0"_U_$P(GMRAL(GMRAL),U,7)_U_$P(GMRAL(GMRAL),U,5)
"RTN","GMRAOR5",51,0)
 ..S:'$D(^GMR(120.86,"B",GMRADFN,GMRADFN)) ^(GMRADFN)=""
"RTN","GMRAOR5",52,0)
 ..Q
"RTN","GMRAOR5",53,0)
 .I GMRAYN="0",$P(GMRAL(GMRAL),U,6)="n" Q
"RTN","GMRAOR5",54,0)
 .; see If the entry needs to be added
"RTN","GMRAOR5",55,0)
 .; If the entry is an allergy set 120.86 to "y"
"RTN","GMRAOR5",56,0)
 .I GMRALL'="",$D(^GMR(120.86,GMRADFN,0)) S GMRAYN=1 D
"RTN","GMRAOR5",57,0)
 ..; Change to yes for allergies
"RTN","GMRAOR5",58,0)
 ..S $P(^GMR(120.86,GMRADFN,0),U,2,4)=GMRAYN_U_$P(GMRAL(GMRAL),U,7)_U_$P(GMRAL(GMRAL),U,5)
"RTN","GMRAOR5",59,0)
 ..S:'$D(^GMR(120.86,"B",GMRADFN,GMRADFN)) ^(GMRADFN)=""
"RTN","GMRAOR5",60,0)
 ..Q
"RTN","GMRAOR5",61,0)
 .; Quit if the reaction is a Dup
"RTN","GMRAOR5",62,0)
 .Q:$$DUPCHK^GMRAOR0(GMRADFN,GMRALL)>0
"RTN","GMRAOR5",63,0)
 .S GMRAPA=0
"RTN","GMRAOR5",64,0)
 .K DD,DO,DIC,DINUM,DLAYGO S DIC="^GMR(120.8,",DLAYGO=120.8,DIC(0)="L",X=GMRADFN D FILE^DICN
"RTN","GMRAOR5",65,0)
 .K DD,DO,DIC,DINUM,DLAYGO
"RTN","GMRAOR5",66,0)
 .Q:Y=-1  S GMRAPA=+Y
"RTN","GMRAOR5",67,0)
 .Q:$G(^GMR(120.8,GMRAPA,0))=""
"RTN","GMRAOR5",68,0)
 .F  Q:$$LOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAOR5",69,0)
 .N GMRALN,GMRAVR
"RTN","GMRAOR5",70,0)
 .S GMRALN=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAOR5",71,0)
 .S $P(GMRALN,U,4)=$P(GMRAL(GMRAL),U,5) ; Orig. DT
"RTN","GMRAOR5",72,0)
 .S $P(GMRALN,U,5)=$P(GMRAL(GMRAL),U,7) ; Originator
"RTN","GMRAOR5",73,0)
 .S %=$P(GMRAL(GMRAL),U,4),%=$S(%="99ALL"!(%="99OTH"):"GMRD(120.82,",%="99NDF":$P($$NDFREF^GMRAOR,U,2),%="99PSC":"PS(50.605,",1:"") Q:%=""  ;Bad entry
"RTN","GMRAOR5",74,0)
 .S:$P(GMRAL(GMRAL),U,2)="NOS" $P(GMRAL(GMRAL),U,2)=$S($O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0))>0:$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0)),1:1)
"RTN","GMRAOR5",75,0)
 .S GMRAAR=$P(GMRAL(GMRAL),U,2)_";"_%,$P(GMRALN,U,3)=GMRAAR ;File Ptr
"RTN","GMRAOR5",76,0)
 .I $P(GMRAL(GMRAL),U,3)'="" S $P(GMRALN,U,2)=$P(GMRAL(GMRAL),U,3) ;Free text
"RTN","GMRAOR5",77,0)
 .E  D  ; This code will resolve the free text pointer for the reaction
"RTN","GMRAOR5",78,0)
 ..N GMRALOC,GMRADATA
"RTN","GMRAOR5",79,0)
 ..S GMRALOC="^"_$P($P(GMRALN,U,3),";",2)_+$P(GMRALN,U,3)_",0)"
"RTN","GMRAOR5",80,0)
 ..S GMRADATA=@GMRALOC
"RTN","GMRAOR5",81,0)
 ..S $P(GMRALN,U,2)=$P(GMRADATA,U)
"RTN","GMRAOR5",82,0)
 ..Q
"RTN","GMRAOR5",83,0)
 .S $P(GMRALN,U,20)=$P(GMRAL(GMRAL),U) ;Type of reaction
"RTN","GMRAOR5",84,0)
 .S $P(GMRALN,U,6)=$P(GMRAL(GMRAL),U,8) ;Obs/Hist
"RTN","GMRAOR5",85,0)
 .S $P(GMRALN,U,14)="U" ;Mechanism
"RTN","GMRAOR5",86,0)
 .S $P(GMRALN,U,12)=1 ;Sign-off the reaction
"RTN","GMRAOR5",87,0)
 .; auto-verify?
"RTN","GMRAOR5",88,0)
 .S GMRAVR="",GMRAVR(0)=GMRALN
"RTN","GMRAOR5",89,0)
 .S $P(GMRALN,U,16)=$$VFY^GMRASIGN(.GMRAVR)
"RTN","GMRAOR5",90,0)
 .I $P(GMRALN,U,16) S $P(GMRALN,U,17)=$$NOW^XLFDT
"RTN","GMRAOR5",91,0)
 .; save
"RTN","GMRAOR5",92,0)
 .S ^GMR(120.8,GMRAPA,0)=GMRALN
"RTN","GMRAOR5",93,0)
 .I $D(GMRAL(GMRAL,"S",1)) D SIGN^GMRAOR6(120.8,GMRAPA,.GMRAL) ; S/S
"RTN","GMRAOR5",94,0)
 .; Comments
"RTN","GMRAOR5",95,0)
 .I $D(GMRAL(GMRAL,"N",1)) D COMM^GMRAOR8(GMRAPA,.GMRAL) ; Add comments
"RTN","GMRAOR5",96,0)
 .D EN1^GMRAOR9 K GMRAAR ;stuff ingredients & classes
"RTN","GMRAOR5",97,0)
 .;Re-Index Whole file entry
"RTN","GMRAOR5",98,0)
 .K DIK,DA S DIK="^GMR(120.8,",DA=GMRAPA D IX^DIK K DIK,DA
"RTN","GMRAOR5",99,0)
 .D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAOR5",100,0)
 .S ^TMP($J,"GMRASF",1,GMRAPA)="" D RANGE^GMRASIGN(1) ;**19  Send bulletins upon signing-off
"RTN","GMRAOR5",101,0)
 .S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0)) D VAD^GMRAUTL1($P(^GMR(120.8,GMRAPA,0),U),"",.GMRALOC,.GMRANAM,"",.GMRASSN),BULLT^GMRASEND ;19 Send mark chart bulletin
"RTN","GMRAOR5",102,0)
 .Q:($P(GMRAL(GMRAL),U,1)'["D"!($P(GMRAL(GMRAL),U,8)'["o"))  ;quit if not an observed drug reaction
"RTN","GMRAOR5",103,0)
 .; add Adverse Reaction report.
"RTN","GMRAOR5",104,0)
 .I $G(GMRAL(GMRAL,"O",1))'="" D ADVERSE^GMRAOR7(GMRAPA,.GMRAL)
"RTN","GMRAOR5",105,0)
 .Q
"RTN","GMRAOR5",106,0)
 Q
"RTN","GMRAPES0")
0^4^B70524740
"RTN","GMRAPES0",1,0)
GMRAPES0 ;HIRMFO/RM-SELECT PATIENT ALLERGY TO EDIT ;5/13/04  13:21
"RTN","GMRAPES0",2,0)
 ;;4.0;Adverse Reaction Tracking;**13,17,19**;Mar 29, 1996
"RTN","GMRAPES0",3,0)
EN1 ; GIVEN DFN, SELECT PATIENT ALLERGY
"RTN","GMRAPES0",4,0)
 N GMRAGOUT,ROOT,CNT,LST,NAM,DIR,GMRAET
"RTN","GMRAPES0",5,0)
 S GMRARET=0
"RTN","GMRAPES0",6,0)
 S GMRAPA=-1,GMRANEW=0 R !!,"Enter Causative Agent: ",GMRALAR:DTIME S:'$T GMRALAR="^^" S:GMRALAR="" GMRARET=1 I "^^"[GMRALAR S GMRAOUT='$L(GMRALAR)+1 G Q1
"RTN","GMRAPES0",7,0)
 I GMRALAR?1P.E!($L(GMRALAR)<3)!($L(GMRALAR)>30) S GMRAHLP=1 D EN1^GMRAHLP0 G EN1:'GMRAOUT,Q1
"RTN","GMRAPES0",8,0)
 I GMRALAR?.E1L.E S GMRALAR=$$UP^XLFSTR(GMRALAR)
"RTN","GMRAPES0",9,0)
PAL K Y,DTOUT,DUOUT S DGSENFLG="",DIC="^GMR(120.8,",DIC(0)="SEZ",X=GMRANAM,DIC("S")="I '+$G(^(""ER"")),$P(^(0),U,2)?@(""1""""""_GMRALAR_"""""".E""),$D(^GMR(120.8,""B"",DFN,+Y))",DIC("W")="W $P(^(0),U,2)"
"RTN","GMRAPES0",10,0)
 W !!,"Checking existing PATIENT ALLERGIES (#120.8) file for matches...",!
"RTN","GMRAPES0",11,0)
 D ^DIC S X=$P($G(Y(0)),"^",2) K DIC,DGSENFLG,DTOUT,DUOUT D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",12,0)
 S:+Y>0 GMRAPA=+Y G Q1:+Y>0!GMRAOUT,PAL:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",13,0)
 G Q1:'GMRALAGO
"RTN","GMRAPES0",14,0)
NPA W !!,"Now checking GMR ALLERGIES (#120.82) file for matches...",!
"RTN","GMRAPES0",15,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 X=$P(Y,"^",2) D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",16,0)
 I +Y>0 S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",17,0)
 G Q1:GMRAOUT,NPA:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",18,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAPES0",19,0)
 K Y,DTOUT,DUOUT
"RTN","GMRAPES0",20,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAPES0",21,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM" D ^DIC K DIC D DIC
"RTN","GMRAPES0",22,0)
 I +Y>0 S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",23,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAPES0",24,0)
 K DUOUT,DTOUT,Y
"RTN","GMRAPES0",25,0)
 S ROOT=$$T^PSNAPIS,CNT=0,X=GMRALAR
"RTN","GMRAPES0",26,0)
 I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAPES0",27,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",28,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAPES0",29,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",30,0)
 I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",31,0)
 I CNT>1 D
"RTN","GMRAPES0",32,0)
 .D MATCHES
"RTN","GMRAPES0",33,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",34,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",35,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",36,0)
 D DIC I GMRAOUT S GMRAOUT=GMRAOUT=1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",37,0)
 I +Y>0 S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",38,0)
DRUG W !!,"Now checking the DRUG (#50) file for matches...",! K Y,DTOUT,DUOUT
"RTN","GMRAPES0",39,0)
 S CNT=0,X=GMRALAR K LST
"RTN","GMRAPES0",40,0)
 F ROOT="^PSDRUG(""B"")","^PSDRUG(""C"")" D
"RTN","GMRAPES0",41,0)
 .I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$O(@ROOT@(X,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(X,0)),.01)_" <"_X_">",1:X)
"RTN","GMRAPES0",42,0)
 .S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",43,0)
 ..S CNT=CNT+1,LST(CNT)=$O(@ROOT@(NAM,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(NAM,0)),.01)_" <"_NAM_">",1:NAM)
"RTN","GMRAPES0",44,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",45,0)
 I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",46,0)
 I CNT>1 D
"RTN","GMRAPES0",47,0)
 .D MATCHES
"RTN","GMRAPES0",48,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",49,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",50,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",51,0)
 D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",52,0)
 I +Y>0 S GMRAAR=+Y(0)_";PSDRUG(",GMRAAR(0)=$$GET1^DIQ(50,+Y(0),.01),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",53,0)
 ;19 - Moved ING and CLASS code here
"RTN","GMRAPES0",54,0)
ING W !!,"Now checking the INGREDIENTS (#50.416) file for matches...",!
"RTN","GMRAPES0",55,0)
 K Y,DTOUT,DUOUT S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",X=GMRALAR D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",56,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",57,0)
 G Q1:GMRAOUT,ING:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",58,0)
CLASS W !!,"Now checking VA DRUG CLASS (50.605) file for matches...",!
"RTN","GMRAPES0",59,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",D="C" D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",60,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",61,0)
 G Q1:GMRAOUT,CLASS:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",62,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files."
"RTN","GMRAPES0",63,0)
 W !!,"Before sending an email requesting the addition of a new reactant, please",!,"try entering the first 3 or 4 letters of the reactant to search for",!,"the desired entry.",!
"RTN","GMRAPES0",64,0)
 W !,"Would you like to send an email requesting ",GMRALAR,!,"be added as a causative agent?"
"RTN","GMRAPES0",65,0)
 S DIR("A")="Send email"
"RTN","GMRAPES0",66,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("?")="^D MESS^GMRAPES0"
"RTN","GMRAPES0",67,0)
 D ^DIR
"RTN","GMRAPES0",68,0)
 I Y'=+Y S GMRAOUT=1 G Q1
"RTN","GMRAPES0",69,0)
 I '+Y G EN1
"RTN","GMRAPES0",70,0)
YNDRG ;
"RTN","GMRAPES0",71,0)
 D GETINPUT(.GMRAET)
"RTN","GMRAPES0",72,0)
 S X=$$SENDREQ(DUZ,DFN,GMRALAR,.GMRAET)
"RTN","GMRAPES0",73,0)
 I '+X W !!,"Error - Message not sent - ",$P(X,U,2)
"RTN","GMRAPES0",74,0)
 I +X W !!,"Message sent - NOTE: This reactant was NOT added for this patient."
"RTN","GMRAPES0",75,0)
 W !
"RTN","GMRAPES0",76,0)
Q1 ;
"RTN","GMRAPES0",77,0)
 S:GMRAPA>0 GMRAPA(0)=$S($D(^GMR(120.8,+GMRAPA,0)):^(0),1:"")
"RTN","GMRAPES0",78,0)
 K %,D,DA,DIC,DTOUT,DUOUT,GMRAAR,GMRAHLP,GMRAING,GMRALAGO,GMRALAR,PSNDA,PSODA,X,Y
"RTN","GMRAPES0",79,0)
 Q
"RTN","GMRAPES0",80,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAPES0",81,0)
 S:$D(DTOUT) X="^^" I X="^^" S GMRAOUT=1 Q
"RTN","GMRAPES0",82,0)
 S:$D(DUOUT) Y=0 Q:+Y'>0
"RTN","GMRAPES0",83,0)
YNOK W !?3,X,"   OK" S %=1 D YN^DICN S:%=-1 GMRAOUT=1,Y=-1 Q:GMRAOUT  S:%=2 Y=-1 Q:Y=-1  S:$$DUPCHK(X,DFN,Y) Y=-1 Q:GMRAOUT  I % W ! Q  ;19
"RTN","GMRAPES0",84,0)
 W !?5,$C(7),"ANSWER YES IF THIS IS THE CORRECT ALLERGY/ADVERSE REACTION,",!?5,"ELSE ANSWER NO."
"RTN","GMRAPES0",85,0)
 G YNOK
"RTN","GMRAPES0",86,0)
DUPCHK(X,Y,Z) ;CHECK FOR ENTERED IN ERROR
"RTN","GMRAPES0",87,0)
 N GMRAPA,GMRAGOUT,%,%Y S GMRAGOUT=0
"RTN","GMRAPES0",88,0)
 I $P($G(^GMR(120.8,+Z,0)),U,2)=X Q GMRAGOUT
"RTN","GMRAPES0",89,0)
 I $O(^GMR(120.8,"B",Y,0)) S GMRAPA=0 F  S GMRAPA=$O(^GMR(120.8,"B",Y,GMRAPA)) Q:GMRAPA<1  D  Q:GMRAOUT!(GMRAGOUT)
"RTN","GMRAPES0",90,0)
 .I $P(^GMR(120.8,GMRAPA,0),U,2)'=X Q
"RTN","GMRAPES0",91,0)
 .I $D(^GMR(120.8,GMRAPA,"ER")) D
"RTN","GMRAPES0",92,0)
 ..F  S %=2 W !,?5,$C(7),"This Agent has been Entered in Error once before.",!,?5,"Are you sure you want to select this Agent again" D  Q:%
"RTN","GMRAPES0",93,0)
 ...D YN^DICN S:%'=1 %=2,GMRAOUT=1  S:%Y?2"^" GMRAOUT=2
"RTN","GMRAPES0",94,0)
 ...Q:%  W !,?10,"ENTER 'Y' FOR YES OR 'N' FOR NO"
"RTN","GMRAPES0",95,0)
 ...Q
"RTN","GMRAPES0",96,0)
 ..S GMRAGOUT=%
"RTN","GMRAPES0",97,0)
 ..Q
"RTN","GMRAPES0",98,0)
 .Q
"RTN","GMRAPES0",99,0)
 I GMRAGOUT=0 S GMRAGOUT=1
"RTN","GMRAPES0",100,0)
 Q (GMRAGOUT-1)
"RTN","GMRAPES0",101,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAPES0",102,0)
 N I,J,QUIT
"RTN","GMRAPES0",103,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAPES0",104,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAPES0",105,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAPES0",106,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAPES0",107,0)
 Q
"RTN","GMRAPES0",108,0)
 ;
"RTN","GMRAPES0",109,0)
MORE()  ; -- show more matches
"RTN","GMRAPES0",110,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAPES0",111,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAPES0",112,0)
 D ^DIR
"RTN","GMRAPES0",113,0)
 Q +Y
"RTN","GMRAPES0",114,0)
 ;
"RTN","GMRAPES0",115,0)
SENDREQ(USER,PAT,TEXT,GMRAET) ;Send email to GMRA REQUEST NEW REACTANT indicating user's request for a new allergy
"RTN","GMRAPES0",116,0)
 ;Returns 0^reason for error
"RTN","GMRAPES0",117,0)
 ;        1 if successful
"RTN","GMRAPES0",118,0)
 N XMDUZ,XMY,XMSUB,GMRATXT,XMTEXT,XMZ,XMMG,GMRAUI,GMRAPI,GMRAUS,GMRAPS,CNT,J
"RTN","GMRAPES0",119,0)
 Q:'$G(USER)!('+$G(DUZ))!('$L(TEXT)) "0^Required information missing"
"RTN","GMRAPES0",120,0)
 S XMDUZ="Allergy Package",XMSUB="Request to add new reactant"
"RTN","GMRAPES0",121,0)
 S XMY("G.GMRA REQUEST NEW REACTANT")=""
"RTN","GMRAPES0",122,0)
 S XMY(DUZ)="" ;Include requestor in message
"RTN","GMRAPES0",123,0)
 D GETS^DIQ(200,USER,".01;.132;.138;8","E","GMRAUI"),GETS^DIQ(2,PAT,".01;.09","IE","GMRAPI") S GMRAUS=USER_",",GMRAPS=PAT_","
"RTN","GMRAPES0",124,0)
 S CNT=1
"RTN","GMRAPES0",125,0)
 S GMRATXT(CNT)="A request to add "_TEXT_" as a new reactant was entered",CNT=CNT+1
"RTN","GMRAPES0",126,0)
 S GMRATXT(CNT)="by "_GMRAUI(200,GMRAUS,.01,"E")_" for patient "_GMRAPI(2,GMRAPS,.01,"E")_" ("_$E(GMRAPI(2,GMRAPS,.09,"I"),6,9)_")",CNT=CNT+1
"RTN","GMRAPES0",127,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",128,0)
 S GMRATXT(CNT)="User's contact information:",CNT=CNT+1
"RTN","GMRAPES0",129,0)
 S GMRATXT(CNT)="Title        : "_GMRAUI(200,GMRAUS,8,"E"),CNT=CNT+1
"RTN","GMRAPES0",130,0)
 S GMRATXT(CNT)="Office Phone : "_GMRAUI(200,GMRAUS,.132,"E"),CNT=CNT+1
"RTN","GMRAPES0",131,0)
 S GMRATXT(CNT)="Digital Pager: "_GMRAUI(200,GMRAUS,.138,"E"),CNT=CNT+1
"RTN","GMRAPES0",132,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",133,0)
 I $D(GMRAET) S GMRATXT(CNT)="The user added the following comment:",CNT=CNT+1 F J=1:1:$P(GMRAET(0),U,3) S GMRATXT(CNT)=GMRAET(J,0),CNT=CNT+1
"RTN","GMRAPES0",134,0)
 I $D(GMRAET) S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",135,0)
 S GMRATXT(CNT)="Please verify with the user the intended reactant and then take the",CNT=CNT+1
"RTN","GMRAPES0",136,0)
 S GMRATXT(CNT)="appropriate action.  Be sure to try alternate spellings, etc before",CNT=CNT+1
"RTN","GMRAPES0",137,0)
 S GMRATXT(CNT)="adding new local allergies.",CNT=CNT+1
"RTN","GMRAPES0",138,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",139,0)
 S GMRATXT(CNT)="Please note, a reaction WAS NOT entered for this patient!",CNT=CNT+1
"RTN","GMRAPES0",140,0)
 S XMTEXT="GMRATXT("
"RTN","GMRAPES0",141,0)
 D ^XMD
"RTN","GMRAPES0",142,0)
 Q $S($D(XMMG):"0^Mail group GMRA REQUEST NEW REACTANT has no members - contact IRM",1:1)
"RTN","GMRAPES0",143,0)
 ;
"RTN","GMRAPES0",144,0)
MESS ;Provide help for sending email message
"RTN","GMRAPES0",145,0)
 W !,"Enter YES to send an email to the allergy coordinator(s) indicating that",!,"Reactant--> ",GMRALAR,!,"was not found when you were trying to add it for this patient.",!,"Enter NO to try entering the reactant again."
"RTN","GMRAPES0",146,0)
 Q
"RTN","GMRAPES0",147,0)
 ;
"RTN","GMRAPES0",148,0)
GETINPUT(GMRAET) ;Allow user to add comment to message
"RTN","GMRAPES0",149,0)
 N DIC,DWLW,DWPK,DIWEPSE
"RTN","GMRAPES0",150,0)
 S ^TMP($J,"TEXT",0)=""
"RTN","GMRAPES0",151,0)
 S DIC="^TMP($J,""TEXT"","
"RTN","GMRAPES0",152,0)
 S DWLW=70,DWPK=1,DIWEPSE=""
"RTN","GMRAPES0",153,0)
 W !!,"You may now add any comments you may have to the message that",!,"is going to be sent with the request to add this reactant."
"RTN","GMRAPES0",154,0)
 W !,"You may want to add things like sign/symptoms, observed or historical, etc",!,"that may be useful to the reviewer.",!
"RTN","GMRAPES0",155,0)
 D EN^DIWE
"RTN","GMRAPES0",156,0)
 I $O(^TMP($J,"TEXT",0)) M GMRAET=^TMP($J,"TEXT")
"RTN","GMRAPES0",157,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAPES0",158,0)
 Q
"RTN","GMRASEN2")
0^10^B8074289
"RTN","GMRASEN2",1,0)
GMRASEN2 ;HIRMFO/WAA-SEND ID BAND/CHART MARK TO BULLETIN/TEAM ;5/4/04  10:26
"RTN","GMRASEN2",2,0)
 ;;4.0;Adverse Reaction Tracking;**14,19**;Mar 29, 1996
"RTN","GMRASEN2",3,0)
BULLT ; SEND GMRA MARK CHART BULLETIN
"RTN","GMRASEN2",4,0)
 S GMRAOUT=0 K GMRASEND
"RTN","GMRASEN2",5,0)
 I '$D(GMRASITE) D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRASEN2",6,0)
 I $P(GMRASITE(0),U,8)=2 Q
"RTN","GMRASEN2",7,0)
 I $P(GMRASITE(0),U,8)<1!($$VERSION^XPDUTL("OR")<2) D  K GMRASEND,GMRASND,GMRABULL Q
"RTN","GMRASEN2",8,0)
 .S GMRABULL=$$FIND1^DIC(3.8,,"BX","GMRA MARK CHART") ;19
"RTN","GMRASEN2",9,0)
 .I GMRABULL<1 D:'$D(ZTQUEUED)&('$$BROKER^XWBLIB)  Q  ;19
"RTN","GMRASEN2",10,0)
 ..W !,"PLEASE CONTACT IRM TO CREATE A MAIL GROUP: GMRA MARK CHART",$C(7) S GMRASEND(DUZ)=""
"RTN","GMRASEN2",11,0)
 ..K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","GMRASEN2",12,0)
 ..Q
"RTN","GMRASEN2",13,0)
 .I '$$GOTLOCAL^XMXAPIG(GMRABULL) D:'$D(ZTQUEUED)&('$$BROKER^XWBLIB)  Q  ;19
"RTN","GMRASEN2",14,0)
 ..W !,"CALL IRM AND HAVE USERS ASSIGNED TO THE GMRA MARK CHART MAIL GROUP",$C(7)
"RTN","GMRASEN2",15,0)
 ..K DIR S DIR(0)="E" D ^DIR K DIR S GMRASEND(DUZ)=""
"RTN","GMRASEN2",16,0)
 ..Q
"RTN","GMRASEN2",17,0)
 .E  S GMRASEND("G.GMRA MARK CHART")="" ;19
"RTN","GMRASEN2",18,0)
 .D PID^VADPT6 S GMRAVIP=VA("PID") D KVAR^VADPT K VA
"RTN","GMRASEN2",19,0)
 .D BUL(.GMRASEND)
"RTN","GMRASEN2",20,0)
 .Q
"RTN","GMRASEN2",21,0)
 S GMRAPAT=$P(GMRAPA(0),U)_";DPT("
"RTN","GMRASEN2",22,0)
 S GMRATEAM=0 F  S GMRATEAM=$O(^OR(100.21,"AB",GMRAPAT,GMRATEAM)) Q:GMRATEAM<1  D
"RTN","GMRASEN2",23,0)
 .Q:'$D(^OR(100.21,GMRATEAM,0))
"RTN","GMRASEN2",24,0)
 .S GMRASEND=0 F  S GMRASEND=$O(^OR(100.21,GMRATEAM,1,GMRASEND)) Q:GMRASEND<1  D
"RTN","GMRASEN2",25,0)
 ..Q:'$D(^OR(100.21,GMRATEAM,1,GMRASEND,0))
"RTN","GMRASEN2",26,0)
 ..S GMRASEND(GMRASEND)=""
"RTN","GMRASEN2",27,0)
 ..Q
"RTN","GMRASEN2",28,0)
 .Q
"RTN","GMRASEN2",29,0)
 ;*********************************************************************
"RTN","GMRASEN2",30,0)
 D BUL(.GMRASEND)
"RTN","GMRASEN2",31,0)
 K GMRAPAT,GMRATEAM,GMRASEND
"RTN","GMRASEN2",32,0)
 Q
"RTN","GMRASEN2",33,0)
BUL(XMY) ;MAIL A BULLETIN TO A GROUP OR PERSON
"RTN","GMRASEN2",34,0)
 I '($D(XMY)\10) W:'$D(ZTQUEUED)&('$$BROKER^XWBLIB) !,"CALL IRM THERE IS NO ONE TO RECEIVE THIS BULLETIN",$C(7) S GMRAOUT=1 Q  ;19
"RTN","GMRASEN2",35,0)
 S XMB(1)=GMRANAM,XMB(3)=$S(GMRALOC'="":GMRALOC,1:"Outpatient"),XMB(4)=GMRAVIP ;19
"RTN","GMRASEN2",36,0)
 I '$D(GMRAPA2(2)) S XMB(2)=$P(GMRAPA2(1),U),XMB(5)=$P(GMRAPA2(1),U,2)
"RTN","GMRASEN2",37,0)
 E  S XMB(2)="See listing of allergies below." D
"RTN","GMRASEN2",38,0)
 .S GMRAPA2=0 F  S GMRAPA2=$O(GMRAPA2(GMRAPA2)) Q:GMRAPA2<1  D
"RTN","GMRASEN2",39,0)
 ..N GMRALN,GMRASPC
"RTN","GMRASEN2",40,0)
 ..S GMRASPC="                                             "
"RTN","GMRASEN2",41,0)
 ..S GMRALN=GMRAPA2(GMRAPA2)
"RTN","GMRASEN2",42,0)
 ..S GMRAPA2(GMRAPA2)=$E($P(GMRALN,U),1,38)
"RTN","GMRASEN2",43,0)
 ..S GMRAPA2(GMRAPA2)=GMRAPA2(GMRAPA2)_$E(GMRASPC,$L(GMRAPA2(GMRAPA2)),40)
"RTN","GMRASEN2",44,0)
 ..S GMRAPA2(GMRAPA2)=GMRAPA2(GMRAPA2)_$P(GMRALN,U,2)
"RTN","GMRASEN2",45,0)
 ..Q
"RTN","GMRASEN2",46,0)
 .S GMRAPA2=0 S XMTEXT="GMRAPA2(",GMRAPA2(.4)=""
"RTN","GMRASEN2",47,0)
 .S GMRAPA2(.5)="This patient has the following allergies:"
"RTN","GMRASEN2",48,0)
 .S GMRAPA2(.6)=""
"RTN","GMRASEN2",49,0)
 .S GMRAPA2(.7)="Causative Agent                         Mechanism"
"RTN","GMRASEN2",50,0)
 .S GMRAPA2(.8)="---------------                         ---------"
"RTN","GMRASEN2",51,0)
 .Q
"RTN","GMRASEN2",52,0)
 D SENDBULL^XMXAPI(DUZ,"GMRA MARK CHART",.XMB,.XMY) ;19
"RTN","GMRASEN2",53,0)
 K GMRAPAT,GMRATEAM,GMRASEND
"RTN","GMRASEN2",54,0)
 Q
"RTN","GMRASEND")
0^9^B8913389
"RTN","GMRASEND",1,0)
GMRASEND ;HIRMFO/WAA-SEND ID BAND/CHART MARK TO BULLETIN/TEAM ;5/13/04  12:48
"RTN","GMRASEND",2,0)
 ;;4.0;Adverse Reaction Tracking;**14,19**;Mar 29, 1996
"RTN","GMRASEND",3,0)
BULLT ; SEND GMRA MARK CHART BULLETIN
"RTN","GMRASEND",4,0)
 I '$D(GMRATYPE) S GMRATYPE="B"
"RTN","GMRASEND",5,0)
 S GMRAOUT=0 K GMRASEND
"RTN","GMRASEND",6,0)
 I '$D(GMRASITE) D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRASEND",7,0)
 I $P(GMRASITE(0),U,8)=2 Q
"RTN","GMRASEND",8,0)
 I $P(GMRASITE(0),U,8)<1!($$VERSION^XPDUTL("OR")<2) D  K GMRASEND,GMRASND,GMRABULL Q
"RTN","GMRASEND",9,0)
 .S GMRABULL=$$FIND1^DIC(3.8,,"BX","GMRA MARK CHART") ;19
"RTN","GMRASEND",10,0)
 .I GMRABULL<1 D:'$D(ZTQUEUED)&('$$BROKER^XWBLIB)  Q  ;19
"RTN","GMRASEND",11,0)
 ..W !,"PLEASE CONTACT IRM TO CREATE A MAIL GROUP: GMRA MARK CHART",$C(7) S GMRASEND(DUZ)=""
"RTN","GMRASEND",12,0)
 ..K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","GMRASEND",13,0)
 ..Q
"RTN","GMRASEND",14,0)
 .I '$$GOTLOCAL^XMXAPIG(GMRABULL) D:'$D(ZTQUEUED)&('$$BROKER^XWBLIB)  Q  ;19
"RTN","GMRASEND",15,0)
 ..W !,"CALL IRM AND HAVE USERS ASSIGNED TO THE GMRA MARK CHART MAIL GROUP",$C(7)
"RTN","GMRASEND",16,0)
 ..K DIR S DIR(0)="E" D ^DIR K DIR S GMRASEND(DUZ)=""
"RTN","GMRASEND",17,0)
 ..Q
"RTN","GMRASEND",18,0)
 .E  S GMRASEND("G.GMRA MARK CHART")="" ;19
"RTN","GMRASEND",19,0)
 .S DFN=$P(GMRAPA(0),U) D INP^VADPT S:'+VAIN(4) GMRALOC=""
"RTN","GMRASEND",20,0)
 .I +VAIN(4) S GMRAHLOC=+$G(^DIC(42,+VAIN(4),44)),GMRALOC=$P(VAIN(4),U,2)
"RTN","GMRASEND",21,0)
 .D PID^VADPT6 S GMRAVIP=VA("PID") D KVAR^VADPT K VA
"RTN","GMRASEND",22,0)
 .D BUL(.GMRASEND,GMRATYPE)
"RTN","GMRASEND",23,0)
 .Q
"RTN","GMRASEND",24,0)
 ;=====================================================================
"RTN","GMRASEND",25,0)
 S GMRAPAT=$P(GMRAPA(0),U)_";DPT("
"RTN","GMRASEND",26,0)
 S GMRATEAM=0 F  S GMRATEAM=$O(^OR(100.21,"AB",GMRAPAT,GMRATEAM)) Q:GMRATEAM<1  D
"RTN","GMRASEND",27,0)
 .Q:'$D(^OR(100.21,GMRATEAM,0))
"RTN","GMRASEND",28,0)
 .S GMRASEND=0 F  S GMRASEND=$O(^OR(100.21,GMRATEAM,1,GMRASEND)) Q:GMRASEND<1  D
"RTN","GMRASEND",29,0)
 ..Q:'$D(^OR(100.21,GMRATEAM,1,GMRASEND,0))
"RTN","GMRASEND",30,0)
 ..S GMRASEND(GMRASEND)=""
"RTN","GMRASEND",31,0)
 ..Q
"RTN","GMRASEND",32,0)
 .Q
"RTN","GMRASEND",33,0)
 ;*********************************************************************
"RTN","GMRASEND",34,0)
 D BUL(.GMRASEND,GMRATYPE)
"RTN","GMRASEND",35,0)
 K GMRAPAT,GMRATEAM,GMRASEND
"RTN","GMRASEND",36,0)
 Q
"RTN","GMRASEND",37,0)
BUL(XMY,GMRATYPE) ;MAIL A BULLETIN TO A GROUP OR PERSON
"RTN","GMRASEND",38,0)
 I '$D(GMRAVIP) S DFN=$P(GMRAPA(0),U) D PID^VADPT6 S GMRAVIP=VA("PID") D KVAR^VADPT K VA
"RTN","GMRASEND",39,0)
 I '($D(XMY)\10) W:'$D(ZTQUEUED)&('$$BROKER^XWBLIB) !,"CALL IRM THERE IS NO ONE TO RECEIVE THIS BULLETIN",$C(7) S GMRAOUT=1 Q  ;19
"RTN","GMRASEND",40,0)
 I GMRATYPE="A",$P(GMRASITE(0),U,9)'=0 D  Q
"RTN","GMRASEND",41,0)
 .N GMRA
"RTN","GMRASEND",42,0)
 .S GMRA=0 F  S GMRA=$O(XMY(GMRA)) Q:GMRA<1  S XQA(GMRA)=""
"RTN","GMRASEND",43,0)
 .K XMY
"RTN","GMRASEND",44,0)
 .S XQAMSG="Mark Chart"_$S(GMRALOC'="":"/ID Band",1:"")_" for "_$E(GMRANAM,1,30)_","_GMRAVIP_" with "_$E($P(GMRAPA(0),U,2),1,20)
"RTN","GMRASEND",45,0)
 .D SETUP^XQALERT
"RTN","GMRASEND",46,0)
 .Q
"RTN","GMRASEND",47,0)
 S XMB(1)=GMRANAM,XMB(3)=$S(GMRALOC'="":GMRALOC,1:"Outpatient"),XMB(4)=GMRAVIP,XMB(2)=$P(GMRAPA(0),U,2) ;19
"RTN","GMRASEND",48,0)
 S XMB(5)=$S($P(GMRAPA(0),U,14)="A":"Allergy",$P(GMRAPA(0),U,14)="P":"Adverse Reaction",$P(GMRAPA(0),U,14)="U":"Unknown",1:"")
"RTN","GMRASEND",49,0)
 N GMRAXMB,GMRAXMY ;19
"RTN","GMRASEND",50,0)
 M GMRAXMB=XMB,GMRAXMY=XMY ;19
"RTN","GMRASEND",51,0)
 D SENDBULL^XMXAPI(DUZ,"GMRA MARK CHART",.GMRAXMB,,.GMRAXMY) ;19
"RTN","GMRASEND",52,0)
 Q
"RTN","GMRASIGN")
0^8^B37583197
"RTN","GMRASIGN",1,0)
GMRASIGN ;HIRMFO/WAA-ALLERGY/ADVERSE REACTION PATIENT SIGN OFF ;5/4/04  12:33
"RTN","GMRASIGN",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19**;Mar 29, 1996
"RTN","GMRASIGN",3,0)
SIGNOFF ; The signoff code
"RTN","GMRASIGN",4,0)
 N GMRAOUT,GMRACNTT S GMRAOUT=0 ;19
"RTN","GMRASIGN",5,0)
 S GMRASIGN=0
"RTN","GMRASIGN",6,0)
 D ENCNT^GMRASIG1 ; Count entries
"RTN","GMRASIGN",7,0)
 D SOQ ; Display entries and ask if user wants all the entries signed.
"RTN","GMRASIGN",8,0)
 I 'Y D  ; User said no the sign off question
"RTN","GMRASIGN",9,0)
 .I GMRACNTT>1 S GMRASIGN=1 D YNSO^GMRASIG1 I Y'=0 D RANGE(Y) ; User had more than one entry
"RTN","GMRASIGN",10,0)
 .D ALERT ; Ask Delete and trigger alerts for those non delete entries 
"RTN","GMRASIGN",11,0)
 .Q
"RTN","GMRASIGN",12,0)
 K GMRASITE ; force the update of the site parameters
"RTN","GMRASIGN",13,0)
 D PNOTE^GMRASIG1 ; File progress note
"RTN","GMRASIGN",14,0)
 K ^TMP($J,"GMRASF") ; clean up the temp globals
"RTN","GMRASIGN",15,0)
 Q
"RTN","GMRASIGN",16,0)
SOQ ;Sign off on all allergies for a patient
"RTN","GMRASIGN",17,0)
 W @IOF,!,"Causative Agent Data edited this Session:"
"RTN","GMRASIGN",18,0)
 K X D PRINT^GMRASIG1 ; Display entries edit this session
"RTN","GMRASIGN",19,0)
 N DIR
"RTN","GMRASIGN",20,0)
 S DIR(0)="YA",DIR("B")="NO"
"RTN","GMRASIGN",21,0)
 S DIR("?")="PLEASE ENTER 'Y' IF THE DATA IS CORRECT OR 'N' IF IT IS NOT CORRECT"
"RTN","GMRASIGN",22,0)
 S DIR("??")="^D PRINT^GMRASIG1"
"RTN","GMRASIGN",23,0)
 S DIR("A")=$S(GMRACNTT>1:"Are ALL these",1:"Is this")_" correct? "
"RTN","GMRASIGN",24,0)
 D ^DIR
"RTN","GMRASIGN",25,0)
 I $D(DIRUT) S Y=0,GMRAOUT=1 ; user ^ or timed out
"RTN","GMRASIGN",26,0)
 I Y=0 Q  ; user answered no the sign off
"RTN","GMRASIGN",27,0)
 D ALLSNG,RANGE(Y) ; sign all the entries
"RTN","GMRASIGN",28,0)
 S Y=1
"RTN","GMRASIGN",29,0)
 Q
"RTN","GMRASIGN",30,0)
ALLSNG ;Sign off on all
"RTN","GMRASIGN",31,0)
 N X
"RTN","GMRASIGN",32,0)
 S Y="",X=0
"RTN","GMRASIGN",33,0)
 F  S X=$O(^TMP($J,"GMRASF",X)) Q:X<1  S Y=Y_X_","
"RTN","GMRASIGN",34,0)
 Q
"RTN","GMRASIGN",35,0)
RANGE(GMRARNG) ;Sign off select allergies
"RTN","GMRASIGN",36,0)
 ;Input:
"RTN","GMRASIGN",37,0)
 ;   GMRARNG = The entries that need to be signed
"RTN","GMRASIGN",38,0)
 ;
"RTN","GMRASIGN",39,0)
 N GMRATYPE ;19
"RTN","GMRASIGN",40,0)
 F I=1:1 S GMRACNT=$P(GMRARNG,",",I) Q:GMRACNT<1  S GMRAPA=$O(^TMP($J,"GMRASF",GMRACNT,0)) Q:GMRAPA'>0  D
"RTN","GMRASIGN",41,0)
 .N I,GMRARNG
"RTN","GMRASIGN",42,0)
 .S DA=GMRAPA,DIE="^GMR(120.8,",DR="15////1" D ^DIE
"RTN","GMRASIGN",43,0)
 .S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRASIGN",44,0)
 .S GMRATYPE=$P(GMRAPA(0),U,20)
"RTN","GMRASIGN",45,0)
 .S GMRASLL(GMRAPA)=0
"RTN","GMRASIGN",46,0)
 .I '$P(GMRAPA(0),U,16) D
"RTN","GMRASIGN",47,0)
 ..N GMRACNT K DR S DA=GMRAPA,DIE="^GMR(120.8,"
"RTN","GMRASIGN",48,0)
 ..I $$VFY(.GMRAPA) D
"RTN","GMRASIGN",49,0)
 ...S DR="19////1;20///N" D ^DIE
"RTN","GMRASIGN",50,0)
 ...Q
"RTN","GMRASIGN",51,0)
 ..E  S DR="19////0" D ^DIE,EN1^GMRAVAB
"RTN","GMRASIGN",52,0)
 ..S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRASIGN",53,0)
 .I $P(GMRAPA(0),U,6)="o",GMRATYPE["D" D PTBUL^GMRAROBS
"RTN","GMRASIGN",54,0)
 .D  ; Execute the event point for this reaction
"RTN","GMRASIGN",55,0)
 ..Q:'$D(GMRAPA)  S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRASIGN",56,0)
 ..N OROLD,DFN,GMRACNT S DFN=$P(GMRAPA(0),U)
"RTN","GMRASIGN",57,0)
 ..D INP^VADPT S X=$$FIND1^DIC(101,,"BX","GMRA SIGN-OFF ON DATA")_";ORD(101," D EN^XQOR:X K VAIN,X ;19
"RTN","GMRASIGN",58,0)
 ..Q
"RTN","GMRASIGN",59,0)
 .K ^TMP($J,"GMRASF",GMRACNT,GMRAPA),^TMP($J,"GMRASF","B",GMRAPA,GMRACNT)
"RTN","GMRASIGN",60,0)
 .Q
"RTN","GMRASIGN",61,0)
 Q
"RTN","GMRASIGN",62,0)
ALERT ; SENDS ALERT FOR ALL DATA THAT IS UNSIGNED
"RTN","GMRASIGN",63,0)
 I '$O(^TMP($J,"GMRASF",0)) Q
"RTN","GMRASIGN",64,0)
 D REMAIN ;D DEL^GMRADEL ; Ask user if they want to delete given entries
"RTN","GMRASIGN",65,0)
 Q:$D(XQADATA)  ; user is processing alert
"RTN","GMRASIGN",66,0)
 S (GMRACNT,GMRACNTF)=0 F  S GMRACNT=$O(^TMP($J,"GMRASF",GMRACNT)) Q:GMRACNT<1  S GMRAPA=$O(^TMP($J,"GMRASF",GMRACNT,0)) Q:GMRAPA<1  D
"RTN","GMRASIGN",67,0)
 .S GMRAPA(0)=(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRASIGN",68,0)
 .S XQA(DUZ)=""
"RTN","GMRASIGN",69,0)
 .S XQAMSG=GMRANAM_" with reaction of "_$P(GMRAPA(0),U,2)_" has not been Signed off."
"RTN","GMRASIGN",70,0)
 .S XQAID="GMASignoff Alert"
"RTN","GMRASIGN",71,0)
 .S XQADATA=DFN_U_GMRAPA_U_$G(GMRAUSER,0)
"RTN","GMRASIGN",72,0)
 .S XQAROU="ALERT^GMRAPEM0"
"RTN","GMRASIGN",73,0)
 .D SETUP^XQALERT
"RTN","GMRASIGN",74,0)
 .D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRASIGN",75,0)
 .I 'GMRACNTF W !,?5,"Please Note that these UNSIGNED Causative Agents ",!,?5,"will not show in the patient's records.",$C(7) D HANGT^GMRAPEH0 S GMRACNTF=1
"RTN","GMRASIGN",76,0)
 .S X=$O(^TMP($J,"GMRASF","B",GMRAPA,0))
"RTN","GMRASIGN",77,0)
 .K ^TMP($J,"GMRASF",X,GMRAPA),^TMP($J,"GMRASF","B",GMRAPA,X)
"RTN","GMRASIGN",78,0)
 .Q
"RTN","GMRASIGN",79,0)
 K XQA,XQAMSG,GMRACNTF
"RTN","GMRASIGN",80,0)
 Q
"RTN","GMRASIGN",81,0)
IDBAND ; Mark ID Bands and Charts for a given patient
"RTN","GMRASIGN",82,0)
 I $D(GMRASLL) D
"RTN","GMRASIGN",83,0)
 .D EN4^GMRAMCB(.GMRASLL,DFN) S GMRAPA=0 F  S GMRAPA=$O(GMRASLL(GMRAPA)) Q:GMRAPA<1  D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRASIGN",84,0)
 .K GMRASLL
"RTN","GMRASIGN",85,0)
 .Q
"RTN","GMRASIGN",86,0)
 Q
"RTN","GMRASIGN",87,0)
VFY(Y) ;THIS FUNCTION WILL RETURN TRUE IF THIS ALLERGY IS AUTO VERIFIED
"RTN","GMRASIGN",88,0)
 N GMRAPASS,X
"RTN","GMRASIGN",89,0)
 S GMRAPASS=0
"RTN","GMRASIGN",90,0)
 I '$D(GMRASITE) D SITE^GMRAUTL
"RTN","GMRASIGN",91,0)
 S X=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRASIGN",92,0)
 S GMRATYPE=$P(Y(0),U,20)
"RTN","GMRASIGN",93,0)
 I @(($P(Y(0),U,6)="o"&($P(X,U,3)\2)!($P(Y(0),U,6)="h"&($P(X,U,3)#2)))_$S($P(X,U,6)="&":"&",1:"!")_(GMRATYPE["F"&($P(X,U,2)\2#2)!(GMRATYPE["D"&($P(X,U,2)#2))!(GMRATYPE["O"&($P(X,U,2)\4)))) S GMRAPASS=1
"RTN","GMRASIGN",94,0)
 Q GMRAPASS
"RTN","GMRASIGN",95,0)
 Q
"RTN","GMRASIGN",96,0)
 ;
"RTN","GMRASIGN",97,0)
REMAIN ;Review remaining entries that were not signed off.  Entire section added with patch 17
"RTN","GMRASIGN",98,0)
 N GMRAPA,LCVJ,Y,DIR,DIRUT,DUOUT,SIGNED,GMRAOUT,GMRANEW,DIC,DONE
"RTN","GMRASIGN",99,0)
 S SIGNED=""
"RTN","GMRASIGN",100,0)
 S LCVJ=0 F  S LCVJ=$O(^TMP($J,"GMRASF",LCVJ)) Q:'+LCVJ  D
"RTN","GMRASIGN",101,0)
 .S GMRAPA=$O(^TMP($J,"GMRASF",LCVJ,0)) Q:'+GMRAPA  S GMRAPA(0)=^GMR(120.8,GMRAPA,0)
"RTN","GMRASIGN",102,0)
 .S DIR(0)="SB^Edit:Edit;Delete:Delete",DIR("B")="Edit",DIR("?")="You must edit or delete the entry.  Entering ^ will return you to editing."
"RTN","GMRASIGN",103,0)
 .S DIR("A")="For reactant "_$P(GMRAPA(0),U,2) D ^DIR S:$G(DIRUT) Y="E"
"RTN","GMRASIGN",104,0)
 .I $E(Y)="D" Q  ;Do nothing if allergy is to be deleted
"RTN","GMRASIGN",105,0)
 .S GMRANEW=0
"RTN","GMRASIGN",106,0)
 .F  D  Q:DONE
"RTN","GMRASIGN",107,0)
 ..S DONE=0,GMRAOUT=0
"RTN","GMRASIGN",108,0)
 ..D EDIT^GMRAPEM4 W !
"RTN","GMRASIGN",109,0)
 ..I $P(^GMR(120.8,GMRAPA,0),U,6)="o" I '$D(^GMR(120.85,"C",GMRAPA))!('$O(^GMR(120.85,+$O(^GMR(120.85,"C",GMRAPA,0)),2,0)))!('$$REQCOM^GMRAPEM0) D  Q
"RTN","GMRASIGN",110,0)
 ...W !,"Observed reactions require the date of the reaction and",!,"sign/symptoms",$S('$$REQCOM^GMRAPEM0:" and comments.",1:"."),!
"RTN","GMRASIGN",111,0)
 ...S DIR(0)="SA^R:Re-edit;D:Delete",DIR("A")="Do you want to (R)e-edit or (D)elete this entry? ",DIR("B")="R" D ^DIR S:Y'="R" DONE=1 Q
"RTN","GMRASIGN",112,0)
 ..I $P(^GMR(120.8,GMRAPA,0),U,6)="h",$D(^GMR(120.85,"C",GMRAPA)) D DELOBS ;Delete observed data if changing to historical
"RTN","GMRASIGN",113,0)
 ..S DIR(0)="Y",DIR("A")="Is this entry now correct",DIR("B")="Y",DIR("?")="Answer yes to accept the allergy.  Enter NO to re-edit.  Enter ^ to delete this entry." D ^DIR
"RTN","GMRASIGN",114,0)
 ..I Y=0 Q
"RTN","GMRASIGN",115,0)
 ..I $G(DIRUT) S DONE=1 Q
"RTN","GMRASIGN",116,0)
 ..S SIGNED=SIGNED_LCVJ_",",DONE=1
"RTN","GMRASIGN",117,0)
 I $L(SIGNED)>1 D RANGE(SIGNED) ;Sign off on accepted allergies
"RTN","GMRASIGN",118,0)
 I $O(^TMP($J,"GMRASF",0)) D DELETE^GMRADEL ;Delete unaccepted entries
"RTN","GMRASIGN",119,0)
 Q
"RTN","GMRASIGN",120,0)
 ;
"RTN","GMRASIGN",121,0)
DELOBS ;Delete observed data from 120.85
"RTN","GMRASIGN",122,0)
 N OIEN,DIK,DA
"RTN","GMRASIGN",123,0)
 S OIEN=0 F  S OIEN=$O(^GMR(120.85,"C",GMRAPA,OIEN)) Q:'+OIEN  S DIK="^GMR(120.85,",DA=OIEN D ^DIK
"RTN","GMRASIGN",124,0)
 Q
"RTN","GMRAY19")
0^6^B9980438
"RTN","GMRAY19",1,0)
GMRAY19 ;SLC/DAN Post-install for patch 19 ;5/4/04  10:24
"RTN","GMRAY19",2,0)
 ;;4.0;Adverse Reaction Tracking;**19**;Mar 29, 1996
"RTN","GMRAY19",3,0)
 ;DBIA SECTION
"RTN","GMRAY19",4,0)
 ;10063 - %ZTLOAD
"RTN","GMRAY19",5,0)
 ; 3744 - $$TESTPAT^VADPT
"RTN","GMRAY19",6,0)
 ;10018 - DIE
"RTN","GMRAY19",7,0)
 ;10103 - XLFDT
"RTN","GMRAY19",8,0)
 ;10070 - XMD
"RTN","GMRAY19",9,0)
 ;10141 - XPDUTL
"RTN","GMRAY19",10,0)
 ;
"RTN","GMRAY19",11,0)
Q ;Entry point to queue process during install
"RTN","GMRAY19",12,0)
 N ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSK
"RTN","GMRAY19",13,0)
 S ZTRTN="DQ^GMRAY19",ZTDESC="GMRA*4*19 POST INSTALL ROUTINE",ZTIO="",ZTDTH=$H
"RTN","GMRAY19",14,0)
 D ^%ZTLOAD I '$G(ZTSK) D BMES^XPDUTL("POST INSTALL NOT QUEUED - RUN DQ^GMRA19 AFTER INSTALL FINISHES") Q
"RTN","GMRAY19",15,0)
 D BMES^XPDUTL("Post-install queued as task # "_$G(ZTSK))
"RTN","GMRAY19",16,0)
 Q
"RTN","GMRAY19",17,0)
 ;
"RTN","GMRAY19",18,0)
DQ ;Dequeue
"RTN","GMRAY19",19,0)
 N TCNT,VCNT
"RTN","GMRAY19",20,0)
 D POST,MAIL
"RTN","GMRAY19",21,0)
 Q
"RTN","GMRAY19",22,0)
 ;
"RTN","GMRAY19",23,0)
POST ;Post-install for patch 19
"RTN","GMRAY19",24,0)
 N IEN,GMRA0,GMRAV,DIE,DA,DR,VER,DFN
"RTN","GMRAY19",25,0)
 S (IEN,TCNT,VCNT)=0 F  S IEN=$O(^GMR(120.8,IEN)) Q:'+IEN  D
"RTN","GMRAY19",26,0)
 .S GMRA0=$G(^GMR(120.8,IEN,0)) ;Set GMRA0 to zero node
"RTN","GMRAY19",27,0)
 .Q:GMRA0=""  ;Quit if no zero node
"RTN","GMRAY19",28,0)
 .Q:$P(GMRA0,U,16)'=""  ;Quit if verified field set
"RTN","GMRAY19",29,0)
 .Q:+$G(^GMR(120.8,IEN,"ER"))  ;Quit if entered in error
"RTN","GMRAY19",30,0)
 .S DFN=$P(GMRA0,U) Q:'+DFN  ;Quit if no patient identifier
"RTN","GMRAY19",31,0)
 .Q:$$TESTPAT^VADPT(DFN)  ;Quit if test patient
"RTN","GMRAY19",32,0)
 .Q:$$DECEASED^GMRAFX(DFN)  ;Quit if patient is deceased
"RTN","GMRAY19",33,0)
 .S TCNT=TCNT+1
"RTN","GMRAY19",34,0)
 .S GMRAV="",GMRAV(0)=GMRA0
"RTN","GMRAY19",35,0)
 .S VER=$$VFY^GMRASIGN(.GMRAV)
"RTN","GMRAY19",36,0)
 .S DIE=120.8,DA=IEN,DR="19///"_VER S:VER DR=DR_";20///"_$$NOW^XLFDT D ^DIE
"RTN","GMRAY19",37,0)
 .I VER S VCNT=VCNT+1 D ADCOM^GMRAFX(IEN,"V","Auto-verified by patch 19 post-install")
"RTN","GMRAY19",38,0)
 Q
"RTN","GMRAY19",39,0)
 ;
"RTN","GMRAY19",40,0)
MAIL ;Send message indicating post install is finished
"RTN","GMRAY19",41,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,GMRATXT
"RTN","GMRAY19",42,0)
 S XMDUZ="PATCH GMRA*4*19 POST-INSTALL",XMY(.5)="" S:$G(DUZ) XMY(DUZ)=""
"RTN","GMRAY19",43,0)
 S GMRATXT(1)="The post-install routine for patch GMRA*4*19"
"RTN","GMRAY19",44,0)
 S GMRATXT(2)="finished on "_$$FMTE^XLFDT($$NOW^XLFDT)_"."
"RTN","GMRAY19",45,0)
 S GMRATXT(3)=""
"RTN","GMRAY19",46,0)
 I TCNT=0 D
"RTN","GMRAY19",47,0)
 .S GMRATXT(4)="The post-install did not find any entries that were missing the"
"RTN","GMRAY19",48,0)
 .S GMRATXT(5)="verified field.  No further action is required."
"RTN","GMRAY19",49,0)
 I TCNT>0 D
"RTN","GMRAY19",50,0)
 .S GMRATXT(4)="The post-install found "_TCNT_$S(TCNT=1:" entry",1:" entries")_" that were missing"
"RTN","GMRAY19",51,0)
 .S GMRATXT(5)="the verified field.  "_$S(TCNT=VCNT:"All",VCNT=0:"None",1:VCNT)_" of these were auto-verified."
"RTN","GMRAY19",52,0)
 .S:TCNT'=VCNT GMRATXT(6)="The remaining reactants are now available for verification",GMRATXT(7)="using allergy package options."
"RTN","GMRAY19",53,0)
 S XMTEXT="GMRATXT(",XMSUB="PATCH GMRA*4*19 Post Install COMPLETED"
"RTN","GMRAY19",54,0)
 D ^XMD
"RTN","GMRAY19",55,0)
 Q
"VER")
8.0^22.0
**END**
**END**
