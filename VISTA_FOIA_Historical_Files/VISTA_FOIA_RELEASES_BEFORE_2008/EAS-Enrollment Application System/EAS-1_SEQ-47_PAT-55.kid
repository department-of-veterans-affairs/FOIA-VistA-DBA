EMERGENCY Released EAS*1*55 SEQ #47
Extracted from mail message
**KIDS**:EAS*1.0*55^

**INSTALL NAME**
EAS*1.0*55
"BLD",5662,0)
EAS*1.0*55^ENROLLMENT APPLICATION SYSTEM^0^3041020^y
"BLD",5662,4,0)
^9.64PA^^
"BLD",5662,"INI")
CHECK^EAS155PT
"BLD",5662,"INID")
^n^n
"BLD",5662,"INIT")
POST^EAS155P1
"BLD",5662,"KRN",0)
^9.67PA^8989.52^19
"BLD",5662,"KRN",.4,0)
.4
"BLD",5662,"KRN",.401,0)
.401
"BLD",5662,"KRN",.402,0)
.402
"BLD",5662,"KRN",.403,0)
.403
"BLD",5662,"KRN",.5,0)
.5
"BLD",5662,"KRN",.84,0)
.84
"BLD",5662,"KRN",3.6,0)
3.6
"BLD",5662,"KRN",3.8,0)
3.8
"BLD",5662,"KRN",9.2,0)
9.2
"BLD",5662,"KRN",9.8,0)
9.8
"BLD",5662,"KRN",9.8,"NM",0)
^9.68A^7^6
"BLD",5662,"KRN",9.8,"NM",2,0)
EAS155P1^^0^B37338094
"BLD",5662,"KRN",9.8,"NM",3,0)
EASMTL2^^0^B39641010
"BLD",5662,"KRN",9.8,"NM",4,0)
EASUER^^0^B20338353
"BLD",5662,"KRN",9.8,"NM",5,0)
EAS155PT^^0^B44770246
"BLD",5662,"KRN",9.8,"NM",6,0)
EAS150PT^^1^
"BLD",5662,"KRN",9.8,"NM",7,0)
EAS150P1^^0^B22612963
"BLD",5662,"KRN",9.8,"NM","B","EAS150P1",7)

"BLD",5662,"KRN",9.8,"NM","B","EAS150PT",6)

"BLD",5662,"KRN",9.8,"NM","B","EAS155P1",2)

"BLD",5662,"KRN",9.8,"NM","B","EAS155PT",5)

"BLD",5662,"KRN",9.8,"NM","B","EASMTL2",3)

"BLD",5662,"KRN",9.8,"NM","B","EASUER",4)

"BLD",5662,"KRN",19,0)
19
"BLD",5662,"KRN",19.1,0)
19.1
"BLD",5662,"KRN",101,0)
101
"BLD",5662,"KRN",409.61,0)
409.61
"BLD",5662,"KRN",771,0)
771
"BLD",5662,"KRN",870,0)
870
"BLD",5662,"KRN",8989.51,0)
8989.51
"BLD",5662,"KRN",8989.52,0)
8989.52
"BLD",5662,"KRN",8994,0)
8994
"BLD",5662,"KRN","B",.4,.4)

"BLD",5662,"KRN","B",.401,.401)

"BLD",5662,"KRN","B",.402,.402)

"BLD",5662,"KRN","B",.403,.403)

"BLD",5662,"KRN","B",.5,.5)

"BLD",5662,"KRN","B",.84,.84)

"BLD",5662,"KRN","B",3.6,3.6)

"BLD",5662,"KRN","B",3.8,3.8)

"BLD",5662,"KRN","B",9.2,9.2)

"BLD",5662,"KRN","B",9.8,9.8)

"BLD",5662,"KRN","B",19,19)

"BLD",5662,"KRN","B",19.1,19.1)

"BLD",5662,"KRN","B",101,101)

"BLD",5662,"KRN","B",409.61,409.61)

"BLD",5662,"KRN","B",771,771)

"BLD",5662,"KRN","B",870,870)

"BLD",5662,"KRN","B",8989.51,8989.51)

"BLD",5662,"KRN","B",8989.52,8989.52)

"BLD",5662,"KRN","B",8994,8994)

"BLD",5662,"QUES",0)
^9.62^^
"BLD",5662,"REQB",0)
^9.611^2^2
"BLD",5662,"REQB",1,0)
EAS*1.0*22^1
"BLD",5662,"REQB",2,0)
EAS*1.0*50^1
"BLD",5662,"REQB","B","EAS*1.0*22",1)

"BLD",5662,"REQB","B","EAS*1.0*50",2)

"INI")
CHECK^EAS155PT
"INIT")
POST^EAS155P1
"MBREQ")
0
"ORD",0,9.8)
9.8;;1;RTNF^XPDTA;RTNE^XPDTA
"ORD",0,9.8,0)
ROUTINE
"PKG",552,-1)
1^1
"PKG",552,0)
ENROLLMENT APPLICATION SYSTEM^EAS^ENROLLMENT
"PKG",552,20,0)
^9.402P^2^1
"PKG",552,20,2,0)
2^^EASXDR
"PKG",552,20,2,1)
 
"PKG",552,20,"B",2,2)

"PKG",552,22,0)
^9.49I^1^1
"PKG",552,22,1,0)
1.0^3010315^3010419^66481
"PKG",552,22,1,"PAH",1,0)
55^3041020
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","EAS150P1")
0^7^B22612963
"RTN","EAS150P1",1,0)
EAS150P1 ;ALB/SCK - PATCH EAS-50 POST UTILITIES ; 28-APR-2004
"RTN","EAS150P1",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**50,55**;Mar 15, 2004
"RTN","EAS150P1",3,0)
 ;
"RTN","EAS150P1",4,0)
 Q
"RTN","EAS150P1",5,0)
QUE ;
"RTN","EAS150P1",6,0)
 N EACY,%I,Y,DIR,DIRUT
"RTN","EAS150P1",7,0)
 ;
"RTN","EAS150P1",8,0)
 D NOW^%DTC S Y=%I(3) D DD^%DT S EACY=Y
"RTN","EAS150P1",9,0)
 W !!
"RTN","EAS150P1",10,0)
 S DIR(0)="F",DIR("B")=EACY,DIR("A")="Print UE Status Report for Calendar Year"
"RTN","EAS150P1",11,0)
 S DIR("?",1)=""
"RTN","EAS150P1",12,0)
 S DIR("?",2)="This report will display the User Enrollee Status information for all"
"RTN","EAS150P1",13,0)
 S DIR("?",3)="patients with a Means Test Letter pending in the selected Calendar Year."
"RTN","EAS150P1",14,0)
 S DIR("?")="Enter ""ALL"" for all entries."
"RTN","EAS150P1",15,0)
 D ^DIR K DIR
"RTN","EAS150P1",16,0)
 Q:$D(DIRUT)
"RTN","EAS150P1",17,0)
 I +Y>0!(Y="ALL") S EACY=Y
"RTN","EAS150P1",18,0)
 E  Q
"RTN","EAS150P1",19,0)
 ;
"RTN","EAS150P1",20,0)
 S ZTSAVE("DUZ")="",ZTSAVE("EACY")=""
"RTN","EAS150P1",21,0)
 D EN^XUTMDEVQ("EN^EAS150P1","EAS UE STATUS REPORT",.ZTSAVE)
"RTN","EAS150P1",22,0)
 ;
"RTN","EAS150P1",23,0)
 Q
"RTN","EAS150P1",24,0)
 ;
"RTN","EAS150P1",25,0)
EN ; Entry point for UE Status report
"RTN","EAS150P1",26,0)
 N EALIEN,EACNT,EAX,EADFN,EADFN1,EANAME,EAPTR,EAS60
"RTN","EAS150P1",27,0)
 ;
"RTN","EAS150P1",28,0)
 K ^TMP("EASUES",$J)
"RTN","EAS150P1",29,0)
 K ^TMP("SCK",$J)
"RTN","EAS150P1",30,0)
 F EAX=0,1,2 S EACNT(EAX)=0
"RTN","EAS150P1",31,0)
 S EALIEN=0
"RTN","EAS150P1",32,0)
 F  S EALIEN=$O(^EAS(713.2,EALIEN)) Q:'EALIEN  D
"RTN","EAS150P1",33,0)
 . Q:$D(^EAS(713.2,"AC",1,EALIEN))  ; Quit if MT has been returned
"RTN","EAS150P1",34,0)
 . S EAPTR=$$GET1^DIQ(713.2,EALIEN,2,"I") ; Get pointer to file #713.1
"RTN","EAS150P1",35,0)
 . Q:$D(^EAS(713.1,"AP",1,EAPTR))  ; Quit if Prohibit Flag is set for patch
"RTN","EAS150P1",36,0)
 . ; If EACY is not "ALL" then check Calendar year for 60 day letter.  
"RTN","EAS150P1",37,0)
 . ; Quit if letter date is not in the selected CY
"RTN","EAS150P1",38,0)
 . S EAS60=$$GET1^DIQ(713.2,EALIEN,8,"I")
"RTN","EAS150P1",39,0)
 . S Y=$E(EAS60,1,3) D DD^%DT S EAS60=Y
"RTN","EAS150P1",40,0)
 . I +EACY>0 Q:EAS60'=EACY 
"RTN","EAS150P1",41,0)
 . Q:$$DECEASED^EASMTUTL(EALIEN)  ; Quit if patient is deceased
"RTN","EAS150P1",42,0)
 . S EADFN1=$$GET1^DIQ(713.2,EALIEN,2,"I")
"RTN","EAS150P1",43,0)
 . S EADFN=$$GET1^DIQ(713.1,EADFN1,.01,"I")
"RTN","EAS150P1",44,0)
 . S EANAME=$$GET1^DIQ(2,EADFN,.01)
"RTN","EAS150P1",45,0)
 . S ^TMP("EASUES",$J,$S(EANAME]"":EANAME,1:"UNKNOWN"),EADFN)=EALIEN_U_EAS60
"RTN","EAS150P1",46,0)
 D REPORT
"RTN","EAS150P1",47,0)
 Q
"RTN","EAS150P1",48,0)
 ;
"RTN","EAS150P1",49,0)
REPORT ;
"RTN","EAS150P1",50,0)
 N EANAME,EADFN,PAGE,EASABRT
"RTN","EAS150P1",51,0)
 ;
"RTN","EAS150P1",52,0)
 S (EASABRT,PAGE)=0
"RTN","EAS150P1",53,0)
 D HDR
"RTN","EAS150P1",54,0)
 ;
"RTN","EAS150P1",55,0)
 S EANAME=""
"RTN","EAS150P1",56,0)
 F  S EANAME=$O(^TMP("EASUES",$J,EANAME)) Q:EANAME']""  D  Q:$G(EASABRT)
"RTN","EAS150P1",57,0)
 . S EADFN=0
"RTN","EAS150P1",58,0)
 . F  S EADFN=$O(^TMP("EASUES",$J,EANAME,EADFN)) Q:'EADFN  D
"RTN","EAS150P1",59,0)
 . . D LINE(EANAME,EADFN,$P($G(^TMP("EASUES",$J,EANAME,EADFN)),U,2))
"RTN","EAS150P1",60,0)
 . . I ($Y+6)>IOSL D HDR  Q:$G(EASABRT)
"RTN","EAS150P1",61,0)
 ;
"RTN","EAS150P1",62,0)
 I '$G(EASABRT) D
"RTN","EAS150P1",63,0)
 . N XX F XX=$Y:1:IOSL-6 W !
"RTN","EAS150P1",64,0)
 . D FTR
"RTN","EAS150P1",65,0)
 Q:$G(EASABRT)
"RTN","EAS150P1",66,0)
 I $E(IOST,1,2)="C-" D  Q:$D(DIRUT)!('Y)
"RTN","EAS150P1",67,0)
 . S DIR(0)="E" D ^DIR K DIR
"RTN","EAS150P1",68,0)
 D SUMMARY
"RTN","EAS150P1",69,0)
 ;
"RTN","EAS150P1",70,0)
 Q
"RTN","EAS150P1",71,0)
 ;
"RTN","EAS150P1",72,0)
LINE(EANAME,DFN,EAS60) ;
"RTN","EAS150P1",73,0)
 N EAUES,VA
"RTN","EAS150P1",74,0)
 ;
"RTN","EAS150P1",75,0)
 S EAUES=$$UESTAT^EASUER(DFN)
"RTN","EAS150P1",76,0)
 S EACNT(EAUES)=EACNT(EAUES)+1
"RTN","EAS150P1",77,0)
 D PID^VADPT6
"RTN","EAS150P1",78,0)
 W !,$E(EANAME,1,25),?28,VA("BID")
"RTN","EAS150P1",79,0)
 W ?35,$$GET1^DIQ(2,EADFN,.3617)
"RTN","EAS150P1",80,0)
 W ?42,$S(EAUES=1:"UE",EAUES=0:"Not UE",EAUES=2:"Diff. Site",1:"")
"RTN","EAS150P1",81,0)
 W ?54,$E($$GET1^DIQ(2,EADFN,.3618),1,18),?74,EAS60
"RTN","EAS150P1",82,0)
 Q
"RTN","EAS150P1",83,0)
 ;
"RTN","EAS150P1",84,0)
SUMMARY ;
"RTN","EAS150P1",85,0)
 N DDASH
"RTN","EAS150P1",86,0)
 ;
"RTN","EAS150P1",87,0)
 W @IOF
"RTN","EAS150P1",88,0)
 W !,"User Enrollee Status Summary for Pending Means Test Letters"
"RTN","EAS150P1",89,0)
 W !,"Print Date: ",$$FMTE^XLFDT(DT)
"RTN","EAS150P1",90,0)
 S $P(DDASH,"=",IOM)="" W !,DDASH,!
"RTN","EAS150P1",91,0)
 W !?4,"Patients with User Enrollee Status at this site:              ",$FN(EACNT(1),",")
"RTN","EAS150P1",92,0)
 W !!?4,"Patients which DO NOT have User Enrollee Status at this site: ",$FN(EACNT(2),",")
"RTN","EAS150P1",93,0)
 W !!?4,"Patients which do not have User Enrollee Status:              ",$FN(EACNT(0),",")
"RTN","EAS150P1",94,0)
 W !!?4,"Total Patients Reviewed:                                      ",$FN(EACNT(0)+EACNT(1)+EACNT(2),",")
"RTN","EAS150P1",95,0)
 Q
"RTN","EAS150P1",96,0)
 ;
"RTN","EAS150P1",97,0)
HDR ;
"RTN","EAS150P1",98,0)
 N DDASH,EASITE,EAPRNT
"RTN","EAS150P1",99,0)
 ;
"RTN","EAS150P1",100,0)
 I PAGE>0,$E(IOST,1,2)="C-" D  Q:$G(EASABRT)
"RTN","EAS150P1",101,0)
 . S DIR(0)="E"
"RTN","EAS150P1",102,0)
 . D ^DIR K DIR
"RTN","EAS150P1",103,0)
 . I 'Y S EASABRT=1
"RTN","EAS150P1",104,0)
 ;
"RTN","EAS150P1",105,0)
 S EASITE=$$SITE^VASITE,EAPRNT=$$PSITE^EASUER($P(EASITE,U,3))
"RTN","EAS150P1",106,0)
 W @IOF
"RTN","EAS150P1",107,0)
 S PAGE=PAGE+1
"RTN","EAS150P1",108,0)
 W !,"User Enrollee Status for Pending Means Test Letters"
"RTN","EAS150P1",109,0)
 W !,"Calendar Year for MT Letters to Print: ",EACY
"RTN","EAS150P1",110,0)
 W !,"Print Date: ",$$FMTE^XLFDT(DT)
"RTN","EAS150P1",111,0)
 W !,"Page: ",PAGE
"RTN","EAS150P1",112,0)
 W !!,"Current Site: ",$P(EASITE,U,2),"  Current Station#: ",$P(EASITE,U,3)
"RTN","EAS150P1",113,0)
 W !,"Administrative Parent for ",$P(EASITE,U,2)," is ",$$GET1^DIQ(4,EAPRNT,.01)
"RTN","EAS150P1",114,0)
 W !!,"Name",?28,"LAST4",?35,"UE-FY",?42,"UE Status",?54,"UE Site",?74,"LT-CY"
"RTN","EAS150P1",115,0)
 ;
"RTN","EAS150P1",116,0)
 S $P(DDASH,"=",IOM)="" W !,DDASH
"RTN","EAS150P1",117,0)
 W !
"RTN","EAS150P1",118,0)
 Q
"RTN","EAS150P1",119,0)
 ;
"RTN","EAS150P1",120,0)
FTR ;
"RTN","EAS150P1",121,0)
 I $E(IOST,1,2)'="C-" D
"RTN","EAS150P1",122,0)
 . W !?5,"UE         -User Enrollee Status at Site "
"RTN","EAS150P1",123,0)
 . W !?5,"Not UE     -User is not a User Enrollee"
"RTN","EAS150P1",124,0)
 . W !?5,"Diff. Site -User Enrollee Status, but at Another Site."
"RTN","EAS150P1",125,0)
 Q
"RTN","EAS150PT")
1^6
"RTN","EAS155P1")
0^2^B37338094
"RTN","EAS155P1",1,0)
EAS155P1 ;;ALB/SCK - MT LETTERS BAD POINTERS CLEAN UP ;07/22/2004
"RTN","EAS155P1",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**55**;MAR 15,2001
"RTN","EAS155P1",3,0)
 ;
"RTN","EAS155P1",4,0)
 ; This routine was initally run as the post-install for patch EAS*1*55
"RTN","EAS155P1",5,0)
 ; Running this routine from programmer mode will initiate another
"RTN","EAS155P1",6,0)
 ; reporting cycle.  You should not run this routine unless advised
"RTN","EAS155P1",7,0)
 ; by customer support.
"RTN","EAS155P1",8,0)
 Q
"RTN","EAS155P1",9,0)
 ;
"RTN","EAS155P1",10,0)
EN ; Entry point from programmer mode
"RTN","EAS155P1",11,0)
 N MSG,XCNT,DIR,X,Y,DIRUT
"RTN","EAS155P1",12,0)
 ;
"RTN","EAS155P1",13,0)
 F XCNT=1:1 S LINE=$P($T(TEXT+XCNT),";;",2) Q:LINE="$$END"  S MSG(XCNT)=LINE
"RTN","EAS155P1",14,0)
 W @IOF
"RTN","EAS155P1",15,0)
 S XCNT=0 F  S XCNT=$O(MSG(XCNT)) Q:'XCNT  W !?3,MSG(XCNT)
"RTN","EAS155P1",16,0)
 W !
"RTN","EAS155P1",17,0)
 I '$$CHKPREV Q
"RTN","EAS155P1",18,0)
 ;
"RTN","EAS155P1",19,0)
 S DIR(0)="Y",DIR("B")="YES",DIR("A")="Continue with scan"
"RTN","EAS155P1",20,0)
 S DIR("?")="Press ENTER to continue, enter ""NO"" to exit."
"RTN","EAS155P1",21,0)
 D ^DIR K DIR
"RTN","EAS155P1",22,0)
 I Y D QUE  Q
"RTN","EAS155P1",23,0)
 W !?3,"Exiting scan..."
"RTN","EAS155P1",24,0)
 Q
"RTN","EAS155P1",25,0)
 ;
"RTN","EAS155P1",26,0)
QUE ;
"RTN","EAS155P1",27,0)
 K ZTRTN,ZTDESC,ZTSAVE
"RTN","EAS155P1",28,0)
 S ZTRTN="BLD^EAS155P1"
"RTN","EAS155P1",29,0)
 S ZTDESC="EAS MT LTR BAD PTR SCAN"
"RTN","EAS155P1",30,0)
 S ZTSAVE("DUZ")=""
"RTN","EAS155P1",31,0)
 S ZTIO=""
"RTN","EAS155P1",32,0)
 D ^%ZTLOAD
"RTN","EAS155P1",33,0)
 I $D(ZTSK)[0 D
"RTN","EAS155P1",34,0)
 . W:'$G(EASQ) !!?3,"Scan canceled"
"RTN","EAS155P1",35,0)
 E  D
"RTN","EAS155P1",36,0)
 . I $G(EASQ) D BMES^XPDUTL("Scan Queued: "_ZTSK)
"RTN","EAS155P1",37,0)
 . E  W !!?3,"Scan Queued: "_ZTSK
"RTN","EAS155P1",38,0)
 Q
"RTN","EAS155P1",39,0)
 ;
"RTN","EAS155P1",40,0)
BLD ; Entry point scan and cleanup.  Do not call directly, call from the EN entry point.
"RTN","EAS155P1",41,0)
 D SCAN,CLNUP,ALERT
"RTN","EAS155P1",42,0)
 S ^XTMP("EASBADPTRS",0,"END")=$H
"RTN","EAS155P1",43,0)
 Q
"RTN","EAS155P1",44,0)
 ;
"RTN","EAS155P1",45,0)
POST ; Post Install entry point.  This entry point is intended to be called from the KIDS build.
"RTN","EAS155P1",46,0)
 N MSG,XCNT,EASQ
"RTN","EAS155P1",47,0)
 ;
"RTN","EAS155P1",48,0)
 F XCNT=1:1 S LINE=$P($T(TEXT+XCNT),";;",2) Q:LINE="$$END"  D
"RTN","EAS155P1",49,0)
 . S MSG(XCNT)=LINE
"RTN","EAS155P1",50,0)
 D MES^XPDUTL(.MSG)
"RTN","EAS155P1",51,0)
 S EASQ=1 D QUE
"RTN","EAS155P1",52,0)
 Q
"RTN","EAS155P1",53,0)
 ;
"RTN","EAS155P1",54,0)
SCAN ; Begin scanning for any bad pointers in the MT Letter Files
"RTN","EAS155P1",55,0)
 N EAIEN
"RTN","EAS155P1",56,0)
 ;
"RTN","EAS155P1",57,0)
 K ^XTMP("EASBADPTRS")
"RTN","EAS155P1",58,0)
 S ^XTMP("EASBADPTRS",0)=$$FMADD^XLFDT($$DT^XLFDT,30)_U_$$DT^XLFDT_U_"EAS MT LETTERS BAD POINTERS SCAN"
"RTN","EAS155P1",59,0)
 S ^XTMP("EASBADPTRS",0,"START")=$H,^XTMP("EASBADPTRS",0,"DUZ")=DUZ
"RTN","EAS155P1",60,0)
 S EAIEN=0
"RTN","EAS155P1",61,0)
 F  S EAIEN=$O(^EAS(713.2,"AC",0,EAIEN)) Q:'EAIEN  D
"RTN","EAS155P1",62,0)
 . I $$GET1^DIQ(713.2,EAIEN,2)']"" S ^XTMP("EASBADPTRS",EAIEN)=""
"RTN","EAS155P1",63,0)
 S ^XTMP("EASBADPTRS",0,"SCAN COMPLETE")=$H
"RTN","EAS155P1",64,0)
 Q
"RTN","EAS155P1",65,0)
 ;
"RTN","EAS155P1",66,0)
CLNUP ; Disable letters in MT Letter Status file with suspicious pointers
"RTN","EAS155P1",67,0)
 ; Do not delete, but flag as "bad"
"RTN","EAS155P1",68,0)
 N EAIEN,EAFDA,ERR,DIE,DA,DR
"RTN","EAS155P1",69,0)
 ;
"RTN","EAS155P1",70,0)
 S EAIEN=0
"RTN","EAS155P1",71,0)
 F  S EAIEN=$O(^XTMP("EASBADPTRS",EAIEN)) Q:'EAIEN  D
"RTN","EAS155P1",72,0)
 . S DIE="^EAS(713.2,",DA=EAIEN
"RTN","EAS155P1",73,0)
 . S DR="4///YES;5///TODAY;6////.5;7///LETTER DISABLED, BAD POINTERS?;9///NO;12///NO;18///NO"
"RTN","EAS155P1",74,0)
 . D ^DIE K DIE,DR,DA
"RTN","EAS155P1",75,0)
 ;
"RTN","EAS155P1",76,0)
 S ^XTMP("EASBADPTRS",0,"CLEANUP COMPLETE")=$H
"RTN","EAS155P1",77,0)
 Q
"RTN","EAS155P1",78,0)
 ;
"RTN","EAS155P1",79,0)
ALERT ; Send an alert to user that the scan has completed.
"RTN","EAS155P1",80,0)
 K XQA,XQAMSG,XQAOPT,XQAROU,XQAID,XQDATA,XQAFLAG
"RTN","EAS155P1",81,0)
 ;
"RTN","EAS155P1",82,0)
 S XQA(DUZ)="",XQAID="EAS",XQAROU="REPORT^EAS155P1"
"RTN","EAS155P1",83,0)
 S XQAMSG="EAS MT LTRs Bad Pointers Scan Complete, Print Report"
"RTN","EAS155P1",84,0)
 D SETUP^XQALERT
"RTN","EAS155P1",85,0)
 Q
"RTN","EAS155P1",86,0)
 ;
"RTN","EAS155P1",87,0)
REPORT ; Print Bad Pointers Report setup
"RTN","EAS155P1",88,0)
 K ZTSAVE S ZTSAVE("DUZ")=""
"RTN","EAS155P1",89,0)
 D EN^XUTMDEVQ("P^EAS155P1","Print EAS Bad Pointers Report",.ZTSAVE)
"RTN","EAS155P1",90,0)
 Q
"RTN","EAS155P1",91,0)
 ;
"RTN","EAS155P1",92,0)
P ; Print report
"RTN","EAS155P1",93,0)
 N LINE,EAIEN,PAGE,EAX,DFN
"RTN","EAS155P1",94,0)
 ;
"RTN","EAS155P1",95,0)
 S (PAGE,EAIEN)=0
"RTN","EAS155P1",96,0)
 D HDR
"RTN","EAS155P1",97,0)
 F  S EAIEN=$O(^XTMP("EASBADPTRS",EAIEN)) Q:'EAIEN  D  Q:$G(EASABRT)
"RTN","EAS155P1",98,0)
 . S LINE=""
"RTN","EAS155P1",99,0)
 . S LINE=$$SETSTR^VALM1(EAIEN,"",20,15)
"RTN","EAS155P1",100,0)
 . S EAX=$$GET1^DIQ(713.2,EAIEN,2,"I")
"RTN","EAS155P1",101,0)
 . S LINE=$$SETSTR^VALM1(EAX,LINE,40,15)
"RTN","EAS155P1",102,0)
 . S DFN=$$GET1^DIQ(713.1,EAX,.01,"I")
"RTN","EAS155P1",103,0)
 . S LINE=$$SETSTR^VALM1(DFN,LINE,60,15)
"RTN","EAS155P1",104,0)
 . W !,LINE
"RTN","EAS155P1",105,0)
 . I $Y+5>IOSL D  Q:$G(EASABRT)
"RTN","EAS155P1",106,0)
 . . I $E(IOST,1,2)="C-" D  Q:$G(EASABRT)
"RTN","EAS155P1",107,0)
 . . . S DIR(0)="E" D ^DIR K DIR
"RTN","EAS155P1",108,0)
 . . . I 'Y S EASABRT=1 Q
"RTN","EAS155P1",109,0)
 . . D HDR
"RTN","EAS155P1",110,0)
 Q
"RTN","EAS155P1",111,0)
 ;
"RTN","EAS155P1",112,0)
HDR ; PRINT REPORT HEADER
"RTN","EAS155P1",113,0)
 N LINE,DDASH,TEXT,TEXT1
"RTN","EAS155P1",114,0)
 ;
"RTN","EAS155P1",115,0)
 S PAGE=PAGE+1
"RTN","EAS155P1",116,0)
 W:$E(IOST,1,2)="C-" @IOF
"RTN","EAS155P1",117,0)
 W "Results of Possible Bad Pointers Report for EAS MT Letters"
"RTN","EAS155P1",118,0)
 S TEXT="Date Scan Run: "_$$HTE^XLFDT(^XTMP("EASBADPTRS",0,"END"))
"RTN","EAS155P1",119,0)
 S TEXT1="Run by: "_$$GET1^DIQ(200,^XTMP("EASBADPTRS",0,"DUZ"),.01)
"RTN","EAS155P1",120,0)
 S SPACE=(IOM-($L(TEXT)+$L(TEXT1)))
"RTN","EAS155P1",121,0)
 S $P(LINE," ",SPACE-2)=""
"RTN","EAS155P1",122,0)
 W !,TEXT,LINE,TEXT1
"RTN","EAS155P1",123,0)
 ;
"RTN","EAS155P1",124,0)
 S TEXT="Print Date: "_$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","EAS155P1",125,0)
 S TEXT1="Page: "_PAGE
"RTN","EAS155P1",126,0)
 S SPACE=(IOM-($L(TEXT)+$L(TEXT1)))
"RTN","EAS155P1",127,0)
 S $P(LINE," ",SPACE-2)=""
"RTN","EAS155P1",128,0)
 W !,TEXT,LINE,TEXT1,!
"RTN","EAS155P1",129,0)
 ;
"RTN","EAS155P1",130,0)
 S $P(DDASH,"=",IOM-10)=""
"RTN","EAS155P1",131,0)
 S LINE=$$SETSTR^VALM1("File IEN's","",5,12)
"RTN","EAS155P1",132,0)
 S LINE=$$SETSTR^VALM1("713.2",LINE,20,5)
"RTN","EAS155P1",133,0)
 S LINE=$$SETSTR^VALM1("713.1",LINE,40,5)
"RTN","EAS155P1",134,0)
 S LINE=$$SETSTR^VALM1("DFN",LINE,60,5)
"RTN","EAS155P1",135,0)
 W !,LINE
"RTN","EAS155P1",136,0)
 W !?5,DDASH
"RTN","EAS155P1",137,0)
 Q
"RTN","EAS155P1",138,0)
 ;
"RTN","EAS155P1",139,0)
CHKPREV() ; Check for a previous scan in XTMP
"RTN","EAS155P1",140,0)
 N RSLT,EASDUZ
"RTN","EAS155P1",141,0)
 ;
"RTN","EAS155P1",142,0)
 S RSLT=1
"RTN","EAS155P1",143,0)
 I $D(^XTMP("EASBADPTRS")) D
"RTN","EAS155P1",144,0)
 . I '$D(^XTMP("EASBADPTRS",0,"END")) D
"RTN","EAS155P1",145,0)
 . . W !?3,$CHAR(7),"The EAS MT LTRs Bad Pointer scan is currently running."
"RTN","EAS155P1",146,0)
 . . S EASDUZ=$G(^XTMP("EASBADPTRS",0,"DUZ"))
"RTN","EAS155P1",147,0)
 . . I EASDUZ>0 W !?3,"started by ",$$GET1^DIQ(200,EASDUZ,.01)
"RTN","EAS155P1",148,0)
 . . I $D(^XTMP("EASBADPTRS",0,"START")) W " on ",$$HTE^XLFDT(^XTMP("EASBADPTRS",0,"START"))
"RTN","EAS155P1",149,0)
 . . S RSLT=0
"RTN","EAS155P1",150,0)
 . E  D
"RTN","EAS155P1",151,0)
 . . W !?3,"Data from a previous scan exists.  "
"RTN","EAS155P1",152,0)
 . . I $D(^XTMP("EASBADPTRS",0,"END")) W "Last Run: ",$$HTE^XLFDT(^XTMP("EASBADPTRS",0,"END"))
"RTN","EAS155P1",153,0)
 . . W !?3,"Answering ""YES"" will cause this data to be erased and a new"
"RTN","EAS155P1",154,0)
 . . W !?3,"scan started!",!
"RTN","EAS155P1",155,0)
 Q $G(RSLT)
"RTN","EAS155P1",156,0)
 ;
"RTN","EAS155P1",157,0)
TEXT ;
"RTN","EAS155P1",158,0)
 ;;Running this routine will scan the EAS MT PATIENT STATUS File (#713.1)
"RTN","EAS155P1",159,0)
 ;;and the EAS MT LETTER STATUS File (#713.2) for any bad pointers
"RTN","EAS155P1",160,0)
 ;;linking to the PATIENT File (#2).  This routine WILL NOT clean up
"RTN","EAS155P1",161,0)
 ;;these pointers, but will flag the appropriate MT Letter entry as
"RTN","EAS155P1",162,0)
 ;;'MT RETURNED' and enter a comment of 'Bad Pointer'.  Your local 
"RTN","EAS155P1",163,0)
 ;;IRM may take additional cleanup actions.
"RTN","EAS155P1",164,0)
 ;;
"RTN","EAS155P1",165,0)
 ;;Data from this scan will be retained in the ^XTMP("EASBADPTRS") 
"RTN","EAS155P1",166,0)
 ;;global for 30 days.  You may run REPORT^EAS155P1 at a programmer 
"RTN","EAS155P1",167,0)
 ;;prompt to re-print a formatted report.  You will be alerted when the 
"RTN","EAS155P1",168,0)
 ;;scan is complete. 
"RTN","EAS155P1",169,0)
 ;;$$END
"RTN","EAS155P1",170,0)
 Q
"RTN","EAS155PT")
0^5^B44770246
"RTN","EAS155PT",1,0)
EAS155PT ;ALB/SCK - PATCH 55 USER ENROLLEE MT LETTER CLEANUP ; 9-AUG-04
"RTN","EAS155PT",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**55**;Mar 15, 2004
"RTN","EAS155PT",3,0)
 ;
"RTN","EAS155PT",4,0)
 Q
"RTN","EAS155PT",5,0)
 ;
"RTN","EAS155PT",6,0)
CHECK ;
"RTN","EAS155PT",7,0)
 N CURSTN,CURSITE,PRNT,PTYP
"RTN","EAS155PT",8,0)
 N MSG,XMDUZ,XMSUB,XMTEXT,XMY,XX
"RTN","EAS155PT",9,0)
 ;
"RTN","EAS155PT",10,0)
 S XMSUB="EAS*1*55 PARENT CHECK"
"RTN","EAS155PT",11,0)
 S XMDUZ="EAS*1*55"
"RTN","EAS155PT",12,0)
 S XMY(.5)="",XMY(DUZ)=""
"RTN","EAS155PT",13,0)
 S XMTEXT="MSG("
"RTN","EAS155PT",14,0)
 ;
"RTN","EAS155PT",15,0)
 S CURSITE=$P($$SITE^VASITE,U,3)
"RTN","EAS155PT",16,0)
 S CURSTN=$$STA^XUAF4(CURSITE)
"RTN","EAS155PT",17,0)
 S PRNT=$$PRNT^XUAF4(CURSITE)
"RTN","EAS155PT",18,0)
 S PTYP=$$GET1^DIQ(4,+PRNT,13)
"RTN","EAS155PT",19,0)
 ;
"RTN","EAS155PT",20,0)
 S MSG(1)="Current Site: "_CURSITE
"RTN","EAS155PT",21,0)
 S MSG(2)="Current Station: "_$$GET1^DIQ(4,CURSTN,.01)_" ("_CURSTN_")"
"RTN","EAS155PT",22,0)
 S MSG(3)="Parent Facility: "_$P(PRNT,U,3)
"RTN","EAS155PT",23,0)
 S MSG(4)="Parent Type: "_PTYP
"RTN","EAS155PT",24,0)
 S MSG(5)=""
"RTN","EAS155PT",25,0)
 I PTYP="HCS" D
"RTN","EAS155PT",26,0)
 . S MSG(6)="Because your parent facility type is ""HCS"", it's recommended that you run"
"RTN","EAS155PT",27,0)
 . S MSG(7)="the MT Letter cleanup at this time.  Please refer to the patch for directions"
"RTN","EAS155PT",28,0)
 E  D
"RTN","EAS155PT",29,0)
 . S MSG(6)="Your parent facility type does not appear to be of type ""HCS"". "
"RTN","EAS155PT",30,0)
 . S MSG(7)="It is not recommended that you run the MT letter cleanup at this time"
"RTN","EAS155PT",31,0)
 . S MSG(8)="If you are experiencing problems with the MT Letters, please contact EVS."
"RTN","EAS155PT",32,0)
 D MES^XPDUTL(.MSG)
"RTN","EAS155PT",33,0)
 D ^XMD
"RTN","EAS155PT",34,0)
 ;
"RTN","EAS155PT",35,0)
 Q
"RTN","EAS155PT",36,0)
 ;
"RTN","EAS155PT",37,0)
EN ; Que off the background task
"RTN","EAS155PT",38,0)
 N ZTRTN,ZTDESC,ZTSK,ZTIO,ZTDH,MSG,ZTSAVE
"RTN","EAS155PT",39,0)
 ;
"RTN","EAS155PT",40,0)
 W !,"Preparing to run the EAS*1*55 MT Letters Cleanup"
"RTN","EAS155PT",41,0)
 W !,"After the cleanup, you will be sent a MailMan summary of the cleanup"
"RTN","EAS155PT",42,0)
 W !,"statistics.  You will also be asked to select a printer to send the"
"RTN","EAS155PT",43,0)
 W !,"detailed results to.  This report could be quite lengthy.  Please "
"RTN","EAS155PT",44,0)
 W !,"DO NOT run the report to your screen!",!
"RTN","EAS155PT",45,0)
 D ^%ZIS
"RTN","EAS155PT",46,0)
 S ZTRTN="LETTERS^EAS155PT"
"RTN","EAS155PT",47,0)
 S ZTDH=$$NOW^XLFDT
"RTN","EAS155PT",48,0)
 S ZTSAVE("DUZ")=""
"RTN","EAS155PT",49,0)
 S ZTDESC="EAS155 MT LETTER CLEANUP FOR UE STATUS"
"RTN","EAS155PT",50,0)
 D ^%ZTLOAD
"RTN","EAS155PT",51,0)
 I $D(ZTSK) W !!?5,"Task: "_ZTSK_" Queued."
"RTN","EAS155PT",52,0)
 D HOME^%ZIS
"RTN","EAS155PT",53,0)
 Q
"RTN","EAS155PT",54,0)
 ;
"RTN","EAS155PT",55,0)
LETTERS ; Reflag those MT letters which need to be updated for UE Status update
"RTN","EAS155PT",56,0)
 N EASIEN,EASPTR,EASDFN,EASLTR,EASCNT,XX
"RTN","EAS155PT",57,0)
 ;
"RTN","EAS155PT",58,0)
 K ^TMP("EAS155P",$J)
"RTN","EAS155PT",59,0)
 S ^TMP("EAS155P",$J,"START")=$H,^TMP("EAS155P",$J,"COUNT")=0,^TMP("EAS155P",$J,"NOCHANGE")=0
"RTN","EAS155PT",60,0)
 ;
"RTN","EAS155PT",61,0)
 F XX="60D","30D","0D","OFF" S EASCNT(XX)=0
"RTN","EAS155PT",62,0)
 S EASIEN=0
"RTN","EAS155PT",63,0)
 F  S EASIEN=$O(^EAS(713.2,"AC",0,EASIEN)) Q:'EASIEN  D
"RTN","EAS155PT",64,0)
 . S EASPTR=$$GET1^DIQ(713.2,EASIEN,2,"I")
"RTN","EAS155PT",65,0)
 . Q:$D(^EAS(713.1,"AP",1,EASPTR))  ; Quit if Letter Prohibit Flag set
"RTN","EAS155PT",66,0)
 . Q:$$DECEASED^EASMTUTL(EASIEN)  ; Quit if patient deceased
"RTN","EAS155PT",67,0)
 . ; ** Safety check for bad patient pointers in 713.1
"RTN","EAS155PT",68,0)
 . Q:$$GET1^DIQ(713.2,EASIEN,2)']""
"RTN","EAS155PT",69,0)
 . D TESTLTR(EASIEN)
"RTN","EAS155PT",70,0)
 ;
"RTN","EAS155PT",71,0)
 S ^TMP("EAS155P",$J,"END")=$H
"RTN","EAS155PT",72,0)
 D MAIL
"RTN","EAS155PT",73,0)
 D REPORT
"RTN","EAS155PT",74,0)
 Q
"RTN","EAS155PT",75,0)
 ;
"RTN","EAS155PT",76,0)
TESTLTR(EASIEN) ; Test letter conditions
"RTN","EAS155PT",77,0)
 N NODE6,NODE4,NODEZ,IENS,FDA,FIN
"RTN","EAS155PT",78,0)
 ;
"RTN","EAS155PT",79,0)
 S ^TMP("EAS155P",$J,"COUNT")=^TMP("EAS155P",$J,"COUNT")+1
"RTN","EAS155PT",80,0)
 ; Piece 1: Threshold date, Piece 2: Flag-to-print, Piece 3: Letter Printed?, Piece 4: Date printed 
"RTN","EAS155PT",81,0)
 S NODE6=$G(^EAS(713.2,EASIEN,6))
"RTN","EAS155PT",82,0)
 S NODE4=$G(^EAS(713.2,EASIEN,4))
"RTN","EAS155PT",83,0)
 S NODEZ=$G(^EAS(713.2,EASIEN,"Z"))
"RTN","EAS155PT",84,0)
 ;
"RTN","EAS155PT",85,0)
 ; Check 1, check if letters have been completely turned off, No flags to print and no letters printed.  Turn back on most appropriate letter.
"RTN","EAS155PT",86,0)
 I '$P(NODE6,U,3),'$P(NODE4,U,3),'$P(NODEZ,U,3) D  Q:$G(FIN)
"RTN","EAS155PT",87,0)
 . I '$P(NODE6,U,2),'$P(NODE4,U,2),'$P(NODEZ,U,2) D
"RTN","EAS155PT",88,0)
 . . I $P(NODEZ,U)<DT D  Q
"RTN","EAS155PT",89,0)
 . . . S EASCNT("0D")=EASCNT("0D")+1
"RTN","EAS155PT",90,0)
 . . . S ^TMP("EAS155P",$J,"0D",EASIEN)=""
"RTN","EAS155PT",91,0)
 . . . S FDA(1,713.2,EASIEN_",",18)="YES"
"RTN","EAS155PT",92,0)
 . . . S FDA(1,713.2,EASIEN_",",9)="NO"
"RTN","EAS155PT",93,0)
 . . . S FDA(1,713.2,EASIEN_",",12)="NO",FIN=1
"RTN","EAS155PT",94,0)
 . . . D FILE^DIE("E","FDA(1)")
"RTN","EAS155PT",95,0)
 . . I $P(NODE4,U)<DT D  Q
"RTN","EAS155PT",96,0)
 . . . S EASCNT("30D")=EASCNT("30D")+1
"RTN","EAS155PT",97,0)
 . . . S ^TMP("EAS155P",$J,"30D",EASIEN)=""
"RTN","EAS155PT",98,0)
 . . . S FDA(1,713.2,EASIEN_",",12)="YES"
"RTN","EAS155PT",99,0)
 . . . S FDA(1,713.2,EASIEN_",",9)="NO"
"RTN","EAS155PT",100,0)
 . . . S FDA(1,713.2,EASIEN_",",18)="NO",FIN=1
"RTN","EAS155PT",101,0)
 . . . D FILE^DIE("E","FDA(1)")
"RTN","EAS155PT",102,0)
 . . S EASCNT("60D")=EASCNT("6OD")+1
"RTN","EAS155PT",103,0)
 . . S ^TMP("EAS155P",$J,"60D",EASIEN)=""
"RTN","EAS155PT",104,0)
 . . S FDA(1,713.2,EASIEN_",",9)="YES"
"RTN","EAS155PT",105,0)
 . . S FDA(1,713.2,EASIEN_",",12)="NO"
"RTN","EAS155PT",106,0)
 . . S FDA(1,713.2,EASIEN_",",18)="NO",FIN=1
"RTN","EAS155PT",107,0)
 . . D FILE^DIE("E","FDA(1)")
"RTN","EAS155PT",108,0)
 ;
"RTN","EAS155PT",109,0)
 ; Check 2, check if 60d ltrs have not been printed, but 30d ltrs are flagged to print.
"RTN","EAS155PT",110,0)
 I '$P(NODE6,U,3)&($P(NODE4,U,2))&($P(NODE4,U,1)>DT) D  Q:$G(FIN)
"RTN","EAS155PT",111,0)
 . S EASCNT("60D")=EASCNT("60D")+1
"RTN","EAS155PT",112,0)
 . S ^TMP("EAS155P",$J,"60D",EASIEN)=""
"RTN","EAS155PT",113,0)
 . S FDA(1,713.2,EASIEN_",",9)="YES"
"RTN","EAS155PT",114,0)
 . S FDA(1,713.2,EASIEN_",",12)="NO"
"RTN","EAS155PT",115,0)
 . D FILE^DIE("E","FDA(1)")
"RTN","EAS155PT",116,0)
 . S FIN=1
"RTN","EAS155PT",117,0)
 ;
"RTN","EAS155PT",118,0)
 ; Check 3, if the 60d ltr has been printed AND the 30d ltr has not AND the 
"RTN","EAS155PT",119,0)
 ; 0d ltr is flagged to print.
"RTN","EAS155PT",120,0)
 I $P(NODE6,U,3)&('$P(NODE4,U,3))&($P(NODEZ,U,2))&($P(NODEZ,U,1)>DT) D  Q:$G(FIN)
"RTN","EAS155PT",121,0)
 . S EASCNT("30D")=EASCNT("30D")+1
"RTN","EAS155PT",122,0)
 . S ^TMP("EAS155P",$J,"30D",EASIEN)=""
"RTN","EAS155PT",123,0)
 . S FDA(1,713.2,EASIEN_",",12)="YES"
"RTN","EAS155PT",124,0)
 . S FDA(1,713.2,EASIEN_",",18)="NO"
"RTN","EAS155PT",125,0)
 . D FILE^DIE("E","FDA(1)")
"RTN","EAS155PT",126,0)
 . S FIN=1
"RTN","EAS155PT",127,0)
 ;
"RTN","EAS155PT",128,0)
 ; Check 4, if the 30d ltr has been printed and the 0d has not AND is not flagged.
"RTN","EAS155PT",129,0)
 I $P(NODE4,U,3)&('$P(NODEZ,U,3))&('$P(NODEZ,U,2)) D  Q
"RTN","EAS155PT",130,0)
 . S EASCNT("0D")=EASCNT("0D")+1
"RTN","EAS155PT",131,0)
 . S ^TMP("EAS155P",$J,"0D",EASIEN)=""
"RTN","EAS155PT",132,0)
 . S FDA(1,713.2,EASIEN_",",18)="YES"
"RTN","EAS155PT",133,0)
 . D FILE^DIE("E","FDA(1)")
"RTN","EAS155PT",134,0)
 ;
"RTN","EAS155PT",135,0)
 S ^TMP("EAS155P",$J,"NOCHANGE")=^TMP("EAS155P",$J,"NOCHANGE")+1
"RTN","EAS155PT",136,0)
 Q
"RTN","EAS155PT",137,0)
 ;
"RTN","EAS155PT",138,0)
UPD(FDA) ;  Update file entry
"RTN","EAS155PT",139,0)
 N ERR
"RTN","EAS155PT",140,0)
 ;
"RTN","EAS155PT",141,0)
 D FILE^DIE("E","FDA(1)","ERR")
"RTN","EAS155PT",142,0)
 Q
"RTN","EAS155PT",143,0)
 ;
"RTN","EAS155PT",144,0)
MAIL ;
"RTN","EAS155PT",145,0)
 N MSG,XMDUZ,XMSUB,XMTEXT,XMY,XX
"RTN","EAS155PT",146,0)
 ;
"RTN","EAS155PT",147,0)
 S (XMDUZ,XMSUB)="EAS*1*55 CLEANUP"
"RTN","EAS155PT",148,0)
 S XMY(.5)="",XMY(DUZ)=""
"RTN","EAS155PT",149,0)
 S XMTEXT="MSG("
"RTN","EAS155PT",150,0)
 S MSG(10)="Begin: "_$$HTE^XLFDT(^TMP("EAS155P",$J,"START"))
"RTN","EAS155PT",151,0)
 S MSG(20)="End:   "_$$HTE^XLFDT(^TMP("EAS155P",$J,"END"))
"RTN","EAS155PT",152,0)
 S MSG(30)="Processing Time: "_$$HDIFF^XLFDT(^TMP("EAS155P",$J,"END"),^TMP("EAS155P",$J,"START"),3)
"RTN","EAS155PT",153,0)
 S MSG(31)=""
"RTN","EAS155PT",154,0)
 S MSG(35)="   Turned Off:    "_EASCNT("OFF")
"RTN","EAS155PT",155,0)
 S MSG(40)="60-Day Letters:   "_EASCNT("60D")
"RTN","EAS155PT",156,0)
 S MSG(50)="30-Day Letters:   "_EASCNT("30D")
"RTN","EAS155PT",157,0)
 S MSG(60)=" 0-Day Letters:   "_EASCNT("0D")
"RTN","EAS155PT",158,0)
 S MSG(65)=""
"RTN","EAS155PT",159,0)
 S MSG(70)="No action required: "_^TMP("EAS155P",$J,"NOCHANGE")
"RTN","EAS155PT",160,0)
 D ^XMD
"RTN","EAS155PT",161,0)
 Q
"RTN","EAS155PT",162,0)
 ;
"RTN","EAS155PT",163,0)
REPORT ;
"RTN","EAS155PT",164,0)
 N EAX,PAGE,EANAME,EASIEN,EASLTR
"RTN","EAS155PT",165,0)
 ;
"RTN","EAS155PT",166,0)
 U IO
"RTN","EAS155PT",167,0)
 S (PAGE,EAX)=0
"RTN","EAS155PT",168,0)
 F EASLTR="60D","30D","0D" D
"RTN","EAS155PT",169,0)
 . D HDR
"RTN","EAS155PT",170,0)
 . I EASCNT(EASLTR)'>0 D  Q
"RTN","EAS155PT",171,0)
 . . W !!,"There were no letters reset for this letter type"
"RTN","EAS155PT",172,0)
 . S EASIEN=0
"RTN","EAS155PT",173,0)
 . F  S EASIEN=$O(^TMP("EAS155P",$J,EASLTR,EASIEN)) Q:EASIEN']""  D
"RTN","EAS155PT",174,0)
 . . W !,$$GET1^DIQ(713.2,EASIEN,2),?35,EASIEN,?55,$$GET1^DIQ(713.2,EASIEN,.01)
"RTN","EAS155PT",175,0)
 . . I ($Y+6)>IOSL D HDR
"RTN","EAS155PT",176,0)
 D FTR
"RTN","EAS155PT",177,0)
 Q
"RTN","EAS155PT",178,0)
 ;
"RTN","EAS155PT",179,0)
HDR ;
"RTN","EAS155PT",180,0)
 N DDASH,LINE,PART1,PART2,SPACE
"RTN","EAS155PT",181,0)
 ;
"RTN","EAS155PT",182,0)
 W @IOF
"RTN","EAS155PT",183,0)
 S PAGE=PAGE+1
"RTN","EAS155PT",184,0)
 W !,"Patch EAS*1*55 MT Letter Cleanup Results"
"RTN","EAS155PT",185,0)
 S PART1="Run Date: "_$$FMTE^XLFDT(DT)
"RTN","EAS155PT",186,0)
 S PART2="Page: "_PAGE
"RTN","EAS155PT",187,0)
 S SPACE=IOM,SPACE=SPACE-($L(PART1)+$L(PART2))
"RTN","EAS155PT",188,0)
 S $P(LINE," ",SPACE)=""
"RTN","EAS155PT",189,0)
 W !,PART1,LINE,PART2
"RTN","EAS155PT",190,0)
 W !!,$S(EASLTR="60D":"60-Day",EASLTR="30D":"30-Day",EASLTR="0D":"0-Day",1:"")," Letters for the following Veterans have been reset"
"RTN","EAS155PT",191,0)
 W !?5,"Name",?35,"File 713.2 IEN",?55,"Processing Date"
"RTN","EAS155PT",192,0)
 S $P(DDASH,"=",IOM)="" W !,DDASH
"RTN","EAS155PT",193,0)
 Q
"RTN","EAS155PT",194,0)
 ;
"RTN","EAS155PT",195,0)
FTR ;
"RTN","EAS155PT",196,0)
 W !!!!?5,"60-Day Letters:   "_EASCNT("60D")
"RTN","EAS155PT",197,0)
 W !?5,"30-Day Letters:   "_EASCNT("30D")
"RTN","EAS155PT",198,0)
 W !?5," 0-Day Letters:   "_EASCNT("0D")
"RTN","EAS155PT",199,0)
 Q
"RTN","EASMTL2")
0^3^B39641010
"RTN","EASMTL2",1,0)
EASMTL2 ;MIN/TCM ALB/SCK/AEG - AUTOMATED MEANS TEST LETTER - SEARCH ; 7/3/01
"RTN","EASMTL2",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**3,12,14,20,22,55**;MAR 15,2001
"RTN","EASMTL2",3,0)
 ;
"RTN","EASMTL2",4,0)
EN60 ; Entry point for inital 60-day letter search for candidates 
"RTN","EASMTL2",5,0)
 N EASIEN,DFN,VADM,CNT,ANNVDT,EASLAST
"RTN","EASMTL2",6,0)
 ;
"RTN","EASMTL2",7,0)
 K ^TMP("EASERR",$J)
"RTN","EASMTL2",8,0)
 S CNT=0 ; Initialize counter
"RTN","EASMTL2",9,0)
 S ANNVDT=EASDT("ANV")
"RTN","EASMTL2",10,0)
 ; Check for means test data to process, quit if none found
"RTN","EASMTL2",11,0)
 Q:'$D(^DGMT(408.31,"B",ANNVDT))
"RTN","EASMTL2",12,0)
 ;
"RTN","EASMTL2",13,0)
 ; Retieve data for each Means Test entry being processed
"RTN","EASMTL2",14,0)
 S EASIEN=0
"RTN","EASMTL2",15,0)
 F  S EASIEN=$O(^DGMT(408.31,"B",ANNVDT,EASIEN)) Q:EASIEN'>0  D
"RTN","EASMTL2",16,0)
 . ; Quit further processing if means test is not MEANS TEST type
"RTN","EASMTL2",17,0)
 . Q:'$$GET1^DIQ(408.31,EASIEN,.019,"I")=1
"RTN","EASMTL2",18,0)
 . S DFN=$$GET1^DIQ(408.31,EASIEN,.02,"I") ; get patient's DFN
"RTN","EASMTL2",19,0)
 . ; Check conditions; if all passed, add new entry to worklist file, #713.2
"RTN","EASMTL2",20,0)
 . Q:'DFN                         ; Safety check for DFN
"RTN","EASMTL2",21,0)
 . Q:'$$CHKDFN(DFN,EASIEN)          ; Check for valid PATIENT File entry, **55**
"RTN","EASMTL2",22,0)
 . Q:$$TEST(DFN)                  ; Quit if test patient
"RTN","EASMTL2",23,0)
 . S EASLAST=$$LST^DGMTU(DFN)     ; Get last MT on file
"RTN","EASMTL2",24,0)
 . Q:'(+EASLAST=EASIEN)  ; Not the latest MT record for patient
"RTN","EASMTL2",25,0)
 . Q:"L,N"[$P(EASLAST,U,4)        ; Quit, patient no longer requires means test (No Longer Applicable or No Longer Required)
"RTN","EASMTL2",26,0)
 . Q:$$DECEASED^EASMTUTL("",DFN)  ; Quit if patient deceased
"RTN","EASMTL2",27,0)
 . ;  If passed through all condition checks, update files
"RTN","EASMTL2",28,0)
 . Q:$$CHKSTAT(EASIEN,DFN)         ; Check current MT status
"RTN","EASMTL2",29,0)
 . Q:$$FUTURE(DFN)  ; Quit if a future means test is on file
"RTN","EASMTL2",30,0)
 . D NEWSTAT(DFN,.EASPT)
"RTN","EASMTL2",31,0)
 . Q:EASPT'>0  ; Safety check
"RTN","EASMTL2",32,0)
 . Q:'$$NEWLTR(EASPT,.EASDT)  ; Quit if letter status was not updated
"RTN","EASMTL2",33,0)
 . ; Finally, Update the counters
"RTN","EASMTL2",34,0)
 . S CNT=CNT+1
"RTN","EASMTL2",35,0)
 S EAS6CNT(EASPRCDT)=CNT,EAS6CNT=EAS6CNT+CNT
"RTN","EASMTL2",36,0)
 D ERRMSG
"RTN","EASMTL2",37,0)
 K ^TMP("EASERR",$J),^TMP("EASBDPTR",$J)
"RTN","EASMTL2",38,0)
 Q
"RTN","EASMTL2",39,0)
 ;
"RTN","EASMTL2",40,0)
NEWLTR(EASPT,EASDT) ; Add new entry to the work list file #713.2.
"RTN","EASMTL2",41,0)
 ; Input
"RTN","EASMTL2",42,0)
 ;   EASPT  - Ptr to 713.1 file
"RTN","EASMTL2",43,0)
 ;   EASDT  - Worklist date array
"RTN","EASMTL2",44,0)
 ;
"RTN","EASMTL2",45,0)
 ; Output
"RTN","EASMTL2",46,0)
 ;   RSLT   - 1 if new letter status entry added
"RTN","EASMTL2",47,0)
 ;            0 if new letter status was not added
"RTN","EASMTL2",48,0)
 ;
"RTN","EASMTL2",49,0)
 N ANNVDT,FDA,RSLT
"RTN","EASMTL2",50,0)
 ;
"RTN","EASMTL2",51,0)
 S ANNVDT=EASDT("ANV")
"RTN","EASMTL2",52,0)
 ;
"RTN","EASMTL2",53,0)
 ; Check for an existing entry for patient and anniversary date
"RTN","EASMTL2",54,0)
 I $D(^EAS(713.2,"AN",EASPT,ANNVDT)) Q 0 ; Quit if duplicate entry
"RTN","EASMTL2",55,0)
 ;
"RTN","EASMTL2",56,0)
 ; Add new entry to the letter status file, #713.2
"RTN","EASMTL2",57,0)
 S FDA(1,713.2,"+1,",.01)=EADT
"RTN","EASMTL2",58,0)
 S FDA(1,713.2,"+1,",2)=EASPT
"RTN","EASMTL2",59,0)
 S FDA(1,713.2,"+1,",3)=ANNVDT
"RTN","EASMTL2",60,0)
 S FDA(1,713.2,"+1,",4)=0
"RTN","EASMTL2",61,0)
 S FDA(1,713.2,"+1,",8)=EASDT("60")
"RTN","EASMTL2",62,0)
 S FDA(1,713.2,"+1,",11)=EASDT("30")
"RTN","EASMTL2",63,0)
 S FDA(1,713.2,"+1,",17)=EASDT("0")
"RTN","EASMTL2",64,0)
 S FDA(1,713.2,"+1,",9)=1
"RTN","EASMTL2",65,0)
 ; Modification for DCD sites which are required to print only the 0-day letters
"RTN","EASMTL2",66,0)
 ;; EAS*1*12
"RTN","EASMTL2",67,0)
 I $$VERSION^XPDUTL("IVMC"),$G(DT)'>3021014 D
"RTN","EASMTL2",68,0)
 . K FDA(1,713.2,"+1,",9)
"RTN","EASMTL2",69,0)
 . S FDA(1,713.2,"+1,",18)=1
"RTN","EASMTL2",70,0)
 ; ***
"RTN","EASMTL2",71,0)
 D UPDATE^DIE("","FDA(1)","","ERRMSG")
"RTN","EASMTL2",72,0)
 Q 1
"RTN","EASMTL2",73,0)
 ;
"RTN","EASMTL2",74,0)
UPDLTR(EAS1,TYPE) ; Update Flagged to print field for letter type
"RTN","EASMTL2",75,0)
 ; Input
"RTN","EASMTL2",76,0)
 ;   EAS1  - Ptr to file 713.2
"RTN","EASMTL2",77,0)
 ;   TYPE  - Letter type (1:60d, 2:30d, 4:0d)
"RTN","EASMTL2",78,0)
 ;
"RTN","EASMTL2",79,0)
 N DGFDA,ERRMSG
"RTN","EASMTL2",80,0)
 ;
"RTN","EASMTL2",81,0)
 S DGFDA(1,713.2,EAS1_",",$S(TYPE=2:12,1:18))=1
"RTN","EASMTL2",82,0)
 D UPDATE^DIE("","DGFDA(1)","","ERRMSG")
"RTN","EASMTL2",83,0)
 Q
"RTN","EASMTL2",84,0)
 ;
"RTN","EASMTL2",85,0)
NEWSTAT(DFN,EASPT) ; Update the Patient status file, #713.1
"RTN","EASMTL2",86,0)
 ; Input
"RTN","EASMTL2",87,0)
 ;   DFN   - Patient's DFN
"RTN","EASMTL2",88,0)
 ;   EASPT - Return Var, New IEN to 713.1 file
"RTN","EASMTL2",89,0)
 ;
"RTN","EASMTL2",90,0)
 N EASIEN,DGFDA,FDAIEN,ERROUT
"RTN","EASMTL2",91,0)
 ;
"RTN","EASMTL2",92,0)
 ; Create new entry in the patient status file
"RTN","EASMTL2",93,0)
 ;
"RTN","EASMTL2",94,0)
 I '$D(^EAS(713.1,"B",DFN)) D  Q
"RTN","EASMTL2",95,0)
 . S DGFDA(1,713.1,"+1,",.01)=DFN
"RTN","EASMTL2",96,0)
 . S DGFDA(1,713.1,"+1,",2)=0
"RTN","EASMTL2",97,0)
 . D UPDATE^DIE("","DGFDA(1)","FDAIEN","ERROUT(1)")
"RTN","EASMTL2",98,0)
 . I $D(ERROUT) D
"RTN","EASMTL2",99,0)
 . . S ^TMP("EASERR",$J,DFN)=ERROUT(1,"DIERR",1)_" - "_ERROUT(1,"DIERR",1,"TEXT",1)
"RTN","EASMTL2",100,0)
 . . S:+$G(FDAIEN(1))'>0 ^TMP("EASERR",$J,DFN)="Unable to generate entry in EAS MT PATIENT STATUS File, #713.1"
"RTN","EASMTL2",101,0)
 . S EASPT=+$G(FDAIEN(1))
"RTN","EASMTL2",102,0)
 ;
"RTN","EASMTL2",103,0)
 I $D(^EAS(713.1,"B",DFN)) D
"RTN","EASMTL2",104,0)
 . Q:'DFN
"RTN","EASMTL2",105,0)
 . S EASPT=$O(^EAS(713.1,"B",DFN,0))
"RTN","EASMTL2",106,0)
 Q
"RTN","EASMTL2",107,0)
 ;
"RTN","EASMTL2",108,0)
PRNTDT(EARY,ETYPE) ; Retrieve Print date and flagged to print status for letter type
"RTN","EASMTL2",109,0)
 ; Input
"RTN","EASMTL2",110,0)
 ;    EARY  - Data array from Patient Status file, #713.1, MT Anniversary date field, #11
"RTN","EASMTL2",111,0)
 ;    ETYPE - Search type, 30 or 0 day
"RTN","EASMTL2",112,0)
 ;
"RTN","EASMTL2",113,0)
 ; Output
"RTN","EASMTL2",114,0)
 ;    RSLT = Print date ^ Flagged to print status
"RTN","EASMTL2",115,0)
 ;           will be 0^0 if nothing found to return
"RTN","EASMTL2",116,0)
 ;
"RTN","EASMTL2",117,0)
 N RSLT
"RTN","EASMTL2",118,0)
 ;
"RTN","EASMTL2",119,0)
 S RSLT=$S(ETYPE=2:EARY(11,"I"),ETYPE=4:EARY(17,"I"),1:0)
"RTN","EASMTL2",120,0)
 S RSLT=RSLT_"^"_+$S(ETYPE=2:EARY(12,"I"),ETYPE=4:EARY(18,"I"),1:0)
"RTN","EASMTL2",121,0)
 Q RSLT
"RTN","EASMTL2",122,0)
 ;
"RTN","EASMTL2",123,0)
CHKSTAT(EASIEN,DFN) ; Check for means test status, still required or not
"RTN","EASMTL2",124,0)
 ; Input
"RTN","EASMTL2",125,0)
 ;    EASIEN  - Internal Entry Number to the ANNUAL MEANS TEST File, #408.31
"RTN","EASMTL2",126,0)
 ;
"RTN","EASMTL2",127,0)
 ; Output
"RTN","EASMTL2",128,0)
 ;    1 - if means test is no longer required or applicable
"RTN","EASMTL2",129,0)
 ;    0 - if means test is still required
"RTN","EASMTL2",130,0)
 ;
"RTN","EASMTL2",131,0)
 N RSLT,EASTAT
"RTN","EASMTL2",132,0)
 ;
"RTN","EASMTL2",133,0)
 ; If status = "NO LONGER REQUIRED" or "NO LONGER APPLICABLE" then set result to 1
"RTN","EASMTL2",134,0)
 ; The .03 field is a pointer to the MEANS TEST STATUS File, #408.32, checks
"RTN","EASMTL2",135,0)
 ; IEN=3 and IEN=10, NO LONGER REQUIRED and NO LONGER APPLICABLE entries respectively 
"RTN","EASMTL2",136,0)
 ; If the 408.32 file is changed, this code will need to be reviewed and updated if necessary.
"RTN","EASMTL2",137,0)
 ;
"RTN","EASMTL2",138,0)
 S RSLT=0,DFN=$G(DFN)
"RTN","EASMTL2",139,0)
 ;
"RTN","EASMTL2",140,0)
 S EASTAT=$$GET1^DIQ(408.31,EASIEN,.03,"I")
"RTN","EASMTL2",141,0)
 I (EASTAT=3)!(EASTAT=10) S RSLT=1
"RTN","EASMTL2",142,0)
 ;
"RTN","EASMTL2",143,0)
 ;; Check current MT Status from API (Looking for Cat-C, Agree to Pay Dedct, MT later than 10-5-99
"RTN","EASMTL2",144,0)
 I 'RSLT D
"RTN","EASMTL2",145,0)
 . S:'$$MTCHK^EASMTCHK(DFN,"L") RSLT=1
"RTN","EASMTL2",146,0)
 ;
"RTN","EASMTL2",147,0)
 Q $G(RSLT)
"RTN","EASMTL2",148,0)
 ;
"RTN","EASMTL2",149,0)
FUTURE(DFN) ; Future Means Test available?
"RTN","EASMTL2",150,0)
 N RSLT
"RTN","EASMTL2",151,0)
 ;
"RTN","EASMTL2",152,0)
 S RSLT=$$FUT^DGMTU(DFN)
"RTN","EASMTL2",153,0)
 Q $G(RSLT)
"RTN","EASMTL2",154,0)
 ;
"RTN","EASMTL2",155,0)
TEST(DFN) ; Test Patient?
"RTN","EASMTL2",156,0)
 N VAROOT,ZSSN,EASDEM
"RTN","EASMTL2",157,0)
 ;
"RTN","EASMTL2",158,0)
 S VAROOT="EASDEM"
"RTN","EASMTL2",159,0)
 D DEM^VADPT
"RTN","EASMTL2",160,0)
 S ZSSN=$P(EASDEM(2),U,1)
"RTN","EASMTL2",161,0)
 I $E(ZSSN,1,5)["00000" Q 1
"RTN","EASMTL2",162,0)
 ;
"RTN","EASMTL2",163,0)
 Q 0
"RTN","EASMTL2",164,0)
 ;
"RTN","EASMTL2",165,0)
CHKDFN(DFN,MTIEN) ; Checks for a valid zero node in the patient file entry.  
"RTN","EASMTL2",166,0)
 ; If no valid zero node, sets bad ptr entry
"RTN","EASMTL2",167,0)
 ;
"RTN","EASMTL2",168,0)
 N RSLT
"RTN","EASMTL2",169,0)
 ;
"RTN","EASMTL2",170,0)
 S DFN=$G(DFN),MTIEN=$G(MTIEN)
"RTN","EASMTL2",171,0)
 S RSLT=$D(^DPT(DFN,0))
"RTN","EASMTL2",172,0)
 I 'RSLT D
"RTN","EASMTL2",173,0)
 . S ^TMP("EASBDPTR",$J,DFN)=MTIEN
"RTN","EASMTL2",174,0)
 ;
"RTN","EASMTL2",175,0)
 Q $G(RSLT)
"RTN","EASMTL2",176,0)
 ;
"RTN","EASMTL2",177,0)
ERRMSG ; Send mail message if any errors were generated during processing
"RTN","EASMTL2",178,0)
 I $D(^TMP("EASERR",$J)) D ERRORS
"RTN","EASMTL2",179,0)
 I $D(^TMP("EASBDPTR",$J)) D BADPTR
"RTN","EASMTL2",180,0)
 Q
"RTN","EASMTL2",181,0)
 ;
"RTN","EASMTL2",182,0)
ERRORS ;
"RTN","EASMTL2",183,0)
 N EASDFN,EASERR,MSG,DFN,VA
"RTN","EASMTL2",184,0)
 ;
"RTN","EASMTL2",185,0)
 S MSG(.1)="The following issues were reported by the Means Test Letter Search Process:"
"RTN","EASMTL2",186,0)
 S MSG(.9)=""
"RTN","EASMTL2",187,0)
 ;
"RTN","EASMTL2",188,0)
 S EASDFN=0
"RTN","EASMTL2",189,0)
 F  S EASDFN=$O(^TMP("EASERR",$J,EASDFN)) Q:'EASDFN  D
"RTN","EASMTL2",190,0)
 . S DFN=EASDFN D PID^VADPT
"RTN","EASMTL2",191,0)
 . S MSG(EASDFN)=$$GET1^DIQ(2,EASDFN,.01)_" ("_VA("BID")_") "_$G(^TMP("EASERR",$J,EASDFN))
"RTN","EASMTL2",192,0)
 . K VA
"RTN","EASMTL2",193,0)
 ;
"RTN","EASMTL2",194,0)
 D SEND(.MSG)
"RTN","EASMTL2",195,0)
 Q
"RTN","EASMTL2",196,0)
 ;
"RTN","EASMTL2",197,0)
BADPTR ;
"RTN","EASMTL2",198,0)
 N EASDFN,EASERR,MSG,X
"RTN","EASMTL2",199,0)
 ;
"RTN","EASMTL2",200,0)
 S MSG(.1)="During the MT Letter Search, the following Annual Means Test "
"RTN","EASMTL2",201,0)
 S MSG(.2)="File entries (#408.31) were found which may point to a non-existent"
"RTN","EASMTL2",202,0)
 S MSG(.3)="Patient entry in the PATIENT File (#2):"
"RTN","EASMTL2",203,0)
 S MSG(.4)=""
"RTN","EASMTL2",204,0)
 S X=$$SETSTR^VALM1("PATIENT FILE (#2)","",5,20)
"RTN","EASMTL2",205,0)
 S X=$$SETSTR^VALM1("MT FILE (#408.31)",X,35,20)
"RTN","EASMTL2",206,0)
 S MSG(.5)=X
"RTN","EASMTL2",207,0)
 S X=$$SETSTR^VALM1("=================","",5,20)
"RTN","EASMTL2",208,0)
 S X=$$SETSTR^VALM1("=================",X,35,20)
"RTN","EASMTL2",209,0)
 S MSG(.6)=X
"RTN","EASMTL2",210,0)
 ;
"RTN","EASMTL2",211,0)
 S EASDFN=0
"RTN","EASMTL2",212,0)
 F  S EASDFN=$O(^TMP("EASBDPTR",$J,EASDFN)) Q:'EASDFN  D
"RTN","EASMTL2",213,0)
 . S X=$$SETSTR^VALM1(EASDFN,"",5,20)
"RTN","EASMTL2",214,0)
 . S X=$$SETSTR^VALM1($G(^TMP("EASBDPTR",$J,EASDFN)),X,35,20)
"RTN","EASMTL2",215,0)
 . S MSG(EASDFN)=X
"RTN","EASMTL2",216,0)
 ;
"RTN","EASMTL2",217,0)
 D SEND(.MSG)
"RTN","EASMTL2",218,0)
 Q
"RTN","EASMTL2",219,0)
 ;
"RTN","EASMTL2",220,0)
SEND(MSG) ;
"RTN","EASMTL2",221,0)
 S XMSUB="MT LETTERS SEARCH ISSUES - "_$$FMTE^XLFDT($$NOW^XLFDT,"D")
"RTN","EASMTL2",222,0)
 S XMTEXT="MSG("
"RTN","EASMTL2",223,0)
 S XMY("G.EAS MTLETTERS")=""
"RTN","EASMTL2",224,0)
 S XMDUZ="AUTOMATED MT LETTERS"
"RTN","EASMTL2",225,0)
 D ^XMD
"RTN","EASMTL2",226,0)
 Q
"RTN","EASUER")
0^4^B20338353
"RTN","EASUER",1,0)
EASUER ;ALB/CKN - GEOGRAPHIC MEANS TEST PHASE II ; 03-MAR-2003
"RTN","EASUER",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**25,37,50,55**;Mar 15, 2001
"RTN","EASUER",3,0)
 ;This routine contains several APIs that will be called from
"RTN","EASUER",4,0)
 ;different packages like Scheduling, PCE and Fee basis to notify
"RTN","EASUER",5,0)
 ;Enrollment package whenever any inpatient/outpatient encounter occurs,
"RTN","EASUER",6,0)
 ;or any appointment made or any changes made to fee basis authorization.
"RTN","EASUER",7,0)
 Q
"RTN","EASUER",8,0)
SCHED ;This API will be called from SDAM APPOINTMENT EVENTS via EAS UE SCHED 
"RTN","EASUER",9,0)
 ;EVENT protocol whenever any changes made to veteran's appointment.
"RTN","EASUER",10,0)
 ;Input variables used in this api:
"RTN","EASUER",11,0)
 ;             SDATA     -  piece 1 - ien of multiple entry of the 
"RTN","EASUER",12,0)
 ;                                    APPOINTMENTS multiple of the
"RTN","EASUER",13,0)
 ;                                    HOSPITAL LOCATION file.
"RTN","EASUER",14,0)
 ;                          piece 2 - ien of PATIENT file (DFN)
"RTN","EASUER",15,0)
 ;                          piece 3 - internal Date/time of appt.
"RTN","EASUER",16,0)
 ;                          piece 4 - ien of clinic in the HOSPITAL
"RTN","EASUER",17,0)
 ;                                    LOCATION file.
"RTN","EASUER",18,0)
 ;             SDAMEVT   -  ien pointing to an entry in the APPOINTMENT
"RTN","EASUER",19,0)
 ;                          TRANSACTION file (#409.66).
"RTN","EASUER",20,0)
 ;
"RTN","EASUER",21,0)
 N DFN,APT,APTDT
"RTN","EASUER",22,0)
 S DFN=$P($G(SDATA),"^",2) Q:DFN=""  ;Veteran's IEN
"RTN","EASUER",23,0)
 I $G(SDAMEVT)=1 D  ;if new appointment is made
"RTN","EASUER",24,0)
 . S APTDT=$P($G(SDATA),"^",3),APTDT=$$FY(APTDT)
"RTN","EASUER",25,0)
 . ;check current User Enrollee data and update it if necessary.
"RTN","EASUER",26,0)
 . I $$UPDCHK(DFN,APTDT) D FILE(DFN,APTDT)
"RTN","EASUER",27,0)
 Q
"RTN","EASUER",28,0)
ENC ;This API will be called from PXK VISIT DATA EVENT via EAS UE PCE EVENT
"RTN","EASUER",29,0)
 ;whenever any inpatient/outpatient encounter occurs.
"RTN","EASUER",30,0)
 ;Input:
"RTN","EASUER",31,0)
 ;^TMP("PXKCO",$J,VISIT,"V FILE STRING",V FILE RECORD,DDSUBSCRIPT,"AFTER/BEFORE")=DATA
"RTN","EASUER",32,0)
 ;where: subscript piece 1 - string notation representing package "PXKCO"
"RTN","EASUER",33,0)
 ;       subscript piece 2 - Job number ($J)
"RTN","EASUER",34,0)
 ;       subscript piece 3 - ien of VISIT file
"RTN","EASUER",35,0)
 ;       subscript piece 4 - string representing the VISIT or V file
"RTN","EASUER",36,0)
 ;                           data category
"RTN","EASUER",37,0)
 ;       subscript piece 5 - ien of the entry in the file represented in
"RTN","EASUER",38,0)
 ;                           subscript #4
"RTN","EASUER",39,0)
 ;       subscript piece 6 - subscript or DD node on which the data is stored.
"RTN","EASUER",40,0)
 ;       subscript piece 7 - string designating whether or not the data
"RTN","EASUER",41,0)
 ;                           is an "after" or "before" reflection of data.
"RTN","EASUER",42,0)
 ;
"RTN","EASUER",43,0)
 N VSIT,NODE,DFN,VDT
"RTN","EASUER",44,0)
 I '$D(^TMP("PXKCO",$J)) Q
"RTN","EASUER",45,0)
 S VSIT=$O(^TMP("PXKCO",$J,"")) Q:VSIT=""  ;ien of VISIT file
"RTN","EASUER",46,0)
 S NODE=$G(^AUPNVSIT(VSIT,0))
"RTN","EASUER",47,0)
 ;get Veteran's IEN and encounter date
"RTN","EASUER",48,0)
 S DFN=$P($G(NODE),"^",5),VDT=$P($G(NODE),"^",1)
"RTN","EASUER",49,0)
 S VDT=$$FY(VDT)
"RTN","EASUER",50,0)
 ;check current User Enrollee data and update if necessary
"RTN","EASUER",51,0)
 I $$UPDCHK(DFN,VDT) D FILE(DFN,VDT)
"RTN","EASUER",52,0)
 Q
"RTN","EASUER",53,0)
FBAUTH(FBDFN,FBTODT) ;This Enrollment api will be called from Fee basis
"RTN","EASUER",54,0)
 ;applications at the time of any fee basis authorization changes.
"RTN","EASUER",55,0)
 ;Input:         FBDFN  -  Veteran's ien
"RTN","EASUER",56,0)
 ;              FBTODT  -  Latest date of authorization.
"RTN","EASUER",57,0)
 ;
"RTN","EASUER",58,0)
 N XDT
"RTN","EASUER",59,0)
 S XDT=$$FY(FBTODT)
"RTN","EASUER",60,0)
 I $$UPDCHK(FBDFN,XDT) D FILE(FBDFN,XDT)
"RTN","EASUER",61,0)
 Q
"RTN","EASUER",62,0)
INP ;This Enrollment api will be called from DGPM MOVEMENT EVENT via 
"RTN","EASUER",63,0)
 ;EAS UE INP EVENT protocol whenever inpatient veteran is admitted,
"RTN","EASUER",64,0)
 ;transfered,discharged or any movement.
"RTN","EASUER",65,0)
 ;supported variables of this event:
"RTN","EASUER",66,0)
 ;       DFN  - Pointer to patient in PATIENT file (#2)
"RTN","EASUER",67,0)
 ;    DGPMDA  - Pointer to primary movement in PATIENT MOVEMENT file.
"RTN","EASUER",68,0)
 ;     DGPMP  - Zero node of primary movement prior to add/edit/del
"RTN","EASUER",69,0)
 ;     DGPMA  - Zero node of primary movement after add/edit/delete
"RTN","EASUER",70,0)
 ;
"RTN","EASUER",71,0)
 N XDT
"RTN","EASUER",72,0)
 I '$G(DFN)!'$G(DGPMDA) Q
"RTN","EASUER",73,0)
 S XDT=$P($G(^DGPM(DGPMDA,0)),"^")  ;Date of movement
"RTN","EASUER",74,0)
 S XDT=$$FY(XDT) I $$UPDCHK(DFN,XDT) D FILE(DFN,XDT)
"RTN","EASUER",75,0)
 Q
"RTN","EASUER",76,0)
UESTAT(DFN) ;This api will be called at the time of Annual MT renewal
"RTN","EASUER",77,0)
 ;process to check if veteran has UE status for current FY.
"RTN","EASUER",78,0)
 N UESTAT,UESITE,UESTN,CURSTN,PRNT,CHILD,CIEN
"RTN","EASUER",79,0)
 I '$G(DFN) Q 0  ;No DFN
"RTN","EASUER",80,0)
 S UESTAT=$P($G(^DPT(DFN,.361)),"^",7)
"RTN","EASUER",81,0)
 I UESTAT="" Q 0  ;Not User Enrollee
"RTN","EASUER",82,0)
 I UESTAT<$$FY(DT) Q 0  ;Not User Enrollee for current FY
"RTN","EASUER",83,0)
 S UESITE=$P($G(^DPT(DFN,.361)),"^",8) Q:+UESITE=0 0
"RTN","EASUER",84,0)
 ; *** Modifications for patch 55 to handle VISN or HCS UE Sites
"RTN","EASUER",85,0)
 S UESTN=$$STA^XUAF4(UESITE)
"RTN","EASUER",86,0)
 S CURSTN=$P($$SITE^VASITE,"^",3)
"RTN","EASUER",87,0)
 ;
"RTN","EASUER",88,0)
 I UESTN']"" D
"RTN","EASUER",89,0)
 . D CHILDREN^XUAF4("CHILD","`"_UESITE,"PARENT FACILITY")
"RTN","EASUER",90,0)
 . S CIEN=0 F  S CIEN=$O(CHILD("C",CIEN)) Q:'CIEN  I CIEN=CURSTN S UESTN=$$STA^XUAF4(CIEN) Q
"RTN","EASUER",91,0)
 . I UESTN']"" D
"RTN","EASUER",92,0)
 . . D CHILDREN^XUAF4("CHILD","`"_UESITE,"VISN")
"RTN","EASUER",93,0)
 . . S CIEN=0 F  S CIEN=$O(CHILD("C",CIEN)) Q:'CIEN  I CIEN=CURSTN S UESTN=$$STA^XUAF4(CIEN) Q
"RTN","EASUER",94,0)
 ;
"RTN","EASUER",95,0)
 S PRNT=$$PSITE(CURSTN),CURSTN=$$STA^XUAF4(PRNT)
"RTN","EASUER",96,0)
 I UESTN'=CURSTN Q 2  ;Not same site
"RTN","EASUER",97,0)
 Q 1
"RTN","EASUER",98,0)
UPDCHK(DFN,APTDT) ;This api will determine whether to update User Enrollee data.
"RTN","EASUER",99,0)
 I '$G(DFN) Q 0  ;No DFN
"RTN","EASUER",100,0)
 I $P($G(^DPT(DFN,"VET")),"^")="N" Q 0  ;Quit if Non veteran
"RTN","EASUER",101,0)
 I APTDT<3030000 Q 0  ;Quit if APTDT is less than FY 2003
"RTN","EASUER",102,0)
 N CURSTAT
"RTN","EASUER",103,0)
 S CURSTAT=$P($G(^DPT(DFN,.361)),"^",7)
"RTN","EASUER",104,0)
 I APTDT>CURSTAT Q 1
"RTN","EASUER",105,0)
 Q 0
"RTN","EASUER",106,0)
FY(XDATE) ;Returns a fiscal year for the date
"RTN","EASUER",107,0)
 N ENFY S ENFY=""
"RTN","EASUER",108,0)
 I $G(XDATE)?7N.E S ENFY=$S($E(XDATE,4,5)<10:$E(XDATE,1,3),1:$E(XDATE,1,3)+1)
"RTN","EASUER",109,0)
 Q ENFY_"0000"
"RTN","EASUER",110,0)
 ;
"RTN","EASUER",111,0)
PSITE(STA) ;Get parent site IEN
"RTN","EASUER",112,0)
 N PRNT,PRNTYP
"RTN","EASUER",113,0)
 ;
"RTN","EASUER",114,0)
 S PRNT=0
"RTN","EASUER",115,0)
 ; First pass, get the parent facility, then get the facility type for the parent
"RTN","EASUER",116,0)
 ; If the parent is a VAMC, then quit returning parent
"RTN","EASUER",117,0)
 ; If the parent is either a VISN or HCS type, then return the current station, not the parent
"RTN","EASUER",118,0)
 ;
"RTN","EASUER",119,0)
 S PRNT=+$$PRNT^XUAF4(STA)
"RTN","EASUER",120,0)
 I PRNT>0 D
"RTN","EASUER",121,0)
 . S PRNTYP=$$GET1^DIQ(4,PRNT,13)
"RTN","EASUER",122,0)
 . I PRNTYP="VAMC" Q
"RTN","EASUER",123,0)
 . I "HCS,VISN"[PRNTYP S PRNT=STA Q
"RTN","EASUER",124,0)
 E  D
"RTN","EASUER",125,0)
 . I $$GET1^DIQ(4,STA,13)="VAMC" S PRNT=STA Q
"RTN","EASUER",126,0)
 . E  S REVSTA=$E(STA,1,3),PRNT=+$$PRNT^XUAF4(REVSTA) D
"RTN","EASUER",127,0)
 . . I $$GET1^DIQ(4,PRNT,13)="VAMC" Q
"RTN","EASUER",128,0)
 . . S PRNT=+$O(^DIC(4,"D",REVSTA,""))
"RTN","EASUER",129,0)
 Q PRNT
"RTN","EASUER",130,0)
 ;
"RTN","EASUER",131,0)
CHKPRNT(PRNT) ; Check if parent is a VISN entity, removed with Patch 50
"RTN","EASUER",132,0)
 Q 0
"RTN","EASUER",133,0)
 ;
"RTN","EASUER",134,0)
FILE(XIEN,XDT) ;Update User Enrollee fields and queue Z07
"RTN","EASUER",135,0)
 N DATA,FILEUPD,SITE,PRNT,EVENT,IYR
"RTN","EASUER",136,0)
 S SITE=$$SITE^VASITE,SITE=$P($G(SITE),"^",3)
"RTN","EASUER",137,0)
 S PRNT=$$PSITE(SITE) Q:'+$G(PRNT)
"RTN","EASUER",138,0)
 S DATA(.3617)=XDT,DATA(.3618)=PRNT
"RTN","EASUER",139,0)
 I '$$UPD^DGENDBS(2,.XIEN,.DATA) Q
"RTN","EASUER",140,0)
 S IYR=$$INCYR(XIEN)
"RTN","EASUER",141,0)
 S EVENT("ENROLL")=1 I $$LOG^IVMPLOG(XIEN,IYR,.EVENT)
"RTN","EASUER",142,0)
 Q
"RTN","EASUER",143,0)
INCYR(XIEN) ;Get valid income year
"RTN","EASUER",144,0)
 ;N INCYR,LMT,R3015,I,TEMP
"RTN","EASUER",145,0)
 I $D(^IVM(301.5,"APT",XIEN)) D  Q INCYR
"RTN","EASUER",146,0)
 . S INCYR=$O(^IVM(301.5,"APT",XIEN,""),-1)
"RTN","EASUER",147,0)
 F I=1,2,4 D
"RTN","EASUER",148,0)
 . S LMT=$$LST^DGMTU(XIEN,,I)
"RTN","EASUER",149,0)
 . I +$G(LMT) S TEMP($P(LMT,"^",2))=""
"RTN","EASUER",150,0)
 I $D(TEMP) S LMT=$O(TEMP(""),-1),INCYR=($E(LMT,1,3)-1)_"0000" Q INCYR
"RTN","EASUER",151,0)
 S INCYR=($E(DT,1,3)-1)_"0000"
"RTN","EASUER",152,0)
 Q INCYR
"VER")
8.0^22
**END**
**END**
