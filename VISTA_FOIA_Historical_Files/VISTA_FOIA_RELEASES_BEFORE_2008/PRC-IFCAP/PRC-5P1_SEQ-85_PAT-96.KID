Released PRC*5.1*96 SEQ #85
Extracted from mail message
**KIDS**:PRC*5.1*96^

**INSTALL NAME**
PRC*5.1*96
"BLD",4942,0)
PRC*5.1*96^IFCAP^0^3060206^y
"BLD",4942,1,0)
^^9^9^3060206^
"BLD",4942,1,1,0)
This patch corrects an issue with FMS transactions that have a Transcode 
"BLD",4942,1,2,0)
of PR (payroll).  The issue occurs when payroll transactions use the same 
"BLD",4942,1,3,0)
common number series for transaction numbers as Purchase Orders.  The 
"BLD",4942,1,4,0)
code initially look at file 442 to find a transaction number match, if 
"BLD",4942,1,5,0)
one did not exist it then searched for payroll transactions.  
"BLD",4942,1,6,0)
Unfortunately, if the same common number series was used to create both 
"BLD",4942,1,7,0)
types of transactions there are instances where two separate transactions 
"BLD",4942,1,8,0)
have the same exact transaction number causing an incorrect posting of 
"BLD",4942,1,9,0)
payroll data to Purchase Order transactions.
"BLD",4942,4,0)
^9.64PA^^
"BLD",4942,"KRN",0)
^9.67PA^8989.52^19
"BLD",4942,"KRN",.4,0)
.4
"BLD",4942,"KRN",.401,0)
.401
"BLD",4942,"KRN",.402,0)
.402
"BLD",4942,"KRN",.403,0)
.403
"BLD",4942,"KRN",.5,0)
.5
"BLD",4942,"KRN",.84,0)
.84
"BLD",4942,"KRN",3.6,0)
3.6
"BLD",4942,"KRN",3.8,0)
3.8
"BLD",4942,"KRN",9.2,0)
9.2
"BLD",4942,"KRN",9.8,0)
9.8
"BLD",4942,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",4942,"KRN",9.8,"NM",1,0)
PRCSREC^^0^B22653875
"BLD",4942,"KRN",9.8,"NM","B","PRCSREC",1)

"BLD",4942,"KRN",19,0)
19
"BLD",4942,"KRN",19.1,0)
19.1
"BLD",4942,"KRN",101,0)
101
"BLD",4942,"KRN",409.61,0)
409.61
"BLD",4942,"KRN",771,0)
771
"BLD",4942,"KRN",870,0)
870
"BLD",4942,"KRN",8989.51,0)
8989.51
"BLD",4942,"KRN",8989.52,0)
8989.52
"BLD",4942,"KRN",8994,0)
8994
"BLD",4942,"KRN","B",.4,.4)

"BLD",4942,"KRN","B",.401,.401)

"BLD",4942,"KRN","B",.402,.402)

"BLD",4942,"KRN","B",.403,.403)

"BLD",4942,"KRN","B",.5,.5)

"BLD",4942,"KRN","B",.84,.84)

"BLD",4942,"KRN","B",3.6,3.6)

"BLD",4942,"KRN","B",3.8,3.8)

"BLD",4942,"KRN","B",9.2,9.2)

"BLD",4942,"KRN","B",9.8,9.8)

"BLD",4942,"KRN","B",19,19)

"BLD",4942,"KRN","B",19.1,19.1)

"BLD",4942,"KRN","B",101,101)

"BLD",4942,"KRN","B",409.61,409.61)

"BLD",4942,"KRN","B",771,771)

"BLD",4942,"KRN","B",870,870)

"BLD",4942,"KRN","B",8989.51,8989.51)

"BLD",4942,"KRN","B",8989.52,8989.52)

"BLD",4942,"KRN","B",8994,8994)

"BLD",4942,"QUES",0)
^9.62^^
"BLD",4942,"REQB",0)
^9.611^^
"MBREQ")
0
"PKG",455,-1)
1^1
"PKG",455,0)
IFCAP^PRC^IFCAP System Files
"PKG",455,20,0)
^9.402P^^
"PKG",455,22,0)
^9.49I^1^1
"PKG",455,22,1,0)
5.1^3001012^3001019^68
"PKG",455,22,1,"PAH",1,0)
96^3060206
"PKG",455,22,1,"PAH",1,1,0)
^^9^9^3060206
"PKG",455,22,1,"PAH",1,1,1,0)
This patch corrects an issue with FMS transactions that have a Transcode 
"PKG",455,22,1,"PAH",1,1,2,0)
of PR (payroll).  The issue occurs when payroll transactions use the same 
"PKG",455,22,1,"PAH",1,1,3,0)
common number series for transaction numbers as Purchase Orders.  The 
"PKG",455,22,1,"PAH",1,1,4,0)
code initially look at file 442 to find a transaction number match, if 
"PKG",455,22,1,"PAH",1,1,5,0)
one did not exist it then searched for payroll transactions.  
"PKG",455,22,1,"PAH",1,1,6,0)
Unfortunately, if the same common number series was used to create both 
"PKG",455,22,1,"PAH",1,1,7,0)
types of transactions there are instances where two separate transactions 
"PKG",455,22,1,"PAH",1,1,8,0)
have the same exact transaction number causing an incorrect posting of 
"PKG",455,22,1,"PAH",1,1,9,0)
payroll data to Purchase Order transactions.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","PRCSREC")
0^1^B22653875^B22254107
"RTN","PRCSREC",1,0)
PRCSREC ;WISC/KMB/DL-FMS 820 RECONCILIATION INTERCEPT ;12/28/99  11:06
"RTN","PRCSREC",2,0)
V ;;5.1;IFCAP;**96**;Oct 20, 2000
"RTN","PRCSREC",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCSREC",4,0)
 ;  add entry to file 417, update CP balance on File 420
"RTN","PRCSREC",5,0)
 ;  finally, send 820 to designee at CP
"RTN","PRCSREC",6,0)
 ;  if duplicate, or CP is not in IFCAP, set status to "N" or "D"
"RTN","PRCSREC",7,0)
START ;
"RTN","PRCSREC",8,0)
 Q:'$D(PRCDA)
"RTN","PRCSREC",9,0)
 N AA,STATUS,STATION,CHECK,FILE,FCP,PODA,OUT,RDA,FY,QTR,TEMP,PONUM,PONUM1,TRANSNUM,X,Y,TDATE
"RTN","PRCSREC",10,0)
 N LINE,LNN,TRANCODE,COUNTER,AMT,RDATE,FMSREF,K,ERROR,STRING
"RTN","PRCSREC",11,0)
 N ENDFY,BEGFY
"RTN","PRCSREC",12,0)
 S OUT=0,(FCP,STATION)=""
"RTN","PRCSREC",13,0)
 D NOW^%DTC S RDATE=%,RDA=PRCDA
"RTN","PRCSREC",14,0)
 ;    1,2 is this the right type of transaction
"RTN","PRCSREC",15,0)
 S CHECK=$P($G(^PRCF(423.6,RDA,1,10000,0)),"^",3) I CHECK'["IFC" S OUT=1 D EVAL Q
"RTN","PRCSREC",16,0)
 S CHECK=$P($G(^PRCF(423.6,RDA,1,10000,0)),"^",5) I CHECK'["REC" S OUT=2 D EVAL Q
"RTN","PRCSREC",17,0)
 ;    3 is site correct
"RTN","PRCSREC",18,0)
 S STATION=$P($G(^PRCF(423.6,RDA,1,10000,0)),"^",4) I STATION="" S OUT=3 D EVAL Q
"RTN","PRCSREC",19,0)
 I '$D(^PRC(420,STATION)) S OUT=3 D EVAL Q
"RTN","PRCSREC",20,0)
 S LINE=10000 F  S LINE=$O(^PRCF(423.6,RDA,1,LINE)) Q:'LINE  D PROCESS
"RTN","PRCSREC",21,0)
 D KILL^PRCOSRV3(PRCDA)
"RTN","PRCSREC",22,0)
 QUIT
"RTN","PRCSREC",23,0)
PROCESS ;  check each transmission line sent
"RTN","PRCSREC",24,0)
 Q:$P($G(^PRCF(423.6,RDA,1,LINE,0)),"^")["{"
"RTN","PRCSREC",25,0)
 S STRING=^PRCF(423.6,RDA,1,LINE,0)
"RTN","PRCSREC",26,0)
 ;    5,7 can a unique transmission record be determined
"RTN","PRCSREC",27,0)
 S (PONUM,PONUM1)=$P(STRING,"^",18) I PONUM="" S OUT=5 D EVAL Q
"RTN","PRCSREC",28,0)
 S LNN=$P(STRING,"^",19),TDATE=$P(STRING,"^",22) I TDATE="" S OUT=5 D EVAL Q
"RTN","PRCSREC",29,0)
 S TRANCODE=$P(STRING,"^",17) I TRANCODE="" S OUT=7 D EVAL Q
"RTN","PRCSREC",30,0)
 ;    8  is there a fiscal year/quarter
"RTN","PRCSREC",31,0)
 S STATION=$P(STRING,"^",8),FY=$P(STRING,"^",4),QUARTER=$P(STRING,"^",5),AMT=$P(STRING,"^",20)
"RTN","PRCSREC",32,0)
 I (FY="")!(QUARTER="") S OUT=8 D EVAL Q
"RTN","PRCSREC",33,0)
 I (QUARTER'?1N)!(QUARTER>5) S OUT=8 D EVAL Q
"RTN","PRCSREC",34,0)
 S ENDFY=$P(STRING,"^",3),BEGFY=$P(STRING,"^",2)
"RTN","PRCSREC",35,0)
 S TRANSNUM=TRANCODE_"-"_PONUM_"-"_TDATE_"-"_+LNN_"-"_QUARTER
"RTN","PRCSREC",36,0)
FCPCHEC ;
"RTN","PRCSREC",37,0)
 ;    if there is a PO number, get CP from 442 record
"RTN","PRCSREC",38,0)
 S $P(STRING,"^",9)=$P(STRING,"^",21)
"RTN","PRCSREC",39,0)
 S PODA=0,(FCP,FILE)="" S PONUM=$E(PONUM,4,9),PONUM=STATION_"-"_PONUM
"RTN","PRCSREC",40,0)
 ;    if it is not an employee payroll transaction ok to search file 442
"RTN","PRCSREC",41,0)
 I TRANCODE'="PR" D  I $D(^PRC(420,STATION,1,+FCP,4,FY)) D CONTINU Q
"RTN","PRCSREC",42,0)
 .S:$D(^PRC(442,"B",PONUM)) PODA=$O(^PRC(442,"B",PONUM,0))
"RTN","PRCSREC",43,0)
 .I +PODA'=0 S FCP=$P($G(^PRC(442,PODA,0)),"^",3),FCP=+$P(FCP," ")
"RTN","PRCSREC",44,0)
 .Q
"RTN","PRCSREC",45,0)
 ;    if no PO match is found, use required fields table
"RTN","PRCSREC",46,0)
 S ARRAY("BFY")=+$$YEAR^PRC0C($P(STRING,"^",2))
"RTN","PRCSREC",47,0)
 S FILE=417.1
"RTN","PRCSREC",48,0)
 S ARRAY("FUND")=$P(STRING,"^",6),ARRAY("AO")=$P(STRING,"^",7),ARRAY("FCPRJ")=$P(STRING,"^",10)
"RTN","PRCSREC",49,0)
 S ARRAY("PGM")=$P(STRING,"^",21),ARRAY("OC")=$P(STRING,"^",16),ARRAY("JOB")=$P(STRING,"^",14),ARRAY("SITE")=STATION
"RTN","PRCSREC",50,0)
 ;
"RTN","PRCSREC",51,0)
 S A="" D FINDCP I A="" S FCP="000" S STATUS="N" D SET Q
"RTN","PRCSREC",52,0)
 ;
"RTN","PRCSREC",53,0)
 S B=$$FIRST^PRC0B1("^PRCD(420.141,""B"","""_A_""",",0)
"RTN","PRCSREC",54,0)
 I 'B S FCP="000" S STATUS="N" D SET Q
"RTN","PRCSREC",55,0)
 S FCP=+$P(^PRCD(420.141,B,0),"^",2)
"RTN","PRCSREC",56,0)
 I +FCP=0 S FCP="000" S STATUS="N" D SET Q
"RTN","PRCSREC",57,0)
 I '$D(^PRC(420,STATION,1,+FCP)) S FCP="000",STATUS="N" D SET Q
"RTN","PRCSREC",58,0)
CONTINU ;    set control point balance on file 420
"RTN","PRCSREC",59,0)
 S FILE=417,TRANSNUM=TRANSNUM_"-"_FCP
"RTN","PRCSREC",60,0)
 S CHECK=TRANSNUM I $D(^PRCS(417,"B",CHECK)) S FILE=417.1 D SET Q
"RTN","PRCSREC",61,0)
 S STATUS="P" D SET S AA=STATION_"^"_+FCP_"^"_FY_"^"_QUARTER_"^"_AMT
"RTN","PRCSREC",62,0)
 I TRANCODE'="CC",$E(PONUM1,4,7)'?4A D EBAL^PRCSEZ(AA,"C")
"RTN","PRCSREC",63,0)
 D EBAL^PRCSEZ(AA,"O")
"RTN","PRCSREC",64,0)
 S INFORM=$P($T(MESSAGE+9),";;",2)
"RTN","PRCSREC",65,0)
 I STATUS="P" D ^PRCSREC1 K INFORM QUIT
"RTN","PRCSREC",66,0)
EVAL I OUT'=0 S ERROR=$P($T(MESSAGE+OUT),";;",2) D ^PRCSREC1
"RTN","PRCSREC",67,0)
 S OUT=0 K ERROR QUIT
"RTN","PRCSREC",68,0)
SET ;  set data on file 417 with status of "P" (posted), "D" (duplicate), "N" (no CP)
"RTN","PRCSREC",69,0)
 S X=TRANSNUM,DIC="^PRCS("_FILE_",",DIC(0)="LZ",DLAYGO=FILE D FILE^DICN Q:Y=-1  S FMSDA=+Y K DLAYGO
"RTN","PRCSREC",70,0)
 L +^PRCS(FILE,FMSDA):5 Q:'$T  F K=2,3,5:1:20 S $P(^PRCS(FILE,FMSDA,0),"^",K)=$P(STRING,"^",K)
"RTN","PRCSREC",71,0)
 S K=$P(STRING,"^",4),DIE=DIC,DA=FMSDA,DR="3////^S X=K" D ^DIE
"RTN","PRCSREC",72,0)
 S X=TDATE,X=$E(X,3,4)_"/"_$E(X,5,6)_"/"_$E(X,1,2) K %DT D ^%DT
"RTN","PRCSREC",73,0)
 S $P(^PRCS(FILE,FMSDA,0),"^",22)=Y
"RTN","PRCSREC",74,0)
 I FILE=417 S DIE=DIC,DA=FMSDA,DR="51///^S X=STATUS"_";"_"22///^S X=1" D ^DIE
"RTN","PRCSREC",75,0)
 S COUNTER=STATION_"-"_FY_"-"_QUARTER_"-"_FCP,$P(^PRCS(FILE,FMSDA,0),"^",21)=COUNTER
"RTN","PRCSREC",76,0)
 S ^PRCS(FILE,"C",COUNTER,FMSDA)=""
"RTN","PRCSREC",77,0)
 L -^PRCS(FILE,FMSDA)
"RTN","PRCSREC",78,0)
 K ARRAY,DA,DIC,DIE,DR QUIT
"RTN","PRCSREC",79,0)
FINDCP ;
"RTN","PRCSREC",80,0)
 S FUNDCODE=+$$FUND^PRC0C(ARRAY("FUND"),ARRAY("BFY")) Q:FUNDCODE=0
"RTN","PRCSREC",81,0)
 D DOCREQ^PRC0C(FUNDCODE,"AB","AB"),DOCREQ^PRC0C(FUNDCODE,"SAB","SAB")
"RTN","PRCSREC",82,0)
 F A="SPE","REV","GL" I $$REQ^PRC0C(FUNDCODE,A,"JOB")="Y" S SAB("JOB")="Y"
"RTN","PRCSREC",83,0)
 S EE="~",A=ARRAY("SITE")_EE_ARRAY("BFY")_EE_ARRAY("FUND")
"RTN","PRCSREC",84,0)
 F I="AO","PGM","FCPRJ","OC","JOB" D
"RTN","PRCSREC",85,0)
 .I $G(AB(I))="Y"!($G(SAB(I))="Y") S PIECE=ARRAY(I)
"RTN","PRCSREC",86,0)
 .E  S PIECE=""
"RTN","PRCSREC",87,0)
 .S A=A_EE_PIECE
"RTN","PRCSREC",88,0)
 K AB,EE,I,PIECE,FIELD,FUNDCODE,SAB Q
"RTN","PRCSREC",89,0)
MESSAGE ;
"RTN","PRCSREC",90,0)
 ;;IFCAP transmission code is incorrect
"RTN","PRCSREC",91,0)
 ;;Transmission type is not correct for 820 processing
"RTN","PRCSREC",92,0)
 ;;Site reference is incorrect
"RTN","PRCSREC",93,0)
 ;;
"RTN","PRCSREC",94,0)
 ;;No FMS message transmission number sent in this transaction
"RTN","PRCSREC",95,0)
 ;;Duplicate message transmission number sent in transaction
"RTN","PRCSREC",96,0)
 ;;No FMS transaction code was sent for this transaction
"RTN","PRCSREC",97,0)
 ;;Invalid fiscal year or quarter sent in this transaction
"RTN","PRCSREC",98,0)
 ;;Your control point balances have been adjusted by the amount above
"VER")
8.0^22.0
"BLD",4942,6)
^85
**END**
**END**
