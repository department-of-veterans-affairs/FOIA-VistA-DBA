Released RG*1*4 SEQ #4
Extracted from mail message
**KIDS**:RG*1.0*4^

**INSTALL NAME**
RG*1.0*4
"BLD",784,0)
RG*1.0*4^CLINICAL INFO RESOURCE NETWORK^0^3000706^y
"BLD",784,1,0)
^^3^3^3000706^
"BLD",784,1,1,0)
CPRS REMOTE DATA VIEWS
"BLD",784,1,2,0)
Refer to patch RG*1*4 in the FORUM Patch Module for a complete
"BLD",784,1,3,0)
description.
"BLD",784,4,0)
^9.64PA^991.8^1
"BLD",784,4,991.8,0)
991.8
"BLD",784,4,991.8,2,0)
^9.641^991.8^1
"BLD",784,4,991.8,2,991.8,0)
CIRN SITE PARAMETER  (File-top level)
"BLD",784,4,991.8,2,991.8,1,0)
^9.6411^12^1
"BLD",784,4,991.8,2,991.8,1,12,0)
MPI/PD SEEDING COMP DATE/TIME
"BLD",784,4,991.8,222)
y^y^p^^^^n
"BLD",784,4,"APDD",991.8,991.8)

"BLD",784,4,"APDD",991.8,991.8,12)

"BLD",784,4,"B",991.8,991.8)

"BLD",784,"ABNS",0)
^9.66A^1^1
"BLD",784,"ABNS",1,0)
RG
"BLD",784,"ABNS",1,1,0)
^9.661A^^
"BLD",784,"ABNS","B","RG",1)

"BLD",784,"ABPKG")
^y^
"BLD",784,"INIT")
RG4POST
"BLD",784,"KRN",0)
^9.67PA^19^18
"BLD",784,"KRN",.4,0)
.4
"BLD",784,"KRN",.401,0)
.401
"BLD",784,"KRN",.402,0)
.402
"BLD",784,"KRN",.403,0)
.403
"BLD",784,"KRN",.5,0)
.5
"BLD",784,"KRN",.84,0)
.84
"BLD",784,"KRN",3.6,0)
3.6
"BLD",784,"KRN",3.8,0)
3.8
"BLD",784,"KRN",9.2,0)
9.2
"BLD",784,"KRN",9.8,0)
9.8
"BLD",784,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",784,"KRN",9.8,"NM",1,0)
RGADT^^0^B9955223
"BLD",784,"KRN",9.8,"NM",2,0)
RGADT1^^0^B15274870
"BLD",784,"KRN",9.8,"NM",3,0)
RGADT2^^0^B22463508
"BLD",784,"KRN",9.8,"NM",4,0)
RG4POST^^0^B11559387
"BLD",784,"KRN",9.8,"NM",5,0)
RGRSMSH^^0^B1617290
"BLD",784,"KRN",9.8,"NM",6,0)
RGRSDYN^^0^B7362449
"BLD",784,"KRN",9.8,"NM","B","RG4POST",4)

"BLD",784,"KRN",9.8,"NM","B","RGADT",1)

"BLD",784,"KRN",9.8,"NM","B","RGADT1",2)

"BLD",784,"KRN",9.8,"NM","B","RGADT2",3)

"BLD",784,"KRN",9.8,"NM","B","RGRSDYN",6)

"BLD",784,"KRN",9.8,"NM","B","RGRSMSH",5)

"BLD",784,"KRN",19,0)
19
"BLD",784,"KRN",19.1,0)
19.1
"BLD",784,"KRN",101,0)
101
"BLD",784,"KRN",101,"NM",0)
^9.68A^6^5
"BLD",784,"KRN",101,"NM",1,0)
RG ADT ENCOUNTER DRIVER^^0
"BLD",784,"KRN",101,"NM",3,0)
RG ADT-A01 CLIENT^^0
"BLD",784,"KRN",101,"NM",4,0)
RG ADT-A01 SERVER^^0
"BLD",784,"KRN",101,"NM",5,0)
RG ADT-A03 CLIENT^^0
"BLD",784,"KRN",101,"NM",6,0)
RG ADT-A03 SERVER^^0
"BLD",784,"KRN",101,"NM","B","RG ADT ENCOUNTER DRIVER",1)

"BLD",784,"KRN",101,"NM","B","RG ADT-A01 CLIENT",3)

"BLD",784,"KRN",101,"NM","B","RG ADT-A01 SERVER",4)

"BLD",784,"KRN",101,"NM","B","RG ADT-A03 CLIENT",5)

"BLD",784,"KRN",101,"NM","B","RG ADT-A03 SERVER",6)

"BLD",784,"KRN",409.61,0)
409.61
"BLD",784,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",784,"KRN",771,0)
771
"BLD",784,"KRN",771,"NM",0)
^9.68A^1^1
"BLD",784,"KRN",771,"NM",1,0)
RG CIRN ADT^^0
"BLD",784,"KRN",771,"NM","B","RG CIRN ADT",1)

"BLD",784,"KRN",869.2,0)
869.2
"BLD",784,"KRN",869.2,"NM",0)
^9.68A^^
"BLD",784,"KRN",870,0)
870
"BLD",784,"KRN",8994,0)
8994
"BLD",784,"KRN","B",.4,.4)

"BLD",784,"KRN","B",.401,.401)

"BLD",784,"KRN","B",.402,.402)

"BLD",784,"KRN","B",.403,.403)

"BLD",784,"KRN","B",.5,.5)

"BLD",784,"KRN","B",.84,.84)

"BLD",784,"KRN","B",3.6,3.6)

"BLD",784,"KRN","B",3.8,3.8)

"BLD",784,"KRN","B",9.2,9.2)

"BLD",784,"KRN","B",9.8,9.8)

"BLD",784,"KRN","B",19,19)

"BLD",784,"KRN","B",19.1,19.1)

"BLD",784,"KRN","B",101,101)

"BLD",784,"KRN","B",409.61,409.61)

"BLD",784,"KRN","B",771,771)

"BLD",784,"KRN","B",869.2,869.2)

"BLD",784,"KRN","B",870,870)

"BLD",784,"KRN","B",8994,8994)

"BLD",784,"QUES",0)
^9.62^^
"BLD",784,"REQB",0)
^9.611^5^5
"BLD",784,"REQB",1,0)
DG*5.3*261^2
"BLD",784,"REQB",2,0)
MPIF*1.0*1^2
"BLD",784,"REQB",3,0)
HL*1.6*58^2
"BLD",784,"REQB",4,0)
RG*1.0*3^2
"BLD",784,"REQB",5,0)
XU*8.0*131^2
"BLD",784,"REQB","B","DG*5.3*261",1)

"BLD",784,"REQB","B","HL*1.6*58",3)

"BLD",784,"REQB","B","MPIF*1.0*1",2)

"BLD",784,"REQB","B","RG*1.0*3",4)

"BLD",784,"REQB","B","XU*8.0*131",5)

"FIA",991.8)
CIRN SITE PARAMETER
"FIA",991.8,0)
^RGSITE(991.8,
"FIA",991.8,0,0)
991.8
"FIA",991.8,0,1)
y^y^p^^^^n
"FIA",991.8,0,10)

"FIA",991.8,0,11)

"FIA",991.8,0,"RLRO")

"FIA",991.8,0,"VR")
1.0^RG
"FIA",991.8,991.8)
1
"FIA",991.8,991.8,12)

"INIT")
RG4POST
"KRN",101,1597,-1)
0^3
"KRN",101,1597,0)
RG ADT-A01 CLIENT^CIRN'S ADT-A01 Client Protocol^^S^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",101,1597,1,0)
^^4^4^2991203^^^
"KRN",101,1597,1,1,0)
This client protocol processes Admission, Discharge, and Transfer (ADT)
"KRN",101,1597,1,2,0)
update patient information (event code A01) Health Level Seven (HL7)
"KRN",101,1597,1,3,0)
messages.  This protocol also re-routes the messages to the CIRN Master
"KRN",101,1597,1,4,0)
of Record (CMOR) and from the CMOR to all other subscribers.  
"KRN",101,1597,20)

"KRN",101,1597,99)
58035,46337
"KRN",101,1597,770)
^RG CIRN ADT^^A01^^^^^^2.3^ACK
"KRN",101,1597,771)
D EN^RGADT
"KRN",101,1597,773)
1^1
"KRN",101,1597,774)
D DYNROU^RGADT("A01")
"KRN",101,1598,-1)
0^5
"KRN",101,1598,0)
RG ADT-A03 CLIENT^CIRN'S ADT-A03 Client Protocol^^S^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",101,1598,1,0)
^^4^4^2991123^^
"KRN",101,1598,1,1,0)
This client protocol processes Admission, Discharge, and Transfer (ADT)
"KRN",101,1598,1,2,0)
update patient information (event code A03) Health Level Seven (HL7)
"KRN",101,1598,1,3,0)
messages.  This protocol also re-routes the messages to the CIRN Master
"KRN",101,1598,1,4,0)
of Record (CMOR) and from the CMOR to all other subscribers.
"KRN",101,1598,99)
58035,46602
"KRN",101,1598,770)
^RG CIRN ADT^^A03^^^^^^2.3^ACK
"KRN",101,1598,771)
D EN^RGADT
"KRN",101,1598,773)
1^1
"KRN",101,1598,774)
D DYNROU^RGADT("A03")
"KRN",101,1601,-1)
0^1
"KRN",101,1601,0)
RG ADT ENCOUNTER DRIVER^CIRN ADT Data Capture^^X^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",101,1601,1,0)
^^6^6^3000314^^^^
"KRN",101,1601,1,1,0)
The addition of the RG ADT ENCOUNTER DRIVER protocol will allow tracking
"KRN",101,1601,1,2,0)
of patient admissions and discharges on the Registration (PIMS) side,
"KRN",101,1601,1,3,0)
as well as clinic checkouts on the Scheduling (PIMS) side.  This protocol
"KRN",101,1601,1,4,0)
builds HL7 messages that update the TREATING FACILITY LIST (#391.91) file,
"KRN",101,1601,1,5,0)
tracking the DATE LAST TREATED (#.03) and ADT/HL7 EVENT REASON (#.07)
"KRN",101,1601,1,6,0)
fields for a particular patient at a given facility.
"KRN",101,1601,20)
D EN^RGADT1
"KRN",101,1601,99)
57960,50477
"KRN",101,1602,-1)
0^4
"KRN",101,1602,0)
RG ADT-A01 SERVER^CIRN's ADT-A01 Server Protocol^^E^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",101,1602,1,0)
^^6^6^2991112^
"KRN",101,1602,1,1,0)
This protocol is triggered whenever a patient is admitted through the
"KRN",101,1602,1,2,0)
Registration (PIMS) module. It executes code that creates an HL7 ADT
"KRN",101,1602,1,3,0)
message consisting of PID, EVN, PD1, and PV1 segments.  The message
"KRN",101,1602,1,4,0)
contains all relevant information about the event, including patient
"KRN",101,1602,1,5,0)
name, event date/time, patient primary facility and patient class
"KRN",101,1602,1,6,0)
(inpatient or outpatient).
"KRN",101,1602,99)
58016,31957
"KRN",101,1602,770)
RG CIRN ADT^^ADT^A01^^^^AL^AL^2.3^
"KRN",101,1602,775,0)
^101.0775PA^1^1
"KRN",101,1602,775,1,0)
1597
"KRN",101,1602,775,1,"^")
RG ADT-A01 CLIENT
"KRN",101,1603,-1)
0^6
"KRN",101,1603,0)
RG ADT-A03 SERVER^CIRN's ADT-A03 Server Protocol^^E^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",101,1603,1,0)
^^7^7^3000207^
"KRN",101,1603,1,1,0)
This protocol is triggered whenever a patient is discharged through the
"KRN",101,1603,1,2,0)
Registration (PIMS) module, or checked out of a clinic through the
"KRN",101,1603,1,3,0)
Scheduling (PIMS) module. It executes code that creates an HL7 ADT message
"KRN",101,1603,1,4,0)
consisting of PID, EVN, PD1, and PV1 segments.  The message contains all
"KRN",101,1603,1,5,0)
relevant information about the event, including patient name, event
"KRN",101,1603,1,6,0)
date/time, patient primary facility and patient class (inpatient or
"KRN",101,1603,1,7,0)
outpatient).
"KRN",101,1603,99)
58016,31971
"KRN",101,1603,770)
RG CIRN ADT^^ADT^A03^^^^AL^AL^2.3^
"KRN",101,1603,775,0)
^101.0775PA^1^1
"KRN",101,1603,775,1,0)
1598
"KRN",101,1603,775,1,"^")
RG ADT-A03 CLIENT
"KRN",771,51,-1)
0^1
"KRN",771,51,0)
RG CIRN ADT^a^^^^^US
"MBREQ")
0
"ORD",14,771)
771;14;;;HLAP^XPDTA1;HLAPF1^XPDIA1;HLAPE1^XPDIA1;HLAPF2^XPDIA1;;
"ORD",14,771,0)
HL7 APPLICATION PARAMETER
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^^0
"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
4^3000706
"PKG",272,22,1,"PAH",1,1,0)
^^3^3^3000706
"PKG",272,22,1,"PAH",1,1,1,0)
CPRS REMOTE DATA VIEWS
"PKG",272,22,1,"PAH",1,1,2,0)
Refer to patch RG*1*4 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","RG4POST")
0^4^B11559387
"RTN","RG4POST",1,0)
RG4POST ;HIRMFO/GJC-POST-INIT DRIVER ;11/10/99
"RTN","RG4POST",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4**;30 Apr 99
"RTN","RG4POST",3,0)
 ;
"RTN","RG4POST",4,0)
 N RGCHK
"RTN","RG4POST",5,0)
 S RGCHK=$$NEWCP^XPDUTL("POST1","EN1^RG4POST")
"RTN","RG4POST",6,0)
 ;         Add RG ADT ENCOUNTER DRIVER (extended action protocol)
"RTN","RG4POST",7,0)
 ;         as an Item under DGPM MOVEMENT EVENTS & SDAM APPOINTMENT
"RTN","RG4POST",8,0)
 ;         EVENTS.
"RTN","RG4POST",9,0)
 ;
"RTN","RG4POST",10,0)
 S RGCHK=$$NEWCP^XPDUTL("POST2","EN2^RG4POST")
"RTN","RG4POST",11,0)
 ;         Task off the process (RGADT2) that seeds (adds data to
"RTN","RG4POST",12,0)
 ;         a null field) the DATE LAST TREATED (#.03) field and the
"RTN","RG4POST",13,0)
 ;         ADT/HL7 EVENT REASON (#.07) field in the TREATING FACILITY
"RTN","RG4POST",14,0)
 ;         LIST (#391.91) file.  Broadcasts MFU HL7 messages with the
"RTN","RG4POST",15,0)
 ;         data mentioned above (VAFCTFMF).
"RTN","RG4POST",16,0)
 ;
"RTN","RG4POST",17,0)
 S RGCHK=$$NEWCP^XPDUTL("POST4","EN4^RG4POST")
"RTN","RG4POST",18,0)
 ;         Add RG CIRN ADT to the HL7 APPLICATION PARAMETER (#.02)
"RTN","RG4POST",19,0)
 ;         field for all the entries in the ADT/HL7 EVENT REASON
"RTN","RG4POST",20,0)
 ;         (#391.72) file.
"RTN","RG4POST",21,0)
 ;
"RTN","RG4POST",22,0)
 QUIT
"RTN","RG4POST",23,0)
 ;
"RTN","RG4POST",24,0)
EN1 ; Add RG ADT ENCOUNTER DRIVER (extended action protocol) as
"RTN","RG4POST",25,0)
 ; an Item under DGPM MOVEMENT EVENTS & SDAM APPOINTMENT EVENTS
"RTN","RG4POST",26,0)
 K RGFDA,RGMSG N X0,X1,X2,Y0,Y1,Y2
"RTN","RG4POST",27,0)
 ; CIRN stuff
"RTN","RG4POST",28,0)
 S Y0="RG ADT ENCOUNTER DRIVER",X0=+$$FIND1^DIC(101,"","QX",Y0)
"RTN","RG4POST",29,0)
 I X0=0 D ERRMSG(Y0) Q
"RTN","RG4POST",30,0)
 ; PIMS stuff: SDAM APPOINTMENT EVENTS
"RTN","RG4POST",31,0)
 S Y1="SDAM APPOINTMENT EVENTS",X1=+$$FIND1^DIC(101,"","QX",Y1)
"RTN","RG4POST",32,0)
 I X1=0 D ERRMSG(Y1) Q
"RTN","RG4POST",33,0)
 ; DGPM MOVEMENT EVENTS
"RTN","RG4POST",34,0)
 S Y2="DGPM MOVEMENT EVENTS",X2=+$$FIND1^DIC(101,"","QX",Y2)
"RTN","RG4POST",35,0)
 I X2=0 D ERRMSG(Y2) Q
"RTN","RG4POST",36,0)
 ;
"RTN","RG4POST",37,0)
 ; add RG ADT ENCOUNTER DRIVER as an item under SDAM APPOINTMENT EVENTS
"RTN","RG4POST",38,0)
 S RGFDA(101.01,"+1,"_X1_",",.01)=Y0
"RTN","RG4POST",39,0)
 D:'$D(^ORD(101,X1,10,"B",X0)) UPDATE^DIE("E","RGFDA")
"RTN","RG4POST",40,0)
 I '$D(^ORD(101,X1,10,"B",X0)) D  ; issue error message
"RTN","RG4POST",41,0)
 . K RGMSG S RGMSG(1)=" ",RGMSG(2)="Error adding "_Y0_" as an"
"RTN","RG4POST",42,0)
 . S RGMSG(3)="item under "_Y1 D MES^XPDUTL(.RGMSG)
"RTN","RG4POST",43,0)
 . Q
"RTN","RG4POST",44,0)
 ; add RG ADT ENCOUNTER DRIVER as an item under DGPM MOVEMENT EVENTS
"RTN","RG4POST",45,0)
 S RGFDA(101.01,"+1,"_X2_",",.01)=Y0
"RTN","RG4POST",46,0)
 D:'$D(^ORD(101,X2,10,"B",X0)) UPDATE^DIE("E","RGFDA")
"RTN","RG4POST",47,0)
 I '$D(^ORD(101,X2,10,"B",X0)) D  ; issue error message
"RTN","RG4POST",48,0)
 . K RGMSG S RGMSG(1)=" ",RGMSG(2)="Error adding "_Y0_" as an"
"RTN","RG4POST",49,0)
 . S RGMSG(3)="item under "_Y2 D MES^XPDUTL(.RGMSG)
"RTN","RG4POST",50,0)
 . Q
"RTN","RG4POST",51,0)
 K RGFDA,RGMSG
"RTN","RG4POST",52,0)
 QUIT
"RTN","RG4POST",53,0)
 ;
"RTN","RG4POST",54,0)
EN2 ; Task off the process (RGADT2) that seeds (adds data to a null
"RTN","RG4POST",55,0)
 ; field) the DATE LAST TREATED (#.03) field in the TREATING FACILITY
"RTN","RG4POST",56,0)
 ; LIST (#391.91) file.  Admission and discharge dates are checked on
"RTN","RG4POST",57,0)
 ; the registration side (IN5^VADPT), and a status of 'check out' is
"RTN","RG4POST",58,0)
 ; what our software is looking for in the OUTPATIENT ENCOUNTER
"RTN","RG4POST",59,0)
 ; (#409.68) file.
"RTN","RG4POST",60,0)
 ;
"RTN","RG4POST",61,0)
 Q:'$D(^DPT("AICN"))  ; if MPI has not been loaded, quit
"RTN","RG4POST",62,0)
 Q:$P($G(^RGSITE(991.8,1,1)),"^",2)  ; seeding process ran in the past
"RTN","RG4POST",63,0)
 K RGMSG N ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","RG4POST",64,0)
 S ZTIO="",ZTRTN="EN^RGADT2",ZTDESC="CIRN-CPRS: seed DATE LAST TREATED field (TREATING FACILITY LIST #391.91)"
"RTN","RG4POST",65,0)
 S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT(),0,0,1,0) ; in future, one minute
"RTN","RG4POST",66,0)
 S:$D(XPDNM) ZTSAVE("XPD*")=""
"RTN","RG4POST",67,0)
 S:$D(RGDUZ) ZTSAVE("RGDUZ")=""
"RTN","RG4POST",68,0)
 D ^%ZTLOAD
"RTN","RG4POST",69,0)
 S RGMSG(1)=" ",RGMSG(2)="CIRN-CPRS: DATE LAST TREATED field seeding for the TREATING FACILITY"
"RTN","RG4POST",70,0)
 S RGMSG(3)="LIST (#391.91) file is running in background."
"RTN","RG4POST",71,0)
 S:$G(ZTSK)>0 RGMSG(4)="Task: "_ZTSK_"." D MES^XPDUTL(.RGMSG)
"RTN","RG4POST",72,0)
 K RGMSG,RGDUZ
"RTN","RG4POST",73,0)
 QUIT
"RTN","RG4POST",74,0)
 ;
"RTN","RG4POST",75,0)
EN4 ; Add RG CIRN ADT to the HL7 APPLICATION PARAMETER (#.02)
"RTN","RG4POST",76,0)
 ; field for all the entries in the ADT/HL7 EVENT REASON
"RTN","RG4POST",77,0)
 ; (#391.72) file.
"RTN","RG4POST",78,0)
 N RG771 S RG771=+$$FIND1^DIC(771,"","X","RG CIRN ADT")
"RTN","RG4POST",79,0)
 Q:'RG771  N DA,RGFDA ; quit if RG CIRN ADT cannot be found
"RTN","RG4POST",80,0)
 S DA=0 F  S DA=$O(^VAT(391.72,DA)) Q:'DA  D
"RTN","RG4POST",81,0)
 .S RGFDA(391.72,DA_",",.02)=RG771
"RTN","RG4POST",82,0)
 .D FILE^DIE("K","RGFDA") K RGFDA
"RTN","RG4POST",83,0)
 Q
"RTN","RG4POST",84,0)
 ;
"RTN","RG4POST",85,0)
ERRMSG(X) ; display an error message about missing protocols
"RTN","RG4POST",86,0)
 ; input: the name of the protocol missing
"RTN","RG4POST",87,0)
 K RGMSG S RGMSG(1)=" ",RGMSG(2)=X_" protocol is missing"
"RTN","RG4POST",88,0)
 S RGMSG(3)="from the host system.  Contact your "_$S($E(X,1,2)="RG":"CIRN",1:"PIMS")_" ADPAC."
"RTN","RG4POST",89,0)
 D MES^XPDUTL(.RGMSG)
"RTN","RG4POST",90,0)
 Q
"RTN","RGADT")
0^1^B9955223
"RTN","RGADT",1,0)
RGADT ;HIRMFO/GJC-ADT MESSAGE PROCESSING/ROUTING ;09/21/99
"RTN","RGADT",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4**;30 Apr 99
"RTN","RGADT",3,0)
 Q  ; quit if called from the top
"RTN","RGADT",4,0)
 ;
"RTN","RGADT",5,0)
EN ;entry point to process local ADT messages.
"RTN","RGADT",6,0)
 ;
"RTN","RGADT",7,0)
 ;This is call by the following clients:
"RTN","RGADT",8,0)
 ; RG ADT-A01 CLIENT & RG ADT-A03 CLIENT (Generate/Process
"RTN","RGADT",9,0)
 ; Routine(771) & Routing Logic(774) field definitions
"RTN","RGADT",10,0)
 ;
"RTN","RGADT",11,0)
 K RGDC,RGDCDFN,RGDCERR,RGDCEVN,RGDCEVN1,RGDCPID,RGDCSFN,RGDCV
"RTN","RGADT",12,0)
 S U="^" D INITIZE^RGRSUTIL ; copy HL7 message into local RGDC array
"RTN","RGADT",13,0)
 S RGDCV=$$EN^RGRSMSH() ;return: dt rec'd^event dt^sending fac.(xternal)
"RTN","RGADT",14,0)
 ; note: the above dates are in FileMan internal format
"RTN","RGADT",15,0)
 S RGDCPID=$$SEG1^RGRSUTIL("PID",1,"PID")
"RTN","RGADT",16,0)
 S RGDCSFN=$$LKUP^XUAF4($P(RGDCV,U,3)) ; need Treating Facility ien
"RTN","RGADT",17,0)
 S RGDCEVN=$P($$SEG1^RGRSUTIL("EVN",1,"EVN"),U,5) ; event reason code
"RTN","RGADT",18,0)
 S RGDCEVN=$$FIND1^DIC(391.72,"","AXM",RGDCEVN) ; event reason(internal)
"RTN","RGADT",19,0)
 S RGDCEVN1=$P($$SEG1^RGRSUTIL("EVN",1,"EVN"),U,2) ; event type
"RTN","RGADT",20,0)
 S RGDCDFN=$$GETDFN^MPIF001(+$P(RGDCPID,HL("FS"),3))
"RTN","RGADT",21,0)
 ; Note: $P(RGDCPID,HL("FS"),3) is: ICN_"V"_ICN checksum
"RTN","RGADT",22,0)
 S RGDCERR=$$ERR()
"RTN","RGADT",23,0)
 ;
"RTN","RGADT",24,0)
 ; input variables to FILE^VAFCTFU
"RTN","RGADT",25,0)
 ; RGDCDFN - patient ien ; RGDCSFN - treating facility
"RTN","RGADT",26,0)
 ; $P(RGDCV,U,2) - date last treated ; RGDCEVN - event reason
"RTN","RGADT",27,0)
 D:RGDCERR']"" FILE^VAFCTFU(RGDCDFN,RGDCSFN_U_$P(RGDCV,U,2)_U_RGDCEVN,1)
"RTN","RGADT",28,0)
 ; call to the TFL utility routine VAFCTFU.  Centrally located code
"RTN","RGADT",29,0)
 ; to add or edit to the TFL file.
"RTN","RGADT",30,0)
 ;
"RTN","RGADT",31,0)
 D GENACK ; generate the 'ack' message
"RTN","RGADT",32,0)
KILL ; kill and exit
"RTN","RGADT",33,0)
 K HLINKP,HLINKX,HLL,RGDC,RGDCDFN,RGDCERR,RGDCEVN,RGDCEVN1,RGDCPID,RGDCSFN,RGDCV
"RTN","RGADT",34,0)
 Q
"RTN","RGADT",35,0)
ERR() ; return the error string (if applicable)
"RTN","RGADT",36,0)
 S:$$FIND1^DIC(391.72,"","AXM",RGDCEVN)="" RGDCERR="could not resolve ADT/HL7 EVENT REASON file pointer"
"RTN","RGADT",37,0)
 S:$$GET1^DIQ(2,RGDCDFN,.01)="" RGDCERR="could not resolve PATIENT file pointer"
"RTN","RGADT",38,0)
 S:$$GET1^DIQ(4,RGDCSFN,.01)="" RGDCERR="could not resolve INSTITUTION file pointer"
"RTN","RGADT",39,0)
 D DT^DILF("EXT",$P(RGDCV,"^",2),.RGDCERR)
"RTN","RGADT",40,0)
 S:RGDCERR=-1 RGDCERR="invalid DATE LAST TREATED date/time value"
"RTN","RGADT",41,0)
 S:RGDCERR'=-1 RGDCERR="" ; no date/time error
"RTN","RGADT",42,0)
 Q $G(RGDCERR)
"RTN","RGADT",43,0)
 ;
"RTN","RGADT",44,0)
DYNROU(RGDCEVT) ; dynamic message routing, but first need to update the
"RTN","RGADT",45,0)
 ; TREATING FACILITY LIST (TFL-391.91) file at the local site
"RTN","RGADT",46,0)
 ; input-{RGDCEVT=event type
"RTN","RGADT",47,0)
 K RGDCEDT,RGDCEVTR,RGDCSITE
"RTN","RGADT",48,0)
 S RGDCSITE=$$KSP^XUPARAM("INST"),U="^"
"RTN","RGADT",49,0)
 S RGDCEDT=$$FMDATE^HLFNC($P($$EVN(),U,3)) ; determine event date/time
"RTN","RGADT",50,0)
 S RGDCEVTR=$$FIND1^DIC(391.72,"","AXM",$P($$EVN(),U,5)) ; event reason
"RTN","RGADT",51,0)
 ;
"RTN","RGADT",52,0)
 ; input variables to FILE^VAFCTFU
"RTN","RGADT",53,0)
 ; DFN - patient ien ; RGDCSITE - treating facility
"RTN","RGADT",54,0)
 ; RGDCEDT - date last treated ; RGDCEVTR - event reason
"RTN","RGADT",55,0)
 D FILE^VAFCTFU(DFN,RGDCSITE_U_RGDCEDT_U_RGDCEVTR,1)
"RTN","RGADT",56,0)
 ; call to the TFL utility routine VAFCTFU.  Centrally located code
"RTN","RGADT",57,0)
 ; to add or edit to the TFL file.
"RTN","RGADT",58,0)
 ;
"RTN","RGADT",59,0)
 ; route the message
"RTN","RGADT",60,0)
 D EN^RGRSDYN("RG ADT-"_RGDCEVT_" CLIENT",0)
"RTN","RGADT",61,0)
 K RGDCEDT,RGDCEVTR,RGDCSITE
"RTN","RGADT",62,0)
 Q
"RTN","RGADT",63,0)
EVN() ; pass back the EVN segment.
"RTN","RGADT",64,0)
 N I,X S I=0
"RTN","RGADT",65,0)
 F  S I=$O(HLA("HLS",I)) Q:I'>0  D  Q:$D(X)
"RTN","RGADT",66,0)
 . S:$P(HLA("HLS",I),U)="EVN" X=$G(HLA("HLS",I))
"RTN","RGADT",67,0)
 . Q
"RTN","RGADT",68,0)
 Q $G(X)
"RTN","RGADT",69,0)
GENACK ; Compile the 'ACK' segment, generate the 'ACK' message.
"RTN","RGADT",70,0)
 S HLA("HLA",1)="MSA"_HL("FS")_$S($G(RGDCERR)]"":"AE",1:"AA")_HL("FS")_HL("MID")_$S($G(RGDCERR)]"":HL("FS")_$G(RGDCERR),1:"")
"RTN","RGADT",71,0)
 S HLEID=HL("EID"),HLEIDS=HL("EIDS"),HLARYTYP="LM",HLFORMAT=1
"RTN","RGADT",72,0)
 D GENACK^HLMA1(HLEID,HLMTIENS,HLEIDS,HLARYTYP,HLFORMAT,.HLRESTLA)
"RTN","RGADT",73,0)
 Q
"RTN","RGADT1")
0^2^B15274870
"RTN","RGADT1",1,0)
RGADT1 ;HIRMFO/GJC-BUILD ADT MESSAGES (A01/A03) ;09/21/99
"RTN","RGADT1",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4**;30 Apr 99
"RTN","RGADT1",3,0)
 Q  ; quit if called from the top
"RTN","RGADT1",4,0)
 ;
"RTN","RGADT1",5,0)
EN ; entry point to build/transmit ADT messages
"RTN","RGADT1",6,0)
 ; Messages built by this software are fired off by server protocols:
"RTN","RGADT1",7,0)
 ; RG ADT-A01 SERVER -or- RG ADT-A03 SERVER
"RTN","RGADT1",8,0)
 ;
"RTN","RGADT1",9,0)
 ; This code is called from the RG ADT ENCOUNTER DRIVER protocol
"RTN","RGADT1",10,0)
 ; entry action field.  RG ADT ENCOUNTER DRIVER is an item protocol
"RTN","RGADT1",11,0)
 ; under the SDAM APPOINTMENTS EVENTS & DGPM MOVEMENT EVENTS event
"RTN","RGADT1",12,0)
 ; protocols.  RG ADT ENCOUNTER DRIVER hangs off of SDAM APPOINTMENTS
"RTN","RGADT1",13,0)
 ; EVENTS because of DBIA: 1320, & DGPM MOVEMENT EVENTS because of
"RTN","RGADT1",14,0)
 ; DBIA: 1181.
"RTN","RGADT1",15,0)
 ; 
"RTN","RGADT1",16,0)
 ;
"RTN","RGADT1",17,0)
 ; I DGPMP="" and DGPMA'="" it means we're adding a new ADMISSION,
"RTN","RGADT1",18,0)
 ; TRANSFER, DISCHARGE, or SPECIALTY TRANSFER to the Patient Movement
"RTN","RGADT1",19,0)
 ; File.  If RGTYPE=1 then we have an ADMISSION, if RGTYPE=3 then we
"RTN","RGADT1",20,0)
 ; have a DISCHARGE
"RTN","RGADT1",21,0)
 ;
"RTN","RGADT1",22,0)
 ; first check if HL7 2.3 messaging has been disabled.  DBIA: 2624
"RTN","RGADT1",23,0)
 I '$P($$SEND^VAFHUTL(),"^",2) Q
"RTN","RGADT1",24,0)
 Q:'$P($G(^DPT(DFN,"MPI")),"^")  ; IA 2070, must have a national icn
"RTN","RGADT1",25,0)
 Q:$$IFLOCAL^MPIF001(DFN)  ; IA 2701, patient has local icn, quit 
"RTN","RGADT1",26,0)
 I $D(DGPMA) D  ; is this an inpatient admission/discharge?
"RTN","RGADT1",27,0)
 . S RGOK=0
"RTN","RGADT1",28,0)
 . I ($G(DGPMP)'=""!($G(DGPMA)="")) Q
"RTN","RGADT1",29,0)
 . N %,VAERR,VAIP
"RTN","RGADT1",30,0)
 . S VAIP("D")="LAST" D IN5^VADPT ; dfn should be defined at this point
"RTN","RGADT1",31,0)
 . S RGTYPE=+VAIP(2),RGDATE=+VAIP(3),RGMOV=$G(VAIP(1))
"RTN","RGADT1",32,0)
 . ; if movement type is defined, so does the date/time of the movement
"RTN","RGADT1",33,0)
 . I ($G(RGTYPE)'=1&($G(RGTYPE)'=3)) Q
"RTN","RGADT1",34,0)
 . S RGOK=1,RGENVR=$S(RGTYPE=1:"A1",1:"A2") ; A1=admission, A2=discharge
"RTN","RGADT1",35,0)
 . Q
"RTN","RGADT1",36,0)
 ;
"RTN","RGADT1",37,0)
 ; I SDAMEVT=5 then we're checking a patient out (5) of a clinic.
"RTN","RGADT1",38,0)
 ;
"RTN","RGADT1",39,0)
 I '+$G(RGOK),($D(SDAMEVT)) D  Q:'RGOK  ; is this a check-out?
"RTN","RGADT1",40,0)
 . S RGOK=0 Q:$G(SDAMEVT)'=5  ; check-out (5)
"RTN","RGADT1",41,0)
 . ; ignore current inpatients
"RTN","RGADT1",42,0)
 . Q:$L($G(^DPT(DFN,.1)))  ; ward location check IA: 10035
"RTN","RGADT1",43,0)
 . S RGTYPE=SDAMEVT,RGENVR="A3"
"RTN","RGADT1",44,0)
 . S RGDATE=$P($G(SDATA),U,3)
"RTN","RGADT1",45,0)
 . S:$L(RGDATE) RGOK=1
"RTN","RGADT1",46,0)
 . Q
"RTN","RGADT1",47,0)
 ; S ^TMP("RGTRACE",$J)=1
"RTN","RGADT1",48,0)
 I 'RGOK K RGOK Q  ; quit if our conditions (A01, A03) have not been met
"RTN","RGADT1",49,0)
 I '($G(DGQUIET)) S:$D(^TMP("RGTRACE",$J)) RGTRACE=1
"RTN","RGADT1",50,0)
 I $D(RGTRACE) D EVENT,EXIT Q
"RTN","RGADT1",51,0)
 N ZTDESC,ZTRTN,ZTSAVE,ZTIO,ZTDTH
"RTN","RGADT1",52,0)
 S ZTDESC="CIRN HL7 ADT-"_$S(RGTYPE=1:"A01",1:"A03")_" Messaging"
"RTN","RGADT1",53,0)
 S ZTRTN="EVENT^RGADT1",ZTIO="",ZTDTH=$H
"RTN","RGADT1",54,0)
 F I="DFN","RGDATE","RGTYPE","RGENVR" S ZTSAVE(I)=""
"RTN","RGADT1",55,0)
 S:$D(RGMOV) ZTSAVE("RGMOV")="" ; defined for admissions & discharges
"RTN","RGADT1",56,0)
 S:$D(SDOE) ZTSAVE("SDOE")="" ; file ien: 409.68, clinic check out
"RTN","RGADT1",57,0)
 D ^%ZTLOAD,EXIT
"RTN","RGADT1",58,0)
 Q
"RTN","RGADT1",59,0)
 ;
"RTN","RGADT1",60,0)
EVENT ; build the HL7 message
"RTN","RGADT1",61,0)
 S RGEVT=$S(RGTYPE=1:"A01",1:"A03") K HL
"RTN","RGADT1",62,0)
 D INIT^HLFNC2("RG ADT-"_RGEVT_" SERVER",.HL)
"RTN","RGADT1",63,0)
 I $G(HL) Q  ; error
"RTN","RGADT1",64,0)
 D:RGTYPE=1!(RGTYPE=3) IN ; admission -or- discharge
"RTN","RGADT1",65,0)
 D:RGTYPE=5 OUT ; clinic check out
"RTN","RGADT1",66,0)
 D GENERATE^HLMA("RG ADT-"_RGEVT_" SERVER","LM",1,.RGRSLT,"",.HL)
"RTN","RGADT1",67,0)
 ;I $L(RGRSLT,"^")>1 D
"RTN","RGADT1",68,0)
 Q
"RTN","RGADT1",69,0)
EXIT ; kill and quit
"RTN","RGADT1",70,0)
 S:$D(ZTQUEUED) ZTREQ="@" D KILL^HLTRANS K ^TMP("RGTRACE",$J)
"RTN","RGADT1",71,0)
 K HLA("HLS"),RGDATE,RGENVR,RGEVT,RGOK,RGMOV,RGPAT,RGRSLT,RGFSTR
"RTN","RGADT1",72,0)
 K RGTRACE,RGTYPE
"RTN","RGADT1",73,0)
 Q
"RTN","RGADT1",74,0)
IN ; build the ADT message for admission/discharges (registration)
"RTN","RGADT1",75,0)
 ; EVN segment
"RTN","RGADT1",76,0)
 S HLA("HLS",1)=$$EVN^VAFHLEVN(RGEVT,RGENVR)
"RTN","RGADT1",77,0)
 S $P(HLA("HLS",1),HL("FS"),3)=$$HLDATE^HLFNC(RGDATE,"TS")
"RTN","RGADT1",78,0)
 ; PID segment
"RTN","RGADT1",79,0)
 S RGFSTR=$$COMMANUM(1,30)
"RTN","RGADT1",80,0)
 S HLA("HLS",2)=$$EN^VAFCPID(DFN,RGFSTR,1)
"RTN","RGADT1",81,0)
 ; PD1 segment
"RTN","RGADT1",82,0)
 S RGFSTR=$$COMMANUM(1,12)
"RTN","RGADT1",83,0)
 S HLA("HLS",3)=$$EN^VAFHLPD1(DFN,RGFSTR)
"RTN","RGADT1",84,0)
 ; PV1 segment
"RTN","RGADT1",85,0)
 S RGFSTR="2,3,4,5,"_$$COMMANUM(7,45)
"RTN","RGADT1",86,0)
 S HLA("HLS",4)=$$IN^VAFHLPV1(DFN,RGDATE,RGFSTR,RGMOV,"","")
"RTN","RGADT1",87,0)
 Q
"RTN","RGADT1",88,0)
OUT ; build the ADT message for scheduling events: checkout
"RTN","RGADT1",89,0)
 ; EVN segment
"RTN","RGADT1",90,0)
 S HLA("HLS",1)=$$EVN^VAFHLEVN(RGEVT,RGENVR)
"RTN","RGADT1",91,0)
 S $P(HLA("HLS",1),HL("FS"),3)=$$HLDATE^HLFNC(RGDATE,"TS")
"RTN","RGADT1",92,0)
 ; PID segment
"RTN","RGADT1",93,0)
 S RGFSTR=$$COMMANUM(1,30)
"RTN","RGADT1",94,0)
 S HLA("HLS",2)=$$EN^VAFCPID(DFN,RGFSTR,1)
"RTN","RGADT1",95,0)
 ; PD1 segment
"RTN","RGADT1",96,0)
 S RGFSTR=$$COMMANUM(1,12)
"RTN","RGADT1",97,0)
 S HLA("HLS",3)=$$EN^VAFHLPD1(DFN,RGFSTR)
"RTN","RGADT1",98,0)
 ; PV1 segment
"RTN","RGADT1",99,0)
 S RGFSTR="2,3,4,5,"_$$COMMANUM(7,45)
"RTN","RGADT1",100,0)
 S HLA("HLS",4)=$$EN^VAFHLPV1("",,RGFSTR,,HL("Q"),HL("FS"))
"RTN","RGADT1",101,0)
 Q
"RTN","RGADT1",102,0)
COMMANUM(FROM,TO) ;Build comma seperated list of numbers
"RTN","RGADT1",103,0)
 ;Input  : FROM - Starting number (default = 1)
"RTN","RGADT1",104,0)
 ;         TO - Ending number (default = FROM)
"RTN","RGADT1",105,0)
 ;Output : Comma seperated list of numbers between FROM and TO
"RTN","RGADT1",106,0)
 ;         (Ex: 1,2,3)
"RTN","RGADT1",107,0)
 ;Notes  : Call assumes FROM <= TO
"RTN","RGADT1",108,0)
 ;         copied from COMMANUM^VAFCADT2
"RTN","RGADT1",109,0)
 ;
"RTN","RGADT1",110,0)
 S FROM=$G(FROM) S:(FROM="") FROM=1
"RTN","RGADT1",111,0)
 S TO=$G(TO) S:(TO="") TO=FROM
"RTN","RGADT1",112,0)
 N OUTPUT,X
"RTN","RGADT1",113,0)
 S OUTPUT=FROM
"RTN","RGADT1",114,0)
 F X=(FROM+1):1:TO S OUTPUT=(OUTPUT_","_X)
"RTN","RGADT1",115,0)
 Q OUTPUT
"RTN","RGADT2")
0^3^B22463508
"RTN","RGADT2",1,0)
RGADT2 ;HIRMFO/GJC-TFL FILE SEEDING ROUTINE (PD-MPI LOAD) ;09/21/99
"RTN","RGADT2",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4**;30 Apr 99
"RTN","RGADT2",3,0)
 Q  ; quit if called from the top
"RTN","RGADT2",4,0)
 ;
"RTN","RGADT2",5,0)
EN ; entry point to check the TREATING FACILITY LIST (TFL-391.91) file
"RTN","RGADT2",6,0)
 ; for the proper LAST TREATMENT DATE.  This code is part of the post
"RTN","RGADT2",7,0)
 ; init for RG*1*4.  This can also be called from the EN1 entry point
"RTN","RGADT2",8,0)
 ; to determine the LAST TREATMENT DATE for a specific patient.
"RTN","RGADT2",9,0)
 ; Closely linked to the MFU event message broadcasts used to update
"RTN","RGADT2",10,0)
 ; the TFL (#391.91) file.
"RTN","RGADT2",11,0)
 ;
"RTN","RGADT2",12,0)
 Q:$P($G(^RGSITE(991.8,1,1)),"^",2)  ; seeding process ran in the past
"RTN","RGADT2",13,0)
 ;
"RTN","RGADT2",14,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","RGADT2",15,0)
 S U="^",RGSITE=$$KSP^XUPARAM("INST") ;defines the local facility
"RTN","RGADT2",16,0)
 S RGSTRT=$$NOW^XLFDT(),RGCNT=0
"RTN","RGADT2",17,0)
 ; check to see if software is part of an KIDS install.  If not, no
"RTN","RGADT2",18,0)
 ; checkpoints needed.
"RTN","RGADT2",19,0)
 S RGICN=$S($D(XPDNM):+$$PARCP^XPDUTL("POST2"),1:0)
"RTN","RGADT2",20,0)
 ; check ALL patients with an Integration Control Number (ICN) for a
"RTN","RGADT2",21,0)
 ; given facility, make sure the DATE LAST TREATED field in the TFL
"RTN","RGADT2",22,0)
 ; file is correct.
"RTN","RGADT2",23,0)
 F  S RGICN=$O(^DPT("AICN",RGICN)) Q:RGICN'>0  D
"RTN","RGADT2",24,0)
 . S RGDFN=0
"RTN","RGADT2",25,0)
 . F  S RGDFN=$O(^DPT("AICN",RGICN,RGDFN)) Q:RGDFN'>0  D EN1(RGDFN)
"RTN","RGADT2",26,0)
 . S RGCNT=RGCNT+1 ; increment record counter
"RTN","RGADT2",27,0)
 . S:$D(XPDNM) RGSAVE=$$UPCP^XPDUTL("POST2",RGICN)
"RTN","RGADT2",28,0)
 . Q
"RTN","RGADT2",29,0)
 S RGFIN=$$NOW^XLFDT() D EMAIL^RGADT2 ; send completion message to user
"RTN","RGADT2",30,0)
 ; populate the 'MPI/PD SEEDING COMP DATE/TIME' (#12) field in the CIRN
"RTN","RGADT2",31,0)
 ; SITE PARAMETER FILE (#991.8)  (do not re-seed a facility)
"RTN","RGADT2",32,0)
 K RGFDA S RGFDA(991.8,"1,",12)=$$NOW^XLFDT()
"RTN","RGADT2",33,0)
 D FILE^DIE("K","RGFDA"),KILL
"RTN","RGADT2",34,0)
 QUIT
"RTN","RGADT2",35,0)
 ;
"RTN","RGADT2",36,0)
EN1(RGDFN,RGSUP) ; determine the LAST TREATMENT DATE for a single
"RTN","RGADT2",37,0)
 ; patient called from our seeding process above.
"RTN","RGADT2",38,0)
 ; input: RGDFN - the dfn of the patient
"RTN","RGADT2",39,0)
 ;        RGSUP - if 1, suppress add entries to the ADT HL7 PIVOT
"RTN","RGADT2",40,0)
 ;                (#391.71) file for TF messaging - VAFCTFMF (optional)
"RTN","RGADT2",41,0)
 ; output: RGDATE - patient's DATE LAST TREATED
"RTN","RGADT2",42,0)
 ;         RGENVR - event reason
"RTN","RGADT2",43,0)
 ;
"RTN","RGADT2",44,0)
 Q:$$LOCICN(RGDFN,$G(RGICN))  ; local ICN
"RTN","RGADT2",45,0)
 S U="^"
"RTN","RGADT2",46,0)
 S:'$D(RGSITE) RGSITE=$$KSP^XUPARAM("INST") ;defines the local facility
"RTN","RGADT2",47,0)
 S (RGLAST,RGADMDIS)=$$ADMDIS(RGDFN) ; dt_"^"_event type or ""
"RTN","RGADT2",48,0)
 S RGADMDIS=$S(RGADMDIS]"":$P(RGADMDIS,"^"),1:"") ; event dt or null
"RTN","RGADT2",49,0)
 S:$P(RGLAST,"^",2)=3!(RGLAST="") RGENCDT=$$ENCDT(RGDFN,RGADMDIS)
"RTN","RGADT2",50,0)
 ; patient has been discharged or has never been admitted.  Has this
"RTN","RGADT2",51,0)
 ; individual been checked out of a clinic? 
"RTN","RGADT2",52,0)
 I $D(RGENCDT)#2,($P(RGLAST,U)) S RGLAST=$S(+RGENCDT>+RGLAST:RGENCDT,1:RGLAST)
"RTN","RGADT2",53,0)
 I $D(RGENCDT)#2,('$P(RGLAST,U)) S RGLAST=RGENCDT
"RTN","RGADT2",54,0)
 S RGTYPE=$P(RGLAST,"^",2),RGDATE=+RGLAST
"RTN","RGADT2",55,0)
 ; input variables to FILE^VAFCTFU
"RTN","RGADT2",56,0)
 ; RGDFN - patient ien ; RGSITE - treating facility
"RTN","RGADT2",57,0)
 ; RGDATE - date last treated ; RGENVR - event reason
"RTN","RGADT2",58,0)
 ;
"RTN","RGADT2",59,0)
 I RGDATE D SETMSG,FILE^VAFCTFU(RGDFN,RGSITE_U_RGDATE_U_RGENVR,$G(RGSUP))
"RTN","RGADT2",60,0)
 ; update the TFL file for the site running the seeding process,
"RTN","RGADT2",61,0)
 ; then build the HL7 message with the new DATE LAST TREATED &
"RTN","RGADT2",62,0)
 ; ADT/HL7 EVENT REASON values & send them to our CMOR/subscribers.
"RTN","RGADT2",63,0)
 ;
"RTN","RGADT2",64,0)
 D:$G(XPDNM)'="RG*1.0*4" KILL ; single patient operation, kill all
"RTN","RGADT2",65,0)
 ; variables (EN1 re-entrant when running post-install for RG*1.0*4)
"RTN","RGADT2",66,0)
 Q
"RTN","RGADT2",67,0)
 ;
"RTN","RGADT2",68,0)
KILL ; kill and quit
"RTN","RGADT2",69,0)
 K DFN,RGADMDIS,RGCNT,RGDATE,RGDFN,RGENCDT,RGENVR,RGFDA,RGFIN,RGICN
"RTN","RGADT2",70,0)
 K RGLAST,RGSAVE,RGSITE,RGSTRT,RGTYPE
"RTN","RGADT2",71,0)
 Q
"RTN","RGADT2",72,0)
 ;
"RTN","RGADT2",73,0)
ADMDIS(DFN) ; find the patient's last admission and discharge dates if
"RTN","RGADT2",74,0)
 ; they exist.
"RTN","RGADT2",75,0)
 ; Input: DFN - ien of the patient (file 2)
"RTN","RGADT2",76,0)
 ;Output: a valid discharge/admission date/time concatenated with
"RTN","RGADT2",77,0)
 ;        the event type (1=admission, 3=discharge) -or- null
"RTN","RGADT2",78,0)
 N %,VAERR,VAIP S VAIP("D")="LAST" D IN5^VADPT
"RTN","RGADT2",79,0)
 I '+$G(VAIP(17,1)),('+$G(VAIP(13,1))) Q ""
"RTN","RGADT2",80,0)
 ; no discharge date, no admission date, return null
"RTN","RGADT2",81,0)
 I '+$G(VAIP(17,1)) Q $P($G(VAIP(13,1)),U)_"^1"
"RTN","RGADT2",82,0)
 ; no discharge date, return admission date
"RTN","RGADT2",83,0)
 I '+$G(VAIP(13,1)) Q $P($G(VAIP(17,1)),U)_"^3"
"RTN","RGADT2",84,0)
 ; no admission date, return discharge date
"RTN","RGADT2",85,0)
 I +$G(VAIP(17,1))>(+$G(VAIP(13,1))) Q +$G(VAIP(17,1))_"^3"
"RTN","RGADT2",86,0)
 ; return discharge date
"RTN","RGADT2",87,0)
 Q +$G(VAIP(13,1))_"^1" ; return admission date
"RTN","RGADT2",88,0)
 ;
"RTN","RGADT2",89,0)
ENCDT(DFN,INPDT) ; find the last patient check out date/time.  'ADFN'
"RTN","RGADT2",90,0)
 ; cross-reference accessed through DBIA: 2953
"RTN","RGADT2",91,0)
 ; Input: DFN  - ien of the patient (file 2)
"RTN","RGADT2",92,0)
 ;        INPDT - date (if any) returned from the inpatient admission/
"RTN","RGADT2",93,0)
 ;               discharge subroutine     
"RTN","RGADT2",94,0)
 ;Output: a valid discharge/admission date/time concatenated with
"RTN","RGADT2",95,0)
 ;        the event type (5=check out) -or- null
"RTN","RGADT2",96,0)
 Q:'DFN "" ; we need dfn defined
"RTN","RGADT2",97,0)
 K RGDATA,RGPURGE,RGX,RGX1,RGX2 N RGX3
"RTN","RGADT2",98,0)
 S RGX=9999999.9999999,RGX2=0,RGX3=""
"RTN","RGADT2",99,0)
 F  S RGX=$O(^SCE("ADFN",DFN,RGX),-1) Q:'RGX!(INPDT>RGX)  D  Q:RGX2
"RTN","RGADT2",100,0)
 . S RGX1=0 F  S RGX1=$O(^SCE("ADFN",DFN,RGX,RGX1)) Q:'RGX1  D  Q:RGX2
"RTN","RGADT2",101,0)
 .. D GETGEN^SDOE(RGX1,"RGDATA")
"RTN","RGADT2",102,0)
 .. D PARSE^SDOE(.RGDATA,"EXTERNAL","RGPARSE")
"RTN","RGADT2",103,0)
 .. I RGPARSE(.12)="CHECKED OUT" S RGX2=1,RGX3=RGX
"RTN","RGADT2",104,0)
 .. K RGDATA,RGPARSE
"RTN","RGADT2",105,0)
 .. Q
"RTN","RGADT2",106,0)
 . Q
"RTN","RGADT2",107,0)
 K RGDATA,RGPURGE,RGX,RGX1,RGX2
"RTN","RGADT2",108,0)
 Q RGX3_"^5" ; X is either null or the date/time of the check out
"RTN","RGADT2",109,0)
 ;
"RTN","RGADT2",110,0)
SETMSG ; define the variables used to build a HL7 message (RGADT1)
"RTN","RGADT2",111,0)
 S DFN=RGDFN
"RTN","RGADT2",112,0)
 S RGENVR=$S(RGTYPE=1:"A1",RGTYPE=3:"A2",1:"A3") ;A1=adm;A2=dis;A3=CO 
"RTN","RGADT2",113,0)
 Q
"RTN","RGADT2",114,0)
 ;
"RTN","RGADT2",115,0)
EMAIL ; Send a completion email message to the user who installed this patch,
"RTN","RGADT2",116,0)
 ; RG*1*4.  Show the number of records processed, elapsed time and the
"RTN","RGADT2",117,0)
 ; number of records processed per minute.
"RTN","RGADT2",118,0)
 N RGELAPS,RGARY,RGMIN
"RTN","RGADT2",119,0)
 S XMDUZ=.5,XMY(DUZ)="",XMTEXT="RGARY(1,"
"RTN","RGADT2",120,0)
 S XMSUB="CIRN-CPRS DATE LAST TREATED seeding (#391.91 ; .03) results"
"RTN","RGADT2",121,0)
 S RGMIN=$$FMDIFF^XLFDT(RGFIN,RGSTRT,2)/60 ; # of sec x (1 min/60 sec)
"RTN","RGADT2",122,0)
 S:RGMIN=0 RGMIN=1 ; avoid a possible divide by zero
"RTN","RGADT2",123,0)
 S RGELAPS=$$FMDIFF^XLFDT(RGFIN,RGSTRT,3)
"RTN","RGADT2",124,0)
 S RGARY(1,1)="# of processed patients, in the PATIENT (#2) file"
"RTN","RGADT2",125,0)
 S RGARY(1,2)="with an ICN: "_RGCNT
"RTN","RGADT2",126,0)
 S RGARY(1,3)="TFL seeding process run time: "_RGELAPS_" (DD HH:MM:SS format)"
"RTN","RGADT2",127,0)
 S RGARY(1,4)="# of records processed per minute: "_$$STRIP^XLFSTR($J((RGCNT/RGMIN),8,2)," ")
"RTN","RGADT2",128,0)
 D ^XMD K XMDUZ,XMSUB,XMTEXT,XMY
"RTN","RGADT2",129,0)
 Q
"RTN","RGADT2",130,0)
 ;
"RTN","RGADT2",131,0)
LOCICN(DFN,ICN) ; check if this patient has a national ICN without having a
"RTN","RGADT2",132,0)
 ; local ICN.  This function is used when an entire site (all patients)
"RTN","RGADT2",133,0)
 ; is seeding, or for individual patient seeding.
"RTN","RGADT2",134,0)
 ; note: IA 2070 covers the hit on the 'MPI' node
"RTN","RGADT2",135,0)
 ;       IA 2701 covers the call to $$IFLOCAL^MPIF001
"RTN","RGADT2",136,0)
 ;input variables:
"RTN","RGADT2",137,0)
 ; DFN(required)-Patient ien (PATIENT file #2)
"RTN","RGADT2",138,0)
 ; ICN(optional)-Integration Control Number(fld: 991.01, file 2)
"RTN","RGADT2",139,0)
 ;output variable:
"RTN","RGADT2",140,0)
 ; FLAG-0 if the patient has a national ICN and not a local ICN, else 1
"RTN","RGADT2",141,0)
 N FLAG S FLAG=1
"RTN","RGADT2",142,0)
 I +$G(ICN) D
"RTN","RGADT2",143,0)
 . I $P($G(^DPT(DFN,"MPI")),"^")=ICN,('$$IFLOCAL^MPIF001(DFN)) S FLAG=0
"RTN","RGADT2",144,0)
 . Q
"RTN","RGADT2",145,0)
 E  D
"RTN","RGADT2",146,0)
 . I $P($G(^DPT(DFN,"MPI")),"^"),('$$IFLOCAL^MPIF001(DFN)) S FLAG=0
"RTN","RGADT2",147,0)
 . Q
"RTN","RGADT2",148,0)
 Q FLAG
"RTN","RGRSDYN")
0^6^B7362449
"RTN","RGRSDYN",1,0)
RGRSDYN ;ALB/RJS-BUILD DYNAMIC LINK LIST FOR A PATIENT ;03/21/97
"RTN","RGRSDYN",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4**;30 Apr 99
"RTN","RGRSDYN",3,0)
EN(CLIENT,CLASS) ;
"RTN","RGRSDYN",4,0)
 ;CLIENT=HL7 CLIENT PROTOCOL AT TARGET SYSTEM
"RTN","RGRSDYN",5,0)
 ;DATA CLASS (Opt.) = Pull from Subs. Registry ONLY
"RTN","RGRSDYN",6,0)
 ;For now, anything else is both DESCRIPTIVE AND CLINICAL
"RTN","RGRSDYN",7,0)
 S CLASS=$G(CLASS),CLIENT=$G(CLIENT)
"RTN","RGRSDYN",8,0)
 Q:CLIENT=""  ;No receiver
"RTN","RGRSDYN",9,0)
 N PPF,DFN,HERE,RGRS,PPFIEN
"RTN","RGRSDYN",10,0)
PARS ;Parse local outbound message
"RTN","RGRSDYN",11,0)
 N RGDC
"RTN","RGRSDYN",12,0)
 D INITIZE^RGRSUTIL,EN^RGRSPARS("RGRS")
"RTN","RGRSDYN",13,0)
 ;Get patients owner site
"RTN","RGRSDYN",14,0)
 S PPF=$G(RGRS("SITENUM"))\1 Q:PPF'>0
"RTN","RGRSDYN",15,0)
 S PPFIEN=$$LKUP^XUAF4(PPF)
"RTN","RGRSDYN",16,0)
 ;Get DFN
"RTN","RGRSDYN",17,0)
 S DFN=$G(RGRS("DFN")) Q:$G(DFN)']""
"RTN","RGRSDYN",18,0)
 Q:+$$SEND2^VAFCUTL1(DFN,"T")  ;quit if test patient
"RTN","RGRSDYN",19,0)
 Q:$$IFLOCAL^MPIF001(DFN)
"RTN","RGRSDYN",20,0)
 ;Where we're at
"RTN","RGRSDYN",21,0)
 S HERE=$P($$SITE^VASITE,"^",3)\1
"RTN","RGRSDYN",22,0)
NOTPPF ; if not ppf send only to ppf
"RTN","RGRSDYN",23,0)
 I PPF'=HERE D  Q
"RTN","RGRSDYN",24,0)
 . N PPFLINK,INDEX
"RTN","RGRSDYN",25,0)
 . D LINK^HLUTIL3(PPFIEN,.PPFLINK)
"RTN","RGRSDYN",26,0)
 . S INDEX=$O(PPFLINK(0))
"RTN","RGRSDYN",27,0)
 . I INDEX]"" S HLL("LINKS",1)=CLIENT_"^"_PPFLINK(INDEX)
"RTN","RGRSDYN",28,0)
ISPPF ;
"RTN","RGRSDYN",29,0)
 I PPF=HERE D  Q
"RTN","RGRSDYN",30,0)
 . N PARENT,INDEX,SUBCONTL,CHILDREN,INDEX1,NODE
"RTN","RGRSDYN",31,0)
 . S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","RGRSDYN",32,0)
 . S SUBCONTL=$P($G(NODE),"^",5)
"RTN","RGRSDYN",33,0)
 . ;Get subscribers, return updated HLL array
"RTN","RGRSDYN",34,0)
 . I SUBCONTL]"" D GET^HLSUB(SUBCONTL,+CLASS,CLIENT,.HLL)
"RTN","RGRSDYN",35,0)
 . ;LAST MINUTE CHANGE MARILYN REQUESTED
"RTN","RGRSDYN",36,0)
 . ;Get MPI link from SITE PARAMETER (when non A01/A03 event, ADT
"RTN","RGRSDYN",37,0)
 . ;message) part of the DG*5.3*261/RG*1.0*4 bundle gjc@2/4/99
"RTN","RGRSDYN",38,0)
 . I '$$ADT0103() D
"RTN","RGRSDYN",39,0)
 . . N MPI S MPI=$$MPILINK^MPIFAPI() D
"RTN","RGRSDYN",40,0)
 . . . I $P($G(MPI),U)'=-1 S HLL("LINKS",9999999999)=CLIENT_"^"_MPI
"RTN","RGRSDYN",41,0)
 . . . I $P($G(MPI),U)=-1 D
"RTN","RGRSDYN",42,0)
 . . . . N RGLOG,RGMTXT
"RTN","RGRSDYN",43,0)
 . . . . D START^RGHLLOG(HLMTIEN,"","")
"RTN","RGRSDYN",44,0)
 . . . . S RGMTXT=" See Appendix F of the Clinical Information Resource Network Patient Demographics (CIRN-PD) and Master Patient Index (MPI) Installation and Implementation Guide."
"RTN","RGRSDYN",45,0)
 . . . . D EXC^RGHLLOG(224,"No MPI link identified in CIRN SITE PARAMETER file (#991.8)"_RGMTXT)
"RTN","RGRSDYN",46,0)
 . . . . D STOP^RGHLLOG(0)
"RTN","RGRSDYN",47,0)
 ;
"RTN","RGRSDYN",48,0)
 ;the following was commented out because we're not updating all sites
"RTN","RGRSDYN",49,0)
 ;in the VISN anymore
"RTN","RGRSDYN",50,0)
 ;
"RTN","RGRSDYN",51,0)
 ;. ;Get owners PARENT
"RTN","RGRSDYN",52,0)
 ;. D PARENT^XUAF4("PARENT",PPF)
"RTN","RGRSDYN",53,0)
 ;. S INDEX=""
"RTN","RGRSDYN",54,0)
 ;. S INDEX=$O(PARENT("P",INDEX))
"RTN","RGRSDYN",55,0)
 ;. Q:INDEX']""
"RTN","RGRSDYN",56,0)
 ;. D LINK^HLUTIL3(INDEX,.CHILDREN)
"RTN","RGRSDYN",57,0)
 ;. S INDEX=$O(HLL("LINKS",9999999999999),-1)
"RTN","RGRSDYN",58,0)
 ;. Q:INDEX']""
"RTN","RGRSDYN",59,0)
 ;. S INDEX1=0
"RTN","RGRSDYN",60,0)
 ;. F  S INDEX1=$O(CHILDREN(INDEX1)) Q:INDEX1'>0  D
"RTN","RGRSDYN",61,0)
 ;. . S INDEX=INDEX+1
"RTN","RGRSDYN",62,0)
 ;. . S HLL("LINKS",INDEX)=CLIENT_"^"_CHILDREN(INDEX1)
"RTN","RGRSDYN",63,0)
 ;
"RTN","RGRSDYN",64,0)
ADT0103() ; check to see if this is an ADT message type with an
"RTN","RGRSDYN",65,0)
 ; event of A01 -or- A03.  If true, do not broadcast the message
"RTN","RGRSDYN",66,0)
 ; to the MPI.  Part of the DG*5.3*261/RG*1.0*4 bundle.  gjc@2/4/99
"RTN","RGRSDYN",67,0)
 S HL("MTN")=$G(HL("MTN")),HL("ETN")=$G(HL("ETN")) ; just in case
"RTN","RGRSDYN",68,0)
 Q $S(HL("MTN")="ADT"&(HL("ETN")="A01"!(HL("ETN")="A03")):1,1:0)
"RTN","RGRSMSH")
0^5^B1617290
"RTN","RGRSMSH",1,0)
RGRSMSH ;ALB/RJS-REGISTRATION MESSAGE PARSER FOR CIRN ;03/8/96
"RTN","RGRSMSH",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**4**;30 Apr 99
"RTN","RGRSMSH",3,0)
EN() ;
"RTN","RGRSMSH",4,0)
 ;This function call returns informtaion from the MSH and EVN segments
"RTN","RGRSMSH",5,0)
 ;
"RTN","RGRSMSH",6,0)
 ; Output:
"RTN","RGRSMSH",7,0)
 ;    Date Recieved^event date from EVN segment^sending facility name
"RTN","RGRSMSH",8,0)
 ;
"RTN","RGRSMSH",9,0)
 N RGRSMSH,RGC,RGRSEVN,SENDING,RECDATE,EVDATE,%,SENDPTR,INSTNUM
"RTN","RGRSMSH",10,0)
 S RGC=$E(HL("ECH"))
"RTN","RGRSMSH",11,0)
 S RGRSMSH=$$SEG1^RGRSUTIL("MSH",1,"MSH")
"RTN","RGRSMSH",12,0)
 S RGRSEVN=$$SEG1^RGRSUTIL("EVN",1,"EVN")
"RTN","RGRSMSH",13,0)
 ;;S INSTNUM=$P(RGRSMSH,HL("FS"),4)
"RTN","RGRSMSH",14,0)
 ;; ^ changed 11/20/98 by cmc - MSH segment read into 2 array entries
"RTN","RGRSMSH",15,0)
 ;; need to use new supported variable HL("SFN")
"RTN","RGRSMSH",16,0)
 ; $$FIND1^DIC & $$GET1^DIQ covered by IA#: 10090-read ^DIC(4 w/FileMan)
"RTN","RGRSMSH",17,0)
 S SENDPTR=$$FIND1^DIC(4,,"QX",+HL("SFN"),"D") ; gjc-RG*1*4 @ 4/27/00
"RTN","RGRSMSH",18,0)
 S SENDING=$$GET1^DIQ(4,SENDPTR_",",.01) ; gjc-RG*1*4 @ 4/27/00
"RTN","RGRSMSH",19,0)
 D NOW^%DTC
"RTN","RGRSMSH",20,0)
 S (RECDATE)=$G(%)
"RTN","RGRSMSH",21,0)
 S EVDATE=$P(RGRSEVN,HL("FS"),3)
"RTN","RGRSMSH",22,0)
 S EVDATE=$$FMDATE^HLFNC(EVDATE)
"RTN","RGRSMSH",23,0)
 ;
"RTN","RGRSMSH",24,0)
 Q $G(RECDATE)_"^"_$G(EVDATE)_"^"_$G(SENDING)
"VER")
8.0^22.0
"^DD",991.8,991.8,12,0)
MPI/PD SEEDING COMP DATE/TIME^D^^1;2^S %DT="ESTX" D ^%DT S X=Y K:Y<1 X
"^DD",991.8,991.8,12,3)
Enter the date/time the MPI/PD seeding process completed.
"^DD",991.8,991.8,12,21,0)
^^4^4^3000214^^
"^DD",991.8,991.8,12,21,1,0)
This field, 'MPI/PD SEEDING COMP DATE/TIME', is used to track the
"^DD",991.8,991.8,12,21,2,0)
date/time our seeding process completed.  This field is used to ensure
"^DD",991.8,991.8,12,21,3,0)
that the seeding process is run once and only once at a facility.  If a
"^DD",991.8,991.8,12,21,4,0)
date is present, our seeding process terminates.
"^DD",991.8,991.8,12,23,0)
^^7^7^3000214^
"^DD",991.8,991.8,12,23,1,0)
This field, 'MPI/PD SEEDING COMP DATE/TIME', is used to track the
"^DD",991.8,991.8,12,23,2,0)
date/time our seeding process completed.  This field is used to ensure
"^DD",991.8,991.8,12,23,3,0)
that the seeding process is run once and only once at a facility.  If a
"^DD",991.8,991.8,12,23,4,0)
date is present, our seeding process terminates.
"^DD",991.8,991.8,12,23,5,0)
 
"^DD",991.8,991.8,12,23,6,0)
This field was added as part of the DG*5.3*261 / RG*1.0*4 bundle
"^DD",991.8,991.8,12,23,7,0)
(CIRN-CPRS FOREIGN PATIENT DATA VIEWS)
"^DD",991.8,991.8,12,"DT")
3000214
**END**
**END**
