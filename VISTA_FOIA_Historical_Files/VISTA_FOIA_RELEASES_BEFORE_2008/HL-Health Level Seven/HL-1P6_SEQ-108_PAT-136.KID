EMERGENCY Released HL*1.6*136 SEQ #108
Extracted from mail message
**KIDS**:HL*1.6*136^

**INSTALL NAME**
HL*1.6*136
"BLD",1005,0)
HL*1.6*136^HEALTH LEVEL SEVEN^0^3070503^y
"BLD",1005,1,0)
^^2^2^3070430^
"BLD",1005,1,1,0)
HLO Purge Settings
"BLD",1005,1,2,0)

"BLD",1005,4,0)
^9.64PA^^0
"BLD",1005,6.3)
9
"BLD",1005,"ABPKG")
n
"BLD",1005,"INI")
CHECK^HLOPRE
"BLD",1005,"INID")
^n^y
"BLD",1005,"INIT")
P136^HLOPOST
"BLD",1005,"KRN",0)
^9.67PA^779.2^20
"BLD",1005,"KRN",.4,0)
.4
"BLD",1005,"KRN",.401,0)
.401
"BLD",1005,"KRN",.402,0)
.402
"BLD",1005,"KRN",.403,0)
.403
"BLD",1005,"KRN",.5,0)
.5
"BLD",1005,"KRN",.84,0)
.84
"BLD",1005,"KRN",3.6,0)
3.6
"BLD",1005,"KRN",3.8,0)
3.8
"BLD",1005,"KRN",9.2,0)
9.2
"BLD",1005,"KRN",9.8,0)
9.8
"BLD",1005,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",1005,"KRN",9.8,"NM",1,0)
HLOPURGE^^0^B33703423
"BLD",1005,"KRN",9.8,"NM","B","HLOPURGE",1)

"BLD",1005,"KRN",19,0)
19
"BLD",1005,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",1005,"KRN",19,"NM",1,0)
HLO DAILY STARTUP^^0
"BLD",1005,"KRN",19,"NM",2,0)
HLO SYSTEM STARTUP^^0
"BLD",1005,"KRN",19,"NM","B","HLO DAILY STARTUP",1)

"BLD",1005,"KRN",19,"NM","B","HLO SYSTEM STARTUP",2)

"BLD",1005,"KRN",19.1,0)
19.1
"BLD",1005,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",1005,"KRN",101,0)
101
"BLD",1005,"KRN",409.61,0)
409.61
"BLD",1005,"KRN",771,0)
771
"BLD",1005,"KRN",779.2,0)
779.2
"BLD",1005,"KRN",870,0)
870
"BLD",1005,"KRN",8989.51,0)
8989.51
"BLD",1005,"KRN",8989.52,0)
8989.52
"BLD",1005,"KRN",8994,0)
8994
"BLD",1005,"KRN","B",.4,.4)

"BLD",1005,"KRN","B",.401,.401)

"BLD",1005,"KRN","B",.402,.402)

"BLD",1005,"KRN","B",.403,.403)

"BLD",1005,"KRN","B",.5,.5)

"BLD",1005,"KRN","B",.84,.84)

"BLD",1005,"KRN","B",3.6,3.6)

"BLD",1005,"KRN","B",3.8,3.8)

"BLD",1005,"KRN","B",9.2,9.2)

"BLD",1005,"KRN","B",9.8,9.8)

"BLD",1005,"KRN","B",19,19)

"BLD",1005,"KRN","B",19.1,19.1)

"BLD",1005,"KRN","B",101,101)

"BLD",1005,"KRN","B",409.61,409.61)

"BLD",1005,"KRN","B",771,771)

"BLD",1005,"KRN","B",779.2,779.2)

"BLD",1005,"KRN","B",870,870)

"BLD",1005,"KRN","B",8989.51,8989.51)

"BLD",1005,"KRN","B",8989.52,8989.52)

"BLD",1005,"KRN","B",8994,8994)

"BLD",1005,"QUES",0)
^9.62^^
"BLD",1005,"REQB",0)
^9.611^1^1
"BLD",1005,"REQB",1,0)
HL*1.6*134^2
"BLD",1005,"REQB","B","HL*1.6*134",1)

"INI")
CHECK^HLOPRE
"INIT")
P136^HLOPOST
"KRN",19,1048,-1)
0^2
"KRN",19,1048,0)
HLO SYSTEM STARTUP^HL7 (Optimized) SYSTEM STARTUP^^A^^^^^^^n^HEALTH LEVEL SEVEN^^1
"KRN",19,1048,1,0)
^19.06^2^2^3070314^^^^
"KRN",19,1048,1,1,0)
This option should be scheduled upon system startup to start HLO
"KRN",19,1048,1,2,0)
running.
"KRN",19,1048,20)
D STARTHL7^HLOPROC1
"KRN",19,1048,200.9)
s
"KRN",19,1048,"U")
HL7 (OPTIMIZED) SYSTEM STARTUP
"KRN",19,1249,-1)
0^1
"KRN",19,1249,0)
HLO DAILY STARTUP^HLO DAILY STARTUP^^A^^^^^^^n^HEALTH LEVEL SEVEN^^1
"KRN",19,1249,1,0)
^19.06^5^5^3070503^^^^
"KRN",19,1249,1,1,0)
This option should be scheduled daily to insure that HLO stays up and running.
"KRN",19,1249,1,2,0)
It does NOT override the HLO ON/OFF SWITCH, i.e., if HLO was deliberately
"KRN",19,1249,1,3,0)
shutdown this option will not start it.  It is meant to re-start HLO if
"KRN",19,1249,1,4,0)
it unexpectely stops.
"KRN",19,1249,1,5,0)

"KRN",19,1249,20)
D:'$$CHKSTOP^HLOPROC STARTHL7^HLOPROC1
"KRN",19,1249,200.9)
y
"KRN",19,1249,"U")
HLO DAILY STARTUP
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",9,-1)
1^1
"PKG",9,0)
HEALTH LEVEL SEVEN^HL^DHCP IMPLEMENTATION OF HEALTH LEVEL SEVEN^
"PKG",9,20,0)
^9.402P^^
"PKG",9,22,0)
^9.49I^1^1
"PKG",9,22,1,0)
1.6^2980130^2980130^6
"PKG",9,22,1,"PAH",1,0)
136^3070503
"PKG",9,22,1,"PAH",1,1,0)
^^2^2^3070503
"PKG",9,22,1,"PAH",1,1,1,0)
HLO Purge Settings
"PKG",9,22,1,"PAH",1,1,2,0)

"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","HLOPOST")
0^^B13205173^B10060576
"RTN","HLOPOST",1,0)
HLOPOST ;IRMFO-ALB/CJM -Post-Install routine for HLO;03/24/2004  14:43 ;05/03/2007
"RTN","HLOPOST",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**126,134,136**;Oct 13, 1995;Build 9
"RTN","HLOPOST",3,0)
 ;
"RTN","HLOPOST",4,0)
 N SYSTEM,DATA,VASITE,OLDSITE
"RTN","HLOPOST",5,0)
 D IDXLINKS
"RTN","HLOPOST",6,0)
 D SYSPARMS^HLOSITE(.SYSTEM)
"RTN","HLOPOST",7,0)
 S VASITE=$$SITE^VASITE
"RTN","HLOPOST",8,0)
 S OLDSITE=$G(^HLCS(869.3,1,0))
"RTN","HLOPOST",9,0)
 S DATA(.01)=SYSTEM("DOMAIN")
"RTN","HLOPOST",10,0)
 I DATA(.01)="" D
"RTN","HLOPOST",11,0)
 .I $P(OLDSITE,"^",2) S DATA(.01)="HL7."_$P($G(^DIC(4.2,$P(OLDSITE,"^",2),0)),"^")
"RTN","HLOPOST",12,0)
 I DATA(.01)="" D
"RTN","HLOPOST",13,0)
 .N INST,DOMAIN
"RTN","HLOPOST",14,0)
 .S INST=$P(VASITE,"^")
"RTN","HLOPOST",15,0)
 .Q:'INST
"RTN","HLOPOST",16,0)
 .S DOMAIN=$P($G(^DIC(4,INST,6)),"^")
"RTN","HLOPOST",17,0)
 .I DOMAIN S DOMAIN=$P($G(^DIC(4.2,DOMAIN,0)),"^") I DOMAIN'="" S DATA(.01)="HL7."_DOMAIN
"RTN","HLOPOST",18,0)
 I DATA(.01)="" D BMES^XPDUTL("Post-Install failed, system missing INSTITUTION or DOMAIN file entry") Q
"RTN","HLOPOST",19,0)
 S DATA(.02)=SYSTEM("STATION")
"RTN","HLOPOST",20,0)
 I DATA(.02)="",$P(OLDSITE,"^",4) S DATA(.02)=$P($G(^DIC(4,$P(OLDSITE,"^",4),99)),"^")
"RTN","HLOPOST",21,0)
 I DATA(.02)="" S DATA(.02)=$P(VASITE,"^",3)
"RTN","HLOPOST",22,0)
 S DATA(.03)=$P(OLDSITE,"^",3)
"RTN","HLOPOST",23,0)
 S DATA(.04)=SYSTEM("MAXSTRING")
"RTN","HLOPOST",24,0)
 S DATA(.05)=SYSTEM("HL7 BUFFER")
"RTN","HLOPOST",25,0)
 S DATA(.06)=SYSTEM("USER BUFFER")
"RTN","HLOPOST",26,0)
 S DATA(.07)=SYSTEM("NORMAL PURGE")
"RTN","HLOPOST",27,0)
 S DATA(.08)=SYSTEM("ERROR PURGE")
"RTN","HLOPOST",28,0)
 I $D(^HLD(779.1,1,0)) D
"RTN","HLOPOST",29,0)
 .N ERROR
"RTN","HLOPOST",30,0)
 .I '$$UPD^HLOASUB1(779.1,1,.DATA,.ERROR) D BMES^XPDUTL("Post-Install failed -"_$G(ERROR))
"RTN","HLOPOST",31,0)
 E  D
"RTN","HLOPOST",32,0)
 .N ERROR
"RTN","HLOPOST",33,0)
 .I '$$ADD^HLOASUB1(779.1,,.DATA,.ERROR,1) D BMES^XPDUTL("Post-Install failed -"_$G(ERROR))
"RTN","HLOPOST",34,0)
 Q
"RTN","HLOPOST",35,0)
IDXLINKS ;
"RTN","HLOPOST",36,0)
 ;set the "AC" and "AD" indicies on the HL Logical Link file
"RTN","HLOPOST",37,0)
 N DIK
"RTN","HLOPOST",38,0)
 S DIK="^HLCS(870,"
"RTN","HLOPOST",39,0)
 S DIK(1)=".01^AC^AD^AD1^AD2"
"RTN","HLOPOST",40,0)
 D ENALL^DIK
"RTN","HLOPOST",41,0)
 Q
"RTN","HLOPOST",42,0)
 ;
"RTN","HLOPOST",43,0)
P134 ;
"RTN","HLOPOST",44,0)
 N DAILY,STARTUP,IEN,DATA
"RTN","HLOPOST",45,0)
 S DAILY=$O(^DIC(19,"B","HLO DAILY STARTUP",0))
"RTN","HLOPOST",46,0)
 I 'DAILY D BMES^XPDUTL("Failed to schedule the HLO DAILY STARTUP option!")
"RTN","HLOPOST",47,0)
 S STARTUP=$O(^DIC(19,"B","HLO SYSTEM STARTUP",0))
"RTN","HLOPOST",48,0)
 I 'STARTUP D BMES^XPDUTL("Failed to schedule the HLO SYSTEM STARTUP option!")
"RTN","HLOPOST",49,0)
 I STARTUP D
"RTN","HLOPOST",50,0)
 .S IEN=$O(^DIC(19.2,"B",STARTUP,0))
"RTN","HLOPOST",51,0)
 .S DATA(.01)=STARTUP
"RTN","HLOPOST",52,0)
 .S DATA(2)=""
"RTN","HLOPOST",53,0)
 .S DATA(6)=""
"RTN","HLOPOST",54,0)
 .S DATA(9)=$S($P($G(^HLD(779.1,1,0)),"^",3)="P":"S",1:"")
"RTN","HLOPOST",55,0)
 .I IEN D
"RTN","HLOPOST",56,0)
 ..I '$$UPD^HLOASUB1(19.2,IEN,.DATA) D BMES^XPDUTL("Failed to schedule the HLO SYSTEM STARTUP option!")
"RTN","HLOPOST",57,0)
 .E  D
"RTN","HLOPOST",58,0)
 ..I '$$ADD^HLOASUB1(19.2,,.DATA) D BMES^XPDUTL("Failed to schedule the HLO SYSTEM STARTUP option!")
"RTN","HLOPOST",59,0)
 I DAILY D
"RTN","HLOPOST",60,0)
 .S IEN=$O(^DIC(19.2,"B",DAILY,0))
"RTN","HLOPOST",61,0)
 .S DATA(.01)=DAILY
"RTN","HLOPOST",62,0)
 .S DATA(2)=$$NOW^XLFDT
"RTN","HLOPOST",63,0)
 .S DATA(6)="1D"
"RTN","HLOPOST",64,0)
 .S DATA(9)=""
"RTN","HLOPOST",65,0)
 .I IEN D
"RTN","HLOPOST",66,0)
 ..I '$$UPD^HLOASUB1(19.2,IEN,.DATA) D BMES^XPDUTL("Failed to schedule the HLO DAILY STARTUP option!")
"RTN","HLOPOST",67,0)
 .E  D
"RTN","HLOPOST",68,0)
 ..I '$$ADD^HLOASUB1(19.2,,.DATA) D BMES^XPDUTL("Failed to schedule the HLO DAILY STARTUP option!")
"RTN","HLOPOST",69,0)
 Q
"RTN","HLOPOST",70,0)
 ;
"RTN","HLOPOST",71,0)
P136 ;post-install routine for HL*1.6*136
"RTN","HLOPOST",72,0)
 N ERROR,DIFROM,IEN
"RTN","HLOPOST",73,0)
 I $P($G(^HLD(779.1,1,0)),"^",3)="P" D
"RTN","HLOPOST",74,0)
 .D RESCH^XUTMOPT("HLO DAILY STARTUP",$$FMADD^XLFDT($$NOW^XLFDT,,1),,"1D","L",.ERROR)
"RTN","HLOPOST",75,0)
 .I $G(ERROR)<0 D BMES^XPDUTL("Failed to schedule the HLO DAILY STARTUP option! Please do so manually")
"RTN","HLOPOST",76,0)
 ; 
"RTN","HLOPOST",77,0)
 S IEN=$O(^HLD(779.3,"B","PURGE OLD MESSAGES",0))
"RTN","HLOPOST",78,0)
 Q:'IEN
"RTN","HLOPOST",79,0)
 S ^HLD(779.3,IEN,0)="PURGE OLD MESSAGES^1^0^2^20^^5^GETWORK^HLOPURGE^DOWORK^HLOPURGE^1^0"
"RTN","HLOPOST",80,0)
 Q
"RTN","HLOPRE")
0^^B871663^B871663
"RTN","HLOPRE",1,0)
HLOPRE ;ALB/CJM-Pre-install check for HLO patches ;04/30/2007
"RTN","HLOPRE",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**134,136**;Oct 13, 1995;Build 9
"RTN","HLOPRE",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","HLOPRE",4,0)
 ;
"RTN","HLOPRE",5,0)
CHECK ;
"RTN","HLOPRE",6,0)
 N WORK
"RTN","HLOPRE",7,0)
 L +^HLTMP("PROCESS MANAGER"):0
"RTN","HLOPRE",8,0)
 I '$T D ABORT Q
"RTN","HLOPRE",9,0)
 D CHKDEAD^HLOPROC1(.WORK)
"RTN","HLOPRE",10,0)
 I $O(^HLTMP("HL7 RUNNING PROCESSES",""))'="" D ABORT
"RTN","HLOPRE",11,0)
 L -^HLTMP("PROCESS MANAGER")
"RTN","HLOPRE",12,0)
 Q
"RTN","HLOPRE",13,0)
ABORT ;
"RTN","HLOPRE",14,0)
 S XPDABORT=1
"RTN","HLOPRE",15,0)
 D BMES^XPDUTL("HLO processes are still running and prevent this installation from completing")
"RTN","HLOPRE",16,0)
 Q
"RTN","HLOPURGE")
0^1^B33703423^B33852841
"RTN","HLOPURGE",1,0)
HLOPURGE ;IRMFO-ALB/CJM - Purging Old Messages;03/24/2004  14:43 ;04/30/2007
"RTN","HLOPURGE",2,0)
 ;;1.6;HEALTH LEVEL SEVEN;**126,134,136**;Oct 13, 1995;Build 9
"RTN","HLOPURGE",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","HLOPURGE",4,0)
 ;
"RTN","HLOPURGE",5,0)
GETWORK(WORK) ;
"RTN","HLOPURGE",6,0)
 ;
"RTN","HLOPURGE",7,0)
 N OK
"RTN","HLOPURGE",8,0)
 S OK=0
"RTN","HLOPURGE",9,0)
 I $G(WORK)]"" L -HLPURGE(WORK)
"RTN","HLOPURGE",10,0)
 F WORK="IN","OUT","OLD778","OLD777" I '$G(WORK("DONE",WORK)) S WORK("DONE",WORK)=1 L +HLPURGE(WORK):0 S OK=$T Q:OK
"RTN","HLOPURGE",11,0)
 I 'OK K WORK("DONE") S WORK=""
"RTN","HLOPURGE",12,0)
 Q OK
"RTN","HLOPURGE",13,0)
 ;
"RTN","HLOPURGE",14,0)
DOWORK(WORK) ;
"RTN","HLOPURGE",15,0)
 I WORK="OLD778" D OLD778
"RTN","HLOPURGE",16,0)
 I WORK="OLD777" D OLD777
"RTN","HLOPURGE",17,0)
 I (WORK="IN")!(WORK="OUT") D
"RTN","HLOPURGE",18,0)
 .N TIME,NOW
"RTN","HLOPURGE",19,0)
 .S NOW=$$NOW^XLFDT
"RTN","HLOPURGE",20,0)
 .S TIME=0
"RTN","HLOPURGE",21,0)
 .F  S TIME=$O(^HLB("AD",WORK,TIME)) Q:TIME=""  Q:TIME>NOW  D
"RTN","HLOPURGE",22,0)
 ..N MSGIEN
"RTN","HLOPURGE",23,0)
 ..S MSGIEN=0
"RTN","HLOPURGE",24,0)
 ..F  S MSGIEN=$O(^HLB("AD",WORK,TIME,MSGIEN)) Q:'MSGIEN  D
"RTN","HLOPURGE",25,0)
 ...K ^HLB("AD",WORK,TIME,MSGIEN)
"RTN","HLOPURGE",26,0)
 ...D DELETE(MSGIEN)
"RTN","HLOPURGE",27,0)
 L -HLPURGE(WORK)
"RTN","HLOPURGE",28,0)
 Q
"RTN","HLOPURGE",29,0)
OLD778 ;
"RTN","HLOPURGE",30,0)
 N OLD,START,END,APP,TYPE,TODAY
"RTN","HLOPURGE",31,0)
 S TODAY=$$DT^XLFDT
"RTN","HLOPURGE",32,0)
 S OLD=$$FMADD^XLFDT(TODAY,-45)
"RTN","HLOPURGE",33,0)
 F START=0,100000000000,200000000000,300000000000 D
"RTN","HLOPURGE",34,0)
 .S END=(START+100000000000)-1
"RTN","HLOPURGE",35,0)
 .N MSGIEN,QUIT
"RTN","HLOPURGE",36,0)
 .S QUIT=0
"RTN","HLOPURGE",37,0)
 .S MSGIEN=START
"RTN","HLOPURGE",38,0)
 .F  S MSGIEN=$O(^HLB(MSGIEN)) Q:'MSGIEN  Q:(MSGIEN>END)  D  Q:QUIT
"RTN","HLOPURGE",39,0)
 ..N WHEN,BODY,NODE
"RTN","HLOPURGE",40,0)
 ..S NODE=$G(^HLB(MSGIEN,0))
"RTN","HLOPURGE",41,0)
 ..S WHEN=$P(NODE,"^",16)
"RTN","HLOPURGE",42,0)
 ..I WHEN,WHEN<OLD,$P(NODE,"^",9)<TODAY D DELETE(MSGIEN) Q
"RTN","HLOPURGE",43,0)
 ..I 'WHEN D
"RTN","HLOPURGE",44,0)
 ...S BODY=$P(NODE,"^",2)
"RTN","HLOPURGE",45,0)
 ...Q:'BODY
"RTN","HLOPURGE",46,0)
 ...S WHEN=+$G(^HLA(BODY,0))
"RTN","HLOPURGE",47,0)
 ...I WHEN,WHEN<OLD D  Q
"RTN","HLOPURGE",48,0)
 ....;I've seen messages sitting on outgoing queues forever, but it should never happen for incoming
"RTN","HLOPURGE",49,0)
 ....I $E($P(NODE,"^",4))="O",$P(NODE,"^",5)]"",$P(NODE,"^",6)]"" D
"RTN","HLOPURGE",50,0)
 .....N FROM
"RTN","HLOPURGE",51,0)
 .....S FROM=$P(NODE,"^",5)
"RTN","HLOPURGE",52,0)
 .....I $P(NODE,"^",8) S FROM=FROM_":"_$P(NODE,"^",8)
"RTN","HLOPURGE",53,0)
 .....Q:'$D(^HLB("QUEUE","OUT",FROM,$P(NODE,"^",6),MSGIEN))
"RTN","HLOPURGE",54,0)
 .....D DEQUE^HLOQUE(FROM,$P(NODE,"^",6),"OUT",MSGIEN)
"RTN","HLOPURGE",55,0)
 ....D DELETE(MSGIEN) Q
"RTN","HLOPURGE",56,0)
 ...;stop looking for old records?
"RTN","HLOPURGE",57,0)
 ...I WHEN,WHEN>OLD S QUIT=1
"RTN","HLOPURGE",58,0)
 ;
"RTN","HLOPURGE",59,0)
 ;also kill old errors left lying around
"RTN","HLOPURGE",60,0)
 F TYPE="TF","AE","SE" S APP="" F  S APP=$O(^HLB("ERRORS",TYPE,APP)) Q:APP=""  D
"RTN","HLOPURGE",61,0)
 .N TIME,PARMS
"RTN","HLOPURGE",62,0)
 .D SYSPARMS^HLOSITE(.PARMS)
"RTN","HLOPURGE",63,0)
 .S OLD=$$FMADD^XLFDT($$DT^XLFDT,-PARMS("ERROR PURGE"))
"RTN","HLOPURGE",64,0)
 .S TIME=0
"RTN","HLOPURGE",65,0)
 .F  S TIME=$O(^HLB("ERRORS",TYPE,APP,TIME)) Q:'TIME  Q:TIME>OLD  K ^HLB("ERRORS",TYPE,APP,TIME)
"RTN","HLOPURGE",66,0)
 Q
"RTN","HLOPURGE",67,0)
OLD777 ;
"RTN","HLOPURGE",68,0)
 N OLD,TIME,TODAY
"RTN","HLOPURGE",69,0)
 S TODAY=$$DT^XLFDT
"RTN","HLOPURGE",70,0)
 S OLD=$$FMADD^XLFDT(TODAY,-45)
"RTN","HLOPURGE",71,0)
 S TIME=0
"RTN","HLOPURGE",72,0)
 F  S TIME=$O(^HLA("B",TIME)) Q:'TIME  Q:TIME>OLD  D
"RTN","HLOPURGE",73,0)
 .N MSGIEN
"RTN","HLOPURGE",74,0)
 .S MSGIEN=0
"RTN","HLOPURGE",75,0)
 .F  S MSGIEN=$O(^HLA("B",TIME,MSGIEN)) Q:'MSGIEN  D
"RTN","HLOPURGE",76,0)
 ..N IEN778,STOP
"RTN","HLOPURGE",77,0)
 ..S (STOP,IEN778)=0
"RTN","HLOPURGE",78,0)
 ..F  S IEN778=$O(^HLB("C",MSGIEN,IEN778)) Q:'IEN778  D
"RTN","HLOPURGE",79,0)
 ...I $P($G(^HLB(IEN778,0)),"^",9)>TODAY S STOP=1 Q
"RTN","HLOPURGE",80,0)
 ...D DELETE(IEN778,1)
"RTN","HLOPURGE",81,0)
 ..K:'STOP ^HLB("C",MSGIEN),^HLA("B",TIME,MSGIEN),^HLA(MSGIEN)
"RTN","HLOPURGE",82,0)
 Q
"RTN","HLOPURGE",83,0)
 ;
"RTN","HLOPURGE",84,0)
DELETE(MSGIEN,FLAG) ;
"RTN","HLOPURGE",85,0)
 ;Input:
"RTN","HLOPURGE",86,0)
 ;  MSGIEN - IEN, file 778
"RTN","HLOPURGE",87,0)
 ;  FLAG - if $G(FLAG), will not delete the pointed to record in file 777
"RTN","HLOPURGE",88,0)
 N AC,SUBIEN,RAPP,SAPP,FS,CS,MSG
"RTN","HLOPURGE",89,0)
 I '$$GETMSG^HLOMSG(MSGIEN,.MSG) ;MSG is corrupted, but there sill may be nodes to delete
"RTN","HLOPURGE",90,0)
 S (RAPP,SAPP)=""
"RTN","HLOPURGE",91,0)
 D
"RTN","HLOPURGE",92,0)
 .S FS=$E(MSG("HDR",1),4)
"RTN","HLOPURGE",93,0)
 .Q:FS=""
"RTN","HLOPURGE",94,0)
 .S CS=$E(MSG("HDR",1),5)
"RTN","HLOPURGE",95,0)
 .S SAPP=$P($P(MSG("HDR",1),FS,3),CS)
"RTN","HLOPURGE",96,0)
 .I SAPP="" S SAPP="UNKNOWN"
"RTN","HLOPURGE",97,0)
 .S RAPP=$P($P(MSG("HDR",1),FS,5),CS)
"RTN","HLOPURGE",98,0)
 .I RAPP="" S RAPP="UNKNOWN"
"RTN","HLOPURGE",99,0)
 ;
"RTN","HLOPURGE",100,0)
 I 'MSG("BATCH") D KSEARCH(.MSG,MSG("MESSAGE TYPE"),MSG("EVENT"),SAPP,RAPP,MSGIEN)
"RTN","HLOPURGE",101,0)
 ;if an error status,take care of the "ERRORS" x-ref
"RTN","HLOPURGE",102,0)
 I MSG("STATUS")'="",MSG("STATUS")'="SU",MSG("BODY") D
"RTN","HLOPURGE",103,0)
 .N APP
"RTN","HLOPURGE",104,0)
 .S APP=$S(MSG("STATUS")="TF":SAPP,1:RAPP)
"RTN","HLOPURGE",105,0)
 .K ^HLB("ERRORS",MSG("STATUS"),APP,MSG("DT/TM CREATED"),MSGIEN)
"RTN","HLOPURGE",106,0)
 .I MSG("STATUS")="AE" D
"RTN","HLOPURGE",107,0)
 ..N SUB
"RTN","HLOPURGE",108,0)
 ..S SUB=MSGIEN_"^"
"RTN","HLOPURGE",109,0)
 ..K ^HLB("ERRORS","AE",APP,MSG("DT/TM CREATED"),SUB)
"RTN","HLOPURGE",110,0)
 ..F  S SUB=$O(^HLB("ERRORS","AE",APP,MSG("DT/TM CREATED"),SUB)) Q:SUB=""  Q:+SUB'=MSGIEN  K ^HLB("ERRORS","AE",APP,MSG("DT/TM CREATED"),SUB)
"RTN","HLOPURGE",111,0)
 ;
"RTN","HLOPURGE",112,0)
 ;kill the whole-file xrefs for the message ien within a batch
"RTN","HLOPURGE",113,0)
 S SUBIEN=0
"RTN","HLOPURGE",114,0)
 F  S SUBIEN=$O(^HLB(MSGIEN,3,SUBIEN)) Q:'SUBIEN  D
"RTN","HLOPURGE",115,0)
 .N MSGID
"RTN","HLOPURGE",116,0)
 .I FS]"" D
"RTN","HLOPURGE",117,0)
 ..N VALUE,HDR2,MSGTYPE,EVENT
"RTN","HLOPURGE",118,0)
 ..S HDR2=$G(^HLB(MSGIEN,3,SUBIEN,2))
"RTN","HLOPURGE",119,0)
 ..S VALUE=$P(HDR2,FS,4)
"RTN","HLOPURGE",120,0)
 ..S MSGTYPE=$P(VALUE,CS)
"RTN","HLOPURGE",121,0)
 ..S EVENT=$P(VALUE,CS,2)
"RTN","HLOPURGE",122,0)
 ..D KSEARCH(.MSG,MSGTYPE,EVENT,SAPP,RAPP,MSGIEN_"^"_SUBIEN)
"RTN","HLOPURGE",123,0)
 .S MSGID=$P($G(^HLB(MSGIEN,3,SUBIEN,0)),"^",2)
"RTN","HLOPURGE",124,0)
 .I MSGID]"" K ^HLB("AE",MSGID,MSGIEN_"^"_SUBIEN)
"RTN","HLOPURGE",125,0)
 ;
"RTN","HLOPURGE",126,0)
 I MSG("DIRECTION")="IN" D
"RTN","HLOPURGE",127,0)
 .Q:FS=""
"RTN","HLOPURGE",128,0)
 .N VALUE,HDR
"RTN","HLOPURGE",129,0)
 .S HDR("SENDING APPLICATION")=$P(MSG("HDR",1),FS,3)
"RTN","HLOPURGE",130,0)
 .S VALUE=$P(MSG("HDR",1),FS,4)
"RTN","HLOPURGE",131,0)
 .S HDR("SENDING FACILITY",1)=$P(VALUE,CS)
"RTN","HLOPURGE",132,0)
 .S HDR("SENDING FACILITY",2)=$P(VALUE,CS,2)
"RTN","HLOPURGE",133,0)
 .S HDR("SENDING FACILITY",3)=$P(VALUE,CS,3)
"RTN","HLOPURGE",134,0)
 .S AC=$S(HDR("SENDING FACILITY",2)]"":HDR("SENDING FACILITY",2),1:HDR("SENDING FACILITY",1))_HDR("SENDING APPLICATION")_MSG("ID")
"RTN","HLOPURGE",135,0)
 K ^HLB(MSGIEN)
"RTN","HLOPURGE",136,0)
 I MSG("STATUS","PURGE"),MSG("DIRECTION")'="" K ^HLB("AD",MSG("DIRECTION"),MSG("STATUS","PURGE"),MSGIEN)
"RTN","HLOPURGE",137,0)
 K:(MSG("ID")]"") ^HLB("B",MSG("ID"),MSGIEN)
"RTN","HLOPURGE",138,0)
 I MSG("DIRECTION")="IN" D
"RTN","HLOPURGE",139,0)
 .K:($G(AC)]"") ^HLB("AC",AC,MSGIEN)
"RTN","HLOPURGE",140,0)
 .I MSG("BODY"),'$G(FLAG) D KILL777(MSG("BODY"))
"RTN","HLOPURGE",141,0)
 I MSG("DIRECTION")="OUT" D
"RTN","HLOPURGE",142,0)
 .K ^HLB("C",+MSG("BODY"),MSGIEN)
"RTN","HLOPURGE",143,0)
 .I '$G(FLAG),'$O(^HLB("C",+MSG("BODY"),0)) D KILL777(MSG("BODY"))
"RTN","HLOPURGE",144,0)
 Q
"RTN","HLOPURGE",145,0)
 ;
"RTN","HLOPURGE",146,0)
KILL777(BODY) ;
"RTN","HLOPURGE",147,0)
 Q:'$G(BODY)
"RTN","HLOPURGE",148,0)
 N TIME
"RTN","HLOPURGE",149,0)
 S TIME=$P($G(^HLA(BODY,0)),"^")
"RTN","HLOPURGE",150,0)
 K ^HLA(BODY)
"RTN","HLOPURGE",151,0)
 K:(TIME]"") ^HLA("B",TIME,BODY)
"RTN","HLOPURGE",152,0)
 Q
"RTN","HLOPURGE",153,0)
 ;
"RTN","HLOPURGE",154,0)
KSEARCH(MSG,MSGTYPE,EVENT,SAPP,RAPP,IEN) ;
"RTN","HLOPURGE",155,0)
 ;Kills the ^HLB("SEARCH") x-ref
"RTN","HLOPURGE",156,0)
 ;
"RTN","HLOPURGE",157,0)
 N APP
"RTN","HLOPURGE",158,0)
 S:MSGTYPE="" MSGTYPE="<none>"
"RTN","HLOPURGE",159,0)
 S:EVENT="" EVENT="<none>"
"RTN","HLOPURGE",160,0)
 Q:'MSG("DT/TM CREATED")
"RTN","HLOPURGE",161,0)
 I MSG("DIRECTION")'="IN",MSG("DIRECTION")'="OUT" Q
"RTN","HLOPURGE",162,0)
 S APP=$S(MSG("DIRECTION")="IN":RAPP,1:SAPP)
"RTN","HLOPURGE",163,0)
 Q:APP=""
"RTN","HLOPURGE",164,0)
 K ^HLB("SEARCH",MSG("DIRECTION"),MSG("DT/TM CREATED"),APP,MSGTYPE,EVENT,IEN)
"RTN","HLOPURGE",165,0)
 Q
"VER")
8.0^22.0
"BLD",1005,6)
^108
**END**
**END**
