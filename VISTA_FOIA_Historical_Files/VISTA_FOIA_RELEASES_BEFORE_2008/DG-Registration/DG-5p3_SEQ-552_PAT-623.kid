Released DG*5.3*623 SEQ #552
Extracted from mail message
**KIDS**:DG*5.3*623^

**INSTALL NAME**
DG*5.3*623
"BLD",5770,0)
DG*5.3*623^REGISTRATION^0^3041001^y
"BLD",5770,1,0)
^^3^3^3041001^
"BLD",5770,1,1,0)
This patch introduces software changes for NOIS issues reported within the
"BLD",5770,1,2,0)
Patient Records Flag module that is part of the Registration V. 5.3 
"BLD",5770,1,3,0)
package.
"BLD",5770,4,0)
^9.64PA^26.11^2
"BLD",5770,4,26.11,0)
26.11
"BLD",5770,4,26.11,2,0)
^9.641^26.11^1
"BLD",5770,4,26.11,2,26.11,0)
PRF LOCAL FLAG  (File-top level)
"BLD",5770,4,26.11,2,26.11,1,0)
^9.6411^.01^1
"BLD",5770,4,26.11,2,26.11,1,.01,0)
NAME
"BLD",5770,4,26.11,222)
y^n^p^^^^n^^n
"BLD",5770,4,26.11,224)

"BLD",5770,4,26.15,0)
26.15
"BLD",5770,4,26.15,2,0)
^9.641^26.15^1
"BLD",5770,4,26.15,2,26.15,0)
PRF NATIONAL FLAG  (File-top level)
"BLD",5770,4,26.15,2,26.15,1,0)
^9.6411^.01^1
"BLD",5770,4,26.15,2,26.15,1,.01,0)
NAME
"BLD",5770,4,26.15,222)
y^n^p^^^^n^^n
"BLD",5770,4,26.15,224)

"BLD",5770,4,"APDD",26.11,26.11)

"BLD",5770,4,"APDD",26.11,26.11,.01)

"BLD",5770,4,"APDD",26.15,26.15)

"BLD",5770,4,"APDD",26.15,26.15,.01)

"BLD",5770,4,"B",26.11,26.11)

"BLD",5770,4,"B",26.15,26.15)

"BLD",5770,"KRN",0)
^9.67PA^8989.52^19
"BLD",5770,"KRN",.4,0)
.4
"BLD",5770,"KRN",.401,0)
.401
"BLD",5770,"KRN",.402,0)
.402
"BLD",5770,"KRN",.403,0)
.403
"BLD",5770,"KRN",.5,0)
.5
"BLD",5770,"KRN",.84,0)
.84
"BLD",5770,"KRN",3.6,0)
3.6
"BLD",5770,"KRN",3.8,0)
3.8
"BLD",5770,"KRN",9.2,0)
9.2
"BLD",5770,"KRN",9.8,0)
9.8
"BLD",5770,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5770,"KRN",9.8,"NM",1,0)
DGPFLMA2^^0^B31940244
"BLD",5770,"KRN",9.8,"NM",2,0)
DGPFLMA3^^0^B56633981
"BLD",5770,"KRN",9.8,"NM","B","DGPFLMA2",1)

"BLD",5770,"KRN",9.8,"NM","B","DGPFLMA3",2)

"BLD",5770,"KRN",19,0)
19
"BLD",5770,"KRN",19.1,0)
19.1
"BLD",5770,"KRN",101,0)
101
"BLD",5770,"KRN",409.61,0)
409.61
"BLD",5770,"KRN",771,0)
771
"BLD",5770,"KRN",870,0)
870
"BLD",5770,"KRN",8989.51,0)
8989.51
"BLD",5770,"KRN",8989.52,0)
8989.52
"BLD",5770,"KRN",8994,0)
8994
"BLD",5770,"KRN","B",.4,.4)

"BLD",5770,"KRN","B",.401,.401)

"BLD",5770,"KRN","B",.402,.402)

"BLD",5770,"KRN","B",.403,.403)

"BLD",5770,"KRN","B",.5,.5)

"BLD",5770,"KRN","B",.84,.84)

"BLD",5770,"KRN","B",3.6,3.6)

"BLD",5770,"KRN","B",3.8,3.8)

"BLD",5770,"KRN","B",9.2,9.2)

"BLD",5770,"KRN","B",9.8,9.8)

"BLD",5770,"KRN","B",19,19)

"BLD",5770,"KRN","B",19.1,19.1)

"BLD",5770,"KRN","B",101,101)

"BLD",5770,"KRN","B",409.61,409.61)

"BLD",5770,"KRN","B",771,771)

"BLD",5770,"KRN","B",870,870)

"BLD",5770,"KRN","B",8989.51,8989.51)

"BLD",5770,"KRN","B",8989.52,8989.52)

"BLD",5770,"KRN","B",8994,8994)

"BLD",5770,"QUES",0)
^9.62^^
"BLD",5770,"REQB",0)
^9.611^1^1
"BLD",5770,"REQB",1,0)
DG*5.3*425^1
"BLD",5770,"REQB","B","DG*5.3*425",1)

"FIA",26.11)
PRF LOCAL FLAG
"FIA",26.11,0)
^DGPF(26.11,
"FIA",26.11,0,0)
26.11I
"FIA",26.11,0,1)
y^n^p^^^^n^^n
"FIA",26.11,0,10)

"FIA",26.11,0,11)

"FIA",26.11,0,"RLRO")

"FIA",26.11,0,"VR")
5.3^DG
"FIA",26.11,26.11)
1
"FIA",26.11,26.11,.01)

"FIA",26.15)
PRF NATIONAL FLAG
"FIA",26.15,0)
^DGPF(26.15,
"FIA",26.15,0,0)
26.15I
"FIA",26.15,0,1)
y^n^p^^^^n^^n
"FIA",26.15,0,10)

"FIA",26.15,0,11)

"FIA",26.15,0,"RLRO")

"FIA",26.15,0,"VR")
5.3^DG
"FIA",26.15,26.15)
1
"FIA",26.15,26.15,.01)

"IX",26.11,26.11,"ASTAT",0)
26.11^ASTAT^This is a sort only index of the STATUS & NAME fields.^R^^R^IR^I^26.11^^^^^S
"IX",26.11,26.11,"ASTAT",1)
S ^DGPF(26.11,"ASTAT",X(1),$E(X(2),1,30),DA)=""
"IX",26.11,26.11,"ASTAT",2)
K ^DGPF(26.11,"ASTAT",X(1),$E(X(2),1,30),DA)
"IX",26.11,26.11,"ASTAT",2.5)
K ^DGPF(26.11,"ASTAT")
"IX",26.11,26.11,"ASTAT",11.1,0)
^.114IA^2^2
"IX",26.11,26.11,"ASTAT",11.1,1,0)
1^F^26.11^.02^^1^F
"IX",26.11,26.11,"ASTAT",11.1,2,0)
2^F^26.11^.01^30^2^F
"IX",26.11,26.11,"ATYP",0)
26.11^ATYP^This is a sort only index of the TYPE and NAME fields.^R^^R^IR^I^26.11^^^^^S
"IX",26.11,26.11,"ATYP",1)
S ^DGPF(26.11,"ATYP",X(1),$E(X(2),1,30),DA)=""
"IX",26.11,26.11,"ATYP",2)
K ^DGPF(26.11,"ATYP",X(1),$E(X(2),1,30),DA)
"IX",26.11,26.11,"ATYP",2.5)
K ^DGPF(26.11,"ATYP")
"IX",26.11,26.11,"ATYP",11.1,0)
^.114IA^2^2
"IX",26.11,26.11,"ATYP",11.1,1,0)
1^F^26.11^.03^^1^F
"IX",26.11,26.11,"ATYP",11.1,1,3)

"IX",26.11,26.11,"ATYP",11.1,2,0)
2^F^26.11^.01^30^2^F
"IX",26.11,26.11,"ATYP",11.1,2,3)

"IX",26.15,26.15,"ASTAT",0)
26.15^ASTAT^This is a sort only index of the STATUS & NAME fields.^R^^R^IR^I^26.15^^^^^S
"IX",26.15,26.15,"ASTAT",1)
S ^DGPF(26.15,"ASTAT",X(1),$E(X(2),1,30),DA)=""
"IX",26.15,26.15,"ASTAT",2)
K ^DGPF(26.15,"ASTAT",X(1),$E(X(2),1,30),DA)
"IX",26.15,26.15,"ASTAT",2.5)
K ^DGPF(26.15,"ASTAT")
"IX",26.15,26.15,"ASTAT",11.1,0)
^.114IA^2^2
"IX",26.15,26.15,"ASTAT",11.1,1,0)
1^F^26.15^.02^^1^F
"IX",26.15,26.15,"ASTAT",11.1,1,3)

"IX",26.15,26.15,"ASTAT",11.1,2,0)
2^F^26.15^.01^30^2^F
"IX",26.15,26.15,"ASTAT",11.1,2,3)

"IX",26.15,26.15,"ATYPE",0)
26.15^ATYPE^This is a sort only index of the TYPE & NAME fields.^R^^R^IR^I^26.15^^^^^S
"IX",26.15,26.15,"ATYPE",1)
S ^DGPF(26.15,"ATYPE",X(1),$E(X(2),1,30),DA)=""
"IX",26.15,26.15,"ATYPE",2)
K ^DGPF(26.15,"ATYPE",X(1),$E(X(2),1,30),DA)
"IX",26.15,26.15,"ATYPE",2.5)
K ^DGPF(26.15,"ATYPE")
"IX",26.15,26.15,"ATYPE",11.1,0)
^.114IA^2^2
"IX",26.15,26.15,"ATYPE",11.1,1,0)
1^F^26.15^.03^^1^F
"IX",26.15,26.15,"ATYPE",11.1,1,3)

"IX",26.15,26.15,"ATYPE",11.1,2,0)
2^F^26.15^.01^30^2^F
"IX",26.15,26.15,"ATYPE",11.1,2,3)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
623^3041001
"PKG",5,22,1,"PAH",1,1,0)
^^3^3^3041001
"PKG",5,22,1,"PAH",1,1,1,0)
This patch introduces software changes for NOIS issues reported within the
"PKG",5,22,1,"PAH",1,1,2,0)
Patient Records Flag module that is part of the Registration V. 5.3 
"PKG",5,22,1,"PAH",1,1,3,0)
package.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","DGPFLMA2")
0^1^B31940244
"RTN","DGPFLMA2",1,0)
DGPFLMA2 ;ALB/KCL - PRF ASSIGNMENT LM PROTOCOL ACTIONS CONT. ; 9/29/04 10:33am
"RTN","DGPFLMA2",2,0)
 ;;5.3;Registration;**425,623**;Aug 13, 1993
"RTN","DGPFLMA2",3,0)
 ;
"RTN","DGPFLMA2",4,0)
 ;no direct entry
"RTN","DGPFLMA2",5,0)
 QUIT
"RTN","DGPFLMA2",6,0)
 ;
"RTN","DGPFLMA2",7,0)
AF ;Entry point for DGPF ASSIGN FLAG action protocol.
"RTN","DGPFLMA2",8,0)
 ;
"RTN","DGPFLMA2",9,0)
 ;  Input:
"RTN","DGPFLMA2",10,0)
 ;     DGDFN - pointer to patient in PATIENT (#2) file
"RTN","DGPFLMA2",11,0)
 ;
"RTN","DGPFLMA2",12,0)
 ; Output:
"RTN","DGPFLMA2",13,0)
 ;   VALMBCK - 'R' = refresh screen
"RTN","DGPFLMA2",14,0)
 ;
"RTN","DGPFLMA2",15,0)
 N DIC,DGWPROOT,DIWETXT,DIWESUB,DWLW,DWPK  ;input vars for EN^DIWE call
"RTN","DGPFLMA2",16,0)
 N DGABORT   ;abort flag for entering assignment narrative
"RTN","DGPFLMA2",17,0)
 N DGOK      ;ok flag for entering assignment narrative
"RTN","DGPFLMA2",18,0)
 N DGPFA     ;assignment array
"RTN","DGPFLMA2",19,0)
 N DGPFAH    ;assignment history array
"RTN","DGPFLMA2",20,0)
 N DGRDAT    ;results of review date calculation
"RTN","DGPFLMA2",21,0)
 N DGRESULT  ;result of STOALL api call
"RTN","DGPFLMA2",22,0)
 N DGREASON  ;reason if unable to add new assignment
"RTN","DGPFLMA2",23,0)
 N DGPFERR   ;if error returned from STOALL api call
"RTN","DGPFLMA2",24,0)
 ;
"RTN","DGPFLMA2",25,0)
 ;set screen to full scrolling region
"RTN","DGPFLMA2",26,0)
 D FULL^VALM1
"RTN","DGPFLMA2",27,0)
 ;
"RTN","DGPFLMA2",28,0)
 D  ;drop out of do block on failure
"RTN","DGPFLMA2",29,0)
 . ;
"RTN","DGPFLMA2",30,0)
 . ;-security key check
"RTN","DGPFLMA2",31,0)
 . I '$D(^XUSEC("DGPF RECORD FLAG ASSIGNMENT",DUZ)) D  Q
"RTN","DGPFLMA2",32,0)
 . . W !!?2,">>> '"_$P($G(XQORNOD(0)),U,3)_"' action not allowed at this point.",*7
"RTN","DGPFLMA2",33,0)
 . . W !?6,"You do not have the appropriate Security Key."
"RTN","DGPFLMA2",34,0)
 . . D PAUSE^VALM1
"RTN","DGPFLMA2",35,0)
 . ;
"RTN","DGPFLMA2",36,0)
 . ;-is action selection allowed?
"RTN","DGPFLMA2",37,0)
 . I '$G(DGDFN) D  Q
"RTN","DGPFLMA2",38,0)
 . . W !!?2,">>> '"_$P($G(XQORNOD(0)),U,3)_"' action not allowed at this point.",*7
"RTN","DGPFLMA2",39,0)
 . . W !?6,"A patient has not been selected."
"RTN","DGPFLMA2",40,0)
 . . D PAUSE^VALM1
"RTN","DGPFLMA2",41,0)
 . ;
"RTN","DGPFLMA2",42,0)
 . ;-init assignment and history arrays
"RTN","DGPFLMA2",43,0)
 . K DGPFA,DGPFAH
"RTN","DGPFLMA2",44,0)
 . ;
"RTN","DGPFLMA2",45,0)
 . ;-get patient DFN into assignment array
"RTN","DGPFLMA2",46,0)
 . S DGPFA("DFN")=$G(DGDFN)
"RTN","DGPFLMA2",47,0)
 . Q:'DGPFA("DFN")
"RTN","DGPFLMA2",48,0)
 . ;
"RTN","DGPFLMA2",49,0)
 . ;-select flag for assignment, quit if not selected
"RTN","DGPFLMA2",50,0)
 . S DGPFA("FLAG")=$$ANSWER^DGPFUT("Select a flag for this assignment","","26.13,.02")
"RTN","DGPFLMA2",51,0)
 . Q:(DGPFA("FLAG")'>0)
"RTN","DGPFLMA2",52,0)
 . ;
"RTN","DGPFLMA2",53,0)
 . ;-check if ok to add new assignment
"RTN","DGPFLMA2",54,0)
 . K DGREASON
"RTN","DGPFLMA2",55,0)
 . I '$$ADDOK^DGPFAA2(DGPFA("DFN"),$P(DGPFA("FLAG"),U),.DGREASON) D  Q
"RTN","DGPFLMA2",56,0)
 . . W !!,"Unable to add new assignment..."_$$LOW^XLFSTR($G(DGREASON))
"RTN","DGPFLMA2",57,0)
 . . D PAUSE^VALM1
"RTN","DGPFLMA2",58,0)
 . ;
"RTN","DGPFLMA2",59,0)
 . ;-if local flag assignment, owner site = current site
"RTN","DGPFLMA2",60,0)
 . ;-else if nat'l flag assignment, prompt for owner site
"RTN","DGPFLMA2",61,0)
 . I DGPFA("FLAG")["26.11" S DGPFA("OWNER")=$P($$SITE^VASITE,U)
"RTN","DGPFLMA2",62,0)
 . E  S DGPFA("OWNER")=$$ANSWER^DGPFUT("Enter Owner Site",$P($$SITE^VASITE,U,2),"P^4:EMZ")
"RTN","DGPFLMA2",63,0)
 . Q:(DGPFA("OWNER")'>0)
"RTN","DGPFLMA2",64,0)
 . ;
"RTN","DGPFLMA2",65,0)
 . ;-prompt user for approved by person, quit if not selected
"RTN","DGPFLMA2",66,0)
 . S DGPFAH("APPRVBY")=$$ANSWER^DGPFUT("Approved By","","P^200:EMZ")
"RTN","DGPFLMA2",67,0)
 . Q:(DGPFAH("APPRVBY")'>0)
"RTN","DGPFLMA2",68,0)
 . ;
"RTN","DGPFLMA2",69,0)
 . ;-have user enter assignment narrative text (required)
"RTN","DGPFLMA2",70,0)
 . S (DGABORT,DGOK)=0
"RTN","DGPFLMA2",71,0)
 . S DGWPROOT=$NA(^TMP($J,"DGPFNARR"))
"RTN","DGPFLMA2",72,0)
 . K @DGWPROOT
"RTN","DGPFLMA2",73,0)
 . F  D  Q:(DGOK!DGABORT)
"RTN","DGPFLMA2",74,0)
 . . W !!,"Enter Narrative Text for this record flag assignment:" ;needed for line editor
"RTN","DGPFLMA2",75,0)
 . . S DIC=$$OREF^DILF(DGWPROOT)
"RTN","DGPFLMA2",76,0)
 . . S DIWETXT="Patient Record Flag - Assignment Narrative Text"
"RTN","DGPFLMA2",77,0)
 . . S DIWESUB="Assignment Narrative Text"
"RTN","DGPFLMA2",78,0)
 . . S DWLW=75 ;max # of chars allowed to be stored on WP global node
"RTN","DGPFLMA2",79,0)
 . . S DWPK=1  ;if line editor, don't join lines
"RTN","DGPFLMA2",80,0)
 . . D EN^DIWE
"RTN","DGPFLMA2",81,0)
 . . I $$CKWP^DGPFUT(DGWPROOT) S DGOK=1 Q
"RTN","DGPFLMA2",82,0)
 . . W !,"Assignment Narrative Text is required!",*7
"RTN","DGPFLMA2",83,0)
 . . I '$$CONTINUE^DGPFUT() S DGABORT=1
"RTN","DGPFLMA2",84,0)
 . . ;
"RTN","DGPFLMA2",85,0)
 . ;-quit if required assignment narrative not entered
"RTN","DGPFLMA2",86,0)
 . Q:$G(DGABORT)
"RTN","DGPFLMA2",87,0)
 . ;
"RTN","DGPFLMA2",88,0)
 . ;-place assignment narrative text into assignment array
"RTN","DGPFLMA2",89,0)
 . M DGPFA("NARR")=@DGWPROOT K @DGWPROOT
"RTN","DGPFLMA2",90,0)
 . ;
"RTN","DGPFLMA2",91,0)
 . ;-setup remaining assignment and history array nodes for filing
"RTN","DGPFLMA2",92,0)
 . S DGPFA("STATUS")=1  ;active
"RTN","DGPFLMA2",93,0)
 . S DGPFA("ORIGSITE")=$P($$SITE^VASITE(),U)  ;current site
"RTN","DGPFLMA2",94,0)
 . S DGPFAH("ASSIGNDT")=$$NOW^XLFDT()  ;current date/time
"RTN","DGPFLMA2",95,0)
 . S DGPFAH("ACTION")=1  ;new assignment
"RTN","DGPFLMA2",96,0)
 . S DGPFAH("ENTERBY")=DUZ  ;current user
"RTN","DGPFLMA2",97,0)
 . S DGPFAH("COMMENT",1,0)="New record flag assignment."
"RTN","DGPFLMA2",98,0)
 . ;
"RTN","DGPFLMA2",99,0)
 . ;-calculate the default review date
"RTN","DGPFLMA2",100,0)
 . S DGRDAT=$$GETRDT^DGPFAA3($P(DGPFA("FLAG"),U),DGPFAH("ASSIGNDT"))
"RTN","DGPFLMA2",101,0)
 . ;
"RTN","DGPFLMA2",102,0)
 . ;-prompt for review date on valid default review date, otherwise null
"RTN","DGPFLMA2",103,0)
 . I DGRDAT>0 D
"RTN","DGPFLMA2",104,0)
 . . S DGPFA("REVIEWDT")=$$ANSWER^DGPFUT("Enter Review Date",$$FMTE^XLFDT(DGRDAT,"5D"),"D^"_DT_":"_DGRDAT_":EX")
"RTN","DGPFLMA2",105,0)
 . E  S DGPFA("REVIEWDT")=""
"RTN","DGPFLMA2",106,0)
 . Q:DGPFA("REVIEWDT")<0
"RTN","DGPFLMA2",107,0)
 . ;
"RTN","DGPFLMA2",108,0)
 . Q:$$ANSWER^DGPFUT("Would you like to file this new record flag assignment","YES","Y")'>0
"RTN","DGPFLMA2",109,0)
 . ;
"RTN","DGPFLMA2",110,0)
 . ;-file the assignment and history using STOALL api
"RTN","DGPFLMA2",111,0)
 . W !,"Filing the patient's new record flag assignment..."
"RTN","DGPFLMA2",112,0)
 . S DGRESULT=$$STOALL^DGPFAA(.DGPFA,.DGPFAH,.DGPFERR)
"RTN","DGPFLMA2",113,0)
 . W !,"   >>> Assignment was "_$S(+$G(DGRESULT):"filed successfully.",1:"not filed successfully.")
"RTN","DGPFLMA2",114,0)
 . ;
"RTN","DGPFLMA2",115,0)
 . ;-- send HL7 message if adding an assignment to a NATIONAL flag
"RTN","DGPFLMA2",116,0)
 . I $G(DGRESULT),DGPFA("FLAG")["26.15",$$SNDORU^DGPFHLS(+DGRESULT) D
"RTN","DGPFLMA2",117,0)
 . . W !,"   >>> HL7 message sent...updating patient's sites of record."
"RTN","DGPFLMA2",118,0)
 . ;
"RTN","DGPFLMA2",119,0)
 . D PAUSE^VALM1
"RTN","DGPFLMA2",120,0)
 . ;
"RTN","DGPFLMA2",121,0)
 . ;-re-build list of flag assignments for patient
"RTN","DGPFLMA2",122,0)
 . D BLDLIST^DGPFLMU(DGDFN)
"RTN","DGPFLMA2",123,0)
 ;
"RTN","DGPFLMA2",124,0)
 ;return to LM (refresh screen)
"RTN","DGPFLMA2",125,0)
 S VALMBCK="R"
"RTN","DGPFLMA2",126,0)
 ;
"RTN","DGPFLMA2",127,0)
 Q
"RTN","DGPFLMA3")
0^2^B56633981
"RTN","DGPFLMA3",1,0)
DGPFLMA3 ;ALB/KCL - PRF ASSIGNMENT LM PROTOCOL ACTIONS CONT. ; 9/29/04 1:13pm
"RTN","DGPFLMA3",2,0)
 ;;5.3;Registration;**425,623**;Aug 13, 1993
"RTN","DGPFLMA3",3,0)
 ;
"RTN","DGPFLMA3",4,0)
 ;no direct entry
"RTN","DGPFLMA3",5,0)
 QUIT
"RTN","DGPFLMA3",6,0)
 ;
"RTN","DGPFLMA3",7,0)
EF ;Entry point for DGPF EDIT FLAG ASSIGNMENT action protocol.
"RTN","DGPFLMA3",8,0)
 ;
"RTN","DGPFLMA3",9,0)
 ;  Input: None
"RTN","DGPFLMA3",10,0)
 ;
"RTN","DGPFLMA3",11,0)
 ; Output:
"RTN","DGPFLMA3",12,0)
 ;   VALMBCK - 'R' = refresh screen
"RTN","DGPFLMA3",13,0)
 ;
"RTN","DGPFLMA3",14,0)
 N DIC,DGWPROOT,DIWETXT,DIWESUB,DWLW,DWPK  ;input vars for EN^DIWE call
"RTN","DGPFLMA3",15,0)
 N DGAROOT   ;assignment narrative word processing root
"RTN","DGPFLMA3",16,0)
 N DGCROOT   ;assignment history comment word processing root
"RTN","DGPFLMA3",17,0)
 N DGABORT   ;abort flag for entering assignment narrative
"RTN","DGPFLMA3",18,0)
 N DGOK      ;ok flag for entering assignment narrative
"RTN","DGPFLMA3",19,0)
 N DGCODE    ;action code
"RTN","DGPFLMA3",20,0)
 N DGDFN     ;pointer to patient in PATIENT (#2) file
"RTN","DGPFLMA3",21,0)
 N DGIEN     ;assignment ien
"RTN","DGPFLMA3",22,0)
 N DGPFA     ;assignment array
"RTN","DGPFLMA3",23,0)
 N DGPFAH    ;assignment history array
"RTN","DGPFLMA3",24,0)
 N DGRDAT    ;review date
"RTN","DGPFLMA3",25,0)
 N DGRESULT  ;result of STOALL api call
"RTN","DGPFLMA3",26,0)
 N DGREASON  ;reason if unable to edit assignment
"RTN","DGPFLMA3",27,0)
 N DGPFERR   ;if error returned from STOALL api call
"RTN","DGPFLMA3",28,0)
 N SEL       ;user selection (list item)
"RTN","DGPFLMA3",29,0)
 N VALMY     ;output of EN^VALM2 call, array of user selected entries
"RTN","DGPFLMA3",30,0)
 ;
"RTN","DGPFLMA3",31,0)
 ;set screen to full scroll region
"RTN","DGPFLMA3",32,0)
 D FULL^VALM1
"RTN","DGPFLMA3",33,0)
 ;
"RTN","DGPFLMA3",34,0)
 ;security key check
"RTN","DGPFLMA3",35,0)
 I '$D(^XUSEC("DGPF RECORD FLAG ASSIGNMENT",DUZ)) D  Q
"RTN","DGPFLMA3",36,0)
 . W !!?2,">>> '"_$P($G(XQORNOD(0)),U,3)_"' action not allowed at this point.",*7
"RTN","DGPFLMA3",37,0)
 . W !?6,"You do not have the appropriate Security Key."
"RTN","DGPFLMA3",38,0)
 . D PAUSE^VALM1
"RTN","DGPFLMA3",39,0)
 . S VALMBCK="R"
"RTN","DGPFLMA3",40,0)
 ;
"RTN","DGPFLMA3",41,0)
 ;is action selection allowed?
"RTN","DGPFLMA3",42,0)
 I '$D(@VALMAR@("IDX")) D  Q
"RTN","DGPFLMA3",43,0)
 . W !!?2,">>> '"_$P($G(XQORNOD(0)),U,3)_"' action not allowed at this point.",*7
"RTN","DGPFLMA3",44,0)
 . I '$G(DGDFN) W !?6,"A patient has not been selected."
"RTN","DGPFLMA3",45,0)
 . E  W !?6,"There are no record flag assignments for this patient."
"RTN","DGPFLMA3",46,0)
 . D PAUSE^VALM1
"RTN","DGPFLMA3",47,0)
 . S VALMBCK="R"
"RTN","DGPFLMA3",48,0)
 ;
"RTN","DGPFLMA3",49,0)
 ;allow user to select a SINGLE flag assignment for editing
"RTN","DGPFLMA3",50,0)
 S (DGIEN,DGSELECT,VALMBCK)=""
"RTN","DGPFLMA3",51,0)
 D EN^VALM2($G(XQORNOD(0)),"S")
"RTN","DGPFLMA3",52,0)
 ;
"RTN","DGPFLMA3",53,0)
 ;process user selection
"RTN","DGPFLMA3",54,0)
 S SEL=$O(VALMY(""))
"RTN","DGPFLMA3",55,0)
 I SEL,$D(@VALMAR@("IDX",SEL,SEL)) D
"RTN","DGPFLMA3",56,0)
 . S DGIEN=$P($G(@VALMAR@("IDX",SEL,SEL)),U)
"RTN","DGPFLMA3",57,0)
 . S DGDFN=$P($G(@VALMAR@("IDX",SEL,SEL)),U,2)
"RTN","DGPFLMA3",58,0)
 . ;
"RTN","DGPFLMA3",59,0)
 . ;-attempt to obtain lock on assignment record
"RTN","DGPFLMA3",60,0)
 . I '$$LOCK^DGPFAA3(DGIEN) D  Q
"RTN","DGPFLMA3",61,0)
 . . W !!,"Record flag assignment currently in use, can not be edited!"
"RTN","DGPFLMA3",62,0)
 . . D PAUSE^VALM1
"RTN","DGPFLMA3",63,0)
 . ;
"RTN","DGPFLMA3",64,0)
 . ;-init word processing arrays 
"RTN","DGPFLMA3",65,0)
 . S DGAROOT=$NA(^TMP($J,"DGPFNARR"))
"RTN","DGPFLMA3",66,0)
 . S DGCROOT=$NA(^TMP($J,"DGPFCMNT"))
"RTN","DGPFLMA3",67,0)
 . K @DGAROOT,@DGCROOT
"RTN","DGPFLMA3",68,0)
 . ;
"RTN","DGPFLMA3",69,0)
 . ;-get PRF assignment into DGPFA array
"RTN","DGPFLMA3",70,0)
 . I '$$GETASGN^DGPFAA(DGIEN,.DGPFA) D  Q
"RTN","DGPFLMA3",71,0)
 . . W !!,"Unable to retrieve the record flag assignment selected."
"RTN","DGPFLMA3",72,0)
 . . D PAUSE^VALM1
"RTN","DGPFLMA3",73,0)
 . ;
"RTN","DGPFLMA3",74,0)
 . ;-is editing of assignment allowed?, quit if not allowed
"RTN","DGPFLMA3",75,0)
 . K DGREASON
"RTN","DGPFLMA3",76,0)
 . I '$$EDTOK^DGPFAA2(.DGPFA,"",.DGREASON) D  Q
"RTN","DGPFLMA3",77,0)
 . . W !!,"Assignment can not be edited..."_$$LOW^XLFSTR($G(DGREASON))
"RTN","DGPFLMA3",78,0)
 . . D PAUSE^VALM1
"RTN","DGPFLMA3",79,0)
 . ;
"RTN","DGPFLMA3",80,0)
 . ;-if assigment is active, set available action codes to 'Continue'
"RTN","DGPFLMA3",81,0)
 . ;   and 'Inactivate', else set action code to 'Reactivate'
"RTN","DGPFLMA3",82,0)
 . I +DGPFA("STATUS")=1 S DGCODE="S^C:Continue Assignment;I:Inactivate Assignment"
"RTN","DGPFLMA3",83,0)
 . E  S DGCODE="S^R:Reactivate Assignment"
"RTN","DGPFLMA3",84,0)
 . ;
"RTN","DGPFLMA3",85,0)
 . ;-prompt user for assignment action, quit if no action selected
"RTN","DGPFLMA3",86,0)
 . S DGPFAH("ACTION")=$$ANSWER^DGPFUT("Select an assignment action","",DGCODE)
"RTN","DGPFLMA3",87,0)
 . Q:(DGPFAH("ACTION")=-1)
"RTN","DGPFLMA3",88,0)
 . S DGPFAH("ACTION")=$S(DGPFAH("ACTION")="C":2,DGPFAH("ACTION")="I":3,DGPFAH("ACTION")="R":4)
"RTN","DGPFLMA3",89,0)
 . ;
"RTN","DGPFLMA3",90,0)
 . ;-if assignment action is 'Inactivate', set status to 'Inactive'
"RTN","DGPFLMA3",91,0)
 . S DGPFA("STATUS")=$S(DGPFAH("ACTION")=3:0,1:1)
"RTN","DGPFLMA3",92,0)
 . ;
"RTN","DGPFLMA3",93,0)
 . ;-if action is not 'Inactivate', then prompt user to edit the narr
"RTN","DGPFLMA3",94,0)
 . I (DGPFAH("ACTION")'=3),(($$ANSWER^DGPFUT("Would you like to edit the assignment narrative","YES","Y")>0)) D
"RTN","DGPFLMA3",95,0)
 . . ;--allow user to edit the assignment narrative (required)
"RTN","DGPFLMA3",96,0)
 . . S (DGABORT,DGOK)=0
"RTN","DGPFLMA3",97,0)
 . . F  D  Q:(DGOK!DGABORT)
"RTN","DGPFLMA3",98,0)
 . . . S DGROOT=$$GET1^DIQ(26.13,DGIEN,"1","Z",DGAROOT)
"RTN","DGPFLMA3",99,0)
 . . . S DIC=$$OREF^DILF(DGAROOT)
"RTN","DGPFLMA3",100,0)
 . . . S DIWETXT="Patient Record Flag - Assignment Narrative Text"
"RTN","DGPFLMA3",101,0)
 . . . S DIWESUB="Assignment Narrative Text"
"RTN","DGPFLMA3",102,0)
 . . . S DWLW=75 ;max # of chars allowed to be stored on WP global node
"RTN","DGPFLMA3",103,0)
 . . . S DWPK=1  ;if line editor, don't join lines
"RTN","DGPFLMA3",104,0)
 . . . D EN^DIWE
"RTN","DGPFLMA3",105,0)
 . . . I $$CKWP^DGPFUT(DGAROOT) S DGOK=1 Q
"RTN","DGPFLMA3",106,0)
 . . . W !,"Assignment Narrative Text is required!",*7
"RTN","DGPFLMA3",107,0)
 . . . I '$$CONTINUE^DGPFUT() S DGABORT=1
"RTN","DGPFLMA3",108,0)
 . . ;
"RTN","DGPFLMA3",109,0)
 . ;-quit if required assignment narrative not entered
"RTN","DGPFLMA3",110,0)
 . Q:$G(DGABORT)
"RTN","DGPFLMA3",111,0)
 . ;
"RTN","DGPFLMA3",112,0)
 . ;-if narrative edited, place new narrative into DGPFA array
"RTN","DGPFLMA3",113,0)
 . I $G(DGOK) D
"RTN","DGPFLMA3",114,0)
 . . K DGPFA("NARR")  ;remove old narrative text
"RTN","DGPFLMA3",115,0)
 . . M DGPFA("NARR")=@DGAROOT K @DGAROOT
"RTN","DGPFLMA3",116,0)
 . ;
"RTN","DGPFLMA3",117,0)
 . ;-prompt user for 'Approved By' person, quit if not selected
"RTN","DGPFLMA3",118,0)
 . S DGPFAH("APPRVBY")=$$ANSWER^DGPFUT("Approved By","","P^200:EMZ")
"RTN","DGPFLMA3",119,0)
 . Q:(DGPFAH("APPRVBY")'>0)
"RTN","DGPFLMA3",120,0)
 . ;
"RTN","DGPFLMA3",121,0)
 . ;-have user enter the edit reason/history comments (required)
"RTN","DGPFLMA3",122,0)
 . S (DGABORT,DGOK)=0
"RTN","DGPFLMA3",123,0)
 . F  D  Q:(DGOK!DGABORT)
"RTN","DGPFLMA3",124,0)
 . . W !!,"Enter the reason for editing this assignment:"  ;needed for line editor
"RTN","DGPFLMA3",125,0)
 . . S DIC=$$OREF^DILF(DGCROOT)
"RTN","DGPFLMA3",126,0)
 . . S DIWETXT="Patient Record Flag - Edit Reason Text"
"RTN","DGPFLMA3",127,0)
 . . S DIWESUB="Edit Reason Text"
"RTN","DGPFLMA3",128,0)
 . . S DWLW=75 ;max # of chars allowed to be stored on WP global node
"RTN","DGPFLMA3",129,0)
 . . S DWPK=1  ;if line editor, don't join lines
"RTN","DGPFLMA3",130,0)
 . . D EN^DIWE
"RTN","DGPFLMA3",131,0)
 . . I $$CKWP^DGPFUT(DGCROOT) S DGOK=1 Q
"RTN","DGPFLMA3",132,0)
 . . W !,"Edit Reason is required!",*7
"RTN","DGPFLMA3",133,0)
 . . I '$$CONTINUE^DGPFUT() S DGABORT=1
"RTN","DGPFLMA3",134,0)
 . ;
"RTN","DGPFLMA3",135,0)
 . ;-quit if required edit reason/history comments not entered
"RTN","DGPFLMA3",136,0)
 . Q:$G(DGABORT)
"RTN","DGPFLMA3",137,0)
 . ;
"RTN","DGPFLMA3",138,0)
 . ;-place comments into history array
"RTN","DGPFLMA3",139,0)
 . M DGPFAH("COMMENT")=@DGCROOT K @DGCROOT
"RTN","DGPFLMA3",140,0)
 . ;
"RTN","DGPFLMA3",141,0)
 . ;-setup remaining assignment history nodes for filing
"RTN","DGPFLMA3",142,0)
 . S DGPFAH("ASSIGNDT")=$$NOW^XLFDT()  ;current date/time
"RTN","DGPFLMA3",143,0)
 . S DGPFAH("ENTERBY")=DUZ             ;current user
"RTN","DGPFLMA3",144,0)
 . ;
"RTN","DGPFLMA3",145,0)
 . ;-calculate the default review date
"RTN","DGPFLMA3",146,0)
 . S DGRDAT=$$GETRDT^DGPFAA3($P(DGPFA("FLAG"),U),DGPFAH("ASSIGNDT"))
"RTN","DGPFLMA3",147,0)
 . ;
"RTN","DGPFLMA3",148,0)
 . ;-prompt for review date when valid default review date and ACTIVE
"RTN","DGPFLMA3",149,0)
 . ; status, otherwise null
"RTN","DGPFLMA3",150,0)
 . I DGRDAT>0,DGPFA("STATUS")=1 D
"RTN","DGPFLMA3",151,0)
 . . S DGPFA("REVIEWDT")=$$ANSWER^DGPFUT("Enter Review Date",$$FMTE^XLFDT(DGRDAT,"5D"),"D^"_DT_":"_DGRDAT_":EX")
"RTN","DGPFLMA3",152,0)
 . E  S DGPFA("REVIEWDT")=""
"RTN","DGPFLMA3",153,0)
 . Q:DGPFA("REVIEWDT")<0
"RTN","DGPFLMA3",154,0)
 . ;
"RTN","DGPFLMA3",155,0)
 . Q:$$ANSWER^DGPFUT("Would you like to file the assignment changes","YES","Y")'>0
"RTN","DGPFLMA3",156,0)
 . ;
"RTN","DGPFLMA3",157,0)
 . ;-file the assignment and history using STOALL api
"RTN","DGPFLMA3",158,0)
 . W !,"Updating the patient's record flag assignment..."
"RTN","DGPFLMA3",159,0)
 . S DGRESULT=$$STOALL^DGPFAA(.DGPFA,.DGPFAH,.DGPFERR)
"RTN","DGPFLMA3",160,0)
 . W !,"   >>> Assignment was "_$S(+$G(DGRESULT):"filed successfully.",1:"not filed successfully.")
"RTN","DGPFLMA3",161,0)
 . ;
"RTN","DGPFLMA3",162,0)
 . ;-- send HL7 message if editing assignment to a NATIONAL flag
"RTN","DGPFLMA3",163,0)
 . I $G(DGRESULT),DGPFA("FLAG")["26.15",$$SNDORU^DGPFHLS(+DGRESULT) D
"RTN","DGPFLMA3",164,0)
 . . W !,"   >>> HL7 message sent...updating patient's sites of record."
"RTN","DGPFLMA3",165,0)
 . ;
"RTN","DGPFLMA3",166,0)
 . D PAUSE^VALM1
"RTN","DGPFLMA3",167,0)
 . ;
"RTN","DGPFLMA3",168,0)
 . ;-re-build list of flag assignments for patient
"RTN","DGPFLMA3",169,0)
 . D BLDLIST^DGPFLMU(DGDFN)
"RTN","DGPFLMA3",170,0)
 . ;
"RTN","DGPFLMA3",171,0)
 . ;-release lock after edit
"RTN","DGPFLMA3",172,0)
 . D UNLOCK^DGPFAA3(DGIEN)
"RTN","DGPFLMA3",173,0)
 ;
"RTN","DGPFLMA3",174,0)
 ;return to LM (refresh screen)
"RTN","DGPFLMA3",175,0)
 S VALMBCK="R"
"RTN","DGPFLMA3",176,0)
 ;
"RTN","DGPFLMA3",177,0)
 Q
"VER")
8.0^22
"^DD",26.11,26.11,.01,0)
NAME^RFXI^^0;1^S X=$$UP^XLFSTR(X) K:$E(X)'?1U!($E(X,$L(X))?1P)!($L(X)>30)!($L(X)<3)!'($TR(X," ","")?1U.UN) X
"^DD",26.11,26.11,.01,.1)
PATIENT RECORD FLAG NAME
"^DD",26.11,26.11,.01,1,0)
^.1
"^DD",26.11,26.11,.01,1,1,0)
26.11^B
"^DD",26.11,26.11,.01,1,1,1)
S ^DGPF(26.11,"B",$E(X,1,30),DA)=""
"^DD",26.11,26.11,.01,1,1,2)
K ^DGPF(26.11,"B",$E(X,1,30),DA)
"^DD",26.11,26.11,.01,3)
Answer must be 3-30 characters in length.  No punctuation characters except spaces may be used.  No leading or trailing spaces.  Can contain numbers but not in the first position.
"^DD",26.11,26.11,.01,21,0)
^.001^1^1^3040331^^^^
"^DD",26.11,26.11,.01,21,1,0)
This field contains the locally assigned name of the Patient Record Flag.
"^DD",26.11,26.11,.01,"DT")
3040331
"^DD",26.15,26.15,.01,0)
NAME^RFIX^^0;1^S X=$$UP^XLFSTR(X) K:$E(X)'?1U!($E(X,$L(X))?1P)!($L(X)>30)!($L(X)<3)!'($TR(X," ","")?1U.UN) X
"^DD",26.15,26.15,.01,1,0)
^.1
"^DD",26.15,26.15,.01,1,1,0)
26.15^B
"^DD",26.15,26.15,.01,1,1,1)
S ^DGPF(26.15,"B",$E(X,1,30),DA)=""
"^DD",26.15,26.15,.01,1,1,2)
K ^DGPF(26.15,"B",$E(X,1,30),DA)
"^DD",26.15,26.15,.01,3)
Answer must be 3-30 characters in length.  No punctuation characters except spaces may be used.  No leading or trailing spaces.  Can contain numbers but not in the first position.
"^DD",26.15,26.15,.01,21,0)
^.001^2^2^3040203^^^^
"^DD",26.15,26.15,.01,21,1,0)
This field contains the nationally assigned name of the Patient Record 
"^DD",26.15,26.15,.01,21,2,0)
Flag.
"^DD",26.15,26.15,.01,"DT")
3040331
**END**
**END**
