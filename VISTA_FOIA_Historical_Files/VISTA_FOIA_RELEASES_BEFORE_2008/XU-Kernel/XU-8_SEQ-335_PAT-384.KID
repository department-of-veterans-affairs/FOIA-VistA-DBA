Released XU*8*384 SEQ #335
Extracted from mail message
**KIDS**:XU*8.0*384^

**INSTALL NAME**
XU*8.0*384
"BLD",874,0)
XU*8.0*384^KERNEL^0^3060112^y
"BLD",874,1,0)
^^2^2^3050622^
"BLD",874,1,1,0)
Kernel Patch XU*8.0*384. Please refer to the Description in Forum Patch 
"BLD",874,1,2,0)
Module for details.
"BLD",874,4,0)
^9.64PA^^
"BLD",874,6.3)
8
"BLD",874,"ABPKG")
n
"BLD",874,"INID")
^n
"BLD",874,"INIT")
XU8P387
"BLD",874,"KRN",0)
^9.67PA^8989.52^19
"BLD",874,"KRN",.4,0)
.4
"BLD",874,"KRN",.401,0)
.401
"BLD",874,"KRN",.402,0)
.402
"BLD",874,"KRN",.403,0)
.403
"BLD",874,"KRN",.5,0)
.5
"BLD",874,"KRN",.84,0)
.84
"BLD",874,"KRN",3.6,0)
3.6
"BLD",874,"KRN",3.6,"NM",0)
^9.68A^1^1
"BLD",874,"KRN",3.6,"NM",1,0)
XUSERDEAC^^0
"BLD",874,"KRN",3.6,"NM","B","XUSERDEAC",1)

"BLD",874,"KRN",3.8,0)
3.8
"BLD",874,"KRN",3.8,"NM",0)
^9.68A^1^1
"BLD",874,"KRN",3.8,"NM",1,0)
XUSEC/PRS PAID SEPARATION^^0
"BLD",874,"KRN",3.8,"NM","B","XUSEC/PRS PAID SEPARATION",1)

"BLD",874,"KRN",9.2,0)
9.2
"BLD",874,"KRN",9.8,0)
9.8
"BLD",874,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",874,"KRN",9.8,"NM",1,0)
XUSTERM^^0^19985590
"BLD",874,"KRN",9.8,"NM",2,0)
XUSTERM1^^0^24004727
"BLD",874,"KRN",9.8,"NM",3,0)
XU8P387^^0^2084080
"BLD",874,"KRN",9.8,"NM",4,0)
XU8P387X^^0^2745871
"BLD",874,"KRN",9.8,"NM",5,0)
XUSECBUL^^0^2500056
"BLD",874,"KRN",9.8,"NM","B","XU8P387",3)

"BLD",874,"KRN",9.8,"NM","B","XU8P387X",4)

"BLD",874,"KRN",9.8,"NM","B","XUSECBUL",5)

"BLD",874,"KRN",9.8,"NM","B","XUSTERM",1)

"BLD",874,"KRN",9.8,"NM","B","XUSTERM1",2)

"BLD",874,"KRN",19,0)
19
"BLD",874,"KRN",19.1,0)
19.1
"BLD",874,"KRN",101,0)
101
"BLD",874,"KRN",409.61,0)
409.61
"BLD",874,"KRN",771,0)
771
"BLD",874,"KRN",870,0)
870
"BLD",874,"KRN",8989.51,0)
8989.51
"BLD",874,"KRN",8989.52,0)
8989.52
"BLD",874,"KRN",8994,0)
8994
"BLD",874,"KRN","B",.4,.4)

"BLD",874,"KRN","B",.401,.401)

"BLD",874,"KRN","B",.402,.402)

"BLD",874,"KRN","B",.403,.403)

"BLD",874,"KRN","B",.5,.5)

"BLD",874,"KRN","B",.84,.84)

"BLD",874,"KRN","B",3.6,3.6)

"BLD",874,"KRN","B",3.8,3.8)

"BLD",874,"KRN","B",9.2,9.2)

"BLD",874,"KRN","B",9.8,9.8)

"BLD",874,"KRN","B",19,19)

"BLD",874,"KRN","B",19.1,19.1)

"BLD",874,"KRN","B",101,101)

"BLD",874,"KRN","B",409.61,409.61)

"BLD",874,"KRN","B",771,771)

"BLD",874,"KRN","B",870,870)

"BLD",874,"KRN","B",8989.51,8989.51)

"BLD",874,"KRN","B",8989.52,8989.52)

"BLD",874,"KRN","B",8994,8994)

"BLD",874,"QUES",0)
^9.62^^
"INIT")
XU8P387
"KRN",3.6,62,-1)
0^1
"KRN",3.6,62,0)
XUSERDEAC^XUSER DEACTIVATION
"KRN",3.6,62,1,0)
^3.61A^6^6^3060110^^
"KRN",3.6,62,1,1,0)
 
"KRN",3.6,62,1,2,0)
      User name : |1|
"KRN",3.6,62,1,3,0)
      Title     : |2|
"KRN",3.6,62,1,4,0)
      Service   : |3|
"KRN",3.6,62,1,5,0)
 
"KRN",3.6,62,1,6,0)
was deactivated on |4|.
"KRN",3.6,62,3,0)
^3.63^2^2^3060110^^^^
"KRN",3.6,62,3,1,0)
This bulletin will be sent to an assigned mail Group when a user get 
"KRN",3.6,62,3,2,0)
deactivated.
"KRN",3.6,62,4,0)
^3.64A^4^4
"KRN",3.6,62,4,1,0)
1
"KRN",3.6,62,4,1,1,0)
^^1^1^3050608^
"KRN",3.6,62,4,1,1,1,0)
Name of user who gets deactivated.
"KRN",3.6,62,4,2,0)
2
"KRN",3.6,62,4,2,1,0)
^^1^1^3060110^
"KRN",3.6,62,4,2,1,1,0)
Title.
"KRN",3.6,62,4,3,0)
3
"KRN",3.6,62,4,3,1,0)
^^1^1^3060110^
"KRN",3.6,62,4,3,1,1,0)
Service.
"KRN",3.6,62,4,4,0)
4
"KRN",3.6,62,4,4,1,0)
^^1^1^3060110^
"KRN",3.6,62,4,4,1,1,0)
Date of user gets deactivated.
"KRN",3.8,46,-1)
0^1
"KRN",3.8,46,0)
XUSEC/PRS PAID SEPARATION^PU^n^^^^
"KRN",3.8,46,2,0)
^^1^1^3060112^
"KRN",3.8,46,2,1,0)
This is the mail group that will receive separation notices.
"KRN",3.8,46,3)

"MBREQ")
0
"ORD",2,3.6)
3.6;2;1;;BUL^XPDTA1;;BULE1^XPDIA1;;;BULDEL^XPDIA1
"ORD",2,3.6,0)
BULLETIN
"ORD",11,3.8)
3.8;11;;;MAILG^XPDTA1;MAILGF1^XPDIA1;MAILGE1^XPDIA1;MAILGF2^XPDIA1;;MAILGDEL^XPDIA1(%)
"ORD",11,3.8,0)
MAIL GROUP
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^3051215^2970507^.5
"PKG",3,22,1,"PAH",1,0)
384^3060112
"PKG",3,22,1,"PAH",1,1,0)
^^2^2^3060112
"PKG",3,22,1,"PAH",1,1,1,0)
Kernel Patch XU*8.0*384. Please refer to the Description in Forum Patch 
"PKG",3,22,1,"PAH",1,1,2,0)
Module for details.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","XU8P387")
0^3^B2084080
"RTN","XU8P387",1,0)
XU8P387 ;SFISC/SO- POST INSTALL CLEAN UP XREF AUSER ;5:41 AM  30 Nov 2005
"RTN","XU8P387",2,0)
 ;;8.0;KERNEL;**384**;Jul 10, 1995;Build 8
"RTN","XU8P387",3,0)
 ;
"RTN","XU8P387",4,0)
 D ^XU8P387X ;Install the fixed xref
"RTN","XU8P387",5,0)
 ;
"RTN","XU8P387",6,0)
 ;Clean up AUSER xref
"RTN","XU8P387",7,0)
 ;
"RTN","XU8P387",8,0)
 N IEN S IEN=0
"RTN","XU8P387",9,0)
 N XUDT540 S XUDT540=$$HTFM^XLFDT($H-540,1)
"RTN","XU8P387",10,0)
 F  S IEN=$O(^VA(200,IEN)) Q:'IEN  D
"RTN","XU8P387",11,0)
 . I IEN<1 Q
"RTN","XU8P387",12,0)
 . N DIK,DA
"RTN","XU8P387",13,0)
 . S DA=IEN
"RTN","XU8P387",14,0)
 . S DIK="^VA(200,",DIK(1)=".01^AUSER"
"RTN","XU8P387",15,0)
 . D EN1^DIK
"RTN","XU8P387",16,0)
 . ;
"RTN","XU8P387",17,0)
 . ;Check to see if DISUERed, But last sign-on is within 540 days
"RTN","XU8P387",18,0)
 . I '$D(^VA(200,IEN,0))#2 Q  ;Missing Zeroth node
"RTN","XU8P387",19,0)
 . N NAME,LDATE,DISUER
"RTN","XU8P387",20,0)
 . S NAME=$P(^VA(200,IEN,0),U)
"RTN","XU8P387",21,0)
 . I NAME="" Q  ; Entry has null .01 field
"RTN","XU8P387",22,0)
 . S LDATE=$P($G(^VA(200,IEN,1.1)),U) ;Get last sign-on
"RTN","XU8P387",23,0)
 . S DISUSER=$P(^VA(200,IEN,0),U,7) ;DISUER FLAG
"RTN","XU8P387",24,0)
 . I $D(^VA(200,"AUSER",NAME,IEN)) Q  ;Entry already indexed
"RTN","XU8P387",25,0)
 . I $D(^XUSEC("XUORES",IEN)) S ^VA(200,"AUSER",NAME,IEN)="" Q
"RTN","XU8P387",26,0)
 . I DISUSER,LDATE'<XUDT540,DISUSER S ^VA(200,"AUSER",NAME,IEN)=""
"RTN","XU8P387",27,0)
 . Q
"RTN","XU8P387",28,0)
 Q
"RTN","XU8P387X")
0^4^B2745871
"RTN","XU8P387X",1,0)
XU8P387X ;FISC/SO-CREATE NEW-STYLE XREF ;5:27 AM  28 Nov 2005
"RTN","XU8P387X",2,0)
 ;;8.0;KERNEL;**384**;Jul 10, 1995;Build 8
"RTN","XU8P387X",3,0)
 ;
"RTN","XU8P387X",4,0)
 N XUXXXR,XUXXRES,XUXXOUT
"RTN","XU8P387X",5,0)
 S XUXXXR("FILE")=200
"RTN","XU8P387X",6,0)
 S XUXXXR("NAME")="AUSER"
"RTN","XU8P387X",7,0)
 S XUXXXR("TYPE")="MU"
"RTN","XU8P387X",8,0)
 S XUXXXR("USE")="S"
"RTN","XU8P387X",9,0)
 S XUXXXR("EXECUTION")="R"
"RTN","XU8P387X",10,0)
 S XUXXXR("ACTIVITY")="IR"
"RTN","XU8P387X",11,0)
 S XUXXXR("SHORT DESCR")="Build cross reference of active users"
"RTN","XU8P387X",12,0)
 S XUXXXR("DESCR",1)="This is a cross reference of CPRS Active USERs (AUSER):"
"RTN","XU8P387X",13,0)
 S XUXXXR("DESCR",2)=" "
"RTN","XU8P387X",14,0)
 S XUXXXR("DESCR",3)=" The cross reference is in the format:"
"RTN","XU8P387X",15,0)
 S XUXXXR("DESCR",4)=" ^VA(200,""AUSER"",<NAME(#.01) value>,IEN)="""""
"RTN","XU8P387X",16,0)
 S XUXXXR("SET")="I DA'<1,$$PROVIDER^XUSER(DA),X(1)]"""",X(3)<1 S ^VA(200,""AUSER"",X(1),DA)="""" Q"
"RTN","XU8P387X",17,0)
 S XUXXXR("KILL")="I ((DA'<1&X1(1)'=X2(1))!(DA'<1&X2(2)="""")) K ^VA(200,""AUSER"",X1(1),DA)"
"RTN","XU8P387X",18,0)
 S XUXXXR("WHOLE KILL")="K ^VA(200,""AUSER"")"
"RTN","XU8P387X",19,0)
 S XUXXXR("SET CONDITION")="Q"
"RTN","XU8P387X",20,0)
 S XUXXXR("KILL CONDITION")="Q"
"RTN","XU8P387X",21,0)
 S XUXXXR("VAL",1)=.01
"RTN","XU8P387X",22,0)
 S XUXXXR("VAL",1,"COLLATION")="F"
"RTN","XU8P387X",23,0)
 S XUXXXR("VAL",2)=2
"RTN","XU8P387X",24,0)
 S XUXXXR("VAL",2,"COLLATION")="F"
"RTN","XU8P387X",25,0)
 S XUXXXR("VAL",3)=7
"RTN","XU8P387X",26,0)
 S XUXXXR("VAL",3,"COLLATION")="F"
"RTN","XU8P387X",27,0)
 D CREIXN^DDMOD(.XUXXXR,"SW",.XUXXRES,"XUXXOUT")
"RTN","XU8P387X",28,0)
 Q
"RTN","XUSECBUL")
0^5^B2500056
"RTN","XUSECBUL",1,0)
XUSECBUL ;SFISC/BT-SEND SEPARATION MESSAGE TO G.XUSEC/PRS PAID SEPARATION ;10 AM  10 Jan 2006
"RTN","XUSECBUL",2,0)
 ;;8.0;KERNEL;**384**;Jul 10, 1995;Build 8
"RTN","XUSECBUL",3,0)
 N TMP,NAME,SSN,SERVICE,MSGSBJ,WHO,LN,OUT,IEN200
"RTN","XUSECBUL",4,0)
 S (NAME,SSN,SERVICE,OUT)=""
"RTN","XUSECBUL",5,0)
 D  I OUT'="Y" Q  ;Person's 'SEPARATION IND' not equal to Y
"RTN","XUSECBUL",6,0)
 . N DIERR,IENS,Z,ZERR
"RTN","XUSECBUL",7,0)
 . S IENS=DA_","
"RTN","XUSECBUL",8,0)
 . D GETS^DIQ(450,IENS,".01;8;80;700","EI","Z","ZERR")
"RTN","XUSECBUL",9,0)
 . S OUT=Z(450,IENS,80,"E")
"RTN","XUSECBUL",10,0)
 . I OUT'="Y" Q
"RTN","XUSECBUL",11,0)
 . S NAME=Z(450,IENS,.01,"E")
"RTN","XUSECBUL",12,0)
 . S SSN="***-**-"_$P(Z(450,IENS,8,"E"),"-",3)
"RTN","XUSECBUL",13,0)
 . I Z(450,IENS,700,"I") S SERVICE=$$GET1^DIQ(200,Z(450,IENS,700,"I")_",",29,"","","ZERR"),IEN200=Z(450,IENS,700,"I")
"RTN","XUSECBUL",14,0)
 . Q
"RTN","XUSECBUL",15,0)
 I +IEN200,'$$ACTIVE^XUSER(+IEN200) Q
"RTN","XUSECBUL",16,0)
 ; Mail back message
"RTN","XUSECBUL",17,0)
 S LN=1
"RTN","XUSECBUL",18,0)
 S TMP(LN)=NAME_" ("_SSN_") separated from "_SERVICE_".",LN=LN+1
"RTN","XUSECBUL",19,0)
 S TMP(LN)="Please terminate the employee.",LN=LN+1
"RTN","XUSECBUL",20,0)
 S WHO(DUZ)=""
"RTN","XUSECBUL",21,0)
 I $$GOTLOCAL^XMXAPIG("XUSEC/PRS PAID SEPARATION") S WHO("G.XUSEC/PRS PAID SEPARATION")=""
"RTN","XUSECBUL",22,0)
 S MSGSBJ="Employee ("_NAME_") Seperated From Station Notification"
"RTN","XUSECBUL",23,0)
 ;
"RTN","XUSECBUL",24,0)
SEND D SENDMSG^XMXAPI(DUZ,MSGSBJ,"TMP",.WHO)
"RTN","XUSECBUL",25,0)
 D CLEAN^DILF
"RTN","XUSECBUL",26,0)
 Q
"RTN","XUSTERM")
0^1^B19985590^B19864984
"RTN","XUSTERM",1,0)
XUSTERM ;SEA/AMF/WDE - DEACTIVATE USER ; [6/22/05 12:30pm]
"RTN","XUSTERM",2,0)
 ;;8.0;KERNEL;**36,73,135,148,169,222,313,384**;Jul 10, 1995;Build 8
"RTN","XUSTERM",3,0)
LKUP N DIRUT,DIC,DIR,XUDA,DA
"RTN","XUSTERM",4,0)
 S DIC=200,DIC("S")="I $L($P(^(0),U,3))",DIC(0)="AEQMZ",DIC("A")="Select USER to be deactivated: "
"RTN","XUSTERM",5,0)
 D ^DIC K DIC G END:Y<0 S XUDA=+Y
"RTN","XUSTERM",6,0)
 D INQ Q:$D(DIRUT)
"RTN","XUSTERM",7,0)
 S DA=XUDA,DIE=200,DR="["_$$GET^XUPARAM("XUSERDEACT","N")_"]" D GET,XUDIE^XUS5
"RTN","XUSTERM",8,0)
 S XUDT=$P(^VA(200,DA,0),U,11),XUACT=XUDT&(XUDT>DT) G END:'XUDT
"RTN","XUSTERM",9,0)
 G:XUACT WHEN G NOW
"RTN","XUSTERM",10,0)
 ;
"RTN","XUSTERM",11,0)
WHEN W !!,XUNAM," will be deactivated on date specified."
"RTN","XUSTERM",12,0)
 S ZTDTH=XUDT,ZTRTN="DQ1^XUSTERM1",ZTDESC="DEACTIVATE USER",ZTSAVE("XUDA")="",ZTIO="" D ^%ZTLOAD
"RTN","XUSTERM",13,0)
 G END
"RTN","XUSTERM",14,0)
 ;
"RTN","XUSTERM",15,0)
NOW S DIR("A")=XUNAM_" will be deactivated now.  Do you wish to proceed",DIR("B")="YES",DIR("??")="XUUSER-DEACT",DIR(0)="Y"
"RTN","XUSTERM",16,0)
 D ^DIR I "Yy"'[$E(X_U) S XUDT=$$NOW^XLFDT G WHEN
"RTN","XUSTERM",17,0)
 W ! S XUVE=1 D ACT
"RTN","XUSTERM",18,0)
 G END
"RTN","XUSTERM",19,0)
 ;
"RTN","XUSTERM",20,0)
INQ ;Ask to show User Inquiry
"RTN","XUSTERM",21,0)
 N DIR,DIC,FLDS,BY,FR,TO,Y,L
"RTN","XUSTERM",22,0)
 S DIR(0)="Y",DIR("A")="View/Print User Inquiry Data",DIR("B")="Yes" D ^DIR Q:$D(DIRUT)!('Y)
"RTN","XUSTERM",23,0)
 S L=0,DIC=200,FLDS="[XUSERINQ]",BY="NUMBER",(TO,FR)=XUDA D EN1^DIP K DIC
"RTN","XUSTERM",24,0)
 K DIR S DIR(0)="E" D ^DIR
"RTN","XUSTERM",25,0)
 Q
"RTN","XUSTERM",26,0)
 ;
"RTN","XUSTERM",27,0)
GET ;XUGRP=mail group, XUKEY=keys, XUSUR=mail surrogates, XUJ=# baskets, XUK=# mail msg, XUIN=# in-basket msg
"RTN","XUSTERM",28,0)
 ;XUTX1, XUTX2 used in edit templates
"RTN","XUSTERM",29,0)
 K XUGRP,XUKEY,XUSUR,XUTX1,XUTX2 N %,XU10,XU11,XU20,XU21,XU30,XU31
"RTN","XUSTERM",30,0)
 S (XU10,XU20)=0,(XU11,XU21,XU31)=""
"RTN","XUSTERM",31,0)
 S DA=XUDA,XUNAM=$P(^VA(200,XUDA,0),U,1)
"RTN","XUSTERM",32,0)
 F XUI=0:0 S XUI=$O(^XMB(3.8,"AB",XUDA,XUI)) Q:XUI'>0  D  ;Mail groups
"RTN","XUSTERM",33,0)
 . S XUK=^XMB(3.8,XUI,0) S:'$L($P(XUK,U,2)) $P(XUK,U,2)="PU"
"RTN","XUSTERM",34,0)
 . S XUGRP(XUI)=$P(XUK,U,1,2)_U_$S('$D(^XMB(3.8,XUI,3)):0,1:^(3)=XUDA)
"RTN","XUSTERM",35,0)
 . S XU10=XU10+1 S:$L(XU11)<70 XU11=XU11_","_$P(XUK,U)
"RTN","XUSTERM",36,0)
 F XUI=0:0 S XUI=$O(^VA(200,XUDA,51,XUI)) Q:XUI'>0  D  ;Get keys
"RTN","XUSTERM",37,0)
 . S %=$G(^DIC(19.1,XUI,0)),XU20=XU20+1
"RTN","XUSTERM",38,0)
 . S:$L(XU21)<70 XU21=XU21_","_$P(%,U)
"RTN","XUSTERM",39,0)
 . Q:$P(%,U,4)="y"  ;Don't count keep at terminate keys
"RTN","XUSTERM",40,0)
 . S XUKEY(XUI)=""
"RTN","XUSTERM",41,0)
 F XUI=0:0 S XUI=$O(^XMB(3.7,"AB",XUDA,XUI)) Q:XUI'>0  D
"RTN","XUSTERM",42,0)
 . S XUSUR(XUI)="" S:$L(XU31)<70 XU31=XU31_","_$P(^VA(200,XUI,0),U)
"RTN","XUSTERM",43,0)
 S (XUJ,XUK,XUIN,XUNUM)=0
"RTN","XUSTERM",44,0)
 F I=.9:0 S I=$O(^XMB(3.7,XUDA,2,I)) Q:I'>0  D
"RTN","XUSTERM",45,0)
 . S XUJ=XUJ+1,XUNUM=$P($G(^XMB(3.7,XUDA,2,I,1,0)),U,4)
"RTN","XUSTERM",46,0)
 . S:XUNUM>0 XUK=XUK+XUNUM S:I=1 XUIN=XUNUM
"RTN","XUSTERM",47,0)
 . Q
"RTN","XUSTERM",48,0)
 S XUTX1(1)="User has "_XUK_" messages in "_XUJ_" baskets, Member of "_XU10_" Mail Groups."
"RTN","XUSTERM",49,0)
 S:XU10 XUTX1(2)="Mail Groups: "_$E(XU11,2,80) S:$L(XU31) XUTX1(3)="Surrogate for: "_$E(XU31,2,80)
"RTN","XUSTERM",50,0)
 S XUTX2(1)="User has "_XU20_" keys" S:XU20 XUTX2(2)=$E(XU21,2,80)
"RTN","XUSTERM",51,0)
 S XUEMP='($D(XUSUR)!$D(XUKEY)!$D(XUGRP)!XUJ!XUK!XUIN!$L($P(^VA(200,XUDA,0),U,3)))
"RTN","XUSTERM",52,0)
 Q
"RTN","XUSTERM",53,0)
ACT ;First let others clean-up, Then do our part.
"RTN","XUSTERM",54,0)
 ;D ^XUSTERM2 ;Cleanup by other packages.
"RTN","XUSTERM",55,0)
 N DIC,DA,DIE,DR
"RTN","XUSTERM",56,0)
 L +^VA(200,XUDA,0):6
"RTN","XUSTERM",57,0)
 ;Delete some fields first.
"RTN","XUSTERM",58,0)
 ;Access;Verify;PAC;Last signon;SMD delegate;electronic signature,Primary menu,Hinq Employee #
"RTN","XUSTERM",59,0)
 S DIE=200,DA=XUDA,DR="2///@;11///@;14///@;1.1///@;19///@;19.2///@;20.4///@;201///@;14.9///@" D ^DIE
"RTN","XUSTERM",60,0)
 L -^VA(200,XUDA,0)
"RTN","XUSTERM",61,0)
 D DEQUE^XUSERP(XUDA,3) ;Cleanup by other packages.
"RTN","XUSTERM",62,0)
 ;
"RTN","XUSTERM",63,0)
 K DIC S DA=XUDA,XUJ=^VA(200,XUDA,0),XUNAM=$P(XUJ,U,1),XUACT(19)=$S($D(^VA(200,XUDA,19)):^(19),1:"") F XUI=5,6,10 S XUACT(XUI)=$P(XUJ,U,XUI)
"RTN","XUSTERM",64,0)
ACT1 K ^DISV(XUDA) ; WARNING: This only gets ^DISV entries on current CPU
"RTN","XUSTERM",65,0)
 ;keys
"RTN","XUSTERM",66,0)
 I XUACT(6)="y" F XUI=0:0 S XUI=$O(^VA(200,XUDA,51,XUI)) Q:XUI'>0  I $P($G(^DIC(19.1,XUI,0)),U,4)'="y" S DA=XUI,DA(1)=XUDA,DIK="^VA(200,XUDA,51," D ^DIK W:XUVE "..."
"RTN","XUSTERM",67,0)
 ;delegated keys
"RTN","XUSTERM",68,0)
 I XUACT(6)="y" F XUI=0:0 S XUI=$O(^VA(200,XUDA,52,XUI)) Q:XUI'>0  S DA=XUI,DA(1)=XUDA,DIK="^VA(200,XUDA,52," D ^DIK W:XUVE "..."
"RTN","XUSTERM",69,0)
 ;Delegated options
"RTN","XUSTERM",70,0)
 S DIK="^VA(200,XUDA,19.5,",DA(1)=XUDA F XUI=0:0 S XUI=$O(^VA(200,XUDA,19.5,XUI)) Q:XUI'>0  S DA=XUI D ^DIK
"RTN","XUSTERM",71,0)
 ;Menu templates
"RTN","XUSTERM",72,0)
 S DIK="^VA(200,XUDA,19.8,",DA(1)=XUDA F XUI=0:0 S XUI=$O(^VA(200,XUDA,19.8,XUI)) Q:XUI'>0  S DA=XUI D ^DIK
"RTN","XUSTERM",73,0)
 ;Secondary Menus
"RTN","XUSTERM",74,0)
 S DIK="^VA(200,XUDA,203,",DA(1)=XUDA F XUI=0:0 S XUI=$O(^VA(200,XUDA,203,XUI)) Q:XUI'>0  S DA=XUI D ^DIK
"RTN","XUSTERM",75,0)
 S DA=0,DA(1)=XUDA D D2^XUFILE1 ;Remove all access to files.
"RTN","XUSTERM",76,0)
 ;Terminate Person Class
"RTN","XUSTERM",77,0)
 D TERM^XUA4A72(XUDA,XUDT)
"RTN","XUSTERM",78,0)
 ;Remove all parameters for the user.
"RTN","XUSTERM",79,0)
 D DELUSR^XPAR3(XUDA)
"RTN","XUSTERM",80,0)
 ;
"RTN","XUSTERM",81,0)
ACT2 ;XUACT(5) All Mail access,  Mail groups
"RTN","XUSTERM",82,0)
 D MAIL
"RTN","XUSTERM",83,0)
 D SEND^XUSTERM1
"RTN","XUSTERM",84,0)
 W:XUVE "... DONE"
"RTN","XUSTERM",85,0)
 Q
"RTN","XUSTERM",86,0)
 ;
"RTN","XUSTERM",87,0)
END K C,D,D0,DI,DR,DIC,DIE,DA,DIR,XUEMP,XUDA,XUI,XUJ,XUK,XUACT,XUKEY,XUGRP,XUSUR,XUNAM,XUF,XUDT,XUIN,DIC,XUDB,XUDC,XUDP,XUGP,XUNUM,XUVE,Y
"RTN","XUSTERM",88,0)
 K XUTX1,XUTX2,DIRUT,DIR
"RTN","XUSTERM",89,0)
 Q
"RTN","XUSTERM",90,0)
MAIL ;Remove mail access
"RTN","XUSTERM",91,0)
 I XUACT(5)="y" D TERMINAT^XMUTERM1(XUDA)
"RTN","XUSTERM",92,0)
 Q
"RTN","XUSTERM1")
0^2^B24004727^B22227327
"RTN","XUSTERM1",1,0)
XUSTERM1 ;SEA/WDE - DEACTIVATE USER ;5:32 AM  28 Nov 2005
"RTN","XUSTERM1",2,0)
 ;;8.0;KERNEL;**102,180,208,222,274,313,332,360,384**;Jul 10, 1995;Build 8
"RTN","XUSTERM1",3,0)
ENALL ;Interactive scan all
"RTN","XUSTERM1",4,0)
 S U="^",DTIME=$G(DTIME,60)
"RTN","XUSTERM1",5,0)
 W !!,"This option can purge all access & verify codes, mail baskets, messages,",!,"authorized senders access, keys, and electronic signature codes of users who have been terminated."
"RTN","XUSTERM1",6,0)
RD1 W !!,"Do you wish to proceed "
"RTN","XUSTERM1",7,0)
 S %=2 D YN^DICN G:%=2!(%=-1) END I %=0 S XQH="XUUSER-PURGEATT" D EN^XQH G RD1
"RTN","XUSTERM1",8,0)
RD2 W !,"Do you wish to verify each user "
"RTN","XUSTERM1",9,0)
 S %=2,XUVE=0 D YN^DICN S:%=1 XUVE=1 G:%=1 CHECK G:%=-1 END I %=0 S XQH="XUUSER-PURGEATT-VER" D EN^XQH G RD2
"RTN","XUSTERM1",10,0)
QUE W !,"Do you wish to have this queued for a later time "
"RTN","XUSTERM1",11,0)
 S %=1 D YN^DICN I %=1 D  Q
"RTN","XUSTERM1",12,0)
 . S ZTDESC="USER DEACTIVATION",ZTRTN="CHECK^XUSTERM1",ZTIO="",ZTSAVE("DUZ*")=""
"RTN","XUSTERM1",13,0)
 . D ^%ZTLOAD
"RTN","XUSTERM1",14,0)
 . Q
"RTN","XUSTERM1",15,0)
 I %=0 K X,XUVE Q
"RTN","XUSTERM1",16,0)
 ;Fall thru if user doesn't queue
"RTN","XUSTERM1",17,0)
CHECK ;Entry point for taskman.
"RTN","XUSTERM1",18,0)
 N XUDT540,XUDT90,XUDT30,FDA,XUDT
"RTN","XUSTERM1",19,0)
 S U="^",DT=$$DT^XLFDT(),XUDT90=$$HTFM^XLFDT($H-90,1),XUDT30=$$HTFM^XLFDT($H-30,1)
"RTN","XUSTERM1",20,0)
 S XUDT540=$$HTFM^XLFDT($H-540,1) ;*p332
"RTN","XUSTERM1",21,0)
 S XUDA=.6,XUVE=$G(XUVE,0)
"RTN","XUSTERM1",22,0)
 F  S XUDA=$O(^VA(200,XUDA)) Q:XUDA'>0  S XUJ=$G(^(XUDA,0)) D
"RTN","XUSTERM1",23,0)
 . S XUDT=$P(XUJ,U,11)
"RTN","XUSTERM1",24,0)
 . I $P(XUJ,U,3)]"",$L(XUDT),(XUDT'>DT) D
"RTN","XUSTERM1",25,0)
 . . D GET
"RTN","XUSTERM1",26,0)
 . . I 'XUEMP K Y D:XUVE DISP Q:$D(Y)  D ACT ;XUEMP=any data to remove
"RTN","XUSTERM1",27,0)
 . . Q
"RTN","XUSTERM1",28,0)
 . I $P(XUJ,U,3)]"",'$P(XUJ,U,8),$$NOSIGNON D DISUSER(XUDA)
"RTN","XUSTERM1",29,0)
 . I $P(XUJ,U,7) D AUSER(XUDA) ;*p332
"RTN","XUSTERM1",30,0)
 . Q
"RTN","XUSTERM1",31,0)
 ;
"RTN","XUSTERM1",32,0)
END K XUEMP,XUDA,XUI,XUJ,XUK,XUACT,XUKEY,XUGRP,XUSUR,XUNAM,XUF,XUDT,XUIN,XUVE,X,DIC,XUDB,XUDC,XUDP
"RTN","XUSTERM1",33,0)
 Q
"RTN","XUSTERM1",34,0)
 ;
"RTN","XUSTERM1",35,0)
DISUSER(XUDA) ;Set DISUSER flag and reason, Remove last menu option
"RTN","XUSTERM1",36,0)
 Q:$P(XUJ,U,7)  ;DISUSER already set *p332
"RTN","XUSTERM1",37,0)
 N %,FDA S %=XUDA_","
"RTN","XUSTERM1",38,0)
 S FDA(200,%,7)=1,FDA(200,%,9.4)="User Inactive for too long"
"RTN","XUSTERM1",39,0)
 D FILE^DIE("","FDA"),CONTCL(XUDA) ;Set Disuser
"RTN","XUSTERM1",40,0)
 Q
"RTN","XUSTERM1",41,0)
 ;
"RTN","XUSTERM1",42,0)
AUSER(XUDA) ;If DISUSERed and Last Sign > 540[18Mo.*30] days, then remove"AUSER" xref
"RTN","XUSTERM1",43,0)
 I $D(XUSEC("XUORES",XUDA)) Q  ;Owner of XUORES key
"RTN","XUSTERM1",44,0)
 N Q S Q=$P($G(^VA(200,XUDA,1.1)),U) ;Get last sign-on
"RTN","XUSTERM1",45,0)
 I $L(Q),Q<XUDT540 K ^VA(200,"AUSER",$P(XUJ,U),XUDA) ;*p360;*p384
"RTN","XUSTERM1",46,0)
 Q
"RTN","XUSTERM1",47,0)
 ;
"RTN","XUSTERM1",48,0)
NOSIGNON() ;Check last signon. Return 1 if should disable account
"RTN","XUSTERM1",49,0)
 N Q S Q=$P($G(^VA(200,XUDA,1.1)),U) ;Get last sign-on
"RTN","XUSTERM1",50,0)
 I $L(Q),Q>XUDT90 Q 0 ;Last sign-on within 90 days
"RTN","XUSTERM1",51,0)
 S Q=$P($G(^VA(200,XUDA,1.1)),U,4) ;Get last Edit date
"RTN","XUSTERM1",52,0)
 I $L(Q),Q>XUDT30 Q 0 ;User edited in last 30 days
"RTN","XUSTERM1",53,0)
 S Q=$P($G(^VA(200,XUDA,1)),U,7) ;Create Date
"RTN","XUSTERM1",54,0)
 I $L(Q),Q>XUDT30 Q 0 ;User set up in last 30 days
"RTN","XUSTERM1",55,0)
 S Q=$P($G(^VA(200,XUDA,.1)),U) ;Get verify code change date
"RTN","XUSTERM1",56,0)
 I $L(Q),(Q+30)>$H Q 0 ;Verify code changed in last 30 days
"RTN","XUSTERM1",57,0)
 Q 1
"RTN","XUSTERM1",58,0)
 ;
"RTN","XUSTERM1",59,0)
CONTCL(XUDA) ;Clear the fields for Menu "Continue"
"RTN","XUSTERM1",60,0)
 N FDA
"RTN","XUSTERM1",61,0)
 S FDA(200,XUDA_",",202.1)="@",FDA(200,XUDA_",",202.2)="@"
"RTN","XUSTERM1",62,0)
 D FILE^DIE("","FDA") ;Clear 202.1 and 202.2
"RTN","XUSTERM1",63,0)
 Q
"RTN","XUSTERM1",64,0)
 ;
"RTN","XUSTERM1",65,0)
ACT ;
"RTN","XUSTERM1",66,0)
 D ACT^XUSTERM
"RTN","XUSTERM1",67,0)
 S XUJ=^VA(200,XUDA,0) ;Get new copy of zero node
"RTN","XUSTERM1",68,0)
 Q
"RTN","XUSTERM1",69,0)
 ;
"RTN","XUSTERM1",70,0)
GET ;Kill ^DISV entries each time, should get all CPUs at some point
"RTN","XUSTERM1",71,0)
 N XUJ
"RTN","XUSTERM1",72,0)
 D GET^XUSTERM K ^DISV(XUDA),Y
"RTN","XUSTERM1",73,0)
 Q
"RTN","XUSTERM1",74,0)
DISP ;Display info and get responses.
"RTN","XUSTERM1",75,0)
 N DA,DIE,DR,XUJ
"RTN","XUSTERM1",76,0)
 S DA=XUDA
"RTN","XUSTERM1",77,0)
 L +^VA(200,DA,0):6 D DISP2 L -^VA(200,DA,0)
"RTN","XUSTERM1",78,0)
 Q
"RTN","XUSTERM1",79,0)
DISP2 ;Do the work.
"RTN","XUSTERM1",80,0)
 W !!,$S(XUTX1(1)["User":XUNAM_$P(XUTX1(1),"User",2),1:XUTX1(1)) ;*p360
"RTN","XUSTERM1",81,0)
 S DR="9.21//YES",DIE=200 D ^DIE Q:$D(Y)  G:'$D(XUSUR) KEYS
"RTN","XUSTERM1",82,0)
 W !!,XUNAM," acts as surrogate for the following users:"
"RTN","XUSTERM1",83,0)
 S XUJ=0,XUI=3 F XUK=0:1 S XUJ=$O(XUSUR(XUJ)) Q:XUJ'>0  W:'(XUK#XUI) ! W ?(XUK#XUI*26),$P(^VA(200,XUJ,0),U,1) W !,"These surrogate privileges will be deleted on deactivation."
"RTN","XUSTERM1",84,0)
KEYS ;This section checks for authorized senders of mail groups and security keys.
"RTN","XUSTERM1",85,0)
 W !,"User will no longer be an authorized sender to any mail groups."
"RTN","XUSTERM1",86,0)
 I '$D(XUKEY) W !!,XUNAM," currently holds no keys." G KEYS1
"RTN","XUSTERM1",87,0)
 W !!,XUNAM," holds the following keys: "
"RTN","XUSTERM1",88,0)
 S XUJ=0,XUI=5 F XUK=0:1 S XUJ=$O(XUKEY(XUJ)) Q:XUJ'>0  W:'(XUK#XUI) ! W ?(XUK#XUI*15),$P($G(^DIC(19.1,XUJ,0)),U,1)
"RTN","XUSTERM1",89,0)
KEYS1 W ! S DR="9.22//YES" D ^DIE Q:$D(Y)
"RTN","XUSTERM1",90,0)
GROUP I '$D(XUGRP) W !!,XUNAM," currently is not a member of any MAIL GROUP." G GROUP1
"RTN","XUSTERM1",91,0)
 W !!,XUNAM," is a member of the following Mail Groups:"
"RTN","XUSTERM1",92,0)
 S XUI="" F XUI=0:0 S XUI=$O(XUGRP(XUI)) Q:XUI'>0  D
"RTN","XUSTERM1",93,0)
 . S XUJ=XUGRP(XUI)
"RTN","XUSTERM1",94,0)
 . I $P(XUJ,U,2)="PU"!$D(^XMB(3.8,"AB",XUDA,XUI)) W !?2,$P(XUJ,U,1) W:$P(XUJ,U,3) " (Organizer)" W ?40,$S(($P(XUJ,U,2)="PR"):"(Private)",1:"(Public)")
"RTN","XUSTERM1",95,0)
 . Q
"RTN","XUSTERM1",96,0)
GROUP1 W ! S DR="9.23//YES" D ^DIE Q:$D(Y)
"RTN","XUSTERM1",97,0)
 Q
"RTN","XUSTERM1",98,0)
 ;
"RTN","XUSTERM1",99,0)
DQ1 ;Terminate one person.
"RTN","XUSTERM1",100,0)
 N XUJ,XUDT,XUVE
"RTN","XUSTERM1",101,0)
 S XUJ=$G(^VA(200,XUDA,0)),XUDT=$P(XUJ,U,11) I XUDT,(XUDT'>DT) D
"RTN","XUSTERM1",102,0)
 . S XUVE=0 D GET I 'XUEMP D ACT
"RTN","XUSTERM1",103,0)
 . Q
"RTN","XUSTERM1",104,0)
 Q
"RTN","XUSTERM1",105,0)
 ;
"RTN","XUSTERM1",106,0)
SEND ; send deactivated message to assigned mail group
"RTN","XUSTERM1",107,0)
 K XMB,XMY
"RTN","XUSTERM1",108,0)
 S XMB(1)=$P(XUJ,"^",1)
"RTN","XUSTERM1",109,0)
 S XMB(2)=$$GET1^DIQ(200,XUDA,8)
"RTN","XUSTERM1",110,0)
 S XMB(3)=$$GET1^DIQ(200,XUDA,29)
"RTN","XUSTERM1",111,0)
 S XMB(4)=$$FMTE^XLFDT(XUDT)
"RTN","XUSTERM1",112,0)
 S XMB="XUSERDEAC" D ^XMB:$D(^XMB(3.6,"B",XMB))
"RTN","XUSTERM1",113,0)
 K XMB
"RTN","XUSTERM1",114,0)
 Q
"VER")
8.0^22.0
"BLD",874,6)
^335
**END**
**END**
