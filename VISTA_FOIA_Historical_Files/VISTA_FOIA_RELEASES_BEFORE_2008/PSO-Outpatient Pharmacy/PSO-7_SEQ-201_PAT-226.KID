Released PSO*7*226 SEQ #201
Extracted from mail message
**KIDS**:PSO*7.0*226^

**INSTALL NAME**
PSO*7.0*226
"BLD",5790,0)
PSO*7.0*226^OUTPATIENT PHARMACY^0^3051201^y
"BLD",5790,1,0)
^^113^113^3051201^
"BLD",5790,1,1,0)
This is the second follow up patch for Outpatient Pharmacy Clinical
"BLD",5790,1,2,0)
Indicator Data Capture (CIDC) patch PSO*7*143.  The first follow-up patch
"BLD",5790,1,3,0)
was PSO*7*219, and the follow-up patches were split into two patches in
"BLD",5790,1,4,0)
order to quickly get the issues resolved by patch PSO*7*219 into the field
"BLD",5790,1,5,0)
immediately.
"BLD",5790,1,6,0)
 
"BLD",5790,1,7,0)
Functional Description:
"BLD",5790,1,8,0)
=======================
"BLD",5790,1,9,0)
This patch PSO*7*226 corrects the following:
"BLD",5790,1,10,0)
 
"BLD",5790,1,11,0)
1.  For only edited prescriptions ordered prior to patch PSO*7*143 being 
"BLD",5790,1,12,0)
installed, the routine that passes information from Outpatient Pharmacy to
"BLD",5790,1,13,0)
CPRS was passing an extra value and was not passing the Combat Veteran
"BLD",5790,1,14,0)
indicator.  An edit to days supply, quantity, etc. on a prescription 
"BLD",5790,1,15,0)
results in a background transmission of data to CRPS.  This type of data
"BLD",5790,1,16,0)
was passed and updated in CRPS correctly.  Because CPRS does not 
"BLD",5790,1,17,0)
currently update SC/EI's for edited prescriptions, there were no adverse
"BLD",5790,1,18,0)
affects.  However, Outpatient Pharmacy sends all data for consistency, and
"BLD",5790,1,19,0)
this was corrected.  There are no associated remedy tickets for this
"BLD",5790,1,20,0)
change.
"BLD",5790,1,21,0)
 
"BLD",5790,1,22,0)
2.  A dollar sign ($) was being displayed for exempt from copay
"BLD",5790,1,23,0)
prescriptions, and it was being displayed up until the prescription was
"BLD",5790,1,24,0)
released.  Also, 'COPAY' was being printed on the label for this type 
"BLD",5790,1,25,0)
of prescription.
"BLD",5790,1,26,0)
 
"BLD",5790,1,27,0)
3.  Copays were erroneously being charged for non-service connected (NSC)
"BLD",5790,1,28,0)
prescriptions fills that had an environmental indicator flagged as
"BLD",5790,1,29,0)
"Yes".   And, copays were charged for some service connected (SC) <50%
"BLD",5790,1,30,0)
prescriptions, and this was due to a "RX COPAY STATUS REVIEW NEEDED"
"BLD",5790,1,31,0)
Mailman message being sent instead of prompting the user for the SC/EI
"BLD",5790,1,32,0)
information.  Patch PSO*7*219 corrected this issue, but PSO*7*226 cancels
"BLD",5790,1,33,0)
the erroneously billed copay(s) as well as restores the copay related
"BLD",5790,1,34,0)
fields in PRESCRIPTION file (#52).
"BLD",5790,1,35,0)
 
"BLD",5790,1,36,0)
When installing this patch, the 'copay correction' portion of this patch
"BLD",5790,1,37,0)
is optional.  Each site can determine if they would be better suited to
"BLD",5790,1,38,0)
run this automated process or correct them manually.  If you answer N (No)
"BLD",5790,1,39,0)
to running the copay correction process and change your mind later, then
"BLD",5790,1,40,0)
have your IRM run ^PSOCIDC1 from the programmers prompt.  Please keep in 
"BLD",5790,1,41,0)
mind that by not running the copay correction process that those
"BLD",5790,1,42,0)
prescriptions where the IBQ node was not stored correctly will continue to
"BLD",5790,1,43,0)
generate a copay until the fill is copied or renewed.
"BLD",5790,1,44,0)
 
"BLD",5790,1,45,0)
 
"BLD",5790,1,46,0)
Technical Description:
"BLD",5790,1,47,0)
======================
"BLD",5790,1,48,0)
The following correlates to each sequence in the Functional Description:
"BLD",5790,1,49,0)
 
"BLD",5790,1,50,0)
1.  In background processing, the PSOHLSN2 routine passes information from
"BLD",5790,1,51,0)
Outpatient Pharmacy to CPRS when orders are created, edited, copied or
"BLD",5790,1,52,0)
renewed from backdoor order entry.  Even though CPRS does not 
"BLD",5790,1,53,0)
currently update SC/EI information for edited prescriptions, Outpatient
"BLD",5790,1,54,0)
Pharmacy passes them for consistency.  The code that handles pre-CIDC
"BLD",5790,1,55,0)
edited prescriptions passed an extra value and did not pass the Combat
"BLD",5790,1,56,0)
Veteran indicator.  Because CPRS does not update SC/EI's for edited
"BLD",5790,1,57,0)
prescriptions, there were no adverse affects.  A change was made to pass
"BLD",5790,1,58,0)
the Combat Veteran indicator and not pass the extra value.
"BLD",5790,1,59,0)
 
"BLD",5790,1,60,0)
2.  Because a value denoting copay was allowed to remain in the COPAY 
"BLD",5790,1,61,0)
TRANSACTION TYPE field (#105) for exempt from copay prescriptions, the
"BLD",5790,1,62,0)
$ sign was incorrectly being displayed and "COPAY was being printed on 
"BLD",5790,1,63,0)
the prescription label.  Modifications were made to eliminate the display
"BLD",5790,1,64,0)
of the $ sign for exempt from copay fills which in turn eliminates the
"BLD",5790,1,65,0)
printing of 'COPAY' on the label.  Also, modifications were made to
"BLD",5790,1,66,0)
eliminate this value for NSC and SC<50% prescriptions for all affected
"BLD",5790,1,67,0)
fills finished between the installation date of patch PSO*7*143 until
"BLD",5790,1,68,0)
present. This patch re-examines the PRESCRIPTION file (#52) for any NSC
"BLD",5790,1,69,0)
and SC<50% prescription that has an ICD node and does not have an IBQ
"BLD",5790,1,70,0)
node.  Using the SC/EI answers stored on the ICD node, the IBQ node is
"BLD",5790,1,71,0)
defined and the COPAY TRANSACTION TYPE field (#105) is defined
"BLD",5790,1,72,0)
appropriately.
"BLD",5790,1,73,0)
 
"BLD",5790,1,74,0)
3.  For those prescriptions that were erroneously billed a copay from 
"BLD",5790,1,75,0)
the installation of PSO*7*143 until present, this patch evaluates any
"BLD",5790,1,76,0)
prescription that was billed, that has an ICD node, but does not have an
"BLD",5790,1,77,0)
IBQ node.  Using the SC/EI answers stored on the ICD node, the IBQ node is
"BLD",5790,1,78,0)
defined.  Then, if a yes answer is defined for any SC or EI, IB is
"BLD",5790,1,79,0)
notified to cancel copay for the fill.
"BLD",5790,1,80,0)
 
"BLD",5790,1,81,0)
This patch prompts the user during installation when to run the copay
"BLD",5790,1,82,0)
correction process.  The job name for this process is 'CANCEL COPAY'.  It
"BLD",5790,1,83,0)
provides summary Mailman messages, and a detailed Results Report by
"BLD",5790,1,84,0)
Veteran that can be run from Programmer mode.  Also, a Query Status of Job
"BLD",5790,1,85,0)
function as well as a Stop Job Command function is provided.  See the
"BLD",5790,1,86,0)
reports and samples section below for details and images of these
"BLD",5790,1,87,0)
features.
"BLD",5790,1,88,0)
 
"BLD",5790,1,89,0)
 
"BLD",5790,1,90,0)
Reports Section:
"BLD",5790,1,91,0)
================
"BLD",5790,1,92,0)
 
"BLD",5790,1,93,0)
* See the sample section below for images of these features.
"BLD",5790,1,94,0)
 
"BLD",5790,1,95,0)
1.  The CANCEL COPAY process will produce a summary mail message of its 
"BLD",5790,1,96,0)
findings and display instructions on how to print a detailed report by 
"BLD",5790,1,97,0)
Veteran.  This MailMan message will be sent to all users that hold the 
"BLD",5790,1,98,0)
'PSO COPAY' security key and the installer of the patch.  This message 
"BLD",5790,1,99,0)
contains results by year and 30, 60, and 90 day fills for total 
"BLD",5790,1,100,0)
released, total un-released, and total cancelled copays.
"BLD",5790,1,101,0)
 
"BLD",5790,1,102,0)
2.  A summary Mailman message will be sent to Management for their 
"BLD",5790,1,103,0)
review.  It can be cut and pasted into a .TXT file.
"BLD",5790,1,104,0)
 
"BLD",5790,1,105,0)
3.  A detailed report by Veteran and fill number can be produced on 
"BLD",5790,1,106,0)
demand by entering D RPT^PSOCIDC3 at the programmers prompt. 
"BLD",5790,1,107,0)
 
"BLD",5790,1,108,0)
4.  To check the status of the COPAY CANCEL background job while it is
"BLD",5790,1,109,0)
running, then type from the direct programmers prompt the command 
"BLD",5790,1,110,0)
D STATUS^PSOCIDC1.
"BLD",5790,1,111,0)
 
"BLD",5790,1,112,0)
5.  If you need to stop the COPAY CANCEL background job for any reason,
"BLD",5790,1,113,0)
then from the direct programmers prompt, type the command D STOP^PSOCIDC1.
"BLD",5790,4,0)
^9.64PA^^
"BLD",5790,6)
8^
"BLD",5790,"ABPKG")
n
"BLD",5790,"INID")
^n
"BLD",5790,"INIT")
PSOCIDC1
"BLD",5790,"KRN",0)
^9.67PA^8989.52^19
"BLD",5790,"KRN",.4,0)
.4
"BLD",5790,"KRN",.401,0)
.401
"BLD",5790,"KRN",.402,0)
.402
"BLD",5790,"KRN",.403,0)
.403
"BLD",5790,"KRN",.5,0)
.5
"BLD",5790,"KRN",.84,0)
.84
"BLD",5790,"KRN",3.6,0)
3.6
"BLD",5790,"KRN",3.8,0)
3.8
"BLD",5790,"KRN",9.2,0)
9.2
"BLD",5790,"KRN",9.8,0)
9.8
"BLD",5790,"KRN",9.8,"NM",0)
^9.68A^9^8
"BLD",5790,"KRN",9.8,"NM",1,0)
PSONEW2^^0^B29428491
"BLD",5790,"KRN",9.8,"NM",2,0)
PSONEWF^^0^B45034725
"BLD",5790,"KRN",9.8,"NM",3,0)
PSONEWG^^0^B22698688
"BLD",5790,"KRN",9.8,"NM",5,0)
PSOCIDC1^^0^B43781391
"BLD",5790,"KRN",9.8,"NM",6,0)
PSOCIDC2^^0^B70634486
"BLD",5790,"KRN",9.8,"NM",7,0)
PSOCIDC3^^0^B43379204
"BLD",5790,"KRN",9.8,"NM",8,0)
PSOCIDC4^^0^B67222951
"BLD",5790,"KRN",9.8,"NM",9,0)
PSOHLSN2^^0^B4326292
"BLD",5790,"KRN",9.8,"NM","B","PSOCIDC1",5)

"BLD",5790,"KRN",9.8,"NM","B","PSOCIDC2",6)

"BLD",5790,"KRN",9.8,"NM","B","PSOCIDC3",7)

"BLD",5790,"KRN",9.8,"NM","B","PSOCIDC4",8)

"BLD",5790,"KRN",9.8,"NM","B","PSOHLSN2",9)

"BLD",5790,"KRN",9.8,"NM","B","PSONEW2",1)

"BLD",5790,"KRN",9.8,"NM","B","PSONEWF",2)

"BLD",5790,"KRN",9.8,"NM","B","PSONEWG",3)

"BLD",5790,"KRN",19,0)
19
"BLD",5790,"KRN",19.1,0)
19.1
"BLD",5790,"KRN",101,0)
101
"BLD",5790,"KRN",409.61,0)
409.61
"BLD",5790,"KRN",771,0)
771
"BLD",5790,"KRN",870,0)
870
"BLD",5790,"KRN",8989.51,0)
8989.51
"BLD",5790,"KRN",8989.52,0)
8989.52
"BLD",5790,"KRN",8994,0)
8994
"BLD",5790,"KRN","B",.4,.4)

"BLD",5790,"KRN","B",.401,.401)

"BLD",5790,"KRN","B",.402,.402)

"BLD",5790,"KRN","B",.403,.403)

"BLD",5790,"KRN","B",.5,.5)

"BLD",5790,"KRN","B",.84,.84)

"BLD",5790,"KRN","B",3.6,3.6)

"BLD",5790,"KRN","B",3.8,3.8)

"BLD",5790,"KRN","B",9.2,9.2)

"BLD",5790,"KRN","B",9.8,9.8)

"BLD",5790,"KRN","B",19,19)

"BLD",5790,"KRN","B",19.1,19.1)

"BLD",5790,"KRN","B",101,101)

"BLD",5790,"KRN","B",409.61,409.61)

"BLD",5790,"KRN","B",771,771)

"BLD",5790,"KRN","B",870,870)

"BLD",5790,"KRN","B",8989.51,8989.51)

"BLD",5790,"KRN","B",8989.52,8989.52)

"BLD",5790,"KRN","B",8994,8994)

"BLD",5790,"QUES",0)
^9.62^2^2
"BLD",5790,"QUES",1,0)
POS1
"BLD",5790,"QUES",1,1)
YA^^
"BLD",5790,"QUES",1,"A")
Do you want to Run the Back-Billing process? Y or N//
"BLD",5790,"QUES",1,"Q")
Enter Y for Yes to run the Copay Correction or N to install patch
"BLD",5790,"QUES",2,0)
POS2
"BLD",5790,"QUES",2,1)
D^::%DT
"BLD",5790,"QUES",2,"A")
Enter when to Queue the Job to run in date@time format
"BLD",5790,"QUES",2,"B")
NOW
"BLD",5790,"QUES",2,"M")
I XPDQUES("POS1")=0 K DIR
"BLD",5790,"QUES",2,"Q")
Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 081505@3:30p.
"BLD",5790,"QUES","B","POS1",1)

"BLD",5790,"QUES","B","POS2",2)

"BLD",5790,"REQB",0)
^9.611^1^1
"BLD",5790,"REQB",1,0)
PSO*7.0*219^2
"BLD",5790,"REQB","B","PSO*7.0*219",1)

"INIT")
PSOCIDC1
"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^2971216^2990510^66476
"PKG",206,22,1,"PAH",1,0)
226^3051201^123457145
"PKG",206,22,1,"PAH",1,1,0)
^^113^113^3051201
"PKG",206,22,1,"PAH",1,1,1,0)
This is the second follow up patch for Outpatient Pharmacy Clinical
"PKG",206,22,1,"PAH",1,1,2,0)
Indicator Data Capture (CIDC) patch PSO*7*143.  The first follow-up patch
"PKG",206,22,1,"PAH",1,1,3,0)
was PSO*7*219, and the follow-up patches were split into two patches in
"PKG",206,22,1,"PAH",1,1,4,0)
order to quickly get the issues resolved by patch PSO*7*219 into the field
"PKG",206,22,1,"PAH",1,1,5,0)
immediately.
"PKG",206,22,1,"PAH",1,1,6,0)
 
"PKG",206,22,1,"PAH",1,1,7,0)
Functional Description:
"PKG",206,22,1,"PAH",1,1,8,0)
=======================
"PKG",206,22,1,"PAH",1,1,9,0)
This patch PSO*7*226 corrects the following:
"PKG",206,22,1,"PAH",1,1,10,0)
 
"PKG",206,22,1,"PAH",1,1,11,0)
1.  For only edited prescriptions ordered prior to patch PSO*7*143 being 
"PKG",206,22,1,"PAH",1,1,12,0)
installed, the routine that passes information from Outpatient Pharmacy to
"PKG",206,22,1,"PAH",1,1,13,0)
CPRS was passing an extra value and was not passing the Combat Veteran
"PKG",206,22,1,"PAH",1,1,14,0)
indicator.  An edit to days supply, quantity, etc. on a prescription 
"PKG",206,22,1,"PAH",1,1,15,0)
results in a background transmission of data to CRPS.  This type of data
"PKG",206,22,1,"PAH",1,1,16,0)
was passed and updated in CRPS correctly.  Because CPRS does not 
"PKG",206,22,1,"PAH",1,1,17,0)
currently update SC/EI's for edited prescriptions, there were no adverse
"PKG",206,22,1,"PAH",1,1,18,0)
affects.  However, Outpatient Pharmacy sends all data for consistency, and
"PKG",206,22,1,"PAH",1,1,19,0)
this was corrected.  There are no associated remedy tickets for this
"PKG",206,22,1,"PAH",1,1,20,0)
change.
"PKG",206,22,1,"PAH",1,1,21,0)
 
"PKG",206,22,1,"PAH",1,1,22,0)
2.  A dollar sign ($) was being displayed for exempt from copay
"PKG",206,22,1,"PAH",1,1,23,0)
prescriptions, and it was being displayed up until the prescription was
"PKG",206,22,1,"PAH",1,1,24,0)
released.  Also, 'COPAY' was being printed on the label for this type 
"PKG",206,22,1,"PAH",1,1,25,0)
of prescription.
"PKG",206,22,1,"PAH",1,1,26,0)
 
"PKG",206,22,1,"PAH",1,1,27,0)
3.  Copays were erroneously being charged for non-service connected (NSC)
"PKG",206,22,1,"PAH",1,1,28,0)
prescriptions fills that had an environmental indicator flagged as
"PKG",206,22,1,"PAH",1,1,29,0)
"Yes".   And, copays were charged for some service connected (SC) <50%
"PKG",206,22,1,"PAH",1,1,30,0)
prescriptions, and this was due to a "RX COPAY STATUS REVIEW NEEDED"
"PKG",206,22,1,"PAH",1,1,31,0)
Mailman message being sent instead of prompting the user for the SC/EI
"PKG",206,22,1,"PAH",1,1,32,0)
information.  Patch PSO*7*219 corrected this issue, but PSO*7*226 cancels
"PKG",206,22,1,"PAH",1,1,33,0)
the erroneously billed copay(s) as well as restores the copay related
"PKG",206,22,1,"PAH",1,1,34,0)
fields in PRESCRIPTION file (#52).
"PKG",206,22,1,"PAH",1,1,35,0)
 
"PKG",206,22,1,"PAH",1,1,36,0)
When installing this patch, the 'copay correction' portion of this patch
"PKG",206,22,1,"PAH",1,1,37,0)
is optional.  Each site can determine if they would be better suited to
"PKG",206,22,1,"PAH",1,1,38,0)
run this automated process or correct them manually.  If you answer N (No)
"PKG",206,22,1,"PAH",1,1,39,0)
to running the copay correction process and change your mind later, then
"PKG",206,22,1,"PAH",1,1,40,0)
have your IRM run ^PSOCIDC1 from the programmers prompt.  Please keep in 
"PKG",206,22,1,"PAH",1,1,41,0)
mind that by not running the copay correction process that those
"PKG",206,22,1,"PAH",1,1,42,0)
prescriptions where the IBQ node was not stored correctly will continue to
"PKG",206,22,1,"PAH",1,1,43,0)
generate a copay until the fill is copied or renewed.
"PKG",206,22,1,"PAH",1,1,44,0)
 
"PKG",206,22,1,"PAH",1,1,45,0)
 
"PKG",206,22,1,"PAH",1,1,46,0)
Technical Description:
"PKG",206,22,1,"PAH",1,1,47,0)
======================
"PKG",206,22,1,"PAH",1,1,48,0)
The following correlates to each sequence in the Functional Description:
"PKG",206,22,1,"PAH",1,1,49,0)
 
"PKG",206,22,1,"PAH",1,1,50,0)
1.  In background processing, the PSOHLSN2 routine passes information from
"PKG",206,22,1,"PAH",1,1,51,0)
Outpatient Pharmacy to CPRS when orders are created, edited, copied or
"PKG",206,22,1,"PAH",1,1,52,0)
renewed from backdoor order entry.  Even though CPRS does not 
"PKG",206,22,1,"PAH",1,1,53,0)
currently update SC/EI information for edited prescriptions, Outpatient
"PKG",206,22,1,"PAH",1,1,54,0)
Pharmacy passes them for consistency.  The code that handles pre-CIDC
"PKG",206,22,1,"PAH",1,1,55,0)
edited prescriptions passed an extra value and did not pass the Combat
"PKG",206,22,1,"PAH",1,1,56,0)
Veteran indicator.  Because CPRS does not update SC/EI's for edited
"PKG",206,22,1,"PAH",1,1,57,0)
prescriptions, there were no adverse affects.  A change was made to pass
"PKG",206,22,1,"PAH",1,1,58,0)
the Combat Veteran indicator and not pass the extra value.
"PKG",206,22,1,"PAH",1,1,59,0)
 
"PKG",206,22,1,"PAH",1,1,60,0)
2.  Because a value denoting copay was allowed to remain in the COPAY 
"PKG",206,22,1,"PAH",1,1,61,0)
TRANSACTION TYPE field (#105) for exempt from copay prescriptions, the
"PKG",206,22,1,"PAH",1,1,62,0)
$ sign was incorrectly being displayed and "COPAY was being printed on 
"PKG",206,22,1,"PAH",1,1,63,0)
the prescription label.  Modifications were made to eliminate the display
"PKG",206,22,1,"PAH",1,1,64,0)
of the $ sign for exempt from copay fills which in turn eliminates the
"PKG",206,22,1,"PAH",1,1,65,0)
printing of 'COPAY' on the label.  Also, modifications were made to
"PKG",206,22,1,"PAH",1,1,66,0)
eliminate this value for NSC and SC<50% prescriptions for all affected
"PKG",206,22,1,"PAH",1,1,67,0)
fills finished between the installation date of patch PSO*7*143 until
"PKG",206,22,1,"PAH",1,1,68,0)
present. This patch re-examines the PRESCRIPTION file (#52) for any NSC
"PKG",206,22,1,"PAH",1,1,69,0)
and SC<50% prescription that has an ICD node and does not have an IBQ
"PKG",206,22,1,"PAH",1,1,70,0)
node.  Using the SC/EI answers stored on the ICD node, the IBQ node is
"PKG",206,22,1,"PAH",1,1,71,0)
defined and the COPAY TRANSACTION TYPE field (#105) is defined
"PKG",206,22,1,"PAH",1,1,72,0)
appropriately.
"PKG",206,22,1,"PAH",1,1,73,0)
 
"PKG",206,22,1,"PAH",1,1,74,0)
3.  For those prescriptions that were erroneously billed a copay from 
"PKG",206,22,1,"PAH",1,1,75,0)
the installation of PSO*7*143 until present, this patch evaluates any
"PKG",206,22,1,"PAH",1,1,76,0)
prescription that was billed, that has an ICD node, but does not have an
"PKG",206,22,1,"PAH",1,1,77,0)
IBQ node.  Using the SC/EI answers stored on the ICD node, the IBQ node is
"PKG",206,22,1,"PAH",1,1,78,0)
defined.  Then, if a yes answer is defined for any SC or EI, IB is
"PKG",206,22,1,"PAH",1,1,79,0)
notified to cancel copay for the fill.
"PKG",206,22,1,"PAH",1,1,80,0)
 
"PKG",206,22,1,"PAH",1,1,81,0)
This patch prompts the user during installation when to run the copay
"PKG",206,22,1,"PAH",1,1,82,0)
correction process.  The job name for this process is 'CANCEL COPAY'.  It
"PKG",206,22,1,"PAH",1,1,83,0)
provides summary Mailman messages, and a detailed Results Report by
"PKG",206,22,1,"PAH",1,1,84,0)
Veteran that can be run from Programmer mode.  Also, a Query Status of Job
"PKG",206,22,1,"PAH",1,1,85,0)
function as well as a Stop Job Command function is provided.  See the
"PKG",206,22,1,"PAH",1,1,86,0)
reports and samples section below for details and images of these
"PKG",206,22,1,"PAH",1,1,87,0)
features.
"PKG",206,22,1,"PAH",1,1,88,0)
 
"PKG",206,22,1,"PAH",1,1,89,0)
 
"PKG",206,22,1,"PAH",1,1,90,0)
Reports Section:
"PKG",206,22,1,"PAH",1,1,91,0)
================
"PKG",206,22,1,"PAH",1,1,92,0)
 
"PKG",206,22,1,"PAH",1,1,93,0)
* See the sample section below for images of these features.
"PKG",206,22,1,"PAH",1,1,94,0)
 
"PKG",206,22,1,"PAH",1,1,95,0)
1.  The CANCEL COPAY process will produce a summary mail message of its 
"PKG",206,22,1,"PAH",1,1,96,0)
findings and display instructions on how to print a detailed report by 
"PKG",206,22,1,"PAH",1,1,97,0)
Veteran.  This MailMan message will be sent to all users that hold the 
"PKG",206,22,1,"PAH",1,1,98,0)
'PSO COPAY' security key and the installer of the patch.  This message 
"PKG",206,22,1,"PAH",1,1,99,0)
contains results by year and 30, 60, and 90 day fills for total 
"PKG",206,22,1,"PAH",1,1,100,0)
released, total un-released, and total cancelled copays.
"PKG",206,22,1,"PAH",1,1,101,0)
 
"PKG",206,22,1,"PAH",1,1,102,0)
2.  A summary Mailman message will be sent to Management for their 
"PKG",206,22,1,"PAH",1,1,103,0)
review.  It can be cut and pasted into a .TXT file.
"PKG",206,22,1,"PAH",1,1,104,0)
 
"PKG",206,22,1,"PAH",1,1,105,0)
3.  A detailed report by Veteran and fill number can be produced on 
"PKG",206,22,1,"PAH",1,1,106,0)
demand by entering D RPT^PSOCIDC3 at the programmers prompt. 
"PKG",206,22,1,"PAH",1,1,107,0)
 
"PKG",206,22,1,"PAH",1,1,108,0)
4.  To check the status of the COPAY CANCEL background job while it is
"PKG",206,22,1,"PAH",1,1,109,0)
running, then type from the direct programmers prompt the command 
"PKG",206,22,1,"PAH",1,1,110,0)
D STATUS^PSOCIDC1.
"PKG",206,22,1,"PAH",1,1,111,0)
 
"PKG",206,22,1,"PAH",1,1,112,0)
5.  If you need to stop the COPAY CANCEL background job for any reason,
"PKG",206,22,1,"PAH",1,1,113,0)
then from the direct programmers prompt, type the command D STOP^PSOCIDC1.
"QUES","POS1",0)
YA^^
"QUES","POS1","?")
Enter Y for Yes to run the Copay Correction or N to install patch
"QUES","POS1","A")
Do you want to Run the Back-Billing process? Y or N//
"QUES","POS2",0)
D^::%DT
"QUES","POS2","?")
Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 081505@3:30p.
"QUES","POS2","A")
Enter when to Queue the Job to run in date@time format
"QUES","POS2","B")
NOW
"QUES","POS2","M")
I XPDQUES("POS1")=0 K DIR
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","PSOCIDC1")
0^5^B43781391
"RTN","PSOCIDC1",1,0)
PSOCIDC1 ;BIR/LE-Copay Correction of erroneous billed copays ;11/8/05 12:50pm
"RTN","PSOCIDC1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**226**;DEC 1997
"RTN","PSOCIDC1",3,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSOCIDC1",4,0)
 ;External reference to IBARX supported by DBIA 125
"RTN","PSOCIDC1",5,0)
 ;External reference to $$PROD^XUPROD(1) supported by DBIA 4440
"RTN","PSOCIDC1",6,0)
 ;
"RTN","PSOCIDC1",7,0)
 N NAMSP,DTOUT,DUOUT,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC,QUIT,RUNOPT,JOBN,Y
"RTN","PSOCIDC1",8,0)
 S NAMSP=$$NAMSP
"RTN","PSOCIDC1",9,0)
 S JOBN="CANCEL COPAY"
"RTN","PSOCIDC1",10,0)
 ;
"RTN","PSOCIDC1",11,0)
 L +^XTMP(NAMSP):0 I '$T D  Q
"RTN","PSOCIDC1",12,0)
 . D BMES^XPDUTL(JOBN_" job is already running.  Halting...")
"RTN","PSOCIDC1",13,0)
 . D MES^XPDUTL("")
"RTN","PSOCIDC1",14,0)
 . D QUIT
"RTN","PSOCIDC1",15,0)
 ;
"RTN","PSOCIDC1",16,0)
 I '$D(^XTMP(NAMSP)) D INITXTMP(NAMSP,"Correct erroneously billed copays, PSO*7*226",90)        ;90 day life
"RTN","PSOCIDC1",17,0)
 S QUIT=0
"RTN","PSOCIDC1",18,0)
 ;
"RTN","PSOCIDC1",19,0)
 ;ques 1, if running from mumps prompt
"RTN","PSOCIDC1",20,0)
 I '$D(XPDQUES("POS1")) D  I QUIT D QUIT Q
"RTN","PSOCIDC1",21,0)
 . ;selected cancel run at last install, dont allow to run manually
"RTN","PSOCIDC1",22,0)
 . I $G(^XTMP(NAMSP,0,"LAST"))["CANCEL" D  Q
"RTN","PSOCIDC1",23,0)
 . . S QUIT=1
"RTN","PSOCIDC1",24,0)
 . . W !!,*7,"The last install of this patch you selected to NOT Run the Copay Correction process."
"RTN","PSOCIDC1",25,0)
 . . W !,"If you have changed your mind, you must re-install the patch to run",!!
"RTN","PSOCIDC1",26,0)
 . K DIR
"RTN","PSOCIDC1",27,0)
 . S DIR("A",1)="****************** SELECT RUN OPTION ******************"
"RTN","PSOCIDC1",28,0)
 . S DIR("A")="Do you want to run the Copay Correction process? Y or N//"
"RTN","PSOCIDC1",29,0)
 . S DIR(0)="YA^^"
"RTN","PSOCIDC1",30,0)
 . D ^DIR I $D(DTOUT)!($D(DUOUT)) W !,"Halting..." S QUIT=1 Q
"RTN","PSOCIDC1",31,0)
 . S RUNOPT=Y
"RTN","PSOCIDC1",32,0)
 . S:'RUNOPT QUIT=1
"RTN","PSOCIDC1",33,0)
 ;
"RTN","PSOCIDC1",34,0)
 ;ques 1, if running from kids install
"RTN","PSOCIDC1",35,0)
 I $D(XPDQUES("POS1")) D  I 'RUNOPT D QUIT Q
"RTN","PSOCIDC1",36,0)
 . S RUNOPT=XPDQUES("POS1")
"RTN","PSOCIDC1",37,0)
 . S:'RUNOPT ^XTMP(NAMSP,0,"LAST")="CANCEL RUN^"_$$NOW^XLFDT_"^^^"
"RTN","PSOCIDC1",38,0)
 . D BMES^XPDUTL("***** SELECTED "_$S('RUNOPT:"NOT ",1:"")_"TO RUN THE COPAY CORRECTION PROCESS *****")
"RTN","PSOCIDC1",39,0)
 ;
"RTN","PSOCIDC1",40,0)
 I $G(^XTMP(NAMSP,0,"LAST"))["COMPLETED" D  Q
"RTN","PSOCIDC1",41,0)
 . W !!,*7,"This job has been run before to completion on "
"RTN","PSOCIDC1",42,0)
 . W $$FMTE^XLFDT($P($G(^XTMP(NAMSP,0,"LAST")),"^",2)),!!
"RTN","PSOCIDC1",43,0)
 . D QUIT
"RTN","PSOCIDC1",44,0)
 ;
"RTN","PSOCIDC1",45,0)
 ;ques 2, if running from mumps prompt
"RTN","PSOCIDC1",46,0)
 I '$D(XPDQUES("POS2")) D  I 'ZTDTH D QUIT Q
"RTN","PSOCIDC1",47,0)
 . K DIR
"RTN","PSOCIDC1",48,0)
 . S DIR("A")="Enter when to Queue the "_JOBN_" job to run in date@time format "
"RTN","PSOCIDC1",49,0)
 . S DIR("B")="NOW"
"RTN","PSOCIDC1",50,0)
 . S DIR(0)="D^::%DT"
"RTN","PSOCIDC1",51,0)
 . S DIR("?")="Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 081505@3:30p"
"RTN","PSOCIDC1",52,0)
 . D ^DIR I $D(DUOUT) W !,"Halting..." S ZTDTH="" Q
"RTN","PSOCIDC1",53,0)
 . S:$D(DTOUT) Y=$$NOW^XLFDT S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSOCIDC1",54,0)
 ;
"RTN","PSOCIDC1",55,0)
 ;ques 2, if running from kids install
"RTN","PSOCIDC1",56,0)
 I $D(XPDQUES("POS2")) S ZTDTH=$$FMTH^XLFDT(XPDQUES("POS2"))
"RTN","PSOCIDC1",57,0)
 ;
"RTN","PSOCIDC1",58,0)
 D BMES^XPDUTL("===================================================")
"RTN","PSOCIDC1",59,0)
 D MES^XPDUTL("Queuing background job to "_JOBN_" erroneous billed copays...")
"RTN","PSOCIDC1",60,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSOCIDC1",61,0)
 D MES^XPDUTL("===================================================")
"RTN","PSOCIDC1",62,0)
 I ZTDTH="" D BMES^XPDUTL(JOBN_" NOT QUEUED") D QUIT Q
"RTN","PSOCIDC1",63,0)
 ;
"RTN","PSOCIDC1",64,0)
 S:$D(^XTMP(NAMSP,0,"LAST")) ^XTMP(NAMSP,0,"ZAUDIT",$H)="RE-STARTED ON"_"^"_$$NOW^XLFDT_"^"_$P(^XTMP(NAMSP,0,"LAST"),"^",2,5)
"RTN","PSOCIDC1",65,0)
 ;
"RTN","PSOCIDC1",66,0)
 I $P($G(^XTMP(NAMSP,0,"LAST")),"^")="STOP" D
"RTN","PSOCIDC1",67,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="RUN^"_$$NOW^XLFDT
"RTN","PSOCIDC1",68,0)
 E  D
"RTN","PSOCIDC1",69,0)
 . S ^XTMP(NAMSP,0,"LAST")="RUN^"_$$NOW^XLFDT_"^^^"
"RTN","PSOCIDC1",70,0)
 ;
"RTN","PSOCIDC1",71,0)
 S ZTRTN="EN^PSOCIDC1",ZTIO=""
"RTN","PSOCIDC1",72,0)
 S ZTDESC="Background job to "_JOBN_" for erroneously billed copays via PSO*7*143"
"RTN","PSOCIDC1",73,0)
 S ZTSAVE("JOBN")=""
"RTN","PSOCIDC1",74,0)
 L -^XTMP(NAMSP)
"RTN","PSOCIDC1",75,0)
 D ^%ZTLOAD
"RTN","PSOCIDC1",76,0)
 D:$D(ZTSK)
"RTN","PSOCIDC1",77,0)
 . D MES^XPDUTL("*** Task #"_ZTSK_" Queued! ***")
"RTN","PSOCIDC1",78,0)
 . D BMES^XPDUTL("")
"RTN","PSOCIDC1",79,0)
 D BMES^XPDUTL("")
"RTN","PSOCIDC1",80,0)
 K XPDQUES
"RTN","PSOCIDC1",81,0)
 Q
"RTN","PSOCIDC1",82,0)
QUIT ;
"RTN","PSOCIDC1",83,0)
 L -^XTMP(NAMSP)
"RTN","PSOCIDC1",84,0)
 Q
"RTN","PSOCIDC1",85,0)
EN ;
"RTN","PSOCIDC1",86,0)
 N NAMSP S NAMSP=$$NAMSP
"RTN","PSOCIDC1",87,0)
 ;if can't get Lock, then already running.
"RTN","PSOCIDC1",88,0)
 L +^XTMP(NAMSP):3 I '$T D  Q
"RTN","PSOCIDC1",89,0)
 . S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCIDC1",90,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="LOCKED^"_$$NOW^XLFDT
"RTN","PSOCIDC1",91,0)
 ;
"RTN","PSOCIDC1",92,0)
 N DFN,PSODT,RXP,PSOTEXT,XX,YY,PSOCNT,PSOUCNT,PSOCCNT,PSOSTART,PSOEND,PSOVETS,PSOCVETS,PSOUVETS,PSOTRX,XIEN
"RTN","PSOCIDC1",93,0)
 N PSOSCMX,PSODFN,PSOUDFN,PSOREL,PSOAMT,PSOCAMT,PSOUAMT,FOUND,PSOTRF,PSOEND2,PSOSTRT2,CC
"RTN","PSOCIDC1",94,0)
 N PSOTIME,PSOSTNM,PSOS1,PSOINST,I,PSOTC,PSOCNTS,PSOUCNTS,PSOCCNTS,LIN,%,X1,XMY,STO,PSOSCP
"RTN","PSOCIDC1",95,0)
 D NOW^%DTC S (Y,PSOS1)=% D DD^%DT S PSOSTART=Y
"RTN","PSOCIDC1",96,0)
 S PSOSTRT2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCIDC1",97,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOCIDC1",98,0)
 S PSODT=+$P($G(^XTMP(NAMSP,0,"LAST")),"^",3)
"RTN","PSOCIDC1",99,0)
 S RXP=+$P($G(^XTMP(NAMSP,0,"LAST")),"^",4)
"RTN","PSOCIDC1",100,0)
 ;
"RTN","PSOCIDC1",101,0)
 ;get 1st occurence of install date of patch PSO*7*143 (CIDC)
"RTN","PSOCIDC1",102,0)
 S XIEN=+$O(^XPD(9.7,"B","PSO*7.0*156",0))
"RTN","PSOCIDC1",103,0)
 S:'PSODT PSODT=+$P($G(^XPD(9.7,XIEN,1)),"^",3)
"RTN","PSOCIDC1",104,0)
 I 'PSODT D  Q
"RTN","PSOCIDC1",105,0)
 . S ^XTMP(NAMSP,0,.1)="CIDC PATCH PSO*7*143 IS NOT INSTALLED"
"RTN","PSOCIDC1",106,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="COMPLETED^"_$$NOW^XLFDT
"RTN","PSOCIDC1",107,0)
 . D MAIL3^PSOCIDC3(^XTMP(NAMSP,0,.1))
"RTN","PSOCIDC1",108,0)
 ;
"RTN","PSOCIDC1",109,0)
 S (PSOTRX,PSOTRF)=1
"RTN","PSOCIDC1",110,0)
 N STOP K ^XTMP(NAMSP,0,"STOP") S STOP=0          ;init stop flag to 0
"RTN","PSOCIDC1",111,0)
 F CC=1:1 S PSODT=$O(^PSRX("AD",PSODT)) Q:'PSODT  D  Q:STOP  ;FINISH DATE
"RTN","PSOCIDC1",112,0)
 . I $D(^XTMP(NAMSP,0,"STOP")) D  Q
"RTN","PSOCIDC1",113,0)
 . . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="STOP^"_$$NOW^XLFDT,STOP=1
"RTN","PSOCIDC1",114,0)
 . F PSOTRX=PSOTRX+1:1 S RXP=$O(^PSRX("AD",PSODT,RXP)) Q:'RXP  D
"RTN","PSOCIDC1",115,0)
 .. Q:'$D(^PSRX(RXP,"ICD",0))
"RTN","PSOCIDC1",116,0)
 .. ;save last date & fill info
"RTN","PSOCIDC1",117,0)
 .. S $P(^XTMP(NAMSP,0,"LAST"),"^",3,5)=PSODT_"^"_RXP_"^"_PSOTRX
"RTN","PSOCIDC1",118,0)
 .. S (DFN,PSODFN)=$P($G(^PSRX(RXP,0)),"^",2)
"RTN","PSOCIDC1",119,0)
 .. Q:('PSODFN)!('$D(^DPT(PSODFN,0)))        ;quit, no valid DFN info
"RTN","PSOCIDC1",120,0)
 .. D ELIG^VADPT S PSOSCP="",PSOSCP=$P(VAEL(3),U,2) K VAEL  ;SC percentage
"RTN","PSOCIDC1",121,0)
 .. ;search all fills
"RTN","PSOCIDC1",122,0)
 .. S YY="" F  S YY=$O(^PSRX("AD",PSODT,RXP,YY)) Q:YY=""  D:PSOSCP<50 CHECK^PSOCIDC2
"RTN","PSOCIDC1",123,0)
 G STP:STOP
"RTN","PSOCIDC1",124,0)
 ;
"RTN","PSOCIDC1",125,0)
 S (PSOUCNT,PSOCNT,PSOCCNT)=0
"RTN","PSOCIDC1",126,0)
 D CANCEL^PSOCIDC2 G STP:STOP
"RTN","PSOCIDC1",127,0)
 D TOTAL^PSOCIDC2
"RTN","PSOCIDC1",128,0)
 S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="COMPLETED^"_$$NOW^XLFDT
"RTN","PSOCIDC1",129,0)
 D MAIL^PSOCIDC4
"RTN","PSOCIDC1",130,0)
 D MAIL2^PSOCIDC4
"RTN","PSOCIDC1",131,0)
STP ;
"RTN","PSOCIDC1",132,0)
 L -^XTMP(NAMSP)
"RTN","PSOCIDC1",133,0)
 I $D(^XTMP(NAMSP,0,"STOP")) S ^XTMP(NAMSP,0,"ZAUDIT",$H)="STOPPED ON"_"^"_$P(^XTMP(NAMSP,0,"LAST"),"^",2,5)
"RTN","PSOCIDC1",134,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCIDC1",135,0)
 K JOBN
"RTN","PSOCIDC1",136,0)
 Q
"RTN","PSOCIDC1",137,0)
 ;
"RTN","PSOCIDC1",138,0)
STATUS ;show status of job running
"RTN","PSOCIDC1",139,0)
 I $$ST D
"RTN","PSOCIDC1",140,0)
 . W !,"Currently processing:"
"RTN","PSOCIDC1",141,0)
 . I ^XTMP($$NAMSP,0,"LAST")["COMPLETED" D
"RTN","PSOCIDC1",142,0)
 . . W !,"COMPLETED ON ",$$FMTE^XLFDT($P($G(^XTMP($$NAMSP,0,"LAST")),"^",2)),!
"RTN","PSOCIDC1",143,0)
 . W !?5,"Released Date > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",3)
"RTN","PSOCIDC1",144,0)
 . W !?5,"         RX # > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",4)
"RTN","PSOCIDC1",145,0)
 . W !?5,"   TOTAL RX's > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",5),!
"RTN","PSOCIDC1",146,0)
 . E  D
"RTN","PSOCIDC1",147,0)
 . I ^XTMP($$NAMSP,0,"LAST")["COMPLETED" D
"RTN","PSOCIDC1",148,0)
 . . W !,"COMPLETED ON ",$$FMTE^XLFDT($P($G(^XTMP($$NAMSP,0,"LAST")),"^",2)),!
"RTN","PSOCIDC1",149,0)
 Q
"RTN","PSOCIDC1",150,0)
 ;
"RTN","PSOCIDC1",151,0)
STOP ;stop job command
"RTN","PSOCIDC1",152,0)
 I $$ST S ^XTMP($$NAMSP,0,"STOP")="" D
"RTN","PSOCIDC1",153,0)
 . W !,"Outpatient RX Copay Correction Job - set to STOP Soon"
"RTN","PSOCIDC1",154,0)
 . W !!,"Check Status to be sure it has stopped and is not running..."
"RTN","PSOCIDC1",155,0)
 . W !,"     (D STATUS^PSOCIDC1)"
"RTN","PSOCIDC1",156,0)
 Q
"RTN","PSOCIDC1",157,0)
ST() ;status
"RTN","PSOCIDC1",158,0)
 L +^XTMP($$NAMSP):3 I $T D  Q 0
"RTN","PSOCIDC1",159,0)
 . L -^XTMP($$NAMSP)
"RTN","PSOCIDC1",160,0)
 . W !,"*** NOT CURRENTLY RUNNING! ***",!
"RTN","PSOCIDC1",161,0)
 Q 1
"RTN","PSOCIDC1",162,0)
INITXTMP(NAMSP,TITLE,LIFE) ;create ^Xtmp according to SAC std
"RTN","PSOCIDC1",163,0)
 N BEGDT,PURGDT
"RTN","PSOCIDC1",164,0)
 S BEGDT=$$NOW^XLFDT()
"RTN","PSOCIDC1",165,0)
 S PURGDT=$$FMADD^XLFDT(BEGDT,LIFE)
"RTN","PSOCIDC1",166,0)
 S ^XTMP(NAMSP,0)=PURGDT_"^"_BEGDT_"^"_TITLE
"RTN","PSOCIDC1",167,0)
 Q
"RTN","PSOCIDC1",168,0)
NAMSP() ;
"RTN","PSOCIDC1",169,0)
 Q $T(+0)
"RTN","PSOCIDC2")
0^6^B70634486
"RTN","PSOCIDC2",1,0)
PSOCIDC2 ;BIR/LE-continuation of Copay Correction of erroneous billed copays ;11/8/05 12:50pm
"RTN","PSOCIDC2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**226**;DEC 1997
"RTN","PSOCIDC2",3,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSOCIDC2",4,0)
 ;External reference to IBARX supported by DBIA 125
"RTN","PSOCIDC2",5,0)
 ;External reference to $$PROD^XUPROD(1) supported by DBIA 4440
"RTN","PSOCIDC2",6,0)
 ;
"RTN","PSOCIDC2",7,0)
TOTAL ;
"RTN","PSOCIDC2",8,0)
 N COUNT,COUNTED,UCOUNT,UCOUNTED,CCOUNT,CCOUNTED
"RTN","PSOCIDC2",9,0)
 I '$D(PSOVETS) S PSOVETS=0
"RTN","PSOCIDC2",10,0)
 N I,J
"RTN","PSOCIDC2",11,0)
 F I=1:1:3 S (PSOCNT("YR2004",I),PSOCNT("YR2005",I),PSOCNT("YR2006",I))=0
"RTN","PSOCIDC2",12,0)
 S PSODFN=0 F  S PSODFN=$O(^XTMP(NAMSP,"TOT REL",PSODFN)) Q:'PSODFN  D
"RTN","PSOCIDC2",13,0)
 .S COUNTED=0
"RTN","PSOCIDC2",14,0)
 .F J="YR2004","YR2005","YR2006" F I=1:1:3 S COUNT=$G(^XTMP(NAMSP,"TOT REL",PSODFN,J,I)) I COUNT>0 S:'$G(COUNTED) COUNTED=1,PSOVETS=PSOVETS+1 S PSOCNT(J,I)=PSOCNT(J,I)+COUNT
"RTN","PSOCIDC2",15,0)
 F I=1:1:3 S PSOCNT=PSOCNT+$G(PSOCNT("YR2004",I))+$G(PSOCNT("YR2005",I))+$G(PSOCNT("YR2006",I))
"RTN","PSOCIDC2",16,0)
 ;
"RTN","PSOCIDC2",17,0)
 S (I,J)=-""
"RTN","PSOCIDC2",18,0)
 I '$D(PSOCVETS) S PSOCVETS=0
"RTN","PSOCIDC2",19,0)
 F I=1:1:3 S (PSOCCNT("YR2004",I),PSOCCNT("YR2005",I),PSOCCNT("YR2006",I))=0
"RTN","PSOCIDC2",20,0)
 S PSODFN=0 F  S PSODFN=$O(^XTMP(NAMSP,"TOT CAN",PSODFN)) Q:'PSODFN  D
"RTN","PSOCIDC2",21,0)
 .S CCOUNTED=0
"RTN","PSOCIDC2",22,0)
 .F J="YR2004","YR2005","YR2006" F I=1:1:3 S CCOUNT=$G(^XTMP(NAMSP,"TOT CAN",PSODFN,J,I)) I CCOUNT>0 S:'$G(CCOUNTED) CCOUNTED=1,PSOCVETS=PSOCVETS+1 S PSOCCNT(J,I)=PSOCCNT(J,I)+CCOUNT
"RTN","PSOCIDC2",23,0)
 F I=1:1:3 S PSOCCNT=PSOCCNT+$G(PSOCCNT("YR2004",I))+$G(PSOCCNT("YR2005",I))+$G(PSOCCNT("YR2006",I))
"RTN","PSOCIDC2",24,0)
 ;
"RTN","PSOCIDC2",25,0)
 S (I,J)=""
"RTN","PSOCIDC2",26,0)
 I '$D(PSOUVETS) S PSOUVETS=0
"RTN","PSOCIDC2",27,0)
 F I=1:1:3 S (PSOUCNT("YR2004",I),PSOUCNT("YR2005",I),PSOUCNT("YR2006",I))=0
"RTN","PSOCIDC2",28,0)
 S PSOUDFN=0 F  S PSOUDFN=$O(^XTMP(NAMSP,"TOT UNREL",PSOUDFN)) Q:'PSOUDFN  D
"RTN","PSOCIDC2",29,0)
 .S UCOUNTED=0
"RTN","PSOCIDC2",30,0)
 .F J="YR2004","YR2005","YR2006" F I=1:1:3 S UCOUNT=$G(^XTMP(NAMSP,"TOT UNREL",PSOUDFN,J,I)) I UCOUNT>0 S:'$G(UCOUNTED) UCOUNTED=1,PSOUVETS=PSOUVETS+1 S PSOUCNT(J,I)=PSOUCNT(J,I)+UCOUNT
"RTN","PSOCIDC2",31,0)
 F I=1:1:3 S PSOUCNT=PSOUCNT+$G(PSOUCNT("YR2004",I))+$G(PSOUCNT("YR2005",I))+$G(PSOUCNT("YR2006",I))
"RTN","PSOCIDC2",32,0)
 ;
"RTN","PSOCIDC2",33,0)
 Q
"RTN","PSOCIDC2",34,0)
 ;
"RTN","PSOCIDC2",35,0)
CHECK ;check for ICD and IB nodes
"RTN","PSOCIDC2",36,0)
 ;
"RTN","PSOCIDC2",37,0)
 N PSOREF,PSOIB,PSOOICD,PSOBILLD
"RTN","PSOCIDC2",38,0)
 S PSOREF=YY
"RTN","PSOCIDC2",39,0)
 S PSOOICD=$P($G(^PSRX(RXP,"ICD",1,0)),"^",2,8)
"RTN","PSOCIDC2",40,0)
 ; see if bill already exists
"RTN","PSOCIDC2",41,0)
 I PSOREF=0 D
"RTN","PSOCIDC2",42,0)
 . I +$P($G(^PSRX(RXP,"IB")),"^",2)>0 D CHKIB^PSOCP1
"RTN","PSOCIDC2",43,0)
 . S PSOREL=$P($G(^PSRX(RXP,2)),"^",13)
"RTN","PSOCIDC2",44,0)
 I PSOREF>0 D
"RTN","PSOCIDC2",45,0)
 . I +$G(^PSRX(RXP,1,PSOREF,"IB")) D CHKIB^PSOCP1
"RTN","PSOCIDC2",46,0)
 . S PSOREL=$P($G(^PSRX(RXP,1,YY,0)),"^",18)
"RTN","PSOCIDC2",47,0)
 I $G(PSOIB)=1!($G(PSOIB)=3) S PSOBILLD=1
"RTN","PSOCIDC2",48,0)
 ;    if billed/RELEASED and no IBQ node for both sc<50 and nsc
"RTN","PSOCIDC2",49,0)
 I $G(PSOBILLD)&('$D(^PSRX(RXP,"IBQ"))) D
"RTN","PSOCIDC2",50,0)
 . I $TR(PSOOICD,"^")[1  S ^XTMP(NAMSP,"CANCEL",PSODFN,RXP,YY)=$P(PSOREL,".")_"^"_PSODT_"^"_PSOSCP
"RTN","PSOCIDC2",51,0)
 . I $TR(PSOOICD,"^")[0 S ^XTMP(NAMSP,"NOIBQ",PSODFN,RXP,YY)=$P(PSOREL,".")_"^"_PSODT_"^"_PSOSCP
"RTN","PSOCIDC2",52,0)
 ;           find unbilled ones with an ICD node and no IBQ node.
"RTN","PSOCIDC2",53,0)
 I '$G(PSOBILLD)&('$D(^PSRX(RXP,"IBQ"))) D
"RTN","PSOCIDC2",54,0)
 . Q:$TR(PSOOICD,"^")=""
"RTN","PSOCIDC2",55,0)
 . S ^XTMP(NAMSP,"NOIBQ",PSODFN,RXP,YY)=$P(PSOREL,".")_"^"_PSODT_"^"_PSOSCP
"RTN","PSOCIDC2",56,0)
 I YY S PSOTRF=PSOTRF+1
"RTN","PSOCIDC2",57,0)
 Q
"RTN","PSOCIDC2",58,0)
 ;
"RTN","PSOCIDC2",59,0)
CANCEL ;Cancel erroneous copays/set IBQ node if not there
"RTN","PSOCIDC2",60,0)
 ;released rx's
"RTN","PSOCIDC2",61,0)
 N PSOCAP,PSODIV,PSODV,PSOFILL,PSOLOG,PSONAM,PSOOUT,PSOPAR,PSOPAR7,PSOSITE
"RTN","PSOCIDC2",62,0)
 N PSOSITE7,PSOSQ,PSOTOT,PSOYEAR,PSOYR,SSN,SAVCPUN,SAVREF,PSOIB,PSOOIBQ,PSONIBQ,PSOOICD,PSOOIB
"RTN","PSOCIDC2",63,0)
 N I,IFN,PSOANSQ,PSOTYP,COM,CC,PREA,PSONW,PSOOLD,PSOREL,PSO,PSOCPUN,PSOFLD,PSOTYPE,CANCEL
"RTN","PSOCIDC2",64,0)
 S PSOTYPE="CAN"
"RTN","PSOCIDC2",65,0)
 S PSODFN=0 F CC=1:1 S PSODFN=$O(^XTMP(NAMSP,"CANCEL",PSODFN)) Q:'PSODFN  D  Q:STOP
"RTN","PSOCIDC2",66,0)
 .I CC#100=0,$D(^XTMP(NAMSP,0,"STOP")) D  Q
"RTN","PSOCIDC2",67,0)
 .. S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="STOP^"_$$NOW^XLFDT,STOP=1
"RTN","PSOCIDC2",68,0)
 .S (PSOCAP(304),PSOCAP(305),PSOCAP(306))=0 ; INITIAL ANNUAL CAP FOR 2004 & 2005
"RTN","PSOCIDC2",69,0)
 .F RXP=0:0 S RXP=$O(^XTMP(NAMSP,"CANCEL",PSODFN,RXP)) Q:'RXP  D
"RTN","PSOCIDC2",70,0)
 ..S (SAVCPUN,PSOCPUN)=($P(^PSRX(RXP,0),"^",8)+29)\30
"RTN","PSOCIDC2",71,0)
 ..S YY="" F  S YY=$O(^XTMP(NAMSP,"CANCEL",PSODFN,RXP,YY)) Q:YY=""  D
"RTN","PSOCIDC2",72,0)
 ...S (SAVREF,PSOREF)=YY
"RTN","PSOCIDC2",73,0)
 ...;  verify again that it was billed and not already cancelled
"RTN","PSOCIDC2",74,0)
 ...S PSOBILLD=0
"RTN","PSOCIDC2",75,0)
 ...I YY=0,+$P($G(^PSRX(RXP,"IB")),"^",2)>0 D CHKIB^PSOCP1 I $G(PSOIB)=1!($G(PSOIB)=3) S PSOBILLD=1
"RTN","PSOCIDC2",76,0)
 ...I YY>0,+$P($G(^PSRX(RXP,1,PSOREF,"IB")),"^")>0 D CHKIB^PSOCP1 I $G(PSOIB)=1!($G(PSOIB)=3) S PSOBILLD=1
"RTN","PSOCIDC2",77,0)
 ...Q:'PSOBILLD
"RTN","PSOCIDC2",78,0)
 ...S PSOREL=$P($G(^XTMP(NAMSP,"CANCEL",PSODFN,RXP,YY)),"^"),PSOFLD=$P($G(^XTMP(NAMSP,"CANCEL",PSODFN,RXP,YY)),"^",2),PSOSCP=$P($G(^XTMP(NAMSP,"CANCEL",PSODFN,RXP,YY)),"^",3)
"RTN","PSOCIDC2",79,0)
 ...S PSO=3 D NOW^%DTC S PSODT=%,PSODA=RXP,PSOCOMM="-BKGD CIDC COPAY CANCEL",PSOOLD="",PSONW="",PREA=""
"RTN","PSOCIDC2",80,0)
 ...D CHKACT
"RTN","PSOCIDC2",81,0)
 ...S PSOIB="",PSOIB=$S(PSOREF>0:$G(^PSRX(RXP,1,YY,"IB")),'PSOREF:$G(^PSRX(PSODA,"IB")),1:"")
"RTN","PSOCIDC2",82,0)
 ...S (PSOOIBQ,PSOOICD,PSOOIB)=""
"RTN","PSOCIDC2",83,0)
 ...S PSOOICD=$P($G(^PSRX(RXP,"ICD",1,0)),"^",2,8),PSOOIB=$G(^PSRX(RXP,"IB")),PSOOIBQ=$G(^PSRX(RXP,"IBQ"))
"RTN","PSOCIDC2",84,0)
 ...I PSOOIBQ=""&($TR(PSOOICD,"^")[0!($TR(PSOOICD,"^")[1)) D SETIBQ
"RTN","PSOCIDC2",85,0)
 ...D SITE S PSOCOMM="-BKGD CIDC COPAY CANCEL" D RXED^PSOCPA S:PSOOICD[1&($D(^PSRX(RXP,"IB"))) $P(^PSRX(RXP,"IB"),"^")=""
"RTN","PSOCIDC2",86,0)
 ...S PSOCPUN=SAVCPUN,PSOREF=SAVREF
"RTN","PSOCIDC2",87,0)
 ...D ACCUM
"RTN","PSOCIDC2",88,0)
 ;
"RTN","PSOCIDC2",89,0)
 ;ICD NODES WITHOUT IBQ NODE; set IBQ node but only set 1st piece of IB node if unreleased.
"RTN","PSOCIDC2",90,0)
 S PSOTYP="IBQ"
"RTN","PSOCIDC2",91,0)
 S PSODFN=0 F CC=1:1 S PSODFN=$O(^XTMP(NAMSP,"NOIBQ",PSODFN)) Q:'PSODFN  D  Q:STOP
"RTN","PSOCIDC2",92,0)
 .I CC#100=0,$D(^XTMP(NAMSP,0,"STOP")) D  Q
"RTN","PSOCIDC2",93,0)
 .. S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="STOP^"_$$NOW^XLFDT,STOP=1
"RTN","PSOCIDC2",94,0)
 .S (PSOCAP(304),PSOCAP(305),PSOCAP(306))=0 ; INITIAL ANNUAL CAP FOR 2004 & 2005
"RTN","PSOCIDC2",95,0)
 .F RXP=0:0 S RXP=$O(^XTMP(NAMSP,"NOIBQ",PSODFN,RXP)) Q:'RXP  D
"RTN","PSOCIDC2",96,0)
 ..S (SAVCPUN,PSOCPUN)=($P(^PSRX(RXP,0),"^",8)+29)\30
"RTN","PSOCIDC2",97,0)
 ..S YY="" F  S YY=$O(^XTMP(NAMSP,"NOIBQ",PSODFN,RXP,YY)) Q:YY=""  D
"RTN","PSOCIDC2",98,0)
 ...S (SAVREF,PSOREF)=YY
"RTN","PSOCIDC2",99,0)
 ...D SITE
"RTN","PSOCIDC2",100,0)
 ...S PSOREL=$P($G(^XTMP(NAMSP,"NOIBQ",PSODFN,RXP,YY)),"^"),PSOFLD=$P($G(^XTMP(NAMSP,"NOIBQ",PSODFN,RXP,YY)),"^",2),PSOSCP=$P($G(^XTMP(NAMSP,"NOIBQ",PSODFN,RXP,YY)),"^",3)
"RTN","PSOCIDC2",101,0)
 ...S (PSOOIBQ,PSOOICD,PSOOIB)=""
"RTN","PSOCIDC2",102,0)
 ...S PSOOICD=$P($G(^PSRX(RXP,"ICD",1,0)),"^",2,8),PSOOIB=$G(^PSRX(RXP,"IB")),PSOOIBQ=$G(^PSRX(RXP,"IBQ"))
"RTN","PSOCIDC2",103,0)
 ...I PSOOIBQ=""&($TR(PSOOICD,"^")[0!($TR(PSOOICD,"^")[1)) D SETIBQ D   ;don't want to set again if already did it as part of copay cancel
"RTN","PSOCIDC2",104,0)
 ....S I="",IFN=0 F I=0:0 S I=$O(^PSRX(RXP,"A",I)) Q:'I  S IFN=I
"RTN","PSOCIDC2",105,0)
 ....S COM=" BKGD CIDC UPDATE"
"RTN","PSOCIDC2",106,0)
 ....D NOW^%DTC S IFN=IFN+1,^PSRX(RXP,"A",0)="^52.3DA^"_IFN_"^"_IFN,^PSRX(RXP,"A",IFN,0)=%_"^I^.5^"_YY_"^"_COM
"RTN","PSOCIDC2",107,0)
 ....K DA
"RTN","PSOCIDC2",108,0)
 ....S:PSOOICD[1&($D(^PSRX(RXP,"IB"))) $P(^PSRX(RXP,"IB"),"^")=""
"RTN","PSOCIDC2",109,0)
 ...D:'$G(^XTMP(NAMSP,"CANCEL",PSODFN,RXP,YY)) ACCUM
"RTN","PSOCIDC2",110,0)
 ...S PSOCPUN=SAVCPUN,PSOREF=SAVREF
"RTN","PSOCIDC2",111,0)
 Q
"RTN","PSOCIDC2",112,0)
 ;
"RTN","PSOCIDC2",113,0)
CHKACT ;check activity log for prev entry
"RTN","PSOCIDC2",114,0)
 N ZACT,ZPSI,ZACTI
"RTN","PSOCIDC2",115,0)
 S ZPSI=0 F  S ZPSI=$O(^PSRX(PSODA,"COPAY",ZPSI)) Q:ZPSI=""  S ZACTI="",ZACTI=$G(^PSRX(PSODA,"COPAY",ZPSI,0)) D  Q:$G(ZACT)
"RTN","PSOCIDC2",116,0)
 . I ZACTI["BKGD CIDC COPAY CANCEL"&($P(ZACTI,"^",2)="R") S PSOOLD="",PSONW="",PREA="C",ZACT=1 Q
"RTN","PSOCIDC2",117,0)
 I '$G(ZACT) S PSOOLD="Copay",PSONW="No Copay",PREA="R" K PSOREF D ACTLOG^PSOCPA S PSOREF=YY,PSOOLD="",PSONW="",PREA="C"
"RTN","PSOCIDC2",118,0)
 Q
"RTN","PSOCIDC2",119,0)
 ;
"RTN","PSOCIDC2",120,0)
SETIBQ ; get data from IBQ node, set IBQ node, and 1st piece of IB node
"RTN","PSOCIDC2",121,0)
 K PSOANSQ
"RTN","PSOCIDC2",122,0)
 N PSONIBQ
"RTN","PSOCIDC2",123,0)
 F PSOTYP=1:1:7 D
"RTN","PSOCIDC2",124,0)
 . I PSOTYP=1 S PSOANSQ("VEH")=$P(PSOOICD,"^",PSOTYP)
"RTN","PSOCIDC2",125,0)
 . I PSOTYP=2 S PSOANSQ("RAD")=$P(PSOOICD,"^",PSOTYP)
"RTN","PSOCIDC2",126,0)
 . I PSOTYP=3 S PSOANSQ("SC")=$P(PSOOICD,"^",PSOTYP)
"RTN","PSOCIDC2",127,0)
 . I PSOTYP=4 S PSOANSQ("PGW")=$P(PSOOICD,"^",PSOTYP)
"RTN","PSOCIDC2",128,0)
 . I PSOTYP=5 S PSOANSQ("MST")=$P(PSOOICD,"^",PSOTYP)
"RTN","PSOCIDC2",129,0)
 . I PSOTYP=6 S PSOANSQ("HNC")=$P(PSOOICD,"^",PSOTYP)
"RTN","PSOCIDC2",130,0)
 . I PSOTYP=7 S PSOANSQ("CV")=$P(PSOOICD,"^",PSOTYP)
"RTN","PSOCIDC2",131,0)
 S ^PSRX(RXP,"IBQ")=PSOANSQ("SC")_"^"_PSOANSQ("MST")_"^"_PSOANSQ("VEH")_"^"_PSOANSQ("RAD")_"^"_PSOANSQ("PGW")_"^"_PSOANSQ("HNC")_"^"_PSOANSQ("CV")
"RTN","PSOCIDC2",132,0)
 Q
"RTN","PSOCIDC2",133,0)
 ;
"RTN","PSOCIDC2",134,0)
ACCUM ; ACCUMULATE TOTALS
"RTN","PSOCIDC2",135,0)
 S (PSOTOT,PSOYR,PSOYEAR,PSOLOG,PSONAM,PSOCHRG)=""
"RTN","PSOCIDC2",136,0)
 ; get finished, but unreleased totals
"RTN","PSOCIDC2",137,0)
 I PSOREL="" S PSOYR=$E(PSOFLD,1,3) Q:PSOYR=""  D  S PSOYEAR="" Q
"RTN","PSOCIDC2",138,0)
 .S PSOYEAR=$S(PSOYR="304":"YR2004",PSOYR="305":"YR2005",PSOYR="306":"YR2006",1:"") Q:PSOYEAR=""
"RTN","PSOCIDC2",139,0)
 .S PSOCHRG=7
"RTN","PSOCIDC2",140,0)
 .I PSOYEAR="YR2006" S PSOCHRG=8
"RTN","PSOCIDC2",141,0)
 .S PSOTOT=$G(^XTMP(NAMSP,"TOT UNREL",PSODFN,PSOYEAR))
"RTN","PSOCIDC2",142,0)
 .S ^XTMP(NAMSP,"TOT UNREL",PSODFN,PSOYEAR)=PSOTOT+(PSOCPUN*PSOCHRG)
"RTN","PSOCIDC2",143,0)
 .S ^XTMP(NAMSP,"TOT UNREL",PSODFN,PSOYEAR,PSOCPUN)=$G(^XTMP(NAMSP,"TOT UNREL",PSODFN,PSOYEAR,PSOCPUN))+1
"RTN","PSOCIDC2",144,0)
 .S PSONAM=$P($G(^DPT(PSODFN,0)),"^"),PSONAM=$P(PSONAM,",")
"RTN","PSOCIDC2",145,0)
 .S PSONAM=$E(PSONAM,1,6)
"RTN","PSOCIDC2",146,0)
 .S ^XTMP(NAMSP,"IBQ UPD",PSONAM,PSODFN,RXP,PSOREF)=PSOFLD
"RTN","PSOCIDC2",147,0)
 ;for released ones
"RTN","PSOCIDC2",148,0)
 S PSOYR=$E(PSOREL,1,3)
"RTN","PSOCIDC2",149,0)
 S:PSOYR'="" PSOYEAR=$S(PSOYR="304":"YR2004",PSOYR="305":"YR2005",PSOYR="306":"YR2006",1:"")
"RTN","PSOCIDC2",150,0)
 Q:PSOYEAR=""
"RTN","PSOCIDC2",151,0)
 S PSOCHRG=7
"RTN","PSOCIDC2",152,0)
 I PSOYEAR="YR2006" S PSOCHRG=8
"RTN","PSOCIDC2",153,0)
 ;
"RTN","PSOCIDC2",154,0)
 ;get Xtmp billing amt which would be IBAM tot + any previous refills
"RTN","PSOCIDC2",155,0)
 S PSOTOT=$G(^XTMP(NAMSP,"TOT REL",PSODFN,PSOYEAR))
"RTN","PSOCIDC2",156,0)
 ;
"RTN","PSOCIDC2",157,0)
 ;if none yet then init to the IBAM total for the year
"RTN","PSOCIDC2",158,0)
 I 'PSOTOT D
"RTN","PSOCIDC2",159,0)
 .F PSOSQ=0:0 S PSOSQ=$O(^IBAM(354.7,PSODFN,1,PSOSQ)) Q:'PSOSQ  D
"RTN","PSOCIDC2",160,0)
 ..S PSOLOG=$G(^IBAM(354.7,PSODFN,1,PSOSQ,0))
"RTN","PSOCIDC2",161,0)
 ..I $E(PSOLOG,1,3)=PSOYR S PSOTOT=PSOTOT+$P(PSOLOG,"^",2)
"RTN","PSOCIDC2",162,0)
 ;
"RTN","PSOCIDC2",163,0)
 ;update Xtmp tot nodes with current fill amounts
"RTN","PSOCIDC2",164,0)
 ;  note:  cancel copays and updated IBQ node released prescription are collected under TOT REL for the RPT^PSOCIDC3
"RTN","PSOCIDC2",165,0)
 ;             routine.  Cancelled copays are denoted with an asterisk.
"RTN","PSOCIDC2",166,0)
 S ^XTMP(NAMSP,"TOT REL",PSODFN,PSOYEAR)=PSOTOT+(PSOCPUN*PSOCHRG)
"RTN","PSOCIDC2",167,0)
 S ^XTMP(NAMSP,"TOT REL",PSODFN,PSOYEAR,PSOCPUN)=$G(^XTMP(NAMSP,"TOT REL",PSODFN,PSOYEAR,PSOCPUN))+1
"RTN","PSOCIDC2",168,0)
 ;
"RTN","PSOCIDC2",169,0)
 ;indicate COPAY CANCEL for this fill 
"RTN","PSOCIDC2",170,0)
 ;       ;by adding to Xtmp "BILLED"
"RTN","PSOCIDC2",171,0)
 S PSONAM=$P($G(^DPT(PSODFN,0)),"^"),PSONAM=$P(PSONAM,",")
"RTN","PSOCIDC2",172,0)
 S PSONAM=$E(PSONAM,1,6)
"RTN","PSOCIDC2",173,0)
 S ^XTMP(NAMSP,"REL",PSONAM,PSODFN,RXP,PSOREF)=PSOREL
"RTN","PSOCIDC2",174,0)
 ;
"RTN","PSOCIDC2",175,0)
CAN I PSOTYPE="CAN"&($G(^XTMP(NAMSP,"CANCEL",PSODFN,RXP,YY))) N PSOFILL S CANCEL="" S PSOFILL=YY D CHK^PSOCIDC3 I CANCEL D
"RTN","PSOCIDC2",176,0)
 . S ^XTMP(NAMSP,"TOT CAN",PSODFN,PSOYEAR)=PSOTOT+(PSOCPUN*PSOCHRG)
"RTN","PSOCIDC2",177,0)
 . S ^XTMP(NAMSP,"TOT CAN",PSODFN,PSOYEAR,PSOCPUN)=$G(^XTMP(NAMSP,"TOT CAN",PSODFN,PSOYEAR,PSOCPUN))+1
"RTN","PSOCIDC2",178,0)
 Q
"RTN","PSOCIDC2",179,0)
 ;
"RTN","PSOCIDC2",180,0)
SITE ; SET UP VARIABLES NEEDED BY BILLING
"RTN","PSOCIDC2",181,0)
 S PSOSITE=$S(YY=0:$P(^PSRX(RXP,2),"^",9),1:$P($G(^PSRX(RXP,1,YY,0)),"^",9))
"RTN","PSOCIDC2",182,0)
 Q:PSOSITE=""
"RTN","PSOCIDC2",183,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1))
"RTN","PSOCIDC2",184,0)
 S PSOPAR7=$G(^PS(59,PSOSITE,"IB"))
"RTN","PSOCIDC2",185,0)
 S PSOSITE7=$P($G(^PS(59,PSOSITE,"IB")),"^")
"RTN","PSOCIDC2",186,0)
 Q
"RTN","PSOCIDC2",187,0)
 ;
"RTN","PSOCIDC3")
0^7^B43379204
"RTN","PSOCIDC3",1,0)
PSOCIDC3 ;BIR/LE - continuation of Copay Correction of erroneous billed copays ;11/08/05 1:56pm
"RTN","PSOCIDC3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**226**;DEC 1997
"RTN","PSOCIDC3",3,0)
 ;
"RTN","PSOCIDC3",4,0)
RPT ;
"RTN","PSOCIDC3",5,0)
 N JOBN,NAMSP,ZTDESC,ZTRTN
"RTN","PSOCIDC3",6,0)
 S NAMSP=$$NAMSP^PSOCIDC1
"RTN","PSOCIDC3",7,0)
 S JOBN="Copay Corrections"
"RTN","PSOCIDC3",8,0)
 L +^XTMP(NAMSP):0 I '$T D  Q
"RTN","PSOCIDC3",9,0)
 .W !,JOBN_" job for PSO*7*226 is still running.  Halting..."
"RTN","PSOCIDC3",10,0)
 L -^XTMP(NAMSP)
"RTN","PSOCIDC3",11,0)
 W !!,"This report shows the patient name and prescription information for"
"RTN","PSOCIDC3",12,0)
 W !,"copay field corrections and copays billed erroneously that were cancelled"
"RTN","PSOCIDC3",13,0)
 W !,"by the patch PSO*7*226."
"RTN","PSOCIDC3",14,0)
 ;
"RTN","PSOCIDC3",15,0)
 W !!,"You may queue the report to print, if you wish.",!
"RTN","PSOCIDC3",16,0)
 ;
"RTN","PSOCIDC3",17,0)
DVC K %ZIS,POP,IOP S %ZIS="QM" D ^%ZIS I $G(POP) W !!,"Nothing queued to print.",! G DONE
"RTN","PSOCIDC3",18,0)
QUEUE I $D(IO("Q")) S ZTRTN="START^PSOCIDC3",ZTDESC=JOBN_" copay cancellation report" D ^%ZTLOAD K %ZSI W !,"Report queued to print.",! G DONE
"RTN","PSOCIDC3",19,0)
START ;
"RTN","PSOCIDC3",20,0)
 U IO
"RTN","PSOCIDC3",21,0)
 N BLDT,RXO,NAMSP,PSOFILL,PSODFN,PSONAM,PSOOUT,PSODV,RXP,SSN,PSODIV,PSODV
"RTN","PSOCIDC3",22,0)
 N CANCEL,JOBN,PSOPATID,PSOTOT,PSOTOTC
"RTN","PSOCIDC3",23,0)
 S NAMSP=$$NAMSP^PSOCIDC1
"RTN","PSOCIDC3",24,0)
 S JOBN="Copay Corrections"
"RTN","PSOCIDC3",25,0)
 S PSOOUT=0,PSODV=$S($E(IOST)="C":"C",1:"P")
"RTN","PSOCIDC3",26,0)
 S PSOPGCT=0,PSOPGLN=IOSL-7,PSOPGCT=1
"RTN","PSOCIDC3",27,0)
 S BLDT=$P($G(^XTMP(NAMSP,0,"LAST")),"^",2)
"RTN","PSOCIDC3",28,0)
 I '$D(DT) S DT=$$NOW^XLFDT
"RTN","PSOCIDC3",29,0)
 D TITLE
"RTN","PSOCIDC3",30,0)
 S (PSOTOT,PSOTOTC,PSONAM)=""
"RTN","PSOCIDC3",31,0)
 F  S PSONAM=$O(^XTMP(NAMSP,"REL",PSONAM)) Q:PSONAM=""  D
"RTN","PSOCIDC3",32,0)
 .S PSODFN=""
"RTN","PSOCIDC3",33,0)
 .F  S PSODFN=$O(^XTMP(NAMSP,"REL",PSONAM,PSODFN)) Q:PSODFN=""  D
"RTN","PSOCIDC3",34,0)
 ..S RXP=""
"RTN","PSOCIDC3",35,0)
 ..F  S RXP=$O(^XTMP(NAMSP,"REL",PSONAM,PSODFN,RXP)) Q:RXP=""  D
"RTN","PSOCIDC3",36,0)
 ...S PSOFILL=""
"RTN","PSOCIDC3",37,0)
 ...F  S PSOFILL=$O(^XTMP(NAMSP,"REL",PSONAM,PSODFN,RXP,PSOFILL)) Q:PSOFILL=""  D
"RTN","PSOCIDC3",38,0)
 ....N XX,RXO,Y,PSONAME
"RTN","PSOCIDC3",39,0)
 ....S XX=$G(^XTMP(NAMSP,"REL",PSONAM,PSODFN,RXP,PSOFILL)) D   ;NOTE THIS IS THE RELEASE DATE
"RTN","PSOCIDC3",40,0)
 .....D FULL Q:$G(PSOOUT)  S PSONAME=$P($G(^DPT(PSODFN,0)),"^")
"RTN","PSOCIDC3",41,0)
 .....S CANCEL="" I $D(^XTMP(NAMSP,"CANCEL",PSODFN,RXP,PSOFILL)) D CHK S:CANCEL PSOTOTC=PSOTOTC+1
"RTN","PSOCIDC3",42,0)
 .....W !,$S(CANCEL:"*",1:"") W:CANCEL $E(PSONAME,1,14) W:'CANCEL ?1,$E(PSONAME,1,14)
"RTN","PSOCIDC3",43,0)
 .....D PRTSSN
"RTN","PSOCIDC3",44,0)
 .....S RXO=$P($G(^PSRX(RXP,0)),"^")
"RTN","PSOCIDC3",45,0)
 .....W ?41," ",RXO," (",PSOFILL,")"
"RTN","PSOCIDC3",46,0)
 .....S Y=XX I Y>0 X ^DD("DD")
"RTN","PSOCIDC3",47,0)
 .....W ?55," ",Y
"RTN","PSOCIDC3",48,0)
 .....W ?69,$S($$PTCOV^IBCNSU3(PSODFN,XX,"PHARMACY"):"YES",1:" NO")
"RTN","PSOCIDC3",49,0)
 .....W ?75,$S($$PTCOV^IBCNSU3(PSODFN,BLDT,"PHARMACY"):"YES",1:" NO")
"RTN","PSOCIDC3",50,0)
 .....S PSOTOT=PSOTOT+1
"RTN","PSOCIDC3",51,0)
 W !!,"Total number of released prescriptions modified: ",PSOTOT
"RTN","PSOCIDC3",52,0)
 W !,"Total number of Cancelled Copay prescriptions: ",PSOTOTC
"RTN","PSOCIDC3",53,0)
 ;
"RTN","PSOCIDC3",54,0)
 ;UNRELEASED CORRECTED RX'S
"RTN","PSOCIDC3",55,0)
 D TITLE2
"RTN","PSOCIDC3",56,0)
 S (PSOTOT,PSONAM)=""
"RTN","PSOCIDC3",57,0)
 F  S PSONAM=$O(^XTMP(NAMSP,"IBQ UPD",PSONAM)) Q:PSONAM=""  D
"RTN","PSOCIDC3",58,0)
 .S PSODFN=""
"RTN","PSOCIDC3",59,0)
 .F  S PSODFN=$O(^XTMP(NAMSP,"IBQ UPD",PSONAM,PSODFN)) Q:PSODFN=""  D
"RTN","PSOCIDC3",60,0)
 ..S RXP=""
"RTN","PSOCIDC3",61,0)
 ..F  S RXP=$O(^XTMP(NAMSP,"IBQ UPD",PSONAM,PSODFN,RXP)) Q:RXP=""  D
"RTN","PSOCIDC3",62,0)
 ...S PSOFILL=""
"RTN","PSOCIDC3",63,0)
 ...F  S PSOFILL=$O(^XTMP(NAMSP,"IBQ UPD",PSONAM,PSODFN,RXP,PSOFILL)) Q:PSOFILL=""  D
"RTN","PSOCIDC3",64,0)
 ....N XX,RXO,Y,PSONAME
"RTN","PSOCIDC3",65,0)
 ....S XX=$G(^XTMP(NAMSP,"IBQ UPD",PSONAM,PSODFN,RXP,PSOFILL)) D  ;NOTE THIS IS THE FILL DATE
"RTN","PSOCIDC3",66,0)
 .....D FULL Q:$G(PSOOUT)  S PSONAME=$P($G(^DPT(PSODFN,0)),"^")
"RTN","PSOCIDC3",67,0)
 .....W !,$E(PSONAME,1,14)
"RTN","PSOCIDC3",68,0)
 .....D PRTSSN
"RTN","PSOCIDC3",69,0)
 .....S RXO=$P($G(^PSRX(RXP,0)),"^")
"RTN","PSOCIDC3",70,0)
 .....W ?41," ",RXO," (",PSOFILL,")"
"RTN","PSOCIDC3",71,0)
 .....S Y=XX I Y>0 X ^DD("DD")
"RTN","PSOCIDC3",72,0)
 .....W ?55," ",Y
"RTN","PSOCIDC3",73,0)
 .....W ?69,$S($$PTCOV^IBCNSU3(PSODFN,XX,"PHARMACY"):"YES",1:" NO")
"RTN","PSOCIDC3",74,0)
 .....W ?75,$S($$PTCOV^IBCNSU3(PSODFN,BLDT,"PHARMACY"):"YES",1:" NO")
"RTN","PSOCIDC3",75,0)
 .....S PSOTOT=PSOTOT+1
"RTN","PSOCIDC3",76,0)
 W !!,"Total number of un-released prescriptions modified: ",PSOTOT
"RTN","PSOCIDC3",77,0)
 G END
"RTN","PSOCIDC3",78,0)
 ;
"RTN","PSOCIDC3",79,0)
FULL ;
"RTN","PSOCIDC3",80,0)
 I ($Y+7)>IOSL&('$G(PSOOUT)) D TITLE
"RTN","PSOCIDC3",81,0)
 Q
"RTN","PSOCIDC3",82,0)
 ;
"RTN","PSOCIDC3",83,0)
CHK ;VERIFY COPAY WAS CANCELLED
"RTN","PSOCIDC3",84,0)
 N IBN,PSOREF,PSOIB,XX S PSOREF=PSOFILL
"RTN","PSOCIDC3",85,0)
 I PSOREF=0 S XX=$G(^PSRX(RXP,"IB")),IBN=$P(XX,"^",2)
"RTN","PSOCIDC3",86,0)
 I PSOREF>0 S XX=$G(^PSRX(RXP,1,PSOREF,"IB")),IBN=$P(XX,"^",1)
"RTN","PSOCIDC3",87,0)
 S XX=$$STATUS^IBARX(IBN)
"RTN","PSOCIDC3",88,0)
 S:$G(XX)=2 CANCEL=1
"RTN","PSOCIDC3",89,0)
 Q
"RTN","PSOCIDC3",90,0)
 ;
"RTN","PSOCIDC3",91,0)
TITLE ;
"RTN","PSOCIDC3",92,0)
 I $G(PSODV)="C",$G(PSOPGCT)'=1 W ! K DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSOOUT=1 Q
"RTN","PSOCIDC3",93,0)
 ;
"RTN","PSOCIDC3",94,0)
 W @IOF D
"RTN","PSOCIDC3",95,0)
 . W !,"Patch PSO*7*226 -Corrected Released Prescriptions "
"RTN","PSOCIDC3",96,0)
 . W !!,"Note that prescriptions where copay was cancelled are denoted with"
"RTN","PSOCIDC3",97,0)
 . W !,"an asterisk (*) in front of the patient name.  Otherwise, only  the"
"RTN","PSOCIDC3",98,0)
 . W !,"the IBQ node was updated.",!
"RTN","PSOCIDC3",99,0)
 S Y=DT X ^DD("DD") W !,"Date printed: ",Y,?70,"Page: ",PSOPGCT,!
"RTN","PSOCIDC3",100,0)
 F MJT=1:1:79 W "="
"RTN","PSOCIDC3",101,0)
 W !,?69,"INS ON DTE"
"RTN","PSOCIDC3",102,0)
 W !,"PATIENT NAME     (SSN)       DIV",?42,"RX# (FILL)",?55,"RELEASE DATE",?69,"REL   BILL"
"RTN","PSOCIDC3",103,0)
 W !,"---------------  -------  --------------",?42,"------------"
"RTN","PSOCIDC3",104,0)
 W ?55,"------------",?69,"---- -----"
"RTN","PSOCIDC3",105,0)
 S PSOPGCT=PSOPGCT+1
"RTN","PSOCIDC3",106,0)
 Q
"RTN","PSOCIDC3",107,0)
TITLE2 ;
"RTN","PSOCIDC3",108,0)
 I $G(PSODV)="C",$G(PSOPGCT)'=1 W ! K DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSOOUT=1 Q
"RTN","PSOCIDC3",109,0)
 ;
"RTN","PSOCIDC3",110,0)
 W @IOF D
"RTN","PSOCIDC3",111,0)
 . W !,"Patch PSO*7*226 -Corrected Unreleased Prescriptions "
"RTN","PSOCIDC3",112,0)
 S Y=DT X ^DD("DD") W !,"Date printed: ",Y,?70,"Page: ",PSOPGCT,!
"RTN","PSOCIDC3",113,0)
 F MJT=1:1:79 W "="
"RTN","PSOCIDC3",114,0)
 W !,?69,"INS ON DTE"
"RTN","PSOCIDC3",115,0)
 W !,"PATIENT NAME     (SSN)       DIV",?43,"RX# (FILL)",?55,"FILL DATE",?69,"REL   BILL"
"RTN","PSOCIDC3",116,0)
 W !,"--------------  -------  ----------------",?42,"------------"
"RTN","PSOCIDC3",117,0)
 W ?55,"------------",?69,"---- -----"
"RTN","PSOCIDC3",118,0)
 S PSOPGCT=PSOPGCT+1
"RTN","PSOCIDC3",119,0)
 Q
"RTN","PSOCIDC3",120,0)
END ;
"RTN","PSOCIDC3",121,0)
 I '$G(PSOOUT),$G(PSODV)="C" W !!,"** End of Report **" K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOCIDC3",122,0)
 I $G(PSODV)="C" W !
"RTN","PSOCIDC3",123,0)
 E  W @IOF
"RTN","PSOCIDC3",124,0)
DONE ;
"RTN","PSOCIDC3",125,0)
 K MJT,PSOPGCT,PSOPGLN,Y,DIR,X,IOP,POP,IO("Q"),DIRUT,DUOUT,DTOUT
"RTN","PSOCIDC3",126,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCIDC3",127,0)
 Q
"RTN","PSOCIDC3",128,0)
 ;
"RTN","PSOCIDC3",129,0)
PRTSSN ;
"RTN","PSOCIDC3",130,0)
 S SSN=$P(^DPT(PSODFN,0),"^",9),SSN=$E(SSN,$L(SSN)-3,$L(SSN))
"RTN","PSOCIDC3",131,0)
 S PSOPATID=$E(PSONAM,1)_SSN
"RTN","PSOCIDC3",132,0)
 S PSODIV=$P($G(^PSRX(RXP,2)),"^",9)
"RTN","PSOCIDC3",133,0)
 S:PSODIV'="" PSODIV=$P($G(^PS(59,PSODIV,0)),"^",1)
"RTN","PSOCIDC3",134,0)
 W ?17,"("_PSOPATID_")"_"  "_$E(PSODIV,1,15)
"RTN","PSOCIDC3",135,0)
 Q
"RTN","PSOCIDC3",136,0)
 ;
"RTN","PSOCIDC3",137,0)
ETIME(SECTIME) ;convert seconds to day:hr:min:sec
"RTN","PSOCIDC3",138,0)
 N DAY,HR,MIN,SEC,ETIM
"RTN","PSOCIDC3",139,0)
 S (DAY,HR,MIN,SEC)=""
"RTN","PSOCIDC3",140,0)
 I SECTIME>86400 S DAY=SECTIME\86400,SECTIME=SECTIME#86400
"RTN","PSOCIDC3",141,0)
 I SECTIME>3600 S HR=SECTIME\3600,SECTIME=SECTIME#3600
"RTN","PSOCIDC3",142,0)
 I SECTIME>60 S MIN=SECTIME\60,SECTIME=SECTIME#60
"RTN","PSOCIDC3",143,0)
 S SEC=SECTIME
"RTN","PSOCIDC3",144,0)
 S ETIM=""
"RTN","PSOCIDC3",145,0)
 S:$L(HR)=1 HR=0_HR S:$L(MIN)=1 MIN=0_MIN S:$L(SEC)=1 SEC=0_SEC
"RTN","PSOCIDC3",146,0)
 S:DAY ETIM=DAY_" Day " S:HR ETIM=ETIM_HR_":" S:MIN ETIM=ETIM_MIN
"RTN","PSOCIDC3",147,0)
 S ETIM=ETIM_":"_SEC
"RTN","PSOCIDC3",148,0)
 Q ETIM
"RTN","PSOCIDC3",149,0)
 ;
"RTN","PSOCIDC3",150,0)
MAIL3(MSG) ;management mail message
"RTN","PSOCIDC3",151,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCIDC3",152,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCIDC3",153,0)
 K PSOTEXT
"RTN","PSOCIDC3",154,0)
 S XMY(DUZ)=""
"RTN","PSOCIDC3",155,0)
 S XMY("ELLZEY.LINDA@FORUM.VA.GOV")=""
"RTN","PSOCIDC3",156,0)
 S:$$PROD^XUPROD(1) XMY("ELLZEY.LINDA@FORUM.VA.GOV")=""
"RTN","PSOCIDC3",157,0)
 S XMDUZ="PSO*7*226 "_JOBN
"RTN","PSOCIDC3",158,0)
 S XMSUB="STATION "_$G(PSOINST)
"RTN","PSOCIDC3",159,0)
 S XMSUB=XMSUB_$S($$PROD^XUPROD(1):" (Prod)",1:" (Test)")
"RTN","PSOCIDC3",160,0)
 S XMSUB=XMSUB_" CANCELLED COPAYS FOR ERRONEOUSLY BILLED PRESCRIPTION FILLS"
"RTN","PSOCIDC3",161,0)
 S PSOTEXT(1)=""
"RTN","PSOCIDC3",162,0)
 S PSOTEXT(2)="Started "_PSOSTART
"RTN","PSOCIDC3",163,0)
 S PSOTEXT(3)=""
"RTN","PSOCIDC3",164,0)
 S PSOTEXT(4)="   "_MSG
"RTN","PSOCIDC3",165,0)
 S PSOTEXT(5)=""
"RTN","PSOCIDC3",166,0)
 S PSOTEXT(6)="NO FURTHER ACTION REQUIRED."
"RTN","PSOCIDC3",167,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCIDC3",168,0)
 Q
"RTN","PSOCIDC3",169,0)
 ;
"RTN","PSOCIDC4")
0^8^B67222951
"RTN","PSOCIDC4",1,0)
PSOCIDC4 ;BIR/LE - continuation of Copay Correction of erroneous billed copays ;11/08/05 1:56pm
"RTN","PSOCIDC4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**226**;DEC 1997
"RTN","PSOCIDC4",3,0)
 ;
"RTN","PSOCIDC4",4,0)
MAIL ;user mail message
"RTN","PSOCIDC4",5,0)
 N TOTAMT,TOTUAMT,TOTCAMT,PSOCXPDA,PSOCHRG
"RTN","PSOCIDC4",6,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCIDC4",7,0)
 S PSOEND2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCIDC4",8,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","PSOCIDC4",9,0)
 S XMDUZ="PSO*7*226 "_JOBN
"RTN","PSOCIDC4",10,0)
 S XMSUB="Outpatient Pharmacy PSO*7*226 "_JOBN
"RTN","PSOCIDC4",11,0)
 S XMY("ELLZEY.LINDA@FORUM.VA.GOV")=""
"RTN","PSOCIDC4",12,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSO COPAY",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOCIDC4",13,0)
 I $O(XMY(""))="" Q  ; no recipients for mail message
"RTN","PSOCIDC4",14,0)
 S PSOTEXT(1)="The Rx "_JOBN_" job for the Outpatient Pharmacy patch (PSO*7*226)"
"RTN","PSOCIDC4",15,0)
 S PSOTEXT(2)="started "_PSOSTART_" and completed "_PSOEND_"."
"RTN","PSOCIDC4",16,0)
 S PSOTEXT(3)=" "
"RTN","PSOCIDC4",17,0)
 I PSOCCNT=0 S PSOTEXT(4)="No erroneously billed copay fills were found."
"RTN","PSOCIDC4",18,0)
 I PSOCNT=0 S PSOTEXT(5)="No released prescriptions were found that needed IBQ node corrections."
"RTN","PSOCIDC4",19,0)
 I PSOUCNT=0 S PSOTEXT(6)="No un-released prescription were found that needed IBQ node corrections."
"RTN","PSOCIDC4",20,0)
 I PSOCNT>0!(PSOUCNT>0)!(PSOCCNT>0) D
"RTN","PSOCIDC4",21,0)
 . S (TOTUAMT,TOTAMT,TOTCAMT)=0
"RTN","PSOCIDC4",22,0)
 . F XX="YR2004","YR2005","YR2006" D
"RTN","PSOCIDC4",23,0)
 .. S PSOCHRG=7 S:XX="YR2006" PSOCHRG=8
"RTN","PSOCIDC4",24,0)
 .. F YY=1:1:3 S PSOAMT(XX,YY)=PSOCNT(XX,YY)*YY*PSOCHRG,TOTAMT=TOTAMT+PSOAMT(XX,YY)
"RTN","PSOCIDC4",25,0)
 .. F YY=1:1:3 S PSOUAMT(XX,YY)=PSOUCNT(XX,YY)*YY*PSOCHRG,TOTUAMT=TOTUAMT+PSOUAMT(XX,YY)
"RTN","PSOCIDC4",26,0)
 .. F YY=1:1:3 S PSOCAMT(XX,YY)=PSOCCNT(XX,YY)*YY*PSOCHRG,TOTCAMT=TOTCAMT+PSOCAMT(XX,YY)
"RTN","PSOCIDC4",27,0)
 . S PSOTEXT(4)="Erroneously billed prescriptions and copay related fields have been corrected."
"RTN","PSOCIDC4",28,0)
 . S PSOTEXT(5)="There were "_$FN(PSOCNT,",")_" released fills successfully updated for "_$FN(PSOVETS,",")_" veterans."
"RTN","PSOCIDC4",29,0)
 . S PSOTEXT(6)=" "
"RTN","PSOCIDC4",30,0)
 . S PSOTEXT(7)="Released fills corrected by year:"
"RTN","PSOCIDC4",31,0)
 . S PSOTEXT(8)="2004  30-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",1),6)
"RTN","PSOCIDC4",32,0)
 . S PSOTEXT(8)=PSOTEXT(8)_"     $"_$J($FN(PSOAMT("YR2004",1),","),9)
"RTN","PSOCIDC4",33,0)
 . S PSOTEXT(9)="2004  60-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",2),6)
"RTN","PSOCIDC4",34,0)
 . S PSOTEXT(9)=PSOTEXT(9)_"     $"_$J($FN(PSOAMT("YR2004",2),","),9)
"RTN","PSOCIDC4",35,0)
 . S PSOTEXT(10)="2004  90-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2004",3),6)
"RTN","PSOCIDC4",36,0)
 . S PSOTEXT(10)=PSOTEXT(10)_"     $"_$J($FN(PSOAMT("YR2004",3),","),9)
"RTN","PSOCIDC4",37,0)
 . S PSOTEXT(11)=""
"RTN","PSOCIDC4",38,0)
 . S PSOTEXT(12)="2005  30-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",1),6)
"RTN","PSOCIDC4",39,0)
 . S PSOTEXT(12)=PSOTEXT(12)_"     $"_$J($FN(PSOAMT("YR2005",1),","),9)
"RTN","PSOCIDC4",40,0)
 . S PSOTEXT(13)="2005  60-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",2),6)
"RTN","PSOCIDC4",41,0)
 . S PSOTEXT(13)=PSOTEXT(13)_"     $"_$J($FN(PSOAMT("YR2005",2),","),9)
"RTN","PSOCIDC4",42,0)
 . S PSOTEXT(14)="2005  90-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2005",3),6)
"RTN","PSOCIDC4",43,0)
 . S PSOTEXT(14)=PSOTEXT(14)_"     $"_$J($FN(PSOAMT("YR2005",3),","),9)
"RTN","PSOCIDC4",44,0)
 . S PSOTEXT(15)=""
"RTN","PSOCIDC4",45,0)
 . S PSOTEXT(16)="2006  30-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2006",1),6)
"RTN","PSOCIDC4",46,0)
 . S PSOTEXT(16)=PSOTEXT(16)_"     $"_$J($FN(PSOAMT("YR2006",1),","),9)
"RTN","PSOCIDC4",47,0)
 . S PSOTEXT(17)="2006  60-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2006",2),6)
"RTN","PSOCIDC4",48,0)
 . S PSOTEXT(17)=PSOTEXT(17)_"     $"_$J($FN(PSOAMT("YR2006",2),","),9)
"RTN","PSOCIDC4",49,0)
 . S PSOTEXT(18)="2006  90-DAY EQUIVALENT FILLS: "_$J(PSOCNT("YR2006",3),6)
"RTN","PSOCIDC4",50,0)
 . S PSOTEXT(18)=PSOTEXT(18)_"     $"_$J($FN(PSOAMT("YR2006",3),","),9)
"RTN","PSOCIDC4",51,0)
 . S PSOTEXT(19)="                                          =========="
"RTN","PSOCIDC4",52,0)
 . S PSOTEXT(20)="                                    TOTAL $"_$J($FN(TOTAMT,","),9)
"RTN","PSOCIDC4",53,0)
 . S PSOTEXT(21)=" "
"RTN","PSOCIDC4",54,0)
 . S PSOTEXT(22)="Out of the above total, there were "_$FN(PSOCCNT,",")_" cancelled copays for "_$FN(PSOCVETS,",")_" veterans."
"RTN","PSOCIDC4",55,0)
 . S PSOTEXT(23)=" "
"RTN","PSOCIDC4",56,0)
 . S PSOTEXT(24)="COPAY cancelled fills by year:"
"RTN","PSOCIDC4",57,0)
 . S PSOTEXT(25)="2004  30-DAY EQUIVALENT FILLS: "_$J(PSOCCNT("YR2004",1),6)
"RTN","PSOCIDC4",58,0)
 . S PSOTEXT(25)=PSOTEXT(25)_"     $"_$J($FN(PSOCAMT("YR2004",1),","),9)
"RTN","PSOCIDC4",59,0)
 . S PSOTEXT(26)="2004  60-DAY EQUIVALENT FILLS: "_$J(PSOCCNT("YR2004",2),6)
"RTN","PSOCIDC4",60,0)
 . S PSOTEXT(26)=PSOTEXT(26)_"     $"_$J($FN(PSOCAMT("YR2004",2),","),9)
"RTN","PSOCIDC4",61,0)
 . S PSOTEXT(27)="2004  90-DAY EQUIVALENT FILLS: "_$J(PSOCCNT("YR2004",3),6)
"RTN","PSOCIDC4",62,0)
 . S PSOTEXT(27)=PSOTEXT(27)_"     $"_$J($FN(PSOCAMT("YR2004",3),","),9)
"RTN","PSOCIDC4",63,0)
 . S PSOTEXT(28)=""
"RTN","PSOCIDC4",64,0)
 . S PSOTEXT(29)="2005  30-DAY EQUIVALENT FILLS: "_$J(PSOCCNT("YR2005",1),6)
"RTN","PSOCIDC4",65,0)
 . S PSOTEXT(29)=PSOTEXT(29)_"     $"_$J($FN(PSOCAMT("YR2005",1),","),9)
"RTN","PSOCIDC4",66,0)
 . S PSOTEXT(30)="2005  60-DAY EQUIVALENT FILLS: "_$J(PSOCCNT("YR2005",2),6)
"RTN","PSOCIDC4",67,0)
 . S PSOTEXT(30)=PSOTEXT(30)_"     $"_$J($FN(PSOCAMT("YR2005",2),","),9)
"RTN","PSOCIDC4",68,0)
 . S PSOTEXT(31)="2005  90-DAY EQUIVALENT FILLS: "_$J(PSOCCNT("YR2005",3),6)
"RTN","PSOCIDC4",69,0)
 . S PSOTEXT(31)=PSOTEXT(31)_"     $"_$J($FN(PSOCAMT("YR2005",3),","),9)
"RTN","PSOCIDC4",70,0)
 . S PSOTEXT(32)=" "
"RTN","PSOCIDC4",71,0)
 . S PSOTEXT(33)="2006  30-DAY EQUIVALENT FILLS: "_$J(PSOCCNT("YR2006",1),6)
"RTN","PSOCIDC4",72,0)
 . S PSOTEXT(33)=PSOTEXT(33)_"     $"_$J($FN(PSOCAMT("YR2006",1),","),9)
"RTN","PSOCIDC4",73,0)
 . S PSOTEXT(34)="2006  60-DAY EQUIVALENT FILLS: "_$J(PSOCCNT("YR2006",2),6)
"RTN","PSOCIDC4",74,0)
 . S PSOTEXT(34)=PSOTEXT(34)_"     $"_$J($FN(PSOCAMT("YR2006",2),","),9)
"RTN","PSOCIDC4",75,0)
 . S PSOTEXT(35)="2006  90-DAY EQUIVALENT FILLS: "_$J(PSOCCNT("YR2006",3),6)
"RTN","PSOCIDC4",76,0)
 . S PSOTEXT(35)=PSOTEXT(35)_"     $"_$J($FN(PSOCAMT("YR2006",3),","),9)
"RTN","PSOCIDC4",77,0)
 . S PSOTEXT(36)="                                          =========="
"RTN","PSOCIDC4",78,0)
 . S PSOTEXT(37)="                                    TOTAL $"_$J($FN(TOTCAMT,","),9)
"RTN","PSOCIDC4",79,0)
 . S PSOTEXT(38)=" "
"RTN","PSOCIDC4",80,0)
 . S PSOTEXT(39)="There were "_$FN(PSOUCNT,",")_" unreleased fills successfully updated for "_$FN(PSOUVETS,",")_" veterans."
"RTN","PSOCIDC4",81,0)
 . S PSOTEXT(40)=" "
"RTN","PSOCIDC4",82,0)
 . S PSOTEXT(41)="Unreleased fills corrected by year:"
"RTN","PSOCIDC4",83,0)
 . S PSOTEXT(42)="2004  30-DAY EQUIVALENT FILLS: "_$J(PSOUCNT("YR2004",1),6)
"RTN","PSOCIDC4",84,0)
 . S PSOTEXT(42)=PSOTEXT(42)_"     $"_$J($FN(PSOUAMT("YR2004",1),","),9)
"RTN","PSOCIDC4",85,0)
 . S PSOTEXT(43)="2004  60-DAY EQUIVALENT FILLS: "_$J(PSOUCNT("YR2004",2),6)
"RTN","PSOCIDC4",86,0)
 . S PSOTEXT(43)=PSOTEXT(43)_"     $"_$J($FN(PSOUAMT("YR2004",2),","),9)
"RTN","PSOCIDC4",87,0)
 . S PSOTEXT(44)="2004  90-DAY EQUIVALENT FILLS: "_$J(PSOUCNT("YR2004",3),6)
"RTN","PSOCIDC4",88,0)
 . S PSOTEXT(44)=PSOTEXT(44)_"     $"_$J($FN(PSOUAMT("YR2004",3),","),9)
"RTN","PSOCIDC4",89,0)
 . S PSOTEXT(45)=""
"RTN","PSOCIDC4",90,0)
 . S PSOTEXT(46)="2005  30-DAY EQUIVALENT FILLS: "_$J(PSOUCNT("YR2005",1),6)
"RTN","PSOCIDC4",91,0)
 . S PSOTEXT(46)=PSOTEXT(46)_"     $"_$J($FN(PSOUAMT("YR2005",1),","),9)
"RTN","PSOCIDC4",92,0)
 . S PSOTEXT(47)="2005  60-DAY EQUIVALENT FILLS: "_$J(PSOUCNT("YR2005",2),6)
"RTN","PSOCIDC4",93,0)
 . S PSOTEXT(47)=PSOTEXT(47)_"     $"_$J($FN(PSOUAMT("YR2005",2),","),9)
"RTN","PSOCIDC4",94,0)
 . S PSOTEXT(48)="2005  90-DAY EQUIVALENT FILLS: "_$J(PSOUCNT("YR2005",3),6)
"RTN","PSOCIDC4",95,0)
 . S PSOTEXT(48)=PSOTEXT(48)_"     $"_$J($FN(PSOUAMT("YR2005",3),","),9)
"RTN","PSOCIDC4",96,0)
 . S PSOTEXT(49)=" "
"RTN","PSOCIDC4",97,0)
 . S PSOTEXT(50)="2006  30-DAY EQUIVALENT FILLS: "_$J(PSOUCNT("YR2006",1),6)
"RTN","PSOCIDC4",98,0)
 . S PSOTEXT(50)=PSOTEXT(50)_"     $"_$J($FN(PSOUAMT("YR2006",1),","),9)
"RTN","PSOCIDC4",99,0)
 . S PSOTEXT(51)="2006  60-DAY EQUIVALENT FILLS: "_$J(PSOUCNT("YR2006",2),6)
"RTN","PSOCIDC4",100,0)
 . S PSOTEXT(51)=PSOTEXT(51)_"     $"_$J($FN(PSOUAMT("YR2006",2),","),9)
"RTN","PSOCIDC4",101,0)
 . S PSOTEXT(52)="2006  90-DAY EQUIVALENT FILLS: "_$J(PSOUCNT("YR2006",3),6)
"RTN","PSOCIDC4",102,0)
 . S PSOTEXT(52)=PSOTEXT(52)_"     $"_$J($FN(PSOUAMT("YR2006",3),","),9)
"RTN","PSOCIDC4",103,0)
 . S PSOTEXT(53)="                                          =========="
"RTN","PSOCIDC4",104,0)
 . S PSOTEXT(54)="                                    TOTAL $"_$J($FN(TOTUAMT,","),9)
"RTN","PSOCIDC4",105,0)
 . S PSOTEXT(55)=" "
"RTN","PSOCIDC4",106,0)
 . S PSOTEXT(56)="To get a report of patients/prescriptions that were affected as"
"RTN","PSOCIDC4",107,0)
 . S PSOTEXT(57)="part of this process, contact your IRM to enter D RPT^PSOCIDC3 at"
"RTN","PSOCIDC4",108,0)
 . S PSOTEXT(58)="the programmer's prompt."
"RTN","PSOCIDC4",109,0)
 ;
"RTN","PSOCIDC4",110,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCIDC4",111,0)
 Q
"RTN","PSOCIDC4",112,0)
 ;
"RTN","PSOCIDC4",113,0)
MAIL2 ;management mail message
"RTN","PSOCIDC4",114,0)
 N J,I,LIN
"RTN","PSOCIDC4",115,0)
 S LIN="",$P(LIN," ",85)=""
"RTN","PSOCIDC4",116,0)
 D NOW^%DTC S PSOTIME=$$FMDIFF^XLFDT(%,$G(PSOS1),2)
"RTN","PSOCIDC4",117,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCIDC4",118,0)
 S PSOSTNM=$P($G(^DIC(4,PSOINST,0)),"^")
"RTN","PSOCIDC4",119,0)
 K PSOTEXT
"RTN","PSOCIDC4",120,0)
 K PSOUTC,PSOTC,PSOCTC,PSOUCNTS,PSOCCNTS,PSOCNTS
"RTN","PSOCIDC4",121,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","PSOCIDC4",122,0)
 S (PSOUTC,PSOTC,PSOCTC)=0,(PSOUCNTS,PSOCNTS,PSOCCNTS)=""
"RTN","PSOCIDC4",123,0)
 F J="YR2004","YR2005","YR2006" F I=1:1:3 D
"RTN","PSOCIDC4",124,0)
 .S PSOTC=PSOTC+$G(PSOCNT(J,I))
"RTN","PSOCIDC4",125,0)
 .S PSOCNTS=PSOCNTS_","_$G(PSOCNT(J,I))
"RTN","PSOCIDC4",126,0)
 F J="YR2004","YR2005","YR2006" F I=1:1:3 D
"RTN","PSOCIDC4",127,0)
 .S PSOUTC=PSOUTC+$G(PSOUCNT(J,I))
"RTN","PSOCIDC4",128,0)
 .S PSOUCNTS=PSOUCNTS_","_$G(PSOUCNT(J,I))
"RTN","PSOCIDC4",129,0)
 F J="YR2004","YR2005","YR2006" F I=1:1:3 D
"RTN","PSOCIDC4",130,0)
 .S PSOCTC=PSOCTC+$G(PSOCCNT(J,I))
"RTN","PSOCIDC4",131,0)
 .S PSOCCNTS=PSOCCNTS_","_$G(PSOCCNT(J,I))
"RTN","PSOCIDC4",132,0)
 S XMY("ELLZEY.LINDA@FORUM.VA.GOV")=""
"RTN","PSOCIDC4",133,0)
 S:$$PROD^XUPROD(1) XMY("ELLZEY.LINDA@FORUM.VA.GOV")=""
"RTN","PSOCIDC4",134,0)
 S:$$PROD^XUPROD(1) XMY("G.BILLING AWARENESS@FORUM.VA.GOV")=""
"RTN","PSOCIDC4",135,0)
 S:$$PROD^XUPROD(1) XMY("G.PATCHES@FORUM.VA.GOV")=""
"RTN","PSOCIDC4",136,0)
 S XMDUZ="PSO*7*226 "_JOBN
"RTN","PSOCIDC4",137,0)
 S XMSUB="STATION "_$G(PSOINST)
"RTN","PSOCIDC4",138,0)
 S XMSUB=XMSUB_$S($$PROD^XUPROD(1):" (Prod)",1:" (Test)")
"RTN","PSOCIDC4",139,0)
 S XMSUB=XMSUB_" Summary of updates FOR PRESCRIPTION FILLS"
"RTN","PSOCIDC4",140,0)
 S PSOTEXT(1)="               Start time: "_PSOSTRT2
"RTN","PSOCIDC4",141,0)
 S PSOTEXT(2)="           Completed time: "_PSOEND2
"RTN","PSOCIDC4",142,0)
 S PSOTEXT(3)="             Elapsed Time: "_$$ETIME^PSOCIDC3(PSOTIME)
"RTN","PSOCIDC4",143,0)
 S PSOTEXT(4)=""
"RTN","PSOCIDC4",144,0)
 S PSOTEXT(5)="               Total RX's processed: "_$J($FN(PSOTRX,","),8)
"RTN","PSOCIDC4",145,0)
 S PSOTEXT(6)="            Total Refills processed: "_$J($FN(PSOTRF,","),8)
"RTN","PSOCIDC4",146,0)
 S PSOTEXT(7)="     Total released fills corrected: "_$J($FN(PSOTC,","),8)
"RTN","PSOCIDC4",147,0)
 S PSOTEXT(8)="            Total cancelled refills: "_$J($FN(PSOCTC,","),8)
"RTN","PSOCIDC4",148,0)
 S PSOTEXT(9)="   Total unreleased fills corrected: "_$J($FN(PSOUTC,","),8)
"RTN","PSOCIDC4",149,0)
 S PSOTEXT(10)="               Total number of vets: "_$J($FN(PSOVETS,","),8)
"RTN","PSOCIDC4",150,0)
 S PSOTEXT(11)=""
"RTN","PSOCIDC4",151,0)
 S PSOTEXT(12)=""
"RTN","PSOCIDC4",152,0)
 S PSOTEXT(13)="Excel comma delimited data below, Two heading, three data line"
"RTN","PSOCIDC4",153,0)
 S PSOTEXT(14)=""
"RTN","PSOCIDC4",154,0)
 S PSOTEXT(15)=$E(("Type of,Station,Station,,2004,,,2005,,,2006"_LIN),1,85)
"RTN","PSOCIDC4",155,0)
 S PSOTEXT(16)=$E(("Rx,Name,#,30 days,60 days,90 days,30 days,60 days,90 days,30 days,60 days,90 days"_LIN),1,85)
"RTN","PSOCIDC4",156,0)
 S PSOTEXT(17)=$E(("Released"_","_PSOSTNM_","_PSOINST_PSOCNTS_LIN),1,85)
"RTN","PSOCIDC4",157,0)
 S PSOTEXT(18)=$E(("Cancelled Copays"_","_PSOSTNM_","_PSOINST_PSOCCNTS_LIN),1,85)
"RTN","PSOCIDC4",158,0)
 S PSOTEXT(19)=$E(("Un-released"_","_PSOSTNM_","_PSOINST_PSOUCNTS_LIN),1,85)
"RTN","PSOCIDC4",159,0)
 S PSOTEXT(20)=""
"RTN","PSOCIDC4",160,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCIDC4",161,0)
 Q
"RTN","PSOCIDC4",162,0)
 ;
"RTN","PSOHLSN2")
0^9^B4326292
"RTN","PSOHLSN2",1,0)
PSOHLSN2 ;BIR/LE - Utilities for PSOHLSN1 ;02/27/04
"RTN","PSOHLSN2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,226**;DEC 1997
"RTN","PSOHLSN2",3,0)
 ;
"RTN","PSOHLSN2",4,0)
DG1 ;this section builds both DG1 segments 
"RTN","PSOHLSN2",5,0)
 Q:'$D(^PSRX(PSRXIEN,"ICD",1,0))
"RTN","PSOHLSN2",6,0)
 N LP,DG,DXDESC,I
"RTN","PSOHLSN2",7,0)
 S LIMIT=4,FIELD(0)="DG1",FIELD(4)=""
"RTN","PSOHLSN2",8,0)
 ;I '$D(^PSRX(PSRXIEN,"ICD",1,0)) S FIELD(1)=1,FIELD(2)="",FIELD(3)="^^^^^" D SEG^PSOHLSN1 Q
"RTN","PSOHLSN2",9,0)
 I $P(^PSRX(PSRXIEN,"ICD",1,0),"^",1)="" Q  ;S FIELD(1)=1,FIELD(2)="",FIELD(3)="^^^^^" D SEG^PSOHLSN1 Q
"RTN","PSOHLSN2",10,0)
 F I=1:1:8 D
"RTN","PSOHLSN2",11,0)
 . Q:'$D(^PSRX(PSRXIEN,"ICD",I,0))
"RTN","PSOHLSN2",12,0)
 . S PSOICD="",PSOICD=^PSRX(PSRXIEN,"ICD",I,0) Q:$P(PSOICD,U,1)=""
"RTN","PSOHLSN2",13,0)
 . S (DG,DXDESC)=""
"RTN","PSOHLSN2",14,0)
 . I $P(PSOICD,U,1)'="" D
"RTN","PSOHLSN2",15,0)
 .. S DXDESC=$$GET1^DIQ(80,$P(PSOICD,U,1)_",",10),FIELD(1)=I,FIELD(2)=""
"RTN","PSOHLSN2",16,0)
 .. S FIELD(3)=$P(PSOICD,U,1)_U_DXDESC_U_"80"_U_$$GET1^DIQ(80,$P(PSOICD,U,1)_",",.01)_U_DXDESC_U_"ICD9"
"RTN","PSOHLSN2",17,0)
 .. D SEG^PSOHLSN1
"RTN","PSOHLSN2",18,0)
 K PSOICD("K")
"RTN","PSOHLSN2",19,0)
 Q
"RTN","PSOHLSN2",20,0)
ZCL N STOP,IBQ,ICD,I,JJJ,EI
"RTN","PSOHLSN2",21,0)
 S LIMIT=3,FIELD(0)="ZCL"
"RTN","PSOHLSN2",22,0)
 I '$D(^PSRX(PSRXIEN,"ICD"))&($D(^PSRX(PSRXIEN,"IBQ"))) D    ;For edits; currently CPRS doesn't update SC/EI for edits, but just in case they start
"RTN","PSOHLSN2",23,0)
 . S FIELD(1)=1,FIELD(2)=3
"RTN","PSOHLSN2",24,0)
 . S EI="",EI=^PSRX(PSRXIEN,"IBQ")
"RTN","PSOHLSN2",25,0)
 . S JJJ=0 F I=3,4,1,5,2,6,7 S JJJ=JJJ+1,FIELD(3)=$P(EI,U,I) S FIELD(1)=1,FIELD(2)=JJJ D SEG^PSOHLSN1
"RTN","PSOHLSN2",26,0)
 E  F I=1:1:8 D
"RTN","PSOHLSN2",27,0)
 . Q:'$D(^PSRX(PSRXIEN,"ICD",I,0))
"RTN","PSOHLSN2",28,0)
 . S PSOICD=^PSRX(PSRXIEN,"ICD",I,0),ICD=$P(PSOICD,"^",1)
"RTN","PSOHLSN2",29,0)
 . Q:ICD=""&(I>1)
"RTN","PSOHLSN2",30,0)
 . F JJJ=2:1:8 S EI=$P(PSOICD,U,JJJ),FIELD(2)=JJJ-1 D
"RTN","PSOHLSN2",31,0)
 .. S FIELD(1)=$S(ICD="":1,1:I)
"RTN","PSOHLSN2",32,0)
 .. ;S FIELD(3)=$S(EI=1:EI,1:0)
"RTN","PSOHLSN2",33,0)
 .. S FIELD(3)=$S(EI=1:EI,EI=0:EI,1:"")
"RTN","PSOHLSN2",34,0)
 .. D SEG^PSOHLSN1
"RTN","PSOHLSN2",35,0)
 K PSOICD
"RTN","PSOHLSN2",36,0)
 Q
"RTN","PSONEW2")
0^1^B29428491
"RTN","PSONEW2",1,0)
PSONEW2 ;BIR/DSD - displays new rx information for edit ;07/26/96
"RTN","PSONEW2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,37,46,71,94,124,139,157,143,226**;DEC 1997
"RTN","PSONEW2",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSONEW2",4,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSONEW2",5,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSONEW2",6,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSONEW2",7,0)
 ; This routine displays the entered new rx information and
"RTN","PSONEW2",8,0)
 ; asks if correct, if not allows editing of the data.
"RTN","PSONEW2",9,0)
 ;------------------------------------------------------------
"RTN","PSONEW2",10,0)
START ;
"RTN","PSONEW2",11,0)
 S (PSONEW("DFLG"),PSONEW2("QFLG"))=0
"RTN","PSONEW2",12,0)
 D STOP
"RTN","PSONEW2",13,0)
 D DISPLAY ; Displays information
"RTN","PSONEW2",14,0)
 ;Copay exemption checks
"RTN","PSONEW2",15,0)
 S PSONEWFF=1 K PSOANSQ,PSOANSQD S PSOCPZ("DFLG")=0,PSONEW("NEWCOPAY")=0 I $P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1,$G(DUZ("AG"))="V" S PSOFLAG=1 D COPAY^PSOCPB W !
"RTN","PSONEW2",16,0)
 D ELIG^VADPT S PSOANSQ("SC>50")="",PSOSCP="",PSOSCP=$P(VAEL(3),U,2) K VAEL
"RTN","PSONEW2",17,0)
 I ($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1)!(PSOSCP>49) S PSOFLAG=1 D SC^PSOMLLD2
"RTN","PSONEW2",18,0)
 I $G(PSOCPZ("DFLG")) K PSONEWFF,PSOANSQD,PSOCPZ("DFLG"),PSONEW("NEWCOPAY") S DIRUT="",PSONEW("DFLG")=1 D ASKX G END
"RTN","PSONEW2",19,0)
 ;IF MILL BILL, AND COPAY (*******TEST THE COPAY CHECK)
"RTN","PSONEW2",20,0)
 I $$DT^PSOMLLDT D  I $G(PSOCPZ("DFLG")) K PSONEWFF,PSOANSQD,PSOANSQ,PSOCPZ("DFLG"),PSONEW("NEWCOPAY") S DIRUT="",PSONEW("DFLG")=1 D ASKX G END
"RTN","PSONEW2",21,0)
 .;New prompts Quit after first '^'
"RTN","PSONEW2",22,0)
 .I $D(PSOIBQS(PSODFN,"CV")) D CV^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("CV"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",23,0)
 .I $D(PSOIBQS(PSODFN,"VEH")) D VEH^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("VEH"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",24,0)
 .I $D(PSOIBQS(PSODFN,"RAD")) D RAD^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("RAD"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",25,0)
 .I $D(PSOIBQS(PSODFN,"PGW")) D PGW^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("PGW"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",26,0)
 .I $D(PSOIBQS(PSODFN,"MST")) D MST^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("MST"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",27,0)
 .I $D(PSOIBQS(PSODFN,"HNC")) D HNC^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("HNC"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",28,0)
 K PSOCPZ("DFLG"),PSONEWFF
"RTN","PSONEW2",29,0)
 D ASK K:$G(PSONEW("DFLG")) PSOANSQ G:PSONEW2("QFLG")!PSONEW("DFLG") END
"RTN","PSONEW2",30,0)
 S PSORX("EDIT")=1 D EN^PSOORNE1(.PSONEW),FULL^VALM1 G:$G(PSORX("FN")) END  I '$G(PSORX("FN")) S PSONEW("DFLG")=1 K PSOANSQ G END ;D EDIT
"RTN","PSONEW2",31,0)
 G:'$G(PSONEW("DFLG")) START
"RTN","PSONEW2",32,0)
 S PSONEW("QFLG")=1,PSONEW("DFLG")=0
"RTN","PSONEW2",33,0)
END D EOJ
"RTN","PSONEW2",34,0)
 Q
"RTN","PSONEW2",35,0)
 ;------------------------------------------------------------
"RTN","PSONEW2",36,0)
STOP K PSEXDT,X,%DT S PSON52("QFLG")=0
"RTN","PSONEW2",37,0)
 S X1=PSOID,X2=PSONEW("DAYS SUPPLY")*(PSONEW("# OF REFILLS")+1)\1
"RTN","PSONEW2",38,0)
 S X2=$S(PSONEW("DAYS SUPPLY")=X2:X2,+$G(PSONEW("CS")):184,1:366)
"RTN","PSONEW2",39,0)
 I X2<30 D
"RTN","PSONEW2",40,0)
 . N % S %=$P($G(PSORX("PATIENT STATUS")),"^"),X2=30
"RTN","PSONEW2",41,0)
 . S:%?.N %=$P($G(^PS(53,+%,0)),"^") I %["AUTH ABS" S X2=5
"RTN","PSONEW2",42,0)
 D C^%DTC I PSONEW("FILL DATE")>$P(X,".") S PSEXDT=1_"^"_$P(X,".")
"RTN","PSONEW2",43,0)
 K X1,X2,X,%DT
"RTN","PSONEW2",44,0)
 Q
"RTN","PSONEW2",45,0)
DISPLAY ;
"RTN","PSONEW2",46,0)
 W !!,"Rx # ",PSONEW("RX #")
"RTN","PSONEW2",47,0)
 W ?23,$E(PSONEW("FILL DATE"),4,5),"/",$E(PSONEW("FILL DATE"),6,7),"/",$E(PSONEW("FILL DATE"),2,3),!,$G(PSORX("NAME")),?30,"#",PSONEW("QTY")
"RTN","PSONEW2",48,0)
 I $G(SIGOK),$O(SIG(0)) D  K D G TRN
"RTN","PSONEW2",49,0)
 .F D=0:0 S D=$O(SIG(D)) W !,SIG(D) Q:'$O(SIG(D))
"RTN","PSONEW2",50,0)
 E  S X=PSONEW("SIG") D SIGONE^PSOHELP W !,$G(INS1)
"RTN","PSONEW2",51,0)
TRN ;I $G(PSOPRC) F I=0:0 S I=$O(PRC(I)) Q:'I  W !,PRC(I)
"RTN","PSONEW2",52,0)
 W !!,$S($G(PSODRUG("TRADE NAME"))]"":PSODRUG("TRADE NAME"),1:PSODRUG("NAME"))
"RTN","PSONEW2",53,0)
 W !,PSONEW("PROVIDER NAME"),?25,PSORX("CLERK CODE"),!,"# of Refills: ",PSONEW("# OF REFILLS"),!
"RTN","PSONEW2",54,0)
 Q
"RTN","PSONEW2",55,0)
 ;
"RTN","PSONEW2",56,0)
ASK ;
"RTN","PSONEW2",57,0)
 K DIR,X,Y S DIR("A")="Is this correct"
"RTN","PSONEW2",58,0)
 S DIR(0)="Y",DIR("B")="YES" D ^DIR K DIR I $D(DIRUT) S PSONEW("DFLG")=1 G ASKX
"RTN","PSONEW2",59,0)
ASK1 I Y D  S PSONEW2("QFLG")=1
"RTN","PSONEW2",60,0)
 .S:$G(PSONEW("MAIL/WINDOW"))["W" BINGCRT=Y,BINGRTE="W"
"RTN","PSONEW2",61,0)
 .D:+$G(PSEXDT)
"RTN","PSONEW2",62,0)
 ..S Y=PSONEW("FILL DATE") X ^DD("DD") W !!,$C(7),Y_" fill date is greater than possible expiration date of " S Y=$P(PSEXDT,"^",2) X ^DD("DD") W Y_"."
"RTN","PSONEW2",63,0)
 .D DCORD K RORD,^TMP("PSORXDC",$J)
"RTN","PSONEW2",64,0)
ASKX I $D(DIRUT) D
"RTN","PSONEW2",65,0)
 .I +$G(PSEXDT) K DIRUT S (PSONEW2("QFLG"),PSONEW2("DFLG"),PSONEW("DFLG"),Y)=1
"RTN","PSONEW2",66,0)
 K X,Y,DIRUT,DTOUT,DUOUT
"RTN","PSONEW2",67,0)
 D:+$G(PSEXDT) PAUSE^VALM1
"RTN","PSONEW2",68,0)
 Q
"RTN","PSONEW2",69,0)
DCORD ;dc rxs and pending orders after new order is entered
"RTN","PSONEW2",70,0)
 F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D @$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"PEN",1:"RX52")
"RTN","PSONEW2",71,0)
 K RORD
"RTN","PSONEW2",72,0)
 Q
"RTN","PSONEW2",73,0)
PEN ;pending ^tmp("psorxdc",$j,rord,0)="p^"_rord_"^"_msg
"RTN","PSONEW2",74,0)
 S $P(^PS(52.41,RORD,0),"^",3)="DC",^PS(52.41,RORD,4)=$P(^TMP("PSORXDC",$J,RORD,0),"^",3)
"RTN","PSONEW2",75,0)
 K ^PS(52.41,"AOR",PSODFN,+$P($G(^PS(52.41,RORD,"INI")),"^"),RORD)
"RTN","PSONEW2",76,0)
 D EN^PSOHLSN($P(^PS(52.41,RORD,0),"^"),"OC",$P(^TMP("PSORXDC",$J,RORD,0),"^",3),"D") W $C(7),!," -Pending Order was discontinued..."
"RTN","PSONEW2",77,0)
 D PSOUL^PSSLOCK(RORD_"S") K ^TMP("PSORXDC",$J,RORD,0)
"RTN","PSONEW2",78,0)
 Q
"RTN","PSONEW2",79,0)
RX52 ;rxs in file 52 ^tmp("psorxdc",$j,rord,0)=52^rord^msg^rea^act^sta^dnm
"RTN","PSONEW2",80,0)
 S PSCAN($P(^PSRX(RORD,0),"^"))=RORD_"^"_$P(^TMP("PSORXDC",$J,RORD,0),"^",4)
"RTN","PSONEW2",81,0)
 S MSG=$P(^TMP("PSORXDC",$J,RORD,0),"^",3),REA=$P(^(0),"^",4),ACT=$P(^(0),"^",5)
"RTN","PSONEW2",82,0)
 N PSONOOR S PSONOOR="D",DUP=1,DA=RORD D CAN^PSOCAN K PSONOOR
"RTN","PSONEW2",83,0)
 W !," -Rx "_$P(^PSRX(RORD,0),"^")_" has been discontinued...",!
"RTN","PSONEW2",84,0)
 K PSOSD($P(^TMP("PSORXDC",$J,RORD,0),"^",6),$P(^TMP("PSORXDC",$J,RORD,0),"^",7))
"RTN","PSONEW2",85,0)
 D PSOUL^PSSLOCK(RORD) K ^TMP("PSORXDC",$J,RORD,0)
"RTN","PSONEW2",86,0)
 Q
"RTN","PSONEW2",87,0)
 ;
"RTN","PSONEW2",88,0)
EDIT ;
"RTN","PSONEW2",89,0)
 S PSORX("EDIT")=1
"RTN","PSONEW2",90,0)
 D ^PSONEW3
"RTN","PSONEW2",91,0)
 S PSONEW("DFLG")=$S($G(PSORX("DFLG")):1,1:0)
"RTN","PSONEW2",92,0)
 Q
"RTN","PSONEW2",93,0)
 ;
"RTN","PSONEW2",94,0)
EOJ ;
"RTN","PSONEW2",95,0)
 K PSONEW2,PSORX("EDIT"),PSORX("DFLG"),PSOEDIT
"RTN","PSONEW2",96,0)
 Q
"RTN","PSONEW2",97,0)
 ;
"RTN","PSONEW2",98,0)
EN1(PSONEW2) ; Entry point to just display and ask if okay
"RTN","PSONEW2",99,0)
 S PSONEW("DFLG")=0
"RTN","PSONEW2",100,0)
 I $G(^PSRX(PSONEW2("IRXN"),0))']"" S PSONEW("DFLG")=1 G EN1X
"RTN","PSONEW2",101,0)
 S PSOX=^PSRX(PSONEW2("IRXN"),0),PSONEW("TRADE NAME")=$G(^("TN")),PSONEW("FILL DATE")=$P($G(^(2)),"^",2)
"RTN","PSONEW2",102,0)
 S PSONEW("RX #")=$P(PSOX,"^"),PSORX("NAME")=$P(^DPT($P(PSOX,"^",2),0),"^")
"RTN","PSONEW2",103,0)
 S PSONEW("QTY")=$P(PSOX,"^",7),PSODRUG("NAME")=$P(^PSDRUG($P(PSOX,"^",6),0),"^"),PSONEW("# OF REFILLS")=$P(PSOX,"^",9)
"RTN","PSONEW2",104,0)
 S PSORX("CLERK CODE")=$P(^VA(200,$P(PSOX,"^",16),0),"^")
"RTN","PSONEW2",105,0)
 S:$G(PSONEW("PROVIDER NAME"))="" PSONEW("PROVIDER NAME")=$P(^VA(200,$P(PSOX,"^",4),0),"^")
"RTN","PSONEW2",106,0)
 S PSONEW("SIG")=$P($G(^PSRX(PSONEW2("IRXN"),"SIG")),"^")
"RTN","PSONEW2",107,0)
 D DISPLAY
"RTN","PSONEW2",108,0)
 D ASK
"RTN","PSONEW2",109,0)
 I PSONEW("DFLG")=1 S PSONEW2("DFLG")=1
"RTN","PSONEW2",110,0)
EN1X ;
"RTN","PSONEW2",111,0)
 Q
"RTN","PSONEWF")
0^2^B45034725
"RTN","PSONEWF",1,0)
PSONEWF ;BIR/RTR - Copay finish questions ;07/26/96
"RTN","PSONEWF",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**71,157,143,219,226**;DEC 1997
"RTN","PSONEWF",3,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSONEWF",4,0)
START ;
"RTN","PSONEWF",5,0)
 N PSOPENIB,PSOSCOTH,PSOSCOTX,PSOMESFI
"RTN","PSONEWF",6,0)
 S PSOPENIB=$S($G(ORD):$G(^PS(52.41,+$G(ORD),"IBQ")),1:"")
"RTN","PSONEWF",7,0)
 ;set PSOSCOTH for display of Provider Copay intent, used with PSORX(SC)
"RTN","PSONEWF",8,0)
 S PSOSCOTH=0 I $P(PSOPENIB,"^")=1!($P(PSOPENIB,"^",2)=1)!($P(PSOPENIB,"^",3)=1)!($P(PSOPENIB,"^",4)=1)!($P(PSOPENIB,"^",5)=1)!($P(PSOPENIB,"^",6)=1) S PSOSCOTH=1
"RTN","PSONEWF",9,0)
 S PSOSCOTX=0 I $G(PSOSCOTH)!($G(PSORX("SC"))="SC")!($G(PSORX("SC"))="NSC") S PSOSCOTX=1
"RTN","PSONEWF",10,0)
 ;Check for Orderable Item change to display message
"RTN","PSONEWF",11,0)
 S PSOMESFI=0 I $G(OR0),$G(PSODRUG("OI")) D
"RTN","PSONEWF",12,0)
 .I $G(PSODRUG("OI"))'=$P($G(OR0),"^",8) S PSOMESFI=1
"RTN","PSONEWF",13,0)
 S PSONEWFF=1
"RTN","PSONEWF",14,0)
 ;Copay exemption checks
"RTN","PSONEWF",15,0)
 K PSOSCP D ELIG^VADPT S PSOANSQ("SC>50")="",PSOSCP="",PSOSCP=$P(VAEL(3),U,2) K VAEL
"RTN","PSONEWF",16,0)
 K PSOANSQ D SET S PSOCPZ("DFLG")=0,PSONEW("NEWCOPAY")=0 I $P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1,$G(DUZ("AG"))="V" S PSOFLAG=1 D COPAY^PSOCPB W !
"RTN","PSONEWF",17,0)
 I $P(PSOPENIB,"^",6)=0!($P(PSOPENIB,"^",6)=1) S PSOANSQ("CV")=$P(PSOPENIB,"^",6)
"RTN","PSONEWF",18,0)
 I $G(PSOCPZ("DFLG")) K PSONEW("NEWCOPAY"),PSONEWFF,PSOSCOTH,PSOSCOTX,PSOMESFI Q
"RTN","PSONEWF",19,0)
 I PSOSCP>49!($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1)!(+PSOBILL=0) D  I $G(PSOCPZ("DFLG")) K PSOANSQ,PSONEW("NEWCOPAY"),PSONEWFF,PSOSCOTH,PSOSCOTX,PSOMESFI Q
"RTN","PSONEWF",20,0)
 . I PSOSCP<50 D MESS S:PSOSCP<50 PSOANSQD("SC>50")=$G(PSOANSQD("SC"))
"RTN","PSONEWF",21,0)
 . S PSOFLAG=1 D SC^PSOMLLD2
"RTN","PSONEWF",22,0)
 . I PSOSCP<50&($D(PSOANSQD("SC"))) S:PSOSCP<50 PSOANSQD("SC")=PSOANSQD("SC>50") K PSOANSQD("SC")
"RTN","PSONEWF",23,0)
 ;IF MILL BILL, AND COPAY (*******TEST THE COPAY CHECK)
"RTN","PSONEWF",24,0)
 I $$DT^PSOMLLDT D  I $G(PSOCPZ("DFLG")) K PSOANSQ,PSONEW("NEWCOPAY"),PSONEWFF,PSOSCOTH,PSOSCOTX,PSOMESFI Q
"RTN","PSONEWF",25,0)
 .;New prompts Quit after first '^'
"RTN","PSONEWF",26,0)
 .I $D(PSOIBQS(PSODFN,"CV")) D  D MESSOI,MESS D CV^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("CV"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",27,0)
 ..I '$D(PSOANSQD("CV")),($P(PSOPENIB,"^",6)=0!($P(PSOPENIB,"^",6)=1)) S PSOANSQD("CV")=$P(PSOPENIB,"^",6)
"RTN","PSONEWF",28,0)
 .I $D(PSOIBQS(PSODFN,"VEH")) D  D MESSOI,MESS D VEH^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("VEH"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",29,0)
 ..I '$D(PSOANSQD("VEH")),($P(PSOPENIB,"^",2)=0!($P(PSOPENIB,"^",2)=1)) S PSOANSQD("VEH")=$P(PSOPENIB,"^",2)
"RTN","PSONEWF",30,0)
 .I $D(PSOIBQS(PSODFN,"RAD")) D  D MESSOI,MESS D RAD^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("RAD"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",31,0)
 ..I '$D(PSOANSQD("RAD")),($P(PSOPENIB,"^",3)=0!($P(PSOPENIB,"^",3)=1)) S PSOANSQD("RAD")=$P(PSOPENIB,"^",3)
"RTN","PSONEWF",32,0)
 .I $D(PSOIBQS(PSODFN,"PGW")) D  D MESSOI,MESS D PGW^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("PGW"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",33,0)
 ..I '$D(PSOANSQD("PGW")),($P(PSOPENIB,"^",4)=0!($P(PSOPENIB,"^",4)=1)) S PSOANSQD("PGW")=$P(PSOPENIB,"^",4)
"RTN","PSONEWF",34,0)
 .I $D(PSOIBQS(PSODFN,"MST")) D  D MESSOI,MESS D MST^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("MST"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",35,0)
 ..I '$D(PSOANSQD("MST")),($P(PSOPENIB,"^")=0!($P(PSOPENIB,"^")=1)) S PSOANSQD("MST")=$P(PSOPENIB,"^")
"RTN","PSONEWF",36,0)
 .I $D(PSOIBQS(PSODFN,"HNC")) D  D MESSOI,MESS D HNC^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("HNC"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",37,0)
 ..I '$D(PSOANSQD("HNC")),($P(PSOPENIB,"^",5)=0!($P(PSOPENIB,"^",5)=1)) S PSOANSQD("HNC")=$P(PSOPENIB,"^",5)
"RTN","PSONEWF",38,0)
 K PSONEWFF,PSOSCOTH,PSOSCOTX,PSOMESFI
"RTN","PSONEWF",39,0)
 Q
"RTN","PSONEWF",40,0)
SET ;Set original answers that were passed from CPRS
"RTN","PSONEWF",41,0)
 Q:'$G(ORD)
"RTN","PSONEWF",42,0)
 Q:'$G(PSOFDR)
"RTN","PSONEWF",43,0)
 I $P($G(^PS(52.41,ORD,0)),"^",16)="SC"!($P($G(^(0)),"^",16)="NSC") D
"RTN","PSONEWF",44,0)
 . I PSOSCP<50 S PSOANSQ("SC")=$S($P($G(^(0)),"^",16)="SC":1,1:0),PSOANSQD("SC")=PSOANSQ("SC") S:PSOANSQ("SC")'="" PSOIBQS(PSODFN,"SC")=PSOANSQ("SC")
"RTN","PSONEWF",45,0)
 . E  S PSOANSQ("SC>50")=$S($P($G(^(0)),"^",16)="SC":1,1:0),PSOANSQD("SC>50")=PSOANSQ("SC>50") S:PSOANSQ("SC>50")'="" PSOIBQS(PSODFN,"SC>50")=PSOANSQ("SC>50")
"RTN","PSONEWF",46,0)
 I $G(PSOPENIB)="" G ICD1:$D(^PS(52.41,ORD,"ICD")) Q
"RTN","PSONEWF",47,0)
 I '$$DT^PSOMLLDT Q
"RTN","PSONEWF",48,0)
 I $P(PSOPENIB,"^")=0!($P(PSOPENIB,"^")=1) S PSOANSQ("MST")=$P(PSOPENIB,"^")
"RTN","PSONEWF",49,0)
 I $P(PSOPENIB,"^",2)=0!($P(PSOPENIB,"^",2)=1) S PSOANSQ("VEH")=$P(PSOPENIB,"^",2)
"RTN","PSONEWF",50,0)
 I $P(PSOPENIB,"^",3)=0!($P(PSOPENIB,"^",3)=1) S PSOANSQ("RAD")=$P(PSOPENIB,"^",3)
"RTN","PSONEWF",51,0)
 I $P(PSOPENIB,"^",4)=0!($P(PSOPENIB,"^",4)=1) S PSOANSQ("PGW")=$P(PSOPENIB,"^",4)
"RTN","PSONEWF",52,0)
 I $P(PSOPENIB,"^",5)=0!($P(PSOPENIB,"^",5)=1) S PSOANSQ("HNC")=$P(PSOPENIB,"^",5)
"RTN","PSONEWF",53,0)
 I $P(PSOPENIB,"^",6)=0!($P(PSOPENIB,"^",6)=1) S PSOANSQ("CV")=$P(PSOPENIB,"^",6)
"RTN","PSONEWF",54,0)
ICD1 ;
"RTN","PSONEWF",55,0)
 N PSONOCHG S PSONOCHG=0
"RTN","PSONEWF",56,0)
 I ('$D(PSORXED("ICD"))) S PSONOCHG=1
"RTN","PSONEWF",57,0)
 I $D(^PS(52.41,ORD,"ICD",0)) D
"RTN","PSONEWF",58,0)
 . N JJ,ICD,II,FLD,RXN S RXN=ORD
"RTN","PSONEWF",59,0)
 . S II=0 F  S II=$O(^PS(52.41,ORD,"ICD",II)) Q:II=""!(II'?1N.N)  D
"RTN","PSONEWF",60,0)
 .. S ICD="",ICD=^PS(52.41,ORD,"ICD",II,0)
"RTN","PSONEWF",61,0)
 .. S JJ="" F JJ=1:1:8 S FLD=$P(ICD,U,JJ) S:$G(PSONEW("IDFLG"))&(JJ=1) FLD=""  D ICD
"RTN","PSONEWF",62,0)
 Q
"RTN","PSONEWF",63,0)
MESS ;
"RTN","PSONEWF",64,0)
 I $G(PSOSCOTX)=1&(PSOSCP<50) W:$G(PSODRUG("DEA"))'["S"&($G(PSODRUG("DEA"))'["I") !,"This Rx has been flagged by the provider as: "_$S($G(PSOSCOTH):"NO COPAY",$G(PSORX("SC"))="SC":"NO COPAY",1:"COPAY"),! S PSOSCOTX=2
"RTN","PSONEWF",65,0)
 Q
"RTN","PSONEWF",66,0)
MESSOI ;
"RTN","PSONEWF",67,0)
 I $G(PSOMESFI)=1 W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESFI=2
"RTN","PSONEWF",68,0)
 Q
"RTN","PSONEWF",69,0)
 ;
"RTN","PSONEWF",70,0)
ICD ;called from PSONEWG and used by PSONEW
"RTN","PSONEWF",71,0)
 I '$D(PSOSCP) D ELIG^VADPT S PSOANSQ("SC>50")="",PSOSCP="",PSOSCP=$P(VAEL(3),U,2) K VAEL
"RTN","PSONEWF",72,0)
 I JJ=1 D
"RTN","PSONEWF",73,0)
 . I $G(PSOCOPY)&($D(PSORXED("ICD")))&($D(PSONEW("IDFLG"))) Q:'$D(PSORXED("ICD",II))
"RTN","PSONEWF",74,0)
 . I $G(PSOCOPY)&($D(PSORXED("ICD",II))) S PSONEW("ICD",II)=PSORXED("ICD",II) Q
"RTN","PSONEWF",75,0)
 . Q:'$G(PSOCOPY)&('$D(PSORXED("ICD",II)))&('$G(PSONOCHG))  ;don't set deleted ones
"RTN","PSONEWF",76,0)
 . Q:$G(PSONEW("IDFLG"))
"RTN","PSONEWF",77,0)
 . I $D(PSORX("ICD",II)) S PSONEW("ICD",II)=PSORX("ICD",II) Q
"RTN","PSONEWF",78,0)
 . S PSONEW("ICD",II)=FLD
"RTN","PSONEWF",79,0)
 ;
"RTN","PSONEWF",80,0)
 I JJ=2 S:'$G(PSOANSQD("VEH")) PSOANSQD("VEH")="" S:PSOANSQD("VEH")=""!(PSOANSQD("VEH")=0) PSOANSQD("VEH")=FLD,PSORX(RXN,"VEH")=FLD S:FLD'="" PSOIBQS(PSODFN,"VEH")=FLD Q
"RTN","PSONEWF",81,0)
 I JJ=3 S:'$G(PSOANSQD("RAD")) PSOANSQD("RAD")="" S:PSOANSQD("RAD")=""!(PSOANSQD("RAD")=0) PSOANSQD("RAD")=FLD,PSORX(RXN,"RAD")=FLD S:FLD'="" PSOIBQS(PSODFN,"RAD")=FLD Q
"RTN","PSONEWF",82,0)
 I JJ=4 D
"RTN","PSONEWF",83,0)
 . I PSOSCP<50&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=0) S:'$G(PSOANSQD("SC")) PSOANSQD("SC")="" S:PSOANSQD("SC")=""!(PSOANSQD("SC")="") PSOANSQD("SC")=FLD,PSORX(RXN,"SC")=FLD S:FLD'="" PSOIBQS(PSODFN,"SC")=FLD
"RTN","PSONEWF",84,0)
 . E  S:'$G(PSOANSQD("SC>50")) PSOANSQD("SC>50")="" S:PSOANSQD("SC>50")=""!(PSOANSQD("SC>50")=0) PSOANSQD("SC>50")=FLD,PSORX(RXN,"SC>50")=FLD S:FLD'="" PSOIBQS(PSODFN,"SC>50")=FLD
"RTN","PSONEWF",85,0)
 I JJ=5 S:'$G(PSOANSQD("PGW")) PSOANSQD("PGW")="" S:PSOANSQD("PGW")=""!(PSOANSQD("PGW")=0) PSOANSQD("PGW")=FLD,PSORX(RXN,"PGW")=FLD S:FLD'="" PSOIBQS(PSODFN,"PGW")=FLD Q
"RTN","PSONEWF",86,0)
 I JJ=6 S:'$G(PSOANSQD("MST")) PSOANSQD("MST")="" S:PSOANSQD("MST")=""!(PSOANSQD("MST")=0) PSOANSQD("MST")=FLD,PSORX(RXN,"MST")=FLD S:FLD'="" PSOIBQS(PSODFN,"MST")=FLD Q
"RTN","PSONEWF",87,0)
 I JJ=7 S:'$G(PSOANSQD("HNC")) PSOANSQD("HNC")="" S:PSOANSQD("HNC")=""!(PSOANSQD("HNC")=0) PSOANSQD("HNC")=FLD,PSORX(RXN,"HNC")=FLD S:FLD'="" PSOIBQS(PSODFN,"HNC")=FLD Q
"RTN","PSONEWF",88,0)
 I JJ=8 S:'$G(PSOANSQD("CV")) PSOANSQD("CV")="" S:PSOANSQD("CV")=""!(PSOANSQD("CV")=0) PSOANSQD("CV")=FLD,PSORX(RXN,"CV")=FLD S:FLD'="" PSOIBQS(PSODFN,"CV")=FLD
"RTN","PSONEWF",89,0)
 Q
"RTN","PSONEWG")
0^3^B22698688
"RTN","PSONEWG",1,0)
PSONEWG ;BIR/RTR - Copay copy and edit questions ;07/26/96
"RTN","PSONEWG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**71,157,143,219,226**;DEC 1997
"RTN","PSONEWG",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSONEWG",4,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSONEWG",5,0)
START ;
"RTN","PSONEWG",6,0)
 N PSOPENIB,PSOMESOI
"RTN","PSONEWG",7,0)
 S PSOPENIB="" I $G(PSORXED)!($G(PSOCOPY)) I $G(PSORXED("IRXN")) S PSOPENIB=$G(^PSRX(PSORXED("IRXN"),"IBQ"))
"RTN","PSONEWG",8,0)
 S PSOMESOI=0 I $G(PSORXED) D
"RTN","PSONEWG",9,0)
 .I $G(PSODRUG("OI")),$P($G(PSORXED("RX0")),"^",6) D
"RTN","PSONEWG",10,0)
 ..I $G(PSODRUG("OI"))'=$P($G(^PSDRUG(+$P($G(PSORXED("RX0")),"^",6),2)),"^") S PSOMESOI=1
"RTN","PSONEWG",11,0)
 S PSONEWFF=1
"RTN","PSONEWG",12,0)
 ;Copay exemption checks
"RTN","PSONEWG",13,0)
 K PSOSCP D ELIG^VADPT S PSOANSQ("SC>50")="",PSOSCP="",PSOSCP=$P(VAEL(3),U,2) K VAEL
"RTN","PSONEWG",14,0)
 K PSOANSQ D SET S PSOCPZ("DFLG")=0,PSONEW("NEWCOPAY")=0 I $P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1,$G(DUZ("AG"))="V" S PSOFLAG=1 D  D COPAY^PSOCPB W !
"RTN","PSONEWG",15,0)
 .;I $G(PSOANSQD("SC"))=0!($G(PSOANSQD("SC"))=1) Q
"RTN","PSONEWG",16,0)
 .I $G(PSOANSQ("SC"))=0!($G(PSOANSQ("SC"))=1) S PSOANSQD("SC")=$G(PSOANSQ("SC"))
"RTN","PSONEWG",17,0)
 I PSOSCP>49!($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1) S PSOFLAG=1 D SC^PSOMLLD2 I $G(PSOCPZ("DFLG")) K PSOANSQ,PSONEW("NEWCOPAY"),PSONEWFF,PSOMESOI Q
"RTN","PSONEWG",18,0)
 I $G(PSOCPZ("DFLG")) K PSONEW("NEWCOPAY"),PSONEWFF,PSOMESOI Q
"RTN","PSONEWG",19,0)
 ;IF MILL BILL, AND COPAY (*******TEST THE COPAY CHECK)
"RTN","PSONEWG",20,0)
 I $$DT^PSOMLLDT D  I $G(PSOCPZ("DFLG")) K PSOANSQ,PSONEW("NEWCOPAY"),PSONEWFF,PSOMESOI Q
"RTN","PSONEWG",21,0)
 .;New prompts Quit after first '^'
"RTN","PSONEWG",22,0)
 .I $D(PSOIBQS(PSODFN,"CV")) D  D MESS D CV^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("CV"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",23,0)
 ..I '$D(PSOANSQD("CV")),($P(PSOPENIB,"^",7)=0!($P(PSOPENIB,"^",7)=1)) S PSOANSQD("CV")=$P(PSOPENIB,"^",7)
"RTN","PSONEWG",24,0)
 .I $D(PSOIBQS(PSODFN,"VEH")) D  D MESS D VEH^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("VEH"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",25,0)
 ..I '$D(PSOANSQD("VEH")),($P(PSOPENIB,"^",3)=0!($P(PSOPENIB,"^",3)=1)) S PSOANSQD("VEH")=$P(PSOPENIB,"^",3)
"RTN","PSONEWG",26,0)
 .I $D(PSOIBQS(PSODFN,"RAD")) D  D MESS D RAD^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("RAD"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",27,0)
 ..I '$D(PSOANSQD("RAD")),($P(PSOPENIB,"^",4)=0!($P(PSOPENIB,"^",4)=1)) S PSOANSQD("RAD")=$P(PSOPENIB,"^",4)
"RTN","PSONEWG",28,0)
 .I $D(PSOIBQS(PSODFN,"PGW")) D  D MESS D PGW^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("PGW"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",29,0)
 ..I '$D(PSOANSQD("PGW")),($P(PSOPENIB,"^",5)=0!($P(PSOPENIB,"^",5)=1)) S PSOANSQD("PGW")=$P(PSOPENIB,"^",5)
"RTN","PSONEWG",30,0)
 .I $D(PSOIBQS(PSODFN,"MST")) D  D MESS D MST^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("MST"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",31,0)
 ..I '$D(PSOANSQD("MST")),($P(PSOPENIB,"^",2)=0!($P(PSOPENIB,"^",2)=1)) S PSOANSQD("MST")=$P(PSOPENIB,"^",2)
"RTN","PSONEWG",32,0)
 .I $D(PSOIBQS(PSODFN,"HNC")) D  D MESS D HNC^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("HNC"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",33,0)
 ..I '$D(PSOANSQD("HNC")),($P(PSOPENIB,"^",6)=0!($P(PSOPENIB,"^",6)=1)) S PSOANSQD("HNC")=$P(PSOPENIB,"^",6)
"RTN","PSONEWG",34,0)
 K PSONEWFF,PSOMESOI
"RTN","PSONEWG",35,0)
 Q
"RTN","PSONEWG",36,0)
SET ;Set original answers that were passed from CPRS
"RTN","PSONEWG",37,0)
 Q:'$G(PSORXED("IRXN"))
"RTN","PSONEWG",38,0)
 S PSOANSQ("SC")=$S($P($G(^PSRX(PSORXED("IRXN"),"IBQ")),"^")'="":$P($G(^("IBQ")),"^"),$P($G(^PSRX(PSORXED("IRXN"),"IB")),"^"):0,1:"")
"RTN","PSONEWG",39,0)
 I $G(PSOANSQ("SC"))="" K PSOANSQ("SC")
"RTN","PSONEWG",40,0)
 I $G(PSOPENIB)="" G ICD
"RTN","PSONEWG",41,0)
 I '$$DT^PSOMLLDT Q
"RTN","PSONEWG",42,0)
 I $P(PSOPENIB,"^",2)=0!($P(PSOPENIB,"^",2)=1) S PSOANSQ("MST")=$P(PSOPENIB,"^",2)
"RTN","PSONEWG",43,0)
 I $P(PSOPENIB,"^",3)=0!($P(PSOPENIB,"^",3)=1) S PSOANSQ("VEH")=$P(PSOPENIB,"^",3)
"RTN","PSONEWG",44,0)
 I $P(PSOPENIB,"^",4)=0!($P(PSOPENIB,"^",4)=1) S PSOANSQ("RAD")=$P(PSOPENIB,"^",4)
"RTN","PSONEWG",45,0)
 I $P(PSOPENIB,"^",5)=0!($P(PSOPENIB,"^",5)=1) S PSOANSQ("PGW")=$P(PSOPENIB,"^",5)
"RTN","PSONEWG",46,0)
 I $P(PSOPENIB,"^",6)=0!($P(PSOPENIB,"^",6)=1) S PSOANSQ("HNC")=$P(PSOPENIB,"^",6)
"RTN","PSONEWG",47,0)
 I $P(PSOPENIB,"^",7)=0!($P(PSOPENIB,"^",7)=1) S PSOANSQ("CV")=$P(PSOPENIB,"^",7)
"RTN","PSONEWG",48,0)
ICD ;
"RTN","PSONEWG",49,0)
 N PSONOCHG S PSONOCHG=0
"RTN","PSONEWG",50,0)
 I '$D(PSONEW("ICD"))&('$D(PSORXED("ICD"))) S PSONOCHG=1
"RTN","PSONEWG",51,0)
 I $D(^PSRX(PSORXED("IRXN"),"ICD",0)) D
"RTN","PSONEWG",52,0)
 . N JJ,ICD,II,FLD,RXN,TNEW S RXN=PSORXED("IRXN")
"RTN","PSONEWG",53,0)
 . S II=0 F  S II=$O(^PSRX(RXN,"ICD",II)) Q:II=""!(II'?1N.N)  D
"RTN","PSONEWG",54,0)
 .. S ICD="",ICD=^PSRX(RXN,"ICD",II,0)
"RTN","PSONEWG",55,0)
 .. Q:$G(PSOCOPY)&(II>1)&('PSONOCHG)        ;user deleted all after this II or no changes made
"RTN","PSONEWG",56,0)
 .. S JJ="" F JJ=1:1:8 S FLD=$P(ICD,U,JJ) S:$G(PSONEW("IDFLG"))&(JJ=1) FLD="" D ICD^PSONEWF
"RTN","PSONEWG",57,0)
 E  I $G(PSONEW("IDFLG")) K ^PSRX(RXN,"B") S $P(^PSRX(RXN,"ICD",1,0),"^",1)="",TNEW=2 D
"RTN","PSONEWG",58,0)
 . F TNEW=TNEW:1:8 Q:'$D(^PSRX(RXN,"ICD",TNEW,0))  S DIK="^PSRX("_RXN_","_$C(34)_"ICD"_$C(34)_",",DA=TNEW,DA(1)=RXN D ^DIK K DA,DIK ;user deleted all
"RTN","PSONEWG",59,0)
 K PSONEW("IDFLG"),PSORXED("IDFLG")
"RTN","PSONEWG",60,0)
 Q
"RTN","PSONEWG",61,0)
MESS ;
"RTN","PSONEWG",62,0)
 I $G(PSOMESOI)=1,$G(PSORXED) W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESOI=2
"RTN","PSONEWG",63,0)
 Q
"VER")
8.0^22.0
"BLD",5790,6)
^201
**END**
**END**
