Released PSA*3*61 SEQ #46
Extracted from mail message
**KIDS**:PSA*3.0*61^

**INSTALL NAME**
PSA*3.0*61
"BLD",6680,0)
PSA*3.0*61^DRUG ACCOUNTABILITY^0^3060926^y
"BLD",6680,1,0)
^^36^36^3060926^
"BLD",6680,1,1,0)
Problem HD129689 - Undefined error while processing invoice
"BLD",6680,1,2,0)
--------------------------------------------------------------
"BLD",6680,1,3,0)
During the processing of an invoice, it is possible to receive
"BLD",6680,1,4,0)
The following message:
"BLD",6680,1,5,0)
Undefined N1+3 DICNO Unable to Process Invoice
"BLD",6680,1,6,0)
This error is caused by the system not properly cleaning up variables
"BLD",6680,1,7,0)
used by the program DICN0.
"BLD",6680,1,8,0)
 
"BLD",6680,1,9,0)
Resolution HD129689 - Undefined error while processing invoice
"BLD",6680,1,10,0)
--------------------------------------------------------------
"BLD",6680,1,11,0)
The program PSAPROC7 will be modified to cleanup the variables prior
"BLD",6680,1,12,0)
to the call to DICN0.
"BLD",6680,1,13,0)
 
"BLD",6680,1,14,0)
Problem HD92886 - Leading zero's in supply item description 
"BLD",6680,1,15,0)
--------------------------------------------------------------
"BLD",6680,1,16,0)
If a line item on an invoice is edited to be a supply item and
"BLD",6680,1,17,0)
the supply item description starts with a numeric (Example: 16
"BLD",6680,1,18,0)
vial dram, or 10x10 sponge) the system interprets the leading
"BLD",6680,1,19,0)
numeric's as an internal entry number to the Drug File.  This
"BLD",6680,1,20,0)
will cause the software to erroneously select the wrong drug.
"BLD",6680,1,21,0)
 
"BLD",6680,1,22,0)
Resolution HD92886 - Leading zero's in supply item description
"BLD",6680,1,23,0)
--------------------------------------------------------------
"BLD",6680,1,24,0)
The code has been modified to ignore the fact that the supply
"BLD",6680,1,25,0)
item description starts with a leading numeric.
"BLD",6680,1,26,0)
 
"BLD",6680,1,27,0)
Problem HD68635 - Undefined error while editing invoices
"BLD",6680,1,28,0)
--------------------------------------------------------------
"BLD",6680,1,29,0)
In rare cases, the UPC and/or the NDC code in an invoice has
"BLD",6680,1,30,0)
no value.  If this is the case, the software will error out
"BLD",6680,1,31,0)
with an undefined error while editing an invoice to be verified.
"BLD",6680,1,32,0)
 
"BLD",6680,1,33,0)
Resolution HD68635 - Undefined error while editing invoices
"BLD",6680,1,34,0)
--------------------------------------------------------------
"BLD",6680,1,35,0)
The code in question will be strengthened to not error out when
"BLD",6680,1,36,0)
this scenario occurs.
"BLD",6680,4,0)
^9.64PA^^
"BLD",6680,6)
1^
"BLD",6680,6.3)
1
"BLD",6680,"ABPKG")
n
"BLD",6680,"KRN",0)
^9.67PA^8989.52^19
"BLD",6680,"KRN",.4,0)
.4
"BLD",6680,"KRN",.401,0)
.401
"BLD",6680,"KRN",.402,0)
.402
"BLD",6680,"KRN",.403,0)
.403
"BLD",6680,"KRN",.5,0)
.5
"BLD",6680,"KRN",.84,0)
.84
"BLD",6680,"KRN",3.6,0)
3.6
"BLD",6680,"KRN",3.8,0)
3.8
"BLD",6680,"KRN",9.2,0)
9.2
"BLD",6680,"KRN",9.8,0)
9.8
"BLD",6680,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",6680,"KRN",9.8,"NM",1,0)
PSAPROC7^^0^B51614865
"BLD",6680,"KRN",9.8,"NM",2,0)
PSAUTL4^^0^B26805479
"BLD",6680,"KRN",9.8,"NM",3,0)
PSAVER6^^0^B56721595
"BLD",6680,"KRN",9.8,"NM",4,0)
PSAVERA1^^0^B25757981
"BLD",6680,"KRN",9.8,"NM",5,0)
PSAORDP1^^0^B72112158
"BLD",6680,"KRN",9.8,"NM","B","PSAORDP1",5)

"BLD",6680,"KRN",9.8,"NM","B","PSAPROC7",1)

"BLD",6680,"KRN",9.8,"NM","B","PSAUTL4",2)

"BLD",6680,"KRN",9.8,"NM","B","PSAVER6",3)

"BLD",6680,"KRN",9.8,"NM","B","PSAVERA1",4)

"BLD",6680,"KRN",19,0)
19
"BLD",6680,"KRN",19.1,0)
19.1
"BLD",6680,"KRN",101,0)
101
"BLD",6680,"KRN",409.61,0)
409.61
"BLD",6680,"KRN",771,0)
771
"BLD",6680,"KRN",870,0)
870
"BLD",6680,"KRN",8989.51,0)
8989.51
"BLD",6680,"KRN",8989.52,0)
8989.52
"BLD",6680,"KRN",8994,0)
8994
"BLD",6680,"KRN","B",.4,.4)

"BLD",6680,"KRN","B",.401,.401)

"BLD",6680,"KRN","B",.402,.402)

"BLD",6680,"KRN","B",.403,.403)

"BLD",6680,"KRN","B",.5,.5)

"BLD",6680,"KRN","B",.84,.84)

"BLD",6680,"KRN","B",3.6,3.6)

"BLD",6680,"KRN","B",3.8,3.8)

"BLD",6680,"KRN","B",9.2,9.2)

"BLD",6680,"KRN","B",9.8,9.8)

"BLD",6680,"KRN","B",19,19)

"BLD",6680,"KRN","B",19.1,19.1)

"BLD",6680,"KRN","B",101,101)

"BLD",6680,"KRN","B",409.61,409.61)

"BLD",6680,"KRN","B",771,771)

"BLD",6680,"KRN","B",870,870)

"BLD",6680,"KRN","B",8989.51,8989.51)

"BLD",6680,"KRN","B",8989.52,8989.52)

"BLD",6680,"KRN","B",8994,8994)

"BLD",6680,"QUES",0)
^9.62^^
"BLD",6680,"REQB",0)
^9.611^3^3
"BLD",6680,"REQB",1,0)
PSA*3.0*21^2
"BLD",6680,"REQB",2,0)
PSA*3.0*54^2
"BLD",6680,"REQB",3,0)
PSA*3.0*57^2
"BLD",6680,"REQB","B","PSA*3.0*21",1)

"BLD",6680,"REQB","B","PSA*3.0*54",2)

"BLD",6680,"REQB","B","PSA*3.0*57",3)

"MBREQ")
0
"PKG",343,-1)
1^1
"PKG",343,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",343,20,0)
^9.402P^^
"PKG",343,22,0)
^9.49I^1^1
"PKG",343,22,1,0)
3.0^2971024^2980330^1
"PKG",343,22,1,"PAH",1,0)
61^3060926^520645583
"PKG",343,22,1,"PAH",1,1,0)
^^36^36^3060926
"PKG",343,22,1,"PAH",1,1,1,0)
Problem HD129689 - Undefined error while processing invoice
"PKG",343,22,1,"PAH",1,1,2,0)
--------------------------------------------------------------
"PKG",343,22,1,"PAH",1,1,3,0)
During the processing of an invoice, it is possible to receive
"PKG",343,22,1,"PAH",1,1,4,0)
The following message:
"PKG",343,22,1,"PAH",1,1,5,0)
Undefined N1+3 DICNO Unable to Process Invoice
"PKG",343,22,1,"PAH",1,1,6,0)
This error is caused by the system not properly cleaning up variables
"PKG",343,22,1,"PAH",1,1,7,0)
used by the program DICN0.
"PKG",343,22,1,"PAH",1,1,8,0)
 
"PKG",343,22,1,"PAH",1,1,9,0)
Resolution HD129689 - Undefined error while processing invoice
"PKG",343,22,1,"PAH",1,1,10,0)
--------------------------------------------------------------
"PKG",343,22,1,"PAH",1,1,11,0)
The program PSAPROC7 will be modified to cleanup the variables prior
"PKG",343,22,1,"PAH",1,1,12,0)
to the call to DICN0.
"PKG",343,22,1,"PAH",1,1,13,0)
 
"PKG",343,22,1,"PAH",1,1,14,0)
Problem HD92886 - Leading zero's in supply item description 
"PKG",343,22,1,"PAH",1,1,15,0)
--------------------------------------------------------------
"PKG",343,22,1,"PAH",1,1,16,0)
If a line item on an invoice is edited to be a supply item and
"PKG",343,22,1,"PAH",1,1,17,0)
the supply item description starts with a numeric (Example: 16
"PKG",343,22,1,"PAH",1,1,18,0)
vial dram, or 10x10 sponge) the system interprets the leading
"PKG",343,22,1,"PAH",1,1,19,0)
numeric's as an internal entry number to the Drug File.  This
"PKG",343,22,1,"PAH",1,1,20,0)
will cause the software to erroneously select the wrong drug.
"PKG",343,22,1,"PAH",1,1,21,0)
 
"PKG",343,22,1,"PAH",1,1,22,0)
Resolution HD92886 - Leading zero's in supply item description
"PKG",343,22,1,"PAH",1,1,23,0)
--------------------------------------------------------------
"PKG",343,22,1,"PAH",1,1,24,0)
The code has been modified to ignore the fact that the supply
"PKG",343,22,1,"PAH",1,1,25,0)
item description starts with a leading numeric.
"PKG",343,22,1,"PAH",1,1,26,0)
 
"PKG",343,22,1,"PAH",1,1,27,0)
Problem HD68635 - Undefined error while editing invoices
"PKG",343,22,1,"PAH",1,1,28,0)
--------------------------------------------------------------
"PKG",343,22,1,"PAH",1,1,29,0)
In rare cases, the UPC and/or the NDC code in an invoice has
"PKG",343,22,1,"PAH",1,1,30,0)
no value.  If this is the case, the software will error out
"PKG",343,22,1,"PAH",1,1,31,0)
with an undefined error while editing an invoice to be verified.
"PKG",343,22,1,"PAH",1,1,32,0)
 
"PKG",343,22,1,"PAH",1,1,33,0)
Resolution HD68635 - Undefined error while editing invoices
"PKG",343,22,1,"PAH",1,1,34,0)
--------------------------------------------------------------
"PKG",343,22,1,"PAH",1,1,35,0)
The code in question will be strengthened to not error out when
"PKG",343,22,1,"PAH",1,1,36,0)
this scenario occurs.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSAORDP1")
0^5^B72112158^B72112204
"RTN","PSAORDP1",1,0)
PSAORDP1 ;BIR/JMB-Print Orders - CONT'D ;9/19/97
"RTN","PSAORDP1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,12,21,61**; 10/24/97;Build 1
"RTN","PSAORDP1",3,0)
 ;This routine prints invoices.
"RTN","PSAORDP1",4,0)
 ;
"RTN","PSAORDP1",5,0)
 ;References to global ^DIC(51.5 are covered by IA #1931
"RTN","PSAORDP1",6,0)
 ;References to global ^PSDRUG( are covered by IA #2095
"RTN","PSAORDP1",7,0)
 ;References to global ^PSDRUG("C" are covered by IA #2095
"RTN","PSAORDP1",8,0)
 ;
"RTN","PSAORDP1",9,0)
DQ S IOM=80 D NOW^%DTC S Y=% D DD^%DT S PSARUN=$E(Y,1,18),PSAPAGE=1,$P(PSASLN,"-",80)="",$P(PSADLN,"=",80)="",(PSADJDRG,PSAOUT)=0,PSAFPG=1
"RTN","PSAORDP1",10,0)
 S PSAEND=0,PSAORDER=$P(^PSD(58.811,PSAORD,0),"^") D HEADER^PSAORDP2
"RTN","PSAORDP1",11,0)
 S PSAIN=$G(^PSD(58.811,PSAORD,1,PSAINV,0)),PSAINVN=$P(PSAIN,"^"),PSASTA=$P(PSAIN,"^",3),PSADEL=+$P(PSAIN,"^",6),PSAREC=+$P(PSAIN,"^",7)
"RTN","PSAORDP1",12,0)
START W !,"PRIME VENDOR : ",$S($P($G(^PSD(58.811,PSAORD,0)),"^",2)'="":$P($G(^(0)),"^",2),1:"UNKNOWN")
"RTN","PSAORDP1",13,0)
 W !!,"ORDER#  : "_PSAORDER,?40,"ORDER DATE   : "_$$DATE($P(PSAIN,"^",4))
"RTN","PSAORDP1",14,0)
 W !,"INVOICE#: "_PSAINVN,?40,"INVOICE DATE : "_$$DATE($P(PSAIN,"^",2))
"RTN","PSAORDP1",15,0)
 W !,"STATUS  : "_$S(PSASTA="P":"PROCESSED",PSASTA="V":"VERIFIED",PSASTA="C":"COMPLETED",1:"UNKNOWN")_$S(+$P(PSAIN,"^",13):" (SUPPLY INVOICE)",1:"")
"RTN","PSAORDP1",16,0)
 W ?40,"DELIVERY DATE: "_$S(PSADEL:$$DATE(PSADEL),1:"UNKNOWN")
"RTN","PSAORDP1",17,0)
 W !?40,"DATE RECEIVED: "_$S(PSAREC:$$DATE(PSAREC),PSADEL:$$DATE(PSADEL),1:"UNKNOWN"),!
"RTN","PSAORDP1",18,0)
 S PSADJDRG=0 S (PSAIECST,PSAAECST)=0 D LINE
"RTN","PSAORDP1",19,0)
 ;
"RTN","PSAORDP1",20,0)
EXIT ;Kills 
"RTN","PSAORDP1",21,0)
 K %,DIR,DIRUT,PSAAECST,PSACIEN,PSADATA,PSADATE,PSADEC,PSADEL,PSADJ,PSADJD,PSADJDP,PSADJDRG,PSADJSUP,PSADJDV,PSADPDT,PSADPDUZ,PSADVDT,PSADVDUZ,PSADJO,PSADJOP,PSADJOV
"RTN","PSAORDP1",22,0)
 K PSADJP,PSADJPP,PSADJPV,PSADJQ,PSADJQP,PSADJQV,PSADLN,PSADRG,PSAECOST,PSAEND,PSAFPG,PSAICOST,PSAIECST,PSAIN,PSAINVN
"RTN","PSAORDP1",23,0)
 K PSALN,PSAMORE,PSANDC,PSANODE,PSAOPDT,PSAOPDUZ,PSAORDER,PSAOU,PSAOVDT,PSAOVDUZ,PSAPAGE,PSAPPDT,PSAPPDUZ,PSAPRICE
"RTN","PSAORDP1",24,0)
 K PSAPVDT,PSAPVDUZ,PSAQPDT,PSAQPDUZ,PSAQPREA,PSAQVDT,PSAQVDUZ,PSAQVREA,PSAREC,PSARUN,PSAS,PSASLN,PSASS,PSASTA,PSATOT,Y
"RTN","PSAORDP1",25,0)
 Q
"RTN","PSAORDP1",26,0)
 ;
"RTN","PSAORDP1",27,0)
DATE(PSADATE)         ;convert date
"RTN","PSAORDP1",28,0)
 S %=$E(PSADATE,4,5)_"/"_$E(PSADATE,6,7)_"/"_$E(PSADATE,2,3)
"RTN","PSAORDP1",29,0)
 I $TR(%,"/")="" S %="UNKNOWN"
"RTN","PSAORDP1",30,0)
 Q %
"RTN","PSAORDP1",31,0)
 ;
"RTN","PSAORDP1",32,0)
LINE ;print line items
"RTN","PSAORDP1",33,0)
 D LINEHDR^PSAORDP2 S (PSAICOST,PSALN,PSATOT)=0
"RTN","PSAORDP1",34,0)
 F  S PSALN=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN)) Q:'PSALN!(PSAOUT)  D  Q:PSAOUT
"RTN","PSAORDP1",35,0)
 .Q:'$D(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,0))
"RTN","PSAORDP1",36,0)
 .S PSADATA=^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,0)
"RTN","PSAORDP1",37,0)
 .K PSADJQP,PSAQPDUZ,PSAQPDT,PSAQPREA,PSADJQV,PSAQVDUZ,PSAQVDT,PSAQVREA
"RTN","PSAORDP1",38,0)
 .K PSADJOP,PSAOPDUZ,PSAOPDT,PSADJOV,PSAOVDUZ,PSAOVDT
"RTN","PSAORDP1",39,0)
 .K PSADJPP,PSAPPDUZ,PSAPPDT,PSADJPV,PSAPVDUZ,PSAPVDT
"RTN","PSAORDP1",40,0)
 .K PSADJDP,PSADPDUZ,PSADPDT,PSADJDV,PSADVDUZ,PSADVDT
"RTN","PSAORDP1",41,0)
 .S PSADJSUP=0
"RTN","PSAORDP1",42,0)
 .I $D(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)) S PSAMORE=4 D
"RTN","PSAORDP1",43,0)
 ..S:+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^") PSAMORE=5
"RTN","PSAORDP1",44,0)
 ..S:+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^",2) PSAMORE=PSAMORE+1
"RTN","PSAORDP1",45,0)
 .E  S PSAMORE=4
"RTN","PSAORDP1",46,0)
 .I ($Y+PSAMORE)>IOSL D:$E(IOST,1,2)="C-" SCREEN^PSAORDP2 Q:PSAOUT  D HEADER^PSAORDP2,LINEHDR^PSAORDP2
"RTN","PSAORDP1",47,0)
 .W !,$P(PSADATA,"^")
"RTN","PSAORDP1",48,0)
DRUG .S PSADRG=0,PSADJ=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,"B","D",0))
"RTN","PSAORDP1",49,0)
 .I $G(PSADJ) D
"RTN","PSAORDP1",50,0)
 ..S PSANODE=$G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,PSADJ,0))
"RTN","PSAORDP1",51,0)
 ..S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAORDP1",52,0)
 ..I $G(PSADJD),$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" D  Q
"RTN","PSAORDP1",53,0)
 ...W ?8,"*"_$P($G(^PSDRUG(+PSADJD,0)),"^") S PSADJDRG=1,PSADRG=PSADJD
"RTN","PSAORDP1",54,0)
 ...I $P(PSANODE,"^",6)'="" S PSADJDV=$P(PSANODE,"^",6),PSADVDT=$P(PSANODE,"^",8),PSADVDUZ=$P(PSANODE,"^",9)
"RTN","PSAORDP1",55,0)
 ...I $P(PSANODE,"^",2)'="" S PSADJDP=$P(PSANODE,"^",2),PSADPDT=$P(PSANODE,"^",4),PSADPDUZ=$P(PSANODE,"^",5)
"RTN","PSAORDP1",56,0)
 ..I $G(PSADJD),$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S PSADJ=0 Q
"RTN","PSAORDP1",57,0)
 ..W ?7,"**"_PSADJD S PSADJSUP=1,PSADRG=0
"RTN","PSAORDP1",58,0)
 ..I $P(PSANODE,"^",6)'="" S PSADJDV=$P(PSANODE,"^",6),PSADVDT=$P(PSANODE,"^",8),PSADVDUZ=$P(PSANODE,"^",9)
"RTN","PSAORDP1",59,0)
 ..I $P(PSANODE,"^",2)'="" S PSADJDP=$P(PSANODE,"^",2),PSADPDT=$P(PSANODE,"^",4),PSADPDUZ=$P(PSANODE,"^",5)
"RTN","PSAORDP1",60,0)
 .I '$G(PSADJ) D
"RTN","PSAORDP1",61,0)
 ..S PSADRG=$S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):+$P(PSADATA,"^",2),1:0)
"RTN","PSAORDP1",62,0)
 ..W ?9,$S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):$P(^PSDRUG(+$P(PSADATA,"^",2),0),"^"),1:"DRUG UNKNOWN")
"RTN","PSAORDP1",63,0)
CS .I +$P(PSADATA,"^",10) W " (CONTROLLED SUBS)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !?5,"*** INACTIVE IN MASTER VAULT ***"
"RTN","PSAORDP1",64,0)
 .E  I PSADRG,$P($G(^PSD(58.8,+$P(PSAIN,"^",5),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !?5,"*** INACTIVE IN PHARMACY LOCATION ***"
"RTN","PSAORDP1",65,0)
 .I PSADRG,$D(^PSDRUG(+PSADRG,"I")) W !?5,"*** INACTIVE IN DRUG FILE ***"
"RTN","PSAORDP1",66,0)
 .;
"RTN","PSAORDP1",67,0)
UPC .W:$P(PSADATA,"^",13)'="" !?9,"UPC: "_$P(PSADATA,"^",13)
"RTN","PSAORDP1",68,0)
NDC .S PSANDC=$P(PSADATA,"^",11)
"RTN","PSAORDP1",69,0)
 .I $E(PSANDC)'="S" D PSANDC1^PSAHELP S PSANDC=PSANDCX K PSANDCX W !?9,PSANDC
"RTN","PSAORDP1",70,0)
 .S PSASUB=$S(+$P($G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)),"^",3):+$P($G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)),"^",3),$G(PSANDC)'="":$S(+$O(^PSDRUG("C",PSANDC,+PSADRG,0)):+$O(^PSDRUG("C",PSANDC,+PSADRG,0)),1:0),1:0)
"RTN","PSAORDP1",71,0)
VSN .W ?25,$S($P(PSADATA,"^",12)'="":$P(PSADATA,"^",12),1:"VSN UNKNOWN")
"RTN","PSAORDP1",72,0)
 .;
"RTN","PSAORDP1",73,0)
QTY .;No Adj. Qty
"RTN","PSAORDP1",74,0)
 .S PSAIECST=PSAIECST+($P(PSADATA,"^",3)*$P(PSADATA,"^",5))
"RTN","PSAORDP1",75,0)
 .S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,"B","P",0))
"RTN","PSAORDP1",76,0)
 .I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,PSADJ,0)),PSAPRICE=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAORDP1",77,0)
 .I '$G(PSADJ) S PSAPRICE=$P(PSADATA,"^",5)
"RTN","PSAORDP1",78,0)
 .S PSADJQ="",PSADJ=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,"B","Q",0))
"RTN","PSAORDP1",79,0)
 .I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAORDP1",80,0)
 .;Adj. Qty
"RTN","PSAORDP1",81,0)
 .I $G(PSADJQ) D
"RTN","PSAORDP1",82,0)
 ..I $P(PSANODE,"^",6)'="" S PSADJQV=$P(PSANODE,"^",6),PSAQVREA=$P(PSANODE,"^",7),PSAQVDT=$P(PSANODE,"^",8),PSAQVDUZ=$P(PSANODE,"^",9)
"RTN","PSAORDP1",83,0)
 ..I $P(PSANODE,"^",2)'="" S PSADJQP=$P(PSANODE,"^",2),PSAQPREA=$P(PSANODE,"^",3),PSAQPDT=$P(PSANODE,"^",4),PSAQPDUZ=$P(PSANODE,"^",5)
"RTN","PSAORDP1",84,0)
 ..S PSAECOST=PSADJQ*PSAPRICE,PSAAECST=PSAAECST+PSAECOST
"RTN","PSAORDP1",85,0)
 ..W ?40,$S($G(PSADJQV)'="":$J(PSADJQV,6),1:$J(PSADJQP,6))_"("_$P(PSADATA,"^",3)_")"
"RTN","PSAORDP1",86,0)
 .I '$G(PSADJQ) W ?40,$J($P(PSADATA,"^",3),6) S PSAECOST=$P(PSADATA,"^",3)*PSAPRICE,PSAAECST=PSAAECST+PSAECOST
"RTN","PSAORDP1",87,0)
 .;
"RTN","PSAORDP1",88,0)
OU .;Order Unit
"RTN","PSAORDP1",89,0)
 .S PSAOU=$S(+$P(PSADATA,"^",4):$P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^"),+PSASUB&(+$P($G(^PSDRUG(PSADRG,1,+PSASUB,0)),"^",5)):$P($G(^DIC(51.5,+$P($G(^PSDRUG(PSADRG,1,+PSASUB,0)),"^",5),0)),"^"),1:"")
"RTN","PSAORDP1",90,0)
 .S PSADJO="",PSADJ=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,"B","O",0))
"RTN","PSAORDP1",91,0)
 .I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAORDP1",92,0)
 .;Adj. Order Unit
"RTN","PSAORDP1",93,0)
 .I PSADJO'="" D
"RTN","PSAORDP1",94,0)
 ..I $P(PSANODE,"^",6)'="" S PSADJOV=$P(PSANODE,"^",6),PSAOVDT=$P(PSANODE,"^",8),PSAOVDUZ=$P(PSANODE,"^",9)
"RTN","PSAORDP1",95,0)
 ..I $P(PSANODE,"^",2)'="" S PSADJOP=$P(PSANODE,"^",2),PSAOPDT=$P(PSANODE,"^",4),PSAOPDUZ=$P(PSANODE,"^",5)
"RTN","PSAORDP1",96,0)
 ..W ?53,$S(+PSADJO:$P($G(^DIC(51.5,+PSADJO,0)),"^"),1:"UNKNOWN")_" ("_$S(PSAOU'="":PSAOU,1:"")_")"
"RTN","PSAORDP1",97,0)
 .I PSADJO="" W ?53,$S(PSAOU'="":PSAOU,1:"()")
"RTN","PSAORDP1",98,0)
 .;
"RTN","PSAORDP1",99,0)
PRICE .;Unit price
"RTN","PSAORDP1",100,0)
 .S PSADEC=$S($L($P($P(PSADATA,"^",5),".",2))>1:$L($P($P(PSADATA,"^",5),".",2)),1:2)
"RTN","PSAORDP1",101,0)
 .S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,"B","P",0))
"RTN","PSAORDP1",102,0)
 .I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAORDP1",103,0)
 .;Adj. Unit Price
"RTN","PSAORDP1",104,0)
 .I $G(PSADJP) D
"RTN","PSAORDP1",105,0)
 ..I +$P(PSANODE,"^",6) S PSADJPV=$P(PSANODE,"^",6),PSAPVDT=$P(PSANODE,"^",8),PSAPVDUZ=$P(PSANODE,"^",9)
"RTN","PSAORDP1",106,0)
 ..I +$P(PSANODE,"^",2) S PSADJPP=$P(PSANODE,"^",2),PSAPPDT=$P(PSANODE,"^",4),PSAPPDUZ=$P(PSANODE,"^",5)
"RTN","PSAORDP1",107,0)
 ..W ?60,$J(PSADJP,7,2)_" ("_$S(+$P(PSADATA,"^",5):$P(PSADATA,"^",5),$P(PSADATA,"^",5)=0:0,1:"")_")"
"RTN","PSAORDP1",108,0)
 .I '$G(PSADJP) D
"RTN","PSAORDP1",109,0)
 ..I +$P(PSADATA,"^",5)!($P(PSADATA,"^",5)=0) W ?60,$S(+$P(PSADATA,"^",5):$J($P(PSADATA,"^",5),7,PSADEC),1:0) Q
"RTN","PSAORDP1",110,0)
 ..W ?65,"(Blank)"
"RTN","PSAORDP1",111,0)
 .;
"RTN","PSAORDP1",112,0)
XCOST .;Extended cost
"RTN","PSAORDP1",113,0)
 .W:PSADJP ?67,$J(PSAECOST,7,2) W:'PSADJP ?70,$J(PSAECOST,9,2)
"RTN","PSAORDP1",114,0)
 .;
"RTN","PSAORDP1",115,0)
LEVELS .;DAVE B (PSA*3*3)
"RTN","PSAORDP1",116,0)
 .S OU=$P($G(^PSDRUG(+PSADRG,660)),"^",2) I OU'="" S OU=$P($G(^DIC(51.5,OU,0)),"^",1)
"RTN","PSAORDP1",117,0)
 .W !!,"Drug file Data - Dispense Unit: ",$P($G(^PSDRUG(+PSADRG,660)),"^",8),?40,"Order Unit : ",$G(OU)
"RTN","PSAORDP1",118,0)
 .;W !,?20," Disp. Unit: ",$P($G(^PSDRUG(+PSADRG,660)),"^",8)
"RTN","PSAORDP1",119,0)
 .W " DUOU: ",$P($G(^PSDRUG(+PSADRG,660)),"^",5)
"RTN","PSAORDP1",120,0)
 .W !,"Invoiced ",?40,"Order Unit : ",$S($P(PSADATA,"^",4)=""!($P(PSADATA,"^",4)=0):"None Sent",1:$S($P(PSADATA,"^",4)["~":"Invalid: "_$P(PSADATA,"^",4),1:$P(^DIC(51.5,$P(PSADATA,"^",4),0),"^")))
"RTN","PSAORDP1",121,0)
 .W " DUOU: ",$S(+$P($G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)),"^")'=0:$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^"),1:"nothing changed")
"RTN","PSAORDP1",122,0)
 .K OU
"RTN","PSAORDP1",123,0)
 .W:+$P($G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)),"^",4)'=0 !?9,"STOCK LEVEL  : "_$FN(+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^",4),",")
"RTN","PSAORDP1",124,0)
 .W:+$P($G(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2)),"^",2)'=0 !?9,"REORDER LEVEL: "_$FN(+$P(^PSD(58.811,PSAORD,1,PSAINV,1,PSALN,2),"^",2),",")
"RTN","PSAORDP1",125,0)
 .;
"RTN","PSAORDP1",126,0)
 .I $Y+5>IOSL D:$E(IOST,1,2)="C-" SCREEN^PSAORDP2 Q:PSAOUT  D HEADER^PSAORDP2 D LINEHDR^PSAORDP2
"RTN","PSAORDP1",127,0)
 .D ^PSAORDP2 Q:PSAOUT
"RTN","PSAORDP1",128,0)
 .W !
"RTN","PSAORDP1",129,0)
 Q:PSAOUT
"RTN","PSAORDP1",130,0)
 I $Y+5>IOSL D:$E(IOST,1,2)="C-" SCREEN^PSAORDP2 Q:PSAOUT  D HEADER^PSAORDP2
"RTN","PSAORDP1",131,0)
 W !,PSASLN
"RTN","PSAORDP1",132,0)
 S PSADJSUP=$S($P($G(^PSD(58.811,PSAORD,1,PSAINV,0)),"^",13)=1:1,1:0)
"RTN","PSAORDP1",133,0)
 I $G(PSAAECST)'=$G(PSAIECST) D
"RTN","PSAORDP1",134,0)
 .W !?47,"TOTAL ADJUSTED COST",?67,$J(PSAAECST,12,2),!
"RTN","PSAORDP1",135,0)
 .I +$O(^PSD(58.811,PSAORD,1,PSAINV,2,0)) D
"RTN","PSAORDP1",136,0)
 ..S PSACIEN=0 F  S PSACIEN=+$O(^PSD(58.811,PSAORD,1,PSAINV,2,PSACIEN)) Q:'PSACIEN  D
"RTN","PSAORDP1",137,0)
 ...Q:'$D(^PSD(58.811,PSAORD,1,PSAINV,2,PSACIEN,0))
"RTN","PSAORDP1",138,0)
 ...I $Y+3>IOSL D:$E(IOST,1,2)="C-" SCREEN^PSAORDP2 Q:PSAOUT  D HEADER^PSAORDP2
"RTN","PSAORDP1",139,0)
 ...W:+$P(^PSD(58.811,PSAORD,1,PSAINV,2,PSACIEN,0),"^",3) ?55,"CREDIT MEMO "_$J($P(^(0),"^",3),12,2),!
"RTN","PSAORDP1",140,0)
 W !?47,"TOTAL INVOICED COST",?67,$J(PSAIECST,12,2)
"RTN","PSAORDP1",141,0)
 S PSAEND=1
"RTN","PSAORDP1",142,0)
 I $E(IOST)'="C" D
"RTN","PSAORDP1",143,0)
 .I PSADJDRG D:$Y+4>IOSL HEADER^PSAORDP2 W !!," * THE DRUG WAS MATCHED TO THE DRUG FILE.",!
"RTN","PSAORDP1",144,0)
 .I PSADJSUP D:$Y+4>IOSL HEADER^PSAORDP2 W !,"** THE ITEM IS A SUPPLY ITEM.",!
"RTN","PSAORDP1",145,0)
 D:$E(IOST,1,2)="C-" SCREEN^PSAORDP2
"RTN","PSAORDP1",146,0)
 W !
"RTN","PSAORDP1",147,0)
 Q
"RTN","PSAPROC7")
0^1^B51614865^B50647267
"RTN","PSAPROC7",1,0)
PSAPROC7 ;BIR/JMB-Process Uploaded Prime Vendor Invoice Data - CONT'D ;9/6/97
"RTN","PSAPROC7",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,12,24,27,21,42,61**; 10/24/97;Build 1
"RTN","PSAPROC7",3,0)
 ;This routine takes the data in XTMP and moves it to DA ORDERS file.
"RTN","PSAPROC7",4,0)
 ;It deletes the data in XTMP after it is copies.
"RTN","PSAPROC7",5,0)
 ;
"RTN","PSAPROC7",6,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAPROC7",7,0)
INVOICE ;PSA*3*21 (3JAN01) - FILE INVOICE IMMEDIATELY
"RTN","PSAPROC7",8,0)
 ;
"RTN","PSAPROC7",9,0)
 S PSAIN=$G(^XTMP("PSAPV",PSACTRL,"IN")) Q:PSAIN=""
"RTN","PSAPROC7",10,0)
 Q:$P(PSAIN,"^",8)'="P"
"RTN","PSAPROC7",11,0)
 S PSAORD=$P(PSAIN,"^",4),PSAIEN=+$O(^PSD(58.811,"B",PSAORD,0)),PSACRED=0
"RTN","PSAPROC7",12,0)
 I 'PSAIEN D
"RTN","PSAPROC7",13,0)
 .F  L +^PSD(58.811,0):0 I  Q
"RTN","PSAPROC7",14,0)
 .;(PSA*3*24 - Dave B. Jun 2 00 - Improper DIC call)
"RTN","PSAPROC7",15,0)
 .;(PSA*3*61 - add N DO. DICN will use DO if defined, we do not want to use it since DIC is defined.
"RTN","PSAPROC7",16,0)
 .N DO S DIC="^PSD(58.811,",DIC(0)="L",X=PSAORD D FILE^DICN K DIC L -^PSD(58.811,0) S PSAIEN=+Y
"RTN","PSAPROC7",17,0)
 F  L +^PSD(58.811,PSAIEN,0):10 I  Q
"RTN","PSAPROC7",18,0)
 S:'$D(^PSD(58.811,PSAIEN,1,0)) DIC("P")=$P(^DD(58.811,2,0),"^",2)
"RTN","PSAPROC7",19,0)
 S DA(1)=PSAIEN,DIC="^PSD(58.811,"_DA(1)_",1,",DIC(0)="L",X=$P(PSAIN,"^",2),DLAYGO=58.811 D ^DIC K DA,DLAYGO S PSAIEN1=+Y
"RTN","PSAPROC7",20,0)
 S DA(1)=PSAIEN,DA=PSAIEN1,DIE=DIC K DIC
"RTN","PSAPROC7",21,0)
 S PSALOCDR=$P($G(PSAIN),"^",7)
"RTN","PSAPROC7",22,0)
 S PSADELDR=$P($G(PSAIN),"^",6)
"RTN","PSAPROC7",23,0)
 S PSACSDR=$S($P(PSAIN,"^",10)="ALL CS":"A",$P(PSAIN,"^",9)="CS":"S",1:"N")
"RTN","PSAPROC7",24,0)
 S PSARECD=$P($G(PSAIN),"^",11)
"RTN","PSAPROC7",25,0)
 S PSAMV=$S(+$P(PSAIN,"^",12):$P(PSAIN,"^",12),1:"")
"RTN","PSAPROC7",26,0)
 S PSASUP=$S($P(PSAIN,"^",13)="SUP":1,1:"")
"RTN","PSAPROC7",27,0)
 ;DAVE B ( PSA*3*12) Invalid Concatenation of zero node
"RTN","PSAPROC7",28,0)
 S ^PSD(58.811,DA(1),1,DA,0)=$P(^(0),"^")_"^"_$P(PSAIN,"^",1)_"^P^"_$P(PSAIN,"^",3)_"^"_$G(PSALOCDR)_"^"_$G(PSADELDR)_"^"_$G(PSARECD)_"^"_$G(PSACSDR)_"^^"_DUZ_"^^"_$G(PSAMV)_"^"_$G(PSASUP)
"RTN","PSAPROC7",29,0)
 S DIK=DIE D IX^DIK
"RTN","PSAPROC7",30,0)
 K ^TMP($J,"PSADIF"),PSADIFLC ;*42 pre verify storage for  OU, DUOU, Cost, NDC changes
"RTN","PSAPROC7",31,0)
 S PSALINE=0 F  S PSALINE=$O(^XTMP("PSAPV",PSACTRL,"IT",PSALINE)) Q:PSALINE=""  D LINE
"RTN","PSAPROC7",32,0)
 D SCANDIF,MM ;*42 look for differences to drug file SEND EMAIL
"RTN","PSAPROC7",33,0)
 I PSACRED K DA S DA(1)=PSAIEN,DA=PSAIEN1,DIE="^PSD(58.811,"_DA(1)_",1,",DR="10///^S X=1" D ^DIE K DIE
"RTN","PSAPROC7",34,0)
 S $P(^PSD(58.811,PSAIEN,0),"^",2)=$P($G(^XTMP("PSAPV",PSACTRL,"DS")),"^")
"RTN","PSAPROC7",35,0)
 L -^PSD(58.811,PSAIEN,0)
"RTN","PSAPROC7",36,0)
 K ^XTMP("PSAPV",PSACTRL)
"RTN","PSAPROC7",37,0)
 Q
"RTN","PSAPROC7",38,0)
 ;
"RTN","PSAPROC7",39,0)
LINE ;Files line items.
"RTN","PSAPROC7",40,0)
 S PSADATA=^XTMP("PSAPV",PSACTRL,"IT",PSALINE) S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,0)) DIC("P")=$P(^DD(58.8112,5,0),"^",2)
"RTN","PSAPROC7",41,0)
 ;PSA*3*31 Dave B - Check for invoice already in file
"RTN","PSAPROC7",42,0)
 S DA(2)=PSAIEN,DA(1)=PSAIEN1,(DA,X)=PSALINE,DIC="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811 D ^DIC S PSAIEN2=+Y K DA,DIC,DLAYGO
"RTN","PSAPROC7",43,0)
 ;
"RTN","PSAPROC7",44,0)
 ;DAVEB PSA*3*3 (5may98)
"RTN","PSAPROC7",45,0)
 S PSADRG=$P($G(PSADATA),"^",6)
"RTN","PSAPROC7",46,0)
 S PSASYN=$P($G(PSADATA),"^",7)
"RTN","PSAPROC7",47,0)
 K PSAUNIT
"RTN","PSAPROC7",48,0)
 I $G(PSASYN)'="",$G(PSADRG)'="" S PSAUNIT=+$P($G(^PSDRUG(PSADRG,1,PSASYN,0)),"^",5)
"RTN","PSAPROC7",49,0)
 ;
"RTN","PSAPROC7",50,0)
 ;DAVE B (PSA*3*12) Assignment of order unit didn't take into 
"RTN","PSAPROC7",51,0)
 ;account the adjusted order unit.
"RTN","PSAPROC7",52,0)
 S PSAUNIT=$S($D(PSAUNIT):PSAUNIT,$P(PSADATA,"^",12)'="":$P(PSADATA,"^",12),+$P($P(PSADATA,"^",2),"~",2):+$P($P(PSADATA,"^",2),"~",2),1:0)
"RTN","PSAPROC7",53,0)
 S PSACS=$S($P(PSADATA,"^",19)="CS":1,1:0),PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~"),PSAUPC=$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC7",54,0)
 I PSANDC="",$P($P(PSADATA,"^",26),"~")'="" S PSANDC="S"_$P($P(PSADATA,"^",26),"~")
"RTN","PSAPROC7",55,0)
 S DA(2)=PSAIEN,DA(1)=PSAIEN1,DA=$S($D(PSAIEN2):PSAIEN2,1:PSALINE),DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,"
"RTN","PSAPROC7",56,0)
 ;DaveB (4may98) hard code filing data
"RTN","PSAPROC7",57,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",3)=+PSADATA
"RTN","PSAPROC7",58,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",11)=PSANDC
"RTN","PSAPROC7",59,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",12)=PSAVSN
"RTN","PSAPROC7",60,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",13)=PSAUPC
"RTN","PSAPROC7",61,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",10)=PSACS
"RTN","PSAPROC7",62,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",2)=PSADRG
"RTN","PSAPROC7",63,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",4)=PSAUNIT
"RTN","PSAPROC7",64,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",5)=$P(PSADATA,"^",3)
"RTN","PSAPROC7",65,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",6)=DT
"RTN","PSAPROC7",66,0)
 S $P(^PSD(58.811,DA(2),1,DA(1),1,DA,0),"^",7)=DUZ
"RTN","PSAPROC7",67,0)
 S DIK=DIE D IX^DIK
"RTN","PSAPROC7",68,0)
 ;End PSA*3*7
"RTN","PSAPROC7",69,0)
 ;
"RTN","PSAPROC7",70,0)
 I +$P(PSADATA,"^",15)!($D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"))) D ADJDRUG
"RTN","PSAPROC7",71,0)
 I $P(PSADATA,"^",8)'="" D QTY
"RTN","PSAPROC7",72,0)
 I +$P(PSADATA,"^",12) D OU
"RTN","PSAPROC7",73,0)
 I +$P(PSADATA,"^",23) D PRICE
"RTN","PSAPROC7",74,0)
 ;Adds the reorder level and/or dispense units per order unit
"RTN","PSAPROC7",75,0)
 I +$P(PSADATA,"^",7)!(+$P(PSADATA,"^",20))!(+$P(PSADATA,"^",21))!(+$P(PSADATA,"^",27)) D
"RTN","PSAPROC7",76,0)
 .S ^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,2)=$P(PSADATA,"^",20)_"^"_$P(PSADATA,"^",21)_"^"_$S(+$P(PSADATA,"^",7):+$P(PSADATA,"^",7),1:0)_"^"_+$P(PSADATA,"^",27)
"RTN","PSAPROC7",77,0)
 K ^XTMP("PSAPV",PSACTRL,"IT",PSALINE)
"RTN","PSAPROC7",78,0)
 Q
"RTN","PSAPROC7",79,0)
ADJDRUG ;Records adjusted drug received
"RTN","PSAPROC7",80,0)
 S PSAFLD="D"
"RTN","PSAPROC7",81,0)
 I +$P(PSADATA,"^",15) S PSADJ=+$P(PSADATA,"^",15),PSADUZ=+$P(PSADATA,"^",16),PSADT=+$P(PSADATA,"^",17),PSAREA="" D RECORD Q
"RTN","PSAPROC7",82,0)
 I $D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")) S PSASNODE=^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"),PSADJ=$P(PSASNODE,"^",3),PSADUZ=+$P(PSASNODE,"^"),PSADT=+$P(PSASNODE,"^",2),PSAREA="" D RECORD
"RTN","PSAPROC7",83,0)
 Q
"RTN","PSAPROC7",84,0)
OU ;Records adjusted order unit
"RTN","PSAPROC7",85,0)
 S PSAFLD="O",PSADJ=+$P(PSADATA,"^",12),PSADUZ=+$P(PSADATA,"^",13),PSADT=+$P(PSADATA,"^",14),PSAREA=""
"RTN","PSAPROC7",86,0)
 D RECORD
"RTN","PSAPROC7",87,0)
 Q
"RTN","PSAPROC7",88,0)
PRICE ;Records adjusted price per order unit
"RTN","PSAPROC7",89,0)
 S PSAFLD="P",PSADJ=+$P(PSADATA,"^",23),PSADUZ=+$P(PSADATA,"^",24),PSADT=+$P(PSADATA,"^",25),PSAREA=""
"RTN","PSAPROC7",90,0)
 S:PSADJ'=+$P(PSADATA,"^",3) PSACRED=1
"RTN","PSAPROC7",91,0)
 D RECORD
"RTN","PSAPROC7",92,0)
 Q
"RTN","PSAPROC7",93,0)
QTY ;Records adjusted quantity received.
"RTN","PSAPROC7",94,0)
 S PSAFLD="Q",PSADJ=+$P(PSADATA,"^",8),PSADUZ=+$P(PSADATA,"^",9),PSADT=+$P(PSADATA,"^",10),PSAREA=$P(PSADATA,"^",11)
"RTN","PSAPROC7",95,0)
 S:PSADJ'=+$P(PSADATA,"^") PSACRED=1
"RTN","PSAPROC7",96,0)
 D RECORD
"RTN","PSAPROC7",97,0)
 Q
"RTN","PSAPROC7",98,0)
RECORD ;Adds adjusted data to DA ORDERS file
"RTN","PSAPROC7",99,0)
 K DA S DA(3)=PSAIEN,DA(2)=PSAIEN1,DA(1)=PSAIEN2,X=PSAFLD
"RTN","PSAPROC7",100,0)
 S:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSAIEN2,1,0)) DIC("P")=$P(^DD(58.81125,9,0),"^",2)
"RTN","PSAPROC7",101,0)
 ;PSA*3*27 (DAVE B) removed killing of DA variable on next line
"RTN","PSAPROC7",102,0)
 S DIC="^PSD(58.811,"_DA(3)_",1,"_DA(2)_",1,"_DA(1)_",1,",DIC(0)="L",DLAYGO=58.811 D ^DIC S PSAIEN3=+Y K DLAYGO
"RTN","PSAPROC7",103,0)
 ;
"RTN","PSAPROC7",104,0)
 ;PSA*3*3
"RTN","PSAPROC7",105,0)
 ;DAVEB Hard code filing
"RTN","PSAPROC7",106,0)
 S DIE=DIC,DA=PSAIEN3
"RTN","PSAPROC7",107,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",2)=PSADJ
"RTN","PSAPROC7",108,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",3)=$G(PSAREA)
"RTN","PSAPROC7",109,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",4)=DT
"RTN","PSAPROC7",110,0)
 S $P(^PSD(58.811,DA(3),1,DA(2),1,DA(1),1,DA,0),"^",5)=DUZ
"RTN","PSAPROC7",111,0)
 ;
"RTN","PSAPROC7",112,0)
 ;S DIE=DIC,DA=PSAIEN3,DR="1///"_PSADJ_$S(PSAREA'="":";2////^S X=PSAREA",1:"")_";3///^S X="_PSADT_";4///^S X="_PSADUZ K DIC D ^DIE
"RTN","PSAPROC7",113,0)
 S DIK=DIE,DA=PSAIEN3 D IX1^DIK K DA,DIE,DIK,PSAFLD
"RTN","PSAPROC7",114,0)
 Q
"RTN","PSAPROC7",115,0)
 ;*42 CHANGES
"RTN","PSAPROC7",116,0)
SCANDIF ; inspect invoice for noted differences in OU,DUOU,PPDU,NDC
"RTN","PSAPROC7",117,0)
 ;NEEDS PSAIEN, PSAIEN1
"RTN","PSAPROC7",118,0)
 K ^TMP($J,"PSADIF"),PSADIFLC
"RTN","PSAPROC7",119,0)
 S PSALINE=0 F  S PSALINE=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:PSALINE'>0  D CHECK
"RTN","PSAPROC7",120,0)
 Q
"RTN","PSAPROC7",121,0)
MM ;
"RTN","PSAPROC7",122,0)
 I $D(^TMP($J,"PSADIF")) D MESSAGE
"RTN","PSAPROC7",123,0)
 Q
"RTN","PSAPROC7",124,0)
CHECK ;Check line item for differences to drug file *42
"RTN","PSAPROC7",125,0)
 N ITM,ITMI,DRG,DRIEN,DIF,ZZ,XX,XXX,PCNT,PDIF,T,IENS
"RTN","PSAPROC7",126,0)
 ; use new API call to retrieve item fields see PSAUTL6
"RTN","PSAPROC7",127,0)
 D ITEM^PSAUTL6(PSAIEN,PSAIEN1,PSALINE,.ITM)
"RTN","PSAPROC7",128,0)
 D ITEM^PSAUTL6(PSAIEN,PSAIEN1,PSALINE,.ITMI,"I")
"RTN","PSAPROC7",129,0)
 I ITM(2)'>0 Q  ;zero quantity will not be filed
"RTN","PSAPROC7",130,0)
 S ITM("OU")=ITM(3),ITM("DUOU")=ITM(10),ITM("NDC")=ITM(13),ITM("PPOU")=ITM(4),ITM("PPDU")=$J(ITM("PPOU")/ITM("DUOU"),1,4)
"RTN","PSAPROC7",131,0)
 S DRIEN=+ITMI(1)
"RTN","PSAPROC7",132,0)
 S DRG("OU")=$$GET1^DIQ(50,DRIEN,12),DRG("DUOU")=$$GET1^DIQ(50,DRIEN,15),DRG("NDC")=$$GET1^DIQ(50,DRIEN,31),DRG("PPDU")=$$GET1^DIQ(50,DRIEN,16)
"RTN","PSAPROC7",133,0)
 K DIF
"RTN","PSAPROC7",134,0)
 F XX="OU","DUOU","NDC" I ITM(XX)'=DRG(XX) S DIF(XX)=""
"RTN","PSAPROC7",135,0)
 I ITM("PPDU")'=DRG("PPDU") S PCNT=.05*DRG("PPDU"),PDIF=DRG("PPDU")-ITM("PPDU") S:PDIF<0 PDIF=-1*PDIF S:PDIF>PCNT DIF("PPDU")=""
"RTN","PSAPROC7",136,0)
 I $D(DIF) D
"RTN","PSAPROC7",137,0)
 . F ZZ=" ",$J(ITM(.01),3)_"   "_ITM(1) D SET
"RTN","PSAPROC7",138,0)
 . S XXX="" F  S XXX=$O(DIF(XXX)) Q:XXX=""  D
"RTN","PSAPROC7",139,0)
 .. S ZZ="  ",T=XXX,ZZ=$$SETSTR^VALM1(T,ZZ,4,$L(T))
"RTN","PSAPROC7",140,0)
 .. S T="Old: "_DRG(XXX),ZZ=$$SETSTR^VALM1(T,ZZ,13,$L(T))
"RTN","PSAPROC7",141,0)
 .. S T="New: "_ITM(XXX),ZZ=$$SETSTR^VALM1(T,ZZ,36,$L(T))
"RTN","PSAPROC7",142,0)
 .. D SET
"RTN","PSAPROC7",143,0)
 Q
"RTN","PSAPROC7",144,0)
SET ;set differences into ^TMP
"RTN","PSAPROC7",145,0)
 S:'$G(PSADIFLC) PSADIFLC=3
"RTN","PSAPROC7",146,0)
 S ^TMP($J,"PSADIF",PSADIFLC,0)=ZZ,PSADIFLC=PSADIFLC+1
"RTN","PSAPROC7",147,0)
 Q
"RTN","PSAPROC7",148,0)
MESSAGE ;differences found, notify user and send message to g.PSA NDC UPDATES.
"RTN","PSAPROC7",149,0)
 K DIR N IENS
"RTN","PSAPROC7",150,0)
 S PSAORD=$$GET1^DIQ(58.811,PSAIEN,.01),IENS=PSAIEN1_","_PSAIEN
"RTN","PSAPROC7",151,0)
 S PSAINV=$$GET1^DIQ(58.8112,IENS,.01)
"RTN","PSAPROC7",152,0)
 S XMSUB="PRE Verify "_PSAORD_" : "_PSAINV_" Variance Report"
"RTN","PSAPROC7",153,0)
 S ^TMP($J,"PSADIF",1,0)=XMSUB,^TMP($J,"PSADIF",2,0)=" "
"RTN","PSAPROC7",154,0)
 W !,XMSUB,!
"RTN","PSAPROC7",155,0)
 W !,"Noted differences between the invoice line items and the drug file have",!,"been found. A mail message is being sent to G.PSA NDC UPDATES."
"RTN","PSAPROC7",156,0)
 W !!,"    Please check the message for accuracy.",!
"RTN","PSAPROC7",157,0)
 K DIR S DIR(0)="E",DIR("A")="<cr> - continue" D ^DIR
"RTN","PSAPROC7",158,0)
 K DIR
"RTN","PSAPROC7",159,0)
 S XMTEXT="^TMP($J,""PSADIF"",",XMY("G.PSA NDC UPDATES")=""
"RTN","PSAPROC7",160,0)
 D ^XMD
"RTN","PSAPROC7",161,0)
 K PSADIFLC,^TMP($J,"PSADIF")
"RTN","PSAPROC7",162,0)
 Q
"RTN","PSAUTL4")
0^2^B26805479^B26771267
"RTN","PSAUTL4",1,0)
PSAUTL4 ;BIR ISC/JMB-Verify Invoices Utility ; 8/19/97
"RTN","PSAUTL4",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,21,48,54,61**; 10/24/97;Build 1
"RTN","PSAUTL4",3,0)
 ;
"RTN","PSAUTL4",4,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAUTL4",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAUTL4",6,0)
 I $G(PSADICW)=1 S PSALINE=Y
"RTN","PSAUTL4",7,0)
 ;This routine contains a utility to display a line item ready for
"RTN","PSAUTL4",8,0)
 ;verification. It is called by PSAVER1 and PSAVER2.
"RTN","PSAUTL4",9,0)
 ;
"RTN","PSAUTL4",10,0)
VERDISP ;Displays a line item on a processed or verified invoice
"RTN","PSAUTL4",11,0)
 W PSALINEN_"  "
"RTN","PSAUTL4",12,0)
DRUG S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAUTL4",13,0)
 I $G(PSADJ) D
"RTN","PSAUTL4",14,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAUTL4",15,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL4",16,0)
 .I PSADJD'?1.N S PSASUP=1
"RTN","PSAUTL4",17,0)
 .S PSADRG=$S(PSADJ&('PSASUP):$G(PSADJD),PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAUTL4",18,0)
 .I $G(PSADJD),$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" W "*"_$P($G(^PSDRUG(+PSADJD,0)),"^") S (PSADRG,PSA50IEN)=+PSADJD Q
"RTN","PSAUTL4",19,0)
 .I $G(PSADJD),$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAUTL4",20,0)
 .W ?7,"**"_PSADJD S PSADJSUP=1,(PSADRG,PSA50IEN)=PSADJD
"RTN","PSAUTL4",21,0)
 I '$G(PSADJ) D
"RTN","PSAUTL4",22,0)
 .S (PSA50IEN,PSADRG)=$S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):+$P(PSADATA,"^",2),1:0)
"RTN","PSAUTL4",23,0)
 .W $S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):$P(^PSDRUG(+$P(PSADATA,"^",2),0),"^"),1:"DRUG UNKNOWN")
"RTN","PSAUTL4",24,0)
 I PSADRG D
"RTN","PSAUTL4",25,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N" W " (Controlled Substance)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN MASTER VAULT **"
"RTN","PSAUTL4",26,0)
 .I $D(^PSDRUG(PSADRG,"I")) W !?5,"** INACTIVE IN DRUG FILE **" Q
"RTN","PSAUTL4",27,0)
 .I $P($G(^PSD(58.8,+$P(PSAIN,"^",5),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN PHARMACY LOCATION **"
"RTN","PSAUTL4",28,0)
QTY W !,"Qty Invoiced: "
"RTN","PSAUTL4",29,0)
 ;No Adj. Qty
"RTN","PSAUTL4",30,0)
 S PSADJQ="",PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAUTL4",31,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL4",32,0)
 ;Adj. Qty
"RTN","PSAUTL4",33,0)
 I $G(PSADJQ) S PSAQTY=PSADJQ W PSAQTY_" ("_$S($P(PSADATA,"^",3):$P(PSADATA,"^",3),$P(PSADATA,"^",3)=0:0,1:"Blank")_")"
"RTN","PSAUTL4",34,0)
 I '$G(PSADJQ) W $P(PSADATA,"^",3) S PSAQTY=$P(PSADATA,"^",3)
"RTN","PSAUTL4",35,0)
UPC S PSAUPC=$P(PSADATA,U,13) W:PSAUPC'="" ?38,"UPC: "_PSAUPC
"RTN","PSAUTL4",36,0)
OU W !,"Order Unit  : "
"RTN","PSAUTL4",37,0)
 S PSAOU=$S(+$P(PSADATA,"^",4)&($P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^")'=""):+$P(PSADATA,"^",4),1:"")
"RTN","PSAUTL4",38,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAUTL4",39,0)
 I +$P(PSATEMP,"^",3),PSADRG,+$P($G(^PSDRUG(PSADRG,1,+$P(PSATEMP,"^",3),0)),"^",5) S PSAOU=+$P(^PSDRUG(PSADRG,1,+$P(PSATEMP,"^",3),0),"^",5)
"RTN","PSAUTL4",40,0)
 S PSADJO="",PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAUTL4",41,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL4",42,0)
 ;Adj. Order Unit
"RTN","PSAUTL4",43,0)
 I PSADJO'="" W $S(+PSADJO&($P($G(^DIC(51.5,+PSADJO,0)),"^")'=""):$P($G(^DIC(51.5,+PSADJO,0)),"^"),1:"UNKNOWN")_" ("_$S(PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"Blank")_")" S PSAOU=+PSADJO
"RTN","PSAUTL4",44,0)
 I PSADJO="" W $S(+PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"Blank")
"RTN","PSAUTL4",45,0)
 ;
"RTN","PSAUTL4",46,0)
NDC S PSANDC=$P(PSADATA,"^",11)
"RTN","PSAUTL4",47,0)
 I $E(PSANDC)'="S" W ?38,"NDC: " D PSANDC1^PSAHELP W PSANDCX K PSANDCX
"RTN","PSAUTL4",48,0)
 ;
"RTN","PSAUTL4",49,0)
PRICE W !,"Unit Price  : $"
"RTN","PSAUTL4",50,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAUTL4",51,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAUTL4",52,0)
 ;Adj. Unit Price
"RTN","PSAUTL4",53,0)
 I $G(PSADJP) D
"RTN","PSAUTL4",54,0)
 .I $L($P(PSADJP,".",2))<2 S PSADJP=$P(PSADJP,".")_"."_$P(PSADJP,".",2)_$E("00",1,(2-$L($P(PSADJP,".",2))))
"RTN","PSAUTL4",55,0)
 .W $FN(PSADJP,",")_" ($"_$S(+$P(PSADATA,"^",5):$FN($P(PSADATA,"^",5),","),$P(PSADATA,"^",5)=0:"0.00",1:"")_")"
"RTN","PSAUTL4",56,0)
 .S PSAPRICE=PSADJP
"RTN","PSAUTL4",57,0)
 I '$G(PSADJP) D
"RTN","PSAUTL4",58,0)
 .S PSAPRICE=+$P(PSADATA,"^",5)
"RTN","PSAUTL4",59,0)
 .I $G(PSAPRICE)!(PSAPRICE=0) W $S($G(PSAPRICE):PSAPRICE,1:"0.00") Q
"RTN","PSAUTL4",60,0)
 .W "Blank"
"RTN","PSAUTL4",61,0)
 ;
"RTN","PSAUTL4",62,0)
VSN S:$D(PSADATA) PSAVSN=$P(PSADATA,"^",12) ;*48
"RTN","PSAUTL4",63,0)
 W ?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAUTL4",64,0)
 ;*54 display VSN XTMP Drug Description and DUOU |==>
"RTN","PSAUTL4",65,0)
 N PSAFLDT S PSAFLDT="February 2006"
"RTN","PSAUTL4",66,0)
 N XXX I PSAVSN'="" S XXX=$G(^XTMP("PSAVSN",PSAVSN)) D
"RTN","PSAUTL4",67,0)
 . I $G(^XTMP("PSAVSN",0)) S PSAFLDT=$P(^XTMP("PSAVSN",0),"^",4)
"RTN","PSAUTL4",68,0)
 . W !,"PV-Drug-Descrip: "
"RTN","PSAUTL4",69,0)
 . I '$L(XXX) W "Not Available. Item is OTC or new after ",PSAFLDT,! Q
"RTN","PSAUTL4",70,0)
 . W ?20,$P(XXX,"~",2),?55,"PV-DUOU: ",+XXX,!
"RTN","PSAUTL4",71,0)
 ;*54 display VSN XTMP Drug Description and DUOU <==|
"RTN","PSAUTL4",72,0)
VDU S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAUTL4",73,0)
 W !,"Dispense Units: "_$S($P($G(^PSDRUG(+PSADRG,660)),"^",8)'="":$P($G(^PSDRUG(+PSADRG,660)),"^",8),1:"Blank")
"RTN","PSAUTL4",74,0)
VDUOU W !,"Dispense Units Per Order Unit: "_$S(+PSADUOU:+PSADUOU,+PSASUB&(+$P($G(^PSDRUG(+PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(+PSADRG,1,PSASUB,0)),"^",7),1:"Blank"),!
"RTN","PSAUTL4",75,0)
 ;
"RTN","PSAUTL4",76,0)
 Q:'+$P($G(^PSD(58.8,+PSALOC,0)),"^",14)
"RTN","PSAUTL4",77,0)
 ;
"RTN","PSAUTL4",78,0)
STOCK S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",3),1:"Blank")
"RTN","PSAUTL4",79,0)
 W "Stock Level   : "_PSASTOCK
"RTN","PSAUTL4",80,0)
REORDER S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",5),1:"Blank")
"RTN","PSAUTL4",81,0)
 W !,"Reorder Level : "_PSAREORD,!
"RTN","PSAUTL4",82,0)
 Q
"RTN","PSAVER6")
0^3^B56721595^B56721641
"RTN","PSAVER6",1,0)
PSAVER6 ;BIR/JMB-Verify Invoices - CONT'D ;10/3/97
"RTN","PSAVER6",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**1,3,21,42,53,57,61**; 10/24/97;Build 1
"RTN","PSAVER6",3,0)
 ;Background Job:
"RTN","PSAVER6",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVER6",5,0)
 ;This routine increments pharmacy location and master vault balances
"RTN","PSAVER6",6,0)
 ;in 58.8 after invoices have been verified.
"RTN","PSAVER6",7,0)
 ;
"RTN","PSAVER6",8,0)
START ;|=> *42 add Post Verify variance report
"RTN","PSAVER6",9,0)
 K ^TMP($J,"PSADD")
"RTN","PSAVER6",10,0)
 K DIC,DA,DR,DIE  ;|=> *52 MOVE POST VERIFY E-MAIL LOGIC FROM START+17
"RTN","PSAVER6",11,0)
 S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",12,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",13,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",14,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",15,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",16,0)
 ..D SCANDIF  ; *57 <=|
"RTN","PSAVER6",17,0)
 S PSAIEN=0  F  S PSAIEN=+$O(PSAVBKG(PSAIEN)) Q:'PSAIEN  D
"RTN","PSAVER6",18,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))
"RTN","PSAVER6",19,0)
 .S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^"),PSAVEND=$P(^(0),"^",2),PSAIEN1=0
"RTN","PSAVER6",20,0)
 .F  S PSAIEN1=+$O(PSAVBKG(PSAIEN,PSAIEN1)) Q:'PSAIEN1  D
"RTN","PSAVER6",21,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))
"RTN","PSAVER6",22,0)
 ..S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER6",23,0)
 ..K DIC,DA,DR,DIE
"RTN","PSAVER6",24,0)
 ..I +$P(PSAIN,"^",13) K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR Q
"RTN","PSAVER6",25,0)
 ..S PSAINV=$P(PSAIN,"^"),PSAINVDT=$P(PSAIN,"^",2),PSALINE=0
"RTN","PSAVER6",26,0)
 ..F  S PSALINE=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:'PSALINE  D
"RTN","PSAVER6",27,0)
 ...Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVER6",28,0)
 ...S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0) D GETDATA I 'PSASUP,'$D(PSA0QTY) D FILE ;PSA*3*42
"RTN","PSAVER6",29,0)
 ..K DIC,DA,DR,DIE
"RTN","PSAVER6",30,0)
 ..K DA S DIE="^PSD(58.811,"_PSAIEN_",1,",DA(1)=PSAIEN,DA=PSAIEN1,DR="2////C" D ^DIE K DIE,DA,DR
"RTN","PSAVER6",31,0)
 ;;*57 => START+17 THRU START+22 MOVED TO START+3 <=|
"RTN","PSAVER6",32,0)
 ; *42 <=|
"RTN","PSAVER6",33,0)
EXIT ;Kills variables
"RTN","PSAVER6",34,0)
 K %,DA,DD,DIC,DIE,DINUM,DLAYGO,DO,PSA,PSAA,PSABAL,PSACBAL,PSACNT,PSACNT,PSACOD,PSACOST,PSACS,PSADASH,PSADATA,PSADJ,PSADJD,PSADJO,PSADJP,PSADJQ
"RTN","PSAVER6",35,0)
 K PSADRG,PSADT,PSADUOU,PSADUQTY,PSADUREC,PSAIEN,PSAIEN1,PSAIN,PSAINV,PSAINVDT,PSALEN,PSALINE,PSALOC,PSAMSG,PSANDC,PSANODE,PSANPDU,PSANPOU
"RTN","PSAVER6",36,0)
 K PSAODASH,PSAONDC,PSAORD,PSAOU,PSAPDU,PSAPOU,PSAQTY,PSAREORD,PSASET,PSASTOCK,PSASUP,PSAT,PSATDRG,PSATEMP,PSAVBKG,PSAVDUZ,PSAVEND,PSAVSN,X,XMDUZ,XMSUB,XMTEXT,XMY,XMZ,Y
"RTN","PSAVER6",37,0)
 K PSA0QTY
"RTN","PSAVER6",38,0)
 Q
"RTN","PSAVER6",39,0)
 ;
"RTN","PSAVER6",40,0)
GETDATA ;Gets invoice data to help file the data
"RTN","PSAVER6",41,0)
 S PSAVDUZ=$P(PSADATA,"^",9),PSASUP=0
"RTN","PSAVER6",42,0)
 S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAVER6",43,0)
 I '$G(PSADJ) S PSADRG=$S(+$P(PSADATA,"^",2):+$P(PSADATA,"^",2),1:0) G CS
"RTN","PSAVER6",44,0)
 I $G(PSADJ) D
"RTN","PSAVER6",45,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVER6",46,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",47,0)
 .I PSADJD'?1.N S PSASUP=1
"RTN","PSAVER6",48,0)
 .S PSADRG=$S(PSADJ&('PSASUP):+PSADJD,PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAVER6",49,0)
 .I +PSADJD,$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" S PSADRG=+PSADJD Q
"RTN","PSAVER6",50,0)
 .I +PSADJD,$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAVER6",51,0)
CS Q:PSASUP!('PSADRG)
"RTN","PSAVER6",52,0)
 S PSACS=$S(+$P(PSADATA,"^",10):1,1:0)
"RTN","PSAVER6",53,0)
 S PSADJQ=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAVER6",54,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",55,0)
 ;
"RTN","PSAVER6",56,0)
 ;PSA*3*1  (DAVE B)
"RTN","PSAVER6",57,0)
 S PSAQTY=$S(($G(PSADJQ)'=""&(+PSADJ)):PSADJQ,1:+$P(PSADATA,"^",3))
"RTN","PSAVER6",58,0)
 S PSAOU=$S(+$P(PSADATA,"^",4):+$P(PSADATA,"^",4),1:"")
"RTN","PSAVER6",59,0)
 ;
"RTN","PSAVER6",60,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",61,0)
 ;I +$P($P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),"^",5),"~",2) S PSAOU=$P($P($G(^(2)),"^",5),"~",2)
"RTN","PSAVER6",62,0)
 ;
"RTN","PSAVER6",63,0)
 S PSADJO=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAVER6",64,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVER6",65,0)
 S:$G(PSADJO) PSAOU=$G(PSADJO)
"RTN","PSAVER6",66,0)
 S PSANDC=$P(PSADATA,"^",11) D PSANDC1^PSAHELP S PSADASH=PSANDCX K PSANDCX
"RTN","PSAVER6",67,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAVER6",68,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAVER6",69,0)
 S (PSAPOU,PSANPOU)=$S($G(PSADJP):PSADJP,1:+$P(PSADATA,"^",5)),PSALEN=$L($P(PSANPOU,".")),(PSAPOU,PSANPOU)=$J(PSANPOU,PSALEN,2)
"RTN","PSAVER6",70,0)
 S PSAVSN=$P(PSADATA,"^",12)
"RTN","PSAVER6",71,0)
 S PSALOC=$S(+PSACS:+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",5))
"RTN","PSAVER6",72,0)
TEMP S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAVER6",73,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVER6",74,0)
 S PSADUOU=$S(+PSADUOU:+PSADUOU,+PSASUB&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:1)
"RTN","PSAVER6",75,0)
 S PSADUREC=$S(PSADUOU:PSAQTY*PSADUOU,1:0)
"RTN","PSAVER6",76,0)
 ;
"RTN","PSAVER6",77,0)
 ;DAVE B (18NOV98)
"RTN","PSAVER6",78,0)
 I PSADUREC=0,$D(PSAQTY),$P($G(^PSDRUG(PSADRG,660)),"^",5)'="" S PSADUREC=(PSAQTY*($P(^PSDRUG(PSADRG,660),"^",5)))
"RTN","PSAVER6",79,0)
 Q:'+$P($G(^PSD(58.8,PSALOC,0)),"^",14)
"RTN","PSAVER6",80,0)
 S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAVER6",81,0)
 S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3):+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAVER6",82,0)
 K PSA0QTY I '$G(PSAQTY),'$G(PSADJQ) S PSA0QTY=1 Q  ;PSA*3*42 (0 QTY)
"RTN","PSAVER6",83,0)
 Q
"RTN","PSAVER6",84,0)
 ;
"RTN","PSAVER6",85,0)
FILE ;File data in 58.8
"RTN","PSAVER6",86,0)
 I $D(PSADUREC),PSADUREC'>0 S PSADUREC=$S($D(PSADJQ):PSADJQ,$D(PSAQTY):PSAQTY,1:0)
"RTN","PSAVER6",87,0)
 D NOW^%DTC S PSADT=+$E(%,1,14)
"RTN","PSAVER6",88,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,0)) D
"RTN","PSAVER6",89,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",90,0)
 .S:'$D(^PSD(58.8,PSALOC,1,0)) DIC("P")=$P(^DD(58.8,10,0),"^",2)
"RTN","PSAVER6",91,0)
 .S DA(1)=PSALOC,DIC="^PSD(58.8,"_DA(1)_",1,",(DA,DINUM,X)=PSADRG,DIC(0)="L",DLAYGO=58.8
"RTN","PSAVER6",92,0)
 .F  L +^PSD(58.8,PSALOC,0):0 I  Q
"RTN","PSAVER6",93,0)
 .D FILE^DICN L -^PSD(58.8,PSALOC,0) K DIC,DA,DLAYGO
"RTN","PSAVER6",94,0)
 .D MM ;*42 send mailmessage
"RTN","PSAVER6",95,0)
 F  L +^PSD(58.8,PSALOC,1,PSADRG,0):0 I  Q
"RTN","PSAVER6",96,0)
 S PSABAL=+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",4)
"RTN","PSAVER6",97,0)
 ;
"RTN","PSAVER6",98,0)
 ;DAVE B (PSA*3*3)
"RTN","PSAVER6",99,0)
 I $P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",1)'=PSADRG S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",1)=PSADRG
"RTN","PSAVER6",100,0)
 S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",4)=PSADUREC+PSABAL
"RTN","PSAVER6",101,0)
 I +$P($G(^PSD(58.8,PSALOC,0)),"^",14) D
"RTN","PSAVER6",102,0)
 .I PSASTOCK'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",3)=PSASTOCK
"RTN","PSAVER6",103,0)
 .I PSAREORD'=$P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5) S $P(^PSD(58.8,PSALOC,1,PSADRG,0),"^",5)=PSAREORD
"RTN","PSAVER6",104,0)
 S:'$D(^PSD(58.8,PSALOC,1,PSADRG,5,0)) DIC("P")=$P(^DD(58.8001,20,0),"^",2)
"RTN","PSAVER6",105,0)
 I '$D(^PSD(58.8,PSALOC,1,PSADRG,5,$E(DT,1,5)*100,0)) D
"RTN","PSAVER6",106,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",107,0)
 .S DIC="^PSD(58.8,"_PSALOC_",1,"_PSADRG_",5,",DIC(0)="L",DIC("DR")="1////^S X=$G(PSABAL)"
"RTN","PSAVER6",108,0)
 .S (X,DINUM)=$E(DT,1,5)*100,DA(2)=PSALOC,DA(1)=PSADRG,DLAYGO=58.8 D ^DIC K DIC("DR")
"RTN","PSAVER6",109,0)
 .S X="T-1M" D ^%DT S (X,DINUM)=$E(Y,1,5)*100,DA=PSADRG D ^DIC K DIC,DLAYGO
"RTN","PSAVER6",110,0)
 .K DIC,DA,DR,DIE
"RTN","PSAVER6",111,0)
 .S DA=+Y,DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DR="3////^S X=$G(PSABAL)" D ^DIE K DIE
"RTN","PSAVER6",112,0)
 K DIC,DA,DR,DIE
"RTN","PSAVER6",113,0)
 S DA=$E(DT,1,5)*100
"RTN","PSAVER6",114,0)
 S DA(2)=PSALOC,DA(1)=PSADRG,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",5,",DA=$E(DT,1,5)*100,DR="3////^S X=($G(PSABAL)+$G(PSADUREC));5////^S X="_($P($G(^(0)),"^",3)+PSADUREC) D ^DIE K DIE
"RTN","PSAVER6",115,0)
 L -^PSD(58.8,PSALOC,1,PSADRG,0)
"RTN","PSAVER6",116,0)
 G TR^PSAVER7
"RTN","PSAVER6",117,0)
MM ;
"RTN","PSAVER6",118,0)
 ;*42 Mail Message to holders of PSDMGR, PSAMGR key
"RTN","PSAVER6",119,0)
 ;*53 Consolidate messages
"RTN","PSAVER6",120,0)
 N PSACS S PSACS=$S($$GET1^DIQ(50,PSADRG,63)["N":" Controlled Substance ",1:"")
"RTN","PSAVER6",121,0)
 S ^TMP($J,"PSADD",$$GET1^DIQ(58.8,PSALOC,.01),$$GET1^DIQ(50,PSADRG,.01))=""
"RTN","PSAVER6",122,0)
 Q
"RTN","PSAVER6",123,0)
SCANDIF ;*42 inspect invoice for noted differences in OU,DUOU,PPDU,NDC
"RTN","PSAVER6",124,0)
 ;NEEDS PSAIEN, PSAIEN1
"RTN","PSAVER6",125,0)
 K ^TMP($J,"PSADIF"),PSADIFLC
"RTN","PSAVER6",126,0)
 S PSALINE=0 F  S PSALINE=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE)) Q:PSALINE'>0  D CHECK^PSAPROC7 ;checks and stores differences in ^TMP($J,
"RTN","PSAVER6",127,0)
 I $D(^TMP($J,"PSADD")) D ADDMM
"RTN","PSAVER6",128,0)
 I $D(^TMP($J,"PSADIF")) D MESSAGE
"RTN","PSAVER6",129,0)
 Q
"RTN","PSAVER6",130,0)
MESSAGE ;differences found, notify user and send message to g.PSA NDC UPDATES.
"RTN","PSAVER6",131,0)
 K DIR N IENS
"RTN","PSAVER6",132,0)
 S PSAORD=$$GET1^DIQ(58.811,PSAIEN,.01),IENS=PSAIEN1_","_PSAIEN
"RTN","PSAVER6",133,0)
 S PSAINV=$$GET1^DIQ(58.8112,IENS,.01)
"RTN","PSAVER6",134,0)
 S XMSUB="POST Verify  Variance Report Ord: "_PSAORD_" Inv: "_PSAINV ;*52
"RTN","PSAVER6",135,0)
 S ^TMP($J,"PSADIF",1,0)=XMSUB,^TMP($J,"PSADIF",2,0)=" "
"RTN","PSAVER6",136,0)
 S XMTEXT="^TMP($J,""PSADIF"",",XMY("G.PSA NDC UPDATES")=""
"RTN","PSAVER6",137,0)
 S XMDUZ="Price & NDC Updater"
"RTN","PSAVER6",138,0)
 D ^XMD
"RTN","PSAVER6",139,0)
 K PSADIFLC,^TMP($J,"PSADIF")
"RTN","PSAVER6",140,0)
 Q
"RTN","PSAVER6",141,0)
ADDMM ; SEND MESSAGE REGARDING DRUGS ADDED TO PHARMACY LOCATIONS
"RTN","PSAVER6",142,0)
 K ^TMP($J,"PSADDMM")
"RTN","PSAVER6",143,0)
 S XMSUB="New Drugs Added by Order: "_$G(PSAORD)_" Invoice: "_$G(PSAINV)
"RTN","PSAVER6",144,0)
 S XMDUZ="Verified by: "_$$GET1^DIQ(200,DUZ,.01)
"RTN","PSAVER6",145,0)
 S LC=0,X=XMSUB D MMLINE S X=XMDUZ D MMLINE
"RTN","PSAVER6",146,0)
 S X="Please use DA and CS menus to populate the balances, stock and re-order levels." D MMLINE
"RTN","PSAVER6",147,0)
 S PSALOC="" F  S PSALOC=$O(^TMP($J,"PSADD",PSALOC)) Q:PSALOC=""  D
"RTN","PSAVER6",148,0)
 . S X=PSALOC D MMLINE
"RTN","PSAVER6",149,0)
 . S PSADRG="" F  S PSADRG=$O(^TMP($J,"PSADD",PSALOC,PSADRG)) Q:PSADRG=""  S X="     "_PSADRG D MMLINE
"RTN","PSAVER6",150,0)
 S XMTEXT="^TMP($J,""PSADDMM"","
"RTN","PSAVER6",151,0)
 S XMY("G.PSA NDC UPDATES")=""
"RTN","PSAVER6",152,0)
 D ^XMD
"RTN","PSAVER6",153,0)
 K ^TMP($J,"PSADD"),^TMP($J,"PSADDMM"),LC
"RTN","PSAVER6",154,0)
 Q
"RTN","PSAVER6",155,0)
MMLINE S LC=LC+1,^TMP($J,"PSADDMM",LC,0)=X W !,X Q
"RTN","PSAVERA1")
0^4^B25757981^B25758027
"RTN","PSAVERA1",1,0)
PSAVERA1 ;BHM/DB - Edit previously verified invoices;16NOV99
"RTN","PSAVERA1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**21,61**; 10/24/97;Build 1
"RTN","PSAVERA1",3,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAVERA1",4,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAVERA1",5,0)
 ;
"RTN","PSAVERA1",6,0)
 S $P(PSASLN,"=",79)="" K PSALINE
"RTN","PSAVERA1",7,0)
DISPLN S PSALINE=$S('$D(PSALINE):$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,0)),1:$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE))) G Q:PSALINE'>0 S CNT=$G(CNT)+1
"RTN","PSAVERA1",8,0)
 S PSADATA=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVERA1",9,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAVERA1",10,0)
 S PSAVSN=$P(PSADATA,"^",12),PSAOUT=0
"RTN","PSAVERA1",11,0)
DRUG S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAVERA1",12,0)
 I $G(PSADJ) D
"RTN","PSAVERA1",13,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVERA1",14,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVERA1",15,0)
 .S PSASUP=$S(PSADJD'?1.N:1,1:0)
"RTN","PSAVERA1",16,0)
 .S PSADRG=$S(PSADJ&('PSASUP):$G(PSADJD),PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAVERA1",17,0)
 .I $G(PSADJD),$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" S (PSADRG,PSA50IEN)=+PSADJD Q
"RTN","PSAVERA1",18,0)
 .I $G(PSADJD),$L(PSADJD)=$L(+PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAVERA1",19,0)
 .S PSADJSUP=1,(PSADRG,PSA50IEN)=PSADJD
"RTN","PSAVERA1",20,0)
 I '$G(PSADJ) D
"RTN","PSAVERA1",21,0)
 .S (PSA50IEN,PSADRG)=$S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):+$P(PSADATA,"^",2),1:0)
"RTN","PSAVERA1",22,0)
 S PSADRUGN=$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P($G(^PSDRUG(PSADRG,0)),"^"),1:"Unknown Drug Name")
"RTN","PSAVERA1",23,0)
QTY ;Quantity
"RTN","PSAVERA1",24,0)
 ;No Adj. Qty
"RTN","PSAVERA1",25,0)
 S PSADJQ="",PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAVERA1",26,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVERA1",27,0)
 ;Adj. Qty
"RTN","PSAVERA1",28,0)
 I $G(PSADJQ) S PSAQTY=PSADJQ
"RTN","PSAVERA1",29,0)
 I '$G(PSADJQ) S PSAQTY=$P(PSADATA,"^",3)
"RTN","PSAVERA1",30,0)
UPC S:$P(PSADATA,"^",13) PSAUPC=$P(PSADATA,"^",13)
"RTN","PSAVERA1",31,0)
OU ;W !,"Order Unit  : "
"RTN","PSAVERA1",32,0)
 S PSAOU=$S(+$P(PSADATA,"^",4)&($P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^")'=""):+$P(PSADATA,"^",4),1:"")
"RTN","PSAVERA1",33,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAVERA1",34,0)
 I +$P(PSATEMP,"^",3),PSADRG,+$P($G(^PSDRUG(PSADRG,1,+$P(PSATEMP,"^",3),0)),"^",5) S PSAOU=+$P(^PSDRUG(PSADRG,1,+$P(PSATEMP,"^",3),0),"^",5)
"RTN","PSAVERA1",35,0)
 S PSADJO="",PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAVERA1",36,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAVERA1",37,0)
 ;Adj. Order Unit
"RTN","PSAVERA1",38,0)
 I PSADJO'="" S PSAOU=+PSADJO
"RTN","PSAVERA1",39,0)
 I PSADJO="" ;W $S(+PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"Blank")
"RTN","PSAVERA1",40,0)
 ;
"RTN","PSAVERA1",41,0)
NDC S PSANDC=$P(PSADATA,"^",11)
"RTN","PSAVERA1",42,0)
 ;I $E(PSANDC)'="S" W ?38,"NDC: "_$S(PSANDC'="":$E(PSANDC,1,6)_"-"_$E(PSANDC,7,10)_"-"_$E(PSANDC,11,12),1:"Blank")
"RTN","PSAVERA1",43,0)
 ;
"RTN","PSAVERA1",44,0)
PRICE ;W !,"Unit Price  : $"
"RTN","PSAVERA1",45,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAVERA1",46,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAVERA1",47,0)
 ;Adj. Unit Price
"RTN","PSAVERA1",48,0)
 I $G(PSADJP) D
"RTN","PSAVERA1",49,0)
 .I $L($P(PSADJP,".",2))<2 S PSADJP=$P(PSADJP,".")_"."_$P(PSADJP,".",2)_$E("00",1,(2-$L($P(PSADJP,".",2))))
"RTN","PSAVERA1",50,0)
 .;W $FN(PSADJP,",")_" ($"_$S(+$P(PSADATA,"^",5):$FN($P(PSADATA,"^",5),","),$P(PSADATA,"^",5)=0:"0.00",1:"")_")"
"RTN","PSAVERA1",51,0)
 .S PSAPRICE=PSADJP
"RTN","PSAVERA1",52,0)
 I '$G(PSADJP) D
"RTN","PSAVERA1",53,0)
 .S PSAPRICE=+$P(PSADATA,"^",5)
"RTN","PSAVERA1",54,0)
 .;I $G(PSAPRICE)!(PSAPRICE=0) W $S($G(PSAPRICE):PSAPRICE,1:"0.00") Q
"RTN","PSAVERA1",55,0)
 .;W "Blank"
"RTN","PSAVERA1",56,0)
 ;
"RTN","PSAVERA1",57,0)
VSN ;W ?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAVERA1",58,0)
VDU S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVERA1",59,0)
 S INVARRAY(PSAORD,PSAINV,PSALINE)=$G(PSADRG)_"~"_$G(PSADRUGN)_"^"_$G(PSAQTY)_"^"_$G(PSALOC)_"^"_$G(PSAOU)_"^"_$G(PSANDC)_"^"_$G(PSAPRICE)_"^"_$G(PSAVSN)_"^"_$G(PSAUPC)
"RTN","PSAVERA1",60,0)
 ;
"RTN","PSAVERA1",61,0)
 I '+$P($G(^PSD(58.8,+PSALOC,0)),"^",14) G DISPLN
"RTN","PSAVERA1",62,0)
 ;
"RTN","PSAVERA1",63,0)
STOCK S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",3),1:"Blank")
"RTN","PSAVERA1",64,0)
REORDER S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",5),1:"Blank")
"RTN","PSAVERA1",65,0)
 S INVARRAY(PSAORD,PSAINV,PSALINE)=$G(INVARRAY(PSAORD,PSAINV,PSALINE))_"^"_$G(PSASTOCK)_"^"_$G(PSAREORD)
"RTN","PSAVERA1",66,0)
 G DISPLN
"RTN","PSAVERA1",67,0)
ASK R !!,"Enter an '^' to abort, <RET> to continue, or a corresponding line item number: ",AN:DTIME I AN="" G DISPLN
"RTN","PSAVERA1",68,0)
 I AN["^" G Q
"RTN","PSAVERA1",69,0)
 I AN<0!(AN>CNT) W !,"Enter a number between 1 and ",CNT G ASK
"RTN","PSAVERA1",70,0)
 S (PSALINE,PSALINEN)=AN
"RTN","PSAVERA1",71,0)
PROCSS I '$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0)) W !,"Invalid line number." G ASK
"RTN","PSAVERA1",72,0)
 S PSADATA=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),PSASUP=0
"RTN","PSAVERA1",73,0)
 S PSANDC=$P(PSADATA,"^",11),PSAVSN=$P(PSADATA,"^",12),PSALOC=$S($P(PSADATA,"^",10):+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",5))
"RTN","PSAVERA1",74,0)
VIEW S PSALINEN=" " D VERDISP^PSAUTL4 W !,PSASLN,!
"RTN","PSAVERA1",75,0)
 W "1. Drug",!,"2. Order Unit",! S PSACHO=2
"RTN","PSAVERA1",76,0)
 S DIR(0)="LO^1:"_PSACHO,DIR("A")="Edit fields",DIR("?")="Enter the number(s) of the data to be edited" S DIR("??")="^D DDQOR^PSAVER3"
"RTN","PSAVERA1",77,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVERA1",78,0)
 Q:Y=""  S PSAFLDS=Y,PSASET=0 ;D VERDISP^PSAUTL4 W PSASLN
"RTN","PSAVERA1",79,0)
FIELDS F PSAPCF=1:1 S PSAFLD=$P(PSAFLDS,",",PSAPCF) Q:'PSAFLD!(PSAOUT)  D
"RTN","PSAVERA1",80,0)
 .I PSAFLD=1 D ASKDRUG^PSAVERA2 Q
"RTN","PSAVERA1",81,0)
 .I PSAFLD=2 D OU^PSAVER2 Q
"RTN","PSAVERA1",82,0)
Q Q
"VER")
8.0^22.0
**END**
**END**
