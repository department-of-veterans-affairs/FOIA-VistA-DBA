Released IBD*3*25 SEQ #22
Extracted from mail message
**KIDS**:IBD*3.0*25^

**INSTALL NAME**
IBD*3.0*25
"BLD",909,0)
IBD*3.0*25^AUTOMATED INFO COLLECTION SYS^0^2980520^y
"BLD",909,1,0)
^^5^5^2980520^
"BLD",909,1,1,0)
This patch comprises a change to the recognition of encounter form anchors.
"BLD",909,1,2,0)
It includes a new routine that causes the formspec files that do the actual
"BLD",909,1,3,0)
recognition to function correctly.  We used to use all 4 anchors printed one
"BLD",909,1,4,0)
in each corner.  With this new functionality we will first use the left pair
"BLD",909,1,5,0)
of anchors and if those aren't found we will use the right pair.
"BLD",909,4,0)
^9.64PA^359.3^2
"BLD",909,4,357.09,0)
357.09
"BLD",909,4,357.09,2,0)
^9.641^357.09^1
"BLD",909,4,357.09,2,357.09,0)
ENCOUNTER FORM PARAMETERS  (File-top level)
"BLD",909,4,357.09,2,357.09,1,0)
^9.6411^.14^3
"BLD",909,4,357.09,2,357.09,1,.12,0)
REDUCE HANDPRINT RECOGNITION SIZE
"BLD",909,4,357.09,2,357.09,1,.13,0)
DARKNESS OF DOTS
"BLD",909,4,357.09,2,357.09,1,.14,0)
CLOSENESS OF DOTS
"BLD",909,4,357.09,222)
y^n^p^^^^n^^
"BLD",909,4,359.3,0)
359.3
"BLD",909,4,359.3,2,0)
^9.641^359.3^1
"BLD",909,4,359.3,2,359.3,0)
AICS ERROR AND WARNING LOG  (File-top level)
"BLD",909,4,359.3,2,359.3,1,0)
^9.6411^9^3
"BLD",909,4,359.3,2,359.3,1,.17,0)
PAGE
"BLD",909,4,359.3,2,359.3,1,.18,0)
WORKSTATION ID
"BLD",909,4,359.3,2,359.3,1,9,0)
CLINIC
"BLD",909,4,359.3,222)
y^n^p^^^^n^^
"BLD",909,4,"APDD",357.09,357.09)

"BLD",909,4,"APDD",357.09,357.09,.12)

"BLD",909,4,"APDD",357.09,357.09,.13)

"BLD",909,4,"APDD",357.09,357.09,.14)

"BLD",909,4,"APDD",359.3,359.3)

"BLD",909,4,"APDD",359.3,359.3,.17)

"BLD",909,4,"APDD",359.3,359.3,.18)

"BLD",909,4,"APDD",359.3,359.3,9)

"BLD",909,4,"B",357.09,357.09)

"BLD",909,4,"B",359.3,359.3)

"BLD",909,"ABPKG")
n
"BLD",909,"INIT")
IBDY325
"BLD",909,"KRN",0)
^9.67PA^19^18
"BLD",909,"KRN",.4,0)
.4
"BLD",909,"KRN",.401,0)
.401
"BLD",909,"KRN",.402,0)
.402
"BLD",909,"KRN",.403,0)
.403
"BLD",909,"KRN",.5,0)
.5
"BLD",909,"KRN",.84,0)
.84
"BLD",909,"KRN",.84,"NM",0)
^9.68A^1^1
"BLD",909,"KRN",.84,"NM",1,0)
3579612^^0
"BLD",909,"KRN",.84,"NM","B",3579612,1)

"BLD",909,"KRN",3.6,0)
3.6
"BLD",909,"KRN",3.8,0)
3.8
"BLD",909,"KRN",9.2,0)
9.2
"BLD",909,"KRN",9.8,0)
9.8
"BLD",909,"KRN",9.8,"NM",0)
^9.68A^23^18
"BLD",909,"KRN",9.8,"NM",1,0)
IBDFBKS1^^0^B81662054
"BLD",909,"KRN",9.8,"NM",2,0)
IBDFBKS2^^0^B78017855
"BLD",909,"KRN",9.8,"NM",3,0)
IBDFESP^^0^B8077950
"BLD",909,"KRN",9.8,"NM",4,0)
IBDF2F^^0^B61324428
"BLD",909,"KRN",9.8,"NM",5,0)
IBDFRPC6^^0^B55319457
"BLD",909,"KRN",9.8,"NM",6,0)
IBDFBKS4^^0^B22083850
"BLD",909,"KRN",9.8,"NM",7,0)
IBDFBKS^^0^B49485041
"BLD",909,"KRN",9.8,"NM",8,0)
IBDF1B1A^^0^B25624007
"BLD",909,"KRN",9.8,"NM",9,0)
IBDF1BA^^0^B19503335
"BLD",909,"KRN",9.8,"NM",10,0)
IBDFN8^^0^B485517
"BLD",909,"KRN",9.8,"NM",11,0)
IBDFM1^^0^B41030043
"BLD",909,"KRN",9.8,"NM",12,0)
IBDF14A^^0^B18485443
"BLD",909,"KRN",9.8,"NM",16,0)
IBDF18E0^^0^B31373655
"BLD",909,"KRN",9.8,"NM",17,0)
IBDF18E2^^0^B19295756
"BLD",909,"KRN",9.8,"NM",18,0)
IBDF18E^^0^B38836989
"BLD",909,"KRN",9.8,"NM",21,0)
IBDF2H^^0^B1836800
"BLD",909,"KRN",9.8,"NM",22,0)
IBDFRPC1^^0^B18235050
"BLD",909,"KRN",9.8,"NM",23,0)
IBDFN3^^0^B5536651
"BLD",909,"KRN",9.8,"NM","B","IBDF14A",12)

"BLD",909,"KRN",9.8,"NM","B","IBDF18E",18)

"BLD",909,"KRN",9.8,"NM","B","IBDF18E0",16)

"BLD",909,"KRN",9.8,"NM","B","IBDF18E2",17)

"BLD",909,"KRN",9.8,"NM","B","IBDF1B1A",8)

"BLD",909,"KRN",9.8,"NM","B","IBDF1BA",9)

"BLD",909,"KRN",9.8,"NM","B","IBDF2F",4)

"BLD",909,"KRN",9.8,"NM","B","IBDF2H",21)

"BLD",909,"KRN",9.8,"NM","B","IBDFBKS",7)

"BLD",909,"KRN",9.8,"NM","B","IBDFBKS1",1)

"BLD",909,"KRN",9.8,"NM","B","IBDFBKS2",2)

"BLD",909,"KRN",9.8,"NM","B","IBDFBKS4",6)

"BLD",909,"KRN",9.8,"NM","B","IBDFESP",3)

"BLD",909,"KRN",9.8,"NM","B","IBDFM1",11)

"BLD",909,"KRN",9.8,"NM","B","IBDFN3",23)

"BLD",909,"KRN",9.8,"NM","B","IBDFN8",10)

"BLD",909,"KRN",9.8,"NM","B","IBDFRPC1",22)

"BLD",909,"KRN",9.8,"NM","B","IBDFRPC6",5)

"BLD",909,"KRN",19,0)
19
"BLD",909,"KRN",19.1,0)
19.1
"BLD",909,"KRN",101,0)
101
"BLD",909,"KRN",409.61,0)
409.61
"BLD",909,"KRN",771,0)
771
"BLD",909,"KRN",869.2,0)
869.2
"BLD",909,"KRN",870,0)
870
"BLD",909,"KRN",8994,0)
8994
"BLD",909,"KRN",8994,"NM",0)
^9.68A^^0
"BLD",909,"KRN","B",.4,.4)

"BLD",909,"KRN","B",.401,.401)

"BLD",909,"KRN","B",.402,.402)

"BLD",909,"KRN","B",.403,.403)

"BLD",909,"KRN","B",.5,.5)

"BLD",909,"KRN","B",.84,.84)

"BLD",909,"KRN","B",3.6,3.6)

"BLD",909,"KRN","B",3.8,3.8)

"BLD",909,"KRN","B",9.2,9.2)

"BLD",909,"KRN","B",9.8,9.8)

"BLD",909,"KRN","B",19,19)

"BLD",909,"KRN","B",19.1,19.1)

"BLD",909,"KRN","B",101,101)

"BLD",909,"KRN","B",409.61,409.61)

"BLD",909,"KRN","B",771,771)

"BLD",909,"KRN","B",869.2,869.2)

"BLD",909,"KRN","B",870,870)

"BLD",909,"KRN","B",8994,8994)

"BLD",909,"PRE")

"BLD",909,"QUES",0)
^9.62^^0
"BLD",909,"REQB",0)
^9.611^4^4
"BLD",909,"REQB",1,0)
AUTOMATED INFO COLLECTION SYS 3.0^1
"BLD",909,"REQB",2,0)
IBD*3.0*3^1
"BLD",909,"REQB",3,0)
IBD*3.0*11^1
"BLD",909,"REQB",4,0)
IBD*3.0*15^1
"BLD",909,"REQB","B","AUTOMATED INFO COLLECTION SYS 3.0",1)

"BLD",909,"REQB","B","IBD*3.0*11",3)

"BLD",909,"REQB","B","IBD*3.0*15",4)

"BLD",909,"REQB","B","IBD*3.0*3",2)

"FIA",357.09)
ENCOUNTER FORM PARAMETERS
"FIA",357.09,0)
^IBD(357.09,
"FIA",357.09,0,0)
357.09
"FIA",357.09,0,1)
y^n^p^^^^n^^
"FIA",357.09,0,10)

"FIA",357.09,0,11)

"FIA",357.09,0,"RLRO")

"FIA",357.09,0,"VR")
3.0^IBD
"FIA",357.09,357.09)
1
"FIA",357.09,357.09,.12)

"FIA",357.09,357.09,.13)

"FIA",357.09,357.09,.14)

"FIA",359.3)
AICS ERROR AND WARNING LOG
"FIA",359.3,0)
^IBD(359.3,
"FIA",359.3,0,0)
359.3DIAO
"FIA",359.3,0,1)
y^n^p^^^^n^^
"FIA",359.3,0,10)

"FIA",359.3,0,11)

"FIA",359.3,0,"RLRO")

"FIA",359.3,0,"VR")
3.0^IBD
"FIA",359.3,359.3)
1
"FIA",359.3,359.3,.17)

"FIA",359.3,359.3,.18)

"FIA",359.3,359.3,9)

"INIT")
IBDY325
"KRN",.84,3579612,-1)
0^1
"KRN",.84,3579612,0)
3579612^1^y^AUTOMATED INFO COLLECTION SYS^OTHER BUBBLE BUT NO DATA
"KRN",.84,3579612,1,0)
^^3^3^2990318^^^^
"KRN",.84,3579612,1,1,0)
During scanning, AICS attempted to pass a procedure node that was the result
"KRN",.84,3579612,1,2,0)
of an other bubble being entered.  However, there was no procedure or narrative
"KRN",.84,3579612,1,3,0)
entered.
"KRN",.84,3579612,2,0)
^^6^6^2990318^^^^
"KRN",.84,3579612,2,1,0)
SCANNING ERROR: AICS was unable to store Procedure Data in PCE for Form ID: |5|.  Error Code 3579612.
"KRN",.84,3579612,2,2,0)

"KRN",.84,3579612,2,3,0)
During scanning of Form ID |5| for patient |2| encounter 
"KRN",.84,3579612,2,4,0)
date |3| AICS received PROCEDURE data that was the 
"KRN",.84,3579612,2,5,0)
result of an "Other" bubble being checked, however, no Procedure
"KRN",.84,3579612,2,6,0)
Code or Narrative was entered.
"KRN",.84,3579612,3,0)
^.845^4^4
"KRN",.84,3579612,3,1,0)
2^Patient
"KRN",.84,3579612,3,2,0)
3^Encounter date/time
"KRN",.84,3579612,3,3,0)
5^Form ID
"KRN",.84,3579612,3,4,0)
17^Page
"KRN",.84,3579612,5,0)
^.841^1^1
"KRN",.84,3579612,5,1,0)
IBDF18E0^OTHRBUB
"KRN",.84,3579612,5,"B","IBDF18E0",1)

"MBREQ")
0
"ORD",9,.84)
.84;9;;;EDEOUT^DIFROMSO(.84,DA,"",XPDA);FPRE^DIFROMSI(.84,"",XPDA);EPRE^DIFROMSI(.84,DA,"",XPDA,"",OLDA);;EPOST^DIFROMSI(.84,DA,"",XPDA);DEL^DIFROMSK(.84,"",%)
"ORD",9,.84,0)
DIALOG
"PKG",421,-1)
1^1
"PKG",421,0)
AUTOMATED INFO COLLECTION SYS^IBD^The utilities for generating a paper encounter form.
"PKG",421,20,0)
^9.402P^^
"PKG",421,22,0)
^9.49I^1^1
"PKG",421,22,1,0)
3.0^2970212^2970424^1258
"PKG",421,22,1,"PAH",1,0)
25^2980520^1453
"PKG",421,22,1,"PAH",1,1,0)
^^5^5^2990326
"PKG",421,22,1,"PAH",1,1,1,0)
This patch comprises a change to the recognition of encounter form anchors.
"PKG",421,22,1,"PAH",1,1,2,0)
It includes a new routine that causes the formspec files that do the actual
"PKG",421,22,1,"PAH",1,1,3,0)
recognition to function correctly.  We used to use all 4 anchors printed one
"PKG",421,22,1,"PAH",1,1,4,0)
in each corner.  With this new functionality we will first use the left pair
"PKG",421,22,1,"PAH",1,1,5,0)
of anchors and if those aren't found we will use the right pair.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
19
"RTN","IBDF14A")
0^12^B18485443
"RTN","IBDF14A",1,0)
IBDF14A ;ALB/CJM - AICS LIST CLINIC SETUP ; JUL 20,1993
"RTN","IBDF14A",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**25**;APR 24, 1997
"RTN","IBDF14A",3,0)
 ;
"RTN","IBDF14A",4,0)
% ; -- entry point from ibdf14
"RTN","IBDF14A",5,0)
 I '$D(VAUTD) G ^IBDF14
"RTN","IBDF14A",6,0)
 D CLINICS,PRINT
"RTN","IBDF14A",7,0)
 Q
"RTN","IBDF14A",8,0)
 ;
"RTN","IBDF14A",9,0)
CLINICS ; -- get a list of clinics with setups defined
"RTN","IBDF14A",10,0)
 S CNT=0
"RTN","IBDF14A",11,0)
 S CLINIC="" F  S CLINIC=$O(^SD(409.95,"B",CLINIC)) Q:'CLINIC  D
"RTN","IBDF14A",12,0)
 .S SETUP=$O(^SD(409.95,"B",CLINIC,""))
"RTN","IBDF14A",13,0)
 .S NAME=$P($G(^SC(CLINIC,0)),"^")
"RTN","IBDF14A",14,0)
 .S DIVIS=$P($G(^SC(CLINIC,0)),"^",15)
"RTN","IBDF14A",15,0)
 .I DIVIS="" S DIVIS=$S(MULTI=0:$$PRIM^VASITE,MULTI=1:"Unknown",1:1)
"RTN","IBDF14A",16,0)
 .I 'VAUTD,'$D(VAUTD(DIVIS)) Q  ;if not all divisions or select div.
"RTN","IBDF14A",17,0)
 .S:+DIVIS DIVIS=$P($G(^DG(40.8,+DIVIS,0)),"^")
"RTN","IBDF14A",18,0)
 .I DIVIS="" S DIVIS="Unknown"
"RTN","IBDF14A",19,0)
 .S:NAME]"" ^TMP($J,"IBCS",DIVIS,NAME)=CLINIC_"^"_SETUP,CNT(DIVIS)=$G(CNT(DIVIS))+1
"RTN","IBDF14A",20,0)
 Q
"RTN","IBDF14A",21,0)
 ;
"RTN","IBDF14A",22,0)
PRINT ; -- Main print driver for output
"RTN","IBDF14A",23,0)
 W:$E(IOST,1,2)="C-" @IOF
"RTN","IBDF14A",24,0)
 S NEWDIV=0
"RTN","IBDF14A",25,0)
 S DIVIS="" F  S DIVIS=$O(^TMP($J,"IBCS",DIVIS)) Q:DIVIS=""!IBQUIT  S NEWDIV=1 D
"RTN","IBDF14A",26,0)
 .S NAME="" F  S NAME=$O(^TMP($J,"IBCS",DIVIS,NAME)) Q:NAME=""!IBQUIT  S CLINIC=+^(NAME),SETUP=$P(^(NAME),"^",2) D  Q:IBQUIT
"RTN","IBDF14A",27,0)
 ..Q:'SETUP
"RTN","IBDF14A",28,0)
 ..I $G(NEWDIV) D HEADER Q:IBQUIT  W !?9,"Division: ",DIVIS,! S NEWDIV=0
"RTN","IBDF14A",29,0)
 ..I ($Y>(IOSL-3)) D HEADER Q:IBQUIT
"RTN","IBDF14A",30,0)
 ..W !,"Clinic: ",NAME I '$$ACLN^IBDFCNOF(CLINIC) W "    (Clinic Currently Inactive)"
"RTN","IBDF14A",31,0)
 ..D FORMS Q:IBQUIT
"RTN","IBDF14A",32,0)
 ..D REPORTS Q:IBQUIT
"RTN","IBDF14A",33,0)
 ..D EXCLUDE Q:IBQUIT
"RTN","IBDF14A",34,0)
 ..W !
"RTN","IBDF14A",35,0)
 .I 'VAUTD,$G(CNT(DIVIS))<1 D HEADER W !,"No clinics found for division '",DIVIS,"'",!
"RTN","IBDF14A",36,0)
 I $E(IOST,1,2)="C-",'IBQUIT D PAUSE
"RTN","IBDF14A",37,0)
 Q
"RTN","IBDF14A",38,0)
 ;
"RTN","IBDF14A",39,0)
FORMS ; -- prints the clinic's encounter forms to the report
"RTN","IBDF14A",40,0)
 S NODE=$G(^SD(409.95,SETUP,0))
"RTN","IBDF14A",41,0)
 I ($Y>(IOSL-3)) D HEADER Q:IBQUIT
"RTN","IBDF14A",42,0)
 S FORM=$P(NODE,"^",2) I FORM W !,?5,"BASIC DEFAULT FORM:  ..........................",$P($G(^IBE(357,FORM,0)),"^")
"RTN","IBDF14A",43,0)
 S FORM=$P(NODE,"^",5) I FORM W !,?5,"FORM WITH NO PRE-PRINTED PATIENT DATA:  .......",$P($G(^IBE(357,FORM,0)),"^")
"RTN","IBDF14A",44,0)
 I ($Y>(IOSL-3)) D HEADER Q:IBQUIT
"RTN","IBDF14A",45,0)
 S FORM=$P(NODE,"^",3) I FORM W !,?5,"SUPPLEMENTAL FORM - PATIENT WITH PRIOR VISITS: ",$P($G(^IBE(357,FORM,0)),"^")
"RTN","IBDF14A",46,0)
 I ($Y>(IOSL-3)) D HEADER Q:IBQUIT
"RTN","IBDF14A",47,0)
 S FORM=$P(NODE,"^",4) I FORM W !,?5,"SUPPLEMENTAL FORM - FIRST TIME PATIENT:  ......",$P($G(^IBE(357,FORM,0)),"^")
"RTN","IBDF14A",48,0)
 I ($Y>(IOSL-3)) D HEADER Q:IBQUIT
"RTN","IBDF14A",49,0)
 S FORM=$P(NODE,"^",6) I FORM W !,?5,"SUPPLEMENTAL FORM - ALL PATIENTS:  ............",$P($G(^IBE(357,FORM,0)),"^")
"RTN","IBDF14A",50,0)
 I ($Y>(IOSL-3)) D HEADER Q:IBQUIT
"RTN","IBDF14A",51,0)
 S FORM=$P(NODE,"^",8) I FORM W !,?5,"SUPPLEMENTAL FORM - ALL PATIENTS:  ............",$P($G(^IBE(357,FORM,0)),"^")
"RTN","IBDF14A",52,0)
 I ($Y>(IOSL-3)) D HEADER Q:IBQUIT
"RTN","IBDF14A",53,0)
 S FORM=$P(NODE,"^",9) I FORM W !,?5,"SUPPLEMENTAL FORM - ALL PATIENTS:  ............",$P($G(^IBE(357,FORM,0)),"^")
"RTN","IBDF14A",54,0)
 I ($Y>(IOSL-3)) D HEADER Q:IBQUIT
"RTN","IBDF14A",55,0)
 S FORM=$P(NODE,"^",7) I FORM W !,?5,"RESERVED FOR FUTURE USE:  .....................",$P($G(^IBE(357,FORM,0)),"^")
"RTN","IBDF14A",56,0)
 Q
"RTN","IBDF14A",57,0)
 ;
"RTN","IBDF14A",58,0)
REPORTS ; -- prints the clinic's reports
"RTN","IBDF14A",59,0)
 Q:'$O(^SD(409.95,SETUP,1,0))
"RTN","IBDF14A",60,0)
 I ($Y>(IOSL-5)) D HEADER Q:IBQUIT
"RTN","IBDF14A",61,0)
 W !!,?5,"REPORTS",?50,"PRINT CONDITION",!,?5,"=======",?50,"==============="
"RTN","IBDF14A",62,0)
 S REPORT=0 F  S REPORT=$O(^SD(409.95,SETUP,1,REPORT)) Q:'REPORT  D  Q:IBQUIT
"RTN","IBDF14A",63,0)
 .I ($Y>(IOSL-3)) D HEADER Q:IBQUIT
"RTN","IBDF14A",64,0)
 .S NODE=$G(^SD(409.95,SETUP,1,REPORT,0))
"RTN","IBDF14A",65,0)
 .S INTRFACE=$P(NODE,"^"),COND=$P(NODE,"^",2)
"RTN","IBDF14A",66,0)
 .I INTRFACE,COND S INTRFACE=$P($G(^IBE(357.6,INTRFACE,0)),"^"),COND=$P($G(^IBE(357.92,COND,0)),"^") W:INTRFACE]"" !,?5,INTRFACE,?50,COND
"RTN","IBDF14A",67,0)
 Q
"RTN","IBDF14A",68,0)
 ;
"RTN","IBDF14A",69,0)
EXCLUDE ; -- prints the division reports excluded from clinic
"RTN","IBDF14A",70,0)
 Q:'$O(^SD(409.95,SETUP,2,0))
"RTN","IBDF14A",71,0)
 I ($Y>(IOSL-5)) D HEADER Q:IBQUIT
"RTN","IBDF14A",72,0)
 W !!,?5,"EXCLUDED REPORTS",!,?5,"================"
"RTN","IBDF14A",73,0)
 S REPORT=0 F  S REPORT=$O(^SD(409.95,SETUP,2,REPORT)) Q:'REPORT  D  Q:IBQUIT
"RTN","IBDF14A",74,0)
 .I ($Y>(IOSL-3)) D HEADER Q:IBQUIT
"RTN","IBDF14A",75,0)
 .S NODE=$G(^SD(409.95,SETUP,2,REPORT,0))
"RTN","IBDF14A",76,0)
 .S INTRFACE=$P(NODE,"^")
"RTN","IBDF14A",77,0)
 .I INTRFACE S INTRFACE=$P($G(^IBE(357.6,INTRFACE,0)),"^") W:INTRFACE]"" !,?5,INTRFACE
"RTN","IBDF14A",78,0)
 Q
"RTN","IBDF14A",79,0)
 ;
"RTN","IBDF14A",80,0)
HEADER ; -- writes the report header
"RTN","IBDF14A",81,0)
 I $E(IOST,1,2)="C-",$Y>1,PAGE>1 D PAUSE Q:IBQUIT
"RTN","IBDF14A",82,0)
 I PAGE>1 W @IOF
"RTN","IBDF14A",83,0)
 W !,"AICS Print Manager Clinic Setup Report",?IOM-32,IBHDT,"   PAGE ",PAGE
"RTN","IBDF14A",84,0)
 W !,"For Division: ",DIVIS
"RTN","IBDF14A",85,0)
 W !,$TR($J(" ",IOM)," ","-")
"RTN","IBDF14A",86,0)
 S PAGE=PAGE+1
"RTN","IBDF14A",87,0)
 Q
"RTN","IBDF14A",88,0)
 ;
"RTN","IBDF14A",89,0)
PAUSE ; -- hold screen
"RTN","IBDF14A",90,0)
 N DIR,X,Y
"RTN","IBDF14A",91,0)
 F  Q:$Y>(IOSL-2)  W !
"RTN","IBDF14A",92,0)
 S DIR(0)="E" D ^DIR S IBQUIT=$S(+Y:0,1:1)
"RTN","IBDF14A",93,0)
 Q
"RTN","IBDF18E")
0^18^B38836989
"RTN","IBDF18E",1,0)
IBDF18E ;ALB/CJM - ENCOUNTER FORM - PCE DEVICE INTERFACE utilities ;04-OCT-94
"RTN","IBDF18E",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3,25**;APR 24, 1997
"RTN","IBDF18E",3,0)
 ;
"RTN","IBDF18E",4,0)
SEND(FORMID,PROVIDER,PROVTYPE,BUBBLES,HANDPRNT,CHECKOUT,PXCA,DYNAMIC) ;builds the PCXA array and passes it to PCE, updates form tracking status
"RTN","IBDF18E",5,0)
 ;input:
"RTN","IBDF18E",6,0)
 ;   FORMID = the unique id assigned to the printed form, points to the FORM TRACKING file
"RTN","IBDF18E",7,0)
 ;   PROVIDER=pointer to NEW PERSON file (#200) (optional)
"RTN","IBDF18E",8,0)
 ;   PROVTYPE= P:=primary,S:=secondary (optional)
"RTN","IBDF18E",9,0)
 ;   BUBBLES = an array which should be passed by reference, BUBBLES is the list of bubbles marked on the form, subscripted by pointers to the BUBBLES multiple in the FORM DEFINITION TABLE
"RTN","IBDF18E",10,0)
 ;   HANDPRNT is the list of hand print fields marked on the form - subscripted by pointers to the HAND PRINT FIELDS multiple in the FORM DEFINITION TABLE, the value being what was input (HANDPRINT(<ien>)=<value>) - should be passed by reference
"RTN","IBDF18E",11,0)
 ;   CHECKOUT = checkout data@time
"RTN","IBDF18E",12,0)
 ;   DYNAMIC = an array which should be passed by reference, contains the list of bubbles selected from dynamic selection lists
"RTN","IBDF18E",13,0)
 ;
"RTN","IBDF18E",14,0)
 ;output:
"RTN","IBDF18E",15,0)
 ;    = 0 if the data is not passed to PCE
"RTN","IBDF18E",16,0)
 ;    = 1 if PXCA is passed by reference, and the data is passed to PCE
"RTN","IBDF18E",17,0)
 ;    the PXCA array is returned, principally to aid in debugging
"RTN","IBDF18E",18,0)
 ;
"RTN","IBDF18E",19,0)
 ;example: S RETURN=$$SEND^IBDF18E(3,DOCTOR,"P",.BUBBLES,.HANDPRNT)
"RTN","IBDF18E",20,0)
 ;
"RTN","IBDF18E",21,0)
 N D,D0,NODE,FORMTYPE,PXCASTAT,IBAPPT,IBCLINIC,IBDFN,VALUE,VALUE1,PI,TEXT,HEADER,QLFR,BUB,STATUS,IBSOURCE,HAND,COUNT,FID,TEMP,ITEM,TYPE,IBDF,LEX,PLEX,QUANTITY,NARR
"RTN","IBDF18E",22,0)
 ;
"RTN","IBDF18E",23,0)
 S FORMID("WSID")=$G(^TMP("IBD-SCAN-RAWDATA",$J,"WSID"))
"RTN","IBDF18E",24,0)
 S FORMID("PAGE")=+$P($G(^TMP("IBD-SCAN-RAWDATA",$J,"FD1")),"PAGE=",2)
"RTN","IBDF18E",25,0)
 K PXCA
"RTN","IBDF18E",26,0)
 S (PXCA,PXCASTAT)=""
"RTN","IBDF18E",27,0)
 ;
"RTN","IBDF18E",28,0)
 ;check that the required parameters were passed
"RTN","IBDF18E",29,0)
 I '$G(FORMID) D LOGERR^IBDF18E2(3579601,.FORMID) Q 0
"RTN","IBDF18E",30,0)
 ;
"RTN","IBDF18E",31,0)
 ;there must be an entry in form tracking - retrieve it into FORMID array
"RTN","IBDF18E",32,0)
 I '$$TRACKING^IBDF18E0(.FORMID) D LOGERR^IBDF18E2(3579501,.FORMID) Q 0
"RTN","IBDF18E",33,0)
 ;
"RTN","IBDF18E",34,0)
 ;there must be a form definition table
"RTN","IBDF18E",35,0)
 S FORMTYPE=$P(NODE,"^",4)
"RTN","IBDF18E",36,0)
 I 'FORMTYPE S STATUS=$$FSCND^IBDF18C(FORMID,12) Q 0
"RTN","IBDF18E",37,0)
 I '$G(^IBD(357.95,FORMTYPE,0)) S STATUS=$$FSCND^IBDF18C(FORMID,12) Q 0
"RTN","IBDF18E",38,0)
 ;
"RTN","IBDF18E",39,0)
 S PROVIDER=$G(PROVIDER)
"RTN","IBDF18E",40,0)
 S PROVTYPE=$G(PROVTYPE)
"RTN","IBDF18E",41,0)
 ;
"RTN","IBDF18E",42,0)
 ;build the encounter node and source node from form tracking
"RTN","IBDF18E",43,0)
 S PXCA("ENCOUNTER")=FORMID("APPT")_"^"_FORMID("DFN")_"^"_FORMID("CLINIC")_"^"_PROVIDER_"^^^^^^^^^^"_CHECKOUT_"^"_PROVTYPE
"RTN","IBDF18E",44,0)
 S PXCA("SOURCE")=+FORMID("SOURCE")_"^"_DUZ_"^"_FORMTYPE_"^^"_FORMID
"RTN","IBDF18E",45,0)
 ;
"RTN","IBDF18E",46,0)
 ;now for each bubble in BUBBLES() add to TEMP()
"RTN","IBDF18E",47,0)
 S BUB=0 F  S BUB=$O(BUBBLES(BUB)) Q:BUB=""  S:BUB NODE=$G(^IBD(357.95,FORMTYPE,1,BUB,0)) D
"RTN","IBDF18E",48,0)
 .N SUBHDR
"RTN","IBDF18E",49,0)
 .I 'BUB!(NODE="") D LOGERR^IBDF18E2(3579502,.FORMID,BUB,BUBBLES(BUB)) Q
"RTN","IBDF18E",50,0)
 .S $P(NODE,"^",8)=$S($D(^IBD(357.95,FORMTYPE,1,BUB,2))&($P($G(^IBD(357.95,FORMTYPE,1,BUB,2)),"^",1)]""):$P($G(^IBD(357.95,FORMTYPE,1,BUB,2)),"^",1),1:$P(NODE,"^",8))
"RTN","IBDF18E",51,0)
 .S VALUE=$P(NODE,"^",4)
"RTN","IBDF18E",52,0)
 .S PI=$P(NODE,"^",3)
"RTN","IBDF18E",53,0)
 .S TEXT=$P(NODE,"^",8)
"RTN","IBDF18E",54,0)
 .; -- strip :: code from TEXT if it exists
"RTN","IBDF18E",55,0)
 .I TEXT[" :: " S TEXT=$$DISP^IBDFM1(TEXT)
"RTN","IBDF18E",56,0)
 .;I TEXT[" :: ",PI,VALUE D
"RTN","IBDF18E",57,0)
 .;.S (Y,X)=VALUE X $G(^IBE(357.6,PI,14)) I Y]"" S TEXT=$P(TEXT," :: "_Y)
"RTN","IBDF18E",58,0)
 .S SUBHDR=$G(^IBD(357.95,FORMTYPE,1,BUB,1))
"RTN","IBDF18E",59,0)
 .;
"RTN","IBDF18E",60,0)
 .; -- the following line causes the subheader and display text to
"RTN","IBDF18E",61,0)
 .;    to be concatenated except for IB, which can pass an alternate
"RTN","IBDF18E",62,0)
 .;    text.  (some don't like this when passed to Problem List)
"RTN","IBDF18E",63,0)
 .;    This may need to be re-visited in the future
"RTN","IBDF18E",64,0)
 .I +FORMID("SOURCE")'=1,$L(SUBHDR),($L(SUBHDR)+$L(TEXT)<80) S TEXT=SUBHDR_" "_TEXT
"RTN","IBDF18E",65,0)
 .S HEADER=$P(NODE,"^",9)
"RTN","IBDF18E",66,0)
 .S FID=$P(NODE,"^",6) I FID="" S FID=$P(NODE,"^") ;PANDAS uses piece 1 to number each bubble - does not use piece 6
"RTN","IBDF18E",67,0)
 .S ITEM=$P(NODE,"^",12)
"RTN","IBDF18E",68,0)
 .S QLFR=$P(NODE,"^",10)
"RTN","IBDF18E",69,0)
 .S QUANTITY=$P(NODE,"^",13)
"RTN","IBDF18E",70,0)
 .;
"RTN","IBDF18E",71,0)
 .; -- if text contains 'x #' for quantity, strip it
"RTN","IBDF18E",72,0)
 .;I +QUANTITY I TEXT[(" x "_QUANTITY) S TEXT=$TR(TEXT," x "_QUANTITY)
"RTN","IBDF18E",73,0)
 .I +QUANTITY I TEXT[(" x "_QUANTITY) D
"RTN","IBDF18E",74,0)
 ..S X=" x "_QUANTITY
"RTN","IBDF18E",75,0)
 ..S TEXT=$E(TEXT,1,$F(TEXT,X)-($L(X)+1))_$E(TEXT,$F(TEXT,X),$L(TEXT))
"RTN","IBDF18E",76,0)
 .;
"RTN","IBDF18E",77,0)
 .S TYPE="",(LEX,NARR)=0
"RTN","IBDF18E",78,0)
 .I $D(^IBD(357.95,FORMTYPE,1,BUB,2)) S LEX=$P($G(^IBD(357.95,FORMTYPE,1,BUB,2)),"^",2)
"RTN","IBDF18E",79,0)
 .D SETTEMP^IBDF18E1
"RTN","IBDF18E",80,0)
 .D CODES^IBDF18E0
"RTN","IBDF18E",81,0)
 K BUBBLES
"RTN","IBDF18E",82,0)
 ;
"RTN","IBDF18E",83,0)
 ;now for each bubble in DYNAMIC() add to TEMP()
"RTN","IBDF18E",84,0)
 S FID="" F  S FID=$O(DYNAMIC(FID)) Q:FID=""  S COUNT="" F  S COUNT=$O(DYNAMIC(FID,COUNT)) Q:COUNT=""  S BUB=$O(^IBD(357.96,FORMID,"AC",FID,+COUNT,0)) S:BUB NODE=$G(^IBD(357.96,FORMID,1,BUB,0)) D
"RTN","IBDF18E",85,0)
 .I 'BUB!(NODE="") D LOGERR^IBDF18E2(3579602,.FORMID,FID,DYNAMIC(FID,COUNT)) Q
"RTN","IBDF18E",86,0)
 .S VALUE=$P(NODE,"^",4)
"RTN","IBDF18E",87,0)
 .S PI=$P(NODE,"^",3)
"RTN","IBDF18E",88,0)
 .S TEXT=$P(NODE,"^",8)
"RTN","IBDF18E",89,0)
 .; -- strip :: code from TEXT if it exists
"RTN","IBDF18E",90,0)
 .I TEXT[" :: " S TEXT=$$DISP^IBDFM1(TEXT)
"RTN","IBDF18E",91,0)
 .;I TEXT[" :: " S TEXT=$P(TEXT," :: ")
"RTN","IBDF18E",92,0)
 .S HEADER=""
"RTN","IBDF18E",93,0)
 .S FID=$P(NODE,"^",6)
"RTN","IBDF18E",94,0)
 .S ITEM=$P(NODE,"^")
"RTN","IBDF18E",95,0)
 .S QLFR=$P(NODE,"^",10)
"RTN","IBDF18E",96,0)
 .S TYPE=""
"RTN","IBDF18E",97,0)
 .S LEX=0
"RTN","IBDF18E",98,0)
 .D SETTEMP^IBDF18E1
"RTN","IBDF18E",99,0)
 K DYNAMIC
"RTN","IBDF18E",100,0)
 ;
"RTN","IBDF18E",101,0)
 ;now for each hand print field in HANDPRNT() add to TEMP()
"RTN","IBDF18E",102,0)
 ;
"RTN","IBDF18E",103,0)
 S HAND=0 F  S HAND=$O(HANDPRNT(HAND)) Q:HAND=""  S:HAND NODE=$G(^IBD(357.95,FORMTYPE,2,HAND,0)) D
"RTN","IBDF18E",104,0)
 .I 'HAND!(NODE="") D LOGERR^IBDF18E2(3579503,.FORMID,HAND,HANDPRNT(HAND)) Q
"RTN","IBDF18E",105,0)
 .S TYPE=$P(NODE,"^",17)
"RTN","IBDF18E",106,0)
 .S VALUE=HANDPRNT(HAND) S:$E(VALUE,$L(VALUE))="," VALUE=$E(VALUE,1,$L(VALUE)-1)
"RTN","IBDF18E",107,0)
 .;
"RTN","IBDF18E",108,0)
 .;what was printed may need transformation/formating
"RTN","IBDF18E",109,0)
 .S VALUE1=VALUE,VALUE=$$HPTRNS^IBDFU91(TYPE,VALUE,.FORMID)
"RTN","IBDF18E",110,0)
 .;
"RTN","IBDF18E",111,0)
 .; -- failed the input transform
"RTN","IBDF18E",112,0)
 .I VALUE="" D LOGERR^IBDF18E2(3579504,.FORMID,HAND,VALUE1,"","",TYPE) Q
"RTN","IBDF18E",113,0)
 .;
"RTN","IBDF18E",114,0)
 .S PI=$P(NODE,"^",4)
"RTN","IBDF18E",115,0)
 .S TEXT=$P(NODE,"^",7)
"RTN","IBDF18E",116,0)
 .S HEADER=$P(NODE,"^",9)
"RTN","IBDF18E",117,0)
 .S FID=$P(NODE,"^",8)
"RTN","IBDF18E",118,0)
 .S ITEM=$P(NODE,"^",12)
"RTN","IBDF18E",119,0)
 .S QLFR=$P(NODE,"^",10)
"RTN","IBDF18E",120,0)
 .S (LEX,NARR)=0
"RTN","IBDF18E",121,0)
 .I $P($G(^IBE(357.2,+$E(FID,2,$L(FID)),0)),U,18)=3 S NARR=1 ;Send both code and narrative
"RTN","IBDF18E",122,0)
 .D SETTEMP^IBDF18E1
"RTN","IBDF18E",123,0)
 K HANDPRNT
"RTN","IBDF18E",124,0)
 ;
"RTN","IBDF18E",125,0)
 D SETPXCA^IBDF18E0,PRO^IBDF18E0,SC^IBDF18E0
"RTN","IBDF18E",126,0)
 ;
"RTN","IBDF18E",127,0)
 I $D(PXCA("IBD-ABORT")) D  S PXCASTAT=0 G SENDQ
"RTN","IBDF18E",128,0)
 .S I="" F  S I=$O(PXCA("IBD-ABORT",I)) Q:I=""  S J="" F  S J=$O(PXCA("IBD-ABORT",I,J)) Q:J=""  D
"RTN","IBDF18E",129,0)
 ..I +PXCA("IBD-ABORT",I,J)=3 K PXCA("IBD-ABORT",I,J) Q
"RTN","IBDF18E",130,0)
 ..D LOGERR^IBDF18E2(3570004,.FORMID,"",$P(PXCA("IBD-ABORT",I,J),"^",2))
"RTN","IBDF18E",131,0)
 ;
"RTN","IBDF18E",132,0)
 I +FORMID("SOURCE")=1 D QUE^IBDF18E3 G STAT
"RTN","IBDF18E",133,0)
 ;
"RTN","IBDF18E",134,0)
 S IBD("AICS")=1 ;flag for IBDF PCE EVENT protocol
"RTN","IBDF18E",135,0)
 S IBD("PASSFLAG")=+$P($G(^IBD(357.09,1,0)),"^",7)
"RTN","IBDF18E",136,0)
 I $G(IBD("PASSFLAG"))<2 D VALIDATE^PXCA(.PXCA) I '$D(PXCA("ERROR")) D BACKGND^PXCA(.PXCA,.PXCASTAT)
"RTN","IBDF18E",137,0)
 I $G(IBD("PASSFLAG"))>1 D FOREGND^PXCA(.PXCA,.PXCASTAT)
"RTN","IBDF18E",138,0)
 K IBD("AICS"),IBD("PASSFLAG")
"RTN","IBDF18E",139,0)
 ;
"RTN","IBDF18E",140,0)
STAT S STATUS=$$FSCND^IBDF18C(FORMID,$S(PXCASTAT=0:4,PXCASTAT=1:3,1:12),$S(PXCASTAT=0:"PCE RETURNED AN ERROR",1:""))
"RTN","IBDF18E",141,0)
 ;
"RTN","IBDF18E",142,0)
 ; -- kill erroneous inpatient warnings
"RTN","IBDF18E",143,0)
 I $D(PXCA("WARNING","ENCOUNTER"))>0 D INPT^IBDF18E0($G(FORMID("DFN")),$G(FORMID("APPT")))
"RTN","IBDF18E",144,0)
 ;
"RTN","IBDF18E",145,0)
 ; -- log pce errors and warnings in AICS Error file
"RTN","IBDF18E",146,0)
 I $O(PXCA("ERROR",""))'=""!($O(PXCA("WARNING",""))'="") S FORMID("SOURCE")=99 D LOGERR^IBDF18E2(3570001,.FORMID)
"RTN","IBDF18E",147,0)
 ;
"RTN","IBDF18E",148,0)
 ; -- if pce returns an error unflag all pages as received and delete
"RTN","IBDF18E",149,0)
 ;    all scanned data so data can be re-scanned
"RTN","IBDF18E",150,0)
SENDQ I $O(PXCA("ERROR",""))'=""!($O(PXCA("IBD-ABORT",""))'="") D UNRECV^IBDFBK2(FORMID)
"RTN","IBDF18E",151,0)
 Q +$G(PXCASTAT)
"RTN","IBDF18E0")
0^16^B31373655
"RTN","IBDF18E0",1,0)
IBDF18E0 ;ALB/CJM - ENCOUNTER FORM - PCE DEVICE INTERFACE utilities ;04-OCT-94
"RTN","IBDF18E0",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**11,25**;APR 24, 1997
"RTN","IBDF18E0",3,0)
 ;
"RTN","IBDF18E0",4,0)
SETPXCA ;set values from TEMP() into the PXCA()
"RTN","IBDF18E0",5,0)
 ;
"RTN","IBDF18E0",6,0)
 N NODE,NUMBER,IBQUIT,Y,Y1,X
"RTN","IBDF18E0",7,0)
 S PROVIDER=+$P(PXCA("ENCOUNTER"),"^",4)
"RTN","IBDF18E0",8,0)
 I PROVIDER,"^P^S^"'[("^"_$P(PXCA("ENCOUNTER"),"^",15)_"^") S $P(PXCA("ENCOUNTER"),"^",15)="S" D LOGERR^IBDF18E2(3579603,.FORMID,"",PROVIDER)
"RTN","IBDF18E0",9,0)
 ;
"RTN","IBDF18E0",10,0)
 S NODE="" F  S NODE=$O(TEMP(NODE)) Q:NODE=""  S NUMBER=0,FID="" F  S FID=$O(TEMP(NODE,FID)) Q:FID=""  S ITEM="" F  S ITEM=$O(TEMP(NODE,FID,ITEM)) Q:ITEM=""  D
"RTN","IBDF18E0",11,0)
 .S IBQUIT=0
"RTN","IBDF18E0",12,0)
 .I NODE="PROCEDURE" S X=TEMP(NODE,FID,ITEM) D
"RTN","IBDF18E0",13,0)
 ..I $P(X,"^",2)="" S $P(X,"^",2)=1
"RTN","IBDF18E0",14,0)
 ..S Y=0 F  S Y=$O(PXCA(NODE,PROVIDER,Y)) Q:'Y!(IBQUIT)  D
"RTN","IBDF18E0",15,0)
 ...S Y1=$G(PXCA(NODE,PROVIDER,Y))
"RTN","IBDF18E0",16,0)
 ...I $P(X,"^")=$P(Y1,"^"),$P(X,"^",3,7)=$P(Y1,"^",3,7) S $P(PXCA(NODE,PROVIDER,Y),"^",2)=$P(PXCA(NODE,PROVIDER,Y),"^",2)+$P(X,"^",2),IBQUIT=1
"RTN","IBDF18E0",17,0)
 ..Q:IBQUIT
"RTN","IBDF18E0",18,0)
 ..S TEMP(NODE,FID,ITEM)=X
"RTN","IBDF18E0",19,0)
 .I IBQUIT K TEMP(NODE,FID,ITEM) Q
"RTN","IBDF18E0",20,0)
 .S NUMBER=NUMBER+1
"RTN","IBDF18E0",21,0)
 .S PXCA(NODE,PROVIDER,NUMBER)=TEMP(NODE,FID,ITEM)
"RTN","IBDF18E0",22,0)
 .K TEMP(NODE,FID,ITEM)
"RTN","IBDF18E0",23,0)
 ;
"RTN","IBDF18E0",24,0)
 ; -- default c/o date time to now if not passed
"RTN","IBDF18E0",25,0)
 I '$P($G(^IBD(357.09,1,1)),"^",2) D  ;cont only if s/p not answerred
"RTN","IBDF18E0",26,0)
 .I $D(PXCA("ENCOUNTER")) I $P(PXCA("ENCOUNTER"),"^",14)="" D  ;quit if we are already passing c/o date/time
"RTN","IBDF18E0",27,0)
 ..N SDOE S SDOE=$$FNDSDOE^IBDFDE($S(+$G(FORMID("DFN")):+$G(FORMID("DFN")),+$G(IBDF("DFN")):+$G(IBDF("DFN")),1:$G(DFN)),$S(+$G(FORMID("APPT")):+$G(FORMID("APPT")),+$G(IBDF("APPT")):+$G(IBDF("APPT")),1:$G(APPT)))
"RTN","IBDF18E0",28,0)
 ..Q:$$COMDT^SDCOU(+SDOE)  ;c/o already performed, don't overwrite
"RTN","IBDF18E0",29,0)
 ..N IBDDFN,IBDAPPT,IBDCLN,IBDCOST
"RTN","IBDF18E0",30,0)
 ..S IBDDFN=$S(+$G(FORMID("DFN")):+$G(FORMID("DFN")),+$G(IBDF("DFN")):+$G(IBDF("DFN")),1:$G(DFN))
"RTN","IBDF18E0",31,0)
 ..S IBDAPPT=$S(+$G(FORMID("APPT")):+$G(FORMID("APPT")),+$G(IBDF("APPT")):+$G(IBDF("APPT")),1:$G(APPT))
"RTN","IBDF18E0",32,0)
 ..S IBDCLN=$S(+$G(FORMID("CLINIC")):+$G(FORMID("CLINIC")),+$G(IBDF("CLINIC")):+$G(IBDF("CLINIC")),1:$G(CLN))
"RTN","IBDF18E0",33,0)
 ..S IBDCOST=$$STATUS^SDAM1(IBDDFN,IBDAPPT,IBDCLN,$G(^DPT(IBDDFN,0))) Q:$P(IBDCOST,";",5)
"RTN","IBDF18E0",34,0)
 ..S $P(PXCA("ENCOUNTER"),"^",14)=$E($$HTFM^XLFDT($H),1,12)
"RTN","IBDF18E0",35,0)
 ;
"RTN","IBDF18E0",36,0)
 D OTHRBUB
"RTN","IBDF18E0",37,0)
 Q
"RTN","IBDF18E0",38,0)
 ;
"RTN","IBDF18E0",39,0)
 ;
"RTN","IBDF18E0",40,0)
OTHRBUB ; -- check procedure and diagnosis node for other bubble, but no data
"RTN","IBDF18E0",41,0)
 N NODE
"RTN","IBDF18E0",42,0)
 S I=0 F  S I=$O(PXCA("PROCEDURE",I)) Q:I=""  S J=0 F  S J=$O(PXCA("PROCEDURE",I,J)) Q:J=""  D
"RTN","IBDF18E0",43,0)
 .I +$G(PXCA("PROCEDURE",I,J))<1 D  ;no code, may be treatment
"RTN","IBDF18E0",44,0)
 ..I $P($G(PXCA("PROCEDURE",I,J)),"^",6)["OTHER#" D  ;no code, narr=other
"RTN","IBDF18E0",45,0)
 ...D LOGERR^IBDF18E2(3579612,.FORMID)
"RTN","IBDF18E0",46,0)
 ...K PXCA("PROCEDURE",I,J)
"RTN","IBDF18E0",47,0)
 .I +$G(PXCA("PROCEDURE",I,J)),$P($G(PXCA("PROCEDURE",I,J)),"^",6)["OTHER#" D
"RTN","IBDF18E0",48,0)
 ..S $P(PXCA("PROCEDURE",I,J),"^",6)=$E($P($G(^ICPT(+PXCA("PROCEDURE",I,J),0)),"^",2),1,80)
"RTN","IBDF18E0",49,0)
 ;
"RTN","IBDF18E0",50,0)
 S I=0 F  S I=$O(PXCA("DIAGNOSIS/PROBLEM",I)) Q:I=""  S J=0 F  S J=$O(PXCA("DIAGNOSIS/PROBLEM",I,J)) Q:J=""  D
"RTN","IBDF18E0",51,0)
 .I $P($G(PXCA("DIAGNOSIS/PROBLEM",I,J)),"^",13)="" D
"RTN","IBDF18E0",52,0)
 ..S $P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",13)=$E($G(^ICD9(+PXCA("DIAGNOSIS/PROBLEM",I,J),1)),1,79)
"RTN","IBDF18E0",53,0)
 .I $P($G(PXCA("DIAGNOSIS/PROBLEM",I,J)),"^",13)["OTHER#" D
"RTN","IBDF18E0",54,0)
 ..S $P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",13)=$E($G(^ICD9(+PXCA("DIAGNOSIS/PROBLEM",I,J),1)),1,79)
"RTN","IBDF18E0",55,0)
 Q
"RTN","IBDF18E0",56,0)
 ;
"RTN","IBDF18E0",57,0)
PRO ; -- make sure diagnosis code is added to DIAGNOSIS/PROBLEM node
"RTN","IBDF18E0",58,0)
 S I=0 F  S I=$O(PXCA("DIAGNOSIS/PROBLEM",I)) Q:I=""  S J=0 F  S J=$O(PXCA("DIAGNOSIS/PROBLEM",I,J)) Q:J=""  D
"RTN","IBDF18E0",59,0)
 .I $TR($P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",5,8),"^","")']"",($P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",2)="") S $P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",2)="S" D
"RTN","IBDF18E0",60,0)
 ..D LOGERR^IBDF18E2(3579505,.FORMID,"",+PXCA("DIAGNOSIS/PROBLEM",I,J),"","","",$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",13))
"RTN","IBDF18E0",61,0)
 .Q:+$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^")
"RTN","IBDF18E0",62,0)
 .I +$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",3) D
"RTN","IBDF18E0",63,0)
 ..S IBX=$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",3) D
"RTN","IBDF18E0",64,0)
 ...I $D(^LEX)>1 S X="LEXU" X ^%ZOSF("TEST") I $T S IBX=$$ICDONE^LEXU(IBX) S:$L(IBX)<1 IBX=799.9 Q  ; clinical lexicon next version to be in ^LEX
"RTN","IBDF18E0",65,0)
 ...S X="GMPTU" X ^%ZOSF("TEST") I $T S IBX=$$ICDONE^GMPTU(IBX) S:$L(IBX)<1 IBX=799.9 Q
"RTN","IBDF18E0",66,0)
 ...S IBX=799.9
"RTN","IBDF18E0",67,0)
 ...Q
"RTN","IBDF18E0",68,0)
 ..S IBXI=+$O(^ICD9("BA",IBX_" ",0)) I +IBXI<1 S IBXI=+$O(^ICD9("BA",799.9_" ",0))
"RTN","IBDF18E0",69,0)
 ..I +IBXI<1 D LOGERR^IBDF18E2(3579506,.FORMID,"",$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",3),"","","",$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",13)) Q
"RTN","IBDF18E0",70,0)
 ..S $P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^")=IBXI
"RTN","IBDF18E0",71,0)
 ..Q
"RTN","IBDF18E0",72,0)
 .;
"RTN","IBDF18E0",73,0)
 .; -- set diagnosis code from problem list into piece 1 of array
"RTN","IBDF18E0",74,0)
 .I +$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",4) S $P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^")=$$PROBDIA^IBDFBK3(+$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",4))
"RTN","IBDF18E0",75,0)
 Q
"RTN","IBDF18E0",76,0)
 ;
"RTN","IBDF18E0",77,0)
CODES ; -- if addt'l codes to pass and qual is prim or sec, send 2nd code
"RTN","IBDF18E0",78,0)
 N VALUE,IBI
"RTN","IBDF18E0",79,0)
 Q:$G(QLFR)']""
"RTN","IBDF18E0",80,0)
 Q:"PRIMARYSECONDARY"'[$P($G(^IBD(357.98,QLFR,0)),"^")
"RTN","IBDF18E0",81,0)
 F IBI=3,4 S VALUE=$P($G(^IBD(357.95,FORMTYPE,1,BUB,2)),"^",IBI) Q:'$G(VALUE)  D
"RTN","IBDF18E0",82,0)
 .N QLFR S QLFR=$O(^IBD(357.98,"B","SECONDARY",0)),ITEM=ITEM_"."_IBI
"RTN","IBDF18E0",83,0)
 .D SETTEMP^IBDF18E1
"RTN","IBDF18E0",84,0)
 .S ITEM=$P(ITEM,".")
"RTN","IBDF18E0",85,0)
 Q
"RTN","IBDF18E0",86,0)
 ;
"RTN","IBDF18E0",87,0)
TRACKING(FORMID) ;get form tracking info,sets FORMID array, which should be passed by reference, return 0 if not found
"RTN","IBDF18E0",88,0)
 ;
"RTN","IBDF18E0",89,0)
 S NODE=$G(^IBD(357.96,FORMID,0))
"RTN","IBDF18E0",90,0)
 Q:NODE="" 0
"RTN","IBDF18E0",91,0)
 S FORMID("APPT")=$P(NODE,"^",3),FORMID("CLINIC")=$P(NODE,"^",10),FORMID("DFN")=$P(NODE,"^",2),FORMID("SOURCE")=$P(NODE,"^",7)
"RTN","IBDF18E0",92,0)
 Q 1
"RTN","IBDF18E0",93,0)
 ;
"RTN","IBDF18E0",94,0)
SC ; -- if SC answered yes then all other classifications = null
"RTN","IBDF18E0",95,0)
 I $P(PXCA("ENCOUNTER"),"^",6) S $P(PXCA("ENCOUNTER"),"^",7,9)="^^"
"RTN","IBDF18E0",96,0)
 Q
"RTN","IBDF18E0",97,0)
 ;
"RTN","IBDF18E0",98,0)
INPT(DFN,APPT) ; -- determine inpatient status
"RTN","IBDF18E0",99,0)
 N INPT
"RTN","IBDF18E0",100,0)
 S INPT=$P($G(^DPT(+$G(DFN),"S",+$G(APPT),0)),"^",2)="I"
"RTN","IBDF18E0",101,0)
 Q:'INPT
"RTN","IBDF18E0",102,0)
 ;
"RTN","IBDF18E0",103,0)
 ; -- kill erroneous warnings for inpatients
"RTN","IBDF18E0",104,0)
 I $G(PXCA("WARNING","ENCOUNTER",0,0,6))["SC flag is missing" K PXCA("WARNING","ENCOUNTER",0,0,6)
"RTN","IBDF18E0",105,0)
 I $G(PXCA("WARNING","ENCOUNTER",0,0,7))["AO flag is missing" K PXCA("WARNING","ENCOUNTER",0,0,7)
"RTN","IBDF18E0",106,0)
 I $G(PXCA("WARNING","ENCOUNTER",0,0,8))["IR flag is missing" K PXCA("WARNING","ENCOUNTER",0,0,8)
"RTN","IBDF18E0",107,0)
 I $G(PXCA("WARNING","ENCOUNTER",0,0,9))["EC flag is missing" K PXCA("WARNING","ENCOUNTER",0,0,9)
"RTN","IBDF18E0",108,0)
 Q
"RTN","IBDF18E2")
0^17^B19295756
"RTN","IBDF18E2",1,0)
IBDF18E2 ;ALB/AAS - AICS Error Logging Routine ;27-JAN-97
"RTN","IBDF18E2",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**25**;APR 24, 1997
"RTN","IBDF18E2",3,0)
 ;
"RTN","IBDF18E2",4,0)
LOGERR(ERRNO,FORMID,DATANO,VALUE,PI,QLFR,TYPEDTA,TXT) ;
"RTN","IBDF18E2",5,0)
 ; -- log aics scanning processing error
"RTN","IBDF18E2",6,0)
 N TEXT,IBDERR
"RTN","IBDF18E2",7,0)
 S TEXT(1)=$$NOW^XLFDT
"RTN","IBDF18E2",8,0)
 S TEXT(2)=$P($G(^IBD(357.96,+$G(FORMID),0)),"^",2) I 'TEXT(2) S TEXT(2)=$G(DFN) ; -- dfn
"RTN","IBDF18E2",9,0)
 S TEXT(3)=$G(FORMID("APPT")) ; -- encounter date/time
"RTN","IBDF18E2",10,0)
 S TEXT(4)=$P($G(^IBD(357.96,+$G(FORMID),0)),"^",4) ; -- pointer to 357.95
"RTN","IBDF18E2",11,0)
 S TEXT(5)=$G(FORMID) S:+TEXT(5) TEXT(5)=+TEXT(5) ; -- pointer to 357.96
"RTN","IBDF18E2",12,0)
 S:$G(DATANO)'="" TEXT(6)=$G(DATANO) ; -- number of bubble or hand print field (ie BUBBLE(1)
"RTN","IBDF18E2",13,0)
 S:$G(VALUE)'="" TEXT(7)=$G(VALUE) ; -- value of bubble or hand print field
"RTN","IBDF18E2",14,0)
 S TEXT(8)=$G(FORMID("SOURCE"))
"RTN","IBDF18E2",15,0)
 S TEXT(9)=$P($G(^IBD(357.95,+$P($G(^IBD(357.96,+$G(FORMID),0)),"^",4),0)),"^",21) ; -- form name
"RTN","IBDF18E2",16,0)
 S:$G(PI)'="" TEXT(10)=$G(PI) ; -- package interface
"RTN","IBDF18E2",17,0)
 S:$G(QLFR)'="" TEXT(11)=$G(QLFR) ; -- name of qualifier
"RTN","IBDF18E2",18,0)
 S:$G(TXT)'="" TEXT(12)=$G(TXT) ; -- Text appearing on the form
"RTN","IBDF18E2",19,0)
 S TEXT(13)=$G(DUZ) ; -- user
"RTN","IBDF18E2",20,0)
 S:$G(TYPEDTA)'="" TEXT(14)=$P($G(^IBE(359.1,+TYPEDTA,0)),"^")
"RTN","IBDF18E2",21,0)
 S:$G(XQY0)'="" TEXT(15)=$P(XQY0,"^") ; -- option name
"RTN","IBDF18E2",22,0)
 S TEXT(16)=$G(ERRNO) ; -- entry in dialog file
"RTN","IBDF18E2",23,0)
 S:$G(FORMID("PAGE")) TEXT(17)=$G(FORMID("PAGE"))
"RTN","IBDF18E2",24,0)
 S:$G(FORMID("WSID"))'="" TEXT(18)=$G(FORMID("WSID"))
"RTN","IBDF18E2",25,0)
 ;
"RTN","IBDF18E2",26,0)
 ; -- Build Error Message from Dialog file
"RTN","IBDF18E2",27,0)
 D BLD^DIALOG(ERRNO,.TEXT,.IBDOUT,"IBDERR","S")
"RTN","IBDF18E2",28,0)
 ;D ERRMSG(ERRNO,.TEXT)
"RTN","IBDF18E2",29,0)
 ;
"RTN","IBDF18E2",30,0)
 ; -- file error in aics error log file
"RTN","IBDF18E2",31,0)
 D ERRFIL(ERRNO,.TEXT,.IBDERR)
"RTN","IBDF18E2",32,0)
 Q:ERRNO=3570001!(ERRNO=3570004)
"RTN","IBDF18E2",33,0)
 ;
"RTN","IBDF18E2",34,0)
 ; -- set error in pxca(aics error) array to pass back to workstation
"RTN","IBDF18E2",35,0)
 S CNT=$G(PXCA("AICS ERROR"))+1
"RTN","IBDF18E2",36,0)
 S PXCA("AICS ERROR")=CNT
"RTN","IBDF18E2",37,0)
 S PXCA("AICS ERROR",1,1,1,CNT)=$P($G(IBDERR(1)),": ",2,99)
"RTN","IBDF18E2",38,0)
 Q
"RTN","IBDF18E2",39,0)
 ;
"RTN","IBDF18E2",40,0)
ERRMSG(ERRNO,TEXT) ;
"RTN","IBDF18E2",41,0)
 ; -- Build Error Message from Dialog file
"RTN","IBDF18E2",42,0)
 D BLD^DIALOG(ERRNO,.TEXT,.IBDOUT,"IBDERR","S")
"RTN","IBDF18E2",43,0)
 Q
"RTN","IBDF18E2",44,0)
 ;
"RTN","IBDF18E2",45,0)
ERRFIL(ERRNO,TEXT,IBDERR) ;
"RTN","IBDF18E2",46,0)
 ; -- file error in aics error log file
"RTN","IBDF18E2",47,0)
 N FDAROOT,FDAIEN
"RTN","IBDF18E2",48,0)
 ;
"RTN","IBDF18E2",49,0)
 Q:$G(TEXT(1))=""
"RTN","IBDF18E2",50,0)
 S FDAROOT(359.3,"+1,",.01)=$G(TEXT(1))
"RTN","IBDF18E2",51,0)
 S:$G(TEXT(2))'="" FDAROOT(359.3,"+1,",.02)=$G(TEXT(2))
"RTN","IBDF18E2",52,0)
 S:$G(TEXT(3))'="" FDAROOT(359.3,"+1,",.03)=$G(TEXT(3))
"RTN","IBDF18E2",53,0)
 S:$G(TEXT(4))'="" FDAROOT(359.3,"+1,",.04)=$G(TEXT(4))
"RTN","IBDF18E2",54,0)
 S:$G(TEXT(5))'="" FDAROOT(359.3,"+1,",.05)=$G(TEXT(5))
"RTN","IBDF18E2",55,0)
 S:$G(TEXT(6))'="" FDAROOT(359.3,"+1,",.06)=$G(TEXT(6))
"RTN","IBDF18E2",56,0)
 S:$G(TEXT(7))'="" FDAROOT(359.3,"+1,",.07)=$G(TEXT(7))
"RTN","IBDF18E2",57,0)
 S:$G(TEXT(8))'="" FDAROOT(359.3,"+1,",.08)=$G(TEXT(8))
"RTN","IBDF18E2",58,0)
 S:$G(TEXT(9))'="" FDAROOT(359.3,"+1,",.09)=$G(TEXT(9))
"RTN","IBDF18E2",59,0)
 S:$G(TEXT(10))'="" FDAROOT(359.3,"+1,",.1)=$G(TEXT(10))
"RTN","IBDF18E2",60,0)
 S:$G(TEXT(11))'="" FDAROOT(359.3,"+1,",.11)=$G(TEXT(11))
"RTN","IBDF18E2",61,0)
 S:$G(TEXT(12))'="" FDAROOT(359.3,"+1,",.12)=$G(TEXT(12))
"RTN","IBDF18E2",62,0)
 S:$G(TEXT(13))'="" FDAROOT(359.3,"+1,",.13)=$G(TEXT(13))
"RTN","IBDF18E2",63,0)
 S:$G(TEXT(16))'="" FDAROOT(359.3,"+1,",.16)=$G(TEXT(16))
"RTN","IBDF18E2",64,0)
 S:$G(TEXT(15))'="" FDAROOT(359.3,"+1,",1.01)=$G(TEXT(15))
"RTN","IBDF18E2",65,0)
 S:$G(TEXT(17))'="" FDAROOT(359.3,"+1,",.17)=$G(TEXT(17))
"RTN","IBDF18E2",66,0)
 S:$G(TEXT(18))'="" FDAROOT(359.3,"+1,",.18)=$G(TEXT(18))
"RTN","IBDF18E2",67,0)
 ;
"RTN","IBDF18E2",68,0)
 S CNT=2
"RTN","IBDF18E2",69,0)
 I ERRNO=3570001 D EW^IBDFBK2(.IBDERR,.PXCA,.CNT,1)
"RTN","IBDF18E2",70,0)
 ;
"RTN","IBDF18E2",71,0)
 D UPDATE^DIE("","FDAROOT","FDAIEN")
"RTN","IBDF18E2",72,0)
 D WP^DIE(359.3,FDAIEN(1)_",",10,"KA","IBDERR")
"RTN","IBDF18E2",73,0)
 Q
"RTN","IBDF18E2",74,0)
 ;
"RTN","IBDF18E2",75,0)
PRT ; -- print error listing
"RTN","IBDF18E2",76,0)
 I '$D(IOF) D HOME^%ZIS
"RTN","IBDF18E2",77,0)
 W @IOF,?10,"Print List of Scanning Errors and Warnings",!!!
"RTN","IBDF18E2",78,0)
 ;
"RTN","IBDF18E2",79,0)
 S DIC="^IBD(359.3,",L=0,FR="?,?,?,?",TO="?,?,?,?"
"RTN","IBDF18E2",80,0)
 S BY="[IBD LIST ERRORS]"
"RTN","IBDF18E2",81,0)
 S FLDS="[IBD LIST ERRORS]"
"RTN","IBDF18E2",82,0)
 ;
"RTN","IBDF18E2",83,0)
 ;S DISUPNO=1 ; -- print No records found if not set, don't uncomment this line
"RTN","IBDF18E2",84,0)
 S DIPCRIT=1 ; -- print sort criteria on first page.
"RTN","IBDF18E2",85,0)
 S DIS(0)="I '$P($G(^IBD(359.3,D0,1)),U,2)"
"RTN","IBDF18E2",86,0)
 D EN1^DIP
"RTN","IBDF18E2",87,0)
PRTQ K DIC,L,FLDS,DIOEND,FR,TO,BY,DHD,X,Y,DUOUT,DIRUT
"RTN","IBDF18E2",88,0)
 Q
"RTN","IBDF18E2",89,0)
 ;
"RTN","IBDF18E2",90,0)
NOAPP ; -- print no appointment listing
"RTN","IBDF18E2",91,0)
 I '$D(IOF) D HOME^%ZIS
"RTN","IBDF18E2",92,0)
 S IBDCNT=0
"RTN","IBDF18E2",93,0)
 W @IOF,?10,"Print List Patients with Data from Encounter Forms and No appointemnts",!!!
"RTN","IBDF18E2",94,0)
 ;
"RTN","IBDF18E2",95,0)
 S DIC="^IBD(357.96,",L=0,FR="?,?,?,T-1",TO="?,?,?,T-1"
"RTN","IBDF18E2",96,0)
 S BY="[IBD NO APPOINTMENT LIST]"
"RTN","IBDF18E2",97,0)
 S FLDS="[IBD NO APPOINTMENT LIST]"
"RTN","IBDF18E2",98,0)
 ;
"RTN","IBDF18E2",99,0)
 ;S DIPCRIT=1 ; -- print sort criteria on first page.
"RTN","IBDF18E2",100,0)
 S DIS(0)="I 1 S IBDCNT=IBDCNT+1"
"RTN","IBDF18E2",101,0)
 S IOP="HOME"
"RTN","IBDF18E2",102,0)
 D EN1^DIP
"RTN","IBDF18E2",103,0)
NOAPPQ K DIC,L,FLDS,DIOEND,FR,TO,BY,DHD,X,Y,DUOUT,DIRUT,IBDCNT
"RTN","IBDF18E2",104,0)
 Q
"RTN","IBDF18E2",105,0)
NOAPP1 ; -- print no appointment listing
"RTN","IBDF18E2",106,0)
 I '$D(IOF) D HOME^%ZIS
"RTN","IBDF18E2",107,0)
 S IBDCNT=0
"RTN","IBDF18E2",108,0)
 W @IOF,?10,"Print List Patients with Data from Encounter Forms and No appointemnts",!!!
"RTN","IBDF18E2",109,0)
 ;
"RTN","IBDF18E2",110,0)
 S DIC="^IBD(357.96,",L=0,FR="?,?,?,T-1",TO="?,?,?,T-1"
"RTN","IBDF18E2",111,0)
 S BY="[IBD NO APPOINTMENT1]"
"RTN","IBDF18E2",112,0)
 S FLDS="[IBD NO APPOINTMENT LIST]"
"RTN","IBDF18E2",113,0)
 ;
"RTN","IBDF18E2",114,0)
 ;S DIPCRIT=1 ; -- print sort criteria on first page.
"RTN","IBDF18E2",115,0)
 S DIS(0)="I 1 S IBDCNT=IBDCNT+1"
"RTN","IBDF18E2",116,0)
 S IOP="HOME"
"RTN","IBDF18E2",117,0)
 D EN1^DIP
"RTN","IBDF18E2",118,0)
NOAPP1Q K DIC,L,FLDS,DIOEND,FR,TO,BY,DHD,X,Y,DUOUT,DIRUT,IBDCNT
"RTN","IBDF18E2",119,0)
 Q
"RTN","IBDF1B1A")
0^8^B25624007
"RTN","IBDF1B1A",1,0)
IBDF1B1A ;ALB/CJM - ENCOUNTER FORM PRINT (IBDF1B continued - user options for printing- continuation of IBDF1B1); 3/1/93
"RTN","IBDF1B1A",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**25**;APR 24, 1997
"RTN","IBDF1B1A",3,0)
 ;
"RTN","IBDF1B1A",4,0)
ENCL ;for every clinic choosen find patient appointments on DATE
"RTN","IBDF1B1A",5,0)
 N DFN,CLNCNAME,IBCLINIC,PNAME,TDIGIT,IBAPPT,IBAPTYP,IBX,Y,IBDIV,FIRST4
"RTN","IBDF1B1A",6,0)
 S IBCLINIC="" F  S IBCLINIC=$O(^TMP("IBDF",$J,"C",IBCLINIC)) Q:'IBCLINIC  D
"RTN","IBDF1B1A",7,0)
 .;
"RTN","IBDF1B1A",8,0)
 .;
"RTN","IBDF1B1A",9,0)
 .;get the clinic's division
"RTN","IBDF1B1A",10,0)
 .S IBDIV=$$DIVISION^IBDF1B5(IBCLINIC) S:IBDIV="" IBDIV="^ "
"RTN","IBDF1B1A",11,0)
 .
"RTN","IBDF1B1A",12,0)
 .;setup defined for clinic or division? - otherwise there is nothing to print
"RTN","IBDF1B1A",13,0)
 .Q:'($D(^SD(409.95,"B",IBCLINIC))!$D(^SD(409.96,"B",+IBDIV)))
"RTN","IBDF1B1A",14,0)
 .S IBDIV=$P(IBDIV,"^",2)
"RTN","IBDF1B1A",15,0)
 .;
"RTN","IBDF1B1A",16,0)
 .;if restart, sorting is by division/clinic, and clinic is in the starting division, make sure the clinic does not precede the starting clinic
"RTN","IBDF1B1A",17,0)
 .I IBDIV=IBSTRTDV,((IBSRT=1)!(IBSRT=3)) S CLNCNAME=$P($G(^SC(IBCLINIC,0)),"^") I CLNCNAME'=IBREPRNT,CLNCNAME']IBREPRNT Q
"RTN","IBDF1B1A",18,0)
 .;
"RTN","IBDF1B1A",19,0)
 .;find the appts
"RTN","IBDF1B1A",20,0)
 .S IBAPPT=IBDT F  S IBAPPT=$O(^SC(IBCLINIC,"S",IBAPPT)) Q:$E(IBAPPT,1,7)'=IBDT  D
"RTN","IBDF1B1A",21,0)
 ..S IBX=0 F  S IBX=$O(^SC(IBCLINIC,"S",IBAPPT,1,IBX)) Q:IBX=""  D
"RTN","IBDF1B1A",22,0)
 ...Q:$P($G(^SC(IBCLINIC,"S",IBAPPT,1,IBX,0)),"^",9)="C"
"RTN","IBDF1B1A",23,0)
 ...S DFN=+$G(^SC(IBCLINIC,"S",IBAPPT,1,IBX,0)) Q:$E($P($G(^DPT(DFN,0)),"^",9),1,5)="00000"&($D(IBDFTSTP))  S PNAME=$P($G(^DPT(DFN,0)),"^") Q:PNAME=""
"RTN","IBDF1B1A",24,0)
 ...;check the appt status - may be cancelled
"RTN","IBDF1B1A",25,0)
 ...S IBAPTYP=$G(^DPT(DFN,"S",IBAPPT,0)) Q:"NT,I,"'[($P(IBAPTYP,"^",2)_",")
"RTN","IBDF1B1A",26,0)
 ...; -- check parameter if inpatient and don't print inpatients then quit
"RTN","IBDF1B1A",27,0)
 ...I $P(IBAPTYP,"^",2)="I",$P($G(^IBD(357.09,1,0)),"^",5)=0 Q
"RTN","IBDF1B1A",28,0)
 ...;
"RTN","IBDF1B1A",29,0)
 ...;if only printing add-ons don't print if already printed
"RTN","IBDF1B1A",30,0)
 ...I IBADDONS,IBREPRNT="" Q:$$PRINTED(DFN,IBAPPT)
"RTN","IBDF1B1A",31,0)
 ...I IBADDONS,IBREPRNT'="" Q:'$$ADDON(DFN,IBAPPT)
"RTN","IBDF1B1A",32,0)
 ...;
"RTN","IBDF1B1A",33,0)
 ...;case of sort by clinic,patient
"RTN","IBDF1B1A",34,0)
 ...;
"RTN","IBDF1B1A",35,0)
 ...;**** when the new SAC standards go into effect, increasing the allowable global subscript length, this line should be substituted for the line following it ****
"RTN","IBDF1B1A",36,0)
 ...I IBSRT=1 S CLNCNAME=$P($G(^SC(IBCLINIC,0)),"^") Q:CLNCNAME=""  S ^TMP("IBDF",$J,"P",IBDIV,CLNCNAME,IBCLINIC,$E(PNAME,1,15),DFN,+IBAPPT)=""
"RTN","IBDF1B1A",37,0)
 ...; old way ;I IBSRT=1 S CLNCNAME=$P($G(^SC(IBCLINIC,0)),"^") Q:CLNCNAME=""  S ^TMP("IBDF",$J,"P",$E(IBDIV,1,20),$E(CLNCNAME,1,10),IBCLINIC,$E(PNAME,1,10),DFN,+IBAPPT)=""
"RTN","IBDF1B1A",38,0)
 ...;
"RTN","IBDF1B1A",39,0)
 ...;case of sort by terminal digit
"RTN","IBDF1B1A",40,0)
 ...I IBSRT=2 D
"RTN","IBDF1B1A",41,0)
 ....S TDIGIT=$$TDG(DFN),FIRST4=$E(TDIGIT,1,$L(TDIGIT)-5)
"RTN","IBDF1B1A",42,0)
 ....;
"RTN","IBDF1B1A",43,0)
 ....;if this is a restart and clinic is in the starting division, make sure the terminal digits (1st 4) do not precede the restart position
"RTN","IBDF1B1A",44,0)
 ....I IBDIV=IBSTRTDV,FIRST4'=IBREPRNT,FIRST4<IBREPRNT Q
"RTN","IBDF1B1A",45,0)
 ....;
"RTN","IBDF1B1A",46,0)
 ....S ^TMP("IBDF",$J,"P",IBDIV,TDIGIT,DFN,+IBAPPT)=IBCLINIC
"RTN","IBDF1B1A",47,0)
 ...;
"RTN","IBDF1B1A",48,0)
 ...;case of sort by clinic/terminal digits
"RTN","IBDF1B1A",49,0)
 ...;
"RTN","IBDF1B1A",50,0)
 ...;**** when the new SAC standards go into effect, increasing the allowable global subscript length, this line should be substituted for the line following it ****
"RTN","IBDF1B1A",51,0)
 ...I IBSRT=3 S TDIGIT=$$TDG(DFN),CLNCNAME=$P($G(^SC(IBCLINIC,0)),"^") Q:CLNCNAME=""  S ^TMP("IBDF",$J,"P",IBDIV,CLNCNAME,IBCLINIC,TDIGIT,DFN,+IBAPPT)=""
"RTN","IBDF1B1A",52,0)
 ...; this is the old way ;I IBSRT=3 S TDIGIT=$$TDG(DFN),CLNCNAME=$P($G(^SC(IBCLINIC,0)),"^") Q:CLNCNAME=""  S ^TMP("IBDF",$J,"P",$E(IBDIV,1,20),$E(CLNCNAME,1,10),IBCLINIC,TDIGIT,DFN,+IBAPPT)=""
"RTN","IBDF1B1A",53,0)
 ;
"RTN","IBDF1B1A",54,0)
 ;don't need the list of clinics anymore
"RTN","IBDF1B1A",55,0)
 K ^TMP("IBDF",$J,"C")
"RTN","IBDF1B1A",56,0)
 Q
"RTN","IBDF1B1A",57,0)
 ;
"RTN","IBDF1B1A",58,0)
TDG(DFN) ;reformat patient's SSN into terminal digit order, then turns it into a cannonic number
"RTN","IBDF1B1A",59,0)
 ; returns either 0 or ssn in terminal digit order
"RTN","IBDF1B1A",60,0)
 N X,Y,I,SSN
"RTN","IBDF1B1A",61,0)
 S SSN=$P($G(^DPT(DFN,0)),"^",9)
"RTN","IBDF1B1A",62,0)
 S Y="" F I=1:1 S X=$E(SSN,I) Q:X=""  I X?1N S Y=Y_X
"RTN","IBDF1B1A",63,0)
 S Y=$S(Y'?9N:0,1:$E(Y,8,9)_$E(Y,6,7)_$E(Y,4,5)_$E(Y,1,3))
"RTN","IBDF1B1A",64,0)
 Q +Y
"RTN","IBDF1B1A",65,0)
 ;
"RTN","IBDF1B1A",66,0)
PRINTED(DFN,IBAPPT) ;returns 1 if the print manager already printed forms for this appt, 0 otherwise
"RTN","IBDF1B1A",67,0)
 Q +$P($G(^DPT(DFN,"S",IBAPPT,0)),"^",21)
"RTN","IBDF1B1A",68,0)
ADDON(DFN,IBAPPT) ;returns 1 if the print manager already printed forms for this appt as an add-on, 0 otherwise
"RTN","IBDF1B1A",69,0)
 Q +$P($G(^DPT(DFN,"S",IBAPPT,0)),"^",22)
"RTN","IBDF1B1A",70,0)
 ;
"RTN","IBDF1B1A",71,0)
GETLIST(DFN,IBDT,DIVISION) ;creates a list of the patient's appts on IBDT
"RTN","IBDF1B1A",72,0)
 Q:'DFN!'IBDT
"RTN","IBDF1B1A",73,0)
 N APPT,NODE,TO
"RTN","IBDF1B1A",74,0)
 S TO=IBDT+.999999
"RTN","IBDF1B1A",75,0)
 S ^TMP("IBDF",$J,"APPT LIST",DIVISION,DFN)=""
"RTN","IBDF1B1A",76,0)
 S APPT=IBDT-.0001 F  S APPT=$O(^DPT(DFN,"S",APPT)) Q:'APPT!(APPT>TO)  D
"RTN","IBDF1B1A",77,0)
 .S NODE=$G(^DPT(DFN,"S",APPT,0))
"RTN","IBDF1B1A",78,0)
 .Q:"NT,I,"'[($P(NODE,"^",2)_",")
"RTN","IBDF1B1A",79,0)
 .Q:$P($G(^SC(+NODE,0)),"^",15)'=DIVISION
"RTN","IBDF1B1A",80,0)
 .; -- check parameter
"RTN","IBDF1B1A",81,0)
 .;I $P(NODE,"^",2)="I",$P($G(^IBD(357.09,1,0)),"^",5)=0 Q
"RTN","IBDF1B1A",82,0)
 .S ^TMP("IBDF",$J,"APPT LIST",DIVISION,DFN,APPT)=+NODE
"RTN","IBDF1B1A",83,0)
 Q
"RTN","IBDF1B1A",84,0)
MULTIPLE(DFN,APPT) ;determines if patient=DFN has multiple appts on the list and APPT is the earliest
"RTN","IBDF1B1A",85,0)
 N APT
"RTN","IBDF1B1A",86,0)
 D GETLIST(DFN,APPT,DIVISION)
"RTN","IBDF1B1A",87,0)
 S APT=$O(^TMP("IBDF",$J,"APPT LIST",DIVISION,DFN,""))
"RTN","IBDF1B1A",88,0)
 ;Q:APT'=APPT 0
"RTN","IBDF1B1A",89,0)
 I $O(^TMP("IBDF",$J,"APPT LIST",DIVISION,DFN,APT))
"RTN","IBDF1B1A",90,0)
 Q $T
"RTN","IBDF1B1A",91,0)
 ;
"RTN","IBDF1B1A",92,0)
DIVHAS(IBDIV) ;returns >0 if the division has anything to print, 0 otherwise
"RTN","IBDF1B1A",93,0)
 Q:'$G(IBDIV) 0
"RTN","IBDF1B1A",94,0)
 Q $L($O(^SD(409.96,"A",IBDIV,"")))
"RTN","IBDF1B1A",95,0)
 ;
"RTN","IBDF1B1A",96,0)
CLNCHAS(CLINIC) ;returns>0 if the clinic has something to print
"RTN","IBDF1B1A",97,0)
 N NODE,SETUP,I,FOUND
"RTN","IBDF1B1A",98,0)
 S SETUP=$O(^SD(409.95,"B",CLINIC,0)) Q:'SETUP 0
"RTN","IBDF1B1A",99,0)
 S NODE=$G(^SD(409.95,SETUP,0))
"RTN","IBDF1B1A",100,0)
 S FOUND=0 F I=2,3,4,6,8,9 I $P(NODE,"^",I) S FOUND=1 Q
"RTN","IBDF1B1A",101,0)
 Q:FOUND 1
"RTN","IBDF1B1A",102,0)
 Q $L($O(^SD(409.95,"A",CLINIC,"")))
"RTN","IBDF1BA")
0^9^B19503335
"RTN","IBDF1BA",1,0)
IBDF1BA ;ALB/CJM - ENCOUNTER FORM (user options for printing - continuation of IBDF1B); 3/1/93
"RTN","IBDF1BA",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**25**;APR 24, 1997
"RTN","IBDF1BA",3,0)
 ;
"RTN","IBDF1BA",4,0)
TERMSTRT ;get terminal digit to restart from - OUTPUT=IBREPRNT
"RTN","IBDF1BA",5,0)
 S IBREPRNT="",DIR(0)="F^4:5",DIR("A")="ENTER THE LAST 4 DIGITS OF THE SSN TO BEGIN REPRINT FROM",DIR("?")="ENTER THE LAST FOUR DIGITS OF THE SSN OF THE LAST PATIENT FOR WHOM FORMS WERE PRINTED"
"RTN","IBDF1BA",6,0)
 F  D ^DIR Q:$D(DIRUT)!(Y=-1)  D  Q:IBREPRNT'=""
"RTN","IBDF1BA",7,0)
 .I Y'?4N W !,$C(7),"MUST BE 4 NUMBERS!" Q
"RTN","IBDF1BA",8,0)
 .S IBREPRNT=Y,IBREPRNT=+($E(IBREPRNT,3,4)_$E(IBREPRNT,1,2))
"RTN","IBDF1BA",9,0)
 K DIR
"RTN","IBDF1BA",10,0)
 Q
"RTN","IBDF1BA",11,0)
CLNCSTRT ;get clinic and division to restart from,OUTPUT=IBREPRNT (name of clinic) and IBSTRTDV (division to restart from)
"RTN","IBDF1BA",12,0)
 ;
"RTN","IBDF1BA",13,0)
 N NODE
"RTN","IBDF1BA",14,0)
 S IBREPRNT=""
"RTN","IBDF1BA",15,0)
 S DIR(0)="409.95,.01",DIR("A")="ENTER CLINIC TO BEGIN REPRINT FROM",DIR("?")="ENTER THE LAST CLINIC FOR WHICH ANY FORMS WERE PRINTED"
"RTN","IBDF1BA",16,0)
 D ^DIR K DIR I $D(DIRUT)!(+Y<0) Q
"RTN","IBDF1BA",17,0)
 S NODE=$G(^SC(+Y,0))
"RTN","IBDF1BA",18,0)
 S IBREPRNT=$P(NODE,"^")
"RTN","IBDF1BA",19,0)
 S IBSTRTDV=+$P(NODE,"^",15) I IBSTRTDV S IBSTRTDV=$P($G(^DG(40.8,IBSTRTDV,0)),"^")
"RTN","IBDF1BA",20,0)
 Q
"RTN","IBDF1BA",21,0)
 ;
"RTN","IBDF1BA",22,0)
SEARCH ;get the appointment data on a patient, put in IBTMP array, indexed by appointment
"RTN","IBDF1BA",23,0)
 ;screens out any appts in clinics with nothing defined to print
"RTN","IBDF1BA",24,0)
 N IBX,IBLN,CLINIC,APPT
"RTN","IBDF1BA",25,0)
 S (VASD("F"),VASD("T"))=IBDT,VASD("W")=129 D SDA^VADPT Q:(VAERR!'$D(^UTILITY("VASD",$J)))
"RTN","IBDF1BA",26,0)
 S IBX="" F  S IBX=$O(^UTILITY("VASD",$J,IBX)) Q:IBX=""  D
"RTN","IBDF1BA",27,0)
 . S IBLN=^UTILITY("VASD",$J,IBX,"I"),APPT=+$P(IBLN,"^"),CLINIC=$P(IBLN,"^",2)
"RTN","IBDF1BA",28,0)
 .Q:'APPT!'CLINIC
"RTN","IBDF1BA",29,0)
 .Q:'($D(^SD(409.95,"B",CLINIC))!$D(^SD(409.96,"B",+$$DIVISION^IBDF1B5(CLINIC))))
"RTN","IBDF1BA",30,0)
 .;^UTILITY("VASD",$J,IBX,"E")=(EXTERNAL FORMAT) appt date time^clinic name^status^appt type
"RTN","IBDF1BA",31,0)
 .S IBTMP(APPT)=DFN_"^"_CLINIC_"^"_IBNM_"^"_^UTILITY("VASD",$J,IBX,"E")
"RTN","IBDF1BA",32,0)
 K VASD,VAERR,^UTILITY("VASD",$J)
"RTN","IBDF1BA",33,0)
 Q
"RTN","IBDF1BA",34,0)
 ;
"RTN","IBDF1BA",35,0)
DISP ;display patients/clinics appointments found and get users choice
"RTN","IBDF1BA",36,0)
 ;sort type is by clinic,patient
"RTN","IBDF1BA",37,0)
 N CLNCIEN,CLNCNAME
"RTN","IBDF1BA",38,0)
 I '$D(IBTMP) W !!,?5,"No Active Appointments for ",IBNM," on",!,"this date in any clinic or division that has forms or reports defined to print",! G ENDDISP
"RTN","IBDF1BA",39,0)
 I '$D(IBTMP) W !!,?10,"No Active Appointments in a Clinic with an Encounter Form",!,?10,"for ",IBNM," on this date.",! G ENDDISP
"RTN","IBDF1BA",40,0)
 W !!,"Appointments for ",IBNM,!
"RTN","IBDF1BA",41,0)
 S IBX="" F IBI=1:1 S IBX=$O(IBTMP(IBX)) Q:IBX=""  S IBLN=IBTMP(IBX) W !,$J(IBI,3),"  ",$E($P(IBLN,"^",5),1,20),?25,"   " F IBJ=4,6,7 W "  ",$P(IBLN,"^",IBJ)
"RTN","IBDF1BA",42,0)
 S DIR(0)="LO^1:"_(IBI-1),DIR("A")="    Select Appointments" D ^DIR K DIR G:$D(DIRUT) ENDDISP
"RTN","IBDF1BA",43,0)
 S IBX="" F IBI=1:1 S IBX=$O(IBTMP(IBX)) Q:IBX=""  I Y[(IBI_",") D
"RTN","IBDF1BA",44,0)
 .S CLNCIEN=$P(IBTMP(IBX),"^",2),CLNCNAME=$P(IBTMP(IBX),"^",5)
"RTN","IBDF1BA",45,0)
 .;
"RTN","IBDF1BA",46,0)
 .;list format - ^TMP("IBDF",$J,"P"," ",division name(but set it to " " because for selecting single appts sort by division not needed),clinic name,clinic ien,patient name,dfn,appt)=""
"RTN","IBDF1BA",47,0)
 .S ^TMP("IBDF",$J,"P"," ",CLNCNAME,CLNCIEN,IBNM,DFN,IBX)=""
"RTN","IBDF1BA",48,0)
 .;S ^TMP("IBDF",$J,"P"," ",$E(CLNCNAME,1,25),CLNCIEN,$E(IBNM,1,25),DFN,IBX)=""
"RTN","IBDF1BA",49,0)
 .;also keep an index by ...,"APPT LIST",DFN,APPT)
"RTN","IBDF1BA",50,0)
 .S ^TMP("IBDF",$J,"APPT LIST",DFN,IBX)=""
"RTN","IBDF1BA",51,0)
ENDDISP K IBTMP,IBX,IBI,IBJ,IBLN,DTOUT,DUOUT,DIRUT,DIROUT,X,Y,^UTILITY("VASD",$J)
"RTN","IBDF1BA",52,0)
 Q
"RTN","IBDF1BA",53,0)
 ;
"RTN","IBDF1BA",54,0)
STARTDIV() ;asks what division to restart the job from and returns division name, or "" if user declines
"RTN","IBDF1BA",55,0)
 N IBDIV
"RTN","IBDF1BA",56,0)
 K DIC S DIC="^DG(40.8,",DIC(0)="AEQMN",DIC("A")="SELECT THE DIVISION TO START THE REPRINT FROM: "
"RTN","IBDF1BA",57,0)
 S IBDIV=$O(^DG(40.8,0)) S:IBDIV DIC("B")=$P($G(^DG(40.8,IBDIV,0)),"^")
"RTN","IBDF1BA",58,0)
 D ^DIC K DIC
"RTN","IBDF1BA",59,0)
 I (+Y<0)!$D(DTOUT)!$D(DUOUT) Q ""
"RTN","IBDF1BA",60,0)
 Q $P(Y,"^",2)
"RTN","IBDF1BA",61,0)
SORTBY ;sort by clinic/patient, clinic/terminal digit, or terminal digit?
"RTN","IBDF1BA",62,0)
 K DIR S DIR(0)="S^1:Division/Clinic/Patient Name;2:Division/Terminal Digits;3:Division/Clinic/Terminal Digits"
"RTN","IBDF1BA",63,0)
 S DIR("?")="Enter '1' for sorting by Division/Clinic/Patient Name or '2' to sort by Division/Terminal Digits or '3' to sort by Division/Clinic/Terminal Digits."
"RTN","IBDF1BA",64,0)
 S DIR("A")="How should the output be SORTED?",DIR("B")="1" D ^DIR K DIR I $D(DIRUT) S QUIT=1 Q
"RTN","IBDF1BA",65,0)
 I Y'=1,Y'=2,Y'=3 S QUIT=1 Q
"RTN","IBDF1BA",66,0)
 S IBSRT=Y
"RTN","IBDF1BA",67,0)
 Q
"RTN","IBDF2F")
0^4^B61324428
"RTN","IBDF2F",1,0)
IBDF2F ;ALB/CJM - ENCOUNTER FORM - PRINT FORM(sends to printer) ;NOV 16,1992
"RTN","IBDF2F",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3,25**;APR 24, 1997
"RTN","IBDF2F",3,0)
 ;
"RTN","IBDF2F",4,0)
LNPRINT(IBPFID) ;prints the form
"RTN","IBDF2F",5,0)
 ;IBPFID is the id for form tracking
"RTN","IBDF2F",6,0)
 ;
"RTN","IBDF2F",7,0)
 N CURY,CURX,NXTTXT,NXTX,LINE,NXTUL,PERPAGE,STRING,STARTY,PAGE
"RTN","IBDF2F",8,0)
 S PAGE=1
"RTN","IBDF2F",9,0)
 ;
"RTN","IBDF2F",10,0)
 ;determine if simplex or duplex
"RTN","IBDF2F",11,0)
 ;
"RTN","IBDF2F",12,0)
 D
"RTN","IBDF2F",13,0)
 .I IBFORM("PRINT_MODE")="DUPLEX_LONG",IBDEVICE("DUPLEX_LONG")]"" W IBDEVICE("DUPLEX_LONG") Q
"RTN","IBDF2F",14,0)
 .I IBFORM("PRINT_MODE")="DUPLEX_SHORT",IBDEVICE("DUPLEX_SHORT")]"" W IBDEVICE("DUPLEX_SHORT") Q
"RTN","IBDF2F",15,0)
 .I IBDEVICE("SIMPLEX")]"" W IBDEVICE("SIMPLEX") Q
"RTN","IBDF2F",16,0)
 .I $Y W @IOF
"RTN","IBDF2F",17,0)
 ;
"RTN","IBDF2F",18,0)
 S PERPAGE=IBFORM("PAGE_HT")
"RTN","IBDF2F",19,0)
 I 'PERPAGE!(PERPAGE>IOSL) S PERPAGE=IOSL
"RTN","IBDF2F",20,0)
 S NXTUL=$O(@IBARRAY("UNDERLINES")@("")),NXTTXT=$O(@IBARRAY("TEXT")@(""))
"RTN","IBDF2F",21,0)
 S STARTY=""
"RTN","IBDF2F",22,0)
 S:NXTTXT'="" LINE=$G(@IBARRAY("TEXT")@(NXTTXT))
"RTN","IBDF2F",23,0)
 ;
"RTN","IBDF2F",24,0)
 ;want this rectangular fill area to apply to underlining
"RTN","IBDF2F",25,0)
 W:IBDEVICE("PCL") $C(27)_"*c35G"
"RTN","IBDF2F",26,0)
 ;
"RTN","IBDF2F",27,0)
 D REGISTER^IBDF2F1(PAGE)
"RTN","IBDF2F",28,0)
 F CURY=0:1 D  I NXTUL'>0,NXTTXT'>0 Q
"RTN","IBDF2F",29,0)
 .I (CURY>0)&('(CURY#PERPAGE)) D
"RTN","IBDF2F",30,0)
 ..I ((NXTTXT'="")!(NXTUL'="")) D
"RTN","IBDF2F",31,0)
 ...D:IBDEVICE("GRAPHICS")&('IBDEVICE("PCL")) PGRPHCS(.STARTY,CURY)
"RTN","IBDF2F",32,0)
 ...D:IBDEVICE("PCL") DRAW(.STARTY,CURY),WHITEOUT
"RTN","IBDF2F",33,0)
 ...W:$G(IBDEVICE("TCP")) ! ;if TCP device must use ! to get to TOF
"RTN","IBDF2F",34,0)
 ...W:'$G(IBDEVICE("TCP")) @IOF
"RTN","IBDF2F",35,0)
 ...S PAGE=PAGE+1
"RTN","IBDF2F",36,0)
 ...D REGISTER^IBDF2F1(PAGE)
"RTN","IBDF2F",37,0)
 .E  I (CURY#PERPAGE) W !
"RTN","IBDF2F",38,0)
 .I CURY=NXTTXT D
"RTN","IBDF2F",39,0)
 ..S CURX=0,NXTX="" F  S NXTX=$O(@IBARRAY("CONTROLS")@(NXTTXT,NXTX)) Q:NXTX=""  D
"RTN","IBDF2F",40,0)
 ...W $E(LINE,+CURX,NXTX),$$CTRLS^IBDFU($G(@IBARRAY("CONTROLS")@(NXTTXT,NXTX)),NXTX,NXTTXT#PERPAGE)
"RTN","IBDF2F",41,0)
 ...S CURX=NXTX+1
"RTN","IBDF2F",42,0)
 ..S STRING=$E(LINE,CURX,240) W:STRING'="" STRING
"RTN","IBDF2F",43,0)
 ..S NXTTXT=$O(@IBARRAY("TEXT")@(NXTTXT)) S:NXTTXT LINE=$G(@IBARRAY("TEXT")@(NXTTXT))
"RTN","IBDF2F",44,0)
 .I CURY=NXTUL D UNDRLINE
"RTN","IBDF2F",45,0)
 ;
"RTN","IBDF2F",46,0)
 ;draw stuff requiring graphics mode - obsoleted by PCL, if available
"RTN","IBDF2F",47,0)
 D:IBDEVICE("GRAPHICS")&('IBDEVICE("PCL")) PGRPHCS(STARTY,0)
"RTN","IBDF2F",48,0)
 ;
"RTN","IBDF2F",49,0)
 ;draw boxes,bubbles, etc. that require PCL
"RTN","IBDF2F",50,0)
 D:IBDEVICE("PCL") DRAW(STARTY,0),WHITEOUT
"RTN","IBDF2F",51,0)
 ;
"RTN","IBDF2F",52,0)
 W:'$G(IBDEVICE("TCP")) @IOF
"RTN","IBDF2F",53,0)
 ;go back to simplex
"RTN","IBDF2F",54,0)
 D
"RTN","IBDF2F",55,0)
 .I IBFORM("PRINT_MODE")="DUPLEX_LONG",IBDEVICE("DUPLEX_LONG")]"",IBDEVICE("SIMPLEX")]"" W IBDEVICE("SIMPLEX") Q
"RTN","IBDF2F",56,0)
 .I IBFORM("PRINT_MODE")="DUPLEX_SHORT",IBDEVICE("DUPLEX_SHORT")]"",IBDEVICE("SIMPLEX")]"" W IBDEVICE("SIMPLEX")
"RTN","IBDF2F",57,0)
 ;
"RTN","IBDF2F",58,0)
 ;set the printer for other stuff to print
"RTN","IBDF2F",59,0)
 S X=IOM X $G(^%ZOSF("RM")) K X ;sets device to wrap
"RTN","IBDF2F",60,0)
 ;set the printer to 132 col for everything else to print
"RTN","IBDF2F",61,0)
 I IBDEVICE("PCL") D
"RTN","IBDF2F",62,0)
 .W $C(27),"E"
"RTN","IBDF2F",63,0)
 .I $G(IBDEVICE("RESET"))'="" W @IBDEVICE("RESET")
"RTN","IBDF2F",64,0)
 .W $C(27),"(s0p16.67h8.5v0s0b0T",!,$C(27),"&l6C" S IOSL=80
"RTN","IBDF2F",65,0)
 Q
"RTN","IBDF2F",66,0)
 ;
"RTN","IBDF2F",67,0)
UNDRLINE ;
"RTN","IBDF2F",68,0)
 Q:IBDEVICE("CRT")
"RTN","IBDF2F",69,0)
 N UL
"RTN","IBDF2F",70,0)
 S UL=$G(@IBARRAY("UNDERLINES")@(NXTUL))
"RTN","IBDF2F",71,0)
 I 'IBDEVICE("PCL") D
"RTN","IBDF2F",72,0)
 .W:UL'="" $C(13),UL
"RTN","IBDF2F",73,0)
 ;do it a bit differently if IBDEVICE("PCL")
"RTN","IBDF2F",74,0)
 I IBDEVICE("PCL") D
"RTN","IBDF2F",75,0)
 .W:UL'="" $C(13),$C(27)_"*v2t1n0O",UL,$C(27)_"*v0T"
"RTN","IBDF2F",76,0)
 .;!!!!!!!!! with the area fill command - needed? see above
"RTN","IBDF2F",77,0)
 .;W:UL'="" $C(13),$C(27)_"*c35G",$C(27)_"*v2t1n0O",UL,$C(27)_"*v0T"
"RTN","IBDF2F",78,0)
 S NXTUL=$O(@IBARRAY("UNDERLINES")@(NXTUL))
"RTN","IBDF2F",79,0)
 Q
"RTN","IBDF2F",80,0)
PGRPHCS(STARTY,LASTY) ;print graphics - only for raster devices
"RTN","IBDF2F",81,0)
 N DX,DY,GRPHCS,LINE
"RTN","IBDF2F",82,0)
 W IOG1
"RTN","IBDF2F",83,0)
 S (DX,DY)=0 X IOXY
"RTN","IBDF2F",84,0)
 S LINE=STARTY F  S LINE=$O(@IBARRAY("GRAPHICS")@(LINE)) Q:(LINE="")!($G(LASTY)&(LINE'<LASTY))  D
"RTN","IBDF2F",85,0)
 .S DX="" F  S DX=$O(@IBARRAY("GRAPHICS")@(LINE,DX)) Q:DX=""  S GRPHCS=$G(@IBARRAY("GRAPHICS")@(LINE,DX)),GRPHCS=$$GRPHCS^IBDFU(GRPHCS) I GRPHCS'="" S DY=LINE#PERPAGE W ! X IOXY W GRPHCS
"RTN","IBDF2F",86,0)
 S STARTY=LASTY-1
"RTN","IBDF2F",87,0)
 W IOG0
"RTN","IBDF2F",88,0)
 Q
"RTN","IBDF2F",89,0)
 ;
"RTN","IBDF2F",90,0)
DRAW(STARTY,LASTY) ; draws the objects needing HP-GL/2 
"RTN","IBDF2F",91,0)
 N ROW,COL,BLK,NODE,WIDTH,HT,IEN,PRNTTYPE,PWPARAM,FIPARAM
"RTN","IBDF2F",92,0)
 W $C(27),"*p0x0Y"
"RTN","IBDF2F",93,0)
 W $C(27),"*c5760x7200Y"
"RTN","IBDF2F",94,0)
 W $C(27),"*c0T"
"RTN","IBDF2F",95,0)
 W $C(27),"%1B"
"RTN","IBDF2F",96,0)
 W "IN;SP1;"
"RTN","IBDF2F",97,0)
 W "SC0,5760,7200,0;" ;sets up the coordinate system same as PCL
"RTN","IBDF2F",98,0)
 W "AD3,16.6;" ;sets the alternate font for the labels
"RTN","IBDF2F",99,0)
 ;
"RTN","IBDF2F",100,0)
 ;draw bubbles
"RTN","IBDF2F",101,0)
 ;W "PW.12;" ;set pen width to .12 mm, patch 3 value
"RTN","IBDF2F",102,0)
 ;W "SV1,25;" ;set fill to 25%, patch 3 value
"RTN","IBDF2F",103,0)
 S PWPARAM=$P($G(^IBD(357.09,1,0)),"^",13)
"RTN","IBDF2F",104,0)
 I PWPARAM="" S PWPARAM=12
"RTN","IBDF2F",105,0)
 S FIPARAM=$P($G(^IBD(357.09,1,0)),"^",14)
"RTN","IBDF2F",106,0)
 I FIPARAM="" S FIPARAM=25
"RTN","IBDF2F",107,0)
 W "PW."_PWPARAM_";" ;set pen width param to file value
"RTN","IBDF2F",108,0)
 W "SV1,"_FIPARAM_";" ;set the fill to file value
"RTN","IBDF2F",109,0)
 ;
"RTN","IBDF2F",110,0)
 S ROW=STARTY
"RTN","IBDF2F",111,0)
 F  S ROW=$O(@IBARRAY("BUBBLES")@(ROW)) Q:(ROW="")!($G(LASTY)&(ROW'<LASTY))  S COL="" F  S COL=$O(@IBARRAY("BUBBLES")@(ROW,COL)) Q:COL=""  D DRWBBL(ROW#PERPAGE,COL)
"RTN","IBDF2F",112,0)
 ;
"RTN","IBDF2F",113,0)
 ;draw boxes
"RTN","IBDF2F",114,0)
 W "PW.4;" ;set pen width to .4 mm
"RTN","IBDF2F",115,0)
 W "SV1,100;"  ;set the fill to 100%
"RTN","IBDF2F",116,0)
 S ROW=STARTY
"RTN","IBDF2F",117,0)
 F  S ROW=$O(@IBARRAY("BOXES")@(ROW)) Q:(ROW="")!($G(LASTY)&(ROW'<(LASTY)))  S COL="" F  S COL=$O(@IBARRAY("BOXES")@(ROW,COL)) Q:COL=""  S BLK=0 F  S BLK=$O(@IBARRAY("BOXES")@(ROW,COL,BLK)) Q:'BLK  D
"RTN","IBDF2F",118,0)
 .S NODE=$G(@IBARRAY("BOXES")@(ROW,COL,BLK)) S WIDTH=$P(NODE,"^"),HT=$P(NODE,"^",2) D DRWBOX(ROW#PERPAGE,COL,WIDTH,HT)
"RTN","IBDF2F",119,0)
 ;
"RTN","IBDF2F",120,0)
 ;draw hand print fields
"RTN","IBDF2F",121,0)
 ;W "PW.12;" ;set pen width to .12 mm, patch 3 value
"RTN","IBDF2F",122,0)
 ;W "SV1,25;" ;set the fill to 25%, patch 3 value
"RTN","IBDF2F",123,0)
 S PWPARAM=$P($G(^IBD(357.09,1,0)),"^",13)
"RTN","IBDF2F",124,0)
 I PWPARAM="" S PWPARAM=12
"RTN","IBDF2F",125,0)
 S FIPARAM=$P($G(^IBD(357.09,1,0)),"^",14)
"RTN","IBDF2F",126,0)
 I FIPARAM="" S FIPARAM=25
"RTN","IBDF2F",127,0)
 W "PW."_PWPARAM_";" ;set pen width param to file value
"RTN","IBDF2F",128,0)
 W "SV1,"_FIPARAM_";" ;set the fill to file value
"RTN","IBDF2F",129,0)
 ;
"RTN","IBDF2F",130,0)
 S ROW=STARTY
"RTN","IBDF2F",131,0)
 F  S ROW=$O(@IBARRAY("HAND_PRINT")@(ROW)) Q:(ROW="")!($G(LASTY)&(ROW'<LASTY))  S COL="" F  S COL=$O(@IBARRAY("HAND_PRINT")@(ROW,COL)) Q:COL=""  S IEN=0 F  S IEN=$O(@IBARRAY("HAND_PRINT")@(ROW,COL,IEN)) Q:'IEN  D
"RTN","IBDF2F",132,0)
 .S NODE=$G(@IBARRAY("HAND_PRINT")@(ROW,COL,IEN)),WIDTH=+$P(NODE,"^",3),PRNTTYPE=$P(NODE,"^",14) Q:('WIDTH)!('PRNTTYPE)
"RTN","IBDF2F",133,0)
 .D HANDPRNT(ROW#PERPAGE,COL,WIDTH,$P(NODE,"^",6),PRNTTYPE,$P(NODE,"^",17))
"RTN","IBDF2F",134,0)
 ;
"RTN","IBDF2F",135,0)
 S STARTY=LASTY-1
"RTN","IBDF2F",136,0)
 W $C(27),"%0A"
"RTN","IBDF2F",137,0)
 Q
"RTN","IBDF2F",138,0)
 ;
"RTN","IBDF2F",139,0)
DRWBBL(Y,X) ;
"RTN","IBDF2F",140,0)
 ; -- position is in terms of col,row - change to decipoints
"RTN","IBDF2F",141,0)
 S Y=(Y*IBDEVICE("ROW_HT"))+$S(IBFORM("WIDTH")>96:20,IBFORM("WIDTH")>80:30,1:40),X=(X+$S(IBFORM("WIDTH")>96:.5,IBFORM("WIDTH")>80:.75,1:1))*IBDEVICE("COL_WIDTH")
"RTN","IBDF2F",142,0)
 ;
"RTN","IBDF2F",143,0)
 ; -- position the pen
"RTN","IBDF2F",144,0)
 W "PA"_(X)_","_(Y)_";"
"RTN","IBDF2F",145,0)
 ;
"RTN","IBDF2F",146,0)
 ; -- draw the bubble (a little box)
"RTN","IBDF2F",147,0)
 W "EA"_(X+87)_","_(Y+45)_";"
"RTN","IBDF2F",148,0)
 Q
"RTN","IBDF2F",149,0)
 ;
"RTN","IBDF2F",150,0)
DRWBOX(Y,X,WIDTH,HT) ;
"RTN","IBDF2F",151,0)
 ; -- position is in terms of col,row - change to decipoints
"RTN","IBDF2F",152,0)
 S Y=((Y+.75)*IBDEVICE("ROW_HT"))+15,X=(X+.5)*IBDEVICE("COL_WIDTH")
"RTN","IBDF2F",153,0)
 ;
"RTN","IBDF2F",154,0)
 ;position the pen
"RTN","IBDF2F",155,0)
 W "PA"_(X)_","_(Y)_";"
"RTN","IBDF2F",156,0)
 ;
"RTN","IBDF2F",157,0)
 ;draw the box
"RTN","IBDF2F",158,0)
 W "EA"_(X+((WIDTH-1)*IBDEVICE("COL_WIDTH")))_","_(Y+((HT-1.7)*IBDEVICE("ROW_HT")))_";"
"RTN","IBDF2F",159,0)
 Q
"RTN","IBDF2F",160,0)
 ;
"RTN","IBDF2F",161,0)
HANDPRNT(Y,X,WIDTH,LINES,PRNTTYPE,TYPEDATA) ; draw hand print area
"RTN","IBDF2F",162,0)
 ; -- FORMAT - contains overlay for the field
"RTN","IBDF2F",163,0)
 ; -- UNIT - label to print on the right of print area
"RTN","IBDF2F",164,0)
 ; -- PRNTTYPE = could be for ICR (print comb) or not ICR (no comb, different size)
"RTN","IBDF2F",165,0)
 N CHAR,FORMAT,UNIT,NODE
"RTN","IBDF2F",166,0)
 S NODE=""
"RTN","IBDF2F",167,0)
 I $G(TYPEDATA) S NODE=$G(^IBE(359.1,TYPEDATA,0))
"RTN","IBDF2F",168,0)
 ;S FORMAT=$$FRMT(NODE,$G(IBAPPT)),UNIT=$P(NODE,"^",11) ;don't use frmt here, cause pre-slugging of data and read when scanning
"RTN","IBDF2F",169,0)
 S FORMAT=$P(NODE,"^",5),UNIT=$P(NODE,"^",11)
"RTN","IBDF2F",170,0)
 S:LINES'>0 LINES=1
"RTN","IBDF2F",171,0)
 I PRNTTYPE=2 D
"RTN","IBDF2F",172,0)
 .;change scale from col,row to decipoints
"RTN","IBDF2F",173,0)
 .S Y=(Y*IBDEVICE("ROW_HT"))+$S(IBFORM("WIDTH")>96:0,IBFORM("WIDTH")>80:15,1:30),X=X*IBDEVICE("COL_WIDTH")
"RTN","IBDF2F",174,0)
 .F  Q:LINES'>0  D  S LINES=LINES-1,Y=Y+(2*IBDEVICE("ROW_HT"))
"RTN","IBDF2F",175,0)
 ..;position the pen
"RTN","IBDF2F",176,0)
 ..W !,"PA"_(X)_","_(Y)_";"
"RTN","IBDF2F",177,0)
 ..;draw the box
"RTN","IBDF2F",178,0)
 ..W "EA"_(X+(172.7654*WIDTH))_","_(Y+(180))_";"
"RTN","IBDF2F",179,0)
 ..;print the unit of measurement
"RTN","IBDF2F",180,0)
 ..I $L(UNIT) W "SA;","PA"_(X+50+(172.7654*WIDTH))_",",(Y+(120))_";","LB",UNIT,$CHAR(3),"SS;"
"RTN","IBDF2F",181,0)
 ..;draw the comb
"RTN","IBDF2F",182,0)
 ..N I F I=1:1:WIDTH-1 W "PA"_(X+(172.7654*I))_",",(Y+(180))_";PD;PR0,-180;PU" S CHAR=$E(FORMAT,I+1) I CHAR'="",CHAR'="_" D
"RTN","IBDF2F",183,0)
 ...;character pre-slug
"RTN","IBDF2F",184,0)
 ...W !,"PA"_(X+50+(172.7654*I))_",",(Y+(120))_";"
"RTN","IBDF2F",185,0)
 ...W "LB",CHAR,$CHAR(3)
"RTN","IBDF2F",186,0)
 ;
"RTN","IBDF2F",187,0)
 I PRNTTYPE=1 D
"RTN","IBDF2F",188,0)
 .;change scale from col,row to decipoints
"RTN","IBDF2F",189,0)
 .S Y=(Y*IBDEVICE("ROW_HT")),X=X*IBDEVICE("COL_WIDTH")
"RTN","IBDF2F",190,0)
 .D CNVRTHT^IBDF2D1(LINES,.LINES)
"RTN","IBDF2F",191,0)
 .;position the pen
"RTN","IBDF2F",192,0)
 .W "PA"_(X)_","_(Y)_";"
"RTN","IBDF2F",193,0)
 .;draw the box
"RTN","IBDF2F",194,0)
 .W "EA"_(X+(103.6593*WIDTH))_","_(Y+(IBDEVICE("ROW_HT")*LINES))_";"
"RTN","IBDF2F",195,0)
 Q
"RTN","IBDF2F",196,0)
 ;
"RTN","IBDF2F",197,0)
FRMT(ND,ADT) ; -- function returns piece 5 on entries from 359.1
"RTN","IBDF2F",198,0)
 ; -- reformats the Checkout/date format for y2k
"RTN","IBDF2F",199,0)
 ; -- input    nd  := zero node from 359.1 for entry
"RTN","IBDF2F",200,0)
 ;            adt  := alternate date (appointment date, when known)
"RTN","IBDF2F",201,0)
 N FRMT
"RTN","IBDF2F",202,0)
 S FRMT=$P(ND,"^",5)
"RTN","IBDF2F",203,0)
 I $P(ND,"^")="CHECKOUT DATE@TIME" S $E(FRMT,5)=$S($G(ADT):$E(ADT,2),1:$E(DT,2))
"RTN","IBDF2F",204,0)
 Q FRMT
"RTN","IBDF2F",205,0)
 ;
"RTN","IBDF2F",206,0)
WHITEOUT ; -- puts white space around the anchors
"RTN","IBDF2F",207,0)
 ;            helps insure that the anchors can be located
"RTN","IBDF2F",208,0)
 ;
"RTN","IBDF2F",209,0)
 Q:'IBFORM("SCAN")  ;if the form isn't scannable there are no anchors
"RTN","IBDF2F",210,0)
 ;
"RTN","IBDF2F",211,0)
 W $C(27),"&a0v0H",! ;set top margin to top of page
"RTN","IBDF2F",212,0)
 W $C(27),"&l0E"
"RTN","IBDF2F",213,0)
 ;
"RTN","IBDF2F",214,0)
 ; -- top left corner (ANCHOR 1)
"RTN","IBDF2F",215,0)
 W $C(27),"&a354v4H",$C(27),"*c200h60v1P"
"RTN","IBDF2F",216,0)
 ;
"RTN","IBDF2F",217,0)
 ; -- bottom left (ANCHOR 2)
"RTN","IBDF2F",218,0)
 W $C(27),"&a7505v4H",$C(27),"*c200h60v1P"
"RTN","IBDF2F",219,0)
 ;
"RTN","IBDF2F",220,0)
 ; -- top right (ANCHOR 3)
"RTN","IBDF2F",221,0)
 W $C(27),"&a354v5450H",$C(27),"*c400h60v1P"
"RTN","IBDF2F",222,0)
 ;
"RTN","IBDF2F",223,0)
 ; -- bottom right (ANCHOR 4)
"RTN","IBDF2F",224,0)
 W $C(27),"&a7505v5450H",$C(27),"*c400h60v1P"
"RTN","IBDF2F",225,0)
 Q
"RTN","IBDF2H")
0^21^B1836800
"RTN","IBDF2H",1,0)
IBDF2H ;ALB/CJM - ENCOUNTER FORM - (prints hand print field);07/20/94
"RTN","IBDF2H",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**25**;APR 24, 1997
"RTN","IBDF2H",3,0)
 ;
"RTN","IBDF2H",4,0)
HFLD(FIELD) ;for printing the input field=FIELD
"RTN","IBDF2H",5,0)
 N BLOCK,LABEL,ROW,COL,NODE,DISP,FNAME,FID,TYPEDATA,PI,FORMAT,WIDTH,UNIT
"RTN","IBDF2H",6,0)
 Q:'$G(FIELD)
"RTN","IBDF2H",7,0)
 S NODE=$G(^IBE(359.94,FIELD,0))
"RTN","IBDF2H",8,0)
 S BLOCK=$P(NODE,"^",8)
"RTN","IBDF2H",9,0)
 ;if the input field does not belong to the right block, reindex it and quit
"RTN","IBDF2H",10,0)
 I BLOCK'=IBBLK K DA S DA=FIELD,DIK="^IBE(359.94," D IX^DIK K DIK Q
"RTN","IBDF2H",11,0)
 S PI=$P(NODE,"^",6)
"RTN","IBDF2H",12,0)
 S COL=$P(NODE,"^",3)
"RTN","IBDF2H",13,0)
 S ROW=$P(NODE,"^",4)
"RTN","IBDF2H",14,0)
 S LABEL=$P(NODE,"^",2)
"RTN","IBDF2H",15,0)
 S DISP=$P(NODE,"^",5)
"RTN","IBDF2H",16,0)
 S TYPEDATA=$P(NODE,"^",10)
"RTN","IBDF2H",17,0)
 S FNAME=$P(NODE,"^")
"RTN","IBDF2H",18,0)
 S FID="H"_FIELD
"RTN","IBDF2H",19,0)
 D DRWSTR^IBDFU(+ROW,+COL,LABEL,DISP)
"RTN","IBDF2H",20,0)
 ;
"RTN","IBDF2H",21,0)
 I TYPEDATA S NODE=$G(^IBE(359.1,TYPEDATA,0)) S FORMAT=$$FRMT^IBDF2F(NODE,$G(IBAPPT)),WIDTH=$P(NODE,"^",6),UNIT=$P(NODE,"^",11)
"RTN","IBDF2H",22,0)
 D DRWHAND^IBDFM1(ROW,COL+$L(LABEL)+1,WIDTH,PI,1,FID,FNAME,LABEL,"",1,2,2,TYPEDATA)
"RTN","IBDF2H",23,0)
 Q
"RTN","IBDFBKS")
0^7^B49485041
"RTN","IBDFBKS",1,0)
IBDFBKS ;ALB/CJM/AAS - Create form spec file for scanning ; 6-JUN-95
"RTN","IBDFBKS",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**25**;APR 24, 1997
"RTN","IBDFBKS",3,0)
 ;
"RTN","IBDFBKS",4,0)
SCAN(IBFORMID) ;
"RTN","IBDFBKS",5,0)
 ;
"RTN","IBDFBKS",6,0)
 Q:'$G(IBFORMID)
"RTN","IBDFBKS",7,0)
 N IBLC,PERPAGE,PAGE,ROW,COL,PAGESIZE,SCAN,ARY,X,Y,ROWHT,ROWWIDTH,CONVERT,COUNT,LINE,TAG,NAME,XOFFSET,YOFFSET,NODE,FID,TYPE,XBUBOS,YBUBOS,COUNT,YHANDOS,FIELD,IEN,QLFR,PRIORPAG,END,LN,FIELDS,IBDFILL,IBDBKGND,XYSMALL
"RTN","IBDFBKS",8,0)
 ;XOFFSET,YOFFSET are the page margins (in decipoints)
"RTN","IBDFBKS",9,0)
 ;XBUBOS,YBUBOS are the offsets within the col,row of the bubbles
"RTN","IBDFBKS",10,0)
 ;YHANDOS is the offset for a handprint field within the row
"RTN","IBDFBKS",11,0)
 ;
"RTN","IBDFBKS",12,0)
 I '$D(DT) D DT^DICRW
"RTN","IBDFBKS",13,0)
 I $D(^IBD(359.2,IBFORMID,0)),$D(^IBD(357.95,IBFORMID,0)) S DIK="^IBD(359.2,",DA=IBFORMID D ^DIK
"RTN","IBDFBKS",14,0)
 I '$D(DT) D DT^DICRW
"RTN","IBDFBKS",15,0)
 S IBLC=0
"RTN","IBDFBKS",16,0)
 D PARAM
"RTN","IBDFBKS",17,0)
 S CONVERT=.352778 ;for converting PCL decipoints to .1mm
"RTN","IBDFBKS",18,0)
 ; This number is actually 254/720 ... 254 PK points (.1 mm) = 1 inch
"RTN","IBDFBKS",19,0)
 ;                                     720 PCL5 decipoints = 1 inch
"RTN","IBDFBKS",20,0)
 ;     A PCL5 decipoint = .352778 PK points
"RTN","IBDFBKS",21,0)
 S SCAN="^TMP(""IBDF"",$J,""SCAN"",IBFORMID)"
"RTN","IBDFBKS",22,0)
 K @SCAN
"RTN","IBDFBKS",23,0)
 ;
"RTN","IBDFBKS",24,0)
 S FIELDS="^TMP(""IBDF"",$J,""FIELDS"")"
"RTN","IBDFBKS",25,0)
 K @FIELDS
"RTN","IBDFBKS",26,0)
 ;
"RTN","IBDFBKS",27,0)
 ;get form description
"RTN","IBDFBKS",28,0)
 S NODE=$G(^IBD(357.95,IBFORMID,0))
"RTN","IBDFBKS",29,0)
 Q:NODE=""
"RTN","IBDFBKS",30,0)
 S PERPAGE=$P(NODE,"^",10)
"RTN","IBDFBKS",31,0)
 ;determine sizes and offsets - in terms of PCL decipoints
"RTN","IBDFBKS",32,0)
 S XOFFSET=180 ; This is 1/4 inch ... .25*720 PCL decipoints
"RTN","IBDFBKS",33,0)
 S YOFFSET=360 ; This is 1/2 inch ... .5*720 PCL decipoints
"RTN","IBDFBKS",34,0)
 ; rowht = # of PCL decipoints/line in height
"RTN","IBDFBKS",35,0)
 ;   80 lines (133 Col) = 720/8 lines per inch)
"RTN","IBDFBKS",36,0)
 ;   72 lines (96 Col) = 720/7.2 lines per inch)
"RTN","IBDFBKS",37,0)
 ;   60 lines (80 Col) = 720/6 lines per inch)
"RTN","IBDFBKS",38,0)
 S ROWHT=$P(NODE,"^",10),ROWHT=$S(ROWHT>72:90,ROWHT>60:100.0005,1:120)
"RTN","IBDFBKS",39,0)
 S COLWIDTH=$P(NODE,"^",9)
"RTN","IBDFBKS",40,0)
 S XBUBOS=$S(COLWIDTH>96:.5,COLWIDTH>80:.75,1:1) ;leaves offset in terms of fraction of column width - must still convert to decipoints
"RTN","IBDFBKS",41,0)
 S YBUBOS=$S(COLWIDTH>96:65,COLWIDTH>80:75,1:85)
"RTN","IBDFBKS",42,0)
 ; colwidth = # of PCL decipoints/character in width
"RTN","IBDFBKS",43,0)
 ;   133 Col = 720/16.67 char per inch
"RTN","IBDFBKS",44,0)
 ;   96 Col = 720/12 char per inch
"RTN","IBDFBKS",45,0)
 ;   80 Col = 720/10 char per inch
"RTN","IBDFBKS",46,0)
 S COLWIDTH=$S(COLWIDTH>96:(720/16.67),COLWIDTH>80:60,1:72) ;converted to decipoints
"RTN","IBDFBKS",47,0)
 S XBUBOS=XBUBOS*COLWIDTH ;converted to decipoints
"RTN","IBDFBKS",48,0)
 S YHANDOS=$S(ROWHT=90:0,ROWHT=100.0005:15,1:30)
"RTN","IBDFBKS",49,0)
 ;
"RTN","IBDFBKS",50,0)
 ;get the list of scannable pages
"RTN","IBDFBKS",51,0)
 S IEN=0 F  S IEN=$O(^IBD(357.95,IBFORMID,3,IEN)) Q:'IEN  S NODE=$G(^IBD(357.95,IBFORMID,3,IEN,0)) S:$P(NODE,"^",2) PAGE(+NODE)=""
"RTN","IBDFBKS",52,0)
 ;
"RTN","IBDFBKS",53,0)
 ;
"RTN","IBDFBKS",54,0)
 S PAGE=0 F  S PAGE=$O(PAGE(PAGE)) Q:'PAGE  D
"RTN","IBDFBKS",55,0)
 .;
"RTN","IBDFBKS",56,0)
 .;list all the bubbles
"RTN","IBDFBKS",57,0)
 .S ROW=((PAGE-1)*PERPAGE)-1
"RTN","IBDFBKS",58,0)
 .S ARY="^IBD(357.95,""AC"","_IBFORMID_")"
"RTN","IBDFBKS",59,0)
 .F  S ROW=$O(@ARY@(ROW)) Q:ROW=""  D
"RTN","IBDFBKS",60,0)
 ..Q:(ROW\PERPAGE)+1'=PAGE
"RTN","IBDFBKS",61,0)
 ..S COL="" F  S COL=$O(@ARY@(ROW,COL)) Q:COL=""  S IEN=0 F  S IEN=$O(@ARY@(ROW,COL,IEN)) Q:'IEN  D
"RTN","IBDFBKS",62,0)
 ...S NODE=$G(^IBD(357.95,IBFORMID,1,IEN,0))
"RTN","IBDFBKS",63,0)
 ...Q:($P(NODE,"^",6)="")!(($P(NODE,"^",4)="")&($P(NODE,"^",8)=""))!('$P(NODE,"^",3))
"RTN","IBDFBKS",64,0)
 ...S NAME=$E($P(NODE,"^",5),1,17),QLFR=$P(NODE,"^",10)
"RTN","IBDFBKS",65,0)
 ...S TYPE=$P(NODE,"^",7)
"RTN","IBDFBKS",66,0)
 ...I (TYPE=0)!(TYPE=3) S:QLFR QLFR=$P($G(^IBD(357.98,QLFR,0)),"^",3)
"RTN","IBDFBKS",67,0)
 ...I (TYPE=1)!(TYPE=2) S:QLFR QLFR=$E($P($G(^IBD(357.98,QLFR,0)),"^"),1,12)
"RTN","IBDFBKS",68,0)
 ...I QLFR'="" S NAME=NAME_"("_QLFR_")"
"RTN","IBDFBKS",69,0)
 ...I QLFR="" S NAME=NAME_"-"
"RTN","IBDFBKS",70,0)
 ...S @SCAN@(PAGE,$P(NODE,"^",6),+$P(NODE,"^",7),COL,(ROW-((PAGE-1)*PERPAGE)),IEN)=$P(NODE,"^",3,12)
"RTN","IBDFBKS",71,0)
 ...S @SCAN@(PAGE,$P(NODE,"^",6))=NAME
"RTN","IBDFBKS",72,0)
 ...;
"RTN","IBDFBKS",73,0)
 .;
"RTN","IBDFBKS",74,0)
 .;list all the handprint fields
"RTN","IBDFBKS",75,0)
 .S ARY="^IBD(357.95,""AD"","_IBFORMID_")"
"RTN","IBDFBKS",76,0)
 .S ROW=((PAGE-1)*PERPAGE)-1
"RTN","IBDFBKS",77,0)
 .F  S ROW=$O(@ARY@(ROW)) Q:ROW=""  D
"RTN","IBDFBKS",78,0)
 ..Q:(ROW\PERPAGE)+1'=PAGE
"RTN","IBDFBKS",79,0)
 ..S COL="" F  S COL=$O(@ARY@(ROW,COL)) Q:COL=""  S IEN=0 F  S IEN=$O(@ARY@(ROW,COL,IEN)) Q:'IEN  D
"RTN","IBDFBKS",80,0)
 ...S NODE=$G(^IBD(357.95,IBFORMID,2,IEN,0))
"RTN","IBDFBKS",81,0)
 ...Q:($P(NODE,"^",8)="")!('$P(NODE,"^",4))!('$P(NODE,"^",15))
"RTN","IBDFBKS",82,0)
 ...S @SCAN@(PAGE,$P(NODE,"^",8),6,COL,(ROW-((PAGE-1)*PERPAGE)),IEN)=$P(NODE,"^",3,17),NAME=$E($P(NODE,"^",5),1,15)
"RTN","IBDFBKS",83,0)
 ...I $P(NODE,"^",17) S NAME=NAME_"("_$P($G(^IBE(359.1,$P(NODE,"^",17),0)),"^")_")"
"RTN","IBDFBKS",84,0)
 ...S @SCAN@(PAGE,$P(NODE,"^",8))=NAME
"RTN","IBDFBKS",85,0)
 ;
"RTN","IBDFBKS",86,0)
 ;make form description
"RTN","IBDFBKS",87,0)
 F COUNT=1:1 S LINE=$T(FORM+COUNT^IBDFBKS1),TAG=$P(LINE,";;"),LINE=$P(LINE,";;",2) Q:TAG["QUIT"  D
"RTN","IBDFBKS",88,0)
 .N PG
"RTN","IBDFBKS",89,0)
 .D BLDARY("")
"RTN","IBDFBKS",90,0)
 .I TAG["NAME" S IBDFSA(IBLC)=IBDFSA(IBLC)_"  NAME = ""ENCOUNTER FORM "_IBFORMID_""";" Q
"RTN","IBDFBKS",91,0)
 .I TAG["SITE" S IBDFSA(IBLC)=IBDFSA(IBLC)_"'VA SITE = "_$P($$SITE^VASITE,"^",2),LINE=""
"RTN","IBDFBKS",92,0)
 .I TAG["PGCK" S IBDFSA(IBLC)=IBDFSA(IBLC)_"  else if ("  D  Q
"RTN","IBDFBKS",93,0)
 ..S PG=$O(PAGE(0))
"RTN","IBDFBKS",94,0)
 ..S IBDFSA(IBLC)=IBDFSA(IBLC)_"(page!="_PG_")"
"RTN","IBDFBKS",95,0)
 ..F  S PG=$O(PAGE(PG)) Q:'PG  S IBDFSA(IBLC)=IBDFSA(IBLC)_"&&(page!="_PG_")"
"RTN","IBDFBKS",96,0)
 ..S IBDFSA(IBLC)=IBDFSA(IBLC)_"){"
"RTN","IBDFBKS",97,0)
 .S IBDFSA(IBLC)=IBDFSA(IBLC)_LINE
"RTN","IBDFBKS",98,0)
 .;D BLDARY(LINE)
"RTN","IBDFBKS",99,0)
 ;
"RTN","IBDFBKS",100,0)
 ;make fields
"RTN","IBDFBKS",101,0)
 S PAGE=0,FIELD=9,PRIORPG=$O(@SCAN@(0)),LN=0,BLN=0
"RTN","IBDFBKS",102,0)
 F  S PAGE=$O(@SCAN@(PAGE)) D:PRIORPG'=PAGE PRINTEND^IBDFBKS3 Q:'PAGE  S FID="" F  S FID=$O(@SCAN@(PAGE,FID)) Q:FID=""  S TYPE=$O(@SCAN@(PAGE,FID,"")) Q:TYPE=""  D
"RTN","IBDFBKS",103,0)
 .S NAME=$G(@SCAN@(PAGE,FID))
"RTN","IBDFBKS",104,0)
 .;
"RTN","IBDFBKS",105,0)
 .; -- 1 = EXACTLY ONE, 2 = AT MOST ONE (0 or 1)
"RTN","IBDFBKS",106,0)
 .I (TYPE=1)!(TYPE=2) S FIELD=FIELD+1,@FIELDS@(PAGE,FIELD)="" D
"RTN","IBDFBKS",107,0)
 ..I TYPE=1 S NAME=NAME_" (1 Required)"
"RTN","IBDFBKS",108,0)
 ..I TYPE=2 S NAME=NAME_" (1 Optional)"
"RTN","IBDFBKS",109,0)
 ..S NAME=$$NAME(NAME)
"RTN","IBDFBKS",110,0)
 ..D BUBBLE^IBDFBKS3 Q
"RTN","IBDFBKS",111,0)
 .;
"RTN","IBDFBKS",112,0)
 .I TYPE=6 D  Q
"RTN","IBDFBKS",113,0)
 ..N OLDNAME S OLDNAME=NAME
"RTN","IBDFBKS",114,0)
 ..S COL="" F  S COL=$O(@SCAN@(PAGE,FID,TYPE,COL)) Q:COL=""  S ROW="" F  S ROW=$O(@SCAN@(PAGE,FID,TYPE,COL,ROW)) Q:ROW=""  S IEN=0 F  S IEN=$O(@SCAN@(PAGE,FID,TYPE,COL,ROW,IEN)) Q:'IEN  D
"RTN","IBDFBKS",115,0)
 ...S NAME=$$NAME(OLDNAME)
"RTN","IBDFBKS",116,0)
 ...;S IBDLAST=0 I $O(@SCAN@(PAGE,FID,TYPE,COL,ROW))="",$O(@SCAN@(PAGE,FID,TYPE,COL))="",$O(@SCAN@(PAGE,FID,TYPE))="" S IBDLAST=1
"RTN","IBDFBKS",117,0)
 ...S NODE=$G(@SCAN@(PAGE,FID,6,COL,ROW,IEN)) D HANDPRNT^IBDFBKS2(IEN,NAME,PAGE,ROW,COL,$P(NODE,"^",1),$P(NODE,"^",4),$P(NODE,"^",13),$P(NODE,"^",15),$P(NODE,"^",2))
"RTN","IBDFBKS",118,0)
 .;
"RTN","IBDFBKS",119,0)
 .;0 = ANY NUMBER
"RTN","IBDFBKS",120,0)
 .;3 = AT LEAST ONE (1 or more)
"RTN","IBDFBKS",121,0)
 .I (TYPE=0)!(TYPE=3) D
"RTN","IBDFBKS",122,0)
 ..N OLDNAME
"RTN","IBDFBKS",123,0)
 ..;I TYPE=3 N FIRST,LAST S LAST=FIELD+1,LAST=""
"RTN","IBDFBKS",124,0)
 ..I TYPE=3 N FIRST,LAST S FIRST=FIELD+1,LAST=""
"RTN","IBDFBKS",125,0)
 ..S COL="" F  S COL=$O(@SCAN@(PAGE,FID,TYPE,COL)) Q:COL=""  S ROW="" F  S ROW=$O(@SCAN@(PAGE,FID,TYPE,COL,ROW)) Q:ROW=""  S IEN=$O(@SCAN@(PAGE,FID,TYPE,COL,ROW,0)) D:IEN
"RTN","IBDFBKS",126,0)
 ...S FIELD=FIELD+1,@FIELDS@(PAGE,FIELD)="",NODE=$G(@SCAN@(PAGE,FID,TYPE,COL,ROW,IEN))
"RTN","IBDFBKS",127,0)
 ...S (NAME,OLDNAME)=$G(@SCAN@(PAGE,FID))
"RTN","IBDFBKS",128,0)
 ...S NAME=$$NAME(NAME)
"RTN","IBDFBKS",129,0)
 ...I TYPE=3,$O(@SCAN@(PAGE,FID,TYPE,COL,ROW))="",($O(@SCAN@(PAGE,FID,TYPE,COL))="") S LAST=FIELD
"RTN","IBDFBKS",130,0)
 ...D BUBBLE^IBDFBKS3
"RTN","IBDFBKS",131,0)
 ;
"RTN","IBDFBKS",132,0)
END ; -- end of routine
"RTN","IBDFBKS",133,0)
 K @SCAN
"RTN","IBDFBKS",134,0)
 K @FIELDS
"RTN","IBDFBKS",135,0)
 K ^TMP("IBDF-NAME",$J)
"RTN","IBDFBKS",136,0)
 S ^IBD(359.2,IBFORMID,10,IBLC,0)=IBDFSA(IBLC)
"RTN","IBDFBKS",137,0)
 S ^IBD(359.2,IBFORMID,10,0)="^^"_IBLC_"^"_IBLC_"^"_DT_"^"
"RTN","IBDFBKS",138,0)
 Q
"RTN","IBDFBKS",139,0)
 ;
"RTN","IBDFBKS",140,0)
NAME(NAME) ;
"RTN","IBDFBKS",141,0)
 ; -- make sure name is unique
"RTN","IBDFBKS",142,0)
 N X
"RTN","IBDFBKS",143,0)
 I (TYPE=0)!(TYPE=3) S NAME=NAME_" "_$P(NODE,"^",6) I TYPE=3
"RTN","IBDFBKS",144,0)
 I TYPE=1,NAME'["Required" S NAME=NAME_" Required"
"RTN","IBDFBKS",145,0)
 S X=$G(^TMP("IBDF-NAME",$J,NAME))+1
"RTN","IBDFBKS",146,0)
 S ^TMP("IBDF-NAME",$J,NAME)=+X
"RTN","IBDFBKS",147,0)
 I X>1 S NAME=NAME_"  #"_X
"RTN","IBDFBKS",148,0)
 Q NAME
"RTN","IBDFBKS",149,0)
 ;
"RTN","IBDFBKS",150,0)
BLDARY(TEXT) ;
"RTN","IBDFBKS",151,0)
 ; -- builds the export array IBDFS(linecount) = text
"RTN","IBDFBKS",152,0)
 N DIC,DA,DINUM,X,Y,I,J,DLAYGO
"RTN","IBDFBKS",153,0)
 I IBLC=1 D
"RTN","IBDFBKS",154,0)
 .S DIC="^IBD(359.2,",DIC(0)="L",DLAYGO=359.2,(DINUM,X)=IBFORMID D FILE^DICN
"RTN","IBDFBKS",155,0)
 .Q
"RTN","IBDFBKS",156,0)
 ;
"RTN","IBDFBKS",157,0)
 I IBLC>0 D
"RTN","IBDFBKS",158,0)
 .S ^IBD(359.2,IBFORMID,10,IBLC,0)=IBDFSA(IBLC)
"RTN","IBDFBKS",159,0)
 .K IBDFSA(IBLC)
"RTN","IBDFBKS",160,0)
 .Q
"RTN","IBDFBKS",161,0)
 ;
"RTN","IBDFBKS",162,0)
 S IBLC=IBLC+1
"RTN","IBDFBKS",163,0)
 S IBDFSA(IBLC)=$G(TEXT)
"RTN","IBDFBKS",164,0)
 Q
"RTN","IBDFBKS",165,0)
 ;
"RTN","IBDFBKS",166,0)
WRITE(IBFORMID) ;
"RTN","IBDFBKS",167,0)
 N LINE S LINE=0
"RTN","IBDFBKS",168,0)
 S X=0 X ^%ZOSF("RM")
"RTN","IBDFBKS",169,0)
 F  S LINE=$O(^IBD(359.2,IBFORMID,10,LINE))  Q:'LINE  W !,$G(^IBD(359.2,IBFORMID,10,LINE,0))
"RTN","IBDFBKS",170,0)
 S X=80 X ^%ZOSF("RM")
"RTN","IBDFBKS",171,0)
 Q
"RTN","IBDFBKS",172,0)
 ;
"RTN","IBDFBKS",173,0)
PARAM ; -- get values from parameter file
"RTN","IBDFBKS",174,0)
 ;    ibdfill  := % fill required
"RTN","IBDFBKS",175,0)
 ;    ibdbkgnd := % background expected
"RTN","IBDFBKS",176,0)
 S IBDFILL=$P($G(^IBD(357.09,1,0)),"^",8) I IBDFILL="" S IBDFILL=20
"RTN","IBDFBKS",177,0)
 S IBDBKGND=$P($G(^IBD(357.09,1,0)),"^",9) I IBDBKGND="" S IBDBKGND=5
"RTN","IBDFBKS",178,0)
 S XYSMALL=$P(^IBD(357.09,1,0),"^",12) I XYSMALL'=+XYSMALL S XYSMALL=4
"RTN","IBDFBKS",179,0)
 Q
"RTN","IBDFBKS1")
0^1^B81662054
"RTN","IBDFBKS1",1,0)
IBDFBKS1 ;ALB/CJM/AAS - ENCOUNTER FORM - create form spec for scanning (Broker Version CONTINUATION) ; 6-JUN-95
"RTN","IBDFBKS1",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3,25**;APR 24, 1997
"RTN","IBDFBKS1",3,0)
 ;
"RTN","IBDFBKS1",4,0)
 ;
"RTN","IBDFBKS1",5,0)
FORM ;;
"RTN","IBDFBKS1",6,0)
 ;;'Paper Keyboard FormSpec
"RTN","IBDFBKS1",7,0)
 ;;'VERSION = 2.53
"RTN","IBDFBKS1",8,0)
 ;;'AICS Version 3.0;**7,3,25**
"RTN","IBDFBKS1",9,0)
SITE ;;'VA SITE NAME
"RTN","IBDFBKS1",10,0)
 ;;INT anchorcnt;
"RTN","IBDFBKS1",11,0)
 ;;INT hasprint;
"RTN","IBDFBKS1",12,0)
 ;;INT check;
"RTN","IBDFBKS1",13,0)
 ;;INT firstanchor;
"RTN","IBDFBKS1",14,0)
 ;;INT pfid;
"RTN","IBDFBKS1",15,0)
 ;;INT page;
"RTN","IBDFBKS1",16,0)
 ;;INT saveunrf;
"RTN","IBDFBKS1",17,0)
 ;;INT ddechan;
"RTN","IBDFBKS1",18,0)
 ;;ALPHA narrative;
"RTN","IBDFBKS1",19,0)
 ;;
"RTN","IBDFBKS1",20,0)
 ;;FORM
"RTN","IBDFBKS1",21,0)
NAME ;;  NAME = "ENCOUNTER FORM 71";
"RTN","IBDFBKS1",22,0)
 ;;  AREA =  0 0 2770 2150;
"RTN","IBDFBKS1",23,0)
 ;;  PAGESIZE = " 2770 2150";
"RTN","IBDFBKS1",24,0)
 ;;  ANCHOR1 = NONE;
"RTN","IBDFBKS1",25,0)
 ;;  ANCHOR2 = NONE;
"RTN","IBDFBKS1",26,0)
 ;;  POINTS = 0 0 0 0;
"RTN","IBDFBKS1",27,0)
 ;;  CONFIDENCE = " 9";
"RTN","IBDFBKS1",28,0)
 ;;  CLOSEFORMSPEC = {DDETERM(ddechan);
"RTN","IBDFBKS1",29,0)
 ;;     LOG(\"AICS #52/DDE channel is closed\"); };
"RTN","IBDFBKS1",30,0)
 ;;  DATEFORMAT = "6";
"RTN","IBDFBKS1",31,0)
 ;;  TIMEFORMAT = "5";
"RTN","IBDFBKS1",32,0)
 ;;  EXFORMAT = "STRIP";
"RTN","IBDFBKS1",33,0)
 ;;  EXPORT = "\'SHOW(\"DO NOT EXPORT - NOT SCANNABLE\");";
"RTN","IBDFBKS1",34,0)
 ;;  FS = ",";
"RTN","IBDFBKS1",35,0)
 ;;  QUOTABLE = "\\n";
"RTN","IBDFBKS1",36,0)
 ;;  ImageProcessing = {
"RTN","IBDFBKS1",37,0)
 ;;     IMAGEPROC=1
"RTN","IBDFBKS1",38,0)
 ;;     AUTO_ALIGN=0
"RTN","IBDFBKS1",39,0)
 ;;     ALIGN_TEXT=0
"RTN","IBDFBKS1",40,0)
 ;;     ALIGN_ORIENT=0
"RTN","IBDFBKS1",41,0)
 ;;     DESKEW=0
"RTN","IBDFBKS1",42,0)
 ;;     DESHADE=0
"RTN","IBDFBKS1",43,0)
 ;;     SMOOTH=0
"RTN","IBDFBKS1",44,0)
 ;;     REMOVE_BORDER=1
"RTN","IBDFBKS1",45,0)
 ;;     REMOVE_NOISE=0
"RTN","IBDFBKS1",46,0)
 ;;     PROC_MIN_VERT_LINE_LEN=0
"RTN","IBDFBKS1",47,0)
 ;;     PROC_MIN_HORZ_LINE_LEN=0
"RTN","IBDFBKS1",48,0)
 ;;     FATTYPE=0
"RTN","IBDFBKS1",49,0)
 ;;     FATTEN=0};
"RTN","IBDFBKS1",50,0)
 ;;  POSITION = "60,60";
"RTN","IBDFBKS1",51,0)
 ;;  OPENFORMSPEC = {ddechan=DDEINIT(\"IBDSCAN\",\"DdeServerConv\");
"RTN","IBDFBKS1",52,0)
 ;;     if (ddechan == 0) LOG(\"AICS #54/Unable to Open Channel to AICS.\");
"RTN","IBDFBKS1",53,0)
 ;;     \' if (ddechan == 0) SHOW(\"Unable to Open Channel to AICS to send data.\");
"RTN","IBDFBKS1",54,0)
 ;;     anchorcnt = 4;
"RTN","IBDFBKS1",55,0)
 ;;     }; 
"RTN","IBDFBKS1",56,0)
 ;;FIELD ' 1
"RTN","IBDFBKS1",57,0)
 ;;  NAME = "TOP LEFT ANCHOR";
"RTN","IBDFBKS1",58,0)
 ;;  ELEMTYPE = ELEM_PAT;
"RTN","IBDFBKS1",59,0)
 ;;  METRIC = 17 120 120;
"RTN","IBDFBKS1",60,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",61,0)
 ;;  LENGTH = 2;
"RTN","IBDFBKS1",62,0)
 ;;  POINTS = 65 70 120 130;
"RTN","IBDFBKS1",63,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",64,0)
 ;;  CONFIDENCE = " 6";
"RTN","IBDFBKS1",65,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",66,0)
 ;;  END = {if (anchorcnt == 2){
"RTN","IBDFBKS1",67,0)
 ;;     firstanchor = 1; 
"RTN","IBDFBKS1",68,0)
 ;;     if (FIELDSTATUS != FIELD_OK) firstanchor = 0;}
"RTN","IBDFBKS1",69,0)
 ;;     };
"RTN","IBDFBKS1",70,0)
 ;;  Pattern = "PATTERN=C:\\VISTA\\AICS\\FORMSPEC\\AICSLOGO.BMP";
"RTN","IBDFBKS1",71,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",72,0)
 ;;FIELD ' 2
"RTN","IBDFBKS1",73,0)
 ;;  NAME = "BOTTOM LEFT ANCHOR";
"RTN","IBDFBKS1",74,0)
 ;;  ELEMTYPE = ELEM_PAT;
"RTN","IBDFBKS1",75,0)
 ;;  METRIC = 17 120 120;
"RTN","IBDFBKS1",76,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",77,0)
 ;;  LENGTH = 2;
"RTN","IBDFBKS1",78,0)
 ;;  POINTS = 2690 70 2745 130;
"RTN","IBDFBKS1",79,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",80,0)
 ;;  CONFIDENCE = " 6";
"RTN","IBDFBKS1",81,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",82,0)
 ;;  Pattern = "PATTERN=C:\\VISTA\\AICS\\FORMSPEC\\AICSLOGO.BMP";
"RTN","IBDFBKS1",83,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",84,0)
 ;;  END = {INT aset;
"RTN","IBDFBKS1",85,0)
 ;;    if (anchorcnt == 2){
"RTN","IBDFBKS1",86,0)
 ;;       if ((firstanchor == 1) && (FIELDSTATUS == FIELD_OK))
"RTN","IBDFBKS1",87,0)
 ;;          aset = ANCHORSET(1,2);
"RTN","IBDFBKS1",88,0)
 ;;       else aset = 0;
"RTN","IBDFBKS1",89,0)
 ;;       if (aset == 0) {NEXTFIELD = 3;} 
"RTN","IBDFBKS1",90,0)
 ;;       else NEXTFIELD = 5;}
"RTN","IBDFBKS1",91,0)
 ;;  }; 
"RTN","IBDFBKS1",92,0)
 ;;FIELD ' 3
"RTN","IBDFBKS1",93,0)
 ;;  NAME = "TOP RIGHT ANCHOR";
"RTN","IBDFBKS1",94,0)
 ;;  ELEMTYPE = ELEM_PAT;
"RTN","IBDFBKS1",95,0)
 ;;  METRIC = 17 120 120;
"RTN","IBDFBKS1",96,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",97,0)
 ;;  LENGTH = 2;
"RTN","IBDFBKS1",98,0)
 ;;  POINTS = 65 2015 120 2075;
"RTN","IBDFBKS1",99,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",100,0)
 ;;  CONFIDENCE = " 6";
"RTN","IBDFBKS1",101,0)
 ;;  END = {if (anchorcnt == 2) {
"RTN","IBDFBKS1",102,0)
 ;;     firstanchor = 1; 
"RTN","IBDFBKS1",103,0)
 ;;     if (FIELDSTATUS != FIELD_OK) firstanchor = 0;}
"RTN","IBDFBKS1",104,0)
 ;;     };
"RTN","IBDFBKS1",105,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",106,0)
 ;;  Pattern = "PATTERN=C:\\VISTA\\AICS\\FORMSPEC\\AICSLOGO.BMP";
"RTN","IBDFBKS1",107,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",108,0)
 ;;FIELD ' 4
"RTN","IBDFBKS1",109,0)
 ;;  NAME = "BOTTOM RIGHT ANCHOR";
"RTN","IBDFBKS1",110,0)
 ;;  ELEMTYPE = ELEM_PAT;
"RTN","IBDFBKS1",111,0)
 ;;  METRIC = 17 120 120;
"RTN","IBDFBKS1",112,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",113,0)
 ;;  LENGTH = 2;
"RTN","IBDFBKS1",114,0)
 ;;  POINTS = 2690 2015 2745 2075;
"RTN","IBDFBKS1",115,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",116,0)
 ;;  CONFIDENCE = " 6";
"RTN","IBDFBKS1",117,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",118,0)
 ;;  Pattern = "PATTERN=C:\\VISTA\\AICS\\FORMSPEC\\AICSLOGO.BMP";
"RTN","IBDFBKS1",119,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",120,0)
 ;;  END={INT aset;
"RTN","IBDFBKS1",121,0)
 ;;INT result;
"RTN","IBDFBKS1",122,0)
 ;;  if (anchorcnt == 2){
"RTN","IBDFBKS1",123,0)
 ;;     if ((firstanchor == 1) && (FIELDSTATUS == FIELD_OK))     
"RTN","IBDFBKS1",124,0)
 ;;     aset = ANCHORSET(3,4);
"RTN","IBDFBKS1",125,0)
 ;;     else aset =0;
"RTN","IBDFBKS1",126,0)
 ;;     if (aset == 0) {
"RTN","IBDFBKS1",127,0)
 ;;        if (ddechan == 0) SHOW(\"Anchors not found, recognition stopping!\");
"RTN","IBDFBKS1",128,0)
 ;;        if (ddechan != 0) {
"RTN","IBDFBKS1",129,0)
 ;;           result = DDEEXEC(ddechan,\"SAVEFORM(0,0,0,U"\);
"RTN","IBDFBKS1",130,0)
 ;;           DDEPOKE(ddechan,\"DdeServerItem\",\"Anchors not found\");}
"RTN","IBDFBKS1",131,0)
 ;;        CHAIN(\"C:\\\\vista\\\\aics\\\\formspec\\\\AICSMSTR.FS\",1);}}
"RTN","IBDFBKS1",132,0)
 ;;  
"RTN","IBDFBKS1",133,0)
 ;;  if (anchorcnt == 4){
"RTN","IBDFBKS1",134,0)
 ;;     aset = ANCHORSET(1,4);
"RTN","IBDFBKS1",135,0)
 ;;     if (aset == 0) {
"RTN","IBDFBKS1",136,0)
 ;;        if (ddechan == 0) SHOW(\"Anchors not found, recognition stopping!\");
"RTN","IBDFBKS1",137,0)
 ;;        if (ddechan != 0) {
"RTN","IBDFBKS1",138,0)
 ;;           result = DDEEXEC(ddechan,\"SAVEFORM(0,0,0,U"\);
"RTN","IBDFBKS1",139,0)
 ;;           DDEPOKE(ddechan,\"DdeServerItem\",\"Anchors not found\");}
"RTN","IBDFBKS1",140,0)
 ;;        CHAIN(\"C:\\\\vista\\\\aics\\\\formspec\\\\AICSMSTR.FS\",1);}}
"RTN","IBDFBKS1",141,0)
 ;;  };
"RTN","IBDFBKS1",142,0)
 ;;FIELD ' 5
"RTN","IBDFBKS1",143,0)
 ;;NAME = "SCANPAGE?";
"RTN","IBDFBKS1",144,0)
 ;;  ELEMTYPE = ELEM_PAT;
"RTN","IBDFBKS1",145,0)
 ;;  METRIC = 17 120 120;
"RTN","IBDFBKS1",146,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",147,0)
 ;;  LENGTH = 2;
"RTN","IBDFBKS1",148,0)
 ;;  POINTS = 2669 1264 2734 1344;
"RTN","IBDFBKS1",149,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",150,0)
 ;;  CONFIDENCE = " 7";
"RTN","IBDFBKS1",151,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",152,0)
 ;;  Pattern = "PATTERN=C:\\VISTA\\AICS\\FORMSPEC\\AICSLOGO.BMP";
"RTN","IBDFBKS1",153,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",154,0)
 ;;FIELD ' 6
"RTN","IBDFBKS1",155,0)
 ;;  NAME = "FORM ID CHECK";
"RTN","IBDFBKS1",156,0)
 ;;  ELEMTYPE = ELEM_OCR;
"RTN","IBDFBKS1",157,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",158,0)
 ;;  LENGTH = 3;
"RTN","IBDFBKS1",159,0)
 ;;  POINTS = 50 1412 150 1545;
"RTN","IBDFBKS1",160,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",161,0)
 ;;  CHARFORMAT = "NOSPACES";
"RTN","IBDFBKS1",162,0)
 ;;  END = {
"RTN","IBDFBKS1",163,0)
 ;;  check=GETIVALUE(FIELDNAME);
"RTN","IBDFBKS1",164,0)
 ;;  if (check < 1) FIELDSTATUS = FIELD_BAD;
"RTN","IBDFBKS1",165,0)
 ;;  if (GETSTATUS(FIELDNAME) == FIELD_BLANK) FIELDSTATUS = FIELD_BAD;};
"RTN","IBDFBKS1",166,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",167,0)
 ;;FIELD ' 7
"RTN","IBDFBKS1",168,0)
 ;;  NAME = "FORM ID";
"RTN","IBDFBKS1",169,0)
 ;;  ELEMTYPE = ELEM_OCR;
"RTN","IBDFBKS1",170,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",171,0)
 ;;  LENGTH = 9;
"RTN","IBDFBKS1",172,0)
 ;;  POINTS = 50 635 150 910;
"RTN","IBDFBKS1",173,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",174,0)
 ;;  CHARFORMAT = "NOSPACES";
"RTN","IBDFBKS1",175,0)
 ;;  END = {
"RTN","IBDFBKS1",176,0)
 ;;  INT checksum;
"RTN","IBDFBKS1",177,0)
 ;;  INT div;
"RTN","IBDFBKS1",178,0)
 ;;
"RTN","IBDFBKS1",179,0)
 ;;  pfid=GETIVALUE(FIELDNAME);
"RTN","IBDFBKS1",180,0)
 ;;  checksum=3*pfid;
"RTN","IBDFBKS1",181,0)
 ;;  div=checksum/997;
"RTN","IBDFBKS1",182,0)
 ;;  checksum=checksum-(div*997);
"RTN","IBDFBKS1",183,0)
 ;;  if ((checksum!=check)&&(FIELDACCEPTED!=1)) {
"RTN","IBDFBKS1",184,0)
 ;;  FIELDSTATUS=FIELD_BAD;
"RTN","IBDFBKS1",185,0)
 ;;  }
"RTN","IBDFBKS1",186,0)
 ;;};
"RTN","IBDFBKS1",187,0)
 ;;FIELD ' 8
"RTN","IBDFBKS1",188,0)
 ;;  NAME = "PAGE CHECK";
"RTN","IBDFBKS1",189,0)
 ;;  ELEMTYPE = ELEM_OCR;
"RTN","IBDFBKS1",190,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",191,0)
 ;;  LENGTH = 3;
"RTN","IBDFBKS1",192,0)
 ;;  POINTS = 50 1590 150 1700;
"RTN","IBDFBKS1",193,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",194,0)
 ;;  CHARFORMAT = "NOSPACES";
"RTN","IBDFBKS1",195,0)
 ;;  END = {
"RTN","IBDFBKS1",196,0)
 ;;  check=GETIVALUE(FIELDNAME);
"RTN","IBDFBKS1",197,0)
 ;;  if (check < 1) FIELDSTATUS = FIELD_BAD;
"RTN","IBDFBKS1",198,0)
 ;;  if (GETSTATUS(FIELDNAME) == FIELD_BLANK) FIELDSTATUS = FIELD_BAD;};
"RTN","IBDFBKS1",199,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",200,0)
 ;;FIELD ' 9
"RTN","IBDFBKS1",201,0)
 ;;  NAME = "PAGE";
"RTN","IBDFBKS1",202,0)
 ;;  ELEMTYPE = ELEM_OCR;
"RTN","IBDFBKS1",203,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",204,0)
 ;;  LENGTH = 1;
"RTN","IBDFBKS1",205,0)
 ;;  POINTS = 50 1860 150 1950;
"RTN","IBDFBKS1",206,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",207,0)
 ;;  CHARFORMAT = "NOSPACES";
"RTN","IBDFBKS1",208,0)
 ;;  END = {INT  checksum;
"RTN","IBDFBKS1",209,0)
 ;;  INT div;
"RTN","IBDFBKS1",210,0)
 ;;  ALPHA next;
"RTN","IBDFBKS1",211,0)
 ;;
"RTN","IBDFBKS1",212,0)
 ;;  page=GETIVALUE(FIELDNAME);
"RTN","IBDFBKS1",213,0)
 ;;  next=STRCAT("TOP OF PAGE ",ITOA(page));
"RTN","IBDFBKS1",214,0)
 ;;  checksum=3*page;
"RTN","IBDFBKS1",215,0)
 ;;  div=checksum/997;
"RTN","IBDFBKS1",216,0)
 ;;  checksum=checksum-(div*997);
"RTN","IBDFBKS1",217,0)
 ;;
"RTN","IBDFBKS1",218,0)
 ;;  if ((checksum!=check)&&(FIELDACCEPTED!=1)) {
"RTN","IBDFBKS1",219,0)
 ;;  FIELDSTATUS=FIELD_BAD;
"RTN","IBDFBKS1",220,0)
 ;;  }
"RTN","IBDFBKS1",221,0)
PGCK ;;  else if ((page!=1)&&(page!=2)){
"RTN","IBDFBKS1",222,0)
 ;;  FIELDSTATUS=FIELD_BAD;
"RTN","IBDFBKS1",223,0)
 ;;  }
"RTN","IBDFBKS1",224,0)
 ;;  else if (page>1) {NEXTFIELD=GETNUM(next); }
"RTN","IBDFBKS1",225,0)
 ;;};
"RTN","IBDFBKS1",226,0)
QUIT ;;
"RTN","IBDFBKS1",227,0)
 ;;
"RTN","IBDFBKS1",228,0)
 ;;
"RTN","IBDFBKS1",229,0)
TOPOFPG ;;
"RTN","IBDFBKS1",230,0)
NUMBER1 ;;FIELD ' 49
"RTN","IBDFBKS1",231,0)
FLDNAME ;;  NAME = "TOP OF PAGE 2";
"RTN","IBDFBKS1",232,0)
 ;;  ELEMTYPE = RECT;
"RTN","IBDFBKS1",233,0)
 ;;  METRIC = 2 2 0 0 0 0 0 0 0;
"RTN","IBDFBKS1",234,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",235,0)
 ;;  LENGTH = 1;
"RTN","IBDFBKS1",236,0)
 ;;  POINTS = 100 2040;
"RTN","IBDFBKS1",237,0)
PAGE1 ;;  PAGE = 1;
"RTN","IBDFBKS1",238,0)
 ;;  HIDDEN="1";
"RTN","IBDFBKS1",239,0)
 ;;  EXFORMAT="NOEXPORT";
"RTN","IBDFBKS1",240,0)
QUIT1 ;;
"RTN","IBDFBKS1",241,0)
 ;;
"RTN","IBDFBKS1",242,0)
BOTTOM ;;
"RTN","IBDFBKS1",243,0)
NUMBER2 ;;FIELD ' 49
"RTN","IBDFBKS1",244,0)
NAME2 ;;  NAME = "BOTTOM OF PAGE";
"RTN","IBDFBKS1",245,0)
 ;;  ELEMTYPE = RECT;
"RTN","IBDFBKS1",246,0)
 ;;  METRIC = 2 2 0 0 0 0 0 0 0;
"RTN","IBDFBKS1",247,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",248,0)
 ;;  LENGTH = 1;
"RTN","IBDFBKS1",249,0)
 ;;  POINTS = 100 2040;
"RTN","IBDFBKS1",250,0)
PAGE2 ;;  PAGE = 1;
"RTN","IBDFBKS1",251,0)
 ;;  HIDDEN="1";
"RTN","IBDFBKS1",252,0)
 ;;END = {INT result;
"RTN","IBDFBKS1",253,0)
 ;;INT loop;
"RTN","IBDFBKS1",254,0)
 ;;ALPHA Data;
"RTN","IBDFBKS1",255,0)
 ;;ALPHA str;
"RTN","IBDFBKS1",256,0)
 ;;ALPHA  RS;
"RTN","IBDFBKS1",257,0)
 ;;ALPHA Save;
"RTN","IBDFBKS1",258,0)
 ;;ALPHA New;
"RTN","IBDFBKS1",259,0)
 ;;ALPHA Add;
"RTN","IBDFBKS1",260,0)
 ;;ALPHA End;
"RTN","IBDFBKS1",261,0)
 ;;
"RTN","IBDFBKS1",262,0)
 ;;if (ddechan == 0) {
"RTN","IBDFBKS1",263,0)
 ;;   SHOW(\"AICS is not connected, no data exported!\");
"RTN","IBDFBKS1",264,0)
 ;;   CHAIN(\"C:\\\\vista\\\\aics\\\\formspec\\\\AICSMSTR.FS\",1);}
"RTN","IBDFBKS1",265,0)
 ;;
"RTN","IBDFBKS1",266,0)
 ;;New=\"$$NEW$$("\;
"RTN","IBDFBKS1",267,0)
 ;;Add=\"$$ADD$$("\;
"RTN","IBDFBKS1",268,0)
 ;;End=\"$$END$$("\;
"RTN","IBDFBKS1",269,0)
 ;;RS=STRCAT(",",ITOC(13));
"RTN","IBDFBKS1",270,0)
 ;;
"RTN","IBDFBKS1",271,0)
 ;;if (BATCH&&(saveunrf>0)){
"RTN","IBDFBKS1",272,0)
SAVE ;;  Save = \"SAVEFORM("\;
"RTN","IBDFBKS1",273,0)
 ;;  if (ddechan != 0) result = DDEEXEC(ddechan,Save);
"RTN","IBDFBKS1",274,0)
 ;;  if (result==0) SHOW(\"Warning: Saving of Unrecognized form in AICS has Failed!\");
"RTN","IBDFBKS1",275,0)
 ;;  else DDEPOKE(ddechan,\"DdeServerItem\",\"Operator Verification Needed\");
"RTN","IBDFBKS1",276,0)
 ;;  CHAIN(\"C:\\\\vista\\\\aics\\\\formspec\\\\AICSMSTR.FS\",1);}
"RTN","IBDFBKS1",277,0)
 ;;
"RTN","IBDFBKS1",278,0)
 ;;  if (ddechan != 0) {
"RTN","IBDFBKS1",279,0)
EXPORT ;;      \'if (STRFIND(Data,RS,STRLEN(Data) - 1) > 0) {;;      \'    Data = SUBSTR(Data,1,STRLEN(Data) - 1); }
"RTN","IBDFBKS1",280,0)
 ;;
"RTN","IBDFBKS1",281,0)
 ;;  result=DDEPOKE(ddechan,\"DdeServerItem\",End);}
"RTN","IBDFBKS1",282,0)
 ;;CHAIN(\"c:\\\\vista\\\\aics\\\\formspec\\\\AICSMSTR.FS\",1);
"RTN","IBDFBKS1",283,0)
 ;;};
"RTN","IBDFBKS1",284,0)
 ;;EXFORMAT="NOEXPORT";
"RTN","IBDFBKS1",285,0)
QUIT2 ;;
"RTN","IBDFBKS2")
0^2^B78017855
"RTN","IBDFBKS2",1,0)
IBDFBKS2 ;ALB/CJM/AAS - Create form spec for scanning ; 6-JUN-95
"RTN","IBDFBKS2",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3,25**;APR 24, 1997
"RTN","IBDFBKS2",3,0)
 ;
"RTN","IBDFBKS2",4,0)
HANDPRNT(IEN,NAME,PAGE,ROW,COL,WIDTH,LINES,READTYPE,PAPKEY,PI) ;
"RTN","IBDFBKS2",5,0)
 ;
"RTN","IBDFBKS2",6,0)
 Q:($P($G(^IBE(357.6,+PI,0)),"^",6)'=1)
"RTN","IBDFBKS2",7,0)
 ;
"RTN","IBDFBKS2",8,0)
 N X1,X2,Y1,Y2,W,PICTURE,TYPEDATA,NODE0,LENGTH,LINENUM,PKDICT,CONF,L,SUBPICS,FORMAT,XYSMALL
"RTN","IBDFBKS2",9,0)
 S TYPEDATA="ALPHA",PICTURE=""
"RTN","IBDFBKS2",10,0)
 ;
"RTN","IBDFBKS2",11,0)
 ; -- get info associated with DHCP Data Element
"RTN","IBDFBKS2",12,0)
 I PAPKEY D
"RTN","IBDFBKS2",13,0)
 .S NODE0=$G(^IBE(359.1,PAPKEY,0)),NODE10=$G(^(10))
"RTN","IBDFBKS2",14,0)
 .S TYPEDATA=$P(NODE10,"^",1)
"RTN","IBDFBKS2",15,0)
 .S TYPEDATA=$S(TYPEDATA="a":"ALPHA",TYPEDATA="i":"INT",TYPEDATA="f":"FLOAT",TYPEDATA="t":"TIME",TYPEDATA="d":"DATE",1:"ALPHA")
"RTN","IBDFBKS2",16,0)
 .S PICTURE=$P(NODE10,"^",2)
"RTN","IBDFBKS2",17,0)
 .S FORMAT=$P(NODE0,"^",5) ;don't set year in format, needed as is for recognition
"RTN","IBDFBKS2",18,0)
 .S LENGTH=$P(NODE0,"^",2)
"RTN","IBDFBKS2",19,0)
 .S CONF=$P(NODE0,"^",7)
"RTN","IBDFBKS2",20,0)
 .S PKDICT=$P(NODE10,"^",3)
"RTN","IBDFBKS2",21,0)
 .S SUBPICS=$P(NODE10,"^",4)
"RTN","IBDFBKS2",22,0)
 ;
"RTN","IBDFBKS2",23,0)
 ;find top left-hand corner
"RTN","IBDFBKS2",24,0)
 S X1=((COL*COLWIDTH)+XOFFSET)*CONVERT,X1=$FN(X1,"",0)
"RTN","IBDFBKS2",25,0)
 S Y1=((ROW*ROWHT)+YOFFSET+YHANDOS)*CONVERT,Y1=$FN(Y1,"",0)
"RTN","IBDFBKS2",26,0)
 S XYSMALL=$P(^IBD(357.09,1,0),"^",12)
"RTN","IBDFBKS2",27,0)
 I XYSMALL'=+XYSMALL S XYSMALL=5 ;default
"RTN","IBDFBKS2",28,0)
 ;
"RTN","IBDFBKS2",29,0)
 I READTYPE=3 D
"RTN","IBDFBKS2",30,0)
 .;define some marksense fields - if any marked it means there is print!
"RTN","IBDFBKS2",31,0)
 .S FIELD=FIELD+1
"RTN","IBDFBKS2",32,0)
 .D BLDARY^IBDFBKS("FIELD ' "_FIELD)
"RTN","IBDFBKS2",33,0)
 .D BLDARY^IBDFBKS("  NAME = """_NAME_"?"";")
"RTN","IBDFBKS2",34,0)
 .D BLDARY^IBDFBKS("  ELEMTYPE = RECT;")
"RTN","IBDFBKS2",35,0)
 .D BLDARY^IBDFBKS("  METRIC = 40 40 0 0 0 0 1 0 1;")
"RTN","IBDFBKS2",36,0)
 .D BLDARY^IBDFBKS("  TYPEDATA = INT;")
"RTN","IBDFBKS2",37,0)
 .D BLDARY^IBDFBKS("  LENGTH = ",LENGTH,";")
"RTN","IBDFBKS2",38,0)
 .D BLDARY^IBDFBKS("  POINTS =")
"RTN","IBDFBKS2",39,0)
 .F L=1:1:LINES F W=1:1:WIDTH D
"RTN","IBDFBKS2",40,0)
 ..S X2=X1+((((W-1)*172.7645)+30)*CONVERT),X2=$FN(X2,"",0)
"RTN","IBDFBKS2",41,0)
 ..S Y2=Y1+(((L*180)-39)*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",42,0)
 ..S IBDFSA(IBLC)=IBDFSA(IBLC)_" "_Y2+1_" "_X2+1
"RTN","IBDFBKS2",43,0)
 .S IBDFSA(IBLC)=IBDFSA(IBLC)_";"
"RTN","IBDFBKS2",44,0)
 .D BLDARY^IBDFBKS("  PAGE = ",PAGE,";")
"RTN","IBDFBKS2",45,0)
 .D BLDARY^IBDFBKS("  CONFIDENCE = "" 0"";")
"RTN","IBDFBKS2",46,0)
 .D BLDARY^IBDFBKS("  END = {if (FIELDSTATUS != FIELD_BLANK){")
"RTN","IBDFBKS2",47,0)
 .D BLDARY^IBDFBKS("    hasprint=1;")
"RTN","IBDFBKS2",48,0)
 .D BLDARY^IBDFBKS("    FIELDSTATUS=FIELD_BAD;")
"RTN","IBDFBKS2",49,0)
 .D BLDARY^IBDFBKS("  }")
"RTN","IBDFBKS2",50,0)
 .D BLDARY^IBDFBKS("  else {")
"RTN","IBDFBKS2",51,0)
 .D BLDARY^IBDFBKS("    hasprint=0;")
"RTN","IBDFBKS2",52,0)
 .D BLDARY^IBDFBKS("    NEXTFIELD=NEXTFIELD+1;")
"RTN","IBDFBKS2",53,0)
 .D BLDARY^IBDFBKS("  }};")
"RTN","IBDFBKS2",54,0)
 .D BLDARY^IBDFBKS("  EXFORMAT = ""NOEXPORT"";")
"RTN","IBDFBKS2",55,0)
 .D BLDARY^IBDFBKS("  HIDDEN = ""1"";")
"RTN","IBDFBKS2",56,0)
 ;
"RTN","IBDFBKS2",57,0)
 ;field is narrative that needs to be broken into single lines
"RTN","IBDFBKS2",58,0)
 I (LINES>1)&(READTYPE=2) D  Q
"RTN","IBDFBKS2",59,0)
 .F LINENUM=1:1:LINES S:LINENUM>1 Y1=$FN(Y1+(2*ROWHT*CONVERT),"",0) D
"RTN","IBDFBKS2",60,0)
 ..S X2=X1+(172.7654*WIDTH*CONVERT),X2=$FN(X2,"",0)
"RTN","IBDFBKS2",61,0)
 ..S Y2=Y1+(180*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",62,0)
 ..D PRINTEND^IBDFBKS3
"RTN","IBDFBKS2",63,0)
 ..D PKFIELD(X1+2,Y1+2,X2-2,Y2-2,2,PICTURE,0,CONF,PKDICT,WIDTH,TYPEDATA,NAME_" LINE "_LINENUM,2)
"RTN","IBDFBKS2",64,0)
 ..;for handprint fields,must prefix data exported with field info - for bubbles the XMAP has the field info
"RTN","IBDFBKS2",65,0)
 ..S @FIELDS@(PAGE,FIELD)="H:"_IEN_":",@FIELDS@(PAGE,FIELD,"DATATYPE")=TYPEDATA S:LINENUM=1 @FIELDS@(PAGE,FIELD,"START")=1 S:LINENUM=LINES @FIELDS@(PAGE,FIELD,"END")=1 S @FIELDS@(PAGE,FIELD,"MULT")=1
"RTN","IBDFBKS2",66,0)
 ;
"RTN","IBDFBKS2",67,0)
 ;field needs to be broken into subfields due to the print format
"RTN","IBDFBKS2",68,0)
 I (READTYPE=2)&(FORMAT'="") D  Q
"RTN","IBDFBKS2",69,0)
 .N SUBFIELD,I1,I2,PREFIX,SX1,SX2,SPICTURE,LEN,FOUNDEND
"RTN","IBDFBKS2",70,0)
 .S PREFIX=$P(FORMAT,"_"),I1=$L(PREFIX)+1
"RTN","IBDFBKS2",71,0)
 .S Y2=Y1+(180*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",72,0)
 .F  Q:(I1>WIDTH)  D
"RTN","IBDFBKS2",73,0)
 ..S I2=I1
"RTN","IBDFBKS2",74,0)
 ..S FOUNDEND=0 F  D  Q:FOUNDEND
"RTN","IBDFBKS2",75,0)
 ...I $E(FORMAT,I2+1)="_" S I2=I2+1
"RTN","IBDFBKS2",76,0)
 ...E  S FOUNDEND=1 Q
"RTN","IBDFBKS2",77,0)
 ..;so at this point I1=beginning of the subfield, I2=the end
"RTN","IBDFBKS2",78,0)
 ..S SX1=$FN(X1+(172.7654*(I1-1)*CONVERT),"",0)
"RTN","IBDFBKS2",79,0)
 ..S SX2=$FN(X1+(172.7654*(I2)*CONVERT),"",0)
"RTN","IBDFBKS2",80,0)
 ..S SPICTURE=$E(SUBPICS,I1,I2)
"RTN","IBDFBKS2",81,0)
 ..S LEN=(I2-I1)+1
"RTN","IBDFBKS2",82,0)
 ..D PRINTEND^IBDFBKS3
"RTN","IBDFBKS2",83,0)
 ..D PKFIELD(SX1+2,Y1+2,SX2-2,Y2-2,2,SPICTURE,1,0,"",LEN,"ALPHA",NAME_" Char:"_I1_" to "_I2)
"RTN","IBDFBKS2",84,0)
 ..S SUBFIELD(FIELD)=""
"RTN","IBDFBKS2",85,0)
 ..S (I1,I2)=I2+1
"RTN","IBDFBKS2",86,0)
 ..S FOUNDEND=0 F  D  Q:FOUNDEND
"RTN","IBDFBKS2",87,0)
 ...I $E(FORMAT,I2+1)="_" S FOUNDEND=1 Q
"RTN","IBDFBKS2",88,0)
 ...I I2>WIDTH S FOUNDEND=1 Q
"RTN","IBDFBKS2",89,0)
 ...S I2=I2+1 Q
"RTN","IBDFBKS2",90,0)
 ..I $E(FORMAT,I1,I2)'="" S SUBFIELD(FIELD)=$E(FORMAT,I1,I2)
"RTN","IBDFBKS2",91,0)
 ..S I1=I2+1
"RTN","IBDFBKS2",92,0)
 .;
"RTN","IBDFBKS2",93,0)
 .;now create a field to concatenate the subfields together
"RTN","IBDFBKS2",94,0)
 .S X2=X1+(172.7654*WIDTH*CONVERT),X2=$FN(X2,"",0)
"RTN","IBDFBKS2",95,0)
 .S Y2=Y1+(180*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",96,0)
 .D PKFIELD(X1,Y1,X2,Y2,1,PICTURE,0,CONF,PKDICT,WIDTH,TYPEDATA,NAME,1)
"RTN","IBDFBKS2",97,0)
 .D
"RTN","IBDFBKS2",98,0)
 ..D BLDARY^IBDFBKS("BEGIN = {ALPHA sfstr;")
"RTN","IBDFBKS2",99,0)
 ..D BLDARY^IBDFBKS("ALPHA str;")
"RTN","IBDFBKS2",100,0)
 ..D BLDARY^IBDFBKS("INT sfconf;")
"RTN","IBDFBKS2",101,0)
 ..D BLDARY^IBDFBKS("INT conf;")
"RTN","IBDFBKS2",102,0)
 ..D BLDARY^IBDFBKS("INT found;")
"RTN","IBDFBKS2",103,0)
 ..D BLDARY^IBDFBKS("INT ret;")
"RTN","IBDFBKS2",104,0)
 ..D BLDARY^IBDFBKS("INT position;") ; patch 25 code
"RTN","IBDFBKS2",105,0)
 ..D BLDARY^IBDFBKS("INT delfield;") ; patch 25 code
"RTN","IBDFBKS2",106,0)
 ..D BLDARY^IBDFBKS("found=0;")
"RTN","IBDFBKS2",107,0)
 ..D BLDARY^IBDFBKS("conf=10;")
"RTN","IBDFBKS2",108,0)
 ..I PREFIX'="" D BLDARY^IBDFBKS("    str=\"""_PREFIX_"\"";")
"RTN","IBDFBKS2",109,0)
 ..N SUB S SUB=0 F  S SUB=$O(SUBFIELD(SUB)) Q:'SUB  D
"RTN","IBDFBKS2",110,0)
 ...D BLDARY^IBDFBKS("  sfstr=STRIP(GETAVALUE("_SUB_"));")
"RTN","IBDFBKS2",111,0)
 ...D BLDARY^IBDFBKS("str=STRCAT(str,sfstr);")
"RTN","IBDFBKS2",112,0)
 ...D BLDARY^IBDFBKS("if (sfstr!=\""\"") found=1;")
"RTN","IBDFBKS2",113,0)
 ...I SUBFIELD(SUB)'="" D BLDARY^IBDFBKS("str=STRCAT(sfstr,\"""_SUBFIELD(SUB)_"\"");")
"RTN","IBDFBKS2",114,0)
 ...D BLDARY^IBDFBKS("sfconf=GETCONF("_SUB_");")
"RTN","IBDFBKS2",115,0)
 ...D BLDARY^IBDFBKS("if (sfconf<conf) conf=sfconf;")
"RTN","IBDFBKS2",116,0)
 ..;
"RTN","IBDFBKS2",117,0)
 ..; patch 25 code starts here, remove dashes and dots
"RTN","IBDFBKS2",118,0)
 ..D BLDARY^IBDFBKS("")
"RTN","IBDFBKS2",119,0)
 ..D BLDARY^IBDFBKS("delfield = 0;")
"RTN","IBDFBKS2",120,0)
 ..D BLDARY^IBDFBKS("position = STRFIND(str,\"".\"",1);")
"RTN","IBDFBKS2",121,0)
 ..D BLDARY^IBDFBKS("if (position == 1) delfield = 1;")
"RTN","IBDFBKS2",122,0)
 ..D BLDARY^IBDFBKS("position = STRFIND(\""     .  -----..  -....-----.-.--.../////--/.@.\"",str,1);")
"RTN","IBDFBKS2",123,0)
 ..D BLDARY^IBDFBKS("if (position != 0 || delfield == 1) {")
"RTN","IBDFBKS2",124,0)
 ..D BLDARY^IBDFBKS("   if (str != \"".\"") LOG(STRCAT(\""The following handprint field "_FIELD_" value was deleted: \"",str));")
"RTN","IBDFBKS2",125,0)
 ..D BLDARY^IBDFBKS("   str = \""\"";")
"RTN","IBDFBKS2",126,0)
 ..D BLDARY^IBDFBKS("   conf = 10;")
"RTN","IBDFBKS2",127,0)
 ..D BLDARY^IBDFBKS("   found = 0;}")
"RTN","IBDFBKS2",128,0)
 ..D BLDARY^IBDFBKS("")
"RTN","IBDFBKS2",129,0)
 ..;
"RTN","IBDFBKS2",130,0)
 ..D BLDARY^IBDFBKS("if (found) ret=SETTEXT("_FIELD_",str,ITOA(conf-1),FIELD_OK);")
"RTN","IBDFBKS2",131,0)
 ..D BLDARY^IBDFBKS("if (found == 0) ret=SETTEXT("_FIELD_",\""\"",ITOA(conf-1),FIELD_BLANK);")
"RTN","IBDFBKS2",132,0)
 ..D BLDARY^IBDFBKS("};")
"RTN","IBDFBKS2",133,0)
 .;
"RTN","IBDFBKS2",134,0)
 .;for handprint fields,must prefix data exported with field info - for bubbles the XMAP has the field info
"RTN","IBDFBKS2",135,0)
 .S @FIELDS@(PAGE,FIELD)="H:"_IEN_":",@FIELDS@(PAGE,FIELD,"DATATYPE")=TYPEDATA
"RTN","IBDFBKS2",136,0)
 ;
"RTN","IBDFBKS2",137,0)
 ;following are handprint fields that don't need to be broken into subfields
"RTN","IBDFBKS2",138,0)
 ;
"RTN","IBDFBKS2",139,0)
 I READTYPE=1 D  ;not printed in ICR format
"RTN","IBDFBKS2",140,0)
 .D CNVRTHT^IBDF2D1(LINES,.LINES)
"RTN","IBDFBKS2",141,0)
 .S X2=X1+(103.65924*WIDTH*CONVERT),X2=$FN(X2,"",0)
"RTN","IBDFBKS2",142,0)
 .S Y2=Y1+(ROWHT*LINES*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",143,0)
 ;
"RTN","IBDFBKS2",144,0)
 I READTYPE'=1 D  ;printed in ICR format
"RTN","IBDFBKS2",145,0)
 .S X2=X1+(172.7654*WIDTH*CONVERT),X2=$FN(X2,"",0)
"RTN","IBDFBKS2",146,0)
 .S Y2=Y1+(180*LINES*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",147,0)
 ;
"RTN","IBDFBKS2",148,0)
 D PRINTEND^IBDFBKS3
"RTN","IBDFBKS2",149,0)
 D:READTYPE=2 PKFIELD(X1+2,Y1+2,X2-2,Y2-2,READTYPE,PICTURE,0,CONF,PKDICT,WIDTH,TYPEDATA,NAME,2)
"RTN","IBDFBKS2",150,0)
 ;
"RTN","IBDFBKS2",151,0)
 D:READTYPE'=2 PKFIELD(X1,Y1,X2,Y2,READTYPE,PICTURE,0,"","",LENGTH,TYPEDATA,NAME)
"RTN","IBDFBKS2",152,0)
 S @FIELDS@(PAGE,FIELD)="H:"_IEN_":",@FIELDS@(PAGE,FIELD,"DATATYPE")=TYPEDATA
"RTN","IBDFBKS2",153,0)
 ;
"RTN","IBDFBKS2",154,0)
 ;** END STUFF **
"RTN","IBDFBKS2",155,0)
 I READTYPE'=2 D  ;test the results of the marksense fields that were laid on top of the operator fill field
"RTN","IBDFBKS2",156,0)
 .D ADDTOEND^IBDFBKS3("  if ((hasprint)&&(FIELDACCEPTED==0)){")
"RTN","IBDFBKS2",157,0)
 .D ADDTOEND^IBDFBKS3("    FIELDSTATUS=FIELD_BAD;}")
"RTN","IBDFBKS2",158,0)
 Q
"RTN","IBDFBKS2",159,0)
 ;
"RTN","IBDFBKS2",160,0)
PKFIELD(X1,Y1,X2,Y2,READTYPE,PICTURE,HIDDEN,CONF,PKDICT,LENGTH,TYPEDATA,NAME,ENDPGM) ;
"RTN","IBDFBKS2",161,0)
 ; -- now for the handprint field
"RTN","IBDFBKS2",162,0)
 S FIELD=FIELD+1
"RTN","IBDFBKS2",163,0)
 D BLDARY^IBDFBKS("FIELD ' "_FIELD)
"RTN","IBDFBKS2",164,0)
 D BLDARY^IBDFBKS("  NAME = """_NAME_""";")
"RTN","IBDFBKS2",165,0)
 ;
"RTN","IBDFBKS2",166,0)
 I READTYPE=2 D
"RTN","IBDFBKS2",167,0)
 .D BLDARY^IBDFBKS("  ELEMTYPE = ELEM_OT;")
"RTN","IBDFBKS2",168,0)
 .D BLDARY^IBDFBKS("  METRIC = 2;")
"RTN","IBDFBKS2",169,0)
 ;
"RTN","IBDFBKS2",170,0)
 E  D
"RTN","IBDFBKS2",171,0)
 .D BLDARY^IBDFBKS("  ELEMTYPE = ELEM_OT;")
"RTN","IBDFBKS2",172,0)
 .D BLDARY^IBDFBKS("  METRIC = 1;")
"RTN","IBDFBKS2",173,0)
 ;
"RTN","IBDFBKS2",174,0)
 D BLDARY^IBDFBKS("  DATATYPE ="_TYPEDATA_";")
"RTN","IBDFBKS2",175,0)
 D BLDARY^IBDFBKS("  LENGTH = "_LENGTH_";")
"RTN","IBDFBKS2",176,0)
 D BLDARY^IBDFBKS("  POINTS = "_(Y1+XYSMALL)_" "_(X1+XYSMALL)_" "_(Y2-XYSMALL)_" "_(X2-XYSMALL)_";")
"RTN","IBDFBKS2",177,0)
 D BLDARY^IBDFBKS("  PAGE = "_PAGE_";")
"RTN","IBDFBKS2",178,0)
 I CONF'="" D BLDARY^IBDFBKS("  CONFIDENCE = """_CONF_""";")
"RTN","IBDFBKS2",179,0)
 I HIDDEN D BLDARY^IBDFBKS(" HIDDEN = ""1"";")
"RTN","IBDFBKS2",180,0)
 I $G(ENDPGM) D HPSKIP
"RTN","IBDFBKS2",181,0)
 ;
"RTN","IBDFBKS2",182,0)
 ;** IMAGE PROCESSING **
"RTN","IBDFBKS2",183,0)
 I READTYPE=2 D
"RTN","IBDFBKS2",184,0)
 .D BLDARY^IBDFBKS(" ImageProcessing = {")
"RTN","IBDFBKS2",185,0)
 .D BLDARY^IBDFBKS("   IMAGEPROC=1")
"RTN","IBDFBKS2",186,0)
 .D BLDARY^IBDFBKS("   DESKEW=0")
"RTN","IBDFBKS2",187,0)
 .D BLDARY^IBDFBKS("   DESHADE=0")
"RTN","IBDFBKS2",188,0)
 .D BLDARY^IBDFBKS("   SMOOTH=1")
"RTN","IBDFBKS2",189,0)
 .D BLDARY^IBDFBKS("   REMOVE_BORDER=1")
"RTN","IBDFBKS2",190,0)
 .D BLDARY^IBDFBKS("   REMOVE_NOISE=0")
"RTN","IBDFBKS2",191,0)
 .D BLDARY^IBDFBKS("   PROC_MIN_VERT_LINE_LEN=70")
"RTN","IBDFBKS2",192,0)
 .D BLDARY^IBDFBKS("   PROC_MIN_HORZ_LINE_LEN=70")
"RTN","IBDFBKS2",193,0)
 .D BLDARY^IBDFBKS("   FATTYPE=0")
"RTN","IBDFBKS2",194,0)
 .D BLDARY^IBDFBKS("   FATTEN=0};")
"RTN","IBDFBKS2",195,0)
 .D BLDARY^IBDFBKS("   Recognition = {FIXED_WIDTH=1")
"RTN","IBDFBKS2",196,0)
 .D BLDARY^IBDFBKS("   OT_RECOGTYPE=HP")
"RTN","IBDFBKS2",197,0)
 .D BLDARY^IBDFBKS("   };")
"RTN","IBDFBKS2",198,0)
 ;
"RTN","IBDFBKS2",199,0)
 ;** begin program **
"RTN","IBDFBKS2",200,0)
 I $G(ENDPGM)=2 D
"RTN","IBDFBKS2",201,0)
 .D BLDARY^IBDFBKS("BEGIN = {ALPHA str;")
"RTN","IBDFBKS2",202,0)
 .D BLDARY^IBDFBKS("INT conf;")
"RTN","IBDFBKS2",203,0)
 .D BLDARY^IBDFBKS("INT ret;")
"RTN","IBDFBKS2",204,0)
 .D BLDARY^IBDFBKS("  conf = GETCONF("_FIELD_");")
"RTN","IBDFBKS2",205,0)
 .D BLDARY^IBDFBKS("  if (GETSTATUS("_FIELD_") == FIELD_BLANK) {")
"RTN","IBDFBKS2",206,0)
 .D BLDARY^IBDFBKS("     ret=SETTEXT("_FIELD_",\""\"",ITOA(conf-1),FIELD_BLANK); }")
"RTN","IBDFBKS2",207,0)
 .D BLDARY^IBDFBKS("if (ret) FIELDSTATUS = FIELD_ERROR;")
"RTN","IBDFBKS2",208,0)
 .D BLDARY^IBDFBKS("};")
"RTN","IBDFBKS2",209,0)
 .;
"RTN","IBDFBKS2",210,0)
 I PKDICT'="" D BLDARY^IBDFBKS("  DICTIONARY = """_PKDICT_""";")
"RTN","IBDFBKS2",211,0)
 I PICTURE'="",TYPEDATA="ALPHA" D BLDARY^IBDFBKS("  PICTURE = """_PICTURE_""";")
"RTN","IBDFBKS2",212,0)
 Q
"RTN","IBDFBKS2",213,0)
HPSKIP ; If hand print field blank, skip it
"RTN","IBDFBKS2",214,0)
 D ADDTOEND^IBDFBKS3("   if ((GETSTATUS(FIELDNAME) != FIELD_BLANK) && (FIELDACCEPTED == 0)) {")
"RTN","IBDFBKS2",215,0)
 D ADDTOEND^IBDFBKS3("     FIELDSTATUS = FIELD_BAD;")
"RTN","IBDFBKS2",216,0)
 D ADDTOEND^IBDFBKS3("     saveunrf = "_FIELD_";}")
"RTN","IBDFBKS2",217,0)
 Q
"RTN","IBDFBKS4")
0^6^B22083850
"RTN","IBDFBKS4",1,0)
IBDFBKS4 ;ALB/AAS - Create form spec file for scanning ; 6-JUN-95
"RTN","IBDFBKS4",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3,25**;APR 24, 1997
"RTN","IBDFBKS4",3,0)
 ;
"RTN","IBDFBKS4",4,0)
RECOMP ;Recompiles all form specs for paper keyboard
"RTN","IBDFBKS4",5,0)
 N QZZ
"RTN","IBDFBKS4",6,0)
 S QZZ=0 F  S QZZ=$O(^IBD(359.2,QZZ)) Q:'QZZ  D SCAN^IBDFBKS(QZZ)
"RTN","IBDFBKS4",7,0)
 Q
"RTN","IBDFBKS4",8,0)
 ;
"RTN","IBDFBKS4",9,0)
FIELDS ;
"RTN","IBDFBKS4",10,0)
 S FLD=1 F  S FLD=$O(@FIELDS@(PAGE,FLD)) Q:'FLD  D
"RTN","IBDFBKS4",11,0)
 .N DATATP S DATATP=$G(@FIELDS@(PAGE,FLD,"DATATYPE"))
"RTN","IBDFBKS4",12,0)
 .I DATATP="" D  Q
"RTN","IBDFBKS4",13,0)
 ..S (LBEGIN,LEND,QUIT)=0
"RTN","IBDFBKS4",14,0)
 ..S LBEGIN=FLD F  S FLD=$O(@FIELDS@(PAGE,FLD)) Q:QUIT  D  Q:QUIT
"RTN","IBDFBKS4",15,0)
 ...I LEND=0,$S(FLD="":1,1:$G(@FIELDS@(PAGE,FLD,"DATATYPE"))'="") S FLD=LBEGIN D ONEBUB S QUIT=1 Q
"RTN","IBDFBKS4",16,0)
 ...I FLD="",LEND>LBEGIN D LOOP(LBEGIN,LEND) S FLD=LEND,QUIT=1 Q
"RTN","IBDFBKS4",17,0)
 ...I $G(@FIELDS@(PAGE,FLD,"DATATYPE"))'="" D LOOP(LBEGIN,LEND) S FLD=LEND,QUIT=1 Q
"RTN","IBDFBKS4",18,0)
 ...S LEND=FLD
"RTN","IBDFBKS4",19,0)
 ...Q
"RTN","IBDFBKS4",20,0)
 .;
"RTN","IBDFBKS4",21,0)
 .I DATATP'="" D
"RTN","IBDFBKS4",22,0)
 ..N TOSTRING
"RTN","IBDFBKS4",23,0)
 ..S TOSTRING=$S($G(@FIELDS@(PAGE,FLD,"START")):"narrative",1:"str")
"RTN","IBDFBKS4",24,0)
 ..;
"RTN","IBDFBKS4",25,0)
 ..D BLDARY^IBDFBKS(" "_TOSTRING_"=\""\"";")
"RTN","IBDFBKS4",26,0)
 ..;
"RTN","IBDFBKS4",27,0)
 ..I DATATP="ALPHA" D BLDARY^IBDFBKS(" if (GETSTATUS("_FLD_")==FIELD_OK) "_TOSTRING_"=STRIP(GETAVALUE("_FLD_"));") Q
"RTN","IBDFBKS4",28,0)
 ..;
"RTN","IBDFBKS4",29,0)
 ..I DATATP="FLOAT" D BLDARY^IBDFBKS(" if (GETSTATUS("_FLD_")==FIELD_OK) "_TOSTRING_"=STRIP(FTOA(GETFVALUE("_FLD_")));") Q
"RTN","IBDFBKS4",30,0)
 ..;
"RTN","IBDFBKS4",31,0)
 ..I DATATP="INT" D BLDARY^IBDFBKS(" if (GETSTATUS("_FLD_")==FIELD_OK) "_TOSTRING_"=STRIP(ITOA(GETIVALUE("_FLD_")));")  Q
"RTN","IBDFBKS4",32,0)
 ..;
"RTN","IBDFBKS4",33,0)
 ..I DATATP="DATE" D BLDARY^IBDFBKS(" if (GETSTATUS("_FLD_")==FIELD_OK) "_TOSTRING_"=STRIP(DTOA(GETIVALUE("_FLD_")));") Q
"RTN","IBDFBKS4",34,0)
 ..;
"RTN","IBDFBKS4",35,0)
 ..I DATATP="TIME" D BLDARY^IBDFBKS(" if (GETSTATUS("_FLD_")==FIELD_OK) "_TOSTRING_"=STRIP(TTOA(GETIVALUE("_FLD_")));") Q
"RTN","IBDFBKS4",36,0)
 ..;
"RTN","IBDFBKS4",37,0)
 ..;D BLDARY^IBDFBKS(" "_TOSTRING_"=STRFIELDS("_FLD_","_FLD_");") Q
"RTN","IBDFBKS4",38,0)
 .;
"RTN","IBDFBKS4",39,0)
 .I $G(@FIELDS@(PAGE,FLD,"MULT")),'$G(@FIELDS@(PAGE,FLD,"START")) D BLDARY^IBDFBKS(" if (str!=\""\"") narrative=STRIP(STRCAT(STRCAT(narrative,\"" \""),str));")
"RTN","IBDFBKS4",40,0)
 .;
"RTN","IBDFBKS4",41,0)
 .I '$G(@FIELDS@(PAGE,FLD,"MULT")) D
"RTN","IBDFBKS4",42,0)
 ..D BLDARY^IBDFBKS(" if (str != \""\"") {")
"RTN","IBDFBKS4",43,0)
 ..D BLDARY^IBDFBKS("   Data=Add;")
"RTN","IBDFBKS4",44,0)
 ..I @FIELDS@(PAGE,FLD)'="" D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"""_@FIELDS@(PAGE,FLD)_"\"");")
"RTN","IBDFBKS4",45,0)
 ..D BLDARY^IBDFBKS("   Data=STRCAT(Data,str);")
"RTN","IBDFBKS4",46,0)
 ..D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"",\"");")
"RTN","IBDFBKS4",47,0)
 ..D BLDARY^IBDFBKS("   if (ddechan != 0) result=DDEEXEC(ddechan,Data);}")
"RTN","IBDFBKS4",48,0)
 ..D BLDARY^IBDFBKS("   ")
"RTN","IBDFBKS4",49,0)
 .;
"RTN","IBDFBKS4",50,0)
 .I $G(@FIELDS@(PAGE,FLD,"END")) D
"RTN","IBDFBKS4",51,0)
 ..D BLDARY^IBDFBKS("    if (narrative!=\""\"") {")
"RTN","IBDFBKS4",52,0)
 ..D BLDARY^IBDFBKS("   Data=Add;")
"RTN","IBDFBKS4",53,0)
 ..I @FIELDS@(PAGE,FLD)'="" D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"""_@FIELDS@(PAGE,FLD)_"\"");")
"RTN","IBDFBKS4",54,0)
 ..D BLDARY^IBDFBKS("   Data=STRCAT(Data,narrative);")
"RTN","IBDFBKS4",55,0)
 ..I $P($G(@FIELDS@(PAGE,FLD)),":")'="H" D BLDARY^IBDFBKS("   Data=STRCAT(Add,str);")
"RTN","IBDFBKS4",56,0)
 ..D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"",\"");")
"RTN","IBDFBKS4",57,0)
 ..D BLDARY^IBDFBKS("   if (ddechan != 0) result=DDEEXEC(ddechan,Data);}")
"RTN","IBDFBKS4",58,0)
FIELDSQ Q
"RTN","IBDFBKS4",59,0)
 ;
"RTN","IBDFBKS4",60,0)
ONEBUB ; -- for a single bubble field
"RTN","IBDFBKS4",61,0)
 D BLDARY^IBDFBKS(" str=STRFIELDS("_FLD_","_FLD_");")
"RTN","IBDFBKS4",62,0)
 D BLDARY^IBDFBKS(" if (str!=\""\"") {")
"RTN","IBDFBKS4",63,0)
 I @FIELDS@(PAGE,FLD)'="" D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"""_@FIELDS@(PAGE,FLD)_"\"");")
"RTN","IBDFBKS4",64,0)
 D BLDARY^IBDFBKS("      Data=STRCAT(Add,str);")
"RTN","IBDFBKS4",65,0)
 D BLDARY^IBDFBKS("      Data=STRCAT(Data,\"",\"");")
"RTN","IBDFBKS4",66,0)
 D BLDARY^IBDFBKS("      if (ddechan != 0) result=DDEEXEC(ddechan,Data);}")
"RTN","IBDFBKS4",67,0)
 Q
"RTN","IBDFBKS4",68,0)
 ;
"RTN","IBDFBKS4",69,0)
LOOP(LBEGIN,LEND) ; -- Loop through fields instead of one by one
"RTN","IBDFBKS4",70,0)
 D BLDARY^IBDFBKS("  ")
"RTN","IBDFBKS4",71,0)
 D BLDARY^IBDFBKS(" loop="_LBEGIN_";")
"RTN","IBDFBKS4",72,0)
 D BLDARY^IBDFBKS(" while (loop < "_(LEND+1)_"){")
"RTN","IBDFBKS4",73,0)
 D BLDARY^IBDFBKS("   str=STRFIELDS(loop,loop);")
"RTN","IBDFBKS4",74,0)
 D BLDARY^IBDFBKS("   if (str!=\""\"") {")
"RTN","IBDFBKS4",75,0)
 D BLDARY^IBDFBKS("      Data=STRCAT(Add,str);")
"RTN","IBDFBKS4",76,0)
 D BLDARY^IBDFBKS("      Data=STRCAT(Data,\"",\"");")
"RTN","IBDFBKS4",77,0)
 D BLDARY^IBDFBKS("      if (ddechan != 0) result=DDEEXEC(ddechan,Data);}")
"RTN","IBDFBKS4",78,0)
 D BLDARY^IBDFBKS("   loop=loop+1;")
"RTN","IBDFBKS4",79,0)
 D BLDARY^IBDFBKS(" if (loop > "_LEND_") break;}")
"RTN","IBDFBKS4",80,0)
 D BLDARY^IBDFBKS("  ")
"RTN","IBDFBKS4",81,0)
 Q
"RTN","IBDFBKS4",82,0)
 ;
"RTN","IBDFBKS4",83,0)
 ;;loop=9;
"RTN","IBDFBKS4",84,0)
 ;;while (loop < 51){
"RTN","IBDFBKS4",85,0)
 ;;    str=STRFIELDS(loop,loop);
"RTN","IBDFBKS4",86,0)
 ;;    if (str!=\"\") {
"RTN","IBDFBKS4",87,0)
 ;;      Data=STRCAT(Data,str);
"RTN","IBDFBKS4",88,0)
 ;;      Data=STRCAT(Data,RS);}
"RTN","IBDFBKS4",89,0)
 ;;   loop=loop+1;
"RTN","IBDFBKS4",90,0)
 ;;   if (loop > 51) break;
"RTN","IBDFBKS4",91,0)
 ;;   }
"RTN","IBDFBKS4",92,0)
 ;;
"RTN","IBDFBKS4",93,0)
 ;;\'SHOW(Data);
"RTN","IBDFBKS4",94,0)
DATA1 ;;    Data = STRCAT(\"FORMTYPE=153\", RS);
"RTN","IBDFBKS4",95,0)
 ;;    Data = STRCAT(Data, \"FORMID=\");
"RTN","IBDFBKS4",96,0)
 ;;    Data = STRCAT(Data, ITOA(GETIVALUE(7)));
"RTN","IBDFBKS4",97,0)
 ;;    Data = STRCAT(Data,RS);
"RTN","IBDFBKS4",98,0)
 ;;    Data = STRCAT(Data,\"PAGE=1\");
"RTN","IBDFBKS4",99,0)
 ;;    Data = STRCAT(Data,RS);
"RTN","IBDFBKS4",100,0)
 ;;    Data = STRCAT(Data, \"DATA=\");
"RTN","IBDFBKS4",101,0)
 ;;    Data = STRCAT(Data,RS);
"RTN","IBDFBKS4",102,0)
 ;;
"RTN","IBDFESP")
0^3^B8077950
"RTN","IBDFESP",1,0)
IBDFESP ;ALB/AAS - AICS EDIT SITE PARAMS ; 19-DEC-95
"RTN","IBDFESP",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**15,25**;APR 24, 1997
"RTN","IBDFESP",3,0)
 ;
"RTN","IBDFESP",4,0)
EDIT ; -- edit site parameters
"RTN","IBDFESP",5,0)
 I '$D(DT) D DT^DICRW
"RTN","IBDFESP",6,0)
 N DIC,DIE,DA,DR,X,Y,HOLD,HOLD2
"RTN","IBDFESP",7,0)
 I $G(^IBD(357.09,1,0))="" D CREATE
"RTN","IBDFESP",8,0)
 S DIE="^IBD(357.09,",DA=1
"RTN","IBDFESP",9,0)
 S HOLD=$P($G(^IBD(357.09,DA,0)),"^",8,9)
"RTN","IBDFESP",10,0)
 S HOLD2=$P($G(^IBD(357.09,DA,0)),"^",12)
"RTN","IBDFESP",11,0)
 W !!,"Edit AICS Site Parameters"
"RTN","IBDFESP",12,0)
 W !!,"Form Tracking Purge Parameters"
"RTN","IBDFESP",13,0)
 S DR=".02;.03;1.01;W !!,""Data Entry Parameters"";.04;.06;.07;W !!,""Print Parameters"";.05//YES;.1//30;.13//12;.14//25;W !!,""Scanning Parameters"";I '$D(^XUSEC(""IBD MANAGER"",DUZ)) S Y=1.02;.08//20;.09//5;.12//2;1.02;.11"
"RTN","IBDFESP",14,0)
 D ^DIE
"RTN","IBDFESP",15,0)
 ;
"RTN","IBDFESP",16,0)
 ; -- if scanning parameters have changed, force a regen. of all fs
"RTN","IBDFESP",17,0)
 I (HOLD'=$P($G(^IBD(357.09,DA,0)),"^",8,9))!(HOLD2'=$P($G(^IBD(357.09,DA,0)),"^",12)) D
"RTN","IBDFESP",18,0)
 .W !!,$C(7),"***SCANNING PERCENTAGES HAVE CHANGED***"
"RTN","IBDFESP",19,0)
 .W !!,"In order for scanning % changes to take affect, you MUST DELETE ALL",!,"Form Specification files from EVERY workstation.  Delete EF*.FS files using",!,"the FILE, DELETE FORMSPEC options on the AICS Workstation screen!"
"RTN","IBDFESP",20,0)
 .S ZTRTN="FSPEC^IBDFESP",ZTDESC="IBD - REGENERATE FORM SPECS",ZTDTH=$H,ZTIO="" D ^%ZTLOAD
"RTN","IBDFESP",21,0)
 .W !!,$S($D(ZTSK):"Form Spec Regeneration task # "_ZTSK,1:"Form Spec Regeneration failed, edit scanning parameters again!") D HOME^%ZIS
"RTN","IBDFESP",22,0)
 Q
"RTN","IBDFESP",23,0)
 ;
"RTN","IBDFESP",24,0)
CREATE ; -- create entry in new parameters file 357.09
"RTN","IBDFESP",25,0)
 I $G(^IBD(357.09,1,0))'="" Q
"RTN","IBDFESP",26,0)
 N DLAYGO
"RTN","IBDFESP",27,0)
 S DIC="^IBD(357.09,",DINUM=1,X=$P($$SITE^VASITE,"^",2),DIC(0)="L",DLAYGO=357.09 D FILE^DICN Q:+Y<1
"RTN","IBDFESP",28,0)
 S $P(^IBD(357.09,1,0),"^",5)=1 ; set print inpatients to yes
"RTN","IBDFESP",29,0)
 S ^IBD(357.09,1,"Q",0)="^357.091A^"
"RTN","IBDFESP",30,0)
 Q
"RTN","IBDFESP",31,0)
FSPEC ;Form Specs deleted from file 359.2  FORM SPEC file.
"RTN","IBDFESP",32,0)
 N IBDIFN
"RTN","IBDFESP",33,0)
 S IBDIFN=0
"RTN","IBDFESP",34,0)
 F  S IBDIFN=$O(^IBD(359.2,IBDIFN)) Q:IBDIFN']""  I $D(^IBD(357.95,IBDIFN,0)) D SCAN^IBDFBKS(IBDIFN)
"RTN","IBDFESP",35,0)
 Q
"RTN","IBDFM1")
0^11^B41030043
"RTN","IBDFM1",1,0)
IBDFM1 ;ALB/CJM - Compiling bubbles and hand print fields;3/1/93
"RTN","IBDFM1",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**13,25**;APR 24, 1997
"RTN","IBDFM1",3,0)
 ;
"RTN","IBDFM1",4,0)
DRWBBL(ROW,COL,PI,VALUE,FNAME,FID,ALLOWED,DISPLAY,HDR,QLFR,DYN,CNT,SUBHDR,QTY,ND2) ;
"RTN","IBDFM1",5,0)
 ;returns "" if no bubble created, else the ien
"RTN","IBDFM1",6,0)
 ;
"RTN","IBDFM1",7,0)
 N BUBBLE
"RTN","IBDFM1",8,0)
 S DISPLAY=$E(DISPLAY,1,80),HDR=$E(HDR,1,40)
"RTN","IBDFM1",9,0)
 S DISPLAY=$TR(DISPLAY,"""\","``")
"RTN","IBDFM1",10,0)
 S DYN=+$G(DYN),CNT=+$G(CNT)
"RTN","IBDFM1",11,0)
 ;
"RTN","IBDFM1",12,0)
 ;don't want to associate a value with the bubble if there is no input interface for the type of data
"RTN","IBDFM1",13,0)
 I 'PI S VALUE=""
"RTN","IBDFM1",14,0)
 ;
"RTN","IBDFM1",15,0)
 ;compiling blocks?
"RTN","IBDFM1",16,0)
 I IBPRINT("COMPILING_BLOCKS") D CMPBBL Q:'IBPRINT("WRITE_IF_COMPILING")
"RTN","IBDFM1",17,0)
 ;
"RTN","IBDFM1",18,0)
 ;don't draw a bubble if in the list processor
"RTN","IBDFM1",19,0)
 Q:IBDEVICE("LISTMAN")
"RTN","IBDFM1",20,0)
 ;
"RTN","IBDFM1",21,0)
 ;add the offsets for the block to position
"RTN","IBDFM1",22,0)
 S ROW=ROW+IBBLK("Y"),COL=COL+IBBLK("X")
"RTN","IBDFM1",23,0)
 ;
"RTN","IBDFM1",24,0)
 ;might not be creating a FORM DEFINITION TABLE - case of toolkit form
"RTN","IBDFM1",25,0)
 I IBFORM("TOOLKIT") S @IBARRAY("BUBBLES")@(ROW,COL)="" Q
"RTN","IBDFM1",26,0)
 ;
"RTN","IBDFM1",27,0)
 ;case of FORM DEFINITION TABLE being created - all forms but toolkit
"RTN","IBDFM1",28,0)
 Q:IBFORM("COMPILED")="F"  ;something already went wrong
"RTN","IBDFM1",29,0)
 I IBFORM("TYPE") I $D(^IBD(357.95,IBFORM("TYPE"),0))
"RTN","IBDFM1",30,0)
 E  S IBFORM("TYPE")=$$NEWTABLE(.IBFORM)
"RTN","IBDFM1",31,0)
 I 'IBFORM("TYPE") D UNCMPL^IBDF19(.IBFORM,1) Q
"RTN","IBDFM1",32,0)
 ;
"RTN","IBDFM1",33,0)
 ;add the bubble to the table
"RTN","IBDFM1",34,0)
 K DIC,D0,DINUM,DD S DIC="^IBD(357.95,"_IBFORM("TYPE")_",1,",X=ROW,DA(1)=IBFORM("TYPE"),DIC(0)=""
"RTN","IBDFM1",35,0)
 D FILE^DICN K DIC,DIE,DA
"RTN","IBDFM1",36,0)
 S BUBBLE=$S(+Y<0:"",1:+Y)
"RTN","IBDFM1",37,0)
 I 'BUBBLE D UNCMPL^IBDF19(.IBFORM,1) Q
"RTN","IBDFM1",38,0)
 I BUBBLE D
"RTN","IBDFM1",39,0)
 .D INPUT^IBDFU91(PI,.VALUE) I '$D(VALUE) S VALUE=""
"RTN","IBDFM1",40,0)
 .S ^IBD(357.95,IBFORM("TYPE"),1,BUBBLE,0)=ROW_"^"_COL_"^"_PI_"^"_VALUE_"^"_$G(FNAME)_"^"_FID_"^"_ALLOWED_"^"_DISPLAY_"^"_HDR_"^"_QLFR_"^"_DYN_"^"_CNT_"^"_$G(QTY)
"RTN","IBDFM1",41,0)
 .I $L($G(SUBHDR)) S ^IBD(357.95,IBFORM("TYPE"),1,BUBBLE,1)=$E(SUBHDR,1,250)
"RTN","IBDFM1",42,0)
 .I $L($G(ND2)) D
"RTN","IBDFM1",43,0)
 ..; -- change external format of 2nd & 3rd codes to internal format
"RTN","IBDFM1",44,0)
 ..N IBJ,IBVAL F IBJ=3,4 S IBVAL=$P(ND2,"^",IBJ) I IBVAL]"" D INPUT^IBDFU91(PI,.IBVAL) S $P(ND2,"^",IBJ)=$S($D(IBVAL):IBVAL,1:"")
"RTN","IBDFM1",45,0)
 ..S ^IBD(357.95,IBFORM("TYPE"),1,BUBBLE,2)=ND2
"RTN","IBDFM1",46,0)
 .K DIK,DA S DIK="^IBD(357.95,"_IBFORM("TYPE")_",1,",DA=BUBBLE,DA(1)=IBFORM("TYPE") D IX1^DIK K DIK,DA
"RTN","IBDFM1",47,0)
 Q
"RTN","IBDFM1",48,0)
 ;
"RTN","IBDFM1",49,0)
NEWTABLE(IBFORM) ;creates a new FORM DEFINITION table
"RTN","IBDFM1",50,0)
 ;returns the ien of the table created, "" if not created
"RTN","IBDFM1",51,0)
 N NODE,SUB,CNT
"RTN","IBDFM1",52,0)
 S IBFORM("TYPE")=$$FORMTYPE^IBDF18D(1)
"RTN","IBDFM1",53,0)
 Q:'IBFORM("TYPE")
"RTN","IBDFM1",54,0)
 S NODE=$G(^IBE(357,IBFORM,0))
"RTN","IBDFM1",55,0)
 S $P(^IBD(357.95,IBFORM("TYPE"),0),"^",9,19)=$P(NODE,"^",9,19) ;not all  19 pieces may exist
"RTN","IBDFM1",56,0)
 S $P(^IBD(357.95,IBFORM("TYPE"),0),"^",20,21)=DT_"^"_IBFORM
"RTN","IBDFM1",57,0)
 S $P(^IBE(357,IBFORM,0),"^",13)=IBFORM("TYPE")
"RTN","IBDFM1",58,0)
 S (CNT,SUB)=0 F  S SUB=$O(^IBE(357,IBFORM,2,SUB)) Q:'SUB  S NODE=$G(^IBE(357,IBFORM,2,SUB,0)) Q:('+NODE)!('$P(NODE,"^",2))  S CNT=CNT+1,^IBD(357.95,IBFORM("TYPE"),3,CNT,0)=+NODE_"^1",^IBD(357.95,IBFORM("TYPE"),3,"B",+NODE,CNT)=""
"RTN","IBDFM1",59,0)
 S $P(^IBD(357.95,IBFORM("TYPE"),3,0),"^",3,4)=CNT_"^"_CNT
"RTN","IBDFM1",60,0)
 Q IBFORM("TYPE")
"RTN","IBDFM1",61,0)
 ;
"RTN","IBDFM1",62,0)
CMPBBL ;save compiled bubbles for the block
"RTN","IBDFM1",63,0)
 S IBWRTCNT("B")=IBWRTCNT("B")+1
"RTN","IBDFM1",64,0)
 S ^IBE(357.1,IBBLK,"B",IBWRTCNT("B"),0)=ROW_"^"_COL_"^"_PI_"^"_VALUE_"^"_FNAME_"^"_FID_"^"_ALLOWED_"^"_DISPLAY_"^"_HDR_"^"_QLFR_"^"_DYN_"^"_CNT_"^"_$G(QTY)
"RTN","IBDFM1",65,0)
 I $L($G(SUBHDR)) S ^IBE(357.1,IBBLK,"B",IBWRTCNT("B"),1)=$E(SUBHDR,1,250)
"RTN","IBDFM1",66,0)
 I $L($G(ND2)) S ^IBE(357.1,IBBLK,"B",IBWRTCNT("B"),2)=ND2
"RTN","IBDFM1",67,0)
 Q
"RTN","IBDFM1",68,0)
 ;
"RTN","IBDFM1",69,0)
CMPHAND ;save compiled hand print fields for the block
"RTN","IBDFM1",70,0)
 S IBWRTCNT("H")=IBWRTCNT("H")+1
"RTN","IBDFM1",71,0)
 S ^IBE(357.1,IBBLK,"H",IBWRTCNT("H"),0)=ROW_"^"_COL_"^"_WIDTH_"^"_PI_"^^"_LINES_"^"_FID_"^"_FNAME_"^"_HDR_"^"_QLFR_"^^"_ITEM_"^^"_PRINT_"^"_READ_"^^"_TYPEDATA
"RTN","IBDFM1",72,0)
 Q
"RTN","IBDFM1",73,0)
 ;
"RTN","IBDFM1",74,0)
DRWHAND(ROW,COL,WIDTH,PI,LINES,FID,FNAME,HDR,QLFR,ITEM,PRINT,READ,TYPEDATA) ;creates hand print field
"RTN","IBDFM1",75,0)
 N NODE
"RTN","IBDFM1",76,0)
 S NODE=""
"RTN","IBDFM1",77,0)
 ;
"RTN","IBDFM1",78,0)
 S ITEM=$G(ITEM),PRINT=$G(PRINT),READ=$G(READ),TYPEDATA=$G(TYPEDATA)
"RTN","IBDFM1",79,0)
 ;returns "" if no hand print field created, else the ien
"RTN","IBDFM1",80,0)
 Q:('$D(ROW))!('$D(COL))
"RTN","IBDFM1",81,0)
 N HANDPRNT
"RTN","IBDFM1",82,0)
 S HDR=$E(HDR,1,40)
"RTN","IBDFM1",83,0)
 ;
"RTN","IBDFM1",84,0)
 ;compiling blocks?
"RTN","IBDFM1",85,0)
 I IBPRINT("COMPILING_BLOCKS") D CMPHAND Q:'IBPRINT("WRITE_IF_COMPILING")
"RTN","IBDFM1",86,0)
 ;
"RTN","IBDFM1",87,0)
 ;don't draw hand print field if in the list processor
"RTN","IBDFM1",88,0)
 Q:IBDEVICE("LISTMAN")
"RTN","IBDFM1",89,0)
 ;
"RTN","IBDFM1",90,0)
 ;add the offsets for the block to position
"RTN","IBDFM1",91,0)
 S ROW=ROW+IBBLK("Y"),COL=COL+IBBLK("X")
"RTN","IBDFM1",92,0)
 ;
"RTN","IBDFM1",93,0)
 ;might not be creating a FORM DEFINITION TABLE - case of toolkit form
"RTN","IBDFM1",94,0)
 I IBFORM("TOOLKIT") D  Q
"RTN","IBDFM1",95,0)
 .N CNT S CNT=+$G(@IBARRAY("HAND_PRINT"))+1
"RTN","IBDFM1",96,0)
 .S @IBARRAY("HAND_PRINT")@(ROW,COL,CNT)=ROW_"^"_COL_"^"_WIDTH_"^"_PI_"^"_FNAME_"^"_LINES_"^^"_FID_"^"_HDR_"^"_QLFR_"^^"_ITEM_"^^"_PRINT_"^"_READ_"^^"_TYPEDATA
"RTN","IBDFM1",97,0)
 ;
"RTN","IBDFM1",98,0)
 ;case of FORM DEFINITION TABLE being created - all forms but toolkit
"RTN","IBDFM1",99,0)
 Q:IBFORM("COMPILED")="F"  ;something already went wrong
"RTN","IBDFM1",100,0)
 I IBFORM("TYPE") I $D(^IBD(357.95,IBFORM("TYPE"),0))
"RTN","IBDFM1",101,0)
 E  S IBFORM("TYPE")=$$NEWTABLE(.IBFORM)
"RTN","IBDFM1",102,0)
 ;if 'IBFORM("TYPE") want to recompile this next time around
"RTN","IBDFM1",103,0)
 I 'IBFORM("TYPE") D UNCMPL^IBDF19(.IBFORM,1) Q
"RTN","IBDFM1",104,0)
 ;
"RTN","IBDFM1",105,0)
 ;add the handprint field to the table
"RTN","IBDFM1",106,0)
 K DIC,D0,DINUM,DD S DIC="^IBD(357.95,"_IBFORM("TYPE")_",2,",X=ROW,DA(1)=IBFORM("TYPE"),DIC(0)=""
"RTN","IBDFM1",107,0)
 D FILE^DICN K DIC,DIE,DA
"RTN","IBDFM1",108,0)
 S HANDPRNT=$S(+Y<0:"",1:+Y)
"RTN","IBDFM1",109,0)
 I 'HANDPRNT D UNCMPL^IBDF19(.IBFORM,1) Q
"RTN","IBDFM1",110,0)
 I HANDPRNT D
"RTN","IBDFM1",111,0)
 .S ^IBD(357.95,IBFORM("TYPE"),2,HANDPRNT,0)=ROW_"^"_COL_"^"_WIDTH_"^"_PI_"^"_FNAME_"^"_LINES_"^^"_FID_"^"_HDR_"^"_QLFR_"^^"_ITEM_"^^"_PRINT_"^"_READ_"^^"_TYPEDATA
"RTN","IBDFM1",112,0)
 .K DIK,DA S DIK="^IBD(357.95,"_IBFORM("TYPE")_",2,",DA=HANDPRNT,DA(1)=IBFORM("TYPE") D IX1^DIK K DIK,DA
"RTN","IBDFM1",113,0)
 Q
"RTN","IBDFM1",114,0)
 ;
"RTN","IBDFM1",115,0)
TRACKBBL(FID,COUNT,QLFR,PI,DISPLAY,VALUE) ;
"RTN","IBDFM1",116,0)
 ;IBPFID, the id in form tracking, should be defined
"RTN","IBDFM1",117,0)
 ;
"RTN","IBDFM1",118,0)
 ; -- do not re-file dynamic data if reprint
"RTN","IBDFM1",119,0)
 Q:$G(REPRINT)
"RTN","IBDFM1",120,0)
 ;N SUB,NODE
"RTN","IBDFM1",121,0)
 ;S NODE=$G(^IBD(357.96,IBPFID,1,0))
"RTN","IBDFM1",122,0)
 ;S SUB=$P(NODE,"^",3)
"RTN","IBDFM1",123,0)
 ;S SUB=SUB+1,$P(NODE,"^",3,4)=SUB_"^"_SUB
"RTN","IBDFM1",124,0)
 ;D INPUT^IBDFU91(PI,.VALUE) I '$D(VALUE) S VALUE=""
"RTN","IBDFM1",125,0)
 ;S ^IBD(357.96,IBPFID,1,SUB,0)=COUNT_"^^"_PI_"^"_VALUE_"^^"_FID_"^^"_DISPLAY_"^^"_QLFR
"RTN","IBDFM1",126,0)
 ;S ^IBD(357.96,IBPFID,1,0)=NODE
"RTN","IBDFM1",127,0)
 ;K DIK,DA S DIK="^IBD(357.96,IBPFID,1,",DA=SUB,DA(1)=IBPFID D IX^DIK K DIK,DA
"RTN","IBDFM1",128,0)
 ;
"RTN","IBDFM1",129,0)
 ; -- for problem list, move the narrative to one piece for storing
"RTN","IBDFM1",130,0)
 S DISPLAY=$$DISP(DISPLAY)
"RTN","IBDFM1",131,0)
 ;
"RTN","IBDFM1",132,0)
 D INPUT^IBDFU91(PI,.VALUE) I '$D(VALUE) S VALUE=""
"RTN","IBDFM1",133,0)
 S X=COUNT
"RTN","IBDFM1",134,0)
 S DLAYGO=357.96
"RTN","IBDFM1",135,0)
 S DIC="^IBD(357.96,IBPFID,1,"
"RTN","IBDFM1",136,0)
 S DIC(0)="L"
"RTN","IBDFM1",137,0)
 S DIC("P")=$P(^DD(357.96,1,0),"^",2)
"RTN","IBDFM1",138,0)
 S DA(1)=IBPFID
"RTN","IBDFM1",139,0)
 S DIC("DR")=".03////^S X=PI;.04////^S X=VALUE;.06////^S X=FID;.08////^S X=$E(DISPLAY,1,80);.1////^S X=QLFR"
"RTN","IBDFM1",140,0)
 K DD,DO D FILE^DICN K DIC,DA,DLAYGO,DD,DO
"RTN","IBDFM1",141,0)
 Q
"RTN","IBDFM1",142,0)
 ;
"RTN","IBDFM1",143,0)
DISP(DIS) ; -- display narrative :: piece
"RTN","IBDFM1",144,0)
 N I,J
"RTN","IBDFM1",145,0)
 S DIS=$E($G(DIS),1,80)
"RTN","IBDFM1",146,0)
 G:DIS="" DISPQ
"RTN","IBDFM1",147,0)
 G:DIS'[" :: " DISPQ
"RTN","IBDFM1",148,0)
 I $P(DIS," :: ",2,99)="" S DIS=$P(DIS," :: ",1) G DISPQ
"RTN","IBDFM1",149,0)
 ;
"RTN","IBDFM1",150,0)
 F I=1:1 D  Q:$P(DIS," :: ",2,99)=""
"RTN","IBDFM1",151,0)
 . ;
"RTN","IBDFM1",152,0)
 . ; -- sometimes the string contains "nnnnn ::  ::  :: narrative"
"RTN","IBDFM1",153,0)
 . I $E(DIS,1,4)=" :: " S DIS=$E(DIS,5,80) Q
"RTN","IBDFM1",154,0)
 . ;
"RTN","IBDFM1",155,0)
 . ; -- get rid of leading spaces
"RTN","IBDFM1",156,0)
 . F J=1:1 Q:$E(DIS)'=" "  S DIS=$E(DIS,2,80)
"RTN","IBDFM1",157,0)
 . ;
"RTN","IBDFM1",158,0)
 . ; -- get rid of piece one if Numeric code
"RTN","IBDFM1",159,0)
 . I +DIS>0 S DIS=$P(DIS," :: ",2,99) Q
"RTN","IBDFM1",160,0)
 . ;
"RTN","IBDFM1",161,0)
 . ; -- get rid of piece one if alpha numeric (cpt) code
"RTN","IBDFM1",162,0)
 . I +DIS=0,$P(DIS," :: ",1)?1U4N S DIS=$P(DIS," :: ",2,99) Q
"RTN","IBDFM1",163,0)
 . ;
"RTN","IBDFM1",164,0)
 . ; -- get rid of piece one if alpha numeric icd code
"RTN","IBDFM1",165,0)
 . I +DIS=0,$P(DIS," :: ",1)?1U2.3N.1".".2N S DIS=$P(DIS," :: ",2,99) Q
"RTN","IBDFM1",166,0)
 . ;
"RTN","IBDFM1",167,0)
 . ; -- must be text in piece one, use it as text
"RTN","IBDFM1",168,0)
 . I +DIS=0 S DIS=$P(DIS," :: ",1) Q
"RTN","IBDFM1",169,0)
DISPQ I DIS=" :: " S DIS="Unknown"
"RTN","IBDFM1",170,0)
 Q DIS
"RTN","IBDFN3")
0^23^B5536651
"RTN","IBDFN3",1,0)
IBDFN3 ;ALB/CJM - ENCOUNTER FORM - (entry points for reports);5/21/93
"RTN","IBDFN3",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**20,25**;APR 24, 1997
"RTN","IBDFN3",3,0)
RXPROF ;Outpatient Pharmacy Action Profile and Information Profile
"RTN","IBDFN3",4,0)
 ;INPUTS:
"RTN","IBDFN3",5,0)
 ;PSDAYS = number of days to print the medication profile for
"RTN","IBDFN3",6,0)
 ;PSTYPE=1 for the Action Profile, =0 for the Information Profile
"RTN","IBDFN3",7,0)
 ;PSONOPG=1 variable needed to indicate to Profiles to not close device
"RTN","IBDFN3",8,0)
 ;PSOSITE= Division -- ien from file 40.8, not always same as in file 59
"RTN","IBDFN3",9,0)
 ;DFN
"RTN","IBDFN3",10,0)
 ;
"RTN","IBDFN3",11,0)
 N IBDFN,ADDR,ADDRFL,CLASS,CNDT,DRUG,HDFL,I,II,J,L,LINE,P,PAGE,PSDOB,PSIIX,PSNAME,PSOI,PSSN,PSIX,PGM,PRF,PSDATE,VAL,VAR,RX,RX0,RX2,ST,ST0,PSDAY,RF,RFS
"RTN","IBDFN3",12,0)
 N PSOPRINT,X1,X2,ZTSK,X,Y,PSII,PSDT,LMI,PSCNT,PSDIS,RXCNTLN,ELN,FN,CNT,VAERR,LN,PCLASS,PSOIFSUP,PSOINST,PSOSITE,PSONOPG,DUOUT,DTOUT,DIRUT
"RTN","IBDFN3",13,0)
 Q:(+$G(DFN)=0)
"RTN","IBDFN3",14,0)
 S IBDFN=DFN
"RTN","IBDFN3",15,0)
 S X1=DT,X2=-PSDAYS D C^%DTC S (PSDATE,PSDAY)=X
"RTN","IBDFN3",16,0)
 S LINE=$TR($J(" ",IOM)," ","-")
"RTN","IBDFN3",17,0)
 ;
"RTN","IBDFN3",18,0)
 ; -- get site name, turn on barcoding, set to not close device
"RTN","IBDFN3",19,0)
 S PSOINST=$P($$SITE^VASITE,"^",3)
"RTN","IBDFN3",20,0)
 S PSOPAR=1,PSONOPG=1
"RTN","IBDFN3",21,0)
 I $G(IBCLINIC)]"" S PSOSITE=$P($G(^SC(IBCLINIC,0)),"^",15)
"RTN","IBDFN3",22,0)
 I $G(PSTYPE)=0 S PAGE=1 D DFN^PSOSD1 ; -- Informational Profile
"RTN","IBDFN3",23,0)
 I $G(PSTYPE)=1 S PAGE=1 D DFN^PSOSD1 ; -- Action Profile
"RTN","IBDFN3",24,0)
 W:$Y @IOF
"RTN","IBDFN3",25,0)
 ;
"RTN","IBDFN3",26,0)
 S DFN=IBDFN
"RTN","IBDFN3",27,0)
 K VA,VAEL,VAPA
"RTN","IBDFN3",28,0)
 Q
"RTN","IBDFN3",29,0)
 ;
"RTN","IBDFN3",30,0)
DRUGS ;prints the medication profile of Outpatient Pharmacy
"RTN","IBDFN3",31,0)
 ;doesn't seem to be needed, integration agreement not obtained to use this
"RTN","IBDFN3",32,0)
 ;INPUTS:
"RTN","IBDFN3",33,0)
 ;PLS=0 for long, 1 for short
"RTN","IBDFN3",34,0)
 ;PSRT="D" to sort by date, "M" to sort by medication, "C" to sort by class
"RTN","IBDFN3",35,0)
 ;DFN
"RTN","IBDFN3",36,0)
 ;
"RTN","IBDFN3",37,0)
 ;N IBDFN,DRUG,ZII,PHYS,CT,AL,I1,REF,LMI,PI,FN,Y,I,J,RX,DRX,ST,RX0,RX2,DA,D0,DIC,DIPGM,II,K,ST0,TEMP,Z,LMI,RXD,RXF,PI,AL,D0,DIPGM,II,PSCNT,PSDIV,PSLC,PSDIS
"RTN","IBDFN3",38,0)
 ;
"RTN","IBDFN3",39,0)
 ;S (FN,IBDFN,D0,DA)=DFN
"RTN","IBDFN3",40,0)
 ;I '$D(^PS(55,IBDFN,"P")),'$D(^("ARC")) D ^PSODEM W !?20,"NO PHARMACY INFORMATION" G RXQ
"RTN","IBDFN3",41,0)
 ;I '$O(^PS(55,IBDFN,"P",0)),$D(^PS(55,IBDFN,"ARC")) D ^PSODEM W !!,"PATIENT HAS ARCHIVED PRESCRIPTIONS",! G RXQ
"RTN","IBDFN3",42,0)
 ;D P^PSOP
"RTN","IBDFN3",43,0)
RXQ ;W @IOF
"RTN","IBDFN3",44,0)
 ;S DFN=IBDFN
"RTN","IBDFN3",45,0)
 ;K ^UTILITY($J)
"RTN","IBDFN3",46,0)
 Q
"RTN","IBDFN3",47,0)
ROUTING ;entry point for printing a routing sheet for a single patient
"RTN","IBDFN3",48,0)
 ;Sets IBPRINT=1 so that it will be known that this entry point was used
"RTN","IBDFN3",49,0)
 ;inputs - 
"RTN","IBDFN3",50,0)
 ;    DFN
"RTN","IBDFN3",51,0)
 ;    IBAPPT - the appointment
"RTN","IBDFN3",52,0)
 ;    IBCLINIC - pointer to the clinic
"RTN","IBDFN3",53,0)
 ;protect variables that may be changed
"RTN","IBDFN3",54,0)
 N %,%DT,%I,ADDR,ALL,APDATE,IBDFN,DGMT,DIC,DIV,G,GDATE,H,I,J,K,L,LL,M,NAME,NDATE,ORD,ORDER,P,POP,PRDATE
"RTN","IBDFN3",55,0)
 N SC,SDA,SDATE,SDCNT,SDI,SDI1,SDIQ,SDM,SDREP,SDSP,SDSTART,SDVA,SDX,SDX1,SSN,SZ,TDO,X,X1,Y,ZIP,ZX,VAR,C,V,SDEF,A,SD,SCN,SDTD,SDSCCOND,SDPARMS
"RTN","IBDFN3",56,0)
 ;
"RTN","IBDFN3",57,0)
 ;protect DFN
"RTN","IBDFN3",58,0)
 Q:(+$G(DFN)=0)
"RTN","IBDFN3",59,0)
 S IBDFN=DFN N DFN S DFN=IBDFN
"RTN","IBDFN3",60,0)
 ;
"RTN","IBDFN3",61,0)
 ;set the start date to the date of the appt
"RTN","IBDFN3",62,0)
 S SDPARMS("START")=IBAPPT\1
"RTN","IBDFN3",63,0)
 ;keep the device open
"RTN","IBDFN3",64,0)
 S SDPARMS("DO NOT CLOSE")=1
"RTN","IBDFN3",65,0)
 ;set DIV to the division of IBCLINIC
"RTN","IBDFN3",66,0)
 S DIV=$P($G(^SC(IBCLINIC,0)),"^",15)
"RTN","IBDFN3",67,0)
 D EN1^SDROUT1
"RTN","IBDFN3",68,0)
 Q
"RTN","IBDFN8")
0^10^B485517
"RTN","IBDFN8",1,0)
IBDFN8 ;ALB/CJM - ENCOUNTER FORM - PCE GDI INPUT TRANSFORMS;AUG 10, 1995
"RTN","IBDFN8",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**25**;APR 24, 1997
"RTN","IBDFN8",3,0)
 ;
"RTN","IBDFN8",4,0)
INPUTCPT(X) ;changes X,a CPT code, into its ien
"RTN","IBDFN8",5,0)
 ;
"RTN","IBDFN8",6,0)
 S X=$$UPP(X)
"RTN","IBDFN8",7,0)
 S X=$S($G(X)'="":$O(^ICPT("B",X,0)),1:"")
"RTN","IBDFN8",8,0)
 K:'X X
"RTN","IBDFN8",9,0)
 Q
"RTN","IBDFN8",10,0)
 ;
"RTN","IBDFN8",11,0)
INPUTICD(ICD) ;changes X, an ICD9 code, into its ien
"RTN","IBDFN8",12,0)
 ;
"RTN","IBDFN8",13,0)
 S ICD=$$UPP(ICD)
"RTN","IBDFN8",14,0)
 S X=$O(^ICD9("BA",ICD_" ",0))
"RTN","IBDFN8",15,0)
 K:'X X
"RTN","IBDFN8",16,0)
 Q
"RTN","IBDFN8",17,0)
 ;
"RTN","IBDFN8",18,0)
UPP(X) ; -- convert lower case to upper case (especially when in codes above)
"RTN","IBDFN8",19,0)
 Q $TR(X,"zxcvbnmlkjhgfdsaqwertyuiop","ZXCVBNMLKJHGFDSAQWERTYUIOP")
"RTN","IBDFRPC1")
0^22^B18235050
"RTN","IBDFRPC1",1,0)
IBDFRPC1 ;ALB/AAS - Return list of selections ; 2-JAN-96
"RTN","IBDFRPC1",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**25**;APR 24, 1997
"RTN","IBDFRPC1",3,0)
 ;
"RTN","IBDFRPC1",4,0)
 ; -- used by AICS Data Entry Systems, IBDFDE2, IBDFDE3, IBDFDE4
"RTN","IBDFRPC1",5,0)
 ;
"RTN","IBDFRPC1",6,0)
OBJLST(RESULT,IBDF) ; -- Procedure
"RTN","IBDFRPC1",7,0)
 ; -- Broker call to return any specified selection list, handprint field or multiple choice field
"RTN","IBDFRPC1",8,0)
 ;    rpc  := IBD GET ONE INPUT OBJECT
"RTN","IBDFRPC1",9,0)
 ;
"RTN","IBDFRPC1",10,0)
 ; -- input   RESULT         := see output
"RTN","IBDFRPC1",11,0)
 ;            IBDF("PI")     := package interface name or pointer
"RTN","IBDFRPC1",12,0)
 ;            IBDF("TYPE")   := type of input object
"RTN","IBDFRPC1",13,0)
 ;            IBDF("IEN")    := internal entry number of object
"RTN","IBDFRPC1",14,0)
 ;            IBDF("DFN")    := pointer to patient (2) (required for patient active problems only)
"RTN","IBDFRPC1",15,0)
 ;            IBDF("CLINIC") := pointer to hospital location (44) (required for provider list only)
"RTN","IBDFRPC1",16,0)
 ;            IBDF("KILL")   := 1 to kill results array prior to setting (Default)  (optional)
"RTN","IBDFRPC1",17,0)
 ;
"RTN","IBDFRPC1",18,0)
 ; -- Output  RESULT (called by reference)
"RTN","IBDFRPC1",19,0)
 ;    new for version 3.0 RESULT may be a closed global, i.e. ^tmp($j)
"RTN","IBDFRPC1",20,0)
 ;      and the data will be returned in ^tmp($j,n)
"RTN","IBDFRPC1",21,0)
 ;    For Lists:
"RTN","IBDFRPC1",22,0)
 ;            RESULT(0)      := number of entries^type of input object (LIST)^qualifier;;selection rule[::qualifier;;selection rule)^no scannable bubbles(1 if not scannable)
"RTN","IBDFRPC1",23,0)
 ;            RESULTS(N) $P1 := Display text
"RTN","IBDFRPC1",24,0)
 ;                       $P2 := Display code
"RTN","IBDFRPC1",25,0)
 ;                       $P3 := input value (value to return)
"RTN","IBDFRPC1",26,0)
 ;                       $P4 := input transform 
"RTN","IBDFRPC1",27,0)
 ;                       $P5 := optional caption
"RTN","IBDFRPC1",28,0)
 ;                       $P6 := optional Term pointer
"RTN","IBDFRPC1",29,0)
 ;                       $P7 := Selectable
"RTN","IBDFRPC1",30,0)
 ;
"RTN","IBDFRPC1",31,0)
 ;    For Hand Print Fields
"RTN","IBDFRPC1",32,0)
 ;            RESULT(0) := 1^type of object (HP)^label^vitals type
"RTN","IBDFRPC1",33,0)
 ;            RESULT(1) := Text from form^print format in 359.1^MAX lenght^units^vitals Type^PCE DIM Units
"RTN","IBDFRPC1",34,0)
 ;
"RTN","IBDFRPC1",35,0)
 ;   For Multiple Choice fields
"RTN","IBDFRPC1",36,0)
 ;            RESULT(0) := count of choices^type (MC)^display text^selection rule
"RTN","IBDFRPC1",37,0)
 ;            RESULT(n) := display text^label^value to return^qualifier^^^selectable (1)
"RTN","IBDFRPC1",38,0)
 ;
"RTN","IBDFRPC1",39,0)
 N IBQUIT,LIST,CLINIC,CL1,PI,PKG,PKG1,DYN,ARRY,VALUE
"RTN","IBDFRPC1",40,0)
 S (IBQUIT,LIST)=0
"RTN","IBDFRPC1",41,0)
 ;
"RTN","IBDFRPC1",42,0)
 I $E($G(RESULT),1)="^" S ARRY=RESULT
"RTN","IBDFRPC1",43,0)
 E  S ARRY="RESULT"
"RTN","IBDFRPC1",44,0)
 I $G(IBDF("KILL"))="" S IBDF("KILL")=1
"RTN","IBDFRPC1",45,0)
 K:IBDF("KILL") @ARRY
"RTN","IBDFRPC1",46,0)
 ;
"RTN","IBDFRPC1",47,0)
 S @ARRY@(0)="No package Interface found, 1"
"RTN","IBDFRPC1",48,0)
 ; -- set pkg = ien of pkg interface from either b or e x-ref
"RTN","IBDFRPC1",49,0)
 S PKG=$G(IBDF("PI"))
"RTN","IBDFRPC1",50,0)
 I +PKG'=PKG,PKG'="" S PKG1=+$O(^IBE(357.6,"B",$E(PKG,1,30),0)) I 'PKG1 S PKG1=+$O(^IBE(357.6,"E",$E(PKG,1,40),0))
"RTN","IBDFRPC1",51,0)
 I $G(PKG1),'PKG S IBDF("PI")=PKG1
"RTN","IBDFRPC1",52,0)
 G:'$G(IBDF("PI")) OBJLSTQ
"RTN","IBDFRPC1",53,0)
 G:$G(^IBE(357.6,+IBDF("PI"),0))="" OBJLSTQ
"RTN","IBDFRPC1",54,0)
 ;
"RTN","IBDFRPC1",55,0)
 I $G(IBDF("TYPE"))="" D
"RTN","IBDFRPC1",56,0)
 .S ITYP=$P($G(^IBE(357.6,+IBDF("PI"),0)),"^")
"RTN","IBDFRPC1",57,0)
 .S IBDF("TYPE")=$S(ITYP=3:"LIST",ITYP=4:"MC",ITYP=5:"HP",1:"")
"RTN","IBDFRPC1",58,0)
 I $G(IBDF("TYPE"))="" S @ARRY@(0)="Object Type not determined" G OBJLSTQ
"RTN","IBDFRPC1",59,0)
 I "^LIST^MC^HP^"'[("^"_IBDF("TYPE")_"^") S @ARRY@(0)="Object type Unknown" G OBJLSTQ
"RTN","IBDFRPC1",60,0)
 ;
"RTN","IBDFRPC1",61,0)
 ;S FRM=$G(IBDF("FRM"))
"RTN","IBDFRPC1",62,0)
 ;I +FRM'=FRM,FRM'="" S FRM=+$O(^IBE(357,"B",FRM,0))
"RTN","IBDFRPC1",63,0)
 ;I 'FRM S FRM=$$DEFAULT^IBDFRPC S:FRM @ARRY@(0)="Using default form",IBDF("FRM")=FRM G:'FRM OBJLSTQ
"RTN","IBDFRPC1",64,0)
 ;
"RTN","IBDFRPC1",65,0)
 ; -- if type is selection list
"RTN","IBDFRPC1",66,0)
 I IBDF("TYPE")="LIST" D  G OBJLSTQ
"RTN","IBDFRPC1",67,0)
 .S DYN=$P(^IBE(357.6,IBDF("PI"),0),"^",14)
"RTN","IBDFRPC1",68,0)
 .I 'DYN D SEL^IBDFRPC2(.RESULT,.IBDF)
"RTN","IBDFRPC1",69,0)
 .I DYN D DYN^IBDFRPC2(.RESULT,.IBDF)
"RTN","IBDFRPC1",70,0)
 ;
"RTN","IBDFRPC1",71,0)
 ; -- if type is multiple choice
"RTN","IBDFRPC1",72,0)
 I IBDF("TYPE")="MC" D MC G OBJLSTQ
"RTN","IBDFRPC1",73,0)
 ;
"RTN","IBDFRPC1",74,0)
 ; -- If type is Hand Print
"RTN","IBDFRPC1",75,0)
 I IBDF("TYPE")="HP" D HP G OBJLSTQ
"RTN","IBDFRPC1",76,0)
 ;
"RTN","IBDFRPC1",77,0)
 S @ARRY@(0)="Processing did not occur"
"RTN","IBDFRPC1",78,0)
 ;
"RTN","IBDFRPC1",79,0)
OBJLSTQ Q
"RTN","IBDFRPC1",80,0)
 ;
"RTN","IBDFRPC1",81,0)
MC ; -- returns list from multiple choice fields
"RTN","IBDFRPC1",82,0)
 N X,DTEXT,SRULE,CHOICE,CH,CTEXT,CHLBL,CHID,CHQLF,CNT
"RTN","IBDFRPC1",83,0)
 S @ARRY@(0)="Multiple Choice Field not found"
"RTN","IBDFRPC1",84,0)
 G:'$G(IBDF("IEN")) MCQ
"RTN","IBDFRPC1",85,0)
 S X=$G(^IBE(357.93,IBDF("IEN"),0)) G:X="" MCQ
"RTN","IBDFRPC1",86,0)
 ;
"RTN","IBDFRPC1",87,0)
 S DTEXT=$P(X,"^",2),SRULE=$P(X,"^",9)
"RTN","IBDFRPC1",88,0)
 ;
"RTN","IBDFRPC1",89,0)
 S (CHOICE,CNT)=0
"RTN","IBDFRPC1",90,0)
 F  S CHOICE=$O(^IBE(357.93,IBDF("IEN"),1,CHOICE)) Q:'CHOICE  D
"RTN","IBDFRPC1",91,0)
 .S CH=$G(^IBE(357.93,IBDF("IEN"),1,CHOICE,0)) Q:CH=""
"RTN","IBDFRPC1",92,0)
 .S CTEXT=$P(CH,"^"),CHLBL=$P(CH,"^",5),CHID=$P(CH,"^",8)
"RTN","IBDFRPC1",93,0)
 .S CHQLF=$P(CH,"^",9),VALUE=$P($G(^IBD(357.98,+$G(CHQLF),0)),"^")
"RTN","IBDFRPC1",94,0)
 .S CNT=CNT+1
"RTN","IBDFRPC1",95,0)
 .S @ARRY@(CNT)=CTEXT_"^"_CHLBL_"^"_VALUE_"^"_CHQLF_"^^^1"
"RTN","IBDFRPC1",96,0)
 .Q
"RTN","IBDFRPC1",97,0)
 S @ARRY@(0)=CNT_"^MC^"_DTEXT_"^"_SRULE
"RTN","IBDFRPC1",98,0)
MCQ Q
"RTN","IBDFRPC1",99,0)
 ;
"RTN","IBDFRPC1",100,0)
HP ; -- returns information on hand print field
"RTN","IBDFRPC1",101,0)
 N X,HNODE,HTEXT,HTYPE,HLEN,HPIC,HMEAS,VTYPE,VUNIT
"RTN","IBDFRPC1",102,0)
 S @ARRY@(0)="Hand Print field not found"
"RTN","IBDFRPC1",103,0)
 G:'$G(IBDF("IEN")) HPQ
"RTN","IBDFRPC1",104,0)
 S HNODE=$G(^IBE(359.94,IBDF("IEN"),0))
"RTN","IBDFRPC1",105,0)
 G:$G(HNODE)="" HPQ
"RTN","IBDFRPC1",106,0)
 S HTEXT=$P(HNODE,"^",2)
"RTN","IBDFRPC1",107,0)
 S HTYPE=$G(^IBE(359.1,+$P(HNODE,"^",10),0))
"RTN","IBDFRPC1",108,0)
 S HLEN=$P(HTYPE,"^",2),HPIC=$$FRMT^IBDF2F(HTYPE,$G(IBAPPT)),HMEAS=$P(HTYPE,"^",11),VTYPE=$P(HTYPE,"^",12),VUNIT=$P(HTYPE,"^",13)
"RTN","IBDFRPC1",109,0)
 S @ARRY@(1)=HTEXT_"^"_HPIC_"^"_HLEN_"^"_HMEAS_"^"_VTYPE_"^"_VUNIT
"RTN","IBDFRPC1",110,0)
 S @ARRY@(0)="1^HP^"_HTEXT_"^0"
"RTN","IBDFRPC1",111,0)
 ;
"RTN","IBDFRPC1",112,0)
HPQ Q
"RTN","IBDFRPC1",113,0)
 ;
"RTN","IBDFRPC1",114,0)
3 ; -- return lists of providers/cpts/diagnosis from form
"RTN","IBDFRPC1",115,0)
 ;    format as in 2
"RTN","IBDFRPC1",116,0)
 Q
"RTN","IBDFRPC1",117,0)
 ;
"RTN","IBDFRPC1",118,0)
4 ; -- provide list of other input items/and parameters
"RTN","IBDFRPC1",119,0)
 Q
"RTN","IBDFRPC1",120,0)
 ;
"RTN","IBDFRPC1",121,0)
TESTD ; -- test dynamic list
"RTN","IBDFRPC1",122,0)
 S IBDF("PI")=61
"RTN","IBDFRPC1",123,0)
 S IBDF("IEN")=1729
"RTN","IBDFRPC1",124,0)
 S IBDF("TYPE")="LIST"
"RTN","IBDFRPC1",125,0)
 S IBDF("CLINIC")=300
"RTN","IBDFRPC1",126,0)
 S IBDF("DFN")=1
"RTN","IBDFRPC1",127,0)
 D OBJLST(.TEST,.IBDF)
"RTN","IBDFRPC1",128,0)
 X "ZW TEST"
"RTN","IBDFRPC1",129,0)
 Q
"RTN","IBDFRPC1",130,0)
 ;
"RTN","IBDFRPC1",131,0)
TESTL ; -- test list
"RTN","IBDFRPC1",132,0)
 K TEST
"RTN","IBDFRPC1",133,0)
 S IBDF("PI")=7
"RTN","IBDFRPC1",134,0)
 S IBDF("IEN")=488
"RTN","IBDFRPC1",135,0)
 S IBDF("TYPE")="LIST"
"RTN","IBDFRPC1",136,0)
 D OBJLST("^TMP($J,""TESTL"")",.IBDF)
"RTN","IBDFRPC1",137,0)
 X "ZW TEST"
"RTN","IBDFRPC1",138,0)
 Q
"RTN","IBDFRPC1",139,0)
 ;
"RTN","IBDFRPC1",140,0)
TESTM ; -- test Multiple choice
"RTN","IBDFRPC1",141,0)
 K TEST
"RTN","IBDFRPC1",142,0)
 S IBDF("PI")=7
"RTN","IBDFRPC1",143,0)
 S IBDF("TYPE")="MC"
"RTN","IBDFRPC1",144,0)
 S IBDF("IEN")=161
"RTN","IBDFRPC1",145,0)
 D OBJLST("^TMP($J,""TESTM"")",.IBDF)
"RTN","IBDFRPC1",146,0)
 X "ZW TEST"
"RTN","IBDFRPC1",147,0)
 Q
"RTN","IBDFRPC1",148,0)
TESTH ; -- test Hand Print
"RTN","IBDFRPC1",149,0)
 K TEST
"RTN","IBDFRPC1",150,0)
 S IBDF("PI")=95
"RTN","IBDFRPC1",151,0)
 S IBDF("TYPE")="HP"
"RTN","IBDFRPC1",152,0)
 S IBDF("IEN")=352
"RTN","IBDFRPC1",153,0)
 D OBJLST(.TEST,.IBDF)
"RTN","IBDFRPC1",154,0)
 X "ZW TEST"
"RTN","IBDFRPC1",155,0)
 Q
"RTN","IBDFRPC6")
0^5^B55319457
"RTN","IBDFRPC6",1,0)
IBDFRPC6 ;ALB/AAS - AICS Pass data to PCE, Broker Call ; 24-FEB-96
"RTN","IBDFRPC6",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3,25**;APR 24, 1997
"RTN","IBDFRPC6",3,0)
 ;
"RTN","IBDFRPC6",4,0)
FINDALL(RESULT) ; -- loop through all entries for data
"RTN","IBDFRPC6",5,0)
 ; -- called from ibdfrpc5, ONLY call if data in ^tmp
"RTN","IBDFRPC6",6,0)
 N IBDI
"RTN","IBDFRPC6",7,0)
 S RESULT(0)="The following data was found: "
"RTN","IBDFRPC6",8,0)
 F IBDI="VST","PRV","POV","CPT","HF","PED","XAM","SK","IMM","TRT" D @(IBDI)
"RTN","IBDFRPC6",9,0)
 K ^TMP("PXKENC",$J)
"RTN","IBDFRPC6",10,0)
 Q
"RTN","IBDFRPC6",11,0)
 ;
"RTN","IBDFRPC6",12,0)
PRV ; -- Expand Provider Entry
"RTN","IBDFRPC6",13,0)
 N IBDY,IBDJ,IEN,X,Y
"RTN","IBDFRPC6",14,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",15,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"PRV",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",16,0)
 ..D GETY(.Y,IBDY,"PRV",IEN)
"RTN","IBDFRPC6",17,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",18,0)
 ...S X=$S($P(Y,"^",4)="P":"Primary",1:"Secondary")_"^Provider^"_$P($G(^VA(200,+Y,0)),"^")
"RTN","IBDFRPC6",19,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.06)
"RTN","IBDFRPC6",20,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",21,0)
 ...S X=$S($P(Y,"^",4)="P":"   Primary",1:" Secondary")_" Provider:  "_$P($G(^VA(200,+Y,0)),"^")
"RTN","IBDFRPC6",22,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",23,0)
 Q
"RTN","IBDFRPC6",24,0)
 ;
"RTN","IBDFRPC6",25,0)
POV ; -- Expand POV entry, (9000010.07)
"RTN","IBDFRPC6",26,0)
 N IBDY,IBDJ,IEN,X,Y
"RTN","IBDFRPC6",27,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",28,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"POV",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",29,0)
 ..D GETY(.Y,IBDY,"POV",IEN)
"RTN","IBDFRPC6",30,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",31,0)
 ...S X=$S($P(Y,"^",12)="P":"  Primary",1:"Secondary")_" Diagnosis:  "
"RTN","IBDFRPC6",32,0)
 ...S X=X_$E($P($G(^ICD9(+Y,0)),"^")_"   ",1,6)_" - "
"RTN","IBDFRPC6",33,0)
 ...IF $P(Y,"^",4) S X=X_$$EXTERNAL^DILFD(9000010.07,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",34,0)
 ...ELSE  S X=X_$E($G(^ICD9(+Y,1)),1,80)
"RTN","IBDFRPC6",35,0)
 ..;
"RTN","IBDFRPC6",36,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",37,0)
 ...S X=$S($P(Y,"^",12)="P":"Primary",1:"Secondary")_"^Diagnosis^"
"RTN","IBDFRPC6",38,0)
 ...IF $P(Y,"^",4) S X=X_$$EXTERNAL^DILFD(9000010.07,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",39,0)
 ...ELSE  S X=X_$E($G(^ICD9(+Y,1)),1,80)
"RTN","IBDFRPC6",40,0)
 ...S X=X_"^"_$E($P($G(^ICD9(+Y,0)),"^")_"   ",1,6)
"RTN","IBDFRPC6",41,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.07)
"RTN","IBDFRPC6",42,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",43,0)
 Q
"RTN","IBDFRPC6",44,0)
 ;
"RTN","IBDFRPC6",45,0)
CPT ; -- Expand CPT entry
"RTN","IBDFRPC6",46,0)
 N IBDY,IBDJ,IEN,QUAN,X,Y
"RTN","IBDFRPC6",47,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",48,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"CPT",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",49,0)
 ..D GETY(.Y,IBDY,"CPT",IEN)
"RTN","IBDFRPC6",50,0)
 ..S QUAN=$P(Y,"^",16)
"RTN","IBDFRPC6",51,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",52,0)
 ...S X="          Procedure:  "_$P($G(^ICPT(+Y,0)),"^")_"  - "
"RTN","IBDFRPC6",53,0)
 ...IF $P(Y,"^",4) S X=X_$$EXTERNAL^DILFD(9000010.18,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",54,0)
 ...ELSE  S X=X_$P($G(^ICPT(+Y,0)),"^",2)
"RTN","IBDFRPC6",55,0)
 ...S X=X_"   Quantity: "_QUAN
"RTN","IBDFRPC6",56,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",57,0)
 ...S X="^Procedure^"
"RTN","IBDFRPC6",58,0)
 ...IF $P(Y,"^",4) S X=X_$$EXTERNAL^DILFD(9000010.18,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",59,0)
 ...ELSE  S X=X_$P($G(^ICPT(+Y,0)),"^",2)
"RTN","IBDFRPC6",60,0)
 ...S X=X_"^"_$P($G(^ICPT(+Y,0)),"^")_"^"_$$SOURCE(9000010.18)_"^"_QUAN
"RTN","IBDFRPC6",61,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",62,0)
 Q
"RTN","IBDFRPC6",63,0)
 ;
"RTN","IBDFRPC6",64,0)
HF ; -- Expand Health Factors
"RTN","IBDFRPC6",65,0)
 N IBDY,IBDJ,IEN,X,Y,Z
"RTN","IBDFRPC6",66,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",67,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"HF",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",68,0)
 ..D GETY(.Y,IBDY,"HF",IEN)
"RTN","IBDFRPC6",69,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",70,0)
 ...S X="      Health Factor:  "_$E($$EXTERNAL^DILFD(9000010.23,.01,"",+Y)_L,1,25)
"RTN","IBDFRPC6",71,0)
 ...I $P(Y,"^",4)'="" S X=X_" Severity="_$$EXTERNAL^DILFD(9000010.23,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",72,0)
 ..;
"RTN","IBDFRPC6",73,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",74,0)
 ...S X=""
"RTN","IBDFRPC6",75,0)
 ...I $P(Y,"^",4)'="" S X=$$EXTERNAL^DILFD(9000010.23,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",76,0)
 ...S X=X_"^Health Factor^"_$E($$EXTERNAL^DILFD(9000010.23,.01,"",+Y),1,25)
"RTN","IBDFRPC6",77,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.23)
"RTN","IBDFRPC6",78,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",79,0)
 Q
"RTN","IBDFRPC6",80,0)
 ;
"RTN","IBDFRPC6",81,0)
IMM ; -- Expand Immunizations
"RTN","IBDFRPC6",82,0)
 N IBDY,IBDJ,IEN,X,Y
"RTN","IBDFRPC6",83,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",84,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"IMM",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",85,0)
 ..D GETY(.Y,IBDY,"IMM",IEN)
"RTN","IBDFRPC6",86,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",87,0)
 ...S X="       Immunization:  "_$$EXTERNAL^DILFD(9000010.11,.01,"",+Y)
"RTN","IBDFRPC6",88,0)
 ...I $P(Y,"^",7) S X=X_"  Contraindicated!"
"RTN","IBDFRPC6",89,0)
 ..;
"RTN","IBDFRPC6",90,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",91,0)
 ...S X="" I $P(Y,"^",7) S X="Contraindicated"
"RTN","IBDFRPC6",92,0)
 ...S X=X_"^Immunization^"_$$EXTERNAL^DILFD(9000010.11,.01,"",+Y)
"RTN","IBDFRPC6",93,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.11)
"RTN","IBDFRPC6",94,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",95,0)
 Q
"RTN","IBDFRPC6",96,0)
 ;
"RTN","IBDFRPC6",97,0)
PED ; -- Expand Patient Education
"RTN","IBDFRPC6",98,0)
 N IBDY,IBDJ,IEN,X,Y
"RTN","IBDFRPC6",99,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",100,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"PED",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",101,0)
 ..D GETY(.Y,IBDY,"PED",IEN)
"RTN","IBDFRPC6",102,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",103,0)
 ...S X="    Education Topic:  "_$E($$EXTERNAL^DILFD(9000010.16,.01,"",+Y)_L,1,25)
"RTN","IBDFRPC6",104,0)
 ...I $P(Y,"^",6)'="" S X=X_" Understanding="_$$EXTERNAL^DILFD(9000010.16,.06,"",$P(Y,"^",6))
"RTN","IBDFRPC6",105,0)
 ..;
"RTN","IBDFRPC6",106,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",107,0)
 ...S X=""
"RTN","IBDFRPC6",108,0)
 ...I $P(Y,"^",6)'="" S X=$$EXTERNAL^DILFD(9000010.16,.06,"",$P(Y,"^",6))
"RTN","IBDFRPC6",109,0)
 ...S X=X_"^Education Topic^"_$E($$EXTERNAL^DILFD(9000010.16,.01,"",+Y),1,25)
"RTN","IBDFRPC6",110,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.16)
"RTN","IBDFRPC6",111,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",112,0)
 Q
"RTN","IBDFRPC6",113,0)
 ;
"RTN","IBDFRPC6",114,0)
SK ; -- Expand Skin Tests
"RTN","IBDFRPC6",115,0)
 N IBDY,IBDJ,IEN,X,Y,Z
"RTN","IBDFRPC6",116,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",117,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"SK",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",118,0)
 ..D GETY(.Y,IBDY,"SK",IEN)
"RTN","IBDFRPC6",119,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",120,0)
 ...S X="          Skin Test:  "_$E($$EXTERNAL^DILFD(9000010.12,.01,"",+Y)_L,1,25)
"RTN","IBDFRPC6",121,0)
 ...I $P(Y,"^",4)'="" S X=X_" Result="_$$EXTERNAL^DILFD(9000010.12,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",122,0)
 ..;
"RTN","IBDFRPC6",123,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",124,0)
 ...S X=$$EXTERNAL^DILFD(9000010.12,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",125,0)
 ...S X=X_"^Skin Test^"_$E($$EXTERNAL^DILFD(9000010.12,.01,"",+Y),1,25)
"RTN","IBDFRPC6",126,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.12)
"RTN","IBDFRPC6",127,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",128,0)
 Q
"RTN","IBDFRPC6",129,0)
 ;
"RTN","IBDFRPC6",130,0)
TRT ; -- Expand Treatments
"RTN","IBDFRPC6",131,0)
 N IBDY,IBDJ,IEN,X,Y,TRT
"RTN","IBDFRPC6",132,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",133,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"TRT",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",134,0)
 ..D GETY(.Y,IBDY,"TRT",IEN)
"RTN","IBDFRPC6",135,0)
 ..S TRT=$$EXTERNAL^DILFD(9000010.15,.01,"",+Y)
"RTN","IBDFRPC6",136,0)
 ..I TRT="OTHER" S TRT=$$EXTERNAL^DILFD(9000010.15,.06,"",$P(Y,"^",6))
"RTN","IBDFRPC6",137,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",138,0)
 ...S X="          Treatment:  "_TRT
"RTN","IBDFRPC6",139,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",140,0)
 ...S X="^Treatment^"_TRT
"RTN","IBDFRPC6",141,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.15)
"RTN","IBDFRPC6",142,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",143,0)
 Q
"RTN","IBDFRPC6",144,0)
 ;
"RTN","IBDFRPC6",145,0)
XAM ; -- Expand Exams
"RTN","IBDFRPC6",146,0)
 N IBDY,IBDJ,IEN,X,Y
"RTN","IBDFRPC6",147,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",148,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"XAM",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",149,0)
 ..D GETY(.Y,IBDY,"XAM",IEN)
"RTN","IBDFRPC6",150,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",151,0)
 ...S X="               Exam:  "_$E($$EXTERNAL^DILFD(9000010.13,.01,"",+Y)_L,1,25)
"RTN","IBDFRPC6",152,0)
 ...S X=X_" Result="_$$EXTERNAL^DILFD(9000010.13,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",153,0)
 ..;
"RTN","IBDFRPC6",154,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",155,0)
 ...S X=$$EXTERNAL^DILFD(9000010.13,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",156,0)
 ...S X=X_"^Exam^"_$E($$EXTERNAL^DILFD(9000010.13,.01,"",+Y),1,25)
"RTN","IBDFRPC6",157,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.13)
"RTN","IBDFRPC6",158,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",159,0)
 Q
"RTN","IBDFRPC6",160,0)
 ;
"RTN","IBDFRPC6",161,0)
VST ; -- Expand visit entry
"RTN","IBDFRPC6",162,0)
 N IBDY,IBDJ,IBDZ,IEN,X,Y
"RTN","IBDFRPC6",163,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",164,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"VST",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",165,0)
 ..D GETY(.Y,IBDY,"VST",IEN)
"RTN","IBDFRPC6",166,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",167,0)
 ...S X="     Encounter Info:  "_$$EXTERNAL^DILFD(9000010,.22,"",$P(Y,"^",22))_" - "_$$FMTE^XLFDT(+Y)_" - "_$$EXTERNAL^DILFD(9000010,15003,"",$P(Y(150),"^",3))_" Encounter"
"RTN","IBDFRPC6",168,0)
 ...D INC(X,.CNT)
"RTN","IBDFRPC6",169,0)
 ...S X=""
"RTN","IBDFRPC6",170,0)
 ...S X=$$SOURCE(9000010) I X'="" S X=$E(L,1,22)_"Source - "_X
"RTN","IBDFRPC6",171,0)
 ...I $P(Y(800),"^",1)'="" S X=X_", SC := "_$S($P(Y(800),"^",1):"Yes",1:"No")
"RTN","IBDFRPC6",172,0)
 ...I $P(Y(800),"^",2)'="" S X=X_", AO:="_$S($P(Y(800),"^",2):"Yes",1:"No")
"RTN","IBDFRPC6",173,0)
 ...I $P(Y(800),"^",3)'="" S X=X_", IR:="_$S($P(Y(800),"^",3):"Yes",1:"No")
"RTN","IBDFRPC6",174,0)
 ...I $P(Y(800),"^",4)'="" S X=X_", EC:="_$S($P(Y(800),"^",4):"Yes",1:"No")
"RTN","IBDFRPC6",175,0)
 ..;
"RTN","IBDFRPC6",176,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",177,0)
 ...S X=$$EXTERNAL^DILFD(9000010,15003,"",$P(Y(150),"^",3))_"^Encounter^"
"RTN","IBDFRPC6",178,0)
 ...S X=X_$$EXTERNAL^DILFD(9000010,.22,"",$P(Y,"^",22))_"^"_$$FMTE^XLFDT(+Y)_"^"
"RTN","IBDFRPC6",179,0)
 ...S X=X_$$SOURCE(9000010)
"RTN","IBDFRPC6",180,0)
 ...F IBDZ=1:1:4 I $P(Y(800),"^",IBDZ)'="" S $P(X,"^",(6+IBDZ))=$P(Y(800),"^",IBDZ)
"RTN","IBDFRPC6",181,0)
 ..I X'="" D INC(X,.CNT)
"RTN","IBDFRPC6",182,0)
 Q
"RTN","IBDFRPC6",183,0)
 ;
"RTN","IBDFRPC6",184,0)
INC(X,CNT) ; -- increment results array
"RTN","IBDFRPC6",185,0)
 S CNT=CNT+1
"RTN","IBDFRPC6",186,0)
 S RESULT(CNT)=X
"RTN","IBDFRPC6",187,0)
 Q
"RTN","IBDFRPC6",188,0)
 ;
"RTN","IBDFRPC6",189,0)
GETY(Y,IBDY,TYPE,IEN) ; -- return y array
"RTN","IBDFRPC6",190,0)
 S Y=$G(^TMP("PXKENC",$J,IBDY,TYPE,IEN,0))
"RTN","IBDFRPC6",191,0)
 S Y(150)=$G(^TMP("PXKENC",$J,IBDY,TYPE,IEN,150))
"RTN","IBDFRPC6",192,0)
 S Y(812)=$G(^TMP("PXKENC",$J,IBDY,TYPE,IEN,812))
"RTN","IBDFRPC6",193,0)
 I TYPE="VST" S Y(800)=$G(^TMP("PXKENC",$J,IBDY,TYPE,IEN,800))
"RTN","IBDFRPC6",194,0)
 Q
"RTN","IBDFRPC6",195,0)
 ;
"RTN","IBDFRPC6",196,0)
SOURCE(FILE) ; -- return source of data
"RTN","IBDFRPC6",197,0)
 N X S X=""
"RTN","IBDFRPC6",198,0)
 I $P(Y(812),"^",3)'="" S X=$$EXTERNAL^DILFD(FILE,81203,"",$P(Y(812),"^",3))
"RTN","IBDFRPC6",199,0)
 I X="",$P(Y(812),"^",2)'="" S X=$$EXTERNAL^DILFD(FILE,81202,"",$P(Y(812),"^",2))
"RTN","IBDFRPC6",200,0)
 Q X
"RTN","IBDFRPC6",201,0)
 ;
"RTN","IBDFRPC6",202,0)
TEST G TEST^IBDFRPC5
"RTN","IBDFRPC6",203,0)
TESTW G TESTW^IBDFRPC5
"RTN","IBDY325")
0^^B10903109
"RTN","IBDY325",1,0)
IBDY325 ;ALB/AAS - POST INSTALL FOR PATCH IBD*3*25 ; 23-JUN-97
"RTN","IBDY325",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**25**;APR 24, 1997
"RTN","IBDY325",3,0)
 ;
"RTN","IBDY325",4,0)
 D SET,Y2K,DEL
"RTN","IBDY325",5,0)
 D UNCOMP,RECOMP
"RTN","IBDY325",6,0)
 Q
"RTN","IBDY325",7,0)
 ;
"RTN","IBDY325",8,0)
 ;
"RTN","IBDY325",9,0)
SET ; -- set default values in new encounter form parameters
"RTN","IBDY325",10,0)
 N X
"RTN","IBDY325",11,0)
 S X=$P($G(^IBD(357.09,1,0)),"^",12,14)
"RTN","IBDY325",12,0)
 I X=""!(X="^^") D  ;only update once
"RTN","IBDY325",13,0)
 .D MES^XPDUTL(">>> Now setting the default value in new Encounter Form Parameters.")
"RTN","IBDY325",14,0)
 .S $P(^IBD(357.09,1,0),"^",12)=5
"RTN","IBDY325",15,0)
 .S $P(^IBD(357.09,1,0),"^",13)=12
"RTN","IBDY325",16,0)
 .S $P(^IBD(357.09,1,0),"^",14)=25
"RTN","IBDY325",17,0)
 Q
"RTN","IBDY325",18,0)
 ;
"RTN","IBDY325",19,0)
Y2K ; -- update the Checkout date/time AICS DATA ELEMENT entry for Y2K
"RTN","IBDY325",20,0)
 N IEN
"RTN","IBDY325",21,0)
 S IEN=$O(^IBE(359.1,"B","CHECKOUT DATE@TIME",0)) Q:'IEN
"RTN","IBDY325",22,0)
 S $P(^IBE(359.1,IEN,0),"^",5)="______@____"
"RTN","IBDY325",23,0)
 S $P(^IBE(359.1,IEN,10),"^",2)="NNNNNNPNNNN"
"RTN","IBDY325",24,0)
 S $P(^IBE(359.1,IEN,10),"^",4)="NNNNNNPNNNN"
"RTN","IBDY325",25,0)
 Q
"RTN","IBDY325",26,0)
 ;
"RTN","IBDY325",27,0)
UNCOMP ; -- uncompile all forms --
"RTN","IBDY325",28,0)
 N ZTQUEUED
"RTN","IBDY325",29,0)
 D MES^XPDUTL(">>> Now uncompiling all Encounter Forms.")
"RTN","IBDY325",30,0)
 S ZTQUEUED=1
"RTN","IBDY325",31,0)
 D RECMPALL^IBDF19
"RTN","IBDY325",32,0)
 D MES^XPDUTL("    Okay, forms will be recompiled as they are printed.")
"RTN","IBDY325",33,0)
 Q
"RTN","IBDY325",34,0)
 ;
"RTN","IBDY325",35,0)
RECOMP ; Recompile all forms in file 359.2
"RTN","IBDY325",36,0)
 N C,X,COUNT,CNT,COLWIDTH,IBDFSA,IBFORMID,IBBDT,IBEDT,IBDAY,LBEGIN,LEND,NODE10,POP,PRIORPG,QUIT
"RTN","IBDY325",37,0)
 ;
"RTN","IBDY325",38,0)
 S IBBDT=$H
"RTN","IBDY325",39,0)
 S COUNT=$P(^IBD(359.2,0),"^",4)
"RTN","IBDY325",40,0)
 ;
"RTN","IBDY325",41,0)
 D MES^XPDUTL(">>> I am going to recompile all "_COUNT_" entries in your FORM SPECS file (359.2)")
"RTN","IBDY325",42,0)
 D MES^XPDUTL(">>> Recompilation Started at "_$$HTE^XLFDT(IBBDT))
"RTN","IBDY325",43,0)
 D MES^XPDUTL(">>> This may take awhile... (about 5 seconds per entry on an unloaded system)")
"RTN","IBDY325",44,0)
 ;
"RTN","IBDY325",45,0)
 S CNT=0
"RTN","IBDY325",46,0)
 S IBFORMID=0 F  S IBFORMID=$O(^IBD(359.2,IBFORMID)) Q:'IBFORMID  D
"RTN","IBDY325",47,0)
 .D SCAN^IBDFBKS(IBFORMID)
"RTN","IBDY325",48,0)
 .S CNT=CNT+1
"RTN","IBDY325",49,0)
 .I '$D(ZTQUEUED),'(CNT#10) D MES^XPDUTL("    "_CNT_" done, "_(COUNT-CNT)_" to go.")
"RTN","IBDY325",50,0)
 ;
"RTN","IBDY325",51,0)
 S IBEDT=$H
"RTN","IBDY325",52,0)
 D MES^XPDUTL("")
"RTN","IBDY325",53,0)
 D MES^XPDUTL(">>> Recompilation Complete at "_$$HTE^XLFDT(IBEDT))
"RTN","IBDY325",54,0)
 I $D(IBBDT) D
"RTN","IBDY325",55,0)
 .S IBDAY=+IBEDT-(+IBBDT)*86400 ;additional seconds of over midnight
"RTN","IBDY325",56,0)
 .S X=IBDAY+$P(IBEDT,",",2)-$P(IBBDT,",",2)
"RTN","IBDY325",57,0)
 .D MES^XPDUTL(">>> Elapse time for recompilation was: "_(X\3600)_" Hours,  "_(X\60-(X\3600*60))_" Minutes,  "_(X#60)_" Seconds")
"RTN","IBDY325",58,0)
 .S X=(X/COUNT)
"RTN","IBDY325",59,0)
 .D MES^XPDUTL(">>> Average Time per Entry was: "_(X\60-(X\3600*60))_" Minutes,  "_(X#60)_" Seconds")
"RTN","IBDY325",60,0)
 Q
"RTN","IBDY325",61,0)
 ;
"RTN","IBDY325",62,0)
DEL ; -- delete unused field
"RTN","IBDY325",63,0)
 N DIK,DA,CNT
"RTN","IBDY325",64,0)
 S DIK="^DD(357.613,",DA(1)=357.613
"RTN","IBDY325",65,0)
 I $D(^DD(357.613,.02)) D
"RTN","IBDY325",66,0)
 . S DA=.02,CNT=$G(CNT)+1
"RTN","IBDY325",67,0)
 . D ^DIK
"RTN","IBDY325",68,0)
 I $D(^DD(357.613,.06)) D
"RTN","IBDY325",69,0)
 . S CNT=$G(CNT)+1
"RTN","IBDY325",70,0)
 . S DA=.06
"RTN","IBDY325",71,0)
 . D ^DIK
"RTN","IBDY325",72,0)
 ;
"RTN","IBDY325",73,0)
 K DIK,DA
"RTN","IBDY325",74,0)
 D:$G(CNT) MES^XPDUTL(">>> Deleted "_$G(CNT)_" unused field"_$S($G(CNT)=1:"",1:"s")_" in the Package Interface File")
"RTN","IBDY325",75,0)
 Q
"VER")
8.0^21.0
"^DD",357.09,357.09,.12,0)
REDUCE HANDPRINT RECOGNITION SIZE^NJ1,0^^0;12^K:+X'=X!(X>8)!(X<0)!(X?.E1"."1N.N) X
"^DD",357.09,357.09,.12,3)
Entering a number greater than zero will reduce the recognition area of hand print fields by .1mm on all sides.  Type a Number between 0 and 8.
"^DD",357.09,357.09,.12,9)
^
"^DD",357.09,357.09,.12,21,0)
^^20^20^2990326^^^^
"^DD",357.09,357.09,.12,21,1,0)
When scanning, some sites have problems with the outline of hand print
"^DD",357.09,357.09,.12,21,2,0)
fields not being removed completely.  This results in "phantom" entries
"^DD",357.09,357.09,.12,21,3,0)
being detected by Paper Keyboard and user validation during recognition.
"^DD",357.09,357.09,.12,21,4,0)

"^DD",357.09,357.09,.12,21,5,0)
This problem is caused by the interaction of 3 different features, the
"^DD",357.09,357.09,.12,21,6,0)
darkness of the print, the size of the recognition area, and the light
"^DD",357.09,357.09,.12,21,7,0)
intensity of the scanner.  This field allows you to reduce the size of
"^DD",357.09,357.09,.12,21,8,0)
the recognition area which may assist in moving the "phantom" outside of
"^DD",357.09,357.09,.12,21,9,0)
the recognition area.  This information is then computed and stored in
"^DD",357.09,357.09,.12,21,10,0)
the FormSpec file on the VistA server and the workstation.
"^DD",357.09,357.09,.12,21,11,0)

"^DD",357.09,357.09,.12,21,12,0)
To leave the recognition area the same size as before AICS v3.0 patch 
"^DD",357.09,357.09,.12,21,13,0)
IBD*3*25 enter a zero.  The default value of the field if there is
"^DD",357.09,357.09,.12,21,14,0)
no entry is 5.  The maximum value of the field is 8.  Reducing the size
"^DD",357.09,357.09,.12,21,15,0)
will move all 4 sides of the box in by .1mm times the number entered.
"^DD",357.09,357.09,.12,21,16,0)

"^DD",357.09,357.09,.12,21,17,0)
If you are having the "phantom" problem, you should also check the 
"^DD",357.09,357.09,.12,21,18,0)
value in fields DARKNESS OF DOTS and CLOSENESS OF DOTS in this file.
"^DD",357.09,357.09,.12,21,19,0)
These fields allow for printing the hand print field outlines at a
"^DD",357.09,357.09,.12,21,20,0)
lighter value.
"^DD",357.09,357.09,.12,23,0)
^^3^3^2990326^^^^
"^DD",357.09,357.09,.12,23,1,0)
The value of this field is used in routine IBDFBKS2 to reduce the xy 
"^DD",357.09,357.09,.12,23,2,0)
coordinates that are computed as the recognition area in the Paper Keyboard
"^DD",357.09,357.09,.12,23,3,0)
form spec file. 
"^DD",357.09,357.09,.12,"DT")
2981120
"^DD",357.09,357.09,.13,0)
DARKNESS OF DOTS^NJ2,0^^0;13^K:+X'=X!(X>15)!(X<9)!(X?.E1"."1N.N) X
"^DD",357.09,357.09,.13,3)
Entering a number of less than 12 will reduce the size of dots that print on Encounter Forms.  Type a Number between 9 and 15, 0 Decimal Digits
"^DD",357.09,357.09,.13,21,0)
^^23^23^2990319^^^^
"^DD",357.09,357.09,.13,21,1,0)
When scanning, some sites have problems with the outline of hand print
"^DD",357.09,357.09,.13,21,2,0)
fields not being removed completely.  This results in "phantom" entries
"^DD",357.09,357.09,.13,21,3,0)
being detected by Paper Keyboard and user validation during recognition.
"^DD",357.09,357.09,.13,21,4,0)

"^DD",357.09,357.09,.13,21,5,0)
This problem is caused by the interaction of 3 different features, the   
"^DD",357.09,357.09,.13,21,6,0)
darkness of the print, the size of the recognition area, and the light
"^DD",357.09,357.09,.13,21,7,0)
intensity of the scanner.  This field allows sites to determine the Pen 
"^DD",357.09,357.09,.13,21,8,0)
Width value of the dots of handprint fields and bubbles when printing on
"^DD",357.09,357.09,.13,21,9,0)
laser printers.  Reducing the pen width below 12 will make the dots
"^DD",357.09,357.09,.13,21,10,0)
smaller thus making it more likely for the dots to disappear during the 
"^DD",357.09,357.09,.13,21,11,0)
scanning process.
"^DD",357.09,357.09,.13,21,12,0)

"^DD",357.09,357.09,.13,21,13,0)
To leave the dot size the same as before AICS v3.0 patch IBD*3*25 
"^DD",357.09,357.09,.13,21,14,0)
enter a 12.  The default value of the field if there is no entry 
"^DD",357.09,357.09,.13,21,15,0)
is 12.  The minimum value of this field is 9, the maximum value is 15.
"^DD",357.09,357.09,.13,21,16,0)
Changing this value immediately affects the printing of encounter forms.
"^DD",357.09,357.09,.13,21,17,0)
Test changes by changing the value one number at a time and then viewing
"^DD",357.09,357.09,.13,21,18,0)
the form.
"^DD",357.09,357.09,.13,21,19,0)

"^DD",357.09,357.09,.13,21,20,0)
If you are having the "phantom" problem, you should also check the values
"^DD",357.09,357.09,.13,21,21,0)
in fields CLOSENESS OF DOTS and REDUCE HANDPRINT RECOGNITION SIZE in this
"^DD",357.09,357.09,.13,21,22,0)
file.  These fields allow for printing the hand print field outlines at 
"^DD",357.09,357.09,.13,21,23,0)
a lighter value and reduce the size of the area used for recognition.
"^DD",357.09,357.09,.13,"DT")
2980812
"^DD",357.09,357.09,.14,0)
CLOSENESS OF DOTS^NJ2,0^^0;14^K:+X'=X!(X>30)!(X<20)!(X?.E1"."1N.N) X
"^DD",357.09,357.09,.14,3)
 Type a Number between 20 and 30, 0 Decimal Digits.  The default value is 25.  A number lower than 25 will reduce "Phantom" data found during scanning.
"^DD",357.09,357.09,.14,21,0)
^^22^22^2990326^^^^
"^DD",357.09,357.09,.14,21,1,0)
When scanning, some sites have problems with the outline of hand print
"^DD",357.09,357.09,.14,21,2,0)
fields not being removed completely.  This results in "phantom" entries
"^DD",357.09,357.09,.14,21,3,0)
being detected by Paper Keyboard and user validation during recognition.
"^DD",357.09,357.09,.14,21,4,0)

"^DD",357.09,357.09,.14,21,5,0)
This problem is caused by the interaction of 3 different features, the   
"^DD",357.09,357.09,.14,21,6,0)
darkness of the print, the size of the recognition area, and the light
"^DD",357.09,357.09,.14,21,7,0)
intensity of the scanner.  This field allows sites to determine the 
"^DD",357.09,357.09,.14,21,8,0)
percentage of fill (closeness of dots) that is used to print handprint 
"^DD",357.09,357.09,.14,21,9,0)
field outlines and bubbles when using a laser printer.
"^DD",357.09,357.09,.14,21,10,0)

"^DD",357.09,357.09,.14,21,11,0)
To leave the closeness of dots the same as before AICS v3.0 patch 
"^DD",357.09,357.09,.14,21,12,0)
IBD*3*25 enter a 25.  The default value of the field if there is no entry 
"^DD",357.09,357.09,.14,21,13,0)
is 25.  The minimum value of this field is 20, the maximum value is 30.
"^DD",357.09,357.09,.14,21,14,0)
Changing this value immediately affects the printing of encounter forms.
"^DD",357.09,357.09,.14,21,15,0)
Reducing the closeness of dots below 25 will allow Paper Keyboard to more
"^DD",357.09,357.09,.14,21,16,0)
easily remove the dots.  Test changes by changing the value one number at
"^DD",357.09,357.09,.14,21,17,0)
a time and then viewing the form.
"^DD",357.09,357.09,.14,21,18,0)

"^DD",357.09,357.09,.14,21,19,0)
If you are having the "phantom" problem, you should also check the values
"^DD",357.09,357.09,.14,21,20,0)
in fields DARKNESS OF DOTS and REDUCE HANDPRINT RECOGNITION SIZE in this
"^DD",357.09,357.09,.14,21,21,0)
file.  These fields allow for printing of the hand print field outlines 
"^DD",357.09,357.09,.14,21,22,0)
at a lighter value and improve recognition during scanning.
"^DD",357.09,357.09,.14,"DT")
2980812
"^DD",359.3,359.3,.17,0)
PAGE^NJ2,0^^0;17^K:+X'=X!(X>10)!(X<1)!(X?.E1"."1N.N) X
"^DD",359.3,359.3,.17,3)
Type a Number between 1 and 10, 0 Decimal Digits
"^DD",359.3,359.3,.17,21,0)
^^1^1^2990315^^^^
"^DD",359.3,359.3,.17,21,1,0)
This is the page of the form being scanned when the error occured.
"^DD",359.3,359.3,.17,"DT")
2971124
"^DD",359.3,359.3,.18,0)
WORKSTATION ID^F^^0;18^K:$L(X)>1!($L(X)<1)!'(X?1U) X
"^DD",359.3,359.3,.18,3)
This is the AICS Workstation ID as set in the AICS workstation preferences.  Answer must be 1 Uppercase character in length.
"^DD",359.3,359.3,.18,21,0)
^^3^3^2990318^^^
"^DD",359.3,359.3,.18,21,1,0)
This is the ID from the AICS workstation.  This is used to identify which
"^DD",359.3,359.3,.18,21,2,0)
workstation the error occured on.
"^DD",359.3,359.3,.18,21,3,0)

"^DD",359.3,359.3,.18,"DT")
2971124
"^DD",359.3,359.3,9,0)
CLINIC^CJ30^^ ; ^X ^DD(359.3,9,9.2) S Y(359.3,9,101)=$S($D(^IBD(357.96,D0,0)):^(0),1:"") S X=$S('$D(^SC(+$P(Y(359.3,9,101),U,10),0)):"",1:$P(^(0),U,1)) S D0=Y(359.3,9,80)
"^DD",359.3,359.3,9,9)
^
"^DD",359.3,359.3,9,9.01)
357.96^.1;359.3^.05
"^DD",359.3,359.3,9,9.1)
#.05:357.96:#.1
"^DD",359.3,359.3,9,9.2)
S Y(359.3,9,80)=$S($D(D0):D0,1:""),Y(359.3,9,1)=$S($D(^IBD(359.3,D0,0)):^(0),1:"") S X=$P(Y(359.3,9,1),U,5) K DIC S DIC="^IBD(357.96,",DIC(0)="NMF" D ^DIC S (D,D0)=+Y
"^DD",359.3,359.3,9,21,0)
^^2^2^2990315^^
"^DD",359.3,359.3,9,21,1,0)
This field is a computed field that can be used on outputs via VA FileManager
"^DD",359.3,359.3,9,21,2,0)
for use by VA Medical Centers.
"^DD",359.3,359.3,9,"DT")
2970724
**END**
**END**
