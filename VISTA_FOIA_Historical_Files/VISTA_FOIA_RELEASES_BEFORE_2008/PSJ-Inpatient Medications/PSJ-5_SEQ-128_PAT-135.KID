Released PSJ*5*135 SEQ #128
Extracted from mail message
**KIDS**:PSJ*5.0*135^

**INSTALL NAME**
PSJ*5.0*135
"BLD",5756,0)
PSJ*5.0*135^INPATIENT MEDICATIONS^0^3050331^y
"BLD",5756,1,0)
^^13^13^3050331^
"BLD",5756,1,1,0)
The "undefined variable DIFLD(1)" error is being caused by the
"BLD",5756,1,2,0)
recursive use of the ^DIE call in a FileMan cross reference.
"BLD",5756,1,3,0)
The "DATE OF DEATH" field of the "PATIENT" file triggers many
"BLD",5756,1,4,0)
cross reference procedures and routines.
"BLD",5756,1,5,0)
    
"BLD",5756,1,6,0)
The purpose of this patch is to make changes to the Inpatient
"BLD",5756,1,7,0)
Medications routines associated with the "DATE OF DEATH" APSJD
"BLD",5756,1,8,0)
cross reference.  There are six tag/program locations that
"BLD",5756,1,9,0)
use the ^DIE call when this cross reference is triggered.
"BLD",5756,1,10,0)
    
"BLD",5756,1,11,0)
This patch changes the routines so that they use the
"BLD",5756,1,12,0)
DBS FILE^DIE function that is designed to be used recursively
"BLD",5756,1,13,0)
and within FileMan cross references.
"BLD",5756,4,0)
^9.64PA^^
"BLD",5756,"KRN",0)
^9.67PA^8989.52^19
"BLD",5756,"KRN",.4,0)
.4
"BLD",5756,"KRN",.401,0)
.401
"BLD",5756,"KRN",.402,0)
.402
"BLD",5756,"KRN",.403,0)
.403
"BLD",5756,"KRN",.5,0)
.5
"BLD",5756,"KRN",.84,0)
.84
"BLD",5756,"KRN",3.6,0)
3.6
"BLD",5756,"KRN",3.8,0)
3.8
"BLD",5756,"KRN",9.2,0)
9.2
"BLD",5756,"KRN",9.8,0)
9.8
"BLD",5756,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",5756,"KRN",9.8,"NM",1,0)
PSIVORAL^^0^B14231518
"BLD",5756,"KRN",9.8,"NM",2,0)
PSIVOPT2^^0^B33907148
"BLD",5756,"KRN",9.8,"NM",3,0)
PSJADT0^^0^B32509433
"BLD",5756,"KRN",9.8,"NM","B","PSIVOPT2",2)

"BLD",5756,"KRN",9.8,"NM","B","PSIVORAL",1)

"BLD",5756,"KRN",9.8,"NM","B","PSJADT0",3)

"BLD",5756,"KRN",19,0)
19
"BLD",5756,"KRN",19.1,0)
19.1
"BLD",5756,"KRN",101,0)
101
"BLD",5756,"KRN",409.61,0)
409.61
"BLD",5756,"KRN",771,0)
771
"BLD",5756,"KRN",870,0)
870
"BLD",5756,"KRN",8989.51,0)
8989.51
"BLD",5756,"KRN",8989.52,0)
8989.52
"BLD",5756,"KRN",8994,0)
8994
"BLD",5756,"KRN","B",.4,.4)

"BLD",5756,"KRN","B",.401,.401)

"BLD",5756,"KRN","B",.402,.402)

"BLD",5756,"KRN","B",.403,.403)

"BLD",5756,"KRN","B",.5,.5)

"BLD",5756,"KRN","B",.84,.84)

"BLD",5756,"KRN","B",3.6,3.6)

"BLD",5756,"KRN","B",3.8,3.8)

"BLD",5756,"KRN","B",9.2,9.2)

"BLD",5756,"KRN","B",9.8,9.8)

"BLD",5756,"KRN","B",19,19)

"BLD",5756,"KRN","B",19.1,19.1)

"BLD",5756,"KRN","B",101,101)

"BLD",5756,"KRN","B",409.61,409.61)

"BLD",5756,"KRN","B",771,771)

"BLD",5756,"KRN","B",870,870)

"BLD",5756,"KRN","B",8989.51,8989.51)

"BLD",5756,"KRN","B",8989.52,8989.52)

"BLD",5756,"KRN","B",8994,8994)

"BLD",5756,"QUES",0)
^9.62^^
"BLD",5756,"REQB",0)
^9.611^2^2
"BLD",5756,"REQB",1,0)
PSJ*5.0*133^1
"BLD",5756,"REQB",2,0)
PSJ*5.0*112^1
"BLD",5756,"REQB","B","PSJ*5.0*112",2)

"BLD",5756,"REQB","B","PSJ*5.0*133",1)

"MBREQ")
0
"PKG",221,-1)
1^1
"PKG",221,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",221,20,0)
^9.402P^^
"PKG",221,22,0)
^9.49I^1^1
"PKG",221,22,1,0)
5.0^2971215^2981113^1
"PKG",221,22,1,"PAH",1,0)
135^3050331
"PKG",221,22,1,"PAH",1,1,0)
^^13^13^3050331
"PKG",221,22,1,"PAH",1,1,1,0)
The "undefined variable DIFLD(1)" error is being caused by the
"PKG",221,22,1,"PAH",1,1,2,0)
recursive use of the ^DIE call in a FileMan cross reference.
"PKG",221,22,1,"PAH",1,1,3,0)
The "DATE OF DEATH" field of the "PATIENT" file triggers many
"PKG",221,22,1,"PAH",1,1,4,0)
cross reference procedures and routines.
"PKG",221,22,1,"PAH",1,1,5,0)
    
"PKG",221,22,1,"PAH",1,1,6,0)
The purpose of this patch is to make changes to the Inpatient
"PKG",221,22,1,"PAH",1,1,7,0)
Medications routines associated with the "DATE OF DEATH" APSJD
"PKG",221,22,1,"PAH",1,1,8,0)
cross reference.  There are six tag/program locations that
"PKG",221,22,1,"PAH",1,1,9,0)
use the ^DIE call when this cross reference is triggered.
"PKG",221,22,1,"PAH",1,1,10,0)
    
"PKG",221,22,1,"PAH",1,1,11,0)
This patch changes the routines so that they use the
"PKG",221,22,1,"PAH",1,1,12,0)
DBS FILE^DIE function that is designed to be used recursively
"PKG",221,22,1,"PAH",1,1,13,0)
and within FileMan cross references.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSIVOPT2")
0^2^B33907148
"RTN","PSIVOPT2",1,0)
PSIVOPT2 ;BIR/PR,MLM-OPTION DRIVER (CONT) ;02 Mar 99 / 9:27 AM
"RTN","PSIVOPT2",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**23,29,58,110,127,133,135**;16 DEC 97
"RTN","PSIVOPT2",3,0)
 ;
"RTN","PSIVOPT2",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSIVOPT2",5,0)
 ; Reference to ^PSSLOCK is supported by DBIA #2789
"RTN","PSIVOPT2",6,0)
 ;
"RTN","PSIVOPT2",7,0)
D ; Discontinue order.
"RTN","PSIVOPT2",8,0)
 D NATURE^PSIVOREN I '$D(P("NAT")) W !,$C(7),"Order Unchanged." S COMQUIT=1 Q
"RTN","PSIVOPT2",9,0)
 ;* 8/2* D EN1^PSJHL2(DFN,"OD",+ON55_"V","ORDER DISCONTINUED"),D1
"RTN","PSIVOPT2",10,0)
 I '$$REQPROV^PSGOEC W !,$C(7),"Order Unchanged." S COMQUIT=1 Q
"RTN","PSIVOPT2",11,0)
 I 'PSJCOM D
"RTN","PSIVOPT2",12,0)
 .D D1
"RTN","PSIVOPT2",13,0)
 .S PSIVALT=1,PSIVALCK="STOP",PSIVREA="D",ON=ON55 D LOG^PSIVORAL S P(3)=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3)
"RTN","PSIVOPT2",14,0)
 I PSJCOM N COMFLG S COMFLG=0 D
"RTN","PSIVOPT2",15,0)
 .I ON55'["P" N COMFLG,O,OO S (COMFLG,O)=0,OO="" F  S O=$O(^PS(55,"ACX",PSJCOM,O)) Q:'O  F  S OO=$O(^PS(55,"ACX",PSJCOM,O,OO)) Q:OO=""  Q:COMFLG  D
"RTN","PSIVOPT2",16,0)
 .. Q:OO=ON55  I '$$LS^PSSLOCK(DFN,OO) S COMFLG=1 Q
"RTN","PSIVOPT2",17,0)
 I PSJCOM Q:COMFLG  N O,OO S O=0,OO="" F  S O=$O(^PS(55,"ACX",PSJCOM,O)) Q:'O  F  S OO=$O(^PS(55,"ACX",PSJCOM,O,OO)) Q:OO=""  D
"RTN","PSIVOPT2",18,0)
 .I OO["V" S ON55=OO D D1 S PSIVALT=1,PSIVALCK="STOP",PSIVREA="D",ON=ON55 D LOG^PSIVORAL N PSJORD S P(3)=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3),PSJORD=ON55 D HL^PSIVORA Q
"RTN","PSIVOPT2",19,0)
 .I OO["U" N PSGORD,PSJORD,PSJNOO K DA D NOW^%DTC S PSGDT=%,T=$E("T",'PSJSYSU),PSGALR=20,PSGP=DFN,DA=+OO,DA(1)=PSGP,(PSGORD,PSJORD)=OO,PSJNOO=P("NAT") D
"RTN","PSIVOPT2",20,0)
 ..S CF=$S($P(PSJSYSP0,U,5):1,PSGORD["U":0,1:($P($G(^PS(53.1,+PSGORD,0)),U,25)=""&($P($G(^(4)),U,7)=DUZ)))  D ASET^PSGOEC,AC^PSGOEC
"RTN","PSIVOPT2",21,0)
 Q
"RTN","PSIVOPT2",22,0)
D1 N %,DA,DIE,DIU,STP,NSTOP
"RTN","PSIVOPT2",23,0)
 S NSTOP=$$DATE^PSJUTL2(),STP=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3),NSTOP=+$S(STP>NSTOP:NSTOP,1:STP),P(17)="D"
"RTN","PSIVOPT2",24,0)
 K TMP
"RTN","PSIVOPT2",25,0)
 S TMP(55.01,""_+ON55_","_DFN_","_"",109)=NSTOP
"RTN","PSIVOPT2",26,0)
 S:'$P($G(^PS(55,DFN,"IV",+ON55,2)),U,7) TMP(55.01,""_+ON55_","_DFN_","_"",116)=STP
"RTN","PSIVOPT2",27,0)
 S TMP(55.01,""_+ON55_","_DFN_","_"",100)="D"
"RTN","PSIVOPT2",28,0)
 S TMP(55.01,""_+ON55_","_DFN_","_"",.03)=NSTOP
"RTN","PSIVOPT2",29,0)
 S PSIVACT=1
"RTN","PSIVOPT2",30,0)
 D FILE^DIE("","TMP")
"RTN","PSIVOPT2",31,0)
 K TMP
"RTN","PSIVOPT2",32,0)
 I $S($G(PSIVAC)="OD":0,$G(PSIVAC)'="AD":1,$G(PSGALO)<1060:0,1:$P($G(PSJSYSW0),U,15)) S X=$S($G(PSIVAC)="AD":1,1:2) D ENLBL^PSIVOPT(X,$S(X=1:+$G(PSGUOW),1:DUZ),DFN,3,+ON55,$E("AD",1,3-X))
"RTN","PSIVOPT2",33,0)
 D:'$D(PSJIVORF) ORPARM^PSIVOREN Q:'PSJIVORF  ;* S ORIFN=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,21) Q:'ORIFN
"RTN","PSIVOPT2",34,0)
 Q
"RTN","PSIVOPT2",35,0)
 ;
"RTN","PSIVOPT2",36,0)
R ; Renew order.
"RTN","PSIVOPT2",37,0)
 ;I PSJCOM D RIV^PSJCOMR Q
"RTN","PSIVOPT2",38,0)
 I PSJCOM D ^PSJCOMR Q
"RTN","PSIVOPT2",39,0)
 I P(17)="D",P(12) N ERR D RI W:$G(ERR)=1 $C(7),"  Order unchanged." I $G(ERR)<2 S COMQUIT=1 Q
"RTN","PSIVOPT2",40,0)
 NEW PSGORQF S PSIVRNFG=1 D ORDCHK^PSJLIFN K PSIVRNFG W !
"RTN","PSIVOPT2",41,0)
 I $G(PSGORQF) S COMQUIT=1 Q
"RTN","PSIVOPT2",42,0)
 ;
"RTN","PSIVOPT2",43,0)
R1 ;
"RTN","PSIVOPT2",44,0)
 I $$EXPIRED^PSGOER(DFN,ON55) D  Q
"RTN","PSIVOPT2",45,0)
 .W !?3,"  THIS ORDER HAS BEEN INACTIVE FOR ONE OR MORE SCHEDULED ADMINISTRATIONS"
"RTN","PSIVOPT2",46,0)
 .W !?20,"  AND CANNOT BE RENEWED!"
"RTN","PSIVOPT2",47,0)
 N PSJRNWDT,PSJOSTOP,OREASON S PSJRNWDT=$$DATE2^PSJUTL2(PSGDT) S:$G(ON55) PSJOSTOP=$P($G(^PS(55,DFN,"IV",+ON55,0)),U,3) I '(PSJOSTOP>P(2)),$G(PSGDT) S PSJOSTOP=PSGDT
"RTN","PSIVOPT2",48,0)
 S (PSIVOK,EDIT)="25^1" S P2=P(2),P(2)=PSJRNWDT D EDIT^PSIVEDT S P(2)=P2 K P2 I X="^" Q
"RTN","PSIVOPT2",49,0)
 S P(11)=$$ENRNAT^PSGOU($P($G(^PS(55,DFN,"IV",+ON55,2)),U,10),+VAIN(4),P(9),P(11))
"RTN","PSIVOPT2",50,0)
 D OK G:X["N" R1 I X=U D RD Q
"RTN","PSIVOPT2",51,0)
 S PSIVCHG=2
"RTN","PSIVOPT2",52,0)
 S P(17)="A",OREASON=P("RES"),P("RES")="R",P("FRES")="" D:'$D(PSJIVORF) ORPARM^PSIVOREN I PSJIVORF D  Q:'$D(P("NAT"))
"RTN","PSIVOPT2",53,0)
 .D NATURE^PSIVOREN I '$D(P("NAT")) D RD Q
"RTN","PSIVOPT2",54,0)
 .S ON=ON55
"RTN","PSIVOPT2",55,0)
 S P(16)="",PSJORIFN="",PSIVACT=1,P("21FLG")="",P("RES")=OREASON D SET55^PSIVORFB
"RTN","PSIVOPT2",56,0)
 D:$P(^PS(55,DFN,"IV",+ON55,0),U,17)="A" RUPDATE^PSIVOREN(DFN,ON55,P(2))
"RTN","PSIVOPT2",57,0)
 I PSJIVORF,$P(^PS(55,DFN,"IV",+ON55,0),U,17)'="A" S X=$$LS^PSSLOCK(DFN,+ON55_"V") D
"RTN","PSIVOPT2",58,0)
 .D EXPOE^PSGOER(DFN,ON55)
"RTN","PSIVOPT2",59,0)
 .S P("RES")="R",PSJREN=1
"RTN","PSIVOPT2",60,0)
 .D ENUDTX^PSJOREN(DFN,ON55,"NR"),EN1^PSJHL2(DFN,"SN",+ON55_"V","ORDER RENEWED"),UPDREN(DFN,ON55,PSJRNWDT,P(6),PSJOSTOP,P("NAT"))
"RTN","PSIVOPT2",61,0)
 S OD=P(2)
"RTN","PSIVOPT2",62,0)
 D VF1^PSJLIACT("","",1),UNL^PSSLOCK(DFN,+ON55_"V")
"RTN","PSIVOPT2",63,0)
 D ENLBL^PSIVOPT(2,DUZ,DFN,3,+ON55,"R")
"RTN","PSIVOPT2",64,0)
 I $G(PSJOSTOP),$G(ON55),$G(DFN) D STIX^PSIVOREN(PSJOSTOP,ON55,DFN)
"RTN","PSIVOPT2",65,0)
 Q
"RTN","PSIVOPT2",66,0)
 ;
"RTN","PSIVOPT2",67,0)
RD ; Delete for renew.
"RTN","PSIVOPT2",68,0)
 ;Q:'$G(PSJVFY)
"RTN","PSIVOPT2",69,0)
 ;D DEL55^PSIVORE2 S (ON55,P("OLDON"))=P("PON") D GT55^PSIVORFB
"RTN","PSIVOPT2",70,0)
 Q
"RTN","PSIVOPT2",71,0)
 ;
"RTN","PSIVOPT2",72,0)
OK ;Print example label, run order through checker, ask if it is ok.
"RTN","PSIVOPT2",73,0)
 S P16=0,PSIVEXAM=1,(PSIVNOL,PSIVCT)=1 D GTOT^PSIVUTL(P(4)) I ($G(P("PD"))="") D GTPD^PSIVORE2
"RTN","PSIVOPT2",74,0)
 D ^PSIVCHK I $D(DUOUT) S X="^",COMQUIT=1 Q
"RTN","PSIVOPT2",75,0)
 I ERR=1 S X="N",COMQUIT=1 Q
"RTN","PSIVOPT2",76,0)
 W ! D ^PSIVORLB K PSIVEXAM S Y=P(2) W !,"Start date: " X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),?30," Stop date: " S Y=P(3) X ^DD("DD") W $P(Y,"@")," ",$P(Y,"@",2),!
"RTN","PSIVOPT2",77,0)
 I $G(PSIVCHG),($G(PSIVREA)'="R") W !,"*** This change will cause a new order to be created. ***"
"RTN","PSIVOPT2",78,0)
 S X="Is this O.K.: ^"_$S(ERR:"N",1:"Y")_"^^NO"_$S(ERR'=1:",YES",1:"") D ENQ^PSIV I X["?" S HELP="OK" D ^PSIVHLP G OK
"RTN","PSIVOPT2",79,0)
 Q
"RTN","PSIVOPT2",80,0)
 ;
"RTN","PSIVOPT2",81,0)
RI ; Reinstate Auto-DC'ed order.
"RTN","PSIVOPT2",82,0)
 N DA,DIE,DIR,DIU,DR,PSIVACT,PSIVALT,PSIVALCK,PSIVREA W !!,$C(7),"This order has been Auto-DC'ed."
"RTN","PSIVOPT2",83,0)
 S DIR(0)="Y",DIR("A")="Reinstate this order" D ^DIR K DIR I 'Y S ERR=1 Q
"RTN","PSIVOPT2",84,0)
 D NOW^%DTC I %>$P($G(^PS(55,DFN,"IV",+ON55,2)),U,7) D
"RTN","PSIVOPT2",85,0)
 .K DIR S ERR=1,DIR(0)="Y",DIR("A",1)="The original stop date of this order has past.",DIR("A")="Do you wish to renew this order" D ^DIR K DIR S ERR=$S(Y:2,1:1)
"RTN","PSIVOPT2",86,0)
 Q:$G(ERR)  S X=$G(^VA(200,+P(6),"PS")) I $S('X:1,'$P(X,U,4):0,DT<$P(X,U,4):0,1:1) S ERR=1
"RTN","PSIVOPT2",87,0)
 I $G(ERR) W !!,$C(7),"This order's provider is no longer valid. Please enter a valid provider." S (EDIT,PSIVOK)=1 D EDIT^PSIVEDT I $G(DONE) W $C(7),"Order unchanged." S ERR=1 Q
"RTN","PSIVOPT2",88,0)
 N PSGALO S PSGALO=18530 D ENARI^PSIVOPT(DFN,ON,DUZ,PSGALO)
"RTN","PSIVOPT2",89,0)
 Q
"RTN","PSIVOPT2",90,0)
 ;
"RTN","PSIVOPT2",91,0)
UPDREN(DFN,ORD,RNWDT,PROV,OSTOPDT,PSJNOO) ;
"RTN","PSIVOPT2",92,0)
 Q:'DFN!'ORD!'RNWDT!'PROV!'OSTOPDT!(PSJNOO="")
"RTN","PSIVOPT2",93,0)
 K DR,DA,DIC,DIE,DD,DO N ND0,PSGOEORD
"RTN","PSIVOPT2",94,0)
 S DIC="^PS(55,"_DFN_",""IV"","_+ORD S ND0=$G(@(DIC_",0)")),PSGOEORD=$P(ND0,"^",21) I $G(ON)["P",$G(PSGOLDOE) S PSGOEORD=PSGOLDOE
"RTN","PSIVOPT2",95,0)
 S DIC=DIC_",14,",DIC(0)="L",DIC("P")="55.1138DA",ND14=$G(@(DIC_"0)")),DINUM=$P(ND14,"^",3)+1,DA(2)=DFN,DA(1)=+ORD D
"RTN","PSIVOPT2",96,0)
 .S DIC("DR")=".01////"_$G(RNWDT)_";1////"_$G(DUZ)_";2////"_$G(PROV)_";3////"_$G(OSTOPDT)_";4////"_+PSGOEORD,X=$G(RNWDT) D FILE^DICN
"RTN","PSIVOPT2",97,0)
 .Q
"RTN","PSIVOPT2",98,0)
 K DO,DINUM
"RTN","PSIVORAL")
0^1^B14231518
"RTN","PSIVORAL",1,0)
PSIVORAL ;BIR/MLM-ACTIVITY LOGGER FOR PHARMACY EDITS ;16 DEC 97 / 1:40 PM 
"RTN","PSIVORAL",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**58,135**;16 DEC 97
"RTN","PSIVORAL",3,0)
 ;
"RTN","PSIVORAL",4,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSIVORAL",5,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSIVORAL",6,0)
 ;
"RTN","PSIVORAL",7,0)
EN ; Entry point for updating activity log from Pharmacy.
"RTN","PSIVORAL",8,0)
 ;
"RTN","PSIVORAL",9,0)
OPI ; Record changes to Other print info.
"RTN","PSIVORAL",10,0)
 I $P($G(^PS(55,DFN,"IV",+ON55,3)),"^")'=$P(P("OPI"),"^") S P("FC")="OTHER PRINT INFO^"_$P($G(^(3)),"^")_U_$P(P("OPI"),"^") D GTFC
"RTN","PSIVORAL",11,0)
 ;
"RTN","PSIVORAL",12,0)
REMARKS ; Record changes to remarks.
"RTN","PSIVORAL",13,0)
 I $G(^PS(55,DFN,"IV",+ON55,1))'=P("REM") S P("FC")="REMARKS^"_$G(^(1))_U_P("REM") D GTFC
"RTN","PSIVORAL",14,0)
 ;
"RTN","PSIVORAL",15,0)
ADMIN ; Record changes to admin. times.
"RTN","PSIVORAL",16,0)
 I $P($G(^PS(55,DFN,"IV",+ON55,0)),U,11)'=P(11) S P("FC")="ADMINISTRATION TIMES^"_$P($G(^(0)),U,11)_U_P(11) D GTFC
"RTN","PSIVORAL",17,0)
 ;
"RTN","PSIVORAL",18,0)
INFUS ; Record changes to infusion rate.
"RTN","PSIVORAL",19,0)
 I $P($G(^PS(55,DFN,"IV",+ON55,0)),U,8)'=P(8) S P("FC")="INFUSION RATE^"_$P($G(^(0)),U,8)_U_P(8) D GTFC
"RTN","PSIVORAL",20,0)
 D:P("DTYP")=1 SOL
"RTN","PSIVORAL",21,0)
 ;
"RTN","PSIVORAL",22,0)
STOP ; Record changes to stop date.
"RTN","PSIVORAL",23,0)
 I $P(^PS(55,DFN,"IV",+ON55,0),U,3)'=P(3) S P("FC")="STOP DATE/TIME^",Y=$P(^(0),U,3) X ^DD("DD") S $P(P("FC"),U,3)=$P(Y,"@")_" "_$P(Y,"@",2),Y=P(3) X ^DD("DD") S $P(P("FC"),U,2)=$P(Y,"@")_" "_$P(Y,"@",2) D GTFC
"RTN","PSIVORAL",24,0)
 K DRGI,DRGN,TDRG,P("AGE"),P("FC")
"RTN","PSIVORAL",25,0)
 Q
"RTN","PSIVORAL",26,0)
 ;
"RTN","PSIVORAL",27,0)
SOL ; Record changes to Solutions.
"RTN","PSIVORAL",28,0)
 K TDRG F DRGI=0:0 S DRGI=$O(DRG("SOL",DRGI)) Q:'DRGI  S TDRG("NEW",$P(DRG("SOL",DRGI),U))=$P(DRG("SOL",DRGI),U,2,3)
"RTN","PSIVORAL",29,0)
 S P("AGE")="NEW"
"RTN","PSIVORAL",30,0)
 F DRGI=0:0 S DRGI=$O(^PS(55,DFN,"IV",+ON55,"SOL",DRGI)) Q:'DRGI  S X=$G(^PS(55,DFN,"IV",+ON55,"SOL",DRGI,0)),DRG=+$P(X,U),TDRG("OLD",+DRG)=$P($G(^PS(52.7,DRG,0)),U)_U_$P(X,U,2) D:$G(TDRG("NEW",DRG))'=$G(TDRG("OLD",DRG)) SOL1
"RTN","PSIVORAL",31,0)
 S P("AGE")="OLD" F DRGI=0:0 S DRG=$O(TDRG("NEW",DRG)) Q:'DRG  D:$G(TDRG("NEW",DRG))'=$G(TDRG("OLD",DRG)) SOL1
"RTN","PSIVORAL",32,0)
 Q
"RTN","PSIVORAL",33,0)
 ;
"RTN","PSIVORAL",34,0)
SOL1 ;
"RTN","PSIVORAL",35,0)
 I '$D(TDRG(P("AGE"),DRG)) S P("FC")="SOLUTION^"_$P($G(TDRG("OLD",DRG)),U)_U_$P($G(TDRG("NEW",DRG)),U) D GTFC
"RTN","PSIVORAL",36,0)
 Q:$G(TDRG("NEW",DRG))=$G(TDRG("OLD",DRG))
"RTN","PSIVORAL",37,0)
 S P("FC")="VOLUME^"_$P($G(TDRG("OLD",DRG)),U,2)_$S($G(TDRG("OLD",DRG))]"":" ("_$P($G(^PS(52.7,DRG,0)),U)_")",1:"")_U_$P($G(TDRG("NEW",DRG)),U,2)_$S($G(TDRG("NEW",DRG))]"":" ("_$P($G(^PS(52.7,DRG,0)),U)_")",1:"") D GTFC
"RTN","PSIVORAL",38,0)
 Q
"RTN","PSIVORAL",39,0)
 ;
"RTN","PSIVORAL",40,0)
GTFC ; Create field change entry in activity log.
"RTN","PSIVORAL",41,0)
 S ND=$G(^PS(55,DFN,"IV",+ON55,"A",PSIVLN,1,0)) S:ND="" ND="^55.151^^" S $P(ND,U,3)=$P(ND,U,3)+1,$P(ND,U,4)=$P(ND,U,4)+1,^PS(55,DFN,"IV",+ON55,"A",PSIVLN,1,0)=ND,^PS(55,DFN,"IV",+ON55,"A",PSIVLN,1,$P(ND,U,3),0)=P("FC") K ND
"RTN","PSIVORAL",42,0)
 Q
"RTN","PSIVORAL",43,0)
LOG ; Update activity log (ask for comment.)
"RTN","PSIVORAL",44,0)
 N ON S ON=ON55
"RTN","PSIVORAL",45,0)
 ;PSJPINIT is defined in PSJUTL3.
"RTN","PSIVORAL",46,0)
 S:+$G(PSJPINIT)'>0 PSJPINIT=DUZ
"RTN","PSIVORAL",47,0)
 I $G(PSIVALT)=1,'$G(PSJUNDC) K DA,DIR S DIR(0)="55.04,.04" D ^DIR K DA,DIR S PSIVAL=$S($D(DIRUT):"",1:Y)
"RTN","PSIVORAL",48,0)
 S:$G(PSIVALT)=2 PSIVAL="Action taken using OE/RR options." D ENTACT^PSIVAL
"RTN","PSIVORAL",49,0)
 K TMP
"RTN","PSIVORAL",50,0)
 S TMP(55.04,""_PSIVLN_","_+ON55_","_DFN_","_"",.02)=PSIVREA
"RTN","PSIVORAL",51,0)
 S TMP(55.04,""_PSIVLN_","_+ON55_","_DFN_","_"",.03)=$P(^VA(200,PSJPINIT,0),U)
"RTN","PSIVORAL",52,0)
 S TMP(55.04,""_PSIVLN_","_+ON55_","_DFN_","_"",.04)=$G(PSIVAL)
"RTN","PSIVORAL",53,0)
 S TMP(55.04,""_PSIVLN_","_+ON55_","_DFN_","_"",.06)=PSJPINIT
"RTN","PSIVORAL",54,0)
 D FILE^DIE("","TMP")
"RTN","PSIVORAL",55,0)
 K TMP
"RTN","PSIVORAL",56,0)
 D:$D(PSIVALCK) @PSIVALCK K PSIVALT,PSIVALCK,PSIVAL
"RTN","PSIVORAL",57,0)
 Q
"RTN","PSJADT0")
0^3^B32509433
"RTN","PSJADT0",1,0)
PSJADT0 ;BIR/CML3,PR,MLM-AUTO DC/HOLD CANCEL ;11 Aug 98 / 8:25 AM
"RTN","PSJADT0",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**17,111,112,135**;16 DEC 97
"RTN","PSJADT0",3,0)
 ;
"RTN","PSJADT0",4,0)
 ;Reference to ^PS(55 supported by DBIA #2191.
"RTN","PSJADT0",5,0)
 ;Reference to ^PS(59.7 supported by DBIA #2181.
"RTN","PSJADT0",6,0)
 ;
"RTN","PSJADT0",7,0)
ENDC ; dc active orders first, then non-verified orders
"RTN","PSJADT0",8,0)
 W:'$D(PSJQUIET)&'$D(DGQUIET) !,"...discontinuing Inpatient Medication orders..."
"RTN","PSJADT0",9,0)
 S $P(PSJPIND,"^")=""
"RTN","PSJADT0",10,0)
 D NOW^%DTC N PSJDCDT S (PSJDCDT,PSGDT)=+%,PSJSYSW0="" I PSJFW S PSJSYSW=$O(^PS(59.6,"B",PSJFW,0)) S:PSJSYSW PSJSYSW0=$G(^PS(59.6,PSJSYSW,0))
"RTN","PSJADT0",11,0)
 I PSGALO=1010!(PSGALO=1030)!(PSGALO=1050) D AUDDD
"RTN","PSJADT0",12,0)
 D ENUNM^PSGOU S PSGALR=10,DIE="^PS(55,"_PSGP_",5," S:PSJFW PSGTOL=1,PSGUOW=PSJFW,PSGTOO=1
"RTN","PSJADT0",13,0)
 F PSJS=PSGDT:0 S PSJS=$O(^PS(55,PSGP,5,"AUS",PSJS)) Q:'PSJS  F PSJDA=0:0 S PSJDA=$O(^PS(55,PSGP,5,"AUS",PSJS,PSJDA)) Q:'PSJDA  D
"RTN","PSJADT0",14,0)
 .Q:'$$DCIMO(PSGP,PSJDA,"U") 
"RTN","PSJADT0",15,0)
 .;first naked reference below refers to the full global reference to the right of the = sign (inside the $S)
"RTN","PSJADT0",16,0)
 .K DA S DA(1)=PSGP,DA=PSJDA,PSGAL("C")=0,$P(^(2),"^",3)=$S($D(^PS(55,PSGP,5,DA,2)):$P(^(2),"^",4),1:"")
"RTN","PSJADT0",17,0)
 .D ^PSGAL5
"RTN","PSJADT0",18,0)
 .K TMP
"RTN","PSJADT0",19,0)
 .S TMP(55.06,""_PSJDA_","_PSGP_","_"",28)="D"
"RTN","PSJADT0",20,0)
 .D FILE^DIE("","TMP")
"RTN","PSJADT0",21,0)
 .K TMP
"RTN","PSJADT0",22,0)
 .S TMP(55.06,""_PSJDA_","_PSGP_","_"",34)=PSJDCDT
"RTN","PSJADT0",23,0)
 .S TMP(55.06,""_PSJDA_","_PSGP_","_"",49)=1
"RTN","PSJADT0",24,0)
 .D FILE^DIE("","TMP")
"RTN","PSJADT0",25,0)
 .K TMP
"RTN","PSJADT0",26,0)
 .D EN1^PSJHL2(PSGP,"OD",PSJDA_"U","AUTO DC")
"RTN","PSJADT0",27,0)
 .I PSGALO'=1050 S DA=PSJDA,^PS(55,"AUE",PSGP,DA)="" I $P(PSJSYSW0,"^",15),(PSGALO'<1060) S $P(^PS(55,PSGP,5,PSJDA,7),"^",1,2)=PSJDCDT_"^D" D ENL^PSGVDS
"RTN","PSJADT0",28,0)
 S PSGTOO=2 F PSJDA=0:0 S PSJDA=$O(^PS(53.1,"AC",PSGP,PSJDA)) Q:'PSJDA  D
"RTN","PSJADT0",29,0)
 .Q:'$$DCIMO(PSGP,PSJDA,"P")
"RTN","PSJADT0",30,0)
 .I PSGALO'<1060,$P(PSJSYSW0,U,15),$P($G(^PS(53.1,PSJDA,0)),U,9)="N" K DA D ENLBL^PSIVOPT(PSGTOL,PSGUOW,DFN,2,+PSJDA,"AD")
"RTN","PSJADT0",31,0)
 .K DA S DA=PSJDA D  I $P($G(^PS(53.1,DA,0)),"^",21) D EN1^PSJHL2(PSGP,"OC",PSJDA_"P","AUTO DC")
"RTN","PSJADT0",32,0)
 ..K TMP
"RTN","PSJADT0",33,0)
 ..S TMP(53.1,""_PSJDA_","_"",28)="D"
"RTN","PSJADT0",34,0)
 ..S TMP(53.1,""_PSJDA_","_"",42)=1
"RTN","PSJADT0",35,0)
 ..D FILE^DIE("","TMP")
"RTN","PSJADT0",36,0)
 ..K TMP
"RTN","PSJADT0",37,0)
 ;
"RTN","PSJADT0",38,0)
ENIV ;
"RTN","PSJADT0",39,0)
 S DFN=PSGP F PSJIVON=0:0 S PSJIVON=$O(^PS(55,DFN,"IV",PSJIVON)) Q:'PSJIVON  S Y=$G(^(PSJIVON,0)) I "PDEN"'[$P(Y,U,17) S P(17)=$P(Y,U,17),P(3)=$P(Y,U,3) D DC
"RTN","PSJADT0",40,0)
 Q
"RTN","PSJADT0",41,0)
DC ;
"RTN","PSJADT0",42,0)
 Q:'$$DCIMO(DFN,PSJIVON,"V")
"RTN","PSJADT0",43,0)
 S (ON,ON55)=PSJIVON_"V" D NOW^%DTC I P(17)="H",P(3)<% D  D EXPIR^PSIVOE Q
"RTN","PSJADT0",44,0)
 .K TMP
"RTN","PSJADT0",45,0)
 .S TMP(55.01,""_+ON_","_DFN_","_"",100)="E"
"RTN","PSJADT0",46,0)
 .D FILE^DIE("","TMP")
"RTN","PSJADT0",47,0)
 .K TMP
"RTN","PSJADT0",48,0)
 K PSIVALT S PSIVAC="AD",PSIVALCK="STOP",PSIVREA="D",PSIVAL=$S('+$G(PSGALO):$G(PSIVRES),1:$P($G(^PS(53.3,+PSGALO,0)),U)) D D1^PSIVOPT2,LOG^PSIVORAL
"RTN","PSJADT0",49,0)
 K TMP
"RTN","PSJADT0",50,0)
 S TMP(55.01,""_+ON_","_DFN_","_"",.03)=PSJDCDT
"RTN","PSJADT0",51,0)
 S TMP(55.01,""_+ON_","_DFN_","_"",121)=1
"RTN","PSJADT0",52,0)
 D FILE^DIE("","TMP")
"RTN","PSJADT0",53,0)
 K TMP
"RTN","PSJADT0",54,0)
 D EN1^PSJHL2(DFN,"OD",+ON_"V","AUTO DC")
"RTN","PSJADT0",55,0)
 S PSJIVDCF=1
"RTN","PSJADT0",56,0)
 Q
"RTN","PSJADT0",57,0)
 ;
"RTN","PSJADT0",58,0)
SIVDIE ; Setup DIE,DA for IV
"RTN","PSJADT0",59,0)
 K DA,DIE,DR S DA=+ON,DA(1)=DFN,DIE="^PS(55,"_DFN_",""IV"","
"RTN","PSJADT0",60,0)
 Q
"RTN","PSJADT0",61,0)
 ;
"RTN","PSJADT0",62,0)
AUDDD ; set up orders for discharge report and purging
"RTN","PSJADT0",63,0)
 S DIS=+VAIP(17,1) I $S('DIS:1,1:$D(^PS(55,"AUDDD",DIS,PSGP))) Q
"RTN","PSJADT0",64,0)
 S X=$$EN^PSGCT(+VAIP(13,1),-1)
"RTN","PSJADT0",65,0)
 F Q=X:0 S Q=$O(^PS(55,PSGP,5,"AUS",Q)) Q:'Q  F QQ=0:0 S QQ=$O(^PS(55,PSGP,5,"AUS",Q,QQ)) Q:'QQ  I $S($D(^PS(55,PSGP,5,QQ,0)):'$P(^(0),"^",20),1:1) S $P(^(0),"^",20)=DIS,^PS(55,"AUDDD",DIS,PSGP,QQ)=""
"RTN","PSJADT0",66,0)
 Q
"RTN","PSJADT0",67,0)
 ;
"RTN","PSJADT0",68,0)
ENHE ; status from hold to expired
"RTN","PSJADT0",69,0)
 D NOW^%DTC S PSGDT=+$E(%,1,12),DIE="^PS(55,"_PSGP_",5,"
"RTN","PSJADT0",70,0)
 F PSJS=+PSJPAD:0 S PSJS=$O(^PS(55,PSGP,5,"AUS",PSJS)) Q:'PSJS  Q:PSJS>PSGDT  F PSJDA=0:0 S PSJDA=$O(^PS(55,PSGP,5,"AUS",PSJS,PSJDA)) Q:'PSJDA  K DA S DA(1)=PSGP,DA=PSJDA I $D(^PS(55,PSGP,5,DA,0)),$P(^(0),"^",9)="H" S DR="28////E" D ^DIE
"RTN","PSJADT0",71,0)
 Q
"RTN","PSJADT0",72,0)
 ;
"RTN","PSJADT0",73,0)
ENUNDC(PSJDCDT,PSGP,PSJUOW,PSGALO) ; Auto-reinstate orders DC'ed due to a patient movement.
"RTN","PSJADT0",74,0)
 N PSJSYSW0 D NOW^%DTC S PSJUNDC=1,PSGDT=%,PSJFIRST='$D(PSJQUIET),PSJSYSW0=$G(^PS(59.6,+$O(^PS(59.6,"B",+PSJUOW,0)),0))
"RTN","PSJADT0",75,0)
 S PSJS=$O(^PS(55,PSGP,5,"AUS",PSJDCDT-.0002)) F PSGORD=0:0 S PSGORD=$O(^PS(55,PSGP,5,"AUS",+PSJS,PSGORD)) Q:'PSGORD  D
"RTN","PSJADT0",76,0)
 .I $P($G(^PS(55,PSGP,5,PSGORD,0)),U,9)["D",$P($G(^(4)),U,11) D DISREIN,ENRI^PSGOERI
"RTN","PSJADT0",77,0)
 .S ^PS(55,"AUE",PSGP,PSGORD)=""
"RTN","PSJADT0",78,0)
 ;
"RTN","PSJADT0",79,0)
 S:PSJS="" PSJS=$O(^PS(55,PSGP,"IV","AIS",PSJDCDT-.0002))
"RTN","PSJADT0",80,0)
 F PSGORD=0:0 S PSGORD=$O(^PS(55,PSGP,"IV","AIS",+PSJS,PSGORD)) Q:'PSGORD  D
"RTN","PSJADT0",81,0)
 .I $P($G(^PS(55,PSGP,"IV",PSGORD,0)),U,12),$P($G(^(2)),U,7)>PSGDT S P(3)=$P($G(^(0)),U,3) D DISREIN,ENARI^PSIVOPT(PSGP,PSGORD,+PSJUOW,PSGALO)
"RTN","PSJADT0",82,0)
 I $D(^TMP("PSJUNDC")) S ^TMP("PSJUNDC",$J,DFN)=$P(^DPT(DFN,0),"^")_"^"_$G(^DPT(PSGP,.1))_"^"_PSGALO D ^PSJADT2
"RTN","PSJADT0",83,0)
 ;
"RTN","PSJADT0",84,0)
ENKL ;
"RTN","PSJADT0",85,0)
 F UW=0:0 S UW=$O(^PS(53.41,1,1,UW)) Q:'UW  D  I '$O(^PS(53.41,1,1,0)) K DA S DA=1,DIK="^PS(53.41," D ^DIK
"RTN","PSJADT0",86,0)
 .F PSGP=0:0 S PSGP=$O(^PS(53.41,1,1,UW,1,PSGP)) Q:'PSGP  D  I '$O(^PS(53.41,1,1,UW,1,0)) K DA S DIK="^PS(53.41,1,1,",DA(1)=1,DA=UW D ^DIK
"RTN","PSJADT0",87,0)
 ..F TO=0:0 S TO=$O(^PS(53.41,1,1,UW,1,PSGP,1,TO)) Q:'TO  D  I '$O(^PS(53.41,1,1,UW,1,PSGP,1,0)) K DA S DA(2)=1,DA(1)=UW,DA=PSGP,DIK="^PS(53.41,1,1,"_UW_",1," D ^DIK
"RTN","PSJADT0",88,0)
 ...I '$O(^PS(53.41,1,1,UW,1,PSGP,1,TO,1,0))  K DA S DA(3)=1,DA(2)=UW,DA(1)=PSGP,DA=TO,DIK="^PS(53.41,1,1,"_UW_",1,"_PSGP_",1," D ^DIK
"RTN","PSJADT0",89,0)
 K DA,DIK,P,PSGDT,PSGP,PSGORD,PSJS,PSJUNDC,TO,UW
"RTN","PSJADT0",90,0)
 Q
"RTN","PSJADT0",91,0)
 ;
"RTN","PSJADT0",92,0)
DISREIN ; Display reinstate msg. for first order.
"RTN","PSJADT0",93,0)
 W:PSJFIRST&'$D(DGQUIET) !,"...reinstating Inpatient Medication orders..." S PSJFIRST=0
"RTN","PSJADT0",94,0)
 Q
"RTN","PSJADT0",95,0)
 ;
"RTN","PSJADT0",96,0)
DCIMO(DFN,ON,TYP) ; Check parameter before DC'ing clinic order
"RTN","PSJADT0",97,0)
 N GLO,IMOND,A,CLINIC,APPT,B,C S GLO=$S(TYP="P":"^PS(53.1,",TYP="U":"^PS(55,"_DFN_",5,",TYP="V":"^PS(55,"_PSGP_",""IV"",",1:"") I TYP="" Q 1
"RTN","PSJADT0",98,0)
 S IMOND=$S(TYP="P"!(TYP="V"):"""DSS""",TYP="U":8,1:"") I IMOND="" Q 1
"RTN","PSJADT0",99,0)
 S GLO=GLO_+ON_","_IMOND_")",A=$G(@GLO),CLINIC=$P(A,"^"),APPT=$P(A,"^",2)
"RTN","PSJADT0",100,0)
 Q:'$$CLINIC^PSJBCMA(A) 1
"RTN","PSJADT0",101,0)
 I '$D(^PS(53.46,"B",CLINIC)) Q 1
"RTN","PSJADT0",102,0)
 S B=$O(^PS(53.46,"B",CLINIC,"")),C=+$P(^PS(53.46,B,0),"^",3) Q C
"VER")
8.0^22.0
"BLD",5756,6)
^SEQ #128
**END**
**END**
