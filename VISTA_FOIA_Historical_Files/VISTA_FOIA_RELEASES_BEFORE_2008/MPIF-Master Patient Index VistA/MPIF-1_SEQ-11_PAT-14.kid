Released MPIF*1*14 SEQ #11
Extracted from mail message
**KIDS**:MPIF*1.0*14^

**INSTALL NAME**
MPIF*1.0*14
"BLD",1900,0)
MPIF*1.0*14^MASTER PATIENT INDEX VISTA^0^3010226^y
"BLD",1900,4,0)
^9.64PA^^
"BLD",1900,"ABNS",0)
^9.66A^^
"BLD",1900,"ABPKG")
n^y^G.CIRN DEV@FORUM.VA.GOV
"BLD",1900,"KRN",0)
^9.67PA^19^17
"BLD",1900,"KRN",.4,0)
.4
"BLD",1900,"KRN",.401,0)
.401
"BLD",1900,"KRN",.402,0)
.402
"BLD",1900,"KRN",.403,0)
.403
"BLD",1900,"KRN",.5,0)
.5
"BLD",1900,"KRN",.84,0)
.84
"BLD",1900,"KRN",3.6,0)
3.6
"BLD",1900,"KRN",3.8,0)
3.8
"BLD",1900,"KRN",9.2,0)
9.2
"BLD",1900,"KRN",9.8,0)
9.8
"BLD",1900,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",1900,"KRN",9.8,"NM",1,0)
MPIFAPI^^0^B14125051
"BLD",1900,"KRN",9.8,"NM",2,0)
MPIFQ0^^0^B86202246
"BLD",1900,"KRN",9.8,"NM","B","MPIFAPI",1)

"BLD",1900,"KRN",9.8,"NM","B","MPIFQ0",2)

"BLD",1900,"KRN",19,0)
19
"BLD",1900,"KRN",19.1,0)
19.1
"BLD",1900,"KRN",101,0)
101
"BLD",1900,"KRN",409.61,0)
409.61
"BLD",1900,"KRN",771,0)
771
"BLD",1900,"KRN",870,0)
870
"BLD",1900,"KRN",8994,0)
8994
"BLD",1900,"KRN","B",.4,.4)

"BLD",1900,"KRN","B",.401,.401)

"BLD",1900,"KRN","B",.402,.402)

"BLD",1900,"KRN","B",.403,.403)

"BLD",1900,"KRN","B",.5,.5)

"BLD",1900,"KRN","B",.84,.84)

"BLD",1900,"KRN","B",3.6,3.6)

"BLD",1900,"KRN","B",3.8,3.8)

"BLD",1900,"KRN","B",9.2,9.2)

"BLD",1900,"KRN","B",9.8,9.8)

"BLD",1900,"KRN","B",19,19)

"BLD",1900,"KRN","B",19.1,19.1)

"BLD",1900,"KRN","B",101,101)

"BLD",1900,"KRN","B",409.61,409.61)

"BLD",1900,"KRN","B",771,771)

"BLD",1900,"KRN","B",870,870)

"BLD",1900,"KRN","B",8994,8994)

"BLD",1900,"QUES",0)
^9.62^^
"BLD",1900,"REQB",0)
^9.611^3^3
"BLD",1900,"REQB",1,0)
MPIF*1.0*8^1
"BLD",1900,"REQB",2,0)
MPIF*1.0*1^1
"BLD",1900,"REQB",3,0)
MPIF*1.0*3^1
"BLD",1900,"REQB","B","MPIF*1.0*1",2)

"BLD",1900,"REQB","B","MPIF*1.0*3",3)

"BLD",1900,"REQB","B","MPIF*1.0*8",1)

"MBREQ")
0
"PKG",474,-1)
1^1
"PKG",474,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",474,20,0)
^9.402P^^
"PKG",474,22,0)
^9.49I^1^1
"PKG",474,22,1,0)
1.0^2990428^2990603^9139
"PKG",474,22,1,"PAH",1,0)
14^3010226
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","MPIFAPI")
0^1^B14125051
"RTN","MPIFAPI",1,0)
MPIFAPI ;CMC/BP-APIS FOR MPI ;DEC 21, 1998
"RTN","MPIFAPI",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,14**;30 Apr 99
"RTN","MPIFAPI",3,0)
 ;original 1st line ARS/SLC - API for local ICNs ;04-FEB-97
"RTN","MPIFAPI",4,0)
 ;
"RTN","MPIFAPI",5,0)
EN2() ;NEW ENTRY POINT FOR LOCALS
"RTN","MPIFAPI",6,0)
 N MPIOUT,DIC,MPICHK,MPINCK,MPINNM,MPINUM1,DA,MPINUM
"RTN","MPIFAPI",7,0)
 I $O(^MPIF(984.1,0))="" G SETUP
"RTN","MPIFAPI",8,0)
AGN2 L +^MPIF(984.1):1 E  H 3 G AGN2
"RTN","MPIFAPI",9,0)
 S MPINUM=0
"RTN","MPIFAPI",10,0)
 S X=$$SITE^VASITE,X=$P(X,"^",3),X=X\1
"RTN","MPIFAPI",11,0)
 S DIC="^MPIF(984.1,",DIC(0)="XZ" D ^DIC
"RTN","MPIFAPI",12,0)
 S MPINUM1=$P(Y(0),"^",4),MPICHK=$P(Y(0),"^",5),MPINNM=MPINUM1+1
"RTN","MPIFAPI",13,0)
 S MPINUM=MPINUM1_"V"_MPICHK
"RTN","MPIFAPI",14,0)
 S MPINCK=$$CHECKDG^MPIFSPC(MPINNM)
"RTN","MPIFAPI",15,0)
 S DA=1,DIE="^MPIF(984.1,",DR="1////^S X=MPINUM1;2////^S X=MPICHK;3////^S X=MPINNM;5////"_MPINCK
"RTN","MPIFAPI",16,0)
 D ^DIE
"RTN","MPIFAPI",17,0)
 K DIE,DR,X,Y
"RTN","MPIFAPI",18,0)
 L -^MPIF(984.1)
"RTN","MPIFAPI",19,0)
 Q MPINUM
"RTN","MPIFAPI",20,0)
SETUP ;
"RTN","MPIFAPI",21,0)
 N CHK,NUM,NXTCHK,NXTNUM,SITE,DA
"RTN","MPIFAPI",22,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFAPI",23,0)
 S DIC="^MPIF(984.1,",DA=1,DIC(0)="",X=SITE
"RTN","MPIFAPI",24,0)
 S NUM=SITE_"0000000"
"RTN","MPIFAPI",25,0)
 S CHK=$$CHECKDG^MPIFSPC(NUM)
"RTN","MPIFAPI",26,0)
 S MPINUM=NUM_"V"_CHK
"RTN","MPIFAPI",27,0)
 S NXTNUM=NUM+1,NXTCHK=$$CHECKDG^MPIFSPC(NXTNUM)
"RTN","MPIFAPI",28,0)
 S DIC("DR")="1////^S X=NUM;2////^S X=CHK;3////^S X=NXTNUM;5////"_NXTCHK
"RTN","MPIFAPI",29,0)
 K DD,D0
"RTN","MPIFAPI",30,0)
 D FILE^DICN
"RTN","MPIFAPI",31,0)
 K DIC,X,Y
"RTN","MPIFAPI",32,0)
 Q MPINUM
"RTN","MPIFAPI",33,0)
 ;
"RTN","MPIFAPI",34,0)
MPILINK() ;returns MPI logical LInk
"RTN","MPIFAPI",35,0)
 N MPIL,MPILINK
"RTN","MPIFAPI",36,0)
 D LINK^HLUTIL3("MPI",.MPIL)
"RTN","MPIFAPI",37,0)
 I '$D(MPIL) S MPIL(0)="-1^NOT DEFINED"
"RTN","MPIFAPI",38,0)
 S MPILINK=$O(MPIL(0)),MPILINK=$G(MPIL(MPILINK))
"RTN","MPIFAPI",39,0)
 Q MPILINK
"RTN","MPIFAPI",40,0)
 ;
"RTN","MPIFAPI",41,0)
SUBNUM(DFN) ; returns Subscription Control Number from MPI node for given DFN
"RTN","MPIFAPI",42,0)
 ; DFN - ien of patient file
"RTN","MPIFAPI",43,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",44,0)
 ;           Subscription Control Number
"RTN","MPIFAPI",45,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",46,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",47,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",48,0)
 N NODE,SUB
"RTN","MPIFAPI",49,0)
 S NODE=$$MPINODE(DFN)
"RTN","MPIFAPI",50,0)
 S SUB=$P(NODE,"^",5)
"RTN","MPIFAPI",51,0)
 I SUB="" S SUB="-1^No Subscription Control Number for DFN "_DFN
"RTN","MPIFAPI",52,0)
 Q SUB
"RTN","MPIFAPI",53,0)
 ;
"RTN","MPIFAPI",54,0)
MPINODE(DFN) ; returns MPI node for given DFN
"RTN","MPIFAPI",55,0)
 ; DFN - patient file ien
"RTN","MPIFAPI",56,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",57,0)
 ;           MPI node from patient file
"RTN","MPIFAPI",58,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",59,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",60,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",61,0)
 N NODE
"RTN","MPIFAPI",62,0)
 S NODE=$G(^DPT(DFN,"MPI"))
"RTN","MPIFAPI",63,0)
 I NODE=""!(NODE?."^") S NODE="-1^No MPI data for DFN "_DFN
"RTN","MPIFAPI",64,0)
 Q NODE
"RTN","MPIFAPI",65,0)
 ;
"RTN","MPIFAPI",66,0)
UPDATE(DFN,ARR) ; updates fields on MPI node passed in ARR(field number) for
"RTN","MPIFAPI",67,0)
 ;patient DFN.  Fields 991.01-991.05 only
"RTN","MPIFAPI",68,0)
 ;ARR - array of values for each field to be updated where subscript
"RTN","MPIFAPI",69,0)
 ; is the field number to be updated
"RTN","MPIFAPI",70,0)
 ;DFN - patient IEN
"RTN","MPIFAPI",71,0)
 ;Returns : -1^error message if unable to update fields
"RTN","MPIFAPI",72,0)
 ;          0 if sucessfully updated fields
"RTN","MPIFAPI",73,0)
 ;
"RTN","MPIFAPI",74,0)
 N FLD,DR,DIE,DA,LOC,SCN
"RTN","MPIFAPI",75,0)
 Q:'$D(^DPT(DFN,0)) "-1^No Entry in Patient file"
"RTN","MPIFAPI",76,0)
 S DIE="^DPT(",DA=DFN,RGRSICN=""
"RTN","MPIFAPI",77,0)
 L +^DPT(DFN,"MPI"):10
"RTN","MPIFAPI",78,0)
 F FLD=991.01,991.02,991.03,991.04,991.05 D
"RTN","MPIFAPI",79,0)
 .I (FLD=991.05)&($G(@ARR@(FLD))="@") D
"RTN","MPIFAPI",80,0)
 ..S SCN=$$SUBNUM(DFN)
"RTN","MPIFAPI",81,0)
 ..S DA=SCN,DIK="^HLS(774," D ^DIK K DIK,DA
"RTN","MPIFAPI",82,0)
 ..S $P(^DPT(DFN,"MPI"),"^",5)=""
"RTN","MPIFAPI",83,0)
 ..K ^DPT("ASCN2",SCN,DFN)
"RTN","MPIFAPI",84,0)
 ..S @ARR@(FLD)=""
"RTN","MPIFAPI",85,0)
 .I $G(@ARR@(FLD))'="" S DR=FLD_"///^S X=$G(@ARR@(FLD))" D ^DIE
"RTN","MPIFAPI",86,0)
 I '$$IFLOCAL^MPIF001(DFN) S LOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFAPI",87,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIFAPI",88,0)
 K ^DPT("AMPIMIS",DFN)
"RTN","MPIFAPI",89,0)
 K RGRSICN
"RTN","MPIFAPI",90,0)
 Q 0
"RTN","MPIFAPI",91,0)
 ;
"RTN","MPIFAPI",92,0)
MPIQ(MDFN) ;
"RTN","MPIFAPI",93,0)
 ;MPI QUERY
"RTN","MPIFAPI",94,0)
 K MPIFRTN D VTQ^MPIFQ0
"RTN","MPIFAPI",95,0)
 I $G(MPIFRTN)="" D
"RTN","MPIFAPI",96,0)
 .; ^ Quit at LM screen when presented with a list of possible matches
"RTN","MPIFAPI",97,0)
 .; \/ setup Local ICN and proceed
"RTN","MPIFAPI",98,0)
 .N ICN,ERR
"RTN","MPIFAPI",99,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIFAPI",100,0)
 .Q:ICN=""!(+ICN=-1)
"RTN","MPIFAPI",101,0)
 .S ERR=$$SETICN^MPIF001(MDFN,+ICN,$P(ICN,"V",2))
"RTN","MPIFAPI",102,0)
 .S ERR=$$SETLOC^MPIF001(MDFN,1)
"RTN","MPIFAPI",103,0)
 .S ERR=$$CHANGE^MPIF001(MDFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFAPI",104,0)
 K MPIFRTN
"RTN","MPIFAPI",105,0)
 Q
"RTN","MPIFAPI",106,0)
 ;
"RTN","MPIFAPI",107,0)
MPIQQ(PDFN) ; Entry point for queueing d/c
"RTN","MPIFAPI",108,0)
 ; DFN should already exist before making this call
"RTN","MPIFAPI",109,0)
 ; Returned is -1^error message OR Task #
"RTN","MPIFAPI",110,0)
 Q:'$D(PDFN) "-1^No DFN passed"
"RTN","MPIFAPI",111,0)
 S ZTRTN="MPIQ^MPIFAPI(PDFN)"
"RTN","MPIFAPI",112,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFAPI",113,0)
 S ZTSAVE("PDFN")=PDFN
"RTN","MPIFAPI",114,0)
 S ZTSAVE("MPIFS")=1
"RTN","MPIFAPI",115,0)
 ; ^ silent flag
"RTN","MPIFAPI",116,0)
 S ZTIO=""
"RTN","MPIFAPI",117,0)
 S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFAPI",118,0)
 D ^%ZTLOAD
"RTN","MPIFAPI",119,0)
 D HOME^ZIS K IO("Q")
"RTN","MPIFAPI",120,0)
 N TSK
"RTN","MPIFAPI",121,0)
 S TSK=ZTSK
"RTN","MPIFAPI",122,0)
 K ZTSAVE,ZTRTN,ZTIO,ZTDTH,ZTSK
"RTN","MPIFAPI",123,0)
 Q TSK
"RTN","MPIFQ0")
0^2^B86202246
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-CIRN QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,14**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",5,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",6,0)
 S MPIFRES="",MPIFINT=""
"RTN","MPIFQ0",7,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",8,0)
 S DIC="^DPT(",DIC(0)="AEMQ" D ^DIC
"RTN","MPIFQ0",9,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",10,0)
 S DFN=+Y
"RTN","MPIFQ0",11,0)
 S HLP("ACKTIME")=300
"RTN","MPIFQ0",12,0)
 W !
"RTN","MPIFQ0",13,0)
CIRNEXC ; CIRN Exception Entry Point
"RTN","MPIFQ0",14,0)
 I $$SEND^RGJUSITE'>0 W !,"CIRN Messaging Parameter Not Enabled" G END
"RTN","MPIFQ0",15,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",16,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",17,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",18,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFQ0",19,0)
 S TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",20,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S TDOB=""
"RTN","MPIFQ0",21,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",22,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",23,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 W !,"Patient has Test SSN" G END
"RTN","MPIFQ0",24,0)
 S HLP("ACKTIME")=300
"RTN","MPIFQ0",25,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",26,0)
 G JUMP
"RTN","MPIFQ0",27,0)
VTQ ;
"RTN","MPIFQ0",28,0)
 G:$G(DFN)']"" END
"RTN","MPIFQ0",29,0)
 I $$SEND^RGJUSITE'>0 S MPIFRTN="STOP/SUSPEND" G END
"RTN","MPIFQ0",30,0)
 ;
"RTN","MPIFQ0",31,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",32,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",33,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFQ0",34,0)
 S TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",35,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S TDOB=""
"RTN","MPIFQ0",36,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",37,0)
 ;
"RTN","MPIFQ0",38,0)
 ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",39,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END
"RTN","MPIFQ0",40,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S MPIFRTN="TEST" G END
"RTN","MPIFQ0",41,0)
JUMP ;
"RTN","MPIFQ0",42,0)
 N TIME,%
"RTN","MPIFQ0",43,0)
 D NOW^%DTC S TIME=%
"RTN","MPIFQ0",44,0)
 ;Initialization for call to MPIVTQ
"RTN","MPIFQ0",45,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,RGDC
"RTN","MPIFQ0",46,0)
 ;If the HLP("ACKTIME") is not already set for the 
"RTN","MPIFQ0",47,0)
 I $G(HLP("ACKTIME"))="" S HLP("ACKTIME")=30
"RTN","MPIFQ0",48,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",49,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",50,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1
"RTN","MPIFQ0",51,0)
 S MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",52,0)
 ;
"RTN","MPIFQ0",53,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM,"00108.1;00108.2;00110;00122")
"RTN","MPIFQ0",54,0)
 ;If call to VTQ1^MPIFVTQ returns '-1^error code', log error and exit
"RTN","MPIFQ0",55,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",56,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0))
"RTN","MPIFQ0",57,0)
 . S MPIFRTN="CONTINUE"
"RTN","MPIFQ0",58,0)
 . I '$D(MPIFS) W !!,"Patient should NOT be sent to the MPI for ICN assignment"
"RTN","MPIFQ0",59,0)
 ;
"RTN","MPIFQ0",60,0)
 ;Create MSH
"RTN","MPIFQ0",61,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFQ0",62,0)
 S HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",63,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",64,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",65,0)
 ;
"RTN","MPIFQ0",66,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFQ0",67,0)
 I '$D(MPIFS) D
"RTN","MPIFQ0",68,0)
 .W !!,"Attempting to connect to the Master Patient Index in Austin..."
"RTN","MPIFQ0",69,0)
 .W !,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFQ0",70,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","RGDC")
"RTN","MPIFQ0",71,0)
 ;kill the HLP array set for the ack timeout
"RTN","MPIFQ0",72,0)
 K HLP("ACKTIME")
"RTN","MPIFQ0",73,0)
 ;
"RTN","MPIFQ0",74,0)
 ;Can't connect to MPI, assign a local ICN, this site as CMOR, and
"RTN","MPIFQ0",75,0)
 ;continue with Registration
"RTN","MPIFQ0",76,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",77,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",78,0)
 . I '$D(MPIFS) W !!,"Could not connect to MPI or Timed Out, assigning local ICN (if not already assigned)..."
"RTN","MPIFQ0",79,0)
 . D LOCAL(DFN)
"RTN","MPIFQ0",80,0)
 . S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",81,0)
 ;
"RTN","MPIFQ0",82,0)
 ;this is the array the data is parsed into for display in list manager
"RTN","MPIFQ0",83,0)
 K ^TMP("MPIFQ0",$J)
"RTN","MPIFQ0",84,0)
INIPARS ;
"RTN","MPIFQ0",85,0)
 N SEG,INDEX,COUNTER,LASTSSN,FIRST
"RTN","MPIFQ0",86,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFQ0",87,0)
PARSE ;
"RTN","MPIFQ0",88,0)
 S SEG=$$SEG^RGRSUTIL("RDT",1,"RDT")
"RTN","MPIFQ0",89,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFQ0",90,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,STRING,NAME,TF,ICN
"RTN","MPIFQ0",91,0)
 . N HEREICN,HERESSN,MIDDLE,IEN,F
"RTN","MPIFQ0",92,0)
 . S STRING=""
"RTN","MPIFQ0",93,0)
 . S FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2)
"RTN","MPIFQ0",94,0)
 . S MIDDLE=$P(SEG,HL("FS"),10)
"RTN","MPIFQ0",95,0)
 . S SUFF=$P(SEG,HL("FS"),11)
"RTN","MPIFQ0",96,0)
 . S (LASTSSN,SSN)=$P(SEG,HL("FS"),3)
"RTN","MPIFQ0",97,0)
 . S NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFQ0",98,0)
 . I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFQ0",99,0)
 . I SUFF'="" S NAME=NAME_" "_SUFF
"RTN","MPIFQ0",100,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFQ0",101,0)
 . I FIRST=1 S FICN=ICN
"RTN","MPIFQ0",102,0)
 . S FIRST=FIRST+1
"RTN","MPIFQ0",103,0)
 . S CMOR=$P(SEG,HL("FS"),5),CCMOR=CMOR
"RTN","MPIFQ0",104,0)
 . I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",105,0)
 . S TF=$P(SEG,HL("FS"),8),TF2=TF
"RTN","MPIFQ0",106,0)
 . I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",107,0)
 . ;
"RTN","MPIFQ0",108,0)
 . ;Same patient just adding TF's
"RTN","MPIFQ0",109,0)
 . I TF'="",ICN=FICN,FIRST'=2 D
"RTN","MPIFQ0",110,0)
 . . S SKIP="Y"
"RTN","MPIFQ0",111,0)
 . . S COUNTER=COUNTER+1
"RTN","MPIFQ0",112,0)
 . . S ^TMP("MPIFQ0",$J,INDEX,COUNTER)=TF
"RTN","MPIFQ0",113,0)
 . ;
"RTN","MPIFQ0",114,0)
 . Q:(ICN=FICN)&(FIRST>2)
"RTN","MPIFQ0",115,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFQ0",116,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFQ0",117,0)
 . I $G(BIRTHDAY)]"" D
"RTN","MPIFQ0",118,0)
 . . S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY)
"RTN","MPIFQ0",119,0)
 . . S BIRTHDAY=$$IN2EXDT^VAFCMGU0(BIRTHDAY,0)
"RTN","MPIFQ0",120,0)
 . ;
"RTN","MPIFQ0",121,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFQ0",122,0)
 . S INDEX=INDEX+1,COUNTER=1
"RTN","MPIFQ0",123,0)
 . S HEREICN=$$HEREICN($P(ICN,"V",1))
"RTN","MPIFQ0",124,0)
 . I HEREICN D
"RTN","MPIFQ0",125,0)
 . . S STRING=$$SETSTR^VALM1("*",STRING,1,1)
"RTN","MPIFQ0",126,0)
 . . S ^TMP("MPIFQ0",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",127,0)
 . S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4)
"RTN","MPIFQ0",128,0)
 . S STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",129,0)
 . S STRING=$$SETSTR^VALM1(SSN,STRING,30,9)
"RTN","MPIFQ0",130,0)
 . S STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",131,0)
 . S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",132,0)
 . S ^TMP("MPIFQ0",$J,INDEX,0)=STRING
"RTN","MPIFQ0",133,0)
 . S ^TMP("MPIFQ0",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",134,0)
 . S ^TMP("MPIFQ0",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF
"RTN","MPIFQ0",135,0)
 . S (VALMCNT,VALMLST)=INDEX
"RTN","MPIFQ0",136,0)
DECIDE ;
"RTN","MPIFQ0",137,0)
 ;I no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFQ0",138,0)
 ;with the VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",139,0)
 I '$D(^TMP("MPIFQ0",$J)) D  G EXIT
"RTN","MPIFQ0",140,0)
 . I '$D(MPIFS) W !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",141,0)
 . D A28(DFN)
"RTN","MPIFQ0",142,0)
 . S MPIFRTN="DID A28"
"RTN","MPIFQ0",143,0)
 ;
"RTN","MPIFQ0",144,0)
 ;If INDEX=1 it means we got 1 match. So we check the SSN to
"RTN","MPIFQ0",145,0)
 ;see if it's definitely the same patient.
"RTN","MPIFQ0",146,0)
 I (INDEX=1)&(TSSN=LASTSSN) D  G EXIT
"RTN","MPIFQ0",147,0)
 . N CMOR,ICN,DATA,TICN
"RTN","MPIFQ0",148,0)
 . S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ0",149,0)
 . S CMOR=CCMOR
"RTN","MPIFQ0",150,0)
 . S ICN=$P(DATA,"^",4)
"RTN","MPIFQ0",151,0)
 . D START^RGHLLOG(0)
"RTN","MPIFQ0",152,0)
 . S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",153,0)
 . I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ0",154,0)
 . I TICN>0&(DFN'=TICN)
"RTN","MPIFQ0",155,0)
 . ; CHECK IF NAME IS SAME - IF NOT POTENTIAL MATCH EXCEPTION
"RTN","MPIFQ0",156,0)
 . I $P(DATA,"^")'=LOCDATA(2,DFN,.01) D  Q
"RTN","MPIFQ0",157,0)
 ..I $D(MPIFINT) D START^MPIFQ1(INDEX) Q
"RTN","MPIFQ0",158,0)
 ..I '$D(MPIFINIT) D LOC2(DFN) Q
"RTN","MPIFQ0",159,0)
 . I '$D(MPIFS) W !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" in MPI, updating ICN and CMOR..."
"RTN","MPIFQ0",160,0)
 . D STOP^RGHLLOG(0)
"RTN","MPIFQ0",161,0)
 . D UPDATE(DFN,ICN,CMOR)
"RTN","MPIFQ0",162,0)
 . S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",163,0)
 ;
"RTN","MPIFQ0",164,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",165,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",166,0)
 .I '$D(MPIFS) W !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",167,0)
 .D START^RGHLLOG(0)
"RTN","MPIFQ0",168,0)
 .D EXC^RGHLLOG(218,"For Patient DFN="_DFN_".  Use Single Patient Initialization to MPI option to manually process.",DFN)
"RTN","MPIFQ0",169,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIFQ0",170,0)
 .D LOCAL(DFN)
"RTN","MPIFQ0",171,0)
 .S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",172,0)
 ;
"RTN","MPIFQ0",173,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",174,0)
EXIT ;
"RTN","MPIFQ0",175,0)
 I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",176,0)
 K CCMOR
"RTN","MPIFQ0",177,0)
 H 3
"RTN","MPIFQ0",178,0)
 W !!
"RTN","MPIFQ0",179,0)
END ;
"RTN","MPIFQ0",180,0)
 Q
"RTN","MPIFQ0",181,0)
A28(DFN) ;
"RTN","MPIFQ0",182,0)
 S ICN=$$GETICN^MPIFRTC(DFN)
"RTN","MPIFQ0",183,0)
 I +ICN>0 I '$D(MPIFS) W !!,"Adding Patient to Master Patient Index..." Q
"RTN","MPIFQ0",184,0)
 ;ASSIGN LOCAL ICN
"RTN","MPIFQ0",185,0)
 I '$D(MPIFS) W !!,"Could not connect to MPI, Assigning Local ICN..."
"RTN","MPIFQ0",186,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",187,0)
 Q
"RTN","MPIFQ0",188,0)
 ;
"RTN","MPIFQ0",189,0)
UPDATE(DFN,ICN,CMOR) ;
"RTN","MPIFQ0",190,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG,LOCAL
"RTN","MPIFQ0",191,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",192,0)
 S CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ0",193,0)
 S ICN=$P(ICN,"V",1)
"RTN","MPIFQ0",194,0)
 S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",195,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",196,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",197,0)
 I +SETICN'>0 D  Q
"RTN","MPIFQ0",198,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0"
"RTN","MPIFQ0",199,0)
 S SETLOC=1,LOCAL="N"
"RTN","MPIFQ0",200,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",201,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",202,0)
 I +SETLOC'>0 D  Q
"RTN","MPIFQ0",203,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0"
"RTN","MPIFQ0",204,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",205,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",206,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",207,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFQ0",208,0)
 I +CHANGE'>0 D  Q
"RTN","MPIFQ0",209,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0"
"RTN","MPIFQ0",210,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",211,0)
 N HERE
"RTN","MPIFQ0",212,0)
 S HERE=+$P($$SITE^VASITE,"^",3)
"RTN","MPIFQ0",213,0)
 I '$$PATCH^XPDUTL("DG*5.3*261") D
"RTN","MPIFQ0",214,0)
 .I CMOR=HERE D TFLIST^MPIFBT2(CMOR,DFN)
"RTN","MPIFQ0",215,0)
 .; ^ add CMOR to treating facility list
"RTN","MPIFQ0",216,0)
 .I CMOR'=HERE D TFLIST^MPIFBT2(HERE,DFN),TFUPDT^MPIFBT2(DFN,0,0),INSERT^RGJCTS01(DFN)
"RTN","MPIFQ0",217,0)
 .; ^ not CMOR add site to Treating Facility list, add pivot file treating facility message and add subscription control message to event queue.
"RTN","MPIFQ0",218,0)
 I $$PATCH^XPDUTL("DG*5.3*261") D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ0",219,0)
 Q
"RTN","MPIFQ0",220,0)
 ;
"RTN","MPIFQ0",221,0)
LOCAL(DFN) ;
"RTN","MPIFQ0",222,0)
 N ICN
"RTN","MPIFQ0",223,0)
 Q:+$$GETICN^MPIF001(DFN)>0
"RTN","MPIFQ0",224,0)
 ;don't assign local if one already exists
"RTN","MPIFQ0",225,0)
 S ICN=$$ICNLC^MPIF001(DFN)
"RTN","MPIFQ0",226,0)
 Q
"RTN","MPIFQ0",227,0)
HEREICN(ICN) ;
"RTN","MPIFQ0",228,0)
 N DFN
"RTN","MPIFQ0",229,0)
 I $G(ICN)="" Q 0
"RTN","MPIFQ0",230,0)
 S DFN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",231,0)
 Q:$G(DFN)'>0 0
"RTN","MPIFQ0",232,0)
 Q DFN
"RTN","MPIFQ0",233,0)
TEST(SSN) ;
"RTN","MPIFQ0",234,0)
 N DFN
"RTN","MPIFQ0",235,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ0",236,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ0",237,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ0",238,0)
 Q DFN
"RTN","MPIFQ0",239,0)
HERESSN(X) ;
"RTN","MPIFQ0",240,0)
 N DFN,X,Y,DIC,D
"RTN","MPIFQ0",241,0)
 I $G(X)="" Q 0
"RTN","MPIFQ0",242,0)
 S DIC="^DPT(",D="SSN",DIC(0)="X"
"RTN","MPIFQ0",243,0)
 D MIX^DIC1
"RTN","MPIFQ0",244,0)
 Q:$G(Y)=-1 0
"RTN","MPIFQ0",245,0)
 Q $P(Y,"^",1)
"RTN","MPIFQ0",246,0)
 ;
"RTN","MPIFQ0",247,0)
GETDATA(DIC,DA,ARRAY,DR,EI) ;
"RTN","MPIFQ0",248,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",249,0)
 ;DIC is the file reference
"RTN","MPIFQ0",250,0)
 ;DA is the file entry IEN
"RTN","MPIFQ0",251,0)
 ;ARRAY is the storage array for the values to be stored in
"RTN","MPIFQ0",252,0)
 ;DR are the fields requested
"RTN","MPIFQ0",253,0)
 ;EI is external/internal values of the fields or dont return null values
"RTN","MPIFQ0",254,0)
 N DIQ
"RTN","MPIFQ0",255,0)
 S DIQ=ARRAY
"RTN","MPIFQ0",256,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",257,0)
 D EN^DIQ1
"RTN","MPIFQ0",258,0)
 Q
"RTN","MPIFQ0",259,0)
LOC2(DFN) ;
"RTN","MPIFQ0",260,0)
 W !!,"Potential Match Found Assigning Local ICN"
"RTN","MPIFQ0",261,0)
 D START^RGHLLOG()
"RTN","MPIFQ0",262,0)
 D EXC^RGHLLOG(218,"For Patient DFN="_DFN_" Use Single Patient Initialization to MPI option to manually process",DFN)
"RTN","MPIFQ0",263,0)
 D STOP^RGHLLOG()
"RTN","MPIFQ0",264,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",265,0)
 Q
"VER")
8.0^22.0
**END**
**END**
