Released EAS*1*23 SEQ #21
Extracted from mail message
**KIDS**:EAS*1.0*23^

**INSTALL NAME**
EAS*1.0*23
"BLD",4188,0)
EAS*1.0*23^ENROLLMENT APPLICATION SYSTEM^0^3030310^y
"BLD",4188,1,0)
^^12^12^3030107^
"BLD",4188,1,1,0)
The software for this patch, EAS*1*23 and associated patch, IVM*2*69, are 
"BLD",4188,1,2,0)
not being distributed through the National Patch Module.  These patches 
"BLD",4188,1,3,0)
are being distributed as a single KIDS software distribution (host 
"BLD",4188,1,4,0)
file).  This patch contains the informational portion of EAS*1*23 and 
"BLD",4188,1,5,0)
provides field personnel with instructions on how to acquire, install and 
"BLD",4188,1,6,0)
implement the patch software.
"BLD",4188,1,7,0)
 
"BLD",4188,1,8,0)
The Health Eligibility Center (HEC) has reinstated the Income 
"BLD",4188,1,9,0)
Verification Matching program, which matches a veteran's self-reported 
"BLD",4188,1,10,0)
income (that is below the Means Test Threshold) with information obtained 
"BLD",4188,1,11,0)
from the Internal Revenue Service (IRS) and Social Security 
"BLD",4188,1,12,0)
Administration (SSA).  
"BLD",4188,4,0)
^9.64PA^^
"BLD",4188,"ABPKG")
n
"BLD",4188,"KRN",0)
^9.67PA^8989.52^19
"BLD",4188,"KRN",.4,0)
.4
"BLD",4188,"KRN",.401,0)
.401
"BLD",4188,"KRN",.402,0)
.402
"BLD",4188,"KRN",.403,0)
.403
"BLD",4188,"KRN",.5,0)
.5
"BLD",4188,"KRN",.84,0)
.84
"BLD",4188,"KRN",3.6,0)
3.6
"BLD",4188,"KRN",3.8,0)
3.8
"BLD",4188,"KRN",9.2,0)
9.2
"BLD",4188,"KRN",9.8,0)
9.8
"BLD",4188,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",4188,"KRN",9.8,"NM",1,0)
EASUM1^^0^B22489965
"BLD",4188,"KRN",9.8,"NM",2,0)
EASPREC2^^0^B7366625
"BLD",4188,"KRN",9.8,"NM",3,0)
EASPREC7^^0^B52679469
"BLD",4188,"KRN",9.8,"NM",4,0)
EASUFNC3^^0^B9331658
"BLD",4188,"KRN",9.8,"NM",5,0)
EASPTRN5^^0^B20478962
"BLD",4188,"KRN",9.8,"NM","B","EASPREC2",2)

"BLD",4188,"KRN",9.8,"NM","B","EASPREC7",3)

"BLD",4188,"KRN",9.8,"NM","B","EASPTRN5",5)

"BLD",4188,"KRN",9.8,"NM","B","EASUFNC3",4)

"BLD",4188,"KRN",9.8,"NM","B","EASUM1",1)

"BLD",4188,"KRN",19,0)
19
"BLD",4188,"KRN",19.1,0)
19.1
"BLD",4188,"KRN",101,0)
101
"BLD",4188,"KRN",409.61,0)
409.61
"BLD",4188,"KRN",771,0)
771
"BLD",4188,"KRN",870,0)
870
"BLD",4188,"KRN",8989.51,0)
8989.51
"BLD",4188,"KRN",8989.52,0)
8989.52
"BLD",4188,"KRN",8994,0)
8994
"BLD",4188,"KRN","B",.4,.4)

"BLD",4188,"KRN","B",.401,.401)

"BLD",4188,"KRN","B",.402,.402)

"BLD",4188,"KRN","B",.403,.403)

"BLD",4188,"KRN","B",.5,.5)

"BLD",4188,"KRN","B",.84,.84)

"BLD",4188,"KRN","B",3.6,3.6)

"BLD",4188,"KRN","B",3.8,3.8)

"BLD",4188,"KRN","B",9.2,9.2)

"BLD",4188,"KRN","B",9.8,9.8)

"BLD",4188,"KRN","B",19,19)

"BLD",4188,"KRN","B",19.1,19.1)

"BLD",4188,"KRN","B",101,101)

"BLD",4188,"KRN","B",409.61,409.61)

"BLD",4188,"KRN","B",771,771)

"BLD",4188,"KRN","B",870,870)

"BLD",4188,"KRN","B",8989.51,8989.51)

"BLD",4188,"KRN","B",8989.52,8989.52)

"BLD",4188,"KRN","B",8994,8994)

"BLD",4188,"QUES",0)
^9.62^^
"BLD",4188,"REQB",0)
^9.611^1^1
"BLD",4188,"REQB",1,0)
IB*2.0*204^1
"BLD",4188,"REQB","B","IB*2.0*204",1)

"MBREQ")
0
"PKG",552,-1)
1^1
"PKG",552,0)
ENROLLMENT APPLICATION SYSTEM^EAS^ENROLLMENT
"PKG",552,20,0)
^9.402P^1^1
"PKG",552,20,1,0)
2^^EASXDR
"PKG",552,20,1,1)
 
"PKG",552,20,"B",2,1)

"PKG",552,22,0)
^9.49I^1^1
"PKG",552,22,1,0)
1.0^3010315^3010410^66481
"PKG",552,22,1,"PAH",1,0)
23^3030310
"PKG",552,22,1,"PAH",1,1,0)
^^12^12^3030310
"PKG",552,22,1,"PAH",1,1,1,0)
The software for this patch, EAS*1*23 and associated patch, IVM*2*69, are 
"PKG",552,22,1,"PAH",1,1,2,0)
not being distributed through the National Patch Module.  These patches 
"PKG",552,22,1,"PAH",1,1,3,0)
are being distributed as a single KIDS software distribution (host 
"PKG",552,22,1,"PAH",1,1,4,0)
file).  This patch contains the informational portion of EAS*1*23 and 
"PKG",552,22,1,"PAH",1,1,5,0)
provides field personnel with instructions on how to acquire, install and 
"PKG",552,22,1,"PAH",1,1,6,0)
implement the patch software.
"PKG",552,22,1,"PAH",1,1,7,0)
 
"PKG",552,22,1,"PAH",1,1,8,0)
The Health Eligibility Center (HEC) has reinstated the Income 
"PKG",552,22,1,"PAH",1,1,9,0)
Verification Matching program, which matches a veteran's self-reported 
"PKG",552,22,1,"PAH",1,1,10,0)
income (that is below the Means Test Threshold) with information obtained 
"PKG",552,22,1,"PAH",1,1,11,0)
from the Internal Revenue Service (IRS) and Social Security 
"PKG",552,22,1,"PAH",1,1,12,0)
Administration (SSA).  
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","EASPREC2")
0^2^B7366625
"RTN","EASPREC2",1,0)
EASPREC2 ;ALB/KCL - ROUTE INCOMING HL7 (ORU) MESSAGES BY EVENT TYPE ; 11/22/02 1:56pm
"RTN","EASPREC2",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**23**; 21-OCT-94
"RTN","EASPREC2",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","EASPREC2",4,0)
 ;
"RTN","EASPREC2",5,0)
 ; This routine will process (ORU) HL7 messages received from the Edb
"RTN","EASPREC2",6,0)
 ; via e*Gate. Currently only the Z06 is being transmitted.
"RTN","EASPREC2",7,0)
 ; Event type code indicating type of transmission is in the BHS segment.
"RTN","EASPREC2",8,0)
 ; Routines based on type will be called to process these messages.  For
"RTN","EASPREC2",9,0)
 ; each batch an ACK will be sent to the Edb indicating errors found.
"RTN","EASPREC2",10,0)
 ; If any errors are found a batch message with AE(indicating error(s))
"RTN","EASPREC2",11,0)
 ; is sent.  If no errors only a MSH and MSA with AA(no errors) is sent.
"RTN","EASPREC2",12,0)
 ; The following event type codes are processed in the following 
"RTN","EASPREC2",13,0)
 ; routine(s):
"RTN","EASPREC2",14,0)
 ;
"RTN","EASPREC2",15,0)
 ;    EVENT CODE    TRANSMISSION TYPE             PROCESSING ROUTINE
"RTN","EASPREC2",16,0)
 ;    ==============================================================
"RTN","EASPREC2",17,0)
 ;       Z06        MEANS TEST TRANSMISSIONS           EASPREC7
"RTN","EASPREC2",18,0)
 ;
"RTN","EASPREC2",19,0)
 ;
"RTN","EASPREC2",20,0)
ORU ; - Receive Observational Results Unsolicited Message
"RTN","EASPREC2",21,0)
 ;
"RTN","EASPREC2",22,0)
 N DIC,%,%H,%I D NOW^%DTC S HLDT=%
"RTN","EASPREC2",23,0)
 K HLERR,IVMSEG1,IVMSEG2,IVMSEG3
"RTN","EASPREC2",24,0)
 S (HLEVN,IVMCT,IVMERROR,IVMCNTR)=0
"RTN","EASPREC2",25,0)
 ; Make sure POSTMASTER DUZ instead of DUZ of Person who
"RTN","EASPREC2",26,0)
 ; started Incoming Logical Link
"RTN","EASPREC2",27,0)
 S DUZ=.5
"RTN","EASPREC2",28,0)
 ;
"RTN","EASPREC2",29,0)
 ; - get incoming segment from HL7 (#772) file
"RTN","EASPREC2",30,0)
 N IVMRTN,SEGCNT,CNT,STATION,HLEID,HLEIDS
"RTN","EASPREC2",31,0)
 S IVMRTN="IVMPREC2" K ^TMP($J,IVMRTN),^TMP("HLA",$J),^TMP("HLS",$J)
"RTN","EASPREC2",32,0)
 F SEGCNT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","EASPREC2",33,0)
 . S CNT=0
"RTN","EASPREC2",34,0)
 . S ^TMP($J,IVMRTN,SEGCNT,CNT)=HLNODE
"RTN","EASPREC2",35,0)
 . F  S CNT=$O(HLNODE(CNT)) Q:'CNT  S ^TMP($J,IVMRTN,SEGCNT,CNT)=HLNODE(CNT)
"RTN","EASPREC2",36,0)
 ;
"RTN","EASPREC2",37,0)
 S HLDA=HLMTIEN
"RTN","EASPREC2",38,0)
 S IVMSEG=$G(^TMP($J,IVMRTN,1,0)) I IVMSEG']"" G ORUQ
"RTN","EASPREC2",39,0)
 ;
"RTN","EASPREC2",40,0)
 ; - check for BHS 
"RTN","EASPREC2",41,0)
 I $E(IVMSEG,1,3)'="BHS" G ORUQ
"RTN","EASPREC2",42,0)
 ;
"RTN","EASPREC2",43,0)
 ; - get batch control id
"RTN","EASPREC2",44,0)
 S HLFS=HL("FS")
"RTN","EASPREC2",45,0)
 S HLECH=HL("ECH")
"RTN","EASPREC2",46,0)
 S HLQ=$G(HL("HLQ")) S:HLQ="" HLQ=""""""
"RTN","EASPREC2",47,0)
 S IVMHLMID=$P(IVMSEG,HLFS,11)
"RTN","EASPREC2",48,0)
 S STATION=$P(IVMSEG,HLFS,6)
"RTN","EASPREC2",49,0)
 ;
"RTN","EASPREC2",50,0)
 ; - get event type code
"RTN","EASPREC2",51,0)
 S IVMETC=$P($P(IVMSEG,HLFS,9),$E(HLECH),3)
"RTN","EASPREC2",52,0)
 S IVMETC=$P(IVMETC,$E(HLECH,2),2)
"RTN","EASPREC2",53,0)
 S HLEID="EAS EDB ORU-"_IVMETC_" SERVER"
"RTN","EASPREC2",54,0)
 S HLEID=$O(^ORD(101,"B",HLEID,0)),HLEIDS=""
"RTN","EASPREC2",55,0)
 I HLEID]"" S HLEIDS=$O(^ORD(101,HLEID,775,"B",0))
"RTN","EASPREC2",56,0)
 ;
"RTN","EASPREC2",57,0)
 ; - process the message according to the event type code
"RTN","EASPREC2",58,0)
 S IVMDO=$S(IVMETC="Z06":"EN^EASPREC7",1:"ORUQ")
"RTN","EASPREC2",59,0)
 D @IVMDO
"RTN","EASPREC2",60,0)
 Q:IVMDO="ORUQ" 
"RTN","EASPREC2",61,0)
 ;
"RTN","EASPREC2",62,0)
 ; - if no error send ACK 'AA' message
"RTN","EASPREC2",63,0)
 S HLMTN="ACK"
"RTN","EASPREC2",64,0)
 K HLARYTYP,HLMTIENA,HLRESLTA,HLP
"RTN","EASPREC2",65,0)
 I 'IVMERROR S HLMID=IVMHLMID D ACK^IVMPREC S HLARYTYP="GM",HLMTIENA=""
"RTN","EASPREC2",66,0)
 I IVMERROR S HLARYTYP="GB",HLMTIENA=HLMTIEN  ;HLMTIEN comes from ACK^IVMPREC
"RTN","EASPREC2",67,0)
 K ^TMP("HLA",$J) M ^TMP("HLA",$J)=^TMP("HLS",$J) K ^TMP("HLS",$J)
"RTN","EASPREC2",68,0)
 D GENACK^HLMA1(HLEID,HLMTIENS,HLEIDS,HLARYTYP,1,.HLRESLTA,HLMTIENA,.HLP)
"RTN","EASPREC2",69,0)
 ;
"RTN","EASPREC2",70,0)
ORUQ ;
"RTN","EASPREC2",71,0)
 K DFN,IVMCNTR,IVMCT,IVMDA,IVMERR,IVMERROR,IVMHLMID,IVMNDE,IVMPTID
"RTN","EASPREC2",72,0)
 K IVMSEG,IVMSEG1,IVMSEG2,IVMSEG3,IVMTEXT,XMSUB
"RTN","EASPREC2",73,0)
 K HLARYTYP,HLMTIENA,HLRESLTA,HLP
"RTN","EASPREC2",74,0)
 K ^TMP($J,IVMRTN),^TMP("HLA",$J),^TMP("HLS",$J)
"RTN","EASPREC2",75,0)
 Q
"RTN","EASPREC7")
0^3^B52679469
"RTN","EASPREC7",1,0)
EASPREC7 ;ALB/SEK,RTK - ROUTINE TO PROCESS INCOMING (Z06 EVENT TYPE) HL7 MESSAGES ; 31 May 94
"RTN","EASPREC7",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**23**;21-OCT-94
"RTN","EASPREC7",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","EASPREC7",4,0)
 ;
"RTN","EASPREC7",5,0)
 ; This routine will process (validate) batch ORU Means Test(event type
"RTN","EASPREC7",6,0)
 ; Z06) HL7 messages received from the IVM center.  Format of batch:
"RTN","EASPREC7",7,0)
 ;       BHS
"RTN","EASPREC7",8,0)
 ;       {MSH
"RTN","EASPREC7",9,0)
 ;        PID
"RTN","EASPREC7",10,0)
 ;        ZIC
"RTN","EASPREC7",11,0)
 ;        ZIR
"RTN","EASPREC7",12,0)
 ;        {ZDP
"RTN","EASPREC7",13,0)
 ;         ZIC
"RTN","EASPREC7",14,0)
 ;         ZIR
"RTN","EASPREC7",15,0)
 ;        }
"RTN","EASPREC7",16,0)
 ;        ZMT
"RTN","EASPREC7",17,0)
 ;        ZIV
"RTN","EASPREC7",18,0)
 ;       }
"RTN","EASPREC7",19,0)
 ;       BTS
"RTN","EASPREC7",20,0)
 ;
"RTN","EASPREC7",21,0)
EN ; entry point to validate Means Test messages 
"RTN","EASPREC7",22,0)
 ;
"RTN","EASPREC7",23,0)
 N DEPFLG,EDB,CANCFLG,CASEFLG,SEGSTR,SEGMENTS,MISSING,ERRFLG,Z06COM
"RTN","EASPREC7",24,0)
 N IVM2,IVM3,IVM7,IVM8,IVM10,IVM12,IVM17,IVM18,IVM20,IVM25,IVM26,IVMIY
"RTN","EASPREC7",25,0)
 N IVMDA,IVMPAT,IVMMTSTS,MTFND,UPMTS,MTDATE,TYPE,EASMTDT,EASZ06
"RTN","EASPREC7",26,0)
 S SEGSTR="00000000000"      ;One byte for each segment in message
"RTN","EASPREC7",27,0)
 S SEGMENTS="BHS,MSH,PID,ZIC,ZIR,ZDP,ZIC,ZIR,ZMT,ZIV,BTS"
"RTN","EASPREC7",28,0)
 S EDB="EDB-EAS"
"RTN","EASPREC7",29,0)
 S Z06COM="Z06 MT via Edb"
"RTN","EASPREC7",30,0)
 S (CASEFLG,DEPFLG,ERRFLG,HLERR,IVMDA,IVMFLGC,MTFND,UPMTS)=0
"RTN","EASPREC7",31,0)
EN1 F  S IVMDA=$O(^TMP($J,IVMRTN,IVMDA)) Q:'IVMDA  D  I $D(HLERR) D ACK^IVMPREC S ERRFLG=1 Q 
"RTN","EASPREC7",32,0)
 .K HLERR
"RTN","EASPREC7",33,0)
 .D GET
"RTN","EASPREC7",34,0)
 .D @IVMSEG1
"RTN","EASPREC7",35,0)
 Q:ERRFLG                               ;Error detected do not continue
"RTN","EASPREC7",36,0)
 S MISSING=$F(SEGSTR,0)                 ;Ensure all required segments
"RTN","EASPREC7",37,0)
 I MISSING D  I $D(HLERR) D ACK^IVMPREC,CLEANUP Q
"RTN","EASPREC7",38,0)
 . S TYPE=$S(MISSING=3!(MISSING=4):"Veteran's",MISSING>4&(MISSING<8):"Spouse's",1:"")
"RTN","EASPREC7",39,0)
 . S HLERR="Missing "_TYPE_" "_$P(SEGMENTS,",",(MISSING-1))_" Segment"
"RTN","EASPREC7",40,0)
 D PROCESS
"RTN","EASPREC7",41,0)
 I $D(HLERR) D ACK^IVMPREC
"RTN","EASPREC7",42,0)
 ;
"RTN","EASPREC7",43,0)
 ; cleanup
"RTN","EASPREC7",44,0)
CLEANUP K DGLY,DGMTP,IVMDAP,IVMDAS,IVMDAZ,IVMDGLY,CANCFLG,IVMFLGC,IVMMT31
"RTN","EASPREC7",45,0)
 K IVMMTDT,IVMMTIEN,IVMSEG,IVMSEG1,IVMSTAT,IVMTEXT,XMSUB,HLERR,CLOSFLG
"RTN","EASPREC7",46,0)
 K IVMDAV,ZIVSEG,ZMTSEG
"RTN","EASPREC7",47,0)
 Q
"RTN","EASPREC7",48,0)
 ;
"RTN","EASPREC7",49,0)
 ;Dependent upon type of Z06 sent perform the following;
"RTN","EASPREC7",50,0)
 ;IVM Case Status:
"RTN","EASPREC7",51,0)
 ;  Value of 1 = Create/Update Z06 MT, Close Case and Mark REASON CODE 
"RTN","EASPREC7",52,0)
 ;               as 'Converted'
"RTN","EASPREC7",53,0)
 ;  Value of 0 = Cancel Z06 MT and Mark REASON CODE as 'Not Convert'
"RTN","EASPREC7",54,0)
 ;
"RTN","EASPREC7",55,0)
 ; If Z06 MT and IVM Case Status is 1 and Z06 MT does not exist Then 
"RTN","EASPREC7",56,0)
 ;   Create new Z06 MT (new Z06 MT becomes primary and existing MT
"RTN","EASPREC7",57,0)
 ;   becomes non-primary)
"RTN","EASPREC7",58,0)
 ;   Assign REASON CODE of 'Converted' in #301.5
"RTN","EASPREC7",59,0)
 ; If Z06 MT already exists Then 
"RTN","EASPREC7",60,0)
 ;   If IVM Case Status is 0 Then 
"RTN","EASPREC7",61,0)
 ;     Delete Z06 MT for income year and return old MT to primary
"RTN","EASPREC7",62,0)
 ;     Change REASON CODE from 'Converted' to 'Not Converted' in #301.5
"RTN","EASPREC7",63,0)
 ;   If IVM Case Status is 1 Then
"RTN","EASPREC7",64,0)
 ;     Update MT Z06 and Close/Convert Case
"RTN","EASPREC7",65,0)
 ; Else  (Z06 MT, IVM Case Status=0 and Z06 MT does not exist)
"RTN","EASPREC7",66,0)
 ;   Send back 'AE' to Edb indicating MT Z06 not available for 
"RTN","EASPREC7",67,0)
 ;   cancellation
"RTN","EASPREC7",68,0)
 ;
"RTN","EASPREC7",69,0)
PROCESS N DIC,%,%H,%I,IVMDATE
"RTN","EASPREC7",70,0)
 D NOW^%DTC
"RTN","EASPREC7",71,0)
 S IVMDATE=%
"RTN","EASPREC7",72,0)
 S EASZ06=0
"RTN","EASPREC7",73,0)
 I $G(IVMMTIEN)="" D
"RTN","EASPREC7",74,0)
 . S CURMT=$$LST^DGMTU(DFN)        ;Retrieve current means test on file
"RTN","EASPREC7",75,0)
 . S IVMMTIEN=$P(CURMT,"^",1)      ; for the appropriate income year
"RTN","EASPREC7",76,0)
 . S IVMMTDT=$P(CURMT,"^",2)
"RTN","EASPREC7",77,0)
 . S IVMMTSTS=$P(CURMT,"^",3)
"RTN","EASPREC7",78,0)
 I $G(IVMMTIEN)="" D  Q                         ;No Means Test in #408.31
"RTN","EASPREC7",79,0)
 . S EASZ06=1
"RTN","EASPREC7",80,0)
 . S IVMMTDT=EASMTDT
"RTN","EASPREC7",81,0)
 . D ^EASUM1                                    ;Create New Z06 MT
"RTN","EASPREC7",82,0)
 . D CLOSE^IVMPTRN1(IVMIY,DFN,1,6)              ;Close Case/Converted
"RTN","EASPREC7",83,0)
 S (IVMMT31,DGMTP)=$G(^DGMT(408.31,IVMMTIEN,0)) ;dgmtp is event driver variable
"RTN","EASPREC7",84,0)
 I 'MTFND,CASEFLG D  Q
"RTN","EASPREC7",85,0)
 . S DA=IVMMTIEN,DIE="^DGMT(408.31,",DR="2////0;"   ;Change old MT to
"RTN","EASPREC7",86,0)
 . D ^DIE K DA,DIE,DR                           ; non-primary
"RTN","EASPREC7",87,0)
 . D ^EASUM1                                    ;Create New Z06 MT
"RTN","EASPREC7",88,0)
 . D CLOSE^IVMPTRN1(IVMIY,DFN,1,6)              ;Close Case/Converted
"RTN","EASPREC7",89,0)
 I 'MTFND,'CASEFLG S HLERR="Existing Z06 MT not found" Q
"RTN","EASPREC7",90,0)
 I MTFND D
"RTN","EASPREC7",91,0)
 . I 'CASEFLG D  Q                              ;Delete means test
"RTN","EASPREC7",92,0)
 . .;Check to see if MT Z06 exists prior to trying to delete
"RTN","EASPREC7",93,0)
 . .; If NOT defined then send an AE back to Edb
"RTN","EASPREC7",94,0)
 . . I 'UPMTS D  Q                           ;Existing Z06 MT not found
"RTN","EASPREC7",95,0)
 . . . S HLERR="Existing Z06 MT not found"
"RTN","EASPREC7",96,0)
 . . I UPMTS D  Q
"RTN","EASPREC7",97,0)
 . . . N CURMT,IVMMTI,IVMDFN
"RTN","EASPREC7",98,0)
 . . . S IVMDFN=DFN                             ;Save off DFN
"RTN","EASPREC7",99,0)
 . . . D ^IVMUM7                                ;Delete Z06 MT
"RTN","EASPREC7",100,0)
 . . . S DFN=IVMDFN
"RTN","EASPREC7",101,0)
 . . . D CLOSE^IVMPTRN1(IVMIY,DFN,1,7)          ;Close Case/Not Converted
"RTN","EASPREC7",102,0)
 . I CASEFLG D                                  ;Update existing Z06 MT
"RTN","EASPREC7",103,0)
 . . I '$D(ZMTSEG) S HLERR="ZMT Segment is Missing" Q
"RTN","EASPREC7",104,0)
 . . D PARSEZMT(ZMTSEG)                         ;Retrieve ZMT Values
"RTN","EASPREC7",105,0)
 . . S DA=IVMMTIEN,DIE="^DGMT(408.31,"
"RTN","EASPREC7",106,0)
 . . S DR=".03////^S X=IVM3;.12////^S X=IVM8;.07////^S X=IVM10;.09////^S X=IVM25;.11////^S X=IVM7;.18////^S X=IVM12;.23////^S X=IVM18;.25////^S X=IVM20;2.02////^S X=IVMDATE;2.03////^S X=IVM26"
"RTN","EASPREC7",107,0)
 . . D ^DIE K DA,DIE,DR                         ;Update Current Z06 MT
"RTN","EASPREC7",108,0)
 . . D CLOSE^IVMPTRN1(IVMIY,DFN,1,6)            ;Close Case/Converted
"RTN","EASPREC7",109,0)
 Q
"RTN","EASPREC7",110,0)
 ;
"RTN","EASPREC7",111,0)
MSH S (HLMID,MSGID)=$P(IVMSEG,HLFS,10)         ;Message control id from MSH
"RTN","EASPREC7",112,0)
 Q
"RTN","EASPREC7",113,0)
PID S DFN=$P($P(IVMSEG,HLFS,4),$E(HLECH))
"RTN","EASPREC7",114,0)
 I ('DFN!(DFN'=+DFN)!('$D(^DPT(+DFN,0)))) D  Q
"RTN","EASPREC7",115,0)
 . S HLERR="Invalid DFN"
"RTN","EASPREC7",116,0)
 I $P(IVMSEG,HLFS,20)'=$P(^DPT(DFN,0),"^",9) D  Q
"RTN","EASPREC7",117,0)
 . S HLERR="Couldn't match IVM SSN with DHCP SSN"
"RTN","EASPREC7",118,0)
 S IVMDAP=IVMDA                  ;Save IVMDA for veteran PID segment
"RTN","EASPREC7",119,0)
 Q
"RTN","EASPREC7",120,0)
ZIC I 'DEPFLG S IVMDGLY=$P(IVMSEG,"^",3)           ;Income year
"RTN","EASPREC7",121,0)
 Q
"RTN","EASPREC7",122,0)
ZIR Q
"RTN","EASPREC7",123,0)
ZDP S DEPFLG=1
"RTN","EASPREC7",124,0)
 Q
"RTN","EASPREC7",125,0)
 ;Get primary means test
"RTN","EASPREC7",126,0)
 ; IVMMTDT - means test date
"RTN","EASPREC7",127,0)
 ; DGLY - income year
"RTN","EASPREC7",128,0)
 ; If Msans Test not in DHCP, don't upload IVM Means Test 
"RTN","EASPREC7",129,0)
 ;
"RTN","EASPREC7",130,0)
ZMT N IVMIEN
"RTN","EASPREC7",131,0)
 S IVMDAZ=IVMDA,ZMTSEG=IVMSEG                      ;ZMT segment ivmda
"RTN","EASPREC7",132,0)
 ;Means test date from ZMT segment
"RTN","EASPREC7",133,0)
 S (EASMTDT,IVMMTDT)=$$FMDATE^HLFNC($P(IVMSEG,HLFS,3))
"RTN","EASPREC7",134,0)
 S DGLY=$$LYR^DGMTSCU1(IVMMTDT)           ;Get means test to be updated
"RTN","EASPREC7",135,0)
 S MTDATE=-IVMMTDT
"RTN","EASPREC7",136,0)
 S IVMIEN=""
"RTN","EASPREC7",137,0)
 S MTFND=0
"RTN","EASPREC7",138,0)
 F  S IVMIEN=$O(^DGMT(408.31,"AID",1,DFN,MTDATE,IVMIEN)) Q:MTFND!(IVMIEN="")  S IVMMTIEN=IVMIEN D
"RTN","EASPREC7",139,0)
 . ; match to MT Z06 from Edb
"RTN","EASPREC7",140,0)
 . I $P($G(^DGMT(408.31,IVMIEN,0)),"^",3)=6 D    ;Previous Converted?
"RTN","EASPREC7",141,0)
 . . S UPMTS=IVMIEN
"RTN","EASPREC7",142,0)
 . . S MTFND=1
"RTN","EASPREC7",143,0)
 Q
"RTN","EASPREC7",144,0)
ZIV S IVMDAV=IVMDA,ZIVSEG=IVMSEG
"RTN","EASPREC7",145,0)
 S IVMIY=$P(IVMSEG,HLFS,3)
"RTN","EASPREC7",146,0)
 S IVMIY=$$FMDATE^HLFNC(IVMIY)
"RTN","EASPREC7",147,0)
 I $E(IVMIY,4,7)'="0000"!($E(IVMIY,1,3)<292) D  Q
"RTN","EASPREC7",148,0)
 . S HLERR="Invalid Income Year"
"RTN","EASPREC7",149,0)
 I "01"'[$P(IVMSEG,HLFS,9) D  Q
"RTN","EASPREC7",150,0)
 . S HLERR="Case Status not 0 or 1"
"RTN","EASPREC7",151,0)
 I $P(IVMSEG,HLFS,9)=1 S CASEFLG=1         ;Close/Convert Case Flag
"RTN","EASPREC7",152,0)
 I $P(IVMSEG,HLFS,9)=0 S CASEFLG=0         ;Delete/Not Converted MT Flag
"RTN","EASPREC7",153,0)
BHS Q
"RTN","EASPREC7",154,0)
BTS Q
"RTN","EASPREC7",155,0)
 ;
"RTN","EASPREC7",156,0)
GET ; get HL7 segment from ^TMP
"RTN","EASPREC7",157,0)
 ;S IVMDA=$O(^TMP($J,IVMRTN,+IVMDA))
"RTN","EASPREC7",158,0)
 S IVMSEG=$G(^TMP($J,IVMRTN,+IVMDA,0))
"RTN","EASPREC7",159,0)
 S IVMSEG1=$E(IVMSEG,1,3)
"RTN","EASPREC7",160,0)
 S $E(SEGSTR,IVMDA)=1
"RTN","EASPREC7",161,0)
 Q
"RTN","EASPREC7",162,0)
 ;
"RTN","EASPREC7",163,0)
 ;Parse ZMT Segment for MT Data
"RTN","EASPREC7",164,0)
 ;
"RTN","EASPREC7",165,0)
PARSEZMT(ZSEG) S IVM2=$$FMDATE^HLFNC($P(ZMTSEG,"^",3))  ;Means Test Date
"RTN","EASPREC7",166,0)
 S IVM3=$O(^DG(408.32,"C",$P(ZMTSEG,"^",4),""))   ;Means Test Status 
"RTN","EASPREC7",167,0)
 S IVM7=$S($P(ZMTSEG,"^",8)="Y":1,1:0)            ;Agrees To Deductible
"RTN","EASPREC7",168,0)
 S IVM8=$P(ZMTSEG,"^",9)                          ;Threshold A
"RTN","EASPREC7",169,0)
 S IVM10=$$FMDATE^HLFNC($P(ZMTSEG,"^",11))        ;Date/Time Completed
"RTN","EASPREC7",170,0)
 S IVM12=$P(ZMTSEG,"^",13)                        ;Number of Dependents
"RTN","EASPREC7",171,0)
 S IVM17=$P(ZMTSEG,"^",18)                        ;Type of Test
"RTN","EASPREC7",172,0)
 S IVM18=$P(ZMTSEG,"^",19)                        ;Source of Test
"RTN","EASPREC7",173,0)
 S IVM20=$$FMDATE^HLFNC($P(ZMTSEG,"^",21))        ;IVM Verified MT
"RTN","EASPREC7",174,0)
 S IVM25=$$FMDATE^HLFNC($P(ZMTSEG,"^",26))        ;D/T Last Changed
"RTN","EASPREC7",175,0)
 S IVM26=$O(^DG(408.32,"C",$P(ZMTSEG,"^",27),"")) ;Test Determined Status
"RTN","EASPREC7",176,0)
 Q
"RTN","EASPREC7",177,0)
 ;
"RTN","EASPREC7",178,0)
ERRBULL ; build mail message for transmission to IVM mail group notifying site
"RTN","EASPREC7",179,0)
 ; of upload error.
"RTN","EASPREC7",180,0)
 S IVMPAT=$$PT^IVMUFNC4(DFN)
"RTN","EASPREC7",181,0)
 S XMSUB="IVM - MEANS TEST UPLOAD"
"RTN","EASPREC7",182,0)
 S IVMTEXT(1)="The following error occured when an Income Verification Match"
"RTN","EASPREC7",183,0)
 S IVMTEXT(2)="verified Means Test was being uploaded for the following patient:"
"RTN","EASPREC7",184,0)
 S IVMTEXT(3)=" "
"RTN","EASPREC7",185,0)
 S IVMTEXT(4)="    NAME:     "_$P(IVMPAT,"^")
"RTN","EASPREC7",186,0)
 S IVMTEXT(5)="    ID:       "_$P(IVMPAT,"^",2)
"RTN","EASPREC7",187,0)
 S IVMTEXT(6)="    ERROR:    "_IVMTEXT(6)
"RTN","EASPREC7",188,0)
 Q
"RTN","EASPTRN5")
0^5^B20478962
"RTN","EASPTRN5",1,0)
EASPTRN5 ;ALB/CPM - NIGHTLY BILLING TRANSMISSION PROCESSING ; 10/30/01 9:58am
"RTN","EASPTRN5",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**23**; 21-OCT-94
"RTN","EASPTRN5",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","EASPTRN5",4,0)
 ;
"RTN","EASPTRN5",5,0)
 ; For Edb Transmission Only - VAMC-to-Edb
"RTN","EASPTRN5",6,0)
 ;
"RTN","EASPTRN5",7,0)
EN ; This routine performs the nightly compilation and transmission
"RTN","EASPTRN5",8,0)
 ; of DHCP billing activity for IVM patients to the IVM Center.
"RTN","EASPTRN5",9,0)
 ;
"RTN","EASPTRN5",10,0)
 K ^TMP("IVMPTRN5",$J)
"RTN","EASPTRN5",11,0)
 D IVMPT ;                                get data for IVM patients
"RTN","EASPTRN5",12,0)
 D INS^IBAMTV4("^TMP(""IVMPTRN5"",$J)") ; get data for Insurance patients
"RTN","EASPTRN5",13,0)
 D UPDATE^IVMPTRN6 ;                      update file #301.61
"RTN","EASPTRN5",14,0)
 D TRNSMT ;                               post transmissions
"RTN","EASPTRN5",15,0)
 Q
"RTN","EASPTRN5",16,0)
 ;
"RTN","EASPTRN5",17,0)
 ;
"RTN","EASPTRN5",18,0)
IVMPT ; Get claims and patient charges for IVM patients
"RTN","EASPTRN5",19,0)
 N DFN,IVMSTART,IVMEND
"RTN","EASPTRN5",20,0)
 S DFN=0 F  S DFN=$O(^IVM(301.61,"C",DFN)) Q:'DFN  D
"RTN","EASPTRN5",21,0)
 .S IVMSTART=$$INIT(DFN) S:'IVMSTART IVMEND=0
"RTN","EASPTRN5",22,0)
 .I IVMSTART S IVMEND=$$FMADD^XLFDT(IVMSTART,364) S:IVMEND>DT IVMEND=DT
"RTN","EASPTRN5",23,0)
 .D ALL^IBAMTV4(DFN,"^TMP(""IVMPTRN5"",$J)",IVMSTART,IVMEND)
"RTN","EASPTRN5",24,0)
 Q
"RTN","EASPTRN5",25,0)
 ;
"RTN","EASPTRN5",26,0)
 ;
"RTN","EASPTRN5",27,0)
TRNSMT ; Transmit required billing activity.
"RTN","EASPTRN5",28,0)
 Q:'$D(^IVM(301.61,"ATR"))
"RTN","EASPTRN5",29,0)
 ; =============
"RTN","EASPTRN5",30,0)
 S HLEID="EAS EDB ORU-Z09 SERVER"
"RTN","EASPTRN5",31,0)
 S HLEID=$O(^ORD(101,"B",HLEID,0))
"RTN","EASPTRN5",32,0)
 D INIT^IVMUFNC(HLEID,.HL) S HLMTN="ORU"
"RTN","EASPTRN5",33,0)
 S NUMS=""
"RTN","EASPTRN5",34,0)
 F I=1:1:30 S NUMS=NUMS_$S(NUMS'="":",",1:"")_I
"RTN","EASPTRN5",35,0)
 S DFN=0 F  S DFN=$O(^IVM(301.61,"ATR",DFN)) Q:'DFN  D
"RTN","EASPTRN5",36,0)
 .I IVMCT=0,$G(IVMGTOT) D FILE^HLTF
"RTN","EASPTRN5",37,0)
 .S HLEVN=HLEVN+1
"RTN","EASPTRN5",38,0)
 .; ==========
"RTN","EASPTRN5",39,0)
 .; Find a slot for each batch
"RTN","EASPTRN5",40,0)
 .I HLEVN#100=1 D
"RTN","EASPTRN5",41,0)
 ..K HLDT,HLDT1,HLMID,MTIEN
"RTN","EASPTRN5",42,0)
 ..D CREATE^HLTF(.HLMID,.MTIEN,.HLDT,.HLDT1)
"RTN","EASPTRN5",43,0)
 .; ==========
"RTN","EASPTRN5",44,0)
 .;
"RTN","EASPTRN5",45,0)
 .; Setup MSH Segment
"RTN","EASPTRN5",46,0)
 .S MID=HLMID_"-"_HLEVN
"RTN","EASPTRN5",47,0)
 .D MSH^HLFNC2(.HL,MID,.RESULT)
"RTN","EASPTRN5",48,0)
 .S IVMCT=IVMCT+1,^TMP("HLS",$J,IVMCT)=RESULT
"RTN","EASPTRN5",49,0)
 .;
"RTN","EASPTRN5",50,0)
 .; - re-set msg control id into MSH segment
"RTN","EASPTRN5",51,0)
 .D MSGID^IVMUFNC4(.IVMCT)
"RTN","EASPTRN5",52,0)
 .;
"RTN","EASPTRN5",53,0)
 .; - create PID segment
"RTN","EASPTRN5",54,0)
 .K IVMPID,VAFPID
"RTN","EASPTRN5",55,0)
 .S IVMPID=$$EN^VAFCPID(DFN,"1,2,3,4,5,7,8,19")
"RTN","EASPTRN5",56,0)
 .I $D(VAFPID(1)) S IVMPID(1)=VAFPID(1)
"RTN","EASPTRN5",57,0)
 .;I $P(IVMPID_$G(IVMPID(1)),HLFS,20)["P" D PSEUDO^IVMPTRN1
"RTN","EASPTRN5",58,0)
 .S IVMCT=IVMCT+1,^TMP("HLS",$J,IVMCT)=IVMPID
"RTN","EASPTRN5",59,0)
 .I $D(IVMPID(1)) S IVMCT=IVMCT+1,^TMP("HLS",$J,IVMCT)=IVMPID(1)
"RTN","EASPTRN5",60,0)
 .;
"RTN","EASPTRN5",61,0)
 .; - create PD1 segment - Patient CMOR segment <<<<<<<<<<<<<<<<<
"RTN","EASPTRN5",62,0)
 .;S IVMCT=IVMCT+1,^TMP("HLS",$J,IVMCT)=$$EN^VAFHLPD1(DFN,"1,2,3,4")
"RTN","EASPTRN5",63,0)
 .S IVMCT=IVMCT+1,^TMP("HLS",$J,IVMCT)=$$EN^VAFHLPD1(DFN,"1,3")
"RTN","EASPTRN5",64,0)
 .;
"RTN","EASPTRN5",65,0)
 .; - find the patient's Means Test date and create ZIC segment
"RTN","EASPTRN5",66,0)
 .S IVMTDA=$O(^IVM(301.61,"ATR",DFN,0))
"RTN","EASPTRN5",67,0)
 .S IVMMTDT=$S(IVMTDA:$P($G(^IVM(301.61,IVMTDA,0)),"^",5),1:DT)
"RTN","EASPTRN5",68,0)
 .D ALL^DGMTU21(DFN,"V",IVMMTDT,"IPR",+$$LST^DGMTU(DFN,IVMMTDT))
"RTN","EASPTRN5",69,0)
 .S IVMHZIC=$$EN^VAFHLZIC(+$G(DGINC("V")),"1,2")
"RTN","EASPTRN5",70,0)
 .;S IVMHZIC=$$EN^VAFHLZIC(+$G(DGINC("V")),$P(NUMS,",",1,23))
"RTN","EASPTRN5",71,0)
 .I '$P(IVMHZIC,"^",3) S $P(IVMHZIC,"^",3)=$$HLDATE^HLFNC($O(^IVM(301.5,"APT",DFN,0)))
"RTN","EASPTRN5",72,0)
 .;
"RTN","EASPTRN5",73,0)
 .; - find all transactions for the patient and create FT1 segments
"RTN","EASPTRN5",74,0)
 .S IVMTDA=0 F  S IVMTDA=$O(^IVM(301.61,"ATR",DFN,IVMTDA)) Q:'IVMTDA  D
"RTN","EASPTRN5",75,0)
 ..S IVMCT=IVMCT+1,^TMP("HLS",$J,IVMCT)=$$FT1^EASUFNC3(IVMTDA)
"RTN","EASPTRN5",76,0)
 ..S IVMN=$G(^IVM(301.61,IVMTDA,0))
"RTN","EASPTRN5",77,0)
 ..;
"RTN","EASPTRN5",78,0)
 ..; - if a payment has been made (or if the bill is closed),
"RTN","EASPTRN5",79,0)
 ..; - but the bill has never been transmitted, re-transmit.
"RTN","EASPTRN5",80,0)
 ..I ($P(IVMN,"^",9)!($P(IVMN,"^",10))),'$P(IVMN,"^",13) D
"RTN","EASPTRN5",81,0)
 ...D NOW^%DTC S DA=IVMTDA,DIE="^IVM(301.61,",DR=".13////"_% D ^DIE
"RTN","EASPTRN5",82,0)
 ...S IVMCT=IVMCT+1,^TMP("HLS",$J,IVMCT)=$$FT1^EASUFNC3(IVMTDA)
"RTN","EASPTRN5",83,0)
 ..;
"RTN","EASPTRN5",84,0)
 ..; - update transmission record
"RTN","EASPTRN5",85,0)
 ..;D:ISITESW'["H"
"RTN","EASPTRN5",86,0)
 ..S IVMSTOP=0
"RTN","EASPTRN5",87,0)
 ..I $P(IVMN,"^",10)!$P(IVMN,"^",11) S IVMSTOP=1
"RTN","EASPTRN5",88,0)
 ..I $P(IVMN,"^",4)>1 S IVMSTOP=1
"RTN","EASPTRN5",89,0)
 ..D NOW^%DTC S DR=".12////0;.13////"_%
"RTN","EASPTRN5",90,0)
 ..I IVMSTOP S DR=DR_";.14////1"
"RTN","EASPTRN5",91,0)
 ..S DR=DR_";1.03////"_%_";1.04////"_DUZ
"RTN","EASPTRN5",92,0)
 ..S DA=IVMTDA,DIE="^IVM(301.61," D ^DIE K DA,DR,DIE
"RTN","EASPTRN5",93,0)
 .;
"RTN","EASPTRN5",94,0)
 .; - set ZIC segment
"RTN","EASPTRN5",95,0)
 .S IVMCT=IVMCT+1,^TMP("HLS",$J,IVMCT)=IVMHZIC
"RTN","EASPTRN5",96,0)
 .;
"RTN","EASPTRN5",97,0)
 .S IVMEVENT="Z09"
"RTN","EASPTRN5",98,0)
 .I HLEVN'<100 D FILE^IVMPTRN3
"RTN","EASPTRN5",99,0)
 ;
"RTN","EASPTRN5",100,0)
 D FILE^IVMPTRN3
"RTN","EASPTRN5",101,0)
 K DFN,IVMPID,IVMTDA,IVMMTDT,IVMN,IVMSTOP,IVMEVENT,IVMHZIC,VAFPID,DGREL,DGINC,DGINR,DGDEP
"RTN","EASPTRN5",102,0)
 D CLEAN^IVMUFNC
"RTN","EASPTRN5",103,0)
 Q
"RTN","EASPTRN5",104,0)
 ;
"RTN","EASPTRN5",105,0)
 ;
"RTN","EASPTRN5",106,0)
INIT(DFN) ; Find the initial date for which to return patient charges.
"RTN","EASPTRN5",107,0)
 ;  Input:   DFN  --  Pointer to the patient in file #2
"RTN","EASPTRN5",108,0)
 ; Output:   Date patient became Cat C, or null (for ins. patients)
"RTN","EASPTRN5",109,0)
 ;
"RTN","EASPTRN5",110,0)
 N IVMDATE,X,Y S IVMDATE=0
"RTN","EASPTRN5",111,0)
 I '$G(DFN) G INITQ
"RTN","EASPTRN5",112,0)
 S X=0 F  S X=$O(^IVM(301.61,"C",DFN,X)) Q:'X  S Y=$G(^IVM(301.61,X,0)) I $P(Y,"^",4)>1,$P(Y,"^",5) S IVMDATE=$P(Y,"^",5) Q
"RTN","EASPTRN5",113,0)
 I IVMDATE S IVMDATE=$P($$LST^DGMTU(DFN,IVMDATE),"^",2)
"RTN","EASPTRN5",114,0)
INITQ Q IVMDATE
"RTN","EASUFNC3")
0^4^B9331658
"RTN","EASUFNC3",1,0)
EASUFNC3 ;ALB/CPM/EJG - BILLING TRANSMISSION UTILITIES ; 13-JUN-94
"RTN","EASUFNC3",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**23**; 21-OCT-94
"RTN","EASUFNC3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","EASUFNC3",4,0)
 ;
"RTN","EASUFNC3",5,0)
 ;IVM Project Interface w/Edb
"RTN","EASUFNC3",6,0)
 ;
"RTN","EASUFNC3",7,0)
REV(IVMREF,DFN,IVMCL,IVMTYP,IVMBF,IVMBT,IVMAB,IVMHLD) ; Interface w/ Rev fct.
"RTN","EASUFNC3",8,0)
 ;  Input:   IVMREF  --  Bill reference number
"RTN","EASUFNC3",9,0)
 ;              DFN  --  Pointer to the patient in file #2
"RTN","EASUFNC3",10,0)
 ;            IVMCL  --  Bill Classification [ 1-Inpt, 2-Opt ]
"RTN","EASUFNC3",11,0)
 ;           IVMTYP  --  Bill Type [ 2-Copayment, 3-Per Diem ]
"RTN","EASUFNC3",12,0)
 ;            IVMBF  --  Bill From Date in FM format
"RTN","EASUFNC3",13,0)
 ;            IVMBT  --  Bill To Date in FM format
"RTN","EASUFNC3",14,0)
 ;            IVMAB  --  Amount Billed
"RTN","EASUFNC3",15,0)
 ;           IVMHLD  --  Charge placed on hold? [ 1-Yes, 0-No ]
"RTN","EASUFNC3",16,0)
 ;
"RTN","EASUFNC3",17,0)
 ; Output:   New entry created in file #301.61
"RTN","EASUFNC3",18,0)
 ;
"RTN","EASUFNC3",19,0)
 N IVMTDA,DA,DIK
"RTN","EASUFNC3",20,0)
 I $G(IVMREF)=""!'$G(DFN) G REVQ
"RTN","EASUFNC3",21,0)
 S IVMTDA=$O(^IVM(301.61,"B",IVMREF,0))
"RTN","EASUFNC3",22,0)
 I 'IVMTDA S IVMTDA=$$ADD(IVMREF) I 'IVMTDA G REVQ
"RTN","EASUFNC3",23,0)
 ;
"RTN","EASUFNC3",24,0)
 D NOW^%DTC
"RTN","EASUFNC3",25,0)
 S $P(^IVM(301.61,IVMTDA,0),"^",2,12)=DFN_"^"_IVMCL_"^"_IVMTYP_"^"_IVMBF_"^"_IVMBT_"^"_$S($G(IVMHLD):"",1:DT)_"^"_IVMAB_"^^^^"_$S($G(IVMHLD):0,1:1),$P(^(1),"^",3,4)=%_"^"_DUZ
"RTN","EASUFNC3",26,0)
 S DA=IVMTDA,DIK="^IVM(301.61," D IX1^DIK
"RTN","EASUFNC3",27,0)
REVQ Q
"RTN","EASUFNC3",28,0)
 ;
"RTN","EASUFNC3",29,0)
ADD(X) ; Add a new entry to file #301.61
"RTN","EASUFNC3",30,0)
 ;  Input:     X  --  Reference number to be used as the .01 field
"RTN","EASUFNC3",31,0)
 ;  Output:  IVM  --  Internal entry number to new entry, or 0.
"RTN","EASUFNC3",32,0)
 ;
"RTN","EASUFNC3",33,0)
 N DA,DD,DO,DIE,DIC,DLAYGO,IVM,Y
"RTN","EASUFNC3",34,0)
 I $G(X)="" S IVM=0 G ADDQ
"RTN","EASUFNC3",35,0)
 S DIC="^IVM(301.61,",DIC(0)="L",DLAYGO=301.61 D FILE^DICN
"RTN","EASUFNC3",36,0)
 S (DA,IVM)=+Y I DA<0 S IVM=0 G ADDQ
"RTN","EASUFNC3",37,0)
 ;
"RTN","EASUFNC3",38,0)
 D NOW^%DTC
"RTN","EASUFNC3",39,0)
 S DIE=DIC,DR="1.01////"_%_";1.02////"_DUZ D ^DIE
"RTN","EASUFNC3",40,0)
ADDQ Q IVM
"RTN","EASUFNC3",41,0)
 ;
"RTN","EASUFNC3",42,0)
 ;
"RTN","EASUFNC3",43,0)
CHK(DFN) ; Is the insurance patient recorded in file #301.61?
"RTN","EASUFNC3",44,0)
 ;  Input:   DFN  --  Pointer to the patient in file #2
"RTN","EASUFNC3",45,0)
 ; Output:     1  --  Patient recorded in #301.61; otherwise, 0
"RTN","EASUFNC3",46,0)
 ;
"RTN","EASUFNC3",47,0)
 Q $O(^IVM(301.61,"C",+$G(DFN),0))>0
"RTN","EASUFNC3",48,0)
 ;
"RTN","EASUFNC3",49,0)
 ;
"RTN","EASUFNC3",50,0)
FT1(IVMTDA) ; Entry point to build FT1 segment from file #301.61
"RTN","EASUFNC3",51,0)
 ;  Input:  IVMTDA  --  Pointer to the transmission record in #301.61
"RTN","EASUFNC3",52,0)
 ;          The HL7 variables HLFS, HLQ and HLECH must also be defined
"RTN","EASUFNC3",53,0)
 ; Output:  String in the form of the HL7 FT1 segment
"RTN","EASUFNC3",54,0)
 ;
"RTN","EASUFNC3",55,0)
 N IVMN,IVMY,IVMSEP
"RTN","EASUFNC3",56,0)
 I '$G(IVMTDA) G FT1Q
"RTN","EASUFNC3",57,0)
 S IVMN=$G(^IVM(301.61,IVMTDA,0)) I IVMN="" G FT1Q
"RTN","EASUFNC3",58,0)
 S IVMSEP=$E(HLECH)
"RTN","EASUFNC3",59,0)
 ;
"RTN","EASUFNC3",60,0)
 S $P(IVMY,HLFS,1)=1 ; set id
"RTN","EASUFNC3",61,0)
 S $P(IVMY,HLFS,4)=$S($P(IVMN,"^",7):$$HLDATE^HLFNC($P(IVMN,"^",7)),1:HLQ) ; date generated
"RTN","EASUFNC3",62,0)
 S $P(IVMY,HLFS,6)=$S($P(IVMN,"^",11):2,$P(IVMN,"^",10)&$P(IVMN,"^",13):4,$P(IVMN,"^",9)&$P(IVMN,"^",13):3,1:1) ; transaction type
"RTN","EASUFNC3",63,0)
 S $P(IVMY,HLFS,7)=$P(IVMN,"^") ; transaction code
"RTN","EASUFNC3",64,0)
 ;
"RTN","EASUFNC3",65,0)
 ; - build extended transaction description
"RTN","EASUFNC3",66,0)
 S $P(IVMY,HLFS,9)=$P(IVMN,"^",3)_IVMSEP_$P(IVMN,"^",4)_IVMSEP_$S($P(IVMN,"^",5):$$HLDATE^HLFNC($P(IVMN,"^",5)),1:HLQ)_IVMSEP_$S($P(IVMN,"^",6):$$HLDATE^HLFNC($P(IVMN,"^",6)),1:HLQ)
"RTN","EASUFNC3",67,0)
 ;
"RTN","EASUFNC3",68,0)
 ; - build extended transaction amount
"RTN","EASUFNC3",69,0)
 S $P(IVMY,HLFS,11)=$S($P(IVMN,"^",10)&$P(IVMN,"^",13):+$P(IVMN,"^",9),$P(IVMN,"^",9)&$P(IVMN,"^",13):$P(IVMN,"^",9),1:"")    ;Amount Collected
"RTN","EASUFNC3",70,0)
 S $P(IVMY,HLFS,12)=$P(IVMN,"^",8)              ;Amount Billed
"RTN","EASUFNC3",71,0)
 ;
"RTN","EASUFNC3",72,0)
FT1Q Q "FT1"_HLFS_$G(IVMY)
"RTN","EASUM1")
0^1^B22489965
"RTN","EASUM1",1,0)
EASUM1 ;ALB/SEK - MEANS TEST UPLOAD DRIVER ; 3/6/01 5:13pm
"RTN","EASUM1",2,0)
 ;;1.0;ENROLLMENT APPLICATION SYSTEM;**23**;21-OCT-94
"RTN","EASUM1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","EASUM1",4,0)
 ;
"RTN","EASUM1",5,0)
EN ; this routine will call routines to upload means tests sent by the IVM
"RTN","EASUM1",6,0)
 ; Center in HL7 segments.  the required sequence of these segments were
"RTN","EASUM1",7,0)
 ; validated in the calling routine IVMPREC7.  this routine will call
"RTN","EASUM1",8,0)
 ; IVMUCHK to ensure that the data is consistent with DHCP means test
"RTN","EASUM1",9,0)
 ; file and software requirements.
"RTN","EASUM1",10,0)
 ;
"RTN","EASUM1",11,0)
 ; entries will be added/modified in the following means test and
"RTN","EASUM1",12,0)
 ; patient files:
"RTN","EASUM1",13,0)
 ;
"RTN","EASUM1",14,0)
 ;       PATIENT RELATION (#408.12)
"RTN","EASUM1",15,0)
 ;       INCOME PERSON (#408.13)
"RTN","EASUM1",16,0)
 ;       INDIVIDUAL ANNUAL INCOME (#408.21)
"RTN","EASUM1",17,0)
 ;       INCOME RELATION (#408.22)
"RTN","EASUM1",18,0)
 ;       ANNUAL MEANS TEST (#408.31)
"RTN","EASUM1",19,0)
 ;       MEANS TEST CHANGES (#408.41)
"RTN","EASUM1",20,0)
 ;       PATIENT (#2)
"RTN","EASUM1",21,0)
 ;
"RTN","EASUM1",22,0)
 ; current year is date of means test.
"RTN","EASUM1",23,0)
 ; income year is calendar year before date of means test.
"RTN","EASUM1",24,0)
 ; meant test status is based on income year data.
"RTN","EASUM1",25,0)
 ;
"RTN","EASUM1",26,0)
 ; IVMDAP is pointer to the PID HL7 segment in file #772
"RTN","EASUM1",27,0)
 ; IVMDAZ is pointer to the ZMT segment
"RTN","EASUM1",28,0)
 ;
"RTN","EASUM1",29,0)
 S:'$D(DUZ) DUZ=.5 ; if no DUZ set to postmaster
"RTN","EASUM1",30,0)
 ;
"RTN","EASUM1",31,0)
 ; get copay exemption status (IVMCEB) and means test status (IVMMTB)
"RTN","EASUM1",32,0)
 ; before upload
"RTN","EASUM1",33,0)
 S IVMCEB=$P($$RXST^IBARXEU(DFN),"^",2)
"RTN","EASUM1",34,0)
 S IVMMTB=$P($$LST^DGMTU(DFN),"^",3)
"RTN","EASUM1",35,0)
 ;
"RTN","EASUM1",36,0)
 ; subscript of array IVMAR is ien of 408.12 transmitted by IVM Center
"RTN","EASUM1",37,0)
 ; or created by upload.
"RTN","EASUM1",38,0)
 ;K IVMAR
"RTN","EASUM1",39,0)
 ;S IVMX=$$EN^IVMUCHK() I IVMX]"" S HLERR=IVMX K IVMX Q  ; error found in MT data
"RTN","EASUM1",40,0)
 ;
"RTN","EASUM1",41,0)
ADD ; add new annual means test file (408.31) stub
"RTN","EASUM1",42,0)
 ; input   DGMTDT (.01) dt of test
"RTN","EASUM1",43,0)
 ;         DFN (.02) Patient IEN
"RTN","EASUM1",44,0)
 ;         DGMTYPT (.19) type of test (1-means test)
"RTN","EASUM1",45,0)
 ; output  DGMTI annual means test IEN
"RTN","EASUM1",46,0)
 S DGMTDT=IVMMTDT,DGMTYPT=1
"RTN","EASUM1",47,0)
 D ADD^DGMTA
"RTN","EASUM1",48,0)
 I $G(IVMMTIEN)="" S IVMMTIEN=+Y    ;Set IEN if only MT on file is Z06 MT
"RTN","EASUM1",49,0)
 ;
"RTN","EASUM1",50,0)
 ;Create new Z06 IVM Means Test
"RTN","EASUM1",51,0)
 ; Make STUB MT primary, add comment that it was created by Edb
"RTN","EASUM1",52,0)
 S DGCOM="Z06 MT via Edb"
"RTN","EASUM1",53,0)
 D PARSEZMT^EASPREC7(ZMTSEG)              ;Parse ZMT Segment for MT Data
"RTN","EASUM1",54,0)
 S DA=DGMTI,DIE="^DGMT(408.31,"
"RTN","EASUM1",55,0)
 S DR=".03////^S X=IVM3;.12////^S X=IVM8;.07////^S X=IVM10;.09////^S X=IVM25;.11////^S X=IVM7;.18////^S X=IVM12;.23////^S X=IVM18;.25////^S X=IVM20;2////1;2.02////^S X=IVMDATE;2.03////^S X=IVM26;50///^S X=DGCOM"
"RTN","EASUM1",56,0)
 D ^DIE K DA,DIE,DR
"RTN","EASUM1",57,0)
 ;
"RTN","EASUM1",58,0)
 ;Variables needed for Bulletins
"RTN","EASUM1",59,0)
 ;
"RTN","EASUM1",60,0)
 I '$D(DGCAT) S DGCAT="C"
"RTN","EASUM1",61,0)
 I '$D(IVM5) S IVM5=""
"RTN","EASUM1",62,0)
 ;
"RTN","EASUM1",63,0)
 D GETREL^DGMTU11(DFN,"V",DGLY,IVMMTIEN)
"RTN","EASUM1",64,0)
 I EASZ06 S (IVMMT31,DGMTP)=$G(^DGMT(408.31,IVMMTIEN,0)) ;dgmtp is event driver variable
"RTN","EASUM1",65,0)
 D COMPLETE
"RTN","EASUM1",66,0)
 Q
"RTN","EASUM1",67,0)
 ;
"RTN","EASUM1",68,0)
 ; add dependent(s) to income person file (408.13)
"RTN","EASUM1",69,0)
 ;
"RTN","EASUM1",70,0)
 ; add spouse if not in 408.13
"RTN","EASUM1",71,0)
 S IVMSPCHV="S" ; spouse/child/vet indicator
"RTN","EASUM1",72,0)
 S IVMDA1=IVMDAP+3 D GET ; spouse ZDP segment
"RTN","EASUM1",73,0)
 D INPIEN^IVMUM2
"RTN","EASUM1",74,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",75,0)
 ;
"RTN","EASUM1",76,0)
 I IVMFLG5 G ADDCHILD ; entry not added - goto add children
"RTN","EASUM1",77,0)
 ;
"RTN","EASUM1",78,0)
 ; add entry to patient relation file (408.12)
"RTN","EASUM1",79,0)
 D EN^IVMUM3
"RTN","EASUM1",80,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",81,0)
 ;
"RTN","EASUM1",82,0)
ADDS21 ; add spouse entry to individual annual income file (408.21)
"RTN","EASUM1",83,0)
 S IVMDA1=IVMDAP+4 D GET ; spouse ZIC segment
"RTN","EASUM1",84,0)
 D EN^IVMUM4
"RTN","EASUM1",85,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",86,0)
 ;
"RTN","EASUM1",87,0)
 ; add spouse entry to income relation file (408.22)
"RTN","EASUM1",88,0)
 S IVMDA1=IVMDAP+5 D GET ; spouse ZIR segment
"RTN","EASUM1",89,0)
 D EN^IVMUM5
"RTN","EASUM1",90,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",91,0)
 ;
"RTN","EASUM1",92,0)
ADDCHILD ; add children if not in 408.13
"RTN","EASUM1",93,0)
 S IVMSPCHV="C" ; spouse/child/vet indicator
"RTN","EASUM1",94,0)
 I 'IVMFLGC G ADDV21 ; no dependent children 
"RTN","EASUM1",95,0)
 S IVMCTR2=5
"RTN","EASUM1",96,0)
 F IVMCTR3=1:1:IVMFLGC D  Q:$D(IVMFERR)
"RTN","EASUM1",97,0)
 .S IVMCTR2=IVMCTR2+1
"RTN","EASUM1",98,0)
 .S IVMDA1=IVMDAP+IVMCTR2 D GET ; child ZDP segment
"RTN","EASUM1",99,0)
 .D INPIEN^IVMUM2
"RTN","EASUM1",100,0)
 .Q:$D(IVMFERR)
"RTN","EASUM1",101,0)
 .;
"RTN","EASUM1",102,0)
 .; add child entry to patient relation file (408.12)
"RTN","EASUM1",103,0)
 .D EN^IVMUM3
"RTN","EASUM1",104,0)
 .Q:$D(IVMFERR)
"RTN","EASUM1",105,0)
 .;
"RTN","EASUM1",106,0)
ADDC21 .; add child entry to individual annual income file (408.21)
"RTN","EASUM1",107,0)
 .S IVMCTR2=IVMCTR2+1
"RTN","EASUM1",108,0)
 .S IVMDA1=IVMDAP+IVMCTR2 D GET ; child ZIC segment
"RTN","EASUM1",109,0)
 .D EN^IVMUM4
"RTN","EASUM1",110,0)
 .Q:$D(IVMFERR)
"RTN","EASUM1",111,0)
 .;
"RTN","EASUM1",112,0)
 .; add entry to income relation file (408.22)
"RTN","EASUM1",113,0)
 .S IVMCTR2=IVMCTR2+1
"RTN","EASUM1",114,0)
 .S IVMDA1=IVMDAP+IVMCTR2 D GET ; child ZIR segment
"RTN","EASUM1",115,0)
 .D EN^IVMUM5
"RTN","EASUM1",116,0)
 .Q:$D(IVMFERR)
"RTN","EASUM1",117,0)
 .Q
"RTN","EASUM1",118,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",119,0)
 ;
"RTN","EASUM1",120,0)
ADDV21 ; add vet entry to individual annual income file (408.21)
"RTN","EASUM1",121,0)
 ; get vet patient relation ien
"RTN","EASUM1",122,0)
 S DGPRI=+$G(DGREL("V"))
"RTN","EASUM1",123,0)
 S IVMDA1=IVMDAP+1 D GET ; vet ZIC segment
"RTN","EASUM1",124,0)
 S IVMSPCHV="V" ; spouse/child/vet indicator
"RTN","EASUM1",125,0)
 D EN^IVMUM4
"RTN","EASUM1",126,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",127,0)
 S DGVINI=DGINI ; vet individual annual income ien
"RTN","EASUM1",128,0)
 ;
"RTN","EASUM1",129,0)
 ; add vet entry to income relation file (408.22)
"RTN","EASUM1",130,0)
 S IVMDA1=IVMDAP+2 D GET ; vet ZIR segment
"RTN","EASUM1",131,0)
 D EN^IVMUM5
"RTN","EASUM1",132,0)
 Q:$D(IVMFERR)
"RTN","EASUM1",133,0)
 S DGVIRI=DGIRI ; vet income relation ien
"RTN","EASUM1",134,0)
 ;
"RTN","EASUM1",135,0)
COMPLETE ; complete means test
"RTN","EASUM1",136,0)
 ;
"RTN","EASUM1",137,0)
 ;D EN^IVMUM6
"RTN","EASUM1",138,0)
 ;Call Means Test Event Driver to complete processing
"RTN","EASUM1",139,0)
 ;
"RTN","EASUM1",140,0)
 S DGMTACT="UPL"
"RTN","EASUM1",141,0)
 D AFTER^DGMTEVT
"RTN","EASUM1",142,0)
 S DGMTINF=1                                    ;Non-Interactive Flag
"RTN","EASUM1",143,0)
 D EN^DGMTEVT
"RTN","EASUM1",144,0)
 D MTBULL^IVMUM6,MAIL^IVMUFNC()                 ;Build Mail Message
"RTN","EASUM1",145,0)
 ;
"RTN","EASUM1",146,0)
 ; cleanup
"RTN","EASUM1",147,0)
 K DGINI,DGIRI,DGLY,DGMTDT,DGMTYPT,DGPRI,DGREL,DGVINI,DGVIRI
"RTN","EASUM1",148,0)
 K IVMAR,IVMCEB,IVMCTR2,IVMCTR3,IVMDA1,IVMDAP,IVMFERR
"RTN","EASUM1",149,0)
 K IVMFLG2,IVMFLG5,IVMFLGC,IVMMTB,IVMPRN
"RTN","EASUM1",150,0)
 K IVMRELN,IVMRELO,IVMSEG,IVMSPCHV,IVMX
"RTN","EASUM1",151,0)
 Q
"RTN","EASUM1",152,0)
 ; 
"RTN","EASUM1",153,0)
GET ; get HL7 segment from ^HL
"RTN","EASUM1",154,0)
 S IVMSEG=$P($G(^TMP($J,IVMRTN,IVMDA1,0)),"^",2,999)
"RTN","EASUM1",155,0)
 Q
"VER")
8.0^22
**END**
**END**
