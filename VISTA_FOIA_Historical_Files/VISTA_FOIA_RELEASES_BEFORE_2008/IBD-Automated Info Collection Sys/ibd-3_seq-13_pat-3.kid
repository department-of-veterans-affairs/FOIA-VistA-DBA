Released IBD*3*3 SEQ #13
Extracted from mail message
**KIDS**:IBD*3.0*3^

**INSTALL NAME**
IBD*3.0*3
"BLD",574,0)
IBD*3.0*3^AUTOMATED INFO COLLECTION SYS^0^2971124^y
"BLD",574,1,0)
^^1^1^2971124^^^
"BLD",574,1,1,0)
AICS scanning patch to fix duplex scanning and anchor location.
"BLD",574,4,0)
^9.64PA^359.1^1
"BLD",574,4,359.1,0)
359.1
"BLD",574,4,359.1,222)
n^n^f^^n^^y^o^n
"BLD",574,4,"B",359.1,359.1)

"BLD",574,"ABPKG")
n
"BLD",574,"INIT")
IBDY303
"BLD",574,"KRN",0)
^9.67PA^19^18
"BLD",574,"KRN",.4,0)
.4
"BLD",574,"KRN",.4,"NM",0)
^9.68A^1^1
"BLD",574,"KRN",.4,"NM",1,0)
IBD NO APPOINTMENT LIST    FILE #357.96^357.96^0
"BLD",574,"KRN",.4,"NM","B","IBD NO APPOINTMENT LIST    FILE #357.96",1)

"BLD",574,"KRN",.401,0)
.401
"BLD",574,"KRN",.401,"NM",0)
^9.68A^1^1
"BLD",574,"KRN",.401,"NM",1,0)
IBD NO APPOINTMENT LIST    FILE #357.96^357.96^0
"BLD",574,"KRN",.401,"NM","B","IBD NO APPOINTMENT LIST    FILE #357.96",1)

"BLD",574,"KRN",.402,0)
.402
"BLD",574,"KRN",.403,0)
.403
"BLD",574,"KRN",.5,0)
.5
"BLD",574,"KRN",.84,0)
.84
"BLD",574,"KRN",3.6,0)
3.6
"BLD",574,"KRN",3.8,0)
3.8
"BLD",574,"KRN",9.2,0)
9.2
"BLD",574,"KRN",9.8,0)
9.8
"BLD",574,"KRN",9.8,"NM",0)
^9.68A^15^15
"BLD",574,"KRN",9.8,"NM",1,0)
IBDFBKS4^^0^B21802437
"BLD",574,"KRN",9.8,"NM",2,0)
IBDFBKS2^^0^B70773166
"BLD",574,"KRN",9.8,"NM",3,0)
IBDF18E^^0^B35760220
"BLD",574,"KRN",9.8,"NM",4,0)
IBDF18E1^^0^B37788506
"BLD",574,"KRN",9.8,"NM",5,0)
IBDY303^^0^B4060502
"BLD",574,"KRN",9.8,"NM",6,0)
IBDY303E^^0^B2668585
"BLD",574,"KRN",9.8,"NM",7,0)
IBDF2F^^0^B52537513
"BLD",574,"KRN",9.8,"NM",8,0)
IBDF2F1^^0^B14792298
"BLD",574,"KRN",9.8,"NM",9,0)
IBDF2F2^^0^B15381752
"BLD",574,"KRN",9.8,"NM",10,0)
IBDFBKS1^^0^B59810208
"BLD",574,"KRN",9.8,"NM",11,0)
IBDF1B1^^0^B22470828
"BLD",574,"KRN",9.8,"NM",12,0)
IBDFDE^^0^B76755336
"BLD",574,"KRN",9.8,"NM",13,0)
IBDFRPC5^^0^B12346956
"BLD",574,"KRN",9.8,"NM",14,0)
IBDFRPC6^^0^B54581145
"BLD",574,"KRN",9.8,"NM",15,0)
IBDFRPC3^^0^B15590454
"BLD",574,"KRN",9.8,"NM","B","IBDF18E",3)

"BLD",574,"KRN",9.8,"NM","B","IBDF18E1",4)

"BLD",574,"KRN",9.8,"NM","B","IBDF1B1",11)

"BLD",574,"KRN",9.8,"NM","B","IBDF2F",7)

"BLD",574,"KRN",9.8,"NM","B","IBDF2F1",8)

"BLD",574,"KRN",9.8,"NM","B","IBDF2F2",9)

"BLD",574,"KRN",9.8,"NM","B","IBDFBKS1",10)

"BLD",574,"KRN",9.8,"NM","B","IBDFBKS2",2)

"BLD",574,"KRN",9.8,"NM","B","IBDFBKS4",1)

"BLD",574,"KRN",9.8,"NM","B","IBDFDE",12)

"BLD",574,"KRN",9.8,"NM","B","IBDFRPC3",15)

"BLD",574,"KRN",9.8,"NM","B","IBDFRPC5",13)

"BLD",574,"KRN",9.8,"NM","B","IBDFRPC6",14)

"BLD",574,"KRN",9.8,"NM","B","IBDY303",5)

"BLD",574,"KRN",9.8,"NM","B","IBDY303E",6)

"BLD",574,"KRN",19,0)
19
"BLD",574,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",574,"KRN",19,"NM",1,0)
IBD SCANNING WORKSTATION^^0
"BLD",574,"KRN",19,"NM","B","IBD SCANNING WORKSTATION",1)

"BLD",574,"KRN",19.1,0)
19.1
"BLD",574,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",574,"KRN",101,0)
101
"BLD",574,"KRN",409.61,0)
409.61
"BLD",574,"KRN",771,0)
771
"BLD",574,"KRN",869.2,0)
869.2
"BLD",574,"KRN",870,0)
870
"BLD",574,"KRN",8994,0)
8994
"BLD",574,"KRN",8994,"NM",0)
^9.68A^2^2
"BLD",574,"KRN",8994,"NM",1,0)
IBD GET ALL PCE DATA^^0
"BLD",574,"KRN",8994,"NM",2,0)
IBD GET PAST APPT LIST^^0
"BLD",574,"KRN",8994,"NM","B","IBD GET ALL PCE DATA",1)

"BLD",574,"KRN",8994,"NM","B","IBD GET PAST APPT LIST",2)

"BLD",574,"KRN","B",.4,.4)

"BLD",574,"KRN","B",.401,.401)

"BLD",574,"KRN","B",.402,.402)

"BLD",574,"KRN","B",.403,.403)

"BLD",574,"KRN","B",.5,.5)

"BLD",574,"KRN","B",.84,.84)

"BLD",574,"KRN","B",3.6,3.6)

"BLD",574,"KRN","B",3.8,3.8)

"BLD",574,"KRN","B",9.2,9.2)

"BLD",574,"KRN","B",9.8,9.8)

"BLD",574,"KRN","B",19,19)

"BLD",574,"KRN","B",19.1,19.1)

"BLD",574,"KRN","B",101,101)

"BLD",574,"KRN","B",409.61,409.61)

"BLD",574,"KRN","B",771,771)

"BLD",574,"KRN","B",869.2,869.2)

"BLD",574,"KRN","B",870,870)

"BLD",574,"KRN","B",8994,8994)

"BLD",574,"PRE")
IBDY303E
"BLD",574,"QUES",0)
^9.62^^
"BLD",574,"REQB",0)
^9.611^2^2
"BLD",574,"REQB",1,0)
IBD*3.0*1^1
"BLD",574,"REQB",2,0)
IBD*3.0*6^1
"BLD",574,"REQB","B","IBD*3.0*1",1)

"BLD",574,"REQB","B","IBD*3.0*6",2)

"DATA",359.1,1,0)
ICD-9 DIAGNOSIS CODE^7^^^____.__^7^10^^^^^ICD-9
"DATA",359.1,1,1)
D INPUTICD^IBDFN8(.X)
"DATA",359.1,1,10)
a^XF^^NNNN.NN
"DATA",359.1,2,0)
CPT-4 PROCEDURE CODE^5^^^^5^10^^^^^CPT-4
"DATA",359.1,2,1)
D INPUTCPT^IBDFN8(.X)
"DATA",359.1,2,10)
a^XNNNN
"DATA",359.1,6,0)
BODY WEIGHT^5^^^___._^5^10^^^Weight:^lbs^WT^LB
"DATA",359.1,6,10)
f^^^NNN.N
"DATA",359.1,7,0)
BODY TEMPERATURE^5^^^___._^5^10^^^Temperature:^Fahr^TMP^F
"DATA",359.1,7,10)
f^^^NNN.N
"DATA",359.1,15,0)
BLOOD PRESSURE^7^^^___/___^7^10^^^Blood Press.:^systolic/diastolic^BP
"DATA",359.1,15,10)
a^NNNPNNN^^NNN/NNN
"DATA",359.1,16,0)
AUDIOMETRY - LEFT EAR^31^^^___/___/___/___/___/___/___/___^31^10^^^^lft ear^AUD
"DATA",359.1,16,10)
a^^^###/###/###/###/###/###/###/###
"DATA",359.1,17,0)
CHECKOUT DATE@TIME^11^^^____9_@____^11^10^^^Checkout:^mmddyy@hhmm^CODT
"DATA",359.1,17,1)
D CKOUT^IBDFN13(.X)
"DATA",359.1,17,10)
a
"DATA",359.1,18,0)
SHORT NARRATIVE (30 CHAR)^^^^_______________________________^30^10^^^^^NARR
"DATA",359.1,18,10)
a^^^################################
"DATA",359.1,19,0)
ABDOMINAL GIRTH^^^^___^3^10^^^Abdominal Girth:^in^AG^IN
"DATA",359.1,19,10)
i^^^NNN
"DATA",359.1,20,0)
AUDIOMETRY - RIGHT EAR^^^^___/___/___/___/___/___/___/___^31^10^^^^rt ear^AUD
"DATA",359.1,20,10)
a^^^###/###/###/###/###/###/###/###
"DATA",359.1,21,0)
FUNDAL HEIGHT^2^^^__^2^10^^^Fundal Ht:^in^FH^IN
"DATA",359.1,21,10)
a^^^NN
"DATA",359.1,22,0)
FETAL HEART TONES^^^^___^3^10^^^Fetal Heart Tone:^per min^FT
"DATA",359.1,22,10)
a^^^NNN
"DATA",359.1,23,0)
HEAD CIRCUMFERENCE^^^^__._^4^10^^^Head Circumference:^in^HC^IN
"DATA",359.1,23,10)
f^^^NN.N
"DATA",359.1,24,0)
HEARING^^^^_^1^10^^^Hearing:^N=normal,A=abnormal^HE
"DATA",359.1,24,10)
a^^^N
"DATA",359.1,25,0)
BODY HEIGHT^4^^^__._^4^10^^^Height:^in^HT^IN
"DATA",359.1,25,10)
f^^^NN.N
"DATA",359.1,26,0)
PULSE^3^^^___^3^10^^^Pulse^per min^PU
"DATA",359.1,26,10)
i^^^NNN
"DATA",359.1,27,0)
RESPIRATION^3^^^__^2^10^^^Respiration:^per min^RS
"DATA",359.1,27,10)
i^^^NN
"DATA",359.1,28,0)
TONOMETRY^^^^__/__^5^10^^^Tonometry:^lft eye/rt eye^TON
"DATA",359.1,28,10)
a^^^NN/NN
"DATA",359.1,29,0)
VISION CORRECTED^^^^__/__^5^10^^^Vision Corrected:^lft eye/rt eye^VC
"DATA",359.1,29,10)
a^^^NN/NN
"DATA",359.1,30,0)
VISION UNCORRECTED^^^^__/__^5^10^^^Vison Uncorrected:^lft eye/rt eye^VU
"DATA",359.1,30,10)
a^^^NN/NN
"DATA",359.1,31,0)
CHECKOUT TIME - DATE ASSUMED^4^^^____^4^10^^^Checkout:^hhmm^COTIME
"DATA",359.1,31,1)
D CKOUTTM^IBDFN13(.X,.IBFORMID)
"DATA",359.1,31,10)
t
"FIA",359.1)
AICS DATA ELEMENTS
"FIA",359.1,0)
^IBE(359.1,
"FIA",359.1,0,0)
359.1
"FIA",359.1,0,1)
n^n^f^^n^^y^o^n
"FIA",359.1,0,10)

"FIA",359.1,0,11)

"FIA",359.1,0,"RLRO")

"FIA",359.1,0,"VR")
3.0^IBD
"FIA",359.1,359.1)
0
"INIT")
IBDY303
"KRN",.4,1780,-1)
0^1
"KRN",.4,1780,0)
IBD NO APPOINTMENT LIST^2970731.1436^@^357.96^^@^2970801
"KRN",.4,1780,"DCL","357.96^.02")
!
"KRN",.4,1780,"F",1)
.02;L25~-2,^DPT(^^S I(0,0)=D0 S DIP(1)=$S($D(^IBD(357.96,D0,0)):^(0),1:"") S X=$P(DIP(1),U,2),X=X S D(0)=+X;Z;"PATIENT:"~-2,.363;"SSN";L12~.1;L25~
"KRN",.4,1780,"F",2)
.05;L20~.11;L18~
"KRN",.4,1780,"H")
Patients w/ Data from Encounter Forms and No Appointments
"KRN",.401,1282,-1)
0^1
"KRN",.401,1282,0)
IBD NO APPOINTMENT LIST^2970731.1437^@^357.96^^@^2970801
"KRN",.401,1282,2,0)
^.4014^4^4
"KRN",.401,1282,2,1,0)
357.96^^NO APPOINTMENT ENTRY=NO APPOINTMENT ENTRY^'@"@B^;L1^^^^^4
"KRN",.401,1282,2,1,3,0)
^.401419^1^1
"KRN",.401,1282,2,1,3,1,0)
OVF0^9.2
"KRN",.401,1282,2,1,3,1,"OVF0")
S Y(2)=$C(59)_$S($D(^DD(357.96,.14,0)):$P(^(0),U,3),1:""),Y(3)=$C(59)_$S($D(^DD(357.96,.14,0)):$P(^(0),U,3),1:""),Y(1)=$S($D(^IBD(357.96,D0,0)):^(0),1:"")
"KRN",.401,1282,2,1,3,"B","OVF0",1)

"KRN",.401,1282,2,1,"CM")
X DPP(1,"OVF0",9.2) S X=$P($P(Y(2),$C(59)_$P(Y(1),U,14)_":",2),$C(59),1)=$P($P(Y(3),$C(59)_$P(Y(1),U,14)_":",2),$C(59),1) I D0>0 S DISX(1)=X
"KRN",.401,1282,2,1,"F")
0
"KRN",.401,1282,2,1,"GET")
X DPP(1,"OVF0",9.2) S X=$P($P(Y(2),$C(59)_$P(Y(1),U,14)_":",2),$C(59),1)=$P($P(Y(3),$C(59)_$P(Y(1),U,14)_":",2),$C(59),1) I D0>0 S DISX(1)=X
"KRN",.401,1282,2,1,"QCON")
I DISX(1)
"KRN",.401,1282,2,1,"T")
1
"KRN",.401,1282,2,1,"TXT")
NO APPOINTMENT ENTRY=NO APPOINTMENT ENTRY
"KRN",.401,1282,2,2,0)
357.96^^INTERNAL(#.11)=3!(INTERNAL(#.11)=6)^'@"@B^;L1^^^^^4
"KRN",.401,1282,2,2,"CM")
S Y(1)=$S($D(^IBD(357.96,D0,0)):^(0),1:"") S X=$P(Y(1),U,11),X=X S X=X=3,Y(2)=X,Y(3)=X S X=$P(Y(1),U,11),X=X S X=X=6,Y=X,X=Y(2),X=X!Y I D0>0 S DISX(2)=X
"KRN",.401,1282,2,2,"F")
0
"KRN",.401,1282,2,2,"GET")
S Y(1)=$S($D(^IBD(357.96,D0,0)):^(0),1:"") S X=$P(Y(1),U,11),X=X S X=X=3,Y(2)=X,Y(3)=X S X=$P(Y(1),U,11),X=X S X=X=6,Y=X,X=Y(2),X=X!Y I D0>0 S DISX(2)=X
"KRN",.401,1282,2,2,"QCON")
I DISX(2)
"KRN",.401,1282,2,2,"T")
1
"KRN",.401,1282,2,2,"TXT")
INTERNAL(#.11)=3!(INTERNAL(#.11)=6)
"KRN",.401,1282,2,3,0)
357.96^^PATIENT^+".02^^^^^^4
"KRN",.401,1282,2,3,"CM")
S Y(1)=$S($D(^IBD(357.96,D0,0)):^(0),1:"") S X=$S('$D(^DPT(+$P(Y(1),U,2),0)):"",1:$P(^(0),U,1)) I D0>0 S DISX(3)=X
"KRN",.401,1282,2,3,"GET")
S Y(1)=$S($D(^IBD(357.96,D0,0)):^(0),1:"") S X=$S('$D(^DPT(+$P(Y(1),U,2),0)):"",1:$P(^(0),U,1)) I D0>0 S DISX(3)=X
"KRN",.401,1282,2,3,"IX")
^IBD(357.96,"C",^IBD(357.96,^2
"KRN",.401,1282,2,3,"PTRIX")
^DPT("B",
"KRN",.401,1282,2,3,"QCON")
I DISX(3)'=""
"KRN",.401,1282,2,3,"SER")
0.0110^0.0110
"KRN",.401,1282,2,3,"TXT")
PATIENT not null
"KRN",.401,1282,2,4,0)
357.96^.05^DATE/TIME PRINTED^^^^^^^1
"KRN",.401,1282,2,4,"ASK")
1
"KRN",.401,1282,2,4,"F")
2970730.99999^T-1^7/31/97
"KRN",.401,1282,2,4,"GET")
S DISX(4)=$P($G(^IBD(357.96,D0,0)),U,5)
"KRN",.401,1282,2,4,"QCON")
I (DISX(4)]]2970730.99999)&(DISX(4)']]2970731.24)
"KRN",.401,1282,2,4,"SER")
0.9890^0.9890
"KRN",.401,1282,2,4,"T")
2970731.24^T-1@2400^7/31/97@24:00
"KRN",.401,1282,2,4,"TXT")
DATE/TIME PRINTED from 7/31/97 to 7/31/97@24:00
"KRN",.401,1282,2,"B",357.96,1)

"KRN",.401,1282,2,"B",357.96,2)

"KRN",.401,1282,2,"B",357.96,3)

"KRN",.401,1282,2,"B",357.96,4)

"KRN",.401,1282,"%D",0)
^^3^3^2970731^^^
"KRN",.401,1282,"%D",1,0)
This template with list patients for a date range that have had encounter
"KRN",.401,1282,"%D",2,0)
forms printed that are not related to appointments.
"KRN",.401,1282,"%D",3,0)

"KRN",19,6966,-1)
0^1
"KRN",19,6966,0)
IBD SCANNING WORKSTATION^AICS Scanning Workstation^^B^^^^^^^^
"KRN",19,6966,99.1)
57012,80851
"KRN",19,6966,"RPC",0)
^19.05P^14^14
"KRN",19,6966,"RPC",1,0)
IBD ELAPSED TIME
"KRN",19,6966,"RPC",2,0)
IBD EXPAND FORMID
"KRN",19,6966,"RPC",3,0)
IBD GET FORMSPEC
"KRN",19,6966,"RPC",4,0)
IBD RECEIVE DATA
"KRN",19,6966,"RPC",5,0)
IBD RECEIVE FORM DATA
"KRN",19,6966,"RPC",6,0)
IBD RETURN IMAGE ID
"KRN",19,6966,"RPC",7,0)
IBD VALIDATE USER
"KRN",19,6966,"RPC",8,0)
SC LISTER
"KRN",19,6966,"RPC",9,0)
SC GETS ENTRY DATA
"KRN",19,6966,"RPC",10,0)
IBD STORE IMAGE NAME
"KRN",19,6966,"RPC",11,0)
IBD STORE WORKSTATION ERROR
"KRN",19,6966,"RPC",12,0)
SC FILER
"KRN",19,6966,"RPC",13,0)
IBD GET ALL PCE DATA
"KRN",19,6966,"RPC",14,0)
IBD GET PAST APPT LIST
"KRN",19,6966,"U")
AICS SCANNING WORKSTATION
"KRN",8994,83,-1)
0^1
"KRN",8994,83,0)
IBD GET ALL PCE DATA^GETALL^IBDFRPC5^2^P
"KRN",8994,83,1,0)
^^2^2^2971009^^^^
"KRN",8994,83,1,1,0)
This RPC is used to retrieve all data in PCE for a particlar encounter
"KRN",8994,83,1,2,0)
formatted for display in a memo component.
"KRN",8994,83,2,0)
^8994.02A^1^1
"KRN",8994,83,2,1,0)
IBDATA^2^80^1
"KRN",8994,83,2,"B","IBDATA",1)

"KRN",8994,84,-1)
0^2
"KRN",8994,84,0)
IBD GET PAST APPT LIST^APPTLST^IBDFRPC5^2^P
"KRN",8994,84,1,0)
^^2^2^2971224^^^
"KRN",8994,84,1,1,0)
This RPC can be used to return a list of appointments for a patient.  It
"KRN",8994,84,1,2,0)
defaults to returning the past 1 year's kept appointments.
"KRN",8994,84,2,0)
^8994.02A^1^1
"KRN",8994,84,2,1,0)
IBDF^2^30^1
"KRN",8994,84,2,1,1,0)
^^4^4^2970722^
"KRN",8994,84,2,1,1,1,0)
Requires the variable IBDF("DFN") be set to the patient internal entry number.
"KRN",8994,84,2,1,1,2,0)
IBDF("F") is the from date (defaults to t-1year)
"KRN",8994,84,2,1,1,3,0)
IBDF("T") is the to date (defaults to t@midnight)
"KRN",8994,84,2,1,1,4,0)
IBDF("W") is the types of appointments to return, see SDA^VAPDT
"KRN",8994,84,2,"B","IBDF",1)

"KRN",8994,84,3,0)
^^9^9^2971224^^
"KRN",8994,84,3,1,0)
Returns the list of appointments in reverse chronological order,
"KRN",8994,84,3,2,0)
     p1 := appointment date (external)
"KRN",8994,84,3,3,0)
     p2 := clinic (external)
"KRN",8994,84,3,4,0)
     p3 := status (external)
"KRN",8994,84,3,5,0)
     p4 := appt type (external)
"KRN",8994,84,3,6,0)
     p5 := appointment date (internal)
"KRN",8994,84,3,7,0)
     p6 := clinic (internal)
"KRN",8994,84,3,8,0)
     p7 := status (internal)
"KRN",8994,84,3,9,0)
     p8 := appt type (internal)
"OER",421,0)
421^IBD
"OER",421,1,0)
^100.9951PA^13^13
"OER",421,1,1,0)
635
"OER",421,1,1,1,0)
^100.99511PA^1^1
"OER",421,1,1,1,1,0)
1228
"OER",421,1,2,0)
634
"OER",421,1,2,1,0)
^100.99511PA^1^1
"OER",421,1,2,1,1,0)
1228
"OER",421,1,3,0)
639
"OER",421,1,3,1,0)
^100.99511PA^1^1
"OER",421,1,3,1,1,0)
1228
"OER",421,1,4,0)
640
"OER",421,1,4,1,0)
^100.99511PA^1^1
"OER",421,1,4,1,1,0)
1228
"OER",421,1,5,0)
636
"OER",421,1,5,1,0)
^100.99511PA^1^1
"OER",421,1,5,1,1,0)
1228
"OER",421,1,6,0)
644
"OER",421,1,6,1,0)
^100.99511PA^1^1
"OER",421,1,6,1,1,0)
1228
"OER",421,1,7,0)
659
"OER",421,1,7,1,0)
^100.99511PA^1^1
"OER",421,1,7,1,1,0)
1228
"OER",421,1,8,0)
660
"OER",421,1,8,1,0)
^100.99511PA^1^1
"OER",421,1,8,1,1,0)
1228
"OER",421,1,9,0)
637
"OER",421,1,9,1,0)
^100.99511PA^1^1
"OER",421,1,9,1,1,0)
1228
"OER",421,1,10,0)
638
"OER",421,1,10,1,0)
^100.99511PA^1^1
"OER",421,1,10,1,1,0)
1228
"OER",421,1,11,0)
642
"OER",421,1,11,1,0)
^100.99511PA^1^1
"OER",421,1,11,1,1,0)
1228
"OER",421,1,12,0)
663
"OER",421,1,12,1,0)
^100.99511PA^1^1
"OER",421,1,12,1,1,0)
1228
"OER",421,1,13,0)
1665
"OER",421,1,13,1,0)
^100.99511PA^2^2
"OER",421,1,13,1,1,0)
1707
"OER",421,1,13,1,2,0)
1110
"OER",421,5,0)
^100.9955^^0
"ORD",5,.4)
.4;5;;;EDEOUT^DIFROMSO(.4,DA,"",XPDA);FPRE^DIFROMSI(.4,"",XPDA);EPRE^DIFROMSI(.4,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.4,DA,"",XPDA);DEL^DIFROMSK(.4,"",%)
"ORD",5,.4,0)
PRINT TEMPLATE
"ORD",6,.401)
.401;6;;;EDEOUT^DIFROMSO(.401,DA,"",XPDA);FPRE^DIFROMSI(.401,"",XPDA);EPRE^DIFROMSI(.401,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.401,DA,"",XPDA);DEL^DIFROMSK(.401,"",%)
"ORD",6,.401,0)
SORT TEMPLATE
"ORD",16,8994)
8994;16;1;;;;;;;RPCDEL^XPDIA1
"ORD",16,8994,0)
REMOTE PROCEDURE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",421,-1)
1^1
"PKG",421,0)
AUTOMATED INFO COLLECTION SYS^IBD^The utilities for generating a paper encounter form.
"PKG",421,22,0)
^9.49I^1^1
"PKG",421,22,1,0)
3.0^2970212^2970424^1258
"PKG",421,22,1,"PAH",1,0)
3^2971124^1453
"PKG",421,22,1,"PAH",1,1,0)
^^1^1^2971230
"PKG",421,22,1,"PAH",1,1,1,0)
AICS scanning patch to fix duplex scanning and anchor location.
"PRE")
IBDY303E
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
15
"RTN","IBDF18E")
0^3^B35760220
"RTN","IBDF18E",1,0)
IBDF18E ;ALB/CJM - ENCOUNTER FORM - PCE DEVICE INTERFACE utilities ;04-OCT-94
"RTN","IBDF18E",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDF18E",3,0)
 ;
"RTN","IBDF18E",4,0)
SEND(FORMID,PROVIDER,PROVTYPE,BUBBLES,HANDPRNT,CHECKOUT,PXCA,DYNAMIC) ;builds the PCXA array and passes it to PCE, updates form tracking status
"RTN","IBDF18E",5,0)
 ;input:
"RTN","IBDF18E",6,0)
 ;   FORMID = the unique id assigned to the printed form, points to the FORM TRACKING file
"RTN","IBDF18E",7,0)
 ;   PROVIDER=pointer to NEW PERSON file (#200) (optional)
"RTN","IBDF18E",8,0)
 ;   PROVTYPE= P:=primary,S:=secondary (optional)
"RTN","IBDF18E",9,0)
 ;   BUBBLES = an array which should be passed by reference, BUBBLES is the list of bubbles marked on the form, subscripted by pointers to the BUBBLES multiple in the FORM DEFINITION TABLE
"RTN","IBDF18E",10,0)
 ;   HANDPRNT is the list of hand print fields marked on the form - subscripted by pointers to the HAND PRINT FIELDS multiple in the FORM DEFINITION TABLE, the value being what was input (HANDPRINT(<ien>)=<value>) - should be passed by reference
"RTN","IBDF18E",11,0)
 ;   CHECKOUT = checkout data@time
"RTN","IBDF18E",12,0)
 ;   DYNAMIC = an array which should be passed by reference, contains the list of bubbles selected from dynamic selection lists
"RTN","IBDF18E",13,0)
 ;
"RTN","IBDF18E",14,0)
 ;output:
"RTN","IBDF18E",15,0)
 ;    = 0 if the data is not passed to PCE
"RTN","IBDF18E",16,0)
 ;    = 1 if PXCA is passed by reference, and the data is passed to PCE
"RTN","IBDF18E",17,0)
 ;    the PXCA array is returned, principally to aid in debugging
"RTN","IBDF18E",18,0)
 ;
"RTN","IBDF18E",19,0)
 ;example: S RETURN=$$SEND^IBDF18E(3,DOCTOR,"P",.BUBBLES,.HANDPRNT)
"RTN","IBDF18E",20,0)
 ;
"RTN","IBDF18E",21,0)
 N D,D0,NODE,FORMTYPE,PXCASTAT,IBAPPT,IBCLINIC,IBDFN,VALUE,VALUE1,PI,TEXT,HEADER,QLFR,BUB,STATUS,IBSOURCE,HAND,COUNT,FID,TEMP,ITEM,TYPE,IBDF,LEX,PLEX,QUANTITY,NARR
"RTN","IBDF18E",22,0)
 ;
"RTN","IBDF18E",23,0)
 S FORMID("WSID")=$G(^TMP("IBD-SCAN-RAWDATA",$J,"WSID"))
"RTN","IBDF18E",24,0)
 K PXCA
"RTN","IBDF18E",25,0)
 S (PXCA,PXCASTAT)=""
"RTN","IBDF18E",26,0)
 ;
"RTN","IBDF18E",27,0)
 ;check that the required parameters were passed
"RTN","IBDF18E",28,0)
 I '$G(FORMID) D LOGERR^IBDF18E2(3579601,.FORMID) Q 0
"RTN","IBDF18E",29,0)
 ;
"RTN","IBDF18E",30,0)
 ;there must be an entry in form tracking - retrieve it into FORMID array
"RTN","IBDF18E",31,0)
 I '$$TRACKING^IBDF18E0(.FORMID) D LOGERR^IBDF18E2(3579501,.FORMID) Q 0
"RTN","IBDF18E",32,0)
 ;
"RTN","IBDF18E",33,0)
 ;there must be a form definition table
"RTN","IBDF18E",34,0)
 S FORMTYPE=$P(NODE,"^",4)
"RTN","IBDF18E",35,0)
 I 'FORMTYPE S STATUS=$$FSCND^IBDF18C(FORMID,12) Q 0
"RTN","IBDF18E",36,0)
 I '$G(^IBD(357.95,FORMTYPE,0)) S STATUS=$$FSCND^IBDF18C(FORMID,12) Q 0
"RTN","IBDF18E",37,0)
 ;
"RTN","IBDF18E",38,0)
 S PROVIDER=$G(PROVIDER)
"RTN","IBDF18E",39,0)
 S PROVTYPE=$G(PROVTYPE)
"RTN","IBDF18E",40,0)
 ;
"RTN","IBDF18E",41,0)
 ;build the encounter node and source node from form tracking
"RTN","IBDF18E",42,0)
 S PXCA("ENCOUNTER")=FORMID("APPT")_"^"_FORMID("DFN")_"^"_FORMID("CLINIC")_"^"_PROVIDER_"^^^^^^^^^^"_CHECKOUT_"^"_PROVTYPE
"RTN","IBDF18E",43,0)
 S PXCA("SOURCE")=+FORMID("SOURCE")_"^"_DUZ_"^"_FORMTYPE_"^^"_FORMID
"RTN","IBDF18E",44,0)
 ;
"RTN","IBDF18E",45,0)
 ;now for each bubble in BUBBLES() add to TEMP()
"RTN","IBDF18E",46,0)
 S BUB=0 F  S BUB=$O(BUBBLES(BUB)) Q:BUB=""  S:BUB NODE=$G(^IBD(357.95,FORMTYPE,1,BUB,0)) D
"RTN","IBDF18E",47,0)
 .N SUBHDR
"RTN","IBDF18E",48,0)
 .I 'BUB!(NODE="") D LOGERR^IBDF18E2(3579502,.FORMID,BUB,BUBBLES(BUB)) Q
"RTN","IBDF18E",49,0)
 .S $P(NODE,"^",8)=$S($D(^IBD(357.95,FORMTYPE,1,BUB,2))&($P($G(^IBD(357.95,FORMTYPE,1,BUB,2)),"^",1)]""):$P($G(^IBD(357.95,FORMTYPE,1,BUB,2)),"^",1),1:$P(NODE,"^",8))
"RTN","IBDF18E",50,0)
 .S VALUE=$P(NODE,"^",4)
"RTN","IBDF18E",51,0)
 .S PI=$P(NODE,"^",3)
"RTN","IBDF18E",52,0)
 .S TEXT=$P(NODE,"^",8)
"RTN","IBDF18E",53,0)
 .; -- strip :: code from TEXT if it exists
"RTN","IBDF18E",54,0)
 .I TEXT[" :: ",PI,VALUE D
"RTN","IBDF18E",55,0)
 ..S (Y,X)=VALUE X $G(^IBE(357.6,PI,14)) I Y]"" S TEXT=$P(TEXT," :: "_Y)
"RTN","IBDF18E",56,0)
 .S SUBHDR=$G(^IBD(357.95,FORMTYPE,1,BUB,1))
"RTN","IBDF18E",57,0)
 .;
"RTN","IBDF18E",58,0)
 .; -- the following line causes the subheader and display text to
"RTN","IBDF18E",59,0)
 .;    to be concatenated except for IB, which can pass an alternate
"RTN","IBDF18E",60,0)
 .;    text.  (some don't like this when passed to Problem List)
"RTN","IBDF18E",61,0)
 .;    This may need to be re-visited in the future
"RTN","IBDF18E",62,0)
 .I +FORMID("SOURCE")'=1,$L(SUBHDR),($L(SUBHDR)+$L(TEXT)<80) S TEXT=SUBHDR_" "_TEXT
"RTN","IBDF18E",63,0)
 .S HEADER=$P(NODE,"^",9)
"RTN","IBDF18E",64,0)
 .S FID=$P(NODE,"^",6) I FID="" S FID=$P(NODE,"^") ;PANDAS uses piece 1 to number each bubble - does not use piece 6
"RTN","IBDF18E",65,0)
 .S ITEM=$P(NODE,"^",12)
"RTN","IBDF18E",66,0)
 .S QLFR=$P(NODE,"^",10)
"RTN","IBDF18E",67,0)
 .S QUANTITY=$P(NODE,"^",13)
"RTN","IBDF18E",68,0)
 .; -- if text contains 'x #' for quantity, strip it
"RTN","IBDF18E",69,0)
 .I +QUANTITY I TEXT[" x "_QUANTITY S TEXT=$TR(TEXT," x "_QUANTITY)
"RTN","IBDF18E",70,0)
 .S TYPE="",(LEX,NARR)=0
"RTN","IBDF18E",71,0)
 .I $D(^IBD(357.95,FORMTYPE,1,BUB,2)) S LEX=$P($G(^IBD(357.95,FORMTYPE,1,BUB,2)),"^",2)
"RTN","IBDF18E",72,0)
 .D SETTEMP^IBDF18E1
"RTN","IBDF18E",73,0)
 .D CODES^IBDF18E0
"RTN","IBDF18E",74,0)
 K BUBBLES
"RTN","IBDF18E",75,0)
 ;
"RTN","IBDF18E",76,0)
 ;now for each bubble in DYNAMIC() add to TEMP()
"RTN","IBDF18E",77,0)
 S FID="" F  S FID=$O(DYNAMIC(FID)) Q:FID=""  S COUNT="" F  S COUNT=$O(DYNAMIC(FID,COUNT)) Q:COUNT=""  S BUB=$O(^IBD(357.96,FORMID,"AC",FID,+COUNT,0)) S:BUB NODE=$G(^IBD(357.96,FORMID,1,BUB,0)) D
"RTN","IBDF18E",78,0)
 .I 'BUB!(NODE="") D LOGERR^IBDF18E2(3579602,.FORMID,FID,DYNAMIC(FID,COUNT)) Q
"RTN","IBDF18E",79,0)
 .S VALUE=$P(NODE,"^",4)
"RTN","IBDF18E",80,0)
 .S PI=$P(NODE,"^",3)
"RTN","IBDF18E",81,0)
 .S TEXT=$P(NODE,"^",8)
"RTN","IBDF18E",82,0)
 .; -- strip :: code from TEXT if it exists
"RTN","IBDF18E",83,0)
 .I TEXT[" :: " S TEXT=$P(TEXT," :: ")
"RTN","IBDF18E",84,0)
 .S HEADER=""
"RTN","IBDF18E",85,0)
 .S FID=$P(NODE,"^",6)
"RTN","IBDF18E",86,0)
 .S ITEM=$P(NODE,"^")
"RTN","IBDF18E",87,0)
 .S QLFR=$P(NODE,"^",10)
"RTN","IBDF18E",88,0)
 .S TYPE=""
"RTN","IBDF18E",89,0)
 .S LEX=0
"RTN","IBDF18E",90,0)
 .D SETTEMP^IBDF18E1
"RTN","IBDF18E",91,0)
 K DYNAMIC
"RTN","IBDF18E",92,0)
 ;
"RTN","IBDF18E",93,0)
 ;now for each hand print field in HANDPRNT() add to TEMP()
"RTN","IBDF18E",94,0)
 ;
"RTN","IBDF18E",95,0)
 S HAND=0 F  S HAND=$O(HANDPRNT(HAND)) Q:HAND=""  S:HAND NODE=$G(^IBD(357.95,FORMTYPE,2,HAND,0)) D
"RTN","IBDF18E",96,0)
 .I 'HAND!(NODE="") D LOGERR^IBDF18E2(3579503,.FORMID,HAND,HANDPRNT(HAND)) Q
"RTN","IBDF18E",97,0)
 .S TYPE=$P(NODE,"^",17)
"RTN","IBDF18E",98,0)
 .S VALUE=HANDPRNT(HAND) S:$E(VALUE,$L(VALUE))="," VALUE=$E(VALUE,1,$L(VALUE)-1)
"RTN","IBDF18E",99,0)
 .;
"RTN","IBDF18E",100,0)
 .;what was printed may need transformation/formating
"RTN","IBDF18E",101,0)
 .S VALUE1=VALUE,VALUE=$$HPTRNS^IBDFU91(TYPE,VALUE,.FORMID)
"RTN","IBDF18E",102,0)
 .;
"RTN","IBDF18E",103,0)
 .; -- failed the input transform
"RTN","IBDF18E",104,0)
 .I VALUE="" D LOGERR^IBDF18E2(3579504,.FORMID,HAND,VALUE1,"","",TYPE) Q
"RTN","IBDF18E",105,0)
 .;
"RTN","IBDF18E",106,0)
 .S PI=$P(NODE,"^",4)
"RTN","IBDF18E",107,0)
 .S TEXT=$P(NODE,"^",7)
"RTN","IBDF18E",108,0)
 .S HEADER=$P(NODE,"^",9)
"RTN","IBDF18E",109,0)
 .S FID=$P(NODE,"^",8)
"RTN","IBDF18E",110,0)
 .S ITEM=$P(NODE,"^",12)
"RTN","IBDF18E",111,0)
 .S QLFR=$P(NODE,"^",10)
"RTN","IBDF18E",112,0)
 .S (LEX,NARR)=0
"RTN","IBDF18E",113,0)
 .I $P($G(^IBE(357.2,+$E(FID,2,$L(FID)),0)),U,18)=3 S NARR=1 ;Send both code and narrative
"RTN","IBDF18E",114,0)
 .D SETTEMP^IBDF18E1
"RTN","IBDF18E",115,0)
 K HANDPRNT
"RTN","IBDF18E",116,0)
 ;
"RTN","IBDF18E",117,0)
 D SETPXCA^IBDF18E0,PRO^IBDF18E0,SC^IBDF18E0
"RTN","IBDF18E",118,0)
 ;
"RTN","IBDF18E",119,0)
 I $D(PXCA("IBD-ABORT")) D  S PXCASTAT=0 G SENDQ
"RTN","IBDF18E",120,0)
 .S I="" F  S I=$O(PXCA("IBD-ABORT",I)) Q:I=""  S J="" F  S J=$O(PXCA("IBD-ABORT",I,J)) Q:J=""  D
"RTN","IBDF18E",121,0)
 ..I +PXCA("IBD-ABORT",I,J)=3 K PXCA("IBD-ABORT",I,J) Q
"RTN","IBDF18E",122,0)
 ..D LOGERR^IBDF18E2(3570004,.FORMID,"",$P(PXCA("IBD-ABORT",I,J),"^",2))
"RTN","IBDF18E",123,0)
 ;
"RTN","IBDF18E",124,0)
 I +FORMID("SOURCE")=1 D QUE^IBDF18E3 G STAT
"RTN","IBDF18E",125,0)
 ;
"RTN","IBDF18E",126,0)
 S IBD("AICS")=1 ;flag for IBDF PCE EVENT protocol
"RTN","IBDF18E",127,0)
 S IBD("PASSFLAG")=+$P($G(^IBD(357.09,1,0)),"^",7)
"RTN","IBDF18E",128,0)
 I $G(IBD("PASSFLAG"))<2 D VALIDATE^PXCA(.PXCA) I '$D(PXCA("ERROR")) D BACKGND^PXCA(.PXCA,.PXCASTAT)
"RTN","IBDF18E",129,0)
 I $G(IBD("PASSFLAG"))>1 D FOREGND^PXCA(.PXCA,.PXCASTAT)
"RTN","IBDF18E",130,0)
 K IBD("AICS"),IBD("PASSFLAG")
"RTN","IBDF18E",131,0)
 ;
"RTN","IBDF18E",132,0)
STAT S STATUS=$$FSCND^IBDF18C(FORMID,$S(PXCASTAT=0:4,PXCASTAT=1:3,1:12),$S(PXCASTAT=0:"PCE RETURNED AN ERROR",1:""))
"RTN","IBDF18E",133,0)
 ;
"RTN","IBDF18E",134,0)
 ; -- kill erroneous inpatient warnings
"RTN","IBDF18E",135,0)
 I $D(PXCA("WARNING","ENCOUNTER"))>0 D INPT^IBDF18E0($G(FORMID("DFN")),$G(FORMID("APPT")))
"RTN","IBDF18E",136,0)
 ;
"RTN","IBDF18E",137,0)
 ; -- log pce errors and warnings in AICS Error file
"RTN","IBDF18E",138,0)
 I $O(PXCA("ERROR",""))'=""!($O(PXCA("WARNING",""))'="") S FORMID("SOURCE")=99 D LOGERR^IBDF18E2(3570001,.FORMID)
"RTN","IBDF18E",139,0)
 ;
"RTN","IBDF18E",140,0)
 ; -- if pce returns an error unflag all pages as received and delete
"RTN","IBDF18E",141,0)
 ;    all scanned data so data can be re-scanned
"RTN","IBDF18E",142,0)
SENDQ I $O(PXCA("ERROR",""))'=""!($O(PXCA("IBD-ABORT",""))'="") D UNRECV^IBDFBK2(FORMID)
"RTN","IBDF18E",143,0)
 Q +$G(PXCASTAT)
"RTN","IBDF18E1")
0^4^B37788506
"RTN","IBDF18E1",1,0)
IBDF18E1 ;ALB/CJM - ENCOUNTER FORM - PCE DEVICE INTERFACE utilities ;04-OCT-94
"RTN","IBDF18E1",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**1,3**;APR 24, 1997
"RTN","IBDF18E1",3,0)
 ;
"RTN","IBDF18E1",4,0)
GETPI(PI,QLFR,TYPE) ; -- returns information about the package interface 
"RTN","IBDF18E1",5,0)
 ;                    needed to map data to PCE DEVICE INTERFACE
"RTN","IBDF18E1",6,0)
 ;
"RTN","IBDF18E1",7,0)
 ; -- input - PI := pointer to the package interface file
"RTN","IBDF18E1",8,0)
 ;                  MUST be passed by reference
"RTN","IBDF18E1",9,0)
 ;          QLFR := pointer to the data qualifier
"RTN","IBDF18E1",10,0)
 ;          TYPE := pointer to file 359.1, applies to hand print fields
"RTN","IBDF18E1",11,0)
 ;
"RTN","IBDF18E1",12,0)
 ; -- output  PI :="" if the mapping can not be determined
"RTN","IBDF18E1",13,0)
 ;            PI(PI,"NODE")
"RTN","IBDF18E1",14,0)
 ;            PI(PI,"VAL")
"RTN","IBDF18E1",15,0)
 ;            PI(PI,"TXT")
"RTN","IBDF18E1",16,0)
 ;            PI(PI,"HDR")
"RTN","IBDF18E1",17,0)
 ;            PI(PI,"QLFR")
"RTN","IBDF18E1",18,0)
 ;            PI(PI,"QTY")
"RTN","IBDF18E1",19,0)
 ;      - if QLFR is passed, also returns PI(PI,QLFR,"IND")
"RTN","IBDF18E1",20,0)
 ;      - if PI(PI,QLFR,"IND")=1,meaning there is independent mapping
"RTN","IBDF18E1",21,0)
 ;        info for this qualifier - then also returns PI(PI,QLFR,"NODE")=
"RTN","IBDF18E1",22,0)
 ;        <the node>,PI(PI,QLFR,"VAL")=<piece for the value>,
"RTN","IBDF18E1",23,0)
 ;        PI(PI,QLFR,"TXT")=<the piece for txt>,PI(PI,QLFR,"HDR")=
"RTN","IBDF18E1",24,0)
 ;        <piece for the hdr>,
"RTN","IBDF18E1",25,0)
 ;        PI(PI,QLFR,"QLFR")=<piece for the qualifier code>
"RTN","IBDF18E1",26,0)
 ;      - if TYPE is passed , also returns PI(PI,"TYPE",TYPE,"UNIT")=
"RTN","IBDF18E1",27,0)
 ;        <unit code> and PI(PI,"TYPE",TYPE,"VTYPE")=
"RTN","IBDF18E1",28,0)
 ;        <vitals type code>
"RTN","IBDF18E1",29,0)
 ;
"RTN","IBDF18E1",30,0)
 ;NOTE - it is assumed that entries in the PI() may be left hanging around,and if so they are valid
"RTN","IBDF18E1",31,0)
 ;
"RTN","IBDF18E1",32,0)
 N NODE,QNODE,PIECE,IEN
"RTN","IBDF18E1",33,0)
 I '$G(PI) S PI="" G GETPIQ
"RTN","IBDF18E1",34,0)
 ;
"RTN","IBDF18E1",35,0)
 ; -- type of package interface must be for input
"RTN","IBDF18E1",36,0)
 I $P($G(^IBE(357.6,PI,0)),"^",6)'=1 S PI="" G GETPIQ
"RTN","IBDF18E1",37,0)
 ;
"RTN","IBDF18E1",38,0)
 I '$D(PI(PI)) D  Q:'PI ""
"RTN","IBDF18E1",39,0)
 .S NODE=$G(^IBE(357.6,PI,12))
"RTN","IBDF18E1",40,0)
 .S PI(PI,"NODE")=$P(NODE,"^")
"RTN","IBDF18E1",41,0)
 .S PI(PI,"VAL")=$P(NODE,"^",2)
"RTN","IBDF18E1",42,0)
 .S PI(PI,"TXT")=$P(NODE,"^",3)
"RTN","IBDF18E1",43,0)
 .S PI(PI,"HDR")=$P(NODE,"^",4)
"RTN","IBDF18E1",44,0)
 .S PI(PI,"QLFR")=$P(NODE,"^",5)
"RTN","IBDF18E1",45,0)
 .S PI(PI,"QTY")=$P(NODE,"^",6)
"RTN","IBDF18E1",46,0)
 ;
"RTN","IBDF18E1",47,0)
 ; - if there is a 'PCE DIM PIECE, VARIABLE VALUE' node, execute code to
"RTN","IBDF18E1",48,0)
 ; - determine value for PCE DIM PIECE, VALUE (since it is variable, it
"RTN","IBDF18E1",49,0)
 ; - must be asked outside of the above dotted do
"RTN","IBDF18E1",50,0)
 S X="",Y=VALUE X $G(^IBE(357.6,PI,21)) I X S PI(PI,"VAL")=X
"RTN","IBDF18E1",51,0)
 ;
"RTN","IBDF18E1",52,0)
 ;special rules apply for the VITALS node
"RTN","IBDF18E1",53,0)
 I PI(PI,"NODE")="VITALS" D  Q:'PI ""
"RTN","IBDF18E1",54,0)
 .S PI(PI,"VAL")=2 ;the value for the VITALS node goes to piece 2
"RTN","IBDF18E1",55,0)
 .;
"RTN","IBDF18E1",56,0)
 .I 'TYPE D LOGERR^IBDF18E2(35791001,.FORMID,TYPE,$G(VALUE),PI) S PI(PI,"TYPE",+$G(TYPE),"VTYPE")="",PI(PI,"TYPE",+$G(TYPE),"UNIT")="" Q
"RTN","IBDF18E1",57,0)
 .;
"RTN","IBDF18E1",58,0)
 .;may have already gotten
"RTN","IBDF18E1",59,0)
 .I $D(PI(PI,"TYPE",TYPE)) Q
"RTN","IBDF18E1",60,0)
 .;
"RTN","IBDF18E1",61,0)
 .S IEN=$O(^IBE(357.6,PI,13,"B",TYPE_";IBE(359.1,",""))
"RTN","IBDF18E1",62,0)
 .I 'IEN D LOGERR^IBDF18E2(3576001,.FORMID,TYPE,$G(VALUE),PI) S PI(PI,"TYPE",TYPE,"VTYPE")="",PI(PI,"TYPE",TYPE,"UNIT")="" Q
"RTN","IBDF18E1",63,0)
 .S NODE=$G(^IBE(359.1,TYPE,0))
"RTN","IBDF18E1",64,0)
 .S PI(PI,"TYPE",TYPE,"UNIT")=$P(NODE,"^",13)
"RTN","IBDF18E1",65,0)
 .S PI(PI,"TYPE",TYPE,"VTYPE")=$P(NODE,"^",12)
"RTN","IBDF18E1",66,0)
 .S PI(PI,"TYPE",TYPE,"DATATYPE")=$P($G(^IBE(359.1,TYPE,10)),"^",1)
"RTN","IBDF18E1",67,0)
 ;
"RTN","IBDF18E1",68,0)
 ;if not VITALS, and there is a QLFR, get independent mapping info if not gotten previously
"RTN","IBDF18E1",69,0)
 I PI(PI,"NODE")'="VITALS",QLFR I '$D(PI(PI,QLFR,"IND")) D  Q:'PI ""
"RTN","IBDF18E1",70,0)
 .S PI(PI,QLFR,"CODE")=$P($G(^IBD(357.98,QLFR,0)),"^",2)
"RTN","IBDF18E1",71,0)
 .S IEN=$O(^IBE(357.6,PI,13,"B",QLFR_";IBD(357.98,",""))
"RTN","IBDF18E1",72,0)
 .I 'IEN D LOGERR^IBDF18E2(3576002,.FORMID,$G(TYPE),$G(VALUE),PI,$G(QLFR)) S PI(PI,QLFR,"IND")=0 Q
"RTN","IBDF18E1",73,0)
 .S NODE=$G(^IBE(357.6,PI,13,IEN,0))
"RTN","IBDF18E1",74,0)
 .S PI(PI,QLFR,"IND")=$P(NODE,"^",3)
"RTN","IBDF18E1",75,0)
 .Q:'PI(PI,QLFR,"IND")
"RTN","IBDF18E1",76,0)
 .S QNODE=$P(NODE,"^",4) S:QNODE="" QNODE=PI(PI,"NODE") S PI(PI,QLFR,"NODE")=QNODE
"RTN","IBDF18E1",77,0)
 .S PIECE=$P(NODE,"^",8) S:('PIECE)&(PI(PI,"NODE")=PI(PI,QLFR,"NODE")) PIECE=PI(PI,"QLFR") S PI(PI,QLFR,"QLFR")=PIECE
"RTN","IBDF18E1",78,0)
 .;
"RTN","IBDF18E1",79,0)
 .;if the node isn't different for the qualifier then the value,text,and header can not be mapped independently
"RTN","IBDF18E1",80,0)
 .I PI(PI,"NODE")=PI(PI,QLFR,"NODE") D
"RTN","IBDF18E1",81,0)
 ..S PI(PI,QLFR,"VAL")=PI(PI,"VAL"),PI(PI,QLFR,"TXT")=PI(PI,"TXT"),PI(PI,QLFR,"HDR")=PI(PI,"HDR")
"RTN","IBDF18E1",82,0)
 .E  S PI(PI,QLFR,"VAL")=$P(NODE,"^",5),PI(PI,QLFR,"TXT")=$P(NODE,"^",6),PI(PI,QLFR,"HDR")=$P(NODE,"^",7)
"RTN","IBDF18E1",83,0)
 .;must at least know the piece to place the returned value
"RTN","IBDF18E1",84,0)
 .I (PI(PI,QLFR,"NODE")="")!('PI(PI,QLFR,"VAL")) S PI=""
"RTN","IBDF18E1",85,0)
 ;
"RTN","IBDF18E1",86,0)
 ;must at least know the node and the piece to place the returned value
"RTN","IBDF18E1",87,0)
 I 'QLFR I (PI(PI,"NODE")="")!('PI(PI,"VAL")) S PI=""
"RTN","IBDF18E1",88,0)
GETPIQ Q PI
"RTN","IBDF18E1",89,0)
 ;
"RTN","IBDF18E1",90,0)
SETTEMP ;sets values for the field into TEMP() - values are merged for fields that consist of a collection
"RTN","IBDF18E1",91,0)
 ;
"RTN","IBDF18E1",92,0)
 ; -- Output   QCODE := <qualifier code>
"RTN","IBDF18E1",93,0)
 ;              PHDR := <header piece>
"RTN","IBDF18E1",94,0)
 ;              PVAL := <value piece>
"RTN","IBDF18E1",95,0)
 ;              PTXT := <text piece>
"RTN","IBDF18E1",96,0)
 ;             PQLFR := <qualifier piece>
"RTN","IBDF18E1",97,0)
 ;               SUB := <PCE GDI node>
"RTN","IBDF18E1",98,0)
 ;              NODE := <the value of the node>
"RTN","IBDF18E1",99,0)
 ;              PLEX := <clinical lexicon piece, for use with diag.>
"RTN","IBDF18E1",100,0)
 ;
"RTN","IBDF18E1",101,0)
 N QCODE,PHDR,PVAL,PTXT,PQLFR,SUB,NODE,PLEX,PQTY,SAVEPI
"RTN","IBDF18E1",102,0)
 S SAVEPI=PI
"RTN","IBDF18E1",103,0)
 Q:'PI
"RTN","IBDF18E1",104,0)
 S PI=$$GETPI(.PI,QLFR,TYPE) I 'PI D LOGERR^IBDF18E2(3576003,.FORMID,$G(TYPE),$G(VALUE),SAVEPI,$G(QLFR)) Q
"RTN","IBDF18E1",105,0)
 ;
"RTN","IBDF18E1",106,0)
 S QCODE=$S(QLFR:PI(PI,QLFR,"CODE"),1:"")
"RTN","IBDF18E1",107,0)
 ;
"RTN","IBDF18E1",108,0)
 ;determine if QCODE should be passed as VALUE
"RTN","IBDF18E1",109,0)
 I $P($G(^IBE(357.6,PI,20)),"^") N VALUE S VALUE=QCODE
"RTN","IBDF18E1",110,0)
 ;
"RTN","IBDF18E1",111,0)
 S PQTY=PI(PI,"QTY")
"RTN","IBDF18E1",112,0)
 ;mapping info could come from several different sources depending on whether or not a data qualifier is involved or the node=VITALS or ENCOUNTER
"RTN","IBDF18E1",113,0)
 I QLFR,PI(PI,"NODE")'="VITALS",PI(PI,"NODE")'="ENCOUNTER" I PI(PI,QLFR,"IND") D
"RTN","IBDF18E1",114,0)
 .S PHDR=PI(PI,QLFR,"HDR"),PVAL=PI(PI,QLFR,"VAL"),PTXT=PI(PI,QLFR,"TXT"),PQLFR=PI(PI,QLFR,"QLFR"),SUB=PI(PI,QLFR,"NODE")
"RTN","IBDF18E1",115,0)
 E  D
"RTN","IBDF18E1",116,0)
 .S PHDR=PI(PI,"HDR"),PVAL=PI(PI,"VAL"),PTXT=PI(PI,"TXT"),PQLFR=PI(PI,"QLFR"),SUB=PI(PI,"NODE")
"RTN","IBDF18E1",117,0)
 ;
"RTN","IBDF18E1",118,0)
 ;the ENCOUNTER node is treated differently, because there is always just one of them
"RTN","IBDF18E1",119,0)
 S:SUB'="ENCOUNTER" NODE=$G(TEMP(SUB,$P(FID,"("),+ITEM))
"RTN","IBDF18E1",120,0)
 S:SUB="ENCOUNTER" NODE=$G(PXCA("ENCOUNTER"))
"RTN","IBDF18E1",121,0)
 ;
"RTN","IBDF18E1",122,0)
 ; -- define clin lex pointer if from data enty  ($d(ibdf(item)))
"RTN","IBDF18E1",123,0)
 ;    if from scanning clin lex pointer defined in ibdf18e
"RTN","IBDF18E1",124,0)
 S PLEX=0 I SUB="DIAGNOSIS/PROBLEM" D
"RTN","IBDF18E1",125,0)
 .S PLEX=3
"RTN","IBDF18E1",126,0)
 .I $G(ITEM)'="" I $D(IBDF(ITEM)) S LEX=$P(IBDF(ITEM),"^",5)
"RTN","IBDF18E1",127,0)
 ;
"RTN","IBDF18E1",128,0)
 ;the VITALS node is also treated differently
"RTN","IBDF18E1",129,0)
 I SUB="VITALS" D
"RTN","IBDF18E1",130,0)
 .I $G(PI(PI,"TYPE",TYPE,"DATATYPE"))="f" S VALUE=+VALUE ; set floating point values to M values
"RTN","IBDF18E1",131,0)
 .S $P(NODE,"^")=PI(PI,"TYPE",TYPE,"VTYPE"),$P(NODE,"^",3)=PI(PI,"TYPE",TYPE,"UNIT"),$P(NODE,"^",2)=VALUE,$P(NODE,"^",4)=+$G(PXCA("ENCOUNTER"))
"RTN","IBDF18E1",132,0)
 ;these are nodes other than VITALS and ENCOUNTER
"RTN","IBDF18E1",133,0)
 E  D
"RTN","IBDF18E1",134,0)
 .;merge the data into the node
"RTN","IBDF18E1",135,0)
 .;
"RTN","IBDF18E1",136,0)
 .; -- for second provider entry put in provider node, always put
"RTN","IBDF18E1",137,0)
 .;    primary in encounter node
"RTN","IBDF18E1",138,0)
 .I SUB="ENCOUNTER",PVAL=4,$P(NODE,"^",4) D  Q
"RTN","IBDF18E1",139,0)
 ..I QCODE="P",$P(NODE,"^",15)'="P" S PXCA("PROVIDER",$P(NODE,"^",4))=$P(NODE,"^",15),$P(NODE,"^",4)=VALUE,$P(NODE,"^",15)=QCODE Q
"RTN","IBDF18E1",140,0)
 ..S PXCA("PROVIDER",VALUE)=QCODE Q
"RTN","IBDF18E1",141,0)
 .;
"RTN","IBDF18E1",142,0)
 .S NARR=+$G(NARR) ; define Narr for manual data entry
"RTN","IBDF18E1",143,0)
 .I $P(NODE,"^",PVAL)="" S:$S(NARR=0:1,1:$P(FID,"(",2)'="N") $P(NODE,"^",PVAL)=VALUE
"RTN","IBDF18E1",144,0)
 .I PTXT S:$P(FID,"(",2)="N"&NARR TEXT=VALUE I $S(NARR=0:$L($P(NODE,"^",PTXT))<$L(TEXT),$P(FID,"(",2)="N":TEXT'="",1:0) S $P(NODE,"^",PTXT)=TEXT
"RTN","IBDF18E1",145,0)
 .I PHDR I $L($P(NODE,"^",PHDR))<$L(HEADER) S $P(NODE,"^",PHDR)=HEADER
"RTN","IBDF18E1",146,0)
 .I PQTY S $P(NODE,"^",PQTY)=$G(QUANTITY)
"RTN","IBDF18E1",147,0)
 .;
"RTN","IBDF18E1",148,0)
 .; -- insert clin lex pointer into temp arry and re-initialize
"RTN","IBDF18E1",149,0)
 .I $G(PLEX),$G(LEX) S $P(NODE,"^",PLEX)=LEX
"RTN","IBDF18E1",150,0)
 .S LEX=0
"RTN","IBDF18E1",151,0)
 .;
"RTN","IBDF18E1",152,0)
 .I QCODE'="" S $P(NODE,"^",PQLFR)=$S($P(NODE,"^",PQLFR)'="":$P(NODE,"^",PQLFR)_","_QCODE,1:QCODE)
"RTN","IBDF18E1",153,0)
 S:SUB'="ENCOUNTER" TEMP(SUB,$P(FID,"("),+ITEM)=NODE
"RTN","IBDF18E1",154,0)
 S:SUB="ENCOUNTER" PXCA(SUB)=NODE
"RTN","IBDF18E1",155,0)
 Q
"RTN","IBDF1B1")
0^11^B22470828
"RTN","IBDF1B1",1,0)
IBDF1B1 ;ALB/CJM - ENCOUNTER FORM PRINT (IBDF1B continued - print encounter forms for selected appts); 3/1/93
"RTN","IBDF1B1",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDF1B1",3,0)
 ;
"RTN","IBDF1B1",4,0)
 N IBDEVICE,IBQUIT
"RTN","IBDF1B1",5,0)
 ;
"RTN","IBDF1B1",6,0)
 K DA,D0,X,Y,I
"RTN","IBDF1B1",7,0)
 ;
"RTN","IBDF1B1",8,0)
 ;set the error trap so workspace in ^TMP is erased in case of abnormal termination of the print job
"RTN","IBDF1B1",9,0)
 S X="ERRORTRP^IBDF1B",@^%ZOSF("TRAP")
"RTN","IBDF1B1",10,0)
 ;
"RTN","IBDF1B1",11,0)
 S IBQUIT=0
"RTN","IBDF1B1",12,0)
 D DEVICE^IBDFUA(0,.IBDEVICE)
"RTN","IBDF1B1",13,0)
 D:$D(^TMP("IBDF",$J,"D")) ENDV^IBDF1B1B D:$D(^TMP("IBDF",$J,"C")) ENCL^IBDF1B1A
"RTN","IBDF1B1",14,0)
 K ^TMP("EARL",$J),^TMP("MULT",$J)
"RTN","IBDF1B1",15,0)
 D ENPT
"RTN","IBDF1B1",16,0)
 D KPRNTVAR^IBDFUA
"RTN","IBDF1B1",17,0)
 K ^TMP("IBDF",$J),^TMP("IB",$J),^TMP("EARL",$J),^TMP("MULT",$J),DA,D0,X,Y,I,IBI
"RTN","IBDF1B1",18,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","IBDF1B1",19,0)
 Q
"RTN","IBDF1B1",20,0)
ENPT ;print encounter forms for each appt
"RTN","IBDF1B1",21,0)
 ;input ^TMP(  - contains appointment data:
"RTN","IBDF1B1",22,0)
 ;if IBSRT=1 format is ^TMP("IBDF",$J,"P",division name,clinic name,clinic ien,patient name,dfn,appt)=""
"RTN","IBDF1B1",23,0)
 ;if IBSRT=2 format is^TMP("IBDF",$J,"P",division name,terminal digits,dfn,appt)=clinic ien
"RTN","IBDF1B1",24,0)
 ;if IBSRT=3 format is ^TMP("IBDF",$J,"P",division name,clinic name,clinic ien,terminal digits,dfn,appt)=""
"RTN","IBDF1B1",25,0)
 N DFN,CLNCNAME,IBCLINIC,PNAME,TDIGIT,IBAPPT,IBDIV
"RTN","IBDF1B1",26,0)
 ;IBCLINIC=ien of clinic
"RTN","IBDF1B1",27,0)
 ;IBSTRTDV is the division to start from in the case of a reprint
"RTN","IBDF1B1",28,0)
 ;IBREPRNT is the clinic or terminal digits (1st 4) to start from in case of a reprint
"RTN","IBDF1B1",29,0)
 ;
"RTN","IBDF1B1",30,0)
 S IBDIV="" F  S IBDIV=$O(^TMP("IBDF",$J,"P",IBDIV)) Q:IBQUIT!(IBDIV="")  D:(IBDIV=" ")!(IBSTRTDV']IBDIV)
"RTN","IBDF1B1",31,0)
 .I IBSRT=2,IBDIV]" " W !,"DIVISION: ",IBDIV,@IOF
"RTN","IBDF1B1",32,0)
 .D:IBSRT=1 SORT1
"RTN","IBDF1B1",33,0)
 .D:IBSRT=2 SORT2
"RTN","IBDF1B1",34,0)
 .D:IBSRT=3 SORT3
"RTN","IBDF1B1",35,0)
 D:'IBQUIT TRLR
"RTN","IBDF1B1",36,0)
 Q
"RTN","IBDF1B1",37,0)
 ;
"RTN","IBDF1B1",38,0)
SORT1 ;case of sort by div/clinic/patient
"RTN","IBDF1B1",39,0)
 S CLNCNAME=""
"RTN","IBDF1B1",40,0)
 ;check if report was restarted, start is after this clinic
"RTN","IBDF1B1",41,0)
 I IBREPRNT]"" I ((IBDIV=" ")!(IBDIV=IBSTRTDV)) S CLNCNAME=$E(IBREPRNT,1,$L(IBREPRNT)-1)
"RTN","IBDF1B1",42,0)
 F  S CLNCNAME=$O(^TMP("IBDF",$J,"P",IBDIV,CLNCNAME)) Q:CLNCNAME=""!IBQUIT  S IBCLINIC="" F  S IBCLINIC=$O(^TMP("IBDF",$J,"P",IBDIV,CLNCNAME,IBCLINIC)) Q:'IBCLINIC!IBQUIT  D
"RTN","IBDF1B1",43,0)
 .D HDRPG($P($G(^SC(IBCLINIC,0)),"^"),IBDIV)
"RTN","IBDF1B1",44,0)
 .S PNAME="" F  S PNAME=$O(^TMP("IBDF",$J,"P",IBDIV,CLNCNAME,IBCLINIC,PNAME)) Q:PNAME=""!IBQUIT  S DFN="" F  S DFN=$O(^TMP("IBDF",$J,"P",IBDIV,CLNCNAME,IBCLINIC,PNAME,DFN)) Q:'DFN!IBQUIT  D
"RTN","IBDF1B1",45,0)
 ..S IBAPPT="" F  S IBAPPT=$O(^TMP("IBDF",$J,"P",IBDIV,CLNCNAME,IBCLINIC,PNAME,DFN,IBAPPT)) Q:'(+IBAPPT)!IBQUIT  D APPT($G(IBDIV),$G(CLNCNAME),$G(IBCLINIC),$G(PNAME),$G(DFN),$G(IBAPPT))
"RTN","IBDF1B1",46,0)
 Q
"RTN","IBDF1B1",47,0)
SORT2 ;case of sort by div/terminal digit
"RTN","IBDF1B1",48,0)
 S TDIGIT=""
"RTN","IBDF1B1",49,0)
 ;check if report was restarted, start is after this terminal digit
"RTN","IBDF1B1",50,0)
 I IBREPRNT]"" I ((IBDIV=" ")!(IBDIV=IBSTRTDV)) S TDIGIT=IBREPRNT
"RTN","IBDF1B1",51,0)
 F  S TDIGIT=$O(^TMP("IBDF",$J,"P",IBDIV,TDIGIT)) Q:TDIGIT=""!IBQUIT  D
"RTN","IBDF1B1",52,0)
 .S DFN="" F  S DFN=$O(^TMP("IBDF",$J,"P",IBDIV,TDIGIT,DFN)) Q:'DFN!IBQUIT  D
"RTN","IBDF1B1",53,0)
 ..S IBAPPT="" F  S IBAPPT=$O(^TMP("IBDF",$J,"P",IBDIV,TDIGIT,DFN,IBAPPT)) Q:'+IBAPPT!IBQUIT  D
"RTN","IBDF1B1",54,0)
 ...S IBCLINIC=$G(^TMP("IBDF",$J,"P",IBDIV,TDIGIT,DFN,IBAPPT)) Q:'IBCLINIC!IBQUIT  D APPT($G(IBDIV),$G(CLNCNAME),$G(IBCLINIC),$G(PNAME),$G(DFN),$G(IBAPPT),$G(TDIGIT))
"RTN","IBDF1B1",55,0)
 Q
"RTN","IBDF1B1",56,0)
SORT3 ;case of sort by div/clinic/terminal digits
"RTN","IBDF1B1",57,0)
 S CLNCNAME=""
"RTN","IBDF1B1",58,0)
 ;check if report was restarted, start is after this CLINIC
"RTN","IBDF1B1",59,0)
 I IBREPRNT]"" I ((IBDIV=" ")!(IBDIV=IBSTRTDV)) S CLNCNAME=$E(IBREPRNT,1,$L(IBREPRNT)-1)
"RTN","IBDF1B1",60,0)
 F  S CLNCNAME=$O(^TMP("IBDF",$J,"P",IBDIV,CLNCNAME)) Q:CLNCNAME=""!IBQUIT  S IBCLINIC="" F  S IBCLINIC=$O(^TMP("IBDF",$J,"P",IBDIV,CLNCNAME,IBCLINIC)) Q:'IBCLINIC!IBQUIT  D
"RTN","IBDF1B1",61,0)
 .D HDRPG($P($G(^SC(IBCLINIC,0)),"^"),IBDIV)
"RTN","IBDF1B1",62,0)
 .S TDIGIT="" F  S TDIGIT=$O(^TMP("IBDF",$J,"P",IBDIV,CLNCNAME,IBCLINIC,TDIGIT)) Q:TDIGIT=""!IBQUIT  S DFN="" F  S DFN=$O(^TMP("IBDF",$J,"P",IBDIV,CLNCNAME,IBCLINIC,TDIGIT,DFN)) Q:'DFN!IBQUIT  D
"RTN","IBDF1B1",63,0)
 ..S IBAPPT="" F  S IBAPPT=$O(^TMP("IBDF",$J,"P",IBDIV,CLNCNAME,IBCLINIC,TDIGIT,DFN,IBAPPT)) Q:'(+IBAPPT)!IBQUIT  D APPT($G(IBDIV),$G(CLNCNAME),$G(IBCLINIC),$G(PNAME),$G(DFN),$G(IBAPPT),$G(TDIGIT))
"RTN","IBDF1B1",64,0)
 Q
"RTN","IBDF1B1",65,0)
 ;
"RTN","IBDF1B1",66,0)
APPT(IBDIV,CLNCNAME,IBCLINIC,PNAME,DFN,IBAPPT,TDIGIT) ;print everything for single appt
"RTN","IBDF1B1",67,0)
 ;input - DFN,IBAPPT,IBCLINIC
"RTN","IBDF1B1",68,0)
 I $$S^%ZTLOAD S (ZTSTOP,IBQUIT)=1 W !,"TASK STOPPED AT USER'S REQUEST" Q
"RTN","IBDF1B1",69,0)
 D PRNTFRMS^IBDF1B2
"RTN","IBDF1B1",70,0)
 D PRNTOTHR^IBDF1B5(IBCLINIC,IBAPPT,DFN)
"RTN","IBDF1B1",71,0)
 I $D(^DPT(DFN,"S",IBAPPT,0)) S $P(^DPT(DFN,"S",IBAPPT,0),"^",21)=1 S:IBADDONS $P(^DPT(DFN,"S",IBAPPT,0),"^",22)=1
"RTN","IBDF1B1",72,0)
 Q
"RTN","IBDF1B1",73,0)
 ;
"RTN","IBDF1B1",74,0)
HDRPG(CLINIC,IBDIV) ;print a header page for clinic
"RTN","IBDF1B1",75,0)
 N LN
"RTN","IBDF1B1",76,0)
 S LN="BEGINNING TO PRINT ENCOUNTER FORMS FOR "_CLINIC_$S(IBDIV'=" ":" IN "_IBDIV,1:"")_" on "_$E(IBDT,4,5)_"/"_$E(IBDT,6,7)_"/"_$E(IBDT,2,3)
"RTN","IBDF1B1",77,0)
 I $Y W @IOF
"RTN","IBDF1B1",78,0)
 W !!!!!,?((IOM-$L(LN))\2),LN
"RTN","IBDF1B1",79,0)
 W @IOF
"RTN","IBDF1B1",80,0)
 W !!
"RTN","IBDF1B1",81,0)
 Q
"RTN","IBDF1B1",82,0)
TRLR ;prints a trailer page
"RTN","IBDF1B1",83,0)
 N LN
"RTN","IBDF1B1",84,0)
 S LN="PRINTING OF ENCOUNTER FORMS IS COMPLETE"_" for "_$E(IBDT,4,5)_"/"_$E(IBDT,6,7)_"/"_$E(IBDT,2,3)
"RTN","IBDF1B1",85,0)
 W !!!!!,?((IOM-$L(LN))\2),LN
"RTN","IBDF1B1",86,0)
 W @IOF
"RTN","IBDF1B1",87,0)
 Q
"RTN","IBDF1B1",88,0)
EARLIEST(DFN,APPT) ;determines if APPT is the earliest appt on the list for DFN
"RTN","IBDF1B1",89,0)
 D GETLIST^IBDF1B1A(DFN,IBDT,DIVISION)
"RTN","IBDF1B1",90,0)
 I APPT=$O(^TMP("IBDF",$J,"APPT LIST",DFN,""))
"RTN","IBDF1B1",91,0)
 Q $T
"RTN","IBDF2F")
0^7^B52537513
"RTN","IBDF2F",1,0)
IBDF2F ;ALB/CJM - ENCOUNTER FORM - PRINT FORM(sends to printer) ;NOV 16,1992
"RTN","IBDF2F",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDF2F",3,0)
 ;
"RTN","IBDF2F",4,0)
LNPRINT(IBPFID) ;prints the form
"RTN","IBDF2F",5,0)
 ;IBPFID is the id for form tracking
"RTN","IBDF2F",6,0)
 ;
"RTN","IBDF2F",7,0)
 N CURY,CURX,NXTTXT,NXTX,LINE,NXTUL,PERPAGE,STRING,STARTY,PAGE
"RTN","IBDF2F",8,0)
 S PAGE=1
"RTN","IBDF2F",9,0)
 ;
"RTN","IBDF2F",10,0)
 ;determine if simplex or duplex
"RTN","IBDF2F",11,0)
 ;
"RTN","IBDF2F",12,0)
 D
"RTN","IBDF2F",13,0)
 .I IBFORM("PRINT_MODE")="DUPLEX_LONG",IBDEVICE("DUPLEX_LONG")]"" W IBDEVICE("DUPLEX_LONG") Q
"RTN","IBDF2F",14,0)
 .I IBFORM("PRINT_MODE")="DUPLEX_SHORT",IBDEVICE("DUPLEX_SHORT")]"" W IBDEVICE("DUPLEX_SHORT") Q
"RTN","IBDF2F",15,0)
 .I IBDEVICE("SIMPLEX")]"" W IBDEVICE("SIMPLEX") Q
"RTN","IBDF2F",16,0)
 .I $Y W @IOF
"RTN","IBDF2F",17,0)
 ;
"RTN","IBDF2F",18,0)
 S PERPAGE=IBFORM("PAGE_HT")
"RTN","IBDF2F",19,0)
 I 'PERPAGE!(PERPAGE>IOSL) S PERPAGE=IOSL
"RTN","IBDF2F",20,0)
 S NXTUL=$O(@IBARRAY("UNDERLINES")@("")),NXTTXT=$O(@IBARRAY("TEXT")@(""))
"RTN","IBDF2F",21,0)
 S STARTY=""
"RTN","IBDF2F",22,0)
 S:NXTTXT'="" LINE=$G(@IBARRAY("TEXT")@(NXTTXT))
"RTN","IBDF2F",23,0)
 ;
"RTN","IBDF2F",24,0)
 ;want this rectangular fill area to apply to underlining
"RTN","IBDF2F",25,0)
 W:IBDEVICE("PCL") $C(27)_"*c35G"
"RTN","IBDF2F",26,0)
 ;
"RTN","IBDF2F",27,0)
 D REGISTER^IBDF2F1(PAGE)
"RTN","IBDF2F",28,0)
 F CURY=0:1 D  I NXTUL'>0,NXTTXT'>0 Q
"RTN","IBDF2F",29,0)
 .I (CURY>0)&('(CURY#PERPAGE)) D
"RTN","IBDF2F",30,0)
 ..I ((NXTTXT'="")!(NXTUL'="")) D
"RTN","IBDF2F",31,0)
 ...D:IBDEVICE("GRAPHICS")&('IBDEVICE("PCL")) PGRPHCS(.STARTY,CURY)
"RTN","IBDF2F",32,0)
 ...D:IBDEVICE("PCL") DRAW(.STARTY,CURY),WHITEOUT
"RTN","IBDF2F",33,0)
 ...W:$G(IBDEVICE("TCP")) ! ;if TCP device must use ! to get to TOF
"RTN","IBDF2F",34,0)
 ...W:'$G(IBDEVICE("TCP")) @IOF
"RTN","IBDF2F",35,0)
 ...S PAGE=PAGE+1
"RTN","IBDF2F",36,0)
 ...D REGISTER^IBDF2F1(PAGE)
"RTN","IBDF2F",37,0)
 .E  I (CURY#PERPAGE) W !
"RTN","IBDF2F",38,0)
 .I CURY=NXTTXT D
"RTN","IBDF2F",39,0)
 ..S CURX=0,NXTX="" F  S NXTX=$O(@IBARRAY("CONTROLS")@(NXTTXT,NXTX)) Q:NXTX=""  D
"RTN","IBDF2F",40,0)
 ...W $E(LINE,+CURX,NXTX),$$CTRLS^IBDFU($G(@IBARRAY("CONTROLS")@(NXTTXT,NXTX)),NXTX,NXTTXT#PERPAGE)
"RTN","IBDF2F",41,0)
 ...S CURX=NXTX+1
"RTN","IBDF2F",42,0)
 ..S STRING=$E(LINE,CURX,240) W:STRING'="" STRING
"RTN","IBDF2F",43,0)
 ..S NXTTXT=$O(@IBARRAY("TEXT")@(NXTTXT)) S:NXTTXT LINE=$G(@IBARRAY("TEXT")@(NXTTXT))
"RTN","IBDF2F",44,0)
 .I CURY=NXTUL D UNDRLINE
"RTN","IBDF2F",45,0)
 ;
"RTN","IBDF2F",46,0)
 ;draw stuff requiring graphics mode - obsoleted by PCL, if available
"RTN","IBDF2F",47,0)
 D:IBDEVICE("GRAPHICS")&('IBDEVICE("PCL")) PGRPHCS(STARTY,0)
"RTN","IBDF2F",48,0)
 ;
"RTN","IBDF2F",49,0)
 ;draw boxes,bubbles, etc. that require PCL
"RTN","IBDF2F",50,0)
 D:IBDEVICE("PCL") DRAW(STARTY,0),WHITEOUT
"RTN","IBDF2F",51,0)
 ;
"RTN","IBDF2F",52,0)
 W:'$G(IBDEVICE("TCP")) @IOF
"RTN","IBDF2F",53,0)
 ;go back to simplex
"RTN","IBDF2F",54,0)
 D
"RTN","IBDF2F",55,0)
 .I IBFORM("PRINT_MODE")="DUPLEX_LONG",IBDEVICE("DUPLEX_LONG")]"",IBDEVICE("SIMPLEX")]"" W IBDEVICE("SIMPLEX") Q
"RTN","IBDF2F",56,0)
 .I IBFORM("PRINT_MODE")="DUPLEX_SHORT",IBDEVICE("DUPLEX_SHORT")]"",IBDEVICE("SIMPLEX")]"" W IBDEVICE("SIMPLEX")
"RTN","IBDF2F",57,0)
 ;
"RTN","IBDF2F",58,0)
 ;set the printer for other stuff to print
"RTN","IBDF2F",59,0)
 S X=IOM X $G(^%ZOSF("RM")) K X ;sets device to wrap
"RTN","IBDF2F",60,0)
 ;set the printer to 132 col for everything else to print
"RTN","IBDF2F",61,0)
 I IBDEVICE("PCL") D
"RTN","IBDF2F",62,0)
 .W $C(27),"E"
"RTN","IBDF2F",63,0)
 .I $G(IBDEVICE("RESET"))'="" W @IBDEVICE("RESET")
"RTN","IBDF2F",64,0)
 .W $C(27),"(s0p16.67h8.5v0s0b0T",!,$C(27),"&l6C" S IOSL=80
"RTN","IBDF2F",65,0)
 Q
"RTN","IBDF2F",66,0)
 ;
"RTN","IBDF2F",67,0)
UNDRLINE ;
"RTN","IBDF2F",68,0)
 Q:IBDEVICE("CRT")
"RTN","IBDF2F",69,0)
 N UL
"RTN","IBDF2F",70,0)
 S UL=$G(@IBARRAY("UNDERLINES")@(NXTUL))
"RTN","IBDF2F",71,0)
 I 'IBDEVICE("PCL") D
"RTN","IBDF2F",72,0)
 .W:UL'="" $C(13),UL
"RTN","IBDF2F",73,0)
 ;do it a bit differently if IBDEVICE("PCL")
"RTN","IBDF2F",74,0)
 I IBDEVICE("PCL") D
"RTN","IBDF2F",75,0)
 .W:UL'="" $C(13),$C(27)_"*v2t1n0O",UL,$C(27)_"*v0T"
"RTN","IBDF2F",76,0)
 .;!!!!!!!!! with the area fill command - needed? see above
"RTN","IBDF2F",77,0)
 .;W:UL'="" $C(13),$C(27)_"*c35G",$C(27)_"*v2t1n0O",UL,$C(27)_"*v0T"
"RTN","IBDF2F",78,0)
 S NXTUL=$O(@IBARRAY("UNDERLINES")@(NXTUL))
"RTN","IBDF2F",79,0)
 Q
"RTN","IBDF2F",80,0)
PGRPHCS(STARTY,LASTY) ;print graphics - only for raster devices
"RTN","IBDF2F",81,0)
 N DX,DY,GRPHCS,LINE
"RTN","IBDF2F",82,0)
 W IOG1
"RTN","IBDF2F",83,0)
 S (DX,DY)=0 X IOXY
"RTN","IBDF2F",84,0)
 S LINE=STARTY F  S LINE=$O(@IBARRAY("GRAPHICS")@(LINE)) Q:(LINE="")!($G(LASTY)&(LINE'<LASTY))  D
"RTN","IBDF2F",85,0)
 .S DX="" F  S DX=$O(@IBARRAY("GRAPHICS")@(LINE,DX)) Q:DX=""  S GRPHCS=$G(@IBARRAY("GRAPHICS")@(LINE,DX)),GRPHCS=$$GRPHCS^IBDFU(GRPHCS) I GRPHCS'="" S DY=LINE#PERPAGE W ! X IOXY W GRPHCS
"RTN","IBDF2F",86,0)
 S STARTY=LASTY-1
"RTN","IBDF2F",87,0)
 W IOG0
"RTN","IBDF2F",88,0)
 Q
"RTN","IBDF2F",89,0)
 ;
"RTN","IBDF2F",90,0)
DRAW(STARTY,LASTY) ; draws the objects needing HP-GL/2 
"RTN","IBDF2F",91,0)
 N ROW,COL,BLK,NODE,WIDTH,HT,IEN,PRNTTYPE
"RTN","IBDF2F",92,0)
 W $C(27),"*p0x0Y"
"RTN","IBDF2F",93,0)
 W $C(27),"*c5760x7200Y"
"RTN","IBDF2F",94,0)
 W $C(27),"*c0T"
"RTN","IBDF2F",95,0)
 W $C(27),"%1B"
"RTN","IBDF2F",96,0)
 W "IN;SP1;"
"RTN","IBDF2F",97,0)
 W "SC0,5760,7200,0;" ;sets up the coordinate system same as PCL
"RTN","IBDF2F",98,0)
 W "AD3,16.6;" ;sets the alternate font for the labels
"RTN","IBDF2F",99,0)
 ;
"RTN","IBDF2F",100,0)
 ;draw bubbles
"RTN","IBDF2F",101,0)
 ;W "SV1,30;" ;set fill to 30%
"RTN","IBDF2F",102,0)
 ;W "PW.15;" ;set pen width to .15 mm
"RTN","IBDF2F",103,0)
 W "PW.12;" ;set pen width to .12 mm
"RTN","IBDF2F",104,0)
 W "SV1,25;" ;set fill to 25%
"RTN","IBDF2F",105,0)
 S ROW=STARTY
"RTN","IBDF2F",106,0)
 F  S ROW=$O(@IBARRAY("BUBBLES")@(ROW)) Q:(ROW="")!($G(LASTY)&(ROW'<LASTY))  S COL="" F  S COL=$O(@IBARRAY("BUBBLES")@(ROW,COL)) Q:COL=""  D DRWBBL(ROW#PERPAGE,COL)
"RTN","IBDF2F",107,0)
 ;
"RTN","IBDF2F",108,0)
 ;draw boxes
"RTN","IBDF2F",109,0)
 W "PW.4;" ;set pen width to .4 mm
"RTN","IBDF2F",110,0)
 ;set the fill to 100%
"RTN","IBDF2F",111,0)
 W "SV1,100;"
"RTN","IBDF2F",112,0)
 S ROW=STARTY
"RTN","IBDF2F",113,0)
 F  S ROW=$O(@IBARRAY("BOXES")@(ROW)) Q:(ROW="")!($G(LASTY)&(ROW'<(LASTY)))  S COL="" F  S COL=$O(@IBARRAY("BOXES")@(ROW,COL)) Q:COL=""  S BLK=0 F  S BLK=$O(@IBARRAY("BOXES")@(ROW,COL,BLK)) Q:'BLK  D
"RTN","IBDF2F",114,0)
 .S NODE=$G(@IBARRAY("BOXES")@(ROW,COL,BLK)) S WIDTH=$P(NODE,"^"),HT=$P(NODE,"^",2) D DRWBOX(ROW#PERPAGE,COL,WIDTH,HT)
"RTN","IBDF2F",115,0)
 ;
"RTN","IBDF2F",116,0)
 ;draw hand print fields
"RTN","IBDF2F",117,0)
 ;W "PW.15;" ;set pen width to .15 mm
"RTN","IBDF2F",118,0)
 ;W "SV1,30;" ;set the fill to 30%
"RTN","IBDF2F",119,0)
 W "PW.12;" ;set pen width to .12 mm
"RTN","IBDF2F",120,0)
 W "SV1,25;" ;set the fill to 25%
"RTN","IBDF2F",121,0)
 S ROW=STARTY
"RTN","IBDF2F",122,0)
 F  S ROW=$O(@IBARRAY("HAND_PRINT")@(ROW)) Q:(ROW="")!($G(LASTY)&(ROW'<LASTY))  S COL="" F  S COL=$O(@IBARRAY("HAND_PRINT")@(ROW,COL)) Q:COL=""  S IEN=0 F  S IEN=$O(@IBARRAY("HAND_PRINT")@(ROW,COL,IEN)) Q:'IEN  D
"RTN","IBDF2F",123,0)
 .S NODE=$G(@IBARRAY("HAND_PRINT")@(ROW,COL,IEN)),WIDTH=+$P(NODE,"^",3),PRNTTYPE=$P(NODE,"^",14) Q:('WIDTH)!('PRNTTYPE)
"RTN","IBDF2F",124,0)
 .D HANDPRNT(ROW#PERPAGE,COL,WIDTH,$P(NODE,"^",6),PRNTTYPE,$P(NODE,"^",17))
"RTN","IBDF2F",125,0)
 ;
"RTN","IBDF2F",126,0)
 S STARTY=LASTY-1
"RTN","IBDF2F",127,0)
 W $C(27),"%0A"
"RTN","IBDF2F",128,0)
 Q
"RTN","IBDF2F",129,0)
 ;
"RTN","IBDF2F",130,0)
DRWBBL(Y,X) ;
"RTN","IBDF2F",131,0)
 ;position is in terms of col,row - change to decipoints
"RTN","IBDF2F",132,0)
 S Y=(Y*IBDEVICE("ROW_HT"))+$S(IBFORM("WIDTH")>96:20,IBFORM("WIDTH")>80:30,1:40),X=(X+$S(IBFORM("WIDTH")>96:.5,IBFORM("WIDTH")>80:.75,1:1))*IBDEVICE("COL_WIDTH")
"RTN","IBDF2F",133,0)
 ;
"RTN","IBDF2F",134,0)
 ;position the pen
"RTN","IBDF2F",135,0)
 W "PA"_(X)_","_(Y)_";"
"RTN","IBDF2F",136,0)
 ;draw the bubble (a little box)
"RTN","IBDF2F",137,0)
 W "EA"_(X+87)_","_(Y+45)_";"
"RTN","IBDF2F",138,0)
 Q
"RTN","IBDF2F",139,0)
DRWBOX(Y,X,WIDTH,HT) ;
"RTN","IBDF2F",140,0)
 ;position is in terms of col,row - change to decipoints
"RTN","IBDF2F",141,0)
 S Y=((Y+.75)*IBDEVICE("ROW_HT"))+15,X=(X+.5)*IBDEVICE("COL_WIDTH")
"RTN","IBDF2F",142,0)
 ;position the pen
"RTN","IBDF2F",143,0)
 W "PA"_(X)_","_(Y)_";"
"RTN","IBDF2F",144,0)
 ;draw the box
"RTN","IBDF2F",145,0)
 W "EA"_(X+((WIDTH-1)*IBDEVICE("COL_WIDTH")))_","_(Y+((HT-1.7)*IBDEVICE("ROW_HT")))_";"
"RTN","IBDF2F",146,0)
 Q
"RTN","IBDF2F",147,0)
HANDPRNT(Y,X,WIDTH,LINES,PRNTTYPE,TYPEDATA) ; draw hand print area
"RTN","IBDF2F",148,0)
 ;FORMAT - contains overlay for the field
"RTN","IBDF2F",149,0)
 ;UNIT - label to print on the right of print area
"RTN","IBDF2F",150,0)
 ;PRNTTYPE = could be for ICR (print comb) or not ICR (no comb, different size)
"RTN","IBDF2F",151,0)
 N CHAR,FORMAT,UNIT,NODE
"RTN","IBDF2F",152,0)
 S NODE=""
"RTN","IBDF2F",153,0)
 I $G(TYPEDATA) S NODE=$G(^IBE(359.1,TYPEDATA,0))
"RTN","IBDF2F",154,0)
 S FORMAT=$P(NODE,"^",5),UNIT=$P(NODE,"^",11)
"RTN","IBDF2F",155,0)
 S:LINES'>0 LINES=1
"RTN","IBDF2F",156,0)
 I PRNTTYPE=2 D
"RTN","IBDF2F",157,0)
 .;change scale from col,row to decipoints
"RTN","IBDF2F",158,0)
 .S Y=(Y*IBDEVICE("ROW_HT"))+$S(IBFORM("WIDTH")>96:0,IBFORM("WIDTH")>80:15,1:30),X=X*IBDEVICE("COL_WIDTH")
"RTN","IBDF2F",159,0)
 .F  Q:LINES'>0  D  S LINES=LINES-1,Y=Y+(2*IBDEVICE("ROW_HT"))
"RTN","IBDF2F",160,0)
 ..;position the pen
"RTN","IBDF2F",161,0)
 ..W !,"PA"_(X)_","_(Y)_";"
"RTN","IBDF2F",162,0)
 ..;draw the box
"RTN","IBDF2F",163,0)
 ..W "EA"_(X+(172.7654*WIDTH))_","_(Y+(180))_";"
"RTN","IBDF2F",164,0)
 ..;print the unit of measurement
"RTN","IBDF2F",165,0)
 ..I $L(UNIT) W "SA;","PA"_(X+50+(172.7654*WIDTH))_",",(Y+(120))_";","LB",UNIT,$CHAR(3),"SS;"
"RTN","IBDF2F",166,0)
 ..;draw the comb
"RTN","IBDF2F",167,0)
 ..N I F I=1:1:WIDTH-1 W "PA"_(X+(172.7654*I))_",",(Y+(180))_";PD;PR0,-180;PU" S CHAR=$E(FORMAT,I+1) I CHAR'="",CHAR'="_" D
"RTN","IBDF2F",168,0)
 ...;character pre-slug
"RTN","IBDF2F",169,0)
 ...W !,"PA"_(X+50+(172.7654*I))_",",(Y+(120))_";"
"RTN","IBDF2F",170,0)
 ...W "LB",CHAR,$CHAR(3)
"RTN","IBDF2F",171,0)
 ;
"RTN","IBDF2F",172,0)
 I PRNTTYPE=1 D
"RTN","IBDF2F",173,0)
 .;change scale from col,row to decipoints
"RTN","IBDF2F",174,0)
 .S Y=(Y*IBDEVICE("ROW_HT")),X=X*IBDEVICE("COL_WIDTH")
"RTN","IBDF2F",175,0)
 .D CNVRTHT^IBDF2D1(LINES,.LINES)
"RTN","IBDF2F",176,0)
 .;position the pen
"RTN","IBDF2F",177,0)
 .W "PA"_(X)_","_(Y)_";"
"RTN","IBDF2F",178,0)
 .;draw the box
"RTN","IBDF2F",179,0)
 .W "EA"_(X+(103.6593*WIDTH))_","_(Y+(IBDEVICE("ROW_HT")*LINES))_";"
"RTN","IBDF2F",180,0)
 Q
"RTN","IBDF2F",181,0)
 ;
"RTN","IBDF2F",182,0)
WHITEOUT ;puts white space around the anchors - helps insure that the anchors can be located
"RTN","IBDF2F",183,0)
 ;
"RTN","IBDF2F",184,0)
 ;if the form isn't scannable there are no anchor marks
"RTN","IBDF2F",185,0)
 Q:'IBFORM("SCAN")
"RTN","IBDF2F",186,0)
 ;
"RTN","IBDF2F",187,0)
 W $C(27),"&a0v0H",! ;set top margin to top of page
"RTN","IBDF2F",188,0)
 W $C(27),"&l0E"
"RTN","IBDF2F",189,0)
 ;top left corner (ANCHOR 1)
"RTN","IBDF2F",190,0)
 W $C(27),"&a354v4H",$C(27),"*c200h60v1P"
"RTN","IBDF2F",191,0)
 ;top middle (ANCHOR 2)
"RTN","IBDF2F",192,0)
 ;W $C(27),"&a354v2676H",$C(27),"*c400h60v1P"
"RTN","IBDF2F",193,0)
 ;bottom left (ANCHOR 4)
"RTN","IBDF2F",194,0)
 W $C(27),"&a7505v4H",$C(27),"*c200h60v1P"
"RTN","IBDF2F",195,0)
 ;top right (ANCHOR 3)
"RTN","IBDF2F",196,0)
 W $C(27),"&a354v5450H",$C(27),"*c400h60v1P"
"RTN","IBDF2F",197,0)
 ;bottom middle (ANCHOR 5)
"RTN","IBDF2F",198,0)
 ;W $C(27),"&a7505v2676H",$C(27),"*c400h60v1P"
"RTN","IBDF2F",199,0)
 ;bottom right (ANCHOR 6)
"RTN","IBDF2F",200,0)
 W $C(27),"&a7505v5450H",$C(27),"*c400h60v1P"
"RTN","IBDF2F",201,0)
 Q
"RTN","IBDF2F1")
0^8^B14792298
"RTN","IBDF2F1",1,0)
IBDF2F1 ;ALB/CJM - ENCOUNTER FORM - PRINT FORM(sends to printer) ;NOV 16,1992
"RTN","IBDF2F1",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDF2F1",3,0)
 ;
"RTN","IBDF2F1",4,0)
REGISTER(PAGE) ;registration for scanning, form # and patient at bottom
"RTN","IBDF2F1",5,0)
 N PAGECHK,TYPECHK,IDCHK,VA
"RTN","IBDF2F1",6,0)
 I IBDEVICE("PCL") D
"RTN","IBDF2F1",7,0)
 .I IBFORM("SCAN") D
"RTN","IBDF2F1",8,0)
 ..;calculate the checksums
"RTN","IBDF2F1",9,0)
 ..S PAGECHK=(3*PAGE)#29,TYPECHK=(3*IBFORM("TYPE"))#997,IDCHK=(3*(+$G(IBPFID)))#997
"RTN","IBDF2F1",10,0)
 .;set top margin to top of page
"RTN","IBDF2F1",11,0)
 .W $C(27),"&l0E"
"RTN","IBDF2F1",12,0)
 .W $C(27),"&a0v0H",!
"RTN","IBDF2F1",13,0)
 .;
"RTN","IBDF2F1",14,0)
 .I IBFORM("SCAN") D ANCHORS^IBDF2F2
"RTN","IBDF2F1",15,0)
 .;
"RTN","IBDF2F1",16,0)
 .;I $G(IBFORM("SCAN",PAGE)) D
"RTN","IBDF2F1",17,0)
 .; -- black box used to determine if page has data for scanning
"RTN","IBDF2F1",18,0)
 .;    but not for sample forms
"RTN","IBDF2F1",19,0)
 .;I '$G(IBDSAMP) W $C(27),"&a7576v3400H",$C(27),"&f1y2X",$C(27)
"RTN","IBDF2F1",20,0)
 .;I '$G(IBDSAMP) W $C(27),"&a7576v3400H",$C(27),"*c140h140v0P",$C(27)
"RTN","IBDF2F1",21,0)
 .;
"RTN","IBDF2F1",22,0)
 .;define font for OCR'd text
"RTN","IBDF2F1",23,0)
 .W $C(27),")s1p10h14v0s0b3T"
"RTN","IBDF2F1",24,0)
 .;define font for non-OCR' text
"RTN","IBDF2F1",25,0)
 .W $C(27)_"(s0p16.67h8.5v0s0b0T"
"RTN","IBDF2F1",26,0)
 .;print the form identifiers
"RTN","IBDF2F1",27,0)
 .W $C(27),"&a330h300V",! ; new line needed to get rest of line to print okay
"RTN","IBDF2F1",28,0)
 .W ! ; new line needed to get rest of line to print okay
"RTN","IBDF2F1",29,0)
 .W $C(27),"&a330h300V",$C(15),"FORM:",$C(27),"&a650H",$C(14),IBFORM("TYPE")
"RTN","IBDF2F1",30,0)
 .W $C(27),"&a1470H",$C(15),"ID:",$C(27),"&a1700H",$C(14),$G(IBPFID)
"RTN","IBDF2F1",31,0)
 .W $C(27),"&a4830H",$C(15),"PAGE:",$C(27),"&a5150H",$C(14),PAGE
"RTN","IBDF2F1",32,0)
 .;
"RTN","IBDF2F1",33,0)
 .;is the page going to be scanned?
"RTN","IBDF2F1",34,0)
 .I $G(IBFORM("SCAN",PAGE)),$G(IBPFID) D
"RTN","IBDF2F1",35,0)
 ..;Populating the scannable pages field in the forms tracking file
"RTN","IBDF2F1",36,0)
 ..;#357.96.   This is used when scanning the EF to make sure all
"RTN","IBDF2F1",37,0)
 ..;scannable pages have been scanned before data is filed in PCE.
"RTN","IBDF2F1",38,0)
 ..I '$D(^IBD(357.96,IBPFID,9,PAGE,0)) D
"RTN","IBDF2F1",39,0)
 ...S DIC="^IBD(357.96,IBPFID,9,",DIC(0)="L",DIC("P")=$P(^DD(357.96,9,0),"^",2),DA(1)=IBPFID,X=PAGE,DLAYGO=357.96 K DD,DO D FILE^DICN K DIC,DA,DLAYGO,DD,DO
"RTN","IBDF2F1",40,0)
 ..;print the checksums
"RTN","IBDF2F1",41,0)
 ..W $C(14),$C(27),"&a3400H",TYPECHK,$C(27),"&a3900H",IDCHK,$C(27),"&a4400H",PAGECHK
"RTN","IBDF2F1",42,0)
 .;
"RTN","IBDF2F1",43,0)
NAM .;print form id, etc. on bottom of form
"RTN","IBDF2F1",44,0)
 .D
"RTN","IBDF2F1",45,0)
 ..W !,$C(15),$C(27),"&a300h7710V"
"RTN","IBDF2F1",46,0)
 ..I $G(IBDSAMP) W "Sample Form: ",$P($G(^IBE(357,+$G(IBFORM),0)),"^") Q
"RTN","IBDF2F1",47,0)
 ..S X=$G(^TMP("IB",$J,"INTERFACES",+$G(DFN),"DPT PATIENT'S NAME"))
"RTN","IBDF2F1",48,0)
 ..W:X'="" X W:X="" $P($G(^DPT(+$G(DFN),0)),"^")
"RTN","IBDF2F1",49,0)
 .;
"RTN","IBDF2F1",50,0)
 .D
"RTN","IBDF2F1",51,0)
 ..W $C(27),"&a1900H"
"RTN","IBDF2F1",52,0)
 ..I $G(IBDSAMP) W "Clinic: ",$P($G(^SC(+$G(IBCLINIC),0)),"^") Q
"RTN","IBDF2F1",53,0)
 ..S X=$G(^TMP("IB",$J,"INTERFACES",+$G(DFN),"DPT PATIENT'S PID"))
"RTN","IBDF2F1",54,0)
 ..W:X'="" X I X="",+$G(DFN) D PID^VADPT W VA("PID")
"RTN","IBDF2F1",55,0)
 .;
"RTN","IBDF2F1",56,0)
 .W $C(27),"&a4200H","VA FORM 10-0360  APR 1994"
"RTN","IBDF2F1",57,0)
 .W $C(27),"&a4200h7620V","Station: ",$P($$SITE^VASITE,"^",3)
"RTN","IBDF2F1",58,0)
 .I $G(REPRINT) W $C(27),"&a1900H","**REPRINT**"
"RTN","IBDF2F1",59,0)
 .;
"RTN","IBDF2F1",60,0)
 .;reset the primary font & top margin, position cursor at the top
"RTN","IBDF2F1",61,0)
 .;reset the font for body of form
"RTN","IBDF2F1",62,0)
 .D
"RTN","IBDF2F1",63,0)
 ..I IBFORM("WIDTH")>96 W $C(27)_"(s0p16.67h8.5v0s0b0T" Q
"RTN","IBDF2F1",64,0)
 ..I IBFORM("WIDTH")>80 W $C(27)_"(s0p12h10v0s0b0T" Q
"RTN","IBDF2F1",65,0)
 ..W $C(27)_"(s0p10h12v0s0b0T"
"RTN","IBDF2F1",66,0)
 .;set top margin to leave 4 lines at top
"RTN","IBDF2F1",67,0)
 .W $C(27),"&l4E"
"RTN","IBDF2F1",68,0)
 .;set cursor to top left
"RTN","IBDF2F1",69,0)
 .W $C(27),"&a0c0R"
"RTN","IBDF2F1",70,0)
 ;
"RTN","IBDF2F1",71,0)
 ;move cursor to top left
"RTN","IBDF2F1",72,0)
 I '(IBFORM("SCAN")&IBDEVICE("PCL")),IBDEVICE("RASTER") S (DX,DY)=0 X IOXY K DX,DY
"RTN","IBDF2F1",73,0)
 Q
"RTN","IBDF2F1",74,0)
 ;
"RTN","IBDF2F1",75,0)
 ;this call replaced by call to achors^ibdf2f2
"RTN","IBDF2F1",76,0)
ANCHORS ; -- print anchors, anchors composed of two narrow rectangles
"RTN","IBDF2F1",77,0)
 ;    escape &a positions cursor at specified vert and horiz decipoints
"RTN","IBDF2F1",78,0)
 ;    escape *c prints rectangle of specified vert and horiz decipoints
"RTN","IBDF2F1",79,0)
 ;           0P is for complete fill.
"RTN","IBDF2F1",80,0)
 ;
"RTN","IBDF2F1",81,0)
 Q
"RTN","IBDF2F1",82,0)
 W !
"RTN","IBDF2F1",83,0)
 ; -- top left corner (ANCHOR 1)
"RTN","IBDF2F1",84,0)
 W $C(27),"&a184v4H",$C(27),"*c12h120v0P",$C(27),"*c124h12v0P"
"RTN","IBDF2F1",85,0)
 ;
"RTN","IBDF2F1",86,0)
 ; -- top right (ANCHOR 3)
"RTN","IBDF2F1",87,0)
 W $C(27),"&a184v5534H",$C(27),"*c116h12v0P",$C(27),"&a184v5650H",$C(27),"*c12h120v0P"
"RTN","IBDF2F1",88,0)
 ;
"RTN","IBDF2F1",89,0)
 ; -- bottom left (ANCHOR 4)
"RTN","IBDF2F1",90,0)
 W !,$C(27),"&a7732v4H",$C(27),"*c124h12v0P",$C(27),"&a7615v4H",$C(27),"*c12h121v0P"
"RTN","IBDF2F1",91,0)
 ;
"RTN","IBDF2F1",92,0)
 ; -- bottom right (ANCHOR 6)
"RTN","IBDF2F1",93,0)
 W $C(27),"&a7732v5534H",$C(27),"*c116h12v0P",$C(27),"&a7616v5650H",$C(27),"*c12h120v0P"
"RTN","IBDF2F1",94,0)
 Q
"RTN","IBDF2F2")
0^9^B15381752
"RTN","IBDF2F2",1,0)
IBDF2F2 ;ALB/AAS - PRINT VA LOGO AS ANCHORS ON ENCOUNTER FORMS ; 25-JUNE-97
"RTN","IBDF2F2",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDF2F2",3,0)
 ;
"RTN","IBDF2F2",4,0)
ANCHORS ; -- print anchors, 
"RTN","IBDF2F2",5,0)
 ;    escape &a positions cursor at specified vert and horiz decipoints
"RTN","IBDF2F2",6,0)
 ;    escape &f1y2X prints macro #1
"RTN","IBDF2F2",7,0)
 ;
"RTN","IBDF2F2",8,0)
 ; -- old anchors composed of two narrow rectangles
"RTN","IBDF2F2",9,0)
 ;    escape *c prints rectangle of specified vert and horiz decipoints
"RTN","IBDF2F2",10,0)
 ;           0P is for complete fill.
"RTN","IBDF2F2",11,0)
 ;
"RTN","IBDF2F2",12,0)
 D MACRO
"RTN","IBDF2F2",13,0)
 ;
"RTN","IBDF2F2",14,0)
 ; -- top left corner (ANCHOR 1)
"RTN","IBDF2F2",15,0)
 W !,$C(27),"&a184v4H",$C(27),"&f1y2X"
"RTN","IBDF2F2",16,0)
 ;
"RTN","IBDF2F2",17,0)
 ; -- top right (ANCHOR 3)
"RTN","IBDF2F2",18,0)
 W !,$C(27),"&a184v5534H",$C(27),"&f1y2X"
"RTN","IBDF2F2",19,0)
 ;
"RTN","IBDF2F2",20,0)
 ; -- bottom left (ANCHOR 4)
"RTN","IBDF2F2",21,0)
 W !,$C(27),"&a7615v4H",$C(27),"&f1y2X"
"RTN","IBDF2F2",22,0)
 ;
"RTN","IBDF2F2",23,0)
 ; -- scannable page
"RTN","IBDF2F2",24,0)
 I $G(IBFORM("SCAN",PAGE)),'$G(IBDSAMP) W $C(27),"&a7576v3400H",$C(27),"&f1y2X"
"RTN","IBDF2F2",25,0)
 ;
"RTN","IBDF2F2",26,0)
 ;bottom right (ANCHOR 6)
"RTN","IBDF2F2",27,0)
 W $C(27),"&a7615v5534H",$C(27),"&f1y2X"
"RTN","IBDF2F2",28,0)
 Q
"RTN","IBDF2F2",29,0)
 ;
"RTN","IBDF2F2",30,0)
MACRO ; -- build macro for printing va logo
"RTN","IBDF2F2",31,0)
 ; -- position cursor before printing macro
"RTN","IBDF2F2",32,0)
 W $C(27),"&f1Y" ; define marco as #1
"RTN","IBDF2F2",33,0)
 W !
"RTN","IBDF2F2",34,0)
 W $C(27),"&f0X" ; start macro definition
"RTN","IBDF2F2",35,0)
 D VALOGO
"RTN","IBDF2F2",36,0)
 W $C(27),"&f1X" ; stop macro definition
"RTN","IBDF2F2",37,0)
 W !
"RTN","IBDF2F2",38,0)
 W $C(27),"&f1y10X" ; make macro permanent, still defined after reset
"RTN","IBDF2F2",39,0)
 Q
"RTN","IBDF2F2",40,0)
 ;
"RTN","IBDF2F2",41,0)
VALOGO ; -- Raster Graphic print of VA LOGO
"RTN","IBDF2F2",42,0)
 ; -- position curser before calling directly
"RTN","IBDF2F2",43,0)
 W $C(27),"*t150R" ;      raster graphics at (75,150,or 300) dots per inch
"RTN","IBDF2F2",44,0)
 W $C(27),"*r0F" ;       presentation mode orientation of logical page
"RTN","IBDF2F2",45,0)
 W $C(27),"*r1A" ;       sets the left graphics margin to current x
"RTN","IBDF2F2",46,0)
 ; -- begin raster data
"RTN","IBDF2F2",47,0)
1 W $C(27),"*b5W",$C(3),$C(224),$C(15),$C(248),$C(0)
"RTN","IBDF2F2",48,0)
2 W $C(27),"*b5W",$C(7),$C(240),$C(15),$C(248),$C(0)
"RTN","IBDF2F2",49,0)
3 W $C(27),"*b5W",$C(15),$C(240),$C(31),$C(252),$C(0)
"RTN","IBDF2F2",50,0)
4 ;W $C(27),"*b5W",$C(15),$C(248),$C(31),$C(252),$C(0)
"RTN","IBDF2F2",51,0)
5 W $C(27),"*b5W",$C(15),$C(248),$C(31),$C(254),$C(0)
"RTN","IBDF2F2",52,0)
6 W $C(27),"*b5W",$C(31),$C(252),$C(63),$C(254),$C(0)
"RTN","IBDF2F2",53,0)
7 W $C(27),"*b5W",$C(31),$C(252),$C(63),$C(255),$C(0)
"RTN","IBDF2F2",54,0)
8 W $C(27),"*b5W",$C(32),$C(254),$C(112),$C(63),$C(0)
"RTN","IBDF2F2",55,0)
9 W $C(27),"*b5W",$C(32),$C(254),$C(112),$C(63),$C(128)
"RTN","IBDF2F2",56,0)
10 W $C(27),"*b5W",$C(96),$C(126),$C(112),$C(31),$C(128)
"RTN","IBDF2F2",57,0)
11 W $C(27),"*b5W",$C(112),$C(127),$C(224),$C(15),$C(192)
"RTN","IBDF2F2",58,0)
12 W $C(27),"*b5W",$C(240),$C(127),$C(224),$C(15),$C(192)
"RTN","IBDF2F2",59,0)
13 W $C(27),"*b5W",$C(248),$C(63),$C(193),$C(7),$C(224)
"RTN","IBDF2F2",60,0)
14 W $C(27),"*b5W",$C(252),$C(63),$C(193),$C(7),$C(224)
"RTN","IBDF2F2",61,0)
15 W $C(27),"*b5W",$C(252),$C(31),$C(195),$C(131),$C(240)
"RTN","IBDF2F2",62,0)
16 W $C(27),"*b5W",$C(126),$C(15),$C(195),$C(131),$C(240)
"RTN","IBDF2F2",63,0)
17 W $C(27),"*b5W",$C(126),$C(15),$C(131),$C(131),$C(240)
"RTN","IBDF2F2",64,0)
18 W $C(27),"*b5W",$C(63),$C(7),$C(135),$C(193),$C(248)
"RTN","IBDF2F2",65,0)
19 W $C(27),"*b5W",$C(63),$C(3),$C(135),$C(193),$C(248)
"RTN","IBDF2F2",66,0)
20 W $C(27),"*b5W",$C(31),$C(131),$C(7),$C(224),$C(252)
"RTN","IBDF2F2",67,0)
21 W $C(27),"*b5W",$C(31),$C(129),$C(15),$C(224),$C(252)
"RTN","IBDF2F2",68,0)
22 W $C(27),"*b5W",$C(15),$C(193),$C(15),$C(240),$C(124)
"RTN","IBDF2F2",69,0)
23 W $C(27),"*b5W",$C(15),$C(192),$C(12),$C(0),$C(120)
"RTN","IBDF2F2",70,0)
24 W $C(27),"*b5W",$C(7),$C(224),$C(30),$C(0),$C(120)
"RTN","IBDF2F2",71,0)
25 W $C(27),"*b5W",$C(7),$C(224),$C(30),$C(0),$C(56)
"RTN","IBDF2F2",72,0)
26 W $C(27),"*b5W",$C(3),$C(240),$C(63),$C(0),$C(48)
"RTN","IBDF2F2",73,0)
27 W $C(27),"*b5W",$C(3),$C(240),$C(63),$C(0),$C(16)
"RTN","IBDF2F2",74,0)
28 W $C(27),"*b5W",$C(1),$C(255),$C(255),$C(255),$C(240)
"RTN","IBDF2F2",75,0)
29 W $C(27),"*b5W",$C(1),$C(255),$C(255),$C(255),$C(224)
"RTN","IBDF2F2",76,0)
30 W $C(27),"*b5W",$C(0),$C(255),$C(255),$C(255),$C(224)
"RTN","IBDF2F2",77,0)
31 W $C(27),"*b5W",$C(0),$C(255),$C(239),$C(255),$C(192)
"RTN","IBDF2F2",78,0)
32 ;W $C(27),"*b5W",$C(0),$C(127),$C(239),$C(255),$C(192)
"RTN","IBDF2F2",79,0)
33 W $C(27),"*b5W",$C(0),$C(127),$C(199),$C(255),$C(128)
"RTN","IBDF2F2",80,0)
34 W $C(27),"*b5W",$C(0),$C(63),$C(131),$C(255),$C(128)
"RTN","IBDF2F2",81,0)
 W $C(27),"*rB" ;        signifies the end of the raster graphic
"RTN","IBDF2F2",82,0)
 Q
"RTN","IBDF2F2",83,0)
 ;
"RTN","IBDF2F2",84,0)
TESTM ; -- Test macro printing
"RTN","IBDF2F2",85,0)
 S PAGE=1,IBFORM("SCAN",PAGE)=1,IBDSAMP=0
"RTN","IBDF2F2",86,0)
 D ^%ZIS G:POP END
"RTN","IBDF2F2",87,0)
 U IO
"RTN","IBDF2F2",88,0)
 ;
"RTN","IBDF2F2",89,0)
 ; -- sets top of page
"RTN","IBDF2F2",90,0)
 W $C(27),"&l0E"
"RTN","IBDF2F2",91,0)
 W !
"RTN","IBDF2F2",92,0)
 D ANCHORS
"RTN","IBDF2F2",93,0)
END D ^%ZISC
"RTN","IBDF2F2",94,0)
 K PAGE,IBDFORM,IBDSAMP
"RTN","IBDF2F2",95,0)
 Q
"RTN","IBDF2F2",96,0)
 ;
"RTN","IBDF2F2",97,0)
TESTD ; -- Test printing without macro
"RTN","IBDF2F2",98,0)
 S PAGE=1,IBFORM("SCAN",PAGE)=1,IBDSAMP=0
"RTN","IBDF2F2",99,0)
 D ^%ZIS G:POP END1
"RTN","IBDF2F2",100,0)
 U IO
"RTN","IBDF2F2",101,0)
 ;
"RTN","IBDF2F2",102,0)
 ; -- sets top of page
"RTN","IBDF2F2",103,0)
 W $C(27),"&l0E"
"RTN","IBDF2F2",104,0)
 W !
"RTN","IBDF2F2",105,0)
 D DIRECT
"RTN","IBDF2F2",106,0)
END1 D ^%ZISC
"RTN","IBDF2F2",107,0)
 K PAGE,IBFORM,IBDSAMP
"RTN","IBDF2F2",108,0)
 Q
"RTN","IBDF2F2",109,0)
DIRECT ; -- print logo direct without macros
"RTN","IBDF2F2",110,0)
 ; -- top left corner (ANCHOR 1)
"RTN","IBDF2F2",111,0)
 W !,$C(27),"&a184v4H",$C(27) D VALOGO
"RTN","IBDF2F2",112,0)
 ;
"RTN","IBDF2F2",113,0)
 ; -- top right (ANCHOR 3)
"RTN","IBDF2F2",114,0)
 W !,$C(27),"&a184v5534H" D VALOGO
"RTN","IBDF2F2",115,0)
 ;
"RTN","IBDF2F2",116,0)
 W !!!,"PRINTING ANCHORS DIRECTLY, NO MACRO"
"RTN","IBDF2F2",117,0)
 ;
"RTN","IBDF2F2",118,0)
 ; -- bottom left (ANCHOR 4)
"RTN","IBDF2F2",119,0)
 W !,$C(27),"&a7615v4H" D VALOGO
"RTN","IBDF2F2",120,0)
 ;
"RTN","IBDF2F2",121,0)
 ; -- scannable page
"RTN","IBDF2F2",122,0)
 I $G(IBFORM("SCAN",PAGE)),'$G(IBDSAMP) W $C(27),"&a7576v3400H" D VALOGO
"RTN","IBDF2F2",123,0)
 ;
"RTN","IBDF2F2",124,0)
 ;bottom right (ANCHOR 6)
"RTN","IBDF2F2",125,0)
 W $C(27),"&a7615v5534H" D VALOGO
"RTN","IBDF2F2",126,0)
 Q
"RTN","IBDFBKS1")
0^10^B59810208
"RTN","IBDFBKS1",1,0)
IBDFBKS1 ;ALB/CJM/AAS - ENCOUNTER FORM - create form spec for scanning (Broker Version CONTINUATION) ; 6-JUN-95
"RTN","IBDFBKS1",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDFBKS1",3,0)
 ;
"RTN","IBDFBKS1",4,0)
 ;
"RTN","IBDFBKS1",5,0)
FORM ;;
"RTN","IBDFBKS1",6,0)
 ;;'Paper Keyboard FormSpec
"RTN","IBDFBKS1",7,0)
 ;;'VERSION = 2.53
"RTN","IBDFBKS1",8,0)
 ;;'AICS Version 3.0;**7,3**
"RTN","IBDFBKS1",9,0)
 ;;INT hasprint;
"RTN","IBDFBKS1",10,0)
 ;;INT check;
"RTN","IBDFBKS1",11,0)
 ;;INT pfid;
"RTN","IBDFBKS1",12,0)
 ;;INT page;
"RTN","IBDFBKS1",13,0)
 ;;INT saveunrf;
"RTN","IBDFBKS1",14,0)
 ;;ALPHA narrative;
"RTN","IBDFBKS1",15,0)
 ;;
"RTN","IBDFBKS1",16,0)
 ;;FORM
"RTN","IBDFBKS1",17,0)
NAME ;;  NAME = "ENCOUNTER FORM 71";
"RTN","IBDFBKS1",18,0)
 ;;  AREA =  0 0 2810 2150;
"RTN","IBDFBKS1",19,0)
 ;;  PAGESIZE = " 2810 2150";
"RTN","IBDFBKS1",20,0)
 ;;  ANCHOR1 = NONE;
"RTN","IBDFBKS1",21,0)
 ;;  ANCHOR2 = NONE;
"RTN","IBDFBKS1",22,0)
 ;;  POINTS = 0 0 0 0;
"RTN","IBDFBKS1",23,0)
 ;;  CONFIDENCE = " 9";
"RTN","IBDFBKS1",24,0)
 ;;  DATEFORMAT = "6";
"RTN","IBDFBKS1",25,0)
 ;;  TIMEFORMAT = "5";
"RTN","IBDFBKS1",26,0)
 ;;  EXFORMAT = "STRIP";
"RTN","IBDFBKS1",27,0)
 ;;  FS = ",";
"RTN","IBDFBKS1",28,0)
 ;;  QUOTABLE = "\\n";
"RTN","IBDFBKS1",29,0)
 ;;  ImageProcessing = {
"RTN","IBDFBKS1",30,0)
 ;;     IMAGEPROC=1
"RTN","IBDFBKS1",31,0)
 ;;     AUTO_ALIGN=0
"RTN","IBDFBKS1",32,0)
 ;;     ALIGN_TEXT=0
"RTN","IBDFBKS1",33,0)
 ;;     ALIGN_ORIENT=0
"RTN","IBDFBKS1",34,0)
 ;;     DESKEW=0
"RTN","IBDFBKS1",35,0)
 ;;     DESHADE=0
"RTN","IBDFBKS1",36,0)
 ;;     SMOOTH=0
"RTN","IBDFBKS1",37,0)
 ;;     REMOVE_BORDER=1
"RTN","IBDFBKS1",38,0)
 ;;     REMOVE_NOISE=0
"RTN","IBDFBKS1",39,0)
 ;;     PROC_MIN_VERT_LINE_LEN=0
"RTN","IBDFBKS1",40,0)
 ;;     PROC_MIN_HORZ_LINE_LEN=0
"RTN","IBDFBKS1",41,0)
 ;;     FATTYPE=0
"RTN","IBDFBKS1",42,0)
 ;;     FATTEN=0};
"RTN","IBDFBKS1",43,0)
 ;;FIELD ' 1
"RTN","IBDFBKS1",44,0)
 ;;  NAME = "TOP LEFT ANCHOR";
"RTN","IBDFBKS1",45,0)
 ;;  ELEMTYPE = ELEM_PAT;
"RTN","IBDFBKS1",46,0)
 ;;  METRIC = 17 130 130;
"RTN","IBDFBKS1",47,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",48,0)
 ;;  LENGTH = 2;
"RTN","IBDFBKS1",49,0)
 ;;  POINTS = 65 70 120 130;
"RTN","IBDFBKS1",50,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",51,0)
 ;;  CONFIDENCE = " 6";
"RTN","IBDFBKS1",52,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",53,0)
 ;;  Pattern = "PATTERN=C:\\VISTA\\AICS\\FORMSPEC\\AICSLOGO.BMP";
"RTN","IBDFBKS1",54,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",55,0)
 ;;FIELD ' 2
"RTN","IBDFBKS1",56,0)
 ;;  NAME = "TOP RIGHT ANCHOR";
"RTN","IBDFBKS1",57,0)
 ;;  ELEMTYPE = ELEM_PAT;
"RTN","IBDFBKS1",58,0)
 ;;  METRIC = 17 130 130;
"RTN","IBDFBKS1",59,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",60,0)
 ;;  LENGTH = 2;
"RTN","IBDFBKS1",61,0)
 ;;  POINTS = 65 2015 120 2075;
"RTN","IBDFBKS1",62,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",63,0)
 ;;  CONFIDENCE = " 6";
"RTN","IBDFBKS1",64,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",65,0)
 ;;  Pattern = "PATTERN=C:\\VISTA\\AICS\\FORMSPEC\\AICSLOGO.BMP";
"RTN","IBDFBKS1",66,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",67,0)
 ;;FIELD ' 3
"RTN","IBDFBKS1",68,0)
 ;;  NAME = "BOTTOM LEFT ANCHOR";
"RTN","IBDFBKS1",69,0)
 ;;  ELEMTYPE = ELEM_PAT;
"RTN","IBDFBKS1",70,0)
 ;;  METRIC = 17 130 130;
"RTN","IBDFBKS1",71,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",72,0)
 ;;  LENGTH = 2;
"RTN","IBDFBKS1",73,0)
 ;;  POINTS = 2690 70 2745 130;
"RTN","IBDFBKS1",74,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",75,0)
 ;;  CONFIDENCE = " 6";
"RTN","IBDFBKS1",76,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",77,0)
 ;;  Pattern = "PATTERN=C:\\VISTA\\AICS\\FORMSPEC\\AICSLOGO.BMP";
"RTN","IBDFBKS1",78,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",79,0)
 ;;FIELD ' 4
"RTN","IBDFBKS1",80,0)
 ;;  NAME = "BOTTOM RIGHT ANCHOR";
"RTN","IBDFBKS1",81,0)
 ;;  ELEMTYPE = ELEM_PAT;
"RTN","IBDFBKS1",82,0)
 ;;  METRIC = 17 130 130;
"RTN","IBDFBKS1",83,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",84,0)
 ;;  LENGTH = 2;
"RTN","IBDFBKS1",85,0)
 ;;  POINTS = 2690 2015 2745 2075;
"RTN","IBDFBKS1",86,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",87,0)
 ;;  CONFIDENCE = " 6";
"RTN","IBDFBKS1",88,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",89,0)
 ;;  Pattern = "PATTERN=C:\\VISTA\\AICS\\FORMSPEC\\AICSLOGO.BMP";
"RTN","IBDFBKS1",90,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",91,0)
 ;;  END={INT aset;
"RTN","IBDFBKS1",92,0)
 ;;  aset = ANCHORSET(1,4);
"RTN","IBDFBKS1",93,0)
 ;;  if (aset = 0) SHOW(\"AICS thinks Paper Keyboard failed to find the Anchors\");    
"RTN","IBDFBKS1",94,0)
 ;;  };
"RTN","IBDFBKS1",95,0)
 ;;FIELD ' 5
"RTN","IBDFBKS1",96,0)
 ;;NAME = "SCANPAGE?";
"RTN","IBDFBKS1",97,0)
 ;;  ELEMTYPE = ELEM_PAT;
"RTN","IBDFBKS1",98,0)
 ;;  METRIC = 17 130 130;
"RTN","IBDFBKS1",99,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",100,0)
 ;;  LENGTH = 2;
"RTN","IBDFBKS1",101,0)
 ;;  POINTS = 2669 1264 2734 1344;
"RTN","IBDFBKS1",102,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",103,0)
 ;;  CONFIDENCE = " 7";
"RTN","IBDFBKS1",104,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",105,0)
 ;;  Pattern = "PATTERN=C:\\VISTA\\AICS\\FORMSPEC\\AICSLOGO.BMP";
"RTN","IBDFBKS1",106,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",107,0)
 ;;FIELD ' 6
"RTN","IBDFBKS1",108,0)
 ;;  NAME = "FORM ID CHECK";
"RTN","IBDFBKS1",109,0)
 ;;  ELEMTYPE = ELEM_OCR;
"RTN","IBDFBKS1",110,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",111,0)
 ;;  LENGTH = 3;
"RTN","IBDFBKS1",112,0)
 ;;  POINTS = 55 1412 130 1530;
"RTN","IBDFBKS1",113,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",114,0)
 ;;  CHARFORMAT = "NOSPACES";
"RTN","IBDFBKS1",115,0)
 ;;  END = {
"RTN","IBDFBKS1",116,0)
 ;;  check=GETIVALUE(FIELDNAME);};
"RTN","IBDFBKS1",117,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",118,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",119,0)
 ;;FIELD ' 7
"RTN","IBDFBKS1",120,0)
 ;;  NAME = "FORM ID";
"RTN","IBDFBKS1",121,0)
 ;;  ELEMTYPE = ELEM_OCR;
"RTN","IBDFBKS1",122,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",123,0)
 ;;  LENGTH = 9;
"RTN","IBDFBKS1",124,0)
 ;;  POINTS = 55 642 130 910;
"RTN","IBDFBKS1",125,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",126,0)
 ;;  CHARFORMAT = "NOSPACES";
"RTN","IBDFBKS1",127,0)
 ;;  END = {
"RTN","IBDFBKS1",128,0)
 ;;  INT checksum;
"RTN","IBDFBKS1",129,0)
 ;;  INT div;
"RTN","IBDFBKS1",130,0)
 ;;
"RTN","IBDFBKS1",131,0)
 ;;  pfid=GETIVALUE(FIELDNAME);
"RTN","IBDFBKS1",132,0)
 ;;  checksum=3*pfid;
"RTN","IBDFBKS1",133,0)
 ;;  div=checksum/997;
"RTN","IBDFBKS1",134,0)
 ;;  checksum=checksum-(div*997);
"RTN","IBDFBKS1",135,0)
 ;;  if ((checksum!=check)&&(FIELDACCEPTED!=1)) {
"RTN","IBDFBKS1",136,0)
 ;;  FIELDSTATUS=FIELD_BAD;
"RTN","IBDFBKS1",137,0)
 ;;  }
"RTN","IBDFBKS1",138,0)
 ;;};
"RTN","IBDFBKS1",139,0)
 ;;FIELD ' 8
"RTN","IBDFBKS1",140,0)
 ;;  NAME = "PAGE CHECK";
"RTN","IBDFBKS1",141,0)
 ;;  ELEMTYPE = ELEM_OCR;
"RTN","IBDFBKS1",142,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",143,0)
 ;;  LENGTH = 3;
"RTN","IBDFBKS1",144,0)
 ;;  POINTS = 55 1590 130 1700;
"RTN","IBDFBKS1",145,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",146,0)
 ;;  CHARFORMAT = "NOSPACES";
"RTN","IBDFBKS1",147,0)
 ;;  END = {
"RTN","IBDFBKS1",148,0)
 ;;  check=GETIVALUE(FIELDNAME);};
"RTN","IBDFBKS1",149,0)
 ;;  HIDDEN = "1";
"RTN","IBDFBKS1",150,0)
 ;;  REQUIRED = "1";
"RTN","IBDFBKS1",151,0)
 ;;FIELD ' 9
"RTN","IBDFBKS1",152,0)
 ;;  NAME = "PAGE";
"RTN","IBDFBKS1",153,0)
 ;;  ELEMTYPE = ELEM_OCR;
"RTN","IBDFBKS1",154,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",155,0)
 ;;  LENGTH = 1;
"RTN","IBDFBKS1",156,0)
 ;;  POINTS = 55 1848 130 1934;
"RTN","IBDFBKS1",157,0)
 ;;  PAGE = 0;
"RTN","IBDFBKS1",158,0)
 ;;  CHARFORMAT = "NOSPACES";
"RTN","IBDFBKS1",159,0)
 ;;  END = {INT  checksum;
"RTN","IBDFBKS1",160,0)
 ;;  INT div;
"RTN","IBDFBKS1",161,0)
 ;;  ALPHA next;
"RTN","IBDFBKS1",162,0)
 ;;
"RTN","IBDFBKS1",163,0)
 ;;  page=GETIVALUE(FIELDNAME);
"RTN","IBDFBKS1",164,0)
 ;;  next=STRCAT("TOP OF PAGE ",ITOA(page));
"RTN","IBDFBKS1",165,0)
 ;;  checksum=3*page;
"RTN","IBDFBKS1",166,0)
 ;;  div=checksum/997;
"RTN","IBDFBKS1",167,0)
 ;;  checksum=checksum-(div*997);
"RTN","IBDFBKS1",168,0)
 ;;
"RTN","IBDFBKS1",169,0)
 ;;  if ((checksum!=check)&&(FIELDACCEPTED!=1)) {
"RTN","IBDFBKS1",170,0)
 ;;  FIELDSTATUS=FIELD_BAD;
"RTN","IBDFBKS1",171,0)
 ;;  }
"RTN","IBDFBKS1",172,0)
PGCK ;;  else if ((page!=1)&&(page!=2)){
"RTN","IBDFBKS1",173,0)
 ;;  FIELDSTATUS=FIELD_BAD;
"RTN","IBDFBKS1",174,0)
 ;;  }
"RTN","IBDFBKS1",175,0)
 ;;  else if (page>1) {NEXTFIELD=GETNUM(next); }
"RTN","IBDFBKS1",176,0)
 ;;};
"RTN","IBDFBKS1",177,0)
QUIT ;;
"RTN","IBDFBKS1",178,0)
 ;;
"RTN","IBDFBKS1",179,0)
 ;;
"RTN","IBDFBKS1",180,0)
TOPOFPG ;;
"RTN","IBDFBKS1",181,0)
NUMBER1 ;;FIELD ' 49
"RTN","IBDFBKS1",182,0)
FLDNAME ;;  NAME = "TOP OF PAGE 2";
"RTN","IBDFBKS1",183,0)
 ;;  ELEMTYPE = RECT;
"RTN","IBDFBKS1",184,0)
 ;;  METRIC = 2 2 0 0 0 0 0 0 0;
"RTN","IBDFBKS1",185,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",186,0)
 ;;  LENGTH = 1;
"RTN","IBDFBKS1",187,0)
 ;;  POINTS = 100 2040;
"RTN","IBDFBKS1",188,0)
PAGE1 ;;  PAGE = 1;
"RTN","IBDFBKS1",189,0)
 ;;  HIDDEN="1";
"RTN","IBDFBKS1",190,0)
 ;;  EXFORMAT="NOEXPORT";
"RTN","IBDFBKS1",191,0)
QUIT1 ;;
"RTN","IBDFBKS1",192,0)
 ;;
"RTN","IBDFBKS1",193,0)
BOTTOM ;;
"RTN","IBDFBKS1",194,0)
NUMBER2 ;;FIELD ' 49
"RTN","IBDFBKS1",195,0)
NAME2 ;;  NAME = "BOTTOM OF PAGE";
"RTN","IBDFBKS1",196,0)
 ;;  ELEMTYPE = RECT;
"RTN","IBDFBKS1",197,0)
 ;;  METRIC = 2 2 0 0 0 0 0 0 0;
"RTN","IBDFBKS1",198,0)
 ;;  DATATYPE =INT;
"RTN","IBDFBKS1",199,0)
 ;;  LENGTH = 1;
"RTN","IBDFBKS1",200,0)
 ;;  POINTS = 100 2040;
"RTN","IBDFBKS1",201,0)
PAGE2 ;;  PAGE = 1;
"RTN","IBDFBKS1",202,0)
 ;;  HIDDEN="1";
"RTN","IBDFBKS1",203,0)
 ;;END = {INT result;
"RTN","IBDFBKS1",204,0)
 ;;INT ddechan;
"RTN","IBDFBKS1",205,0)
 ;;INT loop;
"RTN","IBDFBKS1",206,0)
 ;;ALPHA Data;
"RTN","IBDFBKS1",207,0)
 ;;ALPHA str;
"RTN","IBDFBKS1",208,0)
 ;;ALPHA  RS;
"RTN","IBDFBKS1",209,0)
 ;;ALPHA Save;
"RTN","IBDFBKS1",210,0)
 ;;ALPHA New;
"RTN","IBDFBKS1",211,0)
 ;;ALPHA Add;
"RTN","IBDFBKS1",212,0)
 ;;ALPHA End;
"RTN","IBDFBKS1",213,0)
 ;;
"RTN","IBDFBKS1",214,0)
 ;;New=\"$$NEW$$("\;
"RTN","IBDFBKS1",215,0)
 ;;Add=\"$$ADD$$("\;
"RTN","IBDFBKS1",216,0)
 ;;End=\"$$END$$("\;
"RTN","IBDFBKS1",217,0)
 ;;RS=STRCAT(",",ITOC(13));
"RTN","IBDFBKS1",218,0)
 ;;
"RTN","IBDFBKS1",219,0)
 ;;if (BATCH&&(saveunrf>0)){
"RTN","IBDFBKS1",220,0)
SAVE ;;  Save = \"SAVEFORM("\;
"RTN","IBDFBKS1",221,0)
 ;;  ddechan = DDEINIT(\"IBDSCAN\",\"DdeServerConv\");
"RTN","IBDFBKS1",222,0)
 ;;    if (ddechan==0) {
"RTN","IBDFBKS1",223,0)
 ;;       DIALOG(\"\", \"OK\", \"\",\"Unable to Open Channel to AICS to Export Data!\");
"RTN","IBDFBKS1",224,0)
 ;;       CHAIN(\"C:\\\\vista\\\\aics\\\\formspec\\\\AICSMSTR.FS\",1);
"RTN","IBDFBKS1",225,0)
 ;;       }
"RTN","IBDFBKS1",226,0)
 ;;  else {
"RTN","IBDFBKS1",227,0)
 ;;    result = DDEEXEC(ddechan,Save);
"RTN","IBDFBKS1",228,0)
 ;;    if (result==0) {
"RTN","IBDFBKS1",229,0)
 ;;       DIALOG(\"\", \"OK\", \"\", \"Warning: Saving of Unrecognized form in AICS has Failed!\");}
"RTN","IBDFBKS1",230,0)
 ;;     else {
"RTN","IBDFBKS1",231,0)
 ;;          DDEPOKE(ddechan,\"DdeServerItem\",\"Operator Verification Needed\");}
"RTN","IBDFBKS1",232,0)
 ;;    DDETERM(ddechan);
"RTN","IBDFBKS1",233,0)
 ;;    }
"RTN","IBDFBKS1",234,0)
 ;;  CHAIN(\"C:\\\\vista\\\\aics\\\\formspec\\\\AICSMSTR.FS\",1);}
"RTN","IBDFBKS1",235,0)
 ;;
"RTN","IBDFBKS1",236,0)
 ;;    ddechan=DDEINIT(\"IBDSCAN\",\"DdeServerConv\");
"RTN","IBDFBKS1",237,0)
 ;;    if (ddechan==0) {
"RTN","IBDFBKS1",238,0)
 ;;       DIALOG(\"\", \"OK\", \"\",\"Unable to Open Channel to AICS to Export Data!\");
"RTN","IBDFBKS1",239,0)
 ;;       CHAIN(\"c:\\\\vista\\\\aics\\\\formspec\\\\AICSMSTR.FS\",1);
"RTN","IBDFBKS1",240,0)
 ;;       }
"RTN","IBDFBKS1",241,0)
 ;;  else {
"RTN","IBDFBKS1",242,0)
EXPORT ;;      \'if (STRFIND(Data,RS,STRLEN(Data) - 1) > 0) {;;      \'    Data = SUBSTR(Data,1,STRLEN(Data) - 1); }
"RTN","IBDFBKS1",243,0)
 ;;       result=DDEPOKE(ddechan,\"DdeServerItem\",End);
"RTN","IBDFBKS1",244,0)
 ;;
"RTN","IBDFBKS1",245,0)
 ;;  DDETERM(ddechan);
"RTN","IBDFBKS1",246,0)
 ;;  }
"RTN","IBDFBKS1",247,0)
 ;;CHAIN(\"c:\\\\vista\\\\aics\\\\formspec\\\\AICSMSTR.FS\",1);
"RTN","IBDFBKS1",248,0)
 ;;};
"RTN","IBDFBKS1",249,0)
 ;;EXFORMAT="NOEXPORT";
"RTN","IBDFBKS1",250,0)
QUIT2 ;;
"RTN","IBDFBKS2")
0^2^B70773166
"RTN","IBDFBKS2",1,0)
IBDFBKS2 ;ALB/CJM/AAS - ENCOUNTER FORM - create form spec for scanning (Broker Version) ; 6-JUN-95 [ 11/13/96  5:25 PM ]
"RTN","IBDFBKS2",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDFBKS2",3,0)
 ;
"RTN","IBDFBKS2",4,0)
HANDPRNT(IEN,NAME,PAGE,ROW,COL,WIDTH,LINES,READTYPE,PAPKEY,PI) ;
"RTN","IBDFBKS2",5,0)
 ;there must be a package interface to handle the data
"RTN","IBDFBKS2",6,0)
 Q:('PI)
"RTN","IBDFBKS2",7,0)
 Q:($P($G(^IBE(357.6,PI,0)),"^",6)'=1)
"RTN","IBDFBKS2",8,0)
 ;
"RTN","IBDFBKS2",9,0)
 N X1,X2,Y1,Y2,W,PICTURE,TYPEDATA,NODE0,LENGTH,LINENUM,PKDICT,CONF,L,SUBPICS,FORMAT
"RTN","IBDFBKS2",10,0)
 S TYPEDATA="ALPHA",PICTURE=""
"RTN","IBDFBKS2",11,0)
 ; -- get info associated with DHCP Data Element
"RTN","IBDFBKS2",12,0)
 ;    (and not stored with form definition)
"RTN","IBDFBKS2",13,0)
 ; -- 9/28/95 moved file 359.1, pieces 0;3, 0;4, 0;8, 0;9 to
"RTN","IBDFBKS2",14,0)
 ;    to 10;1, 10;2, 10;3, 10;4 respectively
"RTN","IBDFBKS2",15,0)
 ;
"RTN","IBDFBKS2",16,0)
 I PAPKEY D
"RTN","IBDFBKS2",17,0)
 .S NODE0=$G(^IBE(359.1,PAPKEY,0)),NODE10=$G(^(10))
"RTN","IBDFBKS2",18,0)
 .S TYPEDATA=$P(NODE10,"^",1)
"RTN","IBDFBKS2",19,0)
 .S TYPEDATA=$S(TYPEDATA="a":"ALPHA",TYPEDATA="i":"INT",TYPEDATA="f":"FLOAT",TYPEDATA="t":"TIME",TYPEDATA="d":"DATE",1:"ALPHA")
"RTN","IBDFBKS2",20,0)
 .S PICTURE=$P(NODE10,"^",2)
"RTN","IBDFBKS2",21,0)
 .S FORMAT=$P(NODE0,"^",5)
"RTN","IBDFBKS2",22,0)
 .S LENGTH=$P(NODE0,"^",2)
"RTN","IBDFBKS2",23,0)
 .S CONF=$P(NODE0,"^",7)
"RTN","IBDFBKS2",24,0)
 .S PKDICT=$P(NODE10,"^",3)
"RTN","IBDFBKS2",25,0)
 .S SUBPICS=$P(NODE10,"^",4)
"RTN","IBDFBKS2",26,0)
 ;
"RTN","IBDFBKS2",27,0)
 ;find top left-hand corner
"RTN","IBDFBKS2",28,0)
 S X1=((COL*COLWIDTH)+XOFFSET)*CONVERT,X1=$FN(X1,"",0)
"RTN","IBDFBKS2",29,0)
 S Y1=((ROW*ROWHT)+YOFFSET+YHANDOS)*CONVERT,Y1=$FN(Y1,"",0)
"RTN","IBDFBKS2",30,0)
 ;
"RTN","IBDFBKS2",31,0)
 ;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1
"RTN","IBDFBKS2",32,0)
 ;ALSO MUST DO THIS IF TYPE = 1!!!!!!!!!!!!!!!!! BUT SCALE IT
"RTN","IBDFBKS2",33,0)
 I READTYPE=3 D
"RTN","IBDFBKS2",34,0)
 .;define some marksense fields - if any marked it means there is print!
"RTN","IBDFBKS2",35,0)
 .S FIELD=FIELD+1
"RTN","IBDFBKS2",36,0)
 .D BLDARY^IBDFBKS("FIELD ' "_FIELD)
"RTN","IBDFBKS2",37,0)
 .D BLDARY^IBDFBKS("  NAME = """_NAME_"?"";")
"RTN","IBDFBKS2",38,0)
 .D BLDARY^IBDFBKS("  ELEMTYPE = RECT;")
"RTN","IBDFBKS2",39,0)
 .D BLDARY^IBDFBKS("  METRIC = 40 40 0 0 0 0 1 0 1;")
"RTN","IBDFBKS2",40,0)
 .D BLDARY^IBDFBKS("  TYPEDATA = INT;")
"RTN","IBDFBKS2",41,0)
 .D BLDARY^IBDFBKS("  LENGTH = ",LENGTH,";")
"RTN","IBDFBKS2",42,0)
 .D BLDARY^IBDFBKS("  POINTS =")
"RTN","IBDFBKS2",43,0)
 .F L=1:1:LINES F W=1:1:WIDTH D
"RTN","IBDFBKS2",44,0)
 ..S X2=X1+((((W-1)*172.7645)+30)*CONVERT),X2=$FN(X2,"",0)
"RTN","IBDFBKS2",45,0)
 ..S Y2=Y1+(((L*180)-39)*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",46,0)
 ..S IBDFSA(IBLC)=IBDFSA(IBLC)_" "_Y2+1_" "_X2+1
"RTN","IBDFBKS2",47,0)
 .S IBDFSA(IBLC)=IBDFSA(IBLC)_";"
"RTN","IBDFBKS2",48,0)
 .D BLDARY^IBDFBKS("  PAGE = ",PAGE,";")
"RTN","IBDFBKS2",49,0)
 .D BLDARY^IBDFBKS("  CONFIDENCE = "" 0"";")
"RTN","IBDFBKS2",50,0)
 .D BLDARY^IBDFBKS("  END = {if (FIELDSTATUS != FIELD_BLANK){")
"RTN","IBDFBKS2",51,0)
 .D BLDARY^IBDFBKS("    hasprint=1;")
"RTN","IBDFBKS2",52,0)
 .D BLDARY^IBDFBKS("    FIELDSTATUS=FIELD_BAD;")
"RTN","IBDFBKS2",53,0)
 .D BLDARY^IBDFBKS("  }")
"RTN","IBDFBKS2",54,0)
 .D BLDARY^IBDFBKS("  else {")
"RTN","IBDFBKS2",55,0)
 .D BLDARY^IBDFBKS("    hasprint=0;")
"RTN","IBDFBKS2",56,0)
 .D BLDARY^IBDFBKS("    NEXTFIELD=NEXTFIELD+1;")
"RTN","IBDFBKS2",57,0)
 .D BLDARY^IBDFBKS("  }};")
"RTN","IBDFBKS2",58,0)
 .D BLDARY^IBDFBKS("  EXFORMAT = ""NOEXPORT"";")
"RTN","IBDFBKS2",59,0)
 .D BLDARY^IBDFBKS("  HIDDEN = ""1"";")
"RTN","IBDFBKS2",60,0)
 ;
"RTN","IBDFBKS2",61,0)
 ;field is narrative that needs to be broken into single lines
"RTN","IBDFBKS2",62,0)
 I (LINES>1)&(READTYPE=2) D  Q
"RTN","IBDFBKS2",63,0)
 .F LINENUM=1:1:LINES S:LINENUM>1 Y1=$FN(Y1+(2*ROWHT*CONVERT),"",0) D
"RTN","IBDFBKS2",64,0)
 ..S X2=X1+(172.7654*WIDTH*CONVERT),X2=$FN(X2,"",0)
"RTN","IBDFBKS2",65,0)
 ..S Y2=Y1+(180*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",66,0)
 ..D PRINTEND^IBDFBKS3
"RTN","IBDFBKS2",67,0)
 ..D PKFIELD(X1+2,Y1+2,X2-2,Y2-2,2,PICTURE,0,CONF,PKDICT,WIDTH,TYPEDATA,NAME_" LINE "_LINENUM,2)
"RTN","IBDFBKS2",68,0)
 ..;for handprint fields,must prefix data exported with field info - for bubbles the XMAP has the field info
"RTN","IBDFBKS2",69,0)
 ..S @FIELDS@(PAGE,FIELD)="H:"_IEN_":",@FIELDS@(PAGE,FIELD,"DATATYPE")=TYPEDATA S:LINENUM=1 @FIELDS@(PAGE,FIELD,"START")=1 S:LINENUM=LINES @FIELDS@(PAGE,FIELD,"END")=1 S @FIELDS@(PAGE,FIELD,"MULT")=1
"RTN","IBDFBKS2",70,0)
 ;
"RTN","IBDFBKS2",71,0)
 ;field needs to be broken into subfields due to the print format
"RTN","IBDFBKS2",72,0)
 I (READTYPE=2)&(FORMAT'="") D  Q
"RTN","IBDFBKS2",73,0)
 .N SUBFIELD,I1,I2,PREFIX,SX1,SX2,SPICTURE,LEN,FOUNDEND
"RTN","IBDFBKS2",74,0)
 .S PREFIX=$P(FORMAT,"_"),I1=$L(PREFIX)+1
"RTN","IBDFBKS2",75,0)
 .S Y2=Y1+(180*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",76,0)
 .F  Q:(I1>WIDTH)  D
"RTN","IBDFBKS2",77,0)
 ..S I2=I1
"RTN","IBDFBKS2",78,0)
 ..S FOUNDEND=0 F  D  Q:FOUNDEND
"RTN","IBDFBKS2",79,0)
 ...I $E(FORMAT,I2+1)="_" S I2=I2+1
"RTN","IBDFBKS2",80,0)
 ...E  S FOUNDEND=1 Q
"RTN","IBDFBKS2",81,0)
 ..;so at this point I1=beginning of the subfield, I2=the end
"RTN","IBDFBKS2",82,0)
 ..S SX1=$FN(X1+(172.7654*(I1-1)*CONVERT),"",0)
"RTN","IBDFBKS2",83,0)
 ..S SX2=$FN(X1+(172.7654*(I2)*CONVERT),"",0)
"RTN","IBDFBKS2",84,0)
 ..S SPICTURE=$E(SUBPICS,I1,I2)
"RTN","IBDFBKS2",85,0)
 ..S LEN=(I2-I1)+1
"RTN","IBDFBKS2",86,0)
 ..D PRINTEND^IBDFBKS3
"RTN","IBDFBKS2",87,0)
 ..D PKFIELD(SX1+2,Y1+2,SX2-2,Y2-2,2,SPICTURE,1,0,"",LEN,"ALPHA",NAME_" Char:"_I1_" to "_I2)
"RTN","IBDFBKS2",88,0)
 ..S SUBFIELD(FIELD)=""
"RTN","IBDFBKS2",89,0)
 ..S (I1,I2)=I2+1
"RTN","IBDFBKS2",90,0)
 ..S FOUNDEND=0 F  D  Q:FOUNDEND
"RTN","IBDFBKS2",91,0)
 ...I $E(FORMAT,I2+1)="_" S FOUNDEND=1 Q
"RTN","IBDFBKS2",92,0)
 ...I I2>WIDTH S FOUNDEND=1 Q
"RTN","IBDFBKS2",93,0)
 ...S I2=I2+1 Q
"RTN","IBDFBKS2",94,0)
 ..I $E(FORMAT,I1,I2)'="" S SUBFIELD(FIELD)=$E(FORMAT,I1,I2)
"RTN","IBDFBKS2",95,0)
 ..S I1=I2+1
"RTN","IBDFBKS2",96,0)
 .
"RTN","IBDFBKS2",97,0)
 .;now create a field to concatenate the subfields together
"RTN","IBDFBKS2",98,0)
 .S X2=X1+(172.7654*WIDTH*CONVERT),X2=$FN(X2,"",0)
"RTN","IBDFBKS2",99,0)
 .S Y2=Y1+(180*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",100,0)
 .D PKFIELD(X1,Y1,X2,Y2,1,PICTURE,0,CONF,PKDICT,WIDTH,TYPEDATA,NAME,1)
"RTN","IBDFBKS2",101,0)
 .D
"RTN","IBDFBKS2",102,0)
 ..D BLDARY^IBDFBKS("BEGIN = {ALPHA sfstr;")
"RTN","IBDFBKS2",103,0)
 ..D BLDARY^IBDFBKS("ALPHA str;")
"RTN","IBDFBKS2",104,0)
 ..D BLDARY^IBDFBKS("INT sfconf;")
"RTN","IBDFBKS2",105,0)
 ..D BLDARY^IBDFBKS("INT conf;")
"RTN","IBDFBKS2",106,0)
 ..D BLDARY^IBDFBKS("INT found;")
"RTN","IBDFBKS2",107,0)
 ..D BLDARY^IBDFBKS("INT ret;")
"RTN","IBDFBKS2",108,0)
 ..D BLDARY^IBDFBKS("found=0;")
"RTN","IBDFBKS2",109,0)
 ..D BLDARY^IBDFBKS("conf=10;")
"RTN","IBDFBKS2",110,0)
 ..I PREFIX'="" D BLDARY^IBDFBKS("    str=\"""_PREFIX_"\"";")
"RTN","IBDFBKS2",111,0)
 ..N SUB S SUB=0 F  S SUB=$O(SUBFIELD(SUB)) Q:'SUB  D
"RTN","IBDFBKS2",112,0)
 ...D BLDARY^IBDFBKS("  sfstr=STRIP(GETAVALUE("_SUB_"));")
"RTN","IBDFBKS2",113,0)
 ...D BLDARY^IBDFBKS("str=STRCAT(str,sfstr);")
"RTN","IBDFBKS2",114,0)
 ...D BLDARY^IBDFBKS("if (sfstr!=\""\"") found=1;")
"RTN","IBDFBKS2",115,0)
 ...I SUBFIELD(SUB)'="" D BLDARY^IBDFBKS("str=STRCAT(sfstr,\"""_SUBFIELD(SUB)_"\"");")
"RTN","IBDFBKS2",116,0)
 ...D BLDARY^IBDFBKS("sfconf=GETCONF("_SUB_");")
"RTN","IBDFBKS2",117,0)
 ...D BLDARY^IBDFBKS("if (sfconf<conf) conf=sfconf;")
"RTN","IBDFBKS2",118,0)
 ..D BLDARY^IBDFBKS("if (found) ret=SETTEXT("_FIELD_",str,ITOA(conf-1),FIELD_OK);")
"RTN","IBDFBKS2",119,0)
 ..D BLDARY^IBDFBKS("if (found == 0) ret=SETTEXT("_FIELD_",\""\"",ITOA(conf-1),FIELD_BLANK);")
"RTN","IBDFBKS2",120,0)
 ..D BLDARY^IBDFBKS("if (ret) SETTEXT("_FIELD_",str,\""1\"",FIELD_BAD);")
"RTN","IBDFBKS2",121,0)
 ..D BLDARY^IBDFBKS("};")
"RTN","IBDFBKS2",122,0)
 .;
"RTN","IBDFBKS2",123,0)
 .;for handprint fields,must prefix data exported with field info - for bubbles the XMAP has the field info
"RTN","IBDFBKS2",124,0)
 .S @FIELDS@(PAGE,FIELD)="H:"_IEN_":",@FIELDS@(PAGE,FIELD,"DATATYPE")=TYPEDATA
"RTN","IBDFBKS2",125,0)
 ;
"RTN","IBDFBKS2",126,0)
 ;following are handprint fields that don't need to be broken into subfields
"RTN","IBDFBKS2",127,0)
 ;
"RTN","IBDFBKS2",128,0)
 I READTYPE=1 D  ;not printed in ICR format
"RTN","IBDFBKS2",129,0)
 .D CNVRTHT^IBDF2D1(LINES,.LINES)
"RTN","IBDFBKS2",130,0)
 .S X2=X1+(103.65924*WIDTH*CONVERT),X2=$FN(X2,"",0)
"RTN","IBDFBKS2",131,0)
 .S Y2=Y1+(ROWHT*LINES*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",132,0)
 ;
"RTN","IBDFBKS2",133,0)
 I READTYPE'=1 D  ;printed in ICR format
"RTN","IBDFBKS2",134,0)
 .S X2=X1+(172.7654*WIDTH*CONVERT),X2=$FN(X2,"",0)
"RTN","IBDFBKS2",135,0)
 .S Y2=Y1+(180*LINES*CONVERT),Y2=$FN(Y2,"",0)
"RTN","IBDFBKS2",136,0)
 ;
"RTN","IBDFBKS2",137,0)
 D PRINTEND^IBDFBKS3
"RTN","IBDFBKS2",138,0)
 D:READTYPE=2 PKFIELD(X1+2,Y1+2,X2-2,Y2-2,READTYPE,PICTURE,0,CONF,PKDICT,WIDTH,TYPEDATA,NAME,2)
"RTN","IBDFBKS2",139,0)
 ;
"RTN","IBDFBKS2",140,0)
 D:READTYPE'=2 PKFIELD(X1,Y1,X2,Y2,READTYPE,PICTURE,0,"","",LENGTH,TYPEDATA,NAME)
"RTN","IBDFBKS2",141,0)
 S @FIELDS@(PAGE,FIELD)="H:"_IEN_":",@FIELDS@(PAGE,FIELD,"DATATYPE")=TYPEDATA
"RTN","IBDFBKS2",142,0)
 D ENDSTUFF
"RTN","IBDFBKS2",143,0)
 Q
"RTN","IBDFBKS2",144,0)
 ;
"RTN","IBDFBKS2",145,0)
ENDSTUFF ;** END STUFF **
"RTN","IBDFBKS2",146,0)
 ;S L=$S(TYPEDATA="ALPHA":$L(PICTURE),1:0)
"RTN","IBDFBKS2",147,0)
 ;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! PUT BACK?
"RTN","IBDFBKS2",148,0)
 ;I L D
"RTN","IBDFBKS2",149,0)
 ;.D ADDTOEND^IBDFBKS3("  "_TYPEDATA_" val;")
"RTN","IBDFBKS2",150,0)
 ;.D ADDTOEND^IBDFBKS3("  INT len;")
"RTN","IBDFBKS2",151,0)
 I READTYPE'=2 D  ;test the results of the marksense fields that were laid on top of the operator fill field
"RTN","IBDFBKS2",152,0)
 .D ADDTOEND^IBDFBKS3("  if ((hasprint)&&(FIELDACCEPTED==0)){")
"RTN","IBDFBKS2",153,0)
 .D ADDTOEND^IBDFBKS3("    FIELDSTATUS=FIELD_BAD;")
"RTN","IBDFBKS2",154,0)
 .D ADDTOEND^IBDFBKS3("  }")
"RTN","IBDFBKS2",155,0)
 ;
"RTN","IBDFBKS2",156,0)
 ;!!!!!!!!!! PUT BACK?
"RTN","IBDFBKS2",157,0)
 ;I L D
"RTN","IBDFBKS2",158,0)
 ;.D ADDTOEND^IBDFBKS3("  val=GETVALUE(FIELDNAME);")
"RTN","IBDFBKS2",159,0)
 ;.D ADDTOEND^IBDFBKS3("  val=STRIP(val);")
"RTN","IBDFBKS2",160,0)
 ;.D ADDTOEND^IBDFBKS3("  len=STRLEN(val);")
"RTN","IBDFBKS2",161,0)
 ;.D ADDTOEND^IBDFBKS3("  if ((FIELDSTATUS==FIELD_OK)&&(len<"_L_")){")
"RTN","IBDFBKS2",162,0)
 ;.D ADDTOEND^IBDFBKS3("    FIELDSTATUS=FIELD_BAD;")
"RTN","IBDFBKS2",163,0)
 ;.D ADDTOEND^IBDFBKS3("    SHOW(""Value too short!"");")
"RTN","IBDFBKS2",164,0)
 ;.D ADDTOEND^IBDFBKS3("}")
"RTN","IBDFBKS2",165,0)
 Q
"RTN","IBDFBKS2",166,0)
 ;
"RTN","IBDFBKS2",167,0)
PKFIELD(X1,Y1,X2,Y2,READTYPE,PICTURE,HIDDEN,CONF,PKDICT,LENGTH,TYPEDATA,NAME,ENDPGM) ;
"RTN","IBDFBKS2",168,0)
 ; -- now for the handprint field
"RTN","IBDFBKS2",169,0)
 S FIELD=FIELD+1
"RTN","IBDFBKS2",170,0)
 D BLDARY^IBDFBKS("FIELD ' "_FIELD)
"RTN","IBDFBKS2",171,0)
 D BLDARY^IBDFBKS("  NAME = """_NAME_""";")
"RTN","IBDFBKS2",172,0)
 ;
"RTN","IBDFBKS2",173,0)
 I READTYPE=2 D
"RTN","IBDFBKS2",174,0)
 .D BLDARY^IBDFBKS("  ELEMTYPE = ELEM_OT;")
"RTN","IBDFBKS2",175,0)
 .D BLDARY^IBDFBKS("  METRIC = 2;")
"RTN","IBDFBKS2",176,0)
 ;
"RTN","IBDFBKS2",177,0)
 E  D
"RTN","IBDFBKS2",178,0)
 .D BLDARY^IBDFBKS("  ELEMTYPE = ELEM_OT;")
"RTN","IBDFBKS2",179,0)
 .D BLDARY^IBDFBKS("  METRIC = 1;")
"RTN","IBDFBKS2",180,0)
 ;
"RTN","IBDFBKS2",181,0)
 D BLDARY^IBDFBKS("  DATATYPE ="_TYPEDATA_";")
"RTN","IBDFBKS2",182,0)
 D BLDARY^IBDFBKS("  LENGTH = "_LENGTH_";")
"RTN","IBDFBKS2",183,0)
 D BLDARY^IBDFBKS("  POINTS = "_Y1_" "_X1_" "_Y2_" "_X2_";")
"RTN","IBDFBKS2",184,0)
 D BLDARY^IBDFBKS("  PAGE = "_PAGE_";")
"RTN","IBDFBKS2",185,0)
 I CONF'="" D BLDARY^IBDFBKS("  CONFIDENCE = """_CONF_""";")
"RTN","IBDFBKS2",186,0)
 I HIDDEN D BLDARY^IBDFBKS(" HIDDEN = ""1"";")
"RTN","IBDFBKS2",187,0)
 I $G(ENDPGM) D HPSKIP
"RTN","IBDFBKS2",188,0)
 ;
"RTN","IBDFBKS2",189,0)
 ;** IMAGE PROCESSING **
"RTN","IBDFBKS2",190,0)
 I READTYPE=2 D
"RTN","IBDFBKS2",191,0)
 .D BLDARY^IBDFBKS(" ImageProcessing = {")
"RTN","IBDFBKS2",192,0)
 .D BLDARY^IBDFBKS("   IMAGEPROC=1")
"RTN","IBDFBKS2",193,0)
 .D BLDARY^IBDFBKS("   DESKEW=0")
"RTN","IBDFBKS2",194,0)
 .D BLDARY^IBDFBKS("   DESHADE=0")
"RTN","IBDFBKS2",195,0)
 .D BLDARY^IBDFBKS("   SMOOTH=1")
"RTN","IBDFBKS2",196,0)
 .D BLDARY^IBDFBKS("   REMOVE_BORDER=1")
"RTN","IBDFBKS2",197,0)
 .D BLDARY^IBDFBKS("   REMOVE_NOISE=0")
"RTN","IBDFBKS2",198,0)
 .D BLDARY^IBDFBKS("   PROC_MIN_VERT_LINE_LEN=70")
"RTN","IBDFBKS2",199,0)
 .D BLDARY^IBDFBKS("   PROC_MIN_HORZ_LINE_LEN=70")
"RTN","IBDFBKS2",200,0)
 .D BLDARY^IBDFBKS("   FATTYPE=0")
"RTN","IBDFBKS2",201,0)
 .D BLDARY^IBDFBKS("   FATTEN=0};")
"RTN","IBDFBKS2",202,0)
 .D BLDARY^IBDFBKS("   Recognition = {FIXED_WIDTH=1")
"RTN","IBDFBKS2",203,0)
 .D BLDARY^IBDFBKS("   OT_RECOGTYPE=HP")
"RTN","IBDFBKS2",204,0)
 .D BLDARY^IBDFBKS("   };")
"RTN","IBDFBKS2",205,0)
 ;
"RTN","IBDFBKS2",206,0)
 ;** begin program **
"RTN","IBDFBKS2",207,0)
 I $G(ENDPGM)=2 D
"RTN","IBDFBKS2",208,0)
 .D BLDARY^IBDFBKS("BEGIN = {ALPHA str;")
"RTN","IBDFBKS2",209,0)
 .D BLDARY^IBDFBKS("INT conf;")
"RTN","IBDFBKS2",210,0)
 .D BLDARY^IBDFBKS("INT ret;")
"RTN","IBDFBKS2",211,0)
 .D BLDARY^IBDFBKS("  conf = GETCONF("_FIELD_");")
"RTN","IBDFBKS2",212,0)
 .D BLDARY^IBDFBKS("  if (GETSTATUS("_FIELD_") == FIELD_BLANK) {")
"RTN","IBDFBKS2",213,0)
 .D BLDARY^IBDFBKS("     ret=SETTEXT("_FIELD_",\""\"",ITOA(conf-1),FIELD_BLANK); }")
"RTN","IBDFBKS2",214,0)
 .D BLDARY^IBDFBKS("if (ret) FIELDSTATUS = FIELD_ERROR;")
"RTN","IBDFBKS2",215,0)
 .D BLDARY^IBDFBKS("};")
"RTN","IBDFBKS2",216,0)
 .;
"RTN","IBDFBKS2",217,0)
 I PKDICT'="" D BLDARY^IBDFBKS("  DICTIONARY = """_PKDICT_""";")
"RTN","IBDFBKS2",218,0)
 I PICTURE'="",TYPEDATA="ALPHA" D BLDARY^IBDFBKS("  PICTURE = """_PICTURE_""";")
"RTN","IBDFBKS2",219,0)
 Q
"RTN","IBDFBKS2",220,0)
HPSKIP ; If hand print field blank, skip it
"RTN","IBDFBKS2",221,0)
 D ADDTOEND^IBDFBKS3("   if ((GETSTATUS(FIELDNAME) != FIELD_BLANK) && (FIELDACCEPTED == 0)) {")
"RTN","IBDFBKS2",222,0)
 D ADDTOEND^IBDFBKS3("     FIELDSTATUS = FIELD_BAD;")
"RTN","IBDFBKS2",223,0)
 D ADDTOEND^IBDFBKS3("     saveunrf = "_FIELD_";}")
"RTN","IBDFBKS2",224,0)
 Q
"RTN","IBDFBKS2",225,0)
 ;
"RTN","IBDFBKS4")
0^1^B21802437
"RTN","IBDFBKS4",1,0)
IBDFBKS4 ;ALB/AAS - ENCOUNTER FORM - create form spec for scanning (Broker Version) ; 6-JUN-95
"RTN","IBDFBKS4",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDFBKS4",3,0)
 ;
"RTN","IBDFBKS4",4,0)
RECOMP ;Recompiles all form specs for paper keyboard
"RTN","IBDFBKS4",5,0)
 N QZZ
"RTN","IBDFBKS4",6,0)
 S QZZ=0 F  S QZZ=$O(^IBD(359.2,QZZ)) Q:'QZZ  D SCAN^IBDFBKS(QZZ)
"RTN","IBDFBKS4",7,0)
 Q
"RTN","IBDFBKS4",8,0)
 ;
"RTN","IBDFBKS4",9,0)
FIELDS ;
"RTN","IBDFBKS4",10,0)
 S FLD=1 F  S FLD=$O(@FIELDS@(PAGE,FLD)) Q:'FLD  D
"RTN","IBDFBKS4",11,0)
 .N DATATP S DATATP=$G(@FIELDS@(PAGE,FLD,"DATATYPE"))
"RTN","IBDFBKS4",12,0)
 .I DATATP="" D  Q
"RTN","IBDFBKS4",13,0)
 ..S (LBEGIN,LEND,QUIT)=0
"RTN","IBDFBKS4",14,0)
 ..S LBEGIN=FLD F  S FLD=$O(@FIELDS@(PAGE,FLD)) Q:QUIT  D  Q:QUIT
"RTN","IBDFBKS4",15,0)
 ...I LEND=0,$S(FLD="":1,1:$G(@FIELDS@(PAGE,FLD,"DATATYPE"))'="") S FLD=LBEGIN D ONEBUB S QUIT=1 Q
"RTN","IBDFBKS4",16,0)
 ...I FLD="",LEND>LBEGIN D LOOP(LBEGIN,LEND) S FLD=LEND,QUIT=1 Q
"RTN","IBDFBKS4",17,0)
 ...I $G(@FIELDS@(PAGE,FLD,"DATATYPE"))'="" D LOOP(LBEGIN,LEND) S FLD=LEND,QUIT=1 Q
"RTN","IBDFBKS4",18,0)
 ...S LEND=FLD
"RTN","IBDFBKS4",19,0)
 ...Q
"RTN","IBDFBKS4",20,0)
 .;
"RTN","IBDFBKS4",21,0)
 .I DATATP'="" D
"RTN","IBDFBKS4",22,0)
 ..N TOSTRING
"RTN","IBDFBKS4",23,0)
 ..S TOSTRING=$S($G(@FIELDS@(PAGE,FLD,"START")):"narrative",1:"str")
"RTN","IBDFBKS4",24,0)
 ..;
"RTN","IBDFBKS4",25,0)
 ..D BLDARY^IBDFBKS(" "_TOSTRING_"=\""\"";")
"RTN","IBDFBKS4",26,0)
 ..;
"RTN","IBDFBKS4",27,0)
 ..I DATATP="ALPHA" D BLDARY^IBDFBKS(" if (GETSTATUS("_FLD_")==FIELD_OK) "_TOSTRING_"=STRIP(GETAVALUE("_FLD_"));") Q
"RTN","IBDFBKS4",28,0)
 ..;
"RTN","IBDFBKS4",29,0)
 ..I DATATP="FLOAT" D BLDARY^IBDFBKS(" if (GETSTATUS("_FLD_")==FIELD_OK) "_TOSTRING_"=STRIP(FTOA(GETFVALUE("_FLD_")));") Q
"RTN","IBDFBKS4",30,0)
 ..;
"RTN","IBDFBKS4",31,0)
 ..I DATATP="INT" D BLDARY^IBDFBKS(" if (GETSTATUS("_FLD_")==FIELD_OK) "_TOSTRING_"=STRIP(ITOA(GETIVALUE("_FLD_")));")  Q
"RTN","IBDFBKS4",32,0)
 ..;
"RTN","IBDFBKS4",33,0)
 ..I DATATP="DATE" D BLDARY^IBDFBKS(" if (GETSTATUS("_FLD_")==FIELD_OK) "_TOSTRING_"=STRIP(DTOA(GETIVALUE("_FLD_")));") Q
"RTN","IBDFBKS4",34,0)
 ..;
"RTN","IBDFBKS4",35,0)
 ..I DATATP="TIME" D BLDARY^IBDFBKS(" if (GETSTATUS("_FLD_")==FIELD_OK) "_TOSTRING_"=STRIP(TTOA(GETIVALUE("_FLD_")));") Q
"RTN","IBDFBKS4",36,0)
 ..;
"RTN","IBDFBKS4",37,0)
 ..;D BLDARY^IBDFBKS(" "_TOSTRING_"=STRFIELDS("_FLD_","_FLD_");") Q
"RTN","IBDFBKS4",38,0)
 .;
"RTN","IBDFBKS4",39,0)
 .I $G(@FIELDS@(PAGE,FLD,"MULT")),'$G(@FIELDS@(PAGE,FLD,"START")) D BLDARY^IBDFBKS(" if (str!=\""\"") narrative=STRIP(STRCAT(STRCAT(narrative,\"" \""),str));")
"RTN","IBDFBKS4",40,0)
 .;
"RTN","IBDFBKS4",41,0)
 .I '$G(@FIELDS@(PAGE,FLD,"MULT")) D
"RTN","IBDFBKS4",42,0)
 ..D BLDARY^IBDFBKS(" if (str!=\""\"") {")
"RTN","IBDFBKS4",43,0)
 ..D BLDARY^IBDFBKS("   Data=Add;")
"RTN","IBDFBKS4",44,0)
 ..I @FIELDS@(PAGE,FLD)'="" D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"""_@FIELDS@(PAGE,FLD)_"\"");")
"RTN","IBDFBKS4",45,0)
 ..D BLDARY^IBDFBKS("   Data=STRCAT(Data,str);")
"RTN","IBDFBKS4",46,0)
 ..D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"",\"");")
"RTN","IBDFBKS4",47,0)
 ..D BLDARY^IBDFBKS("   result=DDEEXEC(ddechan,Data);}")
"RTN","IBDFBKS4",48,0)
 .;
"RTN","IBDFBKS4",49,0)
 .I $G(@FIELDS@(PAGE,FLD,"END")) D
"RTN","IBDFBKS4",50,0)
 ..D BLDARY^IBDFBKS("    if (narrative!=\""\"") {")
"RTN","IBDFBKS4",51,0)
 ..D BLDARY^IBDFBKS("   Data=Add;")
"RTN","IBDFBKS4",52,0)
 ..I @FIELDS@(PAGE,FLD)'="" D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"""_@FIELDS@(PAGE,FLD)_"\"");")
"RTN","IBDFBKS4",53,0)
 ..D BLDARY^IBDFBKS("   Data=STRCAT(Data,narrative);")
"RTN","IBDFBKS4",54,0)
 ..I $P($G(@FIELDS@(PAGE,FLD)),":")'="H" D BLDARY^IBDFBKS("   Data=STRCAT(Add,str);")
"RTN","IBDFBKS4",55,0)
 ..D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"",\"");")
"RTN","IBDFBKS4",56,0)
 ..D BLDARY^IBDFBKS("   result=DDEEXEC(ddechan,Data);}")
"RTN","IBDFBKS4",57,0)
 ..;D BLDARY^IBDFBKS("   Data=STRCAT(Data,RS);}")
"RTN","IBDFBKS4",58,0)
FIELDSQ Q
"RTN","IBDFBKS4",59,0)
 ;
"RTN","IBDFBKS4",60,0)
ONEBUB ; -- for a single bubble field
"RTN","IBDFBKS4",61,0)
 D BLDARY^IBDFBKS(" str=STRFIELDS("_FLD_","_FLD_");")
"RTN","IBDFBKS4",62,0)
 D BLDARY^IBDFBKS(" if (str!=\""\"") {")
"RTN","IBDFBKS4",63,0)
 I @FIELDS@(PAGE,FLD)'="" D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"""_@FIELDS@(PAGE,FLD)_"\"");")
"RTN","IBDFBKS4",64,0)
 D BLDARY^IBDFBKS("      Data=STRCAT(Add,str);")
"RTN","IBDFBKS4",65,0)
 D BLDARY^IBDFBKS("      Data=STRCAT(Data,\"",\"");")
"RTN","IBDFBKS4",66,0)
 D BLDARY^IBDFBKS("      result=DDEEXEC(ddechan,Data);}")
"RTN","IBDFBKS4",67,0)
 ;D BLDARY^IBDFBKS("   Data=STRCAT(Data,str);")
"RTN","IBDFBKS4",68,0)
 ;D BLDARY^IBDFBKS("   Data=STRCAT(Data,RS);}")
"RTN","IBDFBKS4",69,0)
 Q
"RTN","IBDFBKS4",70,0)
 ;
"RTN","IBDFBKS4",71,0)
LOOP(LBEGIN,LEND) ; -- Loop through fields instead of one by one
"RTN","IBDFBKS4",72,0)
 D BLDARY^IBDFBKS("  ")
"RTN","IBDFBKS4",73,0)
 D BLDARY^IBDFBKS(" loop="_LBEGIN_";")
"RTN","IBDFBKS4",74,0)
 D BLDARY^IBDFBKS(" while (loop < "_(LEND+1)_"){")
"RTN","IBDFBKS4",75,0)
 D BLDARY^IBDFBKS("   str=STRFIELDS(loop,loop);")
"RTN","IBDFBKS4",76,0)
 D BLDARY^IBDFBKS("   if (str!=\""\"") {")
"RTN","IBDFBKS4",77,0)
 D BLDARY^IBDFBKS("      Data=STRCAT(Add,str);")
"RTN","IBDFBKS4",78,0)
 D BLDARY^IBDFBKS("   Data=STRCAT(Data,\"",\"");")
"RTN","IBDFBKS4",79,0)
 D BLDARY^IBDFBKS("      result=DDEEXEC(ddechan,Data);}")
"RTN","IBDFBKS4",80,0)
 ;D BLDARY^IBDFBKS("     Data=STRCAT(Data,str);")
"RTN","IBDFBKS4",81,0)
 ;D BLDARY^IBDFBKS("     Data=STRCAT(Data,RS);}")
"RTN","IBDFBKS4",82,0)
 D BLDARY^IBDFBKS("   loop=loop+1;")
"RTN","IBDFBKS4",83,0)
 D BLDARY^IBDFBKS(" if (loop > "_LEND_") break;}")
"RTN","IBDFBKS4",84,0)
 D BLDARY^IBDFBKS("  ")
"RTN","IBDFBKS4",85,0)
 Q
"RTN","IBDFBKS4",86,0)
 ;
"RTN","IBDFBKS4",87,0)
 ;;loop=9;
"RTN","IBDFBKS4",88,0)
 ;;while (loop < 51){
"RTN","IBDFBKS4",89,0)
 ;;    str=STRFIELDS(loop,loop);
"RTN","IBDFBKS4",90,0)
 ;;    if (str!=\"\") {
"RTN","IBDFBKS4",91,0)
 ;;      Data=STRCAT(Data,str);
"RTN","IBDFBKS4",92,0)
 ;;      Data=STRCAT(Data,RS);
"RTN","IBDFBKS4",93,0)
 ;;      }
"RTN","IBDFBKS4",94,0)
 ;;   loop=loop+1;
"RTN","IBDFBKS4",95,0)
 ;;   if (loop > 51) break;
"RTN","IBDFBKS4",96,0)
 ;;   }
"RTN","IBDFBKS4",97,0)
 ;;
"RTN","IBDFBKS4",98,0)
 ;;\'SHOW(Data);
"RTN","IBDFBKS4",99,0)
DATA1 ;;    Data = STRCAT(\"FORMTYPE=153\", RS);
"RTN","IBDFBKS4",100,0)
 ;;    Data = STRCAT(Data, \"FORMID=\");
"RTN","IBDFBKS4",101,0)
 ;;    Data = STRCAT(Data, ITOA(GETIVALUE(7)));
"RTN","IBDFBKS4",102,0)
 ;;    Data = STRCAT(Data,RS);
"RTN","IBDFBKS4",103,0)
 ;;    Data = STRCAT(Data,\"PAGE=1\");
"RTN","IBDFBKS4",104,0)
 ;;    Data = STRCAT(Data,RS);
"RTN","IBDFBKS4",105,0)
 ;;    Data =STRCAT(Data, \"DATA=\");
"RTN","IBDFBKS4",106,0)
 ;;    Data=STRCAT(Data,RS);
"RTN","IBDFBKS4",107,0)
 ;;
"RTN","IBDFDE")
0^12^B76755336
"RTN","IBDFDE",1,0)
IBDFDE ;ALB/AAS - AICS Data Entry, Entry point by form ; 24-FEB-96
"RTN","IBDFDE",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDFDE",3,0)
 ;
"RTN","IBDFDE",4,0)
% N %,%H,C,I,J,X,Y,ADD,DEL,ASKOTHER,DIR,DIC,DA,CNT,DFN,DIRUT,DUOUT,DTOUT,POP,RTN,FRMDATA,IBY,IBQUIT,IBDF,IBDOBJ,IBDPTSTI,IBDPTSTE,IBDPTNM,IBDPTDTI,SEL
"RTN","IBDFDE",5,0)
 N IBDPTDTE,IBDFMNME,IBDFMIEN,IBDFMSTI,IBDFMSTE,IBDFMIDI,IBDCLNME,IBFORM,IBDCLNPH,IBDPID,IBDPTPRI,IBDSEL,IBDPI,IBDCO,PXCA,SDCLST,PXCASTAT,PXKNODA,PXKNODB,IBDREDIT,IBDASK,IBDPRE,IBDOK,IBD,IBDCKOUT
"RTN","IBDFDE",6,0)
 N ANS1,AUPNDAYS,AUPNDOB,AUPNDOD,AUPNPAT,AUPNSEX
"RTN","IBDFDE",7,0)
 ;
"RTN","IBDFDE",8,0)
 I '$D(DT) D DT^DICRW
"RTN","IBDFDE",9,0)
 D HOME^%ZIS
"RTN","IBDFDE",10,0)
 W !!,"Data Entry of Encounter Forms (by Form)",!!
"RTN","IBDFDE",11,0)
 ;
"RTN","IBDFDE",12,0)
STRT ; -- ask for form id
"RTN","IBDFDE",13,0)
 D END
"RTN","IBDFDE",14,0)
 S DIR("?")="Enter the encounter form id, printed on the form.  This is the second number from the left, just right of the label 'ID:'."
"RTN","IBDFDE",15,0)
 S DIR(0)="PO^357.96:AEQM",DIR("A")="Encounter Form ID" D ^DIR K DIR,DA,DR,DIC
"RTN","IBDFDE",16,0)
 I $D(DIRUT) G END
"RTN","IBDFDE",17,0)
 S IBDF("FORM")=+Y
"RTN","IBDFDE",18,0)
 D EN
"RTN","IBDFDE",19,0)
 ;
"RTN","IBDFDE",20,0)
STRTQ I '$P($G(^IBD(357.09,1,0)),"^",6) D PAUSE
"RTN","IBDFDE",21,0)
 G:IBQUIT END
"RTN","IBDFDE",22,0)
 W @IOF
"RTN","IBDFDE",23,0)
 Q:$G(IBDF("OPTION"))
"RTN","IBDFDE",24,0)
 G STRT
"RTN","IBDFDE",25,0)
 ;
"RTN","IBDFDE",26,0)
EN ; -- entry point to edit one form,  
"RTN","IBDFDE",27,0)
 ;    Input IBDF("FORM") := form number
"RTN","IBDFDE",28,0)
 ;
"RTN","IBDFDE",29,0)
 D:$D(XRTL) T0^%ZOSV
"RTN","IBDFDE",30,0)
 N IBDSTRT,IBDFIN,IBDTIME S IBDSTRT=$H
"RTN","IBDFDE",31,0)
 S IBQUIT=0
"RTN","IBDFDE",32,0)
 L +^IBD(357.96,IBDF("FORM")):5 I '$T W !!,"Form is currently being entered by another user, try again later!" S IBFLAG=1 G ENQ
"RTN","IBDFDE",33,0)
 I $G(^IBD(357.96,IBDF("FORM"),0))="" W !!,"Form Tracking Entry has been deleted, Data entry not available" S IBFLAG=1 G ENQ
"RTN","IBDFDE",34,0)
 ;
"RTN","IBDFDE",35,0)
OVER ; -- start here to re-edit an entry
"RTN","IBDFDE",36,0)
 N IOINHI,IOINORM
"RTN","IBDFDE",37,0)
 S X="IOINHI;IOINORM" D ENDR^%ZISS
"RTN","IBDFDE",38,0)
 S (IBQUIT,IBDF("KILL"))=0
"RTN","IBDFDE",39,0)
 D IDPAT^IBDFRPC3(.FRMDATA,IBDF("FORM"))
"RTN","IBDFDE",40,0)
 D EXPAND(FRMDATA)
"RTN","IBDFDE",41,0)
 I $P($G(^IBE(357,IBDFMIEN,0)),"^",12)'=1 W !!,"Form is not scannable.  Data entry not available" S IBFLAG=1 G ENQ
"RTN","IBDFDE",42,0)
 ;
"RTN","IBDFDE",43,0)
 I '$G(IBDF("FRMDEF")) W !!,"Form Definition entry not defined for form tracking entry.",!,"Data entry not available." D ERR S IBFLAG=1 G ENQ
"RTN","IBDFDE",44,0)
 I $G(^IBD(357.95,+$G(IBDF("FRMDEF")),0))="" W !!,"Form Definition Entry has been deleted.",!,"Data entry not available." D ERR S IBFLAG=1 G ENQ
"RTN","IBDFDE",45,0)
 I $P($G(^IBD(357.95,+$G(IBDF("FRMDEF")),0)),"^",21)="" W !!,"Can not determine Encounter Form from Form Tracking entry.",!,"Data entry not available." D ERR S IBFLAG=1 G ENQ
"RTN","IBDFDE",46,0)
 I $G(^IBE(357,IBDFMIEN,0))="" W !!,"Encounter Form has been deleted.  Data entry not available." D ERR S IBFLAG=1 G ENQ
"RTN","IBDFDE",47,0)
 I $G(^DPT(DFN,"S",IBDF("APPT"),0))'="",$P(^DPT(DFN,"S",IBDF("APPT"),0),"^",1)'=IBDF("CLINIC") W !!,"Form "_IBDF("FORM")_" is for an Appointment that has been canceled.",!,"Data entry not available." S IBFLAG=1 G ENQ
"RTN","IBDFDE",48,0)
 S X=$P($G(^DPT(DFN,"S",IBDF("APPT"),0)),"^",2) I X'="","^C^N^NA^CA^PC^PCA^"[("^"_X_"^") W !!,"Form "_IBDF("FORM")_" is for an Appointment that has been canceled or no-showed.",!,"Data entry not available." S IBFLAG=1 G ENQ
"RTN","IBDFDE",49,0)
 I '$P($G(^IBE(357,IBDFMIEN,0)),"^",5),'$G(IBDREDIT) D KILLTMP
"RTN","IBDFDE",50,0)
 I '$G(IBDREDIT) D HDR
"RTN","IBDFDE",51,0)
 ;
"RTN","IBDFDE",52,0)
 I IBDFMSTI=3!(IBDFMSTI=6) D  I IBQUIT G ENQ ; -- already sent to pce
"RTN","IBDFDE",53,0)
 .Q:$G(IBDREDIT)
"RTN","IBDFDE",54,0)
 .S IBQUIT=1
"RTN","IBDFDE",55,0)
 .W !!,"Current form Status is ",IBDFMSTE
"RTN","IBDFDE",56,0)
 .W:'IBDCKOUT "."
"RTN","IBDFDE",57,0)
 .W:IBDCKOUT " and was checked out",!,"on "_$$FMTE^XLFDT(IBDCKOUT)_", Status is "_$G(IOINHI)_IBDPTSTE_$G(IOINORM)_".",!
"RTN","IBDFDE",58,0)
 .S DIR("?")="Data Entry on this form appears to have been completed by either scanning or data entry.  Deleting or editing of data is not allowed with this option.  Answer 'Yes' if you wish to continue, or 'No' if to select another form."
"RTN","IBDFDE",59,0)
 .S DIR("?",1)="Enter ?? to see a list of data stored in PCE."
"RTN","IBDFDE",60,0)
 .S DIR("?",2)=" "
"RTN","IBDFDE",61,0)
 .S DIR("??")="^D WRITE^IBDFRPC5"
"RTN","IBDFDE",62,0)
 .S DIR(0)="Y",DIR("B")="No",DIR("A")="Are you sure you want to continue"
"RTN","IBDFDE",63,0)
 .D ^DIR K DIR I Y=1 S IBQUIT=0
"RTN","IBDFDE",64,0)
 ;
"RTN","IBDFDE",65,0)
 I +IBDCKOUT>0 D  I IBQUIT G ENQ ; -- already sent to pce
"RTN","IBDFDE",66,0)
 .I IBDFMSTI=3!(IBDFMSTI=6) Q
"RTN","IBDFDE",67,0)
 .Q:$G(IBDREDIT)
"RTN","IBDFDE",68,0)
 .S IBQUIT=1
"RTN","IBDFDE",69,0)
 .W !!,"Appointment has already been Checked Out on "_$$FMTE^XLFDT(IBDCKOUT)_",",!,"Status is: "_$G(IOINHI)_IBDPTSTE_$G(IOINORM)_".",!
"RTN","IBDFDE",70,0)
 .S DIR("?")="This appointment appears to have been checked out on "_$$FMTE^XLFDT(IBDCKOUT)_".  Deleting or editing of data is not allowed with this option.  Answer 'Yes' if you wish to continue, or 'No' if to select another form."
"RTN","IBDFDE",71,0)
 .S DIR("?",1)="Enter ?? to see a list of data stored in PCE."
"RTN","IBDFDE",72,0)
 .S DIR("?",2)=" "
"RTN","IBDFDE",73,0)
 .S DIR("??")="^D WRITE^IBDFRPC5"
"RTN","IBDFDE",74,0)
 .S DIR(0)="Y",DIR("B")="No",DIR("A")="Are you sure you want to continue"
"RTN","IBDFDE",75,0)
 .D ^DIR K DIR I Y=1 S IBQUIT=0
"RTN","IBDFDE",76,0)
 ;
"RTN","IBDFDE",77,0)
 I '$G(IBDREDIT),$G(^DPT(DFN,"S",IBDF("APPT"),0))="" S IBDOK=1 D FNDAPPT^IBDFDE1 I 'IBDOK W !!,"No action Taken",! G ENQ
"RTN","IBDFDE",78,0)
 ;
"RTN","IBDFDE",79,0)
 I '$D(^TMP("IBD-OBJ",$J,IBDFMIEN,0)) D FRMLSTI^IBDFRPC("^TMP(""IBD-OBJ"",$J,IBDFMIEN)",IBDFMIEN,"",1)
"RTN","IBDFDE",80,0)
 I $O(^TMP("IBD-OBJ",$J,IBDFMIEN,0))="" W !,$G(^TMP("IBD-OBJ",$J,IBDFMIEN,0)),! G ENQ
"RTN","IBDFDE",81,0)
 ;
"RTN","IBDFDE",82,0)
NEWOVER ; -- start here to re-edit an entry
"RTN","IBDFDE",83,0)
 I $G(IBDREDIT) D HDR
"RTN","IBDFDE",84,0)
 D LISTOB
"RTN","IBDFDE",85,0)
 D CHKOUT^IBDFDE0(IBDF("SDOE"))
"RTN","IBDFDE",86,0)
 I '$G(IBDF("PROVIDER PI"))!($G(IBDF("PROVIDER"))) D DEFPROV^IBDFDE21
"RTN","IBDFDE",87,0)
 ;
"RTN","IBDFDE",88,0)
 K ^TMP("IBD-PI-CNT",$J)
"RTN","IBDFDE",89,0)
 S I=0 F  S I=$O(^TMP("IBD-OBJ",$J,IBDFMIEN,I)) Q:I=""  D
"RTN","IBDFDE",90,0)
 .S X=$P($G(^TMP("IBD-OBJ",$J,IBDFMIEN,I)),"^",2)
"RTN","IBDFDE",91,0)
 .S ^TMP("IBD-PI-CNT",$J,X)=$G(^TMP("IBD-PI-CNT",$J,X))+1
"RTN","IBDFDE",92,0)
 ;
"RTN","IBDFDE",93,0)
 S I=0 F  S I=$O(^TMP("IBD-OBJ",$J,IBDFMIEN,I)) Q:I=""!(IBQUIT)  D
"RTN","IBDFDE",94,0)
 .S IBDOBJ=$G(^TMP("IBD-OBJ",$J,IBDFMIEN,I))
"RTN","IBDFDE",95,0)
 .S IBDF("PI")=+$P(IBDOBJ,"^",2),IBDF("TYPE")=$P(IBDOBJ,"^",5)
"RTN","IBDFDE",96,0)
 .S IBDF("IEN")=+$P(IBDOBJ,"^",6),IBDF("VITAL")=$P(IBDOBJ,"^",7)
"RTN","IBDFDE",97,0)
 .S IBDF("PAGE")=$P(IBDOBJ,"^",10)\80+1 ;scannable forms only
"RTN","IBDFDE",98,0)
 .Q:IBDF("IEN")<1!(IBDF("PI")<1)
"RTN","IBDFDE",99,0)
 .S IBDF("IBDF")=I
"RTN","IBDFDE",100,0)
 .S RTN=$G(^IBE(357.6,IBDF("PI"),18)) Q:RTN=""
"RTN","IBDFDE",101,0)
 .X RTN
"RTN","IBDFDE",102,0)
 .I $G(IBDF("GOTO"))'="" S I=IBDF("GOTO") K IBDF("GOTO")
"RTN","IBDFDE",103,0)
 K ^TMP("IBD-PI-CNT",$J)
"RTN","IBDFDE",104,0)
 D FINAL^IBDFDE1 I $G(IBDREDIT) S IBQUIT=0 G OVER
"RTN","IBDFDE",105,0)
 S:$D(XRT0) XRTN=$T(+0) D:$D(XRT0) T1^%ZOSV
"RTN","IBDFDE",106,0)
 ;
"RTN","IBDFDE",107,0)
ENQ K SDFN
"RTN","IBDFDE",108,0)
 L -^IBD(357.96,IBDF("FORM"))
"RTN","IBDFDE",109,0)
 I $D(IBFLAG) D
"RTN","IBDFDE",110,0)
 .I $P($G(^IBD(357.09,1,0)),"^",6) W !! D PAUSE
"RTN","IBDFDE",111,0)
 .K IBFLAG
"RTN","IBDFDE",112,0)
 Q
"RTN","IBDFDE",113,0)
 ;
"RTN","IBDFDE",114,0)
HDR ; -- print patient header
"RTN","IBDFDE",115,0)
 W @IOF
"RTN","IBDFDE",116,0)
 W IBDPTNM,?32,IBDPID,?47,$$FMTE^XLFDT($P($G(^DPT(DFN,0)),"^",3))
"RTN","IBDFDE",117,0)
 W "    Form ID: ",$P(^IBD(357.96,IBDF("FORM"),0),"^")
"RTN","IBDFDE",118,0)
 W !,$TR($J(" ",IOM)," ","=")
"RTN","IBDFDE",119,0)
 W !,"      Clinic: ",$E(IBDCLNME,1,25) W ?40,"  Date/Time: ",IBDPTDTE
"RTN","IBDFDE",120,0)
 W !,"   Form Name: ",$E(IBDFMNME,1,25) W ?40,"Form Status: ",$E(IBDFMSTE,1,25)
"RTN","IBDFDE",121,0)
 Q
"RTN","IBDFDE",122,0)
 ;
"RTN","IBDFDE",123,0)
LISTOB ; -- header for input object list
"RTN","IBDFDE",124,0)
 W !!,"Items available for Input:"
"RTN","IBDFDE",125,0)
 D WRITE^IBDFDE0(IBDF("SDOE"))
"RTN","IBDFDE",126,0)
 S I=0 F  S I=$O(^TMP("IBD-OBJ",$J,IBDFMIEN,I)) Q:I=""  D
"RTN","IBDFDE",127,0)
 .S X=$G(^TMP("IBD-OBJ",$J,IBDFMIEN,I))
"RTN","IBDFDE",128,0)
 .Q:'$P(X,"^",8)
"RTN","IBDFDE",129,0)
 .S Y=$S($P(X,"^",7)="":$P(X,"^"),1:$P(X,"^",7))
"RTN","IBDFDE",130,0)
 .I Y="INPUT PROVIDER" S IBDF("PROVIDER PI")=+$P(X,"^",2)
"RTN","IBDFDE",131,0)
 .I Y["INPUT " S Y=$P(Y,"INPUT ",2)
"RTN","IBDFDE",132,0)
 .W !?3,$E(Y,1,35)
"RTN","IBDFDE",133,0)
 .;
"RTN","IBDFDE",134,0)
 .F  S I=I+1 S X=$G(^TMP("IBD-OBJ",$J,IBDFMIEN,I)) Q:X=""!($P(X,"^",8))
"RTN","IBDFDE",135,0)
 .Q:X=""
"RTN","IBDFDE",136,0)
 .S Y=$S($P(X,"^",7)="":$P(X,"^"),1:$P(X,"^",7))
"RTN","IBDFDE",137,0)
 .I Y="INPUT PROVIDER" S IBDF("PROVIDER PI")=+$P(X,"^",2)
"RTN","IBDFDE",138,0)
 .I Y["INPUT " S Y=$P(Y,"INPUT ",2)
"RTN","IBDFDE",139,0)
 .W ?40,$E(Y,1,35)
"RTN","IBDFDE",140,0)
 ;
"RTN","IBDFDE",141,0)
 W !,$TR($J(" ",IOM)," ","=")
"RTN","IBDFDE",142,0)
 Q
"RTN","IBDFDE",143,0)
 ;
"RTN","IBDFDE",144,0)
EXPAND(X) ; -- sets standard varibles for form data
"RTN","IBDFDE",145,0)
 S (DFN,IBDF("DFN"))=$P(X,"^",2) ;DFN
"RTN","IBDFDE",146,0)
 S IBDF("CLINIC")=$P(X,"^",7) ;   clinic ien
"RTN","IBDFDE",147,0)
 S IBDPTNM=$P(X,"^") ;    patient name
"RTN","IBDFDE",148,0)
 S IBDPID=$P(X,"^",3) ;   Patient identifier (ssn)
"RTN","IBDFDE",149,0)
 S IBDFMNME=$P(X,"^",4) ; form name
"RTN","IBDFDE",150,0)
 S IBDFMIEN=$P(X,"^",5) ; form ien (pointer to 357)
"RTN","IBDFDE",151,0)
 S IBDCLNME=$P(X,"^",6) ; clinic name
"RTN","IBDFDE",152,0)
 S IBDCLNPH=$P(X,"^",8) ; clinic physical location
"RTN","IBDFDE",153,0)
 S IBDF("APPT")=$P(X,"^",9) ; appt date/time (fm format)
"RTN","IBDFDE",154,0)
 S IBDPTDTE=$P(X,"^",10) ;appt date (external format)
"RTN","IBDFDE",155,0)
 S IBDPTSTI=$P(X,"^",11) ;appt status (piece two of "S" node)
"RTN","IBDFDE",156,0)
 S IBDPTSTE=$P(X,"^",12) ;appt status expanded
"RTN","IBDFDE",157,0)
 S IBDFMSTI=$P(X,"^",13) ;form status (internal)
"RTN","IBDFDE",158,0)
 S IBDFMSTE=$P(X,"^",14) ;form status (expanded)
"RTN","IBDFDE",159,0)
 S IBDF("FRMDEF")=$P(X,"^",15) ;form id (pointer to 357.95)
"RTN","IBDFDE",160,0)
 S IBDPTPRI=$P(X,"^",16) ;default provider internal
"RTN","IBDFDE",161,0)
 S IBDPTPRI=$P(X,"^",17) ;default provider external
"RTN","IBDFDE",162,0)
 S IBDCKOUT=$P(X,"^",20) ;checkout dt
"RTN","IBDFDE",163,0)
 S IBDF("SDOE")=$$FNDSDOE(DFN,IBDF("APPT")) ;outpatient encounter
"RTN","IBDFDE",164,0)
 Q
"RTN","IBDFDE",165,0)
 ;Q $$GETAPT^SDVSIT2(DFN,APPT,IBDF("CLINIC"))
"RTN","IBDFDE",166,0)
 ; -- will create encounters for appts/unsch vsts (but not disps or ae?)
"RTN","IBDFDE",167,0)
 ;
"RTN","IBDFDE",168,0)
FNDSDOE(DFN,APPT) ; -- returns pointer to opt encounter for appt.
"RTN","IBDFDE",169,0)
 N SDOE
"RTN","IBDFDE",170,0)
 S SDOE=$P($G(^DPT(+$G(DFN),"S",+$G(APPT),0)),"^",20)
"RTN","IBDFDE",171,0)
 I SDOE="",$G(^DPT(+$G(DFN),"S",+$G(APPT),0))="" S SDOE=$P($$SDV^IBDFRPC3(DFN,APPT),"^",2)
"RTN","IBDFDE",172,0)
 Q SDOE
"RTN","IBDFDE",173,0)
 ;
"RTN","IBDFDE",174,0)
PAUSE ; -- go to bottom of screen and pause for return
"RTN","IBDFDE",175,0)
 Q:$G(IBQUIT)
"RTN","IBDFDE",176,0)
 N I,DIR,DIRUT,DUOUT,DTOUT I $Y'>(IOSL-3)  W !!
"RTN","IBDFDE",177,0)
 I $E(IOST,1,2)["C-" S DIR(0)="E" D ^DIR S IBQUIT='Y
"RTN","IBDFDE",178,0)
 Q
"RTN","IBDFDE",179,0)
 ;
"RTN","IBDFDE",180,0)
END K I,J,X,Y,DA,DR,DIC,DIE,DIR,DTOUT,DUOUT,DIRUT,IBDSEL,CHOICE,TEXT,TEXTU,RESULT,IBDPI,IBDCO,IBDF
"RTN","IBDFDE",181,0)
 K ^TMP("IBD-ASK",$J),^TMP("IBD-LCODE",$J),^TMP("IBD-LST",$J),^TMP("IBD-LTEXT",$J),^TMP("IBD-OBJ",$J)
"RTN","IBDFDE",182,0)
 Q
"RTN","IBDFDE",183,0)
 ;
"RTN","IBDFDE",184,0)
KILLTMP K ^TMP("IBD-OBJ",$J,IBDFMIEN),^TMP("IBD-LST",$J,IBDFMIEN),^TMP("IBD-ASK",$J,IBDFMIEN),^TMP("IB",$J,"INTERFACES"),^TMP("IBD-LTEXT",$J,IBDFMIEN),^TMP("IBD-LCODE",$J,IBDFMIEN)
"RTN","IBDFDE",185,0)
 Q
"RTN","IBDFDE",186,0)
 ;
"RTN","IBDFDE",187,0)
ERR ;
"RTN","IBDFDE",188,0)
 W !!,"Entry in Form Tracking file (357.96) = ",$S($G(IBDF("FORM"))'="":IBDF("FORM"),1:"NULL")
"RTN","IBDFDE",189,0)
 W !,"   Entry in Form Definition (357.95) = ",$S($G(IBDF("FRMDEF"))'="":IBDF("FRMDEF"),1:"NULL")
"RTN","IBDFDE",190,0)
 W !,"  Entry if Encounter Form file (357) = ",$S($G(IBDFMIEN)'="":IBDFMIEN,1:"NULL"),!
"RTN","IBDFDE",191,0)
 Q
"RTN","IBDFRPC3")
0^15^B15590454
"RTN","IBDFRPC3",1,0)
IBDFRPC3 ;ALB/AAS - AICS Identify patient form form id ; 12-FEB-96
"RTN","IBDFRPC3",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**6,3**;APR 24, 1997
"RTN","IBDFRPC3",3,0)
 ;
"RTN","IBDFRPC3",4,0)
 ; -- used by AICS Data Entry System (routine IBDFDE)
"RTN","IBDFRPC3",5,0)
 ;    used by AICS Workstation software
"RTN","IBDFRPC3",6,0)
 ;
"RTN","IBDFRPC3",7,0)
IDPAT(RESULT,FORMID) ; -- Procedure
"RTN","IBDFRPC3",8,0)
 ; -- Broker call to identify patient, clinic, form, and appt. from
"RTN","IBDFRPC3",9,0)
 ;    Encounter form ID
"RTN","IBDFRPC3",10,0)
 ;    rpc := IBD EXPAND FORMID
"RTN","IBDFRPC3",11,0)
 ;
"RTN","IBDFRPC3",12,0)
 ; -- input  FORMID = pointer to form tracking (357.96)
"RTN","IBDFRPC3",13,0)
 ;                    if Formid := Formid_"LOOKUP" then no errors created
"RTN","IBDFRPC3",14,0)
 ;           Result = called by reference
"RTN","IBDFRPC3",15,0)
 ;
"RTN","IBDFRPC3",16,0)
 ; -- output  The format of the returned array is as follows
"RTN","IBDFRPC3",17,0)
 ;        result = $p1 :=  Patient Name^
"RTN","IBDFRPC3",18,0)
 ;                 $p2 :=  Patient IEN
"RTN","IBDFRPC3",19,0)
 ;                 $p3 :=  patient primary identifier (pid)
"RTN","IBDFRPC3",20,0)
 ;                 $p4 :=  form name
"RTN","IBDFRPC3",21,0)
 ;                 $p5 :=  form IEN (pointer to 357)
"RTN","IBDFRPC3",22,0)
 ;                 $p6 :=  Clinic Name 
"RTN","IBDFRPC3",23,0)
 ;                 $p7 :=  Clinic ien
"RTN","IBDFRPC3",24,0)
 ;                 $p8 :=  Clinic Physical Location
"RTN","IBDFRPC3",25,0)
 ;                 $p9 :=  Appt. date/time (fm format)
"RTN","IBDFRPC3",26,0)
 ;                 $P10:=  Appt. date/time (external format)
"RTN","IBDFRPC3",27,0)
 ;                 $P11:=  Appt Status internal
"RTN","IBDFRPC3",28,0)
 ;                 $P12:=  Appt Status external
"RTN","IBDFRPC3",29,0)
 ;                 $P13:=  form input status internal
"RTN","IBDFRPC3",30,0)
 ;                 $p14:=  form input status external
"RTN","IBDFRPC3",31,0)
 ;                 $p15:=  form definition ien (357.95)
"RTN","IBDFRPC3",32,0)
 ;                 $p16:=  default provider (for clinic) internal
"RTN","IBDFRPC3",33,0)
 ;                 $p17:=  default provider (for clinic) external
"RTN","IBDFRPC3",34,0)
 ;                 $P18:=  # Scannable pages on form
"RTN","IBDFRPC3",35,0)
 ;                 $p19:=  shortedge/long edge binding
"RTN","IBDFRPC3",36,0)
 ;                 $p20:=  check out date time
"RTN","IBDFRPC3",37,0)
 ;
"RTN","IBDFRPC3",38,0)
 N C,I,J,X,Y,NODE,PATNM,DFN,PID,CLIN,CLINNM,FORMNM,FORM,APPT,APPTNM,STATUS,STATNM,FRMDEF,PROVDEF,APPTSTI,APPTSTE,CLINPH,DUPLX,SCANPG,CO,LOOKUP
"RTN","IBDFRPC3",39,0)
 K RESULT
"RTN","IBDFRPC3",40,0)
 S FORMID("SOURCE")=1
"RTN","IBDFRPC3",41,0)
 S LOOKUP=0
"RTN","IBDFRPC3",42,0)
 ;
"RTN","IBDFRPC3",43,0)
 ; -- formid is for lookup only
"RTN","IBDFRPC3",44,0)
 I $E(FORMID,($L(FORMID)-5),$L(FORMID))="LOOKUP" S FORMID=+FORMID,LOOKUP=1
"RTN","IBDFRPC3",45,0)
 ;
"RTN","IBDFRPC3",46,0)
 ; -- scanner may send in leading spaces, strip it off
"RTN","IBDFRPC3",47,0)
 I +FORMID'=FORMID,$L(FORMID) S FORMID=+$P(FORMID," ",3)
"RTN","IBDFRPC3",48,0)
 S RESULT="Form ID not a valid value, null or zero^^^"
"RTN","IBDFRPC3",49,0)
 I '$G(FORMID) D:'$G(LOOKUP) LOGERR^IBDF18E2(3579604,.FORMID) G IDPATQ
"RTN","IBDFRPC3",50,0)
 ;
"RTN","IBDFRPC3",51,0)
 S RESULT="Form ID not found^^^"
"RTN","IBDFRPC3",52,0)
 S NODE=$G(^IBD(357.96,+FORMID,0))
"RTN","IBDFRPC3",53,0)
 I NODE="" D:'$G(LOOKUP) LOGERR^IBDF18E2(3579605,.FORMID) G IDPATQ
"RTN","IBDFRPC3",54,0)
 ;
"RTN","IBDFRPC3",55,0)
 S DFN=+$P(NODE,"^",2)
"RTN","IBDFRPC3",56,0)
 I 'DFN S RESULT="Patient Information is Missing^^^^" G IDPATQ
"RTN","IBDFRPC3",57,0)
 S PATNM=$P($G(^DPT(DFN,0)),"^"),PID=$P($G(^DPT(DFN,.36)),"^",3)
"RTN","IBDFRPC3",58,0)
 S APPT=+$P(NODE,"^",3)
"RTN","IBDFRPC3",59,0)
 S APPTSTI=$P($G(^DPT(DFN,"S",APPT,0)),"^",2)
"RTN","IBDFRPC3",60,0)
 S APPTNM=$$FMTE^XLFDT(APPT)
"RTN","IBDFRPC3",61,0)
 ;
"RTN","IBDFRPC3",62,0)
 S X=$$STATUS^SDAM1(DFN,APPT,+$G(^DPT(DFN,"S",APPT,0)),$G(^(0)))
"RTN","IBDFRPC3",63,0)
 S APPTSTE=$P(X,";",3),CO=$P(X,";",5)
"RTN","IBDFRPC3",64,0)
 I $G(^DPT(DFN,"S",APPT,0))="",CO="" D
"RTN","IBDFRPC3",65,0)
 .S CO=+$$SDV(DFN,APPT)
"RTN","IBDFRPC3",66,0)
 .I CO S APPTSTE="COMPLETE"
"RTN","IBDFRPC3",67,0)
 .I +$G(CO)<1 S APPTSTE="ACTION REQUIRED"
"RTN","IBDFRPC3",68,0)
 ;
"RTN","IBDFRPC3",69,0)
 S CLIN=+$P(NODE,"^",10)
"RTN","IBDFRPC3",70,0)
 S CLINNM=$P($G(^SC(CLIN,0)),"^"),CLINPH=$P($G(^SC(CLIN,0)),"^",11)
"RTN","IBDFRPC3",71,0)
 S PROVDEF=$$PRDEF(CLIN)
"RTN","IBDFRPC3",72,0)
 S FRMDEF=$P(NODE,"^",4)
"RTN","IBDFRPC3",73,0)
 S FORM=+$P($G(^IBD(357.95,+FRMDEF,0)),"^",21)
"RTN","IBDFRPC3",74,0)
 S FORMNM=$P($G(^IBE(357,FORM,0)),"^")
"RTN","IBDFRPC3",75,0)
 S DUPLX=$P($G(^IBE(357,FORM,0)),"^",2) ; Duplex/simplex
"RTN","IBDFRPC3",76,0)
 S (SCANPG,I)=0 F  S I=$O(^IBD(357.96,+FORMID,9,I)) Q:'I  S SCANPG=SCANPG+1
"RTN","IBDFRPC3",77,0)
 S STATUS=$P(NODE,"^",11)
"RTN","IBDFRPC3",78,0)
 S Y=STATUS,C=$P(^DD(357.96,.11,0),"^",2) D Y^DIQ S STATNM=Y
"RTN","IBDFRPC3",79,0)
 S RESULT=PATNM_"^"_DFN_"^"_PID_"^"_FORMNM_"^"_FORM_"^"_CLINNM_"^"_CLIN_"^"_CLINPH_"^"_APPT_"^"_APPTNM_"^"_APPTSTI_"^"_APPTSTE_"^"_STATUS_"^"_STATNM_"^"_FRMDEF_"^"_PROVDEF_"^"_$P($G(^VA(200,+PROVDEF,0)),"^")_"^"_SCANPG_"^"_DUPLX_"^"_CO
"RTN","IBDFRPC3",80,0)
 ;
"RTN","IBDFRPC3",81,0)
IDPATQ Q
"RTN","IBDFRPC3",82,0)
 ;
"RTN","IBDFRPC3",83,0)
PRDEF(CLIN) ;Provider Default for Clinic
"RTN","IBDFRPC3",84,0)
 ; Input  -- SDCL     Hospital Location file IEN
"RTN","IBDFRPC3",85,0)
 ; IF DEFINED: DFN - ptr to PATIENT File
"RTN","IBDFRPC3",86,0)
 ; Output -- Default
"RTN","IBDFRPC3",87,0)
 N Y,X
"RTN","IBDFRPC3",88,0)
 S Y=$P($G(^SC(+$G(CLIN),"PR",+$O(^SC("ADPR",CLIN,0)),0)),"^")
"RTN","IBDFRPC3",89,0)
 I $G(Y)="",$G(^SC(+$G(CLIN),"PC")),$D(DFN),$L($T(NMPCPR^SCAPMCU2)) S Y=+$$NMPCPR^SCAPMCU2(DFN,DT,1)
"RTN","IBDFRPC3",90,0)
 Q $G(Y)
"RTN","IBDFRPC3",91,0)
 ;
"RTN","IBDFRPC3",92,0)
SDV(DFN,APPT) ; -- try to find checkout date of stand alone encounter
"RTN","IBDFRPC3",93,0)
 N CO,QUIT,SDV,SDV1,SDOE
"RTN","IBDFRPC3",94,0)
 S CO="",SDOE=""
"RTN","IBDFRPC3",95,0)
 S SDV=+$P(APPT,"."),QUIT=0
"RTN","IBDFRPC3",96,0)
 F  S SDV=+$O(^SDV("C",DFN,SDV)) Q:'SDV!(QUIT)  D
"RTN","IBDFRPC3",97,0)
 .S SDV1=0 F  S SDV1=+$O(^SDV(+SDV,"CS",SDV1)) Q:'SDV1!(QUIT)  D
"RTN","IBDFRPC3",98,0)
 ..S SDOE=+$P($G(^SDV(+SDV,"CS",+SDV1,0)),"^",8)
"RTN","IBDFRPC3",99,0)
 ..S X=$G(^SCE(+SDOE,0)) I +X=APPT S CO=$P(X,"^",7),QUIT=1 Q
"RTN","IBDFRPC3",100,0)
 ..S (SDOE,CO)=""
"RTN","IBDFRPC3",101,0)
 Q CO_"^"_SDOE
"RTN","IBDFRPC5")
0^13^B12346956
"RTN","IBDFRPC5",1,0)
IBDFRPC5 ;ALB/AAS - AICS Pass data to PCE, Broker Call ; 24-FEB-96
"RTN","IBDFRPC5",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDFRPC5",3,0)
 ;
"RTN","IBDFRPC5",4,0)
GETALL(RESULT,IBDATA) ; -- called by RPC and by write
"RTN","IBDFRPC5",5,0)
 ; -- get all encounter data
"RTN","IBDFRPC5",6,0)
 ; -- input  Result (called by reference)
"RTN","IBDFRPC5",7,0)
 ;           IBDATA (called by reference)
"RTN","IBDFRPC5",8,0)
 ;           IBDATA("CLINIC")   := pointer to hospital location file (44)
"RTN","IBDFRPC5",9,0)
 ;           IBDATA("DFN")      := pointer to Patient file (2)
"RTN","IBDFRPC5",10,0)
 ;           IBDATA("APPT")     := date/time of encounter in FM format
"RTN","IBDFRPC5",11,0)
 ;           IBDATA("UNFORMAT") := (optional, default :=0) return piece
"RTN","IBDFRPC5",12,0)
 ;                                  as displayable
"RTN","IBDFRPC5",13,0)
 ; -- output Results Array
"RTN","IBDFRPC5",14,0)
 ;           A sequential array of all data found for encounters for
"RTN","IBDFRPC5",15,0)
 ;             patient/clinic/appt
"RTN","IBDFRPC5",16,0)
 ;           if ibdata(unformat) is false then data is preformatted
"RTN","IBDFRPC5",17,0)
 ;              suitable for display to a crt.
"RTN","IBDFRPC5",18,0)
 ;           if ibdata(unformat) is true then a record as follows:
"RTN","IBDFRPC5",19,0)
 ;              P1  :=  data qualifier (ie primary or secondary)
"RTN","IBDFRPC5",20,0)
 ;              P2  :=  type of data
"RTN","IBDFRPC5",21,0)
 ;              p3  :=  Narrative or Description (Textual name)
"RTN","IBDFRPC5",22,0)
 ;              P4  :=  value (code or date/time)
"RTN","IBDFRPC5",23,0)
 ;              P5  :=  source of data (aics, pce, scheduling)
"RTN","IBDFRPC5",24,0)
 ;              P6  :=  Quantity (cpt codes only)
"RTN","IBDFRPC5",25,0)
 ;                      The next 4 pieces only set if answered
"RTN","IBDFRPC5",26,0)
 ;              P7  :=  sc (null, 1 or 0) encounter node only
"RTN","IBDFRPC5",27,0)
 ;              P8  :=  ao (null, 1 or 0) encounter node only
"RTN","IBDFRPC5",28,0)
 ;              P9  :=  ir (null, 1 or 0) encounter node only
"RTN","IBDFRPC5",29,0)
 ;              P10 :=  ec (null, 1 or 0) encounter node only
"RTN","IBDFRPC5",30,0)
 ;
"RTN","IBDFRPC5",31,0)
 N CNT,IBDI,ENCTRS,L
"RTN","IBDFRPC5",32,0)
 S CNT=0,ENCTRS=""
"RTN","IBDFRPC5",33,0)
 D GETDATA(.RESULT,.IBDATA,.ENCTRS)
"RTN","IBDFRPC5",34,0)
 S L="                             "
"RTN","IBDFRPC5",35,0)
 I +RESULT(0) S RESULT(0)="The following data was found: " D FINDALL^IBDFRPC6(.RESULT)
"RTN","IBDFRPC5",36,0)
 ;F IBDI="VST","PRV","POV","CPT","HF","PED","XAM","SK","IMM","TRT" D @(IBDI_"^IBDFRPC6")
"RTN","IBDFRPC5",37,0)
GETALLQ Q
"RTN","IBDFRPC5",38,0)
 ;
"RTN","IBDFRPC5",39,0)
GETDATA(RESULT,IBDATA,ENCTRS) ; -- return all data for an encounter date time
"RTN","IBDFRPC5",40,0)
 ;
"RTN","IBDFRPC5",41,0)
 N IBDJ,IBDY
"RTN","IBDFRPC5",42,0)
 K ^TMP("PXKENC",$J)
"RTN","IBDFRPC5",43,0)
 I +IBDATA("CLINIC")'=IBDATA("CLINIC"),IBDATA("CLINIC")'="" S IBDATA("CLINIC")=$O(^SC("B",IBDATA("CLINIC"),0))
"RTN","IBDFRPC5",44,0)
 S RESULT(0)="Nothing Processed, Perhaps an Error Occured"
"RTN","IBDFRPC5",45,0)
 I $G(IBDATA("DFN"))<1!($G(IBDATA("APPT"))<1)!($G(IBDATA("CLINIC"))<1) S RESULT(0)="Insufficient Data Passed to find encounter data" G GETQ
"RTN","IBDFRPC5",46,0)
 ;
"RTN","IBDFRPC5",47,0)
 ; -- first get visit iens
"RTN","IBDFRPC5",48,0)
 S ENCTRS=$$GETENC^PXAPI(IBDATA("DFN"),IBDATA("APPT"),IBDATA("CLINIC"))
"RTN","IBDFRPC5",49,0)
 I ENCTRS=-1 S RESULT(0)="No encounter Data on file." G GETQ
"RTN","IBDFRPC5",50,0)
 I ENCTRS=-2 S RESULT(0)="Error in calling routine, file a NOIS" G GETQ
"RTN","IBDFRPC5",51,0)
 ;
"RTN","IBDFRPC5",52,0)
 ; -- then get all visit data
"RTN","IBDFRPC5",53,0)
 S RESULT(0)="Attempting to Retieve Data"
"RTN","IBDFRPC5",54,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:IBDY=""  D ENCEVENT^PXAPI(IBDY,1)
"RTN","IBDFRPC5",55,0)
 ;
"RTN","IBDFRPC5",56,0)
 S RESULT(0)="1"
"RTN","IBDFRPC5",57,0)
GETQ Q
"RTN","IBDFRPC5",58,0)
 ;
"RTN","IBDFRPC5",59,0)
WRITE ; -- called by DIR as executable help from IBDFDE
"RTN","IBDFRPC5",60,0)
 N RESULT,IBQUIT,I,CNT
"RTN","IBDFRPC5",61,0)
 W !,"Retrieving Encounter Data from PCE..."
"RTN","IBDFRPC5",62,0)
 D GETALL(.RESULT,.IBDF)
"RTN","IBDFRPC5",63,0)
 W !
"RTN","IBDFRPC5",64,0)
 S I="",IBQUIT=0,CNT=0
"RTN","IBDFRPC5",65,0)
 F  S I=$O(RESULT(I)) Q:I=""  S CNT=CNT+1 D:'(CNT#10) PAUSE^IBDFDE Q:IBQUIT  W !,RESULT(I)
"RTN","IBDFRPC5",66,0)
 Q
"RTN","IBDFRPC5",67,0)
 ;
"RTN","IBDFRPC5",68,0)
APPTLST(RESULT,IBDF) ; -- return past appointment list, called by rpc
"RTN","IBDFRPC5",69,0)
 N I,J,CNT,DFN,VASD,VAERR,VAROOT
"RTN","IBDFRPC5",70,0)
 S RESULT(0)="No Past Appointments Found^^"
"RTN","IBDFRPC5",71,0)
 K ^UTILITY("VASD",$J)
"RTN","IBDFRPC5",72,0)
 ;
"RTN","IBDFRPC5",73,0)
 S DFN=+$G(IBDF("DFN"))
"RTN","IBDFRPC5",74,0)
 S VASD("F")=$S($G(IBDF("F"))>2840000:IBDF("F"),1:DT-10000)
"RTN","IBDFRPC5",75,0)
 S VASD("T")=$S($G(IBDF("T"))>2840000:IBDF("T"),1:DT+.24)
"RTN","IBDFRPC5",76,0)
 S VASD("W")=$S($G(IBDF("W"))'="":IBDF("W"),1:"129")
"RTN","IBDFRPC5",77,0)
 ;
"RTN","IBDFRPC5",78,0)
 D SDA^VADPT
"RTN","IBDFRPC5",79,0)
 ;
"RTN","IBDFRPC5",80,0)
 I $O(^UTILITY("VASD",$J,"")) S CNT=0
"RTN","IBDFRPC5",81,0)
 S I="" F  S I=$O(^UTILITY("VASD",$J,I),-1) Q:I=""  S RESULT(CNT)=$G(^UTILITY("VASD",$J,I,"E"))_"^"_$G(^UTILITY("VASD",$J,I,"I")),CNT=CNT+1
"RTN","IBDFRPC5",82,0)
 ;
"RTN","IBDFRPC5",83,0)
 I VAERR=1 S RESULT(0)="Invalid Patient Identifier^^"
"RTN","IBDFRPC5",84,0)
 K ^UTILITY("VASD",$J)
"RTN","IBDFRPC5",85,0)
 Q
"RTN","IBDFRPC5",86,0)
 ;
"RTN","IBDFRPC5",87,0)
TEST ;
"RTN","IBDFRPC5",88,0)
 K IBDF,ALAN
"RTN","IBDFRPC5",89,0)
 S IBDF("DFN")=7169761
"RTN","IBDFRPC5",90,0)
 S IBDF("CLINIC")=300
"RTN","IBDFRPC5",91,0)
 S IBDF("APPT")=2970902.0849
"RTN","IBDFRPC5",92,0)
 S IBDF("UNFORMAT")=1
"RTN","IBDFRPC5",93,0)
 D GETALL(.ALAN,.IBDF)
"RTN","IBDFRPC5",94,0)
 Q
"RTN","IBDFRPC5",95,0)
TESTW ;
"RTN","IBDFRPC5",96,0)
 K IBDF
"RTN","IBDFRPC5",97,0)
 S IBDF("DFN")=7169761
"RTN","IBDFRPC5",98,0)
 S IBDF("CLINIC")=300
"RTN","IBDFRPC5",99,0)
 S IBDF("APPT")=2970902.0849
"RTN","IBDFRPC5",100,0)
 D WRITE
"RTN","IBDFRPC5",101,0)
 K IBDF
"RTN","IBDFRPC5",102,0)
 Q
"RTN","IBDFRPC5",103,0)
 ;
"RTN","IBDFRPC5",104,0)
TESTA ;
"RTN","IBDFRPC5",105,0)
 K ALAN,IBDF
"RTN","IBDFRPC5",106,0)
 S IBDF("DFN")=7169761
"RTN","IBDFRPC5",107,0)
 D APPTLST(.ALAN,.IBDF)
"RTN","IBDFRPC5",108,0)
 Q
"RTN","IBDFRPC6")
0^14^B54581145
"RTN","IBDFRPC6",1,0)
IBDFRPC6 ;ALB/AAS - AICS Pass data to PCE, Broker Call ; 24-FEB-96
"RTN","IBDFRPC6",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDFRPC6",3,0)
 ;
"RTN","IBDFRPC6",4,0)
FINDALL(RESULT) ; -- loop through all entries for data
"RTN","IBDFRPC6",5,0)
 ; -- called from ibdfrpc5, ONLY call if data in ^tmp
"RTN","IBDFRPC6",6,0)
 N IBDI
"RTN","IBDFRPC6",7,0)
 S RESULT(0)="The following data was found: "
"RTN","IBDFRPC6",8,0)
 F IBDI="VST","PRV","POV","CPT","HF","PED","XAM","SK","IMM","TRT" D @(IBDI)
"RTN","IBDFRPC6",9,0)
 Q
"RTN","IBDFRPC6",10,0)
 ;
"RTN","IBDFRPC6",11,0)
PRV ; -- Expand Provider Entry
"RTN","IBDFRPC6",12,0)
 N IBDY,IBDJ,IEN,X,Y
"RTN","IBDFRPC6",13,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",14,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"PRV",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",15,0)
 ..D GETY(.Y,IBDY,"PRV",IEN)
"RTN","IBDFRPC6",16,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",17,0)
 ...S X=$S($P(Y,"^",4)="P":"Primary",1:"Secondary")_"^Provider^"_$P($G(^VA(200,+Y,0)),"^")
"RTN","IBDFRPC6",18,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.06)
"RTN","IBDFRPC6",19,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",20,0)
 ...S X=$S($P(Y,"^",4)="P":"   Primary",1:" Secondary")_" Provider:  "_$P($G(^VA(200,+Y,0)),"^")
"RTN","IBDFRPC6",21,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",22,0)
 Q
"RTN","IBDFRPC6",23,0)
 ;
"RTN","IBDFRPC6",24,0)
POV ; -- Expand POV entry, (9000010.07)
"RTN","IBDFRPC6",25,0)
 N IBDY,IBDJ,IEN,X,Y
"RTN","IBDFRPC6",26,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",27,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"POV",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",28,0)
 ..D GETY(.Y,IBDY,"POV",IEN)
"RTN","IBDFRPC6",29,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",30,0)
 ...S X=$S($P(Y,"^",12)="P":"  Primary",1:"Secondary")_" Diagnosis:  "
"RTN","IBDFRPC6",31,0)
 ...S X=X_$E($P($G(^ICD9(+Y,0)),"^")_"   ",1,6)_" - "
"RTN","IBDFRPC6",32,0)
 ...IF $P(Y,"^",4) S X=X_$$EXTERNAL^DILFD(9000010.07,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",33,0)
 ...ELSE  S X=X_$E($G(^ICD9(+Y,1)),1,80)
"RTN","IBDFRPC6",34,0)
 ..;
"RTN","IBDFRPC6",35,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",36,0)
 ...S X=$S($P(Y,"^",12)="P":"Primary",1:"Secondary")_"^Diagnosis^"
"RTN","IBDFRPC6",37,0)
 ...IF $P(Y,"^",4) S X=X_$$EXTERNAL^DILFD(9000010.07,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",38,0)
 ...ELSE  S X=X_$E($G(^ICD9(+Y,1)),1,80)
"RTN","IBDFRPC6",39,0)
 ...S X=X_"^"_$E($P($G(^ICD9(+Y,0)),"^")_"   ",1,6)
"RTN","IBDFRPC6",40,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.07)
"RTN","IBDFRPC6",41,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",42,0)
 Q
"RTN","IBDFRPC6",43,0)
 ;
"RTN","IBDFRPC6",44,0)
CPT ; -- Expand CPT entry
"RTN","IBDFRPC6",45,0)
 N IBDY,IBDJ,IEN,QUAN,X,Y
"RTN","IBDFRPC6",46,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",47,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"CPT",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",48,0)
 ..D GETY(.Y,IBDY,"CPT",IEN)
"RTN","IBDFRPC6",49,0)
 ..S QUAN=$P(Y,"^",16)
"RTN","IBDFRPC6",50,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",51,0)
 ...S X="          Procedure:  "_$P($G(^ICPT(+Y,0)),"^")_"  - "
"RTN","IBDFRPC6",52,0)
 ...IF $P(Y,"^",4) S X=X_$$EXTERNAL^DILFD(9000010.18,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",53,0)
 ...ELSE  S X=X_$P($G(^ICPT(+Y,0)),"^",2)
"RTN","IBDFRPC6",54,0)
 ...S X=X_"   Quantity: "_QUAN
"RTN","IBDFRPC6",55,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",56,0)
 ...S X="^Procedure^"
"RTN","IBDFRPC6",57,0)
 ...IF $P(Y,"^",4) S X=X_$$EXTERNAL^DILFD(9000010.18,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",58,0)
 ...ELSE  S X=X_$P($G(^ICPT(+Y,0)),"^",2)
"RTN","IBDFRPC6",59,0)
 ...S X=X_"^"_$P($G(^ICPT(+Y,0)),"^")_"^"_$$SOURCE(9000010.18)_"^"_QUAN
"RTN","IBDFRPC6",60,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",61,0)
 Q
"RTN","IBDFRPC6",62,0)
 ;
"RTN","IBDFRPC6",63,0)
HF ; -- Expand Health Factors
"RTN","IBDFRPC6",64,0)
 N IBDY,IBDJ,IEN,X,Y,Z
"RTN","IBDFRPC6",65,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",66,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"HF",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",67,0)
 ..D GETY(.Y,IBDY,"HF",IEN)
"RTN","IBDFRPC6",68,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",69,0)
 ...S X="      Health Factor:  "_$E($$EXTERNAL^DILFD(9000010.23,.01,"",+Y)_L,1,25)
"RTN","IBDFRPC6",70,0)
 ...I $P(Y,"^",4)'="" S X=X_" Severity="_$$EXTERNAL^DILFD(9000010.23,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",71,0)
 ..;
"RTN","IBDFRPC6",72,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",73,0)
 ...I $P(Y,"^",4)'="" S X=$$EXTERNAL^DILFD(9000010.23,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",74,0)
 ...S X=X_"^Health Factor^"_$E($$EXTERNAL^DILFD(9000010.23,.01,"",+Y),1,25)
"RTN","IBDFRPC6",75,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.23)
"RTN","IBDFRPC6",76,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",77,0)
 Q
"RTN","IBDFRPC6",78,0)
 ;
"RTN","IBDFRPC6",79,0)
IMM ; -- Expand Immunizations
"RTN","IBDFRPC6",80,0)
 N IBDY,IBDJ,IEN,X,Y
"RTN","IBDFRPC6",81,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",82,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"IMM",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",83,0)
 ..D GETY(.Y,IBDY,"IMM",IEN)
"RTN","IBDFRPC6",84,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",85,0)
 ...S X="       Immunization:  "_$$EXTERNAL^DILFD(9000010.11,.01,"",+Y)
"RTN","IBDFRPC6",86,0)
 ...I $P(Y,"^",7) S X=X_"  Contraindicated!"
"RTN","IBDFRPC6",87,0)
 ..;
"RTN","IBDFRPC6",88,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",89,0)
 ...S X="" I $P(Y,"^",7) S X="Contraindicated"
"RTN","IBDFRPC6",90,0)
 ...S X=X_"^Immunization^"_$$EXTERNAL^DILFD(9000010.11,.01,"",+Y)
"RTN","IBDFRPC6",91,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.11)
"RTN","IBDFRPC6",92,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",93,0)
 Q
"RTN","IBDFRPC6",94,0)
 ;
"RTN","IBDFRPC6",95,0)
PED ; -- Expand Patient Education
"RTN","IBDFRPC6",96,0)
 N IBDY,IBDJ,IEN,X,Y
"RTN","IBDFRPC6",97,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",98,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"PED",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",99,0)
 ..D GETY(.Y,IBDY,"PED",IEN)
"RTN","IBDFRPC6",100,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",101,0)
 ...S X="    Education Topic:  "_$E($$EXTERNAL^DILFD(9000010.16,.01,"",+Y)_L,1,25)
"RTN","IBDFRPC6",102,0)
 ...I $P(Y,"^",6)'="" S X=X_" Understanding="_$$EXTERNAL^DILFD(9000010.16,.06,"",$P(Y,"^",6))
"RTN","IBDFRPC6",103,0)
 ..;
"RTN","IBDFRPC6",104,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",105,0)
 ...S X=""
"RTN","IBDFRPC6",106,0)
 ...I $P(Y,"^",6)'="" S X=$$EXTERNAL^DILFD(9000010.16,.06,"",$P(Y,"^",6))
"RTN","IBDFRPC6",107,0)
 ...S X=X_"^Education Topic^"_$E($$EXTERNAL^DILFD(9000010.16,.01,"",+Y),1,25)
"RTN","IBDFRPC6",108,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.16)
"RTN","IBDFRPC6",109,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",110,0)
 Q
"RTN","IBDFRPC6",111,0)
 ;
"RTN","IBDFRPC6",112,0)
SK ; -- Expand Skin Tests
"RTN","IBDFRPC6",113,0)
 N IBDY,IBDJ,IEN,X,Y,Z
"RTN","IBDFRPC6",114,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",115,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"SK",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",116,0)
 ..D GETY(.Y,IBDY,"SK",IEN)
"RTN","IBDFRPC6",117,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",118,0)
 ...S X="          Skin Test:  "_$E($$EXTERNAL^DILFD(9000010.12,.01,"",+Y)_L,1,25)
"RTN","IBDFRPC6",119,0)
 ...I $P(Y,"^",4)'="" S X=X_" Result="_$$EXTERNAL^DILFD(9000010.12,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",120,0)
 ..;
"RTN","IBDFRPC6",121,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",122,0)
 ...S X=$$EXTERNAL^DILFD(9000010.12,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",123,0)
 ...S X=X_"^Skin Test^"_$E($$EXTERNAL^DILFD(9000010.12,.01,"",+Y),1,25)
"RTN","IBDFRPC6",124,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.12)
"RTN","IBDFRPC6",125,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",126,0)
 Q
"RTN","IBDFRPC6",127,0)
 ;
"RTN","IBDFRPC6",128,0)
TRT ; -- Expand Treatments
"RTN","IBDFRPC6",129,0)
 N IBDY,IBDJ,IEN,X,Y,TRT
"RTN","IBDFRPC6",130,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",131,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"TRT",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",132,0)
 ..D GETY(.Y,IBDY,"TRT",IEN)
"RTN","IBDFRPC6",133,0)
 ..S TRT=$$EXTERNAL^DILFD(9000010.15,.01,"",+Y)
"RTN","IBDFRPC6",134,0)
 ..I TRT="OTHER" S TRT=$$EXTERNAL^DILFD(9000010.15,.06,"",$P(Y,"^",6))
"RTN","IBDFRPC6",135,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",136,0)
 ...S X="          Treatment:  "_TRT
"RTN","IBDFRPC6",137,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",138,0)
 ...S X="^Treatment^"_TRT
"RTN","IBDFRPC6",139,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.15)
"RTN","IBDFRPC6",140,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",141,0)
 Q
"RTN","IBDFRPC6",142,0)
 ;
"RTN","IBDFRPC6",143,0)
XAM ; -- Expand Exams
"RTN","IBDFRPC6",144,0)
 N IBDY,IBDJ,IEN,X,Y
"RTN","IBDFRPC6",145,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",146,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"XAM",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",147,0)
 ..D GETY(.Y,IBDY,"XAM",IEN)
"RTN","IBDFRPC6",148,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",149,0)
 ...S X="               Exam:  "_$E($$EXTERNAL^DILFD(9000010.13,.01,"",+Y)_L,1,25)
"RTN","IBDFRPC6",150,0)
 ...S X=X_" Result="_$$EXTERNAL^DILFD(9000010.13,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",151,0)
 ..;
"RTN","IBDFRPC6",152,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",153,0)
 ...S X=$$EXTERNAL^DILFD(9000010.13,.04,"",$P(Y,"^",4))
"RTN","IBDFRPC6",154,0)
 ...S X=X_"^Exam^"_$E($$EXTERNAL^DILFD(9000010.13,.01,"",+Y),1,25)
"RTN","IBDFRPC6",155,0)
 ...S $P(X,"^",5)=$$SOURCE(9000010.13)
"RTN","IBDFRPC6",156,0)
 ..D INC(X,.CNT)
"RTN","IBDFRPC6",157,0)
 Q
"RTN","IBDFRPC6",158,0)
 ;
"RTN","IBDFRPC6",159,0)
VST ; -- Expand visit entry
"RTN","IBDFRPC6",160,0)
 N IBDY,IBDJ,IBDZ,IEN,X,Y
"RTN","IBDFRPC6",161,0)
 F IBDJ=1:1 S IBDY=$P(ENCTRS,"^",IBDJ) Q:'IBDY  D
"RTN","IBDFRPC6",162,0)
 .S IEN=0 F  S IEN=$O(^TMP("PXKENC",$J,IBDY,"VST",IEN)) Q:'IEN  D
"RTN","IBDFRPC6",163,0)
 ..D GETY(.Y,IBDY,"VST",IEN)
"RTN","IBDFRPC6",164,0)
 ..I '$G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",165,0)
 ...S X="     Encounter Info:  "_$$EXTERNAL^DILFD(9000010,.22,"",$P(Y,"^",22))_" - "_$$FMTE^XLFDT(+Y)_" - "_$$EXTERNAL^DILFD(9000010,15003,"",$P(Y(150),"^",3))_" Encounter"
"RTN","IBDFRPC6",166,0)
 ...D INC(X,.CNT)
"RTN","IBDFRPC6",167,0)
 ...S X=""
"RTN","IBDFRPC6",168,0)
 ...S X=$$SOURCE(9000010) I X'="" S X=$E(L,1,22)_"Source - "_X
"RTN","IBDFRPC6",169,0)
 ...I $P(Y(800),"^",1)'="" S X=X_", SC := "_$S($P(Y(800),"^",1):"Yes",1:"No")
"RTN","IBDFRPC6",170,0)
 ...I $P(Y(800),"^",2)'="" S X=X_", AO:="_$S($P(Y(800),"^",2):"Yes",1:"No")
"RTN","IBDFRPC6",171,0)
 ...I $P(Y(800),"^",3)'="" S X=X_", IR:="_$S($P(Y(800),"^",3):"Yes",1:"No")
"RTN","IBDFRPC6",172,0)
 ...I $P(Y(800),"^",4)'="" S X=X_", EC:="_$S($P(Y(800),"^",4):"Yes",1:"No")
"RTN","IBDFRPC6",173,0)
 ..;
"RTN","IBDFRPC6",174,0)
 ..I $G(IBDATA("UNFORMAT")) D
"RTN","IBDFRPC6",175,0)
 ...S X=$$EXTERNAL^DILFD(9000010,15003,"",$P(Y(150),"^",3))_"^Encounter^"
"RTN","IBDFRPC6",176,0)
 ...S X=X_$$EXTERNAL^DILFD(9000010,.22,"",$P(Y,"^",22))_"^"_$$FMTE^XLFDT(+Y)_"^"
"RTN","IBDFRPC6",177,0)
 ...S X=X_$$SOURCE(9000010)
"RTN","IBDFRPC6",178,0)
 ...F IBDZ=1:1:4 I $P(Y(800),"^",IBDZ)'="" S $P(X,"^",(6+IBDZ))=$P(Y(800),"^",IBDZ)
"RTN","IBDFRPC6",179,0)
 ..I X'="" D INC(X,.CNT)
"RTN","IBDFRPC6",180,0)
 Q
"RTN","IBDFRPC6",181,0)
 ;
"RTN","IBDFRPC6",182,0)
INC(X,CNT) ; -- increment results array
"RTN","IBDFRPC6",183,0)
 S CNT=CNT+1
"RTN","IBDFRPC6",184,0)
 S RESULT(CNT)=X
"RTN","IBDFRPC6",185,0)
 Q
"RTN","IBDFRPC6",186,0)
 ;
"RTN","IBDFRPC6",187,0)
GETY(Y,IBDY,TYPE,IEN) ; -- return y array
"RTN","IBDFRPC6",188,0)
 S Y=$G(^TMP("PXKENC",$J,IBDY,TYPE,IEN,0))
"RTN","IBDFRPC6",189,0)
 S Y(150)=$G(^TMP("PXKENC",$J,IBDY,TYPE,IEN,150))
"RTN","IBDFRPC6",190,0)
 S Y(812)=$G(^TMP("PXKENC",$J,IBDY,TYPE,IEN,812))
"RTN","IBDFRPC6",191,0)
 I TYPE="VST" S Y(800)=$G(^TMP("PXKENC",$J,IBDY,TYPE,IEN,800))
"RTN","IBDFRPC6",192,0)
 Q
"RTN","IBDFRPC6",193,0)
 ;
"RTN","IBDFRPC6",194,0)
SOURCE(FILE) ; -- return source of data
"RTN","IBDFRPC6",195,0)
 N X S X=""
"RTN","IBDFRPC6",196,0)
 I $P(Y(812),"^",3)'="" S X=$$EXTERNAL^DILFD(FILE,81203,"",$P(Y(812),"^",3))
"RTN","IBDFRPC6",197,0)
 I X="",$P(Y(812),"^",2)'="" S X=$$EXTERNAL^DILFD(FILE,81202,"",$P(Y(812),"^",2))
"RTN","IBDFRPC6",198,0)
 Q X
"RTN","IBDFRPC6",199,0)
 ;
"RTN","IBDFRPC6",200,0)
TEST G TEST^IBDFRPC5
"RTN","IBDFRPC6",201,0)
TESTW G TESTW^IBDFRPC5
"RTN","IBDY303")
0^5^B4060502
"RTN","IBDY303",1,0)
IBDY303 ;ALB/TMP - POST INSTALL FOR PATCH IBD*3*3 ; 23-JUN-97
"RTN","IBDY303",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDY303",3,0)
 ;
"RTN","IBDY303",4,0)
EN ; Recompile all forms in file 359.2
"RTN","IBDY303",5,0)
 N C,X,COUNT,CNT,COLWIDTH,IBDFSA,IBFORMID,IBBDT,IBEDT,IBDAY,LBEGIN,LEND,NODE10,POP,PRIORPG,QUIT
"RTN","IBDY303",6,0)
 ;
"RTN","IBDY303",7,0)
 S IBBDT=$H
"RTN","IBDY303",8,0)
 S COUNT=$P(^IBD(359.2,0),"^",4)
"RTN","IBDY303",9,0)
 ;
"RTN","IBDY303",10,0)
 D MES^XPDUTL(">>> I am going to recompile all "_COUNT_" entries in your FORM SPECS file (359.2)")
"RTN","IBDY303",11,0)
 D MES^XPDUTL(">>> Recompilation Started at "_$$HTE^XLFDT(IBBDT))
"RTN","IBDY303",12,0)
 D MES^XPDUTL(">>> This may take awhile...")
"RTN","IBDY303",13,0)
 ;
"RTN","IBDY303",14,0)
 S CNT=0
"RTN","IBDY303",15,0)
 S IBFORMID=0 F  S IBFORMID=$O(^IBD(359.2,IBFORMID)) Q:'IBFORMID  D
"RTN","IBDY303",16,0)
 .D SCAN^IBDFBKS(IBFORMID)
"RTN","IBDY303",17,0)
 .S CNT=CNT+1
"RTN","IBDY303",18,0)
 .I '$D(ZTQUEUED),'(CNT#10) D MES^XPDUTL("    "_CNT_" done, "_(COUNT-CNT)_" to go.")
"RTN","IBDY303",19,0)
 ;
"RTN","IBDY303",20,0)
 S IBEDT=$H
"RTN","IBDY303",21,0)
 D MES^XPDUTL("")
"RTN","IBDY303",22,0)
 D MES^XPDUTL(">>> Recompilation Complete at "_$$HTE^XLFDT(IBEDT))
"RTN","IBDY303",23,0)
 I $D(IBBDT) D
"RTN","IBDY303",24,0)
 .S IBDAY=+IBEDT-(+IBBDT)*86400 ;additional seconds of over midnight
"RTN","IBDY303",25,0)
 .S X=IBDAY+$P(IBEDT,",",2)-$P(IBBDT,",",2)
"RTN","IBDY303",26,0)
 .D MES^XPDUTL(">>> Elapse time for recompilation was: "_(X\3600)_" Hours,  "_(X\60-(X\3600*60))_" Minutes,  "_(X#60)_" Seconds")
"RTN","IBDY303",27,0)
 .S X=(X/COUNT)
"RTN","IBDY303",28,0)
 .D MES^XPDUTL(">>> Average Time per Entry was: "_(X\60-(X\3600*60))_" Minutes,  "_(X#60)_" Seconds")
"RTN","IBDY303",29,0)
 Q
"RTN","IBDY303E")
0^6^B2668585
"RTN","IBDY303E",1,0)
IBDY303E ;ALB/TMP - ENVIRONMENT CHECK FOR PATCH IBD*3*3 ; 23-JUN-97
"RTN","IBDY303E",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**3**;APR 24, 1997
"RTN","IBDY303E",3,0)
 ;
"RTN","IBDY303E",4,0)
EN ; Make sure patch 1 is installed first
"RTN","IBDY303E",5,0)
 Q:$G(XPDENV)'=1
"RTN","IBDY303E",6,0)
 N CNT,PATCH,Z,Z0
"RTN","IBDY303E",7,0)
 ;
"RTN","IBDY303E",8,0)
 I $S($D(DUZ)[0:1,$D(DUZ(0))[0:1,'DUZ:1,1:0) W !!,*7,">> DUZ and DUZ(0) must be defined as an active user",! S XPDQUIT=2
"RTN","IBDY303E",9,0)
 ;
"RTN","IBDY303E",10,0)
 ;Check for existence of prerequisite IBD patch 1
"RTN","IBDY303E",11,0)
 ;
"RTN","IBDY303E",12,0)
 I $T(+2^IBDF18E1)'["**1" D NOPTCH(1,.CNT)
"RTN","IBDY303E",13,0)
 ;
"RTN","IBDY303E",14,0)
 I $G(CNT) W !!,"Please install th",$S(CNT>1:"ese patches",1:"is patch")," first and then restart this install.",! S XPDQUIT=2
"RTN","IBDY303E",15,0)
 Q
"RTN","IBDY303E",16,0)
 ;
"RTN","IBDY303E",17,0)
NOPTCH(PATCH,CNT) ; Writes patch not installed messsage
"RTN","IBDY303E",18,0)
 ;PATCH = patch number not found
"RTN","IBDY303E",19,0)
 ;CNT = # of patches missing ... passed by reference ... running count
"RTN","IBDY303E",20,0)
 W !!,*7,"PATCH #: IBD*3.0*",PATCH," does not appear to be installed on your system and is",!,"  required before this patch can be installed."
"RTN","IBDY303E",21,0)
 S CNT=$G(CNT)+1
"RTN","IBDY303E",22,0)
 Q
"RTN","IBDY303E",23,0)
 ;
"VER")
8.0^21.0
"^DD",359.1,359.1,0)
FIELD^^10.04^15
"^DD",359.1,359.1,0,"DDA")
N
"^DD",359.1,359.1,0,"DT")
2950928
"^DD",359.1,359.1,0,"IX","B",359.1,.01)

"^DD",359.1,359.1,0,"NM","AICS DATA ELEMENTS")

"^DD",359.1,359.1,0,"PT",357.14,.17)

"^DD",359.1,359.1,0,"PT",357.6,13)

"^DD",359.1,359.1,0,"PT",357.6,16.2)

"^DD",359.1,359.1,0,"PT",357.6,16.6)

"^DD",359.1,359.1,0,"PT",357.613,.01)

"^DD",359.1,359.1,0,"PT",357.952,.17)

"^DD",359.1,359.1,0,"PT",358.94,.1)

"^DD",359.1,359.1,0,"PT",359.94,.1)

"^DD",359.1,359.1,0,"VRPK")
AUTOMATED INFO COLLECTION SYS
"^DD",359.1,359.1,.01,0)
DATA TYPE^RF^^0;1^K:$L(X)>30!($L(X)<3)!'(X'?1P.E) X
"^DD",359.1,359.1,.01,1,0)
^.1
"^DD",359.1,359.1,.01,1,1,0)
359.1^B
"^DD",359.1,359.1,.01,1,1,1)
S ^IBE(359.1,"B",$E(X,1,30),DA)=""
"^DD",359.1,359.1,.01,1,1,2)
K ^IBE(359.1,"B",$E(X,1,30),DA)
"^DD",359.1,359.1,.01,3)
Answer must be 3-30 characters in length.
"^DD",359.1,359.1,.01,21,0)
^^8^8^2951003^
"^DD",359.1,359.1,.01,21,1,0)
A type of data that is recognized as such within the framework of scanning
"^DD",359.1,359.1,.01,21,2,0)
DHCP forms and which requires its own description for
"^DD",359.1,359.1,.01,21,3,0)
scanning/recognition.
"^DD",359.1,359.1,.01,21,4,0)
 
"^DD",359.1,359.1,.01,21,5,0)
Enter a type of data that can appear on a scannable encounter form.  The
"^DD",359.1,359.1,.01,21,6,0)
data should require a unique description for each commercial scanning
"^DD",359.1,359.1,.01,21,7,0)
application in use.  For example, check out date/time or CPT procedure
"^DD",359.1,359.1,.01,21,8,0)
require a definition for scanning.
"^DD",359.1,359.1,.01,"DT")
2950928
"^DD",359.1,359.1,.02,0)
MAXIMUM LENGTH FOR INPUT^RNJ2,0^^0;2^K:+X'=X!(X>99)!(X<1)!(X?.E1"."1N.N) X
"^DD",359.1,359.1,.02,3)
What is the maximum number of characters that can be input for this data?
"^DD",359.1,359.1,.02,21,0)
^^1^1^2950808^
"^DD",359.1,359.1,.02,21,1,0)
The maximum number of characters that can be input for this data type.
"^DD",359.1,359.1,.02,"DT")
2950504
"^DD",359.1,359.1,.05,0)
PRINT FORMAT^F^^0;5^K:$L(X)>64!($L(X)<1) X
"^DD",359.1,359.1,.05,3)
Use an underscore,'_',to indicate positions that the user should fill in. Use other characters to pre-fill that position.
"^DD",359.1,359.1,.05,21,0)
^^4^4^2951003^^^^
"^DD",359.1,359.1,.05,21,1,0)
Used to print the field. Fields for certain types of data, such
"^DD",359.1,359.1,.05,21,2,0)
as telephone numbers and Social Security numbers usually require certain
"^DD",359.1,359.1,.05,21,3,0)
formats, such as *********** for an SSN. The PRINT FORMAT allows the
"^DD",359.1,359.1,.05,21,4,0)
required format to be specified.
"^DD",359.1,359.1,.05,"DT")
2950811
"^DD",359.1,359.1,.06,0)
SPACE ALLOCATION^RNJ2,0^^0;6^K:+X'=X!(X>99)!(X<1)!(X?.E1"."1N.N) X
"^DD",359.1,359.1,.06,3)
What is the maximum number of characters in this field?
"^DD",359.1,359.1,.06,21,0)
^^2^2^2950808^^
"^DD",359.1,359.1,.06,21,1,0)
This is used to determine how much space on the form to allocate for the 
"^DD",359.1,359.1,.06,21,2,0)
hand print.
"^DD",359.1,359.1,.06,"DT")
2950504
"^DD",359.1,359.1,.07,0)
REQUIRED CONFIDENCE^NJ2,0^^0;7^K:+X'=X!(X>11)!(X<0)!(X?.E1"."1N.N) X
"^DD",359.1,359.1,.07,3)
Enter a number between 0 and 11. 0 means that the data will not require validation, 11 means the field must always be validated.
"^DD",359.1,359.1,.07,21,0)
^^2^2^2950808^
"^DD",359.1,359.1,.07,21,1,0)
This is the confidence level (as defined by Paper Keyboard) that should be
"^DD",359.1,359.1,.07,21,2,0)
applied to this data type.
"^DD",359.1,359.1,.07,"DT")
2950601
"^DD",359.1,359.1,.1,0)
RECOMMENDED LABEL^F^^0;10^K:$L(X)>30!($L(X)<1) X
"^DD",359.1,359.1,.1,3)
Answer must be 1-30 characters in length.
"^DD",359.1,359.1,.1,21,0)
^^1^1^2950817^^^
"^DD",359.1,359.1,.1,21,1,0)
Will be used as a default label.
"^DD",359.1,359.1,.1,"DT")
2950817
"^DD",359.1,359.1,.11,0)
LABEL FOR UNIT OF MEASUREMENT^F^^0;11^K:$L(X)>20!($L(X)<1) X
"^DD",359.1,359.1,.11,3)
Answer must be 1-20 characters in length.
"^DD",359.1,359.1,.11,21,0)
^^1^1^2950815^^^
"^DD",359.1,359.1,.11,21,1,0)
The unit of measurement as defined by the PCE Generic Device Interface.
"^DD",359.1,359.1,.11,"DT")
2950815
"^DD",359.1,359.1,.12,0)
PCE DIM VITALS TYPE^F^^0;12^K:$L(X)>10!($L(X)<1) X
"^DD",359.1,359.1,.12,3)
Answer must be 1-10 characters in length.
"^DD",359.1,359.1,.12,21,0)
^^1^1^2960401^^^
"^DD",359.1,359.1,.12,21,1,0)
The type of vitals measurement - used only for the PCE DIM VITALS node.
"^DD",359.1,359.1,.12,"DT")
2960401
"^DD",359.1,359.1,.13,0)
PCE DIM VITALS UNITS^F^^0;13^K:$L(X)>10!($L(X)<1) X
"^DD",359.1,359.1,.13,3)
Answer must be 1-10 characters in length.
"^DD",359.1,359.1,.13,21,0)
^^2^2^2960401^^
"^DD",359.1,359.1,.13,21,1,0)
The unit of measurement - used only for the PCE Device Interface Mondule
"^DD",359.1,359.1,.13,21,2,0)
(DIM) VITALS node.
"^DD",359.1,359.1,.13,"DT")
2960401
"^DD",359.1,359.1,1,0)
PCE DIM INPUT TRANSFORM^K^^1;E1,245^K:$L(X)>245 X D:$D(X) ^DIM
"^DD",359.1,359.1,1,3)
The M code should set X to the value to be passed, else kill X if it is not valid.
"^DD",359.1,359.1,1,9)
@
"^DD",359.1,359.1,1,21,0)
^^4^4^2960401^^
"^DD",359.1,359.1,1,21,1,0)
The input transform should change X into a value that can be passed to the
"^DD",359.1,359.1,1,21,2,0)
PCE Device Interface Module. X should be killed if it not be transformed.
"^DD",359.1,359.1,1,21,3,0)
Note that the return value of X need not meet all of PCE's validation
"^DD",359.1,359.1,1,21,4,0)
requirments - for example, X may be an inactive code.
"^DD",359.1,359.1,1,"DT")
2960401
"^DD",359.1,359.1,2,0)
HELP FOR INPUT TRANSFORM^F^^2;1^K:$L(X)>245!($L(X)<1) X
"^DD",359.1,359.1,2,3)
Enter a line of help that will assist the user in entering valid data.
"^DD",359.1,359.1,2,21,0)
^^1^1^2950808^
"^DD",359.1,359.1,2,21,1,0)
Help for the user.
"^DD",359.1,359.1,2,"DT")
2950426
"^DD",359.1,359.1,10.01,0)
PAPER KEYBOARD DATA TYPE^S^a:ALPHA (any ASCII);d:DATE (MM/DD/YY);f:FLOATING POINT NUMBER;i:INTEGER;t:TIME (HHMM, VA FileMan format);^10;1^Q
"^DD",359.1,359.1,10.01,3)
Choose the most appropriate data type from the list.
"^DD",359.1,359.1,10.01,21,0)
^^4^4^2950928^^
"^DD",359.1,359.1,10.01,21,1,0)
These are the data types provided for by Paper Keyboard.  The ALPHA data
"^DD",359.1,359.1,10.01,21,2,0)
type can be further described by a Paper Keyboard picture clause.  The 
"^DD",359.1,359.1,10.01,21,3,0)
Integer data type does not apply if the field can contain spaces or
"^DD",359.1,359.1,10.01,21,4,0)
puntuation other than a '+'.
"^DD",359.1,359.1,10.01,"DT")
2950928
"^DD",359.1,359.1,10.02,0)
PAPER KEYBOARD PICTURE^F^^10;2^K:$L(X)>60!($L(X)<1) X
"^DD",359.1,359.1,10.02,3)
Answer must be 1-60 characters in length.
"^DD",359.1,359.1,10.02,21,0)
^^6^6^2950928^^
"^DD",359.1,359.1,10.02,21,1,0)
Enter a picture clause specific to Paper Keyboard.  A picture clause
"^DD",359.1,359.1,10.02,21,2,0)
describes the intended format for the data type.  This is similar
"^DD",359.1,359.1,10.02,21,3,0)
to an M pattern match.  For example, a CPT code is 5 characters, the
"^DD",359.1,359.1,10.02,21,4,0)
first character may be an alpha or numeric followed by 4 numeric 
"^DD",359.1,359.1,10.02,21,5,0)
characters.  To represent this picture in Paper Keyboard, one would
"^DD",359.1,359.1,10.02,21,6,0)
enter the picture X####.
"^DD",359.1,359.1,10.02,"DT")
2950928
"^DD",359.1,359.1,10.03,0)
DICTIONARY^F^^10;3^K:$L(X)>12!($L(X)<1)!'(X?1.8A.1".".3A) X
"^DD",359.1,359.1,10.03,3)
You may optionally enter the name of a dictionary to assist in the recognition of ICR fields.  Answer must be 1-12 characters in length.
"^DD",359.1,359.1,10.03,21,0)
^^3^3^2951017^
"^DD",359.1,359.1,10.03,21,1,0)
Enter the name of a dictionary.  A dictionary can be applied to ICR data
"^DD",359.1,359.1,10.03,21,2,0)
types to improve the recognition of ICR fields. This is the name of the
"^DD",359.1,359.1,10.03,21,3,0)
file that the scanning software uses.
"^DD",359.1,359.1,10.03,"DT")
2950928
"^DD",359.1,359.1,10.04,0)
PK PICTURES FOR SUBFIELDS^F^^10;4^K:$L(X)>120!($L(X)<1) X
"^DD",359.1,359.1,10.04,3)
Answer must be 1-120 characters in length.
"^DD",359.1,359.1,10.04,21,0)
^^7^7^2950928^^^
"^DD",359.1,359.1,10.04,21,1,0)
When using print formats for paper keyboard you should enter the
"^DD",359.1,359.1,10.04,21,2,0)
picture clause in this field.  For example the print format
"^DD",359.1,359.1,10.04,21,3,0)
for a SSN might look like ___-__-____ .  This would cause the
"^DD",359.1,359.1,10.04,21,4,0)
dashes to be printed and user input to be accepted in three
"^DD",359.1,359.1,10.04,21,5,0)
subfields with lengths of 3, 2, and 4 numerics.  You would then
"^DD",359.1,359.1,10.04,21,6,0)
enter the picture in this field as ###-##-####.  (note the # sign
"^DD",359.1,359.1,10.04,21,7,0)
is used as the picture for numerics)
"^DD",359.1,359.1,10.04,"DT")
2950928
"^DIC",359.1,359.1,0)
AICS DATA ELEMENTS
"^DIC",359.1,359.1,0,"GL")
^IBE(359.1,
"^DIC",359.1,359.1,"%D",0)
^^3^3^2950927^^
"^DIC",359.1,359.1,"%D",1,0)
Used to describe a simple data element, one that would appear as a single
"^DIC",359.1,359.1,"%D",2,0)
field on a form. The description includes instructions on how to print
"^DIC",359.1,359.1,"%D",3,0)
the field and how the scanning software should recognize it.
"^DIC",359.1,"B","AICS DATA ELEMENTS",359.1)

**END**
**END**
