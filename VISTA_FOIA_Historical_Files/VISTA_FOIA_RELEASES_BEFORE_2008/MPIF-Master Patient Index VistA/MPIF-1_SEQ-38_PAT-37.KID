Released MPIF*1*37 SEQ #38
Extracted from mail message
**KIDS**:MPIF*1.0*37^

**INSTALL NAME**
MPIF*1.0*37
"BLD",2203,0)
MPIF*1.0*37^MASTER PATIENT INDEX VISTA^0^3050422^y
"BLD",2203,1,0)
^^3^3^3050422^
"BLD",2203,1,1,0)
CHANGE TO IDENTITY MANAGEMENT FIELDS
"BLD",2203,1,2,0)
Refer to patch MPIF*1*37 in the FORUM Patch Module for a complete
"BLD",2203,1,3,0)
description.
"BLD",2203,4,0)
^9.64PA^^
"BLD",2203,"ABNS",0)
^9.66A^^
"BLD",2203,"ABPKG")
^^
"BLD",2203,"KRN",0)
^9.67PA^8989.52^19
"BLD",2203,"KRN",.4,0)
.4
"BLD",2203,"KRN",.401,0)
.401
"BLD",2203,"KRN",.402,0)
.402
"BLD",2203,"KRN",.403,0)
.403
"BLD",2203,"KRN",.5,0)
.5
"BLD",2203,"KRN",.84,0)
.84
"BLD",2203,"KRN",3.6,0)
3.6
"BLD",2203,"KRN",3.8,0)
3.8
"BLD",2203,"KRN",9.2,0)
9.2
"BLD",2203,"KRN",9.8,0)
9.8
"BLD",2203,"KRN",9.8,"NM",0)
^9.68A^4^2
"BLD",2203,"KRN",9.8,"NM",1,0)
MPIFAPI^^0^B31852226
"BLD",2203,"KRN",9.8,"NM",4,0)
MPIFAPI1^^0^B25470799
"BLD",2203,"KRN",9.8,"NM","B","MPIFAPI",1)

"BLD",2203,"KRN",9.8,"NM","B","MPIFAPI1",4)

"BLD",2203,"KRN",19,0)
19
"BLD",2203,"KRN",19.1,0)
19.1
"BLD",2203,"KRN",101,0)
101
"BLD",2203,"KRN",409.61,0)
409.61
"BLD",2203,"KRN",771,0)
771
"BLD",2203,"KRN",870,0)
870
"BLD",2203,"KRN",8989.51,0)
8989.51
"BLD",2203,"KRN",8989.52,0)
8989.52
"BLD",2203,"KRN",8994,0)
8994
"BLD",2203,"KRN","B",.4,.4)

"BLD",2203,"KRN","B",.401,.401)

"BLD",2203,"KRN","B",.402,.402)

"BLD",2203,"KRN","B",.403,.403)

"BLD",2203,"KRN","B",.5,.5)

"BLD",2203,"KRN","B",.84,.84)

"BLD",2203,"KRN","B",3.6,3.6)

"BLD",2203,"KRN","B",3.8,3.8)

"BLD",2203,"KRN","B",9.2,9.2)

"BLD",2203,"KRN","B",9.8,9.8)

"BLD",2203,"KRN","B",19,19)

"BLD",2203,"KRN","B",19.1,19.1)

"BLD",2203,"KRN","B",101,101)

"BLD",2203,"KRN","B",409.61,409.61)

"BLD",2203,"KRN","B",771,771)

"BLD",2203,"KRN","B",870,870)

"BLD",2203,"KRN","B",8989.51,8989.51)

"BLD",2203,"KRN","B",8989.52,8989.52)

"BLD",2203,"KRN","B",8994,8994)

"BLD",2203,"QUES",0)
^9.62^^
"BLD",2203,"REQB",0)
^9.611^4^1
"BLD",2203,"REQB",4,0)
MPIF*1.0*35^2
"BLD",2203,"REQB","B","MPIF*1.0*35",4)

"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
37^3050422
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3050422
"PKG",282,22,1,"PAH",1,1,1,0)
CHANGE TO IDENTITY MANAGEMENT FIELDS
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1*37 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","MPIFAPI")
0^1^B31852226
"RTN","MPIFAPI",1,0)
MPIFAPI ;CMC/BP-APIS FOR MPI ;DEC 21, 1998
"RTN","MPIFAPI",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,14,16,17,21,27,28,33,35,37**;30 Apr 99
"RTN","MPIFAPI",3,0)
 ; Integration Agreements Utilized:
"RTN","MPIFAPI",4,0)
 ;   ^DPT( - #2070 and #4079
"RTN","MPIFAPI",5,0)
 ;   ^DPT("AICN", ^DPT("AMPIMIS", ^DPT("ASCN2" - #2070
"RTN","MPIFAPI",6,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFAPI",7,0)
 ;
"RTN","MPIFAPI",8,0)
EN2() ;NEW ENTRY POINT FOR LOCALS
"RTN","MPIFAPI",9,0)
 N MPIOUT,DIC,MPICHK,MPINCK,MPINNM,MPINUM1,DA,MPINUM
"RTN","MPIFAPI",10,0)
 I $O(^MPIF(984.1,0))="" G SETUP
"RTN","MPIFAPI",11,0)
AGN2 L +^MPIF(984.1):1 E  H 3 G AGN2
"RTN","MPIFAPI",12,0)
 S MPINUM=0,X=$$SITE^VASITE,X=$P(X,"^",3),X=X\1
"RTN","MPIFAPI",13,0)
 S DIC="^MPIF(984.1,",DIC(0)="XZ" D ^DIC
"RTN","MPIFAPI",14,0)
 S MPINUM1=$P(Y(0),"^",4),MPICHK=$P(Y(0),"^",5),MPINNM=MPINUM1+1
"RTN","MPIFAPI",15,0)
 S MPINUM=MPINUM1_"V"_MPICHK,MPINCK=$$CHECKDG^MPIFSPC(MPINNM)
"RTN","MPIFAPI",16,0)
 S DA=1,DIE="^MPIF(984.1,",DR="1////^S X=MPINUM1;2////^S X=MPICHK;3////^S X=MPINNM;5////"_MPINCK
"RTN","MPIFAPI",17,0)
 D ^DIE
"RTN","MPIFAPI",18,0)
 K DIE,DR,X,Y
"RTN","MPIFAPI",19,0)
 L -^MPIF(984.1)
"RTN","MPIFAPI",20,0)
 Q MPINUM
"RTN","MPIFAPI",21,0)
SETUP ;
"RTN","MPIFAPI",22,0)
 N CHK,NUM,NXTCHK,NXTNUM,SITE,DA
"RTN","MPIFAPI",23,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFAPI",24,0)
 S DIC="^MPIF(984.1,",DA=1,DIC(0)="",X=SITE
"RTN","MPIFAPI",25,0)
 S NUM=SITE_"0000000",CHK=$$CHECKDG^MPIFSPC(NUM),MPINUM=NUM_"V"_CHK
"RTN","MPIFAPI",26,0)
 S NXTNUM=NUM+1,NXTCHK=$$CHECKDG^MPIFSPC(NXTNUM)
"RTN","MPIFAPI",27,0)
 S DIC("DR")="1////^S X=NUM;2////^S X=CHK;3////^S X=NXTNUM;5////"_NXTCHK
"RTN","MPIFAPI",28,0)
 K DD,D0
"RTN","MPIFAPI",29,0)
 D FILE^DICN
"RTN","MPIFAPI",30,0)
 K DIC,X,Y
"RTN","MPIFAPI",31,0)
 Q MPINUM
"RTN","MPIFAPI",32,0)
 ;
"RTN","MPIFAPI",33,0)
MPILINK() ;returns MPI logical Link
"RTN","MPIFAPI",34,0)
 N MPIL,MPILINK
"RTN","MPIFAPI",35,0)
 D LINK^HLUTIL3("MPI",.MPIL)
"RTN","MPIFAPI",36,0)
 I '$D(MPIL) Q "-1^NOT DEFINED"
"RTN","MPIFAPI",37,0)
 S MPILINK=$O(MPIL(0))
"RTN","MPIFAPI",38,0)
 I MPILINK="" Q "-1^NOT DEFINED"
"RTN","MPIFAPI",39,0)
 S MPILINK=$G(MPIL(MPILINK))
"RTN","MPIFAPI",40,0)
 Q MPILINK
"RTN","MPIFAPI",41,0)
 ;
"RTN","MPIFAPI",42,0)
SUBNUM(DFN) ; returns SCN from MPI node for given DFN
"RTN","MPIFAPI",43,0)
 ; DFN - ien of patient file
"RTN","MPIFAPI",44,0)
 ; returns:  -1^error message << always returns.
"RTN","MPIFAPI",45,0)
 ;*** Subscription control numbers no longer exist
"RTN","MPIFAPI",46,0)
 Q "-1^No Subscription Control Number for DFN "_DFN
"RTN","MPIFAPI",47,0)
 ;
"RTN","MPIFAPI",48,0)
MPINODE(DFN) ; returns MPI node for given DFN
"RTN","MPIFAPI",49,0)
 ; DFN - patient file ien
"RTN","MPIFAPI",50,0)
 ; returns:  -1^error message or MPI node from patient file
"RTN","MPIFAPI",51,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",52,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",53,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",54,0)
 N NODE S NODE=$G(^DPT(DFN,"MPI"))
"RTN","MPIFAPI",55,0)
 I NODE=""!(NODE?."^") S NODE="-1^No MPI data for DFN "_DFN
"RTN","MPIFAPI",56,0)
 Q NODE
"RTN","MPIFAPI",57,0)
 ;
"RTN","MPIFAPI",58,0)
GETADFN(ICN) ; return DFN ONLY if ICN is the active ICN
"RTN","MPIFAPI",59,0)
 ; ICN - Integration Control Number for patient to be returned
"RTN","MPIFAPI",60,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",61,0)
 ;           DFN - IEN for the patient entry in the Patient file (#2)
"RTN","MPIFAPI",62,0)
 N RETURN,DFN
"RTN","MPIFAPI",63,0)
 I $G(ICN)'>0 Q "-1^NO ICN"
"RTN","MPIFAPI",64,0)
 I '$D(^DPT("AICN",ICN)) Q "-1^ICN NOT IN DATABASE"
"RTN","MPIFAPI",65,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIFAPI",66,0)
 I $G(DFN)'>0 Q "-1^BAD AICN CROSS-REFERENCE"
"RTN","MPIFAPI",67,0)
 I $P($G(^DPT(DFN,"MPI")),"^")'=ICN Q "-1^ICN is not Active one"
"RTN","MPIFAPI",68,0)
 Q DFN
"RTN","MPIFAPI",69,0)
 ;
"RTN","MPIFAPI",70,0)
UPDATE(DFN,ARR,MPISILNT,REMOVE) ;api to edit 'mpi','mpifhis' and 'mpicmor' nodes
"RTN","MPIFAPI",71,0)
 ;**37 UPDATE module moved 3/30/05 from MPIFAPI into MPIFAPI1.
"RTN","MPIFAPI",72,0)
 ;Linetag must remain due to DBIA #2706.
"RTN","MPIFAPI",73,0)
 Q $$UPDATE^MPIFAPI1(DFN,ARR,.MPISILNT,.REMOVE)
"RTN","MPIFAPI",74,0)
 ;
"RTN","MPIFAPI",75,0)
MPIQ(DFN) ;MPI QUERY
"RTN","MPIFAPI",76,0)
 L +^DPT(DFN):2 I '$T,'$D(MPIFS) W $C(7),!!,"Patient is being edited. No attempt will be made to connect to the MPI." H 2 Q
"RTN","MPIFAPI",77,0)
 I '$D(MPIFS) D  ;Not from SmartCard background job
"RTN","MPIFAPI",78,0)
 .;**37 mods to L -^DPT
"RTN","MPIFAPI",79,0)
 .I $G(DGNEW)=1 D  ;New patient, fields always blank, ask
"RTN","MPIFAPI",80,0)
 ..D WRTLN
"RTN","MPIFAPI",81,0)
 ..S DIE="^DPT(",DA=DFN,DIE("NO^")="BACK"
"RTN","MPIFAPI",82,0)
 ..S DR=".2403;.092;.093;1",DR(2,2.01)=".01" D ^DIE K DA,DIE,DR Q
"RTN","MPIFAPI",83,0)
 .I $G(DGNEW)="" D  ;Existing patient, get current values
"RTN","MPIFAPI",84,0)
 ..K MPIFARR N MPIDOB,IMPRS,MPIMMN,MPICTY,MPIST
"RTN","MPIFAPI",85,0)
 ..S DIC=2,DR=".02;.03;.09;.092;.093;.2403;994;1",DR(2.01)=".01"
"RTN","MPIFAPI",86,0)
 ..S DA=DFN,DA(2.01)=1,DIQ(0)="EI",DIQ="MPIFARR"
"RTN","MPIFAPI",87,0)
 ..D EN^DIQ1 K DA,DIC,DIQ,DR
"RTN","MPIFAPI",88,0)
 ..;build DR from blank fields / imprecise DOB / pseudo SSN
"RTN","MPIFAPI",89,0)
 ..S DR=""
"RTN","MPIFAPI",90,0)
 ..S MPIDOB=$G(MPIFARR(2,DFN,.03,"I")) ;DATE OF BIRTH
"RTN","MPIFAPI",91,0)
 ..I MPIDOB="" S DR=DR_".03;" ;DOB null
"RTN","MPIFAPI",92,0)
 ..;Is DOB imprecise?
"RTN","MPIFAPI",93,0)
 ..I MPIDOB'="" S IMPRS=0 D
"RTN","MPIFAPI",94,0)
 ...I $E(MPIDOB,4,7)="0000" S IMPRS=1 ;Year only; no month/day
"RTN","MPIFAPI",95,0)
 ...I ($E(MPIDOB,6,7)="00")&($E(MPIDOB,4,5)'="00") S IMPRS=1 ;Year/month only; no day
"RTN","MPIFAPI",96,0)
 ...I IMPRS=1 S DR=DR_".03;" ;DOB imprecise
"RTN","MPIFAPI",97,0)
 ..I $G(MPIFARR(2,DFN,.02,"I"))="" S DR=DR_".02;" ;SEX
"RTN","MPIFAPI",98,0)
 ..I ($G(MPIFARR(2,DFN,.09,"E"))="")!($G(MPIFARR(2,DFN,.09,"E"))["P") S DR=DR_".09;" ;SOCIAL SECURITY NUMBER
"RTN","MPIFAPI",99,0)
 ..I $G(MPIFARR(2,DFN,994,"I"))="" S DR=DR_"994;" ;MULTIPLE BIRTH INDICATOR
"RTN","MPIFAPI",100,0)
 ..S MPIMMN=$G(MPIFARR(2,DFN,.2403,"E")) ;MOTHER'S MAIDEN NAME
"RTN","MPIFAPI",101,0)
 ..I $$VALDT(MPIMMN) S DR=DR_".2403;" ;Validate MMN value
"RTN","MPIFAPI",102,0)
 ..S MPICTY=$G(MPIFARR(2,DFN,.092,"E")) ;PLACE OF BIRTH [CITY]
"RTN","MPIFAPI",103,0)
 ..S MPIST=$G(MPIFARR(2,DFN,.093,"E")) ;PLACE OF BIRTH [STATE]
"RTN","MPIFAPI",104,0)
 ..I $S($$VALDT(MPICTY):1,$$VALDT(MPIST):1,1:0) S DR=DR_".092;.093;" ;Validate POB [CITY] & [STATE] value
"RTN","MPIFAPI",105,0)
 ..I $G(MPIFARR(2.01,1,.01,"E"))="" S DR=DR_"1",DR(2,2.01)=".01" ;ALIAS
"RTN","MPIFAPI",106,0)
 ..K MPIFARR
"RTN","MPIFAPI",107,0)
 ..I DR'="" D
"RTN","MPIFAPI",108,0)
 ...D WRTLN
"RTN","MPIFAPI",109,0)
 ...S DIE="^DPT(",DA=DFN,DIE("NO^")="BACK"
"RTN","MPIFAPI",110,0)
 ...D ^DIE K DA,DIE,DR
"RTN","MPIFAPI",111,0)
 L -^DPT(DFN)
"RTN","MPIFAPI",112,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFAPI",113,0)
 K MPIFRTN D VTQ^MPIFQ0
"RTN","MPIFAPI",114,0)
 I $G(MPIFRTN)="" D
"RTN","MPIFAPI",115,0)
 .; ^ Quit at LM screen when presented with a list of possible matches
"RTN","MPIFAPI",116,0)
 .; \/ setup Local ICN and proceed
"RTN","MPIFAPI",117,0)
 .N ICN,ERR
"RTN","MPIFAPI",118,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIFAPI",119,0)
 .Q:ICN=""!(+ICN=-1)
"RTN","MPIFAPI",120,0)
 .S ERR=$$SETICN^MPIF001(DFN,+ICN,$P(ICN,"V",2))
"RTN","MPIFAPI",121,0)
 .Q:+ERR=-1
"RTN","MPIFAPI",122,0)
 .; ^ couldn't set ICN don't set other fields
"RTN","MPIFAPI",123,0)
 .S ERR=$$SETLOC^MPIF001(DFN,1),ERR=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFAPI",124,0)
 K MPIFRTN,ZTREQ
"RTN","MPIFAPI",125,0)
 Q
"RTN","MPIFAPI",126,0)
 ;
"RTN","MPIFAPI",127,0)
MPIQQ(PDFN) ; Entry point for queuing d/c
"RTN","MPIFAPI",128,0)
 ; Returned is -1^error message OR Task #
"RTN","MPIFAPI",129,0)
 Q:'$D(PDFN) "-1^No DFN passed"
"RTN","MPIFAPI",130,0)
 S ZTRTN="MPIQ^MPIFAPI(PDFN)"
"RTN","MPIFAPI",131,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFAPI",132,0)
 S ZTSAVE("PDFN")=PDFN,ZTSAVE("MPIFS")=1
"RTN","MPIFAPI",133,0)
 ; ^ silent flag
"RTN","MPIFAPI",134,0)
 S ZTIO="",ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFAPI",135,0)
 D ^%ZTLOAD
"RTN","MPIFAPI",136,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFAPI",137,0)
 N TSK S TSK=ZTSK
"RTN","MPIFAPI",138,0)
 K ZTSAVE,ZTRTN,ZTIO,ZTDTH,ZTSK
"RTN","MPIFAPI",139,0)
 Q TSK
"RTN","MPIFAPI",140,0)
 ;
"RTN","MPIFAPI",141,0)
WRTLN ;**37 Write intro text ONLY if there are fields to ask
"RTN","MPIFAPI",142,0)
 W !!,"Please verify or update the following information:",!
"RTN","MPIFAPI",143,0)
 Q
"RTN","MPIFAPI",144,0)
 ;
"RTN","MPIFAPI",145,0)
VALDT(VAL) ;**37 Validate value passed in.
"RTN","MPIFAPI",146,0)
 ;Prompt if field contains invalid data (e.g., UNKNOWN, NOT KNOWN, etc.)
"RTN","MPIFAPI",147,0)
 ;Returns 0 if not found
"RTN","MPIFAPI",148,0)
 ;Returns 1 if found
"RTN","MPIFAPI",149,0)
 I VAL="" Q 1
"RTN","MPIFAPI",150,0)
 I $E($$UP^XLFSTR(VAL),1,3)="UNK" Q 1
"RTN","MPIFAPI",151,0)
 I $E($$UP^XLFSTR(VAL),1,4)="NONE" Q 1
"RTN","MPIFAPI",152,0)
 I $E($$UP^XLFSTR(VAL),1,4)="NOT " Q 1
"RTN","MPIFAPI",153,0)
 I $$UP^XLFSTR(VAL)["UNAVAILABLE" Q 1
"RTN","MPIFAPI",154,0)
 I $$UP^XLFSTR(VAL)["DECEASED" Q 1
"RTN","MPIFAPI",155,0)
 I $E($$UP^XLFSTR(VAL),1,2)="DC" Q 1
"RTN","MPIFAPI",156,0)
 Q 0
"RTN","MPIFAPI",157,0)
 ;
"RTN","MPIFAPI1")
0^4^B25470799
"RTN","MPIFAPI1",1,0)
MPIFAPI1 ;CMC/BP-APIS FOR MPI - CONTINUED ;DEC 21, 1998
"RTN","MPIFAPI1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**37**;30 Apr 99
"RTN","MPIFAPI1",3,0)
 ;
"RTN","MPIFAPI1",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFAPI1",5,0)
 ;   ^DPT( - #2070 and #4079
"RTN","MPIFAPI1",6,0)
 ;   ^DPT("AICN", ^DPT("AMPIMIS", ^DPT("ASCN2" - #2070
"RTN","MPIFAPI1",7,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFAPI1",8,0)
 ;
"RTN","MPIFAPI1",9,0)
UPDATE(DFN,ARR,MPISILNT,REMOVE) ;api to edit 'mpi','mpifhis' and 'mpicmor' nodes
"RTN","MPIFAPI1",10,0)
 ;**37 UPDATE module moved 3/30/05 from MPIFAPI into MPIFAPI1.
"RTN","MPIFAPI1",11,0)
 ;
"RTN","MPIFAPI1",12,0)
 ;DFN - patient IEN
"RTN","MPIFAPI1",13,0)
 ;ARR - array in the format listed below
"RTN","MPIFAPI1",14,0)
 ; MPI node by passing in ARR(field#)=value
"RTN","MPIFAPI1",15,0)
 ;  **NOTE:  991.04 is only edited based on the edit of 991.01
"RTN","MPIFAPI1",16,0)
 ;           991.03 should be passed with either "@" or IEN in File 4
"RTN","MPIFAPI1",17,0)
 ; MPIFHIS node by passing ARR(992)=old ICN to remove from multiple
"RTN","MPIFAPI1",18,0)
 ; MPICMOR node by passing ARR(993)=old CMOR to remove from multiple
"RTN","MPIFAPI1",19,0)
 ;MPISILNT(optional) - 0 to not suppress exceptions (default)
"RTN","MPIFAPI1",20,0)
 ;                     1 to suppress exceptions
"RTN","MPIFAPI1",21,0)
 ;REMOVE (optional) - 0 default - use FM to delete MPI values
"RTN","MPIFAPI1",22,0)
 ;    1 to delete outside FM the MPI fields -- should only be used to clean up the stub record's mpi data, including history for icn and cmor
"RTN","MPIFAPI1",23,0)
 ;Returns : -1^error message if unable to update fields
"RTN","MPIFAPI1",24,0)
 ;          0 if successfully updated fields
"RTN","MPIFAPI1",25,0)
 ;
"RTN","MPIFAPI1",26,0)
 N MPIRETN,MPIX,VALUE,ICN,SCN,ICN2
"RTN","MPIFAPI1",27,0)
 I DFN'>0 Q "-1^DFN passed into UPDATE^MPIFAPI not greater than 0"
"RTN","MPIFAPI1",28,0)
 Q:'$D(^DPT(DFN,0)) "-1^DFN "_DFN_" does not exist"
"RTN","MPIFAPI1",29,0)
 S MPIRETN=0,RGRSICN=""
"RTN","MPIFAPI1",30,0)
 F  L +^DPT("MPI",DFN):10 Q:$T
"RTN","MPIFAPI1",31,0)
 I $D(REMOVE) D CLEAN^MPIF002(DFN,.ARR,.MPIRETN) L -^DPT("MPI",DFN) Q MPIRETN
"RTN","MPIFAPI1",32,0)
 I $D(@ARR@(991.01)) D
"RTN","MPIFAPI1",33,0)
 .I '$D(@ARR@(991.02)) S MPIRETN="-1^ICN "_ICN_", passed without checksum" Q
"RTN","MPIFAPI1",34,0)
 .;quit if local is going to overwrite national
"RTN","MPIFAPI1",35,0)
 .S ICN=+$$GETICN^MPIF001(DFN) I ICN>0 I $E(@ARR@(991.01),1,3)=$P($$SITE^VASITE(),"^",3),$E(ICN,1,3)'=$E(@ARR@(991.01),1,3) S MPIRETN="-1^Overwriting the National ICN, "_ICN_", with a local, "_@ARR@(991.01)_", isn't allowed" Q
"RTN","MPIFAPI1",36,0)
 .; quit if ICN has already been assigned to another patient in your data base
"RTN","MPIFAPI1",37,0)
 .S ICN2=@ARR@(991.01)
"RTN","MPIFAPI1",38,0)
 .I $D(^DPT("AICN",ICN2)),DFN'=$O(^DPT("AICN",ICN2,"")) D
"RTN","MPIFAPI1",39,0)
 ..I DFN'=($O(^DPT("AICN",ICN2,""))) D 
"RTN","MPIFAPI1",40,0)
 ...N DFN2 S DFN2=$O(^DPT("AICN",ICN2,""))
"RTN","MPIFAPI1",41,0)
 ...D TWODFNS^MPIF002(DFN2,DFN,ICN2)
"RTN","MPIFAPI1",42,0)
 ..I $P($$SITE^VASITE(),"^",3)'=200 S MPIRETN="-1^ICN "_ICN2_" is already in use for pt DFN "_DFN ;;**37
"RTN","MPIFAPI1",43,0)
 .Q:+MPIRETN=-1
"RTN","MPIFAPI1",44,0)
 .K FDA S FDA(1,2,DFN_",",991.01)=@ARR@(991.01)
"RTN","MPIFAPI1",45,0)
 .K MPIERR D FILE^DIE("E","FDA(1)","MPIERR") K FDA(1) I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to update pt's ICN (DFN="_DFN_") ICN to "_@ARR@(991.01)_" because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI1",46,0)
 .I +MPIRETN'=0 Q
"RTN","MPIFAPI1",47,0)
 .K FDA S FDA(1,2,DFN_",",991.02)=@ARR@(991.02)
"RTN","MPIFAPI1",48,0)
 .K MPIERR D FILE^DIE("E","FDA(1)","MPIERR") K FDA(1) I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to update pt's ("_DFN_") ICN Checksum to "_@ARR@(991.02)_" because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI1",49,0)
 .I +MPIRETN'=0 Q
"RTN","MPIFAPI1",50,0)
 .K FDA S FDA(1,2,DFN_",",991.04)="@"
"RTN","MPIFAPI1",51,0)
 .K MPIERR D FILE^DIE("E","FDA(1)","MPIERR") K FDA(1) I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to delete pt's ("_DFN_" LOCALLY ASSIGNED ICN field because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI1",52,0)
 I MPIRETN=0 I $D(@ARR@(991.03)) D
"RTN","MPIFAPI1",53,0)
 .I @ARR@(991.03)="@" K FDA S FDA(1,2,DFN_",",991.03)="@"
"RTN","MPIFAPI1",54,0)
 .I @ARR@(991.03)'="@" I @ARR@(991.03)>0 I $$STA^XUAF4(@ARR@(991.03))'="" S FDA(1,2,DFN_",",991.03)="`"_@ARR@(991.03)
"RTN","MPIFAPI1",55,0)
 .D FILE^DIE("E","FDA(1)","MPIERR") I $D(MPIERR("DIERR")) D
"RTN","MPIFAPI1",56,0)
 ..S MPIRETN="-1^Unable to update pt's ("_DFN_") CMOR to "_@ARR@(991.03)_" because "_MPIERR("DIERR",1,"TEXT",1)
"RTN","MPIFAPI1",57,0)
 ..I +$G(MPISILNT)=0 N RGLOG D START^RGHLLOG(0) D EXC^RGHLLOG(221,"Unable to update CMOR to "_@ARR@(991.03)_" for DFN="_DFN,DFN) D STOP^RGHLLOG(0)
"RTN","MPIFAPI1",58,0)
 I MPIRETN=0 I $D(@ARR@(991.05)) D
"RTN","MPIFAPI1",59,0)
 .I @ARR@(991.05)="@" D
"RTN","MPIFAPI1",60,0)
 ..S SCN=$$SUBNUM^MPIFAPI(DFN),DA=SCN,DIK="^HLS(774," D ^DIK K DIK,DA ;**37
"RTN","MPIFAPI1",61,0)
 ..S $P(^DPT(DFN,"MPI"),"^",5)=""
"RTN","MPIFAPI1",62,0)
 ..K ^DPT("ASCN2",SCN,DFN)
"RTN","MPIFAPI1",63,0)
 .I @ARR@(991.05)'="@" D
"RTN","MPIFAPI1",64,0)
 ..;do edit and return result
"RTN","MPIFAPI1",65,0)
 ..S DIE="^DPT(",DA=DFN,DR="991.05///^S X=@ARR@(991.05)" D ^DIE
"RTN","MPIFAPI1",66,0)
 I MPIRETN=0 I $D(@ARR@(992)) D
"RTN","MPIFAPI1",67,0)
 .;delete old value from history multiple
"RTN","MPIFAPI1",68,0)
 .S MPIX=0 F  S MPIX=$O(^DPT(DFN,"MPIFHIS",MPIX)) Q:'MPIX  S VALUE=^DPT(DFN,"MPIFHIS",MPIX,0) I $P(VALUE,"^")=@ARR@(992) D
"RTN","MPIFAPI1",69,0)
 ..K ^DPT("AICN",@ARR@(992),DFN),MPIERR,FDA
"RTN","MPIFAPI1",70,0)
 ..S FDA(1,2.0992,MPIX_","_DFN_",",.01)="@" D FILE^DIE("","FDA(1)","MPIERR")
"RTN","MPIFAPI1",71,0)
 ..I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to delete pt's ("_DFN_")  ICN "_@ARR@(992)_" from ICN HISTORY because "_MPIERR("DIERR",1,"TEXT",1) K MPIERR,FDA
"RTN","MPIFAPI1",72,0)
 I MPIRETN=0 I $D(@ARR@(993)) D
"RTN","MPIFAPI1",73,0)
 .;delete old value from history multiple
"RTN","MPIFAPI1",74,0)
 .S MPIX=0 F  S MPIX=$O(^DPT(DFN,"MPICMOR",MPIX)) Q:'MPIX  S VALUE=^DPT(DFN,"MPICMOR",MPIX,0) I $P(VALUE,"^")=@ARR@(993) D
"RTN","MPIFAPI1",75,0)
 ..K FDA,MPIERR S FDA(1,2.0993,MPIX_","_DFN_",",.01)="@" D FILE^DIE("","FDA(1)","MPIERR")
"RTN","MPIFAPI1",76,0)
 ..I $D(MPIERR("DIERR")) S MPIRETN="-1^Unable to delete pt's ("_DFN_") CMOR "_@ARR@(993)_" from CMOR HISTORY because "_MPIERR("DIERR",1,"TEXT",1) K MPIERR,FDA
"RTN","MPIFAPI1",77,0)
 K ^DPT("AMPIMIS",DFN),RGRSICN
"RTN","MPIFAPI1",78,0)
 L -^DPT("MPI",DFN)
"RTN","MPIFAPI1",79,0)
 Q MPIRETN
"RTN","MPIFAPI1",80,0)
 ;
"VER")
8.0^22.0
**END**
**END**
