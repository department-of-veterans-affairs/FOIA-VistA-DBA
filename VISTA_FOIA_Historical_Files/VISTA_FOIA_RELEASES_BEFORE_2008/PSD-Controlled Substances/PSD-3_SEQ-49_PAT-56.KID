Released PSD*3*56 SEQ #49
Extracted from mail message
**KIDS**:PSD*3.0*56^

**INSTALL NAME**
PSD*3.0*56
"BLD",5486,0)
PSD*3.0*56^CONTROLLED SUBSTANCES^0^3060503^y
"BLD",5486,1,0)
^^1^1^3051012^^^^
"BLD",5486,1,1,0)
DRUG BALANCE NOT UPDATED ON NAOU
"BLD",5486,4,0)
^9.64PA^^
"BLD",5486,6.3)
1
"BLD",5486,"KRN",0)
^9.67PA^8989.52^19
"BLD",5486,"KRN",.4,0)
.4
"BLD",5486,"KRN",.401,0)
.401
"BLD",5486,"KRN",.402,0)
.402
"BLD",5486,"KRN",.403,0)
.403
"BLD",5486,"KRN",.5,0)
.5
"BLD",5486,"KRN",.84,0)
.84
"BLD",5486,"KRN",3.6,0)
3.6
"BLD",5486,"KRN",3.8,0)
3.8
"BLD",5486,"KRN",9.2,0)
9.2
"BLD",5486,"KRN",9.8,0)
9.8
"BLD",5486,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",5486,"KRN",9.8,"NM",1,0)
PSDNRGS^^0^B21502719
"BLD",5486,"KRN",9.8,"NM",2,0)
PSDNTT1^^0^B15874368
"BLD",5486,"KRN",9.8,"NM",3,0)
PSDNTF^^0^B32078580
"BLD",5486,"KRN",9.8,"NM",4,0)
PSDGSRV1^^0^B33639338
"BLD",5486,"KRN",9.8,"NM","B","PSDGSRV1",4)

"BLD",5486,"KRN",9.8,"NM","B","PSDNRGS",1)

"BLD",5486,"KRN",9.8,"NM","B","PSDNTF",3)

"BLD",5486,"KRN",9.8,"NM","B","PSDNTT1",2)

"BLD",5486,"KRN",19,0)
19
"BLD",5486,"KRN",19.1,0)
19.1
"BLD",5486,"KRN",101,0)
101
"BLD",5486,"KRN",409.61,0)
409.61
"BLD",5486,"KRN",771,0)
771
"BLD",5486,"KRN",870,0)
870
"BLD",5486,"KRN",8989.51,0)
8989.51
"BLD",5486,"KRN",8989.52,0)
8989.52
"BLD",5486,"KRN",8994,0)
8994
"BLD",5486,"KRN","B",.4,.4)

"BLD",5486,"KRN","B",.401,.401)

"BLD",5486,"KRN","B",.402,.402)

"BLD",5486,"KRN","B",.403,.403)

"BLD",5486,"KRN","B",.5,.5)

"BLD",5486,"KRN","B",.84,.84)

"BLD",5486,"KRN","B",3.6,3.6)

"BLD",5486,"KRN","B",3.8,3.8)

"BLD",5486,"KRN","B",9.2,9.2)

"BLD",5486,"KRN","B",9.8,9.8)

"BLD",5486,"KRN","B",19,19)

"BLD",5486,"KRN","B",19.1,19.1)

"BLD",5486,"KRN","B",101,101)

"BLD",5486,"KRN","B",409.61,409.61)

"BLD",5486,"KRN","B",771,771)

"BLD",5486,"KRN","B",870,870)

"BLD",5486,"KRN","B",8989.51,8989.51)

"BLD",5486,"KRN","B",8989.52,8989.52)

"BLD",5486,"KRN","B",8994,8994)

"BLD",5486,"PRE")

"BLD",5486,"QUES",0)
^9.62^^
"BLD",5486,"REQB",0)
^9.611^2^2
"BLD",5486,"REQB",1,0)
PSD*3.0*1^2
"BLD",5486,"REQB",2,0)
PSD*3.0*9^2
"BLD",5486,"REQB","B","PSD*3.0*1",1)

"BLD",5486,"REQB","B","PSD*3.0*9",2)

"MBREQ")
0
"PKG",113,-1)
1^1
"PKG",113,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",113,20,0)
^9.402P^^
"PKG",113,22,0)
^9.49I^1^1
"PKG",113,22,1,0)
3.0^2970213^2970403^24
"PKG",113,22,1,"PAH",1,0)
56^3060503
"PKG",113,22,1,"PAH",1,1,0)
^^1^1^3060503
"PKG",113,22,1,"PAH",1,1,1,0)
DRUG BALANCE NOT UPDATED ON NAOU
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSDGSRV1")
0^4^B33639338^B33908693
"RTN","PSDGSRV1",1,0)
PSDGSRV1  ;BIR/BJW-Complete GS for Ret Stk/Destroy ; 7 Apr 98
"RTN","PSDGSRV1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**4,8,9,56**;13 Feb 97;Build 1
"RTN","PSDGSRV1",3,0)
 ;**Y2K compliance** display 4 digit year on va forms
"RTN","PSDGSRV1",4,0)
 ;modified for NOIS:NCH-1296-41051;amended to update dest. bal
"RTN","PSDGSRV1",5,0)
 ;modified for NOIS: FAV-0498-70549
"RTN","PSDGSRV1",6,0)
QTY ;
"RTN","PSDGSRV1",7,0)
 W ! K DIR,DIRUT S DIR(0)="NA^"_$S(COMP=3:1,1:.01)_":"_QTY_":"_$S(COMP=3:0,1:2)
"RTN","PSDGSRV1",8,0)
 S DIR("A")="Quantity of "_NBKU_" "_$S(COMP=3:"Returned to Stock",1:"Turned in for Destruction")_": "
"RTN","PSDGSRV1",9,0)
 S DIR("?")="Enter a quantity from "_$S(COMP=3:1,1:.01)_" to "_QTY
"RTN","PSDGSRV1",10,0)
 D ^DIR K DIR I 'Y!$D(DIRUT) D MSG G END
"RTN","PSDGSRV1",11,0)
 S RQTY=+Y K DIRUT
"RTN","PSDGSRV1",12,0)
ASKN K DA,DIR,DTOUT,DUOUT S DIR("A")="RETURNED BY NURSE",DIR(0)="58.81,29O" D ^DIR K DIR I $D(DUOUT)!($D(DTOUT)) D MSG G END
"RTN","PSDGSRV1",13,0)
 S NURS=$P(Y,"^") I NURS S NURSN=$P($G(^VA(200,+NURS,0)),"^")
"RTN","PSDGSRV1",14,0)
REAS K DA,DIR,DTOUT,DUOUT S DIR(0)=$S(COMP=3:"58.81,36O",1:"58.81,39O") D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) D MSG G END
"RTN","PSDGSRV1",15,0)
 S REAS=Y
"RTN","PSDGSRV1",16,0)
OK K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Is this OK",DIR("B")="YES"
"RTN","PSDGSRV1",17,0)
 S DIR("?",1)="Answer 'YES' to post this completed Green Sheet data,",DIR("?")="answer 'NO' to edit or '^' to quit."
"RTN","PSDGSRV1",18,0)
 D ^DIR K DIR I $D(DIRUT) D MSG G END
"RTN","PSDGSRV1",19,0)
 I 'Y G QTY
"RTN","PSDGSRV1",20,0)
UPDATE ;update 58.81
"RTN","PSDGSRV1",21,0)
 W !!,"Accessing Green Sheet information...",!
"RTN","PSDGSRV1",22,0)
 D NOW^%DTC S RECDT=+% D:COMP=3 SUB
"RTN","PSDGSRV1",23,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81
"RTN","PSDGSRV1",24,0)
 S:COMP=3 DR="34////"_RECDT_";35////"_RQTY_";41////"_BAL_";33////"_PSDUZ_";10////"_CSTAT_";11////"_COMP_";22////"_+$E(RECDT,1,12)_";29////"_NURS_";36///"_REAS
"RTN","PSDGSRV1",25,0)
 S:COMP=2 DR="37////"_RECDT_";38////"_RQTY_";33////"_PSDUZ_";10////"_CSTAT_";11////"_COMP_";22////"_+$E(RECDT,1,12)_";29////"_NURS_";39///"_REAS
"RTN","PSDGSRV1",26,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDGSRV1",27,0)
 W !!,"Updating your records..."
"RTN","PSDGSRV1",28,0)
ORDER ;update order info in 58.8
"RTN","PSDGSRV1",29,0)
 ;chged last line to d desta
"RTN","PSDGSRV1",30,0)
 W "nursing records now..."
"RTN","PSDGSRV1",31,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////"_CSTAT_";11////"_COMP_";12////"_RECDT D ^DIE K DA,DIE,DR
"RTN","PSDGSRV1",32,0)
 ;monthly total
"RTN","PSDGSRV1",33,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,0)) S ^(0)="^58.801A^^"
"RTN","PSDGSRV1",34,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,$E(DT,1,5)*100,0)) K DIC S DIC="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=+PSDS,DA(1)=PSDR D ^DIC K DIC,DA,DINUM,DLAYGO
"RTN","PSDGSRV1",35,0)
 K DA,DIE,DR S DIE="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DA(2)=+PSDS,DA(1)=PSDR,DA=$E(DT,1,5)*100,DR=$S(COMP=3:"11////^S X=$P($G(^(0)),""^"",7)+RQTY",1:"12////^S X=$P($G(^(0)),""^"",8)+RQTY") D ^DIE K DA,DIE,DR
"RTN","PSDGSRV1",36,0)
 W "done.",!!
"RTN","PSDGSRV1",37,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11) W ?2,"*** The status of your Green Sheet #"_PSDPN_" *** ",!
"RTN","PSDGSRV1",38,0)
 S CSTAT=$P($G(^PSD(58.81,PSDA,0)),"^",12) W ?6,$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" "_$P($G(^PSD(58.83,CSTAT,0)),"^")
"RTN","PSDGSRV1",39,0)
 I COMP=3 S MFG=$P(^PSD(58.81,PSDA,0),"^",13),LOT=$P(^(0),"^",14),EXP=$P(^(0),"^",15) D PRINT G END
"RTN","PSDGSRV1",40,0)
 I COMP=2 D DESTA
"RTN","PSDGSRV1",41,0)
END K %,%DT,%H,%I,BAL,C,COMP,CPBY,CSTAT,D,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT
"RTN","PSDGSRV1",42,0)
 K EXP,EXP1,EXPD,LOT,MFG,NAOU,NBKU,NODE,NOK,NUM,NURS,NURSN,OCOMP,OK,ORD,PG,POP,PSDA,PSDCT,PSDEV,PSDHLD,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDSN,PSDTYP,PSDUZ,PSDUZN,PSDYR
"RTN","PSDGSRV1",43,0)
 K QTY,REAS,RECD,RECDT,RQTY,STAT,STATN,SUB,WARDBAL,X,Y
"RTN","PSDGSRV1",44,0)
 Q
"RTN","PSDGSRV1",45,0)
MSG ;
"RTN","PSDGSRV1",46,0)
 W $C(7),!!,"*** THIS GREEN SHEET HAS NOT BEEN COMPLETED ***",!,"The status remains "_STATN,! S PSDOUT=1 Q
"RTN","PSDGSRV1",47,0)
 Q
"RTN","PSDGSRV1",48,0)
SUB ;add balance,Line 4,6,9 added 7/9/97 to update naou bal.
"RTN","PSDGSRV1",49,0)
 F  L +^PSD(58.8,+PSDS,1,PSDR,0):0 I  Q
"RTN","PSDGSRV1",50,0)
 D NOW^%DTC S RECDT=+%
"RTN","PSDGSRV1",51,0)
 S BAL=+$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)
"RTN","PSDGSRV1",52,0)
 S WARDBAL=+$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)
"RTN","PSDGSRV1",53,0)
 S $P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)=$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)+RQTY
"RTN","PSDGSRV1",54,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDGSRV1",55,0)
 S $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)-RQTY
"RTN","PSDGSRV1",56,0)
 L -^PSD(58.8,+PSDS,1,PSDR,0)
"RTN","PSDGSRV1",57,0)
 W !!!,"Old Balance: ",BAL,?25,"New Balance: ",BAL+RQTY,!!
"RTN","PSDGSRV1",58,0)
 W !!,"(NAOU) Old Balance: ",WARDBAL,?32,"(NAOU) New Balance: ",WARDBAL-RQTY,!!
"RTN","PSDGSRV1",59,0)
 Q
"RTN","PSDGSRV1",60,0)
DESTA ;update naou balance added 8/19/96
"RTN","PSDGSRV1",61,0)
 F  L +^PSD(58.8,+PSDS,1,PSDR,0):0 I  Q
"RTN","PSDGSRV1",62,0)
 S WARDBAL=+$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)
"RTN","PSDGSRV1",63,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDGSRV1",64,0)
 S $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)-RQTY
"RTN","PSDGSRV1",65,0)
 L -^PSD(58.8,+PSDS,1,PSDR,0)
"RTN","PSDGSRV1",66,0)
 W !!!,"(NAOU) Old Balance: ",WARDBAL,?32,"(NAOU) New Balance: ",WARDBAL-RQTY,!
"RTN","PSDGSRV1",67,0)
DEST ;set up file 58.86
"RTN","PSDGSRV1",68,0)
 S PSDOUT=0,PSDCT=1
"RTN","PSDGSRV1",69,0)
 W !!,"Accessing your transaction history...",!!
"RTN","PSDGSRV1",70,0)
 S NODE=^PSD(58.81,PSDA,0),PSDTYP=$P(NODE,"^",2),(MFG,LOT,EXP)=""
"RTN","PSDGSRV1",71,0)
 I PSDTYP=9 S COMP=2,REAS=$P(NODE,"^",16),RECDT=$E($P(NODE,"^",4),1,12),RQTY=$P(NODE,"^",6),RQTY=$E(RQTY,2,6),PSDS=$P(NODE,"^",3)
"RTN","PSDGSRV1",72,0)
 I  S PSDR=$P(NODE,"^",5),PSDRN=$P($G(^PSDRUG(+PSDR,0)),"^"),PSDUZ=DUZ,NBKU=$P($G(^PSD(58.8,+PSDS,1,+PSDR,0)),"^",8)
"RTN","PSDGSRV1",73,0)
 I PSDTYP=2 S REAS=$P($G(^PSD(58.81,PSDA,3)),"^",6),MFG=$P(NODE,"^",13),LOT=$P(NODE,"^",14),EXP=$P(NODE,"^",15)
"RTN","PSDGSRV1",74,0)
 W !!,"Creating an entry in the Destruction file..."
"RTN","PSDGSRV1",75,0)
 F  L +^PSD(58.86,0):0 I  Q
"RTN","PSDGSRV1",76,0)
FIND S PSDHLD=$P(^PSD(58.86,0),"^",3)+1 I $D(^PSD(58.86,PSDHLD)) S $P(^PSD(58.86,0),"^",3)=PSDHLD G FIND
"RTN","PSDGSRV1",77,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.86,DIC(0)="L",(X,DINUM)=PSDHLD D ^DIC K DIC,DLAYGO
"RTN","PSDGSRV1",78,0)
 L -^PSD(58.86,0)
"RTN","PSDGSRV1",79,0)
 W !!,"Your Destruction Holding number is ",PSDHLD
"RTN","PSDGSRV1",80,0)
 K DA,DIE,DR S DIE=58.86,DA=PSDHLD,DR="1////"_PSDR_";2////"_RQTY_";3////"_PSDUZ_";5////"_RECDT_";6////"_PSDS_";8////"_PSDA_";"_$S($D(NURSN):"4//^S X=NURSN",1:"4")_";11//^S X=PSDCT;12//^S X=NBKU"
"RTN","PSDGSRV1",81,0)
 D ^DIE K DIE,DA,DR S $P(^PSD(58.81,PSDA,3),"^",8)=PSDHLD
"RTN","PSDGSRV1",82,0)
 I $D(DTOUT)!$D(Y) W !!,"Incomplete information.  You must use the Reprint Disp/Receiving Report",!,"for VA FORM 10-2321 to be printed.",! Q
"RTN","PSDGSRV1",83,0)
PRINT ;print 2321
"RTN","PSDGSRV1",84,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! Q
"RTN","PSDGSRV1",85,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G PRINT
"RTN","PSDGSRV1",86,0)
 S Y=RECDT X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDGSRV1",87,0)
 S PG=0,RECDT=$E(RECDT,4,5)_"/"_$E(RECDT,6,7)_"/"_PSDYR
"RTN","PSDGSRV1",88,0)
 I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3) S EXP=EXPD
"RTN","PSDGSRV1",89,0)
 D ^PSDGSRV2
"RTN","PSDGSRV1",90,0)
 Q
"RTN","PSDNRGS")
0^1^B21502719^B21670844
"RTN","PSDNRGS",1,0)
PSDNRGS ;BIR/JPW-Receive Green Sheet for NAOU ; 6 Jan 94
"RTN","PSDNRGS",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**56**;13 Feb 97;Build 1
"RTN","PSDNRGS",3,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNRGS",4,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):2,$D(^XUSEC("PSJ PHARM TECH",DUZ)):2,1:0)
"RTN","PSDNRGS",5,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to complete",!,?12,"narcotic orders.",!!,"PSJ RNURSE, PSD NURSE, PSJ RPHARM, or PSJ PHARM TECH security key required.",! K OK Q
"RTN","PSDNRGS",6,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH Q
"RTN","PSDNRGS",7,0)
 W !!,"Receive Controlled Substances Orders and Green Sheet" S PSDUZ=DUZ,PSDUZN=$S($P($G(^VA(200,PSDUZ,0)),"^")]"":$P(^(0),"^"),1:"")
"RTN","PSDNRGS",8,0)
 N X,X1 D SIG^XUSESIG Q:X1=""
"RTN","PSDNRGS",9,0)
ASKN ;ask naou
"RTN","PSDNRGS",10,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select NAOU: "
"RTN","PSDNRGS",11,0)
 S:OK=1 DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNRGS",12,0)
 S:OK=2 DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"""
"RTN","PSDNRGS",13,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNRGS",14,0)
GS ;select green sheet #
"RTN","PSDNRGS",15,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNRGS",16,0)
 S DIC("S")="I $P(^(0),""^"",11),$P(^(0),""^"",11)<12"
"RTN","PSDNRGS",17,0)
 D IX^DIC K DIC G:Y<0 ASKN S PSDA=+Y
"RTN","PSDNRGS",18,0)
ORD S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNRGS",19,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^"),QTY=+$P(Y(0),"^",6)
"RTN","PSDNRGS",20,0)
 I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=$P(^(4),"^",3)
"RTN","PSDNRGS",21,0)
 I AOU'=NAOU W $C(7),!!,"The Green Sheet # ",PSDPN," is assigned to ",NAOUN,".",!,"Please select another Green Sheet.",! G GS
"RTN","PSDNRGS",22,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNRGS",23,0)
 I STAT'=3 W $C(7),!!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please select another Green Sheet.",! G GS
"RTN","PSDNRGS",24,0)
 D NOW^%DTC S (RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNRGS",25,0)
REC ;receive at order level in 58.8
"RTN","PSDNRGS",26,0)
 W !!,"Accessing ",PSDRN," information...",!!
"RTN","PSDNRGS",27,0)
 K DA,DIR,DIRUT S DIR(0)="58.81,27",DIR("B")=QTY D ^DIR K DIR I $D(DIRUT) W !!,"Quantity not entered.  No action taken.",!,"This order remains ",STATN,!! G END
"RTN","PSDNRGS",28,0)
 S RQTY=Y I RQTY'=QTY W $C(7),!!,"The quantity received does not match the quantity dispensed.",!,"This order must be returned to pharmacy for investigation.",!! G GS
"RTN","PSDNRGS",29,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU
"RTN","PSDNRGS",30,0)
 S DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,"
"RTN","PSDNRGS",31,0)
 S DR=$S(OK=1:"6////"_PSDUZ,1:"6RECEIVED BY NURSE")_";20////"_QTY_";15////"_RECD_";10////4;22////"_$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)_";25////"_$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4) D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",32,0)
 I ($D(Y))!($D(DTOUT)) W $C(7),!!,"*** THIS ORDER HAS NOT BEEN RECEIVED ***",!,"Receiving nurses name must be entered.",!!,"The status remains "_STATN,! G END
"RTN","PSDNRGS",33,0)
UPDATE ;update 58.8 and 58.81
"RTN","PSDNRGS",34,0)
 ;updating drug balance in 58.8
"RTN","PSDNRGS",35,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):0 I  Q
"RTN","PSDNRGS",36,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDNRGS",37,0)
 S $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)+QTY
"RTN","PSDNRGS",38,0)
 L -^PSD(58.8,NAOU,1,PSDR,0)
"RTN","PSDNRGS",39,0)
 ;update transaction file (58.81)
"RTN","PSDNRGS",40,0)
 S OREC=$P($G(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),"^",7)
"RTN","PSDNRGS",41,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81
"RTN","PSDNRGS",42,0)
 S DR="10////"_$S('$P($G(^PSD(58.8,NAOU,2)),U,5):4,$P($G(^PSD(58.81,PSDA,9)),U):4,1:13)_";20////"_OREC_";21////"_RECD_";27////"_QTY_";I OK=1 S Y=""@1"";15COMMENTS;@1"
"RTN","PSDNRGS",43,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",44,0)
 I OK=2 S $P(^PSD(58.81,PSDA,1),"^",11)=PSDUZ
"RTN","PSDNRGS",45,0)
 W !!,"Updating your records now..."
"RTN","PSDNRGS",46,0)
 ;update worksheet file (58.85) to be purged
"RTN","PSDNRGS",47,0)
 S DA=+$O(^PSD(58.85,"AD",NAOU,PSDR,ORD,0)) I DA,$D(^PSD(58.85,DA,0)) K DIE,DR S DIE=58.85,DR="6////4" D ^DIE K DA,DIE,DR
"RTN","PSDNRGS",48,0)
 W "done.",!!
"RTN","PSDNRGS",49,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11) W ?5,"*** Your Green Sheet #"_PSDPN_" is now "_$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNRGS",50,0)
 G GS
"RTN","PSDNRGS",51,0)
END K %,%DT,%H,%I,AOU,AOUN,D,DA,DIC,DIE,DR,DTOUT,DUOUT
"RTN","PSDNRGS",52,0)
 K NAOU,NAOUN,OK,ORD,OREC,PSDPN,PSDR,PSDRN,PSDUZ,PSDUZN,QTY,RECD,RECDT,RQTY,STAT,STATN,SUB,PSDA,X,Y
"RTN","PSDNRGS",53,0)
 Q
"RTN","PSDNTF")
0^3^B32078580^B32314008
"RTN","PSDNTF",1,0)
PSDNTF ;BIR/JPW-Transfer Green Sheet - From this NAOU ; 1 Mar 98
"RTN","PSDNTF",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,56**;13 Feb 97;Build 1
"RTN","PSDNTF",3,0)
 ;**Y2K compliance**;display 4 digit year on va forms
"RTN","PSDNTF",4,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDNTF",5,0)
 S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,$D(^XUSEC("PSD NURSE",DUZ)):1,$D(^XUSEC("PSJ RPHARM",DUZ)):1,1:0)
"RTN","PSDNTF",6,0)
 I 'OK W $C(7),!!,?9,"** Please contact your Coordinator for access to",!,?12,"transfer narcotic orders.",!!,"PSJ RNURSE, PSD NURSE, or PSJ RPHARM security key required.",! K OK Q
"RTN","PSDNTF",7,0)
 W !!,"Transfer a Green Sheet from this NAOU" S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^")
"RTN","PSDNTF",8,0)
ASKN ;ask transfer from naou
"RTN","PSDNTF",9,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer from NAOU: "
"RTN","PSDNTF",10,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTF",11,0)
 D ^DIC K DIC G:Y<0 END S AOU=+Y,AOUN=$P(Y,"^",2)
"RTN","PSDNTF",12,0)
GS ;select green sheet #
"RTN","PSDNTF",13,0)
 W ! K DA,DIC S DIC("A")="Select the Green Sheet #: ",DIC=58.81,DIC(0)="QEASZ",D="D"
"RTN","PSDNTF",14,0)
 S DIC("S")="I $P(^(0),""^"",11)=4!($P(^(0),U,11)=13),$P(^(0),""^"",18)=AOU",DIC("W")="W "" "",$P($G(^PSDRUG($P(^(0),U,5),0)),U),"" => "",$P($G(^DPT(+$P($G(^PSD(58.81,Y,9)),U),0)),U)"
"RTN","PSDNTF",15,0)
 D IX^DIC K DIC G:Y<0 END S PSDA=+Y
"RTN","PSDNTF",16,0)
 S STAT=+$P(Y(0),"^",11),PSDPN=$P(Y(0),"^",17),STATN="" I STAT S STATN=$P($G(^PSD(58.82,STAT,0)),"^")
"RTN","PSDNTF",17,0)
 S ORD=+$P(Y(0),"^",20),NAOU=+$P(Y(0),"^",18),NAOUN=$P($G(^PSD(58.8,NAOU,0)),"^"),PSDR=+$P(Y(0),"^",5),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^")
"RTN","PSDNTF",18,0)
 S MFG=$P(Y(0),"^",13),LOT=$P(Y(0),"^",14),EXP=$P(Y(0),"^",15),QTY=+$P(Y(0),"^",6),PSDS=+$P(Y(0),"^",3)
"RTN","PSDNTF",19,0)
 S NBKU=$P($G(^PSD(58.8,+PSDS,1,+PSDR,0)),"^",8)
"RTN","PSDNTF",20,0)
 I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=+$P(^(4),"^",3)
"RTN","PSDNTF",21,0)
 I AOU'=NAOU W !!,"The Green Sheet # ",PSDPN," does not reside on ",AOUN,".",!,"Please select another Green Sheet.",! G ASKN
"RTN","PSDNTF",22,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)) W $C(7),!!,"There's no data on ",NAOUN," for Green Sheet # ",PSDPN,".",!,"Contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTF",23,0)
 I STAT'=4,STAT'=13 W !!,"This Green Sheet has a status of "_$S(STATN]"":STATN,1:"UNKNOWN")_".",!,"Please contact your Pharmacy Coordinator for assistance.",! G END
"RTN","PSDNTF",24,0)
ASKT ;ask transfer to naou
"RTN","PSDNTF",25,0)
 W ! K DA,DIC S DIC=58.8,DIC(0)="QEAZ",DIC("A")="Select Transfer To NAOU: "
"RTN","PSDNTF",26,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDNTF",27,0)
 D ^DIC K DIC G:Y<0 END S NAOUT=+Y,NAOUTN=$P(Y,"^",2)
"RTN","PSDNTF",28,0)
 I NAOUT=AOU W !!,"You may not transfer a Green Sheet to your NAOU!",!,"Please select another NAOU.",!! G ASKT
"RTN","PSDNTF",29,0)
 I QTY=1 S RQTY=1 W !,"Quantity to Transfer (",NBKU,"/1)",! G OK
"RTN","PSDNTF",30,0)
QTY ;
"RTN","PSDNTF",31,0)
 W !,"Quantity to Transfer ("_NBKU_"/"_QTY_"): " R X:DTIME I '$T!(X="^")!(X="") S PSDOUT=1 W !!,"**** No action taken. ****",!! G END
"RTN","PSDNTF",32,0)
 I X'?1.6N!(X=0) W !!,"Enter a whole number between 1 and ",QTY,! G QTY
"RTN","PSDNTF",33,0)
 I X>QTY W $C(7),!!,"The quantity returned must not exceed "_QTY_"!",! G QTY
"RTN","PSDNTF",34,0)
 S RQTY=X
"RTN","PSDNTF",35,0)
OK ;if perpetual NAOU and not ordered for patient
"RTN","PSDNTF",36,0)
 D:QTY=1&('$P($G(^PSD(58.81,PSDA,9)),U))  G:$G(PSDOUT) END
"RTN","PSDNTF",37,0)
 .W !,PSDRN," Current Balance:  ",$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)," ",NBKU,!
"RTN","PSDNTF",38,0)
 .S DIR(0)="Y",DIR("A")="Is this a PCA syringe that has already been signed out for a patient",DIR("B")="Y",DIR("?")="If you answer no, your balance will be subtracted by one" D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDNTF",39,0)
 .Q:Y'=1
"RTN","PSDNTF",40,0)
 .S RQTY(1)=1
"RTN","PSDNTF",41,0)
 .S DIC="^DPT(",DIC(0)="AEMQ",DIC("A")="Scan/Enter Patient: "
"RTN","PSDNTF",42,0)
 .W ! D ^DIC K DIC I Y<1 S PSDOUT=1 W !!,"No action taken.",!! Q
"RTN","PSDNTF",43,0)
 .S PAT=+Y
"RTN","PSDNTF",44,0)
 ;ask ok to transfer
"RTN","PSDNTF",45,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Are you sure",DIR("B")="NO"
"RTN","PSDNTF",46,0)
 S DIR("?",1)="Answer 'YES' to transfer this Green Sheet to another NAOU or",DIR("?")="answer 'NO' to leave the Green Sheet status active on your NAOU."
"RTN","PSDNTF",47,0)
 D ^DIR K DIR G:$D(DIRUT) END G:'Y GS
"RTN","PSDNTF",48,0)
 D NOW^%DTC S (RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNTF",49,0)
COM ;complete at order level in 58.8
"RTN","PSDNTF",50,0)
 W !!,"Accessing ",PSDRN," information...",!!
"RTN","PSDNTF",51,0)
 S BQTY=$S($P($G(^PSD(58.8,NAOU,1,PSDR,3,ORD,0)),"^",22):$P(^(0),"^",22)-RQTY,1:QTY-RQTY)
"RTN","PSDNTF",52,0)
 W !!,"Updating your records now..."
"RTN","PSDNTF",53,0)
 ;update transaction file (58.81)
"RTN","PSDNTF",54,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81,DR="64////"_RECD_";65////"_PSDUZ_";66////"_NAOUT_";70////"_RQTY_";10////10;73////"_$G(PAT) D ^DIE K DA,DIE,DR
"RTN","PSDNTF",55,0)
 I $D(Y)!$D(DTOUT) W $C(7),!!,"** THIS GREEN SHEET HAS NOT BEEN TRANSFERRED **",!!,"The status remains "_STATN,! G END
"RTN","PSDNTF",56,0)
 ;update order
"RTN","PSDNTF",57,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////10;22////"_BQTY D ^DIE K DA,DIE,DR
"RTN","PSDNTF",58,0)
 ;update naou bal
"RTN","PSDNTF",59,0)
 F  L +^PSD(58.8,NAOU,1,PSDR,0):0 I  Q
"RTN","PSDNTF",60,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDNTF",61,0)
 S:'$G(RQTY(1)) $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)-RQTY
"RTN","PSDNTF",62,0)
 W:$P($G(^PSD(58.8,NAOU,2)),U,5) !,PSDRN," Remaining Balance:  ",$P($G(^PSD(58.8,NAOU,1,PSDR,0)),U,4)," ",NBKU,!
"RTN","PSDNTF",63,0)
 L -^PSD(58.8,NAOU,PSDR,0)
"RTN","PSDNTF",64,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11)
"RTN","PSDNTF",65,0)
 W ?2,!,"*** The status of your Green Sheet #"_PSDPN_" is now",!,$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNTF",66,0)
PRINT ;print 2321
"RTN","PSDNTF",67,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! Q
"RTN","PSDNTF",68,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G PRINT
"RTN","PSDNTF",69,0)
 S Y=RECD X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDNTF",70,0)
 S (PG,PSDOUT)=0,REAS="",COMP=999,RECDT=$E(RECD,4,5)_"/"_$E(RECD,6,7)_"/"_PSDYR
"RTN","PSDNTF",71,0)
 I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3) S EXP=EXPD
"RTN","PSDNTF",72,0)
 D ^PSDGSRV2
"RTN","PSDNTF",73,0)
END K %,%DT,%H,%I,AOU,AOUN,BQTY,COMP,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXP1,EXPD,LOT,MFG
"RTN","PSDNTF",74,0)
 K NAOU,NAOUN,NAOUT,NAOUTN,NBKU,NUM,OK,ORD,PG,PSDA,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDUZ,PSDUZN,PSDYR,QTY,REAS,RECD,RECDT,RQTY,STAT,STATN,X,Y
"RTN","PSDNTF",75,0)
 Q
"RTN","PSDNTT1")
0^2^B15874368^B16030132
"RTN","PSDNTT1",1,0)
PSDNTT1 ;BIR/BJW-Transfer Green Sheet - Receive this NAOU ; 17 JUL 97
"RTN","PSDNTT1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**1,56**;13 Feb 97;Build 1
"RTN","PSDNTT1",3,0)
 ;rtn chg for nois#:pal-0697-60605,pth-0697-20147,sux-0597-42235
"RTN","PSDNTT1",4,0)
COM ;complete order and transaction
"RTN","PSDNTT1",5,0)
 S FLAG=0 D NOW^%DTC S PSDT=X,(RECD,Y)=+$E(%,1,12) X ^DD("DD") S RECDT=Y
"RTN","PSDNTT1",6,0)
 W !!,"Accessing ",PSDRGN," information...",!!
"RTN","PSDNTT1",7,0)
 I '$D(^PSD(58.8,+AOU,1,+PSDRG,0)) D DRUG
"RTN","PSDNTT1",8,0)
 W !!,"Updating your records now..."
"RTN","PSDNTT1",9,0)
DIE ;create the order request in 58.8
"RTN","PSDNTT1",10,0)
 ;7/25/97 inserted line 6 to update order status to "4" or "13"
"RTN","PSDNTT1",11,0)
 ;chged line 7 fr 10////4 to 10////_stat 
"RTN","PSDNTT1",12,0)
 S:'$D(^PSD(58.8,AOU,1,PSDRG,3,0)) ^(0)="^58.800118A^^"
"RTN","PSDNTT1",13,0)
 S PSDRN=$P(^PSD(58.8,AOU,1,PSDRG,3,0),"^",3)+1 I $D(^PSD(58.8,AOU,1,PSDRG,3,PSDRN)) S $P(^PSD(58.8,AOU,1,PSDRG,3,0),"^",3)=$P(^PSD(58.8,AOU,1,PSDRG,3,0),"^",3)+1 G DIE
"RTN","PSDNTT1",14,0)
 W "order..."
"RTN","PSDNTT1",15,0)
 K DA,DIC,DIE,DD,DR,DO S DIC(0)="L",(DIC,DIE)="^PSD(58.8,"_AOU_",1,"_PSDRG_",3,",DA(2)=AOU,DA(1)=PSDRG,(X,DINUM)=PSDRN D FILE^DICN K DIC
"RTN","PSDNTT1",16,0)
 S DA=PSDRN,DA(1)=PSDRG,DA(2)=AOU
"RTN","PSDNTT1",17,0)
 S STAT=$S(+$P($G(^PSD(58.8,AOU,2)),U,5):13,1:4)
"RTN","PSDNTT1",18,0)
 S DR="16////"_PSDPN_";14////"_PSDSP_";15////"_RECD_";2////"_+PSDS_";6////"_PSDUZ_";7////"_MFG_";8////"_LOT_";9////"_EXP_";10////"_STAT_";19////"_QTY_";20////"_RQTY_";22////"_RQTY
"RTN","PSDNTT1",19,0)
 D ^DIE K DIE,DR
"RTN","PSDNTT1",20,0)
 W "transaction..."
"RTN","PSDNTT1",21,0)
ADD ;find entry number in 58.81
"RTN","PSDNTT1",22,0)
 F  L +^PSD(58.81,0):0 I  Q
"RTN","PSDNTT1",23,0)
FIND S PSDREC=$P(^PSD(58.81,0),"^",3)+1 I $D(^PSD(58.81,PSDREC)) S $P(^PSD(58.81,0),"^",3)=PSDREC G FIND
"RTN","PSDNTT1",24,0)
 K DIC,DLAYGO S DIC(0)="L",(DIC,DLAYGO)=58.81,(X,DINUM)=PSDREC D ^DIC K DIC,DLAYGO
"RTN","PSDNTT1",25,0)
 L -^PSD(58.81,0)
"RTN","PSDNTT1",26,0)
EDIT ;edit new transaction in 58.81
"RTN","PSDNTT1",27,0)
 ;7/21/97 on line 1 deleted "4" in 11th piece,added stat
"RTN","PSDNTT1",28,0)
 ; added lines 1-2 to update order status to a "4" or "13"
"RTN","PSDNTT1",29,0)
 ; also added to line 4 to enter a 1 in "CS";4
"RTN","PSDNTT1",30,0)
 I $P($G(^PSD(58.81,PSDREC,0)),"^")
"RTN","PSDNTT1",31,0)
 S STAT=$S(+$P($G(^PSD(58.8,AOU,2)),U,5):13,1:4)
"RTN","PSDNTT1",32,0)
 S ^PSD(58.81,PSDREC,0)=PSDREC_"^5^"_PSDS_"^"_RECD_"^"_PSDRG_"^"_RQTY_"^^^^^"_STAT_"^^"_MFG_"^"_LOT_"^"_EXP_"^^"_PSDPN_"^"_AOU_"^^"_PSDRN
"RTN","PSDNTT1",33,0)
 S ^PSD(58.81,PSDREC,1)="^^"_PSDUZ_"^"_RECD_"^^^^"_RQTY
"RTN","PSDNTT1",34,0)
 S ^PSD(58.81,PSDREC,7)="^^^^^"_PSDA,^PSD(58.81,PSDREC,9)=PAT
"RTN","PSDNTT1",35,0)
 S ^PSD(58.81,PSDREC,"CS")=1,$P(^PSD(58.81,PSDREC,"CS"),"^",4)=1
"RTN","PSDNTT1",36,0)
 K DA,DIK S DA=PSDREC,DIK="^PSD(58.81," D IX^DIK K DA,DIK
"RTN","PSDNTT1",37,0)
 ;update new order and prev trans #
"RTN","PSDNTT1",38,0)
 S $P(^PSD(58.8,AOU,1,PSDRG,3,PSDRN,0),"^",17)=PSDREC
"RTN","PSDNTT1",39,0)
 S $P(^PSD(58.81,PSDA,7),"^",4)=RECD,$P(^(7),"^",5)=PSDUZ,$P(^(7),"^",3)=AOU
"RTN","PSDNTT1",40,0)
BAL ;update naou to balance
"RTN","PSDNTT1",41,0)
 F  L +^PSD(58.8,AOU,1,PSDRG,0):0 I  Q
"RTN","PSDNTT1",42,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDNTT1",43,0)
 S $P(^PSD(58.8,AOU,1,PSDRG,0),"^",4)=$P(^PSD(58.8,AOU,1,PSDRG,0),"^",4)+RQTY
"RTN","PSDNTT1",44,0)
 L -^PSD(58.8,AOU,1,PSDRG,0)
"RTN","PSDNTT1",45,0)
COMP ;completed msg
"RTN","PSDNTT1",46,0)
 W "done.",!!
"RTN","PSDNTT1",47,0)
 S STAT=$P($G(^PSD(58.81,PSDREC,0)),"^",11)
"RTN","PSDNTT1",48,0)
 W ?2,!,"*** The status of your Green Sheet #"_PSDPN_" is now",!,?2,$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" ***",!
"RTN","PSDNTT1",49,0)
 G:'FLAG END
"RTN","PSDNTT1",50,0)
MSG ;send mail message
"RTN","PSDNTT1",51,0)
 K XMY,^TMP("PSDNTMSG",$J) S ^TMP("PSDNTMSG",$J,1,0)="CS PHARM Transfer Green Sheet between NAOUs",^TMP("PSDNTMSG",$J,2,0)="Transfer In Date: "_RECDT
"RTN","PSDNTT1",52,0)
 S ^TMP("PSDNTMSG",$J,3,0)=""
"RTN","PSDNTT1",53,0)
 S ^TMP("PSDNTMSG",$J,4,0)="Drug: "_PSDRGN_"      Green Sheet #"_PSDPN
"RTN","PSDNTT1",54,0)
 S ^TMP("PSDNTMSG",$J,5,0)="Transfer to: "_AOUN
"RTN","PSDNTT1",55,0)
 S ^TMP("PSDNTMSG",$J,6,0)="",^TMP("PSDNTMSG",$J,7,0)="This drug has been inactivated."
"RTN","PSDNTT1",56,0)
 S XMSUB="CS PHARM TRANSFER GREEN SHEET INACTIVATE DRUG",XMTEXT="^TMP(""PSDNTMSG"",$J,",XMDUZ="CONTROLLED SUBSTANCES PHARMACY"
"RTN","PSDNTT1",57,0)
 F JJ=0:0 S JJ=$O(^XUSEC("PSDMGR",JJ)) Q:'JJ  S XMY(JJ)=""
"RTN","PSDNTT1",58,0)
 S:'$D(XMY) XMY(.5)="" D ^XMD K XMY,^TMP("PSDNTMSG",$J)
"RTN","PSDNTT1",59,0)
END Q
"RTN","PSDNTT1",60,0)
DRUG ;add drug and inactivate it
"RTN","PSDNTT1",61,0)
 S:'$D(^PSD(58.8,AOU,1,0)) ^(0)="^58.8001IP^^"
"RTN","PSDNTT1",62,0)
 K DA,DIC,DIE,DD,DO S (DIC,DIE)="^PSD(58.8,"_AOU_",1,",(X,DINUM)=+PSDRG,DA(1)=AOU,DIC(0)="L" D FILE^DICN K DIC I Y<0 S PSDOUT=1 Q
"RTN","PSDNTT1",63,0)
 K DA,DR S DA=PSDRG,DA(1)=AOU,DR="13////"_PSDT_";14////O;14.5////TRANSFER FROM ANOTHER NAOU" D ^DIE K DA,DIE,DR
"RTN","PSDNTT1",64,0)
 S FLAG=1
"RTN","PSDNTT1",65,0)
 Q
"VER")
8.0^22.0
"BLD",5486,6)
^49
**END**
**END**
