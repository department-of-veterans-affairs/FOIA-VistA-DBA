Released IB*2*309 SEQ #282
Extracted from mail message
**KIDS**:IB*2.0*309^

**INSTALL NAME**
IB*2.0*309
"BLD",6209,0)
IB*2.0*309^INTEGRATED BILLING^0^3050913^y
"BLD",6209,1,0)
^^3^3^3050602^^^
"BLD",6209,1,1,0)
This patch will replace all the direct global references to Pharmacy data
"BLD",6209,1,2,0)
in the Integrated Billing package. The direct references will be replaced
"BLD",6209,1,3,0)
with API calls to the Pharmacy package.
"BLD",6209,4,0)
^9.64PA^^
"BLD",6209,"ABPKG")
n
"BLD",6209,"KRN",0)
^9.67PA^8989.52^19
"BLD",6209,"KRN",.4,0)
.4
"BLD",6209,"KRN",.401,0)
.401
"BLD",6209,"KRN",.402,0)
.402
"BLD",6209,"KRN",.403,0)
.403
"BLD",6209,"KRN",.5,0)
.5
"BLD",6209,"KRN",.84,0)
.84
"BLD",6209,"KRN",3.6,0)
3.6
"BLD",6209,"KRN",3.8,0)
3.8
"BLD",6209,"KRN",9.2,0)
9.2
"BLD",6209,"KRN",9.8,0)
9.8
"BLD",6209,"KRN",9.8,"NM",0)
^9.68A^24^23
"BLD",6209,"KRN",9.8,"NM",1,0)
IBATLM2A^^0^B34274323
"BLD",6209,"KRN",9.8,"NM",2,0)
IBATRX^^0^B3695019
"BLD",6209,"KRN",9.8,"NM",3,0)
IBCD4^^0^B16638912
"BLD",6209,"KRN",9.8,"NM",4,0)
IBCEF11^^0^B35185539
"BLD",6209,"KRN",9.8,"NM",5,0)
IBCEF22^^0^B51405532
"BLD",6209,"KRN",9.8,"NM",6,0)
IBCF331^^0^B6717938
"BLD",6209,"KRN",9.8,"NM",7,0)
IBCF4^^0^B19230544
"BLD",6209,"KRN",9.8,"NM",8,0)
IBCRCC^^0^B18876800
"BLD",6209,"KRN",9.8,"NM",9,0)
IBCSC5^^0^B18022600
"BLD",6209,"KRN",9.8,"NM",10,0)
IBCSC5A^^0^B42043599
"BLD",6209,"KRN",9.8,"NM",11,0)
IBCSC5C^^0^B37390710
"BLD",6209,"KRN",9.8,"NM",12,0)
IBCSC61^^0^B7919813
"BLD",6209,"KRN",9.8,"NM",13,0)
IBCU1^^0^B25353879
"BLD",6209,"KRN",9.8,"NM",14,0)
IBECUSO^^0^B41082188
"BLD",6209,"KRN",9.8,"NM",15,0)
IBJTBA^^0^B47561481
"BLD",6209,"KRN",9.8,"NM",17,0)
IBTOBI^^0^B26152194
"BLD",6209,"KRN",9.8,"NM",18,0)
IBTRED^^0^B22295125
"BLD",6209,"KRN",9.8,"NM",19,0)
IBTRKR3^^0^B23758062
"BLD",6209,"KRN",9.8,"NM",20,0)
IBTRKR31^^0^B9080810
"BLD",6209,"KRN",9.8,"NM",21,0)
IBTUBO2^^0^B26096597
"BLD",6209,"KRN",9.8,"NM",22,0)
IBRXUTL^^0^B356749
"BLD",6209,"KRN",9.8,"NM",23,0)
IBRFN^^0^B32970869
"BLD",6209,"KRN",9.8,"NM",24,0)
IBRFN3^^0^B29672386
"BLD",6209,"KRN",9.8,"NM","B","IBATLM2A",1)

"BLD",6209,"KRN",9.8,"NM","B","IBATRX",2)

"BLD",6209,"KRN",9.8,"NM","B","IBCD4",3)

"BLD",6209,"KRN",9.8,"NM","B","IBCEF11",4)

"BLD",6209,"KRN",9.8,"NM","B","IBCEF22",5)

"BLD",6209,"KRN",9.8,"NM","B","IBCF331",6)

"BLD",6209,"KRN",9.8,"NM","B","IBCF4",7)

"BLD",6209,"KRN",9.8,"NM","B","IBCRCC",8)

"BLD",6209,"KRN",9.8,"NM","B","IBCSC5",9)

"BLD",6209,"KRN",9.8,"NM","B","IBCSC5A",10)

"BLD",6209,"KRN",9.8,"NM","B","IBCSC5C",11)

"BLD",6209,"KRN",9.8,"NM","B","IBCSC61",12)

"BLD",6209,"KRN",9.8,"NM","B","IBCU1",13)

"BLD",6209,"KRN",9.8,"NM","B","IBECUSO",14)

"BLD",6209,"KRN",9.8,"NM","B","IBJTBA",15)

"BLD",6209,"KRN",9.8,"NM","B","IBRFN",23)

"BLD",6209,"KRN",9.8,"NM","B","IBRFN3",24)

"BLD",6209,"KRN",9.8,"NM","B","IBRXUTL",22)

"BLD",6209,"KRN",9.8,"NM","B","IBTOBI",17)

"BLD",6209,"KRN",9.8,"NM","B","IBTRED",18)

"BLD",6209,"KRN",9.8,"NM","B","IBTRKR3",19)

"BLD",6209,"KRN",9.8,"NM","B","IBTRKR31",20)

"BLD",6209,"KRN",9.8,"NM","B","IBTUBO2",21)

"BLD",6209,"KRN",19,0)
19
"BLD",6209,"KRN",19,"NM",0)
^9.68A^^
"BLD",6209,"KRN",19.1,0)
19.1
"BLD",6209,"KRN",101,0)
101
"BLD",6209,"KRN",409.61,0)
409.61
"BLD",6209,"KRN",771,0)
771
"BLD",6209,"KRN",870,0)
870
"BLD",6209,"KRN",8989.51,0)
8989.51
"BLD",6209,"KRN",8989.52,0)
8989.52
"BLD",6209,"KRN",8994,0)
8994
"BLD",6209,"KRN","B",.4,.4)

"BLD",6209,"KRN","B",.401,.401)

"BLD",6209,"KRN","B",.402,.402)

"BLD",6209,"KRN","B",.403,.403)

"BLD",6209,"KRN","B",.5,.5)

"BLD",6209,"KRN","B",.84,.84)

"BLD",6209,"KRN","B",3.6,3.6)

"BLD",6209,"KRN","B",3.8,3.8)

"BLD",6209,"KRN","B",9.2,9.2)

"BLD",6209,"KRN","B",9.8,9.8)

"BLD",6209,"KRN","B",19,19)

"BLD",6209,"KRN","B",19.1,19.1)

"BLD",6209,"KRN","B",101,101)

"BLD",6209,"KRN","B",409.61,409.61)

"BLD",6209,"KRN","B",771,771)

"BLD",6209,"KRN","B",870,870)

"BLD",6209,"KRN","B",8989.51,8989.51)

"BLD",6209,"KRN","B",8989.52,8989.52)

"BLD",6209,"KRN","B",8994,8994)

"BLD",6209,"QUES",0)
^9.62^^
"BLD",6209,"REQB",0)
^9.611^18^18
"BLD",6209,"REQB",1,0)
IB*2.0*115^1
"BLD",6209,"REQB",2,0)
IB*2.0*135^1
"BLD",6209,"REQB",3,0)
IB*2.0*155^1
"BLD",6209,"REQB",4,0)
IB*2.0*160^1
"BLD",6209,"REQB",5,0)
IB*2.0*199^1
"BLD",6209,"REQB",6,0)
IB*2.0*210^1
"BLD",6209,"REQB",7,0)
IB*2.0*223^1
"BLD",6209,"REQB",8,0)
IB*2.0*230^1
"BLD",6209,"REQB",9,0)
IB*2.0*240^1
"BLD",6209,"REQB",10,0)
IB*2.0*245^1
"BLD",6209,"REQB",11,0)
IB*2.0*247^1
"BLD",6209,"REQB",12,0)
IB*2.0*266^1
"BLD",6209,"REQB",13,0)
IB*2.0*287^1
"BLD",6209,"REQB",14,0)
PSS*1.0*85^1
"BLD",6209,"REQB",15,0)
PSS*1.0*91^1
"BLD",6209,"REQB",16,0)
PSN*4.0*80^1
"BLD",6209,"REQB",17,0)
PSN*4.0*94^1
"BLD",6209,"REQB",18,0)
IB*2.0*260^1
"BLD",6209,"REQB","B","IB*2.0*115",1)

"BLD",6209,"REQB","B","IB*2.0*135",2)

"BLD",6209,"REQB","B","IB*2.0*155",3)

"BLD",6209,"REQB","B","IB*2.0*160",4)

"BLD",6209,"REQB","B","IB*2.0*199",5)

"BLD",6209,"REQB","B","IB*2.0*210",6)

"BLD",6209,"REQB","B","IB*2.0*223",7)

"BLD",6209,"REQB","B","IB*2.0*230",8)

"BLD",6209,"REQB","B","IB*2.0*240",9)

"BLD",6209,"REQB","B","IB*2.0*245",10)

"BLD",6209,"REQB","B","IB*2.0*247",11)

"BLD",6209,"REQB","B","IB*2.0*260",18)

"BLD",6209,"REQB","B","IB*2.0*266",12)

"BLD",6209,"REQB","B","IB*2.0*287",13)

"BLD",6209,"REQB","B","PSN*4.0*80",16)

"BLD",6209,"REQB","B","PSN*4.0*94",17)

"BLD",6209,"REQB","B","PSS*1.0*85",14)

"BLD",6209,"REQB","B","PSS*1.0*91",15)

"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
309^3050913
"PKG",200,22,1,"PAH",1,1,0)
^^3^3^3050913
"PKG",200,22,1,"PAH",1,1,1,0)
This patch will replace all the direct global references to Pharmacy data
"PKG",200,22,1,"PAH",1,1,2,0)
in the Integrated Billing package. The direct references will be replaced
"PKG",200,22,1,"PAH",1,1,3,0)
with API calls to the Pharmacy package.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
23
"RTN","IBATLM2A")
0^1^B34274323
"RTN","IBATLM2A",1,0)
IBATLM2A ;LL/ELZ - TRANSFER PRICING PT TRANSACTION DETAIL ; 15-SEP-1998
"RTN","IBATLM2A",2,0)
 ;;2.0;INTEGRATED BILLING;**115,210,266,309**;21-MAR-94
"RTN","IBATLM2A",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBATLM2A",4,0)
 ;
"RTN","IBATLM2A",5,0)
 N IBX,IBY K ^TMP("IBATEE",$J)
"RTN","IBATLM2A",6,0)
 F IBX=0,4,5,6 S IBDATA(IBX)=$G(^IBAT(351.61,IBIEN,IBX))
"RTN","IBATLM2A",7,0)
 ;
"RTN","IBATLM2A",8,0)
 S IBY=""
"RTN","IBATLM2A",9,0)
 D SET("*** General Information ***",.IBY,26,27)
"RTN","IBATLM2A",10,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",11,0)
 D CNTRL^VALM10(VALMCNT,26,27,IOINHI,IOINORM)
"RTN","IBATLM2A",12,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",13,0)
 ;
"RTN","IBATLM2A",14,0)
 D SET("Transaction Date:",.IBY,1,17)
"RTN","IBATLM2A",15,0)
 D SET($$DATE($P(IBDATA(0),"^",3)),.IBY,19,19)
"RTN","IBATLM2A",16,0)
 D SET("Event Date:",.IBY,48,11)
"RTN","IBATLM2A",17,0)
 D SET($$DATE($P(IBDATA(0),"^",4)),.IBY,60,20)
"RTN","IBATLM2A",18,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",19,0)
 ;
"RTN","IBATLM2A",20,0)
 D SET("Status:",.IBY,11,7)
"RTN","IBATLM2A",21,0)
 D SET($$EX^IBATUTL(351.61,.05,$P(IBDATA(0),"^",5)),.IBY,19,19)
"RTN","IBATLM2A",22,0)
 D SET("Priced Date:",.IBY,47,12)
"RTN","IBATLM2A",23,0)
 D SET($$DATE($P(IBDATA(0),"^",13)),.IBY,60,20)
"RTN","IBATLM2A",24,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",25,0)
 ;
"RTN","IBATLM2A",26,0)
 D SET("From Date:",.IBY,8,10)
"RTN","IBATLM2A",27,0)
 D SET($$DATE($P(IBDATA(0),"^",9)),.IBY,19,19)
"RTN","IBATLM2A",28,0)
 D SET("To Date:",.IBY,51,8)
"RTN","IBATLM2A",29,0)
 D SET($$DATE($P(IBDATA(0),"^",10)),.IBY,60,20)
"RTN","IBATLM2A",30,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",31,0)
 ;
"RTN","IBATLM2A",32,0)
 D SET("Facility:",.IBY,9,9)
"RTN","IBATLM2A",33,0)
 D SET($$EX^IBATUTL(351.61,.11,$P(IBDATA(0),"^",11)),.IBY,19,19)
"RTN","IBATLM2A",34,0)
 D SETVALM(.VALMCNT,.IBY),SETVALM(.VALMCNT,""),SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",35,0)
 ;
"RTN","IBATLM2A",36,0)
 D SET("*** Workload/Pricing Detail ***",.IBY,24,31)
"RTN","IBATLM2A",37,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",38,0)
 D CNTRL^VALM10(VALMCNT,24,31,IOINHI,IOINORM)
"RTN","IBATLM2A",39,0)
 ;
"RTN","IBATLM2A",40,0)
 D @$S($P(IBDATA(0),"^",12)["DGPM(":"INPT",$P(IBDATA(0),"^",12)["SCE(":"OUT",$P(IBDATA(0),"^",12)["RMPR(":"RMPR",1:"RX")
"RTN","IBATLM2A",41,0)
 ;
"RTN","IBATLM2A",42,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",43,0)
 D SET("*** Totals ***",.IBY,33,14)
"RTN","IBATLM2A",44,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",45,0)
 D CNTRL^VALM10(VALMCNT,26,28,IOINHI,IOINORM)
"RTN","IBATLM2A",46,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",47,0)
 ;
"RTN","IBATLM2A",48,0)
 D SET("Bill Amount:",.IBY,6,18)
"RTN","IBATLM2A",49,0)
 D SET($FN($P(IBDATA(6),"^",2),"",2),.IBY,25,54)
"RTN","IBATLM2A",50,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",51,0)
 ;
"RTN","IBATLM2A",52,0)
 D SET("Patient Copay:",.IBY,6,14)
"RTN","IBATLM2A",53,0)
 S $P(IBDATA(6),"^",3)=$$COPAY^IBATUTL(DFN,$P(IBDATA(0),"^",12),$P(IBDATA(0),"^",9),$P(IBDATA(0),"^",10))
"RTN","IBATLM2A",54,0)
 D SET($FN($P(IBDATA(6),"^",3),"",2),.IBY,26,54)
"RTN","IBATLM2A",55,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",56,0)
 ;
"RTN","IBATLM2A",57,0)
 Q
"RTN","IBATLM2A",58,0)
INPT ; -- detail display for inpatient
"RTN","IBATLM2A",59,0)
 N IBDRG,VAIP
"RTN","IBATLM2A",60,0)
 ;
"RTN","IBATLM2A",61,0)
 S IBDRG=$G(^IBAT(351.61,IBIEN,1))
"RTN","IBATLM2A",62,0)
 ;
"RTN","IBATLM2A",63,0)
 S VAIP("E")=+$P(IBDATA(0),"^",12) D IN5^VADPT
"RTN","IBATLM2A",64,0)
 ;
"RTN","IBATLM2A",65,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",66,0)
 D SET("Admission Date:",.IBY,3,15)
"RTN","IBATLM2A",67,0)
 D SET($P(VAIP(13,1),"^",2),.IBY,19,19)
"RTN","IBATLM2A",68,0)
 D SET("Discharge Date:",.IBY,44,15)
"RTN","IBATLM2A",69,0)
 D SET($P(VAIP(17,1),"^",2),.IBY,60,20)
"RTN","IBATLM2A",70,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",71,0)
 ;
"RTN","IBATLM2A",72,0)
 D SET("Ward Location:",.IBY,4,14)
"RTN","IBATLM2A",73,0)
 D SET($P(VAIP(5),"^",2),.IBY,19,19)
"RTN","IBATLM2A",74,0)
 D SET("Treating Specialty:",.IBY,40,19)
"RTN","IBATLM2A",75,0)
 D SET($P(VAIP(8),"^",2),.IBY,60,20)
"RTN","IBATLM2A",76,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",77,0)
 ;
"RTN","IBATLM2A",78,0)
 D SET("DRG:",.IBY,14,4)
"RTN","IBATLM2A",79,0)
 D SET($$EX^IBATUTL(351.61,1.01,$P(IBDRG,"^")),.IBY,19,19)
"RTN","IBATLM2A",80,0)
 D SET("DRG Charge:",.IBY,48,11)
"RTN","IBATLM2A",81,0)
 D SET($FN($P(IBDRG,"^",2),"",2),.IBY,60,20)
"RTN","IBATLM2A",82,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",83,0)
 ;
"RTN","IBATLM2A",84,0)
 D SET("Inpatient LOS:",.IBY,4,14)
"RTN","IBATLM2A",85,0)
 D SET(+$P(IBDRG,"^",3),.IBY,19,19)
"RTN","IBATLM2A",86,0)
 D SET("High Trim Days:",.IBY,44,15)
"RTN","IBATLM2A",87,0)
 D SET(+$P(IBDRG,"^",4),.IBY,60,20)
"RTN","IBATLM2A",88,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",89,0)
 ;
"RTN","IBATLM2A",90,0)
 D SET("Outlier Days:",.IBY,5,13)
"RTN","IBATLM2A",91,0)
 D SET(+$P(IBDRG,"^",5),.IBY,19,19)
"RTN","IBATLM2A",92,0)
 D SET("Outlier Rate:",.IBY,46,13)
"RTN","IBATLM2A",93,0)
 D SET($FN($P(IBDRG,"^",6),"",2),.IBY,60,20)
"RTN","IBATLM2A",94,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",95,0)
 Q
"RTN","IBATLM2A",96,0)
OUT ; -- detail display for outpatient
"RTN","IBATLM2A",97,0)
 N IBX,IBDXLIST,IBSCE,IBPROV,IBDATE
"RTN","IBATLM2A",98,0)
 ;
"RTN","IBATLM2A",99,0)
 D GETGEN^SDOE($P($P(IBDATA(0),"^",12),";"),"IBSCE")
"RTN","IBATLM2A",100,0)
 D GETPRV^SDOE($P($P(IBDATA(0),"^",12),";"),"IBPROV")
"RTN","IBATLM2A",101,0)
 ;
"RTN","IBATLM2A",102,0)
 D GETDX^SDOE($P($P(IBDATA(0),"^",12),";"),"IBDXLIST")
"RTN","IBATLM2A",103,0)
 S IBDATE=$P($G(IBDATA(0)),U,4) ; Event date
"RTN","IBATLM2A",104,0)
 D DX(.IBDXLIST,IBDATE)
"RTN","IBATLM2A",105,0)
 ;
"RTN","IBATLM2A",106,0)
 D SET("Procedure Information:",.IBY,1,22)
"RTN","IBATLM2A",107,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",108,0)
 D CNTRL^VALM10(VALMCNT,1,22,IOINHI,IOINORM)
"RTN","IBATLM2A",109,0)
 ;
"RTN","IBATLM2A",110,0)
 S IBX=0 F  S IBX=$O(^IBAT(351.61,IBIEN,3,IBX)) Q:IBX<1  D
"RTN","IBATLM2A",111,0)
 . S IBX(0)=$G(^IBAT(351.61,IBIEN,3,IBX,0))
"RTN","IBATLM2A",112,0)
 . S IBX(1)=$$PROC^IBATUTL($P(IBX(0),U),IBDATE)
"RTN","IBATLM2A",113,0)
 . ;
"RTN","IBATLM2A",114,0)
 . D SET(+IBX(1),.IBY,5,6)
"RTN","IBATLM2A",115,0)
 . D SET("-",.IBY,13,1)
"RTN","IBATLM2A",116,0)
 . D SET($P(IBX(1),"^",2),.IBY,15,40)
"RTN","IBATLM2A",117,0)
 . D SET(+$P(IBX(0),"^",2),.IBY,57,3)
"RTN","IBATLM2A",118,0)
 . D SET("x",.IBY,62,1)
"RTN","IBATLM2A",119,0)
 . D SET($FN($P(IBX(0),"^",3),"",2),.IBY,64,15)
"RTN","IBATLM2A",120,0)
 . D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",121,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",122,0)
 ;
"RTN","IBATLM2A",123,0)
 D SET("Visit Information:",.IBY,1,18)
"RTN","IBATLM2A",124,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",125,0)
 D CNTRL^VALM10(VALMCNT,1,22,IOINHI,IOINORM)
"RTN","IBATLM2A",126,0)
 ;
"RTN","IBATLM2A",127,0)
 D SET("Location:",.IBY,8,14)
"RTN","IBATLM2A",128,0)
 D SET($P(^SC(+$P(IBSCE(0),"^",4),0),"^"),.IBY,19,46) ; dbia 10040
"RTN","IBATLM2A",129,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",130,0)
 ;
"RTN","IBATLM2A",131,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",132,0)
 D SET("Provider(s):",.IBY,5,17)
"RTN","IBATLM2A",133,0)
 S IBX=0 F  S IBX=$O(IBPROV(IBX)) Q:IBX<.5  D
"RTN","IBATLM2A",134,0)
 . D SET($$GET1^DIQ(200,+IBPROV(IBX),.01),.IBY,19,49) ; dbia 10060
"RTN","IBATLM2A",135,0)
 . D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",136,0)
 ;
"RTN","IBATLM2A",137,0)
 Q
"RTN","IBATLM2A",138,0)
RX ; -- detail display for rx
"RTN","IBATLM2A",139,0)
 D SET("Drug:",.IBY,5,5)
"RTN","IBATLM2A",140,0)
 D ZERO^IBRXUTL(+IBDATA(4))
"RTN","IBATLM2A",141,0)
 D SET(^TMP($J,"IBDRUG",+IBDATA(4),.01),.IBY,12,40) ; dbia 4533
"RTN","IBATLM2A",142,0)
 D SET(+$P(IBDATA(4),"^",2),.IBY,55,3)
"RTN","IBATLM2A",143,0)
 D SET("x",.IBY,60,1)
"RTN","IBATLM2A",144,0)
 D SET($FN($P(IBDATA(4),"^",3),"",3),.IBY,62,15)
"RTN","IBATLM2A",145,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",146,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",147,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBATLM2A",148,0)
 Q
"RTN","IBATLM2A",149,0)
RMPR ; -- detail display for prosthetic
"RTN","IBATLM2A",150,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",151,0)
 D SET("Prosthetic Item:",.IBY,5,16)
"RTN","IBATLM2A",152,0)
 D SET($$GET1^DIQ(661,$P(IBDATA(4),"^",4),.01),.IBY,12,40) ; dbia 374
"RTN","IBATLM2A",153,0)
 D SET($FN($P(IBDATA(4),"^",5),",",2),.IBY,55,15)
"RTN","IBATLM2A",154,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",155,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",156,0)
 Q
"RTN","IBATLM2A",157,0)
DX(IBDX,IBDATE) ; -- diagnosis info
"RTN","IBATLM2A",158,0)
 N IBX
"RTN","IBATLM2A",159,0)
 ;
"RTN","IBATLM2A",160,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",161,0)
 D SET("Diagnosis Information:",.IBY,1,22)
"RTN","IBATLM2A",162,0)
 D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",163,0)
 D CNTRL^VALM10(VALMCNT,1,22,IOINHI,IOINORM)
"RTN","IBATLM2A",164,0)
 ;
"RTN","IBATLM2A",165,0)
 S IBX=0 F  S IBX=$O(IBDX(IBX)) Q:IBX<1  D
"RTN","IBATLM2A",166,0)
 . S IBX(0)=$$ICD9^IBACSV(+IBDX(IBX),$G(IBDATE))
"RTN","IBATLM2A",167,0)
 . ;
"RTN","IBATLM2A",168,0)
 . D SET($P(IBX(0),"^"),.IBY,5,7)
"RTN","IBATLM2A",169,0)
 . D SET("-",.IBY,14,1)
"RTN","IBATLM2A",170,0)
 . D SET($P(IBX(0),"^",3),.IBY,16,30)
"RTN","IBATLM2A",171,0)
 . D SETVALM(.VALMCNT,.IBY)
"RTN","IBATLM2A",172,0)
 D SETVALM(.VALMCNT,"")
"RTN","IBATLM2A",173,0)
 Q
"RTN","IBATLM2A",174,0)
SET(TEXT,STRING,COL,LENGTH) ; -- set up string with valm1
"RTN","IBATLM2A",175,0)
 S STRING=$$SETSTR^VALM1($$LOWER^VALM1(TEXT),STRING,COL,LENGTH)
"RTN","IBATLM2A",176,0)
 Q
"RTN","IBATLM2A",177,0)
SETVALM(LINE,TEXT) ; -- sets line for display
"RTN","IBATLM2A",178,0)
 S LINE=LINE+1
"RTN","IBATLM2A",179,0)
 S ^TMP("IBATEE",$J,LINE,0)=TEXT
"RTN","IBATLM2A",180,0)
 S TEXT=""
"RTN","IBATLM2A",181,0)
 Q
"RTN","IBATLM2A",182,0)
DATE(X) ; -- returns date for display
"RTN","IBATLM2A",183,0)
 Q $$FMTE^XLFDT(X,"5D")
"RTN","IBATRX")
0^2^B3695019
"RTN","IBATRX",1,0)
IBATRX ;LL/ELZ - TRANSFER PRICING RX ROUTINE ; 24-FEB-99
"RTN","IBATRX",2,0)
 ;;2.0;INTEGRATED BILLING;**115,309**;21-MAR-94
"RTN","IBATRX",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBATRX",4,0)
 ;
"RTN","IBATRX",5,0)
RX(DFN,DT1,DT2,ARRAY) ; look up all rxs for a patient and date range
"RTN","IBATRX",6,0)
 ;
"RTN","IBATRX",7,0)
 N PIFN,RIFN,IBX,IBY,DTE,DTR,RX,IBCNT,IBRX0,IBRX2,IBS,IBRF K ARRAY,POARR S POARR=0
"RTN","IBATRX",8,0)
 S IBCNT=0,DT1=$G(DT1)-.0001,DT2=$G(DT2) S:'DT2 DT2=9999999 Q:'$G(DFN)
"RTN","IBATRX",9,0)
 S DTE=DT1 F  S DTE=$O(^PS(55,DFN,"P","A",DTE)) Q:'DTE  D
"RTN","IBATRX",10,0)
 . S IBRX=0 F  S IBRX=$O(^PS(55,DFN,"P","A",DTE,IBRX)) Q:'IBRX  D
"RTN","IBATRX",11,0)
 .. F IBY=0,2 S IBRX(IBY)=$G(^PSRX(IBRX,IBY))
"RTN","IBATRX",12,0)
 ..D ZERO^IBRXUTL(+$P(IBRX(0),"^",6))
"RTN","IBATRX",13,0)
 .. ; original fill
"RTN","IBATRX",14,0)
 .. S DTR=$P(IBRX(2),"^",2) I DTR'<DT1,DTR'>DT2 D
"RTN","IBATRX",15,0)
 ... S ARRAY(IBRX,+DTR)=$P(IBRX(0),"^")_"^"_0_"^"_$P(IBRX(0),"^",6)_"^"_$G(^TMP($J,"IBDRUG",+$P(IBRX(0),"^",6),.01))_"^"_$P(IBRX(0),"^",7)_"^"_$P(IBRX(0),"^",17)
"RTN","IBATRX",16,0)
 .. ; refills
"RTN","IBATRX",17,0)
 .. S DTR=DT1 F  S DTR=$O(^PSRX(IBRX,1,"B",DTR)) Q:'DTR!(DTR>DT2)  D
"RTN","IBATRX",18,0)
 ... S IBRF=0 F  S IBRF=$O(^PSRX(IBRX,1,"B",DTR,IBRF)) Q:'IBRF  D
"RTN","IBATRX",19,0)
 .... S IBY=$G(^PSRX(IBRX,1,IBRF,0)) Q:IBY=""
"RTN","IBATRX",20,0)
 .... S ARRAY(IBRX,+IBY)=$P(IBRX(0),"^")_"^"_IBRF_"^"_$P(IBRX(0),"^",6)_"^"_$G(^TMP($J,"IBDRUG",+$P(IBRX(0),"^",6),.01))_"^"_$P(IBY,"^",4)_"^"_$P(IBY,"^",11)
"RTN","IBATRX",21,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBATRX",22,0)
 Q
"RTN","IBCD4")
0^3^B16638912
"RTN","IBCD4",1,0)
IBCD4 ;ALB/ARH - AUTOMATED BILLER (ADD NEW BILL - GATHER DX AND PROCEDURES)  ; 9/5/93
"RTN","IBCD4",2,0)
 ;;2.0;INTEGRATED BILLING;**14,80,106,160,309**;21-MAR-94
"RTN","IBCD4",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCD4",4,0)
 ;
"RTN","IBCD4",5,0)
 ;
"RTN","IBCD4",6,0)
IDX(PTF,DT1,DT2) ; find 501 movement Diagnosis and 701 Discharge Diagnosisfor a PTF record within bill range
"RTN","IBCD4",7,0)
 ; check for billable bedsection and SC treatement and duplicates
"RTN","IBCD4",8,0)
 ; results: IBT = number of billable movements within date range
"RTN","IBCD4",9,0)
 ;          IBMSG(X)=" error message " if any errors found
"RTN","IBCD4",10,0)
 ;         ^TMP("IBDX",$J)= PTF IFN
"RTN","IBCD4",11,0)
 ;         ^TMP("IBDX",$J,DX)=""
"RTN","IBCD4",12,0)
 ;         ^TMP("IBDX",$J,-MOVE DATE, x) = Dx
"RTN","IBCD4",13,0)
 N IBMVT,IBN,IBDT,IBCNT,IBBS,IBSC,IBMV,IBDX,IBI,IBX K IBMSG,IBT,^TMP("IBDX",$J)
"RTN","IBCD4",14,0)
 ;
"RTN","IBCD4",15,0)
 D PTFDXDT^IBCSC4F(PTF,DT1,DT2) S IBMVT="M" I +$P($G(^TMP($J,"IBDX","D")),U,3) S IBMVT="D"
"RTN","IBCD4",16,0)
 ;
"RTN","IBCD4",17,0)
 S ^TMP("IBDX",$J)=+PTF S (IBT,IBBS,IBSC)=0,IBCNT=1
"RTN","IBCD4",18,0)
 F IBN="D","M" S IBDT="" F  S IBDT=$O(^TMP($J,"IBDX",IBN,IBDT)) Q:'IBDT  D
"RTN","IBCD4",19,0)
 . S IBMV=$G(^TMP($J,"IBDX",IBN,IBDT)) Q:IBMV=""
"RTN","IBCD4",20,0)
 . ;
"RTN","IBCD4",21,0)
 . I IBN="M" S IBT=IBT+1,IBX="" D  Q:+IBX
"RTN","IBCD4",22,0)
 .. I $P(IBMV,U,3)=1 S IBSC=IBSC+1,IBMSG(IBCNT)=$$FMTE^XLFDT(IBDT)_" movement related to an SC condition.",IBCNT=IBCNT+1,IBX=1
"RTN","IBCD4",23,0)
 .. I $P($G(^DIC(42.4,+$P(IBMV,U,2),0)),U,5)="" S IBBS=IBBS+1,IBMSG(IBCNT)=$$FMTE^XLFDT(IBDT)_" movement is for a non-billable bedsection.",IBCNT=IBCNT+1,IBX=1
"RTN","IBCD4",24,0)
 .. I '$P(IBMV,U,4) S IBMSG(IBCNT)=$$FMTE^XLFDT(IBDT)_" movement does not have a DRG as required for Reasonable Charges.",IBCNT=IBCNT+1
"RTN","IBCD4",25,0)
 . I IBN'=IBMVT Q
"RTN","IBCD4",26,0)
 . ;
"RTN","IBCD4",27,0)
 . S IBI="" F  S IBI=$O(^TMP($J,"IBDX",IBN,IBDT,IBI)) Q:'IBI  D
"RTN","IBCD4",28,0)
 .. S IBDX=$G(^TMP($J,"IBDX",IBN,IBDT,IBI)) Q:'IBDX
"RTN","IBCD4",29,0)
 .. I '$P(IBDX,U,2),IBDT>+$G(^TMP("IBDX",$J,"DX",+IBDX)) S ^TMP("IBDX",$J,"DX",+IBDX)=IBDT_U_IBI
"RTN","IBCD4",30,0)
 ;
"RTN","IBCD4",31,0)
 S IBDX="" F  S IBDX=$O(^TMP("IBDX",$J,"DX",IBDX)) Q:'IBDX  D
"RTN","IBCD4",32,0)
 . S IBX=^TMP("IBDX",$J,"DX",IBDX) I +IBX S ^TMP("IBDX",$J,-IBX,+$P(IBX,U,2))=IBDX
"RTN","IBCD4",33,0)
 K ^TMP($J,"IBDX")
"RTN","IBCD4",34,0)
 ;
"RTN","IBCD4",35,0)
 I +IBSC S IBMSG(IBCNT)="PTF record indicates "_+IBSC_" of "_IBT_" movements are for Service Connected Care.",IBCNT=IBCNT+1
"RTN","IBCD4",36,0)
 I +IBBS S IBMSG(IBCNT)="PTF record indicates "_+IBBS_" of "_IBT_" movements are for a non-billable bedsection.",IBCNT=IBCNT+1
"RTN","IBCD4",37,0)
 S IBT=IBT-IBSC-IBBS I 'IBT S IBMSG(IBCNT)="0 movements are billable."
"RTN","IBCD4",38,0)
IDXE Q
"RTN","IBCD4",39,0)
 ;
"RTN","IBCD4",40,0)
IPRC(PTF,DT1,DT2) ;find 401 and 601 procedures for a PTF record
"RTN","IBCD4",41,0)
 ;results: ^TMP("IBIPRC",$J,PROC DATE)=PROC1^ ... ^PROC5
"RTN","IBCD4",42,0)
 ;where PROC DATE = (45.01,45.01,.01) and (45,45.05,.01) and PROC = (45,45.01,8-12) and (45,45.05,4-8)
"RTN","IBCD4",43,0)
 N IBX,IBY,IBZ,IBI K ^TMP("IBIPRC",$J) I '$D(^DGPT(+$G(PTF),0)) G IPRCE
"RTN","IBCD4",44,0)
 S DT1=$S(+$G(DT1):+DT1,1:0),DT2=$S(+$G(DT2):+DT2,1:9999999),^TMP("IBIPRC",$J)=+PTF
"RTN","IBCD4",45,0)
 S IBX=0 F  S IBX=$O(^DGPT(+PTF,"S",IBX)) Q:'IBX  S IBY=$G(^DGPT(+PTF,"S",IBX,0)) I +IBY'<DT1,+IBY'>DT2 D
"RTN","IBCD4",46,0)
 . S IBZ="" F IBI=8:1:12 I +$P(IBY,U,IBI) S IBZ=IBZ_+$P(IBY,U,IBI)_U
"RTN","IBCD4",47,0)
 . I +IBZ S ^TMP("IBIPRC",$J,+IBY)=$G(^TMP("IBIPRC",$J,+IBY))_IBZ
"RTN","IBCD4",48,0)
 S IBX=0 F  S IBX=$O(^DGPT(+PTF,"P",IBX)) Q:'IBX  S IBY=$G(^DGPT(+PTF,"P",IBX,0)) I +IBY'<DT1,+IBY'>DT2 D
"RTN","IBCD4",49,0)
 . S IBZ="" F IBI=5:1:9 I +$P(IBY,U,IBI) S IBZ=IBZ_+$P(IBY,U,IBI)_U
"RTN","IBCD4",50,0)
 . I +IBZ S ^TMP("IBIPRC",$J,+IBY)=$G(^TMP("IBIPRC",$J,+IBY))_IBZ
"RTN","IBCD4",51,0)
IPRCE Q
"RTN","IBCD4",52,0)
 ;
"RTN","IBCD4",53,0)
RXRF(PIFN,RIFN,IBDT) ; returns data on fill on date for rx (RX # ^ DRUG ^ DAYS SUPPLY ^ FILL DATE ^ QTY ^ NDC #)
"RTN","IBCD4",54,0)
 N X,Y,PLN,RLN,IBFILL S X=""
"RTN","IBCD4",55,0)
 I +$G(PIFN) S PLN=$G(^PSRX(+PIFN,0)) I PLN'="" D
"RTN","IBCD4",56,0)
 . I +$G(IBDT) S RIFN=$O(^PSRX("AD",+IBDT,+PIFN,""))
"RTN","IBCD4",57,0)
 . S RLN="",IBFILL="^^" I $G(RIFN)="" Q
"RTN","IBCD4",58,0)
 . I RIFN=0 S RLN=$G(^PSRX(+PIFN,2)) Q:RLN=""  S IBFILL=$P(PLN,U,8)_"^"_$P(RLN,U,2)_"^"_$P(PLN,U,7)
"RTN","IBCD4",59,0)
 . I +RIFN S RLN=$G(^PSRX(+PIFN,1,+RIFN,0)) Q:RLN=""  S IBFILL=$P(RLN,U,10)_"^"_$P(RLN,U,1)_"^"_$P(RLN,U,4)
"RTN","IBCD4",60,0)
 . D DATA^IBRXUTL(+$P(PLN,U,6))
"RTN","IBCD4",61,0)
 . S X=$P(PLN,U,1)_"^"_$P(PLN,U,6)_"^"_IBFILL_"^"_$G(^TMP($J,"IBDRUG",+$P(PLN,U,6),31))
"RTN","IBCD4",62,0)
 . K ^TMP($J,"IBDRUG")
"RTN","IBCD4",63,0)
 Q X
"RTN","IBCD4",64,0)
 ;
"RTN","IBCD4",65,0)
CHK() ;other checks
"RTN","IBCD4",66,0)
 N X S X=1 I $G(^DPT(+$G(IBDFN),0))="" S X="0^Patient information lacking."
"RTN","IBCD4",67,0)
 Q X
"RTN","IBCD4",68,0)
 ;
"RTN","IBCD4",69,0)
CHKSYS() ;various checks to determine if bill can be created, returns true if passes   XXXXXX
"RTN","IBCD4",70,0)
 ;if fails then returns "0^error message"
"RTN","IBCD4",71,0)
 ;requires nothing
"RTN","IBCD4",72,0)
 N X,Y,I S X=1
"RTN","IBCD4",73,0)
 I '$P($G(^IBE(350.9,1,1)),U,14) S X="0^MAS SERVICE PARAMETER UNKNOWN" G CHKSYSE
"RTN","IBCD4",74,0)
 I +$P($$SITE^VASITE,U,3)<1 S X="0^ACILITY UNDEFINED" G CHKSYSE
"RTN","IBCD4",75,0)
 ;G:$D(IBB) CHKSYSE
"RTN","IBCD4",76,0)
 ;I '$D(DUZ(0)) S X="0^FILEMAN ACCESS UNDEFINED" G CHKSYSE
"RTN","IBCD4",77,0)
 ;I $S($D(DLAYGO):2\1-(DLAYGO\1),1:1),DUZ(0)'="@",$D(^DIC(399,0,"LAYGO"))  S DLAYGO=399
"RTN","IBCD4",78,0)
CHKSYSE Q X
"RTN","IBCD4",79,0)
 ;
"RTN","IBCD4",80,0)
 ;GVARS(IFN) ;get data on bill IFN  (commented out patch 80, does not appear to be used)
"RTN","IBCD4",81,0)
 ;N I S X=1 I '$G(^DGCR(399,+$G(IFN),0)) S X=0 G GVARSE
"RTN","IBCD4",82,0)
 ;F I=0,"M" S IB(I)=$G(^DGCR(399,+IFN,I))
"RTN","IBCD4",83,0)
 ;S DGINPAR=$P($G(^DIC(36,+IB("MP"),0)),U,6,10)
"RTN","IBCD4",84,0)
 ;GVARSE Q X
"RTN","IBCEF11")
0^4^B35185539
"RTN","IBCEF11",1,0)
IBCEF11 ;ALB/TMP - FORMATTER SPECIFIC BILL FUNCTIONS - CONT ;30-JAN-96
"RTN","IBCEF11",2,0)
 ;;2.0;INTEGRATED BILLING;**51,137,155,309**;21-MAR-94
"RTN","IBCEF11",3,0)
 ;
"RTN","IBCEF11",4,0)
BOX24D(A,IB) ; Returns the lines for boxes 19-24 of the HCFA 1500 display
"RTN","IBCEF11",5,0)
 ; IB = flag is 1 if only box 24 is needed
"RTN","IBCEF11",6,0)
 Q $S('$G(IB):"36",1:"44")_"^55"
"RTN","IBCEF11",7,0)
 ;
"RTN","IBCEF11",8,0)
RCBOX() ; Returns the lines for revenue code boxes of the UB-92 display
"RTN","IBCEF11",9,0)
 Q "19^41"
"RTN","IBCEF11",10,0)
 ;
"RTN","IBCEF11",11,0)
OUTPT(IBIFN,IBPRINT) ; Returns an array of service line data from
"RTN","IBCEF11",12,0)
 ;                 HCFA 1500 box 24.  Output is in IBXDATA(n)
"RTN","IBCEF11",13,0)
 ; IBPRINT = print flag  1: return print fields
"RTN","IBCEF11",14,0)
 ;                       0: return EDI fields
"RTN","IBCEF11",15,0)
 ; Uses diagnosis array ^TMP("IBXSAVE",$J,"DX",IBIFN,DIAG CODE)=SEQ #
"RTN","IBCEF11",16,0)
 ;   if it already exists. If not, it builds it from N-DIAGNOSES element
"RTN","IBCEF11",17,0)
 ;
"RTN","IBCEF11",18,0)
 ; For EDI call: Returns IBXDATA(n)=
"RTN","IBCEF11",19,0)
 ;   begin date(YYYYMMDD)^end date(YYYYMMDD)^pos^tos^
"RTN","IBCEF11",20,0)
 ;   proc code/revenue code - if no procedure (not the pointers)^
"RTN","IBCEF11",21,0)
 ;   type of code^dx pointer(s)^unit charge^units^modifiers separated by;
"RTN","IBCEF11",22,0)
 ;   ^purchased charge amount ^anesthesia minutes^emergency indicator^
"RTN","IBCEF11",23,0)
 ;   lab-type service flag.
"RTN","IBCEF11",24,0)
 ;
"RTN","IBCEF11",25,0)
 ;   Also Returns IBXDATA(IBI,"COB",COB,m) with COB data for each line
"RTN","IBCEF11",26,0)
 ;      item found in an accepted EOB for the bill and = the reference
"RTN","IBCEF11",27,0)
 ;      line in the first '^' piece followed by the '0' node data of file
"RTN","IBCEF11",28,0)
 ;      361.115 (LINE LEVEL ADJUSTMENTS)
"RTN","IBCEF11",29,0)
 ;       COB = COB sequence # of adjustment's ins co, m = seq #
"RTN","IBCEF11",30,0)
 ;         -- AND --
"RTN","IBCEF11",31,0)
 ;    IBXDATA(IBI,"COB",COB,m,z,p)=
"RTN","IBCEF11",32,0)
 ;           the data on the '0' node for each subordinate entry of file
"RTN","IBCEF11",33,0)
 ;           361.11511 (REASONS) (Only first 3 pieces for 837 output)
"RTN","IBCEF11",34,0)
 ;       z = group code, sometimes preceeded by a space   p = seq #
"RTN","IBCEF11",35,0)
 ;
"RTN","IBCEF11",36,0)
 ; For Print call: Returns begin date(DDMMYYYY)^end date(DDMMYYYY) or
"RTN","IBCEF11",37,0)
 ;   null if equal to begin date^pos^tos^bedsection name(if no procedure)
"RTN","IBCEF11",38,0)
 ;   or procedure code(not the pointer)^ ... refer to EDI call results
"RTN","IBCEF11",39,0)
 ;   Also, IBXDATA(n,"TEXT")=the text to print on second line of box 24,
"RTN","IBCEF11",40,0)
 ;   If no procedure code, returns IBXDATA(n,"A")=rev code abbrev
"RTN","IBCEF11",41,0)
 ;
"RTN","IBCEF11",42,0)
 ;  For both calls, returns IBXDATA(n,item type,item ptr)=""
"RTN","IBCEF11",43,0)
 ;      -- AND --
"RTN","IBCEF11",44,0)
 ;   IBXDATA(n,"RX")=RX#^drug name^NDC^refill #^(re)fill date^qty^days
"RTN","IBCEF11",45,0)
 ;                   ^chrge^ien of file 362.4^NDC format
"RTN","IBCEF11",46,0)
 ;           If line references a prescription
"RTN","IBCEF11",47,0)
 ;      -- AND --
"RTN","IBCEF11",48,0)
 ;   If no revenue code for a prescription, returns IBXDATA(n,"ARX")=""
"RTN","IBCEF11",49,0)
 ;      -- AND --
"RTN","IBCEF11",50,0)
 ;   IBXDATA(n,"AUX")='AUX' node of the procedure entry
"RTN","IBCEF11",51,0)
 ;
"RTN","IBCEF11",52,0)
 N IB,IBI,IBJ,IBFLD,IBDXI,IBXIEN,Z,IBXTRA,IBRX,IBRX0,IBRX1,Z0,Z1
"RTN","IBCEF11",53,0)
 ;
"RTN","IBCEF11",54,0)
 K ^TMP($J,"IBITEM")
"RTN","IBCEF11",55,0)
 S ^TMP($J,"IBITEM")=""
"RTN","IBCEF11",56,0)
 ; Build diagnosis array if not already built
"RTN","IBCEF11",57,0)
 I $O(^TMP("IBXSAVE",$J,"DX",IBIFN,""))="",$O(^IBA(362.3,"AIFN"_IBIFN,"")) D
"RTN","IBCEF11",58,0)
 .N Z,IBXDATA D F^IBCEF("N-DIAGNOSES",,,IBIFN)
"RTN","IBCEF11",59,0)
 .S Z="" F  S Z=$O(IBXDATA(Z)) K:$O(IBXDATA(0))=""&(Z="") IBXDATA Q:Z=""  S:$P(IBXDATA(Z),U,2) ^TMP("IBXSAVE",$J,"DX",IBIFN,$P(IBXDATA(Z),U,2))=Z
"RTN","IBCEF11",60,0)
 ;
"RTN","IBCEF11",61,0)
 S IB(0)=$G(^DGCR(399,IBIFN,0)),IB("U")=$G(^("U")),IB("U1")=$G(^("U1"))
"RTN","IBCEF11",62,0)
 S IBI="" F  S IBI=$O(^TMP("IBXSAVE",$J,"DX",IBIFN,IBI)) Q:IBI=""  S IBDXI(IBI)=^(IBI)
"RTN","IBCEF11",63,0)
 I '$G(IBPRINT) D RVCE^IBCF23(IBIFN,IBIFN)
"RTN","IBCEF11",64,0)
 I $G(IBPRINT) D RVCE^IBCF23(,IBIFN)
"RTN","IBCEF11",65,0)
 ; Returns IBFLD(24) = begin date^end date^pos^tos^
"RTN","IBCEF11",66,0)
 ;     proc/bedsection/revenue code^dx pointer^unit charge^
"RTN","IBCEF11",67,0)
 ;     units^modifiers^ purchased charge amount ^anesthesia minutes^
"RTN","IBCEF11",68,0)
 ;     emergency indicator ^ AND
"RTN","IBCEF11",69,0)
 ;         IBFLD(24,n,type,item)=""
"RTN","IBCEF11",70,0)
 ;         IBFLD(24,n_"A") = revenue code abbreviation if no procedure
"RTN","IBCEF11",71,0)
 ;         IBFLD(24,n,"AUX") = 'AUX' node of line item 
"RTN","IBCEF11",72,0)
 ;         IBFLD(24,n,"RX") = soft pointer to file 362.4 from 'item' fld
"RTN","IBCEF11",73,0)
 ;                            (can be null)
"RTN","IBCEF11",74,0)
 ;
"RTN","IBCEF11",75,0)
 D SET^IBCSC5A(IBIFN,.IBRX) ;prescriptions
"RTN","IBCEF11",76,0)
 ; IBRX1(ien 362.4)=RX#^drug ien^NDC^refil #^(re)fil date^qty^days^chrge
"RTN","IBCEF11",77,0)
 I IBRX S IBRX="" F  S IBRX=$O(IBRX(IBRX)) Q:IBRX=""  S IBRX0=0 F  S IBRX0=$O(IBRX(IBRX,IBRX0)) Q:'IBRX0  D
"RTN","IBCEF11",78,0)
 . N IBRXH
"RTN","IBCEF11",79,0)
 . S IBRXH=IBRX(IBRX,IBRX0)
"RTN","IBCEF11",80,0)
 . S IBRX1(+IBRXH)=IBRX_U_$P(IBRXH,U,2)_U_$P(IBRXH,U,5)_U_$P(IBRXH,U,7)_U_IBRX0_U_$P(IBRXH,U,4)_U_$P(IBRXH,U,3)_U_$P(IBRXH,U,6)_U_+IBRXH_U_$P(IBRXH,U,8)
"RTN","IBCEF11",81,0)
 K IBRX
"RTN","IBCEF11",82,0)
 ;
"RTN","IBCEF11",83,0)
 S IBI=0
"RTN","IBCEF11",84,0)
 F  S IBI=$O(IBFLD(24,IBI)) Q:IBI'=+IBI  D
"RTN","IBCEF11",85,0)
 . S IBRX1=0
"RTN","IBCEF11",86,0)
 . I '$G(IBPRINT) Q:$P(IBFLD(24,IBI),U,7)*$P(IBFLD(24,IBI),U,8)'>0  ; For EDI, ignore 0-charge line items
"RTN","IBCEF11",87,0)
 . S IBXDATA(IBI)=$P(IBFLD(24,IBI),U)_U_$P(IBFLD(24,IBI),U,$S($P(IBFLD(24,IBI),U,2)=""&'$G(IBPRINT):1,1:2))
"RTN","IBCEF11",88,0)
 . S $P(IBXDATA(IBI),U,3,5)=$P(IBFLD(24,IBI),U,3,5)
"RTN","IBCEF11",89,0)
 . S $P(IBXDATA(IBI),U,6)=$S($D(IBFLD(24,IBI_"X")):"CJ",1:"HC")
"RTN","IBCEF11",90,0)
 . S $P(IBXDATA(IBI),U,7,13)=$P(IBFLD(24,IBI),U,6,12)
"RTN","IBCEF11",91,0)
 . S $P(IBXDATA(IBI),U,14)=+$$ISLAB(IBXDATA(IBI))
"RTN","IBCEF11",92,0)
 . I $D(IBFLD(24,IBI,"RX")) D  ;Rx
"RTN","IBCEF11",93,0)
 .. S IBRX1=1
"RTN","IBCEF11",94,0)
 .. I $P($G(IBFLD(24,IBI,"AUX")),U,8)'="" S $P(IBFLD(24,IBI,"AUX"),U,8)="" ;No free text allowed for rx's
"RTN","IBCEF11",95,0)
 .. I $D(IBRX1(+IBFLD(24,IBI,"RX"))) D  Q  ;Soft link exists
"RTN","IBCEF11",96,0)
 ...D ZERO^IBRXUTL(+$P(IBRX1(+IBFLD(24,IBI,"RX")),U,2))
"RTN","IBCEF11",97,0)
 ... S IBXDATA(IBI,"RX")=IBRX1(+IBFLD(24,IBI,"RX")),$P(IBXDATA(IBI,"RX"),U,2)=$E($G(^TMP($J,"IBDRUG",+$P(IBRX1(+IBFLD(24,IBI,"RX")),U,2),.01)),1,30)
"RTN","IBCEF11",98,0)
 ... K IBRX1(+IBFLD(24,IBI,"RX"))
"RTN","IBCEF11",99,0)
 ... ; No soft link - must find the first Rx with the same charge
"RTN","IBCEF11",100,0)
 .. D ZERO^IBRXUTL(+$P(IBRX1(IBRX),U,2))
"RTN","IBCEF11",101,0)
 .. S IBRX="" F  S IBRX=$O(IBRX1(IBRX)) Q:'IBRX  I +$P(IBRX1(IBRX),U,8)=+$P(IBXDATA(IBI),U,8) S IBXDATA(IBI,"RX")=IBRX1(IBRX),$P(IBXDATA(IBI,"RX"),U,2)=$E($G(^TMP($J,"IBDRUG",+$P(IBRX1(IBRX),U,2),.01)),1,30) K IBRX1(IBRX) Q
"RTN","IBCEF11",102,0)
 . I $G(IBFLD(24,IBI,"AUX"))'="" D
"RTN","IBCEF11",103,0)
 .. I $G(IBPRINT),$P(IBFLD(24,IBI,"AUX"),U,8)'="" S IBXDATA(IBI,"TEXT")=$P(IBFLD(24,IBI,"AUX"),U,8),$P(IBFLD(24,IBI,"AUX"),U,8)=""
"RTN","IBCEF11",104,0)
 .. S IBXDATA(IBI,"AUX")=IBFLD(24,IBI,"AUX")
"RTN","IBCEF11",105,0)
 . I $G(IBPRINT) D
"RTN","IBCEF11",106,0)
 .. I '$P(IBXDATA(IBI),U,8),'$G(IBXDATA(IBI,"RX")) S:'$G(IBNOSHOW) IBXDATA(IBI,"TEXT")="Warning:** REV CODE UNITS < #PROCEDURES, THEY MUST BE =" Q
"RTN","IBCEF11",107,0)
 .. I $G(IBFLD(24,IBI_"A"))'="" S IBXDATA(IBI,"A")=IBFLD(24,IBI_"A") S:'$G(IBNOSHOW) IBXDATA(IBI,"TEXT")="Warning:** REV CODE UNITS > #PROCEDURES, THEY MUST BE=: "_IBFLD(24,IBI_"A") Q
"RTN","IBCEF11",108,0)
 .. S IBRX=$G(IBXDATA(IBI,"RX"))
"RTN","IBCEF11",109,0)
 .. I IBRX'="" D  ;Format Rx detail
"RTN","IBCEF11",110,0)
 ... N Z
"RTN","IBCEF11",111,0)
 ... S Z=$P(IBRX,U)
"RTN","IBCEF11",112,0)
 ... S Z=$S(Z'="":"Rx#"_Z_" ",1:"RX: ")
"RTN","IBCEF11",113,0)
 ... S IBXDATA(IBI,"TEXT")=Z_$S($P(IBRX,U,3)'="":"NDC: "_$P(IBRX,U,3),1:"NOC: "_$P(IBRX,U,2))_" Qty: "_$P(IBRX,U,6)_" Days: "_$P(IBRX,U,7)
"RTN","IBCEF11",114,0)
 . I '$G(IBPRINT) D COBLINE^IBCEU6(IBIFN,IBI,.IBXDATA,,.IBXTRA)
"RTN","IBCEF11",115,0)
 I $G(IBPRINT) D
"RTN","IBCEF11",116,0)
 . S IBRX=0 F  S IBRX=$O(IBRX1(IBRX)) Q:'IBRX  D
"RTN","IBCEF11",117,0)
 .. S IBI=+$O(IBXDATA(""),-1)+1
"RTN","IBCEF11",118,0)
 .. S IBXDATA(IBI)=$$DATE($P(IBRX1(IBRX),U,5))
"RTN","IBCEF11",119,0)
 .. S IBXDATA(IBI,"TEXT")="**** ERROR - NO PROC LINK TO REV CODE FOR DRUG: RX#: "_$P(IBRX1(IBRX),U)_"  NDC #: "_$P(IBRX1(IBRX),U,3)
"RTN","IBCEF11",120,0)
 .. S IBXDATA(IBI,"ARX")=""
"RTN","IBCEF11",121,0)
 .. D ZERO^IBRXUTL(+$P(IBRX1(IBRX),U,2))
"RTN","IBCEF11",122,0)
 .. S IBXDATA(IBI,"RX")=IBRX1(IBRX),$P(IBXDATA(IBI,"RX"),U,2)=$E($G(^TMP($J,"IBDRUG",+$P(IBRX1(IBRX),U,2),.01)),1,30) K IBRX1(IBRX)
"RTN","IBCEF11",123,0)
 ;
"RTN","IBCEF11",124,0)
 I '$G(IBPRINT),$D(IBXTRA) D COMBO^IBCEU2(.IBXDATA,.IBXTRA,0) ;Handle bundled/unbundled lines
"RTN","IBCEF11",125,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBCEF11",126,0)
 Q
"RTN","IBCEF11",127,0)
 ;
"RTN","IBCEF11",128,0)
ISLAB(LDATA) ; Returns 0/1 if line item data indicates the item is a lab (1)
"RTN","IBCEF11",129,0)
 ; 'LAB' is defined here as type of service = 5
"RTN","IBCEF11",130,0)
 Q $E($P(LDATA,U,4))="5"
"RTN","IBCEF11",131,0)
 ;
"RTN","IBCEF11",132,0)
FMT(DATA,DLEN,FLEN) ; Returns a string in DATA with a max length of DLEN
"RTN","IBCEF11",133,0)
 ;  and a field length of FLEN
"RTN","IBCEF11",134,0)
 Q $E($E(DATA,1,DLEN)_$J("",FLEN),1,FLEN)
"RTN","IBCEF11",135,0)
 ;
"RTN","IBCEF11",136,0)
DATE(X,DEL) ;  Returns FM date in X as MMxDDxYYYY  where x=DEL
"RTN","IBCEF11",137,0)
 S DEL=$G(DEL)
"RTN","IBCEF11",138,0)
 S X=$$DATE^IBCF2(X,1,1)
"RTN","IBCEF11",139,0)
 I X'="" S X=$E(X,1,2)_DEL_$E(X,3,4)_DEL_$E(X,5,8)
"RTN","IBCEF11",140,0)
 Q X
"RTN","IBCEF11",141,0)
 ;
"RTN","IBCEF22")
0^5^B51405532
"RTN","IBCEF22",1,0)
IBCEF22 ;ALB/TMP - FORMATTER SPECIFIC BILL FUNCTIONS ;06-FEB-96
"RTN","IBCEF22",2,0)
 ;;2.0;INTEGRATED BILLING;**51,137,135,155,309**;21-MAR-94
"RTN","IBCEF22",3,0)
 ;
"RTN","IBCEF22",4,0)
 ;  OVERFLOW FROM ROUTINE IBCEF2
"RTN","IBCEF22",5,0)
HOS(IBIFN) ; Extract rev codes for episode billed on a UB92 into IBXDATA
"RTN","IBCEF22",6,0)
 ; IBIFN = bill ien
"RTN","IBCEF22",7,0)
 ; Format: IBXDATA(n) =
"RTN","IBCEF22",8,0)
 ;  rev cd ptr ^ CPT CODE ptr ^ unit chg ^ units ^ tot charge
"RTN","IBCEF22",9,0)
 ;    ^ tot uncov^ FL49 value ^ ien of rev code multiple entry(s)
"RTN","IBCEF22",10,0)
 ;      (separated by ";")
"RTN","IBCEF22",11,0)
 ;    ^ modifiers specific to rev code/proc (separated by ",")
"RTN","IBCEF22",12,0)
 ;    ^ rev code date, if it can be determined by a corresponding proc
"RTN","IBCEF22",13,0)
 ;
"RTN","IBCEF22",14,0)
 ;   Also Returns IBXDATA(IBI,"COB",COB,m) with COB data for each line
"RTN","IBCEF22",15,0)
 ;      item found in an accepted EOB for the bill and = the reference
"RTN","IBCEF22",16,0)
 ;      line in the first '^' piece followed by the '0' node of file
"RTN","IBCEF22",17,0)
 ;      361.115 (LINE LEVEL ADJUSTMENTS)
"RTN","IBCEF22",18,0)
 ;       COB = COB seq # of adjustment's ins co, m = seq #
"RTN","IBCEF22",19,0)
 ;         -- AND --
"RTN","IBCEF22",20,0)
 ;    IBXDATA(IBI,"COB",COB,m,z,p)=
"RTN","IBCEF22",21,0)
 ;           the '0' node for each subordinate entry of file
"RTN","IBCEF22",22,0)
 ;           361.11511 (REASONS) (Only first 3 pieces for 837)
"RTN","IBCEF22",23,0)
 ;       z = group code, sometimes preceeded by a space   p = seq #
"RTN","IBCEF22",24,0)
 ;
"RTN","IBCEF22",25,0)
 N IBDA,IBCOMB,IBINPAT,IBLN,IBX,IBY,IBZ,IBS,IBSS,IBXTRA,IBX1,IBXS,IBP,IBPO,IBP1,IBDEF,Z,Z0,Z1,ZX,QQ,IBMOD
"RTN","IBCEF22",26,0)
 S IBINPAT=$$INPAT^IBCEF(IBIFN,1)
"RTN","IBCEF22",27,0)
 I 'IBINPAT D F^IBCEF("N-STATEMENT COVERS FROM DATE","IBZ",,IBIFN)
"RTN","IBCEF22",28,0)
 S IBDEF=$G(IBZ)
"RTN","IBCEF22",29,0)
 ; loop through all proc codes - sort by procedure, modifiers and print order
"RTN","IBCEF22",30,0)
 S IBDA=0 F  S IBDA=$O(^DGCR(399,IBIFN,"CP",IBDA)) Q:'IBDA  S IBZ=$G(^(IBDA,0)) I IBZ D
"RTN","IBCEF22",31,0)
 . S IBP(+$P(IBZ,U)_U_$$GETMOD^IBEFUNC(IBIFN,IBDA,1),$S($P(IBZ,U,4):$P(IBZ,U,4),1:999),IBDA)=$P(IBZ,U,2)
"RTN","IBCEF22",32,0)
 ; loop through all rev codes - sort by rev code
"RTN","IBCEF22",33,0)
 S IBDA=0 F  S IBDA=$O(^DGCR(399,IBIFN,"RC",IBDA)) Q:'IBDA  S IBZ=$G(^(IBDA,0)) I IBZ S IBMOD="" D
"RTN","IBCEF22",34,0)
 . S IBX=$G(^DGCR(399.2,+IBZ,0)),IBX1="",IBPO=0
"RTN","IBCEF22",35,0)
 . ; Auto-added procedure charge
"RTN","IBCEF22",36,0)
 . I $P(IBZ,U,10)=4,$P(IBZ,U,11) D  ; Soft link to proc
"RTN","IBCEF22",37,0)
 .. S Z=$G(^DGCR(399,IBIFN,"CP",$P(IBZ,U,11),0))
"RTN","IBCEF22",38,0)
 .. Q:Z=""
"RTN","IBCEF22",39,0)
 .. S ZX=+Z_U_$$GETMOD^IBEFUNC(IBIFN,$P(IBZ,U,11),1)
"RTN","IBCEF22",40,0)
 .. Q:'$O(IBP(ZX,0))&'$O(IBP1(ZX,0))
"RTN","IBCEF22",41,0)
 .. I $P(IBZ,U,6) Q:$S($P(Z,U)'["ICPT":1,1:+$P(Z,U)'=$P(IBZ,U,6))
"RTN","IBCEF22",42,0)
 .. S Z0=$S($D(IBP(ZX)):$O(IBP(ZX,0)),1:$O(IBP1(ZX,0)))
"RTN","IBCEF22",43,0)
 .. S:'Z0 Z0=999
"RTN","IBCEF22",44,0)
 .. Q:'$D(IBP(ZX,+Z0,$P(IBZ,U,11)))&'$D(IBP1(ZX,+Z0,$P(IBZ,U,11)))
"RTN","IBCEF22",45,0)
 .. I '$D(IBP1(ZX,+Z0,$P(IBZ,U,11))) S IBP1(ZX,+Z0,$P(IBZ,U,11))=IBP(ZX,+Z0,$P(IBZ,U,11)) K IBP(ZX,+Z0,$P(IBZ,U,11))
"RTN","IBCEF22",46,0)
 .. S IBX1=$P(Z,U,2),IBPO=+Z0,IBMOD=$P(ZX,U,2)
"RTN","IBCEF22",47,0)
 . ; Manually added charge with a procedure
"RTN","IBCEF22",48,0)
 . I $P(IBZ,U,6),$S($P(IBZ,U,10)=4:'$P(IBZ,U,11),1:1),+$O(IBP($P(IBZ,U,6)))=$P(IBZ,U,6) D
"RTN","IBCEF22",49,0)
 .. ; No direct link, but a proc exists on rev code and in procedure mult without and then with modifiers
"RTN","IBCEF22",50,0)
 .. S ZX=$O(IBP($P(IBZ,U,6)))
"RTN","IBCEF22",51,0)
 .. F QQ=1,2 Q:IBPO  S Z="" F  S Z=$O(IBP(ZX,Z),-1) Q:'Z!(IBPO)  S Z0=0 F  S Z0=$O(IBP(ZX,Z,Z0)) Q:'Z0  S Z1=$G(^DGCR(399,IBIFN,"CP",Z0,0)) D  Q:IBPO
"RTN","IBCEF22",52,0)
 ... ; Ignore if not a CPT or a modifier exists and this is first pass
"RTN","IBCEF22",53,0)
 ... S IBMOD=$$GETMOD^IBEFUNC(IBIFN,Z0,1)
"RTN","IBCEF22",54,0)
 ... Q:$S($P(Z1,U)'["ICPT":1,QQ=1:IBMOD'="",1:0)
"RTN","IBCEF22",55,0)
 ... S IBPO=+$P(Z1,U,4),IBX1=$P(Z1,U,2)
"RTN","IBCEF22",56,0)
 ... K IBP(+Z1_U_IBMOD,Z,Z0)
"RTN","IBCEF22",57,0)
 . ;
"RTN","IBCEF22",58,0)
 . I IBX'="" D  ; revenue code is valid
"RTN","IBCEF22",59,0)
 .. F Z=900:1 S Z0=$S(IBPO:IBPO,$D(IBX(" "_$P(IBX,U),Z)):0,1:Z) I Z0 S IBPO=Z0 Q
"RTN","IBCEF22",60,0)
 .. S IBX(" "_$P(IBX,U),IBPO,IBDA)=IBX,IBX(" "_$P(IBX,U),IBPO,IBDA,"DT")=$S(IBX1:IBX1,1:IBDEF),IBX(" "_$P(IBX,U),IBPO,IBDA,"MOD")=IBMOD
"RTN","IBCEF22",61,0)
 ;
"RTN","IBCEF22",62,0)
 S IBS="" F  S IBS=$O(IBX(IBS)) Q:IBS=""  S IBPO=0 F  S IBPO=$O(IBX(IBS,IBPO)) Q:'IBPO  D
"RTN","IBCEF22",63,0)
 . S IBDA=0 F  S IBDA=$O(IBX(IBS,IBPO,IBDA)) Q:'IBDA  S IBX=$G(IBX(IBS,IBPO,IBDA)),IBZ=$G(^DGCR(399,IBIFN,"RC",IBDA,0)) I IBX'="" D
"RTN","IBCEF22",64,0)
 .. ;S IBXS=$P(IBZ,U,2)_U_$P(IBZ,U,6)_U_$G(IBX(IBS,IBPO,IBDA,"MOD"))
"RTN","IBCEF22",65,0)
 .. S IBXS=U_$P(IBZ,U,6)_U_$G(IBX(IBS,IBPO,IBDA,"MOD")) ;combine same proc and modifiers regardless of rate
"RTN","IBCEF22",66,0)
 .. S:IBPO'<900&'$$ACCRV($P(IBS," ",2))&$S(IBINPAT:$P(IBZ,U,6),1:1) IBCOMB(IBS,IBXS,IBPO)=IBDA
"RTN","IBCEF22",67,0)
 .. S:'$D(IBX1(IBS,IBPO,IBXS,1)) IBX1(IBS,IBPO,IBXS,1)=IBX,IBX1(IBS,IBPO,IBXS,2)=IBZ
"RTN","IBCEF22",68,0)
 .. S $P(IBX1(IBS,IBPO,IBXS),U)=$P($G(IBX1(IBS,IBPO,IBXS)),U)+$P(IBZ,U,3)
"RTN","IBCEF22",69,0)
 .. S $P(IBX1(IBS,IBPO,IBXS),U,2)=$P($G(IBX1(IBS,IBPO,IBXS)),U,2)+$P(IBZ,U,4)
"RTN","IBCEF22",70,0)
 .. S IBX1(IBS,IBPO,IBXS,"DT")=$G(IBX(IBS,IBPO,IBDA,"DT")),IBX1(IBS,IBPO,IBXS,"IEN")=$G(IBX1(IBS,IBPO,IBXS,"IEN"))_$S($G(IBX1(IBS,IBPO,IBXS,"IEN")):";",1:"")_IBDA
"RTN","IBCEF22",71,0)
 ;
"RTN","IBCEF22",72,0)
 S IBS="" F  S IBS=$O(IBX1(IBS)) Q:IBS=""  S IBPO=899 F  S IBPO=$O(IBX1(IBS,IBPO)) Q:'IBPO  D  ; Check to combine like rev codes without print order
"RTN","IBCEF22",73,0)
 . N Q,Q0,Q1,Z,Z0,Z1,Z2,IBZ1,IBZ2
"RTN","IBCEF22",74,0)
 . S Z=""
"RTN","IBCEF22",75,0)
 . N IBACC
"RTN","IBCEF22",76,0)
 . F  S Z=$O(IBX1(IBS,IBPO,Z)) Q:Z=""  S Q=IBPO F  S Q=$O(IBCOMB(IBS,Z,Q)) Q:'Q  I Q'=IBPO S IBZ1=$G(IBX1(IBS,IBPO,Z,1)),IBZ2=$G(IBX1(IBS,IBPO,Z,2)) D
"RTN","IBCEF22",77,0)
 .. Q:$G(IBX1(IBS,IBPO,Z,1))'=$G(IBX1(IBS,Q,Z,1))
"RTN","IBCEF22",78,0)
 .. S Q1=1,IBACC=$$ACCRV(+$P(IBS," ",2))
"RTN","IBCEF22",79,0)
 .. F Q0=1,5:1:7,10:1:13,15 D  Q:'Q1
"RTN","IBCEF22",80,0)
 ... I IBACC Q:Q0=5!(Q0>6)
"RTN","IBCEF22",81,0)
 ... I (Q0=11!(Q0=15))&($P($G(IBX1(IBS,Q,Z,2)),U,10)=3) Q
"RTN","IBCEF22",82,0)
 ... I Q0=5,'IBINPAT Q
"RTN","IBCEF22",83,0)
 ... I $P($G(IBX1(IBS,IBPO,Z,2)),U,Q0)'=$P($G(IBX1(IBS,Q,Z,2)),U,Q0) S Q1=0
"RTN","IBCEF22",84,0)
 .. Q:'Q1
"RTN","IBCEF22",85,0)
 .. S $P(IBX1(IBS,IBPO,Z,2),U,3)=$P(IBX1(IBS,IBPO,Z,2),U,3)+$P(IBX1(IBS,Q,Z,2),U,3)
"RTN","IBCEF22",86,0)
 .. S $P(IBX1(IBS,IBPO,Z,2),U,4)=$P(IBX1(IBS,IBPO,Z,2),U,4)+$P(IBX1(IBS,Q,Z,2),U,4)
"RTN","IBCEF22",87,0)
 .. S $P(IBX1(IBS,IBPO,Z,2),U,9)=$P(IBX1(IBS,IBPO,Z,2),U,9)+$P(IBX1(IBS,Q,Z,2),U,9)
"RTN","IBCEF22",88,0)
 .. S IBX1(IBS,IBPO,Z)=$P(IBX1(IBS,IBPO,Z,2),U,3)_U_$P(IBX1(IBS,IBPO,Z,2),U,4)
"RTN","IBCEF22",89,0)
 .. S IBX1(IBS,IBPO,Z,"IEN")=IBX1(IBS,IBPO,Z,"IEN")_";"_IBX1(IBS,Q,Z,"IEN")
"RTN","IBCEF22",90,0)
 .. K IBX1(IBS,Q,Z)
"RTN","IBCEF22",91,0)
 ;
"RTN","IBCEF22",92,0)
 S IBS="",IBLN=0
"RTN","IBCEF22",93,0)
 F  S IBS=$O(IBX1(IBS)) Q:IBS=""  S IBPO=0 F  S IBPO=$O(IBX1(IBS,IBPO)) Q:'IBPO  S IBSS="" F  S IBSS=$O(IBX1(IBS,IBPO,IBSS)) Q:IBSS=""  D
"RTN","IBCEF22",94,0)
 . S IBX=$G(IBX1(IBS,IBPO,IBSS,1)),IBZ=$G(IBX1(IBS,IBPO,IBSS,2))
"RTN","IBCEF22",95,0)
 . S IBLN=$G(IBLN)+1,IBXDATA(IBLN)=$P(IBX,U)_U_$P(IBZ,U,6)_U_$P(IBZ,U,2)_U_+IBX1(IBS,IBPO,IBSS)_U_+$P(IBX1(IBS,IBPO,IBSS),U,2),$P(IBXDATA(IBLN),U,10)=$G(IBX1(IBS,IBPO,IBSS,"DT"))
"RTN","IBCEF22",96,0)
 . S $P(IBXDATA(IBLN),U,6)=$P(IBZ,U,9),$P(IBXDATA(IBLN),U,7)=$P(IBZ,U,13),$P(IBXDATA(IBLN),U,8)=$G(IBX1(IBS,IBPO,IBSS,"IEN")),$P(IBXDATA(IBLN),U,9)=$P($P(IBSS,U,3),",",1,2)
"RTN","IBCEF22",97,0)
 . ; Extract line lev COB data for sec or tert bill
"RTN","IBCEF22",98,0)
 . I $$COBN^IBCEF(IBIFN)>1 D COBLINE^IBCEU6(IBIFN,IBLN,.IBXDATA,,.IBXTRA) I $D(IBXTRA) D COMBO^IBCEU2(.IBXDATA,.IBXTRA,1) ;Handle bundled/unbundled
"RTN","IBCEF22",99,0)
 I $D(^IBA(362.4,"AIFN"_IBIFN))!$D(^IBA(362.5,"AIFN"_IBIFN)) D
"RTN","IBCEF22",100,0)
 . N IBARRAY,IBX,IBZ,IBRX,IBLCNT
"RTN","IBCEF22",101,0)
 . S IBLCNT=0
"RTN","IBCEF22",102,0)
 . ; Print prescriptions, prosthetics on front of UB-92
"RTN","IBCEF22",103,0)
 . D SET^IBCSC5A(IBIFN,.IBARRAY)
"RTN","IBCEF22",104,0)
 . I $P(IBARRAY,U,2) D
"RTN","IBCEF22",105,0)
 .. S IBX=+$P(IBARRAY,U,2)+2
"RTN","IBCEF22",106,0)
 .. S IBLCNT=IBLCNT+1,IBXSAVE("RX-UB92",IBLCNT)=""
"RTN","IBCEF22",107,0)
 .. S IBLCNT=IBLCNT+1,IBXSAVE("RX-UB92",IBLCNT)="PRESCRIPTION REFILLS:",IBLCNT=2
"RTN","IBCEF22",108,0)
 .. S IBX=0 F  S IBX=$O(IBARRAY(IBX)) Q:IBX=""  S IBY=0 F  S IBY=$O(IBARRAY(IBX,IBY)) Q:'IBY  S IBRX=IBARRAY(IBX,IBY) D
"RTN","IBCEF22",109,0)
 ... D ZERO^IBRXUTL(+$P(IBRX,U,2))
"RTN","IBCEF22",110,0)
 ... S IBLCNT=IBLCNT+1,IBXSAVE("RX-UB92",IBLCNT)=IBX_$J(" ",(11-$L(IBX)))_" "_$J($S($P(IBRX,U,6):"$"_$FN($P(IBRX,U,6),",",2),1:""),10)_"  "_$J($$FMTE^XLFDT(IBY,2),8)_"  "_$G(^TMP($J,"IBDRUG",+$P(IBRX,U,2),.01))
"RTN","IBCEF22",111,0)
 ... S IBZ=$S(+$P(IBRX,U,4):"QTY: "_$P(IBRX,U,4)_" ",1:"")_$S(+$P(IBRX,U,3):"for "_$P(IBRX,U,3)_" days supply ",1:"") I IBZ'="" S IBLCNT=IBLCNT+1,IBXSAVE("RX-UB92",IBLCNT)=$J(" ",35)_IBZ
"RTN","IBCEF22",112,0)
 ... S IBZ=$S($P(IBRX,U,5)'="":"NDC #: "_$P(IBRX,U,5),1:"") I IBZ'="" S IBLCNT=IBLCNT+1,IBXSAVE("RX-UB92",IBLCNT)=$J(" ",35)_IBZ
"RTN","IBCEF22",113,0)
 ... K ^TMP($J,"IBDRUG")
"RTN","IBCEF22",114,0)
 ... Q
"RTN","IBCEF22",115,0)
 . ;
"RTN","IBCEF22",116,0)
 . D SET^IBCSC5B(IBIFN,.IBARRAY)
"RTN","IBCEF22",117,0)
 . I $P(IBARRAY,U,2) D
"RTN","IBCEF22",118,0)
 .. S IBLCNT=0
"RTN","IBCEF22",119,0)
 .. S IBX=+$P(IBARRAY,U,2)+2
"RTN","IBCEF22",120,0)
 .. S IBLCNT=IBLCNT+1,IBXSAVE("PROS-UB92",IBLCNT)=""
"RTN","IBCEF22",121,0)
 .. S IBLCNT=IBLCNT+1,IBXSAVE("PROS-UB92",IBLCNT)="PROSTHETIC REFILLS:",IBLCNT=2
"RTN","IBCEF22",122,0)
 .. S IBX=0 F  S IBX=$O(IBARRAY(IBX)) Q:IBX=""  S IBY=0 F  S IBY=$O(IBARRAY(IBX,IBY)) Q:'IBY  D
"RTN","IBCEF22",123,0)
 ... S IBLCNT=IBLCNT+1,IBXSAVE("PROS-UB92",IBLCNT)=$$FMTE^XLFDT(IBX,2)_" "_$J($S($P(IBARRAY(IBX,IBY),U,2):"$"_$FN($P(IBARRAY(IBX,IBY),U,2),",",2),1:""),10)_"  "_$E($P($$PIN^IBCSC5B(IBY),U,2),1,54)
"RTN","IBCEF22",124,0)
 Q
"RTN","IBCEF22",125,0)
 ;
"RTN","IBCEF22",126,0)
ACCRV(X) ; Returns 1 if X is an accomodation RC, 0 if not
"RTN","IBCEF22",127,0)
 Q ((X'<100&(X'>219))!(X=224))
"RTN","IBCEF22",128,0)
 ;
"RTN","IBCF331")
0^6^B6717938
"RTN","IBCF331",1,0)
IBCF331 ;ALB/ARH - UB92 HCFA-1450 (GATHER CODES CONT) ;25-AUG-1993
"RTN","IBCF331",2,0)
 ;;2.0;INTEGRATED BILLING;**52,210,309**; 21-MAR-94
"RTN","IBCF331",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCF331",4,0)
 ;
"RTN","IBCF331",5,0)
 ;
"RTN","IBCF331",6,0)
DX ;additional dx codes (ie more than 9 on bill)
"RTN","IBCF331",7,0)
 D SET^IBCSC4D(IBIFN,"",.IBARRAY) G:$P(IBARRAY,U,2)'>9 RX
"RTN","IBCF331",8,0)
 S IBX=+$P(IBARRAY,U,2)-9+2 D SPACE
"RTN","IBCF331",9,0)
 S IBZ="" D SET2
"RTN","IBCF331",10,0)
 S IBZ="ADDITIONAL DIAGNOSIS CODES:" D SET2
"RTN","IBCF331",11,0)
 S IBX=0 F IBI=1:1 S IBX=$O(IBARRAY(IBX)) Q:IBX=""  I IBI>9 D
"RTN","IBCF331",12,0)
 . S IBY=$$ICD9^IBACSV(+$G(IBARRAY(IBX)),$$BDATE^IBACSV(+IBIFN)) Q:IBY=""
"RTN","IBCF331",13,0)
 . S IBZ=$P(IBY,U)_$J(" ",(10-$L($P(IBY,U))))_$P(IBY,U,3) D SET2
"RTN","IBCF331",14,0)
 ;
"RTN","IBCF331",15,0)
RX ;add rx refills
"RTN","IBCF331",16,0)
 D SET^IBCSC5A(IBIFN,.IBARRAY) G:'$P(IBARRAY,U,2) PD
"RTN","IBCF331",17,0)
 S IBX=+$P(IBARRAY,U,2)+2 D SPACE
"RTN","IBCF331",18,0)
 S IBZ="" D SET2
"RTN","IBCF331",19,0)
 S IBZ="PRESCRIPTION REFILLS:" D SET2
"RTN","IBCF331",20,0)
 S IBX=0 F  S IBX=$O(IBARRAY(IBX)) Q:IBX=""  S IBY=0 F  S IBY=$O(IBARRAY(IBX,IBY)) Q:'IBY  S IBLN=IBARRAY(IBX,IBY) D
"RTN","IBCF331",21,0)
 . D ZERO^IBRXUTL(+$P(IBLN,U,2))
"RTN","IBCF331",22,0)
 . S IBZ=IBX_$J(" ",(11-$L(IBX)))_" "_$J($S($P(IBLN,U,6):"$"_$FN($P(IBLN,U,6),",",2),1:""),10)_"  "_$J($$FMTE^XLFDT(IBY,2),8)_"  "_$G(^TMP($J,"IBDRUG",+$P(IBLN,U,2),.01)) D SET2
"RTN","IBCF331",23,0)
 . S IBZ="",IBZ=$S(+$P(IBLN,U,4):"QTY: "_$P(IBLN,U,4)_" ",1:"")_$S(+$P(IBLN,U,3):"for "_$P(IBLN,U,3)_" days supply ",1:"") I IBZ'="" S IBZ=$J(" ",35)_IBZ D SET2
"RTN","IBCF331",24,0)
 . S IBZ="",IBZ=$S($P(IBLN,U,5)'="":"NDC #: "_$P(IBLN,U,5),1:"") I IBZ'="" S IBZ=$J(" ",35)_IBZ D SET2
"RTN","IBCF331",25,0)
 . K ^TMP($J,"IBDRUG")
"RTN","IBCF331",26,0)
 . Q
"RTN","IBCF331",27,0)
 ;
"RTN","IBCF331",28,0)
PD ;add prosthetic items
"RTN","IBCF331",29,0)
 D SET^IBCSC5B(IBIFN,.IBARRAY) G:'$P(IBARRAY,U,2) END
"RTN","IBCF331",30,0)
 S IBX=+$P(IBARRAY,U,2)+2 D SPACE
"RTN","IBCF331",31,0)
 S IBZ="" D SET2
"RTN","IBCF331",32,0)
 S IBZ="PROSTHETIC ITEMS:" D SET2
"RTN","IBCF331",33,0)
 S IBX=0 F  S IBX=$O(IBARRAY(IBX)) Q:IBX=""  S IBY=0 F  S IBY=$O(IBARRAY(IBX,IBY)) Q:'IBY  D
"RTN","IBCF331",34,0)
 . S IBZ=$$FMTE^XLFDT(IBX,2)_" "_$J($S($P(IBARRAY(IBX,IBY),U,2):"$"_$FN($P(IBARRAY(IBX,IBY),U,2),",",2),1:""),10)_"  "_$E($P($$PIN^IBCSC5B(IBY),U,2),1,54) D SET2
"RTN","IBCF331",35,0)
 ;
"RTN","IBCF331",36,0)
END Q
"RTN","IBCF331",37,0)
 ;
"RTN","IBCF331",38,0)
SET2 D SET2^IBCF33 Q
"RTN","IBCF331",39,0)
SPACE D SPACE^IBCF33 Q
"RTN","IBCF4")
0^7^B19230544
"RTN","IBCF4",1,0)
IBCF4 ;ALB/ARH - PRINT BILL ADDENDUM ;12-JAN-94
"RTN","IBCF4",2,0)
 ;;2.0;INTEGRATED BILLING;**52,137,199,309**;21-MAR-94
"RTN","IBCF4",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCF4",4,0)
 ;
"RTN","IBCF4",5,0)
PRXA ;get bill number then print rx refill addendums for bills
"RTN","IBCF4",6,0)
 S DIC("S")="I $D(^IBA(362.4,""AIFN""_+Y))!($D(^IBA(362.5,""AIFN""_+Y)))"
"RTN","IBCF4",7,0)
 N DPTNOFZY S DPTNOFZY=1  ;Suppress PATIENT file fuzzy lookups
"RTN","IBCF4",8,0)
 S DIC="^DGCR(399,",DIC(0)="AEMQ" D ^DIC K DIC G:+Y'>0 EXIT S IBBILL=$P(Y,U,2),IBIFN=+Y
"RTN","IBCF4",9,0)
 ;
"RTN","IBCF4",10,0)
 I $D(^IBA(364,"ABDT",IBIFN)),+$$TXMT^IBCEF4(IBIFN)=1 D  G:'IBTXOK PRXA
"RTN","IBCF4",11,0)
 .S IBTXOK=0
"RTN","IBCF4",12,0)
 .N IBLDT,IBX
"RTN","IBCF4",13,0)
 .S IBLDT=$O(^IBA(364,"ABDT",IBIFN,""),-1),IBX=$O(^IBA(364,"B",IBIFN,+IBLDT,""),-1)
"RTN","IBCF4",14,0)
 .I "X"[$P($G(^IBA(364,+IBX,0)),U,3) W !!,*7,"Transmittable Bill can NOT be printed until transmitted" Q
"RTN","IBCF4",15,0)
 .W !!,"This is a Transmittable Bill that has already been transmitted"
"RTN","IBCF4",16,0)
 .W !!,"WANT TO PRINT THIS BILL ADDENDUM ANYWAY" S %=2 D YN^DICN
"RTN","IBCF4",17,0)
 .Q:'(%+1#3)  ;-1 or 2
"RTN","IBCF4",18,0)
 .S IBTXOK=1
"RTN","IBCF4",19,0)
 ;
"RTN","IBCF4",20,0)
DEV ;get the device
"RTN","IBCF4",21,0)
 W !!,"Report requires 132 columns."
"RTN","IBCF4",22,0)
 S %ZIS="QM",%ZIS("A")="OUTPUT DEVICE: " D ^%ZIS G:POP EXIT
"RTN","IBCF4",23,0)
 I $D(IO("Q")) S ZTRTN="EN^IBCF4",ZTDESC="BILL ADDENDUM FOR "_IBBILL,ZTSAVE("IB*")="" D ^%ZTLOAD K IO("Q"),ZTSK G EXIT
"RTN","IBCF4",24,0)
 U IO D EN
"RTN","IBCF4",25,0)
 ;
"RTN","IBCF4",26,0)
EXIT ;clean up and quit
"RTN","IBCF4",27,0)
 I $D(ZTQUEUED) S ZTREQ="@" Q
"RTN","IBCF4",28,0)
 K IBQUIT,IBIFN,IBBILL,IBTXOK,X,Y,DTOUT,DUOUT,DIRUT,DIROUT D ^%ZISC
"RTN","IBCF4",29,0)
 Q
"RTN","IBCF4",30,0)
 ;
"RTN","IBCF4",31,0)
EN ;ENTRY POINT IF QUEUED, print all rx refills for a bill
"RTN","IBCF4",32,0)
 S IBY=$G(^DGCR(399,+IBIFN,0)) Q:IBY=""  S IBXREF="AIFN"_IBIFN
"RTN","IBCF4",33,0)
 S (IBQUIT,IBPGN,IBRX)=0,IBHDR="BILL ADDENDUM FOR "_$P($G(^DPT(+$P(IBY,U,2),0)),U,1)_" - "_$P(IBY,U,1) D HDR
"RTN","IBCF4",34,0)
RX I '$D(^IBA(362.4,IBXREF)) G PROS
"RTN","IBCF4",35,0)
 W !!,"PRESCRIPTION REFILLS:",!
"RTN","IBCF4",36,0)
 K IBRC
"RTN","IBCF4",37,0)
 D RCITEM^IBCSC5A(IBIFN,"IBRC",3)
"RTN","IBCF4",38,0)
 S IBRX=0 F  S IBRX=$O(^IBA(362.4,IBXREF,IBRX)) Q:IBRX=""!IBQUIT  S IBRIFN=0 F  S IBRIFN=$O(^IBA(362.4,IBXREF,IBRX,IBRIFN)) Q:'IBRIFN!IBQUIT  D
"RTN","IBCF4",39,0)
 .S IBY=$G(^IBA(362.4,IBRIFN,0)) Q:IBY=""
"RTN","IBCF4",40,0)
 .S IBYC=$$CHG(IBRIFN,3,.IBRC)
"RTN","IBCF4",41,0)
 .;
"RTN","IBCF4",42,0)
 . D ZERO^IBRXUTL(+$P(IBY,U,4))
"RTN","IBCF4",43,0)
 . W !,$P(IBY,U,1),?13,$$FMTE^XLFDT(+$P(IBY,U,3),2),?22,$J($S(IBYC:"$"_$FN(IBYC,",",2),1:""),10),?34,$G(^TMP($J,"IBDRUG",+$P(IBY,U,4),.01))
"RTN","IBCF4",44,0)
 . K ^TMP($J,"IBDRUG")
"RTN","IBCF4",45,0)
 . I $P(IBY,U,6)'="" W ?77,"QTY: ",$P(IBY,U,7)
"RTN","IBCF4",46,0)
 . I $P(IBY,U,7)'="" W ?87,"DAYS SUPPLY: ",$P(IBY,U,6)
"RTN","IBCF4",47,0)
 . I $P(IBY,U,8)'="" W ?105,"NDC #: ",$P(IBY,U,8)
"RTN","IBCF4",48,0)
 . S IBLN=IBLN+1 I IBLN>(IOSL-7) D PAUSE,HDR
"RTN","IBCF4",49,0)
 K IBRC
"RTN","IBCF4",50,0)
 ;
"RTN","IBCF4",51,0)
PROS I '$D(^IBA(362.5,IBXREF)) G END
"RTN","IBCF4",52,0)
 W !!!,"PROSTHETIC ITEMS:",!
"RTN","IBCF4",53,0)
 K IBRC
"RTN","IBCF4",54,0)
 D RCITEM^IBCSC5A(IBIFN,"IBRC",5)
"RTN","IBCF4",55,0)
 S IBPI=0 F  S IBPI=$O(^IBA(362.5,IBXREF,IBPI)) Q:IBPI=""!IBQUIT  S IBPIFN=0 F  S IBPIFN=$O(^IBA(362.5,IBXREF,IBPI,IBPIFN)) Q:'IBPIFN!IBQUIT  D
"RTN","IBCF4",56,0)
 . S IBY=$G(^IBA(362.5,IBPIFN,0)),IBYC="" Q:IBY=""
"RTN","IBCF4",57,0)
 . S IBYC=$$CHG(IBPIFN,5,.IBRC)
"RTN","IBCF4",58,0)
 . W !,$$FMTE^XLFDT(+$P(IBY,U,1),2),?11,$J($S(IBYC:"$"_$FN(IBYC,",",2),1:""),10),?24,$P($$PIN^IBCSC5B(+$P(IBY,U,3)),U,2)
"RTN","IBCF4",59,0)
 . S IBLN=IBLN+1 I IBLN>(IOSL-7) D PAUSE,HDR
"RTN","IBCF4",60,0)
 D:'IBQUIT PAUSE
"RTN","IBCF4",61,0)
END K IBX,IBY,IBPGN,IBRX,IBHDR,IBRIFN,IBLN,IBCDT,IBI,IBXREF,IBPI,IBPIFN,IBRC,IBYC
"RTN","IBCF4",62,0)
 Q
"RTN","IBCF4",63,0)
 ;
"RTN","IBCF4",64,0)
CHG(IBY,IBTYP,IBRC) ; Return charge for item entry IBY or null if no charge
"RTN","IBCF4",65,0)
 ; IBRC = the array containing the revenue code items and their units and charges
"RTN","IBCF4",66,0)
 ; IBTYP = the type of item being priced
"RTN","IBCF4",67,0)
 N IBZ,IBYC
"RTN","IBCF4",68,0)
 S IBRC=$S($D(IBRC(IBTYP,IBY)):IBY,1:0),IBYC=""
"RTN","IBCF4",69,0)
 F IBRC=IBRC,0 Q:'$D(IBRC(IBTYP,IBRC))  S IBZ="" D  Q:IBZ'=""!(IBRC=0)
"RTN","IBCF4",70,0)
 .F  S IBZ=$O(IBRC(IBTYP,IBRC,IBZ)) Q:IBZ=""  I IBRC(IBTYP,IBRC,IBZ) S $P(IBRC(IBTYP,IBRC,IBZ),U)=IBRC(IBTYP,IBRC,IBZ)-1,IBYC=$P(IBRC(IBTYP,IBRC,IBZ),U,2) K:'IBRC(IBTYP,IBRC,IBZ) IBRC(IBTYP,IBRC,IBZ) Q
"RTN","IBCF4",71,0)
 Q IBYC
"RTN","IBCF4",72,0)
 ;
"RTN","IBCF4",73,0)
HDR ;print the report header
"RTN","IBCF4",74,0)
 S IBQUIT=$$STOP Q:IBQUIT  S IBPGN=IBPGN+1,IBLN=5
"RTN","IBCF4",75,0)
 D NOW^%DTC S Y=$E(%,1,12) D DD^%DT S IBCDT=$P(Y,"@",1)_"  "_$P(Y,"@",2)
"RTN","IBCF4",76,0)
 I IBPGN>1!($E(IOST,1,2)["C-") W @IOF
"RTN","IBCF4",77,0)
 W IBHDR W:IOM<85 ! W ?(IOM-30),IBCDT,?(IOM-8),"PAGE ",IBPGN,!
"RTN","IBCF4",78,0)
 ;W !,"RX #",?13,"REFILL DATE",?28,"DRUG",?70,"DAYS SUPPLY",?83,"QTY",?90,"NDC #",!
"RTN","IBCF4",79,0)
 F IBI=1:1:IOM W "-"
"RTN","IBCF4",80,0)
 W !
"RTN","IBCF4",81,0)
 Q
"RTN","IBCF4",82,0)
 ;
"RTN","IBCF4",83,0)
PAUSE ;pause at end of screen if being displayed on a terminal
"RTN","IBCF4",84,0)
 Q:$E(IOST,1,2)'["C-"
"RTN","IBCF4",85,0)
 S DIR(0)="E" D ^DIR K DIR
"RTN","IBCF4",86,0)
 I $D(DUOUT)!($D(DIRUT)) S IBQUIT=1
"RTN","IBCF4",87,0)
 Q
"RTN","IBCF4",88,0)
 ;
"RTN","IBCF4",89,0)
STOP() ;determine if user has requested the queued report to stop
"RTN","IBCF4",90,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S ZTSTOP=1 K ZTREQ I +$G(IBPGN) W !,"***TASK STOPPED BY USER***"
"RTN","IBCF4",91,0)
 Q +$G(ZTSTOP)
"RTN","IBCF4",92,0)
 ;
"RTN","IBCF4",93,0)
RXDISP ;displays all rx refills bills
"RTN","IBCF4",94,0)
 ;N IBX,IBY,IBZ,IBC,X,Y S Y=1,IBC=0,IBX="AIFN"
"RTN","IBCF4",95,0)
 ;F  S IBX=$O(^IBA(362.4,IBX)) Q:IBX=""  S IBY=$E(IBX,5,999),IBZ=$G(^DGCR(399,+IBY,0)) I IBZ'="" D  Q:'Y
"RTN","IBCF4",96,0)
 ;. W !,$P(IBZ,U,1),?10,$E($P($G(^DPT(+$P(IBZ,U,2),0)),U,1),1,20),?32,$$DATE(+$P(IBZ,U,3)),?42,$S(+$P(IBZ,U,5)<3:"INPT",1:"OUTPT")
"RTN","IBCF4",97,0)
 ;. W ?49,$P($G(^DGCR(399.3,+$P(IBZ,U,7),0)),U,4),?59,$E($$EXSET^IBEFUNC(+$P(IBZ,U,13),399,.13),1,7),?68,$E($P($G(^IBE(353,+$P(IBZ,U,19),0)),U,1),1,11)
"RTN","IBCF4",98,0)
 ;. S IBC=IBC+1 I '(IBC#10) S DIR(0)="E" D ^DIR K DIR
"RTN","IBCF4",99,0)
 ;Q
"RTN","IBCF4",100,0)
 ;
"RTN","IBCF4",101,0)
DATE(X) Q $E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3)
"RTN","IBCF4",102,0)
 ;
"RTN","IBCF4",103,0)
BILLAD(IFN) ;returns true if bill has either rx refills or prosthetics so addendum should print
"RTN","IBCF4",104,0)
 N IBX S IBX=0,IFN=+$G(IFN) S:+$O(^IBA(362.4,"AIFN"_IFN,0)) IBX=1 S:+$O(^IBA(362.5,"AIFN"_IFN,0)) IBX=IBX+2
"RTN","IBCF4",105,0)
 Q IBX
"RTN","IBCRCC")
0^8^B18876800
"RTN","IBCRCC",1,0)
IBCRCC ;ALB/ARH - RATES: CALCULATION OF ITEM CHARGE ;22-MAY-1996
"RTN","IBCRCC",2,0)
 ;;2.0;INTEGRATED BILLING;**52,80,106,138,245,223,309**;21-MAR-94
"RTN","IBCRCC",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCRCC",4,0)
 ;
"RTN","IBCRCC",5,0)
 ; ITMCHG and RATECHG are basic item/set/rate charge functions, IBCRCI contains more standard callable functions
"RTN","IBCRCC",6,0)
 ;
"RTN","IBCRCC",7,0)
ITMCHG(CS,ITEM,EVDT,MOD,ARR) ; get the base unit charges for a specific item, given a charge set, item and date
"RTN","IBCRCC",8,0)
 ; this is the primary function to get an item charge and works for all Charge Methods, given an Item
"RTN","IBCRCC",9,0)
 ; returns ARR = count of items in array ^ total charge for item ^ total base charge
"RTN","IBCRCC",10,0)
 ;         ARR(x) = charge item IFN (if any) ^ rev code (if any) ^ $ charge ^ $ base charge
"RTN","IBCRCC",11,0)
 ; checks Item effective and inactive dates, modifier match, and only sets array if the charge is non-zero
"RTN","IBCRCC",12,0)
 ; each item will be passed back separately in the array, no combination of charges
"RTN","IBCRCC",13,0)
 ;
"RTN","IBCRCC",14,0)
 N IBCSBR,IBEVDT,IBEFDT,IBXREF,IBITEM,IBDA,IBLN,IBCHRG,IBITMFND K ARR S ARR=0
"RTN","IBCRCC",15,0)
 S CS=+$G(CS),IBEVDT=$S(+$G(EVDT):+EVDT,1:DT),IBITEM=+$G(ITEM),MOD=$G(MOD) I 'CS!'IBITEM Q
"RTN","IBCRCC",16,0)
 S IBCSBR=$$CSBR^IBCRU3(CS)
"RTN","IBCRCC",17,0)
 ;
"RTN","IBCRCC",18,0)
 ; va cost
"RTN","IBCRCC",19,0)
 I $P(IBCSBR,U,5)=2 D  Q  ; va cost
"RTN","IBCRCC",20,0)
 . I $P(IBCSBR,U,1)["PROSTHETICS" S IBCHRG=$$PICOST(IBITEM)  I +IBCHRG D SETARR(0,0,+IBCHRG,.ARR) Q
"RTN","IBCRCC",21,0)
 . I $P(IBCSBR,U,1)["PRESCRIPTION" S IBCHRG=$$RXCOST(IBITEM) I +IBCHRG D SETARR(0,0,+IBCHRG,.ARR) Q
"RTN","IBCRCC",22,0)
 ;
"RTN","IBCRCC",23,0)
 ; all others - have Charge Item entries
"RTN","IBCRCC",24,0)
 ;
"RTN","IBCRCC",25,0)
 ; find most recent Charge Item for the item, search until modifiers match (only BI=CPT should have mods defined)
"RTN","IBCRCC",26,0)
 S IBXREF="AIVDTS"_CS,IBITMFND=0
"RTN","IBCRCC",27,0)
 S IBEFDT=-(IBEVDT+.01) F  S IBEFDT=$O(^IBA(363.2,IBXREF,IBITEM,IBEFDT)) Q:'IBEFDT  D  Q:IBITMFND
"RTN","IBCRCC",28,0)
 . S IBDA=0 F  S IBDA=$O(^IBA(363.2,IBXREF,IBITEM,IBEFDT,IBDA)) Q:'IBDA  D
"RTN","IBCRCC",29,0)
 .. S IBLN=$G(^IBA(363.2,IBDA,0))
"RTN","IBCRCC",30,0)
 .. I +$P(IBLN,U,7)'=+MOD Q  ; charge item modifier does not match modifier passed in
"RTN","IBCRCC",31,0)
 .. S IBITMFND=1 ; item found
"RTN","IBCRCC",32,0)
 .. I +$P(IBLN,U,4),+$P(IBLN,U,4)<IBEVDT Q  ; charge is inactive on event date
"RTN","IBCRCC",33,0)
 .. I +$P(IBLN,U,5) D SETARR(IBDA,+$P(IBLN,U,6),+$P(IBLN,U,5),.ARR,$P(IBLN,U,8))
"RTN","IBCRCC",34,0)
 Q
"RTN","IBCRCC",35,0)
 ;
"RTN","IBCRCC",36,0)
SETARR(CI,RVCD,CHRG,ARR,CHRGB) ; set charges into an array, does not allow zero charge, a new entry is created each time,
"RTN","IBCRCC",37,0)
 ; no attempt to combine like items, the new item charge is added to any that may already be in the array 
"RTN","IBCRCC",38,0)
 ; returns ARR = count of items in array ^ total charge for item
"RTN","IBCRCC",39,0)
 ;         ARR(x) = charge item IFN (if any) ^ item rev code (if any) ^ $ charge
"RTN","IBCRCC",40,0)
 ;
"RTN","IBCRCC",41,0)
 N CNT,TCHRG,TCHRGB
"RTN","IBCRCC",42,0)
 S CNT=+$G(ARR)+1,TCHRG=$P($G(ARR),U,2)+$G(CHRG) I +$G(CHRGB) S TCHRGB=+$P($G(ARR),U,3)+CHRGB
"RTN","IBCRCC",43,0)
 I +$G(CHRG) S ARR=CNT_U_+TCHRG_U_$G(TCHRGB),ARR(CNT)=$G(CI)_U_+$G(RVCD)_U_+CHRG_U_$G(TCHRGB)
"RTN","IBCRCC",44,0)
 Q
"RTN","IBCRCC",45,0)
 ;
"RTN","IBCRCC",46,0)
PICOST(PI) ; returns (PI=ptr 362.5): total VA cost of an item (660,14) ^ quantity (660,5) from prosthetics ^ bill IFN
"RTN","IBCRCC",47,0)
 ;
"RTN","IBCRCC",48,0)
 N IBPIP,IBLN,IBX,IBIFN S (IBPIP,IBX)=0
"RTN","IBCRCC",49,0)
 I +$G(PI) S IBLN=$G(^IBA(362.5,+PI,0)),IBPIP=$P(IBLN,U,4),IBIFN=$P(IBLN,U,2)
"RTN","IBCRCC",50,0)
 I +IBPIP S IBLN=$G(^RMPR(660,+IBPIP,0)) I IBLN'="" S IBX=$P(IBLN,U,16)_U_$P(IBLN,U,7)_U_IBIFN
"RTN","IBCRCC",51,0)
 Q IBX
"RTN","IBCRCC",52,0)
 ;
"RTN","IBCRCC",53,0)
RATECHG(RS,CHG,EVDT,FEE) ; returns modifed item charge based on rate schedule:  check effective dates, apply adjustment
"RTN","IBCRCC",54,0)
 ; adjusted amount ^ comment (if there is an adjustment)
"RTN","IBCRCC",55,0)
 ; if FEE passed by reference, returns disp fee^admin fee
"RTN","IBCRCC",56,0)
 ;
"RTN","IBCRCC",57,0)
 N IBX,IBRS0,IBRS10,IBEFDT,IBINADT,IBRTY,X S IBRTY=""
"RTN","IBCRCC",58,0)
 S IBX=+$G(CHG),IBRS0=$G(^IBE(363,+$G(RS),0)),IBRS10=$G(^IBE(363,+$G(RS),10))
"RTN","IBCRCC",59,0)
 S EVDT=$S(+$G(EVDT):EVDT,1:DT),IBEFDT=$P(IBRS0,U,5),IBINADT=$P(IBRS0,U,6)
"RTN","IBCRCC",60,0)
 I +IBEFDT>EVDT!(+IBINADT&(IBINADT<EVDT)) S IBX=0
"RTN","IBCRCC",61,0)
 I +IBX,IBRS10'="" S X=IBX X IBRS10 S IBX=X,IBRTY="^Rate Schedule Adjustment ("_$J(CHG,"",2)_")"
"RTN","IBCRCC",62,0)
 S FEE=$P($G(^IBE(363,+$G(RS),1)),"^",1,2)
"RTN","IBCRCC",63,0)
 Q IBX_IBRTY
"RTN","IBCRCC",64,0)
 ;
"RTN","IBCRCC",65,0)
RXCOST(RX) ; returns (RX=ptr 362.4): VA Cost of an Rx - Per Unit Cost ^ bill IFN
"RTN","IBCRCC",66,0)
 ; w/ Per Unit Cost = RX (Unit Price of Drug - 52,17) or Drug (Price Per Dispense Unit 50,16) cost
"RTN","IBCRCC",67,0)
 ;
"RTN","IBCRCC",68,0)
 N IBRXP,IBDGP,IBLN,IBX,IBIFN S (IBRXP,IBX)=0
"RTN","IBCRCC",69,0)
 I +$G(RX) S IBLN=$G(^IBA(362.4,+RX,0)),IBRXP=$P(IBLN,U,5),IBDGP=$P(IBLN,U,4),IBIFN=$P(IBLN,U,2)
"RTN","IBCRCC",70,0)
 I +IBRXP S IBLN=$G(^PSRX(+IBRXP,0)) I IBLN'="" S IBX=$P(IBLN,U,17)_U_IBIFN
"RTN","IBCRCC",71,0)
 I 'IBRXP,+IBDGP D DATA^IBRXUTL(+IBDGP) S IBLN=$G(^TMP($J,"IBDRUG",0)) I IBLN'="" S IBX=$G(^TMP($J,"IBDRUG",+IBDGP,16))_U_IBIFN
"RTN","IBCRCC",72,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBCRCC",73,0)
 Q IBX
"RTN","IBCRCC",74,0)
 ;
"RTN","IBCRCC",75,0)
PRVCHG(CS,CHG,PRV,EVDT,ITEM) ; return discounted amount, based on total charge for a the care, the provider and Charge Set (BR)
"RTN","IBCRCC",76,0)
 ; if no discount record found for the Charge Set or the provider then returns original amount
"RTN","IBCRCC",77,0)
 ; no provider discount for Lab charges (80000-89999)
"RTN","IBCRCC",78,0)
 ;   discounted amount ^ comment (if discounted) ^ percent discount
"RTN","IBCRCC",79,0)
 ;
"RTN","IBCRCC",80,0)
 N IBPC,IBSGFN,IBSG,IBPDFN,IBPD0,IBPDTY,IBI,IBX,IBY S IBX=+$G(CHG),(IBSGFN,IBPDTY)="" I '$G(EVDT) S EVDT=DT
"RTN","IBCRCC",81,0)
 I +$G(ITEM),ITEM>79999,ITEM<90000 S (CS,PRV)=""
"RTN","IBCRCC",82,0)
 I +$G(CS) S IBSGFN=+$$CSSG^IBCRU6(+CS,"",2,.IBSG)
"RTN","IBCRCC",83,0)
 I +$G(PRV),+IBSGFN S IBPC=$$GET^XUA4A72(PRV,EVDT)
"RTN","IBCRCC",84,0)
 ;
"RTN","IBCRCC",85,0)
 S IBI=0 F  S IBI=$O(IBSG(IBI)) Q:'IBI  S IBSGFN=+IBSG(IBI) I +IBSGFN D
"RTN","IBCRCC",86,0)
 . S IBPDFN=0 F  S IBPDFN=$O(^IBE(363.34,"C",+IBSGFN,IBPDFN)) Q:'IBPDFN  D  Q:IBPDTY'=""
"RTN","IBCRCC",87,0)
 .. I '$O(^IBE(363.34,+IBPDFN,11,"B",+IBPC,0)) Q
"RTN","IBCRCC",88,0)
 .. S IBPD0=$G(^IBE(363.34,+IBPDFN,0)),IBY=$P(IBPD0,U,3) Q:IBY=""
"RTN","IBCRCC",89,0)
 .. S IBY=+IBY/100,IBX=IBY*IBX
"RTN","IBCRCC",90,0)
 .. S IBPDTY=U_$P($G(^VA(200,+PRV,0)),U,1)_" - "_$P(IBPD0,U,1)_" "_$P(IBPD0,U,3)_"% of "_$J(CHG,0,2)_U_+IBY
"RTN","IBCRCC",91,0)
 Q IBX_IBPDTY
"RTN","IBCRCC",92,0)
 ;
"RTN","IBCRCC",93,0)
HRUNIT(HRS) ; returns Hour Units based on the Hours passed in
"RTN","IBCRCC",94,0)
 ; Hour Units are the hours rounded to the nearest whole hour (less than 30 minutes is 0 units)
"RTN","IBCRCC",95,0)
 N IBX S IBX=0 I +$G(HRS) S IBX=$J(HRS,0,0)
"RTN","IBCRCC",96,0)
 Q IBX
"RTN","IBCRCC",97,0)
 ;
"RTN","IBCRCC",98,0)
MLUNIT(MLS) ; returns Miles Units based on the Miles passed in
"RTN","IBCRCC",99,0)
 ; Mile Units are the miles rounded to the nearest whole mile
"RTN","IBCRCC",100,0)
 N IBX S IBX=0 I +$G(MLS) S IBX=$J(MLS,0,0) I 'IBX S IBX=1
"RTN","IBCRCC",101,0)
 Q IBX
"RTN","IBCRCC",102,0)
 ;
"RTN","IBCRCC",103,0)
MNUNIT(MNS) ; return Minute Units based on the Minutes passed in
"RTN","IBCRCC",104,0)
 ; Minute Units are 15 minute intervals, rounded down for less than 5 minutes
"RTN","IBCRCC",105,0)
 N IBX S IBX=0 I +$G(MNS) S IBX=(MNS\15) S:(MNS#15)>4 IBX=IBX+1 I 'IBX S IBX=1
"RTN","IBCRCC",106,0)
 Q IBX
"RTN","IBCSC5")
0^9^B18022600
"RTN","IBCSC5",1,0)
IBCSC5 ;ALB/MJB - MCCR SCREEN 5 (OPT. EOC) ;27 MAY 88 10:15
"RTN","IBCSC5",2,0)
 ;;2.0;INTEGRATED BILLING;**52,125,51,210,266,288,287,309**;21-MAR-94
"RTN","IBCSC5",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCSC5",4,0)
 ;
"RTN","IBCSC5",5,0)
 ;MAP TO DGCRSC5
"RTN","IBCSC5",6,0)
 ;
"RTN","IBCSC5",7,0)
EN I $$INPAT^IBCEF(IBIFN) G ^IBCSC4
"RTN","IBCSC5",8,0)
 I $D(IBASKCOD) K IBASKCOD D CODMUL^IBCU7 I $$BILLCPT^IBCRU4(IBIFN) D ASK^IBCU7A(IBIFN) S DGRVRCAL=1
"RTN","IBCSC5",9,0)
 I $D(DGRVRCAL) D ^IBCU6 K DGRVRCAL
"RTN","IBCSC5",10,0)
 L ^DGCR(399,IBIFN):1
"RTN","IBCSC5",11,0)
 D ^IBCSCU S IBSR=5,IBSR1="",IBV1="10000000"_$S($$FT^IBCEF(IBIFN)'=2:0,1:1) F I="U",0 S IB(I)=$S($D(^DGCR(399,IBIFN,I)):^(I),1:"") S:IBV IBV1="111111111"
"RTN","IBCSC5",12,0)
 D H^IBCSCU
"RTN","IBCSC5",13,0)
 S IBPTF=$P(IB(0),U,8),IBBT=$P(IB(0),"^",4)_$P(IB(0),"^",5)_$P(IB(0),"^",6)
"RTN","IBCSC5",14,0)
 D EN4^IBCVA1
"RTN","IBCSC5",15,0)
 S Z=1,IBW=1 X IBWW W " Event Date : " S Y=$P(IB(0),U,3) D DT^DIQ
"RTN","IBCSC5",16,0)
 N IBPOARR,IBDATE
"RTN","IBCSC5",17,0)
 D SET^IBCSC4D(IBIFN,"",.IBPOARR)
"RTN","IBCSC5",18,0)
 S IBDATE=$$BDATE^IBACSV(IBIFN) ; Event date
"RTN","IBCSC5",19,0)
 S Z=2,IBW=1 X IBWW W " Prin. Diag.: " S Y=$$DX^IBCSC4(0,IBDATE) W $S(Y'="":$P(Y,U,4)_" - "_$P(Y,U,2),$$DXREQ^IBCSC4(IBIFN):IBU,1:IBUN)
"RTN","IBCSC5",20,0)
 F I=1:1:4 S Y=$$DX^IBCSC4(+Y,IBDATE) Q:Y=""  W !?4,"Other Diag.: ",$P(Y,U,4)_" - "_$P(Y,U,2)
"RTN","IBCSC5",21,0)
 I +Y S Y=$$DX^IBCSC4(+Y,IBDATE) I +Y W !?4,"***There are more diagnoses associated with this bill.***"
"RTN","IBCSC5",22,0)
OP S Z=3,IBW=1 X IBWW W " OP Visits  : " F I=0:0 S I=$O(^DGCR(399,IBIFN,"OP",I)) Q:'I  S Y=I X ^DD("DD") W:$X>67 !?17 W Y_", "
"RTN","IBCSC5",23,0)
 S:$D(^DGCR(399,"OP")) DGOPV=1 I '$O(^DGCR(399,IBIFN,"OP",0)) W IBU
"RTN","IBCSC5",24,0)
 S Z=4,IBW=1 X IBWW W " Cod. Method: ",$S($P(IB(0),U,9)="":IBUN,$P(IB(0),U,9)=9:"ICD-9-CM",$P(IB(0),U,9)=4:"CPT-4",1:"HCPCS")
"RTN","IBCSC5",25,0)
 D WRT:$D(IBPROC)
"RTN","IBCSC5",26,0)
 S Z=5,IBW=1 X IBWW W " Rx. Refills: " S Y=$$RX I 'Y W IBUN
"RTN","IBCSC5",27,0)
OCC G OCC^IBCSC4
"RTN","IBCSC5",28,0)
 W !?4,"Opt. Code  : ",IBUN
"RTN","IBCSC5",29,0)
 G OCC^IBCSC4
"RTN","IBCSC5",30,0)
 Q
"RTN","IBCSC5",31,0)
MORE W !?4,*7,"***There are more procedures associated with this bill.***" S I=0
"RTN","IBCSC5",32,0)
 Q
"RTN","IBCSC5",33,0)
WRT ;  -write out procedures codes on screen
"RTN","IBCSC5",34,0)
 N IBDATE
"RTN","IBCSC5",35,0)
 S J=0 F I=1:1 S J=$O(IBPROC(J)) Q:'J  D  I I>6 D MORE Q
"RTN","IBCSC5",36,0)
 .S IBDATE=$P(IBPROC(J),U,2) I 'IBDATE S IBDATE=$$BDATE^IBACSV($G(IBIFN))
"RTN","IBCSC5",37,0)
 .S X=$$PRCD^IBCEF1($P(IBPROC(J),U),1,IBDATE)
"RTN","IBCSC5",38,0)
 .I IBPROC(J)["ICD" W !?4,"ICD Code   : ",$E($P(X,U,3),1,28)_" - "_$P(X,U,2)
"RTN","IBCSC5",39,0)
 .I IBPROC(J)["CPT" W !?4,"CPT Code   : " D
"RTN","IBCSC5",40,0)
 .. N Z
"RTN","IBCSC5",41,0)
 .. S Z=$P(X,"^",3)_" "_$P(X,"^",2)_$S($P(IBPROC(J),U,15):"-"_$$MODLST^IBEFUNC2($P(IBPROC(J),U,15)),1:"")
"RTN","IBCSC5",42,0)
 .. I $L(Z)>40 S Z=" "_$P(X,"^",2)_$S($P(IBPROC(J),U,15):"-"_$$MODLST^IBEFUNC2($P(IBPROC(J),U,15)),1:""),Z=$E($P(X,U,3),1,40-$L(Z))_Z
"RTN","IBCSC5",43,0)
 .. W Z
"RTN","IBCSC5",44,0)
 .I $P(IB(0),U,19)=2 S Y=+$P(IBPROC(J),U,11) S:+Y Y=+$G(^IBA(362.3,+Y,0)) W ?58,$P($$ICD9^IBACSV(Y,IBDATE),U) S Y=$P(IBPROC(J),U,2) D D^DIQ W ?67,Y Q
"RTN","IBCSC5",45,0)
 .S Y=$P(IBPROC(J),"^",2) D D^DIQ W ?67,Y
"RTN","IBCSC5",46,0)
 Q
"RTN","IBCSC5",47,0)
 ;
"RTN","IBCSC5",48,0)
MOD(IBM,PUNC) ; Returns modifier list from comma delimited ien's in string IBM
"RTN","IBCSC5",49,0)
 ; PUNC = Punctuation to use as first character of output
"RTN","IBCSC5",50,0)
 N IBMOD,Q
"RTN","IBCSC5",51,0)
 S IBMOD=""
"RTN","IBCSC5",52,0)
 F Q=1:1:$L(IBM,",") I $P(IBM,",",Q)'="" S IBMOD=IBMOD_$S(IBMOD'="":",",1:"")_$P($$MOD^ICPTMOD($P(IBM,",",Q),"I"),U,2)
"RTN","IBCSC5",53,0)
 I IBMOD'="" S IBMOD=$G(PUNC)_IBMOD
"RTN","IBCSC5",54,0)
 Q IBMOD
"RTN","IBCSC5",55,0)
 ;
"RTN","IBCSC5",56,0)
PD() ;prints prosthetic device in external form, returns 0 if there are none
"RTN","IBCSC5",57,0)
 N IBX,IBY,IBZ,IBN,X S X=0 S IBX=0 F  S IBX=$O(^IBA(362.5,"AIFN"_IBIFN,IBX)) Q:'IBX  D  Q:X>5
"RTN","IBCSC5",58,0)
 . S IBY=0 F  S IBY=$O(^IBA(362.5,"AIFN"_IBIFN,IBX,IBY)) Q:'IBY  S IBZ=$G(^IBA(362.5,IBY,0)) I IBZ'="" D  Q:X>5
"RTN","IBCSC5",59,0)
 .. S X=X+1 I X>5 W !,?17,"*** There are more Pros. Items associated with this bill.***" Q
"RTN","IBCSC5",60,0)
 .. ;S IBN=$G(^RMPR(661,+$P(IBZ,U,3),0)) W:X'=1 ! W ?17,$E($$PIN^IBCSC5B(+IBN),1,35)," - ",$P(IBN,U,1),?65,$$FMTE^XLFDT(+IBZ)
"RTN","IBCSC5",61,0)
 .. S IBN=$$PIN^IBCSC5B(+$P(IBZ,U,3)) W:X'=1 ! W ?17,$E($P(IBN,U,2),1,35)," - ",$P(IBN,U,1),?65,$$FMTE^XLFDT(+IBZ)
"RTN","IBCSC5",62,0)
 Q X
"RTN","IBCSC5",63,0)
 ;
"RTN","IBCSC5",64,0)
RX() ;prints RX REFILLS in external form, returns 0 if there are none
"RTN","IBCSC5",65,0)
 N IBX,IBY,IBZ,IBN,X S X=0 S IBX="" F  S IBX=$O(^IBA(362.4,"AIFN"_IBIFN,IBX)) Q:IBX=""  D  Q:X>5
"RTN","IBCSC5",66,0)
 . S IBY=0 F  S IBY=$O(^IBA(362.4,"AIFN"_IBIFN,IBX,IBY)) Q:'IBY  S IBZ=$G(^IBA(362.4,IBY,0)) I IBZ'="" D  Q:X>5
"RTN","IBCSC5",67,0)
 .. S X=X+1 I X>5 W !,?17,"*** There are more Rx. Refills associated with this bill.***" Q
"RTN","IBCSC5",68,0)
 ..D ZERO^IBRXUTL(+$P(IBZ,U,4))
"RTN","IBCSC5",69,0)
 .. S IBN=$G(^TMP($J,"IBDRUG",+$P(IBZ,U,4),.01)) W:X'=1 ! W ?17,IBN,?65,$$FMTE^XLFDT(+$P(IBZ,U,3))
"RTN","IBCSC5",70,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBCSC5",71,0)
 Q X
"RTN","IBCSC5",72,0)
 ;
"RTN","IBCSC5",73,0)
 ;IBCSC5
"RTN","IBCSC5A")
0^10^B42043599
"RTN","IBCSC5A",1,0)
IBCSC5A ;ALB/ARH - ADD/ENTER PRESCRIPTION FILLS ; 12/27/93
"RTN","IBCSC5A",2,0)
 ;;2.0;INTEGRATED BILLING;**27,52,106,51,160,137,245,309**;21-MAR-94
"RTN","IBCSC5A",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCSC5A",4,0)
 ;
"RTN","IBCSC5A",5,0)
EN ;add/edit prescription fills for a bill, IBIFN required
"RTN","IBCSC5A",6,0)
 S IBX=$$BILL(IBIFN) Q:'IBIFN  S DFN=+IBX,IBDT1=$P(IBX,U,2),IBDT2=$P(IBX,U,3),IBRXALL=$P(IBX,U,4)
"RTN","IBCSC5A",7,0)
 D SET(IBIFN,.IBRXA,"")
"RTN","IBCSC5A",8,0)
 D RXDISP^IBCSC5C(DFN,IBDT1,IBDT2,.IBPR,.IBPRO,.IBRXA,IBRXALL) I +$P($G(IBPRO),U,2) D NEWRX^IBCSC5C(+IBPRO) I +$G(IBLIST) D ADDNEW^IBCSC5C(IBIFN,IBLIST,.IBPR,.IBPRO) S DGRVRCAL=1
"RTN","IBCSC5A",9,0)
 S IBRXAP=+$G(IBPRO) D SET(IBIFN,.IBRXA,.IBRXAP),DISP(.IBRXA,.IBRXAP)
"RTN","IBCSC5A",10,0)
E1 S IBPIFN=0,IBRX=$$ASKRX(.IBRXAP,.IBPRO) G:IBRX="" EXIT S IBDT=$P(IBRX,U,2),IBRX=$P(IBRX,U,1),DGRVRCAL=1
"RTN","IBCSC5A",11,0)
 I 'IBDT S IBDT=$O(IBRXA(IBRX,0)) S:'IBDT IBDT=$O(IBPR(IBRX,0)) S IBDT=$$ASKDT(IBDT1,IBDT2,IBDT) G:'IBDT E1
"RTN","IBCSC5A",12,0)
 I +$$RXDUP^IBCU3(IBRX,IBDT,IBIFN,1),'$D(IBRXA(IBRX,IBDT)) G E1
"RTN","IBCSC5A",13,0)
 I '$D(IBPR(IBRX,IBDT)) W !,"This rx fill does not exist in Pharmacy for this patient!",!
"RTN","IBCSC5A",14,0)
 S IBPIFN=$G(IBRXA(IBRX,IBDT)),IBDRG=$P(IBPIFN,U,2)
"RTN","IBCSC5A",15,0)
 I 'IBPIFN S IBX=$G(IBPR(IBRX,IBDT)),IBPIFN=$$ADD(IBRX,IBIFN,IBDT,$P(IBX,U,3),$P(IBX,U,1),$P(IBX,U,4,6)) D  G:'IBPIFN E1
"RTN","IBCSC5A",16,0)
 . I 'IBPIFN W " ??" Q
"RTN","IBCSC5A",17,0)
 . W "  ... ADDED"
"RTN","IBCSC5A",18,0)
 D EDIT(+IBPIFN,$P(IBPIFN,U,7)) S IBRXAP=+$G(IBPRO) D SET(IBIFN,.IBRXA,.IBRXAP) G E1
"RTN","IBCSC5A",19,0)
 ;
"RTN","IBCSC5A",20,0)
EXIT ;
"RTN","IBCSC5A",21,0)
 K IBPIFN,IBRX,IBDRG,IBX,IBDT1,IBDT2,IBRXA,IBPR,IBDT,IBLIST,IBPRO,IBRXAP,IBRXALL
"RTN","IBCSC5A",22,0)
 Q
"RTN","IBCSC5A",23,0)
 ;
"RTN","IBCSC5A",24,0)
ASKRX(IBRXAP,IBPRO) ;
"RTN","IBCSC5A",25,0)
 N X,Y,IBY,IBX W ! S IBX=""
"RTN","IBCSC5A",26,0)
 I +$G(IBIFN) S DIR("?")="The prescription number for the fill.  "_$$HTEXT^IBCSC5C,DIR("??")="^D HELP^IBCSC5A("_IBIFN_")"
"RTN","IBCSC5A",27,0)
 S DIR("A")="Select RX FILL",DIR(0)="FO^1:11^K:X'?.UN X" D ^DIR I $D(DIRUT)!(Y'?.AN) S Y="" K DIR,DIRUT G ARX1E
"RTN","IBCSC5A",28,0)
 S IBX=Y I $D(IBRXAP)<10,$D(IBPRO)<10 G ARX1E
"RTN","IBCSC5A",29,0)
 ;
"RTN","IBCSC5A",30,0)
 S IBY=$G(IBRXAP(IBX)) S:IBY="" IBY=$G(IBPRO(IBX)) I IBY="" G ARX1E
"RTN","IBCSC5A",31,0)
 W ! S DIR(0)="YO",DIR("A")="ADD/EDIT RX FILL "_$P(IBY,U,1)_" FOR "_$$FMTE^XLFDT($P(IBY,U,2))_" CORRECT",DIR("B")="YES"
"RTN","IBCSC5A",32,0)
 D ^DIR K DIR I Y=1,'$D(DIRUT) S IBX=IBY
"RTN","IBCSC5A",33,0)
ARX1E Q IBX
"RTN","IBCSC5A",34,0)
 ;
"RTN","IBCSC5A",35,0)
ASKDT(IBDT1,IBDT2,IBDT) ;
"RTN","IBCSC5A",36,0)
 S DIR("A")="Select RX FILL DATE",DIR(0)="DO^"_IBDT1_":"_IBDT2_":EX",DIR("B")=$$FMTE^XLFDT(IBDT) D ^DIR K DIR,DTOUT,DIRUT
"RTN","IBCSC5A",37,0)
 Q $S(Y?7N:Y,1:0)
"RTN","IBCSC5A",38,0)
 ;
"RTN","IBCSC5A",39,0)
ADD(RX,IFN,IBDT,DRUG,PIFN,OTHER) ;
"RTN","IBCSC5A",40,0)
 N IBX,X,Y,DD,DO,DA,DIC,DLAYGO
"RTN","IBCSC5A",41,0)
 S IBX=0 S DRUG=$$DRUG($G(DRUG)) G:'DRUG ADDE
"RTN","IBCSC5A",42,0)
 S DIC="^IBA(362.4,",DIC(0)="AQL",X=RX,DLAYGO=362.4 D FILE^DICN
"RTN","IBCSC5A",43,0)
 I Y>0 D
"RTN","IBCSC5A",44,0)
 . S DIE=DIC,(IBX,DA)=+Y,DR=".02////"_IFN_";.03////"_IBDT_";.04////"_DRUG_";.05////"_+PIFN_";.06////"_$P(OTHER,U,1)_";.07////"_$P(OTHER,U,2)_";.08////"_$P(OTHER,U,3) D ^DIE K DIE,DIC,DA,DR
"RTN","IBCSC5A",45,0)
 . S DGRVRCAL=1
"RTN","IBCSC5A",46,0)
ADDE Q IBX
"RTN","IBCSC5A",47,0)
 ;
"RTN","IBCSC5A",48,0)
EDIT(PIFN,REVIEN) ;
"RTN","IBCSC5A",49,0)
 N IBCHG,DIE,DR,DA,DIC,DIDEL
"RTN","IBCSC5A",50,0)
 S DIDEL=362.4,DIE="^IBA(362.4,"
"RTN","IBCSC5A",51,0)
 S DR=".01;.03;.04;.06;.07;.08;.09"
"RTN","IBCSC5A",52,0)
 S DA=PIFN D ^DIE
"RTN","IBCSC5A",53,0)
 I '$D(^IBA(362.4,PIFN,0)),$G(REVIEN) D  ; Deleted RX - delete related rev code/CPT code
"RTN","IBCSC5A",54,0)
 . I $P($G(^DGCR(399,IBIFN,"RC",REVIEN,0)),U,15) S DA(1)=IBIFN,DA=$P(^(0),U,15),DIK="^DGCR(399,"_DA(1)_",""CP""," D ^DIK
"RTN","IBCSC5A",55,0)
 . S DA=REVIEN,DA(1)=IBIFN,DIK="^DGCR(399,"_DA(1)_",""RC""," D ^DIK
"RTN","IBCSC5A",56,0)
 . S DGRVRCAL=1
"RTN","IBCSC5A",57,0)
 Q
"RTN","IBCSC5A",58,0)
 ;
"RTN","IBCSC5A",59,0)
SET(IFN,RXARR,RXARRP) ;setup array of all rx fills for bill, array name should be passed by reference
"RTN","IBCSC5A",60,0)
 ;returns: RXARR(RX #, FILL DT)=RX IFN (362.4) ^ DRUG ^ DAYS SUPPLY ^ QTY ^ NDC # ^ Charge if known ^ ien of associated rev code multiple, if known ^ NDC FORMAT INDICATOR (1-4)
"RTN","IBCSC5A",61,0)
 ;         RXARR=BILL IFN ^ RX count
"RTN","IBCSC5A",62,0)
 N CNT,IBX,IBY,IBZ,PIFN,IBC,IBCNT,IBRC S IBCNT=+$G(RXARRP),IBC="AIFN"_$G(IFN) K RXARR,RXARRP
"RTN","IBCSC5A",63,0)
 ;
"RTN","IBCSC5A",64,0)
 D RCITEM(IFN,"IBRC",3)
"RTN","IBCSC5A",65,0)
 S (CNT,IBX)=0 F  S IBX=$O(^IBA(362.4,IBC,IBX)) Q:IBX=""  S PIFN=0 F  S PIFN=$O(^IBA(362.4,IBC,IBX,PIFN)) Q:'PIFN  D
"RTN","IBCSC5A",66,0)
 .S IBY=$G(^IBA(362.4,PIFN,0)) Q:IBY=""  S CNT=CNT+1,RXARR($P(IBY,U,1),+$P(IBY,U,3))=PIFN_U_$P(IBY,U,4)_U_$P(IBY,U,6,8),$P(RXARR($P(IBY,U),+$P(IBY,U,3)),U,6)=$$CHG^IBCF4(PIFN,3,.IBRC)
"RTN","IBCSC5A",67,0)
 . I $G(IFN) S $P(RXARR($P(IBY,U),+$P(IBY,U,3)),U,7)=$$FINDREV(IFN,3,PIFN)
"RTN","IBCSC5A",68,0)
 . S $P(RXARR($P(IBY,U),+$P(IBY,U,3)),U,8)=$P(IBY,U,9)
"RTN","IBCSC5A",69,0)
 ;
"RTN","IBCSC5A",70,0)
 S RXARR=$G(IFN)_"^"_CNT
"RTN","IBCSC5A",71,0)
 S IBX=0 F  S IBX=$O(RXARR(IBX)) Q:IBX=""  S IBY=0 F  S IBY=$O(RXARR(IBX,IBY)) Q:'IBY  S IBCNT=IBCNT+1,RXARRP(IBCNT)=IBX_"^"_IBY_"^"_$P(RXARR(IBX,IBY),U,7)
"RTN","IBCSC5A",72,0)
 Q
"RTN","IBCSC5A",73,0)
 ;
"RTN","IBCSC5A",74,0)
DISP(RXARR,RXARRP) ;screen display of existing fills for a bill: input should be print order array returned by SET^IBCSC5A: RXARR(RX,DT)=RX IFN (362.4) ^ DRUG, passed by reference
"RTN","IBCSC5A",75,0)
 N IBX,IBY,IBZ,IBS,IBP,IBIFN
"RTN","IBCSC5A",76,0)
 W !!,?5,"-----------------  Existing Prescriptions on Bill  -----------------",!
"RTN","IBCSC5A",77,0)
 S IBIFN=+$G(RXARR)
"RTN","IBCSC5A",78,0)
 S IBI=0 F  S IBI=$O(RXARRP(IBI)) Q:IBI=""  S IBX=$P(RXARRP(IBI),U,1),IBY=$P(RXARRP(IBI),U,2) I $D(RXARR(IBX,IBY)) D
"RTN","IBCSC5A",79,0)
 . S IBS=$$RXSTAT^IBCU1(+$P(RXARR(IBX,IBY),U,2),+$P($G(^IBA(362.4,+RXARR(IBX,IBY),0)),U,5),IBY)
"RTN","IBCSC5A",80,0)
 . D ZERO^IBRXUTL(+$P(RXARR(IBX,IBY),U,2))
"RTN","IBCSC5A",81,0)
 . S IBZ=$G(^TMP($J,"IBDRUG",+$P(RXARR(IBX,IBY),U,2),.01)),IBP=$$PRVNM(+RXARR(IBX,IBY))
"RTN","IBCSC5A",82,0)
 . K ^TMP($J,"IBDRUG")
"RTN","IBCSC5A",83,0)
 . W !,$J(IBI,2),")",?5,IBX,?19,$E(IBZ,1,25),?46,$$DATE^IBCSC5C(IBY),?56,$P(IBS,U,1),?61,$P(IBS,U,2),?69,$P(IBS,U,3)
"RTN","IBCSC5A",84,0)
 . S IBZ=$$RXDUP^IBCU3(IBX,IBY,IBIFN) I +IBZ W ?73,$P($G(^DGCR(399,+IBZ,0)),U,1)
"RTN","IBCSC5A",85,0)
 . S IBZ=$G(^DGCR(399,IBIFN,"RC",+$P(RXARR(IBX,IBY),U,7),0))
"RTN","IBCSC5A",86,0)
 . W !,?5,$E(IBP,1,25),?35,"(Rx Procedure ",$S($P(IBZ,U,15):"#"_$P(IBZ,U,15)_" "_$$CPTNM^IBCRBH1(IBIFN,4,$P(IBZ,U,15)),1:"Missing"),"  Rev Code ",$S(IBZ:"#"_+$P(RXARR(IBX,IBY),U,7)_" "_$P($G(^DGCR(399.2,+IBZ,0)),U),1:"Missing"),")"
"RTN","IBCSC5A",87,0)
 W !
"RTN","IBCSC5A",88,0)
 Q
"RTN","IBCSC5A",89,0)
 ;
"RTN","IBCSC5A",90,0)
HELP(IFN) ;called for help from rx enter to display existing rx, displays rx' from 52 and 399
"RTN","IBCSC5A",91,0)
 I +$G(IFN) N IBX,IBRXA S IBX=$$BILL(IFN) I +IBX D SET(IFN,.IBRXA,""),RXDISP^IBCSC5C($P(IBX,U,1),$P(IBX,U,2),$P(IBX,U,3),.IBPR,.IBPRO,.IBRXA,$P(IBX,U,4)) S IBRXAP=+IBPRO D SET(IFN,.IBRXA,.IBRXAP),DISP(.IBRXA,.IBRXAP)
"RTN","IBCSC5A",92,0)
 Q
"RTN","IBCSC5A",93,0)
BILL(IBIFN) ; return data on a bill 'patient ifn ^ from dt ^ to dt ^ true if add original rx'
"RTN","IBCSC5A",94,0)
 N IBX,IBY
"RTN","IBCSC5A",95,0)
 S IBX=$G(^DGCR(399,+$G(IBIFN),0)),IBY=$P(IBX,U,2)
"RTN","IBCSC5A",96,0)
 I '$$PERDIEM^IBCRU3(+$P(IBX,U,7),+$P(IBX,U,5),+$P(IBX,U,3)) S $P(IBY,U,4)=1
"RTN","IBCSC5A",97,0)
 S IBX=$G(^DGCR(399,+IBIFN,"U")),$P(IBY,U,2)=+IBX,$P(IBY,U,3)=+$P(IBX,U,2)
"RTN","IBCSC5A",98,0)
 Q IBY
"RTN","IBCSC5A",99,0)
DRUG(IBD) ; get drug
"RTN","IBCSC5A",100,0)
 N X,Y S IBD=+$G(IBD) S DIC(0)="VQ",DIC="^PSDRUG(" D DIC^PSSDI(50,"PS",.DIC,IBD,) I +Y<0  S IBD=0,DIC="^PSDRUG(",DIC(0)="AEQ" D DIC^PSSDI(50,"PS",.DIC,,) K DIC I +Y>0 S IBD=+Y
"RTN","IBCSC5A",101,0)
 Q IBD
"RTN","IBCSC5A",102,0)
 ;
"RTN","IBCSC5A",103,0)
RCITEM(IBIFN,ARRAY,TYPE) ; Pull off all item charges from RC multiple 
"RTN","IBCSC5A",104,0)
 ;  for item TYPE on bill IBIFN, return array ARRAY
"RTN","IBCSC5A",105,0)
 ; If type = "ALL", pull off all types
"RTN","IBCSC5A",106,0)
 ;Set up @ARRAY@(type,item reference,ct)=# units^unit charge
"RTN","IBCSC5A",107,0)
 ; If no pointer to an item, this was a manually entered charge and
"RTN","IBCSC5A",108,0)
 ;  will only 'associate' with the items found in the appropriate
"RTN","IBCSC5A",109,0)
 ;  item source file that are not referenced by an item in the revenue
"RTN","IBCSC5A",110,0)
 ;  code multiple in a sequential fashion (first unassociated 'RC' will
"RTN","IBCSC5A",111,0)
 ;  correlate to the first unassociated entry found for the bill in source file)
"RTN","IBCSC5A",112,0)
 N Z,Z0,Z1
"RTN","IBCSC5A",113,0)
 S Z=0
"RTN","IBCSC5A",114,0)
 F  S Z=$O(^DGCR(399,IBIFN,"RC",Z)) Q:'Z  S Z0=$G(^(Z,0)) I $S(TYPE="ALL":1,1:$P(Z0,U,10)=TYPE) I $P(Z0,U,10)'="" S Z1=$S($P(Z0,U,11)="":0,1:$P(Z0,U,11)),@ARRAY@($P(Z0,U,10),Z1,Z)=$P(Z0,U,3)_U_$P(Z0,U,2)
"RTN","IBCSC5A",115,0)
 Q
"RTN","IBCSC5A",116,0)
 ;
"RTN","IBCSC5A",117,0)
FINDREV(IBIFN,TYP,PTR) ; Finds the first revenue code that matches the
"RTN","IBCSC5A",118,0)
 ; same item type and item pointer
"RTN","IBCSC5A",119,0)
 ;
"RTN","IBCSC5A",120,0)
 N REVIEN,Z,Z0
"RTN","IBCSC5A",121,0)
 S Z=0
"RTN","IBCSC5A",122,0)
 F  S Z=$O(^DGCR(399,IBIFN,"RC",Z)) Q:'Z  S Z0=$G(^(Z,0)) I $P(Z0,U,10)=TYP,$P(Z0,U,11)=PTR S REVIEN=Z Q
"RTN","IBCSC5A",123,0)
 Q $G(REVIEN)
"RTN","IBCSC5A",124,0)
 ;
"RTN","IBCSC5A",125,0)
NDCNUM(IBNDC) ; Returns the format of the NDC # IBNDC, if possible
"RTN","IBCSC5A",126,0)
 N Z
"RTN","IBCSC5A",127,0)
 S Z=$TR(IBNDC,"-")
"RTN","IBCSC5A",128,0)
 Q $S(IBNDC?4N1"-"4N1"-"2N:1,IBNDC?5N1"-"3N1"-"2N:2,IBNDC?5N1"-"4N1"-"1N:3,IBNDC?5N1"-"4N1"-"2N!($L(Z)=11):4,IBNDC'="":1,1:"")
"RTN","IBCSC5A",129,0)
 ;
"RTN","IBCSC5A",130,0)
PRVNM(PIFN) ; return provider name for an rx, if one defined or null
"RTN","IBCSC5A",131,0)
 N IBX,IBPRV,IBRXIFN S IBPRV=""
"RTN","IBCSC5A",132,0)
 S IBRXIFN=$P($G(^IBA(362.4,+$G(PIFN),0)),U,5) I +IBRXIFN S IBX=$P($G(^PSRX(IBRXIFN,0)),U,4) I +IBX S IBPRV=$P($G(^VA(200,+IBX,0)),U,1)
"RTN","IBCSC5A",133,0)
 Q IBPRV
"RTN","IBCSC5C")
0^11^B37390710
"RTN","IBCSC5C",1,0)
IBCSC5C ;ALB/ARH - ADD/EDIT PRESCRIPTION FILLS (CONTINUED) ;3/4/94
"RTN","IBCSC5C",2,0)
 ;;2.0;INTEGRATED BILLING;**27,52,130,51,160,260,309**;21-MAR-94
"RTN","IBCSC5C",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCSC5C",4,0)
 ;
"RTN","IBCSC5C",5,0)
 ;
"RTN","IBCSC5C",6,0)
DEFAULT(IFN,IBRX) ; add default DX and CPT to a prescription bill
"RTN","IBCSC5C",7,0)
 ; if one is not in PSO.  If there is, use it instead.
"RTN","IBCSC5C",8,0)
 ; IFN = ien of bill entry
"RTN","IBCSC5C",9,0)
 N IBX,IBPAR1,IBDX,IBCPT,IBDT,IBBIL,IBDXIFN,IBCPTIFN,IBY,IB52,IBC
"RTN","IBCSC5C",10,0)
 S IBDXIFN=0
"RTN","IBCSC5C",11,0)
 S IBPAR1=$G(^IBE(350.9,1,1)),IBDX=$P(IBPAR1,U,29),IBCPT=$P(IBPAR1,U,30)
"RTN","IBCSC5C",12,0)
 S IBBIL=$G(^DGCR(399,+$G(IFN),0)) Q:IBBIL=""
"RTN","IBCSC5C",13,0)
 S IBX=$S($G(IBRX):$P($G(^DGCR(399,IFN,"RC",+IBRX,0)),U,11),1:$O(^IBA(362.4,"C",IFN,0))) Q:'IBX
"RTN","IBCSC5C",14,0)
 S IB52=+$P($G(^IBA(362.4,IBX,0)),"^",5),IBY=0 F  S IBY=$O(^PSRX(IB52,"ICD",IBY)) Q:'IBY  S IBDX(IBY)=$G(^PSRX(IB52,"ICD",IBY,0))
"RTN","IBCSC5C",15,0)
 I 'IBDX,'IBCPT,$D(IBDX)<10 Q
"RTN","IBCSC5C",16,0)
 S IBDT=$P($G(^IBA(362.4,+IBX,0)),U,3) Q:'IBDT
"RTN","IBCSC5C",17,0)
 ; add dx associated with rx if they are there.
"RTN","IBCSC5C",18,0)
 I $D(IBDX)>9 S (IBC,IBDX,IBY)=0 F  S IBY=$O(IBDX(IBY)) Q:'IBY  D
"RTN","IBCSC5C",19,0)
 . I $D(^IBA(362.3,"AIFN"_IFN,+IBDX(IBY))) Q
"RTN","IBCSC5C",20,0)
 . S IBC=IBC+1
"RTN","IBCSC5C",21,0)
 . S DIC="^IBA(362.3,",DIC(0)="L",DIC("DR")=".02////"_IFN_";.03////"_IBC,X=+IBDX(IBY),DLAYGO=362.3
"RTN","IBCSC5C",22,0)
 . K DD,DO D FILE^DICN K DIC,DA,DR,DD,DO,DLAYGO
"RTN","IBCSC5C",23,0)
 . S IBDXIFN(IBC)=+Y
"RTN","IBCSC5C",24,0)
 ; add default dx if none found on actual rx.
"RTN","IBCSC5C",25,0)
 I +IBDX,'$D(^IBA(362.3,"AIFN"_IFN,+IBDX)) S DIC="^IBA(362.3,",DIC(0)="L",DIC("DR")=".02////"_IFN,X=IBDX,DLAYGO=362.3 K DD,DO D FILE^DICN K DIC,DA,DR,DD,DO,DLAYGO S IBDXIFN=+Y
"RTN","IBCSC5C",26,0)
 I +IBCPT D  ;Check if the procedure is already present for the Rx
"RTN","IBCSC5C",27,0)
 . N Z,Z0,DUP
"RTN","IBCSC5C",28,0)
 . S (DUP,Z)=0 F  S Z=$O(^DGCR(399,IFN,"RC",Z)) Q:'Z  S Z0=$G(^(Z,0)) D  Q:DUP
"RTN","IBCSC5C",29,0)
 .. I $P(Z0,U,10)=3,$P(Z0,U,15),$P(Z0,U,11)=IBX S DUP=1
"RTN","IBCSC5C",30,0)
 . Q:DUP
"RTN","IBCSC5C",31,0)
 . I $P($G(^DGCR(399,IFN,0)),U,9)="" S DIE="^DGCR(399,",DA=IFN,DR=".09////5" D ^DIE K DIE,DIC,DA,DR
"RTN","IBCSC5C",32,0)
 . I '$D(^DGCR(399,IFN,"CP",0)) S DIC("P")=$$GETSPEC^IBEFUNC(399,304)
"RTN","IBCSC5C",33,0)
 . S DLAYGO=399,DIC("DR")="1////"_IBDT D
"RTN","IBCSC5C",34,0)
 . . I +IBDXIFN>0 S DIC("DR")=DIC("DR")_";10////"_IBDXIFN Q
"RTN","IBCSC5C",35,0)
 . . I $D(IBDXIFN)>9 F IBY=1:1:4 I $D(IBDXIFN(IBY)) S DIC("DR")=DIC("DR")_";"_(IBY+9)_"////"_IBDXIFN(IBY)
"RTN","IBCSC5C",36,0)
 . S DIC="^DGCR(399,"_IFN_",""CP"",",DIC(0)="L",DA(1)=IFN,X=IBCPT_";ICPT(" K DD,DO D FILE^DICN K DIC,DA,DD,DO,DR,DLAYGO
"RTN","IBCSC5C",37,0)
 . I +Y D
"RTN","IBCSC5C",38,0)
 .. N Z,IBZ
"RTN","IBCSC5C",39,0)
 .. S IBZ=+Y,Z=$S($G(IBREV):IBREV,1:$$FINDREV^IBCSC5A(IFN,3,+IBX))
"RTN","IBCSC5C",40,0)
 .. I Z S DR=".15////"_IBZ_";.06////"_IBCPT,DA=+Z,DA(1)=IFN,DIE="^DGCR(399,"_DA(1)_",""RC""," D ^DIE
"RTN","IBCSC5C",41,0)
 Q
"RTN","IBCSC5C",42,0)
 ;
"RTN","IBCSC5C",43,0)
RXDISP(DFN,DT1,DT2,ARRAY,POARR,RXARR,IBRXALL,NODISP) ; display all rx fills for a patient and date range
"RTN","IBCSC5C",44,0)
 ;RXARR (as defined by SET^IBCSC5A) passed by ref. only to check if rx-fill is on the bill, not necessary not changed
"RTN","IBCSC5C",45,0)
 ;returns: ARRAY(RX #, FILL DT) = RX IFN (52) ^ FILL IFN ^ DRUG ^ DAYS SUPPLY ^ QTY ^ NDC, pass by reference if desired
"RTN","IBCSC5C",46,0)
 ;         POARR(CNT)=RX # ^ FILL DT
"RTN","IBCSC5C",47,0)
 N PIFN,RIFN,IBX,IBY,DTE,DTR,RX,IBCNT,IBRX0,IBRX2,IBS K ARRAY,POARR S POARR=0,NODISP=+$G(NODISP)
"RTN","IBCSC5C",48,0)
 S IBCNT=0,DT1=$G(DT1)-.0001,DT2=$G(DT2) S:'DT2 DT2=9999999 Q:'$G(DFN)
"RTN","IBCSC5C",49,0)
 ;^PS(55,DFN,"P","A",EXPIRATION DATE, RX) is the best xref available for finding patient fills in a date range
"RTN","IBCSC5C",50,0)
 ;if RX expires/cancelled before start of bill then should not be applicable to bill
"RTN","IBCSC5C",51,0)
 S DTE=DT1 F  S DTE=$O(^PS(55,DFN,"P","A",DTE)) Q:'DTE  D
"RTN","IBCSC5C",52,0)
 . S PIFN=0 F  S PIFN=$O(^PS(55,DFN,"P","A",DTE,PIFN)) Q:'PIFN  D
"RTN","IBCSC5C",53,0)
 .. S IBRX0=$G(^PSRX(PIFN,0)),IBRX2=$G(^PSRX(PIFN,2))
"RTN","IBCSC5C",54,0)
 .. ; original fill
"RTN","IBCSC5C",55,0)
 .. I +$G(IBRXALL) S DTR=$P(IBRX2,U,2) I DTR'<DT1,DTR'>DT2 D
"RTN","IBCSC5C",56,0)
 ... D DATA^IBRXUTL(+$P(IBRX0,U,6))
"RTN","IBCSC5C",57,0)
 ... S ARRAY($P(IBRX0,U,1),+DTR)=PIFN_U_0_U_$P(IBRX0,U,6)_U_$P(IBRX0,U,8)_U_$P(IBRX0,U,7)_U_$G(^TMP($J,"IBDRUG",+$P(IBRX0,U,6),31))
"RTN","IBCSC5C",58,0)
 ... K ^TMP($J,"IBDRUG")
"RTN","IBCSC5C",59,0)
 ... Q
"RTN","IBCSC5C",60,0)
 .. ; refills
"RTN","IBCSC5C",61,0)
 .. S DTR=DT1 F  S DTR=$O(^PSRX(PIFN,1,"B",DTR)) Q:'DTR!(DTR>DT2)  D
"RTN","IBCSC5C",62,0)
 ... S RIFN=0 F  S RIFN=$O(^PSRX(PIFN,1,"B",DTR,RIFN)) Q:'RIFN  D
"RTN","IBCSC5C",63,0)
 .... S IBY=$G(^PSRX(PIFN,1,RIFN,0)) Q:IBY=""
"RTN","IBCSC5C",64,0)
 .... D DATA^IBRXUTL(+$P(IBRX0,U,6))
"RTN","IBCSC5C",65,0)
 .... S ARRAY($P(IBRX0,U,1),+IBY)=PIFN_U_RIFN_U_$P(IBRX0,U,6)_U_$P(IBRX0,U,8)_U_$P(IBY,U,4)_U_$G(^TMP($J,"IBDRUG",+$P(IBRX0,U,6),31))
"RTN","IBCSC5C",66,0)
 .... K ^TMP($J,"IBDRUG")
"RTN","IBCSC5C",67,0)
 .... Q
"RTN","IBCSC5C",68,0)
 ;
"RTN","IBCSC5C",69,0)
 S IBX="",IBS=0 F  S IBX=$O(ARRAY(IBX)) Q:IBX=""  S IBY=0 F  S IBY=$O(ARRAY(IBX,IBY)) Q:'IBY  D
"RTN","IBCSC5C",70,0)
 . S IBCNT=IBCNT+1,POARR(IBCNT)=$P(IBX,U,1)_"^"_+IBY,POARR=IBCNT I $D(RXARR(IBX,IBY)) S IBS=IBS+1
"RTN","IBCSC5C",71,0)
 S $P(POARR,U,2)=IBCNT-IBS
"RTN","IBCSC5C",72,0)
 ;
"RTN","IBCSC5C",73,0)
 Q:+NODISP
"RTN","IBCSC5C",74,0)
 W @IOF,?33,"PRESCRIPTIONS IN DATE RANGE",!,"===============================================================================",!
"RTN","IBCSC5C",75,0)
 S IBCNT=0 F  S IBCNT=$O(POARR(IBCNT)) Q:IBCNT=""  S RX=$P(POARR(IBCNT),U,1),DTR=$P(POARR(IBCNT),U,2) I RX'="",DTR'="" D
"RTN","IBCSC5C",76,0)
 . S IBS=$$RXSTAT^IBCU1($P(ARRAY(RX,DTR),U,3),$P(ARRAY(RX,DTR),U,1),DTR)
"RTN","IBCSC5C",77,0)
 . S IBY="" I $D(RXARR(RX,+DTR)) S IBY="*"
"RTN","IBCSC5C",78,0)
 . D ZERO^IBRXUTL(+$P(ARRAY(RX,DTR),U,3))
"RTN","IBCSC5C",79,0)
 . W !,$J(IBCNT,2),")",?5,IBY,?6,RX,?19,$E($G(^TMP($J,"IBDRUG",+$P(ARRAY(RX,DTR),U,3),.01)),1,25),?46,$$DATE(+DTR),?56,$P(IBS,U,1),?61,$P(IBS,U,2),?69,$P(IBS,U,3),?75,$$EXEMPT(+ARRAY(RX,DTR))
"RTN","IBCSC5C",80,0)
 . S IBY=$$RXDUP^IBCU3(RX,DTR,IBIFN) I +IBY W ?73,$P($G(^DGCR(399,+IBY,0)),U,1)
"RTN","IBCSC5C",81,0)
 . K ^TMP($J,"IBDRUG")
"RTN","IBCSC5C",82,0)
 Q
"RTN","IBCSC5C",83,0)
DATE(X) Q $E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3)
"RTN","IBCSC5C",84,0)
 ;
"RTN","IBCSC5C",85,0)
NEWRX(IBX) ;
"RTN","IBCSC5C",86,0)
 Q:'$G(IBX)  N X,Y K IBLIST W !
"RTN","IBCSC5C",87,0)
NEWRX1 S DIR("?")="Enter the number preceding the RX Fills you want added to the bill.     "_$$HTEXT
"RTN","IBCSC5C",88,0)
 S DIR("A")="SELECT NEW RX FILLS TO ADD THE BILL"
"RTN","IBCSC5C",89,0)
 S DIR(0)="LO^1:"_+IBX D ^DIR K DIR G:'Y!$D(DIRUT) NEWRXE
"RTN","IBCSC5C",90,0)
 S IBLIST=Y
"RTN","IBCSC5C",91,0)
 ;
"RTN","IBCSC5C",92,0)
 S DIR("A")="YOU HAVE SELECTED "_IBLIST_" TO BE ADDED TO THE BILL IS THIS CORRECT",DIR("B")="YES"
"RTN","IBCSC5C",93,0)
 S DIR(0)="YO" D ^DIR K DIR I $D(DIRUT) K IBLIST G NEWRXE
"RTN","IBCSC5C",94,0)
 I 'Y K IBLIST G NEWRX1
"RTN","IBCSC5C",95,0)
NEWRXE Q
"RTN","IBCSC5C",96,0)
 ;
"RTN","IBCSC5C",97,0)
ADDNEW(IBIFN,LIST,IBPR,IBPRO) ;
"RTN","IBCSC5C",98,0)
 Q:'LIST  N IBI,IBX,IBRX,IBDT,IBQ,IBY,IBPIFN,IBZ
"RTN","IBCSC5C",99,0)
 F IBI=1:1 S IBX=$P(LIST,",",IBI) Q:'IBX  I $D(IBPRO(IBX)) D
"RTN","IBCSC5C",100,0)
 . S IBRX=$P(IBPRO(IBX),U,1),IBDT=$P(IBPRO(IBX),U,2) Q:IBRX=""
"RTN","IBCSC5C",101,0)
 . S IBQ=0,IBY=$G(IBPR(IBRX,+IBDT)) Q:'IBY
"RTN","IBCSC5C",102,0)
 . S IBPIFN=0 F  S IBPIFN=$O(^IBA(362.4,"AIFN"_IBIFN,IBRX,IBPIFN)) Q:'IBPIFN  I $P($G(^IBA(362.4,IBPIFN,0)),U,3)=IBDT S IBQ=1 Q
"RTN","IBCSC5C",103,0)
 . I 'IBQ S IBZ=$G(IBPR(IBRX,IBDT)) I $$ADD^IBCSC5A(IBRX,IBIFN,IBDT,$P(IBZ,U,3),$P(IBZ,U,1),$P(IBZ,U,4,6)) W "."
"RTN","IBCSC5C",104,0)
 Q
"RTN","IBCSC5C",105,0)
 ;
"RTN","IBCSC5C",106,0)
HTEXT() ;
"RTN","IBCSC5C",107,0)
 N X S X="If an Rx fill has been assigned to another bill it will be displayed in the last column.  [ORG=Original Fill, NR=Not Released, RTS=Returned to Stock, OTC=Over-the-Counter, INV=Investigational, SUP=Supply Item]"
"RTN","IBCSC5C",108,0)
 Q X
"RTN","IBCSC5C",109,0)
 ;
"RTN","IBCSC5C",110,0)
RXLINK(IBIFN,CPIEN) ; Function returns the ien of the Rx rev code the proc
"RTN","IBCSC5C",111,0)
 ; code is linked to or 0 if no link found.
"RTN","IBCSC5C",112,0)
 Q +$O(^DGCR(399,IBIFN,"RC","ACP",+CPIEN,0))
"RTN","IBCSC5C",113,0)
 ;
"RTN","IBCSC5C",114,0)
EXEMPT(RX) ; Used to look up exemption if any on rx, the return value
"RTN","IBCSC5C",115,0)
 ; will be only the first exemption reason found.
"RTN","IBCSC5C",116,0)
 N IBX,IBZ,IBS,IBR
"RTN","IBCSC5C",117,0)
 S IBR="",(IBS,IBX)=0 F  S IBX=$O(^PSRX(RX,"ICD",IBX)) Q:'IBX!(IBS)  S IBZ=$G(^PSRX(RX,"ICD",IBX,0)) F IBP=2:1:8 Q:IBS  I $P(IBZ,"^",IBP) S IBR=$P($T(EREASON+(IBP-1)),";",3),IBS=1
"RTN","IBCSC5C",118,0)
 Q IBR
"RTN","IBCSC5C",119,0)
EREASON ;
"RTN","IBCSC5C",120,0)
 ;;AO
"RTN","IBCSC5C",121,0)
 ;;IR
"RTN","IBCSC5C",122,0)
 ;;SC
"RTN","IBCSC5C",123,0)
 ;;EC
"RTN","IBCSC5C",124,0)
 ;;MST
"RTN","IBCSC5C",125,0)
 ;;HNC
"RTN","IBCSC5C",126,0)
 ;;CV
"RTN","IBCSC5C",127,0)
 ;
"RTN","IBCSC61")
0^12^B7919813
"RTN","IBCSC61",1,0)
IBCSC61 ;ALB/MJB - MCCR SCREEN UTILITY ;20 JUN 88 10:58
"RTN","IBCSC61",2,0)
 ;;2.0;INTEGRATED BILLING;**52,80,106,51,210,230,309**;21-MAR-94
"RTN","IBCSC61",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCSC61",4,0)
 ;
"RTN","IBCSC61",5,0)
 ;MAP TO IBCSC61
"RTN","IBCSC61",6,0)
 ;
"RTN","IBCSC61",7,0)
REV I I>1 W !?4,"Rev. Code",?16,": "
"RTN","IBCSC61",8,0)
 N IBNAME S IBNAME=$E($$NAME($P(IBREVC(I),U,10),$P(IBREVC(I),U,11)),1,17)
"RTN","IBCSC61",9,0)
 S DGRCD=$S($D(^DGCR(399.2,+IBREVC(I),0)):^(0),1:""),DGRCD=$P(DGRCD,"^",1)_"-"_$S(IBNAME'="":IBNAME,1:$E($P(DGRCD,"^",2),1,17))
"RTN","IBCSC61",10,0)
 I $P(IBREVC(I),"^",6) S DGRCD=DGRCD_$J("",21-$L(DGRCD))_"  "_$P($$CPT^ICPTCOD(+$P(IBREVC(I),"^",6)),U,2)
"RTN","IBCSC61",11,0)
 I '$P(IBREVC(I),U,6),$P(IBREVC,U,11) S DGRCD=DGRCD_$J("",21-$L(DGRCD))_" *"_$P($$CPT^ICPTCOD(+$P(IBREVC(I),"^",11)),U,2)
"RTN","IBCSC61",12,0)
 S DGRCD=DGRCD_$J("",28-$L(DGRCD))
"RTN","IBCSC61",13,0)
 I (+$P(IBREVC(I),"^",3)>1)!($P(IBREVC(I),U,10)'=4) S DGRCD=DGRCD_$J($P(IBREVC(I),"^",3),3)
"RTN","IBCSC61",14,0)
 S X=$S($P(IBREVC(I),"^",4)]"":$P(IBREVC(I),"^",4),1:IBU) I X'=IBU S X2="2$" D COMMA^%DTC
"RTN","IBCSC61",15,0)
 W DGRCD,$J("",32-$L(DGRCD)),X
"RTN","IBCSC61",16,0)
 I $P(IBREVC(I),"^",5)]"",$D(^DGCR(399.1,$P(IBREVC(I),"^",5),0)) W ?60," ",$E($P(^DGCR(399.1,$P(IBREVC(I),"^",5),0),"^"),1,16)
"RTN","IBCSC61",17,0)
 I IBREVC<10,$P(IBREVC(I),U,9)'="",$$FT^IBCEF(IBIFN)=3 S X=$P(IBREVC(I),U,9),X2="2$" D COMMA^%DTC W !,?50,X S IBREVC=IBREVC+1 W ?64,"(Non-Covered)"
"RTN","IBCSC61",18,0)
 Q
"RTN","IBCSC61",19,0)
 ;
"RTN","IBCSC61",20,0)
CHARGE S (IBCH,IBUCH)=0 F I=1:1 Q:'$D(IBREVC(I))  S IBCH=IBCH+($P(IBREVC(I),U,4)),IBUCH=IBUCH+$P(IBREVC(I),U,9)
"RTN","IBCSC61",21,0)
 I IB("U1")]"" S X=$P(IB("U1"),"^",1),X1=$P(IB("U1"),"^",2),IBCH=X
"RTN","IBCSC61",22,0)
 Q
"RTN","IBCSC61",23,0)
 ;
"RTN","IBCSC61",24,0)
OFFSET S IBOFFC="" W !?4,"OFFSET",?16,": " S X=$S(IB("U1")']"":0,1:+$P(IB("U1"),U,2)),X2="2$" S:X IBOFFC=$P(IB("U1"),U,3) D COMMA^%DTC
"RTN","IBCSC61",25,0)
 W X,"  [",$S($L(IBOFFC):IBOFFC,'$P(X,"$",2):"NO OFFSET RECORDED",1:"OFFSET DESCRIPTION UNSPECIFIED"),"]"
"RTN","IBCSC61",26,0)
 D CHARGE W !?4,"BILL TOTAL",?16,": " S X=$S('$D(IBCH):0,1:+IBCH),X2="2$" D COMMA^%DTC W X
"RTN","IBCSC61",27,0)
 K IBOFFC
"RTN","IBCSC61",28,0)
 Q
"RTN","IBCSC61",29,0)
 ;
"RTN","IBCSC61",30,0)
NAME(TYPE,ITEM) ; if rx or pros or DRG or unassociated return name of the item
"RTN","IBCSC61",31,0)
 N IBNAME S IBNAME=""
"RTN","IBCSC61",32,0)
 I $G(TYPE)=3,+$G(ITEM) D
"RTN","IBCSC61",33,0)
 .D ZERO^IBRXUTL($P($G(^IBA(362.4,+ITEM,0)),U,4))
"RTN","IBCSC61",34,0)
 .S IBNAME=$G(^TMP($J,"IBDRUG",+$P($G(^IBA(362.4,+ITEM,0)),U,4),.01))
"RTN","IBCSC61",35,0)
 .K ^TMP($J,"IBDRUG")
"RTN","IBCSC61",36,0)
 .Q
"RTN","IBCSC61",37,0)
 I $G(TYPE)=5,+$G(ITEM) S IBNAME=$P($$PIN^IBCSC5B(+$P($G(^IBA(362.5,+ITEM,0)),U,3)),U,2)
"RTN","IBCSC61",38,0)
 I $G(TYPE)=6,+$G(ITEM) S IBNAME=$P($$DRG^IBACSV(+ITEM),U,1)
"RTN","IBCSC61",39,0)
 I $G(TYPE)=9,+$G(ITEM) S IBNAME=$P($G(^IBA(363.21,+ITEM,0)),U,1)
"RTN","IBCSC61",40,0)
 Q IBNAME
"RTN","IBCSC61",41,0)
 ;IBCSC61
"RTN","IBCU1")
0^13^B25353879
"RTN","IBCU1",1,0)
IBCU1 ;ALB/MRL - BILLING UTILITY ROUTINE (CONTINUED) ;01 JUN 88 12:00
"RTN","IBCU1",2,0)
 ;;2.0;INTEGRATED BILLING;**27,52,106,138,51,182,210,266,309**;21-MAR-94
"RTN","IBCU1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBCU1",4,0)
 ;
"RTN","IBCU1",5,0)
 ;MAP TO DGCRU1
"RTN","IBCU1",6,0)
 ;
"RTN","IBCU1",7,0)
 ;procedure doesn't appear to be used (6/4/93), if it is used, what for??
"RTN","IBCU1",8,0)
 ;where would multiple provider numbers comde from?  ARH
"RTN","IBCU1",9,0)
 ;BCH    ;Blue Cross/Shield Help
"RTN","IBCU1",10,0)
 W ! S IB01=$P($G(^IBE(350.9,1,1)),"^",6)
"RTN","IBCU1",11,0)
 I IB01]"" W "CHOOSE FROM",!!?4,"1 - ",$P(IB01,"^",6) F IB00=2,3 I $P(IB01,"^",$S(IB00=2:14,1:15))]"" W !?4,IB00," - ",$P(IB01,"^",$S(IB00=2:14,1:15))
"RTN","IBCU1",12,0)
 W:IB01']"" "NO BLUE CROSS/SHIELD PROVIDER NUMBERS IDENTIFIED TO SELECT FROM!" W ! W:IB01]"" !,"OR " W "ENTER BLUE CROSS/SHIELD PROVIDER # (BETWEEN 3-13 CHARACTERS)",! K IB00,IB01 Q
"RTN","IBCU1",13,0)
 ;
"RTN","IBCU1",14,0)
RCD ;Revenue Code Display
"RTN","IBCU1",15,0)
 Q:'$D(^DGCR(399,IBIFN,"RC"))
"RTN","IBCU1",16,0)
 W @IOF,!,"Revenue Code Listing",?34,"Units",?45,"Charge" W:$$FT^IBCEF(IBIFN)=3 ?56,"Non-Cov"
"RTN","IBCU1",17,0)
 S DGIFN=0 F IBI=0:0 S DGIFN=$O(^DGCR(399,IBIFN,"RC",DGIFN)) Q:'DGIFN  I $D(^DGCR(399,IBIFN,"RC",DGIFN,0)) S Z=^(0) D DISRC
"RTN","IBCU1",18,0)
 W !
"RTN","IBCU1",19,0)
 I $D(DIC(0)) S DIC(0)=DIC(0)_"N"
"RTN","IBCU1",20,0)
 Q
"RTN","IBCU1",21,0)
DISRC N Z0 W !?1,DGIFN,?4,$P(^DGCR(399.2,+Z,0),"^"),"-",$E($P(^DGCR(399.2,+Z,0),"^",2),1,19)
"RTN","IBCU1",22,0)
 I +$P(Z,U,6) W ?28,$P($$CPT^ICPTCOD(+$P(Z,U,6)),U,2)
"RTN","IBCU1",23,0)
 W ?36,$P(Z,"^",3),?40 S X=$P(Z,"^",2),X2="2$" D COMMA^%DTC W X
"RTN","IBCU1",24,0)
 I $$FT^IBCEF(IBIFN)=3,$P(Z,U,9)'="" S X=$P(Z,U,9),X2="2$" D COMMA^%DTC W ?51,X
"RTN","IBCU1",25,0)
 I $D(^DGCR(399.1,+$P(Z,"^",5),0)) W ?64,$E($P(^(0),"^"),1,15)
"RTN","IBCU1",26,0)
 I $S($P(Z,U,15):1,1:$P(Z,U,10)=3) D
"RTN","IBCU1",27,0)
 . W !,?5,"(Rx: ",$S($P(Z,U,11):$P($G(^IBA(362.4,$P(Z,U,11),0)),U),1:"Link Missing"),"  Procedure "_$S($P(Z,U,15):"#"_$P(Z,U,15)_" "_$$CPTNM^IBCRBH1(IBIFN,4,$P(Z,U,15)),1:"Link Missing"),")"
"RTN","IBCU1",28,0)
 Q
"RTN","IBCU1",29,0)
 ;
"RTN","IBCU1",30,0)
RVCPRC(IBIFN,IBD0) ; returns 1 if CHAMPVA rate type + 2 if HCFA 1500, 0 otherwise
"RTN","IBCU1",31,0)
 ; IBD0 - zero node of bill if available, not required
"RTN","IBCU1",32,0)
 N X S X=0
"RTN","IBCU1",33,0)
 I $G(IBD0)="" S IBD0=$G(^DGCR(399,+$G(IBIFN),0))
"RTN","IBCU1",34,0)
 I $P($G(^DGCR(399.3,+$P(IBD0,U,7),0)),U,1)="CHAMPVA" S X=X+1
"RTN","IBCU1",35,0)
 I $P(IBD0,U,19)=2 S X=X+2
"RTN","IBCU1",36,0)
 Q X
"RTN","IBCU1",37,0)
 ;
"RTN","IBCU1",38,0)
ORDNXT(IFN) ;CALLED BY TRIGGER ON (362.3,.02) THAT SETS DX PRINT ORDER (362.3,.03),
"RTN","IBCU1",39,0)
 ;returns the highest print order used on the bill plus 3, returns 3 if no existing print order
"RTN","IBCU1",40,0)
 ;used for the default print order so that dx's can be printed in order of entry without any input by the user,
"RTN","IBCU1",41,0)
 ;3 is added to allow spaces for additions, changes, moves
"RTN","IBCU1",42,0)
 N X,Y S X="" I $D(^DGCR(399,+$G(IFN),0)) S X=3,Y=0 F  S Y=$O(^IBA(362.3,"AO",+IFN,Y)) Q:'Y  S X=Y+3
"RTN","IBCU1",43,0)
 Q X
"RTN","IBCU1",44,0)
 ;
"RTN","IBCU1",45,0)
ORDDUP(ORD,DIFN) ;returns true if print order ORD is already defined for a bill (not same entry)
"RTN","IBCU1",46,0)
 N IBX,IBY S IBY=0
"RTN","IBCU1",47,0)
 I +$G(ORD) S IBX=$G(^IBA(362.3,+$G(DIFN),0)) I +IBX,+$P(IBX,U,3)'=ORD,$D(^IBA(362.3,"AO",+$P(IBX,U,2),+ORD)) S IBY=1
"RTN","IBCU1",48,0)
 Q IBY
"RTN","IBCU1",49,0)
 ;
"RTN","IBCU1",50,0)
DXDUP(DX,DIFN,IFN) ;returns true if DX is already defined for a bill (not same entry)
"RTN","IBCU1",51,0)
 ;either DIFN or IFN can be passed, both are not needed, DIFN is needed during edit so can reenter the same dx
"RTN","IBCU1",52,0)
 N IBX,IBY S IBY=0 I +$G(DX),'$G(IFN) S IBX=$G(^IBA(362.3,+$G(DIFN),0)),IFN=+$P(IBX,U,2)
"RTN","IBCU1",53,0)
 I +$G(DX),$D(^IBA(362.3,"AIFN"_+IFN,+DX)),$O(^IBA(362.3,"AIFN"_+IFN,+DX,0))'=+$G(DIFN) S IBY=1
"RTN","IBCU1",54,0)
 Q IBY
"RTN","IBCU1",55,0)
 ;
"RTN","IBCU1",56,0)
DXBSTAT(DIFN,IFN) ;returns a diagnosis' bill status (either DIFN or IFN can be passed, both are not needed)
"RTN","IBCU1",57,0)
 N IBX,IBY I '$G(IFN) S IBX=$G(^IBA(362.3,+$G(DIFN),0)),IFN=+$P(IBX,U,2)
"RTN","IBCU1",58,0)
 S IBY=+$P($G(^DGCR(399,+IFN,0)),U,13)
"RTN","IBCU1",59,0)
 Q IBY
"RTN","IBCU1",60,0)
 ;
"RTN","IBCU1",61,0)
RXSTAT(DRUG,PIFN,FILLDT) ; returns status/definition of rx
"RTN","IBCU1",62,0)
 ; returns: ORIGINAL ^ RELEASED/RETURNED TO STOCK ^ DRUG DEA
"RTN","IBCU1",63,0)
 N IBX,IBY,IBZ,IBLN S IBLN="",DRUG=+$G(DRUG),PIFN=+$G(PIFN),FILLDT=+$G(FILLDT)
"RTN","IBCU1",64,0)
 ;
"RTN","IBCU1",65,0)
 S IBX=$G(^PSRX(PIFN,2)),IBZ="" I IBX'="",$P(IBX,U,2)=$G(FILLDT) D  I IBZ'="" S $P(IBLN,U,2)=IBZ
"RTN","IBCU1",66,0)
 . S IBLN="ORG"
"RTN","IBCU1",67,0)
 . ;I +$G(^PS(59.7,1,49.99))<6 Q
"RTN","IBCU1",68,0)
 . I '$P(IBX,U,13) S IBZ="NR"
"RTN","IBCU1",69,0)
 . I +$P(IBX,U,15) S:IBZ'="" IBZ=IBZ_"-" S IBZ=IBZ_"RTS"
"RTN","IBCU1",70,0)
 ;
"RTN","IBCU1",71,0)
 I IBLN="" S IBX=$O(^PSRX(PIFN,1,"B",FILLDT,0)),IBX=$G(^PSRX(PIFN,1,+IBX,0)),IBZ="" I IBX'="" D  I IBZ'="" S $P(IBLN,U,2)=IBZ
"RTN","IBCU1",72,0)
 . ;I +$G(^PS(59.7,1,49.99))<6 Q
"RTN","IBCU1",73,0)
 . I '$P(IBX,U,18) S IBZ="NR"
"RTN","IBCU1",74,0)
 . I +$P(IBX,U,16) S:IBZ'="" IBZ=IBZ_"-" S IBZ=IBZ_"RTS"
"RTN","IBCU1",75,0)
 ;
"RTN","IBCU1",76,0)
 D ZERO^IBRXUTL(DRUG)
"RTN","IBCU1",77,0)
 S IBX=$G(^TMP($J,"IBDRUG",0)) I IBX'="" S IBY=$G(^TMP($J,"IBDRUG",DRUG,3)),IBZ="" D  I IBZ'="" S $P(IBLN,U,3)=IBZ
"RTN","IBCU1",78,0)
 . I IBY["9" S IBZ="OTC"
"RTN","IBCU1",79,0)
 . I IBY["I" S:IBZ'="" IBZ=IBZ_"-" S IBZ=IBZ_"INV"
"RTN","IBCU1",80,0)
 . I IBY["S" S:IBZ'="" IBZ=IBZ_"-" S IBZ=IBZ_"SUP"
"RTN","IBCU1",81,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBCU1",82,0)
 Q IBLN
"RTN","IBCU1",83,0)
 ;
"RTN","IBCU1",84,0)
PRVLIC(NPIFN,IBDT,ARR,STIFN) ; returns the Provider License data from the New Person file active on a date
"RTN","IBCU1",85,0)
 ; Input:   NPIFN = pointer to file 200,              IBDT = date to check (if none passed then all returned)
"RTN","IBCU1",86,0)
 ;          ARR = array pass by reference (optional), STIFN = state to return as value of function (optional)
"RTN","IBCU1",87,0)
 ; Output:  ARR(X) = license state (ifn) ^ license ^ expiration date (200,541)
"RTN","IBCU1",88,0)
 ;          return value = license data of state requested or if no state passed in then count found
"RTN","IBCU1",89,0)
 N IBX,IBY,IBLN,IBCNT S IBX=0,IBCNT=0 K ARR
"RTN","IBCU1",90,0)
 I +$G(NPIFN) S IBY=0 F  S IBY=$O(^VA(200,NPIFN,"PS1",IBY)) Q:'IBY  D
"RTN","IBCU1",91,0)
 . S IBLN=$G(^VA(200,NPIFN,"PS1",IBY,0))
"RTN","IBCU1",92,0)
 . I +$G(IBDT),+$P(IBLN,U,3),$P(IBLN,U,3)<IBDT Q
"RTN","IBCU1",93,0)
 . I +$G(STIFN),+STIFN=+IBLN S IBX=IBLN
"RTN","IBCU1",94,0)
 . S IBCNT=IBCNT+1,ARR(IBCNT)=IBLN
"RTN","IBCU1",95,0)
 S ARR=IBCNT I '$G(STIFN) S IBX=IBCNT
"RTN","IBCU1",96,0)
 Q IBX
"RTN","IBCU1",97,0)
 ;
"RTN","IBCU1",98,0)
DELPR(IB,IBX) ; Deletes the corresponding RX proc when the RX pointer is
"RTN","IBCU1",99,0)
 ; deleted
"RTN","IBCU1",100,0)
 ; IB = the ien of the bill in file 399
"RTN","IBCU1",101,0)
 ; IBX = the ien of the entry in the procedure multiple to be deleted
"RTN","IBCU1",102,0)
 ;
"RTN","IBCU1",103,0)
 N DA,DIK,X,Y
"RTN","IBCU1",104,0)
 S DA(1)=IB,DA=IBX
"RTN","IBCU1",105,0)
 I $D(^DGCR(399,DA(1),"CP",DA,0)) S DIK="^DGCR(399,"_DA(1)_",""CP""," D ^DIK
"RTN","IBCU1",106,0)
 Q
"RTN","IBCU1",107,0)
 ;
"RTN","IBCU1",108,0)
MODHLP(DA) ; Executable modifier help 399.042  .14
"RTN","IBCU1",109,0)
 ; DA = iens of the current entry DA(1) = file 399 ien
"RTN","IBCU1",110,0)
 ;                                DA    = file 399.042 ien
"RTN","IBCU1",111,0)
 N Z,IBZ,DIC,IBDATE
"RTN","IBCU1",112,0)
 S IBDATE=$$BDATE^IBACSV(+$G(DA(1))) ; The date of service
"RTN","IBCU1",113,0)
 I $P($G(^DGCR(399,+$G(DA(1)),"RC",+$G(DA),0)),U,14)'="" S Z=$P(^(0),U,14) D
"RTN","IBCU1",114,0)
 . N Q
"RTN","IBCU1",115,0)
 . S Q=1
"RTN","IBCU1",116,0)
 . S IBZ(1)="Current modifier"_$S($P(Z,";",2)'="":"s are:",1:"is:")
"RTN","IBCU1",117,0)
 . I $P(Z,";")'="" S Q=Q+1,IBZ(Q)="  "_$P(Z,";")_"  "_$P($$MOD^ICPTMOD($P(Z,";"),"E",IBDATE),U,3)
"RTN","IBCU1",118,0)
 . I $P(Z,";",2)'="" S Q=Q+1,IBZ(Q)="  "_$P(Z,";",2)_"  "_$P($$MOD^ICPTMOD($P(Z,";",2),"E",IBDATE),U,3)
"RTN","IBCU1",119,0)
 . S Q=Q+1,IBZ(Q)=" "
"RTN","IBCU1",120,0)
 . D EN^DDIOL(.IBZ)
"RTN","IBCU1",121,0)
 ;
"RTN","IBCU1",122,0)
 S DIC="^DIC(81.3,",DIC(0)="E"
"RTN","IBCU1",123,0)
 S DIC("S")="I $$MODP^ICPTMOD($P($G(^DGCR(399,DA(1),""RC"",DA,0)),U,6),Y,""I"",IBDATE)>0"
"RTN","IBCU1",124,0)
 S DIC("W")="W ?14,$P($$MOD^ICPTMOD(Y,""I"",IBDATE),U,3)"
"RTN","IBCU1",125,0)
 D ^DIC
"RTN","IBCU1",126,0)
 Q
"RTN","IBCU1",127,0)
 ;
"RTN","IBCU1",128,0)
QMED(IBRTN,IBIFN) ; DSS QuadraMed Interface: DSS/QuadraMed Available
"RTN","IBCU1",129,0)
 ; return 1 if QuadraMed Interface is On and available for the type of bill
"RTN","IBCU1",130,0)
 ; - routine must exist on the system (interface is 'On')
"RTN","IBCU1",131,0)
 ; Input: IBRTN = tag^routine, if it exists then Interface is 'On'
"RTN","IBCU1",132,0)
 ;        IBIFN = Bill IFN, bill to check if appropriate for sending to QuadraMed
"RTN","IBCU1",133,0)
 ;
"RTN","IBCU1",134,0)
 N IBON S IBON=0
"RTN","IBCU1",135,0)
 I +$G(IBIFN),$G(IBRTN)'="",$T(@IBRTN)'="" S IBON=1
"RTN","IBCU1",136,0)
 Q IBON
"RTN","IBECUSO")
0^14^B41082188
"RTN","IBECUSO",1,0)
IBECUSO ;RLM/DVAMC - TRICARE PHARMACY BILLING OUTPUTS ; 21-AUG-96
"RTN","IBECUSO",2,0)
 ;;2.0;INTEGRATED BILLING;**52,240,309**;21-MAR-94
"RTN","IBECUSO",3,0)
 ;
"RTN","IBECUSO",4,0)
REJ ; Generate the Pharmacy Billing Reject report.
"RTN","IBECUSO",5,0)
 ;
"RTN","IBECUSO",6,0)
 ; - quit if there are no rejects
"RTN","IBECUSO",7,0)
 I '$O(^IBA(351.52,0)) W !!,"There are no rejects to be printed." G REJQ
"RTN","IBECUSO",8,0)
 ;
"RTN","IBECUSO",9,0)
 ; - select a device
"RTN","IBECUSO",10,0)
 S %ZIS="QM" D ^%ZIS G:POP REJQ
"RTN","IBECUSO",11,0)
 I $D(IO("Q")) D  G REJQ
"RTN","IBECUSO",12,0)
 .S ZTRTN="REJDQ^IBECUSO",ZTDESC="IB - LIST TRICARE PHARMACY BILLING REJECTS"
"RTN","IBECUSO",13,0)
 .D ^%ZTLOAD W !!,$S($D(ZTSK):"This job has been queued.  The task number is "_ZTSK_".",1:"Unable to queue this job.")
"RTN","IBECUSO",14,0)
 .K ZTSK,IO("Q") D HOME^%ZIS
"RTN","IBECUSO",15,0)
 ;
"RTN","IBECUSO",16,0)
 U IO
"RTN","IBECUSO",17,0)
 ;
"RTN","IBECUSO",18,0)
REJDQ ; Tasked entry point.
"RTN","IBECUSO",19,0)
 ;
"RTN","IBECUSO",20,0)
 S (IBPAG,IBQ)=0 D REJHDR
"RTN","IBECUSO",21,0)
 ;
"RTN","IBECUSO",22,0)
 ; - print rejects
"RTN","IBECUSO",23,0)
 S IBR=0 F  S IBR=$O(^IBA(351.52,IBR)) Q:'IBR  D  Q:IBQ
"RTN","IBECUSO",24,0)
 .S IBR0=$G(^IBA(351.52,IBR,0)),IBR1=$G(^(1))
"RTN","IBECUSO",25,0)
 .Q:'IBR0
"RTN","IBECUSO",26,0)
 .;
"RTN","IBECUSO",27,0)
 .S IBRXD=$G(^PSRX(+IBR0,0)),DFN=$P(IBRXD,"^",2)
"RTN","IBECUSO",28,0)
 .Q:IBRXD=""
"RTN","IBECUSO",29,0)
 .S IBFDT=$$FDT($P(IBR0,"^"))
"RTN","IBECUSO",30,0)
 .;
"RTN","IBECUSO",31,0)
 .; - display the prescription
"RTN","IBECUSO",32,0)
 .I $Y>(IOSL-4) D PAUSE Q:IBQ  D REJHDR
"RTN","IBECUSO",33,0)
 .D REJERR
"RTN","IBECUSO",34,0)
 .;
"RTN","IBECUSO",35,0)
 .; - display errors
"RTN","IBECUSO",36,0)
 .F I=1:1 Q:$P(IBR1,",",I)=""  S IBERRP=$P(IBR1,",",I) Q:IBERRP=""  D  Q:IBQ
"RTN","IBECUSO",37,0)
 ..I $Y>(IOSL-2) D PAUSE Q:IBQ  D REJHDR,REJERR
"RTN","IBECUSO",38,0)
 ..S IBTXT=$$ERRTXT^IBECUS22(IBERRP)
"RTN","IBECUSO",39,0)
 ..I IBTXT]"" W !?4,IBTXT
"RTN","IBECUSO",40,0)
 ;
"RTN","IBECUSO",41,0)
 ; - end-of-report pause
"RTN","IBECUSO",42,0)
 D:'IBQ PAUSE
"RTN","IBECUSO",43,0)
 ;
"RTN","IBECUSO",44,0)
REJQ I '$D(ZTQUEUED) D ^%ZISC
"RTN","IBECUSO",45,0)
 K IBFDT,IBPAG,IBQ,IBR,IBR0,IBR1,IBRXD,DFN,IBERRP,IBTXT
"RTN","IBECUSO",46,0)
 Q
"RTN","IBECUSO",47,0)
 ;
"RTN","IBECUSO",48,0)
 ;
"RTN","IBECUSO",49,0)
REJHDR ; Print the Reject report header.
"RTN","IBECUSO",50,0)
 I $E(IOST,1,2)="C-"!(IBPAG) W @IOF,*13
"RTN","IBECUSO",51,0)
 S IBPAG=IBPAG+1
"RTN","IBECUSO",52,0)
 W !,$$DASH(),!,"Date: ",$$DAT1^IBOUTL(DT),?(IOM/2)-14,"IPS Unresolved Reject Report"
"RTN","IBECUSO",53,0)
 W ?(IOM-10),"Page: ",IBPAG,!,$$DASH()
"RTN","IBECUSO",54,0)
 Q
"RTN","IBECUSO",55,0)
 ;
"RTN","IBECUSO",56,0)
REJERR ; Write the prescription and name.
"RTN","IBECUSO",57,0)
 W !!,"RX# ",$P(IBRXD,"^"),", filled on ",$$DAT1^IBOUTL(IBFDT)
"RTN","IBECUSO",58,0)
 W " (",$E($P($G(^DPT(DFN,0)),"^"),1,17)," ",$P($G(^(0)),"^",9),")"
"RTN","IBECUSO",59,0)
 W " rejected because:"
"RTN","IBECUSO",60,0)
 Q
"RTN","IBECUSO",61,0)
 ;
"RTN","IBECUSO",62,0)
DASH() ; Return a dashed line.
"RTN","IBECUSO",63,0)
 Q $TR($J("",IOM)," ","=")
"RTN","IBECUSO",64,0)
 ;
"RTN","IBECUSO",65,0)
PAUSE ; Page break
"RTN","IBECUSO",66,0)
 Q:$E(IOST,1,2)'="C-"
"RTN","IBECUSO",67,0)
 N IBX,DIR,DIRUT,DUOUT,DTOUT,DIROUT,X,Y
"RTN","IBECUSO",68,0)
 F IBX=$Y:1:(IOSL-3) W !
"RTN","IBECUSO",69,0)
 S DIR(0)="E" D ^DIR I $D(DIRUT)!($D(DUOUT)) S IBQ=1
"RTN","IBECUSO",70,0)
 Q
"RTN","IBECUSO",71,0)
 ;
"RTN","IBECUSO",72,0)
 ;
"RTN","IBECUSO",73,0)
 ;
"RTN","IBECUSO",74,0)
TRN ; Generate the Pharmacy Billing Transmission Report
"RTN","IBECUSO",75,0)
 ;
"RTN","IBECUSO",76,0)
 ; - select dates
"RTN","IBECUSO",77,0)
 K DIR S DIR(0)="D^2960101:"_DT,DIR("A")="Beginning Date:" D ^DIR G:$D(DIRUT) TRNQ S IBBEG=Y
"RTN","IBECUSO",78,0)
 K DIR S DIR(0)="D^"_IBBEG_":"_DT,DIR("A")="Ending Date:" D ^DIR G:$D(DIRUT) TRNQ S IBEND=Y
"RTN","IBECUSO",79,0)
 I IBBEG>IBEND W !,"Beginning data must be before ending date.",! G TRN
"RTN","IBECUSO",80,0)
 ;
"RTN","IBECUSO",81,0)
 ; - select a device
"RTN","IBECUSO",82,0)
 S %ZIS="QM" D ^%ZIS G:POP TRNQ
"RTN","IBECUSO",83,0)
 I $D(IO("Q")) D  G TRNQ
"RTN","IBECUSO",84,0)
 .S ZTRTN="TRNDQ^IBECUSO",ZTDESC="IB - LIST TRICARE PHARMACY BILLING TRANSMISSIONS"
"RTN","IBECUSO",85,0)
 .F I="IBBEG","IBEND" S ZTSAVE(I)=""
"RTN","IBECUSO",86,0)
 .D ^%ZTLOAD W !!,$S($D(ZTSK):"This job has been queued.  The task number is "_ZTSK_".",1:"Unable to queue this job.")
"RTN","IBECUSO",87,0)
 .K ZTSK,IO("Q") D HOME^%ZIS
"RTN","IBECUSO",88,0)
 ;
"RTN","IBECUSO",89,0)
 U IO
"RTN","IBECUSO",90,0)
 ;
"RTN","IBECUSO",91,0)
TRNDQ ; Tasked entry point.
"RTN","IBECUSO",92,0)
 ;
"RTN","IBECUSO",93,0)
 S (IBPAG,IBQ)=0 D TRNHDR
"RTN","IBECUSO",94,0)
 ;
"RTN","IBECUSO",95,0)
 ; - print transactions
"RTN","IBECUSO",96,0)
 S IBC=0 F  S IBC=$O(^IBA(351.5,IBC)) Q:'IBC  D  Q:IBQ
"RTN","IBECUSO",97,0)
 .S IBCD=$G(^IBA(351.5,IBC,0)),IBCD2=$G(^(2)),IBCD5=$G(^(5)),IBCD6=$G(^(6))
"RTN","IBECUSO",98,0)
 .Q:'IBCD
"RTN","IBECUSO",99,0)
 .;
"RTN","IBECUSO",100,0)
 .S IBD=$P($G(^PSRX(+IBCD,3)),"^") I IBD="" S IBD=$P($G(^(2)),"^",2)
"RTN","IBECUSO",101,0)
 .I IBD<IBBEG Q
"RTN","IBECUSO",102,0)
 .I IBD>IBEND Q
"RTN","IBECUSO",103,0)
 .;
"RTN","IBECUSO",104,0)
 .S IBDPT(0)=$G(^DPT($P(IBCD,"^",2),0)),IBRXD=$G(^PSRX(+IBCD,0))
"RTN","IBECUSO",105,0)
 .S IBFDT=$$FDT($P(IBCD,"^"))
"RTN","IBECUSO",106,0)
 .;
"RTN","IBECUSO",107,0)
 .I $Y>(IOSL-5) D PAUSE Q:IBQ  D TRNHDR
"RTN","IBECUSO",108,0)
 .D TRNDAT
"RTN","IBECUSO",109,0)
 .D ZERO^IBRXUTL(+$P(IBRXD,"^",6))
"RTN","IBECUSO",110,0)
 .W !,"  Drug Name: ",$G(^TMP($J,"IBDRUG",+$P(IBRXD,"^",6),.01))
"RTN","IBECUSO",111,0)
 .K ^TMP($J,"IBDRUG")
"RTN","IBECUSO",112,0)
 .;
"RTN","IBECUSO",113,0)
 .W !?5,"Status: ",$S($P(IBCD6,"^")]"":"Reversed",IBCD5]"":"Rejected",1:"Accepted")
"RTN","IBECUSO",114,0)
 .;
"RTN","IBECUSO",115,0)
 .; - display errors
"RTN","IBECUSO",116,0)
 .I IBCD5]"" F I=1:1 S IBERRP=$P(IBCD5,",",I) Q:IBERRP=""  D  Q:IBQ
"RTN","IBECUSO",117,0)
 ..I $Y>(IOSL-2) D PAUSE Q:IBQ  D TRNHDR,TRNDAT
"RTN","IBECUSO",118,0)
 ..S IBTXT=$$ERRTXT^IBECUS22(IBERRP)
"RTN","IBECUSO",119,0)
 ..I IBTXT]"" W !?4,IBTXT
"RTN","IBECUSO",120,0)
 .Q:IBCD5]""
"RTN","IBECUSO",121,0)
 .;
"RTN","IBECUSO",122,0)
 .I $Y>(IOSL-3) D PAUSE Q:IBQ  D TRNHDR,TRNDAT
"RTN","IBECUSO",123,0)
 .W !,$P(IBCD,"^",4),?15,$J($P(IBCD,"^",5),6),?25,$J($P(IBCD2,"^"),6),?35,$J($P(IBCD2,"^",2),6),?45,$J($P(IBCD2,"^",3),6),?55,$J($P(IBCD2,"^",5),6)
"RTN","IBECUSO",124,0)
 .W !?15,$P(IBCD2,"^",6),?39,$P(IBCD2,"^",7)
"RTN","IBECUSO",125,0)
 .;
"RTN","IBECUSO",126,0)
 .I $P(IBCD6,"^",3)]"" F I=1:1 S IBERRP=$P($P(IBCD6,"^",3),",",I) Q:IBERRP=""  D  Q:IBQ
"RTN","IBECUSO",127,0)
 ..I $Y>(IOSL-2) D PAUSE Q:IBQ  D TRNHDR,TRNDAT
"RTN","IBECUSO",128,0)
 ..S IBTXT=$$ERRTXT^IBECUS22(IBERRP)
"RTN","IBECUSO",129,0)
 ..I IBTXT]"" W !?4,IBTXT
"RTN","IBECUSO",130,0)
 .;
"RTN","IBECUSO",131,0)
 .I $P(IBCD6,"^")]"" D
"RTN","IBECUSO",132,0)
 ..I $Y>(IOSL-1) D PAUSE Q:IBQ  D TRNHDR,TRNDAT
"RTN","IBECUSO",133,0)
 ..W !,"Reversal Authorization # ",$P(IBCD6,"^"),?40,"Reversed by: ",$P($G(^VA(200,+$P(IBCD6,"^",2),0)),"^")
"RTN","IBECUSO",134,0)
 ;
"RTN","IBECUSO",135,0)
 ; - end-of-report pause
"RTN","IBECUSO",136,0)
 D:'IBQ PAUSE
"RTN","IBECUSO",137,0)
 ;
"RTN","IBECUSO",138,0)
TRNQ I '$D(ZTQUEUED) D ^%ZISC
"RTN","IBECUSO",139,0)
 K IBPAG,IBQ,IBR,IBR0,IBR1,IBRXD,DFN,IBERRP,IBTXT,IBBEG,IBEND
"RTN","IBECUSO",140,0)
 K IBC,IBCD,IBCD2,IBCD5,IBCD6,IBDPT,IBD,IBFDT
"RTN","IBECUSO",141,0)
 Q
"RTN","IBECUSO",142,0)
 ;
"RTN","IBECUSO",143,0)
TRNHDR ; Print the Transmission Report header.
"RTN","IBECUSO",144,0)
 I $E(IOST,1,2)="C-"!(IBPAG) W @IOF,*13
"RTN","IBECUSO",145,0)
 S IBPAG=IBPAG+1
"RTN","IBECUSO",146,0)
 W !,$$DASH(),!,"Date: ",$$DAT1^IBOUTL(DT),?(IOM/2)-16,"IPS Prescription Status Report"
"RTN","IBECUSO",147,0)
 W ?(IOM-10),"Page: ",IBPAG
"RTN","IBECUSO",148,0)
 W !?(IOM/2)-17 S Y=IBBEG X ^DD("DD") W Y," through " S Y=IBEND X ^DD("DD") W Y
"RTN","IBECUSO",149,0)
 W !,"RX#",?15,"Fill Date",?27,"Patient Name",?62,"Patient SSN"
"RTN","IBECUSO",150,0)
 W !,"NDC",?15,"AWP",?25,"Copay",?35,"Ing Cost",?45,"Fee Paid",?55,"Total PD"
"RTN","IBECUSO",151,0)
 W !?15,"Auth. #",?39,"Message"
"RTN","IBECUSO",152,0)
 W !,"Reject Failure Codes"
"RTN","IBECUSO",153,0)
 W !,$$DASH(),!
"RTN","IBECUSO",154,0)
 Q
"RTN","IBECUSO",155,0)
 ;
"RTN","IBECUSO",156,0)
TRNDAT ; Display basic description information.
"RTN","IBECUSO",157,0)
 W !!,$P(IBRXD,"^"),?15,$$DAT1^IBOUTL(IBFDT)
"RTN","IBECUSO",158,0)
 W ?27,$P(IBDPT(0),"^"),?62,$P(IBDPT(0),"^",9)
"RTN","IBECUSO",159,0)
 Q
"RTN","IBECUSO",160,0)
 ;
"RTN","IBECUSO",161,0)
FDT(X) ; Find the Fill Date for the prescription.
"RTN","IBECUSO",162,0)
 ;  Input:  X  --  1;2   where 1 :> pointer to the rx in file #52, and
"RTN","IBECUSO",163,0)
 ;                             2 :> pointer to the re-fill in #52.1, or
"RTN","IBECUSO",164,0)
 ;                                  0 if this is the original fill.
"RTN","IBECUSO",165,0)
 N Y S Y=""
"RTN","IBECUSO",166,0)
 I $G(X)="" G FDTQ
"RTN","IBECUSO",167,0)
 I $P(X,";",2) S Y=$P($G(^PSRX(+X,1,$P(X,";",2),0)),"^") G FDTQ
"RTN","IBECUSO",168,0)
 S Z2=$G(^PSRX(+X,2)),Z3=$G(^(3))
"RTN","IBECUSO",169,0)
 S Y=$S($P(Z2,"^",2):$P(Z2,"^",2),+Z3:+Z3,$P(Z2,"^",5):$P(Z2,"^",5),1:"")
"RTN","IBECUSO",170,0)
FDTQ Q Y
"RTN","IBECUSO",171,0)
 ;
"RTN","IBECUSO",172,0)
AWP ;
"RTN","IBECUSO",173,0)
 I '$D(^JADUTIL("AWP UPDATE")) W !,"No updates on file" Q
"RTN","IBECUSO",174,0)
 W !,"Date         Quantity"
"RTN","IBECUSO",175,0)
 S A="" F  S A=$O(^JADUTIL("AWP UPDATE",A)) Q:'A  D
"RTN","IBECUSO",176,0)
 .I A<($P($H,",")-52) K ^JADUTIL("AWP UPDATE",A) Q
"RTN","IBECUSO",177,0)
 .S %H=A D YMD^%DTC S Y=X X ^DD("DD")
"RTN","IBECUSO",178,0)
 .W !,Y,"  ",^JADUTIL("AWP UPDATE",A)
"RTN","IBECUSO",179,0)
 Q
"RTN","IBECUSO",180,0)
 ;
"RTN","IBECUSO",181,0)
 ;
"RTN","IBECUSO",182,0)
 ;
"RTN","IBECUSO",183,0)
REM ; Delete rejects.
"RTN","IBECUSO",184,0)
 W !!,"Delete entry from IPS error file"
"RTN","IBECUSO",185,0)
 W !,"Delete RX#: " R JADTA:DTIME Q:JADTA=""!(JADTA="^")
"RTN","IBECUSO",186,0)
 I '$D(^JADREJ(JADTA)) W !,JADTA," is not in the error file." G REM
"RTN","IBECUSO",187,0)
 K ^JADREJ(JADTA) W !,JADTA," has been deleted." G REM
"RTN","IBECUSO",188,0)
 Q
"RTN","IBJTBA")
0^15^B47561481
"RTN","IBJTBA",1,0)
IBJTBA ;ALB/ARH - TPI BILL CHARGE INFO SCREEN ;01-MAR-1995
"RTN","IBJTBA",2,0)
 ;;2.0;INTEGRATED BILLING;**39,80,51,137,135,309**;21-MAR-94
"RTN","IBJTBA",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBJTBA",4,0)
 ;
"RTN","IBJTBA",5,0)
EN ; -- main entry point for IBJ TP BILL CHARGES
"RTN","IBJTBA",6,0)
 D EN^VALM("IBJT BILL CHARGES")
"RTN","IBJTBA",7,0)
 Q
"RTN","IBJTBA",8,0)
 ;
"RTN","IBJTBA",9,0)
HDR ; -- header code
"RTN","IBJTBA",10,0)
 D HDR^IBJTU1(+IBIFN,+DFN,12)
"RTN","IBJTBA",11,0)
 Q
"RTN","IBJTBA",12,0)
 ;
"RTN","IBJTBA",13,0)
INIT ; -- init variables and list array
"RTN","IBJTBA",14,0)
 N IBOK,IBEOBDET
"RTN","IBJTBA",15,0)
 K ^TMP("IBJTBA",$J) N IBFT
"RTN","IBJTBA",16,0)
 I '$G(DFN)!'$G(IBIFN) S VALMQUIT="" G INITQ
"RTN","IBJTBA",17,0)
 S IBFT=+$P($G(^DGCR(399,+IBIFN,0)),U,19),IBOK=1
"RTN","IBJTBA",18,0)
 I $D(^IBM(361.1,"B",IBIFN))!$D(^IBM(361.1,"C",IBIFN)) D  G:'IBOK INITQ
"RTN","IBJTBA",19,0)
 . S DIR("A")="DO YOU WANT ALL EEOB DETAILS?: ",DIR("B")="NO",DIR(0)="YA"
"RTN","IBJTBA",20,0)
 . D FULL^VALM1 W ! D ^DIR K DIR
"RTN","IBJTBA",21,0)
 . I $D(DTOUT)!$D(DUOUT) S IBOK=0 Q
"RTN","IBJTBA",22,0)
 . S IBEOBDET=+Y
"RTN","IBJTBA",23,0)
 D BLD
"RTN","IBJTBA",24,0)
INITQ Q
"RTN","IBJTBA",25,0)
 ;
"RTN","IBJTBA",26,0)
MRA ; -- mra/eob
"RTN","IBJTBA",27,0)
 N IBI,Z,IBSTR,IBSHEOB,IBCT
"RTN","IBJTBA",28,0)
 S IBCT=0
"RTN","IBJTBA",29,0)
 S IBI=0 F  S IBI=$O(^IBM(361.1,"B",IBIFN,IBI)) Q:'IBI  S Z=+$O(^IBM(361.1,IBI,8,0)) I '$O(^(Z)) S IBCT=IBCT+1,IBSHEOB(IBI)=0  ; Entire EOB belongs to the bill
"RTN","IBJTBA",30,0)
 S IBI=0 F  S IBI=$O(^IBM(361.1,"C",IBIFN,IBI)) Q:'IBI  S IBCT=IBCT+1,IBSHEOB(IBI)=1 ; EOB has been reapportioned at the site
"RTN","IBJTBA",31,0)
 I 'IBCT D
"RTN","IBJTBA",32,0)
 . S IBSTR=$$SETLN("No EEOB/MRA Information","",1,79)
"RTN","IBJTBA",33,0)
 . S IBLN=$$SET(IBSTR,IBLN)
"RTN","IBJTBA",34,0)
 I IBCT D
"RTN","IBJTBA",35,0)
 . S Z=0
"RTN","IBJTBA",36,0)
 . S IBI=0 F  S IBI=$O(IBSHEOB(IBI)) Q:'IBI  S Z=Z+1 D SHEOB^IBJTBA1(IBI,+IBSHEOB(IBI),Z,IBCT)
"RTN","IBJTBA",37,0)
 ;
"RTN","IBJTBA",38,0)
 Q
"RTN","IBJTBA",39,0)
 ;
"RTN","IBJTBA",40,0)
HELP ; -- help code
"RTN","IBJTBA",41,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","IBJTBA",42,0)
 Q
"RTN","IBJTBA",43,0)
 ;
"RTN","IBJTBA",44,0)
EXIT ; -- exit code
"RTN","IBJTBA",45,0)
 K ^TMP("IBJTBA",$J)
"RTN","IBJTBA",46,0)
 D CLEAR^VALM1
"RTN","IBJTBA",47,0)
 Q
"RTN","IBJTBA",48,0)
 ;
"RTN","IBJTBA",49,0)
BLD ; charges, as they would display on the bill
"RTN","IBJTBA",50,0)
 N IBXDATA,IBXSAVE
"RTN","IBJTBA",51,0)
 I $P($G(^DGCR(399,+IBIFN,0)),U,19)=2 D H1500 Q
"RTN","IBJTBA",52,0)
 D UB92
"RTN","IBJTBA",53,0)
 K ^TMP("IBXSAVE",$J)
"RTN","IBJTBA",54,0)
 Q
"RTN","IBJTBA",55,0)
 ;
"RTN","IBJTBA",56,0)
H1500 ; block 24
"RTN","IBJTBA",57,0)
 N X,IBI,IBJ,IBLN,IBX,IBSTR,IBLKLN,IBPFORM,IBLIN
"RTN","IBJTBA",58,0)
 K ^TMP("IBXSAVE",$J)
"RTN","IBJTBA",59,0)
 S IBLIN=$$BOX24D^IBCEF11("",1),IBLKLN=0,IBLN=1
"RTN","IBJTBA",60,0)
 Q:'$G(IBIFN)  K ^TMP("IBXDISP",$J)
"RTN","IBJTBA",61,0)
 S IBPFORM=$S($P($G(^IBE(353,2,2)),U,8):$P(^(2),U,8),1:2),IBLN=1
"RTN","IBJTBA",62,0)
 S IBX=$$BILLN^IBCEFG0(1,"1^99",IBLIN,+IBIFN,IBPFORM)
"RTN","IBJTBA",63,0)
 S IBI=$O(^TMP("IBXDISP",$J,""),-1)
"RTN","IBJTBA",64,0)
 S IBJ="" F  S IBJ=$O(^TMP("IBXDISP",$J,IBI,IBJ),-1) Q:$S('IBJ:1,1:$TR($G(^(IBJ))," ")'="")  K ^TMP("IBXDISP",$J,IBI,IBJ)
"RTN","IBJTBA",65,0)
 I '$O(^TMP("IBXDISP",$J,IBI,0)) S VALMSG="No charges or procedures defined.",VALMQUIT="" G H1500Q
"RTN","IBJTBA",66,0)
 S IBI="" F  S IBI=$O(^TMP("IBXDISP",$J,IBI)) Q:'IBI  S IBJ=0 F  S IBJ=$O(^TMP("IBXDISP",$J,IBI,IBJ)) Q:'IBJ  D
"RTN","IBJTBA",67,0)
 . S IBX=$G(^TMP("IBXDISP",$J,IBI,IBJ)),IBLN=$$SET(IBX,IBLN)
"RTN","IBJTBA",68,0)
 K ^TMP("IBXDISP",$J)
"RTN","IBJTBA",69,0)
 D COB,MRA
"RTN","IBJTBA",70,0)
 I $$ISRX^IBCEF1(IBIFN) D RX
"RTN","IBJTBA",71,0)
 I $$ISPROS^IBCEF1(IBIFN) D PROS
"RTN","IBJTBA",72,0)
 S VALMCNT=IBLN-1
"RTN","IBJTBA",73,0)
H1500Q Q
"RTN","IBJTBA",74,0)
 ;
"RTN","IBJTBA",75,0)
UB92 ;form locator 42-49,   IBIFN required
"RTN","IBJTBA",76,0)
 N X,Y,DIR,IBI,IBJ,IBX,IBLN,IBLC,IBLIN,IBPFORM,IBSTATE,IBCBILL,IBINPAT,IBQ,Z,Z0
"RTN","IBJTBA",77,0)
 K ^TMP("IBXSAVE",$J)
"RTN","IBJTBA",78,0)
 S IBLIN=$$RCBOX^IBCEF11()
"RTN","IBJTBA",79,0)
 S IBQ=0,IBLC=9 Q:'$G(IBIFN)  K ^TMP("IBXDISP",$J)
"RTN","IBJTBA",80,0)
 S IBPFORM=$S($P($G(^IBE(353,3,2)),U,8):$P(^(2),U,8),1:3)
"RTN","IBJTBA",81,0)
 S IBX=$$BILLN^IBCEFG0(1,"1^99",IBLIN,+IBIFN,IBPFORM)
"RTN","IBJTBA",82,0)
 I '$O(^TMP("IBXDISP",$J,0)) S VALMSG="No charges defined.",VALMQUIT="" G UB92Q
"RTN","IBJTBA",83,0)
 S Z="" F  S Z=$O(^TMP("IBXDISP",$J,1,Z),-1) Q:Z=""  S Z0=$G(^(Z)) Q:$TR(Z0," ")'=""  K ^(Z)
"RTN","IBJTBA",84,0)
 S:Z ^TMP("IBXDISP",$J,1,Z+1)=" "
"RTN","IBJTBA",85,0)
 S IBINPAT=$$INPAT^IBCEF(IBIFN,1)
"RTN","IBJTBA",86,0)
 S IBSTATE=$G(^DGCR(399,IBIFN,"U")),IBCBILL=$G(^DGCR(399,IBIFN,0))
"RTN","IBJTBA",87,0)
 ;
"RTN","IBJTBA",88,0)
 S (VALMCNT,IBLN)=1,IBLKLN=0
"RTN","IBJTBA",89,0)
 I +IBINPAT D  S IBLN=$$SET(IBSTR,IBLN)
"RTN","IBJTBA",90,0)
 . S IBX=$P(IBSTATE,U,15),IBSTR=+IBX_" DAY"_$S(IBX'=1:"S",1:"")_" INPATIENT CARE"
"RTN","IBJTBA",91,0)
 . S IBX=$$LOS^IBCU64(+IBSTATE,+$P(IBSTATE,U,2),+$P(IBCBILL,U,6)),IBX=IBX-$$LOS1^IBCU64(IBIFN) I IBX>0 S IBSTR=IBSTR_$J("Pass Days: "_IBX,55)
"RTN","IBJTBA",92,0)
 ;
"RTN","IBJTBA",93,0)
 S IBI="" F  S IBI=$O(^TMP("IBXDISP",$J,IBI)) Q:'IBI  S IBJ=0 F  S IBJ=$O(^TMP("IBXDISP",$J,IBI,IBJ)) Q:'IBJ  D
"RTN","IBJTBA",94,0)
 . S IBX=$G(^TMP("IBXDISP",$J,IBI,IBJ)),IBLN=$$SET(IBX,IBLN)
"RTN","IBJTBA",95,0)
 . I $E(IBX,1,3)="001" D COB
"RTN","IBJTBA",96,0)
 ;
"RTN","IBJTBA",97,0)
 K ^TMP("IBXDISP",$J)
"RTN","IBJTBA",98,0)
 ;
"RTN","IBJTBA",99,0)
 D MRA
"RTN","IBJTBA",100,0)
 S VALMCNT=IBLN-1
"RTN","IBJTBA",101,0)
UB92Q Q
"RTN","IBJTBA",102,0)
 ;
"RTN","IBJTBA",103,0)
SETLN(STR,IBX,COL,WD) ;
"RTN","IBJTBA",104,0)
 S IBX=$$SETSTR^VALM1(STR,IBX,COL,WD)
"RTN","IBJTBA",105,0)
 Q IBX
"RTN","IBJTBA",106,0)
 ;
"RTN","IBJTBA",107,0)
SET(STR,LN) ; set up TMP array with screen data (allows 2 blank lines, if not at end of array)
"RTN","IBJTBA",108,0)
 N IBX,IBI I STR?80" " S IBLKLN=IBLKLN+1 G SETQ
"RTN","IBJTBA",109,0)
 F IBI=1:1:IBLKLN D SET^VALM10(LN," ") S LN=LN+1 Q:IBI>1
"RTN","IBJTBA",110,0)
 D SET^VALM10(LN,STR)
"RTN","IBJTBA",111,0)
 S LN=LN+1,IBLKLN=0
"RTN","IBJTBA",112,0)
SETQ Q LN
"RTN","IBJTBA",113,0)
 ;
"RTN","IBJTBA",114,0)
COB ; if there is an offset or a secondary/tertiary payer add it to the display, with ins co, and prior bill #
"RTN","IBJTBA",115,0)
 ; IBIFN and IBLN must exist upon entry, IBLN is updated with new line count
"RTN","IBJTBA",116,0)
 N IBM,IBM1,IBI,IBJ,IBD,IBSTR,IBCU2,IBCU1 Q:'$G(IBIFN)
"RTN","IBJTBA",117,0)
 S IBM=$G(^DGCR(399,IBIFN,"M")),IBM1=$G(^DGCR(399,IBIFN,"M1"))
"RTN","IBJTBA",118,0)
 S IBCU2=$G(^DGCR(399,IBIFN,"U2")),IBCU1=$G(^DGCR(399,IBIFN,"U1"))
"RTN","IBJTBA",119,0)
 S IBJ=$P($G(^DGCR(399,IBIFN,0)),U,21),IBJ=$S(IBJ="P":3,IBJ="S":3,IBJ="T":3,1:0),IBSTR=""
"RTN","IBJTBA",120,0)
 I +$P(IBM,U,2)!(+$P(IBM,U,3)) F IBI=1:1:IBJ I +$P(IBM,U,IBI) D  S IBLN=$$SET(IBSTR,IBLN)
"RTN","IBJTBA",121,0)
 . I IBSTR="" S IBLN=$$SET("",IBLN)
"RTN","IBJTBA",122,0)
 . S IBD=$S(IBI=1:"Primary",IBI=2:"Secondary",1:"Tertiary")_": " S IBSTR=$$SETLN(IBD,"",5,11)
"RTN","IBJTBA",123,0)
 . S IBD=$P($G(^DIC(36,+$P(IBM,U,IBI),0)),U,1) S IBSTR=$$SETLN(IBD,IBSTR,17,25)
"RTN","IBJTBA",124,0)
 . I $P(IBCU2,U,(IBI+3))'="" S IBD=$J(+$P(IBCU2,U,(IBI+3)),9,2) S IBSTR=$$SETLN(IBD,IBSTR,44,11)
"RTN","IBJTBA",125,0)
 . I $P(IBM1,U,(IBI+4))'="" S IBD=$$BN1^PRCAFN(+$P(IBM1,U,(IBI+4))) S IBSTR=$$SETLN(IBD,IBSTR,60,11)
"RTN","IBJTBA",126,0)
 I +$P(IBCU1,U,2) D  S IBLN=$$SET(IBSTR,IBLN)
"RTN","IBJTBA",127,0)
 . I IBSTR="" S IBLN=$$SET("",IBLN)
"RTN","IBJTBA",128,0)
 . S IBD="Offset: " S IBSTR=$$SETLN(IBD,"",5,11)
"RTN","IBJTBA",129,0)
 . S IBD=$P(IBCU1,U,3) S IBSTR=$$SETLN(IBD,IBSTR,17,25)
"RTN","IBJTBA",130,0)
 . S IBD=$J($P(IBCU1,U,2),9,2) S IBSTR=$$SETLN(IBD,IBSTR,44,11)
"RTN","IBJTBA",131,0)
 . S IBD=$P(IBCU1,U,1)-$P(IBCU1,U,2),IBD="Billed: "_$J(IBD,0,2) S IBSTR=$$SETLN(IBD,IBSTR,60,17)
"RTN","IBJTBA",132,0)
 Q
"RTN","IBJTBA",133,0)
 ;
"RTN","IBJTBA",134,0)
RX ;RX refill info for HCFA 1500 TPJI display
"RTN","IBJTBA",135,0)
 N Z,Z0,Z1,IBSPC,IBD,IBI,IBSTR,IBARRAY,IBRXX
"RTN","IBJTBA",136,0)
 S IBLN=IBLN+1
"RTN","IBJTBA",137,0)
 S IBSPC=$J("",5)
"RTN","IBJTBA",138,0)
 D SET^IBCSC5A(IBIFN,.IBARRAY)
"RTN","IBJTBA",139,0)
 I $D(IBARRAY) D
"RTN","IBJTBA",140,0)
 . S (Z,Z0)=0 F  S Z0=$O(IBARRAY(Z0)) Q:Z0=""  S Z1=0 F  S Z1=$O(IBARRAY(Z0,Z1)) Q:'Z1  S Z=Z+1 S IBXDATA(Z)=$$DAT1^IBOUTL(Z1)_U_$G(IBARRAY(Z0,Z1))
"RTN","IBJTBA",141,0)
 S IBD=$$SET("",IBLN)
"RTN","IBJTBA",142,0)
 S IBD="PRESCRIPTION REFILLS: (For TPJI display only)"
"RTN","IBJTBA",143,0)
 S IBSTR=$$SETLN(IBD,"",1,79),IBLN=$$SET(IBSTR,IBLN)
"RTN","IBJTBA",144,0)
 S IBI=0 F  S IBI=$O(IBXDATA(IBI)) Q:IBI=""  D
"RTN","IBJTBA",145,0)
 . S IBRXX=$G(IBXDATA(IBI))
"RTN","IBJTBA",146,0)
 . D ZERO^IBRXUTL($P(IBRXX,U,3))
"RTN","IBJTBA",147,0)
 . S IBD=$J($P(IBRXX,U,7),9,2)_IBSPC_$P(IBRXX,U)_IBSPC_$G(^TMP($J,"IBDRUG",+$P(IBRXX,U,3),.01))
"RTN","IBJTBA",148,0)
 . K ^TMP($J,"IBDRUG")
"RTN","IBJTBA",149,0)
 . S IBSTR=$$SETLN(IBD,"",1,79),IBLN=$$SET(IBSTR,IBLN)
"RTN","IBJTBA",150,0)
 . S IBD="QTY: "_$P(IBRXX,U,5)_" for "_$P(IBRXX,U,4)_" days supply "_"NDC# "_$P(IBRXX,U,6)
"RTN","IBJTBA",151,0)
 . S IBSTR=$$SETLN(IBD,"",23,79),IBLN=$$SET(IBSTR,IBLN)
"RTN","IBJTBA",152,0)
 Q
"RTN","IBJTBA",153,0)
 ;
"RTN","IBJTBA",154,0)
PROS ;prosthetic info for HCFA 1500 TPJI display
"RTN","IBJTBA",155,0)
 N Z,Z0,Z1,IBARRAY,IBSPC,IBD,IBI,IBSTR
"RTN","IBJTBA",156,0)
 S IBSPC=$J("",10),IBLN=IBLN+1
"RTN","IBJTBA",157,0)
 D SET^IBCSC5B(IBIFN,.IBARRAY)
"RTN","IBJTBA",158,0)
 I $D(IBARRAY) D
"RTN","IBJTBA",159,0)
 . S (Z,Z0)=0 F  S Z0=$O(IBARRAY(Z0)) Q:Z0=""  S Z1=0 F  S Z1=$O(IBARRAY(Z0,Z1)) Q:'Z1  S Z=Z+1,IBXDATA(Z)=$$DAT1^IBOUTL(Z0)_U_$E($P($$PIN^IBCSC5B(Z1),U,2),1,39)
"RTN","IBJTBA",160,0)
 S IBD=$$SET("",IBLN)
"RTN","IBJTBA",161,0)
 S IBD="PROSTHETIC REFILLS: (For TPJI display only)"
"RTN","IBJTBA",162,0)
 S IBSTR=$$SETLN(IBD,"",1,79),IBLN=$$SET(IBSTR,IBLN)
"RTN","IBJTBA",163,0)
 S IBI=0 F  S IBI=$O(IBXDATA(IBI)) Q:IBI=""  D
"RTN","IBJTBA",164,0)
 . S IBD=$P(IBXDATA(IBI),U)_IBSPC_$P(IBXDATA(IBI),U,2)
"RTN","IBJTBA",165,0)
 . S IBSTR=$$SETLN(IBD,"",1,79),IBLN=$$SET(IBSTR,IBLN)
"RTN","IBJTBA",166,0)
 Q
"RTN","IBJTBA",167,0)
 ;
"RTN","IBRFN")
0^23^B32970869
"RTN","IBRFN",1,0)
IBRFN ;ALB/AAS - Supported functions for AR ;5-MAY-1992
"RTN","IBRFN",2,0)
 ;;2.0;INTEGRATED BILLING;**52,130,183,223,309**;21-MAR-94
"RTN","IBRFN",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBRFN",4,0)
 ;
"RTN","IBRFN",5,0)
ERR(Y) ;  - input Y = -1^error code[;error code...]^literal message
"RTN","IBRFN",6,0)
 ;  - output IBRERR = error message 1
"RTN","IBRFN",7,0)
 ;         if more than one code then
"RTN","IBRFN",8,0)
 ;           IBRERR(n)=error code n
"RTN","IBRFN",9,0)
 N N,X,X1,X2 K IBRERR S IBRERR=""
"RTN","IBRFN",10,0)
 G:+Y>0 ERRQ
"RTN","IBRFN",11,0)
 S X2=$P(Y,"^",2) F N=1:1 S X=$P(X2,";",N) Q:X=""  S X1=$P($G(^IBE(350.8,+$O(^IBE(350.8,"AC",X,0)),0)),"^",2) D
"RTN","IBRFN",12,0)
 .I N=1 S IBRERR=X1
"RTN","IBRFN",13,0)
 .I $P(Y,"^",3)]""!($P(X2,";",2,99)]"") S IBRERR(N)=X1
"RTN","IBRFN",14,0)
 I $P(Y,"^",3)]"" S N=N+1,IBRERR(N)=$P(Y,"^",3)
"RTN","IBRFN",15,0)
ERRQ Q IBRERR
"RTN","IBRFN",16,0)
 ;
"RTN","IBRFN",17,0)
MESS(Y) ;  -input y=error code - from file 350.8 (piece 3)
"RTN","IBRFN",18,0)
 ;   output error message
"RTN","IBRFN",19,0)
 Q $P($G(^IBE(350.8,+$O(^IBE(350.8,"AC",Y,0)),0)),"^",2)
"RTN","IBRFN",20,0)
 ;
"RTN","IBRFN",21,0)
SVDT(BN,VDT) ;returns service dates for a specific bill
"RTN","IBRFN",22,0)
 ;- input:  BN bill number (external form)
"RTN","IBRFN",23,0)
 ;          VDT name of array to hold outpatient visit dates, pass by value (if needed)
"RTN","IBRFN",24,0)
 ;- output: X function value, string, = 0 if bill not found
"RTN","IBRFN",25,0)
 ;            = 1 (Inpt) or 2 (Outpt)^event date^stmt from date^stmt to date^LOS (I)^Number of visit dates (O)
"RTN","IBRFN",26,0)
 ;              all are internal form, any piece may be null if not defined for the bill
"RTN","IBRFN",27,0)
 ;          array containing outpatient visit dates as subscripts/no data, if VDT passed by value
"RTN","IBRFN",28,0)
 N X,Y,IFN S X=0,BN=$G(BN)
"RTN","IBRFN",29,0)
 I BN'="" S IFN=+$O(^DGCR(399,"B",BN,0)),Y=$G(^DGCR(399,IFN,0)) I Y'="" D
"RTN","IBRFN",30,0)
 . S X=$S(+$P(Y,U,5)<1:"",+$P(Y,U,5)<3:1,+$P(Y,U,5)<5:2,1:"")_U_$P(Y,U,3),Y=$G(^DGCR(399,IFN,"U"))
"RTN","IBRFN",31,0)
 . S X=X_U_$P(Y,U,1)_U_$P(Y,U,2)_U_$P(Y,U,15)_U_$P($G(^DGCR(399,IFN,"OP",0)),U,4)
"RTN","IBRFN",32,0)
 . S Y=0 F  S Y=$O(^DGCR(399,IFN,"OP",Y)) Q:'Y  S VDT(Y)=""
"RTN","IBRFN",33,0)
 Q X
"RTN","IBRFN",34,0)
 ;
"RTN","IBRFN",35,0)
 ;
"RTN","IBRFN",36,0)
REC(IBSTR,IBTYPE) ; Find the AR for an Authorization or Rx number
"RTN","IBRFN",37,0)
 ;   Input:   IBSTR  --   FI Authorization Number or Rx Number
"RTN","IBRFN",38,0)
 ;  Output:    IBAR  --   >0 => ptr to claim/AR in files 399/430
"RTN","IBRFN",39,0)
 ;                        -1 => No receivable found
"RTN","IBRFN",40,0)
 ;           IBTYPE (by ref) - how the IBSTR was recognized: 1-Auth,2-ECME,3-Rx#,0-Unknown
"RTN","IBRFN",41,0)
 ;
"RTN","IBRFN",42,0)
 N IBAR,IBARR,IBRX,IBKEY,IBKEYS,IBREF
"RTN","IBRFN",43,0)
 S IBAR=-1
"RTN","IBRFN",44,0)
 S IBTYPE=0
"RTN","IBRFN",45,0)
 I $G(IBSTR)="" G RECQ
"RTN","IBRFN",46,0)
 S IBAR=$$AREC(IBSTR) I IBAR>0 S IBTYPE=1 G RECQ
"RTN","IBRFN",47,0)
 ;
"RTN","IBRFN",48,0)
 ; - look for ecme number
"RTN","IBRFN",49,0)
 S IBAR=$$EREC(IBSTR) I IBAR>0 S IBTYPE=2 G RECQ
"RTN","IBRFN",50,0)
 ;
"RTN","IBRFN",51,0)
 ; - treat as an rx number
"RTN","IBRFN",52,0)
 S IBTYPE=3
"RTN","IBRFN",53,0)
 S IBRX=$O(^PSRX("B",IBSTR,0)) I 'IBRX G RECQ
"RTN","IBRFN",54,0)
 S (IBKEY,IBKEYS)=IBRX_";"
"RTN","IBRFN",55,0)
 F  S IBKEY=$O(^IBA(351.5,"B",IBKEY)) Q:$E(IBKEY,1,$L(IBKEYS))'=IBKEYS  S IBARR(IBKEY)=+$O(^(IBKEY,0))
"RTN","IBRFN",56,0)
 ;
"RTN","IBRFN",57,0)
 S IBKEY=$O(IBARR("")) I IBKEY="" G RECQ
"RTN","IBRFN",58,0)
 I $O(IBARR(IBKEY))="" S IBAR=$P($G(^IBA(351.5,IBARR(IBKEY),0)),"^",9) S:'IBAR IBAR=-1 G RECQ
"RTN","IBRFN",59,0)
 ;
"RTN","IBRFN",60,0)
 W !!,"More than one fill for rx# ",IBSTR," has been billed."
"RTN","IBRFN",61,0)
 S IBREF=$$SEL^IBECUSMU(.IBARR)
"RTN","IBRFN",62,0)
 I IBREF<0 G RECQ
"RTN","IBRFN",63,0)
 ;
"RTN","IBRFN",64,0)
 S IBAR=$P($G(^IBA(351.5,+$G(IBARR(IBRX_";"_IBREF)),0)),"^",9)
"RTN","IBRFN",65,0)
 S:'IBAR IBAR=-1
"RTN","IBRFN",66,0)
 ;
"RTN","IBRFN",67,0)
RECQ Q IBAR
"RTN","IBRFN",68,0)
 ;
"RTN","IBRFN",69,0)
 ;
"RTN","IBRFN",70,0)
AREC(AUTH) ; Find the Receivable for a TRICARE FI Authorization Number
"RTN","IBRFN",71,0)
 ;   Input:    AUTH  --   Fiscal Intermediary Authorization Number
"RTN","IBRFN",72,0)
 ;  Output:   IBIFN  --   >0 => ptr to claim/AR in files 399/430
"RTN","IBRFN",73,0)
 ;                        -1 => No receivable found
"RTN","IBRFN",74,0)
 ;
"RTN","IBRFN",75,0)
 N IBIFN
"RTN","IBRFN",76,0)
 S IBIFN=-1
"RTN","IBRFN",77,0)
 I $G(AUTH)="" G ARECQ
"RTN","IBRFN",78,0)
 S IBIFN=$P($G(^IBA(351.5,+$O(^IBA(351.5,"AUTH",AUTH,0)),0)),"^",9)
"RTN","IBRFN",79,0)
 S:'IBIFN IBIFN=-1
"RTN","IBRFN",80,0)
ARECQ Q IBIFN
"RTN","IBRFN",81,0)
 ;
"RTN","IBRFN",82,0)
 ;
"RTN","IBRFN",83,0)
EREC(AUTH) ; Find the Receivable for an ECME FI Number
"RTN","IBRFN",84,0)
 ;   Input:    AUTH  --   Fiscal Intermediary ECME Number
"RTN","IBRFN",85,0)
 ;  Output:   IBIFN  --   >0 => ptr to claim/AR in files 399/430
"RTN","IBRFN",86,0)
 ;                        -1 => No receivable found
"RTN","IBRFN",87,0)
 ;
"RTN","IBRFN",88,0)
 N IBIFN,IBC,IBX,IBA,IBE,IBES
"RTN","IBRFN",89,0)
 S IBIFN=-1,IBC=0
"RTN","IBRFN",90,0)
 I $G(AUTH)="" G ARECQ
"RTN","IBRFN",91,0)
 S (IBE,IBES)=AUTH_";"
"RTN","IBRFN",92,0)
 F  S IBE=$O(^DGCR(399,"AG",IBE)) Q:IBE'[IBES  D
"RTN","IBRFN",93,0)
 . S IBX=0 F  S IBX=$O(^DGCR(399,"AG",IBE,IBX)) Q:'IBX  D
"RTN","IBRFN",94,0)
 . . I $P($G(^DGCR(399,IBX,"S")),U,16) Q  ; Exclude canceled bills
"RTN","IBRFN",95,0)
 . . S IBA(IBX)="",IBC=IBC+1
"RTN","IBRFN",96,0)
 I IBC'>1 S IBIFN=$O(IBA(0)) G ERECQ  ; only one found
"RTN","IBRFN",97,0)
 W !!,"More than one fill for ECME# ",AUTH," has been billed."
"RTN","IBRFN",98,0)
 S IBIFN=$$SEL(.IBA)
"RTN","IBRFN",99,0)
ERECQ S:'IBIFN IBIFN=-1
"RTN","IBRFN",100,0)
 D EDTL(IBIFN,AUTH) ;details
"RTN","IBRFN",101,0)
 Q IBIFN
"RTN","IBRFN",102,0)
 ;
"RTN","IBRFN",103,0)
EDTL(IBIFN,AUTH) ;Details
"RTN","IBRFN",104,0)
 Q:IBIFN'>0  Q:AUTH=""
"RTN","IBRFN",105,0)
 N IBZ,IBBIL,IBPAT,IBPATN,IBRX,IB3624,IBDRUG,IBQTY,IBDAT,DIR
"RTN","IBRFN",106,0)
 S IBZ=$G(^DGCR(399,IBIFN,0))
"RTN","IBRFN",107,0)
 S IBBIL=$P(IBZ,U),IBPAT=$P(IBZ,U,2),IBDAT=$P(IBZ,U,3)
"RTN","IBRFN",108,0)
 S IBPATN=$P($G(^DPT(+IBPAT,0)),U)
"RTN","IBRFN",109,0)
 S IB3624=$G(^IBA(362.4,+$O(^IBA(362.4,"C",IBIFN,"")),0))
"RTN","IBRFN",110,0)
 D ZERO^IBRXUTL(+$P(IB3624,U,4))
"RTN","IBRFN",111,0)
 S IBDRUG=$G(^TMP($J,"IBDRUG",+$P(IB3624,U,4),.01))
"RTN","IBRFN",112,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBRFN",113,0)
 S IBRX=$P($G(^PSRX(+$P(IB3624,U,5),0)),U)
"RTN","IBRFN",114,0)
 S IBQTY=+$P(IB3624,U,7)
"RTN","IBRFN",115,0)
 W !!,"Found IB Bill ",IBBIL," matching to ECME# '",AUTH,"':"
"RTN","IBRFN",116,0)
 W !,"Rx#",IBRX," ",$$DAT3^IBOUTL(IBDAT),", ",IBPATN,", ",IBDRUG I IBQTY W " (",IBQTY,")"
"RTN","IBRFN",117,0)
 Q
"RTN","IBRFN",118,0)
 ;
"RTN","IBRFN",119,0)
AUD(IBIFN) ; Does the Accounts Receivable need to be audited?
"RTN","IBRFN",120,0)
 ;   Input:   IBIFN  --   ptr to claim/AR in files 399/430
"RTN","IBRFN",121,0)
 ;  Output:          --   0 => Claim does not have to be audited
"RTN","IBRFN",122,0)
 ;                             (claim was set up automatically)
"RTN","IBRFN",123,0)
 ;                        1 => Claim must be audited
"RTN","IBRFN",124,0)
 ;                             (claim was established manually)
"RTN","IBRFN",125,0)
 ;
"RTN","IBRFN",126,0)
AUDQ Q $O(^IBA(351.5,"ACL",+$G(IBIFN),0))'>0
"RTN","IBRFN",127,0)
 ;
"RTN","IBRFN",128,0)
 ;
"RTN","IBRFN",129,0)
TYP(IBIFN) ; Determine the bill type for an Accounts Receivable.
"RTN","IBRFN",130,0)
 ;   Input:   IBIFN  --   ptr to claim/AR in files 399/430
"RTN","IBRFN",131,0)
 ;  Output:          --   I => Inpatient bill
"RTN","IBRFN",132,0)
 ;                        O => Outpatient bill
"RTN","IBRFN",133,0)
 ;                       PH => Pharmacy bill
"RTN","IBRFN",134,0)
 ;                       PR => Prosthetics bill
"RTN","IBRFN",135,0)
 ;
"RTN","IBRFN",136,0)
 ;                       or -1 if the bill type can't be determined.
"RTN","IBRFN",137,0)
 ;
"RTN","IBRFN",138,0)
 N IBATYP,IBATYPN,IBBG,IBN,IBND,IBTYP,IBX
"RTN","IBRFN",139,0)
 S IBTYP=-1
"RTN","IBRFN",140,0)
 I '$G(IBIFN) G TYPQ
"RTN","IBRFN",141,0)
 ;
"RTN","IBRFN",142,0)
 ; - see if AR originated from file #399
"RTN","IBRFN",143,0)
 S IBX=$G(^DGCR(399,IBIFN,0))
"RTN","IBRFN",144,0)
 I IBX]"" D  G TYPQ
"RTN","IBRFN",145,0)
 .S IBTYP=$$BTYP^IBCOIVM1(IBIFN,IBX)
"RTN","IBRFN",146,0)
 .S IBTYP=$S(IBTYP="":-1,IBTYP="P":"PR",IBTYP="R":"PH",1:IBTYP)
"RTN","IBRFN",147,0)
 ;
"RTN","IBRFN",148,0)
 ; - get the bill number
"RTN","IBRFN",149,0)
 S IBX=$P($G(^PRCA(430,IBIFN,0)),"^")
"RTN","IBRFN",150,0)
 I IBX="" G TYPQ
"RTN","IBRFN",151,0)
 ;
"RTN","IBRFN",152,0)
 ; - AR must have originated from file #350
"RTN","IBRFN",153,0)
 S IBN=$O(^IB("ABIL",IBX,0))
"RTN","IBRFN",154,0)
 I 'IBN G TYPQ
"RTN","IBRFN",155,0)
 S IBND=$G(^IB(IBN,0))
"RTN","IBRFN",156,0)
 I 'IBND G TYPQ
"RTN","IBRFN",157,0)
 S IBATYP=$G(^IBE(350.1,+$P(IBND,"^",3),0)),IBBG=$P(IBATYP,"^",11)
"RTN","IBRFN",158,0)
 ;
"RTN","IBRFN",159,0)
 ; - handle TRICARE charges first
"RTN","IBRFN",160,0)
 I IBBG=7 D  G TYPQ
"RTN","IBRFN",161,0)
 .S IBATYPN=$P(IBATYP,"^")
"RTN","IBRFN",162,0)
 .S IBTYP=$S(IBATYPN["INPT":"I",IBATYPN["OPT":"O",1:"PH")
"RTN","IBRFN",163,0)
 ;
"RTN","IBRFN",164,0)
 S IBTYP=$S(IBBG=4:"O",IBBG=5:"PH",IBBG=8:"O",1:"I")
"RTN","IBRFN",165,0)
TYPQ Q IBTYP
"RTN","IBRFN",166,0)
 ;
"RTN","IBRFN",167,0)
RELBILL(IBIFN) ; given a Third Party Bill, find all related Third Party bills,
"RTN","IBRFN",168,0)
 ; then find all First Party bills related to any of the Third Party bills
"RTN","IBRFN",169,0)
 ; Input:  IBIFN = internal file number of a Third Party bill
"RTN","IBRFN",170,0)
 ; Output: Third Party Bills (#399)
"RTN","IBRFN",171,0)
 ;    ^TMP("IBRBT", $J, selected bill ifn) = PATIENT HAS ANY RX COVERAGE ON FROM DATE OF BILL?
"RTN","IBRFN",172,0)
 ;    ^TMP("IBRBT", $J, selected bill ifn, matching bill ifn) =
"RTN","IBRFN",173,0)
 ;                                        BILL FROM ^ BILL TO ^ CANCELLED? ^ AR BILL NUMBER ^
"RTN","IBRFN",174,0)
 ;                                        PAYER SEQUENCE ^ PAYER IS MEDICARE SUPPLEMENTAL (0/1) ^ PAYER NAME
"RTN","IBRFN",175,0)
 ; Output:  First Party Bills (#350)
"RTN","IBRFN",176,0)
 ;    ^TMP("IBRBF", $J , selected bill ifn ) = ""
"RTN","IBRFN",177,0)
 ;    ^TMP("IBRBF", $J , selected bill ifn , charge ifn) = 
"RTN","IBRFN",178,0)
 ;                                        BILL FROM ^ BILL TO ^ CANCELLED? ^ AR BILL NUMBER ^
"RTN","IBRFN",179,0)
 ;                                        TOTAL CHARGE ^ ACTION TYPE (SHORT) ^ # DAYS ON HOLD
"RTN","IBRFN",180,0)
 ;
"RTN","IBRFN",181,0)
 N IBIFN1 I '$D(^DGCR(399,+$G(IBIFN),0)) Q
"RTN","IBRFN",182,0)
 D TPTP^IBEFUR(IBIFN)
"RTN","IBRFN",183,0)
 S IBIFN1=0 F  S IBIFN1=$O(^TMP("IBRBT",$J,IBIFN,IBIFN1)) Q:'IBIFN1  D TPFP^IBEFUR(IBIFN1)
"RTN","IBRFN",184,0)
 Q
"RTN","IBRFN",185,0)
 ;
"RTN","IBRFN",186,0)
SEL(IBARR) ; Select a bill for a auth.
"RTN","IBRFN",187,0)
 ;  Input:   IBARR  --  Array of bill passed by reference.
"RTN","IBRFN",188,0)
 ; Output:   IBNUM  --  One of the bill iens, or -1 (none selected)
"RTN","IBRFN",189,0)
 ;
"RTN","IBRFN",190,0)
 N DIR,DIRUT,DIROUT,DTOUT,DUOUT,IBSTR,IBKEY,IBNUM,IBX,IBY,IBC,IBB
"RTN","IBRFN",191,0)
 ;
"RTN","IBRFN",192,0)
 ; - build string for DIR(0)
"RTN","IBRFN",193,0)
 S (IBSTR,IBKEY,IBC)="",IBNUM=-1
"RTN","IBRFN",194,0)
 F  S IBKEY=$O(IBARR(IBKEY)) Q:IBKEY=""  D
"RTN","IBRFN",195,0)
 . S IBB=$P($G(^DGCR(399,IBKEY,0)),"^") Q:IBB=""
"RTN","IBRFN",196,0)
 . S IBX=0 F  S IBX=$O(^IBA(362.4,"C",IBKEY,IBX)) Q:'IBX  D
"RTN","IBRFN",197,0)
 .. S IBY=$G(^IBA(362.4,IBX,0)) Q:IBY=""
"RTN","IBRFN",198,0)
 .. S IBC=IBC+1
"RTN","IBRFN",199,0)
 .. S IBSTR=IBSTR_IBC_":"_IBB_" "_$P(IBY,"^")_" "_$$DAT1^IBOUTL($P(IBY,"^",3))_";"
"RTN","IBRFN",200,0)
 ;
"RTN","IBRFN",201,0)
 I IBSTR="" G SELQ
"RTN","IBRFN",202,0)
 ;
"RTN","IBRFN",203,0)
 S DIR("A")="Select one of the bills by number",DIR(0)="S^"_IBSTR
"RTN","IBRFN",204,0)
 D ^DIR I $D(DUOUT)!$D(DIROUT)!$D(DTOUT) G SELQ
"RTN","IBRFN",205,0)
 ;
"RTN","IBRFN",206,0)
 S:$L($P(Y(0)," ")) IBNUM=$O(^DGCR(399,"B",$P(Y(0)," "),0))
"RTN","IBRFN",207,0)
 ;
"RTN","IBRFN",208,0)
SELQ Q IBNUM
"RTN","IBRFN3")
0^24^B29672386
"RTN","IBRFN3",1,0)
IBRFN3 ;ALB/ARH - PASS BILL/CLAIM TO AR ;3/18/96
"RTN","IBRFN3",2,0)
 ;;2.0;INTEGRATED BILLING;**61,133,210,309**;21-MAR-94
"RTN","IBRFN3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBRFN3",4,0)
 ;
"RTN","IBRFN3",5,0)
 ;  Returns information on the bill passed in,  all data returned in external format, for AR's RC project
"RTN","IBRFN3",6,0)
 ;
"RTN","IBRFN3",7,0)
 ;  If the bill can not be found then returns ARRAY=0  (should be called with ARRAY passed by reference)
"RTN","IBRFN3",8,0)
 ;  Otherwise ARRAY=1 and the following array elements may be defined
"RTN","IBRFN3",9,0)
 ;  these array elements will only be defined is there is data to return
"RTN","IBRFN3",10,0)
 ;  those elements that have multiple entries will be in the form ARRAY("SUB",X) where X=1:1:...
"RTN","IBRFN3",11,0)
 ;
"RTN","IBRFN3",12,0)
 ;  ARRAY("BN") = BILL NUMBER
"RTN","IBRFN3",13,0)
 ;  ARRAY("SR") = SENSITIVE RECORD? (Y or N)
"RTN","IBRFN3",14,0)
 ;  ARRAY("STF") = STATEMENT COVERS FROM DATE - first date covered by bill
"RTN","IBRFN3",15,0)
 ;  ARRAY("STT") = STATEMENT COVERS TO DATE - last date covered by bill
"RTN","IBRFN3",16,0)
 ;  ARRAY("TCG") = TOTAL CHARGES^OFFSET AMT (PRIOR PAYMENTS)^OFFSET DESC
"RTN","IBRFN3",17,0)
 ;  ARRAY("TOC") = BILL TYPE (INPATIENT OR OUTPATIENT)
"RTN","IBRFN3",18,0)
 ;  ARRAY("TCF") = BILL FORM TYPE
"RTN","IBRFN3",19,0)
 ;  ARRAY("DFP") = DATE FIRST PRINTED
"RTN","IBRFN3",20,0)
 ;  ARRAY("TAX") = FEDERAL TAX NUMBER - for facility, a site parameter
"RTN","IBRFN3",21,0)
 ;
"RTN","IBRFN3",22,0)
 ;  ARRAY("PIN") = DEBTOR INSURANCE NAME ^ HOSPITAL PROVIDER NUMBER ^ GROUP NAME ^ GROUP NUMBER ^
"RTN","IBRFN3",23,0)
 ;                 NAME OF INSURED ^ SUBSCRIBER ID ^ RELATIONSHIP TO INSURED
"RTN","IBRFN3",24,0)
 ;
"RTN","IBRFN3",25,0)
 ;  ARRAY("PIN","MMA") = DEBTOR MAILING STREET ADDRESS [LINE 1] ^
"RTN","IBRFN3",26,0)
 ;                       MAILING STREET ADDRESS [LINE 2] ^ MAILING STREET ADDRESS [LINE 3] ^ CITY ^ 
"RTN","IBRFN3",27,0)
 ;                       STATE (ABBREVIATED) ^ ZIP ^ PHONE NUMBER
"RTN","IBRFN3",28,0)
 ;
"RTN","IBRFN3",29,0)
 ;  ARRAY("RVC") = NUMBER OF REVENUE CODES ON BILL
"RTN","IBRFN3",30,0)
 ;  ARRAY("RVC",X) = REVENUE CODE ^ REVENUE CODE DESCRIPTION ^ CHARGE (PER UNIT) ^ UNITS ^
"RTN","IBRFN3",31,0)
 ;                   TOTAL CHARGE FOR REV CODE
"RTN","IBRFN3",32,0)
 ;
"RTN","IBRFN3",33,0)
 ;  ARRAY("OPV") = NUMBER OF OUTPATIENT VISIT DATES ON BILL
"RTN","IBRFN3",34,0)
 ;  ARRAY("OPV",X) = OUTPATIENT VISIT DATE
"RTN","IBRFN3",35,0)
 ;
"RTN","IBRFN3",36,0)
 ;  ARRAY("PRC") = NUMBER OF PROCEDURES ON BILL
"RTN","IBRFN3",37,0)
 ;  ARRAY("PRC",X) = PROCEDURE CODE ^ PROCEDURE DESCRIPTION ^ PROCEDURE DATE ^
"RTN","IBRFN3",38,0)
 ;                   PLACE OF SERVICE CODE ^ PLACE OF SERVICE ^ TYPE OF SERVICE CODE ^ TYPE OF SERVICE
"RTN","IBRFN3",39,0)
 ;
"RTN","IBRFN3",40,0)
 ;  ARRAY("DXS") = NUMBER OF DIAGNOSIS ON BILL
"RTN","IBRFN3",41,0)
 ;  ARRAY("DXS,X) = DIAGNOSIS CODE ^ DIAGNOSIS
"RTN","IBRFN3",42,0)
 ;
"RTN","IBRFN3",43,0)
 ;  ARRAY("RXF") = NUMBER OF PRESCRIPTION REFILLS ON BILL
"RTN","IBRFN3",44,0)
 ;  ARRAY("RXF",X) = PRESCRIPTION # ^ REFILL DATE ^ DRUG NAME ^ DAYS SUPPLY ^ QUANTITY ^ NDC #
"RTN","IBRFN3",45,0)
 ;
"RTN","IBRFN3",46,0)
 ;  ARRAY("PRD") = NUMBER OF PROSTHETIC ITEMS ON BILL
"RTN","IBRFN3",47,0)
 ;  ARRAY("PRD",X) = PROSTHETIC DEVICE ^ DELIVERY DATE
"RTN","IBRFN3",48,0)
 ;
"RTN","IBRFN3",49,0)
 ;  IF CONDITION RELATED TO EMPLOYMENT:  ARRAY("CRE") = "EMPLOYMENT"
"RTN","IBRFN3",50,0)
 ;  IF CONDITION RELATED TO AN AUTO ACCIDENT:  ARRAY("CRA") = "AUTO ACCIDENT" ^ STATE (ABBREVIATION)
"RTN","IBRFN3",51,0)
 ;  IF CONDITION RELATED TO AN OTHER ACCIDENT:  ARRAY("CRO") = "OTHER ACCIDENT"
"RTN","IBRFN3",52,0)
 ;
"RTN","IBRFN3",53,0)
BILL(IBIFN,ARRAY) ; returns array of information on a specific bill, based on RC requirements
"RTN","IBRFN3",54,0)
 ;
"RTN","IBRFN3",55,0)
 N IBI,IBJ,IBK,IBX,IBY,IBTMP,IBD0,IBDU,IBDU1,IBDI1,IBDS,IBDATE
"RTN","IBRFN3",56,0)
 K ARRAY S ARRAY=1 I '$G(IBIFN)!($G(^DGCR(399,+$G(IBIFN),0))="") S ARRAY=0 Q
"RTN","IBRFN3",57,0)
 F IBI=0,"U","U1","S" S @("IBD"_IBI)=$G(^DGCR(399,IBIFN,IBI))
"RTN","IBRFN3",58,0)
 S IBX=$P(IBD0,U,21),IBX=$S(IBX="P":"I1",IBX="S":"I2",IBX="T":"I3",1:" ")
"RTN","IBRFN3",59,0)
 S IBDI1=$G(^DGCR(399,IBIFN,IBX))
"RTN","IBRFN3",60,0)
 ;
"RTN","IBRFN3",61,0)
 S ARRAY("TCG")=$P(IBDU1,U,1,3)
"RTN","IBRFN3",62,0)
 S ARRAY("BN")=$P(IBD0,U,1)
"RTN","IBRFN3",63,0)
 S ARRAY("SR")=$S($P(IBDU,U,5)=1:"Y",1:"N")
"RTN","IBRFN3",64,0)
 S ARRAY("STF")=$P(IBDU,U,1)
"RTN","IBRFN3",65,0)
 S ARRAY("STT")=$P(IBDU,U,2)
"RTN","IBRFN3",66,0)
 S ARRAY("TOC")=$S($P(IBD0,U,5)<3:"INPATIENT",1:"OUTPATIENT")
"RTN","IBRFN3",67,0)
 S ARRAY("TCF")=$$FTN^IBCU3($$FT^IBCU3(IBIFN))
"RTN","IBRFN3",68,0)
 S ARRAY("DFP")=$P(IBDS,U,12)
"RTN","IBRFN3",69,0)
 S ARRAY("TAX")=$P($G(^IBE(350.9,1,1)),U,5)
"RTN","IBRFN3",70,0)
 ;
"RTN","IBRFN3",71,0)
INS ; insurance information
"RTN","IBRFN3",72,0)
 S IBX=$G(^DGCR(399,+IBIFN,"M"))
"RTN","IBRFN3",73,0)
 S ARRAY("PIN")=$P(IBX,U,4)_U_$P($G(^DIC(36,+IBDI1,0)),U,11)_U_$P(IBDI1,U,15)_U_$P(IBDI1,U,3)_U_$P(IBDI1,U,17)_U_$P(IBDI1,U,2)_U_$$RTI($P(IBDI1,U,16))
"RTN","IBRFN3",74,0)
 S ARRAY("PIN","MMA")=$P(IBX,U,5)_U_$P(IBX,U,6)_U_$P($G(^DGCR(399,+IBIFN,"M1")),U,1)_U_$P(IBX,U,7)_U_$$STATE($P(IBX,U,8))
"RTN","IBRFN3",75,0)
 S ARRAY("PIN","MMA")=ARRAY("PIN","MMA")_U_$$ZIP($P(IBX,U,9))_U_$P($G(^DIC(36,+IBDI1,.13)),U,1)
"RTN","IBRFN3",76,0)
 ;
"RTN","IBRFN3",77,0)
RC ; revenue codes
"RTN","IBRFN3",78,0)
 S (IBI,IBJ)=0,ARRAY("RVC")=IBJ F  S IBI=$O(^DGCR(399,IBIFN,"RC",IBI)) Q:'IBI  D
"RTN","IBRFN3",79,0)
 . S IBX=$G(^DGCR(399,IBIFN,"RC",IBI,0)) Q:IBX=""  S IBY=$G(^DGCR(399.2,+IBX,0))
"RTN","IBRFN3",80,0)
 . S IBJ=IBJ+1,ARRAY("RVC")=IBJ
"RTN","IBRFN3",81,0)
 . S ARRAY("RVC",IBJ)=$P(IBY,U,1)_U_$P(IBY,U,2)_U_$P(IBX,U,2)_U_$P(IBX,U,3)_U_$P(IBX,U,4)
"RTN","IBRFN3",82,0)
 ;
"RTN","IBRFN3",83,0)
OPV ; outpatient visit dates
"RTN","IBRFN3",84,0)
 S (IBI,IBJ)=0,ARRAY("OPV")=IBJ F  S IBI=$O(^DGCR(399,IBIFN,"OP",IBI)) Q:'IBI  D
"RTN","IBRFN3",85,0)
 . S IBX=$G(^DGCR(399,IBIFN,"OP",IBI,0)) Q:'IBX
"RTN","IBRFN3",86,0)
 . S IBJ=IBJ+1,ARRAY("OPV")=IBJ
"RTN","IBRFN3",87,0)
 . S ARRAY("OPV",IBJ)=+IBX
"RTN","IBRFN3",88,0)
 ;
"RTN","IBRFN3",89,0)
PRC ; procedure codes
"RTN","IBRFN3",90,0)
 S (IBI,IBJ)=0,ARRAY("PRC")=IBJ F  S IBI=$O(^DGCR(399,IBIFN,"CP",IBI)) Q:'IBI  D
"RTN","IBRFN3",91,0)
 . S IBX=$G(^DGCR(399,IBIFN,"CP",IBI,0)),IBY=""
"RTN","IBRFN3",92,0)
 . S IBDATE=$P(IBX,U,2) I 'IBDATE S IBDATE=$$BDATE^IBACSV(IBIFN)
"RTN","IBRFN3",93,0)
 . S IBY=$P($$PRCD^IBCEF1($P(IBX,U),1,IBDATE),U,2,3)
"RTN","IBRFN3",94,0)
 . Q:$P(IBY,U)=""
"RTN","IBRFN3",95,0)
 . S IBJ=IBJ+1,ARRAY("PRC")=IBJ
"RTN","IBRFN3",96,0)
 . S ARRAY("PRC",IBJ)=IBY_U_$P(IBX,U,2)
"RTN","IBRFN3",97,0)
 . S IBY=$G(^IBE(353.1,+$P(IBX,U,9),0)),ARRAY("PRC",IBJ)=ARRAY("PRC",IBJ)_U_$P(IBY,U)_U_$P(IBY,U,3)
"RTN","IBRFN3",98,0)
 . S IBY=$G(^IBE(353.2,+$P(IBX,U,10),0)),ARRAY("PRC",IBJ)=ARRAY("PRC",IBJ)_U_$P(IBY,U)_U_$P(IBY,U,3)
"RTN","IBRFN3",99,0)
 ;
"RTN","IBRFN3",100,0)
DX ; diagnosis codes
"RTN","IBRFN3",101,0)
 K IBTMP D SET^IBCSC4D(IBIFN,"",.IBTMP)
"RTN","IBRFN3",102,0)
 S IBDATE=$$BDATE^IBACSV(IBIFN)
"RTN","IBRFN3",103,0)
 S (IBI,IBJ)=0,ARRAY("DXS")=IBJ F  S IBI=$O(IBTMP(IBI)) Q:'IBI  D
"RTN","IBRFN3",104,0)
 . S IBX=IBTMP(IBI),IBY=$$ICD9^IBACSV(+IBX,IBDATE) Q:IBY=""
"RTN","IBRFN3",105,0)
 . S IBJ=IBJ+1,ARRAY("DXS")=IBJ
"RTN","IBRFN3",106,0)
 . S ARRAY("DXS",IBJ)=$P(IBY,U)_U_$P(IBY,U,3)
"RTN","IBRFN3",107,0)
 ;
"RTN","IBRFN3",108,0)
RX ; prescription refills
"RTN","IBRFN3",109,0)
 K IBTMP D SET^IBCSC5A(IBIFN,.IBTMP)
"RTN","IBRFN3",110,0)
 S (IBI,IBJ)=0,ARRAY("RXF")=IBJ F  S IBI=$O(IBTMP(IBI)) Q:'IBI  D
"RTN","IBRFN3",111,0)
 . S IBK=0 F  S IBK=$O(IBTMP(IBI,IBK)) Q:'IBK  D
"RTN","IBRFN3",112,0)
 .. S IBX=IBTMP(IBI,IBK) D ZERO^IBRXUTL(+$P(IBX,U,2)) S IBY=$G(^TMP($J,"IBDRUG",+$P(IBX,U,2),.01))
"RTN","IBRFN3",113,0)
 .. S IBJ=IBJ+1,ARRAY("RXF")=IBJ
"RTN","IBRFN3",114,0)
 .. S ARRAY("RXF",IBJ)=IBI_U_IBK_U_IBY_U_$P(IBX,U,3)_U_$P(IBX,U,4)_U_$P(IBX,U,5)
"RTN","IBRFN3",115,0)
 .. K ^TMP($J,"IBDRUG")
"RTN","IBRFN3",116,0)
 .. Q
"RTN","IBRFN3",117,0)
 ;
"RTN","IBRFN3",118,0)
PD ; prosthetic items
"RTN","IBRFN3",119,0)
 K IBTMP D SET^IBCSC5B(IBIFN,.IBTMP)
"RTN","IBRFN3",120,0)
 S (IBI,IBJ)=0,ARRAY("PRD")=IBJ F  S IBI=$O(IBTMP(IBI)) Q:'IBI  D
"RTN","IBRFN3",121,0)
 . S IBK=0 F  S IBK=$O(IBTMP(IBI,IBK)) Q:'IBK  D
"RTN","IBRFN3",122,0)
 .. S IBX=IBTMP(IBI,IBK)
"RTN","IBRFN3",123,0)
 .. S IBJ=IBJ+1,ARRAY("PRD")=IBJ
"RTN","IBRFN3",124,0)
 .. S ARRAY("PRD",IBJ)=$P($$PIN^IBCSC5B(IBK),U,2)_U_IBI
"RTN","IBRFN3",125,0)
 ;
"RTN","IBRFN3",126,0)
CC ; condition related to employment, auto accident (place), other accident
"RTN","IBRFN3",127,0)
 S IBI=0 F  S IBI=$O(^DGCR(399,IBIFN,"CC",IBI)) Q:'IBI  I $G(^(IBI,0))="02" S ARRAY("CRE")="EMPLOYMENT"
"RTN","IBRFN3",128,0)
 S IBI=0 F  S IBI=$O(^DGCR(399,IBIFN,"OC",IBI)) Q:'IBI  S IBX=$G(^(IBI,0)) I +IBX D
"RTN","IBRFN3",129,0)
 . S IBY=$G(^DGCR(399.1,+IBX,0)) Q:IBY=""
"RTN","IBRFN3",130,0)
 . I $P(IBY,U,9)=1 S ARRAY("CRE")="EMPLOYMENT"
"RTN","IBRFN3",131,0)
 . I $P(IBY,U,9)=2 S ARRAY("CRA")="AUTO ACCIDENT"_U_$$STATE($P(IBX,U,3))
"RTN","IBRFN3",132,0)
 . I $P(IBY,U,9)=3 S ARRAY("CRO")="OTHER ACCIDENT"
"RTN","IBRFN3",133,0)
 Q
"RTN","IBRFN3",134,0)
 ;
"RTN","IBRFN3",135,0)
STATE(X) ; returns 2 letter abbreviation for state
"RTN","IBRFN3",136,0)
 Q $P($G(^DIC(5,+X,0)),U,2)
"RTN","IBRFN3",137,0)
ZIP(X) ; returns zip in external form
"RTN","IBRFN3",138,0)
 S X=$E(X,1,5)_$S($E(X,6,9)]"":"-"_$E(X,6,9),1:"")
"RTN","IBRFN3",139,0)
 Q X
"RTN","IBRFN3",140,0)
RTI(X) ; returns external form of relationship to insured
"RTN","IBRFN3",141,0)
 I X'="" S X=$S(X="01":"PATIENT",X="02":"SPOUSE",X="03":"NATURAL CHILD",X="08":"EMPLOYEE",X="09":"UNKNOWN",X="11":"ORGAN DONOR",X="15":"INJURED PLANTIFF",X="18":"PARENT",1:"")
"RTN","IBRFN3",142,0)
 Q X
"RTN","IBRFN3",143,0)
 ;IBRFN3
"RTN","IBRXUTL")
0^22^B356749
"RTN","IBRXUTL",1,0)
IBRXUTL ;ALB/MAF - PHARMACY API CALLS ; MAY 25, 2005
"RTN","IBRXUTL",2,0)
 ;;2.0;INTEGRATED BILLING;**309**;21-MAR-94
"RTN","IBRXUTL",3,0)
 ;
"RTN","IBRXUTL",4,0)
 ; This routine contains calls to Pharmacy API's to get data
"RTN","IBRXUTL",5,0)
 ; from the Drug file
"RTN","IBRXUTL",6,0)
ZERO(IBDRV) ;This call gets the data from the zero node for file 50 DRUG.
"RTN","IBRXUTL",7,0)
 ;Integration Agreement DBIA 4533 with Pharmacy.
"RTN","IBRXUTL",8,0)
 ;input -  the IFN of the DRUG
"RTN","IBRXUTL",9,0)
 ;output - info is listed in ^TMP($J,"IBDRUG",drug IFN,field number))
"RTN","IBRXUTL",10,0)
 ;the information is listed by using the field number of the data piece.
"RTN","IBRXUTL",11,0)
 ;ie.  the info for the generic drug name .01 field of file 50 will list
"RTN","IBRXUTL",12,0)
 ;like this:
"RTN","IBRXUTL",13,0)
 ;^TMP($J,"IBDRUG",drug IFN,.01)
"RTN","IBRXUTL",14,0)
 ;the DEA, SPECIAL HDLG data 3 field of file 50 will list like this:
"RTN","IBRXUTL",15,0)
 ;^TMP($J,"IBDRUG",drug IFN,3)
"RTN","IBRXUTL",16,0)
 N X
"RTN","IBRXUTL",17,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBRXUTL",18,0)
 S X="IBDRUG" D ZERO^PSS50(IBDRV,,,,,X)
"RTN","IBRXUTL",19,0)
 Q
"RTN","IBRXUTL",20,0)
DATA(IBDRV) ;This call gets more detailed information on the drug 
"RTN","IBRXUTL",21,0)
 ;plus the zero node information for file 50 DRUG.
"RTN","IBRXUTL",22,0)
 ;Integration Agreement DBIA 4533 with Pharmacy.
"RTN","IBRXUTL",23,0)
 ;input -  the IFN of the DRUG
"RTN","IBRXUTL",24,0)
 ;output - info is listed in ^TMP($J,"IBDRUG",drug IFN,field number))
"RTN","IBRXUTL",25,0)
 ;the information is listed by using the field number of the data piece.
"RTN","IBRXUTL",26,0)
 ;ie.  the info for the generic drug name .01 field of file 50 will list
"RTN","IBRXUTL",27,0)
 ;like this:
"RTN","IBRXUTL",28,0)
 ;^TMP($J,"IBDRUG",drug IFN,.01)
"RTN","IBRXUTL",29,0)
 ;the DEA, SPECIAL HDLG data 3 field of file 50 will list like this:
"RTN","IBRXUTL",30,0)
 ;^TMP($J,"IBDRUG",drug IFN,3)
"RTN","IBRXUTL",31,0)
 N X
"RTN","IBRXUTL",32,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBRXUTL",33,0)
 S X="IBDRUG" D DATA^PSS50(IBDRV,,,,,X)
"RTN","IBRXUTL",34,0)
 Q
"RTN","IBTOBI")
0^17^B26152194
"RTN","IBTOBI",1,0)
IBTOBI ;ALB/AAS - CLAIMS TRACKING BILLING INFORMATION PRINT ; 27-OCT-93
"RTN","IBTOBI",2,0)
 ;;2.0;INTEGRATED BILLING;**91,160,199,309**;21-MAR-94
"RTN","IBTOBI",3,0)
 ;
"RTN","IBTOBI",4,0)
% I '$D(DT) D DT^DICRW
"RTN","IBTOBI",5,0)
 W !!,"Bill Preparation Report for a Single Visit"
"RTN","IBTOBI",6,0)
 D END
"RTN","IBTOBI",7,0)
 ;
"RTN","IBTOBI",8,0)
PAT ; -- Select patient
"RTN","IBTOBI",9,0)
 W !!
"RTN","IBTOBI",10,0)
 S DIC="^DPT(",DIC(0)="AEQM"
"RTN","IBTOBI",11,0)
 N DPTNOFZY S DPTNOFZY=1  ;Suppress PATIENT file fuzzy lookups
"RTN","IBTOBI",12,0)
 D ^DIC K DIC I +Y<1 G END
"RTN","IBTOBI",13,0)
 S DFN=+Y
"RTN","IBTOBI",14,0)
 ;
"RTN","IBTOBI",15,0)
VSIT ;
"RTN","IBTOBI",16,0)
 ; -- get claims tracking visit entry
"RTN","IBTOBI",17,0)
 D TRAC^IBTRV K IBY
"RTN","IBTOBI",18,0)
 I '$G(IBTRN) G END
"RTN","IBTOBI",19,0)
 ;
"RTN","IBTOBI",20,0)
DEV ; -- select device, run option
"RTN","IBTOBI",21,0)
 W !
"RTN","IBTOBI",22,0)
 S %ZIS="QM" D ^%ZIS G:POP END
"RTN","IBTOBI",23,0)
 I $D(IO("Q")) S ZTRTN="DQ^IBTOBI",ZTSAVE("IB*")="",ZTSAVE("DFN")="",ZTDESC="IB - Bill Preparation Report" D ^%ZTLOAD K IO("Q"),ZTSK D HOME^%ZIS G PAT
"RTN","IBTOBI",24,0)
 ;
"RTN","IBTOBI",25,0)
 U IO
"RTN","IBTOBI",26,0)
 D ONE,END G PAT
"RTN","IBTOBI",27,0)
 Q
"RTN","IBTOBI",28,0)
DQ ; -- task man entry point
"RTN","IBTOBI",29,0)
 D ONE
"RTN","IBTOBI",30,0)
 ;
"RTN","IBTOBI",31,0)
END ; -- Clean up
"RTN","IBTOBI",32,0)
 W !
"RTN","IBTOBI",33,0)
 I $D(ZTQUEUED) S ZTREQ="@" Q
"RTN","IBTOBI",34,0)
 D ^%ZISC
"RTN","IBTOBI",35,0)
 K I,J,X,Y,DFN,%ZIS,VA,IBTRN,IBTRND,IBTRND1,IBPAG,IBHDT,IBDISDT,IBETYP,IBQUIT,IBTAG,DIRUT,DUOUT,IBCNT,IBI,IBJ,IBNAR,IBTNOD,IBTRCD1,IBTRTP,IBDA
"RTN","IBTOBI",36,0)
 D KVAR^VADPT
"RTN","IBTOBI",37,0)
 Q
"RTN","IBTOBI",38,0)
ONE ; -- print one billing report from ct
"RTN","IBTOBI",39,0)
 S IBPAG=0,IBHDT=$$HTE^XLFDT($H,1),IBQUIT=0
"RTN","IBTOBI",40,0)
 D PID^VADPT
"RTN","IBTOBI",41,0)
 S IBTRND=$G(^IBT(356,+IBTRN,0)),IBTRND1=$G(^(1))
"RTN","IBTOBI",42,0)
 S IBETYP=$G(^IBE(356.6,+$P(IBTRND,"^",18),0))
"RTN","IBTOBI",43,0)
 D HDR,SECT1,^IBTOBI1
"RTN","IBTOBI",44,0)
 Q
"RTN","IBTOBI",45,0)
 ;
"RTN","IBTOBI",46,0)
HDR ; -- Print header for billing report
"RTN","IBTOBI",47,0)
 Q:IBQUIT
"RTN","IBTOBI",48,0)
 I '$D(VA("PID")) N I,J D PID^VADPT
"RTN","IBTOBI",49,0)
 I $E(IOST,1,2)="C-",IBPAG D PAUSE^VALM1 I $D(DIRUT) S IBQUIT=1 Q
"RTN","IBTOBI",50,0)
 I $E(IOST,1,2)="C-"!(IBPAG) W @IOF
"RTN","IBTOBI",51,0)
 S IBPAG=IBPAG+1
"RTN","IBTOBI",52,0)
 W !,$S($D(IBCTHDR):IBCTHDR,1:"Bill Preparation Report"),?(IOM-33),"Page ",IBPAG,"  ",IBHDT
"RTN","IBTOBI",53,0)
 W !!,$E($P($G(^DPT(DFN,0)),"^"),1,25),?28,VA("PID"),?50,"DOB: ",$$FMTE^XLFDT($P($G(^DPT(DFN,0)),"^",3),1)
"RTN","IBTOBI",54,0)
 W !,$$EXPAND^IBTRE(356,.18,$P(IBTRND,"^",18))," on ",$$FMTE^XLFDT($P(IBTRND,"^",6),1)
"RTN","IBTOBI",55,0)
 W !,$TR($J(" ",IOM)," ","-")
"RTN","IBTOBI",56,0)
 Q
"RTN","IBTOBI",57,0)
 ;
"RTN","IBTOBI",58,0)
SECT1 ; -- Section 1 - Visit info Region / misc billing info
"RTN","IBTOBI",59,0)
 N IBD
"RTN","IBTOBI",60,0)
 W !," Visit Information "
"RTN","IBTOBI",61,0)
 S IBD(1,1)="    Visit Type: "_$P(IBETYP,"^")
"RTN","IBTOBI",62,0)
 S X=$P(IBETYP,"^",3) I 'X W !,"No Visit Selected" Q
"RTN","IBTOBI",63,0)
 D @X
"RTN","IBTOBI",64,0)
 D MBI
"RTN","IBTOBI",65,0)
 S I=0 F  S I=$O(IBD(I)) Q:'I  W !,$G(IBD(I,1)),?44,$E($G(IBD(I,2)),1,36)
"RTN","IBTOBI",66,0)
 W !?4,$TR($J(" ",IOM-8)," ","-"),!
"RTN","IBTOBI",67,0)
 Q
"RTN","IBTOBI",68,0)
1 ; -- visit region for admission or scheduled admission
"RTN","IBTOBI",69,0)
 S IBDISDT=""
"RTN","IBTOBI",70,0)
 I $P($G(^DGPM(+$P(IBTRND,"^",5),0)),"^",17) S VAINDT=+$G(^DGPM(+$P(IBTRND,"^",5),0)),IBDISDT=+$G(^DGPM(+$P($G(^DGPM(+$P(IBTRND,"^",5),0)),"^",17),0))
"RTN","IBTOBI",71,0)
 I '$D(VAIN) S VA200="" D INP^VADPT
"RTN","IBTOBI",72,0)
 I VAIN(7)="" S Y=$P(IBTRND,"^",6) D D^DIQ S $P(VAIN(7),"^",2)=Y
"RTN","IBTOBI",73,0)
 S IBD(2,1)="Admission Date: "_$P(VAIN(7),"^",2)
"RTN","IBTOBI",74,0)
 S IBD(3,1)="          Ward: "_$P(VAIN(4),"^",2)
"RTN","IBTOBI",75,0)
 S IBD(4,1)="     Specialty: "_$P(VAIN(3),"^",2)
"RTN","IBTOBI",76,0)
 S IBD(5,1)="Discharge Date: "_$$FMTE^XLFDT(IBDISDT,1)
"RTN","IBTOBI",77,0)
 Q
"RTN","IBTOBI",78,0)
2 ; -- visit region for  outpatient care
"RTN","IBTOBI",79,0)
 N IBOE,IBOE0
"RTN","IBTOBI",80,0)
 S IBOE=$P(IBTRND,"^",4),IBOE0=$$SCE^IBSDU(+IBOE)
"RTN","IBTOBI",81,0)
 S IBD(2,1)="    Visit Date: "_$$DAT1^IBOUTL($P(IBTRND,"^",6),"2P")
"RTN","IBTOBI",82,0)
 I +IBOE<1 S IBD(3,1)="  No Outpatient Encounter Found" Q
"RTN","IBTOBI",83,0)
 S IBD(3,1)="        Clinic: "_$P($G(^SC(+$P(IBOE0,U,4),0)),"^")
"RTN","IBTOBI",84,0)
 S IBD(4,1)="  Appt. Status: "_$$EXPAND^IBTRE(409.68,.12,$P(IBOE0,U,12))
"RTN","IBTOBI",85,0)
 S IBD(5,1)="    Appt. Type: "_$$EXPAND^IBTRE(409.68,.1,$P(IBOE0,U,10))
"RTN","IBTOBI",86,0)
 S IBD(6,1)="  Special Cond: "_$$ENCL^IBTRED(IBOE)
"RTN","IBTOBI",87,0)
 Q
"RTN","IBTOBI",88,0)
 ;
"RTN","IBTOBI",89,0)
3 ; -- visit region for rx refill
"RTN","IBTOBI",90,0)
 N PSONTALK,PSOTMP,PSORXN,PSOFILL
"RTN","IBTOBI",91,0)
 S PSONTALK=1 ;PSORXN=+$P(IBTRND,"^",8),PSOFILL=+$P(IBTRND,"^",10)
"RTN","IBTOBI",92,0)
 S X=+$P(IBTRND,"^",8)_"^"_+$P(IBTRND,"^",10) D EN^PSOCPVW
"RTN","IBTOBI",93,0)
 S IBD(2,1)="Prescription #: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),.01,"E"))
"RTN","IBTOBI",94,0)
 I $P(IBTRND,"^",10)=0 S IBD(3,1)="     Fill Date: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),22,"E"))
"RTN","IBTOBI",95,0)
 I +$P(IBTRND,"^",10) S IBD(3,1)="   Refill Date: "_$G(PSOTMP(52.1,+$P(IBTRND,"^",10),.01,"E"))
"RTN","IBTOBI",96,0)
 S IBD(4,1)="          Drug: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),6,"E"))
"RTN","IBTOBI",97,0)
 S IBD(5,1)="      Quantity: "_$J($G(PSOTMP(52,+$P(IBTRND,"^",8),7,"E")),8)
"RTN","IBTOBI",98,0)
 S IBD(6,1)="   Days Supply: "_$J($G(PSOTMP(52,+$P(IBTRND,"^",8),8,"E")),8)
"RTN","IBTOBI",99,0)
 D DATA^IBRXUTL(+$P($G(^PSRX(+$P(IBTRND,"^",8),0)),"^",6))
"RTN","IBTOBI",100,0)
 S IBD(7,1)="          NDC#: "_$G(^TMP($J,"IBDRUG",+$P($G(^PSRX(+$P(IBTRND,"^",8),0)),"^",6),31))
"RTN","IBTOBI",101,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBTOBI",102,0)
 S IBD(8,1)="     Physician: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),4,"E"))
"RTN","IBTOBI",103,0)
 Q
"RTN","IBTOBI",104,0)
 ;
"RTN","IBTOBI",105,0)
4 ; -- Visit region for prosthetics
"RTN","IBTOBI",106,0)
 D 4^IBTOBI4
"RTN","IBTOBI",107,0)
 Q
"RTN","IBTOBI",108,0)
 ;
"RTN","IBTOBI",109,0)
MBI ; -- Misc. billing info
"RTN","IBTOBI",110,0)
 S IBD(1,2)=" Visit Billable: "_$S('$P(IBTRND,"^",19):"YES",1:"NO-"_$$EXPAND^IBTRE(356,.19,$P(IBTRND,"^",19)))
"RTN","IBTOBI",111,0)
 S IBD(2,2)=" Second Opinion: "_$S('$P(IBTRND,"^",14):"NOT REQUIRED",1:$S('$P(IBTRND,"^",15):"REQUIRED-NOT OBTAINED",1:"OBTAINED"))
"RTN","IBTOBI",112,0)
 S IBD(3,2)=" Auto Bill Date: "_$$FMTE^XLFDT($P(IBTRND,"^",17),1)
"RTN","IBTOBI",113,0)
 S IBD(4,2)="Special Consent: ROI "_$S('$P(IBTRND,"^",31):"NOT DETERMINED",1:$$EXPAND^IBTRE(356,.31,$P(IBTRND,"^",31)))
"RTN","IBTOBI",114,0)
 S IBD(5,2)="Special Billing: "_$$EXPAND^IBTRE(356,.12,$P(IBTRND,"^",12))
"RTN","IBTOBI",115,0)
 Q
"RTN","IBTRED")
0^18^B22295125
"RTN","IBTRED",1,0)
IBTRED ;ALB/AAS - EXPAND/EDIT CLAIMS TRACKING ENTRY ; 01-JUL-1993
"RTN","IBTRED",2,0)
 ;;2.0;INTEGRATED BILLING;**71,91,160,247,309**;21-MAR-94
"RTN","IBTRED",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBTRED",4,0)
 ;
"RTN","IBTRED",5,0)
% ;
"RTN","IBTRED",6,0)
EN ; -- main entry point for IBT EXPAND/EDIT TRACKING
"RTN","IBTRED",7,0)
 I '$D(DT) D DT^DICRW
"RTN","IBTRED",8,0)
 K XQORS,VALMEVL,DFN,IBTRN,IBTRV,IBTRC,IBTRD
"RTN","IBTRED",9,0)
 I '$G(IBTRN) G EN^IBTRE Q  ; entry from programmer mode
"RTN","IBTRED",10,0)
 D EN^VALM("IBT EXPAND/EDIT TRACKING")
"RTN","IBTRED",11,0)
 K IBFASTXT
"RTN","IBTRED",12,0)
 Q
"RTN","IBTRED",13,0)
 ;
"RTN","IBTRED",14,0)
HDR ; -- header code
"RTN","IBTRED",15,0)
 D PID^VADPT
"RTN","IBTRED",16,0)
 S VALMHDR(1)="Expanded Claims Tracking Info for: "_$E($P($G(^DPT(DFN,0)),"^"),1,20)_" "_$E($G(^(0)),1)_VA("BID")_"   ROI: "_$$EXPAND^IBTRE(356,.31,$P(^IBT(356,IBTRN,0),"^",31))
"RTN","IBTRED",17,0)
 S VALMHDR(2)="                              For: "_$$ETYP(IBTRN)
"RTN","IBTRED",18,0)
 Q
"RTN","IBTRED",19,0)
 ;
"RTN","IBTRED",20,0)
INIT ; -- init variables and list array
"RTN","IBTRED",21,0)
 K VALMQUIT
"RTN","IBTRED",22,0)
 S VALMCNT=0,VALMBG=1
"RTN","IBTRED",23,0)
 D BLD,HDR
"RTN","IBTRED",24,0)
 Q
"RTN","IBTRED",25,0)
 ;
"RTN","IBTRED",26,0)
BLD ; -- list builder
"RTN","IBTRED",27,0)
 N IBTRND,IBTRND1,IBTRND2,IBETYP
"RTN","IBTRED",28,0)
 K ^TMP("IBTRED",$J)
"RTN","IBTRED",29,0)
 F I=1:1:30 D BLANK(.I)
"RTN","IBTRED",30,0)
 I '$G(IBTRPRF) S IBTRPRF=123
"RTN","IBTRED",31,0)
 I IBTRPRF<10 S X=$S(IBTRPRF=1:"IBTRED  HR MENU",IBTRPRF=2:"IBTRED  IR MENU",IBTRPRF=3:"IBTRED  BI MENU",1:"IBTRED  MENU") D PROT^IBTRPR(X)
"RTN","IBTRED",32,0)
 D KILL^VALM10()
"RTN","IBTRED",33,0)
 S IBTRND=$G(^IBT(356,IBTRN,0)),IBTRND1=$G(^(1))
"RTN","IBTRED",34,0)
 S IBETYP=$G(^IBE(356.6,+$P(IBTRND,"^",18),0))
"RTN","IBTRED",35,0)
 S VALMCNT=30
"RTN","IBTRED",36,0)
 D VISIT D ^IBTRED0,^IBTRED01
"RTN","IBTRED",37,0)
 Q
"RTN","IBTRED",38,0)
 ;
"RTN","IBTRED",39,0)
VISIT ; -- Visit info Region
"RTN","IBTRED",40,0)
 N OFFSET,START,IBOE,IBOE0
"RTN","IBTRED",41,0)
 S START=1,OFFSET=2
"RTN","IBTRED",42,0)
 D SET^IBCNSP(START,OFFSET," Visit Information ",IORVON,IORVOFF)
"RTN","IBTRED",43,0)
 D SET^IBCNSP(START+1,OFFSET,"    Visit Type: "_$P(IBETYP,"^"))
"RTN","IBTRED",44,0)
 I '$D(IBETYP) N IBETYP S IBETYP=$G(^IBE(356.6,+$P(IBTRND,"^",18),0))
"RTN","IBTRED",45,0)
 S X=$P(IBETYP,"^",3) D @X
"RTN","IBTRED",46,0)
 Q
"RTN","IBTRED",47,0)
1 ; -- visit region for admission or scheduled admission
"RTN","IBTRED",48,0)
 I $P($G(^DGPM(+$P(IBTRND,"^",5),0)),"^",17) S VAINDT=+$G(^DGPM(+$P(IBTRND,"^",5),0))
"RTN","IBTRED",49,0)
 I '$D(VAIN) S VA200="" D INP^VADPT
"RTN","IBTRED",50,0)
 I VAIN(7)="" S Y=$P(IBTRND,"^",6) D D^DIQ S $P(VAIN(7),"^",2)=Y
"RTN","IBTRED",51,0)
 D SET^IBCNSP(START+2,OFFSET,"Admission Date: "_$P(VAIN(7),"^",2))
"RTN","IBTRED",52,0)
 D SET^IBCNSP(START+3,OFFSET,"          Ward: "_$P(VAIN(4),"^",2))
"RTN","IBTRED",53,0)
 D SET^IBCNSP(START+4,OFFSET,"     Specialty: "_$P(VAIN(3),"^",2))
"RTN","IBTRED",54,0)
 Q
"RTN","IBTRED",55,0)
2 ; -- visit region for  outpatient care
"RTN","IBTRED",56,0)
 S IBOE=$P(IBTRND,"^",4),IBOE0=$$SCE^IBSDU(+IBOE)
"RTN","IBTRED",57,0)
 D SET^IBCNSP(START+2,OFFSET,"    Visit Date: "_$$DAT1^IBOUTL($P(IBTRND,"^",6),"2P"))
"RTN","IBTRED",58,0)
 I +IBOE<1 D  Q
"RTN","IBTRED",59,0)
 .D SET^IBCNSP(START+3,OFFSET,"  No Outpatient Encounter Found") Q
"RTN","IBTRED",60,0)
 D SET^IBCNSP(START+3,OFFSET,"        Clinic: "_$P($G(^SC(+$P(IBOE0,"^",4),0)),"^"))
"RTN","IBTRED",61,0)
 D SET^IBCNSP(START+4,OFFSET,"  Appt. Status: "_$$EXPAND^IBTRE(409.68,.12,$P(IBOE0,"^",12)))
"RTN","IBTRED",62,0)
 D SET^IBCNSP(START+5,OFFSET,"    Appt. Type: "_$$EXPAND^IBTRE(409.68,.1,$P(IBOE0,"^",10)))
"RTN","IBTRED",63,0)
 D SET^IBCNSP(START+6,OFFSET,"  Special Cond: "_$$ENCL(IBOE))
"RTN","IBTRED",64,0)
 Q
"RTN","IBTRED",65,0)
 ;
"RTN","IBTRED",66,0)
3 ; -- visit region for rx refill
"RTN","IBTRED",67,0)
 N PSONTALK,PSOTMP
"RTN","IBTRED",68,0)
 S PSONTALK=1 ;PSORXN=+$P(IBTRND,"^",8),PSOFILL=+$P(IBTRND,"^",10)
"RTN","IBTRED",69,0)
 S X=+$P(IBTRND,"^",8)_"^"_+$P(IBTRND,"^",10) D EN^PSOCPVW
"RTN","IBTRED",70,0)
 D SET^IBCNSP(START+2,OFFSET,"Prescription #: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),.01,"E")))
"RTN","IBTRED",71,0)
 I $P(IBTRND,"^",10)=0 D SET^IBCNSP(START+3,OFFSET,"     Fill Date: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),22,"E")))
"RTN","IBTRED",72,0)
 I +$P(IBTRND,"^",10) D SET^IBCNSP(START+3,OFFSET,"   Refill Date: "_$G(PSOTMP(52.1,+$P(IBTRND,"^",10),.01,"E")))
"RTN","IBTRED",73,0)
 D SET^IBCNSP(START+4,OFFSET,"          Drug: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),6,"E")))
"RTN","IBTRED",74,0)
 D SET^IBCNSP(START+5,OFFSET,"      Quantity: "_$J($G(PSOTMP(52,+$P(IBTRND,"^",8),7,"E")),8))
"RTN","IBTRED",75,0)
 D SET^IBCNSP(START+6,OFFSET,"   Days Supply: "_$J($G(PSOTMP(52,+$P(IBTRND,"^",8),8,"E")),8))
"RTN","IBTRED",76,0)
 D DATA^IBRXUTL(+$P($G(^PSRX(+$P(IBTRND,"^",8),0)),"^",6))
"RTN","IBTRED",77,0)
 D SET^IBCNSP(START+7,OFFSET,"          NDC#: "_$G(^TMP($J,"IBDRUG",+$P($G(^PSRX(+$P(IBTRND,"^",8),0)),"^",6),31)))
"RTN","IBTRED",78,0)
 D SET^IBCNSP(START+8,OFFSET,"     Physician: "_$G(PSOTMP(52,+$P(IBTRND,"^",8),4,"E")))
"RTN","IBTRED",79,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBTRED",80,0)
 Q
"RTN","IBTRED",81,0)
 ;
"RTN","IBTRED",82,0)
4 ; -- Visit region for prosthetics
"RTN","IBTRED",83,0)
 D 4^IBTRED01
"RTN","IBTRED",84,0)
 Q
"RTN","IBTRED",85,0)
 ;
"RTN","IBTRED",86,0)
HELP ; -- help code
"RTN","IBTRED",87,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","IBTRED",88,0)
 Q
"RTN","IBTRED",89,0)
 ;
"RTN","IBTRED",90,0)
EXIT ; -- exit code
"RTN","IBTRED",91,0)
 K VALMQUIT,IBTRN
"RTN","IBTRED",92,0)
 D CLEAN^VALM10,FULL^VALM1
"RTN","IBTRED",93,0)
 Q
"RTN","IBTRED",94,0)
 ;
"RTN","IBTRED",95,0)
BLANK(LINE) ; -- Build blank line
"RTN","IBTRED",96,0)
 D SET^VALM10(.LINE,$J("",80))
"RTN","IBTRED",97,0)
 Q
"RTN","IBTRED",98,0)
 ;
"RTN","IBTRED",99,0)
ETYP(IBTRN) ; -- Expand type of epidose and date
"RTN","IBTRED",100,0)
 N IBY S IBY=""
"RTN","IBTRED",101,0)
 S IBTRND=$G(^IBT(356,+IBTRN,0)) I IBTRND="" G ETYPQ
"RTN","IBTRED",102,0)
 S IBETYPD=$G(^IBE(356.6,+$P(IBTRND,"^",18),0))
"RTN","IBTRED",103,0)
 I IBETYPD="" G ETYPQ
"RTN","IBTRED",104,0)
 S IBY=$P(IBETYPD,"^")_" on "_$$DAT1^IBOUTL($P(IBTRND,"^",6),"2P")
"RTN","IBTRED",105,0)
ETYPQ Q IBY
"RTN","IBTRED",106,0)
 ;
"RTN","IBTRED",107,0)
ENCL(IBOE) ; -- output format of classifications
"RTN","IBTRED",108,0)
 N I,X,IBCL,IBCL1 S IBCL=""
"RTN","IBTRED",109,0)
 I '$G(IBOE) G ENCLQ
"RTN","IBTRED",110,0)
 S IBCL1=$$ENCL^IBAMTS2(+IBOE)
"RTN","IBTRED",111,0)
 F I=1:1:7 S X=$P(IBCL1,"^",I) S:X IBCL=IBCL_$S(I=1:"AO",I=2:"IR",I=3:"SC",I=4:"EC",I=5:"MST",I=6:"HNC",I=7:"CV",1:"")_"  "
"RTN","IBTRED",112,0)
ENCLQ Q IBCL
"RTN","IBTRKR3")
0^19^B23758062
"RTN","IBTRKR3",1,0)
IBTRKR3 ;ALB/AAS - CLAIMS TRACKING - ADD/TRACK RX FILLS ;13-AUG-93
"RTN","IBTRKR3",2,0)
 ;;2.0;INTEGRATED BILLING;**13,43,121,160,247,275,260,309**;21-MAR-94
"RTN","IBTRKR3",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBTRKR3",4,0)
 ;
"RTN","IBTRKR3",5,0)
% ; -- entry point for nightly background job
"RTN","IBTRKR3",6,0)
 N IBTSBDT,IBTSEDT
"RTN","IBTRKR3",7,0)
 S IBTSBDT=$$FMADD^XLFDT(DT,-14)-.1
"RTN","IBTRKR3",8,0)
 S IBTSEDT=$$FMADD^XLFDT(DT,-7)+.9
"RTN","IBTRKR3",9,0)
 D EN1
"RTN","IBTRKR3",10,0)
 Q
"RTN","IBTRKR3",11,0)
 ;
"RTN","IBTRKR3",12,0)
EN ; -- entry point to ask date range
"RTN","IBTRKR3",13,0)
 N IBBDT,IBEDT,IBTSBDT,IBTSEDT,IBTALK,IBMESS
"RTN","IBTRKR3",14,0)
 S IBTALK=1
"RTN","IBTRKR3",15,0)
 I '$P($G(^IBE(350.9,1,6)),"^",4) W !!,"I'm sorry, Tracking of Prescription Refills is currently turned off." G ENQ
"RTN","IBTRKR3",16,0)
 W !!!,"Select the Date Range of Rx Refills to Add to Claims Tracking.",!
"RTN","IBTRKR3",17,0)
 D DATE^IBOUTL
"RTN","IBTRKR3",18,0)
 I IBBDT<1!(IBEDT<1) G ENQ
"RTN","IBTRKR3",19,0)
 S IBTSBDT=IBBDT,IBTSEDT=IBEDT
"RTN","IBTRKR3",20,0)
 ;
"RTN","IBTRKR3",21,0)
 ; -- check selected dates
"RTN","IBTRKR3",22,0)
 S IBTRKR=$G(^IBE(350.9,1,6))
"RTN","IBTRKR3",23,0)
 ; start date can't be before parameters
"RTN","IBTRKR3",24,0)
 I +IBTRKR,IBTSBDT<+IBTRKR S IBTSBDT=IBTRKR W !!,"Begin date is before Claims Tracking Start Date, changed to ",$$DAT1^IBOUTL(IBTSBDT)
"RTN","IBTRKR3",25,0)
 ; -- end date into future
"RTN","IBTRKR3",26,0)
 I IBTSEDT>$$FMADD^XLFDT(DT,-3) W !!,"I'll automatically change the end date to 3 days prior to the date queued to run."
"RTN","IBTRKR3",27,0)
 ;
"RTN","IBTRKR3",28,0)
 W !!!,"I'm going to automatically queue this off and send you a"
"RTN","IBTRKR3",29,0)
 W !,"mail message when complete.",!
"RTN","IBTRKR3",30,0)
 S ZTIO="",ZTRTN="EN1^IBTRKR3",ZTSAVE("IB*")="",ZTDESC="IB - Add Rx Refills to Claims Tracking"
"RTN","IBTRKR3",31,0)
 D ^%ZTLOAD I $G(ZTSK) K ZTSK W !,"Request Queued"
"RTN","IBTRKR3",32,0)
ENQ K ZTSK,ZTIO,ZTSAVE,ZTDESC,ZTRTN
"RTN","IBTRKR3",33,0)
 D HOME^%ZIS
"RTN","IBTRKR3",34,0)
 Q
"RTN","IBTRKR3",35,0)
 ;
"RTN","IBTRKR3",36,0)
EN1 ; -- add rx refills to claims tracking file
"RTN","IBTRKR3",37,0)
 N I,J,X,Y,IBTRKR,IBDT,IBRXN,IBFILL,DFN,IBDATA,IBCNT,IBCNT1,IBCNT2
"RTN","IBTRKR3",38,0)
 ;
"RTN","IBTRKR3",39,0)
 ; -- check parameters
"RTN","IBTRKR3",40,0)
 S IBTRKR=$G(^IBE(350.9,1,6))
"RTN","IBTRKR3",41,0)
 G:'$P(IBTRKR,"^",4) EN1Q ; quit if rx tracking off
"RTN","IBTRKR3",42,0)
 I +IBTRKR,IBTSBDT<+IBTRKR S IBTSBDT=IBTRKR ; start date can't be before parameters
"RTN","IBTRKR3",43,0)
 ;
"RTN","IBTRKR3",44,0)
 ; -- users can queue into future, make sure dates not after date run
"RTN","IBTRKR3",45,0)
 I IBTSEDT>$$FMADD^XLFDT(DT,-3) S IBMESS="(Selected end date of "_$$DAT1^IBOUTL(IBTSEDT)_" automatically changed to "_$$DAT1^IBOUTL($$FMADD^XLFDT(DT,-3))_".)",IBTSEDT=$$FMADD^XLFDT(DT,-3)
"RTN","IBTRKR3",46,0)
 ;
"RTN","IBTRKR3",47,0)
 S IBRXTYP=$O(^IBE(356.6,"AC",4,0)) ; event type pointer for rx billing
"RTN","IBTRKR3",48,0)
 ;
"RTN","IBTRKR3",49,0)
 ; -- cnt= total count, cnt1=count added nsc, cnt2=count of pending
"RTN","IBTRKR3",50,0)
 S (IBCNT,IBCNT1,IBCNT2)=0
"RTN","IBTRKR3",51,0)
 S IBDT=IBTSBDT-.0001
"RTN","IBTRKR3",52,0)
 F  S IBDT=$O(^PSRX("AD",IBDT)) Q:'IBDT!(IBDT>IBTSEDT)  S IBRXN="" F  S IBRXN=$O(^PSRX("AD",IBDT,IBRXN)) Q:'IBRXN  S IBFILL="" F  S IBFILL=$O(^PSRX("AD",IBDT,IBRXN,IBFILL)) Q:IBFILL=""  D RXCHK
"RTN","IBTRKR3",53,0)
 ;
"RTN","IBTRKR3",54,0)
 I $G(IBTALK) D BULL^IBTRKR31
"RTN","IBTRKR3",55,0)
EN1Q I $D(ZTQUEUED) S ZTREQ="@"
"RTN","IBTRKR3",56,0)
 Q
"RTN","IBTRKR3",57,0)
 ;
"RTN","IBTRKR3",58,0)
RXCHK ; -- check and add rx
"RTN","IBTRKR3",59,0)
 S IBCNT=IBCNT+1
"RTN","IBTRKR3",60,0)
 ;I IBFILL<1 G RXCHKQ ;       original fill
"RTN","IBTRKR3",61,0)
 I IBDT>(DT+.24) G RXCHKQ ;  future fill
"RTN","IBTRKR3",62,0)
 I '$D(ZTQUEUED),($G(IBTALK)) W "."
"RTN","IBTRKR3",63,0)
 ;
"RTN","IBTRKR3",64,0)
 S IBRXDATA=$G(^PSRX(IBRXN,0)),IBRXSTAT=$P(IBRXDATA,"^",15)
"RTN","IBTRKR3",65,0)
 S DFN=$P(IBRXDATA,"^",2)
"RTN","IBTRKR3",66,0)
 ;I IBDT=$P($O(^DPT(DFN,"S",(IBDT-.00001))),".") G RXCHKQ ;scheduled appointment on same day as fill date
"RTN","IBTRKR3",67,0)
 ;I $$BABCSC^IBEFUNC(DFN,$P(IBDT,".",1)) G RXCHKQ ; is billable clinic stop in encounter file for data (allows telephone stops on same day, but not others) (P121 - RC, can now bill Rx if on same day as opt visit)
"RTN","IBTRKR3",68,0)
 ;
"RTN","IBTRKR3",69,0)
 ; -- not already in claims tracking
"RTN","IBTRKR3",70,0)
 I $O(^IBT(356,"ARXFL",IBRXN,IBFILL,0)) G RXCHKQ ; already in claims tracking
"RTN","IBTRKR3",71,0)
 ;
"RTN","IBTRKR3",72,0)
 ; -- see if tracking only insured and pt is insured
"RTN","IBTRKR3",73,0)
 I $P(IBTRKR,"^",4)=1,'$$INSURED^IBCNS1(DFN,IBDT) G RXCHKQ ; patient not insure
"RTN","IBTRKR3",74,0)
 ;
"RTN","IBTRKR3",75,0)
 ; -- check rx status (not deleted)
"RTN","IBTRKR3",76,0)
 I IBRXSTAT=13 G RXCHKQ
"RTN","IBTRKR3",77,0)
 ;
"RTN","IBTRKR3",78,0)
 ; -- original fill not released or returned to stock
"RTN","IBTRKR3",79,0)
 I 'IBFILL,'$P($G(^PSRX(IBRXN,2)),"^",13) G RXCHKQ
"RTN","IBTRKR3",80,0)
 I 'IBFILL,$P($G(^PSRX(IBRXN,2)),"^",15) G RXCHKQ
"RTN","IBTRKR3",81,0)
 ;
"RTN","IBTRKR3",82,0)
 ; -- refill not released or returned to stock
"RTN","IBTRKR3",83,0)
 I +IBFILL,'$P($G(^PSRX(IBRXN,1,IBFILL,0)),"^",18) G RXCHKQ
"RTN","IBTRKR3",84,0)
 I +IBFILL,$P($G(^PSRX(IBRXN,1,IBFILL,0)),"^",16) G RXCHKQ
"RTN","IBTRKR3",85,0)
 ;
"RTN","IBTRKR3",86,0)
 ; -- check drug (not investigational, supply, or over the counter drug
"RTN","IBTRKR3",87,0)
 S IBDRUG=$P(IBRXDATA,"^",6)
"RTN","IBTRKR3",88,0)
 D ZERO^IBRXUTL(IBDRUG)
"RTN","IBTRKR3",89,0)
 S IBDEA=$G(^TMP($J,"IBDRUG",+IBDRUG,3))
"RTN","IBTRKR3",90,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBTRKR3",91,0)
 I IBDEA["I"!(IBDEA["S")!(IBDEA["9") G RXCHKQ ; investigational drug, supply or otc
"RTN","IBTRKR3",92,0)
 ;
"RTN","IBTRKR3",93,0)
 ; -- see if insured for prescriptions
"RTN","IBTRKR3",94,0)
 I '$$PTCOV^IBCNSU3(DFN,IBDT,"PHARMACY",.IBANY) S IBRMARK=$S($G(IBANY):"SERVICE NOT COVERED",1:"NOT INSURED")
"RTN","IBTRKR3",95,0)
 ;
"RTN","IBTRKR3",96,0)
 ; -- check sc status and others
"RTN","IBTRKR3",97,0)
 I $G(IBRMARK)="" D CL^SDCO21(DFN,IBDT,"",.IBARR) I $D(IBARR) D
"RTN","IBTRKR3",98,0)
 . S IBM=0 F  S IBM=$O(^PSRX(IBRXN,"ICD",IBM)) Q:'IBM!($G(IBRMARK)'="")  S IBZ=$G(^PSRX(IBRXN,"ICD",IBM,0)) F IBP=1:1:7 Q:$G(IBRMARK)'=""  I $D(IBARR(IBP)) D
"RTN","IBTRKR3",99,0)
 .. S IBRMARK=$S($P(IBZ,"^",IBP+1):$P($T(EXEMPT+IBP),";",3),$P(IBZ,"^",IBP+1)=0:"",1:"NEEDS SC DETERMINATION")
"RTN","IBTRKR3",100,0)
 ;
"RTN","IBTRKR3",101,0)
 ;
"RTN","IBTRKR3",102,0)
 ; -- ok to add to tracking module
"RTN","IBTRKR3",103,0)
 D REFILL^IBTUTL1(DFN,IBRXTYP,IBDT,IBRXN,IBFILL,$G(IBRMARK)) I '$D(ZTQUEUED),$G(IBTALK) W "+"
"RTN","IBTRKR3",104,0)
 I $G(IBRMARK)'="" S IBCNT2=IBCNT2+1
"RTN","IBTRKR3",105,0)
 I $G(IBRMARK)="" S IBCNT1=IBCNT1+1
"RTN","IBTRKR3",106,0)
 K IBANY,IBRMARK,VAEL,VA,IBDEA,IBDRUG,IBRXSTAT,IBRXDATA,DFN,X,Y
"RTN","IBTRKR3",107,0)
 K IBARR,IBM,IBZ,IBP
"RTN","IBTRKR3",108,0)
RXCHKQ Q
"RTN","IBTRKR3",109,0)
 ;
"RTN","IBTRKR3",110,0)
EXEMPT ; exemption reasons
"RTN","IBTRKR3",111,0)
 ;;AGENT ORANGE
"RTN","IBTRKR3",112,0)
 ;;IONIZING RADIATION
"RTN","IBTRKR3",113,0)
 ;;SC TREATMENT
"RTN","IBTRKR3",114,0)
 ;;ENV. CONTAM.
"RTN","IBTRKR3",115,0)
 ;;MILITARY SEXUAL TRAUMA
"RTN","IBTRKR3",116,0)
 ;;HEAD/NECK CANCER
"RTN","IBTRKR3",117,0)
 ;;COMBAT VETERAN
"RTN","IBTRKR3",118,0)
 ;;
"RTN","IBTRKR31")
0^20^B9080810
"RTN","IBTRKR31",1,0)
IBTRKR31 ;ALB/AAS - CLAIMS TRACKING - DBLCHK RX FILLS ; 13-AUG-93
"RTN","IBTRKR31",2,0)
 ;;2.0;INTEGRATED BILLING;**33,121,160,309**;21-MAR-94
"RTN","IBTRKR31",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBTRKR31",4,0)
 ;
"RTN","IBTRKR31",5,0)
% ; -- Double check rx data routine
"RTN","IBTRKR31",6,0)
DBLCHK(IBTRN) ; -- double check rx before billing, input tracking id
"RTN","IBTRKR31",7,0)
 N IBX,IBFILL,IBFILLD,IBRXN,IBTRND,IBRMARK,IBRXSTAT,IBDEA,IBDRUG,IBRXDATA,X,Y,IBY
"RTN","IBTRKR31",8,0)
 S IBX=0
"RTN","IBTRKR31",9,0)
 S IBTRND=$G(^IBT(356,+IBTRN,0)) I IBTRND="" G DBLCHKQ
"RTN","IBTRKR31",10,0)
 S IBRXN=$P(IBTRND,"^",8),IBFILL=$P(IBTRND,"^",10),IBFILLD=""
"RTN","IBTRKR31",11,0)
 ;
"RTN","IBTRKR31",12,0)
 I IBFILL=0 S IBY=$G(^PSRX(+IBRXN,2)),IBFILLD=$P(IBY,U,2)_U_$P(IBY,U,13)_U_$P(IBY,U,15)
"RTN","IBTRKR31",13,0)
 I IBFILL>0 S IBY=$G(^PSRX(+IBRXN,1,+IBFILL,0)),IBFILLD=$P(IBY,U,1)_U_$P(IBY,U,18)_U_$P(IBY,U,16)
"RTN","IBTRKR31",14,0)
 ;
"RTN","IBTRKR31",15,0)
 I (IBFILL'>0&(IBFILL'=0))!(IBRXN<1) S IBRMARK="INVALID PRESCRIPTION ENTRY" G DBLCHKQ
"RTN","IBTRKR31",16,0)
 ;
"RTN","IBTRKR31",17,0)
 S IBRXDATA=$G(^PSRX(IBRXN,0)),IBRXSTAT=$P(IBRXDATA,"^",15)
"RTN","IBTRKR31",18,0)
 ;S DFN=+$P(IBRXDATA,"^",2),IBDT=+IBFILLD
"RTN","IBTRKR31",19,0)
 ;I IBDT=$P($O(^DPT(DFN,"S",(IBDT-.00001))),".") S IBRMARK="REFILL ON VISIT DATE" G DBLCHKQ
"RTN","IBTRKR31",20,0)
 ;
"RTN","IBTRKR31",21,0)
 ; -- check rx status (not  deleted)
"RTN","IBTRKR31",22,0)
 I IBRXSTAT=13 S IBRMARK="PRESCRIPTION DELETED" G DBLCHKQ
"RTN","IBTRKR31",23,0)
 ;
"RTN","IBTRKR31",24,0)
 ; -- refill not released or returned to stock
"RTN","IBTRKR31",25,0)
 I '$P(IBFILLD,"^",2) S IBRMARK="PRESCRIPTION NOT RELEASED" G DBLCHKQ
"RTN","IBTRKR31",26,0)
 I $P(IBFILLD,"^",3) S IBRMARK="PRESCRIPTION NOT RELEASED" G DBLCHKQ
"RTN","IBTRKR31",27,0)
 ;
"RTN","IBTRKR31",28,0)
 ; -- check drug (not investigational, supply, or over the counter drug
"RTN","IBTRKR31",29,0)
 S IBDRUG=$P(IBRXDATA,"^",6)
"RTN","IBTRKR31",30,0)
 D ZERO^IBRXUTL(IBDRUG)
"RTN","IBTRKR31",31,0)
 S IBDEA=$G(^TMP($J,"IBDRUG",+IBDRUG,3))
"RTN","IBTRKR31",32,0)
 I IBDEA["I"!(IBDEA["S")!(IBDEA["9") S IBRMARK="DRUG NOT BILLABLE" G DBLCHKQ ; investigational drug, supply or otc
"RTN","IBTRKR31",33,0)
 ;
"RTN","IBTRKR31",34,0)
 S IBX=1
"RTN","IBTRKR31",35,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBTRKR31",36,0)
 ;
"RTN","IBTRKR31",37,0)
DBLCHKQ I $G(IBRMARK)]"" D
"RTN","IBTRKR31",38,0)
 .S IBRMARK=$O(^IBE(356.8,"B",IBRMARK,0)) I 'IBRMARK S IBRMARK=999
"RTN","IBTRKR31",39,0)
 .N DA,DR,DIC,DIE
"RTN","IBTRKR31",40,0)
 .L +^IBT(356,+IBTRN):5 I '$T Q
"RTN","IBTRKR31",41,0)
 .S DA=IBTRN,DIE="^IBT(356,",DR=".19////"_IBRMARK
"RTN","IBTRKR31",42,0)
 .D ^DIE
"RTN","IBTRKR31",43,0)
 .L -^IBT(356,+IBTRN)
"RTN","IBTRKR31",44,0)
 Q IBX
"RTN","IBTRKR31",45,0)
 ;
"RTN","IBTRKR31",46,0)
 ;
"RTN","IBTRKR31",47,0)
BULL ; -- send bulletin
"RTN","IBTRKR31",48,0)
 ;
"RTN","IBTRKR31",49,0)
 S XMSUB="Rx Refills added to Claims Tracking Complete"
"RTN","IBTRKR31",50,0)
 S IBT(1)="The process to automatically add Rx Refills has successfully completed."
"RTN","IBTRKR31",51,0)
 S IBT(1.1)=""
"RTN","IBTRKR31",52,0)
 S IBT(2)="              Start Date: "_$$DAT1^IBOUTL(IBTSBDT)
"RTN","IBTRKR31",53,0)
 S IBT(3)="                End Date: "_$$DAT1^IBOUTL(IBTSEDT)
"RTN","IBTRKR31",54,0)
 I $D(IBMESS) S IBT(3.1)=IBMESS
"RTN","IBTRKR31",55,0)
 S IBT(4)=""
"RTN","IBTRKR31",56,0)
 S IBT(5)="  Total Rx fills checked: "_$G(IBCNT)
"RTN","IBTRKR31",57,0)
 S IBT(6)="Total NSC Rx fills Added: "_$G(IBCNT1)
"RTN","IBTRKR31",58,0)
 S IBT(7)=" Total SC Rx fills Added: "_$G(IBCNT2)
"RTN","IBTRKR31",59,0)
 S IBT(8)=""
"RTN","IBTRKR31",60,0)
 S IBT(9)="*The fills added as SC require determination and editing to be billed"
"RTN","IBTRKR31",61,0)
 D SEND
"RTN","IBTRKR31",62,0)
BULLQ Q
"RTN","IBTRKR31",63,0)
 ;
"RTN","IBTRKR31",64,0)
SEND S XMDUZ="INTEGRATED BILLING PACKAGE",XMTEXT="IBT("
"RTN","IBTRKR31",65,0)
 K XMY S XMN=0
"RTN","IBTRKR31",66,0)
 S XMY(DUZ)=""
"RTN","IBTRKR31",67,0)
 D ^XMD
"RTN","IBTRKR31",68,0)
 K X,Y,IBI,IBT,IBGRP,XMDUZ,XMTEXT,XMY,XMSUB
"RTN","IBTRKR31",69,0)
 Q
"RTN","IBTUBO2")
0^21^B26096597
"RTN","IBTUBO2",1,0)
IBTUBO2 ;ALB/AAS - UNBILLED AMOUNTS - GENERATE UNBILLED REPORTS ;03 Aug 2004  8:21 AM
"RTN","IBTUBO2",2,0)
 ;;2.0;INTEGRATED BILLING;**19,31,32,91,123,159,192,155,309**;21-MAR-94
"RTN","IBTUBO2",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBTUBO2",4,0)
 ;
"RTN","IBTUBO2",5,0)
INPT(DGPM) ; - Check if inpatient episode has bills or final bill; if not,
"RTN","IBTUBO2",6,0)
 ;   ^TMP($J,"IBTUB-INPT",NAME@@DFN,DATE,IBX)=bill status
"RTN","IBTUBO2",7,0)
 ;   ^TMP($J,"IBTUB-INPT_MRA",NAME@@DFN,DATE,IBX)=1 if MRA request
"RTN","IBTUBO2",8,0)
 ;   *Pre-set variables: DFN=patient IEN, DGPM=pointer to file #405,
"RTN","IBTUBO2",9,0)
 ;                       IBDT=event date, IBRT=bill rate,
"RTN","IBTUBO2",10,0)
 ;                       IBEDT=reporting period date
"RTN","IBTUBO2",11,0)
 I '$G(DFN)!('$G(DGPM))!('$G(IBDT))!('$G(IBRT)) G INPTQ
"RTN","IBTUBO2",12,0)
 N IBIP,IBDATA,IBNAME,IBNCF,IBXX,X,Y,IBMRA
"RTN","IBTUBO2",13,0)
 S IBNAME=$P($G(^DPT(DFN,0)),U)
"RTN","IBTUBO2",14,0)
 I $D(^TMP($J,"IBTUB-INPT",IBNAME_"@@"_DFN,IBDT)) G INPTQ
"RTN","IBTUBO2",15,0)
 I $P($G(^DGPM(DGPM,0)),U,11) G INPTQ ;      Admitted for SC condition.
"RTN","IBTUBO2",16,0)
 I $$SC^IBTUBOU($P($G(^DGPM(DGPM,0)),U,16)) G INPTQ ; Check PTF for SC.
"RTN","IBTUBO2",17,0)
 S (IBIP(1),IBIP(2))=0 ; Set claim flags.
"RTN","IBTUBO2",18,0)
 ;
"RTN","IBTUBO2",19,0)
 ; - Check patient's claims.
"RTN","IBTUBO2",20,0)
 S (IBNCF,X)=0
"RTN","IBTUBO2",21,0)
 F  S X=$O(^DGCR(399,"C",DFN,X)) Q:'X  D  Q:IBIP(1)&(IBIP(2))
"RTN","IBTUBO2",22,0)
 . S IBDATA=$$CKBIL^IBTUBOU(X,1) Q:IBDATA=""
"RTN","IBTUBO2",23,0)
 . ;
"RTN","IBTUBO2",24,0)
 . ; The admission date on the bill is different from the Event date.
"RTN","IBTUBO2",25,0)
 . I $P(IBDATA,U,5)'=$P(IBDT,".") Q
"RTN","IBTUBO2",26,0)
 . S IBNCF=IBNCF+1 ; Increment the number of bills on file for episode
"RTN","IBTUBO2",27,0)
 . ;
"RTN","IBTUBO2",28,0)
 . ; If Compile/Store & Not authorized before reporting period - Quit.
"RTN","IBTUBO2",29,0)
 . I $G(IBCOMP),$S($P(IBDATA,U,2)'=2:$P(IBDATA,U,3),1:$P(IBDATA,U,6))>IBEDT Q
"RTN","IBTUBO2",30,0)
 . ;
"RTN","IBTUBO2",31,0)
 . S IBIP($P(IBDATA,U,4))=$S($P(IBDATA,U,2)'=2:1,1:2) ;   Episode billed for inst/prof bill type
"RTN","IBTUBO2",32,0)
 ;
"RTN","IBTUBO2",33,0)
 I IBIP(1)=1 G:IBIP(2)=1!(IBDT<2990901) INPTQ ; Episode is billed.
"RTN","IBTUBO2",34,0)
 ;
"RTN","IBTUBO2",35,0)
 ; - Add to episodes missing inst./prof. bills.
"RTN","IBTUBO2",36,0)
 S (IBXX,IBMRA)=""
"RTN","IBTUBO2",37,0)
 ;
"RTN","IBTUBO2",38,0)
 I IBIP(1)'=1 D
"RTN","IBTUBO2",39,0)
 . I 'IBIP(1) S IBUNB("EPISM-I")=IBUNB("EPISM-I")+1 S:IBDET IBXX="I"
"RTN","IBTUBO2",40,0)
 . I $G(IBXTRACT) S IB(1)=IB(1)+1 ; For DM extract.
"RTN","IBTUBO2",41,0)
 . I IBIP(1)=2 S IBUNB("EPISM-I-MRA")=IBUNB("EPISM-I-MRA")+1 S:IBDET IBMRA="I"
"RTN","IBTUBO2",42,0)
 ;
"RTN","IBTUBO2",43,0)
 I IBIP(2)'=1,IBDT'<2990901 D
"RTN","IBTUBO2",44,0)
 . I 'IBIP(2) S IBUNB("EPISM-P")=IBUNB("EPISM-P")+1 S:IBDET IBXX=$S(IBXX="I":"I,P",1:"P")
"RTN","IBTUBO2",45,0)
 . I $G(IBXTRACT) S IB(3)=IB(3)+1 ; For DM extract.
"RTN","IBTUBO2",46,0)
 . I IBIP(2)=2 S IBUNB("EPISM-P-MRA")=IBUNB("EPISM-P-MRA")+1 S:IBDET IBMRA=$S(IBMRA="I":"I,P",1:"P")
"RTN","IBTUBO2",47,0)
 ;
"RTN","IBTUBO2",48,0)
 I $S('IBIP(1):1,'IBIP(2):1,1:0) S IBUNB("EPISM-A")=IBUNB("EPISM-A")+1  ; Number of Admissions missing claims
"RTN","IBTUBO2",49,0)
 S:IBIP(1)=2!(IBIP(2)=2) IBUNB("EPISM-A-MRA")=IBUNB("EPISM-A-MRA")+1
"RTN","IBTUBO2",50,0)
 I $G(IBXTRACT) S IB(5)=IB(5)+1 ; For DM extract.
"RTN","IBTUBO2",51,0)
 ;
"RTN","IBTUBO2",52,0)
 I '$G(IBINMRA),IBIP(1)=2 G:IBIP(2)=1 INPTQ
"RTN","IBTUBO2",53,0)
 I '$G(IBINMRA),IBIP(2)=2 G:IBIP(1)=1 INPTQ
"RTN","IBTUBO2",54,0)
 ;
"RTN","IBTUBO2",55,0)
 ; - Set global for report.
"RTN","IBTUBO2",56,0)
 I $S($G(IBINMRA):1,1:IBXX'="") S ^TMP($J,"IBTUB-INPT",IBNAME_"@@"_DFN,IBDT,IBX)=IBNCF_U_IBXX_U_U_U_$$HOSP^IBTUBOU(DGPM)
"RTN","IBTUBO2",57,0)
 I IBMRA'="",$G(IBINMRA) S ^TMP($J,"IBTUB-INPT_MRA",IBNAME_"@@"_DFN,IBDT,IBX)=1_U_IBMRA
"RTN","IBTUBO2",58,0)
 ;
"RTN","IBTUBO2",59,0)
INPTQ Q
"RTN","IBTUBO2",60,0)
 ;
"RTN","IBTUBO2",61,0)
RX(IBRX) ; - Check if prescription has been billed; if not,
"RTN","IBTUBO2",62,0)
 ;   ^TMP($J,"IBTUB-RX",NAME@@DFN,DATE@RX#,IBX)=bill status^drug name^
"RTN","IBTUBO2",63,0)
 ;                                            original fill date
"RTN","IBTUBO2",64,0)
 ;   ^TMP($J,"IBTUB-RX_MRA",NAME@@DFN,DATE@RX#,IBX)=1 if req MRA
"RTN","IBTUBO2",65,0)
 ;
"RTN","IBTUBO2",66,0)
 ;   *Pre-set variables: DFN=patient IEN, IBDT=refill date,
"RTN","IBTUBO2",67,0)
 ;                       IBRT=bill rate, IBRX=pointer to file #52,
"RTN","IBTUBO2",68,0)
 ;                       IBEDT=reporting period date
"RTN","IBTUBO2",69,0)
 I '$G(DFN)!('$G(IBDT))!('$G(IBRT))!('$G(IBRX)) G RXQ
"RTN","IBTUBO2",70,0)
 N IBDATA,IBDAY,IBDRX,IBFL,IBFLG,IBOFD,IBNAME,IBND,IBNO,IBNCF,RX,X,RXDT,IBMRA,IBCO
"RTN","IBTUBO2",71,0)
 ;
"RTN","IBTUBO2",72,0)
 ; - Be sure prescription has an RX#.
"RTN","IBTUBO2",73,0)
 S IBND=$G(^PSRX(IBRX,0)),IBNO=$P(IBND,U) G:IBNO="" RXQ
"RTN","IBTUBO2",74,0)
 ;
"RTN","IBTUBO2",75,0)
 ; - Retrieve the Prescription Original Fill Date
"RTN","IBTUBO2",76,0)
 S IBOFD=$P($G(^PSRX(IBRX,2)),"^",2)\1
"RTN","IBTUBO2",77,0)
 ;
"RTN","IBTUBO2",78,0)
 S IBDAY=$E(IBDT,1,7),IBDRX=IBDAY_"@@"_IBNO,IBNAME=$P($G(^DPT(DFN,0)),U)
"RTN","IBTUBO2",79,0)
 ;
"RTN","IBTUBO2",80,0)
 ; - Be sure that this fill was not already marked as unbilled.
"RTN","IBTUBO2",81,0)
 I $D(^TMP($J,"IBTUB-RX",IBNAME_"@@"_DFN,IBDRX,IBX)) G RXQ
"RTN","IBTUBO2",82,0)
 ;
"RTN","IBTUBO2",83,0)
 ; - Look at all fills of the prescription that are on a claim.
"RTN","IBTUBO2",84,0)
 S (IBFL,X)="",(IBFLG,IBNCF,IBNCF(0),IBMRA)=0
"RTN","IBTUBO2",85,0)
 F  S X=$O(^IBA(362.4,"B",IBNO,X)) Q:'X  D  Q:IBFL
"RTN","IBTUBO2",86,0)
 . S RX=$G(^IBA(362.4,X,0)),RXDT=$P(RX,U,3)\1
"RTN","IBTUBO2",87,0)
 . I RXDT=IBOFD S IBFLG=1  ; Original Fill Date Billed?
"RTN","IBTUBO2",88,0)
 . I RXDT'=IBDAY Q  ; RX refill and claim refill dates not the same.
"RTN","IBTUBO2",89,0)
 . ;
"RTN","IBTUBO2",90,0)
 . ; - Skip bill if not authorized (and not meeting other criteria).
"RTN","IBTUBO2",91,0)
 . S IBDATA=$$CKBIL^IBTUBOU($P(RX,U,2)) Q:IBDATA=""
"RTN","IBTUBO2",92,0)
 . S IBNCF=IBNCF+1 ; Increment the number of bills on file for the episode
"RTN","IBTUBO2",93,0)
 . ; If Compile/Store & Not authorized before reporting period - Quit.
"RTN","IBTUBO2",94,0)
 . I $G(IBCOMP),$S($P(IBDATA,U,2)'=2:$P(IBDATA,U,3),1:$P(IBDATA,U,6))>IBEDT S IBNONMRA=0 Q
"RTN","IBTUBO2",95,0)
 . S:$P(IBDATA,U,2)'=2 IBFL=1,IBMRA=0 ; at least 1 non-MRA bill exists
"RTN","IBTUBO2",96,0)
 . S:$P(IBDATA,U,2)=2 IBMRA=1 ; at least 1 MRA bill exists
"RTN","IBTUBO2",97,0)
 . ;
"RTN","IBTUBO2",98,0)
 ;
"RTN","IBTUBO2",99,0)
 I IBFL G RXQ ; Refill has been billed.
"RTN","IBTUBO2",100,0)
 ;
"RTN","IBTUBO2",101,0)
RX1 ; - Calculate unbilled amounts.
"RTN","IBTUBO2",102,0)
 S:'IBMRA IBUNB("PRESCRP")=IBUNB("PRESCRP")+1
"RTN","IBTUBO2",103,0)
 I IBMRA S IBUNB("PRESCRP-MRA")=IBUNB("PRESCRP-MRA")+1
"RTN","IBTUBO2",104,0)
 S IBCO=$$BICOST^IBCRCI(IBRT,3,IBDAY,"PRESCRIPTION FILL")
"RTN","IBTUBO2",105,0)
 S:'IBMRA IBUNB("UNBILRX")=IBUNB("UNBILRX")+IBCO
"RTN","IBTUBO2",106,0)
 I IBMRA S IBUNB("UNBILRX-MRA")=IBUNB("UNBILRX-MRA")+IBCO
"RTN","IBTUBO2",107,0)
 I $G(IBXTRACT) D  ; For DM extract.
"RTN","IBTUBO2",108,0)
 . S IB(17)=IB(17)+1
"RTN","IBTUBO2",109,0)
 . S IB(18)=IB(18)+IBCO
"RTN","IBTUBO2",110,0)
 ;
"RTN","IBTUBO2",111,0)
 ; - Set global for report.
"RTN","IBTUBO2",112,0)
 D ZERO^IBRXUTL(+$P(IBND,U,6))
"RTN","IBTUBO2",113,0)
 I $S($G(IBINMRA):1,1:'IBMRA) S ^TMP($J,"IBTUB-RX",IBNAME_"@@"_DFN,IBDRX,IBX)=IBNCF_U_$P($G(^VA(200,+$P(IBND,U,4),0)),U)_U_$P($G(^PSRX(IBRX,2)),U,2)_U_U_IBFLG_U_$G(^TMP($J,"IBDRUG",+$P(IBND,U,6),.01))
"RTN","IBTUBO2",114,0)
 I IBMRA,$G(IBINMRA) S ^TMP($J,"IBTUB-RX_MRA",IBNAME_"@@"_DFN,IBDRX,IBX)=1
"RTN","IBTUBO2",115,0)
 K ^TMP($J,"IBDRUG")
"RTN","IBTUBO2",116,0)
 ;
"RTN","IBTUBO2",117,0)
RXQ Q
"VER")
8.0^22.0
"BLD",6209,6)
^SEQ #282
**END**
**END**
