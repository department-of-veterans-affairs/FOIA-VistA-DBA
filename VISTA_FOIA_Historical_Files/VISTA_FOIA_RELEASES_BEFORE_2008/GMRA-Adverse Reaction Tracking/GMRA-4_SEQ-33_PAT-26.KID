Released GMRA*4*26 SEQ #33
Extracted from mail message
**KIDS**:GMRA*4.0*26^

**INSTALL NAME**
GMRA*4.0*26
"BLD",5737,0)
GMRA*4.0*26^ADVERSE REACTION TRACKING^0^3060906^y
"BLD",5737,1,0)
^^2^2^3050621^
"BLD",5737,1,1,0)
Remote Data Interoperability updates.  Please see FORUM for a full 
"BLD",5737,1,2,0)
description of the updates.
"BLD",5737,4,0)
^9.64PA^^
"BLD",5737,6)
7^
"BLD",5737,6.3)
4
"BLD",5737,"ABPKG")
n
"BLD",5737,"KRN",0)
^9.67PA^8989.52^19
"BLD",5737,"KRN",.4,0)
.4
"BLD",5737,"KRN",.401,0)
.401
"BLD",5737,"KRN",.402,0)
.402
"BLD",5737,"KRN",.403,0)
.403
"BLD",5737,"KRN",.5,0)
.5
"BLD",5737,"KRN",.84,0)
.84
"BLD",5737,"KRN",3.6,0)
3.6
"BLD",5737,"KRN",3.8,0)
3.8
"BLD",5737,"KRN",9.2,0)
9.2
"BLD",5737,"KRN",9.8,0)
9.8
"BLD",5737,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5737,"KRN",9.8,"NM",1,0)
GMRAOR^^0^B68674698
"BLD",5737,"KRN",9.8,"NM",2,0)
GMRAHDR^^0^B21654904
"BLD",5737,"KRN",9.8,"NM","B","GMRAHDR",2)

"BLD",5737,"KRN",9.8,"NM","B","GMRAOR",1)

"BLD",5737,"KRN",19,0)
19
"BLD",5737,"KRN",19.1,0)
19.1
"BLD",5737,"KRN",101,0)
101
"BLD",5737,"KRN",409.61,0)
409.61
"BLD",5737,"KRN",771,0)
771
"BLD",5737,"KRN",870,0)
870
"BLD",5737,"KRN",8989.51,0)
8989.51
"BLD",5737,"KRN",8989.52,0)
8989.52
"BLD",5737,"KRN",8994,0)
8994
"BLD",5737,"KRN","B",.4,.4)

"BLD",5737,"KRN","B",.401,.401)

"BLD",5737,"KRN","B",.402,.402)

"BLD",5737,"KRN","B",.403,.403)

"BLD",5737,"KRN","B",.5,.5)

"BLD",5737,"KRN","B",.84,.84)

"BLD",5737,"KRN","B",3.6,3.6)

"BLD",5737,"KRN","B",3.8,3.8)

"BLD",5737,"KRN","B",9.2,9.2)

"BLD",5737,"KRN","B",9.8,9.8)

"BLD",5737,"KRN","B",19,19)

"BLD",5737,"KRN","B",19.1,19.1)

"BLD",5737,"KRN","B",101,101)

"BLD",5737,"KRN","B",409.61,409.61)

"BLD",5737,"KRN","B",771,771)

"BLD",5737,"KRN","B",870,870)

"BLD",5737,"KRN","B",8989.51,8989.51)

"BLD",5737,"KRN","B",8989.52,8989.52)

"BLD",5737,"KRN","B",8994,8994)

"BLD",5737,"QUES",0)
^9.62^^
"BLD",5737,"REQB",0)
^9.611^3^3
"BLD",5737,"REQB",1,0)
GMRA*4.0*13^1
"BLD",5737,"REQB",2,0)
GMRA*4.0*24^1
"BLD",5737,"REQB",3,0)
RA*5.0*72^2
"BLD",5737,"REQB","B","GMRA*4.0*13",1)

"BLD",5737,"REQB","B","GMRA*4.0*24",2)

"BLD",5737,"REQB","B","RA*5.0*72",3)

"MBREQ")
0
"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
26^3060906^1450
"PKG",140,22,1,"PAH",1,1,0)
^^2^2^3060906
"PKG",140,22,1,"PAH",1,1,1,0)
Remote Data Interoperability updates.  Please see FORUM for a full 
"PKG",140,22,1,"PAH",1,1,2,0)
description of the updates.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","GMRAHDR")
0^2^B21654904^B18743099
"RTN","GMRAHDR",1,0)
GMRAHDR ;SLC/DAN - HDR calls for ART ;5/12/06  08:04
"RTN","GMRAHDR",2,0)
 ;;4.0;Adverse Reaction Tracking;**18,24,26**;Mar 29, 1996;Build 4
"RTN","GMRAHDR",3,0)
 ;
"RTN","GMRAHDR",4,0)
 ;The variable GMRADONT can be set before making a call to this
"RTN","GMRAHDR",5,0)
 ;routine if you'd like to be able to change data but not have it
"RTN","GMRAHDR",6,0)
 ;sent to the HDR.  If GMRADONT has a positive value then nothing
"RTN","GMRAHDR",7,0)
 ;will be queued to be sent to the HDR.
"RTN","GMRAHDR",8,0)
 ;A check will also be made for the existence of VAFCA08 to indicate
"RTN","GMRAHDR",9,0)
 ;whether a patient merge is taking place.  If so, then data isn't
"RTN","GMRAHDR",10,0)
 ;sent to the HDR.
"RTN","GMRAHDR",11,0)
 ;
"RTN","GMRAHDR",12,0)
SETADR ;Call here when updating data
"RTN","GMRAHDR",13,0)
 N IEN,OIEN
"RTN","GMRAHDR",14,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send HDR information if variable is set
"RTN","GMRAHDR",15,0)
 S IEN=$S($D(DA)=1:DA,1:DA($O(DA("?"),-1)))
"RTN","GMRAHDR",16,0)
 I +$P($G(^GMR(120.8,IEN,0)),U,12)=0 Q  ;Stop if it isn't signed off yet
"RTN","GMRAHDR",17,0)
 I $$TESTPAT^VADPT($P(^GMR(120.8,IEN,0),U)) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",18,0)
 D TASK("ADR",IEN),UPDRDI ;26 Schedule entry to be sent to HDR, note new data for RDI
"RTN","GMRAHDR",19,0)
 I $P($G(^GMR(120.8,IEN,0)),U,6)="o" S OIEN=+$O(^GMR(120.85,"C",IEN,0)) I $D(^GMR(120.85,OIEN,0)),'+$G(^GMR(120.8,IEN,"ER")) D TASK("OBS",OIEN) ;If observed reaction, send observed data on sign off
"RTN","GMRAHDR",20,0)
 Q
"RTN","GMRAHDR",21,0)
 ;
"RTN","GMRAHDR",22,0)
KILLADR ;Call here when data is deleted
"RTN","GMRAHDR",23,0)
 N IEN
"RTN","GMRAHDR",24,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send data to HDR if variable is set
"RTN","GMRAHDR",25,0)
 S IEN=$S($D(DA)=1:DA,1:DA($O(DA("?"),-1)))
"RTN","GMRAHDR",26,0)
 I $P($G(^GMR(120.8,IEN,0)),U,12)=0 Q  ;Stop if it isn't signed off yet
"RTN","GMRAHDR",27,0)
 I $$TESTPAT^VADPT($P(^GMR(120.8,IEN,0),U)) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",28,0)
 D TASK("ADR",IEN),UPDRDI ;26 Schedule entry to be sent to the HDR, note new data for RDI
"RTN","GMRAHDR",29,0)
 Q
"RTN","GMRAHDR",30,0)
 ;
"RTN","GMRAHDR",31,0)
SETAA ;Action taken when assessment is changed
"RTN","GMRAHDR",32,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send data if variable is set
"RTN","GMRAHDR",33,0)
 I $$TESTPAT^VADPT(DA) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",34,0)
 D TASK("ASMT",DA)
"RTN","GMRAHDR",35,0)
 Q
"RTN","GMRAHDR",36,0)
 ;
"RTN","GMRAHDR",37,0)
KILLAA ;Action taken when value is deleted
"RTN","GMRAHDR",38,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send data to HDR if variable is set
"RTN","GMRAHDR",39,0)
 I $$TESTPAT^VADPT(DA) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",40,0)
 D TASK("ASMT",DA)
"RTN","GMRAHDR",41,0)
 Q
"RTN","GMRAHDR",42,0)
 ;
"RTN","GMRAHDR",43,0)
SETOB ;Make call to HDR when observation data is added or edited
"RTN","GMRAHDR",44,0)
 N IEN,AIEN
"RTN","GMRAHDR",45,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send data to HDR if variable is set
"RTN","GMRAHDR",46,0)
 S IEN=$S($D(DA)=1:DA,1:DA($O(DA("?"),-1)))
"RTN","GMRAHDR",47,0)
 S AIEN=+$P($G(^GMR(120.85,IEN,0)),U,15) Q:'+AIEN  ;Stop if there's no related reaction
"RTN","GMRAHDR",48,0)
 I $P($G(^GMR(120.8,AIEN,0)),U,12)=0 Q  ;Stop if related reaction not signed off
"RTN","GMRAHDR",49,0)
 I $$TESTPAT^VADPT($P(^GMR(120.8,AIEN,0),U)) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",50,0)
 D TASK("OBS",IEN)
"RTN","GMRAHDR",51,0)
 Q
"RTN","GMRAHDR",52,0)
 ;
"RTN","GMRAHDR",53,0)
KILLOB ;Action upon deletion of observation data
"RTN","GMRAHDR",54,0)
 N IEN,AIEN
"RTN","GMRAHDR",55,0)
 I $G(GMRADONT)!($G(XDRDVALF)=1) Q  ;Don't send data to HDR if variable is set
"RTN","GMRAHDR",56,0)
 S IEN=$S($D(DA)=1:DA,1:DA($O(DA("?"),-1)))
"RTN","GMRAHDR",57,0)
 S AIEN=+$P($G(^GMR(120.85,IEN,0)),U,15) Q:'AIEN  ;Quit if there's no related reaction
"RTN","GMRAHDR",58,0)
 I +$P($G(^GMR(120.8,AIEN,0)),U,12)=0 Q  ;Quit if related reaction not signed off
"RTN","GMRAHDR",59,0)
 I $$TESTPAT^VADPT($P(^GMR(120.8,AIEN,0),U)) Q  ;24 Don't send data for test patients
"RTN","GMRAHDR",60,0)
 D TASK("OBS",IEN)
"RTN","GMRAHDR",61,0)
 Q
"RTN","GMRAHDR",62,0)
 ;
"RTN","GMRAHDR",63,0)
TASK(TYPE,IEN) ;Create task, if needed, and add entry to list of items to be sent to HDR
"RTN","GMRAHDR",64,0)
 N ZTRTN,ZTDESC,ZTDTH,ZTSK,ZTIO
"RTN","GMRAHDR",65,0)
 L +^XTMP("GMRAHDR") ;Control global so no new entries are added
"RTN","GMRAHDR",66,0)
 I '$D(^XTMP("GMRAHDR")) S ^XTMP("GMRAHDR",0)=$$FMADD^XLFDT(DT,30)_U_$$NOW^XLFDT_U_"Send allergy data to HDR"
"RTN","GMRAHDR",67,0)
 I '$D(^XTMP("GMRAHDR","TASK")) D
"RTN","GMRAHDR",68,0)
 .S ZTRTN="DQ^GMRAHDR",ZTDESC="Transmit allergy data to HDR",ZTDTH=$$HADD^XLFDT($H,,,2),ZTIO="" D ^%ZTLOAD S ^XTMP("GMRAHDR","TASK")=ZTSK
"RTN","GMRAHDR",69,0)
 S ^XTMP("GMRAHDR",TYPE,IEN)="" ;Store off entry to be sent later
"RTN","GMRAHDR",70,0)
 L -^XTMP("GMRAHDR") ;Release lock
"RTN","GMRAHDR",71,0)
 Q
"RTN","GMRAHDR",72,0)
 ;
"RTN","GMRAHDR",73,0)
DQ ;Send data to HDR
"RTN","GMRAHDR",74,0)
 N TYPE,IEN,A
"RTN","GMRAHDR",75,0)
 L +^XTMP("GMRAHDR") ;Get control of global
"RTN","GMRAHDR",76,0)
 F TYPE="ADR","ASMT","OBS" I $D(^XTMP("GMRAHDR",TYPE)) D
"RTN","GMRAHDR",77,0)
 .S IEN=0 F  S IEN=$O(^XTMP("GMRAHDR",TYPE,IEN)) Q:'+IEN  I $L($T(QUEUE^VDEFQM)) S A=$$QUEUE^VDEFQM("ORU^R01","SUBTYPE="_$S(TYPE="ADR":"ALGY",TYPE="ASMT":"ADAS",1:"ADRA")_"^IEN="_IEN,.GMRAERR)
"RTN","GMRAHDR",78,0)
 K ^XTMP("GMRAHDR")
"RTN","GMRAHDR",79,0)
 L -^XTMP("GMRAHDR")
"RTN","GMRAHDR",80,0)
 Q
"RTN","GMRAHDR",81,0)
 ;
"RTN","GMRAHDR",82,0)
UPDRDI ;Create flag to let RDI know that patient data has changed
"RTN","GMRAHDR",83,0)
 N PIEN,ERR
"RTN","GMRAHDR",84,0)
 S PIEN=$P($G(^GMR(120.8,IEN,0)),U) Q:'+PIEN  ;Quit if no patient IEN
"RTN","GMRAHDR",85,0)
 I '$D(^XTMP("GMRAOC",PIEN)) Q  ;If no current patient data then no need to set flag
"RTN","GMRAHDR",86,0)
 L +^XTMP("GMRAOC",PIEN)
"RTN","GMRAHDR",87,0)
 S ERR=+$G(^GMR(120.8,IEN,"ER"))
"RTN","GMRAHDR",88,0)
 S ^XTMP("GMRAOC",PIEN,$S('ERR:"NEW",1:"ERROR"))=""
"RTN","GMRAHDR",89,0)
 L -^XTMP("GMRAOC",PIEN)
"RTN","GMRAHDR",90,0)
 Q
"RTN","GMRAOR")
0^1^B68674698^B11288382
"RTN","GMRAOR",1,0)
GMRAOR ;HIRMFO/WAA,RM-OERR UTILITIES ; 7/6/06 6:01am
"RTN","GMRAOR",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,13,26**;Mar 29, 1996;Build 4
"RTN","GMRAOR",3,0)
ORCHK(DFN,TYP,PTR) ; Given a patient IEN (DFN), this function will
"RTN","GMRAOR",4,0)
 ; return 1 (true) if the patient has an allergy to an agent defined
"RTN","GMRAOR",5,0)
 ; by TYP and PTR, else it returns 0 (false). See table below.
"RTN","GMRAOR",6,0)
 ; The Contrast Media Reaction check will return a null if the patient
"RTN","GMRAOR",7,0)
 ; is not in the ART database.
"RTN","GMRAOR",8,0)
 ; 
"RTN","GMRAOR",9,0)
 ;    Contrast Media Reaction:  TYP="CM", PTR (undefined)
"RTN","GMRAOR",10,0)
 ;              Drug Reaction:  TYP="DR", PTR=IEN in ^PSNDF(.
"RTN","GMRAOR",11,0)
 ;           Drug Ingredients:  TYP="IN", PTR=IEN in ^PS(50.416,
"RTN","GMRAOR",12,0)
 ;                 Drug Class:  TYP="CL", PTR=IEN in ^PS(50.605,
"RTN","GMRAOR",13,0)
 ;
"RTN","GMRAOR",14,0)
 N GMRAFLG
"RTN","GMRAOR",15,0)
 S GMRAFLG=0
"RTN","GMRAOR",16,0)
 I $G(DFN)<1!("^CM^DR^IN^CL^"'[("^"_$G(TYP)_"^"))!($G(TYP)'="CM"&($G(PTR)<1)) S GMRAFLG=""
"RTN","GMRAOR",17,0)
 E  D
"RTN","GMRAOR",18,0)
 .D GETDATA(DFN) ;26 Retreive local/remote allergy data for order checking
"RTN","GMRAOR",19,0)
 .I TYP="CM" S GMRAFLG=$$RAD(DFN) ; check for Contrast Media Reaction
"RTN","GMRAOR",20,0)
 .I TYP="DR" S GMRAFLG=$$DRUG(DFN,PTR) ; check for Drug Reaction
"RTN","GMRAOR",21,0)
 .I TYP="IN" S GMRAFLG=$$ING(DFN,PTR) ; Check for Drug Ingredients
"RTN","GMRAOR",22,0)
 .I TYP="CL" S GMRAFLG=$$CLASS(DFN,PTR) ; Check for Drug Class
"RTN","GMRAOR",23,0)
 .Q
"RTN","GMRAOR",24,0)
 Q GMRAFLG
"RTN","GMRAOR",25,0)
RAD(DFN) ; Subroutine checks for Contrast Media Reaction, returns 1 or 0.
"RTN","GMRAOR",26,0)
 N FLG,GMRAL,GMRAPA
"RTN","GMRAOR",27,0)
 D EN1^GMRADPT S FLG=GMRAL
"RTN","GMRAOR",28,0)
 I GMRAL S GMRAPA=0 F  S GMRAPA=$O(GMRAL(GMRAPA)) Q:GMRAPA<1  D  Q:FLG
"RTN","GMRAOR",29,0)
 .S FLG=$$RALLG^GMRARAD(GMRAPA)
"RTN","GMRAOR",30,0)
 .Q
"RTN","GMRAOR",31,0)
 Q FLG
"RTN","GMRAOR",32,0)
DRUG(DFN,PTR) ; Subroutine checks for Drug Reaction, returns 1 or 0.
"RTN","GMRAOR",33,0)
 N %,FLG,GMRAC,GMRADR,GMRAI,PSNVPN,PSNDA S FLG=0
"RTN","GMRAOR",34,0)
 K GMRAING,GMRADRCL
"RTN","GMRAOR",35,0)
 S PSNDA=$P(PTR,"."),PSNVPN=$P(PTR,".",2)
"RTN","GMRAOR",36,0)
 I $G(@($$NDFREF_PSNDA_",0)"))'="" D
"RTN","GMRAOR",37,0)
 .; Check for rxn to ingredients.
"RTN","GMRAOR",38,0)
 .; If use the new entry point if there.
"RTN","GMRAOR",39,0)
 .I $T(DISPDRG^PSNNGR)]"",PSNVPN]"" D
"RTN","GMRAOR",40,0)
 ..K ^TMP("PSNDD",$J) D DISPDRG^PSNNGR ; get ingredients
"RTN","GMRAOR",41,0)
 ..S GMRAI=0,%=1 F  S GMRAI=$O(^TMP("PSNDD",$J,GMRAI)) Q:GMRAI<1  I $D(^TMP("GMRAOC",$J,"API",GMRAI)) S FLG=1,GMRAING(%)=^TMP("PSNDD",$J,GMRAI)_$$FAC(^TMP("GMRAOC",$J,"API",GMRAI)),%=%+1 ;26
"RTN","GMRAOR",42,0)
 ..K ^TMP("PSNDD",$J)
"RTN","GMRAOR",43,0)
 ..Q
"RTN","GMRAOR",44,0)
 .E  D  ; get ingredients
"RTN","GMRAOR",45,0)
 ..K ^TMP("PSN",$J) D ^PSNNGR
"RTN","GMRAOR",46,0)
 ..S GMRAI=0,%=1 F  S GMRAI=$O(^TMP("PSN",$J,GMRAI)) Q:GMRAI<1  I $D(^TMP("GMRAOC",$J,"API",GMRAI)) S FLG=1,GMRAING(%)=^TMP("PSN",$J,GMRAI)_$$FAC(^TMP("GMRAOC",$J,"API",GMRAI)),%=%+1 ;26
"RTN","GMRAOR",47,0)
 ..K ^TMP("PSN",$J)
"RTN","GMRAOR",48,0)
 ..Q
"RTN","GMRAOR",49,0)
 .Q:FLG  ; Rxn to ingredient, quit now.
"RTN","GMRAOR",50,0)
 .; Check for rxn to VA Drug Class
"RTN","GMRAOR",51,0)
 .S PSNDA=$P(PTR,"."),PSNVPN=$P(PTR,".",2)
"RTN","GMRAOR",52,0)
 .N CLASS
"RTN","GMRAOR",53,0)
 .I PSNVPN S CLASS=$$DCLCODE^PSNAPIS(PSNDA,PSNVPN) D DRCL(CLASS) Q
"RTN","GMRAOR",54,0)
 .N CLASS,LIST
"RTN","GMRAOR",55,0)
 .S LIST=$$CLIST^PSNAPIS(PSNDA,.LIST) Q:'$G(LIST)
"RTN","GMRAOR",56,0)
 .S LIST=0 F  S LIST=$O(LIST(LIST)) Q:'LIST  D DRCL($P(LIST(LIST),U,2))
"RTN","GMRAOR",57,0)
 .Q
"RTN","GMRAOR",58,0)
 Q FLG
"RTN","GMRAOR",59,0)
FAC(NODE) ;
"RTN","GMRAOR",60,0)
 N FAC
"RTN","GMRAOR",61,0)
 S FAC=$S($L(NODE):" ("_NODE_")",1:"")
"RTN","GMRAOR",62,0)
 Q FAC
"RTN","GMRAOR",63,0)
DRCL(CODE) ;return any rxn's in GMRADRCL(
"RTN","GMRAOR",64,0)
 I '$D(^TMP("GMRAOC",$J,"APC",CODE)) Q
"RTN","GMRAOR",65,0)
 N J S J=$S('$D(GMRADRCL):1,1:$O(GMRADRCL(999),-1)+1)
"RTN","GMRAOR",66,0)
 ;S GMRADRCL(J)=$$CLASS2^PSNAPIS(CODE)
"RTN","GMRAOR",67,0)
 N CLSFN
"RTN","GMRAOR",68,0)
 S CLSFN=$P(^PS(50.605,+$O(^PS(50.605,"B",CODE,0)),0),U,2)
"RTN","GMRAOR",69,0)
 S GMRADRCL(J)=CODE_"^"_CLSFN_$$FAC(^TMP("GMRAOC",$J,"APC",CODE))
"RTN","GMRAOR",70,0)
 S FLG=2
"RTN","GMRAOR",71,0)
 Q 
"RTN","GMRAOR",72,0)
ING(DFN,PTR) ; Subroutine checks for Drug Ingredients, returns:
"RTN","GMRAOR",73,0)
 ;                  If found FLG= 1 with GMRAIEN Array Drug Ingredients
"RTN","GMRAOR",74,0)
 ;                 Not found FLG= 0
"RTN","GMRAOR",75,0)
 N GMRAX K GMRAIEN
"RTN","GMRAOR",76,0)
 S FLG=0
"RTN","GMRAOR",77,0)
 S GMRAX=0
"RTN","GMRAOR",78,0)
 F  S GMRAX=$O(^GMR(120.8,"API",DFN,PTR,GMRAX)) Q:GMRAX<1  S FLG=1,GMRAIEN(GMRAX)=""
"RTN","GMRAOR",79,0)
 Q FLG
"RTN","GMRAOR",80,0)
CLASS(DFN,PTR) ; Subroutine checks for Drug Class, returns:
"RTN","GMRAOR",81,0)
 ;                  If found FLG= 1 with GMRAIEN Array Drug Class
"RTN","GMRAOR",82,0)
 ;                 Not found FLG= 0
"RTN","GMRAOR",83,0)
 N GMRAC,GMRAX K GMRAIEN
"RTN","GMRAOR",84,0)
 S GMRAX=0,FLG=0,GMRAC=$P($G(^PS(50.605,PTR,0)),U)
"RTN","GMRAOR",85,0)
 I GMRAC'="" F  S GMRAX=$O(^GMR(120.8,"APC",DFN,GMRAC,GMRAX)) Q:GMRAX<1  S FLG=1,GMRAIEN(GMRAX)=""
"RTN","GMRAOR",86,0)
 Q FLG
"RTN","GMRAOR",87,0)
NDFREF() ;get version dependent NDF reference
"RTN","GMRAOR",88,0)
 I $$VERSION^XPDUTL("PSN")<4 Q "^PSNDF("
"RTN","GMRAOR",89,0)
 Q "^PSNDF(50.6," ; new reference for ver 4.0
"RTN","GMRAOR",90,0)
 ;
"RTN","GMRAOR",91,0)
GETDATA(DFN) ;Obtain local and HDR related allergy data for use in order checking.  Section added in patch 26
"RTN","GMRAOR",92,0)
 ;Output from call will be stored in ^TMP as follows:
"RTN","GMRAOR",93,0)
 ;^TMP("GMRAOC",$J,"API",J)="" where J is the ingredient IEN
"RTN","GMRAOR",94,0)
 ;^TMP("GMRAOC",$J,"APC",K)="" where K is the drug class classification (e.g. MS105)
"RTN","GMRAOR",95,0)
 ;
"RTN","GMRAOR",96,0)
 L +^XTMP("GMRAOC",DFN)
"RTN","GMRAOR",97,0)
 S ^XTMP("GMRAOC",0)=$$FMADD^XLFDT($$NOW^XLFDT,2)_U_$$NOW^XLFDT
"RTN","GMRAOR",98,0)
 N GMRRECDT,GMRCACHE,GMRFRESH,GMRNEW,GMRXTMP
"RTN","GMRAOR",99,0)
 S (GMRFRESH,GMRNEW,GMRXTMP)=0
"RTN","GMRAOR",100,0)
 S GMRRECDT=$P($G(^XTMP("ORRDI","ART",DFN,0)),U)
"RTN","GMRAOR",101,0)
 S GMRCACHE=$$GET^XPAR("SYS","OR RDI CACHE TIME")
"RTN","GMRAOR",102,0)
 I $$FMDIFF^XLFDT($$NOW^XLFDT,GMRRECDT,2)<(60*GMRCACHE),$P(^XTMP("ORRDI","ART",DFN,0),U,3)>-1 S GMRFRESH=1
"RTN","GMRAOR",103,0)
 S GMRXTMP=$D(^XTMP("GMRAOC",DFN))
"RTN","GMRAOR",104,0)
 S GMRNEW=$S($D(^XTMP("GMRAOC",DFN,"ERROR")):2,$D(^XTMP("GMRAOC",DFN,"NEW")):1,1:0)
"RTN","GMRAOR",105,0)
 I GMRFRESH&GMRXTMP&(GMRNEW=1) K ^XTMP("GMRAOC",DFN,"NEW") D LOCAL(DFN)
"RTN","GMRAOR",106,0)
 I 'GMRFRESH!'GMRXTMP!(GMRNEW=2) K ^XTMP("GMRAOC",DFN) D REMOTE(DFN),LOCAL(DFN)
"RTN","GMRAOR",107,0)
 I GMRRECDT'=$G(^XTMP("GMRAOC",DFN,0)) K ^XTMP("GMRAOC",DFN) D REMOTE(DFN),LOCAL(DFN)
"RTN","GMRAOR",108,0)
 K ^TMP("GMRAOC",$J)
"RTN","GMRAOR",109,0)
 M ^TMP("GMRAOC",$J)=^XTMP("GMRAOC",DFN)
"RTN","GMRAOR",110,0)
 L -^XTMP("GMRAOC",DFN)
"RTN","GMRAOR",111,0)
 Q
"RTN","GMRAOR",112,0)
 ;
"RTN","GMRAOR",113,0)
SETNODE(ITEM,DATA) ;
"RTN","GMRAOR",114,0)
 N VALUE
"RTN","GMRAOR",115,0)
 S VALUE=""
"RTN","GMRAOR",116,0)
 I ITEM[DATA S VALUE=ITEM Q VALUE
"RTN","GMRAOR",117,0)
 I DATA="LOCAL" D  Q VALUE
"RTN","GMRAOR",118,0)
 .I ITEM="" S VALUE="LOCAL" Q
"RTN","GMRAOR",119,0)
 .I ITEM["REMOTE SITE(S)" S VALUE="LOCAL AND REMOTE SITE(S)"
"RTN","GMRAOR",120,0)
 I DATA="REMOTE SITE(S)" D  Q VALUE
"RTN","GMRAOR",121,0)
 .I ITEM="" S VALUE="REMOTE SITE(S)" Q
"RTN","GMRAOR",122,0)
 .I ITEM["LOCAL" S VALUE="LOCAL AND REMOTE SITE(S)"
"RTN","GMRAOR",123,0)
 Q VALUE
"RTN","GMRAOR",124,0)
 ;
"RTN","GMRAOR",125,0)
LOCAL(DFN) ;
"RTN","GMRAOR",126,0)
 N J
"RTN","GMRAOR",127,0)
 S J=0 F  S J=$O(^GMR(120.8,"API",DFN,J)) Q:'+J  S ^XTMP("GMRAOC",DFN,"API",J)=$$SETNODE($G(^XTMP("GMRAOC",DFN,"API",J)),"LOCAL")
"RTN","GMRAOR",128,0)
 S J="" F  S J=$O(^GMR(120.8,"APC",DFN,J)) Q:J=""  S ^XTMP("GMRAOC",DFN,"APC",J)=$$SETNODE($G(^XTMP("GMRAOC",DFN,"APC",J)),"LOCAL")
"RTN","GMRAOR",129,0)
 Q
"RTN","GMRAOR",130,0)
 ;
"RTN","GMRAOR",131,0)
REMOTE(DFN) ;
"RTN","GMRAOR",132,0)
 I $G(TYP)'="DR" Q  ;only get remote data for order checking on drug orders
"RTN","GMRAOR",133,0)
 N J,FLG,REACT,IN,VUID,FILE,GMRARAY,DC,DCLASS,GMRAING,GMRADC,K,INGLST,I,PRIM,IEN
"RTN","GMRAOR",134,0)
 ;Check for HDR data
"RTN","GMRAOR",135,0)
 Q:'$L($T(HAVEHDR^ORRDI1))  Q:'$$HAVEHDR^ORRDI1  ;Quit if call doesn't exist or if the HDR isn't available
"RTN","GMRAOR",136,0)
 Q:'$$GET^ORRDI1(DFN,"ART")  ;Quit if no HDR data for selected patient
"RTN","GMRAOR",137,0)
 S ^XTMP("GMRAOC",DFN,0)=$P($G(^XTMP("ORRDI","ART",DFN,0)),U)
"RTN","GMRAOR",138,0)
 S J=0 F  S J=$O(^XTMP("ORRDI","ART",DFN,J)) Q:'+J  D
"RTN","GMRAOR",139,0)
 .S FLG=0
"RTN","GMRAOR",140,0)
 .S REACT=$G(^XTMP("ORRDI","ART",DFN,J,"REACTANT",0)) ;Reaction VUID
"RTN","GMRAOR",141,0)
 .I $D(^XTMP("ORRDI","ART",DFN,J,"DRUG INGREDIENTS")) D  ;Ingredient data exists
"RTN","GMRAOR",142,0)
 ..S FLG=1 ;Have ingredient data so REACT is ok
"RTN","GMRAOR",143,0)
 ..S IN=0 F  S IN=$O(^XTMP("ORRDI","ART",DFN,J,"DRUG INGREDIENTS",IN)) Q:'+IN  D
"RTN","GMRAOR",144,0)
 ...S VUID=$P(^(IN),U),FILE=$P(^(IN),U,3) ;Naked from above line
"RTN","GMRAOR",145,0)
 ...S FILE=$P(FILE,"99VA",2)
"RTN","GMRAOR",146,0)
 ...D GETIREF^XTID(FILE,,VUID,"GMRARAY") ;Get IENs related to VUID
"RTN","GMRAOR",147,0)
 ...S IEN=0 F  S IEN=$O(GMRARAY(FILE,.01,IEN)) Q:'+IEN  S ^XTMP("GMRAOC",DFN,"API",+IEN)=$$SETNODE($G(^XTMP("GMRAOC",DFN,"API",+IEN)),"REMOTE SITE(S)")
"RTN","GMRAOR",148,0)
 ...K GMRARAY
"RTN","GMRAOR",149,0)
 .I $D(^XTMP("ORRDI","ART",DFN,J,"DRUG CLASSES")) D  ;Drug class data exists
"RTN","GMRAOR",150,0)
 ..S FLG=1
"RTN","GMRAOR",151,0)
 ..S DC=0 F  S DC=$O(^XTMP("ORRDI","ART",DFN,J,"DRUG CLASSES",DC)) Q:'+DC  D
"RTN","GMRAOR",152,0)
 ...S DCLASS=$P(^(DC),U,2) ;Naked from above, gets drug class (e.g.MS105)
"RTN","GMRAOR",153,0)
 ...S ^XTMP("GMRAOC",DFN,"APC",DCLASS)=$$SETNODE($G(^XTMP("GMRAOC",DFN,"APC",DCLASS)),"REMOTE SITE(S)")
"RTN","GMRAOR",154,0)
 .D FIND(REACT,.GMRAING,.GMRADC) I $D(GMRAING)!($D(GMRADC)) D
"RTN","GMRAOR",155,0)
 ..S K=0 F  S K=$O(GMRAING(K)) Q:'+K  S ^XTMP("GMRAOC",DFN,"API",K)=$$SETNODE($G(^XTMP("GMRAOC",DFN,"API",K)),"REMOTE SITE(S)")
"RTN","GMRAOR",156,0)
 ..S K="" F  S K=$O(GMRADC(K)) Q:K=""  S ^XTMP("GMRAOC",DFN,"APC",K)=$$SETNODE($G(^XTMP("GMRAOC",DFN,"APC",K)),"REMOTE SITE(S)")
"RTN","GMRAOR",157,0)
 I $D(^XTMP("GMRAOC",DFN,"API")) D
"RTN","GMRAOR",158,0)
 .N I,INGLST
"RTN","GMRAOR",159,0)
 .S I=0 F  S I=$O(^XTMP("GMRAOC",DFN,"API",I)) Q:'I  D
"RTN","GMRAOR",160,0)
 ..N PRIM
"RTN","GMRAOR",161,0)
 ..S PRIM=$$PRIMARY(I)
"RTN","GMRAOR",162,0)
 ..I PRIM S INGLST(PRIM)=^XTMP("GMRAOC",DFN,"API",I) K ^XTMP("GMRAOC",DFN,"API",I)
"RTN","GMRAOR",163,0)
 .S I=0 F  S I=$O(INGLST(I)) Q:'I  S ^XTMP("GMRAOC",DFN,"API",I)=INGLST(I)
"RTN","GMRAOR",164,0)
 Q
"RTN","GMRAOR",165,0)
 ;
"RTN","GMRAOR",166,0)
FIND(REACT,ING,DC) ;If reactant didn't include drug classes and/or ingredients, try and find them locally.  Section added in patch 26
"RTN","GMRAOR",167,0)
 N VUID,FILE,PSNDA,GMRAIEN,LIST,GMRAI,GMRALIST,GMRARAY,J,SUB,FLAG
"RTN","GMRAOR",168,0)
 S FLAG=0
"RTN","GMRAOR",169,0)
 S VUID=$P(REACT,U)
"RTN","GMRAOR",170,0)
 S FILE=$P(REACT,U,3)
"RTN","GMRAOR",171,0)
 S FILE=$P(FILE,"99VA",2)
"RTN","GMRAOR",172,0)
 D GETIREF^XTID(,,VUID,"GMRARAY")
"RTN","GMRAOR",173,0)
 S FILE="" F  S FILE=$O(GMRARAY(FILE)) Q:FILE=""  D
"RTN","GMRAOR",174,0)
 .S GMRAIEN=0 F  S GMRAIEN=$O(GMRARAY(FILE,.01,GMRAIEN)) Q:'+GMRAIEN  D
"RTN","GMRAOR",175,0)
 ..I FILE=50.6 D
"RTN","GMRAOR",176,0)
 ...K ^TMP("PSN",$J) S PSNDA=+GMRAIEN D ^PSNNGR
"RTN","GMRAOR",177,0)
 ...S GMRAI=0 F  S GMRAI=$O(^TMP("PSN",$J,GMRAI)) Q:GMRAI<1  S ING(GMRAI)=""
"RTN","GMRAOR",178,0)
 ...K ^TMP("PSN",$J),GMRARAY
"RTN","GMRAOR",179,0)
 ...S PSNDA=+GMRAIEN,GMRALIST=$$CLIST^PSNAPIS(PSNDA,.GMRALIST) Q:'$G(GMRALIST)
"RTN","GMRAOR",180,0)
 ...S GMRALIST=0 F  S GMRALIST=$O(GMRALIST(GMRALIST)) Q:'GMRALIST  S DC($P(GMRALIST(GMRALIST),U,2))=""
"RTN","GMRAOR",181,0)
 ..I FILE=120.82 D
"RTN","GMRAOR",182,0)
 ...S SUB=0 F  S SUB=$O(^GMRD(120.82,+GMRAIEN,"ING",SUB)) Q:'+SUB  S ING(+$P($G(^GMRD(120.82,+GMRAIEN,"ING",SUB,0)),U))="" ;record ingredients
"RTN","GMRAOR",183,0)
 ...S SUB=0 F  S SUB=$O(^GMRD(120.82,+GMRAIEN,"CLASS",SUB)) Q:'+SUB  S DC($P($$CLASS2^PSNAPIS(+$P($G(^GMRD(120.82,+GMRAIEN,"CLASS",SUB,0)),U)),U))="" ;Get drug classes
"RTN","GMRAOR",184,0)
 ..I FILE=50.605 D
"RTN","GMRAOR",185,0)
 ...S DC($P($$CLASS2^PSNAPIS(+GMRAIEN),U))=""
"RTN","GMRAOR",186,0)
 ..I FILE=50.416 D
"RTN","GMRAOR",187,0)
 ...S ING(+GMRAIEN)=""
"RTN","GMRAOR",188,0)
 Q
"RTN","GMRAOR",189,0)
PRIMARY(INGIEN) ;check if INGIEN is a primary ingredient
"RTN","GMRAOR",190,0)
 ;returns 0 if INGIEN is primary
"RTN","GMRAOR",191,0)
 ;returns the IEN of INGIEN's primary ingredient if INGIEN is not primary
"RTN","GMRAOR",192,0)
 N RETURN
"RTN","GMRAOR",193,0)
 K ^TMP($J,"GMRALIST")
"RTN","GMRAOR",194,0)
 D ZERO^PSN50P41(INGIEN,,,"GMRALIST")
"RTN","GMRAOR",195,0)
 S RETURN=+$G(^TMP($J,"GMRALIST",INGIEN,2))
"RTN","GMRAOR",196,0)
 Q RETURN
"VER")
8.0^22.0
"BLD",5737,6)
^33
**END**
**END**
