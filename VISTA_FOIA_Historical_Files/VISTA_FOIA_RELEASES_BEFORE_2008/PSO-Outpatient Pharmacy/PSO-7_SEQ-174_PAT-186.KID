Released PSO*7*186 SEQ #174
Extracted from mail message
**KIDS**:PSO*7.0*186^

**INSTALL NAME**
PSO*7.0*186
"BLD",1065,0)
PSO*7.0*186^OUTPATIENT PHARMACY^0^3050124^y
"BLD",1065,1,0)
^^6^6^3041122^
"BLD",1065,1,1,0)
 This patch will correct two DEA (Drug Enforcement Agency) Special
"BLD",1065,1,2,0)
 Handling issues, one while completing the prescription via the PSO LM
"BLD",1065,1,3,0)
 BACKDOOR ORDERS option, and one while refilling a prescription via the
"BLD",1065,1,4,0)
 Barcode Batch Prescription Entry option on the PSO BARCODE MENU.  This
"BLD",1065,1,5,0)
 patch will also correct a null subscript error while verifying a
"BLD",1065,1,6,0)
 prescription via the PSO LM BACKDOOR ORDERS option.
"BLD",1065,4,0)
^9.64PA^^0
"BLD",1065,"ABPKG")
n
"BLD",1065,"KRN",0)
^9.67PA^8989.52^19
"BLD",1065,"KRN",.4,0)
.4
"BLD",1065,"KRN",.401,0)
.401
"BLD",1065,"KRN",.402,0)
.402
"BLD",1065,"KRN",.403,0)
.403
"BLD",1065,"KRN",.5,0)
.5
"BLD",1065,"KRN",.84,0)
.84
"BLD",1065,"KRN",3.6,0)
3.6
"BLD",1065,"KRN",3.8,0)
3.8
"BLD",1065,"KRN",9.2,0)
9.2
"BLD",1065,"KRN",9.8,0)
9.8
"BLD",1065,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",1065,"KRN",9.8,"NM",1,0)
PSOORDA^^0^B56022696
"BLD",1065,"KRN",9.8,"NM",2,0)
PSOREF0^^0^B35694868
"BLD",1065,"KRN",9.8,"NM",3,0)
PSOORFI1^^0^B71409262
"BLD",1065,"KRN",9.8,"NM",4,0)
PSOUTLA1^^0^B44704112
"BLD",1065,"KRN",9.8,"NM","B","PSOORDA",1)

"BLD",1065,"KRN",9.8,"NM","B","PSOORFI1",3)

"BLD",1065,"KRN",9.8,"NM","B","PSOREF0",2)

"BLD",1065,"KRN",9.8,"NM","B","PSOUTLA1",4)

"BLD",1065,"KRN",19,0)
19
"BLD",1065,"KRN",19.1,0)
19.1
"BLD",1065,"KRN",101,0)
101
"BLD",1065,"KRN",409.61,0)
409.61
"BLD",1065,"KRN",771,0)
771
"BLD",1065,"KRN",870,0)
870
"BLD",1065,"KRN",8989.51,0)
8989.51
"BLD",1065,"KRN",8989.52,0)
8989.52
"BLD",1065,"KRN",8994,0)
8994
"BLD",1065,"KRN","B",.4,.4)

"BLD",1065,"KRN","B",.401,.401)

"BLD",1065,"KRN","B",.402,.402)

"BLD",1065,"KRN","B",.403,.403)

"BLD",1065,"KRN","B",.5,.5)

"BLD",1065,"KRN","B",.84,.84)

"BLD",1065,"KRN","B",3.6,3.6)

"BLD",1065,"KRN","B",3.8,3.8)

"BLD",1065,"KRN","B",9.2,9.2)

"BLD",1065,"KRN","B",9.8,9.8)

"BLD",1065,"KRN","B",19,19)

"BLD",1065,"KRN","B",19.1,19.1)

"BLD",1065,"KRN","B",101,101)

"BLD",1065,"KRN","B",409.61,409.61)

"BLD",1065,"KRN","B",771,771)

"BLD",1065,"KRN","B",870,870)

"BLD",1065,"KRN","B",8989.51,8989.51)

"BLD",1065,"KRN","B",8989.52,8989.52)

"BLD",1065,"KRN","B",8994,8994)

"BLD",1065,"QUES",0)
^9.62^^
"BLD",1065,"REQB",0)
^9.611^4^3
"BLD",1065,"REQB",1,0)
PSO*7.0*152^2
"BLD",1065,"REQB",2,0)
PSO*7.0*180^2
"BLD",1065,"REQB",4,0)
PSO*7.0*35^2
"BLD",1065,"REQB","B","PSO*7.0*152",1)

"BLD",1065,"REQB","B","PSO*7.0*180",2)

"BLD",1065,"REQB","B","PSO*7.0*35",4)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
7.0^3011218^2980805^5
"PKG",16,22,1,"PAH",1,0)
186^3050124
"PKG",16,22,1,"PAH",1,1,0)
^^6^6^3050124
"PKG",16,22,1,"PAH",1,1,1,0)
 This patch will correct two DEA (Drug Enforcement Agency) Special
"PKG",16,22,1,"PAH",1,1,2,0)
 Handling issues, one while completing the prescription via the PSO LM
"PKG",16,22,1,"PAH",1,1,3,0)
 BACKDOOR ORDERS option, and one while refilling a prescription via the
"PKG",16,22,1,"PAH",1,1,4,0)
 Barcode Batch Prescription Entry option on the PSO BARCODE MENU.  This
"PKG",16,22,1,"PAH",1,1,5,0)
 patch will also correct a null subscript error while verifying a
"PKG",16,22,1,"PAH",1,1,6,0)
 prescription via the PSO LM BACKDOOR ORDERS option.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSOORDA")
0^1^B56022696
"RTN","PSOORDA",1,0)
PSOORDA ;ISC-BHAM/LC - build detailed allergy list ;12/10/04 8:29am
"RTN","PSOORDA",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**44,139,152,186**;DEC 1997
"RTN","PSOORDA",3,0)
 ;External reference to EN1^GMRADPT supported by DBIA 10099
"RTN","PSOORDA",4,0)
 ;External reference to EN1^GMRAOR2 supported by DBIA 2422
"RTN","PSOORDA",5,0)
 ;
"RTN","PSOORDA",6,0)
 ;Inpatient Pharmacy's DBIA 2211 allows reference to ^TMP("PSJAL" and ^TMP("PSJDA"
"RTN","PSOORDA",7,0)
 ;
"RTN","PSOORDA",8,0)
 ;PSO*7*186 Newing of variables to protect their global values
"RTN","PSOORDA",9,0)
 ;
"RTN","PSOORDA",10,0)
BEG(DFN) N VALMCNT,DR,IEN S GMRA="0^0^111",IEN=0 D EN1^GMRADPT
"RTN","PSOORDA",11,0)
 NEW PSONSP S PSONSP=$S($G(PSJINPT):"PSJDA",1:"PSODA")
"RTN","PSOORDA",12,0)
 K ^TMP(PSONSP,$J) I 'GMRAL S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)=$S($G(GMRAL)=0:"No Known Allergies",'GMRAL:"Patient has not been asked about allergies",1:"")
"RTN","PSOORDA",13,0)
 S (OT,FD,DG,LTO,VY,NVY,VDG,VDGF,VDGFO,VDGO,VFD,VFDO,VOT,NDG,NDGF,NDGFO,NDGO,NFD,NFDO,NOT)=0,(NU,TY)="" D:$G(GMRAL)
"RTN","PSOORDA",14,0)
 .F DR=0:0 S DR=$O(GMRAL(DR)) Q:'DR  S AG($S($P(GMRAL(DR),"^",4):1,1:2),$P(GMRAL(DR),"^",7),$P(GMRAL(DR),"^",2))=DR_"^"_$P(GMRAL(DR),"^",2)_"^"_+$P(GMRAL(DR),"^",4)_"^"_+$P(GMRAL(DR),"^",8)
"RTN","PSOORDA",15,0)
 .F  S NU=$O(AG(NU)) Q:'NU  S:NU=1 VY=1 S:NU=2 NVY=1 F  S TY=$O(AG(NU,TY)) Q:TY=""  D
"RTN","PSOORDA",16,0)
 ..S:VY&(TY="D") VDG=1 S:VY&(TY="DF") VDGF=1 S:VY&(TY="DFO") VDGFO=1 S:VY&(TY="DO") VDGO=1 S:VY&(TY="F") VFD=1 S:VY&(TY="FO") VFDO=1 S:VY&(TY="O") VOT=1
"RTN","PSOORDA",17,0)
 ..S:NVY&(TY="D") NDG=1 S:NVY&(TY="DF") NDGF=1 S:NVY&(TY="DFO") NDGFO=1 S:NVY&(TY="DO") NDGO=1 S:NVY&(TY="F") NFD=1 S:NVY&(TY="FO") NFDO=1 S:NVY&(TY="O") NOT=1
"RTN","PSOORDA",18,0)
 .S:VY IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="    Verified"
"RTN","PSOORDA",19,0)
 .S:VDG IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Drug: "
"RTN","PSOORDA",20,0)
 .S AL="" F  S AL=$O(AG(1,"D",AL)) Q:AL=""  D
"RTN","PSOORDA",21,0)
 ..S DG=DG+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_DG_" "_AL,AGN(DG)=$P(AG(1,"D",AL),"^")
"RTN","PSOORDA",22,0)
 .S:VDGF IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Drug/Food: "
"RTN","PSOORDA",23,0)
 .S AL="" F  S AL=$O(AG(1,"DF",AL)) Q:AL=""  D
"RTN","PSOORDA",24,0)
 ..S DG=DG+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_DG_" "_AL,AGN(DG)=$P(AG(1,"DF",AL),"^")
"RTN","PSOORDA",25,0)
 .S:VDGFO IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Drug/Food/Other: "
"RTN","PSOORDA",26,0)
 .S AL="" F  S AL=$O(AG(1,"DFO",AL)) Q:AL=""  D
"RTN","PSOORDA",27,0)
 ..S DG=DG+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_DG_" "_AL,AGN(DG)=$P(AG(1,"DFO",AL),"^")
"RTN","PSOORDA",28,0)
 .S:VDGO IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Drug/Other: "
"RTN","PSOORDA",29,0)
 .S AL="" F  S AL=$O(AG(1,"DO",AL)) Q:AL=""  D
"RTN","PSOORDA",30,0)
 ..S DG=DG+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_DG_" "_AL,AGN(DG)=$P(AG(1,"DO",AL),"^")
"RTN","PSOORDA",31,0)
 .S:VFD IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Food: "
"RTN","PSOORDA",32,0)
 .S AL="" F  S AL=$O(AG(1,"F",AL)) Q:AL=""  D
"RTN","PSOORDA",33,0)
 ..S FD=FD+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_(FD+DG)_" "_AL,AGN(FD+DG)=$P(AG(1,"F",AL),"^")
"RTN","PSOORDA",34,0)
 .S:VFDO IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Food/Other: "
"RTN","PSOORDA",35,0)
 .S AL="" F  S AL=$O(AG(1,"FO",AL)) Q:AL=""  D
"RTN","PSOORDA",36,0)
 ..S FD=FD+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_(FD+DG)_" "_AL,AGN(FD+DG)=$P(AG(1,"FO",AL),"^")
"RTN","PSOORDA",37,0)
 .S:VOT IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="    Other: "
"RTN","PSOORDA",38,0)
 .S AL="" F  S AL=$O(AG(1,"O",AL)) Q:AL=""  D
"RTN","PSOORDA",39,0)
 ..S OT=OT+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_(OT+FD+DG)_" "_AL,AGN(OT+FD+DG)=$P(AG(1,"O",AL),"^")
"RTN","PSOORDA",40,0)
 .S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="        ",LTO=(OT+FD+DG),(OT,FD,DG)=0
"RTN","PSOORDA",41,0)
 .S:NVY IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="Non-Verified"
"RTN","PSOORDA",42,0)
 .S:NDG IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Drug: "
"RTN","PSOORDA",43,0)
 .S AL="" F  S AL=$O(AG(2,"D",AL)) Q:AL=""  D
"RTN","PSOORDA",44,0)
 ..S DG=DG+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_(DG+LTO)_" "_AL,AGN(DG+LTO)=$P(AG(2,"D",AL),"^")
"RTN","PSOORDA",45,0)
 .S:NDGF IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Drug/Food: "
"RTN","PSOORDA",46,0)
 .S AL="" F  S AL=$O(AG(2,"DF",AL)) Q:AL=""  D
"RTN","PSOORDA",47,0)
 ..S DG=DG+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_(DG+LTO)_" "_AL,AGN(DG+LTO)=$P(AG(2,"DF",AL),"^")
"RTN","PSOORDA",48,0)
 .S:NDGFO IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Drug/Food/Other: "
"RTN","PSOORDA",49,0)
 .S AL="" F  S AL=$O(AG(2,"DFO",AL)) Q:AL=""  D
"RTN","PSOORDA",50,0)
 ..S DG=DG+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_(DG+LTO)_" "_AL,AGN(DG+LTO)=$P(AG(2,"DFO",AL),"^")
"RTN","PSOORDA",51,0)
 .S:NDGO IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Drug/Other: "
"RTN","PSOORDA",52,0)
 .S AL="" F  S AL=$O(AG(2,"DO",AL)) Q:AL=""  D
"RTN","PSOORDA",53,0)
 ..S DG=DG+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_(DG+LTO)_" "_AL,AGN(DG+LTO)=$P(AG(2,"DO",AL),"^")
"RTN","PSOORDA",54,0)
 .S:NFD IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Food: "
"RTN","PSOORDA",55,0)
 .S AL="" F  S AL=$O(AG(2,"F",AL)) Q:AL=""  D
"RTN","PSOORDA",56,0)
 ..S FD=FD+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_(FD+DG+LTO)_" "_AL,AGN(FD+DG+LTO)=$P(AG(2,"F",AL),"^")
"RTN","PSOORDA",57,0)
 .S:NFDO IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="     Food/Other: "
"RTN","PSOORDA",58,0)
 .S AL="" F  S AL=$O(AG(2,"FO",AL)) Q:AL=""  D
"RTN","PSOORDA",59,0)
 ..S FD=FD+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_(FD+DG+LTO)_" "_AL,AGN(FD+DG+LTO)=$P(AG(2,"FO",AL),"^")
"RTN","PSOORDA",60,0)
 .S:NOT IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="    Other: "
"RTN","PSOORDA",61,0)
 .S AL="" F  S AL=$O(AG(2,"O",AL)) Q:AL=""  D
"RTN","PSOORDA",62,0)
 ..S OT=OT+1,IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       "_(OT+FD+DG+LTO)_" "_AL,AGN(OT+FD+DG+LTO)=$P(AG(2,"O",AL),"^")
"RTN","PSOORDA",63,0)
 S PSODA=IEN,PSOALL=(OT+FD+DG+LTO)
"RTN","PSOORDA",64,0)
 S:$D(PSJINPT) PSJDA=IEN,PSJALL=(OT+FD+DG+LTO)
"RTN","PSOORDA",65,0)
 K AL,AG,DG,FD,GMRA,GMRAL,LTO,NU,OT,TY,VY,VDG,VDGF,VDGFO,VDGO,VFD,VFDO,VOT,NDG,NDGF,NDGFO,NDGO,NFD,NFDO,NOT,NVY
"RTN","PSOORDA",66,0)
 Q
"RTN","PSOORDA",67,0)
SEL ;select allergy for detail display
"RTN","PSOORDA",68,0)
 N ORD,ORN,IEN,VALMCNT I '$G(PSOALL) S VALMSG="This patient has no Allergies!" S VALMBCK="" Q
"RTN","PSOORDA",69,0)
 K DIR,DUOUT,DIRUT S DIR("A")="Select Allergies by number",DIR(0)="LO^1:"_PSOALL D ^DIR I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" Q
"RTN","PSOORDA",70,0)
SELAL N ORD,ORN,IEN,VALMCNT                                      ;PSO*7*186
"RTN","PSOORDA",71,0)
 K DIR,DIRUT,DTOUT,DTOUT S PSOELSE=+Y I +Y S ALST=Y D FULL^VALM1 D
"RTN","PSOORDA",72,0)
 .F ORD=1:1:$L(ALST,",") Q:$P(ALST,",",ORD)']""  S ORN=+$P(ALST,",",ORD) D DSPLY(DFN)
"RTN","PSOORDA",73,0)
 ;S PSONSP=$S($G(PSJINPT):"PSJAL",1:"PSODA")
"RTN","PSOORDA",74,0)
 I 'PSOELSE S VALMBCK=""
"RTN","PSOORDA",75,0)
 K ALST,PSOELSE
"RTN","PSOORDA",76,0)
 Q
"RTN","PSOORDA",77,0)
DSPLY(DFN) ;build detailed allergy display
"RTN","PSOORDA",78,0)
 NEW PSONSP S PSONSP=$S($G(PSJINPT):"PSJAL",1:"PSOAL")
"RTN","PSOORDA",79,0)
 K ^TMP(PSONSP,$J),AGNL S IEN=0,NB=$G(AGN(ORN)) D EN1^GMRAOR2(NB,"AGNL")
"RTN","PSOORDA",80,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="  Causative Agent: "_$P(AGNL,"^")
"RTN","PSOORDA",81,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="                                  "
"RTN","PSOORDA",82,0)
 S ^TMP(PSONSP,$J,IEN,0)=^TMP(PSONSP,$J,IEN,0)_"                  Severity: "
"RTN","PSOORDA",83,0)
 S I="" F  S I=$O(AGNL("O",I)) Q:I=""  D
"RTN","PSOORDA",84,0)
 . I $P(AGNL("O",I),"^",2)="" Q
"RTN","PSOORDA",85,0)
 . S X=$$DT(+AGNL("O",I))_" "_$P(AGNL("O",I),"^",2)
"RTN","PSOORDA",86,0)
 . I I=$O(AGNL("O","")) S ^TMP(PSONSP,$J,IEN,0)=^TMP(PSONSP,$J,IEN,0)_X Q
"RTN","PSOORDA",87,0)
 . S IEN=IEN+1,$E(^TMP(PSONSP,$J,IEN,0),63)=X
"RTN","PSOORDA",88,0)
 ;get ingredients
"RTN","PSOORDA",89,0)
 S (ING,ING1)="" I $D(AGNL("I")) F IT=0:1 S IN=$O(AGNL("I",IT)) Q:'IN  D
"RTN","PSOORDA",90,0)
 .S:$L(ING_";"_$P($G(AGNL("I",IN)),"^"))>230 ING1=ING1_";"_$P($G(AGNL("I",IN)),"^")
"RTN","PSOORDA",91,0)
 .S:$L(ING_";"_$P($G(AGNL("I",IN)),"^"))<230 ING=ING_";"_$P($G(AGNL("I",IN)),"^")
"RTN","PSOORDA",92,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="      Ingredients: ",ING=$E(ING,2,99999),ING1=$E(ING1,2,99999)
"RTN","PSOORDA",93,0)
ING F IG=1:1:$L(ING) Q:$P(ING,";",IG)=""  S LCC=IG,LC=0
"RTN","PSOORDA",94,0)
 F IG=1:1:$L(ING) Q:$P(ING,";",IG)=""  D
"RTN","PSOORDA",95,0)
 .S:$L(^TMP(PSONSP,$J,IEN,0)_$P(ING,";",IG))>50 LC=LC+1,IEN=IEN+1,$P(^TMP(PSONSP,$J,IEN,0)," ",19)=" "
"RTN","PSOORDA",96,0)
 .S ^TMP(PSONSP,$J,IEN,0)=$G(^TMP(PSONSP,$J,IEN,0))_$P(ING,";",IG)_$S($G(LC)=0&($G(IG)=LCC):"",$G(IG)<LCC:", ",$G(LC)>0&($G(IG)=LCC):"",$G(LC)>0&($G(IG)<LCC):", ",1:"")
"RTN","PSOORDA",97,0)
 I '$D(ING2)&($G(ING1)]"") S ING2=1,ING=ING1 G ING
"RTN","PSOORDA",98,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="" S ODT=$S($D(AGNL("C",1)):$P(AGNL("C",1),"^"),1:"*******.******"),OD=$P(ODT,".")
"RTN","PSOORDA",99,0)
 ;
"RTN","PSOORDA",100,0)
 ;get drug class
"RTN","PSOORDA",101,0)
 S CLS="" I $D(AGNL("V")) F CT=0:1 S CPT=$O(AGNL("V",CT)) Q:'CPT  S CLS=CLS_","_$P($G(AGNL("V",CPT)),"^",2)
"RTN","PSOORDA",102,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="    VA Drug Class: ",CLS=$E(CLS,2,99999)
"RTN","PSOORDA",103,0)
 F CG=1:1:$L(CLS) Q:$P(CLS,",",CG)=""  S LCC=CG,LC=0
"RTN","PSOORDA",104,0)
 F CG=1:1:$L(CLS) Q:$P(CLS,",",CG)=""  D
"RTN","PSOORDA",105,0)
 .S:$L(^TMP(PSONSP,$J,IEN,0)_$P(CLS,",",CG))>50 IEN=IEN+1,$P(^TMP(PSONSP,$J,IEN,0)," ",19)=" "
"RTN","PSOORDA",106,0)
 .S ^TMP(PSONSP,$J,IEN,0)=$G(^TMP(PSONSP,$J,IEN,0))_$P(CLS,",",CG)_$S($G(LC)=0&($G(CG)=LCC):"",$G(CG)<LCC:", ",$G(LC)>0&($G(CG)=LCC):"",$G(LC)>0&($G(CG)<LCC):", ",1:"")
"RTN","PSOORDA",107,0)
 ;
"RTN","PSOORDA",108,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="       Originated: "_$E(OD,4,5)_"/"_$E(OD,6,7)_"/"_$E(OD,2,3)
"RTN","PSOORDA",109,0)
 S ^TMP(PSONSP,$J,IEN,0)=^TMP(PSONSP,$J,IEN,0)_"                       Originator: "_$P(AGNL,"^",2)
"RTN","PSOORDA",110,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="         Verified: "_$S($P(AGNL,"^",4)="VERIFIED":"Yes",$P(AGNL,"^",4)="NOT VERIFIED":"No ",1:"   ")
"RTN","PSOORDA",111,0)
 S ^TMP(PSONSP,$J,IEN,0)=^TMP(PSONSP,$J,IEN,0)_"                              OBS/Hist: "_$P(AGNL,"^",5)
"RTN","PSOORDA",112,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)=""
"RTN","PSOORDA",113,0)
 ;get originator comments
"RTN","PSOORDA",114,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="         Comments: "  ;,ORC=$E(ORC,2,99999)
"RTN","PSOORDA",115,0)
 ;S ORC="" I $D(AGNL("C",1)) F ORT=0:0 S ORT=$O(AGNL("C",1,ORT)) Q:'ORT!(ORT>8)!($L(ORC)+$L($G(AGNL("C",1,ORT,0)))>432)  S ORC=ORC_";"_$G(AGNL("C",1,ORT,0))
"RTN","PSOORDA",116,0)
 ;S ORC=$E(ORC,2,99999) F OG=1:1:$L(ORC) Q:$P(ORC,";",OG)=""  S:$L(^TMP(PSONSP,$J,IEN,0)_$P(ORC,";",OG))>75 IEN=IEN+1,$P(^TMP(PSONSP,$J,IEN,0)," ",1)=" " S ^TMP(PSONSP,$J,IEN,0)=$G(^TMP(PSONSP,$J,IEN,0))_" "_$P(ORC,";",OG)
"RTN","PSOORDA",117,0)
 I $D(AGNL("C",1)) F ORT=0:0 S ORT=$O(AGNL("C",1,ORT)) Q:'ORT  S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)=$G(AGNL("C",1,ORT,0))
"RTN","PSOORDA",118,0)
 ;get signs/symptoms
"RTN","PSOORDA",119,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)=""
"RTN","PSOORDA",120,0)
 S SYM="" I $D(AGNL("S")) F SNM=0:0 S SNM=$O(AGNL("S",SNM)) Q:'SNM  S SYM=SYM_","_$G(AGNL("S",SNM))
"RTN","PSOORDA",121,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="   Signs/Symptoms: ",SYM=$E(SYM,2,99999)
"RTN","PSOORDA",122,0)
 F SG=1:1:$L(SYM) Q:$P(SYM,",",SG)=""  S LCC=SG,LC=0
"RTN","PSOORDA",123,0)
 F SG=1:1:$L(SYM) Q:$P(SYM,",",SG)=""  D
"RTN","PSOORDA",124,0)
 .S:$L(^TMP(PSONSP,$J,IEN,0)_$P(SYM,",",SG))>50 IEN=IEN+1,$P(^TMP(PSONSP,$J,IEN,0)," ",19)=" "
"RTN","PSOORDA",125,0)
 .S ^TMP(PSONSP,$J,IEN,0)=$G(^TMP(PSONSP,$J,IEN,0))_$P(SYM,",",SG)_$S($G(LC)=0&($G(SG)=LCC):"",$G(SG)<LCC:", ",$G(LC)>0&($G(SG)=LCC):"",$G(LC)>0&($G(SG)<LCC):", ",1:"")
"RTN","PSOORDA",126,0)
 S IEN=IEN+1,^TMP(PSONSP,$J,IEN,0)="        Mechanism: "_$P(AGNL,"^",6)
"RTN","PSOORDA",127,0)
 ;
"RTN","PSOORDA",128,0)
 I $D(PSJINPT) S PSJAL=IEN D EXT Q
"RTN","PSOORDA",129,0)
 S PSOAL=IEN D EN^PSOLMAL
"RTN","PSOORDA",130,0)
EXT K AGNL,CG,CLS,CPT,CT,IG,IN,ING,ING1,ING2,IPT,IT,LC,LCC,NB,NUM,OD,ODT,OG,ORC,ORT,SG,SNM,SYM,Y
"RTN","PSOORDA",131,0)
 Q
"RTN","PSOORDA",132,0)
DT(DT) ; - Convert FM Date to MM/DD/YYYY
"RTN","PSOORDA",133,0)
 Q $E(DT,4,5)_"/"_$E(DT,6,7)_"/"_$E(DT,2,3)
"RTN","PSOORFI1")
0^3^B71409262
"RTN","PSOORFI1",1,0)
PSOORFI1 ;BIR/SAB - finish OP orders from OE/RR continued ;11/19/04 12:56pm
"RTN","PSOORFI1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**7,15,23,27,32,44,51,46,71,90,108,131,152,186**;DEC 1997
"RTN","PSOORFI1",3,0)
 ;Ref. ^PS(50.7 supp. DBIA 2223
"RTN","PSOORFI1",4,0)
 ;Ref. ^PSDRUG( supp. DBIA 221
"RTN","PSOORFI1",5,0)
 ;Ref. L^PSSLOCK supp. DBIA 2789
"RTN","PSOORFI1",6,0)
 ;Ref. ^PS(50.606 supp. DBIA 2174
"RTN","PSOORFI1",7,0)
 ;Ref. ^PS(55 supp. DBIA 2228
"RTN","PSOORFI1",8,0)
 ;Ref. ULK^ORX2 supp. DBIA 867
"RTN","PSOORFI1",9,0)
 ;
"RTN","PSOORFI1",10,0)
 ;PSO*186 add call to function $$DEACHK
"RTN","PSOORFI1",11,0)
 ;
"RTN","PSOORFI1",12,0)
 S SIGOK=1
"RTN","PSOORFI1",13,0)
DSPL K ^TMP("PSOPO",$J),CLOZPAT,PSOPRC,PSODSPL
"RTN","PSOORFI1",14,0)
 S (OI,PSODRUG("OI"))=$P(OR0,"^",8),PSODRUG("OIN")=$P(^PS(50.7,$P(OR0,"^",8),0),"^"),OID=$P(OR0,"^",9)
"RTN","PSOORFI1",15,0)
 I $P($G(OR0),"^",9) S POERR=1,DREN=$P(OR0,"^",9) D DRG^PSOORDRG K POERR G DRG
"RTN","PSOORFI1",16,0)
 I '$P(OR0,"^",9) D DREN^PSOORNW2
"RTN","PSOORFI1",17,0)
DRG I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),"CLOZ1")),"^")="PSOCLO1" D CLOZ^PSOORFI2
"RTN","PSOORFI1",18,0)
 ;PSO*186 modify If/Else below to use DEACHK
"RTN","PSOORFI1",19,0)
 I $G(PSODRUG("DEA"))]"" D
"RTN","PSOORFI1",20,0)
 .S PSOCS=0 K DIR,DIC,PSOX
"RTN","PSOORFI1",21,0)
 .N PSDEA,PSDAYS S PSDEA=PSODRUG("DEA"),PSDAYS=+$P(OR0,"^",22)
"RTN","PSOORFI1",22,0)
 .I $$DEACHK^PSOUTLA1("*",PSDEA,PSDAYS,$G(CLOZPAT),.PSOCS,.PSOMAX)
"RTN","PSOORFI1",23,0)
 E  D
"RTN","PSOORFI1",24,0)
 .S PSOMAX=$S($G(CLOZPAT)=1:1,1:$P(OR0,"^",11))
"RTN","PSOORFI1",25,0)
ISSDT S (PSOID,Y,PSONEW("ISSUE DATE"))=$S($G(PSONEW("ISSUE DATE")):PSONEW("ISSUE DATE"),$P($G(OR0),"^",6):$E($P(OR0,"^",6),1,7),1:DT)
"RTN","PSOORFI1",26,0)
 X ^DD("DD") S PSONEW("ISSUE DATE")=Y
"RTN","PSOORFI1",27,0)
 D USER^PSOORFI2($P(OR0,"^",4)) S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSORX("CLERK CODE")=USER1
"RTN","PSOORFI1",28,0)
 S (PSONEW("DFLG"),PSONEW("QFLG"))=0,PSODFN=$P(OR0,"^",2),PSONEW("QTY")=$P(OR0,"^",10),PSONEW("MAIL/WINDOW")=$S($P(OR0,"^",17)="M":"M",1:"W")
"RTN","PSOORFI1",29,0)
 S:$G(PSONEW("CLINIC"))']"" PSONEW("CLINIC")=+$P(OR0,"^",13),PSORX("CLINIC")=$S($D(^SC(PSONEW("CLINIC"),0)):$P(^SC(PSONEW("CLINIC"),0),"^"),1:"")
"RTN","PSOORFI1",30,0)
 S:$G(PSORX("CLINIC"))']"" PSORX("CLINIC")=$S($D(^SC(+$P(OR0,"^",13),0)):$P(^SC($P(OR0,"^",13),0),"^"),1:"")
"RTN","PSOORFI1",31,0)
 D USER^PSOORFI2($P(OR0,"^",5))
"RTN","PSOORFI1",32,0)
 S PSONEW("CLERK CODE")=$P(OR0,"^",4),PSONEW("PROVIDER")=$P(OR0,"^",5),PSONEW("PROVIDER NAME")=USER1
"RTN","PSOORFI1",33,0)
 S PSONEW("PATIENT STATUS")=$S(+$G(^PS(55,PSODFN,"PS")):+$G(^PS(55,PSODFN,"PS")),1:"")
"RTN","PSOORFI1",34,0)
 S PSONEW("CHCS NUMBER")=$S($P($G(^PS(52.41,+$G(ORD),"EXT")),"^")'="":$P($G(^("EXT")),"^"),1:"")
"RTN","PSOORFI1",35,0)
 S PSONEW("EXTERNAL SYSTEM")=$S($P($G(^PS(52.41,+$G(ORD),"EXT")),"^",3)'="":$P($G(^("EXT")),"^",3),1:"")
"RTN","PSOORFI1",36,0)
 I $P(OR0,"^",22)>0 S PSONEW("DAYS SUPPLY")=$P(OR0,"^",22) G DS
"RTN","PSOORFI1",37,0)
 S PSONEW("DAYS SUPPLY")=$S(+$G(^PS(55,PSODFN,"PS"))&($P($G(^PS(53,+$G(^PS(55,PSODFN,"PS")),0)),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:30)
"RTN","PSOORFI1",38,0)
DS S:$D(CLOZPAT) PSONEW("DAYS SUPPLY")=$S(CLOZPAT&(PSONEW("DAYS SUPPLY")>14):14,'CLOZPAT&(PSONEW("DAYS SUPPLY")>7):7,1:PSONEW("DAYS SUPPLY"))
"RTN","PSOORFI1",39,0)
 S IEN=0 D OBX
"RTN","PSOORFI1",40,0)
 D DIN^PSONFI(PSODRUG("OI"),$S($D(PSODRUG("IEN")):PSODRUG("IEN"),1:"")) ;Setup for N/F & DIN indicator
"RTN","PSOORFI1",41,0)
 I $G(PKI1)!($G(PKI)=1) D L1^PSOPKIV1 K:$G(PKI)=1 PKI
"RTN","PSOORFI1",42,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="*(1) Orderable Item: "_$P(^PS(50.7,PSODRUG("OI"),0),"^")_" "_$P(^PS(50.606,$P(^(0),"^",2),0),"^")_NFIO
"RTN","PSOORFI1",43,0)
 S:NFIO["<DIN>" NFIO=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORFI1",44,0)
 D FULL^VALM1 K LST I $G(PSODRUG("NAME"))]"" D  G PST
"RTN","PSOORFI1",45,0)
 .S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)"_$S($D(^PSDRUG("AQ",PSODRUG("IEN"))):"      CMOP ",1:"           ")_"Drug: "_PSODRUG("NAME")_NFID
"RTN","PSOORFI1",46,0)
 .S:NFID["<DIN>" NFID=IEN_","_($L(^TMP("PSOPO",$J,IEN,0))-4)
"RTN","PSOORFI1",47,0)
 .I $P(^PSDRUG(PSODRUG("IEN"),0),"^",10)]"" S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Drug Message:" D DRGMSG^PSOORNEW
"RTN","PSOORFI1",48,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (2)           Drug: No Dispense Drug Selected"
"RTN","PSOORFI1",49,0)
PST D DOSE^PSOORFI4 K PSOINSFL
"RTN","PSOORFI1",50,0)
 S PSOINSFL=$P($G(^PS(52.41,ORD,"INS")),"^",2)
"RTN","PSOORFI1",51,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (4)   Pat Instruct:" D INST^PSOORFI4
"RTN","PSOORFI1",52,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="  Provider Comments:" S TY=3 D INST
"RTN","PSOORFI1",53,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Instructions:" S TY=2 D INST
"RTN","PSOORFI1",54,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="                SIG:" D SIG
"RTN","PSOORFI1",55,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (5) Patient Status: "_$P($G(^PS(53,+PSONEW("PATIENT STATUS"),0)),"^")
"RTN","PSOORFI1",56,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (6)     Issue Date: "_PSONEW("ISSUE DATE")
"RTN","PSOORFI1",57,0)
 S (Y,PSONEW("FILL DATE"))=$S($E($P(OR0,"^",6),1,7)<DT:DT,1:$E($P(OR0,"^",6),1,7)) X ^DD("DD") S PSORX("FILL DATE")=Y,^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"        (7) Fill Date: "_Y
"RTN","PSOORFI1",58,0)
 I $P(OR0,"^",18) D
"RTN","PSOORFI1",59,0)
 .S IEN=IEN+1,Y=$P(OR0,"^",18) X ^DD("DD") S $P(^TMP("PSOPO",$J,IEN,0)," ",39)="Effective Date: "_Y
"RTN","PSOORFI1",60,0)
 I $G(CLOZPAT)=1 D ELIG^PSOORFI2
"RTN","PSOORFI1",61,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)=" (8)    Days Supply: "_$S($G(PSONEW("DAYS SUPPLY")):PSONEW("DAYS SUPPLY"),+$G(^PS(55,PSODFN,"PS"))&($P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3)):$P(^PS(53,+$G(^PS(55,PSODFN,"PS")),0),"^",3),1:"")
"RTN","PSOORFI1",62,0)
 I +$G(^PS(55,PSODFN,"PS")) S RXPT=+^("PS") I $G(^PS(53,RXPT,0))]"" D
"RTN","PSOORFI1",63,0)
 .S PSONEW("# OF REFILLS")=$S(+$P(OR0,"^",11)>+$P(^PS(53,RXPT,0),"^",4):+$P(^PS(53,RXPT,0),"^",4),1:+$P(OR0,"^",11)),PSOX=+$P(^PS(53,RXPT,0),"^",4)
"RTN","PSOORFI1",64,0)
 .S PSONEW("# OF REFILLS")=$S(PSONEW("# OF REFILLS")>PSOMAX:PSOMAX,1:PSONEW("# OF REFILLS"))
"RTN","PSOORFI1",65,0)
 .S PSOMAX=$S(PSOMAX>+$P(^PS(53,RXPT,0),"^",4):+$P(^PS(53,RXPT,0),"^",4),1:PSOMAX) K RXPT
"RTN","PSOORFI1",66,0)
 .S MPSDY=PSONEW("DAYS SUPPLY")
"RTN","PSOORFI1",67,0)
 .;I PSOMAX=5 S MAXRF=$S(MPSDY<60:5,MPSDY'<60&(MPSDY'>89):2,1:1) I PSONEW("# OF REFILLS")>MAXRF S PSONEW("# OF REFILLS")=MAXRF K MAXRF,MPSDY Q
"RTN","PSOORFI1",68,0)
 .S MAXRF=$S(MPSDY<60:11,MPSDY'<60&(MPSDY'>89):5,MPSDY=90:3,1:0)
"RTN","PSOORFI1",69,0)
 .I PSONEW("# OF REFILLS")>MAXRF S PSONEW("# OF REFILLS")=MAXRF K MAXRF,MPSDY
"RTN","PSOORFI1",70,0)
 E  D
"RTN","PSOORFI1",71,0)
 . I $G(PSOMAX) S PSONEW("# OF REFILLS")=$S(+$P(OR0,"^",11)>PSOMAX:PSOMAX,1:+$P(OR0,"^",11)) Q
"RTN","PSOORFI1",72,0)
 .S PSONEW("# OF REFILLS")=+$P(OR0,"^",11)
"RTN","PSOORFI1",73,0)
 S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"                (9)   QTY"_$S($P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)]"":" ("_$P($G(^PSDRUG(+$G(PSODRUG("IEN")),660)),"^",8)_")",1:" (  )")_": "_$P(OR0,"^",10)
"RTN","PSOORFI1",74,0)
 I $P($G(^PSDRUG(+$G(PSODRUG("IEN")),5)),"^")]"" D
"RTN","PSOORFI1",75,0)
 .S $P(RN," ",79)=" ",IEN=IEN+1
"RTN","PSOORFI1",76,0)
 .S ^TMP("PSOPO",$J,IEN,0)=$E(RN,$L("QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^"))+1,79)_"QTY DSP MSG: "_$P(^PSDRUG(PSODRUG("IEN"),5),"^") K RN
"RTN","PSOORFI1",77,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="       Provider ordered "_+$P(OR0,"^",11)_" refills"
"RTN","PSOORFI1",78,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(10)   # of Refills: "_PSONEW("# OF REFILLS")_$E("  ",$L(PSONEW("# OF REFILLS"))+1,2)_"               (11)   Routing: "_$S($G(PSONEW("MAIL/WINDOW"))="M":"MAIL",1:"WINDOW")
"RTN","PSOORFI1",79,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(12)         Clinic: "_PSORX("CLINIC")
"RTN","PSOORFI1",80,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(13)       Provider: "_PSONEW("PROVIDER NAME")
"RTN","PSOORFI1",81,0)
 I $P($G(^VA(200,$S($G(PSONEW("PROVIDER")):PSONEW("PROVIDER"),1:$P(OR0,"^",5)),"PS")),"^",7)&($P($G(^("PS")),"^",8)) S PSONEW("COSIGNING PROVIDER")=$P(^("PS"),"^",8) D
"RTN","PSOORFI1",82,0)
 .D USER^PSOORFI2(PSONEW("COSIGNING PROVIDER"))
"RTN","PSOORFI1",83,0)
 .S IEN=IEN+1 S ^TMP("PSOPO",$J,IEN,0)="        Cos-Provider: "_USER1
"RTN","PSOORFI1",84,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(14)         Copies: 1"
"RTN","PSOORFI1",85,0)
 S PSONEW("REMARKS")=$S($P(OR0,"^",17)="C":"Administered in Clinic.",1:"")
"RTN","PSOORFI1",86,0)
 S IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="(15)        Remarks: "_$S($G(PSONEW("REMARKS"))]"":PSONEW("REMARKS"),1:"")
"RTN","PSOORFI1",87,0)
 D USER^PSOORFI2($P(OR0,"^",4))
"RTN","PSOORFI1",88,0)
 S $P(RN," ",35)=" ",IEN=IEN+1,^TMP("PSOPO",$J,IEN,0)="   Entry By: "_USER1_$E(RN,$L(USER1)+1,35)
"RTN","PSOORFI1",89,0)
 S Y=$P(OR0,"^",12) X ^DD("DD") S ^TMP("PSOPO",$J,IEN,0)=^TMP("PSOPO",$J,IEN,0)_"Entry Date: "_$E($P(OR0,"^",12),4,5)_"/"_$E($P(OR0,"^",12),6,7)_"/"_$E($P(OR0,"^",12),2,3)_" "_$P(Y,"@",2) K RN
"RTN","PSOORFI1",90,0)
 S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEF",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORFI1",91,0)
 D:'$G(ACP) EN^PSOLMPO S:$G(ACP) VALMBCK="Q" D:$G(PKI1)=2 DCP^PSOPKIV1
"RTN","PSOORFI1",92,0)
 Q
"RTN","PSOORFI1",93,0)
POST ;post patient selection
"RTN","PSOORFI1",94,0)
 D POST^PSOORFI2 Q
"RTN","PSOORFI1",95,0)
SIG ;displays possible sig
"RTN","PSOORFI1",96,0)
 D SIG^PSOORFI2 Q
"RTN","PSOORFI1",97,0)
INST ;displays provider comments and pharmacy instructions
"RTN","PSOORFI1",98,0)
 S INST=0 F  S INST=$O(^PS(52.41,ORD,TY,INST)) Q:'INST  S (MIG,INST(INST))=^PS(52.41,ORD,TY,INST,0) D
"RTN","PSOORFI1",99,0)
 .F SG=1:1:$L(MIG," ") S:$L(^TMP("PSOPO",$J,IEN,0)_" "_$P(MIG," ",SG))>80 IEN=IEN+1,$P(^TMP("PSOPO",$J,IEN,0)," ",20)=" " S ^TMP("PSOPO",$J,IEN,0)=$G(^TMP("PSOPO",$J,IEN,0))_" "_$P(MIG," ",SG)
"RTN","PSOORFI1",100,0)
 K INST,TY,MIG,SG
"RTN","PSOORFI1",101,0)
 Q
"RTN","PSOORFI1",102,0)
OBX ;formats obx section
"RTN","PSOORFI1",103,0)
 D OBX^PSOORFI4
"RTN","PSOORFI1",104,0)
 Q
"RTN","PSOORFI1",105,0)
ST ;sort by route or patient
"RTN","PSOORFI1",106,0)
 W !!,"Enter 'PA' to process orders by patients",!,"      'RT' to process orders by route (mail/window)",!,"      'PR' to process orders by priority",!,"      'CL' to process orders by clinic",!,"   or 'E' or '^' to exit" W ! Q
"RTN","PSOORFI1",107,0)
RT ;which route to sort by
"RTN","PSOORFI1",108,0)
 W !!,"Enter 'W' to process window orders first",!,"      'M' to process mail orders first",!,"      'C' to process orders administered in clinic first",!,"   or 'E' or '^' to exit" Q
"RTN","PSOORFI1",109,0)
PT ;process for all or one patient
"RTN","PSOORFI1",110,0)
 W !!,"Enter 'A' to process all patient orders",!,"      'S' to process orders for a patient",!,"      or 'E' or '^' to exit" Q
"RTN","PSOORFI1",111,0)
EP ;continue processing or not
"RTN","PSOORFI1",112,0)
 W !,"If you want to continue processing orders Press RETURN or enter '^' to exit" Q
"RTN","PSOORFI1",113,0)
LOCK S PSOPLCK=$$L^PSSLOCK(PAT,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S POERR("QFLG")=1
"RTN","PSOORFI1",114,0)
 K PSOPLCK
"RTN","PSOORFI1",115,0)
 Q
"RTN","PSOORFI1",116,0)
ULK S X=PAT_";DPT(" D ULK^ORX2 S:$G(PSOQUIT) POERR("QFLG")=1 ; not called anymore
"RTN","PSOORFI1",117,0)
 Q
"RTN","PSOORFI1",118,0)
LOCK1 S PSOACT=$S($D(^XUSEC("PSORPH",DUZ)):"DEF",'$D(^XUSEC("PSORPH",DUZ))&($P($G(PSOPAR),"^",2)):"F",1:"")
"RTN","PSOORFI1",119,0)
 Q
"RTN","PSOORFI1",120,0)
EX K DRET,SIG,PSODRUG,PRC,PHI
"RTN","PSOORFI1",121,0)
 K DIR,DIRUT,DUOUT,DIRUT,X,Y,DIC,POERR,PSONEW,PSOSD,MAIL,CLI,WIN,OR0,OR1,OR2,ORD,SRT,PSRT,PSODFN,PSOFROM,T,OR3,PAT,%,%T,%Y,DI,DQ,DR,DRG,STA,I,T1,PSOSORT
"RTN","PSOORFI1",122,0)
 K TO,TC,TZ,PSOCPAY,PSOBILL,PSOIBQS,GROUPCNT,AGROUP,AGROUP1,OBX,%,%I,%H,D0,DFN,PSORX,PSOPTPST,PSOQFLG,PT,RTN,TM,TM1,DIPGM,PSOID,PSOCNT,PSOLK,PSZFIN,PSZFZZ D KVA^VADPT
"RTN","PSOORFI1",123,0)
 K PSOFDR,PSOQUIT,PSOFIN,^TMP("PSOAO",$J),^TMP("PSODA",$J),^TMP("PSOPO",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOHDR",$J),MEDA,MEDP
"RTN","PSOORFI1",124,0)
 K C,CC,CNT,CRIT,D,DGI,DGS,DREN,IT,JJ,LG,MM,NIEN,PSOD,PATA,PSDAYS,PSOACT,PSOBM,PSOCOU,PSOCOUU,PSOFLAG,PSON,PSONOOR,PSOOPT,PSOPF,PSOPI,PSRF,RXFL,SDA,SEG1,SER,SERS,SLPPL,STAT,Z,Z4,ZDA
"RTN","PSOORFI1",125,0)
 D FULL^VALM1
"RTN","PSOORFI1",126,0)
 Q
"RTN","PSOREF0")
0^2^B35694868
"RTN","PSOREF0",1,0)
PSOREF0 ;IHS/JCM - REFILL CON'T ; 1/18/05 8:23am
"RTN","PSOREF0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**14,152,180,186**;DEC 1997
"RTN","PSOREF0",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOREF0",4,0)
 ;
"RTN","PSOREF0",5,0)
 ;PSO*186 add check for DEA Special handling field refill restrictions
"RTN","PSOREF0",6,0)
PROCESS ;
"RTN","PSOREF0",7,0)
 K PSODF S PSOREF("RX0")=^PSRX(PSOREF("IRXN"),0),PSOREF("RX2")=^(2),PSOREF("RX3")=^(3),PSOREF("STA")=+$G(^("STA")),PSOREF("SIG")=$P($G(^("SIG")),"^"),PSOREF("PSODFN")=$P(PSOREF("RX0"),"^",2)
"RTN","PSOREF0",8,0)
 S PSOREF("DAYS SUPPLY")=$P(PSOREF("RX0"),"^",8)
"RTN","PSOREF0",9,0)
 I $D(PSORX("BAR CODE")),PSODFN'=PSOREF("PSODFN") D NEWPT
"RTN","PSOREF0",10,0)
 W !,"Now refilling Rx# ",$P(PSOREF("RX0"),"^")_"   Drug: "_$P(^PSDRUG($P(PSOREF("RX0"),"^",6),0),"^")
"RTN","PSOREF0",11,0)
 S PSOREF("DFLG")=0 D DSPLY G:PSOREF("DFLG") PROCESSX
"RTN","PSOREF0",12,0)
 D CHECK G:$G(PSODF) PROCESS G:PSOREF("DFLG") PROCESSX D EN^PSOR52(.PSOREF)
"RTN","PSOREF0",13,0)
 S:$G(PSOREF("MAIL/WINDOW"))["W" BINGRTE="W",BINGCRT=1
"RTN","PSOREF0",14,0)
PROCESSX D:$G(PSOREF("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSOREF)
"RTN","PSOREF0",15,0)
 Q
"RTN","PSOREF0",16,0)
DSPLY ;W !!,$P(PSOREF("RX0"),"^"),?12," ",$P(^PSDRUG($P(PSOREF("RX0"),"^",6),0),"^"),?45," SIG: "_PSOREF("SIG"),?60," QTY: ",$P(PSOREF("RX0"),"^",7)
"RTN","PSOREF0",17,0)
 K FSIG,BSIG I $P($G(^PSRX(PSOREF("IRXN"),"SIG")),"^",2) D FSIG^PSOUTLA("R",PSOREF("IRXN"),54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSOREF0",18,0)
 K FSIG,PSREV I '$P($G(^PSRX(PSOREF("IRXN"),"SIG")),"^",2) D EN2^PSOUTLA1(PSOREF("IRXN"),54)
"RTN","PSOREF0",19,0)
 W !!,"Qty: ",$P(PSOREF("RX0"),"^",7),?19,"Sig: ",$G(BSIG(1))
"RTN","PSOREF0",20,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSOREF0",21,0)
 K BSIG,PSREV
"RTN","PSOREF0",22,0)
DSPLYX Q
"RTN","PSOREF0",23,0)
CHECK ;
"RTN","PSOREF0",24,0)
 I '$P(PSOPAR,"^",11),$G(^PSDRUG($P(PSOREF("RX0"),"^",6),"I"))]"",DT>$G(^("I")) D  G CKQ
"RTN","PSOREF0",25,0)
 .W $C(7),!!," *** Drug is inactive for Rx # "_$P(PSOREF("RX0"),"^")_" cannot be refilled ***",!
"RTN","PSOREF0",26,0)
 I '$D(PSORX("BAR CODE")),PSOREF("PSODFN")'=PSODFN W !!,?5,$C(7),"Can't refill Rx # "_$P(PSOREF("RX0"),"^")_", it is not for this patient." G CKQ
"RTN","PSOREF0",27,0)
 S (PSOX,PSOY,STA)=""
"RTN","PSOREF0",28,0)
 I $G(PSOSD) F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S PSOX=$O(PSOSD(STA,PSOX)) Q:PSOX']""!(PSOREF("DFLG"))  I PSOREF("IRXN")=+PSOSD(STA,PSOX) S PSOY=PSOSD(STA,PSOX) I $P(PSOY,"^",4)]"" D
"RTN","PSOREF0",29,0)
 . S PSOREF("DFLG")=1 W:'$G(PSOERR) !,$C(7),"Cannot refill Rx # "_$P(PSOREF("RX0"),"^") S PSOREA=$P(PSOY,"^",4),PSOSTAT=PSOREF("STA")
"RTN","PSOREF0",30,0)
 . D STATUS^PSOUTIL(PSOREA,PSOSTAT) K PSOREA,PSOSTAT
"RTN","PSOREF0",31,0)
 . Q
"RTN","PSOREF0",32,0)
 I PSOY="" W !,$C(7),"Cannot refill, Rx is discontinued or expired.  Later Rx may exist.",! D  I $G(PSODF) Q
"RTN","PSOREF0",33,0)
 .D LOOK^PSOREF2 I $G(PSODF) Q
"RTN","PSOREF0",34,0)
 .S PSOREF("DFLG")=1
"RTN","PSOREF0",35,0)
 K PSOX,PSOY G:PSOREF("DFLG") CHECKX
"RTN","PSOREF0",36,0)
 I $O(^PS(52.5,"B",PSOREF("IRXN"),0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSOREF("IRXN"),0)),"P")) W !,$C(7),"Rx is in suspense and cannot be refilled" S PSOREF("DFLG")=1 G CHECKX
"RTN","PSOREF0",37,0)
 ;
"RTN","PSOREF0",38,0)
 S PSOREF("RXSTATUS")=PSOREF("STA")
"RTN","PSOREF0",39,0)
 I PSOREF("RXSTATUS"),PSOREF("RXSTATUS")'=6 D  G CHECKX
"RTN","PSOREF0",40,0)
 . S PSOY=";"_PSOREF("RXSTATUS"),PSOX=$P(^DD(52,100,0),"^",3),PSOY=$F(PSOX,PSOY),PSOY=$P($E(PSOX,PSOY,999),";",1)
"RTN","PSOREF0",41,0)
 . W !,$C(7),"Rx is in "_PSOY_" status, cannot be refilled" S PSOREF("DFLG")=1
"RTN","PSOREF0",42,0)
 D CHKDIV G:PSOREF("DFLG") CHECKX
"RTN","PSOREF0",43,0)
 D NUMBER I PSOREF("NUMBER")>$P(PSOREF("RX0"),"^",9) W !?5,"Can't refill, no refills remaining." S PSOREF("DFLG")=1 G CHECKX
"RTN","PSOREF0",44,0)
 ;
"RTN","PSOREF0",45,0)
 ;PSO*7*186  check DEA, SPEC HNDLG field, in case changed, and apply
"RTN","PSOREF0",46,0)
 N PSODRG,PSODEA,PSODAY
"RTN","PSOREF0",47,0)
 S PSODRG=$G(^PSDRUG($P(PSOREF("RX0"),U,6),0)),PSODEA=$P(PSODRG,U,3)
"RTN","PSOREF0",48,0)
 S PSODAY=$P(PSOREF("RX0"),U,8)
"RTN","PSOREF0",49,0)
 I $$DEACHK^PSOUTLA1(PSOREF("IRXN"),PSODEA,PSODAY) D  G CHECKX
"RTN","PSOREF0",50,0)
 . W $C(7),!!,"This drug has been changed, No refills allowed",!
"RTN","PSOREF0",51,0)
 . S PSOREF("DFLG")=1
"RTN","PSOREF0",52,0)
 ;
"RTN","PSOREF0",53,0)
 D DATES
"RTN","PSOREF0",54,0)
CHECKX Q
"RTN","PSOREF0",55,0)
CKQ ;
"RTN","PSOREF0",56,0)
 S PSOREF("DFLG")=1 D PAUSE^VALM1 G CHECKX
"RTN","PSOREF0",57,0)
 Q
"RTN","PSOREF0",58,0)
 ;
"RTN","PSOREF0",59,0)
CHKDIV G:$P(PSOREF("RX2"),"^",9)=+PSOSITE CHKDIVX
"RTN","PSOREF0",60,0)
 W !?5,$C(7),"RX # ",$P(PSOREF("RX0"),"^")," is for (",$P(^PS(59,$P(PSOREF("RX2"),"^",9),0),"^"),") division."
"RTN","PSOREF0",61,0)
 I '$P($G(PSOSYS),"^",2) S PSOREF("DFLG")=1 G CHKDIVX
"RTN","PSOREF0",62,0)
 D:$P($G(PSOSYS),"^",3) DIR
"RTN","PSOREF0",63,0)
CHKDIVX Q
"RTN","PSOREF0",64,0)
 ;
"RTN","PSOREF0",65,0)
NUMBER K PSOX,PSOY S PSOREF("# OF REFILLS")=0
"RTN","PSOREF0",66,0)
 I $G(^PSRX(PSOREF("IRXN"),1,0))]"" F PSOX=0:0 S PSOX=$O(^PSRX(PSOREF("IRXN"),1,PSOX)) Q:'PSOX  S PSOREF("# OF REFILLS")=PSOX
"RTN","PSOREF0",67,0)
 S PSOREF("NUMBER")=PSOREF("# OF REFILLS")+1
"RTN","PSOREF0",68,0)
 Q
"RTN","PSOREF0",69,0)
 ;
"RTN","PSOREF0",70,0)
DATES S PSOREF("STOP DATE")=$P(PSOREF("RX2"),"^",6) D NEXT^PSOUTIL(.PSOREF)
"RTN","PSOREF0",71,0)
 D:$G(PSOBBC("QFLG"))&($P(PSOPAR,"^",6)) EDATE Q:$G(PSOREF("DFLG"))
"RTN","PSOREF0",72,0)
 S PSOREF("FILL DATE")=$S($G(PSOREF("FILL DATE")):PSOREF("FILL DATE"),1:DT)
"RTN","PSOREF0",73,0)
 I $P(PSOPAR,"^",6),PSOREF("FILL DATE")<$P(PSOREF("RX3"),"^",2) D SUSDATE^PSOUTIL(.PSOREF)
"RTN","PSOREF0",74,0)
 ;
"RTN","PSOREF0",75,0)
 I PSOREF("FILL DATE")>PSOREF("STOP DATE") D
"RTN","PSOREF0",76,0)
 . W !!?5,$C(7),"Can't refill, Refill Date ",$E(PSOREF("FILL DATE"),4,5),"/",$E(PSOREF("FILL DATE"),6,7),"/"
"RTN","PSOREF0",77,0)
 . W $E(PSOREF("FILL DATE"),2,3)," is past Expiration Date ",$E(PSOREF("STOP DATE"),4,5),"/",$E(PSOREF("STOP DATE"),6,7),"/"
"RTN","PSOREF0",78,0)
 . W $E(PSOREF("STOP DATE"),2,3) S PSOREF("DFLG")=1
"RTN","PSOREF0",79,0)
EDATE S PSOREF("LAST REFILL DATE")=$P(PSOREF("RX3"),"^",1)
"RTN","PSOREF0",80,0)
 I PSOREF("LAST REFILL DATE"),PSOREF("FILL DATE")=PSOREF("LAST REFILL DATE") D  G DATESX
"RTN","PSOREF0",81,0)
 . W !?5,"Can't refill, Fill Date already exists for ",$E(PSOREF("FILL DATE"),4,5),"/",$E(PSOREF("FILL DATE"),6,7),"/",$E(PSOREF("FILL DATE"),2,3)
"RTN","PSOREF0",82,0)
 . S PSOREF("DFLG")=1
"RTN","PSOREF0",83,0)
 I PSOREF("LAST REFILL DATE"),PSOREF("FILL DATE")<PSOREF("LAST REFILL DATE") D  G DATESX
"RTN","PSOREF0",84,0)
 . W !?5,"Can't refill, later Refill Date already exists for ",$E(PSOREF("LAST REFILL DATE"),4,5),"/",$E(PSOREF("LAST REFILL DATE"),6,7),"/",$E(PSOREF("LAST REFILL DATE"),2,3)
"RTN","PSOREF0",85,0)
 . S PSOREF("DFLG")=1
"RTN","PSOREF0",86,0)
 I '$P(PSOPAR,"^",6),'$D(PSOREF("EAOK")),$P(PSOREF("RX3"),"^",2)>PSOREF("FILL DATE") D
"RTN","PSOREF0",87,0)
 . S PSOX1=(PSOREF("NUMBER")+1)*PSOREF("DAYS SUPPLY")-10
"RTN","PSOREF0",88,0)
 . W !?5,$C(7),"LESS THAN ",PSOX1," DAYS FOR ",PSOREF("NUMBER")+1," FILLS",! D DIR K PSOX1
"RTN","PSOREF0",89,0)
 I '$P(PSOPAR,"^",6),$G(PSOREF("EAOK"))=0,$P(PSOREF("RX3"),"^",2)>PSOREF("FILL DATE") D
"RTN","PSOREF0",90,0)
 . S Y=$P(PSOREF("RX3"),"^",2) D DD^%DT W !!,$C(7),"Cannot be refilled until "_Y_"." S PSOREF("DFLG")=1 K Y
"RTN","PSOREF0",91,0)
DATESX Q
"RTN","PSOREF0",92,0)
DIR K DIR,X,Y S DIR(0)="Y",DIR("A")="Continue ",DIR("B")="N",DIR("?")="Answer YES to Refill, NO to bypass"
"RTN","PSOREF0",93,0)
 D ^DIR K DIR S:$D(DIRUT)!('Y) PSOREF("DFLG")=1 K DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSOREF0",94,0)
 Q
"RTN","PSOREF0",95,0)
NEWPT S PSOQFLG=0,(DFN,PSODFN)=PSOREF("PSODFN") D ^PSOPTPST I PSOQFLG S PSOREF("DFLG")=1,PSOQFLG=0 G NEWPTX
"RTN","PSOREF0",96,0)
 D PROFILE^PSOREF1
"RTN","PSOREF0",97,0)
NEWPTX Q
"RTN","PSOREF0",98,0)
 ;
"RTN","PSOREF0",99,0)
EN(PSOREF)         ; Entry Point for Batch Barcode Option
"RTN","PSOREF0",100,0)
 D PROCESS K DRUG,PSODF
"RTN","PSOREF0",101,0)
 Q
"RTN","PSOUTLA1")
0^4^B44704112
"RTN","PSOUTLA1",1,0)
PSOUTLA1 ;BHAM ISC/RTR-Pharmacy utility program cont. ;11/19/04 1:04pm
"RTN","PSOUTLA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**35,186**;DEC 1997
"RTN","PSOUTLA1",3,0)
 ;External reference to File ^PS(55 supported by DBIA 2228
"RTN","PSOUTLA1",4,0)
 ;External reference to File ^PSDRUG supported by DBIA 221
"RTN","PSOUTLA1",5,0)
 ;External reference to File ^PS(59.7 supported by DBIA 694
"RTN","PSOUTLA1",6,0)
 ;External reference to File ^PS(51 supported by DBIA 2224
"RTN","PSOUTLA1",7,0)
 ;
"RTN","PSOUTLA1",8,0)
 ;PSO*186 - add DEACHK function
"RTN","PSOUTLA1",9,0)
 ;
"RTN","PSOUTLA1",10,0)
EN1 ;Formats condensed, back door sig in BSIG array
"RTN","PSOUTLA1",11,0)
 ;pass in  1) Internal Rx from 52
"RTN","PSOUTLA1",12,0)
 ;         2) max length of BSIG array
"RTN","PSOUTLA1",13,0)
 ;Returned, still condensed, in BSIG array, when looping through, check for array=null, if so, juist don't print it
"RTN","PSOUTLA1",14,0)
EN2(PSOBINTR,PSOBLGTH) ;
"RTN","PSOUTLA1",15,0)
 K BSIG
"RTN","PSOUTLA1",16,0)
 N BBSIG,BVAR,BVAR1,III,CNT,NNN,BLIM
"RTN","PSOUTLA1",17,0)
 S BBSIG=$P($G(^PSRX(PSOBINTR,"SIG")),"^") Q:BBSIG=""!($P($G(^("SIG")),"^",2))
"RTN","PSOUTLA1",18,0)
 S (BVAR,BVAR1)="",III=1
"RTN","PSOUTLA1",19,0)
 S CNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S CNT=CNT+1 D  I $L(BVAR)>PSOBLGTH S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSOUTLA1",20,0)
 .S BVAR1=$P(BBSIG," ",(CNT))
"RTN","PSOUTLA1",21,0)
 .S BLIM=BVAR
"RTN","PSOUTLA1",22,0)
 .S BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1)
"RTN","PSOUTLA1",23,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSOUTLA1",24,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSOUTLA1",25,0)
 Q
"RTN","PSOUTLA1",26,0)
 ;
"RTN","PSOUTLA1",27,0)
EN3(PSOBINTR,PSOBLGTH) ;
"RTN","PSOUTLA1",28,0)
 ;Pass in to EN3 the internal Rx number from 52, and the length of
"RTN","PSOUTLA1",29,0)
 ;the array you want. Returns expanded Sig, or warning from PSOHELP
"RTN","PSOUTLA1",30,0)
 ;concantenated with the condensed Sig in the BSIG array
"RTN","PSOUTLA1",31,0)
 ;BACK DOOR ONLY
"RTN","PSOUTLA1",32,0)
 K BSIG,X N BBSIG,BVAR,BVAR1,III,CNT,NNN,BLIM,Y,SIG,Z0,Z1,BBWARN
"RTN","PSOUTLA1",33,0)
 S BBSIG=$P($G(^PSRX(PSOBINTR,"SIG")),"^") Q:BBSIG=""!($P($G(^("SIG")),"^",2))
"RTN","PSOUTLA1",34,0)
 S (SIG,X)=BBSIG
"RTN","PSOUTLA1",35,0)
 I $E(BBSIG)=" " S BBWARN="Leading spaces are not allowed in the SIG!" G START
"RTN","PSOUTLA1",36,0)
 S SIG="" Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" START S Z1=$P(X," ",Z0) D  G:'$D(X) START
"RTN","PSOUTLA1",37,0)
 .I $L(Z1)>32 S BBWARN="MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES!" K X Q
"RTN","PSOUTLA1",38,0)
 .D:$D(X)&($G(Z1)]"")  S SIG=SIG_" "_Z1
"RTN","PSOUTLA1",39,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2) Q:'$D(^(9))  S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOUTLA1",40,0)
START ;
"RTN","PSOUTLA1",41,0)
 S BBSIG=$S($G(BBWARN)="":SIG,1:BBWARN_"  "_BBSIG)
"RTN","PSOUTLA1",42,0)
 S (BVAR,BVAR1)="",III=1
"RTN","PSOUTLA1",43,0)
 S CNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S CNT=CNT+1 D  I $L(BVAR)>PSOBLGTH S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSOUTLA1",44,0)
 .S BVAR1=$P(BBSIG," ",(CNT))
"RTN","PSOUTLA1",45,0)
 .S BLIM=BVAR
"RTN","PSOUTLA1",46,0)
 .S BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1)
"RTN","PSOUTLA1",47,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSOUTLA1",48,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSOUTLA1",49,0)
 Q
"RTN","PSOUTLA1",50,0)
PATCH ;Allow sites to backfill more than what was done at install
"RTN","PSOUTLA1",51,0)
 N PSOBACKL,PSOBACKI,PSOBACKS,PSOBACKB,PSOBACKD,PSOBACKA
"RTN","PSOUTLA1",52,0)
 S PSOBACKL=$O(^PS(59.7,0)),PSOBACKI=$E($P($G(^PS(59.7,+$G(PSOBACKL),49.99)),"^",7),1,7)
"RTN","PSOUTLA1",53,0)
 I '$G(PSOBACKI) S PSOBACKI=$P($G(^PS(59.7,+$G(PSOBACKL),49.99)),"^",4)
"RTN","PSOUTLA1",54,0)
 I $G(PSOBACKI) S Y=PSOBACKI D DD^%DT S PSOBACKS=Y S X1=PSOBACKI,X2=-120 D C^%DTC S (Y,PSOBACKB)=X D DD^%DT S PSOBACKD=Y
"RTN","PSOUTLA1",55,0)
 I $G(PSOBACKD)'="" W !!,"Your CPRS/Outpatient installation date is "_$G(PSOBACKS)_","_" which",!,"means we have already backfilled all active prescriptions and all",!,"prescriptions canceled or expired after "_$G(PSOBACKD)_"."
"RTN","PSOUTLA1",56,0)
 I  W !!,"If you want to backfill orders that were canceled or expired prior to this",!,"date of "_$G(PSOBACKD)_", enter an earlier date and those orders",!,"will be backfilled to CPRS.",!
"RTN","PSOUTLA1",57,0)
 I $G(PSOBACKD)="" W !!,"We cannot determine the date of the CPRS/Outpatient installation.",!
"RTN","PSOUTLA1",58,0)
 W !,"If you choose to backfill more orders to CPRS by utilizing this option,",!,"we remind you that disk storage can be significantly affected, depending on",!,"how many orders are backfilled.",!
"RTN","PSOUTLA1",59,0)
 K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to backfill more prescriptions",DIR("?")="Enter Yes to backfill prescriptions canceled or expired before "_$G(PSOBACKD) D ^DIR K DIR I Y'=1 W ! G PATCHQ
"RTN","PSOUTLA1",60,0)
 W ! S %DT="AEPX",%DT("A")="Enter Date to begin backfill: " S:$G(PSOBACKB) %DT(0)=-PSOBACKB D ^%DT G:Y<0!($D(DTOUT)) PATCHQ S PSOBACKA=$E(Y,1,7)
"RTN","PSOUTLA1",61,0)
 W ! K ZTDTH S ZTSAVE("PSOBACKB")="",ZTSAVE("PSOBACKA")="",ZTRTN="PATCHR^PSOUTLA1",ZTDESC="BACKFILL PRSCRIPTIONS TO CPRS",ZTIO="" D ^%ZTLOAD W ! G PATCHQ
"RTN","PSOUTLA1",62,0)
PATCHR ;Begin task
"RTN","PSOUTLA1",63,0)
 N PSOPAL,PSOLPD,PSOLPRX
"RTN","PSOUTLA1",64,0)
 S PSOBACKA=PSOBACKA-.01
"RTN","PSOUTLA1",65,0)
 I '$G(PSOBACKB) S PSOBACKB=DT
"RTN","PSOUTLA1",66,0)
 F PSOPAL=0:0 S PSOPAL=$O(^PS(55,PSOPAL)) Q:'PSOPAL  F PSOLPD=PSOBACKA:0 S PSOLPD=$O(^PS(55,PSOPAL,"P","A",PSOLPD)) Q:'PSOLPD!(PSOLPD>PSOBACKB)  F PSOLPRX=0:0 S PSOLPRX=$O(^PS(55,PSOPAL,"P","A",PSOLPD,PSOLPRX)) Q:'PSOLPRX  D
"RTN","PSOUTLA1",67,0)
 .I $P($G(^PSRX(PSOLPRX,0)),"^")=""!('$P($G(^(0)),"^",2))!('$P($G(^(0)),"^",6)) Q
"RTN","PSOUTLA1",68,0)
 .I $P($G(^PSRX(PSOLPRX,"OR1")),"^",2) Q
"RTN","PSOUTLA1",69,0)
 .I '$P($G(^PSRX(PSOLPRX,0)),"^",19) D
"RTN","PSOUTLA1",70,0)
 ..I $P($G(^PSRX(PSOLPRX,"OR1")),"^")="",+$G(^PSDRUG(+$P($G(^PSRX(PSOLPRX,0)),"^",6),2)) S $P(^PSRX(PSOLPRX,"OR1"),"^")=+$G(^PSDRUG(+$P($G(^PSRX(PSOLPRX,0)),"^",6),2))
"RTN","PSOUTLA1",71,0)
 ..I $P($G(^PSRX(PSOLPRX,0)),"^",10)'="",$G(^PSRX(PSOLPRX,"SIG"))']"",'$O(^PSRX(PSOLPRX,"SIG1",0)) S ^PSRX(PSOLPRX,"SIG")=$P($G(^PSRX(PSOLPRX,0)),"^",10)_"^"_0 S $P(^PSRX(PSOLPRX,0),"^",10)=""
"RTN","PSOUTLA1",72,0)
 ..I $P($G(^PSRX(PSOLPRX,"STA")),"^")="",$P($G(^PSRX(PSOLPRX,0)),"^",15)'="" S $P(^PSRX(PSOLPRX,"STA"),"^")=$P($G(^PSRX(PSOLPRX,0)),"^",15) S $P(^PSRX(PSOLPRX,0),"^",15)=""
"RTN","PSOUTLA1",73,0)
 ..S $P(^PSRX(PSOLPRX,0),"^",19)=1
"RTN","PSOUTLA1",74,0)
 .S PSOLPSTA=$P($G(^PSRX(PSOLPRX,"STA")),"^") Q:PSOLPSTA=""!(PSOLPSTA=13)!(PSOLPSTA=10)
"RTN","PSOUTLA1",75,0)
 .D EN^PSOHLSN1(PSOLPRX,"ZC","")
"RTN","PSOUTLA1",76,0)
 .I PSOLPSTA'="",PSOLPSTA<10 D
"RTN","PSOUTLA1",77,0)
 ..I +$P($G(^PSRX(PSOLPRX,2)),"^",6),+$P($G(^(2)),"^",6)<DT S $P(^PSRX(PSOLPRX,"STA"),"^")=11,PSOLPSTA=11
"RTN","PSOUTLA1",78,0)
 .S PSOLPSTX=$S(PSOLPSTA=3:"OH",PSOLPSTA=16:"OH",PSOLPSTA=12:"OD",PSOLPSTA=15:"OD",PSOLPSTA=14:"OD",1:"SC"),PSOLPSTZ=$S(PSOLPSTA=0:"CM",PSOLPSTA=1:"IP",PSOLPSTA=4:"IP",PSOLPSTA=5:"ZS",PSOLPSTA=11:"ZE",1:"")
"RTN","PSOUTLA1",79,0)
 .D EN^PSOHLSN1(PSOLPRX,PSOLPSTX,PSOLPSTZ,"")
"RTN","PSOUTLA1",80,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOUTLA1",81,0)
PATCHQ Q
"RTN","PSOUTLA1",82,0)
 ;
"RTN","PSOUTLA1",83,0)
 ;PSO*186
"RTN","PSOUTLA1",84,0)
DEACHK(PSIRXN,PSDEA,PSDAYS,PCLOZ,PSOCS,PSMAXRF) ;Apply DEA restrictions
"RTN","PSOUTLA1",85,0)
 ;
"RTN","PSOUTLA1",86,0)
 ; If no refills allowed indicate that and set Max refills to number
"RTN","PSOUTLA1",87,0)
 ; of fills thus far, or if new order, then num of refills will not be
"RTN","PSOUTLA1",88,0)
 ; found and Max refills will be 0.
"RTN","PSOUTLA1",89,0)
 ;
"RTN","PSOUTLA1",90,0)
 ;  Function returns: 1 = no refills allowed
"RTN","PSOUTLA1",91,0)
 ;                    0 = ok to refill
"RTN","PSOUTLA1",92,0)
 ;  Input Variables: PSIRXN = internal RX number or "*"=(new order)
"RTN","PSOUTLA1",93,0)
 ;                   PSDEA  = DEA special handling for drug ordered
"RTN","PSOUTLA1",94,0)
 ;                   PSDAYS = Days supply ordered
"RTN","PSOUTLA1",95,0)
 ;                   PCLOZ  = Clozapine patient? (Optional)
"RTN","PSOUTLA1",96,0)
 ; Output Variables: PSOCS  = Controlled sub flag  (Optional)
"RTN","PSOUTLA1",97,0)
 ;                   PSMAXRF= Max Refill allowed by DEA restriction
"RTN","PSOUTLA1",98,0)
 ;                                                 (Optional)
"RTN","PSOUTLA1",99,0)
 ;
"RTN","PSOUTLA1",100,0)
 S PSIRXN=+$G(PSIRXN),PSDEA=$G(PSDEA),PSDAYS=+$G(PSDAYS)
"RTN","PSOUTLA1",101,0)
 S PSOCS=+$G(PSOCS),PSMAXRF=+$G(PSMAXRF),PCLOZ=$G(PCLOZ)
"RTN","PSOUTLA1",102,0)
 ;
"RTN","PSOUTLA1",103,0)
 ;if clozapine patient (passed in 0 or 1),  set max refills and quit
"RTN","PSOUTLA1",104,0)
 I PCLOZ=0 S PSMAXRF=0 Q 1
"RTN","PSOUTLA1",105,0)
 I PCLOZ=1 S PSMAXRF=1 Q 0
"RTN","PSOUTLA1",106,0)
 ;
"RTN","PSOUTLA1",107,0)
 ;no refills if PSDEA = 'A' & not 'B' or 'F',
"RTN","PSOUTLA1",108,0)
 I (PSDEA["A")&(PSDEA'["B")!(PSDEA["F") D  Q 1
"RTN","PSOUTLA1",109,0)
 . S PSMAXRF=$$NUMFILLS(PSIRXN)
"RTN","PSOUTLA1",110,0)
 ;
"RTN","PSOUTLA1",111,0)
 N QQ
"RTN","PSOUTLA1",112,0)
 F QQ=1:1 Q:$E(PSDEA,QQ)=""  I $E(+PSDEA,QQ)>1,$E(+PSDEA,QQ)<6 D
"RTN","PSOUTLA1",113,0)
 . S PSOCS=1
"RTN","PSOUTLA1",114,0)
 . S:$E(+PSDEA,QQ)=2 $P(PSOCS,"^",2)=1
"RTN","PSOUTLA1",115,0)
 ;
"RTN","PSOUTLA1",116,0)
 ;no refills allowed on sched 2
"RTN","PSOUTLA1",117,0)
 I $P(PSOCS,"^",2)=1 S PSMAXRF=$$NUMFILLS(PSIRXN) Q 1
"RTN","PSOUTLA1",118,0)
 ;
"RTN","PSOUTLA1",119,0)
 ;set max refill for controlled substance & other based on days supply
"RTN","PSOUTLA1",120,0)
 S PSDAYS=+$G(PSDAYS)
"RTN","PSOUTLA1",121,0)
 I PSOCS D
"RTN","PSOUTLA1",122,0)
 . S PSMAXRF=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0)
"RTN","PSOUTLA1",123,0)
 E  D
"RTN","PSOUTLA1",124,0)
 . S PSMAXRF=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0)
"RTN","PSOUTLA1",125,0)
 ;
"RTN","PSOUTLA1",126,0)
 ;get number of fills if applies & compare to Max refills
"RTN","PSOUTLA1",127,0)
 N PNFILLS S PNFILLS=$$NUMFILLS(PSIRXN)
"RTN","PSOUTLA1",128,0)
 I PNFILLS'<PSMAXRF S PSMAXRF=PNFILLS Q 1
"RTN","PSOUTLA1",129,0)
 ;
"RTN","PSOUTLA1",130,0)
 Q 0
"RTN","PSOUTLA1",131,0)
 ;
"RTN","PSOUTLA1",132,0)
NUMFILLS(PSIRXN) ;Return number of fills thus far, or 0 if doesn't apply
"RTN","PSOUTLA1",133,0)
 ; function returns: if   Active drug, then number of refills thus far
"RTN","PSOUTLA1",134,0)
 ;                   else return 0 for does not apply
"RTN","PSOUTLA1",135,0)
 ;  Input Variables: PSIRXN = internal RX number (Optional)
"RTN","PSOUTLA1",136,0)
 Q:'$G(PSIRXN) 0
"RTN","PSOUTLA1",137,0)
 N RFN,RFNC
"RTN","PSOUTLA1",138,0)
 S (RFN,RFNC)=0
"RTN","PSOUTLA1",139,0)
 F  S RFN=$O(^PSRX(PSIRXN,1,RFN)) Q:'RFN  S RFNC=RFNC+1
"RTN","PSOUTLA1",140,0)
 Q RFNC
"VER")
8.0^22.0
**END**
**END**
