Released IBD*3*23 SEQ #34
Extracted from mail message
**KIDS**:IBD*3.0*23^

**INSTALL NAME**
IBD*3.0*23
"BLD",910,0)
IBD*3.0*23^AUTOMATED INFO COLLECTION SYS^0^3010214^y
"BLD",910,1,0)
^^1^1^3010209^
"BLD",910,1,1,0)
Fixes problems with 2nd and 3rd diagnosis codes.
"BLD",910,4,0)
^9.64PA^^
"BLD",910,"KRN",0)
^9.67PA^19^18
"BLD",910,"KRN",.4,0)
.4
"BLD",910,"KRN",.401,0)
.401
"BLD",910,"KRN",.402,0)
.402
"BLD",910,"KRN",.403,0)
.403
"BLD",910,"KRN",.5,0)
.5
"BLD",910,"KRN",.84,0)
.84
"BLD",910,"KRN",3.6,0)
3.6
"BLD",910,"KRN",3.8,0)
3.8
"BLD",910,"KRN",9.2,0)
9.2
"BLD",910,"KRN",9.8,0)
9.8
"BLD",910,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",910,"KRN",9.8,"NM",1,0)
IBDFDE21^^0^B84112928
"BLD",910,"KRN",9.8,"NM",2,0)
IBDF18E0^^0^B40950973
"BLD",910,"KRN",9.8,"NM",3,0)
IBDFUTL1^^0^B51320678
"BLD",910,"KRN",9.8,"NM",4,0)
IBDFRPC^^0^B35870042
"BLD",910,"KRN",9.8,"NM","B","IBDF18E0",2)
 
"BLD",910,"KRN",9.8,"NM","B","IBDFDE21",1)
 
"BLD",910,"KRN",9.8,"NM","B","IBDFRPC",4)
 
"BLD",910,"KRN",9.8,"NM","B","IBDFUTL1",3)
 
"BLD",910,"KRN",19,0)
19
"BLD",910,"KRN",19.1,0)
19.1
"BLD",910,"KRN",101,0)
101
"BLD",910,"KRN",409.61,0)
409.61
"BLD",910,"KRN",771,0)
771
"BLD",910,"KRN",869.2,0)
869.2
"BLD",910,"KRN",870,0)
870
"BLD",910,"KRN",8994,0)
8994
"BLD",910,"KRN","B",.4,.4)
 
"BLD",910,"KRN","B",.401,.401)
 
"BLD",910,"KRN","B",.402,.402)
 
"BLD",910,"KRN","B",.403,.403)
 
"BLD",910,"KRN","B",.5,.5)
 
"BLD",910,"KRN","B",.84,.84)
 
"BLD",910,"KRN","B",3.6,3.6)
 
"BLD",910,"KRN","B",3.8,3.8)
 
"BLD",910,"KRN","B",9.2,9.2)
 
"BLD",910,"KRN","B",9.8,9.8)
 
"BLD",910,"KRN","B",19,19)
 
"BLD",910,"KRN","B",19.1,19.1)
 
"BLD",910,"KRN","B",101,101)
 
"BLD",910,"KRN","B",409.61,409.61)
 
"BLD",910,"KRN","B",771,771)
 
"BLD",910,"KRN","B",869.2,869.2)
 
"BLD",910,"KRN","B",870,870)
 
"BLD",910,"KRN","B",8994,8994)
 
"BLD",910,"PRE")
 
"BLD",910,"QUES",0)
^9.62^^
"BLD",910,"REQB",0)
^9.611^6^3
"BLD",910,"REQB",4,0)
IBD*3.0*36^1
"BLD",910,"REQB",5,0)
IBD*3.0*32^1
"BLD",910,"REQB",6,0)
IBD*3.0*1^1
"BLD",910,"REQB","B","IBD*3.0*1",6)
 
"BLD",910,"REQB","B","IBD*3.0*32",5)
 
"BLD",910,"REQB","B","IBD*3.0*36",4)
 
"MBREQ")
0
"PKG",421,-1)
1^1
"PKG",421,0)
AUTOMATED INFO COLLECTION SYS^IBD^The utilities for generating a paper encounter form.
"PKG",421,20,0)
^9.402P^^
"PKG",421,22,0)
^9.49I^1^1
"PKG",421,22,1,0)
3.0^2970212^2970424^1258
"PKG",421,22,1,"PAH",1,0)
23^3010214
"PKG",421,22,1,"PAH",1,1,0)
^^1^1^3010214
"PKG",421,22,1,"PAH",1,1,1,0)
Fixes problems with 2nd and 3rd diagnosis codes.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","IBDF18E0")
0^2^B40950973
"RTN","IBDF18E0",1,0)
IBDF18E0 ;ALB/CJM - ENCOUNTER FORM - PCE DEVICE INTERFACE utilities ;04-OCT-94
"RTN","IBDF18E0",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**11,25,38,36,23**;APR 24, 1997
"RTN","IBDF18E0",3,0)
 ;
"RTN","IBDF18E0",4,0)
SETPXCA ;set values from TEMP() into the PXCA()
"RTN","IBDF18E0",5,0)
 ;
"RTN","IBDF18E0",6,0)
 N NODE,NUMBER,IBQUIT,Y,Y1,X
"RTN","IBDF18E0",7,0)
 S PROVIDER=+$P(PXCA("ENCOUNTER"),"^",4)
"RTN","IBDF18E0",8,0)
 I PROVIDER,"^P^S^"'[("^"_$P(PXCA("ENCOUNTER"),"^",15)_"^") S $P(PXCA("ENCOUNTER"),"^",15)="S" D LOGERR^IBDF18E2(3579603,.FORMID,"",PROVIDER)
"RTN","IBDF18E0",9,0)
 ;
"RTN","IBDF18E0",10,0)
 S NODE="" F  S NODE=$O(TEMP(NODE)) Q:NODE=""  S NUMBER=0,FID="" F  S FID=$O(TEMP(NODE,FID)) Q:FID=""  S ITEM="" F  S ITEM=$O(TEMP(NODE,FID,ITEM)) Q:ITEM=""  D
"RTN","IBDF18E0",11,0)
 .S IBQUIT=0
"RTN","IBDF18E0",12,0)
 .I NODE="PROCEDURE" S X=TEMP(NODE,FID,ITEM) D
"RTN","IBDF18E0",13,0)
 ..I $P(X,"^",2)="" S $P(X,"^",2)=1
"RTN","IBDF18E0",14,0)
 ..S Y=0 F  S Y=$O(PXCA(NODE,PROVIDER,Y)) Q:'Y!(IBQUIT)  D
"RTN","IBDF18E0",15,0)
 ...S Y1=$G(PXCA(NODE,PROVIDER,Y))
"RTN","IBDF18E0",16,0)
 ...I $P(X,"^")=$P(Y1,"^"),$P(X,"^",3,7)=$P(Y1,"^",3,7) S $P(PXCA(NODE,PROVIDER,Y),"^",2)=$P(PXCA(NODE,PROVIDER,Y),"^",2)+$P(X,"^",2),IBQUIT=1
"RTN","IBDF18E0",17,0)
 ..Q:IBQUIT
"RTN","IBDF18E0",18,0)
 ..S TEMP(NODE,FID,ITEM)=X
"RTN","IBDF18E0",19,0)
 .I IBQUIT K TEMP(NODE,FID,ITEM) Q
"RTN","IBDF18E0",20,0)
 .S NUMBER=NUMBER+1
"RTN","IBDF18E0",21,0)
 .S PXCA(NODE,PROVIDER,NUMBER)=TEMP(NODE,FID,ITEM)
"RTN","IBDF18E0",22,0)
 .I $D(TEMP(NODE,FID,ITEM,"MODIFIER")) D MODPXCA
"RTN","IBDF18E0",23,0)
 .K TEMP(NODE,FID,ITEM)
"RTN","IBDF18E0",24,0)
 ;
"RTN","IBDF18E0",25,0)
 ; -- default c/o date time to now if not passed
"RTN","IBDF18E0",26,0)
 I '$P($G(^IBD(357.09,1,1)),"^",2) D  ;cont only if s/p not answerred
"RTN","IBDF18E0",27,0)
 .I $D(PXCA("ENCOUNTER")) I $P(PXCA("ENCOUNTER"),"^",14)="" D  ;quit if we are already passing c/o date/time
"RTN","IBDF18E0",28,0)
 ..N SDOE S SDOE=$$FNDSDOE^IBDFDE($S(+$G(FORMID("DFN")):+$G(FORMID("DFN")),+$G(IBDF("DFN")):+$G(IBDF("DFN")),1:$G(DFN)),$S(+$G(FORMID("APPT")):+$G(FORMID("APPT")),+$G(IBDF("APPT")):+$G(IBDF("APPT")),1:$G(APPT)))
"RTN","IBDF18E0",29,0)
 ..Q:$$COMDT^SDCOU(+SDOE)  ;c/o already performed, don't overwrite
"RTN","IBDF18E0",30,0)
 ..N IBDDFN,IBDAPPT,IBDCLN,IBDCOST
"RTN","IBDF18E0",31,0)
 ..S IBDDFN=$S(+$G(FORMID("DFN")):+$G(FORMID("DFN")),+$G(IBDF("DFN")):+$G(IBDF("DFN")),1:$G(DFN))
"RTN","IBDF18E0",32,0)
 ..S IBDAPPT=$S(+$G(FORMID("APPT")):+$G(FORMID("APPT")),+$G(IBDF("APPT")):+$G(IBDF("APPT")),1:$G(APPT))
"RTN","IBDF18E0",33,0)
 ..S IBDCLN=$S(+$G(FORMID("CLINIC")):+$G(FORMID("CLINIC")),+$G(IBDF("CLINIC")):+$G(IBDF("CLINIC")),1:$G(CLN))
"RTN","IBDF18E0",34,0)
 ..S IBDCOST=$$STATUS^SDAM1(IBDDFN,IBDAPPT,IBDCLN,$G(^DPT(IBDDFN,0))) Q:$P(IBDCOST,";",5)
"RTN","IBDF18E0",35,0)
 ..S $P(PXCA("ENCOUNTER"),"^",14)=$E($$HTFM^XLFDT($H),1,12)
"RTN","IBDF18E0",36,0)
 ;
"RTN","IBDF18E0",37,0)
 D OTHRBUB
"RTN","IBDF18E0",38,0)
 Q
"RTN","IBDF18E0",39,0)
 ;
"RTN","IBDF18E0",40,0)
 ;
"RTN","IBDF18E0",41,0)
OTHRBUB ; -- check procedure and diagnosis node for other bubble, but no data
"RTN","IBDF18E0",42,0)
 N NODE,CODE
"RTN","IBDF18E0",43,0)
 S I=0 F  S I=$O(PXCA("PROCEDURE",I)) Q:I=""  S J=0 F  S J=$O(PXCA("PROCEDURE",I,J)) Q:J=""  D
"RTN","IBDF18E0",44,0)
 .I +$G(PXCA("PROCEDURE",I,J))<1 D  ;no code, may be treatment
"RTN","IBDF18E0",45,0)
 ..I $P($G(PXCA("PROCEDURE",I,J)),"^",6)["OTHER#" D  ;no code, narr=other
"RTN","IBDF18E0",46,0)
 ...D LOGERR^IBDF18E2(3579612,.FORMID)
"RTN","IBDF18E0",47,0)
 ...K PXCA("PROCEDURE",I,J)
"RTN","IBDF18E0",48,0)
 .I +$G(PXCA("PROCEDURE",I,J)),$P($G(PXCA("PROCEDURE",I,J)),"^",6)["OTHER#" D
"RTN","IBDF18E0",49,0)
 ..;; --change to api cpt ; dhh
"RTN","IBDF18E0",50,0)
 ..S CODE=$$CPT^ICPTCOD(CODE)
"RTN","IBDF18E0",51,0)
 ..S $P(PXCA("PROCEDURE",I,J),"^",6)=$S(+CODE'=-1:$E($P((CODE),"^",3),1,80),1:"")
"RTN","IBDF18E0",52,0)
 ;
"RTN","IBDF18E0",53,0)
 S I=0 F  S I=$O(PXCA("DIAGNOSIS/PROBLEM",I)) Q:I=""  S J=0 F  S J=$O(PXCA("DIAGNOSIS/PROBLEM",I,J)) Q:J=""  D
"RTN","IBDF18E0",54,0)
 .I $P($G(PXCA("DIAGNOSIS/PROBLEM",I,J)),"^",13)="" D
"RTN","IBDF18E0",55,0)
 ..S $P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",13)=$E($G(^ICD9(+PXCA("DIAGNOSIS/PROBLEM",I,J),1)),1,79)
"RTN","IBDF18E0",56,0)
 .I $P($G(PXCA("DIAGNOSIS/PROBLEM",I,J)),"^",13)["OTHER#" D
"RTN","IBDF18E0",57,0)
 ..S $P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",13)=$E($G(^ICD9(+PXCA("DIAGNOSIS/PROBLEM",I,J),1)),1,79)
"RTN","IBDF18E0",58,0)
 Q
"RTN","IBDF18E0",59,0)
 ;
"RTN","IBDF18E0",60,0)
PRO ; -- make sure diagnosis code is added to DIAGNOSIS/PROBLEM node
"RTN","IBDF18E0",61,0)
 S I=0 F  S I=$O(PXCA("DIAGNOSIS/PROBLEM",I)) Q:I=""  S J=0 F  S J=$O(PXCA("DIAGNOSIS/PROBLEM",I,J)) Q:J=""  D
"RTN","IBDF18E0",62,0)
 .I $TR($P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",5,8),"^","")']"",($P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",2)="") S $P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",2)="S" D
"RTN","IBDF18E0",63,0)
 ..D LOGERR^IBDF18E2(3579505,.FORMID,"",+PXCA("DIAGNOSIS/PROBLEM",I,J),"","","",$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",13))
"RTN","IBDF18E0",64,0)
 .Q:+$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^")
"RTN","IBDF18E0",65,0)
 .I +$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",3) D
"RTN","IBDF18E0",66,0)
 ..S IBX=$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",3) D
"RTN","IBDF18E0",67,0)
 ...I $D(^LEX)>1 S X="LEXU" X ^%ZOSF("TEST") I $T S IBX=$$ICDONE^LEXU(IBX) S:$L(IBX)<1 IBX=799.9 Q  ; clinical lexicon next version to be in ^LEX
"RTN","IBDF18E0",68,0)
 ...S X="GMPTU" X ^%ZOSF("TEST") I $T S IBX=$$ICDONE^GMPTU(IBX) S:$L(IBX)<1 IBX=799.9 Q
"RTN","IBDF18E0",69,0)
 ...S IBX=799.9
"RTN","IBDF18E0",70,0)
 ...Q
"RTN","IBDF18E0",71,0)
 ..S IBXI=+$O(^ICD9("BA",IBX_" ",0)) I +IBXI<1 S IBXI=+$O(^ICD9("BA",799.9_" ",0))
"RTN","IBDF18E0",72,0)
 ..I +IBXI<1 D LOGERR^IBDF18E2(3579506,.FORMID,"",$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",3),"","","",$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",13)) Q
"RTN","IBDF18E0",73,0)
 ..S $P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^")=IBXI
"RTN","IBDF18E0",74,0)
 ..Q
"RTN","IBDF18E0",75,0)
 .;
"RTN","IBDF18E0",76,0)
 .; -- set diagnosis code from problem list into piece 1 of array
"RTN","IBDF18E0",77,0)
 .I +$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",4) S $P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^")=$$PROBDIA^IBDFBK3(+$P(PXCA("DIAGNOSIS/PROBLEM",I,J),"^",4))
"RTN","IBDF18E0",78,0)
 Q
"RTN","IBDF18E0",79,0)
 ;
"RTN","IBDF18E0",80,0)
CODES ; -- if addt'l codes to pass and qual is prim or sec, send 2nd code
"RTN","IBDF18E0",81,0)
 N VALUE,IBI,OQLFR
"RTN","IBDF18E0",82,0)
 S OQLFR=QLFR
"RTN","IBDF18E0",83,0)
 Q:$G(QLFR)']""
"RTN","IBDF18E0",84,0)
 Q:"PRIMARYSECONDARYADD TO PROBLEM LIST"'[$P($G(^IBD(357.98,QLFR,0)),"^")
"RTN","IBDF18E0",85,0)
 F IBI=3,4 S VALUE=$P($G(^IBD(357.95,FORMTYPE,1,BUB,2)),"^",IBI) Q:'$G(VALUE)  D
"RTN","IBDF18E0",86,0)
 .N QLFR,TEXT,X,Y
"RTN","IBDF18E0",87,0)
 .D
"RTN","IBDF18E0",88,0)
 ..S X=VALUE
"RTN","IBDF18E0",89,0)
 ..I $G(^ICD9($G(X),0))="" K X S Y="" Q
"RTN","IBDF18E0",90,0)
 ..E  S Y=$P(^ICD9(X,0),"^",3)
"RTN","IBDF18E0",91,0)
 .S TEXT=Y
"RTN","IBDF18E0",92,0)
 .S QLFR=$O(^IBD(357.98,"B",$S($E(OQLFR)="S":"SECONDARY",1:"ADD TO PROBLEM LIST"),0))
"RTN","IBDF18E0",93,0)
 .S ITEM=ITEM_"."_IBI
"RTN","IBDF18E0",94,0)
 .D SETTEMP^IBDF18E1
"RTN","IBDF18E0",95,0)
 .S ITEM=$P(ITEM,".")
"RTN","IBDF18E0",96,0)
 Q
"RTN","IBDF18E0",97,0)
 ;
"RTN","IBDF18E0",98,0)
TRACKING(FORMID) ;get form tracking info,sets FORMID array, which should be passed by reference, return 0 if not found
"RTN","IBDF18E0",99,0)
 ;
"RTN","IBDF18E0",100,0)
 S NODE=$G(^IBD(357.96,FORMID,0))
"RTN","IBDF18E0",101,0)
 Q:NODE="" 0
"RTN","IBDF18E0",102,0)
 S FORMID("APPT")=$P(NODE,"^",3),FORMID("CLINIC")=$P(NODE,"^",10),FORMID("DFN")=$P(NODE,"^",2),FORMID("SOURCE")=$P(NODE,"^",7)
"RTN","IBDF18E0",103,0)
 Q 1
"RTN","IBDF18E0",104,0)
 ;
"RTN","IBDF18E0",105,0)
SC ; -- if SC answered yes then all other classifications = null
"RTN","IBDF18E0",106,0)
 I $P(PXCA("ENCOUNTER"),"^",6) S $P(PXCA("ENCOUNTER"),"^",7,9)="^^"
"RTN","IBDF18E0",107,0)
 ;
"RTN","IBDF18E0",108,0)
 ; - If 'no classifications' was bubbled in then all other
"RTN","IBDF18E0",109,0)
 ;   classifications = null
"RTN","IBDF18E0",110,0)
 I $P($G(PXCA("IBD NOCLASSIFICATION")),"^",3) S $P(PXCA("ENCOUNTER"),"^",6,10)="^^^^"
"RTN","IBDF18E0",111,0)
 Q
"RTN","IBDF18E0",112,0)
 ;
"RTN","IBDF18E0",113,0)
INPT(DFN,APPT) ; -- determine inpatient status
"RTN","IBDF18E0",114,0)
 N INPT
"RTN","IBDF18E0",115,0)
 S INPT=$P($G(^DPT(+$G(DFN),"S",+$G(APPT),0)),"^",2)="I"
"RTN","IBDF18E0",116,0)
 Q:'INPT
"RTN","IBDF18E0",117,0)
 ;
"RTN","IBDF18E0",118,0)
 ; -- kill erroneous warnings for inpatients
"RTN","IBDF18E0",119,0)
 I $G(PXCA("WARNING","ENCOUNTER",0,0,6))["SC flag is missing" K PXCA("WARNING","ENCOUNTER",0,0,6)
"RTN","IBDF18E0",120,0)
 I $G(PXCA("WARNING","ENCOUNTER",0,0,7))["AO flag is missing" K PXCA("WARNING","ENCOUNTER",0,0,7)
"RTN","IBDF18E0",121,0)
 I $G(PXCA("WARNING","ENCOUNTER",0,0,8))["IR flag is missing" K PXCA("WARNING","ENCOUNTER",0,0,8)
"RTN","IBDF18E0",122,0)
 I $G(PXCA("WARNING","ENCOUNTER",0,0,9))["EC flag is missing" K PXCA("WARNING","ENCOUNTER",0,0,9)
"RTN","IBDF18E0",123,0)
 Q
"RTN","IBDF18E0",124,0)
MODPXCA ; -- copy CPT Modifier information from TEMP to PXCA
"RTN","IBDF18E0",125,0)
 ;
"RTN","IBDF18E0",126,0)
 N MOD,MODX,MODNODE,CODE
"RTN","IBDF18E0",127,0)
 S CODE=$P($G(TEMP(NODE,FID,ITEM)),"^")
"RTN","IBDF18E0",128,0)
 S MOD=0 F  S MOD=$O(TEMP(NODE,FID,ITEM,"MODIFIER",MOD)) Q:MOD']""  D
"RTN","IBDF18E0",129,0)
 . S MODX=TEMP(NODE,FID,ITEM,"MODIFIER",MOD)
"RTN","IBDF18E0",130,0)
 . S MODNODE=$$MODP^ICPTMOD(CODE,MODX)
"RTN","IBDF18E0",131,0)
 . S:+MODNODE>0 PXCA(NODE,PROVIDER,NUMBER,MODX)=$$MOD^ICPTMOD(+MODNODE,"I")
"RTN","IBDF18E0",132,0)
 Q
"RTN","IBDF18E0",133,0)
VSTPXCA ; -- copy CPT Modifier information from TEMP to PXCA for Visit
"RTN","IBDF18E0",134,0)
 ;
"RTN","IBDF18E0",135,0)
 N I,J,MOD,MODX
"RTN","IBDF18E0",136,0)
 S I=0 F  S I=$O(TEMP("ENCOUNTER",I)) Q:I']""  D
"RTN","IBDF18E0",137,0)
 . S J=0 F  S J=$O(TEMP("ENCOUNTER",I,J)) Q:'J  D
"RTN","IBDF18E0",138,0)
 .. S MOD=0 F  S MOD=$O(TEMP("ENCOUNTER",I,J,"MODIFIER",MOD)) Q:MOD']""  D
"RTN","IBDF18E0",139,0)
 ... S MODX=TEMP("ENCOUNTER",I,J,"MODIFIER",MOD)
"RTN","IBDF18E0",140,0)
 ... S PXCA("ENCOUNTER","MODIFIER",MODX)=""
"RTN","IBDF18E0",141,0)
 K TEMP("ENCOUNTER")
"RTN","IBDF18E0",142,0)
 Q
"RTN","IBDFDE21")
0^1^B84112928
"RTN","IBDFDE21",1,0)
IBDFDE21 ;ALB/AAS - AICS Data Entry, process selection lists ; 11/22/99 4:35pm
"RTN","IBDFDE21",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**4,38,23**;APR 24, 1997
"RTN","IBDFDE21",3,0)
 ;
"RTN","IBDFDE21",4,0)
% G ^IBDFDE
"RTN","IBDFDE21",5,0)
 ;
"RTN","IBDFDE21",6,0)
SEL(SEL) ; -- Build results array
"RTN","IBDFDE21",7,0)
 N IBDX,DSPTXT,IBQUIT,IBDQL,QCNT,IBDQLFR
"RTN","IBDFDE21",8,0)
 S IBQUIT=0
"RTN","IBDFDE21",9,0)
 ;
"RTN","IBDFDE21",10,0)
 S IBDQL=$$QLFR(.RULE,.QLFR)
"RTN","IBDFDE21",11,0)
 Q:IBQUIT!(IBDQL="^")
"RTN","IBDFDE21",12,0)
 S IBDQLFR=$P(IBDQL,"^",1) D SEL1
"RTN","IBDFDE21",13,0)
 ;
"RTN","IBDFDE21",14,0)
 F QCNT=2:1 S IBDQLFR=$P(IBDQL,"^",QCNT) Q:IBDQLFR=""  D SEL1
"RTN","IBDFDE21",15,0)
 Q
"RTN","IBDFDE21",16,0)
 ;
"RTN","IBDFDE21",17,0)
SEL1 ; -- build selections
"RTN","IBDFDE21",18,0)
 S IBDX=$G(RESULT(0))+1,RESULT(0)=IBDX
"RTN","IBDFDE21",19,0)
 I +SEL=SEL S CHOICE=$$CHOICE^IBDFDE2(SEL)
"RTN","IBDFDE21",20,0)
 I +SEL'=SEL S CHOICE=SEL
"RTN","IBDFDE21",21,0)
 S DISPTXT=$S($P(CHOICE,"^",5)="":$P(CHOICE,"^"),1:$P(CHOICE,"^",5))
"RTN","IBDFDE21",22,0)
 W:+$G(QCNT)<2 "  ",DISPTXT,"   ",$S($P(CHOICE,"^",2)'="":$P(CHOICE,"^",2),$P($G(^IBE(357.6,IBDF("PI"),0)),"^")="GMP INPUT CLINIC COMMON PROBLEMS":$$LEX^IBDFDE1($P(CHOICE,"^",3)),1:$P(CHOICE,"^",3)),"   ",$P(CHOICE,"^",8)_"   ",$P(CHOICE,"^",4)
"RTN","IBDFDE21",23,0)
 ;
"RTN","IBDFDE21",24,0)
 S RESULT(IBDX)=IBDF("PI")_"^"_$P(CHOICE,"^",3)_"^"_DISPTXT_"^"_$P(CHOICE,"^",8)_"^"_$P(CHOICE,"^",6)_"^"_IBDQLFR_"^"_$G(IBDF("IEN"))_"^^"_$P(CHOICE,"^",9)_"^"_$P(CHOICE,"^",2)_"^^"_$P(CHOICE,"^",12)
"RTN","IBDFDE21",25,0)
 S IBDPI(IBDF("PI"),IBDX)=RESULT(IBDX)
"RTN","IBDFDE21",26,0)
 ;
"RTN","IBDFDE21",27,0)
 ; --validate code for active problem list
"RTN","IBDFDE21",28,0)
 I $P($G(^IBE(357.6,IBDF("PI"),0)),"^")="PX INPUT PATIENT ACTIVE PROBLEM" D
"RTN","IBDFDE21",29,0)
 .N X S X=$P(CHOICE,"^",2) Q:X=""
"RTN","IBDFDE21",30,0)
 .I X=799.9 W !,$C(7),IOINHI,"Warning: The ICD9 Diagnosis associated with this problem needs to be updated!",IOINORM Q
"RTN","IBDFDE21",31,0)
 .D TESTICD^IBDFN7
"RTN","IBDFDE21",32,0)
 .I '$D(X) W !,$C(7),IOINHI,"Warning: The ICD9 code associated with this problem is inactive.",IOINORM
"RTN","IBDFDE21",33,0)
 .;I $D(X) W !,"This is a valid icd9 code"
"RTN","IBDFDE21",34,0)
 ;
"RTN","IBDFDE21",35,0)
 ; -- send second and third codes if applicable
"RTN","IBDFDE21",36,0)
 Q:"PRIMARYSECONDARYADD TO PROBLEM LIST"'[IBDQLFR
"RTN","IBDFDE21",37,0)
 N IBDQUAL
"RTN","IBDFDE21",38,0)
 S IBDQUAL=$S(IBDQLFR="PRIMARY":"SECONDARY",1:IBDQLFR)
"RTN","IBDFDE21",39,0)
 N I,IBDXCD,DISPTXT F I=10,11 I $P(CHOICE,"^",I)]"" D
"RTN","IBDFDE21",40,0)
 .S IBDX=$G(RESULT(0))+1,RESULT(0)=IBDX
"RTN","IBDFDE21",41,0)
 .S IBDXCD=$P(CHOICE,"^",I)
"RTN","IBDFDE21",42,0)
 .N X,Y S X=IBDXCD
"RTN","IBDFDE21",43,0)
 .D
"RTN","IBDFDE21",44,0)
 ..I $G(X)="" K X S Y="" Q
"RTN","IBDFDE21",45,0)
 ..S:$E(X,$L(X))'=" " X=X_" " ; use ba xref, add space to end for lookup.
"RTN","IBDFDE21",46,0)
 ..S X=$O(^ICD9("BA",X,0))
"RTN","IBDFDE21",47,0)
 ..I 'X S Y=""
"RTN","IBDFDE21",48,0)
 ..E  S Y=$P(^ICD9(X,0),"^",3)
"RTN","IBDFDE21",49,0)
 .S DISPTXT=Y
"RTN","IBDFDE21",50,0)
 .S RESULT(IBDX)=IBDF("PI")_"^"_IBDXCD_"^"_DISPTXT_"^"_$P(CHOICE,"^",8)_"^"_$P(CHOICE,"^",6)_"^"_IBDQUAL_"^"_$G(IBDF("IEN"))_"^^"_$P(CHOICE,"^",9)
"RTN","IBDFDE21",51,0)
 .S IBDPI(IBDF("PI"),IBDX)=RESULT(IBDX)
"RTN","IBDFDE21",52,0)
 ; 
"RTN","IBDFDE21",53,0)
 ; -- if ans contains - go to modifier routine
"RTN","IBDFDE21",54,0)
 I IBDASK="CPT Procedure Code" D MOD^IBDFDE23
"RTN","IBDFDE21",55,0)
 I IBDASK="Visit Type (EM) Code" D MOD^IBDFDE23
"RTN","IBDFDE21",56,0)
 Q
"RTN","IBDFDE21",57,0)
 ;
"RTN","IBDFDE21",58,0)
QLFR(RULE,QLFR) ; -- ask Qualifier from array, impose rules
"RTN","IBDFDE21",59,0)
 N I,X,IBDQ,IBDQ1,QCNT,CNT,ANS,IBDI,OVER,X1,X2,NUM
"RTN","IBDFDE21",60,0)
 S IBDQ="",CNT=0
"RTN","IBDFDE21",61,0)
 ;
"RTN","IBDFDE21",62,0)
 ; -- if only 1 qualifier use it
"RTN","IBDFDE21",63,0)
 I RULE=1 S IBDQ=$G(QLFR(+$O(QLFR(0)))) W "  ",IBDQ G QLFRQ
"RTN","IBDFDE21",64,0)
 ;
"RTN","IBDFDE21",65,0)
 S IBDI=0
"RTN","IBDFDE21",66,0)
 F  S IBDI=$O(QLFR(IBDI)) Q:'IBDI  S X=$G(QLFR(IBDI)) I X'="" D
"RTN","IBDFDE21",67,0)
 .S CNT=CNT+1,X(CNT)=X,X2(X)=X
"RTN","IBDFDE21",68,0)
 .I '$D(X1($E(X),1)) S X1($E(X),1)=X Q
"RTN","IBDFDE21",69,0)
 .S NUM=$O(X1($E(X),""),-1) S X1($E(X),NUM+1)=X
"RTN","IBDFDE21",70,0)
 I CNT=1 S IBDQ=$G(X(CNT)) W "  ",IBDQ G QLFRQ
"RTN","IBDFDE21",71,0)
 ;
"RTN","IBDFDE21",72,0)
 I $D(IBNAQLFR) S ANS=1 S IBDQ=X(ANS)  W !,IOINHI,"Using Default Qualifier: "_X(ANS),IOINORM,! Q IBDQ
"RTN","IBDFDE21",73,0)
OVER1 ;
"RTN","IBDFDE21",74,0)
 I CNT<1 G QLFRQ
"RTN","IBDFDE21",75,0)
 W !,IOINHI,"   Select a Qualifier",IOINORM
"RTN","IBDFDE21",76,0)
 I CNT>1 F I=1:1:CNT I X(I)'="" W !?6,I,?10,X(I)
"RTN","IBDFDE21",77,0)
 W !,"   Choose 1-",CNT,": " R ANS:DTIME
"RTN","IBDFDE21",78,0)
 I '$T!($E(ANS,1)="^") S IBDQ="",IBQUIT=1 G QLFRQ
"RTN","IBDFDE21",79,0)
 I ANS="" G OVER1
"RTN","IBDFDE21",80,0)
 S OVER=0
"RTN","IBDFDE21",81,0)
 I $E(ANS,1)="?" D HELP G OVER1
"RTN","IBDFDE21",82,0)
 I ANS=+ANS D  G:OVER OVER1
"RTN","IBDFDE21",83,0)
 .I ANS<1!(ANS>CNT) S OVER=1 Q
"RTN","IBDFDE21",84,0)
 .I $G(X(ANS))="" S OVER=1 Q
"RTN","IBDFDE21",85,0)
 .S IBDQ=X(ANS) W "  ",X(ANS)
"RTN","IBDFDE21",86,0)
 .W !
"RTN","IBDFDE21",87,0)
 I ANS'=+ANS D  G:OVER OVER1
"RTN","IBDFDE21",88,0)
 .S ANS1=ANS,QCNT=0,IBDQ1=""
"RTN","IBDFDE21",89,0)
 .F IBD=1:1 S ANS=$P(ANS1,",",IBD) Q:ANS=""!OVER  D ONEQLFR I 'OVER,IBDQ'="" S QCNT=QCNT+1,$P(IBDQ1,"^",QCNT)=IBDQ
"RTN","IBDFDE21",90,0)
 .S IBDQ=IBDQ1
"RTN","IBDFDE21",91,0)
 .K QCNT,IBDQ1
"RTN","IBDFDE21",92,0)
 ;
"RTN","IBDFDE21",93,0)
QLFRQ Q IBDQ
"RTN","IBDFDE21",94,0)
 ;
"RTN","IBDFDE21",95,0)
ONEQLFR ; -- parse qualifiers
"RTN","IBDFDE21",96,0)
 S ANS=$$UP^XLFSTR(ANS)
"RTN","IBDFDE21",97,0)
 I +ANS=ANS D  Q
"RTN","IBDFDE21",98,0)
 .I $G(X(ANS))="" W !,"'"_ANS_"' IS NOT A VALID SELECTION, RE-ENTER" S OVER=1 Q
"RTN","IBDFDE21",99,0)
 .S IBDQ=X(ANS) W "  ",X(ANS)
"RTN","IBDFDE21",100,0)
 ;
"RTN","IBDFDE21",101,0)
 I $L(ANS)=1,$G(X1(ANS,1))'="",$O(X1(ANS,1))="" S IBDQ=X1(ANS,1) W:ANS=ANS1 $E(X1(ANS,1),2,99) W:ANS'=ANS1 "  ",X1(ANS,1) Q
"RTN","IBDFDE21",102,0)
 I $G(X2(ANS))'="" S IBDQ=X2(ANS) W "  ",X2(ANS) Q
"RTN","IBDFDE21",103,0)
 I $L(ANS)=1,$G(X1(ANS,1))'="",$O(X1(ANS,1)) S OVER=1 W "  Ambiguous answer, enter the number." Q  ;S IBDQ=$$PARTLST("X1",ANS,ANS) W $E(X1(ANS,1),2,99) Q
"RTN","IBDFDE21",104,0)
 S OVER=1
"RTN","IBDFDE21",105,0)
 Q
"RTN","IBDFDE21",106,0)
 ;
"RTN","IBDFDE21",107,0)
LST ; -- List previous selections and selections to choose from.
"RTN","IBDFDE21",108,0)
 N I,CNT,IBQUIT,NUM
"RTN","IBDFDE21",109,0)
 ;
"RTN","IBDFDE21",110,0)
 ; -- list previous selections
"RTN","IBDFDE21",111,0)
 D PREVSEL
"RTN","IBDFDE21",112,0)
 ;
"RTN","IBDFDE21",113,0)
 ; -- list available choices
"RTN","IBDFDE21",114,0)
 S (IBQUIT,CNT)=0
"RTN","IBDFDE21",115,0)
 S NUM=+$$CHOICE^IBDFDE2(0)
"RTN","IBDFDE21",116,0)
 W !!,"Choose from: "
"RTN","IBDFDE21",117,0)
 S I=0 F  S I=$O(^TMP("IBD-LST",$J,IBDFMIEN,IBDF("PI"),IBDF("IEN"),I)) Q:'I!(IBQUIT)  D
"RTN","IBDFDE21",118,0)
 .S CHOICE=$$CHOICE^IBDFDE2(I)
"RTN","IBDFDE21",119,0)
 .I '$P(CHOICE,"^",7) W !?16,IOINHI,$P(CHOICE,"^"),IOINORM Q
"RTN","IBDFDE21",120,0)
 .S CNT=CNT+1,NUMBER(CNT)=I
"RTN","IBDFDE21",121,0)
 .W !?3,CNT,?7,$S($P(CHOICE,"^",2)'="":$P(CHOICE,"^",2),1:$P(CHOICE,"^",3)),?16,$P(CHOICE,"^",1)
"RTN","IBDFDE21",122,0)
 .I NUM>15,NUM>I,'(CNT#15) D PAUSE^IBDFDE I 'IBQUIT W $C(13),$J("",55),$C(13)
"RTN","IBDFDE21",123,0)
 .;I NUM>15,CNT'=NUM,'(CNT#15) D READ I $G(LISTSEL)<1!($G(LISTSEL)>CNT) K LISTSEL
"RTN","IBDFDE21",124,0)
 .;I $G(LISTSEL) S SEL=NUMBER(LISTSEL)
"RTN","IBDFDE21",125,0)
 Q
"RTN","IBDFDE21",126,0)
 ;
"RTN","IBDFDE21",127,0)
PREVSEL ; -- List previous selections
"RTN","IBDFDE21",128,0)
 N I,CNT
"RTN","IBDFDE21",129,0)
 S CNT=0
"RTN","IBDFDE21",130,0)
 ;
"RTN","IBDFDE21",131,0)
 ; -- list previous selections
"RTN","IBDFDE21",132,0)
 I $D(IBDPI(IBDF("PI")))>1 S I=0 F  S I=$O(IBDPI(IBDF("PI"),I)) Q:'I  D
"RTN","IBDFDE21",133,0)
 .Q:$P(IBDPI(IBDF("PI"),I),"^",7)'=IBDF("IEN")  ; not the same list
"RTN","IBDFDE21",134,0)
 .S CNT=CNT+1
"RTN","IBDFDE21",135,0)
 .W:CNT=1 !!,IOINHI,"   You have previously selected: ",IOINORM
"RTN","IBDFDE21",136,0)
 .W !,?7,$S($P($G(^IBE(357.6,+IBDPI(IBDF("PI"),I),0)),"^")="GMP INPUT CLINIC COMMON PROBLEMS":$$LEX^IBDFDE1($P(IBDPI(IBDF("PI"),I),"^",2)),1:$P(IBDPI(IBDF("PI"),I),"^",2))
"RTN","IBDFDE21",137,0)
 .W ?16,$P(IBDPI(IBDF("PI"),I),"^",3),?50,$P(IBDPI(IBDF("PI"),I),"^",6)
"RTN","IBDFDE21",138,0)
 W !
"RTN","IBDFDE21",139,0)
 Q
"RTN","IBDFDE21",140,0)
 ;
"RTN","IBDFDE21",141,0)
DEFAULT ; -- compute default answer
"RTN","IBDFDE21",142,0)
 N CNT,SEL,NAME,PIECE,SELAST
"RTN","IBDFDE21",143,0)
 S (CNT,SEL,SELAST)=0
"RTN","IBDFDE21",144,0)
 S NAME=$P($G(^IBE(357.6,+IBDF("PI"),0)),"^")
"RTN","IBDFDE21",145,0)
 S PIECE=$S(NAME["INPUT PROCEDURE CODE":2,NAME["INPUT DIAGNOSIS CODE":2,NAME["INPUT VISIT TYPE":2,1:3)
"RTN","IBDFDE21",146,0)
 F  S SEL=$O(IBDPI(IBDF("PI"),SEL)) Q:'SEL  D
"RTN","IBDFDE21",147,0)
 .Q:$P(IBDPI(IBDF("PI"),SEL),"^",7)'=IBDF("IEN")  ; not the same list
"RTN","IBDFDE21",148,0)
 .S CNT=CNT+1,SELAST=SEL
"RTN","IBDFDE21",149,0)
 I $G(SELAST) S DIR("B")=$P(IBDPI(IBDF("PI"),SELAST),"^",PIECE),IBDEFLT(IBDF("PI"))=DIR("B")
"RTN","IBDFDE21",150,0)
 D PREVSEL
"RTN","IBDFDE21",151,0)
 Q
"RTN","IBDFDE21",152,0)
 ;
"RTN","IBDFDE21",153,0)
DEFPROV ; -- find default provider, not on form
"RTN","IBDFDE21",154,0)
 N SEL,IBDX
"RTN","IBDFDE21",155,0)
 S IBDF("PI")=$O(^IBE(357.6,"B","INPUT PROVIDER",0))
"RTN","IBDFDE21",156,0)
 Q:$D(IBDPI(IBDF("PI")))
"RTN","IBDFDE21",157,0)
 S SEL=$G(IBDF("PROVIDER")) I 'SEL S SEL=$$PRDEF^IBDFRPC3(IBDF("CLINIC"))
"RTN","IBDFDE21",158,0)
 Q:'SEL
"RTN","IBDFDE21",159,0)
 S $P(IBDF("PROVIDER PI"),"^",2)=1 ;flag not on form
"RTN","IBDFDE21",160,0)
 S IBDX=$G(IBDSEL(0))+1,IBDSEL(0)=IBDX
"RTN","IBDFDE21",161,0)
 S IBDSEL(IBDX)=IBDF("PI")_"^"_SEL_"^"_$P($G(^VA(200,+SEL,0)),"^")_"^^^PRIMARY^"
"RTN","IBDFDE21",162,0)
 S IBDPI(IBDF("PI"),IBDX)=IBDSEL(IBDX)
"RTN","IBDFDE21",163,0)
 W:'$G(IBDF("PROVIDER")) !!,"No Provider Block on form.  Using Default Provider from Clinic as Primary.",!
"RTN","IBDFDE21",164,0)
 W:$G(IBDF("PROVIDER")) !!,"Using Provider: "
"RTN","IBDFDE21",165,0)
 W "   ",$P(^VA(200,+SEL,0),"^"),"    PRIMARY",!
"RTN","IBDFDE21",166,0)
 Q
"RTN","IBDFDE21",167,0)
 ;
"RTN","IBDFDE21",168,0)
HELP ; -- 
"RTN","IBDFDE21",169,0)
 W !,"You must choose a data qualifier for this item.  Enter a number from 1-",CNT,!,"Or enter the first letter, or enter the full name.  Enter more than one",!,"qualifier separated by commas (ie 1,2 or P,A).",!
"RTN","IBDFDE21",170,0)
 Q
"RTN","IBDFDE21",171,0)
 ;
"RTN","IBDFDE21",172,0)
OTHER(IBDX) ; -- allow input of an additional item
"RTN","IBDFDE21",173,0)
 N I,J,X,Y,DIR,DIRUT,DUOUT,SEL,SELX,NARR,DIC,DIE,DA,DR,GMPTUN,GMPTSUB,GMPTSHOW,XTLKGLB,XTLKHLP,XTLKKSCH,XTLKSAY,IBDLEX,IBDFILE
"RTN","IBDFDE21",174,0)
 ;
"RTN","IBDFDE21",175,0)
 ; -- strip the cpt code if modifiers are added cpt-mod,mod,mod...
"RTN","IBDFDE21",176,0)
 ;
"RTN","IBDFDE21",177,0)
 I IBDX["-" S IBDX=$P(IBDX,"-")
"RTN","IBDFDE21",178,0)
 I $G(IBDF("LEXICON")) D  Q:'$D(IBDLEX)
"RTN","IBDFDE21",179,0)
 .I $D(^LEX)>1 S X="LEXSET" X ^%ZOSF("TEST") I $T D CONFIG^LEXSET("ICD","ICD") S IBDLEX=1
"RTN","IBDFDE21",180,0)
 .I '$D(IBDLEX) S X="GMPTSET" X ^%ZOSF("TEST") I $T D CONFIG^GMPTSET("GMPL","PL1") S IBDLEX=1
"RTN","IBDFDE21",181,0)
 .;D CONFIG^GMPTSET("ICD","ICD") (this is an alternate filter)
"RTN","IBDFDE21",182,0)
 S SELX=-1
"RTN","IBDFDE21",183,0)
 I '$G(IBDF("OTHER")) G OTHQ
"RTN","IBDFDE21",184,0)
 I $L($G(IBDX)) S X=IBDX S DIC(0)="EQMZ"
"RTN","IBDFDE21",185,0)
 S DIC("A")="Select Other "_$G(IBDASK)
"RTN","IBDFDE21",186,0)
 S DIC=$P(IBDF("OTHER"),"^") I $P(IBDF("OTHER"),"^",2)'="" S DIC("S")=$P(IBDF("OTHER"),"^",2,99)
"RTN","IBDFDE21",187,0)
 D ^DIC G OTHQ:+Y<1
"RTN","IBDFDE21",188,0)
 K DIC
"RTN","IBDFDE21",189,0)
 S SEL=Y
"RTN","IBDFDE21",190,0)
 W !!,$C(7),"WARNING: Item selected not from Encounter Form."
"RTN","IBDFDE21",191,0)
 ;
"RTN","IBDFDE21",192,0)
 I IBDF("PI")=$G(IBDF("PROVIDER PI")) W ! S SELX=$P($G(^VA(200,+Y,0)),"^",1)_"^^"_+Y_"^^^^1" G OTHQ
"RTN","IBDFDE21",193,0)
 ;
"RTN","IBDFDE21",194,0)
 W "...Entry of Narrative Required!",!
"RTN","IBDFDE21",195,0)
 S IBDFILE=+IBDF("OTHER")
"RTN","IBDFDE21",196,0)
 S:IBDFILE=81 DIR("B")=$P(Y(0),"^",2)
"RTN","IBDFDE21",197,0)
 ;S:IBDFILE=80 DIR("B")=$P(Y(0),"^",3)
"RTN","IBDFDE21",198,0)
 S:IBDFILE=80 DIR("B")=$S($L($G(^ICD9(+Y,1)))<81:^ICD9(+Y,1),1:$P(Y(0),"^",3))
"RTN","IBDFDE21",199,0)
 S:IBDFILE=357.69 DIR("B")=$P(Y(0),"^",3)
"RTN","IBDFDE21",200,0)
 I IBDFILE>9999999,IBDFILE<10000000 S DIR("B")=$P(Y(0),"^",1)
"RTN","IBDFDE21",201,0)
 S DIR(0)="FO^3:80",DIR("A")="Narrative" D ^DIR K DIR G:$G(DIRUT) OTHQ
"RTN","IBDFDE21",202,0)
 S NARR=Y
"RTN","IBDFDE21",203,0)
 ;
"RTN","IBDFDE21",204,0)
 S SELX=$S((IBDFILE<9999999)&(IBDFILE'=757.01):NARR_"^^"_$P(SEL,"^",2)_"^^^^1",1:NARR_"^^"_$P(SEL,"^",1)_"^^^^1")
"RTN","IBDFDE21",205,0)
OTHQ Q $S(SELX=-1:"",1:SELX)
"RTN","IBDFDE21",206,0)
 ;
"RTN","IBDFDE21",207,0)
PARTLST(ARY,NEXT,ANS) ; -- input has more than one match, prompt for which one
"RTN","IBDFDE21",208,0)
 N I,J,K,N,IBD,ANS2,SEL,CHOICE
"RTN","IBDFDE21",209,0)
 S SEL=0
"RTN","IBDFDE21",210,0)
 S NEXT=$E(NEXT,1,$L(NEXT)-1)_$C($A($E(NEXT,$L(NEXT)))-1)_"~"
"RTN","IBDFDE21",211,0)
 ;
"RTN","IBDFDE21",212,0)
 S J=0,K=NEXT F  S K=$O(@ARY@(K)) Q:$E(K,1,$L(ANS))'=ANS  D
"RTN","IBDFDE21",213,0)
 .S N=0 F  S N=$O(@ARY@(K,N)) Q:'N  D
"RTN","IBDFDE21",214,0)
 ..S J=J+1,IBD(J)=@ARY@(K,N),CHOICE=$$CHOICE^IBDFDE2(IBD(J))
"RTN","IBDFDE21",215,0)
 ..W !?6,J,?10,$S($P(CHOICE,"^",2)'="":$P(CHOICE,"^",2),1:$P(CHOICE,"^",3)),?20,$P(CHOICE,"^",1),?50,"   ",$P(CHOICE,"^",8),"   ",$P(CHOICE,"^",4)
"RTN","IBDFDE21",216,0)
 ;
"RTN","IBDFDE21",217,0)
ASKNUM I J<1 G PARTLQ
"RTN","IBDFDE21",218,0)
 W !,"   Choose 1-",J,": " R ANS2:DTIME
"RTN","IBDFDE21",219,0)
 I '$T!($E(ANS2,1)="^")!(ANS2="") S SEL="" G PARTLQ
"RTN","IBDFDE21",220,0)
 I $E(ANS2,1)="?" W !,"Enter a number from 1 - ",J G ASKNUM
"RTN","IBDFDE21",221,0)
 S ANS2=+ANS2
"RTN","IBDFDE21",222,0)
 I ANS2<1!(ANS2>J) G ASKNUM
"RTN","IBDFDE21",223,0)
 I $G(IBD(ANS2))="" G ASKNUM
"RTN","IBDFDE21",224,0)
 W !
"RTN","IBDFDE21",225,0)
 S SEL=$G(IBD(ANS2))
"RTN","IBDFDE21",226,0)
PARTLQ Q SEL
"RTN","IBDFDE21",227,0)
 ;
"RTN","IBDFDE21",228,0)
READ ; -- get input from list
"RTN","IBDFDE21",229,0)
 N ANS2
"RTN","IBDFDE21",230,0)
 G:CNT<1 READQ
"RTN","IBDFDE21",231,0)
 W !,"   Choose 1-",CNT,": " R ANS2:DTIME
"RTN","IBDFDE21",232,0)
 I '$T!($E(ANS2,1)="^") S IBQUIT=1 G READQ
"RTN","IBDFDE21",233,0)
 I $E(ANS2,1)="?" W !,"Enter a number from 1 - ",CNT," or return to see more." G READ
"RTN","IBDFDE21",234,0)
 S ANS2=+ANS2
"RTN","IBDFDE21",235,0)
 I ANS2<1!(ANS2>CNT) W $C(7),! G READ
"RTN","IBDFDE21",236,0)
 I $G(NUMBER(CNT))="" G READ
"RTN","IBDFDE21",237,0)
 W !
"RTN","IBDFDE21",238,0)
READQ Q
"RTN","IBDFRPC")
0^4^B35870042
"RTN","IBDFRPC",1,0)
IBDFRPC ;ALB/AAS - AICS Return list of interfaces ; 2-JAN-96
"RTN","IBDFRPC",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**1,23**;APR 24, 1997
"RTN","IBDFRPC",3,0)
 ;
"RTN","IBDFRPC",4,0)
CLNLSTI(RESULT,CLINIC) ; -- Procedure
"RTN","IBDFRPC",5,0)
 ; -- Broker call to return list of data entry elements for a clinic/patient/form
"RTN","IBDFRPC",6,0)
 ;    rpc := IBD GET INPUT OBJECT BY CLINIC
"RTN","IBDFRPC",7,0)
 ;
"RTN","IBDFRPC",8,0)
 ; -- input  CLINIC = pointer to hospital location file or clinic name
"RTN","IBDFRPC",9,0)
 ;           Result = called by reference or use a closed global root
"RTN","IBDFRPC",10,0)
 ;
"RTN","IBDFRPC",11,0)
 ; -- output  The format of the returned array is as follows
"RTN","IBDFRPC",12,0)
 ;        result(0) := count of array elements
"RTN","IBDFRPC",13,0)
 ;        result(n) := $p1 :=  pkg interface name
"RTN","IBDFRPC",14,0)
 ;                     $p2 :=  pkg interface ien
"RTN","IBDFRPC",15,0)
 ;                     $p3 :=  form name
"RTN","IBDFRPC",16,0)
 ;                     $p4 :=  form type
"RTN","IBDFRPC",17,0)
 ;                     $p5 :=  type of input object
"RTN","IBDFRPC",18,0)
 ;                     $p6 :=  input object ien.
"RTN","IBDFRPC",19,0)
 ;                     $P7 :=  Vital Name (vitals only)
"RTN","IBDFRPC",20,0)
 ;                     $p8 :=  manual data entry supported
"RTN","IBDFRPC",21,0)
 ;                     $p9 :=  Block ien
"RTN","IBDFRPC",22,0)
 ;                     $p10 := block row
"RTN","IBDFRPC",23,0)
 ;                     $p11 := block column
"RTN","IBDFRPC",24,0)
 ;
"RTN","IBDFRPC",25,0)
 N I,J,X,Y,CL1,FTYP,IBDX,FRM,CNT
"RTN","IBDFRPC",26,0)
 ;
"RTN","IBDFRPC",27,0)
 I $E($G(RESULT),1)="^" S ARRY=RESULT
"RTN","IBDFRPC",28,0)
 E  S ARRY="RESULT"
"RTN","IBDFRPC",29,0)
 ;
"RTN","IBDFRPC",30,0)
 K @ARRY S @ARRY@(0)="Clinic Not Found"
"RTN","IBDFRPC",31,0)
 I +CLINIC'=CLINIC,CLINIC'="" S CLINIC=+$O(^SC("B",CLINIC,0))
"RTN","IBDFRPC",32,0)
 G:'CLINIC CLNLSTQ
"RTN","IBDFRPC",33,0)
 ;
"RTN","IBDFRPC",34,0)
 ; -- find forms for clinic in clinic set up
"RTN","IBDFRPC",35,0)
 ;    if no form, use default form from parameters
"RTN","IBDFRPC",36,0)
 S CL1=$O(^SD(409.95,"B",CLINIC,0))
"RTN","IBDFRPC",37,0)
 I 'CL1 D  G CLNLSTQ
"RTN","IBDFRPC",38,0)
 .S @ARRY@(0)="No forms for Clinic"
"RTN","IBDFRPC",39,0)
 .S FRM=$$DEFAULT Q:'FRM
"RTN","IBDFRPC",40,0)
 .S @ARRY@(0)="Using Default Form"
"RTN","IBDFRPC",41,0)
 .D FRMLSTI(.RESULT,FRM,11,0)
"RTN","IBDFRPC",42,0)
 ;
"RTN","IBDFRPC",43,0)
 S IBDX=$G(^SD(409.95,CL1,0)) F FTYP=2,3,4,5,6,8,9 I $P(IBDX,"^",FTYP)'="" S FRM=$P(IBDX,"^",FTYP) D FRMLSTI(.RESULT,FRM,FTYP,0)
"RTN","IBDFRPC",44,0)
 ;
"RTN","IBDFRPC",45,0)
CLNLSTQ Q
"RTN","IBDFRPC",46,0)
 ;
"RTN","IBDFRPC",47,0)
FRMLSTI(RESULT,FRM,FTYP,KILL,ALLOBJ) ; -- procedure
"RTN","IBDFRPC",48,0)
 ; -- Broker call to return list of data entry elemets for one form
"RTN","IBDFRPC",49,0)
 ;    rpc := IBD GET INPUT OBJECT BY FORM
"RTN","IBDFRPC",50,0)
 ;
"RTN","IBDFRPC",51,0)
 ; -- input     FRM := pointer to encounter form file (357) or form name
"RTN","IBDFRPC",52,0)
 ;           Result := Call by reference or use a closed global root
"RTN","IBDFRPC",53,0)
 ;             FTYP := type of form for clinic (optional)
"RTN","IBDFRPC",54,0)
 ;             KILL := 1 to kill results array prior to setting (default) (optional)
"RTN","IBDFRPC",55,0)
 ;           ALLOBJ := 1 to return all form objects, not just input objs
"RTN","IBDFRPC",56,0)
 ;                     0 to not kill array 
"RTN","IBDFRPC",57,0)
 ;
"RTN","IBDFRPC",58,0)
 ; -- output  The format of the returned array is as follows
"RTN","IBDFRPC",59,0)
 ;        Result(0) := count of array elements
"RTN","IBDFRPC",60,0)
 ;        Result(n)    $p1 :=  pkg interface name
"RTN","IBDFRPC",61,0)
 ;                     $p2 :=  pkg interface ien
"RTN","IBDFRPC",62,0)
 ;                     $p3 :=  form name
"RTN","IBDFRPC",63,0)
 ;                     $p4 :=  form type
"RTN","IBDFRPC",64,0)
 ;                     $p5 :=  type of input object
"RTN","IBDFRPC",65,0)
 ;                     $p6 :=  input object ien. 
"RTN","IBDFRPC",66,0)
 ;                     $p7 :=  Vital Name (vitals only)
"RTN","IBDFRPC",67,0)
 ;                     $p8 :=  manual data entry supported
"RTN","IBDFRPC",68,0)
 ;                     $p9 :=  Block ien
"RTN","IBDFRPC",69,0)
 ;                     $p10 := block row
"RTN","IBDFRPC",70,0)
 ;                     $p11 := block column
"RTN","IBDFRPC",71,0)
 ;
"RTN","IBDFRPC",72,0)
 N C,BLK,SEL,X,Y,ROW,COL,RESULT1,VITAL,CNT,ARRY,SEL1
"RTN","IBDFRPC",73,0)
 I $E($G(RESULT),1)="^" S ARRY=RESULT
"RTN","IBDFRPC",74,0)
 E  S ARRY="RESULT"
"RTN","IBDFRPC",75,0)
 ;
"RTN","IBDFRPC",76,0)
 I +FRM'=FRM,FRM'="" S FRM=+$O(^IBE(357,"B",FRM,0))
"RTN","IBDFRPC",77,0)
 I 'FRM S FRM=$$DEFAULT S:FRM @ARRY@(0)="Using default form" G:'FRM FRMLSTQ
"RTN","IBDFRPC",78,0)
 I $G(FTYP)="" S FTYP=1
"RTN","IBDFRPC",79,0)
 I $G(KILL)="" S KILL=1 K:KILL @ARRY
"RTN","IBDFRPC",80,0)
 I $G(@ARRY@(0))="" S @ARRY@(0)="Form Not Found"
"RTN","IBDFRPC",81,0)
 I '$G(ALLOBJ),$P($G(^IBE(357,FRM,0)),"^",12)'=1 S @ARRY@(0)="Form not scannable" G FRMLSTQ
"RTN","IBDFRPC",82,0)
 ;
"RTN","IBDFRPC",83,0)
 ; -- first find all the blocks
"RTN","IBDFRPC",84,0)
 S X=0 F  S X=$O(^IBE(357.1,"C",FRM,X)) Q:'X  S BLK=X D
"RTN","IBDFRPC",85,0)
 .; -- get row and column of block
"RTN","IBDFRPC",86,0)
 .S ROW=$P($G(^IBE(357.1,+BLK,0)),"^",4),COL=$P(^(0),"^",5)
"RTN","IBDFRPC",87,0)
 .Q:ROW=""!(COL="")
"RTN","IBDFRPC",88,0)
 .;
"RTN","IBDFRPC",89,0)
 .; -- now find all the selection lists with input interfaces
"RTN","IBDFRPC",90,0)
 .S Y=0 F  S Y=$O(^IBE(357.2,"C",BLK,Y)) Q:'Y  D
"RTN","IBDFRPC",91,0)
 ..S SEL=+$P($G(^IBE(357.2,+Y,0)),"^",11)
"RTN","IBDFRPC",92,0)
 ..;I $P($G(^IBE(357.6,+SEL,0)),"^",13)'=""!($G(ALLOBJ)) D  ; has input interface
"RTN","IBDFRPC",93,0)
 ..S SEL1=$P($G(^IBE(357.6,+SEL,0)),"^",13)
"RTN","IBDFRPC",94,0)
 ..I '$G(ALLOBJ) S SEL=SEL1
"RTN","IBDFRPC",95,0)
 ..I $G(ALLOBJ),SEL1'="" S SEL=SEL1
"RTN","IBDFRPC",96,0)
 ..Q:$G(^IBE(357.6,+SEL,0))=""
"RTN","IBDFRPC",97,0)
 ..D ADDIN(.RESULT1,FRM,FTYP,SEL,3,+Y,BLK,ROW,COL)
"RTN","IBDFRPC",98,0)
 ..Q
"RTN","IBDFRPC",99,0)
 .;
"RTN","IBDFRPC",100,0)
 .; -- find multiple choice fields
"RTN","IBDFRPC",101,0)
 .S Y=0 F  S Y=$O(^IBE(357.93,"C",BLK,Y)) Q:'Y  D
"RTN","IBDFRPC",102,0)
 ..S SEL=+$P($G(^IBE(357.93,+Y,0)),"^",6)
"RTN","IBDFRPC",103,0)
 ..I $P($G(^IBE(357.6,+SEL,0)),"^",13)'="" D
"RTN","IBDFRPC",104,0)
 ...S SEL=$P($G(^IBE(357.6,+SEL,0)),"^",13)
"RTN","IBDFRPC",105,0)
 ...Q:$G(^IBE(357.6,+SEL,0))=""
"RTN","IBDFRPC",106,0)
 ...D ADDIN(.RESULT1,FRM,FTYP,SEL,4,Y,BLK,ROW,COL)
"RTN","IBDFRPC",107,0)
 ..I $P($G(^IBE(357.6,+SEL,0)),"^",6)=1 D ADDIN(.RESULT1,FRM,FTYP,SEL,4,Y,BLK,ROW,COL)
"RTN","IBDFRPC",108,0)
 ..Q
"RTN","IBDFRPC",109,0)
 .;
"RTN","IBDFRPC",110,0)
 .; -- find Hand Print fields
"RTN","IBDFRPC",111,0)
 .S Y=0 F  S Y=$O(^IBE(359.94,"C",BLK,Y)) Q:'Y  D
"RTN","IBDFRPC",112,0)
 ..S SEL=+$P($G(^IBE(359.94,+Y,0)),"^",6)
"RTN","IBDFRPC",113,0)
 ..S VITAL=""
"RTN","IBDFRPC",114,0)
 ..I $P($G(^IBE(357.6,+SEL,0)),"^")["VITAL" S VITAL=$P($G(^IBE(359.1,+$P($G(^IBE(359.94,+Y,0)),"^",10),0)),"^")
"RTN","IBDFRPC",115,0)
 ..I $P($G(^IBE(357.6,+SEL,0)),"^",13)'="" D
"RTN","IBDFRPC",116,0)
 ...S SEL=$P($G(^IBE(357.6,+SEL,0)),"^",13)
"RTN","IBDFRPC",117,0)
 ...Q:$G(^IBE(357.6,+SEL,0))=""
"RTN","IBDFRPC",118,0)
 ...D ADDIN(.RESULT1,FRM,FTYP,SEL,5,Y,BLK,ROW,COL)
"RTN","IBDFRPC",119,0)
 ..I $P($G(^IBE(357.6,+SEL,0)),"^",6)=1 D ADDIN(.RESULT1,FRM,FTYP,SEL,5,Y,BLK,ROW,COL,VITAL)
"RTN","IBDFRPC",120,0)
 ..Q
"RTN","IBDFRPC",121,0)
 .;
"RTN","IBDFRPC",122,0)
 .I $G(ALLOBJ) D
"RTN","IBDFRPC",123,0)
 ..; find Data fields
"RTN","IBDFRPC",124,0)
 ..S Y=0 F  S Y=$O(^IBE(357.5,"C",BLK,Y)) Q:'Y  D ADDIN(.RESULT1,FRM,FTYP,+$P($G(^IBE(357.5,+Y,0)),"^",3),6,Y,BLK,ROW,COL)
"RTN","IBDFRPC",125,0)
 ..
"RTN","IBDFRPC",126,0)
 ..; find form lines
"RTN","IBDFRPC",127,0)
 ..S Y=0 F  S Y=$O(^IBE(357.7,"C",BLK,Y)) Q:'Y  D ADDIN(.RESULT1,FRM,FTYP,"FORM LINE",7,Y,BLK,ROW,COL)
"RTN","IBDFRPC",128,0)
 ..;
"RTN","IBDFRPC",129,0)
 ..; find text areas
"RTN","IBDFRPC",130,0)
 ..S Y=0 F  S Y=$O(^IBE(357.8,"C",BLK,Y)) Q:'Y  D ADDIN(.RESULT1,FRM,FTYP,"TEXT AREA",8,Y,BLK,ROW,COL)
"RTN","IBDFRPC",131,0)
 .Q
"RTN","IBDFRPC",132,0)
 ;
"RTN","IBDFRPC",133,0)
 ; -- now set results into single array
"RTN","IBDFRPC",134,0)
 S ROW="",CNT=+$G(@ARRY@(0))
"RTN","IBDFRPC",135,0)
 F  S ROW=$O(RESULT1(ROW)) Q:ROW=""  S COL="" F  S COL=$O(RESULT1(ROW,COL)) Q:COL=""  D
"RTN","IBDFRPC",136,0)
 .S C=0 F  S C=$O(RESULT1(ROW,COL,C)) Q:C=""  D
"RTN","IBDFRPC",137,0)
 ..S CNT=CNT+1
"RTN","IBDFRPC",138,0)
 ..S @ARRY@(CNT)=RESULT1(ROW,COL,C)
"RTN","IBDFRPC",139,0)
 S @ARRY@(0)=CNT
"RTN","IBDFRPC",140,0)
 K RESULT1
"RTN","IBDFRPC",141,0)
 ;
"RTN","IBDFRPC",142,0)
FRMLSTQ Q
"RTN","IBDFRPC",143,0)
 ;
"RTN","IBDFRPC",144,0)
ADDIN(RESULT1,FRM,FTYP,SEL,ITYP,ENTRY,BLK,ROW,COL,VITAL) ; --add to array
"RTN","IBDFRPC",145,0)
 N ITYPE1
"RTN","IBDFRPC",146,0)
 S ITYPE1=$S(ITYP=3:"LIST",ITYP=4:"MC",ITYP=5:"HP",ITYP=6:"DF",ITYP=7:"FL",ITYP=8:"TA",1:"OTHER")
"RTN","IBDFRPC",147,0)
 S RESULT1(0)=$G(RESULT1(0))+1
"RTN","IBDFRPC",148,0)
 S RESULT1(+ROW,+COL,RESULT1(0))=$S(+SEL:$P($G(^IBE(357.6,+SEL,0)),"^"),1:SEL)_"^"_SEL_"^"_$P($G(^IBE(357,+FRM,0)),"^")_"^"_$P($T(TYP+FTYP),";;",2)_"^"_ITYPE1_"^"_$G(ENTRY)_"^"_$G(VITAL)_"^"_$$MNL
"RTN","IBDFRPC",149,0)
 S RESULT1(+ROW,+COL,RESULT1(0))=RESULT1(+ROW,+COL,RESULT1(0))_"^"_$G(BLK)_"^"_$G(ROW)_"^"_$G(COL)
"RTN","IBDFRPC",150,0)
 Q
"RTN","IBDFRPC",151,0)
 ;
"RTN","IBDFRPC",152,0)
MNL() ; -- is manual data entry supported
"RTN","IBDFRPC",153,0)
 Q $S($G(^IBE(357.6,+SEL,18))'="":1,1:0)
"RTN","IBDFRPC",154,0)
 ;
"RTN","IBDFRPC",155,0)
DEFAULT() ; -- find default form from parameters
"RTN","IBDFRPC",156,0)
 N FRM
"RTN","IBDFRPC",157,0)
 S FRM=$P($G(^IBD(357.09,1,0)),"^",4)
"RTN","IBDFRPC",158,0)
 I FRM="" S FRM=$O(^IBE(357,"B","PRIMARY CARE SAMPLE V2.1",0))
"RTN","IBDFRPC",159,0)
 Q FRM
"RTN","IBDFRPC",160,0)
 ;
"RTN","IBDFRPC",161,0)
TESTC ; -- test list by clinic
"RTN","IBDFRPC",162,0)
 K TEST
"RTN","IBDFRPC",163,0)
 D CLNLSTI(.TEST,25)
"RTN","IBDFRPC",164,0)
 X "ZW TEST"
"RTN","IBDFRPC",165,0)
 Q
"RTN","IBDFRPC",166,0)
 ;
"RTN","IBDFRPC",167,0)
TESTF ; -- test list by form
"RTN","IBDFRPC",168,0)
 K TEST
"RTN","IBDFRPC",169,0)
 D FRMLSTI(.TEST,91)
"RTN","IBDFRPC",170,0)
 X "ZW TEST"
"RTN","IBDFRPC",171,0)
 Q
"RTN","IBDFRPC",172,0)
 ;
"RTN","IBDFRPC",173,0)
TYP ; types of forms/from piece in 409.95
"RTN","IBDFRPC",174,0)
 ;;
"RTN","IBDFRPC",175,0)
 ;;BASIC FORM
"RTN","IBDFRPC",176,0)
 ;;SUPPLIMENTAL FORM, EST. PATIENTS
"RTN","IBDFRPC",177,0)
 ;;SUPPLEMENTAL FORM, FIRST VISIT
"RTN","IBDFRPC",178,0)
 ;;FORM W/O PATIENT DATA
"RTN","IBDFRPC",179,0)
 ;;SUPPLEMENTAL FORM
"RTN","IBDFRPC",180,0)
 ;;
"RTN","IBDFRPC",181,0)
 ;;SUPPLEMENTAL FORM
"RTN","IBDFRPC",182,0)
 ;;SUPPLEMENTAL FORM
"RTN","IBDFRPC",183,0)
 ;;
"RTN","IBDFRPC",184,0)
 ;;DEFAULT FORM
"RTN","IBDFRPC",185,0)
 ;;
"RTN","IBDFUTL1")
0^3^B51320678
"RTN","IBDFUTL1",1,0)
IBDFUTL1 ;ALB/MAF - Maintenance Utility cont. - 4 20 95
"RTN","IBDFUTL1",2,0)
 ;;3.0;AUTOMATED INFO COLLECTION SYS;**32,23**;APR 24, 1997
"RTN","IBDFUTL1",3,0)
 ;
"RTN","IBDFUTL1",4,0)
 ;
"RTN","IBDFUTL1",5,0)
SETSTR(S,V,X,L) ; -- insert text(S) into variable(V)
"RTN","IBDFUTL1",6,0)
 ;    S := string
"RTN","IBDFUTL1",7,0)
 ;    V := destination
"RTN","IBDFUTL1",8,0)
 ;    X := @ col X
"RTN","IBDFUTL1",9,0)
 ;    L := # of chars
"RTN","IBDFUTL1",10,0)
 ;
"RTN","IBDFUTL1",11,0)
 Q $E(V_$J("",X-1),1,X-1)_$E(S_$J("",L),1,L)_$E(V,X+L,999)
"RTN","IBDFUTL1",12,0)
 ;
"RTN","IBDFUTL1",13,0)
 ;
"RTN","IBDFUTL1",14,0)
SETARR ;  -- Set up Listman array
"RTN","IBDFUTL1",15,0)
 S IBDCNT1=IBDCNT1+1
"RTN","IBDFUTL1",16,0)
 S IBDCNT=IBDCNT+1,VALMCNT=VALMCNT+1
"RTN","IBDFUTL1",17,0)
 S X=""
"RTN","IBDFUTL1",18,0)
 S IBDFVAL=$J(IBDCNT1_")",5)
"RTN","IBDFUTL1",19,0)
 S X=$$SETSTR^VALM1(IBDFVAL,X,1,5)
"RTN","IBDFUTL1",20,0)
 S IBDFVAL=IBDFX
"RTN","IBDFUTL1",21,0)
 S X=$$SETSTR^VALM1(IBDFVAL,X,7,8)
"RTN","IBDFUTL1",22,0)
 S IBDFVAL=$P(IBDFTMP,"^",3)
"RTN","IBDFUTL1",23,0)
 S X=$$SETSTR^VALM1(IBDFVAL,X,17,15)
"RTN","IBDFUTL1",24,0)
 S IBDFVAL=$P(^IBE(357.1,IBDFBLK,0),"^",1)
"RTN","IBDFUTL1",25,0)
 S X=$$SETSTR^VALM1(IBDFVAL,X,34,14)
"RTN","IBDFUTL1",26,0)
 S IBDFVAL=$P(^IBE(357,IBDFORM1,0),"^",1)
"RTN","IBDFUTL1",27,0)
 S X=$$SETSTR^VALM1(IBDFVAL,X,50,14)
"RTN","IBDFUTL1",28,0)
 I $D(VAUTC)!($D(VAUTG)) S IBDFVAL=$P(IBDFTMP,"^",6) S X=$$SETSTR^VALM1(IBDFVAL,X,66,14)
"RTN","IBDFUTL1",29,0)
 ;
"RTN","IBDFUTL1",30,0)
 ;
"RTN","IBDFUTL1",31,0)
TMP ; -- Set up TMP Array
"RTN","IBDFUTL1",32,0)
 S ^TMP("CPT",$J,IBDCNT,0)=$$LOWER^VALM1(X),^TMP("CPT",$J,"IDX",VALMCNT,IBDCNT1)=""
"RTN","IBDFUTL1",33,0)
 S ^TMP("CPTIDX",$J,IBDCNT1)=VALMCNT_"^"_IBDFX_"^"_$P(IBDFTMP,"^",4)_"^"_$P(IBDFTMP,"^",5)_"^"_$P(IBDFTMP,"^",1)_"^"_$P(IBDFTMP,"^",2)
"RTN","IBDFUTL1",34,0)
 Q
"RTN","IBDFUTL1",35,0)
SETARR1 ;  -- Set up Listman array
"RTN","IBDFUTL1",36,0)
 N IBDPRIM,IBDSELP
"RTN","IBDFUTL1",37,0)
 S IBDSELP=$P($G(IBDFTMP),"^",5)
"RTN","IBDFUTL1",38,0)
 Q:IBDSELP']""
"RTN","IBDFUTL1",39,0)
 S IBDPRIM=$P($G(^IBE(357.3,IBDSELP,0)),"^")
"RTN","IBDFUTL1",40,0)
 I IBDPRIM=IBDFX Q
"RTN","IBDFUTL1",41,0)
 ;S IBDCNT1=IBDCNT1+1
"RTN","IBDFUTL1",42,0)
 S IBDCNT=IBDCNT+1,VALMCNT=VALMCNT+1
"RTN","IBDFUTL1",43,0)
 S X=""
"RTN","IBDFUTL1",44,0)
 S IBDFVAL="Primary Diagnosis: "_IBDPRIM
"RTN","IBDFUTL1",45,0)
 S X=$$SETSTR^VALM1(IBDFVAL,X,17,40)
"RTN","IBDFUTL1",46,0)
 ;
"RTN","IBDFUTL1",47,0)
 ;
"RTN","IBDFUTL1",48,0)
TMP1 ; -- Set up TMP Array
"RTN","IBDFUTL1",49,0)
 S ^TMP("CPT",$J,IBDCNT,0)=$$LOWER^VALM1(X),^TMP("CPT",$J,"IDX",VALMCNT,IBDCNT1)=""
"RTN","IBDFUTL1",50,0)
 Q
"RTN","IBDFUTL1",51,0)
 ;
"RTN","IBDFUTL1",52,0)
 ;
"RTN","IBDFUTL1",53,0)
SET ;  -- Loop thru to see if codes are valid
"RTN","IBDFUTL1",54,0)
 F IBDFBLK=0:0 S IBDFBLK=$O(^IBE(357.1,"C",IBDFORM,IBDFBLK)) Q:'IBDFBLK  D
"RTN","IBDFUTL1",55,0)
 .F IBDFLST=0:0 S IBDFLST=$O(^IBE(357.2,"C",IBDFBLK,IBDFLST)) Q:'IBDFLST  S IBDFNODE=$G(^IBE(357.2,IBDFLST,0)) I $P(IBDFNODE,"^",11)=IBDFINT D
"RTN","IBDFUTL1",56,0)
 ..F IBDFSEL=0:0 S IBDFSEL=$O(^IBE(357.3,"C",IBDFLST,IBDFSEL)) Q:'IBDFSEL  S IBDFX=$G(^IBE(357.3,IBDFSEL,0)) I $P(IBDFX,"^",2)']"" D
"RTN","IBDFUTL1",57,0)
 ...S IBDFX1=$P(IBDFX,"^",1),IBDFX2=$P($G(^IBE(357.3,IBDFSEL,2)),"^",3),IBDFX3=$P($G(^IBE(357.3,IBDFSEL,2)),"^",4)
"RTN","IBDFUTL1",58,0)
 ...F IBI=IBDFX1,IBDFX2,IBDFX3 I IBI]"" D
"RTN","IBDFUTL1",59,0)
 ....I IBDFACT=1 D
"RTN","IBDFUTL1",60,0)
 .....S (X,IBDFX)=IBI
"RTN","IBDFUTL1",61,0)
 .....X $G(^IBE(357.6,IBDFINT,11))
"RTN","IBDFUTL1",62,0)
 .....Q:'$D(X)
"RTN","IBDFUTL1",63,0)
 .....;;----change to api cpt;dhh
"RTN","IBDFUTL1",64,0)
 .....I $G(IBDFCODE)="CPT " N IBY,XX D
"RTN","IBDFUTL1",65,0)
 ......S XX=$$CPT^ICPTCOD(X)
"RTN","IBDFUTL1",66,0)
 ......S IBY=$S(+XX=-1:"",1:$P(XX,"^",3))
"RTN","IBDFUTL1",67,0)
 .....I $G(IBDFCODE)="ICD-9 " N IBY S IBY=$P($G(^ICD9(X,0)),"^",3)
"RTN","IBDFUTL1",68,0)
 .....I $G(IBDFCODE)="Type of Visit " N IBY S IBY=$P($G(^IBE(357.69,X,0)),"^",2)
"RTN","IBDFUTL1",69,0)
 .....Q:'$D(VAUTJ(X))
"RTN","IBDFUTL1",70,0)
 .....S ^TMP("UTIL",$J,IBDFNAME,IBDFX,$P(^IBE(357,IBDFORM,0),"^",1),$P(^IBE(357.1,IBDFBLK,0),"^",1),IBDFSEL)=IBDFORM_"^"_IBDFBLK_"^"_$S(IBY]"":IBY,1:"INVALID")_"^"_IBDFLST_"^"_IBDFSEL_"^"_$S($D(VAUTC):IBDFNAME,$D(VAUTG):IBDFCLNM,1:"")
"RTN","IBDFUTL1",71,0)
 ....I IBDFACT=2 D
"RTN","IBDFUTL1",72,0)
 .....S (X,IBDFX)=IBI
"RTN","IBDFUTL1",73,0)
 .....X $G(^IBE(357.6,IBDFINT,11))
"RTN","IBDFUTL1",74,0)
 .....I '$D(X) S ^TMP("UTIL",$J,IBDFNAME,IBDFX,$P(^IBE(357,IBDFORM,0),"^",1),$P(^IBE(357.1,IBDFBLK,0),"^",1),IBDFSEL)=IBDFORM_"^"_IBDFBLK_"^"_$S(Y]"":Y,1:"INVALID")_"^"_IBDFLST_"^"_IBDFSEL_"^"_$S($D(VAUTC):IBDFNAME,$D(VAUTG):IBDFCLNM,1:"")
"RTN","IBDFUTL1",75,0)
 Q
"RTN","IBDFUTL1",76,0)
 ;
"RTN","IBDFUTL1",77,0)
 ;
"RTN","IBDFUTL1",78,0)
 ;  -- Set up alphabetical listing
"RTN","IBDFUTL1",79,0)
SET1 S (IBDFORM1,IBDFBLK,IBDFLG,IBDFX,IBDFNAME,IBDORM,IBDBLK)=0
"RTN","IBDFUTL1",80,0)
 F IBDFNM=0:0 S IBDFNAME=$O(^TMP("UTIL",$J,IBDFNAME)) Q:IBDFNAME']""  S IBDFX="" F  S IBDFX=$O(^TMP("UTIL",$J,IBDFNAME,IBDFX)) D:(IBDFX="")&($D(VAUTF)) CLINICS^IBDFUTL2 Q:IBDFX=""  D
"RTN","IBDFUTL1",81,0)
 .F IBDFRM=0:0 S IBDORM=$O(^TMP("UTIL",$J,IBDFNAME,IBDFX,IBDORM)) Q:IBDORM']""  F IBDFBK=0:0 S IBDBLK=$O(^TMP("UTIL",$J,IBDFNAME,IBDFX,IBDORM,IBDBLK)) Q:IBDBLK']""  D
"RTN","IBDFUTL1",82,0)
 ..F  S IBDFSEL=$O(^TMP("UTIL",$J,IBDFNAME,IBDFX,IBDORM,IBDBLK,IBDFSEL)) Q:IBDFSEL']""  D
"RTN","IBDFUTL1",83,0)
 ...S IBDFTMP=^TMP("UTIL",$J,IBDFNAME,IBDFX,IBDORM,IBDBLK,IBDFSEL),IBDFORM1=$P(IBDFTMP,"^",1),IBDFBLK=$P(IBDFTMP,"^",2) D:'$D(IBDF(IBDFNAME)) HEADER^IBDFUTL2 D SETARR D:IBDBLK="DIAGNOSIS" SETARR1
"RTN","IBDFUTL1",84,0)
 Q
"RTN","IBDFUTL1",85,0)
 ;
"RTN","IBDFUTL1",86,0)
 ;
"RTN","IBDFUTL1",87,0)
CLIN1 ;  -- Sort Display by clinic
"RTN","IBDFUTL1",88,0)
 N IBDFBLK,IBDFLST,IBDFORM,VAUTF
"RTN","IBDFUTL1",89,0)
 I VAUTC=1 F X=0:0 S X=$O(^SC(X)) Q:'X  I $D(^SC(X,0)) S ^TMP("CLN",$J,X)=$P(^SC(X,0),"^",1)
"RTN","IBDFUTL1",90,0)
 I VAUTC=0 K ^TMP("CLN",$J) F IBDFCLIN=0:0 S IBDFCLIN=$O(VAUTC(IBDFCLIN)) Q:'IBDFCLIN  S X=$G(VAUTC(IBDFCLIN)) S ^TMP("CLN",$J,IBDFCLIN)=X
"RTN","IBDFUTL1",91,0)
 I '$D(IBDFNCNG) K ^TMP("CLN1",$J)
"RTN","IBDFUTL1",92,0)
 F IBDFCLIN=0:0 S IBDFCLIN=$O(^TMP("CLN",$J,IBDFCLIN)) Q:'IBDFCLIN  S X=$G(^TMP("CLN",$J,IBDFCLIN)) S ^TMP("CLN1",$J,X)=IBDFCLIN
"RTN","IBDFUTL1",93,0)
 S IBDCLNM=0 F IBDCLN=0:0 S IBDCLNM=$O(^TMP("CLN1",$J,IBDCLNM)) Q:IBDCLNM']""  S IBDFCLIN=^TMP("CLN1",$J,IBDCLNM) S IBDFCIFN=$O(^SD(409.95,"B",IBDFCLIN,0)) S IBDCNODE=$G(^SD(409.95,+IBDFCIFN,0)),IBDFNAME=IBDCLNM I $D(IBDCNODE) D
"RTN","IBDFUTL1",94,0)
 .F IBDFN=2:1:9 S IBDFORM=$P(IBDCNODE,"^",IBDFN) I IBDFORM D SET
"RTN","IBDFUTL1",95,0)
 D SET1 Q
"RTN","IBDFUTL1",96,0)
 ;
"RTN","IBDFUTL1",97,0)
 ;
"RTN","IBDFUTL1",98,0)
FORM1 ;  -- Sort Display by form
"RTN","IBDFUTL1",99,0)
 N IBDFBLK,IBDFLST,IBDFORM
"RTN","IBDFUTL1",100,0)
 I VAUTF=1 S IBDFRNM=0 F IBDFRM=0:0 S IBDFRNM=$O(^IBE(357,"B",IBDFRNM)) Q:IBDFRNM']""  F IBDFORM=0:0 S IBDFORM=$O(^IBE(357,"B",IBDFRNM,IBDFORM)) Q:'IBDFORM  S IBDFNAME=IBDFRNM D SET
"RTN","IBDFUTL1",101,0)
 I '$D(IBDFNCNG) K ^TMP("FRM1",$J)
"RTN","IBDFUTL1",102,0)
 I VAUTF=0 F IBDFORM=0:0 S IBDFORM=$O(VAUTF(IBDFORM)) Q:'IBDFORM  S X=$G(VAUTF(IBDFORM)) S ^TMP("FRM1",$J,X)=IBDFORM
"RTN","IBDFUTL1",103,0)
 I VAUTF=0 S IBDFRNM=0 F IBDFRM=0:0 S IBDFRNM=$O(^TMP("FRM1",$J,IBDFRNM)) Q:IBDFRNM']""  S IBDFORM=^TMP("FRM1",$J,IBDFRNM),IBDFNAME=IBDFRNM D SET
"RTN","IBDFUTL1",104,0)
 D SET1
"RTN","IBDFUTL1",105,0)
 Q
"RTN","IBDFUTL1",106,0)
 ;
"RTN","IBDFUTL1",107,0)
 ;
"RTN","IBDFUTL1",108,0)
GROUP1 ;  -- Sort Display by clinic group
"RTN","IBDFUTL1",109,0)
 N IBDFBLK,IBDFLST,IBDFORM,VAUTF
"RTN","IBDFUTL1",110,0)
 I VAUTG=1 S IBDFGNM=0 F IBDFGN=0:0 S IBDFGNM=$O(^IBD(357.99,"B",IBDFGNM)) Q:IBDFGNM']""  F IBDFGIFN=0:0 S IBDFGIFN=$O(^IBD(357.99,"B",IBDFGNM,IBDFGIFN)) Q:'IBDFGIFN  S ^TMP("GRP1",$J,IBDFGNM)=IBDFGIFN
"RTN","IBDFUTL1",111,0)
 I VAUTG=0,'$D(IBDFNCNG) K ^TMP("GRP1",$J)
"RTN","IBDFUTL1",112,0)
 I VAUTG=0 F IBDFGIFN=0:0 S IBDFGIFN=$O(VAUTG(IBDFGIFN)) Q:'IBDFGIFN  S ^TMP("GRP1",$J,VAUTG(IBDFGIFN))=IBDFGIFN
"RTN","IBDFUTL1",113,0)
 S IBDFGNM=0 F IBDFGN=0:0 S IBDFGNM=$O(^TMP("GRP1",$J,IBDFGNM)) Q:IBDFGNM']""  S IBDFGIFN=^TMP("GRP1",$J,IBDFGNM) D
"RTN","IBDFUTL1",114,0)
 .S IEN=0 F  S IEN=$O(^IBD(357.99,IBDFGIFN,10,IEN)) Q:'IEN  S IBCLN=+$G(^IBD(357.99,IBDFGIFN,10,IEN,0)) S:$D(^SC(IBCLN,0)) ^TMP("IBDF",$J,"C",IBDFGNM,$P(^SC(IBCLN,0),"^",1))=IBCLN
"RTN","IBDFUTL1",115,0)
 .S IEN=0 F  S IEN=$O(^IBD(357.99,IBDFGIFN,11,IEN)) Q:'IEN  S IBDIV=+$G(^IBD(357.99,IBDFGIFN,11,IEN,0)) S:IBDIV ^TMP("IBDF",$J,"D",IBDFGNM,IBDIV)=""
"RTN","IBDFUTL1",116,0)
 D:$D(^TMP("IBDF",$J,"D")) ENDV^IBDFUTL2
"RTN","IBDFUTL1",117,0)
 S IBDFGNM=0 F IBDFGN=0:0 S IBDFGNM=$O(^TMP("IBDF",$J,"C",IBDFGNM)) Q:IBDFGNM']""  S IBDFCLNM=0 F IBDFCLN=0:0 S IBDFCLNM=$O(^TMP("IBDF",$J,"C",IBDFGNM,IBDFCLNM)) Q:IBDFCLNM']""  D
"RTN","IBDFUTL1",118,0)
 .S IBDFCLIN=$G(^TMP("IBDF",$J,"C",IBDFGNM,IBDFCLNM)),IBDFCIFN=$O(^SD(409.95,"B",IBDFCLIN,0)) S IBDCNODE=$G(^SD(409.95,+IBDFCIFN,0)) I $D(IBDCNODE) S IBDFNAME=IBDFGNM F IBDFN=2:1:9 S IBDFORM=$P(IBDCNODE,"^",IBDFN) I IBDFORM D SET
"RTN","IBDFUTL1",119,0)
 D SET1 Q
"VER")
8.0^22
**END**
**END**
