Released PSB*2*20 SEQ #14
Extracted from mail message
**KIDS**:PSB*2.0*20^

**INSTALL NAME**
PSB*2.0*20
"BLD",3988,0)
PSB*2.0*20^BAR CODE MED ADMIN^0^3030218^y
"BLD",3988,1,0)
^^22^22^3030203^
"BLD",3988,1,1,0)
1. BCMA will display a Notification Popup box, once per patient session, 
"BLD",3988,1,2,0)
for the Unit Dose and IVP/IVPB Medication Tabs. The Popup box displays if
"BLD",3988,1,3,0)
a patient has had a recent movement, and at least one of the last actions
"BLD",3988,1,4,0)
occurred within the specified timeframe defined in the "Patient Transfer 
"BLD",3988,1,5,0)
Notification Timeframe:" field on the Parameters tab of the BCMA Site
"BLD",3988,1,6,0)
Parameters application. The Popup box will display the patient movement
"BLD",3988,1,7,0)
type and transaction type within brackets, and the Virtual Due List (VDL)
"BLD",3988,1,8,0)
will display the transaction type in the "Last Action" column for a 
"BLD",3988,1,9,0)
medication displayed on the VDL.
"BLD",3988,1,10,0)
 
"BLD",3988,1,11,0)
2. BCMA will now document fractional dose medication orders, which occur 
"BLD",3988,1,12,0)
when a medication order contains a units per dose that is not a whole
"BLD",3988,1,13,0)
number. When a user administers a fractional dose medication using BCMA, 
"BLD",3988,1,14,0)
a Multiple or a Fractional Dose dialog box will display for documenting
"BLD",3988,1,15,0)
the actual amount and user comments.
"BLD",3988,1,16,0)
 
"BLD",3988,1,17,0)
3. Three fields have been removed from the Parameters tab of the BCMA Site
"BLD",3988,1,18,0)
Parameters application since the functionality no longer exists. They
"BLD",3988,1,19,0)
include the "General System Error:" field, the "Auto Update Notification:"
"BLD",3988,1,20,0)
field in the Mail Groups section of the Parameters tab and
"BLD",3988,1,21,0)
the "UNC of the Auto Update Server:" field in the Misc. Options section of
"BLD",3988,1,22,0)
the Parameters tab.
"BLD",3988,4,0)
^9.64PA^^0
"BLD",3988,"ABPKG")
n
"BLD",3988,"INID")
^y
"BLD",3988,"INIT")
PSBPAR1
"BLD",3988,"KRN",0)
^9.67PA^8989.52^19
"BLD",3988,"KRN",.4,0)
.4
"BLD",3988,"KRN",.401,0)
.401
"BLD",3988,"KRN",.402,0)
.402
"BLD",3988,"KRN",.403,0)
.403
"BLD",3988,"KRN",.403,"NM",0)
^9.68A^^0
"BLD",3988,"KRN",.5,0)
.5
"BLD",3988,"KRN",.5,"NM",0)
^9.68A^^
"BLD",3988,"KRN",.84,0)
.84
"BLD",3988,"KRN",3.6,0)
3.6
"BLD",3988,"KRN",3.8,0)
3.8
"BLD",3988,"KRN",9.2,0)
9.2
"BLD",3988,"KRN",9.2,"NM",0)
^9.68A^^
"BLD",3988,"KRN",9.8,0)
9.8
"BLD",3988,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",3988,"KRN",9.8,"NM",1,0)
PSBVDLTB^^0^B7112659
"BLD",3988,"KRN",9.8,"NM",2,0)
PSBVDLUD^^0^B61956220
"BLD",3988,"KRN",9.8,"NM",3,0)
PSBVDLPB^^0^B65300302
"BLD",3988,"KRN",9.8,"NM",4,0)
PSBVDLIV^^0^B52605453
"BLD",3988,"KRN",9.8,"NM",5,0)
PSBVDLU1^^0^B48961179
"BLD",3988,"KRN",9.8,"NM",6,0)
PSBRPC3^^0^B297189
"BLD",3988,"KRN",9.8,"NM","B","PSBRPC3",6)

"BLD",3988,"KRN",9.8,"NM","B","PSBVDLIV",4)

"BLD",3988,"KRN",9.8,"NM","B","PSBVDLPB",3)

"BLD",3988,"KRN",9.8,"NM","B","PSBVDLTB",1)

"BLD",3988,"KRN",9.8,"NM","B","PSBVDLU1",5)

"BLD",3988,"KRN",9.8,"NM","B","PSBVDLUD",2)

"BLD",3988,"KRN",19,0)
19
"BLD",3988,"KRN",19,"NM",0)
^9.68A^^0
"BLD",3988,"KRN",19.1,0)
19.1
"BLD",3988,"KRN",19.1,"NM",0)
^9.68A^^0
"BLD",3988,"KRN",101,0)
101
"BLD",3988,"KRN",409.61,0)
409.61
"BLD",3988,"KRN",771,0)
771
"BLD",3988,"KRN",870,0)
870
"BLD",3988,"KRN",8989.51,0)
8989.51
"BLD",3988,"KRN",8989.51,"NM",0)
^9.68A^1^1
"BLD",3988,"KRN",8989.51,"NM",1,0)
PSB PATIENT TRANSFER^^0
"BLD",3988,"KRN",8989.51,"NM","B","PSB PATIENT TRANSFER",1)

"BLD",3988,"KRN",8989.52,0)
8989.52
"BLD",3988,"KRN",8989.52,"NM",0)
^9.68A^^0
"BLD",3988,"KRN",8994,0)
8994
"BLD",3988,"KRN",8994,"NM",0)
^9.68A^^0
"BLD",3988,"KRN","B",.4,.4)

"BLD",3988,"KRN","B",.401,.401)

"BLD",3988,"KRN","B",.402,.402)

"BLD",3988,"KRN","B",.403,.403)

"BLD",3988,"KRN","B",.5,.5)

"BLD",3988,"KRN","B",.84,.84)

"BLD",3988,"KRN","B",3.6,3.6)

"BLD",3988,"KRN","B",3.8,3.8)

"BLD",3988,"KRN","B",9.2,9.2)

"BLD",3988,"KRN","B",9.8,9.8)

"BLD",3988,"KRN","B",19,19)

"BLD",3988,"KRN","B",19.1,19.1)

"BLD",3988,"KRN","B",101,101)

"BLD",3988,"KRN","B",409.61,409.61)

"BLD",3988,"KRN","B",771,771)

"BLD",3988,"KRN","B",870,870)

"BLD",3988,"KRN","B",8989.51,8989.51)

"BLD",3988,"KRN","B",8989.52,8989.52)

"BLD",3988,"KRN","B",8994,8994)

"BLD",3988,"QUES",0)
^9.62^^
"BLD",3988,"REQB",0)
^9.611^6^6
"BLD",3988,"REQB",1,0)
PSB*2.0*3^1
"BLD",3988,"REQB",2,0)
PSB*2.0*1^1
"BLD",3988,"REQB",3,0)
PSB*2.0*6^1
"BLD",3988,"REQB",4,0)
PSB*2.0*8^1
"BLD",3988,"REQB",5,0)
PSB*2.0*13^1
"BLD",3988,"REQB",6,0)
PSB*2.0*15^1
"BLD",3988,"REQB","B","PSB*2.0*1",2)

"BLD",3988,"REQB","B","PSB*2.0*13",5)

"BLD",3988,"REQB","B","PSB*2.0*15",6)

"BLD",3988,"REQB","B","PSB*2.0*3",1)

"BLD",3988,"REQB","B","PSB*2.0*6",3)

"BLD",3988,"REQB","B","PSB*2.0*8",4)

"INIT")
PSBPAR1
"KRN",8989.51,4760,-1)
0^1
"KRN",8989.51,4760,0)
PSB PATIENT TRANSFER^Patient Transfer Notification Timeframe^0^^^0
"KRN",8989.51,4760,1)
N^2:99^Enter number of hours (2-99, 72 is default)
"KRN",8989.51,4760,20,0)
^^1^1^3030106^
"KRN",8989.51,4760,20,1,0)
This will store the number of hours for the Patient transfer notification timeframe on the BCMA Site Parameters screen.
"KRN",8989.51,4760,30,0)
^8989.513I^1^1
"KRN",8989.51,4760,30,1,0)
1^4
"MBREQ")
0
"ORD",20,8989.51)
8989.51;20;;;PAR1E1^XPDTA2;PAR1F1^XPDIA3;PAR1E1^XPDIA3;PAR1F2^XPDIA3
"ORD",20,8989.51,0)
PARAMETER DEFINITION
"PKG",536,-1)
1^1
"PKG",536,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",536,20,0)
^9.402P^^
"PKG",536,22,0)
^9.49I^1^1
"PKG",536,22,1,0)
2.0^3020514^3020719^10000000027
"PKG",536,22,1,"PAH",1,0)
20^3030218^10000000010
"PKG",536,22,1,"PAH",1,1,0)
^^22^22^3030218
"PKG",536,22,1,"PAH",1,1,1,0)
1. BCMA will display a Notification Popup box, once per patient session, 
"PKG",536,22,1,"PAH",1,1,2,0)
for the Unit Dose and IVP/IVPB Medication Tabs. The Popup box displays if
"PKG",536,22,1,"PAH",1,1,3,0)
a patient has had a recent movement, and at least one of the last actions
"PKG",536,22,1,"PAH",1,1,4,0)
occurred within the specified timeframe defined in the "Patient Transfer 
"PKG",536,22,1,"PAH",1,1,5,0)
Notification Timeframe:" field on the Parameters tab of the BCMA Site
"PKG",536,22,1,"PAH",1,1,6,0)
Parameters application. The Popup box will display the patient movement
"PKG",536,22,1,"PAH",1,1,7,0)
type and transaction type within brackets, and the Virtual Due List (VDL)
"PKG",536,22,1,"PAH",1,1,8,0)
will display the transaction type in the "Last Action" column for a 
"PKG",536,22,1,"PAH",1,1,9,0)
medication displayed on the VDL.
"PKG",536,22,1,"PAH",1,1,10,0)
 
"PKG",536,22,1,"PAH",1,1,11,0)
2. BCMA will now document fractional dose medication orders, which occur 
"PKG",536,22,1,"PAH",1,1,12,0)
when a medication order contains a units per dose that is not a whole
"PKG",536,22,1,"PAH",1,1,13,0)
number. When a user administers a fractional dose medication using BCMA, 
"PKG",536,22,1,"PAH",1,1,14,0)
a Multiple or a Fractional Dose dialog box will display for documenting
"PKG",536,22,1,"PAH",1,1,15,0)
the actual amount and user comments.
"PKG",536,22,1,"PAH",1,1,16,0)
 
"PKG",536,22,1,"PAH",1,1,17,0)
3. Three fields have been removed from the Parameters tab of the BCMA Site
"PKG",536,22,1,"PAH",1,1,18,0)
Parameters application since the functionality no longer exists. They
"PKG",536,22,1,"PAH",1,1,19,0)
include the "General System Error:" field, the "Auto Update Notification:"
"PKG",536,22,1,"PAH",1,1,20,0)
field in the Mail Groups section of the Parameters tab and
"PKG",536,22,1,"PAH",1,1,21,0)
the "UNC of the Auto Update Server:" field in the Misc. Options section of
"PKG",536,22,1,"PAH",1,1,22,0)
the Parameters tab.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","PSBPAR1")
0^^B316254
"RTN","PSBPAR1",1,0)
PSBPAR1 ;BIRMINGHAM/VRN-BCMA PARAMETER MANAGEMENT ;May 2002
"RTN","PSBPAR1",2,0)
 ;;2.0;BAR CODE MED ADMIN;**20**;May, 2002
"RTN","PSBPAR1",3,0)
 ;
"RTN","PSBPAR1",4,0)
 ;Reference to $$GET^XPAR is supported by DBIA 2263
"RTN","PSBPAR1",5,0)
 ;Reference to $$EN^XPAR is supported by DBIA 2263
"RTN","PSBPAR1",6,0)
 ;
"RTN","PSBPAR1",7,0)
 ;Set the PSB PATIENT TRANSFER parameter to 72 in the PARAMETER
"RTN","PSBPAR1",8,0)
 ;file (#8989.5), if there is no existing data or value.
"RTN","PSBPAR1",9,0)
 ;
"RTN","PSBPAR1",10,0)
 I '$$GET^XPAR("DIV","PSB PATIENT TRANSFER") D EN^XPAR("DIV","PSB PATIENT TRANSFER",1,72)
"RTN","PSBPAR1",11,0)
 Q
"RTN","PSBRPC3")
0^6^B297189
"RTN","PSBRPC3",1,0)
PSBRPC3 ;BIRMINGHAM/VRN-BCMA RPC BROKER CALLS ;May 2002
"RTN","PSBRPC3",2,0)
 ;;2.0;BAR CODE MED ADMIN;**8,20**;May 2002
"RTN","PSBRPC3",3,0)
 ;
"RTN","PSBRPC3",4,0)
GUICHK(RESULTS,DUMMY) ;
"RTN","PSBRPC3",5,0)
 ;
"RTN","PSBRPC3",6,0)
 ; RPC : PSB VERSION CHECK
"RTN","PSBRPC3",7,0)
 ;
"RTN","PSBRPC3",8,0)
 K RESULTS
"RTN","PSBRPC3",9,0)
 N PSBCURR,PSBPREV,PSBCNT
"RTN","PSBRPC3",10,0)
 S PSBCURR="2.0.20.3",PSBPREV="",PSBCNT=0
"RTN","PSBRPC3",11,0)
 S PSBCNT=PSBCNT+1
"RTN","PSBRPC3",12,0)
 S RESULTS(PSBCNT)=PSBCURR_U_PSBPREV
"RTN","PSBRPC3",13,0)
 S RESULTS(0)=PSBCNT
"RTN","PSBRPC3",14,0)
 Q
"RTN","PSBVDLIV")
0^4^B52605453
"RTN","PSBVDLIV",1,0)
PSBVDLIV ;BIRMINGHAM/EFC-BCMA IV VIRTUAL DUE LIST ;May 2002
"RTN","PSBVDLIV",2,0)
 ;;2.0;BAR CODE MED ADMIN;**1,13,6,20**;May 2002
"RTN","PSBVDLIV",3,0)
 ;
"RTN","PSBVDLIV",4,0)
 ; Reference/IA
"RTN","PSBVDLIV",5,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLIV",6,0)
 ;
"RTN","PSBVDLIV",7,0)
EN(DFN,PSBDT) ; Default Order List Return for Today
"RTN","PSBVDLIV",8,0)
 ;
"RTN","PSBVDLIV",9,0)
 ; RPC: PSB GETORDERLIST
"RTN","PSBVDLIV",10,0)
 ;
"RTN","PSBVDLIV",11,0)
 ; Description:
"RTN","PSBVDLIV",12,0)
 ; Returns the current IV order set for today to display on the
"RTN","PSBVDLIV",13,0)
 ; client VDL
"RTN","PSBVDLIV",14,0)
 ;
"RTN","PSBVDLIV",15,0)
 N PSBDATA
"RTN","PSBVDLIV",16,0)
 K ^TMP("PSB",$J,"IVTAB"),^TMP("PSB",$J,"ON IVTAB")
"RTN","PSBVDLIV",17,0)
 S ^TMP("PSB",$J,"IVTAB",0)=1
"RTN","PSBVDLIV",18,0)
 S ^TMP("PSB",$J,"IVTAB",1)="-1^No Active Orders at this Time."
"RTN","PSBVDLIV",19,0)
 ;
"RTN","PSBVDLIV",20,0)
 K ^TMP("PSJ",$J) D EN^PSJBCMA(DFN,PSBDT-7,PSBTRDT)
"RTN","PSBVDLIV",21,0)
 ;
"RTN","PSBVDLIV",22,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 Q  ; No orders
"RTN","PSBVDLIV",23,0)
 ;
"RTN","PSBVDLIV",24,0)
 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:'PSBX  D
"RTN","PSBVDLIV",25,0)
 .D CLEAN^PSBVT
"RTN","PSBVDLIV",26,0)
 .D PSJ^PSBVT(PSBX)
"RTN","PSBVDLIV",27,0)
 .;
"RTN","PSBVDLIV",28,0)
 .; << Standard checks for ALL orders >>
"RTN","PSBVDLIV",29,0)
 .;
"RTN","PSBVDLIV",30,0)
 .Q:PSBONX'["V"  ; IVs only
"RTN","PSBVDLIV",31,0)
 .Q:PSBIVT["P"  ; No piggybacks
"RTN","PSBVDLIV",32,0)
 .Q:PSBONX["P"  ;     No Pending Orders
"RTN","PSBVDLIV",33,0)
 .K PSBCOMP D INFUSING^PSBVDLU2
"RTN","PSBVDLIV",34,0)
 .Q:PSBOST>($$FMADD^XLFDT($$NOW^XLFDT,,,$$GET^XPAR("DIV","PSB ADMIN BEFORE")))
"RTN","PSBVDLIV",35,0)
 .I (PSBOSTS["D")&(PSBCOMP=0) Q  ;     Is it DC'd and not infusing or stopped
"RTN","PSBVDLIV",36,0)
 .I PSBOSTS="E",PSBCOMP=0 Q  ; Is expired and not infusing or stopped
"RTN","PSBVDLIV",37,0)
 .I PSBOSTS="D",PSBCOMP=1,$G(PSBFON)]"" Q  ; order is DC'ed due will be picked up with following order
"RTN","PSBVDLIV",38,0)
 .I PSBOSTS="E",PSBCOMP=1,$G(PSBFON)]"" Q  ; order is renewed will be pickedup by following order
"RTN","PSBVDLIV",39,0)
 .I PSBOSTS="R",PSBFOR="R",PSBOSP<PSBWBEG Q  ; order is renewed bag picked up by following order
"RTN","PSBVDLIV",40,0)
 .Q:$G(^TMP("PSB",$J,"ON IVTAB",PSBDFN,PSBONX))=1  ; The "previous order" is displayed on the VDL!
"RTN","PSBVDLIV",41,0)
 .I (PSBOSTS["E")&(PSBCOMP=0) Q  ;     Is it expired and not infusing
"RTN","PSBVDLIV",42,0)
 .I PSBIVT["S",PSBISYR=1 Q  ;     No intermittent syringes - done on PB tab
"RTN","PSBVDLIV",43,0)
 .I PSBIVT["C",PSBISYR=1 Q  ;     No intermittent syringes - done on PB tab
"RTN","PSBVDLIV",44,0)
 .I PSBIVT["C",PSBCHEMT="P" Q  ;  No Piggyback Chemos
"RTN","PSBVDLIV",45,0)
 .I PSBNGF&(PSBCOMP=1) Q  ;         Is it marked DO NOT GIVE!
"RTN","PSBVDLIV",46,0)
 .;
"RTN","PSBVDLIV",47,0)
 .; Non One-Times with stop date/time < now
"RTN","PSBVDLIV",48,0)
 .;
"RTN","PSBVDLIV",49,0)
 .D NOW^%DTC
"RTN","PSBVDLIV",50,0)
 .I PSBOSP<%,PSBOSTS'="R",PSBCOMP'=1 Q
"RTN","PSBVDLIV",51,0)
 .;
"RTN","PSBVDLIV",52,0)
 .; include Active, Renewed, ReInstated and On Call and Hold and Expired infusing
"RTN","PSBVDLIV",53,0)
 .; (Is it not one time)&(Is it not active or renewed or On Call or Hold)
"RTN","PSBVDLIV",54,0)
 .Q:PSBSCHT'="O"&((PSBOSTS'="A")&(PSBOSTS'="R")&(PSBOSTS'="RE")&(PSBOSTS'="O")&(PSBOSTS'="D")&(PSBOSTS'="H")&(PSBOSTS'="E"))
"RTN","PSBVDLIV",55,0)
 .;
"RTN","PSBVDLIV",56,0)
 .; Is One Time Given
"RTN","PSBVDLIV",57,0)
 .;
"RTN","PSBVDLIV",58,0)
 .I PSBSCHT="O" D  Q:PSBGVN
"RTN","PSBVDLIV",59,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLIV",60,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLIV",61,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLIV",62,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBON,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLIV",63,0)
 .;
"RTN","PSBVDLIV",64,0)
 .; Is On-Call Given, Can it be given more than once
"RTN","PSBVDLIV",65,0)
 .;
"RTN","PSBVDLIV",66,0)
 .I PSBSCHT="OC" D  Q:PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))
"RTN","PSBVDLIV",67,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLIV",68,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLIV",69,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLIV",70,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBON,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLIV",71,0)
 .;
"RTN","PSBVDLIV",72,0)
OK .S PSBSTRT=PSBOST ; Order Start Date/Time
"RTN","PSBVDLIV",73,0)
 .S PSBSTOP=PSBOSP ; Order Stop Date/Time
"RTN","PSBVDLIV",74,0)
 .;
"RTN","PSBVDLIV",75,0)
 .S PSBREC=""
"RTN","PSBVDLIV",76,0)
 .S $P(PSBREC,U,1)=DFN ; dfn
"RTN","PSBVDLIV",77,0)
 .S $P(PSBREC,U,2)=PSBONX ; Order
"RTN","PSBVDLIV",78,0)
 .S $P(PSBREC,U,3)=+PSBON ; order ien
"RTN","PSBVDLIV",79,0)
 .S $P(PSBREC,U,4)=PSBOTYP ; iv/ud/pending
"RTN","PSBVDLIV",80,0)
 .S $P(PSBREC,U,5)=PSBSCHT ; schedule type
"RTN","PSBVDLIV",81,0)
 .S $P(PSBREC,U,6)=PSBSCH ; schedule
"RTN","PSBVDLIV",82,0)
 .S Y=""
"RTN","PSBVDLIV",83,0)
 .S:PSBSM Y="SM"
"RTN","PSBVDLIV",84,0)
 .S:PSBHSM Y="HSM"
"RTN","PSBVDLIV",85,0)
 .S $P(PSBREC,U,7)=Y ; self med
"RTN","PSBVDLIV",86,0)
 .S $P(PSBREC,U,8)=PSBOITX ; drugname
"RTN","PSBVDLIV",87,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ; dosage
"RTN","PSBVDLIV",88,0)
 .S $P(PSBREC,U,10)=PSBMR ; route
"RTN","PSBVDLIV",89,0)
 .; Last Given from the AOIP X-Ref - not given status not excepted
"RTN","PSBVDLIV",90,0)
 .;S (PSBCNT,PSBFLAG)=0,Y=""
"RTN","PSBVDLIV",91,0)
 .;F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,Y),-1) Q:Y=""  Q:PSBFLAG=1  D
"RTN","PSBVDLIV",92,0)
 .;S $P(PSBREC,U,11)=$S(Y:Y,1:"")
"RTN","PSBVDLIV",93,0)
 .;S X="" F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,Y,X),-1) Q:X=""  D
"RTN","PSBVDLIV",94,0)
 .;S PSBSTUS=$P(^PSB(53.79,X,0),U,9),$P(PSBREC,U,20)=PSBSTUS
"RTN","PSBVDLIV",95,0)
 .S $P(PSBREC,U,14)="" ; admin date inserted below
"RTN","PSBVDLIV",96,0)
 .S $P(PSBREC,U,15)=PSBOIT ; OI Pointer
"RTN","PSBVDLIV",97,0)
 .S $P(PSBREC,U,16)=0  ; Default to not injectable
"RTN","PSBVDLIV",98,0)
 .;S $P(PSBREC,U,16)="^IVP^IM^SC^"[PSBMR
"RTN","PSBVDLIV",99,0)
 .;Scan for injectable routes
"RTN","PSBVDLIV",100,0)
 .F X="ID","IV","IM","SC","SQ" D  Q:$P(PSBREC,U,16)
"RTN","PSBVDLIV",101,0)
 ..I PSBMR?@(".E1"""_X_""".E") S $P(PSBREC,U,16)=1
"RTN","PSBVDLIV",102,0)
 .; Variable dosage entered as ####-####?
"RTN","PSBVDLIV",103,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBVDLIV",104,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBVDLIV",105,0)
 .S $P(PSBREC,U,18)=PSBIVT  ;IV TYPE
"RTN","PSBVDLIV",106,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBVDLIV",107,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBVDLIV",108,0)
 .;
"RTN","PSBVDLIV",109,0)
 .; Gather Dispense Drugs
"RTN","PSBVDLIV",110,0)
 .D NOW^%DTC
"RTN","PSBVDLIV",111,0)
 .S (PSBDDS,PSBSOLS,PSBADDS)="0"
"RTN","PSBVDLIV",112,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBVDLIV",113,0)
 ..Q:$P(PSBDDA(Y),U,4)&($P(PSBDDA(Y),U,4)<%)  ; Inactive
"RTN","PSBVDLIV",114,0)
 ..S:$P(PSBDDA(Y),U,3)="" $P(PSBDDA(Y),U,3)=1
"RTN","PSBVDLIV",115,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,3)
"RTN","PSBVDLIV",116,0)
 ..S $P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBVDLIV",117,0)
 .; On-Call One Time PRN orders
"RTN","PSBVDLIV",118,0)
 .S PSBQRR=0
"RTN","PSBVDLIV",119,0)
 .I "^O^OC^P^"[(U_PSBSCHT_U) D  Q
"RTN","PSBVDLIV",120,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1,PSBDDS,PSBSOLS,PSBADDS,"IVTAB")
"RTN","PSBVDLIV",121,0)
 ..S:$G(PSBFON)'="" ^TMP("PSB",$J,"ON IVTAB",PSBDFN,PSBFON)=1  ; Now do not have to place "following order" on VDL!
"RTN","PSBVDLIV",122,0)
 .;
"RTN","PSBVDLIV",123,0)
 .; IV's - don't worry about admin times if blank
"RTN","PSBVDLIV",124,0)
 .I PSBONX["V",PSBIVT'="P",PSBADST="" D  Q
"RTN","PSBVDLIV",125,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"IVTAB")
"RTN","PSBVDLIV",126,0)
 ..S:$G(PSBFON)'="" ^TMP("PSB",$J,"ON IVTAB",PSBDFN,PSBFON)=1  ; Now do not have to place "following order" on VDL!
"RTN","PSBVDLIV",127,0)
 .;
"RTN","PSBVDLIV",128,0)
 .; Now we deal with only continuous
"RTN","PSBVDLIV",129,0)
 .; process admintimes
"RTN","PSBVDLIV",130,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBVDLIV",131,0)
 .S PSBADMIN=PSBADST
"RTN","PSBVDLIV",132,0)
 .; process admin times against beginning and ending date
"RTN","PSBVDLIV",133,0)
 .; build all orders for both days.
"RTN","PSBVDLIV",134,0)
 .;S PSBDAYS=$$DAYS(PSBSCH) ; Days between doses i.e. Q72H=3
"RTN","PSBVDLIV",135,0)
 .F PSBY=1:1 Q:$P(PSBADMIN,"-",PSBY)=""  D
"RTN","PSBVDLIV",136,0)
 ..; apply this time to the beginning window date
"RTN","PSBVDLIV",137,0)
 ..S PSB=+(PSBWBEG\1_"."_$P(PSBADMIN,"-",PSBY))
"RTN","PSBVDLIV",138,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLIV",139,0)
 ...D:(PSB'<PSBSTRT)&(PSB<PSBSTOP)  ; Make sure this time is active
"RTN","PSBVDLIV",140,0)
 ....D:$$OKAY^PSBVDLU1(PSBSTRT,$P(PSB,"."),PSBSCH,PSBON,PSBOITX,PSBFREQ)  ; Okay on this date?
"RTN","PSBVDLIV",141,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"IVTAB")
"RTN","PSBVDLIV",142,0)
 .....S:$G(PSBFON)'="" ^TMP("PSB",$J,"ON IVTAB",PSBDFN,PSBFON)=1  ; Now do not have to place "following order" on VDL!
"RTN","PSBVDLIV",143,0)
 ..;
"RTN","PSBVDLIV",144,0)
 ..Q:(PSBWBEG\1)=(PSBWEND\1)  ; Window only has one day rare but possible
"RTN","PSBVDLIV",145,0)
 ..;
"RTN","PSBVDLIV",146,0)
 ..; apply this time to the ending window date
"RTN","PSBVDLIV",147,0)
 ..S PSB=+(PSBWEND\1_"."_$P(PSBADMIN,"-",PSBY))
"RTN","PSBVDLIV",148,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLIV",149,0)
 ...D:(PSB'<PSBSTRT)&(PSB<PSBSTOP)  ; Make sure this time is active
"RTN","PSBVDLIV",150,0)
 ....D:$$OKAY^PSBVDLU1(PSBSTRT,$P(PSB,"."),PSBSCH,PSBON,PSBOITX,PSBFREQ)  ; Okay on this date?
"RTN","PSBVDLIV",151,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"IVTAB")
"RTN","PSBVDLIV",152,0)
 .....S:$G(PSBFON)'="" ^TMP("PSB",$J,"ON IVTAB",PSBDFN,PSBFON)=1  ; Now do not have to place "following order" on VDL!
"RTN","PSBVDLIV",153,0)
 K ^TMP("PSB",$J,"ON IVTAB")
"RTN","PSBVDLIV",154,0)
 ;
"RTN","PSBVDLIV",155,0)
 ;add initials of verifying pharmacist/verifying nurse
"RTN","PSBVDLIV",156,0)
 D VNURSE^PSBVDLU1("IVTAB")
"RTN","PSBVDLIV",157,0)
 Q
"RTN","PSBVDLIV",158,0)
 ;
"RTN","PSBVDLPB")
0^3^B65300302
"RTN","PSBVDLPB",1,0)
PSBVDLPB ;BIRMINGHAM/EFC-BCMA IV VIRTUAL DUE LIST ;May 2002
"RTN","PSBVDLPB",2,0)
 ;;2.0;BAR CODE MED ADMIN;**1,6,20**;May 2002
"RTN","PSBVDLPB",3,0)
 ;
"RTN","PSBVDLPB",4,0)
 ; Reference/IA
"RTN","PSBVDLPB",5,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLPB",6,0)
 ;
"RTN","PSBVDLPB",7,0)
EN(DFN,PSBDT) ; Default Order List Return for Today
"RTN","PSBVDLPB",8,0)
 ;
"RTN","PSBVDLPB",9,0)
 ; RPC: PSB GETORDERLIST
"RTN","PSBVDLPB",10,0)
 ;
"RTN","PSBVDLPB",11,0)
 ; Description:
"RTN","PSBVDLPB",12,0)
 ; Returns the current IV order set for today to display on the
"RTN","PSBVDLPB",13,0)
 ; client VDL
"RTN","PSBVDLPB",14,0)
 ;
"RTN","PSBVDLPB",15,0)
 ;
"RTN","PSBVDLPB",16,0)
 N PSBDATA
"RTN","PSBVDLPB",17,0)
 K ^TMP("PSB",$J,"PBTAB")
"RTN","PSBVDLPB",18,0)
 S ^TMP("PSB",$J,"PBTAB",0)=1
"RTN","PSBVDLPB",19,0)
 S ^TMP("PSB",$J,"PBTAB",1)="-1^No Active Orders at this Time."
"RTN","PSBVDLPB",20,0)
 ;
"RTN","PSBVDLPB",21,0)
 K ^TMP("PSJ",$J) D EN^PSJBCMA(DFN,PSBNOW,PSBTRDT)
"RTN","PSBVDLPB",22,0)
 ;
"RTN","PSBVDLPB",23,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 Q  ; No orders
"RTN","PSBVDLPB",24,0)
 ;
"RTN","PSBVDLPB",25,0)
 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:'PSBX  D
"RTN","PSBVDLPB",26,0)
 .D CLEAN^PSBVT
"RTN","PSBVDLPB",27,0)
 .D PSJ^PSBVT(PSBX)
"RTN","PSBVDLPB",28,0)
 .;
"RTN","PSBVDLPB",29,0)
 .; << Standard checks for ALL orders >>
"RTN","PSBVDLPB",30,0)
 .;
"RTN","PSBVDLPB",31,0)
 .Q:PSBONX["P"  ;     No Pending Orders
"RTN","PSBVDLPB",32,0)
 .Q:'$$IVPTAB^PSBVDLU3(PSBOTYP,PSBIVT,PSBISYR,PSBCHEMT,PSBMR)
"RTN","PSBVDLPB",33,0)
 .Q:PSBOST>PSBWADM  ; Order Start Date/Time > admin window
"RTN","PSBVDLPB",34,0)
 .Q:PSBOSP<PSBWBEG  ; For all Order Stop Date/Time < vdl window
"RTN","PSBVDLPB",35,0)
 .Q:PSBOSTS["D"  ;     Is it DC'd
"RTN","PSBVDLPB",36,0)
 .Q:PSBNGF  ;  Is it marked DO NOT GIVE!
"RTN","PSBVDLPB",37,0)
 .; Non One-Times with stop date/time < now
"RTN","PSBVDLPB",38,0)
 .;
"RTN","PSBVDLPB",39,0)
 .D NOW^%DTC
"RTN","PSBVDLPB",40,0)
 .Q:PSBOSP<%
"RTN","PSBVDLPB",41,0)
 .;
"RTN","PSBVDLPB",42,0)
 .; include Active, Renewed, ReInstated and On Call
"RTN","PSBVDLPB",43,0)
 .; (Is it not one time)&(Is it not active or renewed or On Call)
"RTN","PSBVDLPB",44,0)
 .Q:PSBSCHT'="O"&((PSBOSTS'="A")&(PSBOSTS'="R")&(PSBOSTS'="RE")&(PSBOSTS'="O")&(PSBOSTS'="H"))
"RTN","PSBVDLPB",45,0)
 .;
"RTN","PSBVDLPB",46,0)
 .; Is One Time Given
"RTN","PSBVDLPB",47,0)
 .;
"RTN","PSBVDLPB",48,0)
 .I PSBSCHT="O" D  Q:PSBGVN
"RTN","PSBVDLPB",49,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLPB",50,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLPB",51,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLPB",52,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLPB",53,0)
 .;
"RTN","PSBVDLPB",54,0)
 .; How long does One Time remain on VDL ?
"RTN","PSBVDLPB",55,0)
 .S PSBRMN=1
"RTN","PSBVDLPB",56,0)
 .I PSBSCHT="O",PSBOSP'=PSBOST,%>PSBOSP S PSBRMN=0
"RTN","PSBVDLPB",57,0)
 .Q:'PSBRMN
"RTN","PSBVDLPB",58,0)
 .;
"RTN","PSBVDLPB",59,0)
 .; Is On-Call Given, Can it be given more than once
"RTN","PSBVDLPB",60,0)
 .;
"RTN","PSBVDLPB",61,0)
 .I PSBSCHT="OC" D  Q:PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))
"RTN","PSBVDLPB",62,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLPB",63,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLPB",64,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLPB",65,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBON,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLPB",66,0)
 .;
"RTN","PSBVDLPB",67,0)
 .S PSBSTRT=PSBOST ; Order Start Date/Time
"RTN","PSBVDLPB",68,0)
 .S PSBSTOP=PSBOSP ; Order Stop Date/Time
"RTN","PSBVDLPB",69,0)
 .;
"RTN","PSBVDLPB",70,0)
 .S PSBREC=""
"RTN","PSBVDLPB",71,0)
 .S $P(PSBREC,U,1)=DFN ; dfn
"RTN","PSBVDLPB",72,0)
 .S $P(PSBREC,U,2)=PSBONX ; Order
"RTN","PSBVDLPB",73,0)
 .S $P(PSBREC,U,3)=+PSBON ; order ien
"RTN","PSBVDLPB",74,0)
 .S $P(PSBREC,U,4)=PSBOTYP ; iv/ud/pending
"RTN","PSBVDLPB",75,0)
 .S $P(PSBREC,U,5)=PSBSCHT ; schedule type
"RTN","PSBVDLPB",76,0)
 .S $P(PSBREC,U,6)=PSBSCH ; schedule
"RTN","PSBVDLPB",77,0)
 .S Y=""
"RTN","PSBVDLPB",78,0)
 .S:PSBSM Y="SM"
"RTN","PSBVDLPB",79,0)
 .S:PSBHSM Y="HSM"
"RTN","PSBVDLPB",80,0)
 .S $P(PSBREC,U,7)=Y ; self med
"RTN","PSBVDLPB",81,0)
 .S $P(PSBREC,U,8)=PSBOITX ; drugname
"RTN","PSBVDLPB",82,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ; dosage
"RTN","PSBVDLPB",83,0)
 .S $P(PSBREC,U,10)=PSBMR ; route
"RTN","PSBVDLPB",84,0)
 .; Last Given from the AOIP X-Ref - not given status not excepted
"RTN","PSBVDLPB",85,0)
 .S (PSBCNT,PSBFLAG)=0,Y=""
"RTN","PSBVDLPB",86,0)
 .F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,Y),-1) Q:Y=""  Q:PSBFLAG=1  D
"RTN","PSBVDLPB",87,0)
 ..S $P(PSBREC,U,11)=$S(Y:Y,1:"")
"RTN","PSBVDLPB",88,0)
 ..S X="" F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,Y,X),-1) Q:X=""  D
"RTN","PSBVDLPB",89,0)
 ...S PSBSTUS=$P(^PSB(53.79,X,0),U,9) I PSBSTUS'="N" S PSBFLAG=1
"RTN","PSBVDLPB",90,0)
 ...S $P(PSBREC,U,20)=$S(PSBSTUS="N":"",1:PSBSTUS)
"RTN","PSBVDLPB",91,0)
 ...D:PSBSTUS="N"
"RTN","PSBVDLPB",92,0)
 ....S $P(PSBREC,U,11)=""
"RTN","PSBVDLPB",93,0)
 ....;I PSBCNT=1 S PSBFLAG=1
"RTN","PSBVDLPB",94,0)
 ....S Z="" F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBVDLPB",95,0)
 .....I (PSBDATA["Set to 'NOT GIVEN'")!(PSBDATA["Set to 'GIVEN'")!(PSBDATA["Set to 'REFUSED'")!(PSBDATA["Set to 'HELD'")!(PSBDATA["Set to 'MISSING DOSE'")!(PSBDATA["Set to 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLPB",96,0)
 .....I (PSBDATA["STATUS 'HELD'")!(PSBDATA["STATUS 'GIVEN'")!(PSBDATA["STATUS 'REFUSED'")!(PSBDATA["STATUS 'MISSING DOSE'")!(PSBDATA["STATUS 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLPB",97,0)
 .....I PSBCNT#2=0,PSBDATA["'REFUSED'" S PSBSTUS="R",$P(PSBREC,U,20)=PSBSTUS D LAST^PSBVDLU1
"RTN","PSBVDLPB",98,0)
 .....I PSBCNT#2=0,PSBDATA["'HELD'" S PSBSTUS="H",$P(PSBREC,U,20)=PSBSTUS D LAST^PSBVDLU1
"RTN","PSBVDLPB",99,0)
 .....I PSBCNT#2=0,PSBDATA["'MISSING DOSE'" S PSBSTUS="M",$P(PSBREC,U,20)=PSBSTUS D LAST^PSBVDLU1
"RTN","PSBVDLPB",100,0)
 .....I PSBCNT#2=0,PSBDATA["'REMOVED'" S PSBSTUS="RM",$P(PSBREC,U,20)=PSBSTUS D LAST^PSBVDLU1
"RTN","PSBVDLPB",101,0)
 .S $P(PSBREC,U,12)=""  ; med log ien iserted below
"RTN","PSBVDLPB",102,0)
 .S $P(PSBREC,U,13)=""  ; med log status inserted below
"RTN","PSBVDLPB",103,0)
 .S $P(PSBREC,U,14)="" ; admin date inserted below
"RTN","PSBVDLPB",104,0)
 .S $P(PSBREC,U,15)=PSBOIT ; OI Pointer
"RTN","PSBVDLPB",105,0)
 .S $P(PSBREC,U,16)=0  ; Default to not injectable
"RTN","PSBVDLPB",106,0)
 .;S $P(PSBREC,U,16)="^IVP^IM^SC^"[PSBMR
"RTN","PSBVDLPB",107,0)
 .;Scan for injectable routes
"RTN","PSBVDLPB",108,0)
 .F X="ID","IV","IM","SC","SQ" D  Q:$P(PSBREC,U,16)
"RTN","PSBVDLPB",109,0)
 ..I PSBMR?@(".E1"""_X_""".E") S $P(PSBREC,U,16)=1
"RTN","PSBVDLPB",110,0)
 .; Variable dosage entered as ####-####?
"RTN","PSBVDLPB",111,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBVDLPB",112,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBVDLPB",113,0)
 .;S X=PSBDOSEF
"RTN","PSBVDLPB",114,0)
 .;S:X?1"CAP".E!(X?1"TAB".E) $P(PSBREC,U,18)=X ; Dosage form
"RTN","PSBVDLPB",115,0)
 .S $P(PSBREC,U,18)=PSBIVT  ;IV TYPE
"RTN","PSBVDLPB",116,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBVDLPB",117,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBVDLPB",118,0)
 .;
"RTN","PSBVDLPB",119,0)
 .; Gather Dispense Drugs
"RTN","PSBVDLPB",120,0)
 .D NOW^%DTC
"RTN","PSBVDLPB",121,0)
 .S (PSBDDS,PSBSOLS,PSBADDS)="0"
"RTN","PSBVDLPB",122,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBVDLPB",123,0)
 ..Q:$P(PSBDDA(Y),U,4)&($P(PSBDDA(Y),U,4)<%)  ; Inactive
"RTN","PSBVDLPB",124,0)
 ..S:$P(PSBDDA(Y),U,3)="" $P(PSBDDA(Y),U,3)=1
"RTN","PSBVDLPB",125,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,3)
"RTN","PSBVDLPB",126,0)
 ..S $P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBVDLPB",127,0)
 .; On-Call One Time PRN orders
"RTN","PSBVDLPB",128,0)
 .S PSBQRR=0
"RTN","PSBVDLPB",129,0)
 .I "^O^OC^P^"[(U_PSBSCHT_U) D  Q
"RTN","PSBVDLPB",130,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1,PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",131,0)
 .;
"RTN","PSBVDLPB",132,0)
 .; IV's - don't worry about admin times if blank
"RTN","PSBVDLPB",133,0)
 .I PSBONX["V","PSC"'[PSBIVT,PSBADST="" D  Q
"RTN","PSBVDLPB",134,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1_".",PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",135,0)
 .;
"RTN","PSBVDLPB",136,0)
 .; Now we deal with only continuous
"RTN","PSBVDLPB",137,0)
 .; process admintimes
"RTN","PSBVDLPB",138,0)
 .S (PSBYES,PSBODD)=0
"RTN","PSBVDLPB",139,0)
 .S PSBDOW="SU^MO^TU^WE^TH^FR^SA" F I=1:1:7 I $P(PSBDOW,"^",I)=$E(PSBSCH,1,2) S PSBYES=1
"RTN","PSBVDLPB",140,0)
 .I PSBYES,PSBADST="" D  Q
"RTN","PSBVDLPB",141,0)
 ..D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH)
"RTN","PSBVDLPB",142,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1
"RTN","PSBVDLPB",143,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBVDLPB",144,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBVDLPB",145,0)
 .I 'PSBYES,PSBADST="",PSBFREQ<1 D  Q
"RTN","PSBVDLPB",146,0)
 ..D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH)
"RTN","PSBVDLPB",147,0)
 .S PSBADMIN=PSBADST
"RTN","PSBVDLPB",148,0)
 .I (PSBADMIN="")&(+PSBFREQ>0) D ODDSCH^PSBVDLU1("PBTAB") Q  ;calculate admin times based on frequency
"RTN","PSBVDLPB",149,0)
 .; No admin times, MAYDAY MAYDAY!!
"RTN","PSBVDLPB",150,0)
 .I +PSBFREQ>0 D
"RTN","PSBVDLPB",151,0)
 ..I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBVDLPB",152,0)
 .I PSBODD,PSBADST'="" D  Q
"RTN","PSBVDLPB",153,0)
 ..D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH)
"RTN","PSBVDLPB",154,0)
 .; process admin times against beginning and ending date
"RTN","PSBVDLPB",155,0)
 .; build all orders for both days.
"RTN","PSBVDLPB",156,0)
 .;S PSBDAYS=$$DAYS(PSBSCH) ; Days between doses i.e. Q72H=3
"RTN","PSBVDLPB",157,0)
 .F PSBY=1:1 Q:$P(PSBADMIN,"-",PSBY)=""  D
"RTN","PSBVDLPB",158,0)
 ..;For invalid admin times
"RTN","PSBVDLPB",159,0)
 ..D:($P(PSBADST,"-",PSBY)'?2N)&($P(PSBADST,"-",PSBY)'?4N)
"RTN","PSBVDLPB",160,0)
 ...D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBVDLPB",161,0)
 ..; apply this time to the beginning window date
"RTN","PSBVDLPB",162,0)
 ..S PSB=+(PSBWBEG\1_"."_$P(PSBADMIN,"-",PSBY))
"RTN","PSBVDLPB",163,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLPB",164,0)
 ...D:(PSB'<PSBSTRT)&(PSB<PSBSTOP)  ; Make sure this time is active
"RTN","PSBVDLPB",165,0)
 ....D:$$OKAY^PSBVDLU1(PSBSTRT,PSB,PSBSCH,PSBON,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLPB",166,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",167,0)
 ..;
"RTN","PSBVDLPB",168,0)
 ..Q:(PSBWBEG\1)=(PSBWEND\1)  ; Window only has one day rare but possible
"RTN","PSBVDLPB",169,0)
 ..;
"RTN","PSBVDLPB",170,0)
 ..; apply this time to the ending window date
"RTN","PSBVDLPB",171,0)
 ..S PSB=+(PSBWEND\1_"."_$P(PSBADMIN,"-",PSBY))
"RTN","PSBVDLPB",172,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLPB",173,0)
 ...D:(PSB'<PSBSTRT)&(PSB<PSBSTOP)  ; Make sure this time is active
"RTN","PSBVDLPB",174,0)
 ....D:$$OKAY^PSBVDLU1(PSBSTRT,PSB,PSBSCH,PSBON,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLPB",175,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"PBTAB")
"RTN","PSBVDLPB",176,0)
 ;
"RTN","PSBVDLPB",177,0)
 ;add initials of verifying pharmacist/verifying nurse
"RTN","PSBVDLPB",178,0)
 D VNURSE^PSBVDLU1("PBTAB")
"RTN","PSBVDLPB",179,0)
 Q
"RTN","PSBVDLPB",180,0)
 ;
"RTN","PSBVDLTB")
0^1^B7112659
"RTN","PSBVDLTB",1,0)
PSBVDLTB ;BIRMINGHAM/EFC-BCMA VIRTUAL DUE LIST FUNCTIONS (CONT) ; 12/11/02 7:55am
"RTN","PSBVDLTB",2,0)
 ;;2.0;BAR CODE MED ADMIN;**1,15,20**;May 2002
"RTN","PSBVDLTB",3,0)
 ;
"RTN","PSBVDLTB",4,0)
 ; Reference/IA
"RTN","PSBVDLTB",5,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLTB",6,0)
 ; IN5^VADPT/10061
"RTN","PSBVDLTB",7,0)
 ;
"RTN","PSBVDLTB",8,0)
RPC(RESULTS,DFN,PSBTAB,PSBDT) ;
"RTN","PSBVDLTB",9,0)
 K RESULTS,^TMP("PSB",$J),^TMP("PSJ",$J)
"RTN","PSBVDLTB",10,0)
 N PSBCNT
"RTN","PSBVDLTB",11,0)
 S PSBTRFL=0
"RTN","PSBVDLTB",12,0)
 S RESULTS=$NAME(^TMP("PSB",$J,PSBTAB))
"RTN","PSBVDLTB",13,0)
 S PSBNOW=+$G(PSBDT)
"RTN","PSBVDLTB",14,0)
 I 'PSBNOW D NOW^%DTC S PSBNOW=+$E(%,1,10),PSBDT=$P(%,".",1)
"RTN","PSBVDLTB",15,0)
 D EN^PSJBCMA(DFN,PSBDT)
"RTN","PSBVDLTB",16,0)
 ; quit if no active orders
"RTN","PSBVDLTB",17,0)
 I $G(^TMP("PSJ",$J,1,0))=-1 D  K ^TMP("PSJ",$J) Q  ;No Orders
"RTN","PSBVDLTB",18,0)
 .S ^TMP("PSB",$J,PSBTAB,0)=1
"RTN","PSBVDLTB",19,0)
 .S ^TMP("PSB",$J,PSBTAB,1)=0_U_0_U_0_U_-1_U_"No Active Orders at this Time."
"RTN","PSBVDLTB",20,0)
 ;
"RTN","PSBVDLTB",21,0)
 ; use fileman function to determine window
"RTN","PSBVDLTB",22,0)
 S PSBWBEG=$$FMADD^XLFDT(PSBNOW,"",-12)
"RTN","PSBVDLTB",23,0)
 S PSBWEND=$$FMADD^XLFDT(PSBNOW,"",12)
"RTN","PSBVDLTB",24,0)
 ;
"RTN","PSBVDLTB",25,0)
 ; Create variable for valid order start date/time against admin window
"RTN","PSBVDLTB",26,0)
 S PSBWADM=$$GET^XPAR("DIV","PSB ADMIN BEFORE")
"RTN","PSBVDLTB",27,0)
 D NOW^%DTC S PSBWADM=$$FMADD^XLFDT(%,"","",+PSBWADM)
"RTN","PSBVDLTB",28,0)
 ;
"RTN","PSBVDLTB",29,0)
 ; use last movement for API
"RTN","PSBVDLTB",30,0)
 S VAIP("D")="LAST" D IN5^VADPT S PSBTRDT=+VAIP(3),PSBTRTYP=$P(VAIP(2),U,2),PSBMVTYP=$P(VAIP(4),U,2) K VAIP
"RTN","PSBVDLTB",31,0)
 ;
"RTN","PSBVDLTB",32,0)
 ;Get patient transfer notification timeframe to determine pop-up box
"RTN","PSBVDLTB",33,0)
 S PSBPTTR=$$GET^XPAR("DIV","PSB PATIENT TRANSFER") I PSBPTTR="" S PSBPTTR=72
"RTN","PSBVDLTB",34,0)
 D NOW^%DTC S PSBNTDT=$$FMADD^XLFDT(%,"",-PSBPTTR) I PSBNTDT'>PSBTRDT S PSBTRFL=1
"RTN","PSBVDLTB",35,0)
 ;determine order type and load to table
"RTN","PSBVDLTB",36,0)
 ;
"RTN","PSBVDLTB",37,0)
 D EN^PSBVDLUD(DFN,PSBDT),EN^PSBVDLIV(DFN,PSBDT),EN^PSBVDLPB(DFN,PSBDT)
"RTN","PSBVDLTB",38,0)
 S $P(PSBATAB,U,1)=$S($D(^TMP("PSB",$J,"UDTAB",2))>0:1,1:0)
"RTN","PSBVDLTB",39,0)
 S $P(PSBATAB,U,2)=$S($D(^TMP("PSB",$J,"PBTAB",2))>0:1,1:0)
"RTN","PSBVDLTB",40,0)
 S $P(PSBATAB,U,3)=$S($D(^TMP("PSB",$J,"IVTAB",2))>0:1,1:0)
"RTN","PSBVDLTB",41,0)
 S:PSBTAB="UDTAB" PSBCNT=$O(^TMP("PSB",$J,"UDTAB",""),-1)
"RTN","PSBVDLTB",42,0)
 S:PSBTAB="IVTAB" PSBCNT=$O(^TMP("PSB",$J,"IVTAB",""),-1)
"RTN","PSBVDLTB",43,0)
 S:PSBTAB="PBTAB" PSBCNT=$O(^TMP("PSB",$J,"PBTAB",""),-1)
"RTN","PSBVDLTB",44,0)
 I PSBCNT>0 S ^TMP("PSB",$J,PSBTAB,0)=PSBCNT
"RTN","PSBVDLTB",45,0)
 I PSBCNT>1 S ^TMP("PSB",$J,PSBTAB,1)=PSBATAB_U_$S(PSBTRFL:PSBTRTYP_U_PSBMVTYP,1:"")
"RTN","PSBVDLTB",46,0)
 I PSBCNT'>1 S ^TMP("PSB",$J,PSBTAB,1)=PSBATAB_U_^TMP("PSB",$J,PSBTAB,1)
"RTN","PSBVDLTB",47,0)
 F X="UDTAB","PBTAB","IVTAB" I X'=PSBTAB K ^TMP("PSB",$J,X)
"RTN","PSBVDLTB",48,0)
 D CLEAN^PSBVT K ^TMP("PSJ",$J),PSBATAB,PSBWADM,PSBWBEG,PSBWEND,PSBNOW,PSBTRDT,PSBUIDA2,PSBPTTR,PSBTRFL,PSBNTDT,PSBTRTYP,PSBMVTYP
"RTN","PSBVDLTB",49,0)
 Q
"RTN","PSBVDLU1")
0^5^B48961179
"RTN","PSBVDLU1",1,0)
PSBVDLU1 ;BIRMINGHAM/EFC- VIRTUAL DUE LIST (VDL) UTILITIES ; 12/11/02 7:44am
"RTN","PSBVDLU1",2,0)
 ;;2.0;BAR CODE MED ADMIN;**1,3,6,15,20**;May 2002
"RTN","PSBVDLU1",3,0)
 ;
"RTN","PSBVDLU1",4,0)
 ; Reference/IA
"RTN","PSBVDLU1",5,0)
 ; EN^PSJBCMA1/2829
"RTN","PSBVDLU1",6,0)
 ;
"RTN","PSBVDLU1",7,0)
ODDSCH(PSBTABX) ;
"RTN","PSBVDLU1",8,0)
 I (PSBOST'<PSBWBEG)&(PSBOST'>PSBWEND) D ADD(PSBREC,PSBOTXT,PSBOST,PSBDDS,PSBSOLS,PSBADDS,PSBTABX)  ;Include start date/time as admin
"RTN","PSBVDLU1",9,0)
 S PSBQUIT=0,PSBCDT=PSBOST F  S PSBCDT=$$FMADD^XLFDT(PSBCDT,"","",PSBFREQ) Q:PSBQUIT=1  D
"RTN","PSBVDLU1",10,0)
 .I $P(PSBCDT,".",2)="" S PSBCDT=PSBCDT-1_".24"
"RTN","PSBVDLU1",11,0)
 .I PSBCDT>PSBWEND S PSBQUIT=1 Q
"RTN","PSBVDLU1",12,0)
 .I PSBCDT'<PSBWBEG,PSBCDT<PSBOSP D ADD(PSBREC,PSBOTXT,PSBCDT,PSBDDS,PSBSOLS,PSBADDS,PSBTABX) Q
"RTN","PSBVDLU1",13,0)
 Q
"RTN","PSBVDLU1",14,0)
GETFREQ(PSBDFN,PSBORDN) ;
"RTN","PSBVDLU1",15,0)
 K ^TMP("PSJ1",$J)
"RTN","PSBVDLU1",16,0)
 D EN^PSJBCMA1(PSBDFN,PSBORDN,1)
"RTN","PSBVDLU1",17,0)
 S PSBFREQ=$P(^TMP("PSJ1",$J,4),U,11) K ^TMP("PSJ1",$J)
"RTN","PSBVDLU1",18,0)
 Q PSBFREQ
"RTN","PSBVDLU1",19,0)
 ;
"RTN","PSBVDLU1",20,0)
GETADMIN(PSBDFN,PSBORDN,PSBSTRT,PSBFREQ,PSBEVDT) ;
"RTN","PSBVDLU1",21,0)
 ;Determine administration times of an odd schedule for today
"RTN","PSBVDLU1",22,0)
 N PSBADMIN
"RTN","PSBVDLU1",23,0)
 K ^TMP("PSB",$J,"GETADMIN")
"RTN","PSBVDLU1",24,0)
 D EN^PSJBCMA1(PSBDFN,PSBORDN,1)
"RTN","PSBVDLU1",25,0)
 S PSBADMIN=$P(^TMP("PSJ1",$J,4),U,9),PSBFREQ=$P(^TMP("PSJ1",$J,4),U,11),^TMP("PSB",$J,"GETADMIN",0)=PSBADMIN
"RTN","PSBVDLU1",26,0)
 I $E(PSBFREQ)'?1N K ^TMP("PSJ1",$J) Q $G(^TMP("PSB",$J,"GETADMIN",0))
"RTN","PSBVDLU1",27,0)
 I PSBFREQ=0 K ^TMP("PSJ1",$J) Q $G(^TMP("PSB",$J,"GETADMIN",0))
"RTN","PSBVDLU1",28,0)
 I PSBSTRT'<PSBEVDT S PSBADMIN=$E($P(PSBSTRT,".",2)_"0000",1,4),^TMP("PSB",$J,"GETADMIN",0)=PSBADMIN
"RTN","PSBVDLU1",29,0)
 S PSBCDT=PSBSTRT,(PSBADTMX,PSBQUIT)=0 F  S PSBCDT=$$FMADD^XLFDT(PSBCDT,"","",PSBFREQ) D  Q:PSBQUIT=1
"RTN","PSBVDLU1",30,0)
 .I $P(PSBCDT,".",2)="" S PSBCDT=PSBCDT-1_".24"
"RTN","PSBVDLU1",31,0)
 .I (PSBCDT\1)>(PSBEVDT\1) S PSBQUIT=1 Q
"RTN","PSBVDLU1",32,0)
 .I (PSBCDT\1)=(PSBEVDT\1) S PSBADMIN=PSBADMIN_$S(PSBADMIN="":"",1:"-")_$E($P(PSBCDT,".",2)_"0000",1,4)
"RTN","PSBVDLU1",33,0)
 .S ^TMP("PSB",$J,"GETADMIN",PSBADTMX)=PSBADMIN
"RTN","PSBVDLU1",34,0)
 .S:($L(PSBADMIN)+5)>255 PSBADTMX=PSBADTMX+1,PSBADMIN=""
"RTN","PSBVDLU1",35,0)
 K ^TMP("PSJ1",$J),PSBADTMX
"RTN","PSBVDLU1",36,0)
 Q $G(^TMP("PSB",$J,"GETADMIN",0))
"RTN","PSBVDLU1",37,0)
 ;
"RTN","PSBVDLU1",38,0)
ADD(PSBREC,PSBSI,PSBDT,PSBDD,PSBSOL,PSBADD,PSBTAB) ;
"RTN","PSBVDLU1",39,0)
 ;
"RTN","PSBVDLU1",40,0)
 ; Description: Add order to ^TMP("PSB",$J,PSBTAB,...) for RPC Return RESULTS
"RTN","PSBVDLU1",41,0)
 ;
"RTN","PSBVDLU1",42,0)
 ; PSBREC=order hdr from above
"RTN","PSBVDLU1",43,0)
 ; PSBSI=special instructions
"RTN","PSBVDLU1",44,0)
 ; PSBDT=admin date/time
"RTN","PSBVDLU1",45,0)
 ; PSBDD=Dispense Drugs
"RTN","PSBVDLU1",46,0)
 ; PSBSOL=Solutions
"RTN","PSBVDLU1",47,0)
 ; PSBADD=Additives
"RTN","PSBVDLU1",48,0)
 ;
"RTN","PSBVDLU1",49,0)
 N PSB
"RTN","PSBVDLU1",50,0)
 S PSBDT=$E(PSBDT,1,12),PSBQR=0
"RTN","PSBVDLU1",51,0)
 S PSB=$O(^TMP("PSB",$J,PSBTAB,""),-1) ; Get next node
"RTN","PSBVDLU1",52,0)
 S $P(PSBREC,U,14)=PSBDT ; Admin Time sits in ^14
"RTN","PSBVDLU1",53,0)
 I $P(PSBREC,U,5)'="O" S X=$O(^PSB(53.79,"AORD",DFN,PSBONX,PSBDT,0)) D:X
"RTN","PSBVDLU1",54,0)
 .S $P(PSBREC,U,12)=X
"RTN","PSBVDLU1",55,0)
 .S PSBSTUS=$P(^PSB(53.79,X,0),U,9),$P(PSBREC,U,13)=$S(PSBSTUS="N":"",1:PSBSTUS),$P(PSBREC,U,23)=$P(^PSB(53.79,X,0),U,10),$P(PSBREC,U,24)=$P(^PSB(53.79,X,0),U,7)
"RTN","PSBVDLU1",56,0)
 .D:$D(^PSB(53.79,X))
"RTN","PSBVDLU1",57,0)
 ..I PSBDOSEF="PATCH",PSBSTUS="G",PSBDT=$P(^PSB(53.79,X,.1),U,3),PSBQRR=0 S PSBQR=1
"RTN","PSBVDLU1",58,0)
 .I PSBSTUS="G",$G(PSBFLAG) D CHECK ;Get the correct dispense drug
"RTN","PSBVDLU1",59,0)
 I ($P(PSBREC,U,5)="O") D
"RTN","PSBVDLU1",60,0)
 .S X=$O(^PSB(53.79,"AORDX",DFN,PSBONX,"")) Q:X=""
"RTN","PSBVDLU1",61,0)
 .S Y=$O(^PSB(53.79,"AORDX",DFN,PSBONX,X,"")) Q:Y=""  S $P(PSBREC,U,12)=Y
"RTN","PSBVDLU1",62,0)
 .S PSBSTUS=$P(^PSB(53.79,Y,0),U,9),$P(PSBREC,U,13)=$S(PSBSTUS="N":"",1:PSBSTUS),$P(PSBREC,U,24)=$P(^PSB(53.79,Y,0),U,7)
"RTN","PSBVDLU1",63,0)
 .D:$D(^PSB(53.79,Y))
"RTN","PSBVDLU1",64,0)
 ..I PSBDOSEF="PATCH",PSBSTUS="G",PSBDT=$P(^PSB(53.79,Y,.1),U,3),PSBQRR=0 S PSBQR=1
"RTN","PSBVDLU1",65,0)
 .I PSBSTUS="G",$G(PSBFLAG) D CHECK
"RTN","PSBVDLU1",66,0)
 Q:PSBQR=1
"RTN","PSBVDLU1",67,0)
 S $P(PSBREC,U,25)=0 I PSBTRFL,$P(PSBREC,U,11)]"",$P(PSBREC,U,11)'<PSBNTDT,$P(PSBREC,U,11)'>PSBTRDT S $P(PSBREC,U,25)=1
"RTN","PSBVDLU1",68,0)
 S PSB=PSB+1,^TMP("PSB",$J,PSBTAB,PSB)=PSBREC ; Order Hdr
"RTN","PSBVDLU1",69,0)
 S PSB=PSB+1,^TMP("PSB",$J,PSBTAB,PSB)=PSBSI ; Special Instructions
"RTN","PSBVDLU1",70,0)
 ; add dispense drugs
"RTN","PSBVDLU1",71,0)
 I $D(PSBDDA) S X="" F  S X=$O(PSBDDA(X)) Q:X=""  D
"RTN","PSBVDLU1",72,0)
 .S PSB=PSB+1,^TMP("PSB",$J,PSBTAB,PSB)=PSBDDA(X)
"RTN","PSBVDLU1",73,0)
 S PSBCHDT=0
"RTN","PSBVDLU1",74,0)
 I PSBONX["V",PSBOSTS="D",$G(PSBFOR)="" D  Q  ;get infusing bag from DCed but not DEed orders
"RTN","PSBVDLU1",75,0)
 .D PSJ^PSBVT(PSBX)
"RTN","PSBVDLU1",76,0)
 .D INFUSING^PSBVDLU2 I PSBCOMP=0 Q
"RTN","PSBVDLU1",77,0)
 .I $D(PSBSOLA) S X="" F  S X=$O(PSBSOLA(X)) Q:X=""  D
"RTN","PSBVDLU1",78,0)
 ..S PSB=PSB+1,^TMP("PSB",$J,PSBTAB,PSB)=PSBSOLA(X)
"RTN","PSBVDLU1",79,0)
 .I $D(PSBADA) S X="" F  S X=$O(PSBADA(X)) Q:X=""  D
"RTN","PSBVDLU1",80,0)
 ..S PSB=PSB+1,^TMP("PSB",$J,PSBTAB,PSB)=PSBADA(X)
"RTN","PSBVDLU1",81,0)
 .S X="" F  S X=$O(PSBPORA(PSBONX,X)) S PSBUID=$P(PSBPORA(PSBONX,X),U,1) Q:PSBUID]""  Q:X=""
"RTN","PSBVDLU1",82,0)
 .I PSBUID["P" Q
"RTN","PSBVDLU1",83,0)
 .I PSBUID["WS" D
"RTN","PSBVDLU1",84,0)
 ..S PSBNODE=$O(^PSB(53.79,"AUID",DFN,X,PSBUID,""))
"RTN","PSBVDLU1",85,0)
 ..S PSBUIDA(PSBUID)="ID"_U_PSBUID
"RTN","PSBVDLU1",86,0)
 ..S X=0 F  S X=$O(^PSB(53.79,PSBNODE,.6,X)) Q:'X  D
"RTN","PSBVDLU1",87,0)
 ...S PSBUIDA(PSBUID)=PSBUIDA(PSBUID)_U_"ADD;"_$P(^PSB(53.79,PSBNODE,.6,X,0),U,1)
"RTN","PSBVDLU1",88,0)
  ..S X=0 F  S X=$O(^PSB(53.79,PSBNODE,.7,X)) Q:'X  D
"RTN","PSBVDLU1",89,0)
  ...S PSBUIDA(PSBUID)=PSBUIDA(PSBUID)_U_"SOL;"_$P(^PSB(53.79,PSBNODE,.7,X,0),U,1)
"RTN","PSBVDLU1",90,0)
 .S PSBSONX=PSBONX
"RTN","PSBVDLU1",91,0)
 .I '$D(PSBUIDA(PSBUID)) D
"RTN","PSBVDLU1",92,0)
 ..S PSBCKOR="" F  S PSBCKOR=$O(PSBPORA(PSBSONX,PSBCKOR)) Q:PSBCKOR=""  D CLEAN^PSBVT,PSJ1^PSBVT(DFN,PSBCKOR) Q:$D(PSBUIDA(PSBUID))
"RTN","PSBVDLU1",93,0)
 .S PSBONX=PSBSONX
"RTN","PSBVDLU1",94,0)
 .S:$D(PSBUIDA(PSBUID)) PSB=PSB+2,^TMP("PSB",$J,PSBTAB,PSB-1)=PSBUIDA(PSBUID),^TMP("PSB",$J,PSBTAB,PSB)="END"
"RTN","PSBVDLU1",95,0)
 .S:'$D(PSBUIDA(PSBUID)) PSB=PSB+2,^TMP("PSB",$J,PSBTAB,PSB-1)=PSBUIDA2(PSBUID),^TMP("PSB",$J,PSBTAB,PSB)="END"
"RTN","PSBVDLU1",96,0)
 .D CLEAN^PSBVT,PSJ1^PSBVT(DFN,$O(PSBPORA("")))
"RTN","PSBVDLU1",97,0)
 ; add additives
"RTN","PSBVDLU1",98,0)
 I $D(PSBADA) S X="" F  S X=$O(PSBADA(X)) Q:X=""  D
"RTN","PSBVDLU1",99,0)
 .S PSB=PSB+1,^TMP("PSB",$J,PSBTAB,PSB)=PSBADA(X)
"RTN","PSBVDLU1",100,0)
 ; add solutions
"RTN","PSBVDLU1",101,0)
 I $D(PSBSOLA) S X="" F  S X=$O(PSBSOLA(X)) Q:X=""  D
"RTN","PSBVDLU1",102,0)
 .S PSB=PSB+1,^TMP("PSB",$J,PSBTAB,PSB)=PSBSOLA(X)
"RTN","PSBVDLU1",103,0)
 I PSBONX["V" D EN^PSBPOIV(DFN,PSBONX)  ; get bags
"RTN","PSBVDLU1",104,0)
 I $D(^TMP("PSBAR",$J)) S PSBUID=DFN_"V"_99999 F  S PSBUID=$O(^TMP("PSBAR",$J,PSBUID),-1) Q:PSBUID=""  D
"RTN","PSBVDLU1",105,0)
 .S PSBUIDS=^TMP("PSBAR",$J,PSBUID)
"RTN","PSBVDLU1",106,0)
 .I $P(PSBUIDS,U,1)="I",$P(PSBUIDS,U,2)'="I" Q  ; bag has invalid IV parameter
"RTN","PSBVDLU1",107,0)
 .I $P(PSBUIDS,U,2)'="I",$P(PSBUIDS,U,2)'="S",$P(PSBUIDS,U,8)'="" Q  ; label is no longer valid, bag is not infusing or stopped
"RTN","PSBVDLU1",108,0)
 .I $P(PSBUIDS,U,2)="C" Q  ; bag is completed
"RTN","PSBVDLU1",109,0)
 .I $P(PSBUIDS,U,2)="G" Q  ; bag is given (PBTAB)
"RTN","PSBVDLU1",110,0)
 .S PSB=PSB+1,^TMP("PSB",$J,PSBTAB,PSB)=$P(PSBUIDS,U,10,999)
"RTN","PSBVDLU1",111,0)
 K ^TMP("PSBAR",$J)
"RTN","PSBVDLU1",112,0)
 S PSB=PSB+1,^TMP("PSB",$J,PSBTAB,PSB)="END"
"RTN","PSBVDLU1",113,0)
 S ^TMP("PSB",$J,PSBTAB,0)=PSB
"RTN","PSBVDLU1",114,0)
 Q
"RTN","PSBVDLU1",115,0)
 ;
"RTN","PSBVDLU1",116,0)
CHECK S FILE=53.795,PSBNODE=.5,PSBIENS=X_","
"RTN","PSBVDLU1",117,0)
 F I=0:0 S I=$O(^PSB(53.79,X,PSBNODE,I)) Q:'I  D
"RTN","PSBVDLU1",118,0)
 .S $P(PSBDDS,U,3,4)=$$GET1^DIQ(FILE,I_","_PSBIENS,.01,"I")_U_$$GET1^DIQ(FILE,I_","_PSBIENS,.01)
"RTN","PSBVDLU1",119,0)
 Q
"RTN","PSBVDLU1",120,0)
 ;
"RTN","PSBVDLU1",121,0)
VNURSE(PSBTAB) ;add initials of verifying pharmacist/verifying nurse
"RTN","PSBVDLU1",122,0)
 F PSBLP=1:1:$P(^TMP("PSB",$J,PSBTAB,0),U,1) S X=^TMP("PSB",$J,PSBTAB,PSBLP) I $P(X,U)=DFN D
"RTN","PSBVDLU1",123,0)
 .K ^TMP("PSJ",$J)
"RTN","PSBVDLU1",124,0)
 .D PSJ1^PSBVT(DFN,$P(X,U,2))
"RTN","PSBVDLU1",125,0)
 .S $P(^TMP("PSB",$J,PSBTAB,PSBLP),U,19)=$S(PSBVNI]"":PSBVNI,1:"***")
"RTN","PSBVDLU1",126,0)
 K PSBLP,PSBTAB
"RTN","PSBVDLU1",127,0)
 Q
"RTN","PSBVDLU1",128,0)
 ;
"RTN","PSBVDLU1",129,0)
OKAY(PSBSTRT,PSBADMIN,PSBSCH,PSBORDER,PSBDRUG,PSBFREQ,PSBOSTS) ;
"RTN","PSBVDLU1",130,0)
 ;
"RTN","PSBVDLU1",131,0)
 ; Description: Determines if an order schedule is valid for
"RTN","PSBVDLU1",132,0)
 ;  the date in PSBADMIN (i.e. Q4D, is it valid today)
"RTN","PSBVDLU1",133,0)
 ;
"RTN","PSBVDLU1",134,0)
 ; PSBSTRT:  Start Date of order (Time ignored)
"RTN","PSBVDLU1",135,0)
 ; PSBADMIN: Date of administration to check (Time ignored)
"RTN","PSBVDLU1",136,0)
 ; PSBSCH:  Schedule (i.e. MO-WE-FR@0900 or Q48H...)
"RTN","PSBVDLU1",137,0)
 ; PSBORDER: Order reference
"RTN","PSBVDLU1",138,0)
 ; PSBDRUG:  Drug ordered (Orderable Item)
"RTN","PSBVDLU1",139,0)
 ; PSBOSTS: The status of the order
"RTN","PSBVDLU1",140,0)
 ;
"RTN","PSBVDLU1",141,0)
 N PSBOKAY,PSBDAYS,PSBDOW
"RTN","PSBVDLU1",142,0)
 S PSBOSTS=$G(PSBOSTS)
"RTN","PSBVDLU1",143,0)
 ;
"RTN","PSBVDLU1",144,0)
 S PSBOKAY=0  ; Default Flag
"RTN","PSBVDLU1",145,0)
 I PSBFREQ'="",PSBFREQ'="D",PSBFREQ'>1440 Q 1
"RTN","PSBVDLU1",146,0)
 S PSBDAYS=$$DAYS(PSBSCH)
"RTN","PSBVDLU1",147,0)
 ;
"RTN","PSBVDLU1",148,0)
 I PSBDAYS=1 S PSBOKAY=1 Q PSBOKAY  ; Order is everyday
"RTN","PSBVDLU1",149,0)
 ;
"RTN","PSBVDLU1",150,0)
 ; find out if today is a good day for multi days
"RTN","PSBVDLU1",151,0)
 I PSBDAYS>1 D  Q PSBOKAY
"RTN","PSBVDLU1",152,0)
 .S X1=PSBADMIN\1,X2=PSBSTRT\1 D ^%DTC
"RTN","PSBVDLU1",153,0)
 .S PSBOKAY=$S(X=0:1,(X#PSBDAYS)&(X'=$P(PSBDAYS,".")):0,1:1)
"RTN","PSBVDLU1",154,0)
 ;
"RTN","PSBVDLU1",155,0)
 ; Try the MO-WE-FR@0800 thing as last resort
"RTN","PSBVDLU1",156,0)
 S X=PSBADMIN D H^%DTC I %Y=-1 D  Q  ; Error beyond belief
"RTN","PSBVDLU1",157,0)
 .S PSBOKAY=0
"RTN","PSBVDLU1",158,0)
 .Q:PSBOSTS="E"
"RTN","PSBVDLU1",159,0)
 .D ERROR^PSBMLU($G(PSBORDER,"UNKNOWN"),$G(PSBDRUG,""),DFN,"Unable to determine schedule "_PSBSCH,PSBSCH)
"RTN","PSBVDLU1",160,0)
 S PSBDOW=$P("SU^MO^TU^WE^TH^FR^SA",U,%Y+1)
"RTN","PSBVDLU1",161,0)
 I $F(PSBSCH,PSBDOW)>0 S PSBOKAY=1 Q PSBOKAY
"RTN","PSBVDLU1",162,0)
 S PSBOKAY=0
"RTN","PSBVDLU1",163,0)
 Q PSBOKAY
"RTN","PSBVDLU1",164,0)
 ;
"RTN","PSBVDLU1",165,0)
DAYS(PSB) ; Return days between doses (-1: error, 1:everyday 2: QOD...)
"RTN","PSBVDLU1",166,0)
 ;
"RTN","PSBVDLU1",167,0)
 ; Is it a PRN
"RTN","PSBVDLU1",168,0)
 I PSB?.E1"PRN".E Q 1  ; Straight PRN - As Needed
"RTN","PSBVDLU1",169,0)
 ;
"RTN","PSBVDLU1",170,0)
 S PSB=$TR(PSB," ","")
"RTN","PSBVDLU1",171,0)
 I PSB?2.4N.E Q 1
"RTN","PSBVDLU1",172,0)
 S X=PSBFREQ/1440 Q X
"RTN","PSBVDLU1",173,0)
 ;
"RTN","PSBVDLU1",174,0)
 Q
"RTN","PSBVDLU1",175,0)
 ;
"RTN","PSBVDLU1",176,0)
LAST ;
"RTN","PSBVDLU1",177,0)
 S PSBCC=0
"RTN","PSBVDLU1",178,0)
 S ZZ="" F  S ZZ=$O(^PSB(53.79,X,.3,ZZ),-1) Q:'ZZ  Q:PSBFLAG=1  S PSBDATA2=$G(^(ZZ,0)) D
"RTN","PSBVDLU1",179,0)
 .S PSBCC=PSBCC+1
"RTN","PSBVDLU1",180,0)
 .I PSBCC=2 S $P(PSBREC,U,11)=$P(PSBDATA2,U,3),PSBFLAG=1
"RTN","PSBVDLU1",181,0)
 Q
"RTN","PSBVDLU1",182,0)
 ;
"RTN","PSBVDLUD")
0^2^B61956220
"RTN","PSBVDLUD",1,0)
PSBVDLUD ;BIRMINGHAM/EFC-BCMA UNIT DOSE VIRTUAL DUE LIST FUNCTIONS ;May 2002
"RTN","PSBVDLUD",2,0)
 ;;2.0;BAR CODE MED ADMIN;**6,20**;May 2002
"RTN","PSBVDLUD",3,0)
 ;
"RTN","PSBVDLUD",4,0)
 ; Reference/IA
"RTN","PSBVDLUD",5,0)
 ; EN^PSJBCMA/2828
"RTN","PSBVDLUD",6,0)
 ;
"RTN","PSBVDLUD",7,0)
EN(DFN,PSBDT) ;
"RTN","PSBVDLUD",8,0)
 ;
"RTN","PSBVDLUD",9,0)
 ;
"RTN","PSBVDLUD",10,0)
 ; Description:
"RTN","PSBVDLUD",11,0)
 ; Returns the current unit dose order set for today to display
"RTN","PSBVDLUD",12,0)
 ; on the client VDL
"RTN","PSBVDLUD",13,0)
 ;
"RTN","PSBVDLUD",14,0)
 N PSBDATA
"RTN","PSBVDLUD",15,0)
 K ^TMP("PSB",$J,"UDTAB")
"RTN","PSBVDLUD",16,0)
 S ^TMP("PSB",$J,"UDTAB",0)=1
"RTN","PSBVDLUD",17,0)
 S ^TMP("PSB",$J,"UDTAB",1)="-1^No Active Orders at this Time."
"RTN","PSBVDLUD",18,0)
 ;
"RTN","PSBVDLUD",19,0)
 K ^TMP("PSJ",$J) D EN^PSJBCMA(DFN,PSBNOW,PSBTRDT)
"RTN","PSBVDLUD",20,0)
 ;
"RTN","PSBVDLUD",21,0)
 I $G(^TMP("PSJ",$J,1,0))=-1  Q  ; No orders
"RTN","PSBVDLUD",22,0)
 ;
"RTN","PSBVDLUD",23,0)
 F PSBX=0:0 S PSBX=$O(^TMP("PSJ",$J,PSBX)) Q:'PSBX  D
"RTN","PSBVDLUD",24,0)
 .D CLEAN^PSBVT
"RTN","PSBVDLUD",25,0)
 .D PSJ^PSBVT(PSBX)
"RTN","PSBVDLUD",26,0)
 .;
"RTN","PSBVDLUD",27,0)
 .; << Standard checks for ALL orders >>
"RTN","PSBVDLUD",28,0)
 .;
"RTN","PSBVDLUD",29,0)
 .Q:PSBONX["V"  ;No IVs on UD tab
"RTN","PSBVDLUD",30,0)
 .Q:PSBONX["P"  ;     No Pending Orders
"RTN","PSBVDLUD",31,0)
 .Q:PSBOST>PSBWADM  ; Order Start Date/Time > admin window
"RTN","PSBVDLUD",32,0)
 .Q:PSBOSP<PSBWBEG  ; For Non one-times Order Stop Date/Time < vdl window
"RTN","PSBVDLUD",33,0)
 .Q:PSBOSTS["D"  ;     Is it DC'd
"RTN","PSBVDLUD",34,0)
 .Q:PSBNGF  ;         Is it marked DO NOT GIVE!
"RTN","PSBVDLUD",35,0)
 .Q:PSBMR="IVP"!(PSBMR="IV PUSH")
"RTN","PSBVDLUD",36,0)
 .;
"RTN","PSBVDLUD",37,0)
 .; Non One-Times with stop date/time < now
"RTN","PSBVDLUD",38,0)
 .;
"RTN","PSBVDLUD",39,0)
 .D NOW^%DTC
"RTN","PSBVDLUD",40,0)
 .Q:PSBOSP<%
"RTN","PSBVDLUD",41,0)
 .;
"RTN","PSBVDLUD",42,0)
 .; include Active, Renewed, ReInstated and On Call
"RTN","PSBVDLUD",43,0)
 .; (Is it not one time)&(Is it not active or renewed or On Call)
"RTN","PSBVDLUD",44,0)
 .I PSBSCHT'="O",PSBOSTS'="A",PSBOSTS'="H",PSBOSTS'="R",PSBOSTS'="RE",PSBOSTS'="O" Q
"RTN","PSBVDLUD",45,0)
 .;
"RTN","PSBVDLUD",46,0)
 .; Is One Time Given
"RTN","PSBVDLUD",47,0)
 .;
"RTN","PSBVDLUD",48,0)
 .I PSBSCHT="O" D  Q:PSBGVN
"RTN","PSBVDLUD",49,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLUD",50,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLUD",51,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLUD",52,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLUD",53,0)
 .;
"RTN","PSBVDLUD",54,0)
 .; How long does One Time remain on VDL ??
"RTN","PSBVDLUD",55,0)
 .S PSBRMN=1
"RTN","PSBVDLUD",56,0)
 .I PSBSCHT="O",PSBOSP'=PSBOST&(%>PSBOSP) S PSBRMN=0
"RTN","PSBVDLUD",57,0)
 .Q:'PSBRMN
"RTN","PSBVDLUD",58,0)
 .; Is On-Call Given, Can it be given more than once
"RTN","PSBVDLUD",59,0)
 .;
"RTN","PSBVDLUD",60,0)
 .I PSBSCHT="OC" D  Q:PSBGVN&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL"))
"RTN","PSBVDLUD",61,0)
 ..S (PSBGVN,X,Y)=""
"RTN","PSBVDLUD",62,0)
 ..F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X),-1) Q:'X  D
"RTN","PSBVDLUD",63,0)
 ...F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,X,Y),-1) Q:'Y  D
"RTN","PSBVDLUD",64,0)
 ....I $P(^PSB(53.79,Y,.1),U)=PSBONX,$P(^PSB(53.79,Y,0),U,9)="G" S PSBGVN=1,(X,Y)=0
"RTN","PSBVDLUD",65,0)
 .;
"RTN","PSBVDLUD",66,0)
 .S PSBREC=""
"RTN","PSBVDLUD",67,0)
 .S $P(PSBREC,U,1)=DFN ; dfn
"RTN","PSBVDLUD",68,0)
 .S $P(PSBREC,U,2)=PSBONX ; order
"RTN","PSBVDLUD",69,0)
 .S $P(PSBREC,U,3)=PSBON ; order ien
"RTN","PSBVDLUD",70,0)
 .S $P(PSBREC,U,4)=PSBOTYP ; iv/ud/pending
"RTN","PSBVDLUD",71,0)
 .S $P(PSBREC,U,5)=PSBSCHT ; schedule type
"RTN","PSBVDLUD",72,0)
 .S $P(PSBREC,U,6)=PSBSCH ; schedule
"RTN","PSBVDLUD",73,0)
 .S $P(PSBREC,U,7)=$S(PSBHSM:"HSM",PSBSM:"SM",1:"") ; self med
"RTN","PSBVDLUD",74,0)
 .S $P(PSBREC,U,8)=PSBOITX ; drugname
"RTN","PSBVDLUD",75,0)
 .S $P(PSBREC,U,9)=PSBDOSE_" "_PSBIFR ; dosage
"RTN","PSBVDLUD",76,0)
 .S $P(PSBREC,U,10)=PSBMR ; route
"RTN","PSBVDLUD",77,0)
 .; Last Given from the AOIP X-Ref - not given status not excepted
"RTN","PSBVDLUD",78,0)
 .S (PSBCNT,PSBFLAG)=0,Y=""
"RTN","PSBVDLUD",79,0)
 .F  S Y=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,Y),-1) Q:Y=""  Q:PSBFLAG=1  D
"RTN","PSBVDLUD",80,0)
 ..S $P(PSBREC,U,11)=$S(Y:Y,1:"")
"RTN","PSBVDLUD",81,0)
 ..S X="" F  S X=$O(^PSB(53.79,"AOIP",DFN,PSBOIT,Y,X),-1) Q:X=""  D
"RTN","PSBVDLUD",82,0)
 ...S PSBSTUS=$P(^PSB(53.79,X,0),U,9) I PSBSTUS'="N" S PSBFLAG=1
"RTN","PSBVDLUD",83,0)
 ...S $P(PSBREC,U,20)=$S(PSBSTUS="N":"",1:PSBSTUS)
"RTN","PSBVDLUD",84,0)
 ...D:PSBSTUS="N"
"RTN","PSBVDLUD",85,0)
 ....S $P(PSBREC,U,11)=""
"RTN","PSBVDLUD",86,0)
 ....;I PSBCNT=1 S PSBFLAG=1
"RTN","PSBVDLUD",87,0)
 ....S Z="" F  S Z=$O(^PSB(53.79,X,.9,Z),-1) Q:'Z  Q:PSBFLAG=1  S PSBDATA=$G(^(Z,0)) D
"RTN","PSBVDLUD",88,0)
 .....I (PSBDATA["Set to 'NOT GIVEN'")!(PSBDATA["Set to 'GIVEN'")!(PSBDATA["Set to 'REFUSED'")!(PSBDATA["Set to 'HELD'")!(PSBDATA["Set to 'MISSING DOSE'")!(PSBDATA["Set to 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLUD",89,0)
 .....I (PSBDATA["STATUS 'HELD'")!(PSBDATA["STATUS 'GIVEN'")!(PSBDATA["STATUS 'REFUSED'")!(PSBDATA["STATUS 'MISSING DOSE'")!(PSBDATA["STATUS 'REMOVED'") S PSBCNT=PSBCNT+1
"RTN","PSBVDLUD",90,0)
 .....I PSBCNT#2=0,PSBDATA["'REFUSED'" S PSBSTUS="R",$P(PSBREC,U,20)=PSBSTUS D LAST^PSBVDLU1
"RTN","PSBVDLUD",91,0)
 .....I PSBCNT#2=0,PSBDATA["'HELD'" S PSBSTUS="H",$P(PSBREC,U,20)=PSBSTUS D LAST^PSBVDLU1
"RTN","PSBVDLUD",92,0)
 .....I PSBCNT#2=0,PSBDATA["'MISSING DOSE'" S PSBSTUS="M",$P(PSBREC,U,20)=PSBSTUS D LAST^PSBVDLU1
"RTN","PSBVDLUD",93,0)
 .....I PSBCNT#2=0,PSBDATA["'REMOVED'" S PSBSTUS="RM",$P(PSBREC,U,20)=PSBSTUS D LAST^PSBVDLU1
"RTN","PSBVDLUD",94,0)
 .S $P(PSBREC,U,12)=""  ;med log ien inserted below for actual date
"RTN","PSBVDLUD",95,0)
 .S $P(PSBREC,U,13)=""  ;med log status inserted below for actual date
"RTN","PSBVDLUD",96,0)
 .S $P(PSBREC,U,14)="" ; admin date inserted below
"RTN","PSBVDLUD",97,0)
 .S $P(PSBREC,U,15)=PSBOIT ; OI Pointer
"RTN","PSBVDLUD",98,0)
 .S $P(PSBREC,U,16)=0  ; Default to not injectable
"RTN","PSBVDLUD",99,0)
 .F X="ID","IV","IM","SC","SQ" D  Q:$P(PSBREC,U,16)
"RTN","PSBVDLUD",100,0)
 ..I PSBMR?@(".E1"""_X_""".E"),PSBMR'["MISC" S $P(PSBREC,U,16)=1
"RTN","PSBVDLUD",101,0)
 .; Variable dosage entered as ####-####?
"RTN","PSBVDLUD",102,0)
 .I $P(PSBREC,U,9)?1.4N1"-"1.4N.E S $P(PSBREC,U,17)=1
"RTN","PSBVDLUD",103,0)
 .E  S $P(PSBREC,U,17)=0
"RTN","PSBVDLUD",104,0)
 .S:PSBDOSEF?1"CAP".E!(PSBDOSEF?1"TAB".E)!(PSBDOSEF="PATCH") $P(PSBREC,U,18)=PSBDOSEF ; Dosage form
"RTN","PSBVDLUD",105,0)
 .S $P(PSBREC,U,21)=PSBOST
"RTN","PSBVDLUD",106,0)
 .S $P(PSBREC,U,22)=PSBOSTS
"RTN","PSBVDLUD",107,0)
 .;
"RTN","PSBVDLUD",108,0)
 .; Gather Dispense Drugs
"RTN","PSBVDLUD",109,0)
 .D NOW^%DTC
"RTN","PSBVDLUD",110,0)
 .S (PSBDDS,PSBSOLS,PSBADDS,PSBFLAG)="0"
"RTN","PSBVDLUD",111,0)
 .F Y=0:0 S Y=$O(PSBDDA(Y)) Q:'Y  D
"RTN","PSBVDLUD",112,0)
 ..I $P(PSBDDA(Y),U,5)=$P(%,".") S PSBFLAG=1 ;If drug was inactivated
"RTN","PSBVDLUD",113,0)
 ..Q:$P(PSBDDA(Y),U,5)&($P(PSBDDA(Y),U,5)<%)  ; Inactive
"RTN","PSBVDLUD",114,0)
 ..S:$P(PSBDDA(Y),U,4)="" $P(PSBDDA(Y),U,4)=1
"RTN","PSBVDLUD",115,0)
 ..S PSBDDS=PSBDDS_U_$P(PSBDDA(Y),U,1,4)
"RTN","PSBVDLUD",116,0)
 ..S $P(PSBDDS,U,1)=PSBDDS+1
"RTN","PSBVDLUD",117,0)
 .;
"RTN","PSBVDLUD",118,0)
 .; On-Call One Time PRN orders
"RTN","PSBVDLUD",119,0)
 .S PSBQRR=0
"RTN","PSBVDLUD",120,0)
 .I "^O^OC^P^"[(U_PSBSCHT_U) D  Q
"RTN","PSBVDLUD",121,0)
 ..D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSBNOW\1,PSBDDS,PSBSOLS,PSBADDS,"UDTAB")
"RTN","PSBVDLUD",122,0)
 .;
"RTN","PSBVDLUD",123,0)
 .; Now we deal with only continuous
"RTN","PSBVDLUD",124,0)
 .; process admintimes
"RTN","PSBVDLUD",125,0)
 .; Display an order on the VDL based on the frequency received from IPM **PSB*2.0*3
"RTN","PSBVDLUD",126,0)
 .S (PSBYES,PSBODD)=0
"RTN","PSBVDLUD",127,0)
 .I PSBSCH="" D
"RTN","PSBVDLUD",128,0)
 ..D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"No Schedule on this order")
"RTN","PSBVDLUD",129,0)
 .S PSBDOW="SU^MO^TU^WE^TH^FR^SA" F I=1:1:7 I $P(PSBDOW,"^",I)=$E(PSBSCH,1,2) S PSBYES=1
"RTN","PSBVDLUD",130,0)
 .I PSBYES,PSBADST="" D  Q
"RTN","PSBVDLUD",131,0)
 ..D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Admin times required",PSBSCH)
"RTN","PSBVDLUD",132,0)
 .F I=1:1 Q:$P(PSBSCH,"-",I)=""  I $P(PSBSCH,"-",I)?2N!($P(PSBSCH,"-",I)?4N) S PSBYES=1
"RTN","PSBVDLUD",133,0)
 .S PSBFREQ=$$GETFREQ^PSBVDLU1(DFN,PSBONX)
"RTN","PSBVDLUD",134,0)
 .I PSBFREQ="O" S PSBFREQ=1440
"RTN","PSBVDLUD",135,0)
 .I 'PSBYES,PSBADST="",PSBFREQ<1 D  Q
"RTN","PSBVDLUD",136,0)
 ..D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid frequency received from order",PSBSCH)
"RTN","PSBVDLUD",137,0)
 .I (PSBADST="")&(+PSBFREQ>0) D ODDSCH^PSBVDLU1("UDTAB") Q  ;calculate admin times based on frequency
"RTN","PSBVDLUD",138,0)
 .; No admin times, MAYDAY MAYDAY!!
"RTN","PSBVDLUD",139,0)
 .I +PSBFREQ>0 D
"RTN","PSBVDLUD",140,0)
 ..I (PSBFREQ#1440'=0),(1440#PSBFREQ'=0) S PSBODD=1
"RTN","PSBVDLUD",141,0)
 .I PSBODD,PSBADST'="" D  Q
"RTN","PSBVDLUD",142,0)
 ..D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Administration Times on ODD SCHEDULE",PSBSCH)
"RTN","PSBVDLUD",143,0)
 .; process admin times against beginning and ending date
"RTN","PSBVDLUD",144,0)
 .; build all orders for both days.
"RTN","PSBVDLUD",145,0)
 .F PSBY=1:1 Q:$P(PSBADST,"-",PSBY)=""  D
"RTN","PSBVDLUD",146,0)
 ..;For invalid admin times
"RTN","PSBVDLUD",147,0)
 ..D:($P(PSBADST,"-",PSBY)'?2N)&($P(PSBADST,"-",PSBY)'?4N)
"RTN","PSBVDLUD",148,0)
 ...D ERROR^PSBMLU(PSBONX,PSBOITX,DFN,"Invalid Admin times",PSBSCH)
"RTN","PSBVDLUD",149,0)
 ..; apply this time to the beginning window date
"RTN","PSBVDLUD",150,0)
 ..S PSB=+(PSBWBEG\1_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBVDLUD",151,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLUD",152,0)
 ...D:(PSB'<PSBOST)&(PSB<PSBOSP)  ; Make sure this time is active
"RTN","PSBVDLUD",153,0)
 ....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLUD",154,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"UDTAB")
"RTN","PSBVDLUD",155,0)
 ..;
"RTN","PSBVDLUD",156,0)
 ..Q:(PSBWBEG\1)=(PSBWEND\1)  ; Window only has one day rare but possible
"RTN","PSBVDLUD",157,0)
 ..;
"RTN","PSBVDLUD",158,0)
 ..; apply this time to the ending window date
"RTN","PSBVDLUD",159,0)
 ..S PSB=+(PSBWEND\1_"."_$P(PSBADST,"-",PSBY))
"RTN","PSBVDLUD",160,0)
 ..D:(PSB'<PSBWBEG)&(PSB'>PSBWEND)  ; Make sure it is in the window
"RTN","PSBVDLUD",161,0)
 ...D:(PSB'<PSBOST)&(PSB<PSBOSP)  ; Make sure this time is active
"RTN","PSBVDLUD",162,0)
 ....D:$$OKAY^PSBVDLU1(PSBOST,PSB,PSBSCH,PSBONX,PSBOITX,PSBFREQ,PSBOSTS)  ; Okay on this date?
"RTN","PSBVDLUD",163,0)
 .....D ADD^PSBVDLU1(PSBREC,PSBOTXT,PSB,PSBDDS,PSBSOLS,PSBADDS,"UDTAB")
"RTN","PSBVDLUD",164,0)
 .K PSBSTUS
"RTN","PSBVDLUD",165,0)
 K PSBREC D EN^PSBVDLPA
"RTN","PSBVDLUD",166,0)
 ;add initials of verifying pharmacist/verifying nurse
"RTN","PSBVDLUD",167,0)
 D VNURSE^PSBVDLU1("UDTAB")
"RTN","PSBVDLUD",168,0)
 D CLEAN^PSBVT
"RTN","PSBVDLUD",169,0)
 Q
"RTN","PSBVDLUD",170,0)
 ;
"VER")
8.0^22.0
**END**
**END**
