Released PSB*3*31 SEQ #29
Extracted from mail message
**KIDS**:PSB*3.0*31^

**INSTALL NAME**
PSB*3.0*31
"BLD",6499,0)
PSB*3.0*31^BAR CODE MED ADMIN^0^3070828^y
"BLD",6499,1,0)
^^1^1^3070828^
"BLD",6499,1,1,0)
Can't enter Manual Med entry for discharged patient.
"BLD",6499,4,0)
^9.64PA^^
"BLD",6499,6.3)
1
"BLD",6499,"KRN",0)
^9.67PA^8989.52^19
"BLD",6499,"KRN",.4,0)
.4
"BLD",6499,"KRN",.401,0)
.401
"BLD",6499,"KRN",.402,0)
.402
"BLD",6499,"KRN",.403,0)
.403
"BLD",6499,"KRN",.5,0)
.5
"BLD",6499,"KRN",.84,0)
.84
"BLD",6499,"KRN",3.6,0)
3.6
"BLD",6499,"KRN",3.8,0)
3.8
"BLD",6499,"KRN",9.2,0)
9.2
"BLD",6499,"KRN",9.8,0)
9.8
"BLD",6499,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",6499,"KRN",9.8,"NM",1,0)
PSBVAR^^0^B13715777
"BLD",6499,"KRN",9.8,"NM",2,0)
PSBVITFL^^0^B4992078
"BLD",6499,"KRN",9.8,"NM","B","PSBVAR",1)

"BLD",6499,"KRN",9.8,"NM","B","PSBVITFL",2)

"BLD",6499,"KRN",19,0)
19
"BLD",6499,"KRN",19.1,0)
19.1
"BLD",6499,"KRN",101,0)
101
"BLD",6499,"KRN",409.61,0)
409.61
"BLD",6499,"KRN",771,0)
771
"BLD",6499,"KRN",870,0)
870
"BLD",6499,"KRN",8989.51,0)
8989.51
"BLD",6499,"KRN",8989.52,0)
8989.52
"BLD",6499,"KRN",8994,0)
8994
"BLD",6499,"KRN","B",.4,.4)

"BLD",6499,"KRN","B",.401,.401)

"BLD",6499,"KRN","B",.402,.402)

"BLD",6499,"KRN","B",.403,.403)

"BLD",6499,"KRN","B",.5,.5)

"BLD",6499,"KRN","B",.84,.84)

"BLD",6499,"KRN","B",3.6,3.6)

"BLD",6499,"KRN","B",3.8,3.8)

"BLD",6499,"KRN","B",9.2,9.2)

"BLD",6499,"KRN","B",9.8,9.8)

"BLD",6499,"KRN","B",19,19)

"BLD",6499,"KRN","B",19.1,19.1)

"BLD",6499,"KRN","B",101,101)

"BLD",6499,"KRN","B",409.61,409.61)

"BLD",6499,"KRN","B",771,771)

"BLD",6499,"KRN","B",870,870)

"BLD",6499,"KRN","B",8989.51,8989.51)

"BLD",6499,"KRN","B",8989.52,8989.52)

"BLD",6499,"KRN","B",8994,8994)

"BLD",6499,"QUES",0)
^9.62^^
"MBREQ")
0
"PKG",536,-1)
1^1
"PKG",536,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",536,20,0)
^9.402P^^
"PKG",536,22,0)
^9.49I^1^1
"PKG",536,22,1,0)
3.0^3040224^3040819^11874
"PKG",536,22,1,"PAH",1,0)
31^3070828
"PKG",536,22,1,"PAH",1,1,0)
^^1^1^3070828
"PKG",536,22,1,"PAH",1,1,1,0)
Can't enter Manual Med entry for discharged patient.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSBVAR")
0^1^B13715777^B13394171
"RTN","PSBVAR",1,0)
PSBVAR ;BIRMINGHAM/EFC-BCMA VARIANCE LOG FUNCTIONS ;Mar 2004
"RTN","PSBVAR",2,0)
 ;;3.0;BAR CODE MED ADMIN;*31*;Mar 2004;Build 1
"RTN","PSBVAR",3,0)
 ;Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBVAR",4,0)
 ;
"RTN","PSBVAR",5,0)
 ; Reference/IA
"RTN","PSBVAR",6,0)
 ; ^DPT/10035
"RTN","PSBVAR",7,0)
 ; ^DIC(42/10039
"RTN","PSBVAR",8,0)
 ;
"RTN","PSBVAR",9,0)
EN ;
"RTN","PSBVAR",10,0)
 Q
"RTN","PSBVAR",11,0)
 ;
"RTN","PSBVAR",12,0)
CHKPRN(DFN,PSBMIN,PSBLOG) ;
"RTN","PSBVAR",13,0)
 Q:PSBMIN=""
"RTN","PSBVAR",14,0)
 Q:PSBMIN'>$$GET^XPAR("DIV","PSB ADMIN PRN EFFECT")
"RTN","PSBVAR",15,0)
 D ADD(.RESULTS,DFN,3,PSBMIN,"",PSBLOG)
"RTN","PSBVAR",16,0)
 Q
"RTN","PSBVAR",17,0)
 ;
"RTN","PSBVAR",18,0)
 ;CHECK^PSBVAR() calling point is used to create a new variance entry.  Triggered by Order Administration Variance Field # 14 in the BCMA Medication Log File (#53.79).
"RTN","PSBVAR",19,0)
 ;
"RTN","PSBVAR",20,0)
CHECK(DFN,PSBMIN,PSBLOG) ;
"RTN","PSBVAR",21,0)
 Q:PSBMIN=""
"RTN","PSBVAR",22,0)
 N RESULTS
"RTN","PSBVAR",23,0)
 ; Checks the timing from the Med Log Entry X-Ref
"RTN","PSBVAR",24,0)
 I PSBMIN<0 D:(PSBMIN*-1)>$$GET^XPAR("DIV","PSB ADMIN BEFORE") ADD(.RESULTS,DFN,2,PSBMIN,"",PSBLOG)
"RTN","PSBVAR",25,0)
 I PSBMIN>0 D:PSBMIN>$$GET^XPAR("DIV","PSB ADMIN AFTER") ADD(.RESULTS,DFN,2,PSBMIN,"",PSBLOG)
"RTN","PSBVAR",26,0)
 Q
"RTN","PSBVAR",27,0)
 ;
"RTN","PSBVAR",28,0)
ADD(RESULTS,DFN,PSBEVNT,PSBMIN,PSBDRUG,PSBLOG) ;
"RTN","PSBVAR",29,0)
 ;
"RTN","PSBVAR",30,0)
 ; DFN:      Patient File (#2) Pointer
"RTN","PSBVAR",31,0)
 ; PSBEVNT:  Event Code (See DD for 53.78)
"RTN","PSBVAR",32,0)
 ; PSBMIN:   Minutes off of schedule (Optional)
"RTN","PSBVAR",33,0)
 ; PSBDRUG:  Drug File (#50) Pointer (Optional)
"RTN","PSBVAR",34,0)
 ; PSBLOG:   BCMA Med Log IEN (Optional)
"RTN","PSBVAR",35,0)
 ;
"RTN","PSBVAR",36,0)
 ;Do not create variance for med order with missing dose status.
"RTN","PSBVAR",37,0)
 I $G(PSBLOG),$P($G(^PSB(53.79,PSBLOG,0)),U,9)="M" Q
"RTN","PSBVAR",38,0)
 ;
"RTN","PSBVAR",39,0)
 N PSBDT,PSBRB,PSBWRD,PSBXX
"RTN","PSBVAR",40,0)
 ;
"RTN","PSBVAR",41,0)
 D EN^DDIOL("Filing Variance...")
"RTN","PSBVAR",42,0)
 D NOW^%DTC
"RTN","PSBVAR",43,0)
 L +(^PSB(53.78,0)):5 E  S RESULTS(0)="-1^Variance Log Locked" Q
"RTN","PSBVAR",44,0)
 S PSBXX=$O(^PSB(53.78,"A"),-1)+1
"RTN","PSBVAR",45,0)
 S $P(^PSB(53.78,0),U,3)=PSBXX
"RTN","PSBVAR",46,0)
 S $P(^PSB(53.78,0),U,4)=$P(^PSB(53.78,0),U,4)+1
"RTN","PSBVAR",47,0)
 ;
"RTN","PSBVAR",48,0)
WARD ;Extract the ward and room/bed information.
"RTN","PSBVAR",49,0)
 ;DFN is pre-defined.
"RTN","PSBVAR",50,0)
 S PSBRB=$P($G(^DPT(DFN,.101)),U)
"RTN","PSBVAR",51,0)
 S PSBRB=$S(PSBRB'="":PSBRB,1:"***")
"RTN","PSBVAR",52,0)
 S PSBWRD=$P($G(^DPT(DFN,.1)),U)
"RTN","PSBVAR",53,0)
 ;Convert Ward Name to Ward IEN
"RTN","PSBVAR",54,0)
 I PSBWRD'="" D
"RTN","PSBVAR",55,0)
 . S PSBDT=%
"RTN","PSBVAR",56,0)
 . S PSBWRD=$$FIND1^DIC(42,"","X",PSBWRD,"","","ERR")
"RTN","PSBVAR",57,0)
 . S %=PSBDT ;reset after $$FIND1^DIC fileman call
"RTN","PSBVAR",58,0)
 S PSBWRD=$S($G(PSBWRD):PSBWRD,1:"***")
"RTN","PSBVAR",59,0)
 ;
"RTN","PSBVAR",60,0)
 ; Set Variance Entry
"RTN","PSBVAR",61,0)
 S ^PSB(53.78,PSBXX,0)=DFN_U_PSBRB_U_DUZ_U_%_U_PSBEVNT_U_$G(PSBMIN)_U_$G(PSBDRUG)_U_$G(PSBLOG)_U_PSBWRD
"RTN","PSBVAR",62,0)
 ;
"RTN","PSBVAR",63,0)
 S ^PSB(53.78,"ADT",%,PSBXX)=""
"RTN","PSBVAR",64,0)
 S ^PSB(53.78,"B",DFN,PSBXX)=""
"RTN","PSBVAR",65,0)
 L -(^PSB(53.78,0))
"RTN","PSBVAR",66,0)
 S RESULTS(0)="1^Data Filed"
"RTN","PSBVAR",67,0)
 Q
"RTN","PSBVAR",68,0)
 ;
"RTN","PSBVAR",69,0)
 ; Unable to UPDATE^DIE WHILE IN UPDATE^DIE
"RTN","PSBVAR",70,0)
 W !,"Filing Variance..."
"RTN","PSBVAR",71,0)
 D EN^DDIOL("Filing Variance...")
"RTN","PSBVAR",72,0)
 N PSBVFDA,PSBVMSG,PSBVIEN
"RTN","PSBVAR",73,0)
 D VAL(.01,"`"_DFN) ; Patient Pointer
"RTN","PSBVAR",74,0)
 S Y=$G(^DPT(DFN,.1),"Unk Ward")_" "_$G(^DPT(DFN,.101),"Unk Bed")
"RTN","PSBVAR",75,0)
 D VAL(.02,Y) ; Patient Location
"RTN","PSBVAR",76,0)
 D VAL(.03,"`"_DUZ) ; New Person Pointer
"RTN","PSBVAR",77,0)
 D VAL(.04,"NOW") ; DT Entered
"RTN","PSBVAR",78,0)
 D VAL(.05,PSBEVNT) ; Event Code
"RTN","PSBVAR",79,0)
 D:$G(PSBMIN) VAL(.06,PSBMIN) ; Minutes Early/Late
"RTN","PSBVAR",80,0)
 D:$G(PSBDRUG) VAL(.07,"`"_PSBDRUG) ; Drug File Pointer
"RTN","PSBVAR",81,0)
 D:$G(PSBLOG) VAL(.08,"`"_PSBLOG)
"RTN","PSBVAR",82,0)
 ; Call UPDATE^DIE and set Results(0)
"RTN","PSBVAR",83,0)
 D UPDATE^DIE("","PSBVFDA","PSBVIEN","PSBVMSG")  ; PSBVFDA set into file 53.68, BCMA MEDICATION VARIANCE LOG at VAL+3
"RTN","PSBVAR",84,0)
 I $D(PSBVMSG) S RESULTS(0)="-1^"_PSBVMSG("DIERR",1)_": "_PSBVMSG("DIERR",1,"TEXT",1)
"RTN","PSBVAR",85,0)
 E  S RESULTS(0)="1^Data Successfully Filed^"_PSBVIEN(1)
"RTN","PSBVAR",86,0)
 W !,RESULTS(0)
"RTN","PSBVAR",87,0)
 Q
"RTN","PSBVAR",88,0)
 ;
"RTN","PSBVAR",89,0)
VAL(PSBVFLD,PSBVVAL) ;
"RTN","PSBVAR",90,0)
 N PSBVRET
"RTN","PSBVAR",91,0)
 K ^TMP("DIERR",$J)
"RTN","PSBVAR",92,0)
 D VAL^DIE(53.78,"+1,",PSBVFLD,"F",PSBVVAL,.PSBVRET,"PSBVFDA")
"RTN","PSBVAR",93,0)
 I PSBVRET="^" F X=0:0 S X=$O(^TMP("DIERR",$J,X)) Q:'X  S Y=^TMP("DIERR",$J,X)_": "_$G(^(X,"TEXT",1),"**"),RESULTS($O(RESULTS(""),-1)+1)="Data Validation Error: "_Y
"RTN","PSBVAR",94,0)
 K ^TMP("DIERR",$J)
"RTN","PSBVAR",95,0)
 Q
"RTN","PSBVAR",96,0)
 ;
"RTN","PSBVITFL")
0^2^B4992078^B4261599
"RTN","PSBVITFL",1,0)
PSBVITFL ;BIRMINGHAM/TEJ-BCMA VITAL MEASUREMENT FILER ;Mar 2004
"RTN","PSBVITFL",2,0)
 ;;3.0;BAR CODE MED ADMIN;*31*;Mar 2004;Build 1
"RTN","PSBVITFL",3,0)
 ; Per VHA Directive 2004-038, this routine should not be modified.
"RTN","PSBVITFL",4,0)
 ; 
"RTN","PSBVITFL",5,0)
 ; Reference/IA
"RTN","PSBVITFL",6,0)
 ; STORE^GMRVPCE0/1589
"RTN","PSBVITFL",7,0)
 ; 44/908
"RTN","PSBVITFL",8,0)
 ; 42/10039
"RTN","PSBVITFL",9,0)
 ; 
"RTN","PSBVITFL",10,0)
 ;
"RTN","PSBVITFL",11,0)
 ; Description:
"RTN","PSBVITFL",12,0)
 ; This routine is to service BCMA 3.0 functionality and store VITALs'
"RTN","PSBVITFL",13,0)
 ; data into the VITAL MEASUREMENT FILE - ^GMR(120.5  using the API
"RTN","PSBVITFL",14,0)
 ; GMRVPCE0
"RTN","PSBVITFL",15,0)
 ; 
"RTN","PSBVITFL",16,0)
 ; Parameters:
"RTN","PSBVITFL",17,0)
 ;       Input  -        DFN     (r) Pointer to the PATIENT (#2) file
"RTN","PSBVITFL",18,0)
 ;                       RATE    (r) BCMA trigger event/transaction
"RTN","PSBVITFL",19,0)
 ;                       VTYPE   (o) Pointer to GMRV VITAL TYPE FILE (#120.51)
"RTN","PSBVITFL",20,0)
 ;                                    (default = Pain ["PN"])
"RTN","PSBVITFL",21,0)
 ;                       DTTKN   (o) Date/time (FileMan) measurment was taken 
"RTN","PSBVITFL",22,0)
 ;                                    (default = $$NOW^XLFDT())
"RTN","PSBVITFL",23,0)
 ;                                    
"RTN","PSBVITFL",24,0)
 ;       Output -        RESULTS(0) = 1                                                                                             
"RTN","PSBVITFL",25,0)
 ;                       RESULTS(1) ="1^*** comment ***"                                                              
"RTN","PSBVITFL",26,0)
 ;                 or    RESULTS(1) ="-1^ERROR * Pain Score NOT filed 
"RTN","PSBVITFL",27,0)
 ;                                    successfully"
"RTN","PSBVITFL",28,0)
 ;
"RTN","PSBVITFL",29,0)
 ;       Process results in the storing of VITAL Measurement rate into the VITAL
"RTN","PSBVITFL",30,0)
 ;       MEASUREMENT FILE per the given patient and vital type.
"RTN","PSBVITFL",31,0)
 ;   
"RTN","PSBVITFL",32,0)
RPC(RESULTS,PSBDFN,PSBRATE,PSBVTYPE,PSBDTTKN) ;
"RTN","PSBVITFL",33,0)
 ;
"RTN","PSBVITFL",34,0)
 ; Set up the input array for the API
"RTN","PSBVITFL",35,0)
 ;
"RTN","PSBVITFL",36,0)
 ;PSB*3*31 Quit if patient has been discharged.
"RTN","PSBVITFL",37,0)
 K VADM,VAIN
"RTN","PSBVITFL",38,0)
 N DFN S DFN=$G(PSBDFN),VAIP("D")=""
"RTN","PSBVITFL",39,0)
 D DEM^VADPT,IN5^VADPT
"RTN","PSBVITFL",40,0)
 S RESULTS(0)=1,RESULTS(1)="-1^ERROR * "_$S($G(PSBVTYPE)']""!($G(PSBVTYPE)="PN"):"Pain Score",1:"Vital Measurement")_" NOT filed successfully."
"RTN","PSBVITFL",41,0)
 I 'VAIP(13)&('VADM(6)) S RESULTS(1)=RESULTS(1)_"  Patient has been DISCHARGED." Q
"RTN","PSBVITFL",42,0)
 S:$G(PSBVTYPE)']"" PSBVTYPE="PN"
"RTN","PSBVITFL",43,0)
 S:$G(PSBDTTKN)']"" PSBDTTKN=$$NOW^XLFDT()
"RTN","PSBVITFL",44,0)
 S PSBHLOC=^DIC(42,+$G(VAIP(5)),44)
"RTN","PSBVITFL",45,0)
 S GMRVDAT("ENCOUNTER")=U_PSBDFN_U_$G(PSBHLOC)
"RTN","PSBVITFL",46,0)
 S GMRVDAT("SOURCE")=U_$G(DUZ)
"RTN","PSBVITFL",47,0)
 S GMRVDAT("VITALS",$G(DUZ),1)=PSBVTYPE_U_$G(PSBRATE)_U_$G(PSBUNTS)_U_PSBDTTKN
"RTN","PSBVITFL",48,0)
 D STORE^GMRVPCE0(.GMRVDAT)
"RTN","PSBVITFL",49,0)
 I '$D(GMRVDAT("ERROR")) D NOW^%DTC,YX^%DTC S RESULTS(0)=1,RESULTS(1)="1^"_$S($G(PSBVTYPE)="PN":"Pain Score",1:PSBVTYPE)_" entered in Vitals via BCMA taken "_Y
"RTN","PSBVITFL",50,0)
 Q
"RTN","PSBVITFL",51,0)
 ;
"VER")
8.0^22.0
"BLD",6499,6)
^29
**END**
**END**
