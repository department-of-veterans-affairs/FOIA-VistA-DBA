Released DG*5.3*591 SEQ #530
Extracted from mail message
**KIDS**:DG*5.3*591^

**INSTALL NAME**
DG*5.3*591
"BLD",5567,0)
DG*5.3*591^REGISTRATION^0^3040802^y
"BLD",5567,1,0)
^^2^2^3040525^
"BLD",5567,1,1,0)
This build contains routines to cleanup various failed Means Test Uploads 
"BLD",5567,1,2,0)
and duplicate Means Test purges.
"BLD",5567,4,0)
^9.64PA^^
"BLD",5567,"ABPKG")
n
"BLD",5567,"INID")
^n
"BLD",5567,"INIT")
POST^DG53591
"BLD",5567,"KRN",0)
^9.67PA^8989.52^19
"BLD",5567,"KRN",.4,0)
.4
"BLD",5567,"KRN",.401,0)
.401
"BLD",5567,"KRN",.402,0)
.402
"BLD",5567,"KRN",.403,0)
.403
"BLD",5567,"KRN",.5,0)
.5
"BLD",5567,"KRN",.84,0)
.84
"BLD",5567,"KRN",3.6,0)
3.6
"BLD",5567,"KRN",3.8,0)
3.8
"BLD",5567,"KRN",9.2,0)
9.2
"BLD",5567,"KRN",9.8,0)
9.8
"BLD",5567,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",5567,"KRN",9.8,"NM",1,0)
DG53591^^0^B78154511
"BLD",5567,"KRN",9.8,"NM",2,0)
DG53591A^^0^B80179024
"BLD",5567,"KRN",9.8,"NM",3,0)
DG53591M^^0^B11725114
"BLD",5567,"KRN",9.8,"NM",4,0)
DG53591B^^0^B12730860
"BLD",5567,"KRN",9.8,"NM",5,0)
DG53591C^^0^B1118574
"BLD",5567,"KRN",9.8,"NM","B","DG53591",1)

"BLD",5567,"KRN",9.8,"NM","B","DG53591A",2)

"BLD",5567,"KRN",9.8,"NM","B","DG53591B",4)

"BLD",5567,"KRN",9.8,"NM","B","DG53591C",5)

"BLD",5567,"KRN",9.8,"NM","B","DG53591M",3)

"BLD",5567,"KRN",19,0)
19
"BLD",5567,"KRN",19,"NM",0)
^9.68A^^
"BLD",5567,"KRN",19.1,0)
19.1
"BLD",5567,"KRN",101,0)
101
"BLD",5567,"KRN",409.61,0)
409.61
"BLD",5567,"KRN",771,0)
771
"BLD",5567,"KRN",870,0)
870
"BLD",5567,"KRN",8989.51,0)
8989.51
"BLD",5567,"KRN",8989.52,0)
8989.52
"BLD",5567,"KRN",8994,0)
8994
"BLD",5567,"KRN","B",.4,.4)

"BLD",5567,"KRN","B",.401,.401)

"BLD",5567,"KRN","B",.402,.402)

"BLD",5567,"KRN","B",.403,.403)

"BLD",5567,"KRN","B",.5,.5)

"BLD",5567,"KRN","B",.84,.84)

"BLD",5567,"KRN","B",3.6,3.6)

"BLD",5567,"KRN","B",3.8,3.8)

"BLD",5567,"KRN","B",9.2,9.2)

"BLD",5567,"KRN","B",9.8,9.8)

"BLD",5567,"KRN","B",19,19)

"BLD",5567,"KRN","B",19.1,19.1)

"BLD",5567,"KRN","B",101,101)

"BLD",5567,"KRN","B",409.61,409.61)

"BLD",5567,"KRN","B",771,771)

"BLD",5567,"KRN","B",870,870)

"BLD",5567,"KRN","B",8989.51,8989.51)

"BLD",5567,"KRN","B",8989.52,8989.52)

"BLD",5567,"KRN","B",8994,8994)

"BLD",5567,"QUES",0)
^9.62^1^1
"BLD",5567,"QUES",1,0)
POS1
"BLD",5567,"QUES",1,1)
YA^^
"BLD",5567,"QUES",1,"A")
Do you want to run the Post-install cleanup now? 
"BLD",5567,"QUES",1,"B")
YES
"BLD",5567,"QUES",1,"Q")
Answer YES to procede with sending the cleanup to Taskman now.
"BLD",5567,"QUES","B","POS1",1)

"BLD",5567,"REQB",0)
^9.611^1^1
"BLD",5567,"REQB",1,0)
DG*5.3*579^1
"BLD",5567,"REQB","B","DG*5.3*579",1)

"INIT")
POST^DG53591
"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
591^3040802
"PKG",5,22,1,"PAH",1,1,0)
^^2^2^3040802
"PKG",5,22,1,"PAH",1,1,1,0)
This build contains routines to cleanup various failed Means Test Uploads 
"PKG",5,22,1,"PAH",1,1,2,0)
and duplicate Means Test purges.
"QUES","POS1",0)
YA^^
"QUES","POS1","?")
Answer YES to procede with sending the cleanup to Taskman now.
"QUES","POS1","A")
Do you want to run the Post-install cleanup now? 
"QUES","POS1","B")
YES
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","DG53591")
0^1^B78154511
"RTN","DG53591",1,0)
DG53591 ;ALB/GN - DG*5.3*591 CLEANUP FOR OVERLAYED INCOME TEST THRESHOLD AND STATUS; 3/17/04 12:26pm ; 7/29/04 11:33am
"RTN","DG53591",2,0)
 ;;5.3;Registration;**591**;Aug 13, 1993
"RTN","DG53591",3,0)
 Q
"RTN","DG53591",4,0)
 ;
"RTN","DG53591",5,0)
SITETEST ; Site test Entry tag.  Allows incremental testing in live mode
"RTN","DG53591",6,0)
 N QUIT,ZTDESC,ZTIO,ZTRTN,ZTSK,ZTQUEUED,ZTSAVE,CHKPNT
"RTN","DG53591",7,0)
 S CHKPNT=3
"RTN","DG53591",8,0)
 W !,"Do you want to process the next "_CHKPNT_" bad tests and stop for review? "
"RTN","DG53591",9,0)
 K DIR
"RTN","DG53591",10,0)
 S DIR("?",1)="  Enter Y to process the next "_CHKPNT_" bad tests it finds and stop the utility."
"RTN","DG53591",11,0)
 S DIR("?",2)="  This will allow you to verify the cleanup in small steps.  Enter N to process"
"RTN","DG53591",12,0)
 S DIR("?")="  the remainder of the file to completion."
"RTN","DG53591",13,0)
 S DIR(0)="Y" D ^DIR
"RTN","DG53591",14,0)
 I $D(DTOUT)!$D(DUOUT) W !,"Cancelled...",! Q
"RTN","DG53591",15,0)
 ;
"RTN","DG53591",16,0)
 S:'Y CHKPNT=0                               ;do not use check points
"RTN","DG53591",17,0)
 ;
"RTN","DG53591",18,0)
 ; setup TM variables and Load 
"RTN","DG53591",19,0)
 S ZTRTN=$S($G(TESTING):"TEST^DG53591",1:"QUE^DG53591")
"RTN","DG53591",20,0)
 S ZTDESC="Cleanup Bad Thresholds in the Means Test file"
"RTN","DG53591",21,0)
 S ZTIO=""
"RTN","DG53591",22,0)
 S ZTSAVE("CHKPNT")=""
"RTN","DG53591",23,0)
 ;
"RTN","DG53591",24,0)
 W !!,ZTDESC,!
"RTN","DG53591",25,0)
 ;check if already running or completed.
"RTN","DG53591",26,0)
 S QUIT=$$CHKSTAT(0)
"RTN","DG53591",27,0)
 Q:QUIT
"RTN","DG53591",28,0)
 D ^%ZTLOAD
"RTN","DG53591",29,0)
 L -^XTMP($$NAMSPC)
"RTN","DG53591",30,0)
 I $D(ZTSK) D
"RTN","DG53591",31,0)
 . W !,"This request queued as Task # ",ZTSK,!
"RTN","DG53591",32,0)
 Q
"RTN","DG53591",33,0)
 ;
"RTN","DG53591",34,0)
POST ;post install entry tag call.  processes entire file in live mode
"RTN","DG53591",35,0)
 I +$G(XPDQUES("POS1"))=0 D  Q
"RTN","DG53591",36,0)
 . D MES^XPDUTL("")
"RTN","DG53591",37,0)
 . D MES^XPDUTL("==================================================")
"RTN","DG53591",38,0)
 . D MES^XPDUTL(" POST INSTALL ABORTED AND WAS NOT SENT TO TASKMAN")
"RTN","DG53591",39,0)
 . D MES^XPDUTL("==================================================")
"RTN","DG53591",40,0)
 . D MES^XPDUTL("")
"RTN","DG53591",41,0)
 N ZTDTH,ZTDESC,ZTIO,ZTRTN,ZTSK,ZTQUEUED,ZTSAVE,CHKPNT
"RTN","DG53591",42,0)
 D MES^XPDUTL("")
"RTN","DG53591",43,0)
 D MES^XPDUTL("=====================================================")
"RTN","DG53591",44,0)
 D MES^XPDUTL("Queuing Bad Income Threshold Test Purge Utility.....")
"RTN","DG53591",45,0)
 I $$CHKSTAT(1) D  Q
"RTN","DG53591",46,0)
 . D BMES^XPDUTL("ABORTING  Post Install Utility Queuing")
"RTN","DG53591",47,0)
 . D MES^XPDUTL("=====================================================")
"RTN","DG53591",48,0)
 S ZTRTN="QUE^DG53591"
"RTN","DG53591",49,0)
 S ZTDESC="Cleanup Bad Thresholds in the Means Test file"
"RTN","DG53591",50,0)
 S ZTIO="",ZTDTH=$H
"RTN","DG53591",51,0)
 S CHKPNT=0,ZTSAVE("CHKPNT")=""
"RTN","DG53591",52,0)
 D ^%ZTLOAD
"RTN","DG53591",53,0)
 L -^XTMP($$NAMSPC)
"RTN","DG53591",54,0)
 D MES^XPDUTL("This request queued as Task # "_ZTSK)
"RTN","DG53591",55,0)
 D MES^XPDUTL("=====================================================")
"RTN","DG53591",56,0)
 D MES^XPDUTL("")
"RTN","DG53591",57,0)
 D EN^DG53591C                        ;restore eff date recs in error
"RTN","DG53591",58,0)
 D POST^DG53591A                      ;link 2nd cleanup to start later
"RTN","DG53591",59,0)
 Q
"RTN","DG53591",60,0)
 ;
"RTN","DG53591",61,0)
TEST ; Entry point for taskman (testing mode)
"RTN","DG53591",62,0)
 S TESTING=1
"RTN","DG53591",63,0)
QUE ; Entry point for taskman (live mode)
"RTN","DG53591",64,0)
 N NAMSPC S NAMSPC=$$NAMSPC^DG53591
"RTN","DG53591",65,0)
 L +^XTMP(NAMSPC):10 I '$T D  Q   ;quit if can't get a lock
"RTN","DG53591",66,0)
 . S $P(^XTMP(NAMSPC,0,0),U,5)="NO LOCK GAINED"
"RTN","DG53591",67,0)
 N QQ,ZTSTOP,XREC,MTIEN,DIK,DA,IVMTOT,IVMPUR,BEGTIME,PURGDT,IVMBAD
"RTN","DG53591",68,0)
 N DFN,TMP,ICDT,MTST,IVMDUPE,COUNT,PRI,TYPE,TYPNAM,IVMIEN,PRIM
"RTN","DG53591",69,0)
 N BADYR,FOUND,GOODIEN,SRCE,TMPIVM,XX,IVMCV,MAX,IVMIEND,LINKB,LINKG
"RTN","DG53591",70,0)
 N MTDT,R40831,THRS,YEAR,YRIEN
"RTN","DG53591",71,0)
 S TESTING=+$G(TESTING)
"RTN","DG53591",72,0)
 ;
"RTN","DG53591",73,0)
 ;get last run info if exists
"RTN","DG53591",74,0)
 S XREC=$G(^XTMP(NAMSPC,0,0))
"RTN","DG53591",75,0)
 S DFN=$P(XREC,U,1)         ;last REC processed
"RTN","DG53591",76,0)
 S IVMTOT=+$P(XREC,U,2)          ;total records processed
"RTN","DG53591",77,0)
 S IVMPUR=+$P(XREC,U,3)          ;total bad records purged
"RTN","DG53591",78,0)
 S IVMBAD=+$P(XREC,U,7)          ;total bad records found
"RTN","DG53591",79,0)
 ;
"RTN","DG53591",80,0)
 ;setup XTMP according to stds.
"RTN","DG53591",81,0)
 D SETUPX(30)
"RTN","DG53591",82,0)
 ;
"RTN","DG53591",83,0)
 ;init status field and start date & time if null
"RTN","DG53591",84,0)
 S $P(^XTMP(NAMSPC,0,0),U,5,6)="RUNNING^"
"RTN","DG53591",85,0)
 S:$P(^XTMP(NAMSPC,0,0),U,4)="" $P(^XTMP(NAMSPC,0,0),U,4)=$$NOW^XLFDT
"RTN","DG53591",86,0)
 ;
"RTN","DG53591",87,0)
 ;drive through 408.31 looking for bad threshold values per INCYR
"RTN","DG53591",88,0)
 S ZTSTOP=0
"RTN","DG53591",89,0)
 F QQ=1:1 S DFN=$O(^DGMT(408.31,"C",DFN)) Q:'DFN  D  Q:ZTSTOP
"RTN","DG53591",90,0)
 . S MTIEN=""
"RTN","DG53591",91,0)
 . K TMP S FOUND=0
"RTN","DG53591",92,0)
 . F  S MTIEN=$O(^DGMT(408.31,"C",DFN,MTIEN),-1) Q:MTIEN=""  D  Q:ZTSTOP!(FOUND)
"RTN","DG53591",93,0)
 . . S IVMTOT=IVMTOT+1                            ;tot ien's processed
"RTN","DG53591",94,0)
 . . Q:'$D(^DGMT(408.31,MTIEN,0))                 ;bad 0 node, quit
"RTN","DG53591",95,0)
 . . Q:$E(+$G(^DGMT(408.31,MTIEN,0)),1,3)<303     ;skip < 2003
"RTN","DG53591",96,0)
 . . S R40831=^DGMT(408.31,MTIEN,0)
"RTN","DG53591",97,0)
 . . S MTDT=+R40831 Q:$L(MTDT)'=7                 ;bad MT date, quit
"RTN","DG53591",98,0)
 . . S TYPE=$P(R40831,"^",19) Q:TYPE>1            ;not a MT, quit
"RTN","DG53591",99,0)
 . . S THRS=+$P(R40831,"^",12)                    ;get MT threshold
"RTN","DG53591",100,0)
 . . Q:'THRS                                      ;thrs. not > 0, quit
"RTN","DG53591",101,0)
 . . S YEAR=$E(MTDT,1,3)_"0000"                   ;build MT thrs. year
"RTN","DG53591",102,0)
 . . ;
"RTN","DG53591",103,0)
 . . ;find and save the bad year & IEN, also save related good year
"RTN","DG53591",104,0)
 . . ;quit when the first good ien is found
"RTN","DG53591",105,0)
 . . I THRS'=$P($G(^DG(43,1,"MT",YEAR,0)),"^",2) D
"RTN","DG53591",106,0)
 . . . S TMP(NAMSPC,DFN,"BAD",YEAR,MTIEN)=^DGMT(408.31,MTIEN,0)
"RTN","DG53591",107,0)
 . . . S BADYR=YEAR
"RTN","DG53591",108,0)
 . . . S IVMBAD=IVMBAD+1
"RTN","DG53591",109,0)
 . . E  D
"RTN","DG53591",110,0)
 . . . I $D(TMP(NAMSPC,DFN,"BAD",YEAR)) D
"RTN","DG53591",111,0)
 . . . . S TMP(NAMSPC,DFN,"GOOD",YEAR,MTIEN)=^DGMT(408.31,MTIEN,0)
"RTN","DG53591",112,0)
 . . . . S FOUND=1
"RTN","DG53591",113,0)
 . ;
"RTN","DG53591",114,0)
 . ;cleanup, delete any bad tests that also have a corresponding good
"RTN","DG53591",115,0)
 . ;test for that same Income year, then re-transmit that year to HEC
"RTN","DG53591",116,0)
 . S YEAR=0
"RTN","DG53591",117,0)
 . F  S YEAR=$O(TMP(NAMSPC,DFN,"BAD",YEAR)) Q:'YEAR  D
"RTN","DG53591",118,0)
 . . ;if no Good MT found, then cleanup and quit
"RTN","DG53591",119,0)
 . . I '$D(TMP(NAMSPC,DFN,"GOOD",YEAR)) K TMP(NAMSPC,DFN,"BAD",YEAR) Q
"RTN","DG53591",120,0)
 . . S MTIEN=""
"RTN","DG53591",121,0)
 . . F  S MTIEN=$O(TMP(NAMSPC,DFN,"BAD",YEAR,MTIEN)) Q:MTIEN=""  D
"RTN","DG53591",122,0)
 . . . ;
"RTN","DG53591",123,0)
 . . . ;if Good MT exists for year then delete Bad MT
"RTN","DG53591",124,0)
 . . . S GOODIEN=$O(TMP(NAMSPC,DFN,"GOOD",YEAR,0))
"RTN","DG53591",125,0)
 . . . D:GOODIEN]"" SETPRIM(GOODIEN,1)                  ;insure a PRIM
"RTN","DG53591",126,0)
 . . . D DELMT(MTIEN,DFN,.IVMPUR)                       ;del MT
"RTN","DG53591",127,0)
 . . . ;
"RTN","DG53591",128,0)
 . . . ;if a linked RXCT see if it needs to be deleted or re-pointed
"RTN","DG53591",129,0)
 . . . S LINKB=$P($G(^DGMT(408.31,MTIEN,2)),"^",6)
"RTN","DG53591",130,0)
 . . . ;if bad MT is linked & RX is linked back to bad MT, then relink
"RTN","DG53591",131,0)
 . . . I LINKB,$P($G(^DGMT(408.31,LINKB,2)),"^",6)=MTIEN D LINKED
"RTN","DG53591",132,0)
 . . . ;
"RTN","DG53591",133,0)
 . . . ;set year to be re-transmitted
"RTN","DG53591",134,0)
 . . . S YRIEN=$O(^IVM(301.5,"AYR",YEAR,DFN,0))
"RTN","DG53591",135,0)
 . . . S DATA(.03)=0
"RTN","DG53591",136,0)
 . . . I 'TESTING,$$UPD^DGENDBS(301.5,YRIEN,.DATA)
"RTN","DG53591",137,0)
 . ;
"RTN","DG53591",138,0)
 . ;update last processed info
"RTN","DG53591",139,0)
 . S $P(^XTMP(NAMSPC,0,0),U,1,3)=DFN_U_IVMTOT_U_IVMPUR
"RTN","DG53591",140,0)
 . S $P(^XTMP(NAMSPC,0,0),U,7)=IVMBAD
"RTN","DG53591",141,0)
 . M ^XTMP(NAMSPC)=TMP(NAMSPC)
"RTN","DG53591",142,0)
 . ;
"RTN","DG53591",143,0)
 . ;check for stop request after every 20 processed DFN recs
"RTN","DG53591",144,0)
 . I QQ#20=0 D
"RTN","DG53591",145,0)
 . . S:$$S^%ZTLOAD ZTSTOP=1
"RTN","DG53591",146,0)
 . . I $D(^XTMP(NAMSPC,0,"STOP")) S ZTSTOP=1 K ^XTMP(NAMSPC,0,"STOP")
"RTN","DG53591",147,0)
 ;
"RTN","DG53591",148,0)
 ;set status and mail stats
"RTN","DG53591",149,0)
 I ZTSTOP S $P(^XTMP(NAMSPC,0,0),U,5,6)="STOPPED"_U_$$NOW^XLFDT
"RTN","DG53591",150,0)
 E  S $P(^XTMP(NAMSPC,0,0),U,5,6)="COMPLETED"_U_$$NOW^XLFDT
"RTN","DG53591",151,0)
 D MAIL^DG53591M
"RTN","DG53591",152,0)
 K TESTING
"RTN","DG53591",153,0)
 L -^XTMP($$NAMSPC)
"RTN","DG53591",154,0)
 Q
"RTN","DG53591",155,0)
 ;
"RTN","DG53591",156,0)
LINKED ;Resolve the linked RX tests to a bad MT
"RTN","DG53591",157,0)
 S LINKG=$P($G(^DGMT(408.31,GOODIEN,2)),"^",6)
"RTN","DG53591",158,0)
 ;
"RTN","DG53591",159,0)
 ;if the Good MT is linked
"RTN","DG53591",160,0)
 I LINKG D
"RTN","DG53591",161,0)
 . ;good MT not linked to the same RX as the Bad MT, then delete 
"RTN","DG53591",162,0)
 . ;the bad linked RX
"RTN","DG53591",163,0)
 . I LINKG'=LINKB D
"RTN","DG53591",164,0)
 . . D DELMT(LINKB,DFN,.IVMPUR)
"RTN","DG53591",165,0)
 . . S TMP(NAMSPC,DFN,"DELLNK",YEAR,LINKB)=^DGMT(408.31,LINKB,0)
"RTN","DG53591",166,0)
 . ;
"RTN","DG53591",167,0)
 . ;else both MT point to same RX, then point RX back to Good MT
"RTN","DG53591",168,0)
 . E  D
"RTN","DG53591",169,0)
 . . D REPOINT(LINKB,GOODIEN)
"RTN","DG53591",170,0)
 . . S TMP(NAMSPC,DFN,"PNTLNK",YEAR,LINKB)=^DGMT(408.31,LINKB,0)
"RTN","DG53591",171,0)
 ;
"RTN","DG53591",172,0)
 ;else save RX and point to Good MT & point Good MT back to RX
"RTN","DG53591",173,0)
 E  D
"RTN","DG53591",174,0)
 . D REPOINT(LINKB,GOODIEN)
"RTN","DG53591",175,0)
 . S TMP(NAMSPC,DFN,"PNTLNK",YEAR,LINKB)=^DGMT(408.31,LINKB,0)
"RTN","DG53591",176,0)
 Q
"RTN","DG53591",177,0)
 ;
"RTN","DG53591",178,0)
DELMT(IEN,DFN,PUR,BAD) ; delete 408.31 ien only, no income related files
"RTN","DG53591",179,0)
 Q:'$G(IEN)
"RTN","DG53591",180,0)
 N DA,DIK
"RTN","DG53591",181,0)
 S TESTING=+$G(TESTING,1),DFN=$G(DFN)
"RTN","DG53591",182,0)
 ;
"RTN","DG53591",183,0)
 S DA=IEN,DIK="^DGMT(408.31," D:'TESTING ^DIK        ;del MT here
"RTN","DG53591",184,0)
 S PUR=PUR+1
"RTN","DG53591",185,0)
 S BAD(IEN)=""
"RTN","DG53591",186,0)
 W:'$D(ZTQUEUED) !,"Deleting Bad IEN in 408.31 > ",IEN," for DFN > ",DFN
"RTN","DG53591",187,0)
 ;
"RTN","DG53591",188,0)
 Q
"RTN","DG53591",189,0)
 ;
"RTN","DG53591",190,0)
REPOINT(LINK,MT) ;  repoint a linked RXCT to MT and vice versa
"RTN","DG53591",191,0)
 Q:'$G(LINK)!('$G(MT))
"RTN","DG53591",192,0)
 N DATA
"RTN","DG53591",193,0)
 S TESTING=+$G(TESTING,1)
"RTN","DG53591",194,0)
 S DATA(2.06)=MT
"RTN","DG53591",195,0)
 I 'TESTING,$$UPD^DGENDBS(408.31,LINK,.DATA)
"RTN","DG53591",196,0)
 I $$UPD^DGENDBS(408.31,LINK,.DATA)
"RTN","DG53591",197,0)
 W:'$D(ZTQUEUED) !,"Point RXCT in 408.31 > ",LINK," to Good MT > ",MT
"RTN","DG53591",198,0)
 S DATA(2.06)=LINK
"RTN","DG53591",199,0)
 I 'TESTING,$$UPD^DGENDBS(408.31,MT,.DATA)
"RTN","DG53591",200,0)
 I $$UPD^DGENDBS(408.31,MT,.DATA)
"RTN","DG53591",201,0)
 W:'$D(ZTQUEUED) !,"Point Good MT in 408.31 > ",MT," to RXCT > ",LINK
"RTN","DG53591",202,0)
 ;
"RTN","DG53591",203,0)
 Q
"RTN","DG53591",204,0)
 ;
"RTN","DG53591",205,0)
SETPRIM(DA,PR) ; set an Income Test (in #408.31) to Prim or Not
"RTN","DG53591",206,0)
 ; Input: DA= ien in 408.31 to set "PRIM" node
"RTN","DG53591",207,0)
 ;        PR= what to set PRIM node to; 0 or 1
"RTN","DG53591",208,0)
 Q:'$D(DA)
"RTN","DG53591",209,0)
 Q:'$D(PR)
"RTN","DG53591",210,0)
 Q:PR=$G(^DGMT(408.31,DA,"PRIM"))
"RTN","DG53591",211,0)
 N DR,DIE
"RTN","DG53591",212,0)
 S DR="2////"_PR,DIE="^DGMT(408.31,"
"RTN","DG53591",213,0)
 D:'$G(TESTING) ^DIE
"RTN","DG53591",214,0)
 D ^DIE
"RTN","DG53591",215,0)
 Q
"RTN","DG53591",216,0)
 ;
"RTN","DG53591",217,0)
CHKSTAT(POST) ;check if job is running, stopped, or completed
"RTN","DG53591",218,0)
 N Y,DUOUT,DTOUT,QUIT,STAT,STIME,NAMSPC
"RTN","DG53591",219,0)
 S QUIT=0
"RTN","DG53591",220,0)
 S NAMSPC=$$NAMSPC
"RTN","DG53591",221,0)
 L +^XTMP(NAMSPC):1
"RTN","DG53591",222,0)
 I '$T D BMES^XPDUTL("*** ALREADY RUNNING ***") Q 1
"RTN","DG53591",223,0)
 ;
"RTN","DG53591",224,0)
 ; get job status
"RTN","DG53591",225,0)
 S STAT=$P($G(^XTMP(NAMSPC,0,0)),U,5)
"RTN","DG53591",226,0)
 S STIME=$P($G(^XTMP(NAMSPC,0,0)),U,6)
"RTN","DG53591",227,0)
 ;
"RTN","DG53591",228,0)
 I POST D KILIT Q 0
"RTN","DG53591",229,0)
 ;
"RTN","DG53591",230,0)
 ;if job Completed and run from menu opt, ask to Re-Run
"RTN","DG53591",231,0)
 I STAT="COMPLETED" D
"RTN","DG53591",232,0)
 . W " was Completed on "_$$FMTE^XLFDT(STIME)
"RTN","DG53591",233,0)
 . W !,"  Do you want to Re-Run again?"
"RTN","DG53591",234,0)
 . K DIR
"RTN","DG53591",235,0)
 . S DIR("?",1)="  Entering Y, will delete the XTMP global where the previous cleanup"
"RTN","DG53591",236,0)
 . S DIR("?")="  information was stored and begin a new job, or N to cancel request"
"RTN","DG53591",237,0)
 . S DIR(0)="Y" D ^DIR
"RTN","DG53591",238,0)
 . I 'Y S QUIT=1 Q
"RTN","DG53591",239,0)
 . W !," ARE YOU SURE?"
"RTN","DG53591",240,0)
 . K DIR
"RTN","DG53591",241,0)
 . S DIR("?")="Enter Y to begin a new Job or N to cancel request"
"RTN","DG53591",242,0)
 . S DIR(0)="Y" D ^DIR
"RTN","DG53591",243,0)
 . I 'Y S QUIT=1 Q
"RTN","DG53591",244,0)
 . ;fall thru to re-run mode, kill ^XTMPs
"RTN","DG53591",245,0)
 . D KILIT
"RTN","DG53591",246,0)
 Q QUIT
"RTN","DG53591",247,0)
 ;
"RTN","DG53591",248,0)
KILIT ; kill Xtmp work file for a re-run
"RTN","DG53591",249,0)
 S:'$D(NAMSPC) NAMSPC=$$NAMSPC^DG53591
"RTN","DG53591",250,0)
 K ^XTMP(NAMSPC)
"RTN","DG53591",251,0)
 Q
"RTN","DG53591",252,0)
 ;
"RTN","DG53591",253,0)
STOP ; alternate stop method
"RTN","DG53591",254,0)
 S ^XTMP($$NAMSPC,0,"STOP")=""
"RTN","DG53591",255,0)
 Q
"RTN","DG53591",256,0)
 ;
"RTN","DG53591",257,0)
SETUPX(EXPDAY) ;Setup XTMP according to standards and set expiration days
"RTN","DG53591",258,0)
 N BEGTIME,PURGDT,NAMSPC
"RTN","DG53591",259,0)
 S NAMSPC=$$NAMSPC^DG53591
"RTN","DG53591",260,0)
 S BEGTIME=$$NOW^XLFDT()
"RTN","DG53591",261,0)
 S PURGDT=$$FMADD^XLFDT(BEGTIME,EXPDAY)
"RTN","DG53591",262,0)
 S ^XTMP(NAMSPC,0)=PURGDT_U_BEGTIME
"RTN","DG53591",263,0)
 S $P(^XTMP(NAMSPC,0),U,3)="Cleanup Bad Thresholds in the Means Test File"
"RTN","DG53591",264,0)
 Q
"RTN","DG53591",265,0)
 ;
"RTN","DG53591",266,0)
NAMSPC() ; Return a consistent name space variable
"RTN","DG53591",267,0)
 Q $T(+0)
"RTN","DG53591A")
0^2^B80179024
"RTN","DG53591A",1,0)
DG53591A ;ALB/GN - DG*5.3*591 CLEANUP FOR PURGED DEPENDENT INCOME; 3/17/04 12:26pm ; 7/26/04 10:51am
"RTN","DG53591A",2,0)
 ;;5.3;Registration;**591**;Aug 13, 1993
"RTN","DG53591A",3,0)
 Q
"RTN","DG53591A",4,0)
 ;
"RTN","DG53591A",5,0)
POST ;post install entry tag call.  processes entire file in live mode
"RTN","DG53591A",6,0)
 N ZTDTH,ZTDESC,ZTIO,ZTRTN,ZTSK,ZTQUEUED,ZTSAVE
"RTN","DG53591A",7,0)
 D MES^XPDUTL("")
"RTN","DG53591A",8,0)
 D MES^XPDUTL("=====================================================")
"RTN","DG53591A",9,0)
 D MES^XPDUTL("Queuing Cleanup Purged Dependent Income Relations....")
"RTN","DG53591A",10,0)
 I $$CHKSTAT(1) D  Q
"RTN","DG53591A",11,0)
 . D BMES^XPDUTL("ABORTING  Post Install Utility Queuing")
"RTN","DG53591A",12,0)
 . D MES^XPDUTL("=====================================================")
"RTN","DG53591A",13,0)
 S ZTRTN="QUE^DG53591A"
"RTN","DG53591A",14,0)
 S ZTDESC="Cleanup Purged Dependent Income Relations"
"RTN","DG53591A",15,0)
 ; delay start by 5 minutes to give 1st cleanup a head start
"RTN","DG53591A",16,0)
 S ZTIO=""
"RTN","DG53591A",17,0)
 S ZTDTH=$H,$P(ZTDTH,",",2)=$P(ZTDTH,",",2)+300
"RTN","DG53591A",18,0)
 D ^%ZTLOAD
"RTN","DG53591A",19,0)
 L -^XTMP($$NAMSPC)
"RTN","DG53591A",20,0)
 D MES^XPDUTL("This request queued as Task # "_ZTSK)
"RTN","DG53591A",21,0)
 D MES^XPDUTL("=====================================================")
"RTN","DG53591A",22,0)
 D MES^XPDUTL("")
"RTN","DG53591A",23,0)
 Q
"RTN","DG53591A",24,0)
 ;
"RTN","DG53591A",25,0)
TEST ; Entry point for taskman (testing mode)
"RTN","DG53591A",26,0)
 S TESTING=1
"RTN","DG53591A",27,0)
QUE ; Entry point for taskman (live mode)
"RTN","DG53591A",28,0)
 N NAMSPC S NAMSPC=$$NAMSPC^DG53591A
"RTN","DG53591A",29,0)
 L +^XTMP(NAMSPC):10 I '$T D  Q   ;quit if can't get a lock
"RTN","DG53591A",30,0)
 . S $P(^XTMP(NAMSPC,0,0),U,5)="NO LOCK GAINED"
"RTN","DG53591A",31,0)
 N QQ,ZTSTOP,XREC,MTIEN,DIK,DA,IVMTOT,IVMPTR,IVMDPTR,BEGTIME,PURGDT
"RTN","DG53591A",32,0)
 N DFN,TMP,ICDT,MTST,IVMDUPE,COUNT,PRI,TYPE,TYPNAM,IVMIEN,PRIM
"RTN","DG53591A",33,0)
 N DG22,MTDT,R21,R22,R12,BADDT,BADYR,NEWYR,PMT,SSN,DGDFN
"RTN","DG53591A",34,0)
 S TESTING=+$G(TESTING)
"RTN","DG53591A",35,0)
 ;
"RTN","DG53591A",36,0)
 ;get last run info if exists
"RTN","DG53591A",37,0)
 S XREC=$G(^XTMP(NAMSPC,0,0))
"RTN","DG53591A",38,0)
 S DFN=$P(XREC,U,1)                           ;last REC processed
"RTN","DG53591A",39,0)
 S IVMTOT=+$P(XREC,U,2)                       ;total records processed
"RTN","DG53591A",40,0)
 S IVMPTR=+$P(XREC,U,3)                       ;total repointed recs
"RTN","DG53591A",41,0)
 S DGDFN=+$P(XREC,U,7)                        ;last DFN of 2nd cleanup
"RTN","DG53591A",42,0)
 S IVMDPTR=+$P(XREC,U,8)                      ;total del 408.1275 recs
"RTN","DG53591A",43,0)
 ;
"RTN","DG53591A",44,0)
 ;setup XTMP according to stds.
"RTN","DG53591A",45,0)
 D SETUPX(60)
"RTN","DG53591A",46,0)
 ;
"RTN","DG53591A",47,0)
 ;init status field and start date & time if null
"RTN","DG53591A",48,0)
 S $P(^XTMP(NAMSPC,0,0),U,5,6)="RUNNING^"
"RTN","DG53591A",49,0)
 S:$P(^XTMP(NAMSPC,0,0),U,4)="" $P(^XTMP(NAMSPC,0,0),U,4)=$$NOW^XLFDT
"RTN","DG53591A",50,0)
 ;
"RTN","DG53591A",51,0)
 ;drive through 408.22 and create a DFN ordered xref
"RTN","DG53591A",52,0)
 K ^TMP(NAMSPC)
"RTN","DG53591A",53,0)
 ;
"RTN","DG53591A",54,0)
 ; build TMP xref from AMT xref in 408.22
"RTN","DG53591A",55,0)
 ;  fmt of TMP(Namspc,MT ien,DFN,408.21 ien,408.22 ien)
"RTN","DG53591A",56,0)
 S GL=$NA(^DGMT(408.22,"AMT"))
"RTN","DG53591A",57,0)
 F  S GL=$Q(@GL) Q:$QS(GL,2)'="AMT"  D
"RTN","DG53591A",58,0)
 . Q:$QS(GL,3)'?.N                             ;insure 3rd sub=numeric
"RTN","DG53591A",59,0)
 . Q:+$G(^DPT($QS(GL,4),.35))                  ;skip vets w/DOD
"RTN","DG53591A",60,0)
 . S ^TMP(NAMSPC,$QS(GL,4),$QS(GL,3),$QS(GL,5))=$QS(GL,6)
"RTN","DG53591A",61,0)
 ;
"RTN","DG53591A",62,0)
 ;drive through TMP XREF looking for bad 408.22 refs with no 408.31
"RTN","DG53591A",63,0)
 S ZTSTOP=0
"RTN","DG53591A",64,0)
 F QQ=1:1 S DFN=$O(^TMP(NAMSPC,DFN)) Q:'DFN  D  Q:ZTSTOP
"RTN","DG53591A",65,0)
 . S MTIEN=0
"RTN","DG53591A",66,0)
 . F  S MTIEN=$O(^TMP(NAMSPC,DFN,MTIEN)) Q:'MTIEN  D  Q:ZTSTOP
"RTN","DG53591A",67,0)
 . . S R21=0
"RTN","DG53591A",68,0)
 . . F  S R21=$O(^TMP(NAMSPC,DFN,MTIEN,R21)) Q:'R21  D  Q:ZTSTOP
"RTN","DG53591A",69,0)
 . . . S IVMTOT=IVMTOT+1                            ;tot ien's read
"RTN","DG53591A",70,0)
 . . . ;
"RTN","DG53591A",71,0)
 . . . ;only process recs that are pointing to nonexistent 408.31 recs
"RTN","DG53591A",72,0)
 . . . S R22=$P(^TMP(NAMSPC,DFN,MTIEN,R21),"^",1)
"RTN","DG53591A",73,0)
 . . . Q:$D(^DGMT(408.31,MTIEN,0))
"RTN","DG53591A",74,0)
 . . . ;
"RTN","DG53591A",75,0)
 . . . ;quit, if 408.22 xref's below ref. bad 408.21 recs
"RTN","DG53591A",76,0)
 . . . Q:'$D(^DGMT(408.21,R21,0))
"RTN","DG53591A",77,0)
 . . . ;
"RTN","DG53591A",78,0)
 . . . ;determine Income year for bad ptr from the 408.21 file
"RTN","DG53591A",79,0)
 . . . S BADDT=(+^DGMT(408.21,R21,0))+11231,BADYR=$E(BADDT,1,3)
"RTN","DG53591A",80,0)
 . . . S BADDT=$S(BADDT>DT:DT,1:BADDT)
"RTN","DG53591A",81,0)
 . . . ;
"RTN","DG53591A",82,0)
 . . . ;get previous Primary MT (PMT) based on the bad ptr's MT year
"RTN","DG53591A",83,0)
 . . . ;and quit if PMT Not found
"RTN","DG53591A",84,0)
 . . . S PMT=$$LST^DGMTU(DFN,BADDT)
"RTN","DG53591A",85,0)
 . . . Q:'PMT
"RTN","DG53591A",86,0)
 . . . ;
"RTN","DG53591A",87,0)
 . . . ;quit, if the PMT income year does not match the bad ptr year
"RTN","DG53591A",88,0)
 . . . S MTDT=$P(PMT,"^",2),NEWYR=$E(MTDT,1,3)
"RTN","DG53591A",89,0)
 . . . Q:BADYR'=NEWYR
"RTN","DG53591A",90,0)
 . . . ;
"RTN","DG53591A",91,0)
 . . . ;quit, if (Cat C & < Oct 1999)or(if Not Cat C & > 2 years old)
"RTN","DG53591A",92,0)
 . . . ;      or if MT is No Longer Required
"RTN","DG53591A",93,0)
 . . . N CATC,NOREQ
"RTN","DG53591A",94,0)
 . . . S CATC=$P(PMT,"^",4)="C"
"RTN","DG53591A",95,0)
 . . . S NOREQ=$P(PMT,"^",3)["NO LONGER REQUIRED"
"RTN","DG53591A",96,0)
 . . . Q:(CATC)&(MTDT<2991001)
"RTN","DG53591A",97,0)
 . . . Q:('CATC)&(MTDT<(DT-20000))
"RTN","DG53591A",98,0)
 . . . Q:$E(MTDT,1,3)<303
"RTN","DG53591A",99,0)
 . . . Q:NOREQ
"RTN","DG53591A",100,0)
 . . . ;
"RTN","DG53591A",101,0)
 . . . ;quit, if PMT was already pointed to by another 408.22 rec
"RTN","DG53591A",102,0)
 . . . S NEWIEN=+PMT
"RTN","DG53591A",103,0)
 . . . Q:$D(^TMP(NAMSPC,DFN,NEWIEN))
"RTN","DG53591A",104,0)
 . . . ;
"RTN","DG53591A",105,0)
 . . . ;quit, if MT to point to is from Other VAMC
"RTN","DG53591A",106,0)
 . . . Q:$P(PMT,"^",5)=4
"RTN","DG53591A",107,0)
 . . . ;
"RTN","DG53591A",108,0)
 . . . ;fall thru to re-point this bad 408.22 xref to new PMT ien
"RTN","DG53591A",109,0)
 . . . S IVMPTR=IVMPTR+1
"RTN","DG53591A",110,0)
 . . . D PT40822(DFN,R22,NEWIEN,MTIEN)          ;repoint bad 408.22
"RTN","DG53591A",111,0)
 . . . D XMIT(DFN,MTDT)                         ;re-xmit PMT to HEC
"RTN","DG53591A",112,0)
 . . . S $P(^TMP(NAMSPC,DFN,MTIEN),"^",2)=NEWIEN
"RTN","DG53591A",113,0)
 . ;
"RTN","DG53591A",114,0)
 . ;update last processed info
"RTN","DG53591A",115,0)
 . S $P(^XTMP(NAMSPC,0,0),U,1,3)=DFN_U_IVMTOT_U_IVMPTR
"RTN","DG53591A",116,0)
 . M ^XTMP(NAMSPC,DFN)=^TMP(NAMSPC,DFN)
"RTN","DG53591A",117,0)
 . ;
"RTN","DG53591A",118,0)
 . ;check for stop request after every 20 processed DFN recs
"RTN","DG53591A",119,0)
 . I QQ#20=0 D
"RTN","DG53591A",120,0)
 . . S:$$S^%ZTLOAD ZTSTOP=1
"RTN","DG53591A",121,0)
 . . I $D(^XTMP(NAMSPC,0,"STOP")) S ZTSTOP=1 K ^XTMP(NAMSPC,0,"STOP")
"RTN","DG53591A",122,0)
 . K TMP
"RTN","DG53591A",123,0)
 ;
"RTN","DG53591A",124,0)
 ;set status and if complete, call 2nd pass cleanup
"RTN","DG53591A",125,0)
 I ZTSTOP D
"RTN","DG53591A",126,0)
 . S $P(^XTMP(NAMSPC,0,0),U,5,6)="STOPPED"_U_$$NOW^XLFDT
"RTN","DG53591A",127,0)
 E  D                                   ;2nd pass will mark complete
"RTN","DG53591A",128,0)
 . D EN^DG53591B                        ;second pass dependent cleanup
"RTN","DG53591A",129,0)
 ;
"RTN","DG53591A",130,0)
 ;mail stats
"RTN","DG53591A",131,0)
 D MAIL^DG53591A
"RTN","DG53591A",132,0)
 K TESTING,^TMP(NAMSPC)
"RTN","DG53591A",133,0)
 L -^XTMP($$NAMSPC)
"RTN","DG53591A",134,0)
 Q
"RTN","DG53591A",135,0)
 ;
"RTN","DG53591A",136,0)
PT40822(DFN,R22,NEWIEN,MTIEN) ; Repoint this bad 408.22 xref to a new MT
"RTN","DG53591A",137,0)
 N DATA,MTDAT
"RTN","DG53591A",138,0)
 S DATA(31)=NEWIEN
"RTN","DG53591A",139,0)
 I '$G(TESTING),$$UPD^DGENDBS(408.22,R22,.DATA)
"RTN","DG53591A",140,0)
 S SSN=$E(^DPT(DFN,0),1)_$E($P(^DPT(DFN,0),"^",9),6,9)
"RTN","DG53591A",141,0)
 S MTDAT=+$G(^DGMT(408.31,NEWIEN,0))
"RTN","DG53591A",142,0)
 S TEXT=" SSN="_SSN_"  Point 408.22 ien "_R22_" From MT "_MTIEN
"RTN","DG53591A",143,0)
 S TEXT=TEXT_" to "_NEWIEN_"  "_$$FMTE^XLFDT(MTDAT,2)
"RTN","DG53591A",144,0)
 W:'$D(ZTQUEUED) !,TEXT
"RTN","DG53591A",145,0)
 S ^XTMP(NAMSPC,"DET",DFN,R22)=TEXT
"RTN","DG53591A",146,0)
 Q
"RTN","DG53591A",147,0)
 ;
"RTN","DG53591A",148,0)
XMIT(DFN,MTDT) ; Re-transmit this Income Year per this MT date
"RTN","DG53591A",149,0)
 N YRIEN,DATA,YEAR
"RTN","DG53591A",150,0)
 S YEAR=$$LYR^DGMTSCU1(MTDT)
"RTN","DG53591A",151,0)
 S YRIEN=$O(^IVM(301.5,"AYR",YEAR,DFN,0))
"RTN","DG53591A",152,0)
 S DATA(.03)=0
"RTN","DG53591A",153,0)
 I '$G(TESTING),$$UPD^DGENDBS(301.5,YRIEN,.DATA)
"RTN","DG53591A",154,0)
 W:'$D(ZTQUEUED) !,"Transmit Income Year ",YEAR," IVM file ien: ",YRIEN
"RTN","DG53591A",155,0)
 Q
"RTN","DG53591A",156,0)
 ;
"RTN","DG53591A",157,0)
CHKSTAT(POST) ;check if job is running, stopped, or completed
"RTN","DG53591A",158,0)
 N Y,DUOUT,DTOUT,QUIT,STAT,STIME,NAMSPC
"RTN","DG53591A",159,0)
 S QUIT=0
"RTN","DG53591A",160,0)
 S NAMSPC=$$NAMSPC
"RTN","DG53591A",161,0)
 L +^XTMP(NAMSPC):1
"RTN","DG53591A",162,0)
 I '$T D BMES^XPDUTL("*** ALREADY RUNNING ***") Q 1
"RTN","DG53591A",163,0)
 ;
"RTN","DG53591A",164,0)
 ; get job status
"RTN","DG53591A",165,0)
 S STAT=$P($G(^XTMP(NAMSPC,0,0)),U,5)
"RTN","DG53591A",166,0)
 S STIME=$P($G(^XTMP(NAMSPC,0,0)),U,6)
"RTN","DG53591A",167,0)
 ;
"RTN","DG53591A",168,0)
 I POST D KILIT Q 0
"RTN","DG53591A",169,0)
 ;
"RTN","DG53591A",170,0)
 ;if job Completed and run from menu opt, ask to Re-Run
"RTN","DG53591A",171,0)
 I STAT="COMPLETED" D
"RTN","DG53591A",172,0)
 . W " was Completed on "_$$FMTE^XLFDT(STIME)
"RTN","DG53591A",173,0)
 . W !,"  Do you want to Re-Run again?"
"RTN","DG53591A",174,0)
 . K DIR
"RTN","DG53591A",175,0)
 . S DIR("?",1)="  Entering Y, will delete the XTMP global where the previous cleanup"
"RTN","DG53591A",176,0)
 . S DIR("?")="  information was stored and begin a new job, or N to cancel request"
"RTN","DG53591A",177,0)
 . S DIR(0)="Y" D ^DIR
"RTN","DG53591A",178,0)
 . I 'Y S QUIT=1 Q
"RTN","DG53591A",179,0)
 . W !," ARE YOU SURE?"
"RTN","DG53591A",180,0)
 . K DIR
"RTN","DG53591A",181,0)
 . S DIR("?")="Enter Y to begin a new Job or N to cancel request"
"RTN","DG53591A",182,0)
 . S DIR(0)="Y" D ^DIR
"RTN","DG53591A",183,0)
 . I 'Y S QUIT=1 Q
"RTN","DG53591A",184,0)
 . ;fall thru to re-run mode, kill ^XTMPs
"RTN","DG53591A",185,0)
 . D KILIT
"RTN","DG53591A",186,0)
 Q QUIT
"RTN","DG53591A",187,0)
 ;
"RTN","DG53591A",188,0)
KILIT ; kill Xtmp work files for a re-run
"RTN","DG53591A",189,0)
 S:'$D(NAMSPC) NAMSPC=$$NAMSPC^DG53591A
"RTN","DG53591A",190,0)
 K ^XTMP(NAMSPC)
"RTN","DG53591A",191,0)
 Q
"RTN","DG53591A",192,0)
 ;
"RTN","DG53591A",193,0)
STOP ; alternate stop method
"RTN","DG53591A",194,0)
 S ^XTMP($$NAMSPC,0,"STOP")=""
"RTN","DG53591A",195,0)
 Q
"RTN","DG53591A",196,0)
 ;
"RTN","DG53591A",197,0)
SETUPX(EXPDAY) ;Setup XTMP according to standards and set expiration days
"RTN","DG53591A",198,0)
 N BEGTIME,PURGDT,NAMSPC
"RTN","DG53591A",199,0)
 S NAMSPC=$$NAMSPC^DG53591A
"RTN","DG53591A",200,0)
 S BEGTIME=$$NOW^XLFDT()
"RTN","DG53591A",201,0)
 S PURGDT=$$FMADD^XLFDT(BEGTIME,EXPDAY)
"RTN","DG53591A",202,0)
 S ^XTMP(NAMSPC,0)=PURGDT_U_BEGTIME
"RTN","DG53591A",203,0)
 S $P(^XTMP(NAMSPC,0),U,3)="Cleanup Purged Dependent Income Relations"
"RTN","DG53591A",204,0)
 Q
"RTN","DG53591A",205,0)
 ;
"RTN","DG53591A",206,0)
NAMSPC() ; Return a consistent name space variable
"RTN","DG53591A",207,0)
 Q $T(+0)
"RTN","DG53591A",208,0)
 ;
"RTN","DG53591A",209,0)
MAIL ; mail stats
"RTN","DG53591A",210,0)
 N ACT,LACT,DFN,BTIME,HTEXT,TEXT,NAMSPC,LIN,MSGNO,IVMBAD,IVMPTR,IVMTOT
"RTN","DG53591A",211,0)
 N LSSN,R40831,STS,STSNAM
"RTN","DG53591A",212,0)
 S MSGNO=0
"RTN","DG53591A",213,0)
 S NAMSPC=$$NAMSPC^DG53591A
"RTN","DG53591A",214,0)
 S IVMTOT=$P($G(^XTMP(NAMSPC,0,0)),U,2)
"RTN","DG53591A",215,0)
 S IVMPTR=$P($G(^XTMP(NAMSPC,0,0)),U,3)
"RTN","DG53591A",216,0)
 S BTIME=$P($G(^XTMP(NAMSPC,0,0)),U,4)
"RTN","DG53591A",217,0)
 S STAT=$P($G(^XTMP(NAMSPC,0,0)),U,5)
"RTN","DG53591A",218,0)
 S STIME=$P($G(^XTMP(NAMSPC,0,0)),U,6)
"RTN","DG53591A",219,0)
 S IVMDPTR=$P($G(^XTMP(NAMSPC,0,0)),U,8)
"RTN","DG53591A",220,0)
 ;
"RTN","DG53591A",221,0)
 D HDNG(.HTEXT,.MSGNO,.LIN)
"RTN","DG53591A",222,0)
 D SUMRY(.LIN)
"RTN","DG53591A",223,0)
 D MAILIT(HTEXT)
"RTN","DG53591A",224,0)
 ;
"RTN","DG53591A",225,0)
 D SNDDET
"RTN","DG53591A",226,0)
 Q
"RTN","DG53591A",227,0)
 ;
"RTN","DG53591A",228,0)
HDNG(HTEXT,MSGNO,LIN) ;build heading lines for mail message
"RTN","DG53591A",229,0)
 K ^TMP(NAMSPC,$J,"MSG")
"RTN","DG53591A",230,0)
 S LIN=0
"RTN","DG53591A",231,0)
 S HTEXT="Cleanup Purged Dependent Income Relations completed:"
"RTN","DG53591A",232,0)
 S HTEXT=HTEXT_$$FMTE^XLFDT(STIME,2)
"RTN","DG53591A",233,0)
 D BLDLINE(HTEXT,.LIN)
"RTN","DG53591A",234,0)
 D BLDLINE("",.LIN)
"RTN","DG53591A",235,0)
 I TESTING S TEXT="** TESTING **" D BLDLINE(TEXT,.LIN)
"RTN","DG53591A",236,0)
 I MSGNO S TEXT="Message number: "_MSGNO D BLDLINE(TEXT,.LIN)
"RTN","DG53591A",237,0)
 D BLDLINE("",.LIN)
"RTN","DG53591A",238,0)
 S MSGNO=MSGNO+1
"RTN","DG53591A",239,0)
 Q
"RTN","DG53591A",240,0)
 ;
"RTN","DG53591A",241,0)
SUMRY(LIN) ;build summary lines for mail message
"RTN","DG53591A",242,0)
 S TEXT="     Total Records Processed: "_$J($FN(IVMTOT,","),11)
"RTN","DG53591A",243,0)
 D BLDLINE(TEXT,.LIN)
"RTN","DG53591A",244,0)
 S TEXT="      408.22 recs re-pointed: "_$J($FN(IVMPTR,","),11)
"RTN","DG53591A",245,0)
 D BLDLINE(TEXT,.LIN)
"RTN","DG53591A",246,0)
 S TEXT="      408.1275 recs deleted : "_$J($FN(IVMDPTR,","),11)
"RTN","DG53591A",247,0)
 D BLDLINE(TEXT,.LIN)
"RTN","DG53591A",248,0)
 D BLDLINE("",.LIN)
"RTN","DG53591A",249,0)
 D BLDLINE("",.LIN)
"RTN","DG53591A",250,0)
 D BLDLINE("",.LIN)
"RTN","DG53591A",251,0)
 ;
"RTN","DG53591A",252,0)
 I IVMPTR D
"RTN","DG53591A",253,0)
 . D BLDLINE("Detail changes to follow in subsequent mail messages.",.LIN)
"RTN","DG53591A",254,0)
 Q
"RTN","DG53591A",255,0)
 ;
"RTN","DG53591A",256,0)
SNDDET ;build and send detail messages limit under 2000 lines each
"RTN","DG53591A",257,0)
 N TEXT,GL,MAXLIN,MORE
"RTN","DG53591A",258,0)
 S MAXLIN=1995,MORE=0
"RTN","DG53591A",259,0)
 D HDNG(.HTEXT,.MSGNO,.LIN)
"RTN","DG53591A",260,0)
 ;
"RTN","DG53591A",261,0)
 S GL=$NA(^XTMP(NAMSPC,"DET"))
"RTN","DG53591A",262,0)
 F  S GL=$Q(@GL) Q:GL=""  Q:$QS(GL,1)'=NAMSPC  D
"RTN","DG53591A",263,0)
 . S TEXT=$G(@GL)
"RTN","DG53591A",264,0)
 . S MORE=1                             ;at least 1 more line to send
"RTN","DG53591A",265,0)
 . D BLDLINE(TEXT,.LIN)
"RTN","DG53591A",266,0)
 . ;max lines reached, print a msg
"RTN","DG53591A",267,0)
 . I LIN>MAXLIN D  S MORE=0
"RTN","DG53591A",268,0)
 . . D MAILIT(HTEXT),HDNG(.HTEXT,.MSGNO,.LIN)
"RTN","DG53591A",269,0)
 ;
"RTN","DG53591A",270,0)
 ;print final message if any to print
"RTN","DG53591A",271,0)
 D MAILIT(HTEXT):MORE
"RTN","DG53591A",272,0)
 Q
"RTN","DG53591A",273,0)
 ;
"RTN","DG53591A",274,0)
BLDLINE(TEXT,LIN) ;build a single line into TMP message global
"RTN","DG53591A",275,0)
 S LIN=LIN+1
"RTN","DG53591A",276,0)
 S ^TMP(NAMSPC,$J,"MSG",LIN)=TEXT
"RTN","DG53591A",277,0)
 Q
"RTN","DG53591A",278,0)
MAILIT(HTEXT) ; send the mail message
"RTN","DG53591A",279,0)
 N XMY,XMDUZ,XMSUB,XMTEXT
"RTN","DG53591A",280,0)
 S XMY(DUZ)="",XMDUZ=.5
"RTN","DG53591A",281,0)
 S XMSUB=HTEXT
"RTN","DG53591A",282,0)
 S XMTEXT="^TMP(NAMSPC,$J,""MSG"","
"RTN","DG53591A",283,0)
 D ^XMD
"RTN","DG53591A",284,0)
 Q
"RTN","DG53591B")
0^4^B12730860
"RTN","DG53591B",1,0)
DG53591B ;ALB/GN - DG*5.3*591 CLEANUP FOR PURGED DEPENDENT INCOME 2ND PASS; 3/17/04 12:26pm ; 7/26/04 10:55am
"RTN","DG53591B",2,0)
 ;;5.3;Registration;**591**;Aug 13, 1993
"RTN","DG53591B",3,0)
 Q
"RTN","DG53591B",4,0)
 ; 
"RTN","DG53591B",5,0)
 ; 1. Drive thru the INCOME RELATION file (#408.22) and look for recs
"RTN","DG53591B",6,0)
 ;    whose fields of MARRIED LAST CALENDAR YEAR #.05 and 
"RTN","DG53591B",7,0)
 ;    LIVED WITH PATIENT #.06 are flagged "Y".
"RTN","DG53591B",8,0)
 ; 2. Use the patient DFN to find the corresponding records in the
"RTN","DG53591B",9,0)
 ;    PATIENT RELATION file (#408.12).
"RTN","DG53591B",10,0)
 ; 3. Drive thru the Effective Date records multiple (#408.1275), in
"RTN","DG53591B",11,0)
 ;    reverse order and look for the first spouse rec that is flagged
"RTN","DG53591B",12,0)
 ;    as inactive and points to a MT that does not exist.
"RTN","DG53591B",13,0)
 ; 4. If found, delete this record.  Keep deleting record until a rec
"RTN","DG53591B",14,0)
 ;    is found that points to valid MT.
"RTN","DG53591B",15,0)
 ;
"RTN","DG53591B",16,0)
EN ; Entry to 2nd pass cleanup of dependent recs
"RTN","DG53591B",17,0)
 N DGMT,DGDFN,R21,DG22,LIV,MLY
"RTN","DG53591B",18,0)
 ;
"RTN","DG53591B",19,0)
 ;drive thru 408.22 per each DFN and look at each DFN in reverse order
"RTN","DG53591B",20,0)
 ;to get most recent info on Married last year & living with last year
"RTN","DG53591B",21,0)
 S DGDFN=0
"RTN","DG53591B",22,0)
 F  S DGDFN=$O(^DGMT(408.22,"B",DGDFN)) Q:'DGDFN  D  Q:ZTSTOP
"RTN","DG53591B",23,0)
 . Q:'$D(^DPT(DGDFN,0))
"RTN","DG53591B",24,0)
 . S DG22=""
"RTN","DG53591B",25,0)
 . F  S DG22=$O(^DGMT(408.22,"B",DGDFN,DG22),-1) Q:'+DG22  D
"RTN","DG53591B",26,0)
 . . S MLY=$P($G(^DGMT(408.22,DG22,0)),"^",5)      ;married last year?
"RTN","DG53591B",27,0)
 . . S LIV=$P($G(^DGMT(408.22,DG22,0)),"^",6)      ;living w/last yr?
"RTN","DG53591B",28,0)
 . . S R21=$P($G(^DGMT(408.22,DG22,0)),"^",2)      ;408.21 ien
"RTN","DG53591B",29,0)
 . . S DGMT=$P($G(^DGMT(408.22,DG22,"MT")),"^",1)  ;MT IEN
"RTN","DG53591B",30,0)
 . . Q:DGMT=""                                     ;bad MT=null, quit
"RTN","DG53591B",31,0)
 . . Q:$P($G(^DGMT(408.31,DGMT,0)),"^",23)'=1      ;not VAMC test,quit
"RTN","DG53591B",32,0)
 . . Q:$E(+$G(^DGMT(408.31,DGMT,0)),1,3)<303       ;skip < 2003
"RTN","DG53591B",33,0)
 . . Q:('MLY)!('LIV)!(R21="")
"RTN","DG53591B",34,0)
 . . Q:'$D(^DGMT(408.22,"AMT",DGMT,DGDFN,R21))
"RTN","DG53591B",35,0)
 . . D D40812(DGDFN,R21)
"RTN","DG53591B",36,0)
 . ;update last processed info
"RTN","DG53591B",37,0)
 . S $P(^XTMP(NAMSPC,0,0),U,7)=DGDFN
"RTN","DG53591B",38,0)
 . ;check for stop request after every 20 processed DFN recs
"RTN","DG53591B",39,0)
 . I QQ#20=0 D
"RTN","DG53591B",40,0)
 . . S:$$S^%ZTLOAD ZTSTOP=1
"RTN","DG53591B",41,0)
 . . I $D(^XTMP(NAMSPC,0,"STOP")) S ZTSTOP=1 K ^XTMP(NAMSPC,0,"STOP")
"RTN","DG53591B",42,0)
 ;
"RTN","DG53591B",43,0)
 ;set status
"RTN","DG53591B",44,0)
 I ZTSTOP D
"RTN","DG53591B",45,0)
 . S $P(^XTMP(NAMSPC,0,0),U,5,6)="STOPPED"_U_$$NOW^XLFDT
"RTN","DG53591B",46,0)
 E  D
"RTN","DG53591B",47,0)
 . S $P(^XTMP(NAMSPC,0,0),U,5,6)="COMPLETED"_U_$$NOW^XLFDT
"RTN","DG53591B",48,0)
 ;
"RTN","DG53591B",49,0)
 Q
"RTN","DG53591B",50,0)
 ;
"RTN","DG53591B",51,0)
D40812(DFN,R21) ;drive through 408.12 ien's and process spouse relation recs
"RTN","DG53591B",52,0)
 N R12,ENODE,EIEN,DA,TEXT,SSN
"RTN","DG53591B",53,0)
 Q:R21=""
"RTN","DG53591B",54,0)
 S R12=$P($G(^DGMT(408.21,R21,0)),"^",2)
"RTN","DG53591B",55,0)
 Q:R12=""
"RTN","DG53591B",56,0)
 Q:$P($G(^DGPR(408.12,R12,0)),"^",2)'=2         ;only process spouse
"RTN","DG53591B",57,0)
 ; drive through the Effective Date Multiple in ien reverse order
"RTN","DG53591B",58,0)
 S EIEN="A"
"RTN","DG53591B",59,0)
 F  S EIEN=$O(^DGPR(408.12,R12,"E",EIEN),-1) Q:'EIEN  D  Q:ZTSTOP
"RTN","DG53591B",60,0)
 . S SSN=$E(^DPT(DFN,0),1)_$E($P(^DPT(DFN,0),"^",9),6,9)
"RTN","DG53591B",61,0)
 . S IVMTOT=IVMTOT+1                            ;tot ien's read
"RTN","DG53591B",62,0)
 . S ENODE=$G(^DGPR(408.12,R12,"E",EIEN,0))
"RTN","DG53591B",63,0)
 . Q:+$P(ENODE,"^",2)                           ;active flag, quit
"RTN","DG53591B",64,0)
 . Q:'+$P(ENODE,"^",4)                          ;no MT ien, quit
"RTN","DG53591B",65,0)
 . Q:$D(^DGMT(408.31,$P(ENODE,"^",4),0))        ;ptr to valid MT, quit
"RTN","DG53591B",66,0)
 . ;
"RTN","DG53591B",67,0)
 . ; if inactive and does not point to a valid MT, delete this
"RTN","DG53591B",68,0)
 . ; effective date multiple rec from 408.1275
"RTN","DG53591B",69,0)
 . S DA=EIEN,DA(1)=R12,DIK="^DGPR(408.12,"_DA(1)_",""E"","
"RTN","DG53591B",70,0)
 . D:'TESTING ^DIK
"RTN","DG53591B",71,0)
 . Q:$G(^XTMP(NAMSPC,9999999999.40812,R12,EIEN,"DEL"))=ENODE
"RTN","DG53591B",72,0)
 . S ^XTMP(NAMSPC,9999999999.40812,R12,EIEN,"DEL")=ENODE
"RTN","DG53591B",73,0)
 . S IVMDPTR=IVMDPTR+1                  ;increment del 408.1275 recs
"RTN","DG53591B",74,0)
 . ;
"RTN","DG53591B",75,0)
 . ; add to detail XTMP for mail message
"RTN","DG53591B",76,0)
 . S TEXT=" SSN:"_SSN_"  Del eff date rec "
"RTN","DG53591B",77,0)
 . S TEXT=TEXT_$$FMTE^XLFDT(+ENODE,2)_"  data:"_R12_","_EIEN
"RTN","DG53591B",78,0)
 . S TEXT=TEXT_"="_ENODE_" <bad MT"
"RTN","DG53591B",79,0)
 . W:'$D(ZTQUEUED) !,TEXT
"RTN","DG53591B",80,0)
 . S ^XTMP(NAMSPC,"DET R12",DFN,R12)=TEXT
"RTN","DG53591B",81,0)
 ;
"RTN","DG53591B",82,0)
 ;update last processed info
"RTN","DG53591B",83,0)
 S $P(^XTMP(NAMSPC,0,0),U,2)=IVMTOT            ;last total recs read
"RTN","DG53591B",84,0)
 S $P(^XTMP(NAMSPC,0,0),U,8)=IVMDPTR           ;last del 408.1275 recs
"RTN","DG53591B",85,0)
 Q
"RTN","DG53591C")
0^5^B1118574
"RTN","DG53591C",1,0)
DG53591C ;ALB/GN - DG*5.3*591 CLEANUP FOR PURGED DEPENDENT INCOME RESTORE; 3/17/04 12:26pm ; 8/2/04 3:50pm
"RTN","DG53591C",2,0)
 ;;5.3;Registration;**591**;Aug 13, 1993
"RTN","DG53591C",3,0)
 Q
"RTN","DG53591C",4,0)
TEST ; 
"RTN","DG53591C",5,0)
 S TESTING=1
"RTN","DG53591C",6,0)
EN N DAT,DAT1,DAT2,DAT3,DA,DATA,GL,IEN
"RTN","DG53591C",7,0)
 S TESTING=+$G(TESTING)
"RTN","DG53591C",8,0)
 Q:'$D(^XTMP("DG53591A","DET R12"))
"RTN","DG53591C",9,0)
 M ^XTMP("DG53591A-SAVE","DET R12")=^XTMP("DG53591A","DET R12")
"RTN","DG53591C",10,0)
 S GL=$NA(^XTMP("DG53591A-SAVE","DET R12"))
"RTN","DG53591C",11,0)
 F  S GL=$Q(@GL) Q:GL=""  Q:$QS(GL,2)'="DET R12"  D
"RTN","DG53591C",12,0)
 . K DA,DATA,EIN
"RTN","DG53591C",13,0)
 . S DAT=$P(@GL,":",3)
"RTN","DG53591C",14,0)
 . S DAT1=$P(DAT,"="),DAT2=$P(DAT,"=",2)
"RTN","DG53591C",15,0)
 . S DAT3=$P(DAT2," <")
"RTN","DG53591C",16,0)
 . S DA(1)=$P(DAT1,","),IEN=$P(DAT1,",",2)
"RTN","DG53591C",17,0)
 . Q:('DA(1))!('IEN)
"RTN","DG53591C",18,0)
 . S DATA(.01)=$P(DAT3,"^")
"RTN","DG53591C",19,0)
 . S DATA(.02)=$P(DAT3,"^",2)
"RTN","DG53591C",20,0)
 . S DATA(.03)=$P(DAT3,"^",3)
"RTN","DG53591C",21,0)
 . S DATA(.04)=$P(DAT3,"^",4)
"RTN","DG53591C",22,0)
 . I 'TESTING,$$ADD^DGENDBS(408.1275,.DA,.DATA,,IEN)
"RTN","DG53591C",23,0)
 Q
"RTN","DG53591M")
0^3^B11725114
"RTN","DG53591M",1,0)
DG53591M ;ALB/GN - DG*5.3*591 CLEANUP UTILITES ; 6/14/04 1:35pm
"RTN","DG53591M",2,0)
 ;;5.3;Registration;**591**;Aug 13, 1993
"RTN","DG53591M",3,0)
 ;
"RTN","DG53591M",4,0)
 ; Misc cleanup utilities
"RTN","DG53591M",5,0)
 ;
"RTN","DG53591M",6,0)
MAIL ; mail stats
"RTN","DG53591M",7,0)
 N ACT,LACT,DFN,BTIME,HTEXT,TEXT,NAMSPC,LIN,MSGNO,IVMBAD,IVMPUR,IVMTOT
"RTN","DG53591M",8,0)
 N LSSN,R40831,STS,STSNAM,STAT,MTIEN,STIME,TYPE,TYPNAM
"RTN","DG53591M",9,0)
 S MSGNO=0
"RTN","DG53591M",10,0)
 S NAMSPC=$$NAMSPC^DG53591
"RTN","DG53591M",11,0)
 S IVMTOT=$P($G(^XTMP(NAMSPC,0,0)),U,2)
"RTN","DG53591M",12,0)
 S IVMPUR=$P($G(^XTMP(NAMSPC,0,0)),U,3)
"RTN","DG53591M",13,0)
 S BTIME=$P($G(^XTMP(NAMSPC,0,0)),U,4)
"RTN","DG53591M",14,0)
 S STAT=$P($G(^XTMP(NAMSPC,0,0)),U,5)
"RTN","DG53591M",15,0)
 S STIME=$P($G(^XTMP(NAMSPC,0,0)),U,6)
"RTN","DG53591M",16,0)
 S IVMBAD=$P($G(^XTMP(NAMSPC,0,0)),U,7)
"RTN","DG53591M",17,0)
 ;
"RTN","DG53591M",18,0)
 D HDNG(.HTEXT,.MSGNO,.LIN)
"RTN","DG53591M",19,0)
 D SUMRY(.LIN)
"RTN","DG53591M",20,0)
 D MAILIT(HTEXT)
"RTN","DG53591M",21,0)
 ;
"RTN","DG53591M",22,0)
 D SNDDET
"RTN","DG53591M",23,0)
 Q
"RTN","DG53591M",24,0)
 ;
"RTN","DG53591M",25,0)
HDNG(HTEXT,MSGNO,LIN) ;build heading lines for mail message
"RTN","DG53591M",26,0)
 K ^TMP(NAMSPC,$J,"MSG")
"RTN","DG53591M",27,0)
 S LIN=0
"RTN","DG53591M",28,0)
 S HTEXT="Cleanup Bad Threshold Tests "_STAT_" on "
"RTN","DG53591M",29,0)
 S HTEXT=HTEXT_$$FMTE^XLFDT(STIME)
"RTN","DG53591M",30,0)
 D BLDLINE(HTEXT,.LIN)
"RTN","DG53591M",31,0)
 D BLDLINE("",.LIN)
"RTN","DG53591M",32,0)
 I TESTING S TEXT="** TESTING **" D BLDLINE(TEXT,.LIN)
"RTN","DG53591M",33,0)
 I MSGNO S TEXT="Message number: "_MSGNO D BLDLINE(TEXT,.LIN)
"RTN","DG53591M",34,0)
 D BLDLINE("",.LIN)
"RTN","DG53591M",35,0)
 S MSGNO=MSGNO+1
"RTN","DG53591M",36,0)
 Q
"RTN","DG53591M",37,0)
 ;
"RTN","DG53591M",38,0)
SUMRY(LIN) ;build summary lines for mail message
"RTN","DG53591M",39,0)
 S TEXT="     Total Records Processed: "_$J($FN(IVMTOT,","),11)
"RTN","DG53591M",40,0)
 D BLDLINE(TEXT,.LIN)
"RTN","DG53591M",41,0)
 S TEXT="  Bad Threshold Tests Purged: "_$J($FN(IVMPUR,","),11)
"RTN","DG53591M",42,0)
 D BLDLINE(TEXT,.LIN)
"RTN","DG53591M",43,0)
 D BLDLINE("",.LIN)
"RTN","DG53591M",44,0)
 D BLDLINE("",.LIN)
"RTN","DG53591M",45,0)
 D BLDLINE("",.LIN)
"RTN","DG53591M",46,0)
 ;
"RTN","DG53591M",47,0)
 I IVMPUR D
"RTN","DG53591M",48,0)
 . D BLDLINE("Detail changes to follow in subsequent mail messages.",.LIN)
"RTN","DG53591M",49,0)
 Q
"RTN","DG53591M",50,0)
 ;
"RTN","DG53591M",51,0)
SNDDET ;build and send detail messages limit under 2000 lines each
"RTN","DG53591M",52,0)
 N DATE,GL,MAXLIN,MORE,NAME,SSN
"RTN","DG53591M",53,0)
 S MAXLIN=1995,MORE=0
"RTN","DG53591M",54,0)
 D HDNG(.HTEXT,.MSGNO,.LIN)
"RTN","DG53591M",55,0)
 D BLDLINE("'*' = Delete, '**' = Delete Linked Test, '>' = Re-transmitted",.LIN)
"RTN","DG53591M",56,0)
 ;
"RTN","DG53591M",57,0)
 S GL=$NA(^XTMP(NAMSPC,1)),LSSN=""
"RTN","DG53591M",58,0)
 F  S GL=$Q(@GL) Q:GL=""  Q:$QS(GL,1)'=NAMSPC  D
"RTN","DG53591M",59,0)
 . S ACT=$QS(GL,3) Q:ACT="PNTLNK"
"RTN","DG53591M",60,0)
 . S R40831=$G(@GL)
"RTN","DG53591M",61,0)
 . S MORE=1                             ;at least 1 more line to send
"RTN","DG53591M",62,0)
 . S DFN=$QS(GL,2)
"RTN","DG53591M",63,0)
 . S MTIEN=$QS(GL,5)
"RTN","DG53591M",64,0)
 . S SSN=$P($G(^DPT(DFN,0)),"^",9),NAME=$P($G(^DPT(DFN,0)),"^")
"RTN","DG53591M",65,0)
 . S DATE=$$FMTE^XLFDT($P(R40831,"^"))
"RTN","DG53591M",66,0)
 . S STS=$P(R40831,"^",3),STSNAM=""
"RTN","DG53591M",67,0)
 . S:STS]"" STSNAM=$P($G(^DG(408.32,STS,0)),"^")
"RTN","DG53591M",68,0)
 . S TYPE=$P(R40831,"^",19),TYPNAM=""
"RTN","DG53591M",69,0)
 . S:TYPE]"" TYPNAM=$G(^DG(408.33,TYPE,0))
"RTN","DG53591M",70,0)
 . S TEXT=NAME_"  ssn: "_SSN
"RTN","DG53591M",71,0)
 . D:SSN'=LSSN BLDLINE(TEXT,.LIN)
"RTN","DG53591M",72,0)
 . S TEXT="    "
"RTN","DG53591M",73,0)
 . S:ACT="BAD" TEXT=" *  "
"RTN","DG53591M",74,0)
 . S:ACT="DELLNK" TEXT=" ** "
"RTN","DG53591M",75,0)
 . S:ACT="GOOD" TEXT=" >  "
"RTN","DG53591M",76,0)
 . S TEXT=TEXT_DATE_$J(TYPNAM,24)_" "_$J(STSNAM,20)_" ien: "_MTIEN
"RTN","DG53591M",77,0)
 . D BLDLINE(TEXT,.LIN)
"RTN","DG53591M",78,0)
 . S LSSN=SSN,LACT=ACT
"RTN","DG53591M",79,0)
 . ;max lines reached, print a msg
"RTN","DG53591M",80,0)
 . I LIN>MAXLIN D  S MORE=0
"RTN","DG53591M",81,0)
 . . D MAILIT(HTEXT),HDNG(.HTEXT,.MSGNO,.LIN)
"RTN","DG53591M",82,0)
 . . D BLDLINE("'*' = Delete, '**' = Delete Linked Test, '>' = Re-transmitted",.LIN)
"RTN","DG53591M",83,0)
 ;
"RTN","DG53591M",84,0)
 ;print final message if any to print
"RTN","DG53591M",85,0)
 D MAILIT(HTEXT):MORE
"RTN","DG53591M",86,0)
 Q
"RTN","DG53591M",87,0)
 ;
"RTN","DG53591M",88,0)
BLDLINE(TEXT,LIN) ;build a single line into TMP message global
"RTN","DG53591M",89,0)
 S LIN=LIN+1
"RTN","DG53591M",90,0)
 S ^TMP(NAMSPC,$J,"MSG",LIN)=TEXT
"RTN","DG53591M",91,0)
 Q
"RTN","DG53591M",92,0)
MAILIT(HTEXT) ; send the mail message
"RTN","DG53591M",93,0)
 N XMY,XMDUZ,XMSUB,XMTEXT
"RTN","DG53591M",94,0)
 S XMY(DUZ)="",XMDUZ=.5
"RTN","DG53591M",95,0)
 S XMSUB=HTEXT
"RTN","DG53591M",96,0)
 S XMTEXT="^TMP(NAMSPC,$J,""MSG"","
"RTN","DG53591M",97,0)
 D ^XMD
"RTN","DG53591M",98,0)
 Q
"VER")
8.0^22
**END**
**END**
