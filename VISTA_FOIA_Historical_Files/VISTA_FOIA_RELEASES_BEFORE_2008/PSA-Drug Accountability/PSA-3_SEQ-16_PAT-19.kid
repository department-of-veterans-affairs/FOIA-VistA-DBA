Released PSA*3*19 SEQ #16
Extracted from mail message
**KIDS**:PSA*3.0*19^

**INSTALL NAME**
PSA*3.0*19
"BLD",770,0)
PSA*3.0*19^DRUG ACCOUNTABILITY^0^2990913^y
"BLD",770,1,0)
^^6^6^2990913^^^
"BLD",770,1,1,0)
  When an invoice is uploaded, the program checks for the UPC and NDC. If
"BLD",770,1,2,0)
 these fields are not populated, the program exits. A check for the VSN
"BLD",770,1,3,0)
 was added to enable the program to continue.
"BLD",770,1,4,0)
 
"BLD",770,1,5,0)
  This will also cause problems in the verify portion. A check has been
"BLD",770,1,6,0)
 added to one of the verification routines.
"BLD",770,"KRN",0)
^9.67PA^^
"BLD",770,"KRN",.4,0)
.4
"BLD",770,"KRN",.4,"NM",0)
^9.68A^^0
"BLD",770,"KRN",.401,0)
.401
"BLD",770,"KRN",.401,"NM",0)
^9.68A^^0
"BLD",770,"KRN",.402,0)
.402
"BLD",770,"KRN",.402,"NM",0)
^9.68A^^0
"BLD",770,"KRN",.403,0)
.403
"BLD",770,"KRN",.5,0)
.5
"BLD",770,"KRN",.84,0)
.84
"BLD",770,"KRN",3.6,0)
3.6
"BLD",770,"KRN",3.8,0)
3.8
"BLD",770,"KRN",9.2,0)
9.2
"BLD",770,"KRN",9.8,0)
9.8
"BLD",770,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",770,"KRN",9.8,"NM",1,0)
PSAUP2^^0^B17057001
"BLD",770,"KRN",9.8,"NM",2,0)
PSAVER3^^0^B71008661
"BLD",770,"KRN",9.8,"NM","B","PSAUP2",1)

"BLD",770,"KRN",9.8,"NM","B","PSAVER3",2)

"BLD",770,"KRN",19,0)
19
"BLD",770,"KRN",19.1,0)
19.1
"BLD",770,"KRN",101,0)
101
"BLD",770,"KRN",409.61,0)
409.61
"BLD",770,"KRN",771,0)
771
"BLD",770,"KRN",869.2,0)
869.2
"BLD",770,"KRN",870,0)
870
"BLD",770,"KRN",8994,0)
8994
"BLD",770,"KRN","B",.4,.4)

"BLD",770,"KRN","B",.401,.401)

"BLD",770,"KRN","B",.402,.402)

"BLD",770,"KRN","B",.403,.403)

"BLD",770,"KRN","B",.5,.5)

"BLD",770,"KRN","B",.84,.84)

"BLD",770,"KRN","B",3.6,3.6)

"BLD",770,"KRN","B",3.8,3.8)

"BLD",770,"KRN","B",9.2,9.2)

"BLD",770,"KRN","B",9.8,9.8)

"BLD",770,"KRN","B",19,19)

"BLD",770,"KRN","B",19.1,19.1)

"BLD",770,"KRN","B",101,101)

"BLD",770,"KRN","B",409.61,409.61)

"BLD",770,"KRN","B",771,771)

"BLD",770,"KRN","B",869.2,869.2)

"BLD",770,"KRN","B",870,870)

"BLD",770,"KRN","B",8994,8994)

"BLD",770,"QUES",0)
^9.62^^
"BLD",770,"REQB",0)
^9.611^1^1
"BLD",770,"REQB",1,0)
PSA*3.0*3^1
"BLD",770,"REQB","B","PSA*3.0*3",1)

"BLD",770,"REQG",0)
^9.611^^
"PKG",182,-1)
1^1
"PKG",182,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability/Inventory Interface^
"PKG",182,20,0)
^9.402P^^0
"PKG",182,22,0)
^9.49I^1^1
"PKG",182,22,1,0)
3.0^2990610^2970912^531
"PKG",182,22,1,"PAH",1,0)
19^2990913
"PKG",182,22,1,"PAH",1,1,0)
^^6^6^2991102
"PKG",182,22,1,"PAH",1,1,1,0)
  When an invoice is uploaded, the program checks for the UPC and NDC. If
"PKG",182,22,1,"PAH",1,1,2,0)
 these fields are not populated, the program exits. A check for the VSN
"PKG",182,22,1,"PAH",1,1,3,0)
 was added to enable the program to continue.
"PKG",182,22,1,"PAH",1,1,4,0)
 
"PKG",182,22,1,"PAH",1,1,5,0)
  This will also cause problems in the verify portion. A check has been
"PKG",182,22,1,"PAH",1,1,6,0)
 added to one of the verification routines.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSAUP2")
0^1^B17057001
"RTN","PSAUP2",1,0)
PSAUP2 ;BIR/JMB-Upload and Process Prime Vendor Invoice Data - CONT'D ;8/13/97
"RTN","PSAUP2",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**19**; 10/24/97
"RTN","PSAUP2",3,0)
 ;Checking the X12 invoice data.
"RTN","PSAUP2",4,0)
 K ^TMP("PSAPV SET",$J),PSAERR
"RTN","PSAUP2",5,0)
 S PSALAST=""
"RTN","PSAUP2",6,0)
 S PSALINE=0 F  S PSALINE=$O(^TMP("PSAPVS",$J,PSALINE)) Q:PSALINE=""  S PSADATA=^(PSALINE) D
"RTN","PSAUP2",7,0)
 .;check segment order
"RTN","PSAUP2",8,0)
 .D ^PSAUP3 S PSALAST=$P(PSADATA,"^")
"RTN","PSAUP2",9,0)
ISA .;control header
"RTN","PSAUP2",10,0)
 .I PSALAST="ISA" D  Q
"RTN","PSAUP2",11,0)
 ..S PSAISA=PSADATA,PSACTRL="" W "." I $L($P(PSADATA,"^",14))'=9 S PSASEG="ISA" D MSG^PSAUTL2
"RTN","PSAUP2",12,0)
 .;
"RTN","PSAUP2",13,0)
IEA .;control trailer
"RTN","PSAUP2",14,0)
 .I PSALAST="IEA" D  Q
"RTN","PSAUP2",15,0)
 ..I $P(PSADATA,"^",3)'=$P(PSAISA,"^",14) S PSASEG="IEA" D MSG^PSAUTL2
"RTN","PSAUP2",16,0)
 .;
"RTN","PSAUP2",17,0)
GS .;group header
"RTN","PSAUP2",18,0)
 .I PSALAST="GS" S PSAGS=PSADATA D  Q
"RTN","PSAUP2",19,0)
 ..F %=3,4 S PSAPC=$S(%=3:7,1:9) I $P(PSADATA,"^",%)'=$TR($P(PSAISA,"^",PSAPC)," ") S PSASEG="GS" D MSG^PSAUTL2
"RTN","PSAUP2",20,0)
 .;
"RTN","PSAUP2",21,0)
GE .;group trailer
"RTN","PSAUP2",22,0)
 .I PSALAST="GE" D  Q
"RTN","PSAUP2",23,0)
 ..I $P(PSADATA,"^",3)'=$P($G(PSAGS),"^",7) S PSASEG="GE" D MSG^PSAUTL2
"RTN","PSAUP2",24,0)
 .;
"RTN","PSAUP2",25,0)
ST .;set header
"RTN","PSAUP2",26,0)
 .I PSALAST="ST" D  Q
"RTN","PSAUP2",27,0)
 ..S PSAST=PSADATA,PSACTRL=$P(PSADATA,"^",3),PSASTCNT=1,PSAITCNT=0,PSANTYPE=""
"RTN","PSAUP2",28,0)
 ..I $L(PSACTRL)>3,$L(PSACTRL)<10 Q
"RTN","PSAUP2",29,0)
 ..S PSASEG="ST" D MSG^PSAUTL2 Q
"RTN","PSAUP2",30,0)
 .;
"RTN","PSAUP2",31,0)
SE .;set trailer
"RTN","PSAUP2",32,0)
 .I PSALAST="SE" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSAUP2",33,0)
 ..I $P(PSADATA,"^",3)'=PSACTRL S PSASEG="SE1" D MSG^PSAUTL2 Q
"RTN","PSAUP2",34,0)
 ..I PSASTCNT'=$P(PSADATA,"^",2) S PSASEG="SE2" D MSG^PSAUTL2
"RTN","PSAUP2",35,0)
 .;
"RTN","PSAUP2",36,0)
BIG .;beginning segment for invoice
"RTN","PSAUP2",37,0)
 .I PSALAST="BIG" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSAUP2",38,0)
 ..I $P(PSADATA,"^",4)="" S $P(PSADATA,"^",4)=$P(PSADATA,"^",2)
"RTN","PSAUP2",39,0)
 ..S $P(PSADATA,"^",5)=$TR($P(PSADATA,"^",5)," ")
"RTN","PSAUP2",40,0)
 ..S ^TMP("PSAPV SET",$J,PSACTRL,"IN")=$P(PSADATA,"^",2,5)
"RTN","PSAUP2",41,0)
 .;
"RTN","PSAUP2",42,0)
REF .;(not used)
"RTN","PSAUP2",43,0)
 .I PSALAST="REF" S PSASTCNT=PSASTCNT+1 Q
"RTN","PSAUP2",44,0)
 .;
"RTN","PSAUP2",45,0)
 .;buyer, seller, shipping addresses
"RTN","PSAUP2",46,0)
N1 .I PSALAST="N1" S PSASTCNT=PSASTCNT+1,PSANTYPE=$P(PSADATA,"^",2) D  Q
"RTN","PSAUP2",47,0)
 ..I PSANTYPE'="BY",PSANTYPE'="DS",PSANTYPE'="ST" S PSASEG="N1" D MSG^PSAUTL2 Q
"RTN","PSAUP2",48,0)
 ..S ^TMP("PSAPV SET",$J,PSACTRL,PSANTYPE)=$P(PSADATA,"^",3)
"RTN","PSAUP2",49,0)
 .;
"RTN","PSAUP2",50,0)
N2 .I PSALAST="N2" D  Q
"RTN","PSAUP2",51,0)
 ..D:PSANTYPE="" NTYPE
"RTN","PSAUP2",52,0)
 ..S $P(^TMP("PSAPV SET",$J,PSACTRL,PSANTYPE),"^",2)=$P(PSADATA,"^",2) S PSASTCNT=PSASTCNT+1
"RTN","PSAUP2",53,0)
 .;
"RTN","PSAUP2",54,0)
N3 .I PSALAST="N3" D  Q
"RTN","PSAUP2",55,0)
 ..D:PSANTYPE="" NTYPE
"RTN","PSAUP2",56,0)
 ..S $P(^TMP("PSAPV SET",$J,PSACTRL,PSANTYPE),"^",3)=$P(PSADATA,"^",2) S PSASTCNT=PSASTCNT+1
"RTN","PSAUP2",57,0)
 .;
"RTN","PSAUP2",58,0)
N4 .I PSALAST="N4" D  Q
"RTN","PSAUP2",59,0)
 ..D:PSANTYPE="" NTYPE
"RTN","PSAUP2",60,0)
 ..S $P(^TMP("PSAPV SET",$J,PSACTRL,PSANTYPE),"^",4,6)=$P(PSADATA,"^",2,4) S PSASTCNT=PSASTCNT+1,PSANTYPE=""
"RTN","PSAUP2",61,0)
 .;
"RTN","PSAUP2",62,0)
DTM .;date time reference
"RTN","PSAUP2",63,0)
 .I PSALAST="DTM" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSAUP2",64,0)
 ..S %=$S($P(PSADATA,"^",2)="002":5,$P(PSADATA,"^",2)="035":6,1:0) I '% Q
"RTN","PSAUP2",65,0)
 ..S $P(^TMP("PSAPV SET",$J,PSACTRL,"IN"),"^",%)=$P(PSADATA,"^",3)
"RTN","PSAUP2",66,0)
 .;
"RTN","PSAUP2",67,0)
IT1 .;invoice line item
"RTN","PSAUP2",68,0)
 .I PSALAST="IT1" S PSASTCNT=PSASTCNT+1,PSAITCNT=PSAITCNT+1 D ITEM Q
"RTN","PSAUP2",69,0)
CTT .;item count
"RTN","PSAUP2",70,0)
 .I PSALAST="CTT" S PSASTCNT=PSASTCNT+1 D  Q
"RTN","PSAUP2",71,0)
 ..I PSAITCNT'=$P(PSADATA,"^",2) S PSASEG="CTT" D MSG^PSAUTL2
"RTN","PSAUP2",72,0)
 .;
"RTN","PSAUP2",73,0)
UNKNOWN .;Segment we don't use
"RTN","PSAUP2",74,0)
 .S PSASTCNT=PSASTCNT+1
"RTN","PSAUP2",75,0)
 ;
"RTN","PSAUP2",76,0)
ERROR S PSASEG=$O(PSAERR("")) D:PSASEG'="" ERROR^PSAUTL2
"RTN","PSAUP2",77,0)
 Q
"RTN","PSAUP2",78,0)
 ;
"RTN","PSAUP2",79,0)
NTYPE S PSASEG="NONTYPE" D MSG^PSAUTL2
"RTN","PSAUP2",80,0)
 Q
"RTN","PSAUP2",81,0)
 ;
"RTN","PSAUP2",82,0)
ITEM ;check line item
"RTN","PSAUP2",83,0)
 I '$P(PSADATA,"^",2) S PSASEG="IT1-1" D MSG^PSAUTL2 Q
"RTN","PSAUP2",84,0)
 I $P(PSADATA,"^",6)'="DS" S PSASEG="IT1-2" D MSG^PSAUTL2 Q
"RTN","PSAUP2",85,0)
 ;DAVE B (PSA*3*19) check for piece 10 (VSN) added
"RTN","PSAUP2",86,0)
 I $P(PSADATA,"^",8)="",$P(PSADATA,"^",10)="",$P(PSADATA,"^",12)="" S PSASEG="IT1-3" D MSG^PSAUTL2 Q
"RTN","PSAUP2",87,0)
 ;"IT1" Seg=Qty Invoiced ^ Unit of Measure ^ Unit Price ^ Basic Unit Code "DS" ^ NDC ^ VSN
"RTN","PSAUP2",88,0)
 S PSAITEM=+$P(PSADATA,"^",2),^TMP("PSAPV SET",$J,PSACTRL,"IT",PSAITEM)=+$P(PSADATA,"^",3)_"^"_$P(PSADATA,"^",4)_"^"_$P(PSADATA,"^",5)_"^"_$P(PSADATA,"^",8)_"^"_$P(PSADATA,"^",10)
"RTN","PSAUP2",89,0)
 I $P(PSADATA,"^",12)'="",$P(PSADATA,"^",11)="UP" S $P(^TMP("PSAPV SET",$J,PSACTRL,"IT",PSAITEM),"^",26)=$P(PSADATA,"^",12)
"RTN","PSAUP2",90,0)
 Q
"RTN","PSAVER3")
0^2^B71008661
"RTN","PSAVER3",1,0)
PSAVER3 ;BIR/JMB-Verify Invoices - CONT'D ;9/5/97
"RTN","PSAVER3",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,19**; 10/24/97
"RTN","PSAVER3",3,0)
 ;This routine checks for verification errors, prints an error report,
"RTN","PSAVER3",4,0)
 ;& changes data in DA ORDERS to verification if there are no errors.
"RTN","PSAVER3",5,0)
 ;
"RTN","PSAVER3",6,0)
 ;References to ^DIC(51.5 are covered by DBIA # 1931
"RTN","PSAVER3",7,0)
 ;References to ^PSDRUG( are covered by DBIA #2095
"RTN","PSAVER3",8,0)
 ;
"RTN","PSAVER3",9,0)
SETLINE ;Set line as verified if all data is present.
"RTN","PSAVER3",10,0)
 K PSADRG,PSAOU,PSAQTY S (PSADJN,PSADJ)=0
"RTN","PSAVER3",11,0)
 S PSADATA=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0))
"RTN","PSAVER3",12,0)
 I $O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) D
"RTN","PSAVER3",13,0)
 .S PSAA=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,0)) Q:PSAA=2
"RTN","PSAVER3",14,0)
 .S PSADJ=0 F  S PSADJ=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ)) Q:'PSADJ  D
"RTN","PSAVER3",15,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAVER3",16,0)
 ..S PSADJN=^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)
"RTN","PSAVER3",17,0)
 ..I $P(PSADJN,"^")="D" D
"RTN","PSAVER3",18,0)
 ...I (+$P(PSADJN,"^",9)&($P(PSADJN,"^",6)'?.N))!('+$P(PSADJN,"^",9)&(+$P(PSADJN,"^",5))&($P(PSADJN,"^",2)'?.N)) S PSASUP=PSASUP+1,PSALNSU=1,PSADRG=0 Q
"RTN","PSAVER3",19,0)
 ...S PSADRG=$S($P(PSADJN,"^",6)'="":$P(PSADJN,"^",6),$P(PSADJN,"^",2)'="":$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",20,0)
 ..I $P(PSADJN,"^")="O" S PSAOU=$S(+$P(PSADJN,"^",6):+$P(PSADJN,"^",6),+$P(PSADJN,"^",2):+$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",21,0)
 ..I $P(PSADJN,"^")="Q" S PSAQTY=$S($P(PSADJN,"^",6)'="":+$P(PSADJN,"^",6),$P(PSADJN,"^",2)'="":+$P(PSADJN,"^",2),1:0)
"RTN","PSAVER3",22,0)
 S:'$G(PSADRG) PSADRG=+$P(PSADATA,"^",2) S:'$D(PSAQTY) PSAQTY=+$P(PSADATA,"^",3)
"RTN","PSAVER3",23,0)
 ;DAVE B (13SEP99) PSA*3*19 If item is supply, skip this area
"RTN","PSAVER3",24,0)
 I $G(PSALNSU)=1,$G(PSADRG)=0,$G(PSASUP)>0 G SUPPLY
"RTN","PSAVER3",25,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2)),PSANDC=$P(PSADATA,"^",11)
"RTN","PSAVER3",26,0)
 ;DAVE B (PSA*3*19) Check for exisitence of NDC
"RTN","PSAVER3",27,0)
 S PSASUB=$S(+$P(PSATEMP,"^",3):+$P(PSATEMP,"^",3),1:0) ;NDC may be zero
"RTN","PSAVER3",28,0)
 I $G(PSANDC)'="",$G(PSANDC)'=0,$G(PSADRG)'="",$G(PSADRG)'=0,$D(^PSDRUG("C",PSANDC,PSADRG)) S PSASUB=$S($G(PSASUB):$G(PSASUB),+$O(^PSDRUG("C",PSANDC,PSADRG,0)):+$O(^PSDRUG("C",PSANDC,PSADRG,0)),1:0)
"RTN","PSAVER3",29,0)
 S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAVER3",30,0)
 I '$D(PSAOU) D
"RTN","PSAVER3",31,0)
 .I +$P(PSADATA,"^",4),$P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^")'="" S PSAOU=+$P(PSADATA,"^",4) Q
"RTN","PSAVER3",32,0)
 .I PSADRG,PSASUB,$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",5) S PSAOU=$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",5) Q
"RTN","PSAVER3",33,0)
 .I $P(PSATEMP,"^",5)'="",+$P($P(PSATEMP,"^",5),"~",2) S PSAOU=+$P($P(PSATEMP,"^",5),"~",2)
"RTN","PSAVER3",34,0)
 I PSASUB D
"RTN","PSAVER3",35,0)
 .;Next line added 8APR98 (Dave B)
"RTN","PSAVER3",36,0)
 .S PSALOC=$S($G(PSALOC)'="":PSALOC,1:$S($P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",12):$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",12),$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",5):$P(^PSD(58.811,PSAIEN,1,PSAIEN1,0),"^",5),1:0))
"RTN","PSAVER3",37,0)
 .S:'PSADUOU PSADUOU=$S(PSADRG&(+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(PSADRG,1,PSASUB,0)),"^",7),1:0)
"RTN","PSAVER3",38,0)
 .S:'PSASTOCK PSASTOCK=$S(PSADRG:+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",3),1:0)
"RTN","PSAVER3",39,0)
 .S:'PSAREORD PSAREORD=$S(PSADRG:+$P($G(^PSD(58.8,PSALOC,1,PSADRG,0)),"^",5),1:0)
"RTN","PSAVER3",40,0)
 ;
"RTN","PSAVER3",41,0)
SUPPLY ;If it is a supply, automatically verify it.
"RTN","PSAVER3",42,0)
 I '+$G(PSAERR),PSALNSU,'$G(PSAPRINT) D VERIFY,VERIFY1 Q
"RTN","PSAVER3",43,0)
 ;
"RTN","PSAVER3",44,0)
NEWDRUG ;Store in array if drug is new to location/vault
"RTN","PSAVER3",45,0)
 I +PSADRG D
"RTN","PSAVER3",46,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N",+$P(PSAIN,"^",12),'$D(^PSD(58.8,+$P(PSAIN,"^",12),1,PSADRG,0)) D
"RTN","PSAVER3",47,0)
 ..S PSAHOLD(+$P(PSAIN,"^",12),PSAIEN,PSAIEN1,$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P($G(^PSDRUG(PSADRG,0)),"^"),1:"UNKNOWN"))=PSADRG,$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=1
"RTN","PSAVER3",48,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)'["N",+$P(PSAIN,"^",5),'$D(^PSD(58.8,+$P(PSAIN,"^",5),1,PSADRG,0)) D
"RTN","PSAVER3",49,0)
 ..S PSAHOLD(+$P(PSAIN,"^",5),PSAIEN,PSAIEN1,$S($P($G(^PSDRUG(PSADRG,0)),"^")'="":$P($G(^PSDRUG(PSADRG,0)),"^"),1:"UNKNOWN"))=PSADRG,$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=0
"RTN","PSAVER3",50,0)
 ;
"RTN","PSAVER3",51,0)
NOTSUP ;If it is not a supply, look for drug, qty, dispense units, dispense
"RTN","PSAVER3",52,0)
 ;units/order unit, order unit, location/master vault, & reorder level
"RTN","PSAVER3",53,0)
 I '+$P(PSADATA,"^",2)&('$G(PSADRG)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"D"
"RTN","PSAVER3",54,0)
 I $P(PSADATA,"^",3)=""&($G(PSAQTY)="") S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"Q"
"RTN","PSAVER3",55,0)
 I $P($G(^PSDRUG(PSADRG,660)),"^",8)="" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_8
"RTN","PSAVER3",56,0)
 I '+$P($G(^PSDRUG(PSADRG,1,+PSASUB,0)),"^",7)&('+$G(PSADUOU)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"U"
"RTN","PSAVER3",57,0)
 I '+$P(PSADATA,"^",4)&('$G(PSAOU)) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"O"
"RTN","PSAVER3",58,0)
 ;
"RTN","PSAVER3",59,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",3)'["N" D
"RTN","PSAVER3",60,0)
 .I '+$P(PSAIN,"^",5) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"P" D CS^PSAVER5
"RTN","PSAVER3",61,0)
 .S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=0,PSADATA=^(0)
"RTN","PSAVER3",62,0)
 I $P(PSAIN,"^",8)="N"!($P(PSAIN,"^",8)="S"),'+$P(PSAIN,"^",5),$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))'["P" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"P"
"RTN","PSAVER3",63,0)
 ;
"RTN","PSAVER3",64,0)
 I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N" D
"RTN","PSAVER3",65,0)
 .I '+$P(PSAIN,"^",12) S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"M" D CS^PSAVER5
"RTN","PSAVER3",66,0)
 .S $P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0),"^",10)=1,PSADATA=^(0)
"RTN","PSAVER3",67,0)
 I $P(PSAIN,"^",8)="A"!($P(PSAIN,"^",8)="S"),'+$P(PSAIN,"^",12),$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))'["M" S PSANOVER(PSAIEN,PSAIEN1,PSALINE)=$G(PSANOVER(PSAIEN,PSAIEN1,PSALINE))_"M"
"RTN","PSAVER3",68,0)
 ;
"RTN","PSAVER3",69,0)
 S:$D(PSANOVER(PSAIEN,PSAIEN1,PSALINE)) PSAERR=PSAERR+1,PSALNERR=1
"RTN","PSAVER3",70,0)
 I 'PSAERR D GOOD Q
"RTN","PSAVER3",71,0)
 Q
"RTN","PSAVER3",72,0)
 ;
"RTN","PSAVER3",73,0)
GOOD ;If no errors found, verify invoice.
"RTN","PSAVER3",74,0)
 D VERIFY,VERIFY1
"RTN","PSAVER3",75,0)
 S PSAL=0 F  S PSAL=+$O(PSAHOLD(PSAL)) Q:'PSAL  D
"RTN","PSAVER3",76,0)
 .S PSANAME="" F  S PSANAME=$O(PSAHOLD(PSAL,PSAIEN,PSAIEN1,PSANAME)) Q:PSANAME=""  D
"RTN","PSAVER3",77,0)
 ..S PSANEWD(PSAL,PSANAME)=PSAHOLD(PSAL,PSAIEN,PSAIEN1,PSANAME)
"RTN","PSAVER3",78,0)
 K PSAHOLD
"RTN","PSAVER3",79,0)
 Q
"RTN","PSAVER3",80,0)
 ;
"RTN","PSAVER3",81,0)
PRINT ;Prints verification error list
"RTN","PSAVER3",82,0)
 S DIR(0)="Y",DIR("A")="Do you want to print the verification error report",DIR("B")="N"
"RTN","PSAVER3",83,0)
 S DIR("?",1)="Enter YES if you want to print the report just displayed.",DIR("?")="Enter NO if you do not want to print the report.",DIR("??")="^D PRINTYN^PSAVER3"
"RTN","PSAVER3",84,0)
 D ^DIR K DIR I $G(DTOUT)!($G(DUOUT)) S PSAOUT=1 Q
"RTN","PSAVER3",85,0)
 Q:Y=""!('+Y)
"RTN","PSAVER3",86,0)
 W ! S %ZIS="Q" D ^%ZIS Q:POP
"RTN","PSAVER3",87,0)
 I $D(IO("Q")) D  Q
"RTN","PSAVER3",88,0)
 .S ZTDESC="Drug Acct. - Print Prime Vendor Invoices",ZTRTN="PRN^PSAVER3"
"RTN","PSAVER3",89,0)
 .;
"RTN","PSAVER3",90,0)
 .;DAVE B (PSA*3*13)
"RTN","PSAVER3",91,0)
 .F PSASAVE="PSAIN","PSASLN","PSANOVER" S:$D(@PSASAVE) ZTSAVE(PSASAVE)=""
"RTN","PSAVER3",92,0)
 .D ^%ZTLOAD
"RTN","PSAVER3",93,0)
 ;
"RTN","PSAVER3",94,0)
PRN ;Entry point to print verification errors
"RTN","PSAVER3",95,0)
 S (PSAERR,PSALINE,PSAOUT,PSAPG)=0,PSAPRINT=1
"RTN","PSAVER3",96,0)
 S PSAIEN=0 F  S PSAIEN=$O(PSANOVER(PSAIEN)) Q:'PSAIEN!(PSAOUT)  D
"RTN","PSAVER3",97,0)
 .Q:'$D(^PSD(58.811,PSAIEN,0))  S PSAORD=$P(^PSD(58.811,PSAIEN,0),"^")
"RTN","PSAVER3",98,0)
 .S PSAIEN1=0 F  S PSAIEN1=$O(PSANOVER(PSAIEN,PSAIEN1)) Q:'PSAIEN1!(PSAOUT)  D
"RTN","PSAVER3",99,0)
 ..Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,0))  S PSAIN=^PSD(58.811,PSAIEN,1,PSAIEN1,0),PSAINV=$P(PSAIN,"^")
"RTN","PSAVER3",100,0)
 ..S PSALINE=0 F  S PSALINE=$O(PSANOVER(PSAIEN,PSAIEN1,PSALINE)) Q:'PSALINE!(PSAOUT)  D
"RTN","PSAVER3",101,0)
 ...D NOVER
"RTN","PSAVER3",102,0)
 .K PSANOVER(PSAIEN)
"RTN","PSAVER3",103,0)
 W !!,"** The invoice has not been placed in a Verified status!",!
"RTN","PSAVER3",104,0)
 D:$E(IOST,1,2)="C-" END^PSAPROC W:$E(IOST)'="C" @IOF
"RTN","PSAVER3",105,0)
 D ^%ZISC
"RTN","PSAVER3",106,0)
 Q
"RTN","PSAVER3",107,0)
 ;
"RTN","PSAVER3",108,0)
NOVER ;Prints errors
"RTN","PSAVER3",109,0)
 S PSANO=PSANOVER(PSAIEN,PSAIEN1,PSALINE),PSALEN=$L(PSANO)
"RTN","PSAVER3",110,0)
 S PSALINEN=$P($G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,0)),"^"),PSATAB=$L(PSALINEN)+8
"RTN","PSAVER3",111,0)
 I $E(IOST,1,2)="C-" D:'PSAPG HDR I $Y+(4+PSALEN)>IOSL D END^PSAPROC Q:PSAOUT  D HDR
"RTN","PSAVER3",112,0)
 I $E(IOST)'="C",$Y+(4+PSALEN)>IOSL!('PSAPG) D HDR
"RTN","PSAVER3",113,0)
 W "Line# "_PSALINEN_": "
"RTN","PSAVER3",114,0)
 W:PSANO[8 ?PSATAB,"Dispense unit",!
"RTN","PSAVER3",115,0)
 W:PSANO["U" ?PSATAB,"Dispense unit per order unit",!
"RTN","PSAVER3",116,0)
 W:PSANO["D" ?PSATAB,"Drug",!
"RTN","PSAVER3",117,0)
 I PSANO["M" W ?PSATAB,"Master Vault",!
"RTN","PSAVER3",118,0)
 W:PSANO["O" ?PSATAB,"Order unit",!
"RTN","PSAVER3",119,0)
 I PSANO["P" W ?PSATAB,"Pharmacy location",!
"RTN","PSAVER3",120,0)
 W:PSANO["Q" ?PSATAB,"Quantity",!
"RTN","PSAVER3",121,0)
 W !
"RTN","PSAVER3",122,0)
 Q
"RTN","PSAVER3",123,0)
 ;
"RTN","PSAVER3",124,0)
HDR ;Prints header
"RTN","PSAVER3",125,0)
 I $E(IOST,1,2)="C-" W @IOF,!?23,"<<< VERIFICATION ERROR REPORT >>>"
"RTN","PSAVER3",126,0)
 I $E(IOST)'="C" W:PSAPG'=1 @IOF W !?20,"DRUG ACCOUNTABILITY/INVENTORY INTERFACE",!?27,"VERIFICATION ERROR REPORT",?72,"Page "_PSAPG,!
"RTN","PSAVER3",127,0)
 S PSAPG=PSAPG+1
"RTN","PSAVER3",128,0)
 W !,"Order#: "_PSAORD_"  Invoice#: "_$P(PSAIN,"^")_"  Invoice Date: "_$$FMTE^XLFDT(+$P(PSAIN,"^",2)) W:'$G(PSAERR) !,PSASLN,!
"RTN","PSAVER3",129,0)
 I $G(PSAERR) W !!,"The following line numbers' status cannot be changed to Verified.",!,"The fields that contain an error or need data are listed with the line item.",!,PSASLN,!
"RTN","PSAVER3",130,0)
 Q
"RTN","PSAVER3",131,0)
 ;
"RTN","PSAVER3",132,0)
STATUS ;Sets invoice's status to Verified
"RTN","PSAVER3",133,0)
 ;
"RTN","PSAVER3",134,0)
 ;PSA*3*3 (DAVE B)
"RTN","PSAVER3",135,0)
 S DA=PSAIEN1,DA(1)=PSAIEN,DIE="^PSD(58.811,"_DA(1)_",1,",DR="2///V;12////^S X="_DUZ
"RTN","PSAVER3",136,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):0 I  Q
"RTN","PSAVER3",137,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER3",138,0)
 K DIE
"RTN","PSAVER3",139,0)
 Q
"RTN","PSAVER3",140,0)
 ;
"RTN","PSAVER3",141,0)
VERIFY ;Set line item to verified
"RTN","PSAVER3",142,0)
 I PSADRG,$P($G(^PSDRUG(PSADRG,2)),"^",3)["N" S PSACSLN=1
"RTN","PSAVER3",143,0)
 E  S PSACSLN=0
"RTN","PSAVER3",144,0)
 K DA S DA=PSALINE,DA(1)=PSAIEN1,DA(2)=PSAIEN,DIE="^PSD(58.811,"_DA(2)_",1,"_DA(1)_",1,",DR="7///^S X="_DT_";8////^S X="_DUZ_";12///^S X=PSACSLN"
"RTN","PSAVER3",145,0)
 F  L +^PSD(58.811,PSAIEN,1,PSAIEN1,0):0 I  Q
"RTN","PSAVER3",146,0)
 D ^DIE L -^PSD(58.811,PSAIEN,1,PSAIEN1,0)
"RTN","PSAVER3",147,0)
 K DIE
"RTN","PSAVER3",148,0)
 Q
"RTN","PSAVER3",149,0)
 ;
"RTN","PSAVER3",150,0)
VERIFY1 ;Set adjs if entire invioce was verified
"RTN","PSAVER3",151,0)
 S DA=0 F  S DA=$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA)) Q:'DA  D
"RTN","PSAVER3",152,0)
 .Q:'$D(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0))
"RTN","PSAVER3",153,0)
 .Q:$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0),"^",9)=DUZ
"RTN","PSAVER3",154,0)
 .S PSAREA="",PSADJ=$P(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,DA,0),"^",2) D ADJ^PSAVER2
"RTN","PSAVER3",155,0)
 Q
"RTN","PSAVER3",156,0)
 ;
"RTN","PSAVER3",157,0)
DDQOR ;Extended help for 'Edit field'
"RTN","PSAVER3",158,0)
 W !?5,"Enter the number or range of numbers of the field you want to edit.",!?5,"For example, 1-3 or 1,3"
"RTN","PSAVER3",159,0)
 Q
"RTN","PSAVER3",160,0)
LNHELP ;Extended help for 'Line Number"
"RTN","PSAVER3",161,0)
 W !?5,"Enter the number of the item on the invoice you want to edit.",!?5,"You may enter several line item numbers separated by comas.",!!?5,"Do NOT enter a range of numbers separated by a dash."
"RTN","PSAVER3",162,0)
 Q
"RTN","PSAVER3",163,0)
PRINTYN ;Extended help for 'Print verification report'
"RTN","PSAVER3",164,0)
 W !?5,"Enter YES to print the Verification Error Report on a printer.",!?5,"Enter NO if you do not want to print the report."
"RTN","PSAVER3",165,0)
 Q
"VER")
8.0^22.0
**END**
**END**
