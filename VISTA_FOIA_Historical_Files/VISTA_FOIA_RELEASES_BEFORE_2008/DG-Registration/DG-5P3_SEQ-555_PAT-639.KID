Released DG*5.3*639 SEQ #555
Extracted from mail message
**KIDS**:DG*5.3*639^

**INSTALL NAME**
DG*5.3*639
"BLD",2123,0)
DG*5.3*639^REGISTRATION^0^3050106^y
"BLD",2123,1,0)
^^3^3^3050106^
"BLD",2123,1,1,0)
OBSOLETE PROTOCOL CLEANUP
"BLD",2123,1,2,0)
Refer to patch DG*5.3*639 in the FORUM Patch Module for a complete
"BLD",2123,1,3,0)
description.
"BLD",2123,4,0)
^9.64PA^^
"BLD",2123,"ABNS",0)
^9.66A^^
"BLD",2123,"ABPKG")
^^
"BLD",2123,"INI")
DG53639P
"BLD",2123,"INID")
^^y
"BLD",2123,"KRN",0)
^9.67PA^8989.52^19
"BLD",2123,"KRN",.4,0)
.4
"BLD",2123,"KRN",.401,0)
.401
"BLD",2123,"KRN",.402,0)
.402
"BLD",2123,"KRN",.403,0)
.403
"BLD",2123,"KRN",.5,0)
.5
"BLD",2123,"KRN",.84,0)
.84
"BLD",2123,"KRN",3.6,0)
3.6
"BLD",2123,"KRN",3.8,0)
3.8
"BLD",2123,"KRN",9.2,0)
9.2
"BLD",2123,"KRN",9.8,0)
9.8
"BLD",2123,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",2123,"KRN",9.8,"NM",1,0)
DG53639P^^0^B10248955
"BLD",2123,"KRN",9.8,"NM",2,0)
VAFCTFIN^^0^B24477699
"BLD",2123,"KRN",9.8,"NM","B","DG53639P",1)

"BLD",2123,"KRN",9.8,"NM","B","VAFCTFIN",2)

"BLD",2123,"KRN",19,0)
19
"BLD",2123,"KRN",19.1,0)
19.1
"BLD",2123,"KRN",101,0)
101
"BLD",2123,"KRN",409.61,0)
409.61
"BLD",2123,"KRN",771,0)
771
"BLD",2123,"KRN",870,0)
870
"BLD",2123,"KRN",8989.51,0)
8989.51
"BLD",2123,"KRN",8989.52,0)
8989.52
"BLD",2123,"KRN",8994,0)
8994
"BLD",2123,"KRN","B",.4,.4)

"BLD",2123,"KRN","B",.401,.401)

"BLD",2123,"KRN","B",.402,.402)

"BLD",2123,"KRN","B",.403,.403)

"BLD",2123,"KRN","B",.5,.5)

"BLD",2123,"KRN","B",.84,.84)

"BLD",2123,"KRN","B",3.6,3.6)

"BLD",2123,"KRN","B",3.8,3.8)

"BLD",2123,"KRN","B",9.2,9.2)

"BLD",2123,"KRN","B",9.8,9.8)

"BLD",2123,"KRN","B",19,19)

"BLD",2123,"KRN","B",19.1,19.1)

"BLD",2123,"KRN","B",101,101)

"BLD",2123,"KRN","B",409.61,409.61)

"BLD",2123,"KRN","B",771,771)

"BLD",2123,"KRN","B",870,870)

"BLD",2123,"KRN","B",8989.51,8989.51)

"BLD",2123,"KRN","B",8989.52,8989.52)

"BLD",2123,"KRN","B",8994,8994)

"BLD",2123,"QUES",0)
^9.62^^
"BLD",2123,"REQB",0)
^9.611^1^1
"BLD",2123,"REQB",1,0)
DG*5.3*520^2
"BLD",2123,"REQB","B","DG*5.3*520",1)

"INI")
DG53639P
"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813^2970721^12541
"PKG",5,22,1,"PAH",1,0)
639^3050106
"PKG",5,22,1,"PAH",1,1,0)
^^3^3^3050106
"PKG",5,22,1,"PAH",1,1,1,0)
OBSOLETE PROTOCOL CLEANUP
"PKG",5,22,1,"PAH",1,1,2,0)
Refer to patch DG*5.3*639 in the FORUM Patch Module for a complete
"PKG",5,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","DG53639P")
0^1^B10248955
"RTN","DG53639P",1,0)
DG53639P ;BIR/PTD-PATCH DG*5.3*639 PRE INSTALLATION ROUTINE ;12/8/04
"RTN","DG53639P",2,0)
 ;;5.3;Registration;**639**;Aug 13, 1993
"RTN","DG53639P",3,0)
 ;
"RTN","DG53639P",4,0)
 ;Reference to ^ORD(101 supported by IA #872
"RTN","DG53639P",5,0)
 ;IA #3082 documentation amended to reflect protocol removal
"RTN","DG53639P",6,0)
 ;
"RTN","DG53639P",7,0)
 ;Remove child protocol off of parent protocol from ITEM (#10)
"RTN","DG53639P",8,0)
 ;subfile and SUBSCRIBERS(#775) subfile in the PROTOCOL (#101) file.
"RTN","DG53639P",9,0)
 ;
"RTN","DG53639P",10,0)
 ;From Parent Protocol                 Remove Child Protocol
"RTN","DG53639P",11,0)
 ;--------------------                 ---------------------
"RTN","DG53639P",12,0)
 ;VAFC ADT-A04 SERVER                  RG ADT-A04 CLIENT
"RTN","DG53639P",13,0)
 ;
"RTN","DG53639P",14,0)
 ;VAFC ADT-A08 SERVER                  RG ADT-A08 CLIENT
"RTN","DG53639P",15,0)
 ;
"RTN","DG53639P",16,0)
EN ;
"RTN","DG53639P",17,0)
 S ERRFLG=0 K DGMSG N DGCIEN,DGCNAM,DGIIEN,DGSIEN,DGPIEN,DGPNAM
"RTN","DG53639P",18,0)
 S DGPNAM="VAFC ADT-A04 SERVER" D
"RTN","DG53639P",19,0)
 .D PARENT I DGPIEN>0 D
"RTN","DG53639P",20,0)
 ..S DGCNAM="RG ADT-A04 CLIENT" D
"RTN","DG53639P",21,0)
 ...D CHILD I DGCIEN>0 D ITEM,SBSCR
"RTN","DG53639P",22,0)
 K DGMSG N DGCIEN,DGCNAM,DGIIEN,DGSIEN,DGPIEN,DGPNAM
"RTN","DG53639P",23,0)
 S DGPNAM="VAFC ADT-A08 SERVER" D
"RTN","DG53639P",24,0)
 .D PARENT I DGPIEN>0 D
"RTN","DG53639P",25,0)
 ..S DGCNAM="RG ADT-A08 CLIENT" D
"RTN","DG53639P",26,0)
 ...D CHILD I DGCIEN>0 D ITEM,SBSCR
"RTN","DG53639P",27,0)
 I ERRFLG=0 D BMES^XPDUTL(" Pre-install routine completed successfully.")
"RTN","DG53639P",28,0)
 K DA,DGARRAY,DGCIEN,DGCNAM,DGCTR,DGIIEN,DGSIEN,DGMSG,DGPIEN,DGPNAM,DIK,ERRFLG,X
"RTN","DG53639P",29,0)
 Q
"RTN","DG53639P",30,0)
 ;
"RTN","DG53639P",31,0)
PARENT ;Get IEN for parent protocol
"RTN","DG53639P",32,0)
 S DGPIEN=+$$FIND1^DIC(101,"","QX",DGPNAM)
"RTN","DG53639P",33,0)
 I DGPIEN=0 D ERRMSG(DGPNAM) S ERRFLG=1 ;No protocol exists, send message.
"RTN","DG53639P",34,0)
 ;Else DGPIEN exists, it is IEN of parent protocol
"RTN","DG53639P",35,0)
 Q
"RTN","DG53639P",36,0)
 ;
"RTN","DG53639P",37,0)
CHILD ;Get IEN for child protocol
"RTN","DG53639P",38,0)
 S DGCIEN=+$$FIND1^DIC(101,"","QX",DGCNAM)
"RTN","DG53639P",39,0)
 I DGCIEN=0 D ERRMSG(DGCNAM) S ERRFLG=1 ;No protocol exists, send message.
"RTN","DG53639P",40,0)
 ;Else DGCIEN exists, it is IEN of child protocol
"RTN","DG53639P",41,0)
 Q
"RTN","DG53639P",42,0)
 ;
"RTN","DG53639P",43,0)
ITEM ;Is this child protocol in the ITEM (#10) multiple?
"RTN","DG53639P",44,0)
 ;If so, delete it.
"RTN","DG53639P",45,0)
 K DGARRAY,DGCTR,DGIIEN
"RTN","DG53639P",46,0)
 D FIND^DIC(101.01,","_DGPIEN_",",,"X",DGCNAM,,"B",,,"DGARRAY")
"RTN","DG53639P",47,0)
 I $P(DGARRAY("DILIST",0),"^")>0 D
"RTN","DG53639P",48,0)
 .S DGCTR=0 F  S DGCTR=$O(DGARRAY("DILIST",2,DGCTR)) Q:'DGCTR  S DGIIEN=$P(DGARRAY("DILIST",2,DGCTR),"^") D
"RTN","DG53639P",49,0)
 ..I DGIIEN>0 D  ;IEN is there.
"RTN","DG53639P",50,0)
 ..;Delete the child protocol from the ITEM (#10) multiple
"RTN","DG53639P",51,0)
 ..S DA(1)=DGPIEN,DA=DGIIEN,DIK="^ORD(101,"_DA(1)_",10,"
"RTN","DG53639P",52,0)
 ..D ^DIK K DIK,DA
"RTN","DG53639P",53,0)
 ..D BMES^XPDUTL(" "_DGCNAM_" removed from ITEM (#10)")
"RTN","DG53639P",54,0)
 ..D MES^XPDUTL(" multiple for "_DGPNAM_".")
"RTN","DG53639P",55,0)
 Q
"RTN","DG53639P",56,0)
 ;
"RTN","DG53639P",57,0)
SBSCR ;Is this child protocol in the SUBSCRIBERS (#775) multiple?
"RTN","DG53639P",58,0)
 ;If so, delete it.
"RTN","DG53639P",59,0)
 K DGARRAY,DGCTR,DGSIEN
"RTN","DG53639P",60,0)
 D FIND^DIC(101.0775,","_DGPIEN_",",,"X",DGCNAM,,"B",,,"DGARRAY")
"RTN","DG53639P",61,0)
 I $P(DGARRAY("DILIST",0),"^")>0 D
"RTN","DG53639P",62,0)
 .S DGCTR=0 F  S DGCTR=$O(DGARRAY("DILIST",2,DGCTR)) Q:'DGCTR  S DGSIEN=$P(DGARRAY("DILIST",2,DGCTR),"^") D
"RTN","DG53639P",63,0)
 ..I DGSIEN>0 D  ;IEN is there.
"RTN","DG53639P",64,0)
 ..;Delete the child protocol from the SUBSCRIBERS (#775) multiple
"RTN","DG53639P",65,0)
 ..S DA(1)=DGPIEN,DA=DGSIEN,DIK="^ORD(101,"_DA(1)_",775,"
"RTN","DG53639P",66,0)
 ..D ^DIK K DIK,DA
"RTN","DG53639P",67,0)
 ..D BMES^XPDUTL(" "_DGCNAM_" removed from SUBSCRIBERS (#775)")
"RTN","DG53639P",68,0)
 ..D MES^XPDUTL(" multiple for "_DGPNAM_".")
"RTN","DG53639P",69,0)
 Q
"RTN","DG53639P",70,0)
 ;
"RTN","DG53639P",71,0)
ERRMSG(X) ;Display an error message about missing protocols.
"RTN","DG53639P",72,0)
 ;Input - name of the missing protocol
"RTN","DG53639P",73,0)
 K DGMSG S DGMSG(1)=" ",DGMSG(2)=X_" protocol is missing"
"RTN","DG53639P",74,0)
 S DGMSG(3)="from the host system.  Contact your "_$S($E(X,1,2)="RG":"MPI/PD",1:"PIMS")_" ADPAC."
"RTN","DG53639P",75,0)
 D MES^XPDUTL(.DGMSG)
"RTN","DG53639P",76,0)
 Q
"RTN","DG53639P",77,0)
 ;
"RTN","VAFCTFIN")
0^2^B24477699
"RTN","VAFCTFIN",1,0)
VAFCTFIN ;BIR/DR-TREATING FACILTIY MFU PROCESSING ROUTINE ;11/09/01
"RTN","VAFCTFIN",2,0)
 ;;5.3;Registration;**428,474,520,639**;Aug 13, 1993
"RTN","VAFCTFIN",3,0)
 ;Reference to EXC, START, and STOP^RGHLLOG supported by IA #2796
"RTN","VAFCTFIN",4,0)
 ;
"RTN","VAFCTFIN",5,0)
IN ;This entry point is used to process the Treating Facility Master File Update Message.
"RTN","VAFCTFIN",6,0)
 ;It is called by the VAFC MFN-M05 CLIENT processing routine when a MFN
"RTN","VAFCTFIN",7,0)
 ;message is received.
"RTN","VAFCTFIN",8,0)
 ;There are no inputs or outputs
"RTN","VAFCTFIN",9,0)
 ;
"RTN","VAFCTFIN",10,0)
 I HL("MTN")="MFK" D RSP Q
"RTN","VAFCTFIN",11,0)
 N VAFC,STATN,VAFCI,MSG,SG,VAFCARR,PDFN,INST,MFUPT,PDLT,TFIEN
"RTN","VAFCTFIN",12,0)
 N ICN,MFI,MFE,MFA,HLCOMP,CNT,X,VAFCERR,VAFCX
"RTN","VAFCTFIN",13,0)
 ;quit if Master Patient Index (MPI) is not installed
"RTN","VAFCTFIN",14,0)
 S X="MPIF001" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFIN",15,0)
 S X="MPIFQ0" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFIN",16,0)
 S X="RGRSBUL1" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFIN",17,0)
 S X="RGRSBULL" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFIN",18,0)
INIT ;Process in the Treating Facility MFN msg
"RTN","VAFCTFIN",19,0)
 F VAFCI=1:1 X HLNEXT Q:HLQUIT'>0  S (MSG,VAFC(VAFCI))=HLNODE,SG=$E(HLNODE,1,3) D:SG?2A1(1A,1N) PICK
"RTN","VAFCTFIN",20,0)
 ;reconcil the inbound TF list from the MPI to the local TF list
"RTN","VAFCTFIN",21,0)
 D RECONCIL
"RTN","VAFCTFIN",22,0)
 ;create response message
"RTN","VAFCTFIN",23,0)
 S CNT=1
"RTN","VAFCTFIN",24,0)
 S HLA("HLA",1)="MSA"_HL("FS")_"AA"_HL("FS")_HL("MID")_HL("FS") S CNT=CNT+1
"RTN","VAFCTFIN",25,0)
 S HLA("HLA",CNT)=MFI S CNT=CNT+1
"RTN","VAFCTFIN",26,0)
 S VAFCX=0 F  S VAFCX=$O(MFE(VAFCX)) Q:'VAFCX  S HLA("HLA",CNT)=MFE(VAFCX),CNT=CNT+1,HLA("HLA",CNT)=MFA(VAFCX),CNT=CNT+1
"RTN","VAFCTFIN",27,0)
 ;generate an application level ack (MFK) identifying the status of the adds/edits/deletes of TF's passed in
"RTN","VAFCTFIN",28,0)
 D ROUTE
"RTN","VAFCTFIN",29,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.VAFCERR,"",.HLP)
"RTN","VAFCTFIN",30,0)
 Q
"RTN","VAFCTFIN",31,0)
PICK ;check routine for segment entry point
"RTN","VAFCTFIN",32,0)
 I $T(@SG)]"" D @SG
"RTN","VAFCTFIN",33,0)
 I $T(@SG)="" Q
"RTN","VAFCTFIN",34,0)
 Q
"RTN","VAFCTFIN",35,0)
MSH ;;MSH
"RTN","VAFCTFIN",36,0)
 ;process the MSH segment
"RTN","VAFCTFIN",37,0)
 S (HLFS,HL("FS"))=$E(MSG,4),(HLECH,HL("ECH"))=$E(MSG,5,8)
"RTN","VAFCTFIN",38,0)
 S HLCOMP=$E(HL("ECH"),1)
"RTN","VAFCTFIN",39,0)
 S VAFCARR("SENDING SITE")=$P(MSG,HL("FS"),4)
"RTN","VAFCTFIN",40,0)
 Q
"RTN","VAFCTFIN",41,0)
EVN ;;EVN
"RTN","VAFCTFIN",42,0)
 ;process the EVN segment
"RTN","VAFCTFIN",43,0)
 S STATN=+$$SITE^VASITE()_"^"_$$FMDATE^HLFNC($P(MSG,HL("FS"),3))
"RTN","VAFCTFIN",44,0)
 Q
"RTN","VAFCTFIN",45,0)
PID ;;PID
"RTN","VAFCTFIN",46,0)
 ;process the PID segment
"RTN","VAFCTFIN",47,0)
 S PDFN=+$P(MSG,HL("FS"),4)
"RTN","VAFCTFIN",48,0)
 Q
"RTN","VAFCTFIN",49,0)
MFI ;;MFI
"RTN","VAFCTFIN",50,0)
 ;process the MFI segment
"RTN","VAFCTFIN",51,0)
 S MFI=MSG
"RTN","VAFCTFIN",52,0)
 S MFUPT=$P(MSG,HL("FS"),4)
"RTN","VAFCTFIN",53,0)
 S VAFCARR("CMOR")=$P($P(MSG,HL("FS"),8),$E(HL("ECH"),1))
"RTN","VAFCTFIN",54,0)
 Q
"RTN","VAFCTFIN",55,0)
MFE ;;MFE
"RTN","VAFCTFIN",56,0)
 ;process the MFE segment
"RTN","VAFCTFIN",57,0)
 N HLCOMP,NXTSGMT,TYPE
"RTN","VAFCTFIN",58,0)
 S HLCOMP=$E(HL("ECH"),1)
"RTN","VAFCTFIN",59,0)
 S PDLT=$$FMDATE^HLFNC($P(MSG,HL("FS"),4))
"RTN","VAFCTFIN",60,0)
 S ICN=$P($P(MSG,HL("FS"),5),HLCOMP,4)
"RTN","VAFCTFIN",61,0)
 S INST=$P($P(MSG,HL("FS"),5),HLCOMP)
"RTN","VAFCTFIN",62,0)
 S TYPE=$P(MSG,HL("FS"),2)
"RTN","VAFCTFIN",63,0)
 S MFE(INST)=MSG
"RTN","VAFCTFIN",64,0)
 S MFI(ICN,INST)=PDLT_"^^"_TYPE
"RTN","VAFCTFIN",65,0)
 Q
"RTN","VAFCTFIN",66,0)
ZET ;;ZET
"RTN","VAFCTFIN",67,0)
 ;process Patient's Date Last Treated Event Type, ZET segment
"RTN","VAFCTFIN",68,0)
 N PDLTET
"RTN","VAFCTFIN",69,0)
 S PDLTET=$P(MSG,HL("FS"),2)
"RTN","VAFCTFIN",70,0)
 S $P(MFI(ICN,INST),"^",2)=PDLTET
"RTN","VAFCTFIN",71,0)
 Q
"RTN","VAFCTFIN",72,0)
RSP ;response process logic entry point
"RTN","VAFCTFIN",73,0)
 Q
"RTN","VAFCTFIN",74,0)
ROUTE ;routing logic entry point
"RTN","VAFCTFIN",75,0)
 N MPI
"RTN","VAFCTFIN",76,0)
 S MPI=$$MPILINK^MPIFAPI() D
"RTN","VAFCTFIN",77,0)
 .I $P($G(MPI),U)'=-1 S HLL("LINKS",1)="VAFC MFN-M05 CLIENT"_"^"_MPI
"RTN","VAFCTFIN",78,0)
 .I $P($G(MPI),U)=-1 D
"RTN","VAFCTFIN",79,0)
 .. N RGLOG D START^RGHLLOG(HLMTIEN,"","")
"RTN","VAFCTFIN",80,0)
 .. D EXC^RGHLLOG(224,"No MPI link identified in CIRN SITE PARAMETER file (#991.8)",$G(PDFN))
"RTN","VAFCTFIN",81,0)
 .. D STOP^RGHLLOG(0)
"RTN","VAFCTFIN",82,0)
 Q
"RTN","VAFCTFIN",83,0)
TEST ;
"RTN","VAFCTFIN",84,0)
 W $$REPROC^HLUTIL(39266,"D IN^VAFCTFIN")
"RTN","VAFCTFIN",85,0)
 Q
"RTN","VAFCTFIN",86,0)
RECONCIL ;
"RTN","VAFCTFIN",87,0)
 N DFN,MFIC,VAFCX,VAFCY,TFL,CNFLT,LOCCMOR,VAFCTYPE
"RTN","VAFCTFIN",88,0)
 S CNFLT=0
"RTN","VAFCTFIN",89,0)
 S DFN=$$GETDFN^MPIF001(ICN)
"RTN","VAFCTFIN",90,0)
 I DFN'>0 S CNFLT=1_"^"_$P($G(DFN),"^",2)
"RTN","VAFCTFIN",91,0)
 I +CNFLT=0 S LOCCMOR=$$GETVCCI^MPIF001(DFN) I VAFCARR("CMOR")'=LOCCMOR S CNFLT=1_"^"_"CMOR conflict MPI CMOR="_VAFCARR("CMOR")_" LOC CMOR="_LOCCMOR
"RTN","VAFCTFIN",92,0)
 I MFUPT="REP" I +CNFLT=0 D TFL^VAFCTFU1(.TFL,DFN) S VAFCX=0 F  S VAFCX=$O(TFL(VAFCX)) Q:'VAFCX  D
"RTN","VAFCTFIN",93,0)
 . S MFIC($P(TFL(VAFCX),"^"))=TFL(VAFCX) I '$D(MFI(ICN,$P(TFL(VAFCX),"^"))) D DEL(ICN,$P(TFL(VAFCX),"^"))
"RTN","VAFCTFIN",94,0)
 ;VAFCX=ICN and VAFCY=INSTITUTION
"RTN","VAFCTFIN",95,0)
 S VAFCX=0 F  S VAFCX=$O(MFI(VAFCX)) Q:'VAFCX  D
"RTN","VAFCTFIN",96,0)
 . S VAFCY=0 F  S VAFCY=$O(MFI(VAFCX,VAFCY)) Q:'VAFCY  D
"RTN","VAFCTFIN",97,0)
 ..S VAFCTYPE=$P(MFI(VAFCX,VAFCY),"^",3)
"RTN","VAFCTFIN",98,0)
 ..I +CNFLT=1 S MFA(VAFCY)="MFA"_HL("FS")_VAFCTYPE_HL("FS")_VAFCY_HL("FS")_$$HLDATE^HLFNC($$NOW^XLFDT)_HL("FS")_"U"_HLCOMP_$S(VAFCTYPE="MDL":"Delete of ",1:"Update of ")_VAFCY_" Failed at "_$P($$SITE^VASITE,"^",3)_" due to "_$P(CNFLT,"^",2)
"RTN","VAFCTFIN",99,0)
 ..I +CNFLT=0 I VAFCTYPE="MAD"!(VAFCTYPE="MUP") D ADDUPD(DFN,VAFCY,$P(MFI(VAFCX,VAFCY),"^"),$P(MFI(VAFCX,VAFCY),"^",2))
"RTN","VAFCTFIN",100,0)
 ..I +CNFLT=0 I VAFCTYPE="MDL" D DEL(ICN,VAFCY)
"RTN","VAFCTFIN",101,0)
 Q
"RTN","VAFCTFIN",102,0)
ADDUPD(DFN,INST,PDLT,PDLRTET) ;add or update TF entry
"RTN","VAFCTFIN",103,0)
 N ERROR,STA
"RTN","VAFCTFIN",104,0)
 S STA=INST
"RTN","VAFCTFIN",105,0)
 S INST=$$LKUP^XUAF4(INST)
"RTN","VAFCTFIN",106,0)
 D FILE^VAFCTFU(DFN,INST_"^"_$G(PDLT)_"^"_$G(PDLRTET),1,1,.ERROR)
"RTN","VAFCTFIN",107,0)
 S MFA(STA)="MFA"_HL("FS")_"MUP"_HL("FS")_STA_HL("FS")_$$HLDATE^HLFNC($$NOW^XLFDT)_HL("FS")
"RTN","VAFCTFIN",108,0)
 I '$D(ERROR(STA)) S MFA(STA)=MFA(STA)_"S"
"RTN","VAFCTFIN",109,0)
 I $D(ERROR(STA)) S MFA(STA)=MFA(STA)_"U"_HLCOMP_ERROR(STA)_HL("FS")
"RTN","VAFCTFIN",110,0)
 Q
"RTN","VAFCTFIN",111,0)
DEL(ICN,INST) ;delete a TF entry
"RTN","VAFCTFIN",112,0)
 N ERROR,STA
"RTN","VAFCTFIN",113,0)
 S STA=INST
"RTN","VAFCTFIN",114,0)
 S INST=$$LKUP^XUAF4(INST)
"RTN","VAFCTFIN",115,0)
 S ERROR=$$DELETETF^VAFCTFU(ICN,INST)
"RTN","VAFCTFIN",116,0)
 S MFA(STA)="MFA"_HL("FS")_"MDL"_HL("FS")_STA_HL("FS")_$$HLDATE^HLFNC($$NOW^XLFDT)_HL("FS")
"RTN","VAFCTFIN",117,0)
 I +ERROR'=1 S MFA(STA)=MFA(STA)_"S"
"RTN","VAFCTFIN",118,0)
 I +ERROR=1 S MFA(STA)=MFA(STA)_"U"_HLCOMP_"Delete Failed: "_$P(ERROR,"^",2)
"RTN","VAFCTFIN",119,0)
 Q
"VER")
8.0^22.0
**END**
**END**
