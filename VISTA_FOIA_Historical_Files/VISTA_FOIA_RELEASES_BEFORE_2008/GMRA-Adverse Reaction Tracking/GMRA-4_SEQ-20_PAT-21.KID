Released GMRA*4*21 SEQ #20
Extracted from mail message
**KIDS**:GMRA*4.0*21^

**INSTALL NAME**
GMRA*4.0*21
"BLD",16662,0)
GMRA*4.0*21^ADVERSE REACTION TRACKING^0^3041223^y
"BLD",16662,1,0)
^^5^5^3040917^
"BLD",16662,1,1,0)
Allergy updates required to support the removal of allergies
"BLD",16662,1,2,0)
as orders.  After installation of this patch and CPRS GUI v25,
"BLD",16662,1,3,0)
allergies will no longer be treated as orders.
"BLD",16662,1,4,0)
 
"BLD",16662,1,5,0)
Please see the FORUM patch module for a complete description.
"BLD",16662,4,0)
^9.64PA^120.82^1
"BLD",16662,4,120.82,0)
120.82
"BLD",16662,4,120.82,222)
n^n^f^^y^^y^r^n
"BLD",16662,4,120.82,224)
I Y=15
"BLD",16662,4,"B",120.82,120.82)

"BLD",16662,"ABPKG")
n
"BLD",16662,"INI")
PRE^GMRAY21
"BLD",16662,"INIT")
Q^GMRAY21
"BLD",16662,"KRN",0)
^9.67PA^8989.52^19
"BLD",16662,"KRN",.4,0)
.4
"BLD",16662,"KRN",.401,0)
.401
"BLD",16662,"KRN",.402,0)
.402
"BLD",16662,"KRN",.403,0)
.403
"BLD",16662,"KRN",.5,0)
.5
"BLD",16662,"KRN",.84,0)
.84
"BLD",16662,"KRN",3.6,0)
3.6
"BLD",16662,"KRN",3.6,"NM",0)
^9.68A^2^2
"BLD",16662,"KRN",3.6,"NM",1,0)
GMRA MARK CHART^^0
"BLD",16662,"KRN",3.6,"NM",2,0)
GMRA ENTERED IN ERROR^^0
"BLD",16662,"KRN",3.6,"NM","B","GMRA ENTERED IN ERROR",2)

"BLD",16662,"KRN",3.6,"NM","B","GMRA MARK CHART",1)

"BLD",16662,"KRN",3.8,0)
3.8
"BLD",16662,"KRN",9.2,0)
9.2
"BLD",16662,"KRN",9.8,0)
9.8
"BLD",16662,"KRN",9.8,"NM",0)
^9.68A^24^24
"BLD",16662,"KRN",9.8,"NM",1,0)
GMRAGUI^^0^B17329042
"BLD",16662,"KRN",9.8,"NM",2,0)
GMRAGUI1^^0^B55918277
"BLD",16662,"KRN",9.8,"NM",3,0)
GMRAOR2^^0^B10543663
"BLD",16662,"KRN",9.8,"NM",4,0)
GMRAPET0^^0^B26842733
"BLD",16662,"KRN",9.8,"NM",5,0)
GMRAY21^^0^B31428709
"BLD",16662,"KRN",9.8,"NM",6,0)
GMRAPEM0^^0^B44377298
"BLD",16662,"KRN",9.8,"NM",7,0)
GMRASEND^^0^B10911311
"BLD",16662,"KRN",9.8,"NM",8,0)
GMRASEN2^^0^B8743380
"BLD",16662,"KRN",9.8,"NM",9,0)
GMRADSP2^^0^B17340136
"BLD",16662,"KRN",9.8,"NM",10,0)
GMRAEAB^^0^B15640269
"BLD",16662,"KRN",9.8,"NM",11,0)
GMRAOR1^^0^B6008032
"BLD",16662,"KRN",9.8,"NM",12,0)
GMRAVAM0^^0^B26305565
"BLD",16662,"KRN",9.8,"NM",13,0)
GMRAHUT0^^0^B3993771
"BLD",16662,"KRN",9.8,"NM",14,0)
GMRAMCB^^0^B10298543
"BLD",16662,"KRN",9.8,"NM",15,0)
GMRARAD^^0^B18443849
"BLD",16662,"KRN",9.8,"NM",16,0)
GMRAOR6^^0^B3213262
"BLD",16662,"KRN",9.8,"NM",17,0)
GMRAPEO0^^0^B7107199
"BLD",16662,"KRN",9.8,"NM",18,0)
GMRAU851^^0^B16822989
"BLD",16662,"KRN",9.8,"NM",19,0)
GMRAPES0^^0^B71230096
"BLD",16662,"KRN",9.8,"NM",20,0)
GMRAFX2^^0^B26038344
"BLD",16662,"KRN",9.8,"NM",21,0)
GMRAPER0^^0^B49881172
"BLD",16662,"KRN",9.8,"NM",22,0)
GMRASIG1^^0^B15349456
"BLD",16662,"KRN",9.8,"NM",23,0)
GMRAROBS^^0^B13241542
"BLD",16662,"KRN",9.8,"NM",24,0)
GMRANKA^^0^B15425405
"BLD",16662,"KRN",9.8,"NM","B","GMRADSP2",9)

"BLD",16662,"KRN",9.8,"NM","B","GMRAEAB",10)

"BLD",16662,"KRN",9.8,"NM","B","GMRAFX2",20)

"BLD",16662,"KRN",9.8,"NM","B","GMRAGUI",1)

"BLD",16662,"KRN",9.8,"NM","B","GMRAGUI1",2)

"BLD",16662,"KRN",9.8,"NM","B","GMRAHUT0",13)

"BLD",16662,"KRN",9.8,"NM","B","GMRAMCB",14)

"BLD",16662,"KRN",9.8,"NM","B","GMRANKA",24)

"BLD",16662,"KRN",9.8,"NM","B","GMRAOR1",11)

"BLD",16662,"KRN",9.8,"NM","B","GMRAOR2",3)

"BLD",16662,"KRN",9.8,"NM","B","GMRAOR6",16)

"BLD",16662,"KRN",9.8,"NM","B","GMRAPEM0",6)

"BLD",16662,"KRN",9.8,"NM","B","GMRAPEO0",17)

"BLD",16662,"KRN",9.8,"NM","B","GMRAPER0",21)

"BLD",16662,"KRN",9.8,"NM","B","GMRAPES0",19)

"BLD",16662,"KRN",9.8,"NM","B","GMRAPET0",4)

"BLD",16662,"KRN",9.8,"NM","B","GMRARAD",15)

"BLD",16662,"KRN",9.8,"NM","B","GMRAROBS",23)

"BLD",16662,"KRN",9.8,"NM","B","GMRASEN2",8)

"BLD",16662,"KRN",9.8,"NM","B","GMRASEND",7)

"BLD",16662,"KRN",9.8,"NM","B","GMRASIG1",22)

"BLD",16662,"KRN",9.8,"NM","B","GMRAU851",18)

"BLD",16662,"KRN",9.8,"NM","B","GMRAVAM0",12)

"BLD",16662,"KRN",9.8,"NM","B","GMRAY21",5)

"BLD",16662,"KRN",19,0)
19
"BLD",16662,"KRN",19.1,0)
19.1
"BLD",16662,"KRN",101,0)
101
"BLD",16662,"KRN",409.61,0)
409.61
"BLD",16662,"KRN",771,0)
771
"BLD",16662,"KRN",870,0)
870
"BLD",16662,"KRN",8989.51,0)
8989.51
"BLD",16662,"KRN",8989.52,0)
8989.52
"BLD",16662,"KRN",8994,0)
8994
"BLD",16662,"KRN","B",.4,.4)

"BLD",16662,"KRN","B",.401,.401)

"BLD",16662,"KRN","B",.402,.402)

"BLD",16662,"KRN","B",.403,.403)

"BLD",16662,"KRN","B",.5,.5)

"BLD",16662,"KRN","B",.84,.84)

"BLD",16662,"KRN","B",3.6,3.6)

"BLD",16662,"KRN","B",3.8,3.8)

"BLD",16662,"KRN","B",9.2,9.2)

"BLD",16662,"KRN","B",9.8,9.8)

"BLD",16662,"KRN","B",19,19)

"BLD",16662,"KRN","B",19.1,19.1)

"BLD",16662,"KRN","B",101,101)

"BLD",16662,"KRN","B",409.61,409.61)

"BLD",16662,"KRN","B",771,771)

"BLD",16662,"KRN","B",870,870)

"BLD",16662,"KRN","B",8989.51,8989.51)

"BLD",16662,"KRN","B",8989.52,8989.52)

"BLD",16662,"KRN","B",8994,8994)

"BLD",16662,"QUES",0)
^9.62^^
"BLD",16662,"REQB",0)
^9.611^5^4
"BLD",16662,"REQB",1,0)
OR*3.0*216^1
"BLD",16662,"REQB",3,0)
GMRA*4.0*19^1
"BLD",16662,"REQB",4,0)
GMRA*4.0*11^1
"BLD",16662,"REQB",5,0)
GMRA*4.0*7^1
"BLD",16662,"REQB","B","GMRA*4.0*11",4)

"BLD",16662,"REQB","B","GMRA*4.0*19",3)

"BLD",16662,"REQB","B","GMRA*4.0*7",5)

"BLD",16662,"REQB","B","OR*3.0*216",1)

"DATA",120.82,15,0)
IODINE^D^1
"DATA",120.82,15,"CLASS",0)
^120.8205P^3^3
"DATA",120.82,15,"CLASS",1,0)
258
"DATA",120.82,15,"CLASS",2,0)
261
"DATA",120.82,15,"CLASS",3,0)
183
"DATA",120.82,15,"ING",0)
^120.824P^1^1
"DATA",120.82,15,"ING",1,0)
254
"FIA",120.82)
GMR ALLERGIES
"FIA",120.82,0)
^GMRD(120.82,
"FIA",120.82,0,0)
120.82I
"FIA",120.82,0,1)
n^n^f^^y^^y^r^n
"FIA",120.82,0,10)

"FIA",120.82,0,11)
I Y=15
"FIA",120.82,0,"RLRO")

"FIA",120.82,0,"VR")
4.0^GMRA
"FIA",120.82,120.82)
0
"FIA",120.82,120.8205)
0
"FIA",120.82,120.823)
0
"FIA",120.82,120.824)
0
"INI")
PRE^GMRAY21
"INIT")
Q^GMRAY21
"KRN",3.6,62,-1)
0^1
"KRN",3.6,62,0)
GMRA MARK CHART^Mark Patient |7|
"KRN",3.6,62,1,0)
^3.61A^7^7^3040806^^^^
"KRN",3.6,62,1,1,0)
The |6| for the following patient needs to be updated to
"KRN",3.6,62,1,2,0)
indicate that the following allergy/adverse reaction has been recorded.
"KRN",3.6,62,1,3,0)
      Patient: |1|
"KRN",3.6,62,1,4,0)
   Patient ID: |4|
"KRN",3.6,62,1,5,0)
     Location: |3|
"KRN",3.6,62,1,6,0)
     Reactant: |2|
"KRN",3.6,62,1,7,0)
    Mechanism: |5|
"KRN",3.6,62,3,0)
^3.63^3^3^3040806^^^^
"KRN",3.6,62,3,1,0)
This bulletin will alert the appropriate users to mark the chart and/or ID
"KRN",3.6,62,3,2,0)
band for the patient and allergy/adverse reaction specified in the
"KRN",3.6,62,3,3,0)
bulletin.
"KRN",3.6,62,4,0)
^3.64A^7^7
"KRN",3.6,62,4,1,0)
1
"KRN",3.6,62,4,1,1,0)
^^1^1^2901126^
"KRN",3.6,62,4,1,1,1,0)
This is the patient who needs the chart marked.
"KRN",3.6,62,4,2,0)
2
"KRN",3.6,62,4,2,1,0)
^^2^2^2930609^^^^
"KRN",3.6,62,4,2,1,1,0)
This is the allergy/adverse reaction that needs to be added to the chart
"KRN",3.6,62,4,2,1,2,0)
for this patient.
"KRN",3.6,62,4,3,0)
3
"KRN",3.6,62,4,3,1,0)
^^1^1^2930114^^^^
"KRN",3.6,62,4,3,1,1,0)
Location for the patient.
"KRN",3.6,62,4,4,0)
4
"KRN",3.6,62,4,4,1,0)
^^2^2^2930609^^
"KRN",3.6,62,4,4,1,1,0)
This is the patient ID.  This will allow the user to select the correct
"KRN",3.6,62,4,4,1,2,0)
patient on a ward.
"KRN",3.6,62,4,5,0)
5
"KRN",3.6,62,4,5,1,0)
^3.65^1^1^3040628^^
"KRN",3.6,62,4,5,1,1,0)
Mechanism of a given patient reaction.
"KRN",3.6,62,4,6,0)
6
"KRN",3.6,62,4,6,1,0)
^3.65^2^2^3040806^^^^
"KRN",3.6,62,4,6,1,1,0)
Indicates if the patient's chart, ID band or both need to be
"KRN",3.6,62,4,6,1,2,0)
updated.
"KRN",3.6,62,4,7,0)
7
"KRN",3.6,62,4,7,1,0)
^^2^2^3040806^
"KRN",3.6,62,4,7,1,1,0)
Same as 6 but the wording can be different so a new parameter is
"KRN",3.6,62,4,7,1,2,0)
needed.
"KRN",3.6,109,-1)
0^2
"KRN",3.6,109,0)
GMRA ENTERED IN ERROR^REACTION ENTERED IN ERROR
"KRN",3.6,109,1,0)
^^10^10^3040917^
"KRN",3.6,109,1,1,0)
The following reaction has been ENTERED IN ERROR.  Please ensure that the
"KRN",3.6,109,1,2,0)
patient's Chart/ID Band |8|are updated to reflect this change.
"KRN",3.6,109,1,3,0)
               Patient: |1|
"KRN",3.6,109,1,4,0)
                   SSN: |2|
"KRN",3.6,109,1,5,0)
              Reaction: |3|
"KRN",3.6,109,1,6,0)
              Location: |4|
"KRN",3.6,109,1,7,0)
            Originator: |5|
"KRN",3.6,109,1,8,0)
            Originated: |9|
"KRN",3.6,109,1,9,0)
   Entered in Error by: |6|
"KRN",3.6,109,1,10,0)
   Entered in Error on: |7|
"KRN",3.6,109,3,0)
^3.63^5^5^3040917^^^^
"KRN",3.6,109,3,1,0)
This bulletin is to be sent to both the verifiers and the chart marking
"KRN",3.6,109,3,2,0)
groups so that the reaction can be corrected on the patient record.
"KRN",3.6,109,3,3,0)
 
"KRN",3.6,109,3,4,0)
In addition, if the reactant is an observed drug reaction, the
"KRN",3.6,109,3,5,0)
P&T committee members will also be notified.
"KRN",3.6,109,4,0)
^3.64A^9^9
"KRN",3.6,109,4,1,0)
1
"KRN",3.6,109,4,1,1,0)
^^1^1^2951023^^
"KRN",3.6,109,4,1,1,1,0)
Patient Name.
"KRN",3.6,109,4,2,0)
2
"KRN",3.6,109,4,2,1,0)
^^1^1^2951023^^
"KRN",3.6,109,4,2,1,1,0)
Patient Social Security Number.
"KRN",3.6,109,4,3,0)
3
"KRN",3.6,109,4,3,1,0)
^^1^1^2951023^^
"KRN",3.6,109,4,3,1,1,0)
Reaction that is entered in error for this patient.
"KRN",3.6,109,4,4,0)
4
"KRN",3.6,109,4,4,1,0)
^^1^1^2951023^^
"KRN",3.6,109,4,4,1,1,0)
Patient location.
"KRN",3.6,109,4,5,0)
5
"KRN",3.6,109,4,5,1,0)
^^1^1^2951023^^
"KRN",3.6,109,4,5,1,1,0)
Originator of the reaction.
"KRN",3.6,109,4,6,0)
6
"KRN",3.6,109,4,6,1,0)
^^1^1^2951023^
"KRN",3.6,109,4,6,1,1,0)
User who entered the reaction in error.
"KRN",3.6,109,4,7,0)
7
"KRN",3.6,109,4,7,1,0)
^3.65^1^1^3040802^^^^
"KRN",3.6,109,4,7,1,1,0)
Date that the reaction was entered in error.
"KRN",3.6,109,4,8,0)
8
"KRN",3.6,109,4,8,1,0)
^3.65^2^2^3040917^^^
"KRN",3.6,109,4,8,1,1,0)
Items to be checked as a result of the entry being marked as
"KRN",3.6,109,4,8,1,2,0)
entered in error.
"KRN",3.6,109,4,9,0)
9
"KRN",3.6,109,4,9,1,0)
^^1^1^3040917^
"KRN",3.6,109,4,9,1,1,0)
Gives the date the allergy was entered into the system.
"MBREQ")
0
"ORD",2,3.6)
3.6;2;1;;BUL^XPDTA1;;BULE1^XPDIA1;;;BULDEL^XPDIA1
"ORD",2,3.6,0)
BULLETIN
"PKG",91,-1)
1^1
"PKG",91,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",91,22,0)
^9.49I^1^1
"PKG",91,22,1,0)
4.0^2960328^2960422^24
"PKG",91,22,1,"PAH",1,0)
21^3041223^222222230
"PKG",91,22,1,"PAH",1,1,0)
^^5^5^3041223
"PKG",91,22,1,"PAH",1,1,1,0)
Allergy updates required to support the removal of allergies
"PKG",91,22,1,"PAH",1,1,2,0)
as orders.  After installation of this patch and CPRS GUI v25,
"PKG",91,22,1,"PAH",1,1,3,0)
allergies will no longer be treated as orders.
"PKG",91,22,1,"PAH",1,1,4,0)
 
"PKG",91,22,1,"PAH",1,1,5,0)
Please see the FORUM patch module for a complete description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
24
"RTN","GMRADSP2")
0^9^B17340136
"RTN","GMRADSP2",1,0)
GMRADSP2 ;HIRMFO/RM,WAA-PRINT PATIENT A/AR ;12/22/04  08:38
"RTN","GMRADSP2",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRADSP2",3,0)
EN1 ; ENTRY TO PRINT DATA FOR A SINGLE RECORD DENOTED BY GMRAPA
"RTN","GMRADSP2",4,0)
 S GMRAOUT=0
"RTN","GMRADSP2",5,0)
 S GMRAPA(0)=$S($D(^GMR(120.8,GMRAPA,0)):^(0),1:"")
"RTN","GMRADSP2",6,0)
 S DFN=$P(GMRAPA(0),"^") D DEM^VADPT S GMRANAM=VADM(1) D KVAR^VADPT K VA
"RTN","GMRADSP2",7,0)
 S GMRADRUG=$S($P(GMRAPA(0),U,20)["D":1,1:0)
"RTN","GMRADSP2",8,0)
 S GMRAERR=$S($D(^GMR(120.8,GMRAPA,"ER")):+^("ER"),1:0) S:'$D(GMRAPG) GMRAPG=0
"RTN","GMRADSP2",9,0)
 D:$Y+3>IOSL EOP^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",10,0)
 ;D:'GMRAPG HDR^GMRADSP3
"RTN","GMRADSP2",11,0)
 I 'GMRAPRNT S GMRASP(1)=7,GMRAHDR(1)="PATIENT: ",GMRALIN(1)=$E(GMRANAM,1,23),GMRASP(2)=41,GMRAHDR(2)="CAUSATIVE AGENT: ",GMRALIN(2)=$E($P(GMRAPA(0),"^",2),1,21) D WRITE^GMRADSP3 G:GMRAOUT EXIT ;21
"RTN","GMRADSP2",12,0)
 I GMRAPRNT S GMRASP(1)=9,GMRAHDR(1)="AGENT: ",GMRALIN(1)=$E($P(GMRAPA(0),"^",2),1,23),GMRASP(2)="" D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",13,0)
 G:'GMRADRUG ORIG S (GMRADI,GMRADC)=0,GMRAFT=1
"RTN","GMRADSP2",14,0)
DICL ;
"RTN","GMRADSP2",15,0)
 S:GMRADI'="" GMRADI=$O(^GMR(120.8,GMRAPA,2,GMRADI)) S:GMRADC'="" GMRADC=$O(^GMR(120.8,GMRAPA,3,GMRADC)) G:GMRADI'>0&(GMRADC'>0)&'GMRAFT ORIG
"RTN","GMRADSP2",16,0)
 S GMRASP(1)=$S(GMRAFT:3,'GMRADI:"",1:16),GMRAHDR(1)=$S(GMRAFT:"INGREDIENTS: ",1:""),X=$S($D(^GMR(120.8,GMRAPA,2,+GMRADI,0)):^(0),1:""),GMRALIN(1)=$E($S($D(^PS(50.416,+X,0)):$P(^(0),"^"),1:""),1,23)
"RTN","GMRADSP2",17,0)
 S GMRASP(2)=$S(GMRAFT:41,'GMRADC:"",1:58),GMRAHDR(2)=$S(GMRAFT:"VA DRUG CLASSES: ",1:""),X=$S($D(^GMR(120.8,GMRAPA,3,+GMRADC,0)):^(0),1:""),GMRALIN(2)=$E($S($D(^PS(50.605,+X,0)):$P(^(0),"^",2),1:""),1,21)
"RTN","GMRADSP2",18,0)
 D WRITE^GMRADSP3 G:GMRAOUT EXIT S GMRAFT=0 G DICL
"RTN","GMRADSP2",19,0)
ORIG ;
"RTN","GMRADSP2",20,0)
 S GMRAREA=0,GMRATRT=0
"RTN","GMRADSP2",21,0)
 S (GMRASP(1),GMRASP(2))="" D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",22,0)
 S Y=$P(GMRAPA(0),"^",4) S:Y Y=$$FMTE^XLFDT(Y) S GMRASP(1)=4,GMRAHDR(1)="ORIGINATOR: ",GMRALIN(1)=$$GET1^DIQ(200,$P(GMRAPA(0),U,5)_",",".01") ;21
"RTN","GMRADSP2",23,0)
 S GMRASP(2)=46,GMRAHDR(2)="ORIGINATED: ",GMRALIN(2)=Y D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",24,0)
 S GMRASP(1)=6,GMRAHDR(1)="SIGN OFF: ",GMRALIN(1)=$S($P(GMRAPA(0),"^",12)=1:"YES",1:"NO"),GMRASP(2)=48,GMRAHDR(2)="OBS/HIST: ",GMRALIN(2)=$S($P(GMRAPA(0),"^",6)="o":"OBSERVED",$P(GMRAPA(0),"^",6)="h":"HISTORICAL",1:"")
"RTN","GMRADSP2",25,0)
 D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",26,0)
 I $D(^GMR(120.85,"C",GMRAPA)) D  ;21
"RTN","GMRADSP2",27,0)
 .S (GMRASP(1),GMRASP(2))="" ;21
"RTN","GMRADSP2",28,0)
 .N GMRAI,SEVER S (GMRAI,SEVER)=0 F  S GMRAI=$O(^GMR(120.85,"C",GMRAPA,GMRAI)) Q:'+GMRAI  S:+$P(^GMR(120.85,GMRAI,0),U,14)>SEVER SEVER=$P(^(0),U,14) ;21
"RTN","GMRADSP2",29,0)
 .I $G(SEVER) S GMRASP(1)=6,GMRAHDR(1)="SEVERITY: ",GMRALIN(1)=$S(SEVER=1:"MILD",SEVER=2:"MODERATE",1:"SEVERE") ;21
"RTN","GMRADSP2",30,0)
 .S GMRASP(2)=49,GMRAHDR(2)="OBS D/T: ",GMRALIN(2)=$$FMTE^XLFDT($P(^GMR(120.85,$O(^GMR(120.85,"C",GMRAPA,0)),0),U)) ;21
"RTN","GMRADSP2",31,0)
 .D WRITE^GMRADSP3 G:GMRAOUT EXIT ;21
"RTN","GMRADSP2",32,0)
 .Q  ;21
"RTN","GMRADSP2",33,0)
 I ($Y+4)>IOSL D EOP^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",34,0)
 D DISP1^GMRAPEM1(GMRAPA,"O",.GMRAOUT) G:GMRAOUT EXIT
"RTN","GMRADSP2",35,0)
 S (GMRASP(1),GMRASP(2))="" D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",36,0)
 S GMRASP(1)=0,GMRAHDR(1)="ID BAND MARKED: ",Y="",Y=$O(^GMR(120.8,GMRAPA,14,"A",Y)),Y=9999999-Y S:Y'=9999999 Y=$$FMTE^XLFDT(Y) S:Y=9999999 Y="" ;21
"RTN","GMRADSP2",37,0)
 S GMRASP(2)=44,GMRALIN(1)=Y,GMRAHDR(2)="CHART MARKED: ",Y="",Y=$O(^GMR(120.8,GMRAPA,13,"A",Y)),Y=9999999-Y S:Y'=9999999 Y=$$FMTE^XLFDT(Y) S:Y=9999999 Y="" S GMRALIN(2)=Y ;21
"RTN","GMRADSP2",38,0)
 D WRITE^GMRADSP3 G:GMRAOUT EXIT
"RTN","GMRADSP2",39,0)
 G RESET
"RTN","GMRADSP2",40,0)
LINEOUT ;
"RTN","GMRADSP2",41,0)
 S GMRASP(1)=$S(GMRAFT:6,1:16),GMRAHDR(1)=$S(GMRAFT:"COMMENTS: ",1:""),GMRALIN(1)=$S($D(^UTILITY($J,"W",15,+GMRAX,0)):^(0),1:""),GMRASP(2)="" D WRITE^GMRADSP3 G:GMRAOUT EXIT S GMRAFT=0
"RTN","GMRADSP2",42,0)
 Q
"RTN","GMRADSP2",43,0)
RESET ;
"RTN","GMRADSP2",44,0)
 D ^GMRADSP3
"RTN","GMRADSP2",45,0)
EXIT K DIWF,DIWL,DIWR,GMRA,GMRADC,GMRADI,GMRAHDR,GMRALIN,GMRASP,GMRAFT,GMRAREA,GMRATRT,GMRAX
"RTN","GMRADSP2",46,0)
 Q
"RTN","GMRAEAB")
0^10^B15640269
"RTN","GMRAEAB",1,0)
GMRAEAB ;HIRMFO/RM-BULLETIN SEND FOR E/E REACTIONS ;12/22/04  08:57
"RTN","GMRAEAB",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRAEAB",3,0)
EN1 ; SEND BULLETIN TO ALL VERIFIERS/CHART MARK GROUPS
"RTN","GMRAEAB",4,0)
 ; INDICATING A/AR NEEDS UPDATES
"RTN","GMRAEAB",5,0)
 N GMRAGRUP,%
"RTN","GMRAEAB",6,0)
 S GMRANAM="",GMRALOC="",GMRASSN=""
"RTN","GMRAEAB",7,0)
 D VAD^GMRAUTL1($P(GMRAPA(0),U),"",.GMRALOC,.GMRANAM,"",.GMRASSN)
"RTN","GMRAEAB",8,0)
 I GMRALOC'="",+$G(^DIC(42,GMRALOC,44)) S GMRALOC=$P($G(^SC(+$G(^DIC(42,GMRALOC,44)),0)),U)
"RTN","GMRAEAB",9,0)
 I GMRALOC="" S GMRALOC="OUT PATIENT"
"RTN","GMRAEAB",10,0)
 S XMB="GMRA ENTERED IN ERROR"
"RTN","GMRAEAB",11,0)
 ; Build XMB array
"RTN","GMRAEAB",12,0)
 S XMB(1)=GMRANAM ; Patient Name
"RTN","GMRAEAB",13,0)
 S XMB(2)=GMRASSN ; Patient SSN
"RTN","GMRAEAB",14,0)
 S XMB(3)=$P(GMRAPA(0),"^",2) ; Reaction
"RTN","GMRAEAB",15,0)
 S XMB(4)=GMRALOC ; Location
"RTN","GMRAEAB",16,0)
 S XMB(5)=$S($P(GMRAPA(0),U,5)'="":$$GET1^DIQ(200,$P(GMRAPA(0),U,5)_",",".01"),1:"<None>") ;21 Originator
"RTN","GMRAEAB",17,0)
 S XMB(6)=$$GET1^DIQ(200,$P($G(^GMR(120.8,GMRAPA,"ER")),U,3)_",",".01") ;21 Enter in error by
"RTN","GMRAEAB",18,0)
 S XMB(7)=$$FMTE^XLFDT($P($G(^GMR(120.8,GMRAPA,"ER")),U,2),1) ; Enter in error on
"RTN","GMRAEAB",19,0)
 S XMB(9)=$$FMTE^XLFDT($P(GMRAPA(0),U,4)) ;21
"RTN","GMRAEAB",20,0)
 ; Signs/symptoms and comments
"RTN","GMRAEAB",21,0)
 K ^TMP($J,"GMRACOM")
"RTN","GMRAEAB",22,0)
 N GMRAKIND,GMRACNT,GMRAX,GMRASP,GMRADATA,GMRAI,GMRAP ;21
"RTN","GMRAEAB",23,0)
 S GMRACNT=1,GMRASP="                                                                           "
"RTN","GMRAEAB",24,0)
 D EN1^GMRAOR2(GMRAPA,"GMRADATA") ;21
"RTN","GMRAEAB",25,0)
 I $D(GMRADATA("S")) S ^TMP($J,"GMRACOM",GMRACNT)="        Signs/Symptoms: " D  ;21
"RTN","GMRAEAB",26,0)
 .S GMRAI=0,GMRAP=0 F  S GMRAI=$O(GMRADATA("S",GMRAI)) Q:'+GMRAI  D  ;21
"RTN","GMRAEAB",27,0)
 ..I 'GMRAP S ^TMP($J,"GMRACOM",GMRACNT)=^TMP($J,"GMRACOM",GMRACNT)_GMRADATA("S",GMRAI),GMRACNT=GMRACNT+1,GMRAP=1 Q  ;21
"RTN","GMRAEAB",28,0)
 ..S ^TMP($J,"GMRACOM",GMRACNT)=$$REPEAT^XLFSTR(" ",24)_GMRADATA("S",GMRAI),GMRACNT=GMRACNT+1 ;21
"RTN","GMRAEAB",29,0)
 I $D(^GMR(120.8,GMRAPA,26,"AVER")) S ^TMP($J,"GMRACOM",GMRACNT)="",GMRACNT=GMRACNT+1,^TMP($J,"GMRACOM",GMRACNT)="Comments:",GMRACNT=GMRACNT+1 ;21
"RTN","GMRAEAB",30,0)
 F GMRAKIND="O","V","E" S GMRAX=0 S GMRAX=$O(^GMR(120.8,GMRAPA,26,"AVER",GMRAKIND,GMRAX)) I GMRAX>0  D
"RTN","GMRAEAB",31,0)
 .S ^TMP($J,"GMRACOM",GMRACNT)=$E(GMRASP,1,5)_$S(GMRAKIND="O":"ORIGINATOR",GMRAKIND="V":"VERIFIER",GMRAKIND="E":"ENTERED IN ERROR",1:""),GMRACNT=GMRACNT+1
"RTN","GMRAEAB",32,0)
 .S GMRAX=0 F  S GMRAX=$O(^GMR(120.8,GMRAPA,26,"AVER",GMRAKIND,GMRAX)) Q:GMRAX<1  D
"RTN","GMRAEAB",33,0)
 ..N GMRAY,GMRAZ
"RTN","GMRAEAB",34,0)
 ..S GMRAY=$P(^GMR(120.8,GMRAPA,26,GMRAX,0),U),GMRAZ=$P(^(0),U,2)
"RTN","GMRAEAB",35,0)
 ..D PRINT Q:GMRAOUT
"RTN","GMRAEAB",36,0)
 ..Q
"RTN","GMRAEAB",37,0)
 .Q
"RTN","GMRAEAB",38,0)
 S XMTEXT="^TMP($J,""GMRACOM"","
"RTN","GMRAEAB",39,0)
 ; Build XMY array
"RTN","GMRAEAB",40,0)
 ;Only send bulletin to verifier groups if reactant still needs to be verified or if it wasn't autoverified
"RTN","GMRAEAB",41,0)
 I '+$P(GMRAPA(0),U,16)!($P(GMRAPA(0),U,18)) F %=1:1:$L($P(GMRAPA(0),"^",20)) D  ;21
"RTN","GMRAEAB",42,0)
 .S GMRAGRUP=$E($P(GMRAPA(0),"^",20),%)
"RTN","GMRAEAB",43,0)
 .S XMY("G.GMRA VERIFY "_$S(GMRAGRUP="D":"DRUG",GMRAGRUP="F":"FOOD",1:"OTHER")_" ALLERGY")=""
"RTN","GMRAEAB",44,0)
 .Q
"RTN","GMRAEAB",45,0)
 S XMY("G.GMRA MARK CHART")=""
"RTN","GMRAEAB",46,0)
 I $P(GMRAPA(0),U,20)["D"&($P(GMRAPA(0),U,6)="o") S XMY("G.GMRA P&T COMMITTEE FDA")="",XMB(8)="and FDA information " ;21
"RTN","GMRAEAB",47,0)
 D ^XMB
"RTN","GMRAEAB",48,0)
 K XMB,XMY,XMTEXT,GMRATEXT,^TMP($J,"GMRACOM")
"RTN","GMRAEAB",49,0)
 Q
"RTN","GMRAEAB",50,0)
PRINT ;PRINT OUT THE DATA
"RTN","GMRAEAB",51,0)
 N GMRAT,GMRAZN S (GMRAZN,GMRAT)=""
"RTN","GMRAEAB",52,0)
 S:GMRAZ'="" GMRAZN=$$GET1^DIQ(200,GMRAZ_",",".01") ;21
"RTN","GMRAEAB",53,0)
 S:GMRAZ'="" GMRAT=$$GET1^DIQ(200,GMRAZ_",","8","I") ;21
"RTN","GMRAEAB",54,0)
 S:GMRAT'="" GMRAT=$P($G(^DIC(3.1,GMRAT,0)),U)
"RTN","GMRAEAB",55,0)
 S ^TMP($J,"GMRACOM",GMRACNT)=$E(GMRASP,1,10)_"Date: "_$$FMTE^XLFDT(GMRAY,1)_$E(GMRASP,1,10)_"User: "_GMRAZN,GMRACNT=GMRACNT+1
"RTN","GMRAEAB",56,0)
 S ^TMP($J,"GMRACOM",GMRACNT)=$E(GMRASP,1,47)_"Title: "_GMRAT,GMRACNT=GMRACNT+1
"RTN","GMRAEAB",57,0)
 I '$D(^GMR(120.8,GMRAPA,26,GMRAX,2,0)) Q
"RTN","GMRAEAB",58,0)
 S DIWL=16,DIWR=75,DIWF=""
"RTN","GMRAEAB",59,0)
 K ^UTILITY($J,"W",DIWL)
"RTN","GMRAEAB",60,0)
 S GMRAXX=0 F  S GMRAXX=$O(^GMR(120.8,GMRAPA,26,GMRAX,2,GMRAXX)) Q:GMRAXX<1  S X=^(GMRAXX,0) D ^DIWP
"RTN","GMRAEAB",61,0)
 S GMRAXX=0 F  S GMRAXX=$O(^UTILITY($J,"W",DIWL,GMRAXX)) Q:GMRAXX<1  S ^TMP($J,"GMRACOM",GMRACNT)=$E(GMRASP,1,16)_^UTILITY($J,"W",DIWL,GMRAXX,0),GMRACNT=GMRACNT+1
"RTN","GMRAEAB",62,0)
 S ^TMP($J,"GMRACOM",GMRACNT)="   ",GMRACNT=GMRACNT+1
"RTN","GMRAEAB",63,0)
 Q
"RTN","GMRAFX2")
0^20^B26038344
"RTN","GMRAFX2",1,0)
GMRAFX2 ;SLC/DAN Select reactant for update ;11/3/04  09:27
"RTN","GMRAFX2",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,19,21**;Mar 29, 1996
"RTN","GMRAFX2",3,0)
 ;DBIA SECTION
"RTN","GMRAFX2",4,0)
 ;10026 - DIR
"RTN","GMRAFX2",5,0)
 ;2056  - DIQ
"RTN","GMRAFX2",6,0)
 ;221   - PSDRUG("B", and PSDRUG("C", cross references
"RTN","GMRAFX2",7,0)
 ;10104 - XLFSTR
"RTN","GMRAFX2",8,0)
 ;10006 - DIC
"RTN","GMRAFX2",9,0)
 ;2531  - $$T^PSNAPIS
"RTN","GMRAFX2",10,0)
 ;2574  - $$TGTOG^PSNAPIS
"RTN","GMRAFX2",11,0)
 ;
"RTN","GMRAFX2",12,0)
EN1 ; Select new reactant
"RTN","GMRAFX2",13,0)
 N DIR,Y,DIRUT,X,DTOUT,DUOUT,DIC,GMRALAR,D,ENTRY,OK,CNT,LST,ROOT,NAM,DIROUT
"RTN","GMRAFX2",14,0)
 S DIR(0)="FO^3:30",DIR("A")="Enter Causative Agent",DIR("?")="^D HELP^GMRAFX2" D ^DIR S:$D(DIROUT) STOP=1 Q:$D(DIRUT)  S GMRALAR=$$UP^XLFSTR(Y)
"RTN","GMRAFX2",15,0)
NPA S DIC("S")="I $P(^(0),U)'=""OTHER ALLERGY/ADVERSE REACTION""" ;21
"RTN","GMRAFX2",16,0)
 W !!,"Checking GMR ALLERGIES (#120.82) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 ENTRY=X D DIC ;21
"RTN","GMRAFX2",17,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) Q
"RTN","GMRAFX2",18,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAFX2",19,0)
 K Y,DTOUT,DUOUT,ENTRY
"RTN","GMRAFX2",20,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAFX2",21,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM" D ^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",22,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" Q
"RTN","GMRAFX2",23,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAFX2",24,0)
 K DUOUT,DTOUT,Y,ENTRY
"RTN","GMRAFX2",25,0)
 S ROOT=$$T^PSNAPIS,CNT=0,X=GMRALAR
"RTN","GMRAFX2",26,0)
 I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAFX2",27,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAFX2",28,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAFX2",29,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAFX2",30,0)
 I CNT=1 S Y(0)=LST(1),ENTRY=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAFX2",31,0)
 I CNT>1 D
"RTN","GMRAFX2",32,0)
 .D MATCHES
"RTN","GMRAFX2",33,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAFX2",34,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAFX2",35,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),(ENTRY,X)=$P(Y(0),U,2)
"RTN","GMRAFX2",36,0)
 D DIC
"RTN","GMRAFX2",37,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" Q
"RTN","GMRAFX2",38,0)
DRUG W !!,"Now checking the DRUG (#50) file for matches...",! K Y,DTOUT,DUOUT,ENTRY
"RTN","GMRAFX2",39,0)
 S CNT=0,X=GMRALAR K LST
"RTN","GMRAFX2",40,0)
 F ROOT="^PSDRUG(""B"")","^PSDRUG(""C"")" D
"RTN","GMRAFX2",41,0)
 .I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$O(@ROOT@(X,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(X,0)),.01)_" <"_X_">",1:X) ;Exact match stores IEN in 50
"RTN","GMRAFX2",42,0)
 .S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAFX2",43,0)
 ..S CNT=CNT+1,LST(CNT)=$O(@ROOT@(NAM,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(NAM,0)),.01)_" <"_NAM_">",1:NAM)
"RTN","GMRAFX2",44,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAFX2",45,0)
 I CNT=1 S Y(0)=LST(1),ENTRY=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAFX2",46,0)
 I CNT>1 D
"RTN","GMRAFX2",47,0)
 .D MATCHES
"RTN","GMRAFX2",48,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAFX2",49,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAFX2",50,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),(ENTRY,X)=$P(Y(0),U,2)
"RTN","GMRAFX2",51,0)
 D DIC
"RTN","GMRAFX2",52,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y(0)_";PSDRUG(",GMRAAR(0)=$$GET1^DIQ(50,+Y(0),.01),GMRAAR("O")="D" Q
"RTN","GMRAFX2",53,0)
 ;19 - Moved ING and CLASS code here from above
"RTN","GMRAFX2",54,0)
ING W !!,"Now checking INGREDIENT (#50.416) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",X=GMRALAR D IX^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",55,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" Q
"RTN","GMRAFX2",56,0)
CLASS W !!,"Now checking VA DRUG CLASS (#50.605) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",D="C" D IX^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",57,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" Q
"RTN","GMRAFX2",58,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files.",!,"Please try again (check spelling, etc).",!,"If you need to add a new reactant, use the AE option." G EN1
"RTN","GMRAFX2",59,0)
 Q
"RTN","GMRAFX2",60,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAFX2",61,0)
 N DIR,X,Y
"RTN","GMRAFX2",62,0)
 Q:'$D(ENTRY)
"RTN","GMRAFX2",63,0)
 K OK
"RTN","GMRAFX2",64,0)
 W !!,"You selected ",ENTRY
"RTN","GMRAFX2",65,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Is this correct",DIR("?")="Answer yes if this is the correct reactant" D ^DIR S:Y=1 OK=1
"RTN","GMRAFX2",66,0)
 Q
"RTN","GMRAFX2",67,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAFX2",68,0)
 N I,J,QUIT
"RTN","GMRAFX2",69,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAFX2",70,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAFX2",71,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAFX2",72,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAFX2",73,0)
 Q
"RTN","GMRAFX2",74,0)
        ;
"RTN","GMRAFX2",75,0)
MORE()  ; -- show more matches
"RTN","GMRAFX2",76,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAFX2",77,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAFX2",78,0)
 D ^DIR
"RTN","GMRAFX2",79,0)
 Q +Y
"RTN","GMRAFX2",80,0)
 ;
"RTN","GMRAFX2",81,0)
HELP ;Display help for selection of causative agent
"RTN","GMRAFX2",82,0)
 W !,"Enter new causative agent to be assigned to the selected entries."
"RTN","GMRAFX2",83,0)
 W !,"Enter between 3 and 30 characters.  The entered text will then be"
"RTN","GMRAFX2",84,0)
 W !,"searched for in a number of different files.  Select the appropriate"
"RTN","GMRAFX2",85,0)
 W !,"entry from the appropriate file to update the selected patient."
"RTN","GMRAFX2",86,0)
 W !!,"Enter ^ to skip the current patient or ^^ to exit the entire process."
"RTN","GMRAFX2",87,0)
 Q
"RTN","GMRAGUI")
0^1^B17329042
"RTN","GMRAGUI",1,0)
GMRAGUI ;SLC/DAN - CPRS GUI support ;12/22/04  10:16
"RTN","GMRAGUI",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRAGUI",3,0)
 ;
"RTN","GMRAGUI",4,0)
GETREC(GMRAIEN,GMRARRAY) ;
"RTN","GMRAGUI",5,0)
 ;GMRAIEN  = IEN of object record from file 120.8
"RTN","GMRAGUI",6,0)
 ;GMRARRAY = array specifier ie.^TMP($J,"ART")
"RTN","GMRAGUI",7,0)
 K @GMRARRAY
"RTN","GMRAGUI",8,0)
 N ND,STRING,SSNODE,GMRA,GMRACA,GMRAT,GMRANOR,SSLIM,SSNUM,GMRASSI,GMRASS,GMRADT,Y,GMRAODUZ,COMFLAG,COMNUM,I
"RTN","GMRAGUI",9,0)
 N COMMENTS,GMRACODT,GMRACDUZ,GMRACUS,PREFIX,COMLINE,IDMNOD,IDMLIM,IDMNUM,GMRAIDB,CHMNOD,CHMLIM,CHMNUM,GMRACHM,GMRAVDUZ,GMRAVYN,GMRAOBS,OBSIEN,USRNAM,USR,SEVCOD,SEVER
"RTN","GMRAGUI",10,0)
 S ND=1
"RTN","GMRAGUI",11,0)
 I '$D(GMRAIEN)!('+GMRAIEN) Q
"RTN","GMRAGUI",12,0)
 S GMRA(0)=$G(^GMR(120.8,+GMRAIEN,0)) Q:'$L(GMRA(0))
"RTN","GMRAGUI",13,0)
 S STRING="~CAUSATIVE AGENT" D NEXT
"RTN","GMRAGUI",14,0)
 S GMRACA=$P(GMRA(0),U,2)
"RTN","GMRAGUI",15,0)
 S STRING="d"_GMRACA D NEXT
"RTN","GMRAGUI",16,0)
 S STRING="~ALLERGY TYPE" D NEXT
"RTN","GMRAGUI",17,0)
 S GMRAT=$P(GMRA(0),U,20)
"RTN","GMRAGUI",18,0)
 S STRING="d"_GMRAT_"^"_$TR($$OUTTYPE^GMRAUTL(GMRAT)," ","") D NEXT
"RTN","GMRAGUI",19,0)
 S STRING="~NATURE OF REACTION" D NEXT
"RTN","GMRAGUI",20,0)
 S GMRANOR=$P(GMRA(0),U,14)
"RTN","GMRAGUI",21,0)
 S STRING="d"_GMRANOR_U_$S(GMRANOR="A":"ALLERGY",GMRANOR="R":"ADVERSE REACTION",GMRANOR="P":"PHARMACOLOGICAL",1:"UNKNOWN") D NEXT
"RTN","GMRAGUI",22,0)
 S STRING="~SIGN/SYMPTOMS" D NEXT
"RTN","GMRAGUI",23,0)
 S SSNODE=$G(^GMR(120.8,GMRAIEN,10,0)),SSLIM=$P(SSNODE,U,3),SSNUM=0
"RTN","GMRAGUI",24,0)
 I SSLIM<1 G ORIG
"RTN","GMRAGUI",25,0)
SSLOOP S SSNUM=$O(^GMR(120.8,GMRAIEN,10,SSNUM))
"RTN","GMRAGUI",26,0)
 I SSNUM<1!(SSNUM>SSLIM) G ORIG
"RTN","GMRAGUI",27,0)
 S GMRASSI=$P($G(^GMR(120.8,GMRAIEN,10,SSNUM,0)),U,1),GMRASS=$P($G(^GMRD(120.83,GMRASSI,0)),U,1),GMRADT=$P($G(^GMR(120.8,GMRAIEN,10,SSNUM,0)),U,4)
"RTN","GMRAGUI",28,0)
 S Y=$$FMTE^XLFDT(GMRADT,"D")
"RTN","GMRAGUI",29,0)
 S STRING="i"_GMRASSI_"^"_GMRASS_"^"_GMRADT_"^  "_Y D NEXT G SSLOOP
"RTN","GMRAGUI",30,0)
ORIG S STRING="~ORIGINATOR" D NEXT
"RTN","GMRAGUI",31,0)
 S GMRAODUZ=$P(GMRA(0),U,5)
"RTN","GMRAGUI",32,0)
 S STRING="d"_GMRAODUZ_"^"_$S(GMRAODUZ:$$GET1^DIQ(200,GMRAODUZ_",",".01"),1:"") D NEXT
"RTN","GMRAGUI",33,0)
 S STRING="~ORIGINATED" D NEXT
"RTN","GMRAGUI",34,0)
 S STRING="d"_$P(GMRA(0),U,4) D NEXT
"RTN","GMRAGUI",35,0)
 S COMFLAG=0,COMNUM=0
"RTN","GMRAGUI",36,0)
 S STRING="~COMMENTS" D NEXT
"RTN","GMRAGUI",37,0)
 S COMMENTS=$G(^GMR(120.8,GMRAIEN,26,0)) S:COMMENTS'="" COMFLAG=1
"RTN","GMRAGUI",38,0)
CLOOP1 I COMFLAG D  ;
"RTN","GMRAGUI",39,0)
 .S COMNUM=$O(^GMR(120.8,GMRAIEN,26,COMNUM))
"RTN","GMRAGUI",40,0)
 .Q:COMNUM<1
"RTN","GMRAGUI",41,0)
 .S GMRACODT=$P($G(^GMR(120.8,GMRAIEN,26,COMNUM,0)),U,1)
"RTN","GMRAGUI",42,0)
 . S Y=$$FMTE^XLFDT(GMRACODT,"D")
"RTN","GMRAGUI",43,0)
 . S STRING="tComment Date: "_Y
"RTN","GMRAGUI",44,0)
 .D NEXT
"RTN","GMRAGUI",45,0)
 .S GMRACDUZ=$P($G(^GMR(120.8,GMRAIEN,26,COMNUM,0)),U,2)  S GMRACUS=$S('GMRACDUZ:"",1:$$GET1^DIQ(200,GMRACDUZ_",",".01"))
"RTN","GMRAGUI",46,0)
 .S STRING="tEntered By  : "_GMRACUS
"RTN","GMRAGUI",47,0)
 .D NEXT
"RTN","GMRAGUI",48,0)
 .S PREFIX="tComments    : "
"RTN","GMRAGUI",49,0)
 .S COMLINE=$O(^GMR(120.8,GMRAIEN,26,COMNUM,2,0))
"RTN","GMRAGUI",50,0)
CLOOP2 .D:COMLINE  ;
"RTN","GMRAGUI",51,0)
 ..S STRING=PREFIX_$G(^GMR(120.8,GMRAIEN,26,COMNUM,2,COMLINE,0)) D NEXT
"RTN","GMRAGUI",52,0)
 ..S PREFIX="t              "
"RTN","GMRAGUI",53,0)
 .S COMLINE=$O(^GMR(120.8,GMRAIEN,26,COMNUM,2,COMLINE))
"RTN","GMRAGUI",54,0)
 .I COMLINE>0 G CLOOP2
"RTN","GMRAGUI",55,0)
 .S STRING="t"
"RTN","GMRAGUI",56,0)
 .F I=1:1:60 S STRING=STRING_"-"
"RTN","GMRAGUI",57,0)
 .D NEXT
"RTN","GMRAGUI",58,0)
 I COMNUM>0 G CLOOP1
"RTN","GMRAGUI",59,0)
IDBM S STRING="~ID BAND MARKED" D NEXT
"RTN","GMRAGUI",60,0)
 S IDMNOD=$G(^GMR(120.8,GMRAIEN,14,0)),IDMLIM=$P(IDMNOD,U,3),IDMNUM=0
"RTN","GMRAGUI",61,0)
 I IDMLIM<1 G CHM
"RTN","GMRAGUI",62,0)
IDBLOOP S IDMNUM=$O(^GMR(120.8,GMRAIEN,14,IDMNUM))
"RTN","GMRAGUI",63,0)
 I IDMNUM<1!(IDMNUM>IDMLIM) G CHM
"RTN","GMRAGUI",64,0)
 S GMRAIDB=$P($G(^GMR(120.8,GMRAIEN,14,IDMNUM,0)),U,1)
"RTN","GMRAGUI",65,0)
 S STRING="i"_GMRAIDB D NEXT G IDBLOOP
"RTN","GMRAGUI",66,0)
CHM S STRING="~CHART MARKED" D NEXT
"RTN","GMRAGUI",67,0)
 S CHMNOD=$G(^GMR(120.8,GMRAIEN,13,0)),CHMLIM=$P(CHMNOD,U,3),CHMNUM=0
"RTN","GMRAGUI",68,0)
 I CHMLIM<1 G VER
"RTN","GMRAGUI",69,0)
CHMLOOP S CHMNUM=$O(^GMR(120.8,GMRAIEN,13,CHMNUM))
"RTN","GMRAGUI",70,0)
 I CHMNUM<1!(CHMNUM>CHMLIM) G VER
"RTN","GMRAGUI",71,0)
 S GMRACHM=$P($G(^GMR(120.8,GMRAIEN,13,CHMNUM,0)),U,1)
"RTN","GMRAGUI",72,0)
 S STRING="i"_GMRACHM D NEXT G CHMLOOP
"RTN","GMRAGUI",73,0)
VER S STRING="~VERIFIER" D NEXT
"RTN","GMRAGUI",74,0)
 S GMRAVDUZ=$P(GMRA(0),U,18) I GMRAVDUZ<1 G VFD
"RTN","GMRAGUI",75,0)
 S STRING="d"_GMRAVDUZ_"^"_$$GET1^DIQ(200,GMRAVDUZ_",",".01") D NEXT
"RTN","GMRAGUI",76,0)
VFD S STRING="~VERIFIED" D NEXT
"RTN","GMRAGUI",77,0)
 S GMRAVYN=$P(GMRA(0),U,16)
"RTN","GMRAGUI",78,0)
 S STRING="d"_$S(GMRAVYN=1:"YES",1:"NO")_"^"_$P(GMRA(0),U,17) D NEXT
"RTN","GMRAGUI",79,0)
ERR S STRING="~ENTERED IN ERROR" D NEXT
"RTN","GMRAGUI",80,0)
 S STRING="d"_$S(+$G(^GMR(120.8,GMRAIEN,"ER"))=1:"YES",1:"NO") D NEXT
"RTN","GMRAGUI",81,0)
OBSHIST S STRING="~OBS/HIST" D NEXT
"RTN","GMRAGUI",82,0)
 S GMRAOBS=$P(GMRA(0),U,6)
"RTN","GMRAGUI",83,0)
 S STRING="d"_GMRAOBS_"^"_$S(GMRAOBS="o":"OBSERVED",GMRAOBS="h":"HISTORICAL",1:"") D NEXT
"RTN","GMRAGUI",84,0)
 I GMRAOBS'="o" G EXIT
"RTN","GMRAGUI",85,0)
 D EN1^GMRAGUI1
"RTN","GMRAGUI",86,0)
EXIT Q
"RTN","GMRAGUI",87,0)
NEXT ;SET ARRAY NODE AND INCREMENT ARRAY COUNTER
"RTN","GMRAGUI",88,0)
 S @GMRARRAY@(ND)=STRING,ND=ND+1,STRING=""
"RTN","GMRAGUI",89,0)
 Q
"RTN","GMRAGUI1")
0^2^B55918277
"RTN","GMRAGUI1",1,0)
GMRAGUI1 ;SLC/DAN - CPRS GUI support ;12/22/04  10:18
"RTN","GMRAGUI1",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRAGUI1",3,0)
 ;
"RTN","GMRAGUI1",4,0)
 Q
"RTN","GMRAGUI1",5,0)
EN1 ; GETREC, cont'd
"RTN","GMRAGUI1",6,0)
OBSV ;  Get OBSERVATIONS from file 120.85
"RTN","GMRAGUI1",7,0)
 S STRING="~OBSERVATIONS" D NEXT
"RTN","GMRAGUI1",8,0)
 S OBSIEN=0
"RTN","GMRAGUI1",9,0)
OBSLOOP S OBSIEN=$O(^GMR(120.85,"C",GMRAIEN,OBSIEN)) G:OBSIEN<1 EXIT
"RTN","GMRAGUI1",10,0)
 S GMRA(1)=$G(^GMR(120.85,OBSIEN,0)) Q:'$L(GMRA(1))
"RTN","GMRAGUI1",11,0)
 S STRING="tRecord            : "_OBSIEN D NEXT
"RTN","GMRAGUI1",12,0)
 S USRNAM=""
"RTN","GMRAGUI1",13,0)
 S USR=$P(GMRA(1),U,13) I USR'="" D GETUSR
"RTN","GMRAGUI1",14,0)
 S Y=$P(GMRA(1),U,1) X ^DD("DD")
"RTN","GMRAGUI1",15,0)
 S STRING="tDate/Time of Event: "_Y D NEXT
"RTN","GMRAGUI1",16,0)
 S STRING="tObserver          : "_USRNAM D NEXT
"RTN","GMRAGUI1",17,0)
 S SEVCOD=$P(GMRA(1),U,14)
"RTN","GMRAGUI1",18,0)
 S SEVER=$S(SEVCOD=1:"MILD",SEVCOD=2:"MODERATE",SEVCOD=3:"SEVERE",1:"")
"RTN","GMRAGUI1",19,0)
 S STRING="tSeverity          : "_SEVER D NEXT
"RTN","GMRAGUI1",20,0)
 S Y=$P(GMRA(1),U,18) X ^DD("DD")
"RTN","GMRAGUI1",21,0)
 S STRING="tDate Reported     : "_Y D NEXT
"RTN","GMRAGUI1",22,0)
 S USRNAM=""
"RTN","GMRAGUI1",23,0)
 S USR=$P(GMRA(1),U,19) I USR'="" D GETUSR
"RTN","GMRAGUI1",24,0)
 S STRING="tReporting User    : "_USRNAM D NEXT
"RTN","GMRAGUI1",25,0)
 S STRING="t" F I=1:1:60 S STRING=STRING_"-"
"RTN","GMRAGUI1",26,0)
 D NEXT
"RTN","GMRAGUI1",27,0)
 G OBSLOOP
"RTN","GMRAGUI1",28,0)
EXIT Q
"RTN","GMRAGUI1",29,0)
NEXT ;SET ARRAY NODE AND INCREMENT ARRAY COUNTER
"RTN","GMRAGUI1",30,0)
 S @GMRARRAY@(ND)=STRING,ND=ND+1,STRING=""
"RTN","GMRAGUI1",31,0)
 Q
"RTN","GMRAGUI1",32,0)
GETUSR S USRNAM=$$GET1^DIQ(200,USR_",",".01")
"RTN","GMRAGUI1",33,0)
 Q
"RTN","GMRAGUI1",34,0)
 ;
"RTN","GMRAGUI1",35,0)
EIE(GMRAIEN,GMRADFN,GMRARRAY) ;Mark individual entry as entered in error
"RTN","GMRAGUI1",36,0)
 N DIE,DA,DR,Y,DIK,DFN,OROLD,VAIN,X,GMRAOUT,GMRAPA
"RTN","GMRAGUI1",37,0)
 L +^XTMP("GMRAED",GMRADFN):1 I '$T D MESS Q
"RTN","GMRAGUI1",38,0)
 S GMRAPA=GMRAIEN
"RTN","GMRAGUI1",39,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR="22///1;23///"_@GMRARRAY@("GMRAERRDT")_";24////"_$G(@GMRARRAY@("GMRAERRBY"),.5)
"RTN","GMRAGUI1",40,0)
 D ^DIE ;Entered in error on date/time by user
"RTN","GMRAGUI1",41,0)
 I $D(@GMRARRAY@("GMRAERRCMTS")) D ADCOM(GMRAPA,"E",$NA(@GMRARRAY@("GMRAERRCMTS"))) ;add comments
"RTN","GMRAGUI1",42,0)
 I $$NKASCR^GMRANKA($P(^GMR(120.8,GMRAPA,0),U)) D
"RTN","GMRAGUI1",43,0)
 .S DIK="^GMR(120.86,",DA=$P(^GMR(120.8,GMRAPA,0),U)
"RTN","GMRAGUI1",44,0)
 .D ^DIK ;If patient's last allergy marked as entered in error then delete assessment
"RTN","GMRAGUI1",45,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAGUI1",46,0)
 S GMRAOUT=0
"RTN","GMRAGUI1",47,0)
 D EN1^GMRAEAB ;Sends entered in error bulletin to appropriate mail groups
"RTN","GMRAGUI1",48,0)
 D EN1^GMRAPET0(GMRADFN,GMRAPA,"E",.GMRAOUT) ;21 File Progress Note
"RTN","GMRAGUI1",49,0)
 S DFN=GMRADFN
"RTN","GMRAGUI1",50,0)
 D INP^VADPT S X=$$FIND1^DIC(101,,"BX","GMRA ENTERED IN ERROR")_";ORD(101,"
"RTN","GMRAGUI1",51,0)
 D:X EN^XQOR ;Process protocols hanging off of "entered in error" protocol
"RTN","GMRAGUI1",52,0)
 L -^XTMP("GMRAED",GMRADFN)
"RTN","GMRAGUI1",53,0)
 Q
"RTN","GMRAGUI1",54,0)
 ;
"RTN","GMRAGUI1",55,0)
ADCOM(ENTRY,TYPE,GMRACOM) ;Add comments to allergies
"RTN","GMRAGUI1",56,0)
 ;
"RTN","GMRAGUI1",57,0)
 N FDA,GMRAI,X,DIWL,DIWR
"RTN","GMRAGUI1",58,0)
 K ^UTILITY($J,"W") S DIWL=1,DIWR=60 S GMRAI=0 F  S GMRAI=$O(@GMRACOM@(GMRAI)) Q:'+GMRAI  S X=@GMRACOM@(GMRAI) D ^DIWP
"RTN","GMRAGUI1",59,0)
 S GMRACOM="^UTILITY($J,""W"",1)"
"RTN","GMRAGUI1",60,0)
 S FDA(120.826,"+1,"_ENTRY_",",.01)=$$NOW^XLFDT
"RTN","GMRAGUI1",61,0)
 S FDA(120.826,"+1,"_ENTRY_",",1)=DUZ
"RTN","GMRAGUI1",62,0)
 S FDA(120.826,"+1,"_ENTRY_",",1.5)=TYPE
"RTN","GMRAGUI1",63,0)
 S FDA(120.826,"+1,"_ENTRY_",",2)=GMRACOM
"RTN","GMRAGUI1",64,0)
 D UPDATE^DIE("","FDA")
"RTN","GMRAGUI1",65,0)
 Q
"RTN","GMRAGUI1",66,0)
 ;
"RTN","GMRAGUI1",67,0)
NKA ;Change patient assessment to NKA
"RTN","GMRAGUI1",68,0)
 ;
"RTN","GMRAGUI1",69,0)
 N DA,DR,DIE,NKA,DFN
"RTN","GMRAGUI1",70,0)
 S DFN=ORDFN
"RTN","GMRAGUI1",71,0)
 L +^XTMP("GMRAED",DFN):1 I '$T D MESS Q
"RTN","GMRAGUI1",72,0)
 S NKA=$$NKA^GMRANKA(DFN)
"RTN","GMRAGUI1",73,0)
 I NKA=0 Q  ;Patient is already NKA
"RTN","GMRAGUI1",74,0)
 I NKA=1 S ORY="-1^Patient has active allergies - can't mark as NKA" Q
"RTN","GMRAGUI1",75,0)
 L +^GMR(120.86,0):5 I '$T S ORY="-1^Unable to update assessment - try again." Q
"RTN","GMRAGUI1",76,0)
 I '$D(^GMR(120.86,DFN,0)) D  ;Add assessment entry
"RTN","GMRAGUI1",77,0)
 .S $P(^GMR(120.86,0),U,3,4)=(DFN_"^"_($P(^GMR(120.86,0),U,4)+1))
"RTN","GMRAGUI1",78,0)
 .S ^GMR(120.86,DFN,0)=DFN_U,^GMR(120.86,"B",DFN,DFN)=""
"RTN","GMRAGUI1",79,0)
 L -^GMR(120.86,0) L +^GMR(120.86,DFN,0):5 I '$T S ORY="-1^Unable to update assessment - try again." Q
"RTN","GMRAGUI1",80,0)
 S DIE="^GMR(120.86,",DA=DFN,DR="1////0;2////"_DUZ_";3///NOW" D ^DIE
"RTN","GMRAGUI1",81,0)
 S ORY=0
"RTN","GMRAGUI1",82,0)
 L -^XTMP("GMRAED",DFN)
"RTN","GMRAGUI1",83,0)
 Q
"RTN","GMRAGUI1",84,0)
 ;
"RTN","GMRAGUI1",85,0)
UPDATE(GMRAIEN,DFN,GMRARRAY) ;Add/edit allergies
"RTN","GMRAGUI1",86,0)
 N NEW,NKA,FDA,NODE,IEN,SUB,FILE,DA,DIK,SIEN,GMRAS0,GMRAIEN,GMRAL,GMRAPA,GMRAAR,GMRALL,GMRADFN,GMRAOUT,GMRAROT
"RTN","GMRAGUI1",87,0)
 S NEW='$G(GMRAIEN)
"RTN","GMRAGUI1",88,0)
 I NEW,$$DUPCHK^GMRAOR0(DFN,$P(@GMRARRAY@("GMRAGNT"),U))=1 S ORY="-1^Patient already has a "_$P(@GMRARRAY@("GMRAGNT"),U)_" reaction entered.  No duplicates allowed." Q
"RTN","GMRAGUI1",89,0)
 L +^XTMP("GMRAED",DFN):1 I '$T D MESS Q
"RTN","GMRAGUI1",90,0)
 D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRAGUI1",91,0)
 S NKA='$$NKA^GMRANKA(DFN) ;is patient NKA?
"RTN","GMRAGUI1",92,0)
 I NKA,NEW D
"RTN","GMRAGUI1",93,0)
 .S FDA(120.86,"?+"_DFN_",",.01)=DFN
"RTN","GMRAGUI1",94,0)
 .S FDA(120.86,"?+"_DFN_",",1)=1
"RTN","GMRAGUI1",95,0)
 .S FDA(120.86,"?+"_DFN_",",2)=DUZ
"RTN","GMRAGUI1",96,0)
 .S FDA(120.86,"?+"_DFN_",",3)=$G(@GMRARRAY@("GMRAORDT"),$$NOW^XLFDT)
"RTN","GMRAGUI1",97,0)
 .S IEN(DFN)=DFN
"RTN","GMRAGUI1",98,0)
 .D UPDATE^DIE("","FDA","IEN")
"RTN","GMRAGUI1",99,0)
 K FDA,IEN
"RTN","GMRAGUI1",100,0)
 S NODE=$S($G(NEW):"+1,",1:(GMRAIEN_","))
"RTN","GMRAGUI1",101,0)
 S:$G(NEW) FDA(120.8,NODE,.01)=DFN
"RTN","GMRAGUI1",102,0)
 I $P($G(@GMRARRAY@("GMRAGNT")),U,2)["50.67" S $P(@GMRARRAY@("GMRAGNT"),U,2)=$$TGTOG^PSNAPIS($P(@GMRARRAY@("GMRAGNT"),U))_";PSNDF(50.6,"
"RTN","GMRAGUI1",103,0)
 F SUB="GMRAGNT;.02","GMRATYPE;3.1","GMRANATR;17","GMRAORIG;5","GMRAORDT;4","GMRAOBHX;6" D
"RTN","GMRAGUI1",104,0)
 .S FDA(120.8,NODE,$P(SUB,";",2))=$P(@GMRARRAY@($P(SUB,";")),U)
"RTN","GMRAGUI1",105,0)
 .I (SUB["GMRAGNT"),NEW S FDA(120.8,NODE,1)=$P(@GMRARRAY@($P(SUB,";")),U,2)
"RTN","GMRAGUI1",106,0)
 D UPDATE^DIE("","FDA","IEN")
"RTN","GMRAGUI1",107,0)
 S:NEW GMRAIEN=IEN(1)
"RTN","GMRAGUI1",108,0)
 K FDA
"RTN","GMRAGUI1",109,0)
 F SUB="GMRACHT","GMRAIDBN" D
"RTN","GMRAGUI1",110,0)
 .Q:'$D(@GMRARRAY@(SUB))  ;Stop if no updates
"RTN","GMRAGUI1",111,0)
 .S FILE=$S(SUB="GMRACHT":120.813,1:120.814)
"RTN","GMRAGUI1",112,0)
 .S FDA(FILE,"+1,"_GMRAIEN_",",.01)=@GMRARRAY@(SUB,1)
"RTN","GMRAGUI1",113,0)
 .S FDA(FILE,"+1,"_GMRAIEN_",",1)=DUZ
"RTN","GMRAGUI1",114,0)
 .D UPDATE^DIE("","FDA")
"RTN","GMRAGUI1",115,0)
 I $D(@GMRARRAY@("GMRACMTS")) D ADCOM(GMRAIEN,"O",$NA(@GMRARRAY@("GMRACMTS"))) ;Add comments if included
"RTN","GMRAGUI1",116,0)
 K FDA
"RTN","GMRAGUI1",117,0)
 S SUB=0 F  S SUB=$O(@GMRARRAY@("GMRASYMP",SUB)) Q:'+SUB  D
"RTN","GMRAGUI1",118,0)
 .S GMRAS0=^(SUB) ;Naked from above
"RTN","GMRAGUI1",119,0)
 .S SIEN=$O(^GMR(120.8,GMRAIEN,10,"B",$P(GMRAS0,U),0))
"RTN","GMRAGUI1",120,0)
 .I SIEN,$P(^GMR(120.8,GMRAIEN,10,SIEN,0),U,4)=$P(GMRAS0,U,3) Q  ;Exists and nothing has changed
"RTN","GMRAGUI1",121,0)
 .I SIEN,$P(GMRAS0,U,5)="@" S DIK="^GMR(120.8,"_GMRAIEN_",",DA(1)=GMRAIEN,DA=SIEN D ^DIK Q  ;Sign/symptom deleted
"RTN","GMRAGUI1",122,0)
 .S:'SIEN FDA(120.81,"+1,"_GMRAIEN_",",.01)=$S($P(GMRAS0,U)="FT":$O(^GMRD(120.83,"B","OTHER REACTION",0)),1:$P(GMRAS0,U))
"RTN","GMRAGUI1",123,0)
 .S NODE=$S(SIEN:SIEN_","_GMRAIEN,1:"+1,"_GMRAIEN_",")
"RTN","GMRAGUI1",124,0)
 .S:$P(GMRAS0,U)="FT" FDA(120.81,NODE,1)=$P(GMRAS0,U,2)
"RTN","GMRAGUI1",125,0)
 .S FDA(120.81,NODE,2)=DUZ
"RTN","GMRAGUI1",126,0)
 .S FDA(120.81,NODE,3)=$P(GMRAS0,U,3)
"RTN","GMRAGUI1",127,0)
 .D UPDATE^DIE("","FDA","","ERR")
"RTN","GMRAGUI1",128,0)
 .S GMRAROT($P(GMRAS0,U,2))="" ;21 record s/s added
"RTN","GMRAGUI1",129,0)
 I NEW D
"RTN","GMRAGUI1",130,0)
 .S GMRALL(GMRAIEN)="" D VAD^GMRAUTL1(DFN,,.GMRALOC,.GMRANAM) D EN7^GMRAMCB ;Send mark chart/ID band bulletin if needed.
"RTN","GMRAGUI1",131,0)
 .I $P(@GMRARRAY@("GMRAOBHX"),U)="o" D  ;if observed reaction add data to 120.85
"RTN","GMRAGUI1",132,0)
 ..S GMRAOUT=0 ;21
"RTN","GMRAGUI1",133,0)
 ..S GMRAL(GMRAIEN,"O",GMRAIEN)=$G(@GMRARRAY@("GMRARDT"))_"^"_$G(@GMRARRAY@("GMRASEVR"))
"RTN","GMRAGUI1",134,0)
 ..S GMRADFN=DFN
"RTN","GMRAGUI1",135,0)
 ..S GMRAL(GMRAIEN)="^^"_$P($G(@GMRARRAY@("GMRAGNT")),U)_"^^^^"_$G(@GMRARRAY@("GMRAORIG"))
"RTN","GMRAGUI1",136,0)
 ..M GMRAL(GMRAIEN,"S")=@GMRARRAY@("GMRASYMP")
"RTN","GMRAGUI1",137,0)
 ..S SUB=0 F  S SUB=$O(GMRAL(GMRAIEN,"S",SUB)) Q:'+SUB  S $P(GMRAL(GMRAIEN,"S",SUB),U,2)=$P(GMRAL(GMRAIEN,"S",SUB),U,2)_"^" S:$P(GMRAL(GMRAIEN,"S",SUB),U)="FT" $P(GMRAL(GMRAIEN,"S",SUB),U)=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAGUI1",138,0)
 ..S GMRAL=GMRAIEN
"RTN","GMRAGUI1",139,0)
 ..D ADVERSE^GMRAOR7(GMRAIEN,.GMRAL) ;adds entry to 120.85
"RTN","GMRAGUI1",140,0)
 ..S GMRAIEN(GMRAIEN)="" ;21
"RTN","GMRAGUI1",141,0)
 ..D EN1^GMRAPET0(GMRADFN,.GMRAIEN,"S",.GMRAOUT) ;21 File progress note
"RTN","GMRAGUI1",142,0)
 ..I $G(@GMRARRAY@("GMRATYPE"))["D" S GMRAPA=GMRAIEN D EN1^GMRAPTB ;21 Send med-watch update
"RTN","GMRAGUI1",143,0)
 .S GMRAAR=$P($G(@GMRARRAY@("GMRAGNT")),U,2),GMRAPA=GMRAIEN
"RTN","GMRAGUI1",144,0)
 .D EN1^GMRAOR9 S ^TMP($J,"GMRASF",1,GMRAPA)="" D RANGE^GMRASIGN(1) ;add ingredients/classes send appropriate bulletins
"RTN","GMRAGUI1",145,0)
 S ORY=0
"RTN","GMRAGUI1",146,0)
 L -^XTMP("GMRAED",DFN)
"RTN","GMRAGUI1",147,0)
 Q
"RTN","GMRAGUI1",148,0)
 ;
"RTN","GMRAGUI1",149,0)
MESS ;Give out locked message
"RTN","GMRAGUI1",150,0)
 N GMRAXBOS,GMRAL1,GMRAL2
"RTN","GMRAGUI1",151,0)
 S GMRAXBOS=$$BROKER^XWBLIB ;In GUI?
"RTN","GMRAGUI1",152,0)
 S GMRAL1="Another user is editing this patient's allergy information."
"RTN","GMRAGUI1",153,0)
 S GMRAL2="Please refresh/review the patient's information before proceeding."
"RTN","GMRAGUI1",154,0)
 I 'GMRAXBOS W !,GMRAL1,!,GMRAL2 D WAIT^GMRAFX3 Q
"RTN","GMRAGUI1",155,0)
 S ORY="-1^"_GMRAL1_"  "_GMRAL2
"RTN","GMRAGUI1",156,0)
 Q
"RTN","GMRAHUT0")
0^13^B3993771
"RTN","GMRAHUT0",1,0)
GMRAHUT0 ;HIRMFO/RM,YMP-HELP UTILITY FOR ALLERGY FILES ;12/22/04  08:07
"RTN","GMRAHUT0",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRAHUT0",3,0)
EN1 ; ENTRY FROM EXECUTABLE HELP OF SEVERITY FIELD OF FILE 120.8
"RTN","GMRAHUT0",4,0)
 W !,?8,"MILD     - Requires minimal therapeutic intervention such as",!?19,"discontinuation of drug(s)."
"RTN","GMRAHUT0",5,0)
 W !,?8,"MODERATE - Requires active treatment of adverse reaction, or",!?19,"further testing or evaluation to assess"
"RTN","GMRAHUT0",6,0)
 W !?19,"extent of non-serious outcome (see SEVERE for",!?19,"definition of serious)."
"RTN","GMRAHUT0",7,0)
 W !,?8,"SEVERE   - Includes any serious outcome, resulting in life or organ",!?19,"threatening situation or death, significant or permanent",!?19,"disability, requiring intervention to prevent permanent"
"RTN","GMRAHUT0",8,0)
 W !?19,"impairment or damage, or requiring/prolonging",!?19,"hospitalization."
"RTN","GMRAHUT0",9,0)
 Q
"RTN","GMRAMCB")
0^14^B10298543
"RTN","GMRAMCB",1,0)
GMRAMCB ;HIRMFO/WAA-MARK CHART & ID BAND FIELD EDIT ;9/16/04  10:58
"RTN","GMRAMCB",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRAMCB",3,0)
EN3 ;Entry for EDIT CHART & ID BAND option
"RTN","GMRAMCB",4,0)
 K GMRALL S GMRAOUT=0 D GETAL^GMRAMCB1 I GMRAOUT!'$D(GMRALL) L:DFN>0 -^GMR(120.8,"B",DFN) G Q3
"RTN","GMRAMCB",5,0)
 D EN5 D:'GMRAOUT EN7
"RTN","GMRAMCB",6,0)
 L -^GMR(120.8,"B",DFN)
"RTN","GMRAMCB",7,0)
 G Q3
"RTN","GMRAMCB",8,0)
EN4(GMRALL,DFN) ;THIS IS THE ENTRY POINT IF YOU KNOW THE ALLERGIES AND PATIENT
"RTN","GMRAMCB",9,0)
 D EN5 D:'GMRAOUT EN7 Q
"RTN","GMRAMCB",10,0)
EN5 ;THIS IS THE ENTRY POINT TO BY PASS THE FORMAL LIST AGAIN
"RTN","GMRAMCB",11,0)
 D VAD^GMRAUTL1(DFN,"",.GMRALOC,.GMRANAM,"",.GMRASSN)
"RTN","GMRAMCB",12,0)
 S GMRATYPE="B",I=0,GMRAPA=0 W !,"This session you have CHOSEN:" F  S GMRAPA=$O(GMRALL(GMRAPA)) Q:GMRAPA<1  S I=I+1 W !,?5,$P($G(^GMR(120.8,GMRAPA,0)),U,2)
"RTN","GMRAMCB",13,0)
 W ! D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0)),GMRAOUT=0
"RTN","GMRAMCB",14,0)
 F GMRAMARK="13^Chart(s)","14^ID Band" S GMRAM2=$P(GMRAMARK,"^",2),GMRAM1=$P(GMRAMARK,"^") D  Q:GMRAOUT
"RTN","GMRAMCB",15,0)
 .I GMRAM1=14,($P(GMRASITE(0),U,5)=0!(GMRALOC="")) Q
"RTN","GMRAMCB",16,0)
 .S GMRANULL=0 F  S %=0 D  I %!(%Y="") Q
"RTN","GMRAMCB",17,0)
 ..I GMRAM1=13 S %=1,%Y="Y" Q  ;21 Marked on chart set to YES automatically
"RTN","GMRAMCB",18,0)
 ..W !,$S(GMRAM1=14:"Has",1:"Have")," the "_GMRAM2_" been marked for",$S(I>1:" these CAUSATIVE AGENTS",1:" this CAUSATIVE AGENT") D YN^DICN
"RTN","GMRAMCB",19,0)
 ..Q:%Y=""
"RTN","GMRAMCB",20,0)
 ..S:%<0 %=2,GMRAOUT=1 Q:%  W !?4,"ANSWER YES IF THE "_GMRAM2_" HAS BEEN MARKED, ELSE ANSWER NO."
"RTN","GMRAMCB",21,0)
 ..Q
"RTN","GMRAMCB",22,0)
 .I %=2!(%Y="") Q
"RTN","GMRAMCB",23,0)
 .S GMRAPA=0 F  S GMRAPA=$O(GMRALL(GMRAPA)) Q:GMRAPA<1  D
"RTN","GMRAMCB",24,0)
 ..I '$D(^GMR(120.8,GMRAPA,GMRAM1,0)) S ^(0)="^120.8"_GMRAM1_"DA^^"
"RTN","GMRAMCB",25,0)
 ..D NOW^%DTC K DO,DD,DINUM S X=%,DIC="^GMR(120.8,"_GMRAPA_","_GMRAM1_",",DIC(0)="L",DLAYGO=120.8,DA(1)=GMRAPA,DIC("DR")="1////"_DUZ D FILE^DICN K DIC,DLAYGO
"RTN","GMRAMCB",26,0)
 ..Q
"RTN","GMRAMCB",27,0)
 .Q
"RTN","GMRAMCB",28,0)
 Q
"RTN","GMRAMCB",29,0)
EN6(GMRALL,DFN,GMRATYPE) ;THIS IS THE ENTRY POINT IF YOU KNOW THE ALLERGIES AND PATIENT
"RTN","GMRAMCB",30,0)
 N GMRAOUT,%,%Y S GMRAOUT=0
"RTN","GMRAMCB",31,0)
 D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRAMCB",32,0)
EN7 I $D(%Y),%Y="" Q
"RTN","GMRAMCB",33,0)
 S GMRAPA=0 F  S GMRAPA=$O(GMRALL(GMRAPA)) Q:GMRAPA<1  D
"RTN","GMRAMCB",34,0)
 .I $O(^GMR(120.8,GMRAPA,13,0))&($P(GMRASITE(0),U,5)=0!$O(^GMR(120.8,GMRAPA,14,0))!(GMRALOC="")) Q
"RTN","GMRAMCB",35,0)
 .S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) D BULLT^GMRASEND
"RTN","GMRAMCB",36,0)
 .Q
"RTN","GMRAMCB",37,0)
 Q
"RTN","GMRAMCB",38,0)
Q3 ; CLEAN UP AFTER EN3
"RTN","GMRAMCB",39,0)
 D KILL^XUSCLEAN
"RTN","GMRAMCB",40,0)
 Q
"RTN","GMRAMCB",41,0)
HELP ;THIS ROUTINE WILL LIST ALL THE SELECTED ALLERGIES AND ALL THE
"RTN","GMRAMCB",42,0)
 ;CURRENT SELECTED ALLERGIES
"RTN","GMRAMCB",43,0)
 S GMRAPA=0 I '$D(GMRALL) W !,"No CAUSATIVE AGENTS have been selected for this patient."
"RTN","GMRAMCB",44,0)
 E  W !,"You have selected the following CAUSATIVE AGENTS:",! S GMRAPA=0 F  S GMRAPA=$O(GMRALL(GMRAPA)) Q:GMRAPA<1  W !,?5,$P($G(^GMR(120.8,GMRAPA,0)),U,2)
"RTN","GMRAMCB",45,0)
 K GMRAPA
"RTN","GMRAMCB",46,0)
 D HANGT^GMRAPEH0
"RTN","GMRAMCB",47,0)
HLP1 ;LIST ALL ALLERGIES
"RTN","GMRAMCB",48,0)
 W !,"You may choose CAUSATIVE AGENTS from the following list for this patient:"
"RTN","GMRAMCB",49,0)
 N DIC
"RTN","GMRAMCB",50,0)
 I '$D(^GMR(120.8,"B",DFN)) W !?4,"There are no reactions on file for this patient." Q
"RTN","GMRAMCB",51,0)
 D HLP12085^GMRAU851(DFN,"'+$G(^GMR(120.8,+GMRAX,""ER""))")
"RTN","GMRAMCB",52,0)
 D HANGT^GMRAPEH0
"RTN","GMRAMCB",53,0)
 Q
"RTN","GMRANKA")
0^24^B15425405
"RTN","GMRANKA",1,0)
GMRANKA ;HIRMFO/WAA-ALLERGY/ADVERSE REACTION PATIENT NKA DRIVE ;12/3/04  13:51
"RTN","GMRANKA",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,21**;Mar 29, 1996
"RTN","GMRANKA",3,0)
NKA(DFN) ;See if patient has reaction on file
"RTN","GMRANKA",4,0)
 ;  Input Variables:
"RTN","GMRANKA",5,0)
 ;       DFN = Patient Internal Entry Number
"RTN","GMRANKA",6,0)
 ;
"RTN","GMRANKA",7,0)
 ;  Output Variables:
"RTN","GMRANKA",8,0)
 ;       GMA = 1 Patient has known reaction
"RTN","GMRANKA",9,0)
 ;             0 Patient has No known reaction
"RTN","GMRANKA",10,0)
 ;             Null Patient has never been asked about reaction
"RTN","GMRANKA",11,0)
 S GMA=""
"RTN","GMRANKA",12,0)
 S GMA=$P($G(^GMR(120.86,DFN,0)),U,2)
"RTN","GMRANKA",13,0)
 Q GMA
"RTN","GMRANKA",14,0)
 ;
"RTN","GMRANKA",15,0)
NKAASK(DFN,GMRAOUT) ; Ask a Patient if patient has any known allergens
"RTN","GMRANKA",16,0)
 ;  Input Variables
"RTN","GMRANKA",17,0)
 ;     DFN = Patient Internal entry number
"RTN","GMRANKA",18,0)
 ;  GMRAOUT = Up Caret or time out flag
"RTN","GMRANKA",19,0)
 ;
"RTN","GMRANKA",20,0)
 N GMAIEN
"RTN","GMRANKA",21,0)
 L +^GMR(120.86,0):1
"RTN","GMRANKA",22,0)
 I $G(^GMR(120.86,DFN,0))="" D  ;ADD A RECORD TO THE 120.86 FILE
"RTN","GMRANKA",23,0)
 .N HEAD
"RTN","GMRANKA",24,0)
 .;UPDATE HEADER
"RTN","GMRANKA",25,0)
 .S HEAD=^GMR(120.86,0)
"RTN","GMRANKA",26,0)
 .S $P(HEAD,U,4)=($P(HEAD,U,4)+1)
"RTN","GMRANKA",27,0)
 .S $P(HEAD,U,3)=DFN,^GMR(120.86,0)=HEAD
"RTN","GMRANKA",28,0)
 .S ^GMR(120.86,DFN,0)=DFN_U,^GMR(120.86,"B",DFN,DFN)=""
"RTN","GMRANKA",29,0)
 .Q
"RTN","GMRANKA",30,0)
 L -^GMR(120.86,0)
"RTN","GMRANKA",31,0)
 L +^GMR(120.86,DFN,0):1
"RTN","GMRANKA",32,0)
 ;ASK PATIENT QUESTION VIA
"RTN","GMRANKA",33,0)
 N DIR,Y,DIROUT,DTOUT,DIRUT,DUOUT,GMAOLD
"RTN","GMRANKA",34,0)
 S GMAOLD=$P($G(^GMR(120.86,DFN,0)),U,2)
"RTN","GMRANKA",35,0)
 S DIR(0)="120.86,1^AO^I Y=0&'$$NKASCR^GMRANKA(DFN) D INFO^GMRANKA K X"
"RTN","GMRANKA",36,0)
 S DIR("A")="Does this patient have any known allergies or adverse reactions? "
"RTN","GMRANKA",37,0)
 S DIR("B")=$S($P($G(^GMR(120.86,DFN,0)),U,2)=1:"Yes",$P($G(^GMR(120.86,DFN,0)),U,2)=0:"No",1:"") K:DIR("B")="" DIR("B")
"RTN","GMRANKA",38,0)
 S DIR("?")=$S(GMAOLD=0:"You may also enter @ to delete a previous NKA assessment and return the patient to a 'not assessed' state.  Use this if the NKA assessment was previously incorrectly entered.",1:"") ;21
"RTN","GMRANKA",39,0)
 D ^DIR
"RTN","GMRANKA",40,0)
 I $G(X)="@" D:GMAOLD=0 CLN W:GMAOLD=0 !,"Assessment deleted." Q  ;21 Allow removal of NKA
"RTN","GMRANKA",41,0)
 I $D(DTOUT)!$D(DIROUT) S GMRAOUT=1 D:GMAOLD="" CLN Q
"RTN","GMRANKA",42,0)
 I $D(DUOUT) S GMRAOUT=2 D:GMAOLD="" CLN Q
"RTN","GMRANKA",43,0)
 ; User Hits return and doesn't answer question
"RTN","GMRANKA",44,0)
 I Y="",GMAOLD="" D CLN Q
"RTN","GMRANKA",45,0)
 I Y'="",GMAOLD'=Y D
"RTN","GMRANKA",46,0)
 . N DIE,DA,DR
"RTN","GMRANKA",47,0)
 . S DIE="^GMR(120.86,",DA=DFN,DR="1////"_Y_";2////"_DUZ_";3///NOW"
"RTN","GMRANKA",48,0)
 . D ^DIE
"RTN","GMRANKA",49,0)
 . Q
"RTN","GMRANKA",50,0)
 L -^GMR(120.86,DFN,0)
"RTN","GMRANKA",51,0)
 Q
"RTN","GMRANKA",52,0)
CLN ; Clean out entries that have not been answered.
"RTN","GMRANKA",53,0)
 S DIK="^GMR(120.86,",DA=DFN D ^DIK K DIK,DA
"RTN","GMRANKA",54,0)
 ;W !?20,"Patient will still be listed as not being",!?20,"asked about Allergies/Adverse Reactions."
"RTN","GMRANKA",55,0)
 Q
"RTN","GMRANKA",56,0)
INFO ; Info string
"RTN","GMRANKA",57,0)
 N GMASTR
"RTN","GMRANKA",58,0)
 S GMASTR(1)="Currently this patient has Causative Agents on file."
"RTN","GMRANKA",59,0)
 S GMASTR(2)="You will have to answer YES to this question and then"
"RTN","GMRANKA",60,0)
 S GMASTR(3)="indicate that each of the Causative Agents are incorrect."
"RTN","GMRANKA",61,0)
 S GMASTR(4)="Then you will be reasked this question and will be able"
"RTN","GMRANKA",62,0)
 S GMASTR(5)="to enter NO."
"RTN","GMRANKA",63,0)
 D WRITE^GMRADSP8(1,0,$C(7))
"RTN","GMRANKA",64,0)
 D WRITE^GMRADSP8(1,10,.GMASTR)
"RTN","GMRANKA",65,0)
 Q
"RTN","GMRANKA",66,0)
NKASCR(DFN) ; Is Patient NKA (No Known Allergy)
"RTN","GMRANKA",67,0)
 ;   Input Variable:
"RTN","GMRANKA",68,0)
 ;        DFN = Patient DFN in Patient file
"RTN","GMRANKA",69,0)
 ;
"RTN","GMRANKA",70,0)
 ;  Output Variable:
"RTN","GMRANKA",71,0)
 ;        GMA = 1 Patient is True NKA
"RTN","GMRANKA",72,0)
 ;            = 0 Patient has a reaction in file 120.8
"RTN","GMRANKA",73,0)
 ;
"RTN","GMRANKA",74,0)
 ; This code will screen out Entered in Error entries
"RTN","GMRANKA",75,0)
 S GMA=1
"RTN","GMRANKA",76,0)
 N GMAX
"RTN","GMRANKA",77,0)
 S GMAX=0
"RTN","GMRANKA",78,0)
 F  S GMAX=$O(^GMR(120.8,"B",DFN,GMAX)) Q:GMAX<1  D  Q:'GMA
"RTN","GMRANKA",79,0)
 .I +$G(^GMR(120.8,GMAX,"ER")) Q
"RTN","GMRANKA",80,0)
 .S GMA=0
"RTN","GMRANKA",81,0)
 .Q
"RTN","GMRANKA",82,0)
 Q GMA
"RTN","GMRANKA",83,0)
 ;
"RTN","GMRANKA",84,0)
DELNKA ;Remove assessment of NKA for a selected patient
"RTN","GMRANKA",85,0)
 N Y,DFN,DIR,DIC
"RTN","GMRANKA",86,0)
 S DIC=120.86,DIC(0)="AEMQZ",DIC("A")="Select PATIENT NAME: " D ^DIC Q:Y=-1
"RTN","GMRANKA",87,0)
 S DFN=+Y
"RTN","GMRANKA",88,0)
 W !
"RTN","GMRANKA",89,0)
 I $$NKA^GMRANKA(DFN)'=0 W !,"This patient doesn't currently have an assessment of NKA." Q
"RTN","GMRANKA",90,0)
 S DIR(0)="Y",DIR("A")="Delete NKA assessment for patient "_$G(Y(0,0)),DIR("B")="NO"
"RTN","GMRANKA",91,0)
 S DIR("?")="Enter Y to delete the NKA assessment and return the patient to a 'not assessed' status.  Enter N to cancel this action."
"RTN","GMRANKA",92,0)
 D ^DIR
"RTN","GMRANKA",93,0)
 I Y=1 D CLN^GMRANKA W "...Done"
"RTN","GMRANKA",94,0)
 Q
"RTN","GMRAOR1")
0^11^B6008032
"RTN","GMRAOR1",1,0)
GMRAOR1 ;HIRMFO/RM,WAA-OERR UTILITIES ;8/2/04  15:13
"RTN","GMRAOR1",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRAOR1",3,0)
EN1(DFN,ARRAY) ; This entry returns a list of patient allergies/adverse
"RTN","GMRAOR1",4,0)
 ; reactions.
"RTN","GMRAOR1",5,0)
 ; Input variables:
"RTN","GMRAOR1",6,0)
 ;     DFN = IEN of patient in Patient (2) file
"RTN","GMRAOR1",7,0)
 ;     ARRAY = Return array for Patient reactions.
"RTN","GMRAOR1",8,0)
 ;             If ARRAY="" or undefined default will be GMRARXN.
"RTN","GMRAOR1",9,0)
 Q:$G(DFN)'>0
"RTN","GMRAOR1",10,0)
 S ARRAY=$S($G(ARRAY)'="":ARRAY,1:ARRAY="GMRARXN") Q:ARRAY="GMRAL"
"RTN","GMRAOR1",11,0)
 K GMRARXN,GMRAL,@ARRAY
"RTN","GMRAOR1",12,0)
 D EN1^GMRADPT ; Get Patient Allergies
"RTN","GMRAOR1",13,0)
 I GMRAL D  ; If the patient has reaction then reprocess to OERR Fmt
"RTN","GMRAOR1",14,0)
 .N GMRAIEN,GMRADFN,%,GMRASVR
"RTN","GMRAOR1",15,0)
 .S GMRARXN=1,GMRAIEN=0
"RTN","GMRAOR1",16,0)
 .F  S GMRAIEN=$O(GMRAL(GMRAIEN)) Q:GMRAIEN<1  D
"RTN","GMRAOR1",17,0)
 ..S GMRARXN(GMRARXN)=$P(GMRAL(GMRAIEN),U,2)_U ; Get freetext of agent.
"RTN","GMRAOR1",18,0)
 ..; Loop through 120.85 file to find all observed reacting reports for
"RTN","GMRAOR1",19,0)
 ..; this reaction.  Grab severity and store only the highest value.
"RTN","GMRAOR1",20,0)
 ..S GMRADFN=0,%="",GMRASVR="" F  S GMRADFN=$O(^GMR(120.85,"C",GMRAIEN,GMRADFN)) Q:GMRADFN<1  S %=$P($G(^GMR(120.85,GMRADFN,0)),U,14) S:%>+GMRASVR GMRASVR=%
"RTN","GMRAOR1",21,0)
 ..S GMRARXN(GMRARXN)=GMRARXN(GMRARXN)_$S(GMRASVR=1:"MILD",GMRASVR=2:"MODERATE",GMRASVR=3:"SEVERE",1:"")_U_GMRAIEN
"RTN","GMRAOR1",22,0)
 ..;Loop through the S/S multiple and get the external format and possibly the date/time.
"RTN","GMRAOR1",23,0)
 ..S %=0 F  S %=$O(GMRAL(GMRAIEN,"S",%)) Q:%<1  S GMRARXN(GMRARXN,"S",%)=$P(GMRAL(GMRAIEN,"S",%),";")_$S($G(GMRAIDT):";"_$P(^GMR(120.8,GMRAIEN,10,$O(^GMR(120.8,GMRAIEN,10,"B",$P(GMRAL(GMRAIEN,"S",%),";",2),0)),0),U,4),1:"") ;21
"RTN","GMRAOR1",24,0)
 ..S GMRARXN=GMRARXN+1
"RTN","GMRAOR1",25,0)
 ..Q
"RTN","GMRAOR1",26,0)
 .S GMRARXN=1
"RTN","GMRAOR1",27,0)
 .Q
"RTN","GMRAOR1",28,0)
 E  S GMRARXN=GMRAL
"RTN","GMRAOR1",29,0)
 I ARRAY'="GMRARXN" M @ARRAY=GMRARXN K GMRARXN
"RTN","GMRAOR1",30,0)
 K GMRAL
"RTN","GMRAOR1",31,0)
 Q
"RTN","GMRAOR2")
0^3^B10543663
"RTN","GMRAOR2",1,0)
GMRAOR2 ;HIRMFO/RM-OERR UTILITIES ;12/22/04  10:38
"RTN","GMRAOR2",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRAOR2",3,0)
EN1(IEN,ARRAY) ; This entry point returns detailed information about a
"RTN","GMRAOR2",4,0)
 ; particular patient allergy/adverse reaction.
"RTN","GMRAOR2",5,0)
 ; Input Variables
"RTN","GMRAOR2",6,0)
 ;       IEN = The internal entry number of the reaction in file 120.8
"RTN","GMRAOR2",7,0)
 ;     ARRAY = The array that the reaction data is to be passed back in.
"RTN","GMRAOR2",8,0)
 ;             (Note: The return array cannot be the GMRAL array.)
"RTN","GMRAOR2",9,0)
 Q:$G(IEN)=""
"RTN","GMRAOR2",10,0)
 S ARRAY=$S($G(ARRAY)'="":ARRAY,1:"GMRACT") Q:ARRAY="GMRAL"
"RTN","GMRAOR2",11,0)
 N GMRAPA,GMRAOTH,GMRAL,GMRAI
"RTN","GMRAOR2",12,0)
 S GMRAPA=IEN,GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAOR2",13,0)
 ; Set up GMRAL variable
"RTN","GMRAOR2",14,0)
 S GMRAL=$P(GMRAPA(0),U,2)_U
"RTN","GMRAOR2",15,0)
 S GMRAL=GMRAL_$S($P(GMRAPA(0),U,5)'="":$$GET1^DIQ(200,$P(GMRAPA(0),U,5)_",",".01"),1:"<None>")_U ;21
"RTN","GMRAOR2",16,0)
 S %=$S($P(GMRAPA(0),U,5)'="":$$GET1^DIQ(200,$P(GMRAPA(0),U,5)_",","8","I"),1:"") ;21
"RTN","GMRAOR2",17,0)
 S GMRAL=GMRAL_$S(%>1:$P($G(^DIC(3.1,%,0)),U),1:"")_U
"RTN","GMRAOR2",18,0)
 S GMRAL=GMRAL_$S($P(GMRAPA(0),U,16)=1:"",1:"NOT ")_"VERIFIED"_U
"RTN","GMRAOR2",19,0)
 S GMRAL=GMRAL_$S($P(GMRAPA(0),U,6)="o":"OBSERVED",$P(GMRAPA(0),U,6)="h":"HISTORICAL",1:"")_U
"RTN","GMRAOR2",20,0)
 S GMRAL=GMRAL_$S($P(GMRAPA(0),U,14)="A":"ALLERGY",$P(GMRAPA(0),U,14)="P":"PHARMACOLOGIC",$P(GMRAPA(0),U,14)="U":"UNKNOWN",1:"")_U
"RTN","GMRAOR2",21,0)
 S GMRAL=GMRAL_$$OUTTYPE^GMRAUTL($P(GMRAPA(0),U,20))_U_$S($P(GMRAPA(0),U,16)&('$P(GMRAPA(0),U,18)):"<auto-verified>",1:$$GET1^DIQ(200,$P(GMRAPA(0),U,18)_",",.01))_U_$P(GMRAPA(0),U,17) ;21
"RTN","GMRAOR2",22,0)
 S GMRAL=GMRAL_U_$$FMTE^XLFDT($P(GMRAPA(0),U,4)) ;21 add orig date/time
"RTN","GMRAOR2",23,0)
 ;Set up Comments in to GMRAL("C",
"RTN","GMRAOR2",24,0)
 S GMRAI=0 F %=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,26,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",25,0)
 .N GMRACOM
"RTN","GMRAOR2",26,0)
 .S GMRACOM=$G(^GMR(120.8,GMRAPA,26,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",27,0)
 .S GMRAL("C",%)=$P(GMRACOM,U)_U_$S($P(GMRACOM,U,3)="V":"VERIFIER",$P(GMRACOM,U,3)="O":"ORIGINATOR",1:"")_U_$$GET1^DIQ(200,$P(GMRACOM,U,2)_",",.01) ;21
"RTN","GMRAOR2",28,0)
 .M GMRAL("C",%)=^GMR(120.8,GMRAPA,26,GMRAI,2)
"RTN","GMRAOR2",29,0)
 .Q
"RTN","GMRAOR2",30,0)
 ;Observer information from file 120.85
"RTN","GMRAOR2",31,0)
 S GMRAI=0 F %=1:1 S GMRAI=$O(^GMR(120.85,"C",GMRAPA,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",32,0)
 .N GMRACOM
"RTN","GMRAOR2",33,0)
 .S GMRACOM=$G(^GMR(120.85,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",34,0)
 .S GMRAL("O",%)=$P(GMRACOM,U)_U_$S($P(GMRACOM,U,14)=1:"MILD",$P(GMRACOM,U,14)=2:"MODERATE",$P(GMRACOM,U,14)=3:"SEVERE",1:"")
"RTN","GMRAOR2",35,0)
 .Q
"RTN","GMRAOR2",36,0)
 ;Signs/Symptoms
"RTN","GMRAOR2",37,0)
 S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAOR2",38,0)
 S GMRAI=0 F %=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,10,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",39,0)
 .N GMRAZ
"RTN","GMRAOR2",40,0)
 .S GMRAZ=$G(^GMR(120.8,GMRAPA,10,GMRAI,0)) Q:GMRAZ=""
"RTN","GMRAOR2",41,0)
 .S GMRAL("S",%)=$S(+GMRAZ'=GMRAOTH:$P($G(^GMRD(120.83,+GMRAZ,0)),U),1:$P(GMRAZ,U,2))_$S($P(GMRAZ,U,4)'="":" ("_$$FMTE^XLFDT($P(GMRAZ,U,4),2)_")",1:"") ;21
"RTN","GMRAOR2",42,0)
 .Q
"RTN","GMRAOR2",43,0)
 ;VA Drug Class
"RTN","GMRAOR2",44,0)
 S GMRAI=0 F %=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,3,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",45,0)
 .N GMRACOM
"RTN","GMRAOR2",46,0)
 .S GMRACOM=$G(^GMR(120.8,GMRAPA,3,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",47,0)
 .S GMRAL("V",%)=$P($G(^PS(50.605,GMRACOM,0)),U,1,2)
"RTN","GMRAOR2",48,0)
 .Q
"RTN","GMRAOR2",49,0)
 ;Drug Ingredients
"RTN","GMRAOR2",50,0)
 S GMRAI=0 F %=1:1 S GMRAI=$O(^GMR(120.8,GMRAPA,2,GMRAI)) Q:GMRAI<1  D
"RTN","GMRAOR2",51,0)
 .N GMRACOM
"RTN","GMRAOR2",52,0)
 .S GMRACOM=$G(^GMR(120.8,GMRAPA,2,GMRAI,0)) Q:GMRACOM=""
"RTN","GMRAOR2",53,0)
 .S GMRAL("I",%)=$P($G(^PS(50.416,GMRACOM,0)),U)
"RTN","GMRAOR2",54,0)
 .Q
"RTN","GMRAOR2",55,0)
 M @ARRAY=GMRAL
"RTN","GMRAOR2",56,0)
 Q
"RTN","GMRAOR6")
0^16^B3213262
"RTN","GMRAOR6",1,0)
GMRAOR6 ;HIRMFO/WAA-OERR HL7 UTILITY ;10/15/04  10:59
"RTN","GMRAOR6",2,0)
 ;;4.0;Adverse Reaction Tracking;**17,21**;Mar 29, 1996
"RTN","GMRAOR6",3,0)
 ; File all allergies Sign/Symptoms
"RTN","GMRAOR6",4,0)
 ; INPUT
"RTN","GMRAOR6",5,0)
 ;    IEN = The internal entry number for the file entry being modified
"RTN","GMRAOR6",6,0)
 ;   FILE = The file number of the file being modified
"RTN","GMRAOR6",7,0)
 ;  GMRAL = The internal entry number of the GMRAL array being added
"RTN","GMRAOR6",8,0)
 ;
"RTN","GMRAOR6",9,0)
SIGN(GMRAFILE,GMRAIEN,GMRAL) ; Signs/Symptoms
"RTN","GMRAOR6",10,0)
 Q:$G(GMRAIEN)<1
"RTN","GMRAOR6",11,0)
 S GMRANODE=$S(GMRAFILE=120.8:10,GMRAFILE=120.85:2,1:0) Q:'GMRANODE
"RTN","GMRAOR6",12,0)
 S GMRASN=0 F  S GMRASN=$O(GMRAL(GMRAL,"S",GMRASN)) Q:GMRASN<1  D
"RTN","GMRAOR6",13,0)
 .Q:$P(GMRAL(GMRAL,"S",GMRASN),U)'>0  ;17 Screen out bad entries
"RTN","GMRAOR6",14,0)
 .Q:$O(^GMR(GMRAFILE,GMRAIEN,GMRANODE,"B",$P(GMRAL(GMRAL,"S",GMRASN),U),""))  ;Prevent DUPS
"RTN","GMRAOR6",15,0)
 .K DD,DO,DIC,DINUM,DLAYGO
"RTN","GMRAOR6",16,0)
 .S DA(1)=GMRAIEN,DIC="^GMR("_GMRAFILE_","_DA(1)_","_GMRANODE_","
"RTN","GMRAOR6",17,0)
 .S DIC(0)="L",X=$P(GMRAL(GMRAL,"S",GMRASN),U),DLAYGO=GMRAFILE
"RTN","GMRAOR6",18,0)
 .S DIC("P")=$S(GMRANODE=10:"120.81P",1:"120.8502P")
"RTN","GMRAOR6",19,0)
 .D FILE^DICN
"RTN","GMRAOR6",20,0)
 .K DD,DO,DIC,DINUM,DLAYGO
"RTN","GMRAOR6",21,0)
 .S GMRASN=$P(+Y,U)
"RTN","GMRAOR6",22,0)
 .S GMRALN=^GMR(GMRAFILE,GMRAIEN,GMRANODE,GMRASN,0) Q:GMRALN=""
"RTN","GMRAOR6",23,0)
 .I '$D(GMRAOTH) S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAOR6",24,0)
 .S $P(GMRALN,U,3)=$P(GMRAL(GMRAL),U,7)
"RTN","GMRAOR6",25,0)
 .I $P(GMRALN,U)=GMRAOTH S $P(GMRALN,U,2)=$P(GMRAL(GMRAL,"S",GMRASN),U,2) ;21
"RTN","GMRAOR6",26,0)
 .I GMRANODE=10 S $P(GMRALN,U,4)=$P(GMRAL(GMRAL,"S",GMRASN),U,4)
"RTN","GMRAOR6",27,0)
 .S ^GMR(GMRAFILE,GMRAIEN,GMRANODE,GMRASN,0)=GMRALN
"RTN","GMRAOR6",28,0)
 .Q
"RTN","GMRAOR6",29,0)
 K GMRAIEN,GMRANODE,GMRAFILE,GMRASN,GMRALN,GMRAOTH,Y,X
"RTN","GMRAOR6",30,0)
 Q
"RTN","GMRAPEM0")
0^6^B44377298
"RTN","GMRAPEM0",1,0)
GMRAPEM0 ;HIRMFO/WAA,FT-ALLERGY/ADVERSE REACTION PATIENT EDIT DRIVER ;11/10/04  15:04
"RTN","GMRAPEM0",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,5,17,21**;Mar 29, 1996
"RTN","GMRAPEM0",3,0)
EN11 ; Entry point for GMRA USER E/E PAT REC DATA option
"RTN","GMRAPEM0",4,0)
 ; GMRAUSER is a flag that indicates that this is a User
"RTN","GMRAPEM0",5,0)
 ; If user has Verifier Key then user will act normal
"RTN","GMRAPEM0",6,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) S GMRAUSER=1
"RTN","GMRAPEM0",7,0)
EN1 ; Entry for ENTER/EDIT PATIENT REACTION DATA option
"RTN","GMRAPEM0",8,0)
 ; EDIT PATIENT A/AR (DFN UNK.)
"RTN","GMRAPEM0",9,0)
 S GMRAOUT=0
"RTN","GMRAPEM0",10,0)
 W @IOF D PAT^GMRAPAT ; Select A Patient
"RTN","GMRAPEM0",11,0)
 D:'GMRAOUT EN21 G:'GMRAOUT EN1
"RTN","GMRAPEM0",12,0)
 K DFN,DIC,GMRAOUT,GMRARET,GMA,GMRAUSER
"RTN","GMRAPEM0",13,0)
 D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",14,0)
 Q
"RTN","GMRAPEM0",15,0)
EN21 ; Process patient data and determine if patient is NKA
"RTN","GMRAPEM0",16,0)
 S GMRAOUT=$G(GMRAOUT,0)
"RTN","GMRAPEM0",17,0)
 ; check patient assessment before enter/edit reaction
"RTN","GMRAPEM0",18,0)
 I $$NKA^GMRANKA(DFN),$$NKASCR^GMRANKA(DFN) D  ;delete 120.86 entry if assessment=yes, but no active reactions in 120.8
"RTN","GMRAPEM0",19,0)
 .N DA,DIK
"RTN","GMRAPEM0",20,0)
 .S DIK="^GMR(120.86,",DA=DFN D ^DIK
"RTN","GMRAPEM0",21,0)
 .Q
"RTN","GMRAPEM0",22,0)
 I '$$NKA^GMRANKA(DFN) D NKAASK^GMRANKA(DFN,.GMRAOUT) Q:GMRAOUT  I '$$NKA^GMRANKA(DFN) Q
"RTN","GMRAPEM0",23,0)
 L +^XTMP("GMRAED",DFN):1 I '$T D MESS^GMRAGUI1 Q  ;21
"RTN","GMRAPEM0",24,0)
 S GMRAOUT=0
"RTN","GMRAPEM0",25,0)
 D:'GMRAOUT SELECT
"RTN","GMRAPEM0",26,0)
 I $G(GMRAPA)'>0 S GMRAOUT=0
"RTN","GMRAPEM0",27,0)
 S GMRARP=1 I 'GMRAOUT D
"RTN","GMRAPEM0",28,0)
 .D ASK^GMRAUTL("Enter another Causative Agent? ",.GMRAOUT,.GMRARP)
"RTN","GMRAPEM0",29,0)
 .I 'GMRARP S GMRACNT=$O(^TMP($J,"GMRASF","B"),-1) D
"RTN","GMRAPEM0",30,0)
 ..I GMRACNT D SIGNOFF^GMRASIGN
"RTN","GMRAPEM0",31,0)
 ..I 'GMRAOUT D IDBAND^GMRASIGN
"RTN","GMRAPEM0",32,0)
 ..I GMRAOUT S GMRAOUT=2-GMRAOUT D:GMRAOUT&($D(^TMP($J,"GMRASF"))) ALERT^GMRASIGN K ^TMP($J,"GMRASF"),GMRACNT
"RTN","GMRAPEM0",33,0)
 ..Q
"RTN","GMRAPEM0",34,0)
 .Q
"RTN","GMRAPEM0",35,0)
 I GMRARP,'GMRAOUT K GMRARP L -^XTMP("GMRAED",DFN) G EN21 ;21
"RTN","GMRAPEM0",36,0)
 K GMRARP
"RTN","GMRAPEM0",37,0)
 ; check patient assessment when exiting enter/edit reaction
"RTN","GMRAPEM0",38,0)
 I $$NKA^GMRANKA(DFN),$$NKASCR^GMRANKA(DFN) D  ;delete 120.86 entry if assessment=yes, but no active reactions in 120.8
"RTN","GMRAPEM0",39,0)
 .N DA,DIK
"RTN","GMRAPEM0",40,0)
 .S DIK="^GMR(120.86,",DA=DFN D ^DIK
"RTN","GMRAPEM0",41,0)
 .Q
"RTN","GMRAPEM0",42,0)
 L -^XTMP("GMRAED",DFN) ;21
"RTN","GMRAPEM0",43,0)
 Q
"RTN","GMRAPEM0",44,0)
EN2 ; EDIT PATIENT A/AR (DFN KNOWN)
"RTN","GMRAPEM0",45,0)
 ; Called from the GMRAOR ALLERGY ENTER/EDIT protocol
"RTN","GMRAPEM0",46,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) S GMRAUSER=1
"RTN","GMRAPEM0",47,0)
 N GMRAOUT
"RTN","GMRAPEM0",48,0)
 D EN21 D
"RTN","GMRAPEM0",49,0)
 .;N GMRAOUT
"RTN","GMRAPEM0",50,0)
 .D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",51,0)
 .Q
"RTN","GMRAPEM0",52,0)
 K GMA,GMRARET,GMRAUSER
"RTN","GMRAPEM0",53,0)
 Q
"RTN","GMRAPEM0",54,0)
ALERT ; PROCESS ALERTS FOR ART
"RTN","GMRAPEM0",55,0)
 N DFN,GMRAPA,GMRACNT,GMRAOUT,GMRANEW,GMRAUSER
"RTN","GMRAPEM0",56,0)
 S (GMRACNT,GMRAOUT,GMRANEW)=0 D
"RTN","GMRAPEM0",57,0)
 .  I $G(XQADATA)="" S XQAKILL=0 Q
"RTN","GMRAPEM0",58,0)
 .  S DFN=$P(XQADATA,U),GMRAPA=$P(XQADATA,U,2),GMRAUSER=$P(XQADATA,U,3) Q:'DFN!'GMRAPA
"RTN","GMRAPEM0",59,0)
 .  I $D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) K GMRAUSER
"RTN","GMRAPEM0",60,0)
 .  S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAPEM0",61,0)
 .  I $P(GMRAPA(0),U,12) D  Q
"RTN","GMRAPEM0",62,0)
 .  .  W !,"This reaction has been signed off.",$C(7)
"RTN","GMRAPEM0",63,0)
 .  .  D HANGT^GMRAPEH0
"RTN","GMRAPEM0",64,0)
 .  .  S XQAKILL=0
"RTN","GMRAPEM0",65,0)
 .  .  Q
"RTN","GMRAPEM0",66,0)
 .  D EDIT^GMRAPEM4
"RTN","GMRAPEM0",67,0)
 .  D UPDATE^GMRAPEM3
"RTN","GMRAPEM0",68,0)
 .  I '$P(GMRAPA(0),U,12) D SIGNOFF^GMRASIGN
"RTN","GMRAPEM0",69,0)
 .  I GMRAOUT S GMRAOUT=2-GMRAOUT K XQAKILL
"RTN","GMRAPEM0",70,0)
 .  E  D
"RTN","GMRAPEM0",71,0)
 .  .I $P(GMRAPA(0),U,12) S XQAKILL=0
"RTN","GMRAPEM0",72,0)
 .  .I '$P(GMRAPA(0),U,12) K XQAKILL
"RTN","GMRAPEM0",73,0)
 .  D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",74,0)
 .  Q
"RTN","GMRAPEM0",75,0)
 Q
"RTN","GMRAPEM0",76,0)
SELECT ;Select a patient reaction
"RTN","GMRAPEM0",77,0)
 S GMRACNT=0 D 1^VADPT
"RTN","GMRAPEM0",78,0)
 S GMRALOC=$P(VAIN(4),U,2),GMRANAM=VADM(1),GMRASEX=VADM(5),GMRAOUT=0,GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0)) D KVAR^VADPT K VA,VAROOT
"RTN","GMRAPEM0",79,0)
 K GMRADUP S GMRALAGO=1
"RTN","GMRAPEM0",80,0)
 D REACT^GMRAPAT(DFN) ; Load all reaction for this patient.
"RTN","GMRAPEM0",81,0)
 D EN1^GMRAPES0
"RTN","GMRAPEM0",82,0)
 I GMRAPA>0 D TYPE D
"RTN","GMRAPEM0",83,0)
 .I GMRAOUT D:$G(GMRANEW)&($$MISSREQ) DELETE S:'$$MISSREQ&($G(GMRANEW)) GMRAOUT=0,^TMP($J,"GMRASF","B",GMRAPA,GMRACNT)="",^TMP($J,"GMRASF",GMRACNT,GMRAPA)="" D:GMRAOUT UPOUT^GMRAPEM3 Q  ; 21 The user up arrows out
"RTN","GMRAPEM0",84,0)
 .I GMRAERR D ERR^GMRAPEM3 Q  ;The reaction was entered in error
"RTN","GMRAPEM0",85,0)
 .I $P(GMRAPA(0),U,12) D SIGNED^GMRAPEM3 Q  ;The reaction has been signed
"RTN","GMRAPEM0",86,0)
 .; Reaction is a new reaction or Update data
"RTN","GMRAPEM0",87,0)
 .D UPDATE^GMRAPEM3
"RTN","GMRAPEM0",88,0)
 .Q
"RTN","GMRAPEM0",89,0)
 Q
"RTN","GMRAPEM0",90,0)
TYPE ; Select the type of the process to use this reaction
"RTN","GMRAPEM0",91,0)
 S GMRAERR=0
"RTN","GMRAPEM0",92,0)
 ; If reaction is not new check to see if user want to enter in error
"RTN","GMRAPEM0",93,0)
 I 'GMRANEW W @IOF N GMRADFN D EN1^GMRAPEE0 I GMRAERR!GMRAOUT Q
"RTN","GMRAPEM0",94,0)
 ;If reaction is observed and signed off
"RTN","GMRAPEM0",95,0)
 I $P(GMRAPA(0),U,6)="o",$P(GMRAPA(0),U,12) D  Q:GMRAOUT
"RTN","GMRAPEM0",96,0)
 .Q:$G(GMRAUSER,0)
"RTN","GMRAPEM0",97,0)
 .N GMRARP
"RTN","GMRAPEM0",98,0)
 .S GMRARP=0 D ASK^GMRAUTL("DO YOU WISH TO EDIT OBSERVED DATA? ",.GMRAOUT,.GMRARP) Q:GMRAOUT
"RTN","GMRAPEM0",99,0)
 .Q:'GMRARP  ;Observed data
"RTN","GMRAPEM0",100,0)
 .N GMRAOD S GMRAOD=$D(^GMR(120.85,"C",GMRAPA)) ;Existing observation data?
"RTN","GMRAPEM0",101,0)
OBSDATE .;
"RTN","GMRAPEM0",102,0)
 .S GMRALAGO=1 F  D EN2^GMRAU85 Q:GMRAPA1>0  Q:GMRAOUT  W !,"You must enter a valid date or an Up-arrow to exit",!,$C(7)
"RTN","GMRAPEM0",103,0)
 .I 'GMRAOUT,GMRAPA1>0  D EN2^GMRAROBS
"RTN","GMRAPEM0",104,0)
 .I '$D(^GMR(120.85,"C",GMRAPA)),$G(GMRANEW)!('$G(GMRANEW)&($G(GMRAOD))) D OBSPROB S GMRAOUT=0 G OBSDATE
"RTN","GMRAPEM0",105,0)
 .Q
"RTN","GMRAPEM0",106,0)
 ;Verify data
"RTN","GMRAPEM0",107,0)
 I 'GMRAERR,$P($G(^GMR(120.8,GMRAPA,0)),U,16)=0,$P(GMRAPA(0),U,12)=1,$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) D  Q:GMRAOUT
"RTN","GMRAPEM0",108,0)
 .K GMRAVER S GMRAVER=0
"RTN","GMRAPEM0",109,0)
 .N GMRAPRNT D EN1^GMRAVFY K GMRALLER,GMRAMEC,GMRAY
"RTN","GMRAPEM0",110,0)
 .I $P($G(^GMR(120.8,GMRAPA,0)),U,16)=1 S GMRASLL(GMRAPA)=1
"RTN","GMRAPEM0",111,0)
 .Q
"RTN","GMRAPEM0",112,0)
 ;EDIT Verified data
"RTN","GMRAPEM0",113,0)
 I 'GMRAERR,$P($G(^GMR(120.8,GMRAPA,0)),U,16)=1,$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) D  Q:GMRAOUT
"RTN","GMRAPEM0",114,0)
 .Q:$G(GMRAVER)=1
"RTN","GMRAPEM0",115,0)
 .N GMRARP
"RTN","GMRAPEM0",116,0)
 .S GMRARP=0
"RTN","GMRAPEM0",117,0)
 .D ASK^GMRAUTL("DO YOU WISH TO EDIT VERIFIED DATA? ",.GMRAOUT,.GMRARP) Q:GMRAOUT
"RTN","GMRAPEM0",118,0)
 .D:GMRARP SITE^GMRAUTL,EN1^GMRAPED0
"RTN","GMRAPEM0",119,0)
 .Q
"RTN","GMRAPEM0",120,0)
 ;if the reaction is new or not signed off
"RTN","GMRAPEM0",121,0)
 I '$P(GMRAPA(0),U,12) D
"RTN","GMRAPEM0",122,0)
 .D EDIT^GMRAPEM4
"RTN","GMRAPEM0",123,0)
 .I $P($G(^GMR(120.8,GMRAPA,0)),U,16) S GMRASLL(GMRAPA)=1
"RTN","GMRAPEM0",124,0)
 .Q
"RTN","GMRAPEM0",125,0)
 Q
"RTN","GMRAPEM0",126,0)
EXIT S GMRAPA=0 F  S GMRAPA=$O(^TMP($J,"GMRASF","B",GMRAPA)) Q:GMRAPA<1  D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAPEM0",127,0)
 K ^TMP($J,"GMRASF")
"RTN","GMRAPEM0",128,0)
 K ^TMP($J,"GMRALST")
"RTN","GMRAPEM0",129,0)
 Q
"RTN","GMRAPEM0",130,0)
 ;
"RTN","GMRAPEM0",131,0)
DELETE ;Delete entry if required information is not entered - section added in 17
"RTN","GMRAPEM0",132,0)
 N DA,DIK,GMRAPA1
"RTN","GMRAPEM0",133,0)
 W !!,"Required data not entered, deleting entry...",!
"RTN","GMRAPEM0",134,0)
 S GMRAPA1=$O(^GMR(120.85,"C",GMRAPA,0))
"RTN","GMRAPEM0",135,0)
 I GMRAPA1,$G(^GMR(120.85,GMRAPA1,0))="" K ^GMR(120.85,"C",GMRAPA,GMRAPA1)
"RTN","GMRAPEM0",136,0)
 I GMRAPA1 S DIK="^GMR(120.85,",DA=GMRAPA1 D ^DIK D UNLOCK^GMRAUTL(120.85,GMRAPA1)
"RTN","GMRAPEM0",137,0)
 I GMRAPA S DIK="^GMR(120.8,",DA=GMRAPA D ^DIK D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAPEM0",138,0)
 Q
"RTN","GMRAPEM0",139,0)
 ;
"RTN","GMRAPEM0",140,0)
OBSPROB ;Display help information for missing observed date/time entry
"RTN","GMRAPEM0",141,0)
 W !!,"Observed reactions must have at least one observation entry.",!,"If this reaction is incorrect then enter a date and then proceed",!,"to mark it as entered in error.",!
"RTN","GMRAPEM0",142,0)
 Q
"RTN","GMRAPEM0",143,0)
 ;
"RTN","GMRAPEM0",144,0)
MISSREQ() ;Function determines if required data is missing
"RTN","GMRAPEM0",145,0)
 N GMRA0,TYPE
"RTN","GMRAPEM0",146,0)
 S GMRA0=$G(^GMR(120.8,+$G(GMRAPA),0)) I GMRA0="" Q 1  ;Entry not found
"RTN","GMRAPEM0",147,0)
 S TYPE=$P(GMRA0,U,6) ;Get observed/historical
"RTN","GMRAPEM0",148,0)
 I TYPE="" Q 1  ;Type not entered
"RTN","GMRAPEM0",149,0)
 I TYPE="h" Q 0  ;Historical has no requirements
"RTN","GMRAPEM0",150,0)
 I TYPE="o" I '$D(^GMR(120.85,"C",GMRAPA))!('$O(^GMR(120.85,+$O(^GMR(120.85,"C",GMRAPA,0)),2,0)))!('$$REQCOM) Q 1  ;Missing obs date/time or sign/symptom or required comment
"RTN","GMRAPEM0",151,0)
 Q 0
"RTN","GMRAPEM0",152,0)
 ;
"RTN","GMRAPEM0",153,0)
REQCOM() ;Function determines if comments required
"RTN","GMRAPEM0",154,0)
 I '$D(GMRASITE) D SITE^GMRAUTL
"RTN","GMRAPEM0",155,0)
 I +$P(^GMRD(120.84,+GMRASITE,0),U,4)=0 Q 1  ;Comments required?
"RTN","GMRAPEM0",156,0)
 I $O(^GMR(120.8,GMRAPA,26,0)) Q 1
"RTN","GMRAPEM0",157,0)
 Q 0
"RTN","GMRAPEO0")
0^17^B7107199
"RTN","GMRAPEO0",1,0)
GMRAPEO0 ;HIRMFO/WAA,RM-EDIT OBSERVED A/AR ;10/15/04  10:06
"RTN","GMRAPEO0",2,0)
 ;;4.0;Adverse Reaction Tracking;**8,17,21**;Mar 29, 1996
"RTN","GMRAPEO0",3,0)
EN1 ; Entry to edit Observed A/AR Data
"RTN","GMRAPEO0",4,0)
 ;This code allows the user to select a concomitant reaction by date.
"RTN","GMRAPEO0",5,0)
 ;If that reactant doesn't have a date, then a new date is added
"RTN","GMRAPEO0",6,0)
 ;for the reactant.
"RTN","GMRAPEO0",7,0)
 N GMRAN85
"RTN","GMRAPEO0",8,0)
 S (GMRAX,GMRAN85)=0 I $D(^GMR(120.85,"C",GMRAPA)) S X=0 F  S X=$O(^GMR(120.85,"C",GMRAPA,X)) Q:X<1  S GMRAX=X
"RTN","GMRAPEO0",9,0)
 I GMRAX K X S:$D(^GMR(120.85,GMRAX,0)) DIC("B")=$P(^GMR(120.85,GMRAX,0),U)
"RTN","GMRAPEO0",10,0)
OBS ; 
"RTN","GMRAPEO0",11,0)
 S GMRALAGO=1 D EN2^GMRAU85 I GMRAOUT D:GMRAPA1 UNLOCK^GMRAUTL(120.85,GMRAPA1) G EXIT
"RTN","GMRAPEO0",12,0)
 I $P($G(^GMR(120.85,+$O(^GMR(120.85,"C",GMRAPA,0)),0)),U)="" W !?4,$C(7),"OBSERVATION DATE IS A REQUIRED ENTRY!!" G OBS
"RTN","GMRAPEO0",13,0)
 I $G(GMRAPA1)<1 W !?4,$C(7),"OBSERVATION DATE IS A REQUIRED ENTRY!!" G OBS
"RTN","GMRAPEO0",14,0)
 D EN1^GMRAPER2(GMRAPA,"120.8",.GMRAOUT,$P(^GMR(120.85,GMRAPA1,0),U))
"RTN","GMRAPEO0",15,0)
 I 'GMRAOUT,$O(^GMR(120.8,GMRAPA,10,0)) D
"RTN","GMRAPEO0",16,0)
 .N GMRAX
"RTN","GMRAPEO0",17,0)
 .K ^GMR(120.85,GMRAPA1,2) ;Clear out s/s before updating
"RTN","GMRAPEO0",18,0)
 .S ^GMR(120.85,GMRAPA1,2,0)="^120.8502P^"_$P(^GMR(120.8,GMRAPA,10,0),U,3,4),GMRAX=0 F  S GMRAX=$O(^GMR(120.8,GMRAPA,10,GMRAX)) Q:GMRAX<1  D
"RTN","GMRAPEO0",19,0)
 ..Q:'$D(^GMR(120.8,GMRAPA,10,GMRAX,0))
"RTN","GMRAPEO0",20,0)
 ..S ^GMR(120.85,GMRAPA1,2,GMRAX,0)=$P(^GMR(120.8,GMRAPA,10,GMRAX,0),U,1,2)_"^"_DUZ
"RTN","GMRAPEO0",21,0)
 ..S DIK="^GMR(120.85,GMRAPA1,2,",DA(1)=GMRAPA1,DA=GMRAX D IX1^DIK ;21
"RTN","GMRAPEO0",22,0)
 ..Q
"RTN","GMRAPEO0",23,0)
 .Q
"RTN","GMRAPEO0",24,0)
 G:GMRAOUT EXIT
"RTN","GMRAPEO0",25,0)
 I $D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) D MECH^GMRAPED0
"RTN","GMRAPEO0",26,0)
 G EXIT:GMRAOUT
"RTN","GMRAPEO0",27,0)
 D COMM G EXIT:GMRAOUT
"RTN","GMRAPEO0",28,0)
 D ORR G EXIT:GMRAOUT
"RTN","GMRAPEO0",29,0)
EXIT ; Exit line
"RTN","GMRAPEO0",30,0)
 I $G(GMRAPA1)'<0 D UNLOCK^GMRAUTL(120.85,GMRAPA1)
"RTN","GMRAPEO0",31,0)
 K DA,DIK,DR,GMRADT,GMRAR10,GMRAPA1,GMRARAD,GMRARDL,GMRAREC,GMRADATE,GMRARODT,GMRAROT,GMRARPR,GMRAX,GMRAY,GMRAZN
"RTN","GMRAPEO0",32,0)
 Q
"RTN","GMRAPEO0",33,0)
ORR ; Observed the reserved reaction reports
"RTN","GMRAPEO0",34,0)
 Q:$G(GMRAPA1)<1
"RTN","GMRAPEO0",35,0)
 Q:$G(GMRAUSER,0)
"RTN","GMRAPEO0",36,0)
 F  S %=1 W !,"Complete the observed reaction report" D YN^DICN Q:%=1  S:%<0 %=2 Q:%=2  W:%=0 !,"ENTER YES TO EDIT REACTION DATA OR NO TO SKIP REACTION DATA",$C(7)
"RTN","GMRAPEO0",37,0)
 I %=1 D
"RTN","GMRAPEO0",38,0)
 .N %
"RTN","GMRAPEO0",39,0)
 .D EN2^GMRAROBS
"RTN","GMRAPEO0",40,0)
 .Q
"RTN","GMRAPEO0",41,0)
 E  S:%=-1 GMRAOUT=1
"RTN","GMRAPEO0",42,0)
 Q
"RTN","GMRAPEO0",43,0)
COMM ; Fill in the comments
"RTN","GMRAPEO0",44,0)
 S GMRAVCM="O" D ENDING^GMRAPEM1 Q:GMRAOUT
"RTN","GMRAPEO0",45,0)
 I $D(DTOUT) S GMRAOUT=1
"RTN","GMRAPEO0",46,0)
 I 'GMRAOUT D COMCHECK^GMRAPEH0
"RTN","GMRAPEO0",47,0)
 I 'GMRAOUT G:GMRAREQ COMM
"RTN","GMRAPEO0",48,0)
 S GMRAOUT=0
"RTN","GMRAPEO0",49,0)
 K DUOUT,DTOUT,DA,DR,DIE Q
"RTN","GMRAPEO0",50,0)
 K DA,DR,DIE
"RTN","GMRAPEO0",51,0)
 Q
"RTN","GMRAPER0")
0^21^B49881172
"RTN","GMRAPER0",1,0)
GMRAPER0 ;HIRMFO/WAA-REACTIONS SELECT ROUTINE ;11/3/04  14:07
"RTN","GMRAPER0",2,0)
 ;;4.0;Adverse Reaction Tracking;**7,21**;Mar 29, 1996
"RTN","GMRAPER0",3,0)
EN1 ; ENTRY POINT TO SELECT SIGNS/SYMPTOMS
"RTN","GMRAPER0",4,0)
 K GMRARAD,GMRAROT,GMRARDL,GMRAROTD S GMRAR10(11)=GMRAOTH_"^OTHER SIGN/SYMPTOM"
"RTN","GMRAPER0",5,0)
LIST ; Display Signs/Symptoms
"RTN","GMRAPER0",6,0)
 W #
"RTN","GMRAPER0",7,0)
 I $O(GMRARPR(""))="" W !!,"No signs/symptoms have been specified.  Please add some now."
"RTN","GMRAPER0",8,0)
RELIST D DSPREAC
"RTN","GMRAPER0",9,0)
 ;This is to handle historical events
"RTN","GMRAPER0",10,0)
 I 'GMRAOUT,($O(GMRARPR(""))=""&($P(GMRAPA(0),U,6)="h")) G Q1
"RTN","GMRAPER0",11,0)
 ;This is to handle observed events
"RTN","GMRAPER0",12,0)
 I 'GMRAOUT,($O(GMRARPR(""))=""&($P(GMRAPA(0),U,6)="o")) W !!,$C(7),"SIGNS/SYMPTOMS MUST BE SPECIFIED.  THIS IS A REQUIRED RESPONSE." G RELIST
"RTN","GMRAPER0",13,0)
 G:'GMRAOUT LIST S:GMRAOUT GMRAOUT=2-GMRAOUT
"RTN","GMRAPER0",14,0)
Q1 ; Exit from program
"RTN","GMRAPER0",15,0)
 K %,DIC,GMADATE,GMRACTR,GMRADO,GMRAOK,GMRAPC,GMRAR10,GMRADATE,GMRAREAC,GMRARECN,GMRARPR,GMRAX,GMRAY,GMRARADD,GMRAROTT,X,Y
"RTN","GMRAPER0",16,0)
 Q
"RTN","GMRAPER0",17,0)
DSPREAC ; Display all the patient reactions
"RTN","GMRAPER0",18,0)
 I $O(GMRARPR(""))="" G NOREAC
"RTN","GMRAPER0",19,0)
 W !!,"The following is the list of reported signs/symptoms for this reaction:"
"RTN","GMRAPER0",20,0)
 ; GMRACHC(Y) is the reaction that the user can change
"RTN","GMRAPER0",21,0)
 S GMRAREAC="",GMRACTR=0 K GMRACHC
"RTN","GMRAPER0",22,0)
 F  S GMRAREAC=$O(GMRARPR(GMRAREAC)) Q:GMRAREAC=""  D
"RTN","GMRAPER0",23,0)
 .S GMRARECN=0 F  S GMRARECN=$O(GMRARPR(GMRAREAC,GMRARECN)) Q:GMRARECN'>0  D
"RTN","GMRAPER0",24,0)
 ..S Y=$$CHC,GMRACHC(Y,GMRAREAC,GMRARECN)=""
"RTN","GMRAPER0",25,0)
 ..S:Y GMRACHC(Y)=GMRARECN_U_GMRAREAC
"RTN","GMRAPER0",26,0)
 ..Q
"RTN","GMRAPER0",27,0)
 .Q
"RTN","GMRAPER0",28,0)
 ;v=reaction that this user did not enter
"RTN","GMRAPER0",29,0)
 I $D(GMRACHC(0)) D
"RTN","GMRAPER0",30,0)
 .W !!,"          These reactions were entered by another user:"
"RTN","GMRAPER0",31,0)
 .W !,"     Signs/Symptoms                                  " W:'$G(GMRANDT) "Date Observed"
"RTN","GMRAPER0",32,0)
 .W !,$$REPEAT^XLFSTR("-",75)
"RTN","GMRAPER0",33,0)
 .S X="" F  S X=$O(GMRACHC(0,X)) Q:X=""  S Y=0 F  S Y=$O(GMRACHC(0,X,Y)) Q:Y<1  D
"RTN","GMRAPER0",34,0)
 ..S GMRARECN=Y
"RTN","GMRAPER0",35,0)
 ..S GMRAREAC=X
"RTN","GMRAPER0",36,0)
 ..D:$G(GMRAPRP(GMRAREAC,GMRARECN))="" PRTREAC
"RTN","GMRAPER0",37,0)
 ..Q
"RTN","GMRAPER0",38,0)
 .W !
"RTN","GMRAPER0",39,0)
 .Q
"RTN","GMRAPER0",40,0)
 ;v===Reaction that this user entered
"RTN","GMRAPER0",41,0)
 S X=0 F  S X=$O(GMRACHC(X)) Q:X<1  D
"RTN","GMRAPER0",42,0)
 .S GMRARECN=$P(GMRACHC(X),U)
"RTN","GMRAPER0",43,0)
 .S GMRAREAC=$P(GMRACHC(X),U,2)
"RTN","GMRAPER0",44,0)
 .D:$G(GMRAPRP(GMRAREAC,GMRARECN))="" PRTREAC
"RTN","GMRAPER0",45,0)
 .Q
"RTN","GMRAPER0",46,0)
MANIL ;
"RTN","GMRAPER0",47,0)
 W !!,"Select Action (A)DD",$S(GMRACTR>0:", (D)ELETE ",1:" "),"OR <RET>: " R X:DTIME S:'$T X="^^" I "^^"[X S GMRAOUT=2-(X'="") Q
"RTN","GMRAPER0",48,0)
 S:X?1L X=$C($A(X)-32)
"RTN","GMRAPER0",49,0)
 I '(X="A"!(X="D")) W !?4,$C(7),"ENTER AN A TO ADD SIGNS/SYMPTOMS TO THIS LIST," W:GMRACTR !?10,"OR D TO DELETE SIGNS/SYMPTOMS FROM THIS LIST," W !?10,"OR <RET> TO ACCEPT THIS LIST OF SIGNS/SYMPTOMS." G MANIL
"RTN","GMRAPER0",50,0)
 I X="D" D DELREAC^GMRAPER1 Q
"RTN","GMRAPER0",51,0)
NOREAC D ADREAC
"RTN","GMRAPER0",52,0)
 Q:'$D(GMRARPR)
"RTN","GMRAPER0",53,0)
 ;v---Ask the date then loop through the RPR array and put the date in 3
"RTN","GMRAPER0",54,0)
 Q:GMRAOUT
"RTN","GMRAPER0",55,0)
 S GMRAASK=0
"RTN","GMRAPER0",56,0)
 S GMADATE=$G(GMADATE)
"RTN","GMRAPER0",57,0)
 I GMADATE="",$G(GMRAODT)>0 S GMADATE=GMRAODT
"RTN","GMRAPER0",58,0)
 I '$G(GMRANDT) D DATE(.GMADATE,.GMRAASK) Q:GMRAOUT  D
"RTN","GMRAPER0",59,0)
 .N GMRAX
"RTN","GMRAPER0",60,0)
 .;Add the data to the new reaction unless it has a date
"RTN","GMRAPER0",61,0)
 .;Reaction from the reaction file 120.8
"RTN","GMRAPER0",62,0)
 .S GMRAX=0 F  S GMRAX=$O(GMRARAD(GMRAX)) Q:GMRAX<1  D
"RTN","GMRAPER0",63,0)
 ..I $P(GMRARAD(GMRAX),U,2)'=""!($D(GMRARADD("DONE",GMRAX))) Q  ;Date had been added to this reaction or reaction has already been processed.  Allows null entry
"RTN","GMRAPER0",64,0)
 ..S $P(GMRARAD(GMRAX),U,2)=GMADATE,GMRARADD("DONE",GMRAX)="" ;keeps track of entries edited so null dates aren't over written during same session
"RTN","GMRAPER0",65,0)
 ..S $P(GMRARPR($P(GMRARAD(GMRAX),U),GMRAX),U,3)=GMADATE
"RTN","GMRAPER0",66,0)
 ..Q
"RTN","GMRAPER0",67,0)
 .;Other Reaction
"RTN","GMRAPER0",68,0)
 .S GMRAX="" F  S GMRAX=$O(GMRAROT(GMRAX)) Q:GMRAX=""  D
"RTN","GMRAPER0",69,0)
 ..I $P(GMRAROT(GMRAX),U,2)'=""!($D(GMRAROTT("DONE",GMRAX))) Q  ;Date had been added to this reaction or sign has already been processed.
"RTN","GMRAPER0",70,0)
 ..S $P(GMRAROT(GMRAX),U,2)=GMADATE,GMRAROTT("DONE",GMRAX)="" ;entries processed will not be overwritten by other sign/symptoms during same editing session
"RTN","GMRAPER0",71,0)
 ..S $P(GMRARPR($P(GMRAROT(GMRAX),U),GMRAOTH),U,3)=GMADATE
"RTN","GMRAPER0",72,0)
 .Q
"RTN","GMRAPER0",73,0)
 K GMADATE ;Delete date associated with this sign/symptom
"RTN","GMRAPER0",74,0)
 Q
"RTN","GMRAPER0",75,0)
ADREAC ;This is the site parameter's top ten most common signs/symptoms
"RTN","GMRAPER0",76,0)
 W !!,"The following are the top ten most common signs/symptoms:"
"RTN","GMRAPER0",77,0)
 F GMRAREAC=1:1:5 W !,$J(GMRAREAC,2),".",?4,$P(GMRAR10(GMRAREAC),U,2),?35,$J(GMRAREAC+6,2),".",?39,$P(GMRAR10(GMRAREAC+6),U,2)
"RTN","GMRAPER0",78,0)
 W !?1,"6.",?4,$P(GMRAR10(6),U,2)
"RTN","GMRAPER0",79,0)
RRD ;
"RTN","GMRAPER0",80,0)
 K DIR S DIR(0)="LOA^1:11"
"RTN","GMRAPER0",81,0)
 S DIR(0)=DIR(0)_"^I X[""."" W !,""DO NOT USE DECIMAL VALUES."",$C(7) K X Q"
"RTN","GMRAPER0",82,0)
 S DIR("A")="Enter from the list above :  "
"RTN","GMRAPER0",83,0)
 S DIR("?",1)="PLEASE ENTER THE NUMBERS OF THE SIGNS/SYMPTOMS YOU WOULD LIKE TO ADD."
"RTN","GMRAPER0",84,0)
 S DIR("?",2)="RANGES CAN BE SEPARATED BY A HYPHEN (-) AND GROUPS OF NUMBERS,"
"RTN","GMRAPER0",85,0)
 S DIR("?")="SEPARATED BY A COMMA (,)."
"RTN","GMRAPER0",86,0)
 D ^DIR K DIR
"RTN","GMRAPER0",87,0)
 S:$D(DTOUT) GMRAOUT=1
"RTN","GMRAPER0",88,0)
 S:$D(DUOUT) GMRAOUT=1
"RTN","GMRAPER0",89,0)
 Q:GMRAOUT!(Y="")
"RTN","GMRAPER0",90,0)
 S GMRADO=Y K Y,GMRAY
"RTN","GMRAPER0",91,0)
 S GMRAASK=0
"RTN","GMRAPER0",92,0)
 F Y=1:1:$L(GMRADO,",") S GMRAY=$P(GMRADO,",",Y) I +GMRAY D ADD
"RTN","GMRAPER0",93,0)
 Q
"RTN","GMRAPER0",94,0)
CHC() ; Check reaction to see if user can see and edit this reaction
"RTN","GMRAPER0",95,0)
 I $P(GMRARPR(GMRAREAC,GMRARECN),U,2)=DUZ!'$L($P(GMRARPR(GMRAREAC,GMRARECN),U,2)),'$P(GMRAPA(0),U,12)!$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) S GMRACTR=GMRACTR+1 Q GMRACTR
"RTN","GMRAPER0",96,0)
 Q 0
"RTN","GMRAPER0",97,0)
PRTREAC ;
"RTN","GMRAPER0",98,0)
 N GMRAPDAT
"RTN","GMRAPER0",99,0)
 I X=1 D
"RTN","GMRAPER0",100,0)
 .W !!,"     Signs/Symptoms                                  " W:'$G(GMRANDT) "Date Observed"
"RTN","GMRAPER0",101,0)
 .W !,$$REPEAT^XLFSTR("-",75)
"RTN","GMRAPER0",102,0)
 .Q
"RTN","GMRAPER0",103,0)
 W !?1,$S(X:$J(X,2),1:""),?5,$E($P(GMRARPR(GMRAREAC,GMRARECN),U),1,45)
"RTN","GMRAPER0",104,0)
 S GMRAPDAT=$S($P(GMRARPR(GMRAREAC,GMRARECN),U,3)'="":$P(GMRARPR(GMRAREAC,GMRARECN),U,3),$G(GMRADATE)>0:GMADATE,1:"")
"RTN","GMRAPER0",105,0)
 I '$G(GMRANDT) W ?53 W:GMRAPDAT'="" $$FMTE^XLFDT(GMRAPDAT,1)
"RTN","GMRAPER0",106,0)
 Q
"RTN","GMRAPER0",107,0)
ADD ;
"RTN","GMRAPER0",108,0)
 N Y
"RTN","GMRAPER0",109,0)
 I GMRAY=11 D STRIN Q
"RTN","GMRAPER0",110,0)
 S Y=GMRAR10(GMRAY)
"RTN","GMRAPER0",111,0)
SETT ;
"RTN","GMRAPER0",112,0)
 Q:'$L(Y)
"RTN","GMRAPER0",113,0)
 S GMRAREAC=$P(Y,U,2),GMRARECN=$P(Y,U) K GMRARDL(GMRARECN)
"RTN","GMRAPER0",114,0)
 S:'$D(GMRARPR(GMRAREAC,GMRARECN)) GMRARAD(GMRARECN)=GMRAREAC,GMRARPR(GMRAREAC,GMRARECN)=GMRAREAC
"RTN","GMRAPER0",115,0)
 Q
"RTN","GMRAPER0",116,0)
STRIN ;This will handle a string input
"RTN","GMRAPER0",117,0)
 W !!,"Enter OTHER SIGN/SYMPTOM: " R X:DTIME S:'$T X="^^" I "^^"[X S:X="^^"!(X=U) GMRAOUT=1 Q
"RTN","GMRAPER0",118,0)
 S DIC="^GMRD(120.83,",DIC("S")="I $P(^(0),U)'=""OTHER REACTION""",DIC(0)="EM",D="B^D",GMRAREAC=X K DTOUT,DUOUT D MIX^DIC1 K DIC G:X?1"?".E STRIN ;21
"RTN","GMRAPER0",119,0)
 I +Y'>0 S:$D(DTOUT)!$D(DUOUT) GMRAOUT=1 Q:GMRAOUT  D ADDG Q:GMRAOUT  G STRIN:%=2,ASKAN
"RTN","GMRAPER0",120,0)
YNOK W !,$P(Y,U,2)_" OK " S %=1 D YN^DICN I '% W !?4,$C(7),"ANSWER YES IF THE DATA ABOVE IS CORRECT, ELSE ANSWER NO." G YNOK
"RTN","GMRAPER0",121,0)
 I %=-1 S GMRAOUT=1 Q
"RTN","GMRAPER0",122,0)
 I %=2 S X=GMRAREAC G STRIN:X=$P(Y,U,2) D ADDG Q:GMRAOUT  G STRIN:%=2,ASKAN
"RTN","GMRAPER0",123,0)
 D SETT
"RTN","GMRAPER0",124,0)
ASKAN ;
"RTN","GMRAPER0",125,0)
 W !,"Would you like to add another sign/symptom" S %=2 D YN^DICN I '% W !?4,$C(7),"ANSWER YES TO ADD ANOTHER SIGN/SYMPTOM, ELSE ANSWER NO." G ASKAN
"RTN","GMRAPER0",126,0)
 S:%=-1 GMRAOUT=1 Q:%=2!GMRAOUT
"RTN","GMRAPER0",127,0)
 G STRIN
"RTN","GMRAPER0",128,0)
 Q
"RTN","GMRAPER0",129,0)
ADDG ;
"RTN","GMRAPER0",130,0)
 I $L(X)<3!($L(X)>30) W " ??",$C(7) S %=2 Q
"RTN","GMRAPER0",131,0)
 W !,X," is not in the Sign/Symptoms file.",!,"Would you like to add it for this patient" S %=1 D YN^DICN I '% W !?4,$C(7),"ANSWER YES IF YOU WANT TO PUT THIS SIGNS/SYMPTOMS INTO THE PATIENT DATA,",!?4,"ELSE ANSWER NO." G ADDG
"RTN","GMRAPER0",132,0)
 S:%=-1 GMRAOUT=1
"RTN","GMRAPER0",133,0)
 I %=1 N % I 'GMRAOUT S:'$D(GMRARPR(X,GMRAOTH)) GMRAROT(X)=X,GMRARPR(X,GMRAOTH)=X K GMRAROTD(X)
"RTN","GMRAPER0",134,0)
 Q
"RTN","GMRAPER0",135,0)
DATE(DATE,ASK) ; Enter the date for a reaction
"RTN","GMRAPER0",136,0)
 Q:ASK
"RTN","GMRAPER0",137,0)
 N %DT,X,Y
"RTN","GMRAPER0",138,0)
 S DATE=$G(DATE,""),%DT="AEPT",%DT("A")="Date(Time Optional) of appearance of Sign/Symptom(s): "
"RTN","GMRAPER0",139,0)
 S:$P(GMRAPA(0),U,6)="o" %DT("B")=$S(DATE="":"NOW",1:$$FMTE^XLFDT(DATE,1))
"RTN","GMRAPER0",140,0)
 S %DT(0)="-NOW" D ^%DT  I "^^"[X S GMRAOUT=$L(X) Q
"RTN","GMRAPER0",141,0)
 S DATE=Y,ASK=1
"RTN","GMRAPER0",142,0)
 Q
"RTN","GMRAPES0")
0^19^B71230096
"RTN","GMRAPES0",1,0)
GMRAPES0 ;HIRMFO/RM-SELECT PATIENT ALLERGY TO EDIT ;11/3/04  09:23
"RTN","GMRAPES0",2,0)
 ;;4.0;Adverse Reaction Tracking;**13,17,19,21**;Mar 29, 1996
"RTN","GMRAPES0",3,0)
EN1 ; GIVEN DFN, SELECT PATIENT ALLERGY
"RTN","GMRAPES0",4,0)
 N GMRAGOUT,ROOT,CNT,LST,NAM,DIR,GMRAET
"RTN","GMRAPES0",5,0)
 S GMRARET=0
"RTN","GMRAPES0",6,0)
 S GMRAPA=-1,GMRANEW=0 R !!,"Enter Causative Agent: ",GMRALAR:DTIME S:'$T GMRALAR="^^" S:GMRALAR="" GMRARET=1 I "^^"[GMRALAR S GMRAOUT='$L(GMRALAR)+1 G Q1
"RTN","GMRAPES0",7,0)
 I GMRALAR?1P.E!($L(GMRALAR)<3)!($L(GMRALAR)>30) S GMRAHLP=1 D EN1^GMRAHLP0 G EN1:'GMRAOUT,Q1
"RTN","GMRAPES0",8,0)
 I GMRALAR?.E1L.E S GMRALAR=$$UP^XLFSTR(GMRALAR)
"RTN","GMRAPES0",9,0)
PAL K Y,DTOUT,DUOUT S DGSENFLG="",DIC="^GMR(120.8,",DIC(0)="SEZ",X=GMRANAM,DIC("S")="I '+$G(^(""ER"")),$P(^(0),U,2)?@(""1""""""_GMRALAR_"""""".E""),$D(^GMR(120.8,""B"",DFN,+Y))",DIC("W")="W $P(^(0),U,2)"
"RTN","GMRAPES0",10,0)
 W !!,"Checking existing PATIENT ALLERGIES (#120.8) file for matches...",!
"RTN","GMRAPES0",11,0)
 D ^DIC S X=$P($G(Y(0)),"^",2) K DIC,DGSENFLG,DTOUT,DUOUT D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",12,0)
 S:+Y>0 GMRAPA=+Y G Q1:+Y>0!GMRAOUT,PAL:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",13,0)
 G Q1:'GMRALAGO
"RTN","GMRAPES0",14,0)
NPA W !!,"Now checking GMR ALLERGIES (#120.82) file for matches...",!
"RTN","GMRAPES0",15,0)
 S DIC("S")="I $P(^(0),U)'=""OTHER ALLERGY/ADVERSE REACTION""" ;21
"RTN","GMRAPES0",16,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 X=$P(Y,"^",2) D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",17,0)
 I +Y>0 S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",18,0)
 G Q1:GMRAOUT,NPA:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",19,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAPES0",20,0)
 K Y,DTOUT,DUOUT
"RTN","GMRAPES0",21,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAPES0",22,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM" D ^DIC K DIC D DIC
"RTN","GMRAPES0",23,0)
 I +Y>0 S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",24,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAPES0",25,0)
 K DUOUT,DTOUT,Y
"RTN","GMRAPES0",26,0)
 S ROOT=$$T^PSNAPIS,CNT=0,X=GMRALAR
"RTN","GMRAPES0",27,0)
 I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAPES0",28,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",29,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAPES0",30,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",31,0)
 I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",32,0)
 I CNT>1 D
"RTN","GMRAPES0",33,0)
 .D MATCHES
"RTN","GMRAPES0",34,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",35,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",36,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",37,0)
 D DIC I GMRAOUT S GMRAOUT=GMRAOUT=1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",38,0)
 I +Y>0 S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",39,0)
DRUG W !!,"Now checking the DRUG (#50) file for matches...",! K Y,DTOUT,DUOUT
"RTN","GMRAPES0",40,0)
 S CNT=0,X=GMRALAR K LST
"RTN","GMRAPES0",41,0)
 F ROOT="^PSDRUG(""B"")","^PSDRUG(""C"")" D
"RTN","GMRAPES0",42,0)
 .I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$O(@ROOT@(X,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(X,0)),.01)_" <"_X_">",1:X)
"RTN","GMRAPES0",43,0)
 .S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",44,0)
 ..S CNT=CNT+1,LST(CNT)=$O(@ROOT@(NAM,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(NAM,0)),.01)_" <"_NAM_">",1:NAM)
"RTN","GMRAPES0",45,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",46,0)
 I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",47,0)
 I CNT>1 D
"RTN","GMRAPES0",48,0)
 .D MATCHES
"RTN","GMRAPES0",49,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",50,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",51,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",52,0)
 D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",53,0)
 I +Y>0 S GMRAAR=+Y(0)_";PSDRUG(",GMRAAR(0)=$$GET1^DIQ(50,+Y(0),.01),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",54,0)
 ;19 - Moved ING and CLASS code here
"RTN","GMRAPES0",55,0)
ING W !!,"Now checking the INGREDIENTS (#50.416) file for matches...",!
"RTN","GMRAPES0",56,0)
 K Y,DTOUT,DUOUT S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",X=GMRALAR D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",57,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",58,0)
 G Q1:GMRAOUT,ING:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",59,0)
CLASS W !!,"Now checking VA DRUG CLASS (50.605) file for matches...",!
"RTN","GMRAPES0",60,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",D="C" D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",61,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",62,0)
 G Q1:GMRAOUT,CLASS:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",63,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files."
"RTN","GMRAPES0",64,0)
 W !!,"Before sending an email requesting the addition of a new reactant, please",!,"try entering the first 3 or 4 letters of the reactant to search for",!,"the desired entry.",!
"RTN","GMRAPES0",65,0)
 W !,"Would you like to send an email requesting ",GMRALAR,!,"be added as a causative agent?"
"RTN","GMRAPES0",66,0)
 S DIR("A")="Send email"
"RTN","GMRAPES0",67,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("?")="^D MESS^GMRAPES0"
"RTN","GMRAPES0",68,0)
 D ^DIR
"RTN","GMRAPES0",69,0)
 I Y'=+Y S GMRAOUT=1 G Q1
"RTN","GMRAPES0",70,0)
 I '+Y G EN1
"RTN","GMRAPES0",71,0)
YNDRG ;
"RTN","GMRAPES0",72,0)
 D GETINPUT(.GMRAET)
"RTN","GMRAPES0",73,0)
 S X=$$SENDREQ(DUZ,DFN,GMRALAR,.GMRAET)
"RTN","GMRAPES0",74,0)
 I '+X W !!,"Error - Message not sent - ",$P(X,U,2)
"RTN","GMRAPES0",75,0)
 I +X W !!,"Message sent - NOTE: This reactant was NOT added for this patient."
"RTN","GMRAPES0",76,0)
 W !
"RTN","GMRAPES0",77,0)
Q1 ;
"RTN","GMRAPES0",78,0)
 S:GMRAPA>0 GMRAPA(0)=$S($D(^GMR(120.8,+GMRAPA,0)):^(0),1:"")
"RTN","GMRAPES0",79,0)
 K %,D,DA,DIC,DTOUT,DUOUT,GMRAAR,GMRAHLP,GMRAING,GMRALAGO,GMRALAR,PSNDA,PSODA,X,Y
"RTN","GMRAPES0",80,0)
 Q
"RTN","GMRAPES0",81,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAPES0",82,0)
 S:$D(DTOUT) X="^^" I X="^^" S GMRAOUT=1 Q
"RTN","GMRAPES0",83,0)
 S:$D(DUOUT) Y=0 Q:+Y'>0
"RTN","GMRAPES0",84,0)
YNOK W !?3,X,"   OK" S %=1 D YN^DICN S:%=-1 GMRAOUT=1,Y=-1 Q:GMRAOUT  S:%=2 Y=-1 Q:Y=-1  S:$$DUPCHK(X,DFN,Y) Y=-1 Q:GMRAOUT  I % W ! Q  ;19
"RTN","GMRAPES0",85,0)
 W !?5,$C(7),"ANSWER YES IF THIS IS THE CORRECT ALLERGY/ADVERSE REACTION,",!?5,"ELSE ANSWER NO."
"RTN","GMRAPES0",86,0)
 G YNOK
"RTN","GMRAPES0",87,0)
DUPCHK(X,Y,Z) ;CHECK FOR ENTERED IN ERROR
"RTN","GMRAPES0",88,0)
 N GMRAPA,GMRAGOUT,%,%Y S GMRAGOUT=0
"RTN","GMRAPES0",89,0)
 I $P($G(^GMR(120.8,+Z,0)),U,2)=X Q GMRAGOUT
"RTN","GMRAPES0",90,0)
 I $O(^GMR(120.8,"B",Y,0)) S GMRAPA=0 F  S GMRAPA=$O(^GMR(120.8,"B",Y,GMRAPA)) Q:GMRAPA<1  D  Q:GMRAOUT!(GMRAGOUT)
"RTN","GMRAPES0",91,0)
 .I $P(^GMR(120.8,GMRAPA,0),U,2)'=X Q
"RTN","GMRAPES0",92,0)
 .I $D(^GMR(120.8,GMRAPA,"ER")) D
"RTN","GMRAPES0",93,0)
 ..F  S %=2 W !,?5,$C(7),"This Agent has been Entered in Error once before.",!,?5,"Are you sure you want to select this Agent again" D  Q:%
"RTN","GMRAPES0",94,0)
 ...D YN^DICN S:%'=1 %=2,GMRAOUT=1  S:%Y?2"^" GMRAOUT=2
"RTN","GMRAPES0",95,0)
 ...Q:%  W !,?10,"ENTER 'Y' FOR YES OR 'N' FOR NO"
"RTN","GMRAPES0",96,0)
 ...Q
"RTN","GMRAPES0",97,0)
 ..S GMRAGOUT=%
"RTN","GMRAPES0",98,0)
 ..Q
"RTN","GMRAPES0",99,0)
 .Q
"RTN","GMRAPES0",100,0)
 I GMRAGOUT=0 S GMRAGOUT=1
"RTN","GMRAPES0",101,0)
 Q (GMRAGOUT-1)
"RTN","GMRAPES0",102,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAPES0",103,0)
 N I,J,QUIT
"RTN","GMRAPES0",104,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAPES0",105,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAPES0",106,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAPES0",107,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAPES0",108,0)
 Q
"RTN","GMRAPES0",109,0)
 ;
"RTN","GMRAPES0",110,0)
MORE()  ; -- show more matches
"RTN","GMRAPES0",111,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAPES0",112,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAPES0",113,0)
 D ^DIR
"RTN","GMRAPES0",114,0)
 Q +Y
"RTN","GMRAPES0",115,0)
 ;
"RTN","GMRAPES0",116,0)
SENDREQ(USER,PAT,TEXT,GMRAET) ;Send email to GMRA REQUEST NEW REACTANT indicating user's request for a new allergy
"RTN","GMRAPES0",117,0)
 ;Returns 0^reason for error
"RTN","GMRAPES0",118,0)
 ;        1 if successful
"RTN","GMRAPES0",119,0)
 N XMDUZ,XMY,XMSUB,GMRATXT,XMTEXT,XMZ,XMMG,GMRAUI,GMRAPI,GMRAUS,GMRAPS,CNT,J
"RTN","GMRAPES0",120,0)
 Q:'$G(USER)!('+$G(DUZ))!('$L(TEXT)) "0^Required information missing"
"RTN","GMRAPES0",121,0)
 S XMDUZ="Allergy Package",XMSUB="Request to add new reactant"
"RTN","GMRAPES0",122,0)
 S XMY("G.GMRA REQUEST NEW REACTANT")=""
"RTN","GMRAPES0",123,0)
 S XMY(DUZ)="" ;Include requestor in message
"RTN","GMRAPES0",124,0)
 D GETS^DIQ(200,USER,".01;.132;.138;8","E","GMRAUI"),GETS^DIQ(2,PAT,".01;.09","IE","GMRAPI") S GMRAUS=USER_",",GMRAPS=PAT_","
"RTN","GMRAPES0",125,0)
 S CNT=1
"RTN","GMRAPES0",126,0)
 S GMRATXT(CNT)="A request to add "_TEXT_" as a new reactant was entered",CNT=CNT+1
"RTN","GMRAPES0",127,0)
 S GMRATXT(CNT)="by "_GMRAUI(200,GMRAUS,.01,"E")_" for patient "_GMRAPI(2,GMRAPS,.01,"E")_" ("_$E(GMRAPI(2,GMRAPS,.09,"I"),6,9)_")",CNT=CNT+1
"RTN","GMRAPES0",128,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",129,0)
 S GMRATXT(CNT)="User's contact information:",CNT=CNT+1
"RTN","GMRAPES0",130,0)
 S GMRATXT(CNT)="Title        : "_GMRAUI(200,GMRAUS,8,"E"),CNT=CNT+1
"RTN","GMRAPES0",131,0)
 S GMRATXT(CNT)="Office Phone : "_GMRAUI(200,GMRAUS,.132,"E"),CNT=CNT+1
"RTN","GMRAPES0",132,0)
 S GMRATXT(CNT)="Digital Pager: "_GMRAUI(200,GMRAUS,.138,"E"),CNT=CNT+1
"RTN","GMRAPES0",133,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",134,0)
 I $D(GMRAET) S GMRATXT(CNT)="The user added the following comment:",CNT=CNT+1 F J=1:1:$P(GMRAET(0),U,3) S GMRATXT(CNT)=GMRAET(J,0),CNT=CNT+1
"RTN","GMRAPES0",135,0)
 I $D(GMRAET) S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",136,0)
 S GMRATXT(CNT)="Please verify with the user the intended reactant and then take the",CNT=CNT+1
"RTN","GMRAPES0",137,0)
 S GMRATXT(CNT)="appropriate action.  Be sure to try alternate spellings, etc before",CNT=CNT+1
"RTN","GMRAPES0",138,0)
 S GMRATXT(CNT)="adding new local allergies.",CNT=CNT+1
"RTN","GMRAPES0",139,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",140,0)
 S GMRATXT(CNT)="Please note, a reaction WAS NOT entered for this patient!",CNT=CNT+1
"RTN","GMRAPES0",141,0)
 S XMTEXT="GMRATXT("
"RTN","GMRAPES0",142,0)
 D ^XMD
"RTN","GMRAPES0",143,0)
 Q $S($D(XMMG):"0^Mail group GMRA REQUEST NEW REACTANT has no members - contact IRM",1:1)
"RTN","GMRAPES0",144,0)
 ;
"RTN","GMRAPES0",145,0)
MESS ;Provide help for sending email message
"RTN","GMRAPES0",146,0)
 W !,"Enter YES to send an email to the allergy coordinator(s) indicating that",!,"Reactant--> ",GMRALAR,!,"was not found when you were trying to add it for this patient.",!,"Enter NO to try entering the reactant again."
"RTN","GMRAPES0",147,0)
 Q
"RTN","GMRAPES0",148,0)
 ;
"RTN","GMRAPES0",149,0)
GETINPUT(GMRAET) ;Allow user to add comment to message
"RTN","GMRAPES0",150,0)
 N DIC,DWLW,DWPK,DIWEPSE
"RTN","GMRAPES0",151,0)
 S ^TMP($J,"TEXT",0)=""
"RTN","GMRAPES0",152,0)
 S DIC="^TMP($J,""TEXT"","
"RTN","GMRAPES0",153,0)
 S DWLW=70,DWPK=1,DIWEPSE=""
"RTN","GMRAPES0",154,0)
 W !!,"You may now add any comments you may have to the message that",!,"is going to be sent with the request to add this reactant."
"RTN","GMRAPES0",155,0)
 W !,"You may want to add things like sign/symptoms, observed or historical, etc",!,"that may be useful to the reviewer.",!
"RTN","GMRAPES0",156,0)
 D EN^DIWE
"RTN","GMRAPES0",157,0)
 I $O(^TMP($J,"TEXT",0)) M GMRAET=^TMP($J,"TEXT")
"RTN","GMRAPES0",158,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAPES0",159,0)
 Q
"RTN","GMRAPET0")
0^4^B26842733
"RTN","GMRAPET0",1,0)
GMRAPET0 ;HIRMFO/RM-VERIFIED ALLERGY TASKS ;12/21/04  12:43
"RTN","GMRAPET0",2,0)
 ;;4.0;Adverse Reaction Tracking;**6,17,21**;Mar 29, 1996
"RTN","GMRAPET0",3,0)
EN1(GMRADFN,GMRAPA,GMRACT,GMRAOUT) ;
"RTN","GMRAPET0",4,0)
 ; ENTRY TO PERFORM ALL OF THE TASKS NECESSARY FOR
"RTN","GMRAPET0",5,0)
 ;                 A PROGRESS NOTE TO BE ENTERED BY ART
"RTN","GMRAPET0",6,0)
 ;     INPUT:
"RTN","GMRAPET0",7,0)
 ;           GMRADFN = PATIENT IEN IN THE PATIENT FILE
"RTN","GMRAPET0",8,0)
 ;           GMRAPA  = THE IEN IN THE PATIENT ALLERGY FILE
"RTN","GMRAPET0",9,0)
 ;           GMRACT  = THE ACTION TO BE ENTERED FOR THIS REACTION
"RTN","GMRAPET0",10,0)
 ;                   = "V" VERIFICATION OF A REACTION
"RTN","GMRAPET0",11,0)
 ;                   = "S" SIGN OFF OF A REACTION
"RTN","GMRAPET0",12,0)
 ;                   = "M" MEDWATCH FORM ENTERD
"RTN","GMRAPET0",13,0)
 ;                   = "E" REACTION ENERED IN ERROR
"RTN","GMRAPET0",14,0)
 ;      OUTPUT:
"RTN","GMRAPET0",15,0)
 ;           GMRAOUT = REACTION ALL WAS PASSED
"RTN","GMRAPET0",16,0)
 ;                   = 1 USER ABORT OR PN FAIL IN SOME WAY
"RTN","GMRAPET0",17,0)
 ;                   = 0 PASSED
"RTN","GMRAPET0",18,0)
 ;
"RTN","GMRAPET0",19,0)
 ;      VARABLE LIST
"RTN","GMRAPET0",20,0)
 ;        GMRACW = IS THE PROGRESS NOTE TITLE
"RTN","GMRAPET0",21,0)
 ;       GMRALOC = IS THE LOCATION OF THE PATIENT
"RTN","GMRAPET0",22,0)
 ;      GMRAHLOC = IS THE LOCATION IN FILE 44
"RTN","GMRAPET0",23,0)
 ;       GMRADFN = IS THE PATIENT IEN
"RTN","GMRAPET0",24,0)
 ;        GMRADT = IS THE DATE THE EVENT TOOK PLACE
"RTN","GMRAPET0",25,0)
 ;       GMRADUZ = IS THE USER WHO ENTERED THE INFORMATION
"RTN","GMRAPET0",26,0)
 ;        GMRAPN = IS THE IEN OF THE PROGRESS NOTE THAT WAS ENTERED
"RTN","GMRAPET0",27,0)
 ;
"RTN","GMRAPET0",28,0)
 ;CHECKING FOR A VALID TITLE
"RTN","GMRAPET0",29,0)
 K ^TMP("TIUP",$J),GMRAPN
"RTN","GMRAPET0",30,0)
 N GMRACW,GMRALOC,GMRAHLOC,GMRAXBOS ;21
"RTN","GMRAPET0",31,0)
 S GMRAPN=-1,GMRAXBOS=$$BROKER^XWBLIB ;21 Got GUI?
"RTN","GMRAPET0",32,0)
 I "VSME"'[GMRACT S GMRAOUT=1 D EXIT Q
"RTN","GMRAPET0",33,0)
 ; The following lines of code which reference Progress Notes files and
"RTN","GMRAPET0",34,0)
 ; routines will have to change when TIU replaces Progress Notes.
"RTN","GMRAPET0",35,0)
 ;S GMRACW=0 F  S GMRACW=$O(^GMR(121.2,"B","ADVERSE REACTION/ALLERGY",GMRACW)) Q:GMRACW<1  I $P($G(^GMR(121.1,$P($G(^GMR(121.2,GMRACW,0)),U,2),0)),U)="GENERAL NOTE" Q
"RTN","GMRAPET0",36,0)
 ;-----ADDED BY VAUGHN 1/13/97 FOR TIU REPLACES LINE ABOVE----
"RTN","GMRAPET0",37,0)
 S GMRACW=+$$WHATITLE^TIUPUTU("ADVERSE REACTION/ALLERGY")
"RTN","GMRAPET0",38,0)
 ;------END---
"RTN","GMRAPET0",39,0)
 ;-----CHANGED BY VAUGHN 1/13/97 FOR TIU---
"RTN","GMRAPET0",40,0)
 I GMRACW<1!($T(NEW^TIUPNAPI)']"")!('$$CANPICK^TIULP(GMRACW)) S GMRAOUT=1 D EXIT Q  ;21
"RTN","GMRAPET0",41,0)
 ;I GMRACW<1!($T(PN^GMRPART)']"") S GMRAOUT=1 D EXIT Q
"RTN","GMRAPET0",42,0)
 ;-----END----
"RTN","GMRAPET0",43,0)
 D @GMRACT I GMRAOUT D EXIT Q  ; THIS TELL'S THE PROGRAM WHERE TO GO
"RTN","GMRAPET0",44,0)
 S GMRALOC=""
"RTN","GMRAPET0",45,0)
 D VAD^GMRAUTL1(GMRADFN,"",.GMRALOC,"","","")
"RTN","GMRAPET0",46,0)
 I GMRALOC'="" S GMRAHLOC=+$G(^DIC(42,GMRALOC,44))
"RTN","GMRAPET0",47,0)
 E  I '$G(GMRAXBOS) D ASK S:Y<1 GMRAOUT=1
"RTN","GMRAPET0",48,0)
 ; Call to Progress Notes
"RTN","GMRAPET0",49,0)
 ; vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
"RTN","GMRAPET0",50,0)
 ;S:'GMRAOUT GMRAPN=+$$PN^GMRPART(GMRADFN,GMRADUZ,GMRADT,GMRACW,GMRAHLOC)
"RTN","GMRAPET0",51,0)
 ;---REPLACED LINE ABOVE WITH LINE BELOW;1/13/97 VAUGHN---
"RTN","GMRAPET0",52,0)
 I 'GMRAOUT D
"RTN","GMRAPET0",53,0)
 .S GMRAPN=0 D NEW^TIUPNAPI(.GMRAPN,GMRADFN,GMRADUZ,GMRADT,GMRACW,$G(GMRAHLOC),$S($G(GMRAXBOS):0,1:1)) ;17,21 Allow editing if not in GUI
"RTN","GMRAPET0",54,0)
 ;----------END-------
"RTN","GMRAPET0",55,0)
 I GMRAPN=-1,'$G(GMRAXBOS) S GMRAOUT=1 W !,"No Progress Note was created." ;21
"RTN","GMRAPET0",56,0)
 I GMRAPN=0,'$G(GMRAXBOS) W !,"Progress note has not been signed." ;21
"RTN","GMRAPET0",57,0)
 D EXIT
"RTN","GMRAPET0",58,0)
 Q
"RTN","GMRAPET0",59,0)
EXIT ; Clean up of variables
"RTN","GMRAPET0",60,0)
 K ^TMP("TIUP",$J),GMRAPN,GMRALOC,GMRAHLOC,GMRADUZ
"RTN","GMRAPET0",61,0)
 Q
"RTN","GMRAPET0",62,0)
ASK ; Simple file manager query for a location in file 44
"RTN","GMRAPET0",63,0)
 N DIC
"RTN","GMRAPET0",64,0)
 S X=""
"RTN","GMRAPET0",65,0)
 S DIC=44,DIC(0)="AEQ",DIC("A")="Select a Hospital Location for this patient: ",DIC("S")="I ""CMW""[$P(^(0),U,3)"
"RTN","GMRAPET0",66,0)
 D ^DIC
"RTN","GMRAPET0",67,0)
 I Y'>0 S GMRAOUT=1 Q
"RTN","GMRAPET0",68,0)
 I $D(DTOUT)!($D(DUOUT)) S GMRAOUT=1 Q
"RTN","GMRAPET0",69,0)
 S GMRAHLOC=+Y
"RTN","GMRAPET0",70,0)
 Q
"RTN","GMRAPET0",71,0)
V ; Verified Reaction
"RTN","GMRAPET0",72,0)
 N GMRAI ;21
"RTN","GMRAPET0",73,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPET0",74,0)
 S GMRADT=$P(GMRAPA(0),U,17),GMRADUZ=$P(GMRAPA(0),U,18)
"RTN","GMRAPET0",75,0)
 S:GMRADUZ="" GMRADUZ=DUZ ; Autoverified reaction being reverified
"RTN","GMRAPET0",76,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had an "_$S($P(GMRAPA(0),"^",14)="P":"adverse reaction reported for ",1:"allergy to ")_$P(GMRAPA(0),"^",2)
"RTN","GMRAPET0",77,0)
 S ^TMP("TIUP",$J,2,0)="verified on "_$$FMTE^XLFDT(GMRADT,1)_"."
"RTN","GMRAPET0",78,0)
 S GMRAI=2 D ADDCOM("V",.GMRAI) ;21
"RTN","GMRAPET0",79,0)
 S ^TMP("TIUP",$J,0)=U_U_GMRAI_U_GMRAI_U_GMRADT_"^^^" ;21
"RTN","GMRAPET0",80,0)
 Q
"RTN","GMRAPET0",81,0)
S ; Signed Reaction
"RTN","GMRAPET0",82,0)
 N GMRAI,GMRAREAC ;21
"RTN","GMRAPET0",83,0)
 D NOW^%DTC
"RTN","GMRAPET0",84,0)
 S GMRADT=%,GMRADUZ=DUZ
"RTN","GMRAPET0",85,0)
 S GMRAREAC=0,GMRAI=3 F  S GMRAREAC=$O(GMRAPA(GMRAREAC)) Q:GMRAREAC<1  S GMRAI=GMRAI+1,^TMP("TIUP",$J,GMRAI,0)=$P($G(^GMR(120.8,GMRAREAC,0)),U,2) S GMRAPA=GMRAREAC D  ;21
"RTN","GMRAPET0",86,0)
 .D ADDCOM("O",.GMRAI) ;21
"RTN","GMRAPET0",87,0)
 .S GMRAI=GMRAI+1,^TMP("TIUP",$J,GMRAI,0)="" ;21
"RTN","GMRAPET0",88,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had the following reaction"_$S(GMRAI=3:" ",1:"s ")
"RTN","GMRAPET0",89,0)
 S ^TMP("TIUP",$J,2,0)="signed-off on "_$$FMTE^XLFDT(GMRADT,1)_"."
"RTN","GMRAPET0",90,0)
 S ^TMP("TIUP",$J,3,0)="" ;21
"RTN","GMRAPET0",91,0)
 S ^TMP("TIUP",$J,0)=U_U_GMRAI_U_GMRAI_U_GMRADT_"^^^"
"RTN","GMRAPET0",92,0)
 Q
"RTN","GMRAPET0",93,0)
M ; MedWATCH data entered
"RTN","GMRAPET0",94,0)
 N X
"RTN","GMRAPET0",95,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPET0",96,0)
 D NOW^%DTC
"RTN","GMRAPET0",97,0)
 S GMRADT=%,GMRADUZ=DUZ
"RTN","GMRAPET0",98,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had a MEDWatch report completed on "_$$FMTE^XLFDT(GMRADT,1)_" for"
"RTN","GMRAPET0",99,0)
 S ^TMP("TIUP",$J,2,0)=$S($P(GMRAPA(0),"^",14)="P":"an adverse reaction to ",1:"allergy to ")_$P(GMRAPA(0),"^",2)_"."
"RTN","GMRAPET0",100,0)
 S ^TMP("TIUP",$J,0)=U_U_"2"_U_"2"_U_GMRADT_"^^^"
"RTN","GMRAPET0",101,0)
 Q
"RTN","GMRAPET0",102,0)
E ; Reaction Entered in Error
"RTN","GMRAPET0",103,0)
 N GMRAER,GMRAI ;21
"RTN","GMRAPET0",104,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPET0",105,0)
 S GMRAER=$G(^GMR(120.8,GMRAPA,"ER")) I GMRAER="" S GMRAOUT=1 Q
"RTN","GMRAPET0",106,0)
 S GMRADT=$P(GMRAER,U,2),GMRADUZ=$P(GMRAER,U,3)
"RTN","GMRAPET0",107,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had an "_$S($P(GMRAPA(0),"^",14)="P":"adverse reaction reported for ",1:"allergy to ")_$P(GMRAPA(0),"^",2)
"RTN","GMRAPET0",108,0)
 S ^TMP("TIUP",$J,2,0)="entered in error on "_$$FMTE^XLFDT(GMRADT,1)_"."
"RTN","GMRAPET0",109,0)
 S GMRAI=2 D ADDCOM("E",.GMRAI) ;21
"RTN","GMRAPET0",110,0)
 S ^TMP("TIUP",$J,0)=U_U_GMRAI_U_GMRAI_U_GMRADT_"^^^" ;21
"RTN","GMRAPET0",111,0)
 Q
"RTN","GMRAPET0",112,0)
 ;
"RTN","GMRAPET0",113,0)
ADDCOM(TYPE,CNT) ;Add any comments to progress note - section added in patch 21
"RTN","GMRAPET0",114,0)
 N SUB,ENTRY
"RTN","GMRAPET0",115,0)
 S ENTRY=$O(^GMR(120.8,GMRAPA,26,"AVER",TYPE,0)) Q:'+ENTRY
"RTN","GMRAPET0",116,0)
 S CNT=CNT+1,^TMP("TIUP",$J,CNT,0)="",CNT=CNT+1,^TMP("TIUP",$J,CNT,0)="Author's comments:"
"RTN","GMRAPET0",117,0)
 S CNT=CNT+1,^TMP("TIUP",$J,CNT,0)=""
"RTN","GMRAPET0",118,0)
 S SUB=0 F  S SUB=$O(^GMR(120.8,GMRAPA,26,ENTRY,2,SUB)) Q:'+SUB  S CNT=CNT+1,^TMP("TIUP",$J,CNT,0)=^GMR(120.8,GMRAPA,26,ENTRY,2,SUB,0)
"RTN","GMRAPET0",119,0)
 Q
"RTN","GMRARAD")
0^15^B18443849
"RTN","GMRARAD",1,0)
GMRARAD ;HIRMFO/RM-Radiology\ART Interface Routine ;12/8/04  08:03
"RTN","GMRARAD",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRARAD",3,0)
 ;
"RTN","GMRARAD",4,0)
RADD(DFN,OH,YN,VER) ; THIS EXTRINSIC FUNCTION WILL ADD A CONTRAST MEDIA
"RTN","GMRARAD",5,0)
 ; ALLERGY TO FILE 120.8 FOR PATIENT WITH IEN DFN.  INPUT VARIABLES:
"RTN","GMRARAD",6,0)
 ;    DFN = IEN IN FILE 2 OF PATIENT
"RTN","GMRARAD",7,0)
 ;    OH = 'o' FOR OBSERVED, 'h' FOR HISTORICAL, OR
"RTN","GMRARAD",8,0)
 ;         'p' IF THE UTILITY SHOULD PROMPT FOR OBSERVED/HISTORICAL.
"RTN","GMRARAD",9,0)
 ;    YN = 'Y' MEANS CONTRAST RXN, 'N' MEANS NO CONTRAST RXN,
"RTN","GMRARAD",10,0)
 ;         'U' MEANS UNKNOWN CONTRAST RXN, "" MEANS CONTRAST RXN DELETED
"RTN","GMRARAD",11,0)
 ;    VER (optional) = '1' MEANS DATA WILL BE AUTOVERIFIED,
"RTN","GMRARAD",12,0)
 ;                     '0' MEANS DATA WILL NOT BE VERIFIED,
"RTN","GMRARAD",13,0)
 ;                     '$D MEANS USE ART AUTOVERIFICATION CHECKS.
"RTN","GMRARAD",14,0)
 ; FUNCTION RETURNS THE IEN OF NEW 120.8 ENTRY, OR -1 IF NOT ADDED.
"RTN","GMRARAD",15,0)
 N DA,DIK,GMRA,GMRACAUS,GMRADRCL,GMRAL,GMRACLS,GMRANEW,GMRANOW,GMRAX,GMRAY,GMRAER,X,Y
"RTN","GMRARAD",16,0)
 I YN'="YES",YN'="Y" S DA=-1 G RETRA ; if no rxn, then no need to add
"RTN","GMRARAD",17,0)
 I DFN'>0 S DA=-1 G RETRA ; if bad DFN, then quit
"RTN","GMRARAD",18,0)
 S GMRACAUS="RADIOLOGICAL/CONTRAST MEDIA",GMRADRCL=$O(^PS(50.605,"B","DX100",0))_";PS(50.605," I +GMRADRCL'>0 S DA=-1 G RETRA ; is DX100 in file 50.605
"RTN","GMRARAD",19,0)
 S DA=0 F  S DA=$O(^GMR(120.8,"B",DFN,DA)) Q:DA'>0  I $$RALLG(DA) Q  ; check to see if RAD allergy present
"RTN","GMRARAD",20,0)
 I DA>0 G RETRA ; if RAD allergy present, then quit
"RTN","GMRARAD",21,0)
 I OH="p" D  ; read for OH if desired
"RTN","GMRARAD",22,0)
 .   K DIR S DIR("A")="(O)bserved or (H)istorical reaction? ",DIR(0)="SAO^O:Observed;H:Historical",DIR("?",1)="   IF THIS REACTION HAS BEEN OBSERVED, PLEASE ENTER AN O,",DIR("?")="   IF THIS REACTION IS HISTORICAL, ENTER AN H." D ^DIR
"RTN","GMRARAD",23,0)
 .   K DIR I Y="O"!(Y="H") S OH=$$LOW^XLFSTR(Y)
"RTN","GMRARAD",24,0)
 .   Q
"RTN","GMRARAD",25,0)
 I OH'="o",OH'="h" S DA=-1 G RETRA ; is OH set up right
"RTN","GMRARAD",26,0)
 S GMRANOW=$$HTFM^XLFDT($H),GMRAL=DFN_"^"_GMRACAUS_"^"_GMRADRCL_"^"_GMRANOW_"^"_$S('$G(RAAF18):DUZ,1:"")_"^"_OH_"^^^^^^1^^U^^^^^^D",GMRACLS=+GMRADRCL ; 120.8 record 0th node
"RTN","GMRARAD",27,0)
 I '$D(VER) D  ; need to check site's autoverify parameters
"RTN","GMRARAD",28,0)
 .   S GMRAY="",GMRAY(0)=GMRAL,VER=$$VFY^GMRASIGN(.GMRAY)
"RTN","GMRARAD",29,0)
 .   K GMRASITE,GMRATYPE,GMRAY
"RTN","GMRARAD",30,0)
 .   Q
"RTN","GMRARAD",31,0)
 I VER'=0,VER'=1 S DA=-1 G RETRA ; is VER set up correctly
"RTN","GMRARAD",32,0)
 S $P(GMRAL,U,16)=VER I VER S $P(GMRAL,U,17)=GMRANOW ; set up verify data in 0th node
"RTN","GMRARAD",33,0)
 S GMRANEW=$P($G(^GMR(120.8,0)),"^",3,4) ; get 120.8 0th node
"RTN","GMRARAD",34,0)
 F DA=1+GMRANEW:1 L +^GMR(120.8,DA,0):0 Q:$T&'$D(^GMR(120.8,DA,0))  L:$T&$D(^GMR(120.8,DA,0)) -^GMR(120.8,DA,0) ; find IEN for new record
"RTN","GMRARAD",35,0)
 S ^GMR(120.8,DA,0)=GMRAL ; set 0th node for new record
"RTN","GMRARAD",36,0)
 S ^GMR(120.8,DA,3,0)="^120.803PA^1^1",^GMR(120.8,DA,3,1,0)=GMRACLS ; set drug class multiple for new record
"RTN","GMRARAD",37,0)
 S ^GMR(120.8,DA,13,0)="^120.813DA^1^1",^GMR(120.8,DA,13,1,0)=$$DT^XLFDT_"^"_$G(DUZ,"") ;21 Add marked on chart when entered
"RTN","GMRARAD",38,0)
 S DIK="^GMR(120.8," D IX1^DIK L -^GMR(120.8,DA,0) ; xref new record
"RTN","GMRARAD",39,0)
 S $P(^GMR(120.8,0),"^",3,4)=DA_"^"_($P(GMRANEW,"^",2)+1) ; update 120.8 0th node
"RTN","GMRARAD",40,0)
 I '$G(RAAF18) S GMRAPA=DA,ZTSAVE("GMRAPA")="",ZTDESC="Send GMRA Bulletins For Radiology Allergy",ZTIO="",ZTRTN="QBULL^GMRARAD0",ZTDTH=$H D ^%ZTLOAD K ZTSK,GMRAPA ; send ART bulletins
"RTN","GMRARAD",41,0)
 D NKADD^GMRARAD0 ; add NKA entry if necessary
"RTN","GMRARAD",42,0)
RETRA Q DA ; exit returning entry number of new record
"RTN","GMRARAD",43,0)
 ;
"RTN","GMRARAD",44,0)
RACHK(DFN,YN) ; This function will be called from input transform on the
"RTN","GMRARAD",45,0)
 ; .05 field of file 70.  If the patient (DFN) has allergies in ART
"RTN","GMRARAD",46,0)
 ; to contrast media, and the user is changing the .05 field to
"RTN","GMRARAD",47,0)
 ; indicate NO contrast media allergy (YN), this function will prompt
"RTN","GMRARAD",48,0)
 ; the user if this change is correct.
"RTN","GMRARAD",49,0)
 ;    Input variables:  DFN=Patient IEN in file 2.
"RTN","GMRARAD",50,0)
 ;                      YN=new value of the .05 field.
"RTN","GMRARAD",51,0)
 ;    Return value:  1 if X should be killed, 0 if not
"RTN","GMRARAD",52,0)
 ;
"RTN","GMRARAD",53,0)
 N DA,DIK,DIR,FXN,GMRADA,GMRAER,GMRAX,GMRAY,X,Y
"RTN","GMRARAD",54,0)
 S FXN=0
"RTN","GMRARAD",55,0)
 I YN="N" D CHKEXAL^GMRARAD0
"RTN","GMRARAD",56,0)
 Q FXN
"RTN","GMRARAD",57,0)
RALLG(DA,ERR) ; This function will determine if entry DA in 120.8 represents
"RTN","GMRARAD",58,0)
 ; a contrast media allergy that is not entered in error.
"RTN","GMRARAD",59,0)
 ;    Input variable: DA=entry in file 120.8
"RTN","GMRARAD",60,0)
 ;                    ERR(optional)=if set to 0 do not check for E/E
"RTN","GMRARAD",61,0)
 ;    Return value: 1 if entry is contrast media allergy, 0 if not
"RTN","GMRARAD",62,0)
 ;
"RTN","GMRARAD",63,0)
 N FXN,ZERO,DRCL,DRCL1
"RTN","GMRARAD",64,0)
 S FXN=0,ZERO=$G(^GMR(120.8,DA,0)) I '$D(ERR) S ERR=1
"RTN","GMRARAD",65,0)
 I 'ERR!(ERR&'+$G(^GMR(120.8,DA,"ER"))) D
"RTN","GMRARAD",66,0)
 .F DRCL="DX100","DX101","DX102" S DRCL1=$O(^PS(50.605,"B",DRCL,0))_";PS(50.605," I $P(ZERO,U,3)=DRCL1!$D(^GMR(120.8,DA,3,"B",+DRCL1)) S FXN=1 Q
"RTN","GMRARAD",67,0)
 .I 'FXN,$P(ZERO,U,3)["GMRD(120.82"&$D(^GMRD(120.82,"D","RADIOLOGICAL/CONTRAST MEDIA",+$P(ZERO,U,3))) S FXN=1
"RTN","GMRARAD",68,0)
 .I 'FXN,$$PSCHK^GMRARAD1($P(ZERO,U,3)) S FXN=1
"RTN","GMRARAD",69,0)
 .Q
"RTN","GMRARAD",70,0)
 Q FXN
"RTN","GMRARAD",71,0)
OTHRAD(DFN,DA) ; This function will determine if another entry for patient
"RTN","GMRARAD",72,0)
 ; (DFN) exists other than entry DA that is also a Radiological
"RTN","GMRARAD",73,0)
 ; allergy.
"RTN","GMRARAD",74,0)
 ;    Input Variables:  DFN=IEN of patient,   DA=entry in 120.8
"RTN","GMRARAD",75,0)
 ;    Function Returns:  1 if another entry exists, else returns 0
"RTN","GMRARAD",76,0)
 ;
"RTN","GMRARAD",77,0)
 N FXN,GMRADA
"RTN","GMRARAD",78,0)
 S (GMRADA,FXN)=0 F  S GMRADA=$O(^GMR(120.8,"B",DFN,GMRADA)) Q:GMRADA'>0  I $$RALLG(GMRADA),GMRADA'=DA S FXN=1 Q
"RTN","GMRARAD",79,0)
 Q FXN
"RTN","GMRAROBS")
0^23^B13241542
"RTN","GMRAROBS",1,0)
GMRAROBS ;HIRMFO/RFM,WAA-OBSERVED REACTION DATA EDIT ;12/22/04  10:37
"RTN","GMRAROBS",2,0)
 ;;4.0;Adverse Reaction Tracking;**8,21**;Mar 29, 1996
"RTN","GMRAROBS",3,0)
EN1 ; Entry for EDIT OBSERVED REACTION DATA option
"RTN","GMRAROBS",4,0)
 S GMRAOUT=0,GMRALAGO=1 D EN1^GMRAU85 G:GMRAPA1'>0 EXIT
"RTN","GMRAROBS",5,0)
 S GMRAPA=0 D ^GMRADSP7 D EN2
"RTN","GMRAROBS",6,0)
 D UNLOCK^GMRAUTL(120.85,GMRAPA1)
"RTN","GMRAROBS",7,0)
 D EXIT
"RTN","GMRAROBS",8,0)
 Q
"RTN","GMRAROBS",9,0)
EN2 ; ENTRY FROM ENTER/EDIT OPTION  GMRAPA1 AND GMRAPA ARE KNOWN
"RTN","GMRAROBS",10,0)
 S DIE="^GMR(120.85,",DA=GMRAPA1,DR=".01;.5//"_$$GET1^DIQ(200,DUZ_",",".01")_";14.5;22//"_$$DATE^GMRAUTL1($P(^GMR(120.85,DA,0),U)) D ^DIE G:$D(Y)!('$D(DA)) EXIT ;21
"RTN","GMRAROBS",11,0)
 D:'$D(GMRASITE) SITE^GMRAUTL S GMRASITE(0)=^GMRD(120.84,+GMRASITE,0)
"RTN","GMRAROBS",12,0)
 G:$P(GMRAPA(0),U,20)'["D" EXIT
"RTN","GMRAROBS",13,0)
 G:$P(GMRASITE(0),U,7)="y" FDA
"RTN","GMRAROBS",14,0)
 F  S %=1 W !,"Complete the FDA data" D YN^DICN S:%<0 %=2 Q:%  W !,"ENTER YES TO EDIT FDA DATA ENTER NO TO SKIP FDA DATA",$C(7)
"RTN","GMRAROBS",15,0)
 I %'=1 K % G EXIT
"RTN","GMRAROBS",16,0)
FDA D EN1^GMRAPEL0 G:GMRAOUT EXIT
"RTN","GMRAROBS",17,0)
FDA1 W @IOF,!,"Indicate which FDA Report Sections to be completed:"
"RTN","GMRAROBS",18,0)
 W !,"1.  Reaction Information",!,"2.  Suspect Drug(s) Information",!,"3.  Concomitant Drugs and History",!,"4.  Initial Reporter"
"RTN","GMRAROBS",19,0)
 K DIR S DIR("A")="Choose number(s) of sections to be edited",DIR(0)="LO^1:4"
"RTN","GMRAROBS",20,0)
 S DIR(0)=DIR(0)_"^I X[""."" W !,""DO NOT USE DECIMAL VALUES."",$C(7) K X Q"
"RTN","GMRAROBS",21,0)
 S DIR("?",1)="ENTER THE NUMBER SECTION OR SECTIONS YOU WISH TO COMPLETE."
"RTN","GMRAROBS",22,0)
 S DIR("?",2)="YOU CAN ENTER:   YOU TYPE          SYSTEM WILL DO"
"RTN","GMRAROBS",23,0)
 S DIR("?",3)="   SECTION  -->    1                  SECTION 1"
"RTN","GMRAROBS",24,0)
 S DIR("?",4)="   RANGE    -->   2-4            SECTION 2 AND 3 AND 4"
"RTN","GMRAROBS",25,0)
 S DIR("?",5)="   GROUPS   -->  1,3,4           SECTION 1 AND 3 AND 4"
"RTN","GMRAROBS",26,0)
 S DIR("B")="1-4"
"RTN","GMRAROBS",27,0)
 D ^DIR K DIR G:$D(DIRUT)!(+Y'>0) EXIT
"RTN","GMRAROBS",28,0)
 K GMRAGHC F X=1:1 S GMRAX=$P(Y,",",X) Q:GMRAX']""  S GMRAGHC(GMRAX)=""
"RTN","GMRAROBS",29,0)
 F GMRAXXX=0:0 S GMRAXXX=$O(GMRAGHC(GMRAXXX)) Q:GMRAXXX'>0  D @GMRAXXX S:$D(Y) GMRAOUT=1 Q:GMRAOUT
"RTN","GMRAROBS",30,0)
EXIT ;
"RTN","GMRAROBS",31,0)
 K GMRAGHC,GMRAX,GMRAXXX,Y,X,DA,DIE,DR,GMRADT,GMRABGDT,GMRAENDT,XMB,XMY,VA
"RTN","GMRAROBS",32,0)
 Q
"RTN","GMRAROBS",33,0)
1 W @IOF D RXN^GMRAU851 Q:GMRAOUT  W ! S DA=GMRAPA1,DIE="^GMR(120.85,",DR="5T;6T;7T;9T;10T;11T;12.1T;12.2T" D ^DIE K GMRADT,GMRABGDT,GMRAENDT W !! D EN1^GMRALAB0 K GMRADT,GMRABGDT,GMRAENDT
"RTN","GMRAROBS",34,0)
 Q
"RTN","GMRAROBS",35,0)
2 W @IOF S GMRAOUT=0 K GMRADT,GMRABGDT,GMRAENDT D EN1^GMRAPHR2 K GMRADT,GMRABGDT,GMRAENDT
"RTN","GMRAROBS",36,0)
 Q
"RTN","GMRAROBS",37,0)
3 W @IOF S GMRAOUT=0 K GMRADT,GMRABGDT,GMRAENDT D EN1^GMRAPHR1 Q:GMRAOUT
"RTN","GMRAROBS",38,0)
 W ! S DA=GMRAPA1,DIE="^GMR(120.85,",DR="14" D ^DIE
"RTN","GMRAROBS",39,0)
 K GMRADT,GMRABGDT,GMRAENDT
"RTN","GMRAROBS",40,0)
 Q
"RTN","GMRAROBS",41,0)
4 N GMRAT W @IOF
"RTN","GMRAROBS",42,0)
 S GMRAT=$$GET1^DIQ(200,DUZ_",","8","I") ;21
"RTN","GMRAROBS",43,0)
 S:GMRAT'="" GMRAT=$P($G(^DIC(3.1,GMRAT,0)),U)
"RTN","GMRAROBS",44,0)
 S DIE="^GMR(120.85,",DA=GMRAPA1
"RTN","GMRAROBS",45,0)
 S DR="43//"_$$GET1^DIQ(200,DUZ_",",".01")_";44;45;46;47;48;49;50;51T;52T;52.1//"_GMRAT ;21
"RTN","GMRAROBS",46,0)
 D ^DIE
"RTN","GMRAROBS",47,0)
 Q
"RTN","GMRAROBS",48,0)
 ;
"RTN","GMRAROBS",49,0)
PTBUL ;Fire off the P&T FDA bul
"RTN","GMRAROBS",50,0)
 D NOW^%DTC
"RTN","GMRAROBS",51,0)
 ;1=PATIENT NAME
"RTN","GMRAROBS",52,0)
 ;2=PATIENT SSN
"RTN","GMRAROBS",53,0)
 ;3=REACTANT
"RTN","GMRAROBS",54,0)
 ;4=SIGNED OFF BY
"RTN","GMRAROBS",55,0)
 ;5=NOW
"RTN","GMRAROBS",56,0)
 S DFN=$P(GMRAPA(0),U) D PID^VADPT6
"RTN","GMRAROBS",57,0)
 S XMB(1)=$P(^DPT(DFN,0),U)
"RTN","GMRAROBS",58,0)
 S XMB(2)="("_VA("PID")_")" K VA
"RTN","GMRAROBS",59,0)
 S XMB(3)=$P(GMRAPA(0),U,2),XMB(4)=$$GET1^DIQ(200,DUZ_",",".01") ;21
"RTN","GMRAROBS",60,0)
 S Y=$$DATE^GMRAUTL1(%) S XMB(5)=Y,XMB="GMRA P&T COMMITTEE FDA"
"RTN","GMRAROBS",61,0)
 N GMRACNT S GMRACNT=0 K ^TMP("TIUP",$J) D ADDCOM^GMRAPET0("O",.GMRACNT) I $G(GMRACNT) S XMTEXT="^TMP(""TIUP"",$J)" ;21 Add originator comments to bulletin if they exist
"RTN","GMRAROBS",62,0)
 S XMY("G.GMRA P&T COMMITTEE FDA")=""
"RTN","GMRAROBS",63,0)
 D ^XMB
"RTN","GMRAROBS",64,0)
 Q
"RTN","GMRASEN2")
0^8^B8743380
"RTN","GMRASEN2",1,0)
GMRASEN2 ;HIRMFO/WAA-SEND ID BAND/CHART MARK TO BULLETIN/TEAM ;12/21/04  15:56
"RTN","GMRASEN2",2,0)
 ;;4.0;Adverse Reaction Tracking;**14,19,21**;Mar 29, 1996
"RTN","GMRASEN2",3,0)
BULLT ; SEND GMRA MARK CHART BULLETIN
"RTN","GMRASEN2",4,0)
 S GMRAOUT=0 K GMRASEND
"RTN","GMRASEN2",5,0)
 I '$D(GMRASITE) D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRASEN2",6,0)
 I $P(GMRASITE(0),U,8)=2 Q
"RTN","GMRASEN2",7,0)
 I $P(GMRASITE(0),U,8)<1!($$VERSION^XPDUTL("OR")<2) D  K GMRASEND,GMRASND,GMRABULL Q
"RTN","GMRASEN2",8,0)
 .S GMRABULL=$$FIND1^DIC(3.8,,"BX","GMRA MARK CHART") ;19
"RTN","GMRASEN2",9,0)
 .I GMRABULL<1 D:'$D(ZTQUEUED)&('$$BROKER^XWBLIB)  Q  ;19
"RTN","GMRASEN2",10,0)
 ..W !,"PLEASE CONTACT IRM TO CREATE A MAIL GROUP: GMRA MARK CHART",$C(7) S GMRASEND(DUZ)=""
"RTN","GMRASEN2",11,0)
 ..K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","GMRASEN2",12,0)
 ..Q
"RTN","GMRASEN2",13,0)
 .I '$$GOTLOCAL^XMXAPIG(GMRABULL) D:'$D(ZTQUEUED)&('$$BROKER^XWBLIB)  Q  ;19
"RTN","GMRASEN2",14,0)
 ..W !,"CALL IRM AND HAVE USERS ASSIGNED TO THE GMRA MARK CHART MAIL GROUP",$C(7)
"RTN","GMRASEN2",15,0)
 ..K DIR S DIR(0)="E" D ^DIR K DIR S GMRASEND(DUZ)=""
"RTN","GMRASEN2",16,0)
 ..Q
"RTN","GMRASEN2",17,0)
 .E  S GMRASEND("G.GMRA MARK CHART")="" ;19
"RTN","GMRASEN2",18,0)
 .D PID^VADPT6 S GMRAVIP=VA("PID") D KVAR^VADPT K VA
"RTN","GMRASEN2",19,0)
 .D BUL(.GMRASEND)
"RTN","GMRASEN2",20,0)
 .Q
"RTN","GMRASEN2",21,0)
 S GMRAPAT=$P(GMRAPA(0),U)_";DPT("
"RTN","GMRASEN2",22,0)
 S GMRATEAM=0 F  S GMRATEAM=$O(^OR(100.21,"AB",GMRAPAT,GMRATEAM)) Q:GMRATEAM<1  D
"RTN","GMRASEN2",23,0)
 .Q:'$D(^OR(100.21,GMRATEAM,0))
"RTN","GMRASEN2",24,0)
 .S GMRASEND=0 F  S GMRASEND=$O(^OR(100.21,GMRATEAM,1,GMRASEND)) Q:GMRASEND<1  D
"RTN","GMRASEN2",25,0)
 ..Q:'$D(^OR(100.21,GMRATEAM,1,GMRASEND,0))
"RTN","GMRASEN2",26,0)
 ..S GMRASEND(GMRASEND)=""
"RTN","GMRASEN2",27,0)
 ..Q
"RTN","GMRASEN2",28,0)
 .Q
"RTN","GMRASEN2",29,0)
 ;*********************************************************************
"RTN","GMRASEN2",30,0)
 D BUL(.GMRASEND)
"RTN","GMRASEN2",31,0)
 K GMRAPAT,GMRATEAM,GMRASEND
"RTN","GMRASEN2",32,0)
 Q
"RTN","GMRASEN2",33,0)
BUL(XMY) ;MAIL A BULLETIN TO A GROUP OR PERSON
"RTN","GMRASEN2",34,0)
 I '($D(XMY)\10) W:'$D(ZTQUEUED)&('$$BROKER^XWBLIB) !,"CALL IRM THERE IS NO ONE TO RECEIVE THIS BULLETIN",$C(7) S GMRAOUT=1 Q  ;19
"RTN","GMRASEN2",35,0)
 S XMB(1)=GMRANAM,XMB(3)=$S(GMRALOC'="":GMRALOC,1:"Outpatient"),XMB(4)=GMRAVIP ;19
"RTN","GMRASEN2",36,0)
 I '$D(GMRAPA2(2)) S XMB(2)=$P(GMRAPA2(1),U),XMB(5)=$P(GMRAPA2(1),U,2)
"RTN","GMRASEN2",37,0)
 E  S XMB(2)="See listing of allergies below." D
"RTN","GMRASEN2",38,0)
 .S GMRAPA2=0 F  S GMRAPA2=$O(GMRAPA2(GMRAPA2)) Q:GMRAPA2<1  D
"RTN","GMRASEN2",39,0)
 ..N GMRALN,GMRASPC
"RTN","GMRASEN2",40,0)
 ..S GMRASPC="                                             "
"RTN","GMRASEN2",41,0)
 ..S GMRALN=GMRAPA2(GMRAPA2)
"RTN","GMRASEN2",42,0)
 ..S GMRAPA2(GMRAPA2)=$E($P(GMRALN,U),1,38)
"RTN","GMRASEN2",43,0)
 ..S GMRAPA2(GMRAPA2)=GMRAPA2(GMRAPA2)_$E(GMRASPC,$L(GMRAPA2(GMRAPA2)),40)
"RTN","GMRASEN2",44,0)
 ..S GMRAPA2(GMRAPA2)=GMRAPA2(GMRAPA2)_$P(GMRALN,U,2)
"RTN","GMRASEN2",45,0)
 ..Q
"RTN","GMRASEN2",46,0)
 .S GMRAPA2=0 S XMTEXT="GMRAPA2",GMRAPA2(.4)="" ;21
"RTN","GMRASEN2",47,0)
 .S GMRAPA2(.5)="This patient has the following allergies:"
"RTN","GMRASEN2",48,0)
 .S GMRAPA2(.6)=""
"RTN","GMRASEN2",49,0)
 .S GMRAPA2(.7)="Causative Agent                         Mechanism"
"RTN","GMRASEN2",50,0)
 .S GMRAPA2(.8)="---------------                         ---------"
"RTN","GMRASEN2",51,0)
 .Q
"RTN","GMRASEN2",52,0)
 S XMB(6)="chart (due to admission)",XMB(7)="chart" ;21
"RTN","GMRASEN2",53,0)
 M GMRAXMB=XMB,GMRAXMY=XMY ;21
"RTN","GMRASEN2",54,0)
 D SENDBULL^XMXAPI(DUZ,"GMRA MARK CHART",.GMRAXMB,$G(XMTEXT),.GMRAXMY) ;19,21
"RTN","GMRASEN2",55,0)
 K GMRAPAT,GMRATEAM,GMRASEND
"RTN","GMRASEN2",56,0)
 Q
"RTN","GMRASEND")
0^7^B10911311
"RTN","GMRASEND",1,0)
GMRASEND ;HIRMFO/WAA-SEND ID BAND/CHART MARK TO BULLETIN/TEAM ;12/8/04  11:24
"RTN","GMRASEND",2,0)
 ;;4.0;Adverse Reaction Tracking;**14,19,21**;Mar 29, 1996
"RTN","GMRASEND",3,0)
BULLT ; SEND GMRA MARK CHART BULLETIN
"RTN","GMRASEND",4,0)
 I '$D(GMRATYPE) S GMRATYPE="B"
"RTN","GMRASEND",5,0)
 S GMRAOUT=0 K GMRASEND
"RTN","GMRASEND",6,0)
 I '$D(GMRASITE) D SITE^GMRAUTL S GMRASITE(0)=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRASEND",7,0)
 I $P(GMRASITE(0),U,8)=2 Q
"RTN","GMRASEND",8,0)
 I $P(GMRASITE(0),U,8)<1!($$VERSION^XPDUTL("OR")<2) D  K GMRASEND,GMRASND,GMRABULL Q
"RTN","GMRASEND",9,0)
 .S GMRABULL=$$FIND1^DIC(3.8,,"BX","GMRA MARK CHART") ;19
"RTN","GMRASEND",10,0)
 .I GMRABULL<1 D:'$D(ZTQUEUED)&('$$BROKER^XWBLIB)  Q  ;19
"RTN","GMRASEND",11,0)
 ..W !,"PLEASE CONTACT IRM TO CREATE A MAIL GROUP: GMRA MARK CHART",$C(7) S GMRASEND(DUZ)=""
"RTN","GMRASEND",12,0)
 ..K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","GMRASEND",13,0)
 ..Q
"RTN","GMRASEND",14,0)
 .I '$$GOTLOCAL^XMXAPIG(GMRABULL) D:'$D(ZTQUEUED)&('$$BROKER^XWBLIB)  Q  ;19
"RTN","GMRASEND",15,0)
 ..W !,"CALL IRM AND HAVE USERS ASSIGNED TO THE GMRA MARK CHART MAIL GROUP",$C(7)
"RTN","GMRASEND",16,0)
 ..K DIR S DIR(0)="E" D ^DIR K DIR S GMRASEND(DUZ)=""
"RTN","GMRASEND",17,0)
 ..Q
"RTN","GMRASEND",18,0)
 .E  S GMRASEND("G.GMRA MARK CHART")="" ;19
"RTN","GMRASEND",19,0)
 .S DFN=$P(GMRAPA(0),U) D INP^VADPT S:'+VAIN(4) GMRALOC=""
"RTN","GMRASEND",20,0)
 .I +VAIN(4) S GMRAHLOC=+$G(^DIC(42,+VAIN(4),44)),GMRALOC=$P(VAIN(4),U,2)
"RTN","GMRASEND",21,0)
 .D PID^VADPT6 S GMRAVIP=VA("PID") D KVAR^VADPT K VA
"RTN","GMRASEND",22,0)
 .D BUL(.GMRASEND,GMRATYPE)
"RTN","GMRASEND",23,0)
 .Q
"RTN","GMRASEND",24,0)
 ;=====================================================================
"RTN","GMRASEND",25,0)
 S GMRAPAT=$P(GMRAPA(0),U)_";DPT("
"RTN","GMRASEND",26,0)
 S GMRATEAM=0 F  S GMRATEAM=$O(^OR(100.21,"AB",GMRAPAT,GMRATEAM)) Q:GMRATEAM<1  D
"RTN","GMRASEND",27,0)
 .Q:'$D(^OR(100.21,GMRATEAM,0))
"RTN","GMRASEND",28,0)
 .S GMRASEND=0 F  S GMRASEND=$O(^OR(100.21,GMRATEAM,1,GMRASEND)) Q:GMRASEND<1  D
"RTN","GMRASEND",29,0)
 ..Q:'$D(^OR(100.21,GMRATEAM,1,GMRASEND,0))
"RTN","GMRASEND",30,0)
 ..S GMRASEND(GMRASEND)=""
"RTN","GMRASEND",31,0)
 ..Q
"RTN","GMRASEND",32,0)
 .Q
"RTN","GMRASEND",33,0)
 ;*********************************************************************
"RTN","GMRASEND",34,0)
 D BUL(.GMRASEND,GMRATYPE)
"RTN","GMRASEND",35,0)
 K GMRAPAT,GMRATEAM,GMRASEND
"RTN","GMRASEND",36,0)
 Q
"RTN","GMRASEND",37,0)
BUL(XMY,GMRATYPE) ;MAIL A BULLETIN TO A GROUP OR PERSON
"RTN","GMRASEND",38,0)
 I '$D(GMRAVIP) S DFN=$P(GMRAPA(0),U) D PID^VADPT6 S GMRAVIP=VA("PID") D KVAR^VADPT K VA
"RTN","GMRASEND",39,0)
 I '($D(XMY)\10) W:'$D(ZTQUEUED)&('$$BROKER^XWBLIB) !,"CALL IRM THERE IS NO ONE TO RECEIVE THIS BULLETIN",$C(7) S GMRAOUT=1 Q  ;19
"RTN","GMRASEND",40,0)
 I GMRATYPE="A",$P(GMRASITE(0),U,9)'=0 D  Q
"RTN","GMRASEND",41,0)
 .N GMRA
"RTN","GMRASEND",42,0)
 .S GMRA=0 F  S GMRA=$O(XMY(GMRA)) Q:GMRA<1  S XQA(GMRA)=""
"RTN","GMRASEND",43,0)
 .K XMY
"RTN","GMRASEND",44,0)
 .S XQAMSG="Mark Chart"_$S(GMRALOC'="":"/ID Band",1:"")_" for "_$E(GMRANAM,1,30)_","_GMRAVIP_" with "_$E($P(GMRAPA(0),U,2),1,20)
"RTN","GMRASEND",45,0)
 .D SETUP^XQALERT
"RTN","GMRASEND",46,0)
 .Q
"RTN","GMRASEND",47,0)
 S XMB(1)=GMRANAM,XMB(3)=$S(GMRALOC'="":GMRALOC,1:"Outpatient"),XMB(4)=GMRAVIP,XMB(2)=$P(GMRAPA(0),U,2) ;19
"RTN","GMRASEND",48,0)
 S XMB(5)=$S($P(GMRAPA(0),U,14)="A":"Allergy",$P(GMRAPA(0),U,14)="P":"Adverse Reaction",$P(GMRAPA(0),U,14)="U":"Unknown",1:"")
"RTN","GMRASEND",49,0)
 N GMRACHT,GMRAID ;21
"RTN","GMRASEND",50,0)
 S GMRACHT=$O(^GMR(120.8,GMRAPA,13,0)),GMRAID=$S('$P(GMRASITE(0),U,5):1,$G(GMRAHLOC):$O(^GMR(120.8,GMRAPA,14,0)),1:1) ;21
"RTN","GMRASEND",51,0)
 S (XMB(6),XMB(7))=$S('GMRACHT&('GMRAID):"chart and ID band",'GMRACHT:"chart",'GMRAID:"ID band",1:"") ;21
"RTN","GMRASEND",52,0)
 I XMB(6)="" Q  ;21 Don't send bulletin if it's not needed
"RTN","GMRASEND",53,0)
 N GMRAXMB,GMRAXMY ;19
"RTN","GMRASEND",54,0)
 M GMRAXMB=XMB,GMRAXMY=XMY ;19
"RTN","GMRASEND",55,0)
 D SENDBULL^XMXAPI(DUZ,"GMRA MARK CHART",.GMRAXMB,,.GMRAXMY) ;19
"RTN","GMRASEND",56,0)
 Q
"RTN","GMRASIG1")
0^22^B15349456
"RTN","GMRASIG1",1,0)
GMRASIG1 ;HIRMFO/WAA-A/AR PATIENT SIGN OFF PART2 ;11/10/04  11:36
"RTN","GMRASIG1",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,17,21**;Mar 29, 1996
"RTN","GMRASIG1",3,0)
PRINT ;Print out data to be signed off on
"RTN","GMRASIG1",4,0)
 N DIR,X,Y
"RTN","GMRASIG1",5,0)
 S GMRAPA=""
"RTN","GMRASIG1",6,0)
 I GMRASIGN W @IOF
"RTN","GMRASIG1",7,0)
 W !,"ADVERSE REACTION",!,"----------------" ;21
"RTN","GMRASIG1",8,0)
 S (GMRAI,GMRACNT)=0
"RTN","GMRASIG1",9,0)
 F  S GMRACNT=$O(^TMP($J,"GMRASF",GMRACNT)) Q:GMRACNT<1  S GMRAPA=$O(^TMP($J,"GMRASF",GMRACNT,0)) Q:GMRAPA<0  D  Q:GMRAOUT  I $Y>(IOSL-4) D PAGE Q:GMRAOUT
"RTN","GMRASIG1",10,0)
 .W ! W:GMRACNTT>1 GMRACNT,")" ;21
"RTN","GMRASIG1",11,0)
 .S GMRAG=^GMR(120.8,GMRAPA,0),GMRADRG=$S($P(GMRAG,U,20)="D":1,1:0)
"RTN","GMRASIG1",12,0)
 .W "  ",$P(GMRAG,U,2),! ;21
"RTN","GMRASIG1",13,0)
 .W !,?11,"Obs/Hist:",?21,$S($P(GMRAG,U,6)="o":"OBSERVED",$P(GMRAG,U,6)="h":"HISTORICAL",1:"") I $P(GMRAG,U,6)="o" W !,?12,"Obs d/t: ",$$FMTE^XLFDT($P(^GMR(120.85,$O(^GMR(120.85,"C",GMRAPA,0)),0),U)) ;21
"RTN","GMRASIG1",14,0)
 .K GMRAHEAD
"RTN","GMRASIG1",15,0)
 .K GMRAREC I $D(^GMR(120.8,GMRAPA,10,0)) D
"RTN","GMRASIG1",16,0)
 ..S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRASIG1",17,0)
 ..S GMRAREC=0 F  S GMRAREC=$O(^GMR(120.8,GMRAPA,10,GMRAREC)) Q:GMRAREC'>0  D  ;21
"RTN","GMRASIG1",18,0)
 ...S X=$G(^GMR(120.8,GMRAPA,10,GMRAREC,0)),GMRAREC(GMRAREC)=$S($P(X,U)'=GMRAOTH:$P($G(^GMRD(120.83,+$P(X,U),0)),U),1:$P(X,U,2)) ;21
"RTN","GMRASIG1",19,0)
 ...I $P(X,U,4)>0 S $P(GMRAREC(GMRAREC),U,2)=$$FMTE^XLFDT($P(X,U,4),2) ;21
"RTN","GMRASIG1",20,0)
 ...Q  ;21
"RTN","GMRASIG1",21,0)
 ..Q
"RTN","GMRASIG1",22,0)
 .I $D(GMRAREC)=11 S GMRAREC=$O(GMRAREC("")) W !,?5,"Signs/Symptoms: ",?21,$P(GMRAREC(GMRAREC),U) W:$P(GMRAREC(GMRAREC),U,2)'="" " ("_$P(GMRAREC(GMRAREC),U,2)_")" ;21
"RTN","GMRASIG1",23,0)
 .;W ?65,$S($P(GMRAG,U,6)="o":"OBSERVED",$P(GMRAG,U,6)="h":"HISTORICAL",1:"")
"RTN","GMRASIG1",24,0)
 .I $G(GMRAREC)>0 F  S GMRAREC=$O(GMRAREC(GMRAREC)) Q:GMRAREC<1  W !,?21,$P(GMRAREC(GMRAREC),U) W:$P(GMRAREC(GMRAREC),U,2)'="" " ("_$P(GMRAREC(GMRAREC),U,2)_")" I $Y>(IOSL-4) D PAGE Q:GMRAOUT  ;21
"RTN","GMRASIG1",25,0)
 .Q:GMRAOUT  D:$Y>(IOSL-4) PAGE Q:GMRAOUT  W !
"RTN","GMRASIG1",26,0)
 .D OUTPUT^GMRAPEM1 Q:GMRAOUT
"RTN","GMRASIG1",27,0)
 .Q
"RTN","GMRASIG1",28,0)
 Q:GMRACNTT'>1
"RTN","GMRASIG1",29,0)
 Q:'GMRASIGN
"RTN","GMRASIG1",30,0)
 W (GMRACNTT+1),")  All of the above",! ;17
"RTN","GMRASIG1",31,0)
 W (GMRACNTT+2),")  None of the above",! ;17
"RTN","GMRASIG1",32,0)
 Q
"RTN","GMRASIG1",33,0)
PAGE ;PAGE
"RTN","GMRASIG1",34,0)
 N DIR
"RTN","GMRASIG1",35,0)
 D ENDPG^GMRADSP3 Q:GMRAOUT
"RTN","GMRASIG1",36,0)
 W @IOF,!
"RTN","GMRASIG1",37,0)
 Q
"RTN","GMRASIG1",38,0)
PNOTE ; Generate a Progress Note for a patient
"RTN","GMRASIG1",39,0)
 Q:$G(GMRAUSER,0)
"RTN","GMRASIG1",40,0)
 N GMRAOUT S GMRAOUT=0
"RTN","GMRASIG1",41,0)
 I $D(GMRASLL) D
"RTN","GMRASIG1",42,0)
 .N GMRAFLL,X
"RTN","GMRASIG1",43,0)
 .S X=0 F  S X=$O(GMRASLL(X)) Q:X<1  D
"RTN","GMRASIG1",44,0)
 ..I GMRASLL(X) Q
"RTN","GMRASIG1",45,0)
 ..I $P($G(^GMR(120.8,X,0)),U,6)'="o" Q
"RTN","GMRASIG1",46,0)
 ..S GMRAFLL(X)=""
"RTN","GMRASIG1",47,0)
 ..Q
"RTN","GMRASIG1",48,0)
 .Q:'$D(GMRAFLL)
"RTN","GMRASIG1",49,0)
 .D EN1^GMRAPET0(DFN,.GMRAFLL,"S",.GMRAOUT)
"RTN","GMRASIG1",50,0)
 .Q
"RTN","GMRASIG1",51,0)
 Q
"RTN","GMRASIG1",52,0)
ENCNT ; Count how many entries where selected and set up Sort order
"RTN","GMRASIG1",53,0)
 S (GMRACNTT,X)=0 K ^TMP($J,"GMRARE") ; Resort the entries
"RTN","GMRASIG1",54,0)
 F  S X=$O(^TMP($J,"GMRASF","B",X)) Q:X<1  D
"RTN","GMRASIG1",55,0)
 .S GMRACNTT=GMRACNTT+1
"RTN","GMRASIG1",56,0)
 .S ^TMP($J,"GMRARE",GMRACNTT,X)=""
"RTN","GMRASIG1",57,0)
 .S ^TMP($J,"GMRARE","B",X,GMRACNTT)=""
"RTN","GMRASIG1",58,0)
 .Q
"RTN","GMRASIG1",59,0)
 K ^TMP($J,"GMRASF")
"RTN","GMRASIG1",60,0)
 M ^TMP($J,"GMRASF")=^TMP($J,"GMRARE")
"RTN","GMRASIG1",61,0)
 K ^TMP($J,"GMRARE")
"RTN","GMRASIG1",62,0)
 Q
"RTN","GMRASIG1",63,0)
YNSO ;Select sign off for a patient
"RTN","GMRASIG1",64,0)
 W @IOF,!,"Causative Agent Data edited this Session:"
"RTN","GMRASIG1",65,0)
 K X D PRINT ; Redisplay the reactions
"RTN","GMRASIG1",66,0)
 K DIR S DIR(0)="L^1:"_(GMRACNTT+2),GMRALL=GMRACNTT+1,GMRANON=GMRACNTT+2 ;17
"RTN","GMRASIG1",67,0)
 S DIR(0)=DIR(0)_"^I X[""."" W !,""DO NOT USE DECIMAL VALUES."",$C(7) K X Q"
"RTN","GMRASIG1",68,0)
 S DIR("A")="Select the Correct data "
"RTN","GMRASIG1",69,0)
 S DIR("?")="^D PRINT^GMRASIG1"
"RTN","GMRASIG1",70,0)
 D ^DIR K DIR
"RTN","GMRASIG1",71,0)
 I $D(DTOUT)!($D(DUOUT)) S Y=GMRANON_","
"RTN","GMRASIG1",72,0)
 I Y=(GMRALL_",") D ALLSNG^GMRASIGN ; User select all the reaction
"RTN","GMRASIG1",73,0)
 I Y=(GMRANON_",") S Y="" ; user select not of the reactions
"RTN","GMRASIG1",74,0)
 I $F(Y,","_GMRALL_",") W !,"INVALID SELECTION: You can only select ",GMRACNT+1,")  All by itself." G YNSO
"RTN","GMRASIG1",75,0)
 I $F(Y,","_GMRANON_",") W !,"INVALID SELECTION: You can only select ",GMRACNT+2,")  None by itself." G YNSO
"RTN","GMRASIG1",76,0)
 Q
"RTN","GMRAU851")
0^18^B16822989
"RTN","GMRAU851",1,0)
GMRAU851 ;HIRMFO/RFM,WAA-UTILITIES FOR FILE 120.85 ;12/22/04  11:02
"RTN","GMRAU851",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRAU851",3,0)
HLP ;
"RTN","GMRAU851",4,0)
 N DIR
"RTN","GMRAU851",5,0)
 I '$D(^GMR(120.8,"B",DFN)) W !?4,"There are no reactions on file for this patient." Q
"RTN","GMRAU851",6,0)
 D HLP12085(DFN,"$$OBSDRG^GMRAU85(GMRAX)")
"RTN","GMRAU851",7,0)
 Q
"RTN","GMRAU851",8,0)
HLP12085(DFN,SCR) ; THIS WILL LIST ENTRIES FOR PATIENT (DFN) IN FILE
"RTN","GMRAU851",9,0)
 ; 120.85.  AN OPTIONAL SCREEN (SCR), EXECUTABLE BOOLEAN FXN, WILL BE
"RTN","GMRAU851",10,0)
 ; USED TO SCREEN OUT ENTRIES, WHILE USING SCREEN, GMRAX WILL BE 120.8
"RTN","GMRAU851",11,0)
 ; IEN.  GMRAOUT WILL BE SET TRUE IF ^/TIME OUT.
"RTN","GMRAU851",12,0)
 N GMRAL,GMRAX,GMRAY
"RTN","GMRAU851",13,0)
 I $G(SCR)="" S SCR="SCR=SCR"
"RTN","GMRAU851",14,0)
 S GMRAX="" F  S GMRAX=$O(^GMR(120.8,"B",DFN,GMRAX)) Q:GMRAX'>0  S GMRAY=$P($G(^GMR(120.8,GMRAX,0)),U,2) I GMRAY]"",@SCR S GMRAL(GMRAY,GMRAX)=""
"RTN","GMRAU851",15,0)
 W #,!!,"CHOOSE FROM:" S GMRAY="" F  Q:GMRAOUT  S GMRAY=$O(GMRAL(GMRAY)) Q:GMRAY=""  S GMRAX="" F  S GMRAX=$O(GMRAL(GMRAY,GMRAX)) Q:GMRAX'>0  D  Q:GMRAOUT
"RTN","GMRAU851",16,0)
 .   I $Y>(IOSL-3) D ENDPG^GMRADSP3 Q:GMRAOUT  W #
"RTN","GMRAU851",17,0)
 .   W !?3,GMRAY
"RTN","GMRAU851",18,0)
 .   Q
"RTN","GMRAU851",19,0)
 Q
"RTN","GMRAU851",20,0)
HLP1 ;
"RTN","GMRAU851",21,0)
 I '$D(^GMR(120.85,"C",GMRAPA)) W !?4,"There are no observed date/times on file for this reaction." Q
"RTN","GMRAU851",22,0)
 S X="??",DIC="^GMR(120.85,",DIC(0)="EQ",DIC("S")="I $P(^(0),U,2)=DFN,$P(^(0),U,15)=GMRAPA",DIC("W")="" D ^DIC K DIC
"RTN","GMRAU851",23,0)
 Q
"RTN","GMRAU851",24,0)
RXN ;ENTRY TO EDIT THE OBSERVED A/AR DATA
"RTN","GMRAU851",25,0)
 N GMRAR0 ;21
"RTN","GMRAU851",26,0)
 S GMRANDT=1
"RTN","GMRAU851",27,0)
 S GMRAPA=$P($G(^GMR(120.85,GMRAPA1,0)),U,15),GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAU851",28,0)
 S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAU851",29,0)
 F GMRAX=0:0 S GMRAX=$O(^GMR(120.85,GMRAPA1,2,GMRAX)) Q:GMRAX'>0  S Y=$S($D(^GMR(120.85,GMRAPA1,2,GMRAX,0)):^(0),1:""),X=$S(+Y=GMRAOTH:$P(Y,"^",2),$D(^GMRD(120.83,+Y,0)):$P(^(0),"^"),1:"") I X'="",Y'="" S GMRARPR(X,+Y)=X_"^"_$P(Y,"^",3)
"RTN","GMRAU851",30,0)
 D SITE^GMRAUTL
"RTN","GMRAU851",31,0)
 S GMRAY=GMRASITE
"RTN","GMRAU851",32,0)
 I GMRAY>0 F GMRAX=1:1:10 S X=$S($D(^GMRD(120.84,GMRAY,1,GMRAX,0)):$P(^(0),"^"),1:""),Y=$S($D(^GMRD(120.83,+X,0)):^(0),1:""),GMRAR10(GMRAX)=$S(X'=""!(Y'=""):X_"^"_Y,1:"")
"RTN","GMRAU851",33,0)
 D EN1^GMRAPER0 Q:GMRAOUT  S:'$D(^GMR(120.85,GMRAPA1,2,0)) ^(0)="^120.8502P^^" S:'$D(^GMR(120.8,GMRAPA,10,0)) ^(0)="^120.81P^^" ;21
"RTN","GMRAU851",34,0)
 F GMRAREC=0:0 S GMRAREC=$O(GMRARAD(GMRAREC)) Q:GMRAREC'>0  S GMRAR0=GMRAREC_"^^"_DUZ D ADREAC  ;21
"RTN","GMRAU851",35,0)
 S GMRAREC="" F GMRAX=0:0 S GMRAREC=$O(GMRAROT(GMRAREC)) Q:GMRAREC=""  S GMRAR0=GMRAOTH_"^"_GMRAREC_"^"_DUZ D ADREAC ;21
"RTN","GMRAU851",36,0)
 F GMRAREC=0:0 S GMRAREC=$O(GMRARDL(GMRAREC)) Q:GMRAREC'>0  D DELREAC ;21
"RTN","GMRAU851",37,0)
 S GMRAREC="" F GMRAX=0:0 S GMRAREC=$O(GMRAROTD(GMRAREC)) Q:GMRAREC=""  D DELREACO ;21
"RTN","GMRAU851",38,0)
 Q
"RTN","GMRAU851",39,0)
ADREAC ; ADD ENTRY TO SIGNS/SYMPTOMS MULTIPLE
"RTN","GMRAU851",40,0)
 S GMRAZN=$P(^GMR(120.85,GMRAPA1,2,0),"^",3,4),DA=$P(GMRAZN,"^")+1 F DA=DA:1 Q:'$D(^GMR(120.85,GMRAPA1,2,DA,0))
"RTN","GMRAU851",41,0)
 S ^GMR(120.85,GMRAPA1,2,DA,0)=GMRAR0 S DIK="^GMR(120.85,DA(1),2,",DA(1)=GMRAPA1 D IX1^DIK S $P(^GMR(120.85,GMRAPA1,2,0),"^",3,4)=DA_"^"_($P(GMRAZN,"^",2)+1)
"RTN","GMRAU851",42,0)
 S GMRAZN=$P(^GMR(120.8,GMRAPA,10,0),"^",3,4),DA=$P(GMRAZN,"^")+1 F DA=DA:1 Q:'$D(^GMR(120.8,GMRAPA,10,DA,0))  ;21
"RTN","GMRAU851",43,0)
 S ^GMR(120.8,GMRAPA,10,DA,0)=GMRAR0_"^"_DT S DIK="^GMR(120.8,DA(1),10,",DA(1)=GMRAPA D IX1^DIK S $P(^GMR(120.8,GMRAPA,10,0),"^",3,4)=DA_"^"_($P(GMRAZN,"^",2)+1) ;21
"RTN","GMRAU851",44,0)
 Q
"RTN","GMRAU851",45,0)
 ;
"RTN","GMRAU851",46,0)
DELREAC ;Delete reactions from 120.85 and 120.8 entire section added in patch 21
"RTN","GMRAU851",47,0)
 S DA(1)=GMRAPA1,DIK="^GMR(120.85,"_DA(1)_",2,"
"RTN","GMRAU851",48,0)
 F DA=0:0 S DA=$O(^GMR(120.85,DA(1),2,"B",GMRAREC,DA)) Q:DA'>0  D ^DIK
"RTN","GMRAU851",49,0)
 S DA(1)=GMRAPA,DIK="^GMR(120.8,"_DA(1)_",10,"
"RTN","GMRAU851",50,0)
 F DA=0:0 S DA=$O(^GMR(120.8,DA(1),10,"B",GMRAREC,DA)) Q:DA'>0  D ^DIK
"RTN","GMRAU851",51,0)
 Q
"RTN","GMRAU851",52,0)
 ;
"RTN","GMRAU851",53,0)
DELREACO ;Delete free text reactions, added in 21
"RTN","GMRAU851",54,0)
 S DA(1)=GMRAPA1,DIK="^GMR(120.85,"_DA(1)_",2,"
"RTN","GMRAU851",55,0)
 F DA=0:0 S DA=$O(^GMR(120.85,DA(1),2,"B",GMRAOTH,DA)) Q:DA'>0  I $D(^GMR(120.85,DA(1),2,DA,0)),$P(^(0),U,2)=GMRAREC D ^DIK
"RTN","GMRAU851",56,0)
 S DA(1)=GMRAPA,DIK="^GMR(120.8,"_DA(1)_",10,"
"RTN","GMRAU851",57,0)
 F DA=0:0 S DA=$O(^GMR(120.8,DA(1),10,"B",GMRAOTH,DA)) Q:DA'>0  I $D(^GMR(120.8,DA(1),10,DA,0)),$P(^(0),U,2)=GMRAREC D ^DIK
"RTN","GMRAU851",58,0)
 Q
"RTN","GMRAVAM0")
0^12^B26305565
"RTN","GMRAVAM0",1,0)
GMRAVAM0 ;HIRMFO/YMP,WAA,RM-DRIVER FOR VERIFIER ;7/30/04  14:42
"RTN","GMRAVAM0",2,0)
 ;;4.0;Adverse Reaction Tracking;**11,21**;Mar 29, 1996
"RTN","GMRAVAM0",3,0)
EN1 ; Entry for VERIFY PATIENT REACTION DATA option
"RTN","GMRAVAM0",4,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) G NOVER
"RTN","GMRAVAM0",5,0)
EN2 ;Select the type of Agent to verify
"RTN","GMRAVAM0",6,0)
 S (GMRAOUT,GMRADFN)=0
"RTN","GMRAVAM0",7,0)
 S DIR("A")="Would you like to verify a single patient's data"
"RTN","GMRAVAM0",8,0)
 S DIR(0)="Y",DIR("B")="NO" D ^DIR K DIR I $D(DIRUT) K DIRUT G EXIT
"RTN","GMRAVAM0",9,0)
 ;If yes above, D ^DIC on Patient file S GMRADFN=+Y
"RTN","GMRAVAM0",10,0)
 I Y D  G:GMRAOUT EXIT
"RTN","GMRAVAM0",11,0)
 .W ! S DIC="^DPT(",DIC(0)="AEQM" D ^DIC
"RTN","GMRAVAM0",12,0)
 .I +Y<1!($D(DUOUT))!($D(DTOUT)) K DIC,DUOUT,DTOUT S GMRAOUT=1 Q
"RTN","GMRAVAM0",13,0)
 .S GMRADFN=+Y
"RTN","GMRAVAM0",14,0)
 .K DIC
"RTN","GMRAVAM0",15,0)
 .Q
"RTN","GMRAVAM0",16,0)
 D FF
"RTN","GMRAVAM0",17,0)
 F I="Drug","Non-drug","Both" W !,?20,$E(I,1),?23,I
"RTN","GMRAVAM0",18,0)
 K DIR S DIR(0)="SOMBA^D:DRUG;N:NON-DRUG;B:BOTH"
"RTN","GMRAVAM0",19,0)
 S DIR("A")="Select type of AGENT to verify:(D/N/B): "
"RTN","GMRAVAM0",20,0)
 S DIR("?",1)="ENTER D FOR DRUG AGENTS, N FOR NON-DRUG AGENTS"
"RTN","GMRAVAM0",21,0)
 S DIR("?")="OR B FOR BOTH DRUG AND NON DRUG AGENTS."
"RTN","GMRAVAM0",22,0)
 D ^DIR K DIR  I "^^"[Y G EXIT
"RTN","GMRAVAM0",23,0)
 S GMRAFLAG=$S(Y="D":1,Y="N":0,1:2)
"RTN","GMRAVAM0",24,0)
 K Y
"RTN","GMRAVAM0",25,0)
 D FF
"RTN","GMRAVAM0",26,0)
 S GMRAOUT=0 K ^TMP("GMRAV",$J),^TMP("GMRA",$J)
"RTN","GMRAVAM0",27,0)
 I GMRADFN D VERPT
"RTN","GMRAVAM0",28,0)
 I 'GMRADFN F GMRADFN=0:0 S GMRADFN=$O(^GMR(120.8,"AVER",GMRADFN)) Q:GMRADFN'>0  D VERPT
"RTN","GMRAVAM0",29,0)
 I $O(^TMP("GMRAV",$J,""))="" W !,$C(7),"There isn't any ",$S(GMRAFLAG=1:"drug ",GMRAFLAG=0:"non-drug ",1:""),"allergy data to verify.",! G EN1
"RTN","GMRAVAM0",30,0)
 G DISPLAY
"RTN","GMRAVAM0",31,0)
 Q
"RTN","GMRAVAM0",32,0)
VERPT ; Loop through all Patient GMRADFN's data to be verified and save
"RTN","GMRAVAM0",33,0)
 ; in ^TMP("GMRAV",$J array.
"RTN","GMRAVAM0",34,0)
 F GMRALL=0:0 S GMRALL=$O(^GMR(120.8,"AVER",GMRADFN,GMRALL)) Q:GMRALL'>0  D ARRAY
"RTN","GMRAVAM0",35,0)
 Q
"RTN","GMRAVAM0",36,0)
ARRAY S GMRAG=$G(^GMR(120.8,GMRALL,0))
"RTN","GMRAVAM0",37,0)
 S %=$P(GMRAG,U,20),GMRADRUG=$S(%["D"&'(%["F"!(%["O")):1,%'["D":0,1:2)
"RTN","GMRAVAM0",38,0)
 I GMRAFLAG=2!(GMRADRUG=2)!(GMRAFLAG=GMRADRUG) S ^TMP("GMRAV",$J,$P(^DPT(GMRADFN,0),"^"),$P(GMRAG,"^",2),GMRALL)=GMRAG Q
"RTN","GMRAVAM0",39,0)
 Q
"RTN","GMRAVAM0",40,0)
DISPLAY ;
"RTN","GMRAVAM0",41,0)
 I GMRAOUT G EXIT
"RTN","GMRAVAM0",42,0)
 I $O(^TMP("GMRAV",$J,0))="" G EXIT
"RTN","GMRAVAM0",43,0)
 K GMRADIG D FF
"RTN","GMRAVAM0",44,0)
 W !,?66,"OBS/"
"RTN","GMRAVAM0",45,0)
 W !,?4,"PATIENT",?41,"ALLERGY",?66,"HIST",?71,"ADR",?75,"TYPE"
"RTN","GMRAVAM0",46,0)
 W !,?4,"-------",?41,"-------",?66,"----",?71,"---",?75,"----",!
"RTN","GMRAVAM0",47,0)
 S GMRANAME="",CX=0 F  S GMRANAME=$O(^TMP("GMRAV",$J,GMRANAME)) Q:GMRANAME=""!GMRAOUT  S GMRALLER="" D ALLERPR Q:CX<1  I GMRAOUT Q
"RTN","GMRAVAM0",48,0)
 G:GMRAOUT EXIT
"RTN","GMRAVAM0",49,0)
 G:$D(GMRADIG) SELL I GMRAOUT G EXIT
"RTN","GMRAVAM0",50,0)
SELECT D SEL G:GMRAOUT EXIT
"RTN","GMRAVAM0",51,0)
 I $D(GMRAY) G:GMRAY="" EXIT
"RTN","GMRAVAM0",52,0)
 I GMRAOUT G EXIT
"RTN","GMRAVAM0",53,0)
SELL F GMRAZ=1:1 S GMRANS=$P(GMRAY,",",GMRAZ) Q:GMRANS<1  Q:GMRAOUT!GMRAER  D SELT
"RTN","GMRAVAM0",54,0)
 K ^TMP("GMRA",$J)
"RTN","GMRAVAM0",55,0)
 G DISPLAY
"RTN","GMRAVAM0",56,0)
SELT ;SELECT THE REACTIONS
"RTN","GMRAVAM0",57,0)
 D FF
"RTN","GMRAVAM0",58,0)
 N GMRAY,GMRAZ
"RTN","GMRAVAM0",59,0)
 S GMRACHK=^TMP("GMRA",$J,GMRANS)
"RTN","GMRAVAM0",60,0)
 S DFN=$P(GMRACHK,"^",2) D 1^VADPT S GMRALOC=$P(VAIN(4),"^",2),GMRANAM=VADM(1),GMRASEX=VADM(5) D KVAR^VADPT K VA,VAROOT
"RTN","GMRAVAM0",61,0)
 S GMRADRUG=GMRAFLAG,GMRAOUT=0,GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0)),GMRAPA=+GMRACHK,GMRAPA(0)=$P(GMRACHK,"^",2,999),GMRAVEDT=0
"RTN","GMRAVAM0",62,0)
 Q:'$$LOCK^GMRAUTL(120.8,GMRAPA,1)
"RTN","GMRAVAM0",63,0)
 D SITE^GMRAUTL,EN1^GMRAPEV0 S GMRALL=GMRAPA,GMRADFN=$P(^GMR(120.8,GMRAPA,0),U) D ARRAY
"RTN","GMRAVAM0",64,0)
 I GMRAVER D EN1^GMRAPET0(GMRADFN,GMRAPA,"V",.GMRAOUT) I GMRAOUT S GMRAOUT=0
"RTN","GMRAVAM0",65,0)
 I $G(GMRAERR),$G(GMRAOUT) S GMRAOUT=0 ;21
"RTN","GMRAVAM0",66,0)
 I GMRAERR!GMRAVER S GMRANAME=$P($G(^DPT(+GMRAPA(0),0)),U),GMRALLER=$P(GMRAPA(0),U,2) K:GMRANAME]""&(GMRALLER]"") ^TMP("GMRAV",$J,GMRANAME,GMRALLER,GMRAPA)
"RTN","GMRAVAM0",67,0)
 D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAVAM0",68,0)
 Q
"RTN","GMRAVAM0",69,0)
ALLERPR ;
"RTN","GMRAVAM0",70,0)
 F  S GMRALLER=$O(^TMP("GMRAV",$J,GMRANAME,GMRALLER)) Q:GMRALLER=""!GMRAOUT!$D(GMRADIG)  F GMRAREC=0:0 S GMRAREC=$O(^TMP("GMRAV",$J,GMRANAME,GMRALLER,GMRAREC)) Q:GMRAREC'>0  D:$Y>(IOSL-5) SCREEN Q:GMRAOUT!$D(GMRADIG)  S CX=CX+1 D WRITE
"RTN","GMRAVAM0",71,0)
 Q
"RTN","GMRAVAM0",72,0)
WRITE S GMRAG=^TMP("GMRAV",$J,GMRANAME,GMRALLER,GMRAREC)
"RTN","GMRAVAM0",73,0)
 S DFN=$P(GMRAG,U) D 1^VADPT S GMRALOC=$P(VAIN(4),"^",2) D PID^VADPT6 S GMRASSN=VA("BID")
"RTN","GMRAVAM0",74,0)
 D KVAR^VADPT K VA,VAROOT
"RTN","GMRAVAM0",75,0)
 W !,$J(CX,2),".",?4,$E(GMRANAME,1,20)," (",GMRASSN,") ",$E(GMRALOC,1,8),?41,$E(GMRALLER,1,23),?66
"RTN","GMRAVAM0",76,0)
 W $S($P(GMRAG,"^",6)="o":"OBS",$P(GMRAG,"^",6)="h":"HIST",1:""),?71,$S($P(GMRAG,"^",14)="A":"NO",$P(GMRAG,"^",14)="P":"YES",1:"UNK")
"RTN","GMRAVAM0",77,0)
 W ?75 D  ;This code is to allow for more than one type.
"RTN","GMRAVAM0",78,0)
 .N X,GMRAY
"RTN","GMRAVAM0",79,0)
 .S GMRAY=$P(GMRAG,"^",20)
"RTN","GMRAVAM0",80,0)
 .F X=1:1:$L(GMRAY) W:X>1 !,?75 W $P("^FOOD^DRUG^OTHER","^",$F("FDO",$E(GMRAY,X)))
"RTN","GMRAVAM0",81,0)
 .Q
"RTN","GMRAVAM0",82,0)
 S ^TMP("GMRA",$J,CX)=GMRAREC_"^"_GMRAG
"RTN","GMRAVAM0",83,0)
 Q
"RTN","GMRAVAM0",84,0)
SCREEN W !,"TYPE '^' TO STOP OR"
"RTN","GMRAVAM0",85,0)
 Q:GMRAOUT  D SEL Q:GMRAOUT
"RTN","GMRAVAM0",86,0)
 I GMRAY="" D FF Q
"RTN","GMRAVAM0",87,0)
 I GMRAOUT Q
"RTN","GMRAVAM0",88,0)
 I GMRAER W !?4,$C(7),"ANSWER WITH A NUMBER BETWEEN 1 AND ",CX G SCREEN
"RTN","GMRAVAM0",89,0)
 S GMRADIG=1
"RTN","GMRAVAM0",90,0)
 Q
"RTN","GMRAVAM0",91,0)
SEL ;
"RTN","GMRAVAM0",92,0)
 Q:CX<1
"RTN","GMRAVAM0",93,0)
 K DIR S DIR(0)="LOA^1:"_CX,DIR("A")="Select a number between 1-"_CX_": "
"RTN","GMRAVAM0",94,0)
 S DIR(0)=DIR(0)_"^I X[""."" W !,""DO NOT USE DECIMAL VALUES."",$C(7) K X Q"
"RTN","GMRAVAM0",95,0)
 D ^DIR K DIR
"RTN","GMRAVAM0",96,0)
 S GMRAY=Y K Y
"RTN","GMRAVAM0",97,0)
 I "^^"[GMRAY S GMRAOUT=$L(GMRAY) Q
"RTN","GMRAVAM0",98,0)
 S GMRAER=0 F GMRAZ=1:1 S GMRAX=$P(GMRAY,",",GMRAZ) Q:GMRAX<1  D  Q:GMRAER
"RTN","GMRAVAM0",99,0)
 .I '$D(^TMP("GMRA",$J,GMRAX)) W !,"ERROR INVALID SELECTION" S GMRAER=1
"RTN","GMRAVAM0",100,0)
 .Q
"RTN","GMRAVAM0",101,0)
 K GMRAX,GMRAZ Q
"RTN","GMRAVAM0",102,0)
NOVER ;
"RTN","GMRAVAM0",103,0)
 W !!?5,$C(7),"You do not have the 'GMRA-ALLERGY VERIFY' Security Key."
"RTN","GMRAVAM0",104,0)
EXIT ;
"RTN","GMRAVAM0",105,0)
 K ^TMP("GMRAV",$J),^TMP("GMRA",$J)
"RTN","GMRAVAM0",106,0)
 D KILL^XUSCLEAN
"RTN","GMRAVAM0",107,0)
 Q
"RTN","GMRAVAM0",108,0)
FF ;
"RTN","GMRAVAM0",109,0)
 W #
"RTN","GMRAVAM0",110,0)
 Q
"RTN","GMRAY21")
0^5^B31428709
"RTN","GMRAY21",1,0)
GMRAY21 ;SLC/DAN Post-init for patch 21 ;12/23/04  12:17
"RTN","GMRAY21",2,0)
 ;;4.0;Adverse Reaction Tracking;**21**;Mar 29, 1996
"RTN","GMRAY21",3,0)
 ;
"RTN","GMRAY21",4,0)
 ;DBIA SECTION
"RTN","GMRAY21",5,0)
 ;10063 - %ZTLOAD
"RTN","GMRAY21",6,0)
 ;3744  - $$TESTPAT^VADPT
"RTN","GMRAY21",7,0)
 ;10013 - DIK
"RTN","GMRAY21",8,0)
 ;10103 - XLFDT
"RTN","GMRAY21",9,0)
 ;10070 - XMD
"RTN","GMRAY21",10,0)
 ;10141 - XPDUTL
"RTN","GMRAY21",11,0)
 ;
"RTN","GMRAY21",12,0)
PRE ;Pre-install converts IODINE to allergy type of drug
"RTN","GMRAY21",13,0)
 N DIE,DA,DR
"RTN","GMRAY21",14,0)
 S DIE="^GMRD(120.82,",DA=$O(^GMRD(120.82,"B","IODINE",0)),DR="1////D"
"RTN","GMRAY21",15,0)
 I DA D ^DIE
"RTN","GMRAY21",16,0)
 Q
"RTN","GMRAY21",17,0)
 ;
"RTN","GMRAY21",18,0)
Q ;Entry point to queue process during install
"RTN","GMRAY21",19,0)
 N ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSK
"RTN","GMRAY21",20,0)
 S ZTRTN="DQ^GMRAY21",ZTDESC="GMRA*4*21 POST INSTALL ROUTINE",ZTIO="",ZTDTH=$H
"RTN","GMRAY21",21,0)
 D ^%ZTLOAD I '$G(ZTSK) D BMES^XPDUTL("POST INSTALL NOT QUEUED - RUN DQ^GMRA21 AFTER INSTALL FINISHES") Q
"RTN","GMRAY21",22,0)
 D BMES^XPDUTL("Post-install queued as task # "_$G(ZTSK))
"RTN","GMRAY21",23,0)
 Q
"RTN","GMRAY21",24,0)
 ;
"RTN","GMRAY21",25,0)
DQ ;Dequeue
"RTN","GMRAY21",26,0)
 N PROB,GMRAIOD
"RTN","GMRAY21",27,0)
 D POST,IODINE,ADDB,MAIL
"RTN","GMRAY21",28,0)
 Q
"RTN","GMRAY21",29,0)
 ;
"RTN","GMRAY21",30,0)
POST ;Post-init entry point
"RTN","GMRAY21",31,0)
 N DA,GMRAI,GMRA0,LCV,DIK
"RTN","GMRAY21",32,0)
 ;Check assessment level in 120.86 and make sure it makes the patient's actual assessment level
"RTN","GMRAY21",33,0)
 S GMRAI=0 F  S GMRAI=$O(^GMR(120.86,GMRAI)) Q:'+GMRAI  I $P(^(GMRAI,0),U,2),$$NKASCR^GMRANKA(GMRAI) S DIK="^GMR(120.86,",DA=GMRAI D ^DIK ;Delete assessment if patient doesn't have allergies and assessment is set to "has allergies"
"RTN","GMRAY21",34,0)
 ;Find entries in 120.8 that are missing the reactant or are missing additional required data and take appropriate action.
"RTN","GMRAY21",35,0)
 S GMRAI=0 F  S GMRAI=$O(^GMR(120.8,GMRAI)) Q:'+GMRAI  D
"RTN","GMRAY21",36,0)
 .S GMRA0=$G(^GMR(120.8,GMRAI,0))
"RTN","GMRAY21",37,0)
 .I GMRA0=""!($L(GMRA0,"^")=1)!($P(GMRA0,"^",2,3)="^") S DIK="^GMR(120.8,",DA=GMRAI D ^DIK Q  ;Delete entry if no zero node or only 1 piece on zero node or missing reactant data
"RTN","GMRAY21",38,0)
 .I $P(GMRA0,U,6)="o" D CHECKOBS
"RTN","GMRAY21",39,0)
 ;Check observed data to make sure it's matched to the right patient
"RTN","GMRAY21",40,0)
 S LCV=0 F  S LCV=$O(^GMR(120.85,LCV)) Q:'+LCV  D
"RTN","GMRAY21",41,0)
 .S GMRA0=$G(^GMR(120.85,LCV,0)) Q:GMRA0=""
"RTN","GMRAY21",42,0)
 .I $P(GMRA0,U,2)'=$P($G(^GMR(120.8,$P(GMRA0,U,15),0)),U) S DIK="^GMR(120.85,",DA=LCV D ^DIK
"RTN","GMRAY21",43,0)
 Q
"RTN","GMRAY21",44,0)
 ;
"RTN","GMRAY21",45,0)
 ;
"RTN","GMRAY21",46,0)
CHECKOBS ;Check observation data to make sure it's present and accurate
"RTN","GMRAY21",47,0)
 N J
"RTN","GMRAY21",48,0)
 Q:$D(^GMR(120.8,GMRAI,"ER"))!($$TESTPAT^VADPT($P(GMRA0,U)))!($$DECEASED^GMRAFX($P(GMRA0,U)))  ;Stop if allergy entered in error, test patient or deceased patient
"RTN","GMRAY21",49,0)
 I $P(GMRA0,U,12)=1 D
"RTN","GMRAY21",50,0)
 .I '$D(^GMR(120.85,"C",GMRAI)) S PROB($P(GMRA0,U),GMRAI)="OBS" Q  ;Marked as observed but no data
"RTN","GMRAY21",51,0)
 .S J=0 F  S J=$O(^GMR(120.85,"C",GMRAI,J)) Q:'+J  I '$O(^GMR(120.85,J,2,0)) S PROB($P(GMRA0,U),GMRAI)="SS" ;Has observed data but no sign/symptoms
"RTN","GMRAY21",52,0)
 Q
"RTN","GMRAY21",53,0)
 ;
"RTN","GMRAY21",54,0)
MAIL ;Send message indicating post install is finished
"RTN","GMRAY21",55,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,GMRATXT,DFN,PCNT,VADM,CNT,IEN
"RTN","GMRAY21",56,0)
 S XMDUZ="PATCH GMRA*4*21 POST-INSTALL",XMY(.5)="" S:$G(DUZ) XMY(DUZ)=""
"RTN","GMRAY21",57,0)
 S GMRATXT(1)="The post-install routine for patch GMRA*4*21"
"RTN","GMRAY21",58,0)
 S GMRATXT(2)="finished on "_$$FMTE^XLFDT($$NOW^XLFDT)_"."
"RTN","GMRAY21",59,0)
 S GMRATXT(3)=""
"RTN","GMRAY21",60,0)
 S CNT=3 I $D(PROB) D
"RTN","GMRAY21",61,0)
 .S CNT=CNT+1,GMRATXT(CNT)="The following patients have observed allergy entries that are"
"RTN","GMRAY21",62,0)
 .S CNT=CNT+1,GMRATXT(CNT)="signed off (accepted) but are missing required data.  Please review each"
"RTN","GMRAY21",63,0)
 .S CNT=CNT+1,GMRATXT(CNT)="entry and update (if data is known), mark it as entered in error,"
"RTN","GMRAY21",64,0)
 .S CNT=CNT+1,GMRATXT(CNT)="or leave it alone."
"RTN","GMRAY21",65,0)
 .S CNT=CNT+1,GMRATXT(CNT)=""
"RTN","GMRAY21",66,0)
 .S PCNT=0
"RTN","GMRAY21",67,0)
 .F  S PCNT=$O(PROB(PCNT)) Q:'+PCNT  D
"RTN","GMRAY21",68,0)
 ..S DFN=PCNT D DEM^VADPT
"RTN","GMRAY21",69,0)
 ..S IEN=0 F  S IEN=$O(PROB(PCNT,IEN)) Q:'+IEN  D
"RTN","GMRAY21",70,0)
 ...S CNT=CNT+1
"RTN","GMRAY21",71,0)
 ...S GMRATXT(CNT)=VADM(1)_"  "_VA("BID")_"  "_$P(^GMR(120.8,IEN,0),U,2)_" missing "_$S(PROB(PCNT,IEN)="OBS":"observation date",1:"sign/symptoms")
"RTN","GMRAY21",72,0)
 ..S CNT=CNT+1,GMRATXT(CNT)=""
"RTN","GMRAY21",73,0)
 I $D(GMRAIOD) D
"RTN","GMRAY21",74,0)
 .S CNT=CNT+1,GMRATXT(CNT)=$$REPEAT^XLFSTR("*",75),CNT=CNT+1,GMRATXT(CNT)=""
"RTN","GMRAY21",75,0)
 .S CNT=CNT+1,GMRATXT(CNT)="The following patients have had their IODINE allergies updated.",CNT=CNT+1,GMRATXT(CNT)="You should review them for accuracy.",CNT=CNT+1,GMRATXT(CNT)=""
"RTN","GMRAY21",76,0)
 .S DFN=0 F  S DFN=$O(GMRAIOD(DFN)) Q:'+DFN  K VADM D DEM^VADPT S CNT=CNT+1,GMRATXT(CNT)=VADM(1)_"  "_VA("BID")
"RTN","GMRAY21",77,0)
 S XMTEXT="GMRATXT(",XMSUB="PATCH GMRA*4*21 Post Install COMPLETED"
"RTN","GMRAY21",78,0)
 D ^XMD
"RTN","GMRAY21",79,0)
 Q
"RTN","GMRAY21",80,0)
 ;
"RTN","GMRAY21",81,0)
IODINE ;Find existing IODINE allergies and update them
"RTN","GMRAY21",82,0)
 N GMRAIODN,GMRAI,PAT,GMRAPA,GMRAAR
"RTN","GMRAY21",83,0)
 S GMRAIODN=$O(^GMRD(120.82,"B","IODINE",0)) Q:'+GMRAIODN  ;No IODINE entry
"RTN","GMRAY21",84,0)
 S (GMRAAR,GMRAIODN)=GMRAIODN_";GMRD(120.82,"
"RTN","GMRAY21",85,0)
 S GMRAI=0 F  S GMRAI=$O(^GMR(120.8,"C","IODINE",GMRAI)) Q:'+GMRAI  D
"RTN","GMRAY21",86,0)
 .S PAT=$P($G(^GMR(120.8,GMRAI,0)),U) Q:'+PAT  ;No patient
"RTN","GMRAY21",87,0)
 .Q:$P($G(^GMR(120.8,GMRAI,0)),U,3)'=GMRAIODN  ;Not the one we're looking for
"RTN","GMRAY21",88,0)
 .Q:$D(^GMR(120.8,GMRAI,"ER"))!($$DECEASED^GMRAFX(PAT))  ;Stop if entered in error or patient has expired
"RTN","GMRAY21",89,0)
 .S GMRAPA=GMRAI
"RTN","GMRAY21",90,0)
 .S DIE="^GMR(120.8,",DA=GMRAPA,DR="3.1////D" D ^DIE ;Update allergy type to drug
"RTN","GMRAY21",91,0)
 .D DELMUL^GMRAFX3(2),DELMUL^GMRAFX3(3) ;Delete any existing ingredients and drug classes for this allergy
"RTN","GMRAY21",92,0)
 .D UPDATE^GMRAPES1 ;add ingredients and drug classes from IODINE entry
"RTN","GMRAY21",93,0)
 .S GMRAIOD(PAT)=""
"RTN","GMRAY21",94,0)
 .Q
"RTN","GMRAY21",95,0)
 Q
"RTN","GMRAY21",96,0)
 ;
"RTN","GMRAY21",97,0)
ADDB ;Add B xref to reactions multiple in 120.85
"RTN","GMRAY21",98,0)
 N IEN,DA,DIK
"RTN","GMRAY21",99,0)
 S IEN=0 F  S IEN=$O(^GMR(120.85,IEN)) Q:'+IEN  I $D(^GMR(120.85,IEN,2)) D
"RTN","GMRAY21",100,0)
 .S $P(^GMR(120.85,IEN,2,0),U,2)="120.8502P"
"RTN","GMRAY21",101,0)
 .S DA(1)=IEN,DIK="^GMR(120.85,DA(1),2," D IXALL^DIK
"RTN","GMRAY21",102,0)
 Q
"VER")
8.0^22.0
"^DD",120.82,120.82,0)
FIELD^^5^6
"^DD",120.82,120.82,0,"DDA")
N
"^DD",120.82,120.82,0,"DT")
2941121
"^DD",120.82,120.82,0,"ID",1)
W ""
"^DD",120.82,120.82,0,"ID",2)
W "   ",@("$P($P($C(59)_$S($D(^DD(120.82,2,0)):$P(^(0),U,3),1:0)_$E("_DIC_"Y,0),0),$C(59)_$P(^(0),U,3)_"":"",2),$C(59),1)")
"^DD",120.82,120.82,0,"IX","B",120.82,.01)

"^DD",120.82,120.82,0,"IX","C",120.82,1)

"^DD",120.82,120.82,0,"IX","D",120.823,.01)

"^DD",120.82,120.82,0,"LOOK")
SOUNDEX
"^DD",120.82,120.82,0,"NM","GMR ALLERGIES")

"^DD",120.82,120.82,0,"PT",120.8,1)

"^DD",120.82,120.82,0,"QUES")
SOUNDEX
"^DD",120.82,120.82,0,"VRPK")
ADVERSE REACTION TRACKING
"^DD",120.82,120.82,.01,0)
NAME^RFX^^0;1^K:X[""""!($A(X)=45) X I $D(X) K:$L(X)>30!($L(X)<3)!'(X'?1P.E) X S:$D(X) X=$$UP^XLFSTR(X)
"^DD",120.82,120.82,.01,1,0)
^.1^^-1
"^DD",120.82,120.82,.01,1,1,0)
120.82^B
"^DD",120.82,120.82,.01,1,1,1)
S ^GMRD(120.82,"B",$E(X,1,30),DA)=""
"^DD",120.82,120.82,.01,1,1,2)
K ^GMRD(120.82,"B",$E(X,1,30),DA)
"^DD",120.82,120.82,.01,3)
Answer must be 3-30 characters in length.  It will automatically be converted to upper case.
"^DD",120.82,120.82,.01,21,0)
^.001^1^1^3030613^^^
"^DD",120.82,120.82,.01,21,1,0)
The name of the allergy/adverse reaction.
"^DD",120.82,120.82,.01,"DT")
3030626
"^DD",120.82,120.82,1,0)
ALLERGY TYPE^RFXO^^0;2^D INTTYPE^GMRAUTL(.X)
"^DD",120.82,120.82,1,1,0)
^.1
"^DD",120.82,120.82,1,1,1,0)
120.82^C
"^DD",120.82,120.82,1,1,1,1)
S ^GMRD(120.82,"C",$E(X,1,30),DA)=""
"^DD",120.82,120.82,1,1,1,2)
K ^GMRD(120.82,"C",$E(X,1,30),DA)
"^DD",120.82,120.82,1,2)
S Y(0)=Y S Y=$$OUTTYPE^GMRAUTL(Y)
"^DD",120.82,120.82,1,2.1)
S Y=$$OUTTYPE^GMRAUTL(Y)
"^DD",120.82,120.82,1,3)
Answer with type(s) of this reaction.  E.g., FOOD or DRUG, FOOD or F or DF.
"^DD",120.82,120.82,1,21,0)
^^5^5^2941121^
"^DD",120.82,120.82,1,21,1,0)
This field contains the type(s) for this allergy/adverse reaction .  The
"^DD",120.82,120.82,1,21,2,0)
user can enter the type(s) separated by commas, or the following codes:
"^DD",120.82,120.82,1,21,3,0)
D=Drug, F=Food, O=Other.  If codes are used, do not use commas to separate
"^DD",120.82,120.82,1,21,4,0)
multiple codes.  Examples of valid entries are:  DRUG or DRUG, FOOD or D
"^DD",120.82,120.82,1,21,5,0)
or DF or OTHER.
"^DD",120.82,120.82,1,"DT")
2941121
"^DD",120.82,120.82,2,0)
NATIONAL ALLERGY^SX^1:NATIONAL ALLERGY;^0;3^Q
"^DD",120.82,120.82,2,8.5)
^
"^DD",120.82,120.82,2,9)
^
"^DD",120.82,120.82,2,21,0)
^^2^2^2901108^^
"^DD",120.82,120.82,2,21,1,0)
Indicates whether this allergy was distributed with the national release
"^DD",120.82,120.82,2,21,2,0)
or is a locally added allergy.
"^DD",120.82,120.82,3,0)
SYNONYM^120.823^^3;0
"^DD",120.82,120.82,3,21,0)
^^1^1^2930824^^
"^DD",120.82,120.82,3,21,1,0)
A list of synonyms that can also be used to look up this allergy.
"^DD",120.82,120.82,4,0)
DRUG INGREDIENTS^120.824P^^ING;0
"^DD",120.82,120.82,4,21,0)
^^1^1^2921022^^^
"^DD",120.82,120.82,4,21,1,0)
List of drug ingredients that comprise this particular allergy.
"^DD",120.82,120.82,5,0)
VA DRUG CLASSES^120.8205P^^CLASS;0
"^DD",120.82,120.82,5,21,0)
^^1^1^2941117^
"^DD",120.82,120.82,5,21,1,0)
List of VA Drug classes that comprise this reactant.
"^DD",120.82,120.8205,0)
VA DRUG CLASSES SUB-FIELD^^.01^1
"^DD",120.82,120.8205,0,"DT")
2941117
"^DD",120.82,120.8205,0,"IX","B",120.8205,.01)

"^DD",120.82,120.8205,0,"NM","VA DRUG CLASSES")

"^DD",120.82,120.8205,0,"UP")
120.82
"^DD",120.82,120.8205,.01,0)
VA DRUG CLASSES^MP50.605'^PS(50.605,^0;1^Q
"^DD",120.82,120.8205,.01,1,0)
^.1
"^DD",120.82,120.8205,.01,1,1,0)
120.8205^B
"^DD",120.82,120.8205,.01,1,1,1)
S ^GMRD(120.82,DA(1),"CLASS","B",$E(X,1,30),DA)=""
"^DD",120.82,120.8205,.01,1,1,2)
K ^GMRD(120.82,DA(1),"CLASS","B",$E(X,1,30),DA)
"^DD",120.82,120.8205,.01,21,0)
^^1^1^2941117^
"^DD",120.82,120.8205,.01,21,1,0)
One of the VA Drug Classes that make up this reactant.
"^DD",120.82,120.8205,.01,"DT")
2941117
"^DD",120.82,120.823,0)
SYNONYM SUB-FIELD^^.01^1
"^DD",120.82,120.823,0,"IX","B",120.823,.01)

"^DD",120.82,120.823,0,"NM","SYNONYM")

"^DD",120.82,120.823,0,"UP")
120.82
"^DD",120.82,120.823,.01,0)
SYNONYM^MFX^^0;1^K:X[""""!($A(X)=45) X I $D(X) K:$L(X)>30!($L(X)<2) X S:$D(X) X=$$UP^XLFSTR(X)
"^DD",120.82,120.823,.01,1,0)
^.1
"^DD",120.82,120.823,.01,1,1,0)
120.823^B
"^DD",120.82,120.823,.01,1,1,1)
S ^GMRD(120.82,DA(1),3,"B",$E(X,1,30),DA)=""
"^DD",120.82,120.823,.01,1,1,2)
K ^GMRD(120.82,DA(1),3,"B",$E(X,1,30),DA)
"^DD",120.82,120.823,.01,1,2,0)
120.82^D
"^DD",120.82,120.823,.01,1,2,1)
S ^GMRD(120.82,"D",$E(X,1,30),DA(1),DA)=""
"^DD",120.82,120.823,.01,1,2,2)
K ^GMRD(120.82,"D",$E(X,1,30),DA(1),DA)
"^DD",120.82,120.823,.01,3)
Answer must be 2-30 characters in length.  It will automatically be converted to upper case.
"^DD",120.82,120.823,.01,21,0)
^^1^1^2930824^^^
"^DD",120.82,120.823,.01,21,1,0)
This is a synonym for a particular allergy.
"^DD",120.82,120.823,.01,"DT")
3030728
"^DD",120.82,120.824,0)
DRUG INGREDIENTS SUB-FIELD^^.01^1
"^DD",120.82,120.824,0,"IX","B",120.824,.01)

"^DD",120.82,120.824,0,"NM","DRUG INGREDIENTS")

"^DD",120.82,120.824,0,"UP")
120.82
"^DD",120.82,120.824,.01,0)
DRUG INGREDIENT^MP50.416'^PS(50.416,^0;1^Q
"^DD",120.82,120.824,.01,1,0)
^.1
"^DD",120.82,120.824,.01,1,1,0)
120.824^B
"^DD",120.82,120.824,.01,1,1,1)
S ^GMRD(120.82,DA(1),"ING","B",$E(X,1,30),DA)=""
"^DD",120.82,120.824,.01,1,1,2)
K ^GMRD(120.82,DA(1),"ING","B",$E(X,1,30),DA)
"^DD",120.82,120.824,.01,4)
D:DZ="?" EN^DDIOL("Enter one of the drug ingredients that make up this allergy.","","!?5")
"^DD",120.82,120.824,.01,21,0)
^^1^1^2930603^^
"^DD",120.82,120.824,.01,21,1,0)
This is one of the drug ingredients that make up this causative agent.
"^DIC",120.82,120.82,0)
GMR ALLERGIES^120.82I
"^DIC",120.82,120.82,0,"GL")
^GMRD(120.82,
"^DIC",120.82,120.82,"%D",0)
^^1^1^2930119^^^^
"^DIC",120.82,120.82,"%D",1,0)
Contains a listing of allergies from which user can select.
"^DIC",120.82,"B","GMR ALLERGIES",120.82)

**END**
**END**
