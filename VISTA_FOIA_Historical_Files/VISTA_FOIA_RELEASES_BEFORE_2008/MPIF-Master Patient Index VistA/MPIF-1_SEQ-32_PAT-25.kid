Released MPIF*1*25 SEQ #32
Extracted from mail message
**KIDS**:MPIF*1.0*25^

**INSTALL NAME**
MPIF*1.0*25
"BLD",1585,0)
MPIF*1.0*25^MASTER PATIENT INDEX VISTA^0^3040616^y
"BLD",1585,1,0)
^^3^3^3031114^
"BLD",1585,1,1,0)
FHIE AND ZPD SEGMENT ADDED FOR POW STATUS
"BLD",1585,1,2,0)
Refer to patch MPIF*1*25 in the FORUM Patch Module for a complete
"BLD",1585,1,3,0)
description.
"BLD",1585,4,0)
^9.64PA^^
"BLD",1585,"ABNS",0)
^9.66A^^
"BLD",1585,"ABPKG")
n^n^
"BLD",1585,"INID")
^y
"BLD",1585,"INIT")
MPIFP25
"BLD",1585,"KRN",0)
^9.67PA^8989.52^19
"BLD",1585,"KRN",.4,0)
.4
"BLD",1585,"KRN",.401,0)
.401
"BLD",1585,"KRN",.402,0)
.402
"BLD",1585,"KRN",.403,0)
.403
"BLD",1585,"KRN",.5,0)
.5
"BLD",1585,"KRN",.84,0)
.84
"BLD",1585,"KRN",3.6,0)
3.6
"BLD",1585,"KRN",3.8,0)
3.8
"BLD",1585,"KRN",9.2,0)
9.2
"BLD",1585,"KRN",9.8,0)
9.8
"BLD",1585,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",1585,"KRN",9.8,"NM",1,0)
MPIFA31B^^0^B6347929
"BLD",1585,"KRN",9.8,"NM",2,0)
MPIFA24^^0^B18332876
"BLD",1585,"KRN",9.8,"NM",3,0)
MPIFA24B^^0^B6739707
"BLD",1585,"KRN",9.8,"NM",4,0)
MPIFA28^^0^B4304244
"BLD",1585,"KRN",9.8,"NM",5,0)
MPIFDEL^^0^B23465100
"BLD",1585,"KRN",9.8,"NM","B","MPIFA24",2)

"BLD",1585,"KRN",9.8,"NM","B","MPIFA24B",3)

"BLD",1585,"KRN",9.8,"NM","B","MPIFA28",4)

"BLD",1585,"KRN",9.8,"NM","B","MPIFA31B",1)

"BLD",1585,"KRN",9.8,"NM","B","MPIFDEL",5)

"BLD",1585,"KRN",19,0)
19
"BLD",1585,"KRN",19.1,0)
19.1
"BLD",1585,"KRN",101,0)
101
"BLD",1585,"KRN",101,"NM",0)
^9.68A^^0
"BLD",1585,"KRN",409.61,0)
409.61
"BLD",1585,"KRN",771,0)
771
"BLD",1585,"KRN",870,0)
870
"BLD",1585,"KRN",8989.51,0)
8989.51
"BLD",1585,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",1585,"KRN",8989.52,0)
8989.52
"BLD",1585,"KRN",8994,0)
8994
"BLD",1585,"KRN","B",.4,.4)

"BLD",1585,"KRN","B",.401,.401)

"BLD",1585,"KRN","B",.402,.402)

"BLD",1585,"KRN","B",.403,.403)

"BLD",1585,"KRN","B",.5,.5)

"BLD",1585,"KRN","B",.84,.84)

"BLD",1585,"KRN","B",3.6,3.6)

"BLD",1585,"KRN","B",3.8,3.8)

"BLD",1585,"KRN","B",9.2,9.2)

"BLD",1585,"KRN","B",9.8,9.8)

"BLD",1585,"KRN","B",19,19)

"BLD",1585,"KRN","B",19.1,19.1)

"BLD",1585,"KRN","B",101,101)

"BLD",1585,"KRN","B",409.61,409.61)

"BLD",1585,"KRN","B",771,771)

"BLD",1585,"KRN","B",870,870)

"BLD",1585,"KRN","B",8989.51,8989.51)

"BLD",1585,"KRN","B",8989.52,8989.52)

"BLD",1585,"KRN","B",8994,8994)

"BLD",1585,"QUES",0)
^9.62^^
"BLD",1585,"REQB",0)
^9.611^4^3
"BLD",1585,"REQB",2,0)
MPIF*1.0*31^1
"BLD",1585,"REQB",3,0)
DG*5.3*545^1
"BLD",1585,"REQB",4,0)
MPIF*1.0*28^1
"BLD",1585,"REQB","B","DG*5.3*545",3)

"BLD",1585,"REQB","B","MPIF*1.0*28",4)

"BLD",1585,"REQB","B","MPIF*1.0*31",2)

"INIT")
MPIFP25
"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
25^3040616
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3040616
"PKG",282,22,1,"PAH",1,1,1,0)
FHIE AND ZPD SEGMENT ADDED FOR POW STATUS
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1*25 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","MPIFA24")
0^2^B18332876
"RTN","MPIFA24",1,0)
MPIFA24 ;BPOFO/CMC-A24 PROCESSING ROUTINE ;18 Mar 02
"RTN","MPIFA24",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,24,27,31,25**;30 Apr 99
"RTN","MPIFA24",3,0)
 ;
"RTN","MPIFA24",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA24",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA24",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA24",7,0)
 ;  ^DPT("AICN" - #2070
"RTN","MPIFA24",8,0)
 ;  DELETETF^VAFCTFU, FILE^VAFCTFU - #2988
"RTN","MPIFA24",9,0)
 ;
"RTN","MPIFA24",10,0)
 ;PROCESS A24 RESULTING FROM A28 ADD TO MPI MESSAGE OR FROM A40 MERGE
"RTN","MPIFA24",11,0)
A24 ;
"RTN","MPIFA24",12,0)
 N MPII,MPIJ,ARRY,SEG,CNT,ERR,SITE,MSG,DFN,IEN,LIST
"RTN","MPIFA24",13,0)
 S (CNT,ERR,FIRST)=1
"RTN","MPIFA24",14,0)
 F MPII=1:1 X HLNEXT Q:HLQUIT'>0  S MSG=HLNODE D
"RTN","MPIFA24",15,0)
 .S MPIJ=0 F  S MPIJ=$O(HLNODE(MPIJ)) Q:'MPIJ  S MSG(MPIJ)=HLNODE(MPIJ)
"RTN","MPIFA24",16,0)
 .S SEG=$E(HLNODE,1,3)
"RTN","MPIFA24",17,0)
 .I SEG="MSH" D MSH(.ARRY,.MSG) Q
"RTN","MPIFA24",18,0)
 .I SEG="EVN" D EVN(.ARRY,.MSG) Q
"RTN","MPIFA24",19,0)
 .I SEG="PID" D PID(.ARRY,.MSG,FIRST) S FIRST=2 Q
"RTN","MPIFA24",20,0)
 .I SEG="PD1" D PD1(.ARRY,.MSG) Q
"RTN","MPIFA24",21,0)
 ;
"RTN","MPIFA24",22,0)
 ;UPDATE 991.01, 991.02, 991.03
"RTN","MPIFA24",23,0)
 I $G(ARRY("ICN",2))'="" S DFN=$$GETDFN^MPIF001(ARRY("ICN",2))
"RTN","MPIFA24",24,0)
 I $G(ARRY("ICN",2))=""!(+$G(DFN)'>0) D
"RTN","MPIFA24",25,0)
 . I $G(ARRY("DFN",2))'="" S DFN=ARRY("DFN",2)
"RTN","MPIFA24",26,0)
 . I $G(ARRY("DFN",2))="" S DFN=ARRY("DFN",1)
"RTN","MPIFA24",27,0)
 S ARRY(991.03)=$$LKUP^XUAF4(ARRY(991.03))
"RTN","MPIFA24",28,0)
 I +$G(DFN)'>0 S ERR="-1^Unknown Identifier(s) ICN#"_$G(ARRY("ICN",2))_" and DFN#"_$G(ARRY("DFN",2))
"RTN","MPIFA24",29,0)
 I +$G(DFN)>0 S ERR=$$UPDATE^MPIFAPI(DFN,"ARRY",0) D
"RTN","MPIFA24",30,0)
 .;remove ALL Treating Facilities except your sites and add the CMOR
"RTN","MPIFA24",31,0)
 .D TFL^VAFCTFU1(.LIST,DFN) I $O(LIST(0)) D
"RTN","MPIFA24",32,0)
 .. N LOC,MPINODE,LOCIEN,CMOR,MPIFX,ERROR
"RTN","MPIFA24",33,0)
 .. S (CMOR,MPIFX)=0 F  S MPIFX=$O(LIST(MPIFX)) Q:'MPIFX  I $P(LIST(MPIFX),"^",5)="VAMC" D
"RTN","MPIFA24",34,0)
 ... ;get MPI node
"RTN","MPIFA24",35,0)
 ... S MPINODE=$$MPINODE^MPIFAPI(DFN),LOC=$P(LIST(MPIFX),"^"),LOCIEN=$$IEN^XUAF4(LOC)
"RTN","MPIFA24",36,0)
 ... I LOC=$P($$SITE^VASITE,"^",3) Q  ;do not delete own site
"RTN","MPIFA24",37,0)
 ... I LOCIEN=$P(MPINODE,"^",3) S CMOR=LOCIEN Q  ;do not delete CMOR site
"RTN","MPIFA24",38,0)
 ... S ERROR=$$DELETETF^VAFCTFU($P(MPINODE,"^",1),LOCIEN)
"RTN","MPIFA24",39,0)
 .. ;add CMOR site to TF list if it did not already exist
"RTN","MPIFA24",40,0)
 .. I CMOR'=0 D FILE^VAFCTFU(DFN,CMOR,1)
"RTN","MPIFA24",41,0)
 .; trigger A31 to MPI incase there have been edits since the ICN was created -- tasked off
"RTN","MPIFA24",42,0)
 .S ZTRTN="TA31^MPIFA31B",ZTDESC="A31 triggered from A24"
"RTN","MPIFA24",43,0)
 .S ZTSAVE("DFN")=DFN,ZTIO="",ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFA24",44,0)
 .D ^%ZTLOAD
"RTN","MPIFA24",45,0)
 .K ZTRTN,ZTDESC,ZTIO,ZTSAVE,ZTDTH,ZTREQ
"RTN","MPIFA24",46,0)
 ; PATCH 29
"RTN","MPIFA24",47,0)
 ;need to trigger msg to HDR?
"RTN","MPIFA24",48,0)
 ;I ARRY("ICN",2)=ARRY("ICN",1)!(ARRY("ICN",2)="") D
"RTN","MPIFA24",49,0)
 ;.; only send msg if new ICN, check if VDEFQM exits
"RTN","MPIFA24",50,0)
 ;.N X,HDR,HERR S X="VDEFQM" X ^%ZOSF("TEST")
"RTN","MPIFA24",51,0)
 ;.;call VDEF to establish HDR as an assoc system and add HDR to TF file
"RTN","MPIFA24",52,0)
 ;.I $T S HDR=$$QUEUE^VDEFQM("ADT^A28","IEN="_DFN,.HERR) N MPIFHDS S MPIFHDS=$$IEN^XUAF4("200HD") D FILE^VAFCTFU(DFN,MPIFHDS,1)
"RTN","MPIFA24",53,0)
 ;
"RTN","MPIFA24",54,0)
 S HLA("HLA",1)="MSA"_HL("FS")_"AA"_HL("FS")_HL("MID")_HL("FS")_$S(+$G(ERR)'>0:$P(ERR,"^",2),1:"")
"RTN","MPIFA24",55,0)
 S $P(HLA("HLA",1),HL("FS"),7)="ICN="_ARRY("ICN",1)
"RTN","MPIFA24",56,0)
 D LINK^HLUTIL3(ARRY("SITE"),.LINK) S IEN=$O(LINK(0)),HLL("LINKS",1)="^"_LINK(IEN)
"RTN","MPIFA24",57,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.MPIFRSLT,"",.HL)
"RTN","MPIFA24",58,0)
 K LINK,MPIFRSLT
"RTN","MPIFA24",59,0)
 ;PATCH 25
"RTN","MPIFA24",60,0)
 I ARRY("ICN",1)'=ARRY("ICN",2),ARRY("ICN",2)'="" D
"RTN","MPIFA24",61,0)
 .; ^ checking if this is a result of a "merge" of ICNs from the MPI
"RTN","MPIFA24",62,0)
 .; to trigger if this is station 200 the MERGE for the FHIE Framework
"RTN","MPIFA24",63,0)
 .Q:$P($$SITE^VASITE,"^",3)'=200
"RTN","MPIFA24",64,0)
 .N FHIE S FHIE=$$MERGE^OMGPIDMI(ARRY("ICN",2),ARRY("ICN",1))
"RTN","MPIFA24",65,0)
 .;               ^^ THIS API IS ONLY AVAILABLE ON THE FHIE HOST SYSTEM
"RTN","MPIFA24",66,0)
 .I +FHIE=-1 D START^RGHLLOG(),EXC^RGHLLOG(208,$P(FHIE,"^",2),DFN),STOP^RGHLLOG()
"RTN","MPIFA24",67,0)
 Q
"RTN","MPIFA24",68,0)
 ;
"RTN","MPIFA24",69,0)
MSH(ARY,MSG) ;processing MSH fields
"RTN","MPIFA24",70,0)
 N COMP
"RTN","MPIFA24",71,0)
 S COMP=$E(HL("ECH"),1)
"RTN","MPIFA24",72,0)
 S ARY("SITE")=$$LKUP^XUAF4($P($P(MSG,HL("FS"),4),COMP))
"RTN","MPIFA24",73,0)
 Q
"RTN","MPIFA24",74,0)
 ;
"RTN","MPIFA24",75,0)
EVN(ARY,MSG) ;processing EVN fields
"RTN","MPIFA24",76,0)
 S ARY("EVTR")=$P(MSG,HL("FS"),2) ;not currently used
"RTN","MPIFA24",77,0)
 S ARY("DLT")=$$FMDATE^HLFNC($P(MSG,HL("FS"),3))
"RTN","MPIFA24",78,0)
 Q
"RTN","MPIFA24",79,0)
 ;
"RTN","MPIFA24",80,0)
PID(ARY,MSG,FIRST) ;processing PID fields
"RTN","MPIFA24",81,0)
 N REP,PID,COMP,SUBCOMP,MPIDFN,MPISSN,ICN
"RTN","MPIFA24",82,0)
 S REP=$E(HL("ECH"),2),COMP=$E(HL("ECH"),1),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA24",83,0)
 S MPISSN="",MPIDFN=""
"RTN","MPIFA24",84,0)
 D PIDPROC^MPIFA43(.ICN,.MPISSN,.MPIDFN,.PID)
"RTN","MPIFA24",85,0)
 I FIRST=1 S ARY(991.01)=+ICN,ARY(991.02)=$P(ICN,"V",2)
"RTN","MPIFA24",86,0)
 S ARY("ICN",FIRST)=ICN
"RTN","MPIFA24",87,0)
 S ARY("SSN",FIRST)=MPISSN
"RTN","MPIFA24",88,0)
 S ARY("DFN",FIRST)=MPIDFN
"RTN","MPIFA24",89,0)
 Q
"RTN","MPIFA24",90,0)
 ;
"RTN","MPIFA24",91,0)
PD1(ARY,MSG) ;processing PD1 fields
"RTN","MPIFA24",92,0)
 N COMP
"RTN","MPIFA24",93,0)
 S COMP=$E(HL("ECH"),1)
"RTN","MPIFA24",94,0)
 S ARY(991.03)=$P($P(HLNODE,HL("FS"),4),COMP,3)
"RTN","MPIFA24",95,0)
 Q
"RTN","MPIFA24",96,0)
 ;
"RTN","MPIFA24",97,0)
PROC ;
"RTN","MPIFA24",98,0)
 N NXT,DFN
"RTN","MPIFA24",99,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA24",100,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA24",101,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA24",102,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA24",103,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA24",104,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA24",105,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA24",106,0)
 K ^XTMP("MPIFA24%"_DFN)
"RTN","MPIFA24",107,0)
 Q
"RTN","MPIFA24B")
0^3^B6739707
"RTN","MPIFA24B",1,0)
MPIFA24B ;BP/CMC-BUILD A24 ADD ME MSGS ;JULY 22, 2002
"RTN","MPIFA24B",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,28,31,25**;30 Apr 99
"RTN","MPIFA24B",3,0)
 ;
"RTN","MPIFA24B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA24B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA24B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA24B",7,0)
 ;
"RTN","MPIFA24B",8,0)
A24(DFN) ;BUILD AND SEND A24
"RTN","MPIFA24B",9,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID,PID2
"RTN","MPIFA24B",10,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA24B",11,0)
 S CNT=1
"RTN","MPIFA24B",12,0)
 D INIT^HLFNC2("MPIF ADT-A24 SERVER",.HL)
"RTN","MPIFA24B",13,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA24B",14,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA24B",15,0)
 S ERR="",TCNT=0
"RTN","MPIFA24B",16,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A24",.ERR)
"RTN","MPIFA24B",17,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",18,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR)
"RTN","MPIFA24B",19,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",20,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA24B",21,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",22,0)
 D BLDPID^VAFCQRY(DFN,2,"ALL",.PID2,.HL,.ERR)
"RTN","MPIFA24B",23,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",24,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA24B",25,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA24B",26,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA24B",27,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA24B",28,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA24B",29,0)
 S CNT=0 F  S CNT=$O(PID2(CNT)) Q:CNT=""  D
"RTN","MPIFA24B",30,0)
 .I CNT=1 S HLA("HLS",4)=PID2(CNT)
"RTN","MPIFA24B",31,0)
 .I CNT>1 S HLA("HLS",4,CNT-1)=PID2(CNT)
"RTN","MPIFA24B",32,0)
 S HLA("HLS",5)=$$EN1^VAFHLZPD(DFN,17) ;25
"RTN","MPIFA24B",33,0)
 K HLL("LINKS")
"RTN","MPIFA24B",34,0)
 D GENERATE^HLMA("MPIF ADT-A24 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA24B",35,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA24B",36,0)
 I '+RESLT S ^XTMP("MPIFA24%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A24 message to MPI for DFN "_DFN,^XTMP("MPIFA24%"_DFN,"MPI",0)="A"
"RTN","MPIFA24B",37,0)
 K HLA,HLEID,HLL("LINKS"),COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA24B",38,0)
 Q RESLT
"RTN","MPIFA24B",39,0)
 ;
"RTN","MPIFA24B",40,0)
RT ;
"RTN","MPIFA24B",41,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA24B",42,0)
 I $P($G(MPI),"^")=-1 D START^RGHLLOG(),EXC^RGHLLOG(224,"No logical link defined for the MPI",$G(DFN)),STOP^RGHLLOG() Q
"RTN","MPIFA24B",43,0)
 S HLL("LINKS",1)="MPIF ADT-A24 CLIENT^"_MPI
"RTN","MPIFA24B",44,0)
 Q
"RTN","MPIFA24B",45,0)
RES ;
"RTN","MPIFA24B",46,0)
 N NXT,DFN
"RTN","MPIFA24B",47,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA24B",48,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA24B",49,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA24B",50,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA24B",51,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA24B",52,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA24B",53,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA24B",54,0)
 K ^XTMP("MPIFA24%"_DFN)
"RTN","MPIFA24B",55,0)
 Q
"RTN","MPIFA28")
0^4^B4304244
"RTN","MPIFA28",1,0)
MPIFA28 ;BP/CMC-BUILD A28 ADD ME MSGS ;MARCH 4, 2002
"RTN","MPIFA28",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,31,25**;30 Apr 99
"RTN","MPIFA28",3,0)
 ;
"RTN","MPIFA28",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA28",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA28",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA28",7,0)
 ;
"RTN","MPIFA28",8,0)
A28(DFN) ;BUILD AND SEND A28
"RTN","MPIFA28",9,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID
"RTN","MPIFA28",10,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA28",11,0)
 S CNT=1
"RTN","MPIFA28",12,0)
 D INIT^HLFNC2("MPIF ADT-A28 SERVER",.HL)
"RTN","MPIFA28",13,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA28",14,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA28",15,0)
 S ERR="",TCNT=0
"RTN","MPIFA28",16,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A28",.ERR)
"RTN","MPIFA28",17,0)
 Q:ERR'="" ERR
"RTN","MPIFA28",18,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR)
"RTN","MPIFA28",19,0)
 Q:ERR'="" ERR
"RTN","MPIFA28",20,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA28",21,0)
 Q:ERR'="" ERR
"RTN","MPIFA28",22,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA28",23,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA28",24,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA28",25,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA28",26,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA28",27,0)
 S HLA("HLS",4)=$$EN1^VAFHLZPD(DFN,17) ;25
"RTN","MPIFA28",28,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA28",29,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA28",30,0)
 S HLL("LINKS",1)="MPIF ADT-A28 CLIENT^"_MPI
"RTN","MPIFA28",31,0)
 D GENERATE^HLMA("MPIF ADT-A28 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA28",32,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA28",33,0)
 I +RESLT S ^XTMP("MPIFA28%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A28 message to MPI for DFN "_DFN,^XTMP("MPIFA28%"_DFN,"MPI",0)="A"
"RTN","MPIFA28",34,0)
 K HLA,HLEID,HLL("LINKS"),COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA28",35,0)
 Q RESLT
"RTN","MPIFA28",36,0)
 ;
"RTN","MPIFA28",37,0)
RES ;
"RTN","MPIFA28",38,0)
 N NXT,DFN
"RTN","MPIFA28",39,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA28",40,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA28",41,0)
 K ^XTMP("MPIFA28%"_DFN)
"RTN","MPIFA28",42,0)
 Q
"RTN","MPIFA31B")
0^1^B6347929
"RTN","MPIFA31B",1,0)
MPIFA31B ;BP/CMC-BUILD A31 MSGS ;FEB 5, 2002
"RTN","MPIFA31B",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,24,27,28,31,25**;30 Apr 99
"RTN","MPIFA31B",3,0)
 ;
"RTN","MPIFA31B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA31B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA31B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA31B",7,0)
 ;
"RTN","MPIFA31B",8,0)
TA31 ; Tasked entry point
"RTN","MPIFA31B",9,0)
 N TMP
"RTN","MPIFA31B",10,0)
 S TMP=$$A31(DFN)
"RTN","MPIFA31B",11,0)
 Q
"RTN","MPIFA31B",12,0)
 ;
"RTN","MPIFA31B",13,0)
A31(DFN) ;BUILD AND SEND A31
"RTN","MPIFA31B",14,0)
 I $P($$SITE^VASITE,"^",3)=200 Q 1
"RTN","MPIFA31B",15,0)
 ; ^ PATCH 25 IF this is the FHIE Host system, don't build A31 messages
"RTN","MPIFA31B",16,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID
"RTN","MPIFA31B",17,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA31B",18,0)
 Q:$E($$GETICN^MPIF001(DFN),1,3)=$P($$SITE^VASITE(),"^",3) 0
"RTN","MPIFA31B",19,0)
 ; ^ LOCAL ICN DON'T SEND
"RTN","MPIFA31B",20,0)
 Q:+$$GETICN^MPIF001(DFN)=-1 0
"RTN","MPIFA31B",21,0)
 ; ^ NO ICN DON'T SEND
"RTN","MPIFA31B",22,0)
 S CNT=1
"RTN","MPIFA31B",23,0)
 D INIT^HLFNC2("MPIF ADT-A31 SERVER",.HL)
"RTN","MPIFA31B",24,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA31B",25,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA31B",26,0)
 S ERR="",TCNT=0
"RTN","MPIFA31B",27,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A31",.ERR)
"RTN","MPIFA31B",28,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",29,0)
 D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL,.ERR) ;**25
"RTN","MPIFA31B",30,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",31,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA31B",32,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",33,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA31B",34,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA31B",35,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA31B",36,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA31B",37,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA31B",38,0)
 S HLA("HLS",4)=$$EN1^VAFHLZPD(DFN,17) ;25
"RTN","MPIFA31B",39,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA31B",40,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA31B",41,0)
 S HLL("LINKS",1)="MPIF ADT-A31 CLIENT^"_MPI
"RTN","MPIFA31B",42,0)
 D GENERATE^HLMA("MPIF ADT-A31 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA31B",43,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA31B",44,0)
 S ^XTMP("MPIFA31%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"MPIA31 msg to MPI for DFN "_DFN
"RTN","MPIFA31B",45,0)
 I '+RESLT S ^XTMP("MPIFA31%"_DFN,"MPI",0)="A"
"RTN","MPIFA31B",46,0)
 K HLA,HLEID,HLL("LINKS"),COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA31B",47,0)
 Q RESLT
"RTN","MPIFA31B",48,0)
 ;
"RTN","MPIFA31B",49,0)
RES ;
"RTN","MPIFA31B",50,0)
 N NXT
"RTN","MPIFA31B",51,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA31B",52,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA31B",53,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA31B",54,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA31B",55,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA31B",56,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA31B",57,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA31B",58,0)
 K ^XTMP("MPIFA31%"_DFN)
"RTN","MPIFA31B",59,0)
 Q
"RTN","MPIFDEL")
0^5^B23465100
"RTN","MPIFDEL",1,0)
MPIFDEL ;SF/MJM,CMC-DELETE PATIENT FROM MPI ;JUL 14, 1998
"RTN","MPIFDEL",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,9,19,17,21,27,28,25**;30 Apr 99
"RTN","MPIFDEL",3,0)
 ;
"RTN","MPIFDEL",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFDEL",5,0)
 ; ^DPT(         - IA #2070
"RTN","MPIFDEL",6,0)
 ; $$EN^VAFCPID  - IA #3015
"RTN","MPIFDEL",7,0)
 ; START^RGHLLOG - IA #2796
"RTN","MPIFDEL",8,0)
 ; EXC^RGHLLOG   - IA #2796
"RTN","MPIFDEL",9,0)
 ; STOP^RGHLLOG  - IA #2796
"RTN","MPIFDEL",10,0)
 ; $$DELALLTF^VAFCTFU  - IA #2988
"RTN","MPIFDEL",11,0)
 ; $$EN^VAFCPID  - IA #3015
"RTN","MPIFDEL",12,0)
 ;
"RTN","MPIFDEL",13,0)
INTER ;
"RTN","MPIFDEL",14,0)
 ;Entry point for Inactivate Patient from MPI option [MPIF PAT INACT]
"RTN","MPIFDEL",15,0)
 ;No input or output variables ^DPT
"RTN","MPIFDEL",16,0)
 N DIC,DA,DFN,HL,ERROR,CNT,HLRST,ICN,DATE,MPIFCMOR,DTOUT,DUTOUT
"RTN","MPIFDEL",17,0)
 S ERROR=""
"RTN","MPIFDEL",18,0)
 S DIC=2,DIC(0)="QEAM" D ^DIC Q:+Y<0  S DFN=+Y
"RTN","MPIFDEL",19,0)
 S ICN=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFDEL",20,0)
 I ICN=""!(ICN=-1) W !,"** Patient Does NOT have an ICN **" Q
"RTN","MPIFDEL",21,0)
 S MPIFCMOR=+$$LKUP^XUAF4(+$$GETVCCI^MPIF001(DFN))
"RTN","MPIFDEL",22,0)
 I MPIFCMOR=0 W !,"*** Could NOT Inactivate Patient from MPI: Coordinating Master of Record is Not Defined ***" Q
"RTN","MPIFDEL",23,0)
 I $$PAT^MPIFNQ(DFN)'=+$P($$SITE^VASITE,"^",3) W !,"*** Could NOT Inactivate Patient from MPI: Coordinating Master of record site is '"_$$CMOR2^MPIF001(DFN)_"'. You MUST be the CMOR ***" Q
"RTN","MPIFDEL",24,0)
 S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFDEL",25,0)
 ;ask user if they are sure
"RTN","MPIFDEL",26,0)
 N DIR,Y S DIR(0)="Y",DIR("B")="No"
"RTN","MPIFDEL",27,0)
 S DIR("A")="Are you sure you want to Inactivate this Patient?"
"RTN","MPIFDEL",28,0)
 D ^DIR
"RTN","MPIFDEL",29,0)
 K DIR
"RTN","MPIFDEL",30,0)
 Q:$D(DTOUT)!($D(DUTOUT))!('Y)
"RTN","MPIFDEL",31,0)
 D HL7(DFN,.ERROR)
"RTN","MPIFDEL",32,0)
 I ERROR="" D DELETE(DFN) S ERROR=$$DELALLTF^VAFCTFU(+ICN),ERROR=""
"RTN","MPIFDEL",33,0)
 I ERROR=""!(ERROR=0) W !,"*** Inactivated on YOUR system, message sent to MPI to Inactivate ***"
"RTN","MPIFDEL",34,0)
 I ERROR'="" W !,"Error Occurred - "_ERROR
"RTN","MPIFDEL",35,0)
 Q
"RTN","MPIFDEL",36,0)
 ;
"RTN","MPIFDEL",37,0)
HL7(DFN,ERROR) ; create HL7 message
"RTN","MPIFDEL",38,0)
 ; check if no subscribers
"RTN","MPIFDEL",39,0)
 N SUB,HL,CNT,ICN,%,HLDATE,TFC,IEN
"RTN","MPIFDEL",40,0)
 K HLL,MPIFDEL
"RTN","MPIFDEL",41,0)
 S ICN=$$GETICN^MPIF001(DFN),ERROR=""
"RTN","MPIFDEL",42,0)
 Q:$E(ICN,1,3)=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFDEL",43,0)
 ; ^ don't generate HL7 message if local ICN
"RTN","MPIFDEL",44,0)
 S SUB=$$QUERYTF^VAFCTFU1(+ICN,"MPIFDEL"),TFC=0
"RTN","MPIFDEL",45,0)
 I $D(MPIFDEL) D
"RTN","MPIFDEL",46,0)
 .S IEN="" F  S IEN=$O(MPIFDEL(IEN)) Q:IEN=""  I +$G(MPIFDEL(IEN))'=$P($$SITE^VASITE,"^") S TFC=TFC+1
"RTN","MPIFDEL",47,0)
 .I TFC'=0 S ERROR="Attempted to Inactivate an ICN and Patient is Shared.  Can't Inactivate patient DFN= "_DFN Q
"RTN","MPIFDEL",48,0)
 Q:ERROR'=""
"RTN","MPIFDEL",49,0)
 D NOW^%DTC S HLDATE=$$HLDATE^HLFNC(%,"DT")
"RTN","MPIFDEL",50,0)
 S HL=0,CNT=0
"RTN","MPIFDEL",51,0)
 D INIT^HLFNC2("MPIF A29 SERVER",.HL)
"RTN","MPIFDEL",52,0)
 I HL S ERROR="ERROR = "_HL_" During INIT^HLFNC2 for MPIF A29 Server for Patient DFN= "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",53,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A29"_HL("FS")_HLDATE_HL("FS")_HL("FS")_""_HL("FS")
"RTN","MPIFDEL",54,0)
 S CNT=CNT+1,HLA("HLS",CNT)=$$EN^VAFCPID(DFN,"2,3,5")
"RTN","MPIFDEL",55,0)
 ; message only goes to MPI Link
"RTN","MPIFDEL",56,0)
 D GENERATE^HLMA("MPIF A29 SERVER","LM",1,.HLRST,"",.HL)
"RTN","MPIFDEL",57,0)
 I 'HLRST S ERROR="Error During Generate for MPIF A29 Server Error= "_HLRST_" for DFN "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",58,0)
 K MPIFDEL
"RTN","MPIFDEL",59,0)
 Q
"RTN","MPIFDEL",60,0)
 ;
"RTN","MPIFDEL",61,0)
PAT1 ;entry point for tasked job from .01 in Patient file for ZZ patients
"RTN","MPIFDEL",62,0)
 N ERR,TDA
"RTN","MPIFDEL",63,0)
 S ERR=""
"RTN","MPIFDEL",64,0)
 S TDA=DA
"RTN","MPIFDEL",65,0)
 L +^DPT("INAC",DA):2
"RTN","MPIFDEL",66,0)
 Q:'$T
"RTN","MPIFDEL",67,0)
 D PAT(DA,.ERR)
"RTN","MPIFDEL",68,0)
 S ZTREQ="@"
"RTN","MPIFDEL",69,0)
 L -^DPT("INAC",TDA)
"RTN","MPIFDEL",70,0)
 Q
"RTN","MPIFDEL",71,0)
 ;
"RTN","MPIFDEL",72,0)
PAT(DFN,ERROR) ;Programmer API to Delete MPI entry and remove ICN data from DPT
"RTN","MPIFDEL",73,0)
 ; if CMOR not defined but is a local CMOR, inactivate and don't log exception
"RTN","MPIFDEL",74,0)
 S ERROR=""
"RTN","MPIFDEL",75,0)
 I $G(DFN)="" S ERROR="DFN not defined" Q
"RTN","MPIFDEL",76,0)
 Q:+$$GETICN^MPIF001(DFN)<0  ; incase has been inactivated already
"RTN","MPIFDEL",77,0)
 I $E($P($$GETICN^MPIF001(DFN),"^"),1,3)'=+$P($$SITE^VASITE,"^",3),+$$PAT^MPIFNQ(DFN)'=+$P($$SITE^VASITE,"^",3) S ERROR="Attempt to Inactivate Patient, DFN= "_DFN_" this site is not the CMOR for this patient" D EXC(DFN,ERROR,226) Q
"RTN","MPIFDEL",78,0)
 D HL7(DFN,.ERROR)
"RTN","MPIFDEL",79,0)
 I ERROR="" S ERROR=$$DELALLTF^VAFCTFU(+$$GETICN^MPIF001(DFN)),ERROR="" D DELETE(DFN)
"RTN","MPIFDEL",80,0)
 Q
"RTN","MPIFDEL",81,0)
DELETE(DFN) ;
"RTN","MPIFDEL",82,0)
 N ARRAY,TMP
"RTN","MPIFDEL",83,0)
 S ARRAY(991.01)="@",ARRAY(991.02)="@",ARRAY(991.03)="@",ARRAY(991.04)="@",ARRAY(991.05)="@"
"RTN","MPIFDEL",84,0)
 S ARR="ARRAY"
"RTN","MPIFDEL",85,0)
 S TMP=$$UPDATE^MPIFAPI(DFN,ARR)
"RTN","MPIFDEL",86,0)
 K ARR
"RTN","MPIFDEL",87,0)
 Q
"RTN","MPIFDEL",88,0)
 ;
"RTN","MPIFDEL",89,0)
EXC(DFN,ERROR,TYPE) ; subscribers, log exception
"RTN","MPIFDEL",90,0)
 D START^RGHLLOG(0)
"RTN","MPIFDEL",91,0)
 D EXC^RGHLLOG(TYPE,ERROR,$G(DFN))
"RTN","MPIFDEL",92,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFDEL",93,0)
 Q
"RTN","MPIFDEL",94,0)
 ;
"RTN","MPIFDEL",95,0)
ZZSET(DA,NAME) ;this entry point checks to see if .01 of Patient file entry
"RTN","MPIFDEL",96,0)
 ;starts with at least two Zs
"RTN","MPIFDEL",97,0)
 ;if it does and an ICN is present, it will be inactivated
"RTN","MPIFDEL",98,0)
 ;
"RTN","MPIFDEL",99,0)
 Q
"RTN","MPIFDEL",100,0)
 Q:$E(NAME,1,2)'="ZZ"
"RTN","MPIFDEL",101,0)
 ;task inactivation off
"RTN","MPIFDEL",102,0)
 I +$$GETICN^MPIF001(DA)>0 D
"RTN","MPIFDEL",103,0)
 .S ZTRTN="PAT1^MPIFDEL",ZTDESC="Inactivate ICN for 'ZZ'd patient"
"RTN","MPIFDEL",104,0)
 .S ZTIO="",ZTSAVE("DA")=DA,ZTSAVE("NAME")=NAME
"RTN","MPIFDEL",105,0)
 .S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFDEL",106,0)
 .D ^%ZTLOAD
"RTN","MPIFDEL",107,0)
 .K ZTRTN,ZTDESC,ZTIO,ZTSAVE,ZTDTH,ZTREQ
"RTN","MPIFDEL",108,0)
 Q
"RTN","MPIFDEL",109,0)
ZZKILL(DA,NAME) ;This entry point checks if there is an ICN present, if so
"RTN","MPIFDEL",110,0)
 ;if will be inactivated, following the inactivate rules
"RTN","MPIFDEL",111,0)
 Q
"RTN","MPIFDEL",112,0)
 N ERR S ERR=""
"RTN","MPIFDEL",113,0)
 I +$$GETICN^MPIF001(DA)>0 D PAT(DA,.ERR)
"RTN","MPIFDEL",114,0)
 Q
"RTN","MPIFDEL",115,0)
SSET(DA,SSN) ; this entry point checks to see if the SSN has been changed
"RTN","MPIFDEL",116,0)
 ; to 5 leading zeros and if the ICN is present, if so, it will be
"RTN","MPIFDEL",117,0)
 ; inactivated.
"RTN","MPIFDEL",118,0)
 Q:$E(SSN,1,5)'="00000"
"RTN","MPIFDEL",119,0)
 I +$$GETICN^MPIF001(DA)>0 D
"RTN","MPIFDEL",120,0)
 .S ZTRTN="PAT1^MPIFDEL",ZTDESC="Inactivate ICN for 'ZZ'd patient"
"RTN","MPIFDEL",121,0)
 .S ZTIO="",ZTSAVE("DA")=DA,ZTSAVE("SSN")="SSN"
"RTN","MPIFDEL",122,0)
 .S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFDEL",123,0)
 .D ^%ZTLOAD
"RTN","MPIFDEL",124,0)
 .K ZTRTN,ZTDESC,ZTIO,ZTSAVE,ZTDTH,ZTREQ
"RTN","MPIFDEL",125,0)
 Q
"RTN","MPIFP25")
0^^B1232204
"RTN","MPIFP25",1,0)
MPIFP25 ;CMC/SF-MPI VISTA build post-init ;JAN 13, 2000
"RTN","MPIFP25",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**25**;30 Apr 99
"RTN","MPIFP25",3,0)
 ;
"RTN","MPIFP25",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFP25",5,0)
 ; ^DPT("SSN"  - #2070
"RTN","MPIFP25",6,0)
EN ;
"RTN","MPIFP25",7,0)
 D BMES^XPDUTL("Looking for patients with 5 leading zero SSNs and an ICN")
"RTN","MPIFP25",8,0)
 N SSN,CNT,DFN,STOP,ICN
"RTN","MPIFP25",9,0)
 S SSN="000000000",CNT=0,STOP=0
"RTN","MPIFP25",10,0)
 F  S SSN=$O(^DPT("SSN",SSN)) Q:STOP  D
"RTN","MPIFP25",11,0)
 .I $E(SSN,1,5)'="00000" S STOP=1 Q
"RTN","MPIFP25",12,0)
 .S DFN=$O(^DPT("SSN",SSN,"")),ICN=$$GETICN^MPIF001(DFN) I +ICN>0 D SSET^MPIFDEL(DFN,SSN) S CNT=CNT+1
"RTN","MPIFP25",13,0)
 ;
"RTN","MPIFP25",14,0)
 D BMES^XPDUTL("Found "_CNT_" patients -- all requested to be inactivated")
"RTN","MPIFP25",15,0)
 Q
"VER")
8.0^22.0
**END**
**END**
