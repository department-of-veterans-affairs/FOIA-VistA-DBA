EMERGENCY Released GMRC*3*31 SEQ #30
Extracted from mail message
**KIDS**:GMRC*3.0*31^

**INSTALL NAME**
GMRC*3.0*31
"BLD",4164,0)
GMRC*3.0*31^CONSULT/REQUEST TRACKING^0^3030205^y
"BLD",4164,1,0)
^^2^2^3030129^
"BLD",4164,1,1,0)
See the National Patch module for details of the changes included in this 
"BLD",4164,1,2,0)
patch.
"BLD",4164,4,0)
^9.64PA^^
"BLD",4164,"KRN",0)
^9.67PA^8989.52^19
"BLD",4164,"KRN",.4,0)
.4
"BLD",4164,"KRN",.401,0)
.401
"BLD",4164,"KRN",.402,0)
.402
"BLD",4164,"KRN",.403,0)
.403
"BLD",4164,"KRN",.5,0)
.5
"BLD",4164,"KRN",.84,0)
.84
"BLD",4164,"KRN",3.6,0)
3.6
"BLD",4164,"KRN",3.8,0)
3.8
"BLD",4164,"KRN",9.2,0)
9.2
"BLD",4164,"KRN",9.8,0)
9.8
"BLD",4164,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",4164,"KRN",9.8,"NM",1,0)
GMRCIEVT^^0^B56867552
"BLD",4164,"KRN",9.8,"NM",2,0)
GMRCIEV1^^0^B34221310
"BLD",4164,"KRN",9.8,"NM",3,0)
GMRCYP31^^0^B19729610
"BLD",4164,"KRN",9.8,"NM","B","GMRCIEV1",2)

"BLD",4164,"KRN",9.8,"NM","B","GMRCIEVT",1)

"BLD",4164,"KRN",9.8,"NM","B","GMRCYP31",3)

"BLD",4164,"KRN",19,0)
19
"BLD",4164,"KRN",19.1,0)
19.1
"BLD",4164,"KRN",101,0)
101
"BLD",4164,"KRN",409.61,0)
409.61
"BLD",4164,"KRN",771,0)
771
"BLD",4164,"KRN",870,0)
870
"BLD",4164,"KRN",8989.51,0)
8989.51
"BLD",4164,"KRN",8989.52,0)
8989.52
"BLD",4164,"KRN",8994,0)
8994
"BLD",4164,"KRN","B",.4,.4)

"BLD",4164,"KRN","B",.401,.401)

"BLD",4164,"KRN","B",.402,.402)

"BLD",4164,"KRN","B",.403,.403)

"BLD",4164,"KRN","B",.5,.5)

"BLD",4164,"KRN","B",.84,.84)

"BLD",4164,"KRN","B",3.6,3.6)

"BLD",4164,"KRN","B",3.8,3.8)

"BLD",4164,"KRN","B",9.2,9.2)

"BLD",4164,"KRN","B",9.8,9.8)

"BLD",4164,"KRN","B",19,19)

"BLD",4164,"KRN","B",19.1,19.1)

"BLD",4164,"KRN","B",101,101)

"BLD",4164,"KRN","B",409.61,409.61)

"BLD",4164,"KRN","B",771,771)

"BLD",4164,"KRN","B",870,870)

"BLD",4164,"KRN","B",8989.51,8989.51)

"BLD",4164,"KRN","B",8989.52,8989.52)

"BLD",4164,"KRN","B",8994,8994)

"BLD",4164,"QUES",0)
^9.62^^
"BLD",4164,"REQB",0)
^9.611^1^1
"BLD",4164,"REQB",1,0)
GMRC*3.0*28^2
"BLD",4164,"REQB","B","GMRC*3.0*28",1)

"MBREQ")
0
"PKG",128,-1)
1^1
"PKG",128,0)
CONSULT/REQUEST TRACKING^GMRC^13
"PKG",128,20,0)
^9.402P^^
"PKG",128,22,0)
^9.49I^1^1
"PKG",128,22,1,0)
3.0^2980101
"PKG",128,22,1,"PAH",1,0)
31^3030205
"PKG",128,22,1,"PAH",1,1,0)
^^2^2^3030205
"PKG",128,22,1,"PAH",1,1,1,0)
See the National Patch module for details of the changes included in this 
"PKG",128,22,1,"PAH",1,1,2,0)
patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","GMRCIEV1")
0^2^B34221310
"RTN","GMRCIEV1",1,0)
GMRCIEV1 ;SLC/JFR - IFC EVENTS CONT'D ;01/27/03 09:28
"RTN","GMRCIEV1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28,31**;DEC 27, 1997
"RTN","GMRCIEV1",3,0)
 Q  ;no-no-no
"RTN","GMRCIEV1",4,0)
RESUB(GMRCDA,GMRCACT) ;build HL7 msg with edits from resubit
"RTN","GMRCIEV1",5,0)
 ;Input:
"RTN","GMRCIEV1",6,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",7,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",8,0)
 ;
"RTN","GMRCIEV1",9,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEV1",10,0)
 S SEG=1
"RTN","GMRCIEV1",11,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEV1",12,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEV1",13,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEV1",14,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEV1",15,0)
 D  I $D(GMRCIQT) D NOMPI^GMRCIEVT(GMRCDA,GMRCACT) Q  ;build PID seg
"RTN","GMRCIEV1",16,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEV1",17,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",18,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEV1",19,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",20,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEV1",21,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",22,0)
 . Q
"RTN","GMRCIEV1",23,0)
 ;
"RTN","GMRCIEV1",24,0)
 ;build ORC seg based on GMRCACT
"RTN","GMRCIEV1",25,0)
 S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,"XO","IP",GMRCACT)
"RTN","GMRCIEV1",26,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",27,0)
 ;
"RTN","GMRCIEV1",28,0)
 ; include Inpatient or Outpatient
"RTN","GMRCIEV1",29,0)
 S ^TMP("HLS",$J,SEG)=$$OBR^GMRCISG1(GMRCDA,GMRCACT)
"RTN","GMRCIEV1",30,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",31,0)
 ;
"RTN","GMRCIEV1",32,0)
 D  ;load up reason for request
"RTN","GMRCIEV1",33,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEV1",34,0)
 . D OBXWP^GMRCISEG(GMRCDA,"XO",GMRCACT,$NA(^TMP("GMRCRFR",$J)))
"RTN","GMRCIEV1",35,0)
 . I '$D(^TMP("GMRCRFR",$J)) Q
"RTN","GMRCIEV1",36,0)
 . N I S I=0
"RTN","GMRCIEV1",37,0)
 . F  S I=$O(^TMP("GMRCRFR",$J,I)) Q:'I  D
"RTN","GMRCIEV1",38,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCRFR",$J,I)
"RTN","GMRCIEV1",39,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",40,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEV1",41,0)
 . Q
"RTN","GMRCIEV1",42,0)
 D  ;prov DX changed, send it
"RTN","GMRCIEV1",43,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXPD^GMRCISG1(GMRCDA)
"RTN","GMRCIEV1",44,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",45,0)
 ;
"RTN","GMRCIEV1",46,0)
 D  ;send ed-res comment and file as is
"RTN","GMRCIEV1",47,0)
 . N I
"RTN","GMRCIEV1",48,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",49,0)
 . D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEV1",50,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEV1",51,0)
 . S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEV1",52,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEV1",53,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",54,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",55,0)
 . Q
"RTN","GMRCIEV1",56,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEV1",57,0)
 S HLL("LINKS",1)=$$ROUTE^GMRCIEVT(GMRCDA) I '$L(HLL("LINKS",1)) D  Q
"RTN","GMRCIEV1",58,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,"",903) ;log error
"RTN","GMRCIEV1",59,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEV1",60,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEV1",61,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEV1",62,0)
 Q
"RTN","GMRCIEV1",63,0)
 ;
"RTN","GMRCIEV1",64,0)
SF(GMRCDA,GMRCACT) ;send SIG FINDING update
"RTN","GMRCIEV1",65,0)
 ;Input:
"RTN","GMRCIEV1",66,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",67,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",68,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT,GMRCOS
"RTN","GMRCIEV1",69,0)
 S SEG=1
"RTN","GMRCIEV1",70,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEV1",71,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEV1",72,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEV1",73,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEV1",74,0)
 D  I $D(GMRCIQT) D NOMPI^GMRCIEVT(GMRCDA,GMRCACT) Q  ;build PID seg
"RTN","GMRCIEV1",75,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEV1",76,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",77,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEV1",78,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",79,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEV1",80,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",81,0)
 . Q
"RTN","GMRCIEV1",82,0)
 ;
"RTN","GMRCIEV1",83,0)
 ;build ORC seg based on GMRCACT
"RTN","GMRCIEV1",84,0)
 S GMRCOS=$S($P(^GMR(123,GMRCDA,0),U,12)="2":"CM",1:"IP")
"RTN","GMRCIEV1",85,0)
 S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,"RE","CM",GMRCACT)
"RTN","GMRCIEV1",86,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",87,0)
 I $O(^GMR(123,GMRCDA,40,GMRCACT,1,0)) D  ;load up comment to send
"RTN","GMRCIEV1",88,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",89,0)
 . D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEV1",90,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEV1",91,0)
 . N I S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEV1",92,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEV1",93,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",94,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",95,0)
 . Q
"RTN","GMRCIEV1",96,0)
 S ^TMP("HLS",$J,SEG)=$$OBXSF^GMRCISEG(GMRCDA),SEG=SEG+1
"RTN","GMRCIEV1",97,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEV1",98,0)
 S HLL("LINKS",1)=$$ROUTE^GMRCIEVT(GMRCDA) I '$L(HLL("LINKS",1)) D  Q
"RTN","GMRCIEV1",99,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,"",903) ;log error
"RTN","GMRCIEV1",100,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEV1",101,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEV1",102,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEV1",103,0)
 Q
"RTN","GMRCIEV1",104,0)
 ;
"RTN","GMRCIEV1",105,0)
FWD(GMRCDA,GMRCACT) ;bld HL7 msg upon FWD action
"RTN","GMRCIEV1",106,0)
 ;Input:
"RTN","GMRCIEV1",107,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",108,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",109,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT,GMRCOS
"RTN","GMRCIEV1",110,0)
 S SEG=1
"RTN","GMRCIEV1",111,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEV1",112,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEV1",113,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEV1",114,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEV1",115,0)
 D  I $D(GMRCIQT) D NOMPI^GMRCIEVT(GMRCDA,GMRCACT) Q  ;build PID seg
"RTN","GMRCIEV1",116,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEV1",117,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",118,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEV1",119,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEV1",120,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEV1",121,0)
 . S SEG=SEG+1
"RTN","GMRCIEV1",122,0)
 . Q
"RTN","GMRCIEV1",123,0)
 ;
"RTN","GMRCIEV1",124,0)
 ;build ORC seg based on GMRCACT
"RTN","GMRCIEV1",125,0)
 S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,"XX","IP",GMRCACT)
"RTN","GMRCIEV1",126,0)
 S SEG=SEG+1
"RTN","GMRCIEV1",127,0)
 S ^TMP("HLS",$J,SEG)=$$OBR^GMRCISG1(GMRCDA,GMRCACT),SEG=SEG+1
"RTN","GMRCIEV1",128,0)
 I $O(^GMR(123,GMRCDA,40,GMRCACT,1,0)) D  ;load up comment to send
"RTN","GMRCIEV1",129,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",130,0)
 . D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEV1",131,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEV1",132,0)
 . N I S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEV1",133,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEV1",134,0)
 .. S SEG=SEG+1
"RTN","GMRCIEV1",135,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEV1",136,0)
 . Q
"RTN","GMRCIEV1",137,0)
 S ^TMP("HLS",$J,SEG)=$$OBXSF^GMRCISEG(GMRCDA),SEG=SEG+1
"RTN","GMRCIEV1",138,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEV1",139,0)
 S HLL("LINKS",1)=$$ROUTE^GMRCIEVT(GMRCDA) I '$L(HLL("LINKS",1)) D  Q
"RTN","GMRCIEV1",140,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,"",903) ;log error
"RTN","GMRCIEV1",141,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEV1",142,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEV1",143,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEV1",144,0)
 Q
"RTN","GMRCIEV1",145,0)
 ;
"RTN","GMRCIEV1",146,0)
FWD2IFC(GMRCDA,GMRCACT) ;pkg up and send request upon fwd'ing into IFC serv
"RTN","GMRCIEV1",147,0)
 ;Input:
"RTN","GMRCIEV1",148,0)
 ;  GMRCDA  = ien from file 123
"RTN","GMRCIEV1",149,0)
 ;  GMRCACT = ien of the activity from 40 multiple
"RTN","GMRCIEV1",150,0)
 N GMRCACTN
"RTN","GMRCIEV1",151,0)
 I '$P(^GMR(123,GMRCDA,0),U,22),'$D(^GMR(123.6,"C",GMRCDA)) D  Q
"RTN","GMRCIEV1",152,0)
 . D NW^GMRCIEVT(GMRCDA)
"RTN","GMRCIEV1",153,0)
 . S GMRCACTN=1
"RTN","GMRCIEV1",154,0)
 . F  S GMRCACTN=$O(^GMR(123,GMRCDA,40,GMRCACTN)) Q:'GMRCACTN  D
"RTN","GMRCIEV1",155,0)
 .. D TRIGR^GMRCIEVT(GMRCDA,GMRCACTN)
"RTN","GMRCIEV1",156,0)
 D FWD(GMRCDA,GMRCACT)
"RTN","GMRCIEV1",157,0)
 Q
"RTN","GMRCIEVT")
0^1^B56867552
"RTN","GMRCIEVT",1,0)
GMRCIEVT ;SLC/JFR - process events and build HL7 message; 1/27/03 09:23
"RTN","GMRCIEVT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**22,28,31**;DEC 27, 1997
"RTN","GMRCIEVT",3,0)
 ;
"RTN","GMRCIEVT",4,0)
 Q  ;don't start at the top
"RTN","GMRCIEVT",5,0)
TRIGR(IEN,ACTN) ;determine what action was taken on IFC and call event point
"RTN","GMRCIEVT",6,0)
 ;Input: 
"RTN","GMRCIEVT",7,0)
 ;  IEN   = consult number from file 123
"RTN","GMRCIEVT",8,0)
 ;  ACT   = ien in 40 multiple corresponding to activity
"RTN","GMRCIEVT",9,0)
 ;
"RTN","GMRCIEVT",10,0)
 N ACTYPE
"RTN","GMRCIEVT",11,0)
 S ACTYPE=$P(^GMR(123,IEN,40,ACTN,0),U,2)
"RTN","GMRCIEVT",12,0)
 I 'ACTYPE Q
"RTN","GMRCIEVT",13,0)
 I ACTYPE=26 Q  ;don't send admin corrections yet...
"RTN","GMRCIEVT",14,0)
 ;
"RTN","GMRCIEVT",15,0)
 ; check bkgrd job and run if overdue
"RTN","GMRCIEVT",16,0)
 I '$D(ZTQUEUED),$$GONOGO^GMRCIBKG D
"RTN","GMRCIEVT",17,0)
 . N ZTQUEUED S ZTQUEUED=1 D EN^GMRCIBKG ;remove ZTQUEUED? 
"RTN","GMRCIEVT",18,0)
 ;
"RTN","GMRCIEVT",19,0)
 I $O(^GMR(123.6,"AC",IEN,ACTN),-1) D  Q  ;earlier pending activities
"RTN","GMRCIEVT",20,0)
 . I ACTYPE=22 Q  ; not a trigger or not done here
"RTN","GMRCIEVT",21,0)
 . I ACTYPE=6 N GMRCQT D  I $D(GMRCQT) Q
"RTN","GMRCIEVT",22,0)
 .. ;complete all transactions if IFC DC'd before request ever sent 
"RTN","GMRCIEVT",23,0)
 .. I $O(^GMR(123.6,"AC",IEN,ACTN),-1)'=1 Q  ;new request already sent
"RTN","GMRCIEVT",24,0)
 .. S GMRCQT=1
"RTN","GMRCIEVT",25,0)
 .. N DA,DIE,DR,GMRCACTS
"RTN","GMRCIEVT",26,0)
 .. S GMRCACTS=0
"RTN","GMRCIEVT",27,0)
 .. F  S GMRCACTS=$O(^GMR(123.6,"AC",IEN,GMRCACTS)) Q:'GMRCACTS  D
"RTN","GMRCIEVT",28,0)
 ... S DIE="^GMR(123.6,",DA=$O(^GMR(123.6,"AC",IEN,GMRCACTS,1,0))
"RTN","GMRCIEVT",29,0)
 ... S DR=".06///@" D ^DIE
"RTN","GMRCIEVT",30,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",902) ;msg log entry but no msg sent
"RTN","GMRCIEVT",31,0)
 I ACTYPE=2!(ACTYPE=1) D NW(IEN) Q  ;send new order
"RTN","GMRCIEVT",32,0)
 I ACTYPE=9!(ACTYPE=14) D RSLT(IEN,ACTN) Q  ;inc report or add'l notes
"RTN","GMRCIEVT",33,0)
 I ACTYPE=10,$P(^GMR(123,IEN,40,ACTN,0),U,9) D RSLT(IEN,ACTN) Q  ;comp
"RTN","GMRCIEVT",34,0)
 I ACTYPE=12 D RSLT(IEN,ACTN) Q  ;dis-associate result
"RTN","GMRCIEVT",35,0)
 I ACTYPE=11 D RESUB^GMRCIEV1(IEN,ACTN) Q  ;ed/resubmit
"RTN","GMRCIEVT",36,0)
 I ACTYPE=13 D RSLT(IEN,ACTN) Q  ; addendum added
"RTN","GMRCIEVT",37,0)
 I ACTYPE=4 D SF^GMRCIEV1(IEN,ACTN) Q  ; sig finding update
"RTN","GMRCIEVT",38,0)
 I ACTYPE=22 Q  ;printed to is not a trigger
"RTN","GMRCIEVT",39,0)
 I ACTYPE=17 D FWD^GMRCIEV1(IEN,ACTN) Q  ; forward
"RTN","GMRCIEVT",40,0)
 I ACTYPE=25 D FWD2IFC^GMRCIEV1(IEN,ACTN) Q  ; FWD into an IFC service
"RTN","GMRCIEVT",41,0)
 D GENUPD(IEN,ACTN) ;all other updates
"RTN","GMRCIEVT",42,0)
 Q
"RTN","GMRCIEVT",43,0)
NW(GMRCDA) ;build new order message for IFC
"RTN","GMRCIEVT",44,0)
 ; Input:
"RTN","GMRCIEVT",45,0)
 ;   GMRCDA  = ien from file 123
"RTN","GMRCIEVT",46,0)
 ;
"RTN","GMRCIEVT",47,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",48,0)
 S SEG=1
"RTN","GMRCIEVT",49,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",50,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",51,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEVT",52,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEVT",53,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,1) Q  ;build PID seg if not a local ICN
"RTN","GMRCIEVT",54,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",55,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",56,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",57,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",58,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",59,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",60,0)
 . Q
"RTN","GMRCIEVT",61,0)
 S ^TMP("HLS",$J,SEG)=$$NWORC^GMRCISG1(GMRCDA) ; get ORC for new ord
"RTN","GMRCIEVT",62,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",63,0)
 S ^TMP("HLS",$J,SEG)=$$OBR^GMRCISG1(GMRCDA) ;get OBR segment
"RTN","GMRCIEVT",64,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",65,0)
 D  ;build reason for request into OBX segment(s)
"RTN","GMRCIEVT",66,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEVT",67,0)
 . D OBXWP^GMRCISEG(GMRCDA,"NW",1,$NA(^TMP("GMRCRFR",$J)))
"RTN","GMRCIEVT",68,0)
 . I '$D(^TMP("GMRCRFR",$J)) Q
"RTN","GMRCIEVT",69,0)
 . N I S I=0
"RTN","GMRCIEVT",70,0)
 . F  S I=$O(^TMP("GMRCRFR",$J,I)) Q:'I  D
"RTN","GMRCIEVT",71,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCRFR",$J,I)
"RTN","GMRCIEVT",72,0)
 .. S SEG=SEG+1
"RTN","GMRCIEVT",73,0)
 . K ^TMP("GMRCRFR",$J)
"RTN","GMRCIEVT",74,0)
 . Q
"RTN","GMRCIEVT",75,0)
 S ^TMP("HLS",$J,SEG)=$$OBXPD^GMRCISG1(GMRCDA) ; build prov DX in OBX
"RTN","GMRCIEVT",76,0)
 S SEG=SEG+1
"RTN","GMRCIEVT",77,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always send local time zone
"RTN","GMRCIEVT",78,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",79,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",80,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",81,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"")
"RTN","GMRCIEVT",82,0)
 D LOGMSG^GMRCIUTL(GMRCDA,1,+GMRC773,ERR)
"RTN","GMRCIEVT",83,0)
 Q
"RTN","GMRCIEVT",84,0)
 ;
"RTN","GMRCIEVT",85,0)
GENUPD(GMRCDA,GMRCACT) ;build msg and send upon REC, SC or ADD CMT event
"RTN","GMRCIEVT",86,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",87,0)
 S SEG=1
"RTN","GMRCIEVT",88,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",89,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",90,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEVT",91,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEVT",92,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,GMRCACT) Q  ;build PID seg if nat'l ICN
"RTN","GMRCIEVT",93,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",94,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",95,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",96,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",97,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",98,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",99,0)
 . Q
"RTN","GMRCIEVT",100,0)
 D  ;build ORC seg based on GMRCACT
"RTN","GMRCIEVT",101,0)
 . N ACTVT,OC,OS
"RTN","GMRCIEVT",102,0)
 . S ACTVT=$P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2) ; get activity
"RTN","GMRCIEVT",103,0)
 . ;set order control for ORC seg:
"RTN","GMRCIEVT",104,0)
 . ;   v-- IP=cmt RE=adm comp OD=DC OC=cancel SC=sch or receive
"RTN","GMRCIEVT",105,0)
 . S OC=$S(ACTVT=20:"IP",ACTVT=10:"RE",ACTVT=6:"OD",ACTVT=19:"OC",1:"SC")
"RTN","GMRCIEVT",106,0)
 . ;set order status for ORC seg:
"RTN","GMRCIEVT",107,0)
 . ;   v-- SC=sch RE=adm comp DC=DC CA=cancel IP=cmt or receive
"RTN","GMRCIEVT",108,0)
 . S OS=$S(ACTVT=8:"SC",ACTVT=10:"CM",ACTVT=6:"DC",ACTVT=19:"CA",1:"IP")
"RTN","GMRCIEVT",109,0)
 . S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,OC,OS,GMRCACT)
"RTN","GMRCIEVT",110,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",111,0)
 . Q
"RTN","GMRCIEVT",112,0)
 I $L($P(^GMR(123,GMRCDA,0),U,19)) D  ;send sig findings
"RTN","GMRCIEVT",113,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXSF^GMRCISEG(GMRCDA)
"RTN","GMRCIEVT",114,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",115,0)
 I $O(^GMR(123,GMRCDA,40,GMRCACT,1,0)) D  ;load up a comment if there
"RTN","GMRCIEVT",116,0)
 . N I
"RTN","GMRCIEVT",117,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEVT",118,0)
 . I $P(^TMP("HLS",$J,SEG-1),"|",2)'["O" D 
"RTN","GMRCIEVT",119,0)
 .. D OBXWP^GMRCISEG(GMRCDA,"",GMRCACT,$NA(^TMP("GMRCMT",$J)))
"RTN","GMRCIEVT",120,0)
 . I $P(^TMP("HLS",$J,SEG-1),"|",2)["O" D
"RTN","GMRCIEVT",121,0)
 .. N GMRCMT
"RTN","GMRCIEVT",122,0)
 .. D NTE^GMRCISEG(GMRCDA,GMRCACT,.GMRCMT)
"RTN","GMRCIEVT",123,0)
 .. I $D(GMRCMT) M ^TMP("GMRCMT",$J)=GMRCMT
"RTN","GMRCIEVT",124,0)
 . Q:'$O(^TMP("GMRCMT",$J,0))
"RTN","GMRCIEVT",125,0)
 . S I=0 F  S I=$O(^TMP("GMRCMT",$J,I)) Q:'I  D
"RTN","GMRCIEVT",126,0)
 .. S ^TMP("HLS",$J,SEG)=^TMP("GMRCMT",$J,I)
"RTN","GMRCIEVT",127,0)
 .. S SEG=SEG+1
"RTN","GMRCIEVT",128,0)
 . K ^TMP("GMRCMT",$J)
"RTN","GMRCIEVT",129,0)
 . Q
"RTN","GMRCIEVT",130,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEVT",131,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",132,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",133,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",134,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEVT",135,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEVT",136,0)
 Q
"RTN","GMRCIEVT",137,0)
 ;
"RTN","GMRCIEVT",138,0)
RSLT(GMRCDA,GMRCACT) ;attach or dis-associate results and update
"RTN","GMRCIEVT",139,0)
 N HL,HLL,SEG,GMRC773,GMRCIQT
"RTN","GMRCIEVT",140,0)
 S SEG=1
"RTN","GMRCIEVT",141,0)
 K ^TMP("HLS",$J)
"RTN","GMRCIEVT",142,0)
 D INIT^HLFNC2("GMRC IFC ORM EVENT",.HL)
"RTN","GMRCIEVT",143,0)
 I $G(HL) D  Q  ; if HL array can't be built, log it with an error
"RTN","GMRCIEVT",144,0)
 . D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,,904)
"RTN","GMRCIEVT",145,0)
 D  I $D(GMRCIQT) D NOMPI(GMRCDA,GMRCACT) Q  ;build PID seg if nat'l ICN
"RTN","GMRCIEVT",146,0)
 . N GMRCDFN S GMRCDFN=$P(^GMR(123,+GMRCDA,0),U,2)
"RTN","GMRCIEVT",147,0)
 . I '$G(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",148,0)
 . I $$GETICN^MPIF001(GMRCDFN)<1 S GMRCIQT=1 Q
"RTN","GMRCIEVT",149,0)
 . I $$IFLOCAL^MPIF001(GMRCDFN) S GMRCIQT=1 Q
"RTN","GMRCIEVT",150,0)
 . S ^TMP("HLS",$J,SEG)=$$EN^VAFCPID(GMRCDFN,"1,2,3,4,5,7,8,19")
"RTN","GMRCIEVT",151,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",152,0)
 . Q
"RTN","GMRCIEVT",153,0)
 D  ;build ORC seg based on GMRCACT
"RTN","GMRCIEVT",154,0)
 . N ACTVT,OC,OS
"RTN","GMRCIEVT",155,0)
 . S ACTVT=$P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2) ; get activity
"RTN","GMRCIEVT",156,0)
 . S OC="RE"
"RTN","GMRCIEVT",157,0)
 . S OS=$S(ACTVT=9:"A",ACTVT=12:"IP",1:"CM") ; A=part res CM=comp IP=dis
"RTN","GMRCIEVT",158,0)
 . S ^TMP("HLS",$J,SEG)=$$ORC^GMRCISEG(GMRCDA,OC,OS,GMRCACT)
"RTN","GMRCIEVT",159,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",160,0)
 I $P(^GMR(123,GMRCDA,40,GMRCACT,0),U,2)'=99 D
"RTN","GMRCIEVT",161,0)
 . S ^TMP("HLS",$J,SEG)=$$OBXRSLT^GMRCISEG(GMRCDA,GMRCACT)
"RTN","GMRCIEVT",162,0)
 . S SEG=SEG+1
"RTN","GMRCIEVT",163,0)
 S ^TMP("HLS",$J,SEG)=$$OBXTZ^GMRCISEG ;always include local time zone
"RTN","GMRCIEVT",164,0)
 S HLL("LINKS",1)=$$ROUTE(GMRCDA) I '$L(HLL("LINKS",1)) D  Q  ;log error
"RTN","GMRCIEVT",165,0)
 . D LOGMSG^GMRCIUTL(IEN,ACTN,"",903)
"RTN","GMRCIEVT",166,0)
 D GENERATE^HLMA("GMRC IFC ORM EVENT","GM",1,.GMRC773)
"RTN","GMRCIEVT",167,0)
 N ERR S ERR=$S($P(GMRC773,U,2):904,1:"") ; if err from HL7, log it
"RTN","GMRCIEVT",168,0)
 D LOGMSG^GMRCIUTL(GMRCDA,GMRCACT,+GMRC773,ERR)
"RTN","GMRCIEVT",169,0)
 Q
"RTN","GMRCIEVT",170,0)
 ;
"RTN","GMRCIEVT",171,0)
NOMPI(GMRCIEN,GMRCACTV) ;process MPI exception
"RTN","GMRCIEVT",172,0)
 N GMRCDFN
"RTN","GMRCIEVT",173,0)
 S GMRCDFN=$P(^GMR(123,GMRCIEN,0),U,2)
"RTN","GMRCIEVT",174,0)
 D PTMPIER^GMRCIERR(GMRCDFN) ; send msg to local group for ICN problem
"RTN","GMRCIEVT",175,0)
 D LOGMSG^GMRCIUTL(GMRCIEN,GMRCACTV,,202) ;put inc. entry in MSG log
"RTN","GMRCIEVT",176,0)
 Q
"RTN","GMRCIEVT",177,0)
 ;
"RTN","GMRCIEVT",178,0)
ROUTE(GMRCDA) ; determine correct routing for IFC msg
"RTN","GMRCIEVT",179,0)
 ; Input:
"RTN","GMRCIEVT",180,0)
 ;  GMRCDA = ien from file 123
"RTN","GMRCIEVT",181,0)
 ;
"RTN","GMRCIEVT",182,0)
 ; Output:
"RTN","GMRCIEVT",183,0)
 ;   the logical link to send the message to in format
"RTN","GMRCIEVT",184,0)
 ;     "GMRC IFC SUBSC^VHAHIN"
"RTN","GMRCIEVT",185,0)
 ;
"RTN","GMRCIEVT",186,0)
 N SITE,GMRCLINK,STA
"RTN","GMRCIEVT",187,0)
 S SITE=$P(^GMR(123,GMRCDA,0),U,23) I 'SITE Q "" ;no ROUTING FACILITY
"RTN","GMRCIEVT",188,0)
 S STA=$$STA^XUAF4(SITE)
"RTN","GMRCIEVT",189,0)
 I '$L(STA) Q "" ;can't find station num for that site
"RTN","GMRCIEVT",190,0)
 D LINK^HLUTIL3(STA,.GMRCLINK,"I")
"RTN","GMRCIEVT",191,0)
 S GMRCLINK=$O(GMRCLINK(0)) I 'GMRCLINK Q "" ; no link for that site
"RTN","GMRCIEVT",192,0)
 S GMRCLINK=GMRCLINK(GMRCLINK) I '$L(GMRCLINK) Q "" ;no link name
"RTN","GMRCIEVT",193,0)
 Q "GMRC IFC SUBSC^"_GMRCLINK
"RTN","GMRCYP31")
0^3^B19729610
"RTN","GMRCYP31",1,0)
GMRCYP31 ;SLC/JFR - POST-INIT FOR PATCH 31; 2/04/03 08:02
"RTN","GMRCYP31",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**31**;DEC 27, 1997
"RTN","GMRCYP31",3,0)
 Q
"RTN","GMRCYP31",4,0)
POST ;
"RTN","GMRCYP31",5,0)
 N %ZIS,GMRCQT,POP
"RTN","GMRCYP31",6,0)
 W !!,"This report should be sent to a printer",!
"RTN","GMRCYP31",7,0)
 S %ZIS="" D ^%ZIS
"RTN","GMRCYP31",8,0)
 I POP Q
"RTN","GMRCYP31",9,0)
 I $D(IO("Q")) D  Q
"RTN","GMRCYP31",10,0)
 . N ZTRTN,ZTDTH,ZTIO,ZTSAVE,ZTDESC
"RTN","GMRCYP31",11,0)
 . S ZTRTN="POST1^GMRCYP31",ZTIO=ION,ZTDTH=$H
"RTN","GMRCYP31",12,0)
 . S ZTDESC="GMRC*3*31 Post-Install Report"
"RTN","GMRCYP31",13,0)
 . D ^%ZTLOAD D HOME^%ZIS K IO("Q") Q
"RTN","GMRCYP31",14,0)
 . W !,"REPORT TASKED TO PRINT!"
"RTN","GMRCYP31",15,0)
 . Q
"RTN","GMRCYP31",16,0)
 D POST1
"RTN","GMRCYP31",17,0)
 Q
"RTN","GMRCYP31",18,0)
POST1 ; START POST-INIT
"RTN","GMRCYP31",19,0)
 N GMRCO,GMRCISIT,GMRCRO
"RTN","GMRCYP31",20,0)
 S GMRCISIT=0
"RTN","GMRCYP31",21,0)
 F  S GMRCISIT=$O(^GMR(123,"AIFC",GMRCISIT)) Q:'GMRCISIT  D
"RTN","GMRCYP31",22,0)
 . S GMRCRO=0
"RTN","GMRCYP31",23,0)
 . F  S GMRCRO=$O(^GMR(123,"AIFC",GMRCISIT,GMRCRO)) Q:'GMRCRO  D
"RTN","GMRCYP31",24,0)
 .. S GMRCO=$O(^GMR(123,"AIFC",GMRCISIT,GMRCRO,0))
"RTN","GMRCYP31",25,0)
 .. I $P($G(^GMR(123,GMRCO,12)),U,5)="P" D
"RTN","GMRCYP31",26,0)
 ... D ACTS(GMRCO)
"RTN","GMRCYP31",27,0)
 ... I $D(^TMP("GMRCYP31",$J,GMRCISIT,GMRCO)) D
"RTN","GMRCYP31",28,0)
 .... S ^TMP("GMRCYP31",$J,GMRCISIT,GMRCO)=""
"RTN","GMRCYP31",29,0)
 .. Q
"RTN","GMRCYP31",30,0)
 . Q
"RTN","GMRCYP31",31,0)
 D PRINT
"RTN","GMRCYP31",32,0)
 Q
"RTN","GMRCYP31",33,0)
 ;
"RTN","GMRCYP31",34,0)
ACTS(CSLT) ;loop activities and see if there is a remote FWD or SF update
"RTN","GMRCYP31",35,0)
 ;CSTL = ien from file 123
"RTN","GMRCYP31",36,0)
 N ACTV
"RTN","GMRCYP31",37,0)
 S ACTV=0
"RTN","GMRCYP31",38,0)
 F  S ACTV=$O(^GMR(123,CSLT,40,ACTV)) Q:'ACTV  D
"RTN","GMRCYP31",39,0)
 . N ACTYPE
"RTN","GMRCYP31",40,0)
 . S ACTYPE=$P(^GMR(123,CSLT,40,ACTV,0),U,2)
"RTN","GMRCYP31",41,0)
 . Q:ACTYPE'=17&(ACTYPE'=4)  ;only FWD and SF are affected
"RTN","GMRCYP31",42,0)
 . Q:'$D(^GMR(123,CSLT,40,ACTV,2))  ;only remote activities
"RTN","GMRCYP31",43,0)
 . Q:'$O(^GMR(123,CSLT,40,ACTV,1,1))  ;only comments >1 line long
"RTN","GMRCYP31",44,0)
 . N SITE
"RTN","GMRCYP31",45,0)
 . S SITE=$P(^GMR(123,CSLT,0),U,23)
"RTN","GMRCYP31",46,0)
 . S ^TMP("GMRCYP31",$J,SITE,CSLT,ACTV,0)=""
"RTN","GMRCYP31",47,0)
 Q
"RTN","GMRCYP31",48,0)
 ;
"RTN","GMRCYP31",49,0)
PRINT ; loop the ^TMP global and write records
"RTN","GMRCYP31",50,0)
 ; ask device and queue if needed
"RTN","GMRCYP31",51,0)
 ; 
"RTN","GMRCYP31",52,0)
 ;I $D(ZTQUEUED) S ZTREQ="@"
"RTN","GMRCYP31",53,0)
 N GMRCCT,TAB,GMRCDA,GMRCSIT,ACT,REMNUM,GMRCPG
"RTN","GMRCYP31",54,0)
 U IO
"RTN","GMRCYP31",55,0)
 S GMRCPG=1
"RTN","GMRCYP31",56,0)
 D HDR(.GMRCPG)
"RTN","GMRCYP31",57,0)
 I '$O(^TMP("GMRCYP31",$J,0)) D  D ^%ZISC,HOME^%ZIS Q
"RTN","GMRCYP31",58,0)
 . W !,"No records to report"
"RTN","GMRCYP31",59,0)
 . N DIR S DIR(0)="E" D ^DIR
"RTN","GMRCYP31",60,0)
 . Q
"RTN","GMRCYP31",61,0)
 S TAB=$$REPEAT^XLFSTR(" ",29)
"RTN","GMRCYP31",62,0)
 W !,"No cleanup or modification should be made to Inter-facility consults that are "
"RTN","GMRCYP31",63,0)
 W !,"identified with extraneous comments at this time.  Patch GMRC*3*32 will outline"
"RTN","GMRCYP31",64,0)
 W !,"the processes that should be utilized to properly accomplish these corrections."
"RTN","GMRCYP31",65,0)
 W !,$$REPEAT^XLFSTR("*",79)
"RTN","GMRCYP31",66,0)
 W !!
"RTN","GMRCYP31",67,0)
 S GMRCSIT=0
"RTN","GMRCYP31",68,0)
 F  S GMRCSIT=$O(^TMP("GMRCYP31",$J,GMRCSIT)) Q:'GMRCSIT  D
"RTN","GMRCYP31",69,0)
 . S GMRCDA=0
"RTN","GMRCYP31",70,0)
 . F  S GMRCDA=$O(^TMP("GMRCYP31",$J,GMRCSIT,GMRCDA)) Q:'GMRCDA  D
"RTN","GMRCYP31",71,0)
 .. I (IOSL-$Y)<7 D HDR(.GMRCPG) I 'GMRCPG S GMRCDA=999999999 Q
"RTN","GMRCYP31",72,0)
 .. N PTNM,PTSSN,REMSIT
"RTN","GMRCYP31",73,0)
 .. S PTNM="Patient name: "_$$GET1^DIQ(123,GMRCDA,.02,"E")
"RTN","GMRCYP31",74,0)
 .. S PTSSN="SSN: "_$$GET1^DIQ(2,$P(^GMR(123,GMRCDA,0),U,2),.09)
"RTN","GMRCYP31",75,0)
 .. S REMSIT=$$GET1^DIQ(4,$P(^GMR(123,GMRCDA,0),U,23),.01)
"RTN","GMRCYP31",76,0)
 .. S REMNUM=$P(^GMR(123,GMRCDA,0),U,22)
"RTN","GMRCYP31",77,0)
 .. I GMRCPG>2 W !,$$REPEAT^XLFSTR("*",78)
"RTN","GMRCYP31",78,0)
 .. W !,"Consult #: ",GMRCDA
"RTN","GMRCYP31",79,0)
 .. W !,PTNM,?50,PTSSN
"RTN","GMRCYP31",80,0)
 .. W !,"Receiving Site: ",REMSIT,?50,"Remote Consult #: ",REMNUM
"RTN","GMRCYP31",81,0)
 .. W !!,$$CJ^XLFSTR("Activities for Review",78)
"RTN","GMRCYP31",82,0)
 .. W !,$$CJ^XLFSTR("*********************",78)
"RTN","GMRCYP31",83,0)
 .. I (IOSL-$Y)<4 D HDR(.GMRCPG) I 'GMRCPG S GMRCDA=999999999 Q
"RTN","GMRCYP31",84,0)
 .. W !,"Facility"
"RTN","GMRCYP31",85,0)
 .. W !," Activity",?25,"Date/Time/Zone",$E(TAB,1,6)
"RTN","GMRCYP31",86,0)
 .. W "Responsible Person",$E(TAB,1,2),"Entered By"
"RTN","GMRCYP31",87,0)
 .. W !,$$REPEAT^XLFSTR("-",79)
"RTN","GMRCYP31",88,0)
 .. S ACT=0
"RTN","GMRCYP31",89,0)
 .. F  S ACT=$O(^TMP("GMRCYP31",$J,GMRCSIT,GMRCDA,ACT)) Q:'ACT  D
"RTN","GMRCYP31",90,0)
 ... N GMRCCT S GMRCCT=1
"RTN","GMRCYP31",91,0)
 ... I (IOSL-$Y)<6 D HDR(.GMRCPG,GMRCDA) I 'GMRCPG D  Q
"RTN","GMRCYP31",92,0)
 .... S (ACT,GMRCDA)=9999999999
"RTN","GMRCYP31",93,0)
 ... W !,?11,"Act. #:",ACT
"RTN","GMRCYP31",94,0)
 ... D BLDALN^GMRCSLM4(GMRCDA,ACT)
"RTN","GMRCYP31",95,0)
 ... N I S I=0
"RTN","GMRCYP31",96,0)
 ... F  S I=$O(^TMP("GMRCR",$J,"DT",I)) Q:'I  D
"RTN","GMRCYP31",97,0)
 .... I (IOSL-$Y)<5 D HDR(.GMRCPG,GMRCDA) I 'GMRCPG D  Q
"RTN","GMRCYP31",98,0)
 ..... S (I,ACT,GMRCDA)=9999999999
"RTN","GMRCYP31",99,0)
 .... W !,$G(^TMP("GMRCR",$J,"DT",I,0))
"RTN","GMRCYP31",100,0)
 ... K ^TMP("GMRCR",$J,"DT")
"RTN","GMRCYP31",101,0)
 .. W !
"RTN","GMRCYP31",102,0)
 .. Q
"RTN","GMRCYP31",103,0)
 . Q
"RTN","GMRCYP31",104,0)
 D ^%ZISC,HOME^%ZIS
"RTN","GMRCYP31",105,0)
 D EXIT
"RTN","GMRCYP31",106,0)
 Q
"RTN","GMRCYP31",107,0)
 ;
"RTN","GMRCYP31",108,0)
HDR(PAGE,CSLT) ;print a new header
"RTN","GMRCYP31",109,0)
 ; PAGE = next page number
"RTN","GMRCYP31",110,0)
 ; CSLT = consult ien working on
"RTN","GMRCYP31",111,0)
 ;
"RTN","GMRCYP31",112,0)
 I $E(IOST,1,2)="C-",PAGE>1 D  I 'PAGE Q
"RTN","GMRCYP31",113,0)
 . N DIR,DIROUT,DIRUT,DTOUT,DUOUT
"RTN","GMRCYP31",114,0)
 . S DIR(0)="E" D ^DIR
"RTN","GMRCYP31",115,0)
 . I $D(DIRUT) S PAGE=0
"RTN","GMRCYP31",116,0)
 W @IOF
"RTN","GMRCYP31",117,0)
 W !,"GMRC*3*31 Post-Install",?69,"Page: ",PAGE
"RTN","GMRCYP31",118,0)
 W !,$$REPEAT^XLFSTR("-",79)
"RTN","GMRCYP31",119,0)
 I $D(CSLT) D
"RTN","GMRCYP31",120,0)
 . N TEXT
"RTN","GMRCYP31",121,0)
 . S TEXT="Consult # "_CSLT_" cont'd."
"RTN","GMRCYP31",122,0)
 . W !,$$CJ^XLFSTR(TEXT,80)
"RTN","GMRCYP31",123,0)
 . W !
"RTN","GMRCYP31",124,0)
 S PAGE=PAGE+1
"RTN","GMRCYP31",125,0)
 Q
"RTN","GMRCYP31",126,0)
EXIT ; clean up
"RTN","GMRCYP31",127,0)
 K ^TMP("GMRCYP31",$J)
"RTN","GMRCYP31",128,0)
 Q
"VER")
8.0^22.0
**END**
**END**
