Released PSO*7*174 SEQ #181
Extracted from mail message
**KIDS**:PSO*7.0*174^

**INSTALL NAME**
PSO*7.0*174
"BLD",1029,0)
PSO*7.0*174^OUTPATIENT PHARMACY^0^3050518^y
"BLD",1029,1,0)
^^4^4^3050202^
"BLD",1029,1,1,0)
1. Partial deletion causing error. This patch fixes this problem.
"BLD",1029,1,2,0)
2. Methadone drug being the only drug released when the Nightly
"BLD",1029,1,3,0)
Management Data Compile Job is run causing error.
"BLD",1029,1,4,0)
This patch fixes this problem.
"BLD",1029,4,0)
^9.64PA^^
"BLD",1029,"ABPKG")
n
"BLD",1029,"KRN",0)
^9.67PA^8989.52^19
"BLD",1029,"KRN",.4,0)
.4
"BLD",1029,"KRN",.401,0)
.401
"BLD",1029,"KRN",.402,0)
.402
"BLD",1029,"KRN",.403,0)
.403
"BLD",1029,"KRN",.5,0)
.5
"BLD",1029,"KRN",.84,0)
.84
"BLD",1029,"KRN",3.6,0)
3.6
"BLD",1029,"KRN",3.8,0)
3.8
"BLD",1029,"KRN",9.2,0)
9.2
"BLD",1029,"KRN",9.8,0)
9.8
"BLD",1029,"KRN",9.8,"NM",0)
^9.68A^6^4
"BLD",1029,"KRN",9.8,"NM",3,0)
PSOMGCOM^^0^B21035171
"BLD",1029,"KRN",9.8,"NM",4,0)
PSORXPA1^^0^B25082444
"BLD",1029,"KRN",9.8,"NM",5,0)
PSOUTL^^0^B62525989
"BLD",1029,"KRN",9.8,"NM",6,0)
PSOSULBL^^0^B32674234
"BLD",1029,"KRN",9.8,"NM","B","PSOMGCOM",3)

"BLD",1029,"KRN",9.8,"NM","B","PSORXPA1",4)

"BLD",1029,"KRN",9.8,"NM","B","PSOSULBL",6)

"BLD",1029,"KRN",9.8,"NM","B","PSOUTL",5)

"BLD",1029,"KRN",19,0)
19
"BLD",1029,"KRN",19,"NM",0)
^9.68A^^
"BLD",1029,"KRN",19.1,0)
19.1
"BLD",1029,"KRN",101,0)
101
"BLD",1029,"KRN",409.61,0)
409.61
"BLD",1029,"KRN",771,0)
771
"BLD",1029,"KRN",870,0)
870
"BLD",1029,"KRN",8989.51,0)
8989.51
"BLD",1029,"KRN",8989.52,0)
8989.52
"BLD",1029,"KRN",8994,0)
8994
"BLD",1029,"KRN","B",.4,.4)

"BLD",1029,"KRN","B",.401,.401)

"BLD",1029,"KRN","B",.402,.402)

"BLD",1029,"KRN","B",.403,.403)

"BLD",1029,"KRN","B",.5,.5)

"BLD",1029,"KRN","B",.84,.84)

"BLD",1029,"KRN","B",3.6,3.6)

"BLD",1029,"KRN","B",3.8,3.8)

"BLD",1029,"KRN","B",9.2,9.2)

"BLD",1029,"KRN","B",9.8,9.8)

"BLD",1029,"KRN","B",19,19)

"BLD",1029,"KRN","B",19.1,19.1)

"BLD",1029,"KRN","B",101,101)

"BLD",1029,"KRN","B",409.61,409.61)

"BLD",1029,"KRN","B",771,771)

"BLD",1029,"KRN","B",870,870)

"BLD",1029,"KRN","B",8989.51,8989.51)

"BLD",1029,"KRN","B",8989.52,8989.52)

"BLD",1029,"KRN","B",8994,8994)

"BLD",1029,"QUES",0)
^9.62^^
"BLD",1029,"REQB",0)
^9.611^7^4
"BLD",1029,"REQB",4,0)
PSO*7.0*126^2
"BLD",1029,"REQB",5,0)
PSO*7.0*181^2
"BLD",1029,"REQB",6,0)
PSO*7.0*28^2
"BLD",1029,"REQB",7,0)
PSO*7.0*173^2
"BLD",1029,"REQB","B","PSO*7.0*126",4)

"BLD",1029,"REQB","B","PSO*7.0*173",7)

"BLD",1029,"REQB","B","PSO*7.0*181",5)

"BLD",1029,"REQB","B","PSO*7.0*28",6)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
7.0^3011218^2980805^5
"PKG",16,22,1,"PAH",1,0)
174^3050518
"PKG",16,22,1,"PAH",1,1,0)
^^4^4^3050518
"PKG",16,22,1,"PAH",1,1,1,0)
1. Partial deletion causing error. This patch fixes this problem.
"PKG",16,22,1,"PAH",1,1,2,0)
2. Methadone drug being the only drug released when the Nightly
"PKG",16,22,1,"PAH",1,1,3,0)
Management Data Compile Job is run causing error.
"PKG",16,22,1,"PAH",1,1,4,0)
This patch fixes this problem.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSOMGCOM")
0^3^B21035171
"RTN","PSOMGCOM",1,0)
PSOMGCOM ;BHAM ISC/JMB,SAB - management compile/recompile routine ;7/19/98
"RTN","PSOMGCOM",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,28,174**;DEC 1997
"RTN","PSOMGCOM",3,0)
 ;External Ref. to ELIG^VADPT is supp. by DBIA# 10061
"RTN","PSOMGCOM",4,0)
 ;External Ref. to ^PSDRUG( is supp. by DBIA# 221
"RTN","PSOMGCOM",5,0)
COM1 D:DA=0 ORI D:DA>0 REF Q:'$D(^PSRX(REC,1,DA,0))&(DA>0)  D STA
"RTN","PSOMGCOM",6,0)
 Q
"RTN","PSOMGCOM",7,0)
ORI Q:'$D(^PSRX(REC,0))  S RX0=^PSRX(REC,0),DV=$S($P($G(^PSRX(REC,2)),"^",9):$P(^PSRX(REC,2),"^",9),1:$O(^PS(59,0)))
"RTN","PSOMGCOM",8,0)
 S NEW(DV)=NEW(DV)+1 S:$P(RX0,"^",11)="W" WIND(DV)=WIND(DV)+1 S:$P(RX0,"^",11)="M" MAIL(DV)=MAIL(DV)+1 S DATE=$P(^PSRX(REC,0),"^",2)-.01
"RTN","PSOMGCOM",9,0)
 S COST=$P(RX0,"^",7)*$S(+$P(RX0,"^",17):$P(RX0,"^",17),1:+$P($G(^PSDRUG(+$P(RX0,"^",6),660)),"^",6))
"RTN","PSOMGCOM",10,0)
 D DAYS Q
"RTN","PSOMGCOM",11,0)
DAYS S TFIL=TFIL+1,TFCT=TFCT+COST,EQCOST(DV)=EQCOST(DV)+COST I DAYS<31 S QTY30(DV)=QTY30(DV)+1 Q
"RTN","PSOMGCOM",12,0)
 I DAYS>30&(DAYS<61) S QTY60(DV)=QTY60(DV)+1 Q
"RTN","PSOMGCOM",13,0)
 I DAYS>60&(DAYS<91) S QTY90(DV)=QTY90(DV)+1 Q
"RTN","PSOMGCOM",14,0)
 I DAYS>90&(DAYS<120) S QTY120(DV)=QTY120(DV)+1 Q
"RTN","PSOMGCOM",15,0)
 I DAYS>120&(DAYS<180) S QTY179(DV)=QTY179(DV)+1 Q
"RTN","PSOMGCOM",16,0)
 I DAYS=180 S QTY180(DV)=QTY180(DV)+1
"RTN","PSOMGCOM",17,0)
 Q
"RTN","PSOMGCOM",18,0)
REF Q:'$D(^PSRX(REC,1,DA,0))  S RXF=^PSRX(REC,1,DA,0),DV=$S($P(RXF,"^",9):$P(RXF,"^",9),1:$O(^PS(59,0))),REF(DV)=REF(DV)+1 S:$P(RXF,"^",2)="W" WIND(DV)=WIND(DV)+1 S:$P(RXF,"^",2)="M" MAIL(DV)=MAIL(DV)+1 S DATE=$P(^PSRX(REC,1,DA,0),"^")-.01
"RTN","PSOMGCOM",19,0)
 S COST=$P(RXF,"^",4)*$S($P(RXF,"^",11):$P(RXF,"^",11),1:+$P($G(^PSDRUG(+$P(^PSRX(REC,0),"^",6),660)),"^",6)) D DAYS
"RTN","PSOMGCOM",20,0)
 Q
"RTN","PSOMGCOM",21,0)
CLE F DV=0:0 S DV=$O(^PS(59,DV)) Q:'+DV  D
"RTN","PSOMGCOM",22,0)
 .S METHAD(DV)=$S($D(^PS(59,DV,5)):$P(^PS(59,DV,5),"^",2),1:0)
"RTN","PSOMGCOM",23,0)
 .S (CATA(DV),CATC(DV),OTH(DV),CAT(DV),CATCOST(DV),QTY30(DV),QTY60(DV),QTY90(DV),QTY120(DV),QTY179(DV),QTY180(DV),EQFL(DV),EQCOST(DV))=0
"RTN","PSOMGCOM",24,0)
 .S (METH(DV),METHCOST(DV),PCPP(DV),PP(DV),PPCOST(DV),PREQ(DV),FEE(DV),FCOST(DV),STAFF(DV),STCOST(DV),NEW(DV),REF(DV),WIND(DV),MAIL(DV),INV(DV))=0
"RTN","PSOMGCOM",25,0)
 S (TFIL,TFTY,TFCT)=0 Q
"RTN","PSOMGCOM",26,0)
STA S:$P($G(^PSDRUG(+$P(^PSRX(REC,0),"^",6),0)),"^",3)["I" INV(DV)=INV(DV)+1
"RTN","PSOMGCOM",27,0)
 I $D(METHAD(DV)),DRUG=METHAD(DV) S METH(DV)=METH(DV)+1,METHCOST(DV)=METHCOST(DV)+COST
"RTN","PSOMGCOM",28,0)
 E  K PCAT D CAT
"RTN","PSOMGCOM",29,0)
 I $P($G(^VA(200,+$G(PHYS),"PS")),"^",6)=4 S FEE(DV)=FEE(DV)+1,FCOST(DV)=FCOST(DV)+COST
"RTN","PSOMGCOM",30,0)
 E  S STAFF(DV)=STAFF(DV)+1,STCOST(DV)=STCOST(DV)+COST
"RTN","PSOMGCOM",31,0)
 I '$D(^TMP($J,DV,DFN)),$G(PCAT) S ^TMP($J,DV,DFN)=PCAT,PREQ(DV)=PREQ(DV)+1
"RTN","PSOMGCOM",32,0)
 Q
"RTN","PSOMGCOM",33,0)
CAT I '$D(^TMP($J,DV,DFN)) D ELIG^VADPT S PCAT=$P($G(VAEL(9)),"^"),CATCOST(DV)=CATCOST(DV)+COST S:PCAT="A" CATA(DV)=CATA(DV)+1 S:PCAT="C" CATC(DV)=CATC(DV)+1 S:PCAT'="A"&(PCAT'="C") OTH(DV)=OTH(DV)+1 Q
"RTN","PSOMGCOM",34,0)
 S PCAT=$G(^TMP($J,DV,DFN)),CATCOST(DV)=CATCOST(DV)+COST S:PCAT="A" CATA(DV)=CATA(DV)+1 S:PCAT="C" CATC(DV)=CATC(DV)+1 S:PCAT'="A"&(PCAT'="C") OTH(DV)=OTH(DV)+1 Q
"RTN","PSOMGCOM",35,0)
BUILD ;SET GLOBAL NODE
"RTN","PSOMGCOM",36,0)
 F DV=0:0 S DV=$O(^PS(59,DV)) Q:'+DV  D BLD
"RTN","PSOMGCOM",37,0)
 Q
"RTN","PSOMGCOM",38,0)
BLD S EQFL(DV)=QTY30(DV)+(QTY60(DV)*2)+(QTY90(DV)*3)+(QTY120(DV)*4)+(QTY179(DV)*5)+(QTY180(DV)*6)
"RTN","PSOMGCOM",39,0)
 S CAT(DV)=CATA(DV)+CATC(DV)+OTH(DV)
"RTN","PSOMGCOM",40,0)
 S RXPREQ(DV)=$FN($S(CAT(DV)=0!(PREQ(DV)=0):0,1:CAT(DV)/PREQ(DV)),"",1)
"RTN","PSOMGCOM",41,0)
 S EQPREQ(DV)=$FN($S(EQFL(DV)=0!(PREQ(DV)=0):0,1:EQFL(DV)/PREQ(DV)),"",0)
"RTN","PSOMGCOM",42,0)
 S NODE1=EQFL(DV)_"^"_METH(DV)_"^"_(NEW(DV)+REF(DV))_"^"_(EQFL(DV)+METH(DV))_"^"_PREQ(DV)_"^"_RXPREQ(DV)_"^"_EQPREQ(DV)_"^"_INV(DV)
"RTN","PSOMGCOM",43,0)
 S ^PS(59.12,PDATE,1,DV,0)=DV_"^"_CATA(DV)_"^"_CATC(DV)_"^"_OTH(DV)_"^"_CAT(DV)_"^"_QTY30(DV)_"^"_QTY60(DV)_"^"_QTY90(DV)_"^^"_NODE1
"RTN","PSOMGCOM",44,0)
 ;
"RTN","PSOMGCOM",45,0)
 S COSTPST(DV)=$FN($S(STCOST(DV)=0!(STAFF(DV)=0):0,1:STCOST(DV)/STAFF(DV)),"",2)
"RTN","PSOMGCOM",46,0)
 S ^PS(59.12,PDATE,2,DV,0)=DV_"^^"_FEE(DV)_"^"_STAFF(DV)_"^"_(FEE(DV)+STAFF(DV))_"^"_NEW(DV)_"^"_REF(DV)_"^"_(NEW(DV)+REF(DV))_"^"_WIND(DV)_"^"_MAIL(DV)_"^"_(WIND(DV)+MAIL(DV))_"^^"_PP(DV)_"^"_PCPP(DV)
"RTN","PSOMGCOM",47,0)
 ;
"RTN","PSOMGCOM",48,0)
 S AVGFEE(DV)=$FN($S(FCOST(DV)=0!(FEE(DV)=0):0,1:FCOST(DV)/FEE(DV)),"",2)
"RTN","PSOMGCOM",49,0)
 S AVGST(DV)=$FN($S(STCOST(DV)=0!(STAFF(DV)=0):0,1:STCOST(DV)/STAFF(DV)),"",2)
"RTN","PSOMGCOM",50,0)
 S AVGCAT(DV)=$FN($S(CATCOST(DV)=0!(CAT(DV)=0):0,1:CATCOST(DV)/CAT(DV)),"",2)
"RTN","PSOMGCOM",51,0)
 S AVGEQFL(DV)=$FN($S(EQCOST(DV)=0!(EQFL(DV)=0):0,1:(EQCOST(DV)-METHCOST(DV)/EQFL(DV))),"",2)
"RTN","PSOMGCOM",52,0)
 S AVGMETH(DV)=$FN($S(METHCOST(DV)=0!(METH(DV)=0):0,1:METHCOST(DV)/METH(DV)),"",2)
"RTN","PSOMGCOM",53,0)
 S ^PS(59.12,PDATE,3,DV,0)=DV_"^"_AVGST(DV)_"^"_AVGFEE(DV)_"^"_AVGCAT(DV)_"^"_AVGEQFL(DV)_"^"_AVGMETH(DV)_"^"_$FN((CATCOST(DV)+METHCOST(DV)),"",2)_"^"_$FN(METHCOST(DV),"",2)_"^0.00^0.00"
"RTN","PSOMGCOM",54,0)
 Q
"RTN","PSORXPA1")
0^4^B25082444
"RTN","PSORXPA1",1,0)
PSORXPA1 ;BIR/SAB - listman partial prescriptions ;07/14/93
"RTN","PSORXPA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,56,77,130,152,181,174**;DEC 1997
"RTN","PSORXPA1",3,0)
 ;External references L,UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORXPA1",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORXPA1",5,0)
 ;External reference to ^DD(52 supported by DBIA 999
"RTN","PSORXPA1",6,0)
 I $D(RXRP($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="A Reprint Label has been requested!" Q
"RTN","PSORXPA1",7,0)
 ;I $D(RXPR($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="A Partial has already been requested!" Q
"RTN","PSORXPA1",8,0)
 I $D(RXRS($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="Rx is being pulled from suspense!" Q
"RTN","PSORXPA1",9,0)
 S PSORPDFN=+$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^",2)
"RTN","PSORXPA1",10,0)
 S PSOPLCK=$$L^PSSLOCK(PSORPDFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK,PSORPDFN D  Q
"RTN","PSORXPA1",11,0)
 .S VALMBCK=""
"RTN","PSORXPA1",12,0)
 K PSOPLCK D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D UL^PSSLOCK(PSORPDFN) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG,PSORPDFN Q
"RTN","PSORXPA1",13,0)
 I '$G(RXPR($P(PSOLST(ORN),"^",2))) S RX=$P(PSOLST(ORN),"^",2) D VALID^PSORXRP1 I $G(QFLG) S VALMBCK="",VALMSG="A New Label has been requested already!" K QFLG,RX D ULK Q
"RTN","PSORXPA1",14,0)
 D FULL^VALM1 I '$D(PSOPAR) D ^PSOLSET D:'$D(PSOPAR) ULK G:'$D(PSOPAR) KL
"RTN","PSORXPA1",15,0)
 S DA=$P(PSOLST(ORN),"^",2),RX0=^PSRX(DA,0),J=DA,RX2=$G(^(2)),R3=$G(^(3)) S:'$G(BBFLG) BBRX(1)=""
"RTN","PSORXPA1",16,0)
 I +$P($G(^PSRX(DA,2)),"^",6)<DT D
"RTN","PSORXPA1",17,0)
 .S:$P($G(^PSRX(DA,"STA")),"^")<12 $P(^PSRX(DA,"STA"),"^")=11
"RTN","PSORXPA1",18,0)
 .S COMM="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"/"_$E($P(^(2),"^",6),6,7)_"/"_$E($P(^(2),"^",6),2,3)
"RTN","PSORXPA1",19,0)
 .S STAT="SC",PHARMST="ZE" D EN^PSOHLSN1(DA,STAT,PHARMST,COMM) K STAT,PHARMST,COMM,RX0,J,RX2,R3
"RTN","PSORXPA1",20,0)
 ;I +$P($G(^PSRX(DA,2)),"^",6)<PSODTCUT D  K DA S VALMBCK="R" Q
"RTN","PSORXPA1",21,0)
 ;.S VALMSG="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"/"_$E($P(^(2),"^",6),6,7)_"/"_$E($P(^(2),"^",6),2,3)
"RTN","PSORXPA1",22,0)
 I +^PSRX(DA,"STA"),+^("STA")'=5,+^("STA")'=11 D  K DA S VALMBCK="R" D ULK Q
"RTN","PSORXPA1",23,0)
 .S C=";"_+^PSRX(DA,"STA")_":",X=$P(^DD(52,100,0),"^",3),E=$F(X,C),D=$P($E(X,E,999),";")
"RTN","PSORXPA1",24,0)
 .S VALMSG="Prescription is in a "_D_" status."
"RTN","PSORXPA1",25,0)
 I $G(PSXSYS),($O(^PS(52.5,"B",DA,""))) S PSOZ1=$O(^PS(52.5,"B",DA,"")) D
"RTN","PSORXPA1",26,0)
 .I $P($G(^PS(52.5,PSOZ1,0)),"^",7)="Q"!($P($G(^(0)),"^",7)="L") D
"RTN","PSORXPA1",27,0)
 ..W !!,"A partial entered for this Rx cannot be suspended."
"RTN","PSORXPA1",28,0)
 ..W !,"A fill for this Rx is already suspended for CMOP transmission."
"RTN","PSORXPA1",29,0)
 ..W !,"You may pull this fill from suspense or enter a partial and print the label.",!!
"RTN","PSORXPA1",30,0)
 ;..S PSOZZ=1 K PSOZ1
"RTN","PSORXPA1",31,0)
CLC S PSOCLC=DUZ,PHYS=$P(^PSRX(DA,0),"^",4),DRG=$P(^(0),"^",6)
"RTN","PSORXPA1",32,0)
 I 'PHYS,$O(^PSRX(DA,1,0)) F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S PHYS=$S($P(^PSRX(DA,1,I,0),"^",17):$P(^PSRX(DA,1,I,0),"^",17),1:PHYS)
"RTN","PSORXPA1",33,0)
 S PSOPRZ=0 I $O(^PSRX(DA,"P",0)) N Z2 F Z2=0:0 S Z2=$O(^PSRX(DA,"P",Z2)) Q:'Z2  S PSOPRZ=Z2
"RTN","PSORXPA1",34,0)
 K Z1,PRMK S PM=1,RXN=DA,RXF=6,DIE("NO^")="BACKOUTOK",DIE=52
"RTN","PSORXPA1",35,0)
 ;DR="[PSO PARTIAL]"
"RTN","PSORXPA1",36,0)
 S DR="K PM,PQ;60;Q;S:$O(Y(1))]""""!($G(PM)) Y=""@1"";35;@1;K PM;"
"RTN","PSORXPA1",37,0)
 S DR(2,52.2)=".01;S Z1=D1;.02;S:X=""M""!('$P($G(PSOPAR),U,12)) PM=1;.04;S:X=U PQ=1;.041R;S:X=U PQ=1;.05;.07////^S X=DUZ;6////^S X=PHYS;Q;.08///^S X=""NOW"";S PDT=X;.09////^S X=PSOSITE;.03;S:X=U PQ=1;S PRMK=X"
"RTN","PSORXPA1",38,0)
 D ^DIE
"RTN","PSORXPA1",39,0)
 I $D(RXPR(DA)),'$D(^PSRX(DA,"P",$G(RXPR(DA)))) D RMP^PSOCAN3
"RTN","PSORXPA1",40,0)
 G:'$G(Z1) CLCX
"RTN","PSORXPA1",41,0)
 I $G(PRMK)']"",Z1>PSOPRZ D ULK G KILL
"RTN","PSORXPA1",42,0)
 I Z1,$G(PRMK)]"" D  D:$T(EN^PSOHDR)]"" EN^PSOHDR("PPAR",RXN) K DIE,RXN,RXF
"RTN","PSORXPA1",43,0)
 .D ACT S:$P($G(^PSRX(RXN,"P",Z1,0)),"^",2)["W" PSODFN=$P(^PSRX(RXN,0),"^",2),BINGRTE="W",BBFLG=1,BBRX(1)=$G(BBRX(1))_RXN_","
"RTN","PSORXPA1",44,0)
 .S ZD(RXN)=+^PSRX(RXN,"P",Z1,0),^PSRX(RXN,"TYPE")=Z1,$P(^PSRX(RXN,"P",Z1,0),"^",11)=$P($G(^PSDRUG(DRG,660)),"^",6),RXF=6,RXP=Z1,RXPR(RXN)=RXP
"RTN","PSORXPA1",45,0)
 .;I $G(PSOZZ)=1,($G(Z1)) D Q1^PSORXL K Z1,PSOZZ Q
"RTN","PSORXPA1",46,0)
 .I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=RXN_"," Q
"RTN","PSORXPA1",47,0)
 .F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  Q:PSORX("PSOL",PSOX1)[RXN_","  S PSOX2=PSOX1
"RTN","PSORXPA1",48,0)
 .I PSOX1 Q
"RTN","PSORXPA1",49,0)
 .I $L(PSORX("PSOL",PSOX2))+$L(RXN)<220 S:PSORX("PSOL",PSOX2)'[RXN_"," PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_RXN_","
"RTN","PSORXPA1",50,0)
 .E  S PSORX("PSOL",PSOX2+1)=RXN_","
"RTN","PSORXPA1",51,0)
 S:'$D(PSOFROM) PSOFROM="PARTIAL" S BINGCRT=1 ;D:$D(BINGRTE)&($D(DISGROUP)) ^PSOBING1 K BINGRTE,TM,TM1
"RTN","PSORXPA1",52,0)
CLCX D ULK K DR,DIE,DRG,PPL,RXP,IOP,DA,PHYS,PSOPRZ S VALMBCK="R" Q
"RTN","PSORXPA1",53,0)
 ;
"RTN","PSORXPA1",54,0)
KILL S DA=Z1,DIK="^PSRX("_RXN_",""P""," D ^DIK S ^PSRX(RXN,"TYPE")=0
"RTN","PSORXPA1",55,0)
 D ULK S VALMSG="No Partial Fill Dispensed",VALMBCK="R" Q
"RTN","PSORXPA1",56,0)
KL K DFN,RFDAT,RLL,%,PRMK,PM,%Y,%X,D0,D1,DA,DI,DIC,DIE,DLAYGO,DQ,DR,I,II,J,JJJ,N,PHYS,PS,PSDATE,RFL,RFL1,RXF,ST,ST0,Z,Z1,X,Y,PDT,PSL,PSNP
"RTN","PSORXPA1",57,0)
 K PSOM,PSOP,PSOD,PSOU,DIK,DUOUT,IFN,RXN,DRG,HRX,I1,PSOCLC,PSOLIST,PSOLST,PSPAR,RXP D KVA^VADPT Q
"RTN","PSORXPA1",58,0)
ACT ;adds activity info for partial rx
"RTN","PSORXPA1",59,0)
 S RXF=0 F I=0:0 S I=$O(^PSRX(RXN,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSORXPA1",60,0)
 S DA=0 F FDA=0:0 S FDA=$O(^PSRX(RXN,"A",FDA)) Q:'FDA  S DA=FDA
"RTN","PSORXPA1",61,0)
 S DA=DA+1,^PSRX(RXN,"A",0)="^52.3DA^"_DA_"^"_DA,^PSRX(RXN,"A",DA,0)=DT_"^"_"P"_"^"_DUZ_"^"_RXF_"^"_PRMK
"RTN","PSORXPA1",62,0)
EX K RXF,I,FDA S DA=RXN
"RTN","PSORXPA1",63,0)
 Q
"RTN","PSORXPA1",64,0)
ULK ;
"RTN","PSORXPA1",65,0)
 D UL^PSSLOCK(+$G(PSORPDFN))
"RTN","PSORXPA1",66,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSORXPA1",67,0)
 K PSOMSG,PSOPLCK,PSORPDFN
"RTN","PSORXPA1",68,0)
 Q
"RTN","PSOSULBL")
0^6^B32674234
"RTN","PSOSULBL",1,0)
PSOSULBL ;BHAM ISC/RTR,SAB-Print Suspended labels ;4/8/93
"RTN","PSOSULBL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**139,173,174**;DEC 1997
"RTN","PSOSULBL",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOSULBL",4,0)
 K PDUZ,REPRINT G ^PSOSULB1
"RTN","PSOSULBL",5,0)
BEG ;
"RTN","PSOSULBL",6,0)
 K PSORUNIN,PSORETRY
"RTN","PSOSULBL",7,0)
 S PSORUNIN="PSOSUSP"_($G(PSOSITE))
"RTN","PSOSULBL",8,0)
 L +@PSORUNIN:10 I '$T D
"RTN","PSOSULBL",9,0)
 . F PSORETRY=1:1:120 L +@PSORUNIN:60 I $T Q  ;waits a Maximum of 2 hours before continuing
"RTN","PSOSULBL",10,0)
 . Q
"RTN","PSOSULBL",11,0)
 K ^UTILITY($J,"PSOPRO") S PSOSEQ=1 F DFN=0:0 S DFN=$O(^PS(52.5,"AC",DFN)) Q:'DFN  D  D:'PSRT PID^VADPT6 D CHKDEAD D:'DEAD&($G(PSOSFLAG)) PRT
"RTN","PSOSULBL",12,0)
 .S PSOSFLAG=0 F ZZ=0:0 S ZZ=$O(^PS(52.5,"AC",DFN,ZZ)) Q:'ZZ!$G(PSOSFLAG)  I ZZ'>PRTDT S PSOSFLAG=1
"RTN","PSOSULBL",13,0)
 D PPL
"RTN","PSOSULBL",14,0)
 D:$D(^UTILITY($J,"PSOPRO"))&($P(PSOPAR,"^",8)) PROF
"RTN","PSOSULBL",15,0)
 G EXIT
"RTN","PSOSULBL",16,0)
PRT F SDT=0:0 S SDT=$O(^PS(52.5,"AC",DFN,SDT)) D:SDT CHK Q:'SDT
"RTN","PSOSULBL",17,0)
 Q
"RTN","PSOSULBL",18,0)
EXIT ;
"RTN","PSOSULBL",19,0)
 K ^TMP($J)
"RTN","PSOSULBL",20,0)
 I $D(PSORUNIN) L -@PSORUNIN
"RTN","PSOSULBL",21,0)
 D ^%ZISC
"RTN","PSOSULBL",22,0)
 K %,%ZIS,CNT,COM,DA,DEAD,DFN,DIRUT,DTTM,G,HDPPL,JJ,JJJ,JJJJ,PDUZ,IOP,ORD,PFIOQ,PSLION,PSRT,POP,PRF,PRTDT,PSLIO,PSNP,PSODBQ,PSOSEQ,PSOSFLAG,PSOSU,PSOTIME,PSOOUT,PSOPRFLG,PSOSEQ,PSOSUSPR,PSSPND,PST,PTL,PPLHLD,PSFNIEN,ZTSK
"RTN","PSOSULBL",23,0)
 K PSORUNIN,PSORETRY,PSRTONE,PSSRT,PSUSDEA,RF,RFCNT,RX,SDT,SFN,SREC,STOP,SUSPT,VADM,VAPA,X,X1,X2,XAK,XDATE,Y,Z,ZZ,WWW,PSDDDATE,SINRX,RXPR,RXPR1,GGGG,XXX,ZII,ZTDESC,ZTRTN,ZTSAVE,RRRR,RXRP,RXRP1,RXFL,SPR S:$D(ZTQUEUED) ZTREQ="@" Q
"RTN","PSOSULBL",24,0)
CHK I SDT'>XDATE D TMP Q
"RTN","PSOSULBL",25,0)
 Q
"RTN","PSOSULBL",26,0)
TMP F SFN=0:0 S SFN=$O(^PS(52.5,"AC",DFN,SDT,SFN)) Q:'SFN  I +$P($G(^PS(52.5,+SFN,0)),"^",6)=$G(PSOSITE),'$G(^("P")),$P(^PSRX($P(^(0),"^"),0),"^",2)=DFN,$D(^DPT(DFN,0)),$P(^PSRX($P(^PS(52.5,SFN,0),"^"),"STA"),"^")<9  D
"RTN","PSOSULBL",27,0)
 .I $D(^PS(52.5,SFN,0)),$P(^PS(52.5,SFN,0),"^",5)'=0 D  Q:'$D(^PSRX($P(^PS(52.5,SFN,0),"^"),"P",SPR))
"RTN","PSOSULBL",28,0)
 ..S SPR=$P(^PS(52.5,SFN,0),"^",5)
"RTN","PSOSULBL",29,0)
 .I +$P($G(^PSRX($P(^PS(52.5,SFN,0),"^"),2)),"^",6)<DT,+$P($G(^("STA")),"^")<11 S RXREC=$P(^PS(52.5,SFN,0),"^") D  S DIE=52,DA=$P(^PS(52.5,SFN,0),"^"),DR="100///"_11 D ^DIE S DA=SFN,DIK="^PS(52.5," D ^DIK K DIE,DIK,DA Q
"RTN","PSOSULBL",30,0)
 ..D EX^PSOSUTL K RXREC Q
"RTN","PSOSULBL",31,0)
 .I PSRT="D" S PSSRT=$S($G(PSRTONE)="I":VA("PID"),1:$P(^DPT(DFN,0),"^")_$P(^(0),"^",9))  S PSUSDEA=$P($G(^PS(52.5,SFN,0)),"^",10) S SRT=$S(PSUSDEA["A"!(PSUSDEA["C"):"A-"_PSSRT,PSUSDEA["S":"S-"_PSSRT,1:"Z-"_PSSRT)
"RTN","PSOSULBL",32,0)
 .I PSRT'="D" S SRT=$S(PSRT:$P(^DPT(DFN,0),"^")_$P(^(0),"^",9),1:VA("PID"))
"RTN","PSOSULBL",33,0)
 .S ^TMP($J,SRT,SFN)=+^PS(52.5,SFN,0)
"RTN","PSOSULBL",34,0)
 Q
"RTN","PSOSULBL",35,0)
PPL K PPL,PPL1 S ORD="" F  S ORD=$O(^TMP($J,ORD)) Q:ORD=""  D PPL1
"RTN","PSOSULBL",36,0)
 Q
"RTN","PSOSULBL",37,0)
PPL1 S (PSOPRFLG,SUSPT)=1 S:$D(PSOPROP) PFIO=PSOPROP
"RTN","PSOSULBL",38,0)
 S:'$D(PDUZ) PDUZ=DUZ K RXPR,RXPR1,PPL F SFN=0:0 S SFN=$O(^TMP($J,ORD,SFN)) Q:'SFN  I $D(^PS(52.5,SFN,0)) S SINRX=$P($G(^PS(52.5,SFN,0)),"^") D
"RTN","PSOSULBL",39,0)
 .I $L($G(PPL))<240 S PPL=$P(^TMP($J,ORD,SFN),"^")_","_$G(PPL) S RXPR(SINRX)=$P(^PS(52.5,SFN,0),"^",5),RXFL(SINRX)=$P($G(^PS(52.5,SFN,0)),"^",13) S:$P(^PS(52.5,SFN,0),"^",12) RXRP(SINRX)=1
"RTN","PSOSULBL",40,0)
 .E  S PPL1=$P(^TMP($J,ORD,SFN),"^")_","_$G(PPL1) S RXPR1(SINRX)=$P(^PS(52.5,SFN,0),"^",5),RXFL(SINRX)=$P($G(^PS(52.5,SFN,0)),"^",13) S:$P(^PS(52.5,SFN,0),"^",12) RXRP1(SINRX)=1
"RTN","PSOSULBL",41,0)
 .S DFN=$P(^PS(52.5,SFN,0),"^",3) I $P(PSOPAR,"^",8),'$D(^PSRX($P(^PS(52.5,SFN,0),"^"),1)),'$G(RXPR(SINRX)),'$G(RXPR1(SINRX)) S PSOPRFLG=0
"RTN","PSOSULBL",42,0)
 S PSNP=$S($P(PSOPAR,"^",8):1,1:0) I $G(PPL) S PPLHLD=$G(PPL1),HDPPL=PPL K PPL1 S (PSODBQ,PSOSUSPR)=1 F GGGG=0:0 S GGGG=$O(RXPR(GGGG)) Q:'GGGG  K:'$G(RXPR(GGGG)) RXPR(GGGG)
"RTN","PSOSULBL",43,0)
 I $G(PPL) D DQ^PSOLBL,SEQ D:'$G(PSOPRFLG)
"RTN","PSOSULBL",44,0)
 .I $G(PSOPROP)'=$G(PSLION) S ^UTILITY($J,"PSOPRO",DFN)="" Q
"RTN","PSOSULBL",45,0)
 .D DQ^PSOPRFSS
"RTN","PSOSULBL",46,0)
 I $G(PPLHLD) K RXPR S (PPL,HDPPL)=PPLHLD,(PSODBQ,PSOSUSPR)=1,PSNP=0 S:'$D(PDUZ) PDUZ=DUZ F XXX=0:0 S XXX=$O(RXPR1(XXX)) Q:'XXX  S:$G(RXPR1(XXX)) RXPR(XXX)=RXPR1(XXX)
"RTN","PSOSULBL",47,0)
 I $G(PPLHLD) F RRRR=0:0 S RRRR=$O(RXRP1(RRRR)) Q:'RRRR  S:$D(RXRP1(RRRR)) RXRP(RRRR)=1
"RTN","PSOSULBL",48,0)
 I $G(PPLHLD) D DQ^PSOLBL,SEQ D:'$G(PSOPRFLG)
"RTN","PSOSULBL",49,0)
 .I $G(PSOPROP)'=$G(PSLION) S ^UTILITY($J,"PSOPRO",DFN)="" Q
"RTN","PSOSULBL",50,0)
 .D DQ^PSOPRFSS
"RTN","PSOSULBL",51,0)
 K PPL,PPL1,PPLHLD,RXPR,RXPR1,RXFL Q
"RTN","PSOSULBL",52,0)
SEQ ;
"RTN","PSOSULBL",53,0)
 S SQCOUNT=0 F JJJ=1:1:$L(HDPPL) S:$E(HDPPL,JJJ)="," SQCOUNT=SQCOUNT+1
"RTN","PSOSULBL",54,0)
 F JJJJ=1:1:SQCOUNT S PSFNIEN=$P(HDPPL,",",JJJJ) D:PSFNIEN
"RTN","PSOSULBL",55,0)
 .S PSFNIEN=$O(^PS(52.5,"B",PSFNIEN,0)) I PSFNIEN D
"RTN","PSOSULBL",56,0)
 ..S $P(^PS(52.5,PSFNIEN,0),"^",11)=PSOSEQ,PSOSEQ=PSOSEQ+1 S:$P(^PS(52.5,PSFNIEN,0),"^",8)&($P(^(0),"^",9))&($P(^(0),"^",6)) ^PS(52.5,"AS",$P(^PS(52.5,PSFNIEN,0),"^",8),$P(^(0),"^",9),$P(^(0),"^",6),$P(^(0),"^",11),PSFNIEN)=""
"RTN","PSOSULBL",57,0)
 Q
"RTN","PSOSULBL",58,0)
CHKDEAD D DEM^VADPT I VADM(1)="" S DEAD=0 Q
"RTN","PSOSULBL",59,0)
 I VADM(6)="" S DEAD=0 Q
"RTN","PSOSULBL",60,0)
 S PSDDDATE=$P(VADM(6),"^",2) F WWW=0:0 S WWW=$O(^PS(55,DFN,"P",WWW)) Q:'WWW  I $D(^PS(55,DFN,"P",WWW,0)),$P($G(^(0)),"^") S (DA,RXREC)=$P(^(0),"^") S SFN=$O(^PS(52.5,"B",RXREC,0)) I SFN,$D(^PS(52.5,SFN,0)) S RX=$P(^(0),"^") D DEAD
"RTN","PSOSULBL",61,0)
 Q
"RTN","PSOSULBL",62,0)
DEAD S $P(^PSRX(RX,"STA"),"^")=12,COM="Died ("_$G(PSDDDATE)_")",DA(1)=RX
"RTN","PSOSULBL",63,0)
 S DEAD=1 D ARECD^PSOSUTL S DIK="^PS(52.5,",DA=SFN D ^DIK K DIK
"RTN","PSOSULBL",64,0)
 Q
"RTN","PSOSULBL",65,0)
PROF ;
"RTN","PSOSULBL",66,0)
 S ZTRTN="PRPROF^PSOSULBL",ZTDESC="PRINT PROFILES FROM SUSPENSE",ZTDTH=$H,ZTIO=PSOPROP
"RTN","PSOSULBL",67,0)
 S ZTSAVE("^UTILITY($J,""PSOPRO"",")="",ZTSAVE("PSOPAR")="",ZTSAVE("PSODTCUT")="",ZTSAVE("PSOSITE")="",ZTSAVE("PSOPRPAS")="" D ^%ZTLOAD Q
"RTN","PSOSULBL",68,0)
PRPROF ;
"RTN","PSOSULBL",69,0)
 F LLL=0:0 S LLL=$O(^UTILITY($J,"PSOPRO",LLL)) Q:'LLL  I $D(^DPT(LLL,0)) S DFN=LLL D DQ^PSOPRFSS
"RTN","PSOSULBL",70,0)
 K PSOPAR,PSODTCUT,PSOSITE,PSOPRPAS,LLL,DFN,^UTILITY($J,"PSOPRO") D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOSULBL",71,0)
 Q
"RTN","PSOUTL")
0^5^B62525989
"RTN","PSOUTL",1,0)
PSOUTL ;BHAM ISC/SAB - pso utility routine ;10/24/92 13:30
"RTN","PSOUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,21,126,174**;DEC 1997
"RTN","PSOUTL",3,0)
 ;External reference SERV^IBARX1 supported by DBIA 2245
"RTN","PSOUTL",4,0)
 ;External reference ^PS(55,     supported by DBIA 2228
"RTN","PSOUTL",5,0)
SUSPCAN ;dcl rx from suspense used in new, renew AND verification of Rxs
"RTN","PSOUTL",6,0)
 S PSLAST=0 F PSI=0:0 S PSI=$O(^PSRX(PSRX,1,PSI)) Q:'PSI  S PSLAST=PSI
"RTN","PSOUTL",7,0)
 I PSLAST S PSI=^PSRX(PSRX,1,PSLAST,0) K ^PSRX(PSRX,1,PSLAST),^PSRX(PSRX,1,"B",+PSI,PSLAST) S ^(0)=$P(^PSRX(PSRX,1,0),"^",1,3)_"^"_($P(^(0),"^",4)-1) K PSLAST,PSI,SUSX,SUS1,SUS2 Q
"RTN","PSOUTL",8,0)
 S $P(^PSRX(PSRX,3),"^",7)="DISCONTINUED FROM SUSPENSE BEFORE FILLING" K PSI,SUSX,SUS1,SUS2 Q
"RTN","PSOUTL",9,0)
 ;
"RTN","PSOUTL",10,0)
ACTLOG ;
"RTN","PSOUTL",11,0)
 F PSI=0:0 S PSI=$O(^PSRX(PSRX,"A",PSI)) I 'PSI!'$O(^(PSI)) S ^PSRX(PSRX,"A",+PSI+1,0)=DT_"^"_PSREA_"^"_PSOCLC_"^"_PSRXREF_"^"_PSMSG,^PSRX(PSRX,"A",0)="^52.3DA^"_(+PSI+1)_"^"_(+PSI+1) Q
"RTN","PSOUTL",12,0)
ACTOUT I PSREA="C" S PSI=$S($D(^PSRX(PSRX,2)):+$P(^(2),"^",6),1:0) K:$D(^PS(55,PSDFN,"P","A",PSI,PSRX)) ^(PSRX) S ^PS(55,PSDFN,"P","A",DT,PSRX)="" Q
"RTN","PSOUTL",13,0)
 I PSREA="R" F PSI=0:0 S PSI=$O(^PSRX(PSRX,"A",PSI)) Q:'PSI  I $D(^(PSI,0)),$P(^(0),"^",2)="C" S PSS=+^(0)
"RTN","PSOUTL",14,0)
 I $D(PSS),PSS K:$D(^PS(55,PSDFN,"P","A",PSS,PSRX)) ^(PSRX)
"RTN","PSOUTL",15,0)
 I PSREA="R",$D(^PSRX(PSRX,2))#2 S ^PS(55,PSDFN,"P","A",+$P(^PSRX(PSRX,2),"^",6),PSRX)=""
"RTN","PSOUTL",16,0)
 Q
"RTN","PSOUTL",17,0)
 ;
"RTN","PSOUTL",18,0)
QUES ;INSTRUCTIONS FOR RENEW AND REFILL
"RTN","PSOUTL",19,0)
 W !?5,"Enter the item #(s) or RX #(s) you wish to ",$S(PSFROM="N":"renew ",PSFROM="R":"REFILL "),"separated by commas."
"RTN","PSOUTL",20,0)
 W !?5,"For example: 1,2,5 or 123456,33254A,232323B."
"RTN","PSOUTL",21,0)
 W !?5,"Do not enter the same number twice, duplicates are not allowed."
"RTN","PSOUTL",22,0)
 Q
"RTN","PSOUTL",23,0)
ENDVCHK S PSOPOP=0 Q:'PSODIV  Q:'$P(^PSRX(PSRX,2),"^",9)!($P(^(2),"^",9)=PSOSITE)
"RTN","PSOUTL",24,0)
CHK1 I '$P(PSOSYS,"^",2) W !?10,$C(7),"RX# ",$P(^PSRX(PSRX,0),"^")," is not a valid choice. (Different Division)" S PSPOP=1 Q
"RTN","PSOUTL",25,0)
 I $P(PSOSYS,"^",3) W !?10,$C(7),"RX# ",$P(^PSRX(PSRX,0),"^")," is from another division. Continue? (Y/N) " R ANS:DTIME I ANS="^"!(ANS="") S PSPOP=1 Q
"RTN","PSOUTL",26,0)
 I (ANS']"")!("YNyn"'[$E(ANS)) W !?10,$C(7),"Answer 'YES' or 'NO'." G CHK1
"RTN","PSOUTL",27,0)
 S:$E(ANS)["Nn" PSPOP=1 Q
"RTN","PSOUTL",28,0)
K52 S SFN=+$O(^PS(52.5,"B",DA(1),0)) Q:SFN=0
"RTN","PSOUTL",29,0)
 I $P($G(^PS(52.5,SFN,0)),"^",5)=$P($G(^PSRX(+^PS(52.5,SFN,0),"P",0)),"^",3),$P($G(^PSRX($P(^PS(52.5,SFN,0),"^"),"P",0)),"^",4)=0 N PSOXX S PSOXX=1 G KILL
"RTN","PSOUTL",30,0)
 G:X'=""&($G(Y)=1) KILL I $G(Y)'=1,SFN I $D(^PS(52.5,SFN,0)),'$P(^(0),"^",5),'$P($G(^("P")),"^") D
"RTN","PSOUTL",31,0)
 .S SDT=+$P(^PS(52.5,SFN,0),"^",2) K ^PS(52.5,"C",SDT,SFN)
"RTN","PSOUTL",32,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="Q" K ^PS(52.5,"AQ",SDT,+$P(^PS(52.5,SFN,0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,"Q")
"RTN","PSOUTL",33,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" K ^PS(52.5,"AC",+$P(^PS(52.5,SFN,0),"^",3),SDT,SFN)
"RTN","PSOUTL",34,0)
 .K SFN,SDT
"RTN","PSOUTL",35,0)
 Q
"RTN","PSOUTL",36,0)
S52 S (RIFN,PSOSX)=0 F  S RIFN=$O(^PSRX(DA(1),1,RIFN)) Q:'RIFN  S RFID=$P(^PSRX(DA(1),1,RIFN,0),"^"),PSOSX=PSOSX+1
"RTN","PSOUTL",37,0)
 S SFN=+$O(^PS(52.5,"B",DA(1),0)) I SFN,'$G(^PS(52.5,SFN,"P")),$P($G(^PSRX($P($G(^PS(52.5,SFN,0)),"^"),"STA")),"^")=5 D
"RTN","PSOUTL",38,0)
 .I '$D(^PS(52.5,SFN,0))!($P($G(^(0)),"^",5)) Q
"RTN","PSOUTL",39,0)
 .S $P(^PS(52.5,SFN,0),"^",2)=RFID,^PS(52.5,"C",RFID,SFN)=""
"RTN","PSOUTL",40,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="Q" S ^PS(52.5,"AQ",RFID,+$P(^PS(52.5,SFN,0),"^",3),SFN)="" D SCMPX^PSOCMOP(SFN,"Q")
"RTN","PSOUTL",41,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" S ^PS(52.5,"AC",+$P(^PS(52.5,SFN,0),"^",3),RFID,SFN)=""
"RTN","PSOUTL",42,0)
 K SFN,RFIN,RFID,PSOSX,PSOSXDT Q
"RTN","PSOUTL",43,0)
KILL I SFN D
"RTN","PSOUTL",44,0)
 .S $P(^PSRX(DA(1),"STA"),"^")=0 Q:'$D(^PS(52.5,SFN,0))  S DFN=+$P(^PS(52.5,SFN,0),"^",3),PAT=$P(^DPT(DFN,0),"^")
"RTN","PSOUTL",45,0)
 .;I $P(^PS(52.5,SFN,0),"^",5) Q
"RTN","PSOUTL",46,0)
 .K ^PS(52.5,"B",+$P(^PS(52.5,SFN,0),"^"),SFN),^PS(52.5,"C",+$P(^PS(52.5,SFN,0),"^",2),SFN),^PS(52.5,"D",PAT,SFN),^PS(52.5,"AF",DFN,SFN)
"RTN","PSOUTL",47,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" D
"RTN","PSOUTL",48,0)
 ..I $G(^PS(52.5,SFN,"P")) K ^PS(52.5,"AS",+$P(^(0),"^",8),+$P(^(0),"^",9),+$P(^(0),"^",6),+$P(^(0),"^",11),SFN),^PS(52.5,"ADL",$E(+$P(^PS(52.5,SFN,0),"^",8),1,7),SFN) Q
"RTN","PSOUTL",49,0)
 ..K ^PS(52.5,"AC",DFN,+$P(^PS(52.5,SFN,0),"^",2),SFN)
"RTN","PSOUTL",50,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)'="" D
"RTN","PSOUTL",51,0)
 ..;Kill CMOP xrefs
"RTN","PSOUTL",52,0)
 ..N PSOC7 S PSOC7=$P($G(^PS(52.5,SFN,0)),"^",7)
"RTN","PSOUTL",53,0)
 ..I PSOC7="Q"!(PSOC7="P") K ^PS(52.5,"AG",+$P(^PS(52.5,SFN,0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,PSOC7)
"RTN","PSOUTL",54,0)
 ..I PSOC7="X"!(PSOC7="P")!(PSOC7="L") K ^PS(52.5,$S(PSOC7="X":"AX",PSOC7="P":"AP",1:"AL"),$P(^PS(52.5,SFN,0),"^",2),$P(^(0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,PSOC7)
"RTN","PSOUTL",55,0)
 ..K ^PS(52.5,"APR",+$P(^PS(52.5,SFN,0),"^",8),+$P(^(0),"^",9),+$P(^(0),"^",6),+$P(^(0),"^",11),SFN),^PS(52.5,"ADL",$E(+$P(^PS(52.5,SFN,0),"^",8),1,7),SFN)
"RTN","PSOUTL",56,0)
 .K ^PS(52.5,SFN,0),^PS(52.5,SFN,"P"),DFN,SFN,PAT
"RTN","PSOUTL",57,0)
 S CNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA(1),"A",SUB)) Q:'SUB  S CNT=SUB
"RTN","PSOUTL",58,0)
 S:DA>5 DA=DA+1 D NOW^%DTC S CNT=CNT+1
"RTN","PSOUTL",59,0)
 S ^PSRX(DA(1),"A",0)="^52.3DA^"_CNT_"^"_CNT,^PSRX(DA(1),"A",CNT,0)=%_"^D^"_DUZ_"^"_DA_"^"
"RTN","PSOUTL",60,0)
 I '$D(PSOXX) S ^PSRX(DA(1),"A",CNT,0)=^PSRX(DA(1),"A",CNT,0)_"Refill "
"RTN","PSOUTL",61,0)
 ;if PSOXX not exist, = refill. otherwise, it is a partial.
"RTN","PSOUTL",62,0)
 S ^PSRX(DA(1),"A",CNT,0)=^PSRX(DA(1),"A",CNT,0)_$S($G(RESK):"returned to stock.",$G(PSOPSDAL):"deleted during Controlled Subs release.",$G(PSOXX)=1:"Partial deleted from suspense file.",1:"deleted during Rx edit.") K CNT,SUB
"RTN","PSOUTL",63,0)
 Q
"RTN","PSOUTL",64,0)
CID ;calculates six months limit on issue dates
"RTN","PSOUTL",65,0)
 S PSID=X,X="T-6M",%DT="X" D ^%DT S %DT(0)=Y,X=PSID,%DT="EX" D ^%DT K PSID
"RTN","PSOUTL",66,0)
 Q
"RTN","PSOUTL",67,0)
CIDH S X="T-6M",%DT="X" D ^%DT X ^DD("DD") D EN^DDIOL("Issue Date must be greater or equal to "_Y,"","!")
"RTN","PSOUTL",68,0)
 Q
"RTN","PSOUTL",69,0)
SPR F RF=0:0 S RF=$O(^PSRX(DA(1),1,RF)) Q:'RF  S NODE=RF
"RTN","PSOUTL",70,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) Q
"RTN","PSOUTL",71,0)
SREF I $G(NODE) S NODE=NODE-1 G:'$D(^PSRX(DA(1),1,NODE,0)) SREF
"RTN","PSOUTL",72,0)
 I NODE=0 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) Q
"RTN","PSOUTL",73,0)
 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),1,NODE,0),"^",1) Q
"RTN","PSOUTL",74,0)
 K NODE,RF
"RTN","PSOUTL",75,0)
 Q
"RTN","PSOUTL",76,0)
KPR F RF=0:0 S RF=$O(^PSRX(DA(1),1,RF)) Q:'RF  S NODE=RF
"RTN","PSOUTL",77,0)
 I NODE=DA&(X'="") S NODE=NODE-1 S:NODE=1 NODE=0 G:'NODE ORIG G:NODE>1 KREF
"RTN","PSOUTL",78,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",79,0)
KREF S NODE=NODE-1 G:'NODE EX
"RTN","PSOUTL",80,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",81,0)
 G:NODE=DA&(X'="") KREF G:'$D(^PSRX(DA(1),1,NODE,0)) KREF
"RTN","PSOUTL",82,0)
ORIG I 'NODE S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",83,0)
 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),1,NODE,0),"^",1) G EX
"RTN","PSOUTL",84,0)
EX K NODE,RF
"RTN","PSOUTL",85,0)
 Q
"RTN","PSOUTL",86,0)
IBSS N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOUTL",87,0)
 S PSOHLP(1)="Entry in this field must match the SERVICE field for pharmacy action"
"RTN","PSOUTL",88,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOUTL",89,0)
 S PSOHLP(2)="types in the IB ACTION TYPE file AND be a valid entry in your"
"RTN","PSOUTL",90,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOUTL",91,0)
 S PSOHLP(3)="SERVICE/SECTION file to generate copay charges!"
"RTN","PSOUTL",92,0)
 S PSOHLP(4,"F")="!!"
"RTN","PSOUTL",93,0)
 D EN^DDIOL(.PSOHLP) K PSOHLP
"RTN","PSOUTL",94,0)
 Q
"RTN","PSOUTL",95,0)
IBSSR S PSOIBFL=0 F PSOIBLP=0:0 S PSOIBLP=$O(^DIC(49,PSOIBLP)) Q:'PSOIBLP!(PSOIBFL)  S Y=PSOIBLP,PSOIBST=$$SERV^IBARX1(+Y) I $G(PSOIBST) S DIE="^PS(59,",DA=PSOSITE,DR="1003////"_PSOIBLP D ^DIE K DIE D  S PSOIBFL=1
"RTN","PSOUTL",96,0)
 .W $C(7),!!,"There was an invalid entry in your IB SERVICE/SECTION field in your Outpatient",!,"Site Parameter file, but we have fixed the problem for you, and you",!,"may continue!" Q
"RTN","PSOUTL",97,0)
 Q
"RTN","PSOUTL",98,0)
WARN ;
"RTN","PSOUTL",99,0)
 I $G(PSOUNHLD) D  Q
"RTN","PSOUTL",100,0)
 .D EN^DDIOL("You cannot delete a refill while removing from Hold! Use the Edit Action.","","$C(7),!!"),EN^DDIOL(" ","","!!")
"RTN","PSOUTL",101,0)
 I $G(CMOP(DA))]""&(+$G(CMOP(DA))<3) D   K CMOP Q
"RTN","PSOUTL",102,0)
 .D EN^DDIOL("You cannot delete a refill that"_$S(+$G(CMOP(DA))=1:" has been released by",1:" is being transmitted to")_" the CMOP","","!!")
"RTN","PSOUTL",103,0)
 .D EN^DDIOL(" ","","!!")
"RTN","PSOUTL",104,0)
 K CMOP
"RTN","PSOUTL",105,0)
 S PSR=0 F  S PSR=$O(^PSRX(DA(1),1,PSR)) Q:'PSR  S PSOL=PSR
"RTN","PSOUTL",106,0)
 I DA=PSOL,$P(^PSRX(DA(1),1,DA,0),"^",18) D
"RTN","PSOUTL",107,0)
 .D EN^DDIOL("Refill Released! Use the 'Return to Stock' option before attempting to delete!","","$C(7),!!"),EN^DDIOL(" ","","!")
"RTN","PSOUTL",108,0)
 K PSR,PSOL Q
"RTN","PSOUTL",109,0)
WARN1 S PSR=0 F  S PSR=$O(^PSRX(DA(1),"P",PSR)) Q:'PSR  S PSOL=PSR
"RTN","PSOUTL",110,0)
 I DA=PSOL,$P(^PSRX(DA(1),"P",DA,0),"^",19) D
"RTN","PSOUTL",111,0)
 .D EN^DDIOL("Partial Released! Use the 'Return to Stock' option before attempting to delete!","","$C(7),!!"),EN^DDIOL(" ","","!")
"RTN","PSOUTL",112,0)
 K PSR,PSOL Q
"RTN","PSOUTL",113,0)
 Q
"RTN","PSOUTL",114,0)
CAN(PSOXRX) ;Clean up Rx when discontinued
"RTN","PSOUTL",115,0)
 N SUSD,IFN,RF,NODE,DA
"RTN","PSOUTL",116,0)
 Q:'$D(^PSRX(PSOXRX,0))
"RTN","PSOUTL",117,0)
 S DA=$O(^PS(52.5,"B",PSOXRX,0)) I DA S DIK="^PS(52.5,",SUSD=$P($G(^PS(52.5,DA,0)),"^",2) D ^DIK K DIK I $O(^PSRX(PSOXRX,1,0)) S DA=PSOXRX D REF^PSOCAN2
"RTN","PSOUTL",118,0)
 I $D(^PS(52.4,PSOXRX,0)) S DIK="^PS(52.4,",DA=PSOXRX D ^DIK K DIK
"RTN","PSOUTL",119,0)
 I $G(^PSRX(PSOXRX,"H"))]"" K:$P(^PSRX(PSOXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOXRX,"H"),"^"),PSOXRX) S ^PSRX(PSOXRX,"H")=""
"RTN","PSOUTL",120,0)
 I '$P($G(^PSRX(PSOXRX,2)),"^",2) K DIE S DIE="^PSRX(",DA=PSOXRX,DR="22///"_DT D ^DIE
"RTN","PSOUTL",121,0)
 Q
"RTN","PSOUTL",122,0)
ECAN(PSOXRX) ;Clean up Rx when expired
"RTN","PSOUTL",123,0)
 N DA
"RTN","PSOUTL",124,0)
 Q:'$D(^PSRX(PSOXRX,0))
"RTN","PSOUTL",125,0)
 S DA=$O(^PS(52.5,"B",PSOXRX,0)) I DA K DIK S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOUTL",126,0)
 I $D(^PS(52.4,PSOXRX,0)) K DIK S DIK="^PS(52.4,",DA=PSOXRX D ^DIK K DIK
"RTN","PSOUTL",127,0)
 I $G(^PSRX(PSOXRX,"H"))]"" K:$P(^PSRX(PSOXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOXRX,"H"),"^"),PSOXRX) S ^PSRX(PSOXRX,"H")=""
"RTN","PSOUTL",128,0)
 I '$P($G(^PSRX(PSOXRX,2)),"^",2) K DIE S DIE="^PSRX(",DA=PSOXRX,DR="22///"_DT D ^DIE
"RTN","PSOUTL",129,0)
 Q
"RTN","PSOUTL",130,0)
CMOP ;CMOP("L")=LAST FILL... if it is orig Rx =0
"RTN","PSOUTL",131,0)
 ;CMOP(FILL #)=CMOP status from 52[TRAN=0,DISP=1,RETRAN=2,NOT DISP=3
"RTN","PSOUTL",132,0)
 ;If suspended CMOP("S")=CMOP suspense status Q,L,X,P,R
"RTN","PSOUTL",133,0)
 ;All returned variables can be killed by K CMOP
"RTN","PSOUTL",134,0)
 ;
"RTN","PSOUTL",135,0)
 S CRX=DA
"RTN","PSOUTL",136,0)
CMOP1 N X
"RTN","PSOUTL",137,0)
 S (CMOP("L"),X)=0  F  S X=$O(^PSRX(CRX,1,X)) Q:'X  S CMOP("L")=X
"RTN","PSOUTL",138,0)
 I $O(^PSRX(CRX,4,0)) F X=0:0 S X=$O(^PSRX(CRX,4,X)) Q:'X  D
"RTN","PSOUTL",139,0)
 .S CMOP($P($G(^PSRX(CRX,4,X,0)),"^",3))=$P($G(^(0)),"^",4)
"RTN","PSOUTL",140,0)
 S X=$O(^PS(52.5,"B",CRX,0)) I X]"" S CMOP("S")=$P($G(^PS(52.5,X,0)),"^",7)
"RTN","PSOUTL",141,0)
 K CRX,X
"RTN","PSOUTL",142,0)
 Q
"VER")
8.0^22.0
"BLD",1029,6)
^SEQ #181
**END**
**END**
