EMERGENCY Released ECX*3*41 SEQ #40
Extracted from mail message
**KIDS**:ECX*3.0*41^

**INSTALL NAME**
ECX*3.0*41
"BLD",3373,0)
ECX*3.0*41^DSS EXTRACTS^0^3020212^y
"BLD",3373,1,0)
^^2^2^3020204^^
"BLD",3373,1,1,0)
Please see the patch description in the NPM for complete details of this
"BLD",3373,1,2,0)
patch.
"BLD",3373,4,0)
^9.64PA^^
"BLD",3373,"KRN",0)
^9.67PA^19^17
"BLD",3373,"KRN",.4,0)
.4
"BLD",3373,"KRN",.401,0)
.401
"BLD",3373,"KRN",.402,0)
.402
"BLD",3373,"KRN",.403,0)
.403
"BLD",3373,"KRN",.5,0)
.5
"BLD",3373,"KRN",.84,0)
.84
"BLD",3373,"KRN",3.6,0)
3.6
"BLD",3373,"KRN",3.8,0)
3.8
"BLD",3373,"KRN",9.2,0)
9.2
"BLD",3373,"KRN",9.8,0)
9.8
"BLD",3373,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",3373,"KRN",9.8,"NM",1,0)
ECXMOV^^0^B13851533
"BLD",3373,"KRN",9.8,"NM",2,0)
ECXSURG^^0^B31893525
"BLD",3373,"KRN",9.8,"NM",3,0)
ECXUTL4^^0^B37662729
"BLD",3373,"KRN",9.8,"NM","B","ECXMOV",1)

"BLD",3373,"KRN",9.8,"NM","B","ECXSURG",2)

"BLD",3373,"KRN",9.8,"NM","B","ECXUTL4",3)

"BLD",3373,"KRN",19,0)
19
"BLD",3373,"KRN",19.1,0)
19.1
"BLD",3373,"KRN",101,0)
101
"BLD",3373,"KRN",409.61,0)
409.61
"BLD",3373,"KRN",771,0)
771
"BLD",3373,"KRN",870,0)
870
"BLD",3373,"KRN",8994,0)
8994
"BLD",3373,"KRN","B",.4,.4)

"BLD",3373,"KRN","B",.401,.401)

"BLD",3373,"KRN","B",.402,.402)

"BLD",3373,"KRN","B",.403,.403)

"BLD",3373,"KRN","B",.5,.5)

"BLD",3373,"KRN","B",.84,.84)

"BLD",3373,"KRN","B",3.6,3.6)

"BLD",3373,"KRN","B",3.8,3.8)

"BLD",3373,"KRN","B",9.2,9.2)

"BLD",3373,"KRN","B",9.8,9.8)

"BLD",3373,"KRN","B",19,19)

"BLD",3373,"KRN","B",19.1,19.1)

"BLD",3373,"KRN","B",101,101)

"BLD",3373,"KRN","B",409.61,409.61)

"BLD",3373,"KRN","B",771,771)

"BLD",3373,"KRN","B",870,870)

"BLD",3373,"KRN","B",8994,8994)

"BLD",3373,"QUES",0)
^9.62^^
"BLD",3373,"REQB",0)
^9.611^1^1
"BLD",3373,"REQB",1,0)
ECX*3.0*39^2
"BLD",3373,"REQB","B","ECX*3.0*39",1)

"MBREQ")
0
"PKG",513,-1)
1^1
"PKG",513,0)
DSS EXTRACTS^ECX^Decision Support System. (DSS)
"PKG",513,20,0)
^9.402P^^
"PKG",513,22,0)
^9.49I^1^1
"PKG",513,22,1,0)
3.0^3010109^3010108^100867
"PKG",513,22,1,"PAH",1,0)
41^3020212
"PKG",513,22,1,"PAH",1,1,0)
^^2^2^3020212
"PKG",513,22,1,"PAH",1,1,1,0)
Please see the patch description in the NPM for complete details of this
"PKG",513,22,1,"PAH",1,1,2,0)
patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","ECXMOV")
0^1^B13851533
"RTN","ECXMOV",1,0)
ECXMOV ;ALB/JAP,BIR/DMA,PTD-Transfer and Discharge Extract ; 10/29/96 13:36
"RTN","ECXMOV",2,0)
 ;;3.0;DSS EXTRACTS;**8,24,33,39,41**;Dec 22, 1997
"RTN","ECXMOV",3,0)
BEG ;entry point from option
"RTN","ECXMOV",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXMOV",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXMOV",6,0)
 Q
"RTN","ECXMOV",7,0)
 ;
"RTN","ECXMOV",8,0)
START ; start package specific extract
"RTN","ECXMOV",9,0)
 N ECXDSC,W,WTO,X1,X2,X
"RTN","ECXMOV",10,0)
 K ECXDD D FIELD^DID(405,.19,,"SPECIFIER","ECXDD")
"RTN","ECXMOV",11,0)
 S ECPRO=$E(+$P(ECXDD("SPECIFIER"),"P",2)) K ECXDD
"RTN","ECXMOV",12,0)
 S ECED=ECED+.3,QFLG=0
"RTN","ECXMOV",13,0)
 F ECM=2,3 S ECARG="ATT"_ECM,ECD=ECSD1 D  Q:QFLG
"RTN","ECXMOV",14,0)
 .F  S ECD=$O(^DGPM(ECARG,ECD)),ECDA=0 Q:('ECD)!(ECD>ECED)  D  Q:QFLG
"RTN","ECXMOV",15,0)
 ..F  S ECDA=$O(^DGPM(ECARG,ECD,ECDA)) Q:'ECDA  D  Q:QFLG
"RTN","ECXMOV",16,0)
 ...Q:'$D(^DGPM(ECDA,0))  S EC=^(0)
"RTN","ECXMOV",17,0)
 ...S ECXDFN=+$P(EC,U,3),ECMT=$P(EC,U,18),ECXDATE=$P(ECD,".")
"RTN","ECXMOV",18,0)
 ...K ECXPAT S OK=$$PAT^ECXUTL3(ECXDFN,ECXDATE,"1;",.ECXPAT)
"RTN","ECXMOV",19,0)
 ...I 'OK K ECXPAT Q
"RTN","ECXMOV",20,0)
 ...S ECXPNM=ECXPAT("NAME"),ECXSSN=ECXPAT("SSN"),ECXMPI=ECXPAT("MPI")
"RTN","ECXMOV",21,0)
 ...S ECTM=$$ECXTIME^ECXUTL(ECD)
"RTN","ECXMOV",22,0)
 ...S WTO=$P(EC,U,6),ECXWTO=$P($G(^DIC(42,+WTO,44)),U)
"RTN","ECXMOV",23,0)
 ...;
"RTN","ECXMOV",24,0)
 ...;reset EC to admission movement
"RTN","ECXMOV",25,0)
 ...S ECCA=$P(EC,U,14),EC=^DGPM(ECCA,0),ECA=$P(EC,U)
"RTN","ECXMOV",26,0)
 ...;
"RTN","ECXMOV",27,0)
 ...;-If transaction=Transfer,ECD (time) is ASIH (7chars) and >0, set
"RTN","ECXMOV",28,0)
 ...;-ECXDATE var to admit DT before calling function to get In/Out & TS
"RTN","ECXMOV",29,0)
 ...I ECM=2,$L($P(ECD,".",2))=7,+$E($P(ECD,".",2),7)>0 S ECXDATE=$P(ECA,".")
"RTN","ECXMOV",30,0)
 ...S X=$$INP^ECXUTL2(ECXDFN,ECXDATE),ECXA=$P(X,U),ECXDOM=$P(X,U,10),ECXTS=$P(X,U,3)
"RTN","ECXMOV",31,0)
 ...;if date of previous xfer movement is greater than admit date,
"RTN","ECXMOV",32,0)
 ...;then reset EC to that previous xfer movement
"RTN","ECXMOV",33,0)
 ...S ECDL=9999999.9999999-ECD,ECDL=+$O(^DGPM("ATID2",ECXDFN,ECDL))
"RTN","ECXMOV",34,0)
 ...S ECDAL=+$O(^DGPM("ATID2",ECXDFN,ECDL,0))
"RTN","ECXMOV",35,0)
 ...I $D(^DGPM(ECDAL,0)),$P(^(0),U)>$P(EC,U) S EC=^(0)
"RTN","ECXMOV",36,0)
 ...;losing ward is either previous xfer ward or admission ward
"RTN","ECXMOV",37,0)
 ...S (ECXWRD,ECXFAC,ECXDSSD)=""
"RTN","ECXMOV",38,0)
 ...S W=$P(EC,U,6) I W'="" D
"RTN","ECXMOV",39,0)
 ....S ECXWRD=$P($G(^DIC(42,W,44)),U),ECXFAC=$P($G(^DIC(42,W,0)),U,11)
"RTN","ECXMOV",40,0)
 ....S ECXDSSD=$P($G(^ECX(727.4,W,0)),U,2)
"RTN","ECXMOV",41,0)
 ...S ECDI=$S(ECM=2:"",1:$$ECXDATE^ECXUTL(ECD,ECXYM))
"RTN","ECXMOV",42,0)
 ...S X1=ECD,X2=$P(EC,U) D ^%DTC S ECXLOS=X
"RTN","ECXMOV",43,0)
 ...;
"RTN","ECXMOV",44,0)
 ...;- Get discharge PC Team, Primary and Assoc Primary Provider
"RTN","ECXMOV",45,0)
 ...S (ECXDPCT,ECXDPR,ECXDAPR)=""
"RTN","ECXMOV",46,0)
 ...I ECM=3 D
"RTN","ECXMOV",47,0)
 ....S ECXDSC=$$PRIMARY^ECXUTL2(ECXDFN,ECD)
"RTN","ECXMOV",48,0)
 ....S ECXDPCT=$P(ECXDSC,U),ECXDPR=$P(ECXDSC,U,2),ECXDAPR=$P(ECXDSC,U,5)
"RTN","ECXMOV",49,0)
 ...;
"RTN","ECXMOV",50,0)
 ...;- Observation patient indicator (YES/NO)
"RTN","ECXMOV",51,0)
 ...S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS)
"RTN","ECXMOV",52,0)
 ...;
"RTN","ECXMOV",53,0)
 ...;- If no encounter number, don't file record
"RTN","ECXMOV",54,0)
 ...S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECA,,ECXTS,ECXOBS,ECHEAD,,)
"RTN","ECXMOV",55,0)
 ...D:ECXENC'="" FILE
"RTN","ECXMOV",56,0)
 Q
"RTN","ECXMOV",57,0)
 ;
"RTN","ECXMOV",58,0)
FILE ;file the extract record
"RTN","ECXMOV",59,0)
 ;node0
"RTN","ECXMOV",60,0)
 ;fac ECXFAC^dfn ECXDFN^ssn ECXSSN^name ECXPNM^in/out ECXA^
"RTN","ECXMOV",61,0)
 ;day (ECD)^^adm date (ECA)^disc date ECDI^mov # ECDA^
"RTN","ECXMOV",62,0)
 ;type ECM^losing ward ECXWARD^treat spec ^los ECXLOS^^
"RTN","ECXMOV",63,0)
 ;movement type ECMT^mov time ECTM^gaining ward ECXWTO^
"RTN","ECXMOV",64,0)
 ;adm time (ECA)^^^
"RTN","ECXMOV",65,0)
 ;node1
"RTN","ECXMOV",66,0)
 ;mpi ECXMPI^dss dept ECXDSSD^dom ECXDOM^observ pat ind ECXOBS^
"RTN","ECXMOV",67,0)
 ;encounter num ECXENC^disch prim prov ECXDPR^disch PC team ECXDPCT^
"RTN","ECXMOV",68,0)
 ;disch assoc prim prov ECXDAPR
"RTN","ECXMOV",69,0)
 N DA,DIK
"RTN","ECXMOV",70,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXMOV",71,0)
 S ECODE=EC7_U_EC23_U_ECXFAC_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXMOV",72,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECD,ECXYM)_U_U
"RTN","ECXMOV",73,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECA,ECXYM)_U_ECDI_U_ECDA_U_ECM_U_ECXWRD_U
"RTN","ECXMOV",74,0)
 S ECODE=ECODE_U_ECXLOS_U_U_ECMT_U_ECTM_U_ECXWTO_U
"RTN","ECXMOV",75,0)
 S ECODE=ECODE_$$ECXTIME^ECXUTL(ECA)_U_U_U
"RTN","ECXMOV",76,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECXDOM_U_ECXOBS_U_ECXENC_U_ECXDPR_U
"RTN","ECXMOV",77,0)
 S ECODE1=ECODE1_ECXDPCT_U_ECXDAPR
"RTN","ECXMOV",78,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXMOV",79,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXMOV",80,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXMOV",81,0)
 Q
"RTN","ECXMOV",82,0)
 ;
"RTN","ECXMOV",83,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXMOV",84,0)
 S ECHEAD="MOV"
"RTN","ECXMOV",85,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXMOV",86,0)
 Q
"RTN","ECXMOV",87,0)
 ;
"RTN","ECXMOV",88,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXMOV",89,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXSURG")
0^2^B31893525
"RTN","ECXSURG",1,0)
ECXSURG ;ALB/JAP,BIR/DMA,PTD-Surgery Extract for DSS ; [ 03/20/97  3:04 PM ]
"RTN","ECXSURG",2,0)
 ;;3.0;DSS EXTRACTS;**1,11,8,13,25,24,33,39,41**;Dec 22, 1997
"RTN","ECXSURG",3,0)
BEG ;entry point from option
"RTN","ECXSURG",4,0)
 D SETUP I ECFILE="" Q
"RTN","ECXSURG",5,0)
 D ^ECXTRAC,^ECXKILL
"RTN","ECXSURG",6,0)
 Q
"RTN","ECXSURG",7,0)
 ;
"RTN","ECXSURG",8,0)
START ;
"RTN","ECXSURG",9,0)
 S QFLG=0,ECED=ECED+.3,ECD=ECSD1
"RTN","ECXSURG",10,0)
 F  S ECD=$O(^SRF("AC",ECD)),ECD0=0 Q:('ECD)!(ECD>ECED)!(QFLG)  D
"RTN","ECXSURG",11,0)
 .F  S ECD0=$O(^SRF("AC",ECD,ECD0)) Q:'ECD0  D
"RTN","ECXSURG",12,0)
 ..I $D(^SRF(ECD0,0)) S ECXDFN=+$P(^(0),U,1) D STUFF Q:QFLG
"RTN","ECXSURG",13,0)
 Q
"RTN","ECXSURG",14,0)
 ;
"RTN","ECXSURG",15,0)
STUFF ;gather data
"RTN","ECXSURG",16,0)
 N J,X,Y,PP,DATA1,DATA2,DATAOP,ARR,ERR,SUB,MOD,ECXNONL,ECXSTOP
"RTN","ECXSURG",17,0)
 S ECXDATE=ECD,ECXERR=0
"RTN","ECXSURG",18,0)
 Q:'$$PATDEM^ECXUTL2(ECXDFN,ECXDATE,"1;2;3;5;")
"RTN","ECXSURG",19,0)
 ;S ECXA1=$P(^SRF(ECD0,0),U,12),ECXA=$S(ECXA1="O":1,ECXA1="I":3,1:"")
"RTN","ECXSURG",20,0)
 ;I $L(ECXDOM) S ECXA=3
"RTN","ECXSURG",21,0)
 S ECXADD=$$ECXDATE^ECXUTL(ECXADMDT,ECXYM),EC0=^SRF(ECD0,0)
"RTN","ECXSURG",22,0)
 S DATA1=$S($D(^SRF(ECD0,.1)):^(.1),1:"")
"RTN","ECXSURG",23,0)
 S DATA2=$S($D(^SRF(ECD0,.2)):^(.2),1:"")
"RTN","ECXSURG",24,0)
 S DATAOP=$S($D(^SRF(ECD0,"OP")):^("OP"),1:"")
"RTN","ECXSURG",25,0)
 S ECNO=$G(^SRF(ECD0,"NON"))
"RTN","ECXSURG",26,0)
 ;get data
"RTN","ECXSURG",27,0)
 S ECSR=$P(DATA1,U,4),(ECATNPI,ECSANPI,ECSRNPI)="",ECAT=$P(DATA1,U,13)
"RTN","ECXSURG",28,0)
 S ECXTM=$$ECXTIME^ECXUTL($P(DATA2,U,10))
"RTN","ECXSURG",29,0)
 S ECXDIV=$S($D(^SRF(ECD0,8)):^(8),1:ECINST)
"RTN","ECXSURG",30,0)
 S ECSA=$P($G(^SRF(ECD0,.3)),U,4),ECO=$P(EC0,U,2)
"RTN","ECXSURG",31,0)
 S ECORTY=$P($G(^SRS(+ECO,2)),U),ECO=$P($G(^SRS(+ECO,0)),U)
"RTN","ECXSURG",32,0)
 S ECSS=$P($G(^SRO(137.45,+$P(EC0,U,4),0)),U,2)
"RTN","ECXSURG",33,0)
 S ECSS=$$RJ^XLFSTR($P($G(^DIC(45.3,+ECSS,0)),U),3,0)
"RTN","ECXSURG",34,0)
 S:ECSS="000" ECSS="999"
"RTN","ECXSURG",35,0)
 ;look for non-OR
"RTN","ECXSURG",36,0)
 S (ECNT,ECNL,ECXDSSD,ECXNONL,ECXSTOP)=""
"RTN","ECXSURG",37,0)
 I $P(ECNO,U)="Y" D
"RTN","ECXSURG",38,0)
 .S ECSR=$P(ECNO,U,6),ECAT=$P(ECNO,U,7)
"RTN","ECXSURG",39,0)
 .S ECXTM=$$ECXTIME^ECXUTL($P(ECNO,U,4))
"RTN","ECXSURG",40,0)
 .S A1=$P(ECNO,U,5),A2=$P(ECNO,U,4),TIME="##" D:(A1&A2) TIME S ECNT=TIME
"RTN","ECXSURG",41,0)
 .S (ECXNONL,ECNL)=+$P(ECNO,U,2),ECNL=$P($G(^ECX(728.44,ECNL,0)),U,9)
"RTN","ECXSURG",42,0)
 .S:ECNL="" ECNL="UNKNOWN"
"RTN","ECXSURG",43,0)
 .;
"RTN","ECXSURG",44,0)
 .;- Get DSS Stop Code to use in encounter number
"RTN","ECXSURG",45,0)
 .S ECXSTOP=$P($G(^ECX(728.44,ECXNONL,0)),U,4)
"RTN","ECXSURG",46,0)
 ;
"RTN","ECXSURG",47,0)
 ;- Cancelled/aborted surgery indicator (C/A)
"RTN","ECXSURG",48,0)
 S ECCAN=$P($G(^SRF(ECD0,30)),U)
"RTN","ECXSURG",49,0)
 I +ECCAN S ECCAN=$$CANC^ECXUTL4(ECNL,$P(DATA2,U,10))
"RTN","ECXSURG",50,0)
 ;get service of attending surgeon
"RTN","ECXSURG",51,0)
 S ECATSV=$P($G(^DIC(49,+$G(^VA(200,+ECAT,5)),730)),U)
"RTN","ECXSURG",52,0)
 ;add leading 2s for pointer to 200
"RTN","ECXSURG",53,0)
 S:ECAT ECAT="2"_ECAT S:ECSR ECSR="2"_ECSR S:ECSA ECSA="2"_ECSA
"RTN","ECXSURG",54,0)
 ;anesthesia technique
"RTN","ECXSURG",55,0)
 S ECANE="",PP=""
"RTN","ECXSURG",56,0)
 I $D(^SRF(ECD0,6,0)) S ECXJ=0 D
"RTN","ECXSURG",57,0)
 .F  S ECXJ=$O(^SRF(ECD0,6,ECXJ)) Q:('ECXJ)!(ECANE]"")  D
"RTN","ECXSURG",58,0)
 ..S PP=$P($G(^(ECXJ,0)),U,3) S:PP="Y" ECANE=$P(^(0),U,1)
"RTN","ECXSURG",59,0)
 .I ECANE="" S ECXJ=$O(^SRF(ECD0,6,0)) I ECXJ S ECANE=$P(^SRF(ECD0,6,ECXJ,0),U,1)
"RTN","ECXSURG",60,0)
 ;get primary procedure
"RTN","ECXSURG",61,0)
 ;ecode0=p^cpt code^^patient time^operation time^anesthesia time
"RTN","ECXSURG",62,0)
 S ECPT=+$P(DATAOP,U,2),ECXCMOD=""
"RTN","ECXSURG",63,0)
 K ARR,ERR D FIELD^DID(130,28,,"LABEL","ARR","ERR") I $D(ARR("LABEL")) D
"RTN","ECXSURG",64,0)
 .K ARR,ERR D FIELD^DID(130,28,,"GLOBAL SUBSCRIPT LOCATION","ARR","ERR")
"RTN","ECXSURG",65,0)
 .Q:$D(ERR("DIERR"))
"RTN","ECXSURG",66,0)
 .S SUB=$P(ARR("GLOBAL SUBSCRIPT LOCATION"),";"),MOD=0
"RTN","ECXSURG",67,0)
 .F  S MOD=$O(^SRF(ECD0,SUB,MOD)) Q:MOD'>0  D
"RTN","ECXSURG",68,0)
 ..S ECXCMOD=ECXCMOD_$P(^(MOD,0),U)_";"
"RTN","ECXSURG",69,0)
 S ECXCPT=$$CPT^ECXUTL3(ECPT,ECXCMOD)
"RTN","ECXSURG",70,0)
 S ECODE0="P"_U_U  ;ECPT_U
"RTN","ECXSURG",71,0)
 F J="10,12","2,3","1,4" D
"RTN","ECXSURG",72,0)
 .S A2=$P(DATA2,U,$P(J,",")),A1=$P(DATA2,U,$P(J,",",2)),TIME="##"
"RTN","ECXSURG",73,0)
 .I (A1&A2)&(+J'=2) D TIME
"RTN","ECXSURG",74,0)
 .I (A1&A2)&(+J=2) D
"RTN","ECXSURG",75,0)
 ..S TIME=$TR($J($$FMDIFF^XLFDT(A1,A2,2)/900,4,0)," ")
"RTN","ECXSURG",76,0)
 ..S:TIME<0 TIME="###"
"RTN","ECXSURG",77,0)
 .S ECODE0=ECODE0_U_TIME K TIME
"RTN","ECXSURG",78,0)
 S ECRR=""
"RTN","ECXSURG",79,0)
 I $D(^SRF(ECD0,1.1)) D
"RTN","ECXSURG",80,0)
 .S A1=$P(^(1.1),U,8),A2=$P(^(1.1),U,7),TIME="##" D:(A1&A2) TIME
"RTN","ECXSURG",81,0)
 .S ECRR=TIME K TIME
"RTN","ECXSURG",82,0)
 I ECNL]"" S $P(ECODE0,U,5)=ECNT
"RTN","ECXSURG",83,0)
 ;
"RTN","ECXSURG",84,0)
 ;- Observation Patient Indicator (yes/no)
"RTN","ECXSURG",85,0)
 S ECXOBS=$$OBSPAT^ECXUTL4(ECXA,ECXTS,ECNL)
"RTN","ECXSURG",86,0)
 ;
"RTN","ECXSURG",87,0)
 ;- If no encounter number don't file record
"RTN","ECXSURG",88,0)
 S ECXENC=$$ENCNUM^ECXUTL4(ECXA,ECXSSN,ECXADMDT,ECXDATE,ECXTS,ECXOBS,ECHEAD,ECXSTOP,ECSS) Q:ECXENC=""
"RTN","ECXSURG",89,0)
 D FILE
"RTN","ECXSURG",90,0)
 ;get secondary procedures
"RTN","ECXSURG",91,0)
 ;ecode0=s^cpt code
"RTN","ECXSURG",92,0)
 S ECXJ=0
"RTN","ECXSURG",93,0)
 F  S ECXJ=$O(^SRF(ECD0,13,ECXJ)) Q:'ECXJ  I $D(^(ECXJ,0)),$D(^(2)),$P(^(2),U)]"" D
"RTN","ECXSURG",94,0)
 .S ECPT=$P(^SRF(ECD0,13,ECXJ,2),U),ECXCMOD=""
"RTN","ECXSURG",95,0)
 .K ARR,ERR
"RTN","ECXSURG",96,0)
 .D FIELD^DID(130.16,4,,"LABEL","ARR","ERR") I $D(ARR("LABEL")) D
"RTN","ECXSURG",97,0)
 ..K ARR,ERR
"RTN","ECXSURG",98,0)
 ..D FIELD^DID(130.16,4,,"GLOBAL SUBSCRIPT LOCATION","ARR","ERR")
"RTN","ECXSURG",99,0)
 ..Q:$D(ERR("DIERR"))
"RTN","ECXSURG",100,0)
 ..S SUB=$P(ARR("GLOBAL SUBSCRIPT LOCATION"),";"),MOD=0
"RTN","ECXSURG",101,0)
 ..F  S MOD=$O(^SRF(ECD0,13,ECXJ,SUB,MOD)) Q:MOD'>0  S ECXCMOD=ECXCMOD_$P(^(MOD,0),U)_";"
"RTN","ECXSURG",102,0)
 .S ECXCPT=$$CPT^ECXUTL3(ECPT,ECXCMOD)
"RTN","ECXSURG",103,0)
 .S ECODE0="S"_U   ;_ECPT
"RTN","ECXSURG",104,0)
 .D FILE
"RTN","ECXSURG",105,0)
 ;get prostheses
"RTN","ECXSURG",106,0)
 ;ecode0=i^^^^^^prosthesis^quantity
"RTN","ECXSURG",107,0)
 S ECXJ=0
"RTN","ECXSURG",108,0)
 F  S ECXJ=$O(^SRF(ECD0,1,ECXJ)) Q:'ECXJ  I $D(^(ECXJ,0)) D
"RTN","ECXSURG",109,0)
 .S ECXP=+^SRF(ECD0,1,ECXJ,0),ECXQ=$P($G(^(1)),U,2) S:'ECXQ ECXQ=1
"RTN","ECXSURG",110,0)
 .S ECODE0="I"_U_U_U_U_U_U_ECXP_U_ECXQ
"RTN","ECXSURG",111,0)
 .D FILE
"RTN","ECXSURG",112,0)
 Q
"RTN","ECXSURG",113,0)
 ;
"RTN","ECXSURG",114,0)
FILE ;file record
"RTN","ECXSURG",115,0)
 ;node0
"RTN","ECXSURG",116,0)
 ;division^dfn^ssn^name^in/out (ECXA)^day^case #^
"RTN","ECXSURG",117,0)
 ;surg specialty^or room #^
"RTN","ECXSURG",118,0)
 ;surgeon^attending^anesthesia supervisor^anesthesia technique^
"RTN","ECXSURG",119,0)
 ;primary/secondary/prostheses^cpt^^pt time^op time^anes time^
"RTN","ECXSURG",120,0)
 ;prostheses^qty^^
"RTN","ECXSURG",121,0)
 ;movement number^treating specialty^cancel/abort (ECCAN)^time^or type^
"RTN","ECXSURG",122,0)
 ;attending's service^non-or dss id^recovery room time^^
"RTN","ECXSURG",123,0)
 ;primary care team^primary care provider^admission date
"RTN","ECXSURG",124,0)
 ;node1
"RTN","ECXSURG",125,0)
 ;mpi^dss dept^surgeon npi^attending npi^anes supervisor npi^
"RTN","ECXSURG",126,0)
 ;pc provider npi^pc prov person class^
"RTN","ECXSURG",127,0)
 ;assoc pc provider^assoc pc prov person class^assoc pc prov npi^
"RTN","ECXSURG",128,0)
 ;cpt&modifiers ECXCPT^dom ECXDOM^enrollment category ECXCAT^
"RTN","ECXSURG",129,0)
 ;enrollment status ECXSTAT^enrollment priority ECXPRIOR^
"RTN","ECXSURG",130,0)
 ;period of service ECXPOS^purple heart indicator ECXPHI^
"RTN","ECXSURG",131,0)
 ;observ pat ind ECXOBS^encounter num ECXENC^ao loc ECXAOL
"RTN","ECXSURG",132,0)
 N DA,DIK,STR
"RTN","ECXSURG",133,0)
 S EC7=$O(^ECX(ECFILE,999999999),-1),EC7=EC7+1
"RTN","ECXSURG",134,0)
 S ECODE=EC7_U_EC23_U_ECXDIV_U_ECXDFN_U_ECXSSN_U_ECXPNM_U_ECXA_U
"RTN","ECXSURG",135,0)
 S ECODE=ECODE_$$ECXDATE^ECXUTL(ECXDATE,ECXYM)_U_ECD0_U_ECSS_U_ECO_U
"RTN","ECXSURG",136,0)
 S ECODE=ECODE_ECSR_U_ECAT_U_ECSA_U_ECANE_U_ECODE0_U
"RTN","ECXSURG",137,0)
 S STR=ECXMN_U_ECXTS_U_$S(ECCAN'="":ECCAN,1:"")_U_ECXTM_U_ECORTY_U
"RTN","ECXSURG",138,0)
 S STR=STR_ECATSV_U_ECNL_U_ECRR_U_U_ECPTTM_U_ECPTPR_U_ECXADD_U
"RTN","ECXSURG",139,0)
 S $P(ECODE,U,26,38)=STR
"RTN","ECXSURG",140,0)
 S ECODE1=ECXMPI_U_ECXDSSD_U_ECSRNPI_U_ECATNPI_U_ECSANPI_U_ECPTNPI_U
"RTN","ECXSURG",141,0)
 S ECODE1=ECODE1_ECCLAS_U_ECASPR_U_ECCLAS2_U_ECASNPI_U_ECXCPT_U_ECXDOM_U
"RTN","ECXSURG",142,0)
 S ECODE1=ECODE1_ECXCAT_U_ECXSTAT_U_ECXPRIOR_U_ECXPOS_U_ECXPHI_U
"RTN","ECXSURG",143,0)
 S ECODE1=ECODE1_ECXOBS_U_ECXENC_U_ECXAOL
"RTN","ECXSURG",144,0)
 S ^ECX(ECFILE,EC7,0)=ECODE,^ECX(ECFILE,EC7,1)=ECODE1,ECRN=ECRN+1
"RTN","ECXSURG",145,0)
 S DA=EC7,DIK="^ECX("_ECFILE_"," D IX1^DIK K DIK,DA
"RTN","ECXSURG",146,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S QFLG=1
"RTN","ECXSURG",147,0)
 ;
"RTN","ECXSURG",148,0)
TIME ; given date/time get increment
"RTN","ECXSURG",149,0)
 ;A1=later, A2=earlier, TIME=difference
"RTN","ECXSURG",150,0)
 N CON
"RTN","ECXSURG",151,0)
 S CON=$P($G(^SRF(ECD0,"CON")),U)
"RTN","ECXSURG",152,0)
 I 'CON D
"RTN","ECXSURG",153,0)
 .S TIME=$J($TR($J($$FMDIFF^XLFDT(A1,A2,2)/900,4,0)," "),2,1)
"RTN","ECXSURG",154,0)
 .S:TIME>"99.0" TIME="99.0"
"RTN","ECXSURG",155,0)
 I CON D
"RTN","ECXSURG",156,0)
 .S TIME=$J(($TR($J($$FMDIFF^XLFDT(A1,A2,2)/900,4,0)," ")/2),2,1)
"RTN","ECXSURG",157,0)
 .S:TIME>"99.5" TIME="99.5"
"RTN","ECXSURG",158,0)
 S:TIME<0 TIME="###"
"RTN","ECXSURG",159,0)
 Q
"RTN","ECXSURG",160,0)
 ;
"RTN","ECXSURG",161,0)
SETUP ;Set required input for ECXTRAC
"RTN","ECXSURG",162,0)
 S ECHEAD="SUR"
"RTN","ECXSURG",163,0)
 D ECXDEF^ECXUTL2(ECHEAD,.ECPACK,.ECGRP,.ECFILE,.ECRTN,.ECPIECE,.ECVER)
"RTN","ECXSURG",164,0)
 Q
"RTN","ECXSURG",165,0)
 ;
"RTN","ECXSURG",166,0)
QUE ; entry point for the background requeuing handled by ECXTAUTO
"RTN","ECXSURG",167,0)
 D SETUP,QUE^ECXTAUTO,^ECXKILL Q
"RTN","ECXUTL4")
0^3^B37662729
"RTN","ECXUTL4",1,0)
ECXUTL4 ;ALB/ESD - Utilities for DSS Extracts ;July 7, 2001
"RTN","ECXUTL4",2,0)
 ;;3.0;DSS EXTRACTS;**39,41**;Dec 22,1997
"RTN","ECXUTL4",3,0)
 ;
"RTN","ECXUTL4",4,0)
OBSPAT(ECXIO,ECXTS,DSSID) ;
"RTN","ECXUTL4",5,0)
 ; Get observation patient indicator from DSS TREATING SPECIALTY
"RTN","ECXUTL4",6,0)
 ; TRANSLATION file (#727.831) or DSS Identifier
"RTN","ECXUTL4",7,0)
 ;
"RTN","ECXUTL4",8,0)
 ; Input:
"RTN","ECXUTL4",9,0)
 ;   ECXIO  - Inpatient/Outpatient indicator
"RTN","ECXUTL4",10,0)
 ;   ECXTS  - Treating specialty (from file #42.4)
"RTN","ECXUTL4",11,0)
 ;   DSSID  - DSS Identifier
"RTN","ECXUTL4",12,0)
 ;
"RTN","ECXUTL4",13,0)
 ;Output:
"RTN","ECXUTL4",14,0)
 ;   ECXOBS - Observation patient indicator (YES/NO)
"RTN","ECXUTL4",15,0)
 ;
"RTN","ECXUTL4",16,0)
 ;
"RTN","ECXUTL4",17,0)
 ;- Check input vars
"RTN","ECXUTL4",18,0)
 S ECXIO=$G(ECXIO),ECXTS=+$G(ECXTS),DSSID=+$G(DSSID)
"RTN","ECXUTL4",19,0)
 S ECXOBS=""
"RTN","ECXUTL4",20,0)
 ;
"RTN","ECXUTL4",21,0)
 D
"RTN","ECXUTL4",22,0)
 .;
"RTN","ECXUTL4",23,0)
 .;- Look up obs patient indicator if treating spec is in file #727.831
"RTN","ECXUTL4",24,0)
 . I $G(^ECX(727.831,ECXTS,0)) S ECXOBS=$P($G(^ECX(727.831,ECXTS,0)),"^",4)
"RTN","ECXUTL4",25,0)
 . I ECXOBS'="" S ECXOBS=$S(ECXOBS="Y":"YES",1:"NO") Q
"RTN","ECXUTL4",26,0)
 .;
"RTN","ECXUTL4",27,0)
 .;- If outpatient and TS not in file, AND Feeder Key (CLI) or DSS ID
"RTN","ECXUTL4",28,0)
 .;- (MTL,IVP,ECQ,QSR,NOS,SUR) is 290-296, Observation Patient Ind=YES
"RTN","ECXUTL4",29,0)
 . I ECXIO="O",ECXOBS="",DSSID D
"RTN","ECXUTL4",30,0)
 .. I $E(DSSID,1,3)>289&($E(DSSID,1,3)<297) S ECXOBS="YES"
"RTN","ECXUTL4",31,0)
 .. E  S ECXOBS="NO"
"RTN","ECXUTL4",32,0)
 Q $S(ECXOBS'="":ECXOBS,1:"NO")
"RTN","ECXUTL4",33,0)
 ;
"RTN","ECXUTL4",34,0)
 ;
"RTN","ECXUTL4",35,0)
INOUTP(ECXTS) ;
"RTN","ECXUTL4",36,0)
 ; Get inpatient/outpatient indicator from DSS TREATING SPECIALTY
"RTN","ECXUTL4",37,0)
 ; TRANSLATION file (#727.831)
"RTN","ECXUTL4",38,0)
 ;
"RTN","ECXUTL4",39,0)
 ; Input:
"RTN","ECXUTL4",40,0)
 ;   ECXTS   - Treating specialty
"RTN","ECXUTL4",41,0)
 ;
"RTN","ECXUTL4",42,0)
 ;Output:
"RTN","ECXUTL4",43,0)
 ;             Inpatient/Outpatient indicator (I/O)
"RTN","ECXUTL4",44,0)
 ;
"RTN","ECXUTL4",45,0)
 ;
"RTN","ECXUTL4",46,0)
 S ECXTS=+$G(ECXTS)
"RTN","ECXUTL4",47,0)
 S ECXIO=""
"RTN","ECXUTL4",48,0)
 ;
"RTN","ECXUTL4",49,0)
 ;- Look up inpat/outpat indicator if treating spec is in file
"RTN","ECXUTL4",50,0)
 I $G(^ECX(727.831,ECXTS,0)) S ECXIO=$P($G(^ECX(727.831,ECXTS,0)),"^",5)
"RTN","ECXUTL4",51,0)
 Q $S(ECXIO'="":ECXIO,1:"I")
"RTN","ECXUTL4",52,0)
 ;
"RTN","ECXUTL4",53,0)
 ;
"RTN","ECXUTL4",54,0)
ENCNUM(ECXIO,ECXSSN,ECXADT,ECXVDT,ECXTRT,ECXOBS,ECXEXT,ECXSTP,ECXSTP2) ;
"RTN","ECXUTL4",55,0)
 ; Get encounter number
"RTN","ECXUTL4",56,0)
 ;
"RTN","ECXUTL4",57,0)
 ; Input:
"RTN","ECXUTL4",58,0)
 ;   ECXIO   - Inpat/Outpat indicator = I or O
"RTN","ECXUTL4",59,0)
 ;   ECXSSN  - Patient SSN
"RTN","ECXUTL4",60,0)
 ;   ECXADT  - Admit Date
"RTN","ECXUTL4",61,0)
 ;   ECXVDT  - Visit Date
"RTN","ECXUTL4",62,0)
 ;   ECXTRT  - Treating Spec
"RTN","ECXUTL4",63,0)
 ;   ECXOBS  - Observation Pat Indicator
"RTN","ECXUTL4",64,0)
 ;   ECXEXT  - Extract
"RTN","ECXUTL4",65,0)
 ;   ECXSTP  - Stop Code (or stop code related) variable
"RTN","ECXUTL4",66,0)
 ;   ECXSTP2 - Stop Code (or stop code related) addtl variable
"RTN","ECXUTL4",67,0)
 ;             (used for SUR and ECS)
"RTN","ECXUTL4",68,0)
 ;
"RTN","ECXUTL4",69,0)
 ;Output:
"RTN","ECXUTL4",70,0)
 ;             Encounter Number
"RTN","ECXUTL4",71,0)
 ;
"RTN","ECXUTL4",72,0)
 N ENCNUM,ECXDATE,ECXSTCD
"RTN","ECXUTL4",73,0)
 S (ENCNUM,ECXSTCD)=""
"RTN","ECXUTL4",74,0)
 ;
"RTN","ECXUTL4",75,0)
 ;- Check input vars
"RTN","ECXUTL4",76,0)
 S ECXEXT=$G(ECXEXT),ECXIO=$G(ECXIO),ECXOBS=$G(ECXOBS),ECXTRT=+$G(ECXTRT)
"RTN","ECXUTL4",77,0)
 S ECXSTP=+$G(ECXSTP),ECXSTP2=+$G(ECXSTP2),ECXADT=+$G(ECXADT),ECXVDT=+$G(ECXVDT)
"RTN","ECXUTL4",78,0)
 ;
"RTN","ECXUTL4",79,0)
 ;- Don't use pseudo-SSN in encounter number
"RTN","ECXUTL4",80,0)
 S ECXSSN=$E($G(ECXSSN),1,9)
"RTN","ECXUTL4",81,0)
 ;
"RTN","ECXUTL4",82,0)
 D
"RTN","ECXUTL4",83,0)
 . ;
"RTN","ECXUTL4",84,0)
 . ;- Inpatient
"RTN","ECXUTL4",85,0)
 . I ECXIO="I",ECXADT,ECXSSN'="" D  Q
"RTN","ECXUTL4",86,0)
 .. S ECXDATE=$$ADMITDT(ECXADT)
"RTN","ECXUTL4",87,0)
 .. I ECXDATE'="" S ENCNUM=ECXSSN_ECXDATE_"I"
"RTN","ECXUTL4",88,0)
 . ;
"RTN","ECXUTL4",89,0)
 . ;- Outpatient branch
"RTN","ECXUTL4",90,0)
 . I ECXIO="O" D
"RTN","ECXUTL4",91,0)
 .. ;
"RTN","ECXUTL4",92,0)
 .. ;- Observation patient (outpatient)
"RTN","ECXUTL4",93,0)
 .. I ECXOBS="YES",ECXSSN'="" D  Q
"RTN","ECXUTL4",94,0)
 ... ;
"RTN","ECXUTL4",95,0)
 ... S ECXDATE=$S(ECXADT:$$JULDT(ECXADT),1:$$JULDT(ECXVDT))
"RTN","ECXUTL4",96,0)
 ... S ECXSTCD=$S(+$P($G(^ECX(727.831,ECXTRT,0)),"^",6):+$P($G(^ECX(727.831,ECXTRT,0)),"^",6),1:+$E(ECXSTP,1,3))
"RTN","ECXUTL4",97,0)
 ... Q:ECXDATE=""!(ECXSTCD="")
"RTN","ECXUTL4",98,0)
 ... S ENCNUM=ECXSSN_ECXDATE_ECXSTCD
"RTN","ECXUTL4",99,0)
 .. ;
"RTN","ECXUTL4",100,0)
 .. ;- Outpatient (no observation pat)
"RTN","ECXUTL4",101,0)
 .. I ECXOBS="NO",ECXVDT,ECXSSN'="" D  Q
"RTN","ECXUTL4",102,0)
 ... ;
"RTN","ECXUTL4",103,0)
 ... ;- ADM, MOV, TRT have no outpat encounter number
"RTN","ECXUTL4",104,0)
 ... I ECXEXT="ADM"!(ECXEXT="MOV")!(ECXEXT="TRT") Q
"RTN","ECXUTL4",105,0)
 ... ;
"RTN","ECXUTL4",106,0)
 ... ;- Use 1st 3 chars of DSS ID for NOS and ECQ (feeder key for CLI)
"RTN","ECXUTL4",107,0)
 ... I ECXEXT="CLI"!(ECXEXT="NOS")!(ECXEXT="ECQ") S ECXSTCD=+$E(ECXSTP,1,3) Q:'ECXSTCD
"RTN","ECXUTL4",108,0)
 ... ;
"RTN","ECXUTL4",109,0)
 ... ;- Use cost center to obtain stop code for ECS
"RTN","ECXUTL4",110,0)
 ... I ECXEXT="ECS" D  Q:'ECXSTCD
"RTN","ECXUTL4",111,0)
 .... S ECXSTCD=$$ECSCOST(ECXSTP2)
"RTN","ECXUTL4",112,0)
 ....;
"RTN","ECXUTL4",113,0)
 ....;- If no cost center, use 1st 3 chars of DSS ID
"RTN","ECXUTL4",114,0)
 .... I ECXSTCD="" S ECXSTCD=+$E(ECXSTP,1,3)
"RTN","ECXUTL4",115,0)
 ... ;
"RTN","ECXUTL4",116,0)
 ... ;- These extracts have predetermined stop code values
"RTN","ECXUTL4",117,0)
 ... I ECXEXT="DEN" S ECXSTCD=180
"RTN","ECXUTL4",118,0)
 ... ;
"RTN","ECXUTL4",119,0)
 ... I ECXEXT="IVP"!(ECXEXT="PRE")!(ECXEXT="UDP") S ECXSTCD=160
"RTN","ECXUTL4",120,0)
 ... ;
"RTN","ECXUTL4",121,0)
 ... I ECXEXT="LAB"!(ECXEXT="LAR") S ECXSTCD=108
"RTN","ECXUTL4",122,0)
 ... ;
"RTN","ECXUTL4",123,0)
 ... I ECXEXT="MTL" S ECXSTCD=538
"RTN","ECXUTL4",124,0)
 ... ;
"RTN","ECXUTL4",125,0)
 ... I ECXEXT="NUR" S ECXSTCD=950
"RTN","ECXUTL4",126,0)
 ... ;
"RTN","ECXUTL4",127,0)
 ... I ECXEXT="PRO" S ECXSTCD=423
"RTN","ECXUTL4",128,0)
 ... ;
"RTN","ECXUTL4",129,0)
 ... ;- If Imaging Type fld=2, use 109 otherwise use 105
"RTN","ECXUTL4",130,0)
 ... I ECXEXT="RAD" S ECXSTCD=$S(ECXSTP=2:109,1:105)
"RTN","ECXUTL4",131,0)
 ... ;
"RTN","ECXUTL4",132,0)
 ... ;- Use DSS STOP CODE fld if populated or if SURG SPEC fld=59 use 430
"RTN","ECXUTL4",133,0)
 ... ;- otherwise if null use 429
"RTN","ECXUTL4",134,0)
 ... I ECXEXT="SUR" S ECXSTCD=$S(ECXSTP:ECXSTP,ECXSTP2=59:430,1:429)
"RTN","ECXUTL4",135,0)
 ... ;
"RTN","ECXUTL4",136,0)
 ... ;- Get Julian Date
"RTN","ECXUTL4",137,0)
 ... S ECXDATE=$$JULDT(ECXVDT)
"RTN","ECXUTL4",138,0)
 ... I ECXDATE'="" S ENCNUM=ECXSSN_ECXDATE_ECXSTCD
"RTN","ECXUTL4",139,0)
 ;
"RTN","ECXUTL4",140,0)
 Q ENCNUM
"RTN","ECXUTL4",141,0)
 ;
"RTN","ECXUTL4",142,0)
 ;
"RTN","ECXUTL4",143,0)
ADMITDT(ECXINDT) ; Returns date in YYMMDD format
"RTN","ECXUTL4",144,0)
 ;
"RTN","ECXUTL4",145,0)
 ; Input:
"RTN","ECXUTL4",146,0)
 ;   ECXINDT - Date (can also include time) in internal FM format
"RTN","ECXUTL4",147,0)
 ;
"RTN","ECXUTL4",148,0)
 ;Output:
"RTN","ECXUTL4",149,0)
 ;             Date in YYMMDD form
"RTN","ECXUTL4",150,0)
 ;
"RTN","ECXUTL4",151,0)
 N ECXDT
"RTN","ECXUTL4",152,0)
 S ECXDT=""
"RTN","ECXUTL4",153,0)
 S ECXINDT=+$G(ECXINDT)
"RTN","ECXUTL4",154,0)
 ;
"RTN","ECXUTL4",155,0)
 ;- If no input or full FM date not passed in, quit
"RTN","ECXUTL4",156,0)
 I 'ECXINDT!($L(ECXINDT)<7) G ADMTDTQ
"RTN","ECXUTL4",157,0)
 ;
"RTN","ECXUTL4",158,0)
 ;- Date in YYMMDD form
"RTN","ECXUTL4",159,0)
 S ECXDT=$TR($$FMTE^XLFDT(ECXINDT,"4DF")," /","0")
"RTN","ECXUTL4",160,0)
ADMTDTQ Q ECXDT
"RTN","ECXUTL4",161,0)
 ;
"RTN","ECXUTL4",162,0)
 ;
"RTN","ECXUTL4",163,0)
JULDT(ECXINDT) ;  Returns Julian Date in MMDDD format
"RTN","ECXUTL4",164,0)
 ;
"RTN","ECXUTL4",165,0)
 ; Input:
"RTN","ECXUTL4",166,0)
 ;   ECINDT  - Date (can also include time) in internal FM format
"RTN","ECXUTL4",167,0)
 ;
"RTN","ECXUTL4",168,0)
 ;Output:
"RTN","ECXUTL4",169,0)
 ;             Julian date in MM_DDD form
"RTN","ECXUTL4",170,0)
 ;
"RTN","ECXUTL4",171,0)
 ;
"RTN","ECXUTL4",172,0)
 N ECXDDD,ECXDT,ECXJUL,ECXMM
"RTN","ECXUTL4",173,0)
 S (ECXDDD,ECXMM)=""
"RTN","ECXUTL4",174,0)
 ;
"RTN","ECXUTL4",175,0)
 ;- If no input or full FM date not passed in, quit
"RTN","ECXUTL4",176,0)
 S ECXINDT=+$G(ECXINDT)
"RTN","ECXUTL4",177,0)
 I 'ECXINDT!($L(ECXINDT)<7) G JULDTQ
"RTN","ECXUTL4",178,0)
 ;
"RTN","ECXUTL4",179,0)
 ;- Extract date portion
"RTN","ECXUTL4",180,0)
 S ECXDT=$E(ECXINDT,1,7)
"RTN","ECXUTL4",181,0)
 ;
"RTN","ECXUTL4",182,0)
 ;- Get month (MM)
"RTN","ECXUTL4",183,0)
 S ECXMM=$E(ECXINDT,2,3)
"RTN","ECXUTL4",184,0)
 ;
"RTN","ECXUTL4",185,0)
 ;- Number of day within year (DDD)
"RTN","ECXUTL4",186,0)
 S ECXDDD=$$RJ^XLFSTR($$FMDIFF^XLFDT(ECXDT,$E(ECXDT,1,3)_"0101",1)+1,3,"0")
"RTN","ECXUTL4",187,0)
JULDTQ Q ECXMM_ECXDDD
"RTN","ECXUTL4",188,0)
 ;
"RTN","ECXUTL4",189,0)
 ;
"RTN","ECXUTL4",190,0)
CNHSTAT(ECXDFN) ;  Get CNH (Contract Nursing Home) status
"RTN","ECXUTL4",191,0)
 ;
"RTN","ECXUTL4",192,0)
 ; Input:
"RTN","ECXUTL4",193,0)
 ;   ECXDFN  - Patient DFN
"RTN","ECXUTL4",194,0)
 ;
"RTN","ECXUTL4",195,0)
 ;Output:
"RTN","ECXUTL4",196,0)
 ;             CNH status (YES/NO)
"RTN","ECXUTL4",197,0)
 ;
"RTN","ECXUTL4",198,0)
 ;
"RTN","ECXUTL4",199,0)
 N ECXCNH
"RTN","ECXUTL4",200,0)
 S ECXDFN=+$G(ECXDFN)
"RTN","ECXUTL4",201,0)
 S ECXCNH=$P($G(^DPT(ECXDFN,"NHC")),U)
"RTN","ECXUTL4",202,0)
 Q $S(ECXCNH="Y":"YES",ECXCNH="N":"NO",1:"")
"RTN","ECXUTL4",203,0)
 ;
"RTN","ECXUTL4",204,0)
 ;
"RTN","ECXUTL4",205,0)
CANC(ECXNOR,ECXTMOR) ; Get Surgery Cancelled/Aborted Status
"RTN","ECXUTL4",206,0)
 ;
"RTN","ECXUTL4",207,0)
 ; Function called after determining CANCEL DATE in SURGERY record exists.
"RTN","ECXUTL4",208,0)
 ;
"RTN","ECXUTL4",209,0)
 ; Input:
"RTN","ECXUTL4",210,0)
 ;   ECXNOR   - Non-OR DSS ID
"RTN","ECXUTL4",211,0)
 ;   ECXTMOR  - Time Pat in OR
"RTN","ECXUTL4",212,0)
 ;
"RTN","ECXUTL4",213,0)
 ;Output:
"RTN","ECXUTL4",214,0)
 ;              Cancelled/aborted status (C/A)
"RTN","ECXUTL4",215,0)
 ;
"RTN","ECXUTL4",216,0)
 ;
"RTN","ECXUTL4",217,0)
 N ECXCANC
"RTN","ECXUTL4",218,0)
 S ECXCANC=""
"RTN","ECXUTL4",219,0)
 S ECXNOR=$G(ECXNOR)
"RTN","ECXUTL4",220,0)
 ;
"RTN","ECXUTL4",221,0)
 ;- If Non-OR DSS ID or Time Pat in OR, ECXCANC = "A" else = "C"
"RTN","ECXUTL4",222,0)
 D
"RTN","ECXUTL4",223,0)
 . I ECXNOR'=""&(ECXNOR'="UNKNOWN") S ECXCANC="A" Q
"RTN","ECXUTL4",224,0)
 . I +$G(ECXTMOR) S ECXCANC="A" Q
"RTN","ECXUTL4",225,0)
 . S ECXCANC="C"
"RTN","ECXUTL4",226,0)
 Q ECXCANC
"RTN","ECXUTL4",227,0)
 ;
"RTN","ECXUTL4",228,0)
 ;
"RTN","ECXUTL4",229,0)
ECSCOST(ECXCOST) ;Get ECS extract stop code based on cost center
"RTN","ECXUTL4",230,0)
 ;
"RTN","ECXUTL4",231,0)
 ;
"RTN","ECXUTL4",232,0)
 ; Input:
"RTN","ECXUTL4",233,0)
 ;   ECXCOST  - ECS extract cost center
"RTN","ECXUTL4",234,0)
 ;
"RTN","ECXUTL4",235,0)
 ;Output:
"RTN","ECXUTL4",236,0)
 ;              ECS extract stop code
"RTN","ECXUTL4",237,0)
 ;
"RTN","ECXUTL4",238,0)
 ;
"RTN","ECXUTL4",239,0)
 N ECXFND,ECXSTOP,I
"RTN","ECXUTL4",240,0)
 S ECXFND=0
"RTN","ECXUTL4",241,0)
 S ECXSTOP=""
"RTN","ECXUTL4",242,0)
 S ECXCOST=+$G(ECXCOST)
"RTN","ECXUTL4",243,0)
 ;
"RTN","ECXUTL4",244,0)
 D
"RTN","ECXUTL4",245,0)
 . I 'ECXCOST Q
"RTN","ECXUTL4",246,0)
 . F I=1:1 Q:ECXFND!($P($T(COST+I),";;",2)="END")  D
"RTN","ECXUTL4",247,0)
 .. I ECXCOST=$P($T(COST+I),";;",2) S ECXSTOP=$P($T(COST+I),";;",3),ECXFND=1
"RTN","ECXUTL4",248,0)
 Q ECXSTOP
"RTN","ECXUTL4",249,0)
 ;
"RTN","ECXUTL4",250,0)
COST ;- ECS Cost Center and stop code
"RTN","ECXUTL4",251,0)
 ;;833100;;652
"RTN","ECXUTL4",252,0)
 ;;833200;;653
"RTN","ECXUTL4",253,0)
 ;;833300;;681
"RTN","ECXUTL4",254,0)
 ;;834100;;651
"RTN","ECXUTL4",255,0)
 ;;834200;;650
"RTN","ECXUTL4",256,0)
 ;;834300;;681
"RTN","ECXUTL4",257,0)
 ;;834400;;654
"RTN","ECXUTL4",258,0)
 ;;834500;;681
"RTN","ECXUTL4",259,0)
 ;;834600;;681
"RTN","ECXUTL4",260,0)
 ;;834700;;681
"RTN","ECXUTL4",261,0)
 ;;834800;;681
"RTN","ECXUTL4",262,0)
 ;;834900;;681
"RTN","ECXUTL4",263,0)
 ;;836100;;654
"RTN","ECXUTL4",264,0)
 ;;836200;;654
"RTN","ECXUTL4",265,0)
 ;;END
"VER")
8.0^22.0
**END**
**END**
