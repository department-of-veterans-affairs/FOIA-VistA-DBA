Released PSO*7*220 SEQ #197
Extracted from mail message
**KIDS**:PSO*7.0*220^

**INSTALL NAME**
PSO*7.0*220
"BLD",5813,0)
PSO*7.0*220^OUTPATIENT PHARMACY^0^3050907^y
"BLD",5813,1,0)
^^10^10^3050902^
"BLD",5813,1,1,0)
This patch adds the NCPDP (National Council for Prescription Drug 
"BLD",5813,1,2,0)
Programs) number from the OUTPATIENT SITE file (#59) to the Outpatient
"BLD",5813,1,3,0)
Pharmacy VDEF (Vista Data Extraction Framework) message that sends
"BLD",5813,1,4,0)
prescription information to the HDR (Health Data Repository). VistA must
"BLD",5813,1,5,0)
collect and maintain this information and make this number readily 
"BLD",5813,1,6,0)
available for application interfaces to store and forward to meet 
"BLD",5813,1,7,0)
requirements for the CHDR (Clinical Data Repository / Health Data
"BLD",5813,1,8,0)
Repository) project to provide this number to the DoD (Department of
"BLD",5813,1,9,0)
Defense). This is a required field in the DoD PDTS (Pharmacy Data
"BLD",5813,1,10,0)
Transaction Service) application.
"BLD",5813,4,0)
^9.64PA^^
"BLD",5813,6)
1^
"BLD",5813,"KRN",0)
^9.67PA^8989.52^19
"BLD",5813,"KRN",.4,0)
.4
"BLD",5813,"KRN",.401,0)
.401
"BLD",5813,"KRN",.402,0)
.402
"BLD",5813,"KRN",.403,0)
.403
"BLD",5813,"KRN",.5,0)
.5
"BLD",5813,"KRN",.84,0)
.84
"BLD",5813,"KRN",3.6,0)
3.6
"BLD",5813,"KRN",3.8,0)
3.8
"BLD",5813,"KRN",9.2,0)
9.2
"BLD",5813,"KRN",9.8,0)
9.8
"BLD",5813,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5813,"KRN",9.8,"NM",1,0)
PSOVDF1^^0^B67244261
"BLD",5813,"KRN",9.8,"NM",2,0)
PSOVDF2^^0^B86129954
"BLD",5813,"KRN",9.8,"NM","B","PSOVDF1",1)

"BLD",5813,"KRN",9.8,"NM","B","PSOVDF2",2)

"BLD",5813,"KRN",19,0)
19
"BLD",5813,"KRN",19.1,0)
19.1
"BLD",5813,"KRN",101,0)
101
"BLD",5813,"KRN",409.61,0)
409.61
"BLD",5813,"KRN",771,0)
771
"BLD",5813,"KRN",870,0)
870
"BLD",5813,"KRN",8989.51,0)
8989.51
"BLD",5813,"KRN",8989.52,0)
8989.52
"BLD",5813,"KRN",8994,0)
8994
"BLD",5813,"KRN","B",.4,.4)

"BLD",5813,"KRN","B",.401,.401)

"BLD",5813,"KRN","B",.402,.402)

"BLD",5813,"KRN","B",.403,.403)

"BLD",5813,"KRN","B",.5,.5)

"BLD",5813,"KRN","B",.84,.84)

"BLD",5813,"KRN","B",3.6,3.6)

"BLD",5813,"KRN","B",3.8,3.8)

"BLD",5813,"KRN","B",9.2,9.2)

"BLD",5813,"KRN","B",9.8,9.8)

"BLD",5813,"KRN","B",19,19)

"BLD",5813,"KRN","B",19.1,19.1)

"BLD",5813,"KRN","B",101,101)

"BLD",5813,"KRN","B",409.61,409.61)

"BLD",5813,"KRN","B",771,771)

"BLD",5813,"KRN","B",870,870)

"BLD",5813,"KRN","B",8989.51,8989.51)

"BLD",5813,"KRN","B",8989.52,8989.52)

"BLD",5813,"KRN","B",8994,8994)

"BLD",5813,"QUES",0)
^9.62^^
"BLD",5813,"REQB",0)
^9.611^2^2
"BLD",5813,"REQB",1,0)
PSO*7.0*216^2
"BLD",5813,"REQB",2,0)
PSO*7.0*205^2
"BLD",5813,"REQB","B","PSO*7.0*205",2)

"BLD",5813,"REQB","B","PSO*7.0*216",1)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
220^3050907^11859
"PKG",141,22,1,"PAH",1,1,0)
^^10^10^3050907
"PKG",141,22,1,"PAH",1,1,1,0)
This patch adds the NCPDP (National Council for Prescription Drug 
"PKG",141,22,1,"PAH",1,1,2,0)
Programs) number from the OUTPATIENT SITE file (#59) to the Outpatient
"PKG",141,22,1,"PAH",1,1,3,0)
Pharmacy VDEF (Vista Data Extraction Framework) message that sends
"PKG",141,22,1,"PAH",1,1,4,0)
prescription information to the HDR (Health Data Repository). VistA must
"PKG",141,22,1,"PAH",1,1,5,0)
collect and maintain this information and make this number readily 
"PKG",141,22,1,"PAH",1,1,6,0)
available for application interfaces to store and forward to meet 
"PKG",141,22,1,"PAH",1,1,7,0)
requirements for the CHDR (Clinical Data Repository / Health Data
"PKG",141,22,1,"PAH",1,1,8,0)
Repository) project to provide this number to the DoD (Department of
"PKG",141,22,1,"PAH",1,1,9,0)
Defense). This is a required field in the DoD PDTS (Pharmacy Data
"PKG",141,22,1,"PAH",1,1,10,0)
Transaction Service) application.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSOVDF1")
0^1^B67244261
"RTN","PSOVDF1",1,0)
PSOVDF1 ;BPOIFO/EL-OUTPATIENT PHARMACY (PRES, PREF, PPAR) HL7 MESSAGE ;10/04/04
"RTN","PSOVDF1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**190,205,220**;DEC 1997
"RTN","PSOVDF1",3,0)
 ;
"RTN","PSOVDF1",4,0)
VALID ;;VDEF HL7 MESSAGE BUILDER
"RTN","PSOVDF1",5,0)
 ;
"RTN","PSOVDF1",6,0)
 ; DBIA #4248 - $$XCN200^VDEFEL (or <MultipleTag>^VDEFEL)
"RTN","PSOVDF1",7,0)
 ; DBIA #3552 - $$PARAM^HLCS2
"RTN","PSOVDF1",8,0)
 ; DBIA #3630 - BLDPID^VAFCQRY
"RTN","PSOVDF1",9,0)
 ; DBIA #10040 - 0-NODE of ^SC
"RTN","PSOVDF1",10,0)
 ; DBIA 4571 - ERR^VDEFREQ
"RTN","PSOVDF1",11,0)
 ;
"RTN","PSOVDF1",12,0)
 ; This routine is called at tag EN as a Function by VDEFREQ1
"RTN","PSOVDF1",13,0)
 ;
"RTN","PSOVDF1",14,0)
 Q
"RTN","PSOVDF1",15,0)
 ;
"RTN","PSOVDF1",16,0)
EN(EVIEN,KEY,VFLAG,OUT,MSHP) ;
"RTN","PSOVDF1",17,0)
 ; This routine creates one of three Outpatient Pharmacy HL7 messages:
"RTN","PSOVDF1",18,0)
 ; RDE^O11^PRES, RDS^O13^PREF, or RDS^O13^PPAR
"RTN","PSOVDF1",19,0)
 ;
"RTN","PSOVDF1",20,0)
 ; Input Parameters:
"RTN","PSOVDF1",21,0)
 ;    EVIEN - IEN of message in file 577
"RTN","PSOVDF1",22,0)
 ;    KEY -   IEN to File #52 ^PSRX
"RTN","PSOVDF1",23,0)
 ;    VFLAG - "V" for VistA HL7 destination (default)
"RTN","PSOVDF1",24,0)
 ;    OUT -   Target array.  Must be passed by reference
"RTN","PSOVDF1",25,0)
 ;    MSHP -  4th piece is SUBTYPE (PRES, PREF, PPAR)
"RTN","PSOVDF1",26,0)
 ;
"RTN","PSOVDF1",27,0)
 ; Returns:
"RTN","PSOVDF1",28,0)
 ;    Two piece string with separator '^':
"RTN","PSOVDF1",29,0)
 ;    Piece 1 - "LM" - LOCAL ARRAY
"RTN","PSOVDF1",30,0)
 ;    Piece 2 - MSH segment, is not set
"RTN","PSOVDF1",31,0)
 ;    OUT - OUTPUT array includes HL7 message for every segment except MSH
"RTN","PSOVDF1",32,0)
 ;              
"RTN","PSOVDF1",33,0)
 ;  Message Body "MSH,PID,ORC1,RXE1,RXR1,FT1,OBX1,NTE1,ORC2,ORC3"
"RTN","PSOVDF1",34,0)
 ;  The Pharmacy Original Fill message will be generated by pgm:PSOVDF2 - (ORC1. . NTE1)
"RTN","PSOVDF1",35,0)
 ;
"RTN","PSOVDF1",36,0)
 ;
"RTN","PSOVDF1",37,0)
 N CTR,D0,D1,DFN,DRCODE,DRUG,ERR,FILE,FIELD,GIVECODE,GL,GLOB,GLOBAL,HLINST
"RTN","PSOVDF1",38,0)
 N I,L,MSG,NTE,P,PSOVNUM,RES,SEPC,SEPE,SEPF,SEPR,SEPS,SRC,SUBTYPE
"RTN","PSOVDF1",39,0)
 N TEMP,TP,UNIT,VAL,WR,X,Y,Z
"RTN","PSOVDF1",40,0)
 ;
"RTN","PSOVDF1",41,0)
 S (ERR,TARGET)=""
"RTN","PSOVDF1",42,0)
 D INIT
"RTN","PSOVDF1",43,0)
 I $G(ERR)'="" D ERR^VDEFREQ(ERR) S ZTSTOP=1 G QUIT
"RTN","PSOVDF1",44,0)
 D MSHPID
"RTN","PSOVDF1",45,0)
 I $G(ERR)'="" D ERR^VDEFREQ(ERR) S ZTSTOP=1 G QUIT
"RTN","PSOVDF1",46,0)
 D PROCESS^PSOVDF2
"RTN","PSOVDF1",47,0)
 D ORC2
"RTN","PSOVDF1",48,0)
QUIT Q TARGET
"RTN","PSOVDF1",49,0)
 ;
"RTN","PSOVDF1",50,0)
INIT ; INITIALIZATION
"RTN","PSOVDF1",51,0)
 K GL,OUT,TEMP,TP
"RTN","PSOVDF1",52,0)
 S (D0,DFN,DRCODE,DRUG,FILE,GIVECODE,GLOB,SEPC,SEPE,SEPF,SEPR,SEPS,SRC,SUBTYPE,UNIT,VAL)=""
"RTN","PSOVDF1",53,0)
 S OUT("HLS")=0
"RTN","PSOVDF1",54,0)
 S (D0,PSOVNUM)=KEY
"RTN","PSOVDF1",55,0)
 I $G(U)="" S U="^"
"RTN","PSOVDF1",56,0)
 ;
"RTN","PSOVDF1",57,0)
 S FILE=52
"RTN","PSOVDF1",58,0)
 S SUBTYPE=$P($G(MSHP),"~",4)
"RTN","PSOVDF1",59,0)
 S VAL=$G(HL("ECH")) S:VAL="" VAL="~|\&"
"RTN","PSOVDF1",60,0)
 S SEPC=$E(VAL,1),SEPE=$E(VAL,3),SEPR=$E(VAL,2),SEPS=$E(VAL,4)
"RTN","PSOVDF1",61,0)
 S VAL=$G(HL("FS")) S:VAL="" VAL="^" S SEPF=$E(VAL,1)
"RTN","PSOVDF1",62,0)
 S GLOB=$$ROOT^DILFD(FILE)_D0_")"
"RTN","PSOVDF1",63,0)
 M GL=@GLOB
"RTN","PSOVDF1",64,0)
 S DFN=$P($G(GL(0)),U,2)
"RTN","PSOVDF1",65,0)
 I $G(DFN)="" S ERR="MISSING DFN IN FILE-52 AT IEN="_D0 Q
"RTN","PSOVDF1",66,0)
 I $G(^DPT(DFN,0))="" S ERR="MISSING DFN IN FILE-2 AT FILE-52/IEN="_D0 Q
"RTN","PSOVDF1",67,0)
 Q
"RTN","PSOVDF1",68,0)
 ;
"RTN","PSOVDF1",69,0)
PUT(P) ; Put in MSG
"RTN","PSOVDF1",70,0)
 I $G(VAL)="" Q
"RTN","PSOVDF1",71,0)
 S $P(MSG,SEPF,P)=VAL
"RTN","PSOVDF1",72,0)
 Q
"RTN","PSOVDF1",73,0)
 ;
"RTN","PSOVDF1",74,0)
REPL(L) ; REPLACE CHAR
"RTN","PSOVDF1",75,0)
 I $G(L)="" Q ""
"RTN","PSOVDF1",76,0)
 N X,Y,Z,RES
"RTN","PSOVDF1",77,0)
 S RES=L
"RTN","PSOVDF1",78,0)
 I $F(L,"\") S X=RES D
"RTN","PSOVDF1",79,0)
 . S Z=$P(X,"\",2,9999),Y=$P(X,"\")_"\E\"_Z,RES=Y,X=Z I '$F(Z,"\") Q
"RTN","PSOVDF1",80,0)
 . F I=2:1 S Z=$P(X,"\",2,9999),Y=$P(RES,"\E\",1,I-1)_"\E\"_$P(X,"\")_"\E\"_Z,RES=Y,X=Z I '$F(Z,"\") Q
"RTN","PSOVDF1",81,0)
 ;
"RTN","PSOVDF1",82,0)
 I $F(RES,"|") F I=1:1 S Y=$P(RES,"|")_"\R\"_$P(RES,"|",2,9999),RES=Y I '$F(RES,"|") Q
"RTN","PSOVDF1",83,0)
 I $F(RES,"^") F I=1:1 S Y=$P(RES,"^")_"\F\"_$P(RES,"^",2,9999),RES=Y I '$F(RES,"^") Q
"RTN","PSOVDF1",84,0)
 I $F(RES,"&") F I=1:1 S Y=$P(RES,"&")_"\T\"_$P(RES,"&",2,9999),RES=Y I '$F(RES,"&") Q
"RTN","PSOVDF1",85,0)
 I $F(RES,"~") F I=1:1 S Y=$P(RES,"~")_"\S\"_$P(RES,"~",2,9999),RES=Y I '$F(RES,"~") Q
"RTN","PSOVDF1",86,0)
 Q RES
"RTN","PSOVDF1",87,0)
 ;
"RTN","PSOVDF1",88,0)
 ;
"RTN","PSOVDF1",89,0)
OUT D OUT^PSOVDF2 Q
"RTN","PSOVDF1",90,0)
OUT20 D OUT20^PSOVDF2 Q
"RTN","PSOVDF1",91,0)
 ;
"RTN","PSOVDF1",92,0)
MSHPID ;
"RTN","PSOVDF1",93,0)
MSH ; MSH
"RTN","PSOVDF1",94,0)
 S (HLINST,MSG,SRC)=""
"RTN","PSOVDF1",95,0)
 I '$D(SITEPARM) S SITEPARM=$$PARAM^HLCS2
"RTN","PSOVDF1",96,0)
 S HLINST=$P(SITEPARM,U,6),SRC=HLINST_"_"_FILE
"RTN","PSOVDF1",97,0)
 S TARGET="LM"_SEPF_MSG
"RTN","PSOVDF1",98,0)
 ;
"RTN","PSOVDF1",99,0)
PID ; PID
"RTN","PSOVDF1",100,0)
 K WR
"RTN","PSOVDF1",101,0)
 S (MSG)=""
"RTN","PSOVDF1",102,0)
 D BLDPID^VAFCQRY(DFN,1,"",.WR,.HL,.ERR)
"RTN","PSOVDF1",103,0)
 I $G(WR(1))="" S ERR="MISSING PID AT DFN="_DFN_" IN FILE-52 AT IEN="_D0 Q
"RTN","PSOVDF1",104,0)
 I $P(WR(1),U,3)="V" S $P(WR(1),U,3)=""
"RTN","PSOVDF1",105,0)
 D OUT20
"RTN","PSOVDF1",106,0)
 K WR
"RTN","PSOVDF1",107,0)
 Q
"RTN","PSOVDF1",108,0)
 ;
"RTN","PSOVDF1",109,0)
ORC2 ; REFILL
"RTN","PSOVDF1",110,0)
 I '$D(GL(1)) G ORC3
"RTN","PSOVDF1",111,0)
 K TEMP M TEMP=GL(1)
"RTN","PSOVDF1",112,0)
 S D1=0
"RTN","PSOVDF1",113,0)
ORC2A S D1=$O(TEMP(D1)) G ORC3:(D1="")!(D1'?1.N)
"RTN","PSOVDF1",114,0)
 S MSG=""
"RTN","PSOVDF1",115,0)
 S VAL=D1 D PUT(3)
"RTN","PSOVDF1",116,0)
 S TP=TEMP(D1,0)
"RTN","PSOVDF1",117,0)
 ; (7~4-10.1)
"RTN","PSOVDF1",118,0)
 S (VAL,WR)="",WR=$P(TP,U,19) I $G(WR)'="" D
"RTN","PSOVDF1",119,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS"),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="DISPENSED"
"RTN","PSOVDF1",120,0)
 ; (7~5-13)
"RTN","PSOVDF1",121,0)
 S WR=$P(TP,U,15) I $G(WR)'="" D
"RTN","PSOVDF1",122,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS"),$P(VAL,SEPC,5)=WR,$P(VAL,SEPC,7)=$P(VAL,SEPC,7)_"/EXPIRATION"
"RTN","PSOVDF1",123,0)
 D PUT(7)
"RTN","PSOVDF1",124,0)
 S VAL="",$P(VAL,SEPC,2)=D0 D PUT(8)
"RTN","PSOVDF1",125,0)
 ; (9-7)
"RTN","PSOVDF1",126,0)
 S VAL=$P(TP,U,8) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") D PUT(9)
"RTN","PSOVDF1",127,0)
 ; (12-15)
"RTN","PSOVDF1",128,0)
 S VAL=$P(TP,U,17) I $G(VAL)'="" S VAL=$$XCN200^VDEFEL(VAL) D PUT(12)
"RTN","PSOVDF1",129,0)
 S VAL="REFILL" D PUT(16)
"RTN","PSOVDF1",130,0)
 S VAL=$P(TP,U,9) S:$G(VAL)="" VAL=$P($G(^PSRX(PSOVNUM,2)),"^",9) I $G(VAL)'="" D
"RTN","PSOVDF1",131,0)
 .N PSONCRF,PSONCRFP
"RTN","PSOVDF1",132,0)
 .S X=$G(^PS(59,VAL,0)),PSONCRFP=$P($G(^("SAND")),"^",3),VAL=$P(X,U) Q:VAL=""
"RTN","PSOVDF1",133,0)
 .S (VAL,PSONCRF)=$$REPL(VAL),VAL=$P(X,U,6)_SEPC_VAL_SEPC_HLINST_"_52.1_8"
"RTN","PSOVDF1",134,0)
 .I PSONCRFP'="" S VAL=VAL_SEPC_PSONCRFP_SEPC_PSONCRF_SEPC_"NCPDP"
"RTN","PSOVDF1",135,0)
 .D PUT(17)
"RTN","PSOVDF1",136,0)
 ;
"RTN","PSOVDF1",137,0)
 I $G(MSG)="" G ORC2Q
"RTN","PSOVDF1",138,0)
 S $P(MSG,U)="RF"
"RTN","PSOVDF1",139,0)
 S MSG="ORC"_SEPF_MSG D OUT
"RTN","PSOVDF1",140,0)
ORC2Q ; Q
"RTN","PSOVDF1",141,0)
 ;
"RTN","PSOVDF1",142,0)
RXE2 ; REFILL
"RTN","PSOVDF1",143,0)
 S MSG=""
"RTN","PSOVDF1",144,0)
 ; (1~4-.01)
"RTN","PSOVDF1",145,0)
 S (VAL,WR)="",WR=$P(TP,U,1) I $G(WR)'="" D
"RTN","PSOVDF1",146,0)
 . S WR=$$HLDATE^HLFNC(WR,"TS"),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="REFILL" D PUT(1)
"RTN","PSOVDF1",147,0)
 ; (2~1..~3-6, 2~4-API , 2~6-NDC)
"RTN","PSOVDF1",148,0)
 S VAL=""
"RTN","PSOVDF1",149,0)
 I $T(NDC^PSOHDR)]"" D
"RTN","PSOVDF1",150,0)
 .  S VAL=$$NDC^PSOHDR(D0,D1,"R")
"RTN","PSOVDF1",151,0)
 E  S VAL=$P($G(TEMP(D1,1)),U,3),VAL=$TR(VAL,"-","")
"RTN","PSOVDF1",152,0)
 I $G(VAL)'="" D
"RTN","PSOVDF1",153,0)
 .  S X="",X=GIVECODE,$P(X,SEPC,4)=VAL,$P(X,SEPC,6)="NDC",VAL=X D PUT(2)
"RTN","PSOVDF1",154,0)
 E  S VAL=GIVECODE D PUT(2)
"RTN","PSOVDF1",155,0)
 S VAL=0 D PUT(3)
"RTN","PSOVDF1",156,0)
 ; (5-DEF="UNK" or API)
"RTN","PSOVDF1",157,0)
 S VAL=UNIT D PUT(5)
"RTN","PSOVDF1",158,0)
 ; (8~6-2)
"RTN","PSOVDF1",159,0)
 S (VAL,WR)="",WR=$P(TP,U,2)
"RTN","PSOVDF1",160,0)
 I $G(WR)'="" S WR=$S((WR="M"):"MAIL",(WR="W"):"WINDOW",1:WR),$P(VAL,SEPC,6)=WR D PUT(8)
"RTN","PSOVDF1",161,0)
 ; (10-1)
"RTN","PSOVDF1",162,0)
 S VAL=$P(TP,U,4) D PUT(10)
"RTN","PSOVDF1",163,0)
 ; (14|1-4)
"RTN","PSOVDF1",164,0)
 S VAL=$P(TP,U,5) I $G(VAL)="" G RXE2A
"RTN","PSOVDF1",165,0)
 S VAL=$$XCN200^VDEFEL(VAL,"PHARMACIST") D PUT(14)
"RTN","PSOVDF1",166,0)
 ; (18-17)
"RTN","PSOVDF1",167,0)
RXE2A S VAL=$P(TP,U,18) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") D PUT(18)
"RTN","PSOVDF1",168,0)
 ; (22-1.1)
"RTN","PSOVDF1",169,0)
 S VAL=$P(TP,U,10) I $G(VAL)'="" S VAL="D"_VAL D PUT(22)
"RTN","PSOVDF1",170,0)
 ;
"RTN","PSOVDF1",171,0)
 I $G(MSG)="" G RXE2Q
"RTN","PSOVDF1",172,0)
 S MSG="RXE"_SEPF_MSG D OUT
"RTN","PSOVDF1",173,0)
RXE2Q ; Q
"RTN","PSOVDF1",174,0)
 ;
"RTN","PSOVDF1",175,0)
NTE2 ; REFILL
"RTN","PSOVDF1",176,0)
 S MSG=""
"RTN","PSOVDF1",177,0)
 ; (3-52.1_3)
"RTN","PSOVDF1",178,0)
 S VAL=$P(TP,U,3) I $G(VAL)="" G NTE2Q
"RTN","PSOVDF1",179,0)
 D PUT(3)
"RTN","PSOVDF1",180,0)
 S VAL="RE"_SEPC_"REMARKS" D PUT(4)
"RTN","PSOVDF1",181,0)
 S MSG="NTE"_SEPF_MSG D OUT
"RTN","PSOVDF1",182,0)
NTE2Q G ORC2A
"RTN","PSOVDF1",183,0)
 ;
"RTN","PSOVDF1",184,0)
ORC3 ; PARTIAL       
"RTN","PSOVDF1",185,0)
 I '$D(GL("P")) Q
"RTN","PSOVDF1",186,0)
 K TEMP M TEMP=GL("P")
"RTN","PSOVDF1",187,0)
 S D1=0
"RTN","PSOVDF1",188,0)
ORC3A S D1=$O(TEMP(D1)) Q:(D1="")!(D1'?1.N)
"RTN","PSOVDF1",189,0)
 S MSG=""
"RTN","PSOVDF1",190,0)
 S VAL=D1 D PUT(3)
"RTN","PSOVDF1",191,0)
 S TP=TEMP(D1,0)
"RTN","PSOVDF1",192,0)
 ; (7~4-7.5)
"RTN","PSOVDF1",193,0)
 S WR=$P(TP,U,13) I $G(WR)'="" D
"RTN","PSOVDF1",194,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS"),VAL="",$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="DISPENSED" D PUT(7)
"RTN","PSOVDF1",195,0)
 S VAL="",$P(VAL,SEPC,2)=D0 D PUT(8)
"RTN","PSOVDF1",196,0)
 ; (9-.08)
"RTN","PSOVDF1",197,0)
 S VAL=$P(TP,U,8) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") D PUT(9)
"RTN","PSOVDF1",198,0)
 ; (12-6)
"RTN","PSOVDF1",199,0)
 S VAL=$P(TP,U,17) I $G(VAL)'="" S VAL=$$XCN200^VDEFEL(VAL) D PUT(12)
"RTN","PSOVDF1",200,0)
 S VAL="PARTIAL" D PUT(16)
"RTN","PSOVDF1",201,0)
 S VAL=$P(TP,U,9) S:$G(VAL)="" VAL=$P($G(^PSRX(PSOVNUM,2)),"^",9) I $G(VAL)'="" D
"RTN","PSOVDF1",202,0)
 .N PSONCPR,PSONCPRP
"RTN","PSOVDF1",203,0)
 .S X=$G(^PS(59,VAL,0)),PSONCPRP=$P($G(^("SAND")),"^",3),VAL=$P(X,U) Q:VAL=""
"RTN","PSOVDF1",204,0)
 .S (VAL,PSONCPR)=$$REPL(VAL),VAL=$P(X,U,6)_SEPC_VAL_SEPC_HLINST_"_52.2_.09"
"RTN","PSOVDF1",205,0)
 .I PSONCPRP'="" S VAL=VAL_SEPC_PSONCPRP_SEPC_PSONCPR_SEPC_"NCPDP"
"RTN","PSOVDF1",206,0)
 .D PUT(17)
"RTN","PSOVDF1",207,0)
 ;
"RTN","PSOVDF1",208,0)
 I $G(MSG)="" G ORC3Q
"RTN","PSOVDF1",209,0)
 S $P(MSG,U)="RF"
"RTN","PSOVDF1",210,0)
 S MSG="ORC"_SEPF_MSG D OUT
"RTN","PSOVDF1",211,0)
ORC3Q ; Q
"RTN","PSOVDF1",212,0)
 ;
"RTN","PSOVDF1",213,0)
RXE3 ; PARTIAL
"RTN","PSOVDF1",214,0)
 S MSG=""
"RTN","PSOVDF1",215,0)
 ; (1~4-.01)
"RTN","PSOVDF1",216,0)
 S WR=$P(TP,U,1) I $G(WR)'="" D
"RTN","PSOVDF1",217,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS"),VAL="",$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="PARTIAL" D PUT(1)
"RTN","PSOVDF1",218,0)
 ; (2~1..~3-6, 2~4-API, 2~6-NDC)
"RTN","PSOVDF1",219,0)
 S VAL=""
"RTN","PSOVDF1",220,0)
 I $T(NDC^PSOHDR)]"" D
"RTN","PSOVDF1",221,0)
 .  S VAL=$$NDC^PSOHDR(D0,D1,"P")
"RTN","PSOVDF1",222,0)
 E  S VAL=$P($G(TEMP(D1,0)),U,12),VAL=$TR(VAL,"-","")
"RTN","PSOVDF1",223,0)
 I $G(VAL)'="" D
"RTN","PSOVDF1",224,0)
 .  S X="",X=GIVECODE,$P(X,SEPC,4)=VAL,$P(X,SEPC,6)="NDC",VAL=X D PUT(2)
"RTN","PSOVDF1",225,0)
 E  S VAL=GIVECODE D PUT(2)
"RTN","PSOVDF1",226,0)
 S VAL=0 D PUT(3)
"RTN","PSOVDF1",227,0)
 ; (5-DEF="UNK" or API)
"RTN","PSOVDF1",228,0)
 S VAL=UNIT D PUT(5)
"RTN","PSOVDF1",229,0)
 ; (8~6-.02)
"RTN","PSOVDF1",230,0)
 S (VAL,WR)="",WR=$P(TP,U,2)
"RTN","PSOVDF1",231,0)
 I $G(WR)'="" S WR=$S((WR="M"):"MAIL",(WR="W"):"WINDOW",1:WR),$P(VAL,SEPC,6)=WR D PUT(8)
"RTN","PSOVDF1",232,0)
 ; (10-.04)
"RTN","PSOVDF1",233,0)
 S VAL=$P(TP,U,4) D PUT(10)
"RTN","PSOVDF1",234,0)
 ; (14|1-.05)
"RTN","PSOVDF1",235,0)
 S VAL=$P(TP,U,5) I $G(VAL)="" G RXE3B
"RTN","PSOVDF1",236,0)
 S VAL=$$XCN200^VDEFEL(VAL,"PHARMACIST") D PUT(14)
"RTN","PSOVDF1",237,0)
 ; (18-8)
"RTN","PSOVDF1",238,0)
RXE3B S VAL=$P(TP,U,19) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") D PUT(18)
"RTN","PSOVDF1",239,0)
 ; (22-.041)
"RTN","PSOVDF1",240,0)
 S VAL=$P(TP,U,10) I $G(VAL)'="" S VAL="D"_VAL D PUT(22)
"RTN","PSOVDF1",241,0)
 ;
"RTN","PSOVDF1",242,0)
 I $G(MSG)="" G RXE3Q
"RTN","PSOVDF1",243,0)
 S MSG="RXE"_SEPF_MSG D OUT
"RTN","PSOVDF1",244,0)
RXE3Q ; Q
"RTN","PSOVDF1",245,0)
 ;
"RTN","PSOVDF1",246,0)
NTE3 ; PARTIAL
"RTN","PSOVDF1",247,0)
 S MSG=""
"RTN","PSOVDF1",248,0)
 ; (3-.03)
"RTN","PSOVDF1",249,0)
 S VAL=$P(TP,U,3) I $G(VAL)="" G NTE3Q
"RTN","PSOVDF1",250,0)
 D PUT(3)
"RTN","PSOVDF1",251,0)
 S VAL="RE"_SEPC_"REMARKS" D PUT(4)
"RTN","PSOVDF1",252,0)
 S MSG="NTE"_SEPF_MSG D OUT
"RTN","PSOVDF1",253,0)
 ;
"RTN","PSOVDF1",254,0)
NTE3Q G ORC3A
"RTN","PSOVDF1",255,0)
 ;
"RTN","PSOVDF1",256,0)
 Q
"RTN","PSOVDF1",257,0)
 ;
"RTN","PSOVDF1",258,0)
SSETX(GLOBAL,P,L) ;Format Sig
"RTN","PSOVDF1",259,0)
 N RES
"RTN","PSOVDF1",260,0)
 S (RES,X)="",D1=0
"RTN","PSOVDF1",261,0)
SSET10X S D1=$O(GLOBAL(D1)) G SSETQX:(D1="")!(D1'?1.N)
"RTN","PSOVDF1",262,0)
 I $G(L)="" S L=""
"RTN","PSOVDF1",263,0)
 S X=GLOBAL(D1,0) I $P($G(X),U,P)'="" D
"RTN","PSOVDF1",264,0)
 .I $G(RES)'="" S RES=RES_$P(X,U,P)
"RTN","PSOVDF1",265,0)
 .E  S RES=$P(X,U,P)
"RTN","PSOVDF1",266,0)
 G SSET10X
"RTN","PSOVDF1",267,0)
SSETQX I $G(RES)="" Q RES
"RTN","PSOVDF1",268,0)
 S RES=RES_SEPC_SEPC_L
"RTN","PSOVDF1",269,0)
 Q RES
"RTN","PSOVDF1",270,0)
 ;
"RTN","PSOVDF1",271,0)
 Q
"RTN","PSOVDF1",272,0)
 ;
"RTN","PSOVDF1",273,0)
SSETZ(GLOBAL,P) ;Format Provider Comments
"RTN","PSOVDF1",274,0)
 N RES
"RTN","PSOVDF1",275,0)
 S (RES,X)="",D1=0
"RTN","PSOVDF1",276,0)
SSET10Z S D1=$O(GLOBAL(D1)) G SSETQZ:(D1="")!(D1'?1.N)
"RTN","PSOVDF1",277,0)
 S X=GLOBAL(D1,0) I $P($G(X),U,P)="" G SSET10Z
"RTN","PSOVDF1",278,0)
 I $G(RES)'="" S RES=RES_" "_$P(X,U,P)
"RTN","PSOVDF1",279,0)
 E  S RES=$P(X,U,P)
"RTN","PSOVDF1",280,0)
 G SSET10Z
"RTN","PSOVDF1",281,0)
SSETQZ ;
"RTN","PSOVDF1",282,0)
 Q RES
"RTN","PSOVDF2")
0^2^B86129954
"RTN","PSOVDF2",1,0)
PSOVDF2 ;BPOIFO/EL-OUTPATIENT PHARMACY (PRES, PREF, PPAR) HL7 MESSAGE ;10/04/04
"RTN","PSOVDF2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**190,205,220**;DEC 1997
"RTN","PSOVDF2",3,0)
 ;
"RTN","PSOVDF2",4,0)
 ; DBIA 2226 - PS(51.2
"RTN","PSOVDF2",5,0)
 ; DBIA 221 - PSDRUG
"RTN","PSOVDF2",6,0)
 ; DBIA 4248 - Routine VDEFEL
"RTN","PSOVDF2",7,0)
 ;
"RTN","PSOVDF2",8,0)
 Q
"RTN","PSOVDF2",9,0)
 ;
"RTN","PSOVDF2",10,0)
 ; Continue from PSOVDF1
"RTN","PSOVDF2",11,0)
 ; This routine creates one of three Outpatient Pharmacy HL7 messages:
"RTN","PSOVDF2",12,0)
 ; RDE^O11^PRES, RDS^O13^PREF, or RDS^O13^PPAR
"RTN","PSOVDF2",13,0)
 ;
"RTN","PSOVDF2",14,0)
 ; Returns:
"RTN","PSOVDF2",15,0)
 ;    Two piece string with separator '^':
"RTN","PSOVDF2",16,0)
 ;        Piece 1 - "LM" - Local Array
"RTN","PSOVDF2",17,0)
 ;        Piece 2 - MSH segment, is not set
"RTN","PSOVDF2",18,0)
 ;    OUT - OUTPUT array includes HL7 message for every segment except MSH
"RTN","PSOVDF2",19,0)
 ;
"RTN","PSOVDF2",20,0)
 ;  Message Body "MSH,PID,ORC1,RXE1,RXR1,FT1,OBX1,NTE1,ORC2,ORC3"
"RTN","PSOVDF2",21,0)
 ;
"RTN","PSOVDF2",22,0)
 ;
"RTN","PSOVDF2",23,0)
OUT ; Output
"RTN","PSOVDF2",24,0)
 N WR K WR
"RTN","PSOVDF2",25,0)
 S L=1
"RTN","PSOVDF2",26,0)
OUT10 I $L(MSG)<247 S WR(L)=MSG
"RTN","PSOVDF2",27,0)
 I $L(MSG)>246 S WR(L)=$E(MSG,1,246),L=L+1,MSG=$E(MSG,247,99999) G OUT10
"RTN","PSOVDF2",28,0)
 ;
"RTN","PSOVDF2",29,0)
OUT20 ; VISTA HL7
"RTN","PSOVDF2",30,0)
 S X=""
"RTN","PSOVDF2",31,0)
 F I=1:1 S X=$G(WR(I)) Q:X=""  D
"RTN","PSOVDF2",32,0)
 .  I I=1 S OUT("HLS")=$G(OUT("HLS"))+1,OUT("HLS",OUT("HLS"))=X
"RTN","PSOVDF2",33,0)
 .  E  I I>1 S OUT("HLS",OUT("HLS"),I-1)=X
"RTN","PSOVDF2",34,0)
 Q
"RTN","PSOVDF2",35,0)
 ;
"RTN","PSOVDF2",36,0)
GET(GLOBAL,L,P) ; GET(GLOBAL,NODE,PIECE)
"RTN","PSOVDF2",37,0)
 I $G(GLOBAL(L))="" Q ""
"RTN","PSOVDF2",38,0)
 N RES
"RTN","PSOVDF2",39,0)
 S RES=$P(GLOBAL(L),U,P)
"RTN","PSOVDF2",40,0)
 Q RES
"RTN","PSOVDF2",41,0)
 ;
"RTN","PSOVDF2",42,0)
PUT(P) ; Put in MSG
"RTN","PSOVDF2",43,0)
 I $G(VAL)="" Q
"RTN","PSOVDF2",44,0)
 S $P(MSG,SEPF,P)=VAL
"RTN","PSOVDF2",45,0)
 Q
"RTN","PSOVDF2",46,0)
 ;
"RTN","PSOVDF2",47,0)
SSET(GLOBAL,P,L) ;Format Schedule field
"RTN","PSOVDF2",48,0)
 N RES
"RTN","PSOVDF2",49,0)
 S (RES,X)="",D1=0
"RTN","PSOVDF2",50,0)
SSET10 S D1=$O(GLOBAL(D1)) G SSETQ:(D1="")!(D1'?1.N)
"RTN","PSOVDF2",51,0)
 I $G(L)="" S L=""
"RTN","PSOVDF2",52,0)
 S X=$G(GLOBAL(D1,0)) I $P($G(X),U,P)'="" D
"RTN","PSOVDF2",53,0)
 .I $G(RES)'="" S RES=RES_SEPR_$P(X,U,P)_SEPC_SEPC_L
"RTN","PSOVDF2",54,0)
 .E  S RES=$P(X,U,P)_SEPC_SEPC_L
"RTN","PSOVDF2",55,0)
 .S CTR=CTR+1
"RTN","PSOVDF2",56,0)
 G SSET10
"RTN","PSOVDF2",57,0)
SSETQ ;
"RTN","PSOVDF2",58,0)
 Q RES
"RTN","PSOVDF2",59,0)
 ;
"RTN","PSOVDF2",60,0)
PROCESS ;
"RTN","PSOVDF2",61,0)
ORC1 ; ORC FOR ORIGINAL FILL
"RTN","PSOVDF2",62,0)
 S MSG="",CTR=0
"RTN","PSOVDF2",63,0)
 S VAL=$$GET(.GL,"OR1",2) I $G(VAL)'="" S VAL=VAL_SEPC_SRC_"_39.3" D PUT(2)
"RTN","PSOVDF2",64,0)
 S VAL=D0_SEPC_SRC_"_.001" D PUT(3)
"RTN","PSOVDF2",65,0)
 S VAL="CM" D PUT(5)
"RTN","PSOVDF2",66,0)
 S (VAL,WR)="",WR=$$GET(.GL,2,2) I $G(WR)'="" D
"RTN","PSOVDF2",67,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS"),$P(VAL,SEPC,4)=WR,$P(VAL,SEPC,7)="FILL"
"RTN","PSOVDF2",68,0)
 S WR=$$GET(.GL,2,6) I $G(WR)'="" D
"RTN","PSOVDF2",69,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS"),$P(VAL,SEPC,5)=WR,$P(VAL,SEPC,7)=$P(VAL,SEPC,7)_"/EXPIRATION"
"RTN","PSOVDF2",70,0)
 I $G(VAL)'="" S CTR=CTR+1
"RTN","PSOVDF2",71,0)
 S (TP)="",WR=$$GET(.GL,0,13) I $G(WR)'="" D  S CTR=CTR+1,$P(VAL,SEPR,CTR)=TP
"RTN","PSOVDF2",72,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS"),$P(TP,SEPC,5)=WR,$P(TP,SEPC,7)="ISSUED"
"RTN","PSOVDF2",73,0)
 S (TP)="",WR=$$GET(.GL,2,5) I $G(WR)'="" D
"RTN","PSOVDF2",74,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS"),$P(TP,SEPC,4)=WR,$P(TP,SEPC,7)="DISPENSED"
"RTN","PSOVDF2",75,0)
 ; (7~5|3-101)
"RTN","PSOVDF2",76,0)
 S WR=$$GET(.GL,3,1) I $G(WR)'="" D
"RTN","PSOVDF2",77,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS"),$P(TP,SEPC,5)=WR,$P(TP,SEPC,7)=$P(TP,SEPC,7)_"/LAST DISPENSED"
"RTN","PSOVDF2",78,0)
 I $G(TP)'="" S CTR=CTR+1,$P(VAL,SEPR,CTR)=TP
"RTN","PSOVDF2",79,0)
 ; (7~5|4-26.1)
"RTN","PSOVDF2",80,0)
 S (TP)="",WR=$$GET(.GL,3,5) I $G(WR)'="" D  S CTR=CTR+1,$P(VAL,SEPR,CTR)=TP
"RTN","PSOVDF2",81,0)
 .  S WR=$$HLDATE^HLFNC(WR,"TS"),$P(TP,SEPC,5)=WR,$P(TP,SEPC,7)="CANCEL"
"RTN","PSOVDF2",82,0)
 I $G(VAL)'="" D PUT(7)
"RTN","PSOVDF2",83,0)
 ; (9-21)
"RTN","PSOVDF2",84,0)
 S VAL=$$GET(.GL,2,1),VAL=$$HLDATE^HLFNC(VAL,"TS") D PUT(9)
"RTN","PSOVDF2",85,0)
 ; (10-16)
"RTN","PSOVDF2",86,0)
 S VAL=$$GET(.GL,0,16) I $G(VAL)'="" S VAL=$$XCN200^VDEFEL(VAL) D PUT(10)
"RTN","PSOVDF2",87,0)
 ; (12|1-4)
"RTN","PSOVDF2",88,0)
 S WR="",VAL=$$GET(.GL,0,4) I $G(VAL)'="" D
"RTN","PSOVDF2",89,0)
 . S WR=$$XCN200^VDEFEL(VAL,"RE")
"RTN","PSOVDF2",90,0)
 ; (12|2-109)
"RTN","PSOVDF2",91,0)
 S TP="",VAL=$$GET(.GL,3,3) I $G(VAL)'="" D
"RTN","PSOVDF2",92,0)
 . S TP=$$XCN200^VDEFEL(VAL,"COSIGNER"),$P(WR,SEPR,2)=TP
"RTN","PSOVDF2",93,0)
 I $G(WR)'="" S VAL=WR D PUT(12)
"RTN","PSOVDF2",94,0)
 ; (13-5)
"RTN","PSOVDF2",95,0)
 S VAL=$$GET(.GL,0,5)
"RTN","PSOVDF2",96,0)
 I $G(VAL)'="" S VAL=$P($G(^SC(VAL,0)),U) D PUT(13)
"RTN","PSOVDF2",97,0)
 S VAL=$$GET(.GL,2,9) I $G(VAL)'="" D
"RTN","PSOVDF2",98,0)
 .N PSONCOR,PSONCORP
"RTN","PSOVDF2",99,0)
 .S X=$G(^PS(59,VAL,0)),PSONCORP=$P($G(^("SAND")),"^",3)  Q:X=""
"RTN","PSOVDF2",100,0)
 .S VAL=$P(X,U),(VAL,PSONCOR)=$$REPL^PSOVDF1(VAL)
"RTN","PSOVDF2",101,0)
 .S VAL=$P(X,U,6)_SEPC_VAL_SEPC_SRC_"_20"
"RTN","PSOVDF2",102,0)
 .I PSONCORP'="" S VAL=VAL_SEPC_PSONCORP_SEPC_PSONCOR_SEPC_"NCPDP"
"RTN","PSOVDF2",103,0)
 .D PUT(17)
"RTN","PSOVDF2",104,0)
 N PSOVLV,PSOVAR,PSOVEN,DIC,DR,DA,DIQ D
"RTN","PSOVDF2",105,0)
 .S DIC=52,DR="100",(DA,PSOVEN)=D0,DIQ="PSOVAR",DIQ(0)="IE" N D0 D EN^DIQ1 S VAL=$G(PSOVAR(52,PSOVEN,100,"I")) I $G(VAL)="" Q
"RTN","PSOVDF2",106,0)
 .N PSOVALE S PSOVALE=$G(PSOVAR(52,PSOVEN,100,"E"))
"RTN","PSOVDF2",107,0)
 .S PSOVLV=$$GETVUID^XTID(52,100,VAL) I +$G(PSOVLV)>0 S VAL=$P(PSOVLV,"^")_SEPC_$G(PSOVALE)_SEPC_"99VA_52_100" D PUT(25) Q
"RTN","PSOVDF2",108,0)
 .I $G(VAL)'="" S VAL=VAL_SEPC_$G(PSOVALE)_SEPC_SRC_"_100" D PUT(25)
"RTN","PSOVDF2",109,0)
 ;
"RTN","PSOVDF2",110,0)
 I $G(MSG)="" G ORC1Q
"RTN","PSOVDF2",111,0)
 S $P(MSG,U)="RE"
"RTN","PSOVDF2",112,0)
 S MSG="ORC"_SEPF_MSG D OUT
"RTN","PSOVDF2",113,0)
ORC1Q ; Q
"RTN","PSOVDF2",114,0)
 ;
"RTN","PSOVDF2",115,0)
RXE1 ; RXE FOR ORIGINAL FILL
"RTN","PSOVDF2",116,0)
 S MSG=""
"RTN","PSOVDF2",117,0)
 ; (1~4-22)
"RTN","PSOVDF2",118,0)
 S (VAL,WR)="",CTR=0 I $D(GL(6)) K TEMP M TEMP=GL(6) S WR=$$DOSE^PSOVDF3(.TEMP) I $G(WR)'="" S VAL=WR
"RTN","PSOVDF2",119,0)
 ;S (VAL,WR)="",WR=$$GET(.GL,2,2)
"RTN","PSOVDF2",120,0)
 D FINISH^PSOVDF3
"RTN","PSOVDF2",121,0)
 D PUT(1)
"RTN","PSOVDF2",122,0)
 N PSOV568,PSOVNAME,PSOVUIDN,PSOVLL,PSOVNND,PSOVNDF
"RTN","PSOVDF2",123,0)
 S (GIVECODE,P,PSOVNDF,DRUG,VAL,PSOVNND,PSOV568,PSOVNAME,PSOVLL,PSOVUIDN)="",DRUG=$$GET(.GL,0,6)
"RTN","PSOVDF2",124,0)
 I +$G(DRUG)'>0 G RXE1A
"RTN","PSOVDF2",125,0)
 S PSOVNND=$G(^PSDRUG(DRUG,"ND"))
"RTN","PSOVDF2",126,0)
 S PSOVNDF=$P(PSOVNND,"^",3),PSOVLL=$P(PSOVNND,"^") I +PSOVNDF>0 D
"RTN","PSOVDF2",127,0)
 .S PSOVUIDN=$$PROD0^PSNAPIS(+PSOVLL,+PSOVNDF),PSOVNAME=$P(PSOVUIDN,"^") S PSOV568=$$GETVUID^XTID(50.68,,+PSOVNDF_",")
"RTN","PSOVDF2",128,0)
 I +$G(PSOV568)>0 S VAL=+$G(PSOV568)_SEPC_$G(PSOVNAME)_SEPC_"99VA_52_6",GIVECODE=VAL
"RTN","PSOVDF2",129,0)
 I +$G(PSOV568)'>0  S VAL=SEPC_$P($G(^PSDRUG(DRUG,0)),"^")_SEPC_SRC_"_6",GIVECODE=VAL
"RTN","PSOVDF2",130,0)
 ; (2~4-API or 52_27 or 50_31)
"RTN","PSOVDF2",131,0)
RXE1A S WR=""
"RTN","PSOVDF2",132,0)
 I $T(NDC^PSOHDR)]"" D
"RTN","PSOVDF2",133,0)
 .  S WR=$$NDC^PSOHDR(D0,0)
"RTN","PSOVDF2",134,0)
 E  S WR=$$GET(.GL,2,7) D
"RTN","PSOVDF2",135,0)
 .  I $G(WR)="",($G(DRUG)'="") S X=$G(^PSDRUG(DRUG,2)),WR=$P(X,U,4)
"RTN","PSOVDF2",136,0)
 .  S WR=$TR(WR,"-","")
"RTN","PSOVDF2",137,0)
 I $G(WR)'="" S $P(VAL,SEPC,4)=WR,$P(VAL,SEPC,6)="NDC",DRCODE=VAL
"RTN","PSOVDF2",138,0)
 D PUT(2)
"RTN","PSOVDF2",139,0)
 S (UNIT,VAL)="" I $G(PSOVNDF)'="" D
"RTN","PSOVDF2",140,0)
 .  S L=$$DFSU^PSNAPIS(PSOVLL,PSOVNDF)
"RTN","PSOVDF2",141,0)
 .  I $G(L)'="" S VAL=$P(L,U,5)_SEPC_$P(L,U,6)_SEPC_SRC_"_6"
"RTN","PSOVDF2",142,0)
 I $G(VAL)="" S VAL="UNK"
"RTN","PSOVDF2",143,0)
 S UNIT=VAL D PUT(5)
"RTN","PSOVDF2",144,0)
 S VAL=0 D PUT(3)
"RTN","PSOVDF2",145,0)
 S CTR=0,(VAL,WR)=""
"RTN","PSOVDF2",146,0)
 ; (7|3-113)
"RTN","PSOVDF2",147,0)
 I $D(GL(6)) K TEMP M TEMP=GL(6) S WR=$$SSET(.TEMP,8,HLINST_"_52.0113_7") I $G(WR)'="" S VAL=WR
"RTN","PSOVDF2",148,0)
 S WR=$$GET(.GL,"INS",1) I $G(WR)'="" S CTR=CTR+1,WR=WR_SEPC_SEPC_SRC_"_114",$P(VAL,SEPR,CTR)=WR
"RTN","PSOVDF2",149,0)
 S WR=$$GET(.GL,"INSS",1) I $G(WR)'="" S CTR=CTR+1,WR=WR_SEPC_SEPC_SRC_"_114.1",$P(VAL,SEPR,CTR)=WR
"RTN","PSOVDF2",150,0)
 D PUT(7)
"RTN","PSOVDF2",151,0)
 ; (8~6-11)
"RTN","PSOVDF2",152,0)
 S (WR,VAL)="",WR=$$GET(.GL,0,11)
"RTN","PSOVDF2",153,0)
 I $G(WR)'="" S WR=$S((WR="M"):"MAIL",(WR="W"):"WINDOW",1:WR),$P(VAL,SEPC,6)=WR D PUT(8)
"RTN","PSOVDF2",154,0)
 ; (10-7)
"RTN","PSOVDF2",155,0)
 S VAL=$$GET(.GL,0,7) D PUT(10)
"RTN","PSOVDF2",156,0)
 ; (12-9)
"RTN","PSOVDF2",157,0)
 S VAL=$$GET(.GL,0,9) D PUT(12)
"RTN","PSOVDF2",158,0)
 ; (14|1-23)
"RTN","PSOVDF2",159,0)
 S WR="",VAL=$$GET(.GL,2,3) I $G(VAL)'="" D
"RTN","PSOVDF2",160,0)
 . S WR=$$XCN200^VDEFEL(VAL,"PHARMACIST")
"RTN","PSOVDF2",161,0)
 ; (14|2-104)
"RTN","PSOVDF2",162,0)
 S TP="",VAL=$$GET(.GL,2,10) I $G(VAL)'="" D
"RTN","PSOVDF2",163,0)
 . S TP=$$XCN200^VDEFEL(VAL,"VERIFIER PHARM"),$P(WR,SEPR,2)=TP
"RTN","PSOVDF2",164,0)
 I $G(WR)'="" S VAL=WR D PUT(14)
"RTN","PSOVDF2",165,0)
 ; (15-.01)
"RTN","PSOVDF2",166,0)
 S VAL=$$GET(.GL,0,1) D PUT(15)
"RTN","PSOVDF2",167,0)
 ; (18-31)
"RTN","PSOVDF2",168,0)
 S VAL=$$GET(.GL,2,13) I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") D PUT(18)
"RTN","PSOVDF2",169,0)
 ; (21|1-10.2=1 or 10)
"RTN","PSOVDF2",170,0)
 S VAL="" I '$D(GL("SIG")) G RXE1B
"RTN","PSOVDF2",171,0)
 I $P(GL("SIG"),U,2)=1 D
"RTN","PSOVDF2",172,0)
 . I $D(GL("SIG1")) K TEMP M TEMP=GL("SIG1") S VAL=$$SSETX^PSOVDF1(.TEMP,1,SRC_"_10.2")
"RTN","PSOVDF2",173,0)
 E  S VAL=$$GET(.GL,"SIG",1) S:$G(VAL)'="" VAL=VAL_SEPC_SEPC_SRC_"_10"
"RTN","PSOVDF2",174,0)
 D PUT(21)
"RTN","PSOVDF2",175,0)
RXE1B ; (22-8)
"RTN","PSOVDF2",176,0)
 S VAL=$$GET(.GL,0,8) I $G(VAL)'="" S VAL="D"_VAL D PUT(22)
"RTN","PSOVDF2",177,0)
 S VAL=$$GET(.GL,"TN",1)
"RTN","PSOVDF2",178,0)
 I $G(VAL)'="" S VAL=$E(VAL,1,32)_SEPC_SEPC_SRC_"_6.5" D PUT(31)
"RTN","PSOVDF2",179,0)
 ;
"RTN","PSOVDF2",180,0)
 I $G(MSG)="" G RXE1Q
"RTN","PSOVDF2",181,0)
 S MSG="RXE"_SEPF_MSG D OUT
"RTN","PSOVDF2",182,0)
RXE1Q ; Q
"RTN","PSOVDF2",183,0)
 ;
"RTN","PSOVDF2",184,0)
RXR1 ; RXR FOR ORIGINAL FILL
"RTN","PSOVDF2",185,0)
 S MSG=""
"RTN","PSOVDF2",186,0)
 I '$D(GL(6)) G RXR1Q
"RTN","PSOVDF2",187,0)
 K TEMP M TEMP=GL(6)
"RTN","PSOVDF2",188,0)
 S X="",D1=0
"RTN","PSOVDF2",189,0)
RXR1A S D1=$O(TEMP(D1)) G RXR1B:(D1="")!(D1'?1.N)
"RTN","PSOVDF2",190,0)
 S X=$P($G(TEMP(D1,0)),U,7)
"RTN","PSOVDF2",191,0)
 I $G(X)="" G RXR1A
"RTN","PSOVDF2",192,0)
 I '$D(^PS(51.2,X,0)) G RXR1A
"RTN","PSOVDF2",193,0)
 S VAL=X_SEPC_$P(^PS(51.2,X,0),U)_SEPC_HLINST_"_52.0113_6"
"RTN","PSOVDF2",194,0)
 I $G(MSG)'="" S MSG=MSG_SEPR_VAL
"RTN","PSOVDF2",195,0)
 E  S MSG=VAL
"RTN","PSOVDF2",196,0)
 G RXR1A
"RTN","PSOVDF2",197,0)
RXR1B I $G(MSG)="" G RXR1Q
"RTN","PSOVDF2",198,0)
 S MSG="RXR"_SEPF_MSG D OUT
"RTN","PSOVDF2",199,0)
RXR1Q ; Q
"RTN","PSOVDF2",200,0)
 ;
"RTN","PSOVDF2",201,0)
FT1 ; FT1 FOR ORIGINAL FILL
"RTN","PSOVDF2",202,0)
 S (MSG)=""
"RTN","PSOVDF2",203,0)
 ; (4-22)
"RTN","PSOVDF2",204,0)
 S VAL=$$GET(.GL,2,2)
"RTN","PSOVDF2",205,0)
 I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") D PUT(4)
"RTN","PSOVDF2",206,0)
 S VAL="CG" D PUT(6)
"RTN","PSOVDF2",207,0)
 S VAL=$$GET1^DIQ(52,D0_",",39.2,"","","ERR")
"RTN","PSOVDF2",208,0)
 I $G(VAL)'="" S VAL=VAL_SEPC_SEPC_SRC_"_39.2" D PUT(7)
"RTN","PSOVDF2",209,0)
 ; (12-17)
"RTN","PSOVDF2",210,0)
 S VAL=$$GET(.GL,0,17) D PUT(12)
"RTN","PSOVDF2",211,0)
 ; (18-3)
"RTN","PSOVDF2",212,0)
 S TP="",TP=$$GET(.GL,0,3)
"RTN","PSOVDF2",213,0)
 I $G(TP)'="" S VAL=$P($G(^PS(53,TP,0)),U,2) D PUT(18)
"RTN","PSOVDF2",214,0)
 ;
"RTN","PSOVDF2",215,0)
 I $G(MSG)="" G FT1Q
"RTN","PSOVDF2",216,0)
 S MSG="FT1"_SEPF_MSG D OUT
"RTN","PSOVDF2",217,0)
FT1Q ; Q
"RTN","PSOVDF2",218,0)
 ;
"RTN","PSOVDF2",219,0)
OBX1 ; OBX FOR ORIGINAL FILL
"RTN","PSOVDF2",220,0)
 S CTR=0
"RTN","PSOVDF2",221,0)
 F FIELD=41,42,116,117,118,119,120,121,201 D OBXLP
"RTN","PSOVDF2",222,0)
 G OBX1B
"RTN","PSOVDF2",223,0)
 ;
"RTN","PSOVDF2",224,0)
OBXLP ;
"RTN","PSOVDF2",225,0)
 S MSG=""
"RTN","PSOVDF2",226,0)
 N DIC,DR,DA,DIQ,PSOOVAR,PSOOVEN
"RTN","PSOVDF2",227,0)
 S DIC=52,DR=FIELD,(DA,PSOOVEN)=D0,DIQ="PSOOVAR",DIQ(0)="IE" N D0 D EN^DIQ1 S VAL=$G(PSOOVAR(52,PSOOVEN,FIELD,"I"))
"RTN","PSOVDF2",228,0)
 I $G(VAL)="" Q
"RTN","PSOVDF2",229,0)
 N PSOOVALE S PSOOVALE=$G(PSOOVAR(52,PSOOVEN,FIELD,"E"))
"RTN","PSOVDF2",230,0)
 N PSOVLVU D
"RTN","PSOVDF2",231,0)
 .S PSOVLVU=$$GETVUID^XTID(52,FIELD,VAL) I +$G(PSOVLVU)>0 S VAL=$P(PSOVLVU,"^")_SEPC_$G(PSOOVALE)_SEPC_"99VA_52_"_FIELD D PUT(5) Q
"RTN","PSOVDF2",232,0)
 .S VAL=VAL_SEPC_$G(PSOOVALE)_SEPC_SRC_"_"_FIELD D PUT(5)
"RTN","PSOVDF2",233,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF2",234,0)
 S VAL="CE" D PUT(2)
"RTN","PSOVDF2",235,0)
 N DD D FIELD^DID(52,FIELD,"","LABEL","DD","ERR")
"RTN","PSOVDF2",236,0)
 S VAL=DD("LABEL") D PUT(3)
"RTN","PSOVDF2",237,0)
 S VAL="F" D PUT(11)
"RTN","PSOVDF2",238,0)
 S MSG="OBX"_SEPF_MSG D OUT
"RTN","PSOVDF2",239,0)
 Q
"RTN","PSOVDF2",240,0)
 ;
"RTN","PSOVDF2",241,0)
OBX1B ;
"RTN","PSOVDF2",242,0)
 S MSG=""
"RTN","PSOVDF2",243,0)
 ; (5-301)
"RTN","PSOVDF2",244,0)
 S VAL=$$GET(.GL,"SAND",1)
"RTN","PSOVDF2",245,0)
 I $G(VAL)="" G OBX1C
"RTN","PSOVDF2",246,0)
 D PUT(5)
"RTN","PSOVDF2",247,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF2",248,0)
 S VAL="NM" D PUT(2)
"RTN","PSOVDF2",249,0)
 S VAL="CLOZAPINE DOSAGE" D PUT(3)
"RTN","PSOVDF2",250,0)
 S VAL="MG/DAY" D PUT(6)
"RTN","PSOVDF2",251,0)
 S VAL="F" D PUT(11)
"RTN","PSOVDF2",252,0)
 S MSG="OBX"_SEPF_MSG D OUT
"RTN","PSOVDF2",253,0)
 ;
"RTN","PSOVDF2",254,0)
OBX1C ;
"RTN","PSOVDF2",255,0)
 S MSG=""
"RTN","PSOVDF2",256,0)
 ; (5-302)
"RTN","PSOVDF2",257,0)
 S VAL=$$GET(.GL,"SAND",2)
"RTN","PSOVDF2",258,0)
 I $G(VAL)="" G NTE1
"RTN","PSOVDF2",259,0)
 D PUT(5)
"RTN","PSOVDF2",260,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF2",261,0)
 S VAL="NM" D PUT(2)
"RTN","PSOVDF2",262,0)
 S VAL="WBC RESULTS" D PUT(3)
"RTN","PSOVDF2",263,0)
 S VAL="F" D PUT(11)
"RTN","PSOVDF2",264,0)
 ; (14-303)
"RTN","PSOVDF2",265,0)
 S VAL=$$GET(.GL,"SAND",3)
"RTN","PSOVDF2",266,0)
 I $G(VAL)'="" S VAL=$$HLDATE^HLFNC(VAL,"TS") D PUT(14)
"RTN","PSOVDF2",267,0)
 S MSG="OBX"_SEPF_MSG D OUT
"RTN","PSOVDF2",268,0)
 ;
"RTN","PSOVDF2",269,0)
 ;
"RTN","PSOVDF2",270,0)
NTE1 ; NTE FOR ORIGINAL FILL
"RTN","PSOVDF2",271,0)
 S MSG="",CTR=0
"RTN","PSOVDF2",272,0)
 S VAL=$$GET(.GL,3,7)
"RTN","PSOVDF2",273,0)
 I $G(VAL)="" G NTE1B
"RTN","PSOVDF2",274,0)
 D PUT(3)
"RTN","PSOVDF2",275,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF2",276,0)
 S VAL="RE"_SEPC_"REMARKS"_SEPC_SRC_"_12" D PUT(4)
"RTN","PSOVDF2",277,0)
 S MSG="NTE"_SEPF_MSG D OUT
"RTN","PSOVDF2",278,0)
 ;
"RTN","PSOVDF2",279,0)
NTE1B ;
"RTN","PSOVDF2",280,0)
 S MSG=""
"RTN","PSOVDF2",281,0)
 I '$D(GL("PRC")) G NTE1C
"RTN","PSOVDF2",282,0)
 S VAL="" K TEMP M TEMP=GL("PRC") S VAL=$$SSETZ^PSOVDF1(.TEMP,1)
"RTN","PSOVDF2",283,0)
 I $G(VAL)="" G NTE1C
"RTN","PSOVDF2",284,0)
 D PUT(3)
"RTN","PSOVDF2",285,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF2",286,0)
 S VAL="PR"_SEPC_"PROVIDER COMMENTS"_SEPC_HLINST_"_52.039_.01" D PUT(4)
"RTN","PSOVDF2",287,0)
 S MSG="NTE"_SEPF_MSG D OUT
"RTN","PSOVDF2",288,0)
 ;
"RTN","PSOVDF2",289,0)
NTE1C ;
"RTN","PSOVDF2",290,0)
 S MSG=""
"RTN","PSOVDF2",291,0)
 S VAL=$$GET(.GL,"D",1)
"RTN","PSOVDF2",292,0)
 I $G(VAL)="" G NTE1Q
"RTN","PSOVDF2",293,0)
 D PUT(3)
"RTN","PSOVDF2",294,0)
 S CTR=CTR+1,VAL=CTR D PUT(1)
"RTN","PSOVDF2",295,0)
 S VAL="DE"_SEPC_"DELETION COMMENTS"_SEPC_SRC_"_108" D PUT(4)
"RTN","PSOVDF2",296,0)
 S MSG="NTE"_SEPF_MSG D OUT
"RTN","PSOVDF2",297,0)
NTE1Q Q
"VER")
8.0^22.0
"BLD",5813,6)
^SEQ #197
**END**
**END**
