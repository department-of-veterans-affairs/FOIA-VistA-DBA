Released PSD*3*62 SEQ #54
Extracted from mail message
**KIDS**:PSD*3.0*62^

**INSTALL NAME**
PSD*3.0*62
"BLD",6824,0)
PSD*3.0*62^CONTROLLED SUBSTANCES^0^3061026^y
"BLD",6824,1,0)
^^28^28^3061019^
"BLD",6824,1,1,0)
This patch addresses the following problems:
"BLD",6824,1,2,0)
 
"BLD",6824,1,3,0)
1.  129499     PSDGSRV1        undefined error
"BLD",6824,1,4,0)
 
"BLD",6824,1,5,0)
When completing a greensheet and the user includes a ";" semicolon at the
"BLD",6824,1,6,0)
"REASON TURN IN FOR DESTROY:" or "REASON RETURNED TO STOCK:" prompts, a
"BLD",6824,1,7,0)
$ZE= <SYNTAX> BR+1^DIE0 error is generated.
"BLD",6824,1,8,0)
 
"BLD",6824,1,9,0)
2.   68785     PSDPAT1         Transferring of Controlled Substances 
"BLD",6824,1,10,0)
 
"BLD",6824,1,11,0)
When a controlled substance is transferred from one NAOU to another NAOU,
"BLD",6824,1,12,0)
the Activity Report [PSD NURSE DISP REPORT] does not include the transfer
"BLD",6824,1,13,0)
if the receipt date is different then the transfer date.
"BLD",6824,1,14,0)
 
"BLD",6824,1,15,0)
3.  136028     Pharmacist able to fill expired order.
"BLD",6824,1,16,0)
 
"BLD",6824,1,17,0)
This patch will prevent the pharmacist from filling expired orders.
"BLD",6824,1,18,0)
 
"BLD",6824,1,19,0)
4.  161718     Pharmacist can't order an inactive drug on NAOU
"BLD",6824,1,20,0)
 
"BLD",6824,1,21,0)
It also allows a pharmacist to see inactive drugs on the lookup.
"BLD",6824,1,22,0)
 
"BLD",6824,1,23,0)
5.  158898     PSD DEST Drugs Report does not work properly.
"BLD",6824,1,24,0)
 
"BLD",6824,1,25,0)
If the first date in the "AD" cross reference of file #58.86 (call it Y) 
"BLD",6824,1,26,0)
is after the last date in the "AC" cross reference (call it X) and
"BLD",6824,1,27,0)
the starting date for the report falls between the two dates
"BLD",6824,1,28,0)
(X < starting date <Y)then an <UNDEFINED> error occurs.
"BLD",6824,4,0)
^9.64PA^^
"BLD",6824,6.3)
3
"BLD",6824,"ABPKG")
n
"BLD",6824,"KRN",0)
^9.67PA^8989.52^19
"BLD",6824,"KRN",.4,0)
.4
"BLD",6824,"KRN",.401,0)
.401
"BLD",6824,"KRN",.402,0)
.402
"BLD",6824,"KRN",.403,0)
.403
"BLD",6824,"KRN",.5,0)
.5
"BLD",6824,"KRN",.84,0)
.84
"BLD",6824,"KRN",3.6,0)
3.6
"BLD",6824,"KRN",3.8,0)
3.8
"BLD",6824,"KRN",9.2,0)
9.2
"BLD",6824,"KRN",9.8,0)
9.8
"BLD",6824,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",6824,"KRN",9.8,"NM",1,0)
PSDPAT1^^0^B63600329
"BLD",6824,"KRN",9.8,"NM",2,0)
PSDGSRV1^^0^B33992603
"BLD",6824,"KRN",9.8,"NM",3,0)
PSDESTP^^0^B47919074
"BLD",6824,"KRN",9.8,"NM",4,0)
PSDORP^^0^B26130595
"BLD",6824,"KRN",9.8,"NM",5,0)
PSDOPT^^0^B83861199
"BLD",6824,"KRN",9.8,"NM","B","PSDESTP",3)

"BLD",6824,"KRN",9.8,"NM","B","PSDGSRV1",2)

"BLD",6824,"KRN",9.8,"NM","B","PSDOPT",5)

"BLD",6824,"KRN",9.8,"NM","B","PSDORP",4)

"BLD",6824,"KRN",9.8,"NM","B","PSDPAT1",1)

"BLD",6824,"KRN",19,0)
19
"BLD",6824,"KRN",19.1,0)
19.1
"BLD",6824,"KRN",101,0)
101
"BLD",6824,"KRN",409.61,0)
409.61
"BLD",6824,"KRN",771,0)
771
"BLD",6824,"KRN",870,0)
870
"BLD",6824,"KRN",8989.51,0)
8989.51
"BLD",6824,"KRN",8989.52,0)
8989.52
"BLD",6824,"KRN",8994,0)
8994
"BLD",6824,"KRN","B",.4,.4)

"BLD",6824,"KRN","B",.401,.401)

"BLD",6824,"KRN","B",.402,.402)

"BLD",6824,"KRN","B",.403,.403)

"BLD",6824,"KRN","B",.5,.5)

"BLD",6824,"KRN","B",.84,.84)

"BLD",6824,"KRN","B",3.6,3.6)

"BLD",6824,"KRN","B",3.8,3.8)

"BLD",6824,"KRN","B",9.2,9.2)

"BLD",6824,"KRN","B",9.8,9.8)

"BLD",6824,"KRN","B",19,19)

"BLD",6824,"KRN","B",19.1,19.1)

"BLD",6824,"KRN","B",101,101)

"BLD",6824,"KRN","B",409.61,409.61)

"BLD",6824,"KRN","B",771,771)

"BLD",6824,"KRN","B",870,870)

"BLD",6824,"KRN","B",8989.51,8989.51)

"BLD",6824,"KRN","B",8989.52,8989.52)

"BLD",6824,"KRN","B",8994,8994)

"BLD",6824,"QUES",0)
^9.62^^
"BLD",6824,"REQB",0)
^9.611^6^5
"BLD",6824,"REQB",2,0)
PSD*3.0*7^1
"BLD",6824,"REQB",3,0)
PSD*3.0*8^1
"BLD",6824,"REQB",4,0)
PSD*3.0*48^1
"BLD",6824,"REQB",5,0)
PSD*3.0*56^1
"BLD",6824,"REQB",6,0)
PSD*3.0*58^1
"BLD",6824,"REQB","B","PSD*3.0*48",4)

"BLD",6824,"REQB","B","PSD*3.0*56",5)

"BLD",6824,"REQB","B","PSD*3.0*58",6)

"BLD",6824,"REQB","B","PSD*3.0*7",2)

"BLD",6824,"REQB","B","PSD*3.0*8",3)

"MBREQ")
0
"PKG",499,-1)
1^1
"PKG",499,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",499,20,0)
^9.402P^^
"PKG",499,22,0)
^9.49I^1^1
"PKG",499,22,1,0)
3.0^2970213^2981028^66481
"PKG",499,22,1,"PAH",1,0)
62^3061026^100104
"PKG",499,22,1,"PAH",1,1,0)
^^28^28^3061026
"PKG",499,22,1,"PAH",1,1,1,0)
This patch addresses the following problems:
"PKG",499,22,1,"PAH",1,1,2,0)
 
"PKG",499,22,1,"PAH",1,1,3,0)
1.  129499     PSDGSRV1        undefined error
"PKG",499,22,1,"PAH",1,1,4,0)
 
"PKG",499,22,1,"PAH",1,1,5,0)
When completing a greensheet and the user includes a ";" semicolon at the
"PKG",499,22,1,"PAH",1,1,6,0)
"REASON TURN IN FOR DESTROY:" or "REASON RETURNED TO STOCK:" prompts, a
"PKG",499,22,1,"PAH",1,1,7,0)
$ZE= <SYNTAX> BR+1^DIE0 error is generated.
"PKG",499,22,1,"PAH",1,1,8,0)
 
"PKG",499,22,1,"PAH",1,1,9,0)
2.   68785     PSDPAT1         Transferring of Controlled Substances 
"PKG",499,22,1,"PAH",1,1,10,0)
 
"PKG",499,22,1,"PAH",1,1,11,0)
When a controlled substance is transferred from one NAOU to another NAOU,
"PKG",499,22,1,"PAH",1,1,12,0)
the Activity Report [PSD NURSE DISP REPORT] does not include the transfer
"PKG",499,22,1,"PAH",1,1,13,0)
if the receipt date is different then the transfer date.
"PKG",499,22,1,"PAH",1,1,14,0)
 
"PKG",499,22,1,"PAH",1,1,15,0)
3.  136028     Pharmacist able to fill expired order.
"PKG",499,22,1,"PAH",1,1,16,0)
 
"PKG",499,22,1,"PAH",1,1,17,0)
This patch will prevent the pharmacist from filling expired orders.
"PKG",499,22,1,"PAH",1,1,18,0)
 
"PKG",499,22,1,"PAH",1,1,19,0)
4.  161718     Pharmacist can't order an inactive drug on NAOU
"PKG",499,22,1,"PAH",1,1,20,0)
 
"PKG",499,22,1,"PAH",1,1,21,0)
It also allows a pharmacist to see inactive drugs on the lookup.
"PKG",499,22,1,"PAH",1,1,22,0)
 
"PKG",499,22,1,"PAH",1,1,23,0)
5.  158898     PSD DEST Drugs Report does not work properly.
"PKG",499,22,1,"PAH",1,1,24,0)
 
"PKG",499,22,1,"PAH",1,1,25,0)
If the first date in the "AD" cross reference of file #58.86 (call it Y) 
"PKG",499,22,1,"PAH",1,1,26,0)
is after the last date in the "AC" cross reference (call it X) and
"PKG",499,22,1,"PAH",1,1,27,0)
the starting date for the report falls between the two dates
"PKG",499,22,1,"PAH",1,1,28,0)
(X < starting date <Y)then an <UNDEFINED> error occurs.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSDESTP")
0^3^B47919074^B47647337
"RTN","PSDESTP",1,0)
PSDESTP ;BIR/BJW-Destroyed CS Drugs Report ; 28 Feb 98
"RTN","PSDESTP",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,62**;13 Feb 97;Build 3
"RTN","PSDESTP",3,0)
 ;**Y2K compliance**,"P" added to date input string 2/9/98
"RTN","PSDESTP",4,0)
 ;*Y2K* chg to print four digit year in body of report
"RTN","PSDESTP",5,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDESTP",6,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)) W !!,"Please contact your Pharmacy Coordinator for access to",!,"the pending Controlled Substances destruction data.",!!,"PSJ RPHARM security key required.",! G END
"RTN","PSDESTP",7,0)
ASKD ;ask disp location
"RTN","PSDESTP",8,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDESTP",9,0)
ASKV ;ask vault(s)
"RTN","PSDESTP",10,0)
 W !!,?5,"You may select a single VAULT, several VAULT(s),",!,?5,"or enter ^ALL to select all VAULT(s).",!
"RTN","PSDESTP",11,0)
 K DA,DIC D NOW^%DTC S (PSDT,Y)=X X ^DD("DD") S RPDT=Y
"RTN","PSDESTP",12,0)
 F  S DIC=58.8,DIC("A")="Select VAULT: ",DIC(0)="QEA",DIC("S")="I $S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>PSDT:1,1:0),$P(^(0),""^"",2)'=""N"",$P(^(0),""^"",3)=+PSDSITE" D ^DIC K DIC Q:Y<0  S PSDVAU(+Y)=""
"RTN","PSDESTP",13,0)
ASKV2 ;
"RTN","PSDESTP",14,0)
 I '$O(PSDVAU(0))&(X'="^ALL") G END
"RTN","PSDESTP",15,0)
 I X="^ALL" F PSD=0:0 S PSD=$O(^PSD(58.8,PSD)) Q:'PSD  I $S('$D(^PSD(58.8,PSD,"I")):1,'^("I"):1,+^("I")>PSDT:1,1:0),$P($G(^(0)),"^",2)'="N",$P($G(^(0)),"^",3)=+PSDSITE S PSDVAU(PSD)=""
"RTN","PSDESTP",16,0)
 S JJ=$O(PSDVAU(0)),JJ=$S($O(PSDVAU(JJ)):1,1:2)
"RTN","PSDESTP",17,0)
 S DIC="^DIC(4,",DR=.01,DA=+$P($G(^XMB(1,1,"XUS")),U,17),DIQ="PSD"
"RTN","PSDESTP",18,0)
 D EN^DIQ1 S PSD=PSD(4,DA,.01) K DIC,DR,DA,DIQ
"RTN","PSDESTP",19,0)
 S PSDSN=$S(JJ=1:PSD,1:$P($G(^PSD(58.8,+$O(PSDVAU(0)),0)),U)) K PSD
"RTN","PSDESTP",20,0)
DRUG ;ask drug
"RTN","PSDESTP",21,0)
 W !!,?5,"You may select a single drug, several drugs,",!,?5,"or enter ^ALL to select all drugs.",!!
"RTN","PSDESTP",22,0)
 W ! K DA,DIC
"RTN","PSDESTP",23,0)
 S PSDS=$O(PSDVAU(0))
"RTN","PSDESTP",24,0)
 I $O(PSDVAU(PSDS)) D  G SKIP
"RTN","PSDESTP",25,0)
 .F  S DIC=50,DIC(0)="QEAM",DIC("A")="SELECT DRUG: " D ^DIC K DIC Q:Y<0  S PSDRG(+Y)=""
"RTN","PSDESTP",26,0)
 F  S DIC("W")="W:$P(^PSDRUG(Y,0),""^"",9) ""   N/F"" I $P(^PSD(58.8,PSDS,1,Y,0),""^"",14)]"""",$P(^(0),""^"",14)'>DT W $C(7),""   *** INACTIVE ***""",DA(1)=+PSDS,DIC(0)="QEAM",DIC="^PSD(58.8,"_PSDS_",1," D ^DIC K DIC Q:Y<0  D
"RTN","PSDESTP",27,0)
 .S PSDRG(+Y)=""
"RTN","PSDESTP",28,0)
SKIP I '$D(PSDRG)&(X'="^ALL") G END
"RTN","PSDESTP",29,0)
 I X="^ALL" S ALL=1
"RTN","PSDESTP",30,0)
DATE ;ask date range
"RTN","PSDESTP",31,0)
 W ! K %DT S %DT="AEP",%DT("A")="Start with Date: " D ^%DT I Y<0 S PSDOUT=1 G END
"RTN","PSDESTP",32,0)
 S PSDSD=Y D D^DIQ S PSDATE=Y,%DT("A")="End with Date: " D ^%DT I Y<0 S PSDOUT=1 G END
"RTN","PSDESTP",33,0)
 I Y<PSDSD W !!,"The ending date of the range must be later than the starting date." G DATE
"RTN","PSDESTP",34,0)
 S PSDED=Y D D^DIQ S PSDATE=PSDATE_"^"_Y,PSDSD=PSDSD-.0001,PSDED=PSDED+.9999
"RTN","PSDESTP",35,0)
DEV ;select device
"RTN","PSDESTP",36,0)
 W !!,"This report is designed for a 80 column format.",!,"You may queue this report to print at a later time.",!!
"RTN","PSDESTP",37,0)
 S Y=$P($G(^PSD(58.8,+PSDS,2)),"^",9),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDESTP",38,0)
 K %ZIS,IOP,IO("Q"),POP S %ZIS="QM",%ZIS("B")=PSDEV D ^%ZIS I POP W !,"NO DEVICE SELECTED OR REPORT PRINTED!" G END
"RTN","PSDESTP",39,0)
 I $D(IO("Q")) K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDESTP",ZTDESC="Destroyed CS Drug Report" D SAVE,^%ZTLOAD,HOME^%ZIS K ZTSK G END
"RTN","PSDESTP",40,0)
 U IO
"RTN","PSDESTP",41,0)
START ;start looping
"RTN","PSDESTP",42,0)
 K ^TMP("PSDESTP",$J)
"RTN","PSDESTP",43,0)
 D NOW^%DTC S Y=X X ^DD("DD") S RPDT=Y
"RTN","PSDESTP",44,0)
 K LN S (CNT,PG,PSDOUT,PSDTOT)=0,$P(LN,"-",80)=""
"RTN","PSDESTP",45,0)
 F PSD=PSDSD:0 S PSD=$O(^PSD(58.86,"AC",PSD)) Q:'PSD!(PSD>PSDED)   S PSDS=0 F  S PSDS=$O(^PSD(58.86,"AC",PSD,PSDS)) Q:'PSDS  D:$D(PSDVAU(PSDS))
"RTN","PSDESTP",46,0)
 .F PSDR=0:0 S PSDR=$O(^PSD(58.86,"AC",PSD,PSDS,PSDR)) Q:'PSDR  D
"RTN","PSDESTP",47,0)
 ..F PSDA=0:0 S PSDA=$O(^PSD(58.86,"AC",PSD,PSDS,PSDR,PSDA)) Q:'PSDA  I $D(ALL)!($D(PSDRG(+PSDR))) D SET
"RTN","PSDESTP",48,0)
 I $D(ALL) F PSD=PSDSD:0 S PSD=$O(^PSD(58.86,"AD",PSD)) Q:'PSD!(PSD>PSDED)  F  S PSDS=$O(^PSD(58.86,"AD",PSD,PSDS)) Q:'PSDS  D:$D(PSDVAU(PSDS))
"RTN","PSDESTP",49,0)
 .S PSDN="" F  S PSDN=$O(^PSD(58.86,"AD",PSD,PSDS,PSDN)) Q:PSDN=""  F PSDA=0:0 S PSDA=$O(^PSD(58.86,"AD",PSD,PSDS,PSDN,PSDA)) Q:'PSDA  D SET
"RTN","PSDESTP",50,0)
 I CNT=0 D HDR W !!,?10,"*** NO CONTROLLED SUBSTANCE DESTRUCTIONS ***",!! G DONE
"RTN","PSDESTP",51,0)
PRINT ;prints data,L-6 added 8/24/95 accum summ.total,10/20/95 chgs made
"RTN","PSDESTP",52,0)
 D HDR
"RTN","PSDESTP",53,0)
 F PSDA=0:0 S PSDA=$O(^TMP("PSDESTP",$J,PSDA)) D:'PSDA GTOT Q:'PSDA!(PSDOUT)  D:$Y+12>IOSL HDR Q:PSDOUT  S PSDRN="" F  S PSDRN=$O(^TMP("PSDESTP",$J,PSDA,PSDRN)) Q:PSDRN=""  D 
"RTN","PSDESTP",54,0)
 .I $Y+12>IOSL D HDR Q:PSDOUT
"RTN","PSDESTP",55,0)
 .S NODE=^TMP("PSDESTP",$J,PSDA,PSDRN)
"RTN","PSDESTP",56,0)
 .W !,"HOLDING #: ",PSDA,! S PVAULT=$P(NODE,U,9) W:JJ=1 "=> ",$P($G(^PSD(58.8,+PVAULT,0)),U),! W "Drug: ",PSDRN W ?60 W:$P(NODE,"^",8) "GS #: ",$P(NODE,U,8) W !,"Quantity: ",$P(NODE,"^"),!,"Cost of above Qty: ",$P(NODE,U,11)
"RTN","PSDESTP",57,0)
 .I $P(NODE,U,10)']"" S PSDTOT=$P(NODE,U,11)+PSDTOT
"RTN","PSDESTP",58,0)
 .I $P(NODE,U,6)']"" D
"RTN","PSDESTP",59,0)
 ..W !,"Date Destroyed: ",$P(NODE,U,3),!,"Destroyed By: ",$P(NODE,U,2),!,"Patient Returning Drug: ",$P(NODE,U,10),!
"RTN","PSDESTP",60,0)
 ..W:$P(NODE,U,4) "Comments: ",$P(NODE,U,4),!!
"RTN","PSDESTP",61,0)
 ..W:'$P(NODE,U,4) "Comments: ",$P(NODE,U,12),!!
"RTN","PSDESTP",62,0)
 .I $P(NODE,U,6)]"" D
"RTN","PSDESTP",63,0)
 ..W !,"Date/Time Cancelled: ",$P(NODE,U,5),!,"Cancelled By: ",$P(NODE,U,6),!,"Patient Returning Drug: ",$P(NODE,U,10),!,"Comments: ",$P(NODE,U,7),!!
"RTN","PSDESTP",64,0)
DONE ;
"RTN","PSDESTP",65,0)
 I $E(IOST)'="C" W @IOF
"RTN","PSDESTP",66,0)
 I $E(IOST,1,2)="C-",'PSDOUT W !! K DIR,DIRUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu" D ^DIR K DIR
"RTN","PSDESTP",67,0)
END ;
"RTN","PSDESTP",68,0)
 K %,%DT,%H,%I,%ZIS,ALL,C,CNT,DA,DIC,DIR,DIROUT,DIRUT,DTOUT,DUOUT,LN,NODE
"RTN","PSDESTP",69,0)
 K JJ,PG,PBACOM,PHARM,PHARMC,PHARMN,PHARMNC,POP,PPDU,PSD,PSDA,PSDATE,PSDCD,PSDCOMS,PSDCOM3,PSDED,PSDEV,PSDGS,PSDN,PSDPAT,PSDPATR,PSDPDU,PSDOUT,PSDR,PSDRG,PSDRN,PSDS,PSDTOT,PSDSD,PSDSN,PSDT,PSDTR,PSDVAU,PVAULT,PSDYR,PSDCYR
"RTN","PSDESTP",70,0)
 K QTY,RPDT,X,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDESTP",71,0)
 K ^TMP("PSDESTP",$J)
"RTN","PSDESTP",72,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDESTP",73,0)
 Q
"RTN","PSDESTP",74,0)
HDR ;prints header information
"RTN","PSDESTP",75,0)
 I $E(IOST,1,2)="C-",PG W ! K DA,DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSDOUT=1 Q
"RTN","PSDESTP",76,0)
 S PG=PG+1 W:$Y @IOF W !,?70,"PAGE: ",PG,!,?15,"DESTROYED CS DRUGS REPORT for ",PSDSN
"RTN","PSDESTP",77,0)
 W !,?15,"Period From: ",$P(PSDATE,"^")," to: ",$P(PSDATE,"^",2),!,?15,"Run Date: ",RPDT,!!,"=> VAULT",!,LN,!
"RTN","PSDESTP",78,0)
 Q
"RTN","PSDESTP",79,0)
GTOT ;10/20/95 msg added,grand total,inserted 8/24/95
"RTN","PSDESTP",80,0)
 Q:PSDOUT
"RTN","PSDESTP",81,0)
 W !!!!?50,"Summary Total: ",PSDTOT
"RTN","PSDESTP",82,0)
 W !!!?15,"*** Drugs returned by a patient ARE NOT ADDED to Summary Total***"
"RTN","PSDESTP",83,0)
 Q
"RTN","PSDESTP",84,0)
SAVE ;saves variables for queueing
"RTN","PSDESTP",85,0)
 S (ZTSAVE("JJ"),ZTSAVE("PSDSD"),ZTSAVE("PSDED"),ZTSAVE("PSDATE"),ZTSAVE("PSDS"),ZTSAVE("PSDSN"),ZTSAVE("PSDTOT"))=""
"RTN","PSDESTP",86,0)
 S:$D(ALL) ZTSAVE("ALL")="" S:$D(PSDRG) ZTSAVE("PSDRG(")=""
"RTN","PSDESTP",87,0)
 S:$D(PSDVAU) ZTSAVE("PSDVAU(")=""
"RTN","PSDESTP",88,0)
 Q
"RTN","PSDESTP",89,0)
SET ;sets data;10/20/95 added bal.adj comms. PBACOM
"RTN","PSDESTP",90,0)
 S CNT=CNT+1
"RTN","PSDESTP",91,0)
 I '$D(PSDR) S PSDR=""  ;<- JD *62
"RTN","PSDESTP",92,0)
 S (PSDGS,PBACOM)=""
"RTN","PSDESTP",93,0)
 S NODE=^PSD(58.86,PSDA,0),PSDRN=$S($G(^PSD(58.86,PSDA,1))]"":$G(^PSD(58.86,PSDA,1))_"*",$P($G(^PSDRUG(+PSDR,0)),"^")]"":$P($G(^PSDRUG(+PSDR,0)),"^"),1:"#"_PSDA_" DRUG NAME MISSING")
"RTN","PSDESTP",94,0)
 S PSDTR=$P(NODE,"^",9) I +PSDTR S PSDGS=$P($G(^PSD(58.81,PSDTR,0)),U,17),PBACOM=$P($G(^PSD(58.81,PSDTR,0)),U,16)
"RTN","PSDESTP",95,0)
 S QTY=$P(NODE,"^",3),PHARM=+$P(NODE,"^",10),PHARMN=$S($P($G(^VA(200,PHARM,0)),"^")]"":$P(^(0),"^"),1:"")
"RTN","PSDESTP",96,0)
 S PPDU=$P($G(^PSDRUG(+PSDR,660)),U,6),PSDPDU=$J(PPDU*QTY,1,3)
"RTN","PSDESTP",97,0)
 S Y=PSD X ^DD("DD") S PSDYR=$P(Y,",",2)
"RTN","PSDESTP",98,0)
 S PSDT=$E(PSD,4,5)_"/"_$E(PSD,6,7)_"/"_PSDYR
"RTN","PSDESTP",99,0)
 S PVAULT=+$P($G(^PSD(58.86,PSDA,0)),"^",7)
"RTN","PSDESTP",100,0)
 S PSDCOMS=$P($G(^PSD(58.86,PSDA,2)),"^")
"RTN","PSDESTP",101,0)
 S PSDCD=$P($G(^PSD(58.86,PSDA,3)),"^") I PSDCD S Y=PSDCD X ^DD("DD") S PSDCYR=$P(Y,",",2) S PSDCD=$E(PSDCD,4,5)_"/"_$E(PSDCD,6,7)_"/"_PSDCYR
"RTN","PSDESTP",102,0)
 S PHARMC=+$P($G(^PSD(58.86,PSDA,3)),"^",2),PHARMNC=$S($P($G(^VA(200,PHARMC,0)),"^")]"":$P(^(0),"^"),1:"")
"RTN","PSDESTP",103,0)
 S PSDCOM3=$P($G(^PSD(58.86,PSDA,3)),"^",3)
"RTN","PSDESTP",104,0)
 S PSDPAT=+$P(NODE,"^",13),PSDPATR=$S($P($G(^DPT(PSDPAT,0)),"^")]"":$P(^(0),"^"),1:"")
"RTN","PSDESTP",105,0)
 S ^TMP("PSDESTP",$J,PSDA,PSDRN)=QTY_"^"_PHARMN_"^"_PSDT_"^"_PSDCOMS_"^"_PSDCD_"^"_PHARMNC_"^"_PSDCOM3_"^"_PSDGS_"^"_PVAULT_"^"_PSDPATR_"^"_PSDPDU_"^"_PBACOM
"RTN","PSDESTP",106,0)
 Q
"RTN","PSDGSRV1")
0^2^B33992603^B33639338
"RTN","PSDGSRV1",1,0)
PSDGSRV1  ;BIR/BJW-Complete GS for Ret Stk/Destroy ; 7 Apr 98
"RTN","PSDGSRV1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**4,8,9,56,62**;13 Feb 97;Build 3
"RTN","PSDGSRV1",3,0)
 ;**Y2K compliance** display 4 digit year on va forms
"RTN","PSDGSRV1",4,0)
 ;modified for NOIS:NCH-1296-41051;amended to update dest. bal
"RTN","PSDGSRV1",5,0)
 ;modified for NOIS: FAV-0498-70549
"RTN","PSDGSRV1",6,0)
QTY ;
"RTN","PSDGSRV1",7,0)
 W ! K DIR,DIRUT S DIR(0)="NA^"_$S(COMP=3:1,1:.01)_":"_QTY_":"_$S(COMP=3:0,1:2)
"RTN","PSDGSRV1",8,0)
 S DIR("A")="Quantity of "_NBKU_" "_$S(COMP=3:"Returned to Stock",1:"Turned in for Destruction")_": "
"RTN","PSDGSRV1",9,0)
 S DIR("?")="Enter a quantity from "_$S(COMP=3:1,1:.01)_" to "_QTY
"RTN","PSDGSRV1",10,0)
 D ^DIR K DIR I 'Y!$D(DIRUT) D MSG G END
"RTN","PSDGSRV1",11,0)
 S RQTY=+Y K DIRUT
"RTN","PSDGSRV1",12,0)
ASKN K DA,DIR,DTOUT,DUOUT S DIR("A")="RETURNED BY NURSE",DIR(0)="58.81,29O" D ^DIR K DIR I $D(DUOUT)!($D(DTOUT)) D MSG G END
"RTN","PSDGSRV1",13,0)
 S NURS=$P(Y,"^") I NURS S NURSN=$P($G(^VA(200,+NURS,0)),"^")
"RTN","PSDGSRV1",14,0)
REAS K DA,DIR,DTOUT,DUOUT S DIR(0)=$S(COMP=3:"58.81,36O",1:"58.81,39O") D ^DIR K DIR I $D(DTOUT)!($D(DUOUT)) D MSG G END
"RTN","PSDGSRV1",15,0)
 S REAS=Y
"RTN","PSDGSRV1",16,0)
OK K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Is this OK",DIR("B")="YES"
"RTN","PSDGSRV1",17,0)
 S DIR("?",1)="Answer 'YES' to post this completed Green Sheet data,",DIR("?")="answer 'NO' to edit or '^' to quit."
"RTN","PSDGSRV1",18,0)
 D ^DIR K DIR I $D(DIRUT) D MSG G END
"RTN","PSDGSRV1",19,0)
 I 'Y G QTY
"RTN","PSDGSRV1",20,0)
UPDATE ;update 58.81
"RTN","PSDGSRV1",21,0)
 W !!,"Accessing Green Sheet information...",!
"RTN","PSDGSRV1",22,0)
 D NOW^%DTC S RECDT=+% D:COMP=3 SUB
"RTN","PSDGSRV1",23,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81
"RTN","PSDGSRV1",24,0)
 S:COMP=3 DR="34////"_RECDT_";35////"_RQTY_";41////"_BAL_";33////"_PSDUZ_";10////"_CSTAT_";11////"_COMP_";22////"_+$E(RECDT,1,12)_";29////"_NURS_";36///^S X=REAS"  ; <*62 RJS>
"RTN","PSDGSRV1",25,0)
 S:COMP=2 DR="37////"_RECDT_";38////"_RQTY_";33////"_PSDUZ_";10////"_CSTAT_";11////"_COMP_";22////"_+$E(RECDT,1,12)_";29////"_NURS_";39///^S X=REAS"  ; <*62 RJS>
"RTN","PSDGSRV1",26,0)
 D ^DIE K DA,DIE,DR
"RTN","PSDGSRV1",27,0)
 W !!,"Updating your records..."
"RTN","PSDGSRV1",28,0)
ORDER ;update order info in 58.8
"RTN","PSDGSRV1",29,0)
 ;chged last line to d desta
"RTN","PSDGSRV1",30,0)
 W "nursing records now..."
"RTN","PSDGSRV1",31,0)
 K DA,DIE,DR S DA=ORD,DA(1)=PSDR,DA(2)=NAOU,DIE="^PSD(58.8,"_DA(2)_",1,"_DA(1)_",3,",DR="10////"_CSTAT_";11////"_COMP_";12////"_RECDT D ^DIE K DA,DIE,DR
"RTN","PSDGSRV1",32,0)
 ;monthly total
"RTN","PSDGSRV1",33,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,0)) S ^(0)="^58.801A^^"
"RTN","PSDGSRV1",34,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,5,$E(DT,1,5)*100,0)) K DIC S DIC="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=+PSDS,DA(1)=PSDR D ^DIC K DIC,DA,DINUM,DLAYGO
"RTN","PSDGSRV1",35,0)
 K DA,DIE,DR S DIE="^PSD(58.8,"_+PSDS_",1,"_PSDR_",5,",DA(2)=+PSDS,DA(1)=PSDR,DA=$E(DT,1,5)*100,DR=$S(COMP=3:"11////^S X=$P($G(^(0)),""^"",7)+RQTY",1:"12////^S X=$P($G(^(0)),""^"",8)+RQTY") D ^DIE K DA,DIE,DR
"RTN","PSDGSRV1",36,0)
 W "done.",!!
"RTN","PSDGSRV1",37,0)
 S STAT=$P($G(^PSD(58.81,PSDA,0)),"^",11) W ?2,"*** The status of your Green Sheet #"_PSDPN_" *** ",!
"RTN","PSDGSRV1",38,0)
 S CSTAT=$P($G(^PSD(58.81,PSDA,0)),"^",12) W ?6,$S($P($G(^PSD(58.82,STAT,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")_" "_$P($G(^PSD(58.83,CSTAT,0)),"^")
"RTN","PSDGSRV1",39,0)
 I COMP=3 S MFG=$P(^PSD(58.81,PSDA,0),"^",13),LOT=$P(^(0),"^",14),EXP=$P(^(0),"^",15) D PRINT G END
"RTN","PSDGSRV1",40,0)
 I COMP=2 D DESTA
"RTN","PSDGSRV1",41,0)
END K %,%DT,%H,%I,BAL,C,COMP,CPBY,CSTAT,D,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DR,DTOUT,DUOUT
"RTN","PSDGSRV1",42,0)
 K EXP,EXP1,EXPD,LOT,MFG,NAOU,NBKU,NODE,NOK,NUM,NURS,NURSN,OCOMP,OK,ORD,PG,POP,PSDA,PSDCT,PSDEV,PSDHLD,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDSN,PSDTYP,PSDUZ,PSDUZN,PSDYR
"RTN","PSDGSRV1",43,0)
 K QTY,REAS,RECD,RECDT,RQTY,STAT,STATN,SUB,WARDBAL,X,Y
"RTN","PSDGSRV1",44,0)
 Q
"RTN","PSDGSRV1",45,0)
MSG ;
"RTN","PSDGSRV1",46,0)
 W $C(7),!!,"*** THIS GREEN SHEET HAS NOT BEEN COMPLETED ***",!,"The status remains "_STATN,! S PSDOUT=1 Q
"RTN","PSDGSRV1",47,0)
 Q
"RTN","PSDGSRV1",48,0)
SUB ;add balance,Line 4,6,9 added 7/9/97 to update naou bal.
"RTN","PSDGSRV1",49,0)
 F  L +^PSD(58.8,+PSDS,1,PSDR,0):0 I  Q
"RTN","PSDGSRV1",50,0)
 D NOW^%DTC S RECDT=+%
"RTN","PSDGSRV1",51,0)
 S BAL=+$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)
"RTN","PSDGSRV1",52,0)
 S WARDBAL=+$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)
"RTN","PSDGSRV1",53,0)
 S $P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)=$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",4)+RQTY
"RTN","PSDGSRV1",54,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDGSRV1",55,0)
 S $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)-RQTY
"RTN","PSDGSRV1",56,0)
 L -^PSD(58.8,+PSDS,1,PSDR,0)
"RTN","PSDGSRV1",57,0)
 W !!!,"Old Balance: ",BAL,?25,"New Balance: ",BAL+RQTY,!!
"RTN","PSDGSRV1",58,0)
 W !!,"(NAOU) Old Balance: ",WARDBAL,?32,"(NAOU) New Balance: ",WARDBAL-RQTY,!!
"RTN","PSDGSRV1",59,0)
 Q
"RTN","PSDGSRV1",60,0)
DESTA ;update naou balance added 8/19/96
"RTN","PSDGSRV1",61,0)
 F  L +^PSD(58.8,+PSDS,1,PSDR,0):0 I  Q
"RTN","PSDGSRV1",62,0)
 S WARDBAL=+$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)
"RTN","PSDGSRV1",63,0)
 ;PSD*3*56;REMOVED CHECK FOR PATIENT ID
"RTN","PSDGSRV1",64,0)
 S $P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)=$P(^PSD(58.8,NAOU,1,PSDR,0),"^",4)-RQTY
"RTN","PSDGSRV1",65,0)
 L -^PSD(58.8,+PSDS,1,PSDR,0)
"RTN","PSDGSRV1",66,0)
 W !!!,"(NAOU) Old Balance: ",WARDBAL,?32,"(NAOU) New Balance: ",WARDBAL-RQTY,!
"RTN","PSDGSRV1",67,0)
DEST ;set up file 58.86
"RTN","PSDGSRV1",68,0)
 S PSDOUT=0,PSDCT=1
"RTN","PSDGSRV1",69,0)
 W !!,"Accessing your transaction history...",!!
"RTN","PSDGSRV1",70,0)
 S NODE=^PSD(58.81,PSDA,0),PSDTYP=$P(NODE,"^",2),(MFG,LOT,EXP)=""
"RTN","PSDGSRV1",71,0)
 I PSDTYP=9 S COMP=2,REAS=$P(NODE,"^",16),RECDT=$E($P(NODE,"^",4),1,12),RQTY=$P(NODE,"^",6),RQTY=$E(RQTY,2,6),PSDS=$P(NODE,"^",3)
"RTN","PSDGSRV1",72,0)
 I  S PSDR=$P(NODE,"^",5),PSDRN=$P($G(^PSDRUG(+PSDR,0)),"^"),PSDUZ=DUZ,NBKU=$P($G(^PSD(58.8,+PSDS,1,+PSDR,0)),"^",8)
"RTN","PSDGSRV1",73,0)
 I PSDTYP=2 S REAS=$P($G(^PSD(58.81,PSDA,3)),"^",6),MFG=$P(NODE,"^",13),LOT=$P(NODE,"^",14),EXP=$P(NODE,"^",15)
"RTN","PSDGSRV1",74,0)
 W !!,"Creating an entry in the Destruction file..."
"RTN","PSDGSRV1",75,0)
 F  L +^PSD(58.86,0):0 I  Q
"RTN","PSDGSRV1",76,0)
FIND S PSDHLD=$P(^PSD(58.86,0),"^",3)+1 I $D(^PSD(58.86,PSDHLD)) S $P(^PSD(58.86,0),"^",3)=PSDHLD G FIND
"RTN","PSDGSRV1",77,0)
 K DA,DIC,DLAYGO S (DIC,DLAYGO)=58.86,DIC(0)="L",(X,DINUM)=PSDHLD D ^DIC K DIC,DLAYGO
"RTN","PSDGSRV1",78,0)
 L -^PSD(58.86,0)
"RTN","PSDGSRV1",79,0)
 W !!,"Your Destruction Holding number is ",PSDHLD
"RTN","PSDGSRV1",80,0)
 K DA,DIE,DR S DIE=58.86,DA=PSDHLD,DR="1////"_PSDR_";2////"_RQTY_";3////"_PSDUZ_";5////"_RECDT_";6////"_PSDS_";8////"_PSDA_";"_$S($D(NURSN):"4//^S X=NURSN",1:"4")_";11//^S X=PSDCT;12//^S X=NBKU"
"RTN","PSDGSRV1",81,0)
 D ^DIE K DIE,DA,DR S $P(^PSD(58.81,PSDA,3),"^",8)=PSDHLD
"RTN","PSDGSRV1",82,0)
 I $D(DTOUT)!$D(Y) W !!,"Incomplete information.  You must use the Reprint Disp/Receiving Report",!,"for VA FORM 10-2321 to be printed.",! Q
"RTN","PSDGSRV1",83,0)
PRINT ;print 2321
"RTN","PSDGSRV1",84,0)
 W !!,"Number of copies of VA FORM 10-2321? " R NUM:DTIME I '$T!(NUM="^")!(NUM="") W !!,"No copies printed!!",!! Q
"RTN","PSDGSRV1",85,0)
 I NUM'?1N!(NUM=0)  W !!,"Enter a whole number between 1 and 9",! G PRINT
"RTN","PSDGSRV1",86,0)
 S Y=RECDT X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4)
"RTN","PSDGSRV1",87,0)
 S PG=0,RECDT=$E(RECDT,4,5)_"/"_$E(RECDT,6,7)_"/"_PSDYR
"RTN","PSDGSRV1",88,0)
 I EXP S (EXP1,EXPD)=$$FMTE^XLFDT(EXP,"5D") S:'$P(EXP1,"/",2) EXPD=$P(EXP1,"/")_"/"_$P(EXP1,"/",3) S EXP=EXPD
"RTN","PSDGSRV1",89,0)
 D ^PSDGSRV2
"RTN","PSDGSRV1",90,0)
 Q
"RTN","PSDOPT")
0^5^B83861199^B82663142
"RTN","PSDOPT",1,0)
PSDOPT ;BIR/JPW,LTL,BJW-Outpatient Rx Entry ; 2/5/04 12:15pm
"RTN","PSDOPT",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**10,11,15,21,30,39,48,62**;13 Feb 97;Build 3
"RTN","PSDOPT",3,0)
 ;Reference to ^PSDRUG( supported by DBIA #221
"RTN","PSDOPT",4,0)
 ;References to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDOPT",5,0)
 ;References to file 58.81 are covered by DBIA #2808
"RTN","PSDOPT",6,0)
 ;Reference to PSRX( supported by DBIA #986
"RTN","PSDOPT",7,0)
 ;Reference to PSOFUNC supported by DBIA #981
"RTN","PSDOPT",8,0)
 ;Line Tag FINAL^PSOLSET supported by DBIA #982
"RTN","PSDOPT",9,0)
 ;
"RTN","PSDOPT",10,0)
 ;mod.for nois:tua-0498-32173,askp,bc1;ver
"RTN","PSDOPT",11,0)
 ;enhancement for Outpat V7 status code of 12,13,14,15 in askp
"RTN","PSDOPT",12,0)
 ;
"RTN","PSDOPT",13,0)
 ;further modifications related to the deletion of
"RTN","PSDOPT",14,0)
 ;refills made in April 1999 
"RTN","PSDOPT",15,0)
 ;
"RTN","PSDOPT",16,0)
 ;PSD*3*39 Kill all variables
"RTN","PSDOPT",17,0)
 D PSDKLL^PSDOPT2
"RTN","PSDOPT",18,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDOPT",19,0)
 I '$D(^XUSEC("PSJ RPHARM",DUZ)) W !!,"Please contact your Pharmacy Coordinator for access",!,"to log Outpatient Prescriptions.  PSJ RPHARM security key required.",!! Q
"RTN","PSDOPT",20,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDOPT",21,0)
 N X,X1 D SIG^XUSESIG I X1="" G END
"RTN","PSDOPT",22,0)
 N LN S (PSDOUT,NEW)=0,PSDUZ=DUZ,$P(LN,"-",80)="",Y=DT
"RTN","PSDOPT",23,0)
 X ^DD("DD") S RPDT=Y
"RTN","PSDOPT",24,0)
ASKD ;ask disp site
"RTN","PSDOPT",25,0)
 S PSDS=$P(PSDSITE,U,3),PSDSN=$P(PSDSITE,U,4)
"RTN","PSDOPT",26,0)
 G:$P(PSDSITE,U,5) CHKD
"RTN","PSDOPT",27,0)
 K DIC,DA S DIC=58.8,DIC(0)="QEAZ",DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S($P(^(0),""^"",2)[""M"":1,$P(^(0),""^"",2)[""S"":1,1:0),$S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0)"
"RTN","PSDOPT",28,0)
 S DIC("A")="Select Primary Dispensing Site: ",DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDOPT",29,0)
 W ! D ^DIC K DIC G:Y<0 END
"RTN","PSDOPT",30,0)
 S PSDS=+Y,PSDSN=$P(Y,"^",2),$P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDSN
"RTN","PSDOPT",31,0)
CHKD I '$O(^PSD(58.8,PSDS,1,0)) W !!,"There are no stocked drugs for this Pharmacy Vault!!",!! G END
"RTN","PSDOPT",32,0)
ASKPH ;ask releasing RPH
"RTN","PSDOPT",33,0)
 S DIC="^VA(200,",DIC(0)="QEAM",DIC("S")="I $D(^XUSEC(""PSORPH"",+Y))"
"RTN","PSDOPT",34,0)
 S DIC("A")="Please identify Pharmacist for Outpatient Release: "
"RTN","PSDOPT",35,0)
 S:$D(^XUSEC("PSORPH",DUZ)) DIC("B")=$P($G(^VA(200,DUZ,0)),U)
"RTN","PSDOPT",36,0)
 W ! D ^DIC K DIC G:Y<1 END S PSDRPH=+Y
"RTN","PSDOPT",37,0)
ASKP ;ask rx #
"RTN","PSDOPT",38,0)
 K PSDSEL,PSDPOST,PSDREL
"RTN","PSDOPT",39,0)
 ;PSD*3*30 (Dave Blocker ) Lock the script node
"RTN","PSDOPT",40,0)
 I $G(PSDRX)'="" L -^PSRX(PSDRX)
"RTN","PSDOPT",41,0)
 W ! K DIR,NEW,PSDRX,PSDRXIN,RXNUM S PSDOUT=0 S DIR("A")="Enter/Wand PRESCRIPTION number"
"RTN","PSDOPT",42,0)
 S DIR("?")="^D HELP^PSODISP",DIR(0)="F^1:35" D ^DIR K DIR
"RTN","PSDOPT",43,0)
 G:$D(DTOUT)!($D(DUOUT)) END G:X="" ASKPH
"RTN","PSDOPT",44,0)
 S X=$$UP^XLFSTR(X)
"RTN","PSDOPT",45,0)
 I X'["-" D  S PSDRX=$G(PSDRXIN)
"RTN","PSDOPT",46,0)
 .S PSDRX=0 F  S PSDRX=$O(^PSRX("B",X,PSDRX)) Q:'PSDRX  S PSDRXIN=PSDRX D VER
"RTN","PSDOPT",47,0)
 I X'["-",'$G(PSDRX)!('$D(^PSRX(+$G(PSDRX),0))) W !,"INVALID PRESCRIPTION NUMBER" G ASKP
"RTN","PSDOPT",48,0)
 ;
"RTN","PSDOPT",49,0)
 ;PSD*3*30 - lock the script
"RTN","PSDOPT",50,0)
 I X'["-" L +^PSRX(PSDRX):5 I '$T W !!,"Sorry, someone else is editting this prescription. Please try again later." K PSDRX G ASKP
"RTN","PSDOPT",51,0)
 ;
"RTN","PSDOPT",52,0)
 ;DAVE B (PSD*3*15) Show previous postings
"RTN","PSDOPT",53,0)
 I X'["-" I $G(PSOVR)=1,$G(PSDSTA)=12!($G(PSDSTA)=13)!($G(PSDSTA)=14)!($G(PSDSTA)=15)!($G(PSDSTA)=11) S PSDXXX=X D CHKRF I $G(PSDNEXT)=1 G ASKP
"RTN","PSDOPT",54,0)
 ;<JD *62
"RTN","PSDOPT",55,0)
 ;
"RTN","PSDOPT",56,0)
 S PSD(1)=X,DIC="^DIC(4,",DR=99,DA=+$P($G(^XMB(1,1,"XUS")),U,17)
"RTN","PSDOPT",57,0)
 K DIQ S DIQ="PSD" D EN^DIQ1 S X=PSD(1) K DIC,DR,DIQ
"RTN","PSDOPT",58,0)
 I X["-",$P(X,"-")'=PSD(4,DA,99) K DA,PSD W !?7,$C(7),"   INVALID STATION NUMBER !!",! G ASKP
"RTN","PSDOPT",59,0)
 K DA,PSD
"RTN","PSDOPT",60,0)
 I X["-" S PSDRX=$P(X,"-",2) I (PSDRX'?1N.N.1U) W !?7,$C(7),"   INVALID PRESCRIPTION NUMBER" G ASKP
"RTN","PSDOPT",61,0)
 I X["-" I '$D(^PSRX(+$G(PSDRX),0))!($G(PSDRX)']"") W !?7,$C(7),"   NON-EXISTENT PRESCRIPTION" G ASKP
"RTN","PSDOPT",62,0)
 ;
"RTN","PSDOPT",63,0)
 I X["-",$D(^PSRX(PSDRX,0)) S PSDRXIN=+PSDRX D VER I PSOVR=1,$G(PSDSTA)=12!($G(PSDSTA)=13)!($G(PSDSTA)=14)!($G(PSDSTA)=15) D CHKRF I $G(PSDNEXT)=1 G ASKP
"RTN","PSDOPT",64,0)
 I X["-" L +^PSRX(PSDRX):5 I '$T W !!,"Sorry, someone else is editting this prescription. Please try again later." K PSDRX G ASKP
"RTN","PSDOPT",65,0)
 ;
"RTN","PSDOPT",66,0)
 ; (PSD*3*21) Check for transmission status for barcode entry
"RTN","PSDOPT",67,0)
 ;
"RTN","PSDOPT",68,0)
 G:$D(^PSRX(PSDRX,0)) BC1
"RTN","PSDOPT",69,0)
 W !?7,$C(7),"   IMPROPER BARCODE FORMAT" G ASKP
"RTN","PSDOPT",70,0)
BC1 ;
"RTN","PSDOPT",71,0)
 S PSDRXIN=+PSDRX D VER
"RTN","PSDOPT",72,0)
 I $G(PSDSTA)=13!(+$P($G(^PSRX(+PSDRX,0)),"^",2)=0) W !?7,$C(7),"    PRESCRIPTION HAS BEEN DELETED." G ASKP
"RTN","PSDOPT",73,0)
 I $G(PSDSTA),$S($G(PSDSTA)=2:0,$G(PSDSTA)=5:0,$G(PSDSTA)=11:0,$G(PSDSTA)=12:0,$G(PSDSTA)=14:0,$G(PSDSTA)=15:0,1:1) D  K J,RX0,RX2,ST,ST0 G ASKP
"RTN","PSDOPT",74,0)
 .S RX0=$G(^PSRX(+PSDRX,0)),RX2=^PSRX(+PSDRX,2),J=PSDRX S $P(RX0,"^",15)=$G(PSDSTA) D ^PSOFUNC
"RTN","PSDOPT",75,0)
 .W !!,$C(7),"     Status of ",ST," is not appropriate for selection."
"RTN","PSDOPT",76,0)
 K PSDSTA,PSOVR,PSDRXIN
"RTN","PSDOPT",77,0)
 S RXNUM=$P($G(^PSRX(+PSDRX,0)),U),PSDR=+$P($G(^(0)),U,6),DFN=+$P($G(^(0)),U,2),QTY=$P($G(^(0)),U,7),PSDRN=$P($G(^PSDRUG(PSDR,0)),"^")
"RTN","PSDOPT",78,0)
 N C S Y=DFN,C=$P(^DD(58.81,73,0),U,2) D Y^DIQ S PATN=Y
"RTN","PSDOPT",79,0)
 D PID^VADPT6
"RTN","PSDOPT",80,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,0)) W !!,PSDRN," is not currently stocked in ",PSDSN,".",!!,"** No action taken. **",!! G END
"RTN","PSDOPT",81,0)
 I $D(^PSD(58.81,"AOP",PSDRX)) D ^PSDOPT2 I PSDOUT D MSG G END
"RTN","PSDOPT",82,0)
 G ^PSDOPT0
"RTN","PSDOPT",83,0)
CHK ;displays and checks if ok
"RTN","PSDOPT",84,0)
CLLDIR I $D(PSDSEL("OR")) S DIR(0)="S^1:Original;",CNT=1
"RTN","PSDOPT",85,0)
 I $D(PSDSEL("RF")) D
"RTN","PSDOPT",86,0)
 .S X1=0 F  S X1=$O(PSDSEL("RF",X1)) Q:X1=""  D
"RTN","PSDOPT",87,0)
 ..I $D(PSDRET("RF",X1)),(PSDRET("RF",X1)\1)=$P(PSDSEL("RF",X1),"^") D RTSDTC^PSDOPT2 Q
"RTN","PSDOPT",88,0)
 ..I $D(PSDRET("RF",X1)),PSDRET("RF",X1)<$P(PSDSEL("RF",X1),"^") D CLLDIR2 Q
"RTN","PSDOPT",89,0)
 ..I '$D(PSDRET("RF",X1)) D CLLDIR2 Q
"RTN","PSDOPT",90,0)
 ..Q
"RTN","PSDOPT",91,0)
 I $D(PSDSEL("PR")) D
"RTN","PSDOPT",92,0)
 .S X1=0 F  S X1=$O(PSDSEL("PR",X1)) Q:X1=""  I '$D(PSDRET("PR",X1)) S CNT=$G(CNT)+1,DIR(0)=$S($G(CNT)=1:"S^1:Partial #"_X1,1:DIR(0)_CNT_":Partial #"_X1)_" ("_$P(PSDSEL("PR",X1),"^",2)_");"
"RTN","PSDOPT",93,0)
 I $G(DIR(0))'="" D
"RTN","PSDOPT",94,0)
 .K PSDERR D ^DIR I $D(DIRUT) S PSDERR=1 Q
"RTN","PSDOPT",95,0)
 .S PSDA=$E(Y(0))
"RTN","PSDOPT",96,0)
 Q:$D(PSDERR)
"RTN","PSDOPT",97,0)
 Q:'$D(Y(0))  I PSDA="O" S DAT=$P($G(^PSRX(PSDRX,2)),U,2),PSDPOST=$P(PSDSEL("OR"),"^",3),PSDREL=$P(PSDSEL("OR"),"^",4) G PROCESS
"RTN","PSDOPT",98,0)
 I PSDA="R" S XX=$P(Y(0),"#",2),XXX=$P(XX," ",1),DAT=$P($G(PSDSEL("RF",XXX)),"^",1),QTY=$P(PSDSEL("RF",XXX),U,2),PSDPOST=$P(PSDSEL("RF",XXX),U,3),PSDREL=$P(PSDSEL("RF",XXX),U,4) G PROCESS
"RTN","PSDOPT",99,0)
 I PSDA="P" S XX=$P(Y(0),"#",2),XXX=$P(XX," ",1),DAT=$P($G(PSDSEL("PR",XXX)),"^",1),QTY=$P(PSDSEL("PR",XXX),U,2),PSDPOST=$P(PSDSEL("PR",XXX),U,3),PSDREL=$P(PSDSEL("PR",XXX),U,4) G PROCESS
"RTN","PSDOPT",100,0)
 W !,"Error somewhere" G ASKP
"RTN","PSDOPT",101,0)
PROCESS ;process selection
"RTN","PSDOPT",102,0)
 I PSDA'="O" S PSDFLNO=XXX ;fill number
"RTN","PSDOPT",103,0)
 I PSDA="O" S NEW=1,(NEW(1),NEW(2))=0 ;Original
"RTN","PSDOPT",104,0)
 I PSDA="R" S NEW(1)=XXX,(NEW,NEW(2))=0 ;Refill
"RTN","PSDOPT",105,0)
 I PSDA="P" S NEW(2)=XXX,(NEW,NEW(1))=0 ;Partial
"RTN","PSDOPT",106,0)
 S X=0 F  S X=$O(^PSRX(PSDRX,4,X)) Q:X'>0  S STATUS=$P($G(^PSRX(PSDRX,4,X,0)),"^",4),NUMBER=$P($G(^PSRX(PSDRX,4,X,0)),"^",3) I $G(STATUS)'=3 D
"RTN","PSDOPT",107,0)
 .I NUMBER=0,$G(NEW)=1,$G(NEW(1))=0 D CMOPMSG
"RTN","PSDOPT",108,0)
 .I NUMBER=$G(NEW(1)),$G(NEW)=0,PSDA'="P",'$D(PSDRET("RF",NUMBER)) D CMOPMSG
"RTN","PSDOPT",109,0)
 .;I NUMBER=$G(NEW(2)),$G(NEW(1))=0,$G(NEW)=0 D CMOPMSG ;Partials cannot be CMOP
"RTN","PSDOPT",110,0)
 I $G(PSDOUT)=1 G ASKP
"RTN","PSDOPT",111,0)
 ;
"RTN","PSDOPT",112,0)
 D:PSDA="O" PSDORIG^PSDOPT1 D:PSDA="R" PSDRFL^PSDOPT1 D:PSDA="P" PSDPRTL^PSDOPT1
"RTN","PSDOPT",113,0)
 I $G(PSDOUT)=1 G ASKP
"RTN","PSDOPT",114,0)
 I $G(PSDPOST)=1,$G(PSDREL)="" W !,"This fill has already been posted." D PSDREL^PSDOPT1 G ASKP
"RTN","PSDOPT",115,0)
 I $G(PSDREL)'="",$G(PSDPOST)'>0 W !,"This fill has already been released."
"RTN","PSDOPT",116,0)
 I $G(PSDREL)'="",$G(PSDPOST)>0 W !,"This fill has already been posted & released, no further action required." G ASKP
"RTN","PSDOPT",117,0)
 D DISPLAY G:PSDOUT END
"RTN","PSDOPT",118,0)
 K DA,DIR,DIRUT S DIR(0)="YA",DIR("B")="YES",DIR("A")="Is this OK? "
"RTN","PSDOPT",119,0)
 S DIR("?",1)="Answer 'YES' to log this RX transaction in your CS vault,",DIR("?")="answer 'NO' to reselect a prescription, or '^' to quit."
"RTN","PSDOPT",120,0)
 D ^DIR K DIR I Y<1 D MSG G:$D(DIRUT) END G:Y<1 ASKP
"RTN","PSDOPT",121,0)
 D ^PSDOPT1 G ASKP
"RTN","PSDOPT",122,0)
END K %,%H,%I,BAL,C,CNT,DA,DAT,DD,DFN,DIC,DIE,DIK,DINUM,DIR,DIROUT,DIRUT,DLAYGO,DO,DR,JJ,LN,NEW,NODE,NODE6 D FINAL^PSOLSET
"RTN","PSDOPT",123,0)
 I $G(PSDRX)'="" L -^PSRX(PSDRX)
"RTN","PSDOPT",124,0)
 K PATN,PHARM,PHARMN,PRF,PSDA,PSDATE,PSDOUT,PSDR,PSDRN,PSDRPH,PSDRX,PSDS,PSDSN,PSDT,PSDUZ,PSOCSUB,QTY,RF,RPDT,RXNUM,X,Y
"RTN","PSDOPT",125,0)
 D KVAR^VADPT K VA("PID"),VA("BID")
"RTN","PSDOPT",126,0)
 Q
"RTN","PSDOPT",127,0)
CLLDIR2 S CNT=$G(CNT)+1,DIR(0)=$S($G(CNT)=1:"S^1:Refill #"_X1,1:DIR(0)_CNT_":Refill #"_X1)_";"
"RTN","PSDOPT",128,0)
 Q
"RTN","PSDOPT",129,0)
DISPLAY ;disp data
"RTN","PSDOPT",130,0)
 W !!,?20,"View Controlled Substances Rx # ",RXNUM,!,?28,RPDT,!,LN,!!
"RTN","PSDOPT",131,0)
 W "Location: ",?10,PSDSN,?55
"RTN","PSDOPT",132,0)
 S PSDRN(1)=$S(NEW:"Original",$G(NEW(1)):"Refill #"_NEW(1),1:"Partial #"_$G(NEW(2))) W PSDRN(1)
"RTN","PSDOPT",133,0)
 W !,"Drug: ",?10,PSDRN,?55,"Quantity: ",QTY
"RTN","PSDOPT",134,0)
 ;
"RTN","PSDOPT",135,0)
 ;DAVE B (PSD*3*15) check for Non-numeric quantity
"RTN","PSDOPT",136,0)
 I QTY'?.N W !,"The Quantity is not strictly numeric. This will cause the new balance to be",!,"calculated incorrectly.",!
"RTN","PSDOPT",137,0)
 W !,"Patient: ",?10,PATN_"  ("_VA("BID")_")",?55,PSDRN(1)," Date: ",?65,$E(DAT,4,5)_"/"_$E(DAT,6,7)_"/"_$E(DAT,2,3),!
"RTN","PSDOPT",138,0)
 S BAL=+$P($G(^PSD(58.8,+PSDS,1,PSDR,0)),"^",4) I QTY>BAL W !!,?5,"Your balance is ",BAL,".",!,?5,"You may not dispense lower than your balance.",!! D MSG S PSDOUT=1 Q
"RTN","PSDOPT",139,0)
 W !!,?15,"Old Balance: ",BAL,?40,"New Balance: ",BAL-QTY,!!
"RTN","PSDOPT",140,0)
 Q
"RTN","PSDOPT",141,0)
MSG W $C(7),!!,"No action taken.  This transaction has not been recorded.",!!
"RTN","PSDOPT",142,0)
 Q
"RTN","PSDOPT",143,0)
VER ;Current Outpatient Version, and Rx status added 6/17/98
"RTN","PSDOPT",144,0)
 K PSDSTA S PSDHOLDX=$G(X) S PSOVR=$$VERSION^XPDUTL("PSO") S X=$G(PSDHOLDX) K PSDHOLDX S PSOVR=$S($G(PSOVR)>6:1,1:0)
"RTN","PSDOPT",145,0)
 I $G(PSDRXIN) S PSDSTA=$S(PSOVR:$P($G(^PSRX(PSDRXIN,"STA")),"^"),1:$P($G(^PSRX(PSDRXIN,0)),"^",15))
"RTN","PSDOPT",146,0)
 Q
"RTN","PSDOPT",147,0)
CHKRF ;Dave B (PSD*3*30) if its deleted, show status.
"RTN","PSDOPT",148,0)
 W !,"This RX has a status of '"_$S(PSDSTA=11:"EXPIRED",PSDSTA=12:"DISCONTINUED",PSDSTA=13:"DELETED",PSDSTA=14:"DISCONTINUED BY PROVIDER",PSDSTA=15:"DISCONTINUED (EDIT)",1:"Unknown  Procedure")_$S(PSDSTA=12:"'.",1:"', no action can be taken.")
"RTN","PSDOPT",149,0)
 ;< JD*62
"RTN","PSDOPT",150,0)
 I $O(^PSRX(PSDRX,"A",0))>0 W !!,"Below is a list of actions taken on the prescription.",!!,"DATE/TIME",?22,"PERSON",?45,"ACTIVITY",! F X=1:1:53 W "=" F X=1:1:(IOM-1) W "="
"RTN","PSDOPT",151,0)
 S X3=0 F  S X3=$O(^PSRX(PSDRX,"A",X3)) Q:X3=""  S DATA=$G(^PSRX(PSDRX,"A",X3,0)),Y=$P(DATA,"^",1) X ^DD("DD") S DATE=Y,X=$P(DATA,"^",2) D
"RTN","PSDOPT",152,0)
 .I $G(X)'="" S ACTIVITY=$$EXTERNAL^DILFD(52.3,.02,,X)
"RTN","PSDOPT",153,0)
 .S DELDUZ=$$EXTERNAL^DILFD(52.3,.03,,$P(DATA,"^",3)) S DELDUZ=$S($G(DELDUZ)="":"Unknown ("_$P(DATA,"^",3)_")",1:DELDUZ)
"RTN","PSDOPT",154,0)
 .K DELREAS S DELREAS=$P(DATA,"^",5)
"RTN","PSDOPT",155,0)
 .W !,DATE,?22,DELDUZ,?45,ACTIVITY I $G(DELREAS)'="" W !,"Comment: ",$G(DELREAS)
"RTN","PSDOPT",156,0)
 I $G(PSDSTA)'=12 S PSDNEXT=1 Q
"RTN","PSDOPT",157,0)
ASK12 R !,"Do you wish to continue? NO // ",AN:DTIME S:AN="" AN="N"
"RTN","PSDOPT",158,0)
 I "YyNn"'[AN W !,"Answer 'N'o, and you will prompted for another prescription." G ASK12
"RTN","PSDOPT",159,0)
 I "nN"[AN S PSDNEXT=1 Q
"RTN","PSDOPT",160,0)
 K PSDNEXT
"RTN","PSDOPT",161,0)
 Q
"RTN","PSDOPT",162,0)
CMOPMSG W !,?10,"This is a CMOP fill and has been transmitted, dispensed or ",!?10,"retransmitted.",! S PSDOUT=1 Q
"RTN","PSDOPT",163,0)
KLLALL ;Kill all
"RTN","PSDORP")
0^4^B26130595^B23997011
"RTN","PSDORP",1,0)
PSDORP ;BIR/JPW-Pharm CS Order Request Entry ; 8 Aug 94
"RTN","PSDORP",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**58,62**;13 Feb 97;Build 3
"RTN","PSDORP",3,0)
 W !!,"Controlled Substances Order Entry",!! S PSDUZ=DUZ,PSDUZN=$P($G(^VA(200,PSDUZ,0)),"^"),(MSG,MSG1)=0,Y=DT X ^DD("DD") S REQD=Y
"RTN","PSDORP",4,0)
NAOU ;select NAOU to order supplies for
"RTN","PSDORP",5,0)
 K ^UTILITY($J,"W")
"RTN","PSDORP",6,0)
 N X,DIWL,DIWR,DIWF,PSD S PSD=0,DIWL=1,DIWR=80,DIWF="W"
"RTN","PSDORP",7,0)
 F  S PSD=$O(^PSD(58.8,+$P(PSDSITE,U,3),5,PSD)) Q:'PSD  S X=$G(^PSD(58.8,+$P(PSDSITE,U,3),5,PSD,0)) D ^DIWP
"RTN","PSDORP",8,0)
 D ^DIWW
"RTN","PSDORP",9,0)
 ;; RJS - PSD*3.0*58
"RTN","PSDORP",10,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Ordering NAOU: "
"RTN","PSDORP",11,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDORP",12,0)
 D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDORP",13,0)
 I '$D(^PSD(58.8,NAOU,0)) S MSG=1 D MSG G END
"RTN","PSDORP",14,0)
 I '$O(^PSD(58.8,NAOU,1,0)) S MSG=1,MSG1=2 D MSG G END
"RTN","PSDORP",15,0)
 S PSDS=+$P(^PSD(58.8,NAOU,0),"^",4) I '+PSDS S (MSG,MSG1)=1 D MSG G END
"RTN","PSDORP",16,0)
 I '$D(^PSD(58.8,+PSDS,0)) S MSG=2 D MSG G END
"RTN","PSDORP",17,0)
 I '$O(^PSD(58.8,+PSDS,1,0)) S MSG=2,MSG1=2 D MSG G END
"RTN","PSDORP",18,0)
 S TYPE=$P(^PSD(58.8,+PSDS,0),"^",2),OKTYP=$S(TYPE="M":1,TYPE="S":1,1:0) I 'OKTYP W !!,"Contact your Pharmacy Coordinator.",!,"The Pharmacy Dispensing Site is invalid for this NAOU." G END
"RTN","PSDORP",19,0)
DRUG ;select drug
"RTN","PSDORP",20,0)
 K DA,DIC S DIC("W")="W:$P(^PSDRUG(Y,0),""^"",9) ""   N/F"" I $P(^PSD(58.8,NAOU,1,Y,0),""^"",14)]"""",$P(^(0),""^"",14)'>DT W $C(7),""  *** INACTIVE ***"""
"RTN","PSDORP",21,0)
 S DIC("S")="I '$P($G(^(7)),U,2),$S('$P(^(0),""^"",14):1,+$P(^(0),""^"",14)>DT:1,1:0)"
"RTN","PSDORP",22,0)
 ;; JD *62 ->
"RTN","PSDORP",23,0)
 S DA(1)=+PSDS,DIC(0)="QEAM",DIC="^PSD(58.8,"_+PSDS_",1,"
"RTN","PSDORP",24,0)
 ;one time requests not allowed by dispensing site
"RTN","PSDORP",25,0)
 D:'$P($G(^PSD(58.8,+PSDS,0)),U,13)
"RTN","PSDORP",26,0)
 .S DIC("W")="W:$P(^PSDRUG(Y,0),U,9) ""  N/F"" I $P(^PSD(58.8,NAOU,1,Y,0),U,14)]"""",$P(^(0),U,14)'>DT W $C(7),""  *** INACTIVE ***"""
"RTN","PSDORP",27,0)
 .S DIC("S")="I $S('$P(^(0),U,14):1,+$P(^(0),U,14)>DT:1,1:0)"
"RTN","PSDORP",28,0)
 .S DA(1)=+NAOU,DIC(0)="QEAM",DIC="^PSD(58.8,"_NAOU_",1,"
"RTN","PSDORP",29,0)
 D ^DIC K DIC G:Y<0 NAOU S PSDR=+Y,PSDRN=$S($P(^PSDRUG(PSDR,0),"^")]"":$P(^(0),"^"),1:"DRUG NAME MISSING")  ; <- JD *62
"RTN","PSDORP",30,0)
 I '$D(^PSD(58.8,NAOU,1,PSDR,0)) D MSG G END
"RTN","PSDORP",31,0)
 I '$D(^PSD(58.8,+PSDS,1,PSDR,0)) S MSG=2 D MSG G END
"RTN","PSDORP",32,0)
 S NBKU=$P(^PSD(58.8,+PSDS,1,PSDR,0),"^",8),NPKG=+$P(^(0),"^",9)
"RTN","PSDORP",33,0)
 I NBKU']"" S MSG1=3 D MSG G END
"RTN","PSDORP",34,0)
 I 'NPKG S MSG1=4 D MSG G END
"RTN","PSDORP",35,0)
 D LIST^PSDORL
"RTN","PSDORP",36,0)
 ;NAOU using perpetual?
"RTN","PSDORP",37,0)
 G:$P($G(^PSD(58.8,+NAOU,2)),U,5) ^PSDORP2
"RTN","PSDORP",38,0)
QTY K ORD S (CNT,PSDR(2),PSDOUT)=0
"RTN","PSDORP",39,0)
 ;DISPLAY STOCK LEVEL
"RTN","PSDORP",40,0)
 W:$P($G(^PSD(58.8,+NAOU,1,+PSDR,0)),U,3) !,"Stock Level:  ",$P($G(^(0)),U,3)," ",NBKU,!
"RTN","PSDORP",41,0)
 ;ASK QUANTITY
"RTN","PSDORP",42,0)
 S DIR(0)="NA^1:999999:0"
"RTN","PSDORP",43,0)
 S DIR("A")="QUANTITY ("_NBKU_"/"_NPKG_"): ",DIR("B")=NPKG
"RTN","PSDORP",44,0)
 D ^DIR K DIR G:Y<1 END S PSDQTY=Y
"RTN","PSDORP",45,0)
 I Y=NPKG S PSDQTY=NPKG,CNT=0 D DIE,ASK^PSDORP1 G:PSDOUT END G DRUG
"RTN","PSDORP",46,0)
 ;QUANTITY EXCEEDS PACKAGE SIZE, MULTIPLE ORDERS
"RTN","PSDORP",47,0)
 S:(PSDQTY#NPKG) CNT=1,PSDR(2)=(PSDQTY#NPKG)
"RTN","PSDORP",48,0)
 S CNT=$G(CNT)+(Y\NPKG)
"RTN","PSDORP",49,0)
 W !!,"This will be "_CNT_" separate order requests,"
"RTN","PSDORP",50,0)
 W:PSDR(2) !!,"One order for ",PSDR(2)," ",NBKU,", and"
"RTN","PSDORP",51,0)
 W !!,(PSDQTY\NPKG)," order"
"RTN","PSDORP",52,0)
 W:CNT>2!('PSDR(2)&(CNT=2)) "s"
"RTN","PSDORP",53,0)
 W " for ",NPKG," ",NBKU,"."
"RTN","PSDORP",54,0)
 W ! K DA,DIR,DIRUT S DIR(0)="Y",DIR("A")="Do you want me to generate the "_CNT_" separate order requests",DIR("B")="YES",DIR("?",1)="Answer 'YES' to create the multiple order requests,"
"RTN","PSDORP",55,0)
 S DIR("?")="Answer 'NO' to edit your quantity or '^' to quit." D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDORP",56,0)
 I 'Y W !,"No order request created.  You must edit quantity.",! G QTY
"RTN","PSDORP",57,0)
 I Y W !!,"The "_CNT_" requests are being created.  You must review every request.",! S PSDQTY=$S(PSDR(2):PSDR(2),1:NPKG) D  D ^PSDORP1 S PSDQTY=NPKG
"RTN","PSDORP",58,0)
 .F ORD=1:1:CNT W !!,"Creating your order request # "_ORD_" of "_CNT_" for "_PSDRN D DIE S ORD(ORD)=PSDA
"RTN","PSDORP",59,0)
 G:'PSDOUT DRUG
"RTN","PSDORP",60,0)
END K %,%DT,%H,%I,CNT,CNT1,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,LN,MSG,MSG1
"RTN","PSDORP",61,0)
 K NAOU,NAOUN,NBKU,NPKG,OK,OKTYP,ORD,PSDA,PSDOUT,PSDQTY,PSDRD,PSDR,PSDRN,PSDS,PSDT,PSDUZ,PSDUZA,PSDUZN,REQD,TEXT,TYPE,WORD,X,Y
"RTN","PSDORP",62,0)
 Q
"RTN","PSDORP",63,0)
DIE ;create the order request
"RTN","PSDORP",64,0)
 S:'$D(^PSD(58.8,NAOU,1,PSDR,3,0)) ^(0)="^58.800118A^^"
"RTN","PSDORP",65,0)
 S PSDA=$P(^PSD(58.8,NAOU,1,PSDR,3,0),"^",3)+1 I $D(^PSD(58.8,NAOU,1,PSDR,3,PSDA)) S $P(^PSD(58.8,NAOU,1,PSDR,3,0),"^",3)=$P(^PSD(58.8,NAOU,1,PSDR,3,0),"^",3)+1 G DIE
"RTN","PSDORP",66,0)
 K DA,DIC,DIE,DD,DR,DO S DIC(0)="L",(DIC,DIE)="^PSD(58.8,"_NAOU_",1,"_PSDR_",3,",DA(2)=NAOU,DA(1)=PSDR,(X,DINUM)=PSDA D FILE^DICN K DIC
"RTN","PSDORP",67,0)
 D NOW^%DTC S PSDT=+$E(%,1,12) W ?10,!!,"processing now..."
"RTN","PSDORP",68,0)
 S DA=PSDA,DA(1)=PSDR,DA(2)=NAOU,DR="1////"_PSDT_";2////"_PSDS_";10////1;5////"_PSDQTY_";13;3//^S X=PSDUZN" D ^DIE K DIE,DR
"RTN","PSDORP",69,0)
 S PSDUZA=+$P($G(^PSD(58.8,NAOU,1,PSDR,3,PSDA,0)),"^",4)
"RTN","PSDORP",70,0)
 Q
"RTN","PSDORP",71,0)
MSG ;display error message
"RTN","PSDORP",72,0)
 W $C(7),!!,?10,"Contact your Pharmacy Coordinator.",!,?10,"This "_$S(MSG=2:"Dispensing Site",MSG=1:"NAOU",1:"PSDR")_" is missing "
"RTN","PSDORP",73,0)
 W $S(MSG1=1:"Primary Disp. Site",MSG1=2:"stocked drugs",MSG1=3:"narcotic breakdown unit",MSG1=4:"narcotic package size",1:"data")_".",!
"RTN","PSDORP",74,0)
 Q
"RTN","PSDPAT1")
0^1^B63600329^B52759406
"RTN","PSDPAT1",1,0)
PSDPAT1 ;B'ham ISC/JPW,BJW - Prt activity report (Patient/Drug) ; 17 Apr 98
"RTN","PSDPAT1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**7,62**;13 Feb 97;Build 3
"RTN","PSDPAT1",3,0)
 ;modified for nois:det-0198-42285;displays drugs for destruction,returns,waste,transfers
"RTN","PSDPAT1",4,0)
START ;entry for compile and print
"RTN","PSDPAT1",5,0)
 K ^TMP("PSDPAT",$J) S (AQTY,CNT)=0
"RTN","PSDPAT1",6,0)
 I $D(ALL) F PSDR=0:0 S PSDR=$O(^PSD(58.8,+NAOU,1,PSDR)) Q:'PSDR  I $D(^PSD(58.8,+NAOU,1,+PSDR,0)) S PSDRG(+PSDR)=+$P(^(0),"^",4)
"RTN","PSDPAT1",7,0)
 F PSDR=0:0 S PSDR=$O(PSDRG(PSDR)) Q:'PSDR  F PSD=PSDSD:0 S PSD=$O(^PSD(58.81,"ACT",PSD)) Q:'PSD!(PSD>PSDED)   D
"RTN","PSDPAT1",8,0)
 .F TYP=0:0 S TYP=$O(^PSD(58.81,"ACT",PSD,+NAOU,PSDR,TYP)) Q:'TYP  F PSDA=0:0 S PSDA=$O(^PSD(58.81,"ACT",PSD,+NAOU,PSDR,TYP,PSDA)) Q:'PSDA  D SET
"RTN","PSDPAT1",9,0)
 ;; *62 RJS>
"RTN","PSDPAT1",10,0)
 F PSDR=0:0 S PSDR=$O(PSDRG(PSDR)) Q:'PSDR  F PSDA=0:0 S PSDA=$O(^PSD(58.8,+NAOU,1,PSDR,3,PSDA)) Q:'PSDA  D
"RTN","PSDPAT1",11,0)
 .Q:'$D(^PSD(58.8,NAOU,1,PSDR,3,PSDA,0))  S NODE=^(0),PSD=$P(NODE,"^",15)
"RTN","PSDPAT1",12,0)
 .I (PSD>PSDSD),(PSD<PSDED) D
"RTN","PSDPAT1",13,0)
 ..S NUR1=+$P(NODE,"^",7),NUR2="",QTY=+$P(NODE,"^",20),PAT="PHARMACY DISP #"_$P(NODE,U,16),PSDRN=$S($P($G(^PSDRUG(+PSDR,0)),"^")]"":$P(^(0),"^"),1:"ZZ/"_PSDR_" NAME MISSING") S PSDTR=+$P($G(NODE),"^",17)
"RTN","PSDPAT1",14,0)
 ..I (TYP=18)!(TYP=17) S $P(PSDRG(+PSDR),"^",2)=+$P(PSDRG(+PSDR),"^",2)+QTY
"RTN","PSDPAT1",15,0)
 ..S NUR1=$S($P($G(^VA(200,NUR1,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDPAT1",16,0)
 ..S (WQTY,WREAS,RQTY,RREAS,DRUGNO,SOQTY,DQTY,DREAS,PSDRET,DDATE)=""
"RTN","PSDPAT1",17,0)
 ..S NODE9="",$P(NODE,U,16)="",TYP=0
"RTN","PSDPAT1",18,0)
 ..S $P(NODE,U,10)=$P(NODE,U,22) D SET1
"RTN","PSDPAT1",19,0)
 ;; *62 RJS>
"RTN","PSDPAT1",20,0)
 F PSD=PSDSD:0 S PSD=$O(^PSD(58.81,"ATRN",PSD)) Q:'PSD!(PSD>PSDED)  D
"RTN","PSDPAT1",21,0)
 .F PSDA=0:0 S PSDA=$O(^PSD(58.81,"ATRN",PSD,PSDA)) Q:'PSDA  D
"RTN","PSDPAT1",22,0)
 ..S NODE=^PSD(58.81,PSDA,0) Q:$P(NODE,U,18)'=NAOU!('$D(PSDRG($P(NODE,U,5))))  D SET2
"RTN","PSDPAT1",23,0)
 ;; <*62 RJS
"RTN","PSDPAT1",24,0)
 F  S PSDR=$O(PSDRG(PSDR)) Q:'PSDR  I $G(PSDRG(PSDR))  S PSDRN=$S($P($G(^PSDRUG(+PSDR,0)),U)]"":$P(^(0),U),1:"ZZ/"_PSDR_" NAME MISSING") D:'$D(^TMP("PSDPAT",$J,PSDRN))
"RTN","PSDPAT1",25,0)
 .S ^TMP("PSDPAT",$J,PSDRN,DT,"NO ACTIVITY",1)=0
"RTN","PSDPAT1",26,0)
 .S ^TMP("PSDPATL",$J,PSDRN)=U_PSDRG(PSDR)
"RTN","PSDPAT1",27,0)
PRINT ;prints data
"RTN","PSDPAT1",28,0)
 I SUM="S" D ^PSDPAT2 G DONE
"RTN","PSDPAT1",29,0)
 S (PG,PSDOUT,AQTY)=0,PSDRN="",$P(LN,"-",132)="" D NOW^%DTC S Y=+$E(%,1,12) X ^DD("DD") S RPDT=Y
"RTN","PSDPAT1",30,0)
 I '$D(^TMP("PSDPAT",$J)) D HDR W !!,?15,"**** NO DISPENSING ACTIVITY ****",!! G DONE
"RTN","PSDPAT1",31,0)
 D HDR S PSDRG="" F  S PSDRG=$O(^TMP("PSDPAT",$J,PSDRG)) Q:PSDRG=""!(PSDOUT)  W !,?5,"=> ",PSDRG,! D CHK F PSD=0:0 S PSD=$O(^TMP("PSDPAT",$J,PSDRG,PSD)) D:'PSD TOT Q:PSD=""!(PSDOUT)  D  Q:PSDOUT
"RTN","PSDPAT1",32,0)
 .S PAT="" F  S PAT=$O(^TMP("PSDPAT",$J,PSDRG,PSD,PAT)) Q:PAT=""!(PSDOUT)  F PSD1=0:0 S PSD1=$O(^TMP("PSDPAT",$J,PSDRG,PSD,PAT,PSD1)) Q:'PSD1!(PSDOUT)  D  Q:PSDOUT
"RTN","PSDPAT1",33,0)
 ..S (QTY,SOQTY,RQTY,WQTY,DQTY,NEWBAL,ORDST)=0,(RREAS,WREAS,DREAS)=""
"RTN","PSDPAT1",34,0)
 ..S NODE=^TMP("PSDPAT",$J,PSDRG,PSD,PAT,PSD1),PSDRGN=PSDRG
"RTN","PSDPAT1",35,0)
 ..Q:$P(NODE,U,4)=3
"RTN","PSDPAT1",36,0)
 ..W !
"RTN","PSDPAT1",37,0)
 ..I $Y+8>IOSL D HDR Q:PSDOUT  W !,?5,"=> ",PSDRG,!
"RTN","PSDPAT1",38,0)
 ..S Y=+$E(PSD,1,12) X ^DD("DD") S DATE=Y
"RTN","PSDPAT1",39,0)
 ..S TYP=+$P(NODE,"^",4),PSDR=$P(NODE,"^",11),ORDST=+$P(NODE,"^",24)
"RTN","PSDPAT1",40,0)
 ..S QTY=+$P(NODE,"^")
"RTN","PSDPAT1",41,0)
 ..I (TYP)=9 S PQTY=+$P(NODE,U,7)+QTY,NEWBAL=PQTY W DATE,?22,PAT,?55,$J(QTY,6),?75,$J(PQTY,6),?98,$P(NODE,U,2),!,?98,$P(NODE,U,3),!,?25,$P(NODE,U,6),!
"RTN","PSDPAT1",42,0)
 ..I TYP=11 S PQTY=+$P(NODE,U,7)+QTY,NEWBAL=PQTY W DATE,?22,PAT,?55,$J(QTY,6),?75,$J(PQTY,6),?98,$P(NODE,U,2),!,?98,$P(NODE,U,3),!
"RTN","PSDPAT1",43,0)
 ..I TYP=17 S SOQTY=+$P(NODE,"^",12),NEWBAL=+$P(NODE,"^",7)-SOQTY D
"RTN","PSDPAT1",44,0)
 ...W DATE,?22,PAT,?54 W:TYP=17 "-" W $J(SOQTY,6)
"RTN","PSDPAT1",45,0)
 ...W ?75,$J(NEWBAL,6),?98,$P(NODE,"^",2),!,?98,$P(NODE,"^",3),!
"RTN","PSDPAT1",46,0)
 ..I (TYP=17),(+$P(NODE,"^",9)) S RQTY=+$P(NODE,"^",9) D
"RTN","PSDPAT1",47,0)
 ...S RREAS=$P(NODE,"^",10),NEWBAL=+NEWBAL+RQTY,PSDRET=$P(NODE,"^",15),Y=PSDRET X ^DD("DD") S PSDRET=$E(Y,1,17)
"RTN","PSDPAT1",48,0)
 ...S:$G(PSDRET)=0 PSDRET="" W PSDRET,?22,PAT,?45,"*RETURN*",?55,$J(RQTY,6),?75,$J(NEWBAL,6),?98,$P(NODE,"^",2),!,?25,RREAS,?98,$P(NODE,"^",3),!
"RTN","PSDPAT1",49,0)
 ..I +$P(NODE,U,5) S WQTY=+$P(NODE,U,5),WREAS=$P(NODE,"^",6),QTY=QTY-WQTY D
"RTN","PSDPAT1",50,0)
 ...W DATE,?22,PAT,?45,"*WASTED*",?55,$J(WQTY,6)
"RTN","PSDPAT1",51,0)
 ...W ?98,$P(NODE,"^",2),!,?25,WREAS,?98,$P(NODE,"^",3),!
"RTN","PSDPAT1",52,0)
 ..I +$P(NODE,U,13) S DQTY=+$P(NODE,U,13),DREAS=$P(NODE,U,14),DDATE=+$P(NODE,U,16) D
"RTN","PSDPAT1",53,0)
 ...W DATE,?22,PAT,?45,"*DESTROY*",?55,$J(DQTY,6),?98,$P(NODE,"^",2),!,?25,DREAS,?98,$P(NODE,"^",3),!
"RTN","PSDPAT1",54,0)
 ..W:TYP=17 DATE,?22,PAT,?45,"*GIVEN*",?55,$J(QTY,6),!
"RTN","PSDPAT1",55,0)
 ..I TYP=23 S PQTY=+$P(NODE,U,7)+QTY,NEWBAL=PQTY W DATE,?22,PAT,?55,$J(QTY,6),?75,$J(PQTY,6),?98,$P(NODE,U,2),!,?98,$P(NODE,U,3),!
"RTN","PSDPAT1",56,0)
 ..I TYP=0,'$G(ORDST) S PQTY=+$P(NODE,U,7)+QTY,NEWBAL=PQTY W DATE,?22,PAT,?55,$J(QTY,6),?75,$J(PQTY,6),?98,$P(NODE,U,2),!,?98,$P(NODE,U,3),!
"RTN","PSDPAT1",57,0)
 ..I TYP=0,$G(ORDST)=10 D  ; *62 RJS .
"RTN","PSDPAT1",58,0)
 ...S PQTY=+$P(NODE,"^")+$P(NODE,"^",7)+$P(NODE,"^",23),NEWBAL=PQTY
"RTN","PSDPAT1",59,0)
 ...W:$P(NODE,"^")'="" DATE,?22,PAT,?55,$J(QTY,6),?75,$J(PQTY,6),?98,$P(NODE,U,2),!,?98,$P(NODE,U,3),!  ; < *62 RJS
"RTN","PSDPAT1",60,0)
 ... S TFDTE=$P(NODE,"^",17),Y=TFDTE X ^DD("DD") S TFDTE=$E(Y,1,17),TFNUR=$P(NODE,"^",18),T2NAOU=$P(NODE,"^",19),TTDTE=$P(NODE,"^",20)
"RTN","PSDPAT1",61,0)
 ...S TTNUR=$P(NODE,"^",21),TRQTY=+$P(NODE,"^",23),NEWBAL=+NEWBAL-TRQTY
"RTN","PSDPAT1",62,0)
 ...W TFDTE,?22,PAT,?45,"*TRFER*",?54 W:TYP=0 "-" W $J(TRQTY,6),?75,$J(NEWBAL,6)
"RTN","PSDPAT1",63,0)
 ...W ?98,$P(NODE,"^",18),!,?32,"*TRANSFER TO "_$P(NODE,"^",19),"*",?98,$P(NODE,"^",21)
"RTN","PSDPAT1",64,0)
 ;..W:$P(NODE,U,8) " recorded by ",$P($G(^VA(200,$P(NODE,U,8),0)),U)
"RTN","PSDPAT1",65,0)
DONE I $E(IOST)'="C" W @IOF
"RTN","PSDPAT1",66,0)
 I $E(IOST,1,2)="C-",'PSDOUT W ! K DIR,DIRUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu" D ^DIR K DIR
"RTN","PSDPAT1",67,0)
END ;
"RTN","PSDPAT1",68,0)
 D KVAR^VADPT K VA
"RTN","PSDPAT1",69,0)
 K %,%DT,%H,%I,%ZIS,ALL,AQTY,BAL,CNT,DA,DATE,DDATE,DFN,DIC,DIR,DIROUT,DIRUT,DQTY,DTOUT,DREAS,DRUGNO,DUOUT,LN,LOOP,NAOU,NAOUN,NEWBAL,NODE,NODE3,NODE7,NODE9,NUR1,NUR2,ORDST
"RTN","PSDPAT1",70,0)
 K PAT,PG,POP,PSD,PSD1,PSDA,PSDATE,PSDED,PSDOUT,PSDPN,PQTY,PSDR,PSDRET,PSDRG,PSDRGN,PSDRN,PSDSD,RQTY,RREAS,RPDT,SOQTY
"RTN","PSDPAT1",71,0)
 K T2NAOU,TFDTE,TFNUR,TPRVTR,TRQTY,TTDTE,TTNUR,TTONAOU,TQTY,TYP,QTY,SUM,UQTY,VADM,VAERR,WQTY,WREAS,X,Y
"RTN","PSDPAT1",72,0)
 K ^TMP("PSDPAT",$J),^TMP("PSDPATL",$J),ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDPAT1",73,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDPAT1",74,0)
 Q
"RTN","PSDPAT1",75,0)
SET ;sets data
"RTN","PSDPAT1",76,0)
 ;Q:TYP=11
"RTN","PSDPAT1",77,0)
 Q:'$D(^PSD(58.81,PSDA,0))  S NODE=^(0),QTY=+$P(NODE,"^",6)
"RTN","PSDPAT1",78,0)
 S NODE9=$G(^PSD(58.81,PSDA,9)) S SOQTY=+$P(NODE9,"^",3),WQTY=+$P(NODE9,"^",4)
"RTN","PSDPAT1",79,0)
 I +$P(NODE,"^",5) S DRUGNO=+$P(NODE,"^",5)
"RTN","PSDPAT1",80,0)
 I TYP=17 S $P(PSDRG(+PSDR),"^",2)=+$P(PSDRG(+PSDR),"^",2)+SOQTY
"RTN","PSDPAT1",81,0)
 S NODE3=$G(^PSD(58.81,PSDA,3)) S PSDRET=+$P(NODE3,"^"),RQTY=+$P(NODE3,"^",2),RREAS=$P(NODE3,"^",3),DQTY=+$P(NODE3,"^",5),DREAS=$P(NODE3,"^",6),DDATE=+$P(NODE3,"^",4)
"RTN","PSDPAT1",82,0)
 S DFN=+$P($G(NODE9),"^") D DEM^VADPT S PAT=$S(TYP=18:"WASTED AMOUNT",TYP=11:"INITIALIZE BALANCE",TYP=9:"BALANCE ADJUSTMENT",TYP=23:"COUNT VERIFICATION",'VAERR:VADM(1),1:"UNKNOWN")
"RTN","PSDPAT1",83,0)
 S NUR1=$S($P(NODE9,U,2):$P(NODE9,U,2),1:$P(NODE,U,7))
"RTN","PSDPAT1",84,0)
 S:NUR1'=$P(NODE,U,7) NUR1(1)=$P(NODE,U,7)
"RTN","PSDPAT1",85,0)
 ;S NUR1=$S(TYP=11:+$P(NODE,"^",7),1:+$P($G(NODE9),"^",2)) S:TYP=9 NUR1=$S(+$P(NODE,"^",7):+$P(NODE,"^",7),1:+$P($G(NODE9),"^",2))
"RTN","PSDPAT1",86,0)
 S NUR1=$S($P($G(^VA(200,+NUR1,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDPAT1",87,0)
 S NUR2=$P($G(NODE9),"^",6) S:NUR2 NUR2=$S($P($G(^VA(200,+NUR2,0)),"^")]"":$P(^(0),"^"),1:"")
"RTN","PSDPAT1",88,0)
 S PSDRN=$S($P($G(^PSDRUG(+PSDR,0)),"^")]"":$P(^(0),"^"),1:"ZZ/"_PSDR_" NAME MISSING")
"RTN","PSDPAT1",89,0)
 ;I +$P(NODE9,"^",4) S QTY=+$P(NODE9,"^",4)
"RTN","PSDPAT1",90,0)
 ;I +$P(NODE9,"^",7) S QTY=+$P(NODE9,"^",7)-$P(NODE9,"^",3)
"RTN","PSDPAT1",91,0)
 ;I +$P(NODE9,"^",5) S QTY=+$P(NODE9,"^",5)
"RTN","PSDPAT1",92,0)
 ;12/9/97 added next line;added to tmp-file
"RTN","PSDPAT1",93,0)
SET1 ;sets ^tmp
"RTN","PSDPAT1",94,0)
 I TYP=0 D CHKNOD7
"RTN","PSDPAT1",95,0)
 S CNT=CNT+1,^TMP("PSDPAT",$J,PSDRN,PSD,PAT,CNT)=QTY_"^"_NUR1_"^"_NUR2_"^"_TYP_"^"_WQTY_"^"_$P(NODE,U,16)_U_$P(NODE,U,10)_"^"_$G(NUR1(1))_"^"_RQTY_"^"_RREAS_"^"_DRUGNO_"^"_SOQTY_"^"_DQTY_"^"_DREAS_"^"_PSDRET_"^"_DDATE
"RTN","PSDPAT1",96,0)
 I $G(TRQTY) S ^TMP("PSDPAT",$J,PSDRN,PSD,PAT,CNT)=^TMP("PSDPAT",$J,PSDRN,PSD,PAT,CNT)_"^"_TFDTE_"^"_TFNUR_"^"_T2NAOU_"^"_TTDTE_"^"_TTNUR_"^"_TPRVTR_"^"_TRQTY_"^"_ORDST
"RTN","PSDPAT1",97,0)
 S:'$D(^TMP("PSDPATL",$J,PSDRN)) ^TMP("PSDPATL",$J,PSDRN)=0
"RTN","PSDPAT1",98,0)
 S ^TMP("PSDPATL",$J,PSDRN)=+^TMP("PSDPATL",$J,PSDRN)+($S(TYP=18:-QTY,TYP=17:-SOQTY,1:QTY)),$P(^(PSDRN),"^",2)=+PSDRG(PSDR)
"RTN","PSDPAT1",99,0)
 S $P(^TMP("PSDPATL",$J,PSDRN),"^",3)=+$P(^TMP("PSDPATL",$J,PSDRN),"^",3)+$P(PSDRG(+PSDR),"^",2)
"RTN","PSDPAT1",100,0)
 K QTY,NUR1,NUR2,NODE,NODE3,NODE7,PSDTR Q
"RTN","PSDPAT1",101,0)
SET2 ;SETS TRANSFER DATA ONLY  ;; *62 RJS >
"RTN","PSDPAT1",102,0)
 N PSDTRDT,PAT
"RTN","PSDPAT1",103,0)
 S PSDR=$P(NODE,U,5),PSDRN=$S($P($G(^PSDRUG(+PSDR,0)),"^")]"":$P(^(0),"^"),1:"ZZ/"_PSDR_" NAME MISSING")
"RTN","PSDPAT1",104,0)
 S PSDTRDT=$P(^PSD(58.81,PSDA,1),U,4)
"RTN","PSDPAT1",105,0)
 Q:$D(^TMP("PSDPAT",$J,PSDRN,PSDTRDT))
"RTN","PSDPAT1",106,0)
 S PSDTR=PSDA D CHKNOD7
"RTN","PSDPAT1",107,0)
 I $G(TRQTY) S CNT=CNT+1,PAT="PHARMACY DISP #"_$P(NODE,U,17),^TMP("PSDPAT",$J,PSDRN,PSD,PAT,CNT)="^^^0^^^^^^^^^^^^^"_TFDTE_"^"_TFNUR_"^"_T2NAOU_"^"_TTDTE_"^"_TTNUR_"^"_TPRVTR_"^"_TRQTY_"^"_ORDST
"RTN","PSDPAT1",108,0)
 S:'$D(^TMP("PSDPATL",$J,PSDRN)) ^TMP("PSDPATL",$J,PSDRN)=0
"RTN","PSDPAT1",109,0)
 S $P(^TMP("PSDPATL",$J,PSDRN),"^",3)=+$P(^TMP("PSDPATL",$J,PSDRN),"^",3)+$P(PSDRG(+PSDR),"^",2)
"RTN","PSDPAT1",110,0)
 K QTY,NUR1,NUR2,NODE,NODE3,NODE7,PSDTR
"RTN","PSDPAT1",111,0)
 Q  ; < *62 RJS
"RTN","PSDPAT1",112,0)
CHKNOD7 ;
"RTN","PSDPAT1",113,0)
 S NODE7=$G(^PSD(58.81,+PSDTR,7))
"RTN","PSDPAT1",114,0)
 S ORDST=$P($G(^PSD(58.81,+PSDTR,0)),"^",11)
"RTN","PSDPAT1",115,0)
 S TFDTE=+$P(NODE7,"^"),TTONAOU=+$P(NODE7,U,3),T2NAOU=$P($G(^PSD(58.8,TTONAOU,0)),U),TTDTE=+$P(NODE7,U,4),TPRVTR=+$P(NODE7,U,6),TRQTY=+$P(NODE7,U,7)
"RTN","PSDPAT1",116,0)
 S TFNUR=$S($P(NODE7,U,2):$P(NODE7,U,2),1:$P(NODE,U,7))
"RTN","PSDPAT1",117,0)
 S:TFNUR'=$P(NODE,U,7) TFNUR(1)=$P(NODE,U,7) S TFNUR=$S($P($G(^VA(200,+TFNUR,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDPAT1",118,0)
 S TTNUR=$P($G(NODE7),"^",5) S:TTNUR TTNUR=$S($P($G(^VA(200,+TTNUR,0)),"^")]"":$P(^(0),"^"),1:"")
"RTN","PSDPAT1",119,0)
 Q
"RTN","PSDPAT1",120,0)
HDR ;header
"RTN","PSDPAT1",121,0)
 I $E(IOST,1,2)="C-",PG K DA,DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSDOUT=1 Q
"RTN","PSDPAT1",122,0)
 S PG=PG+1 W:$Y @IOF W !,?20,"Activity Report for ",NAOUN,?55,RPDT,?115,"Page: ",PG,!,?20,"Date: ",$P(PSDATE,"^")," to ",$P(PSDATE,"^",2),!!
"RTN","PSDPAT1",123,0)
 W ?5,"=>  DRUG",!,"DATE/TIME",?22,"PATIENT",?55,"QUANTITY",?75,"BALANCE",?98,"NURSE 1",!,?98,"NURSE2",!,LN,!!
"RTN","PSDPAT1",124,0)
 Q
"RTN","PSDPAT1",125,0)
CHK ;sets total qty used and balance
"RTN","PSDPAT1",126,0)
 S TQTY=+$G(^TMP("PSDPATL",$J,PSDRG)),BAL=+$P($G(^TMP("PSDPATL",$J,PSDRG)),"^",2),UQTY=BAL-TQTY
"RTN","PSDPAT1",127,0)
 Q
"RTN","PSDPAT1",128,0)
TOT ;prints total qty used and balance
"RTN","PSDPAT1",129,0)
 I $Y+4>IOSL D HDR Q:PSDOUT  W !,?5,"=> ",$S(PSDRG]"":PSDRG,1:PSDRGN),!
"RTN","PSDPAT1",130,0)
 ;W !,?55,"----------",?75,"----------",!,?5,"Total Quantity Used and Balance",?55,$J(AQTY,6),?70,$J(PQTY,6),!
"RTN","PSDPAT1",131,0)
 W ! S AQTY=0
"RTN","PSDPAT1",132,0)
 Q
"VER")
8.0^22.0
"BLD",6824,6)
^54
**END**
**END**
