Released PSO*7*181 SEQ #166
Extracted from mail message
**KIDS**:PSO*7.0*181^

**INSTALL NAME**
PSO*7.0*181
"BLD",1045,0)
PSO*7.0*181^OUTPATIENT PHARMACY^0^3041115^y
"BLD",1045,1,0)
^^6^6^3040629^
"BLD",1045,1,1,0)
This patch supports the VistA Data Extraction Framework (VDEF)
"BLD",1045,1,2,0)
effort, allowing changes to the PRESCRIPTION file (#52) to be transmitted
"BLD",1045,1,3,0)
to the Health Data Repository (HDR). The activation of the transmission 
"BLD",1045,1,4,0)
will be handled with the sites on an individual basis. Until that 
"BLD",1045,1,5,0)
activation occurs, the changes included in this patch will not affect 
"BLD",1045,1,6,0)
any Pharmacy functionality.
"BLD",1045,4,0)
^9.64PA^^
"BLD",1045,"ABPKG")
n
"BLD",1045,"KRN",0)
^9.67PA^8989.52^19
"BLD",1045,"KRN",.4,0)
.4
"BLD",1045,"KRN",.401,0)
.401
"BLD",1045,"KRN",.402,0)
.402
"BLD",1045,"KRN",.403,0)
.403
"BLD",1045,"KRN",.5,0)
.5
"BLD",1045,"KRN",.84,0)
.84
"BLD",1045,"KRN",3.6,0)
3.6
"BLD",1045,"KRN",3.8,0)
3.8
"BLD",1045,"KRN",9.2,0)
9.2
"BLD",1045,"KRN",9.8,0)
9.8
"BLD",1045,"KRN",9.8,"NM",0)
^9.68A^6^5
"BLD",1045,"KRN",9.8,"NM",1,0)
PSOHDR^^0^B5786515
"BLD",1045,"KRN",9.8,"NM",2,0)
PSOHLSN1^^0^B84591647
"BLD",1045,"KRN",9.8,"NM",4,0)
PSOR52^^0^B25637956
"BLD",1045,"KRN",9.8,"NM",5,0)
PSORXPA1^^0^B24712239
"BLD",1045,"KRN",9.8,"NM",6,0)
PSOHLNE1^^0^B61200482
"BLD",1045,"KRN",9.8,"NM","B","PSOHDR",1)

"BLD",1045,"KRN",9.8,"NM","B","PSOHLNE1",6)

"BLD",1045,"KRN",9.8,"NM","B","PSOHLSN1",2)

"BLD",1045,"KRN",9.8,"NM","B","PSOR52",4)

"BLD",1045,"KRN",9.8,"NM","B","PSORXPA1",5)

"BLD",1045,"KRN",19,0)
19
"BLD",1045,"KRN",19.1,0)
19.1
"BLD",1045,"KRN",101,0)
101
"BLD",1045,"KRN",409.61,0)
409.61
"BLD",1045,"KRN",771,0)
771
"BLD",1045,"KRN",870,0)
870
"BLD",1045,"KRN",8989.51,0)
8989.51
"BLD",1045,"KRN",8989.52,0)
8989.52
"BLD",1045,"KRN",8994,0)
8994
"BLD",1045,"KRN","B",.4,.4)

"BLD",1045,"KRN","B",.401,.401)

"BLD",1045,"KRN","B",.402,.402)

"BLD",1045,"KRN","B",.403,.403)

"BLD",1045,"KRN","B",.5,.5)

"BLD",1045,"KRN","B",.84,.84)

"BLD",1045,"KRN","B",3.6,3.6)

"BLD",1045,"KRN","B",3.8,3.8)

"BLD",1045,"KRN","B",9.2,9.2)

"BLD",1045,"KRN","B",9.8,9.8)

"BLD",1045,"KRN","B",19,19)

"BLD",1045,"KRN","B",19.1,19.1)

"BLD",1045,"KRN","B",101,101)

"BLD",1045,"KRN","B",409.61,409.61)

"BLD",1045,"KRN","B",771,771)

"BLD",1045,"KRN","B",870,870)

"BLD",1045,"KRN","B",8989.51,8989.51)

"BLD",1045,"KRN","B",8989.52,8989.52)

"BLD",1045,"KRN","B",8994,8994)

"BLD",1045,"QUES",0)
^9.62^^
"BLD",1045,"REQB",0)
^9.611^2^2
"BLD",1045,"REQB",1,0)
PSO*7.0*157^2
"BLD",1045,"REQB",2,0)
PSO*7.0*152^2
"BLD",1045,"REQB","B","PSO*7.0*152",2)

"BLD",1045,"REQB","B","PSO*7.0*157",1)

"MBREQ")
0
"PKG",16,-1)
1^1
"PKG",16,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",16,20,0)
^9.402P^^
"PKG",16,22,0)
^9.49I^1^1
"PKG",16,22,1,0)
7.0^3011218^2980805^5
"PKG",16,22,1,"PAH",1,0)
181^3041115
"PKG",16,22,1,"PAH",1,1,0)
^^6^6^3041115
"PKG",16,22,1,"PAH",1,1,1,0)
This patch supports the VistA Data Extraction Framework (VDEF)
"PKG",16,22,1,"PAH",1,1,2,0)
effort, allowing changes to the PRESCRIPTION file (#52) to be transmitted
"PKG",16,22,1,"PAH",1,1,3,0)
to the Health Data Repository (HDR). The activation of the transmission 
"PKG",16,22,1,"PAH",1,1,4,0)
will be handled with the sites on an individual basis. Until that 
"PKG",16,22,1,"PAH",1,1,5,0)
activation occurs, the changes included in this patch will not affect 
"PKG",16,22,1,"PAH",1,1,6,0)
any Pharmacy functionality.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSOHDR")
0^1^B5786515
"RTN","PSOHDR",1,0)
PSOHDR ;BIR/RTR-Send order update message to HDR ;06/27/03
"RTN","PSOHDR",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**181**;DEC 1997
"RTN","PSOHDR",3,0)
 ;External reference to PSDRUG supported by DBIA 221
"RTN","PSOHDR",4,0)
 ;
"RTN","PSOHDR",5,0)
 ;PSOHDRTP = Type of message, PRES=fill, PPAR=partial, PREF=refill
"RTN","PSOHDR",6,0)
 ;PSOHDRNM = Internal entry number of order
"RTN","PSOHDR",7,0)
 ;
"RTN","PSOHDR",8,0)
EN(PSOHDRTP,PSOHDRNM) ; Entry point for VDEF calls
"RTN","PSOHDR",9,0)
 Q:'$G(PSOHDRNM)
"RTN","PSOHDR",10,0)
 Q:$G(PSOHDRTP)=""
"RTN","PSOHDR",11,0)
 I $T(QUEUE^VDEFQM)']"" Q
"RTN","PSOHDR",12,0)
 N PSOHDRX,PSOHDRA,PSOHDRB
"RTN","PSOHDR",13,0)
 S PSOHDRA=$S(PSOHDRTP="PRES":"RDE^O11",PSOHDRTP="PPAR":"RDS^O13",PSOHDRTP="PREF":"RDS^O13",1:"")
"RTN","PSOHDR",14,0)
 Q:PSOHDRA=""
"RTN","PSOHDR",15,0)
 S PSOHDRB="SUBTYPE="_PSOHDRTP_"^IEN="_PSOHDRNM
"RTN","PSOHDR",16,0)
 S PSOHDRX=$$QUEUE^VDEFQM(PSOHDRA,PSOHDRB)
"RTN","PSOHDR",17,0)
 Q
"RTN","PSOHDR",18,0)
 ;
"RTN","PSOHDR",19,0)
 ;Return NDC number
"RTN","PSOHDR",20,0)
NDC(PSOVIEN,PSOVFILL,PSOVTYPE) ;
"RTN","PSOHDR",21,0)
 ;PSOVIEN = Internal prescription number
"RTN","PSOHDR",22,0)
 ;PSOVFILL = Fill Number
"RTN","PSOHDR",23,0)
 ;PSOVTYPE = "R" for refill, "P" for Partial
"RTN","PSOHDR",24,0)
 N PSOVNDC,PSOVNX,PSOVY,PSOVDRG
"RTN","PSOHDR",25,0)
 S (PSOVNDC,PSOVNX)=""
"RTN","PSOHDR",26,0)
 I $G(PSOVIEN)'>0 Q PSOVNDC
"RTN","PSOHDR",27,0)
 I '$D(^PSRX(PSOVIEN,0)) Q PSOVNDC
"RTN","PSOHDR",28,0)
 I $G(PSOVFILL)="" Q PSOVNDC
"RTN","PSOHDR",29,0)
 I PSOVFILL=0 D  D:PSOVNX'="" FORMAT Q PSOVNDC
"RTN","PSOHDR",30,0)
 .D CMOP I PSOVNX'="" Q
"RTN","PSOHDR",31,0)
 .;I $P($G(^PSRX(PSOVIEN,"NDC")),"^")'="" S PSOVNX=$P(^("NDC"),"^") Q
"RTN","PSOHDR",32,0)
 .I $P($G(^PSRX(PSOVIEN,2)),"^",7)'="" S PSOVNX=$P(^(2),"^",7) Q
"RTN","PSOHDR",33,0)
 .D DRUG
"RTN","PSOHDR",34,0)
 I $G(PSOVFILL)'>0 Q PSOVNDC
"RTN","PSOHDR",35,0)
 I $G(PSOVTYPE)'="R",$G(PSOVTYPE)'="P" Q PSOVNDC
"RTN","PSOHDR",36,0)
 I PSOVTYPE="R" D  D:PSOVNX'="" FORMAT Q PSOVNDC
"RTN","PSOHDR",37,0)
 .D CMOP I PSOVNX'="" Q
"RTN","PSOHDR",38,0)
 .;I $P($G(^PSRX(PSOVIEN,1,PSOVFILL,"NDC")),"^")'="" S PSOVNX=$P(^("NDC"),"^") Q
"RTN","PSOHDR",39,0)
 .I $P($G(^PSRX(PSOVIEN,1,PSOVFILL,1)),"^",3)'="" S PSOVNX=$P(^(1),"^",3) Q
"RTN","PSOHDR",40,0)
 .D DRUG
"RTN","PSOHDR",41,0)
 I PSOVTYPE="P" D  D:PSOVNX'="" FORMAT Q PSOVNDC
"RTN","PSOHDR",42,0)
 .I $P($G(^PSRX(PSOVIEN,"P",PSOVFILL,0)),"^",12)'="" S PSOVNX=$P(^(0),"^",12) Q
"RTN","PSOHDR",43,0)
 .D DRUG
"RTN","PSOHDR",44,0)
 Q PSOVNDC
"RTN","PSOHDR",45,0)
 ;
"RTN","PSOHDR",46,0)
FORMAT ;format NDC
"RTN","PSOHDR",47,0)
 S PSOVNDC=$G(PSOVNX)
"RTN","PSOHDR",48,0)
 Q
"RTN","PSOHDR",49,0)
CMOP ;Find NDC for CMOP fill
"RTN","PSOHDR",50,0)
 F PSOVY=0:0 S PSOVY=$O(^PSRX(PSOVIEN,4,PSOVY)) Q:'PSOVY  D
"RTN","PSOHDR",51,0)
 .I $P($G(^PSRX(PSOVIEN,4,PSOVY,0)),"^",3)=PSOVFILL,$P($G(^(0)),"^",8)'="" S PSOVNX=$P($G(^(0)),"^",8)
"RTN","PSOHDR",52,0)
 Q
"RTN","PSOHDR",53,0)
DRUG ;Get NDC from Drug file
"RTN","PSOHDR",54,0)
 S PSOVDRG=$P($G(^PSRX(PSOVIEN,0)),"^",6) I PSOVDRG,$P($G(^PSDRUG(+$G(PSOVDRG),2)),"^",4)'="" S PSOVNX=$P(^(2),"^",4)
"RTN","PSOHDR",55,0)
 Q
"RTN","PSOHLNE1")
0^6^B61200482
"RTN","PSOHLNE1",1,0)
PSOHLNE1 ;BIR/RTR-Parsing out segments from OERR ;01/20/95
"RTN","PSOHLNE1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,9,46,71,98,111,117,131,157,181**;DEC 1997
"RTN","PSOHLNE1",3,0)
 ;External reference to EN^ORERR supported by DBIA 2187
"RTN","PSOHLNE1",4,0)
 ;External reference to PS(50.607 supported by DBIA 2221
"RTN","PSOHLNE1",5,0)
 ;External reference to OR(100 supported by DBIA 2219
"RTN","PSOHLNE1",6,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOHLNE1",7,0)
 ;
"RTN","PSOHLNE1",8,0)
EN ;ORC segment
"RTN","PSOHLNE1",9,0)
 N Q1,Q2,Q3,Q4,Q5,Q6,Q7,PSOPOSSD
"RTN","PSOHLNE1",10,0)
 K PSOLQ1I,PSOLQ1II,PSOLQ1IX
"RTN","PSOHLNE1",11,0)
 I '$O(MSG(ZZ,0)) D
"RTN","PSOHLNE1",12,0)
 .S PSOOC="NW",PLACER=+$P(PSOSEG,"|",2),PLACERXX=+$P($P(PSOSEG,"|",2),";",2),ENTERED=$P(PSOSEG,"|",10),PROV=$P(PSOSEG,"|",12)
"RTN","PSOHLNE1",13,0)
 .S X=$P(PSOSEG,"|",15) S EFFECT=$$HL7TFM^XLFDT(X) K X
"RTN","PSOHLNE1",14,0)
 .D NOW^%DTC S PSOLOG=% K %
"RTN","PSOHLNE1",15,0)
 .;S RSN=$P(PSOSEG,"|",16)
"RTN","PSOHLNE1",16,0)
 .S ORCSEG=$P(PSOSEG,"|",7),QCOUNT=1 Q:$G(ORCSEG)'["~"
"RTN","PSOHLNE1",17,0)
 .F JJ=1:1:$L(ORCSEG) S:$E(ORCSEG,JJ)="~" QCOUNT=QCOUNT+1
"RTN","PSOHLNE1",18,0)
 I '$O(MSG(ZZ,0)) D  Q
"RTN","PSOHLNE1",19,0)
 .F JJJ=1:1:QCOUNT S QQQ=$P(ORCSEG,"~",JJJ) D:QQQ'=""
"RTN","PSOHLNE1",20,0)
 ..S PSOPOSSD=$S($P($P(QQQ,"^"),"&"):1,1:0) ;PSOPOSSD=1 if possible dose
"RTN","PSOHLNE1",21,0)
 ..S Q1I(JJJ)=$S(PSOPOSSD:$P(QQQ,"^"),1:$P(QQQ,"^",8)),PSOLQ1IX(JJJ)=$P($P(QQQ,"^"),"&",5) S PSOLQ1I(JJJ)=$P(QQQ,"^",8),PSOLQ1II(JJJ)=PSOPOSSD ;ORC piece 1 if Possible Dosage, ORC piece 8 if Local Possible Dosage
"RTN","PSOHLNE1",22,0)
 ..S Q1(JJJ)=$P(QQQ,"^",2) ;schedule
"RTN","PSOHLNE1",23,0)
 ..S Q2(JJJ)=$P(QQQ,"^",3) ;duration
"RTN","PSOHLNE1",24,0)
 ..S Q3(JJJ)=$P(QQQ,"^",4) I Q3(JJJ) S X=Q3(JJJ) S Q3(JJJ)=$$HL7TFM^XLFDT(X) K X ;start date
"RTN","PSOHLNE1",25,0)
 ..S Q4(JJJ)=$P(QQQ,"^",5) ;end date
"RTN","PSOHLNE1",26,0)
 ..S:$G(PRIOR)="" PRIOR=$P(QQQ,"^",6)
"RTN","PSOHLNE1",27,0)
 ..S Q6(JJJ)=$P(QQQ,"^",9) ;conjunction
"RTN","PSOHLNE1",28,0)
 ..S Q7(JJJ)=$P(QQQ,"^",10) ;sequencing
"RTN","PSOHLNE1",29,0)
 ..S QTARRAY(JJJ)=Q1(JJJ)_"^"_Q2(JJJ)_"^"_Q3(JJJ)_"^"_Q4(JJJ)_"^^"_Q6(JJJ)_"^"_Q7(JJJ)
"RTN","PSOHLNE1",30,0)
 ..S QTARRAY2(JJJ)=$S(PSOPOSSD:$P(Q1I(JJJ),"&"),1:Q1I(JJJ))_"^"_$S(PSOPOSSD:$P(Q1I(JJJ),"&",3),1:"")
"RTN","PSOHLNE1",31,0)
 ..I PSOPOSSD S $P(QTARRAY(JJJ),"^",5)=$P(Q1I(JJJ),"&",4)
"RTN","PSOHLNE1",32,0)
 ..I PSOPOSSD S PSOUNN=$P(Q1I(JJJ),"&",2) I PSOUNN'="" S PSOUNN=$O(^PS(50.607,"B",PSOUNN,0)) S $P(QTARRAY(JJJ),"^",9)=$G(PSOUNN)
"RTN","PSOHLNE1",33,0)
 ..K PSOUNN
"RTN","PSOHLNE1",34,0)
 ;For multiplte ORC subscripts
"RTN","PSOHLNE1",35,0)
 S (POVAR,POVAR1)="",(NNCK,NNN,NNNN)=0,PSOIII=1,MSG(ZZ,0)=$E(MSG(ZZ),5,$L(MSG(ZZ)))
"RTN","PSOHLNE1",36,0)
 S AAA="" F  S AAA=$O(MSG(ZZ,AAA)) Q:AAA=""  S NNN=0 F OOO=1:1:$L(MSG(ZZ,AAA)) S NNN=NNN+1 D  D:$G(POVAR1)="~"&(NNNN=6) PARSE D:$G(POVAR1)="|" PARSE
"RTN","PSOHLNE1",37,0)
 .I $E(MSG(ZZ,AAA),OOO)="|" S NNNN=NNNN+1
"RTN","PSOHLNE1",38,0)
 .S POVAR1=$E(MSG(ZZ,AAA),OOO)
"RTN","PSOHLNE1",39,0)
 .S POLIM=POVAR
"RTN","PSOHLNE1",40,0)
 .S POVAR=$S(POVAR="":POVAR1,1:POVAR_POVAR1)
"RTN","PSOHLNE1",41,0)
 .;I NNNN=6 I $G(POVAR1)="~"!($G(POVAR1)="|")
"RTN","PSOHLNE1",42,0)
END ;16 OF ORC?
"RTN","PSOHLNE1",43,0)
 ;I $G(POVAR)'="" I NNNN=14!(NNNN=15) S EFFECT=$G(POVAR)
"RTN","PSOHLNE1",44,0)
 S QCOUNT=0 F JJJ=0:0 S JJJ=$O(QTVAR(JJJ)) Q:'JJJ  I $L($G(QTVAR(JJJ))) S QCOUNT=QCOUNT+1 D
"RTN","PSOHLNE1",45,0)
 .S PSOPOSSD=$S($P($P(QTVAR(JJJ),"^"),"&"):1,1:0) ;PSOPOSSD =1 if possible dose
"RTN","PSOHLNE1",46,0)
 .S Q1I(JJJ)=$S(PSOPOSSD:$P(QTVAR(JJJ),"^"),1:$P(QTVAR(JJJ),"^",8)),PSOLQ1IX(JJJ)=$P($P(QTVAR(JJJ),"^"),"&",5) S PSOLQ1I(JJJ)=$P(QTVAR(JJJ),"^",8),PSOLQ1II(JJJ)=PSOPOSSD ;piece 1 if possible dose, piece 8 if not
"RTN","PSOHLNE1",47,0)
 .S Q1(JJJ)=$P(QTVAR(JJJ),"^",2)
"RTN","PSOHLNE1",48,0)
 .S Q2(JJJ)=$P(QTVAR(JJJ),"^",3)
"RTN","PSOHLNE1",49,0)
 .;S Q2(JJJ)=$S($E($P(QTVAR(JJJ),"^",3)):"D"_$P(QTVAR(JJJ),"^",3),$E($P(QTVAR(JJJ),"^",3))=0:"D"_$P(QTVAR(JJJ),"^",3),1:$P(QTVAR(JJJ),"^",3))
"RTN","PSOHLNE1",50,0)
 .S Q3(JJJ)=$P(QTVAR(JJJ),"^",4) I Q3(JJJ) S X=Q3(JJJ) S Q3(JJJ)=$$HL7TFM^XLFDT(X) K X
"RTN","PSOHLNE1",51,0)
 .S Q4(JJJ)=$P(QTVAR(JJJ),"^",5)
"RTN","PSOHLNE1",52,0)
 .S:$G(PRIOR)="" PRIOR=$P(QTVAR(JJJ),"^",6)
"RTN","PSOHLNE1",53,0)
 .S Q6(JJJ)=$P(QTVAR(JJJ),"^",9)
"RTN","PSOHLNE1",54,0)
 .S Q7(JJJ)=$P(QTVAR(JJJ),"^",10)
"RTN","PSOHLNE1",55,0)
 .S QTARRAY(JJJ)=Q1(JJJ)_"^"_Q2(JJJ)_"^"_Q3(JJJ)_"^"_Q4(JJJ)_"^^"_Q6(JJJ)_"^"_Q7(JJJ)
"RTN","PSOHLNE1",56,0)
 .S QTARRAY2(JJJ)=$S(PSOPOSSD:$P(Q1I(JJJ),"&"),1:Q1I(JJJ))_"^"_$S(PSOPOSSD:$P(Q1I(JJJ),"&",3),1:"")
"RTN","PSOHLNE1",57,0)
 .I PSOPOSSD S $P(QTARRAY(JJJ),"^",5)=$P(Q1I(JJJ),"&",4)
"RTN","PSOHLNE1",58,0)
 .I PSOPOSSD S PSOUNN=$P(Q1I(JJJ),"&",2) I PSOUNN'="" S PSOUNN=$O(^PS(50.607,"B",PSOUNN,0)) S $P(QTARRAY(JJJ),"^",9)=$G(PSOUNN)
"RTN","PSOHLNE1",59,0)
 .K PSOUNN
"RTN","PSOHLNE1",60,0)
 I $G(EFFECT) S X=EFFECT S EFFECT=$$HL7TFM^XLFDT(X) K X
"RTN","PSOHLNE1",61,0)
 D NOW^%DTC S PSOLOG=% S:'$G(EFFECT) EFFECT=% K %
"RTN","PSOHLNE1",62,0)
 K MSG(ZZ,0)
"RTN","PSOHLNE1",63,0)
 Q
"RTN","PSOHLNE1",64,0)
PARSE I NNNN=1 S PSOOC="NW" G SET
"RTN","PSOHLNE1",65,0)
 I NNNN=2 S PLACER=+$G(POLIM),PLACERXX=+$P($G(POLIM),";",2) G SET
"RTN","PSOHLNE1",66,0)
 I NNNN=3!(NNNN=4)!(NNNN=5) G SET
"RTN","PSOHLNE1",67,0)
 I NNNN=6,$G(POVAR1)="~" S NNCK=NNCK+1,QTVAR(NNCK)=$G(POLIM) G SET
"RTN","PSOHLNE1",68,0)
 I NNNN=7 S NNCK=NNCK+1 S QTVAR(NNCK)=$G(POLIM) G SET
"RTN","PSOHLNE1",69,0)
 I NNNN=8!(NNNN=9) G SET
"RTN","PSOHLNE1",70,0)
 I NNNN=10 S ENTERED=$G(POLIM) G SET
"RTN","PSOHLNE1",71,0)
 I NNNN=11 G SET
"RTN","PSOHLNE1",72,0)
 I NNNN=12 S PROV=$G(POLIM) G SET
"RTN","PSOHLNE1",73,0)
 I NNNN=13!(NNNN=14) G SET
"RTN","PSOHLNE1",74,0)
 I NNNN=15 S EFFECT=$G(POLIM)
"RTN","PSOHLNE1",75,0)
SET S (POVAR,POLIM)="" Q
"RTN","PSOHLNE1",76,0)
 ;
"RTN","PSOHLNE1",77,0)
EXP ;
"RTN","PSOHLNE1",78,0)
 ;Q:'$G(OR("PLACE"))
"RTN","PSOHLNE1",79,0)
 Q:'$G(PSOFILNM)
"RTN","PSOHLNE1",80,0)
 S PSOMSORR=1
"RTN","PSOHLNE1",81,0)
 N PSOSSMES S PSOSSMES="CPRSUP"
"RTN","PSOHLNE1",82,0)
 I $G(PSOFILNM),$G(PSOFILNM)["S" S LL=+$G(PSOFILNM) I $D(^PS(52.41,LL,0)),$P($G(^(0)),"^",3)'="RF" G EXPEN
"RTN","PSOHLNE1",83,0)
 S LL=$G(PSOFILNM) I 'LL!('$D(^PSRX(+$G(LL),0))) S COMM="Order was not located by Pharmacy" D EN^ORERR(COMM,.MSG) D  G EXPQ
"RTN","PSOHLNE1",84,0)
 .F EER=0:0 S EER=$O(MSG(EER)) Q:'EER  S:$P(MSG(EER),"|")="PV1" PSERRPV1=MSG(EER) S:$P(MSG(EER),"|")="PID" PSERRPID=MSG(EER) S:$P(MSG(EER),"|")="ORC"&($G(PSERRORC)="") PSERRORC=MSG(EER)
"RTN","PSOHLNE1",85,0)
 .N MSG,PSOHINST D INIT^PSOHLSN S MSG(2)=$G(PSERRPID),MSG(3)=$G(PSERRPV1),MSG(4)="ORC|DE|"_$G(OR("PLACE"))_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"_"|"_$S($P($G(PSERRORC),"|",4)'="":$P(PSERRORC,"|",4),1:"") S:$G(COMM)'="" MSG(5)="NTE|16||"_COMM
"RTN","PSOHLNE1",86,0)
 .D SEND^PSOHLSN
"RTN","PSOHLNE1",87,0)
 Q:'$D(^PSRX(LL,0))
"RTN","PSOHLNE1",88,0)
 I +$P($G(^PSRX(LL,2)),"^",6)<DT D
"RTN","PSOHLNE1",89,0)
 .I +$P($G(^PSRX(LL,"STA")),"^")<12!($P($G(^("STA")),"^")=16) S $P(^PSRX(LL,"STA"),"^")=11 D ECAN^PSOUTL(LL)
"RTN","PSOHLNE1",90,0)
 S GG=+$P($G(^PSRX(LL,"STA")),"^")
"RTN","PSOHLNE1",91,0)
 ;S AA=$S(GG=3:"OH",GG=12:"OD",GG=13:"OC",GG=14:"OD",GG=15:"OD",GG=16:"OH",1:"SC"),AAA=$S(GG=0:"CM",GG=1:"IP",GG=4:"IP",GG=5:"ZS",GG=11:"ZE",1:"")
"RTN","PSOHLNE1",92,0)
 S AA="SC",AAA=$S(GG=0:"CM",GG=2:"CM",GG=1:"IP",GG=4:"IP",GG=5:"ZS",GG=3:"HD",GG=16:"HD",GG=11:"ZE",1:"DC")
"RTN","PSOHLNE1",93,0)
 D EN^PSOHLSN1(LL,AA,AAA,"")
"RTN","PSOHLNE1",94,0)
 K PSOSSMES
"RTN","PSOHLNE1",95,0)
EXPQ K LL,GG,AA,AAA,PSOMSORR Q
"RTN","PSOHLNE1",96,0)
EXPEN ;SS on Pending orders
"RTN","PSOHLNE1",97,0)
 S AA=$P($G(^PS(52.41,LL,0)),"^",3)
"RTN","PSOHLNE1",98,0)
 S AAA=$S(AA="DC"!(AA="DE"):"DC",AA="HD":"HD",1:"IP")
"RTN","PSOHLNE1",99,0)
 D EN^PSOHLSN(OR("PLACE"),"SC",AAA)
"RTN","PSOHLNE1",100,0)
 G EXPQ
"RTN","PSOHLNE1",101,0)
 ;
"RTN","PSOHLNE1",102,0)
OID ;Chech for 1 to 1 match from Dispense Drug to Orderable Item
"RTN","PSOHLNE1",103,0)
 N PSOCDD,PSOCDDI,PSOCDDIZ
"RTN","PSOHLNE1",104,0)
 Q:'$G(PSORDITE)
"RTN","PSOHLNE1",105,0)
 K PSOCDDIZ
"RTN","PSOHLNE1",106,0)
 S (PSOCDD,PSOCDDI)=0
"RTN","PSOHLNE1",107,0)
 F  S PSOCDD=$O(^PSDRUG("ASP",PSORDITE,PSOCDD)) Q:'PSOCDD  I $S('$P($G(^PSDRUG(PSOCDD,"I")),"^"):1,DT'>$P($G(^("I")),"^"):1,1:0),$P($G(^PSDRUG(PSOCDD,2)),"^",3)["O" S PSOCDDI=PSOCDDI+1,PSOCDDIZ=PSOCDD
"RTN","PSOHLNE1",108,0)
 I PSOCDDI'=1 Q
"RTN","PSOHLNE1",109,0)
 S PSOQWX=$G(PSOCDDIZ)
"RTN","PSOHLNE1",110,0)
 Q
"RTN","PSOHLNE1",111,0)
CP ;ZSC segment
"RTN","PSOHLNE1",112,0)
 S SERV=$S($P(PSOSEG,"|")=1:"SC",$P(PSOSEG,"|")=0:"NSC",1:$P(PSOSEG,"|"))
"RTN","PSOHLNE1",113,0)
 S PSOIBY=$P(PSOSEG,"|",2)_"^"_$P(PSOSEG,"|",3)_"^"_$P(PSOSEG,"|",4)_"^"_$P(PSOSEG,"|",5)_"^"_$P(PSOSEG,"|",6)_"^"_$P(PSOSEG,"|",7)
"RTN","PSOHLNE1",114,0)
 Q
"RTN","PSOHLNE1",115,0)
MISX ;Mismatch patient on CPRS New Order
"RTN","PSOHLNE1",116,0)
 S RCOMM="Patient mismatch on New Order from CPRS." D EN^ORERR(RCOMM,.MSG) S NWFLAG=1 D RERROR^PSOHLSN D KL^PSOHLSIH
"RTN","PSOHLNE1",117,0)
 Q
"RTN","PSOHLNE1",118,0)
MISRN ;Mismatch on CPRS renewal
"RTN","PSOHLNE1",119,0)
 N PSOCINV
"RTN","PSOHLNE1",120,0)
 I $G(PDFN)'=$P($G(^PSRX(+$G(PREV),0)),"^",2) D  S PSOMO=1 Q
"RTN","PSOHLNE1",121,0)
 .S RCOMM="Patient mismatch on CPRS Renewal." D EN^ORERR(RCOMM,.MSG) S PSOXRP=1 D RERROR^PSOHLSN D KL^PSOHLSIH
"RTN","PSOHLNE1",122,0)
 S PSOCINV=+$P($G(^OR(100,+$G(PLACER),3)),"^",5)
"RTN","PSOHLNE1",123,0)
 I PSOCINV'=$P($G(^PSRX(+$G(PREV),"OR1")),"^",2) D  S PSOMO=1 Q
"RTN","PSOHLNE1",124,0)
 .S RCOMM="Order mismatch on CPRS Renewal." D EN^ORERR(RCOMM,.MSG) S PSOCVI=1 D RERROR^PSOHLSN D KL^PSOHLSIH
"RTN","PSOHLNE1",125,0)
 Q
"RTN","PSOHLNE1",126,0)
ZRX ;Process ZRX segment
"RTN","PSOHLNE1",127,0)
 I $P(PSOSEG,"|",3)="R" S PSOOC="RNW",PSRNFLAG=1
"RTN","PSOHLNE1",128,0)
 S PREV=$S(+$P(PSOSEG,"|"):+$P(PSOSEG,"|"),1:"")
"RTN","PSOHLNE1",129,0)
 I $P(PSOSEG,"|")["P"!($P(PSOSEG,"|")["S") S PFLAG=1
"RTN","PSOHLNE1",130,0)
 S NATURE=$P(PSOSEG,"|",2)
"RTN","PSOHLNE1",131,0)
 S PSORSO=$P(PSOSEG,"|",3)
"RTN","PSOHLNE1",132,0)
 S ROUTING=$P(PSOSEG,"|",4)
"RTN","PSOHLNE1",133,0)
 I ROUTING="" S ROUTING="M"
"RTN","PSOHLNE1",134,0)
 I $P(PSOSEG,"|",7) S DSIG=1
"RTN","PSOHLNE1",135,0)
 Q
"RTN","PSOHLNE1",136,0)
CHCS ;Replace CHCS number with CPRS number in .01 field
"RTN","PSOHLNE1",137,0)
 N PSOHTMP
"RTN","PSOHLNE1",138,0)
 I $G(PDFN),PDFN'=+$P($G(^PS(52.41,+$G(PSOCHFFL),0)),"^",2) S COMM="Patient does not match" D EN^ORERR(COMM,.MSG) K PSOPLC,PSOFFL,PSOSND Q
"RTN","PSOHLNE1",139,0)
 I '$D(^PS(52.41,+$G(PSOCHFFL),0)) S COMM="Order was not located by Pharmacy" D EN^ORERR(COMM,.MSG) K PSOPLC,PSOFFL,PSOSND Q
"RTN","PSOHLNE1",140,0)
 S PSOHTMP=$P($G(^PS(52.41,+$G(PSOCHFFL),0)),"^")
"RTN","PSOHLNE1",141,0)
 I PSOHTMP'="" K ^PS(52.41,"B",PSOHTMP,+$G(PSOCHFFL))
"RTN","PSOHLNE1",142,0)
 S $P(^PS(52.41,+$G(PSOCHFFL),0),"^")=PSOPLC,^PS(52.41,"B",PSOPLC,+$G(PSOCHFFL))=""
"RTN","PSOHLNE1",143,0)
 S $P(^PS(52.41,+$G(PSOCHFFL),"EXT"),"^",2)=1
"RTN","PSOHLNE1",144,0)
 Q
"RTN","PSOHLNE1",145,0)
CNT ;
"RTN","PSOHLNE1",146,0)
 S TAC=0 F TACA=0:0 S TACA=$O(^PSRX(PREV,"A",TACA)) Q:'TACA  S TAC=TACA
"RTN","PSOHLNE1",147,0)
 S PAC=0 F PACA=0:0 S PACA=$O(^PSRX(PREV,1,PACA)) Q:'PACA  S PAC=PACA
"RTN","PSOHLNE1",148,0)
 D NOW^%DTC S TAC=TAC+1,^PSRX(PREV,"A",0)="^52.3DA^"_TAC_"^"_TAC,^PSRX(PREV,"A",TAC,0)=%_"^"_"C"_"^"_$S(+$G(PROV):$G(PROV),1:+$G(ENTERED))_"^"_PAC_"^"_"Discontinued due to CPRS edit"
"RTN","PSOHLNE1",149,0)
 K TAC,PAC,TACA,PACA
"RTN","PSOHLNE1",150,0)
 Q
"RTN","PSOHLNE1",151,0)
NTE ;
"RTN","PSOHLNE1",152,0)
 S WPCT=1,WORDP=$S($P(MSG(LL),"|",2):$P(MSG(LL),"|",2),1:$P(MSG(LL),"|",3)) S:$P(MSG(LL),"|",4)'="" WPARRAY(WORDP,WPCT)=$P(MSG(LL),"|",4) S:$P(MSG(LL),"|",4)'="" WPCT=WPCT+1 F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNE1",153,0)
 .I $G(MSG(LL,LLL))'="" S WPARRAY(WORDP,WPCT)=$G(MSG(LL,LLL)),WPCT=WPCT+1
"RTN","PSOHLNE1",154,0)
 Q
"RTN","PSOHLSN1")
0^2^B84591647
"RTN","PSOHLSN1",1,0)
PSOHLSN1 ;BIR/RTR-Send order info to OERR from file 52 ;10/10/94
"RTN","PSOHLSN1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,10,24,27,55,46,71,101,99,121,139,157,181**;DEC 1997
"RTN","PSOHLSN1",3,0)
 ;Reference #50.606-DBIA 2174
"RTN","PSOHLSN1",4,0)
 ;#50.607-DBIA 2221
"RTN","PSOHLSN1",5,0)
 ;#50.7-DBIA 2223
"RTN","PSOHLSN1",6,0)
 ;#51.2-DBIA 2226
"RTN","PSOHLSN1",7,0)
 ;#50-DBIA 221
"RTN","PSOHLSN1",8,0)
 ;PSNDF-DBIA 2195
"RTN","PSOHLSN1",9,0)
 ;EN^PSSUTIL1-DBIA 3179
"RTN","PSOHLSN1",10,0)
 ;
"RTN","PSOHLSN1",11,0)
EN(PSRXIEN,STAT,PSSTAT,COMM,PSNOO) ;
"RTN","PSOHLSN1",12,0)
 N COUNT,DFN,J,LIMIT,NAME,NULLFLDS,PSDIEN,PSFLAG,PSND1,PSND2,PSND3,PRODUCT,UNIT,POIPTR,PSOHINST,PODOSE,PODOSENM,PSROUTE,RTNAME,SEGMENT,CCC,BBB,CSCOUNT,PPTR,MSG,PSOHSTRT,PSOHSTOP,PSOHISSD,PSORTLP,ZRXFLAG,RXE2FLAG,RXE2ONLY,PSODFN,EDUZ
"RTN","PSOHLSN1",13,0)
 N PSOCDDUZ,DA,FSIG,BSIG,PSHRX,PSHORX,PSNOOTX,ZPRE,PSOZSTAT,CCCX,PSOCPS
"RTN","PSOHLSN1",14,0)
 K FIELD
"RTN","PSOHLSN1",15,0)
 I $G(STAT)="" Q
"RTN","PSOHLSN1",16,0)
 I STAT="CR"!(STAT="DR")!(STAT="HR")!(STAT="OC")!(STAT="OD")!(STAT="OH")!(STAT="Z@")!(STAT="RP") S PSOZSTAT=STAT D DELP^PSOHLSN S STAT=PSOZSTAT G SKIP
"RTN","PSOHLSN1",17,0)
 I STAT="SC" I $G(PSSTAT)="ZE"!($G(PSSTAT)="HD")!($G(PSSTAT)="DC") S PSOZSTAT=STAT D DELP^PSOHLSN S STAT=PSOZSTAT
"RTN","PSOHLSN1",18,0)
SKIP ;
"RTN","PSOHLSN1",19,0)
 I $G(STAT)="SC",$G(PSSTAT)="ZE",$P($G(^PSRX(+$G(PSRXIEN),0)),"^",19)=2 Q
"RTN","PSOHLSN1",20,0)
 I $G(STAT)="RP" S STAT="OD",PSSTAT="RP"
"RTN","PSOHLSN1",21,0)
 S COUNT=0,NULLFLDS="F JJ=0:1:LIMIT S FIELD(JJ)="""""
"RTN","PSOHLSN1",22,0)
 I '$D(^PSRX(PSRXIEN,0)) Q
"RTN","PSOHLSN1",23,0)
 I STAT'="SN",STAT'="ZC",'$P($G(^PSRX(PSRXIEN,"OR1")),"^",2) Q
"RTN","PSOHLSN1",24,0)
 I $G(STAT)="SC",$G(PSSTAT)="ZE" S $P(^PSRX(PSRXIEN,0),"^",19)=2
"RTN","PSOHLSN1",25,0)
 D INIT
"RTN","PSOHLSN1",26,0)
 S COUNT=1,(ZRXFLAG,RXE2FLAG,RXE2ONLY)=0 D PID,PV1,ORC
"RTN","PSOHLSN1",27,0)
 I $G(STAT)="Z@" G NCM
"RTN","PSOHLSN1",28,0)
 I $G(STAT)="OK"!($G(STAT)="SN")!($G(STAT)="ZC")!($G(STAT)="XX")!($G(STAT)="SC")!($G(STAT)="RO") D RXO,RXE,RXR,ZRX,ZSC G NCM
"RTN","PSOHLSN1",29,0)
 I $G(STAT)="SC",$G(PSSTAT)="CM" D RXO,RXE,RXR,ZRX,ZSC
"RTN","PSOHLSN1",30,0)
 I '$G(RXE2FLAG) S RXE2ONLY=1 D RXE,SEGPARX^PSOHLSN
"RTN","PSOHLSN1",31,0)
 I '$G(ZRXFLAG) D ZRX
"RTN","PSOHLSN1",32,0)
NCM D SEND
"RTN","PSOHLSN1",33,0)
 K PSRXIEN Q
"RTN","PSOHLSN1",34,0)
INIT K ^UTILITY("DIQ1",$J),DIQ S DA=$P($$SITE^VASITE(),"^") I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOHINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIQ,DIC
"RTN","PSOHLSN1",35,0)
 S MSG(1)="MSH|^~\&|PHARMACY|"_$G(PSOHINST)_"|||||"_$S($G(PSOMSORR):"ORR",1:"ORM")
"RTN","PSOHLSN1",36,0)
 Q
"RTN","PSOHLSN1",37,0)
PID S LIMIT=5 X NULLFLDS
"RTN","PSOHLSN1",38,0)
 S DFN=+$P(^PSRX(PSRXIEN,0),"^",2) D DEM^VADPT S NAME=$G(VADM(1)) K VADM
"RTN","PSOHLSN1",39,0)
 S FIELD(0)="PID"
"RTN","PSOHLSN1",40,0)
 S FIELD(3)=DFN
"RTN","PSOHLSN1",41,0)
 S FIELD(5)=NAME
"RTN","PSOHLSN1",42,0)
 D SEG Q
"RTN","PSOHLSN1",43,0)
PV1 ;
"RTN","PSOHLSN1",44,0)
 S LIMIT=19 X NULLFLDS
"RTN","PSOHLSN1",45,0)
 S FIELD(0)="PV1"
"RTN","PSOHLSN1",46,0)
 S FIELD(2)="O"
"RTN","PSOHLSN1",47,0)
 S:$P(^PSRX(PSRXIEN,0),"^",5) FIELD(3)=$P(^(0),"^",5)
"RTN","PSOHLSN1",48,0)
 D SEG Q
"RTN","PSOHLSN1",49,0)
ORC ;
"RTN","PSOHLSN1",50,0)
 S LIMIT=15 X NULLFLDS
"RTN","PSOHLSN1",51,0)
 S FIELD(0)="ORC"
"RTN","PSOHLSN1",52,0)
 S FIELD(1)=$G(STAT)
"RTN","PSOHLSN1",53,0)
 I $G(STAT)'="SN",$G(STAT)'="ZC" S FIELD(2)=$P($G(^PSRX(PSRXIEN,"OR1")),"^",2)
"RTN","PSOHLSN1",54,0)
 S:FIELD(2)'="" FIELD(2)=FIELD(2)_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"
"RTN","PSOHLSN1",55,0)
 S FIELD(3)=PSRXIEN_"^PS"
"RTN","PSOHLSN1",56,0)
 S FIELD(5)=$G(PSSTAT)
"RTN","PSOHLSN1",57,0)
 I $G(STAT)="RO",$G(PSOROPCH)'="PATCH" S FIELD(5)="CM"
"RTN","PSOHLSN1",58,0)
 I $G(FIELD(5))="" I $G(STAT)="OR"!($G(STAT)="OE") S FIELD(5)="CM"
"RTN","PSOHLSN1",59,0)
 S X=$P($G(^PSRX(PSRXIEN,2)),"^") I X S FIELD(9)=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",60,0)
 S EDUZ=$P($G(^PSRX(PSRXIEN,0)),"^",16) I EDUZ S FIELD(10)=EDUZ_"^"_$P($G(^VA(200,EDUZ,0)),"^")
"RTN","PSOHLSN1",61,0)
 I $G(PSOCANRC),$G(PSOCANRN)'="" I $G(STAT)="OD"!($G(STAT)="OC") S FIELD(12)=$G(PSOCANRC)_"^"_$G(PSOCANRN)
"RTN","PSOHLSN1",62,0)
 I '$G(FIELD(12)) S FIELD(12)=$P($G(^PSRX(PSRXIEN,0)),"^",4)_"^"_$P($G(^VA(200,+$P($G(^PSRX(PSRXIEN,0)),"^",4),0)),"^")
"RTN","PSOHLSN1",63,0)
 S PSOHISSD="",X=$P($G(^PSRX(PSRXIEN,0)),"^",13) I X S PSOHISSD=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",64,0)
 S FIELD(15)=$G(PSOHISSD) K X
"RTN","PSOHLSN1",65,0)
 D SEG
"RTN","PSOHLSN1",66,0)
 I $G(COMM)'=""!($G(PSNOO)'="") D
"RTN","PSOHLSN1",67,0)
 .I $G(PSNOO)'="" D NOO
"RTN","PSOHLSN1",68,0)
 .I $L($G(COMM))+($L(MSG(COUNT)))+($L($G(PSNOOTX)))+($S($G(PSNOO)'="":11,1:5))<245 S MSG(COUNT)=MSG(COUNT)_"|"_$G(PSNOO)_"^"_$G(PSNOOTX)_"^"_$S($G(PSNOO)'="":"99ORN",1:"")_"^^"_$G(COMM)_"^" Q
"RTN","PSOHLSN1",69,0)
 .S MSG(COUNT,1)="|"_$G(PSNOO)_"^"_$G(PSNOOTX)_"^"_$S($G(PSNOO)'="":"99ORN",1:"")_"^^"_$G(COMM)_"^"
"RTN","PSOHLSN1",70,0)
 Q
"RTN","PSOHLSN1",71,0)
RXO ;
"RTN","PSOHLSN1",72,0)
 S LIMIT=1 X NULLFLDS
"RTN","PSOHLSN1",73,0)
 S FIELD(0)="RXO"
"RTN","PSOHLSN1",74,0)
 S PPTR=+$P($G(^PSRX(PSRXIEN,"OR1")),"^")
"RTN","PSOHLSN1",75,0)
 S FIELD(1)=$S('PPTR:"^^^^^",1:"^^^"_PPTR_"^"_$P($G(^PS(50.7,PPTR,0)),"^")_" "_$P($G(^PS(50.606,+$P($G(^(0)),"^",2),0)),"^")_"^99PSP")
"RTN","PSOHLSN1",76,0)
 D SEG Q
"RTN","PSOHLSN1",77,0)
 ;
"RTN","PSOHLSN1",78,0)
RXE ;
"RTN","PSOHLSN1",79,0)
 S RXE2FLAG=1
"RTN","PSOHLSN1",80,0)
 S LIMIT=$S('$G(RXE2ONLY):26,1:2) X NULLFLDS
"RTN","PSOHLSN1",81,0)
 S FIELD(0)="RXE"
"RTN","PSOHLSN1",82,0)
 S (PSOHSTRT,PSOHSTOP)="" S X=$P($G(^PSRX(PSRXIEN,2)),"^",2) I X S PSOHSTRT=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",83,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLSN1",84,0)
 S X=$S($P($G(^PSRX(PSRXIEN,3)),"^",5):$P($G(^(3)),"^",5),$G(STAT)="OD"!($G(STAT)="OC"):$G(DT),$P($G(^(2)),"^",6):$P($G(^(2)),"^",6),1:$G(DT)) I X S PSOHSTOP=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",85,0)
 K X N PSOMZT,MMZZ,MMZZT S MMZZT=1 F MMZZ=0:0 S MMZZ=$O(^PSRX(PSRXIEN,6,MMZZ)) Q:'MMZZ  D:$D(^(MMZZ,0))
"RTN","PSOHLSN1",86,0)
 .S FIELD(1,MMZZT)=$S($P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",2):$P($G(^(0)),"^")_"&"_$P($G(^PS(50.607,+$P($G(^(0)),"^",3),0)),"^")_"&"_$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",2)_"&"_$P($G(^(0)),"^",4),1:"")_"^"_$P($G(^(0)),"^",8)
"RTN","PSOHLSN1",87,0)
 .I $P($G(FIELD(1,MMZZT)),"^")'="" F PSOMZT=1,3 I $E($P(FIELD(1,MMZZT),"&",PSOMZT),1)="." S $P(FIELD(1,MMZZT),"&",PSOMZT)="0"_$P(FIELD(1,MMZZT),"&",PSOMZT)
"RTN","PSOHLSN1",88,0)
 .S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"^"_$$DUR(PSRXIEN,MMZZ)_"^^^^^"_$S($P($G(FIELD(1,MMZZT)),"^")'="":$P($G(FIELD(1,MMZZT)),"&")_$P($G(FIELD(1,MMZZT)),"&",2),1:$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^"))
"RTN","PSOHLSN1",89,0)
 .S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"^"_$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",6)
"RTN","PSOHLSN1",90,0)
 .I $O(^PSRX(PSRXIEN,6,MMZZ)) S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"~"
"RTN","PSOHLSN1",91,0)
 .S MMZZT=MMZZT+1
"RTN","PSOHLSN1",92,0)
 S $P(FIELD(1,1),"^",4)=$G(PSOHSTRT),$P(FIELD(1,1),"^",5)=$G(PSOHSTOP)
"RTN","PSOHLSN1",93,0)
 S PSFLAG=0,PSDIEN=+$P(^PSRX(PSRXIEN,0),"^",6),PSND1=$P($G(^PSDRUG(PSDIEN,"ND")),"^"),PSND2=$P($G(^("ND")),"^",2),PSND3=$P($G(^("ND")),"^",3) I PSND1,PSND3 S PSFLAG=1
"RTN","PSOHLSN1",94,0)
 S FIELD(2)=$S(PSFLAG:PSND1_"."_PSND3_"^"_PSND2_"^"_"99NDF",1:"^^")_"^"_PSDIEN_"^"_$P($G(^PSDRUG(PSDIEN,0)),"^")_"^"_"99PSD"
"RTN","PSOHLSN1",95,0)
 Q:$G(RXE2ONLY)
"RTN","PSOHLSN1",96,0)
 I PSFLAG D
"RTN","PSOHLSN1",97,0)
 .I $T(^PSNAPIS)]"" S PSOXN=$$DFSU^PSNAPIS(PSND1,PSND3) S FIELD(5)="^^^"_$P($G(PSOXN),"^",5)_"^"_$P($G(PSOXN),"^",6)_"^"_"99PSU" K PSOXN Q
"RTN","PSOHLSN1",98,0)
 .S PRODUCT=$G(^PSNDF(PSND1,5,PSND3,0)) S UNIT=$P($G(^PSNDF(PSND1,2,+$P(PRODUCT,"^",2),3,+$P(PRODUCT,"^",3),4,+$P(PRODUCT,"^",4),0)),"^")
"RTN","PSOHLSN1",99,0)
 .S FIELD(5)="^^^"_UNIT_"^"_$P($G(^PS(50.607,+UNIT,0)),"^")_"^"_"99PSU"
"RTN","PSOHLSN1",100,0)
 S POIPTR=$P($G(^PSRX(PSRXIEN,"OR1")),"^") I POIPTR S PODOSE=$P($G(^PS(50.7,POIPTR,0)),"^",2),PODOSENM=$P($G(^PS(50.606,+PODOSE,0)),"^")
"RTN","PSOHLSN1",101,0)
 I POIPTR S FIELD(6)="^^^"_$G(PODOSE)_"^"_$G(PODOSENM)_"^"_"99PSF"
"RTN","PSOHLSN1",102,0)
 S FIELD(10)=$P(^PSRX(PSRXIEN,0),"^",7)
"RTN","PSOHLSN1",103,0)
 S FIELD(12)=$P(^PSRX(PSRXIEN,0),"^",9)
"RTN","PSOHLSN1",104,0)
 S FIELD(14)=$P(^PSRX(PSRXIEN,0),"^",4)
"RTN","PSOHLSN1",105,0)
 S FIELD(15)=$P(^PSRX(PSRXIEN,0),"^")
"RTN","PSOHLSN1",106,0)
 S FIELD(22)=$P(^PSRX(PSRXIEN,0),"^",8)
"RTN","PSOHLSN1",107,0)
 K MMZZ S MMZZ=$$EN^PSSUTIL1(PSDIEN) S FIELD(25)=$S($E($P(MMZZ,"|"),1)=".":"0",1:"")_$P(MMZZ,"|"),FIELD(26)=$P(MMZZ,"|",2)
"RTN","PSOHLSN1",108,0)
 N PLIM,PVAR,PVAR1,SUBCOUNT D SEGPARX^PSOHLSN
"RTN","PSOHLSN1",109,0)
 ;
"RTN","PSOHLSN1",110,0)
 I $O(^PSRX(PSRXIEN,"PRC",0)) D
"RTN","PSOHLSN1",111,0)
 .S COUNT=COUNT+1,CCC=$O(^PSRX(PSRXIEN,"PRC",0))
"RTN","PSOHLSN1",112,0)
 .S MSG(COUNT)="NTE|6||"_$G(^PSRX(PSRXIEN,"PRC",CCC,0))
"RTN","PSOHLSN1",113,0)
 .S CSCOUNT=1 F CCC=CCC:0 S CCC=$O(^PSRX(PSRXIEN,"PRC",CCC)) Q:'CCC  S MSG(COUNT,CSCOUNT)=$G(^PSRX(PSRXIEN,"PRC",CCC,0)),CSCOUNT=CSCOUNT+1
"RTN","PSOHLSN1",114,0)
 I $O(^PSRX(PSRXIEN,"INS1",0)) D
"RTN","PSOHLSN1",115,0)
 .S COUNT=COUNT+1,CCC=$O(^PSRX(PSRXIEN,"INS1",0))
"RTN","PSOHLSN1",116,0)
 .S MSG(COUNT)="NTE|7|L|"_$G(^PSRX(PSRXIEN,"INS1",CCC,0))
"RTN","PSOHLSN1",117,0)
 .S CCCX=1 F CCC=CCC:0 S CCC=$O(^PSRX(PSRXIEN,"INS1",CCC,0)) Q:'CCC  I $D(^(0)) S MSG(COUNT,CCCX)=$G(^(0)) S CCCX=CCCX+1
"RTN","PSOHLSN1",118,0)
 S COUNT=COUNT+1
"RTN","PSOHLSN1",119,0)
 I $P($G(^PSRX(PSRXIEN,"SIG")),"^",2) D  Q
"RTN","PSOHLSN1",120,0)
 .D FSIG^PSOUTLA("R",PSRXIEN,238) S MSG(COUNT)="NTE|21||"_$S($G(FSIG(1))'="":$G(FSIG(1)),1:"No SIG available") I $O(FSIG(1)) F CCC=1:0 S CCC=$O(FSIG(CCC)) Q:'CCC  S MSG(COUNT,(CCC-1))=$G(FSIG(CCC))
"RTN","PSOHLSN1",121,0)
 I '$P($G(^PSRX(PSRXIEN,"SIG")),"^",2) D  Q
"RTN","PSOHLSN1",122,0)
 .D EN3^PSOUTLA1(PSRXIEN,238) S MSG(COUNT)="NTE|21||"_$S($G(BSIG(1))'="":$G(BSIG(1)),1:"No SIG available") I $O(BSIG(1)) F CCC=1:0 S CCC=$O(BSIG(CCC)) Q:'CCC  S MSG(COUNT,(CCC-1))=$G(BSIG(CCC))
"RTN","PSOHLSN1",123,0)
 Q
"RTN","PSOHLSN1",124,0)
 ;
"RTN","PSOHLSN1",125,0)
RXR ;
"RTN","PSOHLSN1",126,0)
 F PSORTLP=0:0 S PSORTLP=$O(^PSRX(PSRXIEN,6,PSORTLP)) Q:'PSORTLP  D
"RTN","PSOHLSN1",127,0)
 .S LIMIT=1 X NULLFLDS
"RTN","PSOHLSN1",128,0)
 .S FIELD(0)="RXR"
"RTN","PSOHLSN1",129,0)
 .S PSROUTE=$P($G(^PSRX(PSRXIEN,6,PSORTLP,0)),"^",7) I PSROUTE,$D(^PS(51.2,PSROUTE,0))  S RTNAME=$P(^PS(51.2,PSROUTE,0),"^")
"RTN","PSOHLSN1",130,0)
 .S FIELD(1)="^^^"_$G(PSROUTE)_"^"_$G(RTNAME)_"^"_"99PSR"
"RTN","PSOHLSN1",131,0)
 .D SEG
"RTN","PSOHLSN1",132,0)
 Q
"RTN","PSOHLSN1",133,0)
ZSC S PSOCPS=$$DT^PSOMLLDT S LIMIT=$S($G(PSOCPS):6,1:1) X NULLFLDS
"RTN","PSOHLSN1",134,0)
 S FIELD(0)="ZSC"
"RTN","PSOHLSN1",135,0)
 I '$G(PSOCPS) S FIELD(1)=$S($P($G(^PSRX(PSRXIEN,"IB")),"^"):"NSC",1:"SC")
"RTN","PSOHLSN1",136,0)
 I $G(PSOCPS) D
"RTN","PSOHLSN1",137,0)
 .S FIELD(1)=$P($G(^PSRX(PSRXIEN,"IBQ")),"^"),FIELD(2)=$P($G(^("IBQ")),"^",2),FIELD(3)=$P($G(^("IBQ")),"^",3),FIELD(4)=$P($G(^("IBQ")),"^",4),FIELD(5)=$P($G(^("IBQ")),"^",5),FIELD(6)=$P($G(^("IBQ")),"^",6),FIELD(7)=$P($G(^("IBQ")),"^",7)
"RTN","PSOHLSN1",138,0)
 D SEG Q
"RTN","PSOHLSN1",139,0)
ZRX ;
"RTN","PSOHLSN1",140,0)
 S ZRXFLAG=1
"RTN","PSOHLSN1",141,0)
 S LIMIT=6 X NULLFLDS
"RTN","PSOHLSN1",142,0)
 S FIELD(0)="ZRX"
"RTN","PSOHLSN1",143,0)
 S ZPRE=$P($G(^PSRX(PSRXIEN,"OR1")),"^",3) I ZPRE S FIELD(1)=$P($G(^PSRX(ZPRE,"OR1")),"^",2)
"RTN","PSOHLSN1",144,0)
 I '$G(FIELD(1)),$G(PSORDEDT) S FIELD(1)=$P($G(^PS(52.41,$G(PSORDEDT),0)),"^")
"RTN","PSOHLSN1",145,0)
 S FIELD(2)=$G(PSNOO)
"RTN","PSOHLSN1",146,0)
 I $G(STAT)="SN"!($G(STAT)="RO") S FIELD(3)=$S($G(STAT)="RO"!($G(PSOEDIT)):"E",$G(PSOOPT)=3:"R",1:"N")
"RTN","PSOHLSN1",147,0)
 S FIELD(4)=$P(^PSRX(PSRXIEN,0),"^",11)
"RTN","PSOHLSN1",148,0)
 S PSOCDDUZ=$S($G(PSOROPCH)="PATCH":$P($G(^PSRX(PSRXIEN,"OR1")),"^",5),$G(PSOHUIOR)&($P($G(^PSRX(PSRXIEN,"EXT")),"^")'=""):+$G(PSOCANRC),1:$G(DUZ))
"RTN","PSOHLSN1",149,0)
 I $G(PSOCDDUZ) S FIELD(5)=PSOCDDUZ_"^"_$P($G(^VA(200,PSOCDDUZ,0)),"^")_"^"_"99NP"
"RTN","PSOHLSN1",150,0)
 I $G(STAT)="ZD",$G(PSODISPP) S FIELD(6)="P"
"RTN","PSOHLSN1",151,0)
 D SEG Q
"RTN","PSOHLSN1",152,0)
SEG S SEGMENT="" F J=0:1:LIMIT S SEGMENT=$S(SEGMENT="":FIELD(J),1:SEGMENT_"|"_FIELD(J))
"RTN","PSOHLSN1",153,0)
 S COUNT=COUNT+1,MSG(COUNT)=SEGMENT
"RTN","PSOHLSN1",154,0)
 Q
"RTN","PSOHLSN1",155,0)
SEND D:$G(PSRXIEN)&($T(EN^PSOHDR)]"")&($G(PSOSSMES)'="CPRSUP")  K FIELD D MSG^XQOR("PS EVSEND OR",.MSG) Q
"RTN","PSOHLSN1",156,0)
 .I $G(STAT)="ZC"!($G(STAT)="UC")!($G(STAT)="UD")!($G(STAT)="UH")!($G(STAT)="UR")!($G(STAT)="DE")!($G(STAT)="ZD") Q
"RTN","PSOHLSN1",157,0)
 .I $G(STAT)="SC" I $G(PSSTAT)="ZZ"!($G(PSSTAT)="ZS")!($G(PSSTAT)="ZU") Q
"RTN","PSOHLSN1",158,0)
 .D EN^PSOHDR("PRES",PSRXIEN)
"RTN","PSOHLSN1",159,0)
 ;
"RTN","PSOHLSN1",160,0)
NOO ;
"RTN","PSOHLSN1",161,0)
 I $G(PSNOO)="" S PSNOOTX="" Q
"RTN","PSOHLSN1",162,0)
 S PSNOOTX=$S(PSNOO="W":"Written",PSNOO="V":"Verbal",PSNOO="P":"Telephoned",PSNOO="S":"Service Correction",PSNOO="X":"Rejected",PSNOO="D":"Duplicate",PSNOO="I":"Policy",PSNOO="E":"Physician Entered",PSNOO="A":"Auto DC",1:"") Q
"RTN","PSOHLSN1",163,0)
 Q
"RTN","PSOHLSN1",164,0)
 ;
"RTN","PSOHLSN1",165,0)
DUR(PSODX1,PSODX2) ;
"RTN","PSOHLSN1",166,0)
 N PSODX,PSODX4,PSODX5,PSODX6,PSODX7 S PSODX=$P($G(^PSRX(PSODX1,6,PSODX2,0)),"^",5)
"RTN","PSOHLSN1",167,0)
 I 'PSODX Q PSODX
"RTN","PSOHLSN1",168,0)
 S PSODX4=$L(PSODX),PSODX5=$E(PSODX,PSODX4)
"RTN","PSOHLSN1",169,0)
 S PSODX=$S(PSODX5?1A:PSODX,1:PSODX_"D")
"RTN","PSOHLSN1",170,0)
 S PSODX6=$L(PSODX)
"RTN","PSOHLSN1",171,0)
 S PSODX7=$E(PSODX,PSODX6)_$E(PSODX,1,(PSODX6-1))
"RTN","PSOHLSN1",172,0)
 Q PSODX7
"RTN","PSOHLSN1",173,0)
 Q
"RTN","PSOR52")
0^4^B25637956
"RTN","PSOR52",1,0)
PSOR52 ;IHS/DSD/JCM-files refill entries in prescription file ;03/10/93
"RTN","PSOR52",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,22,27,181**;DEC 1997
"RTN","PSOR52",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOR52",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOR52",5,0)
 ; This routine is responsible for the actual
"RTN","PSOR52",6,0)
 ; filing of the refill prescription.
"RTN","PSOR52",7,0)
 ;---------------------------------------------------------   
"RTN","PSOR52",8,0)
EN(PSOX) ;Entry Point
"RTN","PSOR52",9,0)
START ;
"RTN","PSOR52",10,0)
 D:$D(XRTL) T0^%ZOSV ; Start RT monitor
"RTN","PSOR52",11,0)
 D INIT G:PSOR52("QFLG") END
"RTN","PSOR52",12,0)
 D FILE
"RTN","PSOR52",13,0)
 D DIK
"RTN","PSOR52",14,0)
 S:$D(XRT0) XRTN=$T(+0) D:$D(XRT0) T1^%ZOSV ; Stop RT Monitor
"RTN","PSOR52",15,0)
 D FINISH
"RTN","PSOR52",16,0)
END D EOJ
"RTN","PSOR52",17,0)
 Q
"RTN","PSOR52",18,0)
 ;---------------------------------------------------------
"RTN","PSOR52",19,0)
 ;
"RTN","PSOR52",20,0)
INIT ;
"RTN","PSOR52",21,0)
 S PSOR52("QFLG")=0
"RTN","PSOR52",22,0)
 S PSOX("QTY")=$P(PSOX("RX0"),"^",7),PSOX("DAYS SUPPLY")=$P(PSOX("RX0"),"^",8)
"RTN","PSOR52",23,0)
 S:$G(^PSDRUG($P(PSOX("RX0"),"^",6),660))]"" PSOX("COST")=$P(^PSDRUG($P(PSOX("RX0"),"^",6),660),"^",6)
"RTN","PSOR52",24,0)
 D NOW^%DTC S PSOX("LOGIN DATE")=$E(%,1,7)
"RTN","PSOR52",25,0)
 S X1=PSOX("FILL DATE"),X2=PSOX("DAYS SUPPLY")-10\1 D C^%DTC S PSOX1=X
"RTN","PSOR52",26,0)
 S X1=$P(PSOX("RX2"),"^",2)
"RTN","PSOR52",27,0)
 S X2=PSOX("DAYS SUPPLY")*(PSOX("NUMBER")+1)-10\1
"RTN","PSOR52",28,0)
 D C^%DTC S PSOX2=X
"RTN","PSOR52",29,0)
 S PSOX("NEXT POSSIBLE REFILL")=$S(PSOX1>PSOX2:PSOX1,1:PSOX2)
"RTN","PSOR52",30,0)
 K X,PSOX1,PSOX2
"RTN","PSOR52",31,0)
 S (PSOX("LAST DISPENSED DATE"),PSOX("DISPENSED DATE"))=PSOX("FILL DATE")
"RTN","PSOR52",32,0)
 I PSOX("FILL DATE")>$S($G(PSOX("LOGIN DATE")):$E(PSOX("LOGIN DATE"),1,7),1:DT),$P(PSOPAR,"^",6) D
"RTN","PSOR52",33,0)
 .S PSOX("OLD MAIL/WINDOW")=$S($G(PSOX("MAIL/WINDOW"))]"":PSOX("MAIL/WINDOW"),1:"MAIL"),PSOX("MAIL/WINDOW")="M"
"RTN","PSOR52",34,0)
 I $P(PSOX("RX2"),"^",12)]"" S PSOX("GENERIC PROVIDER")=$P(PSOX("RX2"),"^",12)
"RTN","PSOR52",35,0)
 S PSOX("PROVIDER")=$P(PSOX("RX0"),"^",4)
"RTN","PSOR52",36,0)
 S:'$D(PSOX("CLERK CODE")) PSOX("CLERK CODE")=DUZ
"RTN","PSOR52",37,0)
INITX Q
"RTN","PSOR52",38,0)
 ;
"RTN","PSOR52",39,0)
FILE ;     
"RTN","PSOR52",40,0)
 ;L +^PSRX(PSOX("IRXN")):0
"RTN","PSOR52",41,0)
 I '$D(^PSRX(PSOX("IRXN"),1,0)) S ^(0)="^52.1DA^1^1"
"RTN","PSOR52",42,0)
 E  S ^PSRX(PSOX("IRXN"),1,0)=$P(^PSRX(PSOX("IRXN"),1,0),"^",1,2)_"^"_PSOX("NUMBER")_"^"_($P(^(0),"^",4)+1)
"RTN","PSOR52",43,0)
 F PSOX1=1:1 S PSOR52=$P($T(DD+PSOX1),";;",2,4) Q:PSOR52=""  K PSOY S PSOY=$P(PSOR52,";;") I $D(@PSOY) S $P(PSOR52(PSOX("IRXN"),1,PSOX("NUMBER"),$P(PSOR52,";;",2)),"^",$P(PSOR52,";;",3))=@PSOY
"RTN","PSOR52",44,0)
 K PSOX1,PSOY
"RTN","PSOR52",45,0)
 S PSOX1="" F  S PSOX1=$O(PSOR52(PSOX("IRXN"),1,PSOX("NUMBER"),PSOX1)) Q:PSOX1=""  S ^PSRX(PSOX("IRXN"),1,PSOX("NUMBER"),PSOX1)=$G(PSOR52(PSOX("IRXN"),1,PSOX("NUMBER"),PSOX1))
"RTN","PSOR52",46,0)
 K PSOX1
"RTN","PSOR52",47,0)
 S:PSOX("STA")=6 $P(^PSRX(PSOX("IRXN"),"STA"),"^")=0
"RTN","PSOR52",48,0)
 S $P(^PSRX(PSOX("IRXN"),3),"^",1,2)=PSOX("LAST DISPENSED DATE")_"^"_PSOX("NEXT POSSIBLE REFILL")
"RTN","PSOR52",49,0)
 S $P(^PSRX(PSOX("IRXN"),3),"^",4)=PSOX("LAST REFILL DATE")
"RTN","PSOR52",50,0)
 I $D(PSOX("METHOD OF PICK-UP")),PSOX("FILL DATE")'>DT S $P(^PSRX(PSOX("IRXN"),"MP"),"^")=PSOX("METHOD OF PICK-UP")
"RTN","PSOR52",51,0)
 ;L -^PSRX(PSOX("IRXN"))
"RTN","PSOR52",52,0)
 Q
"RTN","PSOR52",53,0)
 ;
"RTN","PSOR52",54,0)
DIK ;
"RTN","PSOR52",55,0)
 K DIK,DA
"RTN","PSOR52",56,0)
 S DIK="^PSRX(",DA=PSOX("IRXN") D IX1^DIK K DIK
"RTN","PSOR52",57,0)
 I +$G(^PSRX(DA,"IB")),$P(^PSRX(DA,1,PSOX("NUMBER"),0),"^",2)="W" S ^PSRX("ACP",$P(^PSRX(DA,0),"^",2),$P(^PSRX(DA,1,PSOX("NUMBER"),0),"^"),PSOX("NUMBER"),DA)="" K DA
"RTN","PSOR52",58,0)
 D:$T(EN^PSOHDR)]"" EN^PSOHDR("PREF",PSOX("IRXN"))
"RTN","PSOR52",59,0)
 Q
"RTN","PSOR52",60,0)
 ;
"RTN","PSOR52",61,0)
FINISH ;
"RTN","PSOR52",62,0)
 I $G(PSOX("QS"))="S" D  G FINISHX
"RTN","PSOR52",63,0)
 . S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=PSOX("NUMBER")
"RTN","PSOR52",64,0)
 . D SUS^PSORXL K DA
"RTN","PSOR52",65,0)
 . Q
"RTN","PSOR52",66,0)
 ;
"RTN","PSOR52",67,0)
 I PSOX("FILL DATE")>$S($G(PSOX("LOGIN DATE")):$E(PSOX("LOGIN DATE"),1,7),1:DT),$P(PSOPAR,"^",6) D  G FINISHX
"RTN","PSOR52",68,0)
 .K PSOXRXFL I $D(RXFL(PSOX("IRXN"))) S PSOXRXFL=$G(RXFL(PSOX("IRXN")))
"RTN","PSOR52",69,0)
 . S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=PSOX("NUMBER")
"RTN","PSOR52",70,0)
 . D SUS^PSORXL K DA
"RTN","PSOR52",71,0)
 .I $G(PSOXRXFL)'="" S RXFL(PSOX("IRXN"))=$G(PSOXRXFL) K PSOXRXFL
"RTN","PSOR52",72,0)
 . Q
"RTN","PSOR52",73,0)
 ;
"RTN","PSOR52",74,0)
 I $G(PSOX("QS"))="Q" D  G FINISHX
"RTN","PSOR52",75,0)
 . I $G(PPL),$L(PPL_PSOX("IRXN")_",")>240 D TRI^PSOBBC D Q^PSORXL K PPL,RXFL
"RTN","PSOR52",76,0)
 . S RXFL(PSOX("IRXN"))=PSOX("NUMBER")
"RTN","PSOR52",77,0)
 . I $G(PPL) S PPL=PPL_PSOX("IRXN")_","
"RTN","PSOR52",78,0)
 . E  S PPL=PSOX("IRXN")_","
"RTN","PSOR52",79,0)
 . Q
"RTN","PSOR52",80,0)
 ;
"RTN","PSOR52",81,0)
 I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSOX("IRXN")_",",RXFL(PSOX("IRXN"))=PSOX("NUMBER") G FINISHX
"RTN","PSOR52",82,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSOR52",83,0)
 I $L(PSORX("PSOL",PSOX2))+$L(PSOX("IRXN"))<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSOX("IRXN")_","
"RTN","PSOR52",84,0)
 E  S PSORX("PSOL",PSOX2+1)=PSOX("IRXN")_","
"RTN","PSOR52",85,0)
 S RXFL(PSOX("IRXN"))=PSOX("NUMBER")
"RTN","PSOR52",86,0)
FINISHX ; 
"RTN","PSOR52",87,0)
 ;call to build bingo board Rx array
"RTN","PSOR52",88,0)
 I $G(PSORX("MAIL/WINDOW"))["W" S BINGCRT=1,BINGRTE="W",BBFLG=1 D BBRX^PSORN52C
"RTN","PSOR52",89,0)
 K PSOX1,PSOX2
"RTN","PSOR52",90,0)
 Q
"RTN","PSOR52",91,0)
EOJ ;
"RTN","PSOR52",92,0)
 I $D(PSOX("OLD MAIL/WINDOW")) S PSOX("MAIL/WINDOW")=PSOX("OLD MAIL/WINDOW") K PSOX("OLD MAIL/WINDOW")
"RTN","PSOR52",93,0)
 S DA=$O(^PS(52.41,"ARF",PSOX("IRXN"),0)) I DA D  S DIK="^PS(52.41," D ^DIK
"RTN","PSOR52",94,0)
 .S PSORFKL=DA D PSOUL^PSSLOCK(PSORFKL_"S") K PSORFKL
"RTN","PSOR52",95,0)
 K PSOR52,DA,DIK
"RTN","PSOR52",96,0)
 Q
"RTN","PSOR52",97,0)
 ;
"RTN","PSOR52",98,0)
DD ;rx data nodes
"RTN","PSOR52",99,0)
 ;;PSOX("PROVIDER");;0;;17
"RTN","PSOR52",100,0)
 ;;PSOX("QTY");;0;;4
"RTN","PSOR52",101,0)
 ;;PSOX("DAYS SUPPLY");;0;;10
"RTN","PSOR52",102,0)
 ;;PSOX("MAIL/WINDOW");;0;;2
"RTN","PSOR52",103,0)
 ;;PSOX("REMARKS");;0;;3
"RTN","PSOR52",104,0)
 ;;PSOX("CLERK CODE");;0;;7
"RTN","PSOR52",105,0)
 ;;PSOX("COST");;0;;11
"RTN","PSOR52",106,0)
 ;;PSOSITE;;0;;9
"RTN","PSOR52",107,0)
 ;;PSOX("LOGIN DATE");;0;;8
"RTN","PSOR52",108,0)
 ;;PSOX("FILL DATE");;0;;1
"RTN","PSOR52",109,0)
 ;;PSOX("PHARMACIST");;0;;5
"RTN","PSOR52",110,0)
 ;;PSOX("LOT #");;0;;6
"RTN","PSOR52",111,0)
 ;;PSOX("DISPENSED DATE");;0;;19
"RTN","PSOR52",112,0)
 ;;PSOX("NDC");;0;;13
"RTN","PSOR52",113,0)
 ;;PSOX("MANUFACTURER");;0;;14
"RTN","PSOR52",114,0)
 ;;PSOX("EXPIRATION DATE");;0;;15
"RTN","PSOR52",115,0)
 ;;PSOX("GENERIC PROVIDER");;1;;1
"RTN","PSOR52",116,0)
 ;;PSOX("RELEASED DATE/TIME");;0;;18
"RTN","PSORXPA1")
0^5^B24712239
"RTN","PSORXPA1",1,0)
PSORXPA1 ;BIR/SAB - listman partial prescriptions ;07/14/93
"RTN","PSORXPA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**11,27,56,77,130,152,181**;DEC 1997
"RTN","PSORXPA1",3,0)
 ;External references L,UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSORXPA1",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSORXPA1",5,0)
 ;External reference to ^DD(52 supported by DBIA 999
"RTN","PSORXPA1",6,0)
 I $D(RXRP($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="A Reprint Label has been requested!" Q
"RTN","PSORXPA1",7,0)
 ;I $D(RXPR($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="A Partial has already been requested!" Q
"RTN","PSORXPA1",8,0)
 I $D(RXRS($P(PSOLST(ORN),"^",2))) S VALMBCK="",VALMSG="Rx is being pulled from suspense!" Q
"RTN","PSORXPA1",9,0)
 S PSORPDFN=+$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^",2)
"RTN","PSORXPA1",10,0)
 S PSOPLCK=$$L^PSSLOCK(PSORPDFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK,PSORPDFN D  Q
"RTN","PSORXPA1",11,0)
 .S VALMBCK=""
"RTN","PSORXPA1",12,0)
 K PSOPLCK D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D UL^PSSLOCK(PSORPDFN) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG,PSORPDFN Q
"RTN","PSORXPA1",13,0)
 I '$G(RXPR($P(PSOLST(ORN),"^",2))) S RX=$P(PSOLST(ORN),"^",2) D VALID^PSORXRP1 I $G(QFLG) S VALMBCK="",VALMSG="A New Label has been requested already!" K QFLG,RX D ULK Q
"RTN","PSORXPA1",14,0)
 D FULL^VALM1 I '$D(PSOPAR) D ^PSOLSET D:'$D(PSOPAR) ULK G:'$D(PSOPAR) KL
"RTN","PSORXPA1",15,0)
 S DA=$P(PSOLST(ORN),"^",2),RX0=^PSRX(DA,0),J=DA,RX2=$G(^(2)),R3=$G(^(3)) S:'$G(BBFLG) BBRX(1)=""
"RTN","PSORXPA1",16,0)
 I +$P($G(^PSRX(DA,2)),"^",6)<DT D
"RTN","PSORXPA1",17,0)
 .S:$P($G(^PSRX(DA,"STA")),"^")<12 $P(^PSRX(DA,"STA"),"^")=11
"RTN","PSORXPA1",18,0)
 .S COMM="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"/"_$E($P(^(2),"^",6),6,7)_"/"_$E($P(^(2),"^",6),2,3)
"RTN","PSORXPA1",19,0)
 .S STAT="SC",PHARMST="ZE" D EN^PSOHLSN1(DA,STAT,PHARMST,COMM) K STAT,PHARMST,COMM,RX0,J,RX2,R3
"RTN","PSORXPA1",20,0)
 ;I +$P($G(^PSRX(DA,2)),"^",6)<PSODTCUT D  K DA S VALMBCK="R" Q
"RTN","PSORXPA1",21,0)
 ;.S VALMSG="Medication Expired on "_$E($P(^PSRX(DA,2),"^",6),4,5)_"/"_$E($P(^(2),"^",6),6,7)_"/"_$E($P(^(2),"^",6),2,3)
"RTN","PSORXPA1",22,0)
 I +^PSRX(DA,"STA"),+^("STA")'=5,+^("STA")'=11 D  K DA S VALMBCK="R" D ULK Q
"RTN","PSORXPA1",23,0)
 .S C=";"_+^PSRX(DA,"STA")_":",X=$P(^DD(52,100,0),"^",3),E=$F(X,C),D=$P($E(X,E,999),";")
"RTN","PSORXPA1",24,0)
 .S VALMSG="Prescription is in a "_D_" status."
"RTN","PSORXPA1",25,0)
 I $G(PSXSYS),($O(^PS(52.5,"B",DA,""))) S PSOZ1=$O(^PS(52.5,"B",DA,"")) D
"RTN","PSORXPA1",26,0)
 .I $P($G(^PS(52.5,PSOZ1,0)),"^",7)="Q"!($P($G(^(0)),"^",7)="L") D
"RTN","PSORXPA1",27,0)
 ..W !!,"A partial entered for this Rx cannot be suspended."
"RTN","PSORXPA1",28,0)
 ..W !,"A fill for this Rx is already suspended for CMOP transmission."
"RTN","PSORXPA1",29,0)
 ..W !,"You may pull this fill from suspense or enter a partial and print the label.",!!
"RTN","PSORXPA1",30,0)
 ;..S PSOZZ=1 K PSOZ1
"RTN","PSORXPA1",31,0)
CLC S PSOCLC=DUZ,PHYS=$P(^PSRX(DA,0),"^",4),DRG=$P(^(0),"^",6)
"RTN","PSORXPA1",32,0)
 I 'PHYS,$O(^PSRX(DA,1,0)) F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S PHYS=$S($P(^PSRX(DA,1,I,0),"^",17):$P(^PSRX(DA,1,I,0),"^",17),1:PHYS)
"RTN","PSORXPA1",33,0)
 S PSOPRZ=0 I $O(^PSRX(DA,"P",0)) N Z2 F Z2=0:0 S Z2=$O(^PSRX(DA,"P",Z2)) Q:'Z2  S PSOPRZ=Z2
"RTN","PSORXPA1",34,0)
 K Z1,PRMK S PM=1,RXN=DA,RXF=6,DIE("NO^")="BACKOUTOK",DIE=52
"RTN","PSORXPA1",35,0)
 ;DR="[PSO PARTIAL]"
"RTN","PSORXPA1",36,0)
 S DR="K PM,PQ;60;Q;S:$O(Y(1))]""""!($G(PM)) Y=""@1"";35;@1;K PM;"
"RTN","PSORXPA1",37,0)
 S DR(2,52.2)=".01;S Z1=D1;.02;S:X=""M""!('$P($G(PSOPAR),U,12)) PM=1;.04;S:X=U PQ=1;.041R;S:X=U PQ=1;.05;.07////^S X=DUZ;6////^S X=PHYS;Q;.08///^S X=""NOW"";S PDT=X;.09////^S X=PSOSITE;.03;S:X=U PQ=1;S PRMK=X"
"RTN","PSORXPA1",38,0)
 D ^DIE
"RTN","PSORXPA1",39,0)
 G:'$G(Z1) CLCX
"RTN","PSORXPA1",40,0)
 I $G(PRMK)']"",Z1>PSOPRZ D ULK G KILL
"RTN","PSORXPA1",41,0)
 I Z1,$G(PRMK)]"" D  D:$T(EN^PSOHDR)]"" EN^PSOHDR("PPAR",RXN) K DIE,RXN,RXF
"RTN","PSORXPA1",42,0)
 .D ACT S:$P($G(^PSRX(RXN,"P",Z1,0)),"^",2)["W" PSODFN=$P(^PSRX(RXN,0),"^",2),BINGRTE="W",BBFLG=1,BBRX(1)=$G(BBRX(1))_RXN_","
"RTN","PSORXPA1",43,0)
 .S ZD(RXN)=+^PSRX(RXN,"P",Z1,0),^PSRX(RXN,"TYPE")=Z1,$P(^PSRX(RXN,"P",Z1,0),"^",11)=$P($G(^PSDRUG(DRG,660)),"^",6),RXF=6,RXP=Z1,RXPR(RXN)=RXP
"RTN","PSORXPA1",44,0)
 .;I $G(PSOZZ)=1,($G(Z1)) D Q1^PSORXL K Z1,PSOZZ Q
"RTN","PSORXPA1",45,0)
 .I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=RXN_"," Q
"RTN","PSORXPA1",46,0)
 .F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  Q:PSORX("PSOL",PSOX1)[RXN_","  S PSOX2=PSOX1
"RTN","PSORXPA1",47,0)
 .I PSOX1 Q
"RTN","PSORXPA1",48,0)
 .I $L(PSORX("PSOL",PSOX2))+$L(RXN)<220 S:PSORX("PSOL",PSOX2)'[RXN_"," PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_RXN_","
"RTN","PSORXPA1",49,0)
 .E  S PSORX("PSOL",PSOX2+1)=RXN_","
"RTN","PSORXPA1",50,0)
 S:'$D(PSOFROM) PSOFROM="PARTIAL" S BINGCRT=1 ;D:$D(BINGRTE)&($D(DISGROUP)) ^PSOBING1 K BINGRTE,TM,TM1
"RTN","PSORXPA1",51,0)
CLCX D ULK K DR,DIE,DRG,PPL,RXP,IOP,DA,PHYS,PSOPRZ S VALMBCK="R" Q
"RTN","PSORXPA1",52,0)
 ;
"RTN","PSORXPA1",53,0)
KILL S DA=Z1,DIK="^PSRX("_RXN_",""P""," D ^DIK S ^PSRX(RXN,"TYPE")=0
"RTN","PSORXPA1",54,0)
 D ULK S VALMSG="No Partial Fill Dispensed",VALMBCK="R" Q
"RTN","PSORXPA1",55,0)
KL K DFN,RFDAT,RLL,%,PRMK,PM,%Y,%X,D0,D1,DA,DI,DIC,DIE,DLAYGO,DQ,DR,I,II,J,JJJ,N,PHYS,PS,PSDATE,RFL,RFL1,RXF,ST,ST0,Z,Z1,X,Y,PDT,PSL,PSNP
"RTN","PSORXPA1",56,0)
 K PSOM,PSOP,PSOD,PSOU,DIK,DUOUT,IFN,RXN,DRG,HRX,I1,PSOCLC,PSOLIST,PSOLST,PSPAR,RXP D KVA^VADPT Q
"RTN","PSORXPA1",57,0)
ACT ;adds activity info for partial rx
"RTN","PSORXPA1",58,0)
 S RXF=0 F I=0:0 S I=$O(^PSRX(RXN,1,I)) Q:'I  S RXF=I S:I>5 RXF=I+1
"RTN","PSORXPA1",59,0)
 S DA=0 F FDA=0:0 S FDA=$O(^PSRX(RXN,"A",FDA)) Q:'FDA  S DA=FDA
"RTN","PSORXPA1",60,0)
 S DA=DA+1,^PSRX(RXN,"A",0)="^52.3DA^"_DA_"^"_DA,^PSRX(RXN,"A",DA,0)=DT_"^"_"P"_"^"_DUZ_"^"_RXF_"^"_PRMK
"RTN","PSORXPA1",61,0)
EX K RXF,I,FDA S DA=RXN
"RTN","PSORXPA1",62,0)
 Q
"RTN","PSORXPA1",63,0)
ULK ;
"RTN","PSORXPA1",64,0)
 D UL^PSSLOCK(+$G(PSORPDFN))
"RTN","PSORXPA1",65,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSORXPA1",66,0)
 K PSOMSG,PSOPLCK,PSORPDFN
"RTN","PSORXPA1",67,0)
 Q
"VER")
8.0^22.0
**END**
**END**
