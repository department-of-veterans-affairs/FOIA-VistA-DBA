Released XU*8*95 SEQ #81
Extracted from mail message
**KIDS**:XU*8.0*95^

**INSTALL NAME**
XU*8.0*95
"BLD",80,0)
XU*8.0*95^KERNEL^0^^y
"BLD",80,4,0)
^9.64PA^^
"BLD",80,"KRN",0)
^9.67PA^19^18
"BLD",80,"KRN",.4,0)
.4
"BLD",80,"KRN",.401,0)
.401
"BLD",80,"KRN",.402,0)
.402
"BLD",80,"KRN",.403,0)
.403
"BLD",80,"KRN",.5,0)
.5
"BLD",80,"KRN",.84,0)
.84
"BLD",80,"KRN",3.6,0)
3.6
"BLD",80,"KRN",3.8,0)
3.8
"BLD",80,"KRN",9.2,0)
9.2
"BLD",80,"KRN",9.8,0)
9.8
"BLD",80,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",80,"KRN",9.8,"NM",1,0)
XPDH^^0^B7253061
"BLD",80,"KRN",9.8,"NM",2,0)
XPDI1^^0^B15626193
"BLD",80,"KRN",9.8,"NM",3,0)
XPDIJ^^0^B31259019
"BLD",80,"KRN",9.8,"NM",4,0)
XPDIQ^^0^B20317556
"BLD",80,"KRN",9.8,"NM",5,0)
XPDTC^^0^B38050621
"BLD",80,"KRN",9.8,"NM","B","XPDH",1)

"BLD",80,"KRN",9.8,"NM","B","XPDI1",2)

"BLD",80,"KRN",9.8,"NM","B","XPDIJ",3)

"BLD",80,"KRN",9.8,"NM","B","XPDIQ",4)

"BLD",80,"KRN",9.8,"NM","B","XPDTC",5)

"BLD",80,"KRN",19,0)
19
"BLD",80,"KRN",19.1,0)
19.1
"BLD",80,"KRN",101,0)
101
"BLD",80,"KRN",409.61,0)
409.61
"BLD",80,"KRN",771,0)
771
"BLD",80,"KRN",869.2,0)
869.2
"BLD",80,"KRN",870,0)
870
"BLD",80,"KRN",8994,0)
8994
"BLD",80,"KRN","B",.4,.4)

"BLD",80,"KRN","B",.401,.401)

"BLD",80,"KRN","B",.402,.402)

"BLD",80,"KRN","B",.403,.403)

"BLD",80,"KRN","B",.5,.5)

"BLD",80,"KRN","B",.84,.84)

"BLD",80,"KRN","B",3.6,3.6)

"BLD",80,"KRN","B",3.8,3.8)

"BLD",80,"KRN","B",9.2,9.2)

"BLD",80,"KRN","B",9.8,9.8)

"BLD",80,"KRN","B",19,19)

"BLD",80,"KRN","B",19.1,19.1)

"BLD",80,"KRN","B",101,101)

"BLD",80,"KRN","B",409.61,409.61)

"BLD",80,"KRN","B",771,771)

"BLD",80,"KRN","B",869.2,869.2)

"BLD",80,"KRN","B",870,870)

"BLD",80,"KRN","B",8994,8994)

"BLD",80,"QUES",0)
^9.62^^
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
95
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","XPDH")
0^1^B7253061
"RTN","XPDH",1,0)
XPDH ;SFISC/XAK,RSD - help for answering install questions ;08/17/98  13:33
"RTN","XPDH",2,0)
 ;;8.0;KERNEL;**58,95**;Jul 10, 1995
"RTN","XPDH",3,0)
REP ;changing your file name
"RTN","XPDH",4,0)
 W !!?5,"If YES, then the incoming file name and Data Dictionary will"
"RTN","XPDH",5,0)
 W !?5,"overwrite the existing file ",FLAG,"."
"RTN","XPDH",6,0)
 W !!?5,"If NO, then the Install Process will abort.",!
"RTN","XPDH",7,0)
 Q
"RTN","XPDH",8,0)
DTA ;help for adding data
"RTN","XPDH",9,0)
 W !!?5,"YES means that the data coming in with this INSTALL process"
"RTN","XPDH",10,0)
 W !?5,"will ",FLAG," the data on file if a match is found."
"RTN","XPDH",11,0)
 W !!?5,"Entries will be added if they do not match exactly"
"RTN","XPDH",12,0)
 W !?5,"on Name and Identifiers."
"RTN","XPDH",13,0)
 W !!?5,"NO means that everything will be left as is."
"RTN","XPDH",14,0)
 Q
"RTN","XPDH",15,0)
OPT ;disable options
"RTN","XPDH",16,0)
 W !!?5,"YES means you want to mark Options and Protocols out of"
"RTN","XPDH",17,0)
 W !?5,"order during the Install Process."
"RTN","XPDH",18,0)
 W !!?5,"NO means no action will be taken."
"RTN","XPDH",19,0)
 Q
"RTN","XPDH",20,0)
RTN ;moving routines
"RTN","XPDH",21,0)
 W !!?5,"YES means you want to update the routines on other CPUs"
"RTN","XPDH",22,0)
 W !?5,"during the Install Process.  This will work only if Taskman"
"RTN","XPDH",23,0)
 W !?5,"is running during the Install Process."
"RTN","XPDH",24,0)
 W !!?5,"NO means that only routines on this CPU will be updated."
"RTN","XPDH",25,0)
 Q
"RTN","XPDH",26,0)
MSG ;creating a Packman message
"RTN","XPDH",27,0)
 W !!?5,"YES means that you are going to send this Package over"
"RTN","XPDH",28,0)
 W !?5,"the Network as a message."
"RTN","XPDH",29,0)
 W !?5,"NO means that a Transport Global will be created."
"RTN","XPDH",30,0)
 Q
"RTN","XPDH",31,0)
MG ;adding Coordinator to a Mail Group
"RTN","XPDH",32,0)
 W !!?5,"Enter the person responsible for maintaining the membership"
"RTN","XPDH",33,0)
 W !?5,"of the incoming Mail Group.  The person must exist in the"
"RTN","XPDH",34,0)
 W !?5,"New Person file, #200.  This person will be the coordinator"
"RTN","XPDH",35,0)
 W !?5,"only if this Mail Group is new on your system."
"RTN","XPDH",36,0)
 Q
"RTN","XPDH",37,0)
MENU ;rebuild menu trees if an Option was added
"RTN","XPDH",38,0)
 W !!?5,"YES means that KIDS will run the Menu Trees rebuild routines"
"RTN","XPDH",39,0)
 W !?5,"as part of the installation at the end."
"RTN","XPDH",40,0)
 W !?5,"NO means that the Menu Trees will not be rebuilt."
"RTN","XPDH",41,0)
 W !?5,"It is highly recommended that you rebuild Menu Trees"
"RTN","XPDH",42,0)
 W !?5,"immediately whenever KIDS adds an Option."
"RTN","XPDH",43,0)
 Q
"RTN","XPDI1")
0^2^B15626193
"RTN","XPDI1",1,0)
XPDI1 ;SFISC/RSD - Cont of Install Process ;08/17/98  13:34
"RTN","XPDI1",2,0)
 ;;8.0;KERNEL;**58,61,95**;Jul 10, 1995
"RTN","XPDI1",3,0)
 ;lookup into file 9.7, XPDS=DIC("S") for lookup
"RTN","XPDI1",4,0)
 ;return 0-fail or ien, XPDT=array of linked builds
"RTN","XPDI1",5,0)
LOOK(XPDS) ;lookup Install
"RTN","XPDI1",6,0)
 N DIC,Y,XPD,XPDIT,%
"RTN","XPDI1",7,0)
 S DIC(0)="QEAMZ",DIC="^XPD(9.7,"
"RTN","XPDI1",8,0)
 S:$L($G(XPDS)) DIC("S")=XPDS
"RTN","XPDI1",9,0)
 D ^DIC Q:Y<0 0
"RTN","XPDI1",10,0)
 L +^XPD(9.7,+Y,0):0 E  W !,"Being accessed by another user" Q 0
"RTN","XPDI1",11,0)
 S XPD=+Y,XPDIT=0
"RTN","XPDI1",12,0)
 W !!,"This Distribution was loaded on ",$$FMTE^XLFDT($P(Y(0),U,3))," with header of ",!,$G(^XPD(9.7,XPD,2)),!,"It consisted of the following Install(s):",!
"RTN","XPDI1",13,0)
 ;build XPDT array
"RTN","XPDI1",14,0)
 F  S XPDIT=$O(^XPD(9.7,"ASP",XPD,XPDIT)) Q:'XPDIT  S Y=+$O(^(XPDIT,0)) D
"RTN","XPDI1",15,0)
 .S %=$P($G(^XPD(9.7,Y,0)),U)
"RTN","XPDI1",16,0)
 .I %="" W "**ERROR in Install, You need to remove the Distribution and reload it**",!  S XPDQUIT=1 Q
"RTN","XPDI1",17,0)
 .S XPDT(XPDIT)=Y_U_%,(XPDT("DA",Y),XPDT("NM",%))=XPDIT W %,!
"RTN","XPDI1",18,0)
 I '$O(XPDT(0)) S XPDQUIT=1 D QUIT(XPD)
"RTN","XPDI1",19,0)
 Q XPD
"RTN","XPDI1",20,0)
 ;
"RTN","XPDI1",21,0)
QUIT(Y) ;unlock ien Y
"RTN","XPDI1",22,0)
 L -^XPD(9.7,+Y) Q
"RTN","XPDI1",23,0)
 ;
"RTN","XPDI1",24,0)
QUES(XPDA) ;install questions; XPDA=ien in file 9.7
"RTN","XPDI1",25,0)
 N XPDANS,XPDFIL,XPDFILN,XPDFILO,XPDFLG,XPDNM,XPDQUES,X,Y
"RTN","XPDI1",26,0)
 S XPDNM=$P(^XPD(9.7,XPDA,0),U) W !!,"Install Questions for ",XPDNM,!
"RTN","XPDI1",27,0)
 ;pre-init questions
"RTN","XPDI1",28,0)
 D DIR^XPDIQ("PRE") I $D(XPDQUIT) D ASKABRT^XPDI Q
"RTN","XPDI1",29,0)
 ;file install questions
"RTN","XPDI1",30,0)
 S (XPDFIL,XPDFLG)=0
"RTN","XPDI1",31,0)
 F  S XPDFIL=$O(^XTMP("XPDI",XPDA,"FIA",XPDFIL)) Q:'XPDFIL  S X=^(XPDFIL),X(0)=^(XPDFIL,0),X(1)=^(XPDFIL),XPDFILO=^(0,1) D  Q:$D(XPDQUIT)
"RTN","XPDI1",32,0)
 .;check for DD screening logic
"RTN","XPDI1",33,0)
 .I $G(^(10))]"" N XPDSCR S XPDSCR=^(10) ;^(10) is ref to ^XTMP("XPDI",XPDA,"FIA",XPDFIL,0,10) from prev line
"RTN","XPDI1",34,0)
 .;XPDFILN=file name^global ref^partial DD
"RTN","XPDI1",35,0)
 .;XPDANS=new file^DD screen failed^Data exists^update file name^user
"RTN","XPDI1",36,0)
 .;doesn't want to update data  1=yes,0=no
"RTN","XPDI1",37,0)
 .S XPDFILN=X_X(0)_U_X(1),XPDANS='($D(^DIC(XPDFIL,0))#2)_"^^"_''$O(@(X(0)_"0)"))
"RTN","XPDI1",38,0)
 .I 'XPDFLG W !,"Incoming Files:" S XPDFLG=1
"RTN","XPDI1",39,0)
 .W ! D DIR^XPDIQ("XPF",XPDFIL_"#") Q:$D(XPDQUIT)
"RTN","XPDI1",40,0)
 .S:$G(XPDQUES("XPF"_XPDFIL_"#2"))=0 $P(XPDANS,U,5)=1
"RTN","XPDI1",41,0)
 .S ^XTMP("XPDI",XPDA,"FIA",XPDFIL,0,2)=XPDANS
"RTN","XPDI1",42,0)
 .;kill the answers so we can re-ask for next file
"RTN","XPDI1",43,0)
 .F I=1:1:2 K XPDQUES("XPF"_XPDFIL_"#"_I)
"RTN","XPDI1",44,0)
 ;XPDQUIT is by file questions in previous do loop, set in XPDIQ
"RTN","XPDI1",45,0)
 I $D(XPDQUIT) D ASKABRT^XPDI Q
"RTN","XPDI1",46,0)
 ;ask for coordinators to incoming mail groups
"RTN","XPDI1",47,0)
 S (XPDFIL,XPDFLG)=0
"RTN","XPDI1",48,0)
 F  S XPDFIL=$O(^XTMP("XPDI",XPDA,"KRN",3.8,XPDFIL)) Q:'XPDFIL  S X=^(XPDFIL,0) D  Q:$D(XPDQUIT)
"RTN","XPDI1",49,0)
 .;XPDANS=Mail Group name
"RTN","XPDI1",50,0)
 .S XPDANS=$P(X,U)
"RTN","XPDI1",51,0)
 .I 'XPDFLG W !!,"Incoming Mail Groups:" S XPDFLG=1
"RTN","XPDI1",52,0)
 .W ! D DIR^XPDIQ("XPM",XPDFIL_"#") Q:$D(XPDQUIT)
"RTN","XPDI1",53,0)
 .;kill the answers so we can re-ask for next MG
"RTN","XPDI1",54,0)
 .K XPDQUES("XPM"_XPDFIL_"#1")
"RTN","XPDI1",55,0)
 .Q
"RTN","XPDI1",56,0)
 I $D(XPDQUIT) D ASKABRT^XPDI Q
"RTN","XPDI1",57,0)
 ;ask to rebuild menus if Option is added
"RTN","XPDI1",58,0)
 S (XPDFIL,XPDFLG)=0
"RTN","XPDI1",59,0)
 S XPDFIL=$O(^XTMP("XPDI",XPDA,"KRN",19,XPDFIL))  D:XPDFIL
"RTN","XPDI1",60,0)
 .S X=^XTMP("XPDI",XPDA,"KRN",19,XPDFIL,0)
"RTN","XPDI1",61,0)
 .;XPDANS=Menu Rebuild Answer
"RTN","XPDI1",62,0)
 .S XPDANS=$P(X,U)
"RTN","XPDI1",63,0)
 .W ! D DIR^XPDIQ("XPO") Q:$D(XPDQUIT)
"RTN","XPDI1",64,0)
 I $D(XPDQUIT) D ASKABRT^XPDI Q
"RTN","XPDI1",65,0)
 ;post-init questions
"RTN","XPDI1",66,0)
 W ! D DIR^XPDIQ("POS") I $D(DIRUT)!$D(XPDQUIT) D ASKABRT^XPDI Q
"RTN","XPDI1",67,0)
 Q
"RTN","XPDI1",68,0)
 ;
"RTN","XPDI1",69,0)
XQSET(XPDA) ;get options & protocols to disable
"RTN","XPDI1",70,0)
 ;put in ^TMP($J,"XQOO",starting build name)
"RTN","XPDI1",71,0)
 N A,I,X,Y
"RTN","XPDI1",72,0)
 S I=0 F  S I=$O(^XTMP("XPDI",XPDA,"KRN",19,I)) Q:'I  S X=^(I,0),A=^(-1) D
"RTN","XPDI1",73,0)
 .S Y=$O(^DIC(19,"B",$P(X,U),0))
"RTN","XPDI1",74,0)
 .;check that option exist and 0=send,1=delete,3=merge or 5=disable
"RTN","XPDI1",75,0)
 .I Y,$D(^DIC(19,Y,0)),$S('A:1,1:A#2) S ^TMP($J,"XQOO",XPDSET,19,Y)=$P(^(0),U,1,2)
"RTN","XPDI1",76,0)
 S I=0 F  S I=$O(^XTMP("XPDI",XPDA,"KRN",101,I)) Q:'I  S X=^(I,0),A=^(-1) D
"RTN","XPDI1",77,0)
 .S Y=$O(^ORD(101,"B",$P(X,U),0))
"RTN","XPDI1",78,0)
 .I Y,$D(^ORD(101,Y,0)),$S(A=3:1,A=5:1,1:'A) S ^TMP($J,"XQOO",XPDSET,101,Y)=$P(^(0),U,1,2)
"RTN","XPDI1",79,0)
 Q
"RTN","XPDI1",80,0)
 ;XPDIJ need to install XPDIJ now & set routine flag to skip
"RTN","XPDI1",81,0)
XPDIJ N DIE,XPDA,XCM,XCN,XCS,X
"RTN","XPDI1",82,0)
 S XPDA=XPDIJ,DIE="^XTMP(""XPDI"",XPDIJ,""RTN"",""XPDIJ"",",XCN=0,X="XPDIJ"
"RTN","XPDI1",83,0)
 X ^%ZOSF("SAVE")
"RTN","XPDI1",84,0)
 S XCN=$$RTNUP^XPDUTL("XPDIJ",2)
"RTN","XPDI1",85,0)
 Q
"RTN","XPDIJ")
0^3^B31259019
"RTN","XPDIJ",1,0)
XPDIJ ;SFISC/RSD - Install Job ;08/17/98  13:34
"RTN","XPDIJ",2,0)
 ;;8.0;KERNEL;**2,21,28,41,44,68,81,95**;Jul 10, 1995
"RTN","XPDIJ",3,0)
EN ;install all packages
"RTN","XPDIJ",4,0)
 ;XPDA=ien of first package
"RTN","XPDIJ",5,0)
 ;this is needed to restore XPDIJ1
"RTN","XPDIJ",6,0)
 I $D(^XTMP("XPDI",XPDA,"RTN","XPDIJ1")) D
"RTN","XPDIJ",7,0)
 .N DIE,XCM,XCN,XCS,X
"RTN","XPDIJ",8,0)
 .S DIE="^XTMP(""XPDI"",XPDA,""RTN"",""XPDIJ1"",",XCN=0,X="XPDIJ1"
"RTN","XPDIJ",9,0)
 .X ^%ZOSF("SAVE")
"RTN","XPDIJ",10,0)
 .S XCN=$$RTNUP^XPDUTL("XPDIJ1",2)
"RTN","XPDIJ",11,0)
 N IEN,XPDI,XPD0,XPDSET,XPDABORT,XPDMENU,XPDQUIT,XPDVOL,X,Y,ZTRTN,ZTDTH,ZTIO,ZTDESC,ZTSK
"RTN","XPDIJ",12,0)
 I $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^XPDIJ"
"RTN","XPDIJ",13,0)
 E  S X="ERR^XPDIJ",@^%ZOSF("TRAP")
"RTN","XPDIJ",14,0)
 Q:'$D(^XPD(9.7,+$G(XPDA),0))  S XPD0=^(0)
"RTN","XPDIJ",15,0)
 D INIT^XPDID
"RTN","XPDIJ",16,0)
 ;disable options & protocols for setname, XPDSET=1/0^setname^out of order msg.
"RTN","XPDIJ",17,0)
 S Y=$P(XPD0,U,8),XPDSET=+Y_U_$E(Y,2,99)_U_$S($L(Y):$P($G(^XTMP("XQOO",$E(Y,2,99),0)),U),1:"")
"RTN","XPDIJ",18,0)
 ;hang the number of seconds given in 0;10
"RTN","XPDIJ",19,0)
 I XPDSET D OFF^XQOO1($P(XPDSET,U,2)) I $P(XPD0,U,10) H ($P(XPD0,U,10)*60)
"RTN","XPDIJ",20,0)
 ;XPDVOL is set only if they want to update other CPUs
"RTN","XPDIJ",21,0)
 I $O(^XPD(9.7,XPDA,"VOL",0)) M XPDVOL=^XPD(9.7,XPDA,"VOL") D
"RTN","XPDIJ",22,0)
 .S Y=0
"RTN","XPDIJ",23,0)
 .F  S Y=$O(XPDVOL(Y)) Q:'Y  S $P(XPDVOL(Y,0),U,2,3)="^" K XPDVOL(Y,1)
"RTN","XPDIJ",24,0)
 .;jobup RTN^XPDIJ(XPDA), to install routines on other CPU if Taskman is running
"RTN","XPDIJ",25,0)
 .;check that taskman is running
"RTN","XPDIJ",26,0)
 .D:$$TM^%ZTLOAD
"RTN","XPDIJ",27,0)
 ..N XPDU,XPDY,XPDV,XPDV0,XPDVOL,ZTUCI,ZTCPU,ZTDESC,ZTRTN,ZTDTH,ZTIO,ZTSK
"RTN","XPDIJ",28,0)
 ..X ^%ZOSF("UCI") S XPDU=$P(Y,","),XPDY=$P(Y,",",2),XPDV=0
"RTN","XPDIJ",29,0)
 ..F  S XPDV=$O(^XPD(9.7,XPDA,"VOL",XPDV)) Q:'XPDV  S XPDV0=$P(^(XPDV,0),U) D:XPDV0'=XPDY
"RTN","XPDIJ",30,0)
 ...S ZTUCI=XPDU,ZTDTH=$H,ZTIO="",ZTDESC="KIDS update CPUs "_XPDV0,ZTCPU=XPDV0,ZTRTN="EN^XPDCPU("_XPDA_","_XPDV_")"
"RTN","XPDIJ",31,0)
 ...D ^%ZTLOAD
"RTN","XPDIJ",32,0)
 ...;save task number under Volume set multiple
"RTN","XPDIJ",33,0)
 ...Q:'$G(ZTSK)  K XPD
"RTN","XPDIJ",34,0)
 ...S XPD(9.703,XPDV_","_XPDA_",",3)=ZTSK D FILE^DIE("","XPD")
"RTN","XPDIJ",35,0)
 S Y=0
"RTN","XPDIJ",36,0)
 ;XPDABORT can be set in pre or post install to abort install
"RTN","XPDIJ",37,0)
 F  S Y=$O(^XPD(9.7,"ASP",XPDA,Y)) Q:'Y  S %=$O(^(Y,0)) D:%  Q:$D(XPDABORT)
"RTN","XPDIJ",38,0)
 .;build volume multiple for each package
"RTN","XPDIJ",39,0)
 .I $D(XPDVOL),'$D(^XPD(9.7,%,"VOL")) M ^("VOL")=XPDVOL
"RTN","XPDIJ",40,0)
 .N XPD,XPDA,XPDNM,XPDV,XPDV0,XPDVOL,XPDX,XPDY,Y
"RTN","XPDIJ",41,0)
 .S XPDA=%,XPDNM=$P($G(^XPD(9.7,XPDA,0)),U) D IN^XPDIJ1 Q:$D(XPDABORT)
"RTN","XPDIJ",42,0)
 .;check status of other cpu jobs, do if not this volume
"RTN","XPDIJ",43,0)
 .X ^%ZOSF("UCI") S XPDY=$P(Y,",",2),XPDV=0
"RTN","XPDIJ",44,0)
 .F  S XPDV=$O(^XPD(9.7,XPDA,"VOL",XPDV)) Q:'XPDV  S XPDV0=^(XPDV,0) D:$P(XPDV0,U)'=XPDY
"RTN","XPDIJ",45,0)
 ..;if completed time,write message and quit
"RTN","XPDIJ",46,0)
 ..I $P(XPDV0,U,2) D BMES^XPDUTL(" Job on VOLUME SET "_$P(XPDV0,U)_" Completed.") Q
"RTN","XPDIJ",47,0)
 ..;if job had no start time, write message and quit
"RTN","XPDIJ",48,0)
 ..I '$P(XPDV0,U,3) D  I '$P(XPDV0,U,3)  D VOLERR($P(XPDV0,U),1) Q
"RTN","XPDIJ",49,0)
 ...D BMES^XPDUTL(" Waiting for job on VOLUME SET "_$P(XPDV0,U)_" to start.")
"RTN","XPDIJ",50,0)
 ...;hang 1 minute, try 5 times
"RTN","XPDIJ",51,0)
 ...F %=1:1:5 H 60 S XPDV0=^XPD(9.7,XPDA,"VOL",XPDV,0) Q:$P(XPDV0,U,3)
"RTN","XPDIJ",52,0)
 ..D BMES^XPDUTL(" Waiting for job on VOLUME SET "_$P(XPDV0,U)_" to complete.")
"RTN","XPDIJ",53,0)
 ..S XPD=0,XPDX=$G(^XPD(9.7,XPDA,"VOL",XPDV,1))
"RTN","XPDIJ",54,0)
 ..;check the last update node
"RTN","XPDIJ",55,0)
 ..F  S Y=$P(^XPD(9.7,XPDA,"VOL",XPDV,0),U,2),X=$G(^(1)),XPD=XPD+1 Q:XPD>360!Y  S:X'=XPDX XPD=0,XPDX=X H 10
"RTN","XPDIJ",56,0)
 ..;quit if we have a complete time
"RTN","XPDIJ",57,0)
 ..I Y D BMES^XPDUTL(" Job on VOLUME SET "_$P(XPDV0,U)_" Completed.") Q
"RTN","XPDIJ",58,0)
 ..D VOLERR($P(XPDV0,U),0)
"RTN","XPDIJ",59,0)
 ;ZTREQ tells taskman to delete task
"RTN","XPDIJ",60,0)
 I $G(ZTSK) S ZTREQ="@" D
"RTN","XPDIJ",61,0)
 .;remove task # from Install File
"RTN","XPDIJ",62,0)
 .N XPD S XPD(9.7,XPDA_",",5)="@"
"RTN","XPDIJ",63,0)
 .D FILE^DIE("","XPD")
"RTN","XPDIJ",64,0)
 ;quit if install was aborted
"RTN","XPDIJ",65,0)
 I $D(XPDABORT) D EXIT^XPDID("Install Aborted!!"),^%ZISC Q
"RTN","XPDIJ",66,0)
 ;put option back in order
"RTN","XPDIJ",67,0)
 I $P(XPDSET,U,2)]"" D ON^XQOO1($P(XPDSET,U,2)) K ^XTMP("XQOO",$P(XPDSET,U,2))
"RTN","XPDIJ",68,0)
 ;check if menu rebuild is wanted (only if option has been added)
"RTN","XPDIJ",69,0)
 S IEN=""
"RTN","XPDIJ",70,0)
 S IEN=$O(^XPD(9.7,XPDA,"QUES","B","XPO1",IEN))
"RTN","XPDIJ",71,0)
 D:IEN
"RTN","XPDIJ",72,0)
 .I ^XPD(9.7,XPDA,"QUES",IEN,1)  D
"RTN","XPDIJ",73,0)
 ..D KIDS^XQ81
"RTN","XPDIJ",74,0)
 ..;check if need to queue menu rebuild on other CPUs
"RTN","XPDIJ",75,0)
 ..D:$O(^XPD(9.7,XPDA,"VOL",0))
"RTN","XPDIJ",76,0)
 ...N XPDU,XPDY,XPDV,XPDV0,ZTUCI,ZTCPU
"RTN","XPDIJ",77,0)
 ...X ^%ZOSF("UCI") S XPDU=$P(Y,","),XPDY=$P(Y,",",2),XPDV=0
"RTN","XPDIJ",78,0)
 ...;loop thru VOLUMES SET and don't do current volume set
"RTN","XPDIJ",79,0)
 ...F  S XPDV=$O(^XPD(9.7,XPDA,"VOL",XPDV)) Q:'XPDV  S XPDV0=$P(^(XPDV,0),U) D:XPDV0'=XPDY
"RTN","XPDIJ",80,0)
 ....S ZTUCI=XPDU,ZTDTH=$H,ZTIO="",ZTDESC="Install Menu Rebuild",ZTCPU=XPDV0,ZTRTN="KIDS^XQ81" D ^%ZTLOAD
"RTN","XPDIJ",81,0)
 ;
"RTN","XPDIJ",82,0)
 ;clean up globals
"RTN","XPDIJ",83,0)
 S Y=0
"RTN","XPDIJ",84,0)
 F  S Y=$O(^XPD(9.7,"ASP",XPDA,Y)) Q:'Y  S XPDI=$O(^(Y,0)) D:XPDI
"RTN","XPDIJ",85,0)
 .N Y,XPD
"RTN","XPDIJ",86,0)
 .;kill transport global
"RTN","XPDIJ",87,0)
 .K ^XTMP("XPDI",XPDI)
"RTN","XPDIJ",88,0)
 .;update the status field
"RTN","XPDIJ",89,0)
 .S XPD(9.7,XPDI_",",.02)=3
"RTN","XPDIJ",90,0)
 .D FILE^DIE("","XPD")
"RTN","XPDIJ",91,0)
 D EXIT^XPDID("Install Completed"),^%ZISC
"RTN","XPDIJ",92,0)
 Q
"RTN","XPDIJ",93,0)
 ;
"RTN","XPDIJ",94,0)
SAVE(X) ;restore routine X
"RTN","XPDIJ",95,0)
 N %,DIE,XCM,XCN,XCS
"RTN","XPDIJ",96,0)
 S DIE="^XTMP(""XPDI"",XPDA,""RTN"",X,",XCN=0
"RTN","XPDIJ",97,0)
 X ^%ZOSF("SAVE")
"RTN","XPDIJ",98,0)
 Q
"RTN","XPDIJ",99,0)
RTN(XPDA) ;restore all routines for package XPDA
"RTN","XPDIJ",100,0)
 ;^XPD("XPDI",XPDA,"RTN",routine name)=0-install, 1-delete, 2-skip^checksum
"RTN","XPDIJ",101,0)
 Q:$G(XPDA)=""
"RTN","XPDIJ",102,0)
 N X,XPDI,XPDJ S XPDI=""
"RTN","XPDIJ",103,0)
 F  S XPDI=$O(^XTMP("XPDI",XPDA,"RTN",XPDI)) Q:XPDI=""  S XPDJ=^(XPDI) D
"RTN","XPDIJ",104,0)
 .;if we are doing VT graphic display, set counter
"RTN","XPDIJ",105,0)
 .I $D(XPDIDVT) S XPDIDCNT=XPDIDCNT+1 D:'(XPDIDCNT#XPDIDMOD) UPDATE^XPDID(XPDIDCNT)
"RTN","XPDIJ",106,0)
 .I 'XPDJ D SAVE(XPDI) Q
"RTN","XPDIJ",107,0)
 .;set checksum to null, since routine wasn't loaded
"RTN","XPDIJ",108,0)
 .I $P(XPDJ,U,2) S $P(^XTMP("XPDI",XPDA,"BLD",XPDBLD,"KRN",9.8,"NM",$P(XPDJ,U,2),0),U,4)=""
"RTN","XPDIJ",109,0)
 .I $P(XPDJ,U)=1 S X=XPDI X ^%ZOSF("DEL")
"RTN","XPDIJ",110,0)
 ;if graphic display, update full count
"RTN","XPDIJ",111,0)
 I $D(XPDIDVT) D UPDATE^XPDID(XPDIDCNT)
"RTN","XPDIJ",112,0)
 Q
"RTN","XPDIJ",113,0)
 ;
"RTN","XPDIJ",114,0)
VOLERR(V,F) ;volume set not updated,V=volume set, F=flag
"RTN","XPDIJ",115,0)
 N XQA,XQAMSG,XPDMES
"RTN","XPDIJ",116,0)
 S XPDMES(1)=" ",XPDMES(2)=" ** Job on VOLUME SET "_V_$S(F:" never started **",1:" has been idle for an hour.")
"RTN","XPDIJ",117,0)
 S XPDMES(3)=" ** "_V_" has NOT been updated! **"
"RTN","XPDIJ",118,0)
 S XQA(DUZ)="",XQAMSG="VOLUME SET "_V_" NOT updated for Install "_$E($P($G(^XPD(9.7,+$G(XPDA),0)),"^"),1,30)
"RTN","XPDIJ",119,0)
 D MES^XPDUTL(.XPDMES),SETUP^XQALERT
"RTN","XPDIJ",120,0)
 Q
"RTN","XPDIJ",121,0)
 ;come here on error, record error in Install file and cleanup var.
"RTN","XPDIJ",122,0)
ERR N XPDERROR,XQA,XQAMSG
"RTN","XPDIJ",123,0)
 S XPDERROR=$$EC^%ZOSV
"RTN","XPDIJ",124,0)
 ;record error, write message, reset terminal
"RTN","XPDIJ",125,0)
 D ^%ZTER,BMES^XPDUTL(XPDERROR),EXIT^XPDID()
"RTN","XPDIJ",126,0)
 S XQA(DUZ)="",XQAMSG="Install "_$E($P($G(^XPD(9.7,+$G(XPDA),0)),"^"),1,30)_" has encountered an Error."
"RTN","XPDIJ",127,0)
 D SETUP^XQALERT G UNWIND^%ZTER
"RTN","XPDIQ")
0^4^B20317556
"RTN","XPDIQ",1,0)
XPDIQ ;SFISC/RSD - Install Questions ;08/17/98  13:33
"RTN","XPDIQ",2,0)
 ;;8.0;KERNEL;**21,28,58,61,95**;Jul 10, 1995
"RTN","XPDIQ",3,0)
 Q
"RTN","XPDIQ",4,0)
DIR(XPFR,XPFP) ;XPFR=prefix, XPFP=file no._# or Mail Group ien
"RTN","XPDIQ",5,0)
 ;XPFP is for XPF  or XPM questions
"RTN","XPDIQ",6,0)
 N DIR,DR,XPDI,XPDJ,X,Y,Z
"RTN","XPDIQ",7,0)
 S XPFP=$G(XPFP),XPDI=$S(XPFP:XPFR_XPFP,1:XPFR)
"RTN","XPDIQ",8,0)
 D QUES(XPDI)
"RTN","XPDIQ",9,0)
 ;ask questions
"RTN","XPDIQ",10,0)
 S X=XPFR
"RTN","XPDIQ",11,0)
 F  S X=$O(^XTMP("XPDI",XPDA,"QUES",X)),Z="" Q:X=""!($P(X,XPFR)]"")  D  I $D(DIRUT) S XPDQUIT=1 Q
"RTN","XPDIQ",12,0)
 .S XPDJ=$S('XPFP:X,1:XPDI_$P(X,XPFR,2))
"RTN","XPDIQ",13,0)
 .F  S Z=$O(^XTMP("XPDI",XPDA,"QUES",X,Z)) Q:Z=""  M DIR(Z)=^(Z)
"RTN","XPDIQ",14,0)
 .;if there was a previous answer, reset DIR("B") to external or internal answer
"RTN","XPDIQ",15,0)
 .S:$L($G(XPDQUES(XPDJ))) DIR("B")=$G(XPDQUES(XPDJ,"B"),XPDQUES(XPDJ)) D  Q:'$D(Y)
"RTN","XPDIQ",16,0)
 ..N FLAG,X,Z K Y
"RTN","XPDIQ",17,0)
 ..;this is the M CODE node that was set to DIR("M") in prev for loop
"RTN","XPDIQ",18,0)
 ..;FLAG is used by KIDS questions
"RTN","XPDIQ",19,0)
 ..I $D(DIR("M")) S %=DIR("M"),FLAG="" K DIR("M") X %
"RTN","XPDIQ",20,0)
 ..Q:'$D(DIR)
"RTN","XPDIQ",21,0)
 ..;'|' is used to mark variable in prompt, reset prompt with value of variable
"RTN","XPDIQ",22,0)
 ..S:$G(DIR("A"))["|" DIR("A")=$P(DIR("A"),"|")_@$P(DIR("A"),"|",2)_$P(DIR("A"),"|",3)
"RTN","XPDIQ",23,0)
 ..K:$G(DIR("B"))="" DIR("B")
"RTN","XPDIQ",24,0)
 ..D ^DIR
"RTN","XPDIQ",25,0)
 .S %=$P(DIR(0),U)
"RTN","XPDIQ",26,0)
 .;read was optional and didn't timeout and user didn't enter anything
"RTN","XPDIQ",27,0)
 .I %["O",'$D(DTOUT),$S(%["P":Y=-1,1:Y="") K DIRUT Q
"RTN","XPDIQ",28,0)
 .;quit if the user up-arrowed out
"RTN","XPDIQ",29,0)
 .Q:$D(DIRUT)
"RTN","XPDIQ",30,0)
 .;if pointer, reset Y & Y(0)
"RTN","XPDIQ",31,0)
 .I %["P" S Y(0)=$S(%["Z":$P(Y(0),U),1:$P(Y,U,2)),Y=+Y
"RTN","XPDIQ",32,0)
 .;if Y(0) is not defined, but Y is
"RTN","XPDIQ",33,0)
 .S:$D(Y)#2&'($D(Y(0))#2) Y(0)=Y
"RTN","XPDIQ",34,0)
 .S XPDQUES(XPDJ)=Y,XPDQUES(XPDJ,"A")=$G(DIR("A")),XPDQUES(XPDJ,"B")=$G(Y(0))
"RTN","XPDIQ",35,0)
 .K DIR
"RTN","XPDIQ",36,0)
 K XPDJ S XPDI=XPFR
"RTN","XPDIQ",37,0)
 ;code to save XPDQUES to INSTALL ANSWERS in file 9.7, loop thru the answers starting with the from value, XPFR
"RTN","XPDIQ",38,0)
 F Y=1:1 S XPDI=$O(XPDQUES(XPDI)) Q:XPDI=""!($P(XPDI,XPFR)]"")  D
"RTN","XPDIQ",39,0)
 .S X="XPDJ(9.701,""?+"_Y_","_XPDA_","")",@X@(.01)=XPDI,@X@(1)=$G(XPDQUES(XPDI,"A")),@X@(2)=$G(XPDQUES(XPDI,"B")),@X@(3)=XPDQUES(XPDI)
"RTN","XPDIQ",40,0)
 K XPDI D:$D(XPDJ)>9 UPDATE^DIE("","XPDJ","XPDI")
"RTN","XPDIQ",41,0)
 Q
"RTN","XPDIQ",42,0)
 ;
"RTN","XPDIQ",43,0)
QUES(X) ;build XPDQUES array, X="INI","INIT","XPF","XPM"
"RTN","XPDIQ",44,0)
 ;move INSTALL ANSWERS from file 9.7 to XPDQUES
"RTN","XPDIQ",45,0)
 ;XPDQUES(X)=internal answer, XPDQUES(X,"A")=prompt, XPDQUES(X,"B")=external answer.
"RTN","XPDIQ",46,0)
 N Y,Z K XPDQUES S Z=X
"RTN","XPDIQ",47,0)
 F  S Z=$O(^XPD(9.7,XPDA,"QUES","B",Z)) Q:Z=""!($P(Z,X)]"")  S Y=$O(^(Z,0)) D
"RTN","XPDIQ",48,0)
 .Q:'$D(^XPD(9.7,XPDA,"QUES",Y,0))
"RTN","XPDIQ",49,0)
 .S XPDQUES(Z)=$G(^(1)),XPDQUES(Z,"A")=$G(^("A")),XPDQUES(Z,"B")=$G(^("B")) ; ^(1) refer to prev line ^XPD(9.7,XPDA,"QUES","B",Z)
"RTN","XPDIQ",50,0)
 Q
"RTN","XPDIQ",51,0)
 ;codes for install process questions
"RTN","XPDIQ",52,0)
 ;XPDFIL=file #, XPDFILN=file name^global ref^partial DD
"RTN","XPDIQ",53,0)
 ;XPDFILO=update DD^security codes^^^resolve pt^list template^data with file^add,merge,overwrite,replace^user override data update
"RTN","XPDIQ",54,0)
 ;XPDSCR=screen to determine DD update
"RTN","XPDIQ",55,0)
 ;XPDANS is define in QUES^XPDI
"RTN","XPDIQ",56,0)
XPF1 ;write over existing file
"RTN","XPDIQ",57,0)
 N XPDI
"RTN","XPDIQ",58,0)
 W !!?3,XPDFIL,?13,$P(XPDFILN,U),$P("  (Partial Definition)",U,$P(XPDFILN,U,3)),$P("  (including data)",U,$P(XPDFILO,U,7)="y")
"RTN","XPDIQ",59,0)
 ;file doesn't exists
"RTN","XPDIQ",60,0)
 I XPDANS K DIR Q
"RTN","XPDIQ",61,0)
 I $L($G(XPDSCR)) S XPDI=1 D  Q:'XPDI
"RTN","XPDIQ",62,0)
 .X XPDSCR S XPDI=$T Q:XPDI
"RTN","XPDIQ",63,0)
 .W !,"Data Dictionary FAILED the screening logic, file will NOT be installed!"
"RTN","XPDIQ",64,0)
 .S $P(XPDANS,U,2)="1" K DIR
"RTN","XPDIQ",65,0)
 S FLAG=$P($G(^DIC(XPDFIL,0)),U)
"RTN","XPDIQ",66,0)
 ;file exist and has the same name
"RTN","XPDIQ",67,0)
 I $P(FLAG,$P(XPDFILN,U))="" W !,"Note:  You already have the '",$P(XPDFILN,U),"' File." K DIR Q
"RTN","XPDIQ",68,0)
 W *7,!,"*BUT YOU ALREADY HAVE '",FLAG,"' AS FILE #",XPDFIL,"!"
"RTN","XPDIQ",69,0)
 S $P(XPDANS,U,4)=1
"RTN","XPDIQ",70,0)
 Q
"RTN","XPDIQ",71,0)
XPF2 ;data
"RTN","XPDIQ",72,0)
 ;if they don't want to overwrite a file with a different name then set the DIRUT flag and ABORT, this will stop the rest of the questions and abort the install
"RTN","XPDIQ",73,0)
 I $G(XPDQUES("XPF"_XPFP_1))=0 S DIRUT=1 K DIR Q
"RTN","XPDIQ",74,0)
 ;if Data doesn't exists or DD failed screen or data wasn't sent, don't ask question
"RTN","XPDIQ",75,0)
 I '$P(XPDANS,U,3)!$P(XPDANS,U,2)!($P(XPDFILO,U,7)'="y") K DIR Q
"RTN","XPDIQ",76,0)
 S %=$F("amor",$P(XPDFILO,U,8))-1
"RTN","XPDIQ",77,0)
 ;if this is add and file is not new
"RTN","XPDIQ",78,0)
 I %=1 W !,"Data will NOT be added." K DIR Q
"RTN","XPDIQ",79,0)
 ;check if dev. doesn't want to ask user
"RTN","XPDIQ",80,0)
 I $P(XPDFILO,U,9)'="y" W !,"I will ",$P("^MERGE^OVERWRITE^REPLACE",U,%)," your data with mine." K DIR Q
"RTN","XPDIQ",81,0)
 S FLAG=$P("^merged with^to overwrite^to replace",U,%)
"RTN","XPDIQ",82,0)
 Q
"RTN","XPDIQ",83,0)
XPM1 ;mail groups
"RTN","XPDIQ",84,0)
 S FLAG=XPDANS
"RTN","XPDIQ",85,0)
 Q:'$D(XPDDIQ("XPM1"))
"RTN","XPDIQ",86,0)
 I $D(XPDDIQ("XPM1"))#2 S XPDQUES("XPM1")=XPDDIQ("XPM1") K DIR Q
"RTN","XPDIQ",87,0)
 S:$D(XPDDIQ("XPM1","A")) DIR("A")=XPDDIQ("XPM1","A")
"RTN","XPDIQ",88,0)
 S:$D(XPDDIQ("XPM1","B")) DIR("B")=XPDDIQ("XPM1","B")
"RTN","XPDIQ",89,0)
 Q
"RTN","XPDIQ",90,0)
 ;XPDDIQ(name)=internal value, (name,"A")=prompt, (name,"B")=external
"RTN","XPDIQ",91,0)
XPO1 ;rebuild menu trees
"RTN","XPDIQ",92,0)
 Q:'$D(XPDDIQ("XPO1"))
"RTN","XPDIQ",93,0)
 I $D(XPDDIQ("XPO1"))#2 S XPDQUES("XPO1")=XPDDIQ("XPO1") K DIR Q
"RTN","XPDIQ",94,0)
 S:$D(XPDDIQ("XPO1","A")) DIR("A")=XPDDIQ("XPO1","A")
"RTN","XPDIQ",95,0)
 S:$D(XPDDIQ("XPO1","B")) DIR("B")=XPDDIQ("XPO1","B")
"RTN","XPDIQ",96,0)
 Q
"RTN","XPDIQ",97,0)
XPZ1 ;disable options
"RTN","XPDIQ",98,0)
 Q:'$D(XPDDIQ("XPZ1"))
"RTN","XPDIQ",99,0)
 I $D(XPDDIQ("XPZ1"))#2 S XPDQUES("XPZ1")=XPDDIQ("XPZ1") K DIR Q
"RTN","XPDIQ",100,0)
 S:$D(XPDDIQ("XPZ1","A")) DIR("A")=XPDDIQ("XPZ1","A")
"RTN","XPDIQ",101,0)
 S:$D(XPDDIQ("XPZ1","B")) DIR("B")=XPDDIQ("XPZ1","B")
"RTN","XPDIQ",102,0)
 Q
"RTN","XPDIQ",103,0)
XPZ2 ;move routines
"RTN","XPDIQ",104,0)
 N Y
"RTN","XPDIQ",105,0)
 ;if they are not in production UCI don't ask
"RTN","XPDIQ",106,0)
 X ^%ZOSF("UCI") I Y'=^%ZOSF("PROD") K DIR Q
"RTN","XPDIQ",107,0)
 ;if they are not running MSM don't ask
"RTN","XPDIQ",108,0)
 I ^%ZOSF("OS")'["MSM" K DIR Q
"RTN","XPDIQ",109,0)
 Q:'$D(XPDDIQ("XPZ2"))
"RTN","XPDIQ",110,0)
 I $D(XPDDIQ("XPZ2"))#2 S XPDQUES("XPZ2")=XPDDIQ("XPZ2") K DIR Q
"RTN","XPDIQ",111,0)
 S:$D(XPDDIQ("XPZ2","A")) DIR("A")=XPDDIQ("XPZ2","A")
"RTN","XPDIQ",112,0)
 S:$D(XPDDIQ("XPZ2","B")) DIR("B")=XPDDIQ("XPZ2","B")
"RTN","XPDIQ",113,0)
 Q
"RTN","XPDTC")
0^5^B38050621
"RTN","XPDTC",1,0)
XPDTC ;SFISC/RSD - Transport calls ;08/17/98  13:34
"RTN","XPDTC",2,0)
 ;;8.0;KERNEL;**10,15,21,39,41,44,58,83,92,95**;Jul 10, 1995
"RTN","XPDTC",3,0)
 Q
"RTN","XPDTC",4,0)
 ;^XTMP("XPDT",XPDA,data type,file #,
"RTN","XPDTC",5,0)
 ;XPDA=ien of File 9.6, XPDNM=.01 field
"RTN","XPDTC",6,0)
DD ;build DD
"RTN","XPDTC",7,0)
 N FILE,FGR,FNAM,Z2,Z3,Z4
"RTN","XPDTC",8,0)
 S FILE=0,FGR="^XTMP(""XPDT"",XPDA)",FNAM=$NA(^XPD(9.6,XPDA,4,"APDD"))
"RTN","XPDTC",9,0)
 F  S FILE=$O(^XPD(9.6,XPDA,4,FILE)) Q:'FILE  D
"RTN","XPDTC",10,0)
 .S Z2=$G(^XPD(9.6,XPDA,4,FILE,222)),Z3=$G(^(223)),Z4=$G(^(224))
"RTN","XPDTC",11,0)
 .Q:'$$DATA^XPDV(FILE,Z2)
"RTN","XPDTC",12,0)
 .D FIA^DIFROMSU(FILE,"",FNAM,FGR,Z2,Z3,Z4,XPDVER),DIERR:$D(DIERR)
"RTN","XPDTC",13,0)
 Q:'$D(^XTMP("XPDT",XPDA,"FIA"))
"RTN","XPDTC",14,0)
 ;send DD and Data
"RTN","XPDTC",15,0)
 D DDOUT^DIFROMS("","","",FGR),DIERR:$D(DIERR),DATAOUT^DIFROMS("","","",FGR),DIERR:$D(DIERR)
"RTN","XPDTC",16,0)
 Q
"RTN","XPDTC",17,0)
 ;XPDERR is checked in XPDT and will abort transport
"RTN","XPDTC",18,0)
DIERR ;record error
"RTN","XPDTC",19,0)
 D MSG^DIALOG("EW",.XPD) S XPDERR=1
"RTN","XPDTC",20,0)
 Q
"RTN","XPDTC",21,0)
KRN ;build Kernel Files
"RTN","XPDTC",22,0)
 ;XPDFILE=file #, XPDOLDA=ien in Build file
"RTN","XPDTC",23,0)
 N %,%1,%2,DA,EACT,FACT,FGR,XPDFILE,XPDFL,XPDOLDA,XPDI
"RTN","XPDTC",24,0)
 F XPDFILE=1:1 S Y0=$P($T(FILES+XPDFILE^XPDE),";;",2,99) Q:Y0=""  S XPDI(+Y0)=Y0
"RTN","XPDTC",25,0)
 ;XPDI(XPDFILE)=file;order;x-ref;fact;eact;fpre;epre;fpos;epos;fdel
"RTN","XPDTC",26,0)
 S XPDFILE=0
"RTN","XPDTC",27,0)
 F  S XPDFILE=$O(^XPD(9.6,XPDA,"KRN",XPDFILE)) Q:'XPDFILE  S XPDI=$G(XPDI(XPDFILE)),FACT=$P(XPDI,";",4),EACT=$P(XPDI,";",5) D  Q:$D(XPDERR)  D:FACT]"" ACT(FACT)
"RTN","XPDTC",28,0)
 .;need to add code to check if File and data is already being sent in the File
"RTN","XPDTC",29,0)
 .;mult. If it is, don't bother sending it again.  DTL(XPDFILE)
"RTN","XPDTC",30,0)
 .S XPDOLDA=0,FGR=$$FILE^XPDV(XPDFILE) I FGR="" S XPDERR=1 Q
"RTN","XPDTC",31,0)
 .K ^TMP($J,"XPD")
"RTN","XPDTC",32,0)
 .F  S XPDOLDA=$O(^XPD(9.6,XPDA,"KRN",XPDFILE,"NM",XPDOLDA)) Q:'XPDOLDA  S Y0=$G(^(XPDOLDA,0)) D
"RTN","XPDTC",33,0)
 ..;XPDFL= 0-send,1-delete,2-link,3-merge,4-attach,5-disable
"RTN","XPDTC",34,0)
 ..S XPDFL=$P(Y0,U,3)
"RTN","XPDTC",35,0)
 ..;If deleting at site get an unused DA
"RTN","XPDTC",36,0)
 ..I XPDFL=1 S DA=$O(@FGR@(" "),-1)+1 F DA=DA:1 Q:'$D(^XTMP("XPDT",XPDA,"KRN",XPDFILE,DA))
"RTN","XPDTC",37,0)
 ..;$P(Y0,U,2) is file # for this template, reset Y0 before getting DA
"RTN","XPDTC",38,0)
 ..E  S:$P(Y0,U,2) $P(Y0,U)=$P(Y0,"    FILE #") S DA=$$ENTRY^XPDV(Y0)
"RTN","XPDTC",39,0)
 ..I 'DA S XPDERR=1 Q
"RTN","XPDTC",40,0)
 ..;(-1)=action ^ ien in Build file
"RTN","XPDTC",41,0)
 ..S ^XTMP("XPDT",XPDA,"KRN",XPDFILE,DA,-1)=+XPDFL_"^"_XPDOLDA
"RTN","XPDTC",42,0)
 ..;action 2 - verify children, 4 - verify parent
"RTN","XPDTC",43,0)
 ..I XPDFL=2!(XPDFL=4),'$$MENU^XPDV(XPDFILE,DA,XPDFL) S XPDERR=1 Q
"RTN","XPDTC",44,0)
 ..;if action is 1,4 or 5 then only send .01 field and set checksum to ""
"RTN","XPDTC",45,0)
 ..I XPDFL=1!(XPDFL>3) S ^XTMP("XPDT",XPDA,"KRN",XPDFILE,DA,0)=$P(Y0,U),$P(^XPD(9.6,XPDA,"KRN",XPDFILE,"NM",XPDOLDA),U,4)="" Q
"RTN","XPDTC",46,0)
 ..M ^XTMP("XPDT",XPDA,"KRN",XPDFILE,DA)=@FGR@(DA)
"RTN","XPDTC",47,0)
 ..;execute entry build action
"RTN","XPDTC",48,0)
 ..D:EACT]"" ACT(EACT)
"RTN","XPDTC",49,0)
 .;quit if no entries were saved
"RTN","XPDTC",50,0)
 .Q:'$O(^XTMP("XPDT",XPDA,"KRN",XPDFILE,0))
"RTN","XPDTC",51,0)
 .;XPDI=XPDI(XPDFILE), build x-ref of order to install
"RTN","XPDTC",52,0)
 .S %=$P(^DIC(XPDFILE,0),U),^XTMP("XPDT",XPDA,"ORD",+$P(XPDI,";",2),XPDFILE)=XPDI,^(XPDFILE,0)=%
"RTN","XPDTC",53,0)
 .Q
"RTN","XPDTC",54,0)
 Q
"RTN","XPDTC",55,0)
QUES ;build from Install Questions multiple
"RTN","XPDTC",56,0)
 N I,J,X,%
"RTN","XPDTC",57,0)
 S X=""
"RTN","XPDTC",58,0)
 ;the "B" x-ref will give me the order of the questions
"RTN","XPDTC",59,0)
 F  S X=$O(^XPD(9.6,XPDA,"QUES","B",X)) Q:X=""  S I=$$QUES^XPDV(X) S:'I XPDERR=1 D:I
"RTN","XPDTC",60,0)
 .S J=0 F  S J=$O(^XPD(9.6,XPDA,"QUES",I,J)) Q:J=""  D
"RTN","XPDTC",61,0)
 ..;tranform J to DIR subscripts
"RTN","XPDTC",62,0)
 ..I $L(J)=1!(J="QQ") S ^XTMP("XPDT",XPDA,"QUES",X,$TR(J,"1ABQ","0AB?"))=^(J) Q  ;^(J) ref to ^XPD(9.6,XPDA,"QUES",I,J)
"RTN","XPDTC",63,0)
 ..;set the word processing fields into DIR("?",#) structure
"RTN","XPDTC",64,0)
 ..F %=1:1 Q:'$D(^XPD(9.6,XPDA,"QUES",I,J,%,0))  S ^XTMP("XPDT",XPDA,"QUES",X,$TR(J,"AQ10","A?"),%)=^(0)
"RTN","XPDTC",65,0)
 ;send the File questions
"RTN","XPDTC",66,0)
 F I=1:2 S X=$P($T(QUESTION+I),";;",2,99) Q:X=""  S Y=$P($T(QUESTION+I+1),";;",2) D
"RTN","XPDTC",67,0)
 .S ^XTMP("XPDT",XPDA,"QUES",$P(X,";"),0)=$P(X,";",2),^("A")=$P(X,";",3),^("B")=$P(X,";",4),^("??")=$P(X,";",5) S:Y]"" ^("M")=Y
"RTN","XPDTC",68,0)
 Q
"RTN","XPDTC",69,0)
INT ;build pre,post, & enviroment init routines
"RTN","XPDTC",70,0)
 N %,I,X
"RTN","XPDTC",71,0)
 F I="PRE","INI","INIT" I $G(^XPD(9.6,XPDA,I))]"" S X=^(I) D
"RTN","XPDTC",72,0)
 .S ^XTMP("XPDT",XPDA,I)=X,X=$P(X,U,$L(X,U)) Q:$D(^("RTN",X))
"RTN","XPDTC",73,0)
 .I '$$RTN^XPDV(X) W !,"Routine ",X," **NOT FOUND**" S XPDERR=1 Q
"RTN","XPDTC",74,0)
 .S %=$$LOAD^XPDTA(X,"0^")
"RTN","XPDTC",75,0)
 Q
"RTN","XPDTC",76,0)
BLD ;build Build file, Package file and Order Parameter file
"RTN","XPDTC",77,0)
 N %,DIC,X,XPD,XPDI,XPDV,Y
"RTN","XPDTC",78,0)
 ;save version of kernel and fm
"RTN","XPDTC",79,0)
 S ^XTMP("XPDT",XPDA,"VER")=$$VERSION^XPDUTL("XU")_U_$$VERSION^XPDUTL("VA FILEMAN")
"RTN","XPDTC",80,0)
 M ^XTMP("XPDT",XPDA,"BLD",XPDA)=^XPD(9.6,XPDA)
"RTN","XPDTC",81,0)
 ;check national package file pointer
"RTN","XPDTC",82,0)
 S XPDI=$P(^XPD(9.6,XPDA,0),U,2)
"RTN","XPDTC",83,0)
 I XPDI="" W !,"No Package File Link" Q
"RTN","XPDTC",84,0)
 S $P(^XTMP("XPDT",XPDA,"BLD",XPDA,0),U,2)=$$PT^XPDTA("^DIC(9.4)",XPDI)
"RTN","XPDTC",85,0)
 ;quit if no pointer to package file
"RTN","XPDTC",86,0)
 I '$D(^DIC(9.4,XPDI)) W !,"Package File Link is corrupted" S XPDERR=1 Q
"RTN","XPDTC",87,0)
 ;update version multiple in package file,XPD=version^date distributed
"RTN","XPDTC",88,0)
 S XPD=$$VER^XPDUTL(XPDNM)_U_$P(^XTMP("XPDT",XPDA,"BLD",XPDA,0),U,4)
"RTN","XPDTC",89,0)
 ;XPD(1)=root of description field
"RTN","XPDTC",90,0)
 S:$D(^XTMP("XPDT",XPDA,"BLD",XPDA,1)) XPD(1)=$NA(^(1))
"RTN","XPDTC",91,0)
 S ^XTMP("XPDT",XPDA,"PKG",XPDI,0)=^DIC(9.4,XPDI,0),^XTMP("XPDT",XPDA,"PKG",XPDI,22,0)="^"_$P(^DD(9.4,22,0),U,2)_"^1^1"
"RTN","XPDTC",92,0)
 ;add node 20 to XTMP for Patient Merge
"RTN","XPDTC",93,0)
 M ^XTMP("XPDT",XPDA,"PKG",XPDI,20)=^DIC(9.4,XPDI,20)
"RTN","XPDTC",94,0)
 ;XPDNM'["*" is a version release
"RTN","XPDTC",95,0)
 I XPDNM'["*" D
"RTN","XPDTC",96,0)
 .S XPDV=$$PKGVER^XPDIP(XPDI,.XPD)
"RTN","XPDTC",97,0)
 .;Merge is used to set single nodes and merge multiples
"RTN","XPDTC",98,0)
 .F %=1,5,7,20,"DEV","VERSION" M ^XTMP("XPDT",XPDA,"PKG",XPDI,%)=^DIC(9.4,XPDI,%)
"RTN","XPDTC",99,0)
 .;XPDV=ien of Version Multiple
"RTN","XPDTC",100,0)
 .I $D(^DIC(9.4,XPDI,22,XPDV))'>9 W !!,"**Version multiple in Package file wasn't updated**",!! S XPDERR=1 Q
"RTN","XPDTC",101,0)
 .M ^XTMP("XPDT",XPDA,"PKG",XPDI,22,1)=^DIC(9.4,XPDI,22,XPDV)
"RTN","XPDTC",102,0)
 ;this is a patch, %=version number, $P(XPD,U)=patch number
"RTN","XPDTC",103,0)
 E  D
"RTN","XPDTC",104,0)
 .S %=$P(XPD,U),$P(XPD,U)=$P(XPDNM,"*",3),XPDV=$$PKGPAT^XPDIP(XPDI,%,.XPD)
"RTN","XPDTC",105,0)
 .S ^XTMP("XPDT",XPDA,"PKG",XPDI,22,1,0)=^DIC(9.4,XPDI,22,+XPDV,0)
"RTN","XPDTC",106,0)
 .I $D(^DIC(9.4,XPDI,22,+XPDV,"PAH",+$P(XPDV,U,2)))'>9 W !!,"**Patch multiple in Package file wasn't updated**",!! S XPDERR=1 Q
"RTN","XPDTC",107,0)
 .M ^XTMP("XPDT",XPDA,"PKG",XPDI,22,1,"PAH",1)=^DIC(9.4,XPDI,22,+XPDV,"PAH",+$P(XPDV,U,2))
"RTN","XPDTC",108,0)
 ;M ^XTMP("XPDT",XPDA,"PKG",XPDI)=^DIC(9.4,XPDI)
"RTN","XPDTC",109,0)
 ;save the version ien^patch ien on -1 node
"RTN","XPDTC",110,0)
 S ^XTMP("XPDT",XPDA,"PKG",XPDI,-1)="1^1"
"RTN","XPDTC",111,0)
 ;resolve Primary Help Frame (0;4)
"RTN","XPDTC",112,0)
 S %=+$P(^DIC(9.4,XPDI,0),U,4) S:% $P(^XTMP("XPDT",XPDA,"PKG",XPDI,0),U,4)=$$PT^XPDTA("^DIC(9.2)",%)
"RTN","XPDTC",113,0)
 Q
"RTN","XPDTC",114,0)
 ;
"RTN","XPDTC",115,0)
ACT(%) ;execute action
"RTN","XPDTC",116,0)
 ;user can count on DA,XPDFILE,XPDFL,XPDNM,XPDOLDA being around
"RTN","XPDTC",117,0)
 ;DA=ien in ^XTMP("XPDT",XPDA,"KRN",XPDFILE,DA)
"RTN","XPDTC",118,0)
 ;XPDOLDA=ien in ^XPD(9.6,XPDA,"KRN",XPDIFLE,"NM",XPDOLDA)
"RTN","XPDTC",119,0)
 N EACT,FACT,FGR,K0,Y0
"RTN","XPDTC",120,0)
 S:%'["^" %="^"_%
"RTN","XPDTC",121,0)
 D @% Q
"RTN","XPDTC",122,0)
 ;
"RTN","XPDTC",123,0)
 ;the following are the default questions for the INSTALL QUESTIONS
"RTN","XPDTC",124,0)
 ;in file 9.6, the format is:
"RTN","XPDTC",125,0)
 ;;field .01;field 1;field 2;field 4;field 7
"RTN","XPDTC",126,0)
 ;;field 10
"RTN","XPDTC",127,0)
QUESTION ;package install questions
"RTN","XPDTC",128,0)
 ;;XPF1;Y;Shall I write over your |FLAG| File;YES;^D REP^XPDH
"RTN","XPDTC",129,0)
 ;;D XPF1^XPDIQ
"RTN","XPDTC",130,0)
 ;;XPF2;Y;Want my data |FLAG| yours;YES;^D DTA^XPDH
"RTN","XPDTC",131,0)
 ;;D XPF2^XPDIQ
"RTN","XPDTC",132,0)
 ;;XPM1;PO^VA(200,:EM;Enter the Coordinator for Mail Group '|FLAG|';;^D MG^XPDH
"RTN","XPDTC",133,0)
 ;;D XPM1^XPDIQ
"RTN","XPDTC",134,0)
 ;;XPO1;Y;Want KIDS to Rebuild Menu Trees Upon Completion of Install;YES;^D MENU^XPDH
"RTN","XPDTC",135,0)
 ;;D XPO1^XPDIQ
"RTN","XPDTC",136,0)
 ;;XPZ1;Y;Want to DISABLE Scheduled Options, Menu Options, and Protocols;YES;^D OPT^XPDH
"RTN","XPDTC",137,0)
 ;;D XPZ1^XPDIQ
"RTN","XPDTC",138,0)
 ;;XPZ2;Y;Want to MOVE routines to other CPUs;NO;^D RTN^XPDH
"RTN","XPDTC",139,0)
 ;;D XPZ2^XPDIQ
"VER")
8.0^21.0
**END**
**END**
