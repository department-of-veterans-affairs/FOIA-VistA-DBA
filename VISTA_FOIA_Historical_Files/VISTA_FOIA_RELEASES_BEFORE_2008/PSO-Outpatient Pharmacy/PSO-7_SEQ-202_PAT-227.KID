Released PSO*7*227 SEQ #202
Extracted from mail message
**KIDS**:PSO*7.0*227^

**INSTALL NAME**
PSO*7.0*227
"BLD",5529,0)
PSO*7.0*227^OUTPATIENT PHARMACY^0^3060105^y
"BLD",5529,1,0)
^^114^114^3060105^
"BLD",5529,1,1,0)
The Transitional Pharmacy Benefit (TPB) project that was providing
"BLD",5529,1,2,0)
functionality to furnish medications prescribed by Non-VA Physicians
"BLD",5529,1,3,0)
needs to be shut down as the period for its eligibility expired on
"BLD",5529,1,4,0)
October 22, 2004.  Inactivation of the TPB functionality will be done in 2
"BLD",5529,1,5,0)
steps, a manual step and a automatic step.
"BLD",5529,1,6,0)
 
"BLD",5529,1,7,0)
Step I-To make sure that the Health Level Seven (HL7) data transmission
"BLD",5529,1,8,0)
      of TPB eligible patients to the Austin Automation Center (AAC) is
"BLD",5529,1,9,0)
      shutdown.
"BLD",5529,1,10,0)
Step II-The installation of this patch will automatically inactivate all
"BLD",5529,1,11,0)
     the TPB functionality.
"BLD",5529,1,12,0)
 
"BLD",5529,1,13,0)
***********************************************************************
"BLD",5529,1,14,0)
***                    Step I - Manual Step                         ***
"BLD",5529,1,15,0)
***********************************************************************
"BLD",5529,1,16,0)
The data transmission of TPB eligible patient from the TPB ELIGIBILITY
"BLD",5529,1,17,0)
file (#52.91) is performed by the PSOTPBACC HL7 logical link.
"BLD",5529,1,18,0)
By now most of the sites would have shut down this link. To check
"BLD",5529,1,19,0)
whether this link is enabled or shutdown, do the following:
"BLD",5529,1,20,0)
 
"BLD",5529,1,21,0)
  a) Use the HL7 Main Menu [HL MAIN MENU] option and select the
"BLD",5529,1,22,0)
     Systems Link Monitor [HL MESSAGE MONITOR] option, you should see the
"BLD",5529,1,23,0)
     following screen:
"BLD",5529,1,24,0)
 
"BLD",5529,1,25,0)
                SYSTEM LINK MONITOR for BIRMINGHAM, AL. (Test System)
"BLD",5529,1,26,0)
                MESSAGES  MESSAGES   MESSAGES  MESSAGES  DEVICE
"BLD",5529,1,27,0)
     NODE       RECEIVED  PROCESSED  TO SEND   SENT      TYPE     STATE
"BLD",5529,1,28,0)
 
"BLD",5529,1,29,0)
     LL2VISN    51        51         85        51         NC      Open
"BLD",5529,1,30,0)
     NPTF       0         0          163       0          N       Halting
"BLD",5529,1,31,0)
     PSBCOTS1                        2397                         Shutdown
"BLD",5529,1,32,0)
     PSD HLLP                        38                   N       Halting
"BLD",5529,1,33,0)
     PSO DISP   1380      1380       10130     1380       NC      Openfail
"BLD",5529,1,34,0)
     PSO LLP1                        238                  N       Halting
"BLD",5529,1,35,0)
     PSOTPBAA                        28                           Enabled
"BLD",5529,1,36,0)
     PSU SEND                        13
"BLD",5529,1,37,0)
     TEST       21        21         21        21         SS      Idle
"BLD",5529,1,38,0)
 
"BLD",5529,1,39,0)
     Incoming filers running => Zero     TaskMan running
"BLD",5529,1,40,0)
     Outgoing filers running => Zero     ***LINK MANAGER NOT RUNNING!!!***
"BLD",5529,1,41,0)
                                             Monitor OVERDUE
"BLD",5529,1,42,0)
    Select a Command:
"BLD",5529,1,43,0)
 
"BLD",5529,1,44,0)
  b) If the PSOTPBAAC logical link is enabled then you need to shut down
"BLD",5529,1,45,0)
     the link by doing the following:
"BLD",5529,1,46,0)
     - Use the HL7 Main Menu Option [HL MAIN]
"BLD",5529,1,47,0)
     - Select the Filer and Link Management Options
"BLD",5529,1,48,0)
        [HL MENU FILER LINK MGT]
"BLD",5529,1,49,0)
     - Select the 'Start/Stop Links' option [HL START]
"BLD",5529,1,50,0)
     - At the 'Select HL LOGICAL LINK NODE: ' prompt, type PSOTPBAAC and
"BLD",5529,1,51,0)
       press enter. The system will prompt 'Okay to shut down this job?',
"BLD",5529,1,52,0)
       answer 'YES' and press enter.
"BLD",5529,1,53,0)
       The system will display the following message:
"BLD",5529,1,54,0)
       'The job for the PSOTPBAAC Lower Level Protocol will be shut down.'
"BLD",5529,1,55,0)
     - To ensure the link is shut down use the Systems Link Monitor [HL
"BLD",5529,1,56,0)
       MESSAGE MONITOR] option and make sure the status is 'Shutdown'
"BLD",5529,1,57,0)
       (step a. above).
"BLD",5529,1,58,0)
*************************************************************************
"BLD",5529,1,59,0)
*** Step II - Automated Step                                          ***
"BLD",5529,1,60,0)
*************************************************************************
"BLD",5529,1,61,0)
1. This patch disables the following menu options by placing them to
"BLD",5529,1,62,0)
   be out of order:
"BLD",5529,1,63,0)
      - TPB HL7 Data Extract/Transmission [PSO TPB HL7 EXTRACT]
"BLD",5529,1,64,0)
      - TPB Institution Letter Enter/Edit [PSO TPB INSTITUTION LETTERS]
"BLD",5529,1,65,0)
      - Report TPB Patients Letters Printed/NOT Printed
"BLD",5529,1,66,0)
         [PSO TPB LETTERS PRINTED REPORT]
"BLD",5529,1,67,0)
      - Transitional Pharmacy Benefit Patient Enter/Edit
"BLD",5529,1,68,0)
         [PSO TPB PATIENT ENTER/EDIT]
"BLD",5529,1,69,0)
      - TPB Patient Report [PSO TPB PATIENT REPORT]
"BLD",5529,1,70,0)
      - Report of Patients with TPB and Non-TPB Rx's
"BLD",5529,1,71,0)
         [PSO TPB PATIENT RX REPORT]
"BLD",5529,1,72,0)
      - Print TPB Patient Letter(s) [PSO TPB PRINT LETTERS]
"BLD",5529,1,73,0)
      - TPB Rx (Prescription) Entry [PSO TPB RX ENTRY]
"BLD",5529,1,74,0)
 
"BLD",5529,1,75,0)
2. Inactivation of all active TPB patients
"BLD",5529,1,76,0)
   This patch will scan all the entries in the TPB ELIGIBILITY file
"BLD",5529,1,77,0)
   (#52.91) and will stuff the INACTIVATION OF BENEFIT DATE field (#2)
"BLD",5529,1,78,0)
   of the active patients with today's date and the INACTIVATION REASON
"BLD",5529,1,79,0)
   CODE field (#3) with the code "10-PROGRAM ENDED".
"BLD",5529,1,80,0)
 
"BLD",5529,1,81,0)
3. When a prescription is discontinued, routine PSOTPCAN is called to
"BLD",5529,1,82,0)
   check if that's the last active TPB prescription for an Active TPB
"BLD",5529,1,83,0)
   patient, and if so, the patient TPB patient is inactivated from TPB
"BLD",5529,1,84,0)
   ELIGIBILITY file (#52.91). Based on the fact that there will be no
"BLD",5529,1,85,0)
   active TPB patient upon installing of this patch, routine PSOTPCAN is
"BLD",5529,1,86,0)
   modified to quit without checking for last active TPB prescription.
"BLD",5529,1,87,0)
 
"BLD",5529,1,88,0)
4. Prior to this patch, Outpatient Pharmacy software used to be notified
"BLD",5529,1,89,0)
   by the Scheduling software every time a patient has an appointment at a
"BLD",5529,1,90,0)
   VA clinic. If the patient is eligible for the TPB benefit, the
"BLD",5529,1,91,0)
   appointment was at a clinic defined as primary care for the TPB program
"BLD",5529,1,92,0)
   (determined through a set of clinic stop codes) AND the patient does
"BLD",5529,1,93,0)
   not have any "active" TPB prescription(s) on file, this patient will
"BLD",5529,1,94,0)
   have the TPB eligibility automatically inactivated (introduced by
"BLD",5529,1,95,0)
   PSO*7*160). As all active TPB patient's will be inactivated (item #2
"BLD",5529,1,96,0)
   above), there is no need for this functionality to continue. This patch
"BLD",5529,1,97,0)
   will stop this functionality by removing the PSO TPB SD SUB protocol
"BLD",5529,1,98,0)
   entry from the SDAM APPOINTMENT EVENTS Scheduling protocol.
"BLD",5529,1,99,0)
 
"BLD",5529,1,100,0)
5. This patch will set the AUTOSTART field (#4.5) of the HL LOGICAL LINK
"BLD",5529,1,101,0)
   file (#870) of the PSOTPBAAC Logical Link to "Disabled", to prevent
"BLD",5529,1,102,0)
   restarting of the PSOTPBAAC logical link by TaskMan after a system
"BLD",5529,1,103,0)
   reboot.
"BLD",5529,1,104,0)
 
"BLD",5529,1,105,0)
6. The TPB data extraction job is queued to run daily and transmit
"BLD",5529,1,106,0)
   data to the AAC every Sunday. This patch will remove the TPB HL7 Data
"BLD",5529,1,107,0)
   Extract/Transmission [PSO TPB HL7 EXTRACT] option from the Task
"BLD",5529,1,108,0)
   Manager.
"BLD",5529,1,109,0)
 
"BLD",5529,1,110,0)
Note:
"BLD",5529,1,111,0)
     - The post install routine (PSO227PO) included in this patch
"BLD",5529,1,112,0)
       addresses all items in step II except #3.
"BLD",5529,1,113,0)
     - Most of the TPB routines that are transported in this patch are
"BLD",5529,1,114,0)
       modified to "QUIT" if they are ever called by any other routine.
"BLD",5529,4,0)
^9.64PA^52.91^1
"BLD",5529,4,52.91,0)
52.91
"BLD",5529,4,52.91,2,0)
^9.641^52.91^1
"BLD",5529,4,52.91,2,52.91,0)
TPB ELIGIBILITY  (File-top level)
"BLD",5529,4,52.91,2,52.91,1,0)
^9.6411^3^1
"BLD",5529,4,52.91,2,52.91,1,3,0)
INACTIVATION REASON CODE
"BLD",5529,4,52.91,222)
y^y^p^^^^n^^n
"BLD",5529,4,52.91,224)

"BLD",5529,4,"APDD",52.91,52.91)

"BLD",5529,4,"APDD",52.91,52.91,3)

"BLD",5529,4,"B",52.91,52.91)

"BLD",5529,"INID")
^
"BLD",5529,"INIT")
PSO227PO
"BLD",5529,"KRN",0)
^9.67PA^8989.52^19
"BLD",5529,"KRN",.4,0)
.4
"BLD",5529,"KRN",.401,0)
.401
"BLD",5529,"KRN",.402,0)
.402
"BLD",5529,"KRN",.403,0)
.403
"BLD",5529,"KRN",.5,0)
.5
"BLD",5529,"KRN",.84,0)
.84
"BLD",5529,"KRN",3.6,0)
3.6
"BLD",5529,"KRN",3.8,0)
3.8
"BLD",5529,"KRN",9.2,0)
9.2
"BLD",5529,"KRN",9.8,0)
9.8
"BLD",5529,"KRN",9.8,"NM",0)
^9.68A^11^11
"BLD",5529,"KRN",9.8,"NM",1,0)
PSOHELP1^^0^B45597408
"BLD",5529,"KRN",9.8,"NM",2,0)
PSOTPCAN^^0^B56784820
"BLD",5529,"KRN",9.8,"NM",3,0)
PSOTPCEE^^0^B7950417
"BLD",5529,"KRN",9.8,"NM",4,0)
PSOTPCL^^0^B21264394
"BLD",5529,"KRN",9.8,"NM",5,0)
PSOTPCLP^^0^B62400881
"BLD",5529,"KRN",9.8,"NM",6,0)
PSOTPCLR^^0^B10932938
"BLD",5529,"KRN",9.8,"NM",7,0)
PSOTPCRP^^0^B53305181
"BLD",5529,"KRN",9.8,"NM",8,0)
PSOTPHL1^^0^B72097367
"BLD",5529,"KRN",9.8,"NM",9,0)
PSOTPRP1^^0^B22123133
"BLD",5529,"KRN",9.8,"NM",10,0)
PSOTPRX1^^0^B51610518
"BLD",5529,"KRN",9.8,"NM",11,0)
PSOTPINA^^0^B6448418
"BLD",5529,"KRN",9.8,"NM","B","PSOHELP1",1)

"BLD",5529,"KRN",9.8,"NM","B","PSOTPCAN",2)

"BLD",5529,"KRN",9.8,"NM","B","PSOTPCEE",3)

"BLD",5529,"KRN",9.8,"NM","B","PSOTPCL",4)

"BLD",5529,"KRN",9.8,"NM","B","PSOTPCLP",5)

"BLD",5529,"KRN",9.8,"NM","B","PSOTPCLR",6)

"BLD",5529,"KRN",9.8,"NM","B","PSOTPCRP",7)

"BLD",5529,"KRN",9.8,"NM","B","PSOTPHL1",8)

"BLD",5529,"KRN",9.8,"NM","B","PSOTPINA",11)

"BLD",5529,"KRN",9.8,"NM","B","PSOTPRP1",9)

"BLD",5529,"KRN",9.8,"NM","B","PSOTPRX1",10)

"BLD",5529,"KRN",19,0)
19
"BLD",5529,"KRN",19.1,0)
19.1
"BLD",5529,"KRN",101,0)
101
"BLD",5529,"KRN",409.61,0)
409.61
"BLD",5529,"KRN",771,0)
771
"BLD",5529,"KRN",870,0)
870
"BLD",5529,"KRN",8989.51,0)
8989.51
"BLD",5529,"KRN",8989.52,0)
8989.52
"BLD",5529,"KRN",8994,0)
8994
"BLD",5529,"KRN","B",.4,.4)

"BLD",5529,"KRN","B",.401,.401)

"BLD",5529,"KRN","B",.402,.402)

"BLD",5529,"KRN","B",.403,.403)

"BLD",5529,"KRN","B",.5,.5)

"BLD",5529,"KRN","B",.84,.84)

"BLD",5529,"KRN","B",3.6,3.6)

"BLD",5529,"KRN","B",3.8,3.8)

"BLD",5529,"KRN","B",9.2,9.2)

"BLD",5529,"KRN","B",9.8,9.8)

"BLD",5529,"KRN","B",19,19)

"BLD",5529,"KRN","B",19.1,19.1)

"BLD",5529,"KRN","B",101,101)

"BLD",5529,"KRN","B",409.61,409.61)

"BLD",5529,"KRN","B",771,771)

"BLD",5529,"KRN","B",870,870)

"BLD",5529,"KRN","B",8989.51,8989.51)

"BLD",5529,"KRN","B",8989.52,8989.52)

"BLD",5529,"KRN","B",8994,8994)

"BLD",5529,"QUES",0)
^9.62^^
"BLD",5529,"REQB",0)
^9.611^3^3
"BLD",5529,"REQB",1,0)
PSO*7.0*160^2
"BLD",5529,"REQB",2,0)
PSO*7.0*163^2
"BLD",5529,"REQB",3,0)
PSO*7.0*182^2
"BLD",5529,"REQB","B","PSO*7.0*160",1)

"BLD",5529,"REQB","B","PSO*7.0*163",2)

"BLD",5529,"REQB","B","PSO*7.0*182",3)

"FIA",52.91)
TPB ELIGIBILITY
"FIA",52.91,0)
^PS(52.91,
"FIA",52.91,0,0)
52.91P
"FIA",52.91,0,1)
y^y^p^^^^n^^n
"FIA",52.91,0,10)

"FIA",52.91,0,11)

"FIA",52.91,0,"RLRO")

"FIA",52.91,0,"VR")
7.0^PSO
"FIA",52.91,52.91)
1
"FIA",52.91,52.91,3)

"INIT")
PSO227PO
"IX",52.91,52.91,"AX",0)
52.91^AX^Triggers the "AX" x-ref only during manual edit.^MU^^R^IR^I^52.91^^^^^A
"IX",52.91,52.91,"AX",1)
S:$$PATCH^XPDUTL("PSO*7.0*146") ^PS(52.91,"AX",DT,DA)="" Q
"IX",52.91,52.91,"AX",1.4)
N I S (X,I)=0 F  S I=$O(X1(I)) Q:'I  I X1(I)'=X2(I) S X=1 Q
"IX",52.91,52.91,"AX",2)
S:$$PATCH^XPDUTL("PSO*7.0*146") ^PS(52.91,"AX",DT,DA)="" Q
"IX",52.91,52.91,"AX",2.4)
N I S (X,I)=0 F  S I=$O(X1(I)) Q:'I  I X1(I)'=X2(I) S X=1 Q
"IX",52.91,52.91,"AX",11.1,0)
^.114IA^8^8
"IX",52.91,52.91,"AX",11.1,1,0)
1^F^52.91^1^^1^F
"IX",52.91,52.91,"AX",11.1,2,0)
2^F^52.91^2^^^F
"IX",52.91,52.91,"AX",11.1,3,0)
3^F^52.91^3^^^F
"IX",52.91,52.91,"AX",11.1,4,0)
4^F^52.91^4^^^F
"IX",52.91,52.91,"AX",11.1,5,0)
5^F^52.91^5^^^F
"IX",52.91,52.91,"AX",11.1,6,0)
6^F^52.91^6^^^F
"IX",52.91,52.91,"AX",11.1,7,0)
7^F^52.91^8^^^F
"IX",52.91,52.91,"AX",11.1,8,0)
8^F^52.91^9^^^F
"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
227^3060105
"PKG",141,22,1,"PAH",1,1,0)
^^114^114^3060105
"PKG",141,22,1,"PAH",1,1,1,0)
The Transitional Pharmacy Benefit (TPB) project that was providing
"PKG",141,22,1,"PAH",1,1,2,0)
functionality to furnish medications prescribed by Non-VA Physicians
"PKG",141,22,1,"PAH",1,1,3,0)
needs to be shut down as the period for its eligibility expired on
"PKG",141,22,1,"PAH",1,1,4,0)
October 22, 2004.  Inactivation of the TPB functionality will be done in 2
"PKG",141,22,1,"PAH",1,1,5,0)
steps, a manual step and a automatic step.
"PKG",141,22,1,"PAH",1,1,6,0)
 
"PKG",141,22,1,"PAH",1,1,7,0)
Step I-To make sure that the Health Level Seven (HL7) data transmission
"PKG",141,22,1,"PAH",1,1,8,0)
      of TPB eligible patients to the Austin Automation Center (AAC) is
"PKG",141,22,1,"PAH",1,1,9,0)
      shutdown.
"PKG",141,22,1,"PAH",1,1,10,0)
Step II-The installation of this patch will automatically inactivate all
"PKG",141,22,1,"PAH",1,1,11,0)
     the TPB functionality.
"PKG",141,22,1,"PAH",1,1,12,0)
 
"PKG",141,22,1,"PAH",1,1,13,0)
***********************************************************************
"PKG",141,22,1,"PAH",1,1,14,0)
***                    Step I - Manual Step                         ***
"PKG",141,22,1,"PAH",1,1,15,0)
***********************************************************************
"PKG",141,22,1,"PAH",1,1,16,0)
The data transmission of TPB eligible patient from the TPB ELIGIBILITY
"PKG",141,22,1,"PAH",1,1,17,0)
file (#52.91) is performed by the PSOTPBACC HL7 logical link.
"PKG",141,22,1,"PAH",1,1,18,0)
By now most of the sites would have shut down this link. To check
"PKG",141,22,1,"PAH",1,1,19,0)
whether this link is enabled or shutdown, do the following:
"PKG",141,22,1,"PAH",1,1,20,0)
 
"PKG",141,22,1,"PAH",1,1,21,0)
  a) Use the HL7 Main Menu [HL MAIN MENU] option and select the
"PKG",141,22,1,"PAH",1,1,22,0)
     Systems Link Monitor [HL MESSAGE MONITOR] option, you should see the
"PKG",141,22,1,"PAH",1,1,23,0)
     following screen:
"PKG",141,22,1,"PAH",1,1,24,0)
 
"PKG",141,22,1,"PAH",1,1,25,0)
                SYSTEM LINK MONITOR for BIRMINGHAM, AL. (Test System)
"PKG",141,22,1,"PAH",1,1,26,0)
                MESSAGES  MESSAGES   MESSAGES  MESSAGES  DEVICE
"PKG",141,22,1,"PAH",1,1,27,0)
     NODE       RECEIVED  PROCESSED  TO SEND   SENT      TYPE     STATE
"PKG",141,22,1,"PAH",1,1,28,0)
 
"PKG",141,22,1,"PAH",1,1,29,0)
     LL2VISN    51        51         85        51         NC      Open
"PKG",141,22,1,"PAH",1,1,30,0)
     NPTF       0         0          163       0          N       Halting
"PKG",141,22,1,"PAH",1,1,31,0)
     PSBCOTS1                        2397                         Shutdown
"PKG",141,22,1,"PAH",1,1,32,0)
     PSD HLLP                        38                   N       Halting
"PKG",141,22,1,"PAH",1,1,33,0)
     PSO DISP   1380      1380       10130     1380       NC      Openfail
"PKG",141,22,1,"PAH",1,1,34,0)
     PSO LLP1                        238                  N       Halting
"PKG",141,22,1,"PAH",1,1,35,0)
     PSOTPBAA                        28                           Enabled
"PKG",141,22,1,"PAH",1,1,36,0)
     PSU SEND                        13
"PKG",141,22,1,"PAH",1,1,37,0)
     TEST       21        21         21        21         SS      Idle
"PKG",141,22,1,"PAH",1,1,38,0)
 
"PKG",141,22,1,"PAH",1,1,39,0)
     Incoming filers running => Zero     TaskMan running
"PKG",141,22,1,"PAH",1,1,40,0)
     Outgoing filers running => Zero     ***LINK MANAGER NOT RUNNING!!!***
"PKG",141,22,1,"PAH",1,1,41,0)
                                             Monitor OVERDUE
"PKG",141,22,1,"PAH",1,1,42,0)
    Select a Command:
"PKG",141,22,1,"PAH",1,1,43,0)
 
"PKG",141,22,1,"PAH",1,1,44,0)
  b) If the PSOTPBAAC logical link is enabled then you need to shut down
"PKG",141,22,1,"PAH",1,1,45,0)
     the link by doing the following:
"PKG",141,22,1,"PAH",1,1,46,0)
     - Use the HL7 Main Menu Option [HL MAIN]
"PKG",141,22,1,"PAH",1,1,47,0)
     - Select the Filer and Link Management Options
"PKG",141,22,1,"PAH",1,1,48,0)
        [HL MENU FILER LINK MGT]
"PKG",141,22,1,"PAH",1,1,49,0)
     - Select the 'Start/Stop Links' option [HL START]
"PKG",141,22,1,"PAH",1,1,50,0)
     - At the 'Select HL LOGICAL LINK NODE: ' prompt, type PSOTPBAAC and
"PKG",141,22,1,"PAH",1,1,51,0)
       press enter. The system will prompt 'Okay to shut down this job?',
"PKG",141,22,1,"PAH",1,1,52,0)
       answer 'YES' and press enter.
"PKG",141,22,1,"PAH",1,1,53,0)
       The system will display the following message:
"PKG",141,22,1,"PAH",1,1,54,0)
       'The job for the PSOTPBAAC Lower Level Protocol will be shut down.'
"PKG",141,22,1,"PAH",1,1,55,0)
     - To ensure the link is shut down use the Systems Link Monitor [HL
"PKG",141,22,1,"PAH",1,1,56,0)
       MESSAGE MONITOR] option and make sure the status is 'Shutdown'
"PKG",141,22,1,"PAH",1,1,57,0)
       (step a. above).
"PKG",141,22,1,"PAH",1,1,58,0)
*************************************************************************
"PKG",141,22,1,"PAH",1,1,59,0)
*** Step II - Automated Step                                          ***
"PKG",141,22,1,"PAH",1,1,60,0)
*************************************************************************
"PKG",141,22,1,"PAH",1,1,61,0)
1. This patch disables the following menu options by placing them to
"PKG",141,22,1,"PAH",1,1,62,0)
   be out of order:
"PKG",141,22,1,"PAH",1,1,63,0)
      - TPB HL7 Data Extract/Transmission [PSO TPB HL7 EXTRACT]
"PKG",141,22,1,"PAH",1,1,64,0)
      - TPB Institution Letter Enter/Edit [PSO TPB INSTITUTION LETTERS]
"PKG",141,22,1,"PAH",1,1,65,0)
      - Report TPB Patients Letters Printed/NOT Printed
"PKG",141,22,1,"PAH",1,1,66,0)
         [PSO TPB LETTERS PRINTED REPORT]
"PKG",141,22,1,"PAH",1,1,67,0)
      - Transitional Pharmacy Benefit Patient Enter/Edit
"PKG",141,22,1,"PAH",1,1,68,0)
         [PSO TPB PATIENT ENTER/EDIT]
"PKG",141,22,1,"PAH",1,1,69,0)
      - TPB Patient Report [PSO TPB PATIENT REPORT]
"PKG",141,22,1,"PAH",1,1,70,0)
      - Report of Patients with TPB and Non-TPB Rx's
"PKG",141,22,1,"PAH",1,1,71,0)
         [PSO TPB PATIENT RX REPORT]
"PKG",141,22,1,"PAH",1,1,72,0)
      - Print TPB Patient Letter(s) [PSO TPB PRINT LETTERS]
"PKG",141,22,1,"PAH",1,1,73,0)
      - TPB Rx (Prescription) Entry [PSO TPB RX ENTRY]
"PKG",141,22,1,"PAH",1,1,74,0)
 
"PKG",141,22,1,"PAH",1,1,75,0)
2. Inactivation of all active TPB patients
"PKG",141,22,1,"PAH",1,1,76,0)
   This patch will scan all the entries in the TPB ELIGIBILITY file
"PKG",141,22,1,"PAH",1,1,77,0)
   (#52.91) and will stuff the INACTIVATION OF BENEFIT DATE field (#2)
"PKG",141,22,1,"PAH",1,1,78,0)
   of the active patients with today's date and the INACTIVATION REASON
"PKG",141,22,1,"PAH",1,1,79,0)
   CODE field (#3) with the code "10-PROGRAM ENDED".
"PKG",141,22,1,"PAH",1,1,80,0)
 
"PKG",141,22,1,"PAH",1,1,81,0)
3. When a prescription is discontinued, routine PSOTPCAN is called to
"PKG",141,22,1,"PAH",1,1,82,0)
   check if that's the last active TPB prescription for an Active TPB
"PKG",141,22,1,"PAH",1,1,83,0)
   patient, and if so, the patient TPB patient is inactivated from TPB
"PKG",141,22,1,"PAH",1,1,84,0)
   ELIGIBILITY file (#52.91). Based on the fact that there will be no
"PKG",141,22,1,"PAH",1,1,85,0)
   active TPB patient upon installing of this patch, routine PSOTPCAN is
"PKG",141,22,1,"PAH",1,1,86,0)
   modified to quit without checking for last active TPB prescription.
"PKG",141,22,1,"PAH",1,1,87,0)
 
"PKG",141,22,1,"PAH",1,1,88,0)
4. Prior to this patch, Outpatient Pharmacy software used to be notified
"PKG",141,22,1,"PAH",1,1,89,0)
   by the Scheduling software every time a patient has an appointment at a
"PKG",141,22,1,"PAH",1,1,90,0)
   VA clinic. If the patient is eligible for the TPB benefit, the
"PKG",141,22,1,"PAH",1,1,91,0)
   appointment was at a clinic defined as primary care for the TPB program
"PKG",141,22,1,"PAH",1,1,92,0)
   (determined through a set of clinic stop codes) AND the patient does
"PKG",141,22,1,"PAH",1,1,93,0)
   not have any "active" TPB prescription(s) on file, this patient will
"PKG",141,22,1,"PAH",1,1,94,0)
   have the TPB eligibility automatically inactivated (introduced by
"PKG",141,22,1,"PAH",1,1,95,0)
   PSO*7*160). As all active TPB patient's will be inactivated (item #2
"PKG",141,22,1,"PAH",1,1,96,0)
   above), there is no need for this functionality to continue. This patch
"PKG",141,22,1,"PAH",1,1,97,0)
   will stop this functionality by removing the PSO TPB SD SUB protocol
"PKG",141,22,1,"PAH",1,1,98,0)
   entry from the SDAM APPOINTMENT EVENTS Scheduling protocol.
"PKG",141,22,1,"PAH",1,1,99,0)
 
"PKG",141,22,1,"PAH",1,1,100,0)
5. This patch will set the AUTOSTART field (#4.5) of the HL LOGICAL LINK
"PKG",141,22,1,"PAH",1,1,101,0)
   file (#870) of the PSOTPBAAC Logical Link to "Disabled", to prevent
"PKG",141,22,1,"PAH",1,1,102,0)
   restarting of the PSOTPBAAC logical link by TaskMan after a system
"PKG",141,22,1,"PAH",1,1,103,0)
   reboot.
"PKG",141,22,1,"PAH",1,1,104,0)
 
"PKG",141,22,1,"PAH",1,1,105,0)
6. The TPB data extraction job is queued to run daily and transmit
"PKG",141,22,1,"PAH",1,1,106,0)
   data to the AAC every Sunday. This patch will remove the TPB HL7 Data
"PKG",141,22,1,"PAH",1,1,107,0)
   Extract/Transmission [PSO TPB HL7 EXTRACT] option from the Task
"PKG",141,22,1,"PAH",1,1,108,0)
   Manager.
"PKG",141,22,1,"PAH",1,1,109,0)
 
"PKG",141,22,1,"PAH",1,1,110,0)
Note:
"PKG",141,22,1,"PAH",1,1,111,0)
     - The post install routine (PSO227PO) included in this patch
"PKG",141,22,1,"PAH",1,1,112,0)
       addresses all items in step II except #3.
"PKG",141,22,1,"PAH",1,1,113,0)
     - Most of the TPB routines that are transported in this patch are
"PKG",141,22,1,"PAH",1,1,114,0)
       modified to "QUIT" if they are ever called by any other routine.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
12
"RTN","PSO227PO")
0^^B4735601
"RTN","PSO227PO",1,0)
PSO227PO ;BIR/SJA-Patch 227 Post Install routine ;11/25/05
"RTN","PSO227PO",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**227**;DEC 1997
"RTN","PSO227PO",3,0)
 ;
"RTN","PSO227PO",4,0)
 ; Reference to ^ORD(101 is supported by DBIA #872
"RTN","PSO227PO",5,0)
 ; External reference to file 870 is supported by DBIA #1496
"RTN","PSO227PO",6,0)
 ; 
"RTN","PSO227PO",7,0)
 N CNT,PSOA,PSODT,PSONODE,PSORESN,PSOPRTCL,PSOPRT,SDPRTCL
"RTN","PSO227PO",8,0)
 ;Set AUTOSTART to Disabled for PSOTPBAAC Logical Link
"RTN","PSO227PO",9,0)
 N DIE,DR,DIC,DA,X,Y
"RTN","PSO227PO",10,0)
 K DIC S DIC(0)="X",DIC=870,X="PSOTPBAAC" D ^DIC K DIC
"RTN","PSO227PO",11,0)
 I +Y>0 K DIE S DA=+Y,DIE=870,DR="4.5////"_0 D ^DIE K DA,DR,DIE
"RTN","PSO227PO",12,0)
 ;
"RTN","PSO227PO",13,0)
 D RESCH^XUTMOPT("PSO TPB HL7 EXTRACT","@","","@")
"RTN","PSO227PO",14,0)
OUT D BMES^XPDUTL("...Placing TPB menu options out of order...")
"RTN","PSO227PO",15,0)
 ;Disable TPB menu options
"RTN","PSO227PO",16,0)
 S PSORESN="PLACED OUT OF ORDER BY PSO*7*227"
"RTN","PSO227PO",17,0)
 D OUT^XPDMENU("PSO TPB HL7 EXTRACT",PSORESN)
"RTN","PSO227PO",18,0)
 D OUT^XPDMENU("PSO TPB INSTITUTION LETTERS",PSORESN)
"RTN","PSO227PO",19,0)
 D OUT^XPDMENU("PSO TPB LETTERS PRINTED REPORT",PSORESN)
"RTN","PSO227PO",20,0)
 D OUT^XPDMENU("PSO TPB PATIENT ENTER/EDIT",PSORESN)
"RTN","PSO227PO",21,0)
 D OUT^XPDMENU("PSO TPB PATIENT REPORT",PSORESN)
"RTN","PSO227PO",22,0)
 D OUT^XPDMENU("PSO TPB PATIENT RX REPORT",PSORESN)
"RTN","PSO227PO",23,0)
 D OUT^XPDMENU("PSO TPB PRINT LETTERS",PSORESN)
"RTN","PSO227PO",24,0)
 D OUT^XPDMENU("PSO TPB RX ENTRY",PSORESN)
"RTN","PSO227PO",25,0)
 ;
"RTN","PSO227PO",26,0)
IACT D BMES^XPDUTL("...Inactivating all active TPB patients...")
"RTN","PSO227PO",27,0)
 D NOW^%DTC S PSODT=$P(%,".")
"RTN","PSO227PO",28,0)
 S (PSOA,CNT)=0 F  S PSOA=$O(^PS(52.91,PSOA)) Q:'PSOA  S PSONODE=$G(^(PSOA,0)) I '$P(PSONODE,"^",3)!($P(PSONODE,"^",3)>PSODT) D
"RTN","PSO227PO",29,0)
 .S DA=PSOA,DIE="^PS(52.91,",DR="2///"_PSODT_";3///10" D ^DIE K DIE,DA,DR
"RTN","PSO227PO",30,0)
 .S CNT=CNT+1 W:'(CNT#10) "."
"RTN","PSO227PO",31,0)
 ;
"RTN","PSO227PO",32,0)
PRTCL ;Unsubscribe the Pharmacy PSO TPB SD SUB protocol from the Scheduling protocol SDAM APPOINTMENT EVENTS
"RTN","PSO227PO",33,0)
 S SDPRTCL=$O(^ORD(101,"B","SDAM APPOINTMENT EVENTS",0))
"RTN","PSO227PO",34,0)
 S PSOPRTCL=$O(^ORD(101,"B","PSO TPB SD SUB",0))
"RTN","PSO227PO",35,0)
 I 'SDPRTCL!'PSOPRTCL Q
"RTN","PSO227PO",36,0)
 S PSOPRT=$O(^ORD(101,SDPRTCL,10,"B",PSOPRTCL,0)) I 'PSOPRT Q
"RTN","PSO227PO",37,0)
 K DA,DIK S DA=PSOPRT,DA(1)=SDPRTCL,DIK="^ORD(101,"_DA(1)_",10," D ^DIK K DA,DIK
"RTN","PSO227PO",38,0)
 Q
"RTN","PSOHELP1")
0^1^B45597408
"RTN","PSOHELP1",1,0)
PSOHELP1 ;BIR/SAB-OUTPATIENT HELP TEXT/UTILITY ROUTINE 2 ;11/09/92
"RTN","PSOHELP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**23,36,88,146,227**;DEC 1997
"RTN","PSOHELP1",3,0)
 ;External reference ^DIC(19.2 supported by DBIA 1472
"RTN","PSOHELP1",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOHELP1",5,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOHELP1",6,0)
2001 N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOHELP1",7,0)
 S PSOHLP(1)="Enter the lowest prescription number for this site."
"RTN","PSOHELP1",8,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOHELP1",9,0)
 S PSOHLP(2)="If this is the first time you are entering this field,"
"RTN","PSOHELP1",10,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOHELP1",11,0)
 S PSOHLP(3)="you should pick a number LARGER than the last prescription number used."
"RTN","PSOHELP1",12,0)
 S PSOHLP(4,"F")="!!"
"RTN","PSOHELP1",13,0)
 D WRITE
"RTN","PSOHELP1",14,0)
 Q
"RTN","PSOHELP1",15,0)
 ;
"RTN","PSOHELP1",16,0)
2002 N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOHELP1",17,0)
 S PSOHLP(1)="Enter the largest acceptable prescription number for this site."
"RTN","PSOHELP1",18,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOHELP1",19,0)
 S PSOHLP(2)="The difference between this number and the lowest prescription"
"RTN","PSOHELP1",20,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOHELP1",21,0)
 S PSOHLP(3)="number should be substantial. The system will not allow numbers"
"RTN","PSOHELP1",22,0)
 S PSOHLP(4,"F")="!"
"RTN","PSOHELP1",23,0)
 S PSOHLP(4)="larger than the one you choose. It will give a warning message"
"RTN","PSOHELP1",24,0)
 S PSOHLP(5,"F")="!"
"RTN","PSOHELP1",25,0)
 S PSOHLP(5)="and not allow entry of any more prescriptions."
"RTN","PSOHELP1",26,0)
 S PSOHLP(6,"F")="!!"
"RTN","PSOHELP1",27,0)
 D WRITE
"RTN","PSOHELP1",28,0)
 Q
"RTN","PSOHELP1",29,0)
 ;
"RTN","PSOHELP1",30,0)
2003 N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOHELP1",31,0)
 S PSOHLP(1)="Enter the last prescription number used."
"RTN","PSOHELP1",32,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOHELP1",33,0)
 S PSOHLP(2)="If you are entering this for the first time, this number"
"RTN","PSOHELP1",34,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOHELP1",35,0)
 S PSOHLP(3)="should be the same as the number you entered for LOW RX#."
"RTN","PSOHELP1",36,0)
 S PSOHLP(4,"F")="!"
"RTN","PSOHELP1",37,0)
 S PSOHLP(4)="The system will take this number, increment it by one"
"RTN","PSOHELP1",38,0)
 S PSOHLP(5,"F")="!"
"RTN","PSOHELP1",39,0)
 S PSOHLP(5)="until it finds a number that has not been used, and then"
"RTN","PSOHELP1",40,0)
 S PSOHLP(6,"F")="!"
"RTN","PSOHELP1",41,0)
 S PSOHLP(6)="use that number for the next prescription."
"RTN","PSOHELP1",42,0)
 S PSOHLP(7,"F")="!!"
"RTN","PSOHELP1",43,0)
 D WRITE
"RTN","PSOHELP1",44,0)
 Q
"RTN","PSOHELP1",45,0)
WRITE ;EN^DDIOL call
"RTN","PSOHELP1",46,0)
 D EN^DDIOL(.PSOHLP) K PSOHLP
"RTN","PSOHELP1",47,0)
 Q
"RTN","PSOHELP1",48,0)
AUTOQ ;entry point to queue all background jobs
"RTN","PSOHELP1",49,0)
 D:0 RESET1^PSOTPHL1  ;placed out of order by PSO*7*227
"RTN","PSOHELP1",50,0)
 D AUTO^PSOAUTOC ;ques auto cancel job
"RTN","PSOHELP1",51,0)
 D SETUP^PSOAUTOC ;ques nightly cost compile
"RTN","PSOHELP1",52,0)
 D SETUP1^PSOAUTOC ;ques nightly mgmt compile
"RTN","PSOHELP1",53,0)
 D QUP,CLO ;ques amis compile
"RTN","PSOHELP1",54,0)
 D SETUP^PSOHLEXP ;ques exipration status update
"RTN","PSOHELP1",55,0)
 D AUTO^PSOSUDEL ;ques job to deleted rxs printed from 52.5
"RTN","PSOHELP1",56,0)
CLO K Y,C,D,D0,DI,DQ,DA,DIE,DR,DIC,Y,X,PSOTM,PSOOPTN,%DT,PSOPTN
"RTN","PSOHELP1",57,0)
 Q
"RTN","PSOHELP1",58,0)
QUP K %DT,DIC,DTOUT S DIC(0)="XZM",DIC="^DIC(19.2,",X="PSO AMIS COMPILE" D ^DIC
"RTN","PSOHELP1",59,0)
 I +Y>0 D EDIT^XUTMOPT("PSO AMIS COMPILE") G CLO
"RTN","PSOHELP1",60,0)
 D RESCH^XUTMOPT("PSO AMIS COMPILE","","","24H","L"),EDIT^XUTMOPT("PSO AMIS COMPILE")
"RTN","PSOHELP1",61,0)
 Q
"RTN","PSOHELP1",62,0)
EXP ;reset "P","A" xref in 55 from cancel option
"RTN","PSOHELP1",63,0)
 Q:$G(REA)="C"
"RTN","PSOHELP1",64,0)
 S PCD=+$P($G(^PSRX(DA,3)),"^",5) I 'PCD D  K EXP,PCD,IFN Q
"RTN","PSOHELP1",65,0)
 .S (IFN,EXP)=0
"RTN","PSOHELP1",66,0)
 .F  S EXP=$O(^PS(55,PSODFN,"P","A",EXP)) Q:'EXP  F  S IFN=$O(^PS(55,PSODFN,"P","A",EXP,IFN)) Q:'IFN  I IFN=DA K ^PS(55,PSODFN,"P","A",EXP,DA) S ^PS(55,PSODFN,"P","A",$P(^PSRX(DA,2),"^",6),DA)=""
"RTN","PSOHELP1",67,0)
 K ^PS(55,PSODFN,"P","A",PCD,DA) S ^PS(55,PSODFN,"P","A",$P(^PSRX(DA,2),"^",6),DA)="",$P(^PSRX(DA,3),"^",5)=""
"RTN","PSOHELP1",68,0)
 K PCD Q
"RTN","PSOHELP1",69,0)
SREF ;set "P","A" xref in 55 from fileman
"RTN","PSOHELP1",70,0)
 I $P($G(^PSRX(X,"STA")),"^")=12,'$P($G(^PSRX(X,3)),"^",5) D  Q
"RTN","PSOHELP1",71,0)
 .F PX=0:0 S PA=$O(^PSRX(X,"A",PX)) Q:'PX  S:$P(^PSRX(X,"A",PX,0),"^",2)="C" PCD=$P($P(^PSRX(X,"A",PX,0),"^"),".")
"RTN","PSOHELP1",72,0)
 .I $G(PCD) S ^PS(55,DA(1),"P","A",PCD,X)="",$P(^PSRX(X,3),"^",5)=PCD
"RTN","PSOHELP1",73,0)
 .E  S:$P($G(^PSRX(X,2)),"^",6) ^PS(55,DA(1),"P","A",$P(^PSRX(X,2),"^",6),X)=""
"RTN","PSOHELP1",74,0)
 .K PCD,PX
"RTN","PSOHELP1",75,0)
 I $P($G(^PSRX(X,"STA")),"^")=12,$P($G(^PSRX(X,3)),"^",5) S ^PS(55,DA(1),"P","A",$P(^PSRX(X,3),"^",5),X)="" Q
"RTN","PSOHELP1",76,0)
 S:$P($G(^PSRX(X,2)),"^",6) ^PS(55,DA(1),"P","A",$P(^PSRX(X,2),"^",6),X)=""
"RTN","PSOHELP1",77,0)
 Q
"RTN","PSOHELP1",78,0)
KREF ;kill "P","A" xref in 55 from fileman
"RTN","PSOHELP1",79,0)
 K:+$P($G(^PSRX(X,2)),"^",6) ^PS(55,DA(1),"P","A",+$P(^PSRX(X,2),"^",6),X)
"RTN","PSOHELP1",80,0)
 I $P($G(^PSRX(X,"STA")),"^")=12,'$P($G(^PSRX(X,3)),"^",5) D  K PCD,PX Q
"RTN","PSOHELP1",81,0)
 .F PX=0:0 S A=$O(^PSRX(X,"A",PX)) Q:'PX  S:$P(^PSRX(X,"A",PX,0),"^",2)="C" PCD=$P($P(^PSRX(X,"A",PX,0),"^"),".")
"RTN","PSOHELP1",82,0)
 .I $G(PCD) K ^PS(55,DA(1),"P","A",PCD,X)
"RTN","PSOHELP1",83,0)
 I $P($G(^PSRX(X,"STA")),"^")=12,$P($G(^PSRX(X,3)),"^",5) K ^PS(55,DA(1),"P","A",$P(^PSRX(X,3),"^",5),X)
"RTN","PSOHELP1",84,0)
 Q
"RTN","PSOHELP1",85,0)
DAYS K PSMAX I $P($G(^PSDRUG(+$P(^PSRX(DA,0),"^",6),0)),"^",4),$P(^PSRX(DA,0),"^",7)/X>$P($G(^PSDRUG(+$P(^PSRX(DA,0),"^",6),0)),"^",4) D EN^DDIOL("Max Daily Dose of "_$P($G(^(0)),"^",4)_" Exceeded","","$C(7),!?5") D EN^DDIOL(" ","","!")
"RTN","PSOHELP1",86,0)
 S PSDAYS=$P(^PSRX(DA,0),"^",8),PSRF=+$P(^(0),"^",9),PTST=$G(^PS(53,$P(^(0),"^",3),0)),PTDY=$P(PTST,"^",3),PTRF=$P(PTST,"^",4),PSODEA=$P(^PSDRUG($P(^PSRX(DA,0),"^",6),0),"^",3),CS=0
"RTN","PSOHELP1",87,0)
 D NARC I $G(CLOZPAT)=1,'PSRF,X>14 K X D EN^DDIOL("     14 Day Supply Max for Clozapine Prescriptions.","","$C(7),!!") Q
"RTN","PSOHELP1",88,0)
 I $G(CLOZPAT)=0,'PSRF,X>7 K X D EN^DDIOL("     7 Day Supply Max for Clozapine Prescriptions.","","$C(7),!!") Q
"RTN","PSOHELP1",89,0)
 I $G(CLOZPAT)=1,X'=7,PSRF K X D EN^DDIOL("     Day Supply Must Equal 7 with 1 refill for Clozapine Prescriptions.","","$C(7),!!") Q
"RTN","PSOHELP1",90,0)
 I PSRF>MAX S DS=X D
"RTN","PSOHELP1",91,0)
 .D FULL^VALM1,EN^DDIOL(PSRF_" refills are not correct for a "_DS_" day supply.","","$C(7),!!") D EN^DDIOL("Please enter correct # of refills for a "_DS_" day supply. Max refills allowed is "_MAX_".","","!") D EN^DDIOL(" ","","!")
"RTN","PSOHELP1",92,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,X,Y,DIRUT S VALMBCK="R"
"RTN","PSOHELP1",93,0)
 K PSTMAX,DS D EDSTAT^PSOUTLA
"RTN","PSOHELP1",94,0)
 K MAX,DAYS,PSDAYS,PSODEA,PSOX,PSOX1,PSDY,PSDY1,DEA,CS,PTST,PSRF,PTRF,PTDY
"RTN","PSOHELP1",95,0)
 Q
"RTN","PSOHELP1",96,0)
DAYS1 K PSRMAX S PSRF=$P(^PSRX(DA(1),0),"^",9),PTST=$G(^PS(53,$P(^(0),"^",3),0)),PTDY=$P(PTST,"^",3),PTRF=$P(PTST,"^",4)
"RTN","PSOHELP1",97,0)
 S PSDAYS=$P(^PSRX(DA(1),1,DA,0),"^",10),PSODEA=$P(^PSDRUG($P(^PSRX(DA(1),0),"^",6),0),"^",3),CS=0
"RTN","PSOHELP1",98,0)
 D NARC I PSRF>MAX S DS=X D
"RTN","PSOHELP1",99,0)
 .D EN^DDIOL(PSRF_" refills are not correct for a "_DS_" day supply.","","$C(7),!!") D EN^DDIOL("Please enter correct # of refills for a "_DS_" day supply. Max refills allowed is "_MAX_".","","!") D EN^DDIOL(" ","","!")
"RTN","PSOHELP1",100,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to Continue" D ^DIR K DIR,X,Y,DIRUT S VALMBCK="R"
"RTN","PSOHELP1",101,0)
 K PSTMAX,DS ;D EDSTAT^PSOUTLA
"RTN","PSOHELP1",102,0)
 K MAX,DAYS,PSDAYS,PSODEA,PSOX,PSOX1,PSDY,PSDY1,DEA,CS,PTST,PSRF,PTDY,PTRF
"RTN","PSOHELP1",103,0)
 Q
"RTN","PSOHELP1",104,0)
NARC F DEA=1:1 Q:$E(PSODEA,DEA)=""  I $E(+PSODEA,DEA)>1,$E(+PSODEA,DEA)<6 S CS=1
"RTN","PSOHELP1",105,0)
 I $D(CLOZPAT) S MAX=$S(CLOZPAT=1&($P(^PSRX(DA,0),"^",8)=7):1,1:0),MIN=0 Q
"RTN","PSOHELP1",106,0)
 I CS D
"RTN","PSOHELP1",107,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOX=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOHELP1",108,0)
 .S PSOX=$S('PSOX:0,X=90:1,1:PSOX),PSDY1=$S(X<60:5,X'<60&(X'>89):2,X=90:1,1:0) S MAX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOHELP1",109,0)
 E  D
"RTN","PSOHELP1",110,0)
 .S PSOX1=PTRF,PSOX=$S(PSOX1=11:11,1:PSOX1),PSOX=$S('PSOX:0,X=90:3,1:PSOX)
"RTN","PSOHELP1",111,0)
 .S PSDY1=$S(X<60:11,X'<60&(X'>89):5,X=90:3,1:0) S MAX=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOHELP1",112,0)
 Q
"RTN","PSOTPCAN")
0^2^B56784820
"RTN","PSOTPCAN",1,0)
PSOTPCAN ;BIR/RTR - TPB Utility routine ;08/23/03
"RTN","PSOTPCAN",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**146,153,163,227**;DEC 1997
"RTN","PSOTPCAN",3,0)
 ;External reference to PS(55 supported by DBIA 2228
"RTN","PSOTPCAN",4,0)
 ;External reference to VA(200 supported by DBIA 224
"RTN","PSOTPCAN",5,0)
 ;
"RTN","PSOTPCAN",6,0)
 ;Check Rx being DC'd, if it's a TPB Rx, check to inactivate patient
"RTN","PSOTPCAN",7,0)
 ;Called from all DC actions
"RTN","PSOTPCAN",8,0)
CAN(PSOTPRCX) ;
"RTN","PSOTPCAN",9,0)
 Q  ; placed out of order by PSO*7*227
"RTN","PSOTPCAN",10,0)
 I '$G(PSOTPRCX) Q
"RTN","PSOTPCAN",11,0)
 N PSOTPRC
"RTN","PSOTPCAN",12,0)
 S PSOTPRC=$P($G(^PSRX(PSOTPRCX,0)),"^",2)
"RTN","PSOTPCAN",13,0)
 I '$G(PSOTPRC) Q
"RTN","PSOTPCAN",14,0)
 I '$P($G(^PSRX(PSOTPRCX,"TPB")),"^") Q
"RTN","PSOTPCAN",15,0)
 I '$D(^PS(52.91,PSOTPRC,0)) Q
"RTN","PSOTPCAN",16,0)
 I $P($G(^PS(52.91,PSOTPRC,0)),"^",3),$P($G(^(0)),"^",3)'>DT Q
"RTN","PSOTPCAN",17,0)
 ;Patient is active in the TPB File, and TPB Rx is being canceled
"RTN","PSOTPCAN",18,0)
 I PSOTPRC'=$P($G(^PSRX(PSOTPRCX,0)),"^",2) Q
"RTN","PSOTPCAN",19,0)
 N PSOTPCSS,PSOTCXFL,PSOTC1,PSOTC2,PSOTC3,X1,X2,DA,DR,DIE,X,Y
"RTN","PSOTPCAN",20,0)
 S PSOTCXFL=0
"RTN","PSOTPCAN",21,0)
 S X1=DT,X2=-1 D C^%DTC S PSOTC3=X
"RTN","PSOTPCAN",22,0)
 F PSOTC1=PSOTC3:0 S PSOTC1=$O(^PS(55,PSOTPRC,"P","A",PSOTC1)) Q:'PSOTC1!(PSOTCXFL)  S PSOTC2="" F  S PSOTC2=$O(^PS(55,PSOTPRC,"P","A",PSOTC1,PSOTC2)) Q:PSOTC2=""!(PSOTCXFL)  D
"RTN","PSOTPCAN",23,0)
 .I $P($G(^PSRX(PSOTC2,0)),"^",2)'=PSOTPRC Q
"RTN","PSOTPCAN",24,0)
 .S PSOTPCSS=$P($G(^PSRX(PSOTC2,"STA")),"^")
"RTN","PSOTPCAN",25,0)
 .I PSOTPCSS'=0,PSOTPCSS'=1,PSOTPCSS'=2,PSOTPCSS'=3,PSOTPCSS'=4,PSOTPCSS'=5,PSOTPCSS'=16 Q
"RTN","PSOTPCAN",26,0)
 .I $P($G(^PSRX(PSOTC2,"TPB")),"^"),$P($G(^(2)),"^",6)'<DT S PSOTCXFL=1
"RTN","PSOTPCAN",27,0)
 I 'PSOTCXFL K DA,DIE,DR S DA=PSOTPRC,DIE="^PS(52.91,",DR="2////"_DT_";3////"_6 D ^DIE K DIE,DA,DR
"RTN","PSOTPCAN",28,0)
 Q
"RTN","PSOTPCAN",29,0)
 ;
"RTN","PSOTPCAN",30,0)
MARK ;Mark Rx as TPB Rx if applicable
"RTN","PSOTPCAN",31,0)
 N PSOTPODE,PSOZTRX
"RTN","PSOTPCAN",32,0)
 I '$G(PSOX("IRXN")) Q
"RTN","PSOTPCAN",33,0)
 I '$D(^PSRX(PSOX("IRXN"),0)) Q
"RTN","PSOTPCAN",34,0)
 I '$G(PSOTPBFG) Q
"RTN","PSOTPCAN",35,0)
 ;I $G(PSOFDR) Q
"RTN","PSOTPCAN",36,0)
 S PSOTPODE=$G(^PSRX(PSOX("IRXN"),0))
"RTN","PSOTPCAN",37,0)
 I '$P(PSOTPODE,"^",2)!('$P(PSOTPODE,"^",3))!('$P(PSOTPODE,"^",4)) Q
"RTN","PSOTPCAN",38,0)
 S PSOZTRX=$P($G(^PS(53,+$P(PSOTPODE,"^",3),0)),"^") I $$UP^XLFSTR(PSOZTRX)'="NON-VA" Q
"RTN","PSOTPCAN",39,0)
 I '$P($G(^VA(200,+$P(PSOTPODE,"^",4),"TPB")),"^") Q
"RTN","PSOTPCAN",40,0)
 I $P($G(^VA(200,+$P(PSOTPODE,"^",4),"TPB")),"^",5)'=0 Q
"RTN","PSOTPCAN",41,0)
 I '$D(^PS(52.91,+$P(PSOTPODE,"^",2),0)) Q
"RTN","PSOTPCAN",42,0)
 I $P($G(^PS(52.91,+$P(PSOTPODE,"^",2),0)),"^",3),$P($G(^(0)),"^",3)'>DT Q
"RTN","PSOTPCAN",43,0)
 ;Hard setting, to avoid DIE kiling any needed variables, no cross references on field, if added, need to use FileMan here
"RTN","PSOTPCAN",44,0)
 S $P(^PSRX(PSOX("IRXN"),"TPB"),"^")=1
"RTN","PSOTPCAN",45,0)
 Q
"RTN","PSOTPCAN",46,0)
MARKV ;Mark from Verify action
"RTN","PSOTPCAN",47,0)
 N PSOTPV1,PSOTPV2
"RTN","PSOTPCAN",48,0)
 I '$G(PSONVLP) Q
"RTN","PSOTPCAN",49,0)
 I '$D(^PSRX(PSONVLP,0)) Q
"RTN","PSOTPCAN",50,0)
 I '$G(PSOTPBFG) Q
"RTN","PSOTPCAN",51,0)
 ;I $G(PSOFDR) Q
"RTN","PSOTPCAN",52,0)
 S PSOTPV1=$G(^PSRX(PSONVLP,0))
"RTN","PSOTPCAN",53,0)
 I '$P(PSOTPV1,"^",2)!('$P(PSOTPV1,"^",3))!('$P(PSOTPV1,"^",4)) Q
"RTN","PSOTPCAN",54,0)
 S PSOTPV2=$P($G(^PS(53,+$P(PSOTPV1,"^",3),0)),"^") I $$UP^XLFSTR(PSOTPV2)'="NON-VA" Q
"RTN","PSOTPCAN",55,0)
 I '$P($G(^VA(200,+$P(PSOTPV1,"^",4),"TPB")),"^") Q
"RTN","PSOTPCAN",56,0)
 I $P($G(^VA(200,+$P(PSOTPV1,"^",4),"TPB")),"^",5)'=0 Q
"RTN","PSOTPCAN",57,0)
 I '$D(^PS(52.91,+$P(PSOTPV1,"^",2),0)) Q
"RTN","PSOTPCAN",58,0)
 I $P($G(^PS(52.91,+$P(PSOTPV1,"^",2),0)),"^",3),$P($G(^(0)),"^",3)'>DT Q
"RTN","PSOTPCAN",59,0)
 S $P(^PSRX(PSONVLP,"TPB"),"^")=1
"RTN","PSOTPCAN",60,0)
 Q
"RTN","PSOTPCAN",61,0)
RXPAT ;Sets Rx patient status to null
"RTN","PSOTPCAN",62,0)
 N PSOZZTRX
"RTN","PSOTPCAN",63,0)
 I $G(X),$G(X)'>DT D
"RTN","PSOTPCAN",64,0)
 .S PSOZZTRX=$P($G(^PS(53,+$P($G(^PS(55,DA,"PS")),"^"),0)),"^") S PSOZZTRX=$$UP^XLFSTR(PSOZZTRX) I PSOZZTRX="NON-VA" S $P(^PS(55,DA,"PS"),"^")=""
"RTN","PSOTPCAN",65,0)
 Q
"RTN","PSOTPCAN",66,0)
SET(PSOTPPST) ;Pass in DFN on a hard set of INACTIVATION OF BENEFIT DATE
"RTN","PSOTPCAN",67,0)
 N PSOZXTRX
"RTN","PSOTPCAN",68,0)
 I $P($G(^PS(52.91,PSOTPPST,0)),"^",3),$P($G(^(0)),"^",3)'>DT S PSOZXTRX=$P($G(^PS(53,+$P($G(^PS(55,PSOTPPST,"PS")),"^"),0)),"^") I $$UP^XLFSTR(PSOZXTRX)="NON-VA" S $P(^PS(55,PSOTPPST,"PS"),"^")=""
"RTN","PSOTPCAN",69,0)
 Q
"RTN","PSOTPCAN",70,0)
PCAP(PSOPAPPT) ;Find nearest Primary Care appointment
"RTN","PSOTPCAN",71,0)
 Q "TODAY AT NOON"
"RTN","PSOTPCAN",72,0)
 ;
"RTN","PSOTPCAN",73,0)
PDIR(PSOTPEX) ;
"RTN","PSOTPCAN",74,0)
 Q:'$G(PSOTPEX)
"RTN","PSOTPCAN",75,0)
 N PSOTPEXS
"RTN","PSOTPCAN",76,0)
 S PSOTPEXT=0
"RTN","PSOTPCAN",77,0)
 S PSOTPEXS=$P($G(^DPT(PSOTPEX,0)),"^",9)
"RTN","PSOTPCAN",78,0)
 W !!?10,$C(7),$P($G(^DPT(PSOTPEX,0)),"^")_" ("_$E(PSOTPEXS,1,3)_"-"_$E(PSOTPEXS,4,5)_"-"_$E(PSOTPEXS,6,9)_")"
"RTN","PSOTPCAN",79,0)
 W !?10,"Patient is eligible for the Transitional Pharmacy Benefit!!"
"RTN","PSOTPCAN",80,0)
 W ! K DIR S DIR(0)="E",DIR("A")="Press <ret> to continue, '^' to exit"  D ^DIR K DIR I Y'=1 S PSOTPEXT=1
"RTN","PSOTPCAN",81,0)
 Q
"RTN","PSOTPCAN",82,0)
VOPN ;
"RTN","PSOTPCAN",83,0)
 I '$G(PSOTPPEN) Q
"RTN","PSOTPCAN",84,0)
 I '$D(^PSRX(PSOTPPEN,0)) Q
"RTN","PSOTPCAN",85,0)
 N PSOTPPE3,PSOTPPE4,PSOTPPE5,PSOTPPE6,PSOTPPE7,PSOTPPE8
"RTN","PSOTPCAN",86,0)
 S PSOTPPE6=1
"RTN","PSOTPCAN",87,0)
 S PSOTPPE3=$P($G(^PSRX(PSOTPPEN,0)),"^",3),PSOTPPE4=$P($G(^PSRX(PSOTPPEN,0)),"^",4)
"RTN","PSOTPCAN",88,0)
VOPNX ;
"RTN","PSOTPCAN",89,0)
 I 'PSOTPPE4 S PSOTPPEX=1,PSOTPPE5(PSOTPPE6)="Unknown Provider!",PSOTPPE6=PSOTPPE6+1
"RTN","PSOTPCAN",90,0)
 I 'PSOTPPE3 S PSOTPPEX=1 S PSOTPPE5(PSOTPPE6)="Unknown Patient Status!",PSOTPPE6=PSOTPPE6+1
"RTN","PSOTPCAN",91,0)
 I PSOTPPE4,'$P($G(^VA(200,PSOTPPE4,"TPB")),"^") S PSOTPPE5(PSOTPPE6)="Provider is not flagged as a NON-VA PRESCRIBER!",PSOTPPE6=PSOTPPE6+1,PSOTPPEX=1
"RTN","PSOTPCAN",92,0)
 I PSOTPPE4,$P($G(^VA(200,PSOTPPE4,"TPB")),"^",5)'=0 S PSOTPPE5(PSOTPPE6)="Provider is not flagged as not being on exclusionary list!",PSOTPPE6=PSOTPPE6+1,PSOTPPEX=1
"RTN","PSOTPCAN",93,0)
 I PSOTPPE3 S PSOTPPE7=$P($G(^PS(53,PSOTPPE3,0)),"^") S PSOTPPE7=$$UP^XLFSTR(PSOTPPE7) I PSOTPPE7'="NON-VA" S PSOTPPE5(PSOTPPE6)="Rx Patient Status is not equal to 'NON-VA'!",PSOTPPE6=PSOTPPE6+1,PSOTPPEX=1
"RTN","PSOTPCAN",94,0)
 I $G(PSOTPPEX) D  I $G(PSOTPPE9) S VALMSG="Cannot Verify through this option"
"RTN","PSOTPCAN",95,0)
 .W ! F PSOTPPE8=0:0 S PSOTPPE8=$O(PSOTPPE5(PSOTPPE8)) Q:'PSOTPPE8  W !,$G(PSOTPPE5(PSOTPPE8))
"RTN","PSOTPCAN",96,0)
 .K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOTPCAN",97,0)
 Q
"RTN","PSOTPCAN",98,0)
VOPNR ;
"RTN","PSOTPCAN",99,0)
 I '$G(PSOTPPEN) Q
"RTN","PSOTPCAN",100,0)
 I '$D(^PS(52.41,PSOTPPEN,0)) Q
"RTN","PSOTPCAN",101,0)
 N PSOTPPE3,PSOTPPE4,PSOTPPE5,PSOTPPE6,PSOTPPE7,PSOTPPE8
"RTN","PSOTPCAN",102,0)
 S PSOTPPE6=1
"RTN","PSOTPCAN",103,0)
 I $P(^PS(52.41,PSOTPPEN,0),"^",3)="RNW",$D(^PSRX(+$P(^PS(52.41,PSOTPPEN,0),"^",21),0)) S PSOTPPE3=$P($G(^PSRX(+$P(^PS(52.41,PSOTPPEN,0),"^",21),0)),"^",3) G NOREN
"RTN","PSOTPCAN",104,0)
 S PSOTPPE3=$P($G(^PS(55,+$P($G(^PS(52.41,PSOTPPEN,0)),"^",2),"PS")),"^")
"RTN","PSOTPCAN",105,0)
NOREN ;
"RTN","PSOTPCAN",106,0)
 S PSOTPPE4=$P($G(^PS(52.41,PSOTPPEN,0)),"^",5)
"RTN","PSOTPCAN",107,0)
 G VOPNX
"RTN","PSOTPCAN",108,0)
 ;
"RTN","PSOTPCAN",109,0)
DSPL(PSOTPWRN) ;
"RTN","PSOTPCAN",110,0)
 N DIR,PSOTPWR1,PSOTPWR2,PSOTPWR3
"RTN","PSOTPCAN",111,0)
 I '$G(PSOTPWRN) Q
"RTN","PSOTPCAN",112,0)
 I '$D(^PS(52.41,PSOTPWRN,0)) Q
"RTN","PSOTPCAN",113,0)
 I $P(^PS(52.41,PSOTPWRN,0),"^",3)="RNW",$D(^PSRX(+$P(^PS(52.41,PSOTPWRN,0),"^",21),0)) D  Q
"RTN","PSOTPCAN",114,0)
 . S PSOTPWR1=$P($G(^PSRX(+$P(^PS(52.41,PSOTPWRN,0),"^",21),0)),"^",3)
"RTN","PSOTPCAN",115,0)
 . S PSOTPWR2=$P($G(^PS(53,+PSOTPWR1,0)),"^"),PSOTPWR3=$$UP^XLFSTR(PSOTPWR2)
"RTN","PSOTPCAN",116,0)
 . I PSOTPWR3="NON-VA" D
"RTN","PSOTPCAN",117,0)
 . . K DIR W !!,"This order has an Rx Patient Status of 'NON-VA'!",! K DIR S DIR(0)="E",DIR("A")="Press return to continue" D ^DIR K DIR
"RTN","PSOTPCAN",118,0)
 . . Q
"RTN","PSOTPCAN",119,0)
 . Q
"RTN","PSOTPCAN",120,0)
 S PSOTPWR1=$P($G(^PS(55,+$P($G(^PS(52.41,PSOTPWRN,0)),"^",2),"PS")),"^")
"RTN","PSOTPCAN",121,0)
 S PSOTPWR2=$P($G(^PS(53,+PSOTPWR1,0)),"^") S PSOTPWR3=$$UP^XLFSTR(PSOTPWR2)
"RTN","PSOTPCAN",122,0)
 I PSOTPWR3="NON-VA" D
"RTN","PSOTPCAN",123,0)
 .W !!,"This order has an Rx Patient Status of 'NON-VA'!",! K DIR S DIR(0)="E",DIR("A")="Press return to continue"  D ^DIR K DIR
"RTN","PSOTPCAN",124,0)
 Q
"RTN","PSOTPCAN",125,0)
EXFLAG(PSOTPPX) ;Exit TPB RX option, reset TPG flag if necessary,
"RTN","PSOTPCAN",126,0)
 ;and possibly delete inactive date and reason code for patient in 52.91
"RTN","PSOTPCAN",127,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOTPCAN",128,0)
 I '$G(PSOTPPX) Q
"RTN","PSOTPCAN",129,0)
 I '$D(^PS(52.91,PSOTPPX,0)) Q
"RTN","PSOTPCAN",130,0)
 I $E($P(^PS(52.91,PSOTPPX,0),"^",3),1,7)'=DT Q
"RTN","PSOTPCAN",131,0)
 I $P(^PS(52.91,PSOTPPX,0),"^",4)'=6 Q
"RTN","PSOTPCAN",132,0)
 N DR,DIE,X1,X2,X,Y,DA,PSOTPPX1,PSOTPPX2,PSOTPPX3,PSOTPPX4,PSOTPPX5,PSOTPPX6,PSOTPPX7,PSOTPPX9
"RTN","PSOTPCAN",133,0)
 S X1=DT,X2=-1 D C^%DTC S PSOTPPX1=X
"RTN","PSOTPCAN",134,0)
 S PSOTPPX9=0
"RTN","PSOTPCAN",135,0)
 F PSOTPPX2=PSOTPPX1:0 S PSOTPPX2=$O(^PS(55,PSOTPPX,"P","A",PSOTPPX2)) Q:'PSOTPPX2  S PSOTPPX3="" F  S PSOTPPX3=$O(^PS(55,PSOTPPX,"P","A",PSOTPPX2,PSOTPPX3)) Q:PSOTPPX3=""  D
"RTN","PSOTPCAN",136,0)
 .I PSOTPPX'=$P($G(^PSRX(PSOTPPX3,0)),"^",2) Q
"RTN","PSOTPCAN",137,0)
 .I $P($G(^PSRX(PSOTPPX3,"TPB")),"^") Q
"RTN","PSOTPCAN",138,0)
 .I $E($P($G(^PSRX(PSOTPPX3,2)),"^"),1,7)'=DT Q
"RTN","PSOTPCAN",139,0)
 .S PSOTPPX4=$P($G(^PSRX(PSOTPPX3,"STA")),"^") I PSOTPPX4="" Q
"RTN","PSOTPCAN",140,0)
 .I PSOTPPX4'=0,PSOTPPX4'=1,PSOTPPX4'=2,PSOTPPX4'=3,PSOTPPX4'=4,PSOTPPX4'=5,PSOTPPX4'=16 Q
"RTN","PSOTPCAN",141,0)
 .S PSOTPPX5=$P(^PSRX(PSOTPPX3,0),"^",3),PSOTPPX6=$P(^(0),"^",4)
"RTN","PSOTPCAN",142,0)
 .I 'PSOTPPX5!('PSOTPPX6) Q
"RTN","PSOTPCAN",143,0)
 .S PSOTPPX7=$P($G(^PS(53,+PSOTPPX5,0)),"^") S PSOTPPX7=$$UP^XLFSTR(PSOTPPX7) I PSOTPPX7'="NON-VA" Q
"RTN","PSOTPCAN",144,0)
 .I '$P($G(^VA(200,PSOTPPX6,"TPB")),"^")!($P($G(^("TPB")),"^",5)'=0) Q
"RTN","PSOTPCAN",145,0)
 .S $P(^PSRX(PSOTPPX3,"TPB"),"^")=1,PSOTPPX9=1
"RTN","PSOTPCAN",146,0)
 I PSOTPPX9 K DA,DIE,DR S DIE="^PS(52.91,",DA=PSOTPPX,DR="2////"_"@"_";3////"_"@" D ^DIE K DIE,DA,DR
"RTN","PSOTPCAN",147,0)
 Q
"RTN","PSOTPCAN",148,0)
 ;
"RTN","PSOTPCAN",149,0)
SCH ;DBIA to return TPB patients to Scheduling
"RTN","PSOTPCAN",150,0)
 N PSOSCT,PSOSCTD
"RTN","PSOTPCAN",151,0)
 K ^TMP($J,"PSODFN")
"RTN","PSOTPCAN",152,0)
 F PSOSCT=0:0 S PSOSCT=$O(^PS(52.91,PSOSCT)) Q:'PSOSCT  I PSOSCT=$P($G(^(PSOSCT,0)),"^") D
"RTN","PSOTPCAN",153,0)
 .S PSOSCTD=$P($G(^PS(52.91,PSOSCT,0)),"^",3)
"RTN","PSOTPCAN",154,0)
 .I 'PSOSCTD!(PSOSCTD>DT) D
"RTN","PSOTPCAN",155,0)
 ..I $P($G(^DPT(PSOSCT,0)),"^")="" Q
"RTN","PSOTPCAN",156,0)
 ..S ^TMP($J,"PSODFN",$P($G(^DPT(PSOSCT,0)),"^"),PSOSCT)=""
"RTN","PSOTPCAN",157,0)
 Q
"RTN","PSOTPCEE")
0^3^B7950417
"RTN","PSOTPCEE",1,0)
PSOTPCEE ;BIR/MHA-transitional pharmacy benefit enter/edit ;07/01/03
"RTN","PSOTPCEE",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**145,153,227**;DEC 1997
"RTN","PSOTPCEE",3,0)
 ;;External reference to SDPHARM1 supported by DBIA 4196
"RTN","PSOTPCEE",4,0)
 ;;External reference ^DIC(4 supported by DBIA 2251
"RTN","PSOTPCEE",5,0)
 Q  ;placed out of order by PSO87*227
"RTN","PSOTPCEE",6,0)
ST N PSODFN,FLG,PSODF,FI,INST,SNO,CDT,UL S FI=52.91,$P(UL,"=",79)="="
"RTN","PSOTPCEE",7,0)
PT K DIC,DIE,PSODFN,FLG,PSODF,REC,INST,SNO,CDT
"RTN","PSOTPCEE",8,0)
 W ! S (DIC,DIE)=52.91,DIC(0)="QEALM",DLAYGO=FI
"RTN","PSOTPCEE",9,0)
 ;S DIC("W")="W ?15,$$GET1^DIQ(2,+Y,.01)"
"RTN","PSOTPCEE",10,0)
 D ^DIC G:+Y'>0 PTX S FLG=$P(Y,"^",3)
"RTN","PSOTPCEE",11,0)
 S (PSODFN,DA)=+Y,DR=.351,DIC=2,DIQ="PSODF" D EN^DIQ1 K DIC,DR,DIQ
"RTN","PSOTPCEE",12,0)
 I $G(PSODF(2,DA,.351))]"",FLG D  G PT
"RTN","PSOTPCEE",13,0)
 .W !!?10,$C(7),"Patient died on "_PSODF(2,PSODFN,.351)_" - Cannot be added to file!!",!
"RTN","PSOTPCEE",14,0)
 .S DIK="^PS(52.91," D ^DIK K DIK
"RTN","PSOTPCEE",15,0)
 L +^PS(FI,DA):0 I '$T W $C(7),!!,"Patient Data is Being Edited by Another User!",! G PT
"RTN","PSOTPCEE",16,0)
 S (INST,SNO)="" D:FLG
"RTN","PSOTPCEE",17,0)
 .S X=$$DEF^SDPHARM1(DA) S:X INST=$P(X,"^"),SNO=$P(X,"^",2)
"RTN","PSOTPCEE",18,0)
 .S DR="1////"_DT_";5////M;6////"_SNO_";7////"_INST D ^DIE
"RTN","PSOTPCEE",19,0)
INS S REC=$G(^PS(FI,DA,0))
"RTN","PSOTPCEE",20,0)
 S DR="7" D ^DIE I $D(Y)!($D(DTOUT)) D:FLG RM L -^PS(FI,DA) G PT
"RTN","PSOTPCEE",21,0)
 I X,X'=$P(REC,"^",8) S $P(REC,"^",7)=$P($G(^DIC(4,X,99)),"^"),DR="6////"_$P($G(^DIC(4,X,99)),"^") D ^DIE
"RTN","PSOTPCEE",22,0)
 S DR="6" D ^DIE I $D(Y)!($D(DTOUT)) D:FLG RM L -^PS(52.91,DA) G PT
"RTN","PSOTPCEE",23,0)
 I X,X'=$P(REC,"^",7),$$IEN^XUAF4(X) S DR="7////"_$$IEN^XUAF4(X) D ^DIE G INS
"RTN","PSOTPCEE",24,0)
 S CDT=$P(REC,"^",3)
"RTN","PSOTPCEE",25,0)
 S DR="2" D ^DIE I $D(Y)!($D(DTOUT)) L -^PS(FI,DA) G PT
"RTN","PSOTPCEE",26,0)
 I CDT,X="" S DR="3////@" D ^DIE W !,"INACTIVATION REASON CODE: " G CONT
"RTN","PSOTPCEE",27,0)
 I X S DR="3R",DIE("NO^")="" D ^DIE I $D(DTOUT) S DR="3////3" D ^DIE L -^PS(FI,DA) G PT
"RTN","PSOTPCEE",28,0)
CONT L -^PS(FI,DA)
"RTN","PSOTPCEE",29,0)
 S Y=$S(FLG:DT,1:$P(REC,"^",2)) X ^DD("DD")
"RTN","PSOTPCEE",30,0)
 W !!,UL,!,"DATE PHARMACY BENEFIT BEGAN: "_Y
"RTN","PSOTPCEE",31,0)
 S Y=$P(REC,"^",6),Y=$S(Y="E":"EWL",Y="S":"SCHEDULED APPOINTMENT",Y="X":"EWL & SCHEDULED APPOINTMENT",Y="M":"MANUAL",1:"")
"RTN","PSOTPCEE",32,0)
 W ?42,"WAIT TYPE: "_Y
"RTN","PSOTPCEE",33,0)
 S Y=$P(REC,"^",5) I Y X ^DD("DD")
"RTN","PSOTPCEE",34,0)
 W !,"DESIRED APPOINTMENT DATE: "_Y
"RTN","PSOTPCEE",35,0)
 W !,"EXCLUSION REASON: " S Y=$P(REC,"^",9)
"RTN","PSOTPCEE",36,0)
 W:Y=1 "ACTIVE RX"
"RTN","PSOTPCEE",37,0)
 W:Y=2 "ACTUAL APPT. < 30 DAYS FROM DATE APPT. MADE"
"RTN","PSOTPCEE",38,0)
 W:Y=3 "ACTIVE RX & ACTUAL APPT. < 30 DAYS FROM DATE APPT. MADE"
"RTN","PSOTPCEE",39,0)
 S Y=$P(REC,"^",10) I Y X ^DD("DD")
"RTN","PSOTPCEE",40,0)
 W !,"PRIMARY CARE SCHEDULE APT DATE: "_Y_"   "_"RX #: "_$P(REC,"^",11)
"RTN","PSOTPCEE",41,0)
 S Y=$P(REC,"^",12) I Y X ^DD("DD")
"RTN","PSOTPCEE",42,0)
 W !,"DATE LETTER PRINTED: "_Y,!,UL
"RTN","PSOTPCEE",43,0)
 G PT
"RTN","PSOTPCEE",44,0)
PTX K DIC,DIE,%DT,DR,DA Q
"RTN","PSOTPCEE",45,0)
RM ;
"RTN","PSOTPCEE",46,0)
 ;W !?10,$C(7),"Required Data - Setting patient as Inactive"
"RTN","PSOTPCEE",47,0)
 ;S DR="2////"_DT_";3////3" D ^DIE
"RTN","PSOTPCEE",48,0)
 W !!,$C(7),"Required Data - deleting patient entry from TPB ELIGIBILITY (#52.91) File."
"RTN","PSOTPCEE",49,0)
 K DIK S DIK="^PS(52.91,",DA=PSODFN D ^DIK K DIK,^PS(52.91,"AX",DT,DA)
"RTN","PSOTPCEE",50,0)
 Q
"RTN","PSOTPCL")
0^4^B21264394
"RTN","PSOTPCL",1,0)
PSOTPCL ;BIRM/PDW-EDIT TPC INSTITUTION LETTERS
"RTN","PSOTPCL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**145,227**;DEC 1997
"RTN","PSOTPCL",3,0)
 Q
"RTN","PSOTPCL",4,0)
EDIT ; Manual edit of institution letter information in 52.92
"RTN","PSOTPCL",5,0)
 Q  ;placed out of order by patch PSO*7*227
"RTN","PSOTPCL",6,0)
 W @IOF
"RTN","PSOTPCL",7,0)
 W !,"                             Transitional Pharmacy Care"
"RTN","PSOTPCL",8,0)
 W !,"                       Edit Institution  Letter  Information"
"RTN","PSOTPCL",9,0)
EDIT2 W !!,"(You may add a NEW Institution at this point.)",!
"RTN","PSOTPCL",10,0)
 D PSTINT
"RTN","PSOTPCL",11,0)
 K DIC,DA
"RTN","PSOTPCL",12,0)
 S DIC=52.92,DIC(0)="AEQML",DIC("W")="W ?40,$$GET1^DIQ(52.92,+Y,.02) W:$$CHKINST^PSOTPCL(+Y) ?69,"" Incomp""",DIC("A")="Select/Add TPB INSTITUTION: ",DLAYGO=52.92
"RTN","PSOTPCL",13,0)
 D ^DIC K DLAYGO
"RTN","PSOTPCL",14,0)
 G:Y'>0 EXIT
"RTN","PSOTPCL",15,0)
 S DA=+Y,DR="[INSTITUTION EDIT]",DDSFILE=52.92
"RTN","PSOTPCL",16,0)
 D ^DDS
"RTN","PSOTPCL",17,0)
 G EDIT2
"RTN","PSOTPCL",18,0)
 ;
"RTN","PSOTPCL",19,0)
EXIT K DIC,DIE,DR,DDSFILE
"RTN","PSOTPCL",20,0)
 W @IOF
"RTN","PSOTPCL",21,0)
 Q
"RTN","PSOTPCL",22,0)
PSTINT ;Take institution entries from 52.91 & stuff into 52.92
"RTN","PSOTPCL",23,0)
 S LOCDA=0 F  S LOCDA=$O(^PS(52.91,"AC",LOCDA)) Q:LOCDA'>0  D LOCDA
"RTN","PSOTPCL",24,0)
 Q
"RTN","PSOTPCL",25,0)
LOCDA ;Get physical and mailing address
"RTN","PSOTPCL",26,0)
 I $D(^PS(52.92,LOCDA,0)) Q
"RTN","PSOTPCL",27,0)
 N FAC,FDA
"RTN","PSOTPCL",28,0)
 ; set FAC(FLD#)=(INTvalue of FLD#); ex:  FAC(.01)=500 :"Birmingham VAMC"
"RTN","PSOTPCL",29,0)
 ;
"RTN","PSOTPCL",30,0)
 F XX=.01,.02,1.01,1.02,1.03,1.04 S FAC(XX)=$$GET1^DIQ(4,LOCDA,XX,"I")
"RTN","PSOTPCL",31,0)
 F XX=4.01,4.02,4.03,4.04,4.05 S FAC(XX)=$$GET1^DIQ(4,LOCDA,XX,"I")
"RTN","PSOTPCL",32,0)
 ;
"RTN","PSOTPCL",33,0)
 ; build/map fields from iNSTITUTION file to TPB INSTITUTION LETTER
"RTN","PSOTPCL",34,0)
 ; file into FDA
"RTN","PSOTPCL",35,0)
 ; "XFDL^YFLD," stuff XFLD of file 52.92 with YFLD of file 4
"RTN","PSOTPCL",36,0)
 ;
"RTN","PSOTPCL",37,0)
 F XX=".01^.01",".05^1.01",".06^1.02",".07^1.03",".08^1.04",".09^.02","1.01^4.01","1.02^4.02","1.03^4.03","1.04^4.04","1.05^4.05" D
"RTN","PSOTPCL",38,0)
 . S XFLD=+XX,YFLD=$P(XX,U,2)
"RTN","PSOTPCL",39,0)
 . S FDA(52.92,"+1,",XFLD)=FAC(YFLD)
"RTN","PSOTPCL",40,0)
 S FDA(52.92,"+1,",.01)=LOCDA,LOCDA(1)=LOCDA
"RTN","PSOTPCL",41,0)
 D UPDATE^DIE("","FDA","LOCDA","MSG")
"RTN","PSOTPCL",42,0)
 Q
"RTN","PSOTPCL",43,0)
SEL ;Select divisions
"RTN","PSOTPCL",44,0)
 ; returns arrays
"RTN","PSOTPCL",45,0)
 ; for testing
"RTN","PSOTPCL",46,0)
 W !!,"SELECTION OF INSTITUTION(S)",!
"RTN","PSOTPCL",47,0)
 K DIVNM,DIVDA,DIVX
"RTN","PSOTPCL",48,0)
 S DIVDA=0 F I=1:1 S DIVDA=$O(^PS(52.92,"B",DIVDA)) Q:DIVDA'>0  D
"RTN","PSOTPCL",49,0)
 . Q:$$CHKINST(DIVDA)  ; only completed institutions
"RTN","PSOTPCL",50,0)
 . S DIV=$$GET1^DIQ(52.92,DIVDA,.01)  S INST(DIVDA)=DIV
"RTN","PSOTPCL",51,0)
 K DIR S DIR(0)="S^A:ALL INSTITUTIONS;S:SELECT INSTITUTIONS"
"RTN","PSOTPCL",52,0)
 D ^DIR K DIR
"RTN","PSOTPCL",53,0)
 G:Y="A" ALL
"RTN","PSOTPCL",54,0)
 G:Y="S" SELECT
"RTN","PSOTPCL",55,0)
 K INST
"RTN","PSOTPCL",56,0)
 Q
"RTN","PSOTPCL",57,0)
SELECT ; select range of divisioins
"RTN","PSOTPCL",58,0)
 K INST,DIC
"RTN","PSOTPCL",59,0)
 S DIC="^PS(52.92,",DIC(0)="AEQM"
"RTN","PSOTPCL",60,0)
 F  S DIC("W")="W ?40,$E($$GET1^DIQ(52.92,+Y,.02),1,18) I $$CHKINST^PSOTPCL(+Y) W ?60,""Incomplete""" D ^DIC Q:Y'>0  D
"RTN","PSOTPCL",61,0)
 . I $$CHKINST(+Y) W !,"Sorry, data for that institution is incomplete",! Q
"RTN","PSOTPCL",62,0)
 . S INST(+Y)=$$GET1^DIQ(52.92,+Y,.01)
"RTN","PSOTPCL",63,0)
ALL K PSOSTOP
"RTN","PSOTPCL",64,0)
 I '$D(INST) S INST="" W !,"None Selected - Quitting",! H 3 Q
"RTN","PSOTPCL",65,0)
 W !!,"You have selected:",! S DIV=0 F II=1:1 D:'(II#18) PG Q:$G(PSOSTOP)  S DIV=$O(INST(DIV)) Q:'DIV  W !,?5,INST(DIV)
"RTN","PSOTPCL",66,0)
 S DIR(0)="Y",DIR("A")="Is this correct ",DIR("B")="YES" D ^DIR
"RTN","PSOTPCL",67,0)
 K DIR
"RTN","PSOTPCL",68,0)
 Q:Y
"RTN","PSOTPCL",69,0)
 G SEL
"RTN","PSOTPCL",70,0)
 ;
"RTN","PSOTPCL",71,0)
PG K DIR S DIR(0)="E",DIR("A")="CR - CONTINUE  ^ - Quit" D ^DIR
"RTN","PSOTPCL",72,0)
 S:X["^" PSOSTOP=1
"RTN","PSOTPCL",73,0)
 Q
"RTN","PSOTPCL",74,0)
INSTCHK() ; check required fields of INST in the array INST(INSTDA)
"RTN","PSOTPCL",75,0)
 N FAC S FAC=0
"RTN","PSOTPCL",76,0)
 S INSTDA=0 F  S INSTDA=$O(INST(INSTDA)) Q:INSTDA'>0  S XX=$$CHKINST(INSTDA) I $L(XX) W !,"Sorry, required field(s) are missing from ",INST(INSTDA) S FAC=1
"RTN","PSOTPCL",77,0)
 I $G(FAC) D
"RTN","PSOTPCL",78,0)
 . W !,"= = = = ="
"RTN","PSOTPCL",79,0)
 . W !!,"The above institution(s) will need to have their letter information edited",!,"before the letters for that facility can be printed",!
"RTN","PSOTPCL",80,0)
 . K DIR S DIR(0)="EO" D ^DIR K DIR
"RTN","PSOTPCL",81,0)
 . I X["^" S PSOSTOP=1
"RTN","PSOTPCL",82,0)
 Q FAC
"RTN","PSOTPCL",83,0)
 ;
"RTN","PSOTPCL",84,0)
CHKINST(INSTDA) ; check institution in 52.92 for required edited fields
"RTN","PSOTPCL",85,0)
 N XX,FAC,PAR S FAC=""
"RTN","PSOTPCL",86,0)
 ; see if parent, parent checks OK
"RTN","PSOTPCL",87,0)
 S PAR=$$GET1^DIQ(52.92,INSTDA,.02,"I") I PAR S XX=$$CHKINST(PAR) Q XX
"RTN","PSOTPCL",88,0)
 F YY=.05,.07,.08,2.01 S XX=$$GET1^DIQ(52.92,INSTDA,YY) I $L(XX)=0 S FAC=FAC_YY_","
"RTN","PSOTPCL",89,0)
 Q FAC
"RTN","PSOTPCL",90,0)
PTCHK() ; Check file 52.91 for INST fields and 52.92 for INSTUTITONs present
"RTN","PSOTPCL",91,0)
 N INST,CHK,INSTDA S INSTDA=0,CHK=0
"RTN","PSOTPCL",92,0)
 F  S INSTDA=$O(^PS(52.91,"AC",INSTDA)) Q:INSTDA'>0  D
"RTN","PSOTPCL",93,0)
 . I $D(^PS(52.92,INSTDA)) Q
"RTN","PSOTPCL",94,0)
 . S CHK=1
"RTN","PSOTPCL",95,0)
 . W !!,$$GET1^DIQ(4,INSTDA,.01),!," is missing from the TRANSITIONAL RX INSTITUTION LETTERS file #52.92",!,"and is being added."
"RTN","PSOTPCL",96,0)
 . S LOCDA=INSTDA N INST,FAC D LOCDA ; add INSTDA to # 52.92
"RTN","PSOTPCL",97,0)
 I CHK D
"RTN","PSOTPCL",98,0)
 . W !,"= = = = ="
"RTN","PSOTPCL",99,0)
 . W !!,"The above institution(s) will need to have their letter information edited",!,"before the letters for that facility can be printed",!
"RTN","PSOTPCL",100,0)
 . K DIR S DIR(0)="EO",DIR("A")="<cr> - Continue" D ^DIR K DIR
"RTN","PSOTPCL",101,0)
 Q CHK
"RTN","PSOTPCLP")
0^5^B62400881
"RTN","PSOTPCLP",1,0)
PSOTPCLP ;BIRM/PDW-PRINT PATIENT LETTERS ;AUG 5,2003
"RTN","PSOTPCLP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**145,227**;DEC 1997
"RTN","PSOTPCLP",3,0)
 Q
"RTN","PSOTPCLP",4,0)
PRINT ; select options
"RTN","PSOTPCLP",5,0)
 Q  ;placed out of order by patch PSO*7*227
"RTN","PSOTPCLP",6,0)
 K ^TMP($J,"TPBLET"),TMP($J,"TPCLW")
"RTN","PSOTPCLP",7,0)
 D EXIT ;INITIALIZE
"RTN","PSOTPCLP",8,0)
 ;build INST to show incompleted Institutions
"RTN","PSOTPCLP",9,0)
 K INST S DIVDA=0 F  S DIVDA=$O(^PS(52.92,DIVDA)) Q:DIVDA'>0  D
"RTN","PSOTPCLP",10,0)
 . S INST(DIVDA)=$$GET1^DIQ(52.92,DIVDA,.01)
"RTN","PSOTPCLP",11,0)
 S XX=$$INSTCHK^PSOTPCL I $G(PSOSTOP) Q
"RTN","PSOTPCLP",12,0)
 K INST S DIVDA=0 F  S DIVDA=$O(^PS(52.92,DIVDA)) Q:DIVDA'>0  D
"RTN","PSOTPCLP",13,0)
 . Q:$$CHKINST^PSOTPCL(DIVDA)
"RTN","PSOTPCLP",14,0)
 . S INST(DIVDA)=$$GET1^DIQ(52.92,DIVDA,.01)
"RTN","PSOTPCLP",15,0)
 K PARAM,PATLST
"RTN","PSOTPCLP",16,0)
 K DIR S DIR(0)="SO^A:Print all letters that have not printed;P:Print letter by a patient or multiple patients;I:Print by institution (all, one, or a selection)" D ^DIR
"RTN","PSOTPCLP",17,0)
 I Y="A" S PARAM("SORT")="I",PATLST="",PARAM("LP")="N" G DEVICE
"RTN","PSOTPCLP",18,0)
 I Y="P" G PATIENT
"RTN","PSOTPCLP",19,0)
 I Y="I" G DIVISION
"RTN","PSOTPCLP",20,0)
 W !,"None Selected - Quitting",! H 3
"RTN","PSOTPCLP",21,0)
 G EXIT
"RTN","PSOTPCLP",22,0)
PATIENT ; print by patients
"RTN","PSOTPCLP",23,0)
 S PARAM("SORT")="P",PARAM("LP")="B"
"RTN","PSOTPCLP",24,0)
 D PATSEL ; build PATLST("patient name")=DFN
"RTN","PSOTPCLP",25,0)
 G:($D(PATLST)<10) EXIT
"RTN","PSOTPCLP",26,0)
 G DEVICE
"RTN","PSOTPCLP",27,0)
DIVISION ;print by division
"RTN","PSOTPCLP",28,0)
 K DIR S DIR(0)="SO^N:Letters NOT Printed;P:Letters Printed;B:Both"
"RTN","PSOTPCLP",29,0)
 D ^DIR Q:"NPB"'[Y
"RTN","PSOTPCLP",30,0)
 S PARAM("LP")=Y
"RTN","PSOTPCLP",31,0)
 S PARAM("SORT")="I"
"RTN","PSOTPCLP",32,0)
 K INST D SEL^PSOTPCL
"RTN","PSOTPCLP",33,0)
 I ($D(INST)<10) W !,"No Selection Made - Quitting",! H 3 G EXIT
"RTN","PSOTPCLP",34,0)
 G DEVICE
"RTN","PSOTPCLP",35,0)
PATSEL ; Select one or more patients
"RTN","PSOTPCLP",36,0)
 K PATLST
"RTN","PSOTPCLP",37,0)
 S DIC="^PS(52.91,",DIC(0)="AEQM",DIC("W")="D DSPPAT^PSOTPCLP(+Y)"
"RTN","PSOTPCLP",38,0)
 F  S DIC("W")="D DSPPAT^PSOTPCLP(+Y)" D ^DIC Q:Y'>0  S DFN=+Y,PTNM=$$GET1^DIQ(52.91,DFN,.01),PATLST(PTNM,DFN)="" D
"RTN","PSOTPCLP",39,0)
 . ;test death date
"RTN","PSOTPCLP",40,0)
 . S XX=$$GET1^DIQ(2,DFN,.351) I XX'="" D  Q
"RTN","PSOTPCLP",41,0)
 .. W !!,"Sorry, ",PTNM," died ",XX,!
"RTN","PSOTPCLP",42,0)
 .. K PATLST(PTNM,DFN) H 3
"RTN","PSOTPCLP",43,0)
 . ;test expired date
"RTN","PSOTPCLP",44,0)
 . S EXPDTI=$$GET1^DIQ(52.91,DFN,2,"I")
"RTN","PSOTPCLP",45,0)
 . I EXPDTI,DT>EXPDTI D
"RTN","PSOTPCLP",46,0)
 .. S EXPDT=$$GET1^DIQ(52.91,+DFN,2)
"RTN","PSOTPCLP",47,0)
 .. W !,"Sorry, ",PTNM,"'s eligibility expired ",EXPDT,! K PATLST(PTNM,DFN)
"RTN","PSOTPCLP",48,0)
 . ;check divisions required data
"RTN","PSOTPCLP",49,0)
 . S DIVDA=$$GET1^DIQ(52.91,DFN,7,"I")
"RTN","PSOTPCLP",50,0)
 . S XX=$$CHKINST^PSOTPCL(DIVDA) I XX D
"RTN","PSOTPCLP",51,0)
 .. W !!,"Sorry, ",$$GET1^DIQ(52.91,DFN,7)," is missing required fields.",!!
"RTN","PSOTPCLP",52,0)
 .. K PATLST(PTNM,DFN)
"RTN","PSOTPCLP",53,0)
 ;
"RTN","PSOTPCLP",54,0)
LST I ($D(PATLST)<10) W !,"No Patients Selected - Quitting",! H 3 S PATLST="" Q
"RTN","PSOTPCLP",55,0)
 W !!,"You have selected:",!
"RTN","PSOTPCLP",56,0)
 S PATNM="" F I=1:1 S PATNM=$O(PATLST(PATNM)) Q:'$L(PATNM)  S DFN=0 F  S DFN=$O(PATLST(PATNM,DFN)) Q:DFN'>0  W !,PATNM D DSPPAT(DFN) I '(I#20) D  D ^DIR I X["^" Q
"RTN","PSOTPCLP",57,0)
 .K DIR S DIR(0)="E",DIR("A")="<cr> - Continue ""^"" - Stop Display"
"RTN","PSOTPCLP",58,0)
 ;
"RTN","PSOTPCLP",59,0)
 W ! K DIR S DIR(0)="Y",DIR("A")="Is the above correct ",DIR("B")="YES" D ^DIR
"RTN","PSOTPCLP",60,0)
 I 'Y G PATSEL
"RTN","PSOTPCLP",61,0)
 Q
"RTN","PSOTPCLP",62,0)
DSPPAT(DFN) ; Display Division and expire date
"RTN","PSOTPCLP",63,0)
 N DIVNM,EXPDT,PRTDT
"RTN","PSOTPCLP",64,0)
 S DIVNM=$$GET1^DIQ(52.91,DFN,7) W ?32,$E(DIVNM,1,15)
"RTN","PSOTPCLP",65,0)
 S EXPDT=$$GET1^DIQ(52.91,DFN,2,"I")
"RTN","PSOTPCLP",66,0)
 I EXPDT S EXPDT=$$FMTE^XLFDT(EXPDT,"2D") W ?50,"Inact ",EXPDT
"RTN","PSOTPCLP",67,0)
 S PRTDT=$$GET1^DIQ(52.91,DFN,11,"I")
"RTN","PSOTPCLP",68,0)
 I PRTDT S PRTDT=$$FMTE^XLFDT(PRTDT,"2D") W ?66,"Prt ",PRTDT
"RTN","PSOTPCLP",69,0)
 Q
"RTN","PSOTPCLP",70,0)
DEVICE ;
"RTN","PSOTPCLP",71,0)
 W !,"Queueing is recommended",!
"RTN","PSOTPCLP",72,0)
 S %ZIS="Q" D ^%ZIS
"RTN","PSOTPCLP",73,0)
 Q:POP
"RTN","PSOTPCLP",74,0)
 I $D(IO("Q")) D  K ZTSK G EXIT
"RTN","PSOTPCLP",75,0)
 . S (PATLST,INST,PARAM)=""
"RTN","PSOTPCLP",76,0)
 . S ZTRTN="DEQUE^PSOTPCLP",ZTDESC="TPB PRINT PATIENT LETTERS"
"RTN","PSOTPCLP",77,0)
 . F XX="PATLST*","INST*","PARAM*" S ZTSAVE(XX)=""
"RTN","PSOTPCLP",78,0)
 . ;W ! ZW ZTRTN,ZTDESC,PATLST,INST,PARAM,ZTSAVE
"RTN","PSOTPCLP",79,0)
 . D ^%ZTLOAD
"RTN","PSOTPCLP",80,0)
 . I $G(ZTSK) W !!,"Tasked with "_ZTSK
"RTN","PSOTPCLP",81,0)
 ;  (code falls through if not queued)
"RTN","PSOTPCLP",82,0)
DEQUE ; DEQUE/PRINT LETTERS
"RTN","PSOTPCLP",83,0)
 K ^TMP($J,"TPBLET")
"RTN","PSOTPCLP",84,0)
 I PARAM("SORT")="P" G SORTPAT
"RTN","PSOTPCLP",85,0)
 S DIVDA=0 F  S DIVDA=$O(INST(DIVDA)) Q:DIVDA'>0  D
"RTN","PSOTPCLP",86,0)
 . S DFN=0 F  S DFN=$O(^PS(52.91,"AC",DIVDA,DFN)) Q:DFN'>0  D
"RTN","PSOTPCLP",87,0)
 .. S PTNM=$$GET1^DIQ(52.91,DFN,.01)
"RTN","PSOTPCLP",88,0)
 .. S EXPDTI=$P(^PS(52.91,DFN,0),"^",3),LTPDTI=$P(^(0),"^",12)
"RTN","PSOTPCLP",89,0)
 .. Q:EXPDTI
"RTN","PSOTPCLP",90,0)
 .. Q:$L($$GET1^DIQ(2,DFN,.351))
"RTN","PSOTPCLP",91,0)
 .. I PARAM("LP")="N",LTPDTI Q
"RTN","PSOTPCLP",92,0)
 .. I PARAM("LP")="P",'LTPDTI Q
"RTN","PSOTPCLP",93,0)
 .. S ^TMP($J,"TPBLET",DIVDA,PTNM,DFN)=""
"RTN","PSOTPCLP",94,0)
 G PRTLET
"RTN","PSOTPCLP",95,0)
SORTPAT ; sort by patient
"RTN","PSOTPCLP",96,0)
 K ^TMP($J,"TPBLET")
"RTN","PSOTPCLP",97,0)
 S PTNM="" F  S PTNM=$O(PATLST(PTNM)) Q:PTNM=""  D
"RTN","PSOTPCLP",98,0)
 . S DFN=0 F  S DFN=$O(PATLST(PTNM,DFN)) Q:DFN'>0  D
"RTN","PSOTPCLP",99,0)
 .. S DA0=^PS(52.91,DFN,0),EXPDTI=$P(DA0,"^",3),LTPDTI=$P(DA0,"^",12),DIVDA=$P(DA0,"^",8)
"RTN","PSOTPCLP",100,0)
 .. Q:EXPDTI
"RTN","PSOTPCLP",101,0)
 .. I PARAM("LP")="N",LTPDTI Q
"RTN","PSOTPCLP",102,0)
 .. I PARAM("LP")="P",'LTPDTI Q
"RTN","PSOTPCLP",103,0)
 .. S ^TMP($J,"TPBLET",DIVDA,PTNM,DFN)=""
"RTN","PSOTPCLP",104,0)
 G PRTLET
"RTN","PSOTPCLP",105,0)
 Q
"RTN","PSOTPCLP",106,0)
PRTLET ; pull DIVDAs and DFNs from ^TMP($J,"TPBLET",
"RTN","PSOTPCLP",107,0)
 D LOADTMP^PSOTPCLW ; load letter body into TMP
"RTN","PSOTPCLP",108,0)
 K DIVCNT
"RTN","PSOTPCLP",109,0)
 S DIVDA=0 F  S DIVDA=$O(^TMP($J,"TPBLET",DIVDA)) Q:DIVDA'>0  D
"RTN","PSOTPCLP",110,0)
 . S XX=$$CHKINST^PSOTPCL(DIVDA) I XX S DIVCNT(DIVDA)=0 Q
"RTN","PSOTPCLP",111,0)
 . D DIV ;GETDIV(DIVDA) ;load institution/parent data for print
"RTN","PSOTPCLP",112,0)
 . S PTNM="" F  S PTNM=$O(^TMP($J,"TPBLET",DIVDA,PTNM)) Q:PTNM=""  D
"RTN","PSOTPCLP",113,0)
 .. S DFN=0
"RTN","PSOTPCLP",114,0)
 .. F  S DFN=$O(^TMP($J,"TPBLET",DIVDA,PTNM,DFN)) Q:DFN'>0  D
"RTN","PSOTPCLP",115,0)
 ... S DIVCNT(DIVDA)=$G(DIVCNT(DIVDA))+1
"RTN","PSOTPCLP",116,0)
 ... D LETTER(DFN)
"RTN","PSOTPCLP",117,0)
 ... S $P(^PS(52.91,DFN,0),U,12)=DT ;set print date
"RTN","PSOTPCLP",118,0)
 ; summary of printing
"RTN","PSOTPCLP",119,0)
 S Y=DT D D^DIQ S SRDT=Y
"RTN","PSOTPCLP",120,0)
 W @IOF,!!,?10,"SUMMARY of TPB LETTER PRINTING   ",SRDT
"RTN","PSOTPCLP",121,0)
 W !!
"RTN","PSOTPCLP",122,0)
 I '$D(DIVCNT) W !!,"NO DATA TO PRINT",!! G EXIT
"RTN","PSOTPCLP",123,0)
 S DIVDA=0 F  S DIVDA=$O(DIVCNT(DIVDA)) Q:DIVDA'>0  D
"RTN","PSOTPCLP",124,0)
 . W !,?5,$$GET1^DIQ(52.92,DIVDA,.01),?40,DIVCNT(DIVDA)
"RTN","PSOTPCLP",125,0)
 W !
"RTN","PSOTPCLP",126,0)
 G EXIT
"RTN","PSOTPCLP",127,0)
 ;
"RTN","PSOTPCLP",128,0)
LETTER(DFN) ; print letter , division variables information must be present
"RTN","PSOTPCLP",129,0)
 U IO
"RTN","PSOTPCLP",130,0)
 D GETPAT(DFN)
"RTN","PSOTPCLP",131,0)
 I EXPDT,EXPDT'>DT Q  ; patient inactive on printing date
"RTN","PSOTPCLP",132,0)
 D HEADER
"RTN","PSOTPCLP",133,0)
 F LN=1:1 Q:'$D(^TMP($J,"TPCLW","P1",LN))  W !,^(LN)
"RTN","PSOTPCLP",134,0)
 W ?30,"PHARMACY SERVICE",!,?30,DIVNM
"RTN","PSOTPCLP",135,0)
 I $L(MADD1) D  I 1
"RTN","PSOTPCLP",136,0)
 . W !,?30,MADD1
"RTN","PSOTPCLP",137,0)
 . W:$L(MADD2) !,?30,MADD2
"RTN","PSOTPCLP",138,0)
 . W !,?30,MCITY,", ",MSTATE,"  ",MZIP
"RTN","PSOTPCLP",139,0)
 E  W !,?30,ADD1 D
"RTN","PSOTPCLP",140,0)
 . W:$L(ADD2) !,?30,ADD2
"RTN","PSOTPCLP",141,0)
 . W !,?30,CITY,", ",STATE,"  ",ZIP
"RTN","PSOTPCLP",142,0)
 F LN=1:1 Q:'$D(^TMP($J,"TPCLW","P2",LN))  W !,^(LN)
"RTN","PSOTPCLP",143,0)
 W " ",PHN1 W:$L(PHN2) ", or ",PHN2 W ".",!
"RTN","PSOTPCLP",144,0)
 F LN=1:1 Q:'$D(^TMP($J,"TPCLW","P3",LN))  W:LN>1 ! W ^(LN)
"RTN","PSOTPCLP",145,0)
 W !!!!,?4,SIG1 W:$L(SIG2) !,?4,SIG2 W:$L(SIG3) !,?4,SIG3
"RTN","PSOTPCLP",146,0)
 W !
"RTN","PSOTPCLP",147,0)
 Q
"RTN","PSOTPCLP",148,0)
GETPAT(DFN) ;GET PATIENT DATA
"RTN","PSOTPCLP",149,0)
 K PTNM,EXPDT,SRANAME,TITLE,SRNM,PTSTATE,VADM,VAPA
"RTN","PSOTPCLP",150,0)
 S PTNM=$$GET1^DIQ(52.91,DFN,.01),EXPDT=$$GET1^DIQ(52.91,DFN,2,"I")
"RTN","PSOTPCLP",151,0)
 ;I EXPDT,DT'>EXPDT Q
"RTN","PSOTPCLP",152,0)
 D DEM^VADPT,ADD^VADPT
"RTN","PSOTPCLP",153,0)
 S PTLNM=$P(PTNM,","),PTXNM=$P(PTNM,",")
"RTN","PSOTPCLP",154,0)
 S SRANAME=$P(VADM(1),"^"),X=$P(SRANAME,","),Y=$E(X)_$TR($E(X,2,$L(X)),"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","PSOTPCLP",155,0)
 S TITLE=$S($P(VADM(5),"^")="F":"Ms. ",1:"Mr. "),SRANAME=TITLE_Y
"RTN","PSOTPCLP",156,0)
 S Y=DT D D^DIQ S SRDT=Y
"RTN","PSOTPCLP",157,0)
 S SEX=$P(VADM(5),"^")
"RTN","PSOTPCLP",158,0)
 S SRNM=$P(VADM(1),",",2)_" "_$P(VADM(1),",")
"RTN","PSOTPCLP",159,0)
 S PADD1=$G(VAPA(1)),PADD2=$G(VAPA(2)),PADD3=$G(VAPA(3))
"RTN","PSOTPCLP",160,0)
 S PCITY=$G(VAPA(4)),PTSTATE=$P($G(VAPA(5)),U,2),PZIP=$G(VAPA(6))
"RTN","PSOTPCLP",161,0)
CCADD ; Get Confidential Correspondence Address if one is active
"RTN","PSOTPCLP",162,0)
 ; and has the category "all other".
"RTN","PSOTPCLP",163,0)
 ;
"RTN","PSOTPCLP",164,0)
 ; See if CC address exists
"RTN","PSOTPCLP",165,0)
 I '$G(VAPA(12)) Q
"RTN","PSOTPCLP",166,0)
 ; code to check the CC category in the variable array VAPA(22)
"RTN","PSOTPCLP",167,0)
 ; check catagories
"RTN","PSOTPCLP",168,0)
 S XX=0 F CC=1,2,5 I $P($G(VAPA(22,CC)),U,3)="Y" S XX=1
"RTN","PSOTPCLP",169,0)
 Q:'XX
"RTN","PSOTPCLP",170,0)
 S SRCCADD=1
"RTN","PSOTPCLP",171,0)
 S:$G(VAPA(17)) PTSTATE=$P(^DIC(5,$P(VAPA(17),"^"),0),"^",2)
"RTN","PSOTPCLP",172,0)
 S PADD1=$G(VAPA(13)),PADD2=$G(VAPA(14)),PADD3=$G(VAPA(15))
"RTN","PSOTPCLP",173,0)
 S PCITY=$G(VAPA(16)),PTSTAT=$P(VAPA(17),U,2),PZIP=$P(VAPA(18),U,2)
"RTN","PSOTPCLP",174,0)
 Q
"RTN","PSOTPCLP",175,0)
HEADER ; print letter header
"RTN","PSOTPCLP",176,0)
 U IO
"RTN","PSOTPCLP",177,0)
 W @IOF
"RTN","PSOTPCLP",178,0)
 W !!,?(80-$L(DIVNM))\2,DIVNM
"RTN","PSOTPCLP",179,0)
 W !,?(80-$L(ADD1))\2,ADD1
"RTN","PSOTPCLP",180,0)
 W:$L(ADD2) !,?(80-$L(ADD2))\2,ADD2
"RTN","PSOTPCLP",181,0)
 S XX=CITY_", "_STATE_" "_ZIP
"RTN","PSOTPCLP",182,0)
 W !,?(80-$L(XX))\2,XX
"RTN","PSOTPCLP",183,0)
 F Y=$Y:1:10 W !
"RTN","PSOTPCLP",184,0)
 W !,?4,SRNM,?65,SRDT,!,?4,PADD1 I PADD2'="" W !,?4,PADD2 I PADD3'="" W !,?4,VAPA(3)
"RTN","PSOTPCLP",185,0)
 W:PCITY'="" !,?4,PCITY_", "_PTSTATE_" "_PZIP W !!!
"RTN","PSOTPCLP",186,0)
 Q
"RTN","PSOTPCLP",187,0)
DIV D GETDIV(DIVDA)
"RTN","PSOTPCLP",188,0)
 I $L(PARDIV) S DIVDA2=$$GET1^DIQ(52.92,DIVDA,.02,"I") D GETDIV(DIVDA2)
"RTN","PSOTPCLP",189,0)
 Q
"RTN","PSOTPCLP",190,0)
GETDIV(DIVDA) ; GET DIVISIONAL DATA
"RTN","PSOTPCLP",191,0)
 K DIVNM,PARDIV,PHN1,PHN2,ADD1,ADD2,CITY,ZIP,STATE,MADD1,MADD2,MCITY,MZIP,SIG1,SIG2,SIG3
"RTN","PSOTPCLP",192,0)
 ;
"RTN","PSOTPCLP",193,0)
 F FLDX="DIVNM^.01","PARDIV^.02","PHN1^.03","PHN2^.04","ADD1^.05","ADD2^.06","CITY^.07","ZIP^.08","STATE^.09" D GET1(52.92,DIVDA,FLDX)
"RTN","PSOTPCLP",194,0)
 ;
"RTN","PSOTPCLP",195,0)
 F FLDX="MADD1^1.01","MADD2^1.02","MCITY^1.03","MSTATE^1.04","MZIP^1.05","SIG1^2.01","SIG2^2.02","SIG3^2.03" D GET1(52.92,DIVDA,FLDX)
"RTN","PSOTPCLP",196,0)
 ;
"RTN","PSOTPCLP",197,0)
 Q
"RTN","PSOTPCLP",198,0)
GET1(FILE,FLIEN,FLDX) ; "Variable^FLD" load variable = FILE,FLD
"RTN","PSOTPCLP",199,0)
 N VAR S VAR=$P(FLDX,"^"),FLD=$P(FLDX,"^",2),@VAR=$$GET1^DIQ(FILE,FLIEN,FLD)
"RTN","PSOTPCLP",200,0)
 Q
"RTN","PSOTPCLP",201,0)
EXIT ;
"RTN","PSOTPCLP",202,0)
 D ^%ZISC
"RTN","PSOTPCLP",203,0)
 I $G(ZTSK) D KILL^%ZTLOAD
"RTN","PSOTPCLP",204,0)
 K ADD1,ADD2,CHK,CITY,DIV,DIVCNT,DIVDA,DIVDA2,DIVNM,DIVX
"RTN","PSOTPCLP",205,0)
 K EXPDT,EXPDTI,FAC,FDA,FLD,FLDX,FILE,FLD,FLDX,FLIEN
"RTN","PSOTPCLP",206,0)
 K I,INST,LN,LOCDA,LTPDTI,MADD1,MADD2,MCITY,MZIP,PAR,PARAM
"RTN","PSOTPCLP",207,0)
 K PARDIV,PATLST,PATNM,PHN1,PHN2,POP,PRTDT,PSOSTOP,PTLNM,PTNM
"RTN","PSOTPCLP",208,0)
 K PTSTATE,PTXNM,SEX,SIG1,SIG2,SIG3,SRNAME,SRDT,STATE,TITLE
"RTN","PSOTPCLP",209,0)
 K VADM,VAPA,VAR,XFLD,XX,YFLD,YY,ZIP,ZTDESC
"RTN","PSOTPCLP",210,0)
 K ^TMP($J,"TPBLET"),^TMP($J,"TPCLW")
"RTN","PSOTPCLP",211,0)
 Q
"RTN","PSOTPCLP",212,0)
LOAD K PATLST S DFN=0 F  S DFN=$O(^PS(52.91,DFN)) Q:DFN'>0  S PATLST($$GET1^DIQ(52.91,DFN,.01))=DFN
"RTN","PSOTPCLP",213,0)
 Q
"RTN","PSOTPCLR")
0^6^B10932938
"RTN","PSOTPCLR",1,0)
PSOTPCLR ;BIRM/PDW-LETTER PRINT REPORTS ;AUG 8, 2003
"RTN","PSOTPCLR",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**145,227**;DEC 1997
"RTN","PSOTPCLR",3,0)
 Q
"RTN","PSOTPCLR",4,0)
EN ;
"RTN","PSOTPCLR",5,0)
 Q  ;placed out of order by patch PSO*7*227
"RTN","PSOTPCLR",6,0)
 K DIR S DIR(0)="SO^N:Patients/Letters NOT Printed;P:Patients/Letters Printed" D ^DIR
"RTN","PSOTPCLR",7,0)
 I Y="N" S PARAM=Y G DEVICE
"RTN","PSOTPCLR",8,0)
 I Y="P" S PARAM=Y G DEVICE
"RTN","PSOTPCLR",9,0)
 Q
"RTN","PSOTPCLR",10,0)
DEVICE ;
"RTN","PSOTPCLR",11,0)
 W !,"Queuing is recommended",!
"RTN","PSOTPCLR",12,0)
 K %ZIS S %ZIS="Q" D ^%ZIS
"RTN","PSOTPCLR",13,0)
 Q:POP
"RTN","PSOTPCLR",14,0)
 I $D(IO("Q")) D  K ZTSK G EXIT2
"RTN","PSOTPCLR",15,0)
 . S ZTRTN="DEQUE^PSOTPCLR",ZTDESC="TPB PRINT LETTER REPORT"
"RTN","PSOTPCLR",16,0)
 . S ZTSAVE("PARAM")=""
"RTN","PSOTPCLR",17,0)
 . D ^%ZTLOAD D ^%ZISC
"RTN","PSOTPCLR",18,0)
 . I $G(ZTSK) W !!,"Tasked with "_ZTSK
"RTN","PSOTPCLR",19,0)
 ;
"RTN","PSOTPCLR",20,0)
DEQUE ; DEQUE/PRINT LETTERS
"RTN","PSOTPCLR",21,0)
 K ^TMP($J,"PSOTPBLR"),DIVCNT
"RTN","PSOTPCLR",22,0)
 S DIVDA=0 F  S DIVDA=$O(^PS(52.91,"AC",DIVDA)) Q:DIVDA'>0  D
"RTN","PSOTPCLR",23,0)
 . S DFN=0 F  S DFN=$O(^PS(52.91,"AC",DIVDA,DFN)) Q:DFN'>0  D
"RTN","PSOTPCLR",24,0)
 .. S PRTDTI=$$GET1^DIQ(52.91,DFN,11,"I") I PARAM="P",'PRTDTI Q
"RTN","PSOTPCLR",25,0)
 .. S PRTDTI=$$GET1^DIQ(52.91,DFN,11,"I") I PARAM="N",PRTDTI Q
"RTN","PSOTPCLR",26,0)
 .. S PTNM=$$GET1^DIQ(52.91,DFN,.01),PRTDT=$$FMTE^XLFDT(PRTDTI,"2D")
"RTN","PSOTPCLR",27,0)
 .. S ^TMP($J,"PSOTPBLR",DIVDA,PTNM,DFN)=PRTDT
"RTN","PSOTPCLR",28,0)
 .. S DIVCNT(DIVDA)=$G(DIVCNT(DIVDA))+1
"RTN","PSOTPCLR",29,0)
PRINT ; print report
"RTN","PSOTPCLR",30,0)
 U IO K DIVCNT,PSOSTOP
"RTN","PSOTPCLR",31,0)
 S PG=0,LINE="",$P(LINE,"=",79)=""
"RTN","PSOTPCLR",32,0)
 S DIVDA=0  F  Q:$G(PSOSTOP)  S DIVDA=$O(^TMP($J,"PSOTPBLR",DIVDA)) Q:DIVDA'>0  D
"RTN","PSOTPCLR",33,0)
 . D HEADER
"RTN","PSOTPCLR",34,0)
 . S PTNM="" F  Q:$G(PSOSTOP)  S PTNM=$O(^TMP($J,"PSOTPBLR",DIVDA,PTNM)) Q:PTNM=""  D
"RTN","PSOTPCLR",35,0)
 .. S DFN=0 F  Q:$G(PSOSTOP)  S DFN=$O(^TMP($J,"PSOTPBLR",DIVDA,PTNM,DFN)) Q:DFN'>0  D
"RTN","PSOTPCLR",36,0)
 ... S DIVCNT(DIVDA)=$G(DIVCNT(DIVDA))+1
"RTN","PSOTPCLR",37,0)
 ... D PG
"RTN","PSOTPCLR",38,0)
 ... W !,$$GET1^DIQ(52.91,DFN,.01)
"RTN","PSOTPCLR",39,0)
 ... I PARAM="P" W ?35,^TMP($J,"PSOTPBLR",DIVDA,PTNM,DFN) Q
"RTN","PSOTPCLR",40,0)
 ... S INACTDT=$$GET1^DIQ(52.91,DFN,2,"I"),EXCODE=$$GET1^DIQ(52.91,DFN,3),EXREA=$$GET1^DIQ(52.91,DFN,8)
"RTN","PSOTPCLR",41,0)
 ... W:INACTDT ?35,$$FMTE^XLFDT(INACTDT,"2D") W:$L(EXCODE) ?45,EXCODE
"RTN","PSOTPCLR",42,0)
 ... W:$L(EXREA) !,?10,"Exclusion Reason: ",EXREA
"RTN","PSOTPCLR",43,0)
SUMMARY ;
"RTN","PSOTPCLR",44,0)
 W:'$D(DIVCNT) !!,"No Data Found"
"RTN","PSOTPCLR",45,0)
 Q:$G(PSOSTOP)
"RTN","PSOTPCLR",46,0)
 I PG,$E(IOST)="C" K DIR S DIR(0)="E"  D ^DIR I 'Y S PSOSTOP=1 Q
"RTN","PSOTPCLR",47,0)
 W !,@IOF,!!,?10,"SUMMARY of TPB LETTER PRINTING   "
"RTN","PSOTPCLR",48,0)
 I PARAM="P" W "'PRINTED'" I 1
"RTN","PSOTPCLR",49,0)
 E  W "'NOT PRINTED'"
"RTN","PSOTPCLR",50,0)
 W !!
"RTN","PSOTPCLR",51,0)
 S DIVDA=0 F  S DIVDA=$O(DIVCNT(DIVDA)) Q:DIVDA'>0  D
"RTN","PSOTPCLR",52,0)
 . W !,?5,$$GET1^DIQ(52.92,DIVDA,.01),?40,DIVCNT(DIVDA)
"RTN","PSOTPCLR",53,0)
 W:'$D(DIVCNT) !!,"No Data Found"
"RTN","PSOTPCLR",54,0)
 W !
"RTN","PSOTPCLR",55,0)
 G EXIT
"RTN","PSOTPCLR",56,0)
 ;
"RTN","PSOTPCLR",57,0)
PG I $Y>(IOSL-4) D HEADER
"RTN","PSOTPCLR",58,0)
 Q
"RTN","PSOTPCLR",59,0)
HEADER ;
"RTN","PSOTPCLR",60,0)
 W !
"RTN","PSOTPCLR",61,0)
 I PG,$E(IOST)="C" K DIR S DIR(0)="E"  D ^DIR I 'Y S PSOSTOP=1 Q
"RTN","PSOTPCLR",62,0)
 W @IOF
"RTN","PSOTPCLR",63,0)
 S PG=PG+1
"RTN","PSOTPCLR",64,0)
 W ?20,$$GET1^DIQ(52.92,DIVDA,.01)
"RTN","PSOTPCLR",65,0)
 I PARAM="P" W " TPB PATIENTS LETTERS PRINTED REPORT",! I 1
"RTN","PSOTPCLR",66,0)
 E  W " TPB PATIENTS LETTERS NOT PRINTED REPORT",!
"RTN","PSOTPCLR",67,0)
 W ?28,$$FMTE^XLFDT(DT,"1D"),?60,"Page: ",PG,!,LINE
"RTN","PSOTPCLR",68,0)
 I PARAM="N" W !,?35,"Inactivation",!,"Patient",?35,"Date",?45,"Reason",!
"RTN","PSOTPCLR",69,0)
 Q
"RTN","PSOTPCLR",70,0)
EXIT ;
"RTN","PSOTPCLR",71,0)
 I $E(IOST)="C" W !!,"End of Report",! K DIR S DIR(0)="EO",DIR("A")="<cr> - Continue" D ^DIR
"RTN","PSOTPCLR",72,0)
 K ^TMP($J,"PSOTPBLR") I $G(ZTSK) D KILL^%ZTLOAD
"RTN","PSOTPCLR",73,0)
EXIT2 D ^%ZISC
"RTN","PSOTPCLR",74,0)
 K DIR,DIVCNT,DIVDA,LINE,PARAM,PG,PRTDT,PRTDTI,PTNM,SRDT
"RTN","PSOTPCLR",75,0)
 Q
"RTN","PSOTPCRP")
0^7^B53305181
"RTN","PSOTPCRP",1,0)
PSOTPCRP ;BIR/RTR-Non VA phycisian eligible patient report ;07/07/03
"RTN","PSOTPCRP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**145,153,227**;DEC 1997
"RTN","PSOTPCRP",3,0)
 Q  ;placed out of order by patch PSO*7*227
"RTN","PSOTPCRP",4,0)
EN ;
"RTN","PSOTPCRP",5,0)
 W !!,"This report prints entries from the TPB ELIGIBILITY file (#52.91)."
"RTN","PSOTPCRP",6,0)
 W !,"If multiple Institutions are selected, and some Institutions have data and",!,"some don't, only those Institutions that have data will print on the report.",!
"RTN","PSOTPCRP",7,0)
 N PSOGPINS,PSOGPAR,PSOGOK,PSOGSORT
"RTN","PSOTPCRP",8,0)
 S PSOGPINS=0
"RTN","PSOTPCRP",9,0)
INST ;Ask for Institutions
"RTN","PSOTPCRP",10,0)
 K DIR S DIR(0)="S^S:SELECT;A:ALL",DIR("B")="SELECT",DIR("A")="Print Report for Selected Institutions, or All Institutions" D  D ^DIR K DIR I Y["^"!($D(DTOUT))!($D(DUOUT)) W !!,"Nothing queued to print.",! Q
"RTN","PSOTPCRP",11,0)
 .S DIR("?")=" ",DIR("?",1)="Enter 'S' to select one or more Institutions to print the report for,",DIR("?",2)="Enter 'A' to print the report for all Institutions."
"RTN","PSOTPCRP",12,0)
 I Y="A" S PSOGPINS=1 G PASS
"RTN","PSOTPCRP",13,0)
 S PSOGOK=0
"RTN","PSOTPCRP",14,0)
INSTX ;Ask for individual Institutions
"RTN","PSOTPCRP",15,0)
 K DIC S DIC(0)="QEAMZ",DIC=4 D  W ! D ^DIC K DIC I 'PSOGOK,(Y<1!($D(DUOUT))!($D(DTOUT))) W !!,"Nothing queued to print.",! Q
"RTN","PSOTPCRP",16,0)
 .I 'PSOGOK,$G(DUZ(2)) S DIC("B")=DUZ(2)
"RTN","PSOTPCRP",17,0)
 .I PSOGOK S DIC("A")="Select another INSTITUTION NAME:"
"RTN","PSOTPCRP",18,0)
 I Y>0 S PSOGPAR(+Y)="",PSOGOK=1 G INSTX
"RTN","PSOTPCRP",19,0)
 I '$O(PSOGPAR(0)) W !,"No Institutions selected, nothing queued to print.",! Q
"RTN","PSOTPCRP",20,0)
PASS ;
"RTN","PSOTPCRP",21,0)
ACT ;Ask for type of report
"RTN","PSOTPCRP",22,0)
 W ! K DIR S DIR(0)="S^A:ALL PATIENTS;E:ELIGIBLE PATIENTS;I:INELIGIBLE PATIENTS",DIR("B")="ALL PATIENTS",DIR("A")="Select patients for report" D  D ^DIR K DIR I Y["^"!($D(DTOUT))!($D(DUOUT)) W !!,"Nothing queued to print.",! Q
"RTN","PSOTPCRP",23,0)
 .S DIR("?")=" ",DIR("?",1)="To see only those patients currently eligible for the Transitional Pharmacy",DIR("?",2)="Benefit program, enter 'E'. To see all patients currently in the TPB"
"RTN","PSOTPCRP",24,0)
 .S DIR("?",3)="ELIGIBILITY file (#52.91), but not currently eligible for the benefit,",DIR("?",4)="enter 'I'. To see all patients in the TPB ELIGIBILITY file (#52.91),"
"RTN","PSOTPCRP",25,0)
 .S DIR("?",5)="both eligible and ineligible, enter 'A'."
"RTN","PSOTPCRP",26,0)
 S PSOGSORT=Y
"RTN","PSOTPCRP",27,0)
 W ! K IOP,%ZIS,POP S %ZIS="QM" D ^%ZIS I $G(POP) W !!,"Nothing queued to print.",! Q
"RTN","PSOTPCRP",28,0)
 I $D(IO("Q")) S ZTRTN="START^PSOTPCRP",ZTDESC="TPB ELIGIBILITY Report",ZTSAVE("PSOGPINS")="",ZTSAVE("PSOGSORT")="",ZTSAVE("PSOGPAR(")="" D ^%ZTLOAD K %ZIS W !,"Report queued to print.",! K ZTRTN,ZTDESC,ZTSAVE Q
"RTN","PSOTPCRP",29,0)
START ;
"RTN","PSOTPCRP",30,0)
 K ^TMP("PSOGP",$J)
"RTN","PSOTPCRP",31,0)
 U IO
"RTN","PSOTPCRP",32,0)
 N DIC,DIQ,DA,DR,PSOGPOUT,PSOGDV,PSOGPAGE,PSOGTOP,PSOGPLIN,PSOGLOP,PSOGNODE,PSOGNAME,PSOINAME,PSOTAR,PSOG1,PSOG2,PSOG3,PSOG4,DFN,VADM,PSOGSSN,PSOGSSNX,PSOXND,PSOXRS,VA,VAERR,PSOTINS,PSOTARX,PSOVADIS,PSOVADIX
"RTN","PSOTPCRP",33,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOTPCRP",34,0)
 S PSOGPOUT=0,PSOGDV=$S($E(IOST,1,2)'="C-":0,1:1),PSOGPAGE=1
"RTN","PSOTPCRP",35,0)
 S $P(PSOGPLIN,"-",79)=""
"RTN","PSOTPCRP",36,0)
 ;Set TMP global, store grand total count in PSOGTOP, Subtotals in PSOTAR array
"RTN","PSOTPCRP",37,0)
 S PSOGTOP=0
"RTN","PSOTPCRP",38,0)
 F PSOGLOP=0:0 S PSOGLOP=$O(^PS(52.91,PSOGLOP)) Q:'PSOGLOP  D
"RTN","PSOTPCRP",39,0)
 .S PSOGNODE=$G(^PS(52.91,PSOGLOP,0)) I 'PSOGNODE Q
"RTN","PSOTPCRP",40,0)
 .;If selecting institutions, and patient if file with no Institution won't show on the report??
"RTN","PSOTPCRP",41,0)
 .I 'PSOGPINS,'$D(PSOGPAR(+$P(PSOGNODE,"^",8))),$P(PSOGNODE,"^",8) Q
"RTN","PSOTPCRP",42,0)
 .I PSOGSORT="E",$P(PSOGNODE,"^",3),$P(PSOGNODE,"^",3)'>DT Q
"RTN","PSOTPCRP",43,0)
 .I PSOGSORT="I" I '$P(PSOGNODE,"^",3)!($P(PSOGNODE,"^",3)>DT) Q
"RTN","PSOTPCRP",44,0)
 .K VADM S DFN=+$P(PSOGNODE,"^") I 'DFN Q
"RTN","PSOTPCRP",45,0)
 .D DEM^VADPT I $G(VADM(1))="" K VADM Q
"RTN","PSOTPCRP",46,0)
 .S PSOGNAME=$G(VADM(1))
"RTN","PSOTPCRP",47,0)
 .K VADM
"RTN","PSOTPCRP",48,0)
 .K VA,VAERR S DFN=+$P(PSOGNODE,"^") D PID^VADPT6
"RTN","PSOTPCRP",49,0)
 .S PSOGNAME=PSOGNAME_"("_$G(VA("BID"))_")"
"RTN","PSOTPCRP",50,0)
 .K VA,VAERR
"RTN","PSOTPCRP",51,0)
 .S ^TMP("PSOGP",$J,$S($P(PSOGNODE,"^",8):$P(PSOGNODE,"^",8),1:"NONE"),PSOGNAME,$P(PSOGNODE,"^"),PSOGLOP)="",PSOGTOP=PSOGTOP+1
"RTN","PSOTPCRP",52,0)
 .I $P(PSOGNODE,"^",8) S PSOTAR($P(PSOGNODE,"^",8))=$G(PSOTAR($P(PSOGNODE,"^",8)))+1 Q
"RTN","PSOTPCRP",53,0)
 .S PSOTAR("NONE")=$G(PSOTAR("NONE"))+1
"RTN","PSOTPCRP",54,0)
 ;D HD
"RTN","PSOTPCRP",55,0)
 I 'PSOGTOP D HD W !!,"No patients found that meet report criteria.",! G END
"RTN","PSOTPCRP",56,0)
 S PSOG1="" F  S PSOG1=$O(^TMP("PSOGP",$J,PSOG1)) Q:PSOG1=""!(PSOGPOUT)  D
"RTN","PSOTPCRP",57,0)
 .I $G(PSOG1)="NONE" S PSOINAME="NONE"
"RTN","PSOTPCRP",58,0)
 .I $G(PSOG1)'="NONE" K PSOTINS,DIC,DIQ,DA,DR S DIC=4,DR=".01",DA=+PSOG1,DIQ(0)="E",DIQ="PSOTINS" D EN^DIQ1 S PSOINAME=$G(PSOTINS(4,+PSOG1,.01,"E")) K DIC,DIQ,DR,DA,PSOTINS
"RTN","PSOTPCRP",59,0)
 .D HD I PSOGPOUT Q
"RTN","PSOTPCRP",60,0)
 .S PSOTARX=0
"RTN","PSOTPCRP",61,0)
 .S PSOG2="" F  S PSOG2=$O(^TMP("PSOGP",$J,PSOG1,PSOG2)) Q:PSOG2=""!(PSOGPOUT)  F PSOG3=0:0 S PSOG3=$O(^TMP("PSOGP",$J,PSOG1,PSOG2,PSOG3)) Q:'PSOG3!(PSOGPOUT)  D
"RTN","PSOTPCRP",62,0)
 ..F PSOG4=0:0 S PSOG4=$O(^TMP("PSOGP",$J,PSOG1,PSOG2,PSOG3,PSOG4)) Q:'PSOG4!(PSOGPOUT)  D
"RTN","PSOTPCRP",63,0)
 ...S PSOXND=$G(^PS(52.91,PSOG4,0))
"RTN","PSOTPCRP",64,0)
 ...D ADDR
"RTN","PSOTPCRP",65,0)
 ...S PSOTARX=PSOTARX+1
"RTN","PSOTPCRP",66,0)
 ...W !!,PSOG2
"RTN","PSOTPCRP",67,0)
 ...W ?38,$S($P(PSOXND,"^",2):$E($P(PSOXND,"^",2),4,5)_"/"_$E($P(PSOXND,"^",2),6,7)_"/"_$E($P(PSOXND,"^",2),2,3),1:"")
"RTN","PSOTPCRP",68,0)
 ...W ?47,$S($P(PSOXND,"^",3):$E($P(PSOXND,"^",3),4,5)_"/"_$E($P(PSOXND,"^",3),6,7)_"/"_$E($P(PSOXND,"^",3),2,3),1:"")
"RTN","PSOTPCRP",69,0)
 ...W ?56,$S($P(PSOXND,"^",12):$E($P(PSOXND,"^",12),4,5)_"/"_$E($P(PSOXND,"^",12),6,7)_"/"_$E($P(PSOXND,"^",12),2,3),1:"")
"RTN","PSOTPCRP",70,0)
 ...S PSOXRS=$P(PSOXND,"^",4)
"RTN","PSOTPCRP",71,0)
 ...W ?65,$S(PSOXRS=1:"VA Provider",PSOXRS=2:"No/Show/Cancel",PSOXRS=3:"Patient Ended",PSOXRS=4:"N/F Rx",PSOXRS=5:"Patient Expired",PSOXRS=6:"Rx's Inactive",PSOXRS=7:"Exclusion",PSOXRS=8:"Refused Appt.",PSOXRS=9:"Pat Unreachable",1:"")
"RTN","PSOTPCRP",72,0)
 ...I $P(PSOXND,"^",9) D
"RTN","PSOTPCRP",73,0)
 ....I $P(PSOXND,"^",9)=1 W !?1,"Exclusion: ACTIVE RX "_$P(PSOXND,"^",11) Q
"RTN","PSOTPCRP",74,0)
 ....I $P(PSOXND,"^",9)=2 W !?1,"Exclusion: ACTUAL APPT. <30 DAYS FROM DATE APPT. MADE" Q
"RTN","PSOTPCRP",75,0)
 ....I $P(PSOXND,"^",9)=3 W !?1,"Exclusion: ACTIVE RX "_$P(PSOXND,"^",11)_" & ACTUAL APPT. <30 DAYS FROM DATE APPT. MADE"
"RTN","PSOTPCRP",76,0)
 ...I ($Y+6)>IOSL,$G(PSOVADIS)'="" D HD I PSOGPOUT K PSOVADIS,PSOVADIX Q
"RTN","PSOTPCRP",77,0)
 ...I $G(PSOVADIS)'="" W !,$G(PSOVADIS)
"RTN","PSOTPCRP",78,0)
 ...I ($Y+6)>IOSL,$G(PSOVADIX)'="" D HD I PSOGPOUT K PSOVADIS,PSOVADIX Q
"RTN","PSOTPCRP",79,0)
 ...I $G(PSOVADIX)'="" W !,$G(PSOVADIX)
"RTN","PSOTPCRP",80,0)
 ...K PSOVADIS,PSOVADIX
"RTN","PSOTPCRP",81,0)
 ...I ($Y+6)>IOSL,PSOTARX'=$G(PSOTAR(PSOG1)) D HD
"RTN","PSOTPCRP",82,0)
 G END
"RTN","PSOTPCRP",83,0)
HD ;HEADER
"RTN","PSOTPCRP",84,0)
 I PSOGDV,PSOGPAGE'=1 W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue, '^' to exit" D ^DIR K DIR I 'Y S PSOGPOUT=1 Q
"RTN","PSOTPCRP",85,0)
 I PSOGPAGE=1,'PSOGDV W ! I 1
"RTN","PSOTPCRP",86,0)
 E  W @IOF
"RTN","PSOTPCRP",87,0)
 W !,$S(PSOGSORT="E":"Eligible Patients",PSOGSORT="I":"Ineligible Patients",1:"All Patients")_$S($G(PSOINAME)="":"",1:" (")_$G(PSOINAME)_$S($G(PSOINAME)="":"",1:")")_"  Total: "_$S($G(PSOG1)'="":$G(PSOTAR(PSOG1)),1:""),?68,"PAGE: "_PSOGPAGE
"RTN","PSOTPCRP",88,0)
 S PSOGPAGE=PSOGPAGE+1
"RTN","PSOTPCRP",89,0)
 ;I $G(PSOINAME)'="" W !,"("_PSOINAME_")"_"  Total: ",$G(PSOTAR(PSOG1))
"RTN","PSOTPCRP",90,0)
 W !,"Grand Total: "_PSOGTOP,?38,"Start",?47,"Stop",?56,"Letter",?65,"Inactivation",!,"Patient",?38,"Date",?47,"Date",?56,"Date",?65,"Reason",!,PSOGPLIN
"RTN","PSOTPCRP",91,0)
 Q
"RTN","PSOTPCRP",92,0)
END ;End report
"RTN","PSOTPCRP",93,0)
 K ^TMP("PSOGP",$J),PSOGPAR,PSOGSORT,PSOGPINS
"RTN","PSOTPCRP",94,0)
 I '$G(PSOGPOUT),PSOGDV W !!,"End of Report." K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOTPCRP",95,0)
 I 'PSOGDV W !!,"End of Report."
"RTN","PSOTPCRP",96,0)
 I PSOGDV W !
"RTN","PSOTPCRP",97,0)
 E  W @IOF
"RTN","PSOTPCRP",98,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTPCRP",99,0)
 Q
"RTN","PSOTPCRP",100,0)
ADDR ;Check for difference in State
"RTN","PSOTPCRP",101,0)
 N PSOVA1,PSOVA2,VAPA
"RTN","PSOTPCRP",102,0)
 S (PSOVADIX,PSOVADIS)=""
"RTN","PSOTPCRP",103,0)
 S DFN=$P($G(^PS(52.91,PSOG4,0)),"^")
"RTN","PSOTPCRP",104,0)
 I '$G(DFN) Q
"RTN","PSOTPCRP",105,0)
 D ADD^VADPT
"RTN","PSOTPCRP",106,0)
 I '$G(VAPA(12)) K VAPA G ADDRX
"RTN","PSOTPCRP",107,0)
 I $P($G(VAPA(22,1)),"^",3)'="Y",$P($G(VAPA(22,2)),"^",3)'="Y",$P($G(VAPA(22,5)),"^",3)'="Y" K VAPA G ADDRX
"RTN","PSOTPCRP",108,0)
 S PSOVADIS="Confidential State = "_$P($G(VAPA(17)),"^",2)
"RTN","PSOTPCRP",109,0)
 I $G(VAPA(5))'=$G(VAPA(17)) S PSOVADIX=$S($G(VAPA(9)):"Temporary State = ",1:"Permanent State = ")_$P($G(VAPA(5)),"^",2)
"RTN","PSOTPCRP",110,0)
 K VAPA
"RTN","PSOTPCRP",111,0)
 Q
"RTN","PSOTPCRP",112,0)
ADDRX ;
"RTN","PSOTPCRP",113,0)
 K VAPA D ADD^VADPT I '$G(VAPA(9)) S PSOVADIS="Permanent State = "_$P($G(VAPA(5)),"^",2) K VAPA Q
"RTN","PSOTPCRP",114,0)
 S PSOVADIS="Temporary State = "_$P($G(VAPA(5)),"^",2)
"RTN","PSOTPCRP",115,0)
 S PSOVA1=$G(VAPA(5))
"RTN","PSOTPCRP",116,0)
 K VAPA S VAPA("P")="" D ADD^VADPT
"RTN","PSOTPCRP",117,0)
 S PSOVA2=$G(VAPA(5))
"RTN","PSOTPCRP",118,0)
 I PSOVA1=PSOVA2 K VAPA Q
"RTN","PSOTPCRP",119,0)
 S PSOVADIX="Permanent State = "_$P($G(PSOVA2),"^",2)
"RTN","PSOTPCRP",120,0)
 K VAPA
"RTN","PSOTPCRP",121,0)
 Q
"RTN","PSOTPHL1")
0^8^B72097367
"RTN","PSOTPHL1",1,0)
PSOTPHL1 ;BPFO/EL-CREATE HL7 BATCH MESSAGE FILE ;09/10/03
"RTN","PSOTPHL1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**146,153,227**;DEC 1997
"RTN","PSOTPHL1",3,0)
 ;
"RTN","PSOTPHL1",4,0)
 ; Summary:
"RTN","PSOTPHL1",5,0)
 ; Use of ^VAFCQRY API is approved under private IA #3630
"RTN","PSOTPHL1",6,0)
 ; For initial run, makes sure the "Transmission End Date" (#46.2) in 
"RTN","PSOTPHL1",7,0)
 ;    File 59.7 - Pharmacy System File is null.
"RTN","PSOTPHL1",8,0)
 ; If field (#46.2) is null, the system will pick up all DFN in File 52.91 
"RTN","PSOTPHL1",9,0)
 ;    from the first date of file creation to the "RunDate"-1.
"RTN","PSOTPHL1",10,0)
 ; If field (#46.2) has a date, the system will pick up DFN starting 
"RTN","PSOTPHL1",11,0)
 ;    from the last "Transmission End Date"+1 to the "RunDate"-1.
"RTN","PSOTPHL1",12,0)
 ; This program only runs on Sunday.  RunTime will be 6pm.
"RTN","PSOTPHL1",13,0)
 ; Tab: EN^PSOTPHL1(RDT,EDT,.SDT) is the ad-hoc entry point if user 
"RTN","PSOTPHL1",14,0)
 ;    wants to run it at certain "Transmission Begin Date", 
"RTN","PSOTPHL1",15,0)
 ;    "Transmission End Date", & return actual "Transmission Begin Date".       
"RTN","PSOTPHL1",16,0)
 ; If run is success, an audit node will be placed at File 59.7 as:
"RTN","PSOTPHL1",17,0)
 ;    ^PS(59.7,D0,46)=TransmissionStartDt_"^"_TransmissionEndDt_"^"_MshID_"^"_MshCnt_"^"_LineCnt
"RTN","PSOTPHL1",18,0)
 ;
"RTN","PSOTPHL1",19,0)
 ; At the end of each run, this program will send out mail to the mail
"RTN","PSOTPHL1",20,0)
 ;   group "PSO TPB HL7 EXTRACT" except the non-Sunday TaskMan check
"RTN","PSOTPHL1",21,0)
 ;
"RTN","PSOTPHL1",22,0)
 Q  ; placed out of order by PSO*7*227
"RTN","PSOTPHL1",23,0)
 N A,B,C,CK,EDT,ERR,FRTIME,I,L,R,RDT,SDT,SET,X
"RTN","PSOTPHL1",24,0)
 N BCNT,DATA,DFN,EVENT,LN,MCNT,PGM,PS,PSO
"RTN","PSOTPHL1",25,0)
 N BBDT,BEDT,DADT,EXC,INS,PADT,PN,REASON,STA,WAITYP
"RTN","PSOTPHL1",26,0)
 ;
"RTN","PSOTPHL1",27,0)
START S CK=0 D DATE I CK=1 G ENDS
"RTN","PSOTPHL1",28,0)
 ;  
"RTN","PSOTPHL1",29,0)
 D EN^PSOTPHL1(RDT,EDT,.SDT)
"RTN","PSOTPHL1",30,0)
 Q
"RTN","PSOTPHL1",31,0)
 ;
"RTN","PSOTPHL1",32,0)
DATE ; Check if first time run or Sunday
"RTN","PSOTPHL1",33,0)
 S (EDT,FRTIME,PS,SET)=0,PS=59.7
"RTN","PSOTPHL1",34,0)
 S EDT=$$GET1^DIQ(PS,"1,46",46.2,"I"),EDT=+EDT
"RTN","PSOTPHL1",35,0)
 D NOW^%DTC
"RTN","PSOTPHL1",36,0)
 D DW^%DTC
"RTN","PSOTPHL1",37,0)
 I EDT'>0 S FRTIME=1 G GDATE
"RTN","PSOTPHL1",38,0)
 I X'["SUN" S CK=1 Q
"RTN","PSOTPHL1",39,0)
 ;
"RTN","PSOTPHL1",40,0)
 S SDT=EDT+1
"RTN","PSOTPHL1",41,0)
GDATE S RDT="",SET=1
"RTN","PSOTPHL1",42,0)
 S RDT=$S(EDT:EDT,1:0)
"RTN","PSOTPHL1",43,0)
 S EDT=DT-1
"RTN","PSOTPHL1",44,0)
 Q
"RTN","PSOTPHL1",45,0)
 ;
"RTN","PSOTPHL1",46,0)
INIT ; Variable Initialization
"RTN","PSOTPHL1",47,0)
 S (BCNT,LN,MCNT,CK)=0
"RTN","PSOTPHL1",48,0)
 S PGM="PSOTPHL1"
"RTN","PSOTPHL1",49,0)
 S PSO=52.91
"RTN","PSOTPHL1",50,0)
 D INHL7
"RTN","PSOTPHL1",51,0)
 ;
"RTN","PSOTPHL1",52,0)
 K ^TMP("HLS",$J),^TMP(PGM,$J,EDT)
"RTN","PSOTPHL1",53,0)
 ;
"RTN","PSOTPHL1",54,0)
 Q
"RTN","PSOTPHL1",55,0)
 ;
"RTN","PSOTPHL1",56,0)
INHL7 S EVENT="PSO TPB EV"
"RTN","PSOTPHL1",57,0)
 I '$D(U) S U="^"
"RTN","PSOTPHL1",58,0)
 D INIT^HLFNC2(EVENT,.HL)
"RTN","PSOTPHL1",59,0)
 I $G(HL) S ERR=$P(HL,"^",2),CK=1 Q
"RTN","PSOTPHL1",60,0)
 D CREATE^HLTF(.HLMID,.HLDA,.HLDT,.HLDT1)
"RTN","PSOTPHL1",61,0)
 D INHD
"RTN","PSOTPHL1",62,0)
 Q
"RTN","PSOTPHL1",63,0)
 ;
"RTN","PSOTPHL1",64,0)
INHD I '$D(DTIME) S DTIME=0
"RTN","PSOTPHL1",65,0)
 I '$D(HL("DTM")) S HL("DTM")=HLDT1
"RTN","PSOTPHL1",66,0)
 I '$D(HL("FS")) S HL("FS")="^"
"RTN","PSOTPHL1",67,0)
 I '$D(HL("ECH")) S HL("ECH")="~|\&"
"RTN","PSOTPHL1",68,0)
 I '$D(HL("ETN")) S HL("ETN")="S12"
"RTN","PSOTPHL1",69,0)
 I '$D(HL("MTN")) S HL("MTN")="SIU"
"RTN","PSOTPHL1",70,0)
 I '$D(HL("MTN_ETN")) S HL("MTN_ETN")="SIU_S12"
"RTN","PSOTPHL1",71,0)
 I '$D(HL("PID")) S HL("PID")="P"
"RTN","PSOTPHL1",72,0)
 I '$D(HL("Q")) S HL("Q")=""""
"RTN","PSOTPHL1",73,0)
 I '$D(HL("VER")) S HL("VER")="2.4"
"RTN","PSOTPHL1",74,0)
 I '$D(HL("CC")) S HL("CC")="US"
"RTN","PSOTPHL1",75,0)
 I '$D(HL("ACAT")) S HL("ACAT")="AL"
"RTN","PSOTPHL1",76,0)
 I '$D(HL("APAT")) S HL("APAT")="NE"
"RTN","PSOTPHL1",77,0)
 I '$D(HL("SAN")) S HL("SAN")="PSO TPB-PHARM"
"RTN","PSOTPHL1",78,0)
 I '$D(HL("RAN")) S HL("RAN")="PSO TPB-ACC"
"RTN","PSOTPHL1",79,0)
 ;
"RTN","PSOTPHL1",80,0)
 Q
"RTN","PSOTPHL1",81,0)
 ;
"RTN","PSOTPHL1",82,0)
BHS ; CREATE "BHS" SEGMENT
"RTN","PSOTPHL1",83,0)
 S BCNT=BCNT+1
"RTN","PSOTPHL1",84,0)
 S LN=LN+1
"RTN","PSOTPHL1",85,0)
 ;
"RTN","PSOTPHL1",86,0)
 Q
"RTN","PSOTPHL1",87,0)
 ;
"RTN","PSOTPHL1",88,0)
EN(RDT,EDT,SDT) ; ENTRY POINT FOR PROCESS
"RTN","PSOTPHL1",89,0)
 D INIT I CK=1 G OUT
"RTN","PSOTPHL1",90,0)
 D BHS
"RTN","PSOTPHL1",91,0)
 D PROCESS
"RTN","PSOTPHL1",92,0)
 D BTS
"RTN","PSOTPHL1",93,0)
 G OUT
"RTN","PSOTPHL1",94,0)
 ;
"RTN","PSOTPHL1",95,0)
PROCESS ; Sort and Process the message body
"RTN","PSOTPHL1",96,0)
 I '$D(SET) S SDT=RDT,RDT=RDT-1
"RTN","PSOTPHL1",97,0)
 I $G(FRTIME)=1 D FRTIME
"RTN","PSOTPHL1",98,0)
P10 S RDT=$O(^PS(PSO,"AX",RDT)) G P30:(RDT>EDT)!(RDT="")
"RTN","PSOTPHL1",99,0)
 I SDT>RDT S SDT=RDT
"RTN","PSOTPHL1",100,0)
 S DFN=""
"RTN","PSOTPHL1",101,0)
P20 S DFN=$O(^PS(PSO,"AX",RDT,DFN)) G P10:DFN=""
"RTN","PSOTPHL1",102,0)
 I '$D(^PS(PSO,DFN,0)) K ^PS(PSO,"AX",RDT,DFN) G P20
"RTN","PSOTPHL1",103,0)
 S ^TMP(PGM,$J,EDT,"ZZ",DFN)=RDT
"RTN","PSOTPHL1",104,0)
 G P20
"RTN","PSOTPHL1",105,0)
 ;
"RTN","PSOTPHL1",106,0)
FRTIME ; To generate a complete data set for the frist time 
"RTN","PSOTPHL1",107,0)
 S (DFN,RDT,X)=""
"RTN","PSOTPHL1",108,0)
 S SDT=999999999
"RTN","PSOTPHL1",109,0)
F10 S DFN=$O(^PS(PSO,DFN)) Q:(DFN'?1N.N)!(DFN="")
"RTN","PSOTPHL1",110,0)
 I '$D(^PS(PSO,DFN,0)) G F10
"RTN","PSOTPHL1",111,0)
 S X=$P(^PS(PSO,DFN,0),"^",2)
"RTN","PSOTPHL1",112,0)
 I SDT>X S SDT=X
"RTN","PSOTPHL1",113,0)
 S ^TMP(PGM,$J,EDT,"ZZ",DFN)=X
"RTN","PSOTPHL1",114,0)
 G F10
"RTN","PSOTPHL1",115,0)
 ;
"RTN","PSOTPHL1",116,0)
P30 I '$D(^TMP(PGM,$J,EDT,"ZZ")) D  G GEN
"RTN","PSOTPHL1",117,0)
 .  S MCNT=0
"RTN","PSOTPHL1",118,0)
 .  D MSH^HLFNC2(.HL,HLMID_"-"_MCNT,.X,"")
"RTN","PSOTPHL1",119,0)
 .  D WRITE
"RTN","PSOTPHL1",120,0)
 ;
"RTN","PSOTPHL1",121,0)
 S DFN=""
"RTN","PSOTPHL1",122,0)
DFN S DFN=$O(^TMP(PGM,$J,EDT,"ZZ",DFN)) G GEN:DFN=""
"RTN","PSOTPHL1",123,0)
 S RDT=^TMP(PGM,$J,EDT,"ZZ",DFN)
"RTN","PSOTPHL1",124,0)
 D EXTRACT
"RTN","PSOTPHL1",125,0)
 D MSH
"RTN","PSOTPHL1",126,0)
 D SCH
"RTN","PSOTPHL1",127,0)
 D PID
"RTN","PSOTPHL1",128,0)
 G DFN
"RTN","PSOTPHL1",129,0)
 ;
"RTN","PSOTPHL1",130,0)
GEN S HLP="" D GENERATE^HLMA(EVENT,"GB",1,.R,HLDA,.HLP)
"RTN","PSOTPHL1",131,0)
 Q
"RTN","PSOTPHL1",132,0)
 ;
"RTN","PSOTPHL1",133,0)
EXTRACT ; Extract data from File 52.91
"RTN","PSOTPHL1",134,0)
 S (A,B,BBDT,BEDT,C,DADT,DATA,EXC,INS,PADT,PN,REASON,STA,WAITYP,X)=""
"RTN","PSOTPHL1",135,0)
 S X=^PS(PSO,DFN,0)
"RTN","PSOTPHL1",136,0)
 S DATA="PN,BBDT,BEDT,REASON,DADT,WAITYP,STA,INS,EXC,PADT"
"RTN","PSOTPHL1",137,0)
 F I=1:1:10 S @$P(DATA,",",I)=$P(X,"^",I)
"RTN","PSOTPHL1",138,0)
 I $D(PADT) S PADT=$P(PADT,".")
"RTN","PSOTPHL1",139,0)
 I +BBDT=+RDT S HL("ETN")="S12"
"RTN","PSOTPHL1",140,0)
 E  S HL("ETN")="S14"
"RTN","PSOTPHL1",141,0)
 S HL("MTN_ETN")=HL("MTN")_"_"_HL("ETN")
"RTN","PSOTPHL1",142,0)
 S A="BBDT,BEDT,DADT,PADT"
"RTN","PSOTPHL1",143,0)
 F I=1:1:4 S B=$P(A,",",I) I $G(@B)>0 S C=$$HLDATE^HLFNC(@B,"DT"),@$P(A,",",I)=C
"RTN","PSOTPHL1",144,0)
 Q
"RTN","PSOTPHL1",145,0)
 ;
"RTN","PSOTPHL1",146,0)
MSH ; CREATE "MSH" SEGMENT
"RTN","PSOTPHL1",147,0)
 S MCNT=MCNT+1
"RTN","PSOTPHL1",148,0)
 D MSH^HLFNC2(.HL,HLMID_"-"_MCNT,.X,"")
"RTN","PSOTPHL1",149,0)
 ;
"RTN","PSOTPHL1",150,0)
 D WRITE
"RTN","PSOTPHL1",151,0)
 Q
"RTN","PSOTPHL1",152,0)
 ;
"RTN","PSOTPHL1",153,0)
SCH ; CREATE "SCH" SEGMENT
"RTN","PSOTPHL1",154,0)
 K SCH S (X,A,B,C)="",I=0 S:REASON>9 REASON=9
"RTN","PSOTPHL1",155,0)
 S X="Seen by VA Provider,No/Show/Cancellation,Patient Ended"
"RTN","PSOTPHL1",156,0)
 S X=X_",Non-Formulary Rx not accepted,Patient Expired,All Rx's Inactive"
"RTN","PSOTPHL1",157,0)
 S X=X_",Exclusion,Patient Refused Appointment,Patient Unreachable"
"RTN","PSOTPHL1",158,0)
 S A=$P(X,",",REASON)
"RTN","PSOTPHL1",159,0)
 ;
"RTN","PSOTPHL1",160,0)
 S X="" S:EXC>3 EXC=3
"RTN","PSOTPHL1",161,0)
 S X="Excluded due to active Rx#"
"RTN","PSOTPHL1",162,0)
 S X=X_",Excluded due to actual appt<30 days from desired appt date"
"RTN","PSOTPHL1",163,0)
 S X=X_",Exclued due to active Rx# and actual appt<30 days from desired appt date"
"RTN","PSOTPHL1",164,0)
 S B=$P(X,",",EXC)
"RTN","PSOTPHL1",165,0)
 ;
"RTN","PSOTPHL1",166,0)
 I WAITYP="E" S C="EWL"
"RTN","PSOTPHL1",167,0)
 E  I WAITYP="M" S C="Manual"
"RTN","PSOTPHL1",168,0)
 E  I WAITYP="S" S C="Schedule"
"RTN","PSOTPHL1",169,0)
 E  S C="S\T\E"
"RTN","PSOTPHL1",170,0)
 ;
"RTN","PSOTPHL1",171,0)
 S X=""
"RTN","PSOTPHL1",172,0)
 S X=HL("FS")_HL("FS")_HL("FS")_HL("FS")_HL("FS")_HL("FS")_REASON_"~"_A
"RTN","PSOTPHL1",173,0)
 S X=X_HL("FS")_EXC_"~"_B_HL("FS")_WAITYP_"~"_C
"RTN","PSOTPHL1",174,0)
 S X=X_HL("FS")_HL("FS")_HL("FS")
"RTN","PSOTPHL1",175,0)
 S I=I+1,SCH(I)="SCH"_X
"RTN","PSOTPHL1",176,0)
 ;
"RTN","PSOTPHL1",177,0)
 S X="",X=X_"~~~"_DADT_"~~~~Desired Appointment Date|~~~"
"RTN","PSOTPHL1",178,0)
 S X=X_PADT_"~~~~Primary Care Scheduled Appointment Date|~~~"
"RTN","PSOTPHL1",179,0)
 S X=X_BBDT_"~~~~Date Pharmacy Benefit Began|~~~"
"RTN","PSOTPHL1",180,0)
 S X=X_BEDT_"~~~~Inactivation of Benefit Date|~~~"
"RTN","PSOTPHL1",181,0)
 S X=X_$$HLDATE^HLFNC(RDT,"DT")_"~~~~Record Change Date"
"RTN","PSOTPHL1",182,0)
 I $L(SCH(I)_X)<246 S SCH(I)=SCH(I)_X
"RTN","PSOTPHL1",183,0)
 E  S I=I+1,SCH(I)=X
"RTN","PSOTPHL1",184,0)
 ;
"RTN","PSOTPHL1",185,0)
 S X="",$P(X,"^",12)=STA_"~~~"_INS_"&"_$$GET1^DIQ(4,INS_",0",.01)
"RTN","PSOTPHL1",186,0)
 I $L(SCH(I)_X)<246 S SCH(I)=SCH(I)_X
"RTN","PSOTPHL1",187,0)
 E  S I=I+1,SCH(I)=X
"RTN","PSOTPHL1",188,0)
 ;
"RTN","PSOTPHL1",189,0)
 F I=1:1 S X=$G(SCH(I)) Q:X=""  D
"RTN","PSOTPHL1",190,0)
 . I I=1 D WRITE
"RTN","PSOTPHL1",191,0)
 . E  D WRITEN
"RTN","PSOTPHL1",192,0)
 Q
"RTN","PSOTPHL1",193,0)
 ;
"RTN","PSOTPHL1",194,0)
PID ; CREATE "PID" SEGMENT
"RTN","PSOTPHL1",195,0)
 K PID
"RTN","PSOTPHL1",196,0)
 D DEM^VADPT,ADD^VADPT
"RTN","PSOTPHL1",197,0)
 D BLDPID^PSOTPHL2(DFN,1,.PID,.HL,.ERR)
"RTN","PSOTPHL1",198,0)
 Q:$G(PID(1))=""
"RTN","PSOTPHL1",199,0)
 S X=""
"RTN","PSOTPHL1",200,0)
 F I=1:1 S X=$G(PID(I)) Q:X=""  D
"RTN","PSOTPHL1",201,0)
 . I I=1 D WRITE
"RTN","PSOTPHL1",202,0)
 . E  D WRITEN
"RTN","PSOTPHL1",203,0)
 Q
"RTN","PSOTPHL1",204,0)
 ;
"RTN","PSOTPHL1",205,0)
BTS ; CREATE "BTS" SEGMENT
"RTN","PSOTPHL1",206,0)
 S LN=LN+1
"RTN","PSOTPHL1",207,0)
 Q
"RTN","PSOTPHL1",208,0)
 ;
"RTN","PSOTPHL1",209,0)
WRITE ; Write single line
"RTN","PSOTPHL1",210,0)
 S LN=LN+1
"RTN","PSOTPHL1",211,0)
 S ^TMP("HLS",$J,LN)=X
"RTN","PSOTPHL1",212,0)
 Q
"RTN","PSOTPHL1",213,0)
 ;
"RTN","PSOTPHL1",214,0)
WRITEN ; Write multiple lines
"RTN","PSOTPHL1",215,0)
 S ^TMP("HLS",$J,LN,I-1)=X
"RTN","PSOTPHL1",216,0)
 Q
"RTN","PSOTPHL1",217,0)
 ;
"RTN","PSOTPHL1",218,0)
CLEANUP ; Clean up variables
"RTN","PSOTPHL1",219,0)
 K A,B,C,CK,EDT,ERR,I,L,R,RDT,SDT,X
"RTN","PSOTPHL1",220,0)
 K BCNT,DATA,DFN,EVENT,LN,MCNT,PGM,PS,PSO
"RTN","PSOTPHL1",221,0)
 K BBDT,BEDT,DADT,EXC,INS,PADT,PN,REASON,STA,WAITYP
"RTN","PSOTPHL1",222,0)
 Q
"RTN","PSOTPHL1",223,0)
 ;
"RTN","PSOTPHL1",224,0)
OUT ; End of compilation
"RTN","PSOTPHL1",225,0)
 I CK=1 G END
"RTN","PSOTPHL1",226,0)
 K ^TMP("HLS",$J),^TMP(PGM,$J,EDT),PID,SCH
"RTN","PSOTPHL1",227,0)
 I SDT>EDT S SDT=EDT
"RTN","PSOTPHL1",228,0)
 I $G(SET)=1 S ^PS(PS,1,46)=SDT_"^"_EDT_"^"_HLDA_"^"_MCNT_"^"_LN
"RTN","PSOTPHL1",229,0)
 ;
"RTN","PSOTPHL1",230,0)
END D MAIL
"RTN","PSOTPHL1",231,0)
 I $G(SET)'=1 D CLEANUP
"RTN","PSOTPHL1",232,0)
ENDS I $G(FRTIME)=1 D RESET
"RTN","PSOTPHL1",233,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTPHL1",234,0)
 Q
"RTN","PSOTPHL1",235,0)
 ;
"RTN","PSOTPHL1",236,0)
RESET ; Reset to run tomorrow
"RTN","PSOTPHL1",237,0)
 D RESCH^XUTMOPT("PSO TPB HL7 EXTRACT","T+1@18:00","","24H","L")
"RTN","PSOTPHL1",238,0)
 Q
"RTN","PSOTPHL1",239,0)
 ;
"RTN","PSOTPHL1",240,0)
RESET1 ; Reset to run tomorrow
"RTN","PSOTPHL1",241,0)
 D RESET,EDIT^XUTMOPT("PSO TPB HL7 EXTRACT")
"RTN","PSOTPHL1",242,0)
 Q
"RTN","PSOTPHL1",243,0)
 ;
"RTN","PSOTPHL1",244,0)
MAIL ;Send mail message
"RTN","PSOTPHL1",245,0)
 I '$G(DUZ) Q
"RTN","PSOTPHL1",246,0)
 K PSOTTEXT,XMY S (XMDUZ,XMSUB,XMTEST,A,B,C,I,L,R,X)=""
"RTN","PSOTPHL1",247,0)
 S C="G.PSO TPB HL7 EXTRACT"
"RTN","PSOTPHL1",248,0)
 S XMY(C)=""
"RTN","PSOTPHL1",249,0)
 S PSOTTEXT(1)="SENT TO: "_C
"RTN","PSOTPHL1",250,0)
 S XMDUZ="PSO TPB HL7 EXTRACT"
"RTN","PSOTPHL1",251,0)
 S (A,B)=""
"RTN","PSOTPHL1",252,0)
 I '$D(SET) S A="Ad-Hoc"
"RTN","PSOTPHL1",253,0)
 E  S A=$S(($G(FRTIME)=1):"first-time",1:"weekly")
"RTN","PSOTPHL1",254,0)
 S B=$S(($G(CK)=1):"unsuccessful",1:"successful")
"RTN","PSOTPHL1",255,0)
 S XMSUB="PSO TPB HL7 "_A_" update ** "_B_" **"
"RTN","PSOTPHL1",256,0)
 S A=XMSUB
"RTN","PSOTPHL1",257,0)
 I $G(CK)=1 D FAIL
"RTN","PSOTPHL1",258,0)
 E  D SUCC
"RTN","PSOTPHL1",259,0)
 S PSOTTEXT(2)=" "
"RTN","PSOTPHL1",260,0)
 S PSOTTEXT(3)="The weekly generation of the HL7 Message of"
"RTN","PSOTPHL1",261,0)
 S PSOTTEXT(3.2)="TPB Patient Information was "_B
"RTN","PSOTPHL1",262,0)
 S PSOTTEXT(4)=""
"RTN","PSOTPHL1",263,0)
 S PSOTTEXT(5)=I
"RTN","PSOTPHL1",264,0)
 S PSOTTEXT(6)=L
"RTN","PSOTPHL1",265,0)
 S PSOTTEXT(6.2)=R
"RTN","PSOTPHL1",266,0)
 S PSOTTEXT(6.4)=X
"RTN","PSOTPHL1",267,0)
 S PSOTTEXT(7)=" "
"RTN","PSOTPHL1",268,0)
 D NOW^%DTC S Y=% X ^DD("DD") S PSOTTEXT(8)="The job ended at "_$G(Y)
"RTN","PSOTPHL1",269,0)
 S PSOTTEXT(9)=" "
"RTN","PSOTPHL1",270,0)
 S XMTEXT="PSOTTEXT(" N DIFROM D ^XMD
"RTN","PSOTPHL1",271,0)
 I $D(XMMG),(XMMG["Error =") D
"RTN","PSOTPHL1",272,0)
 .  K XMY(C)
"RTN","PSOTPHL1",273,0)
 .  S XMSUB=A,XMY(DUZ)="",PSOTTEXT(1)=PSOTTEXT(1)_"   ("_XMMG_")",XMMG=""
"RTN","PSOTPHL1",274,0)
 .  S XMTEXT="PSOTTEXT(" D ^XMD
"RTN","PSOTPHL1",275,0)
 K PSOTTEXT,XMDUZ,XMSUB,XMTEXT,XMY
"RTN","PSOTPHL1",276,0)
 Q
"RTN","PSOTPHL1",277,0)
FAIL ; Msg for unsuccessful run
"RTN","PSOTPHL1",278,0)
 S I="Reason: "_$S(($D(ERR)):ERR,1:"Check Event Server Protocol OR the run date")
"RTN","PSOTPHL1",279,0)
 S L=" "
"RTN","PSOTPHL1",280,0)
 S R="Please contact National Help Desk @888-596-4357"
"RTN","PSOTPHL1",281,0)
 S X=" "
"RTN","PSOTPHL1",282,0)
 Q
"RTN","PSOTPHL1",283,0)
 ;
"RTN","PSOTPHL1",284,0)
SUCC ; Msg for successful run
"RTN","PSOTPHL1",285,0)
 S I="Please check the PSOTPBAAC HL7 Logical Link to ensure"
"RTN","PSOTPHL1",286,0)
 S L="successful transmission to the Austin Automation Center."
"RTN","PSOTPHL1",287,0)
 S R=" "
"RTN","PSOTPHL1",288,0)
 S X="MSH-ID: "_HLDA
"RTN","PSOTPHL1",289,0)
 Q
"RTN","PSOTPHL1",290,0)
 ;
"RTN","PSOTPINA")
0^11^B6448418
"RTN","PSOTPINA",1,0)
PSOTPINA ;BIR/MR - Driver to Inactivate TPB patients ;12/01/03
"RTN","PSOTPINA",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**160,227**;DEC 1997
"RTN","PSOTPINA",3,0)
 ;
"RTN","PSOTPINA",4,0)
EN Q  ;placed out of order by PSO*7*227
"RTN","PSOTPINA",5,0)
 N PSOSDHL,PSOSDOE,TODAY,%,DIE,DA,DR,DO,PSOINA,X
"RTN","PSOTPINA",6,0)
 ; - Patient not defined
"RTN","PSOTPINA",7,0)
 I '$D(^DPT(+$G(DFN),0)) Q
"RTN","PSOTPINA",8,0)
 ;
"RTN","PSOTPINA",9,0)
 ; - Patient not in the TPB ELIGIBILITY file (#52.91)
"RTN","PSOTPINA",10,0)
 I '$D(^PS(52.91,DFN)) Q
"RTN","PSOTPINA",11,0)
 ;
"RTN","PSOTPINA",12,0)
 ; - Patient TPB's Benefit is INACTIVE
"RTN","PSOTPINA",13,0)
 I $$GET1^DIQ(52.91,DFN,2,"I") Q
"RTN","PSOTPINA",14,0)
 ;
"RTN","PSOTPINA",15,0)
 ; - At least ONE active TPB prescription found
"RTN","PSOTPINA",16,0)
 I $$ACTRX^PSOTPCUL(DFN,1) Q
"RTN","PSOTPINA",17,0)
 ;
"RTN","PSOTPINA",18,0)
 ; - Checking the OUTPATIENT ENCOUNTER
"RTN","PSOTPINA",19,0)
 S (PSOSDHL,PSOSDOE)="",PSOINA=0 D NOW^%DTC S TODAY=%\1
"RTN","PSOTPINA",20,0)
 F  S PSOSDHL=$O(^TMP("SDEVT",$J,PSOSDHL)) Q:'PSOSDHL  D  I PSOINA Q
"RTN","PSOTPINA",21,0)
 . F  S PSOSDOE=$O(^TMP("SDEVT",$J,PSOSDHL,1,"SDOE",PSOSDOE)) Q:'PSOSDOE  D  I PSOINA Q
"RTN","PSOTPINA",22,0)
 . . ;
"RTN","PSOTPINA",23,0)
 . . ; - Appointment is not CHECKED OUT
"RTN","PSOTPINA",24,0)
 . . I $$UP^XLFSTR($TR($$GET1^DIQ(409.68,PSOSDOE,.12),"- "))'="CHECKEDOUT" Q
"RTN","PSOTPINA",25,0)
 . . ;
"RTN","PSOTPINA",26,0)
 . . ; - STOP CODE for the Encounter Location not TPB
"RTN","PSOTPINA",27,0)
 . . I '$$TPBSC^PSOTPCUL($$GET1^DIQ(409.68,PSOSDOE,.04,"I")) Q
"RTN","PSOTPINA",28,0)
 . . ;
"RTN","PSOTPINA",29,0)
 . . ; Inactivate TPB benefits for the patient
"RTN","PSOTPINA",30,0)
 . . S DIE=52.91,DA=DFN,DR="2///"_TODAY_";3///1" D ^DIE S PSOINA=1
"RTN","PSOTPINA",31,0)
 . . ;
"RTN","PSOTPINA",32,0)
 . . ; - Send Mailman Message about TPB inactivation for Patient
"RTN","PSOTPINA",33,0)
 . . D MAIL(DFN,PSOSDOE)
"RTN","PSOTPINA",34,0)
 ;
"RTN","PSOTPINA",35,0)
 Q
"RTN","PSOTPINA",36,0)
 ;
"RTN","PSOTPINA",37,0)
MAIL(DFN,ENC) ; - Create/Send Mailman Message about Inactivation to 
"RTN","PSOTPINA",38,0)
 ;           PSO TPB GROUP (Mail Group)
"RTN","PSOTPINA",39,0)
 ;
"RTN","PSOTPINA",40,0)
 N XMTEXT,XMDUZ,XMSUB,XMY,VADM,CNAM,PNAM,DAT,MSG,DIFROM,X
"RTN","PSOTPINA",41,0)
 ;
"RTN","PSOTPINA",42,0)
 D DEM^VADPT S PNAM=$P(VADM(1),"^")_" ("_$P($P(VADM(2),"^",2),"-",3)_")"
"RTN","PSOTPINA",43,0)
 S DAT=$$GET1^DIQ(409.68,ENC,.01),CNAM=$$GET1^DIQ(409.68,ENC,.04)
"RTN","PSOTPINA",44,0)
 ;
"RTN","PSOTPINA",45,0)
 S XMDUZ="PHARMACY TPB SCHEDULING MONITOR"
"RTN","PSOTPINA",46,0)
 D SXMY^PSOTPCUL("PSO TPB GROUP")
"RTN","PSOTPINA",47,0)
 S XMSUB="TPB PATIENT BENEFIT INACTIVATION"
"RTN","PSOTPINA",48,0)
 ;
"RTN","PSOTPINA",49,0)
 S MSG(1)="The following patient had the TPB (Transitional Pharmacy Benefit) benefit"
"RTN","PSOTPINA",50,0)
 S MSG(2)="automatically inactivated because the following appointment was found: "
"RTN","PSOTPINA",51,0)
 S MSG(3)=" "
"RTN","PSOTPINA",52,0)
 S MSG(4)="     Patient         : "_PNAM
"RTN","PSOTPINA",53,0)
 S MSG(5)="     VA Clinic       : "_CNAM
"RTN","PSOTPINA",54,0)
 S MSG(6)="     Appointment Date: "_DAT
"RTN","PSOTPINA",55,0)
 ;
"RTN","PSOTPINA",56,0)
 S XMTEXT="MSG(" D ^XMD
"RTN","PSOTPINA",57,0)
 Q
"RTN","PSOTPRP1")
0^9^B22123133
"RTN","PSOTPRP1",1,0)
PSOTPRP1 ;BIR/MR - Report of Patients with TPB and Non-TBP Active Rx's ;12/03/03
"RTN","PSOTPRP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**160,227**;DEC 1997
"RTN","PSOTPRP1",3,0)
 ;
"RTN","PSOTPRP1",4,0)
EN ;
"RTN","PSOTPRP1",5,0)
 Q  ;placed out of order by PSO*7*227
"RTN","PSOTPRP1",6,0)
 N OINAM,INS,INSNAM,VADM,TYPE,DRGIEN,TPBRXCNT,SEQ,DFN,RXIEN,RXEXT,RX,POP
"RTN","PSOTPRP1",7,0)
 N PSOPAT,PSOAINS,PATNAM,PATCNT,PAT,PAG,INST,PATSSN,PSOAPT,VARXCNT,Y
"RTN","PSOTPRP1",8,0)
 ;
"RTN","PSOTPRP1",9,0)
 W !!,"This report prints entries from the TPB ELIGIBILITY file (#52.91)."
"RTN","PSOTPRP1",10,0)
 W !,"If multiple Institutions are selected, and some Institutions have data and"
"RTN","PSOTPRP1",11,0)
 W !,"some don't, only those Institutions that have data will print on the report.",!
"RTN","PSOTPRP1",12,0)
 ;
"RTN","PSOTPRP1",13,0)
 ;Ask for Institutions
"RTN","PSOTPRP1",14,0)
 N DIC,X,I K PSOINS S PSOAINS=0
"RTN","PSOTPRP1",15,0)
 W !,?5,"You may select a single or multiple INSTITUTIONS,"
"RTN","PSOTPRP1",16,0)
 W !,?5,"or enter ^ALL to select all INSTITUTIONS.",!
"RTN","PSOTPRP1",17,0)
 S DIC=4,DIC(0)="QEAM",DIC("A")="     INSTITUTION: "
"RTN","PSOTPRP1",18,0)
 F  D ^DIC Q:Y<0  S PSOINS(+Y)="" K DIC("B")
"RTN","PSOTPRP1",19,0)
 I X="^ALL" S PSOAINS=1 K PSOINS,DUOUT G PAT
"RTN","PSOTPRP1",20,0)
 I $D(DUOUT)!($D(DTOUT)) G END
"RTN","PSOTPRP1",21,0)
 I '$D(PSOINS)&(Y<0) G END
"RTN","PSOTPRP1",22,0)
 ;
"RTN","PSOTPRP1",23,0)
PAT ; - Selection of PATIENTS to print on the Report
"RTN","PSOTPRP1",24,0)
 N DIC,X,I K PSOPT S PSOAPT=0
"RTN","PSOTPRP1",25,0)
 W !!,?5,"You may select a single or multiple PATIENTS,"
"RTN","PSOTPRP1",26,0)
 W !,?5,"or enter ^ALL to select all PATIENTS.",!
"RTN","PSOTPRP1",27,0)
 S DIC=2,DIC(0)="QEAM",DIC("A")="     PATIENT: "
"RTN","PSOTPRP1",28,0)
 S DIC("S")="I $D(^PS(52.91,+Y))"
"RTN","PSOTPRP1",29,0)
 F  D ^DIC Q:Y<0  S PSOPT(+Y)="" K DIC("B")
"RTN","PSOTPRP1",30,0)
 I X="^ALL" S PSOAPT=1 K PSOPT,DUOUT G DEV
"RTN","PSOTPRP1",31,0)
 I $D(DUOUT)!($D(DTOUT)) G END
"RTN","PSOTPRP1",32,0)
 I '$D(PSOPT)&(Y<0) G END
"RTN","PSOTPRP1",33,0)
 ;
"RTN","PSOTPRP1",34,0)
DEV W ! K %ZIS,IOP,POP,ZTSK S %ZIS="QM" D ^%ZIS K %ZIS I POP G END
"RTN","PSOTPRP1",35,0)
 I $D(IO("Q")) D  G END
"RTN","PSOTPRP1",36,0)
 . N VAR K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK S ZTRTN="RPT^PSOTPRP1"
"RTN","PSOTPRP1",37,0)
 . S ZTDESC="Report of Patients with TPB and Non-TPB  Rx's"
"RTN","PSOTPRP1",38,0)
 . F VAR="PSOPT","PSOAPT","PSOINS","PSOAINS" S:$D(@VAR) ZTSAVE(VAR)=""
"RTN","PSOTPRP1",39,0)
 . S:$D(PSOPT) ZTSAVE("PSOPT(")="" S:$D(PSOINS) ZTSAVE("PSOINS(")=""
"RTN","PSOTPRP1",40,0)
 . D ^%ZTLOAD W:$D(ZTSK) !,"Report is Queued to print !!" K ZTSK
"RTN","PSOTPRP1",41,0)
 ;
"RTN","PSOTPRP1",42,0)
 G RPT
"RTN","PSOTPRP1",43,0)
 ;
"RTN","PSOTPRP1",44,0)
END K ^TMP("PSOTPB",$J)
"RTN","PSOTPRP1",45,0)
 Q
"RTN","PSOTPRP1",46,0)
 ;
"RTN","PSOTPRP1",47,0)
RPT ;- Print the Report
"RTN","PSOTPRP1",48,0)
 ;
"RTN","PSOTPRP1",49,0)
SORT ;- Sort the Data by Institution,Patient Name
"RTN","PSOTPRP1",50,0)
 S DFN=0 K ^TMP("PSOTPB",$J)
"RTN","PSOTPRP1",51,0)
 ;
"RTN","PSOTPRP1",52,0)
 ;- ALL Patients
"RTN","PSOTPRP1",53,0)
 I PSOAPT D  G PRINT
"RTN","PSOTPRP1",54,0)
 . F  S DFN=$O(^PS(52.91,DFN)) Q:'DFN  D STMP
"RTN","PSOTPRP1",55,0)
 ;
"RTN","PSOTPRP1",56,0)
 ;- Selected Patiens
"RTN","PSOTPRP1",57,0)
 F  S DFN=$O(PSOPT(DFN)) Q:'DFN  D STMP
"RTN","PSOTPRP1",58,0)
 ;
"RTN","PSOTPRP1",59,0)
PRINT ;- Read TMP global and Print Report
"RTN","PSOTPRP1",60,0)
 S PAG=0
"RTN","PSOTPRP1",61,0)
 I '$D(^TMP("PSOTPB",$J)) D  G END
"RTN","PSOTPRP1",62,0)
 . D HDR W !!?30,"*** NO DATA TO PRINT ***"
"RTN","PSOTPRP1",63,0)
 ;
"RTN","PSOTPRP1",64,0)
 S (INS,PAT,TYPE,RX)=""
"RTN","PSOTPRP1",65,0)
 F  S INS=$O(^TMP("PSOTPB",$J,INS)) Q:INS=""  D  I $D(DIRUT) Q
"RTN","PSOTPRP1",66,0)
 . D HDR I $D(DIRUT) Q
"RTN","PSOTPRP1",67,0)
 . S (PATCNT,VARXCNT,TPBRXCNT)=0
"RTN","PSOTPRP1",68,0)
 . F  S PAT=$O(^TMP("PSOTPB",$J,INS,PAT)) Q:PAT=""  D  I $D(DIRUT) Q
"RTN","PSOTPRP1",69,0)
 . . W !,PAT
"RTN","PSOTPRP1",70,0)
 . . F  S TYPE=$O(^TMP("PSOTPB",$J,INS,PAT,TYPE)) Q:TYPE=""  D  I $D(DIRUT) Q
"RTN","PSOTPRP1",71,0)
 . . . F  S RX=$O(^TMP("PSOTPB",$J,INS,PAT,TYPE,RX)) Q:RX=""  D  I $D(DIRUT) Q
"RTN","PSOTPRP1",72,0)
 . . . . I $Y>(IOSL-4) D HDR Q:$D(DIRUT)  W !,PAT
"RTN","PSOTPRP1",73,0)
 . . . . S RXEXT=$$GET1^DIQ(52,RX,.01),DRGIEN=$$GET1^DIQ(52,RX,6)
"RTN","PSOTPRP1",74,0)
 . . . . S OINAM=$$GET1^DIQ(50,DRGIEN,2.1) S:OINAM="" OINAM=$$GET1^DIQ(52,RX,6)
"RTN","PSOTPRP1",75,0)
 . . . . W ?$S(TYPE=0:30,1:42),RXEXT,?54,$E(OINAM,1,26),!
"RTN","PSOTPRP1",76,0)
 . . . . S:TYPE=0 VARXCNT=VARXCNT+1 S:TYPE=1 TPBRXCNT=TPBRXCNT+1
"RTN","PSOTPRP1",77,0)
 . . S PATCNT=PATCNT+1
"RTN","PSOTPRP1",78,0)
 . I '$D(DIRUT) D
"RTN","PSOTPRP1",79,0)
 . . W !,"TOTAL ",INS,": ",PATCNT," Patient(s) ",VARXCNT," VA Prescriptions"
"RTN","PSOTPRP1",80,0)
 . . W TPBRXCNT," TPB Prescriptions."
"RTN","PSOTPRP1",81,0)
 Q
"RTN","PSOTPRP1",82,0)
 ;
"RTN","PSOTPRP1",83,0)
STMP ;- Set Temporary Global (^TMP)
"RTN","PSOTPRP1",84,0)
 ;
"RTN","PSOTPRP1",85,0)
 ;- Check the Patient Instituion
"RTN","PSOTPRP1",86,0)
 S INS=$$GET1^DIQ(52.91,DFN,7,"I")
"RTN","PSOTPRP1",87,0)
 I 'PSOAINS,'$D(PSOINS(INS)) Q
"RTN","PSOTPRP1",88,0)
 S INSNAM="Institution Missing" I INS S INSNAM=$$GET1^DIQ(4,INS,.01)
"RTN","PSOTPRP1",89,0)
 ;
"RTN","PSOTPRP1",90,0)
 ;- Get Patient Information (Name,SSN)
"RTN","PSOTPRP1",91,0)
 D DEM^VADPT S PATNAM=$P(VADM(1),U) S:PATNAM="" PATNAM="Patient Missing"
"RTN","PSOTPRP1",92,0)
 S PATSSN=$P($P(VADM(2),U,2),"-",3)
"RTN","PSOTPRP1",93,0)
 S PATNAM=$E(PATNAM,1,22)_"("_PATSSN_")"
"RTN","PSOTPRP1",94,0)
 ;
"RTN","PSOTPRP1",95,0)
 ;Start Loop of PHARMACY PATIENT (#55)
"RTN","PSOTPRP1",96,0)
 S (SEQ,VARXCNT,TPBRXCNT)=0
"RTN","PSOTPRP1",97,0)
 F  S SEQ=$O(^PS(55,DFN,"P",SEQ)) Q:'SEQ  D
"RTN","PSOTPRP1",98,0)
 . ;Get Prescription Number
"RTN","PSOTPRP1",99,0)
 . S RXIEN=$G(^PS(55,DFN,"P",SEQ,0)) I $G(^PSRX(RXIEN,0))="" Q
"RTN","PSOTPRP1",100,0)
 . ;
"RTN","PSOTPRP1",101,0)
 . ;- Rx not Active
"RTN","PSOTPRP1",102,0)
 . I '$$ACTIVE^PSOTPCUL(RXIEN) Q
"RTN","PSOTPRP1",103,0)
 . ;
"RTN","PSOTPRP1",104,0)
 . ;- VA or TPB prescription
"RTN","PSOTPRP1",105,0)
 . S TYPE=$S($$GET1^DIQ(52,RXIEN,201,"I"):1,1:0)
"RTN","PSOTPRP1",106,0)
 . S:TYPE=0 VARXCNT=VARXCNT+1 S:TYPE=1 TPBRXCNT=TPBRXCNT+1
"RTN","PSOTPRP1",107,0)
 . ;
"RTN","PSOTPRP1",108,0)
 . S ^TMP("PSOTPB",$J,INSNAM,PATNAM,TYPE,RXIEN)=""
"RTN","PSOTPRP1",109,0)
 ;
"RTN","PSOTPRP1",110,0)
 ;- VA and TPB Active prescritpions must be found
"RTN","PSOTPRP1",111,0)
 I (VARXCNT'>0)!(TPBRXCNT'>0) K ^TMP("PSOTPB",$J,INSNAM,PATNAM)
"RTN","PSOTPRP1",112,0)
 Q
"RTN","PSOTPRP1",113,0)
 ;
"RTN","PSOTPRP1",114,0)
HDR ; - Prints the Header
"RTN","PSOTPRP1",115,0)
 N X,DIR S PAG=$G(PAG)+1
"RTN","PSOTPRP1",116,0)
 I PAG>1,$E(IOST)="C" D  Q:$D(DIRUT)
"RTN","PSOTPRP1",117,0)
 . F  Q:$Y>(IOSL-2)  W !
"RTN","PSOTPRP1",118,0)
 . S DIR(0)="E",DIR("A")=" Press ENTER to Continue or ^ to Exit" D ^DIR
"RTN","PSOTPRP1",119,0)
 ;
"RTN","PSOTPRP1",120,0)
 W @IOF,!,"REPORT OF PATIENTS WITH TPB AND NON-TBP RX's ON FILE",?70,"Page: ",$J(PAG,3)
"RTN","PSOTPRP1",121,0)
 W !,?48,"Run Date: "_$$FMTE^XLFDT($$NOW^XLFDT())
"RTN","PSOTPRP1",122,0)
 W:$G(INST)'="" !,"INSTITUTION: ",INS
"RTN","PSOTPRP1",123,0)
 S X="",$P(X,"-",80)="" W !,X
"RTN","PSOTPRP1",124,0)
 W !,"PATIENT (LAST4SSN)",?30,"VA RX#",?42,"TPB RX#",?54,"DRUG"
"RTN","PSOTPRP1",125,0)
 W !,X
"RTN","PSOTPRP1",126,0)
 Q
"RTN","PSOTPRX1")
0^10^B51610518
"RTN","PSOTPRX1",1,0)
PSOTPRX1 ;BIR/MHA-TPB medication procesing driver ;08/21/03
"RTN","PSOTPRX1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**146,182,227**;DEC 1997
"RTN","PSOTPRX1",3,0)
 ;External reference PDA^PPPPDA1 supported by DBIA 1374
"RTN","PSOTPRX1",4,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOTPRX1",5,0)
 ;External reference ^DIC(31 supported by DBIA 658
"RTN","PSOTPRX1",6,0)
 ;External reference EN2^GMRAPEM0 supported by DBIA 190
"RTN","PSOTPRX1",7,0)
 Q  ;placed out of order by patch PSO*7*227
"RTN","PSOTPRX1",8,0)
START K PSOQFLG,PSOID,PSOFIN,PSOQUIT,PSODRUG S (PSOBCK,PSOERR)=1 D INIT
"RTN","PSOTPRX1",9,0)
 W:'$D(PSOTPBFG) !!,"*** Transitional Pharmacy Benefit Flag Undefined - Quitting ***"
"RTN","PSOTPRX1",10,0)
 G:PSORX("QFLG")!('$D(PSOTPBFG)) END
"RTN","PSOTPRX1",11,0)
 D PT G:$G(PSORX("QFLG")) END D FULL^VALM1 I $G(NOPROC) K NOPROC G NX
"RTN","PSOTPRX1",12,0)
 ;call to add bingo board data to file 52.11
"RTN","PSOTPRX1",13,0)
 F SLPPL=0:0 S SLPPL=$O(RXRS(SLPPL)) Q:'SLPPL  D
"RTN","PSOTPRX1",14,0)
 .I $P($G(^PSRX(SLPPL,"STA")),"^")'=5 K RXRS(SLPPL) Q
"RTN","PSOTPRX1",15,0)
 .S RXREC=SLPPL D WIND^PSOSUPOE I $G(PBINGRTE) D BBADD^PSOSUPOE S (BINGCRT,BINGRTE)=1 S:$G(PSOFROM)'="NEW" PSOFROM="REFILL"
"RTN","PSOTPRX1",16,0)
 K TM,TM1 I $G(PSORX("PSOL",1))]""!($D(RXRS)) D ^PSORXL K PSORX S PSOPBM1=1
"RTN","PSOTPRX1",17,0)
 G:$G(NOBG) NX
"RTN","PSOTPRX1",18,0)
 S TM=$P(^TMP("PSOBB",$J),"^"),TM1=$P(^TMP("PSOBB",$J),"^",2) K ^TMP("PSOBB",$J)
"RTN","PSOTPRX1",19,0)
 I $G(PSOFROM)="NEW"!($G(PSOFROM)="REFILL")!($G(PSOFROM)="PARTIAL") D:$D(BINGCRT)&($D(BINGRTE)&($D(DISGROUP))) ^PSOBING1 K BINGCRT,BINGRTE,BBRX,BBFLG
"RTN","PSOTPRX1",20,0)
 I $G(PSOPBM),$G(PSOPBM1) S $P(^PS(55,PSODFN,0),"^",7)=PSOPBM,$P(^(0),"^",8)="A" K PSOPBM,PSOPBM1
"RTN","PSOTPRX1",21,0)
NX D:$G(PSODFN) EXFLAG^PSOTPCAN(PSODFN) D EOJ G START
"RTN","PSOTPRX1",22,0)
END Q
"RTN","PSOTPRX1",23,0)
 ;---------------------------------------------------------
"RTN","PSOTPRX1",24,0)
INIT ;
"RTN","PSOTPRX1",25,0)
 S PSORX("QFLG")=0
"RTN","PSOTPRX1",26,0)
 D:'$D(PSOPAR) ^PSOLSET I '$D(PSOPAR) S PSORX("QFLG")=1
"RTN","PSOTPRX1",27,0)
 I $P($G(PSOPAR),"^",2),'$D(^XUSEC("PSORPH",DUZ)) S PSORX("VERIFY")=1
"RTN","PSOTPRX1",28,0)
INITX Q
"RTN","PSOTPRX1",29,0)
 ;
"RTN","PSOTPRX1",30,0)
PT ;
"RTN","PSOTPRX1",31,0)
 K ^TMP("PSORXDC",$J),CLOZPAT,DIC,PSODFN,PSOPBM,PSOPBM1 S PSORX("QFLG")=0
"RTN","PSOTPRX1",32,0)
 S DIC("S")="I '$P(^PS(52.91,+Y,0),""^"",3)!($P(^(0),""^"",3)>DT)"
"RTN","PSOTPRX1",33,0)
 S DIC=52.91,DIC(0)="QEAM" D ^DIC K DIC,DA
"RTN","PSOTPRX1",34,0)
 I +Y'>0 S PSORX("QFLG")=1 G PTX
"RTN","PSOTPRX1",35,0)
OERR N:$G(MEDP) PAT,POERR K PSOXFLG S (DFN,PSODFN)=+Y,PSORX("NAME")=$P($G(^DPT(PSODFN,0)),"^")
"RTN","PSOTPRX1",36,0)
 K NPPROC,PSOQFLG,DIC,DR,DIQ S DIC=2,DA=PSODFN,DR=.351,DIQ="PSOPTPST" D EN^DIQ1 K DIC,DA,DR,DIQ D DEAD^PSOPTPST I $G(PSOQFLG) S NOPROC=1 Q
"RTN","PSOTPRX1",37,0)
 I $P($G(^PS(55,PSODFN,"LAN")),"^") W !,"Patient has another language preference!",! H 3
"RTN","PSOTPRX1",38,0)
 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2) S ^TMP("PSOBB",$J)=TM_"^"_TM1
"RTN","PSOTPRX1",39,0)
 I '$G(MEDP) S X="PPPPDA1" X ^%ZOSF("TEST") S:$T X=$$PDA^PPPPDA1(PSODFN)
"RTN","PSOTPRX1",40,0)
 S PSOQFLG=0,DIC="^PS(55,",DLAYGO=55
"RTN","PSOTPRX1",41,0)
 I $G(PSOFIN) S SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")" K SSN
"RTN","PSOTPRX1",42,0)
 K PSOPBM ; KILL SO THAT WON'T CARRY OVER PRIOR PATIENT'S VALUE
"RTN","PSOTPRX1",43,0)
 I '$D(^PS(55,PSODFN,0)) D
"RTN","PSOTPRX1",44,0)
 .S PSOPBM=$P(TM,".")
"RTN","PSOTPRX1",45,0)
 .K DD,DO S DIC(0)="L",(DINUM,X)=PSODFN D FILE^DICN D:Y<1  K DIC,DA,DR,DD,DO
"RTN","PSOTPRX1",46,0)
 ..S $P(^PS(55,PSODFN,0),"^")=PSODFN K DIK S DA=PSODFN,DIK="^PS(55,",DIK(1)=.01 D EN^DIK K DIK
"RTN","PSOTPRX1",47,0)
 S PSOLOUD=1 D:$P($G(^PS(55,PSODFN,0)),"^",6)'=2 EN^PSOHLUP(PSODFN) K PSOLOUD
"RTN","PSOTPRX1",48,0)
 I $G(^PS(55,PSODFN,"PS"))']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSOTPRX1",49,0)
 .L +^PS(55,PSODFN):0 I '$T W $C(7),!!,"Patient Data is Being Edited by Another User!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1 Q
"RTN","PSOTPRX1",50,0)
 .S PSOXFLG=1,SSN=$P(^DPT(PSODFN,0),"^",9) W !!?10,$C(7),PSORX("NAME")_" ("_$E(SSN,1,3)_"-"_$E(SSN,4,5)_"-"_$E(SSN,6,9)_")",! K SSN
"RTN","PSOTPRX1",51,0)
 .S DIE=55,DR=".02;.03;.04;.05;1;D ELIG^PSORX1;@1;3//NON-VA;D CHK^PSOTPRX1;50;106;106.1"
"RTN","PSOTPRX1",52,0)
 .S DA=PSODFN W !!,?5,">>PHARMACY PATIENT DATA<<",! D ^DIE L -^PS(55,PSODFN)
"RTN","PSOTPRX1",53,0)
 .I $D(Y)!($D(DTOUT)) S PSOX=$G(^PS(55,PSODFN,"PS")) D:+$P(PSOX,"^")
"RTN","PSOTPRX1",54,0)
 ..I $$UP^XLFSTR($P(^PS(53,$P(PSOX,"^"),0),"^"))'="NON-VA" S DR="3////@" D ^DIE
"RTN","PSOTPRX1",55,0)
 S PSOX=$G(^PS(55,PSODFN,"PS"))
"RTN","PSOTPRX1",56,0)
 I PSOX]"" S (X,PSORX("PATIENT STATUS"))=$$UP^XLFSTR($P(^PS(53,$P(PSOX,"^"),0),"^")) D:X'="NON-VA" WRN
"RTN","PSOTPRX1",57,0)
 I PSOX']"" D  I $G(POERR("QFLG")) G EOJ
"RTN","PSOTPRX1",58,0)
 .W !!,"Patient Status Required!!",! D ELIG
"RTN","PSOTPRX1",59,0)
 .W ! K POERR("QFLG"),DIC,DR,DIE S DIC("B")="NON-VA"
"RTN","PSOTPRX1",60,0)
 .S DIC("A")="PATIENT STATUS: ",DIC(0)="QEAMZ",DIC=53 D ^DIC K DIC
"RTN","PSOTPRX1",61,0)
 .I $D(DIRUT)!(Y=-1) D  Q
"RTN","PSOTPRX1",62,0)
 ..W $C(7),"Required Data!",! S POERR("QFLG")=1 S:$G(PSOFIN) PSOQUIT=1
"RTN","PSOTPRX1",63,0)
 ..I $G(PSOPBM) D  K PSOPBM
"RTN","PSOTPRX1",64,0)
 ...I $O(^PS(55,PSODFN,0))="" S DA=PSODFN,DIK="^PS(55," D ^DIK
"RTN","PSOTPRX1",65,0)
 .I $$UP^XLFSTR($P(^PS(53,+Y,0),"^"))'="NON-VA" D MES S POERR("QFLG")=1 Q
"RTN","PSOTPRX1",66,0)
 .S ^PS(55,PSODFN,"PS")=+Y,PSORX("PATIENT STATUS")=$P(^PS(53,+Y,0),"^")
"RTN","PSOTPRX1",67,0)
 .D KV
"RTN","PSOTPRX1",68,0)
 Q:$G(PSOFIN)
"RTN","PSOTPRX1",69,0)
PROV ;
"RTN","PSOTPRX1",70,0)
 D ST^PSOTPPRV G:'$G(DA) NX
"RTN","PSOTPRX1",71,0)
 S PSORX("PROVIDER NAME")=$P(^VA(200,DA,0),"^")
"RTN","PSOTPRX1",72,0)
 D KV S DIR("A")="Do you want to enter allergies or adverse reactions at this time?"
"RTN","PSOTPRX1",73,0)
 S DIR("B")="Y",DIR(0)="YN" W !! D ^DIR I Y W !
"RTN","PSOTPRX1",74,0)
 D:Y EN2^GMRAPEM0
"RTN","PSOTPRX1",75,0)
 I '$G(PSOPBM),'$P(^PS(55,PSODFN,0),"^",7),$P(^(0),"^",8)']"" S PSOPBM=$P(TM,".")
"RTN","PSOTPRX1",76,0)
 D ^PSOBUILD
"RTN","PSOTPRX1",77,0)
 F PT="GET","DEAD","INP","CNH","ADDRESS","COPAY" S RTN=PT_"^PSOPTPST" D @RTN Q:$G(POERR("DEAD"))!($G(PSOQFLG))
"RTN","PSOTPRX1",78,0)
 I $G(POERR("DEAD")) S POERR("QFLG")=1 F II=0:0 S II=$O(^PS(52.41,"P",PSODFN,II)) D:$P($G(^PS(52.41,II,0)),"^",3)'="DC"&($P($G(^(0)),"^",3)'="DE") DC^PSOORFI2
"RTN","PSOTPRX1",79,0)
 K PSOERR("DEAD"),II I $G(PSOQFLG) S POERR("QFLG")=1 G EOJ Q
"RTN","PSOTPRX1",80,0)
 S (PAT,PSOXXDFN)=PSODFN,POERR=1 D ^PSOORUT2,BLD^PSOORUT1,EN^PSOLMUTL
"RTN","PSOTPRX1",81,0)
 D CLEAR^VALM1 G:$G(PSOQUIT) PTX D EN^PSOLMAO
"RTN","PSOTPRX1",82,0)
 S (DFN,PSODFN)=PSOXXDFN K DIE,DIC,DLAYGO,DR,DA,PSOX,PSORXED
"RTN","PSOTPRX1",83,0)
PTX ;
"RTN","PSOTPRX1",84,0)
 K X,Y,^TMP("PS",$J),C,DEA,PRC,PSCNT,PSOACT,PSOCLC,PSOCS,PSOCT,PSOFINFL,PSOHD,PSOLST,PSOOPT,PSOPF,PSOX,PSOX1,PSOXXDFN,SIGOK,STP,STR
"RTN","PSOTPRX1",85,0)
 Q
"RTN","PSOTPRX1",86,0)
CHK ;
"RTN","PSOTPRX1",87,0)
 Q:'X
"RTN","PSOTPRX1",88,0)
 I $$UP^XLFSTR($P(^PS(53,+X,0),"^"))'="NON-VA" D MES S Y="@1",$P(^PS(55,PSODFN,"PS"),"^")=""
"RTN","PSOTPRX1",89,0)
 Q
"RTN","PSOTPRX1",90,0)
MES W $C(7),!!,"Invalid Selection - Only 'NON-VA' patient status can be processed through"
"RTN","PSOTPRX1",91,0)
 W !,"this option. For all other statuses use the regular Patient Prescription"
"RTN","PSOTPRX1",92,0)
 W !,"Processing option"
"RTN","PSOTPRX1",93,0)
 Q
"RTN","PSOTPRX1",94,0)
WRN W $C(7),!!?15,"*** Current RX Patient Status is "_X_" ***"
"RTN","PSOTPRX1",95,0)
 W !,"Only 'NON-VA' patient status should be processed through this option."
"RTN","PSOTPRX1",96,0)
 W !,"For all other statuses use the regular Patient Prescription Processing option."
"RTN","PSOTPRX1",97,0)
 Q
"RTN","PSOTPRX1",98,0)
EOJ ;
"RTN","PSOTPRX1",99,0)
 K PSOERR,PSOMED,PSORX,PSOSD,PSODRUG,PSODFN,PSOOPT,PSOBILL,PSOIBQS,PSOCPAY,PSOPF,PSOPI,COMM,DGI,DGS,PT,PTDY,PTRF,RN,RTN,SERS,ST0,STAT,DFN,STOP,SLPPL,RXREC,PSOPBM
"RTN","PSOTPRX1",100,0)
 K:'$G(MEDP) PSOQFLG
"RTN","PSOTPRX1",101,0)
 D KVA^VADPT,FULL^VALM1 K PSOLST,PSOXFLG,PSCNT,PSDIS,PSOAL,P1,LOG,%,%DT,%I,D0,DAT,DFN,DRG,ORX,PSON,PSOPTPST,PTST,PSOBCK,PSOID,PSOBXPUL
"RTN","PSOTPRX1",102,0)
 K INCOM,SIG,SG,STP,RX0,RXN,RX2,RX3,RTS,C,DEAD,PS,PSOCLC,PSOCNT,PSOCT,PSODA,PSOFROM,PSOHD,R3,REA,RF,RFD,RFM,RLD,RXNUM,RXP,RXPR,RXRP,RXRS,STR,POERR,VALMSG
"RTN","PSOTPRX1",103,0)
 K ^TMP("PSORXDC",$J),^TMP("PSOAL",$J),^TMP("PSOAO",$J),^TMP("PSOSF",$J),^TMP("PSOPF",$J),^TMP("PSOPI",$J),^TMP("PSOPO",$J),^TMP("PSOHDR",$J) I '$G(MEDP),'$G(PSOQUIT) K PAT
"RTN","PSOTPRX1",104,0)
 K RFN,PSOXXDFN,VALM,VALMKEY,PSOBCK,SPOERR,PSOFLAG,VALMBCK,D,GMRA,GMRAL,GMRAREC,PSOSTA,PSODT,RXFL,NOBG,BBRX,BBFLG
"RTN","PSOTPRX1",105,0)
KV K DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSOTPRX1",106,0)
 Q
"RTN","PSOTPRX1",107,0)
ELIG ; shows eligibility and disabilities
"RTN","PSOTPRX1",108,0)
 D ELIG^VADPT W !,"Eligibility: "_$P(VAEL(1),"^",2)_$S(+VAEL(3):"     SC%: "_$P(VAEL(3),"^",2),1:"") S N=0 F  S N=$O(VAEL(1,N)) Q:'N  W !,?10,$P(VAEL(1,N),"^",2)
"RTN","PSOTPRX1",109,0)
 W !,"Disabilities: " F I=0:0 S I=$O(^DPT(DFN,.372,I)) Q:'I  S I1=$S($D(^DPT(DFN,.372,I,0)):^(0),1:"") D:+I1
"RTN","PSOTPRX1",110,0)
 .S PSDIS=$S($P($G(^DIC(31,+I1,0)),"^")]""&($P($G(^(0)),"^",4)']""):$P(^(0),"^"),$P($G(^DIC(31,+I1,0)),"^",4)]"":$P(^(0),"^",4),1:""),PSCNT=$P(I1,"^",2)
"RTN","PSOTPRX1",111,0)
 .W:$L(PSDIS_"-"_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), ")>80 !,?15
"RTN","PSOTPRX1",112,0)
 .W $S($G(PSDIS)]"":PSDIS_"-",1:"")_PSCNT_"% ("_$S($P(I1,"^",3):"SC",1:"NSC")_"), "
"RTN","PSOTPRX1",113,0)
 K N
"RTN","PSOTPRX1",114,0)
 Q
"RTN","PSOTPRX1",115,0)
PROFILE ;
"RTN","PSOTPRX1",116,0)
 S (PSORX("REFILL"),PSORX("RENEW"))=0,PSOX="" D ^PSOBUILD
"RTN","PSOTPRX1",117,0)
 I '$G(PSOSD) W !,"This patient has no prescriptions" S:'$D(DFN) DFN=PSODFN D GMRA^PSODEM G PROFILEX
"RTN","PSOTPRX1",118,0)
 S (PSODRG,PSOX)="" F  S PSODRG=$O(PSOSD(PSODRG)) Q:PSODRG=""  F  S PSOX=$O(PSOSD(PSODRG,PSOX)) Q:PSOX=""  S:$P(PSOSD(PSODRG,PSOX),"^",3)="" PSORX("RENEW")=1 S:$P(PSOSD(PSODRG,PSOX),"^",4)="" PSORX("REFILL")=1
"RTN","PSOTPRX1",119,0)
 K PSOX
"RTN","PSOTPRX1",120,0)
PROFILEX ;
"RTN","PSOTPRX1",121,0)
 Q
"VER")
8.0^22.0
"^DD",52.91,52.91,3,0)
INACTIVATION REASON CODE^*S^1:SEEN BY VA PROVIDER;2:NO/SHOW/CANCELLATION;3:PATIENT ENDED;4:NON-FORMULARY RX NOT ACCEPTED;5:PATIENT EXPIRED;6:ALL RX'S INACTIVE;7:EXCLUSION;8:PATIENT REFUSED APPT;9:PATIENT UNREACHABLE;10:PROGRAM ENDED;^0;4^Q
"^DD",52.91,52.91,3,12)
Only these codes are allowed for manual entry.
"^DD",52.91,52.91,3,12.1)
S DIC("S")="I Y'=7"
"^DD",52.91,52.91,3,21,0)
^.001^4^4^3051116^^^
"^DD",52.91,52.91,3,21,1,0)
This field contains a code representing the reason for inactivating a
"^DD",52.91,52.91,3,21,2,0)
patient for this benefit. EXCLUSION code 7, is hidden and not user 
"^DD",52.91,52.91,3,21,3,0)
selectable. It is used by the post-install routine during initial
"^DD",52.91,52.91,3,21,4,0)
extraction.
"^DD",52.91,52.91,3,"DT")
3051116
"BLD",5529,6)
^202
**END**
**END**
