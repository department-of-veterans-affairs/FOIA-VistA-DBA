Released PSO*7*249 SEQ #235
Extracted from mail message
**KIDS**:PSO*7.0*249^

**INSTALL NAME**
PSO*7.0*249
"BLD",6330,0)
PSO*7.0*249^OUTPATIENT PHARMACY^0^3070618^y
"BLD",6330,1,0)
^^3^3^3070320^
"BLD",6330,1,1,0)
Cancel date
"BLD",6330,1,2,0)
Scriptalk issue
"BLD",6330,1,3,0)
Fileman API
"BLD",6330,4,0)
^9.64PA^52^1
"BLD",6330,4,52,0)
52
"BLD",6330,4,52,2,0)
^9.641^52^1
"BLD",6330,4,52,2,52,0)
PRESCRIPTION  (File-top level)
"BLD",6330,4,52,2,52,1,0)
^9.6411^127^1
"BLD",6330,4,52,2,52,1,127,0)
LAST DISPENSED DATE HOLDER
"BLD",6330,4,52,222)
y^y^p^^^^n^^n
"BLD",6330,4,52,224)

"BLD",6330,4,"APDD",52,52)

"BLD",6330,4,"APDD",52,52,127)

"BLD",6330,4,"B",52,52)

"BLD",6330,6)
13^
"BLD",6330,6.3)
9
"BLD",6330,"KRN",0)
^9.67PA^8989.52^19
"BLD",6330,"KRN",.4,0)
.4
"BLD",6330,"KRN",.401,0)
.401
"BLD",6330,"KRN",.402,0)
.402
"BLD",6330,"KRN",.403,0)
.403
"BLD",6330,"KRN",.5,0)
.5
"BLD",6330,"KRN",.84,0)
.84
"BLD",6330,"KRN",3.6,0)
3.6
"BLD",6330,"KRN",3.8,0)
3.8
"BLD",6330,"KRN",9.2,0)
9.2
"BLD",6330,"KRN",9.8,0)
9.8
"BLD",6330,"KRN",9.8,"NM",0)
^9.68A^14^11
"BLD",6330,"KRN",9.8,"NM",1,0)
PSOCAN3^^0^B73551199
"BLD",6330,"KRN",9.8,"NM",2,0)
PSOORUTL^^0^B42538902
"BLD",6330,"KRN",9.8,"NM",3,0)
PSOHLNEW^^0^B77643201
"BLD",6330,"KRN",9.8,"NM",4,0)
PSOORED1^^0^B67707631
"BLD",6330,"KRN",9.8,"NM",5,0)
PSOAUTOC^^0^B66090393
"BLD",6330,"KRN",9.8,"NM",6,0)
PSOFUNC^^0^B6545033
"BLD",6330,"KRN",9.8,"NM",7,0)
PSOHLDC^^0^B34921764
"BLD",6330,"KRN",9.8,"NM",8,0)
PSOPKIV1^^0^B24905517
"BLD",6330,"KRN",9.8,"NM",9,0)
PSOVERC^^0^B8973587
"BLD",6330,"KRN",9.8,"NM",11,0)
PSOTALK^^0^B84408343
"BLD",6330,"KRN",9.8,"NM",14,0)
PSOORED3^^0^B56356282
"BLD",6330,"KRN",9.8,"NM","B","PSOAUTOC",5)

"BLD",6330,"KRN",9.8,"NM","B","PSOCAN3",1)

"BLD",6330,"KRN",9.8,"NM","B","PSOFUNC",6)

"BLD",6330,"KRN",9.8,"NM","B","PSOHLDC",7)

"BLD",6330,"KRN",9.8,"NM","B","PSOHLNEW",3)

"BLD",6330,"KRN",9.8,"NM","B","PSOORED1",4)

"BLD",6330,"KRN",9.8,"NM","B","PSOORED3",14)

"BLD",6330,"KRN",9.8,"NM","B","PSOORUTL",2)

"BLD",6330,"KRN",9.8,"NM","B","PSOPKIV1",8)

"BLD",6330,"KRN",9.8,"NM","B","PSOTALK",11)

"BLD",6330,"KRN",9.8,"NM","B","PSOVERC",9)

"BLD",6330,"KRN",19,0)
19
"BLD",6330,"KRN",19.1,0)
19.1
"BLD",6330,"KRN",101,0)
101
"BLD",6330,"KRN",409.61,0)
409.61
"BLD",6330,"KRN",771,0)
771
"BLD",6330,"KRN",870,0)
870
"BLD",6330,"KRN",8989.51,0)
8989.51
"BLD",6330,"KRN",8989.52,0)
8989.52
"BLD",6330,"KRN",8994,0)
8994
"BLD",6330,"KRN","B",.4,.4)

"BLD",6330,"KRN","B",.401,.401)

"BLD",6330,"KRN","B",.402,.402)

"BLD",6330,"KRN","B",.403,.403)

"BLD",6330,"KRN","B",.5,.5)

"BLD",6330,"KRN","B",.84,.84)

"BLD",6330,"KRN","B",3.6,3.6)

"BLD",6330,"KRN","B",3.8,3.8)

"BLD",6330,"KRN","B",9.2,9.2)

"BLD",6330,"KRN","B",9.8,9.8)

"BLD",6330,"KRN","B",19,19)

"BLD",6330,"KRN","B",19.1,19.1)

"BLD",6330,"KRN","B",101,101)

"BLD",6330,"KRN","B",409.61,409.61)

"BLD",6330,"KRN","B",771,771)

"BLD",6330,"KRN","B",870,870)

"BLD",6330,"KRN","B",8989.51,8989.51)

"BLD",6330,"KRN","B",8989.52,8989.52)

"BLD",6330,"KRN","B",8994,8994)

"BLD",6330,"QUES",0)
^9.62^^
"BLD",6330,"REQB",0)
^9.611^7^4
"BLD",6330,"REQB",3,0)
PSO*7.0*244^2
"BLD",6330,"REQB",5,0)
PSO*7.0*239^2
"BLD",6330,"REQB",6,0)
PSO*7.0*200^2
"BLD",6330,"REQB",7,0)
PSO*7.0*243^2
"BLD",6330,"REQB","B","PSO*7.0*200",6)

"BLD",6330,"REQB","B","PSO*7.0*239",5)

"BLD",6330,"REQB","B","PSO*7.0*243",7)

"BLD",6330,"REQB","B","PSO*7.0*244",3)

"FIA",52)
PRESCRIPTION
"FIA",52,0)
^PSRX(
"FIA",52,0,0)
52Is
"FIA",52,0,1)
y^y^p^^^^n^^n
"FIA",52,0,10)

"FIA",52,0,11)

"FIA",52,0,"RLRO")

"FIA",52,0,"VR")
7.0^PSO
"FIA",52,52)
1
"FIA",52,52,127)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
249^3070618^10000000073
"PKG",141,22,1,"PAH",1,1,0)
^^3^3^3070618
"PKG",141,22,1,"PAH",1,1,1,0)
Cancel date
"PKG",141,22,1,"PAH",1,1,2,0)
Scriptalk issue
"PKG",141,22,1,"PAH",1,1,3,0)
Fileman API
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
11
"RTN","PSOAUTOC")
0^5^B66090393^B66351677
"RTN","PSOAUTOC",1,0)
PSOAUTOC ;BIR/SAB - autocancel rxs on admission ;08/15/94
"RTN","PSOAUTOC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**3,24,30,36,88,146,132,223,148,249**;DEC 1997;Build 9
"RTN","PSOAUTOC",3,0)
 ;External reference to File #59.7 supported by DBIA 694
"RTN","PSOAUTOC",4,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOAUTOC",5,0)
 ;External reference ^DPT(PSODFN,.1) supported by DBIA 10035
"RTN","PSOAUTOC",6,0)
 ;External reference ^DGPM("AMV1" supported by DBIA 2249
"RTN","PSOAUTOC",7,0)
 ;External reference ^DGPM("APTT1" supported by DBIA 2249
"RTN","PSOAUTOC",8,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOAUTOC",9,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOAUTOC",10,0)
AUTO I '$P(^PS(59.7,1,40.1),"^") W $C(7),!,"Autocancel System Parameter must be set to 'YES'",!,"before prescriptions are discontinued."
"RTN","PSOAUTOC",11,0)
 K %DT,DIC S DIC(0)="XZM",(DIE,DIC)="^DIC(19.2,",X="PSO AUTOCANCEL" D ^DIC
"RTN","PSOAUTOC",12,0)
 I +Y>0 D EDIT^XUTMOPT("PSO AUTOCANCEL") G EX
"RTN","PSOAUTOC",13,0)
 D RESCH^XUTMOPT("PSO AUTOCANCEL","","","24H","L"),EDIT^XUTMOPT("PSO AUTOCANCEL")
"RTN","PSOAUTOC",14,0)
EX K Y,C,D,D0,DI,DQ,DA,DIE,DR,DIC,X
"RTN","PSOAUTOC",15,0)
 Q
"RTN","PSOAUTOC",16,0)
TASK ;TaskMan entry point
"RTN","PSOAUTOC",17,0)
 G:'$P(^PS(59.7,1,40.1),"^") KILL S X="T-3" D ^%DT S PSOD2=Y,PSOD0=Y-.01,PSODL=Y+.3
"RTN","PSOAUTOC",18,0)
 S PSOD=PSOD0 F  S PSOD=$O(^DGPM("AMV1",PSOD)),PSODFN=0 Q:'PSOD!(PSOD>PSODL)  F PSODFN=0:0 S PSODFN=$O(^DGPM("AMV1",PSOD,PSODFN)) Q:'PSODFN  I $G(^DPT(PSODFN,.1))]"",$O(^PS(55,PSODFN,"P",0)),'$O(^DGPM("APTT1",PSODFN,PSOD)) D CAN
"RTN","PSOAUTOC",19,0)
 G KILL
"RTN","PSOAUTOC",20,0)
CAN ;discontinue Rxs
"RTN","PSOAUTOC",21,0)
 S DFN=PSODFN K VAIN D INP^VADPT I $P($G(VAIN(4)),"^"),$D(^PS(59.7,1,40.19,"B",$P($G(VAIN(4)),"^"))) Q
"RTN","PSOAUTOC",22,0)
 I $D(^PS(55,PSODFN,0)),$P($G(^PS(55,PSODFN,0)),U,6)'=2 D EN^PSOHLUP(PSODFN)
"RTN","PSOAUTOC",23,0)
 F PSORXJ=0:0 S PSORXJ=$O(^PS(55,PSODFN,"P",PSORXJ)) Q:'PSORXJ  I $D(^(PSORXJ,0)) S PSORX=^(0) D
"RTN","PSOAUTOC",24,0)
 .I $D(^PSRX(PSORX,0)) S PSO0=^(0),PSO2=$G(^(2)),STA=+^("STA") I STA<11,PSO2,$P(PSO2,"^",6)'<DT,$E(PSO2,1,7)'>PSOD2!(STA=16) D
"RTN","PSOAUTOC",25,0)
 ..S $P(^PSRX(PSORX,3),"^",5)=DT,$P(^("STA"),"^")=12
"RTN","PSOAUTOC",26,0)
 ..D REVERSE^PSOBPSU1(PSORX,,"DC",7)
"RTN","PSOAUTOC",27,0)
 ..D CAN^PSOTPCAN(PSORX)
"RTN","PSOAUTOC",28,0)
 ..D FIL^PSOCAN3
"RTN","PSOAUTOC",29,0)
 ..;remove from hold
"RTN","PSOAUTOC",30,0)
 ..I $G(^PSRX(PSORX,"H"))]"" D
"RTN","PSOAUTOC",31,0)
 ...K:$P(^PSRX(PSORX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSORX,"H"),"^"),PSORX) S ^PSRX(PSORX,"H")=""
"RTN","PSOAUTOC",32,0)
 ...I '$P($G(^PSRX(PSORX,2)),"^",2),$P($G(^(3)),"^") S $P(^PSRX(PSORX,2),"^",2)=$P(^(3),"^")
"RTN","PSOAUTOC",33,0)
 ..;Add activity record
"RTN","PSOAUTOC",34,0)
 ..S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(PSORX,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOAUTOC",35,0)
 ..S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(PSORX,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOAUTOC",36,0)
 ..D NOW^%DTC S ACNT=ACNT+1,^PSRX(PSORX,"A",0)="^52.3DA^"_ACNT_"^"_ACNT S ^PSRX(PSORX,"A",ACNT,0)=%_"^"_"C"_"^^"_RFCNT_"^"_"Auto Discontinued on Admission"
"RTN","PSOAUTOC",37,0)
 ..;delete from suspense
"RTN","PSOAUTOC",38,0)
 ..D:$O(^PS(52.5,"B",PSORX,0))
"RTN","PSOAUTOC",39,0)
 ...I $O(^PSRX(PSORX,1,0)) S DA=PSORX,SUSD=$P($G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),0)),"^",2) D:'$G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),"P")) REF^PSOCAN2
"RTN","PSOAUTOC",40,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)),DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOAUTOC",41,0)
 ..;remove from non-verified file
"RTN","PSOAUTOC",42,0)
 ..I $G(^PS(52.4,PSORX,0))]"" S DIK="^PS(52.4,",DA=PSORX D ^DIK K DIK
"RTN","PSOAUTOC",43,0)
 ..S STAT="OD",PHARMST="",COM="Auto Discontinued on Admission" D EN^PSOHLSN1(PSORX,STAT,PHARMST,COM,"A")
"RTN","PSOAUTOC",44,0)
 ;auto-dc pending orders
"RTN","PSOAUTOC",45,0)
 ;F PSOIORD=0:0 S PSOIORD=$O(^PS(52.41,"AOR",PSODFN,PSOIORD)) Q:'PSOIORD  F PSORD=0:0 S PSORD=$O(^PS(52.41,"AOR",PSODFN,PSOIORD,PSORD)) Q:'PSORD  D
"RTN","PSOAUTOC",46,0)
 ;.I $P(^PS(52.41,PSORD,0),"^",3)="RF" S DA=PSORD,DIK="^PS(52.41," D ^DIK K DA,DIK Q
"RTN","PSOAUTOC",47,0)
 ;.K ^PS(52.41,"AOR",PSODFN,PSOIORD,PSORD) S $P(^PS(52.41,PSORD,0),"^",3)="DC"
"RTN","PSOAUTOC",48,0)
 ;.D EN^PSOHLSN(+^PS(52.41,PSORD,0),"OC","Auto Canceled on Admission","A")
"RTN","PSOAUTOC",49,0)
 K PSORD,PSOIORD
"RTN","PSOAUTOC",50,0)
 Q
"RTN","PSOAUTOC",51,0)
KILL K %,%H,%T,ACNT,DA,DFN,DIRUT,DTOUT,PSO,PSO0,PSO2,PSOD,PSOD0,PSOD2,PSODFN,PSODL,PSORX,PSORXJ,PSOSD,RF,RFCNT,SUB,TM,TSKDT,VAIN,X,X1,X2,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","PSOAUTOC",52,0)
 K ORD,PHARMST,STAT,COM S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOAUTOC",53,0)
 Q
"RTN","PSOAUTOC",54,0)
SETUP ;initialize nightly Rx cost compile job
"RTN","PSOAUTOC",55,0)
 K %DT,DIC,DTOUT S DIC(0)="XZM",DIC="^DIC(19.2,",X="PSO COSTDAY NIGHTJOB" D ^DIC
"RTN","PSOAUTOC",56,0)
 I +Y>0 D EDIT^XUTMOPT("PSO COSTDAY NIGHTJOB") G OUT
"RTN","PSOAUTOC",57,0)
 D RESCH^XUTMOPT("PSO COSTDAY NIGHTJOB","","","24H","L"),EDIT^XUTMOPT("PSO COSTDAY NIGHTJOB")
"RTN","PSOAUTOC",58,0)
OUT K Y,DIC,X,PSOTM,PSOOPTN,PSOPTN,%DT,DTOUT
"RTN","PSOAUTOC",59,0)
 Q
"RTN","PSOAUTOC",60,0)
 ;initialize management data compile job
"RTN","PSOAUTOC",61,0)
SETUP1 K %DT,DIC,DTOUT S DIC(0)="ZXM",DIC="^DIC(19.2,",X="PSO MGMT NIGHTLY COMPILE" D ^DIC
"RTN","PSOAUTOC",62,0)
 I +Y>0 D EDIT^XUTMOPT("PSO MGMT NIGHTLY COMPILE") G OUT
"RTN","PSOAUTOC",63,0)
 D RESCH^XUTMOPT("PSO MGMT NIGHTLY COMPILE","","","24H","L"),EDIT^XUTMOPT("PSO MGMT NIGHTLY COMPILE")
"RTN","PSOAUTOC",64,0)
 K Y,DIC,X,PSOTM,DIR,PSOOPTN,PSOPTN,%DT,DTOUT
"RTN","PSOAUTOC",65,0)
 Q
"RTN","PSOAUTOC",66,0)
APSOD(PSODFN) ;sends mail message that date of death has been deleted
"RTN","PSOAUTOC",67,0)
 I $G(PSODFN),$D(^PS(52.91,PSODFN,0)) D
"RTN","PSOAUTOC",68,0)
 .I $P(^PS(52.91,PSODFN,0),"^",3),$P(^(0),"^",4)=5 D
"RTN","PSOAUTOC",69,0)
 ..S $P(^PS(52.91,PSODFN,0),"^",3)="",$P(^PS(52.91,PSODFN,0),"^",4)=""
"RTN","PSOAUTOC",70,0)
 ..S ^PS(52.91,"AX",DT,PSODFN)=""
"RTN","PSOAUTOC",71,0)
 ..I $D(^PS(55,PSODFN,0)),$P($G(^PS(55,PSODFN,"PS")),"^")="" D
"RTN","PSOAUTOC",72,0)
 ...N PSORESPS,PSORESFG,PSORESF1 S PSORESFG=0 F PSORESPS=0:0 S PSORESPS=$O(^PS(53,PSORESPS)) Q:'PSORESPS!(PSORESFG)  D
"RTN","PSOAUTOC",73,0)
 ....S PSORESF1=$P($G(^PS(53,PSORESPS,0)),"^") S PSORESF1=$$UP^XLFSTR(PSORESF1) I PSORESF1="NON-VA" S $P(^PS(55,PSODFN,"PS"),"^")=PSORESPS,PSORESFG=1
"RTN","PSOAUTOC",74,0)
 N DI,DA,DR,DIE,DIC,X,Y
"RTN","PSOAUTOC",75,0)
 S ZTDTH=$H,ZTREQ="@",ZTSAVE("ZTREQ")="",ZTSAVE("PSODFN")="",ZTRTN="MAIL^PSOAUTOC",ZTDESC="Sends Mail Message that a Date of Death was Deleted",ZTIO="" D ^%ZTLOAD
"RTN","PSOAUTOC",76,0)
 Q
"RTN","PSOAUTOC",77,0)
MAIL ;builds mail message
"RTN","PSOAUTOC",78,0)
 S DIC=2,DA=PSODFN,DR=.351,DIQ="PTDOD" D EN^DIQ1 I PTDOD(2,DA,.351)]"" G EX1
"RTN","PSOAUTOC",79,0)
 K ^TMP("PSOHLD",$J),^TMP("PSOAD",$J),TOTRX,TOTPRX
"RTN","PSOAUTOC",80,0)
 F I=0:0 S I=$O(^PSRX("APSOD",PSODFN,I)) Q:'I  S TOTRX=$G(TOTRX)+1
"RTN","PSOAUTOC",81,0)
 F I=0:0 S I=$O(^PS(52.41,"APSOD",PSODFN,I)) Q:'I  S TOTPRX=$G(TOTPRX)+1
"RTN","PSOAUTOC",82,0)
 F I=0:0 S I=$O(^PS(55,PSODFN,"NVA","APSOD",I)) Q:'I  S TOTNVA=$G(TOTNVA)+1
"RTN","PSOAUTOC",83,0)
 K I Q:'$G(TOTRX)&('$G(TOTPRX))&('$G(TOTNVA))
"RTN","PSOAUTOC",84,0)
 S ENT=0,DFN=PSODFN D DEM^VADPT
"RTN","PSOAUTOC",85,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)=$P(^DPT(PSODFN,0),"^")_" ID#: "_VA("PID")_" DOB: "_$P(VADM(3),"^",2)
"RTN","PSOAUTOC",86,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)=" " S Y=DT D DD^%DT
"RTN","PSOAUTOC",87,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="This patient had a Date of Death deleted on "_Y_"."
"RTN","PSOAUTOC",88,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="When a Date of Death is entered ALL active prescriptions, pending orders, and",ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Non-VA Meds are discontinued automatically. The following Outpatient"
"RTN","PSOAUTOC",89,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Prescriptions and/or Pending Orders should be reviewed for this patient using",ENT=ENT+1,^TMP("PSOAD",$J,ENT)="the Patient Prescription Processing option."
"RTN","PSOAUTOC",90,0)
 S ENT=ENT+1,^TMP("PSOAD",$J,ENT)=" "
"RTN","PSOAUTOC",91,0)
 I $G(TOTRX) S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Total number of Prescriptions found for review is "_TOTRX D
"RTN","PSOAUTOC",92,0)
 .F I=0:0 S I=$O(^PSRX("APSOD",PSODFN,I)) Q:'I  S ^TMP("PSOHLD",$J,$P(^PSDRUG($P(^PSRX(I,0),"^",6),0),"^"),I)=I
"RTN","PSOAUTOC",93,0)
 .S DRG="" F  S DRG=$O(^TMP("PSOHLD",$J,DRG)) Q:DRG=""  F I=0:0 S I=$O(^TMP("PSOHLD",$J,DRG,I)) Q:'I  S RX=^TMP("PSOHLD",$J,DRG,I) D
"RTN","PSOAUTOC",94,0)
 ..S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Rx: "_$P(^PSRX(RX,0),"^")_"  Drug: "_DRG
"RTN","PSOAUTOC",95,0)
 N PSOLPI,PSOLPIX,PSOLPIST,PSOLPND
"RTN","PSOAUTOC",96,0)
 I $G(TOTPRX) S ENT=ENT+1,^TMP("PSOAD",$J,ENT)=" " D
"RTN","PSOAUTOC",97,0)
 .S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Total number of Pending Orders found and reinstated is "_TOTPRX
"RTN","PSOAUTOC",98,0)
 .F PSOLPI=0:0 S PSOLPI=$O(^PS(52.41,"APSOD",PSODFN,PSOLPI)) Q:'PSOLPI  D
"RTN","PSOAUTOC",99,0)
 ..S $P(^PS(52.41,PSOLPI,0),"^",3)=$P(^PS(52.41,PSOLPI,"DDSTA"),";"),^PS(52.41,"AOR",PSODFN,$P(^PS(52.41,PSOLPI,"DDSTA"),";",2),PSOLPI)=""
"RTN","PSOAUTOC",100,0)
 ..S PSOLPIX=$P($G(^PS(52.41,PSOLPI,0)),"^"),PSOLPIST=$P($G(^(0)),"^",3)
"RTN","PSOAUTOC",101,0)
 ..I PSOLPIX D
"RTN","PSOAUTOC",102,0)
 ...I PSOLPIST'="NW",PSOLPIST'="RNW",PSOLPIST'="RF" Q
"RTN","PSOAUTOC",103,0)
 ...;Reset remaining cross references
"RTN","PSOAUTOC",104,0)
 ...S PSOLPND=$G(^PS(52.41,PSOLPI,0))
"RTN","PSOAUTOC",105,0)
 ...I $P(PSOLPND,"^",12),$P(PSOLPND,"^",13) S ^PS(52.41,"ACL",$P(PSOLPND,"^",13),$P(PSOLPND,"^",12),PSOLPI)=""
"RTN","PSOAUTOC",106,0)
 ...I $P(^PS(52.41,PSOLPI,"INI"),"^"),$P(PSOLPND,"^",12) S ^PS(52.41,"AD",$P(PSOLPND,"^",12),$P(^PS(52.41,PSOLPI,"INI"),"^"),PSOLPI)=""
"RTN","PSOAUTOC",107,0)
 ...I PSOLPIST="RNW",$P(PSOLPND,"^",21) S ^PS(52.41,"AQ",$P(PSOLPND,"^",21),PSOLPI)=""
"RTN","PSOAUTOC",108,0)
 ...I PSOLPIST="RF" Q
"RTN","PSOAUTOC",109,0)
 ...;Update CPRS with Pending order information on new and renewals
"RTN","PSOAUTOC",110,0)
 ...D EN^PSOHLSN(PSOLPIX,"SC","IP")
"RTN","PSOAUTOC",111,0)
 ..K ^PS(52.41,"APSOD",PSODFN,PSOLPI),ORTYP
"RTN","PSOAUTOC",112,0)
 ..S ENT=ENT+1,ORTYP=$P(^PS(52.41,PSOLPI,0),"^",3)
"RTN","PSOAUTOC",113,0)
 ..S MED=$S($P(^PS(52.41,PSOLPI,0),"^",9):$P(^PSDRUG($P(^PS(52.41,PSOLPI,0),"^",9),0),"^"),1:$P(^PS(50.7,$P(^PS(52.41,PSOLPI,0),"^",8),0),"^"))
"RTN","PSOAUTOC",114,0)
 ..I $G(MED)']"" S MED="NO DRUG OR ORDERABLE ITEM FOUND"
"RTN","PSOAUTOC",115,0)
 ..S ^TMP("PSOAD",$J,ENT)=$S(ORTYP="RF":"Refill",ORTYP="RNW":"Renew",ORTYP="HD":"On Hold",1:"New")_" Order Request  -  "
"RTN","PSOAUTOC",116,0)
 ..S ^TMP("PSOAD",$J,ENT)=^TMP("PSOAD",$J,ENT)_"Medication: "_MED
"RTN","PSOAUTOC",117,0)
 I $G(TOTNVA) S ENT=ENT+1,^TMP("PSOAD",$J,ENT)=" " D
"RTN","PSOAUTOC",118,0)
 .N PSODD,MED,PSOOI,PSONVA,NVA S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Total number of Non-VA Med Orders found and reinstated is "_TOTNVA
"RTN","PSOAUTOC",119,0)
 .F NVA=0:0 S NVA=$O(^PS(55,PSODFN,"NVA","APSOD",NVA)) Q:'NVA  D
"RTN","PSOAUTOC",120,0)
 ..S PSOOI=$P(^PS(55,PSODFN,"NVA",NVA,0),"^"),PSODD=$P(^(0),"^",2),PLACER=$P(^(0),"^",8),LOCATION=$P(^(0),"^",12),DFN=PSODFN
"RTN","PSOAUTOC",121,0)
 ..S MED=$S(PSODD:$P($G(^PSDRUG(PSODD,0)),"^"),1:$P(^PS(50.7,+PSOOI,0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,+PSOOI,0),"^",2),0),"^"))
"RTN","PSOAUTOC",122,0)
 ..S $P(^PS(55,PSODFN,"NVA",NVA,0),"^",6)="",$P(^(0),"^",7)="" K ^PS(55,PSODFN,"NVA","APSOD",NVA)
"RTN","PSOAUTOC",123,0)
 ..S ENT=ENT+1,^TMP("PSOAD",$J,ENT)="Non-VA "_MED,REIN=1,PSONVA=NVA D REIN^PSONVNEW
"RTN","PSOAUTOC",124,0)
 ..K PSOOI,PSODD,PLACER,LOCATION,MED,REIN
"RTN","PSOAUTOC",125,0)
 S XMDUZ=.5,XMSUB="Date of Death Deleted for "_$P(^DPT(PSODFN,0),"^")_" ("_VA("BID")_")",XMTEXT="^TMP(""PSOAD"",$J," N DIFROM
"RTN","PSOAUTOC",126,0)
 F I=0:0 S I=$O(^XUSEC("PSORPH",I)) Q:'I  S XMY(I)=""
"RTN","PSOAUTOC",127,0)
 D ^XMD
"RTN","PSOAUTOC",128,0)
EX1 K ^TMP("PSOHLD",$J),XMSUB,XMTEXT,XMY,XMDUZ,^TMP("PSOAD",$J),I,TOTRX,TOTPRX,PSODFN,ENT,ORTYP,X,Y,MED,RX,PTDOD
"RTN","PSOAUTOC",129,0)
 Q
"RTN","PSOCAN3")
0^1^B73551199^B71670516
"RTN","PSOCAN3",1,0)
PSOCAN3 ;BIR/RTR/SAB - auto dc rxs due to death ; 9/18/06 2:59pm
"RTN","PSOCAN3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,24,27,32,36,94,88,117,131,146,139,132,223,235,148,249**;DEC 1997;Build 9
"RTN","PSOCAN3",3,0)
 ;External reference to File #55 supported by DBIA 2228
"RTN","PSOCAN3",4,0)
 ;External references to L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN3",5,0)
 Q
"RTN","PSOCAN3",6,0)
APSOD(PSODFN) ;called from file #2 date of death xref 'APOSD'
"RTN","PSOCAN3",7,0)
 N D,DA,DB,DC,DE,DG,DH,DI,DIC,DIE,DIG,DIH,DIK,DIR,DIQ,DIU,DIV,DIW,DK,DL,DM,DP,DQ,DU,DV,DW,DR
"RTN","PSOCAN3",8,0)
 S PSODEATH=1 D CAN K PSODEATH
"RTN","PSOCAN3",9,0)
 Q
"RTN","PSOCAN3",10,0)
CAN ;discontinued rxs due to death
"RTN","PSOCAN3",11,0)
 I $G(PSODFN),$D(^PS(52.91,PSODFN,0)) D
"RTN","PSOCAN3",12,0)
 .I '$P($G(^PS(52.91,PSODFN,0)),"^",3)!($P($G(^(0)),"^",3)>DT) S $P(^PS(52.91,PSODFN,0),"^",3)=DT,$P(^PS(52.91,PSODFN,0),"^",4)=5,^PS(52.91,"AX",DT,PSODFN)="" D SET^PSOTPCAN(PSODFN)
"RTN","PSOCAN3",13,0)
 F PSORXJ=0:0 S PSORXJ=$O(^PS(55,PSODFN,"P",PSORXJ)) Q:'PSORXJ  I $D(^(PSORXJ,0)) S PSORX=^(0) S STA=$S($P($G(^PSRX(PSORX,"STA")),"^")<11:1,$P($G(^("STA")),"^")=16:1,1:0) D:STA
"RTN","PSOCAN3",14,0)
 .I $D(^PSRX(PSORX,0)),$P($G(^PSRX(PSORX,"STA")),"^")="" D SETC
"RTN","PSOCAN3",15,0)
 .D REVERSE^PSOBPSU1(PSORX,,"DC",7)
"RTN","PSOCAN3",16,0)
 .I $D(^PSRX(PSORX,0)),$P($G(^PSRX(PSORX,2)),"^",6)'<DT S PSO0=^(0),PSO2=$G(^(2)) D
"RTN","PSOCAN3",17,0)
 ..S ^PSRX(PSORX,"DDSTA")="52;"_$P(^PSRX(PSORX,"STA"),"^")
"RTN","PSOCAN3",18,0)
 ..;remove from hold
"RTN","PSOCAN3",19,0)
 ..I $G(^PSRX(PSORX,"H"))]"" D
"RTN","PSOCAN3",20,0)
 ...S ^PSRX(PSORX,"DDSTA")="52;"_$P(^PSRX(PSORX,"STA"),"^")_"^"_^PSRX(PSORX,"H")
"RTN","PSOCAN3",21,0)
 ...K:$P(^PSRX(PSORX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSORX,"H"),"^"),PSORX) S ^PSRX(PSORX,"H")=""
"RTN","PSOCAN3",22,0)
 ...I '$P($G(^PSRX(PSORX,2)),"^",2),$P($G(^(3)),"^") S $P(^PSRX(PSORX,2),"^",2)=$P(^(3),"^")
"RTN","PSOCAN3",23,0)
 ...I $G(PSODEATH),$P(^PSRX(PSORX,0),"^",2) S ^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",24,0)
 ..;delete from non-verified file
"RTN","PSOCAN3",25,0)
 ..I $G(^PS(52.4,PSORX,0))]"" S ^PSRX(PSORX,"DDSTA")="52.4;"_$P(^PSRX(PSORX,"STA"),"^")_"^"_^PS(52.4,PSORX,0),DIK="^PS(52.4,",DA=PSORX D ^DIK K DIK
"RTN","PSOCAN3",26,0)
 ..I $G(PSODEATH),$P(^PSRX(PSORX,0),"^",2) S ^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",27,0)
 ..;delete from suspense
"RTN","PSOCAN3",28,0)
 ..D:$O(^PS(52.5,"B",PSORX,0))
"RTN","PSOCAN3",29,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)) I '$G(^PS(52.5,DA,"P")),$G(PSODEATH) S ^PSRX(PSORX,"DDSTA")="52.5;5^"_^PS(52.5,DA,0),^PSRX("APSOD",$P(^PSRX(PSORX,0),"^",2),PSORX)=""
"RTN","PSOCAN3",30,0)
 ...I $O(^PSRX(PSORX,1,0)),'$G(PSODEATH) S DA=PSORX,SUSD=$P($G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),0)),"^",2) D:'$G(^PS(52.5,$O(^PS(52.5,"B",PSORX,0)),"P")) REF^PSOCAN2
"RTN","PSOCAN3",31,0)
 ...S DA=$O(^PS(52.5,"B",PSORX,0)),DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOCAN3",32,0)
 ..D SETC
"RTN","PSOCAN3",33,0)
 ..;activity record
"RTN","PSOCAN3",34,0)
 ..S (COM,ACOM)=$S($G(PSODEATH):"Date of Death Entered by MAS",1:"Discontinued by Pharmacy")_"."
"RTN","PSOCAN3",35,0)
 ..S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(PSORX,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOCAN3",36,0)
 ..S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(PSORX,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN3",37,0)
 ..D NOW^%DTC S ACNT=ACNT+1,^PSRX(PSORX,"A",0)="^52.3DA^"_ACNT_"^"_ACNT
"RTN","PSOCAN3",38,0)
 ..S ^PSRX(PSORX,"A",ACNT,0)=%_"^"_"C"_"^^"_RFCNT_"^"_"Auto Discontinued Due to Death. "_ACOM
"RTN","PSOCAN3",39,0)
 ..;check for label/release/pending release
"RTN","PSOCAN3",40,0)
 ..D FIL
"RTN","PSOCAN3",41,0)
 ..S STAT="OD",PHARMST="" D EN^PSOHLSN1(PSORX,STAT,PHARMST,COM,"A") K COMM,PHARMST,STAT
"RTN","PSOCAN3",42,0)
 ;dc pending orders
"RTN","PSOCAN3",43,0)
 F PDA=0:0 S PDA=$O(^PS(52.41,"P",PSODFN,PDA)) Q:'PDA  I $P(^PS(52.41,PDA,0),"^",3)'="DC"&($P(^(0),"^",3)'="DE") D
"RTN","PSOCAN3",44,0)
 .I $G(PSODEATH) D
"RTN","PSOCAN3",45,0)
 ..S ^PS(52.41,PDA,"DDSTA")=$P(^PS(52.41,PDA,0),"^",3)_";"_+$P($G(^PS(52.41,PDA,"INI")),"^"),^PS(52.41,"APSOD",PSODFN,PDA)=""
"RTN","PSOCAN3",46,0)
 ..S $P(^PS(52.41,PDA,4),"^")="Date of Death Entered by MAS."
"RTN","PSOCAN3",47,0)
 .S $P(^PS(52.41,PDA,0),"^",3)="DC"
"RTN","PSOCAN3",48,0)
 .K ^PS(52.41,"AOR",PSODFN,+$P($G(^PS(52.41,PDA,"INI")),"^"),PDA)
"RTN","PSOCAN3",49,0)
 .S COM=$S($G(PSODEATH):"Date of Death Entered by MAS.",1:""),PL=$P(^PS(52.41,PDA,0),"^"),$P(^(0),"^",3)="DC"
"RTN","PSOCAN3",50,0)
 .D EN^PSOHLSN(PL,"OC",COM,"A") K COM,PL
"RTN","PSOCAN3",51,0)
 ;dc non-va meds
"RTN","PSOCAN3",52,0)
 D APSOD^PSONVNEW
"RTN","PSOCAN3",53,0)
KILL K %,%H,%T,ACNT,DA,PDA,DIRUT,DTOUT,PSO,PSO0,PSO2,PSOD,PSOD0,PSODFN,PSODL,PSORX,PSORXJ,PSOSD,RF,RFCNT,SUB,TM,TSKDT,X,X1,X2,Y,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","PSOCAN3",54,0)
 D KVAR^VADPT S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCAN3",55,0)
 Q
"RTN","PSOCAN3",56,0)
CAN1 Q:$G(DODR)
"RTN","PSOCAN3",57,0)
 S PSOMGDFN=$G(PSODFN) ; SAVE IN CASE CANCELING RX THAT WAS MERGED TO ANOTHER DFN
"RTN","PSOCAN3",58,0)
 I $G(^PSRX(DA,"H"))]"" D HLD^PSOCAN2
"RTN","PSOCAN3",59,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7)
"RTN","PSOCAN3",60,0)
 S PSCANVAR=0,RXDA=DA,DA=$O(^PS(52.5,"B",DA,0)) I DA,'$G(^PS(52.5,DA,"P")) S PSCANVAR=1 D
"RTN","PSOCAN3",61,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOCAN3",62,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while suspended. "_$G(COM)
"RTN","PSOCAN3",63,0)
 .S DIK="^PS(52.5," D ^DIK K DIK S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2)
"RTN","PSOCAN3",64,0)
 .D AREC^PSOCAN1 S DA=RXDA I $O(^PSRX(DA,1,0)) D REF^PSOCAN2
"RTN","PSOCAN3",65,0)
 I $G(REA)="C" S DA=$O(^PS(52.5,"B",RXDA,0)) I DA S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOCAN3",66,0)
 I 'PSCANVAR S:$D(SPCANC) ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" during Rx cancel.  "
"RTN","PSOCAN3",67,0)
ADD S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) S:$G(PSOOPT)=3 REA="L"
"RTN","PSOCAN3",68,0)
 D:'$G(PSCANVAR) AREC^PSOCAN1 S:REA="L" REA="C" S:REA'="C" $P(^PSRX(DA,"STA"),"^")=0
"RTN","PSOCAN3",69,0)
 N PSOTPCNZ S PSOTPCNZ=0 I $P(^PSRX(DA,"STA"),"^")'=12 S PSOTPCNZ=1
"RTN","PSOCAN3",70,0)
 S:REA="C"&($P(^PSRX(DA,"STA"),"^")<12)!($P(^("STA"),"^")=16) $P(^PSRX(DA,"STA"),"^")=12 I $P($G(^PSRX(DA,"STA")),"^")=12,$G(PSOTPCNZ) D CAN^PSOTPCAN(DA)
"RTN","PSOCAN3",71,0)
 K PSOTPCNZ
"RTN","PSOCAN3",72,0)
 I REA="R" D
"RTN","PSOCAN3",73,0)
 .I $P(^PSRX(DA,3),"^",8) S $P(^PSRX(DA,3),"^",2)=$P(^PSRX(DA,3),"^",8),$P(^(3),"^",8)=""
"RTN","PSOCAN3",74,0)
 .S $P(^PSRX(DA,3),"^")=$S($P(^PSRX(DA,3),"^",10):$P(^(3),"^",10),$G(PSOCANHD):PSOCANHD,$P(^(3),"^",5):$P(^(3),"^",5),1:$P(^(3),"^")),$P(^(3),"^",5)="",$P(^(3),"^",10)=""
"RTN","PSOCAN3",75,0)
 I REA="C" D
"RTN","PSOCAN3",76,0)
 .S $P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^")
"RTN","PSOCAN3",77,0)
 .S:'$P(^PSRX(DA,3),"^",5) $P(^PSRX(DA,3),"^",5)=DT
"RTN","PSOCAN3",78,0)
 .I $O(^PS(52.41,"ARF",DA,0)),'$O(^PS(52.41,"APSOD",PSODFN,0)) S HLDDA=DA,DA=$O(^PS(52.41,"ARF",DA,0)),DIK="^PS(52.41," D ^DIK S DA=HLDDA K HLDDA
"RTN","PSOCAN3",79,0)
 .;check for label/release/pending release
"RTN","PSOCAN3",80,0)
 .I $G(PSOOPT)'=3 D FILX
"RTN","PSOCAN3",81,0)
 S PSONOOR=$S($D(PSONOOR):PSONOOR,1:"D"),STAT=$S(REA="C":"OD",1:"SC"),PHARMST=$S(REA="C":"",1:"CM")
"RTN","PSOCAN3",82,0)
 S COM=$S(REA="C":$S($G(PSOOPT)=3&('$G(DUP)):"Renewed",1:"Discontinued")_" by Pharmacy",1:"Reinstated by Pharmacy")
"RTN","PSOCAN3",83,0)
 D EN^PSOHLSN1(DA,STAT,PHARMST,COM,$S($G(PSOOPT)=3&('$G(DUP)):"",1:PSONOOR)) K COM,STAT,PHARMST,PSCANVAR
"RTN","PSOCAN3",84,0)
 I REA="C" D
"RTN","PSOCAN3",85,0)
 .I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOCAN3",86,0)
 I $G(PSOMGDFN)'="" S PSODFN=PSOMGDFN K PSOMGDFN
"RTN","PSOCAN3",87,0)
 Q:(REA="C")!('$P($G(PSOPAR),"^",2))!($P(^PSRX(DA,2),"^",10)]"")
"RTN","PSOCAN3",88,0)
 Q:$D(^XUSEC("PSORPH",DUZ))  S PSVC=$P(^PSRX(DA,0),"^",16) F JJ=0:0 S JJ=$O(^PS(55,PSODFN,"P",JJ)) Q:'JJ  I $D(^(JJ,0)),+^(0)=DA Q
"RTN","PSOCAN3",89,0)
 Q:'JJ  S PSRXIN=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXIN,DIC(0)="ML"
"RTN","PSOCAN3",90,0)
 S DIC("DR")="1////"_$G(PSODFN)_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN3",91,0)
 K DD,DO D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM
"RTN","PSOCAN3",92,0)
 K DA,DIK S DA=PSRXIN K PSRXIN S $P(^PSRX(DA,"STA"),"^")=1 D NVER^PSOCAN2
"RTN","PSOCAN3",93,0)
 W !,"Rx # "_$P(^PSRX(DA,0),"^")_" is still non-verified!"
"RTN","PSOCAN3",94,0)
 Q
"RTN","PSOCAN3",95,0)
OERR I '$D(^XUSEC("PSORPH",DUZ)),'$P($G(PSOPAR),"^",2) S VALMSG="Invalid Action Selection!",VALMBCK="" Q
"RTN","PSOCAN3",96,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOCAN3",97,0)
 K PSOPLCK S PSOCANRD=+$P($G(^PSRX($P(PSOLST(ORN),"^",2),0)),"^",4),PSOCANRA=1
"RTN","PSOCAN3",98,0)
 I $P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^"),$P(^("STA"),"^")=1!($P(^("STA"),"^")=4) S:$G(SPEED) PSONOORS=$G(PSONOOR) D DEL^PSOCAN4 S:$G(PSONOORS)'="" PSONOOR=$G(PSONOORS) K PSONOORS D KCAN D ULP Q
"RTN","PSOCAN3",99,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) S VALMSG=$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),VALMBCK="" K PSOMSG D KCAN D ULP Q
"RTN","PSOCAN3",100,0)
 I '+^PSRX($P(PSOLST(ORN),"^",2),"OR1"),$P(^("STA"),"^")=12 S VALMSG="Rx Cannot be Reinstated.  No Orderable Item." D KCAN D ULP D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN3",101,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12,$P($G(^("PKI")),"^") S VALMSG="Cannot be Reinstated - Digitally Signed" D KCAN D ULP D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN3",102,0)
 I $P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12 S PSOCANRZ=1
"RTN","PSOCAN3",103,0)
 D HLDHDR^PSOLMUTL S X=$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),PS=$S($P(^PSRX($P(PSOLST(ORN),"^",2),"STA"),"^")=12:"Reinstate: ",1:"Discontinue: ")
"RTN","PSOCAN3",104,0)
 S POERR=1,DFNHLD=PSODFN,DA=$P(PSOLST(ORN),"^",2)
"RTN","PSOCAN3",105,0)
 I $P(^PSRX(DA,3),"^",5) S PSOCANHD=$P(^PSRX(DA,3),"^",5)
"RTN","PSOCAN3",106,0)
 D LMNO D:$P($G(^PSRX($P(PSOLST(ORN),"^",2),"STA")),"^")=12 RMP
"RTN","PSOCAN3",107,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOCAN3",108,0)
 K POERR,PSCAN,PSI,PSL S PSODFN=DFNHLD K DFNHLD D ULP
"RTN","PSOCAN3",109,0)
 D KCAN
"RTN","PSOCAN3",110,0)
 Q
"RTN","PSOCAN3",111,0)
 Q
"RTN","PSOCAN3",112,0)
ULP D UL^PSSLOCK(+$G(PSODFN))
"RTN","PSOCAN3",113,0)
 Q
"RTN","PSOCAN3",114,0)
 ;
"RTN","PSOCAN3",115,0)
LMNO ; Calls LMNO^PSOCAN
"RTN","PSOCAN3",116,0)
 N PSODFN,PSORX,RXN,RX0
"RTN","PSOCAN3",117,0)
 S PSPOP=0,RXNUM=X S PSODFN=+$P(^PSRX(DA,0),"^",2) D LMNO^PSOCAN
"RTN","PSOCAN3",118,0)
 Q
"RTN","PSOCAN3",119,0)
 ;
"RTN","PSOCAN3",120,0)
KCAN ;
"RTN","PSOCAN3",121,0)
 K PSOCANRA,PSOCANRC,PSOCANRD,PSOCANRN,PSOCANRP,PSOCANRZ,PSOMSG,PSOCANHD
"RTN","PSOCAN3",122,0)
 Q
"RTN","PSOCAN3",123,0)
 ;
"RTN","PSOCAN3",124,0)
KCAN1 ;
"RTN","PSOCAN3",125,0)
 K PSOCANRC,PSOCANRD,PSOCANRN,PSOCANRP,PSOCANRZ
"RTN","PSOCAN3",126,0)
 Q
"RTN","PSOCAN3",127,0)
 ;
"RTN","PSOCAN3",128,0)
RMP ;remove Rx if found in array PSORX("PSOL") (Label Queue)
"RTN","PSOCAN3",129,0)
 Q:'$D(PSORX("PSOL"))  S:'$G(DA) DA=$P(PSOLST(ORN),"^",2)
"RTN","PSOCAN3",130,0)
 N I,J,FND,ST1,ST2,ST3 S I=0
"RTN","PSOCAN3",131,0)
 F  S I=$O(PSORX("PSOL",I)) Q:'I  D
"RTN","PSOCAN3",132,0)
 . S ST1=PSORX("PSOL",I) Q:ST1'[(DA_",")
"RTN","PSOCAN3",133,0)
 . S ST3="",FND=0
"RTN","PSOCAN3",134,0)
 . F J=1:1 S ST2=$P(ST1,",",J) Q:'ST2  D
"RTN","PSOCAN3",135,0)
 . . I ST2=DA S FND=1 Q
"RTN","PSOCAN3",136,0)
 . . S ST3=ST3_$S('ST3:"",1:",")_ST2
"RTN","PSOCAN3",137,0)
 . I FND D
"RTN","PSOCAN3",138,0)
 . . S:ST3]"" PSORX("PSOL",I)=ST3_","
"RTN","PSOCAN3",139,0)
 . . K:ST3="" PSORX("PSOL",I)
"RTN","PSOCAN3",140,0)
 . . D:$D(BBRX(I)) RMB^PSOCAN2(I)
"RTN","PSOCAN3",141,0)
 Q
"RTN","PSOCAN3",142,0)
 ;
"RTN","PSOCAN3",143,0)
FIL Q:'$G(PSORX)
"RTN","PSOCAN3",144,0)
 S PSOFC=PSORX G FILC
"RTN","PSOCAN3",145,0)
FILX Q:'$G(DA)
"RTN","PSOCAN3",146,0)
 S PSOFC=DA
"RTN","PSOCAN3",147,0)
FILC ;
"RTN","PSOCAN3",148,0)
 N PFC,PSOFFLAG
"RTN","PSOCAN3",149,0)
 I $P($G(^PSRX(PSOFC,2)),"^",13) G FILQ
"RTN","PSOCAN3",150,0)
 S PSOFFLAG=0 F PFC=0:0 S PFC=$O(^PSRX(PSOFC,1,PFC)) Q:'PFC!(PSOFFLAG)  I $P($G(^PSRX(PSOFC,1,PFC,0)),"^",18) S PSOFFLAG=1
"RTN","PSOCAN3",151,0)
 I PSOFFLAG G FILQ
"RTN","PSOCAN3",152,0)
 F PFC=0:0 S PFC=$O(^PSRX(PSOFC,"L",PFC)) Q:'PFC!(PSOFFLAG)  I $D(^PSRX(PSOFC,"L",PFC,0)),'$P($G(^(0)),"^",5) S PSOFFLAG=1
"RTN","PSOCAN3",153,0)
 I PSOFFLAG G FILQ
"RTN","PSOCAN3",154,0)
 S PSOFCSUS=$O(^PS(52.5,"B",PSOFC,0))
"RTN","PSOCAN3",155,0)
 I $G(PSOFCSUS),$P($G(^PS(52.5,PSOFCSUS,0)),"^",7)="L"!($P($G(^(0)),"^",7)="X") G FILQ
"RTN","PSOCAN3",156,0)
 S $P(^PSRX(PSOFC,3),"^",8)=$P($G(^PSRX(PSOFC,3)),"^",2)
"RTN","PSOCAN3",157,0)
 S $P(^PSRX(PSOFC,3),"^",2)=$P($G(^PSRX(PSOFC,2)),"^",2)
"RTN","PSOCAN3",158,0)
 I $P($G(^PSRX(PSOFC,"OR1")),"^",3) S $P(^PSRX(PSOFC,3),"^")=$P($G(^PSRX($P(^PSRX(PSOFC,"OR1"),"^",3),3)),"^")
"RTN","PSOCAN3",159,0)
FILQ K PSOFC,PSOFCSUS
"RTN","PSOCAN3",160,0)
 Q
"RTN","PSOCAN3",161,0)
 ;
"RTN","PSOCAN3",162,0)
SETC ;Called from Date of Death
"RTN","PSOCAN3",163,0)
 S $P(^PSRX(PSORX,"STA"),"^")=12,$P(^PSRX(PSORX,3),"^",5)=DT,$P(^PSRX(PSORX,3),"^",10)=$P(^PSRX(PSORX,3),"^") D CAN^PSOTPCAN(PSORX)
"RTN","PSOCAN3",164,0)
 Q
"RTN","PSOFUNC")
0^6^B6545033^B6987842
"RTN","PSOFUNC",1,0)
PSOFUNC ;BHAM ISC/DRI - functions moved from the psf global ; 10/26/92 11:49
"RTN","PSOFUNC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**146,223,249**;DEC 1997;Build 9
"RTN","PSOFUNC",3,0)
STAT ;gets status of rx
"RTN","PSOFUNC",4,0)
 S ST0=+$P(RX0,"^",15) I ST0<12,$O(^PS(52.5,"B",J,0)),$D(^PS(52.5,+$O(^(0)),0)),'$G(^("P")) S ST0=5
"RTN","PSOFUNC",5,0)
 I ST0<12,$P(RX2,"^",6)<DT S ST0=11
"RTN","PSOFUNC",6,0)
 S ST=$P("Error^Active^Non-Verified^Refill^Hold^Non-Verified^Suspended^^^^^Done^Expired^Discontinued^Deleted^Discontinued^Discontinued (Edit)^Provider Hold^","^",ST0+2),$P(RX0,"^",15)=ST0
"RTN","PSOFUNC",7,0)
 Q
"RTN","PSOFUNC",8,0)
CUTDATE ;calculates exp/cancel cutoff date in PSODTCUT
"RTN","PSOFUNC",9,0)
 S X1=DT,X2=-120 D C^%DTC S PSODTCUT=X,PSOPRPAS=$P($G(PSOPAR),"^",7) Q
"RTN","PSOFUNC",10,0)
 ;
"RTN","PSOFUNC",11,0)
FIXEXPDT ;calculate expiration date on rx's missing them
"RTN","PSOFUNC",12,0)
 F J=0:0 S J=$O(^PSRX(J)) Q:'J  I $D(^(J,0))#2 S RX0=^(0),RX2=$S($D(^(2))#2:^(2),1:"") D ^PSOEXDT:'$P(RX2,"^",6)
"RTN","PSOFUNC",13,0)
 Q
"RTN","PSOFUNC",14,0)
 ;
"RTN","PSOFUNC",15,0)
INP526 ;input transform for drug field (#6) in prescription file (#52)
"RTN","PSOFUNC",16,0)
 ;
"RTN","PSOFUNC",17,0)
 S PSODFN=+$P(^PSRX(DA,0),"^",2) F I=0:0 S I=$O(^PS(55,PSODFN,"P",I)) Q:'I  S RX=+^(I,0) I RX'=DA,$D(^PSRX(RX,0)),+$P(^(0),"^",6)=X,'$P(^("STA"),"^") S XS=X,X2=$P(^(0),"^",13),X1=$P(^PSRX(DA,0),"^",13) D ^%DTC D:X<180 INP5261 Q:'$D(X)  S X=XS
"RTN","PSOFUNC",18,0)
 Q
"RTN","PSOFUNC",19,0)
INP5261 D EN^DDIOL("Duplicate Drug in Rx #"_$P(^PSRX(RX,0),"^")_" . Discontinue? (Y/N): ","","$C(7),?10") R ZX:DTIME
"RTN","PSOFUNC",20,0)
 I ZX["^" D EN^DDIOL("NO UP ARROW ALLOWED","","!") S ZX="?"
"RTN","PSOFUNC",21,0)
 I ZX["?" D EN^DDIOL("Enter Y to discontinue this Prescription","","!") D EN^DDIOL(" ","","!") G INP5261
"RTN","PSOFUNC",22,0)
 S ZX=ZX?1"Y".E I ZX S $P(^PSRX(RX,"STA"),"^")=12,$P(^PSRX(RX,3),"^",5)=DT D CAN^PSOTPCAN(RX) D EN^DDIOL("     Discontinued") Q
"RTN","PSOFUNC",23,0)
 K X,XS,ZS Q
"RTN","PSOHLDC")
0^7^B34921764^B35362366
"RTN","PSOHLDC",1,0)
PSOHLDC ;BIR/RTR-Process incoming cancel messages from CHCS ;09/06/02
"RTN","PSOHLDC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**111,121,146,223,148,249**;DEC 1997;Build 9
"RTN","PSOHLDC",3,0)
 ;External reference to ^PSSLOCK supported by DBIA 2789
"RTN","PSOHLDC",4,0)
 ;
"RTN","PSOHLDC",5,0)
ENDC ;
"RTN","PSOHLDC",6,0)
 ;Process exceptions
"RTN","PSOHLDC",7,0)
 N DA,PSOEXINP,PSOHLINR,PSOHLSTP,PSOHLSTR,PSOHLPL,PSOHLCM,PSOCANRC,PSOCANRN,PSOHUIOR
"RTN","PSOHLDC",8,0)
 S (PSOHBDS,PSOEXXQ)=0
"RTN","PSOHLDC",9,0)
 I PSOHDFOR S PSOEXMS="Invalid message structure." D NAK^PSOHLEXC Q
"RTN","PSOHLDC",10,0)
 F PSOHMSG="MSH","PID","ORC" Q:PSOEXXQ  I '$D(PSOHLMIS(PSOHMSG)) S PSOEXMS="Missing "_PSOHMSG_" segment." S PSOHBDS=1 D NAK^PSOHLEXC
"RTN","PSOHLDC",11,0)
 I $G(PSOEXXQ) Q
"RTN","PSOHLDC",12,0)
 I $G(HL("SAN"))="" S PSOEXMS="Missing sending application name." D NAK^PSOHLEXC Q
"RTN","PSOHLDC",13,0)
 S PSOHY("EXAPP")=HL("SAN")
"RTN","PSOHLDC",14,0)
 I '$G(PSOHY("PAT"))!('$D(^DPT(+$G(PSOHY("PAT")),0))) S PSOEXMS="Invalid patient entry." D NAK^PSOHLEXC Q
"RTN","PSOHLDC",15,0)
 I $G(PSOHY("CHNUM"))="" S PSOEXMS="Missing CHCS Placer Order Number." D NAK^PSOHLEXC Q
"RTN","PSOHLDC",16,0)
 D CAN^PSOHLEXC
"RTN","PSOHLDC",17,0)
 I $G(PSOEXXQ) Q
"RTN","PSOHLDC",18,0)
 S (PSOEXINP,PSOHLINR)=0
"RTN","PSOHLDC",19,0)
 S PSOEXINP=$O(^PS(52.41,"C",PSOHY("CHNUM"),PSOHY("EXAPP"),0)) I PSOEXINP D PEND Q
"RTN","PSOHLDC",20,0)
 S PSOHLINR=$O(^PSRX("D",PSOHY("CHNUM"),PSOHY("EXAPP"),0)) I PSOHLINR D RX Q
"RTN","PSOHLDC",21,0)
 S PSOEXMS="Unable to find order in Pharmacy." D NAK^PSOHLEXC
"RTN","PSOHLDC",22,0)
 Q
"RTN","PSOHLDC",23,0)
PEND ;Process a DC message on a Pending order
"RTN","PSOHLDC",24,0)
 I PSOHY("PAT")'=$P($G(^PS(52.41,PSOEXINP,0)),"^",2) S PSOEXMS="Patient mismatch in Pending order." D NAK^PSOHLEXC Q
"RTN","PSOHLDC",25,0)
 K PSOMSG D PSOL^PSSLOCK(+PSOEXINP_"S") I '$G(PSOMSG) S PSOEXMS="Pending order is being edited by another user." D NAK^PSOHLEXC K PSOMSG Q
"RTN","PSOHLDC",26,0)
 K PSOMSG
"RTN","PSOHLDC",27,0)
 S PSOHLSTP=$P($G(^PS(52.41,PSOEXINP,0)),"^",3)
"RTN","PSOHLDC",28,0)
 I PSOHLSTP'="NW" D  D NAK^PSOHLEXC Q
"RTN","PSOHLDC",29,0)
 .S PSOEXMS="Unable to cancel Pending order, status is "_$S(PSOHLSTP="HD":"HOLD",PSOHLSTP="RNW":"RENEW",PSOHLSTP="DE":"DISCONTINUE (EDIT)",PSOHLSTP="DC":"DISCONTINUE",PSOHLSTP="RF":"REFILL REQUEST",1:"UNKNOWN")_"."
"RTN","PSOHLDC",30,0)
 S $P(^PS(52.41,PSOEXINP,0),"^",3)="DC"
"RTN","PSOHLDC",31,0)
 S PSOHLPL=$P(^PS(52.41,PSOEXINP,0),"^")
"RTN","PSOHLDC",32,0)
 K ^PS(52.41,"AOR",+$P($G(^PS(52.41,PSOEXINP,0)),"^",2),+$P($G(^PS(52.41,PSOEXINP,"INI")),"^"),PSOEXINP)
"RTN","PSOHLDC",33,0)
 S PSOHLCM="Discontinued by Provider."
"RTN","PSOHLDC",34,0)
 S $P(^PS(52.41,PSOEXINP,4),"^")=PSOHLCM
"RTN","PSOHLDC",35,0)
 D PVSET
"RTN","PSOHLDC",36,0)
 S PSOHUIOR=1
"RTN","PSOHLDC",37,0)
 I PSOHLPL D EN^PSOHLSN(PSOHLPL,"OC",PSOHLCM,"")
"RTN","PSOHLDC",38,0)
 D PSOUL^PSSLOCK(+PSOEXINP_"S")
"RTN","PSOHLDC",39,0)
 D ACK^PSOHLEXC
"RTN","PSOHLDC",40,0)
 K PSOHUIOR
"RTN","PSOHLDC",41,0)
 Q
"RTN","PSOHLDC",42,0)
RX ;Process a DC message on a prescription
"RTN","PSOHLDC",43,0)
 N PSOSUSD,PSOIFN,PSORFDT,PSOHTEST,PSOHPDA,CMOP,ACOM,PSOARECX,PSODFN
"RTN","PSOHLDC",44,0)
 S PSOARECX=0
"RTN","PSOHLDC",45,0)
 I PSOHY("PAT")'=$P($G(^PSRX(PSOHLINR,0)),"^",2) S PSOEXMS="Patient mismatch in prescription." D NAK^PSOHLEXC Q
"RTN","PSOHLDC",46,0)
 S PSODFN=$P($G(^PSRX(PSOHLINR,0)),"^",2)
"RTN","PSOHLDC",47,0)
 K PSOMSG D PSOL^PSSLOCK(PSOHLINR) I '$G(PSOMSG) S PSOEXMS="Prescription is being edited by another user." D NAK^PSOHLEXC K PSOMSG Q
"RTN","PSOHLDC",48,0)
 K PSOMSG
"RTN","PSOHLDC",49,0)
 S PSOHLSTR=$P($G(^PSRX(PSOHLINR,"STA")),"^")
"RTN","PSOHLDC",50,0)
 I PSOHLSTR>11,PSOHLSTR<16 D  D NAK^PSOHLEXC Q
"RTN","PSOHLDC",51,0)
 .S PSOEXMS="Unable to cancel prescription, status is "_$S(PSOHLSTR=12:"DISCONTINUED",PSOHLSTR=13:"DELETED",PSOHLSTR=14:"DISCONTINUED BY PROVIDER",1:"DISCONTINUED (EDIT)")_"."
"RTN","PSOHLDC",52,0)
 S (PSOHLCM,ACOM)="Discontinued by Provider."
"RTN","PSOHLDC",53,0)
 I PSOHLSTR=3!(PSOHLSTR=16) D
"RTN","PSOHLDC",54,0)
 .S (PSOHLCM,ACOM)="Discontinued by Provider while on hold." K:$P($G(^PSRX(PSOHLINR,"H")),"^") ^PSRX("AH",$P($G(^PSRX(PSOHLINR,"H")),"^"),PSOHLINR) S ^PSRX(PSOHLINR,"H")=""
"RTN","PSOHLDC",55,0)
 .I $P(^PSRX(PSOHLINR,0),"^",13),'$O(^PSRX(PSOHLINR,1,0)) S DIE=52,DR="22///"_$E($P(^PSRX(PSOHLINR,0),"^",13),1,7),DA=PSOHLINR D ^DIE K DIE,DA,DR Q
"RTN","PSOHLDC",56,0)
 .S (PSOIFN,PSOSUSD)=0,PSORFDT="" F  S PSOIFN=$O(^PSRX(PSOHLINR,1,PSOIFN)) Q:'PSOIFN  S PSOSUSD=PSOIFN,PSORFDT=$P($G(^PSRX(PSOHLINR,1,PSOIFN,0)),"^")
"RTN","PSOHLDC",57,0)
 .I $G(PSORFDT)=""!('$G(PSOSUSD)) Q
"RTN","PSOHLDC",58,0)
 .I '$P($G(^PSRX(PSOHLINR,1,PSOSUSD,0)),"^",18) S PSOHTEST=0 D  I 'PSOHTEST K ^PSRX(PSOHLINR,1,PSOSUSD),^PSRX("AD",PSORFDT,PSOHLINR,PSOSUSD),^PSRX(PSOHLINR,1,"B",PSORFDT,PSOSUSD),PSOIFN,PSOSUSD,PSORFDT
"RTN","PSOHLDC",59,0)
 ..F PSOHPDA=0:0 S PSOHPDA=$O(^PSRX(PSOHLINR,"L",PSOHPDA)) Q:'PSOHPDA  I $P($G(^PSRX(PSOHLINR,"L",PSOHPDA,0)),"^",2)=PSOSUSD S PSOHTEST=1
"RTN","PSOHLDC",60,0)
 ..K CMOP S DA=PSOHLINR D ^PSOCMOPA I $G(CMOP(CMOP("L")))="",$G(CMOP("S"))'="L" Q
"RTN","PSOHLDC",61,0)
 ..S PSOHTEST=1
"RTN","PSOHLDC",62,0)
 D SUS
"RTN","PSOHLDC",63,0)
 I '$G(PSOARECX) D ACTL
"RTN","PSOHLDC",64,0)
 S $P(^PSRX(PSOHLINR,"STA"),"^")=14,$P(^PSRX(PSOHLINR,3),"^",5)=DT
"RTN","PSOHLDC",65,0)
 D CAN^PSOTPCAN(PSOHLINR),REVERSE^PSOBPSU1(PSOHLINR,,"DC",7)
"RTN","PSOHLDC",66,0)
 I $O(^PS(52.41,"ARF",PSOHLINR,0)),'$O(^PS(52.41,"APSOD",PSODFN,0)) S DA=$O(^PS(52.41,"ARF",PSOHLINR,0)),DIK="^PS(52.41," D ^DIK K DIK
"RTN","PSOHLDC",67,0)
 D PVSET
"RTN","PSOHLDC",68,0)
 S PSOHUIOR=1
"RTN","PSOHLDC",69,0)
 D EN^PSOHLSN1(PSOHLINR,"OD","","Discontinued by Provider","")
"RTN","PSOHLDC",70,0)
 K PSOHUIOR
"RTN","PSOHLDC",71,0)
 I $G(^PS(52.4,PSOHLINR,0))]"" S DA=PSOHLINR,DIK="^PS(52.4," D ^DIK K DIK
"RTN","PSOHLDC",72,0)
 D PSOUL^PSSLOCK(PSOHLINR)
"RTN","PSOHLDC",73,0)
 D ACK^PSOHLEXC
"RTN","PSOHLDC",74,0)
 Q
"RTN","PSOHLDC",75,0)
SUS N RXDA,SUSDA,IFN,PSORFDEL,SUSD,RF,NODE
"RTN","PSOHLDC",76,0)
 S RXDA=PSOHLINR,(DA,SUSDA)=$O(^PS(52.5,"B",PSOHLINR,0)) D:DA
"RTN","PSOHLDC",77,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOHLDC",78,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 (PSOHLCM,ACOM)="Discontinued by Provider while suspended."
"RTN","PSOHLDC",79,0)
 .I $O(^PSRX(PSOHLINR,1,0)) S PSOARECX=1 D ACTL S DA=PSOHLINR D:'$G(^PS(52.5,+SUSDA,"P")) REF^PSOCAN2
"RTN","PSOHLDC",80,0)
 .I $P($G(^PS(52.5,+SUSDA,0)),"^",2),$P($G(^(0)),"^",3) S DA=SUSDA,DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOHLDC",81,0)
 Q
"RTN","PSOHLDC",82,0)
ACTL ;Add Activity log
"RTN","PSOHLDC",83,0)
 N PSORXREF,REA,PSOACNT,PSOSIBB,PSORFH,PSORFCNT
"RTN","PSOHLDC",84,0)
 S PSORXREF=0,PSODFN=+$P(^PSRX(PSOHLINR,0),"^",2) D
"RTN","PSOHLDC",85,0)
 .S PSOACNT=0 F PSOSUBB=0:0 S PSOSUBB=$O(^PSRX(PSOHLINR,"A",PSOSUBB)) Q:'PSOSUBB  S PSOACNT=PSOSUBB
"RTN","PSOHLDC",86,0)
 .S PSORFCNT=0 F PSORFH=0:0 S PSORFH=$O(^PSRX(PSOHLINR,1,PSORFH)) Q:'PSORFH  S PSORFCNT=PSORFH S:PSORFH>5 PSORFCNT=PSORFH+1
"RTN","PSOHLDC",87,0)
 .D NOW^%DTC S ^PSRX(PSOHLINR,"A",0)="^52.3DA^"_(PSOACNT+1)_"^"_(PSOACNT+1),^PSRX(PSOHLINR,"A",PSOACNT+1,0)=%_"^C^"_$G(PSOHY("PROV"))_"^"_PSORFCNT_"^"_$G(PSOHLCM)
"RTN","PSOHLDC",88,0)
 .S REA="C" S DA=PSOHLINR N EXP,PCD,IFN D EXP^PSOHELP1
"RTN","PSOHLDC",89,0)
 Q
"RTN","PSOHLDC",90,0)
PVSET ;
"RTN","PSOHLDC",91,0)
 N DIC,X,Y,USER1
"RTN","PSOHLDC",92,0)
 D USER^PSOORFI2(PSOHY("PROV"))
"RTN","PSOHLDC",93,0)
 S PSOCANRC=PSOHY("PROV"),PSOCANRN=USER1
"RTN","PSOHLDC",94,0)
 Q
"RTN","PSOHLNEW")
0^3^B77643201^B77391528
"RTN","PSOHLNEW",1,0)
PSOHLNEW ;BIR/RTR - CPRS orders ; 11/30/06 11:49am
"RTN","PSOHLNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,7,15,46,71,98,111,124,117,131,146,132,143,223,235,148,239,249**;DEC 1997;Build 9
"RTN","PSOHLNEW",3,0)
 ;40.8-728,50-221,SC-2675,100-2219,50.7-2223,EN^ORERR-2187
"RTN","PSOHLNEW",4,0)
EN(MSG) ;
"RTN","PSOHLNEW",5,0)
 N PSODDRUG,ENTERED,LOCATION,PLACER,PSOOC,ROUTE,NATURE,PREV,ROUTING,OO,OR,STAT,ZZ,DFN,COMM,QCOUNT,OCOUNT,Q1I,QTARRAY,QTARRAY2,EE,PP,XOFLAG,PSODYSPL,PSOFILNM
"RTN","PSOHLNEW",6,0)
 N ONEFLAG,SERV,WPCT,EFFECT,PROV,PENDING,RRX,PSOLQ1I,PSOLQ1II,PSOQWX,PSOLQ1IX,PSONVA,PSOICD,PSOSCP,EEE
"RTN","PSOHLNEW",7,0)
 N OBXAR,AA,II,SIG1,FILLER,COMM,GG,FF,JJ,JJJ,CT,LIM,VAR,VAR1,QQQ,PSRNFLAG,PSRNQFLG,RCOMM,XOFLAGZ,NWFLAG,PFLAG,PSINPTR,INPTRX,PSOIBN,PSOIBY
"RTN","PSOHLNEW",8,0)
 N DSIG,PSOCHFFL,PSOCVI,PSOMO,PSOXRP,NN,LL,LLL,WPARRAY,QTVAR,POVAR,POVAR1,ORCSEG,NNN,OOO,AAA,NNNN,POLIM,NNCK,PRIOR,IPPLACER,PLACERXX,EER,PSERRPID,PSERRPV1,PSERRORC,PSOEXFLG,PSOMSORR,PDFN
"RTN","PSOHLNEW",9,0)
 S (SEND,PSOSND,OCOUNT)=0 K PSOPLC,PSOFFL,PSORSO,PSOSUSZ
"RTN","PSOHLNEW",10,0)
 F OO=0:0 S OO=$O(MSG(OO)) Q:'OO!(SEND)!(PSOSND)  D:$P(MSG(OO),"|")="PID" SPDFN I $P(MSG(OO),"|")="ORC",$P(MSG(OO),"|",2)'="NW",$P(MSG(OO),"|",2)'="XO" D
"RTN","PSOHLNEW",11,0)
 .S OR("STAT")=$P(MSG(OO),"|",2),OR("PLACE")=+$P(MSG(OO),"|",3),PLACERXX=+$P($P(MSG(OO),"|",3),";",2),OR("COMM")=$P(MSG(OO),"|",17),OR("USER")=$P(MSG(OO),"|",11) I $P(MSG(OO),"|",2)'="DE",$P(MSG(OO),"|",2)'="NA" S SEND=1 D FILL Q
"RTN","PSOHLNEW",12,0)
 .S PSOPLC=+$P(MSG(OO),"|",3),PSOFFL=+$P(MSG(OO),"|",4),PSOSND=1,PSOCHFFL=$P($P(MSG(OO),"|",4),"^")
"RTN","PSOHLNEW",13,0)
 I $G(OR("COMM"))["^" S OR("COMM")=$P(OR("COMM"),"^",5)
"RTN","PSOHLNEW",14,0)
 I PSOSND,$G(PSOCHFFL)["S",$G(OR("STAT"))="NA" D CHCS^PSOHLNE1 Q
"RTN","PSOHLNEW",15,0)
 I PSOSND,'$D(^PSRX(+$G(PSOFFL),0)) S COMM="Order was not located by Pharmacy" D EN^ORERR(COMM,.MSG) D KL Q
"RTN","PSOHLNEW",16,0)
 I PSOSND,$G(PDFN),PDFN'=+$P($G(^PSRX(+$G(PSOFFL),0)),"^",2) S COMM="Patient does not match" D EN^ORERR(COMM,.MSG) D KL Q
"RTN","PSOHLNEW",17,0)
 I PSOSND,$G(OR("STAT"))'="DE" N PSONAS S PSONAS=$S($P($G(^PSRX(PSOFFL,"OR1")),"^",2)="":1,1:0) S $P(^PSRX(PSOFFL,"OR1"),"^",2)=PSOPLC,^PSRX("APL",PSOPLC,PSOFFL)="" D:PSONAS EN^PSOHDR("PRES",PSOFFL) D KL Q
"RTN","PSOHLNEW",18,0)
 D KL
"RTN","PSOHLNEW",19,0)
 I SEND,$G(OR("STAT"))="Z@" G PURGE^PSOHLNE2
"RTN","PSOHLNEW",20,0)
 I SEND,$G(OR("STAT"))="ZF" G REF^PSOHLNE2
"RTN","PSOHLNEW",21,0)
 I SEND,$G(OR("STAT"))'="CA",$G(OR("STAT"))'="DC",$G(OR("STAT"))'="HD",$G(OR("STAT"))'="RL",$G(OR("STAT"))'="SS" S RCOMM="Invalid Order Control Code" D EN^ORERR(RCOMM,.MSG) Q
"RTN","PSOHLNEW",22,0)
 I SEND K SEND G:$G(OR("STAT"))="SS" ESTAT D EN^PSOORUTL(.OR) S PLACER=OR("PLACE"),STAT=OR("STAT"),COMM=OR("COMM") S PSOMSORR=1 D  K PSOMSORR Q
"RTN","PSOHLNEW",23,0)
 .I $G(OR("FILLER"))="" D  D ERROR^PSOHLSN Q
"RTN","PSOHLNEW",24,0)
 ..F EER=0:0 S EER=$O(MSG(EER)) Q:'EER  S:$P(MSG(EER),"|")="PV1" PSERRPV1=MSG(EER) S:$P(MSG(EER),"|")="PID" PSERRPID=MSG(EER) S:$P(MSG(EER),"|")="ORC"&($G(PSERRORC)="") PSERRORC=MSG(EER)
"RTN","PSOHLNEW",25,0)
 .I $P(OR("FILLER"),"^",2)="R" S FILLER=$P(OR("FILLER"),"^") D EN^PSOHLSN1(FILLER,STAT,$G(OR("PHARMST")),COMM) K:$G(PSOEXFLG) PSOMSORR,PLACERXX D:$G(PSOEXFLG) EN^PSOHLSN1(FILLER,"SC","ZE","") D:$G(PSOSUSZ) SUS^PSOORUT1 K PSOSUSZ Q
"RTN","PSOHLNEW",26,0)
 .D EN^PSOHLSN(PLACER,STAT,COMM) Q
"RTN","PSOHLNEW",27,0)
 D KL^PSOHLSIH S RRX=1 F ZZ=0:0 S ZZ=$O(MSG(ZZ)) Q:'ZZ  S PSOSEG=$G(MSG(ZZ)),PSOTYPE=$P(PSOSEG,"|") S PSOSEG=$E(PSOSEG,5,$L(PSOSEG)) I PSOTYPE'="NTE" D @PSOTYPE
"RTN","PSOHLNEW",28,0)
 I $G(PSRNFLAG) S PSOMO=0 D MISRN^PSOHLNE1 I $G(PSOMO) Q
"RTN","PSOHLNEW",29,0)
 S PSRNQFLG=0 I $G(PSRNFLAG),$G(PREV) D  I $G(PSRNQFLG) S RCOMM="Duplicate Renewal Request. Order rejected by Pharmacy." D EN^ORERR(RCOMM,.MSG) D RERROR^PSOHLSN D KL^PSOHLSIH Q
"RTN","PSOHLNEW",30,0)
 .I $P($G(^PSRX(PREV,"OR1")),"^",4) S PSRNQFLG=1 Q
"RTN","PSOHLNEW",31,0)
 .I $O(^PS(52.41,"AQ",PREV,0)) S PSRNQFLG=1
"RTN","PSOHLNEW",32,0)
 .I $G(XOFLAG),$G(DFN)'=$S($G(PFLAG):$P($G(^PS(52.41,+$G(PREV),0)),"^",2),1:$P($G(^PSRX(+$G(PREV),0)),"^",2)) S RCOMM="Patient mismatch on previous order." D EN^ORERR(RCOMM,.MSG) S XOFLAGZ=1 D RERROR^PSOHLSN D KL^PSOHLSIH Q
"RTN","PSOHLNEW",33,0)
 I $G(DFN)'=+$P($G(^OR(100,+$G(PLACER),0)),"^",2) G MISX^PSOHLNE1
"RTN","PSOHLNEW",34,0)
 I $G(PLACER) D NFILE
"RTN","PSOHLNEW",35,0)
 D KL^PSOHLSIH
"RTN","PSOHLNEW",36,0)
 Q
"RTN","PSOHLNEW",37,0)
ESTAT ;
"RTN","PSOHLNEW",38,0)
 D EXP^PSOHLNE1
"RTN","PSOHLNEW",39,0)
 Q
"RTN","PSOHLNEW",40,0)
MSH Q
"RTN","PSOHLNEW",41,0)
PID S DFN=+$P(PSOSEG,"|",3)
"RTN","PSOHLNEW",42,0)
 Q
"RTN","PSOHLNEW",43,0)
PV1 S LOCATION=+$P(+$P(PSOSEG,"|",3),"^")
"RTN","PSOHLNEW",44,0)
 S:'$D(^SC(LOCATION,0)) LOCATION=""
"RTN","PSOHLNEW",45,0)
 S INPTRX=0 I $G(LOCATION) S PSINPTR=$P($G(^SC(LOCATION,0)),"^",4) I PSINPTR Q
"RTN","PSOHLNEW",46,0)
 I $G(LOCATION) S INPTRX=$P($G(^SC(LOCATION,0)),"^",15)
"RTN","PSOHLNEW",47,0)
 I '$G(INPTRX) S INPTRX=$O(^DG(40.8,0))
"RTN","PSOHLNEW",48,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLNEW",49,0)
 S PSINPTR=+$$SITE^VASITE(DT,INPTRX)
"RTN","PSOHLNEW",50,0)
 Q
"RTN","PSOHLNEW",51,0)
DG1 S $P(PSOICD($P(PSOSEG,"|",1)),"^")=$P($P(PSOSEG,"|",3),"^")
"RTN","PSOHLNEW",52,0)
 Q
"RTN","PSOHLNEW",53,0)
ORC ;
"RTN","PSOHLNEW",54,0)
 Q:$P(PSOSEG,"|")="DE"
"RTN","PSOHLNEW",55,0)
 S:$P(PSOSEG,"|")="XO" XOFLAG=1 D ^PSOHLNE1 S:$G(PRIOR)="A" PRIOR="E" S:$G(PRIOR)="" PRIOR="R"
"RTN","PSOHLNEW",56,0)
 Q
"RTN","PSOHLNEW",57,0)
 ;
"RTN","PSOHLNEW",58,0)
RXO I $O(MSG(ZZ,0)) D ^PSOHLNE2 G RXOPS
"RTN","PSOHLNEW",59,0)
 S PSORDITE=$P($P(PSOSEG,"|"),"^",4)
"RTN","PSOHLNEW",60,0)
 S PSODDRUG=$P($P(PSOSEG,"|",10),"^",4) I $G(PSODDRUG) S:'$D(^PSDRUG(PSODDRUG,0)) PSODDRUG=""
"RTN","PSOHLNEW",61,0)
 S PSOXQTY=$P(PSOSEG,"|",11)
"RTN","PSOHLNEW",62,0)
 S PSOREFIL=$P(PSOSEG,"|",13)
"RTN","PSOHLNEW",63,0)
 S PSODYSPL=$P(PSOSEG,"|",17)
"RTN","PSOHLNEW",64,0)
RXOPS S ONEFLAG=0,WPCT=1,LL=ZZ+1
"RTN","PSOHLNEW",65,0)
 I $P($G(MSG(LL)),"|")="NTE" D
"RTN","PSOHLNEW",66,0)
 .S ONEFLAG=1,WORDP=$S($P(MSG(LL),"|",2):$P(MSG(LL),"|",2),1:$P(MSG(LL),"|",3)) S:$P(MSG(LL),"|",4)'="" WPARRAY(WORDP,WPCT)=$P(MSG(LL),"|",4) S:$P(MSG(LL),"|",4)'="" WPCT=WPCT+1 F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNEW",67,0)
 ..I $G(MSG(LL,LLL))'="" S WPARRAY(WORDP,WPCT)=$G(MSG(LL,LLL)),WPCT=WPCT+1
"RTN","PSOHLNEW",68,0)
 I ONEFLAG S LL=LL+1 I $P($G(MSG(LL)),"|")="NTE" D NTE^PSOHLNE1
"RTN","PSOHLNEW",69,0)
 K WORDP
"RTN","PSOHLNEW",70,0)
 Q
"RTN","PSOHLNEW",71,0)
RXR I $P($P(PSOSEG,"|"),"^",4) S ROUTE(RRX)=$P($P(PSOSEG,"|"),"^",4) S RRX=RRX+1
"RTN","PSOHLNEW",72,0)
 Q
"RTN","PSOHLNEW",73,0)
OBX I $O(MSG(ZZ,0)) D OBXX^PSOHLNE2 G OBXNTE
"RTN","PSOHLNEW",74,0)
 S OCOUNT=OCOUNT+1
"RTN","PSOHLNEW",75,0)
 S OBXAR(OCOUNT,1)=$P(PSOSEG,"|",5)
"RTN","PSOHLNEW",76,0)
OBXNTE ;
"RTN","PSOHLNEW",77,0)
 S LL=ZZ+1,PSOBCT=2
"RTN","PSOHLNEW",78,0)
 I $P($G(MSG(LL)),"|")="NTE" D
"RTN","PSOHLNEW",79,0)
 .I $P(MSG(LL),"|",4)'="" S PSOBCT=3,OBXAR(OCOUNT,2)=$P(MSG(LL),"|",4)
"RTN","PSOHLNEW",80,0)
 .F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNEW",81,0)
 ..I $P($G(MSG(LL,LLL)),"|",4)'="" S OBXAR(OCOUNT,PSOBCT)=$P(MSG(LL,LLL),"|",4),PSOBCT=PSOBCT+1
"RTN","PSOHLNEW",82,0)
 Q
"RTN","PSOHLNEW",83,0)
ZRN S PSODSC=1_"^"_$P(PSOSEG,"|",2)
"RTN","PSOHLNEW",84,0)
 I $O(MSG(ZZ,0)) F T=0:0 S T=$O(MSG(ZZ,T)) Q:'T  S PSODSC(T)=MSG(ZZ,T)
"RTN","PSOHLNEW",85,0)
 K T
"RTN","PSOHLNEW",86,0)
 Q
"RTN","PSOHLNEW",87,0)
 ;
"RTN","PSOHLNEW",88,0)
ZRX D ZRX^PSOHLNE1
"RTN","PSOHLNEW",89,0)
 Q
"RTN","PSOHLNEW",90,0)
 ;
"RTN","PSOHLNEW",91,0)
ZCL D ZCL^PSOHLNE1
"RTN","PSOHLNEW",92,0)
 Q
"RTN","PSOHLNEW",93,0)
ZSC D CP^PSOHLNE1
"RTN","PSOHLNEW",94,0)
 Q
"RTN","PSOHLNEW",95,0)
NFILE ;
"RTN","PSOHLNEW",96,0)
 I $G(PSODSC) D ^PSONVNEW Q  ;adds non-va med to #55
"RTN","PSOHLNEW",97,0)
 ;
"RTN","PSOHLNEW",98,0)
 K DD,DO,DIC S DLAYGO="52.41",DIC="^PS(52.41,",DIC(0)="L",X=PLACER,DIC("DR")="1////"_DFN_";2////"_PSOOC_";6////"_$G(EFFECT)_";12////"_$G(PSOXQTY)_";25////"_$G(PRIOR)
"RTN","PSOHLNEW",99,0)
 S DIC("DR")=DIC("DR")_";22////"_$G(PSORSO)_";22.1////"_$G(PREV)_";19////"_$G(ROUTING)_";17////"_$G(SERV)_";7////"_$G(NATURE)_";13////"_$G(PSOREFIL)_";1.1////"_$G(LOCATION)_";117////"_$G(DSIG)
"RTN","PSOHLNEW",100,0)
 D FILE^DICN K DIC,DR I Y<0 Q
"RTN","PSOHLNEW",101,0)
 S PENDING=+Y
"RTN","PSOHLNEW",102,0)
 S $P(^PS(52.41,PENDING,0),"^",4)=$S($G(ENTERED):+$G(ENTERED),1:""),$P(^(0),"^",5)=$S($G(PROV):+$G(PROV),1:""),$P(^(0),"^",8)=$S($G(PSORDITE):+$G(PSORDITE),1:""),$P(^(0),"^",9)=$S($G(PSODDRUG):+$G(PSODDRUG),1:""),$P(^(0),"^",15)=$G(ROUTE)
"RTN","PSOHLNEW",103,0)
 S ^PS(52.41,PENDING,"IBQ")=$G(PSOIBY)
"RTN","PSOHLNEW",104,0)
 I $G(PSODYSPL)'="",$E(PSODYSPL)?1A S PSODYSPL=$E(PSODYSPL,2,$L(PSODYSPL))
"RTN","PSOHLNEW",105,0)
 S $P(^PS(52.41,PENDING,"INI"),"^")=$G(PSINPTR),$P(^(0),"^",12)=$G(PSOLOG),$P(^(0),"^",22)=$G(PSODYSPL)
"RTN","PSOHLNEW",106,0)
 I $G(QCOUNT) S ^PS(52.41,PENDING,1,0)="^52.413^"_QCOUNT_"^"_QCOUNT
"RTN","PSOHLNEW",107,0)
 S PSOQWX=$G(PSODDRUG) D:'$G(PSOQWX) OID^PSOHLNE1
"RTN","PSOHLNEW",108,0)
 F PP=0:0 S PP=$O(Q1I(PP)) Q:'PP  S ^PS(52.41,PENDING,1,PP,0)=$S($G(PSOQWX)&($G(PSOLQ1II(PP))):Q1I(PP),$G(PSOQWX)&($G(PSOLQ1IX(PP))'="")&('$G(PSOLQ1II(PP))):PSOLQ1IX(PP),1:PSOLQ1I(PP))
"RTN","PSOHLNEW",109,0)
 F EE=0:0 S EE=$O(QTARRAY(EE)) Q:'EE  S ^PS(52.41,PENDING,1,EE,1)=QTARRAY(EE),^PS(52.41,PENDING,1,EE,2)=$S($G(PSOQWX)&($G(PSOLQ1II(EE))):$G(QTARRAY2(EE)),$G(PSOQWX)&($G(PSOLQ1IX(EE))'="")&('$G(PSOLQ1II(EE))):PSOLQ1IX(EE),1:$G(PSOLQ1I(EE))) D
"RTN","PSOHLNEW",110,0)
 .S $P(^PS(52.41,PENDING,1,EE,1),"^",8)=+$G(ROUTE(EE))
"RTN","PSOHLNEW",111,0)
 S:$P($G(^PS(52.41,PENDING,1,1,1)),"^",3) $P(^PS(52.41,PENDING,0),"^",18)=$E($P($G(^PS(52.41,PENDING,1,1,1)),"^",3),1,7)
"RTN","PSOHLNEW",112,0)
 D STUFF^PSOHLNE2
"RTN","PSOHLNEW",113,0)
 D ^PSOHLPII
"RTN","PSOHLNEW",114,0)
 S LL=0 I $O(WPARRAY(6,0)) F LLL=0:0 S LLL=$O(WPARRAY(6,LLL)) Q:'LLL  S LL=LL+1 S ^PS(52.41,PENDING,3,LL,0)=$G(WPARRAY(6,LLL))
"RTN","PSOHLNEW",115,0)
 I LL S ^PS(52.41,PENDING,3,0)="^52.42^"_LL_"^"_LL
"RTN","PSOHLNEW",116,0)
 S LL=0 I $O(WPARRAY(7,0)) F LLL=0:0 S LLL=$O(WPARRAY(7,LLL)) Q:'LLL  S LL=LL+1 S ^PS(52.41,PENDING,"INS1",LL,0)=$G(WPARRAY(7,LLL))
"RTN","PSOHLNEW",117,0)
 I LL S ^PS(52.41,PENDING,"INS1",0)="^^"_LL_"^"_LL_"^"_$G(DT)_"^"
"RTN","PSOHLNEW",118,0)
 I $P($G(^PS(50.7,+$G(PSORDITE),"INS")),"^")'="" S $P(^PS(52.41,PENDING,"INS"),"^",2)=$S($O(^PS(52.41,PENDING,"INS1",0)):1,1:0)
"RTN","PSOHLNEW",119,0)
 I $G(OCOUNT) S ^PS(52.41,PENDING,"OBX",0)="^52.4118A^"_OCOUNT_"^"_OCOUNT F OCOUNT=1:1:OCOUNT D
"RTN","PSOHLNEW",120,0)
 .S ^PS(52.41,PENDING,"OBX",OCOUNT,0)=$G(OBXAR(OCOUNT,1))
"RTN","PSOHLNEW",121,0)
 .D USER^PSOORFI2(+$G(PROV)) S ^PS(52.41,PENDING,"OBX",OCOUNT,1)=USER1 K USER1
"RTN","PSOHLNEW",122,0)
 .S PSOBCT=1 F LLL=2:1 Q:'$D(OBXAR(OCOUNT,LLL))  S ^PS(52.41,PENDING,"OBX",OCOUNT,2,PSOBCT,0)=OBXAR(OCOUNT,LLL),^PS(52.41,PENDING,"OBX",OCOUNT,2,0)="^^"_PSOBCT_"^"_PSOBCT_"^"_$G(DT)_"^"
"RTN","PSOHLNEW",123,0)
 D ^PSOHLPIS
"RTN","PSOHLNEW",124,0)
 K DIK S DIK="^PS(52.41,",DA=PENDING D IX^DIK
"RTN","PSOHLNEW",125,0)
 I $G(PSOOC)="RNW",$G(PREV),$D(^PSRX(+$G(PREV),0)) D EN^PSOHLSN1(PREV,"SC","ZZ","")
"RTN","PSOHLNEW",126,0)
 S PSOMSORR=1,IPPLACER=$P($G(^PS(52.41,PENDING,0)),"^") I IPPLACER D
"RTN","PSOHLNEW",127,0)
 .I '$G(XOFLAG) D EN^PSOHLSN(IPPLACER,"OK","IP") Q
"RTN","PSOHLNEW",128,0)
 .D EN^PSOHLSN(IPPLACER,"XR","IP") I $G(PFLAG) D DCP^PSOHLSN Q
"RTN","PSOHLNEW",129,0)
 .K PSOMSORR I $D(^PSRX(+$G(PREV),0)) D  D EN^PSOHLSN1(PREV,"RP","","","A")
"RTN","PSOHLNEW",130,0)
 ..S $P(^PSRX(PREV,"STA"),"^")=15,$P(^PSRX(PREV,3),"^",5)=DT,$P(^PSRX(PREV,3),"^",10)=$P(^PSRX(PREV,3),"^")  ;;PSO*7*249
"RTN","PSOHLNEW",131,0)
 ..D REVERSE^PSOBPSU1(PREV,,"DC",7),CAN^PSOTPCAN(PREV),CAN^PSOUTL(PREV)
"RTN","PSOHLNEW",132,0)
 ..D CNT^PSOHLNE1
"RTN","PSOHLNEW",133,0)
 ..D:$G(^PS(52.41,PENDING,1,1,0))=""&($P($G(^PS(52.41,PENDING,1,1,1)),"^")="")&($G(^PS(52.41,PENDING,"SIG",1,0))="")
"RTN","PSOHLNEW",134,0)
 ...N FSIG,BSIG
"RTN","PSOHLNEW",135,0)
 ...I '$P($G(^PSRX(PREV,"SIG")),"^",2),$P($G(^("SIG")),"^")'="" D
"RTN","PSOHLNEW",136,0)
 ....D EN3^PSOUTLA1(PREV,70)
"RTN","PSOHLNEW",137,0)
 ....I $G(BSIG(1))'="" S ^PS(52.41,PENDING,"SIG",1,0)=$G(BSIG(1)) I $O(BSIG(1)) F EE=1:0 S EE=$O(BSIG(EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",EE,0)=$G(BSIG(EE))
"RTN","PSOHLNEW",138,0)
 ...I $P($G(^PSRX(PREV,"SIG")),"^",2),$G(^PSRX(PREV,"SIG1",1,0))'="" D
"RTN","PSOHLNEW",139,0)
 ....D FSIG^PSOUTLA("R",PREV,70)
"RTN","PSOHLNEW",140,0)
 ....I $G(FSIG(1))'="" S ^PS(52.41,PENDING,"SIG",1,0)=$G(FSIG(1)) I $O(FSIG(1)) F EE=1:0 S EE=$O(FSIG(EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",EE,0)=$G(FSIG(EE))
"RTN","PSOHLNEW",141,0)
 ...F EE=0:0 S EE=$O(^PS(52.41,PENDING,"SIG",EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",0)="^52.4124A^"_EE_"^"_EE
"RTN","PSOHLNEW",142,0)
 D CSET^PSODIAG
"RTN","PSOHLNEW",143,0)
 Q
"RTN","PSOHLNEW",144,0)
SPDFN S PDFN=$P($G(MSG(OO)),"|",4) Q
"RTN","PSOHLNEW",145,0)
KL K PSOPLC,PSOFFL,PSOSND
"RTN","PSOHLNEW",146,0)
 Q
"RTN","PSOHLNEW",147,0)
FILL ;
"RTN","PSOHLNEW",148,0)
 S (PSOFILNM,OR("PSOFILNM"))=$P($P(MSG(OO),"|",4),"^")
"RTN","PSOHLNEW",149,0)
 Q
"RTN","PSOORED1")
0^4^B67707631^B67696730
"RTN","PSOORED1",1,0)
PSOORED1 ;ISC-BHAM/SAB - edit orders from backdoor ;6/30/06 10:21am
"RTN","PSOORED1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,23,46,78,114,117,131,146,223,148,244,249**;DEC 1997;Build 9
"RTN","PSOORED1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORED1",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED1",5,0)
 ;
"RTN","PSOORED1",6,0)
 ;*244 call to remove DC'd Rx's from Rx ien strings
"RTN","PSOORED1",7,0)
 ;
"RTN","PSOORED1",8,0)
EN(PSORENW) ;
"RTN","PSOORED1",9,0)
 N LST,ORD,ORN K VALMBCK,PSORX("FN") S PSOAC=1,(PSORX("QFLG"),PSORX("DFLG"))=0 ;D DREN^PSOORNW2,INIT
"RTN","PSOORED1",10,0)
 D INIT
"RTN","PSOORED1",11,0)
 D @$S($P(PSOPAR,"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN")
"RTN","PSOORED1",12,0)
 I '$D(PSONEW("RX #")),'$P(PSOPAR,"^",7) D PAUSE^VALM1 K VALMSG,PSONEW("QFLG") S VALMBCK="Q" Q
"RTN","PSOORED1",13,0)
 I '$D(PSONEW("RX #")) K VALMSG D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" Q
"RTN","PSOORED1",14,0)
 S PSORENW("RX #")=PSONEW("RX #") I '$P(PSOPAR,"^",7) D  Q:$G(PSONEW("DFLG"))!($G(PSONEW("QFLG")))
"RTN","PSOORED1",15,0)
 .S PSOX=PSORENW("RX #") D CHECK^PSONRXN
"RTN","PSOORED1",16,0)
 I $G(PSONEW("DFLG"))!$G(PSONEW("QFLG")) D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" K PSORENW Q
"RTN","PSOORED1",17,0)
 D EN^PSOORNE1(.PSORENW) I '$G(PSORX("FN")) D:$P($G(PSOPAR),"^",7)=1  S VALMBCK="Q" Q
"RTN","PSOORED1",18,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOY=$O(PSONEW("OLD LAST RX#","")),PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORED1",19,0)
 .L +^PS(59,+PSOSITE,PSOY):0
"RTN","PSOORED1",20,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORED1",21,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORED1",22,0)
 .I $D(PSONEW("RX #")) L -^PSRX("B",PSONEW("RX #"))
"RTN","PSOORED1",23,0)
 .K PSOX,PSOY Q
"RTN","PSOORED1",24,0)
 Q:$G(COPY)
"RTN","PSOORED1",25,0)
TRY S $P(^PSRX(PSORENW("OIRXN"),"STA"),"^")=15,DA=PSORENW("OIRXN")
"RTN","PSOORED1",26,0)
 S $P(^PSRX(DA,3),"^",5)=DT,$P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^")
"RTN","PSOORED1",27,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7),CAN^PSOTPCAN(DA)
"RTN","PSOORED1",28,0)
 D RMP^PSOCAN3                ;*244
"RTN","PSOORED1",29,0)
 ;cancel/discontinue action
"RTN","PSOORED1",30,0)
 S PHARM="",STAT="RP",COMM="Prescription discontinued due to editing." D EN^PSOHLSN1(DA,STAT,PHARM,COMM,PSONOOR) K STAT,PHARM,COMM
"RTN","PSOORED1",31,0)
 S ACOM="Discontinued due to editing. New Rx created "_$P(^PSRX(PSORENW("IRXN"),0),"^")_"."
"RTN","PSOORED1",32,0)
 I $G(^PSRX(DA,"H"))]"" D
"RTN","PSOORED1",33,0)
 .I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")=16) D
"RTN","PSOORED1",34,0)
 ..S DIE=52,DR="22///"_$P(^PSRX(DA,3),"^") D ^DIE S ACOM="Discontinued due to editing while on hold. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)
"RTN","PSOORED1",35,0)
 ..S ^PSRX(DA,"H")=""
"RTN","PSOORED1",36,0)
 S RXDA=DA,(DA,SUSDA)=$O(^PS(52.5,"B",RXDA,0)) D:DA
"RTN","PSOORED1",37,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOORED1",38,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM="Discontinued due to editing while suspended."
"RTN","PSOORED1",39,0)
 .I $O(^PSRX(RXDA,1,0)) S DA=RXDA D:'$G(^PS(52.5,+SUSDA,"P")) REF^PSOCAN2
"RTN","PSOORED1",40,0)
 .S DA=SUSDA,DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORED1",41,0)
 K SUSD,SUSDA S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) D
"RTN","PSOORED1",42,0)
 .S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOORED1",43,0)
 .S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOORED1",44,0)
 .D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1),^PSRX(DA,"A",ACNT+1,0)=%_"^C^"_DUZ_"^"_RFCNT_"^"_$G(ACOM)
"RTN","PSOORED1",45,0)
 .I $G(PSOOIFLG),'$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item Edited."
"RTN","PSOORED1",46,0)
 .I '$G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Medication Route/Schedule Edited."
"RTN","PSOORED1",47,0)
 .I $G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item and Medication Route/Schedule Edited."
"RTN","PSOORED1",48,0)
 .S REA="C" D EXP^PSOHELP1
"RTN","PSOORED1",49,0)
 I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOORED1",50,0)
 Q
"RTN","PSOORED1",51,0)
INS K X,QUIT,Y,DIR,DIRUT,DUOUT,DTOUT,DIC,INSDEL,UPMI,^TMP($J,"INS1")
"RTN","PSOORED1",52,0)
 I '$O(^PSRX(PSORXED("IRXN"),6,0)),'$O(PSORXED("DOSE",0)) D UPMI Q:$G(QUIT)  ;G INS1
"RTN","PSOORED1",53,0)
 I $G(^PSRX(PSORXED("IRXN"),"INS"))]"" S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS") K UPMI G INS1
"RTN","PSOORED1",54,0)
 K DD,GG F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S DD=$G(DD)+1
"RTN","PSOORED1",55,0)
 I $G(DD)=1 S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS1",$O(^PSRX(PSORXED("IRXN"),"INS1",0)),0) K UPMI,DD G INS1
"RTN","PSOORED1",56,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D  G INSX
"RTN","PSOORED1",57,0)
 .F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S ^TMP($J,"INS1",I,0)=^PSRX(PSORXED("IRXN"),"INS1",I,0)
"RTN","PSOORED1",58,0)
 .S ^TMP($J,"INS1",0)=^PSRX(PSORXED("IRXN"),"INS1",0)
"RTN","PSOORED1",59,0)
 .S DIC="^TMP($J,""INS1"",",DWPK=2,DWLW=80 D EN^DIWE I $G(X)="^" K ^TMP($J,"INS1") Q
"RTN","PSOORED1",60,0)
 .I '$O(^TMP($J,"INS1",0)) S INSDEL=1
"RTN","PSOORED1",61,0)
 .S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED1",62,0)
INS1 K Y,DIR,DIRUT,DUOUT,DTOUT,DIC,X
"RTN","PSOORED1",63,0)
 I $G(UPMI) K UPMI I $G(^PS(50.7,PSODRUG("OI"),"INS"))]"" S PSORXED("FLD",114)=^PS(50.7,PSODRUG("OI"),"INS")
"RTN","PSOORED1",64,0)
 S:$G(PSORXED("FLD",114))]"" DIR("B")=PSORXED("FLD",114)
"RTN","PSOORED1",65,0)
 S DIR("?")="Enter Quick codes or Free Text",DIR(0)="52,114" D ^DIR
"RTN","PSOORED1",66,0)
 I $D(DTOUT)!($D(DUOUT))!($G(PSORXED("FLD",114))=X) K PSORXED("FLD",114) G INSX
"RTN","PSOORED1",67,0)
 I X'="",X'="@" D SIG^PSOHELP G INS1:'$D(X)
"RTN","PSOORED1",68,0)
 S PSORXED("FLD",114)=X
"RTN","PSOORED1",69,0)
 I $G(INS1)]"" W " ("_$E(INS1,2,9999999)_")"
"RTN","PSOORED1",70,0)
 G:(X']""!(X="@")) INSX
"RTN","PSOORED1",71,0)
 S (PSORXED("INS"),PSORXED("SIG",1))=$E(INS1,2,9999999) D EN^PSOFSIG(.PSORXED)
"RTN","PSOORED1",72,0)
INSX I $P($G(^PS(55,PSODFN,"LAN")),"^") K DIR D
"RTN","PSOORED1",73,0)
 .I $G(^PSRX(PSORXED("IRXN"),"INSS"))]"" S PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORED1",74,0)
 .D SINS^PSODIR(.PSORXED) I $G(PSORXED("SINS"))']"" K ^PSRX(PSORXED("IRXN"),"INSS") Q
"RTN","PSOORED1",75,0)
 .S PSORXED("FLD",114.1)=PSORXED("SINS")
"RTN","PSOORED1",76,0)
 K DIRUT,DUOUT,DTOUT,DIR,X,Y,DIC,DWPK
"RTN","PSOORED1",77,0)
 Q
"RTN","PSOORED1",78,0)
INIT ;setup psorenw array
"RTN","PSOORED1",79,0)
 S PSORENW("RX0")=^PSRX(PSORENW("IRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN"))
"RTN","PSOORED1",80,0)
 I $G(PSOSIGFL),$G(PSORX("SIG"))]"" S PSORENW("SIG")=PSORX("SIG"),SIGOK=0
"RTN","PSOORED1",81,0)
 E  D
"RTN","PSOORED1",82,0)
 .I '$P($G(^PSRX(PSORENW("IRXN"),"SIG")),"^",2) S PSORENW("SIG")=$P($G(^("SIG")),"^")
"RTN","PSOORED1",83,0)
 .E  D
"RTN","PSOORED1",84,0)
 ..S SIGOK=1 Q:$O(SIG(0))
"RTN","PSOORED1",85,0)
 ..S D=0 F I=0:0 S D=D+1,I=$O(^PSRX(PSORENW("IRXN"),"SIG1",I)) Q:'I  S SIG(D)=^PSRX(PSORENW("IRXN"),"SIG1",I,0)
"RTN","PSOORED1",86,0)
 ..K PSOX1,D
"RTN","PSOORED1",87,0)
 S PSORENW("OIRXN")=PSORENW("IRXN")
"RTN","PSOORED1",88,0)
 S PSORENW("PROVIDER")=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:$P(PSORENW("RX0"),"^",4))
"RTN","PSOORED1",89,0)
 S (PSORENW("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSOORED1",90,0)
 I $P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",7),$P($G(^("PS")),"^",8) S PSORENW("COSIGNING PROVIDER")=$P($G(^("PS")),"^",8)
"RTN","PSOORED1",91,0)
 S PSORENW("CLINIC")=$S($G(PSORENW("CLINIC")):PSORENW("CLINIC"),1:$P(PSORENW("RX0"),"^",5))
"RTN","PSOORED1",92,0)
 S PSORENW("REMARKS")="New Order Created by "_$S($G(COPY)&('$G(PSOEDIT)):"copying",1:"editing")_" Rx # "_$P(PSORENW("RX0"),"^")_"."
"RTN","PSOORED1",93,0)
 S PSORENW("COSIGNER")=$S($G(PSORENW("COSIGNER")):PSORENW("COSIGNER"),$P(PSORENW("RX3"),"^",3):$P(PSORENW("RX3"),"^",3),1:"")
"RTN","PSOORED1",94,0)
 K:PSORENW("COSIGNER")="" PSORENW("COSIGNER")
"RTN","PSOORED1",95,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSOORED1",96,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSOORED1",97,0)
 S:$G(PSODRUG("IEN")) PSORENW("DRUG IEN")=PSODRUG("IEN")
"RTN","PSOORED1",98,0)
 I $G(PSORENW("DAYS SUPPLY")) G QTY
"RTN","PSOORED1",99,0)
 S PSORENW("DAYS SUPPLY")=$S($D(CLOZPAT):7,1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",100,0)
QTY S PSORENW("QTY")=$S($G(PSORENW("QTY")):PSORENW("QTY"),1:$P(PSORENW("RX0"),"^",7))
"RTN","PSOORED1",101,0)
RFN S PSORENW("# OF REFILLS")=$S($D(CLOZPAT):0,$G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSOORED1",102,0)
 S (PSOID,Y,PSORENW("FILL DATE"),PSORENW("ISSUE DATE"))=DT
"RTN","PSOORED1",103,0)
 S:PSORENW("CLINIC") PSORX("CLINIC")=$P(^SC(+PSORENW("CLINIC"),0),"^")
"RTN","PSOORED1",104,0)
 S PSORENW("PATIENT STATUS")=$S($G(PSORENW("PATIENT STATUS")):PSORENW("PATIENT STATUS"),'$P(PSORENW("RX0"),"^",3):$G(^PS(55,PSORENW("PSODFN"),"PS")),1:$P(PSORENW("RX0"),"^",3))
"RTN","PSOORED1",105,0)
 S PSORENW("PTST NODE")=$G(^PS(53,PSORENW("PATIENT STATUS"),0))
"RTN","PSOORED1",106,0)
 S PSDAYS=$S($G(PSORENW("DAYS SUPPLY")):PSORENW("DAYS SUPPLY"),'$P(PSORENW("RX0"),"^",8):$P(PSORENW("PTST NODE"),"^",3),1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",107,0)
 I $G(PSODRUG("IEN")) S DREN=PSODRUG("IEN"),POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORED1",108,0)
 D:$G(PSORENW("# OF REFILLS"))']"" RF
"RTN","PSOORED1",109,0)
 S PSORENW("MAIL/WINDOW")=$S($G(PSORENW("MAIL/WINDOW"))]"":PSORENW("MAIL/WINDOW"),1:$P(PSORENW("RX0"),"^",11))
"RTN","PSOORED1",110,0)
 S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="W":"WINDOW",1:"MAIL")
"RTN","PSOORED1",111,0)
 S PSORENW("COPIES")=$S($G(PSORENW("COPIES")):PSORENW("COPIES"),$P(PSORENW("RX0"),"^",18):$P(PSORENW("RX0"),"^",18),1:1)
"RTN","PSOORED1",112,0)
 S PSORENW("CLERK CODE")=DUZ
"RTN","PSOORED1",113,0)
 S:$G(PSORX("CLERK CODE"))']"" PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^")
"RTN","PSOORED1",114,0)
 Q:$D(COPY)  S PSORENW("ENT")=0 ;Q:$G(PSOSIGFL)!($D(COPY))
"RTN","PSOORED1",115,0)
 K PSORENW("ENT") F I=0:0 S I=$O(PSORENW("DOSE",I)) Q:'I  S PSORENW("ENT")=$G(PSORENW("ENT"))+1
"RTN","PSOORED1",116,0)
 I $O(^TMP($J,"INS1",0)) D
"RTN","PSOORED1",117,0)
 .K PSORXED("SIG"),DD
"RTN","PSOORED1",118,0)
 .F I=0:0 S I=$O(^TMP($J,"INS1",I)) Q:'I  S PSORENW("SIG",I)=^TMP($J,"INS1",I,0)
"RTN","PSOORED1",119,0)
 .K ^TMP($J,"INS1")
"RTN","PSOORED1",120,0)
 I $G(^PSRX(PSORENW("IRXN"),"INS"))]"" S PSORENW("INS")=^PSRX(PSORENW("IRXN"),"INS")
"RTN","PSOORED1",121,0)
 I $G(^PSRX(PSORENW("IRXN"),"INSS"))]"" S PSORENW("SINS")=^PSRX(PSORENW("IRXN"),"INSS")
"RTN","PSOORED1",122,0)
 I '$G(PSORENW("ENT")),'$G(PSOSIGFL) D DOLST1^PSOORED3(.PSORENW) S PSORENW("ENT")=+$G(OLENT)
"RTN","PSOORED1",123,0)
 Q
"RTN","PSOORED1",124,0)
RF ;# of refills
"RTN","PSOORED1",125,0)
 S PTRF=$S($P(PSORENW("PTST NODE"),"^",4)]"":$P(PSORENW("PTST NODE"),"^",4),1:11)
"RTN","PSOORED1",126,0)
 S CS=0 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S CS=1
"RTN","PSOORED1",127,0)
 I CS D
"RTN","PSOORED1",128,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOX=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOORED1",129,0)
 .S PSOX=$S('PSOX:0,PSDAYS=90:1,1:PSOX),PSDY1=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0) S PSORENW("# OF REFILLS")=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORED1",130,0)
 E  D
"RTN","PSOORED1",131,0)
 .S PSOX1=PTRF,PSOX=$S(PSOX1=11:11,1:PSOX1),PSOX=$S('PSOX:0,PSDAYS=90:3,1:PSOX)
"RTN","PSOORED1",132,0)
 .S PSDY1=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0) S PSORENW("# OF REFILLS")=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORED1",133,0)
 I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F") S PSORENW("# OF REFILLS")=0
"RTN","PSOORED1",134,0)
 K PSDY,PSDY1,PTRF,PSOX,PSOX1,PSDAYS,CS
"RTN","PSOORED1",135,0)
 Q
"RTN","PSOORED1",136,0)
UPMI ;add dosing data for pre-poe rxs
"RTN","PSOORED1",137,0)
 W !! K PSONEW("DFLG"),DIR,DIRUT,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Dosing Instructions Are Missing!! Do You Want to Add Them"
"RTN","PSOORED1",138,0)
 D ^DIR I 'Y!($D(DIRUT)) S QUIT=1 K DIR,DIRUT,DUOT,DUOUT Q
"RTN","PSOORED1",139,0)
 S UPMI=1,EDTHLD=$G(PSORX("EDIT")) K PSORX("EDIT")
"RTN","PSOORED1",140,0)
 D DOSE1^PSOORED5(.PSORXED) S (PSORXED,PSORX("EDIT"))=EDTHLD K EDTHLD I $G(PSONEW("DFLG")) S QUIT=1
"RTN","PSOORED1",141,0)
 Q
"RTN","PSOORED3")
0^14^B56356282^B55877013
"RTN","PSOORED3",1,0)
PSOORED3 ;BIR/SAB-edit finished orders through backdoor ; 10/20/06 11:09am
"RTN","PSOORED3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**46,78,99,117,133,148,249**;DEC 1997;Build 9
"RTN","PSOORED3",3,0)
 ;External reference to PS(51.2 supported by DBIA 2226
"RTN","PSOORED3",4,0)
 ;called from psoored2
"RTN","PSOORED3",5,0)
 D DOLST
"RTN","PSOORED3",6,0)
 ;
"RTN","PSOORED3",7,0)
DOSE ;adds dosing info
"RTN","PSOORED3",8,0)
 I '$G(PSORXED("ENT")) F  S I=$O(PSORXED("DOSE",I)) Q:'I  S PSORXED("ENT")=$G(PSORXED("ENT"))+1
"RTN","PSOORED3",9,0)
 K ROU,UNITN,STRE,PSODOSE,RTE,NOUN,VERB M PSODOSE=PSORXED
"RTN","PSOORED3",10,0)
 D KV K FIELD,DOSEOR,DOOR,X,Y,UNITS S ENT=1
"RTN","PSOORED3",11,0)
ASK S ROU="PSOORED3" D ASK^PSOBKDED K ROU I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",12,0)
 G:$D(DIRUT) EXQ
"RTN","PSOORED3",13,0)
 I $G(QUIT)]"" K QUIT,ROU Q
"RTN","PSOORED3",14,0)
 ;
"RTN","PSOORED3",15,0)
 I $G(VERB)]"" S PSORXED("VERB",ENT)=VERB G DUPD
"RTN","PSOORED3",16,0)
VER D VER^PSOOREDX I X[U,$L(X)>1 S FIELD="VER" G JUMP
"RTN","PSOORED3",17,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",18,0)
 I X="@" K PSORXED("VERB",ENT),VERB G DUPD
"RTN","PSOORED3",19,0)
 S:X'="" (PSORXED("VERB",ENT),VERB)=X
"RTN","PSOORED3",20,0)
DUPD ;
"RTN","PSOORED3",21,0)
 I $G(PSORXED("DOSE",ENT))'?.N&($G(PSORXED("DOSE",ENT))'?.N1".".N)!'DOSE("LD") K PSORXED("DOSE ORDERED",ENT),DUPD G NOU1
"RTN","PSOORED3",22,0)
 D DUPD^PSOOREDX
"RTN","PSOORED3",23,0)
 S DIR("B")=$S($G(PSORXED("DOSE ORDERED",ENT))]"":PSORXED("DOSE ORDERED",ENT),1:"") S:$E($G(DIR("B")),1)="." DIR("B")="0"_$G(DIR("B")) K:DIR("B")="" DIR("B")
"RTN","PSOORED3",24,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUPD" G JUMP
"RTN","PSOORED3",25,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",26,0)
 I X="@"!(X=0) W !,"Dispense Units Per Dose is Required!!",! G DUPD
"RTN","PSOORED3",27,0)
 D STR^PSOOREDX
"RTN","PSOORED3",28,0)
NOU1 G:'$G(PSORXED("DOSE ORDERED",ENT)) RTE
"RTN","PSOORED3",29,0)
 D CNON
"RTN","PSOORED3",30,0)
 N PSONDEF
"RTN","PSOORED3",31,0)
 I $G(NOUN)]"" S PSORXED("NOUN",ENT)=NOUN
"RTN","PSOORED3",32,0)
NOU D NOU^PSOOREDX I X[U,$L(X)>1 S FIELD="NOU" G JUMP
"RTN","PSOORED3",33,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",34,0)
 I X="@" K PSORXED("NOUN",ENT),NOUN G RTE
"RTN","PSOORED3",35,0)
 I X'="",$G(PSONDEF)="" S NOUN=X
"RTN","PSOORED3",36,0)
 I X'="",$G(PSONDEF)'=X S NOUN=X
"RTN","PSOORED3",37,0)
 S:X'="" PSORXED("NOUN",ENT)=X
"RTN","PSOORED3",38,0)
RTE S:$G(PSORXED("ROUTE",ENT))']"" DRET=1
"RTN","PSOORED3",39,0)
 K JUMP S ROU="PSOORED3" D RTE^PSOBKDED K ROU
"RTN","PSOORED3",40,0)
 I $G(JUMP) K JUMP G JUMP
"RTN","PSOORED3",41,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",42,0)
 I $G(QUIT) K QUIT,ROU Q
"RTN","PSOORED3",43,0)
 ;
"RTN","PSOORED3",44,0)
SCH D SCH^PSOBKDED I X[U,$L(X)>1 S FIELD="SCH" G JUMP
"RTN","PSOORED3",45,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",46,0)
 S SCH=Y D SCH^PSOSIG I $G(SCH)']"" G SCH
"RTN","PSOORED3",47,0)
 S PSORXED("SCHEDULE",ENT)=SCH W " ("_SCHEX_")" K SCH,SCHEX,X,Y,PSOSCH
"RTN","PSOORED3",48,0)
 S:PSORXED("ENT")<ENT PSORXED("ENT")=ENT
"RTN","PSOORED3",49,0)
 ;
"RTN","PSOORED3",50,0)
DUR D KV K EXP S DIR(0)="52.0113,4",DIR("A")="LIMITED DURATION (IN MONTHS, WEEKS, DAYS, HOURS OR MINUTES)"
"RTN","PSOORED3",51,0)
 S DIR("B")=$S($G(DUR)]"":DUR,$G(PSORXED("DURATION",ENT))]"":PSORXED("DURATION",ENT),1:"") K:DIR("B")="" DIR("B")
"RTN","PSOORED3",52,0)
 D ^DIR I X[U,$L(X)>1 S FIELD="DUR" G JUMP
"RTN","PSOORED3",53,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",54,0)
 D DUR1^PSOOREDX
"RTN","PSOORED3",55,0)
 ;
"RTN","PSOORED3",56,0)
CON D CON^PSOOREDX I X[U,$L(X)>1 S FIELD="CON" G JUMP
"RTN","PSOORED3",57,0)
 G:$D(DTOUT)!($D(DUOUT)) EXQ
"RTN","PSOORED3",58,0)
 I X="@",$G(PSORXED("CONJUNCTION",ENT))="" W !,?10,"Invalid Entry - nothing to delete!!" G CON
"RTN","PSOORED3",59,0)
 S:X'=""&(X'="@") PSORXED("CONJUNCTION",ENT)=Y
"RTN","PSOORED3",60,0)
 I X="@" D CON1^PSOOREDX G:$D(DIRUT) EXQ G:'Y CON N CKX S CKX=1 D UPD^PSOOREDX G CON
"RTN","PSOORED3",61,0)
 I $G(PSORXED("CONJUNCTION",ENT))]"" S ENT=ENT+1 K DIR G ASK
"RTN","PSOORED3",62,0)
 S DENT=$O(PSORXED("DOSE",ENT)) I DENT,(ENT+1)'=DENT D
"RTN","PSOORED3",63,0)
 .K PSORXED("DOSE",DENT),PSORXED("NOUN",DENT),PSORXED("VERB",DENT),PSORXED("DOSE ORDERED",DENT),PSORXED("ROUTE",DENT),PSORXED("ODOSE",DENT)
"RTN","PSOORED3",64,0)
 .K PSORXED("SCHEDULE",DENT),PSORXED("DURATION",DENT),PSORXED("CONJUNCTION",DENT),DENT
"RTN","PSOORED3",65,0)
 I $G(FIELD)]"" K FIELD S QUIT=1
"RTN","PSOORED3",66,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D
"RTN","PSOORED3",67,0)
 .F D=0:0 S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED3",68,0)
 D EN^PSOFSIG(.PSORXED) D VER^PSOORED7:'$G(PSOVER) I $G(CKX),'$G(PSOSIGFL) D M1 K CKX
"RTN","PSOORED3",69,0)
 I $G(PSOSIGFL)=1 S PSORXED("ENT")=ENT,SIGOK=1 G EX1
"RTN","PSOORED3",70,0)
 K QTY,QTYHLD S:$G(PSORXED("QTY")) QTYHLD=PSORXED("QTY") D QTY^PSOSIG(.PSORXED) I $G(PSORXED("QTY")) S QTY=1
"RTN","PSOORED3",71,0)
 I $G(QTYHLD),'$G(PSORXED("QTY")) S PSORXED("QTY")=QTYHLD
"RTN","PSOORED3",72,0)
 K QTYHLD Q:$G(PSOVER)!($G(PSOREEDQ))
"RTN","PSOORED3",73,0)
UDSIG I $O(SIG(0)) D
"RTN","PSOORED3",74,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSOORED3",75,0)
 .S (A,I)=0 F  S I=$O(^PSRX(PSORXED("IRXN"),"A",I)) Q:'I  S A=A+1
"RTN","PSOORED3",76,0)
 .D NOW^%DTC I $G(QTY) S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^Quantity Updated "_"("_$P(^PSRX(PSORXED("IRXN"),0),"^",7)_")",$P(^PSRX(PSORXED("IRXN"),0),"^",7)=$G(PSORXED("QTY")) K QTY
"RTN","PSOORED3",77,0)
 .S A=A+1,^PSRX(PSORXED("IRXN"),"A",A,0)=%_"^E^"_DUZ_"^0^New Dosing Instructions Added",^PSRX(PSORXED("IRXN"),"A",A,1)="ORIGINAL SIG^" D
"RTN","PSOORED3",78,0)
 ..I '$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^",2) S $P(^PSRX(PSORXED("IRXN"),"A",A,1),"^",2)=$P($G(^PSRX(PSORXED("IRXN"),"SIG")),"^") Q
"RTN","PSOORED3",79,0)
 ..F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"SIG1",I)) Q:'I  S ^PSRX(PSORXED("IRXN"),"A",A,2,I,0)=^PSRX(PSORXED("IRXN"),"SIG1",I,0),^PSRX(PSORXED("IRXN"),"A",A,2,0)="^52.34A^"_I_"^"_I
"RTN","PSOORED3",80,0)
 .S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",81,0)
 .K SIG,A,I
"RTN","PSOORED3",82,0)
 S ^PSRX(PSORXED("IRXN"),6,0)="^52.0113^"_ENT_"^"_ENT
"RTN","PSOORED3",83,0)
 F I=1:1:ENT S ^PSRX(PSORXED("IRXN"),6,I,0)=PSORXED("DOSE",I)_"^"_$G(PSORXED("DOSE ORDERED",I))_"^"_$G(PSORXED("UNITS",I))_"^"_$G(PSORXED("NOUN",I))_"^" D
"RTN","PSOORED3",84,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,0)=^PSRX(PSORXED("IRXN"),6,I,0)_$G(PSORXED("DURATION",I))_"^"_$G(PSORXED("CONJUNCTION",I))_"^"_$G(PSORXED("ROUTE",I))_"^"_$G(PSORXED("SCHEDULE",I))_"^"_$G(PSORXED("VERB",I))
"RTN","PSOORED3",85,0)
 .S ^PSRX(PSORXED("IRXN"),6,I,1)=$G(PSORXED("ODOSE",I))
"RTN","PSOORED3",86,0)
 S ^PSRX(PSORXED("IRXN"),"POE")=1
"RTN","PSOORED3",87,0)
 G EX
"RTN","PSOORED3",88,0)
 Q
"RTN","PSOORED3",89,0)
EX ;
"RTN","PSOORED3",90,0)
 K PSORXED("DOSE"),DOSE,DUPD,SCH,PSORXED("NOUN"),PSORXED("VERB"),VERB,NOUN,PSORXED("DOSE ORDERED"),DOSEOR,PSORXED("ROUTE"),ENT,PSORTE,SIG,PSODOSE
"RTN","PSOORED3",91,0)
 K PSORXED("SCHEDULE"),PSORXED("DURATION"),PSORXED("CONJUNCTION"),DURA,X,Y,PSORXED("ODOSE")
"RTN","PSOORED3",92,0)
EX1 K STRE,UNITN,DOSE,DUPD,SCH,VERB,NOUN,DOSEOR,RTE,DUR,X,Y,ENTS,PSOSCH,ERTE,ROU
"RTN","PSOORED3",93,0)
KV K DIR,DIRUT,DUOUT,DTOUT
"RTN","PSOORED3",94,0)
 Q
"RTN","PSOORED3",95,0)
EXQ K PSORXED,PSOSIGFL M PSORXED=PSODOSE D EN^PSOFSIG(.PSORXED) S PSORXED("DFLG")=1 D M1 G EX
"RTN","PSOORED3",96,0)
 Q
"RTN","PSOORED3",97,0)
M1 D M1^PSOOREDX
"RTN","PSOORED3",98,0)
 Q
"RTN","PSOORED3",99,0)
DOLST1(PSORXED) ;
"RTN","PSOORED3",100,0)
 ;
"RTN","PSOORED3",101,0)
DOLST F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),6,I)) Q:'I  S INST=^(I,0) D
"RTN","PSOORED3",102,0)
 .S PSORXED("DOSE",I)=$P(INST,"^"),PSORXED("DOSE ORDERED",I)=$P(INST,"^",2),PSORXED("UNITS",I)=$P(INST,"^",3),PSORXED("NOUN",I)=$P(INST,"^",4)
"RTN","PSOORED3",103,0)
 .I $P(INST,"^",5)]"" D
"RTN","PSOORED3",104,0)
 ..S PSORXED("DURATION",I)=$S($E($P(INST,"^",5),1)'?.N:$E($P(INST,"^",5),2,99)_$E($P(INST,"^",5),1),1:$P(INST,"^",5))
"RTN","PSOORED3",105,0)
 .S PSORXED("ROUTE",I)=$P(INST,"^",7),PSORXED("SCHEDULE",I)=$P(INST,"^",8)
"RTN","PSOORED3",106,0)
 .S PSORXED("CONJUNCTION",I)=$P(INST,"^",6),PSORXED("VERB",I)=$P(INST,"^",9),OLENT=I
"RTN","PSOORED3",107,0)
 .S PSORXED("ODOSE",I)=$G(^PSRX(PSORXED("IRXN"),6,I,1))
"RTN","PSOORED3",108,0)
 K:'$O(PSORXED("DOSE",0)) PSORXED("ENT"),OLENT
"RTN","PSOORED3",109,0)
 S PSORXED("INS")=$G(^PSRX(PSORXED("IRXN"),"INS"))
"RTN","PSOORED3",110,0)
 Q
"RTN","PSOORED3",111,0)
UPDSIG ;updates sig
"RTN","PSOORED3",112,0)
 K ^PSRX(PSORXED("IRXN"),"SIG1") S ^PSRX(PSORXED("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSOORED3",113,0)
 S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSORXED("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSORXED("IRXN"),"SIG1",0),"^",3)=+$P($G(^PSRX(PSORXED("IRXN"),"SIG1",0)),"^",3)+1,$P(^(0),"^",4)=+$P($G(^(0)),"^",4)+1
"RTN","PSOORED3",114,0)
 S ^PSRX(PSORXED("IRXN"),"SIG")="^1"
"RTN","PSOORED3",115,0)
 Q
"RTN","PSOORED3",116,0)
JUMP ;jump to fields
"RTN","PSOORED3",117,0)
 I $L($E(X,2,99))<3 W !,"Field Name Must Be At Least 3 Characters in Length",! G @FIELD
"RTN","PSOORED3",118,0)
 D FNM^PSOOREDX
"RTN","PSOORED3",119,0)
 I FLDNM']"" K X,NM,FLDNM W !,"INVALID FIELD NAME.  PLEASE TRY AGAIN!",! G @FIELD
"RTN","PSOORED3",120,0)
 F AR=1:1:PSORXED("ENT") W !,AR_". "_$P(FLDNM,"^",2)_": "_$S(NM="ROU"&($G(PSORXED($P(FLDNM,"^"),AR))):$P(^PS(51.2,PSORXED($P(FLDNM,"^"),AR),0),"^"),1:$G(PSORXED($P(FLDNM,"^"),AR))) S AR1=AR
"RTN","PSOORED3",121,0)
 D KV S DIR("A",1)="* Indicates which fields will create a New Order",DIR("A")="Select Field to Edit by number",DIR(0)="NO^1:"_AR1 D ^DIR G:$D(DIRUT) @FIELD
"RTN","PSOORED3",122,0)
 D JFN^PSOOREDX G:FLDNM="" @FIELD G @FLDNM
"RTN","PSOORED3",123,0)
 G EX
"RTN","PSOORED3",124,0)
 Q
"RTN","PSOORED3",125,0)
 ;
"RTN","PSOORED3",126,0)
CNON ;
"RTN","PSOORED3",127,0)
 I $G(NOUN)'="" Q
"RTN","PSOORED3",128,0)
 I '$G(PSORXED("DOSE ORDERED",ENT)) Q
"RTN","PSOORED3",129,0)
 N PSONLT,PSONLL,PSONLG
"RTN","PSOORED3",130,0)
 S PSONLL=$P($G(DOSE("DD",+$G(PSODRUG("IEN")))),"^",9) I PSONLL="" Q
"RTN","PSOORED3",131,0)
 S PSONLG=$L(PSONLL)
"RTN","PSOORED3",132,0)
 I PSONLG'>3 Q
"RTN","PSOORED3",133,0)
 S PSONLT=$E(PSONLL,(PSONLG-2),PSONLG)
"RTN","PSOORED3",134,0)
 I PSONLT'="(S)",PSONLT'="(s)" Q
"RTN","PSOORED3",135,0)
 ;test noun of (S)
"RTN","PSOORED3",136,0)
 K NOUN ; NOT SURE ABOUT THIS???
"RTN","PSOORED3",137,0)
 I $G(PSORXED("DOSE ORDERED",ENT))>1 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))_$E(PSONLT,2) Q
"RTN","PSOORED3",138,0)
 S PSORXED("NOUN",ENT)=$E(PSONLL,1,(PSONLG-3))
"RTN","PSOORED3",139,0)
 Q
"RTN","PSOORUTL")
0^2^B42538902^B42520369
"RTN","PSOORUTL",1,0)
PSOORUTL ;ISC BHAM/SAB  - updates order status from oerr ;02/22/95
"RTN","PSOORUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**14,46,146,132,118,199,223,148,249**;DEC 1997;Build 9
"RTN","PSOORUTL",3,0)
 ;External reference to EN^ORERR - 2187
"RTN","PSOORUTL",4,0)
 ;External reference to ^PS(55 - 2228
"RTN","PSOORUTL",5,0)
 ;Input variables, poerr("psofilnm")=pharmacy pointer # from OE/RR, poerr("stat")=Order Control status
"RTN","PSOORUTL",6,0)
 ;poerr("pharmst")=will contain 'ZE'if rx has expired, poerr("comm")=Comments, poerr("user")=Person placing request
"RTN","PSOORUTL",7,0)
EN(POERR) ;
"RTN","PSOORUTL",8,0)
 N PSZORS,III
"RTN","PSOORUTL",9,0)
 F OO=0:0 S OO=$O(MSG(OO)) Q:'OO  I $P(MSG(OO),"|")="ZRN" S NVA=1
"RTN","PSOORUTL",10,0)
 I $G(NVA) G NVA
"RTN","PSOORUTL",11,0)
 G:POERR("PSOFILNM")'["S" RXO S III=+POERR("PSOFILNM")
"RTN","PSOORUTL",12,0)
 S ORS=0 I $D(^PS(52.41,III,0)) D  G PEXIT
"RTN","PSOORUTL",13,0)
 .Q:$P($G(^PS(52.41,III,0)),"^",3)="RF"
"RTN","PSOORUTL",14,0)
 .I $G(PDFN),$P($G(^PS(52.41,III,0)),"^",2),PDFN'=$P(^PS(52.41,III,0),"^",2) S ORS=1
"RTN","PSOORUTL",15,0)
RXO S III=POERR("PSOFILNM") I $D(^PSRX(III,0)) D  G PEXIT
"RTN","PSOORUTL",16,0)
 .I $G(PDFN),$P($G(^PSRX(III,0)),"^",2),PDFN'=$P(^PSRX(III,0),"^",2) S ORS=1
"RTN","PSOORUTL",17,0)
 S (ORS,PSZORS)=1
"RTN","PSOORUTL",18,0)
PEXIT I $G(ORS) S POERR("STAT")=$S(POERR("STAT")="CA":"UC",POERR("STAT")="DC":"UD",POERR("STAT")="HD":"UH",1:"UR"),POERR("FILLER")="",POERR("COMM")=$S($G(PSZORS):"Unable to locate order.",1:"Patient does not match.") K ORS,PSZORS,III Q
"RTN","PSOORUTL",19,0)
 S POERR("PHARMST")="" G:POERR("STAT")="HD"!(POERR("STAT")="RL") HD
"RTN","PSOORUTL",20,0)
 S ORS=0 I POERR("PSOFILNM")["S" S DA=+POERR("PSOFILNM") I $D(^PS(52.41,DA,0)) D  G EXIT
"RTN","PSOORUTL",21,0)
 .Q:$P($G(^PS(52.41,DA,0)),"^",3)="RF"
"RTN","PSOORUTL",22,0)
 .S $P(^PS(52.41,DA,0),"^",3)="DC",POERR("PLACE")=$P(^(0),"^"),POERR("STAT")="CR",POERR("FILLER")=DA_"^P"
"RTN","PSOORUTL",23,0)
 .K ^PS(52.41,"AOR",+$P($G(^PS(52.41,DA,0)),"^",2),+$P($G(^PS(52.41,DA,"INI")),"^"),DA)
"RTN","PSOORUTL",24,0)
 .S:$G(POERR("COMM"))']"" POERR("COMM")="Order Canceled by OE/RR before finishing." S ORS=1,$P(^PS(52.41,DA,4),"^")=$G(POERR("COMM"))
"RTN","PSOORUTL",25,0)
 S DA=POERR("PSOFILNM") D:$D(^PSRX(DA,0)) REVERSE^PSOBPSU1(DA,,"DC",7)
"RTN","PSOORUTL",26,0)
 I $D(^PSRX(DA,0)) D  S $P(^PSRX(DA,"STA"),"^")=14,$P(^PSRX(DA,3),"^",5)=DT,$P(^PSRX(DA,3),"^",10)=$P(^PSRX(DA,3),"^") D CAN^PSOTPCAN(DA) G EXIT
"RTN","PSOORUTL",27,0)
 .;cancel/discontinue action
"RTN","PSOORUTL",28,0)
 .S POERR("PLACE")=+$P($G(^PSRX(DA,"OR1")),"^",2),POERR("STAT")=$S(POERR("STAT")="CA":"CR",1:"DR"),POERR("FILLER")=DA_"^R"
"RTN","PSOORUTL",29,0)
 .S:'$D(POERR("COMM")) POERR("COMM")="Prescription DISCONTINUED by OERR"
"RTN","PSOORUTL",30,0)
 .S ORS=1 D CAN
"RTN","PSOORUTL",31,0)
EXIT I '$G(ORS) D
"RTN","PSOORUTL",32,0)
 .S POERR("STAT")=$S(POERR("STAT")="CA":"UC",POERR("STAT")="DC":"UD",POERR("STAT")="HD":"UH",1:"UR"),POERR("FILLER")="",POERR("COMM")="Order was not located by Pharmacy"
"RTN","PSOORUTL",33,0)
 K EXP,ORS,DA,ACOM,RXDA,SUSD,PSUS,RXF,I,FDA,DIC,DIE,DR,Y,X,%,%I,%H,RSDT,ACNT,ACT,DIK,FDT,IR,LFD,NOW,ORD,PSDA,PSCDA,PSODFN,PSUS,RF,RFCNT,RXN,RXP,RXREF,SD,SUB
"RTN","PSOORUTL",34,0)
 Q
"RTN","PSOORUTL",35,0)
CAN S ACOM="Discontinued by OE/RR." I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")=16) D
"RTN","PSOORUTL",36,0)
 .S ACOM="Discontinued by OE/RR while on hold. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA) S ^PSRX(DA,"H")=""
"RTN","PSOORUTL",37,0)
 .I $P(^PSRX(DA,0),"^",13),'$O(^PSRX(DA,1,0)) S DIE=52,DR="22///"_$E($P(^PSRX(DA,0),"^",13),1,7) D ^DIE K DIE,DR Q
"RTN","PSOORUTL",38,0)
 .S (IFN,SUSD)=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  S SUSD=IFN,RFDT=$P(^PSRX(DA,1,IFN,0),"^")
"RTN","PSOORUTL",39,0)
 .Q:'$G(SUSD)  I '$P(^PSRX(DA,1,SUSD,0),"^",18) S PSDTEST=0 D  I 'PSDTEST K ^PSRX(DA,1,SUSD),^PSRX("AD",RFDT,DA,SUSD),^PSRX(DA,1,"B",RFDT,SUSD),IFN,SUSD,RFDT
"RTN","PSOORUTL",40,0)
 ..F PDA=0:0 S PDA=$O(^PSRX(DA,"L",PDA)) Q:'PDA  I $P($G(^PSRX(DA,"L",PDA,0)),"^",2)=SUSD S PSDTEST=1
"RTN","PSOORUTL",41,0)
 ..K CMOP D ^PSOCMOPA I $G(CMOP(CMOP("L")))="",$G(CMOP("S"))'="L" Q
"RTN","PSOORUTL",42,0)
 ..S PSDTEST=1
"RTN","PSOORUTL",43,0)
 S RXDA=DA,(DA,SUSDA)=$O(^PS(52.5,"B",DA,0)) D:DA
"RTN","PSOORUTL",44,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOORUTL",45,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM="Discontinued by OE/RR while suspended."
"RTN","PSOORUTL",46,0)
 .I $O(^PSRX(RXDA,1,0)) S DA=RXDA D:'$G(^PS(52.5,+SUSDA,"P")) REF^PSOCAN2
"RTN","PSOORUTL",47,0)
 .S DA=SUSDA,DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORUTL",48,0)
 K SUSD,SUSDA S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) D
"RTN","PSOORUTL",49,0)
 .S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOORUTL",50,0)
 .S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOORUTL",51,0)
 .D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1),^PSRX(DA,"A",ACNT+1,0)=%_"^C^"_POERR("USER")_"^"_RFCNT_"^"_$G(ACOM)
"RTN","PSOORUTL",52,0)
 .S REA="C" D EXP^PSOHELP1
"RTN","PSOORUTL",53,0)
 I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOORUTL",54,0)
 Q
"RTN","PSOORUTL",55,0)
HD ;place order on hold
"RTN","PSOORUTL",56,0)
 G:POERR("STAT")="RL" REL^PSOORUT1 S (ACT,ORS)=0 I POERR("PSOFILNM")["S" D  G EXIT
"RTN","PSOORUTL",57,0)
 .S DA=+POERR("PSOFILNM")
"RTN","PSOORUTL",58,0)
 .Q:'$D(^PS(52.41,DA,0))  Q:$P(^PS(52.41,DA,0),"^",3)="RF"
"RTN","PSOORUTL",59,0)
 .S $P(^PS(52.41,DA,0),"^",3)="HD",POERR("STAT")="HR",POERR("FILLER")=DA_"^P"
"RTN","PSOORUTL",60,0)
 .S:$G(POERR("COMM"))']"" POERR("COMM")="Order PLACED on HOLD by OERR before finished." S $P(^PS(52.41,DA,4),"^")=POERR("COMM"),ORS=1
"RTN","PSOORUTL",61,0)
 S DA=POERR("PSOFILNM") I $D(^PSRX(DA,0)) S ORS=1,PSDA=DA D  G EXIT
"RTN","PSOORUTL",62,0)
 .S POERR("FILLER")=DA_"^R"
"RTN","PSOORUTL",63,0)
 .S:'$D(POERR("COMM")) POERR("COMM")="Prescription Placed on HOLD by OERR"
"RTN","PSOORUTL",64,0)
 .I DT>$P(^PSRX(DA,2),"^",6) S EXP=$P(^(2),"^",6) S:$P(^PSRX(DA,"STA"),"^")<12 $P(^PSRX(DA,"STA"),"^")=11,PSOEXFLG=1 S POERR("STAT")="UH",POERR("COMM")="Prescription EXPIRED on "_$E(EXP,4,5)_"/"_$E(EXP,6,7)_"/"_$E(EXP,2,3)_"." D  Q
"RTN","PSOORUTL",65,0)
 ..D ECAN^PSOUTL(DA)
"RTN","PSOORUTL",66,0)
 .I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")>11) S POERR("STAT")="UH",POERR("COMM")="Unable to place on HOLD" Q
"RTN","PSOORUTL",67,0)
 .S $P(^PSRX(DA,"STA"),"^")=16,POERR("STAT")="HR",^PSRX(DA,"H")=99_"^"_POERR("COMM")_"^"_DT
"RTN","PSOORUTL",68,0)
 .S (PSUS,RXF)=0 F I=0:0 S I=$O(^PSRX(DA,1,I)) Q:'I  S RXF=I S:RXF>1 RSDT=$P(^(RXF-1,0),"^")
"RTN","PSOORUTL",69,0)
 .S DA=PSDA D ACT D REVERSE^PSOBPSU1(DA,,"HLD",2)
"RTN","PSOORUTL",70,0)
 .S DA=$O(^PS(52.5,"B",PSDA,0)) I DA S DIK="^PS(52.5,",PSUS=1 D ^DIK K DA,DIK
"RTN","PSOORUTL",71,0)
 I 'ORS S POERR("COMM")="Unable to place order on HOLD" G EXIT
"RTN","PSOORUTL",72,0)
 Q
"RTN","PSOORUTL",73,0)
NVA ;non-va med action
"RTN","PSOORUTL",74,0)
 N DIE,DR,DA K NVA
"RTN","PSOORUTL",75,0)
 I POERR("PSOFILNM")'["N"!('$D(^PS(55,PDFN,"NVA",+POERR("PSOFILNM"),0))) D EN^ORERR("Order was not located by Pharmacy",.MSG) Q
"RTN","PSOORUTL",76,0)
 I $G(OR("STAT"))'="CA",$G(OR("STAT"))'="DC" D EN^ORERR("Invalid Order Control Code",.MSG) Q
"RTN","PSOORUTL",77,0)
XO S ORD=+POERR("PSOFILNM")
"RTN","PSOORUTL",78,0)
 N TMP
"RTN","PSOORUTL",79,0)
 D NOW^%DTC
"RTN","PSOORUTL",80,0)
 K TMP S TMP(55.05,ORD_","_PDFN_",",5)=$S($G(PSODEATH):2,1:1)
"RTN","PSOORUTL",81,0)
 S TMP(55.05,ORD_","_PDFN_",",6)=%
"RTN","PSOORUTL",82,0)
 D FILE^DIE("","TMP")
"RTN","PSOORUTL",83,0)
 S PLACER=$P(^PS(55,PDFN,"NVA",ORD,0),"^",8)
"RTN","PSOORUTL",84,0)
 K MSG S NULLFLDS="F JJ=0:1:LIMIT S FIELD(JJ)="""""
"RTN","PSOORUTL",85,0)
 K ^UTILITY("DIQ1",$J),DIQ S DA=$P($$SITE^VASITE(),"^")
"RTN","PSOORUTL",86,0)
 I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOHINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIQ,DIC
"RTN","PSOORUTL",87,0)
 S MSG(1)="MSH|^~\&|PHARMACY|"_$G(PSOHINST)_"|||||ORR"
"RTN","PSOORUTL",88,0)
 ;
"RTN","PSOORUTL",89,0)
 S DFN=PDFN,COUNT=1,LIMIT=5 X NULLFLDS D DEM^VADPT S NAME=$G(VADM(1)) K VADM
"RTN","PSOORUTL",90,0)
 S FIELD(0)="PID",FIELD(3)=DFN,FIELD(5)=NAME
"RTN","PSOORUTL",91,0)
 D SEG^PSOHLSN1
"RTN","PSOORUTL",92,0)
 ;
"RTN","PSOORUTL",93,0)
 S LIMIT=15 X NULLFLDS
"RTN","PSOORUTL",94,0)
 S FIELD(0)="ORC",FIELD(2)=PLACER_"^OR",FIELD(3)=+POERR("PSOFILNM")_"N^PS"
"RTN","PSOORUTL",95,0)
 S FIELD(1)="SC",FIELD(5)="DC"
"RTN","PSOORUTL",96,0)
 D SEG^PSOHLSN1
"RTN","PSOORUTL",97,0)
 I $G(PSODEATH) S MSG(COUNT)=MSG(COUNT)_"|^^^^DATE OF DEATH ENTERED BY MAS.^"
"RTN","PSOORUTL",98,0)
 ;
"RTN","PSOORUTL",99,0)
 D SEND^PSOHLSN1 K FIELDS,LIMIT,PSODSC,PSONVA,OI
"RTN","PSOORUTL",100,0)
 Q
"RTN","PSOORUTL",101,0)
 ;
"RTN","PSOORUTL",102,0)
ACT ;activity log
"RTN","PSOORUTL",103,0)
 D NOW^%DTC S NOW=%
"RTN","PSOORUTL",104,0)
 S IR=0 F FDA=0:0 S FDA=$O(^PSRX(DA,"A",FDA)) Q:'FDA  S IR=FDA
"RTN","PSOORUTL",105,0)
 S IR=IR+1,^PSRX(DA,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOORUTL",106,0)
 S ^PSRX(DA,"A",IR,0)=NOW_"^"_$S(ACT:"U",1:"H")_"^"_POERR("USER")_"^"_RXF_"^"_"RX "_$S('ACT:"placed in a",1:"removed from")_" HOLD status "_$S(+$G(PSUS):"and removed from SUSPENSE ",1:"")_"("_$E(DT,4,5)_"-"_$E(DT,6,7)_"-"_$E(DT,2,3)_") by OERR."
"RTN","PSOORUTL",107,0)
 Q
"RTN","PSOPKIV1")
0^8^B24905517^B25219791
"RTN","PSOPKIV1",1,0)
PSOPKIV1 ;BHAM ISC/MHA - validate PKI cert. ; 05/09/2002  8:15 am
"RTN","PSOPKIV1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**131,146,223,148,249**;DEC 1997;Build 9
"RTN","PSOPKIV1",3,0)
 ;Ref. to ^ORWOR1 supported by DBIA 3750
"RTN","PSOPKIV1",4,0)
CER ;
"RTN","PSOPKIV1",5,0)
 N P1,P2
"RTN","PSOPKIV1",6,0)
 I $D(OR0) S P1=$P(OR0,"^"),P2=$P(OR0,"^",2)
"RTN","PSOPKIV1",7,0)
 E  S P1=$P($G(^PSRX(DA,"OR1")),"^",2),P2=$P($G(^(0)),"^",2)
"RTN","PSOPKIV1",8,0)
 I P1<1 S PKI=-1,VALMSG="Invalid CPRS Pointer - Unable to Process" Q
"RTN","PSOPKIV1",9,0)
CT N PKIRT D VERIFY^ORWOR1(.PKIRT,P1,P2)
"RTN","PSOPKIV1",10,0)
 S PKI=+PKIRT I PKI=1 S VALMSG="Digitally Signed Order",PKIE="Processing "_VALMSG Q
"RTN","PSOPKIV1",11,0)
 I PKI<2 S VALMSG=$P(PKIRT,"^",2) Q
"RTN","PSOPKIV1",12,0)
 S PKI1=$S(PKI>89802014&(PKI<89802019)!((PKI>89802020)&(PKI<89802023)):2,1:1)
"RTN","PSOPKIV1",13,0)
 S PKIE="Digital Signature Failed: "_$P($T(@($E(PKI,7,8))),";;",2)
"RTN","PSOPKIV1",14,0)
 S:'$G(PSOZVER) VALMSG="Signature Failed: "_$P($T(@($E(PKI,7,8))),";;",2)
"RTN","PSOPKIV1",15,0)
 S:PKI1=2 PKIE=PKIE_" - Order Auto Discontinued" S:$L(PKIE)>75 PKIE=$E(PKIE,1,75)
"RTN","PSOPKIV1",16,0)
 Q
"RTN","PSOPKIV1",17,0)
L1 ;
"RTN","PSOPKIV1",18,0)
 S PKID=1,IEN=IEN+1,^TMP($S($G(ST)=1:"PSOAO",1:"PSOPO"),$J,IEN,0)=PKIE Q
"RTN","PSOPKIV1",19,0)
ERR(ER) ;
"RTN","PSOPKIV1",20,0)
 Q:'ER
"RTN","PSOPKIV1",21,0)
 N ERM S ERM=$P($T(@($E(ER,7,8))),";;",2) I ERM]"" Q "Signature Failed: "_ERM
"RTN","PSOPKIV1",22,0)
 Q ""
"RTN","PSOPKIV1",23,0)
REA ;
"RTN","PSOPKIV1",24,0)
 D KV^PSOVER1
"RTN","PSOPKIV1",25,0)
 W ! S DIR("A")="Enter Override Reason ",DIR(0)="F^5:70",DIR("?")="Free text reason must be entered, should be between 5 to 70 characters and must not contain embedded up-arrow, e.g. Spoke with the Provider."
"RTN","PSOPKIV1",26,0)
 S:$G(PKIR)]"" DIR("B")=PKIR D ^DIR S:'$D(DIRUT) PKIR=Y
"RTN","PSOPKIV1",27,0)
 I $D(DIRUT) K PKIR I $D(OR0) S:$P(OR0,"^",3)="RNW" PSONEW("QFLG")=1 S:$P(OR0,"^",3)="NW" PSORX("DFLG")=1
"RTN","PSOPKIV1",28,0)
 D KV^PSOVER1 K Y Q
"RTN","PSOPKIV1",29,0)
ACT(DA) ;
"RTN","PSOPKIV1",30,0)
 Q:'DA
"RTN","PSOPKIV1",31,0)
 N I,J D AR
"RTN","PSOPKIV1",32,0)
 S ^PSRX(DA,"A",0)="^52.3DA^"_J_"^"_J,^PSRX(DA,"A",J,0)=%_"^K^"_DUZ_"^0^INVALID PKI CERT. "_PKI
"RTN","PSOPKIV1",33,0)
 S ^PSRX(DA,"A",J,2,1,0)=PKIR,^PSRX(DA,"A",J,2,0)="^52.34A^1^1"
"RTN","PSOPKIV1",34,0)
 K PKIR Q
"RTN","PSOPKIV1",35,0)
 ;
"RTN","PSOPKIV1",36,0)
AR ;
"RTN","PSOPKIV1",37,0)
 S (I,J)=0 F  S I=$O(^PSRX(DA,"A",I)) Q:'I  S J=I
"RTN","PSOPKIV1",38,0)
 S J=J+1 D NOW^%DTC Q
"RTN","PSOPKIV1",39,0)
DCP ;
"RTN","PSOPKIV1",40,0)
 Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOPKIV1",41,0)
 K ^PS(52.41,"AOR",$P(^PS(52.41,ORD,0),"^",2),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD),^PS(52.41,"AD",$P(^PS(52.41,ORD,0),"^",12),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD)
"RTN","PSOPKIV1",42,0)
 S $P(^PS(52.41,ORD,0),"^",3)="DC"
"RTN","PSOPKIV1",43,0)
 S PKIE=$P(PKIE," - ")_" - "_PKI,$P(^PS(52.41,ORD,4),"^")=PKIE
"RTN","PSOPKIV1",44,0)
 D EN^PSOHLSN($P(^PS(52.41,ORD,0),"^"),"OD",PKIE,"A")
"RTN","PSOPKIV1",45,0)
 Q
"RTN","PSOPKIV1",46,0)
 ;
"RTN","PSOPKIV1",47,0)
DCV ;
"RTN","PSOPKIV1",48,0)
 W ! D KV^PSOVER1 K PKIR S DIR(0)="Y",DIR("B")="N",DIR("A",1)="Digitally signed Schedule II Rx cannot be deleted, it can only be D/Ced."
"RTN","PSOPKIV1",49,0)
 S DIR("A")="Are you sure you want to D/C this Rx: " D ^DIR,KV^PSOVER1
"RTN","PSOPKIV1",50,0)
 I 'Y S VALMSG="No Action Taken!",VALMBCK="R" Q
"RTN","PSOPKIV1",51,0)
 S:'$D(INCOM) INCOM="DCed by Pharmacy for PKI" S DIR("B")=INCOM
"RTN","PSOPKIV1",52,0)
 ;
"RTN","PSOPKIV1",53,0)
 W ! S DIR("A")="Reason for D/Cing",DIR(0)="F^5:75",DIR("?")="Reason must be entered and should be 5 to 75 characters and must not contain embedded uparrow"
"RTN","PSOPKIV1",54,0)
 D ^DIR I $D(DIRUT) D KV^PSOVER1 S VALMSG="No Action Taken!",VALMBCK="R" Q
"RTN","PSOPKIV1",55,0)
 S PKIR=Y D KV^PSOVER1
"RTN","PSOPKIV1",56,0)
DCV0 Q:'$D(^PS(52.4,DA,0))
"RTN","PSOPKIV1",57,0)
 S $P(^PSRX(DA,"STA"),"^")=12,$P(^PSRX(DA,3),"^",5)=DT
"RTN","PSOPKIV1",58,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7),CAN^PSOTPCAN(DA) N I,J D AR
"RTN","PSOPKIV1",59,0)
 S ^PSRX(DA,"A",J,0)=%_"^C^"_DUZ_"^0^Discontinued during verification"
"RTN","PSOPKIV1",60,0)
 S J=J+1 D ADR
"RTN","PSOPKIV1",61,0)
 N PKIX S PKIX=DA D EN^PSOHLSN1(DA,"OD","",PKIR,PSONOOR)
"RTN","PSOPKIV1",62,0)
 S DA=PKIX S DIK="^PS(52.4," D ^DIK K DIK
"RTN","PSOPKIV1",63,0)
 Q
"RTN","PSOPKIV1",64,0)
 ;
"RTN","PSOPKIV1",65,0)
DCV1 N PKIR,PSONOOR,DA S DA=PSONV,PKIR=$P($G(PKIE),"-")_" - "_PKI,PSONOOR="A" D DCV0
"RTN","PSOPKIV1",66,0)
 Q
"RTN","PSOPKIV1",67,0)
ADR ;
"RTN","PSOPKIV1",68,0)
 S ^PSRX(DA,"A",0)="^52.3DA^"_J_"^"_J
"RTN","PSOPKIV1",69,0)
 S ^PSRX(DA,"A",J,0)=%_"^K^"_DUZ_"^0^Digitally signed"
"RTN","PSOPKIV1",70,0)
 S ^PSRX(DA,"A",J,2,1,0)=$S($G(PKIR)]"":PKIR,1:"Digitally signed order Discontinued"),^PSRX(DA,"A",J,2,0)="^52.34A^1^1"
"RTN","PSOPKIV1",71,0)
 Q
"RTN","PSOPKIV1",72,0)
RV ;
"RTN","PSOPKIV1",73,0)
 N TY,T,T1,T2,MIG,SG
"RTN","PSOPKIV1",74,0)
 S (T,T2)=0
"RTN","PSOPKIV1",75,0)
 F  S T=$O(^PS(52.41,ORD,"OBX",T)) Q:'T  D
"RTN","PSOPKIV1",76,0)
 .S T1=0,$P(TY(T2)," ",23)=" "
"RTN","PSOPKIV1",77,0)
 .F  S T1=$O(^PS(52.41,ORD,"OBX",T,2,T1)) Q:'T1  D
"RTN","PSOPKIV1",78,0)
 ..S MIG=^PS(52.41,ORD,"OBX",T,2,T1,0)
"RTN","PSOPKIV1",79,0)
 ..F SG=1:1:$L(MIG," ") S:$L(TY(T2)_" "_$P(MIG," ",SG))>80 T2=T2+1,$P(TY(T2)," ",23)=" " S TY(T2)=$G(TY(T2))_" "_$P(MIG," ",SG)
"RTN","PSOPKIV1",80,0)
 .S T2=T2+4
"RTN","PSOPKIV1",81,0)
 S T2=T2+2 D CNTRL^VALM10(T2,1,$L(PKIE),IORVON,IORVOFF,0)
"RTN","PSOPKIV1",82,0)
 Q
"RTN","PSOPKIV1",83,0)
 ;
"RTN","PSOPKIV1",84,0)
00 ;;Order Text is blank;;
"RTN","PSOPKIV1",85,0)
01 ;;DEA # missing;;
"RTN","PSOPKIV1",86,0)
02 ;;Drug Schedule missing;;
"RTN","PSOPKIV1",87,0)
03 ;;DEA # not valid;;
"RTN","PSOPKIV1",88,0)
04 ;;Valid Certificate not found;;
"RTN","PSOPKIV1",89,0)
05 ;;Couldn't load CSP;;
"RTN","PSOPKIV1",90,0)
06 ;;Smart card Reader not found;;
"RTN","PSOPKIV1",91,0)
07 ;;Certificate with DEA # not found;;
"RTN","PSOPKIV1",92,0)
08 ;;Certificate not valid for schedule;;
"RTN","PSOPKIV1",93,0)
10 ;;Crypto Error (contact IRM);;
"RTN","PSOPKIV1",94,0)
15 ;;Corrupted (Decode failure);;
"RTN","PSOPKIV1",95,0)
16 ;;Corrupted (Hash mismatch);;
"RTN","PSOPKIV1",96,0)
17 ;;Certificate revoked;;
"RTN","PSOPKIV1",97,0)
18 ;;Verification failure;;
"RTN","PSOPKIV1",98,0)
19 ;;Before Cert effective date;;
"RTN","PSOPKIV1",99,0)
20 ;;Certificate expired;;
"RTN","PSOPKIV1",100,0)
21 ;;No Cert with a valid date found;;
"RTN","PSOPKIV1",101,0)
22 ;;Signature Check failed (Invalid Signature);;
"RTN","PSOTALK")
0^11^B84408343^B84758414
"RTN","PSOTALK",1,0)
PSOTALK ;BIR/EJW - SCRIPTALK INTERFACE FROM VISTA ; 3/9/07 10:38am
"RTN","PSOTALK",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**135,182,211,200,249**;DEC 1997;Build 9
"RTN","PSOTALK",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOTALK",4,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOTALK",5,0)
 ;External reference to ^PS(59.7 controlled subscription by DBIA 694
"RTN","PSOTALK",6,0)
 ;ROB SILVERMAN-HINES DEVELOPED ORIGINAL VISTA CUSTOM SOFTWARE FOR SCRIPTALK
"RTN","PSOTALK",7,0)
EN Q:'$$PAT55  ; QUIT IF NOT A SCRIPTALK ELIGIBLE PATIENT
"RTN","PSOTALK",8,0)
 S PSOSTALK=1
"RTN","PSOTALK",9,0)
 N PHONE,RXNUM,RXALPHA,DATE,EDATE,RFILLS,PTNAME,SIG,SIGX,PROV,DRUG,WARN,LINE
"RTN","PSOTALK",10,0)
 D GATHER,TRANS,CLEAN
"RTN","PSOTALK",11,0)
 Q
"RTN","PSOTALK",12,0)
 ;
"RTN","PSOTALK",13,0)
CLEAN K PHONE,RXNUM,RXALPHA,DATE,EDATE,RFILLS,PTNAME,SIG,SIGX,PROV,DRUG,WARN,VADM
"RTN","PSOTALK",14,0)
 K PSOCTP,PSOCTV,XMIT,PSORCT,PSOTSSN,PSOEXPDT
"RTN","PSOTALK",15,0)
 K PSOLNE,PSOLEN,PSOLINE,PSOWORD,PSOWDS,LINE
"RTN","PSOTALK",16,0)
 K PSOSIG1,PSOLSIG,PSOSIG,PSOSTOP,PSOPMAP
"RTN","PSOTALK",17,0)
 Q
"RTN","PSOTALK",18,0)
BARE N RX
"RTN","PSOTALK",19,0)
 D CLEAN
"RTN","PSOTALK",20,0)
 W ! S DIC="^PSRX(",DIC(0)="AEQM" D ^DIC K DIC Q:Y<0  S RX=+Y
"RTN","PSOTALK",21,0)
 D:'$D(PSOPAR) ^PSOLSET
"RTN","PSOTALK",22,0)
 I '$$PAT55 W !,"Patient not enrolled in ScripTalk program." G BAREO
"RTN","PSOTALK",23,0)
 I $P(^PSRX(RX,"STA"),"^")'=0 W !,"Prescription not ACTIVE" G BAREO
"RTN","PSOTALK",24,0)
 D GATHER
"RTN","PSOTALK",25,0)
 W !!,"  Queuing ScripTalk label"
"RTN","PSOTALK",26,0)
 D TRANS
"RTN","PSOTALK",27,0)
BAREO D CLEAN
"RTN","PSOTALK",28,0)
 W !!
"RTN","PSOTALK",29,0)
 G BARE
"RTN","PSOTALK",30,0)
 Q
"RTN","PSOTALK",31,0)
BARI N RX
"RTN","PSOTALK",32,0)
 D CLEAN
"RTN","PSOTALK",33,0)
 S RX=$$READER^PSOTALK1("FO^1:12","Enter Barcode Rx#")
"RTN","PSOTALK",34,0)
 Q:RX']""
"RTN","PSOTALK",35,0)
 G:RX'["-" BARIO
"RTN","PSOTALK",36,0)
 S RX=$P(RX,"-",2)
"RTN","PSOTALK",37,0)
 I '$D(^PSRX(RX,0)) W !,"Prescription not on file" G BARIO
"RTN","PSOTALK",38,0)
 I '$$PAT55 W !,"Patient not enrolled in ScripTalk program." G BARIO
"RTN","PSOTALK",39,0)
 I $P(^PSRX(RX,"STA"),"^")'=0 W !,"Prescription not ACTIVE" G BARIO
"RTN","PSOTALK",40,0)
 D:'$D(PSOPAR) ^PSOLSET
"RTN","PSOTALK",41,0)
 D GATHER
"RTN","PSOTALK",42,0)
 W !!,"  Queuing ScripTalk label"
"RTN","PSOTALK",43,0)
 D TRANS
"RTN","PSOTALK",44,0)
BARIO D CLEAN
"RTN","PSOTALK",45,0)
 W !!
"RTN","PSOTALK",46,0)
 G BARI
"RTN","PSOTALK",47,0)
 Q
"RTN","PSOTALK",48,0)
GATHER ;
"RTN","PSOTALK",49,0)
 N DFN
"RTN","PSOTALK",50,0)
 S DFN=$P(^PSRX(RX,0),"^",2)
"RTN","PSOTALK",51,0)
 D DEM^VADPT
"RTN","PSOTALK",52,0)
 S PHONE=$$PHONE
"RTN","PSOTALK",53,0)
 S RXNUM=+$$RXNUM
"RTN","PSOTALK",54,0)
 S RXALPHA=$$RXALPHA
"RTN","PSOTALK",55,0)
 S DATE=$$DATE
"RTN","PSOTALK",56,0)
 S FILLS=$$RFILLS I $L(RFILLS)=1 S FILLS="0"_FILLS
"RTN","PSOTALK",57,0)
 S PTNAME=VADM(1) D
"RTN","PSOTALK",58,0)
 .N FNAM,MI
"RTN","PSOTALK",59,0)
 .S FNAM=$P(PTNAME,",",2) I FNAM[" " D
"RTN","PSOTALK",60,0)
 ..S MI=$P(FNAM," ",2,99) I MI[" " S MI=$P(MI," ")
"RTN","PSOTALK",61,0)
 ..S FNAM=$P(FNAM," ")
"RTN","PSOTALK",62,0)
 .S PTNAME=FNAM_$S($G(MI)'="":" "_MI,1:"")_" "_$P(PTNAME,",")
"RTN","PSOTALK",63,0)
 .S PTNAME=$$UP^XLFSTR(PTNAME)
"RTN","PSOTALK",64,0)
 .S PTNAME=$TR(PTNAME,"-"," ")
"RTN","PSOTALK",65,0)
 .S PTNAME=$TR(PTNAME,".","")
"RTN","PSOTALK",66,0)
 .S PTNAME=$TR(PTNAME,"'"," ")
"RTN","PSOTALK",67,0)
 S SIG=$TR($$UP^XLFSTR($$SIGPOE),"[\]^_`{|}~","(/) -'( ) ")
"RTN","PSOTALK",68,0)
 S SIGX=$TR($$UP^XLFSTR($$SIGPOEX),"[\]^_`{|}~","(/) -'( ) ")
"RTN","PSOTALK",69,0)
 S PROV=$E($$UP^XLFSTR($$PROV),1,30)
"RTN","PSOTALK",70,0)
 S DRUG=$TR($$UP^XLFSTR($$DRUG),"[\]^_`{|}~","(/) -'( ) ")
"RTN","PSOTALK",71,0)
 S WARN=$$WARN
"RTN","PSOTALK",72,0)
 D PSOEXP
"RTN","PSOTALK",73,0)
 S LINE(1)="VAMC "_$$CITY_", "_$$STATE_"  "_$$ZIP
"RTN","PSOTALK",74,0)
 S LINE(2)=$$SITE_" ("_$$CLERK_"/"_$$VRPH_") "_$$ACODE_"-"_$$EPHON_" Exp: "_PSOEXPDT
"RTN","PSOTALK",75,0)
 S LINE(3)="Rx# "_$$RXNUM_"  "_$$EDATE_"  Fill "_$$FILNO_" of "_$$TFILLS
"RTN","PSOTALK",76,0)
 S LINE(4)=$$EPAT_"  "_$$LAST6
"RTN","PSOTALK",77,0)
 D INST^PSOTALK1 S LINE(5)=$G(PSOLNE(1)),LINE(6)=$G(PSOLNE(2)),LINE(7)=$G(PSOLNE(3))
"RTN","PSOTALK",78,0)
 S LINE(8)=$$EPROV,LINE(10)=$$DRUG
"RTN","PSOTALK",79,0)
 S LINE(9)="Qty: "_$$QTY_"  "_$$DF
"RTN","PSOTALK",80,0)
 Q
"RTN","PSOTALK",81,0)
TRANS ;If printer mapping defined use it; otherwise print by division 01/19/07
"RTN","PSOTALK",82,0)
 D PCHK:'$D(PSOPMAP)  ;don't recheck for mapped printer if PSOPMAP equal 0 (not defined) or 1 (defined)
"RTN","PSOTALK",83,0)
 I '$D(^PS(59.7,1,47,"B",IOS))&('$G(PSOPMAP)) S ZTIO="`"_$P($G(^PS(59,PSOSITE,"STALK")),U)
"RTN","PSOTALK",84,0)
 Q:ZTIO="`"
"RTN","PSOTALK",85,0)
 S ZTRTN="GO^PSOTALK",ZTSAVE("*")="",ZTDTH=$$NOW^XLFDT,ZTDESC="Scriptalk Interface Transmission"
"RTN","PSOTALK",86,0)
 D ^%ZTLOAD
"RTN","PSOTALK",87,0)
 Q
"RTN","PSOTALK",88,0)
PCHK ;Check for printers that are mapped to a ScripTalk printer
"RTN","PSOTALK",89,0)
 N PSOLPRT,PSONIOS,PSOLBSEQ
"RTN","PSOTALK",90,0)
 S ZTIO="`",PSOLPRT=$S($D(PSOLAP):PSOLAP,$G(SUSPT):PSLION,$D(ION):ION,1:"") Q:PSOLPRT=""  Q:'$D(^%ZIS(1,"B",PSOLPRT))
"RTN","PSOTALK",91,0)
 S PSONIOS="",PSOPMAP=0,PSONIOS=$O(^%ZIS(1,"B",PSOLPRT,PSONIOS))
"RTN","PSOTALK",92,0)
 I $D(^PS(59.7,1,47,"B",PSONIOS)) D
"RTN","PSOTALK",93,0)
 . S PSOLBSEQ="",PSOLBSEQ=$O(^PS(59.7,1,47,"B",PSONIOS,PSOLBSEQ))
"RTN","PSOTALK",94,0)
 . S ZTIO=ZTIO_$P(^PS(59.7,1,47,PSOLBSEQ,0),"^",2),PSOPMAP=1
"RTN","PSOTALK",95,0)
 Q
"RTN","PSOTALK",96,0)
 ;
"RTN","PSOTALK",97,0)
GO W !,"^XA",!,"^FO250,700^XGE:RX.GRF^FS"  ;;1.2e 4-17-02 TO MOVE GRAPHIC
"RTN","PSOTALK",98,0)
 D OVERLAY,PICOTAG  ;;FOR LARGER LABELS
"RTN","PSOTALK",99,0)
 W !,"^PQ1,0,1,Y",!,"^XZ"  ;;FOR LARGER LABELS
"RTN","PSOTALK",100,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOTALK",101,0)
 Q
"RTN","PSOTALK",102,0)
 ;
"RTN","PSOTALK",103,0)
OVERLAY F PSOLINE=1:1:7 D DEFLINE((9+((20-PSOLINE)*28)),50,LINE(PSOLINE),PSOLINE,0)
"RTN","PSOTALK",104,0)
 F PSOLINE=8:1:10 D DEFLINE((9+((19-PSOLINE)*28)),50,LINE(PSOLINE),PSOLINE,0)
"RTN","PSOTALK",105,0)
 Q
"RTN","PSOTALK",106,0)
 ;
"RTN","PSOTALK",107,0)
DEFLINE(XCORD,YCORD,PRTOUT,FIELDNO,OFFSET) ;
"RTN","PSOTALK",108,0)
 W !,"^AFR,20,10^FO"_XCORD_","_YCORD_"^FR^CI0^FD"_PRTOUT_"^FS"
"RTN","PSOTALK",109,0)
 Q
"RTN","PSOTALK",110,0)
 ;
"RTN","PSOTALK",111,0)
PICOTAG S PSOCTP=1
"RTN","PSOTALK",112,0)
 S DRUG=$E(DRUG,1,39)  ;1.2c*1 TEMPORARY FIX FOR DRUG TRUNCATE AT 39
"RTN","PSOTALK",113,0)
 F XMIT=PTNAME,DRUG,SIGX,DATE,FILLS,WARN,PROV,PHONE,RXNUM,RXALPHA D XMITP
"RTN","PSOTALK",114,0)
 Q
"RTN","PSOTALK",115,0)
 ;
"RTN","PSOTALK",116,0)
XMITP W !,"^RX"_$S(PSOCTP<10:"0",1:"")_PSOCTP_","_XMIT_"^FS"
"RTN","PSOTALK",117,0)
 S PSOCTP=PSOCTP+1
"RTN","PSOTALK",118,0)
 Q
"RTN","PSOTALK",119,0)
ID() I $$PAT55 Q "+SCRIPTALK"
"RTN","PSOTALK",120,0)
 E  Q ""
"RTN","PSOTALK",121,0)
AUTO ;;v1.2c - LABEL REPRINTING FUNCTIONS 3-12-02
"RTN","PSOTALK",122,0)
 Q:$G(PSOTREP)  ;NO AUTO-PRINT DURING REGULAR NON-VOIDED LABEL REPRINT
"RTN","PSOTALK",123,0)
 D PCHK
"RTN","PSOTALK",124,0)
 I $P($G(^PS(59,+PSOSITE,"STALK")),U,2)="A"!($G(PSOPMAP)) D EN
"RTN","PSOTALK",125,0)
 Q
"RTN","PSOTALK",126,0)
 ;
"RTN","PSOTALK",127,0)
PAT55() Q +$G(^PS(55,"ASTALK",$P(^PSRX(RX,0),"^",2)))  ;IS PATIENT ENROLLED (NEW FIELD POSITION 2-12-02 RMS UPDATE v1.2b)
"RTN","PSOTALK",128,0)
PHONE() ;changes below 1.2c*1 to swap to site signed-on vs. site from Rx
"RTN","PSOTALK",129,0)
 Q $E($P(^PS(59,+PSOSITE,0),"^",3),1,3)_$E($TR($P(^PS(59,+PSOSITE,0),"^",4),"-,",""),1,7) ; RX DIVISION PHONE NUMBER
"RTN","PSOTALK",130,0)
CITY() Q $P(^PS(59,+PSOSITE,0),"^",7)
"RTN","PSOTALK",131,0)
STATE() Q $P(^DIC(5,$P(^PS(59,+PSOSITE,0),"^",8),0),"^",2)
"RTN","PSOTALK",132,0)
ZIP() Q $P(^PS(59,+PSOSITE,0),"^",5)
"RTN","PSOTALK",133,0)
SITE() Q $P(^PS(59,+PSOSITE,0),"^",6)
"RTN","PSOTALK",134,0)
ACODE() Q $P(^PS(59,+PSOSITE,0),"^",3)
"RTN","PSOTALK",135,0)
EPHON() Q $P(^PS(59,+PSOSITE,0),"^",4)
"RTN","PSOTALK",136,0)
CLERK() Q $P($G(^PSRX(RX,"OR1")),"^",5)
"RTN","PSOTALK",137,0)
PSOEXP ;
"RTN","PSOTALK",138,0)
 N X1,X2,X S X1=DT,X2=365 D C^%DTC S PSOEXPDT=X
"RTN","PSOTALK",139,0)
 S PSOEXPDT=$E(PSOEXPDT,4,5)_"/"_$E(PSOEXPDT,6,7)_"/"_$E(PSOEXPDT,2,3)
"RTN","PSOTALK",140,0)
 Q
"RTN","PSOTALK",141,0)
VRPH() Q $P($G(^PSRX(RX,2)),"^",10)
"RTN","PSOTALK",142,0)
RXNUM() Q $P(^PSRX(RX,0),"^",1) ;RETURN RX EXTERNAL NUMBER
"RTN","PSOTALK",143,0)
RXALPHA() ;RETURN RENEWAL LETTER OR SPACE CHARACTER
"RTN","PSOTALK",144,0)
 N RXALPHA
"RTN","PSOTALK",145,0)
 S RXALPHA=$E($P(^PSRX(RX,0),"^",1),$L($P(^PSRX(RX,0),"^",1)))
"RTN","PSOTALK",146,0)
 Q $S(RXALPHA?1A:RXALPHA,1:" ")
"RTN","PSOTALK",147,0)
DATE() ;CHANGED 7-30-01 TO USE EDATE FORMAT ALSO WHEN SPEAKING
"RTN","PSOTALK",148,0)
 S EDATE=$P(^PSRX(RX,3),"^")
"RTN","PSOTALK",149,0)
 Q $E(EDATE,4,5)_$E(EDATE,6,7)_$E(EDATE,2,3)
"RTN","PSOTALK",150,0)
EDATE() Q $$FMTE^XLFDT($P(^PSRX(RX,3),"^"))  ; EXTERNAL DATE / LAST DISPENSED
"RTN","PSOTALK",151,0)
FILLS() Q $G(RXF)+1 ; FILL COUNT
"RTN","PSOTALK",152,0)
TFILLS() Q $P(^PSRX(RX,0),"^",9)+1 ; TOTAL FILLS
"RTN","PSOTALK",153,0)
RFILLS() ;NEW REFILLS REMAINING METHOD 9-21-00, BASED ON PTST+5^PSORXVW
"RTN","PSOTALK",154,0)
 S RFILLS=$P(^PSRX(RX,0),"^",9),PSORCT=0 F  S PSORCT=$O(^PSRX(RX,1,PSORCT)) Q:'PSORCT  S RFILLS=RFILLS-1
"RTN","PSOTALK",155,0)
 Q RFILLS
"RTN","PSOTALK",156,0)
FILNO() Q $$TFILLS-$$RFILLS
"RTN","PSOTALK",157,0)
EPAT() Q $P(^DPT($P(^PSRX(RX,0),"^",2),0),"^") ; EXTERNAL PATIENT NAME
"RTN","PSOTALK",158,0)
LAST6() S PSOTSSN=$P(^DPT($P(^PSRX(RX,0),"^",2),0),"^",9)  ; LAST 6 OF SSN
"RTN","PSOTALK",159,0)
 Q $E(PSOTSSN,4,5)_"-"_$E(PSOTSSN,6,9)
"RTN","PSOTALK",160,0)
SIG() ;THIS SUBROUTINE WILL BE ABANDONED IF SIGPOE WORKS v1.2c 3-13-02
"RTN","PSOTALK",161,0)
 I $L($P(^PSRX(RX,"SIG"),"^",1))=0 Q $E($$LSIG^PSOTALK1($P(^PSRX(RX,"SIG1",1,0),"^",1)),1,196)
"RTN","PSOTALK",162,0)
 E  Q $E($$LSIG^PSOTALK1($P(^PSRX(RX,"SIG"),"^",1)),1,196) ; SIG -- NEEDS TO BE EXPANDED
"RTN","PSOTALK",163,0)
SIGPOE() ;v1.2c - NEW SUBROUTINE TO GIVE MESSAGE FOR LONG SIGS FOR THE HUMAN READABLE PORTION
"RTN","PSOTALK",164,0)
 S PSOSIG=""
"RTN","PSOTALK",165,0)
 I $P($G(^PS(55,DFN,"LAN")),"^",1) D  G SIGPOEE
"RTN","PSOTALK",166,0)
 .S PSOSIG=" " ; PUT SPACE ON FRONT OF SIG (GETS STRIPPED OFF LATER)
"RTN","PSOTALK",167,0)
 .D OTHL1^PSOLBL3(RX) I $O(SIG2(0))="" Q
"RTN","PSOTALK",168,0)
 .N XX,X
"RTN","PSOTALK",169,0)
 .;PSO*7*211;MODIFIED TO REPLACE SIG IF >138 INSTEAD OF 196
"RTN","PSOTALK",170,0)
 .S XX=0 F  S XX=$O(SIG2(XX)) Q:'XX  S X=SIG2(XX) I X'="" S PSOSIG=PSOSIG_X_" " I $L(PSOSIG)>138 D  Q
"RTN","PSOTALK",171,0)
 ..S PSOSIG=" INDICACIONES MUY LARGAS. IMPRIMA UNA ETIQUETA DE VISTA VALIDA Y APLIQUELA SOBRE ESTA ETIQUETA DE SCRIPTALK EN LA BOTELLA."
"RTN","PSOTALK",172,0)
 E  D  ;
"RTN","PSOTALK",173,0)
 . N PSOSEQ
"RTN","PSOTALK",174,0)
 . S PSOSTOP=0,PSOSIG=""
"RTN","PSOTALK",175,0)
 . S PSOLSIG=" SIG IS TOO LONG. REPRINT A NON-VOIDED VISTA LABEL AND PLACE OVER THIS SCRIPTALK LABEL"
"RTN","PSOTALK",176,0)
 . S PSOSEQ=0 F  S PSOSEQ=$O(^PSRX(RX,"SIG1",PSOSEQ)) Q:PSOSEQ'=+PSOSEQ!($G(PSOSTOP))  D  ;
"RTN","PSOTALK",177,0)
 .. S PSOSIG1=$G(^PSRX(RX,"SIG1",PSOSEQ,0))
"RTN","PSOTALK",178,0)
 ..;PSO*7*211;MODIFIED TO REPLACE SIG IF >138 INSTEAD OF 196
"RTN","PSOTALK",179,0)
 .. I $L(PSOSIG)+$L($G(^PSRX(RX,"SIG1",PSOSEQ,0)))>138 S PSOSIG=PSOLSIG,PSOSTOP=1 Q  ;
"RTN","PSOTALK",180,0)
 .. S PSOSIG=$G(PSOSIG)_" "_PSOSIG1
"RTN","PSOTALK",181,0)
SIGPOEE Q $E(PSOSIG,2,197)
"RTN","PSOTALK",182,0)
 ;
"RTN","PSOTALK",183,0)
SIGPOEX() ;v1.2c - NEW SUBROUTINE TO GIVE MESSAGE FOR LONG SIGS FOR THE READ ALOUD PORTION
"RTN","PSOTALK",184,0)
 S PSOSIG=""
"RTN","PSOTALK",185,0)
 I $P($G(^PS(55,DFN,"LAN")),"^",1) D  G SIGPOEEX
"RTN","PSOTALK",186,0)
 .S PSOSIG=" " ; PUT SPACE ON FRONT OF SIG (GETS STRIPPED OFF LATER)
"RTN","PSOTALK",187,0)
 .D OTHL1^PSOLBL3(RX) I $O(SIG2(0))="" Q
"RTN","PSOTALK",188,0)
 .N XX,X
"RTN","PSOTALK",189,0)
 .S XX=0 F  S XX=$O(SIG2(XX)) Q:'XX  S X=SIG2(XX) I X'="" S PSOSIG=PSOSIG_X_" " I $L(PSOSIG)>196 D  Q
"RTN","PSOTALK",190,0)
 ..S PSOSIG=" LAS INSTRUCCIONES DE ESTA RECETA SON MUY LARGAS.  POR FAVOR SOLICITE A SU CUIDADOR QUE LE LEA LAS INSTRUCCIONES IMPRESAS EN EL ROTULO O COMUNIQUESE CON SU MEDICO PARA INSTRUCCIONES COMPLETAS."
"RTN","PSOTALK",191,0)
 I $L($P(^PSRX(RX,"SIG"),"^",1))'=0 Q $E($$LSIG^PSOTALK1($P(^PSRX(RX,"SIG"),"^",1)),1,196)
"RTN","PSOTALK",192,0)
 E  D  ;
"RTN","PSOTALK",193,0)
 . N PSOSEQ
"RTN","PSOTALK",194,0)
 . S PSOSTOP=0,PSOSIG=""
"RTN","PSOTALK",195,0)
 . S PSOLSIG=" THE INSTRUCTIONS FOR THIS PRESCRIPTION ARE TOO LONG. PLEASE HAVE A CAREGIVER READ THE PRINTED LABEL OR CONTACT YOUR PHYSICIAN FOR COMPLETE INSTRUCTIONS."
"RTN","PSOTALK",196,0)
 . S PSOSEQ=0 F  S PSOSEQ=$O(^PSRX(RX,"SIG1",PSOSEQ)) Q:PSOSEQ'=+PSOSEQ!($G(PSOSTOP))  D  ;
"RTN","PSOTALK",197,0)
 .. S PSOSIG1=$G(^PSRX(RX,"SIG1",PSOSEQ,0))
"RTN","PSOTALK",198,0)
 .. I $L(PSOSIG)+$L($G(^PSRX(RX,"SIG1",PSOSEQ,0)))>196 S PSOSIG=PSOLSIG,PSOSTOP=1 Q  ;
"RTN","PSOTALK",199,0)
 .. S PSOSIG=$G(PSOSIG)_" "_PSOSIG1
"RTN","PSOTALK",200,0)
SIGPOEEX Q $E(PSOSIG,2,197)
"RTN","PSOTALK",201,0)
PROV() ;PROVIDER NAME
"RTN","PSOTALK",202,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="M",X="`"_+$P(^PSRX(RX,0),"^",4) D ^DIC S PSOPHYS=$S(+Y:$P(Y,"^",2),1:"UNKNOWN") K DIC,X,Y
"RTN","PSOTALK",203,0)
 Q $P($$NAMEFMT^XLFNAME(PSOPHYS)," MD")
"RTN","PSOTALK",204,0)
EPROV() ;
"RTN","PSOTALK",205,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="M",X="`"_+$P(^PSRX(RX,0),"^",4) D ^DIC S PSOPHYS=$S(+Y:$P(Y,"^",2),1:"UNKNOWN") K DIC,X,Y
"RTN","PSOTALK",206,0)
 Q PSOPHYS
"RTN","PSOTALK",207,0)
QTY() Q $S($G(RXP):$P(RXP,"^",4),1:$P(^PSRX(RX,0),"^",7))
"RTN","PSOTALK",208,0)
DF() Q $P($G(^PSDRUG($P(^PSRX(RX,0),"^",6),660)),"^",8)
"RTN","PSOTALK",209,0)
DRUG() Q $$ZZ^PSOSUTL(RX) ; DRUG NAME
"RTN","PSOTALK",210,0)
WARN() N WARN,NWARN,IWARN,XWARN ; 1-28-02 UPDATE v1.2a TO ELIMINATE LOCAL CODES
"RTN","PSOTALK",211,0)
 S WARN=$P(^PSDRUG($P(^PSRX(RX,0),"^",6),0),"^",8) ; WARNING LABEL CODES
"RTN","PSOTALK",212,0)
 F NWARN=1:1:3 S IWARN=$P(WARN,",",NWARN) S:IWARN>20 IWARN="" S:$L(IWARN)=1 IWARN="0"_IWARN S:$L(IWARN)=0 IWARN="00" S XWARN=$G(XWARN)_IWARN
"RTN","PSOTALK",213,0)
 Q XWARN
"RTN","PSOVERC")
0^9^B8973587^B9313505
"RTN","PSOVERC",1,0)
PSOVERC ;BHAM ISC/DMA,SAB - discontinue duplicate class from verify ; 07/22/95 17:11
"RTN","PSOVERC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**146,223,148,249**;DEC 1997;Build 9
"RTN","PSOVERC",3,0)
 W !,$C(7)," *** SAME CLASS *** OF DRUG IN RX # ",$P(^PSRX(+$P(RX0,"^"),0),"^"),"  ",$P(DRG,"^") Q:'$P(PSOPAR,"^",18)
"RTN","PSOVERC",4,0)
 S PTST="" I $D(^PS(55,PSDFN,"PS")) S Z=+^("PS") I $D(^PS(53,Z,0)) S PTST=^(0)
"RTN","PSOVERC",5,0)
DATA S DUPRX0=^PSRX($P(RX0,"^"),0),$P(DUPRX0,"^",15)=+$G(^("STA")),PSRFLS=$P(DUPRX0,"^",9),ISSD=$P(^(0),"^",13),RX0=DUPRX0,RX2=^(2),CAN=$P(DUPRX0,"^",15)'<11 K PSONULN S $P(PSONULN,"-",79)="-"
"RTN","PSOVERC",6,0)
 W !!,$J("Status: ",24) S J=$P(RX0,"^") D STAT^PSOFUNC W ST K RX0,RX2 W ?40,$J("Issued: ",24),$E(ISSD,4,5),"-",$E(ISSD,6,7),"-",$E(ISSD,2,3)
"RTN","PSOVERC",7,0)
 W !,$J("SIG: ",24),$P(DUPRX0,"^",10),!,$J("QTY: ",24),$P(DUPRX0,"^",7),?40,$J("# of refills: ",24),PSRFLS
"RTN","PSOVERC",8,0)
 S PHYS=$S($D(^VA(200,+$P(DUPRX0,"^",4),0)):^(0),1:"UNKNOWN")
"RTN","PSOVERC",9,0)
 W !,$J("Provider: ",24),$P(PHYS,"^"),?40,$J("Refills remaining: ",24),PSRFLS-$S($D(^PSRX($P(RX0,"^"),1,0)):$P(^(0),"^",4),1:0)
"RTN","PSOVERC",10,0)
 S LSTFL=+^PSRX($P(RX0,"^"),3) W !?40,$J("Last filled on: ",24),$E(LSTFL,4,5),"-",$E(LSTFL,6,7),"-",$E(LSTFL,2,3)
"RTN","PSOVERC",11,0)
 W !,PSONULN,! I (CAN)!($P(DUPRX0,"^",15)=12) S CAN=1 Q
"RTN","PSOVERC",12,0)
 I PTST["AUTH ABS",'$P(PSOPAR,"^",5) S X=1 Q
"RTN","PSOVERC",13,0)
ASKC S DIR("A")="Discontinue Prescription #"_$P(DUPRX0,"^")_" ",DIR("B")="N",DIR(0)="SA^1:YES;0:NO",DIR("?")="Enter Y to discontinue this Prescription." D ^DIR K DIR
"RTN","PSOVERC",14,0)
 I 'Y W "  Prescription was not discontinued..." Q
"RTN","PSOVERC",15,0)
CANOLD S $P(^PSRX($P(RX0,"^"),"STA"),"^")=12,$P(^PSRX($P(RX0,"^"),3),"^",5)=DT
"RTN","PSOVERC",16,0)
 S PSMSG="Discontinued by new prescription",PSREA="C",PSRXREF=0 N PSOVRCTP S PSOVRCTP=$P(RX0,"^") D REVERSE^PSOBPSU1(PSOVRCTP,,"DC",7),CAN^PSOTPCAN(PSOVRCTP) D ACTLOG
"RTN","PSOVERC",17,0)
 S PSI="",$P(PSD(DRG),"^",3)=12 W "  Prescription has been discontinued." S DA=$O(^PS(52.5,"B",$P(RX0,"^"),0)) I DA S PSI=$G(^PS(52.5,DA,"P")),DIK="^PS(52.5," D ^DIK K DIK,DA
"RTN","PSOVERC",18,0)
 D:'PSI SUSPCAN^PSOUTL
"RTN","PSOVERC",19,0)
 Q
"RTN","PSOVERC",20,0)
ACTLOG ;adds activity log for discontinuations
"RTN","PSOVERC",21,0)
 S RXF=0 F JJ=0:0 S JJ=$O(^PSRX($P(RX0,"^"),1,JJ)) Q:'JJ  S RXF=JJ S:JJ>5 RXF=JJ+1
"RTN","PSOVERC",22,0)
 S IR=0 F JJ=0:0 S JJ=$O(^PSRX($P(RX0,"^"),"A",JJ)) Q:'JJ  S IR=JJ
"RTN","PSOVERC",23,0)
 S IR=IR+1,^PSRX($P(RX0,"^"),"A",IR,0)=DT_"^C^"_DUZ_"^"_RXF_"^"_PSMSG K RXF,JJ,IR
"RTN","PSOVERC",24,0)
 Q
"VER")
8.0^22.0
"^DD",52,52,127,0)
LAST DISPENSED DATE HOLDER^D^^3;10^S %DT="EX" D ^%DT S X=Y K:Y<1 X
"^DD",52,52,127,21,0)
^^1^1^3060713^
"^DD",52,52,127,21,1,0)
This field is a holder for the last dispensed date.
"^DD",52,52,127,"DT")
3060713
"BLD",6330,6)
^235
**END**
**END**
