Released GMRA*4*17 SEQ #16
Extracted from mail message
**KIDS**:GMRA*4.0*17^

**INSTALL NAME**
GMRA*4.0*17
"BLD",4545,0)
GMRA*4.0*17^ADVERSE REACTION TRACKING^0^3031024^y
"BLD",4545,1,0)
^^2^2^3031024^^
"BLD",4545,1,1,0)
This patch includes a utility for updating free text entries.  Please see
"BLD",4545,1,2,0)
the FORUM patch description for a detailed explanation of this patch.
"BLD",4545,4,0)
^9.64PA^120.82^1
"BLD",4545,4,120.82,0)
120.82
"BLD",4545,4,120.82,2,0)
^9.641^120.823^2
"BLD",4545,4,120.82,2,120.82,0)
GMR ALLERGIES  (File-top level)
"BLD",4545,4,120.82,2,120.82,1,0)
^9.6411^.01^1
"BLD",4545,4,120.82,2,120.82,1,.01,0)
NAME
"BLD",4545,4,120.82,2,120.823,0)
SYNONYM  (sub-file)
"BLD",4545,4,120.82,2,120.823,1,0)
^9.6411^.01^1
"BLD",4545,4,120.82,2,120.823,1,.01,0)
SYNONYM
"BLD",4545,4,120.82,222)
y^n^p^^^^n^^n
"BLD",4545,4,120.82,224)

"BLD",4545,4,"APDD",120.82,120.82)

"BLD",4545,4,"APDD",120.82,120.82,.01)

"BLD",4545,4,"APDD",120.82,120.823)

"BLD",4545,4,"APDD",120.82,120.823,.01)

"BLD",4545,4,"B",120.82,120.82)

"BLD",4545,"ABPKG")
n
"BLD",4545,"INIT")
Q^GMRAY17
"BLD",4545,"KRN",0)
^9.67PA^8989.52^19
"BLD",4545,"KRN",.4,0)
.4
"BLD",4545,"KRN",.401,0)
.401
"BLD",4545,"KRN",.402,0)
.402
"BLD",4545,"KRN",.403,0)
.403
"BLD",4545,"KRN",.5,0)
.5
"BLD",4545,"KRN",.84,0)
.84
"BLD",4545,"KRN",3.6,0)
3.6
"BLD",4545,"KRN",3.8,0)
3.8
"BLD",4545,"KRN",3.8,"NM",0)
^9.68A^1^1
"BLD",4545,"KRN",3.8,"NM",1,0)
GMRA REQUEST NEW REACTANT^^0
"BLD",4545,"KRN",3.8,"NM","B","GMRA REQUEST NEW REACTANT",1)

"BLD",4545,"KRN",9.2,0)
9.2
"BLD",4545,"KRN",9.8,0)
9.8
"BLD",4545,"KRN",9.8,"NM",0)
^9.68A^16^16
"BLD",4545,"KRN",9.8,"NM",1,0)
GMRAFX^^0^B88087992
"BLD",4545,"KRN",9.8,"NM",2,0)
GMRAFX1^^0^B30858013
"BLD",4545,"KRN",9.8,"NM",3,0)
GMRAFX2^^0^B24744852
"BLD",4545,"KRN",9.8,"NM",4,0)
GMRAFX3^^0^B35641797
"BLD",4545,"KRN",9.8,"NM",5,0)
GMRAPES1^^0^B9930531
"BLD",4545,"KRN",9.8,"NM",6,0)
GMRAPES0^^0^B69402223
"BLD",4545,"KRN",9.8,"NM",7,0)
GMRAY17^^0^B33163113
"BLD",4545,"KRN",9.8,"NM",8,0)
GMRAPET0^^0^B19862734
"BLD",4545,"KRN",9.8,"NM",9,0)
GMRASIGN^^0^B37191101
"BLD",4545,"KRN",9.8,"NM",10,0)
GMRAPEM0^^0^B43111824
"BLD",4545,"KRN",9.8,"NM",11,0)
GMRAUTL^^0^B16078280
"BLD",4545,"KRN",9.8,"NM",12,0)
GMRASIG1^^0^B12179593
"BLD",4545,"KRN",9.8,"NM",13,0)
GMRAPED0^^0^B22812955
"BLD",4545,"KRN",9.8,"NM",14,0)
GMRAPEO0^^0^B6816187
"BLD",4545,"KRN",9.8,"NM",15,0)
GMRAOR7^^0^B2567375
"BLD",4545,"KRN",9.8,"NM",16,0)
GMRAOR6^^0^B3212051
"BLD",4545,"KRN",9.8,"NM","B","GMRAFX",1)

"BLD",4545,"KRN",9.8,"NM","B","GMRAFX1",2)

"BLD",4545,"KRN",9.8,"NM","B","GMRAFX2",3)

"BLD",4545,"KRN",9.8,"NM","B","GMRAFX3",4)

"BLD",4545,"KRN",9.8,"NM","B","GMRAOR6",16)

"BLD",4545,"KRN",9.8,"NM","B","GMRAOR7",15)

"BLD",4545,"KRN",9.8,"NM","B","GMRAPED0",13)

"BLD",4545,"KRN",9.8,"NM","B","GMRAPEM0",10)

"BLD",4545,"KRN",9.8,"NM","B","GMRAPEO0",14)

"BLD",4545,"KRN",9.8,"NM","B","GMRAPES0",6)

"BLD",4545,"KRN",9.8,"NM","B","GMRAPES1",5)

"BLD",4545,"KRN",9.8,"NM","B","GMRAPET0",8)

"BLD",4545,"KRN",9.8,"NM","B","GMRASIG1",12)

"BLD",4545,"KRN",9.8,"NM","B","GMRASIGN",9)

"BLD",4545,"KRN",9.8,"NM","B","GMRAUTL",11)

"BLD",4545,"KRN",9.8,"NM","B","GMRAY17",7)

"BLD",4545,"KRN",19,0)
19
"BLD",4545,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",4545,"KRN",19,"NM",1,0)
GMRA SITE FILE MENU^^2
"BLD",4545,"KRN",19,"NM",2,0)
GMRA FREE TEXT UTILITY^^0
"BLD",4545,"KRN",19,"NM","B","GMRA FREE TEXT UTILITY",2)

"BLD",4545,"KRN",19,"NM","B","GMRA SITE FILE MENU",1)

"BLD",4545,"KRN",19.1,0)
19.1
"BLD",4545,"KRN",101,0)
101
"BLD",4545,"KRN",101,"NM",0)
^9.68A^11^11
"BLD",4545,"KRN",101,"NM",1,0)
GMRA FIX FREE TEXT LIST^^0
"BLD",4545,"KRN",101,"NM",2,0)
GMRA FIX ADD/EDIT ALLERGY FILE^^0
"BLD",4545,"KRN",101,"NM",3,0)
GMRA FIX ENTERED IN ERROR^^0
"BLD",4545,"KRN",101,"NM",4,0)
GMRA FIX DETAIL LIST^^0
"BLD",4545,"KRN",101,"NM",5,0)
GMRA FIX DETAIL MENU^^0
"BLD",4545,"KRN",101,"NM",6,0)
GMRA FIX ENTERED IN ERROR IN DETAIL^^0
"BLD",4545,"KRN",101,"NM",7,0)
GMRA FIX UPDATE REACTANT^^0
"BLD",4545,"KRN",101,"NM",8,0)
GMRA FIX UPDATE REACTANT IN DETAIL^^0
"BLD",4545,"KRN",101,"NM",9,0)
GMRA FIX ADD/EDIT ALLERGY FILE IN DETAIL^^0
"BLD",4545,"KRN",101,"NM",10,0)
GMRA FIX PATIENT A/AR EDIT IN DETAIL^^0
"BLD",4545,"KRN",101,"NM",11,0)
GMRA FIX DETAIL IN DETAIL^^0
"BLD",4545,"KRN",101,"NM","B","GMRA FIX ADD/EDIT ALLERGY FILE",2)

"BLD",4545,"KRN",101,"NM","B","GMRA FIX ADD/EDIT ALLERGY FILE IN DETAIL",9)

"BLD",4545,"KRN",101,"NM","B","GMRA FIX DETAIL IN DETAIL",11)

"BLD",4545,"KRN",101,"NM","B","GMRA FIX DETAIL LIST",4)

"BLD",4545,"KRN",101,"NM","B","GMRA FIX DETAIL MENU",5)

"BLD",4545,"KRN",101,"NM","B","GMRA FIX ENTERED IN ERROR",3)

"BLD",4545,"KRN",101,"NM","B","GMRA FIX ENTERED IN ERROR IN DETAIL",6)

"BLD",4545,"KRN",101,"NM","B","GMRA FIX FREE TEXT LIST",1)

"BLD",4545,"KRN",101,"NM","B","GMRA FIX PATIENT A/AR EDIT IN DETAIL",10)

"BLD",4545,"KRN",101,"NM","B","GMRA FIX UPDATE REACTANT",7)

"BLD",4545,"KRN",101,"NM","B","GMRA FIX UPDATE REACTANT IN DETAIL",8)

"BLD",4545,"KRN",409.61,0)
409.61
"BLD",4545,"KRN",409.61,"NM",0)
^9.68A^2^2
"BLD",4545,"KRN",409.61,"NM",1,0)
GMRA FIX^^0
"BLD",4545,"KRN",409.61,"NM",2,0)
GMRA FIX DETAIL^^0
"BLD",4545,"KRN",409.61,"NM","B","GMRA FIX",1)

"BLD",4545,"KRN",409.61,"NM","B","GMRA FIX DETAIL",2)

"BLD",4545,"KRN",771,0)
771
"BLD",4545,"KRN",870,0)
870
"BLD",4545,"KRN",8989.51,0)
8989.51
"BLD",4545,"KRN",8989.52,0)
8989.52
"BLD",4545,"KRN",8994,0)
8994
"BLD",4545,"KRN","B",.4,.4)

"BLD",4545,"KRN","B",.401,.401)

"BLD",4545,"KRN","B",.402,.402)

"BLD",4545,"KRN","B",.403,.403)

"BLD",4545,"KRN","B",.5,.5)

"BLD",4545,"KRN","B",.84,.84)

"BLD",4545,"KRN","B",3.6,3.6)

"BLD",4545,"KRN","B",3.8,3.8)

"BLD",4545,"KRN","B",9.2,9.2)

"BLD",4545,"KRN","B",9.8,9.8)

"BLD",4545,"KRN","B",19,19)

"BLD",4545,"KRN","B",19.1,19.1)

"BLD",4545,"KRN","B",101,101)

"BLD",4545,"KRN","B",409.61,409.61)

"BLD",4545,"KRN","B",771,771)

"BLD",4545,"KRN","B",870,870)

"BLD",4545,"KRN","B",8989.51,8989.51)

"BLD",4545,"KRN","B",8989.52,8989.52)

"BLD",4545,"KRN","B",8994,8994)

"BLD",4545,"QUES",0)
^9.62^^
"BLD",4545,"REQB",0)
^9.611^4^3
"BLD",4545,"REQB",2,0)
GMRA*4.0*6^1
"BLD",4545,"REQB",3,0)
GMRA*4.0*14^1
"BLD",4545,"REQB",4,0)
GMRA*4.0*8^1
"BLD",4545,"REQB","B","GMRA*4.0*14",3)

"BLD",4545,"REQB","B","GMRA*4.0*6",2)

"BLD",4545,"REQB","B","GMRA*4.0*8",4)

"FIA",120.82)
GMR ALLERGIES
"FIA",120.82,0)
^GMRD(120.82,
"FIA",120.82,0,0)
120.82I
"FIA",120.82,0,1)
y^n^p^^^^n^^n
"FIA",120.82,0,10)

"FIA",120.82,0,11)

"FIA",120.82,0,"RLRO")

"FIA",120.82,0,"VR")
4.0^GMRA
"FIA",120.82,120.82)
1
"FIA",120.82,120.82,.01)

"FIA",120.82,120.82,3)

"FIA",120.82,120.823)
1
"FIA",120.82,120.823,.01)

"INIT")
Q^GMRAY17
"KRN",3.8,146,-1)
0^1
"KRN",3.8,146,0)
GMRA REQUEST NEW REACTANT^PU^n^^^^
"KRN",3.8,146,2,0)
^3.801^6^6^3030827^^^^
"KRN",3.8,146,2,1,0)
When adding a new allergy entry the user is prompted for the reactant.  
"KRN",3.8,146,2,2,0)
If the user cannot find a reactant to match their input then they are 
"KRN",3.8,146,2,3,0)
given the option to send an email message requesting that the new 
"KRN",3.8,146,2,4,0)
reactant be added.
"KRN",3.8,146,2,5,0)
 
"KRN",3.8,146,2,6,0)
Members of this mail group will be recipients of that message.
"KRN",3.8,146,3)

"KRN",19,2455,-1)
2^1
"KRN",19,2455,0)
GMRA SITE FILE MENU^Enter/Edit Site Configurable Files^^M^10^^^^^^^140
"KRN",19,2455,10,0)
^19.01IP^6^6
"KRN",19,2455,10,6,0)
9207^6
"KRN",19,2455,10,6,"^")
GMRA FREE TEXT UTILITY
"KRN",19,2455,"U")
ENTER/EDIT SITE CONFIGURABLE F
"KRN",19,9207,-1)
0^2
"KRN",19,9207,0)
GMRA FREE TEXT UTILITY^Free text allergy clean up utility^^R^^^^^^^^
"KRN",19,9207,1,0)
^^6^6^3030728^
"KRN",19,9207,1,1,0)
This utility will search the patient allergy file (120.8) for free text 
"KRN",19,9207,1,2,0)
reactants.  The user will then be allowed to either update the reactant 
"KRN",19,9207,1,3,0)
to an existing reactant or they can mark the allergy as entered in error.
"KRN",19,9207,1,4,0)
 
"KRN",19,9207,1,5,0)
New reactants can be added to the GMR ALLERGIES file (120.82) as local 
"KRN",19,9207,1,6,0)
entries if they are not found in any existing files.
"KRN",19,9207,25)
GMRAFX
"KRN",19,9207,"U")
FREE TEXT ALLERGY CLEAN UP UTI
"KRN",101,6274,-1)
0^1
"KRN",101,6274,0)
GMRA FIX FREE TEXT LIST^Free text entries^^M^^^^^^^^
"KRN",101,6274,4)
25^4
"KRN",101,6274,10,0)
^101.01PA^4^4
"KRN",101,6274,10,1,0)
6275^AE^^
"KRN",101,6274,10,1,"^")
GMRA FIX ADD/EDIT ALLERGY FILE
"KRN",101,6274,10,2,0)
6276^EE^^
"KRN",101,6274,10,2,"^")
GMRA FIX ENTERED IN ERROR
"KRN",101,6274,10,3,0)
6313^DD^^
"KRN",101,6274,10,3,"^")
GMRA FIX DETAIL LIST
"KRN",101,6274,10,4,0)
6336^UR^^
"KRN",101,6274,10,4,"^")
GMRA FIX UPDATE REACTANT
"KRN",101,6274,15)

"KRN",101,6274,20)
D:'$D(^XTMP("GMRAFX","IDX")) LIST^GMRAFX D CHKSEL^GMRAFX
"KRN",101,6274,26)
D PHDR^GMRAFX
"KRN",101,6274,99)
59273,41275
"KRN",101,6275,-1)
0^2
"KRN",101,6275,0)
GMRA FIX ADD/EDIT ALLERGY FILE^Add/Edit Allergy File^^A^^^^^^^^
"KRN",101,6275,15)
D DESELECT^GMRAFX
"KRN",101,6275,20)
D AEA^GMRAFX
"KRN",101,6275,99)
59129,35320
"KRN",101,6276,-1)
0^3
"KRN",101,6276,0)
GMRA FIX ENTERED IN ERROR^Mark entered in error^^A^^^^^^^^
"KRN",101,6276,15)
D DESELECT^GMRAFX
"KRN",101,6276,20)
D PROCESS^GMRAFX("E")
"KRN",101,6276,99)
59130,35292
"KRN",101,6313,-1)
0^4
"KRN",101,6313,0)
GMRA FIX DETAIL LIST^Detailed Display^^A^^^^^^^^
"KRN",101,6313,15)
D DESELECT^GMRAFX
"KRN",101,6313,20)
D EN^VALM("GMRA FIX DETAIL")
"KRN",101,6313,99)
59252,54990
"KRN",101,6314,-1)
0^5
"KRN",101,6314,0)
GMRA FIX DETAIL MENU^^^M^^^^^^^^
"KRN",101,6314,4)
27^4
"KRN",101,6314,10,0)
^101.01PA^5^5
"KRN",101,6314,10,1,0)
6335^EE^1^
"KRN",101,6314,10,1,"^")
GMRA FIX ENTERED IN ERROR IN DETAIL
"KRN",101,6314,10,2,0)
6337^UR^2^
"KRN",101,6314,10,2,"^")
GMRA FIX UPDATE REACTANT IN DETAIL
"KRN",101,6314,10,3,0)
6371^AE^3^
"KRN",101,6314,10,3,"^")
GMRA FIX ADD/EDIT ALLERGY FILE IN DETAIL
"KRN",101,6314,10,4,0)
6397^PR^4^
"KRN",101,6314,10,4,"^")
GMRA FIX PATIENT A/AR EDIT IN DETAIL
"KRN",101,6314,10,5,0)
6485^DD^5^
"KRN",101,6314,10,5,"^")
GMRA FIX DETAIL IN DETAIL
"KRN",101,6314,15)

"KRN",101,6314,20)
D DET^GMRAFX1,CHKSEL^GMRAFX1
"KRN",101,6314,26)
D PHDR^GMRAFX1
"KRN",101,6314,99)
59465,50487
"KRN",101,6335,-1)
0^6
"KRN",101,6335,0)
GMRA FIX ENTERED IN ERROR IN DETAIL^Entered in Error^^A^^^^^^^^
"KRN",101,6335,15)
D DESELECT^GMRAFX1
"KRN",101,6335,20)
D PROCESS^GMRAFX1("E")
"KRN",101,6335,99)
59267,34190
"KRN",101,6336,-1)
0^7
"KRN",101,6336,0)
GMRA FIX UPDATE REACTANT^Update to new reactant^^A^^^^^^^^
"KRN",101,6336,15)
D DESELECT^GMRAFX
"KRN",101,6336,20)
D PROCESS^GMRAFX("U")
"KRN",101,6336,99)
59273,41196
"KRN",101,6337,-1)
0^8
"KRN",101,6337,0)
GMRA FIX UPDATE REACTANT IN DETAIL^Update to new reactant^^A^^^^^^^^
"KRN",101,6337,15)
D DESELECT^GMRAFX1
"KRN",101,6337,20)
D PROCESS^GMRAFX1("U")
"KRN",101,6337,99)
59273,42349
"KRN",101,6371,-1)
0^9
"KRN",101,6371,0)
GMRA FIX ADD/EDIT ALLERGY FILE IN DETAIL^Add/Edit Allergy File^^A^^^^^^^^
"KRN",101,6371,15)
D DESELECT^GMRAFX1
"KRN",101,6371,20)
D AEA^GMRAFX
"KRN",101,6371,99)
59401,39037
"KRN",101,6397,-1)
0^10
"KRN",101,6397,0)
GMRA FIX PATIENT A/AR EDIT IN DETAIL^Add/Edit Patient Reaction^^A^^^^^^^^
"KRN",101,6397,15)
D DESELECT^GMRAFX1
"KRN",101,6397,20)
D AR^GMRAFX3
"KRN",101,6397,99)
59424,46552
"KRN",101,6485,-1)
0^11
"KRN",101,6485,0)
GMRA FIX DETAIL IN DETAIL^Free Text Detailed Display^^A^^^^^^^^
"KRN",101,6485,15)
D DESELECT^GMRAFX1
"KRN",101,6485,20)
D DSPREACT^GMRAFX3
"KRN",101,6485,99)
59465,50476
"KRN",409.61,882,-1)
0^1
"KRN",409.61,882,0)
GMRA FIX^1^^80^4^20^0^1^^GMRA FIX FREE TEXT LIST^Allergy Tracking Update^1^^1
"KRN",409.61,882,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,882,"ARRAY")
 ^XTMP("GMRAFX")
"KRN",409.61,882,"COL",0)
^409.621^2^2
"KRN",409.61,882,"COL",1,0)
REACTANT^5^40^Reactant
"KRN",409.61,882,"COL",2,0)
ACTIVE^46^16^# Active Entries
"KRN",409.61,882,"COL","B","ACTIVE",2)

"KRN",409.61,882,"COL","B","REACTANT",1)

"KRN",409.61,882,"FNL")
D EXIT^GMRAFX
"KRN",409.61,882,"HDR")
D HDR^GMRAFX
"KRN",409.61,882,"HLP")
D HELP^GMRAFX
"KRN",409.61,882,"INIT")
D INIT^GMRAFX
"KRN",409.61,885,-1)
0^2
"KRN",409.61,885,0)
GMRA FIX DETAIL^1^^160^4^19^0^1^^GMRA FIX DETAIL MENU^Reactant Detailed Display^1^^1
"KRN",409.61,885,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,885,"ARRAY")
 ^TMP($J,"GMRADET")
"KRN",409.61,885,"COL",0)
^409.621^2^2
"KRN",409.61,885,"COL",1,0)
NAME^5^30^Patient Name
"KRN",409.61,885,"COL",2,0)
SSN^36^6^Last 4
"KRN",409.61,885,"COL","B","NAME",1)

"KRN",409.61,885,"COL","B","SSN",2)

"KRN",409.61,885,"FNL")
D EXIT^GMRAFX1
"KRN",409.61,885,"HDR")
D HDR^GMRAFX1
"KRN",409.61,885,"HLP")
D HELP^GMRAFX1
"KRN",409.61,885,"INIT")
D INIT^GMRAFX1
"MBREQ")
0
"ORD",11,3.8)
3.8;11;;;MAILG^XPDTA1;MAILGF1^XPDIA1;MAILGE1^XPDIA1;MAILGF2^XPDIA1;;MAILGDEL^XPDIA1(%)
"ORD",11,3.8,0)
MAIL GROUP
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"ORD",17,409.61)
409.61;17;1;;;;;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",140,-1)
1^1
"PKG",140,0)
ADVERSE REACTION TRACKING^GMRA^Allergy Tracking System
"PKG",140,20,0)
^9.402P^^
"PKG",140,22,0)
^9.49I^1^1
"PKG",140,22,1,0)
4.0^2960328^2960506^10
"PKG",140,22,1,"PAH",1,0)
17^3031024
"PKG",140,22,1,"PAH",1,1,0)
^^2^2^3031024
"PKG",140,22,1,"PAH",1,1,1,0)
This patch includes a utility for updating free text entries.  Please see
"PKG",140,22,1,"PAH",1,1,2,0)
the FORUM patch description for a detailed explanation of this patch.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
16
"RTN","GMRAFX")
0^1^B88087992
"RTN","GMRAFX",1,0)
GMRAFX ;SLC/DAN Fix existing free text entries ;10/23/03  14:55
"RTN","GMRAFX",2,0)
 ;;4.0;Adverse Reaction Tracking;**17**;Mar 29, 1996
"RTN","GMRAFX",3,0)
 ;DBIA SECTION
"RTN","GMRAFX",4,0)
 ;10118 - VALM
"RTN","GMRAFX",5,0)
 ;2056  - DIQ
"RTN","GMRAFX",6,0)
 ;3744  - $$TESTPAT^VADPT
"RTN","GMRAFX",7,0)
 ;10006 - DIC
"RTN","GMRAFX",8,0)
 ;10103 - XLFDT
"RTN","GMRAFX",9,0)
 ;10102 - XQORM1
"RTN","GMRAFX",10,0)
 ;10104 - XLFSTR
"RTN","GMRAFX",11,0)
 ;10117 - VALM10
"RTN","GMRAFX",12,0)
 ;10116 - VALM1
"RTN","GMRAFX",13,0)
 ;10026 - DIR
"RTN","GMRAFX",14,0)
 ;10018 - DIE
"RTN","GMRAFX",15,0)
 ;10013 - DIK
"RTN","GMRAFX",16,0)
 ;10061 - VADPT
"RTN","GMRAFX",17,0)
 ;10101 - XQOR
"RTN","GMRAFX",18,0)
 ;
"RTN","GMRAFX",19,0)
EN ; -- main entry point for GMRA FIX
"RTN","GMRAFX",20,0)
 N NMBR,REBLD,Y,DIR,I
"RTN","GMRAFX",21,0)
 I $D(^XTMP("GMRAFX","B")) W !,"The list is currently being built by another user so this option is",!,"temporarily unavailable.  Please try again in a few minutes." Q
"RTN","GMRAFX",22,0)
 I $D(^XTMP("GMRAFX","INUSE")) D
"RTN","GMRAFX",23,0)
 .W !,"The utility is currently in use by the following people:",!
"RTN","GMRAFX",24,0)
 .S I=0 F  S I=$O(^XTMP("GMRAFX","INUSE",I)) Q:'+I  W !,$$GET1^DIQ(200,I,.01)
"RTN","GMRAFX",25,0)
 .W !!,"As a result, the existing free text list will be used." D WAIT^GMRAFX3
"RTN","GMRAFX",26,0)
 I $D(^XTMP("GMRAFX")),'$D(^XTMP("GMRAFX","INUSE")) D
"RTN","GMRAFX",27,0)
 .W !,"The free text list was last built on ",$$FMTE^XLFDT($P(^XTMP("GMRAFX",0),U,2)),!
"RTN","GMRAFX",28,0)
 .S DIR(0)="Y",DIR("A")="Do you want to rebuild the list",DIR("B")="NO",DIR("?")="Enter yes to rebuild the list of free text entries.  Enter NO to use the currently existing list"
"RTN","GMRAFX",29,0)
 .D ^DIR I Y=1 K ^XTMP("GMRAFX") S REBLD=1
"RTN","GMRAFX",30,0)
 I $G(REBLD)!('$D(^XTMP("GMRAFX"))) W !,"Building list of free text allergies...this may take a few minutes",!
"RTN","GMRAFX",31,0)
 S ^XTMP("GMRAFX","INUSE",+$G(DUZ))=""
"RTN","GMRAFX",32,0)
 D EN^VALM("GMRA FIX")
"RTN","GMRAFX",33,0)
 K ^XTMP("GMRAFX","INUSE",+$G(DUZ))
"RTN","GMRAFX",34,0)
 Q
"RTN","GMRAFX",35,0)
 ;
"RTN","GMRAFX",36,0)
HDR ; -- header code
"RTN","GMRAFX",37,0)
 S VALMHDR(1)="Allergy Tracking Free Text Entries"
"RTN","GMRAFX",38,0)
 Q
"RTN","GMRAFX",39,0)
PHDR ;
"RTN","GMRAFX",40,0)
 S VALMSG="Select one or more entries"
"RTN","GMRAFX",41,0)
 S XQORM("#")=$O(^ORD(101,"B","GMRA FIX FREE TEXT LIST",0))
"RTN","GMRAFX",42,0)
 D SHOW^VALM
"RTN","GMRAFX",43,0)
 Q
"RTN","GMRAFX",44,0)
 ;
"RTN","GMRAFX",45,0)
INIT ;Initialize variables, etc
"RTN","GMRAFX",46,0)
 S VALMBCK="",VALMBG=$S($G(VALMBG)'="":VALMBG,1:1),VALMCNT=$S($D(^XTMP("GMRAFX",0)):$P(^(0),U,3),1:0),VALMWD=80
"RTN","GMRAFX",47,0)
 Q
"RTN","GMRAFX",48,0)
LIST ; -- obtain and display list of free text allergies
"RTN","GMRAFX",49,0)
 N GMRAIEN,GMRAOTH,GMRATXT,GMRAUTXT,SP1,SP2,SP3,UP,TXT
"RTN","GMRAFX",50,0)
 S VALMBCK="R",VALMCNT=0
"RTN","GMRAFX",51,0)
 K ^XTMP("GMRAFX") S ^XTMP("GMRAFX","B")="",^XTMP("GMRAFX","INUSE",+$G(DUZ))=""
"RTN","GMRAFX",52,0)
 S GMRAOTH=$O(^GMRD(120.82,"B","OTHER ALLERGY/ADVERSE REACTION",0))_";GMRD(120.82," ;Gets IEN;FILE ENTRY for free text entries
"RTN","GMRAFX",53,0)
 S GMRAIEN=0 F  S GMRAIEN=$O(^GMR(120.8,GMRAIEN)) Q:'+GMRAIEN  I $P($G(^(GMRAIEN,0)),U,3)=GMRAOTH D
"RTN","GMRAFX",54,0)
 .Q:+$G(^GMR(120.8,GMRAIEN,"ER"))  ;Quit if reactant entered in error
"RTN","GMRAFX",55,0)
 .Q:$$DECEASED(+$P($G(^GMR(120.8,GMRAIEN,0)),U))  ;Don't report expired patients
"RTN","GMRAFX",56,0)
 .Q:$$TESTPAT^VADPT($P($G(^GMR(120.8,GMRAIEN,0)),U))  ;Don't report test patients
"RTN","GMRAFX",57,0)
 .S GMRATXT=$E($P($G(^GMR(120.8,GMRAIEN,0)),U,2),1,75) ;Get "reactant" text entry, no more than 75 characters
"RTN","GMRAFX",58,0)
 .S GMRAUTXT=$$UP^XLFSTR(GMRATXT) ;Convert to upper case
"RTN","GMRAFX",59,0)
 .S ^XTMP("GMRAFX","GMRAR",GMRAUTXT,GMRATXT)=$G(^XTMP("GMRAFX","GMRAR",GMRAUTXT,GMRATXT))+1 ;Local array of free text entries = active
"RTN","GMRAFX",60,0)
 .S ^XTMP("GMRAFX","GMRAR",GMRAUTXT,GMRATXT,GMRAIEN)="" ;Store entry number
"RTN","GMRAFX",61,0)
 .Q
"RTN","GMRAFX",62,0)
 S UP="" F  S UP=$O(^XTMP("GMRAFX","GMRAR",UP)) Q:UP=""  S TXT="" F  S TXT=$O(^XTMP("GMRAFX","GMRAR",UP,TXT)) Q:TXT=""  D
"RTN","GMRAFX",63,0)
 .S VALMCNT=VALMCNT+1
"RTN","GMRAFX",64,0)
 .S SP1=4-$L(VALMCNT),SP2=40-$L(TXT),SP3=16-$L(^XTMP("GMRAFX","GMRAR",UP,TXT))\2 ;Set up spacing before storing
"RTN","GMRAFX",65,0)
 .D SET^VALM10(VALMCNT,VALMCNT_$$REPEAT^XLFSTR(" ",SP1)_TXT_$$REPEAT^XLFSTR(" ",SP2)_$$REPEAT^XLFSTR(" ",SP3)_^XTMP("GMRAFX","GMRAR",UP,TXT))
"RTN","GMRAFX",66,0)
 .S ^XTMP("GMRAFX","IDX",VALMCNT)=UP_"^"_TXT
"RTN","GMRAFX",67,0)
 K ^XTMP("GMRAFX","B") ;Done building
"RTN","GMRAFX",68,0)
 S ^XTMP("GMRAFX",0)=$$FMADD^XLFDT(DT,30)_U_DT_U_$G(VALMCNT)
"RTN","GMRAFX",69,0)
 Q
"RTN","GMRAFX",70,0)
 ;
"RTN","GMRAFX",71,0)
HELP ; -- help code
"RTN","GMRAFX",72,0)
 D FULL^VALM1
"RTN","GMRAFX",73,0)
 W !!,"Use AE to add local allergies to the GMR ALLERGY file.  This",!,"should only be done if you're sure no existing reactant matches your needs."
"RTN","GMRAFX",74,0)
 W !!,"Use EE to mark all entries within the selected group as entered",!,"in error.  You may select multiple groups if you like."
"RTN","GMRAFX",75,0)
 W !!,"Use DD to get a detailed display.  It's highly recommended that you",!,"use the detailed display menu to make all changes."
"RTN","GMRAFX",76,0)
 W !!,"Use UR to update the reactant.  Extreme caution should be used when doing",!,"mass updates.  It would be better to do the updates from within",!,"the detailed display menu.",!
"RTN","GMRAFX",77,0)
 D WAIT^GMRAFX3 S VALMBCK="R"
"RTN","GMRAFX",78,0)
 Q
"RTN","GMRAFX",79,0)
 ;
"RTN","GMRAFX",80,0)
EXIT ; -- exit code
"RTN","GMRAFX",81,0)
 D FULL^VALM1
"RTN","GMRAFX",82,0)
 D DESELECT  ;Clear any remaining items
"RTN","GMRAFX",83,0)
 Q
"RTN","GMRAFX",84,0)
 ;
"RTN","GMRAFX",85,0)
EXPND ; -- expand code
"RTN","GMRAFX",86,0)
 Q
"RTN","GMRAFX",87,0)
 ;
"RTN","GMRAFX",88,0)
CHKSEL ;Evaluate selection if done by number
"RTN","GMRAFX",89,0)
 N J,TMP,DIR,NUM,X,Y,TNMBR
"RTN","GMRAFX",90,0)
 S VALMBCK="R"
"RTN","GMRAFX",91,0)
 S NUM=$P($G(XQORNOD(0)),"=",2) ;get currently selected entries
"RTN","GMRAFX",92,0)
 I NUM'="" D
"RTN","GMRAFX",93,0)
 .I NUM=$G(NMBR) D DESELECT Q  ;If user selects same entry without taking an entry, unhighlight and stop processing
"RTN","GMRAFX",94,0)
 .D DESELECT:$G(NMBR) ;If user previously selected entries but took no action, unhighlight before highlighting new choices
"RTN","GMRAFX",95,0)
 .S NMBR=$P(XQORNOD(0),"=",2),DIR(0)="L^"_"1:"_VALMCNT,X=NMBR,DIR("V")="" D ^DIR K DIR
"RTN","GMRAFX",96,0)
 .I Y="" D FULL^VALM1 W !,"Invalid selection." D WAIT^GMRAFX3 K NMBR Q  ;Selection out of range, stop processing
"RTN","GMRAFX",97,0)
 .S TNMBR=""
"RTN","GMRAFX",98,0)
 .F J=1:1:$L(NMBR,",")-1 S TMP=$P(NMBR,",",J) I $$LOCK^GMRAFX3(TMP) S TNMBR=TNMBR_TMP_"," D CNTRL^VALM10(TMP,1,+$G(VALMWD),IORVON,IORVOFF)
"RTN","GMRAFX",99,0)
 .I TNMBR="" K NMBR Q
"RTN","GMRAFX",100,0)
 .S NMBR=TNMBR
"RTN","GMRAFX",101,0)
 Q
"RTN","GMRAFX",102,0)
 ;
"RTN","GMRAFX",103,0)
DESELECT ;Un-highlight selected choices
"RTN","GMRAFX",104,0)
 N J,TMP
"RTN","GMRAFX",105,0)
 F J=1:1:$L($G(NMBR),",")-1 S TMP=$P(NMBR,",",J) D CNTRL^VALM10(TMP,1,+$G(VALMWD),IORVOFF,IORVOFF) L -^XTMP("GMRAFX","IDX",TMP)
"RTN","GMRAFX",106,0)
 K NMBR
"RTN","GMRAFX",107,0)
 Q
"RTN","GMRAFX",108,0)
 ;
"RTN","GMRAFX",109,0)
AEA ; Entry for GMRA LOCAL ALLERGIES EDIT option
"RTN","GMRAFX",110,0)
 N DLAYGO,DIC,Y,GMRAIEN,DA,GMRALN,DIE,GMRACT,DR,GMRAX,GMRAY,X
"RTN","GMRAFX",111,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX",112,0)
 W ! S DLAYGO=120.82,DIC="^GMRD(120.82,",DIC("A")="Select a LOCAL ALLERGY/ADVERSE REACTION: ",DIC(0)="AEQML",DIC("DR")="1" D ^DIC K DIC,DLAYGO Q:+Y'>0  S (DA,GMRAIEN)=+Y
"RTN","GMRAFX",113,0)
 L +^GMRD(120.82,GMRAIEN):1 I '$T W !,"THIS ENTRY IS BEING EDITED BY SOMEONE ELSE" Q
"RTN","GMRAFX",114,0)
 S GMRALN=$G(^GMRD(120.82,GMRAIEN,0))
"RTN","GMRAFX",115,0)
 S DIE="^GMRD(120.82,",DR="",GMRACT=1
"RTN","GMRAFX",116,0)
 I +$P(GMRALN,U,3) S DR(1,120.82,1)="@1;W !!,$C(7),""CANNOT EDIT NAME FIELD OF A NATIONAL ALLERGY."",!;3;"
"RTN","GMRAFX",117,0)
 E  D
"RTN","GMRAFX",118,0)
 .S DR(1,120.82,1)=".01;3;"
"RTN","GMRAFX",119,0)
 .S DR(1,120.82,2)="S (GMRAY,GMRAX)=$P(GMRALN,U,2) D EDTTYPE^GMRAUTL(.GMRAX);"
"RTN","GMRAFX",120,0)
 .S DR(1,120.82,3)="S:GMRAX=GMRAY!(""^^""[GMRAX) X=GMRAX,Y=$S(""^^""[GMRAX:""@3"",1:""@4"");1///^S X=GMRAX;@4;4;5;@3;"
"RTN","GMRAFX",121,0)
 .Q
"RTN","GMRAFX",122,0)
 D ^DIE
"RTN","GMRAFX",123,0)
 L -^GMRD(120.82,GMRAIEN)
"RTN","GMRAFX",124,0)
 Q
"RTN","GMRAFX",125,0)
 ;
"RTN","GMRAFX",126,0)
PROCESS(TYPE) ;API to mark all entries as entered in error or update entries to new reactant
"RTN","GMRAFX",127,0)
 N GMRAPA,GMRAI,GMRAJ,DIR,Y,ROOT,NUM,ENTRY,GMRADONE,STOP,J,TNMBR,GMRAAR
"RTN","GMRAFX",128,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX",129,0)
 I '$G(NMBR) S NMBR=$$GETNUM^GMRAFX3("") Q:'+NMBR  D  Q:'+$G(NMBR)
"RTN","GMRAFX",130,0)
 .S TNMBR=""
"RTN","GMRAFX",131,0)
 .F J=1:1:$L(NMBR,",")-1 S TMP=$P(NMBR,",",J) I $$LOCK^GMRAFX3(TMP) S TNMBR=TNMBR_TMP_","
"RTN","GMRAFX",132,0)
 .I TNMBR="" K NMBR Q
"RTN","GMRAFX",133,0)
 .S NMBR=TNMBR
"RTN","GMRAFX",134,0)
 I TYPE="U" W !!,"You should use the detailed display option to review entries in",!,"this group before doing a mass update.  CHANGES CANNOT BE UN-DONE!" D WAIT^GMRAFX3
"RTN","GMRAFX",135,0)
 W !!,"You are about to ",$S(TYPE="E":"mark",1:"update")," ALL allergies with the selected reactant ",!,$S(TYPE="E":"as entered in error.",1:"to a new reactant."),!
"RTN","GMRAFX",136,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="ARE YOU SURE"
"RTN","GMRAFX",137,0)
 S DIR("?")="If you're unsure, use the 'detailed display' option to get a list of individual patients."
"RTN","GMRAFX",138,0)
 S DIR("?",1)="Answering YES to this prompt will cause all allergies associated with"
"RTN","GMRAFX",139,0)
 S DIR("?",2)="the selected reactant to be "_$S(TYPE="E":"marked as entered in error.",1:"updated to the new reactant.")
"RTN","GMRAFX",140,0)
 S DIR("?",3)=""
"RTN","GMRAFX",141,0)
 S DIR("?",4)="Be SURE this is what you want to do."
"RTN","GMRAFX",142,0)
 D ^DIR Q:Y'=1  ;Stop if user doesn't answer yes
"RTN","GMRAFX",143,0)
 F GMRAI=1:1:($L(NMBR,",")-1) D
"RTN","GMRAFX",144,0)
 .S NUM=$P(NMBR,",",GMRAI),ENTRY=^XTMP("GMRAFX","IDX",NUM),STOP=0
"RTN","GMRAFX",145,0)
 .S ROOT="^XTMP(""GMRAFX"",""GMRAR"","_""""_$P(ENTRY,"^")_""""_","_""""_$P(ENTRY,"^",2)_""""_")",GMRAJ=0 Q:'@ROOT
"RTN","GMRAFX",146,0)
 .I TYPE="U" W !!,"Updating ",$P(ENTRY,U)," reactions"
"RTN","GMRAFX",147,0)
 .F  S GMRAJ=$O(@ROOT@(GMRAJ)) Q:GMRAJ=""!($G(STOP))  I GMRAJ D
"RTN","GMRAFX",148,0)
 ..S GMRAPA=GMRAJ,GMRADONE=1 D @$S(TYPE="E":"EIE",1:"UIE^GMRAFX3")
"RTN","GMRAFX",149,0)
 ..D:GMRADONE UPDATE^GMRAFX3
"RTN","GMRAFX",150,0)
 Q
"RTN","GMRAFX",151,0)
 ;
"RTN","GMRAFX",152,0)
EIE ;Mark individual entry as entered in error
"RTN","GMRAFX",153,0)
 N DIE,DA,DR,Y,DIK,DFN,OROLD,VAIN,X,GMRAOUT
"RTN","GMRAFX",154,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR="22///1;23///NOW;24////"_$G(DUZ,.5)
"RTN","GMRAFX",155,0)
 D ^DIE ;Entered in error on date/time by user
"RTN","GMRAFX",156,0)
 D ADCOM(GMRAPA,"E","Marked Entered in Error during clean up process")
"RTN","GMRAFX",157,0)
 I $$NKASCR^GMRANKA($P(^GMR(120.8,GMRAPA,0),U)) D
"RTN","GMRAFX",158,0)
 .S DIK="^GMR(120.86,",DA=$P(^GMR(120.8,GMRAPA,0),U)
"RTN","GMRAFX",159,0)
 .D ^DIK ;If patient's last allergy marked as entered in error then delete assessment
"RTN","GMRAFX",160,0)
 .W !!,"**NOTE: By marking this reaction as entered in error, ",$$GET1^DIQ(2,DA,.01,"E"),!,"no longer has an assessment on file.  You may reassess this patient",!
"RTN","GMRAFX",161,0)
 .W "now by answering the following prompt or hit return to do it later.",!
"RTN","GMRAFX",162,0)
 .D NKAASK^GMRANKA(DA)
"RTN","GMRAFX",163,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAFX",164,0)
 S GMRAOUT=0
"RTN","GMRAFX",165,0)
 D EN1^GMRAEAB ;Sends entered in error bulletin to appropriate mail groups
"RTN","GMRAFX",166,0)
 S DFN=$P(GMRAPA(0),U)
"RTN","GMRAFX",167,0)
 D INP^VADPT S X=$O(^ORD(101,"B","GMRA ENTERED IN ERROR",0))_";ORD(101,"
"RTN","GMRAFX",168,0)
 D:X EN^XQOR ;Process protocols hanging off of "entered in error" protocol
"RTN","GMRAFX",169,0)
 Q
"RTN","GMRAFX",170,0)
 ;
"RTN","GMRAFX",171,0)
DECEASED(GMRAIFN) ;Function returns 1 if patient is deceased, 0 if living
"RTN","GMRAFX",172,0)
 N DFN,VADM
"RTN","GMRAFX",173,0)
 Q:GMRAIFN=0 1  ;If no patient entry return true
"RTN","GMRAFX",174,0)
 S DFN=GMRAIFN
"RTN","GMRAFX",175,0)
 D DEM^VADPT
"RTN","GMRAFX",176,0)
 Q $S(+VADM(6):1,1:0)  ;VADM(6) holds date of death
"RTN","GMRAFX",177,0)
 ;
"RTN","GMRAFX",178,0)
ADCOM(ENTRY,TYPE,COM) ;Add comment to allergy
"RTN","GMRAFX",179,0)
 N DIC,DIE,DR,DA,Y,X
"RTN","GMRAFX",180,0)
 S DA(1)=ENTRY
"RTN","GMRAFX",181,0)
 S DIC="^GMR(120.8,"_DA(1)_",26,",DIC(0)="L",X=$$NOW^XLFDT
"RTN","GMRAFX",182,0)
 D ^DIC Q:Y=-1  ;add new comment multiple
"RTN","GMRAFX",183,0)
 S DA=+Y
"RTN","GMRAFX",184,0)
 S DIE=DIC K DIC
"RTN","GMRAFX",185,0)
 S DR="1////"_$G(DUZ,.5)_";1.5///"_TYPE_";2///"_$TR(COM,";"," ") ;remove semi-colon from free text
"RTN","GMRAFX",186,0)
 D ^DIE ;Comment added by user
"RTN","GMRAFX",187,0)
 Q
"RTN","GMRAFX1")
0^2^B30858013
"RTN","GMRAFX1",1,0)
GMRAFX1 ;SLC/DAN Fix existing free text entries-continued ;10/23/03  15:05
"RTN","GMRAFX1",2,0)
 ;;4.0;Adverse Reaction Tracking;**17**;Mar 29, 1996
"RTN","GMRAFX1",3,0)
 ;DBIA SECTION
"RTN","GMRAFX1",4,0)
 ;10116 - VALM1
"RTN","GMRAFX1",5,0)
 ;10102 - XQORM1
"RTN","GMRAFX1",6,0)
 ;10104 - XLFSTR
"RTN","GMRAFX1",7,0)
 ;10061 - VADPT
"RTN","GMRAFX1",8,0)
 ;10017 - VALM10
"RTN","GMRAFX1",9,0)
 ;10118 - VALM
"RTN","GMRAFX1",10,0)
 ;10026 - DIR
"RTN","GMRAFX1",11,0)
 ;
"RTN","GMRAFX1",12,0)
DET ;Detailed listing of selected group
"RTN","GMRAFX1",13,0)
 N DIR,Y,DTOUT,DUOUT,DIRUT,J,GMRAT,GMRAUT,DFN,GMRA,GMRAL,VADM,CNT,VAERR,K,LEN,NAME,ENTRY,NMBR2,ENMBR,GMRAR
"RTN","GMRAFX1",14,0)
 S VALMBCK="R",CNT=0
"RTN","GMRAFX1",15,0)
 K ^TMP($J,"GMRADET"),^TMP($J,"IDX2")
"RTN","GMRAFX1",16,0)
 S ENMBR=+NMBR ;get number portion of entry
"RTN","GMRAFX1",17,0)
 S ENTRY=0
"RTN","GMRAFX1",18,0)
 S GMRAUT=$P(^XTMP("GMRAFX","IDX",ENMBR),"^"),GMRAT=$P(^XTMP("GMRAFX","IDX",ENMBR),"^",2)
"RTN","GMRAFX1",19,0)
 S J=0 F  S J=$O(^XTMP("GMRAFX","GMRAR",GMRAUT,GMRAT,J)) Q:'+J  D
"RTN","GMRAFX1",20,0)
 .S DFN=$P($G(^GMR(120.8,J,0)),"^"),GMRA="0^0^111" D ^GMRADPT ;Get patient allergies
"RTN","GMRAFX1",21,0)
 .D DEM^VADPT ;Get patient information
"RTN","GMRAFX1",22,0)
 .Q:$G(VAERR)  ;Quit if patient lookup produces an error
"RTN","GMRAFX1",23,0)
 .S CNT=CNT+1,ENTRY=ENTRY+1
"RTN","GMRAFX1",24,0)
 .S GMRAR(CNT)=VADM(1)_$$REPEAT^XLFSTR(" ",(32-$L(VADM(1))))_$E(VADM(2),6,9)_" "
"RTN","GMRAFX1",25,0)
 .D SET^VALM10(CNT,ENTRY_$$REPEAT^XLFSTR(" ",(4-$L(ENTRY)))_GMRAR(CNT))
"RTN","GMRAFX1",26,0)
 .S ^TMP($J,"IDX2",ENTRY)=CNT_"^"_J
"RTN","GMRAFX1",27,0)
 .S CNT=CNT+1,LEN=0,GMRAR(CNT)="Allergies: "
"RTN","GMRAFX1",28,0)
 .S K=0 F  S K=$O(GMRAL(K)) Q:'+K  D
"RTN","GMRAFX1",29,0)
 ..S NAME=$P(GMRAL(K),"^",2) ;Allergy name
"RTN","GMRAFX1",30,0)
 ..S LEN=LEN+$L(NAME)+1
"RTN","GMRAFX1",31,0)
 ..I LEN>70 S CNT=CNT+1,LEN=$L(NAME)+1,GMRAR(CNT)="   "
"RTN","GMRAFX1",32,0)
 ..S GMRAR(CNT)=$G(GMRAR(CNT))_NAME_$S($O(GMRAL(K)):"~",1:"") D SET^VALM10(CNT,GMRAR(CNT))
"RTN","GMRAFX1",33,0)
 S VALMCNT=CNT,^TMP($J,"IDX2",0)=ENTRY
"RTN","GMRAFX1",34,0)
 Q
"RTN","GMRAFX1",35,0)
 ;
"RTN","GMRAFX1",36,0)
HDR ; -- header code
"RTN","GMRAFX1",37,0)
 S VALMHDR(1)="Patient listing for reactant "_$S(+$G(NMBR):$P(^XTMP("GMRAFX","IDX",+NMBR),"^"),1:"")
"RTN","GMRAFX1",38,0)
 Q
"RTN","GMRAFX1",39,0)
 ;
"RTN","GMRAFX1",40,0)
PHDR ;
"RTN","GMRAFX1",41,0)
 S VALMSG="Select a patient"
"RTN","GMRAFX1",42,0)
 S XQORM("#")=$O(^ORD(101,"B","GMRA FIX DETAIL MENU",0))
"RTN","GMRAFX1",43,0)
 D SHOW^VALM
"RTN","GMRAFX1",44,0)
 Q
"RTN","GMRAFX1",45,0)
 ;
"RTN","GMRAFX1",46,0)
INIT ; -- init variables and list array
"RTN","GMRAFX1",47,0)
 N DIR
"RTN","GMRAFX1",48,0)
 I '$G(NMBR) S NMBR=$$GETNUM^GMRAFX3("DET") S:'+NMBR VALMQUIT="" Q:'+NMBR  I '$$LOCK^GMRAFX3(+NMBR) S VALMQUIT="" Q
"RTN","GMRAFX1",49,0)
 I $L($G(NMBR),",")>2 D FULL^VALM1 W !,"Please select",$S('$G(NMBR):"",1:" only")," one entry from the list." S DIR(0)="E",DIR("A")="Press enter to continue" D ^DIR S VALMQUIT=1 Q
"RTN","GMRAFX1",50,0)
 K ^TMP($J,"GMRADET"),^TMP($J,"IDX2")
"RTN","GMRAFX1",51,0)
 S VALMBCK="",VALMBG=$G(VALMBG,1),VALMCNT=0,VALMWD=80
"RTN","GMRAFX1",52,0)
 Q
"RTN","GMRAFX1",53,0)
 ;
"RTN","GMRAFX1",54,0)
CHKSEL ;Evaluate selection if done by number
"RTN","GMRAFX1",55,0)
 N J,TMP,DIR,NUM,X,Y
"RTN","GMRAFX1",56,0)
 S NUM=$P($G(XQORNOD(0)),"=",2) ;get currently selected entries
"RTN","GMRAFX1",57,0)
 I NUM'="" D
"RTN","GMRAFX1",58,0)
 .I NUM=$G(NMBR2) D DESELECT Q  ;If user selects same entry without taking an entry, unhighlight and stop processing
"RTN","GMRAFX1",59,0)
 .D DESELECT:$G(NMBR2) ;If user previously selected entries but took no action, unhighlight before highlighting new choices
"RTN","GMRAFX1",60,0)
 .S NMBR2=$P(XQORNOD(0),"=",2),DIR(0)="L^"_"1:"_$G(^TMP($J,"IDX2",0)),X=NMBR2,DIR("V")="" D ^DIR K DIR
"RTN","GMRAFX1",61,0)
 .I Y="" D FULL^VALM1 W !,"Invalid selection." D WAIT^GMRAFX3 K NMBR2 Q  ;Selection out of range, stop processing
"RTN","GMRAFX1",62,0)
 .F J=1:1:$L(NMBR2,",")-1 S TMP=$P(NMBR2,",",J) D CNTRL^VALM10(+^TMP($J,"IDX2",TMP),1,+$G(VALMWD),IORVON,IORVOFF)
"RTN","GMRAFX1",63,0)
 Q
"RTN","GMRAFX1",64,0)
 ;
"RTN","GMRAFX1",65,0)
DESELECT ;Un-highlight selected choices
"RTN","GMRAFX1",66,0)
 N J,TMP
"RTN","GMRAFX1",67,0)
 F J=1:1:$L($G(NMBR2),",")-1 S TMP=$P(NMBR2,",",J) D CNTRL^VALM10(+^TMP($J,"IDX2",TMP),1,+$G(VALMWD),IORVOFF,IORVOFF)
"RTN","GMRAFX1",68,0)
 K NMBR2
"RTN","GMRAFX1",69,0)
 Q
"RTN","GMRAFX1",70,0)
HELP ; -- help code
"RTN","GMRAFX1",71,0)
 D FULL^VALM1
"RTN","GMRAFX1",72,0)
 W !!,"Use AE to add local allergies to the GMR ALLERGY file.  This",!,"should only be done if you're sure no existing reactant matches your needs."
"RTN","GMRAFX1",73,0)
 W !!,"Use EE to mark all selected entries as entered",!,"in error.  You may select multiple patients if you like."
"RTN","GMRAFX1",74,0)
 W !!,"Use UR to update the reactant.  Extreme caution should be used when updating",!,"reactants.  You may select multiple patients if you like,"
"RTN","GMRAFX1",75,0)
 W !!,"Use PR to add new allergies for the selected patient in",!,"addition to the ones listed here."
"RTN","GMRAFX1",76,0)
 W !!,"Use DD to get details about the free text entry that you're",!,"currently working on for this patient.",!
"RTN","GMRAFX1",77,0)
 D WAIT^GMRAFX3 S VALMBCK="R"
"RTN","GMRAFX1",78,0)
 Q
"RTN","GMRAFX1",79,0)
 ;
"RTN","GMRAFX1",80,0)
EXIT ; -- exit code
"RTN","GMRAFX1",81,0)
 K ^TMP($J,"IDX2"),^TMP($J,"GMRADET")
"RTN","GMRAFX1",82,0)
 Q
"RTN","GMRAFX1",83,0)
 ;
"RTN","GMRAFX1",84,0)
EXPND ; -- expand code
"RTN","GMRAFX1",85,0)
 Q
"RTN","GMRAFX1",86,0)
 ;
"RTN","GMRAFX1",87,0)
PROCESS(TYPE) ;API to mark selected entries from the detailed listing as entered in error or update to new reactant
"RTN","GMRAFX1",88,0)
 N GMRAPA,GMRAJ,DIR,Y,NUM,GMRADONE,ENTRY,GMRAI,STOP,NUM2,GMRAAR
"RTN","GMRAFX1",89,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX1",90,0)
 I '$G(NMBR2) S NMBR2=$$GETNUM^GMRAFX3("") Q:'+NMBR2
"RTN","GMRAFX1",91,0)
 W !!,"You are about to ",$S(TYPE="E":"mark",1:"update")," the selected patient",$S($L(NMBR2,",")>2:"s'",1:"'s"),!
"RTN","GMRAFX1",92,0)
 S ENTRY=$G(^XTMP("GMRAFX","IDX",+NMBR))
"RTN","GMRAFX1",93,0)
 W $P(ENTRY,"^",2)," allergy ",$S(TYPE="E":"as entered in error.",1:"to a new reactant."),!
"RTN","GMRAFX1",94,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("A")="ARE YOU SURE"
"RTN","GMRAFX1",95,0)
 S DIR("?")="Once allergies are updated or marked as entered in error it cannot be undone!"
"RTN","GMRAFX1",96,0)
 S DIR("?",1)="Be sure this is what you want to do."
"RTN","GMRAFX1",97,0)
 D ^DIR Q:Y'=1  ;Stop if user doesn't answer yes
"RTN","GMRAFX1",98,0)
 S NUM=+NMBR
"RTN","GMRAFX1",99,0)
 F GMRAI=1:1:($L(NMBR2,",")-1) D  Q:$G(STOP)
"RTN","GMRAFX1",100,0)
 .S GMRADONE=1
"RTN","GMRAFX1",101,0)
 .S NUM2=$P(NMBR2,",",GMRAI)
"RTN","GMRAFX1",102,0)
 .S (GMRAPA,GMRAJ)=$P(^TMP($J,"IDX2",NUM2),U,2) Q:'GMRAPA
"RTN","GMRAFX1",103,0)
 .D @$S(TYPE="E":"EIE^GMRAFX",1:"UIE^GMRAFX3")
"RTN","GMRAFX1",104,0)
 .D:$G(GMRADONE) UPDATE^GMRAFX3
"RTN","GMRAFX1",105,0)
 Q
"RTN","GMRAFX2")
0^3^B24744852
"RTN","GMRAFX2",1,0)
GMRAFX2 ;SLC/DAN Select reactant for update ;10/2/03  13:45
"RTN","GMRAFX2",2,0)
 ;;4.0;Adverse Reaction Tracking;**17**;Mar 29, 1996
"RTN","GMRAFX2",3,0)
 ;DBIA SECTION
"RTN","GMRAFX2",4,0)
 ;10026 - DIR
"RTN","GMRAFX2",5,0)
 ;2056  - DIQ
"RTN","GMRAFX2",6,0)
 ;221   - PSDRUG("B", and PSDRUG("C", cross references
"RTN","GMRAFX2",7,0)
 ;10104 - XLFSTR
"RTN","GMRAFX2",8,0)
 ;10006 - DIC
"RTN","GMRAFX2",9,0)
 ;2531  - $$T^PSNAPIS
"RTN","GMRAFX2",10,0)
 ;2574  - $$TGTOG^PSNAPIS
"RTN","GMRAFX2",11,0)
 ;
"RTN","GMRAFX2",12,0)
EN1 ; Select new reactant
"RTN","GMRAFX2",13,0)
 N DIR,Y,DIRUT,X,DTOUT,DUOUT,DIC,GMRALAR,D,ENTRY,OK,CNT,LST,ROOT,NAM,DIROUT
"RTN","GMRAFX2",14,0)
 S DIR(0)="FO^3:30",DIR("A")="Enter Causative Agent",DIR("?")="^D HELP^GMRAFX2" D ^DIR S:$D(DIROUT) STOP=1 Q:$D(DIRUT)  S GMRALAR=$$UP^XLFSTR(Y)
"RTN","GMRAFX2",15,0)
NPA W !!,"Checking GMR ALLERGIES (#120.82) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",16,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) Q
"RTN","GMRAFX2",17,0)
ING W !!,"Now checking INGREDIENT (#50.416) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",X=GMRALAR D IX^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",18,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" Q
"RTN","GMRAFX2",19,0)
CLASS W !!,"Now checking VA DRUG CLASS (#50.605) file for matches...",! K Y,DTOUT,DUOUT,ENTRY S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",D="C" D IX^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",20,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" Q
"RTN","GMRAFX2",21,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAFX2",22,0)
 K Y,DTOUT,DUOUT,ENTRY
"RTN","GMRAFX2",23,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAFX2",24,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM" D ^DIC K DIC S:+Y>0 ENTRY=X D DIC
"RTN","GMRAFX2",25,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" Q
"RTN","GMRAFX2",26,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAFX2",27,0)
 K DUOUT,DTOUT,Y,ENTRY
"RTN","GMRAFX2",28,0)
 S ROOT=$$T^PSNAPIS,CNT=0,X=GMRALAR
"RTN","GMRAFX2",29,0)
 I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAFX2",30,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAFX2",31,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAFX2",32,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAFX2",33,0)
 I CNT=1 S Y(0)=LST(1),ENTRY=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAFX2",34,0)
 I CNT>1 D
"RTN","GMRAFX2",35,0)
 .D MATCHES
"RTN","GMRAFX2",36,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAFX2",37,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAFX2",38,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),(ENTRY,X)=$P(Y(0),U,2)
"RTN","GMRAFX2",39,0)
 D DIC
"RTN","GMRAFX2",40,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" Q
"RTN","GMRAFX2",41,0)
DRUG W !!,"Now checking the DRUG (#50) file for matches...",! K Y,DTOUT,DUOUT,ENTRY
"RTN","GMRAFX2",42,0)
 S CNT=0,X=GMRALAR K LST
"RTN","GMRAFX2",43,0)
 F ROOT="^PSDRUG(""B"")","^PSDRUG(""C"")" D
"RTN","GMRAFX2",44,0)
 .I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$O(@ROOT@(X,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(X,0)),.01)_" <"_X_">",1:X) ;Exact match stores IEN in 50
"RTN","GMRAFX2",45,0)
 .S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAFX2",46,0)
 ..S CNT=CNT+1,LST(CNT)=$O(@ROOT@(NAM,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(NAM,0)),.01)_" <"_NAM_">",1:NAM)
"RTN","GMRAFX2",47,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAFX2",48,0)
 I CNT=1 S Y(0)=LST(1),ENTRY=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAFX2",49,0)
 I CNT>1 D
"RTN","GMRAFX2",50,0)
 .D MATCHES
"RTN","GMRAFX2",51,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAFX2",52,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAFX2",53,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),(ENTRY,X)=$P(Y(0),U,2)
"RTN","GMRAFX2",54,0)
 D DIC
"RTN","GMRAFX2",55,0)
 I +Y>0&($G(OK)) S GMRAAR=+Y(0)_";PSDRUG(",GMRAAR(0)=$$GET1^DIQ(50,+Y(0),.01),GMRAAR("O")="D" Q
"RTN","GMRAFX2",56,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files.",!,"Please try again (check spelling, etc).",!,"If you need to add a new reactant, use the AE option." G EN1
"RTN","GMRAFX2",57,0)
 Q
"RTN","GMRAFX2",58,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAFX2",59,0)
 N DIR,X,Y
"RTN","GMRAFX2",60,0)
 Q:'$D(ENTRY)
"RTN","GMRAFX2",61,0)
 K OK
"RTN","GMRAFX2",62,0)
 W !!,"You selected ",ENTRY
"RTN","GMRAFX2",63,0)
 S DIR(0)="Y",DIR("B")="Y",DIR("A")="Is this correct",DIR("?")="Answer yes if this is the correct reactant" D ^DIR S:Y=1 OK=1
"RTN","GMRAFX2",64,0)
 Q
"RTN","GMRAFX2",65,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAFX2",66,0)
 N I,J,QUIT
"RTN","GMRAFX2",67,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAFX2",68,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAFX2",69,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAFX2",70,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAFX2",71,0)
 Q
"RTN","GMRAFX2",72,0)
        ;
"RTN","GMRAFX2",73,0)
MORE()  ; -- show more matches
"RTN","GMRAFX2",74,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAFX2",75,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAFX2",76,0)
 D ^DIR
"RTN","GMRAFX2",77,0)
 Q +Y
"RTN","GMRAFX2",78,0)
 ;
"RTN","GMRAFX2",79,0)
HELP ;Display help for selection of causative agent
"RTN","GMRAFX2",80,0)
 W !,"Enter new causative agent to be assigned to the selected entries."
"RTN","GMRAFX2",81,0)
 W !,"Enter between 3 and 30 characters.  The entered text will then be"
"RTN","GMRAFX2",82,0)
 W !,"searched for in a number of different files.  Select the appropriate"
"RTN","GMRAFX2",83,0)
 W !,"entry from the appropriate file to update the selected patient."
"RTN","GMRAFX2",84,0)
 W !!,"Enter ^ to skip the current patient or ^^ to exit the entire process."
"RTN","GMRAFX2",85,0)
 Q
"RTN","GMRAFX3")
0^4^B35641797
"RTN","GMRAFX3",1,0)
GMRAFX3 ;SLC/DAN Update existing entries to new reactant ;10/23/03  15:47
"RTN","GMRAFX3",2,0)
 ;;4.0;Adverse Reaction Tracking;**17**;Mar 29, 1996
"RTN","GMRAFX3",3,0)
 ;DBIA SECTION
"RTN","GMRAFX3",4,0)
 ;10018 - DIE
"RTN","GMRAFX3",5,0)
 ;2056  - DIQ
"RTN","GMRAFX3",6,0)
 ;3154  - ORQ1
"RTN","GMRAFX3",7,0)
 ;4134  - ORCHECK
"RTN","GMRAFX3",8,0)
 ;4135  - ORKCHK
"RTN","GMRAFX3",9,0)
 ;10026 - DIR
"RTN","GMRAFX3",10,0)
 ;
"RTN","GMRAFX3",11,0)
UIE ;Update individual entries
"RTN","GMRAFX3",12,0)
 N DFN,GMRAOUT,GMRAING,GMRADRCL,DIE,DA,DR,AIFN,SIGN,TIME,SUB,ORX,GMRAORX,GMRAOC,GI,FND,COM,SIEN,DIR,Y
"RTN","GMRAFX3",13,0)
 S GMRADONE=0 ;Flag to keep track of updated entries
"RTN","GMRAFX3",14,0)
 S DFN=$P($G(^GMR(120.8,GMRAPA,0)),U) Q:'+DFN
"RTN","GMRAFX3",15,0)
 W !!,"For patient ",$$GET1^DIQ(2,DFN_",",.01),!
"RTN","GMRAFX3",16,0)
 I $D(GMRAAR) D
"RTN","GMRAFX3",17,0)
 .S DIR(0)="Y",DIR("A")="Use reactant "_GMRAAR(0),DIR("B")="Y" D ^DIR
"RTN","GMRAFX3",18,0)
 .K:'Y GMRAAR
"RTN","GMRAFX3",19,0)
 .Q
"RTN","GMRAFX3",20,0)
 D:'$D(GMRAAR) ^GMRAFX2 Q:'$D(GMRAAR)  ;Get new reactant
"RTN","GMRAFX3",21,0)
 S GMRAOUT=0
"RTN","GMRAFX3",22,0)
 I $$DUP W !,"Patient already has an active allergy for this reactant.",!,"Duplicate not allowed.",! D WAIT Q
"RTN","GMRAFX3",23,0)
 I $$DUPCHK^GMRAPES0(GMRAAR(0),DFN,GMRAPA) Q  ;Checks to see if reactant previously entered in error.
"RTN","GMRAFX3",24,0)
 ;Update reactant, allergy and signed off fields
"RTN","GMRAFX3",25,0)
 S DIE="^GMR(120.8,",DA=GMRAPA,DR=".02////"_GMRAAR(0)_";1////^S X=GMRAAR"_";3.1////"_GMRAAR("O")_";15///1" D ^DIE
"RTN","GMRAFX3",26,0)
 I $D(^GMR(120.85,"C",GMRAPA)) D  ;Observed reaction, need to update data
"RTN","GMRAFX3",27,0)
 .S AIFN=0
"RTN","GMRAFX3",28,0)
 .F  S AIFN=$O(^GMR(120.85,"C",GMRAPA,AIFN)) Q:'+AIFN  D
"RTN","GMRAFX3",29,0)
 ..S SIEN=$O(^GMR(120.85,AIFN,3,"B",$P(^XTMP("GMRAFX","IDX",+NMBR),"^"),0)) Q:'+SIEN  ;Was previous reactant stored as "suspected agent"
"RTN","GMRAFX3",30,0)
 ..S DA(1)=AIFN,DA=SIEN
"RTN","GMRAFX3",31,0)
 ..S DIE="^GMR(120.85,DA(1),3,",DR=".01////^S X=GMRAAR(0)" D ^DIE ;Update suspected agent to new value
"RTN","GMRAFX3",32,0)
 D DELMUL(2),DELMUL(3) ;Delete drug ingredient/drug classes multiples
"RTN","GMRAFX3",33,0)
 I GMRAAR("O")["D" D UPDATE^GMRAPES1 ;If reactant type is Drug then add appropriate ingredients and classes
"RTN","GMRAFX3",34,0)
 S GMRADONE=1 ;Update complete
"RTN","GMRAFX3",35,0)
 S COM="Updated using clean up process.  Changed reactant from "_$P(^XTMP("GMRAFX","IDX",+NMBR),"^",2)_" (free text) "_"to "_GMRAAR(0)_"(file - "_$P(GMRAAR,";",2)_")"
"RTN","GMRAFX3",36,0)
 D ADCOM^GMRAFX(GMRAPA,"O",COM) ;Add a comment for this update
"RTN","GMRAFX3",37,0)
 ;Do order checking here - compare existing orders against new allergy information.
"RTN","GMRAFX3",38,0)
 W !,"Performing order checking..."
"RTN","GMRAFX3",39,0)
 K ^TMP("ORR",$J),GMRAOC,ORX
"RTN","GMRAFX3",40,0)
 D EN^ORQ1(DFN_";DPT(") ;Retrieve active orders
"RTN","GMRAFX3",41,0)
 S TIME=$O(^TMP("ORR",$J,0))
"RTN","GMRAFX3",42,0)
 Q:'^TMP("ORR",$J,TIME,"TOT")  ;No orders found
"RTN","GMRAFX3",43,0)
 S SUB=0 F  S SUB=$O(^TMP("ORR",$J,TIME,SUB)) Q:'+SUB  D
"RTN","GMRAFX3",44,0)
 .D BLD^ORCHECK(+^TMP("ORR",$J,TIME,SUB)) ;Get "order" information in order checking format
"RTN","GMRAFX3",45,0)
 M GMRAORX=ORX
"RTN","GMRAFX3",46,0)
 D EN^ORKCHK(.GMRAOC,DFN,.GMRAORX,"ACCEPT")
"RTN","GMRAFX3",47,0)
 S GI=0,FND=0 F  S GI=$O(GMRAOC(GI)) Q:'+GI  D
"RTN","GMRAFX3",48,0)
 .Q:$P(GMRAOC(GI),U,2)'=3  ;Quit if not allergy related
"RTN","GMRAFX3",49,0)
 .W !,"Patient has a(n) ",$P($$STATUS^ORQOR2($P(GMRAOC(GI),U)),U,2)," order for",$P($P(GMRAOC(GI),U,4),":",2),", order #",$P(GMRAOC(GI),U)
"RTN","GMRAFX3",50,0)
 .S FND=1
"RTN","GMRAFX3",51,0)
 W:'FND "No problems found"
"RTN","GMRAFX3",52,0)
 D WAIT
"RTN","GMRAFX3",53,0)
 Q
"RTN","GMRAFX3",54,0)
 ;
"RTN","GMRAFX3",55,0)
DELMUL(FIELD) ;Delete multiple FIELD from GMR ALLERGY file
"RTN","GMRAFX3",56,0)
 N MIEN,DA,DIE,DR
"RTN","GMRAFX3",57,0)
 S MIEN=0 F  S MIEN=$O(^GMR(120.8,GMRAPA,FIELD,MIEN)) Q:'+MIEN  D
"RTN","GMRAFX3",58,0)
 .S DA(1)=GMRAPA,DA=MIEN
"RTN","GMRAFX3",59,0)
 .S DIE="^GMR(120.8,DA(1),FIELD,",DR=".01///@" D ^DIE ;Delete entry
"RTN","GMRAFX3",60,0)
 Q
"RTN","GMRAFX3",61,0)
 ;
"RTN","GMRAFX3",62,0)
DUP() ;Function returns true (1) if selected reactant is a duplicate
"RTN","GMRAFX3",63,0)
 N LOOP,FND
"RTN","GMRAFX3",64,0)
 S LOOP=0,FND=0
"RTN","GMRAFX3",65,0)
 F  S LOOP=$O(^GMR(120.8,"B",DFN,LOOP)) Q:'+LOOP!(FND)  D
"RTN","GMRAFX3",66,0)
 .I $P(^GMR(120.8,LOOP,0),U,3)=GMRAAR&('$D(^GMR(120.8,LOOP,"ER"))) S FND=1
"RTN","GMRAFX3",67,0)
 Q FND
"RTN","GMRAFX3",68,0)
 ;
"RTN","GMRAFX3",69,0)
WAIT ;Issues press enter to return prompt
"RTN","GMRAFX3",70,0)
 N DIR
"RTN","GMRAFX3",71,0)
 S DIR(0)="E",DIR("A")="Press enter to continue" D ^DIR
"RTN","GMRAFX3",72,0)
 Q
"RTN","GMRAFX3",73,0)
 ;
"RTN","GMRAFX3",74,0)
GETNUM(ACTION) ; -- Return numbers to act on, if action chosen first
"RTN","GMRAFX3",75,0)
 N X,Y,DIR,MAX
"RTN","GMRAFX3",76,0)
 S MAX=$S($D(^TMP($J,"IDX2")):$G(^TMP($J,"IDX2",0)),1:$G(VALMCNT)) Q:MAX'>0 ""
"RTN","GMRAFX3",77,0)
 I ACTION="DET" W !!,"Please choose only one entry for the detailed display."
"RTN","GMRAFX3",78,0)
 S DIR(0)="LAO^1:"_MAX,DIR("A")="Select Entries from list: "
"RTN","GMRAFX3",79,0)
 S DIR("?")="Enter the items you wish to act on, as a range or list of numbers."
"RTN","GMRAFX3",80,0)
 D ^DIR S:$D(DTOUT) Y="^"
"RTN","GMRAFX3",81,0)
 I $D(Y(1)) W !,">>>Too many entries selected, try using smaller ranges" H 2 S Y="^"
"RTN","GMRAFX3",82,0)
 I $L($G(Y),",")>2,ACTION="DET" W !,">>You may only choose ONE group for detailed display." H 2 S Y="^"
"RTN","GMRAFX3",83,0)
 Q Y
"RTN","GMRAFX3",84,0)
 ;
"RTN","GMRAFX3",85,0)
UPDATE ;Update display to account for changes to the list
"RTN","GMRAFX3",86,0)
 N CNT,SP1,SP2,SP3
"RTN","GMRAFX3",87,0)
 I VALMAR["GMRADET" N VALMAR S VALMAR="^XTMP(""GMRAFX"")"
"RTN","GMRAFX3",88,0)
 S CNT=^XTMP("GMRAFX","GMRAR",$P(ENTRY,U),$P(ENTRY,U,2))-1
"RTN","GMRAFX3",89,0)
 S ^XTMP("GMRAFX","GMRAR",$P(ENTRY,U),$P(ENTRY,U,2))=CNT K ^($P(ENTRY,U,2),GMRAJ)
"RTN","GMRAFX3",90,0)
 S SP1=4-$L(+NUM),SP2=40-$L($P(ENTRY,U)),SP3=$S(CNT:16-$L(CNT)\2,1:2)
"RTN","GMRAFX3",91,0)
 D SET^VALM10(+NUM,+NUM_$$REPEAT^XLFSTR(" ",SP1)_$P(ENTRY,U,2)_$$REPEAT^XLFSTR(" ",(SP2+SP3))_$S(CNT:CNT,1:"** FIXED **"))
"RTN","GMRAFX3",92,0)
 Q
"RTN","GMRAFX3",93,0)
 ;
"RTN","GMRAFX3",94,0)
LOCK(ENTRY) ;Lock entry in 120.8
"RTN","GMRAFX3",95,0)
 N LOCK
"RTN","GMRAFX3",96,0)
 S LOCK=1
"RTN","GMRAFX3",97,0)
 L +^XTMP("GMRAFX","IDX",ENTRY):1
"RTN","GMRAFX3",98,0)
 I '$T D FULL^VALM1 S VALMBCK="R" W !,"The ",$P(^XTMP("GMRAFX","IDX",ENTRY),U)," group is being edited by another user" D WAIT S LOCK=0
"RTN","GMRAFX3",99,0)
 Q LOCK
"RTN","GMRAFX3",100,0)
 ;
"RTN","GMRAFX3",101,0)
AR ;Add/edit patient reactions
"RTN","GMRAFX3",102,0)
 N LCV,DFN,SUB
"RTN","GMRAFX3",103,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX3",104,0)
 W !!,"You should use this option to add NEW reactions only.  If you mark"
"RTN","GMRAFX3",105,0)
 W !,"existing free text entries as entered in error from within this option it will"
"RTN","GMRAFX3",106,0)
 W !,"not update the utility's display until the list is rebuilt upon re-entry"
"RTN","GMRAFX3",107,0)
 W !,"of this option.  This could cause confusion as the list will no longer"
"RTN","GMRAFX3",108,0)
 W !,"be accurate.",!
"RTN","GMRAFX3",109,0)
 I '$G(NMBR2) D WAIT,EN1^GMRAPEM0 Q
"RTN","GMRAFX3",110,0)
 F LCV=1:1:$L(NMBR2,",")-1 S SUB=$P(NMBR2,",",LCV) S DFN=+$P($G(^GMR(120.8,+$P($G(^TMP($J,"IDX2",SUB)),U,2),0)),U) I DFN W !!,"Now working with patient ",$$GET1^DIQ(2,DFN,.01),! D WAIT D EN2^GMRAPEM0
"RTN","GMRAFX3",111,0)
 Q
"RTN","GMRAFX3",112,0)
 ;
"RTN","GMRAFX3",113,0)
DSPREACT ;Display detailed information about the free text reactant
"RTN","GMRAFX3",114,0)
 N DIC,DA,GMRAI,STOP,NUM2,DIR,Y
"RTN","GMRAFX3",115,0)
 S VALMBCK="R" D FULL^VALM1
"RTN","GMRAFX3",116,0)
 I '$G(NMBR2) S NMBR2=$$GETNUM("") Q:'+NMBR2
"RTN","GMRAFX3",117,0)
 F GMRAI=1:1:($L(NMBR2,",")-1) D  Q:$G(STOP)
"RTN","GMRAFX3",118,0)
 .S NUM2=$P(NMBR2,",",GMRAI)
"RTN","GMRAFX3",119,0)
 .S DA=$P(^TMP($J,"IDX2",NUM2),U,2) Q:'DA
"RTN","GMRAFX3",120,0)
 .S DIC="^GMR(120.8,"
"RTN","GMRAFX3",121,0)
 .W ! D EN^DIQ
"RTN","GMRAFX3",122,0)
 .S DIR(0)="E",DIR("A")="Press return to continue or '^' to stop" D ^DIR
"RTN","GMRAFX3",123,0)
 .S:$D(DIRUT) STOP=1
"RTN","GMRAFX3",124,0)
 .Q
"RTN","GMRAFX3",125,0)
 Q
"RTN","GMRAOR6")
0^16^B3212051
"RTN","GMRAOR6",1,0)
GMRAOR6 ;HIRMFO/WAA-OERR HL7 UTILITY ;8/28/03  14:36
"RTN","GMRAOR6",2,0)
 ;;4.0;Adverse Reaction Tracking;**17**;Mar 29, 1996
"RTN","GMRAOR6",3,0)
 ; File all allergies Sign/Symptoms
"RTN","GMRAOR6",4,0)
 ; INPUT
"RTN","GMRAOR6",5,0)
 ;    IEN = The internal entry number for the file entry being modified
"RTN","GMRAOR6",6,0)
 ;   FILE = The file number of the file being modified
"RTN","GMRAOR6",7,0)
 ;  GMRAL = The internal entry number of the GMRAL array being added
"RTN","GMRAOR6",8,0)
 ;
"RTN","GMRAOR6",9,0)
SIGN(GMRAFILE,GMRAIEN,GMRAL) ; Signs/Symptoms
"RTN","GMRAOR6",10,0)
 Q:$G(GMRAIEN)<1
"RTN","GMRAOR6",11,0)
 S GMRANODE=$S(GMRAFILE=120.8:10,GMRAFILE=120.85:2,1:0) Q:'GMRANODE
"RTN","GMRAOR6",12,0)
 S GMRASN=0 F  S GMRASN=$O(GMRAL(GMRAL,"S",GMRASN)) Q:GMRASN<1  D
"RTN","GMRAOR6",13,0)
 .Q:$P(GMRAL(GMRAL,"S",GMRASN),U)'>0  ;17 Screen out bad entries
"RTN","GMRAOR6",14,0)
 .Q:$O(^GMR(GMRAFILE,GMRAIEN,GMRANODE,"B",$P(GMRAL(GMRAL,"S",GMRASN),U),""))  ;Prevent DUPS
"RTN","GMRAOR6",15,0)
 .K DD,DO,DIC,DINUM,DLAYGO
"RTN","GMRAOR6",16,0)
 .S DA(1)=GMRAIEN,DIC="^GMR("_GMRAFILE_","_DA(1)_","_GMRANODE_","
"RTN","GMRAOR6",17,0)
 .S DIC(0)="L",X=$P(GMRAL(GMRAL,"S",GMRASN),U),DLAYGO=GMRAFILE
"RTN","GMRAOR6",18,0)
 .S DIC("P")=$S(GMRANODE=10:"120.81P",1:"120.8502P")
"RTN","GMRAOR6",19,0)
 .D FILE^DICN
"RTN","GMRAOR6",20,0)
 .K DD,DO,DIC,DINUM,DLAYGO
"RTN","GMRAOR6",21,0)
 .S GMRASN=$P(+Y,U)
"RTN","GMRAOR6",22,0)
 .S GMRALN=^GMR(GMRAFILE,GMRAIEN,GMRANODE,GMRASN,0) Q:GMRALN=""
"RTN","GMRAOR6",23,0)
 .I '$D(GMRAOTH) S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRAOR6",24,0)
 .S $P(GMRALN,U,3)=$P(GMRAL(GMRAL),U,7)
"RTN","GMRAOR6",25,0)
 .I $P(GMRALN,U)=GMRAOTH S $P(GMRALN,U,2)=$P(GMRAL(GMRAL,"S",GMRASN),U,2)_U
"RTN","GMRAOR6",26,0)
 .I GMRANODE=10 S $P(GMRALN,U,4)=$P(GMRAL(GMRAL,"S",GMRASN),U,4)
"RTN","GMRAOR6",27,0)
 .S ^GMR(GMRAFILE,GMRAIEN,GMRANODE,GMRASN,0)=GMRALN
"RTN","GMRAOR6",28,0)
 .Q
"RTN","GMRAOR6",29,0)
 K GMRAIEN,GMRANODE,GMRAFILE,GMRASN,GMRALN,GMRAOTH,Y,X
"RTN","GMRAOR6",30,0)
 Q
"RTN","GMRAOR7")
0^15^B2567375
"RTN","GMRAOR7",1,0)
GMRAOR7 ;HIRMFO/WAA,FPT-OERR HL7 UTILITY ;8/28/03  13:52
"RTN","GMRAOR7",2,0)
 ;;4.0;Adverse Reaction Tracking;**4,17**;Mar 29, 1996
"RTN","GMRAOR7",3,0)
ADVERSE(GMRAPA,GMRAL) ;Add a Adverse reaction entry to file 120.85
"RTN","GMRAOR7",4,0)
 ;INPUT
"RTN","GMRAOR7",5,0)
 ;   GMRAPA = the entry in file 120.8 that was added
"RTN","GMRAOR7",6,0)
 ;    GMRAL = The entry in the GMRAL array that is being added
"RTN","GMRAOR7",7,0)
 ;
"RTN","GMRAOR7",8,0)
 N GMRAO,GMRAPA1,X,Y
"RTN","GMRAOR7",9,0)
 S GMRAO=0 F  S GMRAO=$O(GMRAL(GMRAL,"O",GMRAO)) Q:GMRAO<1  D
"RTN","GMRAOR7",10,0)
 .K DD,DO,DIC,DINUM,DLAYGO
"RTN","GMRAOR7",11,0)
 .S DIC="^GMR(120.85,",DLAYGO=120.85,DIC(0)="L",X=$P(GMRAL(GMRAL,"O",GMRAO),U)
"RTN","GMRAOR7",12,0)
 .D FILE^DICN
"RTN","GMRAOR7",13,0)
 .K DD,DO,DIC,DINUM,DLAYGO
"RTN","GMRAOR7",14,0)
 .Q:Y=-1  S GMRAPA1=+Y
"RTN","GMRAOR7",15,0)
 .N GMRALN
"RTN","GMRAOR7",16,0)
 .F  Q:$$LOCK^GMRAUTL(120.85,GMRAPA1)
"RTN","GMRAOR7",17,0)
 .S GMRALN=^GMR(120.85,GMRAPA1,0)
"RTN","GMRAOR7",18,0)
 .S $P(GMRALN,U,2)=GMRADFN
"RTN","GMRAOR7",19,0)
 .S $P(GMRALN,U,13)=$P(GMRAL(GMRAL),U,7)
"RTN","GMRAOR7",20,0)
 .I $P(GMRAL(GMRAL,"O",GMRAO),U,3)]"" S $P(GMRALN,U,13)=$P(GMRAL(GMRAL,"O",GMRAO),U,3)
"RTN","GMRAOR7",21,0)
 .S $P(GMRALN,U,14)=$P(GMRAL(GMRAL,"O",GMRAO),U,2)
"RTN","GMRAOR7",22,0)
 .S $P(GMRALN,U,15)=GMRAPA
"RTN","GMRAOR7",23,0)
 .S ^GMR(120.85,GMRAPA1,0)=GMRALN
"RTN","GMRAOR7",24,0)
 .I $D(GMRAL(GMRAL,"S",1)) D SIGN^GMRAOR6(120.85,GMRAPA1,.GMRAL) ;S/S
"RTN","GMRAOR7",25,0)
 .S ^GMR(120.85,GMRAPA1,3,0)="^120.8503^1^1"
"RTN","GMRAOR7",26,0)
 .S ^GMR(120.85,GMRAPA1,3,1,0)=$P(GMRAL(GMRAL),U,3)
"RTN","GMRAOR7",27,0)
 .K DIK,DA S DIK="^GMR(120.85,",DA=GMRAPA1 D IX^DIK K DIK,DA ;17 changed GMRAPA to GMRAPA1
"RTN","GMRAOR7",28,0)
 .D UNLOCK^GMRAUTL(120.85,GMRAPA1)
"RTN","GMRAOR7",29,0)
 .Q
"RTN","GMRAOR7",30,0)
 Q
"RTN","GMRAPED0")
0^13^B22812955
"RTN","GMRAPED0",1,0)
GMRAPED0 ;HIRMFO/RM,WAA-VERIFIER EDIT OF DRUG A/AR ;8/1/03  09:23
"RTN","GMRAPED0",2,0)
 ;;4.0;Adverse Reaction Tracking;**17**;Mar 29, 1996
"RTN","GMRAPED0",3,0)
EN1 ; ENTRY TO EDIT INFO SPECIFIC TO DRUG A/AR FOR VERIFIER
"RTN","GMRAPED0",4,0)
 K GMRAINGR,GMRACLAS
"RTN","GMRAPED0",5,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) G Q1
"RTN","GMRAPED0",6,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) G:GMRAPA(0)="" Q1
"RTN","GMRAPED0",7,0)
 F GMRAINGR=0:0 S GMRAINGR=$O(^GMR(120.8,GMRAPA,2,GMRAINGR)) Q:GMRAINGR'>0  S X=$S($D(^GMR(120.8,GMRAPA,2,GMRAINGR,0)):^(0),1:"") I +X>0 S Y=$S($D(^PS(50.416,+X,0)):^(0),1:"") I $P(Y,U)'="" S GMRAINGR($P(Y,U),+X)=Y
"RTN","GMRAPED0",8,0)
 F GMRACLAS=0:0 S GMRACLAS=$O(^GMR(120.8,GMRAPA,3,GMRACLAS)) Q:GMRACLAS'>0  S X=$S($D(^GMR(120.8,GMRAPA,3,GMRACLAS,0)):^(0),1:"") I +X>0 S Y=$S($D(^PS(50.605,+X,0)):^(0),1:"") I $P(Y,U)'="" S GMRACLAS($P(Y,U),+X)=Y
"RTN","GMRAPED0",9,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPED0",10,0)
 W @IOF
"RTN","GMRAPED0",11,0)
 W !,"CAUSATIVE AGENT: ",$P(GMRAPA(0),U,2)
"RTN","GMRAPED0",12,0)
 W !?11,"TYPE: ",$$OUTTYPE^GMRAUTL($P(GMRAPA(0),U,20))
"RTN","GMRAPED0",13,0)
 W !?4,"INGREDIENTS: " S Y="",GMRAPRSW=0 F  S Y=$O(GMRAINGR(Y)) Q:Y=""  F X=0:0 S X=$O(GMRAINGR(Y,X)) Q:X'>0  W:GMRAPRSW ! W ?17,Y S:'GMRAPRSW GMRAPRSW=1
"RTN","GMRAPED0",14,0)
 W !,"VA DRUG CLASSES: "
"RTN","GMRAPED0",15,0)
 S Y="",GMRAPRSW=0 F  S Y=$O(GMRACLAS(Y)) Q:Y=""  F X=0:0 S X=$O(GMRACLAS(Y,X)) Q:X'>0  W:GMRAPRSW ! W ?17,Y," - ",$P(GMRACLAS(Y,X),U,2) S:'GMRAPRSW GMRAPRSW=1
"RTN","GMRAPED0",16,0)
 W !,"       OBS/HIST: ",$S($P(GMRAPA(0),U,6)="o":"OBSERVED",$P(GMRAPA(0),U,6)="h":"HISTORICAL",1:"")
"RTN","GMRAPED0",17,0)
 D  ;Sign/Symptoms
"RTN","GMRAPED0",18,0)
 .N GMRAVFY
"RTN","GMRAPED0",19,0)
 .S GMRAVFY=1
"RTN","GMRAPED0",20,0)
 .D EN1^GMRADSP3
"RTN","GMRAPED0",21,0)
 .Q
"RTN","GMRAPED0",22,0)
 W !,"      MECHANISM: ",$S($P(GMRAPA(0),U,14)="A":"ALLERGY",$P(GMRAPA(0),U,14)="P":"PHARMACOLOGIC",$P(GMRAPA(0),U,14)="U":"UNKNOWN",1:"")
"RTN","GMRAPED0",23,0)
YNED W !!,"Would you like to edit any of this data" S %=0 D YN^DICN I '% W !?4,$C(7),"ANSWER YES IF YOU WISH TO CHANGE ANY OF THE DATA ABOVE, ELSE ANSWER NO." G YNED
"RTN","GMRAPED0",24,0)
 S:%=-1 GMRAOUT=1 G Q1:%=2!GMRAOUT
"RTN","GMRAPED0",25,0)
 D EN1^GMRAPED3 G:GMRAOUT Q1 I GMRAAR'="" S DIE="^GMR(120.8,",DA=GMRAPA,DR=".02////^S X=GMRAAR(0);1////^S X=GMRAAR"_$S($D(GMRAAR("O")):";3.1////"_GMRAAR("O"),1:"") D ^DIE
"RTN","GMRAPED0",26,0)
 S GMRAPA(0)=$G(^GMR(120.8,+GMRAPA,0))
"RTN","GMRAPED0",27,0)
 S GMRAEN=GMRAPA_";GMR(120.8," D INPTYPE^GMRAUTL(GMRAEN) G Q1:GMRAOUT
"RTN","GMRAPED0",28,0)
 S DA=GMRAPA,DIE="^GMR(120.8,",DR="2" D ^DIE S:$D(Y) GMRAOUT=1 G Q1:GMRAOUT
"RTN","GMRAPED0",29,0)
 S GMRAPA(0)=$G(^GMR(120.8,+GMRAPA,0))
"RTN","GMRAPED0",30,0)
 D DRGCLS^GMRAPED1
"RTN","GMRAPED0",31,0)
 I 'GMRAOUT F  K Y D  Q:GMRAOUT!('$D(Y))
"RTN","GMRAPED0",32,0)
 .S GMRAPA(0)=$S($D(^GMR(120.8,GMRAPA,0)):^(0),1:"")
"RTN","GMRAPED0",33,0)
 .S DR="6(O)bserved or (H)istorical Allergy/Adverse Reaction",DIE="^GMR(120.8,",DA=GMRAPA D ^DIE
"RTN","GMRAPED0",34,0)
 .I $D(Y) S GMRAOUT=1 Q
"RTN","GMRAPED0",35,0)
 .S GMRANEW(0)=$S($D(^GMR(120.8,GMRAPA,0)):^(0),1:"")
"RTN","GMRAPED0",36,0)
 .I $P(GMRANEW(0),"^",6)="" W $C(7),"  Required??" S Y="" Q
"RTN","GMRAPED0",37,0)
 .Q:$P(GMRANEW(0),"^",6)=$P(GMRAPA(0),"^",6)
"RTN","GMRAPED0",38,0)
 .I $P(GMRAPA(0),"^",6)'=$P(GMRANEW(0),"^",6) D  Q
"RTN","GMRAPED0",39,0)
 ..W !!,"You cannot change the type of reaction.  If this is incorrect",!,"please exit and mark this entry as entered-in-error and then re-enter",!,"the correct information.",!
"RTN","GMRAPED0",40,0)
 ..S DIE="^GMR(120.8,",DR="6////"_$P(GMRAPA(0),"^",6),DA=GMRAPA D ^DIE S Y="" Q
"RTN","GMRAPED0",41,0)
 ..Q
"RTN","GMRAPED0",42,0)
 .Q
"RTN","GMRAPED0",43,0)
 I 'GMRAOUT D EN1^GMRAPER2(GMRAPA,"120.8",.GMRAOUT)
"RTN","GMRAPED0",44,0)
 I 'GMRAOUT D MECH Q:GMRAOUT
"RTN","GMRAPED0",45,0)
 S GMRAPA(0)=$S($D(^GMR(120.8,GMRAPA,0)):^(0),1:"")
"RTN","GMRAPED0",46,0)
 S GMRAOUT=0 G EN1
"RTN","GMRAPED0",47,0)
Q1 ;Exit
"RTN","GMRAPED0",48,0)
 K GMRAEN,X,GMRAAR
"RTN","GMRAPED0",49,0)
 K DA,DIE,DR
"RTN","GMRAPED0",50,0)
 Q
"RTN","GMRAPED0",51,0)
MECH ;Mechanism for ADRs
"RTN","GMRAPED0",52,0)
 F  W !!,?5,"Choose one of the following:",! D  Q:GMRAOUT!('$D(Y))
"RTN","GMRAPED0",53,0)
 .F GMRAMEC="A - ALLERGY","P - PHARMACOLOGICAL","U - UNKNOWN" W !,?20,GMRAMEC
"RTN","GMRAPED0",54,0)
 .W ! S DIE="^GMR(120.8,",DA=GMRAPA,DR=17 D ^DIE
"RTN","GMRAPED0",55,0)
 .S:$D(Y) GMRAOUT=1
"RTN","GMRAPED0",56,0)
 .Q
"RTN","GMRAPED0",57,0)
 Q
"RTN","GMRAPED0",58,0)
HELP ; HELP FOR A/AR LOOKUP
"RTN","GMRAPED0",59,0)
 W !!?4,"Would you like to see a list of:",!?6,"1  Local Allergies (Food/Drug/Other)",!?6,"2  Drug Classes",!?6,"3  Drug Ingredients",!?6,"4  National Drugs",!?6,"5  Local Drugs"
"RTN","GMRAPED0",60,0)
 R !?4,"Select a number (1-5):",X:DTIME S:'$T X="^^" I "^^"[X S:X="^^"!(X=U) GMRAOUT=1 Q
"RTN","GMRAPED0",61,0)
 I X\1'=X!(X<1)!(X>5) W !?7,$C(7),"ANSWER WITH THE NUMBER (1-5) OF THE SELECTION FOR",!?7,"WHICH YOU WISH TO SEE MORE HELP." G HELP
"RTN","GMRAPED0",62,0)
 S DIC=$S(X=1:120.82,X=2:50.605,X=3:50.416,X=4:50.6,1:50) D HLPLK
"RTN","GMRAPED0",63,0)
 G HELP
"RTN","GMRAPED0",64,0)
HLPLK ; LOOKUP ON FILE IN DIC
"RTN","GMRAPED0",65,0)
 S DIC(0)="E",X="??" S:DIC=50.416 D="P" S:DIC=50.605 DIC("W")="W ?10,$P(^(0),U,2)",DIC(0)="SE",D="C" D ^DIC:DIC'=50.605&(DIC'=50.416),IX^DIC:DIC=50.605!(DIC=50.416)
"RTN","GMRAPED0",66,0)
 Q
"RTN","GMRAPED0",67,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAPED0",68,0)
 S:$D(DTOUT) X="^^" I X="^^" S GMRAOUT=1 Q
"RTN","GMRAPED0",69,0)
 S:$D(DUOUT) Y=0 Q:+Y'>0
"RTN","GMRAPED0",70,0)
YNOK W !?3,X,"   OK" S %=1 D YN^DICN S:%=-1 GMRAOUT=1,Y=-1 S:%=2 Y=-1 I % W ! Q
"RTN","GMRAPED0",71,0)
 W !?5,$C(7),"ANSWER YES IF THIS IS THE CORRECT ALLERGY/ADVERSE REACTION,",!?5,"ELSE ANSWER NO."
"RTN","GMRAPED0",72,0)
 G YNOK
"RTN","GMRAPED0",73,0)
HEAD ; Header for reactions
"RTN","GMRAPED0",74,0)
 W @IOF
"RTN","GMRAPED0",75,0)
 W !,"Reactions: (cont.) "
"RTN","GMRAPED0",76,0)
 Q
"RTN","GMRAPEM0")
0^10^B43111824
"RTN","GMRAPEM0",1,0)
GMRAPEM0 ;HIRMFO/WAA,FT-ALLERGY/ADVERSE REACTION PATIENT EDIT DRIVER ;8/28/03  14:22
"RTN","GMRAPEM0",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,5,17**;Mar 29, 1996
"RTN","GMRAPEM0",3,0)
EN11 ; Entry point for GMRA USER E/E PAT REC DATA option
"RTN","GMRAPEM0",4,0)
 ; GMRAUSER is a flag that indicates that this is a User
"RTN","GMRAPEM0",5,0)
 ; If user has Verifier Key then user will act normal
"RTN","GMRAPEM0",6,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) S GMRAUSER=1
"RTN","GMRAPEM0",7,0)
EN1 ; Entry for ENTER/EDIT PATIENT REACTION DATA option
"RTN","GMRAPEM0",8,0)
 ; EDIT PATIENT A/AR (DFN UNK.)
"RTN","GMRAPEM0",9,0)
 S GMRAOUT=0
"RTN","GMRAPEM0",10,0)
 W @IOF D PAT^GMRAPAT ; Select A Patient
"RTN","GMRAPEM0",11,0)
 D:'GMRAOUT EN21 G:'GMRAOUT EN1
"RTN","GMRAPEM0",12,0)
 K DFN,DIC,GMRAOUT,GMRARET,GMA,GMRAUSER
"RTN","GMRAPEM0",13,0)
 D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",14,0)
 Q
"RTN","GMRAPEM0",15,0)
EN21 ; Process patient data and determine if patient is NKA
"RTN","GMRAPEM0",16,0)
 S GMRAOUT=$G(GMRAOUT,0)
"RTN","GMRAPEM0",17,0)
 ; check patient assessment before enter/edit reaction
"RTN","GMRAPEM0",18,0)
 I $$NKA^GMRANKA(DFN),$$NKASCR^GMRANKA(DFN) D  ;delete 120.86 entry if assessment=yes, but no active reactions in 120.8
"RTN","GMRAPEM0",19,0)
 .N DA,DIK
"RTN","GMRAPEM0",20,0)
 .S DIK="^GMR(120.86,",DA=DFN D ^DIK
"RTN","GMRAPEM0",21,0)
 .Q
"RTN","GMRAPEM0",22,0)
 I '$$NKA^GMRANKA(DFN) D NKAASK^GMRANKA(DFN,.GMRAOUT) Q:GMRAOUT  I '$$NKA^GMRANKA(DFN) Q
"RTN","GMRAPEM0",23,0)
 S GMRAOUT=0
"RTN","GMRAPEM0",24,0)
 D:'GMRAOUT SELECT
"RTN","GMRAPEM0",25,0)
 I $G(GMRAPA)'>0 S GMRAOUT=0
"RTN","GMRAPEM0",26,0)
 S GMRARP=1 I 'GMRAOUT D
"RTN","GMRAPEM0",27,0)
 .D ASK^GMRAUTL("Enter another Causative Agent? ",.GMRAOUT,.GMRARP)
"RTN","GMRAPEM0",28,0)
 .I 'GMRARP S GMRACNT=$O(^TMP($J,"GMRASF","B"),-1) D
"RTN","GMRAPEM0",29,0)
 ..I GMRACNT D SIGNOFF^GMRASIGN
"RTN","GMRAPEM0",30,0)
 ..I 'GMRAOUT D IDBAND^GMRASIGN
"RTN","GMRAPEM0",31,0)
 ..I GMRAOUT S GMRAOUT=2-GMRAOUT D:GMRAOUT&($D(^TMP($J,"GMRASF"))) ALERT^GMRASIGN K ^TMP($J,"GMRASF"),GMRACNT
"RTN","GMRAPEM0",32,0)
 ..Q
"RTN","GMRAPEM0",33,0)
 .Q
"RTN","GMRAPEM0",34,0)
 I GMRARP,'GMRAOUT K GMRARP G EN21
"RTN","GMRAPEM0",35,0)
 K GMRARP
"RTN","GMRAPEM0",36,0)
 ; check patient assessment when exiting enter/edit reaction
"RTN","GMRAPEM0",37,0)
 I $$NKA^GMRANKA(DFN),$$NKASCR^GMRANKA(DFN) D  ;delete 120.86 entry if assessment=yes, but no active reactions in 120.8
"RTN","GMRAPEM0",38,0)
 .N DA,DIK
"RTN","GMRAPEM0",39,0)
 .S DIK="^GMR(120.86,",DA=DFN D ^DIK
"RTN","GMRAPEM0",40,0)
 .Q
"RTN","GMRAPEM0",41,0)
 Q
"RTN","GMRAPEM0",42,0)
EN2 ; EDIT PATIENT A/AR (DFN KNOWN)
"RTN","GMRAPEM0",43,0)
 ; Called from the GMRAOR ALLERGY ENTER/EDIT protocol
"RTN","GMRAPEM0",44,0)
 I '$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) S GMRAUSER=1
"RTN","GMRAPEM0",45,0)
 N GMRAOUT
"RTN","GMRAPEM0",46,0)
 D EN21 D
"RTN","GMRAPEM0",47,0)
 .;N GMRAOUT
"RTN","GMRAPEM0",48,0)
 .D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",49,0)
 .Q
"RTN","GMRAPEM0",50,0)
 K GMA,GMRARET,GMRAUSER
"RTN","GMRAPEM0",51,0)
 Q
"RTN","GMRAPEM0",52,0)
ALERT ; PROCESS ALERTS FOR ART
"RTN","GMRAPEM0",53,0)
 N DFN,GMRAPA,GMRACNT,GMRAOUT,GMRANEW,GMRAUSER
"RTN","GMRAPEM0",54,0)
 S (GMRACNT,GMRAOUT,GMRANEW)=0 D
"RTN","GMRAPEM0",55,0)
 .  I $G(XQADATA)="" S XQAKILL=0 Q
"RTN","GMRAPEM0",56,0)
 .  S DFN=$P(XQADATA,U),GMRAPA=$P(XQADATA,U,2),GMRAUSER=$P(XQADATA,U,3) Q:'DFN!'GMRAPA
"RTN","GMRAPEM0",57,0)
 .  I $D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) K GMRAUSER
"RTN","GMRAPEM0",58,0)
 .  S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRAPEM0",59,0)
 .  I $P(GMRAPA(0),U,12) D  Q
"RTN","GMRAPEM0",60,0)
 .  .  W !,"This reaction has been signed off.",$C(7)
"RTN","GMRAPEM0",61,0)
 .  .  D HANGT^GMRAPEH0
"RTN","GMRAPEM0",62,0)
 .  .  S XQAKILL=0
"RTN","GMRAPEM0",63,0)
 .  .  Q
"RTN","GMRAPEM0",64,0)
 .  D EDIT^GMRAPEM4
"RTN","GMRAPEM0",65,0)
 .  D UPDATE^GMRAPEM3
"RTN","GMRAPEM0",66,0)
 .  I '$P(GMRAPA(0),U,12) D SIGNOFF^GMRASIGN
"RTN","GMRAPEM0",67,0)
 .  I GMRAOUT S GMRAOUT=2-GMRAOUT K XQAKILL
"RTN","GMRAPEM0",68,0)
 .  E  D
"RTN","GMRAPEM0",69,0)
 .  .I $P(GMRAPA(0),U,12) S XQAKILL=0
"RTN","GMRAPEM0",70,0)
 .  .I '$P(GMRAPA(0),U,12) K XQAKILL
"RTN","GMRAPEM0",71,0)
 .  D EXIT,EN1^GMRAKILL
"RTN","GMRAPEM0",72,0)
 .  Q
"RTN","GMRAPEM0",73,0)
 Q
"RTN","GMRAPEM0",74,0)
SELECT ;Select a patient reaction
"RTN","GMRAPEM0",75,0)
 S GMRACNT=0 D 1^VADPT
"RTN","GMRAPEM0",76,0)
 S GMRALOC=$P(VAIN(4),U,2),GMRANAM=VADM(1),GMRASEX=VADM(5),GMRAOUT=0,GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0)) D KVAR^VADPT K VA,VAROOT
"RTN","GMRAPEM0",77,0)
 K GMRADUP S GMRALAGO=1
"RTN","GMRAPEM0",78,0)
 D REACT^GMRAPAT(DFN) ; Load all reaction for this patient.
"RTN","GMRAPEM0",79,0)
 D EN1^GMRAPES0
"RTN","GMRAPEM0",80,0)
 I GMRAPA>0 D TYPE D
"RTN","GMRAPEM0",81,0)
 .I GMRAOUT D:$G(GMRANEW)&($$MISSREQ) DELETE S:'$$MISSREQ GMRAOUT=0,^TMP($J,"GMRASF","B",GMRAPA,GMRACNT)="",^TMP($J,"GMRASF",GMRACNT,GMRAPA)="" D:GMRAOUT UPOUT^GMRAPEM3 Q  ; The user up arrows out
"RTN","GMRAPEM0",82,0)
 .I GMRAERR D ERR^GMRAPEM3 Q  ;The reaction was entered in error
"RTN","GMRAPEM0",83,0)
 .I $P(GMRAPA(0),U,12) D SIGNED^GMRAPEM3 Q  ;The reaction has been signed
"RTN","GMRAPEM0",84,0)
 .; Reaction is a new reaction or Update data
"RTN","GMRAPEM0",85,0)
 .D UPDATE^GMRAPEM3
"RTN","GMRAPEM0",86,0)
 .Q
"RTN","GMRAPEM0",87,0)
 Q
"RTN","GMRAPEM0",88,0)
TYPE ; Select the type of the process to use this reaction
"RTN","GMRAPEM0",89,0)
 S GMRAERR=0
"RTN","GMRAPEM0",90,0)
 ; If reaction is not new check to see if user want to enter in error
"RTN","GMRAPEM0",91,0)
 I 'GMRANEW W @IOF N GMRADFN D EN1^GMRAPEE0 I GMRAERR!GMRAOUT Q
"RTN","GMRAPEM0",92,0)
 ;If reaction is observed and signed off
"RTN","GMRAPEM0",93,0)
 I $P(GMRAPA(0),U,6)="o",$P(GMRAPA(0),U,12) D  Q:GMRAOUT
"RTN","GMRAPEM0",94,0)
 .Q:$G(GMRAUSER,0)
"RTN","GMRAPEM0",95,0)
 .N GMRARP
"RTN","GMRAPEM0",96,0)
 .S GMRARP=0 D ASK^GMRAUTL("DO YOU WISH TO EDIT OBSERVED DATA? ",.GMRAOUT,.GMRARP) Q:GMRAOUT
"RTN","GMRAPEM0",97,0)
 .Q:'GMRARP  ;Observed data
"RTN","GMRAPEM0",98,0)
 .N GMRAOD S GMRAOD=$D(^GMR(120.85,"C",GMRAPA)) ;Existing observation data?
"RTN","GMRAPEM0",99,0)
OBSDATE .;
"RTN","GMRAPEM0",100,0)
 .S GMRALAGO=1 F  D EN2^GMRAU85 Q:GMRAPA1>0  Q:GMRAOUT  W !,"You must enter a valid date or an Up-arrow to exit",!,$C(7)
"RTN","GMRAPEM0",101,0)
 .I 'GMRAOUT,GMRAPA1>0  D EN2^GMRAROBS
"RTN","GMRAPEM0",102,0)
 .I '$D(^GMR(120.85,"C",GMRAPA)),$G(GMRANEW)!('$G(GMRANEW)&($G(GMRAOD))) D OBSPROB S GMRAOUT=0 G OBSDATE
"RTN","GMRAPEM0",103,0)
 .Q
"RTN","GMRAPEM0",104,0)
 ;Verify data
"RTN","GMRAPEM0",105,0)
 I 'GMRAERR,$P($G(^GMR(120.8,GMRAPA,0)),U,16)=0,$P(GMRAPA(0),U,12)=1,$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) D  Q:GMRAOUT
"RTN","GMRAPEM0",106,0)
 .K GMRAVER S GMRAVER=0
"RTN","GMRAPEM0",107,0)
 .N GMRAPRNT D EN1^GMRAVFY K GMRALLER,GMRAMEC,GMRAY
"RTN","GMRAPEM0",108,0)
 .I $P($G(^GMR(120.8,GMRAPA,0)),U,16)=1 S GMRASLL(GMRAPA)=1
"RTN","GMRAPEM0",109,0)
 .Q
"RTN","GMRAPEM0",110,0)
 ;EDIT Verified data
"RTN","GMRAPEM0",111,0)
 I 'GMRAERR,$P($G(^GMR(120.8,GMRAPA,0)),U,16)=1,$D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) D  Q:GMRAOUT
"RTN","GMRAPEM0",112,0)
 .Q:$G(GMRAVER)=1
"RTN","GMRAPEM0",113,0)
 .N GMRARP
"RTN","GMRAPEM0",114,0)
 .S GMRARP=0
"RTN","GMRAPEM0",115,0)
 .D ASK^GMRAUTL("DO YOU WISH TO EDIT VERIFIED DATA? ",.GMRAOUT,.GMRARP) Q:GMRAOUT
"RTN","GMRAPEM0",116,0)
 .D:GMRARP SITE^GMRAUTL,EN1^GMRAPED0
"RTN","GMRAPEM0",117,0)
 .Q
"RTN","GMRAPEM0",118,0)
 ;if the reaction is new or not signed off
"RTN","GMRAPEM0",119,0)
 I '$P(GMRAPA(0),U,12) D
"RTN","GMRAPEM0",120,0)
 .D EDIT^GMRAPEM4
"RTN","GMRAPEM0",121,0)
 .I $P($G(^GMR(120.8,GMRAPA,0)),U,16) S GMRASLL(GMRAPA)=1
"RTN","GMRAPEM0",122,0)
 .Q
"RTN","GMRAPEM0",123,0)
 Q
"RTN","GMRAPEM0",124,0)
EXIT S GMRAPA=0 F  S GMRAPA=$O(^TMP($J,"GMRASF","B",GMRAPA)) Q:GMRAPA<1  D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAPEM0",125,0)
 K ^TMP($J,"GMRASF")
"RTN","GMRAPEM0",126,0)
 K ^TMP($J,"GMRALST")
"RTN","GMRAPEM0",127,0)
 Q
"RTN","GMRAPEM0",128,0)
 ;
"RTN","GMRAPEM0",129,0)
DELETE ;Delete entry if required information is not entered - section added in 17
"RTN","GMRAPEM0",130,0)
 N DA,DIK,GMRAPA1
"RTN","GMRAPEM0",131,0)
 W !!,"Required data not entered, deleting entry...",!
"RTN","GMRAPEM0",132,0)
 S GMRAPA1=$O(^GMR(120.85,"C",GMRAPA,0))
"RTN","GMRAPEM0",133,0)
 I GMRAPA1,$G(^GMR(120.85,GMRAPA1,0))="" K ^GMR(120.85,"C",GMRAPA,GMRAPA1)
"RTN","GMRAPEM0",134,0)
 I GMRAPA1 S DIK="^GMR(120.85,",DA=GMRAPA1 D ^DIK D UNLOCK^GMRAUTL(120.85,GMRAPA1)
"RTN","GMRAPEM0",135,0)
 I GMRAPA S DIK="^GMR(120.8,",DA=GMRAPA D ^DIK D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRAPEM0",136,0)
 Q
"RTN","GMRAPEM0",137,0)
 ;
"RTN","GMRAPEM0",138,0)
OBSPROB ;Display help information for missing observed date/time entry
"RTN","GMRAPEM0",139,0)
 W !!,"Observed reactions must have at least one observation entry.",!,"If this reaction is incorrect then enter a date and then proceed",!,"to mark it as entered in error.",!
"RTN","GMRAPEM0",140,0)
 Q
"RTN","GMRAPEM0",141,0)
 ;
"RTN","GMRAPEM0",142,0)
MISSREQ() ;Function determines if required data is missing
"RTN","GMRAPEM0",143,0)
 N GMRA0,TYPE
"RTN","GMRAPEM0",144,0)
 S GMRA0=$G(^GMR(120.8,+$G(GMRAPA),0)) I GMRA0="" Q 1  ;Entry not found
"RTN","GMRAPEM0",145,0)
 S TYPE=$P(GMRA0,U,6) ;Get observed/historical
"RTN","GMRAPEM0",146,0)
 I TYPE="" Q 1  ;Type not entered
"RTN","GMRAPEM0",147,0)
 I TYPE="h" Q 0  ;Historical has no requirements
"RTN","GMRAPEM0",148,0)
 I TYPE="o" I '$D(^GMR(120.85,"C",GMRAPA))!('$O(^GMR(120.85,+$O(^GMR(120.85,"C",GMRAPA,0)),2,0)))!('$$REQCOM) Q 1  ;Missing obs date/time or sign/symptom or required comment
"RTN","GMRAPEM0",149,0)
 Q 0
"RTN","GMRAPEM0",150,0)
 ;
"RTN","GMRAPEM0",151,0)
REQCOM() ;Function determines if comments required
"RTN","GMRAPEM0",152,0)
 I '$D(GMRASITE) D SITE^GMRAUTL
"RTN","GMRAPEM0",153,0)
 I +$P(^GMRD(120.84,+GMRASITE,0),U,4)=0 Q 1  ;Comments required?
"RTN","GMRAPEM0",154,0)
 I $O(^GMR(120.8,GMRAPA,26,0)) Q 1
"RTN","GMRAPEM0",155,0)
 Q 0
"RTN","GMRAPEO0")
0^14^B6816187
"RTN","GMRAPEO0",1,0)
GMRAPEO0 ;HIRMFO/WAA,RM-EDIT OBSERVED A/AR ;8/28/03  14:20
"RTN","GMRAPEO0",2,0)
 ;;4.0;Adverse Reaction Tracking;**8,17**;Mar 29, 1996
"RTN","GMRAPEO0",3,0)
EN1 ; Entry to edit Observed A/AR Data
"RTN","GMRAPEO0",4,0)
 ;This code allows the user to select a concomitant reaction by date.
"RTN","GMRAPEO0",5,0)
 ;If that reactant doesn't have a date, then a new date is added
"RTN","GMRAPEO0",6,0)
 ;for the reactant.
"RTN","GMRAPEO0",7,0)
 N GMRAN85
"RTN","GMRAPEO0",8,0)
 S (GMRAX,GMRAN85)=0 I $D(^GMR(120.85,"C",GMRAPA)) S X=0 F  S X=$O(^GMR(120.85,"C",GMRAPA,X)) Q:X<1  S GMRAX=X
"RTN","GMRAPEO0",9,0)
 I GMRAX K X S:$D(^GMR(120.85,GMRAX,0)) DIC("B")=$P(^GMR(120.85,GMRAX,0),U)
"RTN","GMRAPEO0",10,0)
OBS ; 
"RTN","GMRAPEO0",11,0)
 S GMRALAGO=1 D EN2^GMRAU85 I GMRAOUT D:GMRAPA1 UNLOCK^GMRAUTL(120.85,GMRAPA1) G EXIT
"RTN","GMRAPEO0",12,0)
 I $P($G(^GMR(120.85,+$O(^GMR(120.85,"C",GMRAPA,0)),0)),U)="" W !?4,$C(7),"OBSERVATION DATE IS A REQUIRED ENTRY!!" G OBS
"RTN","GMRAPEO0",13,0)
 I $G(GMRAPA1)<1 W !?4,$C(7),"OBSERVATION DATE IS A REQUIRED ENTRY!!" G OBS
"RTN","GMRAPEO0",14,0)
 D EN1^GMRAPER2(GMRAPA,"120.8",.GMRAOUT,$P(^GMR(120.85,GMRAPA1,0),U))
"RTN","GMRAPEO0",15,0)
 I 'GMRAOUT,$O(^GMR(120.8,GMRAPA,10,0)) D
"RTN","GMRAPEO0",16,0)
 .N GMRAX
"RTN","GMRAPEO0",17,0)
 .K ^GMR(120.85,GMRAPA1,2) ;Clear out s/s before updating
"RTN","GMRAPEO0",18,0)
 .S ^GMR(120.85,GMRAPA1,2,0)="^120.8502P^"_$P(^GMR(120.8,GMRAPA,10,0),U,3,4),GMRAX=0 F  S GMRAX=$O(^GMR(120.8,GMRAPA,10,GMRAX)) Q:GMRAX<1  D
"RTN","GMRAPEO0",19,0)
 ..Q:'$D(^GMR(120.8,GMRAPA,10,GMRAX,0))
"RTN","GMRAPEO0",20,0)
 ..S ^GMR(120.85,GMRAPA1,2,GMRAX,0)=$P(^GMR(120.8,GMRAPA,10,GMRAX,0),U,1,2)_"^"_DUZ
"RTN","GMRAPEO0",21,0)
 ..Q
"RTN","GMRAPEO0",22,0)
 .Q
"RTN","GMRAPEO0",23,0)
 G:GMRAOUT EXIT
"RTN","GMRAPEO0",24,0)
 I $D(^XUSEC("GMRA-ALLERGY VERIFY",DUZ)) D MECH^GMRAPED0
"RTN","GMRAPEO0",25,0)
 G EXIT:GMRAOUT
"RTN","GMRAPEO0",26,0)
 D COMM G EXIT:GMRAOUT
"RTN","GMRAPEO0",27,0)
 D ORR G EXIT:GMRAOUT
"RTN","GMRAPEO0",28,0)
EXIT ; Exit line
"RTN","GMRAPEO0",29,0)
 I $G(GMRAPA1)'<0 D UNLOCK^GMRAUTL(120.85,GMRAPA1)
"RTN","GMRAPEO0",30,0)
 K DA,DIK,DR,GMRADT,GMRAR10,GMRAPA1,GMRARAD,GMRARDL,GMRAREC,GMRADATE,GMRARODT,GMRAROT,GMRARPR,GMRAX,GMRAY,GMRAZN
"RTN","GMRAPEO0",31,0)
 Q
"RTN","GMRAPEO0",32,0)
ORR ; Observed the reserved reaction reports
"RTN","GMRAPEO0",33,0)
 Q:$G(GMRAPA1)<1
"RTN","GMRAPEO0",34,0)
 Q:$G(GMRAUSER,0)
"RTN","GMRAPEO0",35,0)
 F  S %=1 W !,"Complete the observed reaction report" D YN^DICN Q:%=1  S:%<0 %=2 Q:%=2  W:%=0 !,"ENTER YES TO EDIT REACTION DATA OR NO TO SKIP REACTION DATA",$C(7)
"RTN","GMRAPEO0",36,0)
 I %=1 D
"RTN","GMRAPEO0",37,0)
 .N %
"RTN","GMRAPEO0",38,0)
 .D EN2^GMRAROBS
"RTN","GMRAPEO0",39,0)
 .Q
"RTN","GMRAPEO0",40,0)
 E  S:%=-1 GMRAOUT=1
"RTN","GMRAPEO0",41,0)
 Q
"RTN","GMRAPEO0",42,0)
COMM ; Fill in the comments
"RTN","GMRAPEO0",43,0)
 S GMRAVCM="O" D ENDING^GMRAPEM1 Q:GMRAOUT
"RTN","GMRAPEO0",44,0)
 I $D(DTOUT) S GMRAOUT=1
"RTN","GMRAPEO0",45,0)
 I 'GMRAOUT D COMCHECK^GMRAPEH0
"RTN","GMRAPEO0",46,0)
 I 'GMRAOUT G:GMRAREQ COMM
"RTN","GMRAPEO0",47,0)
 S GMRAOUT=0
"RTN","GMRAPEO0",48,0)
 K DUOUT,DTOUT,DA,DR,DIE Q
"RTN","GMRAPEO0",49,0)
 K DA,DR,DIE
"RTN","GMRAPEO0",50,0)
 Q
"RTN","GMRAPES0")
0^6^B69402223
"RTN","GMRAPES0",1,0)
GMRAPES0 ;HIRMFO/RM-SELECT PATIENT ALLERGY TO EDIT ;10/2/03  13:45
"RTN","GMRAPES0",2,0)
 ;;4.0;Adverse Reaction Tracking;**13,17**;Mar 29, 1996
"RTN","GMRAPES0",3,0)
EN1 ; GIVEN DFN, SELECT PATIENT ALLERGY
"RTN","GMRAPES0",4,0)
 N GMRAGOUT,ROOT,CNT,LST,NAM,DIR,GMRAET
"RTN","GMRAPES0",5,0)
 S GMRARET=0
"RTN","GMRAPES0",6,0)
 S GMRAPA=-1,GMRANEW=0 R !!,"Enter Causative Agent: ",GMRALAR:DTIME S:'$T GMRALAR="^^" S:GMRALAR="" GMRARET=1 I "^^"[GMRALAR S GMRAOUT='$L(GMRALAR)+1 G Q1
"RTN","GMRAPES0",7,0)
 I GMRALAR?1P.E!($L(GMRALAR)<3)!($L(GMRALAR)>30) S GMRAHLP=1 D EN1^GMRAHLP0 G EN1:'GMRAOUT,Q1
"RTN","GMRAPES0",8,0)
 I GMRALAR?.E1L.E S GMRALAR=$$UP^XLFSTR(GMRALAR)
"RTN","GMRAPES0",9,0)
PAL K Y,DTOUT,DUOUT S DGSENFLG="",DIC="^GMR(120.8,",DIC(0)="SEZ",X=GMRANAM,DIC("S")="I '+$G(^(""ER"")),$P(^(0),U,2)?@(""1""""""_GMRALAR_"""""".E""),$D(^GMR(120.8,""B"",DFN,+Y))",DIC("W")="W $P(^(0),U,2)"
"RTN","GMRAPES0",10,0)
 W !!,"Checking existing PATIENT ALLERGIES (#120.8) file for matches...",!
"RTN","GMRAPES0",11,0)
 D ^DIC S X=$P($G(Y(0)),"^",2) K DIC,DGSENFLG,DTOUT,DUOUT D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",12,0)
 S:+Y>0 GMRAPA=+Y G Q1:+Y>0!GMRAOUT,PAL:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",13,0)
 G Q1:'GMRALAGO
"RTN","GMRAPES0",14,0)
NPA W !!,"Now checking GMR ALLERGIES (#120.82) file for matches...",!
"RTN","GMRAPES0",15,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^GMRD(120.82,",DIC(0)="EZM",DIC("W")="" D ^DIC K DIC S:+Y>0 X=$P(Y,"^",2) D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",16,0)
 I +Y>0 S GMRAAR=+Y_";GMRD(120.82,",GMRAAR(0)=$P(Y,"^",2),GMRAAR("O")=$P(Y(0),"^",2) D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",17,0)
 G Q1:GMRAOUT,NPA:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",18,0)
ING W !!,"Now checking the INGREDIENTS (#50.416) file for matches...",!
"RTN","GMRAPES0",19,0)
 K Y,DTOUT,DUOUT S D="P",DIC="^PS(50.416,",DIC(0)="SEMZ",X=GMRALAR D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",20,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.416,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",21,0)
 G Q1:GMRAOUT,ING:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",22,0)
CLASS W !!,"Now checking VA DRUG CLASS (50.605) file for matches...",!
"RTN","GMRAPES0",23,0)
 K Y,DTOUT,DUOUT S X=GMRALAR,DIC="^PS(50.605,",DIC(0)="SEZ",D="C" D IX^DIC K DIC D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",24,0)
 I +Y>0 S GMRAAR=+Y_";PS(50.605,",GMRAAR(0)=$S(X?1A.E:X,1:$P(Y,"^",2)),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",25,0)
 G Q1:GMRAOUT,CLASS:X?1"?".E,EN1:Y=0
"RTN","GMRAPES0",26,0)
NDF ;find partial matches and select from NDF
"RTN","GMRAPES0",27,0)
 K Y,DTOUT,DUOUT
"RTN","GMRAPES0",28,0)
 W !!,"Now checking the National Drug File - Generic Names (#50.6)",!
"RTN","GMRAPES0",29,0)
 S DIC=50.6,X=GMRALAR,DIC(0)="EZM" D ^DIC K DIC D DIC
"RTN","GMRAPES0",30,0)
 I +Y>0 S GMRAAR=+Y_";PSNDF(50.6,",GMRAAR(0)=$P(Y,U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",31,0)
 W !!,"Now checking the National Drug File - Trade Names (#50.67)",!
"RTN","GMRAPES0",32,0)
 K DUOUT,DTOUT,Y
"RTN","GMRAPES0",33,0)
 S ROOT=$$T^PSNAPIS,CNT=0,X=GMRALAR
"RTN","GMRAPES0",34,0)
 I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(X)_U_X ;Exact match stores IEN in 50.6 along with trade name
"RTN","GMRAPES0",35,0)
 S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",36,0)
 .S CNT=CNT+1,LST(CNT)=$$TGTOG^PSNAPIS(NAM)_U_NAM
"RTN","GMRAPES0",37,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",38,0)
 I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",39,0)
 I CNT>1 D
"RTN","GMRAPES0",40,0)
 .D MATCHES
"RTN","GMRAPES0",41,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",42,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",43,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",44,0)
 D DIC I GMRAOUT S GMRAOUT=GMRAOUT=1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",45,0)
 I +Y>0 S GMRAAR=+Y(0)_";PSNDF(50.6,",GMRAAR(0)=$P(Y(0),U,2),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",46,0)
DRUG W !!,"Now checking the DRUG (#50) file for matches...",! K Y,DTOUT,DUOUT
"RTN","GMRAPES0",47,0)
 S CNT=0,X=GMRALAR K LST
"RTN","GMRAPES0",48,0)
 F ROOT="^PSDRUG(""B"")","^PSDRUG(""C"")" D
"RTN","GMRAPES0",49,0)
 .I $D(@ROOT@(X)) S CNT=CNT+1,LST(CNT)=$O(@ROOT@(X,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(X,0)),.01)_" <"_X_">",1:X)
"RTN","GMRAPES0",50,0)
 .S NAM=X F  S NAM=$O(@ROOT@(NAM)) Q:NAM=""!($E(NAM,1,$L(X))'=X)  D
"RTN","GMRAPES0",51,0)
 ..S CNT=CNT+1,LST(CNT)=$O(@ROOT@(NAM,0))_U_$S(ROOT["C":$$GET1^DIQ(50,$O(@ROOT@(NAM,0)),.01)_" <"_NAM_">",1:NAM)
"RTN","GMRAPES0",52,0)
 I 'CNT S Y=-1 ;No matches found
"RTN","GMRAPES0",53,0)
 I CNT=1 S Y(0)=LST(1),X=$P(Y(0),U,2),Y=+LST(1) ;Only one choice
"RTN","GMRAPES0",54,0)
 I CNT>1 D
"RTN","GMRAPES0",55,0)
 .D MATCHES
"RTN","GMRAPES0",56,0)
 .S DIR(0)="NAO^1:"_CNT,DIR("A")="Select 1-"_CNT_": "
"RTN","GMRAPES0",57,0)
 .S DIR("?")="Select the number of desired causative agent"
"RTN","GMRAPES0",58,0)
 .D ^DIR S Y=$S(+Y:+Y,1:-1) S:Y>0 Y(0)=LST(Y),X=$P(Y(0),U,2)
"RTN","GMRAPES0",59,0)
 D DIC I GMRAOUT S GMRAOUT=GMRAOUT-1 G:GMRAOUT Q1 G EN1
"RTN","GMRAPES0",60,0)
 I +Y>0 S GMRAAR=+Y(0)_";PSDRUG(",GMRAAR(0)=$$GET1^DIQ(50,+Y(0),.01),GMRAAR("O")="D" D:'GMRAOUT ADAR^GMRAPES1 G EN1:GMRAPA'>0,Q1
"RTN","GMRAPES0",61,0)
YNOTH W !!,"Could not find ",GMRALAR," in any files."
"RTN","GMRAPES0",62,0)
 W !!,"Before sending an email requesting the addition of a new reactant, please",!,"try entering the first 3 or 4 letters of the reactant to search for",!,"the desired entry.",!
"RTN","GMRAPES0",63,0)
 W !,"Would you like to send an email requesting ",GMRALAR,!,"be added as a causative agent?"
"RTN","GMRAPES0",64,0)
 S DIR("A")="Send email"
"RTN","GMRAPES0",65,0)
 S DIR(0)="Y",DIR("B")="NO",DIR("?")="^D MESS^GMRAPES0"
"RTN","GMRAPES0",66,0)
 D ^DIR
"RTN","GMRAPES0",67,0)
 I Y'=+Y S GMRAOUT=1 G Q1
"RTN","GMRAPES0",68,0)
 I '+Y G EN1
"RTN","GMRAPES0",69,0)
YNDRG ;
"RTN","GMRAPES0",70,0)
 D GETINPUT(.GMRAET)
"RTN","GMRAPES0",71,0)
 S X=$$SENDREQ(DUZ,DFN,GMRALAR,.GMRAET)
"RTN","GMRAPES0",72,0)
 I '+X W !!,"Error - Message not sent - ",$P(X,U,2)
"RTN","GMRAPES0",73,0)
 I +X W !!,"Message sent - NOTE: This reactant was NOT added for this patient."
"RTN","GMRAPES0",74,0)
 W !
"RTN","GMRAPES0",75,0)
Q1 ;
"RTN","GMRAPES0",76,0)
 S:GMRAPA>0 GMRAPA(0)=$S($D(^GMR(120.8,+GMRAPA,0)):^(0),1:"")
"RTN","GMRAPES0",77,0)
 K %,D,DA,DIC,DTOUT,DUOUT,GMRAAR,GMRAHLP,GMRAING,GMRALAGO,GMRALAR,PSNDA,PSODA,X,Y
"RTN","GMRAPES0",78,0)
 Q
"RTN","GMRAPES0",79,0)
DIC ; VALIDATE LOOKUP FOR A/AR
"RTN","GMRAPES0",80,0)
 S:$D(DTOUT) X="^^" I X="^^" S GMRAOUT=1 Q
"RTN","GMRAPES0",81,0)
 S:$D(DUOUT) Y=0 Q:+Y'>0
"RTN","GMRAPES0",82,0)
YNOK W !?3,X,"   OK" S %=1 D YN^DICN S:%=-1 GMRAOUT=1,Y=-1 Q:GMRAOUT  S:%=2 Y=-1 S:$$DUPCHK(X,DFN,Y) Y=-1 Q:GMRAOUT  I % W ! Q
"RTN","GMRAPES0",83,0)
 W !?5,$C(7),"ANSWER YES IF THIS IS THE CORRECT ALLERGY/ADVERSE REACTION,",!?5,"ELSE ANSWER NO."
"RTN","GMRAPES0",84,0)
 G YNOK
"RTN","GMRAPES0",85,0)
DUPCHK(X,Y,Z) ;CHECK FOR ENTERED IN ERROR
"RTN","GMRAPES0",86,0)
 N GMRAPA,GMRAGOUT,%,%Y S GMRAGOUT=0
"RTN","GMRAPES0",87,0)
 I $P($G(^GMR(120.8,+Z,0)),U,2)=X Q GMRAGOUT
"RTN","GMRAPES0",88,0)
 I $O(^GMR(120.8,"B",Y,0)) S GMRAPA=0 F  S GMRAPA=$O(^GMR(120.8,"B",Y,GMRAPA)) Q:GMRAPA<1  D  Q:GMRAOUT!(GMRAGOUT)
"RTN","GMRAPES0",89,0)
 .I $P(^GMR(120.8,GMRAPA,0),U,2)'=X Q
"RTN","GMRAPES0",90,0)
 .I $D(^GMR(120.8,GMRAPA,"ER")) D
"RTN","GMRAPES0",91,0)
 ..F  S %=2 W !,?5,$C(7),"This Agent has been Entered in Error once before.",!,?5,"Are you sure you want to select this Agent again" D  Q:%
"RTN","GMRAPES0",92,0)
 ...D YN^DICN S:%'=1 %=2,GMRAOUT=1  S:%Y?2"^" GMRAOUT=2
"RTN","GMRAPES0",93,0)
 ...Q:%  W !,?10,"ENTER 'Y' FOR YES OR 'N' FOR NO"
"RTN","GMRAPES0",94,0)
 ...Q
"RTN","GMRAPES0",95,0)
 ..S GMRAGOUT=%
"RTN","GMRAPES0",96,0)
 ..Q
"RTN","GMRAPES0",97,0)
 .Q
"RTN","GMRAPES0",98,0)
 I GMRAGOUT=0 S GMRAGOUT=1
"RTN","GMRAPES0",99,0)
 Q (GMRAGOUT-1)
"RTN","GMRAPES0",100,0)
MATCHES ; -- List matches for NDF
"RTN","GMRAPES0",101,0)
 N I,J,QUIT
"RTN","GMRAPES0",102,0)
 W !!,"Choose from the following "_+$G(CNT)_" matches:"
"RTN","GMRAPES0",103,0)
 S (I,J,QUIT)=0 F  S I=$O(LST(I)) Q:I'>0  D  Q:QUIT
"RTN","GMRAPES0",104,0)
 . S J=J+1 I '(J#(IOSL-5)) S:'$$MORE QUIT=1 Q:QUIT
"RTN","GMRAPES0",105,0)
 . W !,J,"  ",$P(LST(I),"^",2)
"RTN","GMRAPES0",106,0)
 Q
"RTN","GMRAPES0",107,0)
 ;
"RTN","GMRAPES0",108,0)
MORE()  ; -- show more matches
"RTN","GMRAPES0",109,0)
 N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRAPES0",110,0)
 S DIR(0)="EA",DIR("A")="Press <return> to see more, or ^ to stop ..."
"RTN","GMRAPES0",111,0)
 D ^DIR
"RTN","GMRAPES0",112,0)
 Q +Y
"RTN","GMRAPES0",113,0)
 ;
"RTN","GMRAPES0",114,0)
SENDREQ(USER,PAT,TEXT,GMRAET) ;Send email to GMRA REQUEST NEW REACTANT indicating user's request for a new allergy
"RTN","GMRAPES0",115,0)
 ;Returns 0^reason for error
"RTN","GMRAPES0",116,0)
 ;        1 if successful
"RTN","GMRAPES0",117,0)
 N XMDUZ,XMY,XMSUB,GMRATXT,XMTEXT,XMZ,XMMG,GMRAUI,GMRAPI,GMRAUS,GMRAPS,CNT,J
"RTN","GMRAPES0",118,0)
 Q:'$G(USER)!('+$G(DUZ))!('$L(TEXT)) "0^Required information missing"
"RTN","GMRAPES0",119,0)
 S XMDUZ="Allergy Package",XMSUB="Request to add new reactant"
"RTN","GMRAPES0",120,0)
 S XMY("G.GMRA REQUEST NEW REACTANT")=""
"RTN","GMRAPES0",121,0)
 S XMY(DUZ)="" ;Include requestor in message
"RTN","GMRAPES0",122,0)
 D GETS^DIQ(200,USER,".01;.132;.138;8","E","GMRAUI"),GETS^DIQ(2,PAT,".01;.09","IE","GMRAPI") S GMRAUS=USER_",",GMRAPS=PAT_","
"RTN","GMRAPES0",123,0)
 S CNT=1
"RTN","GMRAPES0",124,0)
 S GMRATXT(CNT)="A request to add "_TEXT_" as a new reactant was entered",CNT=CNT+1
"RTN","GMRAPES0",125,0)
 S GMRATXT(CNT)="by "_GMRAUI(200,GMRAUS,.01,"E")_" for patient "_GMRAPI(2,GMRAPS,.01,"E")_" ("_$E(GMRAPI(2,GMRAPS,.09,"I"),6,9)_")",CNT=CNT+1
"RTN","GMRAPES0",126,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",127,0)
 S GMRATXT(CNT)="User's contact information:",CNT=CNT+1
"RTN","GMRAPES0",128,0)
 S GMRATXT(CNT)="Title        : "_GMRAUI(200,GMRAUS,8,"E"),CNT=CNT+1
"RTN","GMRAPES0",129,0)
 S GMRATXT(CNT)="Office Phone : "_GMRAUI(200,GMRAUS,.132,"E"),CNT=CNT+1
"RTN","GMRAPES0",130,0)
 S GMRATXT(CNT)="Digital Pager: "_GMRAUI(200,GMRAUS,.138,"E"),CNT=CNT+1
"RTN","GMRAPES0",131,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",132,0)
 I $D(GMRAET) S GMRATXT(CNT)="The user added the following comment:",CNT=CNT+1 F J=1:1:$P(GMRAET(0),U,3) S GMRATXT(CNT)=GMRAET(J,0),CNT=CNT+1
"RTN","GMRAPES0",133,0)
 I $D(GMRAET) S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",134,0)
 S GMRATXT(CNT)="Please verify with the user the intended reactant and then take the",CNT=CNT+1
"RTN","GMRAPES0",135,0)
 S GMRATXT(CNT)="appropriate action.  Be sure to try alternate spellings, etc before",CNT=CNT+1
"RTN","GMRAPES0",136,0)
 S GMRATXT(CNT)="adding new local allergies.",CNT=CNT+1
"RTN","GMRAPES0",137,0)
 S GMRATXT(CNT)="",CNT=CNT+1
"RTN","GMRAPES0",138,0)
 S GMRATXT(CNT)="Please note, a reaction WAS NOT entered for this patient!",CNT=CNT+1
"RTN","GMRAPES0",139,0)
 S XMTEXT="GMRATXT("
"RTN","GMRAPES0",140,0)
 D ^XMD
"RTN","GMRAPES0",141,0)
 Q $S($D(XMMG):"0^Mail group GMRA REQUEST NEW REACTANT has no members - contact IRM",1:1)
"RTN","GMRAPES0",142,0)
 ;
"RTN","GMRAPES0",143,0)
MESS ;Provide help for sending email message
"RTN","GMRAPES0",144,0)
 W !,"Enter YES to send an email to the allergy coordinator(s) indicating that",!,"Reactant--> ",GMRALAR,!,"was not found when you were trying to add it for this patient.",!,"Enter NO to try entering the reactant again."
"RTN","GMRAPES0",145,0)
 Q
"RTN","GMRAPES0",146,0)
 ;
"RTN","GMRAPES0",147,0)
GETINPUT(GMRAET) ;Allow user to add comment to message
"RTN","GMRAPES0",148,0)
 N DIC,DWLW,DWPK,DIWEPSE
"RTN","GMRAPES0",149,0)
 S ^TMP($J,"TEXT",0)=""
"RTN","GMRAPES0",150,0)
 S DIC="^TMP($J,""TEXT"","
"RTN","GMRAPES0",151,0)
 S DWLW=70,DWPK=1,DIWEPSE=""
"RTN","GMRAPES0",152,0)
 W !!,"You may now add any comments you may have to the message that",!,"is going to be sent with the request to add this reactant."
"RTN","GMRAPES0",153,0)
 W !,"You may want to add things like sign/symptoms, observed or historical, etc",!,"that may be useful to the reviewer.",!
"RTN","GMRAPES0",154,0)
 D EN^DIWE
"RTN","GMRAPES0",155,0)
 I $O(^TMP($J,"TEXT",0)) M GMRAET=^TMP($J,"TEXT")
"RTN","GMRAPES0",156,0)
 K ^TMP($J,"TEXT")
"RTN","GMRAPES0",157,0)
 Q
"RTN","GMRAPES1")
0^5^B9930531
"RTN","GMRAPES1",1,0)
GMRAPES1 ;HIRMFO/RM,WAA-SELECT PATIENT ALLERGY TO EDIT ;7/28/03  15:23
"RTN","GMRAPES1",2,0)
 ;;4.0;Adverse Reaction Tracking;**13,14,17**;Mar 29, 1996
"RTN","GMRAPES1",3,0)
ADAR ; ADD A NEW A/AR FOR THIS PATIENT
"RTN","GMRAPES1",4,0)
 S GMRAPA="" F X=0:0 S X=$O(^GMR(120.8,"B",DFN,X)) Q:X'>0  I $S('$D(^GMR(120.8,X,0)):0,$P(^(0),"^",2)=GMRAAR(0):1,1:0),$S('$D(^("ER")):1,1:'+^("ER")) S GMRAPA=X Q
"RTN","GMRAPES1",5,0)
 Q:GMRAPA>0
"RTN","GMRAPES1",6,0)
 I $D(XRTL) D T0^%ZOSV ; START RT
"RTN","GMRAPES1",7,0)
 D NOW^%DTC
"RTN","GMRAPES1",8,0)
 S GMRAAR(1)=+$E(%,1,12),DIC="^GMR(120.8,",DIC(0)="LQ",DLAYGO=120.8
"RTN","GMRAPES1",9,0)
 S DIC("DR")=".02////"_GMRAAR(0)_";1////^S X=GMRAAR;4////"_GMRAAR(1)_";5////"_DUZ_";15///0;17///U;3.1////"_$S($G(GMRAAR("O"))'="":GMRAAR("O"),1:"O"),X=DFN
"RTN","GMRAPES1",10,0)
 K DD,DO D FILE^DICN
"RTN","GMRAPES1",11,0)
 K DIC,DLAYGO S GMRAPA=+Y,GMRANEW=Y>0
"RTN","GMRAPES1",12,0)
 S GMRACAUS="RADIOLOGICAL/CONTRAST MEDIA",GMRADRCL=$O(^PS(50.605,"B","DX100",0))_";PS(50.605,"
"RTN","GMRAPES1",13,0)
 K GMRACAUS,GMRADRCL
"RTN","GMRAPES1",14,0)
 I GMRAPA'>0 D  Q  ;Entry is not added
"RTN","GMRAPES1",15,0)
 .   I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV ; STOP RT IF EXITING HERE
"RTN","GMRAPES1",16,0)
 .   Q
"RTN","GMRAPES1",17,0)
 ;
"RTN","GMRAPES1",18,0)
UPDATE ;Updates entry with drug ingredients and/or drug classes - this API added with patch 17
"RTN","GMRAPES1",19,0)
 ;Start of New code to support Drug Classes
"RTN","GMRAPES1",20,0)
 ;This code section will auto stuff Ings and VA Drug Classes
"RTN","GMRAPES1",21,0)
 ;GMRAING() will have all the Ing for the selected reaction
"RTN","GMRAPES1",22,0)
 ;GMRADRCL() will have all the drug classes for the selected
"RTN","GMRAPES1",23,0)
 ;reaction.
"RTN","GMRAPES1",24,0)
 ;If the Reactant is a Drug Ingrediant
"RTN","GMRAPES1",25,0)
 I GMRAAR[50.416 S GMRAING(+GMRAAR)="" G STING
"RTN","GMRAPES1",26,0)
 ;If the Reacant is a Drug Class
"RTN","GMRAPES1",27,0)
 I GMRAAR[50.605 S GMRADRCL(+GMRAAR)=""
"RTN","GMRAPES1",28,0)
 ;If the Reactant is a entry in the GMR ALLERGY file
"RTN","GMRAPES1",29,0)
 I GMRAAR[120.82 D
"RTN","GMRAPES1",30,0)
 .S Y=0 F  S Y=$O(^GMRD(120.82,+GMRAAR,"ING",Y)) Q:Y'>0  I $D(^GMRD(120.82,+GMRAAR,"ING",Y,0)),+^(0)>0 S GMRAING(+^(0))=""
"RTN","GMRAPES1",31,0)
 .S Y=0 F  S Y=$O(^GMRD(120.82,+GMRAAR,"CLASS",Y)) Q:Y'>0  I $D(^GMRD(120.82,+GMRAAR,"CLASS",Y,0)),+^(0)>0 S GMRADRCL(+^(0))=""
"RTN","GMRAPES1",32,0)
 .Q
"RTN","GMRAPES1",33,0)
 I GMRAAR["PSDRUG" D
"RTN","GMRAPES1",34,0)
 .N PSODA
"RTN","GMRAPES1",35,0)
 .S PSODA=+GMRAAR K ^TMP("PSO",$J) D ^PSONGR F Y=0:0 S Y=$O(^TMP("PSO",$J,Y)) Q:Y'>0  S GMRAING(Y)=""
"RTN","GMRAPES1",36,0)
 .N GMRAX,GMRAY
"RTN","GMRAPES1",37,0)
 .S GMRAX=$P($G(^PSDRUG(+GMRAAR,"ND")),U,6) S:GMRAX>0 GMRADRCL(GMRAX)="" Q
"RTN","GMRAPES1",38,0)
 .S GMRAX=$P($G(^PSDRUG(+GMRAAR,0)),U,2) Q:GMRAX=""
"RTN","GMRAPES1",39,0)
 .S GMRAY=$O(^PS(50.605,"B",GMRAX,"")) S:GMRAY>0 GMRADRCL(GMRAY)=""
"RTN","GMRAPES1",40,0)
 .Q
"RTN","GMRAPES1",41,0)
 I GMRAAR["PSNDF" D
"RTN","GMRAPES1",42,0)
 .N PSNDA
"RTN","GMRAPES1",43,0)
 .S PSNDA=+GMRAAR K ^TMP("PSN",$J) D ^PSNNGR F Y=0:0 S Y=$O(^TMP("PSN",$J,Y)) Q:Y'>0  S GMRAING(Y)=""
"RTN","GMRAPES1",44,0)
 .; all classes for NDF entry returned in GMRADRCL
"RTN","GMRAPES1",45,0)
 .N CLASS
"RTN","GMRAPES1",46,0)
 .S CLASS=$$CLIST^PSNAPIS(+GMRAAR,.GMRADRCL)
"RTN","GMRAPES1",47,0)
 .Q
"RTN","GMRAPES1",48,0)
 K ^TMP("PSO",$J),^TMP("PSN",$J),PSOID,PSNID
"RTN","GMRAPES1",49,0)
STING ;Stuffing Drug Ing & VA Drug Classes into file 120.8
"RTN","GMRAPES1",50,0)
 I $D(GMRAING) D
"RTN","GMRAPES1",51,0)
 .S DA(1)=+GMRAPA,DIC="^GMR(120.8,"_+GMRAPA_",2,",DLAYGO=120.8,DIC(0)="L",DIC("P")="120.802PA"
"RTN","GMRAPES1",52,0)
 .F X=0:0 S X=$O(GMRAING(X)) Q:X'>0  I '$D(^GMR(120.8,GMRAPA,2,"B",X)) K DD,DO,DINUM D FILE^DICN
"RTN","GMRAPES1",53,0)
 .K DIC,DLAYGO
"RTN","GMRAPES1",54,0)
 .Q
"RTN","GMRAPES1",55,0)
 I $D(GMRADRCL) D
"RTN","GMRAPES1",56,0)
 .S DA(1)=+GMRAPA,DIC="^GMR(120.8,"_+GMRAPA_",3,",DIC(0)="L",DIC("P")="120.803PA"
"RTN","GMRAPES1",57,0)
 .F X=0:0 S X=$O(GMRADRCL(X)) Q:X'>0  I '$D(^GMR(120.8,GMRAPA,3,"B",X)) K DD,DO,DINUM D FILE^DICN
"RTN","GMRAPES1",58,0)
 .K DIC
"RTN","GMRAPES1",59,0)
 .Q
"RTN","GMRAPES1",60,0)
 I $D(XRT0) S XRTN=$T(+0) D T1^%ZOSV ; STOP RT IF EXITING HERE
"RTN","GMRAPES1",61,0)
 K GMRADRCL,GMRAING
"RTN","GMRAPES1",62,0)
 Q
"RTN","GMRAPET0")
0^8^B19862734
"RTN","GMRAPET0",1,0)
GMRAPET0 ;HIRMFO/RM-VERIFIED ALLERGY TASKS ;7/28/03  08:39
"RTN","GMRAPET0",2,0)
 ;;4.0;Adverse Reaction Tracking;**6,17**;Mar 29, 1996
"RTN","GMRAPET0",3,0)
EN1(GMRADFN,GMRAPA,GMRACT,GMRAOUT) ;
"RTN","GMRAPET0",4,0)
 ; ENTRY TO PERFORM ALL OF THE TASKS NECESSARY FOR
"RTN","GMRAPET0",5,0)
 ;                 A PROGRESS NOTE TO BE ENTERED BY ART
"RTN","GMRAPET0",6,0)
 ;     INPUT:
"RTN","GMRAPET0",7,0)
 ;           GMRADFN = PATIENT IEN IN THE PATIENT FILE
"RTN","GMRAPET0",8,0)
 ;           GMRAPA  = THE IEN IN THE PATIENT ALLERGY FILE
"RTN","GMRAPET0",9,0)
 ;           GMRACT  = THE ACTION TO BE ENTERED FOR THIS REACTION
"RTN","GMRAPET0",10,0)
 ;                   = "V" VERIFICATION OF A REACTION
"RTN","GMRAPET0",11,0)
 ;                   = "S" SIGN OFF OF A REACTION
"RTN","GMRAPET0",12,0)
 ;                   = "M" MEDWATCH FORM ENTERD
"RTN","GMRAPET0",13,0)
 ;                   = "E" REACTION ENERED IN ERROR
"RTN","GMRAPET0",14,0)
 ;      OUTPUT:
"RTN","GMRAPET0",15,0)
 ;           GMRAOUT = REACTION ALL WAS PASSED
"RTN","GMRAPET0",16,0)
 ;                   = 1 USER ABORT OR PN FAIL IN SOME WAY
"RTN","GMRAPET0",17,0)
 ;                   = 0 PASSED
"RTN","GMRAPET0",18,0)
 ;
"RTN","GMRAPET0",19,0)
 ;      VARABLE LIST
"RTN","GMRAPET0",20,0)
 ;        GMRACW = IS THE PROGRESS NOTE TITLE
"RTN","GMRAPET0",21,0)
 ;       GMRALOC = IS THE LOCATION OF THE PATIENT
"RTN","GMRAPET0",22,0)
 ;      GMRAHLOC = IS THE LOCATION IN FILE 44
"RTN","GMRAPET0",23,0)
 ;       GMRADFN = IS THE PATIENT IEN
"RTN","GMRAPET0",24,0)
 ;        GMRADT = IS THE DATE THE EVENT TOOK PLACE
"RTN","GMRAPET0",25,0)
 ;       GMRADUZ = IS THE USER WHO ENTERED THE INFORMATION
"RTN","GMRAPET0",26,0)
 ;        GMRAPN = IS THE IEN OF THE PROGRESS NOTE THAT WAS ENTERED
"RTN","GMRAPET0",27,0)
 ;
"RTN","GMRAPET0",28,0)
 ;CHECKING FOR A VALID TITLE
"RTN","GMRAPET0",29,0)
 K ^TMP("TIUP",$J),GMRAPN
"RTN","GMRAPET0",30,0)
 N GMRACW,GMRALOC,GMRAHLOC
"RTN","GMRAPET0",31,0)
 S GMRAPN=-1
"RTN","GMRAPET0",32,0)
 I "VSME"'[GMRACT S GMRAOUT=1 D EXIT Q
"RTN","GMRAPET0",33,0)
 ; The following lines of code which reference Progress Notes files and
"RTN","GMRAPET0",34,0)
 ; routines will have to change when TIU replaces Progress Notes.
"RTN","GMRAPET0",35,0)
 ;S GMRACW=0 F  S GMRACW=$O(^GMR(121.2,"B","ADVERSE REACTION/ALLERGY",GMRACW)) Q:GMRACW<1  I $P($G(^GMR(121.1,$P($G(^GMR(121.2,GMRACW,0)),U,2),0)),U)="GENERAL NOTE" Q
"RTN","GMRAPET0",36,0)
 ;-----ADDED BY VAUGHN 1/13/97 FOR TIU REPLACES LINE ABOVE----
"RTN","GMRAPET0",37,0)
 S GMRACW=+$$WHATITLE^TIUPUTU("ADVERSE REACTION/ALLERGY")
"RTN","GMRAPET0",38,0)
 ;------END---
"RTN","GMRAPET0",39,0)
 ;-----CHANGED BY VAUGHN 1/13/97 FOR TIU---
"RTN","GMRAPET0",40,0)
 I GMRACW<1!($T(NEW^TIUPNAPI)']"") S GMRAOUT=1 D EXIT Q
"RTN","GMRAPET0",41,0)
 ;I GMRACW<1!($T(PN^GMRPART)']"") S GMRAOUT=1 D EXIT Q
"RTN","GMRAPET0",42,0)
 ;-----END----
"RTN","GMRAPET0",43,0)
 D @GMRACT I GMRAOUT D EXIT Q  ; THIS TELL'S THE PROGRAM WHERE TO GO
"RTN","GMRAPET0",44,0)
 S GMRALOC=""
"RTN","GMRAPET0",45,0)
 D VAD^GMRAUTL1(GMRADFN,"",.GMRALOC,"","","")
"RTN","GMRAPET0",46,0)
 I GMRALOC'="" S GMRAHLOC=+$G(^DIC(42,GMRALOC,44))
"RTN","GMRAPET0",47,0)
 E  D ASK S:Y<1 GMRAOUT=1
"RTN","GMRAPET0",48,0)
 ; Call to Progress Notes
"RTN","GMRAPET0",49,0)
 ; vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
"RTN","GMRAPET0",50,0)
 ;S:'GMRAOUT GMRAPN=+$$PN^GMRPART(GMRADFN,GMRADUZ,GMRADT,GMRACW,GMRAHLOC)
"RTN","GMRAPET0",51,0)
 ;---REPLACED LINE ABOVE WITH LINE BELOW;1/13/97 VAUGHN---
"RTN","GMRAPET0",52,0)
 I 'GMRAOUT D
"RTN","GMRAPET0",53,0)
 .S GMRAPN=0 D NEW^TIUPNAPI(.GMRAPN,GMRADFN,GMRADUZ,GMRADT,GMRACW,GMRAHLOC,1) ;17 - Takes you into document to allow editing)
"RTN","GMRAPET0",54,0)
 ;----------END-------
"RTN","GMRAPET0",55,0)
 I GMRAPN=-1 S GMRAOUT=1 W !,"No Progress Note was created." ; PN not created
"RTN","GMRAPET0",56,0)
 I GMRAPN=0 W !,"Progress note has not been signed." ; PN created but not signed
"RTN","GMRAPET0",57,0)
 D EXIT
"RTN","GMRAPET0",58,0)
 Q
"RTN","GMRAPET0",59,0)
EXIT ; Clean up of variables
"RTN","GMRAPET0",60,0)
 K ^TMP("TIUP",$J),GMRAPN,GMRALOC,GMRAHLOC,GMRADUZ
"RTN","GMRAPET0",61,0)
 Q
"RTN","GMRAPET0",62,0)
ASK ; Simple file manager query for a location in file 44
"RTN","GMRAPET0",63,0)
 N DIC
"RTN","GMRAPET0",64,0)
 S X=""
"RTN","GMRAPET0",65,0)
 S DIC=44,DIC(0)="AEQ",DIC("A")="Select a Hospital Location for this patient: ",DIC("S")="I ""CMW""[$P(^(0),U,3)"
"RTN","GMRAPET0",66,0)
 D ^DIC
"RTN","GMRAPET0",67,0)
 I Y'>0 S GMRAOUT=1 Q
"RTN","GMRAPET0",68,0)
 I $D(DTOUT)!($D(DUOUT)) S GMRAOUT=1 Q
"RTN","GMRAPET0",69,0)
 S GMRAHLOC=+Y
"RTN","GMRAPET0",70,0)
 Q
"RTN","GMRAPET0",71,0)
V ; Verified Reaction
"RTN","GMRAPET0",72,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPET0",73,0)
 S GMRADT=$P(GMRAPA(0),U,17),GMRADUZ=$P(GMRAPA(0),U,18)
"RTN","GMRAPET0",74,0)
 S:GMRADUZ="" GMRADUZ=DUZ ; Autoverified reaction being reverified
"RTN","GMRAPET0",75,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had an "_$S($P(GMRAPA(0),"^",14)="P":"adverse reaction reported for ",1:"allergy to ")_$P(GMRAPA(0),"^",2)
"RTN","GMRAPET0",76,0)
 S ^TMP("TIUP",$J,2,0)="verified on "_$$FMTE^XLFDT(GMRADT,1)_"."
"RTN","GMRAPET0",77,0)
 S ^TMP("TIUP",$J,0)=U_U_"2"_U_"2"_U_GMRADT_"^^^"
"RTN","GMRAPET0",78,0)
 Q
"RTN","GMRAPET0",79,0)
S ; Signed Reaction
"RTN","GMRAPET0",80,0)
 N I,X
"RTN","GMRAPET0",81,0)
 D NOW^%DTC
"RTN","GMRAPET0",82,0)
 S GMRADT=%,GMRADUZ=DUZ
"RTN","GMRAPET0",83,0)
 S X=0,I=2 F  S X=$O(GMRAPA(X)) Q:X<1  S I=I+1,^TMP("TIUP",$J,I,0)="          "_$P($G(^GMR(120.8,X,0)),U,2)
"RTN","GMRAPET0",84,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had the following reaction"_$S(I=3:" ",1:"s ")
"RTN","GMRAPET0",85,0)
 S ^TMP("TIUP",$J,2,0)="signed-off on "_$$FMTE^XLFDT(GMRADT,1)_"."
"RTN","GMRAPET0",86,0)
 S ^TMP("TIUP",$J,0)=U_U_I_U_I_U_GMRADT_"^^^"
"RTN","GMRAPET0",87,0)
 Q
"RTN","GMRAPET0",88,0)
M ; MedWATCH data entered
"RTN","GMRAPET0",89,0)
 N X
"RTN","GMRAPET0",90,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPET0",91,0)
 D NOW^%DTC
"RTN","GMRAPET0",92,0)
 S GMRADT=%,GMRADUZ=DUZ
"RTN","GMRAPET0",93,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had a MEDWatch report completed on "_$$FMTE^XLFDT(GMRADT,1)_" for"
"RTN","GMRAPET0",94,0)
 S ^TMP("TIUP",$J,2,0)=$S($P(GMRAPA(0),"^",14)="P":"an adverse reaction to ",1:"allergy to ")_$P(GMRAPA(0),"^",2)_"."
"RTN","GMRAPET0",95,0)
 S ^TMP("TIUP",$J,0)=U_U_"2"_U_"2"_U_GMRADT_"^^^"
"RTN","GMRAPET0",96,0)
 Q
"RTN","GMRAPET0",97,0)
E ; Reaction Entered in Error
"RTN","GMRAPET0",98,0)
 N GMRAER
"RTN","GMRAPET0",99,0)
 S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRAPET0",100,0)
 S GMRAER=$G(^GMR(120.8,GMRAPA,"ER")) I GMRAER="" S GMRAOUT=1 Q
"RTN","GMRAPET0",101,0)
 S GMRADT=$P(GMRAER,U,2),GMRADUZ=$P(GMRAER,U,3)
"RTN","GMRAPET0",102,0)
 S ^TMP("TIUP",$J,1,0)="This patient has had an "_$S($P(GMRAPA(0),"^",14)="P":"adverse reaction reported for ",1:"allergy to ")_$P(GMRAPA(0),"^",2)
"RTN","GMRAPET0",103,0)
 S ^TMP("TIUP",$J,2,0)="entered in error on "_$$FMTE^XLFDT(GMRADT,1)_"."
"RTN","GMRAPET0",104,0)
 S ^TMP("TIUP",$J,0)=U_U_"2"_U_"2"_U_GMRADT_"^^^"
"RTN","GMRAPET0",105,0)
 Q
"RTN","GMRASIG1")
0^12^B12179593
"RTN","GMRASIG1",1,0)
GMRASIG1 ;HIRMFO/WAA-A/AR PATIENT SIGN OFF PART2 ;7/28/03  14:58
"RTN","GMRASIG1",2,0)
 ;;4.0;Adverse Reaction Tracking;**2,17**;Mar 29, 1996
"RTN","GMRASIG1",3,0)
PRINT ;Print out data to be signed off on
"RTN","GMRASIG1",4,0)
 N DIR,X,Y
"RTN","GMRASIG1",5,0)
 S GMRAPA=""
"RTN","GMRASIG1",6,0)
 I GMRASIGN W @IOF
"RTN","GMRASIG1",7,0)
 W !,"ADVERSE REACTION",!,"----------------",!
"RTN","GMRASIG1",8,0)
 S (GMRAI,GMRACNT)=0
"RTN","GMRASIG1",9,0)
 F  S GMRACNT=$O(^TMP($J,"GMRASF",GMRACNT)) Q:GMRACNT<1  S GMRAPA=$O(^TMP($J,"GMRASF",GMRACNT,0)) Q:GMRAPA<0  D  Q:GMRAOUT  I $Y>(IOSL-4) D PAGE Q:GMRAOUT
"RTN","GMRASIG1",10,0)
 .W ! I GMRASIGN W:GMRACNTT>1 GMRACNT,")"
"RTN","GMRASIG1",11,0)
 .S GMRAG=^GMR(120.8,GMRAPA,0),GMRADRG=$S($P(GMRAG,U,20)="D":1,1:0)
"RTN","GMRASIG1",12,0)
 .W "  ",$P(GMRAG,U,2)
"RTN","GMRASIG1",13,0)
 .K GMRAHEAD
"RTN","GMRASIG1",14,0)
 .K GMRAREC I $D(^GMR(120.8,GMRAPA,10,0)) D
"RTN","GMRASIG1",15,0)
 ..S GMRAOTH=$O(^GMRD(120.83,"B","OTHER REACTION",0))
"RTN","GMRASIG1",16,0)
 ..S GMRAREC=0 F  S GMRAREC=$O(^GMR(120.8,GMRAPA,10,GMRAREC)) Q:GMRAREC'>0  S X=$G(^GMR(120.8,GMRAPA,10,GMRAREC,0)),GMRAREC(GMRAREC)=$S($P(X,U)'=GMRAOTH:$P($G(^GMRD(120.83,+$P(X,U),0)),U),1:$P(X,U,2))
"RTN","GMRASIG1",17,0)
 ..Q
"RTN","GMRASIG1",18,0)
 .I $D(GMRAREC)=11 S GMRAREC=$O(GMRAREC("")) W ?30,"Reactions: ",?42,GMRAREC(GMRAREC)
"RTN","GMRASIG1",19,0)
 .W ?65,$S($P(GMRAG,U,6)="o":"OBSERVED",$P(GMRAG,U,6)="h":"HISTORICAL",1:"")
"RTN","GMRASIG1",20,0)
 .I $G(GMRAREC)>0 F  S GMRAREC=$O(GMRAREC(GMRAREC)) Q:GMRAREC<1  W !,?42,GMRAREC(GMRAREC) I $Y>(IOSL-4) D PAGE Q:GMRAOUT
"RTN","GMRASIG1",21,0)
 .Q:GMRAOUT  D:$Y>(IOSL-4) PAGE Q:GMRAOUT  W !
"RTN","GMRASIG1",22,0)
 .D OUTPUT^GMRAPEM1 Q:GMRAOUT
"RTN","GMRASIG1",23,0)
 .Q
"RTN","GMRASIG1",24,0)
 Q:GMRACNTT'>1
"RTN","GMRASIG1",25,0)
 Q:'GMRASIGN
"RTN","GMRASIG1",26,0)
 W (GMRACNTT+1),")  All of the above",! ;17
"RTN","GMRASIG1",27,0)
 W (GMRACNTT+2),")  None of the above",! ;17
"RTN","GMRASIG1",28,0)
 Q
"RTN","GMRASIG1",29,0)
PAGE ;PAGE
"RTN","GMRASIG1",30,0)
 N DIR
"RTN","GMRASIG1",31,0)
 D ENDPG^GMRADSP3 Q:GMRAOUT
"RTN","GMRASIG1",32,0)
 W @IOF,!
"RTN","GMRASIG1",33,0)
 Q
"RTN","GMRASIG1",34,0)
PNOTE ; Generate a Progress Note for a patient
"RTN","GMRASIG1",35,0)
 Q:$G(GMRAUSER,0)
"RTN","GMRASIG1",36,0)
 N GMRAOUT S GMRAOUT=0
"RTN","GMRASIG1",37,0)
 I $D(GMRASLL) D
"RTN","GMRASIG1",38,0)
 .N GMRAFLL,X
"RTN","GMRASIG1",39,0)
 .S X=0 F  S X=$O(GMRASLL(X)) Q:X<1  D
"RTN","GMRASIG1",40,0)
 ..I GMRASLL(X) Q
"RTN","GMRASIG1",41,0)
 ..I $P($G(^GMR(120.8,X,0)),U,6)'="o" Q
"RTN","GMRASIG1",42,0)
 ..S GMRAFLL(X)=""
"RTN","GMRASIG1",43,0)
 ..Q
"RTN","GMRASIG1",44,0)
 .Q:'$D(GMRAFLL)
"RTN","GMRASIG1",45,0)
 .D EN1^GMRAPET0(DFN,.GMRAFLL,"S",.GMRAOUT)
"RTN","GMRASIG1",46,0)
 .Q
"RTN","GMRASIG1",47,0)
 Q
"RTN","GMRASIG1",48,0)
ENCNT ; Count how many entries where selected and set up Sort order
"RTN","GMRASIG1",49,0)
 S (GMRACNTT,X)=0 K ^TMP($J,"GMRARE") ; Resort the entries
"RTN","GMRASIG1",50,0)
 F  S X=$O(^TMP($J,"GMRASF","B",X)) Q:X<1  D
"RTN","GMRASIG1",51,0)
 .S GMRACNTT=GMRACNTT+1
"RTN","GMRASIG1",52,0)
 .S ^TMP($J,"GMRARE",GMRACNTT,X)=""
"RTN","GMRASIG1",53,0)
 .S ^TMP($J,"GMRARE","B",X,GMRACNTT)=""
"RTN","GMRASIG1",54,0)
 .Q
"RTN","GMRASIG1",55,0)
 K ^TMP($J,"GMRASF")
"RTN","GMRASIG1",56,0)
 M ^TMP($J,"GMRASF")=^TMP($J,"GMRARE")
"RTN","GMRASIG1",57,0)
 K ^TMP($J,"GMRARE")
"RTN","GMRASIG1",58,0)
 Q
"RTN","GMRASIG1",59,0)
YNSO ;Select sign off for a patient
"RTN","GMRASIG1",60,0)
 W @IOF,!,"Causative Agent Data edited this Session:"
"RTN","GMRASIG1",61,0)
 K X D PRINT ; Redisplay the reactions
"RTN","GMRASIG1",62,0)
 K DIR S DIR(0)="L^1:"_(GMRACNTT+2),GMRALL=GMRACNTT+1,GMRANON=GMRACNTT+2 ;17
"RTN","GMRASIG1",63,0)
 S DIR(0)=DIR(0)_"^I X[""."" W !,""DO NOT USE DECIMAL VALUES."",$C(7) K X Q"
"RTN","GMRASIG1",64,0)
 S DIR("A")="Select the Correct data "
"RTN","GMRASIG1",65,0)
 S DIR("?")="^D PRINT^GMRASIG1"
"RTN","GMRASIG1",66,0)
 D ^DIR K DIR
"RTN","GMRASIG1",67,0)
 I $D(DTOUT)!($D(DUOUT)) S Y=GMRANON_","
"RTN","GMRASIG1",68,0)
 I Y=(GMRALL_",") D ALLSNG^GMRASIGN ; User select all the reaction
"RTN","GMRASIG1",69,0)
 I Y=(GMRANON_",") S Y="" ; user select not of the reactions
"RTN","GMRASIG1",70,0)
 I $F(Y,","_GMRALL_",") W !,"INVALID SELECTION: You can only select ",GMRACNT+1,")  All by itself." G YNSO
"RTN","GMRASIG1",71,0)
 I $F(Y,","_GMRANON_",") W !,"INVALID SELECTION: You can only select ",GMRACNT+2,")  None by itself." G YNSO
"RTN","GMRASIG1",72,0)
 Q
"RTN","GMRASIGN")
0^9^B37191101
"RTN","GMRASIGN",1,0)
GMRASIGN ;HIRMFO/WAA-ALLERGY/ADVERSE REACTION PATIENT SIGN OFF ;10/20/03  14:27
"RTN","GMRASIGN",2,0)
 ;;4.0;Adverse Reaction Tracking;**17**;Mar 29, 1996
"RTN","GMRASIGN",3,0)
SIGNOFF ; The signoff code
"RTN","GMRASIGN",4,0)
 N GMRAOUT S GMRAOUT=0
"RTN","GMRASIGN",5,0)
 S GMRASIGN=0
"RTN","GMRASIGN",6,0)
 D ENCNT^GMRASIG1 ; Count entries
"RTN","GMRASIGN",7,0)
 D SOQ ; Display entries and ask if user wants all the entries signed.
"RTN","GMRASIGN",8,0)
 I 'Y D  ; User said no the sign off question
"RTN","GMRASIGN",9,0)
 .I GMRACNTT>1 S GMRASIGN=1 D YNSO^GMRASIG1 I Y'=0 D RANGE(Y) ; User had more than one entry
"RTN","GMRASIGN",10,0)
 .D ALERT ; Ask Delete and trigger alerts for those non delete entries 
"RTN","GMRASIGN",11,0)
 .Q
"RTN","GMRASIGN",12,0)
 K GMRASITE ; force the update of the site parameters
"RTN","GMRASIGN",13,0)
 D PNOTE^GMRASIG1 ; File progress note
"RTN","GMRASIGN",14,0)
 K ^TMP($J,"GMRASF") ; clean up the temp globals
"RTN","GMRASIGN",15,0)
 Q
"RTN","GMRASIGN",16,0)
SOQ ;Sign off on all allergies for a patient
"RTN","GMRASIGN",17,0)
 W @IOF,!,"Causative Agent Data edited this Session:"
"RTN","GMRASIGN",18,0)
 K X D PRINT^GMRASIG1 ; Display entries edit this session
"RTN","GMRASIGN",19,0)
 N DIR
"RTN","GMRASIGN",20,0)
 S DIR(0)="YA",DIR("B")="NO"
"RTN","GMRASIGN",21,0)
 S DIR("?")="PLEASE ENTER 'Y' IF THE DATA IS CORRECT OR 'N' IF IT IS NOT CORRECT"
"RTN","GMRASIGN",22,0)
 S DIR("??")="^D PRINT^GMRASIG1"
"RTN","GMRASIGN",23,0)
 S DIR("A")=$S(GMRACNTT>1:"Are ALL these",1:"Is this")_" correct? "
"RTN","GMRASIGN",24,0)
 D ^DIR
"RTN","GMRASIGN",25,0)
 I $D(DIRUT) S Y=0,GMRAOUT=1 ; user ^ or timed out
"RTN","GMRASIGN",26,0)
 I Y=0 Q  ; user answered no the sign off
"RTN","GMRASIGN",27,0)
 D ALLSNG,RANGE(Y) ; sign all the entries
"RTN","GMRASIGN",28,0)
 S Y=1
"RTN","GMRASIGN",29,0)
 Q
"RTN","GMRASIGN",30,0)
ALLSNG ;Sign off on all
"RTN","GMRASIGN",31,0)
 N X
"RTN","GMRASIGN",32,0)
 S Y="",X=0
"RTN","GMRASIGN",33,0)
 F  S X=$O(^TMP($J,"GMRASF",X)) Q:X<1  S Y=Y_X_","
"RTN","GMRASIGN",34,0)
 Q
"RTN","GMRASIGN",35,0)
RANGE(GMRARNG) ;Sign off select allergies
"RTN","GMRASIGN",36,0)
 ;Input:
"RTN","GMRASIGN",37,0)
 ;   GMRARNG = The entries that need to be signed
"RTN","GMRASIGN",38,0)
 ;
"RTN","GMRASIGN",39,0)
 F I=1:1 S GMRACNT=$P(GMRARNG,",",I) Q:GMRACNT<1  S GMRAPA=$O(^TMP($J,"GMRASF",GMRACNT,0)) Q:GMRAPA'>0  D
"RTN","GMRASIGN",40,0)
 .N I,GMRARNG
"RTN","GMRASIGN",41,0)
 .S DA=GMRAPA,DIE="^GMR(120.8,",DR="15////1" D ^DIE
"RTN","GMRASIGN",42,0)
 .S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRASIGN",43,0)
 .S GMRATYPE=$P(GMRAPA(0),U,20)
"RTN","GMRASIGN",44,0)
 .S GMRASLL(GMRAPA)=0
"RTN","GMRASIGN",45,0)
 .I '$P(GMRAPA(0),U,16) D
"RTN","GMRASIGN",46,0)
 ..N GMRACNT K DR S DA=GMRAPA,DIE="^GMR(120.8,"
"RTN","GMRASIGN",47,0)
 ..I $$VFY(.GMRAPA) D
"RTN","GMRASIGN",48,0)
 ...S DR="19////1;20///N" D ^DIE
"RTN","GMRASIGN",49,0)
 ...Q
"RTN","GMRASIGN",50,0)
 ..E  S DR="19////0" D ^DIE,EN1^GMRAVAB
"RTN","GMRASIGN",51,0)
 ..S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0))
"RTN","GMRASIGN",52,0)
 .I $P(GMRAPA(0),U,6)="o",GMRATYPE["D" D PTBUL^GMRAROBS
"RTN","GMRASIGN",53,0)
 .D  ; Execute the event point for this reaction
"RTN","GMRASIGN",54,0)
 ..Q:'$D(GMRAPA)  S GMRAPA(0)=$G(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRASIGN",55,0)
 ..N OROLD,DFN,GMRACNT S DFN=$P(GMRAPA(0),U)
"RTN","GMRASIGN",56,0)
 ..D INP^VADPT S X=$O(^ORD(101,"B","GMRA SIGN-OFF ON DATA",0))_";ORD(101," D EN^XQOR:X K VAIN,X
"RTN","GMRASIGN",57,0)
 ..Q
"RTN","GMRASIGN",58,0)
 .K ^TMP($J,"GMRASF",GMRACNT,GMRAPA),^TMP($J,"GMRASF","B",GMRAPA,GMRACNT)
"RTN","GMRASIGN",59,0)
 .Q
"RTN","GMRASIGN",60,0)
 Q
"RTN","GMRASIGN",61,0)
ALERT ; SENDS ALERT FOR ALL DATA THAT IS UNSIGNED
"RTN","GMRASIGN",62,0)
 I '$O(^TMP($J,"GMRASF",0)) Q
"RTN","GMRASIGN",63,0)
 D REMAIN ;D DEL^GMRADEL ; Ask user if they want to delete given entries
"RTN","GMRASIGN",64,0)
 Q:$D(XQADATA)  ; user is processing alert
"RTN","GMRASIGN",65,0)
 S (GMRACNT,GMRACNTF)=0 F  S GMRACNT=$O(^TMP($J,"GMRASF",GMRACNT)) Q:GMRACNT<1  S GMRAPA=$O(^TMP($J,"GMRASF",GMRACNT,0)) Q:GMRAPA<1  D
"RTN","GMRASIGN",66,0)
 .S GMRAPA(0)=(^GMR(120.8,GMRAPA,0)) Q:GMRAPA(0)=""
"RTN","GMRASIGN",67,0)
 .S XQA(DUZ)=""
"RTN","GMRASIGN",68,0)
 .S XQAMSG=GMRANAM_" with reaction of "_$P(GMRAPA(0),U,2)_" has not been Signed off."
"RTN","GMRASIGN",69,0)
 .S XQAID="GMASignoff Alert"
"RTN","GMRASIGN",70,0)
 .S XQADATA=DFN_U_GMRAPA_U_$G(GMRAUSER,0)
"RTN","GMRASIGN",71,0)
 .S XQAROU="ALERT^GMRAPEM0"
"RTN","GMRASIGN",72,0)
 .D SETUP^XQALERT
"RTN","GMRASIGN",73,0)
 .D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRASIGN",74,0)
 .I 'GMRACNTF W !,?5,"Please Note that these UNSIGNED Causative Agents ",!,?5,"will not show in the patient's records.",$C(7) D HANGT^GMRAPEH0 S GMRACNTF=1
"RTN","GMRASIGN",75,0)
 .S X=$O(^TMP($J,"GMRASF","B",GMRAPA,0))
"RTN","GMRASIGN",76,0)
 .K ^TMP($J,"GMRASF",X,GMRAPA),^TMP($J,"GMRASF","B",GMRAPA,X)
"RTN","GMRASIGN",77,0)
 .Q
"RTN","GMRASIGN",78,0)
 K XQA,XQAMSG,GMRACNTF
"RTN","GMRASIGN",79,0)
 Q
"RTN","GMRASIGN",80,0)
IDBAND ; Mark ID Bands and Charts for a given patient
"RTN","GMRASIGN",81,0)
 I $D(GMRASLL) D
"RTN","GMRASIGN",82,0)
 .D EN4^GMRAMCB(.GMRASLL,DFN) S GMRAPA=0 F  S GMRAPA=$O(GMRASLL(GMRAPA)) Q:GMRAPA<1  D UNLOCK^GMRAUTL(120.8,GMRAPA)
"RTN","GMRASIGN",83,0)
 .K GMRASLL
"RTN","GMRASIGN",84,0)
 .Q
"RTN","GMRASIGN",85,0)
 Q
"RTN","GMRASIGN",86,0)
VFY(Y) ;THIS FUNCTION WILL RETURN TRUE IF THIS ALLERGY IS AUTO VERIFIED
"RTN","GMRASIGN",87,0)
 N GMRAPASS,X
"RTN","GMRASIGN",88,0)
 S GMRAPASS=0
"RTN","GMRASIGN",89,0)
 I '$D(GMRASITE) D SITE^GMRAUTL
"RTN","GMRASIGN",90,0)
 S X=$G(^GMRD(120.84,+GMRASITE,0))
"RTN","GMRASIGN",91,0)
 S GMRATYPE=$P(Y(0),U,20)
"RTN","GMRASIGN",92,0)
 I @(($P(Y(0),U,6)="o"&($P(X,U,3)\2)!($P(Y(0),U,6)="h"&($P(X,U,3)#2)))_$S($P(X,U,6)="&":"&",1:"!")_(GMRATYPE["F"&($P(X,U,2)\2#2)!(GMRATYPE["D"&($P(X,U,2)#2))!(GMRATYPE["O"&($P(X,U,2)\4)))) S GMRAPASS=1
"RTN","GMRASIGN",93,0)
 Q GMRAPASS
"RTN","GMRASIGN",94,0)
 Q
"RTN","GMRASIGN",95,0)
 ;
"RTN","GMRASIGN",96,0)
REMAIN ;Review remaining entries that were not signed off.  Entire section added with patch 17
"RTN","GMRASIGN",97,0)
 N GMRAPA,LCVJ,Y,DIR,DIRUT,DUOUT,SIGNED,GMRAOUT,GMRANEW,DIC,DONE
"RTN","GMRASIGN",98,0)
 S SIGNED=""
"RTN","GMRASIGN",99,0)
 S LCVJ=0 F  S LCVJ=$O(^TMP($J,"GMRASF",LCVJ)) Q:'+LCVJ  D
"RTN","GMRASIGN",100,0)
 .S GMRAPA=$O(^TMP($J,"GMRASF",LCVJ,0)) Q:'+GMRAPA  S GMRAPA(0)=^GMR(120.8,GMRAPA,0)
"RTN","GMRASIGN",101,0)
 .S DIR(0)="SB^Edit:Edit;Delete:Delete",DIR("B")="Edit",DIR("?")="You must edit or delete the entry.  Entering ^ will return you to editing."
"RTN","GMRASIGN",102,0)
 .S DIR("A")="For reactant "_$P(GMRAPA(0),U,2) D ^DIR S:$G(DIRUT) Y="E"
"RTN","GMRASIGN",103,0)
 .I $E(Y)="D" Q  ;Do nothing if allergy is to be deleted
"RTN","GMRASIGN",104,0)
 .S GMRANEW=0
"RTN","GMRASIGN",105,0)
 .F  D  Q:DONE
"RTN","GMRASIGN",106,0)
 ..S DONE=0,GMRAOUT=0
"RTN","GMRASIGN",107,0)
 ..D EDIT^GMRAPEM4 W !
"RTN","GMRASIGN",108,0)
 ..I $P(^GMR(120.8,GMRAPA,0),U,6)="o" I '$D(^GMR(120.85,"C",GMRAPA))!('$O(^GMR(120.85,+$O(^GMR(120.85,"C",GMRAPA,0)),2,0)))!('$$REQCOM^GMRAPEM0) D  Q
"RTN","GMRASIGN",109,0)
 ...W !,"Observed reactions require the date of the reaction and",!,"sign/symptoms",$S('$$REQCOM^GMRAPEM0:" and comments.",1:"."),!
"RTN","GMRASIGN",110,0)
 ...S DIR(0)="SA^R:Re-edit;D:Delete",DIR("A")="Do you want to (R)e-edit or (D)elete this entry? ",DIR("B")="R" D ^DIR S:Y'="R" DONE=1 Q
"RTN","GMRASIGN",111,0)
 ..I $P(^GMR(120.8,GMRAPA,0),U,6)="h",$D(^GMR(120.85,"C",GMRAPA)) D DELOBS ;Delete observed data if changing to historical
"RTN","GMRASIGN",112,0)
 ..S DIR(0)="Y",DIR("A")="Is this entry now correct",DIR("B")="Y",DIR("?")="Answer yes to accept the allergy.  Enter NO to re-edit.  Enter ^ to delete this entry." D ^DIR
"RTN","GMRASIGN",113,0)
 ..I Y=0 Q
"RTN","GMRASIGN",114,0)
 ..I $G(DIRUT) S DONE=1 Q
"RTN","GMRASIGN",115,0)
 ..S SIGNED=SIGNED_LCVJ_",",DONE=1
"RTN","GMRASIGN",116,0)
 I $L(SIGNED)>1 D RANGE(SIGNED) ;Sign off on accepted allergies
"RTN","GMRASIGN",117,0)
 I $O(^TMP($J,"GMRASF",0)) D DELETE^GMRADEL ;Delete unaccepted entries
"RTN","GMRASIGN",118,0)
 Q
"RTN","GMRASIGN",119,0)
 ;
"RTN","GMRASIGN",120,0)
DELOBS ;Delete observed data from 120.85
"RTN","GMRASIGN",121,0)
 N OIEN,DIK,DA
"RTN","GMRASIGN",122,0)
 S OIEN=0 F  S OIEN=$O(^GMR(120.85,"C",GMRAPA,OIEN)) Q:'+OIEN  S DIK="^GMR(120.85,",DA=OIEN D ^DIK
"RTN","GMRASIGN",123,0)
 Q
"RTN","GMRAUTL")
0^11^B16078280
"RTN","GMRAUTL",1,0)
GMRAUTL ;HIRMFO/YMP,RM,WAA-ALLERGY UTILITIES ;7/28/03  08:40
"RTN","GMRAUTL",2,0)
 ;;4.0;Adverse Reaction Tracking;**17**;Mar 29, 1996
"RTN","GMRAUTL",3,0)
DEV ;Device selecting module
"RTN","GMRAUTL",4,0)
 W !
"RTN","GMRAUTL",5,0)
 S GMRAZIS=$G(GMRAZIS)
"RTN","GMRAUTL",6,0)
 S IOP="Q",%ZIS("B")=""
"RTN","GMRAUTL",7,0)
 S %ZIS="NQ" I GMRAZIS'["Q",GMRAZIS'["M132" S %ZIS("B")="HOME" K IOP
"RTN","GMRAUTL",8,0)
 D ^%ZIS I POP K GMRAZIS Q  ; Select the device (not open)
"RTN","GMRAUTL",9,0)
 I '$D(IO("S")) D  I POP S POP=0 G DEV
"RTN","GMRAUTL",10,0)
 .I $E(IOST)="P",'$D(IO("Q")) W !?4,$C(7),"PRINTED REPORTS MUST BE QUEUED.",! S POP=1
"RTN","GMRAUTL",11,0)
 .Q
"RTN","GMRAUTL",12,0)
 I $G(GMRAZIS)?.E1"M"1N.E D  I POP S POP=0 G DEV
"RTN","GMRAUTL",13,0)
 .I IOM<+$P(GMRAZIS,"M",2) W !!?4,$C(7),"THIS REPORT MUST BE SENT TO A PRINTER WITH A MARGIN OF AT LEAST "_+$P(GMRAZIS,"M",2)_"." S POP=1
"RTN","GMRAUTL",14,0)
 .Q
"RTN","GMRAUTL",15,0)
 I $G(GMRAZIS)?.E1"S"1N.E D  I POP S POP=0 G DEV
"RTN","GMRAUTL",16,0)
 . I IOSL<+$P(GMRAZIS,"S",2) W !!?4,$C(7),"THIS REPORT MUST BE SENT TO A PRINTER WITH PAGE LENGTH OF AT LEAST "_+$P(GMRAZIS,"S",2)_"." S POP=1
"RTN","GMRAUTL",17,0)
 .Q
"RTN","GMRAUTL",18,0)
 I '$D(IO("Q")) S IOP=ION_";"_IOST_";"_IOM_";"_IOSL,%ZIS="" D ^%ZIS I POP G DEV ; Open the device
"RTN","GMRAUTL",19,0)
 K GMRAZIS
"RTN","GMRAUTL",20,0)
 Q
"RTN","GMRAUTL",21,0)
CLOSE ; Close device, and dequeue if queued.
"RTN","GMRAUTL",22,0)
 I 'GMRAOUT D ENDPG^GMRADSP3
"RTN","GMRAUTL",23,0)
 W ! D ^%ZISC
"RTN","GMRAUTL",24,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","GMRAUTL",25,0)
 Q
"RTN","GMRAUTL",26,0)
SITE ; GET SITE PARAMTER NODE
"RTN","GMRAUTL",27,0)
 S GMRASITE=$O(^GMRD(120.84,"SITE",+$G(DUZ(2)),0))
"RTN","GMRAUTL",28,0)
 I 'GMRASITE S GMRASITE=$O(^GMRD(120.84,"B","HOSPITAL",0)) I 'GMRASITE S GMRASITE=$O(^GMRD(120.84,0)) I 'GMRASITE S GMRASITE=1
"RTN","GMRAUTL",29,0)
 Q
"RTN","GMRAUTL",30,0)
LOCK(X,Y,Z) ; LOCKS ^GMR(X,Y,0).  IF IT CAN RETURNS 1, ELSE RETURNS 0
"RTN","GMRAUTL",31,0)
 ; OPTIONAL PAR. Z IF EXISTS AND TRUE WILL PRINT ERROR MSG IF NO LOCK
"RTN","GMRAUTL",32,0)
 L +^GMR(X,Y,0):1
"RTN","GMRAUTL",33,0)
 E  W:$G(Z) !,$C(7),"THIS ENTRY BEING EDITED, TRY LATER."
"RTN","GMRAUTL",34,0)
 Q $T
"RTN","GMRAUTL",35,0)
UNLOCK(X,Y) ; UNLOCKS ^GMR(X,Y,0)
"RTN","GMRAUTL",36,0)
 L -^GMR(X,Y,0)
"RTN","GMRAUTL",37,0)
 Q
"RTN","GMRAUTL",38,0)
OUTTYPE(GMRAY) ; INPUT VARIABLE IS INTERNAL FORMAT OF TYPE FIELD FOR
"RTN","GMRAUTL",39,0)
 ; FILES 120.8 AND 120.82.  THIS FUNCTION RETURNS OUTPUT VALUE
"RTN","GMRAUTL",40,0)
 ; FOR THAT FIELD.
"RTN","GMRAUTL",41,0)
 N FXN,X S FXN=""
"RTN","GMRAUTL",42,0)
 F X=1:1:$L(GMRAY) S FXN=FXN_$S(FXN="":"",1:", ")_$P("^FOOD^DRUG^OTHER","^",$F("FDO",$E(GMRAY,X)))
"RTN","GMRAUTL",43,0)
 Q FXN
"RTN","GMRAUTL",44,0)
INPTYPE(GMRAEN) ; THIS PROCEDURE WILL ALLOW USER TO EDIT TYPE FIELD FOR
"RTN","GMRAUTL",45,0)
 ; FILE AND ENTRY DESIGNATED IN GMRAEN.  GMRAEN IS IN VARIABLE PTR.
"RTN","GMRAUTL",46,0)
 ; FORMAT.
"RTN","GMRAUTL",47,0)
 Q:'+GMRAEN!("^GMRD(120.82,^GMR(120.8,^"'[("^"_$P(GMRAEN,";",2)_"^"))
"RTN","GMRAUTL",48,0)
 N DIE,DA,DR,GMRADEF
"RTN","GMRAUTL",49,0)
 S DIE="^"_$P(GMRAEN,";",2),DA=+GMRAEN,DR=$S(DIE[120.82:1,1:3.1)_"////"
"RTN","GMRAUTL",50,0)
 S GMRADEF=$P($G(@(DIE_DA_",0)")),"^",$S(DIE[120.82:2,1:20))
"RTN","GMRAUTL",51,0)
 D EDTTYPE(.GMRADEF)
"RTN","GMRAUTL",52,0)
 I "^^"[GMRADEF Q
"RTN","GMRAUTL",53,0)
 S DR=DR_GMRADEF D ^DIE
"RTN","GMRAUTL",54,0)
 Q
"RTN","GMRAUTL",55,0)
EDTTYPE(GMRADEF) ; THIS PROCEDURE WILL ALLOW EMULATE THE EDITING OF
"RTN","GMRAUTL",56,0)
 ; TYPE FIELD.  GMRADEF IS THE VARIABLE THAT WILL BE RETURNED, AND MUST
"RTN","GMRAUTL",57,0)
 ; BE PASSED BY REFERENCE.  IT SHOULD BE SET TO THE DEFAULT VALUE OF
"RTN","GMRAUTL",58,0)
 ; THE TYPE PRIOR TO THE EDIT AND WILL BE RETURNED AS THE NEW VALUE.
"RTN","GMRAUTL",59,0)
 ; GMRAOUT WILL BE SET TO 1 IF USER ABNORMALLY EXITS.
"RTN","GMRAUTL",60,0)
 Q:'$D(GMRADEF)
"RTN","GMRAUTL",61,0)
 N DIR,X,Y
"RTN","GMRAUTL",62,0)
 I GMRADEF'="" D
"RTN","GMRAUTL",63,0)
 .   S X=""
"RTN","GMRAUTL",64,0)
 .   I GMRADEF["D" S X=1
"RTN","GMRAUTL",65,0)
 .   I GMRADEF["F" S X=X_$S(X="":"",1:",")_2
"RTN","GMRAUTL",66,0)
 .   I GMRADEF["O" S X=X_$S(X="":"",1:",")_3
"RTN","GMRAUTL",67,0)
 .   S GMRADEF=X
"RTN","GMRAUTL",68,0)
 .   Q
"RTN","GMRAUTL",69,0)
ASKTYP ; This line is where the query for type begins.
"RTN","GMRAUTL",70,0)
 S DIR(0)="LA^1:3",DIR("A",1)="  1   Drug",DIR("A",2)="  2   Food",DIR("A",3)="  3   Other",DIR("A")="Select Classification(s) of Causative Agent: " S:GMRADEF'="" DIR("B")=GMRADEF
"RTN","GMRAUTL",71,0)
 S DIR("?")="This response must be a list or a range, e.g., 1,3 or 1-3."
"RTN","GMRAUTL",72,0)
 D ^DIR
"RTN","GMRAUTL",73,0)
 I $D(DIRUT) S GMRADEF="",GMRAOUT=1 Q
"RTN","GMRAUTL",74,0)
 S GMRADEF="" F X=1:1:3 I Y[X S GMRADEF=GMRADEF_$E("DFO",X)
"RTN","GMRAUTL",75,0)
 Q
"RTN","GMRAUTL",76,0)
INTTYPE(GMRAX) ; INPUT VARIABLE IS INTERNAL VALUE OF TYPE FIELD FOR FILES
"RTN","GMRAUTL",77,0)
 ; 120.8 AND 120.82.  THIS PROCEDURE WILL KILL GMRAX IF IT IS INVALID,
"RTN","GMRAUTL",78,0)
 ; OR WILL RETURN GMRAX IN ITS PROPER FORMAT.  GMRAX MUST BE PASSED BY
"RTN","GMRAUTL",79,0)
 ; REFERENCE.
"RTN","GMRAUTL",80,0)
 N FXN S FXN=1
"RTN","GMRAUTL",81,0)
 I $L(GMRAX)>3 D  ; take text entry ($L>3) and codify or reject
"RTN","GMRAUTL",82,0)
 .   N I,J,K
"RTN","GMRAUTL",83,0)
 .   S K="" F I=1:1 S J=$TR($$UP^XLFSTR($P(GMRAX,",",I))," ") Q:J=""  D
"RTN","GMRAUTL",84,0)
 .   .   I "^DRUG^FOOD^OTHER^"[("^"_J_"^") S J=$E(J) I K'[J S K=$S(J="D":J_K,J="F":$E("D",K["D")_J_$E("O",K["O"),1:K_J)
"RTN","GMRAUTL",85,0)
 .   .   E  S FXN=0
"RTN","GMRAUTL",86,0)
 .   .   Q
"RTN","GMRAUTL",87,0)
 .   I FXN S GMRAX=K
"RTN","GMRAUTL",88,0)
 .   Q
"RTN","GMRAUTL",89,0)
 E  D  ; take coded entry ($L'>3) and validates/formats
"RTN","GMRAUTL",90,0)
 .   I $L($TR(GMRAX,"DFO"))!'$L(GMRAX)!($L(GMRAX,"D")>2)!($L(GMRAX,"F")>2)!($L(GMRAX,"O")>2) S FXN=0 Q
"RTN","GMRAUTL",91,0)
 .   S GMRAX=$E("D",GMRAX["D")_$E("F",GMRAX["F")_$E("O",GMRAX["O")
"RTN","GMRAUTL",92,0)
 .   Q
"RTN","GMRAUTL",93,0)
 I 'FXN K GMRAX
"RTN","GMRAUTL",94,0)
 Q
"RTN","GMRAUTL",95,0)
ASK(GMRATYPE,GMRAOUT,GMRASP) ;Answer yes or no to data type questions
"RTN","GMRAUTL",96,0)
 N DIR,Y,X
"RTN","GMRAUTL",97,0)
 S DIR(0)="YA",DIR("A")=GMRATYPE
"RTN","GMRAUTL",98,0)
 S DIR("B")=$S(GMRASP=0:"NO",1:"YES") D ^DIR
"RTN","GMRAUTL",99,0)
 S:$D(DIRUT) GMRAOUT=1,GMRASP=0
"RTN","GMRAUTL",100,0)
 S:'GMRAOUT GMRASP=Y
"RTN","GMRAUTL",101,0)
 Q
"RTN","GMRAY17")
0^7^B33163113
"RTN","GMRAY17",1,0)
GMRAY17 ;SLC/DAN Post-init for patch 17 ;10/20/03  14:24
"RTN","GMRAY17",2,0)
 ;;4.0;Adverse Reaction Tracking;**17**;Mar 29, 1996
"RTN","GMRAY17",3,0)
 ;
"RTN","GMRAY17",4,0)
 ;DBIA SECTION
"RTN","GMRAY17",5,0)
 ;10063 - %ZTLOAD
"RTN","GMRAY17",6,0)
 ;3744  - $$TESTPAT^VADPT
"RTN","GMRAY17",7,0)
 ;10018 - DIE
"RTN","GMRAY17",8,0)
 ;10013 - DIK
"RTN","GMRAY17",9,0)
 ;2056  - DIQ
"RTN","GMRAY17",10,0)
 ;10103 - XLFDT
"RTN","GMRAY17",11,0)
 ;10104 - XLFSTR
"RTN","GMRAY17",12,0)
 ;10070 - XMD
"RTN","GMRAY17",13,0)
 ;10141 - XPDUTL
"RTN","GMRAY17",14,0)
 ;
"RTN","GMRAY17",15,0)
Q ;Entry point to queue process during install
"RTN","GMRAY17",16,0)
 N ZTRTN,ZTDESC,ZTIO,ZTDTH,ZTSK
"RTN","GMRAY17",17,0)
 S ZTRTN="DQ^GMRAY17",ZTDESC="GMRA*4*17 POST INSTALL ROUTINE",ZTIO="",ZTDTH=$H
"RTN","GMRAY17",18,0)
 D ^%ZTLOAD I '$G(ZTSK) D BMES^XPDUTL("POST INSTALL NOT QUEUED - RUN DQ^GMRA17 AFTER INSTALL FINISHES") Q
"RTN","GMRAY17",19,0)
 D BMES^XPDUTL("Post-install queued as task # "_$G(ZTSK))
"RTN","GMRAY17",20,0)
 Q
"RTN","GMRAY17",21,0)
 ;
"RTN","GMRAY17",22,0)
DQ ;Dequeue
"RTN","GMRAY17",23,0)
 D POST,MAIL
"RTN","GMRAY17",24,0)
 Q
"RTN","GMRAY17",25,0)
 ;
"RTN","GMRAY17",26,0)
POST ;Post-init entry point
"RTN","GMRAY17",27,0)
 ;Update lower case entries
"RTN","GMRAY17",28,0)
 N NAME,IEN,AIEN,DA,DIE,DR,RIEN,SIEN,ROOT,GMRAI,GMRA0,LCV,CNT,PCNT,PROB,DIK,FILE,FILEIEN
"RTN","GMRAY17",29,0)
 ;Re-index 120.85 as previous bug may have left xrefs unset
"RTN","GMRAY17",30,0)
 S DIK="^GMR(120.85," D IXALL^DIK
"RTN","GMRAY17",31,0)
 F ROOT="^GMRD(120.82,""B"")","^GMRD(120.82,""D"")" D
"RTN","GMRAY17",32,0)
 .S NAME=""
"RTN","GMRAY17",33,0)
 .F  S NAME=$O(@ROOT@(NAME)) Q:NAME=""  I NAME?.E1L.E D
"RTN","GMRAY17",34,0)
 ..S IEN=0 F  S IEN=$O(@ROOT@(NAME,IEN)) Q:'+IEN  I '$P(^GMRD(120.82,IEN,0),U,3) D
"RTN","GMRAY17",35,0)
 ...S DIE="^GMRD(120.82,"_$S(ROOT["""D""":"DA(1),3,",1:""),DR=".01///"_$$UP^XLFSTR(NAME)
"RTN","GMRAY17",36,0)
 ...I ROOT["""D""" S DA(1)=IEN,DA=$O(@ROOT@(NAME,IEN,0))
"RTN","GMRAY17",37,0)
 ...I ROOT["""B""" S DA=IEN
"RTN","GMRAY17",38,0)
 ...D ^DIE K DA
"RTN","GMRAY17",39,0)
 ...S AIEN=0 F  S AIEN=$O(^GMR(120.8,"C",NAME,AIEN)) Q:'+AIEN  I $P(^GMR(120.8,AIEN,0),U,3)=(IEN_";GMRD(120.82,") S DIE="^GMR(120.8,",DA=AIEN,DR=".02////"_$$UP^XLFSTR(NAME) D ^DIE K DA D
"RTN","GMRAY17",40,0)
 ....I $D(^GMR(120.85,"C",AIEN)) D  ;Observed reaction for this reactant
"RTN","GMRAY17",41,0)
 .....S RIEN=0 F  S RIEN=$O(^GMR(120.85,"C",AIEN,RIEN)) Q:'+RIEN  D
"RTN","GMRAY17",42,0)
 ......S SIEN=$O(^GMR(120.85,RIEN,3,"B",NAME,0)) Q:'+SIEN
"RTN","GMRAY17",43,0)
 ......S DA(1)=RIEN,DA=SIEN,DIE="^GMR(120.85,DA(1),3,",DR=".01////^S X=$$UP^XLFSTR(NAME)" D ^DIE
"RTN","GMRAY17",44,0)
 ;
"RTN","GMRAY17",45,0)
 ;Find entries in 120.8 that are missing the reactant or are missing additional required data and take appropriate action.
"RTN","GMRAY17",46,0)
 K DA
"RTN","GMRAY17",47,0)
 S GMRAI=0 F  S GMRAI=$O(^GMR(120.8,GMRAI)) Q:'+GMRAI  D
"RTN","GMRAY17",48,0)
 .I '$D(^GMR(120.8,GMRAI,0)) Q  ;Don't process if missing zero node
"RTN","GMRAY17",49,0)
 .S GMRA0=$G(^GMR(120.8,GMRAI,0))
"RTN","GMRAY17",50,0)
 .I $L(GMRA0,U)=1 S DIK="^GMR(120.8,",DA=GMRAI D ^DIK Q  ;Delete entry if only the 1st piece of the zero node is present
"RTN","GMRAY17",51,0)
 .I $P(GMRA0,U,4)'=+$P(GMRA0,U,4) D FIXDATE
"RTN","GMRAY17",52,0)
 .I $P(GMRA0,U,6)="o",$P(GMRA0,U,20)["D" D CHECKOBS
"RTN","GMRAY17",53,0)
 .I $D(^GMR(120.8,GMRAI,10,"B",-1)) D FIXREACT ;If -1 is stored as reactant delete it
"RTN","GMRAY17",54,0)
 .I $P(GMRA0,U,2)="",$P(GMRA0,U,3)'="" D  ;If no reactant but pointer is present then set reactant
"RTN","GMRAY17",55,0)
 ..S ENTRY=$P(GMRA0,U,3)
"RTN","GMRAY17",56,0)
 ..S FILE=+$P(@("^"_$P(ENTRY,";",2)_"0)"),U,2)
"RTN","GMRAY17",57,0)
 ..S FILEIEN=$P(ENTRY,";")
"RTN","GMRAY17",58,0)
 ..S NAME=$$GET1^DIQ(FILE,FILEIEN,$S(FILE'=50.67:.01,1:4))
"RTN","GMRAY17",59,0)
 ..S DIE="^GMR(120.8,",DA=GMRAI,DR=".02////"_NAME D ^DIE
"RTN","GMRAY17",60,0)
 ;Check observed data to make sure it's matched to the right patient
"RTN","GMRAY17",61,0)
 S LCV=0 F  S LCV=$O(^GMR(120.85,LCV)) Q:'+LCV  D
"RTN","GMRAY17",62,0)
 .S GMRA0=$G(^GMR(120.85,LCV,0)) Q:GMRA0=""
"RTN","GMRAY17",63,0)
 .I $P(GMRA0,U,2)'=$P($G(^GMR(120.8,$P(GMRA0,U,15),0)),U) S DIK="^GMR(120.85,",DA=LCV D ^DIK
"RTN","GMRAY17",64,0)
 Q
"RTN","GMRAY17",65,0)
 ;
"RTN","GMRAY17",66,0)
FIXDATE ;Update origination date to get rid of trailing zeros.  Problem was caused by a bug in XLFDT
"RTN","GMRAY17",67,0)
 N DIE,DR,DA
"RTN","GMRAY17",68,0)
 S DIE="^GMR(120.8,",DA=GMRAI,DR="4////"_+$P(GMRA0,U,4)
"RTN","GMRAY17",69,0)
 D ^DIE
"RTN","GMRAY17",70,0)
 Q
"RTN","GMRAY17",71,0)
 ;
"RTN","GMRAY17",72,0)
CHECKOBS ;Check observation data to make sure it's present and accurate
"RTN","GMRAY17",73,0)
 Q:$D(^GMR(120.8,GMRAI,"ER"))!($$TESTPAT^VADPT($P(GMRA0,U)))!($$DECEASED^GMRAFX($P(GMRA0,U)))  ;Stop if allergy entered in error, test patient or deceased patient
"RTN","GMRAY17",74,0)
 I $P(GMRA0,U,12)=1 D
"RTN","GMRAY17",75,0)
 .I '$D(^GMR(120.85,"C",GMRAI)) S PROB($P(GMRA0,U),GMRAI)="OBS" Q  ;Marked as observed but no data
"RTN","GMRAY17",76,0)
 .S J=0 F  S J=$O(^GMR(120.85,"C",GMRAI,J)) Q:'+J  I '$O(^GMR(120.85,J,2,0)) S PROB($P(GMRA0,U),GMRAI)="SS" ;Has observed data but no sign/symptoms
"RTN","GMRAY17",77,0)
 Q
"RTN","GMRAY17",78,0)
 ;
"RTN","GMRAY17",79,0)
MAIL ;Send message indicating post install is finished
"RTN","GMRAY17",80,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,GMRATXT
"RTN","GMRAY17",81,0)
 S XMDUZ="PATCH GMRA*4*17 POST-INSTALL",XMY(.5)="" S:$G(DUZ) XMY(DUZ)=""
"RTN","GMRAY17",82,0)
 S GMRATXT(1)="The post-install routine for patch GMRA*4*17"
"RTN","GMRAY17",83,0)
 S GMRATXT(2)="finished on "_$$FMTE^XLFDT($$NOW^XLFDT)_"."
"RTN","GMRAY17",84,0)
 S GMRATXT(3)=""
"RTN","GMRAY17",85,0)
 S CNT=3 I $D(PROB) D
"RTN","GMRAY17",86,0)
 .S CNT=CNT+1,GMRATXT(CNT)="The following patients have observed allergy entries that are"
"RTN","GMRAY17",87,0)
 .S CNT=CNT+1,GMRATXT(CNT)="signed off (accepted) but are missing required data.  Please review each"
"RTN","GMRAY17",88,0)
 .S CNT=CNT+1,GMRATXT(CNT)="entry and and update (if data is known), mark it as entered in error,"
"RTN","GMRAY17",89,0)
 .S CNT=CNT+1,GMRATXT(CNT)="or leave it alone."
"RTN","GMRAY17",90,0)
 .S CNT=CNT+1,GMRATXT(CNT)=""
"RTN","GMRAY17",91,0)
 .S PCNT=0
"RTN","GMRAY17",92,0)
 .F  S PCNT=$O(PROB(PCNT)) Q:'+PCNT  D
"RTN","GMRAY17",93,0)
 ..S DFN=PCNT D DEM^VADPT
"RTN","GMRAY17",94,0)
 ..S IEN=0 F  S IEN=$O(PROB(PCNT,IEN)) Q:'+IEN  D
"RTN","GMRAY17",95,0)
 ...S CNT=CNT+1
"RTN","GMRAY17",96,0)
 ...S GMRATXT(CNT)=VADM(1)_"  "_$P($P(VADM(2),U,2),"-",3)_"  "_$P(^GMR(120.8,IEN,0),U,2)_" missing "_$S(PROB(PCNT,IEN)="OBS":"observation date",1:"sign/symptoms")
"RTN","GMRAY17",97,0)
 ..S CNT=CNT+1,GMRATXT(CNT)=""
"RTN","GMRAY17",98,0)
 S CNT=CNT+1,GMRATXT(CNT)="You should"_$S($D(PROB):" also ",1:" ")_"run option GMRA PRINT-NOT SIGNED OFF to get a listing"
"RTN","GMRAY17",99,0)
 S CNT=CNT+1,GMRATXT(CNT)="of all entries that have not yet been signed off.  These entries"
"RTN","GMRAY17",100,0)
 S CNT=CNT+1,GMRATXT(CNT)="should be reviewed and updated if possible.  They can be left alone"
"RTN","GMRAY17",101,0)
 S CNT=CNT+1,GMRATXT(CNT)="if additional data is unavailable."
"RTN","GMRAY17",102,0)
 S XMTEXT="GMRATXT(",XMSUB="PATCH GMRA*4*17 Post Install COMPLETED"
"RTN","GMRAY17",103,0)
 D ^XMD
"RTN","GMRAY17",104,0)
 Q
"RTN","GMRAY17",105,0)
 ;
"RTN","GMRAY17",106,0)
FIXREACT ;delete any sign/symptoms erroneously stored as -1
"RTN","GMRAY17",107,0)
 N DIK,DA,RIEN
"RTN","GMRAY17",108,0)
 S DA(1)=GMRAI,DA=$O(^GMR(120.8,GMRAI,10,"B",-1,0)),DIK="^GMR(120.8,DA(1),10," D ^DIK
"RTN","GMRAY17",109,0)
 ;Now check 120.85 for corresponding entries
"RTN","GMRAY17",110,0)
 S RIEN=$O(^GMR(120.85,"C",GMRAI,0)) Q:'+RIEN
"RTN","GMRAY17",111,0)
 S DA(1)=RIEN,DA=$O(^GMR(120.85,RIEN,2,"B",-1,0)),DIK="^GMR(120.85,DA(1),2," D ^DIK
"RTN","GMRAY17",112,0)
 Q
"UP",120.82,120.823,-1)
120.82^3
"UP",120.82,120.823,0)
120.823
"VER")
8.0^22.0
"^DD",120.82,120.82,.01,0)
NAME^RFX^^0;1^K:X[""""!($A(X)=45) X I $D(X) K:$L(X)>30!($L(X)<3)!'(X'?1P.E) X S:$D(X) X=$$UP^XLFSTR(X)
"^DD",120.82,120.82,.01,1,0)
^.1^^-1
"^DD",120.82,120.82,.01,1,1,0)
120.82^B
"^DD",120.82,120.82,.01,1,1,1)
S ^GMRD(120.82,"B",$E(X,1,30),DA)=""
"^DD",120.82,120.82,.01,1,1,2)
K ^GMRD(120.82,"B",$E(X,1,30),DA)
"^DD",120.82,120.82,.01,3)
Answer must be 3-30 characters in length.  It will automatically be converted to upper case.
"^DD",120.82,120.82,.01,21,0)
^.001^1^1^3030613^^^
"^DD",120.82,120.82,.01,21,1,0)
The name of the allergy/adverse reaction.
"^DD",120.82,120.82,.01,"DT")
3030626
"^DD",120.82,120.82,3,0)
SYNONYM^120.823^^3;0
"^DD",120.82,120.82,3,21,0)
^^1^1^2930824^^
"^DD",120.82,120.82,3,21,1,0)
A list of synonyms that can also be used to look up this allergy.
"^DD",120.82,120.823,0)
SYNONYM SUB-FIELD^^.01^1
"^DD",120.82,120.823,0,"NM","SYNONYM")

"^DD",120.82,120.823,.01,0)
SYNONYM^MFX^^0;1^K:X[""""!($A(X)=45) X I $D(X) K:$L(X)>30!($L(X)<2) X S:$D(X) X=$$UP^XLFSTR(X)
"^DD",120.82,120.823,.01,1,0)
^.1
"^DD",120.82,120.823,.01,1,1,0)
120.823^B
"^DD",120.82,120.823,.01,1,1,1)
S ^GMRD(120.82,DA(1),3,"B",$E(X,1,30),DA)=""
"^DD",120.82,120.823,.01,1,1,2)
K ^GMRD(120.82,DA(1),3,"B",$E(X,1,30),DA)
"^DD",120.82,120.823,.01,1,2,0)
120.82^D
"^DD",120.82,120.823,.01,1,2,1)
S ^GMRD(120.82,"D",$E(X,1,30),DA(1),DA)=""
"^DD",120.82,120.823,.01,1,2,2)
K ^GMRD(120.82,"D",$E(X,1,30),DA(1),DA)
"^DD",120.82,120.823,.01,3)
Answer must be 2-30 characters in length.  It will automatically be converted to upper case.
"^DD",120.82,120.823,.01,21,0)
^^1^1^2930824^^^
"^DD",120.82,120.823,.01,21,1,0)
This is a synonym for a particular allergy.
"^DD",120.82,120.823,.01,"DT")
3030728
**END**
**END**
