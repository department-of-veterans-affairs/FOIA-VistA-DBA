Released XOBS*1*2 SEQ #1
Extracted from mail message
**KIDS**:XOBS*1.0*2^

**INSTALL NAME**
XOBS*1.0*2
"BLD",5215,0)
XOBS*1.0*2^VISTALINK SECURITY^0^3040913^y
"BLD",5215,1,0)
^^3^3^3040913^
"BLD",5215,1,1,0)
See the patch description for patch XOBS*1.0*2 on Forum.
"BLD",5215,1,2,0)
 
"BLD",5215,1,3,0)
[M Build: 1.0.2.6]
"BLD",5215,4,0)
^9.64PA^^
"BLD",5215,"KRN",0)
^9.67PA^8989.52^19
"BLD",5215,"KRN",.4,0)
.4
"BLD",5215,"KRN",.401,0)
.401
"BLD",5215,"KRN",.402,0)
.402
"BLD",5215,"KRN",.403,0)
.403
"BLD",5215,"KRN",.5,0)
.5
"BLD",5215,"KRN",.84,0)
.84
"BLD",5215,"KRN",3.6,0)
3.6
"BLD",5215,"KRN",3.8,0)
3.8
"BLD",5215,"KRN",9.2,0)
9.2
"BLD",5215,"KRN",9.8,0)
9.8
"BLD",5215,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5215,"KRN",9.8,"NM",1,0)
XOBSCAV^^0^B52444348
"BLD",5215,"KRN",9.8,"NM",2,0)
XOBSCAV1^^0^B76615545
"BLD",5215,"KRN",9.8,"NM","B","XOBSCAV",1)

"BLD",5215,"KRN",9.8,"NM","B","XOBSCAV1",2)

"BLD",5215,"KRN",19,0)
19
"BLD",5215,"KRN",19.1,0)
19.1
"BLD",5215,"KRN",101,0)
101
"BLD",5215,"KRN",409.61,0)
409.61
"BLD",5215,"KRN",771,0)
771
"BLD",5215,"KRN",870,0)
870
"BLD",5215,"KRN",8989.51,0)
8989.51
"BLD",5215,"KRN",8989.52,0)
8989.52
"BLD",5215,"KRN",8994,0)
8994
"BLD",5215,"KRN","B",.4,.4)

"BLD",5215,"KRN","B",.401,.401)

"BLD",5215,"KRN","B",.402,.402)

"BLD",5215,"KRN","B",.403,.403)

"BLD",5215,"KRN","B",.5,.5)

"BLD",5215,"KRN","B",.84,.84)

"BLD",5215,"KRN","B",3.6,3.6)

"BLD",5215,"KRN","B",3.8,3.8)

"BLD",5215,"KRN","B",9.2,9.2)

"BLD",5215,"KRN","B",9.8,9.8)

"BLD",5215,"KRN","B",19,19)

"BLD",5215,"KRN","B",19.1,19.1)

"BLD",5215,"KRN","B",101,101)

"BLD",5215,"KRN","B",409.61,409.61)

"BLD",5215,"KRN","B",771,771)

"BLD",5215,"KRN","B",870,870)

"BLD",5215,"KRN","B",8989.51,8989.51)

"BLD",5215,"KRN","B",8989.52,8989.52)

"BLD",5215,"KRN","B",8994,8994)

"BLD",5215,"QUES",0)
^9.62^^
"MBREQ")
0
"PKG",554,-1)
1^1
"PKG",554,0)
VISTALINK SECURITY^XOBS^SECURITY SUBSYSTEM FOR VISTALINK
"PKG",554,20,0)
^9.402P^^
"PKG",554,22,0)
^9.49I^1^1
"PKG",554,22,1,0)
1.0^3030930^3040319^12124
"PKG",554,22,1,"PAH",1,0)
2^3040913^101011
"PKG",554,22,1,"PAH",1,1,0)
^^3^3^3040913
"PKG",554,22,1,"PAH",1,1,1,0)
See the patch description for patch XOBS*1.0*2 on Forum.
"PKG",554,22,1,"PAH",1,1,2,0)
 
"PKG",554,22,1,"PAH",1,1,3,0)
[M Build: 1.0.2.6]
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","XOBSCAV")
0^1^B52444348
"RTN","XOBSCAV",1,0)
XOBSCAV ;; kec/oak - VistaLink Access/Verify Security ; 9/13/2004  17:00
"RTN","XOBSCAV",2,0)
 ;;1.0;VistaLink Security;**2**;Aug 20, 2003
"RTN","XOBSCAV",3,0)
 ;;Foundations Toolbox Release v1.0 [Build: 1.0.2.6]
"RTN","XOBSCAV",4,0)
 ;;
"RTN","XOBSCAV",5,0)
 QUIT
"RTN","XOBSCAV",6,0)
 ;
"RTN","XOBSCAV",7,0)
 ; ---------------------------------------------------------------------
"RTN","XOBSCAV",8,0)
 ;      Access/Verify Security: Security Message Request Handler
"RTN","XOBSCAV",9,0)
 ;             (main entry point; utilities; constants)   
"RTN","XOBSCAV",10,0)
 ; ---------------------------------------------------------------------
"RTN","XOBSCAV",11,0)
 ; 
"RTN","XOBSCAV",12,0)
 ; ==== main entry point ====
"RTN","XOBSCAV",13,0)
 ; 
"RTN","XOBSCAV",14,0)
EN(XOBDATA) ; -- handle parsed messages request
"RTN","XOBSCAV",15,0)
 ;
"RTN","XOBSCAV",16,0)
 IF XOBDATA("XOB SECAV","SECURITYTYPE")'=$$MSGTYP^XOBSCAV("request") DO  QUIT
"RTN","XOBSCAV",17,0)
 .;this routine should never see a message not of this type.
"RTN","XOBSCAV",18,0)
 .NEW XOBSPAR SET XOBSPAR(1)=$$MSGTYP^XOBSCAV("request"),XOBSPAR(2)=XOBDATA("SECURITYTYPE")
"RTN","XOBSCAV",19,0)
 .DO ERROR(.XOBR,$PIECE($TEXT(FCLIENT),";;",2),"Unexpected Message Format",183001,$$CHARCHK^XOBVLIB($$EZBLD^DIALOG(183001,.XOBSPAR)))
"RTN","XOBSCAV",20,0)
 ;
"RTN","XOBSCAV",21,0)
 ;---- now process each security message type ----
"RTN","XOBSCAV",22,0)
 IF XOBDATA("XOB SECAV","SECURITYACTION")=$PIECE($TEXT(MSGSETUP),";;",2) DO SENDITXT^XOBSCAV1 QUIT
"RTN","XOBSCAV",23,0)
 IF XOBDATA("XOB SECAV","SECURITYACTION")=$PIECE($TEXT(MSGLGON),";;",2) DO LOGON^XOBSCAV1 QUIT
"RTN","XOBSCAV",24,0)
 IF XOBDATA("XOB SECAV","SECURITYACTION")=$PIECE($TEXT(MSGLGOUT),";;",2) DO LOGOUT^XOBSCAV1 QUIT
"RTN","XOBSCAV",25,0)
 IF XOBDATA("XOB SECAV","SECURITYACTION")=$PIECE($TEXT(MSGSELDV),";;",2) DO DIVSLCT^XOBSCAV1 QUIT
"RTN","XOBSCAV",26,0)
 IF XOBDATA("XOB SECAV","SECURITYACTION")=$PIECE($TEXT(MSGUPDVC),";;",2) DO SENDNVC^XOBSCAV1 QUIT
"RTN","XOBSCAV",27,0)
 IF XOBDATA("XOB SECAV","SECURITYACTION")=$PIECE($TEXT(MSGUSERD),";;",2) DO SENDDEM^XOBSCAV2 QUIT
"RTN","XOBSCAV",28,0)
 ;
"RTN","XOBSCAV",29,0)
 ; done processing all known message types
"RTN","XOBSCAV",30,0)
 NEW XOBSPAR SET XOBSPAR(1)=XOBDATA("XOB SECAV","SECURITYACTION")
"RTN","XOBSCAV",31,0)
 DO ERROR(.XOBR,$PIECE($TEXT(FCLIENT),";;",2),"Unexpected Message Format",183002,$$CHARCHK^XOBVLIB($$EZBLD^DIALOG(183002,.XOBSPAR)))
"RTN","XOBSCAV",32,0)
 QUIT
"RTN","XOBSCAV",33,0)
 ;
"RTN","XOBSCAV",34,0)
 ; ==== utilities ====
"RTN","XOBSCAV",35,0)
 ; 
"RTN","XOBSCAV",36,0)
SENDSEC(XOBR,XOBMSGTP,XOBRSTYP,XOBMSG,XOBSTAT,XOBSCHEM) ; -- stream XML security reply back
"RTN","XOBSCAV",37,0)
 ;
"RTN","XOBSCAV",38,0)
 ; XOBR: internal VistaLink variable
"RTN","XOBSCAV",39,0)
 ; XOBMSGTP: type of message (e.g., gov.va.med.foundations.security.response)
"RTN","XOBSCAV",40,0)
 ; XOBRSTYP: type of response (e.g., AV.SetupAndIntroText)
"RTN","XOBSCAV",41,0)
 ; XOBMSG: message lines to send inside standard wrapper
"RTN","XOBSCAV",42,0)
 ; XOBSTAT: type of result (e.g., success)
"RTN","XOBSCAV",43,0)
 ; XOBSCHEM: noNamespaceSchemaLocation
"RTN","XOBSCAV",44,0)
 ; 
"RTN","XOBSCAV",45,0)
 NEW XOBFILL
"RTN","XOBSCAV",46,0)
 ; -- prepare socket for writing
"RTN","XOBSCAV",47,0)
 DO PRE^XOBVSKT
"RTN","XOBSCAV",48,0)
 ; -- write XML header tag and VistaLink tag
"RTN","XOBSCAV",49,0)
 DO WRITE^XOBVSKT($$ENVHDR^XOBVLIB(XOBMSGTP,XOBSCHEM))
"RTN","XOBSCAV",50,0)
 ; -- write SecurityInfo tag
"RTN","XOBSCAV",51,0)
 DO WRITE^XOBVSKT("<SecurityInfo version="""_$PIECE($TEXT(VRSNSEC),";;",2)_""" />")
"RTN","XOBSCAV",52,0)
 ; -- write Response opening tag
"RTN","XOBSCAV",53,0)
 DO WRITE^XOBVSKT("<Response type="""_XOBRSTYP_""" status="""_XOBSTAT_""">")
"RTN","XOBSCAV",54,0)
  ; -- write lines of message passed in
"RTN","XOBSCAV",55,0)
 NEW XOBI SET XOBI=0 FOR  SET XOBI=$ORDER(XOBMSG(XOBI))  QUIT:'+XOBI  DO WRITE^XOBVSKT(XOBMSG(XOBI))
"RTN","XOBSCAV",56,0)
 ; -- write closing Response tag, closing VistaLink tag
"RTN","XOBSCAV",57,0)
 DO WRITE^XOBVSKT("</Response>")
"RTN","XOBSCAV",58,0)
 DO WRITE^XOBVSKT($$ENVFTR^XOBVLIB())
"RTN","XOBSCAV",59,0)
 ; -- send eot and flush buffer
"RTN","XOBSCAV",60,0)
 DO POST^XOBVSKT
"RTN","XOBSCAV",61,0)
 ;
"RTN","XOBSCAV",62,0)
 KILL XOBDATA("XOB SECAV")
"RTN","XOBSCAV",63,0)
 QUIT
"RTN","XOBSCAV",64,0)
 ;
"RTN","XOBSCAV",65,0)
ERROR(XOBR,XOBFCODE,XOBFSTR,XOBCODE,XOBSTR) ; -- send security error back to client
"RTN","XOBSCAV",66,0)
 ;
"RTN","XOBSCAV",67,0)
 ; XOBR: internal VistaLink variable
"RTN","XOBSCAV",68,0)
 ; XOBFCODE: the fault code
"RTN","XOBSCAV",69,0)
 ; XOBFSTRING: the fault string
"RTN","XOBSCAV",70,0)
 ; XOBCODE: error code
"RTN","XOBSCAV",71,0)
 ; XOBSTR: error message
"RTN","XOBSCAV",72,0)
 ; 
"RTN","XOBSCAV",73,0)
 NEW XOBFILL
"RTN","XOBSCAV",74,0)
 ; -- prepare socket for writing
"RTN","XOBSCAV",75,0)
 DO PRE^XOBVSKT
"RTN","XOBSCAV",76,0)
 ; -- write XML header tag and VistaLink tag
"RTN","XOBSCAV",77,0)
 DO WRITE^XOBVSKT($$ENVHDR^XOBVLIB($PIECE($TEXT(ERRTYPE^XOBSCAV),";;",2),$PIECE($TEXT(SCHERROR^XOBSCAV),";;",2)))
"RTN","XOBSCAV",78,0)
 ; -- write SecurityInfo tag
"RTN","XOBSCAV",79,0)
 DO WRITE^XOBVSKT("<SecurityInfo version="""_$PIECE($TEXT(VRSNSEC),";;",2)_""" />")
"RTN","XOBSCAV",80,0)
 ; -- write fault message
"RTN","XOBSCAV",81,0)
 DO WRITE^XOBVSKT("<Fault>")
"RTN","XOBSCAV",82,0)
 DO WRITE^XOBVSKT("<FaultCode>"_XOBFCODE_"</FaultCode>")
"RTN","XOBSCAV",83,0)
 DO WRITE^XOBVSKT("<FaultString>"_XOBFSTR_"</FaultString>")
"RTN","XOBSCAV",84,0)
 DO WRITE^XOBVSKT("<Detail>")
"RTN","XOBSCAV",85,0)
 DO WRITE^XOBVSKT("<Error code="""_XOBCODE_""">")
"RTN","XOBSCAV",86,0)
 DO WRITE^XOBVSKT("<Message>"_XOBSTR_"</Message>")
"RTN","XOBSCAV",87,0)
 DO WRITE^XOBVSKT("</Error>")
"RTN","XOBSCAV",88,0)
 DO WRITE^XOBVSKT("</Detail>")
"RTN","XOBSCAV",89,0)
 DO WRITE^XOBVSKT("</Fault>")
"RTN","XOBSCAV",90,0)
 DO WRITE^XOBVSKT($$ENVFTR^XOBVLIB())
"RTN","XOBSCAV",91,0)
 ; -- send eot and flush buffer
"RTN","XOBSCAV",92,0)
 DO POST^XOBVSKT
"RTN","XOBSCAV",93,0)
 ; -- log the error/fault unless it's "too many invalid login attempts"
"RTN","XOBSCAV",94,0)
 IF XOBCODE'=183005 DO
"RTN","XOBSCAV",95,0)
 .DO ^%ZTER
"RTN","XOBSCAV",96,0)
 KILL XOBDATA("XOB SECAV")
"RTN","XOBSCAV",97,0)
 QUIT
"RTN","XOBSCAV",98,0)
 ;
"RTN","XOBSCAV",99,0)
POSTTXT(XOBRET,XOBMSG) ; -- adds the post-sign-in-text to a message being prepared
"RTN","XOBSCAV",100,0)
 NEW XOBI,XOBLINE,XOBCNT
"RTN","XOBSCAV",101,0)
 SET XOBCNT="",XOBLINE=1 FOR  SET XOBCNT=$ORDER(XOBMSG(XOBCNT)) QUIT:XOBCNT']""  SET XOBLINE=XOBCNT
"RTN","XOBSCAV",102,0)
 SET XOBLINE=XOBLINE+1,XOBMSG(XOBLINE)="<PostSignInText>"
"RTN","XOBSCAV",103,0)
 ; only return post sign in text if the signon says that the text line count is > 0
"RTN","XOBSCAV",104,0)
 ; (even if, past XOBRET(5), there are actually messages from the post-sign-in text)
"RTN","XOBSCAV",105,0)
 IF XOBRET(5)>0 DO
"RTN","XOBSCAV",106,0)
 .SET XOBI=5 FOR  SET XOBI=$ORDER(XOBRET(XOBI)) QUIT:XOBI']""  DO
"RTN","XOBSCAV",107,0)
 ..SET XOBLINE=XOBLINE+1,XOBMSG(XOBLINE)="<Line>"_$$CHARCHK^XOBVLIB(XOBRET(XOBI))_"</Line>"
"RTN","XOBSCAV",108,0)
 SET XOBLINE=XOBLINE+1,XOBMSG(XOBLINE)="</PostSignInText>"
"RTN","XOBSCAV",109,0)
 QUIT XOBLINE
"RTN","XOBSCAV",110,0)
 ;
"RTN","XOBSCAV",111,0)
ADDDIVS(XOBRET,XOBMSG) ; -- adds division list to a message being prepared
"RTN","XOBSCAV",112,0)
 NEW XOBI,XOBLINE,XOBCNT,XOBDEF
"RTN","XOBSCAV",113,0)
 SET XOBCNT="",XOBLINE=1 FOR  SET XOBCNT=$ORDER(XOBMSG(XOBCNT)) QUIT:XOBCNT']""  SET XOBLINE=XOBCNT
"RTN","XOBSCAV",114,0)
 ;
"RTN","XOBSCAV",115,0)
 SET XOBDEF=$ORDER(^VA(200,DUZ,2,"AX1",1,"")) ; default division if any. Use of ^VA(200,,2,"AX1"): DBIA #4058
"RTN","XOBSCAV",116,0)
 SET XOBLINE=XOBLINE+1,XOBMSG(XOBLINE)="<"_$PIECE($TEXT(PARTTAG),";;",2)_" needDivisionSelection=""true"">"
"RTN","XOBSCAV",117,0)
 SET XOBLINE=XOBLINE+1,XOBMSG(XOBLINE)="<Divisions>"
"RTN","XOBSCAV",118,0)
 SET XOBI=0 FOR  SET XOBI=$ORDER(XOBDIVS(XOBI)) QUIT:XOBI']""  DO
"RTN","XOBSCAV",119,0)
 .SET XOBLINE=XOBLINE+1,XOBMSG(XOBLINE)="<Division ien="""_$PIECE(XOBDIVS(XOBI),U)_""" divName="""_$$CHARCHK^XOBVLIB($PIECE(XOBDIVS(XOBI),U,2))_""" divNumber="""_$$CHARCHK^XOBVLIB($PIECE(XOBDIVS(XOBI),U,3))_""""
"RTN","XOBSCAV",120,0)
 .SET:($PIECE(XOBDIVS(XOBI),U)=XOBDEF) XOBMSG(XOBLINE)=XOBMSG(XOBLINE)_" default=""true"" "
"RTN","XOBSCAV",121,0)
 .SET XOBMSG(XOBLINE)=XOBMSG(XOBLINE)_" />"
"RTN","XOBSCAV",122,0)
 SET XOBLINE=XOBLINE+1,XOBMSG(XOBLINE)="</Divisions>"
"RTN","XOBSCAV",123,0)
 SET XOBLINE=XOBLINE+1,XOBMSG(XOBLINE)="   </"_$PIECE($TEXT(PARTTAG),";;",2)_">"
"RTN","XOBSCAV",124,0)
 ;
"RTN","XOBSCAV",125,0)
 QUIT XOBLINE
"RTN","XOBSCAV",126,0)
 ;
"RTN","XOBSCAV",127,0)
LOGGEDON() ; -- checks if the environment was previously properly set up, e.g.,
"RTN","XOBSCAV",128,0)
 ; logon succeeded in some previous call
"RTN","XOBSCAV",129,0)
 QUIT +$GET(DUZ)
"RTN","XOBSCAV",130,0)
 ;
"RTN","XOBSCAV",131,0)
CRCONTXT(XOBOPTNM) ; -- create the contxt if it doesn't already exist
"RTN","XOBSCAV",132,0)
 ; INPUT VALUE: XOBOPTNM encoded with Kernel encoding algorithm
"RTN","XOBSCAV",133,0)
 ; RETURN VALUE: +result will be 1 if successful, or 0 if unsuccessful
"RTN","XOBSCAV",134,0)
 ; if unsuccessful, result may (or may not) also contain the textual reason for failure
"RTN","XOBSCAV",135,0)
 ; 
"RTN","XOBSCAV",136,0)
 ; Accessing, Setting and Killing of XQY and XQY0: DBIA #4059
"RTN","XOBSCAV",137,0)
 ; 
"RTN","XOBSCAV",138,0)
 NEW XOBRSLT,XOBOPTN1
"RTN","XOBSCAV",139,0)
 ;
"RTN","XOBSCAV",140,0)
 SET XOBOPTN1=$$DECRYP^XUSRB1(XOBOPTNM)
"RTN","XOBSCAV",141,0)
 ; -- if context already set, quit 1
"RTN","XOBSCAV",142,0)
 IF $LENGTH($GET(XQY0)),XQY0=XOBOPTN1 QUIT 1
"RTN","XOBSCAV",143,0)
 ; -- if param is empty string, then kill off the context
"RTN","XOBSCAV",144,0)
 IF XOBOPTN1="" KILL XQY0,XQY QUIT 1
"RTN","XOBSCAV",145,0)
 ; -- otherwise try to create the context
"RTN","XOBSCAV",146,0)
 DO CRCONTXT^XWBSEC(.XOBRSLT,XOBOPTNM) ; use of CRCONTXT^XWBSEC: DBIA #4053
"RTN","XOBSCAV",147,0)
 ; -- return the result
"RTN","XOBSCAV",148,0)
 QUIT XOBRSLT
"RTN","XOBSCAV",149,0)
 ;
"RTN","XOBSCAV",150,0)
CHKCTXT(XOBRPCNM) ; -- does user have access to RPC?
"RTN","XOBSCAV",151,0)
 NEW XWBSEC
"RTN","XOBSCAV",152,0)
 DO CHKPRMIT^XWBSEC(XOBRPCNM) ; use of CHKPRMIT^XWBSEC: DBIA # 4053
"RTN","XOBSCAV",153,0)
 QUIT:'+$LENGTH($GET(XWBSEC)) 1
"RTN","XOBSCAV",154,0)
 QUIT XWBSEC
"RTN","XOBSCAV",155,0)
 ;
"RTN","XOBSCAV",156,0)
 ; ==== Constants ====
"RTN","XOBSCAV",157,0)
 ; 
"RTN","XOBSCAV",158,0)
MSGTYP(XOBRQRS) ; return request message type
"RTN","XOBSCAV",159,0)
 IF XOBRQRS="request" QUIT $PIECE($TEXT(REQTYPE),";;",2)
"RTN","XOBSCAV",160,0)
 IF XOBRQRS="response" QUIT $PIECE($TEXT(RESTYPE),";;",2)
"RTN","XOBSCAV",161,0)
 IF XOBRQRS="error" QUIT $PIECE($TEXT(ERRTYPE),";;",2)
"RTN","XOBSCAV",162,0)
 QUIT ""
"RTN","XOBSCAV",163,0)
SUCCESS() ; resulttype
"RTN","XOBSCAV",164,0)
 QUIT $PIECE($TEXT(RESTYPES+1),";;",2)
"RTN","XOBSCAV",165,0)
FAILURE() ;
"RTN","XOBSCAV",166,0)
 QUIT $PIECE($TEXT(RESTYPES+2),";;",2)
"RTN","XOBSCAV",167,0)
PARTIAL() ;
"RTN","XOBSCAV",168,0)
 QUIT $PIECE($TEXT(RESTYPES+3),";;",2)
"RTN","XOBSCAV",169,0)
 ;
"RTN","XOBSCAV",170,0)
RESTYPES ;Result types
"RTN","XOBSCAV",171,0)
 ;;success
"RTN","XOBSCAV",172,0)
 ;;failure
"RTN","XOBSCAV",173,0)
 ;;partialSuccess
"RTN","XOBSCAV",174,0)
 ;
"RTN","XOBSCAV",175,0)
 ;Message types
"RTN","XOBSCAV",176,0)
REQTYPE ;;gov.va.med.foundations.security.request
"RTN","XOBSCAV",177,0)
RESTYPE ;;gov.va.med.foundations.security.response
"RTN","XOBSCAV",178,0)
ERRTYPE ;;gov.va.med.foundations.security.fault
"RTN","XOBSCAV",179,0)
 ;
"RTN","XOBSCAV",180,0)
 ;Message response types
"RTN","XOBSCAV",181,0)
MSGSETUP ;;AV.SetupAndIntroText
"RTN","XOBSCAV",182,0)
MSGLGON ;;AV.Logon
"RTN","XOBSCAV",183,0)
MSGLGOUT ;;AV.Logout
"RTN","XOBSCAV",184,0)
MSGSELDV ;;AV.SelectDivision
"RTN","XOBSCAV",185,0)
MSGUPDVC ;;AV.UpdateVC
"RTN","XOBSCAV",186,0)
MSGUSERD ;;AV.GetUserDemographics
"RTN","XOBSCAV",187,0)
 ;
"RTN","XOBSCAV",188,0)
 ;Attribute values for response XML messages
"RTN","XOBSCAV",189,0)
VRSNSEC ;;1.0
"RTN","XOBSCAV",190,0)
 ;
"RTN","XOBSCAV",191,0)
 ;XML Tag names
"RTN","XOBSCAV",192,0)
PARTTAG ;;PartialSuccessData
"RTN","XOBSCAV",193,0)
MSGTAG ;;Message
"RTN","XOBSCAV",194,0)
 ;
"RTN","XOBSCAV",195,0)
 ;XML Schemas
"RTN","XOBSCAV",196,0)
SCHERROR ;;secFault.xsd
"RTN","XOBSCAV",197,0)
SCHLGON ;;secLogonResponse.xsd
"RTN","XOBSCAV",198,0)
SCHPARTS ;;secPartialSuccessResponse.xsd
"RTN","XOBSCAV",199,0)
SCHSETUP ;;secSetupIntroResponse.xsd
"RTN","XOBSCAV",200,0)
SCHSIMPL ;;secSimpleResponse.xsd
"RTN","XOBSCAV",201,0)
SCHUSERD ;;secUserDemographicsResponse.xsd
"RTN","XOBSCAV",202,0)
 ;
"RTN","XOBSCAV",203,0)
 ;Faultcodes
"RTN","XOBSCAV",204,0)
FSERVER ;;Server
"RTN","XOBSCAV",205,0)
FCLIENT ;;Client
"RTN","XOBSCAV",206,0)
FVERSION ;;VersionMismatch
"RTN","XOBSCAV",207,0)
FUNDERST ;;MustUnderstand
"RTN","XOBSCAV1")
0^2^B76615545
"RTN","XOBSCAV1",1,0)
XOBSCAV1 ;; kec/oak - VistaLink Access/Verify Security ; 9/13/2004  17:00
"RTN","XOBSCAV1",2,0)
 ;;1.0;VistaLink Security;**2**;Aug 20, 2003
"RTN","XOBSCAV1",3,0)
 ;;Foundations Toolbox Release v1.0 [Build: 1.0.2.6]
"RTN","XOBSCAV1",4,0)
 ;;
"RTN","XOBSCAV1",5,0)
 QUIT
"RTN","XOBSCAV1",6,0)
 ;
"RTN","XOBSCAV1",7,0)
 ; ------------------------------------------------------------------------
"RTN","XOBSCAV1",8,0)
 ;      Access/Verify Security: Security Message Request Handler
"RTN","XOBSCAV1",9,0)
 ;              (specific message request/response pairs)  
"RTN","XOBSCAV1",10,0)
 ; ------------------------------------------------------------------------
"RTN","XOBSCAV1",11,0)
 ; 
"RTN","XOBSCAV1",12,0)
 ; ** Setting/Killing of DUZ covered by blanket SAC Kernel exemption for Foundations
"RTN","XOBSCAV1",13,0)
 ; 
"RTN","XOBSCAV1",14,0)
 ;==== AV.SetupAndIntroText.Request message processing ====
"RTN","XOBSCAV1",15,0)
SENDITXT ; Do Setup and send Intro Text
"RTN","XOBSCAV1",16,0)
 ; TODO: handle here if logins are disabled?
"RTN","XOBSCAV1",17,0)
 ; 
"RTN","XOBSCAV1",18,0)
 NEW XOBSTINF,XOBITINF,XOBMSG,XOBTMP,XOBTMP1,XOBCCMSK,XOBI
"RTN","XOBSCAV1",19,0)
 ; Do SETUP^XUSRB to setup, then INTRO^XUSRB to get intro text
"RTN","XOBSCAV1",20,0)
 ; NOTE: $$GETPEER^%ZOSV currently fails on DSM systems where listener is started by UCX
"RTN","XOBSCAV1",21,0)
 ;       should be fixed w/ patch XU*8.0*265
"RTN","XOBSCAV1",22,0)
 SET XWBTIP=$$GETPEER^%ZOSV ; XWBTIP needed by SETUP^XUSRB. Use of GETPEER^%ZOSV: DBIA #4056
"RTN","XOBSCAV1",23,0)
 ;
"RTN","XOBSCAV1",24,0)
 USE XOBNULL ; protect against direct writes to socket
"RTN","XOBSCAV1",25,0)
 ; note: SETUP/INTRO^XUSRB set current IO to null device
"RTN","XOBSCAV1",26,0)
 SET XWBVER=1.1 ; to allow VistaLink to contact client agent
"RTN","XOBSCAV1",27,0)
 DO SETUP^XUSRB(.XOBSTINF,"") ; use of SETUP^XUSRB: DBIA #4054
"RTN","XOBSCAV1",28,0)
 ;
"RTN","XOBSCAV1",29,0)
 ; start of auto-signon support
"RTN","XOBSCAV1",30,0)
 SET DUZ=$$AUTOXWB^XUS1B() IF DUZ<1 KILL DUZ ; use of $$AUTOXWB^XUS1B: DBIA #4060
"RTN","XOBSCAV1",31,0)
 IF $GET(DUZ)>0 DO NOW^XUSRB SET XUMSG=$$POST^XUSRB(0) IF XUMSG>0 KILL DUZ ; XUSRB calls: DBIA #4061
"RTN","XOBSCAV1",32,0)
 ; do autosignon and quit if DUZ is set
"RTN","XOBSCAV1",33,0)
 IF $GET(DUZ)>0 DO  QUIT
"RTN","XOBSCAV1",34,0)
 .USE XOBPORT ; restore current IO (the TCP port)
"RTN","XOBSCAV1",35,0)
 .SET XOBRET(5)=0 DO LOGFIN
"RTN","XOBSCAV1",36,0)
 .QUIT
"RTN","XOBSCAV1",37,0)
 ; end of auto-signon support
"RTN","XOBSCAV1",38,0)
 ;
"RTN","XOBSCAV1",39,0)
 KILL XWBVER ; once auto-signon fails, don't need to contact client agent
"RTN","XOBSCAV1",40,0)
 ;if failed autosignon, continue w/intro text
"RTN","XOBSCAV1",41,0)
 DO INTRO^XUSRB(.XOBITINF) ; use of INTRO^XUSRB: DBIA #4054
"RTN","XOBSCAV1",42,0)
 ; ** use of USE command covered by blanket SAC Kernel exemption for Foundations
"RTN","XOBSCAV1",43,0)
 USE XOBPORT ; restore current IO (the TCP port)
"RTN","XOBSCAV1",44,0)
 ;
"RTN","XOBSCAV1",45,0)
 SET XOBMSG(1)="<SetupInfo serverName='"_$$CHARCHK^XOBVLIB(XOBSTINF(0))_"' volume='"
"RTN","XOBSCAV1",46,0)
 ; note: next line, "dtime" attribute value is not DTIME, but is the VistaLink heartbeat rate.
"RTN","XOBSCAV1",47,0)
 ;       this is used by the J2SE client code to time out the client dialogs.
"RTN","XOBSCAV1",48,0)
 ;       Value may be replaced w/a signon-specific site parameter later.
"RTN","XOBSCAV1",49,0)
 SET XOBMSG(1)=XOBMSG(1)_$$CHARCHK^XOBVLIB(XOBSTINF(1))_"' uci='"_$$CHARCHK^XOBVLIB(XOBSTINF(2))_"' device='"_$$CHARCHK^XOBVLIB(XOBSTINF(3))_"' numberAttempts='"_$$CHARCHK^XOBVLIB(XOBSTINF(4))_"' dtime='"_$$GETRATE^XOBVLIB()_"'/>"
"RTN","XOBSCAV1",50,0)
 ; control character mask
"RTN","XOBSCAV1",51,0)
 SET XOBCCMSK="" F XOBI=0:1:8,11,12,14:1:31 S XOBCCMSK=XOBCCMSK_$CHAR(XOBI)
"RTN","XOBSCAV1",52,0)
 ; introductory text
"RTN","XOBSCAV1",53,0)
 SET XOBTMP=2,XOBMSG(XOBTMP)="<IntroText><![CDATA["
"RTN","XOBSCAV1",54,0)
 SET XOBTMP1=-1 FOR  SET XOBTMP1=$ORDER(XOBITINF(XOBTMP1)) QUIT:XOBTMP1']""  DO
"RTN","XOBSCAV1",55,0)
 .SET XOBTMP=XOBTMP+1,XOBMSG(XOBTMP)=$TRANSLATE(XOBITINF(XOBTMP1),XOBCCMSK,"")_"<BR>"
"RTN","XOBSCAV1",56,0)
 SET XOBMSG(XOBTMP+1)="]]></IntroText>"
"RTN","XOBSCAV1",57,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGSETUP^XOBSCAV),";;",2),.XOBMSG,$$SUCCESS^XOBSCAV(),$PIECE($TEXT(SCHSETUP^XOBSCAV),";;",2))
"RTN","XOBSCAV1",58,0)
 QUIT
"RTN","XOBSCAV1",59,0)
 ;
"RTN","XOBSCAV1",60,0)
 ;==== AV.Logon.Request message processing ====
"RTN","XOBSCAV1",61,0)
LOGON ; process login request
"RTN","XOBSCAV1",62,0)
 NEW XOBAC,XOBVC,XOBRET,XOBRETDV
"RTN","XOBSCAV1",63,0)
 ;
"RTN","XOBSCAV1",64,0)
 IF $$LOGGEDON^XOBSCAV DO  QUIT
"RTN","XOBSCAV1",65,0)
 .DO ERROR^XOBSCAV(.XOBR,$PIECE($TEXT(FSERVER^XOBSCAV),";;",2),"Server Partition State",183003,$$CHARCHK^XOBVLIB($$EZBLD^DIALOG(183003)))
"RTN","XOBSCAV1",66,0)
 ;
"RTN","XOBSCAV1",67,0)
 KILL DUZ ; if DUZ is around, it shouldn't be.
"RTN","XOBSCAV1",68,0)
 USE XOBNULL ; protect against direct writes to socket
"RTN","XOBSCAV1",69,0)
 ; try to logon w/avcodes
"RTN","XOBSCAV1",70,0)
 DO VALIDAV^XUSRB(.XOBRET,XOBDATA("XOB SECAV","AVCODE")) ; use of VALIDAV^XUSRB: DBIA#4054
"RTN","XOBSCAV1",71,0)
 USE XOBPORT ; restore current IO (the TCP port)
"RTN","XOBSCAV1",72,0)
 ;
"RTN","XOBSCAV1",73,0)
 ; if bad a/v code credentials
"RTN","XOBSCAV1",74,0)
 IF '+XOBRET(0),'+XOBRET(1),'+XOBRET(2) DO LOGBADCD QUIT
"RTN","XOBSCAV1",75,0)
 ;
"RTN","XOBSCAV1",76,0)
 ; if Kernel says user needs to change verify code
"RTN","XOBSCAV1",77,0)
 IF '+XOBRET(0),'+XOBRET(1),XOBRET(2) DO LOGCVC QUIT
"RTN","XOBSCAV1",78,0)
 ;
"RTN","XOBSCAV1",79,0)
 IF '+XOBRET(0) DO  QUIT  ; there was an error
"RTN","XOBSCAV1",80,0)
 .NEW XOBSPAR SET XOBSPAR(1)=$GET(XOBRET(3))
"RTN","XOBSCAV1",81,0)
 .; look for particular error string which means too many invalid sign-on attempts
"RTN","XOBSCAV1",82,0)
 .IF XOBSPAR(1)["too many invalid sign-on attempts" DO ERROR^XOBSCAV(.XOBR,$PIECE($TEXT(FSERVER^XOBSCAV),";;",2),"Logon Failed",183005,$$CHARCHK^XOBVLIB($$EZBLD^DIALOG(183005,.XOBSPAR))) QUIT
"RTN","XOBSCAV1",83,0)
 .DO ERROR^XOBSCAV(.XOBR,$PIECE($TEXT(FSERVER^XOBSCAV),";;",2),"Logon Failed",183004,$$CHARCHK^XOBVLIB($$EZBLD^DIALOG(183004,.XOBSPAR)))
"RTN","XOBSCAV1",84,0)
 ;
"RTN","XOBSCAV1",85,0)
 ; if user requested to change verify code
"RTN","XOBSCAV1",86,0)
 IF XOBDATA("XOB SECAV","REQUESTCVC")="true" DO LOGCVC QUIT
"RTN","XOBSCAV1",87,0)
 ;
"RTN","XOBSCAV1",88,0)
 ; at this point login was successful.
"RTN","XOBSCAV1",89,0)
 DO LOGFIN
"RTN","XOBSCAV1",90,0)
 QUIT
"RTN","XOBSCAV1",91,0)
 ;
"RTN","XOBSCAV1",92,0)
LOGFIN ; check the divisions, finish login now
"RTN","XOBSCAV1",93,0)
 NEW XOBRETDV DO DIVGET^XUSRB2(.XOBRETDV,DUZ) ; use of DIVGET^XUSRB2: DBIA #4055
"RTN","XOBSCAV1",94,0)
 IF '+XOBRETDV(0) DO LOGOK QUIT
"RTN","XOBSCAV1",95,0)
 ; otherwise this is a multidivisional user
"RTN","XOBSCAV1",96,0)
 DO LOGSELDV(.XOBRETDV)
"RTN","XOBSCAV1",97,0)
 QUIT
"RTN","XOBSCAV1",98,0)
 ;
"RTN","XOBSCAV1",99,0)
LOGBADCD ; response if bad a/v code pair
"RTN","XOBSCAV1",100,0)
 NEW XOBMSG
"RTN","XOBSCAV1",101,0)
 SET XOBMSG(1)="<"_$PIECE($TEXT(MSGTAG^XOBSCAV),";;",2)_">"_$$CHARCHK^XOBVLIB(XOBRET(3))_"</"_$PIECE($TEXT(MSGTAG^XOBSCAV),";;",2)_">"
"RTN","XOBSCAV1",102,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGLGON^XOBSCAV),";;",2),.XOBMSG,$$FAILURE^XOBSCAV(),$PIECE($TEXT(SCHSIMPL^XOBSCAV),";;",2))
"RTN","XOBSCAV1",103,0)
 QUIT
"RTN","XOBSCAV1",104,0)
LOGCVC ; response if need to change vc
"RTN","XOBSCAV1",105,0)
 NEW XOBMSG,XOBLINE
"RTN","XOBSCAV1",106,0)
 SET XOBLINE=$$POSTTXT^XOBSCAV(.XOBRET,.XOBMSG)
"RTN","XOBSCAV1",107,0)
 SET XOBMSG(XOBLINE+1)="<"_$PIECE($TEXT(PARTTAG^XOBSCAV),";;",2)_" changeVerify=""true"" cvcHelpText="""_$$CHARCHK^XOBVLIB($$AVHLPTXT^XUS2())_""" />" ; use of AVHLPTXT^XUS2: DBIA #4057
"RTN","XOBSCAV1",108,0)
 SET XOBMSG(XOBLINE+2)="<"_$PIECE($TEXT(MSGTAG^XOBSCAV),";;",2)_">"_$$CHARCHK^XOBVLIB(XOBRET(3))_"</"_$PIECE($TEXT(MSGTAG^XOBSCAV),";;",2)_">"
"RTN","XOBSCAV1",109,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGLGON^XOBSCAV),";;",2),.XOBMSG,$$PARTIAL^XOBSCAV(),$PIECE($TEXT(SCHPARTS^XOBSCAV),";;",2))
"RTN","XOBSCAV1",110,0)
 QUIT
"RTN","XOBSCAV1",111,0)
LOGSELDV(XOBDIVS) ; response if need to select division
"RTN","XOBSCAV1",112,0)
 ;XOBDIVS is in format of output from DIVGET^XUSRB2
"RTN","XOBSCAV1",113,0)
 NEW XOBMSG,XOBLINE
"RTN","XOBSCAV1",114,0)
 SET XOBLINE=$$POSTTXT^XOBSCAV(.XOBRET,.XOBMSG)
"RTN","XOBSCAV1",115,0)
 SET XOBLINE=$$ADDDIVS^XOBSCAV(.XOBDIVS,.XOBMSG)
"RTN","XOBSCAV1",116,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGLGON^XOBSCAV),";;",2),.XOBMSG,$$PARTIAL^XOBSCAV(),$PIECE($TEXT(SCHPARTS^XOBSCAV),";;",2))
"RTN","XOBSCAV1",117,0)
 QUIT
"RTN","XOBSCAV1",118,0)
LOGOK ; response if everything's looking good
"RTN","XOBSCAV1",119,0)
 NEW XOBMSG,XOBLINE
"RTN","XOBSCAV1",120,0)
 SET XOBLINE=$$POSTTXT^XOBSCAV(.XOBRET,.XOBMSG)
"RTN","XOBSCAV1",121,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGLGON^XOBSCAV),";;",2),.XOBMSG,$$SUCCESS^XOBSCAV(),$PIECE($TEXT(SCHLGON^XOBSCAV),";;",2))
"RTN","XOBSCAV1",122,0)
 QUIT
"RTN","XOBSCAV1",123,0)
 ;==== AV.Logout.Request message processing ====
"RTN","XOBSCAV1",124,0)
LOGOUT ; logout
"RTN","XOBSCAV1",125,0)
 USE XOBNULL ; protect against direct writes to socket
"RTN","XOBSCAV1",126,0)
 ; do the logout
"RTN","XOBSCAV1",127,0)
 DO CLEAN
"RTN","XOBSCAV1",128,0)
 USE XOBPORT ; restore current IO (the TCP port)
"RTN","XOBSCAV1",129,0)
 NEW XOBMSG
"RTN","XOBSCAV1",130,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGLGOUT^XOBSCAV),";;",2),.XOBMSG,$$SUCCESS^XOBSCAV(),$PIECE($TEXT(SCHSIMPL^XOBSCAV),";;",2))
"RTN","XOBSCAV1",131,0)
 QUIT
"RTN","XOBSCAV1",132,0)
 ;==== Logout to call if connection has timed out ====
"RTN","XOBSCAV1",133,0)
CLEAN ; logout
"RTN","XOBSCAV1",134,0)
 DO LOGOUT^XUSRB ; use of LOGOUT^XUSRB: DBIA #4054
"RTN","XOBSCAV1",135,0)
 QUIT
"RTN","XOBSCAV1",136,0)
 ;==== AV.SelectDivision.Request message processing ====
"RTN","XOBSCAV1",137,0)
DIVSLCT ; select division
"RTN","XOBSCAV1",138,0)
 NEW XOBRET
"RTN","XOBSCAV1",139,0)
 IF '+DUZ DO DIVSLCT0("User did not complete the access/verify code login process.") QUIT  ; need DUZ
"RTN","XOBSCAV1",140,0)
 DO DIVSET^XUSRB2(.XOBRET,"`"_XOBDATA("XOB SECAV","SELECTEDDIVISION")) ; use of DIVSET^XUSRB2: DBIA #4055
"RTN","XOBSCAV1",141,0)
 IF +XOBRET DO DIVSLCT1 QUIT
"RTN","XOBSCAV1",142,0)
 DO DIVSLCT0("division not found for this user.")
"RTN","XOBSCAV1",143,0)
 QUIT
"RTN","XOBSCAV1",144,0)
DIVSLCT0(XOBTEXT) ; send 
"RTN","XOBSCAV1",145,0)
 NEW XOBMSG
"RTN","XOBSCAV1",146,0)
 SET XOBMSG(1)="<"_$PIECE($TEXT(MSGTAG^XOBSCAV),";;",2)_">"_$$CHARCHK^XOBVLIB(XOBTEXT)_"</"_$PIECE($TEXT(MSGTAG^XOBSCAV),";;",2)_">"
"RTN","XOBSCAV1",147,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGSELDV^XOBSCAV),";;",2),.XOBMSG,$$FAILURE^XOBSCAV(),$PIECE($TEXT(SCHSIMPL^XOBSCAV),";;",2))
"RTN","XOBSCAV1",148,0)
 QUIT
"RTN","XOBSCAV1",149,0)
DIVSLCT1 ; success
"RTN","XOBSCAV1",150,0)
 NEW XOBMSG
"RTN","XOBSCAV1",151,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGSELDV^XOBSCAV),";;",2),.XOBMSG,$$SUCCESS^XOBSCAV(),$PIECE($TEXT(SCHSIMPL^XOBSCAV),";;",2))
"RTN","XOBSCAV1",152,0)
 QUIT
"RTN","XOBSCAV1",153,0)
 ;==== AV.UpdateVC.Request message processing ====
"RTN","XOBSCAV1",154,0)
SENDNVC ; respond to "change verify code" request. Use of CVC^XUSRB per DBIA #4054
"RTN","XOBSCAV1",155,0)
 NEW XOBRET,XOBRETDV,XOBSDUZ
"RTN","XOBSCAV1",156,0)
 SET XOBSDUZ=DUZ ; save DUZ in case of failure - we need to restore
"RTN","XOBSCAV1",157,0)
 DO CVC^XUSRB(.XOBRET,XOBDATA("XOB SECAV","OLDVC")_U_XOBDATA("XOB SECAV","NEWVC")_U_XOBDATA("XOB SECAV","NEWVCCHECK"))
"RTN","XOBSCAV1",158,0)
 IF +$GET(DUZ) DO  QUIT  ; success changing verify code
"RTN","XOBSCAV1",159,0)
 .; check the divisions now
"RTN","XOBSCAV1",160,0)
 .DO DIVGET^XUSRB2(.XOBRETDV,DUZ) ; use of DIVGET^XUSRB2: DBIA #4055
"RTN","XOBSCAV1",161,0)
 .IF '+XOBRETDV(0) DO SENDNVC1 QUIT
"RTN","XOBSCAV1",162,0)
 .; otherwise this is a multidivisional user
"RTN","XOBSCAV1",163,0)
 .DO SENDNVCD(.XOBRETDV)
"RTN","XOBSCAV1",164,0)
 ; cvc failed
"RTN","XOBSCAV1",165,0)
 SET DUZ=XOBSDUZ ; restore DUZ
"RTN","XOBSCAV1",166,0)
 DO SENDNVC0 ; failure
"RTN","XOBSCAV1",167,0)
 QUIT
"RTN","XOBSCAV1",168,0)
SENDNVC1 ; send verify code update success
"RTN","XOBSCAV1",169,0)
 ;update the vc/finish the logon
"RTN","XOBSCAV1",170,0)
 NEW XOBMSG
"RTN","XOBSCAV1",171,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGUPDVC^XOBSCAV),";;",2),.XOBMSG,$$SUCCESS^XOBSCAV(),$PIECE($TEXT(SCHSIMPL^XOBSCAV),";;",2))
"RTN","XOBSCAV1",172,0)
 QUIT
"RTN","XOBSCAV1",173,0)
SENDNVC0 ; send verify code update error
"RTN","XOBSCAV1",174,0)
 ;update the vc/finish the logon
"RTN","XOBSCAV1",175,0)
 NEW XOBMSG,XOBI
"RTN","XOBSCAV1",176,0)
 SET XOBMSG(1)="<"_$PIECE($TEXT(MSGTAG^XOBSCAV),";;",2)_">"_$$CHARCHK^XOBVLIB($GET(XOBRET(1)))_"</"_$PIECE($TEXT(MSGTAG^XOBSCAV),";;",2)_">"
"RTN","XOBSCAV1",177,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGUPDVC^XOBSCAV),";;",2),.XOBMSG,$$FAILURE^XOBSCAV(),$PIECE($TEXT(SCHSIMPL^XOBSCAV),";;",2))
"RTN","XOBSCAV1",178,0)
 QUIT
"RTN","XOBSCAV1",179,0)
SENDNVCD(XOBDIVS) ; send verify code partial success, need divisions
"RTN","XOBSCAV1",180,0)
 ;XOBDIVS is in format of output from DIVGET^XUSRB2
"RTN","XOBSCAV1",181,0)
 NEW XOBMSG,XOBI,XOBLINE
"RTN","XOBSCAV1",182,0)
 SET XOBLINE=$$ADDDIVS^XOBSCAV(.XOBDIVS,.XOBMSG)
"RTN","XOBSCAV1",183,0)
 DO SENDSEC^XOBSCAV(.XOBR,$PIECE($TEXT(RESTYPE^XOBSCAV),";;",2),$PIECE($TEXT(MSGUPDVC^XOBSCAV),";;",2),.XOBMSG,$$PARTIAL^XOBSCAV(),$PIECE($TEXT(SCHPARTS^XOBSCAV),";;",2))
"RTN","XOBSCAV1",184,0)
 QUIT
"VER")
8.0^22.0
**END**
**END**
