Released PSJ*5*130 SEQ #136
Extracted from mail message
**KIDS**:PSJ*5.0*130^

**INSTALL NAME**
PSJ*5.0*130
"BLD",5572,0)
PSJ*5.0*130^INPATIENT MEDICATIONS^0^3051109^y
"BLD",5572,1,0)
^^11^11^3051109^
"BLD",5572,1,1,0)
In support of the Decision Support System (DSS) FY2006 Extract
"BLD",5572,1,2,0)
Enhancement project two changes have been requested in Inpatient
"BLD",5572,1,3,0)
Medications V. 5.0.
"BLD",5572,1,4,0)
 
"BLD",5572,1,5,0)
First, add the order number to the list of data being sent to DSS Extracts
"BLD",5572,1,6,0)
V. 3.0.
"BLD",5572,1,7,0)
 
"BLD",5572,1,8,0)
Second, add the IV room and order date to the list of data being sent to 
"BLD",5572,1,9,0)
DSS Extracts V. 3.0. The order date will be the date the order was 
"BLD",5572,1,10,0)
verified by a nurse or if that is not present, the login date of the 
"BLD",5572,1,11,0)
order.
"BLD",5572,4,0)
^9.64PA^^
"BLD",5572,6)
5^
"BLD",5572,"ABPKG")
n
"BLD",5572,"KRN",0)
^9.67PA^8989.52^19
"BLD",5572,"KRN",.4,0)
.4
"BLD",5572,"KRN",.4,"NM",0)
^9.68A^^
"BLD",5572,"KRN",.401,0)
.401
"BLD",5572,"KRN",.402,0)
.402
"BLD",5572,"KRN",.403,0)
.403
"BLD",5572,"KRN",.5,0)
.5
"BLD",5572,"KRN",.84,0)
.84
"BLD",5572,"KRN",3.6,0)
3.6
"BLD",5572,"KRN",3.8,0)
3.8
"BLD",5572,"KRN",9.2,0)
9.2
"BLD",5572,"KRN",9.8,0)
9.8
"BLD",5572,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",5572,"KRN",9.8,"NM",1,0)
PSGAMSA^^0^B19393725
"BLD",5572,"KRN",9.8,"NM",2,0)
PSGPLF^^0^B20358378
"BLD",5572,"KRN",9.8,"NM",3,0)
PSIVSTAT^^0^B21167755
"BLD",5572,"KRN",9.8,"NM","B","PSGAMSA",1)

"BLD",5572,"KRN",9.8,"NM","B","PSGPLF",2)

"BLD",5572,"KRN",9.8,"NM","B","PSIVSTAT",3)

"BLD",5572,"KRN",19,0)
19
"BLD",5572,"KRN",19.1,0)
19.1
"BLD",5572,"KRN",101,0)
101
"BLD",5572,"KRN",409.61,0)
409.61
"BLD",5572,"KRN",771,0)
771
"BLD",5572,"KRN",870,0)
870
"BLD",5572,"KRN",8989.51,0)
8989.51
"BLD",5572,"KRN",8989.52,0)
8989.52
"BLD",5572,"KRN",8994,0)
8994
"BLD",5572,"KRN","B",.4,.4)

"BLD",5572,"KRN","B",.401,.401)

"BLD",5572,"KRN","B",.402,.402)

"BLD",5572,"KRN","B",.403,.403)

"BLD",5572,"KRN","B",.5,.5)

"BLD",5572,"KRN","B",.84,.84)

"BLD",5572,"KRN","B",3.6,3.6)

"BLD",5572,"KRN","B",3.8,3.8)

"BLD",5572,"KRN","B",9.2,9.2)

"BLD",5572,"KRN","B",9.8,9.8)

"BLD",5572,"KRN","B",19,19)

"BLD",5572,"KRN","B",19.1,19.1)

"BLD",5572,"KRN","B",101,101)

"BLD",5572,"KRN","B",409.61,409.61)

"BLD",5572,"KRN","B",771,771)

"BLD",5572,"KRN","B",870,870)

"BLD",5572,"KRN","B",8989.51,8989.51)

"BLD",5572,"KRN","B",8989.52,8989.52)

"BLD",5572,"KRN","B",8994,8994)

"BLD",5572,"QUES",0)
^9.62^^
"BLD",5572,"REQB",0)
^9.611^1^1
"BLD",5572,"REQB",1,0)
PSJ*5.0*111^2
"BLD",5572,"REQB","B","PSJ*5.0*111",1)

"MBREQ")
0
"PKG",197,-1)
1^1
"PKG",197,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",197,20,0)
^9.402P^^
"PKG",197,22,0)
^9.49I^1^1
"PKG",197,22,1,0)
5.0^2971215^2980917^11712
"PKG",197,22,1,"PAH",1,0)
130^3051109^11881
"PKG",197,22,1,"PAH",1,1,0)
^^11^11^3051109
"PKG",197,22,1,"PAH",1,1,1,0)
In support of the Decision Support System (DSS) FY2006 Extract
"PKG",197,22,1,"PAH",1,1,2,0)
Enhancement project two changes have been requested in Inpatient
"PKG",197,22,1,"PAH",1,1,3,0)
Medications V. 5.0.
"PKG",197,22,1,"PAH",1,1,4,0)
 
"PKG",197,22,1,"PAH",1,1,5,0)
First, add the order number to the list of data being sent to DSS Extracts
"PKG",197,22,1,"PAH",1,1,6,0)
V. 3.0.
"PKG",197,22,1,"PAH",1,1,7,0)
 
"PKG",197,22,1,"PAH",1,1,8,0)
Second, add the IV room and order date to the list of data being sent to 
"PKG",197,22,1,"PAH",1,1,9,0)
DSS Extracts V. 3.0. The order date will be the date the order was 
"PKG",197,22,1,"PAH",1,1,10,0)
verified by a nurse or if that is not present, the login date of the 
"PKG",197,22,1,"PAH",1,1,11,0)
order.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSGAMSA")
0^1^B19393725
"RTN","PSGAMSA",1,0)
PSGAMSA ;BIR/CML3-ENTERS RETURNS, EXTRAS, & PRE-EX NEEDS INTO 57.6 ; 15 May 98 / 9:25 AM
"RTN","PSGAMSA",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**3,84,130**;16 DEC 97
"RTN","PSGAMSA",3,0)
 ;
"RTN","PSGAMSA",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSGAMSA",5,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSGAMSA",6,0)
 ; Reference to ^ECXUD1 is supported by DBIA# 172.
"RTN","PSGAMSA",7,0)
 ; 
"RTN","PSGAMSA",8,0)
EN(DFN,PSGORD,PSGORD1,PSGLOG) ;
"RTN","PSGAMSA",9,0)
 ; PSGLOG: 2 - pre-exchange needs, 3 - extra units dispensed, 4 - returns
"RTN","PSGAMSA",10,0)
 N %,ECUD,LOG,ND,PSGAMSF,PSGDRG,PSGDRGC,PSGPRVR,PSGWARD,PSGX,VAIN,VAIP,PSGSTRT
"RTN","PSGAMSA",11,0)
 S PSGX=X,PSGAMSF=$S(PSGLOG=4:2,1:0),PSGWARD=$P($G(^PS(55,DFN,5,PSGORD,0)),"^",23),PSGSTRT=$P($G(^PS(55,DFN,5,PSGORD,2)),"^",2)
"RTN","PSGAMSA",12,0)
 ; removed ref to DGPM.
"RTN","PSGAMSA",13,0)
 ;I 'PSGWARD D INP^VADPT S PSGWARD=+VAIN(4) I 'PSGWARD K VAIP S VAIP("E")=$O(^DGPM("ATID3",DFN,0)) I VAIP("E") S VAIP("E")=$O(^(VAIP("E"),0)) I VAIP("E") D IN5^VADPT S PSGWARD=+VAIP(17,4)
"RTN","PSGAMSA",14,0)
 I 'PSGWARD D IN5^VADPT S PSGWARD=+VAIP(5) I 'PSGWARD K VAIP S VAIP("D")="L" D IN5^VADPT S PSGWARD=+VAIP(17,4)
"RTN","PSGAMSA",15,0)
 S:'PSGWARD PSGWARD="999Z" S PSGPRVR=$S('$D(^PS(55,DFN,5,PSGORD,0)):"999Z",$P(^(0),"^",2):$P(^(0),"^",2),1:"999Z"),PSGDRG=$S('$D(^(1,PSGORD1,0)):"999Z",+^(0):+^(0),1:"999Z"),PSGDRGC=$S($D(^PSDRUG(PSGDRG,660)):$P(^(660),"^",6),1:0)*PSGX
"RTN","PSGAMSA",16,0)
 D ENLOG,ENOPC
"RTN","PSGAMSA",17,0)
 ;
"RTN","PSGAMSA",18,0)
OUT ;
"RTN","PSGAMSA",19,0)
 I PSGDRG=+PSGDRG,PSGPRVR=+PSGPRVR,PSGWARD=+PSGWARD D
"RTN","PSGAMSA",20,0)
 . S X="ECXUD1" X ^%ZOSF("TEST")
"RTN","PSGAMSA",21,0)
 . I  S ECUD=DFN_"^"_DT_"^"_+PSGDRG_"^"_$S(PSGAMSF:-PSGX,1:+PSGX)_"^"_+PSGWARD_"^"_+PSGPRVR_";200^"_$S(PSGAMSF:-PSGDRGC,1:+PSGDRGC)_"^"_PSGSTRT_"^"_$G(PSGORD) D ^ECXUD1
"RTN","PSGAMSA",22,0)
 Q
"RTN","PSGAMSA",23,0)
 ;
"RTN","PSGAMSA",24,0)
ENOPC ; outpatient entry point
"RTN","PSGAMSA",25,0)
 F  L +^PS(57.6,DT,1,PSGWARD,1,PSGPRVR,1,PSGDRG,0):0 I  Q
"RTN","PSGAMSA",26,0)
 I $D(^PS(57.6,DT,1,PSGWARD,1,PSGPRVR,1,PSGDRG,0)) S ND=^(0),X=1
"RTN","PSGAMSA",27,0)
 E  S ND=PSGDRG,X=0
"RTN","PSGAMSA",28,0)
 S $P(ND,"^",2+PSGAMSF)=$P(ND,"^",2+PSGAMSF)+PSGX,$P(ND,"^",3+PSGAMSF)=$P(ND,"^",3+PSGAMSF)+PSGDRGC,^(0)=ND L -^PS(57.6,DT,1,PSGWARD,1,PSGPRVR,1,PSGDRG,0) Q:X  ; naked from ENOPC+2
"RTN","PSGAMSA",29,0)
 F  L +^PS(57.6,DT,1,PSGWARD,1,PSGPRVR,1,0):1 I  S ND=$S($D(^PS(57.6,DT,1,PSGWARD,1,PSGPRVR,1,0)):^(0),1:"^57.63P"),$P(ND,"^",3,4)=PSGDRG_"^"_PSGDRG,^(0)=ND L -^PS(57.6,DT,1,PSGWARD,1,PSGPRVR,1,0) Q
"RTN","PSGAMSA",30,0)
 Q:$D(^PS(57.6,DT,1,PSGWARD,1,PSGPRVR,0))  S ^(0)=PSGPRVR
"RTN","PSGAMSA",31,0)
 F  L +^PS(57.6,DT,1,PSGWARD,1,0):1 I  S ND=$S($D(^PS(57.6,DT,1,PSGWARD,1,0)):^(0),1:"^57.62P"),$P(ND,"^",3,4)=PSGPRVR_"^"_PSGPRVR,^(0)=ND L -^PS(57.6,DT,1,PSGWARD,1,0) Q
"RTN","PSGAMSA",32,0)
 Q:$D(^PS(57.6,DT,1,PSGWARD,0))  S ^(0)=PSGWARD
"RTN","PSGAMSA",33,0)
 F  L +^PS(57.6,DT,1,0):1 I  S ND=$S($D(^PS(57.6,DT,1,0)):^(0),1:"^57.61"),$P(ND,"^",3,4)=PSGWARD_"^"_PSGWARD,^(0)=ND L -^PS(57.6,DT,1,0) Q
"RTN","PSGAMSA",34,0)
 I '$D(^PS(57.6,DT,0)) S ^(0)=DT F  L +^PS(57.6,0):1 I  S ND=$S($D(^PS(57.6,0)):^(0),1:"UNIT DOSE PICK LIST STATS^57.6D"),$P(ND,"^",3)=DT,$P(ND,"^",4)=$P(ND,"^",4)+1,^(0)=ND L -^PS(57.6,0) Q
"RTN","PSGAMSA",35,0)
 Q
"RTN","PSGAMSA",36,0)
 ;
"RTN","PSGAMSA",37,0)
ENPLF(DFN,PSGORD,PSGDRG,PSGX,PSGDRGC,PSGLOG,PSGWARD,PSGPRVR,PSGPLFDT) ;
"RTN","PSGAMSA",38,0)
 N DA,LOG,ND
"RTN","PSGAMSA",39,0)
 ;
"RTN","PSGAMSA",40,0)
ENLOG ;
"RTN","PSGAMSA",41,0)
 D:'$D(PSGPLFDT) NOW^%DTC F  L +^PS(55,DFN,5,PSGORD,11,0):0 Q:$T
"RTN","PSGAMSA",42,0)
 S ND=$G(^PS(55,DFN,5,PSGORD,11,0)) S:$P(ND,"^",2)="" $P(ND,"^",2)="55.0611D"
"RTN","PSGAMSA",43,0)
 F LOG=$P(ND,"^",3)+1:1 I '$D(^PS(55,DFN,5,PSGORD,11,LOG)) L +^PS(55,DFN,5,PSGORD,11,LOG):0 I  S ^PS(55,DFN,5,PSGORD,11,LOG,0)=$S($D(PSGPLFDT):PSGPLFDT,1:%),^PS(55,DFN,5,PSGORD,11,"B",$S($D(PSGPLFDT):PSGPLFDT,1:%),LOG)="" Q
"RTN","PSGAMSA",44,0)
 S $P(ND,"^",3)=LOG,$P(ND,"^",4)=$P(ND,"^",4)+1,^PS(55,DFN,5,PSGORD,11,0)=ND L -^PS(55,DFN,5,PSGORD,11,0)
"RTN","PSGAMSA",45,0)
 S ^PS(55,DFN,5,PSGORD,11,LOG,0)=$S($D(PSGPLFDT):PSGPLFDT,1:%)_"^"_$S(PSGDRG=+PSGDRG:PSGDRG,1:"")_"^"_PSGX_"^"_PSGDRGC_"^"_PSGLOG_"^"_DUZ_"^"_$S(PSGWARD=+PSGWARD:PSGWARD,1:"")_"^"_$S(PSGPRVR=+PSGPRVR:PSGPRVR,1:"")
"RTN","PSGAMSA",46,0)
 L -^PS(55,DFN,5,PSGORD,11,LOG)
"RTN","PSGAMSA",47,0)
 Q
"RTN","PSGAMSA",48,0)
CLEANUP ; Clean up partial orders having no provider or status.
"RTN","PSGAMSA",49,0)
 F DFN=0:0 S DFN=$O(^PS(55,DFN)) Q:'DFN  F ON=0:0 S ON=$O(^PS(55,DFN,5,ON)) Q:'ON  S X=$G(^(+ON,0)) I $P(X,U,2)_$P(X,U,9)="" W !,DFN," ",ON D DIK
"RTN","PSGAMSA",50,0)
 Q
"RTN","PSGAMSA",51,0)
DIK ;
"RTN","PSGAMSA",52,0)
 ;K DA S DA(1)=DFN,DA=+ON,DIK="^PS(55,"_DA(1)_",5," D ^DIK K ^PS(55,DA(1),5,"B",DA,DA),^PS(55,"AUDDD",PSGPO,DA(1),DA),^PS(55,"AUE",DA(1),DA)
"RTN","PSGAMSA",53,0)
 K ^PS(55,+DFN,5,+ON),^PS(55,+DFN,5,"B",+ON,+ON),^PS(55,"AUE",+DFN,+ON)
"RTN","PSGAMSA",54,0)
 Q
"RTN","PSGPLF")
0^2^B20358378
"RTN","PSGPLF",1,0)
PSGPLF ;BIR/CML3-FILES AWAY PICK LIST DATA (BACKGROUND JOB) ;29 SEP 97 / 12:40 PM
"RTN","PSGPLF",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**84,130**;16 DEC 97
"RTN","PSGPLF",3,0)
 ;
"RTN","PSGPLF",4,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSGPLF",5,0)
 ; Reference to ^PSDRUG is supported by DBIA# 2192.
"RTN","PSGPLF",6,0)
 ; Reference to ^ECXUD1 is supported by DBIA# 172.
"RTN","PSGPLF",7,0)
 ;
"RTN","PSGPLF",8,0)
FILE ; add data to cost file and order
"RTN","PSGPLF",9,0)
 S PSGX=$P(PLR,"^",2),PSGY=$P(PLR,"^",3) S:PSGX?7N1"DI" PSGX=0 S PSGX=+PSGX S:PSGY="" $P(PLR,"^",3)=PSGX,PSGY=PSGX
"RTN","PSGPLF",10,0)
 S COST="",(D3,DO)=$P(PLR,"^") I D3=+D3 S D3=$P($G(^PS(55,PN,5,O,1,D3,0)),"^") I D3=+D3 S COST=$P($G(^PSDRUG(D3,660)),"^",6)
"RTN","PSGPLF",11,0)
 E  S D3="999Z"
"RTN","PSGPLF",12,0)
 I COST="" S PSGPLFF=0 S:D3="999Z" D3=PN_","_O_","_DO S:'$D(^TMP("PSGNCF",$J,"B",D3)) ^(D3)="" Q
"RTN","PSGPLF",13,0)
 S PS=PSGY<0*2 S:PS PSGY=-PSGY S COST=COST*PSGY G:'PSGY&'COST OS
"RTN","PSGPLF",14,0)
 F  L +^PS(57.6,D0,1,D1,1,D2,1,D3,0):1 I  Q
"RTN","PSGPLF",15,0)
 I $D(^PS(57.6,D0,1,D1,1,D2,1,D3,0)) S ND=^(0),PSGZ=1
"RTN","PSGPLF",16,0)
 E  S ND=D3,PSGZ=0
"RTN","PSGPLF",17,0)
 S $P(ND,"^",2+PS)=$P(ND,"^",2+PS)+PSGY,$P(ND,"^",3+PS)=$P(ND,"^",3+PS)+COST,^PS(57.6,D0,1,D1,1,D2,1,D3,0)=ND L -^PS(57.6,D0,1,D1,1,D2,1,D3,0)
"RTN","PSGPLF",18,0)
 G:PSGZ OS
"RTN","PSGPLF",19,0)
 F  L +^PS(57.6,D0,1,D1,1,D2,1,0):1 I  S ND=$G(^PS(57.6,D0,1,D1,1,D2,1,0)) S:ND="" ND="^57.63P^" S $P(ND,"^",3)=D3,$P(ND,"^",4)=$P(ND,"^",4)+1 S ^(0)=ND L -^PS(57.6,D0,1,D1,1,D2,1,0) Q
"RTN","PSGPLF",20,0)
 I '$D(^PS(57.6,D0,1,D1,1,D2,0)) F  L +^PS(57.6,D0,1,D1,1,0):1 I  S ND=$G(^PS(57.6,D0,1,D1,1,0)) S:ND="" ND="^57.62P" S $P(ND,"^",3)=D2,$P(ND,"^",4)=$P(ND,"^",4)+1 S ^(0)=ND L -^PS(57.6,D0,1,D1,1,0) Q
"RTN","PSGPLF",21,0)
 ;
"RTN","PSGPLF",22,0)
OS ;
"RTN","PSGPLF",23,0)
 I PSGX!PSGY F  L +^PS(55,PN,5,O,1,DO,0):1 I  S PSGZ=$G(^PS(55,PN,5,O,1,DO,0)),$P(PSGZ,"^",5)=$P(PSGZ,"^",5)+PSGX,$P(PSGZ,"^",PS>0+6)=$P(PSGZ,"^",PS>0+6)+PSGY,^(0)=PSGZ L -^PS(55,PN,5,O,1,DO,0) Q
"RTN","PSGPLF",24,0)
 N PSGSTRT S PSGSTRT=$P($G(^PS(55,PN,5,O,2)),"^",2)
"RTN","PSGPLF",25,0)
 I PSGY,D0=+D0,D1=+D1,D2=+D2,D3=+D3 S:PS PSGY=-PSGY,COST=-COST D ENPLF^PSGAMSA(PN,O,D3,PSGY,COST,1,D1,D2,D0) S X="ECXUD1" X ^%ZOSF("TEST") I  S ECUD=PN_"^"_D0_"^"_D3_"^"_PSGY_"^"_D1_"^"_D2_";200^"_COST_"^"_PSGSTRT_"^"_$G(O) D ^ECXUD1
"RTN","PSGPLF",26,0)
 S $P(PLR,"^",4)=1,^PS(53.5,G,1,PN,1,$P(PD,"^",2),1,$P(DD,"^",2),0)=PLR
"RTN","PSGPLF",27,0)
 Q
"RTN","PSGPLF",28,0)
 ;
"RTN","PSGPLF",29,0)
GD1 ; get next (second) level (ward) in 57.6
"RTN","PSGPLF",30,0)
 S WH=WD,D1=$O(^DIC(42,"B",WD,0)) S:'D1 D1="999Z" Q:$D(^PS(57.6,D0,1,D1))
"RTN","PSGPLF",31,0)
 F  L +^PS(57.6,D0,1,0):1 I  S ND=$G(^PS(57.6,D0,1,0)) S:ND="" ND="^57.61PA" S $P(ND,"^",3)=D1 S:'$D(^(D1)) $P(ND,"^",4)=$P(ND,"^",4)+1 S ^(0)=ND,^(D1,0)=D1 L -^PS(57.6,D0,1,0) Q
"RTN","PSGPLF",32,0)
 Q
"RTN","PSGPLF",33,0)
 ;
"RTN","PSGPLF",34,0)
EN ; action starts here
"RTN","PSGPLF",35,0)
 N G,T,W,R,P,S,PD,DD,DDRG D NOW^%DTC S PSGDT=%,G=0 K C,^TMP("PSGNCF",$J)
"RTN","PSGPLF",36,0)
 F  S G=$O(^PS(53.5,"AF",G)) Q:'G  S PSGPLTND=$G(^PS(53.5,G,0)) K:PSGPLTND="" ^PS(53.5,"AF",G) I PSGPLTND]"" I $$LOCK^PSGPLUTL(G,"PSGPL") D  D UNLOCK^PSGPLUTL(G,"PSGPL")
"RTN","PSGPLF",37,0)
 .S WSF=$P(PSGPLTND,"^",7),D0=$S($P(PSGPLTND,"^",3):$P($P(PSGPLTND,"^",3),"."),1:DT)
"RTN","PSGPLF",38,0)
 .I '$D(^PS(57.6,D0)) F  L +^PS(57.6,0):1 I  S ND=$G(^(0)) S:ND="" ND="UNIT DOSE PICK LIST STATS^57.6D" S $P(ND,"^",3)=D0,$P(ND,"^",4)=$P(ND,"^",4)+1,^(0)=ND,^(D0,0)=D0 L -^PS(57.6,0) Q
"RTN","PSGPLF",39,0)
 .S T="",PSGPLFF=1
"RTN","PSGPLF",40,0)
 .F  S T=$O(^PS(53.5,"AC",G,T)) Q:T=""  S (WH,W)="" F  S (W,WD)=$O(^PS(53.5,"AC",G,T,W)) Q:W=""  S R="" D:'WSF GD1 F  S R=$O(^PS(53.5,"AC",G,T,W,R)) Q:R=""  S P="" F  S P=$O(^PS(53.5,"AC",G,T,W,R,P)) Q:P=""  D
"RTN","PSGPLF",41,0)
 ..S PN=$P(P,"^",2),(DD,PD)="",S="A" S:WSF WD=$P(^PS(53.5,G,1,PN,0),"^",3) D:WD'=WH&WSF GD1
"RTN","PSGPLF",42,0)
 ..F  S S=$O(^PS(53.5,"AC",G,T,W,R,P,S)) Q:("Z"[S)!(S="NO ORDERS")  F  S PD=$O(^PS(53.5,"AC",G,T,W,R,P,S,PD)) Q:PD=""  S O=$P(^PS(53.5,G,1,PN,1,$P(PD,"^",2),0),"^"),D2=$P($G(^PS(55,PN,5,O,0)),"^",2) S:'D2 D2="999Z" D
"RTN","PSGPLF",43,0)
 ...F  S DD=$O(^PS(53.5,"AC",G,T,W,R,P,S,PD,DD)) Q:(DD="")!(DD="NO DISPENSE DRUG")  S PLR=$G(^PS(53.5,G,1,PN,1,$P(PD,"^",2),1,$P(DD,"^",2),0)) D:'$P(PLR,"^",4) FILE
"RTN","PSGPLF",44,0)
 .I PSGPLFF S $P(^PS(53.5,G,0),"^",5)=2,^PS(53.5,"AO",+$P(PSGPLTND,"^",2),$P(PSGPLTND,"^",3),G)="" K ^PS(53.5,"AF",G)
"RTN","PSGPLF",45,0)
 ;
"RTN","PSGPLF",46,0)
 I $D(^TMP("PSGNCF",$J,"B")) D ^PSGPLFM
"RTN","PSGPLF",47,0)
 ;
"RTN","PSGPLF",48,0)
DONE ;
"RTN","PSGPLF",49,0)
 K %,AM,C,COST,D0,D1,D2,D3,DO,ECUD,ND,O,PIN,PLR,PN,PS,PSGPLFF,PSGPLTND,Q,WD,WH,WSF,PSGX,PSGY,PSGZ Q
"RTN","PSIVSTAT")
0^3^B21167755
"RTN","PSIVSTAT",1,0)
PSIVSTAT ;BIR/PR-BUILD COST TRANS NODE, ENTER COMPILE ;6 Nov 98 / 4:45 PM
"RTN","PSIVSTAT",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**3,18,84,81,104,111,130**;16 DEC 97
"RTN","PSIVSTAT",3,0)
 ;
"RTN","PSIVSTAT",4,0)
 ; Reference to ^ECXPIV1 is supported by DBIA# 1882.
"RTN","PSIVSTAT",5,0)
 ; Reference to ^PS(52.6 is supported by DBIA# 1231.
"RTN","PSIVSTAT",6,0)
 ; Reference to ^PS(52.7 is supported by DBIA# 2173.
"RTN","PSIVSTAT",7,0)
 ; Reference to ^PS(55 is supported by DBIA# 2191.
"RTN","PSIVSTAT",8,0)
 ; 
"RTN","PSIVSTAT",9,0)
 ;Needs dfn,on,psivnol,psivc (optional:dis/ret/des).
"RTN","PSIVSTAT",10,0)
 ;
"RTN","PSIVSTAT",11,0)
 S PSIVV=1 L +^PS(50.8,PSIVSN):5000
"RTN","PSIVSTAT",12,0)
 I '$G(PSIVC) S PSIVC=$S(($G(PSJRDC)="R"):2,($G(PSJRDC)="D"):3,($G(PSJRDC)]""):4,1:1)
"RTN","PSIVSTAT",13,0)
 ;D NOW^%DTC S (Y,PSIVNOW)=% I '$D(^PS(50.8,PSIVSN,0)) L +^PS(50.8,0) S ^PS(50.8,PSIVSN,0)=PSIVSN,$P(^(0),U,3,4)=PSIVSN_U_($P(^PS(50.8,0),U,4)+1) L -^PS(50.8,0)
"RTN","PSIVSTAT",14,0)
 D NOW^%DTC S (Y,PSIVNOW)=% I '$D(^PS(50.8,PSIVSN,0)) D  S ^PS(50.8,PSIVSN,0)=PSIVSN,$P(^(0),U,3,4)=PSIVSN_U_($P(^PS(50.8,0),U,4)+1) L -^PS(50.8,0)
"RTN","PSIVSTAT",15,0)
 .F  L +^PS(50.8,0):1 Q:$T
"RTN","PSIVSTAT",16,0)
 S $P(^PS(50.8,PSIVSN,1,0),U,1,3)="^50.801P^"_DFN S:'$D(^(DFN,0)) ^(0)=DFN,$P(^(0),U,3,4)=DFN_U_($P(^PS(50.8,PSIVSN,1,0),U,4)+1)
"RTN","PSIVSTAT",17,0)
 S PSIVTN=1 I $D(^PS(50.8,PSIVSN,1,DFN,1,0)) F PSIVTN=$P(^(0),U,3)+1:1 Q:'$D(^PS(50.8,PSIVSN,1,DFN,1,PSIVTN,0))
"RTN","PSIVSTAT",18,0)
 ;
"RTN","PSIVSTAT",19,0)
RETDET ;Get the ward that returns or destroyed need to be associated with.
"RTN","PSIVSTAT",20,0)
 ;RDFLAG & RDWARD ARE set in routine PSIVRD.
"RTN","PSIVSTAT",21,0)
 I $D(RDFLAG) S PSIVWD=RDWARD S:'$D(^PS(55,DFN,"IV",+ON,9)) $P(^(9),U,1,2)="" S $P(^(9),U,3)=$P(^(9),U,3)-PSIVNOL G SKIP
"RTN","PSIVSTAT",22,0)
 ;
"RTN","PSIVSTAT",23,0)
LBWD ;Get the ward we that we are printing labels on.
"RTN","PSIVSTAT",24,0)
 S PSIVWD=$P(^PS(55,DFN,"IV",+ON,0),U,22) G:PSIVWD SKIP
"RTN","PSIVSTAT",25,0)
 S PSIVWD=$S($D(^DPT(DFN,.1)):$O(^DIC(42,"B",^DPT(DFN,.1),0)),1:.5)
"RTN","PSIVSTAT",26,0)
 ;
"RTN","PSIVSTAT",27,0)
SKIP ;
"RTN","PSIVSTAT",28,0)
 ;Set up the transaction node here.
"RTN","PSIVSTAT",29,0)
 S ^PS(50.8,PSIVSN,1,DFN,1,0)="^50.802^"_PSIVTN_U_PSIVTN,^(PSIVTN,0)=PSIVTN_U_+ON_U_PSIVC_U_PSIVNOW_U_PSIVNOL_U_PSIVWD
"RTN","PSIVSTAT",30,0)
 ;
"RTN","PSIVSTAT",31,0)
DSS ; Update DSS for IV extract
"RTN","PSIVSTAT",32,0)
 ;
"RTN","PSIVSTAT",33,0)
 S X="ECXPIV1" X ^%ZOSF("TEST") Q:'$T
"RTN","PSIVSTAT",34,0)
 N ADSTR,ADUNITS,DCST,DDRG,DRG,PROV,SOLSTR,TYP,START,IVROOM,DSDATE,A,B
"RTN","PSIVSTAT",35,0)
 K ^TMP($J)
"RTN","PSIVSTAT",36,0)
 S X=$G(^PS(55,DFN,"IV",+ON,0)),PROV=$P(X,U,6),TYP=$P(X,U,4),START=$P(X,U,2)
"RTN","PSIVSTAT",37,0)
 S A=$G(^PS(55,DFN,"IV",+ON,2)),IVROOM=$P(A,"^",2),B=$G(^PS(55,DFN,"IV",+ON,4)),DSDATE=$S($P(B,"^",2)]"":$P(B,"^",2),1:$P(A,"^"))
"RTN","PSIVSTAT",38,0)
 F DRGTYP="AD","SOL" F DRG=0:0 S DRG=$O(^PS(55,DFN,"IV",+ON,DRGTYP,DRG)) Q:'DRG  D
"RTN","PSIVSTAT",39,0)
 .S ND=$G(^PS(55,DFN,"IV",+ON,DRGTYP,DRG,0)),(ADSTR,ADUNITS,SOLSTR)=""
"RTN","PSIVSTAT",40,0)
 .S @(DRGTYP_"STR")=$P(ND,U,2),ND=$G(^PS($S(DRGTYP="AD":52.6,1:52.7),+ND,0)),DDRG=$P(ND,U,2),DCST=$P(ND,U,7)
"RTN","PSIVSTAT",41,0)
 .I DRGTYP="AD" S Y=$P(ND,U,3) I Y S Y=$$CODES^PSIVUTL(Y,52.6,2) S ADUNITS=Y
"RTN","PSIVSTAT",42,0)
 .S ECUD=DFN_U_+ON_U_DDRG_U_PSIVNOW_U_PSIVC_U_ADSTR_U_ADUNITS_U_+SOLSTR_U_PROV_U_TYP_U_DCST
"RTN","PSIVSTAT",43,0)
 .S ECUD=ECUD_U_$P($G(^PS(55,DFN,"IV",+ON,"DSS")),"^")_U_START_U_IVROOM_U_DSDATE S ^TMP($J,DFN,ON,DDRG)=ECUD D ^ECXPIV1
"RTN","PSIVSTAT",44,0)
Q1 L -^PS(50.8,PSIVSN) K PSIVD,PSIVTN,PSIVV,PSIVWD,PSIVLP Q
"RTN","PSIVSTAT",45,0)
 ;
"RTN","PSIVSTAT",46,0)
EN ;Compile IV stats hold file here.
"RTN","PSIVSTAT",47,0)
 I $D(PSIVSITE),$D(PSIVSN) K ZTSAVE S ZTDTH=$H,ZTDESC="COMPILE IV STATS (FROM MENU)",ZTRTN="EN^PSIVSTAT",ZTIO="" D ^%ZTLOAD W:$D(ZTSK) !,"Queued." G Q
"RTN","PSIVSTAT",48,0)
 ;K ^TMP("PSIVNC",$J) S PSIVV=1,X="T-"_$S(+$G(^PS(59.7,1,31)):+^(31),1:100),%DT="" D ^%DT
"RTN","PSIVSTAT",49,0)
 ;F X=0:0 S X=$O(^PS(50.8,X)) Q:'X  F I=0:0 S I=$O(^PS(50.8,X,2,I)) Q:'I  I I<Y K ^PS(50.8,X,2,I) S $P(^(0),U,4)=$P(^(0),U,4)-1
"RTN","PSIVSTAT",50,0)
 K ^TMP("PSIVNC",$J) F Q=0:0 S Q=$O(^PS(50.8,Q)) Q:'Q  D
"RTN","PSIVSTAT",51,0)
 .S X="T-"_$S($P($G(^PS(59.5,Q,1)),U,19):$P(^(1),U,19),1:100) D ^%DT
"RTN","PSIVSTAT",52,0)
 .F I=0:0 S I=$O(^PS(50.8,Q,2,I)) Q:'I  I I<Y K ^PS(50.8,Q,2,I) S $P(^(0),U,4)=$P(^(0),U,4)-1
"RTN","PSIVSTAT",53,0)
 ;F PSIVS=0:0 S PSIVS=$O(^PS(50.8,PSIVS)) Q:'PSIVS  L +^PS(50.8,PSIVS,0) D CNT L -^PS(50.8,PSIVS,0)
"RTN","PSIVSTAT",54,0)
 F PSIVS=0:0 S PSIVS=$O(^PS(50.8,PSIVS)) Q:'PSIVS  D  D CNT L -^PS(50.8,PSIVS,0)
"RTN","PSIVSTAT",55,0)
 .F  L +^PS(50.8,PSIVS,0):1 Q:$T
"RTN","PSIVSTAT",56,0)
Q K D,PSGDT,PSIVNOL,PSIVD,PSIVC,PSIVS,PSIVV,%DT,Z,ZTSK,DFN,PSIV,PNL,POP,LO,IV,PSIVDG,PSIVDRG D ENIVKV^PSGSETU Q
"RTN","PSIVSTAT",57,0)
CNT F DFN=0:0 S DFN=$O(^PS(50.8,PSIVS,1,DFN)) Q:'DFN  F TN=0:0 S TN=$O(^PS(50.8,PSIVS,1,DFN,1,TN)) Q:'TN  D SET
"RTN","PSIVSTAT",58,0)
 S:$D(ZTQUEUED) ZTREQ="@" I $D(^TMP("PSIVNC",$J)) D MSG K TN,ZTIO,ZTRTN,X,Y Q
"RTN","PSIVSTAT",59,0)
 K ^PS(50.8,PSIVS,1),TN,ZTIO,ZTRTN,X,Y Q
"RTN","PSIVSTAT",60,0)
SET S TN=^PS(50.8,PSIVS,1,DFN,1,TN,0),ON=$P(TN,U,2),PSIVC=$P(TN,U,3),PSIVNOL=$P(TN,U,5),W42=$P(TN,U,6),PSIVD=$P(TN,U,4)\1
"RTN","PSIVSTAT",61,0)
 F PSIVDG=52.6,52.7 F I=0:0 S I=$O(^PS(55,DFN,"IV",+ON,$S(PSIVDG=52.6:"AD",1:"SOL"),I)) Q:'I!($D(NON))  S PSIVDRG=+^(I,0) I $P(^PS(PSIVDG,PSIVDRG,0),U,7)="" S NON=1 D NOCOST
"RTN","PSIVSTAT",62,0)
 I $D(NON) K PSIVDG,PSIVDRG,NON Q
"RTN","PSIVSTAT",63,0)
 D ^PSIVST2 K ^PS(50.8,PSIVS,1,DFN,1,+TN) Q
"RTN","PSIVSTAT",64,0)
NOCOST ;Send message if the drug is missing a unit cost.
"RTN","PSIVSTAT",65,0)
 ;
"RTN","PSIVSTAT",66,0)
 S $P(^PS(50.8,PSIVS,1,DFN,1,+TN,0),U,7)=PSIVDG_";"_PSIVDRG,NUM=$S('$D(NUM):1,1:NUM+1),^TMP($J,"PSIVNC",NUM,0)=$P(^PS(PSIVDG,PSIVDRG,0),U)_" IN THE "_$S(PSIVDG=52.6:"ADDITIVES",1:"SOLUTIONS")_" FILE." Q
"RTN","PSIVSTAT",67,0)
MSG S XMDUZ="IV PHARMACY PACKAGE",XMSUB="MISSING COST INFORMATION",XMTEXT="^TMP(""PSIVNC"",$J,"
"RTN","PSIVSTAT",68,0)
 F PSIVDUZ=0:0 S PSIVDUZ=$O(^XUSEC("PSJI MGR",PSIVDUZ)) Q:'PSIVDUZ  S XMY(PSIVDUZ)=""
"RTN","PSIVSTAT",69,0)
 D ^XMD K TMP("PSIVNC",$J),XMY,XMDUZ,NUM,XMTEXT,PSIVDUZ,XMSUB
"RTN","PSIVSTAT",70,0)
 Q
"VER")
8.0^22.0
"BLD",5572,6)
^SEQ #136
**END**
**END**
