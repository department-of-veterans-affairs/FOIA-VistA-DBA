Released TIU*1*221 SEQ #216
Extracted from mail message
**KIDS**:TIU*1.0*221^

**INSTALL NAME**
TIU*1.0*221
"BLD",7142,0)
TIU*1.0*221^TEXT INTEGRATION UTILITIES^0^3070212^y
"BLD",7142,1,0)
^^6^6^3070212^
"BLD",7142,1,1,0)
Problem 1 - when there are 2 appointments in the same day an uploaded 
"BLD",7142,1,2,0)
document always posts to the last appointment.
"BLD",7142,1,3,0)
Problem 2 - Alerts for additional signer are being sent on a retracted 
"BLD",7142,1,4,0)
document
"BLD",7142,1,5,0)
Problem 3 - Addendum alerts are sent to author and expected co-signer 
"BLD",7142,1,6,0)
daily when an additonal signer is overdue for signature
"BLD",7142,4,0)
^9.64PA^^
"BLD",7142,6.3)
2
"BLD",7142,"ABPKG")
n
"BLD",7142,"KRN",0)
^9.67PA^8989.52^19
"BLD",7142,"KRN",.4,0)
.4
"BLD",7142,"KRN",.401,0)
.401
"BLD",7142,"KRN",.402,0)
.402
"BLD",7142,"KRN",.403,0)
.403
"BLD",7142,"KRN",.5,0)
.5
"BLD",7142,"KRN",.84,0)
.84
"BLD",7142,"KRN",3.6,0)
3.6
"BLD",7142,"KRN",3.8,0)
3.8
"BLD",7142,"KRN",9.2,0)
9.2
"BLD",7142,"KRN",9.8,0)
9.8
"BLD",7142,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",7142,"KRN",9.8,"NM",1,0)
TIUVSIT1^^0^B12827375
"BLD",7142,"KRN",9.8,"NM",2,0)
TIUTSK^^0^B21782897
"BLD",7142,"KRN",9.8,"NM",3,0)
TIUALRT^^0^B47663478
"BLD",7142,"KRN",9.8,"NM","B","TIUALRT",3)

"BLD",7142,"KRN",9.8,"NM","B","TIUTSK",2)

"BLD",7142,"KRN",9.8,"NM","B","TIUVSIT1",1)

"BLD",7142,"KRN",19,0)
19
"BLD",7142,"KRN",19.1,0)
19.1
"BLD",7142,"KRN",101,0)
101
"BLD",7142,"KRN",409.61,0)
409.61
"BLD",7142,"KRN",771,0)
771
"BLD",7142,"KRN",870,0)
870
"BLD",7142,"KRN",8989.51,0)
8989.51
"BLD",7142,"KRN",8989.52,0)
8989.52
"BLD",7142,"KRN",8994,0)
8994
"BLD",7142,"KRN","B",.4,.4)

"BLD",7142,"KRN","B",.401,.401)

"BLD",7142,"KRN","B",.402,.402)

"BLD",7142,"KRN","B",.403,.403)

"BLD",7142,"KRN","B",.5,.5)

"BLD",7142,"KRN","B",.84,.84)

"BLD",7142,"KRN","B",3.6,3.6)

"BLD",7142,"KRN","B",3.8,3.8)

"BLD",7142,"KRN","B",9.2,9.2)

"BLD",7142,"KRN","B",9.8,9.8)

"BLD",7142,"KRN","B",19,19)

"BLD",7142,"KRN","B",19.1,19.1)

"BLD",7142,"KRN","B",101,101)

"BLD",7142,"KRN","B",409.61,409.61)

"BLD",7142,"KRN","B",771,771)

"BLD",7142,"KRN","B",870,870)

"BLD",7142,"KRN","B",8989.51,8989.51)

"BLD",7142,"KRN","B",8989.52,8989.52)

"BLD",7142,"KRN","B",8994,8994)

"BLD",7142,"QUES",0)
^9.62^^
"BLD",7142,"REQB",0)
^9.611^3^3
"BLD",7142,"REQB",1,0)
TIU*1.0*210^1
"BLD",7142,"REQB",2,0)
TIU*1.0*190^1
"BLD",7142,"REQB",3,0)
TIU*1.0*175^1
"BLD",7142,"REQB","B","TIU*1.0*175",3)

"BLD",7142,"REQB","B","TIU*1.0*190",2)

"BLD",7142,"REQB","B","TIU*1.0*210",1)

"MBREQ")
0
"PKG",470,-1)
1^1
"PKG",470,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",470,20,0)
^9.402P^^
"PKG",470,22,0)
^9.49I^1^1
"PKG",470,22,1,0)
1.0^3010801^3010806^66481
"PKG",470,22,1,"PAH",1,0)
221^3070212
"PKG",470,22,1,"PAH",1,1,0)
^^6^6^3070212
"PKG",470,22,1,"PAH",1,1,1,0)
Problem 1 - when there are 2 appointments in the same day an uploaded 
"PKG",470,22,1,"PAH",1,1,2,0)
document always posts to the last appointment.
"PKG",470,22,1,"PAH",1,1,3,0)
Problem 2 - Alerts for additional signer are being sent on a retracted 
"PKG",470,22,1,"PAH",1,1,4,0)
document
"PKG",470,22,1,"PAH",1,1,5,0)
Problem 3 - Addendum alerts are sent to author and expected co-signer 
"PKG",470,22,1,"PAH",1,1,6,0)
daily when an additonal signer is overdue for signature
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","TIUALRT")
0^3^B47663478^B46526341
"RTN","TIUALRT",1,0)
TIUALRT ; SLC/JER,AJB - Notify Author and Attending. ; Mar 17, 2003
"RTN","TIUALRT",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**21,84,79,88,58,61,151,158,175,221**;Jun 20, 1997;Build 2
"RTN","TIUALRT",3,0)
SEND(DA,OVERDUE) ; Generate "available for signature" alert
"RTN","TIUALRT",4,0)
 N TIU0,TIU12,TIU13,TIU14,TIU15,TIUESNR,TIUPNM,TIUECSNR,TIUSIG,TIUDPRM
"RTN","TIUALRT",5,0)
 N TIUCOSG,TIUEDT,TIUSSN,TIU,TIUTYP,XQA,XQAKILL,XQAMSG,XQAROU,XQAID
"RTN","TIUALRT",6,0)
 N XQAFLG,STATUS,SIGACT,ECSNRFLG
"RTN","TIUALRT",7,0)
 I '$D(TIUPRM0)!'$D(TIUPRM1) D SETPARM^TIULE
"RTN","TIUALRT",8,0)
 I '$D(TIUTMP("NODEL")) D ALERTDEL(DA)
"RTN","TIUALRT",9,0)
 S TIU0=$G(^TIU(8925,+DA,0)),TIU12=$G(^(12)),TIU13=$G(^(13))
"RTN","TIUALRT",10,0)
 S TIU14=$G(^TIU(8925,+DA,14)),TIU15=$G(^(15))
"RTN","TIUALRT",11,0)
 D DOCPRM^TIULC1(+TIU0,.TIUDPRM,DA)
"RTN","TIUALRT",12,0)
 ; Quit if notifications not enabled
"RTN","TIUALRT",13,0)
 I '$D(TIUDPRM(0)) Q
"RTN","TIUALRT",14,0)
 ; If document is an addendum, and the original is incomplete, quit
"RTN","TIUALRT",15,0)
 ; per NOIS DUR-0101-32087
"RTN","TIUALRT",16,0)
 ; I +$$ISADDNDM^TIULC1(DA),($P($G(^TIU(8925,+$P(TIU0,U,6),0)),U,5)<7) Q
"RTN","TIUALRT",17,0)
 I '+$P(TIUPRM1,U,7)!(+$P(TIU12,U)<+$P(TIUPRM1,U,7)) Q
"RTN","TIUALRT",18,0)
 ;VMP/ELR  PATCH 221  DO NOT SEND ALERTS FOR RETRACTED DOCUMENTS
"RTN","TIUALRT",19,0)
 I +$P(TIU0,U,5)=15 Q
"RTN","TIUALRT",20,0)
 ; If third party alert from TIUALFUN **158**
"RTN","TIUALRT",21,0)
 I $D(TIUTMP("THIRD PARTY ALERTS")) G THIRD
"RTN","TIUALRT",22,0)
 ; If document is completed, jump to additional signers
"RTN","TIUALRT",23,0)
 I (+$P(TIU0,U,5)'<7) G ADDSNR
"RTN","TIUALRT",24,0)
 I +$P(TIU0,U,5)=3,+$P($G(TIUDPRM(0)),U,2),'+$P(TIU13,U,4) Q  ; not released **175**
"RTN","TIUALRT",25,0)
 ; If Verification required, and not verified, don't send
"RTN","TIUALRT",26,0)
 I +$P(TIU0,U,5)=4,+$$REQVER^TIULC(DA,+$P($G(TIUDPRM(0)),U,3)),'+$P(TIU13,U,5) Q  ; **175**
"RTN","TIUALRT",27,0)
 ; Set up for call to XQALERT
"RTN","TIUALRT",28,0)
 S TIUEDT=$$DATE^TIULS($P(TIU0,U,7))
"RTN","TIUALRT",29,0)
 S TIUESNR=$P(TIU12,U,4)
"RTN","TIUALRT",30,0)
 S TIUSIG=$P(TIU15,U)
"RTN","TIUALRT",31,0)
 S TIUECSNR=$P(TIU12,U,8),TIUCOSG=$P(TIU15,U,7)
"RTN","TIUALRT",32,0)
 ; If author has been identified, but not Expected Signer, make
"RTN","TIUALRT",33,0)
 ; author the expected signer
"RTN","TIUALRT",34,0)
 I +TIUESNR'>0,(+$P(TIU12,U,2)>0) D
"RTN","TIUALRT",35,0)
 . N DIE,DR
"RTN","TIUALRT",36,0)
 . S TIUESNR=$P(TIU12,U,2)
"RTN","TIUALRT",37,0)
 . S DIE=8925,DR="1204////^S X=TIUESNR" D ^DIE
"RTN","TIUALRT",38,0)
 ; If attending has been identified, but not Expected Cosigner, make
"RTN","TIUALRT",39,0)
 ; attending the expected cosigner
"RTN","TIUALRT",40,0)
 I +TIUECSNR'>0,(+$P(TIU12,U,9)>0) D
"RTN","TIUALRT",41,0)
 . N DIE,DR
"RTN","TIUALRT",42,0)
 . S TIUECSNR=$P(TIU12,U,9)
"RTN","TIUALRT",43,0)
 . S DIE=8925,DR="1208////^S X=TIUECSNR" D ^DIE
"RTN","TIUALRT",44,0)
 ; If first signature required and the expected signer is authorized
"RTN","TIUALRT",45,0)
 ; to sign this record, and the record is not yet signed
"RTN","TIUALRT",46,0)
 ; ** Set AUTHOR as recipient
"RTN","TIUALRT",47,0)
 I '+$G(TIUSIG),(+TIUESNR>0),(+$P(TIUDPRM(0),U,4)>0) S XQA(TIUESNR)=""
"RTN","TIUALRT",48,0)
 ; If the record requires cosignature, and is not yet cosigned
"RTN","TIUALRT",49,0)
 ; ** Set Expected Cosigner as recipient
"RTN","TIUALRT",50,0)
 I TIUECSNR]"",(+$P(TIU0,U,5)<7),(+$G(TIUCOSG)'>0) D
"RTN","TIUALRT",51,0)
 . N TIUDA S TIUDA=DA
"RTN","TIUALRT",52,0)
 . ; For documents other than Discharge Summaries, defer alerting
"RTN","TIUALRT",53,0)
 . ; Expected Cosigner 'til AUTHOR has signed
"RTN","TIUALRT",54,0)
 . ; If current document is an addendum apply test to its parent
"RTN","TIUALRT",55,0)
 . I +$$ISADDNDM^TIULC1(DA) S TIUDA=$P(^TIU(8925,DA,0),U,6)
"RTN","TIUALRT",56,0)
 . ; If cosigner alerts are to be deferred until signature, quit
"RTN","TIUALRT",57,0)
 . I '+$P(TIUDPRM(0),U,20),'+$G(TIUSIG),+$P(TIUDPRM(0),U,4) Q  ; **84,112/151**
"RTN","TIUALRT",58,0)
 . S XQA(TIUECSNR)="",ECSNRFLG=1 ; **151**
"RTN","TIUALRT",59,0)
ADDSNR ; Send addendum alerts, check for additional signers
"RTN","TIUALRT",60,0)
 ;VMP/ELR PATCH 221  DO NOT SEND AMENDMENT ALERT IF CAUSED BY A DELINQUENT ADDITIONAL SIGNER
"RTN","TIUALRT",61,0)
 I +$$ISADDNDM^TIULC1(DA),$G(TIUADDL)'=1 D SENDADD(DA)
"RTN","TIUALRT",62,0)
 ; If additional signers have been designated, alert them too
"RTN","TIUALRT",63,0)
 I +$O(^TIU(8925.7,"B",DA,0)),(+$P(TIU0,U,5)>5) D
"RTN","TIUALRT",64,0)
 . N TIUXTRA,TIUI D XTRASGNR^TIULG(.TIUXTRA,DA) Q:+$D(TIUXTRA)'>9
"RTN","TIUALRT",65,0)
 . S TIUI=0 F  S TIUI=$O(TIUXTRA(TIUI)) Q:+TIUI'>0  S XQA(TIUI)=""
"RTN","TIUALRT",66,0)
 Q:$D(XQA)'>9
"RTN","TIUALRT",67,0)
THIRD ; **158**
"RTN","TIUALRT",68,0)
 I $D(TIUTMP("THIRD PARTY ALERTS")) D
"RTN","TIUALRT",69,0)
 . N TIUX
"RTN","TIUALRT",70,0)
 . S TIUX="" F  S TIUX=$O(TIUXQA(TIUX)) Q:TIUX=""  S XQA(TIUX)=""
"RTN","TIUALRT",71,0)
 ; Get demographics for alert message
"RTN","TIUALRT",72,0)
 S TIUPNM=$E($P($G(^DPT(+$P(TIU0,U,2),0)),U),1,9)
"RTN","TIUALRT",73,0)
 S TIUTYP=$$PNAME^TIULC1(+$G(TIU0))
"RTN","TIUALRT",74,0)
 D PATVADPT^TIULV(.TIU,+$P(TIU0,U,2))
"RTN","TIUALRT",75,0)
 S TIUSSN=$E(TIUPNM,1)_$P($G(TIU("SSN")),"-",3)
"RTN","TIUALRT",76,0)
 S XQAID="TIU"_+DA,STATUS=$$UP^XLFSTR($$GET1^DIQ(8925,DA,.05)) ; **175** $$STATUS^TIULC(DA))
"RTN","TIUALRT",77,0)
 S SIGACT=$S(STATUS="UNSIGNED":"SIGNATURE",STATUS="UNCOSIGNED":"COSIGNATURE",1:"ADD'L SIGNATURE")
"RTN","TIUALRT",78,0)
 I $G(ECSNRFLG),$P(TIU0,U,5)=5 S STATUS="UNSIG/UNCOS'D" ; **151**
"RTN","TIUALRT",79,0)
 S XQAMSG=TIUPNM_" ("_TIUSSN_"): "_STATUS_" "_$S($P(TIU0,U,9)="P":"STAT ",1:"")_TIUTYP
"RTN","TIUALRT",80,0)
 I +$G(OVERDUE) S XQAMSG=XQAMSG_" OVERDUE for "_SIGACT_"." G ENDMSG
"RTN","TIUALRT",81,0)
 S XQAMSG=XQAMSG_" available for "_SIGACT_"."
"RTN","TIUALRT",82,0)
ENDMSG ;
"RTN","TIUALRT",83,0)
 S XQAROU="ACT^TIUALRT",XQADATA=+DA_U
"RTN","TIUALRT",84,0)
 D SETUP^XQALERT
"RTN","TIUALRT",85,0)
 Q
"RTN","TIUALRT",86,0)
ACT ; Act on alerts
"RTN","TIUALRT",87,0)
 N TIUQUIK,TIUDA,TIUPRM0,TIUPRM1,TIUPRM3,RSTOK S TIUQUIK=1 K XQAKILL
"RTN","TIUALRT",88,0)
 S TIUDA=$P(XQADATA,U)
"RTN","TIUALRT",89,0)
 I '$D(^TIU(8925,+TIUDA,0)) D ALERTDEL(TIUDA) Q
"RTN","TIUALRT",90,0)
 S RSTOK=$$DOCCHK^TIULRR(TIUDA)
"RTN","TIUALRT",91,0)
 I RSTOK'>0 D  Q
"RTN","TIUALRT",92,0)
 . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIUALRT",93,0)
 . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIUALRT",94,0)
 I $P(^TIU(8925,+TIUDA,0),U,5)'<7,'+$$ISSIGNR(TIUDA,DUZ) S XQAKILL=1
"RTN","TIUALRT",95,0)
 D:'$D(TIUPRM0)!'$D(TIUPRM1) SETPARM^TIULE
"RTN","TIUALRT",96,0)
 D EN^VALM("TIU BROWSE FOR CLINICIAN")
"RTN","TIUALRT",97,0)
 Q
"RTN","TIUALRT",98,0)
SENDTRAN(DA) ; Generate "Send back to transcription" alert
"RTN","TIUALRT",99,0)
 N TIUEDT,TIU0,TIUPNM,TIUSSN,TIUTRAN,TIU,XQA,XQAMSG,TIUMSG
"RTN","TIUALRT",100,0)
 N TIUESNR,TIU12,TIU13,TIU14,TIU15,TIUTYP
"RTN","TIUALRT",101,0)
 I '$D(TIUPRM0)!'$D(TIUPRM1) D SETPARM^TIULE
"RTN","TIUALRT",102,0)
 D ALERTDEL(DA)
"RTN","TIUALRT",103,0)
 ; Don't send if notifications not enabled
"RTN","TIUALRT",104,0)
 I '+$P(TIUPRM1,U,7) Q
"RTN","TIUALRT",105,0)
 S TIU0=$G(^TIU(8925,+DA,0)),TIU12=$G(^(12)),TIU13=$G(^(13))
"RTN","TIUALRT",106,0)
 S TIU14=$G(^TIU(8925,+DA,14)),TIU15=$G(^(15))
"RTN","TIUALRT",107,0)
 S TIUPNM=$E($P($G(^DPT(+$P(TIU0,U,2),0)),U),1,9)
"RTN","TIUALRT",108,0)
 S TIUEDT=$$DATE^TIULS($P(TIU0,U,7))
"RTN","TIUALRT",109,0)
 S TIUTYP=$$PNAME^TIULC1(+$G(TIU0))
"RTN","TIUALRT",110,0)
 S TIUTRAN=$P(TIU13,U,2),TIUESNR=$P(TIU12,U,2) ; **175**
"RTN","TIUALRT",111,0)
 D PATVADPT^TIULV(.TIU,+$P(TIU0,U,2)) ;Used to get SSN. Date not important.
"RTN","TIUALRT",112,0)
 S TIUSSN=$E(TIUPNM,1)_$P($G(TIU("SSN")),"-",3)
"RTN","TIUALRT",113,0)
 I $D(^VA(200,+TIUTRAN,0)) S XQA(TIUTRAN)=""
"RTN","TIUALRT",114,0)
 Q:$D(XQA)'>9
"RTN","TIUALRT",115,0)
 S TIUMSG=$S(TIUTRAN=TIUESNR:" needs editing",1:" needs retranscription.")
"RTN","TIUALRT",116,0)
 S XQAID="TIU"_+DA
"RTN","TIUALRT",117,0)
 S XQAMSG=TIUPNM_" ("_TIUSSN_"): "_TIUTYP_TIUMSG
"RTN","TIUALRT",118,0)
 D SETUP^XQALERT
"RTN","TIUALRT",119,0)
 Q
"RTN","TIUALRT",120,0)
SENDADD(DA) ; Generates "Addendum added" alert
"RTN","TIUALRT",121,0)
 N TIU12,TIU13,TIU14,TIU15,TIU0,TIUPNM,TIUSSN,TIUTRAN,TIU,TIUTITLE,TIUDPRM
"RTN","TIUALRT",122,0)
 N XQA,XQAMSG,XQAFLG,XQADATA,XQAROU,TIUESNR,TIUDATE,TIUESNM,TIUO0,TIUO12,TIUO13
"RTN","TIUALRT",123,0)
 I '$D(TIUPRM0)!'$D(TIUPRM1) D SETPARM^TIULE
"RTN","TIUALRT",124,0)
 D ADDENDEL(DA)
"RTN","TIUALRT",125,0)
 ; Don't send if notifications not enabled
"RTN","TIUALRT",126,0)
 I '+$P(TIUPRM1,U,7) Q
"RTN","TIUALRT",127,0)
 S TIU0=$G(^TIU(8925,+DA,0))
"RTN","TIUALRT",128,0)
 ; Only send upon completion
"RTN","TIUALRT",129,0)
 Q:+$P(TIU0,U,5)'>6
"RTN","TIUALRT",130,0)
 D DOCPRM^TIULC1(+TIU0,.TIUDPRM,DA) Q:'+$P(TIUDPRM(0),U,17)
"RTN","TIUALRT",131,0)
 S TIU12=$G(^TIU(8925,+DA,12)),TIU13=$G(^(13)),TIU14=$G(^(14)),TIU15=$G(^(15))
"RTN","TIUALRT",132,0)
 S TIUO0=$G(^TIU(8925,$P(TIU0,U,6),0)),TIUO12=$G(^(12)),TIUO13=$G(^(13))
"RTN","TIUALRT",133,0)
 S TIUPNM=$E($$PTNAME^TIULC1(+$P(TIU0,U,2)),1,9)
"RTN","TIUALRT",134,0)
 S TIUESNM=$$NAME^TIULS($$PERSNAME^TIULC1(+$P(TIU12,U,2)),"LAST,FI MI")
"RTN","TIUALRT",135,0)
 S TIUTITLE=$E($$PNAME^TIULC1(+TIUO0),1,20)
"RTN","TIUALRT",136,0)
 S TIUDATE=$S(+$P(TIUO13,U):$P(TIUO13,U),1:$G(DT))
"RTN","TIUALRT",137,0)
 S TIUDATE=$$DATE^TIULS(TIUDATE)
"RTN","TIUALRT",138,0)
 D PATVADPT^TIULV(.TIU,+$P(TIU0,U,2)) ;Used to get SSN. Date not important.
"RTN","TIUALRT",139,0)
 S TIUSSN=$E(TIUPNM,1)_$P($G(TIU("SSN")),"-",3)
"RTN","TIUALRT",140,0)
 S TIUTRAN=$P(TIU13,U,2)
"RTN","TIUALRT",141,0)
 ;Expected Cosigner and Author of original document
"RTN","TIUALRT",142,0)
 S TIUECSNR=$P($G(^TIU(8925,$P(TIU0,U,6),12)),U,8),TIUESNR=$P($G(^(12)),U,4)
"RTN","TIUALRT",143,0)
 ; Not entered by Expected Signer: SET Expected Signer as recipient
"RTN","TIUALRT",144,0)
 I TIUESNR'=TIUTRAN,$D(^VA(200,+TIUESNR,0)) S XQA(TIUESNR)=""
"RTN","TIUALRT",145,0)
 ; Not entered by Expected Cosigner: SET Expected Cosigner as recipient
"RTN","TIUALRT",146,0)
 I +TIUECSNR>0,(TIUECSNR'=TIUTRAN),$D(^VA(200,+TIUECSNR,0)) S XQA(TIUECSNR)=""
"RTN","TIUALRT",147,0)
 Q:$D(XQA)'>9
"RTN","TIUALRT",148,0)
 S XQAID="TIUADD"_+DA,XQADATA=+DA_U,XQAROU="ACTADD^TIUALRT"
"RTN","TIUALRT",149,0)
 S XQAMSG=TIUPNM_" ("_TIUSSN_"): ADDENDUM to "_TIUTITLE_" of "_TIUDATE_" by "_TIUESNM
"RTN","TIUALRT",150,0)
 D SETUP^XQALERT
"RTN","TIUALRT",151,0)
 Q
"RTN","TIUALRT",152,0)
ACTADD ; Act on ADDENDUM alerts
"RTN","TIUALRT",153,0)
 N TIUQUIK,TIUDA,TIUPRM0,TIUPRM1,TIUPRM3 S TIUQUIK=1 K XQAKILL
"RTN","TIUALRT",154,0)
 S TIUDA=$P(XQADATA,U),XQAKILL=1
"RTN","TIUALRT",155,0)
 I '$D(^TIU(8925,+TIUDA,0)) D ADDENDEL(TIUDA) Q
"RTN","TIUALRT",156,0)
 W !!,"A NEW Addendum has been added to your document...",!
"RTN","TIUALRT",157,0)
 W:$L($P($G(XQX),U,3)) !,$P($G(XQX),U,3),!
"RTN","TIUALRT",158,0)
 I '+$$READ^TIUU("YAO","Do you wish to Browse the Addendum now? ","NO") Q
"RTN","TIUALRT",159,0)
 D:'$D(TIUPRM0)!'$D(TIUPRM1) SETPARM^TIULE
"RTN","TIUALRT",160,0)
 D EN^VALM("TIU BROWSE FOR CLINICIAN")
"RTN","TIUALRT",161,0)
 Q
"RTN","TIUALRT",162,0)
ALERTDEL(DA) ; Delete alerts associated with a given document
"RTN","TIUALRT",163,0)
 N XQA,XQAID,XQAKILL S XQAID="TIU"_DA
"RTN","TIUALRT",164,0)
 D DELETEA^XQALERT
"RTN","TIUALRT",165,0)
 Q
"RTN","TIUALRT",166,0)
ADDENDEL(DA) ; Delete alert associated with a Addendum added
"RTN","TIUALRT",167,0)
 N XQA,XQAID,XQAKILL S XQAID="TIUADD"_DA
"RTN","TIUALRT",168,0)
 D DELETEA^XQALERT
"RTN","TIUALRT",169,0)
 Q
"RTN","TIUALRT",170,0)
ISSIGNR(DA,USER) ; Is USER an additional signer of document DA?
"RTN","TIUALRT",171,0)
 N TIUY,TIUSDA,TIUSD0 S (TIUY,TIUSDA)=0
"RTN","TIUALRT",172,0)
 S TIUSDA=+$O(^TIU(8925.7,"AE",DA,USER,0)) G:'TIUSDA ISSIGNX
"RTN","TIUALRT",173,0)
 S TIUSD0=$G(^TIU(8925.7,TIUSDA,0)) G:'$L(TIUSD0) ISSIGNX
"RTN","TIUALRT",174,0)
 I +$P(TIUSD0,U,4)'>0 S TIUY=1
"RTN","TIUALRT",175,0)
ISSIGNX Q TIUY
"RTN","TIUTSK")
0^2^B21782897^B21071583
"RTN","TIUTSK",1,0)
TIUTSK ; SLC/JER - TIU's Nightly Daemon ;4/18/03 [10/18/04 10:34am]
"RTN","TIUTSK",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**7,53,100,113,157,210,221**;Jun 20, 1997;Build 2
"RTN","TIUTSK",3,0)
MAIN ; All records are read. DC date updated, Record purged, Alerts are 
"RTN","TIUTSK",4,0)
 ; generated if appropriate
"RTN","TIUTSK",5,0)
 N TIUDA,TIUPRM0,TIUPRM1,TIUDATE,TIUENTDT,TIUPDT,TIUODT
"RTN","TIUTSK",6,0)
 N TIUSTART,TIUEND,TIUADDL
"RTN","TIUTSK",7,0)
 D SETPARM^TIULE
"RTN","TIUTSK",8,0)
 S TIUSTART=$$TSKPARM(1),TIUEND=$$TSKPARM(2)
"RTN","TIUTSK",9,0)
 ; Traverse "FIX" X-ref to fix temporary reference dates & back-fill
"RTN","TIUTSK",10,0)
 ; Discharge Dates
"RTN","TIUTSK",11,0)
 S TIUDA="" F  S TIUDA=$O(^TIU(8925,"FIX",1,TIUDA)) Q:TIUDA'>0  D
"RTN","TIUTSK",12,0)
 . D UPDDCDT(TIUDA) ;Ref Date fixed/DC Date updated if missing
"RTN","TIUTSK",13,0)
 ; Traverse "F" X-ref to identify records for which the grace period
"RTN","TIUTSK",14,0)
 ; for purge has expired
"RTN","TIUTSK",15,0)
 S TIUPDT=$$FMADD^XLFDT(DT,-$P(TIUPRM0,U,4))
"RTN","TIUTSK",16,0)
 S TIUODT=$$FMADD^XLFDT(DT,-$P(TIUPRM0,U,5))
"RTN","TIUTSK",17,0)
 ; Traverse "F" X-ref to identify records overdue for signature or purge
"RTN","TIUTSK",18,0)
 ; NOTE: Following VHA Directive 10-92-077, the purge is disabled until
"RTN","TIUTSK",19,0)
 ;       further notice **53**
"RTN","TIUTSK",20,0)
 ;VMP/ELR PATCH 221  SET UP TIUADDL IS OVERDUE ONLY BECAUSE OF ADDITIONAL SIGNER TO STOP AMENDMENT ALERT
"RTN","TIUTSK",21,0)
 S TIUADDL=0
"RTN","TIUTSK",22,0)
 S TIUENTDT=($$TSKPARM(3)-1)+.999999
"RTN","TIUTSK",23,0)
 F  S TIUENTDT=$O(^TIU(8925,"F",TIUENTDT)) Q:+TIUENTDT'>0!(TIUENTDT>TIUODT)  D
"RTN","TIUTSK",24,0)
 . S TIUDA=0 F  S TIUDA=$O(^TIU(8925,"F",+TIUENTDT,TIUDA)) Q:+TIUDA'>0  D
"RTN","TIUTSK",25,0)
 . . ; I (TIUPDT<$$FMADD^XLFDT(DT,-90)),+$$PURGE^TIULC(TIUDA) D PURGE(TIUDA) Purges old records (see NOTE above) **53**
"RTN","TIUTSK",26,0)
 . . I +$$OVERDUE(TIUDA,TIUSTART,TIUEND) D SEND^TIUALRT(TIUDA,1) S TIUADDL=0     ;Alert for overdue
"RTN","TIUTSK",27,0)
 ; If upload buffer rec older than 30 days, delete it & its alerts
"RTN","TIUTSK",28,0)
 S TIUDA=0 F  S TIUDA=$O(^TIU(8925.2,TIUDA)) Q:TIUDA'>0  D
"RTN","TIUTSK",29,0)
 . N TIUDATE
"RTN","TIUTSK",30,0)
 . S TIUDATE=$P($G(^TIU(8925.2,TIUDA,0)),U,3)
"RTN","TIUTSK",31,0)
 . Q:+TIUDATE'>0
"RTN","TIUTSK",32,0)
 . I $$FMDIFF^XLFDT(DT,TIUDATE)>30 D
"RTN","TIUTSK",33,0)
 . . N TIUEI S TIUEI=0
"RTN","TIUTSK",34,0)
 . . ; JOEL, 12/21/00:
"RTN","TIUTSK",35,0)
 . . F  S TIUEI=$O(^TIU(8925.2,TIUDA,"ERR",TIUEI)) Q:+TIUEI'>0  D
"RTN","TIUTSK",36,0)
 . . . N TIUEDA
"RTN","TIUTSK",37,0)
 . . . S TIUEDA=+$G(^TIU(8925.2,TIUDA,"ERR",TIUEI,0)) Q:+TIUEDA'>0
"RTN","TIUTSK",38,0)
 . . . D ALERTDEL^TIUPEVNT(TIUEDA)
"RTN","TIUTSK",39,0)
 . . D BUFPURGE^TIUPUTC(TIUDA)
"RTN","TIUTSK",40,0)
 Q
"RTN","TIUTSK",41,0)
UPDDCDT(TIUDA) ; If missing DC date & Patient Movement file has DC date,
"RTN","TIUTSK",42,0)
 ;         DC date updated.
"RTN","TIUTSK",43,0)
 N DFN,DIE,DR,TIU,TIUDAD,TIUDDT,TIUD0,TIUD14,TIUDGPM
"RTN","TIUTSK",44,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD14=$G(^TIU(8925,+TIUDA,14))
"RTN","TIUTSK",45,0)
 S TIUDGPM=+$P(TIUD14,U)
"RTN","TIUTSK",46,0)
 I +$P($G(^DGPM(+TIUDGPM,0)),U,17)'>0 D  Q
"RTN","TIUTSK",47,0)
 . I +$P(TIUD0,U,12)>0 Q
"RTN","TIUTSK",48,0)
 . S DIE=8925,DR=".12////1",DA=TIUDA D ^DIE
"RTN","TIUTSK",49,0)
 I TIUD0'="",'+$P(TIUD0,U,6),(($P(TIUD0,U,8)="")!(+$P(TIUD0,U,12)>0)) D
"RTN","TIUTSK",50,0)
 . D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUTSK",51,0)
 . I +$G(TIU("LDT"))>0 D
"RTN","TIUTSK",52,0)
 . . S TIUDAD=$P(TIUD0,U,6)
"RTN","TIUTSK",53,0)
 . . D FIXDC(TIUDA,TIUDAD,DFN,.TIU)
"RTN","TIUTSK",54,0)
 Q
"RTN","TIUTSK",55,0)
PURGE(DA) ; When purge criteria met, document and addenda purged
"RTN","TIUTSK",56,0)
 N DR,DIE,TIUTYP,TIUDA,X,Y S TIUDA=0
"RTN","TIUTSK",57,0)
 F  S TIUDA=+$O(^TIU(8925,"DAD",+DA,TIUDA)) Q:+TIUDA'>0  D
"RTN","TIUTSK",58,0)
 . I +$$ISADDNDM^TIULC1(TIUDA) D PURGE(TIUDA) I 1
"RTN","TIUTSK",59,0)
 . E  D DIK^TIURB2(TIUDA) ; Remove components entirely. 1/3/01 updated DIK^TIURB to DIK^TIURB2 - Margy
"RTN","TIUTSK",60,0)
 S DIE=8925,DR=".05///PURGED;1609////"_$$NOW^TIULC_";2///@" D ^DIE
"RTN","TIUTSK",61,0)
 S ^TIU(8925,+DA,"TEXT",0)="^^"_2_U_2_U_DT_"^^"
"RTN","TIUTSK",62,0)
 S ^TIU(8925,+DA,"TEXT",1,0)=" "
"RTN","TIUTSK",63,0)
 S ^TIU(8925,+DA,"TEXT",2,0)="  Document Purged on "_$$DATE^TIULS(DT,"MM/DD/YY")_"."
"RTN","TIUTSK",64,0)
 Q
"RTN","TIUTSK",65,0)
FIXDC(DA,PARENT,DFN,TIU) ; Stuff fixed field data
"RTN","TIUTSK",66,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG
"RTN","TIUTSK",67,0)
 S IENS=""""_DA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS="K"
"RTN","TIUTSK",68,0)
 I +$G(PARENT)'>0 D
"RTN","TIUTSK",69,0)
 . S @FDARR@(.08)=$P(TIU("LDT"),U)
"RTN","TIUTSK",70,0)
 . S @FDARR@(1402)=$P($G(TIU("TS")),U)
"RTN","TIUTSK",71,0)
 I +$G(PARENT)>0 D
"RTN","TIUTSK",72,0)
 . S @FDARR@(.08)=$P(TIU("LDT"),U)
"RTN","TIUTSK",73,0)
 . S @FDARR@(1401)=$P(^TIU(8925,+PARENT,14),U)
"RTN","TIUTSK",74,0)
 . S @FDARR@(1402)=$P(^TIU(8925,+PARENT,14),U,2)
"RTN","TIUTSK",75,0)
 S @FDARR@(1205)=$P($G(TIU("LOC")),U)
"RTN","TIUTSK",76,0)
 S @FDARR@(1212)=$P($G(TIU("INST")),U)
"RTN","TIUTSK",77,0)
 S @FDARR@(.12)="@"
"RTN","TIUTSK",78,0)
 S @FDARR@(1301)=+$G(TIU("LDT"))
"RTN","TIUTSK",79,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG") ; File record
"RTN","TIUTSK",80,0)
 Q
"RTN","TIUTSK",81,0)
OVERDUE(TIUDA,TIUSTART,TIUEND) ;Checks whether or not a given document is overdue
"RTN","TIUTSK",82,0)
 ;This is the same as OVERDUE^TIULC exept for the following items:
"RTN","TIUTSK",83,0)
 ;    TIUPRM0 must be defined before calling
"RTN","TIUTSK",84,0)
 ;    also checks for additional signatures overdue
"RTN","TIUTSK",85,0)
 N TIUD0,TIUDATE,TIUY,TIUDPRM,TIUXTRA S TIUY=0,TIUD0=$G(^TIU(8925,TIUDA,0)),TIUXTRA=0
"RTN","TIUTSK",86,0)
 D DOCPRM^TIULC1(+TIUD0,.TIUDPRM,TIUDA)
"RTN","TIUTSK",87,0)
 I '$D(TIUDPRM) G OVERX
"RTN","TIUTSK",88,0)
 S TIUDATE=$S($$REQVER^TIULC(TIUDA,+$P(TIUDPRM(0),U,3)):$P($G(^TIU(8925,+TIUDA,13)),U,5),$P(TIUDPRM(0),U,2):$P($G(^TIU(8925,+TIUDA,13)),U,4),1:$P($G(^TIU(8925,+TIUDA,12)),U))
"RTN","TIUTSK",89,0)
 G:+TIUDATE'>0 OVERX
"RTN","TIUTSK",90,0)
 I $$FMDIFF^XLFDT(DT,TIUDATE)>$P(TIUPRM0,U,5),(+$P($G(^TIU(8925,+TIUDA,0)),U,5)>4),(+$P($G(^TIU(8925,+TIUDA,0)),U,5)<7) S TIUY=1 G OVERX
"RTN","TIUTSK",91,0)
 F  S TIUXTRA=$O(^TIU(8925.7,"B",TIUDA,TIUXTRA)) Q:'TIUXTRA  D
"RTN","TIUTSK",92,0)
 . I TIUDATE<$G(TIUSTART)!(TIUDATE>$G(TIUEND)) Q
"RTN","TIUTSK",93,0)
 . I '$$TSKPARM^TIUTSK(1) Q
"RTN","TIUTSK",94,0)
 . I $$FMDIFF^XLFDT(DT,TIUDATE)>$P(TIUPRM0,U,5),('$P($G(^TIU(8925.7,TIUXTRA,0)),U,4)) S TIUY=1,TIUADDL=1
"RTN","TIUTSK",95,0)
OVERX Q TIUY
"RTN","TIUTSK",96,0)
TSKPARM(TIUDA) ;Calculate a tiu parameter for the nightly task
"RTN","TIUTSK",97,0)
 ; TIUDA = 1 then return NIGHTLY TASK START computation
"RTN","TIUTSK",98,0)
 ; TIUDA = 2 then return NIGHTLY TASK END computation
"RTN","TIUTSK",99,0)
 N TIUDIV,TIUPARM,TIUY,TIUVAL
"RTN","TIUTSK",100,0)
 S TIUY=0
"RTN","TIUTSK",101,0)
 I TIUDA=2 S TIUY=DT
"RTN","TIUTSK",102,0)
 I TIUDA=3 D DT^DILF("P","T-12M",.TIUY)
"RTN","TIUTSK",103,0)
 I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIUTSK",104,0)
 I '$G(TIUPRM0) Q TIUY
"RTN","TIUTSK",105,0)
 S TIUDIV=$P(TIUPRM0,U,1)
"RTN","TIUTSK",106,0)
 I '$G(TIUDIV) Q TIUY
"RTN","TIUTSK",107,0)
 S TIUPARM=$O(^TIU(8925.99,"B",TIUDIV,""))
"RTN","TIUTSK",108,0)
 I '$G(TIUPARM) Q TIUY
"RTN","TIUTSK",109,0)
 S TIUVAL=$P($G(^TIU(8925.99,TIUPARM,3)),U,TIUDA)
"RTN","TIUTSK",110,0)
 I '$G(TIUVAL) Q TIUY
"RTN","TIUTSK",111,0)
 D DT^DILF("P","T-"_TIUVAL,.TIUY)
"RTN","TIUTSK",112,0)
 Q TIUY
"RTN","TIUVSIT1")
0^1^B12827375^B10242353
"RTN","TIUVSIT1",1,0)
TIUVSIT1 ; SLC/JER - Visit look-up (cont'd) ;4/29/99@11:51:42 [1/18/05 9:22am]
"RTN","TIUVSIT1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**39,179,190,221**;Jun 20, 1997;Build 2
"RTN","TIUVSIT1",3,0)
NOTFOUND() ; Ask <U>NSCHEDULED or <F>UTURE
"RTN","TIUVSIT1",4,0)
 N TIUY
"RTN","TIUVSIT1",5,0)
 W !,"CHOOSE <U>NSCHEDULED VISITS, <F>UTURE VISITS, or <N>EW VISIT"
"RTN","TIUVSIT1",6,0)
 W !,"<RETURN> TO CONTINUE"
"RTN","TIUVSIT1",7,0)
 S TIUY=$$READ^TIUU("FOA","OR '^' TO QUIT: ","","^D HELP^TIUVSITH(""?"")")
"RTN","TIUVSIT1",8,0)
 Q TIUY
"RTN","TIUVSIT1",9,0)
GETAPPT(DFN,CLINIC,OCCLIM,INDEX,COUNT,LAST,EARLY,FUTURE) ; Get list
"RTN","TIUVSIT1",10,0)
 ; of appointments
"RTN","TIUVSIT1",11,0)
 N TIUCNT,TIUI,TIUSREC,TIUJ,TIUFLIM,TIUARRAY,LATE,TIUK,TIUNUM
"RTN","TIUVSIT1",12,0)
 I '$D(TIUPRM0) D SETPARM^TIULE
"RTN","TIUVSIT1",13,0)
 S TIUFLIM=$S(+$P(TIUPRM0,U,14)>0&+$G(FUTURE):$P(TIUPRM0,U,14),1:1)
"RTN","TIUVSIT1",14,0)
 S OCCLIM=$S(+$G(OCCLIM):+$G(OCCLIM),1:20)
"RTN","TIUVSIT1",15,0)
 S:'+$G(DT) DT=$$DT^XLFDT
"RTN","TIUVSIT1",16,0)
 S EARLY=+$G(EARLY)
"RTN","TIUVSIT1",17,0)
 S LATE=$S(+$G(INDEX):+$G(INDEX),1:$$FMADD^XLFDT(DT,TIUFLIM)_"."_235959)
"RTN","TIUVSIT1",18,0)
 S (LAST,TIUCNT,TIUK)=0,TIUJ=$S(+$G(COUNT):+$G(COUNT),1:0)
"RTN","TIUVSIT1",19,0)
 S TIUARRAY(1)=EARLY_";"_LATE
"RTN","TIUVSIT1",20,0)
 I $G(EARLY)=0 S TIUARRAY(1)=";"_LATE
"RTN","TIUVSIT1",21,0)
 S TIUARRAY(4)=DFN
"RTN","TIUVSIT1",22,0)
 S TIUARRAY("SORT")="P"
"RTN","TIUVSIT1",23,0)
 S TIUARRAY("FLDS")="1;2;3;10;12;22"
"RTN","TIUVSIT1",24,0)
 S TIUNUM=$$SDAPI^SDAMA301(.TIUARRAY) Q:'TIUNUM
"RTN","TIUVSIT1",25,0)
 S TIUI=LATE+.000001
"RTN","TIUVSIT1",26,0)
 I TIUNUM=-1 D  Q
"RTN","TIUVSIT1",27,0)
 . S ^TMP("TIUVERR",$J)="Could not retrieve patient information due to a problem with the database."
"RTN","TIUVSIT1",28,0)
 . I $D(^TMP($J,"SDAMA301",115)) S ^TMP("TIUVERR",$J,115)="This patient may not have an assigned ICN."
"RTN","TIUVSIT1",29,0)
 ;VMP/ELR ADDED NEXT LINE PATCH TIU 1 221   DBIA 3356 FOR XQY0
"RTN","TIUVSIT1",30,0)
 I $G(TIUNUM)>1,$G(XQY0)["TIU UPLOAD DOCUMENTS" N TIUONEC S TIUONEC=$$CLCNT()
"RTN","TIUVSIT1",31,0)
 F  S TIUI=$O(^TMP($J,"SDAMA301",DFN,TIUI),-1) S:+TIUI'>0 LAST=1 Q:+TIUI'>0!(+TIUCNT'<OCCLIM)!(+TIUI<EARLY)  D
"RTN","TIUVSIT1",32,0)
 . N APPTDT,APPTCL,APPTST,APPTTY,OPENC,STATUS
"RTN","TIUVSIT1",33,0)
 . ;VMP/ELR ADDED NEXT LINE PATCH TIU 1 221
"RTN","TIUVSIT1",34,0)
 . I $G(XQY0)["TIU UPLOAD DOCUMENTS",$G(TIUNUM)>1,$G(TIUONEC)>1,$L(TIUVDT),TIUVDT'=TIUI Q
"RTN","TIUVSIT1",35,0)
 . S TIUCNT=+$G(TIUCNT)+1,TIUJ=+$G(TIUJ)+1
"RTN","TIUVSIT1",36,0)
 . S APPTCL=$P(^TMP($J,"SDAMA301",DFN,TIUI),U,2)
"RTN","TIUVSIT1",37,0)
 . S APPTST=$P(^TMP($J,"SDAMA301",DFN,TIUI),U,3)
"RTN","TIUVSIT1",38,0)
 . S APPTTY=$P(^TMP($J,"SDAMA301",DFN,TIUI),U,10)
"RTN","TIUVSIT1",39,0)
 . S OPENC=$P(^TMP($J,"SDAMA301",DFN,TIUI),U,12)
"RTN","TIUVSIT1",40,0)
 . S STATUS=$P(^TMP($J,"SDAMA301",DFN,TIUI),U,22)
"RTN","TIUVSIT1",41,0)
 . I +$G(CLINIC),(+APPTCL'=+CLINIC) Q
"RTN","TIUVSIT1",42,0)
 . ;Set up internal value array
"RTN","TIUVSIT1",43,0)
 . S ^TMP("TIUVNI",$J,TIUJ)=TIUI_U_+APPTCL
"RTN","TIUVSIT1",44,0)
 . I $P(APPTST,";")="R" S ^TMP("TIUVNI",$J,TIUJ)=^TMP("TIUVNI",$J,TIUJ)_U
"RTN","TIUVSIT1",45,0)
 . I $P(APPTST,";")'="R" S ^TMP("TIUVNI",$J,TIUJ)=^TMP("TIUVNI",$J,TIUJ)_U_$P(APPTST,";")
"RTN","TIUVSIT1",46,0)
 . S ^TMP("TIUVNI",$J,TIUJ)=^TMP("TIUVNI",$J,TIUJ)_U_+APPTTY
"RTN","TIUVSIT1",47,0)
 . S ^TMP("TIUVNI",$J,TIUJ)=^TMP("TIUVNI",$J,TIUJ)_U_$G(OPENC)
"RTN","TIUVSIT1",48,0)
 . ;Set up external value array
"RTN","TIUVSIT1",49,0)
 . S ^TMP("TIUVN",$J,TIUJ)=$$DATE^TIULS(TIUI,"AMTH DD, CCYY@HR:MIN")
"RTN","TIUVSIT1",50,0)
 . S ^TMP("TIUVN",$J,TIUJ)=^TMP("TIUVN",$J,TIUJ)_U_$P(APPTCL,";",2)
"RTN","TIUVSIT1",51,0)
 . S ^TMP("TIUVN",$J,TIUJ)=^TMP("TIUVN",$J,TIUJ)_U_$P(STATUS,";",3)
"RTN","TIUVSIT1",52,0)
 . S ^TMP("TIUVN",$J,TIUJ)=^TMP("TIUVN",$J,TIUJ)_U_$P(APPTTY,";",2)
"RTN","TIUVSIT1",53,0)
 . ;Set up index by date
"RTN","TIUVSIT1",54,0)
 . S ^TMP("TIUVDT",$J,TIUI)=TIUJ
"RTN","TIUVSIT1",55,0)
 . ;Set up array of appts to exclude dup visit creation if appt is for today
"RTN","TIUVSIT1",56,0)
 . I $P(APPTST,";")="R" S ^TMP("TIUNOT",$J,+$P($G(^TMP($J,"SDAMA301",DFN,TIUI)),U,2),+TIUI)=TIUJ
"RTN","TIUVSIT1",57,0)
 K ^TMP($J,"SDAMA301")
"RTN","TIUVSIT1",58,0)
 Q
"RTN","TIUVSIT1",59,0)
 ;VMP/ELR ADDED NEXT TAG PATCH TIU 1 221
"RTN","TIUVSIT1",60,0)
CLCNT() ;
"RTN","TIUVSIT1",61,0)
 N TIUICL,TIUCNT S TIUICL=TIUI,TIUCNT=0
"RTN","TIUVSIT1",62,0)
 F  S TIUICL=$O(^TMP($J,"SDAMA301",DFN,TIUICL),-1)  Q:+TIUICL'>0!(+TIUICL<EARLY)  D
"RTN","TIUVSIT1",63,0)
 . I +$P(^TMP($J,"SDAMA301",DFN,TIUICL),U,2)=$G(CLINIC) S TIUCNT=TIUCNT+1
"RTN","TIUVSIT1",64,0)
 Q TIUCNT
"VER")
8.0^22.0
"BLD",7142,6)
^216
**END**
**END**
