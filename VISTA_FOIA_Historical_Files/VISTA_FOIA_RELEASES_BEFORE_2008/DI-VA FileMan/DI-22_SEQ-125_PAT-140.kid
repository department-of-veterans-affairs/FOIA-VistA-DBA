Released DI*22*140 SEQ #125
Extracted from mail message
**KIDS**:DI*22.0*140^

**INSTALL NAME**
DI*22.0*140
"BLD",540,0)
DI*22.0*140^VA FILEMAN^0^3040824^y
"BLD",540,1,0)
^^2^2^3040607^
"BLD",540,1,1,0)
See patch DI*22*140 in the National Patch Module on FORUM for complete
"BLD",540,1,2,0)
information on this patch.
"BLD",540,4,0)
^9.64PA^^
"BLD",540,"INIT")
DIPOS140
"BLD",540,"KRN",0)
^9.67PA^8989.52^19
"BLD",540,"KRN",.4,0)
.4
"BLD",540,"KRN",.401,0)
.401
"BLD",540,"KRN",.402,0)
.402
"BLD",540,"KRN",.403,0)
.403
"BLD",540,"KRN",.5,0)
.5
"BLD",540,"KRN",.84,0)
.84
"BLD",540,"KRN",3.6,0)
3.6
"BLD",540,"KRN",3.8,0)
3.8
"BLD",540,"KRN",9.2,0)
9.2
"BLD",540,"KRN",9.8,0)
9.8
"BLD",540,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",540,"KRN",9.8,"NM",1,0)
DIKZ^^0^B29541347
"BLD",540,"KRN",9.8,"NM",2,0)
DIKZ0^^0^B25444668
"BLD",540,"KRN",9.8,"NM",3,0)
DIAUTL^^0^B26328475
"BLD",540,"KRN",9.8,"NM","B","DIAUTL",3)

"BLD",540,"KRN",9.8,"NM","B","DIKZ",1)

"BLD",540,"KRN",9.8,"NM","B","DIKZ0",2)

"BLD",540,"KRN",19,0)
19
"BLD",540,"KRN",19.1,0)
19.1
"BLD",540,"KRN",101,0)
101
"BLD",540,"KRN",409.61,0)
409.61
"BLD",540,"KRN",771,0)
771
"BLD",540,"KRN",870,0)
870
"BLD",540,"KRN",8989.51,0)
8989.51
"BLD",540,"KRN",8989.52,0)
8989.52
"BLD",540,"KRN",8994,0)
8994
"BLD",540,"KRN","B",.4,.4)

"BLD",540,"KRN","B",.401,.401)

"BLD",540,"KRN","B",.402,.402)

"BLD",540,"KRN","B",.403,.403)

"BLD",540,"KRN","B",.5,.5)

"BLD",540,"KRN","B",.84,.84)

"BLD",540,"KRN","B",3.6,3.6)

"BLD",540,"KRN","B",3.8,3.8)

"BLD",540,"KRN","B",9.2,9.2)

"BLD",540,"KRN","B",9.8,9.8)

"BLD",540,"KRN","B",19,19)

"BLD",540,"KRN","B",19.1,19.1)

"BLD",540,"KRN","B",101,101)

"BLD",540,"KRN","B",409.61,409.61)

"BLD",540,"KRN","B",771,771)

"BLD",540,"KRN","B",870,870)

"BLD",540,"KRN","B",8989.51,8989.51)

"BLD",540,"KRN","B",8989.52,8989.52)

"BLD",540,"KRN","B",8994,8994)

"BLD",540,"PRE")
DIENVWRN
"BLD",540,"QUES",0)
^9.62^^
"BLD",540,"REQB",0)
^9.611^1^1
"BLD",540,"REQB",1,0)
DI*22.0*76^2
"BLD",540,"REQB","B","DI*22.0*76",1)

"INIT")
DIPOS140
"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
VA FILEMAN^DI^FM INIT
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
22.0^2990330^3030110^41
"PKG",5,22,1,"PAH",1,0)
140^3040824
"PKG",5,22,1,"PAH",1,1,0)
^^2^2^3040824
"PKG",5,22,1,"PAH",1,1,1,0)
See patch DI*22*140 in the National Patch Module on FORUM for complete
"PKG",5,22,1,"PAH",1,1,2,0)
information on this patch.
"PRE")
DIENVWRN
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","DIAUTL")
0^3^B26328475
"RTN","DIAUTL",1,0)
DIAUTL ;GFT;13AUG2004
"RTN","DIAUTL",2,0)
 ;;22.0;VA FileMan;**76,140**;Mar 30, 1999
"RTN","DIAUTL",3,0)
 ;
"RTN","DIAUTL",4,0)
TURNON(DIFILE,FLDS,DIMODE) ;Turn on AUDITING for the FLDS named
"RTN","DIAUTL",5,0)
 N D,DIFIELD,DIE,DR,DA,DIQUIET,DIEZS,D0,DQ,DI,DIC,X
"RTN","DIAUTL",6,0)
 S DIMODE=$E($G(DIMODE,"y")),DIQUIET=1,DIEZS=1 Q:DIFILE<2  Q:"yen"'[DIMODE
"RTN","DIAUTL",7,0)
 F DIFIELD=0:0 S DIFIELD=$O(^DD(DIFILE,DIFIELD)) Q:'DIFIELD  D:$$FLDSINC(DIFILE,FLDS,DIFIELD) ON
"RTN","DIAUTL",8,0)
 Q
"RTN","DIAUTL",9,0)
ON N DIOLD
"RTN","DIAUTL",10,0)
 S DIOLD=$G(^DD(DIFILE,DIFIELD,"AUDIT")) I DIOLD=DIMODE Q  ;It's already on
"RTN","DIAUTL",11,0)
 S D=$P($G(^(0)),U,2) Q:D["C"
"RTN","DIAUTL",12,0)
 I D Q:$P($G(^DD(+D,.01,0)),U,2)["W"  D TURNON(+D,"**",DIMODE) Q  ;Recursive!
"RTN","DIAUTL",13,0)
 S DR="1.1////"_DIMODE,DIE="^DD("_DIFILE_",",DA(1)=DIFILE,DA=DIFIELD
"RTN","DIAUTL",14,0)
 I DA=.001,DIMODE="y" Q  ;CAN'T AUDIT NUMBER FIELD!!
"RTN","DIAUTL",15,0)
 D ^DIE
"RTN","DIAUTL",16,0)
 D IN^DIU0(DIFILE,DIFIELD),DDAUDIT(DIFILE,DIFIELD,1.1,DIOLD,DIMODE)
"RTN","DIAUTL",17,0)
 Q
"RTN","DIAUTL",18,0)
 ;
"RTN","DIAUTL",19,0)
CHANGED(FILE,FLDS,FLAGS,ARRAY,START,END) ;
"RTN","DIAUTL",20,0)
 ;Returns in @ARRAY the list of entries in FILE who had any of the fields in FLDS changed from START to END
"RTN","DIAUTL",21,0)
 ;If FLAGS is "O", the Oldest values are saved in @ARRAY@(entry,field)
"RTN","DIAUTL",22,0)
 N GLO,E,F,T,D,%I
"RTN","DIAUTL",23,0)
 K @ARRAY
"RTN","DIAUTL",24,0)
 S FLAGS=$G(FLAGS)
"RTN","DIAUTL",25,0)
 S GLO=^DIC(FILE,0,"GL")
"RTN","DIAUTL",26,0)
 I '$G(START) S START=0
"RTN","DIAUTL",27,0)
 I '$G(END) D NOW^%DTC S END=%
"RTN","DIAUTL",28,0)
 S T=START D  F  S T=$O(^DIA(FILE,"C",T)) Q:T>END!'T  D
"RTN","DIAUTL",29,0)
 .F D=0:0 S D=$O(^DIA(FILE,"C",T,D)) Q:'D  D
"RTN","DIAUTL",30,0)
 ..S E=$G(^DIA(FILE,D,0)) Q:'E
"RTN","DIAUTL",31,0)
 ..I $D(@ARRAY@(+E)),FLAGS="" Q
"RTN","DIAUTL",32,0)
 ..S F=+$P(E,U,3) Q:'$$FLDSINC(FILE,FLDS,F)
"RTN","DIAUTL",33,0)
 ..I '$D(@(GLO_"+E)")),FLAGS="" Q
"RTN","DIAUTL",34,0)
 ..S @ARRAY@(+E)="" I FLAGS["O",'$D(@ARRAY@(+E,F)) S @ARRAY@(+E,F)=$G(^DIA(FILE,D,2))
"RTN","DIAUTL",35,0)
 Q
"RTN","DIAUTL",36,0)
 ;
"RTN","DIAUTL",37,0)
LAST(DIQGR,ENTRY,FLDS) ;returns DATE^USER who most recently touched any of the FLDS in ENTRY in File DIQGR
"RTN","DIAUTL",38,0)
 N E,F,DILAST,DENTRY
"RTN","DIAUTL",39,0)
 S DILAST="",DENTRY=ENTRY D E
"RTN","DIAUTL",40,0)
 S DENTRY=ENTRY_","
"RTN","DIAUTL",41,0)
 F  S DENTRY=$O(^DIA(DIQGR,"B",DENTRY)) Q:DENTRY-ENTRY  D E
"RTN","DIAUTL",42,0)
 Q DILAST
"RTN","DIAUTL",43,0)
E S E="" F  S E=$O(^DIA(DIQGR,"B",DENTRY,E),-1) Q:'E  I $$FLDSINC(DIQGR,FLDS,+$P($G(^DIA(DIQGR,E,0)),U,3)) D  Q:DENTRY=ENTRY
"RTN","DIAUTL",44,0)
 .N L S L=$P(^DIA(DIQGR,E,0),"^",2)_"^"_$P(^(0),"^",4)
"RTN","DIAUTL",45,0)
 .I L>DILAST S DILAST=L
"RTN","DIAUTL",46,0)
 Q
"RTN","DIAUTL",47,0)
 ;
"RTN","DIAUTL",48,0)
DATE(FILE,FIELD) ;
"RTN","DIAUTL",49,0)
 D VALUE(FILE,FIELD,2) Q
"RTN","DIAUTL",50,0)
 ;
"RTN","DIAUTL",51,0)
USER(FILE,FIELD) ;
"RTN","DIAUTL",52,0)
 D VALUE(FILE,FIELD,4) Q
"RTN","DIAUTL",53,0)
 ;
"RTN","DIAUTL",54,0)
VALUE(FILE,FIELD,TU) ;FILE' can be SubFile
"RTN","DIAUTL",55,0)
 N DIACMP,ENTRY,I
"RTN","DIAUTL",56,0)
 S ENTRY=+$G(D0)
"RTN","DIAUTL",57,0)
 F I=1:1 Q:'$D(^DD(FILE,0,"UP"))  S ENTRY=ENTRY_","_+$G(@("D"_I)),F=^("UP"),FIELD=$O(^DD(F,"SB",FILE,0))_","_FIELD,FILE=F
"RTN","DIAUTL",58,0)
 D PRIOR(FILE,ENTRY,FIELD,.DIACMP)
"RTN","DIAUTL",59,0)
 S D="" F  S D=$O(DIACMP(D),-1) Q:'D  S X=$S($G(TU):$P(^DIA(FILE,D,0),U,TU),1:DIACMP(D)) X DICMX Q:'$D(D)
"RTN","DIAUTL",60,0)
 S X="" Q
"RTN","DIAUTL",61,0)
 ;
"RTN","DIAUTL",62,0)
PRIOR(FILE,ENTRY,FIELD,OUT) ;
"RTN","DIAUTL",63,0)
 N E
"RTN","DIAUTL",64,0)
 F E=0:0 S E=$O(^DIA(FILE,"B",ENTRY,E)) Q:'E  I $P($G(^DIA(FILE,E,0)),U,3)=FIELD,$D(^(2)) S OUT(E)=^(2)
"RTN","DIAUTL",65,0)
 Q
"RTN","DIAUTL",66,0)
 ;
"RTN","DIAUTL",67,0)
FLDSINC(DIQGR,DR,DIAUTLF) ;is DIAUTLF within DR?  -- from 'DIQGQ' routine
"RTN","DIAUTL",68,0)
 I DR=""!'DIAUTLF Q 0
"RTN","DIAUTL",69,0)
 I DR="*" Q 1
"RTN","DIAUTL",70,0)
 N DIAUGOT,DIQGCP,DIQGDD,DIQGXDC,DIQGXDF,DIQGXDI,DIQGXDN,DIQGXDD
"RTN","DIAUTL",71,0)
 S DIQGXDC=0,DIAUGOT=0,DIQGDD=1,DIQGCP="D"
"RTN","DIAUTL",72,0)
 I '$D(DIQGR) N X S X(1)="FILE" G 202
"RTN","DIAUTL",73,0)
 S DIQGXDD="^DD("_DIQGR_")"
"RTN","DIAUTL",74,0)
 S:DIQGR DIQGR=$S(DIQGDD:$$DD(DIQGR),1:$$ROOT^DIQGU(DIQGR,.DA)) I DIQGR="" N X S X(1)="FILE AND IEN COMBINATION" G 202
"RTN","DIAUTL",75,0)
 F DIQGXDI=1:1 S DIQGXDF=$P(DR,";",DIQGXDI),DIQGXDN=$P(DIQGXDF,":") Q:DIQGXDF=""  D RANGE G GOT:DIAUGOT
"RTN","DIAUTL",76,0)
NOGOT Q 0
"RTN","DIAUTL",77,0)
 ;
"RTN","DIAUTL",78,0)
RANGE I DIQGXDC,$P(^DD(+DIQGXDC,.01,0),"^",2)'["W" S:DR="**" DIQGXDN=DIQGXDN_"*" Q:$L(DIQGXDN,"*")'=2  ;multiple
"RTN","DIAUTL",79,0)
 I DIQGXDN'?.N,$L(DIQGXDN,"*")=2,$P(DIQGXDN,"*")]"",$D(@DIQGXDD@("B",$P(DIQGXDN,"*"))) S DIQGXDN=$O(^($P(DIQGXDN,"*"),""))_"*"
"RTN","DIAUTL",80,0)
 I DIQGXDN?1.2"*" S DIAUGOT=1 Q
"RTN","DIAUTL",81,0)
 Q:DIAUTLF<DIQGXDN  I $P(DIQGXDF,":",2)<DIAUTLF Q:DIAUTLF-DIQGXDN
"RTN","DIAUTL",82,0)
 S DIAUGOT=1 Q
"RTN","DIAUTL",83,0)
 ;
"RTN","DIAUTL",84,0)
GOT Q 1
"RTN","DIAUTL",85,0)
 ;
"RTN","DIAUTL",86,0)
DD(X) Q:'$D(^DD(X)) "" Q "^DD("_X_","
"RTN","DIAUTL",87,0)
202 D BLD^DIALOG(202,.X) Q  ;bad parameter
"RTN","DIAUTL",88,0)
 ;
"RTN","DIAUTL",89,0)
 ;
"RTN","DIAUTL",90,0)
GET(FIL,DA,DATE,TMP,FIELD) ;BUILD 'TMP' ARRAY AS OF DATE
"RTN","DIAUTL",91,0)
 ;DA is in IEN format    FIELD, optional, means just look at one field
"RTN","DIAUTL",92,0)
 K @TMP
"RTN","DIAUTL",93,0)
 N DAT,FLD,FILE,F,D,E,B,C,T
"RTN","DIAUTL",94,0)
 S F=FIL,FILE=$$FNO^DILIBF(F),@TMP=FILE,D=+$P(DA,",",$L(DA,",")-1) I 'D S D=DA
"RTN","DIAUTL",95,0)
 I F=FILE F E=0:0 S E=$O(^DIA(FILE,"B",D,E)) Q:'E  D L G Q:$G(@TMP@(F,D_","))
"RTN","DIAUTL",96,0)
SUBFILES S D=D_"," F  S E=D,D=$O(^DIA(FILE,"B",D)) Q:D-E  D
"RTN","DIAUTL",97,0)
 .F E=0:0 S E=$O(^DIA(FILE,"B",D,E)) Q:'E  D L
"RTN","DIAUTL",98,0)
 Q
"RTN","DIAUTL",99,0)
L I $P($G(^DIA(FILE,E,0)),U)'=D Q
"RTN","DIAUTL",100,0)
 S FLD=$P(^(0),U,3),DAT=$P(^(0),U,2),I="",F=FILE
"RTN","DIAUTL",101,0)
 F  S C=$L(FLD,","),I=I_$P(D,",",C)_"," Q:C=1  S T=+FLD G Q:'$D(^DD(F,T,0)) S T=+$P(^(0),U,2) G Q:T'>F!'$D(^DD(T)) S F=T,FLD=$P(FLD,",",2,C)
"RTN","DIAUTL",102,0)
 I FLD=.01,DAT>DATE,$P(^DIA(FILE,E,0),U,5)="A" K @TMP@(F,I) S @TMP@(F,I)=1 Q  ;THAT ENTRY OR SUB-ENTRY DIDN'T EXIST AS OF DATE  2nd level will only be defined in this case
"RTN","DIAUTL",103,0)
 I $G(FIELD),FLD-FIELD!(F-FIL) Q
"RTN","DIAUTL",104,0)
 I '$D(@TMP@(F,I,FLD)) S @TMP@(F,I,FLD)=DAT_U_E Q
"RTN","DIAUTL",105,0)
 I DAT>DATE Q
"RTN","DIAUTL",106,0)
 I @TMP@(F,I,FLD)<DAT S @TMP@(F,I,FLD)=DAT_U_E
"RTN","DIAUTL",107,0)
Q Q
"RTN","DIAUTL",108,0)
 ;
"RTN","DIAUTL",109,0)
DIA(DAT,FILE,X,DIAUTLEX) ;FROM DIQG AND DIQGQ
"RTN","DIAUTL",110,0)
 ;X is a node value from the 'TMP' array built by the GET subroutine, above
"RTN","DIAUTL",111,0)
 ;DAT is the date/time as of which we want the audited value
"RTN","DIAUTL",112,0)
 ;DIAUTLEX may contain "E" if we want external value
"RTN","DIAUTL",113,0)
 I X>DAT Q $$D(2) ;We know what it was before deletion
"RTN","DIAUTL",114,0)
 Q $$D(3)
"RTN","DIAUTL",115,0)
D(ON) S X=$G(^DIA(FILE,+$P(X,U,2),ON)) I $G(DIAUTLEX)["E" Q X
"RTN","DIAUTL",116,0)
 N S,Y S S=$G(^(ON+.1)) I X]"",S="" D  I Y>0 Q Y
"RTN","DIAUTL",117,0)
 .N %DT S %DT="T" D ^%DT
"RTN","DIAUTL",118,0)
 S S=$P(S,U) I S]"" Q S
"RTN","DIAUTL",119,0)
 Q X
"RTN","DIAUTL",120,0)
 ;
"RTN","DIAUTL",121,0)
DDAUDIT(B0,DA,A0,A1,A2) ;B0=File or SubFile,  DA=Field, A0=Attribute #, A1=Old value, A2=New value
"RTN","DIAUTL",122,0)
 N DDA,%,%T,%D,J,B3,I
"RTN","DIAUTL",123,0)
 Q:'$D(DUZ)!'$G(DT)
"RTN","DIAUTL",124,0)
 D IJ^DIUTL(B0) I $G(^DD(J(0),0,"DDA"))'["Y" Q  ;only if DD audit is on
"RTN","DIAUTL",125,0)
 S A0=+$G(A0),A0=$P($G(^DD(0,A0,0)),U)_U_A0
"RTN","DIAUTL",126,0)
 K:$G(A1)="" A1 L:$G(A2)="" A2
"RTN","DIAUTL",127,0)
 D P^DICATTA Q
"RTN","DIENVWRN")
0^^B3680036
"RTN","DIENVWRN",1,0)
DIENVWRN ;IRMFO-SF/FM STAFF-ENVIRONMENT CHECK ROUTINE ;9:36 AM  26 Jan 2004
"RTN","DIENVWRN",2,0)
 ;;22.0;VA FileMan;;Mar 30, 1999
"RTN","DIENVWRN",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIENVWRN",4,0)
 ;
"RTN","DIENVWRN",5,0)
 ; Check XPDENV 0 = Loading; 1 = Installing
"RTN","DIENVWRN",6,0)
 I 'XPDENV Q  ; Loading Distribution - No Check
"RTN","DIENVWRN",7,0)
 ;
"RTN","DIENVWRN",8,0)
INSCHK ; Do Checks During Install Only
"RTN","DIENVWRN",9,0)
 W $C(7)
"RTN","DIENVWRN",10,0)
 D MES^XPDUTL("** Although Queuing is allowed - it is HIGHLY recommended that ALL Users and")
"RTN","DIENVWRN",11,0)
 D MES^XPDUTL("VISTA Background jobs be STOPPED before installation of this patch.  Failure")
"RTN","DIENVWRN",12,0)
 D MES^XPDUTL("to do so may result in 'source routine edited' error(s). Edits will be")
"RTN","DIENVWRN",13,0)
 D MES^XPDUTL("lost and record(s) may be left in an inconsistent state, for example,")
"RTN","DIENVWRN",14,0)
 D MES^XPDUTL("not all Cross-Referencing completed; which in turn may cause FUTURE")
"RTN","DIENVWRN",15,0)
 D MES^XPDUTL("VistA/FileMan Hard Errors or corrupted Data. **")
"RTN","DIENVWRN",16,0)
 ;
"RTN","DIENVWRN",17,0)
TMCHK ; Check to see if TaskMan is still running
"RTN","DIENVWRN",18,0)
 S X=$$TM^%ZTLOAD
"RTN","DIENVWRN",19,0)
 I X,'$D(^%ZTSCH("WAIT")) D
"RTN","DIENVWRN",20,0)
 . W $C(7)
"RTN","DIENVWRN",21,0)
 . D BMES^XPDUTL("* Warning TaskMan Has NOT Been Stopped or Placed in a WAIT State!")
"RTN","DIENVWRN",22,0)
 ;
"RTN","DIENVWRN",23,0)
LINH ; Check to see if Logons are Inhibited
"RTN","DIENVWRN",24,0)
 D GETENV^%ZOSV  ; $P(Y,"^",2) = Installing Volume
"RTN","DIENVWRN",25,0)
 S X=+$G(^%ZIS(14.5,"LOGON",$P(Y,"^",2)))
"RTN","DIENVWRN",26,0)
 I 'X D
"RTN","DIENVWRN",27,0)
 . W $C(7)
"RTN","DIENVWRN",28,0)
 . D BMES^XPDUTL("* Warning Logons are NOT Inhibited!")
"RTN","DIENVWRN",29,0)
 Q
"RTN","DIKZ")
0^1^B29541347
"RTN","DIKZ",1,0)
DIKZ ;SFISC/XAK-XREF COMPILER ;7JUN2004
"RTN","DIKZ",2,0)
 ;;22.0;VA FileMan;**140**;Mar 30, 1999
"RTN","DIKZ",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIKZ",4,0)
 I $G(DUZ(0))'="@" W $C(7),$$EZBLD^DIALOG(101) Q
"RTN","DIKZ",5,0)
EN1 N DIKJ,%X D:'$D(DISYS) OS^DII
"RTN","DIKZ",6,0)
 I '$D(^DD("OS",DISYS,"ZS")) W $C(7),$$EZBLD^DIALOG(820) Q
"RTN","DIKZ",7,0)
 S U="^" S:'$G(DTIME) DTIME=300
"RTN","DIKZ",8,0)
 D SIZ^DIPZ0(8036) G:$D(DTOUT)!($D(DUOUT))!('X) Q1 S DMAX=X
"RTN","DIKZ",9,0)
FILE K DIC S DMAX=X,DIC="^DIC(",DIC(0)="AEQ" D ^DIC G Q1:Y'>0 N DIPZ S DIPZ=+Y
"RTN","DIKZ",10,0)
 D RNM^DIPZ0(8036) G:$D(DTOUT)!($D(DUOUT))!(X="") Q1 S DNM=X
"RTN","DIKZ",11,0)
 W ! S DIR(0)="Y",DIR("A")=$$EZBLD^DIALOG(8020) D ^DIR K DIR G:'Y!($D(DIRUT)) Q1
"RTN","DIKZ",12,0)
 S X=DNM,Y=DIPZ K DIPZ
"RTN","DIKZ",13,0)
EN ;
"RTN","DIKZ",14,0)
 S Y(1)=$$EZBLD^DIALOG(8036),Y(3)=Y D BLD^DIALOG(8024,.Y,"","DIR") W:'$G(DIKZS) !!,DIR,! K Y(1),Y(3)
"RTN","DIKZ",15,0)
 K ^UTILITY($J),^UTILITY("DIK",$J) N DIK,DIFILENO
"RTN","DIKZ",16,0)
 S DNM=X,(DH,DIFILENO)=+Y I $D(^DIC(+Y,0,"GL")) S DIK2=^("GL")
"RTN","DIKZ",17,0)
 I '$D(DIK2)!(DMAX<2400) G Q
"RTN","DIKZ",18,0)
 S X=DH D A^DIU21,WAIT^DICD:'$G(DIKZS),DT^DICRW
"RTN","DIKZ",19,0)
 S (DRN,DIKZQ,T)=0,DMAX=DMAX-100
"RTN","DIKZ",20,0)
 ;
"RTN","DIKZ",21,0)
 ;Load indexes defined in Index file
"RTN","DIKZ",22,0)
 N DIXRLIST,DIKMF
"RTN","DIKZ",23,0)
 K ^TMP("DIKC",$J)
"RTN","DIKZ",24,0)
 D LOADALL^DIKC1(DIFILENO,"KS","R","",$NA(^TMP("DIKC",$J)),"",.DIKMF)
"RTN","DIKZ",25,0)
 ;
"RTN","DIKZ",26,0)
 ; compile kill logic
"RTN","DIKZ",27,0)
 S (DIKA,A)=1,X=2,DIKVR="DIKILL",DIK=DIK2
"RTN","DIKZ",28,0)
 D Q2,NEWR S ^UTILITY($J,0,3)=" S DIKZK="_X
"RTN","DIKZ",29,0)
 S DIKGO="^"_DNM_1 ;starting ROUTINE name
"RTN","DIKZ",30,0)
 D ^DIKZ0 G:DIKZQ Q D RTE
"RTN","DIKZ",31,0)
 ;
"RTN","DIKZ",32,0)
 ; compile set logic
"RTN","DIKZ",33,0)
 S (DIKA,A)=1,X=1,DIKVR="DISET",DIK=DIK2
"RTN","DIKZ",34,0)
 D Q2,NEWR S ^UTILITY($J,0,3)=" S DIKZK="_X
"RTN","DIKZ",35,0)
 S DIKGO=DIKGO_",^"_DNM_DRN
"RTN","DIKZ",36,0)
 D ^DIKZ0 G:DIKZQ Q D RTE
"RTN","DIKZ",37,0)
 ;
"RTN","DIKZ",38,0)
 ; compile driver code
"RTN","DIKZ",39,0)
 D Q2,^DIKZ1
"RTN","DIKZ",40,0)
 ;
"RTN","DIKZ",41,0)
 ; finish up
"RTN","DIKZ",42,0)
 S:'DIKZQ ^DD(DIFILENO,0,"DIKOLD")=DNM
"RTN","DIKZ",43,0)
Q I DIKZQ S X=DH(1) D A^DIU21
"RTN","DIKZ",44,0)
Q1 K DH,X,Y,DIK4,DIKQ,DIKC,T,DV,DIK8,DU,DW,DW1,DIKGO,DRN,DNM,DTOUT,DIRUT,DIROUT,DUOUT,DIC,A,%,%H,%Y
"RTN","DIKZ",45,0)
 K DIKVR,DIK6,DIKA,DIKR,DMAX,DIK2,DIKCT,DIK1,DIK0,^UTILITY($J),^("DIK"),DIK,DIKZQ,DIKZZ,DIKZZ1,DIKZOVFL
"RTN","DIKZ",46,0)
 K ^TMP("DIKC",$J)
"RTN","DIKZ",47,0)
Q2 K DIKRT,DIKLW,DIKL2
"RTN","DIKZ",48,0)
 Q
"RTN","DIKZ",49,0)
SV ; transfer the accumulated code in ^UTILITY($J,#) to ^UTILITY($J,0,#)
"RTN","DIKZ",50,0)
 ; (the routine buffer) and call SAVE to flush the buffer into a routine
"RTN","DIKZ",51,0)
 ; whenever it's full. Flush the buffer one more time when done.
"RTN","DIKZ",52,0)
 S DNM(1)=DNM_DRN
"RTN","DIKZ",53,0)
 F DIKR=0:0 S DIKR=$O(^UTILITY($J,DIKR)) Q:DIKR'>0  S %=^(DIKR) K ^(DIKR) D:T+$L(%)>DMAX  S ^UTILITY($J,0,DIKR)=%,T=T+$L(%)+2
"RTN","DIKZ",54,0)
 . N DIKZMORE S DIKZMORE=1 D SAVE
"RTN","DIKZ",55,0)
 D SAVE
"RTN","DIKZ",56,0)
 Q
"RTN","DIKZ",57,0)
SAVE ; save the accumulated code in ^UTILITY($J,0,#) as a routine
"RTN","DIKZ",58,0)
 I DIKR,$E($P(%," ",2))="." F  D  Q:$E($P(%," ",2))'="."
"RTN","DIKZ",59,0)
 . S ^UTILITY($J,DIKR)=%
"RTN","DIKZ",60,0)
 . S DIKR=$O(^UTILITY($J,0,DIKR),-1),%=^(DIKR) K ^(DIKR)
"RTN","DIKZ",61,0)
 I $D(DIKLW),'DIKR S ^UTILITY($J,0,997)=" G:'$D(DIKLM) "_$C(64+DIKCT)_$S(DNM_DRN'=DNM(1):"^"_DNM(1),1:"")_" Q:$D("_DIKVR_")"
"RTN","DIKZ",62,0)
 I $D(DIKLW),DIKR S ^UTILITY($J,0,998)=" G ^"_DNM_(DRN+1)
"RTN","DIKZ",63,0)
 S ^UTILITY($J,0,999)="END "_$S($D(DIKRT)&'DIKR:"Q",1:"G "_$S(DIKR&($D(DIKLW)):"END",1:"")_U_DNM_(DRN+1))
"RTN","DIKZ",64,0)
 N X,DIR S X=DNM_DRN X ^DD("OS",DISYS,"ZS") S X(1)=X D BLD^DIALOG(8025,.X,"","DIR") W:'$G(DIKZS) !,DIR S:$G(DIKZRLA)]"" @DIKZRLA@(DNM_DRN)="",DIKZRLAF=1
"RTN","DIKZ",65,0)
 D NEWR:'$D(DIKRT)!$G(DIKZMORE) Q:DIKZQ  S ^DD(DH,0,"DIK")=DNM K DIKL2
"RTN","DIKZ",66,0)
 Q
"RTN","DIKZ",67,0)
NEWR ;
"RTN","DIKZ",68,0)
 I '$D(DIKRT),T,$D(%),T+$L(%)>DMAX S DIKZDH=+$P(^UTILITY($J,0,1),"#",2)
"RTN","DIKZ",69,0)
 K ^UTILITY($J,0) S DIKR=4,T=0,DRN=DRN+1 I $L(DNM_DRN)>8 W:'$G(DIKZS) $C(7),!,DNM_DRN_$$EZBLD^DIALOG(1503) S:$G(DIKZRLA)]"" DIKZRLAF=0 S DIKZQ=1 Q
"RTN","DIKZ",70,0)
 S ^UTILITY($J,0,1)=DNM_DRN_" ; COMPILED XREF FOR FILE #"_$S($D(DIKZDH):DIKZDH,1:DH)_" ; "_$E(DT,4,5)_"/"_$E(DT,6,7)_"/"_$E(DT,2,3),^(2)=" ; "
"RTN","DIKZ",71,0)
 K DIKZDH Q
"RTN","DIKZ",72,0)
RTE ;
"RTN","DIKZ",73,0)
 N DIKFIL,DIKSUB,DIKLIST,DIKP
"RTN","DIKZ",74,0)
 ;Build DIKSUB(file)=subfile1,subfile2,... list
"RTN","DIKZ",75,0)
 S DIKFIL=0 F  S DIKFIL=$O(DIK(X,DIKFIL)) Q:'DIKFIL  D
"RTN","DIKZ",76,0)
 . S DIKSUB=0 F  S DIKSUB=$O(^DD(DIKFIL,"SB",DIKSUB)) Q:'DIKSUB  D
"RTN","DIKZ",77,0)
 .. S:$D(DIK(X,DIKSUB))#2 DIKSUB(DIKFIL)=$G(DIKSUB(DIKFIL))_DIKSUB_","
"RTN","DIKZ",78,0)
 ;
"RTN","DIKZ",79,0)
 ;Build DIKLIST(file)=subfile1,subfile2,...
"RTN","DIKZ",80,0)
 M DIKLIST=DIKSUB
"RTN","DIKZ",81,0)
 S DIKFIL=0 F  S DIKFIL=$O(DIKSUB(DIKFIL)) Q:'DIKFIL  D
"RTN","DIKZ",82,0)
 . S DIKP=0
"RTN","DIKZ",83,0)
 . F  D  Q:DIKP'<($L(DIKLIST(DIKFIL),",")-1)
"RTN","DIKZ",84,0)
 .. F DIKP=DIKP+1:1:$L(DIKLIST(DIKFIL),",")-1 D
"RTN","DIKZ",85,0)
 ... S DIKSUB=$P(DIKLIST(DIKFIL),",",DIKP)
"RTN","DIKZ",86,0)
 ... S DIKLIST(DIKFIL)=DIKLIST(DIKFIL)_$G(DIKSUB(DIKSUB))
"RTN","DIKZ",87,0)
 K DIKSUB
"RTN","DIKZ",88,0)
 ;
"RTN","DIKZ",89,0)
 ;Convert file numbers in DIKLIST to routine list
"RTN","DIKZ",90,0)
 S DIKFIL=0 F  S DIKFIL=$O(DIKLIST(DIKFIL)) Q:'DIKFIL  D
"RTN","DIKZ",91,0)
 . S $E(DIKLIST(DIKFIL),$L(DIKLIST(DIKFIL)))=""
"RTN","DIKZ",92,0)
 . S DIKLIST(DIKFIL)=DIKFIL_","_DIKLIST(DIKFIL)
"RTN","DIKZ",93,0)
 . F DIKP=1:1:$L(DIKLIST(DIKFIL),",") D
"RTN","DIKZ",94,0)
 .. S DIKSUB=$P(DIKLIST(DIKFIL),",",DIKP)
"RTN","DIKZ",95,0)
 .. S $P(DIKLIST(DIKFIL),",",DIKP)=DIK(X,DIKSUB)
"RTN","DIKZ",96,0)
 ;
"RTN","DIKZ",97,0)
 ;Move list to DIK
"RTN","DIKZ",98,0)
 M DIK(X)=DIKLIST
"RTN","DIKZ",99,0)
 K DIKFIL,DIKLIST,DIKP
"RTN","DIKZ",100,0)
 S DIKRT=1,A=A-1,DH=DH(1) G SV
"RTN","DIKZ",101,0)
 ;
"RTN","DIKZ",102,0)
EN2(Y,DIKZFLGS,X,DMAX,DIKZRLA,DIKZZMSG) ;Silent or Talking with parameter passing
"RTN","DIKZ",103,0)
 ;and optionally return list of routines built and if successful
"RTN","DIKZ",104,0)
 ;FILE#,FLAGS,ROUTINE,RTNMAXSIZE,RTNLISTARRAY,MSGARRAY
"RTN","DIKZ",105,0)
 ;Y=FILE NUMBER (required)
"RTN","DIKZ",106,0)
 ;FLAGS="T"alk (optional)
"RTN","DIKZ",107,0)
 ;X=ROUTINE NAME (required)
"RTN","DIKZ",108,0)
 ;DMAX=ROUTINE SIZE (optional)
"RTN","DIKZ",109,0)
 ;DIKZRLA=ROUTINE LIST ARRAY, by value (optional)
"RTN","DIKZ",110,0)
 ;DIKZZMSG=MESSAGE ARRAY (optional) (default ^TMP)
"RTN","DIKZ",111,0)
 ;*
"RTN","DIKZ",112,0)
 ;DIKZS will be used to indicate "silent" if set to 1
"RTN","DIKZ",113,0)
 ;Write statements are made conditional, if not "silent"
"RTN","DIKZ",114,0)
 ;*
"RTN","DIKZ",115,0)
 N DIKZS,DNM,DIQUIET,DIKZRIEN,DIKZRLAZ,%X,DIKJ,DIR,DIKZRLAF,DK1
"RTN","DIKZ",116,0)
 N DIK,DIC,%I,DICS
"RTN","DIKZ",117,0)
 S DIKZS=$G(DIKZFLGS)'["T"
"RTN","DIKZ",118,0)
 S:DIKZS DIQUIET=1
"RTN","DIKZ",119,0)
 I '$D(DIFM) N DIFM S DIFM=1 D
"RTN","DIKZ",120,0)
 .N Y,DIKZFLGS,X,DMAX,DIKZRLA,DIKZS
"RTN","DIKZ",121,0)
 .D INIZE^DIEFU
"RTN","DIKZ",122,0)
 I $G(Y)'>0 D BLD^DIALOG(1700,"File Number missing or invalid") G EN2E
"RTN","DIKZ",123,0)
 I '$D(^DD(Y,0)) D BLD^DIALOG(1700,"File Number: "_Y_" Invalid") G EN2E
"RTN","DIKZ",124,0)
 I $G(X)']"" D BLD^DIALOG(1700,"Routine name missing") G EN2E
"RTN","DIKZ",125,0)
 I X'?1U.NU&(X'?1"%"1U.NU) D BLD^DIALOG(1700,"Routine name invalid") G EN2E
"RTN","DIKZ",126,0)
 I $L(X)>7 D BLD^DIALOG(1700,"Routine name too long") G EN2E
"RTN","DIKZ",127,0)
 S DIKZRLA=$G(DIKZRLA,"DIKZRLAZ"),DIKZRIEN=Y
"RTN","DIKZ",128,0)
 S:DIKZRLA="" DIKZRLA="DIKZRLAZ" S:$G(DMAX)<2500!($G(DMAX)>^DD("ROU")) DMAX=^DD("ROU")
"RTN","DIKZ",129,0)
 S DIKZRLAF=""
"RTN","DIKZ",130,0)
 K @DIKZRLA
"RTN","DIKZ",131,0)
 D EN
"RTN","DIKZ",132,0)
 G:'DIKZS!(DIKZRLAF) EN2E
"RTN","DIKZ",133,0)
 D BLD^DIALOG(1700,"Compiling Cross-references (FILE#:"_DIKZRIEN_")"_$S(DIKZRLAF=0:", routine name too long",1:""))
"RTN","DIKZ",134,0)
EN2E I 'DIKZS D MSG^DIALOG() Q
"RTN","DIKZ",135,0)
 I $G(DIKZZMSG)]"" D CALLOUT^DIEFU(DIKZZMSG)
"RTN","DIKZ",136,0)
 Q
"RTN","DIKZ",137,0)
 ;
"RTN","DIKZ",138,0)
 ;DIALOG #101    'only those with programmer's access'
"RTN","DIKZ",139,0)
 ;       #820    'no way to save routines on the system'
"RTN","DIKZ",140,0)
 ;       #8020   'Should the compilation run now?'
"RTN","DIKZ",141,0)
 ;       #8024   'Compiling template name Input template of file n'
"RTN","DIKZ",142,0)
 ;       #8036   'Cross-References'
"RTN","DIKZ",143,0)
 ;       #8025   'Routine filed'
"RTN","DIKZ",144,0)
 ;       #1503   'routine name is too long...'
"RTN","DIKZ0")
0^2^B25444668
"RTN","DIKZ0",1,0)
DIKZ0 ;SFISC/XAK-XREF COMPILER ;23AUG2004
"RTN","DIKZ0",2,0)
 ;;22.0;VA FileMan;**140**;Mar 30, 1999
"RTN","DIKZ0",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIKZ0",4,0)
 S DIK0=" I X'=""""" D DD^DIK,A,SD Q:DIKZQ
"RTN","DIKZ0",5,0)
RET I $D(DK1) S A=A+1,DIKA=1,DH=0 F  S DH=$O(DK1(DH)) Q:DH'>0  D E^DIK
"RTN","DIKZ0",6,0)
 S:DH="" DH=-1 I $D(DK1) K DK1 D SD Q:DIKZQ  G RET
"RTN","DIKZ0",7,0)
 Q
"RTN","DIKZ0",8,0)
SD F DH=DH(1):0 S DH=$O(DU(DH)) Q:DH'>0  S:$D(^DD(DH,"SB")) DK1(DH)="" D DD1^DIK,0 Q:DIKZQ  S:$D(^DD(DH,"IX"))!$D(^TMP("DIKC",$J,DH)) DIK(X,DH)="A1^"_DNM_DRN K:'$D(^DD(DH,"IX"))&'$D(^TMP("DIKC",$J,DH)) DIK(X,DH) K DU(DH)
"RTN","DIKZ0",9,0)
 Q
"RTN","DIKZ0",10,0)
0 ;
"RTN","DIKZ0",11,0)
 D SV^DIKZ Q:DIKZQ  S DIK1=""
"RTN","DIKZ0",12,0)
 I $D(DIKA) S DIK1=" S DA("_A_")=DA"_$S(A=1:"",1:"("_(A-1)_")")
"RTN","DIKZ0",13,0)
 F DIKL2=A-1:-1:1 S DIK1=DIK1_" S DA("_DIKL2_")=0"
"RTN","DIKZ0",14,0)
 S ^UTILITY($J,DIKR+1)=DIK1_" S DA=0",DIKR=DIKR+2,^(DIKR)="A1 ;"
"RTN","DIKZ0",15,0)
 D ^DIKZ2 K DIKA S DIKLW=1
"RTN","DIKZ0",16,0)
 S DIKR=DIKR+1,DIK=DIK2_DIK8(DH),^UTILITY($J,DIKR)=A_" ;",DIKR=DIKR+1
"RTN","DIKZ0",17,0)
A ;
"RTN","DIKZ0",18,0)
 K DIK6 F DIKQ=0:0 S DIKQ=$O(^UTILITY("DIK",$J,DH,DIKQ)) Q:DIKQ'>0  I $G(DIKVR)="DISET"!(DIKQ'=.01) S %=^(DIKQ) S:+%'=% %=""""_%_"""" D PUT
"RTN","DIKZ0",19,0)
 I $G(DIKVR)="DIKILL",$D(^UTILITY("DIK",$J,DH,.01)) S DIKQ=.01,%=^(.01) S:+%'=% %=""""_%_"""" D PUT
"RTN","DIKZ0",20,0)
 D INDEX
"RTN","DIKZ0",21,0)
 K ^UTILITY("DIK",$J),DIK6
"RTN","DIKZ0",22,0)
 Q
"RTN","DIKZ0",23,0)
PUT N DIKSET I '$D(DIK6(%)) S ^UTILITY($J,DIKR)=" S DIKZ("_%_")=$G("_DIK_"DA,"_%_"))",DIK6(%)=""
"RTN","DIKZ0",24,0)
 S DIKR=DIKR+1,(DIKSET,^UTILITY($J,DIKR))=" "_$P(^UTILITY("DIK",$J,DH,DIKQ,0),"^(X)")_"DIKZ("_%_")"_$P(^(0),"^(X)",2,9)
"RTN","DIKZ0",25,0)
 F DIKC=0:0 S DIKC=$O(^UTILITY("DIK",$J,DH,DIKQ,DIKC)) S DIKR=DIKR+1 Q:DIKC'>0  D
"RTN","DIKZ0",26,0)
 .S %=^(DIKC) S:$O(^(0))'=DIKC ^UTILITY($J,DIKR)=DIKSET,DIKR=DIKR+1
"RTN","DIKZ0",27,0)
 .I %["Q:"!(%[" Q") K DIK6 S ^UTILITY($J,DIKR)=DIK0_" X ^DD("_DH_","_DIKQ_",1,"_DIKC_","_X_")" Q
"RTN","DIKZ0",28,0)
 .I %["D RCR" K DIK6 S ^UTILITY($J,DIKR)=DIK0_" D",DIKR=DIKR+2,^(DIKR-1)=" .N DIK,DIV,DIU,DIN",^UTILITY($J,DIKR)=" ."_^UTILITY("DIK",$J,DH,DIKQ,DIKC,0) Q
"RTN","DIKZ0",29,0)
 .I %["S XMB=" S ^UTILITY($J,DIKR)=DIK0_",$D(DIK(0)),DIK(0)[""B"" S DIKZR="_DIKC_",DIKZZ="_DIKQ_" D BUL^"_DNM,DIKR=DIKR+1,^UTILITY($J,DIKR)=DIK0_",'$D(DIKOZ) "_$S($L(%)<225:%,1:"X ^DD("_DH_","_DIKQ_",1,"_DIKC_","_X_")") Q
"RTN","DIKZ0",30,0)
 .S ^UTILITY($J,DIKR)=DIK0_" "_$S(%[" AUDIT":"S DH="_DH_",DV="_DIKQ_",DU="_A_" ",1:"")_%_$S(%[" AUDIT":"^DIK1",1:"")
"RTN","DIKZ0",31,0)
 Q
"RTN","DIKZ0",32,0)
 ;
"RTN","DIKZ0",33,0)
 ;
"RTN","DIKZ0",34,0)
INDEX ;Loop through ^TMP and pick up cross references for file DH
"RTN","DIKZ0",35,0)
 N DIKO,DIKCTAG
"RTN","DIKZ0",36,0)
 S DIKCTAG=0
"RTN","DIKZ0",37,0)
 ;
"RTN","DIKZ0",38,0)
 ;Build code for each xref
"RTN","DIKZ0",39,0)
 S DIKC=0 F  S DIKC=$O(^TMP("DIKC",$J,DH,DIKC)) Q:'DIKC  D GETINDEX
"RTN","DIKZ0",40,0)
 D:DIKCTAG LINE("CR"_(DIKCTAG+1)_" K X")
"RTN","DIKZ0",41,0)
 Q
"RTN","DIKZ0",42,0)
 ;
"RTN","DIKZ0",43,0)
GETINDEX ;Get code for one index DIKC in file DH
"RTN","DIKZ0",44,0)
 I DIKVR="DIKILL",$G(^TMP("DIKC",$J,DH,DIKC,"K"))?."^" Q
"RTN","DIKZ0",45,0)
 I DIKVR="DISET",$G(^TMP("DIKC",$J,DH,DIKC,"S"))?."^" Q
"RTN","DIKZ0",46,0)
 ;
"RTN","DIKZ0",47,0)
 N DIKF,DIKCOD,DIKO,DIK01
"RTN","DIKZ0",48,0)
 S DIKCTAG=DIKCTAG+1
"RTN","DIKZ0",49,0)
 D LINE("CR"_DIKCTAG_" S DIXR="_DIKC)
"RTN","DIKZ0",50,0)
 ;
"RTN","DIKZ0",51,0)
 ;Build code to set X array
"RTN","DIKZ0",52,0)
 S DIKF=$O(^TMP("DIKC",$J,DH,DIKC,0)) Q:'DIKF
"RTN","DIKZ0",53,0)
 D LINE(" K X")
"RTN","DIKZ0",54,0)
 S DIKO=0 F  S DIKO=$O(^TMP("DIKC",$J,DH,DIKC,DIKO)) Q:'DIKO  D XARR
"RTN","DIKZ0",55,0)
 D LINE(" S X=$G(X("_DIKF_"))")
"RTN","DIKZ0",56,0)
 ;
"RTN","DIKZ0",57,0)
 ;Build code to check for null subscripts
"RTN","DIKZ0",58,0)
 S DIKCOD="",DIKO=0
"RTN","DIKZ0",59,0)
 F  S DIKO=$O(^TMP("DIKC",$J,DH,DIKC,DIKO)) Q:'DIKO  D:$G(^(DIKO,"SS"))
"RTN","DIKZ0",60,0)
 . S DIKCOD=DIKCOD_$E(",",DIKCOD]"")_"$G(X("_DIKO_"))]"""""
"RTN","DIKZ0",61,0)
 D LINE($S(DIKCOD]"":" I "_DIKCOD_" D",1:" D")) ;**GFT -- NOIS ISL-0604-50146 **
"RTN","DIKZ0",62,0)
 D LINE(" . K X1,X2 M X1=X,X2=X")
"RTN","DIKZ0",63,0)
 ;
"RTN","DIKZ0",64,0)
 I DIKVR="DIKILL" D
"RTN","DIKZ0",65,0)
 . ;Adjust .01 values X2 array if we're deleting a record
"RTN","DIKZ0",66,0)
 . I $D(DIK01) D
"RTN","DIKZ0",67,0)
 ..S DIKCOD="",DIKO=0 F  S DIKO=$O(DIK01(DIKO)) Q:'DIKO  D  ;**GFT -- NOIS ISL-0604-50146 **
"RTN","DIKZ0",68,0)
 ... S DIKCOD=DIKCOD_$E(",",DIKCOD]"")_"X2("_DIKO_")"
"RTN","DIKZ0",69,0)
 .. Q:DIKCOD=""
"RTN","DIKZ0",70,0)
 .. S:DIKF=$O(DIK01(0)) DIKCOD="X2,"_DIKCOD
"RTN","DIKZ0",71,0)
 .. S:DIKCOD["," DIKCOD="("_DIKCOD_")"
"RTN","DIKZ0",72,0)
 .. D LINE(" . S:$D(DIKIL) "_DIKCOD_"=""""")
"RTN","DIKZ0",73,0)
 . ;
"RTN","DIKZ0",74,0)
 . ;Get kill condition code
"RTN","DIKZ0",75,0)
 . S DIKCOD=$G(^TMP("DIKC",$J,DH,DIKC,"KC"))
"RTN","DIKZ0",76,0)
 . I DIKCOD'?."^" D
"RTN","DIKZ0",77,0)
 .. D LINE(" . N DIKXARR M DIKXARR=X S DIKCOND=1")
"RTN","DIKZ0",78,0)
 .. D LINE(" . "_DIKCOD)
"RTN","DIKZ0",79,0)
 .. D LINE(" . S DIKCOND=$G(X) K X M X=DIKXARR")
"RTN","DIKZ0",80,0)
 .. D LINE(" . Q:'DIKCOND")
"RTN","DIKZ0",81,0)
 . ;Get kill logic
"RTN","DIKZ0",82,0)
 . D LINE(" . "_$G(^TMP("DIKC",$J,DH,DIKC,"K")))
"RTN","DIKZ0",83,0)
 ;
"RTN","DIKZ0",84,0)
 I DIKVR="DISET" D
"RTN","DIKZ0",85,0)
 . ;Get set condition code
"RTN","DIKZ0",86,0)
 . S DIKCOD=$G(^TMP("DIKC",$J,DH,DIKC,"SC"))
"RTN","DIKZ0",87,0)
 . I DIKCOD'?."^" D
"RTN","DIKZ0",88,0)
 .. D LINE(" . N DIKXARR M DIKXARR=X S DIKCOND=1")
"RTN","DIKZ0",89,0)
 .. D LINE(" . "_DIKCOD)
"RTN","DIKZ0",90,0)
 .. D LINE(" . S DIKCOND=$G(X) K X M X=DIKXARR")
"RTN","DIKZ0",91,0)
 .. D LINE(" . Q:'DIKCOND")
"RTN","DIKZ0",92,0)
 . ;Get set logic
"RTN","DIKZ0",93,0)
 . D LINE(" . "_$G(^TMP("DIKC",$J,DH,DIKC,"S")))
"RTN","DIKZ0",94,0)
 K DIK6 Q
"RTN","DIKZ0",95,0)
 ;
"RTN","DIKZ0",96,0)
XARR ;Build code to set X array
"RTN","DIKZ0",97,0)
 ;Also return DIK01(order#)="" if crv is .01 field
"RTN","DIKZ0",98,0)
 N CODE,NODE,REF,LINE,TRANS
"RTN","DIKZ0",99,0)
 ;K DIK01
"RTN","DIKZ0",100,0)
 ;
"RTN","DIKZ0",101,0)
 ;Build data extraction code
"RTN","DIKZ0",102,0)
 S CODE=$G(^TMP("DIKC",$J,DH,DIKC,DIKO)) Q:CODE?."^"
"RTN","DIKZ0",103,0)
 I $D(^TMP("DIKC",$J,DH,DIKC,DIKO,"F"))#2 D
"RTN","DIKZ0",104,0)
 . S DIK01(DIKO)=""
"RTN","DIKZ0",105,0)
 . S REF=$P($P(CODE,",",1,$L(CODE,",")-2),"(",2,999)
"RTN","DIKZ0",106,0)
 . S NODE=$P($P(REF,",",$L(REF,",")),"))")
"RTN","DIKZ0",107,0)
 . I '$D(DIK6(NODE)) D
"RTN","DIKZ0",108,0)
 .. D LINE(" S DIKZ("_NODE_")="_REF)
"RTN","DIKZ0",109,0)
 .. S DIK6(NODE)=""
"RTN","DIKZ0",110,0)
 . S LINE=" "_$P(CODE,REF)_"DIKZ("_NODE_")"_$P(CODE,REF,2,999)
"RTN","DIKZ0",111,0)
 E  S LINE=" "_CODE
"RTN","DIKZ0",112,0)
 ;
"RTN","DIKZ0",113,0)
 S TRANS=$G(^TMP("DIKC",$J,DH,DIKC,DIKO,"T"))
"RTN","DIKZ0",114,0)
 I TRANS'?."^" D
"RTN","DIKZ0",115,0)
 . D LINE(LINE)
"RTN","DIKZ0",116,0)
 . D DOTLINE(" I $G(X)]"""" "_TRANS)
"RTN","DIKZ0",117,0)
 . D LINE(" S:$D(X)#2 X("_DIKO_")=X")
"RTN","DIKZ0",118,0)
 E  I $G(NODE)]"",LINE?1" S X=".E D
"RTN","DIKZ0",119,0)
 . D LINE(" S X("_DIKO_")"_$E(LINE,5,999))
"RTN","DIKZ0",120,0)
 E  D
"RTN","DIKZ0",121,0)
 . D LINE(LINE)
"RTN","DIKZ0",122,0)
 . D LINE(" S:$D(X)#2 X("_DIKO_")=X")
"RTN","DIKZ0",123,0)
 Q
"RTN","DIKZ0",124,0)
 ;
"RTN","DIKZ0",125,0)
DOTLINE(CODE) ;Add code to ^UTILITY. If the code looks like it contains
"RTN","DIKZ0",126,0)
 ;a Quit command, put the code under a do-dot structure.
"RTN","DIKZ0",127,0)
 I CODE[" Q"!(CODE["Q:") D
"RTN","DIKZ0",128,0)
 . D LINE(" D")
"RTN","DIKZ0",129,0)
 . D LINE(" . "_CODE)
"RTN","DIKZ0",130,0)
 E  D LINE(CODE)
"RTN","DIKZ0",131,0)
 Q
"RTN","DIKZ0",132,0)
 ;
"RTN","DIKZ0",133,0)
LINE(CODE) ;Add line of code to ^UTILITY, increment DIKR
"RTN","DIKZ0",134,0)
 S ^UTILITY($J,DIKR)=CODE
"RTN","DIKZ0",135,0)
 S DIKR=DIKR+1
"RTN","DIKZ0",136,0)
 Q
"RTN","DIPOS140")
0^^B1796599
"RTN","DIPOS140",1,0)
DIPOS140 ;SFISC/SO- POST INSTAL DI*22*140 RE-COMPILE XREF;8:50 AM  18 Aug 2004
"RTN","DIPOS140",2,0)
 ;;22.0;VA FileMan;*140*;Mar 30, 1999
"RTN","DIPOS140",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIPOS140",4,0)
 D MES^XPDUTL("Begin re-compile of cross references...")
"RTN","DIPOS140",5,0)
 N FILE S FILE=1.99999
"RTN","DIPOS140",6,0)
 F  S FILE=$O(^DIC(FILE)) Q:'FILE  D
"RTN","DIPOS140",7,0)
 . I '$D(^DD(FILE,0,"DIK")) Q  ;File does not have compiled xref
"RTN","DIPOS140",8,0)
 . N GL,X,Y,DMAX,DIQUITE
"RTN","DIPOS140",9,0)
 . I '$D(^DIC(FILE,0,"GL")) Q  ;Missing global location
"RTN","DIPOS140",10,0)
 . S GL=^("GL")_"0)" ;Naked set in previous line
"RTN","DIPOS140",11,0)
 . I '$D(@GL) Q  ;No file header node
"RTN","DIPOS140",12,0)
 . I +$P(@GL,U,2)'=FILE Q  ;File node number not correct
"RTN","DIPOS140",13,0)
 . D MES^XPDUTL("Re-compiling cross reference for: "_$$GET1^DIQ(1,FILE_",",.01)_"(#"_FILE_")")
"RTN","DIPOS140",14,0)
 . S DMAX=^DD("ROU")
"RTN","DIPOS140",15,0)
 . S X=^DD(FILE,0,"DIK")
"RTN","DIPOS140",16,0)
 . S Y=FILE
"RTN","DIPOS140",17,0)
 . D EN^DIKZ
"RTN","DIPOS140",18,0)
 . Q
"RTN","DIPOS140",19,0)
 D MES^XPDUTL("Finished re-compile of cross refereneces.")
"RTN","DIPOS140",20,0)
 Q
"VER")
8^22.0
**END**
**END**
