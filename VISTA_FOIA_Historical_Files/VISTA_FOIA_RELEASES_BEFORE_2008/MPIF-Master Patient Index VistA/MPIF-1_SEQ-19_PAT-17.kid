Released MPIF*1*17 SEQ #19
Extracted from mail message
**KIDS**:MPIF*1.0*17^

**INSTALL NAME**
MPIF*1.0*17
"BLD",1395,0)
MPIF*1.0*17^MASTER PATIENT INDEX VISTA^0^3020208^y
"BLD",1395,1,0)
^^3^3^3020208^
"BLD",1395,1,1,0)
Selection screen and Misc changes
"BLD",1395,1,2,0)
Refer to patch MPIF*1.0*17 in the FORUM Patch Module for a complete
"BLD",1395,1,3,0)
description.
"BLD",1395,4,0)
^9.64PA^^
"BLD",1395,"ABNS",0)
^9.66A^^
"BLD",1395,"ABPKG")
n^n^
"BLD",1395,"KRN",0)
^9.67PA^8989.52^19
"BLD",1395,"KRN",.4,0)
.4
"BLD",1395,"KRN",.401,0)
.401
"BLD",1395,"KRN",.402,0)
.402
"BLD",1395,"KRN",.403,0)
.403
"BLD",1395,"KRN",.5,0)
.5
"BLD",1395,"KRN",.84,0)
.84
"BLD",1395,"KRN",3.6,0)
3.6
"BLD",1395,"KRN",3.8,0)
3.8
"BLD",1395,"KRN",9.2,0)
9.2
"BLD",1395,"KRN",9.8,0)
9.8
"BLD",1395,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",1395,"KRN",9.8,"NM",1,0)
MPIFRES^^0^B12887670
"BLD",1395,"KRN",9.8,"NM",2,0)
MPIFVTQ^^0^B50367191
"BLD",1395,"KRN",9.8,"NM",3,0)
MPIFQ0^^0^B70291821
"BLD",1395,"KRN",9.8,"NM",4,0)
MPIFBT1^^0^B37227281
"BLD",1395,"KRN",9.8,"NM",5,0)
MPIFSAQ^^0^B73294372
"BLD",1395,"KRN",9.8,"NM",6,0)
MPIFQ1^^0^B44651502
"BLD",1395,"KRN",9.8,"NM",7,0)
MPIFAPI^^0^B27612509
"BLD",1395,"KRN",9.8,"NM",8,0)
MPIFDEL^^0^B17855631
"BLD",1395,"KRN",9.8,"NM",9,0)
MPIFBT2^^0^B45960593
"BLD",1395,"KRN",9.8,"NM",10,0)
MPIFBT3^^0^B22489834
"BLD",1395,"KRN",9.8,"NM","B","MPIFAPI",7)

"BLD",1395,"KRN",9.8,"NM","B","MPIFBT1",4)

"BLD",1395,"KRN",9.8,"NM","B","MPIFBT2",9)

"BLD",1395,"KRN",9.8,"NM","B","MPIFBT3",10)

"BLD",1395,"KRN",9.8,"NM","B","MPIFDEL",8)

"BLD",1395,"KRN",9.8,"NM","B","MPIFQ0",3)

"BLD",1395,"KRN",9.8,"NM","B","MPIFQ1",6)

"BLD",1395,"KRN",9.8,"NM","B","MPIFRES",1)

"BLD",1395,"KRN",9.8,"NM","B","MPIFSAQ",5)

"BLD",1395,"KRN",9.8,"NM","B","MPIFVTQ",2)

"BLD",1395,"KRN",19,0)
19
"BLD",1395,"KRN",19.1,0)
19.1
"BLD",1395,"KRN",101,0)
101
"BLD",1395,"KRN",409.61,0)
409.61
"BLD",1395,"KRN",409.61,"NM",0)
^9.68A^1^1
"BLD",1395,"KRN",409.61,"NM",1,0)
MPIF REAL-TIME QUERY^^0
"BLD",1395,"KRN",409.61,"NM","B","MPIF REAL-TIME QUERY",1)

"BLD",1395,"KRN",771,0)
771
"BLD",1395,"KRN",870,0)
870
"BLD",1395,"KRN",8989.51,0)
8989.51
"BLD",1395,"KRN",8989.52,0)
8989.52
"BLD",1395,"KRN",8994,0)
8994
"BLD",1395,"KRN","B",.4,.4)

"BLD",1395,"KRN","B",.401,.401)

"BLD",1395,"KRN","B",.402,.402)

"BLD",1395,"KRN","B",.403,.403)

"BLD",1395,"KRN","B",.5,.5)

"BLD",1395,"KRN","B",.84,.84)

"BLD",1395,"KRN","B",3.6,3.6)

"BLD",1395,"KRN","B",3.8,3.8)

"BLD",1395,"KRN","B",9.2,9.2)

"BLD",1395,"KRN","B",9.8,9.8)

"BLD",1395,"KRN","B",19,19)

"BLD",1395,"KRN","B",19.1,19.1)

"BLD",1395,"KRN","B",101,101)

"BLD",1395,"KRN","B",409.61,409.61)

"BLD",1395,"KRN","B",771,771)

"BLD",1395,"KRN","B",870,870)

"BLD",1395,"KRN","B",8989.51,8989.51)

"BLD",1395,"KRN","B",8989.52,8989.52)

"BLD",1395,"KRN","B",8994,8994)

"BLD",1395,"QUES",0)
^9.62^^
"BLD",1395,"REQB",0)
^9.611^5^5
"BLD",1395,"REQB",1,0)
MPIF*1.0*16^1
"BLD",1395,"REQB",2,0)
MPIF*1.0*13^1
"BLD",1395,"REQB",3,0)
MPIF*1.0*15^1
"BLD",1395,"REQB",4,0)
MPIF*1.0*9^1
"BLD",1395,"REQB",5,0)
MPIF*1.0*10^1
"BLD",1395,"REQB","B","MPIF*1.0*10",5)

"BLD",1395,"REQB","B","MPIF*1.0*13",2)

"BLD",1395,"REQB","B","MPIF*1.0*15",3)

"BLD",1395,"REQB","B","MPIF*1.0*16",1)

"BLD",1395,"REQB","B","MPIF*1.0*9",4)

"KRN",409.61,125,-1)
0^1
"KRN",409.61,125,0)
MPIF REAL-TIME QUERY^1^^80^8^16^1^1^^MPIF REAL-TIME QUERY MENU^MPI QUERY RESULTS^1^^1
"KRN",409.61,125,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,125,"ARRAY")
 ^TMP("MPIFQ0",$J)
"KRN",409.61,125,"COL",0)
^409.621^4^4
"KRN",409.61,125,"COL",1,0)
PATIENT^6^31^Patient
"KRN",409.61,125,"COL",2,0)
SSN^31^9^SSN^^0
"KRN",409.61,125,"COL",3,0)
Date of Birth^42^11^DOB
"KRN",409.61,125,"COL",4,0)
CMOR^55^20^CMOR
"KRN",409.61,125,"COL","AIDENT",0,2)

"KRN",409.61,125,"COL","B","CMOR",4)

"KRN",409.61,125,"COL","B","Date of Birth",3)

"KRN",409.61,125,"COL","B","PATIENT",1)

"KRN",409.61,125,"COL","B","SSN",2)

"KRN",409.61,125,"FNL")
D EXIT^MPIFQ1
"KRN",409.61,125,"HDR")
D HDR^MPIFQ1
"KRN",409.61,125,"INIT")
D INIT^MPIFQ1
"MBREQ")
0
"ORD",17,409.61)
409.61;17;1;;;;;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
17^3020208
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3020208
"PKG",282,22,1,"PAH",1,1,1,0)
Selection screen and Misc changes
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1.0*17 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","MPIFAPI")
0^7^B27612509
"RTN","MPIFAPI",1,0)
MPIFAPI ;CMC/BP-APIS FOR MPI ;DEC 21, 1998
"RTN","MPIFAPI",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,14,16,17**;30 Apr 99
"RTN","MPIFAPI",3,0)
 ;original 1st line ARS/SLC - API for local ICNs ;04-FEB-97
"RTN","MPIFAPI",4,0)
 ;
"RTN","MPIFAPI",5,0)
 ; Intregration Agreement Utilized:
"RTN","MPIFAPI",6,0)
 ;   ^DPT( - #2070
"RTN","MPIFAPI",7,0)
 ;   ^%ZTLOAD - #10063
"RTN","MPIFAPI",8,0)
 ;   ^DIC - #10006
"RTN","MPIFAPI",9,0)
 ;   FILE^DICN - #10009
"RTN","MPIFAPI",10,0)
 ;   ^DIE - #10018
"RTN","MPIFAPI",11,0)
 ;   ^DIK - #10013
"RTN","MPIFAPI",12,0)
 ;   ^DPT("AICN", ^DPT("AMPIMIS", ^DPT("ASCN2" - #2070
"RTN","MPIFAPI",13,0)
 ;   LINK^HLUTIL3 - #2271
"RTN","MPIFAPI",14,0)
 ;   $$SITE^VASITE - #10112
"RTN","MPIFAPI",15,0)
 ;   $$FMADD and $$NOW^XLFDT - #10103
"RTN","MPIFAPI",16,0)
 ;   $$LKUP^XUAF4 - #2171
"RTN","MPIFAPI",17,0)
 ;   HOME^ZIS - #10086
"RTN","MPIFAPI",18,0)
 ;
"RTN","MPIFAPI",19,0)
EN2() ;NEW ENTRY POINT FOR LOCALS
"RTN","MPIFAPI",20,0)
 N MPIOUT,DIC,MPICHK,MPINCK,MPINNM,MPINUM1,DA,MPINUM
"RTN","MPIFAPI",21,0)
 I $O(^MPIF(984.1,0))="" G SETUP
"RTN","MPIFAPI",22,0)
AGN2 L +^MPIF(984.1):1 E  H 3 G AGN2
"RTN","MPIFAPI",23,0)
 S MPINUM=0
"RTN","MPIFAPI",24,0)
 S X=$$SITE^VASITE,X=$P(X,"^",3),X=X\1
"RTN","MPIFAPI",25,0)
 S DIC="^MPIF(984.1,",DIC(0)="XZ" D ^DIC
"RTN","MPIFAPI",26,0)
 S MPINUM1=$P(Y(0),"^",4),MPICHK=$P(Y(0),"^",5),MPINNM=MPINUM1+1
"RTN","MPIFAPI",27,0)
 S MPINUM=MPINUM1_"V"_MPICHK
"RTN","MPIFAPI",28,0)
 S MPINCK=$$CHECKDG^MPIFSPC(MPINNM)
"RTN","MPIFAPI",29,0)
 S DA=1,DIE="^MPIF(984.1,",DR="1////^S X=MPINUM1;2////^S X=MPICHK;3////^S X=MPINNM;5////"_MPINCK
"RTN","MPIFAPI",30,0)
 D ^DIE
"RTN","MPIFAPI",31,0)
 K DIE,DR,X,Y
"RTN","MPIFAPI",32,0)
 L -^MPIF(984.1)
"RTN","MPIFAPI",33,0)
 Q MPINUM
"RTN","MPIFAPI",34,0)
SETUP ;
"RTN","MPIFAPI",35,0)
 N CHK,NUM,NXTCHK,NXTNUM,SITE,DA
"RTN","MPIFAPI",36,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFAPI",37,0)
 S DIC="^MPIF(984.1,",DA=1,DIC(0)="",X=SITE
"RTN","MPIFAPI",38,0)
 S NUM=SITE_"0000000"
"RTN","MPIFAPI",39,0)
 S CHK=$$CHECKDG^MPIFSPC(NUM)
"RTN","MPIFAPI",40,0)
 S MPINUM=NUM_"V"_CHK
"RTN","MPIFAPI",41,0)
 S NXTNUM=NUM+1,NXTCHK=$$CHECKDG^MPIFSPC(NXTNUM)
"RTN","MPIFAPI",42,0)
 S DIC("DR")="1////^S X=NUM;2////^S X=CHK;3////^S X=NXTNUM;5////"_NXTCHK
"RTN","MPIFAPI",43,0)
 K DD,D0
"RTN","MPIFAPI",44,0)
 D FILE^DICN
"RTN","MPIFAPI",45,0)
 K DIC,X,Y
"RTN","MPIFAPI",46,0)
 Q MPINUM
"RTN","MPIFAPI",47,0)
 ;
"RTN","MPIFAPI",48,0)
MPILINK() ;returns MPI logical Link
"RTN","MPIFAPI",49,0)
 N MPIL,MPILINK
"RTN","MPIFAPI",50,0)
 D LINK^HLUTIL3("MPI",.MPIL)
"RTN","MPIFAPI",51,0)
 I '$D(MPIL) Q "-1^NOT DEFINED"
"RTN","MPIFAPI",52,0)
 S MPILINK=$O(MPIL(0))
"RTN","MPIFAPI",53,0)
 I MPILINK="" Q "-1^NOT DEFINED"
"RTN","MPIFAPI",54,0)
 S MPILINK=$G(MPIL(MPILINK))
"RTN","MPIFAPI",55,0)
 Q MPILINK
"RTN","MPIFAPI",56,0)
 ;
"RTN","MPIFAPI",57,0)
SUBNUM(DFN) ; returns Subscription Control Number from MPI node for given DFN
"RTN","MPIFAPI",58,0)
 ; DFN - ien of patient file
"RTN","MPIFAPI",59,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",60,0)
 ;           Subscription Control Number
"RTN","MPIFAPI",61,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",62,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",63,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",64,0)
 N NODE,SUB
"RTN","MPIFAPI",65,0)
 S NODE=$$MPINODE(DFN)
"RTN","MPIFAPI",66,0)
 S SUB=$P(NODE,"^",5)
"RTN","MPIFAPI",67,0)
 I SUB="" S SUB="-1^No Subscription Control Number for DFN "_DFN
"RTN","MPIFAPI",68,0)
 Q SUB
"RTN","MPIFAPI",69,0)
 ;
"RTN","MPIFAPI",70,0)
MPINODE(DFN) ; returns MPI node for given DFN
"RTN","MPIFAPI",71,0)
 ; DFN - patient file ien
"RTN","MPIFAPI",72,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",73,0)
 ;           MPI node from patient file
"RTN","MPIFAPI",74,0)
 I '$D(DFN) Q "-1^DFN not defined"
"RTN","MPIFAPI",75,0)
 I '$D(^DPT(DFN)) Q "-1^DFN doesn't exist"
"RTN","MPIFAPI",76,0)
 I '$D(^DPT(DFN,"MPI")) Q "-1^No MPI node for DFN "_DFN
"RTN","MPIFAPI",77,0)
 N NODE
"RTN","MPIFAPI",78,0)
 S NODE=$G(^DPT(DFN,"MPI"))
"RTN","MPIFAPI",79,0)
 I NODE=""!(NODE?."^") S NODE="-1^No MPI data for DFN "_DFN
"RTN","MPIFAPI",80,0)
 Q NODE
"RTN","MPIFAPI",81,0)
 ;
"RTN","MPIFAPI",82,0)
GETADFN(ICN) ; return DFN ONLY if ICN is the active ICN
"RTN","MPIFAPI",83,0)
 ; ICN - Integration Control Number for patient to be returned
"RTN","MPIFAPI",84,0)
 ; returns:  -1^error message
"RTN","MPIFAPI",85,0)
 ;           DFN - IEN for the patient entry in the Patient file (#2)
"RTN","MPIFAPI",86,0)
 N RETURN,DFN
"RTN","MPIFAPI",87,0)
 I $G(ICN)'>0 Q "-1^NO ICN"
"RTN","MPIFAPI",88,0)
 I '$D(^DPT("AICN",ICN)) Q "-1^ICN NOT IN DATABASE"
"RTN","MPIFAPI",89,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIFAPI",90,0)
 I $G(DFN)'>0 Q "-1^BAD AICN CROSS-REFERENCE"
"RTN","MPIFAPI",91,0)
 I $P($G(^DPT(DFN,"MPI")),"^")'=ICN Q "-1^ICN is not Active one"
"RTN","MPIFAPI",92,0)
 Q DFN
"RTN","MPIFAPI",93,0)
 ;
"RTN","MPIFAPI",94,0)
UPDATE(DFN,ARR) ; updates fields on MPI node passed in ARR(field number) for
"RTN","MPIFAPI",95,0)
 ;patient DFN.  Fields 991.01-991.05 only
"RTN","MPIFAPI",96,0)
 ;ARR - array of values for each field to be updated where subscript
"RTN","MPIFAPI",97,0)
 ; is the field number to be updated
"RTN","MPIFAPI",98,0)
 ;DFN - patient IEN
"RTN","MPIFAPI",99,0)
 ;Returns : -1^error message if unable to update fields
"RTN","MPIFAPI",100,0)
 ;          0 if successfully updated fields
"RTN","MPIFAPI",101,0)
 ;
"RTN","MPIFAPI",102,0)
 N FLD,DR,DIE,DA,LOC,SCN,ICN,CMOR
"RTN","MPIFAPI",103,0)
 Q:'$D(^DPT(DFN,0)) "-1^No Entry in Patient file"
"RTN","MPIFAPI",104,0)
 S DIE="^DPT(",DA=DFN,RGRSICN=""
"RTN","MPIFAPI",105,0)
 L +^DPT(DFN,"MPI"):10
"RTN","MPIFAPI",106,0)
 I $G(@ARR@(991.01))'=""&($G(@ARR@(991.02))'="") S ICN=$$SETICN^MPIF001(DFN,@ARR@(991.01),@ARR@(991.02))
"RTN","MPIFAPI",107,0)
 I $G(@ARR@(991.03))'="" S CMOR=$$CHANGE^MPIF001(DFN,$$LKUP^XUAF4(@ARR@(991.03)))
"RTN","MPIFAPI",108,0)
 I $G(@ARR@(991.04))'="" S LOC=$$SETLOC^MPIF001(DFN,@ARR@(991.04))
"RTN","MPIFAPI",109,0)
 I $G(@ARR@(991.05))'=""&($G(@ARR@(991.05))="@") D
"RTN","MPIFAPI",110,0)
 .S SCN=$$SUBNUM(DFN)
"RTN","MPIFAPI",111,0)
 .S DA=SCN,DIK="^HLS(774," D ^DIK K DIK,DA
"RTN","MPIFAPI",112,0)
 .S $P(^DPT(DFN,"MPI"),"^",5)=""
"RTN","MPIFAPI",113,0)
 .K ^DPT("ASCN2",SCN,DFN)
"RTN","MPIFAPI",114,0)
 I $G(@ARR@(991.05))'=""&($G(@ARR@(991.05))'="@") S DIE="^DPT(",DR="991.05///"_@ARR@(991.05),DA=DFN D ^DIE
"RTN","MPIFAPI",115,0)
 S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFAPI",116,0)
 I ICN'="",$E(ICN,1,3)=$P($$SITE^VASITE(),"^",3) S LOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFAPI",117,0)
 I ICN'="",$E(ICN,1,3)'=$P($$SITE^VASITE(),"^",3) S LOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFAPI",118,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIFAPI",119,0)
 K ^DPT("AMPIMIS",DFN)
"RTN","MPIFAPI",120,0)
 K RGRSICN
"RTN","MPIFAPI",121,0)
 Q 0
"RTN","MPIFAPI",122,0)
 ;
"RTN","MPIFAPI",123,0)
MPIQ(MDFN) ;
"RTN","MPIFAPI",124,0)
 ;MPI QUERY
"RTN","MPIFAPI",125,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFAPI",126,0)
 K MPIFRTN D VTQ^MPIFQ0
"RTN","MPIFAPI",127,0)
 I $G(MPIFRTN)="" D
"RTN","MPIFAPI",128,0)
 .; ^ Quit at LM screen when presented with a list of possible matches
"RTN","MPIFAPI",129,0)
 .; \/ setup Local ICN and proceed
"RTN","MPIFAPI",130,0)
 .N ICN,ERR
"RTN","MPIFAPI",131,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIFAPI",132,0)
 .Q:ICN=""!(+ICN=-1)
"RTN","MPIFAPI",133,0)
 .S ERR=$$SETICN^MPIF001(MDFN,+ICN,$P(ICN,"V",2))
"RTN","MPIFAPI",134,0)
 .S ERR=$$SETLOC^MPIF001(MDFN,1)
"RTN","MPIFAPI",135,0)
 .S ERR=$$CHANGE^MPIF001(MDFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFAPI",136,0)
 K MPIFRTN,ZTREQ
"RTN","MPIFAPI",137,0)
 Q
"RTN","MPIFAPI",138,0)
 ;
"RTN","MPIFAPI",139,0)
MPIQQ(PDFN) ; Entry point for queuing d/c
"RTN","MPIFAPI",140,0)
 ; DFN should already exist before making this call
"RTN","MPIFAPI",141,0)
 ; Returned is -1^error message OR Task #
"RTN","MPIFAPI",142,0)
 Q:'$D(PDFN) "-1^No DFN passed"
"RTN","MPIFAPI",143,0)
 S ZTRTN="MPIQ^MPIFAPI(PDFN)"
"RTN","MPIFAPI",144,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFAPI",145,0)
 S ZTSAVE("PDFN")=PDFN
"RTN","MPIFAPI",146,0)
 S ZTSAVE("MPIFS")=1
"RTN","MPIFAPI",147,0)
 ; ^ silent flag
"RTN","MPIFAPI",148,0)
 S ZTIO=""
"RTN","MPIFAPI",149,0)
 S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFAPI",150,0)
 D ^%ZTLOAD
"RTN","MPIFAPI",151,0)
 D HOME^ZIS K IO("Q")
"RTN","MPIFAPI",152,0)
 N TSK
"RTN","MPIFAPI",153,0)
 S TSK=ZTSK
"RTN","MPIFAPI",154,0)
 K ZTSAVE,ZTRTN,ZTIO,ZTDTH,ZTSK
"RTN","MPIFAPI",155,0)
 Q TSK
"RTN","MPIFAPI",156,0)
 ;
"RTN","MPIFAPI",157,0)
SEG(SEGMENT,PIECE,CODE) ;Return segment from MPIDC array and kill node
"RTN","MPIFAPI",158,0)
 N MPINODE,MPIDATA,MPIDONE,MPIC K MPIDONE
"RTN","MPIFAPI",159,0)
 I '$D(MPIC) S MPIC=$E(HL("ECH"))
"RTN","MPIFAPI",160,0)
 S MPINODE=0
"RTN","MPIFAPI",161,0)
 F  S MPINODE=$O(MPIDC(MPINODE)) Q:MPINODE=""!($D(MPIDONE))  D
"RTN","MPIFAPI",162,0)
 .S MPIDATA=MPIDC(MPINODE)
"RTN","MPIFAPI",163,0)
 .I ($P(MPIDATA,HL("FS"),1)=SEGMENT)&($P($P(MPIDATA,HL("FS"),PIECE),MPIC,1)=CODE) S MPIDONE=1 K MPIDC(MPINODE)
"RTN","MPIFAPI",164,0)
 Q:$D(MPIDONE) $G(MPIDATA)
"RTN","MPIFAPI",165,0)
 Q ""
"RTN","MPIFBT1")
0^4^B37227281
"RTN","MPIFBT1",1,0)
MPIFBT1 ;SLC/ARS/SFCIO/CMC-BATCH QUERY TO MPI ;FEB 4, 1997
"RTN","MPIFBT1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**17**;30 Apr 99
"RTN","MPIFBT1",3,0)
 ;
"RTN","MPIFBT1",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFBT1",5,0)
 ;  EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFBT1",6,0)
 ;  ^DPT("ACMORS" - #2070
"RTN","MPIFBT1",7,0)
 ;  ^RGSITE(991.8,1,"CMOR" - #2746
"RTN","MPIFBT1",8,0)
 ;
"RTN","MPIFBT1",9,0)
GOBKG ;
"RTN","MPIFBT1",10,0)
 K STOP
"RTN","MPIFBT1",11,0)
 ;make sure only one job will run
"RTN","MPIFBT1",12,0)
 L +^XTMP("MPIF BATCH LOAD"):3 E  W !,"JOB ALREADY RUNNING" Q
"RTN","MPIFBT1",13,0)
 ;
"RTN","MPIFBT1",14,0)
 I '$D(^RGSITE(991.8,1,"CMOR")) W !,"CMOR Scores NOT Complete" G EXIT
"RTN","MPIFBT1",15,0)
 I $D(^RGSITE(991.8,1,"CMOR")),$P($G(^RGSITE(991.8,1,"CMOR")),"^",7)'="SN" W !,"CMOR Scores NOT Complete" G EXIT
"RTN","MPIFBT1",16,0)
 ;
"RTN","MPIFBT1",17,0)
 ;Check to see if job had STOPed -start where left off, start over or quit
"RTN","MPIFBT1",18,0)
 I $P($G(^MPIF(984.8,1,0)),"^",6)'="" D AGAIN
"RTN","MPIFBT1",19,0)
 I $D(STOP) W !,"Job NOT Started" K STOP G EXIT
"RTN","MPIFBT1",20,0)
 D BEG
"RTN","MPIFBT1",21,0)
 I $D(STOP) K STOP G EXIT
"RTN","MPIFBT1",22,0)
 S ZTRTN="GO^MPIFBT1",ZTDESC="USE HL7 MSGS AND MAIL TO BUILD ICN"
"RTN","MPIFBT1",23,0)
 S ZTIO="",ZTDTH=START
"RTN","MPIFBT1",24,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFBT1",25,0)
 I $D(ORDER) S ZTSAVE("ORDER")=ORDER
"RTN","MPIFBT1",26,0)
 D ^%ZTLOAD W:$D(ZTSK) !,"TASK #: ",ZTSK
"RTN","MPIFBT1",27,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFBT1",28,0)
 K ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,ORDER,START,ENDT
"RTN","MPIFBT1",29,0)
 Q
"RTN","MPIFBT1",30,0)
EXIT ;
"RTN","MPIFBT1",31,0)
 L -^XTMP("MPIF BATCH LOAD")
"RTN","MPIFBT1",32,0)
 Q
"RTN","MPIFBT1",33,0)
 ;
"RTN","MPIFBT1",34,0)
BEG K DIR,DIE,DR,DA,X,Y
"RTN","MPIFBT1",35,0)
 S DIR(0)="D^::AEFT",DIR("B")="NOW",DIR("A")="START TIME"
"RTN","MPIFBT1",36,0)
 D ^DIR
"RTN","MPIFBT1",37,0)
 I $D(DTOUT)!($D(DUOUT)) W !,"Job NOT Scheduled" K DTOUT,DUOUT,DIR,DA,X,Y S STOP="" Q
"RTN","MPIFBT1",38,0)
 S START=Y
"RTN","MPIFBT1",39,0)
 D DD^%DT
"RTN","MPIFBT1",40,0)
 S ENDT=Y
"RTN","MPIFBT1",41,0)
TRY K DIR,DIE,DR,DA,X,Y
"RTN","MPIFBT1",42,0)
 S DIR(0)="D^::AEFT",DIR("B")=ENDT,DIR("A")="STOP TIME"
"RTN","MPIFBT1",43,0)
 D ^DIR
"RTN","MPIFBT1",44,0)
 I $D(DTOUT)!($D(DUOUT)) W !,"Job NOT Scheduled" K DTOUT,DUOUT,DIR,DA,X,Y S STOP="" Q
"RTN","MPIFBT1",45,0)
 I Y'>START W !,"Stop Time must be greater than Start Time" G TRY
"RTN","MPIFBT1",46,0)
 D DD^%DT
"RTN","MPIFBT1",47,0)
 S ENDT=Y
"RTN","MPIFBT1",48,0)
 K DIR,DIE,DR,DA,X,Y
"RTN","MPIFBT1",49,0)
 S DIE="^MPIF(984.8,",DR="9///"_ENDT,DA=1 D ^DIE
"RTN","MPIFBT1",50,0)
 K DIE,X,Y,DA,DR
"RTN","MPIFBT1",51,0)
 I $D(DTOUT)!($D(DUOUT)) W !,"Job NOT Scheduled" K DTOUT,DUOUT,DIR,DA,X,Y S STOP="" Q
"RTN","MPIFBT1",52,0)
 Q
"RTN","MPIFBT1",53,0)
 ;
"RTN","MPIFBT1",54,0)
GO ;ENTRY POINT
"RTN","MPIFBT1",55,0)
 I '$D(ZTQUEUED) L +^XTMP("MPIF BATCH LOAD"):3 E  W !,"JOB ALREADY RUNNING" Q
"RTN","MPIFBT1",56,0)
 I '$D(ZTQUEUED),('$D(^RGSITE(991.8,1,"CMOR"))) W !,"CMOR Scores NOT Complete" G EXIT
"RTN","MPIFBT1",57,0)
 I '$D(ZTQUEUED),$D(^RGSITE(991.8,1,"CMOR")),$P($G(^RGSITE(991.8,1,"CMOR")),"^",7)'="SN" W !,"CMOR Scores NOT Complete" G EXIT
"RTN","MPIFBT1",58,0)
 K STOP
"RTN","MPIFBT1",59,0)
 ;Check to see if job had STOPed-start where left off, start over or quit
"RTN","MPIFBT1",60,0)
 I '$D(ZTQUEUED),$P($G(^MPIF(984.8,1,0)),"^",6)'="" D AGAIN
"RTN","MPIFBT1",61,0)
 I $D(STOP) W !,"Job NOT Started" K STOP G EXIT
"RTN","MPIFBT1",62,0)
 I '$D(ZTQUEUED) D BEG
"RTN","MPIFBT1",63,0)
 I $D(STOP) K STOP G EXIT
"RTN","MPIFBT1",64,0)
GO1 K ^TMP("HLS",$J)
"RTN","MPIFBT1",65,0)
 N MPIMORE,MPITOT
"RTN","MPIFBT1",66,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFBT1",67,0)
 S QUITIME=$P(^MPIF(984.8,1,0),"^",10)
"RTN","MPIFBT1",68,0)
 I '$D(ORDER) S ORDER=0
"RTN","MPIFBT1",69,0)
 ;
"RTN","MPIFBT1",70,0)
 K ^TMP("HLS",$J)
"RTN","MPIFBT1",71,0)
 S MPICNT=$S($P(^MPIF(984.8,1,0),"^",9)>1:$P(^MPIF(984.8,1,0),"^",9),1:1)
"RTN","MPIFBT1",72,0)
 I +ORDER<1 S ORDER=0
"RTN","MPIFBT1",73,0)
 D WORK
"RTN","MPIFBT1",74,0)
 I $D(^TMP("HLS",$J)) D SEND
"RTN","MPIFBT1",75,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFBT1",76,0)
 K MPIIT,MPITOT,HLDT,HLDT1,MPICNT,MPIDNUM,MPIEROR,MPIHL,MPIMIDT,MPIMSH
"RTN","MPIFBT1",77,0)
 K MPIOUT,MPIQRYNM,MPISEQ,ORDER,QCNT,QUITIME,MPIMCNT,MPIMTX,ORDER,START
"RTN","MPIFBT1",78,0)
 K ENDT
"RTN","MPIFBT1",79,0)
 L -^XTMP("MPIF BATCH LOAD")
"RTN","MPIFBT1",80,0)
 Q
"RTN","MPIFBT1",81,0)
WORK ;
"RTN","MPIFBT1",82,0)
 Q:$P(^MPIF(984.8,1,0),"^",6)="STOP"
"RTN","MPIFBT1",83,0)
 D NOW^%DTC
"RTN","MPIFBT1",84,0)
 S $P(^MPIF(984.8,1,0),"^",2)=%
"RTN","MPIFBT1",85,0)
 I %>QUITIME Q
"RTN","MPIFBT1",86,0)
 S MPIMCNT="",MPIMTX=""
"RTN","MPIFBT1",87,0)
 D HLRDF,LOOP
"RTN","MPIFBT1",88,0)
 Q
"RTN","MPIFBT1",89,0)
 ;
"RTN","MPIFBT1",90,0)
HLRDF ;
"RTN","MPIFBT1",91,0)
 S (MPIOUT,MPIMCNT)=""
"RTN","MPIFBT1",92,0)
 S MPIHL("ECH")="^~\&"
"RTN","MPIFBT1",93,0)
 S MPIHL("FS")="|"
"RTN","MPIFBT1",94,0)
 D INIT^HLFNC2("MPIF ICN-Q02 SERVER",.MPIHL)
"RTN","MPIFBT1",95,0)
 I $O(MPIHL("")) S ^TMP($J,"MPIF","ERR")=MPIHL
"RTN","MPIFBT1",96,0)
 D CREATE^HLTF(.MPIMCNT,.MPIMTX,.HLDT,.HLDT1)
"RTN","MPIFBT1",97,0)
 D START^RGHLLOG()
"RTN","MPIFBT1",98,0)
 Q:$P(^MPIF(984.8,1,0),"^",6)="STOP"
"RTN","MPIFBT1",99,0)
 S $P(^MPIF(984.8,1,0),"^",7)=MPIMCNT
"RTN","MPIFBT1",100,0)
 S $P(^MPIF(984.8,1,0),"^",8)=MPIMTX
"RTN","MPIFBT1",101,0)
 Q
"RTN","MPIFBT1",102,0)
LOOP ;
"RTN","MPIFBT1",103,0)
 Q:$P(^MPIF(984.8,1,0),"^",6)="STOP"
"RTN","MPIFBT1",104,0)
 S MPIDNUM=1
"RTN","MPIFBT1",105,0)
 D MAKE
"RTN","MPIFBT1",106,0)
 Q
"RTN","MPIFBT1",107,0)
SEND ;ready to send
"RTN","MPIFBT1",108,0)
 S $P(^MPIF(984.8,1,0),"^",5)="GENERATE TAG"
"RTN","MPIFBT1",109,0)
 D GENERATE^HLMA("MPIF ICN-Q02 SERVER","GB",1,.MPIMTX,.MPIEROR,.MPIMORE)
"RTN","MPIFBT1",110,0)
 I +MPIEROR=0 S ^TMP($J,"MPIF","ERR")=MPIEROR
"RTN","MPIFBT1",111,0)
 D NOW^%DTC
"RTN","MPIFBT1",112,0)
 S $P(^MPIF(984.8,1,0),"^",3)=%
"RTN","MPIFBT1",113,0)
 K %,MPIMTX,MPIEROR,MPIMORE
"RTN","MPIFBT1",114,0)
 K ^TMP("HLS",$J)
"RTN","MPIFBT1",115,0)
 Q
"RTN","MPIFBT1",116,0)
MAKE ;
"RTN","MPIFBT1",117,0)
 F  S ORDER=$O(^DPT("ACMORS",ORDER)) Q:ORDER=""!($P(^MPIF(984.8,1,0),"^",6)="STOP")  D
"RTN","MPIFBT1",118,0)
 .S MPIIT=0
"RTN","MPIFBT1",119,0)
 .F  S MPIIT=$O(^DPT("ACMORS",ORDER,MPIIT)) Q:MPIIT=""!($P(^MPIF(984.8,1,0),"^",6)="STOP")  D
"RTN","MPIFBT1",120,0)
 ..D MAKE3
"RTN","MPIFBT1",121,0)
 ..D NOW^%DTC
"RTN","MPIFBT1",122,0)
 ..I %>QUITIME S $P(^MPIF(984.8,1,0),"^",6)="STOP"
"RTN","MPIFBT1",123,0)
 Q
"RTN","MPIFBT1",124,0)
MAKE3 ;
"RTN","MPIFBT1",125,0)
 K MPIOUT
"RTN","MPIFBT1",126,0)
 Q:$P(^MPIF(984.8,1,0),"^",6)="STOP"
"RTN","MPIFBT1",127,0)
 S $P(^MPIF(984.8,1,0),"^",5)="LOOPING: "_MPIDNUM
"RTN","MPIFBT1",128,0)
 S:$G(MPIQRYNM)="" MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFBT1",129,0)
 D VTQ1^MPIFVTQ(MPIIT,.MPIOUT,.MPIHL,.MPIQRYNM)
"RTN","MPIFBT1",130,0)
 I $P(MPIOUT(0),"^",1)<0,$P(MPIOUT(0),"^",2)="invalid DFN"!($P(MPIOUT(0),"^",2)="no encoding characters") D
"RTN","MPIFBT1",131,0)
 .D EXC^RGHLLOG(206,"DFN = "_MPIIT_"  Problem with building VTQ was "_$P(MPIOUT(0),"^",2),MPIIT) Q
"RTN","MPIFBT1",132,0)
 I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="Missing Required Field(s)" D EXC^RGHLLOG(209,"DFN - "_MPIIT_" Missing Required Field(s)",MPIIT) Q
"RTN","MPIFBT1",133,0)
 Q:$P(MPIOUT(0),"^")<0
"RTN","MPIFBT1",134,0)
 ;call for HL7 header
"RTN","MPIFBT1",135,0)
 S MPIMIDT=MPIMCNT_"-"_MPIDNUM
"RTN","MPIFBT1",136,0)
 D MSH^HLFNC2(.MPIHL,MPIMIDT,.MPIMSH)
"RTN","MPIFBT1",137,0)
 S MPIOUT(1)=MPIMSH
"RTN","MPIFBT1",138,0)
 ;MESSAGE BUILT
"RTN","MPIFBT1",139,0)
 S MPISEQ=0
"RTN","MPIFBT1",140,0)
 F  S MPISEQ=$O(MPIOUT(MPISEQ)) Q:MPISEQ'>0  D
"RTN","MPIFBT1",141,0)
 .S ^TMP("HLS",$J,MPICNT)=MPIOUT(MPISEQ)
"RTN","MPIFBT1",142,0)
 .S MPICNT=MPICNT+1
"RTN","MPIFBT1",143,0)
 S $P(^MPIF(984.8,1,0),"^",11)=ORDER
"RTN","MPIFBT1",144,0)
 S $P(^MPIF(984.8,1,0),"^",9)=MPICNT
"RTN","MPIFBT1",145,0)
 S $P(^MPIF(984.8,1,0),"^",4)=MPIIT
"RTN","MPIFBT1",146,0)
 S MPIDNUM=MPIDNUM+1
"RTN","MPIFBT1",147,0)
 I MPIDNUM>100 D
"RTN","MPIFBT1",148,0)
 .D SEND
"RTN","MPIFBT1",149,0)
 .S (MPICNT,MPIDNUM)=1
"RTN","MPIFBT1",150,0)
 .D HLRDF
"RTN","MPIFBT1",151,0)
 Q
"RTN","MPIFBT1",152,0)
 ;
"RTN","MPIFBT1",153,0)
AGAIN ;job started before
"RTN","MPIFBT1",154,0)
 W !,"Job was started before and has Stopped"
"RTN","MPIFBT1",155,0)
 K DIR,DR
"RTN","MPIFBT1",156,0)
 S DIR(0)="Y",DIR("B")="YES",DIR("A")="Begin Where Left Off? ",DIR("?")="Y for yes to start where job left off, N for no"
"RTN","MPIFBT1",157,0)
 D ^DIR
"RTN","MPIFBT1",158,0)
 I Y=1 S ORDER=$P(^MPIF(984.8,1,0),"^",11),$P(^MPIF(984.8,1,0),"^",6)="" G END
"RTN","MPIFBT1",159,0)
 ;job started but used doesn't want to start where job left off
"RTN","MPIFBT1",160,0)
 W !,"'E' - Exit or 'O' - Start over from the Beginning"
"RTN","MPIFBT1",161,0)
 K DIR,DR
"RTN","MPIFBT1",162,0)
 S DIR(0)="S^E:EXIT;O:OVER",DIR("?")="E for Exit, O to Start Over from the Beginning"
"RTN","MPIFBT1",163,0)
 S DIR("A")="What would you like to do?"
"RTN","MPIFBT1",164,0)
 D ^DIR
"RTN","MPIFBT1",165,0)
 S:Y="E" STOP=""
"RTN","MPIFBT1",166,0)
 S:Y="O" ORDER=0,$P(^MPIF(984.8,1,0),"^",6)=""
"RTN","MPIFBT1",167,0)
END ;
"RTN","MPIFBT1",168,0)
 K DIR,Y,DR,X
"RTN","MPIFBT1",169,0)
 ; wants to start over or from where job left off if '$d(stop)
"RTN","MPIFBT1",170,0)
 Q
"RTN","MPIFBT2")
0^9^B45960593
"RTN","MPIFBT2",1,0)
MPIFBT2 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT2",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,10,17**;30 Apr 99
"RTN","MPIFBT2",3,0)
 ;
"RTN","MPIFBT2",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFBT2",5,0)
 ;   ^DGCN(391.91 - #2751
"RTN","MPIFBT2",6,0)
 ;   EXC, START, STOP ^RGHLLOG - #2796
"RTN","MPIFBT2",7,0)
 ;   XMITFLAG^VAFCDD01 - #3493
"RTN","MPIFBT2",8,0)
 ;   $$PIVNW^VAFHPIVT - #3494
"RTN","MPIFBT2",9,0)
 ;
"RTN","MPIFBT2",10,0)
ADDPAT ;Called when response from MPI is received for messages sent.
"RTN","MPIFBT2",11,0)
 K ^XTMP($J,"MPIF") D NOW^%DTC S ST=%,X1=ST,X2=20 D C^%DTC
"RTN","MPIFBT2",12,0)
 S STP=X,^XTMP($J,"MPIF","MPIIN",0)=STP_"^"_ST_"^"_"MPI BATCH JOB"
"RTN","MPIFBT2",13,0)
 K %,X,Y,X1,X2,ST,STP N RGLOG,MPIMSG S MPIMSG=HLMTIEN
"RTN","MPIFBT2",14,0)
 D START^RGHLLOG(HLMTIEN,"","ADDPAT^MPIFBT2")
"RTN","MPIFBT2",15,0)
 D PREPMSG,PROCESS(MPIMSG),STOP^RGHLLOG(0)
"RTN","MPIFBT2",16,0)
 K ACK1,ACK2,ACK3,ACK4,HDR,MPICKG,MPIIN,MPIIPPF,MPIIT,MPINUM,MPIPPF,DA
"RTN","MPIFBT2",17,0)
 K CNTR,COM,ENC,ESC,LOCAL,MSHDR,PATID,REP,SCOM,SEP,SITE,MPIDTH,VISTDTH,MPITMP,MPICNTR,MPIFOK,^XTMP($J,"MPIF")
"RTN","MPIFBT2",18,0)
 Q
"RTN","MPIFBT2",19,0)
PREPMSG ;prepare for response
"RTN","MPIFBT2",20,0)
 N I,J,X F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFBT2",21,0)
 .S ^XTMP($J,"MPIF","MPIIN",I)=HLNODE,J=0
"RTN","MPIFBT2",22,0)
 .F  S J=$O(HLNODE(J))  Q:'J  S ^XTMP($J,"MPIF","MPIIN",I,J)=HLNODE(J)
"RTN","MPIFBT2",23,0)
 Q
"RTN","MPIFBT2",24,0)
PROCESS(MPIMSG) ;Process mesage out of array
"RTN","MPIFBT2",25,0)
 N HDR,MPICNTR S MPICNTR=1,HDR=^XTMP($J,"MPIF","MPIIN",1) ;check hdr here
"RTN","MPIFBT2",26,0)
 D CHDR(HDR,.SEP,MPICNTR,MPIMSG)
"RTN","MPIFBT2",27,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",28,0)
 F  S MPICNTR=$O(^XTMP($J,"MPIF","MPIIN",MPICNTR)) Q:'MPICNTR  D LOOPS(.MPICNTR,SEP,MPIMSG)
"RTN","MPIFBT2",29,0)
 Q
"RTN","MPIFBT2",30,0)
LOOPS(CNTR,SEP,MPIMSG) ;Loop in the batch
"RTN","MPIFBT2",31,0)
 K ^XTMP($J,"MPIF","MSHERR") N MSHDR,ACK1,ACK2,ACK3,ACK4,ACK5,PATID,LOCAL,MPITMP,LICN
"RTN","MPIFBT2",32,0)
 S MSHDR=^XTMP($J,"MPIF","MPIIN",+CNTR)
"RTN","MPIFBT2",33,0)
 D CHKMSH(MSHDR,.SITE,SEP,MPIMSG)
"RTN","MPIFBT2",34,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",35,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",36,0)
 S ACK1=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",37,0)
 I $P(ACK1,SEP)'="MSA" S ^XTMP($J,"MPIF","MSHERR")="NOT AN MSA SEGMENT" D EXC^RGHLLOG(203,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",38,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",39,0)
 I ACK1["AR" S ^XTMP($J,"MPIF","MSHERR")="APP REJECT ERROR" D EXC^RGHLLOG(207,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",40,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",41,0)
 I ACK1["AE" S ^XTMP($J,"MPIF","MSHERR")="APP ERROR" D EXC^RGHLLOG(208,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",42,0)
 ;ACK1 must be an AA
"RTN","MPIFBT2",43,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",44,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",45,0)
 S ACK2=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",46,0)
 I $P(ACK2,SEP)'="QAK" S ^XTMP($J,"MPIF","MSHERR")="NOT A QAK SEGMENT" D EXC^RGHLLOG(202,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",47,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",48,0)
 I ACK2["NO DATA" D
"RTN","MPIFBT2",49,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NO DATA in MPI "
"RTN","MPIFBT2",50,0)
 .I ACK2["POTENTIAL MATCHES" D
"RTN","MPIFBT2",51,0)
 ..D EXC^RGHLLOG(218,"For Patient DFN="_$P(ACK2,SEP,2)_".  Use Single Patient Initialization to MPI option to manually process.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",52,0)
 ..I $D(^DPT($P(ACK2,SEP,2),0)) S LICN=$$ICNLC^MPIF001($P(ACK2,SEP,2))
"RTN","MPIFBT2",53,0)
 ..; ^ create a local ICN
"RTN","MPIFBT2",54,0)
 .I ACK2'["POTENTIAL MATCHES" D
"RTN","MPIFBT2",55,0)
 ..D EXC^RGHLLOG(209,"For Patient DFN="_$P(ACK2,SEP,2)_".  Need required fields before patient can be processed again the MPI.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",56,0)
 ..I $D(^DPT($P(ACK2,SEP,2),0)) S LICN=$$ICNLC^MPIF001($P(ACK2,SEP,2))
"RTN","MPIFBT2",57,0)
 ..; ^ create a local ICN
"RTN","MPIFBT2",58,0)
 .N TACK,TCNTR S TCNTR=CNTR,CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),TACK=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",59,0)
 .I $P(TACK,SEP)="MSH" S CNTR=TCNTR
"RTN","MPIFBT2",60,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",61,0)
 S PATID=$P(ACK2,SEP,2),LOCAL=$G(^DPT(PATID,0)) ;Verify patient is in database
"RTN","MPIFBT2",62,0)
 I LOCAL']"" S ^XTMP($J,"MPIF","MSHERR")="PATIENT DFN NOT IN DATABASE- BAD " D EXC^RGHLLOG(210,"Around line number "_(CNTR*2)_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT2",63,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",64,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",65,0)
 S ACK3=^XTMP($J,"MPIF","MPIIN",CNTR) ;RDF DEFINITION SEGMENT NO-OP
"RTN","MPIFBT2",66,0)
 I $P(ACK3,SEP)'="RDF" S ^XTMP($J,"MPIF","MSHERR")="NOT RDF SEGMENT" D EXC^RGHLLOG(204,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".",PATID)
"RTN","MPIFBT2",67,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",68,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",69,0)
 S ACK4=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",70,0)
 I $P(ACK4,SEP)'="RDT" S ^XTMP($J,"MPIF","MSHERR")="NOT RDT SEGMENT" D EXC^RGHLLOG(205,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".",PATID)
"RTN","MPIFBT2",71,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",72,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",73,0)
 I MPITMP'>0 S:$E($G(^XTMP($J,"MPIF","MPIIN",MPITMP)),1,3)="BTS" CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",74,0)
 Q:CNTR'>0
"RTN","MPIFBT2",75,0)
 D VFYRDT^MPIFBT3(ACK4,SEP,CNTR,PATID,SITE,MPIMSG)
"RTN","MPIFBT2",76,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",77,0)
 Q:MPITMP'>0
"RTN","MPIFBT2",78,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP)
"RTN","MPIFBT2",79,0)
 I $P(ACK5,SEP)="RDT" D MULT^MPIFBT3(.CNTR,ACK5,SEP,MPIMSG,PATID)
"RTN","MPIFBT2",80,0)
 Q
"RTN","MPIFBT2",81,0)
TFLIST(TFSITE,PATID) ;adding TFSITE site for patient to Treating Facility List (#391.91)
"RTN","MPIFBT2",82,0)
 I $G(TFSITE)="" S ^XTMP($J,"MPIF","MSHERR")="Treating Facility = null" D EXC^RGHLLOG(212,"DFN = "_PATID_" Treating Facility = Null",PATID) Q
"RTN","MPIFBT2",83,0)
 S TFSITE=$$LKUP^XUAF4(TFSITE)
"RTN","MPIFBT2",84,0)
 Q:+TFSITE'>0
"RTN","MPIFBT2",85,0)
 Q:$D(^DGCN(391.91,"APAT",PATID,TFSITE))
"RTN","MPIFBT2",86,0)
 K DD,DO N DIC,X,Y L +^DGCN(391.91,0):60
"RTN","MPIFBT2",87,0)
 I '$T D EXC^RGHLLOG(212,"Unable to Lock Treating Facility file to add patient DFN="_PATID_" Facility= "_TFSITE,PATID) Q
"RTN","MPIFBT2",88,0)
 S DIC="^DGCN(391.91,",DIC("DR")=".02///`"_TFSITE,X=PATID,DIC(0)="LQZ"
"RTN","MPIFBT2",89,0)
 I $D(^DGCN(391.91,"APAT",PATID,TFSITE)) L -^DGCN(391.91,0) Q
"RTN","MPIFBT2",90,0)
 D FILE^DICN L -^DGCN(391.91,0)
"RTN","MPIFBT2",91,0)
 I +Y=-1,'$D(^DGCN(391.91,"APAT",PATID,TFSITE)) S ^XTMP($J,"MPIF","MSHERR")="Treating Facility Add Failed" D EXC^RGHLLOG(212,"DFN= "_PATID_"  Treating Facility= "_TFSITE_"  failed when adding an entry to the Treating Facility file.",PATID)
"RTN","MPIFBT2",92,0)
 K DD,DO,DIC,X,Y
"RTN","MPIFBT2",93,0)
 Q
"RTN","MPIFBT2",94,0)
TFUPDT(PATID,MPIMSG,CNTR) ;treating facility update message to pivot file
"RTN","MPIFBT2",95,0)
 N ERR,TRANS,EVDT,X,Y,%
"RTN","MPIFBT2",96,0)
 D NOW^%DTC S EVDT=% K %,X,Y
"RTN","MPIFBT2",97,0)
 S ERR=$$PIVNW^VAFHPIVT(PATID,EVDT,5,PATID_";DPT(")
"RTN","MPIFBT2",98,0)
 I +ERR<1 D EXC^RGHLLOG(212,"When trying to add Patient (DFN)"_PATID_"   message# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT2",99,0)
 Q:+ERR<1
"RTN","MPIFBT2",100,0)
 D XMITFLAG^VAFCDD01("",+ERR)
"RTN","MPIFBT2",101,0)
 Q
"RTN","MPIFBT2",102,0)
CHDR(HDR,SEP,CNTR,MPIMSG) ;Only process Batch message responses
"RTN","MPIFBT2",103,0)
 I $P(HDR,"^")'="BHS" S ^XTMP($J,"MPIF","MSHERR")="BHS SEGMENT MISSING" D EXC^RGHLLOG(200,"for message "_MPIMSG_".  The segment contains "_HDR)
"RTN","MPIFBT2",104,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",105,0)
 S SEP=$G(HL("FS")) ;get field sep, and encoding characters
"RTN","MPIFBT2",106,0)
 I SEP="" S ^XTMP($J,"MPIF","MSHERR")="Missing field seperator" D EXC^RGHLLOG(200,"Missing field seperator")
"RTN","MPIFBT2",107,0)
 Q
"RTN","MPIFBT2",108,0)
CHKMSH(MSHDR,SITE,SEP,MPIMSG) ;VERIFY MSH
"RTN","MPIFBT2",109,0)
 I $P(MSHDR,SEP)="BTS" S ^XTMP($J,"MPIF","MSHERR")="BTS FOUND" Q
"RTN","MPIFBT2",110,0)
 S:$P(MSHDR,SEP)'="MSH" ^XTMP($J,"MPIF","MSHERR")="NOT MSH HEADER   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",111,0)
 S:$E(MSHDR,4)'=SEP ^XTMP($J,"MPIF","MSHERR")="FIELD SEPARATOR MISMATCH   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",112,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(201,$G(^XTMP($J,"MPIF","MSHERR")))
"RTN","MPIFBT2",113,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",114,0)
 S SITE=$P(MSHDR,SEP,6)
"RTN","MPIFBT2",115,0)
 I SITE="" S ^XTMP($J,"MPIF","MSHERR")="SITE NOT IN MSH"
"RTN","MPIFBT2",116,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(8,"MSH Doesn't Have SITE as 6th piece.   MESSAGE# "_MPIMSG)
"RTN","MPIFBT2",117,0)
 Q
"RTN","MPIFBT3")
0^10^B22489834
"RTN","MPIFBT3",1,0)
MPIFBT3 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,10,17**;30 Apr 99
"RTN","MPIFBT3",3,0)
 ;
"RTN","MPIFBT3",4,0)
 ; Intergration Agreements Utilized:
"RTN","MPIFBT3",5,0)
 ;  ^DPT("AICN", ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFBT3",6,0)
 ;  EXC^RGHLLOG - #2796
"RTN","MPIFBT3",7,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFBT3",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFBT3",9,0)
 ;
"RTN","MPIFBT3",10,0)
MULT(CNTR,ACK5,SEP,MPIMSG,PATID) ;multiple RDT segments
"RTN","MPIFBT3",11,0)
 N NEXTTF,MPITMP S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),NEXTTF=$P(ACK5,SEP,8)
"RTN","MPIFBT3",12,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:MPITMP'>0
"RTN","MPIFBT3",13,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP) K NEXTTF,MPITMP
"RTN","MPIFBT3",14,0)
 I $P(ACK5,SEP)="RDT" D MULT(.CNTR,ACK5,SEP,MPIMSG,PATID) ; ^ add to treating facility list.  If not RDT continue on processing next msh
"RTN","MPIFBT3",15,0)
 Q
"RTN","MPIFBT3",16,0)
VFYRDT(ACK4,SEP,CNTR,PATID,SITE,MPIMSG) ;Here is the meat
"RTN","MPIFBT3",17,0)
 N MPIY,IEN,MPICMOR S DGSENFLG=""
"RTN","MPIFBT3",18,0)
 D FINDHM(PATID,ACK4,SEP,.MPIY,MPIMSG,CNTR)
"RTN","MPIFBT3",19,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",20,0)
 N MPINUM,MPICKG,MPIIT,DR,DIE,X,MPIIPPF,MPIPPF
"RTN","MPIFBT3",21,0)
 S MPINUM=$P(ACK4,SEP,6),MPICKG=$P(MPINUM,"V",2),MPINUM=$P(MPINUM,"V",1)
"RTN","MPIFBT3",22,0)
 ;check if ICN already in use in Patient file
"RTN","MPIFBT3",23,0)
 I $D(^DPT("AICN",MPINUM)) D
"RTN","MPIFBT3",24,0)
 .Q:PATID=$O(^DPT("AICN",MPINUM,""))   ; same patient
"RTN","MPIFBT3",25,0)
 .S ^XTMP($J,"MPIF","MSHERR")="ICN already in use"
"RTN","MPIFBT3",26,0)
 .D EXC^RGHLLOG(227,"Patient dfn "_PATID_" returned ICN "_MPINUM_" that is already in use for Patient dfn "_$O(^DPT("AICN",MPINUM,""))_" Checkout pair to determine if a Duplicate.",PATID)
"RTN","MPIFBT3",27,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",28,0)
 S DIE="^DPT(",DA=$P(MPIY,"^",1),MPIIT=$P(MPIY,"^",1),DR="991.01////^S X=MPINUM;991.02////^S X=MPICKG" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",29,0)
 S IEN=$P(MPIY,"^") ; check if need to kill Local/MISSING ICN field
"RTN","MPIFBT3",30,0)
 I $D(^DPT("AMPIMIS",IEN)) K ^DPT("AMPIMIS",IEN)
"RTN","MPIFBT3",31,0)
 I $D(^DPT("AICNL",1,IEN)) D
"RTN","MPIFBT3",32,0)
 .S DIE="^DPT(",DA=IEN,DR="991.04///@" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",33,0)
 S MPIIPPF=""
"RTN","MPIFBT3",34,0)
 S MPIPPF=$P(ACK4,SEP,5),MPICMOR=$$LKUP^XUAF4(MPIPPF)
"RTN","MPIFBT3",35,0)
 I MPICMOR'="" S MPIIPPF=$$CHANGE^MPIF001(MPIIT,MPICMOR)
"RTN","MPIFBT3",36,0)
 I +MPIIPPF<0 D EXC^RGHLLOG(211,"Around line number "_(CNTR*2)_"  CMOR= "_MPIPPF_" DFN= "_MPIIT_"  MESSAGE# "_MPIMSG,MPIIT)
"RTN","MPIFBT3",37,0)
 Q:+MPIIPPF<0
"RTN","MPIFBT3",38,0)
 D FILE^VAFCTFU(PATID,+$$SITE^VASITE)
"RTN","MPIFBT3",39,0)
 Q
"RTN","MPIFBT3",40,0)
FINDHM(PATID,ACK4,SEP,MPIY,MPIMSG,CNTR) ;LOOKUP
"RTN","MPIFBT3",41,0)
 N DIC,X,Y,NM,YTMP,MPIN
"RTN","MPIFBT3",42,0)
 ;added I to DIC(0) allow processing of sensative patients when DUZ=0
"RTN","MPIFBT3",43,0)
 S DGSENFLG="",DIC="^DPT(",DIC(0)="OISZ",X="`"_PATID D ^DIC K DIC,DGSENFLG
"RTN","MPIFBT3",44,0)
 S YTMP=Y
"RTN","MPIFBT3",45,0)
 I YTMP=-1 S ^XTMP($J,"MPIF","MSHERR")="LOOKUP FAILED" D EXC^RGHLLOG(210,"SSN = "_$P(ACK4,SEP,3)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",46,0)
 Q:YTMP=-1
"RTN","MPIFBT3",47,0)
 S NM=$P(Y(0),"^"),YTMP=$G(Y(0)),MPIY=Y ; check if ICN already populated
"RTN","MPIFBT3",48,0)
 N ICN S ICN=$$GETICN^MPIF001(PATID)
"RTN","MPIFBT3",49,0)
 I +ICN'=-1,$E(+ICN,1,3)'=$P($$SITE^VASITE,"^",3) S ^XTMP($J,"MPIF","MSHERR")="Patient "_PATID_" Already has an ICN"
"RTN","MPIFBT3",50,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",51,0)
 S Y(0)=$G(YTMP)
"RTN","MPIFBT3",52,0)
 Q:$P(Y(0),"^",9)["P"&($P(ACK4,SEP,3)="")
"RTN","MPIFBT3",53,0)
 I $P(Y(0),"^",9)'=$P(ACK4,SEP,3) D
"RTN","MPIFBT3",54,0)
 .S ^XTMP($J,"MPIF","MSHERR")="SSN MISMATCH"
"RTN","MPIFBT3",55,0)
 .D EXC^RGHLLOG(213,"SSN on File = "_$P(Y(0),"^",9)_" SSN in Message = "_$P(ACK4,SEP,3)_"    MESSAGE # "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",56,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ; create local ICN
"RTN","MPIFBT3",57,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",58,0)
 D NAME^VAFCPID2(0,.NM,0) ; reformat name in DG 149 fashion for comparison
"RTN","MPIFBT3",59,0)
 S MPIN=$P(ACK4,SEP,2)_","_$P(ACK4,SEP,7)
"RTN","MPIFBT3",60,0)
 I $P(ACK4,SEP,10)'="" S MPIN=MPIN_" "_$P(ACK4,SEP,10)
"RTN","MPIFBT3",61,0)
 I NM'=MPIN D
"RTN","MPIFBT3",62,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NAME MISMATCH"
"RTN","MPIFBT3",63,0)
 .D EXC^RGHLLOG(214,"Name on File = "_$P(Y(0),"^")_"  Name in Message = "_MPIN_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",64,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ;create local ICN
"RTN","MPIFBT3",65,0)
 ;check to see if MPI has Date of Death or if VistA has DOD
"RTN","MPIFBT3",66,0)
 N MPIDTH,VISTDTH
"RTN","MPIFBT3",67,0)
 I $P(ACK4,SEP,9)'="" S MPIDTH=$P(ACK4,SEP,9),MPIDTH=$$FMDATE^HLFNC(MPIDTH)\1
"RTN","MPIFBT3",68,0)
 I $D(^DPT(PATID,.35)),$P($G(^DPT(PATID,.35)),"^")'="" S VISTDTH=$P($G(^DPT(PATID,.35)),"^")\1
"RTN","MPIFBT3",69,0)
 I $D(MPIDTH)&$D(VISTDTH),MPIDTH'=VISTDTH D
"RTN","MPIFBT3",70,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y,Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",71,0)
 .D EXC^RGHLLOG(217,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",72,0)
 ; ^ BOTH HAVE DOD BUT THEY DON'T MATCH
"RTN","MPIFBT3",73,0)
 I '$D(MPIDTH)&($D(VISTDTH)) D
"RTN","MPIFBT3",74,0)
 .N Y S Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",75,0)
 .D EXC^RGHLLOG(216,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",76,0)
 ; ^ VISTA HAS DOD BUT MPI DOESN'T
"RTN","MPIFBT3",77,0)
 I $D(MPIDTH)&('$D(VISTDTH)) D
"RTN","MPIFBT3",78,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y
"RTN","MPIFBT3",79,0)
 .D EXC^RGHLLOG(215,"Around line "_(CNTR*2)_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",80,0)
 ; ^ MPI HAS DOD BUT VISTA DOESN'T
"RTN","MPIFBT3",81,0)
 Q
"RTN","MPIFDEL")
0^8^B17855631
"RTN","MPIFDEL",1,0)
MPIFDEL ;SF/MJM,CMC-DELETE PATIENT FROM MPI ;JUL 14, 1998
"RTN","MPIFDEL",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,9,19,17**;30 Apr 99
"RTN","MPIFDEL",3,0)
 ;
"RTN","MPIFDEL",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFDEL",5,0)
 ; ^DPT(         - IA #2070
"RTN","MPIFDEL",6,0)
 ; $$EN^VAFCPID  - IA #3015
"RTN","MPIFDEL",7,0)
 ; START^RGHLLOG - IA #2796
"RTN","MPIFDEL",8,0)
 ; EXC^RGHLLOG   - IA #2796
"RTN","MPIFDEL",9,0)
 ; STOP^RGHLLOG  - IA #2796
"RTN","MPIFDEL",10,0)
 ; $$DELALLTF^VAFCTFU  - IA #2988
"RTN","MPIFDEL",11,0)
 ; $$EN^VAFCPID  - IA #3015
"RTN","MPIFDEL",12,0)
 ;
"RTN","MPIFDEL",13,0)
INTER ;
"RTN","MPIFDEL",14,0)
 ;Entry point for Inactivate Patient from MPI option [MPIF PAT INACT]
"RTN","MPIFDEL",15,0)
 ;No input or output variables ^DPT
"RTN","MPIFDEL",16,0)
 N DIC,DA,DFN,HL,ERROR,CNT,HLRST,ICN,DATE,MPIFCMOR,DTOUT,DUTOUT
"RTN","MPIFDEL",17,0)
 S ERROR=""
"RTN","MPIFDEL",18,0)
 S DIC=2,DIC(0)="QEAM" D ^DIC Q:+Y<0  S DFN=+Y
"RTN","MPIFDEL",19,0)
 S ICN=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFDEL",20,0)
 I ICN=""!(ICN=-1) W !,"** Patient Does NOT have an ICN **" Q
"RTN","MPIFDEL",21,0)
 S MPIFCMOR=+$$LKUP^XUAF4(+$$GETVCCI^MPIF001(DFN))
"RTN","MPIFDEL",22,0)
 I MPIFCMOR=0 W !,"*** Could NOT Inactivate Patient from MPI: Coordinating Master of Record is Not Defined ***" Q
"RTN","MPIFDEL",23,0)
 I $$PAT^MPIFNQ(DFN)'=+$P($$SITE^VASITE,"^",3) W !,"*** Could NOT Inactivate Patient from MPI: Coordinating Master of record site is '"_$$CMOR2^MPIF001(DFN)_"'. You MUST be the CMOR ***" Q
"RTN","MPIFDEL",24,0)
 S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFDEL",25,0)
 ;ask user if they are sure
"RTN","MPIFDEL",26,0)
 N DIR,Y S DIR(0)="Y",DIR("B")="No"
"RTN","MPIFDEL",27,0)
 S DIR("A")="Are you sure you want to Inactivate this Patient?"
"RTN","MPIFDEL",28,0)
 D ^DIR
"RTN","MPIFDEL",29,0)
 K DIR
"RTN","MPIFDEL",30,0)
 Q:$D(DTOUT)!($D(DUTOUT))!('Y)
"RTN","MPIFDEL",31,0)
 D HL7(DFN,.ERROR)
"RTN","MPIFDEL",32,0)
 I ERROR="" D DELETE(DFN) S ERROR=$$DELALLTF^VAFCTFU(+ICN),ERROR=""
"RTN","MPIFDEL",33,0)
 I ERROR=""!(ERROR=0) W !,"*** Inactivated on YOUR system, message sent to MPI to Inactivate ***"
"RTN","MPIFDEL",34,0)
 I ERROR'="" W !,"Error Occurred - "_ERROR
"RTN","MPIFDEL",35,0)
 Q
"RTN","MPIFDEL",36,0)
 ;
"RTN","MPIFDEL",37,0)
HL7(DFN,ERROR) ; create HL7 message
"RTN","MPIFDEL",38,0)
 ; check if no subscribers
"RTN","MPIFDEL",39,0)
 N SUB,HL,CNT,ICN,%,HLDATE
"RTN","MPIFDEL",40,0)
 K HLL
"RTN","MPIFDEL",41,0)
 Q:$E($$GETICN^MPIF001(DFN),1,3)=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFDEL",42,0)
 ; ^ don't generate HL7 message if local ICN
"RTN","MPIFDEL",43,0)
 S SUB=$P($G(^DPT(DFN,"MPI")),"^",5)
"RTN","MPIFDEL",44,0)
 I SUB'="" D GET^HLSUB(SUB,"","MPIF A29 SERVER",.HLL) I $D(HLL) S ERROR="Attempted to Inactivate an ICN and Patient is Shared.  Can't Inactivate patient DFN= "_DFN Q
"RTN","MPIFDEL",45,0)
 S ICN=+$$ICN^MPIFNQ(DFN)
"RTN","MPIFDEL",46,0)
 D NOW^%DTC S HLDATE=$$HLDATE^HLFNC(%,"DT")
"RTN","MPIFDEL",47,0)
 S HL=0,CNT=0
"RTN","MPIFDEL",48,0)
 D INIT^HLFNC2("MPIF A29 SERVER",.HL)
"RTN","MPIFDEL",49,0)
 I HL S ERROR="ERROR = "_HL_" During INIT^HLFNC2 for MPIF A29 Server for Patient DFN= "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",50,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A29"_HL("FS")_HLDATE_HL("FS")_HL("FS")_""_HL("FS")
"RTN","MPIFDEL",51,0)
 S CNT=CNT+1,HLA("HLS",CNT)=$$EN^VAFCPID(DFN,"2,3,5")
"RTN","MPIFDEL",52,0)
 ; message only goes to MPI Link
"RTN","MPIFDEL",53,0)
 D GENERATE^HLMA("MPIF A29 SERVER","LM",1,.HLRST,"",.HL)
"RTN","MPIFDEL",54,0)
 I 'HLRST S ERROR="Error During Generate for MPIF A29 Server Error= "_HLRST_" for dfn "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",55,0)
 Q
"RTN","MPIFDEL",56,0)
 ;
"RTN","MPIFDEL",57,0)
PAT1 ;entry point for tasked job from .01 in Patient file for ZZ patients
"RTN","MPIFDEL",58,0)
 N ERR
"RTN","MPIFDEL",59,0)
 S ERR=""
"RTN","MPIFDEL",60,0)
 D PAT(DA,.ERR)
"RTN","MPIFDEL",61,0)
 S ZTREQ="@"
"RTN","MPIFDEL",62,0)
 Q
"RTN","MPIFDEL",63,0)
 ;
"RTN","MPIFDEL",64,0)
PAT(DFN,ERROR) ;Programmer API to Delete MPI entry and remove ICN data from DPT
"RTN","MPIFDEL",65,0)
 S ERROR=""
"RTN","MPIFDEL",66,0)
 I $G(DFN)="" S ERROR="DFN not defined" Q
"RTN","MPIFDEL",67,0)
 I +$$PAT^MPIFNQ(DFN)'=+$P($$SITE^VASITE,"^",3) S ERROR="Attempt to Inactivate Patient, DFN= "_DFN_" this site is not the CMOR for this patient" D EXC(DFN,ERROR,226) Q
"RTN","MPIFDEL",68,0)
 D HL7(DFN,.ERROR)
"RTN","MPIFDEL",69,0)
 I ERROR="" S ERROR=$$DELALLTF^VAFCTFU(+$$GETICN^MPIF001(DFN)),ERROR="" D DELETE(DFN)
"RTN","MPIFDEL",70,0)
 Q
"RTN","MPIFDEL",71,0)
DELETE(DFN) ;
"RTN","MPIFDEL",72,0)
 N FDA,ERRORS
"RTN","MPIFDEL",73,0)
 Q:DFN=""
"RTN","MPIFDEL",74,0)
 S FDA(2,DFN_",",991.01)="@",FDA(2,DFN_",",991.02)="@",FDA(2,DFN_",",991.03)="@",FDA(2,DFN_",",991.04)="@"
"RTN","MPIFDEL",75,0)
 D FILE^DIE("K","FDA","ERRORS(1)")
"RTN","MPIFDEL",76,0)
 Q
"RTN","MPIFDEL",77,0)
 ;
"RTN","MPIFDEL",78,0)
EXC(DFN,ERROR,TYPE) ; subscribers, log exception
"RTN","MPIFDEL",79,0)
 D START^RGHLLOG(0)
"RTN","MPIFDEL",80,0)
 D EXC^RGHLLOG(TYPE,ERROR,$G(DFN))
"RTN","MPIFDEL",81,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFDEL",82,0)
 Q
"RTN","MPIFDEL",83,0)
 ;
"RTN","MPIFDEL",84,0)
ZZSET(DA,NAME) ;this entry point checks to see if .01 of Patient file entry
"RTN","MPIFDEL",85,0)
 ;starts with at least two Zs
"RTN","MPIFDEL",86,0)
 ;if it does and an ICN is present, it will be inactivated
"RTN","MPIFDEL",87,0)
 ;
"RTN","MPIFDEL",88,0)
 Q:$E(NAME,1,2)'="ZZ"
"RTN","MPIFDEL",89,0)
 ;task inactivation off
"RTN","MPIFDEL",90,0)
 I +$$GETICN^MPIF001(DA)>0 D
"RTN","MPIFDEL",91,0)
 .S ZTRTN="PAT1^MPIFDEL",ZTDESC="Inactivate ICN for 'ZZ'd patient"
"RTN","MPIFDEL",92,0)
 .S ZTIO="",ZTSAVE("DA")=DA,ZTSAVE("NAME")=NAME
"RTN","MPIFDEL",93,0)
 .S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFDEL",94,0)
 .D ^%ZTLOAD
"RTN","MPIFDEL",95,0)
 .K ZTRTN,ZTDESC,ZTIO,ZTSAVE,ZTDTH,ZTREQ
"RTN","MPIFDEL",96,0)
 Q
"RTN","MPIFDEL",97,0)
ZZKILL(DA,NAME) ;This entry point checks if there is an ICN present, if so
"RTN","MPIFDEL",98,0)
 ;if will be inactivated, following the inactivate rules
"RTN","MPIFDEL",99,0)
 N ERR S ERR=""
"RTN","MPIFDEL",100,0)
 I +$$GETICN^MPIF001(DA)>0 D PAT(DA,.ERR)
"RTN","MPIFDEL",101,0)
 Q
"RTN","MPIFQ0")
0^3^B70291821
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,14,13,16,17**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
 ; Integration Agreements utilized:
"RTN","MPIFQ0",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFQ0",6,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFQ0",7,0)
 ;  $$SEND2^VAFCUTL1- #2779
"RTN","MPIFQ0",8,0)
 ;  $$SEND^RGJUSITE - #3469
"RTN","MPIFQ0",9,0)
 ;  $$EN^HLCSAS - #3471
"RTN","MPIFQ0",10,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFQ0",11,0)
 ;
"RTN","MPIFQ0",12,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",13,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",14,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",15,0)
 S MPIFRES="",MPIFINT="",DIC="^DPT(",DIC(0)="AEMQ" D ^DIC
"RTN","MPIFQ0",16,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",17,0)
 S DFN=+Y,HLP("ACKTIME")=300
"RTN","MPIFQ0",18,0)
 W !
"RTN","MPIFQ0",19,0)
CIRNEXC ; Exception Entry Point
"RTN","MPIFQ0",20,0)
 I $$SEND^RGJUSITE'>0 W !,"MPI/PD Messaging Parameter Not Enabled" G END
"RTN","MPIFQ0",21,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",22,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",23,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",24,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",25,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N W !,"Patient is missing Date of Birth -- Required Field" D LOCAL(DFN) G END
"RTN","MPIFQ0",26,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",27,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W !,"Patient already has an ICN" G END
"RTN","MPIFQ0",28,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 W !,"Patient should not be sent to the MPI -- SSN has 5 leading 0s or name has been ZZ'd" G END
"RTN","MPIFQ0",29,0)
 S HLP("ACKTIME")=300,MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",30,0)
 G JUMP
"RTN","MPIFQ0",31,0)
VTQ G:$G(DFN)']"" END
"RTN","MPIFQ0",32,0)
 I $$SEND^RGJUSITE'>0 S MPIFRTN="STOP/SUSPEND" G END
"RTN","MPIFQ0",33,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",34,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",35,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",36,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S MPIFRTN="MISSING DOB" D EXC^MPIFVTQ(DFN) G END
"RTN","MPIFQ0",37,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",38,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",39,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S MPIFRTN="TEST" G END
"RTN","MPIFQ0",40,0)
JUMP N TIME,% D NOW^%DTC S TIME=%
"RTN","MPIFQ0",41,0)
 ;Initialization for call to MPIVTQ
"RTN","MPIFQ0",42,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,MPIDC
"RTN","MPIFQ0",43,0)
 I $G(HLP("ACKTIME"))="" S HLP("ACKTIME")=30 ;If the HLP("ACKTIME") is not already set for the D/C
"RTN","MPIFQ0",44,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",45,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",46,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",47,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM,"00108.1;00108.2;00110;00122")
"RTN","MPIFQ0",48,0)
 ;If call to VTQ1^MPIFVTQ returns '-1^error code', log error and exit
"RTN","MPIFQ0",49,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",50,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0)),MPIFRTN="CONTINUE"
"RTN","MPIFQ0",51,0)
 . I '$D(MPIFS) W !!,"Patient should NOT be sent to the MPI for ICN assignment"
"RTN","MPIFQ0",52,0)
 ;Create MSH
"RTN","MPIFQ0",53,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1,HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",54,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",55,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",56,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFQ0",57,0)
 I '$D(MPIFS) W !!,"Attempting to connect to the Master Patient Index in Austin...",!,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFQ0",58,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFQ0",59,0)
 K HLP("ACKTIME") ;kill the HLP array set for the ack timeout
"RTN","MPIFQ0",60,0)
 ;Can't connect to MPI, assign a local ICN, this site as CMOR, and continue with Registration
"RTN","MPIFQ0",61,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",62,0)
 . S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",63,0)
 . I '$D(MPIFS) W !!,"Could not connect to MPI or Timed Out, assigning local ICN (if not already assigned)..."
"RTN","MPIFQ0",64,0)
 . D LOCAL(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",65,0)
 K ^TMP("MPIFQ0",$J) ;this is the array the data is parsed into for display in list manager
"RTN","MPIFQ0",66,0)
INIPARS N SEG,INDEX,COUNTER,LASTSSN,FIRST
"RTN","MPIFQ0",67,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFQ0",68,0)
PARSE S SEG=$$SEG^MPIFAPI("RDT",1,"RDT")
"RTN","MPIFQ0",69,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFQ0",70,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,STRING,NAME,TF,ICN,HEREICN,HERESSN,MIDDLE,IEN,F,SUFF,SEX
"RTN","MPIFQ0",71,0)
 . S STRING="",FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2),MIDDLE=$P(SEG,HL("FS"),10),SUFF=$P(SEG,HL("FS"),11)
"RTN","MPIFQ0",72,0)
 . S (LASTSSN,SSN)=$P(SEG,HL("FS"),3),NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFQ0",73,0)
 . I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFQ0",74,0)
 . I SUFF'="" S NAME=NAME_" "_SUFF
"RTN","MPIFQ0",75,0)
 . S SEX=$P(SEG,HL("FS"),12)
"RTN","MPIFQ0",76,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFQ0",77,0)
 . I $D(FICN) I FICN'=ICN S FIRST=1,FICN=ICN
"RTN","MPIFQ0",78,0)
 . I FIRST=1 S FICN=ICN
"RTN","MPIFQ0",79,0)
 . S FIRST=FIRST+1,CMOR=$P(SEG,HL("FS"),5),CCMOR=CMOR
"RTN","MPIFQ0",80,0)
 . I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",81,0)
 . S TF=$P(SEG,HL("FS"),8)
"RTN","MPIFQ0",82,0)
 . I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",83,0)
 . ;Same patient just adding TF's
"RTN","MPIFQ0",84,0)
 . I TF'="",ICN=FICN,FIRST'=2 S COUNTER=COUNTER+1,^TMP("MPIFQ0",$J,INDEX,COUNTER)=TF
"RTN","MPIFQ0",85,0)
 . Q:(ICN=FICN)&(FIRST>2)
"RTN","MPIFQ0",86,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFQ0",87,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFQ0",88,0)
 . I $G(BIRTHDAY)]"" S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY),BIRTHDAY=$TR($$FMTE^XLFDT(BIRTHDAY,"5D"),"/","-")
"RTN","MPIFQ0",89,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFQ0",90,0)
 . S INDEX=INDEX+1,COUNTER=1,HEREICN=$$HEREICN($P(ICN,"V",1))
"RTN","MPIFQ0",91,0)
 . I HEREICN S STRING=$$SETSTR^VALM1("*",STRING,1,1),^TMP("MPIFQ0",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",92,0)
 . S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4),STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",93,0)
 . S STRING=$$SETSTR^VALM1(SSN,STRING,30,9),STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",94,0)
 . S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",95,0)
 . S ^TMP("MPIFQ0",$J,INDEX,0)=STRING,^TMP("MPIFQ0",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",96,0)
 . S ^TMP("MPIFQ0",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_CCMOR_"^"_SEX
"RTN","MPIFQ0",97,0)
 . S (VALMCNT,VALMLST)=INDEX
"RTN","MPIFQ0",98,0)
DECIDE ;If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFQ0",99,0)
 ;with the VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",100,0)
 I '$D(^TMP("MPIFQ0",$J)) D  G EXIT
"RTN","MPIFQ0",101,0)
 . I '$D(MPIFS) W !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",102,0)
 . D A28(DFN) S MPIFRTN="DID A28"
"RTN","MPIFQ0",103,0)
 ;If INDEX=1 it means we got 1 match. So we check the SSN to see if it's definitely the same patient.
"RTN","MPIFQ0",104,0)
 I (INDEX=1)&(TSSN=LASTSSN) D  G EXIT
"RTN","MPIFQ0",105,0)
 . N CMOR,ICN,DATA,TICN,SNM
"RTN","MPIFQ0",106,0)
 . S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA"),CMOR=CCMOR,ICN=$P(DATA,"^",4)
"RTN","MPIFQ0",107,0)
 . D START^RGHLLOG(0)
"RTN","MPIFQ0",108,0)
 . S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",109,0)
 . I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ0",110,0)
 . I TICN>0&(DFN'=TICN)
"RTN","MPIFQ0",111,0)
 . ; CHECK IF NAME IS SAME - IF NOT POTENTIAL MATCH EXCEPTION
"RTN","MPIFQ0",112,0)
 . S SNM=LOCDATA(2,DFN,.01) D NAME^VAFCPID2(DFN,.SNM,0) ;reformat name to DG 149 standard
"RTN","MPIFQ0",113,0)
 . I $P(DATA,"^")'=SNM D  Q
"RTN","MPIFQ0",114,0)
 ..I $D(MPIFINT) D START^MPIFQ1(INDEX) Q
"RTN","MPIFQ0",115,0)
 ..I '$D(MPIFINT) D LOC2(DFN) Q
"RTN","MPIFQ0",116,0)
 . I '$D(MPIFS) W !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" in MPI, updating ICN and CMOR..."
"RTN","MPIFQ0",117,0)
 . D STOP^RGHLLOG(0),UPDATE(DFN,ICN,CMOR)
"RTN","MPIFQ0",118,0)
 . S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",119,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",120,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",121,0)
 .I '$D(MPIFS) W !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",122,0)
 .D START^RGHLLOG(0),EXC^RGHLLOG(218,"For Patient DFN="_DFN_".  Use Single Patient Initialization to MPI option to manually process.",DFN),STOP^RGHLLOG(0)
"RTN","MPIFQ0",123,0)
 .D LOCAL(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",124,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",125,0)
EXIT ;
"RTN","MPIFQ0",126,0)
 I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",127,0)
 K CCMOR,FICN H 3 W !!
"RTN","MPIFQ0",128,0)
END ;
"RTN","MPIFQ0",129,0)
 K VALMCNT,VALMLST
"RTN","MPIFQ0",130,0)
 Q
"RTN","MPIFQ0",131,0)
A28(DFN) ;
"RTN","MPIFQ0",132,0)
 S ICN=$$GETICN^MPIFRTC(DFN)
"RTN","MPIFQ0",133,0)
 I +ICN>0 I '$D(MPIFS) W !!,"Adding Patient to Master Patient Index..." Q
"RTN","MPIFQ0",134,0)
 I '$D(MPIFS) W !!,"Could not connect to MPI, Assigning Local ICN..."
"RTN","MPIFQ0",135,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",136,0)
 Q
"RTN","MPIFQ0",137,0)
UPDATE(DFN,ICN,CMOR) ;
"RTN","MPIFQ0",138,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG,LOCAL
"RTN","MPIFQ0",139,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",140,0)
 S CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",141,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",142,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",143,0)
 I +SETICN'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0" Q
"RTN","MPIFQ0",144,0)
 S SETLOC=1,LOCAL="N"
"RTN","MPIFQ0",145,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",146,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",147,0)
 I +SETLOC'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0" Q
"RTN","MPIFQ0",148,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",149,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",150,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",151,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFQ0",152,0)
 I +CHANGE'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0" Q
"RTN","MPIFQ0",153,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",154,0)
 N HERE S HERE=+$P($$SITE^VASITE,"^",3) D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ0",155,0)
 Q
"RTN","MPIFQ0",156,0)
LOCAL(DFN) ;
"RTN","MPIFQ0",157,0)
 N ICN
"RTN","MPIFQ0",158,0)
 Q:+$$GETICN^MPIF001(DFN)>0
"RTN","MPIFQ0",159,0)
 S ICN=$$ICNLC^MPIF001(DFN) ;don't assign local if one already exists
"RTN","MPIFQ0",160,0)
 Q
"RTN","MPIFQ0",161,0)
HEREICN(ICN) ;
"RTN","MPIFQ0",162,0)
 N DFN
"RTN","MPIFQ0",163,0)
 Q:$G(ICN)="" 0
"RTN","MPIFQ0",164,0)
 S DFN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",165,0)
 Q:$G(DFN)'>0 0
"RTN","MPIFQ0",166,0)
 Q DFN
"RTN","MPIFQ0",167,0)
GETDATA(DIC,DA,ARRAY,DR,EI) ;
"RTN","MPIFQ0",168,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",169,0)
 ;DIC is the file reference, DA is the file entry IEN, ARRAY is the
"RTN","MPIFQ0",170,0)
 ;storage array for the values to be stored in, DR are the fields
"RTN","MPIFQ0",171,0)
 ;requested, EI is external/internal values of the fields or don't
"RTN","MPIFQ0",172,0)
 ;return null values
"RTN","MPIFQ0",173,0)
 N DIQ S DIQ=ARRAY
"RTN","MPIFQ0",174,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",175,0)
 D EN^DIQ1
"RTN","MPIFQ0",176,0)
 Q
"RTN","MPIFQ0",177,0)
LOC2(DFN) ;
"RTN","MPIFQ0",178,0)
 W !!,"Potential Match Found Assigning Local ICN"
"RTN","MPIFQ0",179,0)
 D START^RGHLLOG(),EXC^RGHLLOG(218,"For Patient DFN="_DFN_" Use Single Patient Initialization to MPI option to manually process",DFN),STOP^RGHLLOG()
"RTN","MPIFQ0",180,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",181,0)
 Q
"RTN","MPIFQ1")
0^6^B44651502
"RTN","MPIFQ1",1,0)
MPIFQ1 ;ALB/RJS-CIRN QUERY HANDLER ;JUN 30, 1997
"RTN","MPIFQ1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,8,12,16,17**;30 Apr 99
"RTN","MPIFQ1",3,0)
 ;
"RTN","MPIFQ1",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFQ1",5,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFQ1",6,0)
 ;   FILE^VAFCTFU - #2988
"RTN","MPIFQ1",7,0)
 ;   ^DPT("AICN" - #2070
"RTN","MPIFQ1",8,0)
 ;   NAME^VAFCPID2 - #3492
"RTN","MPIFQ1",9,0)
 ;
"RTN","MPIFQ1",10,0)
INIT ;Entry point for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",11,0)
 ; It is started from outside of the template.
"RTN","MPIFQ1",12,0)
 Q
"RTN","MPIFQ1",13,0)
HDR ;Header code for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",14,0)
 N SSN,DOB,MPIFQ1,NAME1,SEX
"RTN","MPIFQ1",15,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.03;.09;.02","EI")
"RTN","MPIFQ1",16,0)
 S NAME1=$G(MPIFQ1(2,DFN,.01,"E"))
"RTN","MPIFQ1",17,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E"))
"RTN","MPIFQ1",18,0)
 S DOB=$G(MPIFQ1(2,DFN,.03,"I"))
"RTN","MPIFQ1",19,0)
 S SEX=$G(MPIFQ1(2,DFN,.02,"E"))
"RTN","MPIFQ1",20,0)
 I DOB]"" S DOB=$TR($$FMTE^XLFDT(DOB,"5D"),"/","-")
"RTN","MPIFQ1",21,0)
 S VALMHDR(1)=" Possible MPI Matches for Patient: "_IOINHI_NAME1_IOINORM
"RTN","MPIFQ1",22,0)
 S VALMHDR(2)="                              SSN: "_IOINHI_SSN_IOINORM
"RTN","MPIFQ1",23,0)
 S VALMHDR(3)="                              DOB: "_IOINHI_DOB_IOINORM
"RTN","MPIFQ1",24,0)
 S VALMHDR(4)="                              SEX: "_IOINHI_SEX_IOINORM
"RTN","MPIFQ1",25,0)
 S VALMHDR(5)=" "
"RTN","MPIFQ1",26,0)
 Q
"RTN","MPIFQ1",27,0)
START(INDEX) ;
"RTN","MPIFQ1",28,0)
 ;Starting entry point for envoking the List Manager Template MPIF Real-time query
"RTN","MPIFQ1",29,0)
 S VALMCNT=INDEX
"RTN","MPIFQ1",30,0)
 D EN^VALM("MPIF REAL-TIME QUERY")
"RTN","MPIFQ1",31,0)
 Q
"RTN","MPIFQ1",32,0)
SELECT ;
"RTN","MPIFQ1",33,0)
 N VALMY
"RTN","MPIFQ1",34,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",35,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",36,0)
 N DATA,INDEX,ICN,CHKSUM,NODE2,HERESSN
"RTN","MPIFQ1",37,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",38,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ1",39,0)
 S NODE2=$G(^TMP("MPIFQ0",$J,INDEX,"INDICATOR"))
"RTN","MPIFQ1",40,0)
 S DATA(.01)=$P(DATA,"^",1) I $E(DATA(.01),$L(DATA(.01)))=" " S DATA(.01)=$E(DATA(.01),1,$L(DATA(.01))-1) ;NAME
"RTN","MPIFQ1",41,0)
 S DATA(.03)=$P(DATA,"^",3) ;DOB
"RTN","MPIFQ1",42,0)
 S DATA(.09)=$P(DATA,"^",2) ;SSN
"RTN","MPIFQ1",43,0)
 S DATA(.02)=$P(DATA,"^",8) ;SEX
"RTN","MPIFQ1",44,0)
 S ICN=$P(DATA,"^",4)
"RTN","MPIFQ1",45,0)
 S CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ1",46,0)
 S ICN=$P(ICN,"V",1) ;ICN
"RTN","MPIFQ1",47,0)
 S DATA(991.01)=ICN
"RTN","MPIFQ1",48,0)
 S DATA(991.02)=CHKSUM ;CHKSUM
"RTN","MPIFQ1",49,0)
 S DATA(991.03)=$P(DATA,"^",7) ;CMOR
"RTN","MPIFQ1",50,0)
 ;
"RTN","MPIFQ1",51,0)
 ;If NODE2["*" it means we got a match on ICN for a patient in our
"RTN","MPIFQ1",52,0)
 ;list, with a patient in our local database. Since we don't allow more 
"RTN","MPIFQ1",53,0)
 ;than one patient to have the same ICN, we log an Exception and assign 
"RTN","MPIFQ1",54,0)
 ;a Local ICN for this patient.
"RTN","MPIFQ1",55,0)
 ;
"RTN","MPIFQ1",56,0)
 I NODE2["*",$O(^DPT("AICN",ICN,""))'=DFN D  Q
"RTN","MPIFQ1",57,0)
 . D CLEAR^VALM1
"RTN","MPIFQ1",58,0)
 . D MSG1
"RTN","MPIFQ1",59,0)
 . D START^RGHLLOG()
"RTN","MPIFQ1",60,0)
 . D EXC^RGHLLOG(227,"Attempted to assign same ICN to Patient DFN "_DFN_". ICN is already used for Name: "_DATA(.01)_" SSN: "_DATA(.09)_" DOB: "_DATA(.03)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ1",61,0)
 . D STOP^RGHLLOG(0)
"RTN","MPIFQ1",62,0)
 . W !!,"Assigning Local ICN"
"RTN","MPIFQ1",63,0)
 . D LOCAL^MPIFQ0(DFN)
"RTN","MPIFQ1",64,0)
 . D PROMPT
"RTN","MPIFQ1",65,0)
 . S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",66,0)
 ;
"RTN","MPIFQ1",67,0)
 ;User selected one from the list that doesn't exist already in this
"RTN","MPIFQ1",68,0)
 ; Patient file. 
"RTN","MPIFQ1",69,0)
 ;Does SSN and Name match?  If no - ask if they are sure before 
"RTN","MPIFQ1",70,0)
 ;updating ICN and CMOR fields
"RTN","MPIFQ1",71,0)
 ;
"RTN","MPIFQ1",72,0)
 N SSN,NAME,SEX
"RTN","MPIFQ1",73,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.09;.02","EI")
"RTN","MPIFQ1",74,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E")),NAME=$G(MPIFQ1(2,DFN,.01,"E"))
"RTN","MPIFQ1",75,0)
 S SEX=$G(MPIFQ1(2,DFN,.02,"I"))
"RTN","MPIFQ1",76,0)
 ; if sex doesn't match -- not allowed to update ICN
"RTN","MPIFQ1",77,0)
 I DATA(.02)'=SEX W !!,"Sex for these two patients doesn't match -- Can't select this patient until",!,"Sex matches between the MPI and your site.  No action will be taken." D PROMPT S VALMBCK="R" Q
"RTN","MPIFQ1",78,0)
 I SSN["P" S SSN=""
"RTN","MPIFQ1",79,0)
 I DATA(.09)'=SSN W !!,"SSN for these two patients doesn't match -- Can't select this patient until",!,"SSN matches between the MPI and your site.  No action will be taken." D PROMPT S VALMBCK="R" Q
"RTN","MPIFQ1",80,0)
 ;Name, SSN and Sex match on site and MPI -- Update ICN and CMOR
"RTN","MPIFQ1",81,0)
 D NAME^VAFCPID2(0,.NAME,0) ;reformat name into DG 149 format
"RTN","MPIFQ1",82,0)
 I DATA(.01)=NAME K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") D MSG3,PROMPT,TF(DFN,.DATA) Q
"RTN","MPIFQ1",83,0)
 ;
"RTN","MPIFQ1",84,0)
 ;Name doesn't match exactly - ask if sure
"RTN","MPIFQ1",85,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",86,0)
 D MSG2
"RTN","MPIFQ1",87,0)
 D MSG(SSN,NAME,DATA(.09),DATA(.01))
"RTN","MPIFQ1",88,0)
 N ANS
"RTN","MPIFQ1",89,0)
 S ANS=$$PROMPT1()
"RTN","MPIFQ1",90,0)
 I ANS K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") S MPIFRTN="CONTINUE" W !!,"ICN and CMOR Updated" D PROMPT,TF(DFN,.DATA) Q
"RTN","MPIFQ1",91,0)
 D MSG5,PROMPT
"RTN","MPIFQ1",92,0)
 S VALMBCK="R"
"RTN","MPIFQ1",93,0)
 ;
"RTN","MPIFQ1",94,0)
 Q
"RTN","MPIFQ1",95,0)
 ;
"RTN","MPIFQ1",96,0)
 ;
"RTN","MPIFQ1",97,0)
ADD ;
"RTN","MPIFQ1",98,0)
 ;Add List Manager Action (MPIF REAL-TIME QUERY (ADD PATIENT)) to add
"RTN","MPIFQ1",99,0)
 ; patient to the MPI Austin.
"RTN","MPIFQ1",100,0)
 D A28^MPIFQ0(DFN)
"RTN","MPIFQ1",101,0)
 D MSG3,PROMPT
"RTN","MPIFQ1",102,0)
 S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",103,0)
 Q
"RTN","MPIFQ1",104,0)
 ;
"RTN","MPIFQ1",105,0)
HELP ; Help List Manager Action (MPIF REAL-TIME QUERY (HELP))
"RTN","MPIFQ1",106,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",107,0)
 D MSG4
"RTN","MPIFQ1",108,0)
 D PROMPT
"RTN","MPIFQ1",109,0)
 S VALMBCK="R"
"RTN","MPIFQ1",110,0)
 Q
"RTN","MPIFQ1",111,0)
 ;
"RTN","MPIFQ1",112,0)
MSG(LOCSSN,LOCNAME,MPISSN,MPINAME) ;
"RTN","MPIFQ1",113,0)
 ;
"RTN","MPIFQ1",114,0)
 W !!!,"Local SSN = "_LOCSSN,?35,"MPI SSN = "_MPISSN
"RTN","MPIFQ1",115,0)
 W !,"Local NAME = "_LOCNAME,?40,"MPI NAME = "_MPINAME
"RTN","MPIFQ1",116,0)
 Q
"RTN","MPIFQ1",117,0)
 ;
"RTN","MPIFQ1",118,0)
MSG3 ;
"RTN","MPIFQ1",119,0)
 W !!,"Updating ICN and CMOR"
"RTN","MPIFQ1",120,0)
 Q
"RTN","MPIFQ1",121,0)
MSG1 ;
"RTN","MPIFQ1",122,0)
 W !!,"You are attempting to assign an ICN that has already been assigned"
"RTN","MPIFQ1",123,0)
 W !,"to another patient in your Patient file."
"RTN","MPIFQ1",124,0)
 W !,"An exception will be recorded noting that these 2 patients "
"RTN","MPIFQ1",125,0)
 W !,"need to be reviewed to determine if they are duplicates."
"RTN","MPIFQ1",126,0)
 Q
"RTN","MPIFQ1",127,0)
MSG2 ;
"RTN","MPIFQ1",128,0)
 W !!,"You have selected a patient from the list of potential matches"
"RTN","MPIFQ1",129,0)
 W !," where the Name is different than what the MPI has."
"RTN","MPIFQ1",130,0)
 W !," Are you sure this is the correct patient?"
"RTN","MPIFQ1",131,0)
 Q
"RTN","MPIFQ1",132,0)
 ;
"RTN","MPIFQ1",133,0)
MSG5 ;
"RTN","MPIFQ1",134,0)
 W !!,"No Action Taken"
"RTN","MPIFQ1",135,0)
 Q
"RTN","MPIFQ1",136,0)
MSG4 ;
"RTN","MPIFQ1",137,0)
 W !!,"When you have reached MPI QUERY RESULTS screen, the software has"
"RTN","MPIFQ1",138,0)
 W !,"queried the Master Patient Index, for possible matches to the patient"
"RTN","MPIFQ1",139,0)
 W !,"you are adding, or selected (pre-existing record)."
"RTN","MPIFQ1",140,0)
 W !!,"The MPI has returned a list of possible matches for that patient"
"RTN","MPIFQ1",141,0)
 W !,"An '*' indicates the Integration Control Number of a patient"
"RTN","MPIFQ1",142,0)
 W !,"on the list, matches one in your Patient file already."
"RTN","MPIFQ1",143,0)
 W !,"To select a patient from the list, choose SP."
"RTN","MPIFQ1",144,0)
 W !,"If the patients listed as potential matches aren't the same patient"
"RTN","MPIFQ1",145,0)
 W !,"select ADD to create a new entry on the MPI for this patient"
"RTN","MPIFQ1",146,0)
 Q
"RTN","MPIFQ1",147,0)
 ;
"RTN","MPIFQ1",148,0)
PROMPT ;
"RTN","MPIFQ1",149,0)
 W !!
"RTN","MPIFQ1",150,0)
 S DIR("A")="Hit the Enter key, to Continue "
"RTN","MPIFQ1",151,0)
 S DIR(0)="EA"
"RTN","MPIFQ1",152,0)
 D ^DIR
"RTN","MPIFQ1",153,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",154,0)
 Q
"RTN","MPIFQ1",155,0)
PROMPT1() ;
"RTN","MPIFQ1",156,0)
 N DIR,X,Y
"RTN","MPIFQ1",157,0)
 W !
"RTN","MPIFQ1",158,0)
 S DIR("A")="Are you sure this is the correct patient? Enter YES or NO "
"RTN","MPIFQ1",159,0)
 S DIR(0)="YA"
"RTN","MPIFQ1",160,0)
 D ^DIR
"RTN","MPIFQ1",161,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",162,0)
 Q Y
"RTN","MPIFQ1",163,0)
HERESSN(SSN) ;
"RTN","MPIFQ1",164,0)
 N DFN
"RTN","MPIFQ1",165,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ1",166,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ1",167,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ1",168,0)
 Q DFN
"RTN","MPIFQ1",169,0)
 ;
"RTN","MPIFQ1",170,0)
CHECK(DFN) ;
"RTN","MPIFQ1",171,0)
 N CHECK
"RTN","MPIFQ1",172,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"CHECK",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ1",173,0)
 I $G(CHECK(2,DFN,.01))']"" Q 0
"RTN","MPIFQ1",174,0)
 I $G(CHECK(2,DFN,.02))']"" Q 0
"RTN","MPIFQ1",175,0)
 I $G(CHECK(2,DFN,.03))']"" Q 0
"RTN","MPIFQ1",176,0)
 I $G(CHECK(2,DFN,.09))']"" Q 0
"RTN","MPIFQ1",177,0)
 I $G(CHECK(2,DFN,.301))']"" Q 0
"RTN","MPIFQ1",178,0)
 I $G(CHECK(2,DFN,391))']"" Q 0
"RTN","MPIFQ1",179,0)
 I $G(CHECK(2,DFN,1901))']"" Q 0
"RTN","MPIFQ1",180,0)
 Q 1
"RTN","MPIFQ1",181,0)
 ;
"RTN","MPIFQ1",182,0)
EXIT ;Exit for List Manager Template MPIF REAL-TIME QUERY
"RTN","MPIFQ1",183,0)
 K VALMBCK,VALMCNT,VALMHDR
"RTN","MPIFQ1",184,0)
 Q
"RTN","MPIFQ1",185,0)
 ;
"RTN","MPIFQ1",186,0)
TF(DFN,ARR) ;Add you to TF list and trigger TF and Sub msgs
"RTN","MPIFQ1",187,0)
 N SITE
"RTN","MPIFQ1",188,0)
 S SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFQ1",189,0)
 I $$PATCH^XPDUTL("DG*5.3*261") D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ1",190,0)
 Q
"RTN","MPIFRES")
0^1^B12887670
"RTN","MPIFRES",1,0)
MPIFRES ;SF/CMC-LOCAL AND MISSING ICN RESOLUTION ;JUL 13, 1998
"RTN","MPIFRES",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,7,10,15,17**;30 Apr 99
"RTN","MPIFRES",3,0)
 ;
"RTN","MPIFRES",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFRES",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFRES",6,0)
 ;  ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFRES",7,0)
 ;  ^RGHL7(991.1 - #3259
"RTN","MPIFRES",8,0)
 ;
"RTN","MPIFRES",9,0)
BKG ;
"RTN","MPIFRES",10,0)
 S ZTRTN="GO^MPIFRES",ZTDESC="USE HL7 MSGS AND MAIL TO BUILD ICN"
"RTN","MPIFRES",11,0)
 D NOW^%DTC
"RTN","MPIFRES",12,0)
 S ZTIO="",ZTDTH=%
"RTN","MPIFRES",13,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFRES",14,0)
 D ^%ZTLOAD
"RTN","MPIFRES",15,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFRES",16,0)
 K ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,%
"RTN","MPIFRES",17,0)
 Q
"RTN","MPIFRES",18,0)
 ;
"RTN","MPIFRES",19,0)
GO ;ENTRY POINT
"RTN","MPIFRES",20,0)
 N MPIMORE,MPITOT
"RTN","MPIFRES",21,0)
 L +^XTMP("MPIF RESOLUTION"):3 E  Q
"RTN","MPIFRES",22,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFRES",23,0)
 ;
"RTN","MPIFRES",24,0)
 K ^TMP("HLS",$J),STOP
"RTN","MPIFRES",25,0)
 D START^RGHLLOG()
"RTN","MPIFRES",26,0)
 D HLRDF
"RTN","MPIFRES",27,0)
 I $D(STOP) K STOP Q  ;patch 7 added to quit if init returned an error
"RTN","MPIFRES",28,0)
 D LOOP
"RTN","MPIFRES",29,0)
 I $D(^TMP("HLS",$J)) D SEND
"RTN","MPIFRES",30,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFRES",31,0)
 K MPIIT,MPITOT,HLDT,HLDT1,MPICNT,MPIDNUM,MPIEROR,MPIHL,MPIMIDT,MPIMSH
"RTN","MPIFRES",32,0)
 K MPIOUT,MPIQRYNM,MPISEQ,QCNT,MPIMCNT,MPIMTX,ENDT,MPIFRES
"RTN","MPIFRES",33,0)
 L -^XTMP("MPIF RESOLUTION")
"RTN","MPIFRES",34,0)
 Q
"RTN","MPIFRES",35,0)
 ;
"RTN","MPIFRES",36,0)
HLRDF ;
"RTN","MPIFRES",37,0)
 S (MPIOUT,MPIMCNT)=""
"RTN","MPIFRES",38,0)
 S MPIHL("ECH")="^~\&"
"RTN","MPIFRES",39,0)
 S MPIHL("FS")="|"
"RTN","MPIFRES",40,0)
 D INIT^HLFNC2("MPIF ICN-Q02 SERVER",.MPIHL)
"RTN","MPIFRES",41,0)
 I $O(MPIHL("")) D EXC^RGHLLOG(220,"INIT^HLFNC2 call error returned") S STOP="" Q
"RTN","MPIFRES",42,0)
 D CREATE^HLTF(.MPIMCNT,.MPIMTX,.HLDT,.HLDT1)
"RTN","MPIFRES",43,0)
 Q
"RTN","MPIFRES",44,0)
LOOP ;
"RTN","MPIFRES",45,0)
 S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",46,0)
 D MAKE
"RTN","MPIFRES",47,0)
 Q
"RTN","MPIFRES",48,0)
SEND ;ready to send
"RTN","MPIFRES",49,0)
 D GENERATE^HLMA("MPIF ICN-Q02 SERVER","GB",1,.MPIMTX,.MPIEROR,.MPIMORE)
"RTN","MPIFRES",50,0)
 I +MPIEROR=0 D EXC^RGHLLOG(220,"GENERATE^HLMA call returned error") Q
"RTN","MPIFRES",51,0)
 K %,MPIMTX,MPIEROR,MPIMORE
"RTN","MPIFRES",52,0)
 K ^TMP("HLS",$J)
"RTN","MPIFRES",53,0)
 Q
"RTN","MPIFRES",54,0)
MAKE ;
"RTN","MPIFRES",55,0)
 N LOCAL,MPIIT,TICN,STOP,X,Y,%,%H,%I,TODAY
"RTN","MPIFRES",56,0)
 S LOCAL="",MPIIT=0,MPIFRES=""
"RTN","MPIFRES",57,0)
 D NOW^%DTC S TODAY=X
"RTN","MPIFRES",58,0)
 ;local ICNs
"RTN","MPIFRES",59,0)
 F  S MPIIT=$O(^DPT("AICNL",1,MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",60,0)
 .Q:+$G(^DPT("AICNL",1,MPIIT))=1
"RTN","MPIFRES",61,0)
 .; ^ only send patient to MPI for Local ICN resolution 1 time
"RTN","MPIFRES",62,0)
 .I $D(^RGHL7(991.1,"ADFN",218,MPIIT)) S ^DPT("AICNL",1,MPIIT)="1^"_TODAY Q
"RTN","MPIFRES",63,0)
 .; ^ checking if potential match exception
"RTN","MPIFRES",64,0)
 .D MAKE3
"RTN","MPIFRES",65,0)
 ;missing ICNs
"RTN","MPIFRES",66,0)
 S MPIIT=0
"RTN","MPIFRES",67,0)
 F  S MPIIT=$O(^DPT("AMPIMIS",MPIIT)) Q:MPIIT=""  D
"RTN","MPIFRES",68,0)
 .K STOP
"RTN","MPIFRES",69,0)
 .S TICN=+$$GETICN^MPIF001(MPIIT)
"RTN","MPIFRES",70,0)
 .I TICN<0,'$D(STOP) D MAKE3
"RTN","MPIFRES",71,0)
 .I TICN>0 K ^DPT("AMPIMIS",MPIIT)
"RTN","MPIFRES",72,0)
 Q
"RTN","MPIFRES",73,0)
MAKE3 ;
"RTN","MPIFRES",74,0)
 K MPIOUT
"RTN","MPIFRES",75,0)
 S MPIFRES=""
"RTN","MPIFRES",76,0)
 S:$G(MPIQRYNM)="" MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFRES",77,0)
 D VTQ1^MPIFVTQ(MPIIT,.MPIOUT,.MPIHL,.MPIQRYNM)
"RTN","MPIFRES",78,0)
 I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="invalid DFN"!($P(MPIOUT(0),"^",2)="no encoding characters") D
"RTN","MPIFRES",79,0)
 .D EXC^RGHLLOG(206,"DFN = "_MPIIT_"  Problem with building VTQ was "_$P(MPIOUT(0),"^",2),MPIIT) Q
"RTN","MPIFRES",80,0)
 I $P(MPIOUT(0),"^")<0,$P(MPIOUT(0),"^",2)="Missing Required Field(s)" Q
"RTN","MPIFRES",81,0)
 Q:$P(MPIOUT(0),"^")<0
"RTN","MPIFRES",82,0)
 S ^DPT("AICNL",1,MPIIT)="1^"_TODAY
"RTN","MPIFRES",83,0)
 ; ^ mark Local ICN as having been sent to MPI for resolution
"RTN","MPIFRES",84,0)
 ;call for HL7 header
"RTN","MPIFRES",85,0)
 S MPIMIDT=MPIMCNT_"-"_MPIDNUM
"RTN","MPIFRES",86,0)
 D MSH^HLFNC2(.MPIHL,MPIMIDT,.MPIMSH)
"RTN","MPIFRES",87,0)
 S MPIOUT(1)=MPIMSH
"RTN","MPIFRES",88,0)
 ;MESSAGE BUILT
"RTN","MPIFRES",89,0)
 S MPISEQ=0
"RTN","MPIFRES",90,0)
 F  S MPISEQ=$O(MPIOUT(MPISEQ)) Q:MPISEQ'>0  D
"RTN","MPIFRES",91,0)
 .S ^TMP("HLS",$J,MPICNT)=MPIOUT(MPISEQ)
"RTN","MPIFRES",92,0)
 .S MPICNT=MPICNT+1
"RTN","MPIFRES",93,0)
 S MPIDNUM=MPIDNUM+1
"RTN","MPIFRES",94,0)
 I MPIDNUM>100 D
"RTN","MPIFRES",95,0)
 .D SEND
"RTN","MPIFRES",96,0)
 .S (MPICNT,MPIDNUM)=1
"RTN","MPIFRES",97,0)
 .D HLRDF
"RTN","MPIFRES",98,0)
 Q
"RTN","MPIFSAQ")
0^5^B73294372
"RTN","MPIFSAQ",1,0)
MPIFSAQ ;SF/CMC-STAND ALONE QUERY ;JAN 12, 1998
"RTN","MPIFSAQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,13,17**;30 Apr 99
"RTN","MPIFSAQ",3,0)
 ;
"RTN","MPIFSAQ",4,0)
 ;Integration Agreements:
"RTN","MPIFSAQ",5,0)
 ;  $$SEND^RGJUSITE - #3469
"RTN","MPIFSAQ",6,0)
 ;  $$EN^HLCSAC - #3471
"RTN","MPIFSAQ",7,0)
 ;
"RTN","MPIFSAQ",8,0)
INTACTV ;Interactive standalone query - Display Only!
"RTN","MPIFSAQ",9,0)
 ;patient doesn't have to be in Patient file
"RTN","MPIFSAQ",10,0)
 K DIR,X,Y
"RTN","MPIFSAQ",11,0)
 S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is Patient in the PATIENT file? "
"RTN","MPIFSAQ",12,0)
 D ^DIR
"RTN","MPIFSAQ",13,0)
 G:(Y'=1)&(Y'=0) END
"RTN","MPIFSAQ",14,0)
 I Y=1 D PAT(.MPIVAR)
"RTN","MPIFSAQ",15,0)
 I Y'=1,'$D(MPIVAR) D NOPAT(.MPIVAR)
"RTN","MPIFSAQ",16,0)
 I +$G(MPIVAR("DOB"))'>0 W !,"DOB is missing - Required field" G END
"RTN","MPIFSAQ",17,0)
 D VTQ(.MPIVAR)
"RTN","MPIFSAQ",18,0)
 K DIR,X,Y,MPIVAR
"RTN","MPIFSAQ",19,0)
 Q
"RTN","MPIFSAQ",20,0)
END K DIR,X,Y,MPIVAR,DIRUT,DTOUT,DUOUT
"RTN","MPIFSAQ",21,0)
 Q
"RTN","MPIFSAQ",22,0)
CLEAN(NAM) ;
"RTN","MPIFSAQ",23,0)
 ;NAM is the name to be cleaned up
"RTN","MPIFSAQ",24,0)
 ; Returned from this function is a clean name
"RTN","MPIFSAQ",25,0)
 N YY,I
"RTN","MPIFSAQ",26,0)
 ; -- only uppercase
"RTN","MPIFSAQ",27,0)
 I NAM?.E1L.E F I=1:1:$L(NAM) S:$E(NAM,I)?1L NAM=$E(NAM,0,I-1)_$C($A(NAM,I)-32)_$E(NAM,I+1,$L(NAM))
"RTN","MPIFSAQ",28,0)
 ; -- no space after comma and no double spaces
"RTN","MPIFSAQ",29,0)
 F YY=", ","  " F  Q:'$F(NAM,YY)  S NAM=$E(NAM,1,($F(NAM,YY)-2))_$E(NAM,$F(NAM,YY),$L(NAM))
"RTN","MPIFSAQ",30,0)
 ; -- no space at the end
"RTN","MPIFSAQ",31,0)
 F  Q:$E(NAM,$L(NAM))'=" "  S NAM=$E(NAM,1,$L(NAM)-1)
"RTN","MPIFSAQ",32,0)
 Q NAM
"RTN","MPIFSAQ",33,0)
PAT(MPIVAR) ;patient is in local Patient file
"RTN","MPIFSAQ",34,0)
PATA N DIC,X,Y,DIQ,DR,DA,ARRAY,DFN,DTOUT,DUOUT
"RTN","MPIFSAQ",35,0)
 S DIC="^DPT(",DIC(0)="AEQZM",DIC("A")="Patient Name: "
"RTN","MPIFSAQ",36,0)
 D ^DIC
"RTN","MPIFSAQ",37,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",38,0)
 I +Y=-1 W !,"Patient not found.  Try Again" G PATA
"RTN","MPIFSAQ",39,0)
 S (DFN,MPIVAR("DFN"))=+Y,MPIVAR("NM")=$P(Y(0),"^")
"RTN","MPIFSAQ",40,0)
 S DIQ="ARRAY",DR=".09;.03",DIC="^DPT(",DA=+Y,DIQ(0)="I"
"RTN","MPIFSAQ",41,0)
 D EN^DIQ1
"RTN","MPIFSAQ",42,0)
 S MPIVAR("DOB")=$G(ARRAY(2,DFN,.03,"I"))
"RTN","MPIFSAQ",43,0)
 S MPIVAR("SSN")=$G(ARRAY(2,DFN,.09,"I")) I MPIVAR("SSN")["P" S MPIVAR("SSN")=""
"RTN","MPIFSAQ",44,0)
 Q
"RTN","MPIFSAQ",45,0)
 ;
"RTN","MPIFSAQ",46,0)
NOPAT(MPIVAR) ; patient is not in the local Patient file
"RTN","MPIFSAQ",47,0)
NAME N DTOUT,DUOUT,DIR,X,Y
"RTN","MPIFSAQ",48,0)
 S DIR(0)="FU^::",DIR("A")="PATIENT NAME (last,first middle)"
"RTN","MPIFSAQ",49,0)
 D ^DIR
"RTN","MPIFSAQ",50,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",51,0)
 I (Y="")!($L(Y)>45)!($L(Y)<3) W !,"Name should be Last,first middle and at least 3 characters and no more than 30" G NAME
"RTN","MPIFSAQ",52,0)
 I (Y?1P.E)!(Y'?1U.ANP)!(Y'[",")!(Y[":")!(Y[";") W !,"Name should be Last,first middle and at least 3 characters and no more than 30" G NAME
"RTN","MPIFSAQ",53,0)
 I Y'?.UNP F %=1:1:$L(Y) I $E(Y,%)?1L S Y=$E(Y,0,%-1)_$C($A(Y,%)-32)_$E(Y,%+1,999)
"RTN","MPIFSAQ",54,0)
 S MPIVAR("NM")=$$CLEAN(Y)
"RTN","MPIFSAQ",55,0)
DOB K DIR,X,Y
"RTN","MPIFSAQ",56,0)
 S DIR(0)="DU^::AE",DIR("A")="Date of Birth"
"RTN","MPIFSAQ",57,0)
 D ^DIR
"RTN","MPIFSAQ",58,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",59,0)
 S MPIVAR("DOB")=Y
"RTN","MPIFSAQ",60,0)
SSN ; ssn is optional
"RTN","MPIFSAQ",61,0)
 K DIR,X,Y
"RTN","MPIFSAQ",62,0)
 S DIR(0)="FUO^9:9:",DIR("A")="9 Digit SSN (No Dashes)"
"RTN","MPIFSAQ",63,0)
 D ^DIR
"RTN","MPIFSAQ",64,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",65,0)
 I Y'="",Y'?9N W !,"SSN should be 9 numbers" G SSN
"RTN","MPIFSAQ",66,0)
 S MPIVAR("SSN")=Y
"RTN","MPIFSAQ",67,0)
 Q
"RTN","MPIFSAQ",68,0)
 ;
"RTN","MPIFSAQ",69,0)
VTQ(MPIVAR) ;
"RTN","MPIFSAQ",70,0)
 I $$SEND^RGJUSITE'>0 W !,"Not in SEND or SUSPEND mode, Try Again Later" G END
"RTN","MPIFSAQ",71,0)
 N TIME,%
"RTN","MPIFSAQ",72,0)
 D NOW^%DTC S TIME=%
"RTN","MPIFSAQ",73,0)
 ;
"RTN","MPIFSAQ",74,0)
 W !!,"Attempting to connect to the Master Patient Index in Austin..."
"RTN","MPIFSAQ",75,0)
 W !,"If DOB is inexact or if SSN is not passed or if common name,",!,"this could take some time - please be patient...."
"RTN","MPIFSAQ",76,0)
 ;
"RTN","MPIFSAQ",77,0)
 N HL,MPIQRYNM,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER
"RTN","MPIFSAQ",78,0)
 N TEST,SITE,MPIDC,MPINM,MPI1NM,MPI2NM,MPIESC,MPIHDOB,MPIRS,MPISCS
"RTN","MPIFSAQ",79,0)
 N QUEDDOB,QUERY,RDF
"RTN","MPIFSAQ",80,0)
 S HLP("ACKTIME")=300,HL("ECH")="^~\&",HL("FS")="|",MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFSAQ",81,0)
 S MPIIN="",MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFSAQ",82,0)
 I '$D(MPIVAR("DFN")) S MPIVAR("DFN")=235
"RTN","MPIFSAQ",83,0)
 S MPIMCNT=MPIVAR("DFN")
"RTN","MPIFSAQ",84,0)
 ;
"RTN","MPIFSAQ",85,0)
 ;SETUP VTQ
"RTN","MPIFSAQ",86,0)
 ;
"RTN","MPIFSAQ",87,0)
 S MPICS=$E(HL("ECH"),1),MPIRS=$E(HL("ECH"),2),MPISCS=$E(HL("ECH"),4),MPIESC=$E(HL("ECH"),3)
"RTN","MPIFSAQ",88,0)
 ;
"RTN","MPIFSAQ",89,0)
 S RDF="RDF"_HL("FS")_"15"_HL("FS")_"@00108.1"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00122"_MPICS_"ST"_MPICS_"9"_MPIRS_"@00110"_MPICS_"TS"_MPICS_8_MPIRS_"@00756"_MPICS_"ST"_MPICS_30
"RTN","MPIFSAQ",90,0)
 S RDF=RDF_MPIRS_"@00105"_MPICS_"ST"_MPICS_19_MPIRS_"@00108.2"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00169"_MPICS_"ST"_MPICS_30_MPIRS_"@00740"_MPICS_"TS"_MPICS_8
"RTN","MPIFSAQ",91,0)
 S RDF=RDF_MPIRS_"@00108.3"_MPICS_"ST"_MPICS_16_MPIRS_"@00111"_MPICS_"ST"_MPICS_1_MPIRS_"@00126.1"_MPICS_"ST"_MPICS_30_MPIRS_"@00126.2"_MPICS_"ST"_MPICS_3
"RTN","MPIFSAQ",92,0)
 S RDF=RDF_MPIRS_"@00108.5"_MPICS_"ST"_MPICS_20_MPIRS_"@00108.4"_MPICS_"ST"_MPICS_20_MPIRS_"@00109.1"_MPICS_"ST"_MPICS_30
"RTN","MPIFSAQ",93,0)
 ; ^ fields to be returned in query response
"RTN","MPIFSAQ",94,0)
 S QUERY="VTQ"_HL("FS")_$G(MPIVAR("DFN"))_HL("FS")_"T"_HL("FS")_MPIQRYNM_HL("FS")_"ICN"_HL("FS")
"RTN","MPIFSAQ",95,0)
 S MPI2NM=$P($G(MPIVAR("NM")),",",1),QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFSAQ",96,0)
 ; ^ sending last name
"RTN","MPIFSAQ",97,0)
 I MPIVAR("SSN")'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_$G(MPIVAR("SSN"))
"RTN","MPIFSAQ",98,0)
 ; ^ sending SSN
"RTN","MPIFSAQ",99,0)
 S MPI1NM=$P($G(MPIVAR("NM")),",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFSAQ",100,0)
 ; ^ sending first name
"RTN","MPIFSAQ",101,0)
 I $G(MPIVAR("DOB"))>0 D
"RTN","MPIFSAQ",102,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIVAR("DOB"))
"RTN","MPIFSAQ",103,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFSAQ",104,0)
 .S QUEDDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFSAQ",105,0)
 .S QUERY=QUERY_QUEDDOB
"RTN","MPIFSAQ",106,0)
 .; ^ sending date of birth
"RTN","MPIFSAQ",107,0)
 ;
"RTN","MPIFSAQ",108,0)
 ;Create MSH
"RTN","MPIFSAQ",109,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFSAQ",110,0)
 S HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFSAQ",111,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFSAQ",112,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFSAQ",113,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFSAQ",114,0)
 S MPIOUT(3)=RDF
"RTN","MPIFSAQ",115,0)
 ;
"RTN","MPIFSAQ",116,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFSAQ",117,0)
 ;Message is returned in MPIDC array
"RTN","MPIFSAQ",118,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFSAQ",119,0)
 ;Clean up the ack timeout HLP array variable
"RTN","MPIFSAQ",120,0)
 K HLP("ACKTIME")
"RTN","MPIFSAQ",121,0)
 I +TEST=-1 W !!,"Could not connect to MPI or Time-out occured, try again later." G EXIT
"RTN","MPIFSAQ",122,0)
 ;
"RTN","MPIFSAQ",123,0)
 ;Kill ^TMP("MPIFSAQ",$J) this is the array the data is parsed into
"RTN","MPIFSAQ",124,0)
 K ^TMP("MPIFSAQ",$J)
"RTN","MPIFSAQ",125,0)
 ;
"RTN","MPIFSAQ",126,0)
INIPARS ;
"RTN","MPIFSAQ",127,0)
 N SEG,INDEX,COUNTER,LASTSSN,SKIP,CHECK,FIRST
"RTN","MPIFSAQ",128,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFSAQ",129,0)
 K CHECK
"RTN","MPIFSAQ",130,0)
PARSE S SEG=$$SEG^MPIFAPI("RDT",1,"RDT")
"RTN","MPIFSAQ",131,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFSAQ",132,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,NAME,TF,ICN,POBC,POBS,PAST
"RTN","MPIFSAQ",133,0)
 . N HEREICN,HERESSN,MIDDLE,MNAME,SUFFIX,PREFIX,SEX,IEN,CMOR2,TF2
"RTN","MPIFSAQ",134,0)
 . S FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2)
"RTN","MPIFSAQ",135,0)
 . S MIDDLE=$P(SEG,HL("FS"),10),(LASTSSN,SSN)=$P(SEG,HL("FS"),3)
"RTN","MPIFSAQ",136,0)
 . S NAME=LASTNAME_","_FRSTNAME_" "_MIDDLE
"RTN","MPIFSAQ",137,0)
 . S CMOR=$P(SEG,HL("FS"),5),CMOR2=CMOR
"RTN","MPIFSAQ",138,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFSAQ",139,0)
 . I $D(FICN) I FICN'=ICN S FIRST=1,FICN=ICN K CHECK
"RTN","MPIFSAQ",140,0)
 . I FIRST=1 S FICN=ICN
"RTN","MPIFSAQ",141,0)
 . S FIRST=FIRST+1
"RTN","MPIFSAQ",142,0)
 . I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^"),CMOR2=CMOR
"RTN","MPIFSAQ",143,0)
 . S TF=$P(SEG,HL("FS"),8),TF2=TF
"RTN","MPIFSAQ",144,0)
 . I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFSAQ",145,0)
 . ;Same patient just adding TF's
"RTN","MPIFSAQ",146,0)
 . I TF'="",FICN=ICN,FIRST'=2 D
"RTN","MPIFSAQ",147,0)
 . . S SKIP="Y"
"RTN","MPIFSAQ",148,0)
 . . Q:CMOR2=TF2!($D(CHECK(TF2)))
"RTN","MPIFSAQ",149,0)
 . . S COUNTER=COUNTER+1
"RTN","MPIFSAQ",150,0)
 . . S ^TMP("MPIFSAQ",$J,INDEX,COUNTER)=TF,CHECK(TF2)=""
"RTN","MPIFSAQ",151,0)
 . ;
"RTN","MPIFSAQ",152,0)
 . I $G(SKIP)="Y" K SKIP Q
"RTN","MPIFSAQ",153,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFSAQ",154,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFSAQ",155,0)
 . I $G(BIRTHDAY)]"" D
"RTN","MPIFSAQ",156,0)
 . . S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY)
"RTN","MPIFSAQ",157,0)
 . . S BIRTHDAY=$TR($$FMTE^XLFDT(BIRTHDAY,"5D"),"/","-")
"RTN","MPIFSAQ",158,0)
 . S SEX=$P(SEG,HL("FS"),11)
"RTN","MPIFSAQ",159,0)
 . S SUFFIX=$P(SEG,HL("FS"),15)
"RTN","MPIFSAQ",160,0)
 . S PREFIX=$P(SEG,HL("FS"),14)
"RTN","MPIFSAQ",161,0)
 . S MNAME=$P(SEG,HL("FS"),16)
"RTN","MPIFSAQ",162,0)
 . S POBC=$P(SEG,HL("FS"),12)
"RTN","MPIFSAQ",163,0)
 . S POBS=$P(SEG,HL("FS"),13)
"RTN","MPIFSAQ",164,0)
 . S PAST=$P(SEG,HL("FS"),9)
"RTN","MPIFSAQ",165,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFSAQ",166,0)
 . S INDEX=INDEX+1
"RTN","MPIFSAQ",167,0)
 . S COUNTER=1
"RTN","MPIFSAQ",168,0)
 . I CMOR2=TF2 S TF=""
"RTN","MPIFSAQ",169,0)
 . S ^TMP("MPIFSAQ",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_SEX_"^"_SUFFIX_"^"_PREFIX_"^"_MNAME_"^"_POBC_"^"_POBS_"^"_PAST
"RTN","MPIFSAQ",170,0)
 ;
"RTN","MPIFSAQ",171,0)
 ; If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFSAQ",172,0)
 I '$D(^TMP("MPIFSAQ",$J)) W !!,"Patient was not found in the MPI." G EXIT
"RTN","MPIFSAQ",173,0)
DISPLAY ;
"RTN","MPIFSAQ",174,0)
 I INDEX>1 W !!,"Found potential matches"
"RTN","MPIFSAQ",175,0)
 I INDEX=1 W !!,"Found One Match"
"RTN","MPIFSAQ",176,0)
 ; display data returned
"RTN","MPIFSAQ",177,0)
 N CNT1,CNT2,STOP,CNTR2,TTF,CNT3,DIR,X,Y,DATA
"RTN","MPIFSAQ",178,0)
 S (CNT1)=0
"RTN","MPIFSAQ",179,0)
 F  S CNT1=$O(^TMP("MPIFSAQ",$J,CNT1)) Q:CNT1'>0!($D(STOP))  D
"RTN","MPIFSAQ",180,0)
 . S CNTR2=0
"RTN","MPIFSAQ",181,0)
 . I CNT1>1 D
"RTN","MPIFSAQ",182,0)
 . . K DIR,X,Y
"RTN","MPIFSAQ",183,0)
 . . S DIR(0)="Y",DIR("B")="YES",DIR("A")="Continue to next Patient? "
"RTN","MPIFSAQ",184,0)
 . . D ^DIR
"RTN","MPIFSAQ",185,0)
 . . I Y'=1 S STOP=""
"RTN","MPIFSAQ",186,0)
 . Q:$D(STOP)
"RTN","MPIFSAQ",187,0)
 . S CNTR2=CNTR2+1
"RTN","MPIFSAQ",188,0)
 . S DATA=$G(^TMP("MPIFSAQ",$J,CNT1,"DATA"))
"RTN","MPIFSAQ",189,0)
 . Q:DATA=""
"RTN","MPIFSAQ",190,0)
 . K TF,CHECK
"RTN","MPIFSAQ",191,0)
 . S NAME=$P(DATA,"^"),SSN=$P(DATA,"^",2),BIRTHDAY=$P(DATA,"^",3)
"RTN","MPIFSAQ",192,0)
 . S ICN=$P(DATA,"^",4),CMOR=$P(DATA,"^",5),TTF=$P(DATA,"^",6)
"RTN","MPIFSAQ",193,0)
 . I TTF'="",CMOR'=TTF S TF(CNTR2)=TTF
"RTN","MPIFSAQ",194,0)
 . S SEX=$P(DATA,"^",7),SUFFIX=$P(DATA,"^",9),PREFIX=$P(DATA,"^",8)
"RTN","MPIFSAQ",195,0)
 . S MNAME=$P(DATA,"^",10),POBC=$P(DATA,"^",11),POBS=$P(DATA,"^",12)
"RTN","MPIFSAQ",196,0)
 . S PAST=$P(DATA,"^",13)
"RTN","MPIFSAQ",197,0)
 . S Y=$$HL7TFM^XLFDT(PAST) D DD^%DT ; convert to FM date and then external display
"RTN","MPIFSAQ",198,0)
 . S PAST=Y
"RTN","MPIFSAQ",199,0)
 . S CNT3=""
"RTN","MPIFSAQ",200,0)
 . F  S CNT3=$O(^TMP("MPIFSAQ",$J,CNT1,CNT3)) Q:CNT3<0!(CNT3'?.N)  D
"RTN","MPIFSAQ",201,0)
 . . S TTF=$G(^TMP("MPIFSAQ",$J,CNT1,CNT3))
"RTN","MPIFSAQ",202,0)
 . . I TTF'=CMOR S CNTR2=CNTR2+1,TF(CNTR2)=TTF
"RTN","MPIFSAQ",203,0)
 . W !!!,"Name: ",NAME," ",SUFFIX," ",PREFIX
"RTN","MPIFSAQ",204,0)
 . W !,"SSN: ",SSN,?25,"Gender: ",SEX
"RTN","MPIFSAQ",205,0)
 . W !,"Integration Control Number (ICN): ",$P(ICN,"V")
"RTN","MPIFSAQ",206,0)
 . W !,"Date of Birth: ",BIRTHDAY,?30,"Date of Death: ",PAST
"RTN","MPIFSAQ",207,0)
 . W:$G(MNAME)'="" !,"Mother's Maiden Name: ",MNAME
"RTN","MPIFSAQ",208,0)
 . W:$G(POBC)'="" !,"Place of Birth: ",POBC,", ",POBS
"RTN","MPIFSAQ",209,0)
 . W !,"CMOR: ",CMOR
"RTN","MPIFSAQ",210,0)
 . S CNT2=""
"RTN","MPIFSAQ",211,0)
 . F  S CNT2=$O(TF(CNT2)) Q:CNT2=""  D
"RTN","MPIFSAQ",212,0)
 . . W !?10,"Treating Facility: ",TF(CNT2)
"RTN","MPIFSAQ",213,0)
 .W !!
"RTN","MPIFSAQ",214,0)
 Q
"RTN","MPIFSAQ",215,0)
EXIT H 3 K FICN W !! Q
"RTN","MPIFVTQ")
0^2^B50367191
"RTN","MPIFVTQ",1,0)
MPIFVTQ ;SLC/ARS-BUILD DATA TO QUERY MPI RESPONSE PROCESS (ADDPAT) ;JUL 16, 1997
"RTN","MPIFVTQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,9,17**;30 Apr 99
"RTN","MPIFVTQ",3,0)
 ;
"RTN","MPIFVTQ",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFVTQ",5,0)
 ;  ^DPT( -9 node check - #2762
"RTN","MPIFVTQ",6,0)
 ;  ^DPT( "MPI" node - #2070
"RTN","MPIFVTQ",7,0)
 ;  EXC, START, STOP ^RGHLLOG - #2796
"RTN","MPIFVTQ",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFVTQ",9,0)
 ;
"RTN","MPIFVTQ",10,0)
 Q  ;NOT an entry point
"RTN","MPIFVTQ",11,0)
VTQ2(MPIIT,MPIOUT,MPIHL,MPIQRYNM,MPISND) ;
"RTN","MPIFVTQ",12,0)
 ;** CURRENTLY NOT USED
"RTN","MPIFVTQ",13,0)
 ;MPIIT=DFN in patient file.
"RTN","MPIFVTQ",14,0)
 ;MPIOUT=Array you want the VTQ/RDF put into.
"RTN","MPIFVTQ",15,0)
 ;MPIHL=Array of encoding characters and Field separator.
"RTN","MPIFVTQ",16,0)
 ;MPIQRYNM=Name of query to put into message.
"RTN","MPIFVTQ",17,0)
 ;MPISND (OPTIONAL) = item #'s separated by ; to be used to query.
"RTN","MPIFVTQ",18,0)
 ;  default is DOB;SSN;LAST NAME;FIRST NAME;SUFFIX OF NAME;SEX;DOD;
"RTN","MPIFVTQ",19,0)
 ;  POB-CITY;POB-STATE
"RTN","MPIFVTQ",20,0)
 ;
"RTN","MPIFVTQ",21,0)
 ;If invalid DFN, Patient Merged, if ICN (NOT LOCAL) already assigned, Test SSN, the VTQ query is not built and -1^'error message' returned in MPIOUT(0).
"RTN","MPIFVTQ",22,0)
 ;
"RTN","MPIFVTQ",23,0)
 ;If patient has a date of death, the VTQ query is built with MPIOUT(0) returned with 0^Patient has date of death.  Programmer to decide if VTQ should be sent.
"RTN","MPIFVTQ",24,0)
 ;
"RTN","MPIFVTQ",25,0)
 ; allows VTQ to be created for Local ICN patients.
"RTN","MPIFVTQ",26,0)
 ;
"RTN","MPIFVTQ",27,0)
 N MPITEST,MPISSN,MPIDTH
"RTN","MPIFVTQ",28,0)
 S MPIOUT(0)=""
"RTN","MPIFVTQ",29,0)
 I '$D(MPISND) S MPISND="00122;00108.1;00108.2;00110;00740;00111;00108.4;00126.1;00126.2"
"RTN","MPIFVTQ",30,0)
 ;validation check
"RTN","MPIFVTQ",31,0)
 I '$D(MPIHL) S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",32,0)
 I $G(MPIHL("FS"))=""!($G(MPIHL("ECH"))="") S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",33,0)
 I MPIIT="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",34,0)
 I $G(^DPT(MPIIT,-9))'="" S MPIOUT(0)="-1^Patient merged "_^DPT(MPIIT,-9) Q
"RTN","MPIFVTQ",35,0)
 I $P($G(^DPT(MPIIT,0)),"^")["MERGING" S MPIOUT(0)="-1^Patient being merged DFN= "_MPIIT Q
"RTN","MPIFVTQ",36,0)
 S MPIMPI=$G(^DPT(MPIIT,"MPI"))
"RTN","MPIFVTQ",37,0)
 S:MPIMPI'="" MPIZICN=$P(^DPT(MPIIT,"MPI"),"^",1),MPIZLOC=$P(^DPT(MPIIT,"MPI"),"^",4)
"RTN","MPIFVTQ",38,0)
 I $G(MPIZICN)'="",$G(MPIZLOC)'=1 S MPIOUT(0)="-1^ICN already assigned "_MPIZICN Q
"RTN","MPIFVTQ",39,0)
 S MPITEST=$G(^DPT(MPIIT,0))
"RTN","MPIFVTQ",40,0)
 I MPITEST="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",41,0)
 S MPISSN=$P(MPITEST,"^",9)
"RTN","MPIFVTQ",42,0)
 I $E(MPISSN,1,5)="00000" S MPIOUT(0)="-1^5 zero SSN" Q
"RTN","MPIFVTQ",43,0)
 S MPIDTH=""
"RTN","MPIFVTQ",44,0)
 S:$G(^DPT(MPIIT,.35))'="" MPIDTH=$P(^DPT(MPIIT,.35),"^",1)
"RTN","MPIFVTQ",45,0)
 I $G(MPIDTH)'="" S MPIOUT(0)="0^Patient has Date of Death "_MPIDTH
"RTN","MPIFVTQ",46,0)
 D VTQC(MPISSN,MPIDTH,MPISND,.MPIHL,MPIQRYNM,.MPIOUT,MPIIT)
"RTN","MPIFVTQ",47,0)
 Q
"RTN","MPIFVTQ",48,0)
 ;
"RTN","MPIFVTQ",49,0)
VTQ1(MPIIT,MPIOUT,MPIHL,MPIQRYNM,MPISND) ;
"RTN","MPIFVTQ",50,0)
 ;MPIIT=DFN in patient file.
"RTN","MPIFVTQ",51,0)
 ;MPIOUT=Array you want the VTQ/RDF put into.
"RTN","MPIFVTQ",52,0)
 ;MPIHL=Array of encoding characters and Field separator.
"RTN","MPIFVTQ",53,0)
 ;MPIQRYNM=Name of query to put into message.
"RTN","MPIFVTQ",54,0)
 ;MPISND (OPTIONAL) = item #'s separated by ; to be used to query.
"RTN","MPIFVTQ",55,0)
 ;  default is DOB;SSN;LAST NAME;FIRST NAME;SUFFIX OF NAME;SEX;DOD;
"RTN","MPIFVTQ",56,0)
 ;  POB-CITY;POB-STATE;MIDDLE NAME
"RTN","MPIFVTQ",57,0)
 ;
"RTN","MPIFVTQ",58,0)
 ;If invalid DFN, Patient Merged, if ICN already assigned, Test SSN, the VTQ query is not built and -1^'error message' returned in MPIOUT(0).
"RTN","MPIFVTQ",59,0)
 ;
"RTN","MPIFVTQ",60,0)
 ;If DOB does not contain a 7 digit date OR if name is not present, -1^Missing Required fields will be returned in MPIOUT(0).
"RTN","MPIFVTQ",61,0)
 ;
"RTN","MPIFVTQ",62,0)
 ;If patient has a date of death, the VTQ query is built with MPIOUT(0) returned with 0^Patient has date of death.  Programmer to decide if VTQ should be sent.
"RTN","MPIFVTQ",63,0)
 ;
"RTN","MPIFVTQ",64,0)
 N MPITEST,MPISSN,MPIDTH,MPINM,MPIDOB
"RTN","MPIFVTQ",65,0)
 S MPIOUT(0)=""
"RTN","MPIFVTQ",66,0)
 I '$D(MPISND) S MPISND="00122;00108.1;00108.2;00110;00740;00111;00108.4;00126.1;00126.2;00108.3"
"RTN","MPIFVTQ",67,0)
 ;validation check
"RTN","MPIFVTQ",68,0)
 I '$D(MPIHL) S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",69,0)
 I $G(MPIHL("FS"))=""!($G(MPIHL("ECH"))="") S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",70,0)
 I MPIIT="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",71,0)
 I $G(^DPT(MPIIT,-9))'="" S MPIOUT(0)="-1^Patient merged "_^DPT(MPIIT,-9) Q
"RTN","MPIFVTQ",72,0)
 I $P($G(^DPT(MPIIT,0)),"^")["MERGING" S MPIOUT(0)="-1^Patient being merged DFN= "_MPIIT Q
"RTN","MPIFVTQ",73,0)
 S MPIMPI=$G(^DPT(MPIIT,"MPI"))
"RTN","MPIFVTQ",74,0)
 S:MPIMPI'="" MPIZICN=$P(^DPT(MPIIT,"MPI"),"^",1)
"RTN","MPIFVTQ",75,0)
 I '$D(MPIFRES),$G(MPIZICN)'="" S MPIOUT(0)="-1^ICN already assigned "_MPIZICN Q
"RTN","MPIFVTQ",76,0)
 S MPITEST=$G(^DPT(MPIIT,0))
"RTN","MPIFVTQ",77,0)
 I MPITEST="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",78,0)
 S MPISSN=$P(MPITEST,"^",9)
"RTN","MPIFVTQ",79,0)
 I $E(MPISSN,1,5)="00000" S MPIOUT(0)="-1^5 zero SSN" Q
"RTN","MPIFVTQ",80,0)
 I $E($P(MPITEST,"^"),1,2)="ZZ" S MPIOUT(0)="-1^ZZ'd Patient" Q
"RTN","MPIFVTQ",81,0)
 S MPINM=$P(MPITEST,"^") I MPINM=""!($L(MPINM)<3) S MPIOUT(0)="-1^Missing Required Field(s)" D EXC(MPIIT) Q
"RTN","MPIFVTQ",82,0)
 S MPIDOB=$P(MPITEST,"^",3) I MPIDOB'?7N S MPIOUT(0)="-1^Missing Required Field(s)" D EXC(MPIIT) Q
"RTN","MPIFVTQ",83,0)
 S MPIDTH=""
"RTN","MPIFVTQ",84,0)
 S:$G(^DPT(MPIIT,.35))'="" MPIDTH=$P(^DPT(MPIIT,.35),"^",1)
"RTN","MPIFVTQ",85,0)
 I $G(MPIDTH)'="" S MPIOUT(0)="0^Patient has Date of Death "_MPIDTH
"RTN","MPIFVTQ",86,0)
 D VTQC(MPISSN,MPIDTH,MPISND,.MPIHL,MPIQRYNM,.MPIOUT,MPIIT)
"RTN","MPIFVTQ",87,0)
 Q
"RTN","MPIFVTQ",88,0)
EXC(IEN) ;
"RTN","MPIFVTQ",89,0)
 Q:'$D(^DPT(IEN))
"RTN","MPIFVTQ",90,0)
 D LOCAL^MPIFQ0(IEN)
"RTN","MPIFVTQ",91,0)
 D START^RGHLLOG()
"RTN","MPIFVTQ",92,0)
 D EXC^RGHLLOG(209,"DFN= "_IEN_" is Missing Required Field(s)",IEN)
"RTN","MPIFVTQ",93,0)
 D STOP^RGHLLOG()
"RTN","MPIFVTQ",94,0)
 Q
"RTN","MPIFVTQ",95,0)
 ;
"RTN","MPIFVTQ",96,0)
VTQC(MPISSN,MPIDTH,MPISND,MPIHL,MPIQRYNM,MPIOUT,MPIIT) ;
"RTN","MPIFVTQ",97,0)
 N MPIPOB,MPIPOBS,MPINM,MPI2MN,MPI1NM,QUERY,MPIDOB,RDF,MPIMOD
"RTN","MPIFVTQ",98,0)
 N MPIHDTH,MPIZDOB,MPIXDOB,MPIMPI,MPIZICN,QUEDOB,MPI2NM,MPICS,MPIESC,MPIHDOB,MPIMNM,MPIMN
"RTN","MPIFVTQ",99,0)
 N MPINMSFX,MPIRS,MPISCS,MPISEX,MPIZLOC
"RTN","MPIFVTQ",100,0)
 I $G(MPIQRYNM)="" S MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFVTQ",101,0)
 S MPICS=$E(MPIHL("ECH"),1)
"RTN","MPIFVTQ",102,0)
 S MPIRS=$E(MPIHL("ECH"),2)
"RTN","MPIFVTQ",103,0)
 S MPISCS=$E(MPIHL("ECH"),4)
"RTN","MPIFVTQ",104,0)
 S MPIESC=$E(MPIHL("ECH"),3)
"RTN","MPIFVTQ",105,0)
 ;
"RTN","MPIFVTQ",106,0)
 S RDF="RDF"_MPIHL("FS")_"11"_MPIHL("FS")_"@00108.1"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00122"_MPICS_"ST"_MPICS_"9"_MPIRS_"@00110"_MPICS_"TS"_MPICS_8_MPIRS_"@00756"_MPICS_"ST"_MPICS_30_MPIRS_"@00105"_MPICS_"ST"_MPICS_19
"RTN","MPIFVTQ",107,0)
 S RDF=RDF_MPIRS_"@00108.2"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00169"_MPICS_"ST"_MPICS_30_MPIRS_"@00740"_MPICS_"TS"_MPICS_8_MPIRS_"@00108.3"_MPICS_"ST"_MPICS_16_MPIRS_"@00108.4"_MPICS_"ST"_MPICS_20
"RTN","MPIFVTQ",108,0)
 S RDF=RDF_MPIRS_"@00111"_MPICS_"ST"_MPICS_1 ;adding sex to list
"RTN","MPIFVTQ",109,0)
 ; ^ fields to be returned in query response
"RTN","MPIFVTQ",110,0)
 ;
"RTN","MPIFVTQ",111,0)
 S QUERY="VTQ"_MPIHL("FS")_MPIIT_MPIHL("FS")_"T"_MPIHL("FS")_MPIQRYNM_MPIHL("FS")_"ICN"_MPIHL("FS")
"RTN","MPIFVTQ",112,0)
 ;
"RTN","MPIFVTQ",113,0)
 I MPISND["00108" S MPINM=$P(MPITEST,"^") D NAME^VAFCPID2(MPIIT,.MPINM) ;agressive name reformatting
"RTN","MPIFVTQ",114,0)
 ; ^ sending all or part of name
"RTN","MPIFVTQ",115,0)
 I MPISND["00108.1" S MPI2NM=$P(MPINM,",",1) I MPI2NM'="" S QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFVTQ",116,0)
 ; ^ sending last name
"RTN","MPIFVTQ",117,0)
 I MPISND["00122"&(MPISSN'="")&(MPISSN'["P") S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_MPISSN
"RTN","MPIFVTQ",118,0)
 ; ^ sending SSN
"RTN","MPIFVTQ",119,0)
 I MPISND["00108.2" S MPI1NM=$P(MPINM,",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFVTQ",120,0)
 ; ^ sending first name
"RTN","MPIFVTQ",121,0)
 I MPISND["00110" D
"RTN","MPIFVTQ",122,0)
 .S MPIDOB=$P(MPITEST,"^",3)
"RTN","MPIFVTQ",123,0)
 .Q:MPIDOB=""
"RTN","MPIFVTQ",124,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIDOB)
"RTN","MPIFVTQ",125,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFVTQ",126,0)
 .S MPIMOD=MPIDOB#100
"RTN","MPIFVTQ",127,0)
 .I MPIQRYNM'="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"GN"_MPICS_MPIHDOB
"RTN","MPIFVTQ",128,0)
 .I MPIQRYNM="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",129,0)
 .S MPIXDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",130,0)
 .S QUEDOB=$S(MPIMOD>0:MPIXDOB,1:MPIZDOB)
"RTN","MPIFVTQ",131,0)
 .S QUERY=QUERY_QUEDOB
"RTN","MPIFVTQ",132,0)
 ; ^ sending date of birth
"RTN","MPIFVTQ",133,0)
 I $D(MPIDTH),(MPISND["00740")&(MPIDTH'="") S MPIHDTH=$$HLDATE^HLFNC(MPIDTH),QUERY=QUERY_MPICS_"AND"_MPIRS_"@00740"_MPICS_"EQ"_MPICS_MPIHDTH
"RTN","MPIFVTQ",134,0)
 ; ^ sending date of death
"RTN","MPIFVTQ",135,0)
 I MPISND["00111" S:$G(^DPT(MPIIT,0))'="" MPISEX=$P(^DPT(MPIIT,0),"^",2) I MPISEX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00111"_MPICS_"EQ"_MPICS_MPISEX
"RTN","MPIFVTQ",136,0)
 ; ^ sending Sex
"RTN","MPIFVTQ",137,0)
 I MPISND["00108.4" S MPI1NM=$P(MPINM,",",2),MPINMSFX=$P(MPI1NM," ",3) I MPINMSFX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.4"_MPICS_"EQ"_MPICS_MPINMSFX
"RTN","MPIFVTQ",138,0)
 ; ^ sending suffix name
"RTN","MPIFVTQ",139,0)
 I MPISND["00126.1" S MPIPOB=$P(^DPT(MPIIT,0),"^",11) I MPIPOB'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.1"_MPICS_"EQ"_MPICS_MPIPOB
"RTN","MPIFVTQ",140,0)
 ; send place of birth - city
"RTN","MPIFVTQ",141,0)
 I MPISND["00126.2" S MPIPOBS=$P(^DPT(MPIIT,0),"^",12) I MPIPOBS'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.2"_MPICS_"EQ"_MPICS_MPIPOBS
"RTN","MPIFVTQ",142,0)
 ; send place of birth - state
"RTN","MPIFVTQ",143,0)
 I MPISND["00108.3" S MPIMN=$P($P(MPINM,",",2)," ",2) I MPIMN'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.3"_MPICS_"EQ"_MPICS_MPIMN
"RTN","MPIFVTQ",144,0)
 ; send middle name
"RTN","MPIFVTQ",145,0)
 ;
"RTN","MPIFVTQ",146,0)
 I $G(MPIOUT(0))="" S MPIOUT(0)="1^good data"
"RTN","MPIFVTQ",147,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFVTQ",148,0)
 S MPIOUT(3)=RDF
"RTN","MPIFVTQ",149,0)
 ;W !,QUERY
"RTN","MPIFVTQ",150,0)
 Q
"VER")
8.0^22.0
**END**
**END**
