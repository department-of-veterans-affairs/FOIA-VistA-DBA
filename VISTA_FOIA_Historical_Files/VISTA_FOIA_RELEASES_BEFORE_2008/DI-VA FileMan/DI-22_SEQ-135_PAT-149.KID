Released DI*22*149 SEQ #135
Extracted from mail message
**KIDS**:DI*22.0*149^

**INSTALL NAME**
DI*22.0*149
"BLD",585,0)
DI*22.0*149^VA FILEMAN^0^3060811^y
"BLD",585,1,0)
^^2^2^3060809^
"BLD",585,1,1,0)
See patch DI*22*149 in the National Patch Module on FORUM for complete
"BLD",585,1,2,0)
information on this patch.
"BLD",585,4,0)
^9.64PA^^
"BLD",585,6.3)
2
"BLD",585,"KRN",0)
^9.67PA^8989.52^19
"BLD",585,"KRN",.4,0)
.4
"BLD",585,"KRN",.401,0)
.401
"BLD",585,"KRN",.402,0)
.402
"BLD",585,"KRN",.403,0)
.403
"BLD",585,"KRN",.5,0)
.5
"BLD",585,"KRN",.84,0)
.84
"BLD",585,"KRN",3.6,0)
3.6
"BLD",585,"KRN",3.8,0)
3.8
"BLD",585,"KRN",9.2,0)
9.2
"BLD",585,"KRN",9.8,0)
9.8
"BLD",585,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",585,"KRN",9.8,"NM",1,0)
DICM^^0^B29790678
"BLD",585,"KRN",9.8,"NM",2,0)
DIQG^^0^B36192228
"BLD",585,"KRN",9.8,"NM",3,0)
DICRW^^0^B13427185
"BLD",585,"KRN",9.8,"NM","B","DICM",1)

"BLD",585,"KRN",9.8,"NM","B","DICRW",3)

"BLD",585,"KRN",9.8,"NM","B","DIQG",2)

"BLD",585,"KRN",19,0)
19
"BLD",585,"KRN",19.1,0)
19.1
"BLD",585,"KRN",101,0)
101
"BLD",585,"KRN",409.61,0)
409.61
"BLD",585,"KRN",771,0)
771
"BLD",585,"KRN",870,0)
870
"BLD",585,"KRN",8989.51,0)
8989.51
"BLD",585,"KRN",8989.52,0)
8989.52
"BLD",585,"KRN",8994,0)
8994
"BLD",585,"KRN","B",.4,.4)

"BLD",585,"KRN","B",.401,.401)

"BLD",585,"KRN","B",.402,.402)

"BLD",585,"KRN","B",.403,.403)

"BLD",585,"KRN","B",.5,.5)

"BLD",585,"KRN","B",.84,.84)

"BLD",585,"KRN","B",3.6,3.6)

"BLD",585,"KRN","B",3.8,3.8)

"BLD",585,"KRN","B",9.2,9.2)

"BLD",585,"KRN","B",9.8,9.8)

"BLD",585,"KRN","B",19,19)

"BLD",585,"KRN","B",19.1,19.1)

"BLD",585,"KRN","B",101,101)

"BLD",585,"KRN","B",409.61,409.61)

"BLD",585,"KRN","B",771,771)

"BLD",585,"KRN","B",870,870)

"BLD",585,"KRN","B",8989.51,8989.51)

"BLD",585,"KRN","B",8989.52,8989.52)

"BLD",585,"KRN","B",8994,8994)

"BLD",585,"PRE")
DI149ENV
"BLD",585,"QUES",0)
^9.62^^
"BLD",585,"REQB",0)
^9.611^2^2
"BLD",585,"REQB",1,0)
DI*22.0*40^2
"BLD",585,"REQB",2,0)
DI*22.0*133^2
"BLD",585,"REQB","B","DI*22.0*133",2)

"BLD",585,"REQB","B","DI*22.0*40",1)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
VA FILEMAN^DI^FM INIT
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
22.0^2990330^3051028^41
"PKG",5,22,1,"PAH",1,0)
149^3060811
"PKG",5,22,1,"PAH",1,1,0)
^^2^2^3060811
"PKG",5,22,1,"PAH",1,1,1,0)
See patch DI*22*149 in the National Patch Module on FORUM for complete
"PKG",5,22,1,"PAH",1,1,2,0)
information on this patch.
"PRE")
DI149ENV
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","DI149ENV")
0^^B5665116^n/a
"RTN","DI149ENV",1,0)
DI149ENV ;IRMFO-SF/FM STAFF-ENVIRONMENT CHECK ROUTINE ;6:09 AM  11 Aug 2006
"RTN","DI149ENV",2,0)
 ;;22.0;VA FileMan;**149**;Mar 30, 1999;Build 2
"RTN","DI149ENV",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DI149ENV",4,0)
 ;
"RTN","DI149ENV",5,0)
 ; Check XPDENV 0 = Loading; 1 = Installing
"RTN","DI149ENV",6,0)
 I 'XPDENV D  Q  ; Loading Distribution - No Check
"RTN","DI149ENV",7,0)
 . ; Make sure exported routines are registered in ROUTINE(#9.8) file
"RTN","DI149ENV",8,0)
 . ; Edit FOR loop
"RTN","DI149ENV",9,0)
 . N ROU,ZDATE,%,%H,%I,X
"RTN","DI149ENV",10,0)
 . D NOW^%DTC
"RTN","DI149ENV",11,0)
 . S ZDATE=%
"RTN","DI149ENV",12,0)
 . F ROU="DICM","DICRW","DIQG" D
"RTN","DI149ENV",13,0)
 .. N IEN S IEN=$O(^DIC(9.8,"B",ROU,0))
"RTN","DI149ENV",14,0)
 .. I 'IEN D
"RTN","DI149ENV",15,0)
 ... N FDA,DIERR,ZERR,IEN
"RTN","DI149ENV",16,0)
 ... S IEN="+1,"
"RTN","DI149ENV",17,0)
 ... S FDA(9.8,IEN,.01)=ROU
"RTN","DI149ENV",18,0)
 ... S FDA(9.8,IEN,1)="R"
"RTN","DI149ENV",19,0)
 ... S FDA(9.8,IEN,7.4)=ZDATE
"RTN","DI149ENV",20,0)
 ... D UPDATE^DIE("","FDA","IEN")
"RTN","DI149ENV",21,0)
 ... Q
"RTN","DI149ENV",22,0)
 .. Q
"RTN","DI149ENV",23,0)
 . D CLEAN^DILF
"RTN","DI149ENV",24,0)
 . Q
"RTN","DI149ENV",25,0)
 ;
"RTN","DI149ENV",26,0)
INSCHK ; Do Checks During Install Only
"RTN","DI149ENV",27,0)
 W $C(7)
"RTN","DI149ENV",28,0)
 D MES^XPDUTL("** Although Queuing is allowed - it is HIGHLY recommended that ALL Users and")
"RTN","DI149ENV",29,0)
 D MES^XPDUTL("VISTA Background jobs be STOPPED before installation of this patch.  Failure")
"RTN","DI149ENV",30,0)
 D MES^XPDUTL("to do so may result in 'source routine edited' error(s). Edits will be")
"RTN","DI149ENV",31,0)
 D MES^XPDUTL("lost and record(s) may be left in an inconsistent state, for example,")
"RTN","DI149ENV",32,0)
 D MES^XPDUTL("not all Cross-Referencing completed; which in turn may cause FUTURE")
"RTN","DI149ENV",33,0)
 D MES^XPDUTL("VistA/FileMan Hard Errors or corrupted Data. **")
"RTN","DI149ENV",34,0)
 ;
"RTN","DI149ENV",35,0)
TMCHK ; Check to see if TaskMan is still running
"RTN","DI149ENV",36,0)
 S X=$$TM^%ZTLOAD
"RTN","DI149ENV",37,0)
 I X,'$D(^%ZTSCH("WAIT")) D
"RTN","DI149ENV",38,0)
 . W $C(7)
"RTN","DI149ENV",39,0)
 . D BMES^XPDUTL("* Warning TaskMan Has NOT Been Stopped or Placed in a WAIT State!")
"RTN","DI149ENV",40,0)
 ;
"RTN","DI149ENV",41,0)
LINH ; Check to see if Logons are Inhibited
"RTN","DI149ENV",42,0)
 D GETENV^%ZOSV  ; $P(Y,"^",2) = Installing Volume
"RTN","DI149ENV",43,0)
 S X=+$G(^%ZIS(14.5,"LOGON",$P(Y,"^",2)))
"RTN","DI149ENV",44,0)
 I 'X D
"RTN","DI149ENV",45,0)
 . W $C(7)
"RTN","DI149ENV",46,0)
 . D BMES^XPDUTL("* Warning Logons are NOT Inhibited!")
"RTN","DI149ENV",47,0)
 Q
"RTN","DICM")
0^1^B29790678^B29893266
"RTN","DICM",1,0)
DICM ;SFISC/GFT,XAK,TKW-MULTIPLE LOOKUP FOR FLDS WHICH MUST BE TRANSFORMED ;26JUN2006
"RTN","DICM",2,0)
 ;;22.0;VA FileMan;**4,20,31,40,149**;Mar 30, 1999;Build 2
"RTN","DICM",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DICM",4,0)
 I '$D(DICR(1)),DIC(0)'["T" N DICR S DICR=0
"RTN","DICM",5,0)
 I $A(X)=34,X?.E1"""" G N
"RTN","DICM",6,0)
 I $G(^DD(+DO(2),0,"LOOK"))]"",^("LOOK")'="SOUNDEX" G @^("LOOK")
"RTN","DICM",7,0)
 I DIC(0)["U" S DD=0 G W
"RTN","DICM",8,0)
 I DIC(0)["T" G 2
"RTN","DICM",9,0)
R N DIFLAGS S DIFLAGS="4l"_$P("M^",U,DIC(0)["M")
"RTN","DICM",10,0)
 N DIFORCE D
"RTN","DICM",11,0)
 . S DIFORCE=0 I DIC(0)'["M"!($D(DID)) S DIFORCE=1
"RTN","DICM",12,0)
 . S DIFORCE(0)=$S(DIC(0)'["M":DINDEX,$D(DID):DID,1:"*"),DIFORCE(1)=1
"RTN","DICM",13,0)
 F  D 1 I DINDEX=""!(Y>0)!($G(DTOUT))!($G(DIROUT)) Q
"RTN","DICM",14,0)
 G 2
"RTN","DICM",15,0)
 ;
"RTN","DICM",16,0)
1 N DS,%Y,DIV
"RTN","DICM",17,0)
 I $G(DINDEX("IXFILE")) S Y=DINDEX(1,"FILE"),%Y=DINDEX(1,"FIELD")
"RTN","DICM",18,0)
 E  S Y=$O(^DD(+DO(2),0,"IX",DINDEX,0)) S:Y="" Y=-1 S %Y=+$O(^(Y,0))
"RTN","DICM",19,0)
 I Y=-1,DINDEX="B" S Y=+DO(2),%Y=.01
"RTN","DICM",20,0)
 S:Y="" Y=-1 S:%Y="" %Y=-1
"RTN","DICM",21,0)
 I $D(DICR(U,Y,%Y,DINDEX)) S Y=-1
"RTN","DICM",22,0)
 E  I %Y=.01,DINDEX'="B",Y=+DO(2),$D(DICR(U,Y,%Y,"B")),$G(DINDEX(1,"TRANCODE"))="" S Y=-1
"RTN","DICM",23,0)
 I Y'<0 D
"RTN","DICM",24,0)
 . S DS=$G(^DD(Y,%Y,0)) I DS="" S Y=-1 Q
"RTN","DICM",25,0)
 . S %=DINDEX,DICR(U,Y,%Y,DINDEX)=0
"RTN","DICM",26,0)
 . I $D(^DD(Y,%Y,7)) D RS K DS X ^(7) Q
"RTN","DICM",27,0)
 . I $G(DINDEX("IXTYPE"))="S" D A,SOU^DICM1,D Q:Y>0  S Y=-1 Q
"RTN","DICM",28,0)
 . S DIX=Y,Y=$P(DS,U,2)
"RTN","DICM",29,0)
 . S Y=$S(Y["P":"P",Y["D":"D",Y["S":"S",Y["V":"V",1:"")
"RTN","DICM",30,0)
 . I Y]"" D A D:'Y ^DICM1,D Q:Y>0  S Y=-1 Q
"RTN","DICM",31,0)
 . I $G(DINDEX(1,"TRANCODE"))]"" S Y="T" D A,^DICM1 N DITRANX S DITRANX=1 D D
"RTN","DICM",32,0)
 . Q:Y>0  S Y=-1 Q
"RTN","DICM",33,0)
 Q:Y>0!(DIC(0)["T")  D
"RTN","DICM",34,0)
 . K DIV M DIV=X S DIV(1)=X N X,Y
"RTN","DICM",35,0)
 . D NXTINDX^DICF2(.DINDEX,.DIFORCE,.DIFILEI,DIFLAGS,.DIV,"*") Q
"RTN","DICM",36,0)
 Q
"RTN","DICM",37,0)
 ;
"RTN","DICM",38,0)
2 D D^DIC0 S %=D
"RTN","DICM",39,0)
 G K:Y>0!($G(DIROUT))
"RTN","DICM",40,0)
 I X?.E1L.E,DIC(0)'["X" D  G K:$G(DIROUT)
"RTN","DICM",41,0)
 . D % N DIFILEI,DINDEX
"RTN","DICM",42,0)
 . S DIC(0)=$TR(DIC(0),"L"),X=$$UP^DILIBF(X) S:$G(DILONGX) DICR(DICR,"ORG")=X
"RTN","DICM",43,0)
 . D DIC Q
"RTN","DICM",44,0)
 I Y'>0,X["," S DS="",DIX=$P(X,",",1) I DIC(0)'["X",$L(DIX)<31 D  G K:$G(DIROUT)
"RTN","DICM",45,0)
 . F %=2:1 S DD=$P(X,",",%) I DD'["""" D  Q:DD=""
"RTN","DICM",46,0)
 . . F  Q:$A(DD)-32  S DD=$E(DD,2,999)
"RTN","DICM",47,0)
 . . F  Q:$A(DD,$L(DD))-32  S DD=$E(DD,1,$L(DD)-1)
"RTN","DICM",48,0)
 . . I $L(DD)*2+$L(DS)>200!(DD="") S DD="" Q
"RTN","DICM",49,0)
 . . S DS=DS_" I %?.E1P1"""_DD_""".E!(D'=""B""&(%?1"""_DD_""".E))" Q
"RTN","DICM",50,0)
 . Q:DS=""  S %=D
"RTN","DICM",51,0)
 . D % S X=DIX N DILONGX
"RTN","DICM",52,0)
 . S DS="S %=$P(^(0),U,1)"_DS,DIC(0)=DIC(0)_"D" D 7 Q
"RTN","DICM",53,0)
 I Y'>0,$L(X)>30 D
"RTN","DICM",54,0)
 . N DILONGX S DILONGX=1
"RTN","DICM",55,0)
 . S %=D D % S Y="DICR("_DICR_")",DICR(DICR,"ORG")=X
"RTN","DICM",56,0)
 . S DS=$S(DIC(0)["X":"I DIVAL="_Y,1:"I '$L($P(DIVAL,"_Y_"))")
"RTN","DICM",57,0)
 . S:DIC(0)["O"&(DIC(0)'["E") DS=DS_",'$L($P(DIVAL,"_Y_",2))"
"RTN","DICM",58,0)
 . D 7 I Y>0!(X'?.E1L.E)!(DIC(0)["X") K DILONGX Q
"RTN","DICM",59,0)
 . S %=D D % S (X,DICR(DICR,"ORG"))=$$UP^DILIBF(X)
"RTN","DICM",60,0)
 . S Y="DICR("_DICR_",""ORG"")"
"RTN","DICM",61,0)
 . S DS="I '$L($P(DIVAL,"_Y_"))" S:DIC(0)["O"&(DIC(0)'["E") DS=DS_",'$L($P(DIVAL,"_Y_",2))"
"RTN","DICM",62,0)
 . D 7 K DILONGX Q
"RTN","DICM",63,0)
 ;
"RTN","DICM",64,0)
K S DD=$D(DICR(DICR,6)) K:'DICR DICR
"RTN","DICM",65,0)
 I Y>0 K DIC("W") D R^DIC2 Q
"RTN","DICM",66,0)
 I $G(DTOUT)!($G(DIROUT)) Q
"RTN","DICM",67,0)
W I @("$O("_DIC_"""A[""))]""""") G NL:DIC(0)["N",DD
"RTN","DICM",68,0)
 I DO(2)'["Z" S Y=0 D  Q:Y>0!($G(DIROUT))
"RTN","DICM",69,0)
 . N DIOUT S DIOUT=0 F DS=1:1 S @("Y=$O("_DIC_"Y))") D  Q:DIOUT
"RTN","DICM",70,0)
 . . I 'Y S Y=-1,DIOUT=1 Q
"RTN","DICM",71,0)
 . . W:DIC(0)["E"&(DS#20=0) ".."
"RTN","DICM",72,0)
 . . I $D(@(DIC_Y_",0)")),$P(^(0),U)=X X:$D(DIC("S")) DIC("S") I  S DIOUT=1
"RTN","DICM",73,0)
 . . I DIOUT S DIY="",DS=1 N DZ,DD D ADDKEY^DIC3,GOT^DIC2
"RTN","DICM",74,0)
 . . Q
"RTN","DICM",75,0)
NL I '$G(DICR) D NQ I $T D  Q:Y>0!($G(DTOUT))!($G(DIROUT))
"RTN","DICM",76,0)
 . N:'$G(DIASKOK) DIASKOK S (DS,DIASKOK)=1 N DZ,DD
"RTN","DICM",77,0)
 . D ADDKEY^DIC3,GOT^DIC2 Q
"RTN","DICM",78,0)
DD S Y=-1 I DD D BAD^DIC1 Q
"RTN","DICM",79,0)
L I DIC(0)["L" K DD G ^DICN
"RTN","DICM",80,0)
B D BAD^DIC1 Q
"RTN","DICM",81,0)
 ;
"RTN","DICM",82,0)
N D RS S X=$E(X,2,$L(X)-1),%=D D
"RTN","DICM",83,0)
 . I DINDEX("#")>1 S %Y=+$G(DINDEX(1,"FIELD")),DS=$G(^DD(+$G(DINDEX(1,"FILE")),%Y,0)) Q:DS]""
"RTN","DICM",84,0)
 . S DS=^DD(+DO(2),.01,0),%Y=.01 Q
"RTN","DICM",85,0)
 F Y="P","D","S","V" I $P(DS,U,2)[Y K:Y="P" DO D ^DICM1 S:$D(X)#2 DS("INT")=X Q
"RTN","DICM",86,0)
 I $D(X),DINDEX("#")>1 S X(1)=X
"RTN","DICM",87,0)
 S Y=-1 D L:$D(X),E
"RTN","DICM",88,0)
 I Y'>0 K DUOUT D BAD^DIC1 Q
"RTN","DICM",89,0)
 G 2
"RTN","DICM",90,0)
 ;
"RTN","DICM",91,0)
A ; Set variables needed for transforming date/set/ptr/var.ptr
"RTN","DICM",92,0)
 S DICR(DICR+1,4)=%
"RTN","DICM",93,0)
 D % K DF,DID,DINUM Q
"RTN","DICM",94,0)
 ;
"RTN","DICM",95,0)
% ; Set variables up before doing lookup w/transformed value
"RTN","DICM",96,0)
 I DIC(0)'["L" S DICR(DICR+1,8)=1
"RTN","DICM",97,0)
 E  I '$$OKTOADD^DICM0(.DIFILEI,.DINDEX,.DIFINDER) S DICR(DICR+1,8)=1
"RTN","DICM",98,0)
 I $G(DINUM)]"" S DICR(DICR+1,10)=DINUM
"RTN","DICM",99,0)
 I $D(DF) S DICR(DICR+1,9)=DF S:$G(DID)]"" DICR(DICR+1,9.1)=$G(DID(1))_U_DID
"RTN","DICM",100,0)
RS S DICR=DICR+1,DICR(DICR)=X,DICR(DICR,0)=DIC(0),DIC(0)=$TR(DIC(0),"A"),DIC(0)=$TR(DIC(0),"Q") Q
"RTN","DICM",101,0)
 ;
"RTN","DICM",102,0)
D S:$G(DICR(DICR,10))]"" DINUM=DICR(DICR,10)
"RTN","DICM",103,0)
 S (D,DF)=DICR(DICR,4) D
"RTN","DICM",104,0)
 . N T S T=$P($G(DS),U,2)
"RTN","DICM",105,0)
 . S DIC(0)=$TR(DIC(0),"M","") I T["V" S DIC(0)=$TR(DIC(0),"A","")
"RTN","DICM",106,0)
 . I D="B",T'["D",'$G(DITRANX) S DIC(0)=DIC(0)_"s"
"RTN","DICM",107,0)
 . I T["P"!(T["V")!(T["S") S DIC(0)=DIC(0)_"X"
"RTN","DICM",108,0)
 . Q
"RTN","DICM",109,0)
 I DICR(DICR,4)=DINDEX N I M I=DINDEX N DINDEX M DINDEX=I K I S DINDEX("START")=DINDEX
"RTN","DICM",110,0)
 E  N DINDEX D
"RTN","DICM",111,0)
 . S (DINDEX,DINDEX("START"))=DICR(DICR,4),DINDEX("WAY")=1
"RTN","DICM",112,0)
 . D INDEX^DICUIX(.DIFILEI,DIFLAGS,.DINDEX,"",.DIVALUE) Q
"RTN","DICM",113,0)
 I DINDEX("#")>1 S (DINDEX(1),DINDEX(1,"FROM"),DINDEX(1,"PART"))=$G(X)
"RTN","DICM",114,0)
RCR S:'$D(DIDA) DICRS=1
"RTN","DICM",115,0)
DIC ;
"RTN","DICM",116,0)
 I $D(DICR(DICR,8)) S DIC(0)=$TR(DIC(0),"L")
"RTN","DICM",117,0)
 S Y=-1 I $D(X),$L(X)<31 D
"RTN","DICM",118,0)
 . N DIVAL S (DIVAL,DIVAL(1))=X N X S (X,X(1))=DIVAL
"RTN","DICM",119,0)
 . D RENUM^DIC1 K DIDA Q
"RTN","DICM",120,0)
 S:DIC(0)["L" DICR(DICR-1,6)=1 K:$D(DICR(DICR,4)) DF
"RTN","DICM",121,0)
E S D="B",%=DICR,X=DICR(%),DIC(0)=DICR(%,0),DICR=%-1
"RTN","DICM",122,0)
 S:$G(DICR(%,10))]"" DINUM=DICR(%,10)
"RTN","DICM",123,0)
 S:$D(DICR(%,9)) (D,DF)=DICR(%,9) I $G(DICR(%,9.1))]"" S:$P(DICR(%,9.1),U)]"" DID(1)=$P(DICR(%,9.1),U) S DID=$P(DICR(%,9.1),U,2,999)
"RTN","DICM",124,0)
 K DICRS,DICR(%) D DO^DIC1:'$D(DO) Q
"RTN","DICM",125,0)
 ;
"RTN","DICM",126,0)
NQ I $L(X)<14,X?.NP,+X=X,@("$D("_DIC_"X,0))") S Y=X D S^DIC3
"RTN","DICM",127,0)
 Q
"RTN","DICM",128,0)
 ;
"RTN","DICM",129,0)
SOUNDEX I DIC(0)["E",'$D(DICRS) W "  " D RS,SOU S DIC(0)=$TR(DIC(0),"L") D RCR Q:Y>0
"RTN","DICM",130,0)
 G R
"RTN","DICM",131,0)
 ;
"RTN","DICM",132,0)
7 S Y=-1 N % S %=$S($D(DIC("S")):DIC("S"),1:1)
"RTN","DICM",133,0)
 I $D(DS),'$D(DIC("S1")) D
"RTN","DICM",134,0)
 . S DIC("S")=DS I '% S DIC("S")=DIC("S")_" X DIC(""S1"")",DIC("S1")=%
"RTN","DICM",135,0)
 . I X]"" D
"RTN","DICM",136,0)
 . . N DIVAL S (DIVAL,DIVAL(1))=X,DIVAL(0)=1 N X S (X,X(1))=DIVAL
"RTN","DICM",137,0)
 . . N DINDEX,DIFILEI
"RTN","DICM",138,0)
 . . S DIC(0)=$TR(DIC(0),"L") D F^DIC
"RTN","DICM",139,0)
 . K DIC("S") S:$D(DIC("S1")) DIC("S")=DIC("S1") K DIC("S1")
"RTN","DICM",140,0)
 D E Q
"RTN","DICM",141,0)
 ;
"RTN","DICM",142,0)
SOU D SOU^DICM1 Q
"RTN","DICRW")
0^3^B13427185^B13105146
"RTN","DICRW",1,0)
DICRW ;SFISC/XAK-SELECT A FILE ;8/11/06  05:51
"RTN","DICRW",2,0)
 ;;22.0;VA FileMan;**149**;Mar 30, 1999;Build 2
"RTN","DICRW",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DICRW",4,0)
R D DT S D="OUTPUT FROM",DIC(0)="QEI",DIA=$S($D(^DISV(DUZ,"^DIC(")):^("^DIC("),1:"")
"RTN","DICRW",5,0)
 D R1,DIC K DIAC,DIFILE,DIC("S") Q:$D(DTOUT)  G R:'$T,AU:+Y=1.1,A:+Y=.6
"RTN","DICRW",6,0)
R2 I DUZ(0)'="@" S DICS="I 1 Q:'$D(^(8))  F DW=1:1:$L(^(8)) I DUZ(0)[$E(^(8),DW) Q"
"RTN","DICRW",7,0)
 K DIA Q
"RTN","DICRW",8,0)
 ;
"RTN","DICRW",9,0)
AU S D="AUDIT FROM",DIC(0)="QEI" S:'$D(DIC("S")) DIC("S")="I Y>1.1"
"RTN","DICRW",10,0)
 S:DIA ^DISV(DUZ,"^DIC(")=DIA D DIC Q:'$D(DIC)  G AU:Y<0
"RTN","DICRW",11,0)
 I '$D(DDA),'$D(^DIA(+Y,0))#2 W $C(7),"   NO AUDIT ENTRIES" G AU
"RTN","DICRW",12,0)
 S DIA=+Y,Y="1.1^"_$P(Y,U,2)_" AUDIT",DIC="^DIA(DIA,"
"RTN","DICRW",13,0)
 Q
"RTN","DICRW",14,0)
A S:'$D(DIC("S")) DIC("S")="S DIFILE=Y,DIAC=""DD"" D ^DIAC I %",DDA=""
"RTN","DICRW",15,0)
 D AU Q:'$D(DIC)
"RTN","DICRW",16,0)
 S %=$P(^DIC(DIA,0),U),Y=DIA D SUB I DIA'>0!$D(DTOUT)!$D(DUOUT) K DIC Q
"RTN","DICRW",17,0)
 I '$D(^DDA(DIA,0)) W !,"  No DD AUDIT entries!" K DIC Q
"RTN","DICRW",18,0)
 S Y=".6^"_$P(Y,U,2)_"DD AUDIT",DIC="^DDA(DIA,"
"RTN","DICRW",19,0)
 Q
"RTN","DICRW",20,0)
SUB I $D(DIT) S L=L+1,DFL(L)=$O(^DD(+Y,0,"NM","")),(DFF,DFF(L))=+Y,Y=-1
"RTN","DICRW",21,0)
 S DIC="^DD("_Y_"," Q:$O(^DD(Y,"SB",0))'>0  Q:$D(DIT)
"RTN","DICRW",22,0)
 S DIC(0)="AEQIZ",DIC("A")="Select "_%_" SUB-FILE: "
"RTN","DICRW",23,0)
 S DIC("S")="I $P(^(0),U,2)" D ^DIC Q:Y<0!$D(DTOUT)  S Y=+$P(Y(0),U,2)
"RTN","DICRW",24,0)
 S DIA=Y,%=$P($P(^DD(DIA,0),U)," SUB-FIELD")
"RTN","DICRW",25,0)
 I $D(DIT) S X=$P($P(Y(0),U,4),";",1),DSUB(L)=$S(X:X,1:""""_X_"""")_","
"RTN","DICRW",26,0)
 G SUB
"RTN","DICRW",27,0)
R1 S DIC("S")="S DIFILE=+Y,DIAC=""RD"" D ^DIAC I %"
"RTN","DICRW",28,0)
 Q
"RTN","DICRW",29,0)
DT ;
"RTN","DICRW",30,0)
 I $D(IO)#2,$D(IO(0))#2,IO=IO(0),IO=""
"RTN","DICRW",31,0)
 E  W:'$G(DIQUIET) !
"RTN","DICRW",32,0)
DTNOLF ; DT entry point without doing a line feed.
"RTN","DICRW",33,0)
 S:$D(DUZ)#2-1 DUZ=0 S:$D(DUZ(0))#2-1 DUZ(0)="" S X=DUZ(0)="@" D 1
"RTN","DICRW",34,0)
 I '$D(DTIME) S DTIME=300
"RTN","DICRW",35,0)
 I '$D(DILOCKTM) S DILOCKTM=+$G(^DD("DILOCKTM"),1) ;DI*146
"RTN","DICRW",36,0)
 K %DT,DT S:$D(IO(0))[0 IO(0)=$I D NOW^%DTC S DT=X,U="^"
"RTN","DICRW",37,0)
 K DIK,DIC,%I,DICS Q
"RTN","DICRW",38,0)
 ;
"RTN","DICRW",39,0)
0 S X=0
"RTN","DICRW",40,0)
1 D:'$D(DISYS) OS^DII
"RTN","DICRW",41,0)
 Q
"RTN","DICRW",42,0)
W D DT S D=$S('$D(DDS1):"INPUT TO",1:DDS1),DIC(0)=$E("L",$D(DLAYGO)>0)_"EQI"
"RTN","DICRW",43,0)
 D W1,DIC Q:$T!($D(DTOUT))  G W:'$P(Y,U,3) K DIC Q
"RTN","DICRW",44,0)
W1 S DIC("S")="I Y>.19,Y-1,Y-1.1,Y-.6,Y-.403,Y-.404,Y-.31 S DIFILE=+Y,DIAC=""WR"" D ^DIAC I %"
"RTN","DICRW",45,0)
 Q
"RTN","DICRW",46,0)
DIC W ! S U="^",D=D_" WHAT FILE: ",DIC="^DIC("
"RTN","DICRW",47,0)
 I DUZ(0)'="@",DIC(0)'["L",$S($D(^VA(200,"AFOF")):1,1:$D(^DIC(3,"AFOF"))) S DIC=$S($D(^VA(200,"AFOF")):"^VA(200,",1:DIC_"3,")_"DUZ,""FOF"","
"RTN","DICRW",48,0)
 I $D(^DISV(DUZ,DIC)) S Y=^(DIC) I $D(@(DIC_Y_",0)")) X:$D(DIC("S")) DIC("S") I  S Y=Y_U_$P(^DIC(Y,0),U),D=D_$P(Y,U,2)_"// "
"RTN","DICRW",49,0)
 W D S %=$T R X:DTIME E  W $C(7) S X=U,DTOUT=1,Y=-1 K DIC Q
"RTN","DICRW",50,0)
 I '$D(@(DIC_"0)")) W "  There are no selectable files." K DIC S Y=-1 Q
"RTN","DICRW",51,0)
 S:DIC["FOF" DIC(0)=DIC(0)_"O" I X="",% G WW
"RTN","DICRW",52,0)
 S DIC("W")=$P($T(WW1),";",3) D ^DIC I $D(DTOUT) K DIC Q
"RTN","DICRW",53,0)
GOT I $D(^DIC(+Y,0,"GL")) K DIC S DIC=^("GL") Q
"RTN","DICRW",54,0)
 I U[X K DIC
"RTN","DICRW",55,0)
 Q
"RTN","DICRW",56,0)
WW S A9=$P($T(WW1),";",3) X A9
"RTN","DICRW",57,0)
 K A9
"RTN","DICRW",58,0)
 G GOT
"RTN","DICRW",59,0)
 ;
"RTN","DICRW",60,0)
D D DT S D="MODIFY",DIC(0)="LQEI",DIC("S")="I Y'<2 S DIFILE=+Y,DIAC=""DD"" D ^DIAC I %"
"RTN","DICRW",61,0)
 D DIC S:DUZ(0)'="@" DICS="I 1 Q:'$D(^(9))  Q:^(9)=U  F DW=1:1:$L(^(9)) I DUZ(0)[$E(^(9),DW) Q"
"RTN","DICRW",62,0)
 Q:$T!($D(DTOUT))  G D:'$P(Y,U,3) K DIC
"RTN","DICRW",63,0)
 Q
"RTN","DICRW",64,0)
DIAR ;
"RTN","DICRW",65,0)
 D DT S D=$S($D(DIAX):"EXTRACT",1:"ARCHIVE")_" FROM",DIC(0)="QEI" D R1 S DIC("S")="I Y'<2 "_DIC("S")
"RTN","DICRW",66,0)
 D DIC G R2:$D(DTOUT)!(X="^")!(X="")!(Y>0&($P($G(^DD(+Y,0,"DI")),U)'["Y"))
"RTN","DICRW",67,0)
 W:$P($G(^DD(+Y,0,"DI")),U)["Y" !,$C(7),"SORRY, THIS IS ALREADY AN ARCHIVE FILE!"
"RTN","DICRW",68,0)
 G DIAR
"RTN","DICRW",69,0)
 Q
"RTN","DICRW",70,0)
T ; COMP/MERGE
"RTN","DICRW",71,0)
 D DT S D="COMPARE ENTRIES IN",DIC=1,DIC(0)="QEI" D W1,DIC Q:$T!($D(DTOUT))  G T
"RTN","DICRW",72,0)
 ;
"RTN","DICRW",73,0)
WW1 ;;W:$X>53 !?9 I Y-1.1,Y-.6,$D(^DIC(Y,0,"GL")),^("GL")'["[",$D(@(^("GL")_"0)")) S %=+$P(^(0),U,4) W ?40,"  ("_%_" entr"_$P("ies^y",U,%=1+1)_")"
"RTN","DIQG")
0^2^B36192228^B35600880
"RTN","DIQG",1,0)
DIQG ;SFISC/DCL-DATA RETRIEVAL PRIMITIVE ;29JUL2006
"RTN","DIQG",2,0)
 ;;22.0;VA FileMan;**76,118,133,149**;Mar 30, 1999;Build 2
"RTN","DIQG",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","DIQG",4,0)
GET(DIQGR,DA,DR,DIQGPARM,DIQGETA,DIQGERRA,DIQGIPAR) ; file,rec,fld,parm,targetarray,errarray,int
"RTN","DIQG",5,0)
DDENTRY I $G(U)'="^" N U S U="^"
"RTN","DIQG",6,0)
 I '$G(DA) N X S X(1)="RECORD" Q $$F(.X,2)
"RTN","DIQG",7,0)
 S DIQGIPAR=$G(DIQGIPAR),DIQGPARM=$G(DIQGPARM)
"RTN","DIQG",8,0)
 I 'DIQGIPAR N DIQGAUDR,DIQGAUDD S DIQGAUDD=+$P(DIQGPARM,"A",2) I DIQGAUDD D GET^DIAUTL(DIQGR,DA,DIQGAUDD,"DIQGAUDR")
"RTN","DIQG",9,0)
 N DFF,DIQGSI,DIQGDD,DIQGWPB,DIQGWPO S DIQGDD=DIQGPARM["D",DIQGWPB=DIQGPARM["B"
"RTN","DIQG",10,0)
 S DIQGWPO=1
"RTN","DIQG",11,0)
 N DIQGEY S DIQGEY("FILE")=$G(DIQGR),DIQGEY("RECORD")=$G(DA),DIQGEY("FIELD")=$G(DR)
"RTN","DIQG",12,0)
 I '$D(DIQGR) N X S X(1)="FILE" Q $$F(.X,1)
"RTN","DIQG",13,0)
 I 'DIQGR,'DIQGIPAR N X S X(1)="FILE" Q $$F(.X,12)
"RTN","DIQG",14,0)
DA D:$G(DA)["," IEN(DA,.DA)
"RTN","DIQG",15,0)
 I $G(DR)="" N X S X(1)="FIELD" Q $$F(.X,10)
"RTN","DIQG",16,0)
 I 'DIQGIPAR,'DIQGDD Q:$$N9^DIQGU(DIQGR,.DA) $$F(.DIQGEY,16) I '$D(^DD(DIQGR)) N X S X(1)="FILE" Q $$F(.X,18)
"RTN","DIQG",17,0)
 S DIQGETA=$G(DIQGETA) I DIQGETA["("&(DIQGETA'[")") N X S X(1)="TARGET ARRAY" Q $$F(.X,14)
"RTN","DIQG",18,0)
 I DIQGR S DFF=DIQGR,DIQGR=$S(DIQGDD:$$DDROOT(DIQGR),1:$$ROOT^DIQGU(DIQGR,.DA)) I DIQGR="" N X S X(1)="FILE and/or IEN" Q $$F(.X,4)
"RTN","DIQG",19,0)
DFF S DIQGSI=$$CREF(DIQGR) I '$D(DFF) S DFF=+$P($G(@DIQGSI@(0)),U,2) I 'DFF,DIQGPARM'["D" N X S X("FILE")=DIQGSI Q $$F(.X,6)  ;does the file exist?
"RTN","DIQG",20,0)
 I '$D(@DIQGSI@(DA)),'DIQGIPAR,DIQGPARM'["A" Q $$F(.DIQGEY,19)  ;Entry may have existed audited in the past
"RTN","DIQG",21,0)
 I '$G(DT) N DT S DT=$$DT^DIQGU($H)
"RTN","DIQG",22,0)
 N DIQGPI,DIQGZN S DIQGPI=DIQGPARM["I",DIQGZN=DIQGPARM["Z"
"RTN","DIQG",23,0)
 N %,%H,%T,I,J,N,X
"RTN","DIQG",24,0)
D0 S X=0,N="D0" F  S X=$O(DA(X)) Q:X'>0  S I=X,N=N_",D"_X
"RTN","DIQG",25,0)
 N @N
"RTN","DIQG",26,0)
 S @("D"_+$G(I)_"=DA") I $G(I) F J=I-1:-1:0 S @("D"_J_"=DA(I-J)")
"RTN","DIQG",27,0)
 N C,P,Y,DIQGDN,DIQGD4,DIQGDRN
"RTN","DIQG",28,0)
 S (X,Y)="",DIQGDRN=DR
"RTN","DIQG",29,0)
DD S DIQGDN="^DD("_$S(DIQGPARM["D":0,1:DFF)_")" ;name of ^DD
"RTN","DIQG",30,0)
FIELD I DR'?.N,$D(@DIQGDN@("B",DR)) S DIQGDRN=$O(^(DR,"")) I $O(^(DIQGDRN)) N X S X("FILE")=DIQGDN,X(1)=DR Q $$F(.X,15)
"RTN","DIQG",31,0)
 I DIQGDD,DIQGDRN'>0 D  I $E(DIQGDRN,1,6)="$$$ NO" N X S X(1)="ATTRIBUTE" Q $$F(.X,17)
"RTN","DIQG",32,0)
 .S DIQGDRN=$$DDN^DIQGU0(DR) Q:$E(DIQGDRN,1,6)="$$$ NO"
"RTN","DIQG",33,0)
 .S DIQGDN="^DD("_$P(DIQGDRN,"^")_")",DIQGDRN=$P(DIQGDRN,"^",2)
"RTN","DIQG",34,0)
 I DIQGDRN>0,$D(@DIQGDN@(DIQGDRN,0)) S DIQGD4=$P(^(0),"^",4),C=$P(^(0),"^",2),P=$P(DIQGD4,";") G:$P(DIQGD4,";",2)'>0 DIQ S Y=$P($G(@DIQGSI@(DA,P)),"^",$P(DIQGD4,";",2)) G DIQ
"RTN","DIQG",35,0)
TRYCOMP N X,DIQGS I 'DIQGIPAR D EXPR(DFF,DR) ;DON'T ALLOW COMPUTED EXPRESSIONS EXCEPT FROM $$GET1^DIQ
"RTN","DIQG",36,0)
 I $D(X) S C=Y G C:C["m" D CMPAUD(DR,$G(X("USED"))) I $D(X) X X Q X
"RTN","DIQG",37,0)
GIVEUP Q $$F(.DIQGEY,7)
"RTN","DIQG",38,0)
 ;
"RTN","DIQG",39,0)
DIQ I DIQGDRN=.001 S Y=DA
"RTN","DIQG",40,0)
 G BMW:C,REAL:C'["C"
"RTN","DIQG",41,0)
C I C["m" N X S X(1)="MULTILINE COMPUTED" Q $$F(.X,3)
"RTN","DIQG",42,0)
 ;I DIQGPI Q "" MAR2001 GFT
"RTN","DIQG",43,0)
 I DIQGDN="^DD(1.005)",DIQGDRN=1 S X=@DIQGSI@(DA,0)
"RTN","DIQG",44,0)
 N DCC,DIQGH,X,DFF S DIQGH=$G(DIERR),DCC=DIQGR,DFF=+$P(DCC,"(",2)
"RTN","DIQG",45,0)
 I $D(@DIQGDN@(DIQGDRN,9.01)),$D(^(9.1)) D CMPAUD(^(9.1),^(9.01)) I $D(X) X X I 1
"RTN","DIQG",46,0)
 E  S X="" X $P(@DIQGDN@(DIQGDRN,0),"^",5,999) ;HELLEVI
"RTN","DIQG",47,0)
 D:DIQGH'=$G(DIERR)
"RTN","DIQG",48,0)
 .N X
"RTN","DIQG",49,0)
 .D BLD^DIALOG(120,"FIELD")
"RTN","DIQG",50,0)
 I $G(X)=""!DIQGPI Q $G(X)
"RTN","DIQG",51,0)
CP I C["p",X S C=+$P(C,"p",2) I C,$D(^DIC(C,0,"GL")),$D(@(^("GL")_"0)")),$D(^(X,0)) Q $$EXTERNAL^DIDU(C,.01,"",$P(^(0),U))
"RTN","DIQG",52,0)
 Q $S(C["D":$$FMTE^DILIBF(X,"1U"),1:X)
"RTN","DIQG",53,0)
 ;
"RTN","DIQG",54,0)
REAL I $E($P(DIQGD4,";",2))="E" S Y=$E($G(@DIQGSI@(DA,P)),$E($P($P(DIQGD4,";",2),","),2,99),$P($P(DIQGD4,";",2),",",2)) S:Y?." " Y="" ;SPACES ARE NULL
"RTN","DIQG",55,0)
AUDIT I $G(DIQGAUDD) D  ;Is there an AUDIT TRAIL for the field?
"RTN","DIQG",56,0)
 .I $G(DIQGAUDR(DFF,$$DA^DIQGQ(.DA))) S Y="" Q  ;If entry was created after DIQGAUDD, we know there were no FIELD values!
"RTN","DIQG",57,0)
 .S P=$G(DIQGAUDR(DFF,$$DA^DIQGQ(.DA),DIQGDRN))
"RTN","DIQG",58,0)
 .I P S Y=$$DIA^DIAUTL(DIQGAUDD,DIQGAUDR,P)
"RTN","DIQG",59,0)
 .Q:C'["P"!'Y  N F S F=+$P(C,"P",2) Q:F=DIQGEY("FILE")&(Y=DA)
"RTN","DIQG",60,0)
 .S Y=$$GET1^DIQ(F,Y_",",.01,"A"_DIQGAUDD),C=$TR(C,"PO") ;Recurse to get old POINTER value (as long as recursion isn't infinite!)
"RTN","DIQG",61,0)
 I 'DIQGPI&(C["O"!(C["S")!(C["P")!(C["V")!(C["D"))&($D(@DIQGDN@(DIQGDRN,0))) S C=$P(^(0),"^",2) Q $$EXTERNAL^DIDU(+$P(DIQGDN,"(",2),DIQGDRN,"",Y)
"RTN","DIQG",62,0)
 Q $G(Y)
"RTN","DIQG",63,0)
 ;
"RTN","DIQG",64,0)
BMW I C,$P(^DD(+C,.01,0),"^",2)["W" Q:DIQGWPB "$CREF$"_DIQGR_DA_","_$$Q^DIQGU(P)_")" D  G:X="" FE Q:DIQGWPO $NA(@DIQGETA) Q:DIQGIPAR "$WP$" Q ""
"RTN","DIQG",65,0)
 .I DIQGETA']"" K X S X(1)="TARGET ARRAY" D BLD^DIALOG(202,.X) S X="" Q
"RTN","DIQG",66,0)
 .S X=DIQGR_DA_","_$$Q^DIQGU(P)_")"
"RTN","DIQG",67,0)
 .I '$P($G(@X@(0)),"^",3) S X="" Q
"RTN","DIQG",68,0)
 .I DIQGZN M @DIQGETA=@X K @DIQGETA@(0) Q
"RTN","DIQG",69,0)
 .S Y=0 F  S Y=$O(@X@(Y)) Q:Y'>0  I $D(^(Y,0)) S @DIQGETA@(Y)=^(0)
"RTN","DIQG",70,0)
 .Q
"RTN","DIQG",71,0)
 I C,$P(^DD(+C,.01,0),"^",2)["M" Q $$F(.DIQGEY,11)
"RTN","DIQG",72,0)
 I DIQGPI!(DIQGDD) Q $G(Y)
"RTN","DIQG",73,0)
 Q $$F(.DIQGEY,8)
"RTN","DIQG",74,0)
CREF(X) N L,X1,X2,X3 S X1=$P(X,"("),X2=$P(X,"(",2,99),L=$L(X2),X3=$TR($E(X2,L),",)"),X2=$E(X2,1,(L-1))_X3 Q X1_$S(X2]"":"("_X2_")",1:"")
"RTN","DIQG",75,0)
WP(DIQGSA,DIQGTA,DIQGZN,DIQGP) N DIQG S DIQG=0 F  S DIQG=$O(@DIQGSA@(DIQG)) Q:DIQG'>0  I $D(^(DIQG,0)) S @$S(DIQGZN:"@DIQGTA@(DIQG,0)",1:"@DIQGTA@(DIQG)")=^(0)
"RTN","DIQG",76,0)
 Q:DIQGP "$WP$" Q ""
"RTN","DIQG",77,0)
DY(Y) Q $$FMTE^DILIBF(Y,"1U")
"RTN","DIQG",78,0)
IEN(IEN,DA) S DA=$P(IEN,",") N I F I=2:1 Q:$P(IEN,",",I)=""  S DA(I-1)=$P(IEN,",",I)
"RTN","DIQG",79,0)
 Q
"RTN","DIQG",80,0)
DDROOT(X) Q:'$D(^DD(X)) "" Q "^DD("_X_","
"RTN","DIQG",81,0)
 ;
"RTN","DIQG",82,0)
CMPAUD(DEXPR,DIQGS) ;DEXPR is Expression, DIQGS is string of Fields used
"RTN","DIQG",83,0)
 Q:'$G(DIQGAUDD)
"RTN","DIQG",84,0)
 N I,F,FD,A
"RTN","DIQG",85,0)
 F I=1:1 S F=$P(DIQGS,";",I) Q:F=""  D
"RTN","DIQG",86,0)
 .S A=$G(DIQGAUDR(+F,$$DA^DIQGQ(.DA),$P(F,U,2)))
"RTN","DIQG",87,0)
 .I A S DIQGS(1,+F,$P(F,U,2))=""""_$$CONVQQ^DILIBF($$DIA^DIAUTL(DIQGAUDD,+F,A))_""""
"RTN","DIQG",88,0)
 S DIQGS("TODAY")=DIQGAUDD\1,DIQGS("TODAY","DATE")=1,DIQGS("NOW")=DIQGAUDD,DIQGS("NOW","DATE")=1 ;'TODAY' is the old date!
"RTN","DIQG",89,0)
 ;now we call DICOMP with old (audit) values plugged in to the field's Computed Expression --
"RTN","DIQG",90,0)
 D EXPR(DIQGAUDR,DEXPR)
"RTN","DIQG",91,0)
 Q
"RTN","DIQG",92,0)
EXPR(DIFILE,DIEXPR) I DIQGPI K X Q:$TR(DIEXPR," 1234567890.?")=""  S DIEXPR="INTERNAL("_DIEXPR_")"
"RTN","DIQG",93,0)
 D EXPR^DICOMP(DIFILE,"",DIEXPR,.DIQGS)
"RTN","DIQG",94,0)
 I 'DIQGPI,$G(Y)["D",Y'["m",$D(X)#2 S X=X_" S X=$$FMTE^DILIBF(X,""5U"")"
"RTN","DIQG",95,0)
 Q
"RTN","DIQG",96,0)
 ;
"RTN","DIQG",97,0)
F(DIQGEY,X) D BLD^DIALOG($P($T(TXT+X),";",4),.DIQGEY)
"RTN","DIQG",98,0)
FE I $G(DIQGERRA)]"" D CALLOUT^DIEFU(DIQGERRA)
"RTN","DIQG",99,0)
 Q ""
"RTN","DIQG",100,0)
TXT ;;
"RTN","DIQG",101,0)
 ;;file root/ref invalid;202;1
"RTN","DIQG",102,0)
 ;;record invalid;202;2
"RTN","DIQG",103,0)
 ;;multiline computed;520;3
"RTN","DIQG",104,0)
 ;;file ref invalid;202;4
"RTN","DIQG",105,0)
 ;;field name/number invalid;202;5
"RTN","DIQG",106,0)
 ;;DD ref for file/field invalid;401;6
"RTN","DIQG",107,0)
 ;;unable to find field name;200;7
"RTN","DIQG",108,0)
 ;;unable to identify type of data in DD;510;8
"RTN","DIQG",109,0)
 ;;unable to resolve extended ref;501;9
"RTN","DIQG",110,0)
 ;;field ref missing;202;10
"RTN","DIQG",111,0)
 ;;multiple field - invalid parameters;309;11
"RTN","DIQG",112,0)
 ;;file number not passed or invalid;202;12
"RTN","DIQG",113,0)
 ;;;;13
"RTN","DIQG",114,0)
 ;;invalid target array;202;14
"RTN","DIQG",115,0)
 ;;ambiguous field name;505;15
"RTN","DIQG",116,0)
 ;;record unavailable;602;16
"RTN","DIQG",117,0)
 ;;invalid attribute;202;17
"RTN","DIQG",118,0)
 ;;file not found;202;18
"RTN","DIQG",119,0)
 ;;record entry does not exist;601;19
"RTN","DIQG",120,0)
 ;;;;20
"VER")
8^22.0
"BLD",585,6)
^135
**END**
**END**
