Released RG*1*35 SEQ #35
Extracted from mail message
**KIDS**:RG*1.0*35^

**INSTALL NAME**
RG*1.0*35
"BLD",1976,0)
RG*1.0*35^CLINICAL INFO RESOURCE NETWORK^0^3040628^y
"BLD",1976,1,0)
^^3^3^3040527^
"BLD",1976,1,1,0)
REMOVE 'TEST' PATIENT SCREEN - MPI CHANGES ITERATION 2
"BLD",1976,1,2,0)
Refer to patch RG*1.0*35 in the FORUM Patch Module for a complete
"BLD",1976,1,3,0)
description.
"BLD",1976,4,0)
^9.64PA^^
"BLD",1976,"ABNS",0)
^9.66A^^
"BLD",1976,"ABPKG")
^^
"BLD",1976,"INID")
^
"BLD",1976,"INIT")

"BLD",1976,"KRN",0)
^9.67PA^8989.52^19
"BLD",1976,"KRN",.4,0)
.4
"BLD",1976,"KRN",.401,0)
.401
"BLD",1976,"KRN",.402,0)
.402
"BLD",1976,"KRN",.403,0)
.403
"BLD",1976,"KRN",.5,0)
.5
"BLD",1976,"KRN",.84,0)
.84
"BLD",1976,"KRN",3.6,0)
3.6
"BLD",1976,"KRN",3.8,0)
3.8
"BLD",1976,"KRN",9.2,0)
9.2
"BLD",1976,"KRN",9.8,0)
9.8
"BLD",1976,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",1976,"KRN",9.8,"NM",1,0)
RGADTP^^0^B42232817
"BLD",1976,"KRN",9.8,"NM",2,0)
RGEVPRG^^0^B41075390
"BLD",1976,"KRN",9.8,"NM","B","RGADTP",1)

"BLD",1976,"KRN",9.8,"NM","B","RGEVPRG",2)

"BLD",1976,"KRN",19,0)
19
"BLD",1976,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",1976,"KRN",19,"NM",1,0)
RG EXCEPTION PURGE^^0
"BLD",1976,"KRN",19,"NM","B","RG EXCEPTION PURGE",1)

"BLD",1976,"KRN",19.1,0)
19.1
"BLD",1976,"KRN",101,0)
101
"BLD",1976,"KRN",409.61,0)
409.61
"BLD",1976,"KRN",771,0)
771
"BLD",1976,"KRN",870,0)
870
"BLD",1976,"KRN",8989.51,0)
8989.51
"BLD",1976,"KRN",8989.52,0)
8989.52
"BLD",1976,"KRN",8994,0)
8994
"BLD",1976,"KRN","B",.4,.4)

"BLD",1976,"KRN","B",.401,.401)

"BLD",1976,"KRN","B",.402,.402)

"BLD",1976,"KRN","B",.403,.403)

"BLD",1976,"KRN","B",.5,.5)

"BLD",1976,"KRN","B",.84,.84)

"BLD",1976,"KRN","B",3.6,3.6)

"BLD",1976,"KRN","B",3.8,3.8)

"BLD",1976,"KRN","B",9.2,9.2)

"BLD",1976,"KRN","B",9.8,9.8)

"BLD",1976,"KRN","B",19,19)

"BLD",1976,"KRN","B",19.1,19.1)

"BLD",1976,"KRN","B",101,101)

"BLD",1976,"KRN","B",409.61,409.61)

"BLD",1976,"KRN","B",771,771)

"BLD",1976,"KRN","B",870,870)

"BLD",1976,"KRN","B",8989.51,8989.51)

"BLD",1976,"KRN","B",8989.52,8989.52)

"BLD",1976,"KRN","B",8994,8994)

"BLD",1976,"PRET")

"BLD",1976,"QUES",0)
^9.62^^
"BLD",1976,"REQB",0)
^9.611^3^3
"BLD",1976,"REQB",1,0)
RG*1.0*34^1
"BLD",1976,"REQB",2,0)
DG*5.3*589^1
"BLD",1976,"REQB",3,0)
RG*1.0*32^2
"BLD",1976,"REQB","B","DG*5.3*589",2)

"BLD",1976,"REQB","B","RG*1.0*32",3)

"BLD",1976,"REQB","B","RG*1.0*34",1)

"KRN",19,6656,-1)
0^1
"KRN",19,6656,0)
RG EXCEPTION PURGE^MPI/PD Exception Purge ^^R^^^^^^^^CLINICAL INFO RESOURCE NETWORK
"KRN",19,6656,1,0)
^19.06^4^4^3040610^^
"KRN",19,6656,1,1,0)
This option purges duplicate entries, resolved entries over
"KRN",19,6656,1,2,0)
30 days old, and entries for patients were the name field is
"KRN",19,6656,1,3,0)
null or patient has been merge (i.e., has a -9 node) from the
"KRN",19,6656,1,4,0)
CIRN HL7 EXCEPTION LOG (#991.1) file.
"KRN",19,6656,25)
MAIN^RGEVPRG
"KRN",19,6656,"U")
MPI/PD EXCEPTION PURGE 
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^^0
"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
35^3040628
"PKG",272,22,1,"PAH",1,1,0)
^^3^3^3040628
"PKG",272,22,1,"PAH",1,1,1,0)
REMOVE 'TEST' PATIENT SCREEN - MPI CHANGES ITERATION 2
"PKG",272,22,1,"PAH",1,1,2,0)
Refer to patch RG*1.0*35 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","RGADTP")
0^1^B42232817
"RTN","RGADTP",1,0)
RGADTP ;BIR/DLR-ADT PROCESSOR TO RETRIGGER A08 or A04 MESSAGES WITH AL/AL (COMMIT/APPLICATION) ACKNOWLEDGEMENTS ;5/28/02
"RTN","RGADTP",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**26,27,20,34,35**;30 Apr 99
"RTN","RGADTP",3,0)
 ;
"RTN","RGADTP",4,0)
 ;Reference to BLDEVN^VAFCQRY and BLDPID^VAFCQRY supported by IA #3630
"RTN","RGADTP",5,0)
 ;
"RTN","RGADTP",6,0)
INIT ;
"RTN","RGADTP",7,0)
 N RGER,RGSITE,ARRAY,MSH,RGLOCAL,RGEVNT,REP,DIC,DR,DIE,DA,DLAYGO
"RTN","RGADTP",8,0)
 S RGER=""
"RTN","RGADTP",9,0)
 D IN
"RTN","RGADTP",10,0)
 D PROCIN
"RTN","RGADTP",11,0)
 D GENACK
"RTN","RGADTP",12,0)
 Q
"RTN","RGADTP",13,0)
PROC ;processing entry point
"RTN","RGADTP",14,0)
 N HLA,RGADT,PV1,DIC,ARRAY,RGEVNT,RGLOCAL,REP,ICN,RGSITE
"RTN","RGADTP",15,0)
 S RGEVNT=HL("ETN")
"RTN","RGADTP",16,0)
 I $G(HL("MID"))'="" S RGADT=HL("MID")
"RTN","RGADTP",17,0)
 I $G(HL("MID"))="" S RGADT=999
"RTN","RGADTP",18,0)
 D IN
"RTN","RGADTP",19,0)
 ;**35 removed reference to stop process if patient is "test" pt
"RTN","RGADTP",20,0)
 S ICN=$G(ARRAY("ICN"))
"RTN","RGADTP",21,0)
 ;S ICN=$$GETICN^MPIF001(DFN)
"RTN","RGADTP",22,0)
 I +$G(ICN)<1 Q  ;quit if no ICN
"RTN","RGADTP",23,0)
 I $E($G(ICN),1,3)=$P($$SITE^VASITE,"^",3) Q  ;quit if ICN is a local
"RTN","RGADTP",24,0)
 S ZTSAVE("DFN")="",ZTSAVE("RGEVNT")="",ZTSAVE("HLA(""HLS"",")="",ZTRTN="SEND^RGADTPC",ZTDESC="Sending HL7 Patient Update...",ZTIO="RG QUEUE",ZTDTH=$H D ^%ZTLOAD
"RTN","RGADTP",25,0)
 K ZTSAVE,ZTRTN,ZTDESC,ZTIO,ZTDTH
"RTN","RGADTP",26,0)
 Q
"RTN","RGADTP",27,0)
IN ;Process in the ADT A04/A08 (routing logic)
"RTN","RGADTP",28,0)
 N RGI,MSG,RG,SG,DFN,EVN,SITE,RGC,RGJ,DIC,PV1,PID,COMP
"RTN","RGADTP",29,0)
 ;set local flag to indicate the processing of an outbound for reformatting
"RTN","RGADTP",30,0)
 S REP=$E(HL("ECH"),2)
"RTN","RGADTP",31,0)
 S COMP=$E(HL("ECH"),1)
"RTN","RGADTP",32,0)
 I $P($G(HL("SAF")),COMP)=$P($$SITE^VASITE,"^",3) S RGLOCAL=1
"RTN","RGADTP",33,0)
 I $P($G(HL("SAF")),COMP)'=$P($$SITE^VASITE,"^",3) S RGLOCAL=0
"RTN","RGADTP",34,0)
 S RGC=$E($G(HL("ECH")),1)
"RTN","RGADTP",35,0)
 F RGI=1:1 X HLNEXT Q:HLQUIT'>0  S MSG=HLNODE,SG=$E(HLNODE,1,3) D
"RTN","RGADTP",36,0)
 . S RGJ=0 F  S RGJ=$O(HLNODE(RGJ)) Q:'RGJ  S MSG(RGJ)=HLNODE(RGJ)
"RTN","RGADTP",37,0)
 . D:SG?2A1(1A,1N) PICK
"RTN","RGADTP",38,0)
 ;if message MSH sending facility matches the PID assigning authority update
"RTN","RGADTP",39,0)
QUIT Q
"RTN","RGADTP",40,0)
ROUTE ;
"RTN","RGADTP",41,0)
 N RGERR
"RTN","RGADTP",42,0)
 I $G(RGEVNT)="" S RGEVNT=$G(HL("ETN"))
"RTN","RGADTP",43,0)
 N MPI S MPI=$$MPILINK^MPIFAPI() D
"RTN","RGADTP",44,0)
 . I $P($G(MPI),U)'=-1 S HLL("LINKS",1)="RG ADT-"_HL("ETN")_" 2.4 CLIENT^"_MPI
"RTN","RGADTP",45,0)
 . I $P($G(MPI),U)=-1 D
"RTN","RGADTP",46,0)
 .. N RGLOG,RGMTXT
"RTN","RGADTP",47,0)
 .. D START^RGHLLOG(HLMTIEN,"","")
"RTN","RGADTP",48,0)
 .. S RGMTXT="for DFN#"_$G(DFN)
"RTN","RGADTP",49,0)
 .. D EXC^RGHLLOG(224,"No MPI link identified"_RGMTXT,$G(DFN)) S RGERR=1
"RTN","RGADTP",50,0)
 I $G(RGERR)'=1 S ^XTMP("RG"_HL("ETN")_"%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"RG"_HL("ETN")_" msg to MPI for DFN "_DFN S ^XTMP("RG"_HL("ETN")_"%"_DFN,"MPI",0)="A"
"RTN","RGADTP",51,0)
 Q
"RTN","RGADTP",52,0)
RESP ;
"RTN","RGADTP",53,0)
 N RGER,RGSITE,ARRAY,MSH,RGLOCAL,RGEVNT
"RTN","RGADTP",54,0)
 N RGI,MSG,RG,SG,DFN,EVN,SITE,RGC,RGJ,DIC,PV1,PID
"RTN","RGADTP",55,0)
 D IN
"RTN","RGADTP",56,0)
 Q
"RTN","RGADTP",57,0)
PICK ;check routine for segment entry point
"RTN","RGADTP",58,0)
 I $T(@SG)]"" D @SG
"RTN","RGADTP",59,0)
 I $T(@SG)="" Q
"RTN","RGADTP",60,0)
 Q
"RTN","RGADTP",61,0)
MSA ;;
"RTN","RGADTP",62,0)
 ;process the MSA segment
"RTN","RGADTP",63,0)
 N ARRAY,CNT,DFN,EXIT,HLCOMP,RGAA,RGERR,RGEVNT,RGMSG,RETURN,RGX,RGY
"RTN","RGADTP",64,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",65,0)
 S RGAA=MSG
"RTN","RGADTP",66,0)
 S EXIT=0
"RTN","RGADTP",67,0)
 S RGMSG=$P(RGAA,HL("FS"),3)
"RTN","RGADTP",68,0)
 S RGERR=$P(RGAA,HL("FS"),4)
"RTN","RGADTP",69,0)
 S RGMSG=$$MSG^HLCSUTL(RGMSG,"RETURN(1)")
"RTN","RGADTP",70,0)
 K RGMSG
"RTN","RGADTP",71,0)
 S CNT=1,RGX=0 F  S RGX=$O(RETURN(1,RGX)) Q:'RGX!(EXIT=1)  D
"RTN","RGADTP",72,0)
 . I RETURN(1,RGX)'="" D
"RTN","RGADTP",73,0)
 .. I $D(RGMSG) S RGMSG(CNT)=RETURN(1,RGX),CNT=CNT+1
"RTN","RGADTP",74,0)
 .. I '$D(RGMSG) S RGMSG=RETURN(1,RGX),RGY=RGX
"RTN","RGADTP",75,0)
 . I RETURN(1,RGX)="" D  S CNT=1 K RGMSG
"RTN","RGADTP",76,0)
 .. I $E(RETURN(1,RGY),1,3)="MSH" D MSH
"RTN","RGADTP",77,0)
 .. I $E(RETURN(1,RGY),1,3)="PID" D PIDP^RGADTP1(.RGMSG,.ARRAY,.HL) S EXIT=1
"RTN","RGADTP",78,0)
 S DFN=$G(ARRAY("DFN"))
"RTN","RGADTP",79,0)
 I $D(^XTMP("RG"_HL("ETN")_"%"_DFN,0)) K ^XTMP("RG"_HL("ETN")_"%"_DFN)
"RTN","RGADTP",80,0)
 Q
"RTN","RGADTP",81,0)
MSH ;;
"RTN","RGADTP",82,0)
 S MSH=1
"RTN","RGADTP",83,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",84,0)
 I 'RGLOCAL S RGC=$E(HL("ECH"),1)
"RTN","RGADTP",85,0)
 S RGSITE=$P($P(MSG,HL("FS"),4),RGC)
"RTN","RGADTP",86,0)
 S RGEVNT=$P($P(MSG,HL("FS"),9),RGC,2)
"RTN","RGADTP",87,0)
 Q
"RTN","RGADTP",88,0)
EVN ;;
"RTN","RGADTP",89,0)
 N CNT,ERR
"RTN","RGADTP",90,0)
 S EVN=RGI
"RTN","RGADTP",91,0)
 I RGLOCAL S (EVN(1),HLA("HLS",RGI))=MSG
"RTN","RGADTP",92,0)
 I 'RGLOCAL D
"RTN","RGADTP",93,0)
 .S ARRAY("EVR")=$P(MSG,HL("FS"),2)
"RTN","RGADTP",94,0)
 .S ARRAY("DLT")=$$FMDATE^HLFNC($P(MSG,HL("FS"),3))
"RTN","RGADTP",95,0)
 .S ARRAY("EVNAME")=$$FMNAME^XLFNAME($P(MSG,HL("FS"),2),"",$E(HL("ECH"),1))
"RTN","RGADTP",96,0)
 .S ARRAY("SENDING SITE")=$P(MSG,HL("FS"),8)
"RTN","RGADTP",97,0)
 Q
"RTN","RGADTP",98,0)
EVNP ;
"RTN","RGADTP",99,0)
 N EVNX
"RTN","RGADTP",100,0)
 I $G(DFN)'="" D BLDEVN^VAFCQRY(DFN,"1,2,4,5,6,7",.EVN,.HL,$G(HL("ETN")),.ERR) S CNT=0,EVNX=0 F  S EVNX=$O(EVN(EVNX)) Q:'EVNX  D
"RTN","RGADTP",101,0)
 . I CNT>0 S HLA("HLS",EVN,CNT)=EVN(EVNX),CNT=CNT+1
"RTN","RGADTP",102,0)
 . I CNT'>0 S HLA("HLS",EVN)=EVN(EVNX),CNT=CNT+1
"RTN","RGADTP",103,0)
 Q
"RTN","RGADTP",104,0)
PID ;;
"RTN","RGADTP",105,0)
 N CNT,PIDX
"RTN","RGADTP",106,0)
 I RGLOCAL D
"RTN","RGADTP",107,0)
 .N HLCOMP S HLCOMP=$E(HL("ECH"),1)
"RTN","RGADTP",108,0)
 .S HLA("HLS",RGI)=MSG
"RTN","RGADTP",109,0)
 .S DFN=+$P(MSG,HL("FS"),4)
"RTN","RGADTP",110,0)
 .D EVNP
"RTN","RGADTP",111,0)
 .D BLDPID^VAFCQRY(DFN,1,"ALL",.PID,.HL)
"RTN","RGADTP",112,0)
 .;get Primary ICN value in the PID segment
"RTN","RGADTP",113,0)
 .S ARRAY("ICN")=+$P($P(PID(1),HL("FS"),4),HLCOMP)
"RTN","RGADTP",114,0)
 .S CNT=0,PIDX=0 F  S PIDX=$O(PID(PIDX)) Q:'PIDX  D
"RTN","RGADTP",115,0)
 .. I CNT>0 S HLA("HLS",RGI,CNT)=PID(PIDX),CNT=CNT+1
"RTN","RGADTP",116,0)
 .. I CNT'>0 S HLA("HLS",RGI)=PID(PIDX),CNT=CNT+1
"RTN","RGADTP",117,0)
 I 'RGLOCAL D PIDP^RGADTP1(.MSG,.ARRAY,.HL)
"RTN","RGADTP",118,0)
 Q
"RTN","RGADTP",119,0)
PD1 ;;
"RTN","RGADTP",120,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",121,0)
 I 'RGLOCAL S (ARRAY(991.03),ARRAY("CMOR"))=$P($P(MSG,HL("FS"),4),RGC)
"RTN","RGADTP",122,0)
 Q
"RTN","RGADTP",123,0)
PV1 ;;
"RTN","RGADTP",124,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",125,0)
 Q
"RTN","RGADTP",126,0)
OBX ;;
"RTN","RGADTP",127,0)
 N COMP S COMP=$E(HL("ECH"),1)
"RTN","RGADTP",128,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",129,0)
 I 'RGLOCAL D:$$FREE^RGRSPARS($P($P(MSG,HL("FS"),4),RGC,2))="SECURITY LEVEL"
"RTN","RGADTP",130,0)
 . S ARRAY("SENSITIVITY")=$$SENSTIVE^RGRSPARS($P(MSG,HL("FS"),6),COMP)
"RTN","RGADTP",131,0)
 . S ARRAY("SENSITIVITY USER")=$$FREE^RGRSPARS($P($P(MSG,HL("FS"),17),RGC,2))_","_$$FREE^RGRSPARS($P($P(MSG,HL("FS"),17),RGC,3))
"RTN","RGADTP",132,0)
 . S ARRAY("SENSITIVITY DATE")=$$FREE^RGRSPARS($$FMDATE^HLFNC($P(MSG,HL("FS"),15)))
"RTN","RGADTP",133,0)
 Q
"RTN","RGADTP",134,0)
ZPD ;;
"RTN","RGADTP",135,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",136,0)
 ;I 'RGLOCAL S ARRAY(.351)=$$FREE^RGRSPARS($P(MSG,HL("FS"),5))
"RTN","RGADTP",137,0)
 Q
"RTN","RGADTP",138,0)
ZSP ;;
"RTN","RGADTP",139,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",140,0)
 I 'RGLOCAL D
"RTN","RGADTP",141,0)
 . S ARRAY(.301)=$$YESNO^RGRSPARS($P(MSG,HL("FS"),3))
"RTN","RGADTP",142,0)
 . S ARRAY(.302)=$$FREE^RGRSPARS($P(MSG,HL("FS"),4))
"RTN","RGADTP",143,0)
 . S ARRAY(.323)=$$POS^RGRSPARS($P(MSG,HL("FS"),5))
"RTN","RGADTP",144,0)
 Q
"RTN","RGADTP",145,0)
ZEL ;;
"RTN","RGADTP",146,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",147,0)
 I 'RGLOCAL D
"RTN","RGADTP",148,0)
 . S ARRAY(.361)=$$ELIG^RGRSPARS($P(MSG,HL("FS"),3))
"RTN","RGADTP",149,0)
 . S ARRAY(.3612)=$$FREE^RGRSPARS($P(MSG,HL("FS"),12))
"RTN","RGADTP",150,0)
 . S ARRAY(.3615)=$$FREE^RGRSPARS($P(MSG,HL("FS"),14))
"RTN","RGADTP",151,0)
 . S ARRAY(391)=$$TYPE^RGRSPARS($P(MSG,HL("FS"),10))
"RTN","RGADTP",152,0)
 . S ARRAY(1901)=$$VETERAN^RGRSPARS($P(MSG,HL("FS"),9))
"RTN","RGADTP",153,0)
 Q
"RTN","RGADTP",154,0)
ZCT ;;
"RTN","RGADTP",155,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",156,0)
 I 'RGLOCAL D
"RTN","RGADTP",157,0)
 . S ARRAY(.211)=$$FREE^RGRSPARS($P(MSG,HL("FS"),4))
"RTN","RGADTP",158,0)
 . S ARRAY(.219)=$$FREE^RGRSPARS($P(MSG,HL("FS"),7))
"RTN","RGADTP",159,0)
 Q
"RTN","RGADTP",160,0)
ZEM ;;
"RTN","RGADTP",161,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",162,0)
 I 'RGLOCAL D
"RTN","RGADTP",163,0)
 . S ARRAY(.31115)=$$EMP^RGRSPARS($P(MSG,HL("FS"),4))
"RTN","RGADTP",164,0)
 Q
"RTN","RGADTP",165,0)
ZFF ;;
"RTN","RGADTP",166,0)
 I RGLOCAL S HLA("HLS",RGI)=MSG
"RTN","RGADTP",167,0)
 I 'RGLOCAL S ARRAY("FLD")=$P(MSG,HL("FS"),3)
"RTN","RGADTP",168,0)
 Q
"RTN","RGADTP",169,0)
PROCIN ;
"RTN","RGADTP",170,0)
 D PROCIN^RGADTP2(.ARRAY,.RGLOCAL,.RGER,.DFN,.HL)
"RTN","RGADTP",171,0)
 Q
"RTN","RGADTP",172,0)
GENACK ;
"RTN","RGADTP",173,0)
 N RGCNT,IEN,RG
"RTN","RGADTP",174,0)
 I $G(ARRAY("DFN"))'>0 S RGER="-1^Unknown ICN#"_$G(ARRAY("ICN"))_" and SSN#"_$G(ARRAY(.09))
"RTN","RGADTP",175,0)
 S RGCNT=1
"RTN","RGADTP",176,0)
 S HLA("HLA",RGCNT)="MSA"_HL("FS")_"AA"_HL("FS")_HL("MID")_HL("FS")_$S(+$G(RGER)<0:$P(RGER,"^",2,3),1:""),RGCNT=RGCNT+1
"RTN","RGADTP",177,0)
 S RGSITE=$$LKUP^XUAF4(RGSITE)
"RTN","RGADTP",178,0)
 D LINK^HLUTIL3(RGSITE,.RG) S IEN=$O(RG(0)) S HLL("LINKS",1)="^"_RG(IEN)
"RTN","RGADTP",179,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.HLRESLTA,"",.HL)
"RTN","RGADTP",180,0)
 K HLA
"RTN","RGADTP",181,0)
 Q
"RTN","RGADTP",182,0)
RSP ;
"RTN","RGADTP",183,0)
 Q
"RTN","RGEVPRG")
0^2^B41075390
"RTN","RGEVPRG",1,0)
RGEVPRG ;BAY/ALS-OPTIONS TO PURGE MPI/PD EXCEPTIONS ;08/23/99
"RTN","RGEVPRG",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**3,12,19,32,35**;30 Apr 99
"RTN","RGEVPRG",3,0)
 ;
"RTN","RGEVPRG",4,0)
MAIN ;
"RTN","RGEVPRG",5,0)
 ;Q:($D(^TMP("RGEXC")))!($D(^TMP("RGEXC2")))
"RTN","RGEVPRG",6,0)
 L +^RGHL7(991.1):0 I '$T Q
"RTN","RGEVPRG",7,0)
 L -^RGHL7(991.1)
"RTN","RGEVPRG",8,0)
 L +^RGHL7(991.1,"RG PURGE EXCEPTION"):5 E  Q
"RTN","RGEVPRG",9,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","RGEVPRG",10,0)
 S $P(^RGSITE(991.8,1,"EXCPRG"),"^",1)=$$NOW^XLFDT
"RTN","RGEVPRG",11,0)
 S $P(^RGSITE(991.8,1,"EXCPRG"),"^",3)="R"
"RTN","RGEVPRG",12,0)
 D PROC
"RTN","RGEVPRG",13,0)
 D PRGDUP
"RTN","RGEVPRG",14,0)
 D PRG30
"RTN","RGEVPRG",15,0)
 D PRGZZ
"RTN","RGEVPRG",16,0)
 S $P(^RGSITE(991.8,1,"EXCPRG"),"^",2)=$$NOW^XLFDT
"RTN","RGEVPRG",17,0)
 S $P(^RGSITE(991.8,1,"EXCPRG"),"^",3)="C"
"RTN","RGEVPRG",18,0)
 L -^RGHL7(991.1,"RG PURGE EXCEPTION")
"RTN","RGEVPRG",19,0)
 Q
"RTN","RGEVPRG",20,0)
PRGPAT ;Purge by Patient
"RTN","RGEVPRG",21,0)
 W !
"RTN","RGEVPRG",22,0)
 S DIC="^DPT(",DIC(0)="QEAM",DIC("A")="Select PATIENT: "
"RTN","RGEVPRG",23,0)
 D ^DIC K DIC G:Y<0 QUIT  S RGDFN=+Y
"RTN","RGEVPRG",24,0)
 S EXCT="",FLAG=0
"RTN","RGEVPRG",25,0)
 F  S EXCT=$O(^RGHL7(991.1,"ADFN",EXCT)) Q:EXCT=""  D
"RTN","RGEVPRG",26,0)
 . I $D(^RGHL7(991.1,"ADFN",EXCT,RGDFN)) S FLAG=1 Q
"RTN","RGEVPRG",27,0)
 I FLAG=0 W !,"There are no exceptions on file for this patient." G PRGPAT
"RTN","RGEVPRG",28,0)
 I $$IFLOCAL^MPIF001(RGDFN) W !,"This patient does not have a national ICN assigned, do not purge." Q
"RTN","RGEVPRG",29,0)
 S DFN=RGDFN D DEM^VADPT
"RTN","RGEVPRG",30,0)
 S DIR(0)="YA",DIR("B")="YES"
"RTN","RGEVPRG",31,0)
 S DIR("A")="Are you sure you want to purge all exceptions on file for "_VADM(1)_"?   YES//  "
"RTN","RGEVPRG",32,0)
 D ^DIR Q:$D(DIRUT)  I Y>0 D
"RTN","RGEVPRG",33,0)
 . S EXCT="",CNT=0
"RTN","RGEVPRG",34,0)
 . F  S EXCT=$O(^RGHL7(991.1,"ADFN",EXCT)) Q:'EXCT  D
"RTN","RGEVPRG",35,0)
 .. S IEN=0
"RTN","RGEVPRG",36,0)
 .. F  S IEN=$O(^RGHL7(991.1,"ADFN",EXCT,RGDFN,IEN)) Q:'IEN  D
"RTN","RGEVPRG",37,0)
 ... S IEN2=0
"RTN","RGEVPRG",38,0)
 ... F  S IEN2=$O(^RGHL7(991.1,"ADFN",EXCT,RGDFN,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",39,0)
 .... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","RGEVPRG",40,0)
 .... I NUM=1 S DIK="^RGHL7(991.1,",DA=IEN D ^DIK K DIK,DA S CNT=CNT+1
"RTN","RGEVPRG",41,0)
 .... E  I NUM>1 D DEL
"RTN","RGEVPRG",42,0)
 . W !,"All exceptions purged for "_VADM(1)_"   DFN: "_RGDFN
"RTN","RGEVPRG",43,0)
 K EXCT,DFN,FLAG,VADM,CNT,IEN,IEN2,NUM,RGDFN,Y
"RTN","RGEVPRG",44,0)
QUIT Q
"RTN","RGEVPRG",45,0)
 ;
"RTN","RGEVPRG",46,0)
PRGDT ; Purge by Date
"RTN","RGEVPRG",47,0)
 W !!,"Enter a date for the purge. All exceptions on file, on or before that date, will be deleted."
"RTN","RGEVPRG",48,0)
 K DIR,DIRUT,DTOUT,DUOUT
"RTN","RGEVPRG",49,0)
 S DIR(0)="DA^:DT:EPX",DIR("A")="Enter Date for Purge: "
"RTN","RGEVPRG",50,0)
 D ^DIR K DIR Q:$D(DIRUT)
"RTN","RGEVPRG",51,0)
 S PURDT=Y
"RTN","RGEVPRG",52,0)
 S PDATE=$$FMTE^XLFDT(PURDT)
"RTN","RGEVPRG",53,0)
 S DIR(0)="YA",DIR("B")="YES"
"RTN","RGEVPRG",54,0)
 S DIR("A")="Are you sure you want to purge all exceptions on file dated on or before "_PDATE_"?  YES//  "
"RTN","RGEVPRG",55,0)
 D ^DIR Q:$D(DIRUT)  I Y>0 D
"RTN","RGEVPRG",56,0)
 . S EXCDT="",CNT=0
"RTN","RGEVPRG",57,0)
 . F  S EXCDT=$O(^RGHL7(991.1,"AD",EXCDT)) Q:'EXCDT  D
"RTN","RGEVPRG",58,0)
 .. I ($P(EXCDT,".",1)=PURDT)!($P(EXCDT,".",1)<PURDT) D
"RTN","RGEVPRG",59,0)
 ... S IEN=0
"RTN","RGEVPRG",60,0)
 ... F  S IEN=$O(^RGHL7(991.1,"AD",EXCDT,IEN)) Q:'IEN  D
"RTN","RGEVPRG",61,0)
 .... S NUM="" S NUM=$P($G(^RGHL7(991.1,IEN,1,0)),"^",4) Q:NUM<1
"RTN","RGEVPRG",62,0)
 .... S CNT=CNT+NUM
"RTN","RGEVPRG",63,0)
 .... S DIK="^RGHL7(991.1,",DA=IEN
"RTN","RGEVPRG",64,0)
 .... D ^DIK K DIK,DA
"RTN","RGEVPRG",65,0)
 I CNT=0 W !,"There are no exceptions dated on or before "_PDATE_", no data to purge."
"RTN","RGEVPRG",66,0)
 E  I CNT>0 W !,CNT_" exceptions, dated on or before "_PDATE_" have been purged!"
"RTN","RGEVPRG",67,0)
 K PDATE,PURDT,EXCDT,CNT,IEN,NUM,Y
"RTN","RGEVPRG",68,0)
 Q
"RTN","RGEVPRG",69,0)
PRG30   ; Purge Exceptions over 30 days old
"RTN","RGEVPRG",70,0)
 S TODAY=""
"RTN","RGEVPRG",71,0)
 S TODAY=$$NOW^XLFDT D
"RTN","RGEVPRG",72,0)
 . S EXCDT="",CNT=0,DIFF=""
"RTN","RGEVPRG",73,0)
 . F  S EXCDT=$O(^RGHL7(991.1,"AD",EXCDT)) Q:'EXCDT  D
"RTN","RGEVPRG",74,0)
 .. S DIFF=$$FMDIFF^XLFDT(TODAY,EXCDT)
"RTN","RGEVPRG",75,0)
 .. I DIFF>30 D
"RTN","RGEVPRG",76,0)
 ... S IEN=0
"RTN","RGEVPRG",77,0)
 ... F  S IEN=$O(^RGHL7(991.1,"AD",EXCDT,IEN)) Q:'IEN  D
"RTN","RGEVPRG",78,0)
 .... S NUM="" S NUM=$P($G(^RGHL7(991.1,IEN,1,0)),"^",4) Q:'NUM
"RTN","RGEVPRG",79,0)
 .... S IEN2=0
"RTN","RGEVPRG",80,0)
 .... F  S IEN2=$O(^RGHL7(991.1,IEN,1,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",81,0)
 ..... S STAT=""
"RTN","RGEVPRG",82,0)
 ..... S STAT=$P(^RGHL7(991.1,IEN,1,IEN2,0),"^",5)
"RTN","RGEVPRG",83,0)
 ..... ; Only delete PROCESSED exceptions
"RTN","RGEVPRG",84,0)
 ..... I (STAT>0)!(STAT="") D
"RTN","RGEVPRG",85,0)
 ...... I NUM>1 D DEL
"RTN","RGEVPRG",86,0)
 ...... E  I NUM=1 D
"RTN","RGEVPRG",87,0)
 ....... S CNT=CNT+NUM
"RTN","RGEVPRG",88,0)
 ....... S DIK="^RGHL7(991.1,",DA=IEN
"RTN","RGEVPRG",89,0)
 ....... D ^DIK K DIK,DA
"RTN","RGEVPRG",90,0)
 K DIFF,TODAY,EXCDT,CNT,IEN,IEN2,NUM,STAT
"RTN","RGEVPRG",91,0)
 Q
"RTN","RGEVPRG",92,0)
PRGEXC ; Purge by Exception Type
"RTN","RGEVPRG",93,0)
 ;S DIC="^RGHL7(991.11,",DIC(0)="QEAM"
"RTN","RGEVPRG",94,0)
 ;S DIC("A")="Enter an exception type to purge: "
"RTN","RGEVPRG",95,0)
 ;D ^DIC K DIC G:Y<200 QUIT  S EXCTYP=+Y,ETYPE=X
"RTN","RGEVPRG",96,0)
 ;S DIR(0)="YA",DIR("B")="YES"
"RTN","RGEVPRG",97,0)
 ;S DIR("A")="*WARNING* This will permanently delete all "_ETYPE_" exceptions. Are you sure you want to do this?  YES//  "
"RTN","RGEVPRG",98,0)
 ;D ^DIR Q:$D(DIRUT)  I Y>0 D
"RTN","RGEVPRG",99,0)
 ;. S CNT=0,IEN=""
"RTN","RGEVPRG",100,0)
 ;. F  S IEN=$O(^RGHL7(991.1,"AC",EXCTYP,IEN)) Q:'IEN  D
"RTN","RGEVPRG",101,0)
 ;.. S IEN2=0
"RTN","RGEVPRG",102,0)
 ;.. F  S IEN2=$O(^RGHL7(991.1,"AC",EXCTYP,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",103,0)
 ;... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","RGEVPRG",104,0)
 ;... I NUM=1 S DIK="^RGHL7(991.1,",DA=IEN D ^DIK K DIK,DA S CNT=CNT+1
"RTN","RGEVPRG",105,0)
 ;... E  I NUM>1 D DEL
"RTN","RGEVPRG",106,0)
 ;I CNT=0 W !,"There are no "_ETYPE_" exceptions on file."
"RTN","RGEVPRG",107,0)
 ;E  I CNT>0 W !,CNT_" "_ETYPE_" Exceptions purged!"
"RTN","RGEVPRG",108,0)
 ;K ETYPE,CNT,IEN,IEN2,NUM,X,Y
"RTN","RGEVPRG",109,0)
 ;Q
"RTN","RGEVPRG",110,0)
PRGDUP ; Purge Duplicate Entries
"RTN","RGEVPRG",111,0)
 S EXCTYP="",CNT=0
"RTN","RGEVPRG",112,0)
 K ^TMP("RGEVDUP",$J)
"RTN","RGEVPRG",113,0)
 F  S EXCTYP=$O(^RGHL7(991.1,"ADFN",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEVPRG",114,0)
 . S RGDFN=""
"RTN","RGEVPRG",115,0)
 . F  S RGDFN=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN)) Q:'RGDFN  D
"RTN","RGEVPRG",116,0)
 .. S IEN=0
"RTN","RGEVPRG",117,0)
 .. F  S IEN=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN)) Q:'IEN  D
"RTN","RGEVPRG",118,0)
 ... S IEN2=0
"RTN","RGEVPRG",119,0)
 ... F  S IEN2=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",120,0)
 .... S EXCDT=$P(^RGHL7(991.1,IEN,0),"^",3)
"RTN","RGEVPRG",121,0)
 .... I '$D(^TMP("RGEVDUP",$J,RGDFN,EXCTYP)) D  Q
"RTN","RGEVPRG",122,0)
 ..... S ^TMP("RGEVDUP",$J,RGDFN,EXCTYP)=EXCDT_"^"_IEN_"^"_IEN2
"RTN","RGEVPRG",123,0)
 .... I $D(^TMP("RGEVDUP",$J,RGDFN,EXCTYP)) D
"RTN","RGEVPRG",124,0)
 ..... S OLDNODE=^TMP("RGEVDUP",$J,RGDFN,EXCTYP)
"RTN","RGEVPRG",125,0)
 ..... S OLDDT=$P(OLDNODE,"^")
"RTN","RGEVPRG",126,0)
 ..... I EXCDT>OLDDT D  Q
"RTN","RGEVPRG",127,0)
 ...... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","RGEVPRG",128,0)
 ...... I NUM=1 S DIK="^RGHL7(991.1,",DA=$P(OLDNODE,"^",2) D ^DIK K DIK,DA
"RTN","RGEVPRG",129,0)
 ...... E  I NUM>1 D
"RTN","RGEVPRG",130,0)
 ....... S DA(1)=$P(OLDNODE,"^",2),DA=$P(OLDNODE,"^",3)
"RTN","RGEVPRG",131,0)
 ....... S DIK="^RGHL7(991.1,"_DA(1)_",1," D ^DIK K DIK,DA
"RTN","RGEVPRG",132,0)
 ...... S CNT=CNT+1
"RTN","RGEVPRG",133,0)
 ...... S ^TMP("RGEVDUP",$J,RGDFN,EXCTYP)=EXCDT_"^"_IEN_"^"_IEN2
"RTN","RGEVPRG",134,0)
 ..... I OLDDT>EXCDT!(OLDDT=EXCDT) D
"RTN","RGEVPRG",135,0)
 ...... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","RGEVPRG",136,0)
 ...... I NUM=1 S DIK="^RGHL7(991.1,",DA=IEN D ^DIK K DIK,DA S CNT=CNT+1
"RTN","RGEVPRG",137,0)
 ...... E  I NUM>1 D DEL
"RTN","RGEVPRG",138,0)
 ; W !,CNT_" Duplicate entries"
"RTN","RGEVPRG",139,0)
 K OLDDT,OLDNODE,EXCDT,CNT,IEN,IEN2,NUM,RGDFN
"RTN","RGEVPRG",140,0)
 Q
"RTN","RGEVPRG",141,0)
PRGZZ ;Purge if name field is null (incomplete record)
"RTN","RGEVPRG",142,0)
 ;Purge if -9 node exists, this indicates the record has been merged.
"RTN","RGEVPRG",143,0)
 S EXCTYP="",CNT=""
"RTN","RGEVPRG",144,0)
 F  S EXCTYP=$O(^RGHL7(991.1,"ADFN",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEVPRG",145,0)
 . S RGDFN=""
"RTN","RGEVPRG",146,0)
 . F  S RGDFN=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN)) Q:'RGDFN  D
"RTN","RGEVPRG",147,0)
 .. S IEN=0
"RTN","RGEVPRG",148,0)
 .. F  S IEN=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN)) Q:'IEN  D
"RTN","RGEVPRG",149,0)
 ... S IEN2=0
"RTN","RGEVPRG",150,0)
 ... F  S IEN2=$O(^RGHL7(991.1,"ADFN",EXCTYP,RGDFN,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",151,0)
 .... S DFN=RGDFN D DEM^VADPT
"RTN","RGEVPRG",152,0)
 .... I VADM(1)=""!($D(^DPT(RGDFN,-9))) D
"RTN","RGEVPRG",153,0)
 ..... S NUM="" S NUM=$P(^RGHL7(991.1,IEN,1,0),"^",4)
"RTN","RGEVPRG",154,0)
 ..... I NUM=1 S DIK="^RGHL7(991.1,",DA=IEN D ^DIK K DIK,DA
"RTN","RGEVPRG",155,0)
 ..... E  I NUM>1 D DEL
"RTN","RGEVPRG",156,0)
 K EXCTYP,RGDFN,DFN,IEN,IEN2,NUM,VADM
"RTN","RGEVPRG",157,0)
 Q
"RTN","RGEVPRG",158,0)
DEL ;
"RTN","RGEVPRG",159,0)
 S CNT=CNT+1
"RTN","RGEVPRG",160,0)
 S DA(1)=IEN,DA=IEN2
"RTN","RGEVPRG",161,0)
 S DIK="^RGHL7(991.1,"_DA(1)_",1,"
"RTN","RGEVPRG",162,0)
 D ^DIK K DIK,DA
"RTN","RGEVPRG",163,0)
 Q
"RTN","RGEVPRG",164,0)
PROC ; 
"RTN","RGEVPRG",165,0)
 S EXCTYP=""
"RTN","RGEVPRG",166,0)
 S HOME=$$SITE^VASITE()
"RTN","RGEVPRG",167,0)
 F  S EXCTYP=$O(^RGHL7(991.1,"AC",EXCTYP)) Q:'EXCTYP  D
"RTN","RGEVPRG",168,0)
 . I (EXCTYP=209)!(EXCTYP=227)!(EXCTYP=213)!(EXCTYP=214)!(EXCTYP=218) D
"RTN","RGEVPRG",169,0)
 .. S IEN=0
"RTN","RGEVPRG",170,0)
 .. F  S IEN=$O(^RGHL7(991.1,"AC",EXCTYP,IEN)) Q:'IEN  D
"RTN","RGEVPRG",171,0)
 ... S IEN2=0,ICN="",RGDFN=""
"RTN","RGEVPRG",172,0)
 ... F  S IEN2=$O(^RGHL7(991.1,"AC",EXCTYP,IEN,IEN2)) Q:'IEN2  D
"RTN","RGEVPRG",173,0)
 .... S RGDFN=$P(^RGHL7(991.1,IEN,1,IEN2,0),"^",4) Q:'RGDFN
"RTN","RGEVPRG",174,0)
 .... S ICN=+$$GETICN^MPIF001(RGDFN)
"RTN","RGEVPRG",175,0)
 .... I $E(ICN,1,3)'=$E($P(HOME,"^",3),1,3)&(ICN>0) D
"RTN","RGEVPRG",176,0)
 ..... L +^RGHL7(991.1,IEN):10
"RTN","RGEVPRG",177,0)
 ..... S DA(1)=IEN,DA=IEN2,DR="6///"_1,DIE="^RGHL7(991.1,"_DA(1)_",1,"
"RTN","RGEVPRG",178,0)
 ..... D ^DIE K DIE,DA,DR
"RTN","RGEVPRG",179,0)
 ..... L -^RGHL7(991.1,IEN)
"RTN","RGEVPRG",180,0)
 K EXCTYP,HOME,ICN,IEN,IEN2,RGDFN
"RTN","RGEVPRG",181,0)
 Q
"VER")
8.0^22.0
**END**
**END**
