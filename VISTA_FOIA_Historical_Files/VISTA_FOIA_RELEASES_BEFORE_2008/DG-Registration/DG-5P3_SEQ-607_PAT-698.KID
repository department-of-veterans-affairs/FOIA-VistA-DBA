EMERGENCY Released DG*5.3*698 SEQ #607
Extracted from mail message
**KIDS**:DG*5.3*698^

**INSTALL NAME**
DG*5.3*698
"BLD",2317,0)
DG*5.3*698^REGISTRATION^0^3060331^y
"BLD",2317,1,0)
^^3^3^3060331^
"BLD",2317,1,1,0)
HANDLING HL ENCODING CHAR IN PID 2.4
"BLD",2317,1,2,0)
Refer to patch DG*5.3*698 in the FORUM Patch Module for a complete 
"BLD",2317,1,3,0)
description.
"BLD",2317,4,0)
^9.64PA^^
"BLD",2317,"ABNS",0)
^9.66A^^
"BLD",2317,"ABPKG")
^^
"BLD",2317,"KRN",0)
^9.67PA^8989.52^19
"BLD",2317,"KRN",.4,0)
.4
"BLD",2317,"KRN",.4,"NM",0)
^9.68A^^
"BLD",2317,"KRN",.401,0)
.401
"BLD",2317,"KRN",.402,0)
.402
"BLD",2317,"KRN",.403,0)
.403
"BLD",2317,"KRN",.5,0)
.5
"BLD",2317,"KRN",.84,0)
.84
"BLD",2317,"KRN",3.6,0)
3.6
"BLD",2317,"KRN",3.8,0)
3.8
"BLD",2317,"KRN",9.2,0)
9.2
"BLD",2317,"KRN",9.8,0)
9.8
"BLD",2317,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",2317,"KRN",9.8,"NM",1,0)
VAFCQRY1^^0^B69367143
"BLD",2317,"KRN",9.8,"NM","B","VAFCQRY1",1)

"BLD",2317,"KRN",19,0)
19
"BLD",2317,"KRN",19.1,0)
19.1
"BLD",2317,"KRN",101,0)
101
"BLD",2317,"KRN",409.61,0)
409.61
"BLD",2317,"KRN",771,0)
771
"BLD",2317,"KRN",870,0)
870
"BLD",2317,"KRN",8989.51,0)
8989.51
"BLD",2317,"KRN",8989.52,0)
8989.52
"BLD",2317,"KRN",8994,0)
8994
"BLD",2317,"KRN","B",.4,.4)

"BLD",2317,"KRN","B",.401,.401)

"BLD",2317,"KRN","B",.402,.402)

"BLD",2317,"KRN","B",.403,.403)

"BLD",2317,"KRN","B",.5,.5)

"BLD",2317,"KRN","B",.84,.84)

"BLD",2317,"KRN","B",3.6,3.6)

"BLD",2317,"KRN","B",3.8,3.8)

"BLD",2317,"KRN","B",9.2,9.2)

"BLD",2317,"KRN","B",9.8,9.8)

"BLD",2317,"KRN","B",19,19)

"BLD",2317,"KRN","B",19.1,19.1)

"BLD",2317,"KRN","B",101,101)

"BLD",2317,"KRN","B",409.61,409.61)

"BLD",2317,"KRN","B",771,771)

"BLD",2317,"KRN","B",870,870)

"BLD",2317,"KRN","B",8989.51,8989.51)

"BLD",2317,"KRN","B",8989.52,8989.52)

"BLD",2317,"KRN","B",8994,8994)

"BLD",2317,"QUES",0)
^9.62^^
"BLD",2317,"REQB",0)
^9.611^1^1
"BLD",2317,"REQB",1,0)
DG*5.3*648^2
"BLD",2317,"REQB","B","DG*5.3*648",1)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813^2970721^12541
"PKG",5,22,1,"PAH",1,0)
698^3060331^12555
"PKG",5,22,1,"PAH",1,1,0)
^^3^3^3060331
"PKG",5,22,1,"PAH",1,1,1,0)
HANDLING HL ENCODING CHAR IN PID 2.4
"PKG",5,22,1,"PAH",1,1,2,0)
Refer to patch DG*5.3*698 in the FORUM Patch Module for a complete 
"PKG",5,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","VAFCQRY1")
0^1^B69367143^B60711121
"RTN","VAFCQRY1",1,0)
VAFCQRY1 ;BIR/DLR-Query for patient demographics ;10/30/02  13:58
"RTN","VAFCQRY1",2,0)
 ;;5.3;Registration;**428,474,477,575,627,648,698**;Aug 13, 1993
"RTN","VAFCQRY1",3,0)
 ;
"RTN","VAFCQRY1",4,0)
 ;Reference to $$GETDFNS^MPIF002 supported by IA #3634.
"RTN","VAFCQRY1",5,0)
 ;
"RTN","VAFCQRY1",6,0)
BLDPID(DFN,CNT,SEQ,PID,HL,ERR)  ;build PID from File #2
"RTN","VAFCQRY1",7,0)
 ; Variable list
"RTN","VAFCQRY1",8,0)
 ;  DFN - internal PATIENT (#2) number
"RTN","VAFCQRY1",9,0)
 ;  CNT - value to be place in PID seq#1 (SET ID)
"RTN","VAFCQRY1",10,0)
 ;  SEQ - variable consisting of sequence numbers delimited by commas
"RTN","VAFCQRY1",11,0)
 ;        that will be used to build the message (default is ALL)
"RTN","VAFCQRY1",12,0)
 ;  PID (passed by reference) - array location to place PID segment
"RTN","VAFCQRY1",13,0)
 ;        result, the array can have existing values when passed.
"RTN","VAFCQRY1",14,0)
 ;   HL - array that contains the necessary HL variables (init^hlsub)
"RTN","VAFCQRY1",15,0)
 ;  ERR - array that is used to return an error
"RTN","VAFCQRY1",16,0)
 N VAFCA1,VAFCMN,VAFCMMN,SITE,VAFCZN,SSN,SITE,APID,HIST,HISTDT,VAFCHMN,NXT,NXTC,COMP,REP,SUBCOMP,STATE,CITY,CLAIM,HLECH,HLFS,HLQ,STATEIEN,SARY,LVL,LNGTH,X
"RTN","VAFCQRY1",17,0)
 I '$D(SEQ) S SEQ="ALL"
"RTN","VAFCQRY1",18,0)
 I SEQ="" S SEQ="ALL"
"RTN","VAFCQRY1",19,0)
 I SEQ'="ALL" N POS,EN S POS=1 F  S EN=$P(SEQ,",",POS) Q:EN=""  S SARY(EN)="",POS=POS+1
"RTN","VAFCQRY1",20,0)
 ; setting up temp array to hold fields to be included in message
"RTN","VAFCQRY1",21,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),HLQ=HL("Q"),(COMP,HL("COMP"))=$E(HL("ECH"),1)
"RTN","VAFCQRY1",22,0)
 S (SUBCOMP,HL("SUBCOMP"))=$E(HL("ECH"),4),(REP,HL("REP"))=$E(HL("ECH"),2),HLES=$E(HL("ECH"),3)
"RTN","VAFCQRY1",23,0)
 ;get Patient File MPI node
"RTN","VAFCQRY1",24,0)
 S VAFCMN=$$MPINODE^MPIFAPI(DFN)
"RTN","VAFCQRY1",25,0)
 I +VAFCMN<0 S VAFCMN=""
"RTN","VAFCQRY1",26,0)
 S VAFCZN=^DPT(DFN,0),SSN=$P(^DPT(DFN,0),"^",9),SITE=$$SITE^VASITE
"RTN","VAFCQRY1",27,0)
 N TMP F TMP=1:1:31 S APID(TMP)=""
"RTN","VAFCQRY1",28,0)
 S APID(2)=CNT
"RTN","VAFCQRY1",29,0)
 ;repeat patient ID list including ICN (NI),SSN (SS),CLAIM# (PN) AND DFN (PI)
"RTN","VAFCQRY1",30,0)
 I $D(SARY(3))!(SEQ="ALL") D
"RTN","VAFCQRY1",31,0)
 .S APID(4)=""
"RTN","VAFCQRY1",32,0)
 .;National Identifier (ICN)
"RTN","VAFCQRY1",33,0)
 .I VAFCMN'="" I +VAFCMN>0 S APID(4)=$P(VAFCMN,"^")_"V"_$P(VAFCMN,"^",2)_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L" D
"RTN","VAFCQRY1",34,0)
 ..;Assumption that if this is a local ICN at this point send the message with an expiration date of today, so that it will be treated as a deprecated ID and stored on the MPI as such
"RTN","VAFCQRY1",35,0)
 ..I $E($P(VAFCMN,"^"),1,3)=$P($$SITE^VASITE,"^",3) S APID(4)=APID(4)_COMP_COMP_$$HLDATE^HLFNC(DT)
"RTN","VAFCQRY1",36,0)
 .I $G(SSN)'="" S APID(4)=APID(4)_$S(APID(4)'="":REP,1:"")_SSN_COMP_COMP_COMP_"USSSA"_SUBCOMP_SUBCOMP_"0363"_COMP_"SS"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"
"RTN","VAFCQRY1",37,0)
 .I $G(DFN)'="" S APID(4)=APID(4)_$S(APID(4)'="":REP,1:"")_DFN_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"PI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L" D
"RTN","VAFCQRY1",38,0)
 ..;CLAIM#
"RTN","VAFCQRY1",39,0)
 ..I $D(^DPT(DFN,.31)) S CLAIM=$P(^DPT(DFN,.31),"^",3) I +CLAIM>0 S APID(4)=APID(4)_REP_CLAIM_COMP_COMP_COMP_"USVBA"_SUBCOMP_SUBCOMP_"0363"_COMP_"PN"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"
"RTN","VAFCQRY1",40,0)
 .I $D(^DPT(DFN,"MPIFHIS")) N HIST S NXTC=0,LVL=0,HIST=0  F  S HIST=$O(^DPT(DFN,"MPIFHIS",HIST)) Q:'HIST  S VAFCHMN=^DPT(DFN,"MPIFHIS",HIST,0) S HISTDT=$P(VAFCHMN,"^",4) D
"RTN","VAFCQRY1",41,0)
 ..;**477 due to a timing issue if checksum and D/T of deprication of ICN is not present hang two seconds and try again if still not able to get ICN set D/T to DT
"RTN","VAFCQRY1",42,0)
 ..I $G(HISTDT)="" H 2 S VAFCHMN=^DPT(DFN,"MPIFHIS",HIST,0) S HISTDT=$P(VAFCHMN,"^",4) I HISTDT="" S HISTDT=DT
"RTN","VAFCQRY1",43,0)
 ..I APID(4)'="" D
"RTN","VAFCQRY1",44,0)
 ...S NXT=$P(VAFCHMN,"^")_"V"_$P(VAFCHMN,"^",2)_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"_COMP_COMP_$$HLDATE^HLFNC(HISTDT,"DT") ;**648 only send date not time
"RTN","VAFCQRY1",45,0)
 ...I LVL=0 D
"RTN","VAFCQRY1",46,0)
 ....I $L(APID(4)_NXT)'>244 S APID(4)=APID(4)_REP_NXT Q
"RTN","VAFCQRY1",47,0)
 ....I $L(APID(4)_NXT)>244 S LVL=1 S LNGTH=244-$L(APID(4)),APID(4)=APID(4)_REP_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)),NXTC=1
"RTN","VAFCQRY1",48,0)
 ...I LVL>0 D
"RTN","VAFCQRY1",49,0)
 ....I $L($G(APID(4,LVL))_NXT)'>245 S APID(4,LVL)=$G(APID(4,LVL))_$S(NXTC=0:REP,1:"")_NXT Q
"RTN","VAFCQRY1",50,0)
 ....I $L($G(APID(4,LVL))_NXT)>245 S LNGTH=244-$L(APID(4,LVL)),APID(4,LVL)=APID(4,LVL)_REP_$E(NXT,1,LNGTH) S LNGTH=LNGTH+1,NXT=$E(NXT,LNGTH,$L(NXT)) S LVL=LVL+1 S APID(4,LVL)=NXT
"RTN","VAFCQRY1",51,0)
 ..I NXTC=1 S NXTC=0
"RTN","VAFCQRY1",52,0)
 ..I APID(4)="" S APID(4)=$P(VAFCHMN,"^")_COMP_COMP_COMP_"USVHA"_SUBCOMP_SUBCOMP_"0363"_COMP_"NI"_COMP_"VA FACILITY ID"_SUBCOMP_$$STA^XUAF4(+SITE)_SUBCOMP_"L"_COMP_COMP_$$HLDATE^HLFNC(HISTDT)
"RTN","VAFCQRY1",53,0)
NAMEPID ;patient name (last^first^middle^suffix^prefix^^"L" for legal)
"RTN","VAFCQRY1",54,0)
 I $D(SARY(5))!(SEQ="ALL") D
"RTN","VAFCQRY1",55,0)
 .;**698 code below fixes missing PREFIX and fix missing component separator between last and middle name
"RTN","VAFCQRY1",56,0)
 .N X,DGNAME S DGNAME("FILE")=2,DGNAME("IENS")=DFN,DGNAME("FIELD")=.01 S X=$$NAMEFMT^XLFNAME(.DGNAME,"H","PS",$E(HLECH)),APID(6)=$S(X]"":X,1:HL("Q")) I APID(6)'=HL("Q") S $P(APID(6),$E(HL("ECH"),1),7)="L"_REP
"RTN","VAFCQRY1",57,0)
ALIAS .;patient alias (last^first^middle^suffice^prefix^^"A" for alias - can be multiple)
"RTN","VAFCQRY1",58,0)
 .N ALIAS,ALIEN,LVL6 D GETS^DIQ(2,DFN_",","1*","E","VAFCA1") S LVL6=0
"RTN","VAFCQRY1",59,0)
 .I $D(VAFCA1) S ALIEN=0 F  S ALIEN=$O(VAFCA1(2.01,ALIEN)) Q:'ALIEN  D
"RTN","VAFCQRY1",60,0)
 ..S DGNAME("FILE")=2.01,DGNAME("IENS")=ALIEN,DGNAME("FIELD")=".01" S ALIAS=$$NAMEFMT^XLFNAME(.DGNAME,"H","PS",COMP)
"RTN","VAFCQRY1",61,0)
 ..Q:ALIAS=""
"RTN","VAFCQRY1",62,0)
 ..S $P(ALIAS,$E(HL("ECH"),1),7)="A"
"RTN","VAFCQRY1",63,0)
 ..I $L(APID(6)_ALIAS)>244 S LVL6=1
"RTN","VAFCQRY1",64,0)
 .. I LVL6=0 D
"RTN","VAFCQRY1",65,0)
 ... I $L(APID(6)_ALIAS)'>244 S APID(6)=APID(6)_ALIAS_REP Q
"RTN","VAFCQRY1",66,0)
 ... I $L(APID(6)_ALIAS)>244 S LVL6=1
"RTN","VAFCQRY1",67,0)
 ..I LVL6>0 D
"RTN","VAFCQRY1",68,0)
 ...I $L($G(APID(6,LVL6))_ALIAS)'>245 S APID(6,LVL6)=$G(APID(6,LVL6))_ALIAS_REP Q
"RTN","VAFCQRY1",69,0)
 ...I $L($G(APID(6,LVL6))_ALIAS)>245 S LVL6=LVL6+1,APID(6,LVL6)=ALIAS_REP
"RTN","VAFCQRY1",70,0)
 .I APID(6)="" S APID(6)=HL("Q")
"RTN","VAFCQRY1",71,0)
MOTHER ;mother's maiden name  (last^first^middle^suffix^prefix^^"M" for maiden name)
"RTN","VAFCQRY1",72,0)
 I $D(SARY(6))!(SEQ="ALL") D
"RTN","VAFCQRY1",73,0)
 .S APID(7)=HL("Q")
"RTN","VAFCQRY1",74,0)
 .I $D(^DPT(DFN,.24)) S VAFCMMN=$P(^DPT(DFN,.24),"^",3) D
"RTN","VAFCQRY1",75,0)
 ..S DGNAME("FILE")=2,DGNAME("IENS")=DFN,DGNAME("FIELD")=.2403 S APID(7)=$$NAMEFMT^XLFNAME(.DGNAME,"H","S",$E(HL("ECH"),1)) I APID(7)="" S APID(7)=HL("Q")
"RTN","VAFCQRY1",76,0)
 ..I $P(APID(7),$E(HL("ECH"),1),7)'="M" S $P(APID(7),$E(HL("ECH"),1),7)="M"
"RTN","VAFCQRY1",77,0)
 .I APID(7)="" S APID(7)=HL("Q")
"RTN","VAFCQRY1",78,0)
 I $D(SARY(7))!(SEQ="ALL") S APID(8)=$$HLDATE^HLFNC($P(VAFCZN,"^",3)) I APID(8)="" S APID(8)=HL("Q") ;date/time of birth
"RTN","VAFCQRY1",79,0)
 I $D(SARY(8))!(SEQ="ALL") S APID(9)=$P(VAFCZN,"^",2) I APID(9)="" S APID(9)=HL("Q") ;sex
"RTN","VAFCQRY1",80,0)
 ;place of birth city and state
"RTN","VAFCQRY1",81,0)
ADDR ;
"RTN","VAFCQRY1",82,0)
 I $D(SARY(11))!(SEQ="ALL") S APID(12)="" D
"RTN","VAFCQRY1",83,0)
 .I $D(^DPT(DFN,0)) D
"RTN","VAFCQRY1",84,0)
 ..;address info
"RTN","VAFCQRY1",85,0)
 ..S HL7STRG=$$GET1^DIQ(2,DFN_",",.111) D HL7TXT(.HL7STRG,.HL,HLES)
"RTN","VAFCQRY1",86,0)
 ..S $P(APID(12),COMP)=HL7STRG I $P(APID(12),COMP)="" S $P(APID(12),COMP)=HL("Q")
"RTN","VAFCQRY1",87,0)
 ..K HL7STRG S HL7STRG=$$GET1^DIQ(2,DFN_",",.112) D HL7TXT(.HL7STRG,.HL,HLES) ;**698 add HL7TXT call
"RTN","VAFCQRY1",88,0)
 ..S $P(APID(12),COMP,2)=HL7STRG I $P(APID(12),COMP,2)="" S $P(APID(12),COMP,2)=HL("Q")
"RTN","VAFCQRY1",89,0)
 ..K HL7STRG S HL7STRG=$$GET1^DIQ(2,DFN_",",.113) D HL7TXT(.HL7STRG,.HL,HLES) ;**698 add HL7TXT call
"RTN","VAFCQRY1",90,0)
 ..S $P(APID(12),COMP,8)=HL7STRG I $P(APID(12),COMP,8)="" S $P(APID(12),COMP,8)=HL("Q")
"RTN","VAFCQRY1",91,0)
 ..K HL7STRG
"RTN","VAFCQRY1",92,0)
 ..S HL7STRG=$$GET1^DIQ(2,DFN_",",.114) D HL7TXT(.HL7STRG,.HL,HLES) S $P(APID(12),COMP,3)=HL7STRG
"RTN","VAFCQRY1",93,0)
 ..I $P(APID(12),COMP,3)="" S $P(APID(12),COMP,3)=HL("Q")
"RTN","VAFCQRY1",94,0)
 ..S STATEIEN=$$GET1^DIQ(2,DFN_",",.115,"I") S STATE=$$GET1^DIQ(5,+STATEIEN_",",1) S $P(APID(12),COMP,4)=$G(STATE) I $P(APID(12),COMP,4)="" S $P(APID(12),COMP,4)=HL("Q")
"RTN","VAFCQRY1",95,0)
 ..S $P(APID(12),COMP,5)=$$GET1^DIQ(2,DFN_",",.1112) I $P(APID(12),COMP,5)="" S $P(APID(12),COMP,5)=HL("Q")
"RTN","VAFCQRY1",96,0)
 ..S $P(APID(12),COMP,7)="P"
"RTN","VAFCQRY1",97,0)
 ..; **648 add COUNTY Code to PID-11, retained in PID-12 also
"RTN","VAFCQRY1",98,0)
 ..N COUNTY S COUNTY=$$GET1^DIQ(2,DFN_",",.117) I COUNTY="" S COUNTY=HL("Q")
"RTN","VAFCQRY1",99,0)
 ..S $P(APID(12),COMP,9)=COUNTY ;county code
"RTN","VAFCQRY1",100,0)
 ..;place of birth information
"RTN","VAFCQRY1",101,0)
 ..S CITY=$$GET1^DIQ(2,DFN_",",.092) S HL7STRG=CITY D HL7TXT(.HL7STRG,.HL,HLES) S CITY=HL7STRG D
"RTN","VAFCQRY1",102,0)
 ...N X
"RTN","VAFCQRY1",103,0)
 ...I $G(CITY)'="" S $P(X,COMP,3)=CITY
"RTN","VAFCQRY1",104,0)
 ...I $G(CITY)="" S $P(X,COMP,3)=HL("Q")
"RTN","VAFCQRY1",105,0)
 ...S STATEIEN=$$GET1^DIQ(2,DFN_",",.093,"I") S STATE=$$GET1^DIQ(5,+STATEIEN_",",1) D
"RTN","VAFCQRY1",106,0)
 ....I $G(STATE)'="" S $P(X,COMP,4)=STATE
"RTN","VAFCQRY1",107,0)
 ....I $G(STATE)="" S $P(X,COMP,4)=HL("Q")
"RTN","VAFCQRY1",108,0)
 ... S $P(X,COMP,7)="N",APID(12)=$G(APID(12))_REP_X
"RTN","VAFCQRY1",109,0)
 I $D(SARY(12))!(SEQ="ALL") S APID(13)=$$GET1^DIQ(2,DFN_",",.117) I APID(13)="" S APID(13)=HL("Q")  ;county code **648 backwards compatibility only
"RTN","VAFCQRY1",110,0)
 I $D(SARY(13))!($D(SARY(14)))!(SEQ="ALL") N PHONEN,HNUM,WNUM S PHONEN=$G(^DPT(DFN,.13)) S HNUM=$P(PHONEN,"^",1),WNUM=$P(PHONEN,"^",2)
"RTN","VAFCQRY1",111,0)
 I $D(SARY(13))!(SEQ="ALL") S APID(14)=$$HLPHONE^HLFNC(HNUM) S HL7STRG=APID(14) D HL7TXT(.HL7STRG,.HL,HLES) S APID(14)=HL7STRG I APID(14)="" S APID(14)=HL("Q")
"RTN","VAFCQRY1",112,0)
 I $D(SARY(14))!(SEQ="ALL") S APID(15)=$$HLPHONE^HLFNC(WNUM) S HL7STRG=APID(15) D HL7TXT(.HL7STRG,.HL,HLES) S APID(15)=HL7STRG I APID(15)="" S APID(15)=HL("Q")
"RTN","VAFCQRY1",113,0)
 I $D(SARY(19))!(SEQ="ALL") S APID(20)=SSN  ;ssn passed in PID-3
"RTN","VAFCQRY1",114,0)
 I $D(SARY(23))!(SEQ="ALL") D
"RTN","VAFCQRY1",115,0)
 .S CITY=$$GET1^DIQ(2,DFN_",",.092) S HL7STRG=CITY D HL7TXT(.HL7STRG,.HL,HLES) S CITY=HL7STRG
"RTN","VAFCQRY1",116,0)
 .S STATEIEN=$$GET1^DIQ(2,DFN_",",.093,"I") S STATE=$$GET1^DIQ(5,+STATEIEN_",",1) D
"RTN","VAFCQRY1",117,0)
 .I CITY'=""&(STATE'="") S APID(24)=CITY_" "_STATE  ;place of birth (not used) use PID-11 with an 'N' instead
"RTN","VAFCQRY1",118,0)
 .I CITY=""&(STATE="") S APID(24)=HL("Q")
"RTN","VAFCQRY1",119,0)
 ;list of fields used for backwards compatibility with HDR
"RTN","VAFCQRY1",120,0)
 I $D(SARY(2))!(SEQ="ALL") S APID(3)=$P(VAFCMN,"^")_"V"_$P(VAFCMN,"^",2)  ;Patient ID
"RTN","VAFCQRY1",121,0)
 D CONT^VAFCQRY3(DFN,.APID,.PID,.HL,.SARY,SEQ,.ERR,REP,COMP)
"RTN","VAFCQRY1",122,0)
 D KVA^VADPT
"RTN","VAFCQRY1",123,0)
 Q
"RTN","VAFCQRY1",124,0)
HL7TXT(HL7STRG,HL,HLES) ; Replace occurrences of embedded HL7 delimiters with
"RTN","VAFCQRY1",125,0)
 ; HL7 escape sequence
"RTN","VAFCQRY1",126,0)
 ; Inputs: HL7STRG - Data string to be checked
"RTN","VAFCQRY1",127,0)
 ;         HL("ECH") - HL7 delimiter string
"RTN","VAFCQRY1",128,0)
 ; Output: HL7XTRG - Data string with escape sequence added (if needed)
"RTN","VAFCQRY1",129,0)
 ;
"RTN","VAFCQRY1",130,0)
 N OCHR,RCHR,RCHRI,TYPE,I,HLES2
"RTN","VAFCQRY1",131,0)
 ; Set HL7 escape char
"RTN","VAFCQRY1",132,0)
 I $G(HL("COMP"))="" S HL("COMP")=$G(COMP),HL("REP")=REP,HL("SUBCOMP")=SUBCOMP
"RTN","VAFCQRY1",133,0)
 S HLES2=HLES_HL("FS")_HL("COMP")_HL("REP")_HL("SUBCOMP")
"RTN","VAFCQRY1",134,0)
 ; Search for occurrence of each delimiter and replace it with "\<type>\"
"RTN","VAFCQRY1",135,0)
 F TYPE="E","F","C","R","S" D
"RTN","VAFCQRY1",136,0)
 .S RCHRI=$S(TYPE="E":1,TYPE="F":2,TYPE="C":3,TYPE="R":4,TYPE="S":5)
"RTN","VAFCQRY1",137,0)
 .;
"RTN","VAFCQRY1",138,0)
 .; OCHR=original char, RCHR=replacement char
"RTN","VAFCQRY1",139,0)
 .S OCHR=$E(HLES2,RCHRI),RCHR=$E("EFSRT",RCHRI) Q:'$F(HL7STRG,OCHR)
"RTN","VAFCQRY1",140,0)
 .F I=1:1 Q:$E(HL7STRG,I)=""  I $E(HL7STRG,I)=OCHR S HL7STRG=$E(HL7STRG,1,I-1)_HLES_RCHR_HLES_$E(HL7STRG,I+1,999),I=I+2
"RTN","VAFCQRY1",141,0)
 Q
"VER")
8.0^22.0
"BLD",2317,6)
^607
**END**
**END**
