EMERGENCY Released PSO*7*259 SEQ #227
Extracted from mail message
**KIDS**:PSO*7.0*259^

**INSTALL NAME**
PSO*7.0*259
"BLD",7077,0)
PSO*7.0*259^OUTPATIENT PHARMACY^0^3061025^y
"BLD",7077,1,0)
^^11^11^3061023^
"BLD",7077,1,1,0)
This patch will correct 5 problems.
"BLD",7077,1,2,0)
 
"BLD",7077,1,3,0)
Problem 1: Users are able to delete released refills without returning to
"BLD",7077,1,4,0)
           stock.
"BLD",7077,1,5,0)
Problem 2: A released refill may still allow for deletion.
"BLD",7077,1,6,0)
Problem 3: Error occurs when deleting suspended refills using menu option
"BLD",7077,1,7,0)
           Change Suspense Date.
"BLD",7077,1,8,0)
Problem 4: The Return Medication to Stock option is not deleting the
"BLD",7077,1,9,0)
           refill.
"BLD",7077,1,10,0)
Problem 5: Prevent OPAI from updating a refill node via Auto-Release
"BLD",7077,1,11,0)
           when the refill node was deleted.
"BLD",7077,4,0)
^9.64PA^^
"BLD",7077,6.3)
5
"BLD",7077,"ABPKG")
n
"BLD",7077,"KRN",0)
^9.67PA^8989.52^19
"BLD",7077,"KRN",.4,0)
.4
"BLD",7077,"KRN",.401,0)
.401
"BLD",7077,"KRN",.402,0)
.402
"BLD",7077,"KRN",.403,0)
.403
"BLD",7077,"KRN",.5,0)
.5
"BLD",7077,"KRN",.84,0)
.84
"BLD",7077,"KRN",3.6,0)
3.6
"BLD",7077,"KRN",3.8,0)
3.8
"BLD",7077,"KRN",3.8,"NM",0)
^9.68A^1^1
"BLD",7077,"KRN",3.8,"NM",1,0)
PSO EXTERNAL DISPENSE ALERTS^^0
"BLD",7077,"KRN",3.8,"NM","B","PSO EXTERNAL DISPENSE ALERTS",1)

"BLD",7077,"KRN",9.2,0)
9.2
"BLD",7077,"KRN",9.8,0)
9.8
"BLD",7077,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",7077,"KRN",9.8,"NM",1,0)
PSOCAN2^^0^B70871318
"BLD",7077,"KRN",9.8,"NM",2,0)
PSOHLDI1^^0^B12265819
"BLD",7077,"KRN",9.8,"NM",3,0)
PSOHLDIS^^0^B66788990
"BLD",7077,"KRN",9.8,"NM",4,0)
PSORESK^^0^B66758202
"BLD",7077,"KRN",9.8,"NM",5,0)
PSOUTL^^0^B70558171
"BLD",7077,"KRN",9.8,"NM",6,0)
PSOUTLA1^^0^B59108648
"BLD",7077,"KRN",9.8,"NM",7,0)
PSOCAN4^^0^B42089158
"BLD",7077,"KRN",9.8,"NM","B","PSOCAN2",1)

"BLD",7077,"KRN",9.8,"NM","B","PSOCAN4",7)

"BLD",7077,"KRN",9.8,"NM","B","PSOHLDI1",2)

"BLD",7077,"KRN",9.8,"NM","B","PSOHLDIS",3)

"BLD",7077,"KRN",9.8,"NM","B","PSORESK",4)

"BLD",7077,"KRN",9.8,"NM","B","PSOUTL",5)

"BLD",7077,"KRN",9.8,"NM","B","PSOUTLA1",6)

"BLD",7077,"KRN",19,0)
19
"BLD",7077,"KRN",19.1,0)
19.1
"BLD",7077,"KRN",101,0)
101
"BLD",7077,"KRN",409.61,0)
409.61
"BLD",7077,"KRN",771,0)
771
"BLD",7077,"KRN",870,0)
870
"BLD",7077,"KRN",8989.51,0)
8989.51
"BLD",7077,"KRN",8989.52,0)
8989.52
"BLD",7077,"KRN",8994,0)
8994
"BLD",7077,"KRN","B",.4,.4)

"BLD",7077,"KRN","B",.401,.401)

"BLD",7077,"KRN","B",.402,.402)

"BLD",7077,"KRN","B",.403,.403)

"BLD",7077,"KRN","B",.5,.5)

"BLD",7077,"KRN","B",.84,.84)

"BLD",7077,"KRN","B",3.6,3.6)

"BLD",7077,"KRN","B",3.8,3.8)

"BLD",7077,"KRN","B",9.2,9.2)

"BLD",7077,"KRN","B",9.8,9.8)

"BLD",7077,"KRN","B",19,19)

"BLD",7077,"KRN","B",19.1,19.1)

"BLD",7077,"KRN","B",101,101)

"BLD",7077,"KRN","B",409.61,409.61)

"BLD",7077,"KRN","B",771,771)

"BLD",7077,"KRN","B",870,870)

"BLD",7077,"KRN","B",8989.51,8989.51)

"BLD",7077,"KRN","B",8989.52,8989.52)

"BLD",7077,"KRN","B",8994,8994)

"BLD",7077,"QUES",0)
^9.62^^
"BLD",7077,"REQB",0)
^9.611^4^3
"BLD",7077,"REQB",1,0)
PSO*7.0*201^2
"BLD",7077,"REQB",2,0)
PSO*7.0*218^2
"BLD",7077,"REQB",4,0)
PSO*7.0*131^2
"BLD",7077,"REQB","B","PSO*7.0*131",4)

"BLD",7077,"REQB","B","PSO*7.0*201",1)

"BLD",7077,"REQB","B","PSO*7.0*218",2)

"KRN",3.8,3847,-1)
0^1
"KRN",3.8,3847,0)
PSO EXTERNAL DISPENSE ALERTS^PR^y^^^^
"KRN",3.8,3847,2,0)
^3.801^4^4^3061011^^^^
"KRN",3.8,3847,2,1,0)
This mail group will receive information about activities that need 
"KRN",3.8,3847,2,2,0)
investigation by site personnel.  Examples would be a refill Release 
"KRN",3.8,3847,2,3,0)
message is sent to Vista by the External Dispense machines, but the refill
"KRN",3.8,3847,2,4,0)
is not on file any longer, possibly was deleted.
"KRN",3.8,3847,3)

"KRN",3.8,3847,552001)

"MBREQ")
0
"ORD",11,3.8)
3.8;11;;;MAILG^XPDTA1;MAILGF1^XPDIA1;MAILGE1^XPDIA1;MAILGF2^XPDIA1;;MAILGDEL^XPDIA1(%)
"ORD",11,3.8,0)
MAIL GROUP
"PKG",134,-1)
1^1
"PKG",134,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",134,20,0)
^9.402P^^
"PKG",134,22,0)
^9.49I^1^1
"PKG",134,22,1,0)
7.0^2971216^2980417^1271
"PKG",134,22,1,"PAH",1,0)
259^3061025
"PKG",134,22,1,"PAH",1,1,0)
^^11^11^3061025
"PKG",134,22,1,"PAH",1,1,1,0)
This patch will correct 5 problems.
"PKG",134,22,1,"PAH",1,1,2,0)
 
"PKG",134,22,1,"PAH",1,1,3,0)
Problem 1: Users are able to delete released refills without returning to
"PKG",134,22,1,"PAH",1,1,4,0)
           stock.
"PKG",134,22,1,"PAH",1,1,5,0)
Problem 2: A released refill may still allow for deletion.
"PKG",134,22,1,"PAH",1,1,6,0)
Problem 3: Error occurs when deleting suspended refills using menu option
"PKG",134,22,1,"PAH",1,1,7,0)
           Change Suspense Date.
"PKG",134,22,1,"PAH",1,1,8,0)
Problem 4: The Return Medication to Stock option is not deleting the
"PKG",134,22,1,"PAH",1,1,9,0)
           refill.
"PKG",134,22,1,"PAH",1,1,10,0)
Problem 5: Prevent OPAI from updating a refill node via Auto-Release
"PKG",134,22,1,"PAH",1,1,11,0)
           when the refill node was deleted.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","PSOCAN2")
0^1^B70871318^B66349002
"RTN","PSOCAN2",1,0)
PSOCAN2 ;BHAM ISC/JMB - modular rx cancel with speed ability drug check ; 10/23/06 11:30am
"RTN","PSOCAN2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,18,62,46,88,164,235,148,259**;DEC 1997;Build 5
"RTN","PSOCAN2",3,0)
 ;External reference to ^PSDRUG supported by dbia 221
"RTN","PSOCAN2",4,0)
REINS N DODR
"RTN","PSOCAN2",5,0)
 I $P(^PSRX(DA,2),"^",6)<DT D  Q
"RTN","PSOCAN2",6,0)
 .S Y=$P(^PSRX(DA,2),"^",6) X ^DD("DD")
"RTN","PSOCAN2",7,0)
 .W !!,"Rx: "_$P(^PSRX(DA,0),"^")_" Drug: "_$S($D(^PSDRUG($P(^PSRX(DA,0),"^",6),0)):$P(^(0),"^"),1:""),!,"Expired "_Y_" and cannot be Reinstated!",!
"RTN","PSOCAN2",8,0)
 .D PAUSE^VALM1
"RTN","PSOCAN2",9,0)
 I $D(^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA)) S PSCAN($P(^PSRX(DA,0),"^"))=DA_"^R",DODR=1 D AUTOD G ACT
"RTN","PSOCAN2",10,0)
 I $P(PSOPAR,"^",2),'$D(^XUSEC("PSORPH",DUZ)) D VERIFY D  D AREC^PSOCAN1 Q
"RTN","PSOCAN2",11,0)
 .S RX1=$P(^PSRX(DA,0),"^") S:'$D(PSCAN(RX1)) PSCAN(RX1)=DA_"^R" K RX1
"RTN","PSOCAN2",12,0)
ACT W ! F I=1:1:80 W "="
"RTN","PSOCAN2",13,0)
 D ^PSOBUILD S DRG=+$P(^PSRX(DA,0),"^",6),DRG=$S($D(^PSDRUG(DRG,0)):$P(^(0),"^"),1:""),HOLDRX=RX
"RTN","PSOCAN2",14,0)
 W !!,RX_"  "_DRG D DRGDRG S RX=HOLDRX K HOLDRX Q:$P(^PSRX(+PSCAN(RX),"STA"),"^")'=12!($G(PSORX("DFLG")))  S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2) D CAN^PSOCAN W !
"RTN","PSOCAN2",15,0)
 N RXIEN S RXIEN=DA
"RTN","PSOCAN2",16,0)
 ;Takes action on reinstated Rx's
"RTN","PSOCAN2",17,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF
"RTN","PSOCAN2",18,0)
 S (LPRT,LREF)="" F LL=0:0 S LL=$O(^PSRX(DA,"L",LL)) Q:'LL  S LPRT=$P($G(^PSRX(DA,"L",LL,0)),"."),LREF=$P($G(^(0)),"^",2)
"RTN","PSOCAN2",19,0)
 I 'RFCNT S FDT=$S($P($G(^PSRX(DA,2)),"^",2)'="":$P($G(^PSRX(DA,2)),"^",2),1:$P($G(^PSRX(DA,2)),"^")) S RELDT=$P(^(2),"^",13),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",20,0)
 I RFCNT S FDT=$P($G(^PSRX(DA,1,RFCNT,0)),"^"),RELDT=$P(^(0),"^",18),RELDT=$P(RELDT,".")
"RTN","PSOCAN2",21,0)
 S Y=FDT D DD^%DT S XFDT=Y I RELDT'="" S Y=RELDT D DD^%DT S XRELDT=Y
"RTN","PSOCAN2",22,0)
 I LPRT'="" S Y=LPRT D DD^%DT S XLPDT=Y
"RTN","PSOCAN2",23,0)
 ;If Rx was released, do nothing
"RTN","PSOCAN2",24,0)
 I RELDT'="" W !,RX_" Reinstated -- ",!?3,$S('RFCNT:"Filled",1:"Refilled # "_LREF)_": "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:""),?56,"Released: "_$G(XRELDT) H 3 Q
"RTN","PSOCAN2",25,0)
 ;If Rx not released, check fill/refill date for action
"RTN","PSOCAN2",26,0)
 I $G(PSXSYS) D REINS^PSOCMOPA I $G(XFLAG) K XFLAG Q
"RTN","PSOCAN2",27,0)
 W !,"Prescription #"_RX_" REINSTATED!"
"RTN","PSOCAN2",28,0)
 ;
"RTN","PSOCAN2",29,0)
 I $$SUBMIT^PSOBPSUT(RXIEN) D
"RTN","PSOCAN2",30,0)
 . N ACTION
"RTN","PSOCAN2",31,0)
 . D ECMESND^PSOBPSU1(RXIEN,,,$S($O(^PSRX(RXIEN,1,0)):"RF",1:"OF"))
"RTN","PSOCAN2",32,0)
 . I $$FIND^PSOREJUT(RXIEN) S ACTION=$$HDLG^PSOREJU1(RXIEN,,"79,88","OF","IOQ","I")
"RTN","PSOCAN2",33,0)
 ;
"RTN","PSOCAN2",34,0)
 W !?3,"Prescription #",RX," "
"RTN","PSOCAN2",35,0)
 I FDT<DT D
"RTN","PSOCAN2",36,0)
 .W $S('RFCNT:"Filled",1:"Refilled # "_LREF)_":  "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:""),?56,"Released:"
"RTN","PSOCAN2",37,0)
 .S DIR("A")="     ** Do you want to print the label now",DIR("B")="N",DIR(0)="Y",DIR("?")="Enter 'Y' to print the label now.  If 'N' is entered, the label may be reprinted through reprint at a later date."
"RTN","PSOCAN2",38,0)
 .D ^DIR K DIR Q:$G(DIRUT)!('Y)  S PPL=DA D Q^PSORXL Q
"RTN","PSOCAN2",39,0)
 I FDT=DT W $S('RFCNT:"Filled",1:"Refilled # "_LREF)_": "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:"")
"RTN","PSOCAN2",40,0)
 I  W ?56,"Released:",!?5,"Either print the label using the reprint option ",!?7,"or check later to see if the label has been printed." Q
"RTN","PSOCAN2",41,0)
 I FDT>DT W $S('RFCNT:"Filled",1:"Refilled # "_LREF)_": "_XFDT,?32,"Printed: "_$S(LREF=RFCNT:XLPDT,1:"")
"RTN","PSOCAN2",42,0)
 I  W ?56,"Released:" I '$G(DODR) W !?5,"Placing Rx on suspense.  Please wait..." D SUS
"RTN","PSOCAN2",43,0)
 K DODR
"RTN","PSOCAN2",44,0)
 Q
"RTN","PSOCAN2",45,0)
SUS ;Adds rec to suspense
"RTN","PSOCAN2",46,0)
 S ACT=1,RXN=DA,RX0=^PSRX(DA,0),RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK S DA=RXN
"RTN","PSOCAN2",47,0)
 S RXP=$S($D(RXP):RXP,1:0),DIC="^PS(52.5,",DIC(0)="L",X=RXN,DIC("DR")=".02///"_FDT_";.03///"_$P(RX0,"^",2)_";.04///M;.05///"_RXP_";.06////"_$G(PSOSITE)_";2///0" K DD,DO D FILE^DICN
"RTN","PSOCAN2",48,0)
 I +$G(Y),$G(RFCNT)'="" S $P(^PS(52.5,+Y,0),"^",13)=$G(RFCNT)
"RTN","PSOCAN2",49,0)
 S DA=RXN,$P(^PSRX(DA,"STA"),"^")=5,LFD=$E($P(^PSRX(DA,3),"^"),4,5)_"-"_$E($P(^(3),"^"),6,7)_"-"_$E($P(^(3),"^"),2,3)
"RTN","PSOCAN2",50,0)
 S ACOM="RX Placed on Suspense until "_LFD D AREC^PSOCAN1 S ST="SC",PHST="ZS" D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST
"RTN","PSOCAN2",51,0)
 Q
"RTN","PSOCAN2",52,0)
DRGDRG ;Checks for drug/drug interaction, duplicate drug and class
"RTN","PSOCAN2",53,0)
 Q:$P(^PSRX(DA,2),"^",6)<DT
"RTN","PSOCAN2",54,0)
 S STA="ACTIVE^NON-VERIFIED^R^HOLD^NON-VERIFIED^ACTIVE^^^^^^ACTIVE^DISCONTINUED^^DISCONTINUED^DISCONTINUED^HOLD"
"RTN","PSOCAN2",55,0)
 S STAT=$P(STA,"^",$P(^PSRX(DA,"STA"),"^")+1)
"RTN","PSOCAN2",56,0)
 S X=$P(^PSRX(DA,0),"^",6),DIC="^PSDRUG(",DIC(0)="MZO" D ^DIC K DIC Q:$D(DTOUT)!(Y<0)
"RTN","PSOCAN2",57,0)
 K HOLD S NAME=$P(Y(0),"^") I +$G(PSOSD(STAT,NAME))=+PSCAN(RX) S HOLD(STAT,NAME)=$G(PSOSD(STAT,NAME)) K PSOSD(STAT,NAME)
"RTN","PSOCAN2",58,0)
 S:$G(PSONEW("OLD VAL"))=+Y PSODRG("QFLG")=1
"RTN","PSOCAN2",59,0)
 K PSOY S PSOY=Y,PSOY(0)=Y(0)
"RTN","PSOCAN2",60,0)
 S PSORENW("OIRXN")=DA D SET^PSODRG,POST^PSODRG S REA=$P(PSCAN($P(^PSRX(PSORENW("OIRXN"),0),"^")),"^",2)
"RTN","PSOCAN2",61,0)
 W ! S:$G(HOLD(STAT,NAME))]"" PSOSD(STAT,NAME)=$G(HOLD(STAT,NAME)) K HOLD,STA,STAT,PSORENW("OIRXN")
"RTN","PSOCAN2",62,0)
 Q
"RTN","PSOCAN2",63,0)
VERIFY ;Put in non-verify file
"RTN","PSOCAN2",64,0)
 S PSRXDA=DA,DIC="^PS(52.4,",DLAYGO=52.4,(X,DINUM)=PSRXDA,DIC(0)="ML",DIC("DR")="1////"_PSODFN_";2////"_DUZ_";4////"_DT
"RTN","PSOCAN2",65,0)
 K DD,DO D FILE^DICN K DIC,DLAYGO,DINUM
"RTN","PSOCAN2",66,0)
 S DA=PSRXDA S $P(^PSRX(DA,"STA"),"^")=1
"RTN","PSOCAN2",67,0)
 S ST="SC",PHST="IP",VCOM="Put in non-verified status" D EN^PSOHLSN1(DA,ST,PHST,VCOM) K ST,PHST,VCOM
"RTN","PSOCAN2",68,0)
 Q
"RTN","PSOCAN2",69,0)
HLD N PSDTEST,PDA,CMOP,SUSD I $P(^PSRX(DA,"STA"),"^")=3 D
"RTN","PSOCAN2",70,0)
 .S ACOM=$S(REA="C":"Discontinued",1:"Reinstated")_" while on hold during Rx cancel. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA) S ^PSRX(DA,"H")=""
"RTN","PSOCAN2",71,0)
 .I $P(^PSRX(DA,0),"^",13),'$O(^PSRX(DA,1,0)) S DIE=52,DR="22///"_$E($P(^PSRX(DA,0),"^",13),1,7) D ^DIE K DIE,DR Q
"RTN","PSOCAN2",72,0)
 .S (IFN,SUSD)=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  S SUSD=IFN,RFDT=$P(^PSRX(DA,1,IFN,0),"^")
"RTN","PSOCAN2",73,0)
 .Q:'$G(SUSD)  I '$P(^PSRX(DA,1,SUSD,0),"^",18) S PSDTEST=0 D  I 'PSDTEST K ^PSRX(DA,1,SUSD),^PSRX("AD",RFDT,DA,SUSD),^PSRX(DA,1,"B",RFDT,SUSD),IFN,SUSD,RFDT
"RTN","PSOCAN2",74,0)
 ..F PDA=0:0 S PDA=$O(^PSRX(DA,"L",PDA)) Q:'PDA  I $P($G(^PSRX(DA,"L",PDA,0)),"^",2)=SUSD S PSDTEST=1
"RTN","PSOCAN2",75,0)
 ..K CMOP D ^PSOCMOPA I $G(CMOP(CMOP("L")))="",$G(CMOP("S"))'="L" Q
"RTN","PSOCAN2",76,0)
 ..S PSDTEST=1
"RTN","PSOCAN2",77,0)
 Q
"RTN","PSOCAN2",78,0)
REF S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I $P($G(^PSRX(DA,1,IFN,0)),"^")=SUSD,'$P(^(0),"^",18) D
"RTN","PSOCAN2",79,0)
 .D DELREF I $G(PSORFDEL) K PSORFDEL Q
"RTN","PSOCAN2",80,0)
 .;PSO*7*259;CHECK IF REFILL RELEASED OR LABEL PRINTED
"RTN","PSOCAN2",81,0)
 .I $P($G(^PSRX(DA,1,IFN,0)),"^",18)]"" Q  ;REFILL RELEASED
"RTN","PSOCAN2",82,0)
 .N PSONODEL,PSOLBL S PSONODEL=0
"RTN","PSOCAN2",83,0)
 .I $P(^PSRX(DA,"STA"),"^")=5 D REF^PSOCAN4 Q:PSONODEL
"RTN","PSOCAN2",84,0)
 .S PSOLBL="" F  S PSOLBL=$O(^PSRX(DA,"L",PSOLBL),-1) Q:'PSOLBL  Q:PSONODEL  Q:$P(^PSRX(DA,"L",PSOLBL,0),"^",2)<IFN  I $P(^PSRX(DA,"L",PSOLBL,0),"^",2)=IFN S PSONODEL=1
"RTN","PSOCAN2",85,0)
 .Q:PSONODEL
"RTN","PSOCAN2",86,0)
 .K PSORFDEL K ^PSRX(DA,1,IFN),^PSRX("AD",SUSD,DA,IFN),^PSRX(DA,1,"B",SUSD,IFN)
"RTN","PSOCAN2",87,0)
 .S $P(^PSRX(DA,1,0),"^",4)=$P(^PSRX(DA,1,0),"^",4)-1,DA(1)=DA
"RTN","PSOCAN2",88,0)
 .S NODE=0 D SPR^PSOUTL K DA(1),RF,NODE
"RTN","PSOCAN2",89,0)
 S IFN=0 F  S IFN=$O(^PSRX(DA,1,IFN)) Q:'IFN  I '$O(^PSRX(DA,1,IFN)) S $P(^PSRX(DA,3),"^")=+$P(^PSRX(DA,1,IFN,0),"^"),$P(^(3),"^",2)=SUSD
"RTN","PSOCAN2",90,0)
 I '$O(^PSRX(DA,1,0)) S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,2),"^",2),$P(^PSRX(DA,3),"^",2)=SUSD
"RTN","PSOCAN2",91,0)
 K IFN,SUSD
"RTN","PSOCAN2",92,0)
 Q
"RTN","PSOCAN2",93,0)
KILL K %,ACNT,ACOM,ACT,ALL,BCNUM,CMOP,CNT,DA,DAYS360,DEAD,DRG,DIRUT,DR,DRUG,DTOUT,DUOUT,FDT,HOLD,I,II,IN,IT,JJ,LC,LFD,LINE,LL,LPRT,LREF,LSI,NAME,NDF,NOEXP,NSF,OUT,RXSP,EN,WARN K:'$G(POERR) INCOM
"RTN","PSOCAN2",94,0)
 K PSODRUG,PCNT,POP,PPL,PS,PSFROM,PSINV,PLINE,PSI,PSINV,PSOCAN,PSOCMOP,PSODFN,PSODRG,PSOOPT,PSOSD,PSPOP,PSRXDA,PSS,PSVC,PSONOOR
"RTN","PSOCAN2",95,0)
 K REA,RELDT,RF,RFDATE,RFCNT,RFL,RFL1,RFLL,RP,RX,RX0,RXCNT,RXDA,RXN,RXNUM,RXP,RXREC,RXREF,RXS,SDATE,SPCANC,SS,STAT,SUB,X,XFDT,XLPDT,XRELDT,Y D KVA^VADPT Q
"RTN","PSOCAN2",96,0)
DELREF ;
"RTN","PSOCAN2",97,0)
 N RDL,PSCNODE
"RTN","PSOCAN2",98,0)
 S PSORFDEL=0
"RTN","PSOCAN2",99,0)
 F RDL=0:0 S RDL=$O(^PSRX(DA,4,RDL)) Q:'RDL  I $G(IFN)=$P($G(^PSRX(DA,4,RDL,0)),"^",3) S PSCNODE=$G(^(0))
"RTN","PSOCAN2",100,0)
 I $G(PSCNODE)="" Q
"RTN","PSOCAN2",101,0)
 I +$P(PSCNODE,"^",4)<3 S PSORFDEL=1
"RTN","PSOCAN2",102,0)
 Q
"RTN","PSOCAN2",103,0)
AUTOD ;reinstates Rxs dc'd by date of death
"RTN","PSOCAN2",104,0)
 I $G(^PSRX(DA,"DDSTA"))']"" K ^PSRX("APSOD",+$P(^PSRX(DA,0),"^",2),DA),DODR Q
"RTN","PSOCAN2",105,0)
 S DODS=$P(^PSRX(DA,"DDSTA"),"^"),DODD=$P(^("DDSTA"),"^",2,245)
"RTN","PSOCAN2",106,0)
 S FILE=$P(DODS,";"),STA=$P(DODS,";",2)
"RTN","PSOCAN2",107,0)
 I FILE=52.4 D  Q
"RTN","PSOCAN2",108,0)
 .S RXN=DA,^PS(52.4,DA,0)=DODD,DIK="^PS(52.4," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",109,0)
 .S ST="SC",PHST="IP",ACOM="Date of Death Deleted. Returned to Non-Verified status."
"RTN","PSOCAN2",110,0)
 .K ^PSRX("APSOD",$P(^PSRX(DA,0),"^",2),DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",111,0)
 .S DA=RXN D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,RXN
"RTN","PSOCAN2",112,0)
 I FILE=52.5 D  Q
"RTN","PSOCAN2",113,0)
 .;Adds rec to suspense
"RTN","PSOCAN2",114,0)
 .S RXN=DA,RXS=$O(^PS(52.5,"B",DA,0)) I RXS S DA=RXS,DIK="^PS(52.5," D ^DIK
"RTN","PSOCAN2",115,0)
 .S DIC="^PS(52.5,",DIC(0)="L",X=RXN K DD,DO D FILE^DICN S DA=+Y
"RTN","PSOCAN2",116,0)
 .S ^PS(52.5,DA,0)=DODD,^PS(52.5,DA,"P")=0,LFD=$E($P(^PS(52.5,DA,0),"^",2),4,5)_"-"_$E($P(^(0),"^",2),6,7)_"-"_$E($P(^(0),"^",2),2,3)
"RTN","PSOCAN2",117,0)
 .S DIK="^PS(52.5," D IX^DIK K DIK,DA S DA=RXN,$P(^PSRX(DA,"STA"),"^")=STA
"RTN","PSOCAN2",118,0)
 .S ACOM="Date of Death Deleted. RX Placed on Suspense until "_LFD
"RTN","PSOCAN2",119,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",120,0)
 .I STA=5 S ST="SC",PHST="ZS" D LOG D EN^PSOHLSN1(DA,ST,PHST,ACOM) K ST,PHST,ACOM,LFD
"RTN","PSOCAN2",121,0)
 I FILE=52 S ^PSRX(DA,"STA")=STA I STA=3!(STA=16) D  Q
"RTN","PSOCAN2",122,0)
 .S ^PSRX(DA,"H")=DODD,^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)=""
"RTN","PSOCAN2",123,0)
 .S ACOM="Date of Death Deleted. Medication Returned to"_$S(STA=16:" Provider",1:"")_" Hold Status "_$E(DT,4,5)_"/"_$E(DT,6,7)_"/"_$E(DT,2,3)_"."
"RTN","PSOCAN2",124,0)
 .D LOG,EN^PSOHLSN1(DA,"OH","",ACOM) K ACOM
"RTN","PSOCAN2",125,0)
 .K ^PSRX("APSOD",PSODFN,DA),^PSRX(DA,"DDSTA")
"RTN","PSOCAN2",126,0)
 S ACOM="Date of Death Deleted. Prescription Reinstated." D EN^PSOHLSN1(DA,"SC","CM",ACOM),LOG K ACOM
"RTN","PSOCAN2",127,0)
 Q
"RTN","PSOCAN2",128,0)
LOG K ACNT F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",129,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=$G(RFCNT)+1 S:RF>5 RFCNT=$G(RFCNT)+1
"RTN","PSOCAN2",130,0)
 S ACNT=$G(ACNT)+1
"RTN","PSOCAN2",131,0)
 D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_ACNT_"^"_ACNT S ^PSRX(DA,"A",ACNT,0)=%_"^R^"_DUZ_"^"_RFCNT_"^"_ACOM
"RTN","PSOCAN2",132,0)
 K ^PSRX("APSOD",PSODFN,DA),ACNT,RFCNT,RF,%
"RTN","PSOCAN2",133,0)
 S $P(^PSRX(DA,3),"^")=$P(^PSRX(DA,3),"^",5),$P(^(3),"^",2)=$P(^(3),"^",8)
"RTN","PSOCAN2",134,0)
 S $P(^PSRX(DA,3),"^",5)="",$P(^(3),"^",8)=""
"RTN","PSOCAN2",135,0)
 Q
"RTN","PSOCAN2",136,0)
NVER ;Called from PSOCAN3, needs DA defined
"RTN","PSOCAN2",137,0)
 N PSONVC,PSONVCP,PSONVCC
"RTN","PSOCAN2",138,0)
 S PSONVC="SC",PSONVCP="IP",PSONVCC="Put in non-verified status" D EN^PSOHLSN1(DA,PSONVC,PSONVCP,PSONVCC)
"RTN","PSOCAN2",139,0)
 Q
"RTN","PSOCAN2",140,0)
RMB(IDX) ;remove Rx if found in array BBRX() (Bingo Board)
"RTN","PSOCAN2",141,0)
 N ST4,ST5,ST6,K
"RTN","PSOCAN2",142,0)
 S ST4=BBRX(IDX) Q:ST4'[(DA_",")
"RTN","PSOCAN2",143,0)
 S ST6=""
"RTN","PSOCAN2",144,0)
 F K=1:1 S ST5=$P(ST4,",",K) Q:'ST5  D
"RTN","PSOCAN2",145,0)
 . S:ST5'=DA ST6=ST6_$S('ST6:"",1:",")_ST5
"RTN","PSOCAN2",146,0)
 . S:ST6]"" BBRX(IDX)=ST6_"," K:ST6="" BBRX(IDX)
"RTN","PSOCAN2",147,0)
 I '$D(BBRX) K BINGCRT
"RTN","PSOCAN2",148,0)
 Q
"RTN","PSOCAN4")
0^7^B42089158^B39864455
"RTN","PSOCAN4",1,0)
PSOCAN4 ;BIR/SAB-rx speed dc listman ; 10/23/06 11:50am
"RTN","PSOCAN4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,24,27,63,88,117,131,259**;DEC 1997;Build 5
"RTN","PSOCAN4",3,0)
 ;External reference to File #200 supported by DBIA 224
"RTN","PSOCAN4",4,0)
 ;External reference NA^ORX1 supported by DBIA 2186
"RTN","PSOCAN4",5,0)
 ;External references to L, UL, PSOL, and PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSOCAN4",6,0)
 ;External reference to PSDRUG supported by DBIA 221
"RTN","PSOCAN4",7,0)
 ;External reference to PS(50.7 supported by DBIA 2223
"RTN","PSOCAN4",8,0)
 ;External reference to PS(50.606 supported by DBIA 2174
"RTN","PSOCAN4",9,0)
SEL I '$D(^XUSEC("PSORPH",DUZ)) S VALMSG="Unauthorized Action Selection.",VALMBCK="" Q
"RTN","PSOCAN4",10,0)
 N VALMCNT I '$G(PSOCNT) S VALMSG="This patient has no Prescriptions!" S VALMBCK="" Q
"RTN","PSOCAN4",11,0)
 S DFNHLD=PSODFN
"RTN","PSOCAN4",12,0)
 S PSOPLCK=$$L^PSSLOCK(PSODFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY S VALMSG=$S($P($G(PSOPLCK),"^",2)'="":$P($G(PSOPLCK),"^",2)_" is working on this patient.",1:"Another person is entering orders for this patient.") K PSOPLCK S VALMBCK="" Q
"RTN","PSOCAN4",13,0)
 K PSOPLCK S RXCNT=0 K PSOFDR,DIR,DUOUT,DIRUT S DIR("A")="Select Orders by number",DIR(0)="LO^1:"_PSOCNT D ^DIR S LST=Y I $D(DTOUT)!($D(DUOUT)) K DIR,DIRUT,DTOUT,DUOUT S VALMBCK="" D ULP Q
"RTN","PSOCAN4",14,0)
 K DIR,DIRUT,DTOUT,PSOOELSE,DTOUT I +LST S (SPEED,PSOOELSE)=1 D  D KCAN^PSOCAN3
"RTN","PSOCAN4",15,0)
 .S PSOCANRA=1 D RQTEST
"RTN","PSOCAN4",16,0)
 .D FULL^VALM1,COM^PSOCAN1 I '$D(INCOM)!($D(DIRUT)) K SPEED S VALMBCK="R" Q
"RTN","PSOCAN4",17,0)
 .D FULL^VALM1 F ORD=1:1:$L(LST,",") Q:$P(LST,",",ORD)']""  S ORN=$P(LST,",",ORD) D @$S(+PSOLST(ORN)=52:"RX",1:"PEN")
"RTN","PSOCAN4",18,0)
 .S VALMBCK="R"
"RTN","PSOCAN4",19,0)
 I '$G(PSOOELSE) S VALMBCK=""
"RTN","PSOCAN4",20,0)
 D ^PSOBUILD,BLD^PSOORUT1 K PSOMSG,RXCNT,DIR,DIRUT,DTOUT,DUOUT,LST,ORD,IEN,ORN,RPH,ST,REFL,REF,PSOACT,ORSV,PSORNW,PSORENW,PSONO,PSOCO,PSOCU,PSODIR,DSMSG,SAVORD,SAVORN,SPEED,DIRUT,PSONOOR
"RTN","PSOCAN4",21,0)
 D INVALD^PSOCAN1 K PSINV,PSOOELSE,INCOM,COM S PSODFN=DFNHLD K DFNHLD D ULP
"RTN","PSOCAN4",22,0)
 Q
"RTN","PSOCAN4",23,0)
ULP D UL^PSSLOCK(+$G(PSODFN)) Q
"RTN","PSOCAN4",24,0)
 ;
"RTN","PSOCAN4",25,0)
RX Q:'$D(^XUSEC("PSORPH",DUZ))
"RTN","PSOCAN4",26,0)
 D PSOL^PSSLOCK($P(PSOLST(ORN),"^",2)) I '$G(PSOMSG) D  D PAUSE^VALM1 K PSOMSG Q
"RTN","PSOCAN4",27,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P($G(PSOMSG),"^",2),!,"Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),! Q
"RTN","PSOCAN4",28,0)
 .W $C(7),!!,"Another person is editing Rx "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^"),!
"RTN","PSOCAN4",29,0)
 S RXSP=1 K PSCAN S (EN,X)=$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^") S Y=$P(PSOLST(ORN),"^",2)_"^"_X,Y(0,0)=X,Y(0)=$G(^PSRX($P(PSOLST(ORN),"^",2),0)) D
"RTN","PSOCAN4",30,0)
 .I $P(^PSRX(+Y,"STA"),"^")=1!($P(^("STA"),"^")=4) D  Q
"RTN","PSOCAN4",31,0)
 ..I $P($G(^PSRX(+Y,"PKI")),"^") N PKI,PKI1,PKIR,PKIE,DA S DA=+Y D CER^PSOPKIV1
"RTN","PSOCAN4",32,0)
 ..S:$G(PSONOOR)'="" PSONOORA=$G(PSONOOR) D DEL S:$G(PSONOORA)'="" PSONOOR=$G(PSONOORA) K PSONOORA Q
"RTN","PSOCAN4",33,0)
 .S YY=Y,YY(0,0)=Y(0,0),(PSODFN,DFN)=$P(Y(0),"^",2) D:$G(DFN) CHK^PSOCAN I DEAD!($P(^PSRX(+YY,"STA"),"^")>11),$P(^("STA"),"^")<16 S PSINV(EN)="" Q
"RTN","PSOCAN4",34,0)
 .S DA=+YY I $P($G(^PSRX(DA,"STA")),"^")=11!($P($G(^(2)),"^",6)<DT) D EXP^PSOCAN
"RTN","PSOCAN4",35,0)
 .S RX=YY(0,0) D:$D(^PSRX(DA,0)) SPEED1^PSOCAN1
"RTN","PSOCAN4",36,0)
 K YY I '$D(PSCAN) D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2)) Q
"RTN","PSOCAN4",37,0)
 S RX="",RXCNT=0 F  S RX=$O(PSCAN(RX)) Q:RX=""  S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),RXCNT=RXCNT+1 D SHOW^PSOCAN1
"RTN","PSOCAN4",38,0)
 S RX="" F  S RX=$O(PSCAN(RX)) Q:RX=""  D ACT
"RTN","PSOCAN4",39,0)
 D PSOUL^PSSLOCK($P(PSOLST(ORN),"^",2))
"RTN","PSOCAN4",40,0)
 Q
"RTN","PSOCAN4",41,0)
ACT S DA=+PSCAN(RX),REA=$P(PSCAN(RX),"^",2),II=RX,PSODFN=$P(^PSRX(DA,0),"^",2) I REA="R" D REINS^PSOCAN2 Q
"RTN","PSOCAN4",42,0)
 D CAN1^PSOCAN3 Q
"RTN","PSOCAN4",43,0)
PEN ;discontinue pending orders
"RTN","PSOCAN4",44,0)
 S SAVORD=ORD,SAVORN=ORN
"RTN","PSOCAN4",45,0)
 S ORD=$P(PSOLST(ORN),"^",2) D PSOL^PSSLOCK(+ORD_"S") I '$G(PSOMSG) D  D MEDDIS K PSOMSG G OK
"RTN","PSOCAN4",46,0)
 .I $P($G(PSOMSG),"^",2)'="" W $C(7),!!,$P($G(PSOMSG),"^",2)_"  (Pending order)",! Q
"RTN","PSOCAN4",47,0)
 .W $C(7),!!,"Another person is editing this Pending order.",!
"RTN","PSOCAN4",48,0)
 I $P(^PS(52.41,ORD,0),"^",3)="RF" S DA=ORD,DIK="^PS(52.41," D ^DIK K DA,DIK D PSOUL^PSSLOCK(ORD_"S") Q
"RTN","PSOCAN4",49,0)
 K ^PS(52.41,"AOR",$P(^PS(52.41,ORD,0),"^",2),+$P($G(^PS(52.41,ORD,"INI")),"^"),ORD) S $P(^PS(52.41,ORD,0),"^",3)="DC"
"RTN","PSOCAN4",50,0)
 D EN^PSOHLSN(+^PS(52.41,ORD,0),"OC",INCOM,PSONOOR)
"RTN","PSOCAN4",51,0)
 D PSOUL^PSSLOCK(ORD_"S")
"RTN","PSOCAN4",52,0)
OK S ORD=SAVORD,ORN=SAVORN Q
"RTN","PSOCAN4",53,0)
NOOR ;ask nature of order
"RTN","PSOCAN4",54,0)
 D FULL^VALM1
"RTN","PSOCAN4",55,0)
 K DIR,DTOUT,DTOUT,DIRUT I $T(NA^ORX1)]"" D  Q:$D(DIRUT)  G NOORXP
"RTN","PSOCAN4",56,0)
 .S PSONOOR=$$NA^ORX1("S",0,"B","Nature of Order",0,"WPSDIVX"_$S(+$G(^VA(200,DUZ,"PS")):"E",1:""))
"RTN","PSOCAN4",57,0)
 .I +PSONOOR S PSONOOR=$P(PSONOOR,"^",3) Q
"RTN","PSOCAN4",58,0)
 .S DIRUT=1 K PSONOOR
"RTN","PSOCAN4",59,0)
 S DIR("A")="Nature of Order: ",DIR("B")=$S($G(DODR):"SERVICE CORRECTED",1:"WRITTEN")
"RTN","PSOCAN4",60,0)
 S DIR(0)="SA^W:WRITTEN;V:VERBAL;P:TELEPHONE;S:SERVICE CORRECTED;D:DUPLICATE;I:POLICY;X:REJECTED"_$S(+$G(^VA(200,DUZ,"PS")):";E:PROVIDER ENTERED",1:"")
"RTN","PSOCAN4",61,0)
 D ^DIR K DIR,DTOUT,DTOUT Q:$D(DIRUT)  S PSONOOR=Y
"RTN","PSOCAN4",62,0)
NOORXP I $G(PSOCANRA),'$G(PSOCANRZ) D REQ
"RTN","PSOCAN4",63,0)
NOORX S:$D(DIRUT)&($G(SPEED)) VALMBCK="Q"
"RTN","PSOCAN4",64,0)
 Q
"RTN","PSOCAN4",65,0)
DEL ;deletes non-verified Rxs
"RTN","PSOCAN4",66,0)
 D FULL^VALM1
"RTN","PSOCAN4",67,0)
 W ! K DIR,DIRUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A",1)="Rx # "_$P(^PSRX($P(PSOLST(ORN),"^",2),0),"^")_" is in a Non-Verified Status.",DIR("A")="Are sure you want to mark the Rx as deleted" D ^DIR I 'Y!($D(DIRUT)) S VALMBCK="R" G EX
"RTN","PSOCAN4",68,0)
 I '$G(SPEED) D  I $D(DIRUT) G EX
"RTN","PSOCAN4",69,0)
 .D NOOR^PSOCAN4 I $D(DIRUT) S VALMSG="No Action Taken!",VALMBCK="R" Q
"RTN","PSOCAN4",70,0)
 .K DIR S DIR("A")="Comments",DIR("B")="Per Pharmacy Request",DIR(0)="F^5:100" D ^DIR K DIR I $D(DIRUT) S VALMSG="No Action Taken!" Q
"RTN","PSOCAN4",71,0)
 K PSDEL,PSORX("INTERVENE") S PSOZVER=1,DA=$P(PSOLST(ORN),"^",2)
"RTN","PSOCAN4",72,0)
 I $G(PKI1) N INCOM S INCOM=Y D DCV^PSOPKIV1 Q
"RTN","PSOCAN4",73,0)
 D ENQ^PSORXDL
"RTN","PSOCAN4",74,0)
EX Q
"RTN","PSOCAN4",75,0)
REQ ;prompt for requesting provider
"RTN","PSOCAN4",76,0)
 I '$G(PSOCANRD),$G(PSOCANRP),$G(ORD),$D(^PS(52.41,ORD,0)) S PSOCANRD=+$P($G(^PS(52.41,ORD,0)),"^",5)
"RTN","PSOCAN4",77,0)
 I $G(PSOCANRD) D
"RTN","PSOCAN4",78,0)
 .I $D(^VA(200,PSOCANRD,"PS")),$P($G(^("PS")),"^"),$S('$P(^("PS"),"^",4):1,1:$P(^("PS"),"^",4)'<DT) Q
"RTN","PSOCAN4",79,0)
 .K PSOCANRD
"RTN","PSOCAN4",80,0)
 W ! K DIC S DIC=200,DIC(0)="AEQMZ",DIC("A")="Requesting PROVIDER: ",DIC("S")="I $D(^(""PS"")),$P(^(""PS""),""^""),$S('$P(^(""PS""),""^"",4):1,1:$P(^(""PS""),""^"",4)'<DT)" I $G(PSOCANRD) S DIC("B")=PSOCANRD
"RTN","PSOCAN4",81,0)
 D ^DIC K DIC S:$G(Y)<0!($D(DTOUT))!($D(DUOUT)) DIRUT=1 I $G(Y) S PSOCANRC=+$G(Y),PSOCANRN=$P($G(Y),"^",2),PSOCANRZ=1
"RTN","PSOCAN4",82,0)
 Q
"RTN","PSOCAN4",83,0)
RQTEST ;
"RTN","PSOCAN4",84,0)
 N PMIN,PMINZ,PMINFLAG
"RTN","PSOCAN4",85,0)
 S PMINFLAG=0 F PMIN=1:1:$L(LST,",") Q:$P(LST,",",PMIN)']""  S PMINZ=$P(LST,",",PMIN) D
"RTN","PSOCAN4",86,0)
 .I $P($G(PSOLST(PMINZ)),"^")=52 I $P($G(^PSRX(+$P($G(PSOLST(PMINZ)),"^",2),"STA")),"^")'=12,'$G(PMINFLAG) S PSOCANRD=+$P($G(^PSRX(+$P($G(PSOLST(PMINZ)),"^",2),0)),"^",4) S PMINFLAG=1
"RTN","PSOCAN4",87,0)
 .I $P($G(PSOLST(PMINZ)),"^")=52.41,'$G(PMINFLAG) S PSOCANRD=$P($G(^PS(52.41,+$P($G(PSOLST(PMINZ)),"^",2),0)),"^",5) S PMINFLAG=1
"RTN","PSOCAN4",88,0)
 I '$G(PMINFLAG) S PSOCANRZ=1
"RTN","PSOCAN4",89,0)
 Q
"RTN","PSOCAN4",90,0)
MEDDIS ;
"RTN","PSOCAN4",91,0)
 N PSOFMMD
"RTN","PSOCAN4",92,0)
 Q:'$G(ORD)
"RTN","PSOCAN4",93,0)
 Q:'$D(^PS(52.41,ORD,0))
"RTN","PSOCAN4",94,0)
 I $P(^PS(52.41,ORD,0),"^",9) W "Drug: "_$P($G(^PSDRUG(+$P(^PS(52.41,ORD,0),"^",9),0)),"^") D PAUSE^VALM1 Q
"RTN","PSOCAN4",95,0)
 I $P(^PS(52.41,ORD,0),"^",8) S PSOFMMD=$P(^(0),"^",8) W "Orderable Item: "_$P($G(^PS(50.7,PSOFMMD,0)),"^")_"  "_$P($G(^PS(50.606,+$P($G(^PS(50.7,PSOFMMD,0)),"^",2),0)),"^") D PAUSE^VALM1
"RTN","PSOCAN4",96,0)
 Q
"RTN","PSOCAN4",97,0)
 ;
"RTN","PSOCAN4",98,0)
REF ;CONT. FROM REF^PSOCAN2; PSO*7*259
"RTN","PSOCAN4",99,0)
 N PSOSIEN S PSOSIEN=0
"RTN","PSOCAN4",100,0)
 F  S PSOSIEN=$O(^PS(52.5,"B",DA,PSOSIEN)) Q:'PSOSIEN  D  Q:PSONODEL
"RTN","PSOCAN4",101,0)
 .I $P($G(^PS(52.5,PSOSIEN,0)),"^",13)'=IFN Q  ;NOT SAME REFILL
"RTN","PSOCAN4",102,0)
 .I '$P($G(^PS(52.5,PSOSIEN,"P")),"^") Q  ;SUSPENSE LABEL PRINT
"RTN","PSOCAN4",103,0)
 .S PSONODEL=1   ;REFILL NODE SHOULD NOT BE DELETED
"RTN","PSOCAN4",104,0)
 Q
"RTN","PSOHLDI1")
0^2^B12265819^n/a
"RTN","PSOHLDI1",1,0)
PSOHLDI1 ;BIR/PWC,SAB - Automated Dispense Completion HL7 v.2.4 cont. ;10/25/06 10:04am
"RTN","PSOHLDI1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**259**;DEC 1997;Build 5
"RTN","PSOHLDI1",3,0)
 ;Reference to ^PSD(58.8 supported by DBIA 1036
"RTN","PSOHLDI1",4,0)
 ;Reference to ^XTMP("PSA" supported by DBIA 1036
"RTN","PSOHLDI1",5,0)
 ;This routine is called by PSOHLDIS
"RTN","PSOHLDI1",6,0)
 ;
"RTN","PSOHLDI1",7,0)
 ;*259 create routine to hold DRGACCT, psohldis exceeded 10k, also
"RTN","PSOHLDI1",8,0)
 ;     add MAIL tag for Email Alert to mail group.
"RTN","PSOHLDI1",9,0)
 ;
"RTN","PSOHLDI1",10,0)
 Q
"RTN","PSOHLDI1",11,0)
 ;
"RTN","PSOHLDI1",12,0)
BINGREL ;displays to bingo board
"RTN","PSOHLDI1",13,0)
 N NAM,NAME,RXO,SSN S ADA="",BRXP=RXID
"RTN","PSOHLDI1",14,0)
 F XX=0:0 S XX=$O(^PS(52.11,"B",BNAM,XX)) Q:'XX  D
"RTN","PSOHLDI1",15,0)
 .F BRX=0:0 S BRX=$O(^PS(52.11,XX,2,"B",BRX)) Q:'BRX  I BRX=BRXP S (DA,ODA)=XX
"RTN","PSOHLDI1",16,0)
 Q:'$D(DA)
"RTN","PSOHLDI1",17,0)
 I $P($G(^PS(52.11,DA,0)),"^",7)]"" Q
"RTN","PSOHLDI1",18,0)
 I $P($P($G(^PS(52.11,DA,0)),"^",5),".")'=DT S DIK="^PS(52.11," D ^DIK K DIK Q
"RTN","PSOHLDI1",19,0)
 N TM,TM1 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2)
"RTN","PSOHLDI1",20,0)
 S NM=$P(^DPT($P(^PS(52.11,DA,0),"^"),0),"^"),DR="6////"_$E(TM1_"0000",1,4)_";8////"_NM_"",DIE="^PS(52.11,"
"RTN","PSOHLDI1",21,0)
 L +^PS(52.11,DA):2 E  Q
"RTN","PSOHLDI1",22,0)
 D ^DIE L -^PS(52.11,DA) I $G(X)="" S DIK="^PS(52.11," D ^DIK K DIK Q
"RTN","PSOHLDI1",23,0)
 S RX0=^PS(52.11,DA,0),JOES=$P(RX0,"^",4),TICK=+$P($G(RX0),"^",2),GRP=$P($G(^PS(59.3,$P($G(^PS(52.11,DA,0)),"^",3),0)),"^",2)
"RTN","PSOHLDI1",24,0)
 I GRP="T",'$G(TICK) S DIK="^PS(52.11," D ^DIK K DIK
"RTN","PSOHLDI1",25,0)
 Q:'$G(DA)
"RTN","PSOHLDI1",26,0)
 S PSZ=0 I '$D(^PS(59.2,DT,0)) K DD,DIC,DO,DA S X=DT,DIC="^PS(59.2,",DIC(0)="",DINUM=X D FILE^DICN S PSZ=1 Q:Y'>0 
"RTN","PSOHLDI1",27,0)
 I PSZ=1 S DA(1)=+Y,DIC=DIC_DA(1)_",1,",(DINUM,X)=JOES,DIC(0)="",DIC("P")=$P(^DD(59.2,1,0),"^",2) K DD,DO D FILE^DICN K DIC,DA Q:Y'>0
"RTN","PSOHLDI1",28,0)
 I PSZ=0 K DD,DIC,DO,DA S DA(1)=DT,(DINUM,X)=JOES,DIC="^PS(59.2,"_DT_",1,",DIC(0)="LZ" D FILE^DICN K DIC,DA,DO
"RTN","PSOHLDI1",29,0)
 S DA=ODA D STATS1^PSOBRPRT,WTIME^PSOBING1
"RTN","PSOHLDI1",30,0)
 Q
"RTN","PSOHLDI1",31,0)
 ;
"RTN","PSOHLDI1",32,0)
DRGACCT(RXP) ;update Drug Accountability Package                      ;PSO*209
"RTN","PSOHLDI1",33,0)
 S RXP=+$G(RXP) Q:'RXP
"RTN","PSOHLDI1",34,0)
 N PSA,DIC,DA,DR,X,Y,DIQ,PSODA,PSOSITE,QDRUG,QTY,JOB192
"RTN","PSOHLDI1",35,0)
 S (JOB192,PSODA)=0
"RTN","PSOHLDI1",36,0)
 ;check for Drug Acct background job
"RTN","PSOHLDI1",37,0)
 S X="PSA IV ALL LOCATIONS",DIC(0)="MZ",DIC=19.2 D ^DIC S JOB192=Y
"RTN","PSOHLDI1",38,0)
 I JOB192>0,$P($G(Y(0)),U,2)>DT D
"RTN","PSOHLDI1",39,0)
 . S PSODA=1
"RTN","PSOHLDI1",40,0)
 . S:'$P($G(^XTMP("PSA",0)),U,2) $P(^(0),U,2)=DT
"RTN","PSOHLDI1",41,0)
 I JOB192'>0 D             ;check old way of scheduling
"RTN","PSOHLDI1",42,0)
 . S X="PSA IV ALL LOCATIONS",DIC(0)="MZ",DIC=19 D ^DIC
"RTN","PSOHLDI1",43,0)
 . K DIQ,PSA S DA=+Y,DIC=19,DIQ="PSA",DR=200,DIQ(0)="IN" D EN^DIQ1
"RTN","PSOHLDI1",44,0)
 . I $G(PSA(19,DA,200,"I"))>DT D
"RTN","PSOHLDI1",45,0)
 . . S PSODA=1
"RTN","PSOHLDI1",46,0)
 . . S:'$P($G(^XTMP("PSA",0)),U,2) $P(^(0),U,2)=DT
"RTN","PSOHLDI1",47,0)
 ;drug stocked in Drug Acct Location?
"RTN","PSOHLDI1",48,0)
 S PSOSITE=+$O(^PS(59,0))
"RTN","PSOHLDI1",49,0)
 S PSODA(1)=$S($D(^PSD(58.8,+$O(^PSD(58.8,"AOP",PSOSITE,0)),1,+$P(^PSRX(RXP,0),U,6))):1,1:0)
"RTN","PSOHLDI1",50,0)
 ;if appropriate update ^XTMP("PSA", for Drug Acct
"RTN","PSOHLDI1",51,0)
 S QTY=$P($G(^PSRX(RXP,0)),"^",7)
"RTN","PSOHLDI1",52,0)
 S QDRUG=+$P($G(^PSRX(RXP,0)),"^",6)
"RTN","PSOHLDI1",53,0)
 Q:'QDRUG
"RTN","PSOHLDI1",54,0)
 I $G(PSODA),$G(PSODA(1)),'$D(^PSRX("AR",$$NOW^XLFDT,RXP,0)) S ^XTMP("PSA",PSOSITE,QDRUG,DT)=$G(^XTMP("PSA",PSOSITE,QDRUG,DT))+QTY
"RTN","PSOHLDI1",55,0)
 Q
"RTN","PSOHLDI1",56,0)
 ;
"RTN","PSOHLDI1",57,0)
MAIL ;Send mail message
"RTN","PSOHLDI1",58,0)
 S:'$G(DUZ) DUZ=.5
"RTN","PSOHLDI1",59,0)
 N PSOTTEXT,PSOIEN,PSOKEYN,XMY,XMDUZ,XMSUB,XMTEXT
"RTN","PSOHLDI1",60,0)
 S XMY("G.PSO EXTERNAL DISPENSE ALERTS")=""
"RTN","PSOHLDI1",61,0)
 ;if no members in group, then send to PSXCMOPMGR key holders
"RTN","PSOHLDI1",62,0)
 S PSOIEN=$O(^XMB(3.8,"B","PSO EXTERNAL DISPENSE ALERTS",0))
"RTN","PSOHLDI1",63,0)
 I '$O(^XMB(3.8,PSOIEN,1,0)) D
"RTN","PSOHLDI1",64,0)
 . S PSOKEYN=0
"RTN","PSOHLDI1",65,0)
 . F  S PSOKEYN=$O(^XUSEC("PSXCMOPMGR",PSOKEYN)) Q:'PSOKEYN  D
"RTN","PSOHLDI1",66,0)
 . . S XMY(PSOKEYN)=""
"RTN","PSOHLDI1",67,0)
 S XMDUZ="PSO EXTERNAL DISPENSE"
"RTN","PSOHLDI1",68,0)
 S XMSUB="External Dispense - Rx Release Attempted"
"RTN","PSOHLDI1",69,0)
 S PSOTTEXT(1)="Patient: "_NAME_"   SSN: "_PSSN
"RTN","PSOHLDI1",70,0)
 S PSOTTEXT(2)="   Rx #: "_PSORX_"   Fill: "_FLLN
"RTN","PSOHLDI1",71,0)
 S PSOTTEXT(3)="   Drug: "_$P(GIVECOD,"~",2)
"RTN","PSOHLDI1",72,0)
 S PSOTTEXT(4)=""
"RTN","PSOHLDI1",73,0)
 S PSOTTEXT(5)=ATXT
"RTN","PSOHLDI1",74,0)
 S PSOTTEXT(6)=""
"RTN","PSOHLDI1",75,0)
 S:ACTN]"" PSOTTEXT(7)=ACTN
"RTN","PSOHLDI1",76,0)
 S XMTEXT="PSOTTEXT(" D ^XMD
"RTN","PSOHLDI1",77,0)
 Q
"RTN","PSOHLDIS")
0^3^B66788990^B68225842
"RTN","PSOHLDIS",1,0)
PSOHLDIS ;BIR/PWC,SAB - Automated Dispense Completion HL7 v.2.4 ;10/20/06 3:39pm
"RTN","PSOHLDIS",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**156,189,193,209,148,259**;DEC 1997;Build 5
"RTN","PSOHLDIS",3,0)
 ;Reference to ^PSDRUG supported by DBIA #221
"RTN","PSOHLDIS",4,0)
 ;Reference to $$NDCFMT^PSSNDCUT supported by IA 4707
"RTN","PSOHLDIS",5,0)
 ;This routine is called by FACK1^PSOHLDS
"RTN","PSOHLDIS",6,0)
 ;
"RTN","PSOHLDIS",7,0)
 ;*209 add Drug accountability & fix Copay for refills
"RTN","PSOHLDIS",8,0)
 ;*259 check for refill node to exist before updating the Release msg
"RTN","PSOHLDIS",9,0)
 ;
"RTN","PSOHLDIS",10,0)
EN ;main entry and process
"RTN","PSOHLDIS",11,0)
 N NONODE
"RTN","PSOHLDIS",12,0)
 D GETHL7,GETPID,GETORC,GETRXD
"RTN","PSOHLDIS",13,0)
 ;
"RTN","PSOHLDIS",14,0)
 ;Begin Updating files           ;*259
"RTN","PSOHLDIS",15,0)
 I MEDDISP  D                    ;if dispensed
"RTN","PSOHLDIS",16,0)
 . I FLL="F",'FLLN D FILL              ;orig fill
"RTN","PSOHLDIS",17,0)
 . I FLL="F",FLLN D REFILL             ;refill
"RTN","PSOHLDIS",18,0)
 . I FLL="P" D PARTIAL                 ;partial fill
"RTN","PSOHLDIS",19,0)
 . D ACTLOG                            ;activity log
"RTN","PSOHLDIS",20,0)
 . Q:$G(NONODE)                        ;quit, no refill node to update
"RTN","PSOHLDIS",21,0)
 . I $D(BGRP),$D(BNAM),$D(BDIV) D BINGREL^PSOHLDI1    ;bingo board rel
"RTN","PSOHLDIS",22,0)
 . D DRGACCT^PSOHLDI1(RXID)            ;drug accountability *209
"RTN","PSOHLDIS",23,0)
 E  D                            ;else not dispensed
"RTN","PSOHLDIS",24,0)
 . D ACTLOG                            ;activity log no release
"RTN","PSOHLDIS",25,0)
 ;
"RTN","PSOHLDIS",26,0)
 ;if label was printed
"RTN","PSOHLDIS",27,0)
 I PRT D
"RTN","PSOHLDIS",28,0)
 . S LBI=0 F LB=0:0 S LB=$O(^PSRX(RXID,"L",LB)) Q:'LB  S LBI=LBI+1
"RTN","PSOHLDIS",29,0)
 . S LBI=LBI+1,^PSRX(RXID,"L",0)="^52.032DA^"_LBI_"^"_LBI
"RTN","PSOHLDIS",30,0)
 . S ^PSRX(RXID,"L",LBI,0)=NOW_"^"_$S(FLL="F":FLLN,1:(99-FLLN))_"^"_"From Rx # "_$P(^PSRX(RXID,0),"^")_$S(FLL="P":" (Partial)",1:"")_$S($G(HLRPT):" (Reprint)",1:"")_" (External Interface)"_"^"_HLUSER
"RTN","PSOHLDIS",31,0)
 ;
"RTN","PSOHLDIS",32,0)
 D END
"RTN","PSOHLDIS",33,0)
 Q
"RTN","PSOHLDIS",34,0)
 ;
"RTN","PSOHLDIS",35,0)
GETHL7 ;get HL7 segments from msg
"RTN","PSOHLDIS",36,0)
 K OK
"RTN","PSOHLDIS",37,0)
 F I=0:0 S I=$O(PSOMSG(I)) Q:'I  D
"RTN","PSOHLDIS",38,0)
 .I $P(PSOMSG(I),"|")="MSH" S NODE1=PSOMSG(I) Q
"RTN","PSOHLDIS",39,0)
 .I $P(PSOMSG(I),"|")="MSA" S NODE2=PSOMSG(I) Q
"RTN","PSOHLDIS",40,0)
 .I $P(PSOMSG(I),"|")="PID" S NODE3=PSOMSG(I) Q
"RTN","PSOHLDIS",41,0)
 .I $P(PSOMSG(I),"|")="ORC" S NODE4=PSOMSG(I) Q
"RTN","PSOHLDIS",42,0)
 .I $P(PSOMSG(I),"|")="RXD" S NODE5=PSOMSG(I) Q
"RTN","PSOHLDIS",43,0)
 Q
"RTN","PSOHLDIS",44,0)
 ;
"RTN","PSOHLDIS",45,0)
GETPID ;get PID segment data
"RTN","PSOHLDIS",46,0)
 S PID=$P($G(NODE3),"|",4)   ;this contains all the patient id numbers
"RTN","PSOHLDIS",47,0)
 F XX=1:1 S PIDD=$P(PID,"^",XX) Q:PIDD=""  D
"RTN","PSOHLDIS",48,0)
 . S PIDID=$P(PIDD,"~",5)
"RTN","PSOHLDIS",49,0)
 . I PIDID="NI" S PICN=$P(PIDD,"~",1)   ;ICN #
"RTN","PSOHLDIS",50,0)
 . I PIDID="SS" S PSSN=$P(PIDD,"~",1)   ;SSN #
"RTN","PSOHLDIS",51,0)
 . I PIDID="PI" S PPID=$P(PIDD,"~",1)   ;patient ID
"RTN","PSOHLDIS",52,0)
 . I PIDID="PN" S PCLM=$P(PIDD,"~",1)   ;claim #
"RTN","PSOHLDIS",53,0)
 Q
"RTN","PSOHLDIS",54,0)
GETORC ;get ORC segment data
"RTN","PSOHLDIS",55,0)
 S RXID=$P($P($G(NODE4),"|",3),"^")    ;RX #
"RTN","PSOHLDIS",56,0)
 S DFN=$P(^PSRX(RXID,0),"^",2) D DEM^VADPT
"RTN","PSOHLDIS",57,0)
 S NAME=VADM(1),DOB=$P(VADM(3),"^"),SEX=$P(VADM(5),"^") K VADM
"RTN","PSOHLDIS",58,0)
 S FPER=$P($P($G(NODE4),"|",11),"~")   ;filling person
"RTN","PSOHLDIS",59,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+FPER D
"RTN","PSOHLDIS",60,0)
 .D ^DIC I +Y>0 S FPER=+Y,FPERN=$P(Y,"^",2) Q
"RTN","PSOHLDIS",61,0)
 .S FPER="",FPERN="UNKNOWN"
"RTN","PSOHLDIS",62,0)
 S CPHARM=$P($P($G(NODE4),"|",12),"~") ;checking pharmacist
"RTN","PSOHLDIS",63,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+CPHARM D  K DIC,X,Y
"RTN","PSOHLDIS",64,0)
 .D ^DIC I +Y>0 S CPHARM=+Y,CPHARMN=$P(Y,"^",2) Q
"RTN","PSOHLDIS",65,0)
 .S CPHARM="",CPHARMN="UNKNOWN"
"RTN","PSOHLDIS",66,0)
 Q
"RTN","PSOHLDIS",67,0)
GETRXD ;get RXD segment data
"RTN","PSOHLDIS",68,0)
 S FILL=$P($P($G(NODE5),"|",2),"^")         ;fill #
"RTN","PSOHLDIS",69,0)
 S GIVECOD=$P($P($G(NODE5),"|",3),"^")      ;give code
"RTN","PSOHLDIS",70,0)
 S X=$P($P($G(NODE5),"|",4),"^"),DISPDT=$$FMDATE^HLFNC(X) K X  ;dispense date
"RTN","PSOHLDIS",71,0)
 S PSORX=$P($P($G(NODE5),"|",8),"^")        ;prescription #
"RTN","PSOHLDIS",72,0)
 S NDC=$P($P($G(NODE5),"|",10),"^")  ;NDC #
"RTN","PSOHLDIS",73,0)
 K F I NDC]"" D  K L,F
"RTN","PSOHLDIS",74,0)
 .S F=""
"RTN","PSOHLDIS",75,0)
 .F L=1:1:$L(NDC,"^") I $P(NDC,"^",L)'=""  S F=$G(F)_$P(NDC,"^",L)_$S($P(NDC,"^",(L+1))]"":",",1:"")
"RTN","PSOHLDIS",76,0)
 .S NDC=F
"RTN","PSOHLDIS",77,0)
 S X=$P($P($G(NODE5),"|",10),"^",2),RELDT=$S($$FMDATE^HLFNC(X)>0:$$FMDATE^HLFNC(X),1:"") K X  ;release dt
"RTN","PSOHLDIS",78,0)
 S PRT=$S($P($P($G(NODE5),"|",10),"^",3)=1:1,$P($P($G(NODE5),"|",10),"^",3)=2:1,1:0)  ;label printed by vendor
"RTN","PSOHLDIS",79,0)
 S MEDDISP=$S($P($P($G(NODE5),"|",10),"^",3)=1:1,$P($P($G(NODE5),"|",10),"^",3)=4:1,1:0)  ;med dispensed by vendor
"RTN","PSOHLDIS",80,0)
 S RPHARM=$P($P($G(NODE5),"|",11),"~",1)      ;releasing pharmacist
"RTN","PSOHLDIS",81,0)
 K DIC,X,Y S DIC="^VA(200,",DIC(0)="N,Z",X=+RPHARM D
"RTN","PSOHLDIS",82,0)
 .D ^DIC I +Y>0 S RPHARM=+Y Q
"RTN","PSOHLDIS",83,0)
 .S RPHARM=""
"RTN","PSOHLDIS",84,0)
 S LOT=$P($G(NODE5),"|",19)
"RTN","PSOHLDIS",85,0)
 I LOT]"" D  K L,F
"RTN","PSOHLDIS",86,0)
 .S F=""
"RTN","PSOHLDIS",87,0)
 .F L=1:1:$L(LOT,"^") I $P(LOT,"^",L)'=""  S F=$G(F)_$P(LOT,"^",L)_$S($P(LOT,"^",(L+1))]"":",",1:"")
"RTN","PSOHLDIS",88,0)
 .S LOT=F
"RTN","PSOHLDIS",89,0)
 S X=$P($P($G(NODE5),"|",20),"^"),EXPDT=$S($$FMDATE^HLFNC(X)>0:$$FMDATE^HLFNC(X),1:"") K X   ;expiration date
"RTN","PSOHLDIS",90,0)
 S MFG=$P($P($G(NODE5),"|",21),"^")         ;manufacturer
"RTN","PSOHLDIS",91,0)
 K F I MFG]"" D  K L,F
"RTN","PSOHLDIS",92,0)
 .F L=1:1:$L(MFG) Q:$P(MFG,"^",L)=""  S F=$G(F)_$P(MFG,"^",L)_$S($P(MFG,"^",(L+1))]"":",",1:"")
"RTN","PSOHLDIS",93,0)
 .S MFG=F
"RTN","PSOHLDIS",94,0)
 S EXRX=^PS(52.51,EIN,0)
"RTN","PSOHLDIS",95,0)
 S IRX=$P(EXRX,"^"),FLL=$P(EXRX,"^",8),FLLN=$P(EXRX,"^",9),RPT=$P(EXRX,"^",5),(DIV,PSOSITE)=$P(EXRX,"^",11),PSOPAR=$G(^PS(59,DIV,0))
"RTN","PSOHLDIS",96,0)
 S PSOPAR7=$G(^PS(59,PSOSITE,"IB")),PSOSYS=$G(^PS(59.7,1,40.1))
"RTN","PSOHLDIS",97,0)
 S RXN=$P(^PSRX(IRX,0),"^"),DRG=$P(^(0),"^",6),QTY=$P(^(0),"^",7)
"RTN","PSOHLDIS",98,0)
 Q
"RTN","PSOHLDIS",99,0)
FILL ;Orig fill
"RTN","PSOHLDIS",100,0)
 S $P(^PSRX(IRX,2),"^",4)=LOT,$P(^(2),"^",8)=MFG,$P(^(2),"^",11)=EXPDT,$P(^PSRX(IRX,"OR1"),"^",6)=FPER,$P(^("OR1"),"^",7)=CPHARM
"RTN","PSOHLDIS",101,0)
 S:$G(^PSDRUG(DRG,660.1))]"" ^PSDRUG(DRG,660.1)=^PSDRUG(DRG,660.1)-QTY
"RTN","PSOHLDIS",102,0)
 ;if auto release & rel dt
"RTN","PSOHLDIS",103,0)
 I $P($G(^PS(59,DIV,"DISP")),"^",2),$G(RELDT) D
"RTN","PSOHLDIS",104,0)
 .S DIE="^PSRX(",DA=IRX,DR="31///"_RELDT_";23////"_RPHARM_";32.1///@;32.2///@" D ^DIE K DIE,DR,DA
"RTN","PSOHLDIS",105,0)
 .I $P(^PSRX(IRX,0),"^",11)["W" S BRT="W",BNAM=$P(^PSRX(IRX,0),"^",2),BDIV=$P(^(2),"^",9) S:BDIV'="" BGRP=$P($G(^PS(59,BDIV,1)),"^",20)
"RTN","PSOHLDIS",106,0)
 .S PSOCPRX=$P(^PSRX(IRX,0),"^"),RXP=IRX D CP^PSOCP
"RTN","PSOHLDIS",107,0)
 .D EN^PSOHLSN1(IRX,"ZD"),AUTOREL^PSOBPSUT(IRX,FLLN,RELDT,NDC,"A",,30)
"RTN","PSOHLDIS",108,0)
 ;else if not auto release nor rel dt
"RTN","PSOHLDIS",109,0)
 E  I $$NDCFMT^PSSNDCUT(NDC)'="",$$STATUS^PSOBPSUT(IRX,FLLN)="" D SAVNDC^PSONDCUT(IRX,FLLN,NDC)
"RTN","PSOHLDIS",110,0)
 Q
"RTN","PSOHLDIS",111,0)
REFILL ;refill
"RTN","PSOHLDIS",112,0)
 I '$D(^PSRX(IRX,1,FLLN,0)) S NONODE=1 Q
"RTN","PSOHLDIS",113,0)
 S $P(^PSRX(IRX,1,FLLN,0),"^",6)=LOT,$P(^(0),"^",14)=MFG,$P(^(0),"^",15)=EXPDT,$P(^(1),"^",4)=FPER,$P(^(1),"^",5)=CPHARM
"RTN","PSOHLDIS",114,0)
 S:$G(^PSDRUG(DRG,660.1))]"" ^PSDRUG(DRG,660.1)=^PSDRUG(DRG,660.1)-$P(^PSRX(IRX,1,FLLN,0),"^",4)
"RTN","PSOHLDIS",115,0)
 I $P($G(^PS(59,DIV,"DISP")),"^",2),$G(RELDT) D
"RTN","PSOHLDIS",116,0)
 .S DIE="^PSRX("_IRX_","""_1_""",",DA(1)=IRX,DA=FLLN
"RTN","PSOHLDIS",117,0)
 .S DR="17///"_RELDT_";4////"_RPHARM D ^DIE K DIE,DR,DA
"RTN","PSOHLDIS",118,0)
 .I $P(^PSRX(IRX,1,FLLN,0),"^",2)["W" S BRT="W",BDIV=$P(^PSRX(IRX,1,FLLN,0),"^",9),BNAM=$P(^PSRX(IRX,0),"^",2) S:BDIV'="" BGRP=$P($G(^PS(59,BDIV,1)),"^",20)
"RTN","PSOHLDIS",119,0)
 .N YY S YY=FLLN        ;*209
"RTN","PSOHLDIS",120,0)
 .S PSOCPRX=$P(^PSRX(IRX,0),"^"),RXP=IRX D CP^PSOCP
"RTN","PSOHLDIS",121,0)
 .D EN^PSOHLSN1(IRX,"ZD"),AUTOREL^PSOBPSUT(IRX,FLLN,RELDT,NDC,"A",,30)
"RTN","PSOHLDIS",122,0)
 ;else if not auto release nor rel dt
"RTN","PSOHLDIS",123,0)
 E  I $$NDCFMT^PSSNDCUT(NDC)'="",$$STATUS^PSOBPSUT(IRX,FLLN)="" D SAVNDC^PSONDCUT(IRX,FLLN,NDC)
"RTN","PSOHLDIS",124,0)
 Q
"RTN","PSOHLDIS",125,0)
PARTIAL ;partial fill dispensed
"RTN","PSOHLDIS",126,0)
 I '$D(^PSRX(IRX,"P",FLLN,0)) S NONODE=1 Q
"RTN","PSOHLDIS",127,0)
 S $P(^PSRX(IRX,"P",FLLN,0),"^",6)=LOT,$P(^(0),"^",12)=NDC,$P(^PSRX(IRX,"P",FLLN,1),"^")=MFG,$P(^(1),"^",3)=FPER,$P(^(1),"^",4)=CPHARM
"RTN","PSOHLDIS",128,0)
 S:$G(^PSDRUG(DRG,660.1))]"" ^PSDRUG(DRG,660.1)=^PSDRUG(DRG,660.1)-$P(^PSRX(IRX,"P",FLLN,0),"^",4)
"RTN","PSOHLDIS",129,0)
 I $P($G(^PS(59,DIV,"DISP")),"^",2),$G(RELDT) D
"RTN","PSOHLDIS",130,0)
 .S DIE="^PSRX("_IRX_","""_"P"_""",",DA(1)=IRX,DA=FLLN
"RTN","PSOHLDIS",131,0)
 .S DR="8///"_RELDT_";.05////"_RPHARM D ^DIE K DIE,DR,DA
"RTN","PSOHLDIS",132,0)
 .I $P(^PSRX(IRX,"P",FLLN,0),"^",2)["W" S BRT="W",BDIV=$P(^PSRX(IRX,"P",FLLN,0),"^",9),BNAM=$P(^PSRX(IRX,0),"^",2) S:BDIV'="" BGRP=$P($G(^PS(59,BDIV,1)),"^",20)
"RTN","PSOHLDIS",133,0)
 Q
"RTN","PSOHLDIS",134,0)
ACTLOG ;activity log entry
"RTN","PSOHLDIS",135,0)
 N ATXT,ACTN,RXF
"RTN","PSOHLDIS",136,0)
 S:FLL="F" RXF=$S(FLLN>5:FLLN+1,1:FLLN)
"RTN","PSOHLDIS",137,0)
 S:FLL="P" RXF=6
"RTN","PSOHLDIS",138,0)
 S ACL=0 F I=0:0 S I=$O(^PSRX(RXID,"A",I)) Q:'I  S ACL=(ACL+1)
"RTN","PSOHLDIS",139,0)
 D NOW^%DTC S NOW=%,ACL=ACL+1,^PSRX(RXID,"A",0)="^52.3DA^"_ACL_"^"_ACL
"RTN","PSOHLDIS",140,0)
 I 'MEDDISP S ATXT="Medication WAS NOT Dispensed through Interface!"
"RTN","PSOHLDIS",141,0)
 ;
"RTN","PSOHLDIS",142,0)
 ;create activity log text
"RTN","PSOHLDIS",143,0)
 I MEDDISP D
"RTN","PSOHLDIS",144,0)
 . S ATXT="External Interface Dispensing is Complete."
"RTN","PSOHLDIS",145,0)
 . I $G(NONODE) D  Q                                ;node was deleted
"RTN","PSOHLDIS",146,0)
 . . S ATXT="External Interface attempted to Release, but "
"RTN","PSOHLDIS",147,0)
 . . S ATXT=ATXT_$S(FLL="P":"Partial fill",1:"Refill")_" NOT on file."
"RTN","PSOHLDIS",148,0)
 . . S ACTN="No update performed."
"RTN","PSOHLDIS",149,0)
 . . D MAIL^PSOHLDI1
"RTN","PSOHLDIS",150,0)
 . I $G(^PSRX(RXID,"STA"))>11 D  Q                  ;non-active status
"RTN","PSOHLDIS",151,0)
 . . S ATXT="Ext. Disp. Released this Rx, which is Status of "
"RTN","PSOHLDIS",152,0)
 . . S ATXT=ATXT_$$GET1^DIQ(52,RXID,100)
"RTN","PSOHLDIS",153,0)
 . . S ACTN=""
"RTN","PSOHLDIS",154,0)
 . . D MAIL^PSOHLDI1
"RTN","PSOHLDIS",155,0)
 S ^PSRX(RXID,"A",ACL,0)=NOW_"^N^"_RPHARM_"^"_RXF_"^"_ATXT
"RTN","PSOHLDIS",156,0)
 ;
"RTN","PSOHLDIS",157,0)
 ;other comments - additional info when dispensed
"RTN","PSOHLDIS",158,0)
 I MEDDISP D
"RTN","PSOHLDIS",159,0)
 .S ^PSRX(RXID,"A",ACL,2,0)="^52.34A^2^2"
"RTN","PSOHLDIS",160,0)
 .S ^PSRX(RXID,"A",ACL,2,1,0)="Filled By: "_FPERN
"RTN","PSOHLDIS",161,0)
 .S ^PSRX(RXID,"A",ACL,2,2,0)="Checking Pharmacist: "_CPHARMN
"RTN","PSOHLDIS",162,0)
 Q
"RTN","PSOHLDIS",163,0)
ERROR ;sends the error message back to the sending station
"RTN","PSOHLDIS",164,0)
 ;parse the data from the msh segment in order to send back the error message release
"RTN","PSOHLDIS",165,0)
 ;OK=1 - segment missing
"RTN","PSOHLDIS",166,0)
 ;OK=2 - Rx does not exists
"RTN","PSOHLDIS",167,0)
 D NOW^%DTC
"RTN","PSOHLDIS",168,0)
 S REJ=$S(OK=1:"MISSING SEGMENT(S)",OK=2:"PRESCRIPTION "_$S($G(PSORX):"#: "_PSORX,1:"")_" DOES NOT EXISTS",1:"")
"RTN","PSOHLDIS",169,0)
 S ACKDATE=$P($$FMTHL7^XLFDT(%),"-",1)
"RTN","PSOHLDIS",170,0)
 S ^TMP("PSO2",$J,1)="MSH|^~\&|PSO VISTA||PSO DISPENSE||"_$G(ACKDATE)_"||RDS^013|10001|P|2.4|||NE|NE"
"RTN","PSOHLDIS",171,0)
 ;S ^TMP("PSO2",$J,2)="MFE|MUP|"_$G(J)_"|"_$G(ACKDATE)_"|"_$G(SITE)_"|CE"
"RTN","PSOHLDIS",172,0)
 ;S ^TMP("PSO2",$J,3)="ZLF|4|^"_$G(USER)_"||"_$G(REJ)
"RTN","PSOHLDIS",173,0)
 K %,ACKDATE,USER,Y,REJ,OK
"RTN","PSOHLDIS",174,0)
 Q
"RTN","PSOHLDIS",175,0)
END K ACL,I,NOW,LBI,LB,PRT,MEDDISP
"RTN","PSOHLDIS",176,0)
 K ADA,BDA,BDIV,BNGRXP,BNGSUS,BNAME,BRX,CNT1,CT,DA,DD,DIC,DIE,DIK,DIR,DO,DR,DTOUT,DUOUT,GRP,GRTP,JOES
"RTN","PSOHLDIS",177,0)
 K NAM,NDA,NFLAG,NME,ODA,PSZ,RXO,SSN,TDFN,TFLAG,TIC,TICK,TIEN,TM,TM1,TSSN,X,Y,XX,BNAM,BRT,BGRP
"RTN","PSOHLDIS",178,0)
 K Y,OK,XQADATA,SITEN,RDOM,CMOP,REQT,RTDTM,SITENUM,XQSOP,XQMSG,SITEN,NAME,XQAMSG,SITEN
"RTN","PSOHLDIS",179,0)
 K XQAROU,XQAID,RDTM,NODE1,NODE2,NODE3,NODE4,NODE5,PIDID,PIDD,PICN,PSSN,PPID,PCLM
"RTN","PSOHLDIS",180,0)
 K CPHARM,CPHARMN,FPER,FPERN,RPHARM
"RTN","PSOHLDIS",181,0)
 Q
"RTN","PSORESK")
0^4^B66758202^B61223518
"RTN","PSORESK",1,0)
PSORESK ;BIR/SAB-return to stock ;10/24/06 4:22pm
"RTN","PSORESK",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**15,9,27,40,47,55,85,130,185,184,196,148,201,259**;DEC 1997;Build 5
"RTN","PSORESK",3,0)
 ;
"RTN","PSORESK",4,0)
 ;REF/IA
"RTN","PSORESK",5,0)
 ;^PSDRUG/221
"RTN","PSORESK",6,0)
 ;^PS(59.7/694
"RTN","PSORESK",7,0)
 ;L, UL, PSOL, and PSOUL^PSSLOCK/2789
"RTN","PSORESK",8,0)
 ;^PS(55/2228
"RTN","PSORESK",9,0)
 ;PSDRTS^PSDOPT0/3064
"RTN","PSORESK",10,0)
 ;
"RTN","PSORESK",11,0)
 ;*259 - if refill was Not deleted, then stop RTS from continuing
"RTN","PSORESK",12,0)
 ;
"RTN","PSORESK",13,0)
AC I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) W !!,"Outpatient Pharmacy Site Parameters are required!" Q
"RTN","PSORESK",14,0)
 S RESK=1 K PSODEF,^UTILITY($J,"PSOPCE") S PSOPCECT=1
"RTN","PSORESK",15,0)
BC K PSOWHERE,PSODEFLG,PSOINVTX,XTYPE W !! S DIR("A")="Enter/Wand PRESCRIPTION number",DIR("?")="^D HP^PSORESK1",DIR(0)="FO" D ^DIR K DIR I $D(DIRUT) K PSODEF G EX
"RTN","PSORESK",16,0)
 I X'["-" D BCI W:'$G(RXP) !,"INVALID Rx" G:'$G(RXP) BC G BC1
"RTN","PSORESK",17,0)
 I X["-" D  I $P(X,"-")'=$G(PSORESST) W !,$C(7),$C(7),"   INVALID STATION NUMBER !!",$C(7),$C(7),! K PSORESST G BC
"RTN","PSORESK",18,0)
 .K PSORESST S PSORESSX=$G(X) K PSORESAR S DA=$P($$SITE^VASITE(),"^") I $G(DA) S DIC=4,DIQ(0)="I",DIQ="PSORESAR",DR="99" D EN^DIQ1 S PSORESST=$G(PSORESAR(4,DA,99,"I")) K PSORESAR,DIQ,DA,DR S X=$G(PSORESSX) K PSORESSX
"RTN","PSORESK",19,0)
 I X["-" S RXP=$P(X,"-",2) I '$D(^PSRX(+$G(RXP),0))!($G(RXP)']"") W !,$C(7),$C(7),$C(7),"   NON-EXISTENT Rx" G BC
"RTN","PSORESK",20,0)
 G:$D(^PSRX(RXP,0)) BC1 W !,$C(7),$C(7),$C(7),"   IMPROPER BARCODE FORMAT" G BC
"RTN","PSORESK",21,0)
BC1 ;
"RTN","PSORESK",22,0)
 S PSORRDFN=+$P($G(^PSRX(RXP,0)),"^",2)
"RTN","PSORESK",23,0)
 D ICN^PSODPT(PSORRDFN)
"RTN","PSORESK",24,0)
 S PSOPLCK=$$L^PSSLOCK(PSORRDFN,0) I '$G(PSOPLCK) D LOCK^PSOORCPY K PSOPLCK G BC
"RTN","PSORESK",25,0)
 K PSOPLCK D PSOL^PSSLOCK(RXP) I '$G(PSOMSG) W !!,$S($P($G(PSOMSG),"^",2)'="":$P($G(PSOMSG),"^",2),1:"Another person is editing this order."),! K PSOMSG D UL^PSSLOCK(+$G(PSORRDFN)) G BC
"RTN","PSORESK",26,0)
 S PSOLOUD=1 D:$P($G(^PS(55,+$P(^PSRX(RXP,0),"^",2),0)),"^",6)'=2 EN^PSOHLUP($P(^PSRX(RXP,0),"^",2)) K PSOLOUD
"RTN","PSORESK",27,0)
 I $S('+$P($G(^PSRX(+RXP,"STA")),"^"):0,$P(^("STA"),"^")=11:0,$P(^("STA"),"^")=12:0,$P(^("STA"),"^")=14:0,$P(^("STA"),"^")=15:0,1:1) D STAT^PSORESK1 D UL G BC
"RTN","PSORESK",28,0)
 S COPAYFLG=1,QDRUG=$P($G(^PSRX(RXP,0)),"^",6),QTY=$P($G(^(0)),"^",7) I $O(^PSRX(RXP,1,0)) G REF
"RTN","PSORESK",29,0)
 S Y="O" I $O(^PSRX(RXP,"P",0)) D  I $D(DUOUT)!($D(DTOUT)) D UL G BC
"RTN","PSORESK",30,0)
 .S DIR(0)="SA^O:ORIGINAL;P:PARTIAL",DIR("B")="ORIGINAL",DIR("A",1)="",DIR("A",2)="There are Partials for this Rx.",DIR("A")="Which are you Returning To Stock? "
"RTN","PSORESK",31,0)
 .S DIR("?")=" Press return for Original. Enter 'P' for Partial" D ^DIR K DIR
"RTN","PSORESK",32,0)
 S XTYPE=$S(Y="O":"O",1:"P") G:Y="P" PAR
"RTN","PSORESK",33,0)
 I $P($G(^PSRX(RXP,2)),"^",15) D  G BC
"RTN","PSORESK",34,0)
 .W !,$C(7),$C(7),"Original fill for Rx # "_$P(^PSRX(RXP,0),"^")_" was Returned to Stock." D UL
"RTN","PSORESK",35,0)
 I '$P($G(^PSRX(RXP,2)),"^",13) W !,$C(7),$C(7),"Rx # "_$P(^PSRX(RXP,0),"^")_" was NOT released !" D UL G BC
"RTN","PSORESK",36,0)
 S PSOLOCRL=$P($G(^PSRX(RXP,2)),"^",13),PSOWHERE=$S($D(^PSRX("AR",+$G(PSOLOCRL),RXP,0)):1,1:0)
"RTN","PSORESK",37,0)
 W ! S DIR("B")="YES",DIR("A",1)="Are you sure you want to RETURN TO STOCK Rx # "_$P(^PSRX(RXP,0),"^")
"RTN","PSORESK",38,0)
 S DIR("A",2)="for "_$P(^DPT($P(^PSRX(RXP,0),"^",2),0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",DIR("A")="Drug: "_$P(^PSDRUG($P(^PSRX(RXP,0),"^",6),0),"^")
"RTN","PSORESK",39,0)
 I $G(PSOWHERE) S DIR("A",3)=" ",DIR("A",4)="   *** This prescription was filled at the CMOP *** ",DIR("A",5)=" "
"RTN","PSORESK",40,0)
 S DIR(0)="YO" D ^DIR K DIR I Y=0!($D(DIRUT)) D UL G BC
"RTN","PSORESK",41,0)
 ;ORI
"RTN","PSORESK",42,0)
 D  D UL,EX S (RESK,PSOPCECT)=1 G BC
"RTN","PSORESK",43,0)
 .;VMP OIFO BAY PINES;PSO*7.0*196;KILL PSDS
"RTN","PSORESK",44,0)
 .I $T(PSDRTS^PSDOPT0)]"" D PSDRTS^PSDOPT0(RXP,"O^"_0,$P(^PSRX(RXP,2),"^",9),$P(^PSRX(RXP,0),"^",7)) D MSG K PSDS
"RTN","PSORESK",45,0)
 .Q:$G(RETSK)
"RTN","PSORESK",46,0)
 .K PSOINVTX,PSODEFLG I $G(PSOWHERE),$G(^PSDRUG(QDRUG,660.1)) D INVT^PSORXDL I $G(PSODEFLG) W !!?5,"Prescription Not Returned to Stock!",! Q
"RTN","PSORESK",47,0)
 .I +$G(^PSRX(RXP,"IB"))!($P($G(^PSRX(RXP,"PFS")),"^",2)) N PSOPFS S:$P($G(^PSRX(RXP,"PFS")),"^",2) PSOPFS="1^"_$P(^PSRX(RXP,"PFS"),"^",1,2) D CP^PSORESK1 Q:'$G(COPAYFLG)
"RTN","PSORESK",48,0)
 .;Ask comments until answered, do not allow exiting.
"RTN","PSORESK",49,0)
 .F  D  I '$D(DIRUT) Q
"RTN","PSORESK",50,0)
 ..K DIR,DUOUT,DTOUT,DIRUT,X,Y
"RTN","PSORESK",51,0)
 ..S DIR(0)="F0^10:75",DIR("A")="Comments",DIR("?")="Comments are required, 10-75 characters."
"RTN","PSORESK",52,0)
 ..S DIR("B")=$S($D(PSODEF):PSODEF,1:"Per Pharmacy Request")
"RTN","PSORESK",53,0)
 ..D ^DIR I $D(DIRUT) W !?5,"Comments are required, 10-75 characters.",! Q
"RTN","PSORESK",54,0)
 ..S (PSODEF,COM)=$G(Y) K DIR,X,Y
"RTN","PSORESK",55,0)
 ..Q
"RTN","PSORESK",56,0)
 .I $G(^PSDRUG(QDRUG,660.1)) D
"RTN","PSORESK",57,0)
 ..I $G(PSOWHERE),'$G(PSOINVTX) Q
"RTN","PSORESK",58,0)
 ..S ^PSDRUG(QDRUG,660.1)=^PSDRUG(QDRUG,660.1)+QTY
"RTN","PSORESK",59,0)
 .I $G(PSOWHERE) K ^PSRX("AR",+$G(PSOLOCRL),RXP,0)
"RTN","PSORESK",60,0)
 .D NOW^%DTC S DA=RXP,DA=RXP,DIE="^PSRX(",DR="31///@;32.1///"_% D ^DIE K DIE,DR,DA Q:$D(Y)
"RTN","PSORESK",61,0)
 .D ACT^PSORESK1 S DA=$O(^PS(52.5,"B",RXP,0)) I DA S DIK="^PS(52.5," D ^DIK
"RTN","PSORESK",62,0)
 .D REVERSE^PSOBPSU1(RXP,0,"RS",4,,1)
"RTN","PSORESK",63,0)
 .D EN^PSOHLSN1(RXP,"ZD") W !,"Rx # "_$P(^PSRX(RXP,0),"^")_" Returned to Stock.",!
"RTN","PSORESK",64,0)
 .Q
"RTN","PSORESK",65,0)
 ;
"RTN","PSORESK",66,0)
REF I $O(^PSRX(RXP,1,0)),$O(^PSRX(RXP,"P",0)) D  I $D(DTOUT)!($D(DUOUT)) D UL G BC
"RTN","PSORESK",67,0)
 .S DIR(0)="SA^R:REFILL;P:PARTIAL",DIR("B")="REFILL",DIR("A",1)="",DIR("A",2)="There are Refills and Partials for this Rx.",DIR("A")="Which are you Returning To Stock? "
"RTN","PSORESK",68,0)
 .S DIR("?")=" Press return for Refill. Enter 'P' for Partial" D ^DIR K DIR
"RTN","PSORESK",69,0)
 I $O(^PSRX(RXP,1,0)),$O(^PSRX(RXP,"P",0)) S XTYPE=$S(Y="R":1,1:"P")
"RTN","PSORESK",70,0)
PAR S:$G(XTYPE)']"" XTYPE=1 S TYPE=0 F YY=0:0 S YY=$O(^PSRX(RXP,XTYPE,YY)) Q:'YY  S TYPE=YY
"RTN","PSORESK",71,0)
 I 'TYPE D UL,EX S (RESK,PSOPCECT)=1 G BC
"RTN","PSORESK",72,0)
 I $P($G(^PSRX(RXP,XTYPE,TYPE,0)),"^",16) W $C(7),!!,"Last Fill Already Returned to Stock !",! D UL,EX S (RESK,PSOPCECT)=1 G BC
"RTN","PSORESK",73,0)
 I '$P(^PSRX(RXP,XTYPE,TYPE,0),"^",$S(XTYPE:18,1:19)) W !!,$C(7),$C(7),$S(XTYPE:"Refill",1:"PARTIAL")_" #"_TYPE_" was NOT released !",! D UL G BC
"RTN","PSORESK",74,0)
 W ! K DIR,DUOUT,DTOUT
"RTN","PSORESK",75,0)
 K PSOLOCRL,PSOWHERE I $G(XTYPE) S PSOLOCRL=$P($G(^PSRX(RXP,XTYPE,+$G(TYPE),0)),"^",18),PSOWHERE=$S($D(^PSRX("AR",+$G(PSOLOCRL),RXP,+$G(TYPE))):1,1:0)
"RTN","PSORESK",76,0)
 W ! S DIR("B")="YES",DIR("A",1)="Are you sure you want to RETURN TO STOCK Rx # "_$P(^PSRX(RXP,0),"^")_$S(XTYPE:" Refill ",1:" Partial ")_"# "_TYPE,DIR(0)="Y"
"RTN","PSORESK",77,0)
 S DIR("A",2)="for "_$P(^DPT($P(^PSRX(RXP,0),"^",2),0),"^")_" ("_$E($P(^(0),"^",9),6,9)_")",DIR("A")="Drug: "_$P(^PSDRUG($P(^PSRX(RXP,0),"^",6),0),"^")
"RTN","PSORESK",78,0)
 I $G(PSOWHERE) S DIR("A",3)=" ",DIR("A",4)="   *** This prescription was filled at the CMOP *** ",DIR("A",5)=" "
"RTN","PSORESK",79,0)
 D ^DIR K DIR I 'Y!($D(DUOUT))!($D(DTOUT)) D UL G BC
"RTN","PSORESK",80,0)
 I $T(PSDRTS^PSDOPT0)]"" D
"RTN","PSORESK",81,0)
 .;VMP OIFO BAY PINES;PSO*7.0*196;KILL PSDS
"RTN","PSORESK",82,0)
 .I XTYPE D PSDRTS^PSDOPT0(RXP,"R^"_TYPE,$P(^PSRX(RXP,1,TYPE,0),"^",9),$P(^(0),"^",4)) D MSG K PSDS Q
"RTN","PSORESK",83,0)
 .D PSDRTS^PSDOPT0(RXP,"P^"_TYPE,$P(^PSRX(RXP,"P",TYPE,0),"^",9),$P(^(0),"^",4)) D MSG K PSDS
"RTN","PSORESK",84,0)
 I $G(RETSK) D UL,EX G BC
"RTN","PSORESK",85,0)
 K PSOINVTX,PSODEFLG I $G(PSOWHERE),$G(^PSDRUG(QDRUG,660.1)) D INVT^PSORXDL I $G(PSODEFLG) W !!?5,"Prescription Not Returned to Stock!",! D UL G BC
"RTN","PSORESK",86,0)
 I XTYPE I +$G(^PSRX(RXP,"IB"))!($P($G(^PSRX(RXP,1,TYPE,"PFS")),"^",2)) N PSOPFS S:$P($G(^PSRX(RXP,1,TYPE,"PFS")),"^",2) PSOPFS="1^"_$P(^PSRX(RXP,1,TYPE,"PFS"),"^",1,2) D CP^PSORESK1 I '$G(COPAYFLG) D UL G BC
"RTN","PSORESK",87,0)
 ;Ask comments until answered, do not allow exiting.
"RTN","PSORESK",88,0)
 F  D  I '$D(DIRUT) Q
"RTN","PSORESK",89,0)
 .K DIR,DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSORESK",90,0)
 .S DIR(0)="F0^10:75",DIR("A")="Comments",DIR("?")="Comments are required, 10-75 characters."
"RTN","PSORESK",91,0)
 .S DIR("B")=$S($D(PSODEF):PSODEF,1:"Per Pharmacy Request")
"RTN","PSORESK",92,0)
 .D ^DIR K DIR I $D(DIRUT) W !?5,"Comments are required, 10-75 characters.",! Q
"RTN","PSORESK",93,0)
 .Q
"RTN","PSORESK",94,0)
 S (PSODEF,COM)=$G(Y) K X,Y
"RTN","PSORESK",95,0)
 D NOW^%DTC S QTY=$P(^PSRX(RXP,XTYPE,TYPE,0),"^",4) I $G(^PSDRUG(QDRUG,660.1)) D
"RTN","PSORESK",96,0)
 .I $G(PSOWHERE),'$G(PSOINVTX) Q
"RTN","PSORESK",97,0)
 .S ^PSDRUG(QDRUG,660.1)=^PSDRUG(QDRUG,660.1)+$G(QTY)
"RTN","PSORESK",98,0)
 I $G(PSOWHERE) K ^PSRX("AR",+$G(PSOLOCRL),RXP,$G(TYPE))
"RTN","PSORESK",99,0)
 I XTYPE D REVERSE^PSOBPSU1(RXP,TYPE,"RS",4,,1)
"RTN","PSORESK",100,0)
 ;
"RTN","PSORESK",101,0)
 ;save release dates in case can't perform the delete of .01     *259
"RTN","PSORESK",102,0)
 S:XTYPE SVRELDT=$P(^PSRX(RXP,XTYPE,TYPE,0),"^",18)
"RTN","PSORESK",103,0)
 S:'XTYPE SVRELDT=$P(^PSRX(RXP,XTYPE,TYPE,0),"^",19)
"RTN","PSORESK",104,0)
 ;
"RTN","PSORESK",105,0)
 ;del rel date 1st and then attempt to del .01 field
"RTN","PSORESK",106,0)
 S DA(1)=RXP,DA=TYPE,DIE="^PSRX("_DA(1)_","_$S(XTYPE:1,1:"""P""")_",",DR=$S(XTYPE:"17////@",1:"8////@")_";.01///@"
"RTN","PSORESK",107,0)
 W ! D ^DIE
"RTN","PSORESK",108,0)
 ;
"RTN","PSORESK",109,0)
 ;if node still exists then fileman could not delete .01         *259
"RTN","PSORESK",110,0)
 I $D(^PSRX(RXP,XTYPE,TYPE,0)) D  G BC
"RTN","PSORESK",111,0)
 . W " - Not Returned!"
"RTN","PSORESK",112,0)
 . S DA(1)=RXP,DA=TYPE,DIE="^PSRX("_DA(1)_","_$S(XTYPE:1,1:"""P""")_","
"RTN","PSORESK",113,0)
 . S DR=$S(XTYPE:"17////",1:"8////")_SVRELDT   ;put back saved rel dte
"RTN","PSORESK",114,0)
 . D ^DIE,UL
"RTN","PSORESK",115,0)
 ;
"RTN","PSORESK",116,0)
 ;fall thru and perform RTS for refills/partials
"RTN","PSORESK",117,0)
 D:XTYPE'="P" NPF D ACT^PSORESK1
"RTN","PSORESK",118,0)
 W !!,"Rx # "_$P(^PSRX(RXP,0),"^")_$S(XTYPE:" REFILL",1:" PARTIAL")_" #"_TYPE_" Returned to Stock" S DA=$O(^PS(52.5,"B",RXP,0)) I DA S DIK="^PS(52.5," D ^DIK
"RTN","PSORESK",119,0)
 K PSODISPP S:'$G(XTYPE) PSODISPP=1 D EN^PSOHLSN1(RXP,"ZD") K PSODISPP
"RTN","PSORESK",120,0)
 D UL G BC
"RTN","PSORESK",121,0)
EX ;
"RTN","PSORESK",122,0)
 K DA,DR,DIE,X,X1,X2,Y,RXP,REC,DIR,XDT,REC,RDUZ,DIRUT,PSOCPN,PSOCPRX,YY,QDRUG,QTY,TYPE,XTYPE,I,%,DIRUT,COPAYFLG,PSOINVTX,RESK,PSOPCECT,COM,PSOWHERE,PSOLOCRL,PSODEFLG,PSORRDFN,PSOMSG,PSOPLCK,PSDCS,PSDRS,RETSK
"RTN","PSORESK",123,0)
 K DIC,DIK,PSOPFS
"RTN","PSORESK",124,0)
 Q
"RTN","PSORESK",125,0)
MSG I $G(PSDCS),'$G(PSDRS) W !!,"The PSDMGR key is required to return a CONTROLLED SUBSTANCE Rx to stock and",!,"update corresponding vault balances." S RETSK=1
"RTN","PSORESK",126,0)
 Q
"RTN","PSORESK",127,0)
BCI S RXP=0
"RTN","PSORESK",128,0)
RXP S RXP=$O(^PSRX("B",X,RXP)) I $P($G(^PSRX(+RXP,"STA")),"^")=13 G RXP
"RTN","PSORESK",129,0)
 Q
"RTN","PSORESK",130,0)
UL ;
"RTN","PSORESK",131,0)
 I $G(RXP) D PSOUL^PSSLOCK(RXP)
"RTN","PSORESK",132,0)
 D UL^PSSLOCK(+$G(PSORRDFN))
"RTN","PSORESK",133,0)
 Q
"RTN","PSORESK",134,0)
NPF N PSOY I $G(TYPE)-1>0,+$P(^PSRX(RXP,1,TYPE-1,0),"^") D
"RTN","PSORESK",135,0)
 .S X1=+$P(^PSRX(RXP,1,$G(TYPE)-1,0),"^"),X2=$P(^PSRX(RXP,0),"^",8)-10\1
"RTN","PSORESK",136,0)
 .D C^%DTC S PSOY=X,X1=$P(^PSRX(RXP,2),"^",2),X2=TYPE*$P(^PSRX(RXP,0),"^",8)-10\1
"RTN","PSORESK",137,0)
 .D C^%DTC S X=$S(PSOY<X:X,1:PSOY)
"RTN","PSORESK",138,0)
 I $G(TYPE)-1<1 D
"RTN","PSORESK",139,0)
 .S X1=$P(^PSRX(RXP,2),"^",2),X2=$P(^PSRX(RXP,0),"^",8)-10\1
"RTN","PSORESK",140,0)
 .D C^%DTC S:$P(^PSRX(RXP,3),"^",8) X=""
"RTN","PSORESK",141,0)
 I $G(X) S DA=RXP,DIE=52,DR="102///"_X D ^DIE K DIE
"RTN","PSORESK",142,0)
 Q
"RTN","PSOUTL")
0^5^B70558171^B70215755
"RTN","PSOUTL",1,0)
PSOUTL ;BHAM ISC/SAB - pso utility routine ;10/20/06 3:44pm
"RTN","PSOUTL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,21,126,174,218,259**;DEC 1997;Build 5
"RTN","PSOUTL",3,0)
 ;External reference SERV^IBARX1 supported by DBIA 2245
"RTN","PSOUTL",4,0)
 ;External reference ^PS(55,     supported by DBIA 2228
"RTN","PSOUTL",5,0)
 ;
"RTN","PSOUTL",6,0)
 ;*218 prevent refill from being deleted if pending processing via
"RTN","PSOUTL",7,0)
 ; external dispense machines
"RTN","PSOUTL",8,0)
 ;*259 reverse *218 restrictions & Add del only last refill logic.
"RTN","PSOUTL",9,0)
 ;
"RTN","PSOUTL",10,0)
SUSPCAN ;dcl rx from suspense used in new, renew AND verification of Rxs
"RTN","PSOUTL",11,0)
 S PSLAST=0 F PSI=0:0 S PSI=$O(^PSRX(PSRX,1,PSI)) Q:'PSI  S PSLAST=PSI
"RTN","PSOUTL",12,0)
 I PSLAST S PSI=^PSRX(PSRX,1,PSLAST,0) K ^PSRX(PSRX,1,PSLAST),^PSRX(PSRX,1,"B",+PSI,PSLAST) S ^(0)=$P(^PSRX(PSRX,1,0),"^",1,3)_"^"_($P(^(0),"^",4)-1) K PSLAST,PSI,SUSX,SUS1,SUS2 Q
"RTN","PSOUTL",13,0)
 S $P(^PSRX(PSRX,3),"^",7)="DISCONTINUED FROM SUSPENSE BEFORE FILLING" K PSI,SUSX,SUS1,SUS2 Q
"RTN","PSOUTL",14,0)
 ;
"RTN","PSOUTL",15,0)
ACTLOG ;
"RTN","PSOUTL",16,0)
 F PSI=0:0 S PSI=$O(^PSRX(PSRX,"A",PSI)) I 'PSI!'$O(^(PSI)) S ^PSRX(PSRX,"A",+PSI+1,0)=DT_"^"_PSREA_"^"_PSOCLC_"^"_PSRXREF_"^"_PSMSG,^PSRX(PSRX,"A",0)="^52.3DA^"_(+PSI+1)_"^"_(+PSI+1) Q
"RTN","PSOUTL",17,0)
ACTOUT I PSREA="C" S PSI=$S($D(^PSRX(PSRX,2)):+$P(^(2),"^",6),1:0) K:$D(^PS(55,PSDFN,"P","A",PSI,PSRX)) ^(PSRX) S ^PS(55,PSDFN,"P","A",DT,PSRX)="" Q
"RTN","PSOUTL",18,0)
 I PSREA="R" F PSI=0:0 S PSI=$O(^PSRX(PSRX,"A",PSI)) Q:'PSI  I $D(^(PSI,0)),$P(^(0),"^",2)="C" S PSS=+^(0)
"RTN","PSOUTL",19,0)
 I $D(PSS),PSS K:$D(^PS(55,PSDFN,"P","A",PSS,PSRX)) ^(PSRX)
"RTN","PSOUTL",20,0)
 I PSREA="R",$D(^PSRX(PSRX,2))#2 S ^PS(55,PSDFN,"P","A",+$P(^PSRX(PSRX,2),"^",6),PSRX)=""
"RTN","PSOUTL",21,0)
 Q
"RTN","PSOUTL",22,0)
 ;
"RTN","PSOUTL",23,0)
QUES ;INSTRUCTIONS FOR RENEW AND REFILL
"RTN","PSOUTL",24,0)
 W !?5,"Enter the item #(s) or RX #(s) you wish to ",$S(PSFROM="N":"renew ",PSFROM="R":"REFILL "),"separated by commas."
"RTN","PSOUTL",25,0)
 W !?5,"For example: 1,2,5 or 123456,33254A,232323B."
"RTN","PSOUTL",26,0)
 W !?5,"Do not enter the same number twice, duplicates are not allowed."
"RTN","PSOUTL",27,0)
 Q
"RTN","PSOUTL",28,0)
ENDVCHK S PSOPOP=0 Q:'PSODIV  Q:'$P(^PSRX(PSRX,2),"^",9)!($P(^(2),"^",9)=PSOSITE)
"RTN","PSOUTL",29,0)
CHK1 I '$P(PSOSYS,"^",2) W !?10,$C(7),"RX# ",$P(^PSRX(PSRX,0),"^")," is not a valid choice. (Different Division)" S PSPOP=1 Q
"RTN","PSOUTL",30,0)
 I $P(PSOSYS,"^",3) W !?10,$C(7),"RX# ",$P(^PSRX(PSRX,0),"^")," is from another division. Continue? (Y/N) " R ANS:DTIME I ANS="^"!(ANS="") S PSPOP=1 Q
"RTN","PSOUTL",31,0)
 I (ANS']"")!("YNyn"'[$E(ANS)) W !?10,$C(7),"Answer 'YES' or 'NO'." G CHK1
"RTN","PSOUTL",32,0)
 S:$E(ANS)["Nn" PSPOP=1 Q
"RTN","PSOUTL",33,0)
 ;PSO*7*259; SET VAR PSOSFN TO CHECK FOR SUSPENDED REFILL
"RTN","PSOUTL",34,0)
K52 K PSOSFN S SFN=+$O(^PS(52.5,"B",DA(1),0)),PSOSFN=SFN Q:SFN=0
"RTN","PSOUTL",35,0)
 I $P($G(^PS(52.5,SFN,0)),"^",5)=$P($G(^PSRX(+^PS(52.5,SFN,0),"P",0)),"^",3),$P($G(^PSRX($P(^PS(52.5,SFN,0),"^"),"P",0)),"^",4)=0 N PSOXX S PSOXX=1 G KILL
"RTN","PSOUTL",36,0)
 G:X'=""&($G(Y)=1) KILL I $G(Y)'=1,SFN I $D(^PS(52.5,SFN,0)),'$P(^(0),"^",5),'$P($G(^("P")),"^") D
"RTN","PSOUTL",37,0)
 .S SDT=+$P(^PS(52.5,SFN,0),"^",2) K ^PS(52.5,"C",SDT,SFN)
"RTN","PSOUTL",38,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="Q" K ^PS(52.5,"AQ",SDT,+$P(^PS(52.5,SFN,0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,"Q")
"RTN","PSOUTL",39,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" K ^PS(52.5,"AC",+$P(^PS(52.5,SFN,0),"^",3),SDT,SFN)
"RTN","PSOUTL",40,0)
 .K SFN,SDT
"RTN","PSOUTL",41,0)
 Q
"RTN","PSOUTL",42,0)
S52 S (RIFN,PSOSX)=0 F  S RIFN=$O(^PSRX(DA(1),1,RIFN)) Q:'RIFN  S RFID=$P(^PSRX(DA(1),1,RIFN,0),"^"),PSOSX=PSOSX+1
"RTN","PSOUTL",43,0)
 S SFN=+$O(^PS(52.5,"B",DA(1),0)) I SFN,'$G(^PS(52.5,SFN,"P")),$P($G(^PSRX($P($G(^PS(52.5,SFN,0)),"^"),"STA")),"^")=5 D
"RTN","PSOUTL",44,0)
 .I '$D(^PS(52.5,SFN,0))!($P($G(^(0)),"^",5)) Q
"RTN","PSOUTL",45,0)
 .S $P(^PS(52.5,SFN,0),"^",2)=RFID,^PS(52.5,"C",RFID,SFN)=""
"RTN","PSOUTL",46,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="Q" S ^PS(52.5,"AQ",RFID,+$P(^PS(52.5,SFN,0),"^",3),SFN)="" D SCMPX^PSOCMOP(SFN,"Q")
"RTN","PSOUTL",47,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" S ^PS(52.5,"AC",+$P(^PS(52.5,SFN,0),"^",3),RFID,SFN)=""
"RTN","PSOUTL",48,0)
 K SFN,RFIN,RFID,PSOSX,PSOSXDT Q
"RTN","PSOUTL",49,0)
KILL N DFN
"RTN","PSOUTL",50,0)
 I SFN D
"RTN","PSOUTL",51,0)
 .S $P(^PSRX(DA(1),"STA"),"^")=0 Q:'$D(^PS(52.5,SFN,0))  S DFN=+$P(^PS(52.5,SFN,0),"^",3),PAT=$P(^DPT(DFN,0),"^")
"RTN","PSOUTL",52,0)
 .;I $P(^PS(52.5,SFN,0),"^",5) Q
"RTN","PSOUTL",53,0)
 .K ^PS(52.5,"B",+$P(^PS(52.5,SFN,0),"^"),SFN),^PS(52.5,"C",+$P(^PS(52.5,SFN,0),"^",2),SFN),^PS(52.5,"D",PAT,SFN),^PS(52.5,"AF",DFN,SFN)
"RTN","PSOUTL",54,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)="" D
"RTN","PSOUTL",55,0)
 ..I $G(^PS(52.5,SFN,"P")) K ^PS(52.5,"AS",+$P(^(0),"^",8),+$P(^(0),"^",9),+$P(^(0),"^",6),+$P(^(0),"^",11),SFN),^PS(52.5,"ADL",$E(+$P(^PS(52.5,SFN,0),"^",8),1,7),SFN) Q
"RTN","PSOUTL",56,0)
 ..K ^PS(52.5,"AC",DFN,+$P(^PS(52.5,SFN,0),"^",2),SFN)
"RTN","PSOUTL",57,0)
 .I $P($G(^PS(52.5,SFN,0)),"^",7)'="" D
"RTN","PSOUTL",58,0)
 ..;Kill CMOP xrefs
"RTN","PSOUTL",59,0)
 ..N PSOC7 S PSOC7=$P($G(^PS(52.5,SFN,0)),"^",7)
"RTN","PSOUTL",60,0)
 ..I PSOC7="Q"!(PSOC7="P") K ^PS(52.5,"AG",+$P(^PS(52.5,SFN,0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,PSOC7)
"RTN","PSOUTL",61,0)
 ..I PSOC7="X"!(PSOC7="P")!(PSOC7="L") K ^PS(52.5,$S(PSOC7="X":"AX",PSOC7="P":"AP",1:"AL"),$P(^PS(52.5,SFN,0),"^",2),$P(^(0),"^",3),SFN) D KCMPX^PSOCMOP(SFN,PSOC7)
"RTN","PSOUTL",62,0)
 ..K ^PS(52.5,"APR",+$P(^PS(52.5,SFN,0),"^",8),+$P(^(0),"^",9),+$P(^(0),"^",6),+$P(^(0),"^",11),SFN),^PS(52.5,"ADL",$E(+$P(^PS(52.5,SFN,0),"^",8),1,7),SFN)
"RTN","PSOUTL",63,0)
 .K ^PS(52.5,SFN,0),^PS(52.5,SFN,"P"),DFN,SFN,PAT
"RTN","PSOUTL",64,0)
 S CNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA(1),"A",SUB)) Q:'SUB  S CNT=SUB
"RTN","PSOUTL",65,0)
 S:DA>5 DA=DA+1 D NOW^%DTC S CNT=CNT+1
"RTN","PSOUTL",66,0)
 S ^PSRX(DA(1),"A",0)="^52.3DA^"_CNT_"^"_CNT,^PSRX(DA(1),"A",CNT,0)=%_"^D^"_DUZ_"^"_DA_"^"
"RTN","PSOUTL",67,0)
 I '$D(PSOXX) S ^PSRX(DA(1),"A",CNT,0)=^PSRX(DA(1),"A",CNT,0)_"Refill "
"RTN","PSOUTL",68,0)
 ;if PSOXX not exist, = refill. otherwise, it is a partial.
"RTN","PSOUTL",69,0)
 S ^PSRX(DA(1),"A",CNT,0)=^PSRX(DA(1),"A",CNT,0)_$S($G(RESK):"returned to stock.",$G(PSOPSDAL):"deleted during Controlled Subs release.",$G(PSOXX)=1:"Partial deleted from suspense file.",1:"deleted during Rx edit.") K CNT,SUB
"RTN","PSOUTL",70,0)
 Q
"RTN","PSOUTL",71,0)
CID ;calculates six months limit on issue dates
"RTN","PSOUTL",72,0)
 S PSID=X,X="T-6M",%DT="X" D ^%DT S %DT(0)=Y,X=PSID,%DT="EX" D ^%DT K PSID
"RTN","PSOUTL",73,0)
 Q
"RTN","PSOUTL",74,0)
CIDH S X="T-6M",%DT="X" D ^%DT X ^DD("DD") D EN^DDIOL("Issue Date must be greater or equal to "_Y,"","!")
"RTN","PSOUTL",75,0)
 Q
"RTN","PSOUTL",76,0)
SPR F RF=0:0 S RF=$O(^PSRX(DA(1),1,RF)) Q:'RF  S NODE=RF
"RTN","PSOUTL",77,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) Q
"RTN","PSOUTL",78,0)
SREF I $G(NODE) S NODE=NODE-1 G:'$D(^PSRX(DA(1),1,NODE,0)) SREF
"RTN","PSOUTL",79,0)
 I NODE=0 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) Q
"RTN","PSOUTL",80,0)
 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),1,NODE,0),"^",1) Q
"RTN","PSOUTL",81,0)
 K NODE,RF
"RTN","PSOUTL",82,0)
 Q
"RTN","PSOUTL",83,0)
KPR F RF=0:0 S RF=$O(^PSRX(DA(1),1,RF)) Q:'RF  S NODE=RF
"RTN","PSOUTL",84,0)
 I NODE=DA&(X'="") S NODE=NODE-1 S:NODE=1 NODE=0 G:'NODE ORIG G:NODE>1 KREF
"RTN","PSOUTL",85,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",86,0)
KREF S NODE=NODE-1 G:'NODE EX
"RTN","PSOUTL",87,0)
 I NODE=1 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",88,0)
 G:NODE=DA&(X'="") KREF G:'$D(^PSRX(DA(1),1,NODE,0)) KREF
"RTN","PSOUTL",89,0)
ORIG I 'NODE S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),2),"^",2) G EX
"RTN","PSOUTL",90,0)
 S $P(^PSRX(DA(1),3),"^",4)=$P(^PSRX(DA(1),1,NODE,0),"^",1) G EX
"RTN","PSOUTL",91,0)
EX K NODE,RF
"RTN","PSOUTL",92,0)
 Q
"RTN","PSOUTL",93,0)
IBSS N PSOHLP S PSOHLP(1,"F")="!!"
"RTN","PSOUTL",94,0)
 S PSOHLP(1)="Entry in this field must match the SERVICE field for pharmacy action"
"RTN","PSOUTL",95,0)
 S PSOHLP(2,"F")="!"
"RTN","PSOUTL",96,0)
 S PSOHLP(2)="types in the IB ACTION TYPE file AND be a valid entry in your"
"RTN","PSOUTL",97,0)
 S PSOHLP(3,"F")="!"
"RTN","PSOUTL",98,0)
 S PSOHLP(3)="SERVICE/SECTION file to generate copay charges!"
"RTN","PSOUTL",99,0)
 S PSOHLP(4,"F")="!!"
"RTN","PSOUTL",100,0)
 D EN^DDIOL(.PSOHLP) K PSOHLP
"RTN","PSOUTL",101,0)
 Q
"RTN","PSOUTL",102,0)
IBSSR S PSOIBFL=0 F PSOIBLP=0:0 S PSOIBLP=$O(^DIC(49,PSOIBLP)) Q:'PSOIBLP!(PSOIBFL)  S Y=PSOIBLP,PSOIBST=$$SERV^IBARX1(+Y) I $G(PSOIBST) S DIE="^PS(59,",DA=PSOSITE,DR="1003////"_PSOIBLP D ^DIE K DIE D  S PSOIBFL=1
"RTN","PSOUTL",103,0)
 .W $C(7),!!,"There was an invalid entry in your IB SERVICE/SECTION field in your Outpatient",!,"Site Parameter file, but we have fixed the problem for you, and you",!,"may continue!" Q
"RTN","PSOUTL",104,0)
 Q
"RTN","PSOUTL",105,0)
WARN ;
"RTN","PSOUTL",106,0)
 I $G(PSOUNHLD) D  Q
"RTN","PSOUTL",107,0)
 .D EN^DDIOL("You cannot delete a refill while removing from Hold! Use the Edit Action.","","$C(7),!!"),EN^DDIOL(" ","","!!")
"RTN","PSOUTL",108,0)
 I $G(CMOP(DA))]""&(+$G(CMOP(DA))<3) D  K CMOP Q
"RTN","PSOUTL",109,0)
 .D EN^DDIOL("You cannot delete a refill that"_$S(+$G(CMOP(DA))=1:" has been released by",1:" is being transmitted to")_" the CMOP","","!!")
"RTN","PSOUTL",110,0)
 .D EN^DDIOL(" ","","!!")
"RTN","PSOUTL",111,0)
 K CMOP
"RTN","PSOUTL",112,0)
 ;
"RTN","PSOUTL",113,0)
 N PSOL,PSR
"RTN","PSOUTL",114,0)
 S PSR=0 F  S PSR=$O(^PSRX(DA(1),1,PSR)) Q:'PSR  S PSOL=PSR
"RTN","PSOUTL",115,0)
 I DA=PSOL,$P(^PSRX(DA(1),1,DA,0),"^",18) D  Q
"RTN","PSOUTL",116,0)
 .D EN^DDIOL("Refill Released! Use the 'Return to Stock' option!","","$C(7),!!"),EN^DDIOL(" ","","!")
"RTN","PSOUTL",117,0)
 ;
"RTN","PSOUTL",118,0)
 ;Only allow deletion if last refill      *259
"RTN","PSOUTL",119,0)
 I $O(^PSRX(DA(1),1,DA)) D  Q
"RTN","PSOUTL",120,0)
 .D EN^DDIOL("Only the last refill can be deleted.  Later refills must be deleted first.","","$C(7),!!")
"RTN","PSOUTL",121,0)
 .D EN^DDIOL("","","!!")
"RTN","PSOUTL",122,0)
 ;
"RTN","PSOUTL",123,0)
 ;Warn of In Process, Only delete if answered Yes         ;*259
"RTN","PSOUTL",124,0)
 I $$REFIP^PSOUTLA1(DA(1),DA,"R") D  I 'Y Q               ;reset $T
"RTN","PSOUTL",125,0)
 . D EN^DDIOL("** Refill has previously been sent to the External Dispense Machine","","!!,?2")
"RTN","PSOUTL",126,0)
 . D EN^DDIOL("** for filling and is still Pending Processing","","$C(7),!,?2")
"RTN","PSOUTL",127,0)
 . D EN^DDIOL("","","!")
"RTN","PSOUTL",128,0)
 . K DIR
"RTN","PSOUTL",129,0)
 . S DIR("A")="Do you want to continue? "
"RTN","PSOUTL",130,0)
 . S DIR("B")="Y"
"RTN","PSOUTL",131,0)
 . S DIR(0)="YA^^"
"RTN","PSOUTL",132,0)
 . S DIR("?")="Enter Y for Yes or N for No."
"RTN","PSOUTL",133,0)
 . D ^DIR
"RTN","PSOUTL",134,0)
 . K DIR
"RTN","PSOUTL",135,0)
 Q
"RTN","PSOUTL",136,0)
 ;
"RTN","PSOUTL",137,0)
WARN1 ;move to PSOUTLA1
"RTN","PSOUTL",138,0)
 D WARN1^PSOUTLA1
"RTN","PSOUTL",139,0)
 Q
"RTN","PSOUTL",140,0)
 ;
"RTN","PSOUTL",141,0)
CAN(PSOXRX) ;Clean up Rx when discontinued
"RTN","PSOUTL",142,0)
 N SUSD,IFN,RF,NODE,DA
"RTN","PSOUTL",143,0)
 Q:'$D(^PSRX(PSOXRX,0))
"RTN","PSOUTL",144,0)
 S DA=$O(^PS(52.5,"B",PSOXRX,0)) I DA S DIK="^PS(52.5,",SUSD=$P($G(^PS(52.5,DA,0)),"^",2) D ^DIK K DIK I $O(^PSRX(PSOXRX,1,0)) S DA=PSOXRX D REF^PSOCAN2
"RTN","PSOUTL",145,0)
 I $D(^PS(52.4,PSOXRX,0)) S DIK="^PS(52.4,",DA=PSOXRX D ^DIK K DIK
"RTN","PSOUTL",146,0)
 I $G(^PSRX(PSOXRX,"H"))]"" K:$P(^PSRX(PSOXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOXRX,"H"),"^"),PSOXRX) S ^PSRX(PSOXRX,"H")=""
"RTN","PSOUTL",147,0)
 I '$P($G(^PSRX(PSOXRX,2)),"^",2) K DIE S DIE="^PSRX(",DA=PSOXRX,DR="22///"_DT D ^DIE
"RTN","PSOUTL",148,0)
 Q
"RTN","PSOUTL",149,0)
ECAN(PSOXRX) ;Clean up Rx when expired
"RTN","PSOUTL",150,0)
 N DA
"RTN","PSOUTL",151,0)
 Q:'$D(^PSRX(PSOXRX,0))
"RTN","PSOUTL",152,0)
 S DA=$O(^PS(52.5,"B",PSOXRX,0)) I DA K DIK S DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOUTL",153,0)
 I $D(^PS(52.4,PSOXRX,0)) K DIK S DIK="^PS(52.4,",DA=PSOXRX D ^DIK K DIK
"RTN","PSOUTL",154,0)
 I $G(^PSRX(PSOXRX,"H"))]"" K:$P(^PSRX(PSOXRX,"H"),"^") ^PSRX("AH",$P(^PSRX(PSOXRX,"H"),"^"),PSOXRX) S ^PSRX(PSOXRX,"H")=""
"RTN","PSOUTL",155,0)
 I '$P($G(^PSRX(PSOXRX,2)),"^",2) K DIE S DIE="^PSRX(",DA=PSOXRX,DR="22///"_DT D ^DIE
"RTN","PSOUTL",156,0)
 Q
"RTN","PSOUTL",157,0)
CMOP ;CMOP("L")=LAST FILL... if it is orig Rx =0
"RTN","PSOUTL",158,0)
 ;CMOP(FILL #)=CMOP status from 52[TRAN=0,DISP=1,RETRAN=2,NOT DISP=3
"RTN","PSOUTL",159,0)
 ;If suspended CMOP("S")=CMOP suspense status Q,L,X,P,R
"RTN","PSOUTL",160,0)
 ;All returned variables can be killed by K CMOP
"RTN","PSOUTL",161,0)
 ;
"RTN","PSOUTL",162,0)
 S CRX=DA
"RTN","PSOUTL",163,0)
CMOP1 N X
"RTN","PSOUTL",164,0)
 S (CMOP("L"),X)=0  F  S X=$O(^PSRX(CRX,1,X)) Q:'X  S CMOP("L")=X
"RTN","PSOUTL",165,0)
 I $O(^PSRX(CRX,4,0)) F X=0:0 S X=$O(^PSRX(CRX,4,X)) Q:'X  D
"RTN","PSOUTL",166,0)
 .S CMOP($P($G(^PSRX(CRX,4,X,0)),"^",3))=$P($G(^(0)),"^",4)
"RTN","PSOUTL",167,0)
 S X=$O(^PS(52.5,"B",CRX,0)) I X]"" S CMOP("S")=$P($G(^PS(52.5,X,0)),"^",7)
"RTN","PSOUTL",168,0)
 K CRX,X
"RTN","PSOUTL",169,0)
 Q
"RTN","PSOUTLA1")
0^6^B59108648^B47429412
"RTN","PSOUTLA1",1,0)
PSOUTLA1 ;BHAM ISC/RTR-Pharmacy utility program cont. ;10/20/06 3:44pm
"RTN","PSOUTLA1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**35,186,218,259**;DEC 1997;Build 5
"RTN","PSOUTLA1",3,0)
 ;External reference to File ^PS(55 supported by DBIA 2228
"RTN","PSOUTLA1",4,0)
 ;External reference to File ^PSDRUG supported by DBIA 221
"RTN","PSOUTLA1",5,0)
 ;External reference to File ^PS(59.7 supported by DBIA 694
"RTN","PSOUTLA1",6,0)
 ;External reference to File ^PS(51 supported by DBIA 2224
"RTN","PSOUTLA1",7,0)
 ;
"RTN","PSOUTLA1",8,0)
 ;*186 - add DEACHK function
"RTN","PSOUTLA1",9,0)
 ;*218 - add REFIP function
"RTN","PSOUTLA1",10,0)
 ;*259 - reverse *218 delete restriction only warn of deleting
"RTN","PSOUTLA1",11,0)
 ;       also add del of last refill only
"RTN","PSOUTLA1",12,0)
 ;
"RTN","PSOUTLA1",13,0)
EN1 ;Formats condensed, back door sig in BSIG array
"RTN","PSOUTLA1",14,0)
 ;pass in  1) Internal Rx from 52
"RTN","PSOUTLA1",15,0)
 ;         2) max length of BSIG array
"RTN","PSOUTLA1",16,0)
 ;Returned, still condensed, in BSIG array, when looping through, check for array=null, if so, juist don't print it
"RTN","PSOUTLA1",17,0)
EN2(PSOBINTR,PSOBLGTH) ;
"RTN","PSOUTLA1",18,0)
 K BSIG
"RTN","PSOUTLA1",19,0)
 N BBSIG,BVAR,BVAR1,III,CNT,NNN,BLIM
"RTN","PSOUTLA1",20,0)
 S BBSIG=$P($G(^PSRX(PSOBINTR,"SIG")),"^") Q:BBSIG=""!($P($G(^("SIG")),"^",2))
"RTN","PSOUTLA1",21,0)
 S (BVAR,BVAR1)="",III=1
"RTN","PSOUTLA1",22,0)
 S CNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S CNT=CNT+1 D  I $L(BVAR)>PSOBLGTH S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSOUTLA1",23,0)
 .S BVAR1=$P(BBSIG," ",(CNT))
"RTN","PSOUTLA1",24,0)
 .S BLIM=BVAR
"RTN","PSOUTLA1",25,0)
 .S BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1)
"RTN","PSOUTLA1",26,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSOUTLA1",27,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSOUTLA1",28,0)
 Q
"RTN","PSOUTLA1",29,0)
 ;
"RTN","PSOUTLA1",30,0)
EN3(PSOBINTR,PSOBLGTH) ;
"RTN","PSOUTLA1",31,0)
 ;Pass in to EN3 the internal Rx number from 52, and the length of
"RTN","PSOUTLA1",32,0)
 ;the array you want. Returns expanded Sig, or warning from PSOHELP
"RTN","PSOUTLA1",33,0)
 ;concantenated with the condensed Sig in the BSIG array
"RTN","PSOUTLA1",34,0)
 ;BACK DOOR ONLY
"RTN","PSOUTLA1",35,0)
 K BSIG,X N BBSIG,BVAR,BVAR1,III,CNT,NNN,BLIM,Y,SIG,Z0,Z1,BBWARN
"RTN","PSOUTLA1",36,0)
 S BBSIG=$P($G(^PSRX(PSOBINTR,"SIG")),"^") Q:BBSIG=""!($P($G(^("SIG")),"^",2))
"RTN","PSOUTLA1",37,0)
 S (SIG,X)=BBSIG
"RTN","PSOUTLA1",38,0)
 I $E(BBSIG)=" " S BBWARN="Leading spaces are not allowed in the SIG!" G START
"RTN","PSOUTLA1",39,0)
 S SIG="" Q:$L(X)<1  F Z0=1:1:$L(X," ") G:Z0="" START S Z1=$P(X," ",Z0) D  G:'$D(X) START
"RTN","PSOUTLA1",40,0)
 .I $L(Z1)>32 S BBWARN="MAX OF 32 CHARACTERS ALLOWED BETWEEN SPACES!" K X Q
"RTN","PSOUTLA1",41,0)
 .D:$D(X)&($G(Z1)]"")  S SIG=SIG_" "_Z1
"RTN","PSOUTLA1",42,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2) Q:'$D(^(9))  S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOUTLA1",43,0)
START ;
"RTN","PSOUTLA1",44,0)
 S BBSIG=$S($G(BBWARN)="":SIG,1:BBWARN_"  "_BBSIG)
"RTN","PSOUTLA1",45,0)
 S (BVAR,BVAR1)="",III=1
"RTN","PSOUTLA1",46,0)
 S CNT=0 F NNN=1:1:$L(BBSIG) I $E(BBSIG,NNN)=" "!($L(BBSIG)=NNN) S CNT=CNT+1 D  I $L(BVAR)>PSOBLGTH S BSIG(III)=BLIM_" ",III=III+1,BVAR=BVAR1
"RTN","PSOUTLA1",47,0)
 .S BVAR1=$P(BBSIG," ",(CNT))
"RTN","PSOUTLA1",48,0)
 .S BLIM=BVAR
"RTN","PSOUTLA1",49,0)
 .S BVAR=$S(BVAR="":BVAR1,1:BVAR_" "_BVAR1)
"RTN","PSOUTLA1",50,0)
 I $G(BVAR)'="" S BSIG(III)=BVAR
"RTN","PSOUTLA1",51,0)
 I $G(BSIG(1))=""!($G(BSIG(1))=" ") S BSIG(1)=$G(BSIG(2)) K BSIG(2)
"RTN","PSOUTLA1",52,0)
 Q
"RTN","PSOUTLA1",53,0)
PATCH ;Allow sites to backfill more than what was done at install
"RTN","PSOUTLA1",54,0)
 N PSOBACKL,PSOBACKI,PSOBACKS,PSOBACKB,PSOBACKD,PSOBACKA
"RTN","PSOUTLA1",55,0)
 S PSOBACKL=$O(^PS(59.7,0)),PSOBACKI=$E($P($G(^PS(59.7,+$G(PSOBACKL),49.99)),"^",7),1,7)
"RTN","PSOUTLA1",56,0)
 I '$G(PSOBACKI) S PSOBACKI=$P($G(^PS(59.7,+$G(PSOBACKL),49.99)),"^",4)
"RTN","PSOUTLA1",57,0)
 I $G(PSOBACKI) S Y=PSOBACKI D DD^%DT S PSOBACKS=Y S X1=PSOBACKI,X2=-120 D C^%DTC S (Y,PSOBACKB)=X D DD^%DT S PSOBACKD=Y
"RTN","PSOUTLA1",58,0)
 I $G(PSOBACKD)'="" W !!,"Your CPRS/Outpatient installation date is "_$G(PSOBACKS)_","_" which",!,"means we have already backfilled all active prescriptions and all",!,"prescriptions canceled or expired after "_$G(PSOBACKD)_"."
"RTN","PSOUTLA1",59,0)
 I  W !!,"If you want to backfill orders that were canceled or expired prior to this",!,"date of "_$G(PSOBACKD)_", enter an earlier date and those orders",!,"will be backfilled to CPRS.",!
"RTN","PSOUTLA1",60,0)
 I $G(PSOBACKD)="" W !!,"We cannot determine the date of the CPRS/Outpatient installation.",!
"RTN","PSOUTLA1",61,0)
 W !,"If you choose to backfill more orders to CPRS by utilizing this option,",!,"we remind you that disk storage can be significantly affected, depending on",!,"how many orders are backfilled.",!
"RTN","PSOUTLA1",62,0)
 K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to backfill more prescriptions",DIR("?")="Enter Yes to backfill prescriptions canceled or expired before "_$G(PSOBACKD) D ^DIR K DIR I Y'=1 W ! G PATCHQ
"RTN","PSOUTLA1",63,0)
 W ! S %DT="AEPX",%DT("A")="Enter Date to begin backfill: " S:$G(PSOBACKB) %DT(0)=-PSOBACKB D ^%DT G:Y<0!($D(DTOUT)) PATCHQ S PSOBACKA=$E(Y,1,7)
"RTN","PSOUTLA1",64,0)
 W ! K ZTDTH S ZTSAVE("PSOBACKB")="",ZTSAVE("PSOBACKA")="",ZTRTN="PATCHR^PSOUTLA1",ZTDESC="BACKFILL PRSCRIPTIONS TO CPRS",ZTIO="" D ^%ZTLOAD W ! G PATCHQ
"RTN","PSOUTLA1",65,0)
PATCHR ;Begin task
"RTN","PSOUTLA1",66,0)
 N PSOPAL,PSOLPD,PSOLPRX
"RTN","PSOUTLA1",67,0)
 S PSOBACKA=PSOBACKA-.01
"RTN","PSOUTLA1",68,0)
 I '$G(PSOBACKB) S PSOBACKB=DT
"RTN","PSOUTLA1",69,0)
 F PSOPAL=0:0 S PSOPAL=$O(^PS(55,PSOPAL)) Q:'PSOPAL  F PSOLPD=PSOBACKA:0 S PSOLPD=$O(^PS(55,PSOPAL,"P","A",PSOLPD)) Q:'PSOLPD!(PSOLPD>PSOBACKB)  F PSOLPRX=0:0 S PSOLPRX=$O(^PS(55,PSOPAL,"P","A",PSOLPD,PSOLPRX)) Q:'PSOLPRX  D
"RTN","PSOUTLA1",70,0)
 .I $P($G(^PSRX(PSOLPRX,0)),"^")=""!('$P($G(^(0)),"^",2))!('$P($G(^(0)),"^",6)) Q
"RTN","PSOUTLA1",71,0)
 .I $P($G(^PSRX(PSOLPRX,"OR1")),"^",2) Q
"RTN","PSOUTLA1",72,0)
 .I '$P($G(^PSRX(PSOLPRX,0)),"^",19) D
"RTN","PSOUTLA1",73,0)
 ..I $P($G(^PSRX(PSOLPRX,"OR1")),"^")="",+$G(^PSDRUG(+$P($G(^PSRX(PSOLPRX,0)),"^",6),2)) S $P(^PSRX(PSOLPRX,"OR1"),"^")=+$G(^PSDRUG(+$P($G(^PSRX(PSOLPRX,0)),"^",6),2))
"RTN","PSOUTLA1",74,0)
 ..I $P($G(^PSRX(PSOLPRX,0)),"^",10)'="",$G(^PSRX(PSOLPRX,"SIG"))']"",'$O(^PSRX(PSOLPRX,"SIG1",0)) S ^PSRX(PSOLPRX,"SIG")=$P($G(^PSRX(PSOLPRX,0)),"^",10)_"^"_0 S $P(^PSRX(PSOLPRX,0),"^",10)=""
"RTN","PSOUTLA1",75,0)
 ..I $P($G(^PSRX(PSOLPRX,"STA")),"^")="",$P($G(^PSRX(PSOLPRX,0)),"^",15)'="" S $P(^PSRX(PSOLPRX,"STA"),"^")=$P($G(^PSRX(PSOLPRX,0)),"^",15) S $P(^PSRX(PSOLPRX,0),"^",15)=""
"RTN","PSOUTLA1",76,0)
 ..S $P(^PSRX(PSOLPRX,0),"^",19)=1
"RTN","PSOUTLA1",77,0)
 .S PSOLPSTA=$P($G(^PSRX(PSOLPRX,"STA")),"^") Q:PSOLPSTA=""!(PSOLPSTA=13)!(PSOLPSTA=10)
"RTN","PSOUTLA1",78,0)
 .D EN^PSOHLSN1(PSOLPRX,"ZC","")
"RTN","PSOUTLA1",79,0)
 .I PSOLPSTA'="",PSOLPSTA<10 D
"RTN","PSOUTLA1",80,0)
 ..I +$P($G(^PSRX(PSOLPRX,2)),"^",6),+$P($G(^(2)),"^",6)<DT S $P(^PSRX(PSOLPRX,"STA"),"^")=11,PSOLPSTA=11
"RTN","PSOUTLA1",81,0)
 .S PSOLPSTX=$S(PSOLPSTA=3:"OH",PSOLPSTA=16:"OH",PSOLPSTA=12:"OD",PSOLPSTA=15:"OD",PSOLPSTA=14:"OD",1:"SC"),PSOLPSTZ=$S(PSOLPSTA=0:"CM",PSOLPSTA=1:"IP",PSOLPSTA=4:"IP",PSOLPSTA=5:"ZS",PSOLPSTA=11:"ZE",1:"")
"RTN","PSOUTLA1",82,0)
 .D EN^PSOHLSN1(PSOLPRX,PSOLPSTX,PSOLPSTZ,"")
"RTN","PSOUTLA1",83,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOUTLA1",84,0)
PATCHQ Q
"RTN","PSOUTLA1",85,0)
 ;
"RTN","PSOUTLA1",86,0)
 ;PSO*186
"RTN","PSOUTLA1",87,0)
DEACHK(PSIRXN,PSDEA,PSDAYS,PCLOZ,PSOCS,PSMAXRF) ;Apply DEA restrictions
"RTN","PSOUTLA1",88,0)
 ;
"RTN","PSOUTLA1",89,0)
 ; If no refills allowed indicate that and set Max refills to number
"RTN","PSOUTLA1",90,0)
 ; of fills thus far, or if new order, then num of refills will not be
"RTN","PSOUTLA1",91,0)
 ; found and Max refills will be 0.
"RTN","PSOUTLA1",92,0)
 ;
"RTN","PSOUTLA1",93,0)
 ;  Function returns: 1 = no refills allowed
"RTN","PSOUTLA1",94,0)
 ;                    0 = ok to refill
"RTN","PSOUTLA1",95,0)
 ;  Input Variables: PSIRXN = internal RX number or "*"=(new order)
"RTN","PSOUTLA1",96,0)
 ;                   PSDEA  = DEA special handling for drug ordered
"RTN","PSOUTLA1",97,0)
 ;                   PSDAYS = Days supply ordered
"RTN","PSOUTLA1",98,0)
 ;                   PCLOZ  = Clozapine patient? (Optional)
"RTN","PSOUTLA1",99,0)
 ; Output Variables: PSOCS  = Controlled sub flag  (Optional)
"RTN","PSOUTLA1",100,0)
 ;                   PSMAXRF= Max Refill allowed by DEA restriction
"RTN","PSOUTLA1",101,0)
 ;                                                 (Optional)
"RTN","PSOUTLA1",102,0)
 ;
"RTN","PSOUTLA1",103,0)
 S PSIRXN=+$G(PSIRXN),PSDEA=$G(PSDEA),PSDAYS=+$G(PSDAYS)
"RTN","PSOUTLA1",104,0)
 S PSOCS=+$G(PSOCS),PSMAXRF=+$G(PSMAXRF),PCLOZ=$G(PCLOZ)
"RTN","PSOUTLA1",105,0)
 ;
"RTN","PSOUTLA1",106,0)
 ;if clozapine patient (passed in 0 or 1),  set max refills and quit
"RTN","PSOUTLA1",107,0)
 I PCLOZ=0 S PSMAXRF=0 Q 1
"RTN","PSOUTLA1",108,0)
 I PCLOZ=1 S PSMAXRF=1 Q 0
"RTN","PSOUTLA1",109,0)
 ;
"RTN","PSOUTLA1",110,0)
 ;no refills if PSDEA = 'A' & not 'B' or 'F',
"RTN","PSOUTLA1",111,0)
 I (PSDEA["A")&(PSDEA'["B")!(PSDEA["F") D  Q 1
"RTN","PSOUTLA1",112,0)
 . S PSMAXRF=$$NUMFILLS(PSIRXN)
"RTN","PSOUTLA1",113,0)
 ;
"RTN","PSOUTLA1",114,0)
 N QQ
"RTN","PSOUTLA1",115,0)
 F QQ=1:1 Q:$E(PSDEA,QQ)=""  I $E(+PSDEA,QQ)>1,$E(+PSDEA,QQ)<6 D
"RTN","PSOUTLA1",116,0)
 . S PSOCS=1
"RTN","PSOUTLA1",117,0)
 . S:$E(+PSDEA,QQ)=2 $P(PSOCS,"^",2)=1
"RTN","PSOUTLA1",118,0)
 ;
"RTN","PSOUTLA1",119,0)
 ;no refills allowed on sched 2
"RTN","PSOUTLA1",120,0)
 I $P(PSOCS,"^",2)=1 S PSMAXRF=$$NUMFILLS(PSIRXN) Q 1
"RTN","PSOUTLA1",121,0)
 ;
"RTN","PSOUTLA1",122,0)
 ;set max refill for controlled substance & other based on days supply
"RTN","PSOUTLA1",123,0)
 S PSDAYS=+$G(PSDAYS)
"RTN","PSOUTLA1",124,0)
 I PSOCS D
"RTN","PSOUTLA1",125,0)
 . S PSMAXRF=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0)
"RTN","PSOUTLA1",126,0)
 E  D
"RTN","PSOUTLA1",127,0)
 . S PSMAXRF=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0)
"RTN","PSOUTLA1",128,0)
 ;
"RTN","PSOUTLA1",129,0)
 ;get number of fills if applies & compare to Max refills
"RTN","PSOUTLA1",130,0)
 N PNFILLS S PNFILLS=$$NUMFILLS(PSIRXN)
"RTN","PSOUTLA1",131,0)
 I PNFILLS'<PSMAXRF S PSMAXRF=PNFILLS Q 1
"RTN","PSOUTLA1",132,0)
 ;
"RTN","PSOUTLA1",133,0)
 Q 0
"RTN","PSOUTLA1",134,0)
 ;
"RTN","PSOUTLA1",135,0)
NUMFILLS(PSIRXN) ;Return number of fills thus far, or 0 if doesn't apply
"RTN","PSOUTLA1",136,0)
 ; function returns: if   Active drug, then number of refills thus far
"RTN","PSOUTLA1",137,0)
 ;                   else return 0 for does not apply
"RTN","PSOUTLA1",138,0)
 ;  Input Variables: PSIRXN = internal RX number (Optional)
"RTN","PSOUTLA1",139,0)
 Q:'$G(PSIRXN) 0
"RTN","PSOUTLA1",140,0)
 N RFN,RFNC
"RTN","PSOUTLA1",141,0)
 S (RFN,RFNC)=0
"RTN","PSOUTLA1",142,0)
 F  S RFN=$O(^PSRX(PSIRXN,1,RFN)) Q:'RFN  S RFNC=RFNC+1
"RTN","PSOUTLA1",143,0)
 Q RFNC
"RTN","PSOUTLA1",144,0)
 ;
"RTN","PSOUTLA1",145,0)
REFIP(RXI,RFIL,TYP) ;Check if refill is Not Released and In Process and
"RTN","PSOUTLA1",146,0)
 ;           pending Auto Release by an external dispense machine.
"RTN","PSOUTLA1",147,0)
 ; Input: RXI = internal Prescription no.
"RTN","PSOUTLA1",148,0)
 ;        RFIL= refill number
"RTN","PSOUTLA1",149,0)
 ;        TYP ="R"-refill or "P"-partial
"RTN","PSOUTLA1",150,0)
 ; Returns 1 = In Process      (Not OK to delete)
"RTN","PSOUTLA1",151,0)
 ;         0 = Not In Process  (OK to delete)
"RTN","PSOUTLA1",152,0)
 ;
"RTN","PSOUTLA1",153,0)
 ;assumes a refill is Not In Process by the external dispense machine
"RTN","PSOUTLA1",154,0)
 ;unless it finds a record in this file and is marked to the contrary
"RTN","PSOUTLA1",155,0)
 ;
"RTN","PSOUTLA1",156,0)
 N PSIEN,IP,FOUND,EXDATA,EXDIV
"RTN","PSOUTLA1",157,0)
 S (IP,FOUND)=0,PSIEN=""
"RTN","PSOUTLA1",158,0)
 ;find first specified refill processing backwards, in case dupes
"RTN","PSOUTLA1",159,0)
 F  S PSIEN=$O(^PS(52.51,"B",RXI,PSIEN),-1) Q:PSIEN=""  D  Q:FOUND
"RTN","PSOUTLA1",160,0)
 . S EXDATA=^PS(52.51,PSIEN,0)
"RTN","PSOUTLA1",161,0)
 . I $P(EXDATA,"^",9)=RFIL D
"RTN","PSOUTLA1",162,0)
 . . S EXDIV=$P(EXDATA,"^",11)
"RTN","PSOUTLA1",163,0)
 . . Q:'$P($G(^PS(59,EXDIV,"DISP")),"^",2)     ;quit, not auto release
"RTN","PSOUTLA1",164,0)
 . . S FOUND=1
"RTN","PSOUTLA1",165,0)
 . I FOUND,$P(^PS(52.51,PSIEN,0),"^",10)'=2 S IP=1
"RTN","PSOUTLA1",166,0)
 Q IP
"RTN","PSOUTLA1",167,0)
 ;
"RTN","PSOUTLA1",168,0)
WARN1 ;partial del checks    *259
"RTN","PSOUTLA1",169,0)
 N PSR,PSOL
"RTN","PSOUTLA1",170,0)
 S PSR=0 F  S PSR=$O(^PSRX(DA(1),"P",PSR)) Q:'PSR  S PSOL=PSR
"RTN","PSOUTLA1",171,0)
 I DA=PSOL,$P(^PSRX(DA(1),"P",DA,0),"^",19) D  Q
"RTN","PSOUTLA1",172,0)
 .D EN^DDIOL("Partial Released! Use the 'Return to Stock' option!","","$C(7),!!"),EN^DDIOL(" ","","!")
"RTN","PSOUTLA1",173,0)
 ;
"RTN","PSOUTLA1",174,0)
 ;Warn of In Process, Only delete if answered Yes         ;*259
"RTN","PSOUTLA1",175,0)
 I $$REFIP^PSOUTLA1(DA(1),DA,"P") D  I 'Y Q               ;reset $T
"RTN","PSOUTLA1",176,0)
 . D EN^DDIOL("** Partial refill has previously been sent to the External Dispense Machine","","!!,?2")
"RTN","PSOUTLA1",177,0)
 . D EN^DDIOL("** for filling and is still Pending Processing","","$C(7),!,?2")
"RTN","PSOUTLA1",178,0)
 . D EN^DDIOL("","","!")
"RTN","PSOUTLA1",179,0)
 . K DIR
"RTN","PSOUTLA1",180,0)
 . S DIR("A")="Do you want to continue? "
"RTN","PSOUTLA1",181,0)
 . S DIR("B")="Y"
"RTN","PSOUTLA1",182,0)
 . S DIR(0)="YA^^"
"RTN","PSOUTLA1",183,0)
 . S DIR("?")="Enter Y for Yes or N for No."
"RTN","PSOUTLA1",184,0)
 . D ^DIR
"RTN","PSOUTLA1",185,0)
 . K DIR
"RTN","PSOUTLA1",186,0)
 Q
"VER")
8.0^22.0
"BLD",7077,6)
^227
**END**
**END**
