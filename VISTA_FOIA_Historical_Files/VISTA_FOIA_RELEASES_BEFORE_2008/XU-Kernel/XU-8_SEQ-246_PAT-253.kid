Released XU*8*253 SEQ #246
Extracted from mail message
**KIDS**:XU*8.0*253^

**INSTALL NAME**
XU*8.0*253
"BLD",610,0)
XU*8.0*253^KERNEL^0^3030428^y
"BLD",610,1,0)
^^1^1^3020917^
"BLD",610,1,1,0)
See Patch Module for a complete description.
"BLD",610,4,0)
^9.64PA^^
"BLD",610,"KRN",0)
^9.67PA^8989.52^19
"BLD",610,"KRN",.4,0)
.4
"BLD",610,"KRN",.401,0)
.401
"BLD",610,"KRN",.402,0)
.402
"BLD",610,"KRN",.403,0)
.403
"BLD",610,"KRN",.5,0)
.5
"BLD",610,"KRN",.84,0)
.84
"BLD",610,"KRN",3.6,0)
3.6
"BLD",610,"KRN",3.8,0)
3.8
"BLD",610,"KRN",9.2,0)
9.2
"BLD",610,"KRN",9.8,0)
9.8
"BLD",610,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",610,"KRN",9.8,"NM",1,0)
XQ12^^0^B55364301
"BLD",610,"KRN",9.8,"NM",2,0)
XQ84^^0^B58717207
"BLD",610,"KRN",9.8,"NM",3,0)
XQ81^^0^B72609826
"BLD",610,"KRN",9.8,"NM",4,0)
XQ75^^0^B49668487
"BLD",610,"KRN",9.8,"NM",5,0)
XQCS^^0^B34794389
"BLD",610,"KRN",9.8,"NM","B","XQ12",1)

"BLD",610,"KRN",9.8,"NM","B","XQ75",4)

"BLD",610,"KRN",9.8,"NM","B","XQ81",3)

"BLD",610,"KRN",9.8,"NM","B","XQ84",2)

"BLD",610,"KRN",9.8,"NM","B","XQCS",5)

"BLD",610,"KRN",19,0)
19
"BLD",610,"KRN",19.1,0)
19.1
"BLD",610,"KRN",101,0)
101
"BLD",610,"KRN",409.61,0)
409.61
"BLD",610,"KRN",771,0)
771
"BLD",610,"KRN",870,0)
870
"BLD",610,"KRN",8989.51,0)
8989.51
"BLD",610,"KRN",8989.52,0)
8989.52
"BLD",610,"KRN",8994,0)
8994
"BLD",610,"KRN","B",.4,.4)

"BLD",610,"KRN","B",.401,.401)

"BLD",610,"KRN","B",.402,.402)

"BLD",610,"KRN","B",.403,.403)

"BLD",610,"KRN","B",.5,.5)

"BLD",610,"KRN","B",.84,.84)

"BLD",610,"KRN","B",3.6,3.6)

"BLD",610,"KRN","B",3.8,3.8)

"BLD",610,"KRN","B",9.2,9.2)

"BLD",610,"KRN","B",9.8,9.8)

"BLD",610,"KRN","B",19,19)

"BLD",610,"KRN","B",19.1,19.1)

"BLD",610,"KRN","B",101,101)

"BLD",610,"KRN","B",409.61,409.61)

"BLD",610,"KRN","B",771,771)

"BLD",610,"KRN","B",870,870)

"BLD",610,"KRN","B",8989.51,8989.51)

"BLD",610,"KRN","B",8989.52,8989.52)

"BLD",610,"KRN","B",8994,8994)

"BLD",610,"QUES",0)
^9.62^^
"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
253^3030428^10
"PKG",3,22,1,"PAH",1,1,0)
^^1^1^3030428
"PKG",3,22,1,"PAH",1,1,1,0)
See Patch Module for a complete description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","XQ12")
0^1^B55364301
"RTN","XQ12",1,0)
XQ12 ;SEA/LUKE - MENU MANAGER UTILITIES ;11/14/2002  11:55
"RTN","XQ12",2,0)
 ;;8.0;KERNEL;**9,20,46,157,253**;Jul 10, 1995
"RTN","XQ12",3,0)
 ;
"RTN","XQ12",4,0)
DVARS ;Set up (or reset) necessary variables. From ^XQ1 and ^XQT1.
"RTN","XQ12",5,0)
 S U="^" I '$D(DUZ)#2 S DUZ=^XUTL("XQ",$J,"DUZ")
"RTN","XQ12",6,0)
 S:'$D(DUZ(0))#2 DUZ(0)="" I DUZ(0)="" S:$D(^VA(200,DUZ,0)) DUZ(0)=$P(^(0),U,4)
"RTN","XQ12",7,0)
 I '$D(DT) D ^XQDATE S DT=$P(%,".")
"RTN","XQ12",8,0)
 I '$D(DUZ("AG")),$D(^XTV(8989.3,1,0)) S DUZ("AG")=$P(^(0),U,8)
"RTN","XQ12",9,0)
 I '$D(IOS) S IOS=$S($D(^XUTL("XQ",$J,"IOS"))#2:^("IOS"),1:"")
"RTN","XQ12",10,0)
 I '$D(DTIME) S DTIME=$$DTIME^XUP(DUZ,IOS)
"RTN","XQ12",11,0)
 I '$D(DUZ("AUTO")) S I=$S($D(^VA(200,DUZ,200)):$P(^(200),U,6),1:"") S:'$L(I) I=$S($D(^%ZIS(1,$I,"XUS")):$P(^("XUS"),U,6),1:"") S:'$L(I) I=$S($D(^XTV(8989.3,1,"XUS")):$P(^("XUS"),U,6),1:"") S:'$L(I) I=1 S DUZ("AUTO")=I
"RTN","XQ12",12,0)
 Q
"RTN","XQ12",13,0)
 ;
"RTN","XQ12",14,0)
INIT ;Entry for new logon, called from the top of ^XQ and ^XQ1
"RTN","XQ12",15,0)
 K DIC,Y Q:$D(DUZ)[0  Q:'$D(^VA(200,DUZ,0))
"RTN","XQ12",16,0)
 ;S:'$D(XQY) XQY=^VA(200,DUZ,201)
"RTN","XQ12",17,0)
 I '$D(XQUSER) S XQUSER=$P($P(^VA(200,DUZ,0),U),",",2)_" "_$P($P(^(0),U),",")
"RTN","XQ12",18,0)
 ;
"RTN","XQ12",19,0)
 ;Select device tied option, primary menu, or primary window
"RTN","XQ12",20,0)
 ;
"RTN","XQ12",21,0)
 S:'$D(XQY) XQY=""
"RTN","XQ12",22,0)
 S %=$G(^VA(200,DUZ,201)),^XUTL("XQ",$J,"XQM")=+%,^("XQW")=$P(%,"^",2)
"RTN","XQ12",23,0)
 D:'$D(IO) HOME^%ZIS
"RTN","XQ12",24,0)
 I IO]"" S %=$G(^%ZIS(1,IO,201)) I %]"" S XQY=%
"RTN","XQ12",25,0)
 I XQY']"" D
"RTN","XQ12",26,0)
 .S %=$G(^VA(200,DUZ,201))
"RTN","XQ12",27,0)
 .S XQPM=$P(%,U),XQPW=$P(%,U,2),XQSD=$P(%,U,3)
"RTN","XQ12",28,0)
 .I XQPW']"" S XQY=XQPM Q
"RTN","XQ12",29,0)
 .I XQSD="M" S XQY=XQPM
"RTN","XQ12",30,0)
 .E  S XQY=XQPW
"RTN","XQ12",31,0)
 .Q
"RTN","XQ12",32,0)
 ;
"RTN","XQ12",33,0)
 D SET^XQCHK
"RTN","XQ12",34,0)
 S ^XUTL("XQ",$J,1)=XQY_"P"_XQY_"^"_XQY0,^("T")=1
"RTN","XQ12",35,0)
 S XQDIC=XQY,XQPSM="P"_XQY
"RTN","XQ12",36,0)
 ;
"RTN","XQ12",37,0)
 ;D MERGE,MGPXU,MGSEC ;get the menu trees this user will need to jump
"RTN","XQ12",38,0)
 ;
"RTN","XQ12",39,0)
 ;Fire LOGIN menu template if they have one and its the first login
"RTN","XQ12",40,0)
 ;of the day.  XQXFLG("LLOG") is copy of ^VA(200,DUZ,1.1) before it's
"RTN","XQ12",41,0)
 ;updated at XUS1+47
"RTN","XQ12",42,0)
 I $D(^VA(200,DUZ,19.8,"B","LOGIN")) D
"RTN","XQ12",43,0)
 .Q:'$D(XQXFLG("LLOG"))
"RTN","XQ12",44,0)
 .S XQLAST=$P($P(XQXFLG("LLOG"),U),".") ;Get last login DT
"RTN","XQ12",45,0)
 .Q:+XQLAST<1
"RTN","XQ12",46,0)
 .I XQLAST<DT S XQUR="[LOGIN",XQJS=3
"RTN","XQ12",47,0)
 .K XQLAST
"RTN","XQ12",48,0)
 .Q
"RTN","XQ12",49,0)
 K XQXFLG("LLOG")
"RTN","XQ12",50,0)
 ;
"RTN","XQ12",51,0)
UI ;Entry for TaskMan (DUZ may =  0), from ZTSK^XQ1
"RTN","XQ12",52,0)
 D DVARS I '$D(^XUTL("XQ",$J,0)) D ^XQDATE S ^XUTL("XQ",$J,0)=%_U_%Y
"RTN","XQ12",53,0)
 S:'$D(XQDIC) XQDIC="P"_XQY
"RTN","XQ12",54,0)
 S:'$D(XQPSM) XQPSM="P"_XQY
"RTN","XQ12",55,0)
 S:'$D(XQJS)&'$D(ZTQUEUED) XQY0=^DIC(19,XQY,0),^XUTL("XQ",$J,"T")=0,^("DUZ")=DUZ,^("XQM")=XQY,XQPSM="P"_XQY
"RTN","XQ12",56,0)
 S XQCY=XQY D ^XQCHK I XQCY<1 D
"RTN","XQ12",57,0)
 .S XQPRMN=1,XQL=0
"RTN","XQ12",58,0)
 .D:'$D(ZTQUEUED) MES^XQCHK,PAUSE^XQ6
"RTN","XQ12",59,0)
 .;G:'$D(ZTQUEUED) ^XUSCLEAN S XQY=-1
"RTN","XQ12",60,0)
 .S XQY=-1
"RTN","XQ12",61,0)
 .Q
"RTN","XQ12",62,0)
 S XQM3="" I $P(XQY0,U,4)'="A",$P(XQY0,U,14),$D(^DIC(19,XQY,20)),$L(^(20)) X ^(20) ;W "  ==> XQ12+59"
"RTN","XQ12",63,0)
 ;I $D(XQUIT),'$D(ZTQUEUED) S XQL=0 W !!,"The variable XQUIT was encountered in the Entry Action of your Primary Menu." D PAUSE^XQ6 S XQY=-1 G ^XUSCLEAN
"RTN","XQ12",64,0)
 I $D(XQUIT),'$D(ZTQUEUED) D PM^XQUIT I $D(XQUIT) S XQY=-1 G ^XUSCLEAN
"RTN","XQ12",65,0)
 ;I $P(XQY0,U,17),$D(^DIC(19,XQY,26)),$L(^(26)) X ^(26)
"RTN","XQ12",66,0)
ABT ;WARNING: XQXFLG is also used by OERR test sites.
"RTN","XQ12",67,0)
 S U="^"
"RTN","XQ12",68,0)
 S $P(XQXFLG,U)=$S($O(^XTV(8989.3,1,"ABPKG",0))>0:1,1:0)
"RTN","XQ12",69,0)
CMP S $P(XQXFLG,U,2)=$S('$D(^XTV(8989.3,1,"XUCP")):0,1:^("XUCP")="Y")
"RTN","XQ12",70,0)
 K %,%Y,PGM,X,XQCY,XQPM,XQPXU,XQPW,XQSD
"RTN","XQ12",71,0)
 Q
"RTN","XQ12",72,0)
 ;
"RTN","XQ12",73,0)
 ;
"RTN","XQ12",74,0)
MERGE ;Merge in the menu trees that this user needs, start with Primary Menu
"RTN","XQ12",75,0)
 Q:'$D(^DIC(19,"AXQ",XQPSM))
"RTN","XQ12",76,0)
 I $D(^XUTL("XQMERGED",XQPSM)) D OLDF(XQPSM)
"RTN","XQ12",77,0)
 Q:$D(^XUTL("XQMERGED",XQPSM))  ;It's already being done
"RTN","XQ12",78,0)
 ;
"RTN","XQ12",79,0)
 L +^XUTL("XQO",XQPSM):0 Q:'$T
"RTN","XQ12",80,0)
 S ^XUTL("XQMERGED",XQPSM)=$H
"RTN","XQ12",81,0)
 ;
"RTN","XQ12",82,0)
 K ^XUTL("XQO",XQPSM)
"RTN","XQ12",83,0)
 M ^XUTL("XQO",XQPSM)=^DIC(19,"AXQ",XQPSM)
"RTN","XQ12",84,0)
 ;
"RTN","XQ12",85,0)
 L -^DIC(19,"AXQ",XQPSM)
"RTN","XQ12",86,0)
 K ^XUTL("XQMERGED",XQPSM)
"RTN","XQ12",87,0)
 Q
"RTN","XQ12",88,0)
 ;
"RTN","XQ12",89,0)
MGPXU ;Check for XUCOMMAND
"RTN","XQ12",90,0)
 Q:'$D(^DIC(19,"AXQ","PXU"))
"RTN","XQ12",91,0)
 I $D(^XUTL("XQMERGED","PXU")) D OLDF("PXU")
"RTN","XQ12",92,0)
 Q:$D(^XUTL("XQMERGED","PXU"))  ;Already being merged
"RTN","XQ12",93,0)
 ;
"RTN","XQ12",94,0)
 L +^XUTL("XQO","PXU"):0 Q:'$T
"RTN","XQ12",95,0)
 S ^XUTL("XQMERGED","PXU")=$H
"RTN","XQ12",96,0)
 ;
"RTN","XQ12",97,0)
 K ^XUTL("XQO","PXU")
"RTN","XQ12",98,0)
 M ^XUTL("XQO","PXU")=^DIC(19,"AXQ","PXU")
"RTN","XQ12",99,0)
 ;
"RTN","XQ12",100,0)
 L -^DIC(19,"AXQ","PXU")
"RTN","XQ12",101,0)
 K ^XUTL("XQMERGED","PXU")
"RTN","XQ12",102,0)
 Q
"RTN","XQ12",103,0)
 ;
"RTN","XQ12",104,0)
MGSEC ;Now the Secondary Menu trees
"RTN","XQ12",105,0)
 N %,%1
"RTN","XQ12",106,0)
 F %=0:0 S %=$O(^VA(200,DUZ,203,"B",%)) Q:%'=+%  D
"RTN","XQ12",107,0)
 .S %1="P"_%
"RTN","XQ12",108,0)
 .I '$D(^XUTL("XQO",%1)),$D(^DIC(19,"AXQ",%1)) D
"RTN","XQ12",109,0)
 ..I $D(^XUTL("XQMERGED",%1)) D OLDF(%1)
"RTN","XQ12",110,0)
 ..Q:$D(^XUTL("XQMERGED",%1))  ;Already merging as we speak
"RTN","XQ12",111,0)
 ..S ^XUTL("XQMERGED",%1)=$H
"RTN","XQ12",112,0)
 ..L +^XUTL("XQO",%1):0 Q:'$T
"RTN","XQ12",113,0)
 ..I '$D(^XUTL("XQO",%1)) D
"RTN","XQ12",114,0)
 ...K ^XUTL("XQO",%1)
"RTN","XQ12",115,0)
 ...M ^XUTL("XQO",%1)=^DIC(19,"AXQ",%1)
"RTN","XQ12",116,0)
 ...Q
"RTN","XQ12",117,0)
 ..L -^DIC(19,"AXQ",%1)
"RTN","XQ12",118,0)
 ..K ^XUTL("XQMERGED",%1)
"RTN","XQ12",119,0)
 ..Q
"RTN","XQ12",120,0)
 .Q
"RTN","XQ12",121,0)
 Q
"RTN","XQ12",122,0)
 ;
"RTN","XQ12",123,0)
OLDF(X) ;See if this flag is au current, if not KILL it
"RTN","XQ12",124,0)
 ;X is the P name of the tree, e.g., P9 might be EVE
"RTN","XQ12",125,0)
 S:'$D(XQPXU) XQPXU=$G(^DIC(19,"AXQ","PXU",0))
"RTN","XQ12",126,0)
 I XQPXU="" S XQPXU=$H ;Assume it's rebuilding now
"RTN","XQ12",127,0)
 N Y,Z
"RTN","XQ12",128,0)
 S Y=$G(^XUTL("XQMERGED",X)) Q:Y=""  ;Flag's gone
"RTN","XQ12",129,0)
 S Z=$$HDIFF^XLFDT(XQPXU,Y,2)
"RTN","XQ12",130,0)
 I Z<3600 K ^XUTL("XQMERGED",X) ;Old Flag
"RTN","XQ12",131,0)
 Q
"RTN","XQ12",132,0)
 ;
"RTN","XQ12",133,0)
LOGOPT ;Option audit
"RTN","XQ12",134,0)
 S:'$D(XQLTL) XQLTL=""
"RTN","XQ12",135,0)
 S %=$P($H,",",2),%=DT_(%\60#60/100+(%\3600)+(%#60/10000)/100)
"RTN","XQ12",136,0)
 I XQLTL S $P(^XUSEC(19,XQLTL,0),U,5)=%,XQLTL=0
"RTN","XQ12",137,0)
 S I=1 I XQAUDIT'=1 S I=0 F J=1:2 S K1=$P(XQAUDIT,U,J),K2=$P(XQAUDIT,U,J+1) Q:'$L(K1)!I  I K1=2&(K2=XQY)!(K1=3&($E($P(XQY0,U,1),1,$L(K2))=K2)) S I=1
"RTN","XQ12",138,0)
 Q:'I  S XQLTL=% L +^XUSEC(19,0):0 S %=^XUSEC(19,0),XQLTL=XQLTL+(.00000001*$S(XQLTL'=$E($P(%,U,3),1,14):10,1:$E($P(%,U,3),15,16)+1)),$P(^(0),U,3,4)=XQLTL_"^"_($P(%,U,4)+1) L -^XUSEC(19,0)
"RTN","XQ12",139,0)
 D GETENV^%ZOSV S XUVOL=$P(Y,U,2),^XUSEC(19,XQLTL,0)=XQY_U_DUZ_U_$I_U_$J_"^^"_XUVOL
"RTN","XQ12",140,0)
 K K1,K2
"RTN","XQ12",141,0)
 Q
"RTN","XQ12",142,0)
XPRMP D CHK^XM W !!,"Do you really want to ",$S(XQUR="REST":"restart",1:"halt"),"? YES// " R X:10 S:'$L(X) X="Y"
"RTN","XQ12",143,0)
 I "Yy"'[$E(X) S Y=1 S:^XUTL("XQ",$J,"T")>1 Y=^("T")-1 S ^("T")=Y,Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_" Option: " W ! G ASK^XQ
"RTN","XQ12",144,0)
 G REST:XQUR="REST",HALT:XQUR'="CON"
"RTN","XQ12",145,0)
 ;
"RTN","XQ12",146,0)
CON ;Continue option logic.  Enter from ASK^XQ on timeout.
"RTN","XQ12",147,0)
 W !!,"Do you want to halt and continue with this option later? YES// " R XQUR:20 S:(XQUR="")!('$T) XQUR="Y"
"RTN","XQ12",148,0)
 I "YyNn"'[$E(XQUR,1) W !!,"   If you enter 'Y' or 'RETURN' you will halt and continue here next time",!,"    you logon to the computer.",!,"   If you enter 'N' you will resume processing where you were." G CON
"RTN","XQ12",149,0)
 I "Nn"[$E(XQUR,1) W ! S XQUR=0,Y=^XUTL("XQ",$J,"T"),Y=^(Y),XQY0=$P(Y,U,2,99),XQPSM=$P(Y,U,1),(XQY,XQDIC)=+XQPSM,XQPSM=$P(XQPSM,XQY,2,3),XQAA="Select "_$P(XQY0,U,2)_" Option: " G ASK^XQ
"RTN","XQ12",150,0)
 S X=^XUTL("XQ",$J,^XUTL("XQ",$J,"T")),Y=^("XQM") I (+X'=+Y) S XQM="P"_+Y S XQPSM=$S($D(^XUTL("XQO",XQM,"^",+X)):XQM,$D(^XUTL("XQO","PXU","^",+X)):"PXU",1:"") D:XQPSM="" SS S:XQPSM'="" ^VA(200,DUZ,202.1)=+X_XQPSM
"RTN","XQ12",151,0)
 S X=$P($H,",",2),X=(X>41400&(X<46800))
"RTN","XQ12",152,0)
 W !!,$P("HMM^OK^ALL RIGHT^WELL CERTAINLY^FINE","^",$R(5)+1),"... ",$P("SEE YOU LATER^I'LL BE READY WHEN YOU ARE.^HURRY BACK!^HAVE A GOOD LUNCH BREAK!","^",$R(3)+X+1)
"RTN","XQ12",153,0)
HALT ;
"RTN","XQ12",154,0)
 G H^XUS
"RTN","XQ12",155,0)
REST S XQNOHALT=1 D ^XUSCLEAN G ^XUS
"RTN","XQ12",156,0)
 ;
"RTN","XQ12",157,0)
SS ;Search Secondaries for a particuloar option.
"RTN","XQ12",158,0)
 Q:'$D(^VA(200,DUZ,203,0))  Q:$P(^VA(200,DUZ,203,0),U,4)<1
"RTN","XQ12",159,0)
 S Y=0 F XQI=1:1 Q:XQPSM'=""  S Y=$O(^VA(200,DUZ,203,Y)) Q:Y'>0  S %=^(Y,0) I $D(^XUTL("XQO","P"_%,"^",+X)) S XQPSM="U"_DUZ_",P"_%
"RTN","XQ12",160,0)
 Q
"RTN","XQ12",161,0)
ABLOG S %2=0 F %3=0:0 S %2=$O(^XTV(8989.3,1,"ABPKG",%2)) Q:%2'>0  F %=0:0 S %=$O(^XTV(8989.3,1,"ABPKG",%2,1,%)) Q:%'>0  S %1=$P(^(%,0),U) I $E(XQY0,1,$L(%1))=%1,$E(XQY0,$L(%1)+1)'="Z" D ABLOG1
"RTN","XQ12",162,0)
 K %,%1,%2,%3,%4
"RTN","XQ12",163,0)
 Q
"RTN","XQ12",164,0)
ABLOG1 F %4=0:0 S %4=$O(^XTV(8989.3,1,"ABPKG",%2,1,%,1,%4)) Q:%4'>0  S %1=$P(^(%4,0),U) I $E(XQY0,1,$L(%1))=%1 Q
"RTN","XQ12",165,0)
 I %4'>0 S:'$D(^XTV(8989.3,1,"ABOPT",0)) ^(0)="^8989.333P^" S:'$D(^(XQY)) %4=+$P(^(0),U,3),$P(^(0),U,3,4)=$S(XQY>%4:XQY,1:%4)_U_($P(^(0),U,4)+1) S ^(0)=XQY_U_($S($D(^(XQY,0)):$P(^(0),U,2),1:0)+1),%2="A"
"RTN","XQ12",166,0)
 Q
"RTN","XQ75")
0^4^B49668487
"RTN","XQ75",1,0)
XQ75 ;SEA/AMF,LUKE,JLI - Lookup response for jumps ;09/17/2002  12:51
"RTN","XQ75",2,0)
 ;;8.0;KERNEL;**47,46,157,253**;Jul 10, 1995
"RTN","XQ75",3,0)
 ;Enter at S with XQUR. Exit with XQY set to the chosen option #,
"RTN","XQ75",4,0)
 ;with array of possibilities in XQ(XQ):XQY^menu txt [name]^XQPSM
"RTN","XQ75",5,0)
 ;XQXT(XQXT) similarly built, holds exact matches
"RTN","XQ75",6,0)
 ;XQY=-1 (no option found), or XQY=-2 (jumps shut down).
"RTN","XQ75",7,0)
 ;
"RTN","XQ75",8,0)
X ;Unless exact match is found, find all possibilities in any XQDIC
"RTN","XQ75",9,0)
 S XQO=$O(^XUTL("XQO",XQDIC,XQO)) Q:'$S(XQO="":0,XQUR="?":XQO'="^",XQUR=0_$C(1):'$L($P(XQO,"0",1)),1:'$L($P(XQO,XQUR,1)))
"RTN","XQ75",10,0)
 S XQYY=^XUTL("XQO",XQDIC,XQO) S XQY=+XQYY G:$D(XQ("X",+XQY)) X S %=$G(^XUTL("XQO",XQDIC,"^",+XQY)) G:%="" X S XQY0=$P(%,U,2,99)
"RTN","XQ75",11,0)
 S XQCY=XQY,XQCY0=XQY0 D ^XQCHK I XQCY<0 S XQY=0 G X
"RTN","XQ75",12,0)
 S:'$P(XQYY,U,2) XQ("S",+XQY)=$P(XQO,U)
"RTN","XQ75",13,0)
 I XQUR=$P(XQO,U),'XQS S XQXT=XQXT+1,XQXT(XQXT)=+XQY_U_$P(XQY0,U,2)_"  ["_$P(XQY0,U)_"] "_U_$S($D(XQUD):XQUD_",",1:"")_XQDIC,XQXT("X",XQY)="" S:'$P(XQYY,U,2) XQXT("S",+XQY)=$P(XQO,U)
"RTN","XQ75",14,0)
 S XQ=XQ+1,XQ1=XQ1+1,XQ(XQ)=+XQY_U_$P(XQY0,U,2)_"  ["_$P(XQY0,U)_"] "_U_$S($D(XQUD):XQUD_",",1:"")_XQDIC,XQ("X",XQY)=""
"RTN","XQ75",15,0)
 I XQ1>19,'XQXT D C
"RTN","XQ75",16,0)
 Q:XQY<0!(XQUR="")  G X
"RTN","XQ75",17,0)
 Q
"RTN","XQ75",18,0)
 ;
"RTN","XQ75",19,0)
C ;Display a screen-load of 19 possibilities and ask for a choice
"RTN","XQ75",20,0)
 ;I $G(XQXFLG("GUI")) D  Q
"RTN","XQ75",21,0)
 ;.D LIST^XQGS1(XQ)
"RTN","XQ75",22,0)
 ;.S XQUR=""
"RTN","XQ75",23,0)
 ;.Q:XQY<0
"RTN","XQ75",24,0)
 ;.S %="" F  S %=$O(XQ(%)) Q:%=""!(%'=+%)  I XQY=+XQ(%) S XQPSM=$P(XQ(%),U,3)
"RTN","XQ75",25,0)
 ;.Q
"RTN","XQ75",26,0)
 S:XQ1<1 XQ1=XQ W ! F XQI=1:1:XQ1 S XQJ=XQS*20+XQI W !?4,XQJ,?9,$P(XQ(XQJ),U,2) I $D(XQ("S",+XQ(XQJ))) W ?43,"  (",XQ("S",+XQ(XQJ)),")"
"RTN","XQ75",27,0)
ASK W !!,"Type '^' to stop, or choose a number from 1 to ",XQ," :"
"RTN","XQ75",28,0)
 R XQJ:DTIME S:'$T XQJ=U W:XQJ["?" !!,"**> Choose an item from this list by selecting its corresponding number,",!?5,"or type a '^' to return to your menu.",! G:XQJ["?" ASK
"RTN","XQ75",29,0)
 I XQJ=U S XQY=-1,XQ=0 Q
"RTN","XQ75",30,0)
 I XQJ'?1N.N,$L(XQJ),XQJ'=U W $C(7),"  ??",! G ASK
"RTN","XQ75",31,0)
 I XQJ?1N.N G C:'$D(XQ(XQJ)) D  Q:$D(XQ(+XQJ))
"RTN","XQ75",32,0)
 .N %,XQD,XQP,Y
"RTN","XQ75",33,0)
 .S %=XQ(XQJ),Y=+% I Y>0 D
"RTN","XQ75",34,0)
 ..S XQP=$P(%,U,3),XQD=$S($L(XQP,",")>1:$P(XQP,",",$L(XQP,",")),1:XQP)
"RTN","XQ75",35,0)
 ..S XQY0=$G(^XUTL("XQO",XQD,"^",Y)),XQY0=$P(XQY0,U,2,99)
"RTN","XQ75",36,0)
 ..I XQY0="" K XQ(XQJ) S XQ=XQ-1,XQJ="" Q
"RTN","XQ75",37,0)
 .I $L(XQJ),$D(XQ(XQJ)) S XQY=Y,XQDIC=XQD,XQPSM=XQP,XQUR="" W "  " Q
"RTN","XQ75",38,0)
 .Q
"RTN","XQ75",39,0)
 I XQJ?1N.N W $C(7),$P(XQ(XQJ-1#20+1),U,4),! G C
"RTN","XQ75",40,0)
 I '$L(XQJ),XQ1'<20 S XQS=XQS+1,XQ1=0 Q
"RTN","XQ75",41,0)
 I '$L(XQJ),XQ1<20 S XQY=-1,XQ=0 Q
"RTN","XQ75",42,0)
 I '$D(XQ(XQJ)) G C
"RTN","XQ75",43,0)
 K XQ S XQY=$S(XQJ=U:-3,XQJ="":-3,1:-1),XQUR=$C(95) S:XQJ=U XQJ="",XQY=-1 S:$L(XQJ) XQUR=$S($E(XQDIC,1)="P":U_XQJ,1:XQJ),XQY=0 Q
"RTN","XQ75",44,0)
 Q
"RTN","XQ75",45,0)
 ;
"RTN","XQ75",46,0)
S ;Entry from XQ: Search primary, common, and secondary menus for XQUR
"RTN","XQ75",47,0)
 I XQUR'?.ANP W $C(7) S XQY=-1 Q
"RTN","XQ75",48,0)
 I XQPSM'="PXU" S XQDIC=$S($D(XQPSM):$P(XQPSM,"P",2),$D(XQDIC):XQDIC,1:XQY)
"RTN","XQ75",49,0)
 E  S XQDIC="PXU"
"RTN","XQ75",50,0)
 I '$D(XQTT) S XQTT=$G(^XUTL("XQ",$J,"T")) I XQTT="" S XQTT=1
"RTN","XQ75",51,0)
 ;S:'$D(XQDIC) XQDIC=XQY S XQSV=XQY_U_XQDIC_U_XQY0
"RTN","XQ75",52,0)
 S XQJ="",XQJMP=1,(XQ,XQ1,XQS,XQXT,XQY)=0
"RTN","XQ75",53,0)
 S XQO=$E(XQUR,1,30) I XQUR'?.PUN S XQO=$$UP^XLFSTR(XQO) ;F XQI=1:1 Q:XQO?.NUP  S XQO1=$A(XQO,XQI) I XQO1<123,XQO1>96 S XQO=$E(XQO,1,XQI-1)_$C(XQO1-32)_$E(XQO,XQI+1,255)
"RTN","XQ75",54,0)
 S XQUR=XQO,(XQO,XQO1)=$E(XQUR,1,$L(XQUR)-1)_$C($A($E(XQUR,$L(XQUR)))-1)_"z"
"RTN","XQ75",55,0)
 I '$D(^XUTL("XQ",$J,"XQM")) S ^("XQM")=+^VA(200,DUZ,201)
"RTN","XQ75",56,0)
 ;I '$D(^XUTL("XQ",$J,"XQW")) S ^("XQW")=$P(^VA(200,DUZ,201),U,2)
"RTN","XQ75",57,0)
 I $D(XQJS),XQJS G OUT
"RTN","XQ75",58,0)
 ;
"RTN","XQ75",59,0)
 ;Check the Primary Menu first
"RTN","XQ75",60,0)
 S XQDIC="P"_^XUTL("XQ",$J,"XQM")
"RTN","XQ75",61,0)
 ;If there's no master copy in ^DIC(19,"AXQ"), nothing to do.
"RTN","XQ75",62,0)
 I '$D(^DIC(19,"AXQ",XQDIC,0)) D REACT^XQ84(DUZ) S XQY=-1 G OUT
"RTN","XQ75",63,0)
 I '$D(^XUTL("XQO",XQDIC,0)) S XQSAVE=XQPSM,XQPSM=XQDIC D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",64,0)
 S XQXUTL=$G(^XUTL("XQO",XQDIC,0)),XQDIC19=^DIC(19,"AXQ",XQDIC,0)
"RTN","XQ75",65,0)
 I XQXUTL="" S XQXUTL=XQDIC19
"RTN","XQ75",66,0)
 S %=$$HDIFF^XLFDT(XQDIC19,XQXUTL,2) I %>30 S XQSAVE=XQPSM,XQPSM=XQDIC D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",67,0)
 ;If tree is not there or out of date, remerge it
"RTN","XQ75",68,0)
 D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",69,0)
 ;
"RTN","XQ75",70,0)
 ;Look in XUCOMMAND
"RTN","XQ75",71,0)
 S XQDIC="PXU"
"RTN","XQ75",72,0)
 ;I $S('$D(^XUTL("XQO",XQDIC,0)):1,^XUTL("XQO",XQDIC,0)'=^DIC(19,"AXQ",XQDIC,0):1,1:0) D MGPXU^XQ12
"RTN","XQ75",73,0)
 I '$D(^XUTL("XQO",XQDIC,0)) D MGPXU^XQ12
"RTN","XQ75",74,0)
 S XQXUTL=$G(^XUTL("XQO",XQDIC,0)),XQDIC19=^DIC(19,"AXQ",XQDIC,0)
"RTN","XQ75",75,0)
 I XQXUTL="" S XQXUTL=XQDIC19
"RTN","XQ75",76,0)
 S %=$$HDIFF^XLFDT(XQDIC19,XQXUTL,2) I %>30 D MGPXU^XQ12
"RTN","XQ75",77,0)
 S XQO=XQO1 D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",78,0)
 ;
"RTN","XQ75",79,0)
 ;Check the top level of the Secondaries
"RTN","XQ75",80,0)
 S XQDIC="U"_DUZ,XQO=XQO1 D:$S('$D(^XUTL("XQO",XQDIC,0)):1,'$D(^VA(200,DUZ,203.1)):1,1:^VA(200,DUZ,203.1)'=$P(^XUTL("XQO",XQDIC,0),U,2)) ^XQSET I '$D(^XUTL("XQO",XQDIC,0)),'XQXT D C G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",81,0)
 D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",82,0)
 ;
"RTN","XQ75",83,0)
 ;Check each secondary in depth
"RTN","XQ75",84,0)
 F XQK=0:0 Q:XQY<0!(XQUR="")  S XQUD="U"_DUZ,XQK=$O(^XUTL("XQO",XQUD,U,XQK)) Q:XQK=""  D
"RTN","XQ75",85,0)
 .S XQCY=XQK D ^XQCHK I XQCY>0,$P(^XUTL("XQO",XQUD,U,XQK),U,5)="M" D
"RTN","XQ75",86,0)
 ..N XQSAVE
"RTN","XQ75",87,0)
 ..S XQST=XQK,XQDIC="P"_XQK,XQO=XQO1
"RTN","XQ75",88,0)
 ..I '$D(^DIC(19,"AXQ","P0")) D
"RTN","XQ75",89,0)
 ...I '$D(^XUTL("XQO",XQDIC,0)) S XQSAVE=XQPSM D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",90,0)
 ...S XQXUTL=$G(^XUTL("XQO",XQDIC,0)),XQDIC19=$G(^DIC(19,"AXQ",XQDIC,0))
"RTN","XQ75",91,0)
 ...Q:XQDIC19=""  ;Nothing to merge, probably a new scondary
"RTN","XQ75",92,0)
 ...I XQXUTL="" S XQXUTL=XQDIC19
"RTN","XQ75",93,0)
 ...S %=$$HDIFF^XLFDT(XQDIC19,XQXUTL,2) I %>30 S XQSAVE=XQPSM,XQPSM=XQDIC D MERGE^XQ12 S XQPSM=XQSAVE
"RTN","XQ75",94,0)
 ...Q
"RTN","XQ75",95,0)
 ..D X Q:XQY<0!(XQUR="")
"RTN","XQ75",96,0)
 ..Q
"RTN","XQ75",97,0)
 .Q
"RTN","XQ75",98,0)
 G:XQY<0 OUT
"RTN","XQ75",99,0)
 G:XQUR="" W
"RTN","XQ75",100,0)
 ;
"RTN","XQ75",101,0)
 I XQXT K XQ S (XQ,XQ1)=XQXT F XQI=1:1:XQ S XQ(XQI)=XQXT(XQI),%=+XQ(XQI),XQ("X",%)="" I $D(XQXT("S",%)) S XQ("S",%)=XQXT("S",%)
"RTN","XQ75",102,0)
 ;
"RTN","XQ75",103,0)
 I XQ=1,XQS=0 D
"RTN","XQ75",104,0)
 .N X
"RTN","XQ75",105,0)
 .S %=XQ(1),XQY=+%,XQPSM=$P(%,U,3)
"RTN","XQ75",106,0)
 .S XQDIC=$S($L(XQPSM,",")>1:$P(XQPSM,",",$L(XQPSM,",")),1:XQPSM)
"RTN","XQ75",107,0)
 .S X=$G(^XUTL("XQO",XQDIC,U,XQY))
"RTN","XQ75",108,0)
 .I X="" S X=$G(^DIC(19,"AXQ",XQDIC,U,XQY))
"RTN","XQ75",109,0)
 .Q:X=""
"RTN","XQ75",110,0)
 .S XQY0=$P(X,U,2,99),XQSFLG=""
"RTN","XQ75",111,0)
 .Q
"RTN","XQ75",112,0)
 I $D(XQSFLG) K XQSFLG G W
"RTN","XQ75",113,0)
 ;
"RTN","XQ75",114,0)
 I XQ>0,'$D(XQ(XQS*20+1)) S XQY=-1 G OUT
"RTN","XQ75",115,0)
 D:XQ>0 C G:XQY<0 OUT I XQ=0 S XQY=-1 G OUT
"RTN","XQ75",116,0)
 ;
"RTN","XQ75",117,0)
W ;Write out remaining text and return to XQ
"RTN","XQ75",118,0)
 ;G:$D(XQXFLG("GUI")) OUT
"RTN","XQ75",119,0)
 I $D(XQ("S",+XQY)),XQUR=$E(XQ("S",+XQY),1,$L(XQUR)) W $E(XQ("S",+XQY),$L(XQUR)+1,99),"   ",$P(XQY0,U,2)
"RTN","XQ75",120,0)
 E  W $E($P(XQY0,U,2),$L(XQUR)+1,99) W:$D(XQ("S",+XQY)) "   (",XQ("S",+XQY),")"
"RTN","XQ75",121,0)
 ;
"RTN","XQ75",122,0)
OUT ;Exit here
"RTN","XQ75",123,0)
 K XQ
"RTN","XQ75",124,0)
 N % S XQ=""
"RTN","XQ75",125,0)
 I XQY>0,$D(^XUTL("XQO",XQDIC,"^",+XQY,0)) D
"RTN","XQ75",126,0)
 .S %=$G(^XUTL("XQO",XQDIC,"^",+XQY,0)) I %="" D
"RTN","XQ75",127,0)
 ..H 1 ;Micro surgery must have it wait a sec
"RTN","XQ75",128,0)
 ..S %=$G(^XUTL("XQO",XQDIC,"^",+XQY,0))
"RTN","XQ75",129,0)
 ..Q
"RTN","XQ75",130,0)
 .Q:%=""
"RTN","XQ75",131,0)
 .S:%>0 XQ=+%
"RTN","XQ75",132,0)
 .F XQI=1:1:XQ D
"RTN","XQ75",133,0)
 ..S %=$G(^XUTL("XQO",XQDIC,"^",XQY,0,XQI)) I %="" D
"RTN","XQ75",134,0)
 ...H 1
"RTN","XQ75",135,0)
 ...S %=$G(^XUTL("XQO",XQDIC,"^",XQY,0,XQI))
"RTN","XQ75",136,0)
 ...Q
"RTN","XQ75",137,0)
 ..I %]"" S XQ(XQI)=$P(%,U)
"RTN","XQ75",138,0)
 ..Q
"RTN","XQ75",139,0)
 .Q
"RTN","XQ75",140,0)
 I XQ="" S XQ=0
"RTN","XQ75",141,0)
 ;I XQY=-1,'$D(XQHLP) W $C(7),"  ??" S XQY=+XQSV,XQDIC=$P(XQSV,U,2),XQY0=$P(XQSV,U,3,99),XQUR=""
"RTN","XQ75",142,0)
 ;
"RTN","XQ75",143,0)
 K %,I,J,X,XQ1,XQAP,XQCY,XQCY0,XQDIC19,XQI,XQJ,XQJMP,XQK,XQO,XQO1,XQS,XQST,XQUD,XQXT,XQXUTL,XQYY,Y
"RTN","XQ75",144,0)
 K XQ
"RTN","XQ75",145,0)
 Q
"RTN","XQ75",146,0)
 ;
"RTN","XQ75",147,0)
FIND(XQDIC) ;The expected 0th node in ^XUTL is not here
"RTN","XQ75",148,0)
 I '$D(XQDIC) Q 0
"RTN","XQ75",149,0)
 N %,XQT1,XQT2
"RTN","XQ75",150,0)
 S %=$G(^DIC(19,"AXQ",XQDIC,0))
"RTN","XQ75",151,0)
 I '$L(%) Q 0
"RTN","XQ75",152,0)
 I $D(^XTMP("XQO","NOFIND",XQDIC)) D
"RTN","XQ75",153,0)
 .N XQT1,XQT2,XQFLG
"RTN","XQ75",154,0)
 .S XQT1=$H,XQFLG=0
"RTN","XQ75",155,0)
 .S XQT2=$G(^XTMP("XQO","NOFIND",XQDIC))
"RTN","XQ75",156,0)
 .I '$L(XQT2) Q
"RTN","XQ75",157,0)
 .I XQT2>XQT1 K ^XTMP("XQO","NOFIND",XQDIC) Q
"RTN","XQ75",158,0)
 .I XQT1>XQT2!($P(XQT1,",",2)-$P(XQT2,",",2)>.300) D
"RTN","XQ75",159,0)
 ..K ^XTMP("XQO","NOFIND",XQDIC)
"RTN","XQ75",160,0)
 ..I XQDIC="PXU" S XQFLG=1 D MGPXU^XQ12
"RTN","XQ75",161,0)
 ..I 'XQFLG D MERGE^XQ12
"RTN","XQ75",162,0)
 ..Q
"RTN","XQ75",163,0)
 .Q
"RTN","XQ75",164,0)
 I '$D(^XTMP("XQO","NOFIND",XQDIC)) S ^(XQDIC)=$H
"RTN","XQ75",165,0)
 Q %
"RTN","XQ75",166,0)
 ;
"RTN","XQ75",167,0)
P ;Entry point for '"' jump to XUCOMMAND options
"RTN","XQ75",168,0)
 I XQUR'?.ANP!(XQUR[U) W $C(7)," ??" S XQY=-1 Q
"RTN","XQ75",169,0)
 S XQO=XQUR I XQUR'?.PUN S XQO=$$UP^XLFSTR(XQO) ;F XQI=1:1 Q:XQO?.NUP  S XQO1=$A(XQO,XQI) I XQO1<123,XQO1>96 S XQO=$E(XQO,1,XQI-1)_$C(XQO1-32)_$E(XQO,XQI+1,255)
"RTN","XQ75",170,0)
 S XQUR=XQO ;,XQSV=XQY_U_XQDIC_U_XQY0
"RTN","XQ75",171,0)
 S XQJ="",XQJMP=1,(XQ,XQ1,XQS,XQXT,XQY)=0
"RTN","XQ75",172,0)
 S (XQO,XQO1)=$E(XQUR,1,$L(XQUR)-1)_$C($A($E(XQUR,$L(XQUR)))-1)_"z"
"RTN","XQ75",173,0)
 S XQDIC="PXU" D X G:XQY<0 OUT G:XQUR="" W
"RTN","XQ75",174,0)
 I XQXT K XQ S XQ=XQXT F XQI=1:1:XQ S XQ(XQI)=XQXT(XQI),%=+XQ(XQI),XQ("X",%)="" I $D(XQXT("S",%)) S XQ("S",%)=XQXT("S",%)
"RTN","XQ75",175,0)
 I XQ=1,XQS=0 S %=XQ(1),XQY=+%,XQPSM=$P(%,U,3),XQDIC=$S($L(XQPSM,",")>1:$P(XQPSM,",",$L(XQPSM,",")),1:XQPSM),XQY0=$P(^XUTL("XQO",XQDIC,U,XQY),U,2,99) G OUT
"RTN","XQ75",176,0)
 D:XQ>0 C G:XQY<0 OUT I XQ=0&('XQXT) S XQY=-1 G OUT
"RTN","XQ75",177,0)
 G OUT
"RTN","XQ81")
0^3^B72609826
"RTN","XQ81",1,0)
XQ81 ;SEA/AMF/LUKE,SF/RWF - Build menu trees ;03/03/2003  10:00
"RTN","XQ81",2,0)
 ;;8.0;KERNEL;**81,116,157,253**;Jul 10, 1995
"RTN","XQ81",3,0)
BUILD ;
"RTN","XQ81",4,0)
 ;
"RTN","XQ81",5,0)
RD2 N XQSTAT S XQSTAT=$$STATUS()
"RTN","XQ81",6,0)
 I 'XQSTAT W !!,"Some one else is rebuilding menus.  Sorry." Q
"RTN","XQ81",7,0)
 K ZTSK
"RTN","XQ81",8,0)
 D MICRO ;Turn off micro surgery for now
"RTN","XQ81",9,0)
 ;
"RTN","XQ81",10,0)
 S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",11,0)
 K XQFG W !!,"This option will build menu trees for each primary and secondary menu.",!,"You may build all the trees, or build them selectively, using 'verify'.",!,"Note that the 'compiled menus' will only be built into ^XUTL on this CPU.",!
"RTN","XQ81",12,0)
 S DIR(0)="Y",DIR("A")="Do you wish to verify each primary menu",DIR("B")="NO",DIR("??")="XQBUILDTREE-VER" D ^DIR K DIR G:$D(DIRUT) BLDEND S XQVE=(Y=1)
"RTN","XQ81",13,0)
 S DIR(0)="Y",DIR("A")="Would you like to build secondary menu trees too",DIR("B")="YES",DIR("??")="XQBUILDTREE-SEC" D ^DIR G:$D(DIRUT) BLDEND S XQBSEC=(Y=1)
"RTN","XQ81",14,0)
 ;
"RTN","XQ81",15,0)
 I 'XQVE S DIR(0)="Y",DIR("A")="Would you like to queue this job",DIR("B")="YES" D ^DIR K DIR G:$D(DIRUT) BLDEND I Y=1 D
"RTN","XQ81",16,0)
 .S ZTRTN="QUE^XQ81",ZTIO=""
"RTN","XQ81",17,0)
 .S ZTSAVE("XQVE")="",ZTSAVE("XQBSEC")="",ZTSAVE("XQSTART")=""
"RTN","XQ81",18,0)
 .S ZTDESC="Build menu trees in ^DIC(19,""AXQ"")"
"RTN","XQ81",19,0)
 .D ^%ZTLOAD
"RTN","XQ81",20,0)
 .I $D(ZTSK),'XQVE W !!,"Task #: ",ZTSK,!
"RTN","XQ81",21,0)
 .Q
"RTN","XQ81",22,0)
 ;
"RTN","XQ81",23,0)
 I $D(ZTSK) K ^DIC(19,"AXQ","P0") S XQALLDON="" G BLDEND
"RTN","XQ81",24,0)
 E  S ^DIC(19,"AXQ","P0")=$H L +^DIC(19,"AXQ","P0")
"RTN","XQ81",25,0)
 ;
"RTN","XQ81",26,0)
 I 'XQVE S DIR(0)="Y",DIR("A")="Do you really wish to run this DIRECTLY (it may take some time)",DIR("B")="NO" D ^DIR K DIR G:$D(DIRUT) BLDEND G:Y'=1 RD2
"RTN","XQ81",27,0)
 ;
"RTN","XQ81",28,0)
KIDS ;Entry from KIDS
"RTN","XQ81",29,0)
 I '$D(XQSTAT),$D(^DIC(19,"AXQ","P0")) S XQSTAT=$$STATUS I 'XQSTAT W !!,"  Some one else is building menus.  Sorry." K XQSTAT Q
"RTN","XQ81",30,0)
 I '$D(^DIC(19,"AXQ","P0","STOP")) D MICRO
"RTN","XQ81",31,0)
 I '$D(^DIC(19,"AXQ","P0")) S ^DIC(19,"AXQ","P0")=$H L +^DIC(19,"AXQ","P0")
"RTN","XQ81",32,0)
 I '$D(XQVE) S XQFG=0,XQBSEC=1,XQVE=0
"RTN","XQ81",33,0)
 N XQNTREE,XQNDONE S (XQNTREE,XQNDONE)=0
"RTN","XQ81",34,0)
 ;
"RTN","XQ81",35,0)
 ;Set up the error trap so we can clear the screen if it blows
"RTN","XQ81",36,0)
 I $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP="D ERR^XQ81"
"RTN","XQ81",37,0)
 E  S X="ERR^XQ81",@^%ZOSF("TRAP")
"RTN","XQ81",38,0)
 ;
"RTN","XQ81",39,0)
 ;Set up the bar graph and window if not from KIDS
"RTN","XQ81",40,0)
 I '$D(XPDNM) D INIT^XPDID
"RTN","XQ81",41,0)
 I XPDIDVT D
"RTN","XQ81",42,0)
 .I $D(XPDIDTOT) S XQSAVTOT=XPDIDTOT
"RTN","XQ81",43,0)
 .S X="Rebuilding Menus" D TITLE^XPDID(X)
"RTN","XQ81",44,0)
 .S XPDIDTOT=50 ;Number of divisions in bar graph
"RTN","XQ81",45,0)
 .D UPDATE^XPDID(0)
"RTN","XQ81",46,0)
 .Q
"RTN","XQ81",47,0)
 ;
"RTN","XQ81",48,0)
 S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",49,0)
 W !!,"Starting Menu Rebuild:  ",XQSTART
"RTN","XQ81",50,0)
 S XQFG=0 W !!,"Collecting primary menus in the New Person file..."
"RTN","XQ81",51,0)
 ;
"RTN","XQ81",52,0)
DQ ;Entry from taskman  Write if $D(XQFG)
"RTN","XQ81",53,0)
 K ZTREQ
"RTN","XQ81",54,0)
 I '$D(XQSTART) S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",55,0)
 N XQNOW,XQ8FLG,XQTASK
"RTN","XQ81",56,0)
 S XQ8FLG=0
"RTN","XQ81",57,0)
 S:'$D(XQNOW) XQNOW=$H
"RTN","XQ81",58,0)
 S ^DIC(19,"AXQ","P0")=XQNOW
"RTN","XQ81",59,0)
 S ^DIC(19,"AXQ","P0","STOP")=XQNOW ;Stop micro surgery if it's running
"RTN","XQ81",60,0)
 ;
"RTN","XQ81",61,0)
 S XQSEC=1,XQ81T="" I 'XQVE H 1
"RTN","XQ81",62,0)
 S XQI="" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:XQI'=+XQI!(XQI="")  I $D(^TMP("XQO",$J,XQI,0))#2 S $P(^(0),U,2)=""
"RTN","XQ81",63,0)
 S XQI="U" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:"U"'[$E(XQI)!(XQI="")  I $D(^TMP("XQO",$J,XQI,0))#2 S $P(^(0),U,2)=""
"RTN","XQ81",64,0)
 S XQI="P" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:"P"'[$E(XQI)!(XQI="")  I $D(^TMP("XQO",$J,XQI,0))#2,$L(^(0)) S XQ81T=^(0) Q
"RTN","XQ81",65,0)
 S:XQ81T="" XQ81T="Unknown"
"RTN","XQ81",66,0)
 S XQI="P" F XQK=0:0 S XQI=$O(^TMP("XQO",$J,XQI)) Q:"P"'[$E(XQI)!(XQI="")  I "P"[$E(XQI),XQI'="P0" K ^TMP("XQO",$J,XQI)
"RTN","XQ81",67,0)
 ;
"RTN","XQ81",68,0)
 ;Find the various trees and put them into ^TMP($J), and count them
"RTN","XQ81",69,0)
 S:'$D(XQH) XQH=$H K ^TMP($J) S XQI=.5 F XQK=0:0 S XQI=$O(^VA(200,XQI)) Q:XQI'=+XQI  I $D(^VA(200,XQI,0)),$L($P(^VA(200,XQI,0),U,3)) D SET
"RTN","XQ81",70,0)
 ;
"RTN","XQ81",71,0)
 S (XQNTREE,%)=0 F  S %=$O(^TMP($J,%)) Q:%=""  S XQNTREE=XQNTREE+1
"RTN","XQ81",72,0)
 S %=0 F  S %=$O(^TMP($J,"SEC",%)) Q:%=""  S XQNTREE=XQNTREE+1
"RTN","XQ81",73,0)
 ;
"RTN","XQ81",74,0)
 W:$D(XQFG) !!?20,"Primary menus found in the New Person file",!?20,"------------------------------------------"
"RTN","XQ81",75,0)
 W:$D(XQFG) !!,"OPTION NAME         MENU TEXT",?49,"# OF",?62,"LAST",?71,"LAST",!?49,"USERS",?62,"USED",?71,"BUILT",!
"RTN","XQ81",76,0)
 S X="" F XQBLD=0:0 S XQBLD=$O(^TMP($J,XQBLD)) Q:XQBLD'>0!(X=U)  I $D(^DIC(19,XQBLD,0)) S XQJ=^DIC(19,XQBLD,0) D VER
"RTN","XQ81",77,0)
 S XQSEC=0 I $D(XQFG),XQBSEC W !!,"Building secondary menu trees...."
"RTN","XQ81",78,0)
 I XQBSEC S X="" F XQBLD=0:0 S XQBLD=$O(^TMP($J,"SEC",XQBLD)) Q:XQBLD'>0  D SEC
"RTN","XQ81",79,0)
 I 'XQVE S XQK="P" F XQBLD=0:0 S XQK=$O(^TMP("XQO",$J,XQK)) Q:XQK'["P"  S ^(XQK,0)=XQH
"RTN","XQ81",80,0)
 G BLDEND
"RTN","XQ81",81,0)
 ;
"RTN","XQ81",82,0)
SEC S XQL="P"_XQBLD Q:$D(^TMP("XQO",$J,XQL))  D RD3 Q
"RTN","XQ81",83,0)
 S XQL="P" F XQN=0:0 S XQL=$O(^TMP("XQO",$J,XQL)) Q:$E(XQL)'="P"  I $D(^TMP("XQO",$J,XQL,"^",XQBLD)) Q
"RTN","XQ81",84,0)
 D:$E(XQL)'="P" RD3
"RTN","XQ81",85,0)
 Q
"RTN","XQ81",86,0)
 ;
"RTN","XQ81",87,0)
VER I $D(XQFG) D
"RTN","XQ81",88,0)
 .N XQMT,XQOPNM
"RTN","XQ81",89,0)
 .S XQK=$P(^TMP($J,XQBLD),U,2)
"RTN","XQ81",90,0)
 .S:$L(XQK) XQK=$E(XQK,4,5)_"/"_$E(XQK,6,7)_"/"_$E(XQK,2,3)
"RTN","XQ81",91,0)
 .S XQOPNM=$P(XQJ,U)
"RTN","XQ81",92,0)
 .S XQMT=$P(XQJ,U,2) I $L(XQMT)>28 S XQMT=$E(XQMT,1,25)_"..."
"RTN","XQ81",93,0)
 .W !,$P(XQJ,U,1)
"RTN","XQ81",94,0)
 .W:($L(XQOPNM)>20) !
"RTN","XQ81",95,0)
 .W ?20,XQMT,?49,+^TMP($J,XQBLD),?60,XQK
"RTN","XQ81",96,0)
 .Q
"RTN","XQ81",97,0)
 ;
"RTN","XQ81",98,0)
 I $D(XQFG) S:$D(^DIC(19,"AXQ","P"_XQBLD,0)) XQ81T=+^(0) I $L(XQ81T) S %H=XQ81T D YMD^%DTC S XQK=X W ?71,$E(XQK,4,5),"/",$E(XQK,6,7),"/",$E(XQK,2,3)
"RTN","XQ81",99,0)
 ;
"RTN","XQ81",100,0)
RD3 ;Update counter an rebuild it if necessary
"RTN","XQ81",101,0)
 I $D(XQFG),XPDIDVT D
"RTN","XQ81",102,0)
 .N %
"RTN","XQ81",103,0)
 .S XQNDONE=XQNDONE+1
"RTN","XQ81",104,0)
 .S %=(XQNDONE/XQNTREE)*XPDIDTOT
"RTN","XQ81",105,0)
 .D UPDATE^XPDID(%)
"RTN","XQ81",106,0)
 .Q
"RTN","XQ81",107,0)
 ;
"RTN","XQ81",108,0)
 S XQDIC="P"_XQBLD D CHK^XQ8 I XQRE W:$D(XQFG) !,"SOMEONE ELSE IS CURRENTLY REBUILDING THIS MENU" Q
"RTN","XQ81",109,0)
 I XQVE,XQSEC S DIR(0)="Y",DIR("A")="Rebuild",DIR("B")="YES" D ^DIR Q:$D(DIRUT)  W ! Q:Y'=1
"RTN","XQ81",110,0)
 S XQFG1=1 D PM2^XQ8
"RTN","XQ81",111,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XQ81",112,0)
 Q
"RTN","XQ81",113,0)
 ;
"RTN","XQ81",114,0)
SET G:'$D(^VA(200,XQI,201)) SET1 S XQK=+^(201) Q:'$L(XQK)  ;I $D(XQFG) W:'(XQI#10) "."
"RTN","XQ81",115,0)
 S XQR="" S:$D(^VA(200,XQI,1.1)) XQR=$P(^(1.1),".",1) S XQP=1_U_XQR
"RTN","XQ81",116,0)
 I $D(^TMP($J,XQK)) S XQP=^TMP($J,XQK) S XQP=XQP+1_U_$S(XQR>$P(XQP,U,2):XQR,1:$P(XQP,U,2))
"RTN","XQ81",117,0)
 I $D(^DIC(19,XQK,0)),$P(^(0),U,4)="M" S ^TMP($J,XQK)=XQP
"RTN","XQ81",118,0)
 ;
"RTN","XQ81",119,0)
SET1 I XQBSEC F XQN=0:0 S XQN=$O(^VA(200,XQI,203,XQN)) Q:XQN'>0  S XQL=+^(XQN,0) I $D(^DIC(19,XQL,0)),$P(^(0),U,4)="M" S ^TMP($J,"SEC",XQL)=""
"RTN","XQ81",120,0)
 Q
"RTN","XQ81",121,0)
 ;
"RTN","XQ81",122,0)
QUE ;Entry point for the option XQBUILDTREEQUE, and XQBUILDALL
"RTN","XQ81",123,0)
 ;Also called by CHEK^XQ83
"RTN","XQ81",124,0)
 S XQVE=0,XQBSEC=1 K XQFG
"RTN","XQ81",125,0)
 S XQSTART=$$HTE^XLFDT($H)
"RTN","XQ81",126,0)
 G DQ
"RTN","XQ81",127,0)
 ;
"RTN","XQ81",128,0)
BLDEND ;File a report, cleanup, and quit.
"RTN","XQ81",129,0)
 ;
"RTN","XQ81",130,0)
 K %,%H,%TG,C,D,DIC,DIR,I,J,K,L,V,XQBSEC,X,Y,Z,XQL,XQN,XQRE,XQK,XQI,XQII,UU,XQH,XQPX,XQSAV,XQXUF,XQ81T,XQDATE,XQSEC,XQVE,XQBLD,XQP,XQR,XQJ
"RTN","XQ81",131,0)
 ;
"RTN","XQ81",132,0)
 I $D(XQALLDON) K XQALLDON Q  ;Quit here if we're just creating a task
"RTN","XQ81",133,0)
 ;
"RTN","XQ81",134,0)
 D MERGET
"RTN","XQ81",135,0)
 D CLEAN
"RTN","XQ81",136,0)
 D MERGEX
"RTN","XQ81",137,0)
 ;
"RTN","XQ81",138,0)
 K ^TMP($J),^TMP("XQO",$J)
"RTN","XQ81",139,0)
 ;
"RTN","XQ81",140,0)
 ;Clear the flags and locks.
"RTN","XQ81",141,0)
 K ^XUTL("XQMERGED") ;Menues merged since last rebuild REACT^XQ84
"RTN","XQ81",142,0)
 K ^DIC(19,"AT") ;Micro message nodes
"RTN","XQ81",143,0)
 S ^XUTL("XQ","MICRO")=0 ;Number of Micro instances since last build
"RTN","XQ81",144,0)
 K ^DIC(19,"AXQ","P0","STOP") ;Allow Micro surgery to start up
"RTN","XQ81",145,0)
 K ^DIC(19,"AXQ","P0") ;Clear the rebuild flag (redundant, I know)
"RTN","XQ81",146,0)
 L -^DIC(19,"AXQ","P0") ;Unlock the rebuild flag, everybody's good to go
"RTN","XQ81",147,0)
 ;
"RTN","XQ81",148,0)
 S %=$S($D(XPDNM):"KIDS",$D(ZTSK):"QUEUED",1:"LIVE")
"RTN","XQ81",149,0)
 D REPORT^XQ84(%)
"RTN","XQ81",150,0)
 K XQSTART,ZTSK
"RTN","XQ81",151,0)
 ;
"RTN","XQ81",152,0)
 I '$D(XPDIDVT) K XQFG Q
"RTN","XQ81",153,0)
 ;
"RTN","XQ81",154,0)
 I $D(XQFG),XPDIDVT F %=((XQNDONE/XQNTREE)*XPDIDTOT):1:XPDIDTOT D UPDATE^XPDID(%) H .25
"RTN","XQ81",155,0)
 I $D(XQFG),XPDIDVT D UPDATE^XPDID(XPDIDTOT)
"RTN","XQ81",156,0)
 I $D(XQFG) W !!,"Menu Rebuild Complete:  ",$$HTE^XLFDT($H)
"RTN","XQ81",157,0)
 ;
"RTN","XQ81",158,0)
 ;
"RTN","XQ81",159,0)
 H 2
"RTN","XQ81",160,0)
 ;If we're not from KIDS then clean it up, otherwise let kids do it.
"RTN","XQ81",161,0)
 I '$D(XPDNM) D
"RTN","XQ81",162,0)
 .D EXIT^XPDID()
"RTN","XQ81",163,0)
 .K XPDIDVT,XPDIDTOT
"RTN","XQ81",164,0)
 .Q
"RTN","XQ81",165,0)
 ;
"RTN","XQ81",166,0)
 I $D(XQSAVTOT) S XPDIDTOT=XQSAVTOT
"RTN","XQ81",167,0)
 K %,VALMCOFF,VALMCON,VALMIOXY,VALMSGR,VALMWD,XQFG,XQNDONE,XQNTREE,XQSAVTOT
"RTN","XQ81",168,0)
 Q
"RTN","XQ81",169,0)
 ;
"RTN","XQ81",170,0)
 ;================================Subroutines==========================
"RTN","XQ81",171,0)
 ;
"RTN","XQ81",172,0)
MERGET ;Merge ^TMP("XQO",$J) into ^DIC(19,"AXQ")
"RTN","XQ81",173,0)
 N Q,X,XQFLAG,Y S X="P",XQFLAG=0,Q=""""
"RTN","XQ81",174,0)
 I $D(XQFG) W !!,"Merging...."
"RTN","XQ81",175,0)
 F  S X=$O(^TMP("XQO",$J,X)) Q:X=""  D
"RTN","XQ81",176,0)
 .L +^DIC(19,"AXQ",X):2 I '$T S XQFLAG=1 Q
"RTN","XQ81",177,0)
 .S %X="^TMP(""XQO"","_$J_","_Q_X_Q_","
"RTN","XQ81",178,0)
 .S %Y="^DIC(19,""AXQ"","_Q_X_Q_","
"RTN","XQ81",179,0)
 .K ^DIC(19,"AXQ",X)
"RTN","XQ81",180,0)
 .;M ^DIC(19,"AXQ",X)=^TMP("XQO",$J,X)
"RTN","XQ81",181,0)
 .D %XY^%RCR
"RTN","XQ81",182,0)
 .L -^DIC(19,"AXQ",X)
"RTN","XQ81",183,0)
 .K %X,%Y
"RTN","XQ81",184,0)
 .Q
"RTN","XQ81",185,0)
 ;
"RTN","XQ81",186,0)
 I XQFLAG,$D(XQFG) D
"RTN","XQ81",187,0)
 .N %,Y
"RTN","XQ81",188,0)
 .S Y=$P(X,"P",2) Q:Y=""
"RTN","XQ81",189,0)
 .S %=$G(^DIC(19,Y,0)) Q:%=""
"RTN","XQ81",190,0)
 .S Y=$P(%,"^",2) Q:%=""
"RTN","XQ81",191,0)
 .W !,?12,"Could not merge menu: "_Y
"RTN","XQ81",192,0)
 .Q
"RTN","XQ81",193,0)
 Q
"RTN","XQ81",194,0)
 ;
"RTN","XQ81",195,0)
CLEAN ;Clean out unused menu trees from ^DIC(19,"AXQ")
"RTN","XQ81",196,0)
 N X,Y S X="P"
"RTN","XQ81",197,0)
 F  S X=$O(^DIC(19,"AXQ",X)) Q:X=""  D
"RTN","XQ81",198,0)
 .I X'="PXU" D
"RTN","XQ81",199,0)
 ..S Y=$E(X,2,99)
"RTN","XQ81",200,0)
 ..I '$D(^TMP($J,Y))&('$D(^TMP($J,"SEC",Y))) K ^DIC(19,"AXQ",X),^XUTL("XQO",X)
"RTN","XQ81",201,0)
 ..Q
"RTN","XQ81",202,0)
 .Q
"RTN","XQ81",203,0)
 Q
"RTN","XQ81",204,0)
 ;
"RTN","XQ81",205,0)
MERGEX ;Merge ^DIC(19,"AXQ") into ^XUTL("XQO")
"RTN","XQ81",206,0)
 N Q,X,XQFLAG,Y S X="P",XQFLAG=0,Q=""""
"RTN","XQ81",207,0)
 F  S X=$O(^DIC(19,"AXQ",X)) Q:X=""  D
"RTN","XQ81",208,0)
 .L +^XUTL("XQO",X):2 I '$T S XQFLAG=1 Q
"RTN","XQ81",209,0)
 .S %X="^DIC(19,""AXQ"","_Q_X_Q_","
"RTN","XQ81",210,0)
 .S %Y="^XUTL(""XQO"","_Q_X_Q_","
"RTN","XQ81",211,0)
 .K ^XUTL("XQO",X)
"RTN","XQ81",212,0)
 .;M ^XUTL("XQO",X)=^DIC(19,"AXQ",X)
"RTN","XQ81",213,0)
 .D %XY^%RCR
"RTN","XQ81",214,0)
 .L -^XUTL("XQO",X)
"RTN","XQ81",215,0)
 .K %X,%Y
"RTN","XQ81",216,0)
 .Q
"RTN","XQ81",217,0)
 ;
"RTN","XQ81",218,0)
 I XQFLAG,$D(XQFG) D
"RTN","XQ81",219,0)
 .N %,Y
"RTN","XQ81",220,0)
 .S Y=$P(X,"P",2) Q:Y=""
"RTN","XQ81",221,0)
 .S %=$G(^DIC(19,Y,0)) Q:%=""
"RTN","XQ81",222,0)
 .S Y=$P(%,"^",2) Q:%=""
"RTN","XQ81",223,0)
 .W !,?12,"Could not merge menu: "_Y
"RTN","XQ81",224,0)
 .Q
"RTN","XQ81",225,0)
 ;
"RTN","XQ81",226,0)
 I 'XQFLAG,$D(XQFG) W " done."
"RTN","XQ81",227,0)
 Q
"RTN","XQ81",228,0)
 ;
"RTN","XQ81",229,0)
STATUS()  ;Are the menus being rebuilt even as we speak?
"RTN","XQ81",230,0)
 N %,XQTHEN
"RTN","XQ81",231,0)
 S %=$G(^DIC(19,"AXQ","P0")) I %="" Q 1  ;It finished.  Never mind.
"RTN","XQ81",232,0)
 L +^DIC(19,"AXQ","P0"):0 ;If job is still running we can't lock it
"RTN","XQ81",233,0)
 I $T L -^DIC(19,"AXQ","P0") K ^("P0") Q 1  ;Job must have failed
"RTN","XQ81",234,0)
 Q 0
"RTN","XQ81",235,0)
 ;
"RTN","XQ81",236,0)
 ;
"RTN","XQ81",237,0)
MICRO ;Turn off micro surgery
"RTN","XQ81",238,0)
 I $D(^DIC(19,"AXQ","P0","MICRO")) D
"RTN","XQ81",239,0)
 .S ^DIC(19,"AXQ","P0","STOP")=$H ;Turn off micro-surgery
"RTN","XQ81",240,0)
 .K ^DIC(19,"AXQ","P0","MICRO")
"RTN","XQ81",241,0)
 .H 2
"RTN","XQ81",242,0)
 .Q
"RTN","XQ81",243,0)
 Q
"RTN","XQ81",244,0)
 ;
"RTN","XQ81",245,0)
 ;
"RTN","XQ81",246,0)
ERR ;Come here on error
"RTN","XQ81",247,0)
 N XQERROR
"RTN","XQ81",248,0)
 S XQERROR=$$EC^%ZOSV
"RTN","XQ81",249,0)
 D ^%ZTER
"RTN","XQ81",250,0)
 D EXIT^XPDID()
"RTN","XQ81",251,0)
 G UNWIND^%ZTER
"RTN","XQ81",252,0)
 Q
"RTN","XQ84")
0^2^B58717207
"RTN","XQ84",1,0)
XQ84 ;SEA/Luke - Menu Rebuild Utilities ;03/03/2003  09:19
"RTN","XQ84",2,0)
 ;;8.0;KERNEL;**157,253**;Jul 10, 1995
"RTN","XQ84",3,0)
 ;
"RTN","XQ84",4,0)
 ;
"RTN","XQ84",5,0)
SHOW ; Show what's in the global ^XUTL("XQ","REBUILDS")
"RTN","XQ84",6,0)
 I '$D(^XUTL("XQ","REBUILDS")) W !,"  Sorry, there is no data in the global ^XUTL(""XQ"",""REBUILDS"") to show you.",! Q
"RTN","XQ84",7,0)
 ;
"RTN","XQ84",8,0)
 N %,XQI,XQNL,XQNI,XQNT
"RTN","XQ84",9,0)
 N XQB,XQE,XQBY,XQTYPE,XQT,XQUCI,XQJ
"RTN","XQ84",10,0)
 ;
"RTN","XQ84",11,0)
 I '$D(IOF) D HOME^%ZIS
"RTN","XQ84",12,0)
 W @IOF
"RTN","XQ84",13,0)
 S XQNL=0 ;Line counter
"RTN","XQ84",14,0)
 S XQNI=1 ;Item or occurance counter
"RTN","XQ84",15,0)
 S XQNT=$S($D(IOSL):IOSL-4,1:18) ;Number of lines on the screen
"RTN","XQ84",16,0)
 ;
"RTN","XQ84",17,0)
 D TITLE
"RTN","XQ84",18,0)
 D TOP
"RTN","XQ84",19,0)
 ;
"RTN","XQ84",20,0)
 S XQI=0
"RTN","XQ84",21,0)
 F  Q:$D(DIRUT)  S XQI=$O(^XUTL("XQ","REBUILDS",XQI)) Q:XQI=""  D
"RTN","XQ84",22,0)
 .S %=^XUTL("XQ","REBUILDS",XQI)
"RTN","XQ84",23,0)
 .S XQBY=$P($P(%,U,3),","),XQBY=$E(XQBY,1,12)
"RTN","XQ84",24,0)
 .S XQB=$P(%,U,1),XQE=$P(%,U,2),XQTYPE=$P(%,U,4),XQT=$P(%,U,5)
"RTN","XQ84",25,0)
 .S XQUCI="  Location:  "_$P(%,U,6,8)
"RTN","XQ84",26,0)
 .S XQJ="     Job #:  "_$P(%,U,9)
"RTN","XQ84",27,0)
 .D WRITE
"RTN","XQ84",28,0)
 .Q
"RTN","XQ84",29,0)
 ;
"RTN","XQ84",30,0)
 K DIRUT,DUOUT
"RTN","XQ84",31,0)
 Q
"RTN","XQ84",32,0)
 ;
"RTN","XQ84",33,0)
WRITE ;Write an entry unless the screen is full
"RTN","XQ84",34,0)
 I XQNL>XQNT D
"RTN","XQ84",35,0)
 .D WAIT Q:$D(DIRUT)
"RTN","XQ84",36,0)
 .W @IOF
"RTN","XQ84",37,0)
 .S XQNL=0
"RTN","XQ84",38,0)
 .D TOP
"RTN","XQ84",39,0)
 .Q
"RTN","XQ84",40,0)
 Q:$D(DIRUT)
"RTN","XQ84",41,0)
 W !,XQNI,".",?4,XQB,?28,XQE,?51,XQBY,?60,XQTYPE,?71,XQT,!,XQUCI,XQJ,!
"RTN","XQ84",42,0)
 S XQNL=XQNL+3,XQNI=XQNI+1
"RTN","XQ84",43,0)
 Q
"RTN","XQ84",44,0)
 ;
"RTN","XQ84",45,0)
TOP ; Format the top of the page
"RTN","XQ84",46,0)
 W !,?11,"Start",?35,"End",?53,"By",?59,"Type/Name",?72,"Task #",!
"RTN","XQ84",47,0)
 S XQNL=XQNL+2
"RTN","XQ84",48,0)
 Q
"RTN","XQ84",49,0)
 ;
"RTN","XQ84",50,0)
TITLE ;What is this all about?
"RTN","XQ84",51,0)
 N %
"RTN","XQ84",52,0)
 S %=$G(^XUTL("XQ","MICRO"))
"RTN","XQ84",53,0)
 W ?36,"Recent Menu Rebuilds",!
"RTN","XQ84",54,0)
 S XQNL=XQNL+2
"RTN","XQ84",55,0)
 W ?14,$S(%>0:%,1:"No")_" instances of Micro Surgery since last rebuild."
"RTN","XQ84",56,0)
 S XQNL=XQNL+2
"RTN","XQ84",57,0)
 Q
"RTN","XQ84",58,0)
 ;
"RTN","XQ84",59,0)
WAIT ;That's a screen load hold it here for a minute
"RTN","XQ84",60,0)
 N X,Y
"RTN","XQ84",61,0)
 S DIR(0)="E" D ^DIR K DIR
"RTN","XQ84",62,0)
 Q
"RTN","XQ84",63,0)
 ;
"RTN","XQ84",64,0)
 ;
"RTN","XQ84",65,0)
USER ;Rebuild the menu trees of a specific user
"RTN","XQ84",66,0)
 ;called by the option XQBUILDUSER
"RTN","XQ84",67,0)
 N XUN,XQCNT,XQSEC,XQREACT,XQPRIM,XQFL
"RTN","XQ84",68,0)
 S (XQCNT,XQSEC)=0
"RTN","XQ84",69,0)
 ;
"RTN","XQ84",70,0)
 S XUN=+$$LOOKUP^XUSER Q:XUN'>0
"RTN","XQ84",71,0)
 S XQPRIM=$G(^VA(200,XUN,201)) I XQPRIM'>0 W !!,"No Primary Menu defined for this user." Q
"RTN","XQ84",72,0)
 S XQCNT=1,XQREACT(XQCNT)=XQPRIM
"RTN","XQ84",73,0)
 F  S XQSEC=$O(^VA(200,XUN,203,"B",XQSEC)) Q:XQSEC'=+XQSEC  D
"RTN","XQ84",74,0)
 .Q:'$D(^DIC(19,XQSEC,0))  ;Error in Buffalo...old pointer?
"RTN","XQ84",75,0)
 .I $P(^DIC(19,XQSEC,0),U,4)="M" S XQCNT=XQCNT+1,XQREACT(XQCNT)=XQSEC
"RTN","XQ84",76,0)
 .Q
"RTN","XQ84",77,0)
 ;
"RTN","XQ84",78,0)
 M XQREACTS=XQREACT  ;Save the originals
"RTN","XQ84",79,0)
 S XQCNTS=XQCNT
"RTN","XQ84",80,0)
 ;
"RTN","XQ84",81,0)
 S XQFL=$$FLAG(.XQREACT,.XQCNT)
"RTN","XQ84",82,0)
 I XQFL=1 D
"RTN","XQ84",83,0)
 .N DIR
"RTN","XQ84",84,0)
 .S DIR(0)="Y"
"RTN","XQ84",85,0)
 .S DIR("A")=" Are you sure you want to force a rebuild? "
"RTN","XQ84",86,0)
 .S DIR("A",1)="               ***WARNING*** "
"RTN","XQ84",87,0)
 .S DIR("A",2)=" Someone else may be rebuilding these trees right now."
"RTN","XQ84",88,0)
 .S DIR("?")=" Enter 'Y' to force a rebuild, 'N' to quit."
"RTN","XQ84",89,0)
 .D ^DIR
"RTN","XQ84",90,0)
 .I Y=1 D
"RTN","XQ84",91,0)
 ..M XQREACT=XQREACTS  ;Restore original list of menus
"RTN","XQ84",92,0)
 ..S XQCNT=XQCNTS
"RTN","XQ84",93,0)
 ..S XQFL=0
"RTN","XQ84",94,0)
 ..Q
"RTN","XQ84",95,0)
 .Q
"RTN","XQ84",96,0)
 ;
"RTN","XQ84",97,0)
 Q:XQFL  ;Flags are set, let's not mess with it.
"RTN","XQ84",98,0)
 ;
"RTN","XQ84",99,0)
 S DIR(0)="Y",DIR("A")=" Queue this rebuild? ",DIR("B")="Y"
"RTN","XQ84",100,0)
 S DIR("?")=" Please enter 'Y'es or 'N'o."
"RTN","XQ84",101,0)
 D ^DIR I Y=1 D
"RTN","XQ84",102,0)
 .S ZTRTN="REACTQ^XQ84"
"RTN","XQ84",103,0)
 .S ZTSAVE("XUN")=""
"RTN","XQ84",104,0)
 .S ZTSAVE("XQREACT(")="",ZTSAVE("XQCNT")=""
"RTN","XQ84",105,0)
 .S ZTIO="",ZTDTH=$H
"RTN","XQ84",106,0)
 .S ZTDESC="Rebuild "_$P(^VA(200,XUN,0),U)_"'s menu trees (DUZ="_XUN_")"
"RTN","XQ84",107,0)
 .D ^%ZTLOAD
"RTN","XQ84",108,0)
 .I $D(ZTSK) W !!," Task number: ",ZTSK
"RTN","XQ84",109,0)
 .Q
"RTN","XQ84",110,0)
 K DIR,Y
"RTN","XQ84",111,0)
 ;
"RTN","XQ84",112,0)
 I '$D(ZTSK) D REACTQ W !!," Done."
"RTN","XQ84",113,0)
 K ZTSK
"RTN","XQ84",114,0)
 Q
"RTN","XQ84",115,0)
 ;
"RTN","XQ84",116,0)
REACT(XUN) ;From XUSERNEW, check trees for reactivated user
"RTN","XQ84",117,0)
 ;
"RTN","XQ84",118,0)
 N XQCNT,XQSEC,XQREACT,XQPRIM,XQCHAT
"RTN","XQ84",119,0)
 S XQCHAT=1 I $D(XQUEUED)!$D(XWB) S XQCHAT=0 ;Anybody out there?
"RTN","XQ84",120,0)
 S XQPRIM=$G(^VA(200,XUN,201)) I 'XQPRIM,'$D(XQQUE) W:XQCHAT !!,"** WARNING ** No Primary Menu defined." Q
"RTN","XQ84",121,0)
 I (XQPRIM'=+XQPRIM)!($G(^DIC(19,XQPRIM,0))="") Q
"RTN","XQ84",122,0)
 S (XQCNT,XQSEC)=0
"RTN","XQ84",123,0)
 I XQPRIM,'$D(^DIC(19,"AXQ","P"_XQPRIM)),$P(^DIC(19,XQPRIM,0),U,4)="M" S XQCNT=XQCNT+1,XQREACT(XQCNT)="P"_XQPRIM
"RTN","XQ84",124,0)
 F  S XQSEC=$O(^VA(200,XUN,203,"B",XQSEC)) Q:XQSEC'=+XQSEC  D
"RTN","XQ84",125,0)
 .Q:'$D(^DIC(19,XQSEC,0))  ;Bad pointer don't use it
"RTN","XQ84",126,0)
 .I '$D(^DIC(19,"AXQ","P"_XQSEC)),$P(^DIC(19,XQSEC,0),U,4)="M" S XQCNT=XQCNT+1,XQREACT(XQCNT)="P"_XQSEC
"RTN","XQ84",127,0)
 .Q
"RTN","XQ84",128,0)
 ;
"RTN","XQ84",129,0)
 Q:XQCNT=0  ;The menu trees look OK to me.
"RTN","XQ84",130,0)
 ;
"RTN","XQ84",131,0)
 N %
"RTN","XQ84",132,0)
 S %=$$FLAG(.XQREACT,.XQCNT) ;Are we already merging them (1)
"RTN","XQ84",133,0)
 Q:%
"RTN","XQ84",134,0)
 ;
"RTN","XQ84",135,0)
 I XQCNT>0 D
"RTN","XQ84",136,0)
 .S ZTRTN="REACTQ^XQ84"
"RTN","XQ84",137,0)
 .S ZTSAVE("XQREACT(")="",ZTSAVE("XUN")=""
"RTN","XQ84",138,0)
 .S ZTIO="",ZTDTH=$H
"RTN","XQ84",139,0)
 .S ZTDESC="Rebuild reactivated user's menu trees (DUZ="_XUN_")"
"RTN","XQ84",140,0)
 .D ^%ZTLOAD
"RTN","XQ84",141,0)
 .K ZTSK
"RTN","XQ84",142,0)
 .Q
"RTN","XQ84",143,0)
 Q
"RTN","XQ84",144,0)
 ;
"RTN","XQ84",145,0)
FLAG(XQARRAY,XQNUM1) ;Should we build a particular array of trees
"RTN","XQ84",146,0)
 ;Input: XQARRAY - array of trees e.g. P106, etc.  XQNUM1 number of trees
"RTN","XQ84",147,0)
 ;Output: 0 - There are trees to rebuild, 1 - Trees are already flagged
"RTN","XQ84",148,0)
 ;Merge flags e.g. [^XUTL("XQMERGED","P106)=$H] are set here 
"RTN","XQ84",149,0)
 ; and killed in REACTQ+16
"RTN","XQ84",150,0)
 ;
"RTN","XQ84",151,0)
 N %,XQNUM,XQPXU S XQNUM=0
"RTN","XQ84",152,0)
 S %=$$STATUS^XQ81() I '% Q 1  ;Menues rebuilding
"RTN","XQ84",153,0)
 S XQPXU=$G(^DIC(19,"AXQ","PXU",0)) Q:XQPXU="" 1
"RTN","XQ84",154,0)
 S %="" F  S %=$O(XQARRAY(%)) Q:%=""  D
"RTN","XQ84",155,0)
 .N X
"RTN","XQ84",156,0)
 .S X=XQARRAY(%)
"RTN","XQ84",157,0)
 .I $D(^XUTL("XQMERGED",X)) D
"RTN","XQ84",158,0)
 ..N Y,Z
"RTN","XQ84",159,0)
 ..S Y=$G(^XUTL("XQMERGED",X)) Q:Y=""  ;Flag's gone
"RTN","XQ84",160,0)
 ..S Z=$$HDIFF^XLFDT(XQPXU,Y)
"RTN","XQ84",161,0)
 ..I Z>0 K ^XUTL("XQMERGED",X) ;Old Flag
"RTN","XQ84",162,0)
 ..Q
"RTN","XQ84",163,0)
 .I $D(^XUTL("XQMERGED",X)) K XQARRAY(%) Q
"RTN","XQ84",164,0)
 .S ^XUTL("XQMERGED",X)=$H,XQNUM=XQNUM+1 ;We'll merge this one
"RTN","XQ84",165,0)
 .Q
"RTN","XQ84",166,0)
 I XQNUM>0 S XQNUM1=XQNUM Q 0  ;There are some left to rebuild
"RTN","XQ84",167,0)
 Q 1
"RTN","XQ84",168,0)
 ;
"RTN","XQ84",169,0)
 ;
"RTN","XQ84",170,0)
REACTQ ;Queued job to rebuild a reativated user's menu trees
"RTN","XQ84",171,0)
 ;  can also be run in real time by USER (above) [Not Used]
"RTN","XQ84",172,0)
 ;
"RTN","XQ84",173,0)
 N % S %=0
"RTN","XQ84",174,0)
 K ZTREQ ;Don't delete the task information
"RTN","XQ84",175,0)
 I $D(^DIC(19,"AXQ","P0")) S XQSTAT=$$STATUS^XQ81 Q:'XQSTAT  ;Menus are being rebuilt
"RTN","XQ84",176,0)
 Q:'$D(XQREACT)  ;Nothing to rebuild
"RTN","XQ84",177,0)
 ;
"RTN","XQ84",178,0)
 D MICRO^XQ81  ;Turn off Micro Surgery
"RTN","XQ84",179,0)
 S ^DIC(19,"AXQ","P0")=$H
"RTN","XQ84",180,0)
 N XQCNT,XQDIC S XQCNT=""
"RTN","XQ84",181,0)
 K ^TMP($J),^TMP("XQO",$J)
"RTN","XQ84",182,0)
 F  S XQCNT=$O(XQREACT(XQCNT)) Q:XQCNT=""  D
"RTN","XQ84",183,0)
 .S (XQFG1,XQXUF)="",XQDIC="P"_XQREACT(XQCNT)
"RTN","XQ84",184,0)
 .D PM2^XQ8
"RTN","XQ84",185,0)
 .Q:'$D(^TMP("XQO",$J,XQDIC))
"RTN","XQ84",186,0)
 .M ^DIC(19,"AXQ",XQDIC)=^TMP("XQO",$J,XQDIC) ;D MERGET^XQ81
"RTN","XQ84",187,0)
 .M ^XUTL("XQO",XQDIC)=^DIC(19,"AXQ",XQDIC)  ;D MERGEX^XQ81
"RTN","XQ84",188,0)
 .K ^XUTL("XQMERGED",XQREACT(XQCNT))
"RTN","XQ84",189,0)
 .Q
"RTN","XQ84",190,0)
 K ^DIC(19,"AXQ","P0"),^TMP($J),^TMP("XQO",$J)
"RTN","XQ84",191,0)
 D REPORT($E($P(^VA(200,XUN,0),U),1,9))
"RTN","XQ84",192,0)
 K ^DIC(19,"AXQ","P0","STOP")
"RTN","XQ84",193,0)
 K D,I,W,X,XQK,XQQUE,XQXUF,Y,Z
"RTN","XQ84",194,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XQ84",195,0)
 Q
"RTN","XQ84",196,0)
 ;
"RTN","XQ84",197,0)
 ;
"RTN","XQ84",198,0)
REPORT(XQTYPE) ;Tell Rick What happened.
"RTN","XQ84",199,0)
 N %,X,XQI,XQJ,XQK,XQLINE,XQEND,Y
"RTN","XQ84",200,0)
 I '$D(^XUTL("XQ","MICRO")) S ^("MICRO")=0
"RTN","XQ84",201,0)
 I XQTYPE["MICRO" S ^XUTL("XQ","MICRO")=^XUTL("XQ","MICRO")+1 Q  ;Update Micro count
"RTN","XQ84",202,0)
 S XQEND=$$HTE^XLFDT($H)
"RTN","XQ84",203,0)
 I '$D(XQSTART) S XQSTART=XQEND
"RTN","XQ84",204,0)
 S XQLINE=XQSTART_"^"_XQEND_"^"_$P(^VA(200,DUZ,0),U,1)_"^"
"RTN","XQ84",205,0)
 ;S X=$S($D(^DIC(19,"AXQ","P0","MICRO")):"MICRO",$D(ZTSK):"QUEUED",1:"LIVE")
"RTN","XQ84",206,0)
 S X=XQTYPE K XQTYPE
"RTN","XQ84",207,0)
 S Y=$S($D(ZTSK):ZTSK,1:"LIVE")
"RTN","XQ84",208,0)
 S XQLINE=XQLINE_X_"^"_Y
"RTN","XQ84",209,0)
 D GETENV^%ZOSV
"RTN","XQ84",210,0)
 S XQLINE=XQLINE_"^"_$P(Y,"^",1,3)_"^"_$J
"RTN","XQ84",211,0)
 I $D(^XUTL("XQ","REBUILDS")) D
"RTN","XQ84",212,0)
 .S (XQJ,XQK)=0
"RTN","XQ84",213,0)
 .F  S XQJ=$O(^XUTL("XQ","REBUILDS",XQJ)) Q:XQJ=""!(XQJ=49)  S XQK=XQK+1
"RTN","XQ84",214,0)
 .F XQI=XQK:-1:1 S ^XUTL("XQ","REBUILDS",XQI+1)=^(XQI)
"RTN","XQ84",215,0)
 .Q
"RTN","XQ84",216,0)
 S ^XUTL("XQ","REBUILDS",1)=XQLINE
"RTN","XQ84",217,0)
 Q
"RTN","XQ84",218,0)
 ;
"RTN","XQ84",219,0)
 ;
"RTN","XQ84",220,0)
NOW ;Is there a rebuild of any kind running right now?
"RTN","XQ84",221,0)
 N % S %=0
"RTN","XQ84",222,0)
 I $D(^DIC(19,"AXQ","P0","MICRO")) D
"RTN","XQ84",223,0)
 .W !!?6,"Micro surgery is currently updating the compiled menus."
"RTN","XQ84",224,0)
 .I $D(^DIC(19,"AXQ","AXQ","STOP")) D
"RTN","XQ84",225,0)
 ..W !?6,"... but it has been instructed to stop."
"RTN","XQ84",226,0)
 ..Q
"RTN","XQ84",227,0)
 .S %=47
"RTN","XQ84",228,0)
 .Q
"RTN","XQ84",229,0)
 Q:%=47
"RTN","XQ84",230,0)
 I $D(^DIC(19,"AXQ","P0")) D
"RTN","XQ84",231,0)
 .W !!?6," A complete menu rebuild is currently running."
"RTN","XQ84",232,0)
 .S %=47
"RTN","XQ84",233,0)
 .Q
"RTN","XQ84",234,0)
 Q:%=47
"RTN","XQ84",235,0)
 W !!?6,"There is no menu rebuild activity running on your system right now."
"RTN","XQ84",236,0)
 Q
"RTN","XQCS")
0^5^B34794389
"RTN","XQCS",1,0)
XQCS ;SEA/Luke - Client/Server Utilities ;01/07/2003  13:53
"RTN","XQCS",2,0)
 ;;8.0;KERNEL;**15,28,82,116,115,177,188,157,253**;Jul 10, 1995
"RTN","XQCS",3,0)
 ;
"RTN","XQCS",4,0)
CHK(XQUSR,XQOPT,XQRPC) ;Check to see if this user can run this RPC from
"RTN","XQCS",5,0)
 ;this option.  Called by XWBSEC and XUSRB.
"RTN","XQCS",6,0)
 ;
"RTN","XQCS",7,0)
 ;Input: XQUSR-DUZ of user
"RTN","XQCS",8,0)
 ;       XQOPT - name or IEN of the option
"RTN","XQCS",9,0)
 ;       XQRPC - name or IEN of the remote procedure.  If this
"RTN","XQCS",10,0)
 ;               variable is null no check is made to see if a
"RTN","XQCS",11,0)
 ;               procedure is allowed.  That is, we only look
"RTN","XQCS",12,0)
 ;               to see if the option is there and  if the user
"RTN","XQCS",13,0)
 ;               has been assigned access to it.
"RTN","XQCS",14,0)
 ;
"RTN","XQCS",15,0)
 ;Output: XQMES - returned as 1 if the user is allowed to use this
"RTN","XQCS",16,0)
 ;        option (and RPC is valid if XQRPC input variable is not
"RTN","XQCS",17,0)
 ;        null), or as a message string explaining why the option
"RTN","XQCS",18,0)
 ;        or RPC is not allowed.
"RTN","XQCS",19,0)
 ;
"RTN","XQCS",20,0)
 ;Rules: If M code exsists in ^DIC(19,option#,"RPC",rpc#,1) the
"RTN","XQCS",21,0)
 ;       RULES field for a corresponding RPC, the software sets
"RTN","XQCS",22,0)
 ;       the flag XQRPCOK to 1 and executes the field's code.
"RTN","XQCS",23,0)
 ;       If the flag is returned as less than 1, the request for
"RTN","XQCS",24,0)
 ;       use of that RPC is denied.  Rules are written by the
"RTN","XQCS",25,0)
 ;       package developer and are not required.
"RTN","XQCS",26,0)
 ;
"RTN","XQCS",27,0)
 ;
"RTN","XQCS",28,0)
 N %,X,XQCY0,XQDIC,XQKEY,XQRPCOK,XQPM,XQSM,XQSMY,XQYSAV
"RTN","XQCS",29,0)
 ;
"RTN","XQCS",30,0)
 S XQMES=1
"RTN","XQCS",31,0)
 D OPT I 'XQMES Q XQMES
"RTN","XQCS",32,0)
 I ($G(XQY0)'="XUS SIGNON")&(XQUSR>0) D USER I 'XQMES Q XQMES
"RTN","XQCS",33,0)
 S %=$G(XQRPC) I %]"" S XQRPC=% D RPC I 'XQMES Q XQMES
"RTN","XQCS",34,0)
 Q XQMES
"RTN","XQCS",35,0)
 ;
"RTN","XQCS",36,0)
 ;
"RTN","XQCS",37,0)
OPT ;See if the option is there and is a broker type option
"RTN","XQCS",38,0)
 I XQOPT'=+XQOPT S XQOPT=$O(^DIC(19,"B",XQOPT,0))
"RTN","XQCS",39,0)
 I XQOPT'>0 S XQMES="No such option in the ""B"" cross reference of the Option File." Q
"RTN","XQCS",40,0)
 I $G(MODE)="CHECK" D OPT1 Q
"RTN","XQCS",41,0)
 I '$D(^TMP("XQCS",$J)) S XQOPT=$$OPTLK($P(^DIC(19,XQOPT,0),U))
"RTN","XQCS",42,0)
 Q
"RTN","XQCS",43,0)
OPT1 ;
"RTN","XQCS",44,0)
 I XQOPT'=+XQOPT S XQOPT=$O(^DIC(19,"B",XQOPT,0)) I XQOPT'>0 S XQMES="No such option in the ""B"" cross reference of the Option File." Q
"RTN","XQCS",45,0)
 I '$D(^DIC(19,XQOPT,0)) S XQMES="No such option in the Option File."  Q
"RTN","XQCS",46,0)
 ;I $P(^DIC(19,XQOPT,0),U,4)'="B" S XQMES="This option is not a Client/Server-type option."  Q
"RTN","XQCS",47,0)
 ;
"RTN","XQCS",48,0)
 ;Check for Out-Of-Order, etc.  Patch XU*8*38 7/16/96
"RTN","XQCS",49,0)
 ;
"RTN","XQCS",50,0)
 S XQCY0=^DIC(19,XQOPT,0) ;W XQCY0
"RTN","XQCS",51,0)
 I $L($P(XQCY0,U,3)) S XQMES="Option out of order with message: "_$P(XQCY0,U,3)_"."  Q
"RTN","XQCS",52,0)
 I $L($P(XQCY0,U,6)) S %=$P(XQCY0,U,6) I '$D(^XUSEC(%,DUZ)) S XQMES="Option locked, "_$P(^VA(200,DUZ,0),U)_" does not hold the key."  Q
"RTN","XQCS",53,0)
 I $L($P(XQCY0,U,16)) I $D(^DIC(19,XQOPT,3)),^(3)]"" S %=^(3) I $D(^XUSEC(%,DUZ)) S XQMES="Reverse lock, "_$P(^VA(200,DUZ,0),U)_" holds the key."  Q
"RTN","XQCS",54,0)
 I $L($P(XQCY0,U,9)) S XQZ=$P(XQCY0,U,9) D ^XQDATE S (XX,X)=% D XQO^XQ92 I X=""!(XX'=X) S XQMES="This option is time restricted."  Q
"RTN","XQCS",55,0)
 I $D(^DIC(19,+XQOPT,3.91)),$P(^(3.91,0),U,4)>1 S:$D(XQY) XQYSAV=XQY D ^XQDATE S X=%,XQY=+XQOPT D ^XQ92 S:$D(XQYSAV) XQY=XQYSAV I X="" S XQMES="This option is time restricted."  Q
"RTN","XQCS",56,0)
 ;End patch 38
"RTN","XQCS",57,0)
 Q
"RTN","XQCS",58,0)
 ;
"RTN","XQCS",59,0)
OPTLK(V) ;Lookup a Option in the file, Return it's IEN
"RTN","XQCS",60,0)
 N XQOPT S XQOPT=$O(^DIC(19,"B",V,0)) I XQOPT'>0 Q ""
"RTN","XQCS",61,0)
 I '$D(XQMES) N XQMES S XQMES=1
"RTN","XQCS",62,0)
 N XQCS,XQCSO S XQCS(XQOPT)="" N XQOPT K ^TMP("XQCS",$J)
"RTN","XQCS",63,0)
 F  S XQOPT=$O(XQCS("")) Q:XQOPT=""  K XQCS(XQOPT) I '$D(XQCSO(XQOPT)) D OPT1 D:XQMES  I 'XQMES Q
"RTN","XQCS",64,0)
 . N I,J F I=0:0 S I=$O(^DIC(19,XQOPT,"RPC",I)) Q:I'>0  K J S J=^(I,0) S:$D(^(1)) J(1)=^(1) I '$D(^TMP("XQCS",$J,+J)) S ^TMP("XQCS",$J,+J,0)=J I $D(J(1)) S ^(1)=J(1)
"RTN","XQCS",65,0)
 . F I=0:0 S I=$O(^DIC(19,XQOPT,10,I)) Q:I'>0  S J=+^(I,0) I $P(^DIC(19,J,0),U,4)="B" S XQCS(J)=""
"RTN","XQCS",66,0)
 . S XQCSO(XQOPT)=""
"RTN","XQCS",67,0)
 . Q
"RTN","XQCS",68,0)
 Q $O(^DIC(19,"B",V,0))
"RTN","XQCS",69,0)
 ;
"RTN","XQCS",70,0)
RPC ;See if rpc exsists, is registered, is locked, etc.
"RTN","XQCS",71,0)
 ; I '$D(^DIC(19,XQOPT,"RPC",0)) S XQMES="No RPC subfile defined for the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",72,0)
 ; I $P(^DIC(19,XQOPT,"RPC",0),U,4)<1 S XQMES="No remote procedure calls registered for the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",73,0)
 I XQRPC'=+XQRPC S XQRPC=$O(^XWB(8994,"B",XQRPC,0)) I XQRPC'>0 S XQMES="No RPC by that name in the ""B"" cross-reference of the Remote Procedure File." Q
"RTN","XQCS",74,0)
 I '$D(^XWB(8994,XQRPC,0)) S XQMES="No such procedure in the Remote Procedure File." Q
"RTN","XQCS",75,0)
 ; I '$D(^DIC(19,XQOPT,"RPC","B",XQRPC)) S XQMES="The remote procedure "_$P(^XWB(8994,XQRPC,0),U)_" is not registered to the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",76,0)
 I '$D(^TMP("XQCS",$J,XQRPC)) S XQMES="The remote procedure "_$P(^XWB(8994,XQRPC,0),U)_" is not registered to the option "_$P(^DIC(19,XQOPT,0),U)_"." Q
"RTN","XQCS",77,0)
 ; S %=$O(^DIC(19,XQOPT,"RPC","B",XQRPC,0)),XQKEY=$P(^DIC(19,XQOPT,"RPC",%,0),U,2)
"RTN","XQCS",78,0)
 S XQKEY=$P(^TMP("XQCS",$J,XQRPC,0),U,2)
"RTN","XQCS",79,0)
 I $L(XQKEY) I '$D(^XUSEC(XQKEY,XQUSR)) S XQMES="Remote procedure is locked." Q
"RTN","XQCS",80,0)
 ;
"RTN","XQCS",81,0)
RULES ;Check the rules for this RPC
"RTN","XQCS",82,0)
 ;S %=$O(^DIC(19,XQOPT,"RPC","B",XQRPC,0))
"RTN","XQCS",83,0)
 ;I $D(^DIC(19,XQOPT,"RPC",%,1)),$L(^(1)) D
"RTN","XQCS",84,0)
 I $D(^TMP("XQCS",$J,XQRPC,1)),$L(^(1)) D
"RTN","XQCS",85,0)
 . S XQRPCOK=1
"RTN","XQCS",86,0)
 . X ^TMP("XQCS",$J,XQRPC,1)
"RTN","XQCS",87,0)
 . I XQRPCOK<1 S XQMES="Remote procedure request failed rules test."
"RTN","XQCS",88,0)
 . Q
"RTN","XQCS",89,0)
 Q
"RTN","XQCS",90,0)
 ;
"RTN","XQCS",91,0)
 ;
"RTN","XQCS",92,0)
 ;
"RTN","XQCS",93,0)
USER ;See if XQUSR has been assigned access this option or not
"RTN","XQCS",94,0)
 ;
"RTN","XQCS",95,0)
 N XQYES
"RTN","XQCS",96,0)
 S XQMES=1,(XQSMY,%,XQYES)=0
"RTN","XQCS",97,0)
 ;
"RTN","XQCS",98,0)
TOP ;See if XQOPT is on top level of a tree: primary, secondary, or common
"RTN","XQCS",99,0)
 S XQPM=+$G(^VA(200,XQUSR,201)) I XQOPT=XQPM Q
"RTN","XQCS",100,0)
 ;
"RTN","XQCS",101,0)
 ;Check the Common Options (XUCOMMAND)
"RTN","XQCS",102,0)
 I $D(^DIC(19,"B","XUCOMMAND")) D
"RTN","XQCS",103,0)
 . N XQCOM
"RTN","XQCS",104,0)
 . S XQCOM=$O(^DIC(19,"B","XUCOMMAND",0))
"RTN","XQCS",105,0)
 . I $D(^DIC(19,XQCOM,10,"B",XQOPT)) S XQYES=1
"RTN","XQCS",106,0)
 . I XQYES Q
"RTN","XQCS",107,0)
 . I '$D(^XUTL("XQO","PXU",0)) S %=$$BUILD("PXU")
"RTN","XQCS",108,0)
 . I $D(^XUTL("XQO","PXU","^",XQOPT)) S XQYES=1
"RTN","XQCS",109,0)
 . Q
"RTN","XQCS",110,0)
 I XQYES Q
"RTN","XQCS",111,0)
 ;
"RTN","XQCS",112,0)
 ;
"RTN","XQCS",113,0)
 I $D(^VA(200,XQUSR,203,0)),$P(^(0),U,4)>0 S XQSMY=1 D
"RTN","XQCS",114,0)
 . S XQDIC="U"_XQUSR I $S('$D(^XUTL("XQO",XQDIC,0)):1,'$D(^VA(200,XQUSR,203.1)):1,1:^VA(200,XQUSR,203.1)'=$P(^XUTL("XQO",XQDIC,0),U,2)) D ^XQSET
"RTN","XQCS",115,0)
 . S (XQSM,%)=0
"RTN","XQCS",116,0)
 . F  Q:%  S XQSM=$O(^XUTL("XQO",XQDIC,"^",XQSM)) Q:XQSM=""  I XQSM=XQOPT S XQYES=1 Q
"RTN","XQCS",117,0)
 . Q
"RTN","XQCS",118,0)
 I XQYES Q
"RTN","XQCS",119,0)
 ;
"RTN","XQCS",120,0)
DEEP ;See if it's under the top somewhere - start with primary tree
"RTN","XQCS",121,0)
 I XQPM>0 D
"RTN","XQCS",122,0)
 .S XQDIC="P"_XQPM
"RTN","XQCS",123,0)
 .S XQYES=$S($D(^XUTL("XQO",XQDIC,"^",XQOPT)):1,$D(^DIC(19,"AXQ",XQDIC,"^",XQOPT)):1,1:0)
"RTN","XQCS",124,0)
 .Q
"RTN","XQCS",125,0)
 I XQYES Q
"RTN","XQCS",126,0)
 ;
"RTN","XQCS",127,0)
 ;Check secondary trees
"RTN","XQCS",128,0)
 S (XQSM,%)=0
"RTN","XQCS",129,0)
 I XQSMY F  Q:XQYES  S XQSM=$O(^XUTL("XQO","U"_XQUSR,"^",XQSM)) Q:XQSM=""  D
"RTN","XQCS",130,0)
 .S XQDIC="P"_XQSM
"RTN","XQCS",131,0)
 .S XQYES=$S($D(^XUTL("XQO",XQDIC,"^",XQOPT)):1,$D(^DIC(19,"AXQ",XQDIC,"^",XQOPT)):1,1:0)
"RTN","XQCS",132,0)
 . Q
"RTN","XQCS",133,0)
 I XQYES Q
"RTN","XQCS",134,0)
 ;
"RTN","XQCS",135,0)
 I $L(XQMES<5) S XQMES="User "_$P(^VA(200,XQUSR,0),U)_" does not have access to option "_$P(^DIC(19,XQOPT,0),U)
"RTN","XQCS",136,0)
 Q
"RTN","XQCS",137,0)
 ;
"RTN","XQCS",138,0)
 ;End of main program
"RTN","XQCS",139,0)
 ;
"RTN","XQCS",140,0)
BUILD(XQDIC)   ;A missing ^XUTL node brings us here
"RTN","XQCS",141,0)
 I $D(^DIC(19,"AXQ",XQDIC)) D
"RTN","XQCS",142,0)
 .L +^DIC(19,"AXQ",XQDIC):5
"RTN","XQCS",143,0)
 .I '$D(^XUTL("XQO",XQDIC)) M ^XUTL("XQO",XQDIC)=^DIC(19,"AXQ",XQDIC)
"RTN","XQCS",144,0)
 .L -^DIC(19,"AXQ",XQDIC)
"RTN","XQCS",145,0)
 .Q
"RTN","XQCS",146,0)
 I $D(^XUTL("XQO",XQDIC,0)) Q 1
"RTN","XQCS",147,0)
 ;
"RTN","XQCS",148,0)
 ;If they are not even in ^DIC the make them from scratch
"RTN","XQCS",149,0)
 I '$D(^DIC(19,"AXQ",XQDIC)) D
"RTN","XQCS",150,0)
 .;D REACT^XQ84(DUZ)
"RTN","XQCS",151,0)
 .S XQMES="Your menus are being rebuilt.  Please try again later."
"RTN","XQCS",152,0)
 Q 0
"VER")
8.0^22.0
**END**
**END**
