Released IB*2*237 SEQ #227
Extracted from mail message
**KIDS**:IB*2.0*237^

**INSTALL NAME**
IB*2.0*237
"BLD",4939,0)
IB*2.0*237^INTEGRATED BILLING^0^3031023^y
"BLD",4939,1,0)
^^2^2^3030730^
"BLD",4939,1,1,0)
This patch adds patient information to an INTEGRATED BILLING BACKGROUND
"BLD",4939,1,2,0)
ERROR message.
"BLD",4939,4,0)
^9.64PA^^
"BLD",4939,"KRN",0)
^9.67PA^8989.52^19
"BLD",4939,"KRN",.4,0)
.4
"BLD",4939,"KRN",.401,0)
.401
"BLD",4939,"KRN",.402,0)
.402
"BLD",4939,"KRN",.403,0)
.403
"BLD",4939,"KRN",.5,0)
.5
"BLD",4939,"KRN",.84,0)
.84
"BLD",4939,"KRN",3.6,0)
3.6
"BLD",4939,"KRN",3.8,0)
3.8
"BLD",4939,"KRN",9.2,0)
9.2
"BLD",4939,"KRN",9.8,0)
9.8
"BLD",4939,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",4939,"KRN",9.8,"NM",1,0)
IBARX^^0^B50649768
"BLD",4939,"KRN",9.8,"NM",2,0)
IBARXMC^^0^B43160101
"BLD",4939,"KRN",9.8,"NM","B","IBARX",1)

"BLD",4939,"KRN",9.8,"NM","B","IBARXMC",2)

"BLD",4939,"KRN",19,0)
19
"BLD",4939,"KRN",19.1,0)
19.1
"BLD",4939,"KRN",101,0)
101
"BLD",4939,"KRN",409.61,0)
409.61
"BLD",4939,"KRN",771,0)
771
"BLD",4939,"KRN",870,0)
870
"BLD",4939,"KRN",8989.51,0)
8989.51
"BLD",4939,"KRN",8989.52,0)
8989.52
"BLD",4939,"KRN",8994,0)
8994
"BLD",4939,"KRN","B",.4,.4)

"BLD",4939,"KRN","B",.401,.401)

"BLD",4939,"KRN","B",.402,.402)

"BLD",4939,"KRN","B",.403,.403)

"BLD",4939,"KRN","B",.5,.5)

"BLD",4939,"KRN","B",.84,.84)

"BLD",4939,"KRN","B",3.6,3.6)

"BLD",4939,"KRN","B",3.8,3.8)

"BLD",4939,"KRN","B",9.2,9.2)

"BLD",4939,"KRN","B",9.8,9.8)

"BLD",4939,"KRN","B",19,19)

"BLD",4939,"KRN","B",19.1,19.1)

"BLD",4939,"KRN","B",101,101)

"BLD",4939,"KRN","B",409.61,409.61)

"BLD",4939,"KRN","B",771,771)

"BLD",4939,"KRN","B",870,870)

"BLD",4939,"KRN","B",8989.51,8989.51)

"BLD",4939,"KRN","B",8989.52,8989.52)

"BLD",4939,"KRN","B",8994,8994)

"BLD",4939,"QUES",0)
^9.62^^
"BLD",4939,"REQB",0)
^9.611^1^1
"BLD",4939,"REQB",1,0)
IB*2.0*186^1
"BLD",4939,"REQB","B","IB*2.0*186",1)

"MBREQ")
0
"PKG",200,-1)
1^1
"PKG",200,0)
INTEGRATED BILLING^IB^INTEGRATED BILLING
"PKG",200,20,0)
^9.402P^1^1
"PKG",200,20,1,0)
2^^IBAXDR
"PKG",200,20,1,1)

"PKG",200,20,"B",2,1)

"PKG",200,22,0)
^9.49I^1^1
"PKG",200,22,1,0)
2.0^2940321^2990406^2447
"PKG",200,22,1,"PAH",1,0)
237^3031023^12463
"PKG",200,22,1,"PAH",1,1,0)
^^2^2^3031023
"PKG",200,22,1,"PAH",1,1,1,0)
This patch adds patient information to an INTEGRATED BILLING BACKGROUND
"PKG",200,22,1,"PAH",1,1,2,0)
ERROR message.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","IBARX")
0^1^B50649768
"RTN","IBARX",1,0)
IBARX ;ALB/AAS-INTEGRATED BILLING, PHARMACY COPAY INTERFACE ;14-FEB-91
"RTN","IBARX",2,0)
 ;;2.0;INTEGRATED BILLING;**101,150,156,168,186,237**;21-MAR-94
"RTN","IBARX",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBARX",4,0)
 ;
"RTN","IBARX",5,0)
XTYPE ; - tag XTYPE - returns array of billable action types for service
"RTN","IBARX",6,0)
 ;  - see IBARXDOC for documentation
"RTN","IBARX",7,0)
 ;
"RTN","IBARX",8,0)
X1 K Y D INSTAL I '$T S Y=-1 Q
"RTN","IBARX",9,0)
 N I,J,X1,X2,DA,DFN S Y=1,IBSAVX=X,IBTAG=1,IBWHER=5
"RTN","IBARX",10,0)
 ;
"RTN","IBARX",11,0)
 D CHKX^IBAUTL G:+Y<1 XTYPEQ
"RTN","IBARX",12,0)
 ;
"RTN","IBARX",13,0)
 I '$D(^IBE(350.1,"ANEW",IBSERV,1,1)) D  S Y=-1 G XTYPEQ
"RTN","IBARX",14,0)
 .I '$D(ZTQUEUED) W !!,*7,"WARNING: Pharmacy Copay not working,",!,"         Check IB SERVICE/SECTION in Pharmacy Site File.",!!
"RTN","IBARX",15,0)
 .D E3^IBAERR
"RTN","IBARX",16,0)
 ;
"RTN","IBARX",17,0)
 N X D ELIG^VADPT,INP^VADPT,DOM S Y=1
"RTN","IBARX",18,0)
 F I=0:0 S I=$O(^IBE(350.1,"ANEW",IBSERV,1,I)) Q:'I  I $D(^IBE(350.1,I,40)) S DA=I X ^IBE(350.1,DA,40) S Y(DA,X)=I_"^"_X1_"^"_X2
"RTN","IBARX",19,0)
 ;
"RTN","IBARX",20,0)
XTYPEQ K X1,X2,IBSERV,VAEL,VA,VAERR,IBDOM,VAIN,IBSAVX,IBTAG,IBWHER
"RTN","IBARX",21,0)
 Q
"RTN","IBARX",22,0)
 ;
"RTN","IBARX",23,0)
DOM S IBDOM=0 I $D(VAIN(4)),$D(^DIC(42,+VAIN(4),0)),$P(^(0),"^",3)="D" S IBDOM=1
"RTN","IBARX",24,0)
 Q
"RTN","IBARX",25,0)
NEW ;  - process new/renew/refill rx for charges
"RTN","IBARX",26,0)
 ;  - see IBARXDOC for documentation
"RTN","IBARX",27,0)
 ;
"RTN","IBARX",28,0)
N1 K Y,IBSAVX D INSTAL I '$T S Y=-1 Q
"RTN","IBARX",29,0)
 N I,J,X1,X2,DA,DFN,IBEXMP
"RTN","IBARX",30,0)
 S IBWHER=1,IBSAVX=X,Y=1,IBTAG=2 D CHKX^IBAUTL I +Y<1 G NEWQ
"RTN","IBARX",31,0)
 I $D(X)<11 S Y="-1^IB010" G NEWQ
"RTN","IBARX",32,0)
 S J="" F  S J=$O(X(J)) Q:J=""  S IBSAVX(J)=X(J)
"RTN","IBARX",33,0)
 D ARPARM^IBAUTL I +Y<1 G NEWQ
"RTN","IBARX",34,0)
 ;
"RTN","IBARX",35,0)
 ; -- check rx exemption in case refill is exempt
"RTN","IBARX",36,0)
 ; -- if exempt set amount to each rx and total to zero
"RTN","IBARX",37,0)
 ;    1= exempt, 0= non-exempt, -1=copay off (manila)
"RTN","IBARX",38,0)
 S IBEXMP=+$$RXEXMT^IBARXEU0(DFN,DT)
"RTN","IBARX",39,0)
 I IBEXMP'=0 D  S Y="1^0" G NEWQ
"RTN","IBARX",40,0)
 .S IBJ=""
"RTN","IBARX",41,0)
 .; changed return value 6th piece is the exempt flag
"RTN","IBARX",42,0)
 .F  S IBJ=$O(IBSAVX(IBJ)) Q:IBJ=""  S $P(Y(IBJ),"^",6)=IBEXMP
"RTN","IBARX",43,0)
 .Q
"RTN","IBARX",44,0)
 ;
"RTN","IBARX",45,0)
 ; check to see if billing has been tracked across facilities before,
"RTN","IBARX",46,0)
 ; if not, start now.
"RTN","IBARX",47,0)
 D TRACK^IBARXMN(DFN) I +Y<1 G NEWQ
"RTN","IBARX",48,0)
 ;
"RTN","IBARX",49,0)
 S IBTOTL=0
"RTN","IBARX",50,0)
 D BILLNO^IBAUTL I +Y<1 G NEWQ
"RTN","IBARX",51,0)
 ;
"RTN","IBARX",52,0)
 S IBTOTL=0,IBJ="",IBSEQNO=$P(^IBE(350.1,IBATYP,0),"^",5) I 'IBSEQNO S Y="-1^IB023" G NEWQ
"RTN","IBARX",53,0)
 F  S IBJ=$O(IBSAVX(IBJ)) Q:IBJ=""  S IBX=IBSAVX(IBJ) D RX^IBARX1
"RTN","IBARX",54,0)
 I +Y<1 G NEWQ
"RTN","IBARX",55,0)
 ;
"RTN","IBARX",56,0)
 ; changed to only do if charge exists
"RTN","IBARX",57,0)
 D:IBTOTL ^IBAFIL
"RTN","IBARX",58,0)
 ;
"RTN","IBARX",59,0)
 S IBJ="" F  S IBJ=$O(IBSAVY(IBJ)) Q:IBJ=""  S Y(IBJ)=IBSAVY(IBJ)
"RTN","IBARX",60,0)
 S:+Y>0 Y="1^"_IBTOTL S X=IBSAVX
"RTN","IBARX",61,0)
 ;
"RTN","IBARX",62,0)
NEWQ D:+Y<1 ^IBAERR
"RTN","IBARX",63,0)
 D END
"RTN","IBARX",64,0)
 Q
"RTN","IBARX",65,0)
 ;
"RTN","IBARX",66,0)
INSTAL I $S($D(^IBE(350.9,1,0)):1,$D(^IB(0)):1,1:0)
"RTN","IBARX",67,0)
 Q
"RTN","IBARX",68,0)
 ;
"RTN","IBARX",69,0)
CANCEL ;  - cancel charges for a rx
"RTN","IBARX",70,0)
 ;  - see IBARXDOC for documentation
"RTN","IBARX",71,0)
 ;
"RTN","IBARX",72,0)
C1 K Y,IBSAVX N I,J,X1,X2,DA,DFN I '$G(IBUPDATE) N IBCAP,IBAMP,IBSAVXMC
"RTN","IBARX",73,0)
 S IBWHER=1,IBSAVX=X,Y=1,IBTAG=3 D CHKX^IBAUTL I +Y<1 G CANQ
"RTN","IBARX",74,0)
 I $D(X)<11 S Y="-1^IB010" G CANQ
"RTN","IBARX",75,0)
 S J="" F  S J=$O(X(J)) Q:J=""  S IBSAVX(J)=X(J)
"RTN","IBARX",76,0)
 D ARPARM^IBAUTL I +Y<1 G CANQ
"RTN","IBARX",77,0)
 ;
"RTN","IBARX",78,0)
 S IBJ="",IBTOTL=0
"RTN","IBARX",79,0)
 F  S IBJ=$O(IBSAVX(IBJ)) Q:IBJ=""  S IBX=IBSAVX(IBJ) D CANRX^IBARX1 I +IBY(IBJ)'<1 D ^IBAFIL:$P(IBND,"^",5)'=8 I +Y<1 S IBY(IBJ)=Y
"RTN","IBARX",80,0)
 I +Y<1 S IBT="",IBY=Y,IBM="" F  S IBM=$O(IBY(IBM)) Q:IBM=""  I +IBY(IBM)<1 S Y=IBY(IBM) D ^IBAERR S Y(IBM)=IBY(IBM),Y=IBY
"RTN","IBARX",81,0)
CANQ D:+Y<1 ^IBAERR:('$D(IBT))
"RTN","IBARX",82,0)
 S X=IBSAVX
"RTN","IBARX",83,0)
 M IBSAVXMC=Y
"RTN","IBARX",84,0)
 D END
"RTN","IBARX",85,0)
 ;
"RTN","IBARX",86,0)
 ; now that I have cancelled lets see if there are some to be billed
"RTN","IBARX",87,0)
 I '$G(IBUPDATE),$D(IBCAP)>10 D QCAN^IBARXMC(DFN,.IBCAP,.IBSAVXMC)
"RTN","IBARX",88,0)
 ;S IBD=0 F  S IBD=$O(IBCAP(IBD)) Q:IBD<1  D CANCEL^IBARXMC(DFN,IBD)
"RTN","IBARX",89,0)
 Q
"RTN","IBARX",90,0)
 ;
"RTN","IBARX",91,0)
UPDATE ;  - will cancel current open charge and create updated entry
"RTN","IBARX",92,0)
 ;  - see IBARXDOC for documentation
"RTN","IBARX",93,0)
 ;
"RTN","IBARX",94,0)
U1 K Y,IBSAVX N I,J,X1,X2,DA,DFN,IBEXMP,IBUPDATE,IBCAP,IBEFDT,IBAMP,IBSAVXMC
"RTN","IBARX",95,0)
 S IBUPDATE=1  ; new flag so we know we are updating
"RTN","IBARX",96,0)
 S IBWHER=1,IBSAVX=X,Y=1,IBTAG=4 D CHKX^IBAUTL I +Y<1 G UPDQ
"RTN","IBARX",97,0)
 S IBSAVXU=IBSAVX
"RTN","IBARX",98,0)
 I $D(X)<11 S Y="-1^IB010" G UPDQ
"RTN","IBARX",99,0)
 S J="" F  S J=$O(X(J)) Q:J=""  S IBSAVXU(J)=X(J),X(J)=$P(X(J),"^",3,4) D EFDT^IBARXMU($P(X(J),"^"),.IBEFDT)
"RTN","IBARX",100,0)
 ;
"RTN","IBARX",101,0)
 D CANCEL
"RTN","IBARX",102,0)
U2 K X
"RTN","IBARX",103,0)
 S X=IBSAVXU S J="" F  S J=$O(IBSAVXU(J)) Q:J=""  S X(J)=$P(IBSAVXU(J),"^",1,3)
"RTN","IBARX",104,0)
 S IBSAVX=X,Y=1,IBTAG=4 D CHKX^IBAUTL I +Y<1 G UPDQ
"RTN","IBARX",105,0)
 D ARPARM^IBAUTL I +Y<1 G UPDQ
"RTN","IBARX",106,0)
 ;
"RTN","IBARX",107,0)
 ; -- check rx exemption in case refill is exempt
"RTN","IBARX",108,0)
 ; -- if exempt set amount to each rx and total to zero
"RTN","IBARX",109,0)
 S IBEXMP=+$$RXEXMT^IBARXEU0(DFN,DT)
"RTN","IBARX",110,0)
 I IBEXMP'=0 D  S Y="1^0" G UPDQ
"RTN","IBARX",111,0)
 .; changed return value 6th piece is the exempt flag
"RTN","IBARX",112,0)
 .S IBJ="" F  S IBJ=$O(IBSAVXU(IBJ)) Q:IBJ=""  S $P(Y(IBJ),"^",6)=IBEXMP
"RTN","IBARX",113,0)
 .Q
"RTN","IBARX",114,0)
 ;
"RTN","IBARX",115,0)
 S IBATYP=$P(^IBE(350.1,+IBATYP,0),"^",7) I '$D(^IBE(350.1,+IBATYP,0)) S Y="-1^IB008" G UPDQ ;update type action
"RTN","IBARX",116,0)
 ;
"RTN","IBARX",117,0)
 D BILLNO^IBAUTL G:+Y<1 UPDQ
"RTN","IBARX",118,0)
 S IBTOTL=0,IBNOS="",IBSEQNO=$P(^IBE(350.1,IBATYP,0),"^",5) I 'IBSEQNO S Y="-1^IB023" G UPDQ
"RTN","IBARX",119,0)
 S IBJ="" F  S IBJ=$O(IBSAVXU(IBJ)) Q:IBJ=""  S IBX=IBSAVXU(IBJ) S:$D(IBEFDT(+$P(IBX,"^",3))) IBEFDT=IBEFDT(+$P(IBX,"^",3)) D UCHPAR,RX^IBARX1:'$D(IBSAVY(IBJ)) S IBEFDT=0
"RTN","IBARX",120,0)
 D ^IBAFIL
"RTN","IBARX",121,0)
 ;
"RTN","IBARX",122,0)
 S IBJ="" F  S IBJ=$O(IBSAVY(IBJ)) Q:IBJ=""  S Y(IBJ)=IBSAVY(IBJ),$P(Y(IBJ),"^",6)=+$G(IBEXMP) S:+Y(IBJ)<1 Y=Y(IBJ)
"RTN","IBARX",123,0)
 S:+Y>0 Y="1^"_IBTOTL S X=IBSAVXU
"RTN","IBARX",124,0)
 ;
"RTN","IBARX",125,0)
 ; now that I have the update done lets see if there are some to be billed
"RTN","IBARX",126,0)
 I $D(IBCAP)>10 D QCAN^IBARXMC(DFN,.IBCAP,.IBSAVXMC)
"RTN","IBARX",127,0)
 ;S IBD=0 F  S IBD=$O(IBCAP(IBD)) Q:IBD<1  D CANCEL^IBARXMC(DFN,IBD)
"RTN","IBARX",128,0)
 ;
"RTN","IBARX",129,0)
UPDQ D:+Y<1 ^IBAERR
"RTN","IBARX",130,0)
 K IBSAVXU
"RTN","IBARX",131,0)
END K %,%H,%I,K,X1,X2,X3,IBSERV,IBATYP,IBAFY,IBDUZ,IBNOW,IBSAVX,IBTOTL,IBX,IBT,IBCHRG,IBDESC,IBFAC,IBIL,IBN,IBNOS,IBSEQNO,IBSITE,IBTAG,IBTRAN,IBCRES,IBJ,IBLAST,IBND,IBY,IBPARNT,IBUNIT,IBJ,IBARTYP,IBI,IBSAVY,IBWHER
"RTN","IBARX",132,0)
 Q
"RTN","IBARX",133,0)
UCHPAR ; Check that IB action and its parent exist.
"RTN","IBARX",134,0)
 S IBPARNT=$P(IBX,"^",3)
"RTN","IBARX",135,0)
 I '$D(^IB(+IBPARNT,0)) S IBSAVY(IBJ)="-1^IB021" G UCHPARQ
"RTN","IBARX",136,0)
 S IBPARNT=$P(^IB(+IBPARNT,0),"^",9)
"RTN","IBARX",137,0)
 I '$D(^IB(+IBPARNT,0)) S IBSAVY(IBJ)="-1^IB027"
"RTN","IBARX",138,0)
UCHPARQ Q
"RTN","IBARX",139,0)
 ;
"RTN","IBARX",140,0)
STATUS(X) ; returns the status of a transaction in 350
"RTN","IBARX",141,0)
 ;  - see IBARXDOC for documentation
"RTN","IBARX",142,0)
 ;
"RTN","IBARX",143,0)
 N Y S Y=$G(^IB(X,0))
"RTN","IBARX",144,0)
 Q +$S($P(Y,"^",5)=10:2,1:$P($G(^IBE(350.1,+$P(Y,"^",3),0)),"^",5))
"RTN","IBARX",145,0)
 ;
"RTN","IBARX",146,0)
CANIBAM ; used by pso to cancel a 354.71 transaction
"RTN","IBARX",147,0)
 ;  - see IBARXDOC for documentation
"RTN","IBARX",148,0)
 N IBZ,IBXX,IBYY,IBCAP
"RTN","IBARX",149,0)
 M IBXX=X
"RTN","IBARX",150,0)
 S IBXX=0 F  S IBXX=$O(IBXX(IBXX)) Q:IBXX=""  D
"RTN","IBARX",151,0)
 . N IBY
"RTN","IBARX",152,0)
 . S IBZ=$G(^IBAM(354.71,+IBXX(IBXX),0))
"RTN","IBARX",153,0)
 . I $P(IBZ,"^",4) S IBYY(IBXX)="-1^Transaction has been billed" Q
"RTN","IBARX",154,0)
 . I $P(IBZ,"^",5)="Y"!($P(IBZ,"^",5)="X") S IBYY(IBXX)="-1^Transaction already cancelled" Q
"RTN","IBARX",155,0)
 . S IBZ=$$CANCEL^IBARXMN($P(IBZ,"^",2),+IBXX(IBXX),.IBY,$P(IBXX(IBXX),"^",2))
"RTN","IBARX",156,0)
 . S IBYY(IBXX)=$S($P($G(IBY),"^")=-1:IBY,1:IBZ)
"RTN","IBARX",157,0)
 K Y M Y=IBYY
"RTN","IBARX",158,0)
 Q
"RTN","IBARX",159,0)
 ;
"RTN","IBARX",160,0)
UPIBAM ;  - will cancel current potential charge and create updated entry
"RTN","IBARX",161,0)
 ;  - see IBARXDOC for documentation
"RTN","IBARX",162,0)
 ;
"RTN","IBARX",163,0)
 N IBXX,IBYY,IBWHER,IBTAG,IBZ,IBX,IBY,IBSAVX,IBA,IBAM,IBATYP,IBCAP,IBDESC,IBDUZ,IBSERV,IBTCH
"RTN","IBARX",164,0)
 M IBXX=X
"RTN","IBARX",165,0)
 S IBA=$O(X("")) I IBA="" S (Y)="-1^Invalid Subscript in X" Q
"RTN","IBARX",166,0)
 S IBWHER=1,Y=1,IBTAG=4,IBSAVX=X D CHKX^IBAUTL I +Y<1 S Y(IBA)=Y Q
"RTN","IBARX",167,0)
 S IBZ=$G(^IBAM(354.71,+$P($G(IBXX(IBA)),"^",3),0))
"RTN","IBARX",168,0)
 ;
"RTN","IBARX",169,0)
 ; check out the transaction sent
"RTN","IBARX",170,0)
 I 'IBZ S (Y,Y(IBA))="-1^Not a valid transaction number" Q
"RTN","IBARX",171,0)
 I $P(IBZ,"^",4) S (Y,Y(IBA))="-1^Transaction has been billed" Q
"RTN","IBARX",172,0)
 I $P(IBZ,"^",5)="Y"!($P(IBZ,"^",5)="X") S (Y,Y(IBA))="-1^Transaction already cancelled" Q
"RTN","IBARX",173,0)
 ;
"RTN","IBARX",174,0)
 ; cancel that transaction
"RTN","IBARX",175,0)
 S IBX=$$CANCEL^IBARXMN($P(IBZ,"^",2),$P($G(IBXX(IBA)),"^",3),.Y,$P(IBXX(IBA),"^",4)) I +Y<1 S Y(IBA)=Y Q
"RTN","IBARX",176,0)
 ;
"RTN","IBARX",177,0)
 ; create the new updated transaction
"RTN","IBARX",178,0)
 S IBX=IBXX(IBA) D BDESC^IBARX1 S IBATYP=$P(^IBE(350.1,+IBATYP,0),"^",7),DA=IBATYP D COST^IBAUTL S IBTCH=$P(IBX,"^",2)*X1
"RTN","IBARX",179,0)
 S IBAM=$$ADD^IBARXMN($P(IBZ,"^",2),"^^"_$P(IBZ,"^",3)_"^^P^"_$P(IBXX(IBA),"^")_"^"_$P(IBXX(IBA),"^",2)_"^"_IBTCH_"^"_IBDESC_"^"_$$PARENT^IBARXMC($P(IBXX(IBA),"^",3))_"^0^"_IBTCH_"^"_(+$P($$SITE^IBARXMU,"^",3)),IBATYP)
"RTN","IBARX",180,0)
 I IBAM<1 S (Y,Y(IBA))="-1^IB316" Q
"RTN","IBARX",181,0)
 ;
"RTN","IBARX",182,0)
 S Y(IBA)=IBAM,Y=1
"RTN","IBARX",183,0)
 ;
"RTN","IBARX",184,0)
 Q
"RTN","IBARXMC")
0^2^B43160101
"RTN","IBARXMC",1,0)
IBARXMC ;LL/ELZ-PHARMACY COPAY CAP FUNCTIONS ;26-APR-2001
"RTN","IBARXMC",2,0)
 ;;2.0;INTEGRATED BILLING;**156,186,237**;21-MAR-94
"RTN","IBARXMC",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IBARXMC",4,0)
 ;
"RTN","IBARXMC",5,0)
NEW(IBQ,IBC,IBD,IBB,IBN) ; used to compute new bills amount above cap
"RTN","IBARXMC",6,0)
 ; DFN is assumed
"RTN","IBARXMC",7,0)
 ; IBQ = quantity
"RTN","IBARXMC",8,0)
 ; IBC = charge per item
"RTN","IBARXMC",9,0)
 ; IBD = effective date
"RTN","IBARXMC",10,0)
 ;   Return:
"RTN","IBARXMC",11,0)
 ; IBB = Amount to bill
"RTN","IBARXMC",12,0)
 ; IBN = Amount NOT to bill
"RTN","IBARXMC",13,0)
 ;
"RTN","IBARXMC",14,0)
 N IBA,IBA,IBZ,IBP,IBE,IBY,IBFD,IBTD
"RTN","IBARXMC",15,0)
 ;
"RTN","IBARXMC",16,0)
 S IBP=$$PRIORITY^IBARXMU(DFN)
"RTN","IBARXMC",17,0)
 D CAP(IBD,IBP,.IBZ,.IBY,.IBFD,.IBTD)
"RTN","IBARXMC",18,0)
 S IBA=$$BILLED(DFN,IBD,IBFD,IBTD),IBE=$P(IBA,"^",2)
"RTN","IBARXMC",19,0)
 S IBB=IBQ*IBC
"RTN","IBARXMC",20,0)
 S IBB=$S('IBZ:IBB,IBB+IBA>IBZ:$S(IBZ-IBA>0:IBZ-IBA,1:0),1:IBB) ; monthly
"RTN","IBARXMC",21,0)
 I IBB,IBY S IBB=$S(IBB+IBE>IBY:$S(IBY-IBE>0:IBY-IBE,1:0),1:IBB) ; yearly
"RTN","IBARXMC",22,0)
 S IBN=$S(IBQ*IBC=IBB:0,1:IBQ*IBC-IBB)
"RTN","IBARXMC",23,0)
 ;
"RTN","IBARXMC",24,0)
 Q
"RTN","IBARXMC",25,0)
 ;
"RTN","IBARXMC",26,0)
BILLED(DFN,IBD,IBFD,IBTD) ; returns about billed, format:  month^year
"RTN","IBARXMC",27,0)
 ; IBD = transaction date, IBFD = from date, IBTD = to date
"RTN","IBARXMC",28,0)
 N IBFY,IBX,IBM,IBY,IBZ
"RTN","IBARXMC",29,0)
 F IBX="IBD","IBFD","IBTD" S @IBX=$E(@IBX,1,5)_"00"
"RTN","IBARXMC",30,0)
 S IBX=+$O(^IBAM(354.7,DFN,1,"B",IBD,0))
"RTN","IBARXMC",31,0)
 S IBM=+$P($G(^IBAM(354.7,DFN,1,IBX,0)),"^",2)
"RTN","IBARXMC",32,0)
 S IBY=0,IBZ=IBFD-1 F  S IBZ=$O(^IBAM(354.7,DFN,1,"B",IBZ)) Q:IBZ<1!(IBZ>IBTD)  S IBX=$O(^IBAM(354.7,DFN,1,"B",IBZ,0)) I IBX S IBY=IBY+$P($G(^IBAM(354.7,DFN,1,IBX,0)),"^",2)
"RTN","IBARXMC",33,0)
 Q IBM_"^"_IBY
"RTN","IBARXMC",34,0)
 ;
"RTN","IBARXMC",35,0)
CAP(IBD,IBP,IBM,IBY,IBF,IBT) ; returns the cap amount and dates
"RTN","IBARXMC",36,0)
 ; IBD = date of transaction
"RTN","IBARXMC",37,0)
 ; IBP = priority level of patient
"RTN","IBARXMC",38,0)
 ;    return (by reference):
"RTN","IBARXMC",39,0)
 ; IBM = monthly cap amount
"RTN","IBARXMC",40,0)
 ; IBY = yearly cap amount
"RTN","IBARXMC",41,0)
 ; IBF = from date for yearly cap determination
"RTN","IBARXMC",42,0)
 ; IBT = to date for yearly cap determination
"RTN","IBARXMC",43,0)
 N IBX,IBDT
"RTN","IBARXMC",44,0)
 I $D(^IBAM(354.75,"AC",IBP,IBD)) S IBX=+$O(^(IBD,0)) G CAPC
"RTN","IBARXMC",45,0)
 S IBDT=+$O(^IBAM(354.75,"AC",IBP,IBD),-1),IBX=+$O(^(IBDT,0))
"RTN","IBARXMC",46,0)
CAPC ;
"RTN","IBARXMC",47,0)
 S IBX=$G(^IBAM(354.75,IBX,0))
"RTN","IBARXMC",48,0)
 I 'IBX!($P(IBX,"^",5)&(IBD>$P(IBX,"^",5))) S (IBM,IBY,IBF,IBT)=0 Q
"RTN","IBARXMC",49,0)
 S IBM=$P(IBX,"^",3),IBY=$P(IBX,"^",4)
"RTN","IBARXMC",50,0)
 S IBDT=$P($$FYCY^IBCU8(IBD),"^",$S($P(IBX,"^",6)="C":1,1:3),$S($P(IBX,"^",6)="C":2,1:4))
"RTN","IBARXMC",51,0)
 S IBF=$S($P(IBDT,"^")>IBX:$P(IBDT,"^"),1:+IBX)
"RTN","IBARXMC",52,0)
 S IBT=$S('$P(IBX,"^",5):$P(IBDT,"^",2),$P(IBDT,"^",2)<$P(IBX,"^",5):$P(IBDT,"^",2),1:$P(IBX,"^",5))
"RTN","IBARXMC",53,0)
 ;
"RTN","IBARXMC",54,0)
 Q
"RTN","IBARXMC",55,0)
 ;
"RTN","IBARXMC",56,0)
FLAG(DFN,IBD) ; flag account if at or above cap
"RTN","IBARXMC",57,0)
 ; IBD = date of transaction (mo/year fm format)
"RTN","IBARXMC",58,0)
 ; flag in account is set to:  2 = cap exceeded, some copays not billed
"RTN","IBARXMC",59,0)
 ;                             1 = cap reached
"RTN","IBARXMC",60,0)
 ;                             0 = below cap
"RTN","IBARXMC",61,0)
 ;
"RTN","IBARXMC",62,0)
 N IBC,IBB,IBZ,IBF,IBX,DIE,DR,DA,X,Y,IBFD,IBTD,IBY
"RTN","IBARXMC",63,0)
 S IBX=+$O(^IBAM(354.7,DFN,1,"B",IBD,0)) Q:'IBX
"RTN","IBARXMC",64,0)
 S IBZ=$G(^IBAM(354.7,DFN,1,IBX,0))
"RTN","IBARXMC",65,0)
 D CAP(IBD+1,+$$PRIORITY^IBARXMU(DFN),.IBC,.IBY,.IBFD,.IBTD)
"RTN","IBARXMC",66,0)
 S IBB=$$BILLED(DFN,IBD,IBFD,IBTD)
"RTN","IBARXMC",67,0)
 S IBF=$S('IBC&('IBY):0,$P(IBZ,"^",4):2,IBC=+IBB:1,IBY=$P(IBB,"^",2):1,1:0)
"RTN","IBARXMC",68,0)
 I IBF'=$P(IBZ,"^",3) S DIE="^IBAM(354.7,"_DFN_",1,",DA=IBX,DR=".03///^S X=IBF",DA(1)=DFN L +^IBAM(354.7,DFN):10 I $T D ^DIE L -^IBAM(354.7,DFN)
"RTN","IBARXMC",69,0)
 Q
"RTN","IBARXMC",70,0)
 ;
"RTN","IBARXMC",71,0)
PARENT(X) ; returns the parent entry in 354.71 for a transaction
"RTN","IBARXMC",72,0)
 Q +$P($G(^IBAM(354.71,X,0)),"^",10)
"RTN","IBARXMC",73,0)
 ;
"RTN","IBARXMC",74,0)
NET(X) ; returns net amount billed for a parent and its children
"RTN","IBARXMC",75,0)
 ; X = ien from 354.71 (parent or child) output: billed ^ un-billed
"RTN","IBARXMC",76,0)
 ;
"RTN","IBARXMC",77,0)
 N Y,Z,B,N,P S P=$$PARENT(X),(Y,B,N)=0 F  S Y=$O(^IBAM(354.71,"AF",P,Y)) Q:Y<1  S Z=^IBAM(354.71,Y,0),B=B+$P(Z,"^",11),N=N+$P(Z,"^",12)
"RTN","IBARXMC",78,0)
 Q B_"^"_N
"RTN","IBARXMC",79,0)
 ;
"RTN","IBARXMC",80,0)
CANCEL(DFN,IBDT) ; receives notification of a cancellation and determines
"RTN","IBARXMC",81,0)
 ; if more need to be billed.  IBDT should be in fm format date to check
"RTN","IBARXMC",82,0)
 ;
"RTN","IBARXMC",83,0)
 N IBT,IBTFL,IBX,IBD,IBFD,IBTD,IBDTQ,IBBIL,IBS1,IBS2
"RTN","IBARXMC",84,0)
 ;
"RTN","IBARXMC",85,0)
 ; first determine if cap reached or quit
"RTN","IBARXMC",86,0)
 ;Q:'$P($G(^IBAM(354.7,DFN,1,+$O(^IBAM(354.7,DFN,1,"B",IBDT,0)),0)),"^",3)
"RTN","IBARXMC",87,0)
 ;
"RTN","IBARXMC",88,0)
C1 ; get starting values
"RTN","IBARXMC",89,0)
 S IBS=+$$SITE^IBARXMU
"RTN","IBARXMC",90,0)
 S IBP=+$$PRIORITY^IBARXMU(DFN)
"RTN","IBARXMC",91,0)
 D CAP(IBDT+1,IBP,.IBZ,.IBY,.IBFD,.IBTD)
"RTN","IBARXMC",92,0)
 I ('IBY&('IBZ))!('IBFD)!('IBTD) Q
"RTN","IBARXMC",93,0)
 S IBA=$$BILLED(DFN,IBDT+1,IBFD,IBTD),IBE=$P(IBA,"^",2)
"RTN","IBARXMC",94,0)
 ;
"RTN","IBARXMC",95,0)
 ; query (if any) other facilities to see what is there.
"RTN","IBARXMC",96,0)
C2 S IBT=$$TFL^IBARXMU(DFN,.IBTFL)
"RTN","IBARXMC",97,0)
 I IBT W:'$D(ZTQUEUED) !,"This patient is being seen at other VA treating facilities. I need to make",!,"sure there are no Rx fills that have not been billed elsewhere." S IBX=0 F  S IBX=$O(IBTFL(IBX)) Q:IBX<1  D
"RTN","IBARXMC",98,0)
 . I '$D(ZTQUEUED) U IO W !,"Now sending queries to ",$P(IBTFL(IBX),"^",2)," ..."
"RTN","IBARXMC",99,0)
 . S IBDTQ=IBFD F  D  S IBDTQ=$$NEXTMO(IBDTQ) Q:IBDTQ>IBTD
"RTN","IBARXMC",100,0)
 .. D UQUERY^IBARXMU(DFN,$E(IBDTQ,1,5)_"00",+IBTFL(IBX),.IBD)
"RTN","IBARXMC",101,0)
 .. I $P(IBD(0),"^")=-1!(-1=+IBD) K IBD Q
"RTN","IBARXMC",102,0)
 .. S X=1 F  S X=$O(IBD(X)) Q:X<1  S IBD=$$ADD^IBARXMN(DFN,IBD(X))
"RTN","IBARXMC",103,0)
 .. K IBD
"RTN","IBARXMC",104,0)
 I '$D(ZTQUEUED) U IO
"RTN","IBARXMC",105,0)
 ;
"RTN","IBARXMC",106,0)
C3 K ^TMP("IBD",$J)
"RTN","IBARXMC",107,0)
 ; now lets see if there are some unbilled that can be billed.
"RTN","IBARXMC",108,0)
 S IBDTQ=IBFD F  D  S IBDTQ=$$NEXTMO(IBDTQ) Q:IBDTQ>IBTD
"RTN","IBARXMC",109,0)
 . S IBX=0 F  S IBX=$O(^IBAM(354.71,"AD",DFN,$E(IBDTQ,1,5)_"00",IBX)) Q:IBX<1  D
"RTN","IBARXMC",110,0)
 .. N IBZ S IBZ=^IBAM(354.71,IBX,0)
"RTN","IBARXMC",111,0)
 .. ;
"RTN","IBARXMC",112,0)
 .. ; check, am I the parent and still have some unbilled
"RTN","IBARXMC",113,0)
 .. I $P(IBZ,"^",10)'=IBX!('$P($$NET(IBX),"^",2)) Q
"RTN","IBARXMC",114,0)
 .. ;
"RTN","IBARXMC",115,0)
 .. ; ^TMP("IBD",$J format(date of transaction,date/time entry added,ien)
"RTN","IBARXMC",116,0)
 .. S ^TMP("IBD",$J,$P(IBZ,"^",3),$P(IBZ,"^",15),IBX)=IBZ
"RTN","IBARXMC",117,0)
 ;
"RTN","IBARXMC",118,0)
 I '$D(^TMP("IBD",$J)) W:'$D(ZTQUEUED) !,"No un-billed transactions exist" Q
"RTN","IBARXMC",119,0)
 ;
"RTN","IBARXMC",120,0)
 ; how much more can we bill
"RTN","IBARXMC",121,0)
C4 S IBB=$S('IBZ&('IBY):9999999,IBZ&((IBZ-IBA)<(IBY-IBE)):IBZ-IBA,1:IBY-IBE)
"RTN","IBARXMC",122,0)
 ;
"RTN","IBARXMC",123,0)
 ; we now have to bill some of the unbilled ones
"RTN","IBARXMC",124,0)
 S IBS1=0 F  S IBS1=$O(^TMP("IBD",$J,IBS1)) Q:IBS1<1  S IBS2=0 F  S IBS2=$O(^TMP("IBD",$J,IBS1,IBS2)) Q:IBS2<1  S IBX=0 F  S IBX=$O(^TMP("IBD",$J,IBS1,IBS2,IBX)) Q:IBX<1  D
"RTN","IBARXMC",125,0)
 . S IBZ=^TMP("IBD",$J,IBS1,IBS2,IBX)
"RTN","IBARXMC",126,0)
 . ;
"RTN","IBARXMC",127,0)
C5 . ; determine how much to bill (if any)
"RTN","IBARXMC",128,0)
 . S IBA=$$NET(IBX)
"RTN","IBARXMC",129,0)
 . S IBBIL=$S(IBB>$P(IBA,"^",2):$P(IBA,"^",2),1:IBB)
"RTN","IBARXMC",130,0)
 . I 'IBBIL S IBS1=9999999999 Q
"RTN","IBARXMC",131,0)
 . S IBB=IBB-IBBIL
"RTN","IBARXMC",132,0)
 . ;
"RTN","IBARXMC",133,0)
 . D @($S(IBS=+IBZ:"BILL",1:"SEND")_"^IBARXMB($P(IBZ,""^""),IBBIL)")
"RTN","IBARXMC",134,0)
 K ^TMP("IBD",$J)
"RTN","IBARXMC",135,0)
 Q
"RTN","IBARXMC",136,0)
 ;
"RTN","IBARXMC",137,0)
NEXTMO(DATE) ; returns first date of next month
"RTN","IBARXMC",138,0)
 N X S X="",DATE=$G(DATE)\1 I DATE'?7N G NEXTMOQ
"RTN","IBARXMC",139,0)
 S X=$S($E(DATE,4,5)<12:$E(DATE,1,5)+1_"01",1:$E(DATE,1,3)+1_"0101")
"RTN","IBARXMC",140,0)
NEXTMOQ Q X
"RTN","IBARXMC",141,0)
 ;
"RTN","IBARXMC",142,0)
QCAN(DFN,IBCAP,IBSAVXMC) ; queue off job to look for back billing in the background
"RTN","IBARXMC",143,0)
 N ZTRTN,ZTDTH,ZTIO,ZTDESC,ZTSK,ZTSAVE,Y,IBTAG
"RTN","IBARXMC",144,0)
 ;
"RTN","IBARXMC",145,0)
 S ZTRTN="DQCAN^IBARXMC",ZTDESC="IB Back Billing of Rx Copay Charges"
"RTN","IBARXMC",146,0)
 S ZTDTH=$$FMTH^XLFDT($$FMADD^XLFDT($$NOW^XLFDT,"","",10))
"RTN","IBARXMC",147,0)
 S (ZTSAVE("DFN"),ZTSAVE("IBCAP("),ZTSAVE("IBSAVXMC("),ZTIO)="" D ^%ZTLOAD
"RTN","IBARXMC",148,0)
 ;
"RTN","IBARXMC",149,0)
 I ZTSK<1 S IBTAG=3,Y="^^Error when trying to queue back billing job." D BULL^IBAERR
"RTN","IBARXMC",150,0)
 ;
"RTN","IBARXMC",151,0)
 Q
"RTN","IBARXMC",152,0)
 ;
"RTN","IBARXMC",153,0)
DQCAN ; entry point for queued back billing job
"RTN","IBARXMC",154,0)
 N IBD,IBL,IBPAT,IBREF,IBSSN,IBTAG,Y
"RTN","IBARXMC",155,0)
 ;
"RTN","IBARXMC",156,0)
 ; try to get a lock
"RTN","IBARXMC",157,0)
 S IBL=0 F X=1:1:10 L +^IBAM(354.7,"APAT",DFN):10 H:'$T 600 I $T S IBL=1 Q
"RTN","IBARXMC",158,0)
 I 'IBL D  Q
"RTN","IBARXMC",159,0)
 .S IBTAG=3
"RTN","IBARXMC",160,0)
 .S IBPAT=$P($G(^DPT(DFN,0)),"^",1) I IBPAT="" S IBPAT=DFN
"RTN","IBARXMC",161,0)
 .S IBSSN=$P($G(^DPT(DFN,0)),"^",9) I IBSSN="" S IBSSN="????"
"RTN","IBARXMC",162,0)
 .S (X,IBREF)=""
"RTN","IBARXMC",163,0)
 .F  S X=$O(IBSAVXMC(X)) Q:X=""  D
"RTN","IBARXMC",164,0)
 ..I IBREF'="" S IBREF=IBREF_", "_$P(IBSAVXMC(X),"^",1)
"RTN","IBARXMC",165,0)
 ..I IBREF="" S IBREF=$P(IBSAVXMC(X),"^",1)
"RTN","IBARXMC",166,0)
 .S Y="^^Unable to lock the IB PATIENT COPAY ACCOUNT (#354.7) file for back billing job related to "_IBPAT_" ("_IBSSN_") and IB reference number(s): "_IBREF_"."
"RTN","IBARXMC",167,0)
 .D ^IBAERR Q
"RTN","IBARXMC",168,0)
 ;
"RTN","IBARXMC",169,0)
 ; do query/back billing
"RTN","IBARXMC",170,0)
 S IBD=0 F  S IBD=$O(IBCAP(IBD)) Q:IBD<1  D CANCEL(DFN,IBD)
"RTN","IBARXMC",171,0)
 ;
"RTN","IBARXMC",172,0)
 ; remove lock
"RTN","IBARXMC",173,0)
 L -^IBAM(354.7,"APAT",DFN)
"RTN","IBARXMC",174,0)
 ;
"RTN","IBARXMC",175,0)
 Q
"VER")
8.0^22
**END**
**END**
