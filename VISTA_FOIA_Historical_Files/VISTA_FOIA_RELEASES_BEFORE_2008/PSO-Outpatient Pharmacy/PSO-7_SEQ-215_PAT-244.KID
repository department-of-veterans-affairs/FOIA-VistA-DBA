EMERGENCY Released PSO*7*244 SEQ #215
Extracted from mail message
**KIDS**:PSO*7.0*244^

**INSTALL NAME**
PSO*7.0*244
"BLD",6775,0)
PSO*7.0*244^OUTPATIENT PHARMACY^0^3060720^y
"BLD",6775,1,0)
^^2^2^3060424^
"BLD",6775,1,1,0)
Prevent newly Discontinued Rx's due to edit from being sent to the
"BLD",6775,1,2,0)
External Dispense Machines.
"BLD",6775,4,0)
^9.64PA^^
"BLD",6775,"ABPKG")
n
"BLD",6775,"KRN",0)
^9.67PA^8989.52^19
"BLD",6775,"KRN",.4,0)
.4
"BLD",6775,"KRN",.401,0)
.401
"BLD",6775,"KRN",.402,0)
.402
"BLD",6775,"KRN",.403,0)
.403
"BLD",6775,"KRN",.5,0)
.5
"BLD",6775,"KRN",.84,0)
.84
"BLD",6775,"KRN",3.6,0)
3.6
"BLD",6775,"KRN",3.8,0)
3.8
"BLD",6775,"KRN",9.2,0)
9.2
"BLD",6775,"KRN",9.8,0)
9.8
"BLD",6775,"KRN",9.8,"NM",0)
^9.68A^7^6
"BLD",6775,"KRN",9.8,"NM",2,0)
PSOBING1^^0^54041634
"BLD",6775,"KRN",9.8,"NM",3,0)
PSOLLLH^^0^24123418
"BLD",6775,"KRN",9.8,"NM",4,0)
PSOORED1^^0^67696730
"BLD",6775,"KRN",9.8,"NM",5,0)
PSOLBL^^0^70864785
"BLD",6775,"KRN",9.8,"NM",6,0)
PSOLBL4^^0^52469710
"BLD",6775,"KRN",9.8,"NM",7,0)
PSOLLLI^^0^66394524
"BLD",6775,"KRN",9.8,"NM","B","PSOBING1",2)

"BLD",6775,"KRN",9.8,"NM","B","PSOLBL",5)

"BLD",6775,"KRN",9.8,"NM","B","PSOLBL4",6)

"BLD",6775,"KRN",9.8,"NM","B","PSOLLLH",3)

"BLD",6775,"KRN",9.8,"NM","B","PSOLLLI",7)

"BLD",6775,"KRN",9.8,"NM","B","PSOORED1",4)

"BLD",6775,"KRN",19,0)
19
"BLD",6775,"KRN",19.1,0)
19.1
"BLD",6775,"KRN",101,0)
101
"BLD",6775,"KRN",409.61,0)
409.61
"BLD",6775,"KRN",771,0)
771
"BLD",6775,"KRN",870,0)
870
"BLD",6775,"KRN",8989.51,0)
8989.51
"BLD",6775,"KRN",8989.52,0)
8989.52
"BLD",6775,"KRN",8994,0)
8994
"BLD",6775,"KRN","B",.4,.4)

"BLD",6775,"KRN","B",.401,.401)

"BLD",6775,"KRN","B",.402,.402)

"BLD",6775,"KRN","B",.403,.403)

"BLD",6775,"KRN","B",.5,.5)

"BLD",6775,"KRN","B",.84,.84)

"BLD",6775,"KRN","B",3.6,3.6)

"BLD",6775,"KRN","B",3.8,3.8)

"BLD",6775,"KRN","B",9.2,9.2)

"BLD",6775,"KRN","B",9.8,9.8)

"BLD",6775,"KRN","B",19,19)

"BLD",6775,"KRN","B",19.1,19.1)

"BLD",6775,"KRN","B",101,101)

"BLD",6775,"KRN","B",409.61,409.61)

"BLD",6775,"KRN","B",771,771)

"BLD",6775,"KRN","B",870,870)

"BLD",6775,"KRN","B",8989.51,8989.51)

"BLD",6775,"KRN","B",8989.52,8989.52)

"BLD",6775,"KRN","B",8994,8994)

"BLD",6775,"QUES",0)
^9.62^^
"BLD",6775,"REQB",0)
^9.611^4^4
"BLD",6775,"REQB",1,0)
PSO*7.0*135^2
"BLD",6775,"REQB",2,0)
PSO*7.0*156^2
"BLD",6775,"REQB",3,0)
PSO*7.0*148^2
"BLD",6775,"REQB",4,0)
PSO*7.0*157^2
"BLD",6775,"REQB","B","PSO*7.0*135",1)

"BLD",6775,"REQB","B","PSO*7.0*148",3)

"BLD",6775,"REQB","B","PSO*7.0*156",2)

"BLD",6775,"REQB","B","PSO*7.0*157",4)

"MBREQ")
0
"PKG",134,-1)
1^1
"PKG",134,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",134,20,0)
^9.402P^^
"PKG",134,22,0)
^9.49I^1^1
"PKG",134,22,1,0)
7.0^2971216^2980417^1271
"PKG",134,22,1,"PAH",1,0)
244^3060720
"PKG",134,22,1,"PAH",1,1,0)
^^2^2^3060720
"PKG",134,22,1,"PAH",1,1,1,0)
Prevent newly Discontinued Rx's due to edit from being sent to the
"PKG",134,22,1,"PAH",1,1,2,0)
External Dispense Machines.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","PSOBING1")
0^2^B54041634^B52182367
"RTN","PSOBING1",1,0)
PSOBING1 ;BHAM ISC/LC - bingo board utility routine ;6/29/06 11:46am
"RTN","PSOBING1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,28,56,135,244**;DEC 1997
"RTN","PSOBING1",3,0)
 ;External reference to ^PS(55 supported by DBIA 2228
"RTN","PSOBING1",4,0)
 ;External reference to DD(52.11 and DD(59.2 supported by DBIA 999
"RTN","PSOBING1",5,0)
 ;
"RTN","PSOBING1",6,0)
 ;*244 don't store to file 52.11 if Rx Status > 11
"RTN","PSOBING1",7,0)
 ;
"RTN","PSOBING1",8,0)
BEG D:'$D(PSOPAR) ^PSOLSET G:'$D(PSOPAR) END
"RTN","PSOBING1",9,0)
NEW K DD,DO S (DIC,DIE)="^PS(52.11,",(NDA,X,DA)=PSODFN,DIC(0)="LMNQZ" D FILE^DICN K DIC G:Y'>0 NEW S (ODA,DA)=+Y,BNGSUS=0 S:$D(SUSROUTE) BNGSUS=1
"RTN","PSOBING1",10,0)
NEW1 S GRTP=$P($G(^PS(59.3,DISGROUP,0)),"^",2),NAM=$P($G(^DPT(PSODFN,0)),"^"),SSN=$P($G(^DPT(PSODFN,0)),"^",9) I GRTP="T" D  G:'$D(DA) END
"RTN","PSOBING1",11,0)
 .K TFLAG S DR="1;2////"_DISGROUP_";3////"_PSOSITE_";4////"_TM_";5////"_$E(TM1_"0000",1,4)_";8////"_NAM_";9////"_SSN_";13////"_BNGSUS_"" D STO  Q:'$D(DA)
"RTN","PSOBING1",12,0)
 .W !! S TIC=$P(^PS(52.11,DA,0),"^",2) D
"RTN","PSOBING1",13,0)
 ..F TIEN=0:0 S TIEN=$O(^PS(52.11,"C",TIC,TIEN)) Q:'TIEN  I DA'=TIEN,($P(^PS(52.11,DA,0),"^",4)=+$P(^PS(52.11,TIEN,0),"^",4)) D
"RTN","PSOBING1",14,0)
 ...S TDFN=$P(^PS(52.11,TIEN,0),"^"),TSSN=$P(^PS(52.11,TIEN,1),"^",2),TFLAG=0 W !,$C(7),$P(^DPT(TDFN,0),"^")_" ("_TSSN_") was issued ticket # "_TIC,". Try again!",!
"RTN","PSOBING1",15,0)
 ..K TDFN,TIEN,TSSN Q:'TFLAG
"RTN","PSOBING1",16,0)
 I $G(GRTP)="T" G:'TFLAG NEW1 G:TFLAG END
"RTN","PSOBING1",17,0)
 S DR="2////"_DISGROUP_";3////"_PSOSITE_";4////"_TM_";5////"_$E(TM1_"0000",1,4)_";8////"_NAM_";9////"_SSN_";13////"_BNGSUS_""
"RTN","PSOBING1",18,0)
STO S NFLAG=1 L +^PS(52.11,DA):2 E  W !!,$C(7),Y(0,0)," is being edited!",! S DA=NDA D WARN Q:$G(GRTP)="T"  G END
"RTN","PSOBING1",19,0)
 S XDA=DA D ^DIE I $G(DUOUT)!($G(DTOUT))!(X="") S DA=ODA D WARN G END
"RTN","PSOBING1",20,0)
 S DA=XDA D STORX S DA=XDA L -^PS(52.11,DA)
"RTN","PSOBING1",21,0)
 S TFLAG=1 D:$G(GRTP)="N" CHKUP^PSOBINGO,NOTE G:$G(GRTP)="N" END
"RTN","PSOBING1",22,0)
 Q
"RTN","PSOBING1",23,0)
NOTE S DFN=$P($G(^PS(52.11,DA,0)),"^"),NFLAG=1 W !!,?5,"NAME",?30,"SSN",?45,"ID",?50,"ORDER"
"RTN","PSOBING1",24,0)
 F Z=0:0 S Z=$O(^PS(52.11,"B",DFN,Z)) Q:'Z  S ZDA=Z S NODE=^PS(52.11,ZDA,1),Z1=$P($G(NODE),"^"),Z2=$P($G(NODE),"^",3),Z3=$P($G(NODE),"^",4),Z4=$P($G(NODE),"^",2) W !,?5,Z1,?30,Z4,?46,Z2,?52,Z3
"RTN","PSOBING1",25,0)
 W !!,"Please advise the patient that the above ID # and/or ORDER Letter"
"RTN","PSOBING1",26,0)
 W !,"will be displayed with his/her name on the Bingo Display",!!
"RTN","PSOBING1",27,0)
 I $G(^PS(55,"ASTALK",DFN)) W !,$C(7),"** ",Z1," is enrolled for ScripTalk.",!,"  Please use label(s) from ScripTalk printer." D  W !
"RTN","PSOBING1",28,0)
 .I $P($G(^PS(59,+PSOSITE,"STALK")),"^")="" W !,"  ** NO SCRIPTALK PRINTER DEFINED FOR THIS DIVISION!",! Q
"RTN","PSOBING1",29,0)
 .I $P($G(^PS(59,+PSOSITE,"STALK")),"^",2)'="A" W !,"  ** SCRIPTALK PRINTER IS NOT DEFINED FOR AUTO-PRINT",!,"You must manually queue the ScripTalk label(s) to print.",!
"RTN","PSOBING1",30,0)
 K NODE,Z1,Z2,Z3
"RTN","PSOBING1",31,0)
 Q
"RTN","PSOBING1",32,0)
HELP W !!,"Wand the barcode of the Rx or manually key in",!,"the number below the barcode, the Rx number, or the",!,"patient name in the format - 'LASTNAME,FIRSTNAME'"
"RTN","PSOBING1",33,0)
 W !!,"The barcode # should be of the format - 'NNN-NNNNNNN'"
"RTN","PSOBING1",34,0)
 Q
"RTN","PSOBING1",35,0)
BCRMV W !! K DIR S DIR("A")="Enter/Wand Rx # or Enter PATIENT NAME",DIR("?")="^D HELP^PSOBING1",DIR(0)="FO^1:45" D ^DIR
"RTN","PSOBING1",36,0)
 G:$D(DIRUT) END
"RTN","PSOBING1",37,0)
 I X'["-" D BCI^PSODISP Q:'$G(RXP)  G BCRMV1
"RTN","PSOBING1",38,0)
 I X["-",$P(X,"-")'=$P($$SITE^VASITE(),"^",3) W !?7,$C(7)," INVALID STATION # !",! G BCRMV
"RTN","PSOBING1",39,0)
 I X["-" S RXP=$P(X,"-",2) I '$D(^PSRX(+$G(RXP),0))!($G(RXP)']"") W !?7,$C(7)," NON-EXISTENT RX #" G BCRMV
"RTN","PSOBING1",40,0)
 G:$D(^PSRX(RXP,0)) BCRMV1
"RTN","PSOBING1",41,0)
 W !?7,$C(7)," IMPROPER BARCODE FORMAT" G BCRMV
"RTN","PSOBING1",42,0)
BCRMV1 S NME=$P($G(^PSRX(RXP,0)),"^",2),BNAME=$P($G(^DPT(NME,0)),"^"),BDA="",CNT1=0
"RTN","PSOBING1",43,0)
 F XX=0:0 S XX=$O(^PS(52.11,"B",NME,XX)) Q:'XX  D
"RTN","PSOBING1",44,0)
 .F BRX=0:0 S BRX=$O(^PS(52.11,XX,2,"B",BRX)) Q:'BRX  D
"RTN","PSOBING1",45,0)
 ..I BRX=RXP S DA=XX
"RTN","PSOBING1",46,0)
 I '$D(DA) W !!,BNAME," isn't in the Bingo Board file.",$C(7) G BCRMV
"RTN","PSOBING1",47,0)
 I $D(^PS(52.11,"ANAMK",DA)) W !!,BNAME," has already been removed from the display.",$C(7) G BCRMV
"RTN","PSOBING1",48,0)
 D REMOVE1^PSOBINGO
"RTN","PSOBING1",49,0)
 K BRX,DIK,DA,XX W !!,BNAME," is removed from the display."
"RTN","PSOBING1",50,0)
 G BCRMV
"RTN","PSOBING1",51,0)
WARN W !!,$C(7),"Bingo record is incomplete!" S DIK="^PS(52.11," D ^DIK K DIK,DA W !!,"Bingo record removed.",!
"RTN","PSOBING1",52,0)
 Q
"RTN","PSOBING1",53,0)
STORX ;Sto Rx # for each entry in 52.11
"RTN","PSOBING1",54,0)
 Q:'$D(BBRX(1))  N DIC,DIE,NUM,BB,BBN,DR,FL,FLN,I
"RTN","PSOBING1",55,0)
 S DA(1)=DA,(DIC,DIE)="^PS(52.11,"_DA(1)_",2,",DIC(0)="L",DIC("P")=$P(^DD(52.11,12,0),"^",2),DLAYGO=52.11
"RTN","PSOBING1",56,0)
 F BBN=0:0 S BBN=$O(BBRX(BBN)) Q:'BBN  F NUM=1:1 S BB=$P(BBRX(BBN),",",NUM) Q:'BB  D
"RTN","PSOBING1",57,0)
 .Q:$G(^PSRX(BB,"STA"))>11                            ;*244
"RTN","PSOBING1",58,0)
 .I $D(RXPR(BB)) S FL="P",FLN=$G(RXPR(BB))
"RTN","PSOBING1",59,0)
 .I '$D(RXPR(BB)) F I=0:0 S I=$O(^PSRX(BB,1,I)) Q:'I  S FL="F",FLN=I
"RTN","PSOBING1",60,0)
 .I '$D(FL) S FL="F",FLN=0
"RTN","PSOBING1",61,0)
 .S X=$P(^PSRX(BB,0),"^") D ^DIC
"RTN","PSOBING1",62,0)
 .S DA=$P(Y,"^"),DR="1////"_FL_";2////"_FLN_"" D ^DIE K FL,FLN
"RTN","PSOBING1",63,0)
 Q
"RTN","PSOBING1",64,0)
 ;
"RTN","PSOBING1",65,0)
WTIME ;sto bingo wait time in 52
"RTN","PSOBING1",66,0)
 Q:'$D(DA)!'$D(DIF)  S BDA=DA
"RTN","PSOBING1",67,0)
 N DIE,XX,BRX1,BRXFL,BRXFLN,DR
"RTN","PSOBING1",68,0)
 S DA(1)=DA,DIE="^PS(52.11,"_DA(1)_",2,"
"RTN","PSOBING1",69,0)
 F XX=0:0 S XX=$O(^PS(52.11,BDA,2,XX)) Q:'XX  S DA=XX,BRX=$G(^PS(52.11,BDA,2,DA,0)),BRX1=$P(^(0),"^"),BRXFL=$P(^(0),"^",2),BRXFLN=$P(^(0),"^",3) D
"RTN","PSOBING1",70,0)
 .S DR="3////"_DIF_"" D ^DIE D
"RTN","PSOBING1",71,0)
 ..N DA,DIE S DA=BRX1
"RTN","PSOBING1",72,0)
 ..I $G(BRXFLN)=0 S DIE="^PSRX(",DR="32.3////"_DIF_"" D ^DIE K DIE
"RTN","PSOBING1",73,0)
 ..I $G(BRXFLN)>0,$G(BRXFL)="F",$G(^PSRX(DA,1,BRXFLN,0)) S DA(1)=DA,DIE="^PSRX("_DA(1)_",1,",DA=BRXFLN,DR="18////"_DIF_"" D ^DIE K DIE
"RTN","PSOBING1",74,0)
 ..I $G(BRXFLN)>0,$G(BRXFL)="P",$G(^PSRX(DA,"P",BRXFLN,0)) S DA(1)=DA,DIE="^PSRX("_DA(1)_",""P"",",DA=BRXFLN,DR="9////"_DIF_"" D ^DIE K DIE
"RTN","PSOBING1",75,0)
 S DA=BDA K DIE,XX,BRX,BRX1,BRXFL,BRXFLN,DR,DA(1)
"RTN","PSOBING1",76,0)
 Q
"RTN","PSOBING1",77,0)
 ;
"RTN","PSOBING1",78,0)
CREF ;check for deleted refills
"RTN","PSOBING1",79,0)
 S BDA=DA,XX=0,BRB="" F  S XX=$O(^PS(52.11,BDA,2,XX)) Q:'XX  S DA=XX D
"RTN","PSOBING1",80,0)
 .S BRX0=$G(^PS(52.11,BDA,2,DA,0)),BRX1=$P(BRX0,"^"),BRXFL=$P(BRX0,"^",2),BRXFLN=$P(BRX0,"^",3)
"RTN","PSOBING1",81,0)
 .I BRXFLN,BRXFL="F",$G(^PSRX(BRX1,1,BRXFLN,0))']"" D
"RTN","PSOBING1",82,0)
 ..S DA(1)=BDA,DIK="^PS(52.11,"_DA(1)_",2," D ^DIK K DIK,DA(1)
"RTN","PSOBING1",83,0)
 ..S BRB=BRB_$S(BRB="":"",1:"; ")_BRX1_","_BRXFLN
"RTN","PSOBING1",84,0)
 S DA=BDA I BRB]"",$P($G(^PS(52.11,BDA,2,0)),"^",4)=0 D
"RTN","PSOBING1",85,0)
 .W !!,$C(7),"Refill(s) "_BRB_" does not exist.",!,"It can't be displayed and is now deleted."
"RTN","PSOBING1",86,0)
 .S DIK="^PS(52.11," D ^DIK S PSODRF=1
"RTN","PSOBING1",87,0)
 K BDA,BRB,BRX0,BRX1,BRXFL,BRXFLN
"RTN","PSOBING1",88,0)
 Q
"RTN","PSOBING1",89,0)
 ;
"RTN","PSOBING1",90,0)
REL S BNGRXP=RXP N NAM,NAME,RXO,SSN
"RTN","PSOBING1",91,0)
 S NAM=$P($G(^DPT(BINGNAM,0)),"^"),ADA="",BNGRXP=RXP
"RTN","PSOBING1",92,0)
 F XX=0:0 S XX=$O(^PS(52.11,"B",BINGNAM,XX)) Q:'XX  D
"RTN","PSOBING1",93,0)
 .F BRX=0:0 S BRX=$O(^PS(52.11,XX,2,"B",BRX)) Q:'BRX  D
"RTN","PSOBING1",94,0)
 ..I BRX=BNGRXP S (DA,ODA)=XX
"RTN","PSOBING1",95,0)
 I '$D(DA) W !!,"The Rx for ",NAM," isn't in the Bingo Board",!,"file and must be entered manually.",$C(7) G END
"RTN","PSOBING1",96,0)
 I $P($G(^PS(52.11,DA,0)),"^",7)]"" W !!,NAM,"  is already in the display queue.",$C(7) G END
"RTN","PSOBING1",97,0)
 I $P($P($G(^PS(52.11,DA,0)),"^",5),".")'=DT S Y=$P($P($G(^PS(52.11,DA,0)),"^",5),".") D DD^%DT W !!,$C(7),NAM," was entered on "_Y_".",!,"It can't be displayed and is now deleted." S DIK="^PS(52.11," D ^DIK K DIK G END
"RTN","PSOBING1",98,0)
 G:$P($G(^PS(52.11,DA,0)),"^",9) REL1
"RTN","PSOBING1",99,0)
 I $P($G(^PS(52.11,DA,0)),"^",4)'=PSOSITE W !!,NAM," is from another division",!,"and must be displayed manually.",$C(7) G END
"RTN","PSOBING1",100,0)
 I $D(BINGRO),$D(BINGDIV) S BDIV=BINGDIV G REL1
"RTN","PSOBING1",101,0)
 I $D(BINGRPR),$D(BNGPDV) S BDIV=BNGPDV G REL1
"RTN","PSOBING1",102,0)
 I $D(BINGRPR),$D(BNGRDV) S BDIV=BNGRDV G REL1
"RTN","PSOBING1",103,0)
REL1 N TM,TM1 D NOW^%DTC S TM=$E(%,1,12),TM1=$P(TM,".",2)
"RTN","PSOBING1",104,0)
 S NM=$P(^DPT($P(^PS(52.11,DA,0),"^"),0),"^"),DR="6////"_$E(TM1_"0000",1,4)_";8////"_NM_"",DIE="^PS(52.11,"
"RTN","PSOBING1",105,0)
 L +^PS(52.11,DA):2 E  W !!,$C(7),NM," is being edited!",! D WARN G END
"RTN","PSOBING1",106,0)
 D ^DIE L -^PS(52.11,DA) I $G(DUOUT)!($G(DTOUT))!(X="") D WARN G END
"RTN","PSOBING1",107,0)
 S RX0=^PS(52.11,DA,0),JOES=$P(RX0,"^",4),TICK=+$P($G(RX0),"^",2),GRP=$P($G(^PS(59.3,$P($G(^PS(52.11,DA,0)),"^",3),0)),"^",2) D:GRP="T"&('$G(TICK)) WARN G:'$D(DA) END
"RTN","PSOBING1",108,0)
 W !!,NAM," added to the "_$P($G(^PS(59.3,$P(RX0,"^",3),0)),"^")_" display."
"RTN","PSOBING1",109,0)
 I +$G(^PS(55,"ASTALK",$P(^PS(52.11,DA,0),"^"))) W !,$C(7),"This patient is enrolled in ScripTalk and may benefit from",!,"a non-visual announcement that prescriptions are ready."
"RTN","PSOBING1",110,0)
 S PSZ=0 I '$D(^PS(59.2,DT,0)) K DD,DIC,DO,DA S X=DT,DIC="^PS(59.2,",DIC(0)="",DINUM=X D FILE^DICN S PSZ=1 Q:Y'>0 
"RTN","PSOBING1",111,0)
 I PSZ=1 S DA(1)=+Y,DIC=DIC_DA(1)_",1,",(DINUM,X)=JOES,DIC(0)="",DIC("P")=$P(^DD(59.2,1,0),"^",2) K DD,DO D FILE^DICN K DIC,DA Q:Y'>0
"RTN","PSOBING1",112,0)
 I PSZ=0 K DD,DIC,DO,DA S DA(1)=DT,(DINUM,X)=JOES,DIC="^PS(59.2,"_DT_",1,",DIC(0)="LZ" D FILE^DICN K DIC,DA,DO
"RTN","PSOBING1",113,0)
 S DA=ODA D STATS1^PSOBRPRT,WTIME
"RTN","PSOBING1",114,0)
END K ADA,BDA,BDIV,BNGRXP,BNGSUS,BNAME,BRX,CNT1,CT,DA,DD,DIC,DIE,DIK,DIR,DO,DR,DTOUT,DUOUT,GRP,GRTP,JOES
"RTN","PSOBING1",115,0)
 K NAM,NDA,NFLAG,NME,ODA,PSZ,RXO,SSN,TDFN,TFLAG,TIC,TICK,TIEN,TM,TM1,TSSN,X,Y,XX
"RTN","PSOBING1",116,0)
 Q
"RTN","PSOLBL")
0^5^B70864785^B69139699
"RTN","PSOLBL",1,0)
PSOLBL ;BIR/SAB/RTR-BOTTLE LABEL ;6/29/06 11:39am
"RTN","PSOLBL",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**8,19,30,36,47,71,92,120,157,244**;DEC 1997
"RTN","PSOLBL",3,0)
 ;DBIAs PSDRUG-221, PS(55-2228, IBARX-125, PSXSRP-2201, %ZIS-3435, DPT-3097
"RTN","PSOLBL",4,0)
 ;
"RTN","PSOLBL",5,0)
 ;*244 remove test for partial fill when testing status > 11
"RTN","PSOLBL",6,0)
 ;
"RTN","PSOLBL",7,0)
DQ I $D(PSOIOS),PSOIOS]"" D DEVBAR^PSOBMST
"RTN","PSOLBL",8,0)
 I $G(PSOBAR0)]"",$G(PSOBAR1)]"",$D(^PS(59,PSOSITE,1)) S PSOBARS=1
"RTN","PSOLBL",9,0)
DQ1 D ^PSOLBL4
"RTN","PSOLBL",10,0)
 I $G(IOST(0)),$D(^%ZIS(2,IOST(0),55,"B","LL")) G ^PSOLLLI
"RTN","PSOLBL",11,0)
 G:'$D(PPL) HLEX G:($P($G(PSOPAR),"^",30)=2)&('$G(PSOEXREP)) HLEX K RXFLX S PSOCKHN=","_$G(PPL) S PSRESOLV=+PPL D CHECK F PI=1:1  D  S RX=$P(PPL,",",PI) D C Q:$G(PSOLAPPL)  D:$G(PSDFNFLG) TRAIL^PSOLBL2 K RXP,REPRINT
"RTN","PSOLBL",12,0)
 .S (PSDFNFLG,PSOLAPPL)=0 S NEXTRX=$P(PPL,",",(PI+1)) I NEXTRX=""!(NEXTRX=",") S PSOLAPPL=1 Q
"RTN","PSOLBL",13,0)
 .I PSOPDFN'=$P(^PSRX(NEXTRX,0),"^",2) S PSDFNFLG=1,PSOPDFN=$P(^PSRX(NEXTRX,0),"^",2) Q
"RTN","PSOLBL",14,0)
 I $P(^PS(59,PSOSITE,1),"^",28) D ^PSOLBLN2
"RTN","PSOLBL",15,0)
 D:'$P(^PS(59,PSOSITE,1),"^",28) ^PSOLBLS
"RTN","PSOLBL",16,0)
DQ5 I $D(^TMP($J,"PSOCP",DFN)),'$P(^PS(59,PSOSITE,1),"^",28) D INV^PSOCPE
"RTN","PSOLBL",17,0)
HLEX K RXPI,PSORX,RXP,PSOIOS,PSOLAPPL,XXX,COPAYVAR,TECH,PHYS,MFG,NURSE,STATE,SIDE,COPIES,EXDT,ISD,PSOINST,RXN,RXY,VADT,DEA,WARN,FDT,QTY,PATST,PDA,PS,PS1,PS2,PSL,PSNP,INRX,RR,XTYPE,SSNP,SSNPN,PNM,ADDR,PSODBQ,PSOLASTF,PSRESOLV,PSOEXREP,PSOSXQ
"RTN","PSOLBL",18,0)
 K ^TMP($J,"PSOCP",+$G(PSOCPN)),PSOCPN,PSOLBLDR,PSOLBLPS,PSOLBLCP,RXPR,RXRP,RXRS,PSOCKHN,RXFLX,PSOLAPPL,PSOPDFN,PSDFNFLG,PSOZERO,NEXTRX,PSOBLALL,STA S:'$G(PSOSUREP)&('$G(PSOSUSPR)) ZTREQ="@" Q
"RTN","PSOLBL",19,0)
C I $G(IOST(0)),$D(^%ZIS(2,IOST(0),55,"B","LL")) G C^PSOLLLI
"RTN","PSOLBL",20,0)
 U IO S X=$S('$P(^PS(59,PSOSITE,1),"^",28):132,1:158) X ^%ZOSF("RM") Q:'$D(^PSRX(RX,0))
"RTN","PSOLBL",21,0)
 S:$G(PSOBLALL) PSOBLRX=RX
"RTN","PSOLBL",22,0)
 S:$D(RXRP(RX)) REPRINT=1 S:$D(RXPR(RX)) RXP=RXPR(RX)
"RTN","PSOLBL",23,0)
 I $G(PSOSUREP)!($G(PSOEXREP)) S REPRINT=1 S:'$G(RXRP(RX)) RXRP(RX)=1
"RTN","PSOLBL",24,0)
 S RXY=^PSRX(RX,0),RXSTA=$P(^PSRX(RX,"STA"),"^") I RXSTA>11 D AL("QT") K RXY,RXP,REPRINT Q         ;*244
"RTN","PSOLBL",25,0)
 I RXSTA=3 D AL("QT") K RXY,RXP,REPRINT Q
"RTN","PSOLBL",26,0)
 I $G(RXPR(RX)),'$D(^PSRX(RX,"P",RXP,0)) K RXY,RXP,REPRINT Q
"RTN","PSOLBL",27,0)
 I $P($G(RXFL(RX)),"^"),'$D(^PSRX(RX,1,$P($G(RXFL(RX)),"^"),0)) K RXY,RXP,REPRINT Q
"RTN","PSOLBL",28,0)
 I $G(PSODBQ)!($G(RXRS(RX))) S RR=$O(^PS(52.5,"B",RX,0)) Q:'RR  I $G(^PS(52.5,RR,"P"))=1 K RXY,RXP,REPRINT Q
"RTN","PSOLBL",29,0)
 I $G(RXRS(RX))!($G(PSOPULL)) S PSOSXQ=0 N DR,DA,DIE D  I $G(PSOSXQ) K RXY,RXP,REPRINT Q
"RTN","PSOLBL",30,0)
 .S DA=$O(^PS(52.5,"B",RX,0)) Q:'DA  S A=$P($G(^PS(52.5,DA,0)),"^",7) Q:A=""
"RTN","PSOLBL",31,0)
 .I A="Q" S DIE="^PS(52.5,",DR="3////P" D ^DIE Q
"RTN","PSOLBL",32,0)
 .K RXRS(RX) S PSOSXQ=1
"RTN","PSOLBL",33,0)
 I $G(PSRESOLV)=RX D ENLBL^PSOBSET K PSRESOLV
"RTN","PSOLBL",34,0)
 I RXSTA'=4 D:$G(PSOSUSPR) AREC^PSOSUTL D:$G(PSOPULL)!($G(RXRS(RX))) AREC1^PSOSUTL D:$G(PSOSUREP) AREC^PSOSUSRP D:$G(PSXREP) AREC^PSXSRP
"RTN","PSOLBL",35,0)
 K ^UTILITY("DIQ1",$J) S DA=$P($$SITE^VASITE(),"^") I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIC
"RTN","PSOLBL",36,0)
 S RXN=$P(RXY,"^"),ISD=$P(RXY,"^",13),RXF=0,DFN=+$P(RXY,"^",2),SIG=$P($G(^PSRX(RX,"SIG")),"^"),ISD=$E(ISD,4,5)_"/"_$E(ISD,6,7)_"/"_($E(ISD,1,3)+1700),ZY=0,$P(LINE,"_",28)="_"
"RTN","PSOLBL",37,0)
 S PSOLBLPS=+$P(RXY,"^",3),PSOLBLDR=+$P(RXY,"^",6)
"RTN","PSOLBL",38,0)
 S NURSE=$S($P($G(^DPT(DFN,"NHC")),"^")="Y":1,$P($G(^PS(55,DFN,40)),"^"):1,1:0) S FDT=$P(^PSRX(RX,2),"^",2),PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:""),PS1=$S($D(^(1)):^(1),1:""),PSOSITE7=$P(^("IB"),"^")
"RTN","PSOLBL",39,0)
 S PS2=$P(PS,"^")_"^"_$P(PS,"^",6)
"RTN","PSOLBL",40,0)
 S (EXPDT,EXDT)=$P(^PSRX(RX,2),"^",6),EXDT=$S('EXDT:"",1:$E(EXDT,4,5)_"/"_$E(EXDT,6,7)_"/"_($E(EXDT,1,3)+1700))
"RTN","PSOLBL",41,0)
 S COPIES=$S($P($G(RXRP(RX)),"^",2):$P($G(RXRP(RX)),"^",2),$P(RXY,"^",18)]"":$P(RXY,"^",18),1:1)
"RTN","PSOLBL",42,0)
 K PSOCKHNX S PSOCKHL=$L(RX),PSOCKHN=$E($G(PSOCKHN),(PSOCKHL+2),999) D  K PSOCKHNX,PSOCKHL,PSOCKHA
"RTN","PSOLBL",43,0)
 .S PSOCKHA=","_RX_","
"RTN","PSOLBL",44,0)
 .I PSOCKHN'[PSOCKHA Q
"RTN","PSOLBL",45,0)
 .S PSOCKHA=$E(PSOCKHA,1,($L(PSOCKHA)-1))
"RTN","PSOLBL",46,0)
 .S PSOCKHNX=$L(PSOCKHN,PSOCKHA)-1
"RTN","PSOLBL",47,0)
 .I +$G(PSOCKHNX)>0 D DOUB
"RTN","PSOLBL",48,0)
 I $O(^PSRX(RX,1,0)),$G(RXFL(RX))'=0 S $P(^PSRX(RX,3),"^",6)="" K ^PSRX(RX,"DAI"),^PSRX(RX,"DRI")
"RTN","PSOLBL",49,0)
 I '$G(RXP),'$O(^PSRX(RX,1,0)) S RXFL(RX)=0
"RTN","PSOLBL",50,0)
 I '$G(RXP) D OSET I '$O(^PSRX(RX,1,0))!($G(RXFL(RX))=0) G ORIG
"RTN","PSOLBL",51,0)
 I $O(^PSRX(RX,1,0)),'$G(RXP),'$G(RXFL(RX)) S XTYPE=1 D REF G STA
"RTN","PSOLBL",52,0)
 I $O(^PSRX(RX,1,0)),'$G(RXP),$G(RXFL(RX)) G STA
"RTN","PSOLBL",53,0)
 I $G(RXP) S XTYPE="P" D REF G STA
"RTN","PSOLBL",54,0)
ORIG S TECH=$P($G(^VA(200,+$P(^PSRX(RX,0),"^",16),0)),"^"),QTY=$P(^PSRX(RX,0),"^",7),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UKN") D 6^VADPT,PID^VADPT S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLBL",55,0)
 S DAYS=$P(^PSRX(RX,0),"^",8),MFG="________",LOT="________"
"RTN","PSOLBL",56,0)
STA S STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UKN")
"RTN","PSOLBL",57,0)
 S DRUG=$$ZZ^PSOSUTL(RX),DEA=$P($G(^PSDRUG(+$P(RXY,"^",6),0)),"^",3),WARN=$P($G(^(0)),"^",8)
"RTN","PSOLBL",58,0)
 S SIDE=$S($P($G(RXRP(RX)),"^",3):1,1:0)
"RTN","PSOLBL",59,0)
 I $G(^PSRX(RX,"P",+$G(RXP),0))]"" S RXPI=RXP D
"RTN","PSOLBL",60,0)
 .S RXP=^PSRX(RX,"P",RXP,0)
"RTN","PSOLBL",61,0)
 .S RXY=$P(RXP,"^")_"^"_$P(RXY,"^",2,6)_"^"_$P(RXP,"^",4)_"^"_$P(RXP,"^",10)_"^"_$P(RXY,"^",9)_"^"_$P($G(^PSRX(RX,"SIG")),"^",2)_"^"_$P(RXP,"^",2)_"^"_$P(RXY,"^",12,14)_"^"_$P(^PSRX(RX,"STA"),"^")_"^"_$P(RXP,"^",7)_"^"_$P(RXY,"^",17,99)
"RTN","PSOLBL",62,0)
 .S FDT=$P(RXP,"^")
"RTN","PSOLBL",63,0)
 S MW=$P(RXY,"^",11) I $G(RXFL(RX))'=0 D:$G(RXFL(RX))  I '$G(RXFL(RX)) F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=RXF+1 S:'$G(RXP) MW=$P(^PSRX(RX,1,I,0),"^",2) I +^PSRX(RX,1,I,0)'<FDT S FDT=+^(0)
"RTN","PSOLBL",64,0)
 .I $G(RXFL(RX)),'$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLBL",65,0)
 .S RXF=RXFL(RX) S:'$G(RXP) MW=$P($G(^PSRX(RX,1,RXF,0)),"^",2) I +^PSRX(RX,1,RXF,0)'<FDT S FDT=+^(0)
"RTN","PSOLBL",66,0)
 I MW="W" S PSMP=$G(^PSRX(RX,"MP")) I PSMP]"" D
"RTN","PSOLBL",67,0)
 .S PSJ=0 F PSI=1:1:$L(PSMP) S PSMP(PSI)="",PSJ=PSJ+1 F PSJ=PSJ:1 S PSMP(PSI)=PSMP(PSI)_$P(PSMP," ",PSJ)_" " Q:($L(PSMP(PSI))+$L($P(PSMP," ",PSJ+1))>30)
"RTN","PSOLBL",68,0)
 .K PSMP(PSI)
"RTN","PSOLBL",69,0)
 S X=$S($D(^PS(55,DFN,0)):^(0),1:""),PSCAP=$P(X,"^",2),PS55=$P($G(X),"^",3),PS55X=$P($G(X),"^",5)
"RTN","PSOLBL",70,0)
 I (($G(PS55X)]"")&(PS55>1)&(PS55X<DT)) S PS55=1
"RTN","PSOLBL",71,0)
 S:MW="M" MW=$S((PS55=1!(PS55=4)):"R",1:MW)
"RTN","PSOLBL",72,0)
 S MW=$S(MW="M":"REGULAR",MW="R":"CERTIFIED",1:"WINDOW")
"RTN","PSOLBL",73,0)
 I ($G(PSMP(1))']""&($G(PS55)=2)) S PSMP(1)=$G(SSNPN)
"RTN","PSOLBL",74,0)
 ;S X=$S($D(^PS(55,DFN,0)):^(0),1:""),PSCAP=$P(X,"^",2) S:MW="M" MW=$S(+$P(X,"^",3):"R",1:MW) S MW=$S(MW="M":"REGULAR",MW="R":"CERTIFIED",1:"WINDOW")
"RTN","PSOLBL",75,0)
 S DATE=$E(FDT,1,7),REF=$P(RXY,"^",9)-RXF S:'$G(RXP) $P(^PSRX(RX,3),"^")=FDT S:REF<1 REF=0 D ^PSOLBL2 S II=RX D ^PSORFL,RFLDT^PSORFL
"RTN","PSOLBL",76,0)
 S PATST=$G(^PS(53,+$P(RXY,"^",3),0)) S PRTFL=1 I REF=0 S:('$P(PATST,"^",5))!(DEA["A"&(DEA'["B"))!(DEA["W") PRTFL=0
"RTN","PSOLBL",77,0)
 S VRPH=$P(^PSRX(RX,2),"^",10),PSCLN=+$P(RXY,"^",5),PSCLN=$S($D(^SC(PSCLN,0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLBL",78,0)
 S PATST=$P(PATST,"^",2),X1=DT,X2=$P(RXY,"^",8)-10 D C^%DTC:REF I $D(^PSRX(RX,2)),$P(^(2),"^",6),REF,X'<$P(^(2),"^",6) S REF=0,VRPH=$P(^(2),"^",10)
"RTN","PSOLBL",79,0)
 I $G(PSOCHAMP),$G(PSOTRAMT) S COPAYVAR="CHAMPUS" G LBL
"RTN","PSOLBL",80,0)
 I $G(RXP) S COPAYVAR="" G LBL
"RTN","PSOLBL",81,0)
 I $P($G(^PS(53,+$G(PSOLBLPS),0)),"^",7) D SNO G LBL
"RTN","PSOLBL",82,0)
 I $P($G(^PSDRUG(+$G(PSOLBLDR),0)),"^",3)["I"!($P($G(^(0)),"^",3)["S") D SNO G LBL
"RTN","PSOLBL",83,0)
 I $P(^PSRX(RX,"STA"),"^")>0,$P(^("STA"),"^")'=2,'$G(PSODBQ) D SNO G LBL
"RTN","PSOLBL",84,0)
 I $G(PSOLBLCP)="" D IBCP
"RTN","PSOLBL",85,0)
 N PSOQI S PSOQI=$G(^PSRX(RX,"IBQ")) I $G(PSOLBLCP)=0 D SNO G LBL
"RTN","PSOLBL",86,0)
 I $G(PSOLBLCP)=1 I $P(PSOQI,"^",2)!($P(PSOQI,"^",3))!($P(PSOQI,"^",4))!($P(PSOQI,"^",5))!($P(PSOQI,"^",6))!($P(PSOQI,"^",7)) D SNO G LBL
"RTN","PSOLBL",87,0)
 I $G(PSOLBLCP)=2 I $P(PSOQI,"^")!($P(PSOQI,"^",2))!($P(PSOQI,"^",3))!($P(PSOQI,"^",4))!($P(PSOQI,"^",5))!($P(PSOQI,"^",6))!($P(PSOQI,"^",7)) D SNO G LBL
"RTN","PSOLBL",88,0)
 I $G(PSOLBLCP)=2,'$P($G(^PSRX(RX,"IB")),"^") D SNO G LBL
"RTN","PSOLBL",89,0)
 S PSOCPN=$P(^PSRX(RX,0),"^",2),INRX=$P(^(0),"^") I $G(^TMP($J,"PSOCP",PSOCPN))="" S ^(PSOCPN)=PSOCPN
"RTN","PSOLBL",90,0)
 S ^TMP($J,"PSOCP",PSOCPN,INRX)=INRX_"^"_$$ZZ^PSOSUTL(RX)_"^"_+$G(DAYS) S COPAYVAR="COPAY" K ZDRUG
"RTN","PSOLBL",91,0)
LBL G ^PSOLBLD:$P(^PSRX(RX,"STA"),"^")=4 D ^PSOLBLD:$D(^PSRX(RX,"DRI"))&('$G(RXF))&('$G(RXP)) D:$P($G(^PSRX(RX,3)),"^",6)&('$G(RXF))&('$G(RXP)) ^PSOLBLD1 G ^PSOLBL1:'$P(^PS(59,PSOSITE,1),"^",28)
"RTN","PSOLBL",92,0)
 G ^PSOLBLN
"RTN","PSOLBL",93,0)
REF F XXX=0:0 S XXX=$O(^PSRX(RX,XTYPE,XXX)) Q:+XXX'>0  D
"RTN","PSOLBL",94,0)
 .S TECH=$S($D(^VA(200,+$P(^PSRX(RX,XTYPE,XXX,0),"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLBL",95,0)
 .S QTY=$P(^PSRX(RX,XTYPE,XXX,0),"^",4),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,XTYPE,XXX,0),"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLBL",96,0)
 .S DAYS=$P(^PSRX(RX,XTYPE,XXX,0),"^",10),LOT="________",MFG="________"
"RTN","PSOLBL",97,0)
 Q
"RTN","PSOLBL",98,0)
CHECK S PSDFNFLG=0,PSOZERO=$P(PPL,","),PSOPDFN=$P(^PSRX(PSOZERO,0),"^",2)
"RTN","PSOLBL",99,0)
 Q
"RTN","PSOLBL",100,0)
OSET I $G(RXFL(RX))']""!($G(RXFL(RX))=0) D  Q
"RTN","PSOLBL",101,0)
 .S TECH=$P($G(^VA(200,+$P(^PSRX(RX,0),"^",16),0)),"^"),QTY=$P(^PSRX(RX,0),"^",7),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UKN") D 6^VADPT,PID^VADPT S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLBL",102,0)
 .S DAYS=$P(^PSRX(RX,0),"^",8),MFG="________",LOT="________"
"RTN","PSOLBL",103,0)
 I '$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLBL",104,0)
 S TECH=$S($D(^VA(200,+$P(^PSRX(RX,1,RXFL(RX),0),"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLBL",105,0)
 S QTY=$P(^PSRX(RX,1,RXFL(RX),0),"^",4),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,1,RXFL(RX),0),"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLBL",106,0)
 S DAYS=$P(^PSRX(RX,1,RXFL(RX),0),"^",10),LOT="________",MFG="________"
"RTN","PSOLBL",107,0)
 Q
"RTN","PSOLBL",108,0)
DOUB Q:'$D(RXFL(RX))  I +$G(RXFL(RX))-PSOCKHNX<0 Q
"RTN","PSOLBL",109,0)
 S RXFLX(RX)=$G(RXFL(RX)),RXFL(RX)=$G(RXFL(RX))-PSOCKHNX
"RTN","PSOLBL",110,0)
 Q
"RTN","PSOLBL",111,0)
AL(T) N I,IR,RF,USR,TY,DES S USR=""
"RTN","PSOLBL",112,0)
 I T="UT" D
"RTN","PSOLBL",113,0)
 .N J,RX S USR=$G(DUZ),TY="B",DES="Label never queued to print by User"
"RTN","PSOLBL",114,0)
 .F J=1:1  S RX=+$P(PPL,",",J) Q:'RX  D AL1
"RTN","PSOLBL",115,0)
 I T="QT" D
"RTN","PSOLBL",116,0)
 .S I=+$P(^PSRX(RX,"STA"),"^"),TY=$S((I=3)!(I=16):"H",I=13:"D",1:"C")
"RTN","PSOLBL",117,0)
 .S DES=I_" "_$S((I=3)!(I=16):"HOLD"_$S(I=16:"(PROVIDER)",1:""),(I=12)!(I=14)!(I=15):"DISCONTINUED"_$S(I=14:"(PROVIDER)",I=15:"(EDIT)",1:""),I=13:"DELETED",1:"")
"RTN","PSOLBL",118,0)
 .S DES="Queued label terminated - "_DES D AL1
"RTN","PSOLBL",119,0)
 K %,%H,%I Q
"RTN","PSOLBL",120,0)
AL1 S (IR,I,RF)=0 F  S I=$O(^PSRX(RX,1,I)) Q:'I  S RF=I S:I>5 RF=I+1
"RTN","PSOLBL",121,0)
 S I=0 F  S I=$O(^PSRX(RX,"A",I)) Q:'I  S IR=I
"RTN","PSOLBL",122,0)
 S IR=IR+1,^PSRX(RX,"A",0)="^52.3DA^"_IR_"^"_IR
"RTN","PSOLBL",123,0)
 D NOW^%DTC S ^PSRX(RX,"A",IR,0)=%_"^"_TY_"^"_USR_"^"_$S($G(RXPR(RX)):6,1:RF)_"^"_DES
"RTN","PSOLBL",124,0)
 Q
"RTN","PSOLBL",125,0)
IBCP N X,Y,PSOJJ,PSOLL
"RTN","PSOLBL",126,0)
 S PSOLBLCP="",X=$P($G(^PS(59,+$G(PSOSITE),"IB")),"^")_"^"_$G(DFN) D XTYPE^IBARX
"RTN","PSOLBL",127,0)
 S PSOJJ="" F  S PSOJJ=$O(Y(PSOJJ)) Q:'PSOJJ  S PSOLL="" F  S PSOLL=$O(Y(PSOJJ,PSOLL)) Q:PSOLL=""  S:PSOLL>0 PSOLBLCP=PSOLL
"RTN","PSOLBL",128,0)
 I '$G(PSOLBLCP) S PSOLBLCP=0
"RTN","PSOLBL",129,0)
 Q
"RTN","PSOLBL",130,0)
SNO S COPAYVAR="NO COPAY" Q
"RTN","PSOLBL4")
0^6^B52469710^B51765794
"RTN","PSOLBL4",1,0)
PSOLBL4 ;BIR/RTR-Set up routine for HL7 interface ;6/29/06 1:21pm
"RTN","PSOLBL4",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**26,70,156,244**;DEC 1997
"RTN","PSOLBL4",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOLBL4",4,0)
 ;
"RTN","PSOLBL4",5,0)
 ;*244 - ignore RX's with a status > 11
"RTN","PSOLBL4",6,0)
 ;
"RTN","PSOLBL4",7,0)
 N DIC,AP,X,Y,DPRT,QPRT
"RTN","PSOLBL4",8,0)
 I $G(ZTIO)]"" D
"RTN","PSOLBL4",9,0)
 .Q:'$O(^PS(59,PSOSITE,"P",0))
"RTN","PSOLBL4",10,0)
 .S DIC=3.5,DIC(0)="",X=ZTIO D ^DIC K DIC,X Q:Y=-1
"RTN","PSOLBL4",11,0)
 .S DPRT=+Y
"RTN","PSOLBL4",12,0)
 .F AP=0:0 S AP=$O(^PS(59,PSOSITE,"P",AP)) Q:'AP  I +$P(^PS(59,PSOSITE,"P",AP,0),"^")=DPRT S QPRT=1
"RTN","PSOLBL4",13,0)
 .I '$G(QPRT) S $P(PSOPAR,"^",30)=0
"RTN","PSOLBL4",14,0)
 Q:'$P($G(PSOPAR),"^",30)
"RTN","PSOLBL4",15,0)
 Q:$G(PSOEXREP)
"RTN","PSOLBL4",16,0)
HL N PSODTM,HHHH,HLCOT,HLFLAG,HLFOUR,HLINGF,HLINRX,HLINRX0,HLLOOP,HLNEXT,HLRR,HLRX,HLRXY,LL,PPLHL,PSHALP,HDFN,HLDFN,HNEWDFN,HLDAI,HLOSITE,HLJUST,HLRXYZ,PSOLLN,PSOLLL,PSFLG,HDFN1
"RTN","PSOLBL4",17,0)
 S HLOSITE=$P($G(PSOPAR),"^",30)
"RTN","PSOLBL4",18,0)
 K ^UTILITY($J,"PSOHL"),^UTILITY($J,"PSOHLL"),HLRXY
"RTN","PSOLBL4",19,0)
 S PPLHL=PPL G:HLOSITE=4 SOMD
"RTN","PSOLBL4",20,0)
 S HLFLAG=0 F HLLOOP=1:1 S HLRX=$P(PPLHL,",",HLLOOP) D  Q:$G(HLFLAG)
"RTN","PSOLBL4",21,0)
 .S HLNEXT=$P(PPLHL,",",(HLLOOP+1)) I HLNEXT=""!(HLNEXT=",") S HLFLAG=1
"RTN","PSOLBL4",22,0)
 .Q:'$G(HLRX)
"RTN","PSOLBL4",23,0)
 .Q:'$D(^PSRX(HLRX,0))
"RTN","PSOLBL4",24,0)
 .Q:$P($G(^PSRX(HLRX,"STA")),"^")=4
"RTN","PSOLBL4",25,0)
 .Q:$G(RXRP(HLRX,"RP"))
"RTN","PSOLBL4",26,0)
 .I $P($G(^PSRX(HLRX,"STA")),"^")>11!('$P(^PSRX(HLRX,0),"^",2)) Q     ;*244
"RTN","PSOLBL4",27,0)
 .I $G(PSODBQ) S HLRR=$O(^PS(52.5,"B",HLRX,0)) Q:'HLRR  I $G(^PS(52.5,+HLRR,"P"))=1 Q
"RTN","PSOLBL4",28,0)
 .;Here, if Site Parameter is 3, check entry in Drug File for National Id
"RTN","PSOLBL4",29,0)
 .I $G(HLOSITE)=3 S HLJUST=+$P($G(^PSRX(HLRX,0)),"^",6) I '$P($G(^PSDRUG(HLJUST,6)),"^") Q
"RTN","PSOLBL4",30,0)
 .S HLRXY(HLLOOP,HLRX)="" ; VALID RXS
"RTN","PSOLBL4",31,0)
 .S:$G(HLOSITE)=3 HLRXYZ(HLRX)=""
"RTN","PSOLBL4",32,0)
 I $G(HLOSITE)=3,$D(HLRXY) D
"RTN","PSOLBL4",33,0)
 .N HLZFLAG,HLZ,HLZRX,HLZNEXT
"RTN","PSOLBL4",34,0)
 .S HLZFLAG=0 K PPL F HLZ=1:1 S HLZRX=$P(PPLHL,",",HLZ) D  Q:$G(HLZFLAG)
"RTN","PSOLBL4",35,0)
 ..S HLZNEXT=$P(PPLHL,",",(HLZ+1)) I HLZNEXT=""!(HLZNEXT=",") S HLZFLAG=1
"RTN","PSOLBL4",36,0)
 ..Q:'$G(HLZRX)
"RTN","PSOLBL4",37,0)
 ..Q:$D(HLRXYZ(HLZRX))
"RTN","PSOLBL4",38,0)
 ..I $G(RXRP(HLZRX,"RP")) D  Q
"RTN","PSOLBL4",39,0)
 ...I $G(PPL)="" S PPL=HLZRX_"," Q
"RTN","PSOLBL4",40,0)
 ...S PPL=PPL_HLZRX_","
"RTN","PSOLBL4",41,0)
 ..I $G(PPL)="" S PPL=HLZRX_"," Q
"RTN","PSOLBL4",42,0)
 ..S PPL=PPL_HLZRX_","
"RTN","PSOLBL4",43,0)
SOMDQ S HLCOT=1,PSHALP="" F  S PSHALP=$O(HLRXY(PSHALP)) Q:PSHALP=""  S ^UTILITY($J,"PSOHLL",HLCOT)=$O(HLRXY(PSHALP,0)),HLCOT=HLCOT+1
"RTN","PSOLBL4",44,0)
 I HLCOT=1 G ENDHL ; NOTHING SET, BYPASS CALL TO QUEUE
"RTN","PSOLBL4",45,0)
 F HLCOT=0:0 S HLCOT=$O(^UTILITY($J,"PSOHLL",HLCOT)) Q:'HLCOT  S HLINRX=^(HLCOT),HLINRX0=$G(^PSRX(HLINRX,0)) D
"RTN","PSOLBL4",46,0)
 .S ^UTILITY($J,"PSOHLL",HLCOT)=HLINRX_"^"_+$P(HLINRX0,"^",6)_"^"_$S($G(RXPR(HLINRX)):"P",1:"F")
"RTN","PSOLBL4",47,0)
 .I '$G(RXPR(HLINRX)) S HLFOUR=0 F HHHH=0:0 S HHHH=$O(^PSRX(HLINRX,1,HHHH)) Q:'HHHH  I +^(HHHH,0) S HLFOUR=HHHH
"RTN","PSOLBL4",48,0)
 .I '$G(RXPR(HLINRX)),$G(RXFL(HLINRX))'="" S HLFOUR=$S($G(RXFL(HLINRX))=0:0,$D(^PSRX(HLINRX,1,+$G(RXFL(HLINRX)),0)):+$G(RXFL(HLINRX)),1:$G(HLFOUR))
"RTN","PSOLBL4",49,0)
 .S ^UTILITY($J,"PSOHLL",HLCOT)=^UTILITY($J,"PSOHLL",HLCOT)_"^"_$S($G(RXPR(HLINRX)):RXPR(HLINRX),1:HLFOUR)_"^"_$S($P($G(^PSRX(HLINRX,3)),"^",6)&('$G(RXPR(HLINRX)))&('$G(RXFL(HLINRX))):1,1:0) D ACLOG
"RTN","PSOLBL4",50,0)
 .S HLINGF=0 I $P(^UTILITY($J,"PSOHLL",HLCOT),"^",5),$O(^PSRX(HLINRX,"DAI",0)) S HLINGF=1 D
"RTN","PSOLBL4",51,0)
 ..F LL=0:0 S LL=$O(^PSRX(HLINRX,"DAI",LL)) Q:'LL  S ^UTILITY($J,"PSOHLL",HLCOT,HLINGF)=$G(^PSRX(HLINRX,"DAI",LL,0)),HLINGF=HLINGF+1
"RTN","PSOLBL4",52,0)
 .S $P(^UTILITY($J,"PSOHLL",HLCOT),"^",6)=$S($G(HLINGF):1,1:0)
"RTN","PSOLBL4",53,0)
 .I $D(^PSRX(HLINRX,"DRI")),'$G(RXPR(HLINRX)),'$G(RXFL(HLINRX)) S ^UTILITY($J,"PSOHLL",HLCOT,"DRI")=^PSRX(HLINRX,"DRI"),$P(^UTILITY($J,"PSOHLL",HLCOT),"^",7)=1
"RTN","PSOLBL4",54,0)
 .E  S $P(^UTILITY($J,"PSOHLL",HLCOT),"^",7)=0
"RTN","PSOLBL4",55,0)
 .S $P(^UTILITY($J,"PSOHLL",HLCOT),"^",8)=0 D RPT Q:'$G(^PSRX(HLINRX,"IB"))
"RTN","PSOLBL4",56,0)
 .I $P(^PSRX(HLINRX,"STA"),"^")>0,$P(^("STA"),"^")'=2,'$G(PSODBQ) Q
"RTN","PSOLBL4",57,0)
 .S $P(^UTILITY($J,"PSOHLL",HLCOT),"^",8)=1
"RTN","PSOLBL4",58,0)
 ;
"RTN","PSOLBL4",59,0)
AAA D STRT^PSOHLSG5
"RTN","PSOLBL4",60,0)
 S (HDFN,HDFN1)=$O(^UTILITY($J,"PSOHLL",0)),HDFN=$P(^PSRX($P(^(HDFN),"^"),0),"^",2),PSOLLL=$P(^UTILITY($J,"PSOHLL",HDFN1),"^",12)
"RTN","PSOLBL4",61,0)
 F HLDFN=0:0 S HLDFN=$O(^UTILITY($J,"PSOHLL",HLDFN)) Q:'HLDFN  D  S ^UTILITY($J,"PSOHL",HLDFN)=^UTILITY($J,"PSOHLL",HLDFN) D OTHER
"RTN","PSOLBL4",62,0)
 .S PSFLG=0,PSOLLN=$P(^UTILITY($J,"PSOHLL",HLDFN),"^",12),HNEWDFN=$P(^PSRX($P(^UTILITY($J,"PSOHLL",HLDFN),"^"),0),"^",2) D
"RTN","PSOLBL4",63,0)
 ..I HDFN'=HNEWDFN S HDFN=HNEWDFN,PSFLG=1
"RTN","PSOLBL4",64,0)
 ..I PSOLLL'=PSOLLN S PSOLLL=PSOLLN,PSFLG=1
"RTN","PSOLBL4",65,0)
 ..I PSFLG=1 D SETZ
"RTN","PSOLBL4",66,0)
 I '$D(^UTILITY($J,"PSOHL")) G ENDHL
"RTN","PSOLBL4",67,0)
CALL D SETZ
"RTN","PSOLBL4",68,0)
ENDHL K ^UTILITY($J,"PSOHL"),^UTILITY($J,"PSOHLL"),HLRXY
"RTN","PSOLBL4",69,0)
 Q
"RTN","PSOLBL4",70,0)
OTHER I $G(^UTILITY($J,"PSOHLL",HLDFN,"DRI"))'="" S ^UTILITY($J,"PSOHL",HLDFN,"DRI")=^UTILITY($J,"PSOHLL",HLDFN,"DRI")
"RTN","PSOLBL4",71,0)
 F HLDAI=0:0 S HLDAI=$O(^UTILITY($J,"PSOHLL",HLDFN,HLDAI)) Q:'HLDAI  S ^UTILITY($J,"PSOHL",HLDFN,HLDAI)=^UTILITY($J,"PSOHLL",HLDFN,HLDAI)
"RTN","PSOLBL4",72,0)
 Q
"RTN","PSOLBL4",73,0)
ACLOG ;Activity log (sending to Hl7 interface)
"RTN","PSOLBL4",74,0)
 N DTTM,HCOM,HCNT,HJJ
"RTN","PSOLBL4",75,0)
 D NOW^%DTC S DTTM=%,HCOM="Prescription"_$S($G(RXPR(HLINRX)):" (Partial)",1:"")_$S($G(PSOSUREP)!($G(RXRP(HLINRX))):" (Reprint)",1:"")_" sent to external interface."
"RTN","PSOLBL4",76,0)
 S HCNT=0 F HJJ=0:0 S HJJ=$O(^PSRX(HLINRX,"A",HJJ)) Q:'HJJ  S HCNT=HJJ
"RTN","PSOLBL4",77,0)
 S HCNT=HCNT+1,^PSRX(HLINRX,"A",0)="^52.3DA^"_HCNT_"^"_HCNT S ^PSRX(HLINRX,"A",HCNT,0)=DTTM_"^X^"_$G(PDUZ)_"^"_$S($G(RXPR(HLINRX)):6,$G(HLFOUR)<6:$G(HLFOUR),1:(HLFOUR+1))_"^"_HCOM
"RTN","PSOLBL4",78,0)
 Q
"RTN","PSOLBL4",79,0)
SUS(HSREX,HSFL,HSFILL,HSRP) ;
"RTN","PSOLBL4",80,0)
 N DA,DIK,DTTM,HSCOM,HSCNT,HSJJ,HSLDUZ,PSHLCPRS
"RTN","PSOLBL4",81,0)
 I $P($G(^PSRX(HSREX,"STA")),"^")=5 S $P(^PSRX(HSREX,"STA"),"^")=0 S PSHLCPRS="Removed from Suspense, External Interface." D EN^PSOHLSN1(HSREX,"SC","ZU",PSHLCPRS)
"RTN","PSOLBL4",82,0)
 S DA=$O(^PS(52.5,"B",HSREX,0)) I DA K DIK S DIK="^PS(52.5," D ^DIK
"RTN","PSOLBL4",83,0)
 I $G(HSFL)="P" S HSLDUZ=+$P($G(^PSRX(HSREX,"P",HSFILL,0)),"^",7)
"RTN","PSOLBL4",84,0)
 E  S HSLDUZ=$S('HSFILL:+$P($G(^PSRX(HSREX,0)),"^",16),1:+$P($G(^PSRX(HSREX,1,HSFILL,0)),"^",7))
"RTN","PSOLBL4",85,0)
 D NOW^%DTC S DTTM=%,HSCOM="Removed from Suspense"_$S($G(HSFL)="P":" (Partial)",1:"")_$S($G(HSRP):" (Reprint)",1:"")_" (External Interface)"
"RTN","PSOLBL4",86,0)
 S HSCNT=0 F HSJJ=0:0 S HSJJ=$O(^PSRX(HSREX,"A",HSJJ)) Q:'HSJJ  S HSCNT=HSJJ
"RTN","PSOLBL4",87,0)
 S HSCNT=HSCNT+1,^PSRX(HSREX,"A",0)="^52.3DA^"_HSCNT_"^"_HSCNT S ^PSRX(HSREX,"A",HSCNT,0)=DTTM_"^X^"_$G(HSLDUZ)_"^"_$S($G(HSFL)="P":6,$G(HSFILL)<6:$G(HSFILL),1:(HSFILL+1))_"^"_$G(HSCOM)
"RTN","PSOLBL4",88,0)
 Q
"RTN","PSOLBL4",89,0)
LAB(HLREX,HLFL,HLFILL,HLREPT) ;
"RTN","PSOLBL4",90,0)
 N HLDUZ,NOW,DA,HCT,HFF
"RTN","PSOLBL4",91,0)
 D NOW^%DTC S NOW=% S HCT=0 F HFF=0:0 S HFF=$O(^PSRX(HLREX,"L",HFF)) Q:'HFF  S HCT=HFF
"RTN","PSOLBL4",92,0)
 I HLFL="F" S HLDUZ=$S('HLFILL:+$P($G(^PSRX(HLREX,0)),"^",16),1:+$P($G(^PSRX(HLREX,1,HLFILL,0)),"^",7))
"RTN","PSOLBL4",93,0)
 I HLFL="P" S HLDUZ=+$P($G(^PSRX(HLREX,"P",HLFILL,0)),"^",7)
"RTN","PSOLBL4",94,0)
 S HCT=HCT+1,^PSRX(HLREX,"L",0)="^52.032DA^"_HCT_"^"_HCT
"RTN","PSOLBL4",95,0)
 S ^PSRX(HLREX,"L",HCT,0)=NOW_"^"_$S($G(HLFL)="F":HLFILL,1:(99-HLFILL))_"^"_"From Rx number "_$P(^PSRX(HLREX,0),"^")_$S($G(HLFL)="P":" (Partial)",1:"")_$S($G(HLREPT):" (Reprint)",1:"")_" (External Interface)"_"^"_$G(HLDUZ)
"RTN","PSOLBL4",96,0)
 Q
"RTN","PSOLBL4",97,0)
RPT ;
"RTN","PSOLBL4",98,0)
 S $P(^UTILITY($J,"PSOHLL",HLCOT),"^",9)=$S($G(PSOSUREP)!($G(RXRP(HLINRX))):1,1:0)
"RTN","PSOLBL4",99,0)
 S $P(^UTILITY($J,"PSOHLL",HLCOT),"^",10)=+$G(PDUZ)
"RTN","PSOLBL4",100,0)
 Q
"RTN","PSOLBL4",101,0)
SETZ ;
"RTN","PSOLBL4",102,0)
 D NOW^%DTC S PSODTM=%
"RTN","PSOLBL4",103,0)
 S ZTRTN=$S($$GET1^DIQ(59,PSOSITE_",",105,"I")=2.4:"INIT^PSOHLDS",1:"INIT^PSOHLSG")
"RTN","PSOLBL4",104,0)
 S ZTIO="",ZTDTH=$H,ZTSAVE("^UTILITY($J,""PSOHL"",")="",ZTSAVE("PSOPAR")="",ZTSAVE("PSOSITE")="",ZTSAVE("PSODTM")="",ZTSAVE("PSOLAP")=""
"RTN","PSOLBL4",105,0)
 S ZTSAVE("RXRP(")="",ZTSAVE("RXPR(")="",ZTSAVE("RXFL(")="",ZTSAVE("RXRS(")=""
"RTN","PSOLBL4",106,0)
 S ZTDESC=$S($$GET1^DIQ(59,PSOSITE_",",105,"I")=2.4:"Outpatient Automation External Interface",1:"GENERIC INTERFACE LABEL INFORMATION")
"RTN","PSOLBL4",107,0)
 D ^%ZTLOAD
"RTN","PSOLBL4",108,0)
 Q
"RTN","PSOLBL4",109,0)
SOMD ;send only mark drugs to external interface and print in vista
"RTN","PSOLBL4",110,0)
 S HLFLG=0 F HLLP=1:1 S HLRX=$P(PPLHL,",",HLLP) D  Q:$G(HLFLG)
"RTN","PSOLBL4",111,0)
 .S HLNEXT=$P(PPLHL,",",(HLLP+1)) I HLNEXT=""!(HLNEXT=",") S HLFLG=1
"RTN","PSOLBL4",112,0)
 .Q:'$G(HLRX)
"RTN","PSOLBL4",113,0)
 .Q:'$D(^PSRX(HLRX,0))
"RTN","PSOLBL4",114,0)
 .Q:$P($G(^PSRX(HLRX,"STA")),"^")=4
"RTN","PSOLBL4",115,0)
 .I $P($G(^PSRX(HLRX,"STA")),"^")>11!('$P(^PSRX(HLRX,0),"^",2)) Q     ;*244
"RTN","PSOLBL4",116,0)
 .Q:$G(RXRP(HLRX,"RP"))
"RTN","PSOLBL4",117,0)
 .S HLRR=$O(^PS(52.5,"B",HLRX,0)) Q:'HLRR  I $G(^PS(52.5,+HLRR,"P"))=1 K HLRR Q
"RTN","PSOLBL4",118,0)
 .S DRG=+$P($G(^PSRX(HLRX,0)),"^",6) I '$P($G(^PSDRUG(DRG,6)),"^") Q
"RTN","PSOLBL4",119,0)
 .S HLRXY(HLRX)="" ; VALID RXS
"RTN","PSOLBL4",120,0)
 I $D(HLRXY) G SOMDQ
"RTN","PSOLBL4",121,0)
 Q
"RTN","PSOLLLH")
0^3^B24123418^B23086524
"RTN","PSOLLLH",1,0)
PSOLLLH ;BIR/EJW - HIPAA/NCPDP LASER LABELS ;7/20/06 10:21am
"RTN","PSOLLLH",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**161,148,244**;DEC 1997
"RTN","PSOLLLH",3,0)
 ;
"RTN","PSOLLLH",4,0)
 ;Reference to DUR1^BPSNCPD3 supported by DBIA 4560
"RTN","PSOLLLH",5,0)
 ;
"RTN","PSOLLLH",6,0)
 ;*244 ignore Rx status > 11
"RTN","PSOLLLH",7,0)
 ;
"RTN","PSOLLLH",8,0)
SIGLOG N I,J,RXF,RXY,RXN,RX,FIRST,DATE,BLNKLIN,RX2,FDT,BLNKLN2,LAST
"RTN","PSOLLLH",9,0)
 D DEM^VADPT
"RTN","PSOLLLH",10,0)
 S FIRST=1,LAST=0
"RTN","PSOLLLH",11,0)
 S $P(BLNKLN2," ",37)=" "
"RTN","PSOLLLH",12,0)
 S $P(BLNKLIN,"_",32)="_"
"RTN","PSOLLLH",13,0)
 F I=1:1:$L(PPL,",") S RX=$P(PPL,",",I) D
"RTN","PSOLLLH",14,0)
 .I RX="" Q
"RTN","PSOLLLH",15,0)
 .Q:$G(^PSRX(RX,"STA"))>11                           ;*244
"RTN","PSOLLLH",16,0)
 .S RXY=$G(^PSRX(RX,0)) I RXY="" Q
"RTN","PSOLLLH",17,0)
 .S RX2=$G(^PSRX(RX,2)),FDT=$P(RX2,"^",2)
"RTN","PSOLLLH",18,0)
 .I FIRST!(I#4=1) D HDR S FIRST=0
"RTN","PSOLLLH",19,0)
 .S RXF=+$O(^PSRX(RX,1,"A"),-1)
"RTN","PSOLLLH",20,0)
 .I RXF>0 I +^PSRX(RX,1,RXF,0)'<FDT S FDT=+^(0)
"RTN","PSOLLLH",21,0)
 .S DATE=$E(FDT,1,7),Y=DATE X ^DD("DD") S DATE=Y
"RTN","PSOLLLH",22,0)
 .S RXN=$P(RXY,"^")
"RTN","PSOLLLH",23,0)
 .S T="Rx# "_RXN_"  "
"RTN","PSOLLLH",24,0)
 .S T=T_DATE_"  "_"Fill "_(RXF+1)_" of "_(1+$P(RXY,"^",9))_"   _____" D PRINT(T)
"RTN","PSOLLLH",25,0)
 S LAST=1 D SIGN
"RTN","PSOLLLH",26,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","PSOLLLH",27,0)
 Q
"RTN","PSOLLLH",28,0)
 ;
"RTN","PSOLLLH",29,0)
SIGN ;
"RTN","PSOLLLH",30,0)
 N II
"RTN","PSOLLLH",31,0)
 S II=I#4
"RTN","PSOLLLH",32,0)
 I LAST,II>0 F J=1:1:(4-II) S T=" " D PRINT(T)
"RTN","PSOLLLH",33,0)
 S PSOY=PSOY+10
"RTN","PSOLLLH",34,0)
 S T="Pt. Sig."_BLNKLIN D PRINT(T)
"RTN","PSOLLLH",35,0)
 S PSOY=PSOY+5
"RTN","PSOLLLH",36,0)
 D PRINT($$PLANNM())
"RTN","PSOLLLH",37,0)
 S PSOY=PSOY+15
"RTN","PSOLLLH",38,0)
 S T="Relationship_________________ Counseled? _____" D PRINT(T)
"RTN","PSOLLLH",39,0)
 S PSOY=PSOY+10
"RTN","PSOLLLH",40,0)
 S T=PNM_"  "_$G(SSNP) D PRINT(T,1)
"RTN","PSOLLLH",41,0)
 Q
"RTN","PSOLLLH",42,0)
 ;
"RTN","PSOLLLH",43,0)
HDR ;
"RTN","PSOLLLH",44,0)
 I 'FIRST D SIGN W @IOF
"RTN","PSOLLLH",45,0)
 I $G(PSOIO("BLH"))]"" X PSOIO("BLH")
"RTN","PSOLLLH",46,0)
 S T="VAMC "_$P(PS,"^",7)_", "_STATE_" "_$G(PSOHZIP) D PRINT(T)
"RTN","PSOLLLH",47,0)
 S T=$P(PS2,"^",2)_"  "_TECH_"  Ph: "_$P(PS,"^",3)_"-"_$P(PS,"^",4) D PRINT(T)
"RTN","PSOLLLH",48,0)
 I $G(PSOIO("BLB"))]"" X PSOIO("BLB")
"RTN","PSOLLLH",49,0)
 S XFONT=$E(PSOFONT,2,99)
"RTN","PSOLLLH",50,0)
 N REPMSG
"RTN","PSOLLLH",51,0)
 S REPMSG=BLNKLN2_"(REPRINT)"
"RTN","PSOLLLH",52,0)
 S T="By signing below"_$S($G(REPRINT):REPMSG,1:"") D PRINT(T,1)
"RTN","PSOLLLH",53,0)
 S T="you acknowledge receipt of the following Rx's" D PRINT(T,1)
"RTN","PSOLLLH",54,0)
 S T=" " D PRINT(T)
"RTN","PSOLLLH",55,0)
 S PSOY=PSOY-20
"RTN","PSOLLLH",56,0)
 Q
"RTN","PSOLLLH",57,0)
 ;
"RTN","PSOLLLH",58,0)
PRINT(T,B) ;
"RTN","PSOLLLH",59,0)
 S BOLD=$G(B)
"RTN","PSOLLLH",60,0)
 I 'BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT)
"RTN","PSOLLLH",61,0)
 I BOLD,$G(PSOIO(PSOFONT_"B"))]"" X PSOIO(PSOFONT_"B")
"RTN","PSOLLLH",62,0)
 I $G(PSOIO("ST"))]"" X PSOIO("ST")
"RTN","PSOLLLH",63,0)
 W T,!
"RTN","PSOLLLH",64,0)
 I $G(PSOIO("ET"))]"" X PSOIO("ET")
"RTN","PSOLLLH",65,0)
 I BOLD,$G(PSOIO(PSOFONT))]"" X PSOIO(PSOFONT) ;TURN OFF BOLDING
"RTN","PSOLLLH",66,0)
 Q
"RTN","PSOLLLH",67,0)
 ;
"RTN","PSOLLLH",68,0)
QUEUE ; ENTRY POINT TO PRINT STAND-ALONE MULTI-RX FORM
"RTN","PSOLLLH",69,0)
 I '$D(PSOPAR) D ^PSOLSET I '$D(PSOPAR) Q
"RTN","PSOLLLH",70,0)
 N REPRINT,PS,STATE,PS2,PSOHZIP,TECH
"RTN","PSOLLLH",71,0)
 S PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:"")
"RTN","PSOLLLH",72,0)
 S PS2=$P(PS,"^")_"^"_$P(PS,"^",6)
"RTN","PSOLLLH",73,0)
 I $P(PSOSYS,"^",4),$D(^PS(59,+$P($G(PSOSYS),"^",4),0)) S PS=^PS(59,$P($G(PSOSYS),"^",4),0)
"RTN","PSOLLLH",74,0)
 S VAADDR1=$P(PS,"^"),VASTREET=$P(PS,"^",2),STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UNKNOWN")
"RTN","PSOLLLH",75,0)
 S PSZIP=$P(PS,"^",5),PSOHZIP=$S(PSZIP["-":PSZIP,1:$E(PSZIP,1,5)_$S($E(PSZIP,6,9)]"":"-"_$E(PSZIP,6,9),1:""))
"RTN","PSOLLLH",76,0)
 D 6^VADPT,PID^VADPT6 S SSNP=$E($G(VA("PID")),5,12)
"RTN","PSOLLLH",77,0)
 S REPRINT=1
"RTN","PSOLLLH",78,0)
LRP W !! S DIC("S")="I $P($G(^(0)),""^"",2),$D(^(""STA"")),$P($G(^(""STA"")),""^"")<10",DIC="^PSRX(",DIC("A")="Reprint Signature Log for Prescription: ",DIC(0)="QEAZ" D ^DIC K P,DIC("A") I Y<0!("^"[X) D KILL Q
"RTN","PSOLLLH",79,0)
 W !
"RTN","PSOLLLH",80,0)
 S (PPL,RX)=+Y
"RTN","PSOLLLH",81,0)
 N RXY
"RTN","PSOLLLH",82,0)
 S RXY=$G(^PSRX(RX,0)) I RXY="" Q
"RTN","PSOLLLH",83,0)
 S TECH=$P($G(^VA(200,+$P(RXY,"^",16),0)),"^")
"RTN","PSOLLLH",84,0)
 S DFN=$P(RXY,"^",2)
"RTN","PSOLLLH",85,0)
GETPT2 D DEM^VADPT S PNM=VADM(1)
"RTN","PSOLLLH",86,0)
 I $P(VADM(6),"^",2)]"" D  G LRP
"RTN","PSOLLLH",87,0)
 .W $C(7),!!,PNM_" Died "_$P(VADM(6),"^",2)_".",!
"RTN","PSOLLLH",88,0)
Q1 W ! K POP,ZTSK S %ZIS("B")="",%ZIS="MNQ",%ZIS("A")="Select LABEL DEVICE: " D ^%ZIS S PSLION=ION K %ZIS("A")
"RTN","PSOLLLH",89,0)
 I $G(POP) Q
"RTN","PSOLLLH",90,0)
 I $G(IOST(0)),'$D(^%ZIS(2,IOST(0),55,"B","LL")) W !,"Must specify a laser labels printer for Signature Log Reprint" G Q1
"RTN","PSOLLLH",91,0)
 I '$G(IOST(0)) W !,"Nothing queued to print." H 1 Q
"RTN","PSOLLLH",92,0)
 D NOW^%DTC S Y=$P(%,"."),PSOFNOW=% X ^DD("DD") S PSONOW=Y
"RTN","PSOLLLH",93,0)
 F G="PPL","REPRINT","TECH","PNM","STATE","PS2","PSOHZIP","PSOPAR","PSOSITE","PS","PSONOW","PSOSYS","RX","SSNP" S:$D(@G) ZTSAVE(G)=""
"RTN","PSOLLLH",94,0)
 S ZTRTN="DQ^PSOLLLH",ZTIO=PSLION,ZTDESC="Outpatient Pharmacy Signature Log Reprint",ZTDTH=$H,PDUZ=DUZ
"RTN","PSOLLLH",95,0)
 D ^%ZISC,^%ZTLOAD W:$D(ZTSK) !!,"Signature Log Reprint queued",!! H 1 K G
"RTN","PSOLLLH",96,0)
 G QUEUE
"RTN","PSOLLLH",97,0)
 Q
"RTN","PSOLLLH",98,0)
DQ N PSOBIO S (I,PSOIO)=0 F  S I=$O(^%ZIS(2,IOST(0),55,I)) Q:'I  S X0=$G(^(I,0)) I X0]"" S PSOIO($P(X0,"^"))=^(1),PSOIO=1
"RTN","PSOLLLH",99,0)
 I $G(PSOIO("LLI"))]"" X PSOIO("LLI")
"RTN","PSOLLLH",100,0)
 G SIGLOG
"RTN","PSOLLLH",101,0)
 ;
"RTN","PSOLLLH",102,0)
PLANNM() ; Returns Insurance Name (3rd Party)
"RTN","PSOLLLH",103,0)
 S PLANNM=""
"RTN","PSOLLLH",104,0)
 N I,DUR,RX
"RTN","PSOLLLH",105,0)
 F I=1:1:$L(PPL,",") S RX=+$P(PPL,",",I) D  I PLANNM'="" Q
"RTN","PSOLLLH",106,0)
 .I 'RX Q
"RTN","PSOLLLH",107,0)
 .D DUR1^BPSNCPD3(RX,$$LSTRFL^PSOBPSU1(RX),.DUR) S PLANNM=$G(DUR(1,"INSURANCE NAME"))
"RTN","PSOLLLH",108,0)
 Q PLANNM
"RTN","PSOLLLH",109,0)
KILL ; CLEAN UP VARIABLES
"RTN","PSOLLLH",110,0)
 K DIC,DFN,PNM,PPL,PSZIP,RX,SSNP,VA,VADDR1,VADM,VAEL,VAPA,VASTREET
"RTN","PSOLLLH",111,0)
 Q
"RTN","PSOLLLI")
0^7^B66394524^B65332955
"RTN","PSOLLLI",1,0)
PSOLLLI ;BIR/JLC - LASER LABELS INITIALIZATION ;6/29/06 11:42am
"RTN","PSOLLLI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**120,157,189,161,244**;DEC 1997
"RTN","PSOLLLI",3,0)
 ;
"RTN","PSOLLLI",4,0)
 ;DBIAs PSDRUG-221, PS(55-2228, SC-10040, IBARX-125, PSXSRP-2201, %ZIS-3435, DPT-3097, ^TMP($J,"PSNPPIO"-3794
"RTN","PSOLLLI",5,0)
 ;External reference to DRUG^PSSWRNA supported by DBIA 4449
"RTN","PSOLLLI",6,0)
 ;
"RTN","PSOLLLI",7,0)
 ;*244 remove test for partial fill when testing status > 11
"RTN","PSOLLLI",8,0)
 ;
"RTN","PSOLLLI",9,0)
DQ N PSOBIO S (I,PSOIO)=0 F  S I=$O(^%ZIS(2,IOST(0),55,I)) Q:'I  S X0=$G(^(I,0)) I X0]"" S PSOIO($P(X0,"^"))=^(1),PSOIO=1
"RTN","PSOLLLI",10,0)
DQ1 I '$D(PPL) G HLEX
"RTN","PSOLLLI",11,0)
 I $P($G(PSOPAR),"^",30)=2,'$G(PSOEXREP) G HLEX
"RTN","PSOLLLI",12,0)
 K RXFLX S PSOCKHN=","_$G(PPL),PSRESOLV=+PPL D CHECK
"RTN","PSOLLLI",13,0)
 S PSOINT=1 F PI=1:1 S RX=$P(PPL,",",PI) Q:RX=""  D
"RTN","PSOLLLI",14,0)
 . S RXY=$G(^PSRX(RX,0)) Q:RXY=""  I PSOPDFN'=$P(RXY,"^",2),'PSOINT D TRAIL^PSOLLL1 S PSOPDFN=$P(RXY,"^",2)
"RTN","PSOLLLI",15,0)
 . K RXP,REPRINT D C
"RTN","PSOLLLI",16,0)
 I 'PSOINT D TRAIL^PSOLLL1
"RTN","PSOLLLI",17,0)
HLEX K RXPI,PSORX,RXP,PSOIOS,PSOLAPPL,XXX,COPAYVAR,TECH,PHYS,MFG,NURSE,STATE,SIDE,COPIES,EXDT,ISD,PSOINST,RXN,RXY,VADT,DEA,WARN,FDT,QTY,PATST,PDA,PS,PS1,RXP,REPRINT
"RTN","PSOLLLI",18,0)
 K SGY,OSGY,PS2,PSL,PSNP,INRX,RR,XTYPE,SSNP,SSNPN,PNM,ADDR,PSODBQ,PSOLASTF,PSRESOLV,PSOEXREP,PSOSXQ
"RTN","PSOLLLI",19,0)
 K DATE,DR,DRUG,LINE,MW,PRTFL,VRPH,EXPDT,X2,DIFF,DAYS,PSZIP,PSOHZIP,PS55,PS55X
"RTN","PSOLLLI",20,0)
 K ^TMP($J,"PSNPMI"),^TMP($J,"PSOCP",+$G(PSOCPN)),PSOCPN,PSOLBLDR,PSOLBLPS,PSOLBLCP,RXPR,RXRP,RXRS,PSOCKHN,RXFLX,PSOLAPPL,PSOPDFN,PSDFNFLG,PSOZERO,NEXTRX,PSOBLALL,STA
"RTN","PSOLLLI",21,0)
 I '$G(PSOSUREP),'$G(PSOSUSPR) S ZTREQ="@"
"RTN","PSOLLLI",22,0)
 Q
"RTN","PSOLLLI",23,0)
C N PSOBIO S (I,PSOIO)=0 F  S I=$O(^%ZIS(2,IOST(0),55,I)) Q:'I  S X0=$G(^(I,0)) I X0]"" S PSOIO($P(X0,"^"))=^(1),PSOIO=1
"RTN","PSOLLLI",24,0)
 U IO Q:'$D(^PSRX(RX,0))  S RXY=^(0),RX2=^(2),RXSTA=^("STA") K SGY,OSGY
"RTN","PSOLLLI",25,0)
 S (SIGM,PFM,PMIM,L2,L3,L4,L5,FILLCONT,BOTTLBL)=0
"RTN","PSOLLLI",26,0)
 K SIGF,PFF,PMIF S (SIGF,PFF,PMIF)=0 F I="DR","T" S (SIGF(I),PFF(I))=1
"RTN","PSOLLLI",27,0)
 F I="A","B","I" S PMIF(I)=1
"RTN","PSOLLLI",28,0)
 D NOW^%DTC S Y=$P(%,"."),PSOFNOW=% X ^DD("DD") S PSONOW=Y,Y=PSOFNOW X ^DD("DD") S PSONOWT=Y
"RTN","PSOLLLI",29,0)
 S:$G(PSOBLALL) PSOBLRX=RX S:$D(RXRP(RX)) REPRINT=1 S:$D(RXPR(RX)) RXP=RXPR(RX)
"RTN","PSOLLLI",30,0)
 I $G(PSOSUREP)!($G(PSOEXREP)) S REPRINT=1 I '$G(RXRP(RX)) S RXRP(RX)=1
"RTN","PSOLLLI",31,0)
 S A=$P(RXSTA,"^") I A>11 D AL^PSOLBL("QT") K RXP,REPRINT Q      ;*244
"RTN","PSOLLLI",32,0)
 I A=3 D AL^PSOLBL("QT") K RXP,REPRINT Q
"RTN","PSOLLLI",33,0)
 I $G(RXPR(RX)),'$D(^PSRX(RX,"P",RXP,0)) K RXP,REPRINT Q
"RTN","PSOLLLI",34,0)
 I $P($G(RXFL(RX)),"^"),'$D(^PSRX(RX,1,$P($G(RXFL(RX)),"^"),0)) K RXP,REPRINT Q
"RTN","PSOLLLI",35,0)
 I $G(PSODBQ)!($G(RXRS(RX))) S RR=$O(^PS(52.5,"B",RX,0)) Q:'RR  I $G(^PS(52.5,RR,"P"))=1 K RXP,REPRINT Q
"RTN","PSOLLLI",36,0)
 I $G(RXRS(RX))!($G(PSOPULL)) S PSOSXQ=0 N DR,DA,DIE D  I $G(PSOSXQ) K RXP,REPRINT Q
"RTN","PSOLLLI",37,0)
 . S DA=$O(^PS(52.5,"B",RX,0)) Q:'DA
"RTN","PSOLLLI",38,0)
 . S A=$P($G(^PS(52.5,DA,0)),"^",7) I A="" Q
"RTN","PSOLLLI",39,0)
 . I A="Q" S DIE="^PS(52.5,",DR="3////P" D ^DIE Q
"RTN","PSOLLLI",40,0)
 . K RXRS(RX) S PSOSXQ=1
"RTN","PSOLLLI",41,0)
 I $G(PSRESOLV)=RX D ENLBL^PSOBSET K PSRESOLV
"RTN","PSOLLLI",42,0)
 I $P(RXSTA,"^")'=4 D
"RTN","PSOLLLI",43,0)
 . I $G(PSOSUSPR) D AREC^PSOSUTL
"RTN","PSOLLLI",44,0)
 . I $G(PSOPULL)!($G(RXRS(RX))) D AREC1^PSOSUTL
"RTN","PSOLLLI",45,0)
 . I $G(PSOSUREP) D AREC^PSOSUSRP
"RTN","PSOLLLI",46,0)
 . I $G(PSXREP) D AREC^PSXSRP
"RTN","PSOLLLI",47,0)
 S RXY=^PSRX(RX,0),RX2=^(2),RXSTA=^("STA")
"RTN","PSOLLLI",48,0)
 K ^UTILITY("DIQ1",$J) S DA=$P($$SITE^VASITE(),"^")
"RTN","PSOLLLI",49,0)
 I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIC
"RTN","PSOLLLI",50,0)
 S RXN=$P(RXY,"^"),DFN=+$P(RXY,"^",2),PSOLBLPS=+$P(RXY,"^",3),PSOLBLDR=+$P(RXY,"^",6)
"RTN","PSOLLLI",51,0)
 S ISD=$P(RXY,"^",13),RXF=0,SIG=$P($G(^PSRX(RX,"SIG")),"^"),ISD=$E(ISD,4,5)_"/"_$E(ISD,6,7)_"/"_($E(ISD,1,3)+1700),ZY=0,$P(LINE,"_",28)="_"
"RTN","PSOLLLI",52,0)
 S NURSE=$S($P($G(^DPT(DFN,"NHC")),"^")="Y":1,$P($G(^PS(55,DFN,40)),"^"):1,1:0)
"RTN","PSOLLLI",53,0)
 S FDT=$P(RX2,"^",2),PS=$S($D(^PS(59,PSOSITE,0)):^(0),1:""),PS1=$S($D(^(1)):^(1),1:""),PSOSITE7=$P(^("IB"),"^")
"RTN","PSOLLLI",54,0)
 S PS2=$P(PS,"^")_"^"_$P(PS,"^",6)
"RTN","PSOLLLI",55,0)
 S EXPDT=$P(RX2,"^",6),EXDT=$S('EXPDT:"",1:$E(EXPDT,4,5)_"/"_$E(EXPDT,6,7)_"/"_($E(EXPDT,1,3)+1700))
"RTN","PSOLLLI",56,0)
 S COPIES=$S($P($G(RXRP(RX)),"^",2):$P($G(RXRP(RX)),"^",2),$P(RXY,"^",18)]"":$P(RXY,"^",18),1:1)
"RTN","PSOLLLI",57,0)
 K PSOCKHNX S PSOCKHL=$L(RX),PSOCKHN=$E($G(PSOCKHN),(PSOCKHL+2),999) D  K PSOCKHNX,PSOCKHL,PSOCKHA
"RTN","PSOLLLI",58,0)
 .S PSOCKHA=","_RX_","
"RTN","PSOLLLI",59,0)
 .I PSOCKHN'[PSOCKHA Q
"RTN","PSOLLLI",60,0)
 .S PSOCKHA=$E(PSOCKHA,1,($L(PSOCKHA)-1))
"RTN","PSOLLLI",61,0)
 .S PSOCKHNX=$L(PSOCKHN,PSOCKHA)-1
"RTN","PSOLLLI",62,0)
 .I +$G(PSOCKHNX)>0 D DOUB
"RTN","PSOLLLI",63,0)
 I $O(^PSRX(RX,1,0)),$G(RXFL(RX))'=0 S $P(^PSRX(RX,3),"^",6)="" K ^PSRX(RX,"DAI"),^PSRX(RX,"DRI")
"RTN","PSOLLLI",64,0)
 I '$G(RXP),'$O(^PSRX(RX,1,0)) S RXFL(RX)=0
"RTN","PSOLLLI",65,0)
 I '$G(RXP) D OSET I '$O(^PSRX(RX,1,0))!($G(RXFL(RX))=0) G ORIG
"RTN","PSOLLLI",66,0)
 I $O(^PSRX(RX,1,0)),'$G(RXP) D  G STA
"RTN","PSOLLLI",67,0)
 . I '$G(RXFL(RX)) S XTYPE=1 D REF
"RTN","PSOLLLI",68,0)
 I $G(RXP) S XTYPE="P" D REF G STA
"RTN","PSOLLLI",69,0)
ORIG S TECH=$P($G(^VA(200,+$P(RXY,"^",16),0)),"^"),PHYS=$S($D(^VA(200,+$P(RXY,"^",4),0)):$P(^(0),"^"),1:"UKN")
"RTN","PSOLLLI",70,0)
 S DAYS=$P(RXY,"^",8),QTY=$P(RXY,"^",7)
"RTN","PSOLLLI",71,0)
 D 6^VADPT,PID^VADPT6 S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLLLI",72,0)
STA S STATE=$S($D(^DIC(5,+$P(PS,"^",8),0)):$P(^(0),"^",2),1:"UKN")
"RTN","PSOLLLI",73,0)
 S DRUG=$$ZZ^PSOSUTL(RX),DEA=$P($G(^PSDRUG(+$P(RXY,"^",6),0)),"^",3),WARN=$P($G(^(0)),"^",8)
"RTN","PSOLLLI",74,0)
 S WARN=$$DRUG^PSSWRNA(+$P(RXY,"^",6),+$P(RXY,"^",2))
"RTN","PSOLLLI",75,0)
 S SIDE=$S($P($G(RXRP(RX)),"^",3):1,1:0)
"RTN","PSOLLLI",76,0)
 I $G(^PSRX(RX,"P",+$G(RXP),0))]"" S RXPI=RXP D
"RTN","PSOLLLI",77,0)
 .S RXP=^PSRX(RX,"P",RXP,0)
"RTN","PSOLLLI",78,0)
 .S RXY=$P(RXP,"^")_"^"_$P(RXY,"^",2,6)_"^"_$P(RXP,"^",4)_"^"_$P(RXP,"^",10)_"^"_$P(RXY,"^",9)_"^"_$P($G(^PSRX(RX,"SIG")),"^",2)_"^"_$P(RXP,"^",2)_"^"_$P(RXY,"^",12,14)_"^"_$P(^PSRX(RX,"STA"),"^")_"^"_$P(RXP,"^",7)_"^"_$P(RXY,"^",17,99)
"RTN","PSOLLLI",79,0)
 .S FDT=$P(RXP,"^")
"RTN","PSOLLLI",80,0)
 S MW=$P(RXY,"^",11) I $G(RXFL(RX))'=0 D:$G(RXFL(RX))  I '$G(RXFL(RX)) F I=0:0 S I=$O(^PSRX(RX,1,I)) Q:'I  S RXF=RXF+1 S:'$G(RXP) MW=$P(^PSRX(RX,1,I,0),"^",2) I +^PSRX(RX,1,I,0)'<FDT S FDT=+^(0)
"RTN","PSOLLLI",81,0)
 .I $G(RXFL(RX)),'$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLLLI",82,0)
 .S RXF=RXFL(RX) S:'$G(RXP) MW=$P($G(^PSRX(RX,1,RXF,0)),"^",2) I +^PSRX(RX,1,RXF,0)'<FDT S FDT=+^(0)
"RTN","PSOLLLI",83,0)
 I MW="W",$G(^PSRX(RX,"MP"))]"" D
"RTN","PSOLLLI",84,0)
 .S PSMP=^PSRX(RX,"MP"),PSJ=0 F PSI=1:1:$L(PSMP) S PSMP(PSI)="",PSJ=PSJ+1 F PSJ=PSJ:1 S PSMP(PSI)=PSMP(PSI)_$P(PSMP," ",PSJ)_" " Q:($L(PSMP(PSI))+$L($P(PSMP," ",PSJ+1))>30)
"RTN","PSOLLLI",85,0)
 .K PSMP(PSI)
"RTN","PSOLLLI",86,0)
 ;New mail codes for CMOP
"RTN","PSOLLLI",87,0)
 S MAILCOM=""
"RTN","PSOLLLI",88,0)
 S X=$G(^PS(55,DFN,0)),PSCAP=$P(X,"^",2),PS55=$P(X,"^",3),PS55X=$P(X,"^",5)
"RTN","PSOLLLI",89,0)
 I PS55X]"",PS55>1,PS55X<DT S PS55=1
"RTN","PSOLLLI",90,0)
 S:MW="M" MW=$S((PS55=1!(PS55=4)):"R",1:MW)
"RTN","PSOLLLI",91,0)
 S MAILCOM=$P($G(^PS(59,PSOSITE,9)),"^")
"RTN","PSOLLLI",92,0)
 S MW=$S(MW="M":"REGULAR",MW="R":"CERTIFIED",1:"WINDOW")
"RTN","PSOLLLI",93,0)
 I $G(PSMP(1))="",$G(PS55)=2 S PSMP(1)=$G(SSNPN)
"RTN","PSOLLLI",94,0)
 S DATE=$E(FDT,1,7),REF=$P(RXY,"^",9)-RXF S:'$G(RXP) $P(^PSRX(RX,3),"^")=FDT S:REF<1 REF=0 D ^PSOLBL2 S II=RX D ^PSORFL,RFLDT^PSORFL
"RTN","PSOLLLI",95,0)
 S (X,PSOFLAST)=$G(PSOLASTF) I X?1N.E D ^%DT X ^DD("DD") S PSOFLAST=Y
"RTN","PSOLLLI",96,0)
 S PATST=$G(^PS(53,+$P(RXY,"^",3),0)) S PRTFL=1 I REF=0 S:('$P(PATST,"^",5))!(DEA["A"&(DEA'["B"))!(DEA["W") PRTFL=0
"RTN","PSOLLLI",97,0)
 S VRPH=$P(RX2,"^",10),PSCLN=+$P(RXY,"^",5),PSCLN=$G(^SC(PSCLN,0)),PSCLN=$S($P(PSCLN,"^",2)'="":$P(PSCLN,"^",2),1:$E($P(PSCLN,"^"),1,7)) I PSCLN="" S PSCLN="UNKNOWN"
"RTN","PSOLLLI",98,0)
 S PATST=$P(PATST,"^",2),X1=DT,X2=$P(RXY,"^",8)-10 D C^%DTC:REF I $D(^PSRX(RX,2)),$P(^(2),"^",6),REF,X'<$P(^(2),"^",6) S REF=0,VRPH=$P(^(2),"^",10)
"RTN","PSOLLLI",99,0)
 I $G(PSOCHAMP),$G(PSOTRAMT) S COPAYVAR="CHAMPUS" G LBL
"RTN","PSOLLLI",100,0)
 I $G(RXP) S COPAYVAR="" G LBL
"RTN","PSOLLLI",101,0)
 I $P($G(^PS(53,+$G(PSOLBLPS),0)),"^",7) D SNO G LBL
"RTN","PSOLLLI",102,0)
 I DEA["I"!(DEA["S") D SNO G LBL
"RTN","PSOLLLI",103,0)
 I $P(^PSRX(RX,"STA"),"^")>0,$P(^("STA"),"^")'=2,'$G(PSODBQ) D SNO G LBL
"RTN","PSOLLLI",104,0)
 I $G(PSOLBLCP)="" D IBCP
"RTN","PSOLLLI",105,0)
 N PSOQI S PSOQI=$G(^PSRX(RX,"IBQ"))
"RTN","PSOLLLI",106,0)
 I $G(PSOLBLCP)=0 D SNO G LBL
"RTN","PSOLLLI",107,0)
 I $G(PSOLBLCP)=1 I $P(PSOQI,"^",2)!($P(PSOQI,"^",3))!($P(PSOQI,"^",4))!($P(PSOQI,"^",5))!($P(PSOQI,"^",6))!($P(PSOQI,"^",7)) D SNO G LBL
"RTN","PSOLLLI",108,0)
 I $G(PSOLBLCP)=2 I $P(PSOQI,"^")!($P(PSOQI,"^",2))!($P(PSOQI,"^",3))!($P(PSOQI,"^",4))!($P(PSOQI,"^",5))!($P(PSOQI,"^",6))!($P(PSOQI,"^",7)) D SNO G LBL
"RTN","PSOLLLI",109,0)
 I $G(PSOLBLCP)=2,'$P($G(^PSRX(RX,"IB")),"^") D SNO G LBL
"RTN","PSOLLLI",110,0)
 S PSOCPN=$P(RXY,"^",2),INRX=$P(RXY,"^")
"RTN","PSOLLLI",111,0)
 I $G(^TMP($J,"PSOCP",PSOCPN))="" S ^(PSOCPN)=PSOCPN
"RTN","PSOLLLI",112,0)
 S ^TMP($J,"PSOCP",PSOCPN,INRX)=INRX_"^"_$$ZZ^PSOSUTL(RX)_"^"_+$G(DAYS),COPAYVAR="COPAY" K ZDRUG
"RTN","PSOLLLI",113,0)
LBL I $G(PSOIO("LLI"))]"" X PSOIO("LLI")
"RTN","PSOLLLI",114,0)
 I $P(RXSTA,"^")=4 D ^PSOLLL8 Q  ;for a critical interaction entered by a tech - don't allow a label to be printed
"RTN","PSOLLLI",115,0)
 I $D(^PSRX(RX,"DRI")),'$G(RXF),'$G(RXP) D ^PSOLLL8
"RTN","PSOLLLI",116,0)
 I $P($G(^PSRX(RX,3)),"^",6),'$G(RXF),'$G(RXP) D ^PSOLLL9
"RTN","PSOLLLI",117,0)
 S PSOINT=0 G ^PSOLLL1
"RTN","PSOLLLI",118,0)
REF F XXX=0:0 S XXX=$O(^PSRX(RX,XTYPE,XXX)) Q:+XXX'>0  D
"RTN","PSOLLLI",119,0)
 .S TECH=$S($D(^VA(200,+$P(^PSRX(RX,XTYPE,XXX,0),"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLLLI",120,0)
 .S QTY=$P(^PSRX(RX,XTYPE,XXX,0),"^",4),PHYS=$S($D(^VA(200,+$P(^PSRX(RX,XTYPE,XXX,0),"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT6 S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLLLI",121,0)
 .S DAYS=$P(^PSRX(RX,XTYPE,XXX,0),"^",10)
"RTN","PSOLLLI",122,0)
 Q
"RTN","PSOLLLI",123,0)
CHECK S PSDFNFLG=0,PSOZERO=$P(PPL,","),PSOPDFN=$P(^PSRX(PSOZERO,0),"^",2)
"RTN","PSOLLLI",124,0)
 Q
"RTN","PSOLLLI",125,0)
OSET ;
"RTN","PSOLLLI",126,0)
 N A
"RTN","PSOLLLI",127,0)
 I $G(RXFL(RX))']""!($G(RXFL(RX))=0) D  Q
"RTN","PSOLLLI",128,0)
 .S A=^PSRX(RX,0)
"RTN","PSOLLLI",129,0)
 .S TECH=$P($G(^VA(200,+$P(A,"^",16),0)),"^"),QTY=$P(A,"^",7),PHYS=$S($D(^VA(200,+$P(A,"^",4),0)):$P(^(0),"^"),1:"UKN") D 6^VADPT,PID^VADPT6 S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLLLI",130,0)
 .S DAYS=$P(A,"^",8)
"RTN","PSOLLLI",131,0)
 I '$D(^PSRX(RX,1,RXFL(RX),0)) K RXFL(RX) Q
"RTN","PSOLLLI",132,0)
 S A=^PSRX(RX,1,RXFL(RX),0)
"RTN","PSOLLLI",133,0)
 S TECH=$S($D(^VA(200,+$P(A,"^",7),0)):$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSOLLLI",134,0)
 S QTY=$P(A,"^",4),PHYS=$S($D(^VA(200,+$P(A,"^",17),0)):$P(^(0),"^"),$D(^VA(200,+$P(^PSRX(RX,0),"^",4),0)):$P(^(0),"^"),1:"UNKNOWN") D 6^VADPT,PID^VADPT6 S SSNPN=$E($G(VA("PID")),5,12)
"RTN","PSOLLLI",135,0)
 S DAYS=$P(A,"^",10)
"RTN","PSOLLLI",136,0)
 Q
"RTN","PSOLLLI",137,0)
DOUB ;
"RTN","PSOLLLI",138,0)
 Q:'$D(RXFL(RX))
"RTN","PSOLLLI",139,0)
 I +$G(RXFL(RX))-PSOCKHNX<0 Q
"RTN","PSOLLLI",140,0)
 S RXFLX(RX)=$G(RXFL(RX))
"RTN","PSOLLLI",141,0)
 S RXFL(RX)=$G(RXFL(RX))-PSOCKHNX
"RTN","PSOLLLI",142,0)
 Q
"RTN","PSOLLLI",143,0)
IBCP ;
"RTN","PSOLLLI",144,0)
 N X,Y,PSOJJ,PSOLL
"RTN","PSOLLLI",145,0)
 S PSOLBLCP=""
"RTN","PSOLLLI",146,0)
 S X=$P($G(^PS(59,+$G(PSOSITE),"IB")),"^")_"^"_$G(DFN) D XTYPE^IBARX
"RTN","PSOLLLI",147,0)
 S PSOJJ="" F  S PSOJJ=$O(Y(PSOJJ)) Q:'PSOJJ  S PSOLL="" F  S PSOLL=$O(Y(PSOJJ,PSOLL)) Q:PSOLL=""  S:PSOLL>0 PSOLBLCP=PSOLL
"RTN","PSOLLLI",148,0)
 I '$G(PSOLBLCP) S PSOLBLCP=0
"RTN","PSOLLLI",149,0)
 Q
"RTN","PSOLLLI",150,0)
SNO ;
"RTN","PSOLLLI",151,0)
 S COPAYVAR="NO COPAY"
"RTN","PSOLLLI",152,0)
 Q
"RTN","PSOORED1")
0^4^B67696730^B65457372
"RTN","PSOORED1",1,0)
PSOORED1 ;ISC-BHAM/SAB - edit orders from backdoor ;6/30/06 10:21am
"RTN","PSOORED1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**5,23,46,78,114,117,131,146,223,148,244**;DEC 1997
"RTN","PSOORED1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOORED1",4,0)
 ;External reference ^PS(50.7 supported by DBIA 2223
"RTN","PSOORED1",5,0)
 ;
"RTN","PSOORED1",6,0)
 ;*244 call to remove DC'd Rx's from Rx ien strings
"RTN","PSOORED1",7,0)
 ;
"RTN","PSOORED1",8,0)
EN(PSORENW) ;
"RTN","PSOORED1",9,0)
 N LST,ORD,ORN K VALMBCK,PSORX("FN") S PSOAC=1,(PSORX("QFLG"),PSORX("DFLG"))=0 ;D DREN^PSOORNW2,INIT
"RTN","PSOORED1",10,0)
 D INIT
"RTN","PSOORED1",11,0)
 D @$S($P(PSOPAR,"^",7):"AUTO^PSONRXN",1:"MANUAL^PSONRXN")
"RTN","PSOORED1",12,0)
 I '$D(PSONEW("RX #")),'$P(PSOPAR,"^",7) D PAUSE^VALM1 K VALMSG,PSONEW("QFLG") S VALMBCK="Q" Q
"RTN","PSOORED1",13,0)
 I '$D(PSONEW("RX #")) K VALMSG D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" Q
"RTN","PSOORED1",14,0)
 S PSORENW("RX #")=PSONEW("RX #") I '$P(PSOPAR,"^",7) D  Q:$G(PSONEW("DFLG"))!($G(PSONEW("QFLG")))
"RTN","PSOORED1",15,0)
 .S PSOX=PSORENW("RX #") D CHECK^PSONRXN
"RTN","PSOORED1",16,0)
 I $G(PSONEW("DFLG"))!$G(PSONEW("QFLG")) D DEL^PSONEW,PAUSE^VALM1 S VALMBCK="Q" K PSORENW Q
"RTN","PSOORED1",17,0)
 D EN^PSOORNE1(.PSORENW) I '$G(PSORX("FN")) D:$P($G(PSOPAR),"^",7)=1  S VALMBCK="Q" Q
"RTN","PSOORED1",18,0)
 .S DIE="^PS(59,",DA=PSOSITE,PSOY=$O(PSONEW("OLD LAST RX#","")),PSOX=PSONEW("OLD LAST RX#",PSOY)
"RTN","PSOORED1",19,0)
 .L +^PS(59,+PSOSITE,PSOY):0
"RTN","PSOORED1",20,0)
 .S DR=$S(PSOY=8:"2003////"_PSOX,PSOY=3:"1002.1////"_PSOX,1:"2003////"_PSOX)
"RTN","PSOORED1",21,0)
 .D:PSOX<$P(^PS(59,+PSOSITE,PSOY),"^",3) ^DIE K DIE,X,Y L -^PS(59,+PSOSITE,PSOY)
"RTN","PSOORED1",22,0)
 .I $D(PSONEW("RX #")) L -^PSRX("B",PSONEW("RX #"))
"RTN","PSOORED1",23,0)
 .K PSOX,PSOY Q
"RTN","PSOORED1",24,0)
 Q:$G(COPY)
"RTN","PSOORED1",25,0)
TRY S $P(^PSRX(PSORENW("OIRXN"),"STA"),"^")=15,DA=PSORENW("OIRXN")
"RTN","PSOORED1",26,0)
 S $P(^PSRX(DA,3),"^",5)=$S($P($G(^PSRX(DA,3)),"^"):$P(^(3),"^"),1:DT)
"RTN","PSOORED1",27,0)
 D REVERSE^PSOBPSU1(DA,,"DC",7),CAN^PSOTPCAN(DA)
"RTN","PSOORED1",28,0)
 D RMP^PSOCAN3                ;*244
"RTN","PSOORED1",29,0)
 ;cancel/discontinue action
"RTN","PSOORED1",30,0)
 S PHARM="",STAT="RP",COMM="Prescription discontinued due to editing." D EN^PSOHLSN1(DA,STAT,PHARM,COMM,PSONOOR) K STAT,PHARM,COMM
"RTN","PSOORED1",31,0)
 S ACOM="Discontinued due to editing. New Rx created "_$P(^PSRX(PSORENW("IRXN"),0),"^")_"."
"RTN","PSOORED1",32,0)
 I $G(^PSRX(DA,"H"))]"" D
"RTN","PSOORED1",33,0)
 .I $P(^PSRX(DA,"STA"),"^")=3!($P(^("STA"),"^")=16) D
"RTN","PSOORED1",34,0)
 ..S DIE=52,DR="22///"_$P(^PSRX(DA,3),"^") D ^DIE S ACOM="Discontinued due to editing while on hold. " K:$P(^PSRX(DA,"H"),"^") ^PSRX("AH",$P(^PSRX(DA,"H"),"^"),DA)
"RTN","PSOORED1",35,0)
 ..S ^PSRX(DA,"H")=""
"RTN","PSOORED1",36,0)
 S RXDA=DA,(DA,SUSDA)=$O(^PS(52.5,"B",RXDA,0)) D:DA
"RTN","PSOORED1",37,0)
 .S SUSD=$P($G(^PS(52.5,DA,0)),"^",2)
"RTN","PSOORED1",38,0)
 .S:+$G(^PS(52.5,DA,"P"))'=1 ACOM="Discontinued due to editing while suspended."
"RTN","PSOORED1",39,0)
 .I $O(^PSRX(RXDA,1,0)) S DA=RXDA D:'$G(^PS(52.5,+SUSDA,"P")) REF^PSOCAN2
"RTN","PSOORED1",40,0)
 .S DA=SUSDA,DIK="^PS(52.5," D ^DIK K DIK
"RTN","PSOORED1",41,0)
 K SUSD,SUSDA S DA=RXDA,RXREF=0,PSODFN=+$P(^PSRX(DA,0),"^",2) D
"RTN","PSOORED1",42,0)
 .S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(DA,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOORED1",43,0)
 .S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(DA,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOORED1",44,0)
 .D NOW^%DTC S ^PSRX(DA,"A",0)="^52.3DA^"_(ACNT+1)_"^"_(ACNT+1),^PSRX(DA,"A",ACNT+1,0)=%_"^C^"_DUZ_"^"_RFCNT_"^"_$G(ACOM)
"RTN","PSOORED1",45,0)
 .I $G(PSOOIFLG),'$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item Edited."
"RTN","PSOORED1",46,0)
 .I '$G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Medication Route/Schedule Edited."
"RTN","PSOORED1",47,0)
 .I $G(PSOOIFLG),$G(PSOMRFLG) S $P(^PSRX(DA,"A",ACNT+1,1),"^")="Pharmacy Orderable Item and Medication Route/Schedule Edited."
"RTN","PSOORED1",48,0)
 .S REA="C" D EXP^PSOHELP1
"RTN","PSOORED1",49,0)
 I $G(^PS(52.4,DA,0))]"" S PSCDA=DA,DIK="^PS(52.4," D ^DIK S DA=PSCDA K DIK,PSCDA
"RTN","PSOORED1",50,0)
 Q
"RTN","PSOORED1",51,0)
INS K X,QUIT,Y,DIR,DIRUT,DUOUT,DTOUT,DIC,INSDEL,UPMI,^TMP($J,"INS1")
"RTN","PSOORED1",52,0)
 I '$O(^PSRX(PSORXED("IRXN"),6,0)),'$O(PSORXED("DOSE",0)) D UPMI Q:$G(QUIT)  ;G INS1
"RTN","PSOORED1",53,0)
 I $G(^PSRX(PSORXED("IRXN"),"INS"))]"" S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS") K UPMI G INS1
"RTN","PSOORED1",54,0)
 K DD,GG F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S DD=$G(DD)+1
"RTN","PSOORED1",55,0)
 I $G(DD)=1 S PSORXED("FLD",114)=^PSRX(PSORXED("IRXN"),"INS1",$O(^PSRX(PSORXED("IRXN"),"INS1",0)),0) K UPMI,DD G INS1
"RTN","PSOORED1",56,0)
 I $O(^PSRX(PSORXED("IRXN"),"INS1",0)) D  G INSX
"RTN","PSOORED1",57,0)
 .F I=0:0 S I=$O(^PSRX(PSORXED("IRXN"),"INS1",I)) Q:'I  S ^TMP($J,"INS1",I,0)=^PSRX(PSORXED("IRXN"),"INS1",I,0)
"RTN","PSOORED1",58,0)
 .S ^TMP($J,"INS1",0)=^PSRX(PSORXED("IRXN"),"INS1",0)
"RTN","PSOORED1",59,0)
 .S DIC="^TMP($J,""INS1"",",DWPK=2,DWLW=80 D EN^DIWE I $G(X)="^" K ^TMP($J,"INS1") Q
"RTN","PSOORED1",60,0)
 .I '$O(^TMP($J,"INS1",0)) S INSDEL=1
"RTN","PSOORED1",61,0)
 .S D=0 F  S D=$O(^PSRX(PSORXED("IRXN"),"INS1",D)) Q:'D  S PSORXED("SIG",D)=^PSRX(PSORXED("IRXN"),"INS1",D,0)
"RTN","PSOORED1",62,0)
INS1 K Y,DIR,DIRUT,DUOUT,DTOUT,DIC,X
"RTN","PSOORED1",63,0)
 I $G(UPMI) K UPMI I $G(^PS(50.7,PSODRUG("OI"),"INS"))]"" S PSORXED("FLD",114)=^PS(50.7,PSODRUG("OI"),"INS")
"RTN","PSOORED1",64,0)
 S:$G(PSORXED("FLD",114))]"" DIR("B")=PSORXED("FLD",114)
"RTN","PSOORED1",65,0)
 S DIR("?")="Enter Quick codes or Free Text",DIR(0)="52,114" D ^DIR
"RTN","PSOORED1",66,0)
 I $D(DTOUT)!($D(DUOUT))!($G(PSORXED("FLD",114))=X) K PSORXED("FLD",114) G INSX
"RTN","PSOORED1",67,0)
 I X'="",X'="@" D SIG^PSOHELP G INS1:'$D(X)
"RTN","PSOORED1",68,0)
 S PSORXED("FLD",114)=X
"RTN","PSOORED1",69,0)
 I $G(INS1)]"" W " ("_$E(INS1,2,9999999)_")"
"RTN","PSOORED1",70,0)
 G:(X']""!(X="@")) INSX
"RTN","PSOORED1",71,0)
 S (PSORXED("INS"),PSORXED("SIG",1))=$E(INS1,2,9999999) D EN^PSOFSIG(.PSORXED)
"RTN","PSOORED1",72,0)
INSX I $P($G(^PS(55,PSODFN,"LAN")),"^") K DIR D
"RTN","PSOORED1",73,0)
 .I $G(^PSRX(PSORXED("IRXN"),"INSS"))]"" S PSORXED("SINS")=^PSRX(PSORXED("IRXN"),"INSS")
"RTN","PSOORED1",74,0)
 .D SINS^PSODIR(.PSORXED) I $G(PSORXED("SINS"))']"" K ^PSRX(PSORXED("IRXN"),"INSS") Q
"RTN","PSOORED1",75,0)
 .S PSORXED("FLD",114.1)=PSORXED("SINS")
"RTN","PSOORED1",76,0)
 K DIRUT,DUOUT,DTOUT,DIR,X,Y,DIC,DWPK
"RTN","PSOORED1",77,0)
 Q
"RTN","PSOORED1",78,0)
INIT ;setup psorenw array
"RTN","PSOORED1",79,0)
 S PSORENW("RX0")=^PSRX(PSORENW("IRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN"))
"RTN","PSOORED1",80,0)
 I $G(PSOSIGFL),$G(PSORX("SIG"))]"" S PSORENW("SIG")=PSORX("SIG"),SIGOK=0
"RTN","PSOORED1",81,0)
 E  D
"RTN","PSOORED1",82,0)
 .I '$P($G(^PSRX(PSORENW("IRXN"),"SIG")),"^",2) S PSORENW("SIG")=$P($G(^("SIG")),"^")
"RTN","PSOORED1",83,0)
 .E  D
"RTN","PSOORED1",84,0)
 ..S SIGOK=1 Q:$O(SIG(0))
"RTN","PSOORED1",85,0)
 ..S D=0 F I=0:0 S D=D+1,I=$O(^PSRX(PSORENW("IRXN"),"SIG1",I)) Q:'I  S SIG(D)=^PSRX(PSORENW("IRXN"),"SIG1",I,0)
"RTN","PSOORED1",86,0)
 ..K PSOX1,D
"RTN","PSOORED1",87,0)
 S PSORENW("OIRXN")=PSORENW("IRXN")
"RTN","PSOORED1",88,0)
 S PSORENW("PROVIDER")=$S($G(PSORENW("PROVIDER")):PSORENW("PROVIDER"),1:$P(PSORENW("RX0"),"^",4))
"RTN","PSOORED1",89,0)
 S (PSORENW("PROVIDER NAME"),PSORX("PROVIDER NAME"))=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSOORED1",90,0)
 I $P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",7),$P($G(^("PS")),"^",8) S PSORENW("COSIGNING PROVIDER")=$P($G(^("PS")),"^",8)
"RTN","PSOORED1",91,0)
 S PSORENW("CLINIC")=$S($G(PSORENW("CLINIC")):PSORENW("CLINIC"),1:$P(PSORENW("RX0"),"^",5))
"RTN","PSOORED1",92,0)
 S PSORENW("REMARKS")="New Order Created by "_$S($G(COPY)&('$G(PSOEDIT)):"copying",1:"editing")_" Rx # "_$P(PSORENW("RX0"),"^")_"."
"RTN","PSOORED1",93,0)
 S PSORENW("COSIGNER")=$S($G(PSORENW("COSIGNER")):PSORENW("COSIGNER"),$P(PSORENW("RX3"),"^",3):$P(PSORENW("RX3"),"^",3),1:"")
"RTN","PSOORED1",94,0)
 K:PSORENW("COSIGNER")="" PSORENW("COSIGNER")
"RTN","PSOORED1",95,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSOORED1",96,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSOORED1",97,0)
 S:$G(PSODRUG("IEN")) PSORENW("DRUG IEN")=PSODRUG("IEN")
"RTN","PSOORED1",98,0)
 I $G(PSORENW("DAYS SUPPLY")) G QTY
"RTN","PSOORED1",99,0)
 S PSORENW("DAYS SUPPLY")=$S($D(CLOZPAT):7,1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",100,0)
QTY S PSORENW("QTY")=$S($G(PSORENW("QTY")):PSORENW("QTY"),1:$P(PSORENW("RX0"),"^",7))
"RTN","PSOORED1",101,0)
RFN S PSORENW("# OF REFILLS")=$S($D(CLOZPAT):0,$G(PSORENW("# OF REFILLS")):PSORENW("# OF REFILLS"),1:$P(PSORENW("RX0"),"^",9))
"RTN","PSOORED1",102,0)
 S (PSOID,Y,PSORENW("FILL DATE"),PSORENW("ISSUE DATE"))=DT
"RTN","PSOORED1",103,0)
 S:PSORENW("CLINIC") PSORX("CLINIC")=$P(^SC(+PSORENW("CLINIC"),0),"^")
"RTN","PSOORED1",104,0)
 S PSORENW("PATIENT STATUS")=$S($G(PSORENW("PATIENT STATUS")):PSORENW("PATIENT STATUS"),'$P(PSORENW("RX0"),"^",3):$G(^PS(55,PSORENW("PSODFN"),"PS")),1:$P(PSORENW("RX0"),"^",3))
"RTN","PSOORED1",105,0)
 S PSORENW("PTST NODE")=$G(^PS(53,PSORENW("PATIENT STATUS"),0))
"RTN","PSOORED1",106,0)
 S PSDAYS=$S($G(PSORENW("DAYS SUPPLY")):PSORENW("DAYS SUPPLY"),'$P(PSORENW("RX0"),"^",8):$P(PSORENW("PTST NODE"),"^",3),1:$P(PSORENW("RX0"),"^",8))
"RTN","PSOORED1",107,0)
 I $G(PSODRUG("IEN")) S DREN=PSODRUG("IEN"),POERR=1 D DRG^PSOORDRG K POERR
"RTN","PSOORED1",108,0)
 D:$G(PSORENW("# OF REFILLS"))']"" RF
"RTN","PSOORED1",109,0)
 S PSORENW("MAIL/WINDOW")=$S($G(PSORENW("MAIL/WINDOW"))]"":PSORENW("MAIL/WINDOW"),1:$P(PSORENW("RX0"),"^",11))
"RTN","PSOORED1",110,0)
 S PSORX("MAIL/WINDOW")=$S(PSORENW("MAIL/WINDOW")="W":"WINDOW",1:"MAIL")
"RTN","PSOORED1",111,0)
 S PSORENW("COPIES")=$S($G(PSORENW("COPIES")):PSORENW("COPIES"),$P(PSORENW("RX0"),"^",18):$P(PSORENW("RX0"),"^",18),1:1)
"RTN","PSOORED1",112,0)
 S PSORENW("CLERK CODE")=DUZ
"RTN","PSOORED1",113,0)
 S:$G(PSORX("CLERK CODE"))']"" PSORX("CLERK CODE")=$P($G(^VA(200,DUZ,0)),"^")
"RTN","PSOORED1",114,0)
 Q:$D(COPY)  S PSORENW("ENT")=0 ;Q:$G(PSOSIGFL)!($D(COPY))
"RTN","PSOORED1",115,0)
 K PSORENW("ENT") F I=0:0 S I=$O(PSORENW("DOSE",I)) Q:'I  S PSORENW("ENT")=$G(PSORENW("ENT"))+1
"RTN","PSOORED1",116,0)
 I $O(^TMP($J,"INS1",0)) D
"RTN","PSOORED1",117,0)
 .K PSORXED("SIG"),DD
"RTN","PSOORED1",118,0)
 .F I=0:0 S I=$O(^TMP($J,"INS1",I)) Q:'I  S PSORENW("SIG",I)=^TMP($J,"INS1",I,0)
"RTN","PSOORED1",119,0)
 .K ^TMP($J,"INS1")
"RTN","PSOORED1",120,0)
 I $G(^PSRX(PSORENW("IRXN"),"INS"))]"" S PSORENW("INS")=^PSRX(PSORENW("IRXN"),"INS")
"RTN","PSOORED1",121,0)
 I $G(^PSRX(PSORENW("IRXN"),"INSS"))]"" S PSORENW("SINS")=^PSRX(PSORENW("IRXN"),"INSS")
"RTN","PSOORED1",122,0)
 I '$G(PSORENW("ENT")),'$G(PSOSIGFL) D DOLST1^PSOORED3(.PSORENW) S PSORENW("ENT")=+$G(OLENT)
"RTN","PSOORED1",123,0)
 Q
"RTN","PSOORED1",124,0)
RF ;# of refills
"RTN","PSOORED1",125,0)
 S PTRF=$S($P(PSORENW("PTST NODE"),"^",4)]"":$P(PSORENW("PTST NODE"),"^",4),1:11)
"RTN","PSOORED1",126,0)
 S CS=0 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S CS=1
"RTN","PSOORED1",127,0)
 I CS D
"RTN","PSOORED1",128,0)
 .S PSOX1=$S(PTRF>5:5,1:PTRF),PSOX=$S(PSOX1=5:5,1:PSOX1)
"RTN","PSOORED1",129,0)
 .S PSOX=$S('PSOX:0,PSDAYS=90:1,1:PSOX),PSDY1=$S(PSDAYS<60:5,PSDAYS'<60&(PSDAYS'>89):2,PSDAYS=90:1,1:0) S PSORENW("# OF REFILLS")=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORED1",130,0)
 E  D
"RTN","PSOORED1",131,0)
 .S PSOX1=PTRF,PSOX=$S(PSOX1=11:11,1:PSOX1),PSOX=$S('PSOX:0,PSDAYS=90:3,1:PSOX)
"RTN","PSOORED1",132,0)
 .S PSDY1=$S(PSDAYS<60:11,PSDAYS'<60&(PSDAYS'>89):5,PSDAYS=90:3,1:0) S PSORENW("# OF REFILLS")=$S(PSOX'>PSDY1:PSOX,1:PSDY1)
"RTN","PSOORED1",133,0)
 I PSODRUG("DEA")["A"&(PSODRUG("DEA")'["B")!(PSODRUG("DEA")["F") S PSORENW("# OF REFILLS")=0
"RTN","PSOORED1",134,0)
 K PSDY,PSDY1,PTRF,PSOX,PSOX1,PSDAYS,CS
"RTN","PSOORED1",135,0)
 Q
"RTN","PSOORED1",136,0)
UPMI ;add dosing data for pre-poe rxs
"RTN","PSOORED1",137,0)
 W !! K PSONEW("DFLG"),DIR,DIRUT,DTOUT,DUOUT S DIR(0)="Y",DIR("B")="No",DIR("A")="Dosing Instructions Are Missing!! Do You Want to Add Them"
"RTN","PSOORED1",138,0)
 D ^DIR I 'Y!($D(DIRUT)) S QUIT=1 K DIR,DIRUT,DUOT,DUOUT Q
"RTN","PSOORED1",139,0)
 S UPMI=1,EDTHLD=$G(PSORX("EDIT")) K PSORX("EDIT")
"RTN","PSOORED1",140,0)
 D DOSE1^PSOORED5(.PSORXED) S (PSORXED,PSORX("EDIT"))=EDTHLD K EDTHLD I $G(PSONEW("DFLG")) S QUIT=1
"RTN","PSOORED1",141,0)
 Q
"VER")
8.0^22.0
"BLD",6775,6)
^215
**END**
**END**
