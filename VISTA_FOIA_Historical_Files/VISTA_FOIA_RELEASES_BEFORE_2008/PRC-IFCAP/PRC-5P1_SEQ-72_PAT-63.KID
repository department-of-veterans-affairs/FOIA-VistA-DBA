Released PRC*5.1*63 SEQ #72
Extracted from mail message
**KIDS**:PRC*5.1*63^

**INSTALL NAME**
PRC*5.1*63
"BLD",2886,0)
PRC*5.1*63^IFCAP^0^3050810^y
"BLD",2886,1,0)
^^11^11^3050106^^^^
"BLD",2886,1,1,0)
This patch installs software in support of the National Item File - Phase 
"BLD",2886,1,2,0)
1 initiative, as defined by IT Service Request #20020708.
"BLD",2886,1,3,0)
 
"BLD",2886,1,4,0)
IFCAP has been enhanced to receive via an X12 Item Maintenance 888 
"BLD",2886,1,5,0)
transaction, the National Item File (NIF)'s item number, short description
"BLD",2886,1,6,0)
and extended description and store them in the corresponding entry of the
"BLD",2886,1,7,0)
local IFCAP system's ITEM MASTER file (#441). The NIF item number now is 
"BLD",2886,1,8,0)
a write identifier for this file.  One can now also select entries using 
"BLD",2886,1,9,0)
the NIF item number.  In addition, the NIF item number is now sent in the 
"BLD",2886,1,10,0)
'IT' segment of the PHA transaction for inclusion in OA&MM's Procurement 
"BLD",2886,1,11,0)
History database at the Austin Automation Center (AAC).
"BLD",2886,4,0)
^9.64PA^441^1
"BLD",2886,4,441,0)
441
"BLD",2886,4,441,2,0)
^9.641^441^1
"BLD",2886,4,441,2,441,0)
ITEM MASTER  (File-top level)
"BLD",2886,4,441,2,441,1,0)
^9.6411^52^3
"BLD",2886,4,441,2,441,1,50,0)
PRE_NIF LONG DESCRIPTION
"BLD",2886,4,441,2,441,1,51,0)
NIF ITEM NUMBER
"BLD",2886,4,441,2,441,1,52,0)
PRE_NIF SHORT DESCRIPTION
"BLD",2886,4,441,222)
y^n^p^^^^n
"BLD",2886,4,"APDD",441,441)

"BLD",2886,4,"APDD",441,441,50)

"BLD",2886,4,"APDD",441,441,51)

"BLD",2886,4,"APDD",441,441,52)

"BLD",2886,4,"B",441,441)

"BLD",2886,"ABPKG")
n
"BLD",2886,"INID")
y^y
"BLD",2886,"INIT")
EN^PRC5163P
"BLD",2886,"KRN",0)
^9.67PA^19^17
"BLD",2886,"KRN",.4,0)
.4
"BLD",2886,"KRN",.4,"NM",0)
^9.68A^^
"BLD",2886,"KRN",.401,0)
.401
"BLD",2886,"KRN",.402,0)
.402
"BLD",2886,"KRN",.402,"NM",0)
^9.68A^2^2
"BLD",2886,"KRN",.402,"NM",1,0)
PRCHITEM    FILE #441^441^0
"BLD",2886,"KRN",.402,"NM",2,0)
PRCHITEM2    FILE #441^441^0
"BLD",2886,"KRN",.402,"NM","B","PRCHITEM    FILE #441",1)

"BLD",2886,"KRN",.402,"NM","B","PRCHITEM2    FILE #441",2)

"BLD",2886,"KRN",.403,0)
.403
"BLD",2886,"KRN",.5,0)
.5
"BLD",2886,"KRN",.84,0)
.84
"BLD",2886,"KRN",3.6,0)
3.6
"BLD",2886,"KRN",3.8,0)
3.8
"BLD",2886,"KRN",9.2,0)
9.2
"BLD",2886,"KRN",9.8,0)
9.8
"BLD",2886,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",2886,"KRN",9.8,"NM",1,0)
PRCHE^^0^B48972338
"BLD",2886,"KRN",9.8,"NM",2,0)
PRCHITM^^0^B50914708
"BLD",2886,"KRN",9.8,"NM",3,0)
PRCOE2^^0^B29096792
"BLD",2886,"KRN",9.8,"NM",4,0)
PRCHQ4^^0^B41778600
"BLD",2886,"KRN",9.8,"NM",5,0)
PRCPHLFM^^0^B37336873
"BLD",2886,"KRN",9.8,"NM",6,0)
PRCHITM2^^0^B8168070
"BLD",2886,"KRN",9.8,"NM","B","PRCHE",1)

"BLD",2886,"KRN",9.8,"NM","B","PRCHITM",2)

"BLD",2886,"KRN",9.8,"NM","B","PRCHITM2",6)

"BLD",2886,"KRN",9.8,"NM","B","PRCHQ4",4)

"BLD",2886,"KRN",9.8,"NM","B","PRCOE2",3)

"BLD",2886,"KRN",9.8,"NM","B","PRCPHLFM",5)

"BLD",2886,"KRN",19,0)
19
"BLD",2886,"KRN",19,"NM",0)
^9.68A^3^3
"BLD",2886,"KRN",19,"NM",1,0)
PRCHITEM_UPDATE^^0
"BLD",2886,"KRN",19,"NM",2,0)
PRCH NIF UPDATE REPORT^^0
"BLD",2886,"KRN",19,"NM",3,0)
PRCH DISPLAY^^2
"BLD",2886,"KRN",19,"NM","B","PRCH DISPLAY",3)

"BLD",2886,"KRN",19,"NM","B","PRCH NIF UPDATE REPORT",2)

"BLD",2886,"KRN",19,"NM","B","PRCHITEM_UPDATE",1)

"BLD",2886,"KRN",19.1,0)
19.1
"BLD",2886,"KRN",19.1,"NM",0)
^9.68A^1^1
"BLD",2886,"KRN",19.1,"NM",1,0)
PRCHITEM MASTER^^0
"BLD",2886,"KRN",19.1,"NM","B","PRCHITEM MASTER",1)

"BLD",2886,"KRN",101,0)
101
"BLD",2886,"KRN",101,"NM",0)
^9.68A^^
"BLD",2886,"KRN",409.61,0)
409.61
"BLD",2886,"KRN",771,0)
771
"BLD",2886,"KRN",870,0)
870
"BLD",2886,"KRN",8994,0)
8994
"BLD",2886,"KRN","B",.4,.4)

"BLD",2886,"KRN","B",.401,.401)

"BLD",2886,"KRN","B",.402,.402)

"BLD",2886,"KRN","B",.403,.403)

"BLD",2886,"KRN","B",.5,.5)

"BLD",2886,"KRN","B",.84,.84)

"BLD",2886,"KRN","B",3.6,3.6)

"BLD",2886,"KRN","B",3.8,3.8)

"BLD",2886,"KRN","B",9.2,9.2)

"BLD",2886,"KRN","B",9.8,9.8)

"BLD",2886,"KRN","B",19,19)

"BLD",2886,"KRN","B",19.1,19.1)

"BLD",2886,"KRN","B",101,101)

"BLD",2886,"KRN","B",409.61,409.61)

"BLD",2886,"KRN","B",771,771)

"BLD",2886,"KRN","B",870,870)

"BLD",2886,"KRN","B",8994,8994)

"BLD",2886,"PRE")
PRC5163P
"BLD",2886,"QUES",0)
^9.62^^
"BLD",2886,"REQB",0)
^9.611^^
"FIA",441)
ITEM MASTER
"FIA",441,0)
^PRC(441,
"FIA",441,0,0)
441Is
"FIA",441,0,1)
y^n^p^^^^n
"FIA",441,0,10)

"FIA",441,0,11)

"FIA",441,0,"RLRO")

"FIA",441,0,"VR")
5.1^PRC
"FIA",441,441)
1
"FIA",441,441,50)

"FIA",441,441,51)

"FIA",441,441,52)

"FIA",441,441.06)
0
"INIT")
EN^PRC5163P
"KRN",.402,2696,-1)
0^2
"KRN",.402,2696,0)
PRCHITEM2^3021223.1603^@^441^^@^3050809
"KRN",.402,2696,"DR",1,441)
.05;.1;I '$O(^PRC(441,DA,1,0)) W *7,!,"Long Description is REQUIRED to be entered" S Y=.1;.08;2;5;5.5;3;19;S PRCHFSC=$P(^PRC(441,DA,0),U,3) S:$P(PRCHFSC/100,".")'=89 Y=21;20;21;S:$P(^PRC(441,DA,0),U,3)'=6505 Y=6;22;6;10;
"KRN",.402,2696,"DR",1,441,1)
I $D(PRC("PARAM")),$P(PRC("PARAM"),U,16)=""!($P(PRC("PARAM"),U,16)="N") S Y="";12;
"KRN",.402,2696,"DR",1,441,2)
I X="",$D(PRC("PARAM")),$P(PRC("PARAM"),U,16)="Y" W *7,!!,"  A&MM has been designated to enter BOC on items--this should be done",!,"before ordering this item!";
"KRN",.402,2696,"DR",2,441.01)
S DIE("NO^")="";.01;1.5;1;1.6;10;K DIE("NO^");2;3;8;8.5;9;S:$P(^PRC(441,DA(1),0),U,3)'=6505 Y="";4;
"KRN",.402,2696,"DR",2,441.05)
.01;
"KRN",.402,2844,-1)
0^1
"KRN",.402,2844,0)
PRCHITEM^3050801.1507^@^441^^@^3050809
"KRN",.402,2844,"DR",1,441)
W !!,"Short Description (uneditable)";D EN^DDIOL($P($G(^PRC(441,DA,0)),U,2),"","!?5");W !,"Description (uneditable)";D EN^DDIOL("","^PRC(441,DA,1)");.08;2;5;5.5;3;19;S PRCHFSC=$P(^PRC(441,DA,0),U,3) S:$P(PRCHFSC/100,".")'=89 Y=21;
"KRN",.402,2844,"DR",1,441,1)
20;21;S:$P(^PRC(441,DA,0),U,3)'=6505 Y=6;22;6;10;I $D(PRC("PARAM")),$P(PRC("PARAM"),U,16)=""!($P(PRC("PARAM"),U,16)="N") S Y="";12;
"KRN",.402,2844,"DR",1,441,2)
I X="",$D(PRC("PARAM")),$P(PRC("PARAM"),U,16)="Y" W *7,!!,"  A&MM has been designated to enter BOC on items--this should be done",!,"before ordering this item!";
"KRN",.402,2844,"DR",2,441.01)
S DIE("NO^")="";.01;1.5;1;1.6;10;K DIE("NO^");2;3;8;8.5;9;S:$P(^PRC(441,DA(1),0),U,3)'=6505 Y="";4;
"KRN",.402,2844,"DR",2,441.05)
.01;
"KRN",19,10399,-1)
2^3
"KRN",19,10399,0)
PRCH DISPLAY^Display/Print Menu^^M^68^^^^^^^
"KRN",19,10399,10,0)
^19.01IP^6^6
"KRN",19,10399,10,6,0)
11891^^5
"KRN",19,10399,10,6,"^")
PRCH NIF UPDATE REPORT
"KRN",19,10399,"U")
DISPLAY/PRINT MENU
"KRN",19,10905,-1)
0^1
"KRN",19,10905,0)
PRCHITEM_UPDATE^Server Option to update ITEM MASTER file (#441)^^S^^^^^^^^IFCAP
"KRN",19,10905,1,0)
^19.06^1^1^3030110^^^
"KRN",19,10905,1,1,0)
This server-type option is the recipient of mail messages to update the ITEM MASTER File (#441) entries with values from the National Item File database.
"KRN",19,10905,25)
EN^PRCHITM
"KRN",19,10905,220)
^Q^ISM^^Y^E^^152
"KRN",19,10905,"U")
SERVER OPTION TO UPDATE ITEM M
"KRN",19,11891,-1)
0^2
"KRN",19,11891,0)
PRCH NIF UPDATE REPORT^Item Descriptions After NIF Update^^R^^^^^^^^IFCAP
"KRN",19,11891,1,0)
^19.06^5^5^3040908^^
"KRN",19,11891,1,1,0)
This option displays the pre-NIF and current values of the Short
"KRN",19,11891,1,2,0)
Description (#.05) and the Description (#.1) fields, along with
"KRN",19,11891,1,3,0)
the most recent Short Description edit date and the Inactive Flag.
"KRN",19,11891,1,4,0)
The user has a choice of up to 5 sort keys to specify the sort orders
"KRN",19,11891,1,5,0)
at run time.
"KRN",19,11891,25)
PRT^PRCHITM2
"KRN",19,11891,"U")
ITEM DESCRIPTIONS AFTER NIF UP
"KRN",19.1,398,-1)
0^1
"KRN",19.1,398,0)
PRCHITEM MASTER
"KRN",19.1,398,1,0)
^19.11^1^1^3050117^^^
"KRN",19.1,398,1,1,0)
This security key enables a "super user" to edit otherwise restricted fields.
"MBREQ")
0
"ORD",3,19.1)
19.1;3;1;;KEY^XPDTA1;;;KEYF2^XPDIA1;;KEYDEL^XPDIA1
"ORD",3,19.1,0)
SECURITY KEY
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",455,-1)
1^1
"PKG",455,0)
IFCAP^PRC^IFCAP System Files
"PKG",455,20,0)
^9.402P^^
"PKG",455,22,0)
^9.49I^1^1
"PKG",455,22,1,0)
5.1^3001012^3001019^68
"PKG",455,22,1,"PAH",1,0)
63^3050810
"PKG",455,22,1,"PAH",1,1,0)
^^11^11^3050810
"PKG",455,22,1,"PAH",1,1,1,0)
This patch installs software in support of the National Item File - Phase 
"PKG",455,22,1,"PAH",1,1,2,0)
1 initiative, as defined by IT Service Request #20020708.
"PKG",455,22,1,"PAH",1,1,3,0)
 
"PKG",455,22,1,"PAH",1,1,4,0)
IFCAP has been enhanced to receive via an X12 Item Maintenance 888 
"PKG",455,22,1,"PAH",1,1,5,0)
transaction, the National Item File (NIF)'s item number, short description
"PKG",455,22,1,"PAH",1,1,6,0)
and extended description and store them in the corresponding entry of the
"PKG",455,22,1,"PAH",1,1,7,0)
local IFCAP system's ITEM MASTER file (#441). The NIF item number now is 
"PKG",455,22,1,"PAH",1,1,8,0)
a write identifier for this file.  One can now also select entries using 
"PKG",455,22,1,"PAH",1,1,9,0)
the NIF item number.  In addition, the NIF item number is now sent in the 
"PKG",455,22,1,"PAH",1,1,10,0)
'IT' segment of the PHA transaction for inclusion in OA&MM's Procurement 
"PKG",455,22,1,"PAH",1,1,11,0)
History database at the Austin Automation Center (AAC).
"PRE")
PRC5163P
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","PRC5163P")
0^^B14009598
"RTN","PRC5163P",1,0)
PRC5163P ;WOIFO/LKG-Environmental Check & PostInstall routine ;8/3/05  08:06
"RTN","PRC5163P",2,0)
V ;;5.1;IFCAP;**63**;Oct 20, 2000
"RTN","PRC5163P",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRC5163P",4,0)
CHECK ;Check for resource device PRCHITEM
"RTN","PRC5163P",5,0)
 I $$GET1^DIQ(4,$$KSP^XUPARAM("INST")_",",99)=516,'$$PATCH^XPDUTL("PRC*5.1*902") D BMES^XPDUTL("The Bay Pines VAMC should install PRC*5.1*902 first.") S XPDQUIT=1 Q
"RTN","PRC5163P",6,0)
 N PRCX,PRCERR
"RTN","PRC5163P",7,0)
 D FIND^DIC(3.5,"","@;.01;1;2;35","X","PRCHITEM","","B","","","PRCX","PRCERR")
"RTN","PRC5163P",8,0)
 I $P($G(PRCX("DILIST",0)),U)'>0 D  S XPDQUIT=2 Q
"RTN","PRC5163P",9,0)
 . N PRCT S PRCT(1)="Resource device PRCHITEM was not found."
"RTN","PRC5163P",10,0)
 . S PRCT(2)="Please refer to patch documentation and add it to the DEVICE file"
"RTN","PRC5163P",11,0)
 . S PRCT(3)="  before proceeding."
"RTN","PRC5163P",12,0)
 . D MES^XPDUTL(.PRCT)
"RTN","PRC5163P",13,0)
 I $P($G(PRCX("DILIST",0)),U)>1 D  S XPDQUIT=2 Q
"RTN","PRC5163P",14,0)
 . N PRCT S PRCT(1)="PRCHITEM device is not unique which will cause problems."
"RTN","PRC5163P",15,0)
 . S PRCT(2)="  Please refer to patch documentation and correct before proceeding."
"RTN","PRC5163P",16,0)
 . D MES^XPDUTL(.PRCT)
"RTN","PRC5163P",17,0)
 I $G(PRCX("DILIST","ID",1,1))'="PRCHITEM" D  S XPDQUIT=2 Q
"RTN","PRC5163P",18,0)
 . N PRCT S PRCT(1)="$I value "_$G(PRCX("DILIST","ID",1,1))_" is invalid for resource device PRCHITEM."
"RTN","PRC5163P",19,0)
 . S PRCT(2)="  Please refer to patch documentation and correct before proceeding."
"RTN","PRC5163P",20,0)
 . D MES^XPDUTL(.PRCT)
"RTN","PRC5163P",21,0)
 I $G(PRCX("DILIST","ID",1,2))'="RESOURCES" D  S XPDQUIT=2 Q
"RTN","PRC5163P",22,0)
 . N PRCT S PRCT(1)="Device type "_$G(PRCX("DILIST","ID",1,2))_" is invalid for resource device PRCHITEM."
"RTN","PRC5163P",23,0)
 . S PRCT(2)="  Please refer to patch documentation and correct before proceeding."
"RTN","PRC5163P",24,0)
 . D MES^XPDUTL(.PRCT)
"RTN","PRC5163P",25,0)
 I $G(PRCX("DILIST","ID",1,35))'=1 D  S XPDQUIT=2 Q
"RTN","PRC5163P",26,0)
 . N PRCT S PRCT(1)="Resource Slots value "_$S($G(PRCX("DILIST","ID",1,35))="":"NULL",1:$G(PRCX("DILIST","ID",1,35)))_" is invalid for resource device PRCHITEM."
"RTN","PRC5163P",27,0)
 . S PRCT(2)="  Please refer to patch documentation and correct before proceeding."
"RTN","PRC5163P",28,0)
 . S PRCT(3)="  The appropriate value is 1."
"RTN","PRC5163P",29,0)
 . D MES^XPDUTL(.PRCT)
"RTN","PRC5163P",30,0)
 Q
"RTN","PRC5163P",31,0)
EN ;Entry point  DBIA #3875 for setting ID node
"RTN","PRC5163P",32,0)
 ;Adding NIF Item # as write identifier for ITEM MASTER file (#441)
"RTN","PRC5163P",33,0)
 S ^DD(441,0,"ID","Z")="W:$P($G(^(0)),U,15)>0 ""   NIF#""_$P($G(^(0)),U,15)"
"RTN","PRC5163P",34,0)
 ;Linking resource device to server option   DBIA #3878 
"RTN","PRC5163P",35,0)
 N PRCERR,PRCD,PRCDA,PRCDA2
"RTN","PRC5163P",36,0)
 K PRCERR
"RTN","PRC5163P",37,0)
 S PRCDA=$$FIND1^DIC(3.5,"","X","PRCHITEM","B","I $P(^(""TYPE""),U)=""RES""","PRCERR")
"RTN","PRC5163P",38,0)
 I PRCDA'>0!$D(PRCERR) D  G EX
"RTN","PRC5163P",39,0)
 . N PRCT S PRCT(1)="Lookup of resource device PRCHITEM failed."
"RTN","PRC5163P",40,0)
 . S PRCT(2)="  You will have to manually link resource device PRCHITEM to server"
"RTN","PRC5163P",41,0)
 . S PRCT(3)="  option PRCHITEM_UPDATE."
"RTN","PRC5163P",42,0)
 . D MES^XPDUTL(.PRCT)
"RTN","PRC5163P",43,0)
 K PRCERR
"RTN","PRC5163P",44,0)
 S PRCDA2=$$FIND1^DIC(19,"","X","PRCHITEM_UPDATE","B","","PRCERR")
"RTN","PRC5163P",45,0)
 I PRCDA2'>0!$D(PRCERR) D  G EX
"RTN","PRC5163P",46,0)
 . N PRCT S PRCT(1)="Lookup of server option PRCHITEM_UPDATE failed."
"RTN","PRC5163P",47,0)
 . S PRCT(2)="  Please contact NVS as there were patch installation problems."
"RTN","PRC5163P",48,0)
 . D MES^XPDUTL(.PRCT)
"RTN","PRC5163P",49,0)
 K PRCD,PRCERR
"RTN","PRC5163P",50,0)
 S PRCD(19,PRCDA2_",",227)=PRCDA
"RTN","PRC5163P",51,0)
 D FILE^DIE("K","PRCD","PRCERR")
"RTN","PRC5163P",52,0)
 I $D(PRCERR) D  G EX
"RTN","PRC5163P",53,0)
 . N PRCT S PRCT(1)="Automated linkage of resource device PRCHITEM to server option"
"RTN","PRC5163P",54,0)
 . S PRCT(2)="  PRCHITEM_UPDATE failed.  You will have to manually link it."
"RTN","PRC5163P",55,0)
 . D MES^XPDUTL(.PRCT)
"RTN","PRC5163P",56,0)
 N PRCT S PRCT(1)="Resource device PRCHITEM was successfully linked to server"
"RTN","PRC5163P",57,0)
 S PRCT(2)="  option PRCHITEM_UPDATE."
"RTN","PRC5163P",58,0)
 D MES^XPDUTL(.PRCT)
"RTN","PRC5163P",59,0)
EX ;
"RTN","PRC5163P",60,0)
 Q
"RTN","PRCHE")
0^1^B48972338
"RTN","PRCHE",1,0)
PRCHE ;WOIFO/LKG/DST-EDIT ROUTINES FOR SUPPLY SYSTEM ; 6/22/05 8:40am
"RTN","PRCHE",2,0)
V ;;5.1;IFCAP;**1,28,39,81,63**;Oct 20, 2000
"RTN","PRCHE",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCHE",4,0)
EN1 ;ITEM FILE EDIT
"RTN","PRCHE",5,0)
 N PRCVDA
"RTN","PRCHE",6,0)
 I '$D(PRC("PARAM")) S PRCF("X")="S" D ^PRCFSITE Q:'$D(PRC("PARAM"))
"RTN","PRCHE",7,0)
 W !! D DISP^PRCOSS1
"RTN","PRCHE",8,0)
 S DIC="^PRC(441,",DIC(0)="AEMQL",DLAYGO=441,PRCHPO="",PRCHDA=-1 D ^DIC
"RTN","PRCHE",9,0)
 I Y>0 D
"RTN","PRCHE",10,0)
 . S PRCHDA=+Y,DIE=DIC,DA=+Y
"RTN","PRCHE",11,0)
 . S DR=$S($P($G(^PRC(441,DA,0)),U,15)="":"[PRCHITEM2]",$D(^XUSEC("PRCHITEM MASTER",DUZ)):"[PRCHITEM2]",1:"[PRCHITEM]")
"RTN","PRCHE",12,0)
 . I DR="[PRCHITEM]" D
"RTN","PRCHE",13,0)
 . . N PRCARR S PRCARR(1)="This item is a National Item File entry and you have"
"RTN","PRCHE",14,0)
 . . S PRCARR(2)="not been granted permission to edit the SHORT DESCRIPTION"
"RTN","PRCHE",15,0)
 . . S PRCARR(3)="and DESCRIPTION fields.  You will not be able to edit these fields."
"RTN","PRCHE",16,0)
 . . D EN^DDIOL(.PRCARR)
"RTN","PRCHE",17,0)
 . D LCK D:$D(DA) ^DIE
"RTN","PRCHE",18,0)
 . ; Send ITEM master file updates info to DynaMed - **81**
"RTN","PRCHE",19,0)
 . S PRCVDA=$G(DA)
"RTN","PRCHE",20,0)
 S Y=PRCHDA K PRCHDA D Q K PRCHPO
"RTN","PRCHE",21,0)
 I Y<0 D CHECK^PRCOSS1 Q
"RTN","PRCHE",22,0)
 S (PRCHDA,DA,DA(1))=+Y I $O(^PRC(441,DA,4,0)) S DIC="^PRC(441,"_DA(1)_",4,",DIC(0)="QEMAN" D ^DIC S:$G(Y)'=-1 PRCVDA=PRCHDA I Y>0 S DA=+Y,DIE=DIC,DR=3 D ^DIE,Q
"RTN","PRCHE",23,0)
 ; S:$G(Y)'=-1 PRCVDA=PRCHDA
"RTN","PRCHE",24,0)
 ; If either ITEM record (and FCP fields) created or updated, and
"RTN","PRCHE",25,0)
 ; this site is a DynaMed Interface site
"RTN","PRCHE",26,0)
 I $G(PRCVDA),$$GET^XPAR("SYS","PRCV COTS INVENTORY",1,"Q")=1 D ONECHK^PRCVIT(PRCVDA)
"RTN","PRCHE",27,0)
 I $P(^PRC(441,PRCHDA,0),U,10)="",$P(PRC("PARAM"),U,16)="Y" W $C(7),!!,"Warning--BOC is missing from this item--you should",!,"re-edit the item!!",!
"RTN","PRCHE",28,0)
 I $O(^PRCP(445,"AH",PRCHDA,""))]"" D BLDSEG^PRCPHLFM(3,PRCHDA,0) ; update supply stations
"RTN","PRCHE",29,0)
 K PRCHDA G EN1
"RTN","PRCHE",30,0)
 ;
"RTN","PRCHE",31,0)
EN2 ;EDIT SITE PARAMETERS
"RTN","PRCHE",32,0)
 N X R !,"STATION NUMBER: ",X:DTIME Q:'$T!(X["^")!(X="")
"RTN","PRCHE",33,0)
 I "???"[X D EN2DSP G EN2
"RTN","PRCHE",34,0)
 I X'?3N W !,"Please enter a 3 digit number or '^' to exit.  If attempting to enter substation information, please use 'Substation Enter/Edit'." G EN2
"RTN","PRCHE",35,0)
 I $D(^PRC(411,"B",X)) G EN2A
"RTN","PRCHE",36,0)
 N PRCX
"RTN","PRCHE",37,0)
 S PRCX=$O(^DIC(4,"D",X,"")) I PRCX="" W " ?? (That is not a valid Station Number)" G EN2
"RTN","PRCHE",38,0)
 S PRCX=$P($G(^DIC(4,PRCX,0)),U,1)
"RTN","PRCHE",39,0)
 D EN^DDIOL("Do you wish to add "_X_" ("_PRCX_") as a NEW station")
"RTN","PRCHE",40,0)
 S %=0 D YN^DICN I %'=1 G EN2
"RTN","PRCHE",41,0)
 ;
"RTN","PRCHE",42,0)
EN2A S DIC="^PRC(411,",DIC(0)="LX",DR="[PRCHSITE]",DLAYGO=411 D DIE
"RTN","PRCHE",43,0)
 G EN2
"RTN","PRCHE",44,0)
EN2DSP ;Display entries from file #411 if they are Ok in file #4. Otherwise,
"RTN","PRCHE",45,0)
 ;alert user about any incomplete entry.
"RTN","PRCHE",46,0)
 N PRCDA,PRCA,J,PRCIEN,PRCINSN
"RTN","PRCHE",47,0)
 S PRCDA=0 F J=2:0 S PRCDA=$O(^PRC(411,"B",PRCDA)) Q:PRCDA=""  D
"RTN","PRCHE",48,0)
 . S PRCIEN=$O(^PRC(411,"B",PRCDA,"")) I $D(^PRC(411,PRCIEN,0))#10 D 
"RTN","PRCHE",49,0)
 .. S PRCA=$P($G(^PRC(411,PRCIEN,0)),U,1) I PRCA?3N D
"RTN","PRCHE",50,0)
 ... S PRCA(J)=$J("",5)_PRCA_"  "
"RTN","PRCHE",51,0)
 ... S PRCINSN=$O(^DIC(4,"D",PRCDA,"")) I PRCINSN']"" D  Q
"RTN","PRCHE",52,0)
 .... W !,$C(7),?5,"ENTRY "_PRCDA_" IS NOT SET UP PROPERLY IN FILE #4. PLEASE CALL IRM"
"RTN","PRCHE",53,0)
 ... S PRCA(J)=PRCA(J)_$P($G(^DIC(4,PRCINSN,0)),U,1),J=J+1
"RTN","PRCHE",54,0)
 I J>2 S PRCA(1)=" ",PRCA(J)=" " D EN^DDIOL(.PRCA)
"RTN","PRCHE",55,0)
 Q
"RTN","PRCHE",56,0)
EN3 ;EDIT VENDOR FILE
"RTN","PRCHE",57,0)
 S DIC="^PRC(440,",DIC(0)="AEMQL",DR="[PRCHVENDOR1]",DLAYGO=440 K PRCHPO D DIE Q:Y<0  G EN3
"RTN","PRCHE",58,0)
 ;
"RTN","PRCHE",59,0)
EN5 ;ENTER A NEW P.O.
"RTN","PRCHE",60,0)
 D ST Q:'$D(PRC("SITE"))
"RTN","PRCHE",61,0)
EN50 D ENPO^PRCHUTL Q:'$D(PRCHPO)  D LCK1 G:'$D(DA) EN50 D ^PRCHNPO L  G EN50
"RTN","PRCHE",62,0)
 ;
"RTN","PRCHE",63,0)
EN6 ;EDIT AN INCOMPLETE P.O.
"RTN","PRCHE",64,0)
 ;Edit an Incomplete Purchase Order created by 'New Purchase Order' option only
"RTN","PRCHE",65,0)
 D ST Q:'$D(PRC("SITE"))
"RTN","PRCHE",66,0)
EN60 N FLG1 S FLG1=1 D PO Q:'$D(PRCHPO)
"RTN","PRCHE",67,0)
 D LCK1 G:'$D(DA) EN60 D ^PRCHNPO L  G EN60
"RTN","PRCHE",68,0)
 ;
"RTN","PRCHE",69,0)
EN8 ;DELETE A RECEIVING REPORT
"RTN","PRCHE",70,0)
 N FLG1 S FLG1=0 D ST Q:'$D(PRC("SITE"))  G EN80^PRCHEF
"RTN","PRCHE",71,0)
 ;
"RTN","PRCHE",72,0)
EN9 ;EDIT COMMON NUMBERING SERIES
"RTN","PRCHE",73,0)
 W ! S DIC="^PRC(442.6,",DIC(0)="AEMQL",DR=".01:99",DLAYGO=442.6 D DIE Q:Y<0  I $D(^PRC(442.6,+Y)),$P(^(+Y,0),U,5)="" W !!,$C(7),"NOTE: Since you have left the USING SECTION field empty, these",!,"numbers can only be used by P&C.",!
"RTN","PRCHE",74,0)
 G EN9
"RTN","PRCHE",75,0)
 ;
"RTN","PRCHE",76,0)
EN10 ;EDIT SUPPLY EMPLOYEE INFORMATION
"RTN","PRCHE",77,0)
 K DIC,DA,X,Y S DIC="^VA(200,",DIC(0)="AEMQ" D ^DIC
"RTN","PRCHE",78,0)
 G:Y<0 EN10Q
"RTN","PRCHE",79,0)
 S DA=+Y L +^VA(200,DA):0 E  W $C(7),!,"ANOTHER USER IS EDITING THIS ENTRY!" G EN10
"RTN","PRCHE",80,0)
 K DR,DIE S DR="400;.135;.136;.151",DIE=DIC D ^DIE K DIE,DR
"RTN","PRCHE",81,0)
 L -^VA(200,DA)
"RTN","PRCHE",82,0)
 W !?5,"To edit the Signature Block Printed Name or title, Use TBOX",!
"RTN","PRCHE",83,0)
 G:'$D(DTOUT) EN10
"RTN","PRCHE",84,0)
EN10Q K DIC,DIE,X,Y,DA,DR,DTOUT,DUOUT
"RTN","PRCHE",85,0)
 Q
"RTN","PRCHE",86,0)
 ;
"RTN","PRCHE",87,0)
EN11 ;EDIT ADMINISTRATIVE CERTIFICATIONS
"RTN","PRCHE",88,0)
 S DIC="^PRC(442.7,",DIC(0)="AEMLQ",DR=".01:99",DLAYGO=442.7 D DIE Q:Y<0  G EN11
"RTN","PRCHE",89,0)
 ;
"RTN","PRCHE",90,0)
EN12 ;EDIT DELIVERY DATE
"RTN","PRCHE",91,0)
 N PRCHP D ST Q:'$D(PRC("SITE"))
"RTN","PRCHE",92,0)
 ;S PRCHP("S")="$P($G(^(7)),U,2)>19,$P($G(^(7)),U,2)<30,($P($G(^(0)),U,2)=25!($S($D(PRCHNRQ):$P($G(^(0)),U,2)=8,1:$P($G(^(0)),U,2)<8)))"
"RTN","PRCHE",93,0)
EN120 D PORQ I '$D(PRCHPO) G Q
"RTN","PRCHE",94,0)
 ;I X<20!(X>29) W " ??",$C(7) G EN120
"RTN","PRCHE",95,0)
 I "^20^21^22^23^24^25^26^27^28^29^32^34^39^44^46^47^"'[(U_X_U) W " ??",$C(7) G EN120
"RTN","PRCHE",96,0)
 D LCK1 G:'$D(DA) EN120
"RTN","PRCHE",97,0)
 S D0=DA,%=2,%B="",%A="REVIEW ORDER " D ^PRCFYN D:%=1 ^PRCHDP1
"RTN","PRCHE",98,0)
 W ! S PRCHDT=$P(^PRC(442,PRCHPO,0),U,10) S DA=PRCHPO,DIE="^PRC(442,",DR="[PRCHDEL]" D ^DIE S X=$P(^PRC(442,PRCHPO,0),U,10) I X,X'=PRCHDT,$P(^(0),U,20)="" S $P(^(0),U,20)=PRCHDT
"RTN","PRCHE",99,0)
 ; trigger bulletin for changed delivery date
"RTN","PRCHE",100,0)
 S PRCHDTT=$P(^PRC(442,PRCHPO,0),U,10) I PRCHDTT'=PRCHDT D ^PRCFACS2
"RTN","PRCHE",101,0)
 K PRCHDT D Q G EN120
"RTN","PRCHE",102,0)
 ;
"RTN","PRCHE",103,0)
EN13 ; Delete 2237 option has been de-activated.
"RTN","PRCHE",104,0)
 ; See documentation for PRC*5*128.
"RTN","PRCHE",105,0)
 Q
"RTN","PRCHE",106,0)
EN14 ;CREATE ADJUSTMENT VOUCHER
"RTN","PRCHE",107,0)
 D ST Q:'$D(PRC("SITE"))
"RTN","PRCHE",108,0)
EN140 D PORQ Q:'$D(PRCHPO)
"RTN","PRCHE",109,0)
 I X=28!(X=33) W $C(7),!,"Adjustment Vouchers not allowed until after order has been Obligated!!" G EN140
"RTN","PRCHE",110,0)
 I '$O(^PRC(442,PRCHPO,11,0)) W !?3,"Order has no Receiving Reports !",$C(7) G EN140
"RTN","PRCHE",111,0)
 D ^PRCHAM4 G EN140
"RTN","PRCHE",112,0)
 ;
"RTN","PRCHE",113,0)
EN15 ;ENTER LOG DEPARTMENTS TO FCP FILE (420)
"RTN","PRCHE",114,0)
 D ST Q:'$D(PRC("SITE"))
"RTN","PRCHE",115,0)
EN150 S DIC="^PRC(420,"_PRC("SITE")_",1,",DIC(0)="AEMNQ"
"RTN","PRCHE",116,0)
 S DIC("A")="Select CONTROL POINT: ",D="B^C" D MIX^DIC1 G:Y<0 Q
"RTN","PRCHE",117,0)
 S DIE=DIC,DA(1)=PRC("SITE"),DA=+Y,DR=19 D ^DIE
"RTN","PRCHE",118,0)
 D:$P(^PRC(420,DA(1),1,DA,0),U,18)?1"11".E
"RTN","PRCHE",119,0)
 .  W !,">>> You have just assigned a LOG DEPARTMENT that should only be used for        Subsistence FCPs.  If that is NOT true, please reassign it or you will be       asked for a Food Group on every item purchased."
"RTN","PRCHE",120,0)
 G EN150
"RTN","PRCHE",121,0)
 ;
"RTN","PRCHE",122,0)
DIE S PRCHDA=-1 D ^DIC
"RTN","PRCHE",123,0)
 I Y>0 S PRCHDA=+Y,DIE=DIC,DA=+Y D LCK I $D(DA) D ^DIE
"RTN","PRCHE",124,0)
 S Y=PRCHDA K PRCHDA G Q
"RTN","PRCHE",125,0)
 ;
"RTN","PRCHE",126,0)
QQ S:'$D(ROUTINE) ROUTINE=$T(+0) W !!,$$ERR^PRCHQQ(ROUTINE,PRCSIG) W:PRCSIG=0!(PRCSIG=-3) !,"Notify Application Coordinator!",$C(7) S DIR(0)="EAO",DIR("A")="Press <return> to continue" D ^DIR
"RTN","PRCHE",127,0)
 ;
"RTN","PRCHE",128,0)
Q K DA,DIC,DIE,DIK,DR,DLAYGO,D0,E,I,J,L,PRCHEX,PRCHPUSH,%,ROUTINE,CHECK L
"RTN","PRCHE",129,0)
 Q
"RTN","PRCHE",130,0)
 ;
"RTN","PRCHE",131,0)
LCK1 S DIC="^PRC(442,"
"RTN","PRCHE",132,0)
 ;
"RTN","PRCHE",133,0)
LCK L @(DIC_DA_"):0") E  W !,$C(7),"ANOTHER USER IS EDITING THIS ENTRY!" K DA
"RTN","PRCHE",134,0)
 Q
"RTN","PRCHE",135,0)
 ;
"RTN","PRCHE",136,0)
ST S PRCF("X")="S" D ^PRCFSITE
"RTN","PRCHE",137,0)
 Q
"RTN","PRCHE",138,0)
 ;
"RTN","PRCHE",139,0)
PO S PRCHP("A")="P.O./REQ.NO.: "
"RTN","PRCHE",140,0)
 S PRCHP("S")=$S(FLG1:"$P($G(^(7)),U,2)<10,($P(^(0),U,2)<10!($P(^(0),U,2)=25&($P($G(^(23)),U,11)=""""))!($P(^(0),U,2)=26))",1:"$P(^(0),U,2)<10!($P(^(0),U,2)=25)!($P(^(0),U,2)=26)")
"RTN","PRCHE",141,0)
 S:$G(PRCHPC)=1 PRCHP("S")="$P($G(^(7)),U,2)<9,$P($G(^(1)),U,10)=DUZ,$P($G(^(0)),U,2)=25,$P($G(^(23)),U,11)=""S"""
"RTN","PRCHE",142,0)
 S:$G(PRCHPC)=2 PRCHP("S")="$P($G(^(7)),U,2)<9,$P($G(^(1)),U,10)=DUZ,$P($G(^(0)),U,2)=25,$P($G(^(23)),U,11)=""P"""
"RTN","PRCHE",143,0)
 S:$G(PRCHDELV) PRCHP("S")="$P($G(^(7)),U,2)<9,$P($G(^(23)),U,11)=""D"",$P(^(0),U,2)'=26"
"RTN","PRCHE",144,0)
 S:$G(PRCHPC)=3 PRCHP("S")="$P($G(^(7)),U,2)<9,$P($G(^(1)),U,10)=DUZ,$P($G(^(0)),U,2)=25,$P($G(^(23)),U,11)=""P"""
"RTN","PRCHE",145,0)
 S:$G(PRCHPHAM) PRCHP("S")="$P($G(^(7)),U,2)<9,$P($G(^(23)),U,11)=""D"",$P(^(0),U,2)=26"
"RTN","PRCHE",146,0)
 D EN3^PRCHPAT
"RTN","PRCHE",147,0)
 Q
"RTN","PRCHE",148,0)
 ;
"RTN","PRCHE",149,0)
PORQ S:$D(PRCHNRQ) PRCHP("A")="REQUISITION NO.: "
"RTN","PRCHE",150,0)
 I $G(PRCHAUTH)=1 S PRCHP("S")="$P($G(^(23)),U,11)=""P"""
"RTN","PRCHE",151,0)
 I $G(PRCHAUTH)=2 S PRCHP("S")="$P($G(^(23)),U,11)=""D"""
"RTN","PRCHE",152,0)
 D EN3^PRCHPAT
"RTN","PRCHE",153,0)
 Q
"RTN","PRCHITM")
0^2^B50914708
"RTN","PRCHITM",1,0)
PRCHITM ;WOIFO/LKG-ITEM UPDATE FROM NIF ;11/15/04  13:02
"RTN","PRCHITM",2,0)
V ;;5.1;IFCAP;**63**;Oct 20, 2000
"RTN","PRCHITM",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCHITM",4,0)
 Q
"RTN","PRCHITM",5,0)
EN ;Entry for server invoked filer
"RTN","PRCHITM",6,0)
 S PRCERRC=0
"RTN","PRCHITM",7,0)
 ; loading ^XTMP with 888 transaction from MailMan message
"RTN","PRCHITM",8,0)
 F  X XMREC Q:XMER<0!($E(XMRG,1,4)="ISA^")
"RTN","PRCHITM",9,0)
 I XMER<0 G EXIT
"RTN","PRCHITM",10,0)
 S PRCTXN=$P(XMRG,U,14)
"RTN","PRCHITM",11,0)
 S PRCHNODE="PRCHITM;"_PRCTXN K ^XTMP(PRCHNODE)
"RTN","PRCHITM",12,0)
 ; set up ^XTMP header node including automated purge date
"RTN","PRCHITM",13,0)
 S DT=$$DT^XLFDT,X1=DT,X2=10 D C^%DTC S ^XTMP(PRCHNODE,0)=X_"^"_DT_"^"_"NIF ITEM UPDATE"
"RTN","PRCHITM",14,0)
 S PRCSUB=1,^XTMP(PRCHNODE,1,PRCSUB)=XMRG
"RTN","PRCHITM",15,0)
 F  X XMREC Q:XMER<0!($E(XMRG,1,4)="IEA^")  D
"RTN","PRCHITM",16,0)
 . S PRCSUB=PRCSUB+1,^XTMP(PRCHNODE,1,PRCSUB)=XMRG
"RTN","PRCHITM",17,0)
 I XMER<0 D ERR("IEA segment is missing.") G EXIT
"RTN","PRCHITM",18,0)
 S PRCSUB=PRCSUB+1,^XTMP(PRCHNODE,1,PRCSUB)=XMRG
"RTN","PRCHITM",19,0)
 ; processing data
"RTN","PRCHITM",20,0)
RESTART ;Restart filer with data from ^XTMP global
"RTN","PRCHITM",21,0)
 S PRCX=$G(^XTMP(PRCHNODE,1,1)) I $P(PRCX,U)'="ISA" D ERR("ISA segment is missing.") G EXIT
"RTN","PRCHITM",22,0)
 S PRCY=$P(PRCX,U,7) I $TR(PRCY," ")'="36001200NIF" D ERR("Interchange Sender ID '"_PRCY_"' is invalid.") G EXIT
"RTN","PRCHITM",23,0)
 S PRCY=$P(PRCX,U,9) I $TR(PRCY," ")'="IFCAPNIF" D ERR("Interchange Receiver ID '"_PRCY_"' is invalid.") G EXIT
"RTN","PRCHITM",24,0)
 S PRCX=$G(^XTMP(PRCHNODE,1,2)) I $P(PRCX,U)'="ST" D ERR("ST segment is missing.") G EXIT
"RTN","PRCHITM",25,0)
 I $P(PRCX,U,2)'="888" D ERR("Transaction is not the 888.") G EXIT
"RTN","PRCHITM",26,0)
 S PRCX=$G(^XTMP(PRCHNODE,1,3)) I $P(PRCX,U)'="N1" D ERR("N1 segment is missing.") G EXIT
"RTN","PRCHITM",27,0)
 I $P(PRCX,U,3)'="NIF" D ERR("Source is not the National Item File database.") G EXIT
"RTN","PRCHITM",28,0)
 S Y=$$GET1^DIQ(4,$$KSP^XUPARAM("INST")_",",99) I $P(PRCX,U,5)'=Y D ERR("Intended recipient station is "_$P(PRCX,U,5)_", not "_Y_".") G EXIT
"RTN","PRCHITM",29,0)
 I $P(PRCX,U,7)'="KA" D ERR("Intended recipient application is not IFCAP's ITEM MASTER file.") G EXIT
"RTN","PRCHITM",30,0)
 S PRCSUB=6 I $P($G(^XTMP(PRCHNODE,1,PRCSUB)),U)'="G39" D ERR("Item characteristics node 'G39' is missing.") G EXIT
"RTN","PRCHITM",31,0)
PROCITM ;Process items
"RTN","PRCHITM",32,0)
 S PRCX=$G(^XTMP(PRCHNODE,1,PRCSUB))
"RTN","PRCHITM",33,0)
 I $P(PRCX,U,24)'="ZZ" D ERR("The G39 segment for NIF Item #"_$P(PRCX,U,25)_" is defective.") G EXIT
"RTN","PRCHITM",34,0)
 S PRCIEN=$P(PRCX,U,4),PRCNIF=$P(PRCX,U,25)
"RTN","PRCHITM",35,0)
 I PRCNIF?1.N D
"RTN","PRCHITM",36,0)
 . I PRCIEN?1.N D
"RTN","PRCHITM",37,0)
 . . ; updating IMF entry specified by IMF Number in G39 segment
"RTN","PRCHITM",38,0)
 . . I '$$FIND1^DIC(441,"","XQ","`"_PRCIEN,"","","PRCE") D ERR("Item Master Number "_PRCIEN_" does not exist.") Q
"RTN","PRCHITM",39,0)
 . . K PRCE I $$GET1^DIQ(441,PRCIEN_",",16,"I","","PRCE") D ERR("Item Master Number "_PRCIEN_" is inactive, so it will not be updated.") Q
"RTN","PRCHITM",40,0)
 . . S PRCLOCK=0 F PRCI=1:1:20 L +^PRC(441,PRCIEN):30 I $T S PRCLOCK=1 Q
"RTN","PRCHITM",41,0)
 . . I 'PRCLOCK D ERR("Filer was unable to lock Item Master Number "_PRCIEN_"/NIF Item #"_PRCNIF_".") Q
"RTN","PRCHITM",42,0)
 . . ; filing NIF Item #
"RTN","PRCHITM",43,0)
 . . K PRCRR,PRCE S PRCRR(441,PRCIEN_",",51)=PRCNIF D FILE^DIE("E","PRCRR","PRCE")
"RTN","PRCHITM",44,0)
 . . I $D(PRCE("DIERR")) S PRCY=0 F  S PRCY=$O(PRCE("DIERR",1,"TEXT",PRCY)) Q:PRCY'>0  D ERR("Item Master Number "_PRCIEN_": "_PRCE("DIERR",1,"TEXT",PRCY))
"RTN","PRCHITM",45,0)
 . . K PRCRR,PRCE
"RTN","PRCHITM",46,0)
 . . S PRCSUB=$O(^XTMP(PRCHNODE,1,PRCSUB))
"RTN","PRCHITM",47,0)
 . . I PRCSUB="" D ERR("No descriptions exist for NIF Item Number "_PRCNIF_".") L -^PRC(441,PRCIEN) Q
"RTN","PRCHITM",48,0)
 . . D DESC(PRCIEN,1) L -^PRC(441,PRCIEN)
"RTN","PRCHITM",49,0)
 . . I $O(^PRCP(445,"AH",PRCIEN,""))]"" D BLDSEG^PRCPHLFM(3,PRCIEN,0) ;update supply stations
"RTN","PRCHITM",50,0)
 . I PRCIEN'?1.N D
"RTN","PRCHITM",51,0)
 . . ; updating all IMF entries with specified NIF Item Number
"RTN","PRCHITM",52,0)
 . . K PRCE,PRCRR
"RTN","PRCHITM",53,0)
 . . D FIND^DIC(441,"","@","XQ",PRCNIF,"","I","","","PRCRR","PRCE")
"RTN","PRCHITM",54,0)
 . . I '$D(PRCRR("DILIST",2)) D ERR("No entry was found with NIF Item #"_PRCNIF_".") Q
"RTN","PRCHITM",55,0)
 . . S PRCSUB=$O(^XTMP(PRCHNODE,1,PRCSUB)),PRCZ=PRCSUB
"RTN","PRCHITM",56,0)
 . . I PRCSUB="" D ERR("No descriptions exist for NIF Item Number "_PRCNIF_".") Q
"RTN","PRCHITM",57,0)
 . . K PRCL M PRCL=PRCRR("DILIST",2) ; save list of iens
"RTN","PRCHITM",58,0)
 . . S PRCCTR=0 F  S PRCCTR=$O(PRCL(PRCCTR)) Q:PRCCTR=""  D
"RTN","PRCHITM",59,0)
 . . . S PRCIEN=PRCL(PRCCTR)
"RTN","PRCHITM",60,0)
 . . . K PRCE I $$GET1^DIQ(441,PRCIEN_",",16,"I","","PRCE") D ERR("Item Master Number "_PRCIEN_" is inactive, so it will not be updated.") Q
"RTN","PRCHITM",61,0)
 . . . S PRCLOCK=0 F PRCI=1:1:20 L +^PRC(441,PRCIEN):30 I $T S PRCLOCK=1 Q
"RTN","PRCHITM",62,0)
 . . . I 'PRCLOCK D ERR("Filer was unable to lock Item Master Number "_PRCIEN_"/NIF Item #"_PRCNIF_".") Q
"RTN","PRCHITM",63,0)
 . . . S PRCSUB=PRCZ D DESC(PRCIEN,0) L -^PRC(441,PRCIEN)
"RTN","PRCHITM",64,0)
 . . . I $O(^PRCP(445,"AH",PRCIEN,""))]"" D BLDSEG^PRCPHLFM(3,PRCIEN,0) ;update supply stations
"RTN","PRCHITM",65,0)
 . . K PRCRR,PRCE,PRCL,PRCZ
"RTN","PRCHITM",66,0)
 I PRCNIF'?1.N D ERR("NIF Item Number is missing for Item Master Number "_PRCIEN_".")
"RTN","PRCHITM",67,0)
NEXT F  S PRCSUB=$O(^XTMP(PRCHNODE,1,PRCSUB)) Q:PRCSUB=""  S PRCX=$G(^(PRCSUB)) Q:"^G39^SE^"[("^"_$P(PRCX,U)_"^")
"RTN","PRCHITM",68,0)
 G PROCITM:$P(PRCX,U)="G39"
"RTN","PRCHITM",69,0)
EXIT I $D(PRCHNODE) D
"RTN","PRCHITM",70,0)
 . ; send message if errors
"RTN","PRCHITM",71,0)
 . I $D(^XTMP(PRCHNODE,"ERR")) D
"RTN","PRCHITM",72,0)
 . . N XMDUZ,XMMG,XMSUB,XMTEXT,XMY,XMZ
"RTN","PRCHITM",73,0)
 . . S XMSUB="Item Filing Errors for Interchange Control #"_PRCTXN
"RTN","PRCHITM",74,0)
 . . S XMDUZ="Master Item File Updater",XMTEXT="^XTMP(PRCHNODE,""ERR"","
"RTN","PRCHITM",75,0)
 . . S XMY("G.ISM")="",XMY("Lyford.Greene@med.va.gov")=""
"RTN","PRCHITM",76,0)
 . . D ^XMD
"RTN","PRCHITM",77,0)
 . ; if no errors delete ^XTMP nodes when done
"RTN","PRCHITM",78,0)
 . I '$D(^XTMP(PRCHNODE,"ERR")) K ^XTMP(PRCHNODE)
"RTN","PRCHITM",79,0)
 K PRCCTR,PRCE,PRCERRC,PRCI,PRCIEN,PRCL,PRCLOCK,PRCNIF,PRCHNODE,PRCRR,PRCSUB,PRCTXN,PRCX,PRCY,PRCZ,XMPOS,X,X1,X2,XMER,XMREC,XMRG,Y
"RTN","PRCHITM",80,0)
 ; delete MailMan message from server basket
"RTN","PRCHITM",81,0)
 I $D(XMZ) S XMSER="S."_XQSOP D REMSBMSG^XMA1C
"RTN","PRCHITM",82,0)
 Q
"RTN","PRCHITM",83,0)
DESC(PRCDA,PRCFLG) ;File Short and Extended Descriptions
"RTN","PRCHITM",84,0)
 N PRCDES
"RTN","PRCHITM",85,0)
 S PRCX=$G(^XTMP(PRCHNODE,1,PRCSUB))
"RTN","PRCHITM",86,0)
 I $P(PRCX,U)'="G69" D ERR("No descriptions exist for NIF Item Number "_PRCNIF_".") Q
"RTN","PRCHITM",87,0)
 S X=$P(PRCX,U,2) X ^%ZOSF("UPPERCASE") S PRCDES=Y
"RTN","PRCHITM",88,0)
 I PRCDES'="" D
"RTN","PRCHITM",89,0)
 . ; file NIF version of short description, but first save off
"RTN","PRCHITM",90,0)
 . I PRCFLG,$L($P($G(^PRC(441,PRCDA,9)),"^"))=0 D  I $D(PRCE("DIERR")) K PRCE,PRCRR Q
"RTN","PRCHITM",91,0)
 . . N PRCDESO S PRCDESO=$P($G(^PRC(441,PRCDA,0)),"^",2)
"RTN","PRCHITM",92,0)
 . . K PRCRR,PRCE S PRCRR(441,PRCDA_",",52)=PRCDESO
"RTN","PRCHITM",93,0)
 . . D FILE^DIE("E","PRCRR","PRCE")
"RTN","PRCHITM",94,0)
 . . I $D(PRCE("DIERR")) S PRCY=0 F  S PRCY=$O(PRCE("DIERR",1,"TEXT",PRCY)) Q:PRCY'>0  D ERR("Item Master Number "_PRCDA_": "_PRCE("DIERR",1,"TEXT",PRCY))
"RTN","PRCHITM",95,0)
 . . I $D(PRCE("DIERR")) K PRCRR Q
"RTN","PRCHITM",96,0)
 . . K PRCRR,PRCERR S PRCDESO=$E(PRCDESO,1,36)
"RTN","PRCHITM",97,0)
 . . I '$$FIND1^DIC(441.05,","_PRCDA_",","X",PRCDESO,"","","PRCE") D
"RTN","PRCHITM",98,0)
 . . . S PRCRR(441.05,"+1,"_PRCDA_",",.01)=PRCDESO D UPDATE^DIE("E","PRCRR","","PRCERR")
"RTN","PRCHITM",99,0)
 . . . I $D(PRCERR("DIERR")) S PRCY=0 F  S PRCY=$O(PRCERR("DIERR",1,"TEXT",PRCY)) Q:PRCY'>0  D ERR("Item Master Number "_PRCDA_": "_PRCERR("DIERR",1,"TEXT",PRCY))
"RTN","PRCHITM",100,0)
 . . . K PRCRR,PRCERR
"RTN","PRCHITM",101,0)
 . K PRCRR,PRCE S PRCRR(441,PRCDA_",",.05)=PRCDES D FILE^DIE("E","PRCRR","PRCE")
"RTN","PRCHITM",102,0)
 . I $D(PRCE("DIERR")) S PRCY=0 F  S PRCY=$O(PRCE("DIERR",1,"TEXT",PRCY)) Q:PRCY'>0  D ERR("Item Master Number "_PRCDA_": "_PRCE("DIERR",1,"TEXT",PRCY))
"RTN","PRCHITM",103,0)
 . K PRCRR,PRCE
"RTN","PRCHITM",104,0)
 ; save off prior description during first NIF import
"RTN","PRCHITM",105,0)
 ; if save fails, don't overwrite existing description with NIF extended description
"RTN","PRCHITM",106,0)
 I PRCFLG,$P($G(^PRC(441,PRCDA,8,0)),U,4)'>0 D  I $D(PRCE("DIERR")) K PRCE Q
"RTN","PRCHITM",107,0)
 . K PRCE D WP^DIE(441,PRCDA_",",50,"","^PRC(441,PRCDA,1)","PRCE")
"RTN","PRCHITM",108,0)
 . I $D(PRCE("DIERR")) S PRCY=0 F  S PRCY=$O(PRCE("DIERR",1,"TEXT",PRCY)) Q:PRCY'>0  D ERR("Item Master Number "_PRCDA_": "_PRCE("DIERR",1,"TEXT",PRCY))
"RTN","PRCHITM",109,0)
 ; extract extended description
"RTN","PRCHITM",110,0)
 S PRCI=0 K PRCY
"RTN","PRCHITM",111,0)
 F  S PRCSUB=$O(^XTMP(PRCHNODE,1,PRCSUB)) Q:PRCSUB=""  S PRCX=$G(^XTMP(PRCHNODE,1,PRCSUB)) Q:$P(PRCX,U)'="G69"  D
"RTN","PRCHITM",112,0)
 . S PRCI=PRCI+1,PRCY(PRCI)=$P($G(^XTMP(PRCHNODE,1,PRCSUB)),U,2)
"RTN","PRCHITM",113,0)
 I PRCI'>0 D ERR("No extended description exists for NIF Item Number "_PRCNIF_".")
"RTN","PRCHITM",114,0)
 I PRCI D
"RTN","PRCHITM",115,0)
 . ; file NIF extended description in description field
"RTN","PRCHITM",116,0)
 . K PRCE D WP^DIE(441,PRCDA_",",.1,"","PRCY","PRCE")
"RTN","PRCHITM",117,0)
 . K PRCY
"RTN","PRCHITM",118,0)
 . I $D(PRCE("DIERR")) S PRCY=0 F  S PRCY=$O(PRCE("DIERR",1,"TEXT",PRCY)) Q:PRCY'>0  D ERR("Item Master Number "_PRCDA_": "_PRCE("DIERR",1,"TEXT",PRCY))
"RTN","PRCHITM",119,0)
 . K PRCE
"RTN","PRCHITM",120,0)
 S PRCSUB=$O(^XTMP(PRCHNODE,1,PRCSUB),-1)
"RTN","PRCHITM",121,0)
 Q
"RTN","PRCHITM",122,0)
ERR(PRCMSG) ;Error processing
"RTN","PRCHITM",123,0)
 S PRCERRC=PRCERRC+1 S ^XTMP(PRCHNODE,"ERR",PRCERRC)=PRCMSG
"RTN","PRCHITM",124,0)
 Q
"RTN","PRCHITM2")
0^6^B8168070
"RTN","PRCHITM2",1,0)
PRCHITM2 ;WOIFO/LKG-NIF Items Descriptions Extract ;9/14/04  16:11
"RTN","PRCHITM2",2,0)
V ;;5.1;IFCAP;**63**;Oct 20, 2000
"RTN","PRCHITM2",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCHITM2",4,0)
PRT ;VA FileMan Print Output
"RTN","PRCHITM2",5,0)
 N PRCTXT S PRCTXT(1)="This option displays item records via FileMan print utilities."
"RTN","PRCHITM2",6,0)
 S PRCTXT(1,"F")="!!?5"
"RTN","PRCHITM2",7,0)
 S PRCTXT(2)="It supports up to 5 levels of sort based on displayed fields."
"RTN","PRCHITM2",8,0)
 S PRCTXT(2,"F")="!?5"
"RTN","PRCHITM2",9,0)
 D EN^DDIOL(.PRCTXT) K PRCTXT
"RTN","PRCHITM2",10,0)
 K L,DIC,FLDS,BY,FR,TO,DIS,DHD S DHD="IFCAP ITEM DESCRIPTIONS STATION "_$$GET1^DIQ(4,$$KSP^XUPARAM("INST")_",",99)
"RTN","PRCHITM2",11,0)
 S L=0,DIC=441,DIS(0)="I $P($G(^PRC(441,D0,0)),U,15)>0",BY=$$SORTKEYS
"RTN","PRCHITM2",12,0)
 I $D(DTOUT)!$D(DUOUT) G PRTX
"RTN","PRCHITM2",13,0)
 S FLDS=".01;C1;""IMF ITEM #"",51;C20;""NIF ITEM #"",14;C40;""EDIT DATE"",16;C60;""INACTIVE FLAG"",""SHORT DESCRIPTION:"";C1;"""",.05;C5;"""",""PRE-NIF SHORT DESCRIPTION:"";C1;"""",52;C5;"""""
"RTN","PRCHITM2",14,0)
 S FLDS(1)="""DESCRIPTION:"";C1;"""",.1;C5;"""",""PRE-NIF DESCRIPTION:"";C1;"""",50;C5;"""","" "";C1;"""""
"RTN","PRCHITM2",15,0)
 N PRCTR S PRCTR=0,DHIT="S PRCTR=PRCTR+1",DIOEND="W !!,""Count = "",PRCTR R:$E(IOST,1,2)=""C-"" !,""Press RETURN to continue... "",PRCX:DTIME",DIPCRIT=1
"RTN","PRCHITM2",16,0)
 S DIOBEG="W:$E(IOST,1,2)=""C-"" @IOF"
"RTN","PRCHITM2",17,0)
 D EN1^DIP
"RTN","PRCHITM2",18,0)
PRTX K L,DIC,DIS,FLDS,BY,FR,TO,DHD,DHIT,DIOBEG,DIOEND,DIPCRIT,DTOUT,DUOUT,DIROUT,PRCX
"RTN","PRCHITM2",19,0)
 Q
"RTN","PRCHITM2",20,0)
SORTKEYS() ;Returns sort key string
"RTN","PRCHITM2",21,0)
 N PRCCNT,PRCX S PRCCNT=0,PRCX=""
"RTN","PRCHITM2",22,0)
SORTIN K DIR,X,Y
"RTN","PRCHITM2",23,0)
 S DIR(0)="SO^.01:IMF Item# (NUMBER);51:NIF Item#;14:Edit Date (DATE ITEM CREATED);.05:Short Description;52:Pre-NIF Short Description"
"RTN","PRCHITM2",24,0)
 S DIR("A")=$S(PRCCNT=0:"Sort",1:"Then sort")_" by"
"RTN","PRCHITM2",25,0)
 S DIR("L",1)="   .01  IMF Item# (NUMBER)"
"RTN","PRCHITM2",26,0)
 S DIR("L",2)="    51  NIF Item#"
"RTN","PRCHITM2",27,0)
 S DIR("L",3)="    14  Edit Date (DATE ITEM CREATED)"
"RTN","PRCHITM2",28,0)
 S DIR("L",4)="   .05  Short Description"
"RTN","PRCHITM2",29,0)
 S DIR("L",5)="    52  Pre-NIF Short Description"
"RTN","PRCHITM2",30,0)
 S DIR("L",6)=""
"RTN","PRCHITM2",31,0)
 S DIR("L")="Press RETURN at the prompt when you have finished selecting sort fields."
"RTN","PRCHITM2",32,0)
 S DIR("?")="Enter "_$S(PRCCNT<1:"major",1:"minor")_" sort key"
"RTN","PRCHITM2",33,0)
 D ^DIR I $D(DUOUT)!$D(DTOUT)!$D(DIROUT) S PRCX="" G SORTX
"RTN","PRCHITM2",34,0)
 I Y'="" S PRCX=PRCX_$S(PRCCNT>0:",",1:"")_Y S PRCCNT=PRCCNT+1 G:PRCCNT<5 SORTIN
"RTN","PRCHITM2",35,0)
 S:PRCX="" PRCX=".01"
"RTN","PRCHITM2",36,0)
SORTX K DIR,DIRUT,DIROUT,X,Y
"RTN","PRCHITM2",37,0)
 Q PRCX
"RTN","PRCHQ4")
0^4^B41778600
"RTN","PRCHQ4",1,0)
PRCHQ4 ;WOIFO/LKG-RFQ Set up Transmission Records ;7/25/05  15:27
"RTN","PRCHQ4",2,0)
 ;;5.1;IFCAP;**63**;Oct 20, 2000
"RTN","PRCHQ4",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCHQ4",4,0)
HE ;Set up Heading segment
"RTN","PRCHQ4",5,0)
 N PRCN0,PRCN1,PRCA,PRCB,PRCZ,DA,DIC,DR,DIQ,X,Y
"RTN","PRCHQ4",6,0)
 S PRCN0=$G(^PRC(444,PRCDA,0)),PRCN1=$G(^PRC(444,PRCDA,1))
"RTN","PRCHQ4",7,0)
 S X=$P(PRCN0,U,2) D JDN^PRCUTL S PRCA="HE^^"_Y_"^^"
"RTN","PRCHQ4",8,0)
 S X=$P(PRCN1,U,2) D JDN^PRCUTL S PRCA=PRCA_Y_"^"
"RTN","PRCHQ4",9,0)
 S PRCB=$P(PRCN0,U,3),X=$P(PRCB,".") D JDN^PRCUTL S X=$P(PRCB,".",2)
"RTN","PRCHQ4",10,0)
 S X=X_$E("000000",$L(X)+1,6),PRCA=PRCA_Y_"^"_X_"^^^^^0^0^0^^^^^|"
"RTN","PRCHQ4",11,0)
 K DA S DA=$P(PRCN0,U,4) I DA?1.N D
"RTN","PRCHQ4",12,0)
 . K ^UTILITY("DIQ1",$J)
"RTN","PRCHQ4",13,0)
 . S DIC=200,DR=".01;.135",DIQ(0)="I" D EN^DIQ1 K DIC,DIQ,DR
"RTN","PRCHQ4",14,0)
 . S $P(PRCA,"^",8,9)=^UTILITY("DIQ1",$J,200,DA,.01,"I")_"^"_^UTILITY("DIQ1",$J,200,DA,.135,"I")
"RTN","PRCHQ4",15,0)
 . K ^UTILITY("DIQ1",$J)
"RTN","PRCHQ4",16,0)
 S ^TMP($J,"STRING",1)=PRCA
"RTN","PRCHQ4",17,0)
 I $P(PRCA,U,3)'?7N S PRCZ(1)="Invalid RFQ Reference Date"
"RTN","PRCHQ4",18,0)
 I $P(PRCA,U,5)'?7N S PRCZ(2)="Invalid Requested Delivery Date"
"RTN","PRCHQ4",19,0)
 I $P(PRCA,U,6)'?7N S PRCZ(3)="Invalid RFQ Bids Due Date"
"RTN","PRCHQ4",20,0)
 I $P(PRCA,U,7)'?6N S PRCZ(4)="Invalid RFQ Bids Due Time"
"RTN","PRCHQ4",21,0)
 I $P(PRCA,U,8)="" S PRCZ(5)="Contracting Officer's Name is missing"
"RTN","PRCHQ4",22,0)
 I $P(PRCA,U,9)="" S PRCZ(6)="Contracting Officer's Commercial Phone # is missing"
"RTN","PRCHQ4",23,0)
 I $D(PRCZ) S PRCERR=3 D EN^DDIOL(.PRCZ)
"RTN","PRCHQ4",24,0)
 Q
"RTN","PRCHQ4",25,0)
VELST(PRCN) ;Gets list of solicited vendors from RFQ and invokes 'VE' setup
"RTN","PRCHQ4",26,0)
 N PRCX,PRCY,X,PRCW S PRCX=0,PRCW=0
"RTN","PRCHQ4",27,0)
 F  S PRCX=$O(^PRC(444,PRCDA,5,PRCX)) Q:PRCX'?1.N  D
"RTN","PRCHQ4",28,0)
 . S PRCY=$G(^PRC(444,PRCDA,5,PRCX,0)) Q:PRCY=""
"RTN","PRCHQ4",29,0)
 . S:$P(PRCY,U,2)="" $P(PRCY,U,2)=$P(^PRC(444,PRCDA,0),U,7),$P(^PRC(444,PRCDA,5,PRCX,0),U,2)=$P(PRCY,U,2)
"RTN","PRCHQ4",30,0)
 . Q:";b;e;"'[(";"_$P(PRCY,U,2)_";")
"RTN","PRCHQ4",31,0)
 . S PRCY=$P(PRCY,U)
"RTN","PRCHQ4",32,0)
 . S X=$S(PRCY["PRC(440,":$P($G(^PRC(440,$P(PRCY,";"),7)),U,12),1:$P($G(^PRC(444.1,$P(PRCY,";"),0)),U,2))
"RTN","PRCHQ4",33,0)
 . I X="" D DUNERR(PRCY) Q
"RTN","PRCHQ4",34,0)
 . D VE(X,.PRCN) S PRCW=PRCW+1
"RTN","PRCHQ4",35,0)
 I $P($G(^PRC(444,PRCDA,1)),U,8)="y" D VE("PUBLIC",.PRCN) S PRCW=PRCW+1
"RTN","PRCHQ4",36,0)
 Q PRCW
"RTN","PRCHQ4",37,0)
VE(PRCD,PRCC) ;Set up Vendor segment
"RTN","PRCHQ4",38,0)
 S PRCC=PRCC+1
"RTN","PRCHQ4",39,0)
 S ^TMP($J,"STRING",PRCC)="VE^"_PRCD_"^^^^^^^^^^^^^^^^^^|"
"RTN","PRCHQ4",40,0)
 S ^TMP($J,"VE",PRCD)=""
"RTN","PRCHQ4",41,0)
 Q
"RTN","PRCHQ4",42,0)
ST(PRCC) ;Setting up Ship to segment
"RTN","PRCHQ4",43,0)
 N PRCX,PRCY,DA,DIC,DR
"RTN","PRCHQ4",44,0)
 S PRCY=$G(^PRC(444,PRCDA,0)),PRCX=$P(PRCY,U,10)
"RTN","PRCHQ4",45,0)
 S:PRCX="" PRCX=$E($P(PRCY,U),1,3)
"RTN","PRCHQ4",46,0)
 S PRCY=$P($G(^PRC(444,PRCDA,1)),U,3) Q:PRCY'?1.N
"RTN","PRCHQ4",47,0)
 S PRCX=$G(^PRC(411,PRCX,1,PRCY,0)) Q:PRCX=""
"RTN","PRCHQ4",48,0)
 S PRCC=PRCC+1
"RTN","PRCHQ4",49,0)
 I $P(PRCX,U,9)]"" S ^TMP($J,"STRING",PRCC)="ST^"_$P(PRCX,U,9)_"^^^^^^^^^|" G STX
"RTN","PRCHQ4",50,0)
 S PRCY="ST^^"_$P(PRCX,U)_"^"_$P(PRCX,U,2)_"^"_$P(PRCX,U,3)_"^"_$P(PRCX,U,4)
"RTN","PRCHQ4",51,0)
 S PRCY=PRCY_"^^"_$P(PRCX,U,5)_"^^"_$TR($P(PRCX,U,7),"-")_"^|"
"RTN","PRCHQ4",52,0)
 S DA=$P(PRCX,U,6) I DA?1.N D
"RTN","PRCHQ4",53,0)
 . K ^UTILITY("DIQ1",$J) S DIC=5,DR=1 D EN^DIQ1
"RTN","PRCHQ4",54,0)
 . S $P(PRCY,U,9)=$E(^UTILITY("DIQ1",$J,5,DA,1),1,2) K ^UTILITY("DIQ1",$J)
"RTN","PRCHQ4",55,0)
 S ^TMP($J,"STRING",PRCC)=PRCY
"RTN","PRCHQ4",56,0)
STX Q
"RTN","PRCHQ4",57,0)
MI(PRCRFQ,PRCC) ;Set up Miscellaneous Information segment
"RTN","PRCHQ4",58,0)
 N PRCY
"RTN","PRCHQ4",59,0)
 S PRCY="MI^^^^"_PRCRFQ_"^^^^^^|",PRCC=PRCC+1
"RTN","PRCHQ4",60,0)
 S ^TMP($J,"STRING",PRCC)=PRCY
"RTN","PRCHQ4",61,0)
 Q
"RTN","PRCHQ4",62,0)
AC(PRCC) ;Set up Accounting Information segment
"RTN","PRCHQ4",63,0)
 N PRCY
"RTN","PRCHQ4",64,0)
 S PRCY="AC^^"_$P($G(^PRC(444,PRCDA,1)),U)_"^^^^^^^^^^^^^^^^|",PRCC=PRCC+1
"RTN","PRCHQ4",65,0)
 S ^TMP($J,"STRING",PRCC)=PRCY
"RTN","PRCHQ4",66,0)
 Q
"RTN","PRCHQ4",67,0)
TX(PRCN,PRCC) ;Set up Text segment (i.e. Administrative Certification
"RTN","PRCHQ4",68,0)
 ;;or 864 text)
"RTN","PRCHQ4",69,0)
 ;;Syntax of call: S X=$$TX^PRCHQ4(ARG1,.ARG2)
"RTN","PRCHQ4",70,0)
 ;; Returns number of lines in reformatted Word Processing field
"RTN","PRCHQ4",71,0)
 ;;ARG1: CLOSED GLOBAL ROOT
"RTN","PRCHQ4",72,0)
 ;;ARG2: CURRENT MESSAGE LINE COUNT
"RTN","PRCHQ4",73,0)
 N PRCI,PRCT,PRCX,X,DIWL,DIWR,DIWF
"RTN","PRCHQ4",74,0)
 S PRCX=0,DIWL=1,DIWR=70,DIWF="" K ^UTILITY($J,"W")
"RTN","PRCHQ4",75,0)
 F  S PRCX=$O(@PRCN@(PRCX)) Q:PRCX=""  D
"RTN","PRCHQ4",76,0)
 . Q:'$D(@PRCN@(PRCX,0))  S X=@PRCN@(PRCX,0) D ^DIWP
"RTN","PRCHQ4",77,0)
 ;I PRCN="^PRC(444,PRCDA,4)",$G(PRCTYPE)="00",$P($G(^PRC(444,PRCDA,1)),U,8)="y" D
"RTN","PRCHQ4",78,0)
 ;. S X="If you are not an electronic trading partner with VA, you may submit" D ^DIWP
"RTN","PRCHQ4",79,0)
 ;. S X="your bid by mail or FAX to the Contracting Office.  If you would" D ^DIWP
"RTN","PRCHQ4",80,0)
 ;. S X="like to register as a VA Electronic Trading Partner, please contact" D ^DIWP
"RTN","PRCHQ4",81,0)
 ;. S X="your Software Provider or VA EDI Staff at 512-326-6463." D ^DIWP
"RTN","PRCHQ4",82,0)
 S PRCT=$G(^UTILITY($J,"W",1))+0
"RTN","PRCHQ4",83,0)
 F PRCI=1:1:PRCT D
"RTN","PRCHQ4",84,0)
 . S PRCC=PRCC+1,X=$G(^UTILITY($J,"W",1,PRCI,0)) S:$L(X)=0 X=" " S X=$TR(X,"^")
"RTN","PRCHQ4",85,0)
 . S ^TMP($J,"STRING",PRCC)="TX^"_PRCI_"^"_X_"^|"
"RTN","PRCHQ4",86,0)
 K ^UTILITY($J,"W")
"RTN","PRCHQ4",87,0)
 Q PRCT
"RTN","PRCHQ4",88,0)
IT(PRCC) ;Set up Item segment (Also calls SC and DE to set up Delivery
"RTN","PRCHQ4",89,0)
 ;;Schedule and Description segments for item.)
"RTN","PRCHQ4",90,0)
 N PRCA,PRCB,PRCD,PRCE,PRCF,PRCG,PRCH,PRCK,PRCL,PRCY,PRCCNT
"RTN","PRCHQ4",91,0)
 S PRCA=0,PRCCNT=0
"RTN","PRCHQ4",92,0)
 F  S PRCA=$O(^PRC(444,PRCDA,2,PRCA)) Q:PRCA'?1.N  D
"RTN","PRCHQ4",93,0)
 . S PRCL=0
"RTN","PRCHQ4",94,0)
 . S PRCB=$G(^PRC(444,PRCDA,2,PRCA,0)) Q:PRCB=""
"RTN","PRCHQ4",95,0)
 . S PRCD=$G(^PRC(444,PRCDA,2,PRCA,1)),PRCG=$P(PRCB,U)
"RTN","PRCHQ4",96,0)
 . S PRCY="IT^"_PRCG_"^"_$S($P(PRCB,U,6)]"":$P(PRCB,U,6),$P(PRCB,U,5)>0:$P($G(^PRC(441.2,$P(PRCB,U,5),0)),U),1:"")_"^^^",PRCCNT=PRCCNT+1
"RTN","PRCHQ4",97,0)
 . I $P($G(^PRC(444,PRCDA,5,0)),U,4)=1,$P($G(^PRC(444,PRCDA,1)),U,8)'="y" S $P(PRCY,U,5)=$P($G(^PRC(444,PRCDA,5)),U,2)
"RTN","PRCHQ4",98,0)
 . S PRCY=PRCY_$P(PRCB,U,9)_"^"_$P(PRCB,U,8)_"^"_($P(PRCB,U,2)*100)_"^^"
"RTN","PRCHQ4",99,0)
 . S PRCE=$P(PRCB,U,3) S:PRCE?1.N PRCH=$P($G(^PRCD(420.5,PRCE,0)),U),$P(PRCY,U,9)=PRCH
"RTN","PRCHQ4",100,0)
 . S PRCY=PRCY_"^^^^^^^^^^^^^"
"RTN","PRCHQ4",101,0)
 . S PRCE=$P(PRCB,U,7) S:PRCE?1.N PRCE=$P($P($G(^PRC(444.2,PRCE,0)),U)," "),$P(PRCY,U,22)=PRCE
"RTN","PRCHQ4",102,0)
 . S $P(PRCY,U,23,29)=$P(PRCD,U)_"^"_$P(PRCD,U,2)_"^"_$P(PRCB,U,11)_"^"_$P($G(^PRC(444,PRCDA,1)),U)_"^^^|"
"RTN","PRCHQ4",103,0)
 . S PRCC=PRCC+1,^TMP($J,"STRING",PRCC)=PRCY
"RTN","PRCHQ4",104,0)
 . S PRCF=PRCC
"RTN","PRCHQ4",105,0)
 . S $P(^TMP($J,"STRING",PRCF),U,21)=$$DE("^PRC(444,PRCDA,2,PRCA,2)",PRCG,.PRCC)
"RTN","PRCHQ4",106,0)
 . S $P(^TMP($J,"STRING",PRCF),U,27)=$$SC("^PRC(444,PRCDA,2,PRCA,4)",PRCG,PRCH,.PRCC,.PRCL)
"RTN","PRCHQ4",107,0)
 . I $P(^TMP($J,"STRING",PRCF),U,3)="" S PRCK(1)="Item #"_$P(PRCB,U)_": FSC and NSN missing"
"RTN","PRCHQ4",108,0)
 . I $P(^TMP($J,"STRING",PRCF),U,8)'>0 S PRCK(2)="Item #"_$P(PRCB,U)_": Quantity not greater than zero"
"RTN","PRCHQ4",109,0)
 . I $P(^TMP($J,"STRING",PRCF),U,9)="" S PRCK(3)="Item #"_$P(PRCB,U)_": Unit of Purchase missing"
"RTN","PRCHQ4",110,0)
 . I $P(^TMP($J,"STRING",PRCF),U,22)="" S PRCK(4)="Item #"_$P(PRCB,U)_": SIC Code missing"
"RTN","PRCHQ4",111,0)
 . I $P(^TMP($J,"STRING",PRCF),U,21)'>0 S PRCK(5)="Item #"_$P(PRCB,U)_": Item Description missing"
"RTN","PRCHQ4",112,0)
 . I $P(^TMP($J,"STRING",PRCF),U,27)>0,$P(^(PRCF),U,8)'=PRCL S PRCK(6)="Item #"_$P(PRCB,U)_": Total of Delivery Schedule NOT EQUAL to Line Quantity"
"RTN","PRCHQ4",113,0)
 S:PRCCNT>0 $P(^TMP($J,"STRING",1),U,12)=PRCCNT
"RTN","PRCHQ4",114,0)
 I PRCCNT'>0 S PRCK(7)="No Items in RFQ"
"RTN","PRCHQ4",115,0)
 I $D(PRCK) S PRCERR=2 D EN^DDIOL(.PRCK)
"RTN","PRCHQ4",116,0)
 Q
"RTN","PRCHQ4",117,0)
SC(PRCN,PRCIT,PRCU,PRCC,PRCJ) ;Set up Delivery Schedule for item
"RTN","PRCHQ4",118,0)
 N PRCW,PRCX,PRCY,PRCZ,X,Y
"RTN","PRCHQ4",119,0)
 S PRCX=0,PRCW=0
"RTN","PRCHQ4",120,0)
 F  S PRCX=$O(@PRCN@(PRCX)) Q:PRCX'?1.N  D
"RTN","PRCHQ4",121,0)
 . S PRCZ=$G(@PRCN@(PRCX,0)) Q:PRCZ=""
"RTN","PRCHQ4",122,0)
 . S X=$P(PRCZ,U,2) D JDN^PRCUTL
"RTN","PRCHQ4",123,0)
 . S PRCY="SC^"_PRCIT_"^"_$P(PRCZ,U)_"^"_($P(PRCZ,U,3)*100)_"^"_PRCU
"RTN","PRCHQ4",124,0)
 . S PRCY=PRCY_"^"_Y_"^|",PRCC=PRCC+1,PRCJ=PRCJ+$P(PRCY,U,4)
"RTN","PRCHQ4",125,0)
 . S ^TMP($J,"STRING",PRCC)=PRCY,PRCW=PRCW+1
"RTN","PRCHQ4",126,0)
 Q PRCW
"RTN","PRCHQ4",127,0)
DE(PRCN,PRCIT,PRCC) ;Set up Item Description segments
"RTN","PRCHQ4",128,0)
 N PRCI,PRCT,PRCX,X,DIWL,DIWR,DIWF
"RTN","PRCHQ4",129,0)
 S PRCX=0,DIWL=1,DIWR=70,DIWF="" K ^UTILITY($J,"W")
"RTN","PRCHQ4",130,0)
 F  S PRCX=$O(@PRCN@(PRCX)) Q:PRCX=""  D
"RTN","PRCHQ4",131,0)
 . Q:'$D(@PRCN@(PRCX,0))  S X=@PRCN@(PRCX,0) D ^DIWP
"RTN","PRCHQ4",132,0)
 S PRCT=$G(^UTILITY($J,"W",1))
"RTN","PRCHQ4",133,0)
 F PRCI=1:1:PRCT D
"RTN","PRCHQ4",134,0)
 . S PRCC=PRCC+1,X=$G(^UTILITY($J,"W",1,PRCI,0)) S:$L(X)=0 X=" " S X=$TR(X,"^")
"RTN","PRCHQ4",135,0)
 . S ^TMP($J,"STRING",PRCC)="DE^"_PRCIT_"^"_PRCI_"^"_X_"^|"
"RTN","PRCHQ4",136,0)
 K ^UTILITY($J,"W")
"RTN","PRCHQ4",137,0)
 Q PRCT
"RTN","PRCHQ4",138,0)
DUNERR(PRCA) ;Displays the Error Message for Vendor Lacking Dun #
"RTN","PRCHQ4",139,0)
 Q:$D(ZTQUEUED)
"RTN","PRCHQ4",140,0)
 N PRCB S PRCB="^"_$P(PRCA,";",2)_$P(PRCA,";")_",0)"
"RTN","PRCHQ4",141,0)
 S PRCB=$P(@PRCB,U)_" lacks a Dun # so NOT a recipient"
"RTN","PRCHQ4",142,0)
 D EN^DDIOL(PRCB)
"RTN","PRCHQ4",143,0)
 Q
"RTN","PRCOE2")
0^3^B29096792
"RTN","PRCOE2",1,0)
PRCOE2 ;WISC/DJM-IFCAP SEGMENTS IT,DE ;12/26/02  18:18
"RTN","PRCOE2",2,0)
V ;;5.1;IFCAP;**63**;Oct 20, 2000
"RTN","PRCOE2",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCOE2",4,0)
 ;;
"RTN","PRCOE2",5,0)
 ;;THIS ROUTINE AT THE 'IT' ENTRY POINT CREATES ONE 'IT' SEGMENTS FOR EACH
"RTN","PRCOE2",6,0)
 ;;ITEM IN THE P.O. TRANSACTION.  IT ALSO CREATES ALL THE 'DE' SEGMENTS
"RTN","PRCOE2",7,0)
 ;;NEEDED FOR EACH 'IT' SEGMENT.  THE LAST THING DONE IN THIS ROUTINE IS
"RTN","PRCOE2",8,0)
 ;;TO UPDATE THE 'HE' SEGMENT AT FIELD NAME 'LINE COUNT' TO REFLECT THE
"RTN","PRCOE2",9,0)
 ;;NUMBER OF 'IT' SEGMENTS IN THIS TRANSACTION.
"RTN","PRCOE2",10,0)
 ;;
"RTN","PRCOE2",11,0)
 ;;THIS ROUTINE CREATES THE 'COMMENTS' SEGMENT AT THE 'CO' ENTRY POINT.
"RTN","PRCOE2",12,0)
 ;;ADDITIONALLY, THE 'HE' SEGMENT AT THE FIELD NAME 'COMMENT COUNT' IS
"RTN","PRCOE2",13,0)
 ;;UPDATED TO REFLECT THE NUMBER OF 'CO' SEGMENTS CREATED.
"RTN","PRCOE2",14,0)
 ;;
"RTN","PRCOE2",15,0)
IT(VAR1,VAR2,TOTAL) ;ITEMS INFORMATION SEGMENT
"RTN","PRCOE2",16,0)
 N AZ,B,C,CN,DC,DE,DELDT,DIS,DIWF,DIWL,DIWR,FOBPOINT,FSC,HAZM,I0,I2
"RTN","PRCOE2",17,0)
 N I4,INC,INN,ITEM,ITEMCNT,J,LI,LIN,LOT,LPRC,LPRC1,M,MPN,MPNO,N,N1L
"RTN","PRCOE2",18,0)
 N NSN,UC,UNIT,UP,UPN,VPN,X,TD,SKU,SKUF,SERNO,SEQU,SCH
"RTN","PRCOE2",19,0)
 N SCHX,RP,PDA,OS,OT,IT,ICNT
"RTN","PRCOE2",20,0)
 S (ITEM,ITEMCNT)=0
"RTN","PRCOE2",21,0)
 S OS=$P($G(^PRC(442,VAR1,7)),"^",1)+0 ; order status
"RTN","PRCOE2",22,0)
 S TOTAL=$P($G(^PRC(442,VAR1,2,0)),U,4)+7
"RTN","PRCOE2",23,0)
 F  S ITEM=$O(^PRC(442,VAR1,2,ITEM)) Q:ITEM'>0  S ITEMCNT=ITEMCNT+1 D  Q:VAR2]""
"RTN","PRCOE2",24,0)
 .S I0=$G(^PRC(442,VAR1,2,ITEM,0))
"RTN","PRCOE2",25,0)
 .S I2=$G(^PRC(442,VAR1,2,ITEM,2))
"RTN","PRCOE2",26,0)
 .I I2="" S VAR2="NI2N^"_ITEM Q
"RTN","PRCOE2",27,0)
 .S I4=$G(^PRC(442,VAR1,2,ITEM,4))
"RTN","PRCOE2",28,0)
 .S NSN=$P(I0,U,13)
"RTN","PRCOE2",29,0)
 .S FSC=$P(I2,U,3)
"RTN","PRCOE2",30,0)
 .S FSC=$S(FSC]"":$P($G(^PRC(441.2,FSC,0)),U),1:"")
"RTN","PRCOE2",31,0)
 .S NSN=$S(NSN]"":NSN,1:FSC)
"RTN","PRCOE2",32,0)
 .S B="IT^"_$P(I0,U)_"^"_NSN_"^" ; FIELDS 1, 2, 3
"RTN","PRCOE2",33,0)
 .S RP=$P(I0,U,5)
"RTN","PRCOE2",34,0)
 .S INN=""
"RTN","PRCOE2",35,0)
 .S:RP>0 INN=$G(^PRC(441,RP,0))
"RTN","PRCOE2",36,0)
 .S INC=$P(INN,U,12)
"RTN","PRCOE2",37,0)
 .I $P(I0,U,13)="",INC="" S INC=77777
"RTN","PRCOE2",38,0)
 .S B=B_INC_"^" ; FIELD 4
"RTN","PRCOE2",39,0)
 .S VPN=$P(I0,U,6)
"RTN","PRCOE2",40,0)
 .S:$E(VPN,1)="#" VPN=$E(VPN,2,99)
"RTN","PRCOE2",41,0)
 .S B=B_VPN_"^" ; FIELD 5
"RTN","PRCOE2",42,0)
 .;
"RTN","PRCOE2",43,0)
IT0 .S MPN=$S(RP>0:$G(^PRC(441,RP,3)),1:"")
"RTN","PRCOE2",44,0)
 .I MPN="" S B=B_"^" G IT1 ; FIELD 6 - CONDITION 1
"RTN","PRCOE2",45,0)
 .S MPNO=$P(MPN,U,5)
"RTN","PRCOE2",46,0)
 .S:$E(MPNO,1)="#" MPNO=$E(MPNO,2,99)
"RTN","PRCOE2",47,0)
 .S B=B_MPNO_"^" ; FIELD 6 - CONDITION 2
"RTN","PRCOE2",48,0)
 .;
"RTN","PRCOE2",49,0)
IT1 .S N=$P(I0,U,15)
"RTN","PRCOE2",50,0)
 .I N]"" S N=$TR($P(N,"-",1,3),"-")
"RTN","PRCOE2",51,0)
 .S B=B_N_"^" ; FIELD 7 (NDC)
"RTN","PRCOE2",52,0)
 .;
"RTN","PRCOE2",53,0)
 .S Q=$P(I0,U,2)
"RTN","PRCOE2",54,0)
 .I OS=45 S Q=0 ; zero for cancelled orders
"RTN","PRCOE2",55,0)
 .I Q="" S VAR2="NQTY^"_$P(I0,U) Q
"RTN","PRCOE2",56,0)
 .S Q=Q\1+(Q#1>0)_"00"
"RTN","PRCOE2",57,0)
 .S B=B_Q_"^" ; FIELD 8 (quantity)
"RTN","PRCOE2",58,0)
 .;
"RTN","PRCOE2",59,0)
 .S UP=$P(I0,U,3)
"RTN","PRCOE2",60,0)
 .I UP="" S VAR2="NUOP^"_$P(I0,U) Q
"RTN","PRCOE2",61,0)
 .S UPN=$G(^PRCD(420.5,UP,0))
"RTN","PRCOE2",62,0)
 .I UPN="" S VAR2="NUPN^"_$P(I0,U) Q
"RTN","PRCOE2",63,0)
 .S UNIT=$P(UPN,U)
"RTN","PRCOE2",64,0)
 .I UNIT="" S VAR2="NUNI^"_$P(I0,U) Q
"RTN","PRCOE2",65,0)
 .S B=B_UNIT_"^" ; FIELD 9
"RTN","PRCOE2",66,0)
 .;
"RTN","PRCOE2",67,0)
 .S UC=$P(I0,U,9)
"RTN","PRCOE2",68,0)
 .I UC="" S VAR2="NAUC^"_$P(I0,U) Q
"RTN","PRCOE2",69,0)
 .I UC="N/C"!(OS=45) S UC=0 ; no charge or canceled
"RTN","PRCOE2",70,0)
 .S UC=$TR($J(UC,11,4)," .","0") ; pad and strip decimal point
"RTN","PRCOE2",71,0)
 .;
"RTN","PRCOE2",72,0)
IT2 .S B=B_UC_"^^" ; FIELDS 10, 11
"RTN","PRCOE2",73,0)
 .S LIN=$P(I0,U)
"RTN","PRCOE2",74,0)
 .S (DIS,TD)=0
"RTN","PRCOE2",75,0)
 .F  S DIS=$O(^PRC(442,VAR1,3,DIS)) G:DIS'>0 IT3 D   Q:LIN=LI
"RTN","PRCOE2",76,0)
 . .S DC=$G(^PRC(442,VAR1,3,DIS,0))
"RTN","PRCOE2",77,0)
 . .S LI=$P(DC,U,6)
"RTN","PRCOE2",78,0)
 . .Q
"RTN","PRCOE2",79,0)
 .S TD=1
"RTN","PRCOE2",80,0)
 .S PDA=$P(DC,U,2)
"RTN","PRCOE2",81,0)
 .I $E(PDA,1)'="$" D  G IT3
"RTN","PRCOE2",82,0)
 . .S N=$TR($J(PDA,5,2)," .","0")
"RTN","PRCOE2",83,0)
 . .S B=B_N_"^^" ; FIELDS 12, 13 - CONDITION 1
"RTN","PRCOE2",84,0)
 .S PDA=$E(PDA,2,99)
"RTN","PRCOE2",85,0)
 .S N=$TR($J(PDA,10,2)," .","0")
"RTN","PRCOE2",86,0)
 .S B=B_"^"_N_"^" ; FIELDS 12, 13 - CONDITION 2
"RTN","PRCOE2",87,0)
 .;
"RTN","PRCOE2",88,0)
IT3 .S:'TD B=B_"^^" ; FIELDS 12, 13 - CONDITION 3
"RTN","PRCOE2",89,0)
 .I $P(I0,U,16)>0 D
"RTN","PRCOE2",90,0)
 . .S SKU=$P(I0,U,16)
"RTN","PRCOE2",91,0)
 . .S SKU=$G(^PRCD(420.5,SKU,0))
"RTN","PRCOE2",92,0)
 . .S SKUF=$S($P(I0,U,17)>0:$P(I0,U,17),1:1)
"RTN","PRCOE2",93,0)
 . .S SKU=$P(SKU,U)
"RTN","PRCOE2",94,0)
 . .S B=B_SKU_"^"_SKUF_"^" ; FIELDS 14, 15 - CONDITION 1
"RTN","PRCOE2",95,0)
 .I $P(I0,U,16)'>0 S B=B_UNIT_"^1^" ; FIELDS 14, 15 - CONDITION 2
"RTN","PRCOE2",96,0)
 .;
"RTN","PRCOE2",97,0)
IT4 .S B=B_"^"_$S($P(I4,U,15)]"":$P(I4,U,15),1:"N")_"^"_$S($P(I4,U,16)]"":$P(I4,U,16),1:"N")_"^" ; FIELDS 16, 17, 18
"RTN","PRCOE2",98,0)
 .S CN=$P(I2,U,2)
"RTN","PRCOE2",99,0)
 .S OT=$P(^PRC(442,VAR1,1),U,7)
"RTN","PRCOE2",100,0)
 .S OT=","_OT_","
"RTN","PRCOE2",101,0)
 .S OT=$S(",1,4,6,10,"[OT:"D",1:"")
"RTN","PRCOE2",102,0)
 .I OT="D",CN="" S VAR2="NCNO^"_$P(I0,U) Q:VAR2]""
"RTN","PRCOE2",103,0)
 .S B=B_CN_"^" ; FIELD 19
"RTN","PRCOE2",104,0)
 .S LPRC=$P($G(^PRC(442,VAR1,1)),U,19)
"RTN","PRCOE2",105,0)
 .S LPRC1=""
"RTN","PRCOE2",106,0)
 .I LPRC>0 S LPRC1=$P($G(^PRC(443.8,LPRC,0)),U)
"RTN","PRCOE2",107,0)
 .I LPRC>0 S:LPRC1=10 LPRC1="A"
"RTN","PRCOE2",108,0)
 .S B=B_LPRC1_"^" ; FIELD 20
"RTN","PRCOE2",109,0)
 .;
"RTN","PRCOE2",110,0)
IT5 .S (IT,ICNT)=0
"RTN","PRCOE2",111,0)
 .S AZ=$G(^PRC(442,VAR1,2,ITEM,1,0))
"RTN","PRCOE2",112,0)
 .G:$P(AZ,U,4)'>0 IT6
"RTN","PRCOE2",113,0)
 .S DIWR=70
"RTN","PRCOE2",114,0)
 .S DIWL=1
"RTN","PRCOE2",115,0)
 .S DIWF=""
"RTN","PRCOE2",116,0)
 .S DE=0
"RTN","PRCOE2",117,0)
 .K ^UTILITY($J,"W")
"RTN","PRCOE2",118,0)
 .F  S DE=$O(^PRC(442,VAR1,2,ITEM,1,DE)) Q:DE=""  D
"RTN","PRCOE2",119,0)
 . .S X=$G(^PRC(442,VAR1,2,ITEM,1,DE,0))
"RTN","PRCOE2",120,0)
 . .D DIWP^PRCUTL($G(DA))
"RTN","PRCOE2",121,0)
 .S J=$G(^UTILITY($J,"W",1))
"RTN","PRCOE2",122,0)
 .G:J="" IT6
"RTN","PRCOE2",123,0)
 .I J>900 S J=900
"RTN","PRCOE2",124,0)
 .S IT=1
"RTN","PRCOE2",125,0)
 .S ICNT=""
"RTN","PRCOE2",126,0)
 .F I=1:1:J D
"RTN","PRCOE2",127,0)
 . .S N=$G(^UTILITY($J,"W",1,I,0)) S:$L(N)=0 N=" " S N=$TR(N,"^")
"RTN","PRCOE2",128,0)
 . .S M="DE^"_$P(I0,U)_"^"_I_"^"_N_"^|" ; DE SEGMENT FIELDS 1, 2, 3, 4, 5
"RTN","PRCOE2",129,0)
 . .S ^TMP($J,"STRING",ITEMCNT+6+I)=M
"RTN","PRCOE2",130,0)
 . .S TOTAL=TOTAL+1
"RTN","PRCOE2",131,0)
 . .S ICNT=ICNT+1
"RTN","PRCOE2",132,0)
 .K ^UTILITY($J,"W")
"RTN","PRCOE2",133,0)
 .;
"RTN","PRCOE2",134,0)
IT6 .S B=B_$S(IT:ICNT,1:0)_"^^" ; FIELDS 21, 22
"RTN","PRCOE2",135,0)
 .;
"RTN","PRCOE2",136,0)
IT7 .S LOT=$P(I4,U,17)
"RTN","PRCOE2",137,0)
 .S SERNO=$P(I4,U,18)
"RTN","PRCOE2",138,0)
 .S HAZM=$P(I2,U,14)
"RTN","PRCOE2",139,0)
 .S B=B_LOT_"^"_SERNO_"^"_HAZM_"^^" ; FIELDS 23, 24, 25, 26
"RTN","PRCOE2",140,0)
 .;
"RTN","PRCOE2",141,0)
IT8 .S IT=0
"RTN","PRCOE2",142,0)
 .S AZ=$P(^PRC(442,VAR1,0),U)
"RTN","PRCOE2",143,0)
 .S SCH=0
"RTN","PRCOE2",144,0)
 .S SEQU=0
"RTN","PRCOE2",145,0)
 .F  S SCH=$O(^PRC(442.8,"AC",AZ,ITEM,SCH)) Q:SCH=""  D
"RTN","PRCOE2",146,0)
 .  .S SCHX=$G(^PRC(442.8,SCH,0))
"RTN","PRCOE2",147,0)
 .  .Q:SCHX=""
"RTN","PRCOE2",148,0)
 .  .S SEQU=SEQU+1
"RTN","PRCOE2",149,0)
 .  .S IT=1
"RTN","PRCOE2",150,0)
 .  .S X=$P(SCHX,U,3)
"RTN","PRCOE2",151,0)
 .  .D JD^PRCFDLN
"RTN","PRCOE2",152,0)
 .  .S DELDT=$E(X,1,3)+1700_$E(Y,1,3)
"RTN","PRCOE2",153,0)
 .  .S M="SC^"_$P(I0,U)_"^"_SEQU_"^"_($P(SCHX,U,5)*100)_"^"_UNIT_"^"_DELDT_"^|"
"RTN","PRCOE2",154,0)
 .  .S ^TMP($J,"STRING",ITEMCNT+6+ICNT+SEQU)=M
"RTN","PRCOE2",155,0)
 .  .S TOTAL=TOTAL+1
"RTN","PRCOE2",156,0)
IT9 .S B=B_$S(IT:SEQU,1:0)_"^"_$P(INN,U,15)_"^|" ;FIELDS 27, 28, 29
"RTN","PRCOE2",157,0)
 .S ^TMP($J,"STRING",ITEMCNT+6)=B
"RTN","PRCOE2",158,0)
 .S ITEMCNT=ITEMCNT+ICNT+SEQU
"RTN","PRCOE2",159,0)
 .S B=^TMP($J,"STRING",1) ;ADD 1 TO HE SEGMENT FIELD 12
"RTN","PRCOE2",160,0)
 .S $P(B,U,12)=$P(B,U,12)+1
"RTN","PRCOE2",161,0)
 .S ^TMP($J,"STRING",1)=B
"RTN","PRCOE2",162,0)
 Q
"RTN","PRCPHLFM")
0^5^B37336873
"RTN","PRCPHLFM",1,0)
PRCPHLFM ;WISC/CC/DWA-build HL7 messages for item maintenance ;11/5/03  22:34
"RTN","PRCPHLFM",2,0)
V ;;5.1;IFCAP;**1,24,52,63**;Oct 20, 2000
"RTN","PRCPHLFM",3,0)
 ;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCPHLFM",4,0)
 ;
"RTN","PRCPHLFM",5,0)
 Q
"RTN","PRCPHLFM",6,0)
 ;
"RTN","PRCPHLFM",7,0)
BLDSEG(ACTION,ITEM,SIP) ;
"RTN","PRCPHLFM",8,0)
 ;
"RTN","PRCPHLFM",9,0)
 ; ACTION (1st '^' piece) 1 if add, 2 if delete, 3 if update
"RTN","PRCPHLFM",10,0)
 ;        (2nd '^' piece) flag indicating txn MUST be built 
"RTN","PRCPHLFM",11,0)
 ; ITEM   the number of the item affected
"RTN","PRCPHLFM",12,0)
 ; SIP    the number of the secondary inventory point affected
"RTN","PRCPHLFM",13,0)
 ;        0 (zero) for non-station specific edits (from PRCHE)
"RTN","PRCPHLFM",14,0)
 ; MSG    0 to suppress messages, 1 to display them
"RTN","PRCPHLFM",15,0)
 ;
"RTN","PRCPHLFM",16,0)
 ; if this is a non-station specific edit (i.e. from PRCHE)
"RTN","PRCPHLFM",17,0)
 ;
"RTN","PRCPHLFM",18,0)
 N MSG,PUSH S MSG=1
"RTN","PRCPHLFM",19,0)
 S PUSH=0
"RTN","PRCPHLFM",20,0)
 I $P(ACTION,"^",2)=1 S PUSH=1
"RTN","PRCPHLFM",21,0)
 I ACTION=3,SIP=0 D  QUIT
"RTN","PRCPHLFM",22,0)
 . N SS,IME
"RTN","PRCPHLFM",23,0)
 . S SS=0,IME=0 ; entry from PRCHE
"RTN","PRCPHLFM",24,0)
 . F  S SS=$O(^PRCP(445.5,SS)) Q:'+SS  D
"RTN","PRCPHLFM",25,0)
 . . ; send transaction to non-station specific SS housing the item
"RTN","PRCPHLFM",26,0)
 . . I $P(^PRCP(445.5,SS,0),"^",2)="O",$O(^PRCP(445,"AH",ITEM,SS,""))>0 D GO
"RTN","PRCPHLFM",27,0)
 ;
"RTN","PRCPHLFM",28,0)
 N IME,SS
"RTN","PRCPHLFM",29,0)
 I $P(^PRCP(445,SIP,0),"^",3)'="S" QUIT
"RTN","PRCPHLFM",30,0)
 I '$D(^PRCP(445,SIP,1,ITEM)),ACTION'=2 QUIT
"RTN","PRCPHLFM",31,0)
 S SS=$P($G(^PRCP(445,SIP,5)),"^",1) I SS']"" QUIT
"RTN","PRCPHLFM",32,0)
 S IME=0
"RTN","PRCPHLFM",33,0)
 ;
"RTN","PRCPHLFM",34,0)
GO N %,%H,%I,CNT,DATETIME,HLA,HLCS,HLEVN,HLFS,ITEMDATA,MC,NM,OUT,PRIM,SEG,X
"RTN","PRCPHLFM",35,0)
 N MYRESULT,MYOPTNS
"RTN","PRCPHLFM",36,0)
 I SIP>0,'+$P($G(^PRCP(445,SIP,1,ITEM,0)),"^",9),ACTION'=2 QUIT  ; only deletes are valid for items with no normal
"RTN","PRCPHLFM",37,0)
 S CNT=0,OUT=0
"RTN","PRCPHLFM",38,0)
 ; if the supply station doesn't handle station specific data
"RTN","PRCPHLFM",39,0)
 I SS>0,$P(^PRCP(445.5,SS,0),"^",2)="O",'PUSH D  I OUT QUIT
"RTN","PRCPHLFM",40,0)
 . ; I ACTION=3 S OUT=1 QUIT  ; quit if editing station specific data
"RTN","PRCPHLFM",41,0)
 . ; for add, quit if item is already on an IP in the SS 
"RTN","PRCPHLFM",42,0)
 . I ACTION=1 D
"RTN","PRCPHLFM",43,0)
 . . N A,B
"RTN","PRCPHLFM",44,0)
 . . S A=0
"RTN","PRCPHLFM",45,0)
 . . S A=$O(^PRCP(445,"AH",ITEM,SS,"")) I +A'>0 S OUT=1 QUIT  ; should have one
"RTN","PRCPHLFM",46,0)
 . . I A'=SIP S OUT=1 QUIT  ; item on a different IP in the SS
"RTN","PRCPHLFM",47,0)
 . . I A=SIP S B=$O(^PRCP(445,"AH",ITEM,SS,A)) I +B>0 S OUT=1 QUIT
"RTN","PRCPHLFM",48,0)
 . I ACTION=2 D  I OUT=1 QUIT
"RTN","PRCPHLFM",49,0)
 . . N A,B
"RTN","PRCPHLFM",50,0)
 . . S A=0
"RTN","PRCPHLFM",51,0)
 . . S A=$O(^PRCP(445,"AH",ITEM,SS,"")) I +A'>0 QUIT  ; should find one
"RTN","PRCPHLFM",52,0)
 . . I A'=SIP S OUT=1 QUIT  ; item is on a different IP in the SS, don't delete from system
"RTN","PRCPHLFM",53,0)
 . . I A=SIP S B=$O(^PRCP(445,"AH",ITEM,SS,A)) I +B>0 S OUT=1 QUIT  ; item exists on another IP in the SS, don't delete from system
"RTN","PRCPHLFM",54,0)
 . ; S SIP=0 ; flag to indicate revisions are not station specific
"RTN","PRCPHLFM",55,0)
 ;
"RTN","PRCPHLFM",56,0)
 ; set up environment for message
"RTN","PRCPHLFM",57,0)
1 D INIT^HLFNC2("PRCP EV ITEM UPDATE",.HL)
"RTN","PRCPHLFM",58,0)
 I $G(HL) D:'IME&MSG  Q  ; error occurred
"RTN","PRCPHLFM",59,0)
 . D EN^DDIOL("The HL7 transaction cannot be built now.")
"RTN","PRCPHLFM",60,0)
 . I ACTION=1,MSG D EN^DDIOL("You will need to add this item directly to the supply station.")
"RTN","PRCPHLFM",61,0)
 . I ACTION=2,MSG D EN^DDIOL("You will need to delete this item from your supply station.")
"RTN","PRCPHLFM",62,0)
 . I ACTION=3,MSG D EN^DDIOL("You must edit the item again later to update the supply station.")
"RTN","PRCPHLFM",63,0)
 . D EN^DDIOL("Error: "_$P(HL,"^",2))
"RTN","PRCPHLFM",64,0)
 S HLFS=$G(HL("FS")) I HLFS="" S HLFS="|"
"RTN","PRCPHLFM",65,0)
 S HLCS=$E(HL("ECH"),1)
"RTN","PRCPHLFM",66,0)
 ;
"RTN","PRCPHLFM",67,0)
 I MSG D EN^DDIOL("Building HL7 "_($P("ADD,DELETE,EDIT",",",ACTION))_" Transaction on item#"_ITEM_" for "_$P(^PRCP(445.5,SS,0),"^",1))
"RTN","PRCPHLFM",68,0)
 I MSG,SIP>0 D EN^DDIOL(" station "_$P(^PRCP(445,SIP,0),"^",1))
"RTN","PRCPHLFM",69,0)
 ;
"RTN","PRCPHLFM",70,0)
 ; create MFI segment
"RTN","PRCPHLFM",71,0)
2 D NOW^%DTC S DATETIME=$P(%+17000000,".",1)_$P(%,".",2)
"RTN","PRCPHLFM",72,0)
 S SEG="MFI"_HL("FS")
"RTN","PRCPHLFM",73,0)
 S SEG=SEG_($S(SIP>0:445,1:441))_HL("FS")_HL("FS")
"RTN","PRCPHLFM",74,0)
 S HLA("HLS",1)=SEG_"UPD"_HL("FS")_DATETIME_HL("FS")_HL("FS")_"NE"
"RTN","PRCPHLFM",75,0)
 ;
"RTN","PRCPHLFM",76,0)
 ; create MFE segment
"RTN","PRCPHLFM",77,0)
 S SEG="MFE"_HL("FS")
"RTN","PRCPHLFM",78,0)
 I ACTION=1 S SEG=SEG_"MAD"
"RTN","PRCPHLFM",79,0)
 I ACTION=2 S SEG=SEG_"MDL"
"RTN","PRCPHLFM",80,0)
 I ACTION=3 S SEG=SEG_"MUP"
"RTN","PRCPHLFM",81,0)
 S SEG=SEG_HL("FS")_HL("FS")_HL("FS")
"RTN","PRCPHLFM",82,0)
 S HLA("HLS",2)=SEG_ITEM_"~"_$P(^PRC(441,ITEM,0),"^",2)
"RTN","PRCPHLFM",83,0)
 ;
"RTN","PRCPHLFM",84,0)
 I SIP'>0 G 3 ; Z segment for station specific items only
"RTN","PRCPHLFM",85,0)
 ;
"RTN","PRCPHLFM",86,0)
 S ITEMDATA=""
"RTN","PRCPHLFM",87,0)
 S ITEMDATA=^PRCP(445,SIP,1,ITEM,0)
"RTN","PRCPHLFM",88,0)
 S PRIM=$P(ITEMDATA,"^",12) I PRIM']"" D
"RTN","PRCPHLFM",89,0)
 . S PRIM=$O(^PRCP(445,"AB",SIP,""))
"RTN","PRCPHLFM",90,0)
 . I PRIM]"" S PRIM=PRIM_";PRCP(445,"
"RTN","PRCPHLFM",91,0)
 S NM=$P($G(^PRCP(445,SIP,1,ITEM,6)),"^",1)
"RTN","PRCPHLFM",92,0)
 I NM']"",+PRIM>0 S NM=$P($G(^PRCP(445,+PRIM,1,ITEM,6)),"^",1)
"RTN","PRCPHLFM",93,0)
 I NM']"" S NM=$P(^PRC(441,ITEM,0),"^",2)
"RTN","PRCPHLFM",94,0)
 ;
"RTN","PRCPHLFM",95,0)
 ; create Z segment
"RTN","PRCPHLFM",96,0)
 S SEG="ZIM"_HL("FS")_ITEM_"~"_NM ; item# and description
"RTN","PRCPHLFM",97,0)
 S SEG=SEG_HL("FS")_"~"_$P(^PRCP(445,SIP,0),"^",1) ; full station name
"RTN","PRCPHLFM",98,0)
 S SEG=SEG_HL("FS")_$P(ITEMDATA,"^",9) ; normal level
"RTN","PRCPHLFM",99,0)
 S SEG=SEG_HL("FS")_$P(ITEMDATA,"^",10) ; std reord pt
"RTN","PRCPHLFM",100,0)
 S SEG=SEG_HL("FS")_$P(ITEMDATA,"^",11)_HL("FS") ; emergency
"RTN","PRCPHLFM",101,0)
 I $P(ITEMDATA,"^",5)]"" S SEG=SEG_$P($G(^PRCD(420.5,$P(ITEMDATA,"^",5),0)),"^",1) ; unit of issue
"RTN","PRCPHLFM",102,0)
 I PRIM]"" S X=$$GETVEN^PRCPUVEN(SIP,ITEM,PRIM,1)
"RTN","PRCPHLFM",103,0)
 S X=$P(X,"^",4) I X']"" S X=1
"RTN","PRCPHLFM",104,0)
 S SEG=SEG_HL("FS")_X ; pkg multiple (conversion factor)
"RTN","PRCPHLFM",105,0)
 S HLA("HLS",3)=SEG_HL("FS")_$P(ITEMDATA,"^",15) ; last cost
"RTN","PRCPHLFM",106,0)
 ;
"RTN","PRCPHLFM",107,0)
 ;call HL7 to transmit message
"RTN","PRCPHLFM",108,0)
3 S HLL("LINKS",1)="PRCP SU ITEM UPDATE"_"^"_$P(^PRCP(445.5,SS,0),"^",3)
"RTN","PRCPHLFM",109,0)
 D GENERATE^HLMA("PRCP EV ITEM UPDATE","LM",1,.MYRESULT,"",.MYOPTNS)
"RTN","PRCPHLFM",110,0)
 I MSG,$P(MYRESULT,"^",2,3)]"" D
"RTN","PRCPHLFM",111,0)
 . ; error handler for message send failures
"RTN","PRCPHLFM",112,0)
 . D EN^DDIOL("ERROR: "_MYRESULT)
"RTN","PRCPHLFM",113,0)
 Q
"RTN","PRCPHLFM",114,0)
 ;
"RTN","PRCPHLFM",115,0)
 ; send all items in IP to supply station
"RTN","PRCPHLFM",116,0)
INIT D ^PRCPUSEL Q:'$G(PRCP("I"))
"RTN","PRCPHLFM",117,0)
 I PRCP("DPTYPE")'="P" W !," This option may only be invoked from the Primary"
"RTN","PRCPHLFM",118,0)
 N ACTION,DIR,DTOUT,DUOUT,INVPT,ITEM,PRCPINPT,Y
"RTN","PRCPHLFM",119,0)
INIT0 S INVPT=$$INVPT^PRCPUINV(PRC("SITE"),"S","","","") Q:'INVPT
"RTN","PRCPHLFM",120,0)
 I $P($G(^PRCP(445,INVPT,5)),"^",1)']"" W !,"This option may only be run for supply station secondary inventory points." G INIT0
"RTN","PRCPHLFM",121,0)
 ;
"RTN","PRCPHLFM",122,0)
 ; ask initialize or update supply station items?
"RTN","PRCPHLFM",123,0)
 S DIR("A",1)="This option sends information about ALL items with a normal stock"
"RTN","PRCPHLFM",124,0)
 S DIR("A",2)="level greater than zero to the linked supply station. "
"RTN","PRCPHLFM",125,0)
 S DIR("A",3)="You must flag the transactions as 'ADD' or 'EDIT'."
"RTN","PRCPHLFM",126,0)
 S DIR("A",4)=""
"RTN","PRCPHLFM",127,0)
 S DIR("A")="Select 'Add' OR 'Edit' transactions"
"RTN","PRCPHLFM",128,0)
 S DIR(0)="SB^A:ADD;E:EDIT"
"RTN","PRCPHLFM",129,0)
 D ^DIR
"RTN","PRCPHLFM",130,0)
 I $D(DUOUT)!($D(DTOUT))!(Y']"") QUIT
"RTN","PRCPHLFM",131,0)
 S ACTION=3 ; default to edit
"RTN","PRCPHLFM",132,0)
 I Y="A" S ACTION=1
"RTN","PRCPHLFM",133,0)
 ;
"RTN","PRCPHLFM",134,0)
 S ITEM=0 F  S ITEM=$O(^PRCP(445,INVPT,1,ITEM)) Q:'+ITEM  D
"RTN","PRCPHLFM",135,0)
 . I '$D(^PRCP(445,INVPT,1,ITEM,0)) QUIT
"RTN","PRCPHLFM",136,0)
 . I +$P($G(^PRCP(445,INVPT,1,ITEM,0)),"^",9)=0 QUIT
"RTN","PRCPHLFM",137,0)
 . D BLDSEG^PRCPHLFM(ACTION,ITEM,INVPT)
"RTN","PRCPHLFM",138,0)
 . Q
"RTN","PRCPHLFM",139,0)
 Q
"UP",441,441.06,-1)
441^8
"UP",441,441.06,0)
441.06
"VER")
8.0^22.0
"^DD",441,441,50,0)
PRE_NIF LONG DESCRIPTION^441.06^^8;0
"^DD",441,441,50,21,0)
^^4^4^3041008^
"^DD",441,441,50,21,1,0)
This field stores the value of the DESCRIPTION field (#.1) prior to the
"^DD",441,441,50,21,2,0)
overwriting of that field's value with the value from the National Item
"^DD",441,441,50,21,3,0)
File (NIF) database.  This field MUST NOT be edited.  It is for historical
"^DD",441,441,50,21,4,0)
record only.  
"^DD",441,441,51,0)
NIF ITEM NUMBER^NJ8,0^^0;15^K:+X'=X!(X>99999999)!(X<1)!(X?.E1"."1N.N) X
"^DD",441,441,51,1,0)
^.1
"^DD",441,441,51,1,1,0)
441^I
"^DD",441,441,51,1,1,1)
S ^PRC(441,"I",$E(X,1,30),DA)=""
"^DD",441,441,51,1,1,2)
K ^PRC(441,"I",$E(X,1,30),DA)
"^DD",441,441,51,1,1,"%D",0)
^^1^1^3040908^
"^DD",441,441,51,1,1,"%D",1,0)
This cross reference enables lookup by the National Item File's Item Number.
"^DD",441,441,51,1,1,"DT")
3040908
"^DD",441,441,51,3)
Type a Number between 1 and 99999999, 0 Decimal Digits
"^DD",441,441,51,21,0)
^.001^2^2^3021223^^
"^DD",441,441,51,21,1,0)
This is the Item Number assigned to this item in the National Item File (NIF).
"^DD",441,441,51,21,2,0)
This field is populated by a feed from the NIF and must not be user edited.
"^DD",441,441,51,"DT")
3040908
"^DD",441,441,52,0)
PRE_NIF SHORT DESCRIPTION^F^^9;1^K:$L(X)>60!($L(X)<3) X
"^DD",441,441,52,3)
Do not edit this field.  It is populated by the NIF/IFCAP interface.
"^DD",441,441,52,21,0)
^.001^5^5^3050103^^^^
"^DD",441,441,52,21,1,0)
This field  stores the value of the SHORT DESCRIPTION field
"^DD",441,441,52,21,2,0)
(#.05) prior to that field's overwrite with the value of
"^DD",441,441,52,21,3,0)
the Brief Item Description from the National Item File
"^DD",441,441,52,21,4,0)
(NIF). This field must not be edited.  It is for historical
"^DD",441,441,52,21,5,0)
record only.
"^DD",441,441,52,"DT")
3040908
"^DD",441,441.06,0)
PRE_NIF LONG DESCRIPTION SUB-FIELD^^.01^1
"^DD",441,441.06,0,"DT")
3040908
"^DD",441,441.06,0,"NM","PRE_NIF LONG DESCRIPTION")

"^DD",441,441.06,0,"UP")
441
"^DD",441,441.06,.01,0)
PRE_NIF LONG DESCRIPTION^W^^0;1^Q
"^DD",441,441.06,.01,3)
Do not edit this field. It is populated by the NIF/IFCAP interface.
"^DD",441,441.06,.01,21,0)
^.001^4^4^3041008^^
"^DD",441,441.06,.01,21,1,0)
This field stores the value of the DESCRIPTION field (#.1) prior to the
"^DD",441,441.06,.01,21,2,0)
overwriting of that field's value with the value from the National Item
"^DD",441,441.06,.01,21,3,0)
File (NIF) database.  This field MUST NOT be edited.  It is for historical
"^DD",441,441.06,.01,21,4,0)
record only.
"^DD",441,441.06,.01,"DT")
3040908
"BLD",2886,6)
^SEQ #72
**END**
**END**
