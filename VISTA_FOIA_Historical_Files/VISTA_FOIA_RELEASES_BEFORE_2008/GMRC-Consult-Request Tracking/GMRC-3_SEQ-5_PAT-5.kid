Released GMRC*3*5 SEQ #5
Extracted from mail message
**KIDS**:GMRC*3.0*5^

**INSTALL NAME**
GMRC*3.0*5
"BLD",962,0)
GMRC*3.0*5^CONSULT/REQUEST TRACKING^0^2990428^y
"BLD",962,1,0)
^^1^1^2990428^
"BLD",962,1,1,0)
See National Patch Module for details of enhancements.
"BLD",962,4,0)
^9.64PA^^
"BLD",962,"ABPKG")
n
"BLD",962,"INIT")
GMRCYP5
"BLD",962,"KRN",0)
^9.67PA^19^18
"BLD",962,"KRN",.4,0)
.4
"BLD",962,"KRN",.401,0)
.401
"BLD",962,"KRN",.402,0)
.402
"BLD",962,"KRN",.403,0)
.403
"BLD",962,"KRN",.5,0)
.5
"BLD",962,"KRN",.84,0)
.84
"BLD",962,"KRN",3.6,0)
3.6
"BLD",962,"KRN",3.8,0)
3.8
"BLD",962,"KRN",9.2,0)
9.2
"BLD",962,"KRN",9.8,0)
9.8
"BLD",962,"KRN",9.8,"NM",0)
^9.68A^18^18
"BLD",962,"KRN",9.8,"NM",1,0)
GMRCADC^^0^B9525436
"BLD",962,"KRN",9.8,"NM",2,0)
GMRCEDIT^^0^B9930865
"BLD",962,"KRN",9.8,"NM",3,0)
GMRCEDT1^^0^B31800007
"BLD",962,"KRN",9.8,"NM",4,0)
GMRCEDT2^^0^B9031407
"BLD",962,"KRN",9.8,"NM",5,0)
GMRCEDT3^^0^B13304726
"BLD",962,"KRN",9.8,"NM",6,0)
GMRCEDT4^^0^B67546845
"BLD",962,"KRN",9.8,"NM",7,0)
GMRCEDT5^^0^B8404659
"BLD",962,"KRN",9.8,"NM",8,0)
GMRCHL7^^0^B25970884
"BLD",962,"KRN",9.8,"NM",9,0)
GMRCHL72^^0^B11271463
"BLD",962,"KRN",9.8,"NM",10,0)
GMRCHL7A^^0^B26829382
"BLD",962,"KRN",9.8,"NM",11,0)
GMRCHL7B^^0^B15129415
"BLD",962,"KRN",9.8,"NM",12,0)
GMRCHL7U^^0^B17092200
"BLD",962,"KRN",9.8,"NM",13,0)
GMRCPR0^^0^B15604442
"BLD",962,"KRN",9.8,"NM",14,0)
GMRCYP5^^0^B12074052
"BLD",962,"KRN",9.8,"NM",15,0)
GMRC101^^0^B13650465
"BLD",962,"KRN",9.8,"NM",16,0)
GMRCR^^0^B16413390
"BLD",962,"KRN",9.8,"NM",17,0)
GMRC101C^^0^B32302482
"BLD",962,"KRN",9.8,"NM",18,0)
GMRCT^^0^B4519174
"BLD",962,"KRN",9.8,"NM","B","GMRC101",15)

"BLD",962,"KRN",9.8,"NM","B","GMRC101C",17)

"BLD",962,"KRN",9.8,"NM","B","GMRCADC",1)

"BLD",962,"KRN",9.8,"NM","B","GMRCEDIT",2)

"BLD",962,"KRN",9.8,"NM","B","GMRCEDT1",3)

"BLD",962,"KRN",9.8,"NM","B","GMRCEDT2",4)

"BLD",962,"KRN",9.8,"NM","B","GMRCEDT3",5)

"BLD",962,"KRN",9.8,"NM","B","GMRCEDT4",6)

"BLD",962,"KRN",9.8,"NM","B","GMRCEDT5",7)

"BLD",962,"KRN",9.8,"NM","B","GMRCHL7",8)

"BLD",962,"KRN",9.8,"NM","B","GMRCHL72",9)

"BLD",962,"KRN",9.8,"NM","B","GMRCHL7A",10)

"BLD",962,"KRN",9.8,"NM","B","GMRCHL7B",11)

"BLD",962,"KRN",9.8,"NM","B","GMRCHL7U",12)

"BLD",962,"KRN",9.8,"NM","B","GMRCPR0",13)

"BLD",962,"KRN",9.8,"NM","B","GMRCR",16)

"BLD",962,"KRN",9.8,"NM","B","GMRCT",18)

"BLD",962,"KRN",9.8,"NM","B","GMRCYP5",14)

"BLD",962,"KRN",19,0)
19
"BLD",962,"KRN",19,"NM",0)
^9.68A^^
"BLD",962,"KRN",19.1,0)
19.1
"BLD",962,"KRN",101,0)
101
"BLD",962,"KRN",101,"NM",0)
^9.68A^3^3
"BLD",962,"KRN",101,"NM",1,0)
GMRCACT EDIT FIELD^^0
"BLD",962,"KRN",101,"NM",2,0)
GMRCACT EDIT CONSULT/REQUEST^^2
"BLD",962,"KRN",101,"NM",3,0)
GMRCACT RESUBMIT DENIED CONSULT^^0
"BLD",962,"KRN",101,"NM","B","GMRCACT EDIT CONSULT/REQUEST",2)

"BLD",962,"KRN",101,"NM","B","GMRCACT EDIT FIELD",1)

"BLD",962,"KRN",101,"NM","B","GMRCACT RESUBMIT DENIED CONSULT",3)

"BLD",962,"KRN",409.61,0)
409.61
"BLD",962,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",962,"KRN",771,0)
771
"BLD",962,"KRN",869.2,0)
869.2
"BLD",962,"KRN",870,0)
870
"BLD",962,"KRN",8994,0)
8994
"BLD",962,"KRN",8994,"NM",0)
^9.68A^^
"BLD",962,"KRN","B",.4,.4)

"BLD",962,"KRN","B",.401,.401)

"BLD",962,"KRN","B",.402,.402)

"BLD",962,"KRN","B",.403,.403)

"BLD",962,"KRN","B",.5,.5)

"BLD",962,"KRN","B",.84,.84)

"BLD",962,"KRN","B",3.6,3.6)

"BLD",962,"KRN","B",3.8,3.8)

"BLD",962,"KRN","B",9.2,9.2)

"BLD",962,"KRN","B",9.8,9.8)

"BLD",962,"KRN","B",19,19)

"BLD",962,"KRN","B",19.1,19.1)

"BLD",962,"KRN","B",101,101)

"BLD",962,"KRN","B",409.61,409.61)

"BLD",962,"KRN","B",771,771)

"BLD",962,"KRN","B",869.2,869.2)

"BLD",962,"KRN","B",870,870)

"BLD",962,"KRN","B",8994,8994)

"BLD",962,"QUES",0)
^9.62^^
"BLD",962,"REQB",0)
^9.611^2^2
"BLD",962,"REQB",1,0)
GMRC*3.0*4^2
"BLD",962,"REQB",2,0)
GMRC*3.0*1^2
"BLD",962,"REQB","B","GMRC*3.0*1",2)

"BLD",962,"REQB","B","GMRC*3.0*4",1)

"INIT")
GMRCYP5
"KRN",101,4626,-1)
2^2
"KRN",101,4626,0)
GMRCACT EDIT CONSULT/REQUEST^Edit a consult that has been denied for resubmission.^^M^1119^^^^^^^128
"KRN",101,4626,1,0)
^^5^5^2981216^^^^
"KRN",101,4626,1,1,0)
When a consult has been entered and submitted to a service, and that
"KRN",101,4626,1,2,0)
service has denied the request (for whatever reason), then this option
"KRN",101,4626,1,3,0)
allows the clinician to edit the consult to correct/add information needed
"KRN",101,4626,1,4,0)
by the requested service to evaluate and accept the consult.  When the
"KRN",101,4626,1,5,0)
consult is edited, it may then be resubmitted to the consult service.
"KRN",101,4626,4)
22^3^^
"KRN",101,4626,10,0)
^101.01PA^2^2
"KRN",101,4626,10,1,0)
4627^ED^2^^^Edit A Field
"KRN",101,4626,10,1,"^")
GMRCACT EDIT FIELD
"KRN",101,4626,10,2,0)
4661^RS^2^^^ReSubmit Consult
"KRN",101,4626,10,2,"^")
GMRCACT RESUBMIT DENIED CONSULT
"KRN",101,4626,10,"B",4627,1)

"KRN",101,4626,10,"B",4661,2)

"KRN",101,4626,15)

"KRN",101,4626,20)

"KRN",101,4626,26)
D SHOW^VALM
"KRN",101,4626,28)
Select Item/Action:
"KRN",101,4626,99)
57696,74978
"KRN",101,4627,-1)
0^1
"KRN",101,4627,0)
GMRCACT EDIT FIELD^Edit a specific field of a Consult^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,4627,1,0)
^^5^5^2990604^
"KRN",101,4627,1,1,0)
This protocol calls the routine that will allow specific fields of a
"KRN",101,4627,1,2,0)
consult to be edited.  The call will ask for the field to be edited, and
"KRN",101,4627,1,3,0)
then allow editing of that field.  When editing is complete, the display
"KRN",101,4627,1,4,0)
is updated to show the edited fields and the user is returned to the
"KRN",101,4627,1,5,0)
main menu.
"KRN",101,4627,15)
S VALMBCK="R"
"KRN",101,4627,20)
D FULL^VALM1,EDITFLD^GMRCEDT4(GMRCDA)
"KRN",101,4627,99)
57695,50102
"KRN",101,4661,-1)
0^3
"KRN",101,4661,0)
GMRCACT RESUBMIT DENIED CONSULT^Resubmit a denied consult from Alert action after edit.^^A^^^^^^^^CONSULT/REQUEST TRACKING
"KRN",101,4661,1,0)
^^2^2^2990103^^^^
"KRN",101,4661,1,1,0)
This protocol will allow a consult/request to be resubmitted as a pending
"KRN",101,4661,1,2,0)
consult/request after it has been denied by the service.
"KRN",101,4661,15)
S VALMBCK="Q" S:'$D(GMRCDA) GMRCDA=GMRCDAP
"KRN",101,4661,20)
D EN^GMRCEDT2(GMRCDA)
"KRN",101,4661,99)
56964,54443
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",128,-1)
1^1
"PKG",128,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",128,20,0)
^9.402P^^
"PKG",128,22,0)
^9.49I^1^1
"PKG",128,22,1,0)
3.0^2980101
"PKG",128,22,1,"PAH",1,0)
5^2990428
"PKG",128,22,1,"PAH",1,1,0)
^^1^1^2990607
"PKG",128,22,1,"PAH",1,1,1,0)
See National Patch Module for details of enhancements.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
18
"RTN","GMRC101")
0^15^B13650465
"RTN","GMRC101",1,0)
GMRC101 ;SLC/DLT - Create Protocol entries for OE/RR ADD orders screens ;5/20/98  14:20
"RTN","GMRC101",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRC101",3,0)
EN ;Entry to build Consult types for Add menus
"RTN","GMRC101",4,0)
 W !,"There are 2 types of Protocols used by the Consult Package on 'Add Orders'",!,"menus in OE/RR."
"RTN","GMRC101",5,0)
EN1 K DIR,DA S GMRCEND=0,DIR(0)="SO^1:CONSULT TYPE;2:PROCEDURE REQUEST",DIR("A")="Select Protocol Type",DIR("??")="^D HELP^GMRC101"
"RTN","GMRC101",6,0)
 D ^DIR K DIR S GMRCEND=$S($D(DTOUT):1,$D(DUOUT):1,$D(DIROUT):1,1:0) I GMRCEND G END
"RTN","GMRC101",7,0)
 I Y=1 D CONSULT G:GMRCEND=2 EN1 D END Q
"RTN","GMRC101",8,0)
 I Y=2 D PROCDURE G:GMRCEND=2 EN1 D END Q
"RTN","GMRC101",9,0)
 Q
"RTN","GMRC101",10,0)
CONSULT ;entry to create a Consult Type
"RTN","GMRC101",11,0)
 S GMRCPFX="GMRCT ",GMRCDESC="Consult Type",GMRCDEFN="GMRCT SAMPLE CONSULT TYPE"
"RTN","GMRC101",12,0)
 W !!,"NOTE: All Consult Types in the Protocol file are prefixed with ""GMRCT "".",!,"For A Fast Lookup Of Consult Type Protocols, Type ""GMRCT"" At The Prompt.",!
"RTN","GMRC101",13,0)
 D SETDEF I GMRCEND Q
"RTN","GMRC101",14,0)
 D EN^GMRC101C
"RTN","GMRC101",15,0)
 Q
"RTN","GMRC101",16,0)
PROCDURE ;entry to create a Procedure Request
"RTN","GMRC101",17,0)
 S GMRCPFX="GMRCR ",GMRCDESC="Procedure Request",GMRCDEFN="GMRCR SAMPLE PROCEDURE"
"RTN","GMRC101",18,0)
 W !!,"NOTE: All Procedure/Requests in the Protocol file are prefixed with ""GMRCR "".",!,"For A Fast Look-up Of Procedures, Type 'GMRCR' At The Prompt.",!
"RTN","GMRC101",19,0)
 D SETDEF I GMRCEND Q
"RTN","GMRC101",20,0)
 D EN^GMRC101C
"RTN","GMRC101",21,0)
 Q
"RTN","GMRC101",22,0)
SETDEF ;Set GMRCDEF once to hold for filling in ORDEF for protocol processing.
"RTN","GMRC101",23,0)
 S GMRCDEF=$O(^ORD(101,"B",GMRCDEFN,"")) I 'GMRCDEF W !!,"Missing Sample Protocol "_GMRCDEFN,! S GMRCEND=1 Q
"RTN","GMRC101",24,0)
 Q
"RTN","GMRC101",25,0)
END K GMRCACT,GMRCEND,GMRCDEFN,GMRCDEF,GMRCDESC,GMRCPFX,GMRCPRF
"RTN","GMRC101",26,0)
 K ORPKG,DIROUT,DUOUT,DTOUT,Y
"RTN","GMRC101",27,0)
 Q
"RTN","GMRC101",28,0)
HELP ;?? help for DIR to define types of consults
"RTN","GMRC101",29,0)
 W @IOF
"RTN","GMRC101",30,0)
 W !,"Protocols defined in this option and Added to Add New Order menus, will have"
"RTN","GMRC101",31,0)
 W !,"orders created in OE/RR based on the protocols definition."
"RTN","GMRC101",32,0)
 W !,"(e.g. Item Text: TPN, and Related Consult Service/Specialty: Pharmacy Service"
"RTN","GMRC101",33,0)
 W !,"  creates a ""Pharmacy Service TPN"" order in OE/RR if the TPN protocol is"
"RTN","GMRC101",34,0)
 W !,"  selected from the Add New Orders menu in OE/RR"
"RTN","GMRC101",35,0)
 W !!,"CONSULT TYPES are names of consults which are very common, such as: "
"RTN","GMRC101",36,0)
 W !,"     ""TPN"" Consult for Hyperalimentation Pharmacy consult"
"RTN","GMRC101",37,0)
 W !,"     ""Physical Therapy"" Consult for RMS"
"RTN","GMRC101",38,0)
 W !,"  Once the commonly known consults are defined here, they may also be added"
"RTN","GMRC101",39,0)
 W !,"  to OE/RR Add New Orders menus for ease of ordering."
"RTN","GMRC101",40,0)
 W !,"  Consult Type protocols are always prefixed with ""GMRCT """
"RTN","GMRC101",41,0)
 W !!,"PROCEDURE REQUESTS are names of procedures, tests, or other requests"
"RTN","GMRC101",42,0)
 W !,"  which are very common, such as: "
"RTN","GMRC101",43,0)
 W !,"    ""EKG: Portable"""
"RTN","GMRC101",44,0)
 W !,"  Once the commonly known procedures which may be ordered without a consult"
"RTN","GMRC101",45,0)
 W !,"  are defined here, they may also be added to OE/RR Add New Orders menus for"
"RTN","GMRC101",46,0)
 W !,"  ease of ordering."
"RTN","GMRC101",47,0)
 W !,"  Procedure Request protocols are always prefixed with ""GMRCR """
"RTN","GMRC101",48,0)
 W !! R "Press RETURN to continue: ",X:$S($D(DTIME):DTIME,1:300)
"RTN","GMRC101",49,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIROUT) D END S GMRCEND=1 Q
"RTN","GMRC101C")
0^17^B32302482
"RTN","GMRC101C",1,0)
GMRC101C ;SLC/DLT,DCM - Create Protocol entries for OE/RR ADD orders screens (Continued) ;5/21/98  13:53
"RTN","GMRC101C",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRC101C",3,0)
DEFAULT ;default variable setting depending on protocol type
"RTN","GMRC101C",4,0)
 S OREA=$S(GMRCPFX="GMRCT ":"S GMRCEN=""C"" D EN^GMRCP",1:"S GMRCEN=""R"" D EN^GMRCP")
"RTN","GMRC101C",5,0)
 S ORPKG=$$PACKAGE^GMRCR I ORPKG="" S GMRCMSG="Missing package entry for CONSULT/REQUEST TRACKING" D EXAC^GMRCADC(GMRCMSG) S GMRCEND=1 Q
"RTN","GMRC101C",6,0)
 S ORFL="",ORDEF=GMRCDEF
"RTN","GMRC101C",7,0)
 Q
"RTN","GMRC101C",8,0)
EN ;Loop logic to process consult types/procedure request
"RTN","GMRC101C",9,0)
 K DIR S DIR(0)="Y",DIR("B")="Y",DIR("A")="Do you want to select an existing "_GMRCDESC_" protocol" D ^DIR K DIR S GMRCEND=$S($D(DTOUT):1,$D(DUOUT):1,$D(DIROUT):1,1:0)
"RTN","GMRC101C",10,0)
 I GMRCEND D END Q
"RTN","GMRC101C",11,0)
 I Y=1 G EN1
"RTN","GMRC101C",12,0)
 F  D ADD S GMRCTRLC="UPD" Q:GMRCEND
"RTN","GMRC101C",13,0)
 Q
"RTN","GMRC101C",14,0)
EN1 ;get a GMRCT or GMRCR prefixed protocol
"RTN","GMRC101C",15,0)
 S DIC=101,DIC(0)="AEMQZ",DIC("A")="'"_GMRCPFX_"' prefixed PROTOCOL NAME: ",DIC("S")="I X["""_$E(GMRCPFX,1,$L(GMRCPFX)-1)_"""" D ^DIC K DIC I Y<0 S GMRCEND=1 D END Q
"RTN","GMRC101C",16,0)
 I GMRCPFX="GMRCT ",Y(0)'?1"GMRCT ".E W !,"Select a 'GMRCT ' prefixed protocol",! G EN1
"RTN","GMRC101C",17,0)
 I GMRCPFX="GMRCR ",Y(0)'?1"GMRCR ".E W !,"Select a 'GMRCR ' prefixed protocol",! G EN1
"RTN","GMRC101C",18,0)
 D DEFAULT S ORDA=+Y,ORDANM=$P(Y(0),"^",1) D SETUP,ASK I GMRCEND D END Q
"RTN","GMRC101C",19,0)
 S GMRCTRLC="MUP",GMRCACT="UPD"
"RTN","GMRC101C",20,0)
 D BUILD,END W ! G EN
"RTN","GMRC101C",21,0)
ADD ;Enter a new protocol
"RTN","GMRC101C",22,0)
 K ORDA,ITEMTXT,ORDANM D DEFAULT Q:GMRCEND  D ASK I GMRCEND D END Q
"RTN","GMRC101C",23,0)
 S GMRCTRLC="MAD",GMRCACT="REP"
"RTN","GMRC101C",24,0)
 D BUILD,END
"RTN","GMRC101C",25,0)
 Q
"RTN","GMRC101C",26,0)
ASK ;Ask for Item Text and Related Service
"RTN","GMRC101C",27,0)
 D ITEMTXT Q:GMRCEND
"RTN","GMRC101C",28,0)
 I $D(GMRCSS),$L(GMRCSS) S DIR("B")=GMRCSS
"RTN","GMRC101C",29,0)
ASK1 ;Ask for Relate Service
"RTN","GMRC101C",30,0)
 K DA,X S DIR(0)="PO^123.5:EMZ",DIR("A")="RELATED CONSULT SERVICE/SPECIALTY" D ^DIR K DIR I $D(X),X="@" W !,$C(7),"You Cannot Delete This Entry, ONLY CHANGE IT!",! D  G ASK1
"RTN","GMRC101C",31,0)
 .I $D(GMRCSS),$L(GMRCSS) S DIR("B")=GMRCSS
"RTN","GMRC101C",32,0)
 .Q
"RTN","GMRC101C",33,0)
 S GMRCEND=$S($D(DTOUT):1,$D(DUOUT):1,$D(DIROUT):1,Y<0:1,1:0) I GMRCEND D END Q
"RTN","GMRC101C",34,0)
 S:+Y>0 ORFL=+Y_";GMR(123.5,"
"RTN","GMRC101C",35,0)
 Q:GMRCEND
"RTN","GMRC101C",36,0)
 I $P(^GMR(123.5,+Y,0),"^",2)=9 W !,$C(7),$P(^(0),"^",1)_" Has Been Disabled.",!,"You Cannot Add A Procedure To A Disabled Service!",! G ASK1
"RTN","GMRC101C",37,0)
 I ORFL="" W !!,"  Each "_GMRCDESC_" will have a related consult service associated with it.",!,"  If no service is identified the service will be prompted for during the",!,"  add orders process.",!
"RTN","GMRC101C",38,0)
 Q
"RTN","GMRC101C",39,0)
ITEMTXT ;Ask for item text
"RTN","GMRC101C",40,0)
 K DIR,DA I $D(ORDA),$L(ITEMTXT) S DIR("B")=ITEMTXT
"RTN","GMRC101C",41,0)
 I '$D(ORDA) W !! S DIR("A")="Enter the new protocols ITEM TEXT"
"RTN","GMRC101C",42,0)
 K REJECT S DIR(0)="101,1" D ^DIR K DIR S GMRCEND=$S($D(DTOUT):1,$D(DUOUT):1,$D(DIROUT):1,1:0) K DIROUT,DUOUT,DTOUT Q:GMRCEND  I Y="" S GMRCEND=2 Q
"RTN","GMRC101C",43,0)
 I $E(Y,1)'?1A W !!,"The ITEM TEXT should begin with an alphabetic character.  Please re-enter." G ITEMTXT
"RTN","GMRC101C",44,0)
 I $D(ORDA),ORDA,Y=ITEMTXT S (GMRCTXT,ORTXT)=Y Q
"RTN","GMRC101C",45,0)
 S GMRCTXT=$O(^ORD(101,"C",Y,"")) I GMRCTXT D  I $D(REJECT) K REJECT G ITEMTXT
"RTN","GMRC101C",46,0)
 .S GMRCY=Y W !,"** "_Y_" is already being used by "
"RTN","GMRC101C",47,0)
 .S GMRCTXT="" F  S GMRCTXT=$O(^ORD(101,"C",Y,GMRCTXT)) Q:GMRCTXT=""  S TXT=$P($G(^ORD(101,GMRCTXT,0)),"^",1) W:((78-$X)'>$L(TXT)) ! W ?25," "_TXT I TXT?1"GMRCT ".E S REJECT=1
"RTN","GMRC101C",48,0)
 .I $D(REJECT) W !,"This is a duplicate name.  Please re-enter a unique item text." Q
"RTN","GMRC101C",49,0)
 .I '$D(ORDA) S DIR(0)="Y",DIR("A")="Do you really want to add '"_GMRCPFX_GMRCY_"' as a new "_GMRCDESC_" Protocol",DIR("B")="NO" D ^DIR K DIR I Y=0 S REJECT=1
"RTN","GMRC101C",50,0)
 .S Y=GMRCY
"RTN","GMRC101C",51,0)
 .Q
"RTN","GMRC101C",52,0)
 I $D(ORDA),$P(^ORD(101,ORDA,0),"^",1)'=GMRCPFX_Y D ACCESS I $D(GMRC101) W !,"The Protocol name "_$P(^ORD(101,ORDA,0),"^",1),!,"     WILL NOT be changed to match ITEM TEXT due to Package Code dependencies!",!
"RTN","GMRC101C",53,0)
 S ORTXT=Y I '$D(GMRC101) S ORDANM=GMRCPFX_ORTXT
"RTN","GMRC101C",54,0)
 Q
"RTN","GMRC101C",55,0)
SETUP ;Get the Itemtext and service name
"RTN","GMRC101C",56,0)
 Q:'$D(ORDA)  Q:'ORDA
"RTN","GMRC101C",57,0)
 S ITEMTXT=$P(^ORD(101,ORDA,0),"^",2)
"RTN","GMRC101C",58,0)
 S GMRCSS=+$P($G(^ORD(101,ORDA,5)),"^",1),GMRCSS=$P($G(^GMR(123.5,GMRCSS,0)),"^",1)
"RTN","GMRC101C",59,0)
 Q
"RTN","GMRC101C",60,0)
ACCESS ;Check for Protocol Item with GMRC101 security restricting name change of the Protocols .01 field.
"RTN","GMRC101C",61,0)
 Q:'$D(ORDA)
"RTN","GMRC101C",62,0)
 N DIC,X,Y
"RTN","GMRC101C",63,0)
 S DIC=19.1,DIC(0)="FMX",X="GMRC101" D ^DIC Q:(+Y<1)
"RTN","GMRC101C",64,0)
 S:$D(^ORD(101,ORDA,3,"B",+Y)) GMRC101=1
"RTN","GMRC101C",65,0)
 Q
"RTN","GMRC101C",66,0)
BUILD ;Logic to update file 101
"RTN","GMRC101C",67,0)
 S (GMRCPRO,ORDANM)=$TR(ORDANM,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ"),GMRCTXT=$S(GMRCTXT="":ORTXT,1:GMRCTXT),GMRCSV=ORFL,GMRCSS=ORFL
"RTN","GMRC101C",68,0)
 D EN3^GMRCPREF
"RTN","GMRC101C",69,0)
 S DA=$S($G(DA):DA,$G(ORDA):ORDA,1:"") I '$L(DA) W !!,$C(7),GMRCPRO_" Was Not Added To The Protocol Or Orderable Item File!",! Q
"RTN","GMRC101C",70,0)
 S DIE="^ORD(101,",DR=1.1 D ^DIE D
"RTN","GMRC101C",71,0)
 .S ND=0 F I=1:1 S ND=$O(^ORD(101,DA,2,ND)) Q:ND?1A.E!(ND="")  S GMRCSYN(I)=^ORD(101,DA,2,ND,0)
"RTN","GMRC101C",72,0)
 .Q
"RTN","GMRC101C",73,0)
 K DIR D:GMRCTRLC'="MAD"  I $S($D(DTOUT):1,$D(DUOUT):1,$D(DIROUT):1,1:0) D END S GMRCEND=1 Q
"RTN","GMRC101C",74,0)
 .I $S('$L($P(^ORD(101,DA,0),"^",3)):1,+$P(^(0),"^",3)=0:1,1:0) S DIR(0)="Y",DIR("A")="Do You Want To DISABLE This Protocol" D ^DIR K DIR D:Y=1  Q
"RTN","GMRC101C",75,0)
 ..S DR="2////^S X=""1 No Longer Used""" D ^DIE S GMRCTRLC="MDC"
"RTN","GMRC101C",76,0)
 ..Q
"RTN","GMRC101C",77,0)
 .I $L($P(^ORD(101,DA,0),"^",3)),+$P(^(0),"^",3)=1 S DIR(0)="Y",DIR("A")="Do You Want To ACTIVATE This Disabled Protocol" D ^DIR K DIR D:Y=1  Q
"RTN","GMRC101C",78,0)
 ..S DR="2///@" D ^DIE
"RTN","GMRC101C",79,0)
 ..Q
"RTN","GMRC101C",80,0)
 .Q
"RTN","GMRC101C",81,0)
 D EN^GMRC101H(GMRCACT,GMRCTRLC,DA,GMRCTXT,.GMRCSYN,GMRCPFX)
"RTN","GMRC101C",82,0)
 D MSG^XQOR("GMRC ORDERABLE ITEM UPDATE",.GMRCMSG)
"RTN","GMRC101C",83,0)
 I $E(GMRCPRO,1,6)="GMRCR " D
"RTN","GMRC101C",84,0)
 .S GMRCPROI=$O(^ORD(101,"B",GMRCPRO,0)) Q:'GMRCPROI
"RTN","GMRC101C",85,0)
 .D GMRCR^GMRCMU
"RTN","GMRC101C",86,0)
 K DIC,DIE,DIR,DR,ORDA,ORDANM,ORDEF,OREA,ORFL,ORPKG,ORTXT
"RTN","GMRC101C",87,0)
 Q
"RTN","GMRC101C",88,0)
END ;Clean-up logic
"RTN","GMRC101C",89,0)
 K I,GMRC101,GMRCMSG,GMRCPRO,GMRCPROI,GMRCSS,GMRCSYN,GMRCSV,GMRCTRLC,GMRCTXT,GMRCY,ITEMTXT,ND
"RTN","GMRC101C",90,0)
 K ORDA,ORDANM,ORDEF,OREA,ORFL,ORPKG,ORTXT
"RTN","GMRC101C",91,0)
 K DIROUT,DUOUT,DTOUT,TXT,Y
"RTN","GMRC101C",92,0)
 Q
"RTN","GMRCADC")
0^1^B9525436
"RTN","GMRCADC",1,0)
GMRCADC ;SLC/DLT/DCM - Discontinue Action taken from List Manager ;6/17/98  10:22
"RTN","GMRCADC",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCADC",3,0)
EXAC(MSG) ;Exit message asking for user to press <ENTER>; EXAC=Exit Action
"RTN","GMRCADC",4,0)
 N ND
"RTN","GMRCADC",5,0)
 W $C(7),!,MSG I $O(MSG(0)) S ND=0 F  S ND=$O(MSG(ND)) Q:ND=""  W !,MSG(ND)
"RTN","GMRCADC",6,0)
 W !,"Press <RETURN> to continue: " R X:DTIME W !!
"RTN","GMRCADC",7,0)
 Q
"RTN","GMRCADC",8,0)
DC(GMRCO,GMRCA) ;Discontinue a consult logic from DC^GMRCA1
"RTN","GMRCADC",9,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCADC",10,0)
 N GMRCDA,GMRCACTM,GMRCADUZ,GMRCSERV
"RTN","GMRCADC",11,0)
 K GMRCQUT,GMRCQIT
"RTN","GMRCADC",12,0)
 I '+$G(GMRCO) D SELECT^GMRCA2(.GMRCO) I $D(GMRCQUT) Q
"RTN","GMRCADC",13,0)
 I '+$G(GMRCO) S GMRCQUT=1 Q
"RTN","GMRCADC",14,0)
 ;
"RTN","GMRCADC",15,0)
 S GMRC(0)=^GMR(123,GMRCO,0),GMRCDA=GMRCO
"RTN","GMRCADC",16,0)
 S (GMRCDFN,DFN)=$P(GMRC(0),"^",2)
"RTN","GMRCADC",17,0)
 I $D(GMRCA),+GMRCA S GMRCACTM=$S(GMRCA=6:"Discontinued",GMRCA=19:"Cancelled",1:$P($G(GMR(123.1,+GMRCA,0)),"^",1))
"RTN","GMRCADC",18,0)
 ;
"RTN","GMRCADC",19,0)
 D PROC I $D(GMRCQUT) S GMRCQUT=1 Q
"RTN","GMRCADC",20,0)
 ;send 513 back to service printer if request DC'd or Cancelled
"RTN","GMRCADC",21,0)
 I GMRCA=6,+$P(GMRC(0),U,5) D PRNT^GMRCUTL1(+$P(GMRC(0),U,5),+GMRCO)
"RTN","GMRCADC",22,0)
 S GMRCTRLC=$S(GMRCA=19:"OC",1:"OD")
"RTN","GMRCADC",23,0)
 D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCRB),GMRCTRLC,GMRCORNP,$G(GMRCVSIT),.GMRCOM)
"RTN","GMRCADC",24,0)
 Q
"RTN","GMRCADC",25,0)
 ;
"RTN","GMRCADC",26,0)
PROC ;Check validity of action and if valid process the discontinue action
"RTN","GMRCADC",27,0)
 I $P(GMRC(0),"^",12)=1 S GMRCMSG="This consult has already been discontinued!" D EXAC(GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",28,0)
 I $P(GMRC(0),"^",12)=2 S GMRCMSG="This consult has already been completed!" D EXAC(GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",29,0)
 I $P(GMRC(0),"^",12)=9 S GMRCMSG="Action invalid. This consult has partial results!",GMRCMSG(1)="Remove the associated results and then discontinue." D EXAC(.GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",30,0)
 I $P(GMRC(0),"^",12)=13 S GMRCMSG="This consult has already been cancelled!" D EXAC(GMRCMSG) S GMRCQUT=1 Q
"RTN","GMRCADC",31,0)
 ;
"RTN","GMRCADC",32,0)
 S GMRCORVP=GMRCDFN_";DPT("
"RTN","GMRCADC",33,0)
 N GETPROV D GETPROV^GMRCAU I $D(DIROUT)!$D(DTOUT)!$D(DUOUT) S GMRCQUT=1 Q
"RTN","GMRCADC",34,0)
 N GETDT D GETDT^GMRCAU I $D(DIROUT)!$D(DTOUT)!$D(DUOUT) S GMRCQUT=1 Q  ;Returns GMRCAD as the entered date.
"RTN","GMRCADC",35,0)
 S GMRCSTS=$S(GMRCA=6:1,1:13),$P(GMRC(0),"^",12)=GMRCSTS
"RTN","GMRCADC",36,0)
 S GMRCOM=1
"RTN","GMRCADC",37,0)
 D STATUS^GMRCP
"RTN","GMRCADC",38,0)
 D AUDIT^GMRCP
"RTN","GMRCADC",39,0)
 ;
"RTN","GMRCADC",40,0)
 S GMRCORTX=$S($L($G(GMRCACTM)):GMRCACTM,+GMRCA:$P(^GMR(123.1,GMRCA,0),U,1),1:"ACTION UNKNOWN FOR")_" consult "_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCADC",41,0)
 S GMRCADUZ="",GMRCFL=0
"RTN","GMRCADC",42,0)
 I +$P($G(^GMR(123,+GMRCO,0)),"^",14),+$P(^(0),"^",14)'=DUZ S GMRCADUZ($P(^(0),"^",14))=""
"RTN","GMRCADC",43,0)
 I +$P($G(^GMR(123,+GMRCO,0)),"^",14)=DUZ S GMRCFL=1
"RTN","GMRCADC",44,0)
 ;send notification info to routine to be sent to OERR
"RTN","GMRCADC",45,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,$S(GMRCA=6:23,1:30),.GMRCADUZ,GMRCFL)
"RTN","GMRCADC",46,0)
 Q
"RTN","GMRCEDIT")
0^2^B9930865
"RTN","GMRCEDIT",1,0)
GMRCEDIT ;SLC/DCM,JFR - EDIT CANCELLED CONSULT-MAIN DRIVER ;1/3/99 22:10
"RTN","GMRCEDIT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCEDIT",3,0)
EN(XQCON,XQDFN) ; -- main entry point for GMRCEDIT
"RTN","GMRCEDIT",4,0)
 ;XQDFN=XQAID   XQCON=XQADATA from CPRS alerts
"RTN","GMRCEDIT",5,0)
 N GMRCNOTF,GMRCCORY
"RTN","GMRCEDIT",6,0)
 S DFN=$P(XQDFN,",",2),GMRCDA=$S(XQCON=+XQCON:+XQCON,+$P($P(XQCON,",",2),";",2):+$P($P(XQCON,",",2),";",2),XQCON?1N.N1",GMRC".E:+XQCON,1:$P($P(XQCON,";",3),",",1))
"RTN","GMRCEDIT",7,0)
 S GMRCNOTF=+$P(XQDFN,",",3)
"RTN","GMRCEDIT",8,0)
 I '+GMRCDA S XQAKILL=$$XQAKILL^ORB3F1(GMRCNOTF) D DEL^ORB3FUP1(.GMRCCORY,XQDFN),END Q
"RTN","GMRCEDIT",9,0)
 S GMRCDAP=GMRCDA I +$P(^GMR(123,+GMRCDA,0),"^",5)
"RTN","GMRCEDIT",10,0)
 S GMRCOK=$P(^ORD(100.01,$P(^GMR(123,+GMRCDA,0),"^",12),0),"^",1),GMRCOK=$S(GMRCOK["CANCELLED":1,1:0)
"RTN","GMRCEDIT",11,0)
 I '$D(GMRCOK) S XQAKILL=$$XQAKILL^ORB3F1(GMRCNOTF) D DEL^ORB3FUP1(.GMRCCORY,XQDFN),END Q
"RTN","GMRCEDIT",12,0)
 S GMRCPNM=$P(^DPT(DFN,0),"^",1),GMRCPROV=$P(^GMR(123,GMRCDA,0),"^",14) I +GMRCPROV S GMRCPROV=$P(^VA(200,GMRCPROV,0),"^",1)
"RTN","GMRCEDIT",13,0)
 D EN^VALM("GMRC EDIT CONSULT")  ;********* CALL TO LIST MANAGER
"RTN","GMRCEDIT",14,0)
 I $S($O(GMRCED(0)):1,$D(^TMP("GMRCED",$J)):1,1:0),'$D(GMRCRSUB) D
"RTN","GMRCEDIT",15,0)
 . N DIR,DTOUT,DUOUT,X,Y
"RTN","GMRCEDIT",16,0)
 . W !,$C(7),"This Consult Has Not Been Resubmitted!!"
"RTN","GMRCEDIT",17,0)
 . W !,"Resubmit Or All Edits Will Be Lost!!",!!
"RTN","GMRCEDIT",18,0)
 . S DIR(0)="Y",DIR("A")="Do you wish to resubmit now? ",DIR("B")="YES"
"RTN","GMRCEDIT",19,0)
 . D ^DIR I $D(DUOUT)!($D(DTOUT))!(Y<1) W !!,"No changes made!" Q
"RTN","GMRCEDIT",20,0)
 . D EN^GMRCEDT2(GMRCDAP)
"RTN","GMRCEDIT",21,0)
 . Q
"RTN","GMRCEDIT",22,0)
 S XQAKILL=$$XQAKILL^ORB3F1(GMRCNOTF) D DEL^ORB3FUP1(.GMRCCORY,XQDFN)
"RTN","GMRCEDIT",23,0)
 D END
"RTN","GMRCEDIT",24,0)
 Q
"RTN","GMRCEDIT",25,0)
 ;
"RTN","GMRCEDIT",26,0)
HDR ; -- header code
"RTN","GMRCEDIT",27,0)
 S VALMHDR(1)="Edit Consult for Patient "_GMRCPNM_"  Consult Number: "_GMRCDA
"RTN","GMRCEDIT",28,0)
 S VALMHDR(2)="Sending Provider: "_GMRCPROV
"RTN","GMRCEDIT",29,0)
 Q
"RTN","GMRCEDIT",30,0)
 ;
"RTN","GMRCEDIT",31,0)
INIT ; -- init variables and list array
"RTN","GMRCEDIT",32,0)
 K ^TMP("GMRCR",$J,"EDLIST")
"RTN","GMRCEDIT",33,0)
 S DSPLINE=0,DATA="",VALMAR="^TMP(""GMRCR"",$J,""EDLIST"")"
"RTN","GMRCEDIT",34,0)
 F LINE=1:1:GMRCLNO S DSPLINE=$O(^TMP("GMRCR",$J,"ED",DSPLINE)) Q:DSPLINE=""!(DSPLINE?1A.E)  S DATA=^(DSPLINE,0) D SET^VALM10(LINE,DATA)
"RTN","GMRCEDIT",35,0)
 S VALMCNT=GMRCLNO,VALMPGE=1,XQORM("A")="Select Action: "
"RTN","GMRCEDIT",36,0)
 K DSPLINE,DATA,LINE
"RTN","GMRCEDIT",37,0)
 Q
"RTN","GMRCEDIT",38,0)
 ;
"RTN","GMRCEDIT",39,0)
HELP ; -- help code
"RTN","GMRCEDIT",40,0)
 S X="?" D DISP^XQORM1 W !!
"RTN","GMRCEDIT",41,0)
 Q
"RTN","GMRCEDIT",42,0)
 ;
"RTN","GMRCEDIT",43,0)
EXIT ;
"RTN","GMRCEDIT",44,0)
 ;Don't kill anything here
"RTN","GMRCEDIT",45,0)
 Q
"RTN","GMRCEDIT",46,0)
END ; -- exit code
"RTN","GMRCEDIT",47,0)
 K ^TMP("GMRCR",$J,"EDLIST"),^TMP("GMRCR",$J,"ED")
"RTN","GMRCEDIT",48,0)
 K ^TMP("GMRCED",$J),^TMP("GMRCSUB",$J),^TMP("GMRCFLD20",$J)
"RTN","GMRCEDIT",49,0)
 K CMDA,DFN,DIC,DIE,DR,DA,FLDA,FLDNM,GMRCA,GMRCATN,GMRCD,GMRCDD,GMRCANS,GMRCDIAG,GMRCED,GMRCEDCM,GMRCIND,GMRCINO,GMRCKEEP,GMRCLNO,GMRCND,GMRCND1,GMRCO,GMRCOK,GMRCPC,GMRCPL,GMRCPR,GMRCPNM,GMRCPROC,GMRCPROV,GMRCREQ,GMRCRQT
"RTN","GMRCEDIT",50,0)
 K GMRCFLD,GMRCOUNT,GMRCRSUB,GMRCSS,GMRCURG,GMRCDA,GMRCDAP,GMRCDA1,ND,TRKDA,XQAKILL
"RTN","GMRCEDIT",51,0)
 Q
"RTN","GMRCEDIT",52,0)
 ;
"RTN","GMRCEDIT",53,0)
EXPND ; -- expand code
"RTN","GMRCEDIT",54,0)
 Q
"RTN","GMRCEDIT",55,0)
 ;
"RTN","GMRCEDT1")
0^3^B31800007
"RTN","GMRCEDT1",1,0)
GMRCEDT1 ;SLC/DCM,JFR - EDIT A CONSULT AND RE-SEND AS NEW ;1/3/99 23:19
"RTN","GMRCEDT1",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCEDT1",3,0)
EN(GMRCO) ;GMRCO=IEN of consult from file 123
"RTN","GMRCEDT1",4,0)
 ;GMRCSS=To Service   GMRCPROC=Procedure Request Type
"RTN","GMRCEDT1",5,0)
 ;GMRCURG=Urgency     GMRCPL=Place Of Consultation
"RTN","GMRCEDT1",6,0)
 ;GMRCATN=Attention   GMRCINO=Service is In/Out Patient
"RTN","GMRCEDT1",7,0)
 ;GMRCPNM=Patient Name  GMRCDIAG=Provisional Diagnosis
"RTN","GMRCEDT1",8,0)
 N GMRCSS,GMRCPROC,GMRCURG,GMRCPL,GMRCATN,GMRCINO,GMRCDIAG,LN
"RTN","GMRCEDT1",9,0)
 K ^TMP("GMRCR",$J,"ED") S GMRCLNO=1
"RTN","GMRCEDT1",10,0)
 I $L($P(^GMR(123,+GMRCO,0),"^",12)) S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  CURRENT STATUS: (Not Editable): "_$P(^ORD(100.01,$P(^(0),"^",12),0),"^",1),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",11,0)
 S GMRCD=0 F  S GMRCD=$O(^GMR(123,+GMRCO,40,"B",GMRCD)) Q:'GMRCD  S GMRCDD="" F  S GMRCDD=$O(^GMR(123,GMRCO,40,"B",GMRCD,GMRCDD)) Q:'GMRCDD  D
"RTN","GMRCEDT1",12,0)
 .I $P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",2)=19 S LN=0 D
"RTN","GMRCEDT1",13,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  CANCELLED BY (Not Editable): "_$P(^VA(200,$P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",5),0),"^",1),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",14,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  CANCELLED COMMENT (Not Editable):",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",15,0)
 ..S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  I $L(^GMR(123,+GMRCO,40,GMRCDD,1,LN,0))>75 S FLG=1 D WPSET^GMRCUTIL("^GMR(123,+GMRCO,40,GMRCDD,1)","^TMP(""GMRCR"",$J,""ED"")","",.GMRCLNO,"",FLG)
"RTN","GMRCEDT1",16,0)
 ..I '$D(FLG) S LN=0 F  S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^(LN,0),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",17,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",$P(^(0),"-",79)="",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",18,0)
 ..Q
"RTN","GMRCEDT1",19,0)
 .Q
"RTN","GMRCEDT1",20,0)
 S GMRCSS=$S($D(GMRCEDT(1)):GMRCEDT(1),1:$P(^GMR(123,+GMRCO,0),"^",5)_U_$P(^GMR(123.5,$P(^GMR(123,+GMRCO,0),"^",5),0),U))
"RTN","GMRCEDT1",21,0)
 S GMRCPROC=$S($D(GMRCED(1)):GMRCED(1),1:$P(^GMR(123,+GMRCO,0),"^",8)_U_$$GET1^DIQ(101,+$P(^GMR(123,+GMRCO,0),"^",8),1))
"RTN","GMRCEDT1",22,0)
 S GMRCURG=$S($D(GMRCED(3)):GMRCED(3),1:$P(^GMR(123,+GMRCO,0),"^",9)_U_$$GET1^DIQ(101,+$P(^(0),"^",9),1))
"RTN","GMRCEDT1",23,0)
 S GMRCPL=$S($D(GMRCED(4)):GMRCED(4),1:$P(^GMR(123,+GMRCO,0),"^",10)_U_$$GET1^DIQ(101,+$P(^(0),U,10),1))
"RTN","GMRCEDT1",24,0)
 S GMRCATN=$S($D(GMRCED(5)):GMRCED(5),1:$P(^GMR(123,+GMRCO,0),"^",11)_U_$$GET1^DIQ(200,+$P(^(0),U,11),.01))
"RTN","GMRCEDT1",25,0)
 S GMRCDIAG=$S($D(GMRCED(6)):GMRCED(6),1:$G(^GMR(123,+GMRCO,30)))
"RTN","GMRCEDT1",26,0)
 I $D(GMRCED(2)) S GMRCINO=GMRCED(2)
"RTN","GMRCEDT1",27,0)
 I '$D(GMRCINO) S GMRCINO=$P(^GMR(123,+GMRCO,0),U,18)_U_$S($P(^(0),U,18)="I":"Inpatient",1:"Outpatient")
"RTN","GMRCEDT1",28,0)
 S GMRCREQ=$$GET1^DIQ(101,+$P(^GMR(123,+GMRCO,0),U,17),1)
"RTN","GMRCEDT1",29,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="SENDING PROVIDER (Not Editable): "_$$GET1^DIQ(200,+$P(^GMR(123,+GMRCO,0),"^",14),.01),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",30,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="REQUEST TYPE (Not Editable): "_GMRCREQ,GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",31,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=$$REPEAT^XLFSTR("-",79),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",32,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  TO SERVICE (Not Editable): "_$P(GMRCSS,U,2) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",33,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=" ",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",34,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="1 PROCEDURE: "_$P(GMRCPROC,U,2)
"RTN","GMRCEDT1",35,0)
 D:+GMRCPROC RVRS(GMRCLNO,$D(GMRCED(1))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",36,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="2 Performed as INPT OR OUTPT: "_$P(GMRCINO,U,2) D RVRS(GMRCLNO,$D(GMRCED(2))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",37,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="3 URGENCY: "_$P(GMRCURG,U,2) D RVRS(GMRCLNO,$D(GMRCED(3))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",38,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="4 PLACE OF CONSULTATION: "_$P(GMRCPL,U,2) D RVRS(GMRCLNO,$D(GMRCED(4))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",39,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="5 ATTENTION (CONSULTANT): "_$P(GMRCATN,U,2) D RVRS(GMRCLNO,$D(GMRCED(5))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",40,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="6 PROVISIONAL DIAGNOSIS: "_GMRCDIAG D RVRS(GMRCLNO,$D(GMRCED(6))) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",41,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="7 REASON FOR REQUEST:" D RVRS(GMRCLNO,$D(^TMP("GMRCED",$J,20))) S GMRCLNO=GMRCLNO+1 D
"RTN","GMRCEDT1",42,0)
 . I $D(^TMP("GMRCED",$J,20)) D  Q
"RTN","GMRCEDT1",43,0)
 .. N ND S ND=0
"RTN","GMRCEDT1",44,0)
 .. F  S ND=$O(^TMP("GMRCED",$J,20,ND)) Q:'ND  D
"RTN","GMRCEDT1",45,0)
 ... D KILL^VALM10(GMRCLNO)
"RTN","GMRCEDT1",46,0)
 ... S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCED",$J,20,ND,0)
"RTN","GMRCEDT1",47,0)
 ... S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",48,0)
 . N ND S ND=0
"RTN","GMRCEDT1",49,0)
 . F  S ND=$O(^GMR(123,+GMRCO,20,ND)) Q:ND=""  D
"RTN","GMRCEDT1",50,0)
 .. S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^GMR(123,+GMRCO,20,ND,0)
"RTN","GMRCEDT1",51,0)
 .. S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",52,0)
 .Q
"RTN","GMRCEDT1",53,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",GMRCLNO=GMRCLNO+1,^TMP("GMRCR",$J,"ED",GMRCLNO,0)="8 COMMENT(S): (Add Only)" D RVRS(GMRCLNO) S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",54,0)
 I $D(^TMP("GMRCED",$J,40)) D
"RTN","GMRCEDT1",55,0)
 . D KILL^VALM10(GMRCLNO)
"RTN","GMRCEDT1",56,0)
 . S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="  New Comment:",GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",57,0)
 . N ND S ND=0 F  S ND=$O(^TMP("GMRCED",$J,40,ND)) Q:'ND  D
"RTN","GMRCEDT1",58,0)
 .. S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCED",$J,40,ND,0)
"RTN","GMRCEDT1",59,0)
 .. S GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",60,0)
 N GMRCEDCT
"RTN","GMRCEDT1",61,0)
 S GMRCD=0,GMRCEDCT=0 F  S GMRCD=$O(^GMR(123,+GMRCO,40,"B",GMRCD)) Q:'GMRCD  S GMRCDD="",GMRCDD=$O(^GMR(123,+GMRCO,40,"B",GMRCD,GMRCDD)) Q:'GMRCDD  D
"RTN","GMRCEDT1",62,0)
 .I $P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",2)=20 S LN=0,GMRCEDCT=GMRCEDCT+1,GMRCEDCM(GMRCEDCT)=GMRCDD D
"RTN","GMRCEDT1",63,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)="",GMRCLNO=GMRCLNO+1,^TMP("GMRCR",$J,"ED",GMRCLNO,0)="ADDED COMMENT (Not Editable) Entered: "_$P($$FMTE^XLFDT($P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",1)),"@",1)
"RTN","GMRCEDT1",64,0)
 ..S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^TMP("GMRCR",$J,"ED",GMRCLNO,0)_" BY: "_$S($L($P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",4)):$P(^VA(200,$P(^GMR(123,+GMRCO,40,GMRCDD,0),"^",4),0),"^",1),1:"UNKNOWN"),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",65,0)
 ..S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  I $L(^GMR(123,+GMRCO,40,GMRCDD,1,LN,0))>75 S FLG=1 D WPSET^GMRCUTIL("^GMR(123,+GMRCO,40,GMRCDD,1)","^TMP(""GMRCR"",$J,""ED"")","",.GMRCLNO,"",FLG) Q
"RTN","GMRCEDT1",66,0)
 ..S LN=0 F  S LN=$O(^GMR(123,+GMRCO,40,GMRCDD,1,LN)) Q:LN=""!(LN?1A.E)  S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=^(LN,0),GMRCLNO=GMRCLNO+1
"RTN","GMRCEDT1",67,0)
 ..Q
"RTN","GMRCEDT1",68,0)
 .Q
"RTN","GMRCEDT1",69,0)
 S ^TMP("GMRCR",$J,"ED",GMRCLNO,0)=""
"RTN","GMRCEDT1",70,0)
 K FLG
"RTN","GMRCEDT1",71,0)
 Q
"RTN","GMRCEDT1",72,0)
RVRS(LINE,EDITED) ;reverse video for fields that can be edited
"RTN","GMRCEDT1",73,0)
 I '$G(EDITED) D CNTRL^VALM10(LINE,1,1,IORVON,IORVOFF) Q
"RTN","GMRCEDT1",74,0)
 D CNTRL^VALM10(LINE,1,1,IORVON_IOINHI,IORVOFF_IOINORM)
"RTN","GMRCEDT1",75,0)
 Q
"RTN","GMRCEDT2")
0^4^B9031407
"RTN","GMRCEDT2",1,0)
GMRCEDT2 ;SLC/JFR,DCM - RESUBMIT A CANCELLED CONSULT ;1/4/99 00:27
"RTN","GMRCEDT2",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCEDT2",3,0)
EN(GMRCO,COMNO) ;entry point into the routine
"RTN","GMRCEDT2",4,0)
 ;COMNO=CMDA from ^GMRCEDT2=comments array IEN from ^GMR(123,IEN,40,
"RTN","GMRCEDT2",5,0)
 ;GMRCO=IEN of the consult from file 123
"RTN","GMRCEDT2",6,0)
 I $S($P(^GMR(123,GMRCO,0),"^",12)'=13:1,$D(GMRCRSUB):1,1:0) D  S:'$D(GMRCRSUB) GMRCRSUB=1 Q
"RTN","GMRCEDT2",7,0)
 .S GMRCMSG="***     Consult Has Already Been Resubmitted   ***",GMRCMSG(1)="***  No Further Action Is Required Or Allowed ***" D EXAC^GMRCADC(.GMRCMSG)
"RTN","GMRCEDT2",8,0)
 .Q
"RTN","GMRCEDT2",9,0)
 I '$D(GMRCGUIF) W !,"Resubmitting Consult ... One moment please ..."
"RTN","GMRCEDT2",10,0)
 K ^TMP("GMRCSUB",$J) S ^TMP("GMRCSUB",$J)=0
"RTN","GMRCEDT2",11,0)
 I $D(GMRCEDT(1)) S ^TMP("GMRCSUB",$J,1)="GMRCSS^"_+GMRCEDT(1)
"RTN","GMRCEDT2",12,0)
 I $D(GMRCED(1)) D
"RTN","GMRCEDT2",13,0)
 . I $P(GMRCED(1),U)=$P(^GMR(123,+GMRCO,0),U,8) K GMRCED(1) Q
"RTN","GMRCEDT2",14,0)
 . S ^TMP("GMRCSUB",$J,2)="GMRCPROC^"_+GMRCED(1)_";ORD(101,"
"RTN","GMRCEDT2",15,0)
 I $D(GMRCED(2)) D
"RTN","GMRCEDT2",16,0)
 . I $P(GMRCED(2),U)=$P(^GMR(123,+GMRCO,0),U,18) K GMRCED(2) Q
"RTN","GMRCEDT2",17,0)
 . S ^TMP("GMRCSUB",$J,3)="GMRCION^"_$P(GMRCED(2),U)
"RTN","GMRCEDT2",18,0)
 I $D(GMRCED(3)) D
"RTN","GMRCEDT2",19,0)
 . I $P(GMRCED(3),U)=$P(^GMR(123,+GMRCO,0),U,9) K GMRCED(3) Q
"RTN","GMRCEDT2",20,0)
 . S ^TMP("GMRCSUB",$J,4)="GMRCURG^"_$P(GMRCED(3),U)
"RTN","GMRCEDT2",21,0)
 I $D(GMRCED(4)) D
"RTN","GMRCEDT2",22,0)
 . I $P(GMRCED(4),U)=$P(^GMR(123,+GMRCO,0),U,10) K GMRCED(4) Q
"RTN","GMRCEDT2",23,0)
 . S ^TMP("GMRCSUB",$J,5)="GMRCPL^"_$P(GMRCED(4),U)
"RTN","GMRCEDT2",24,0)
 I $D(GMRCED(5)) D
"RTN","GMRCEDT2",25,0)
 . I $P(GMRCED(5),U)=$P(^GMR(123,+GMRCO,0),U,11) K GMRCED(5) Q
"RTN","GMRCEDT2",26,0)
 . I '$L($P(GMRCED(5),U)) S $P(GMRCED(5),U)="@"
"RTN","GMRCEDT2",27,0)
 . S ^TMP("GMRCSUB",$J,6)="GMRCATN^"_$P(GMRCED(5),U)
"RTN","GMRCEDT2",28,0)
 I $D(GMRCED(6)) D
"RTN","GMRCEDT2",29,0)
 . I GMRCED(6)=$G(^GMR(123,+GMRCO,30)) K GMRCED(6) Q
"RTN","GMRCEDT2",30,0)
 . I '$L($P(GMRCED(6),U)) S $P(GMRCED(6),U)="@"
"RTN","GMRCEDT2",31,0)
 . S ^TMP("GMRCSUB",$J,7)="GMRCDIAG^"_GMRCED(6)
"RTN","GMRCEDT2",32,0)
 I $D(^TMP("GMRCED",$J,20)) S ^TMP("GMRCSUB",$J,20)="GMRCRFQ^" D
"RTN","GMRCEDT2",33,0)
 . N ND S ND=0
"RTN","GMRCEDT2",34,0)
 . F  S ND=$O(^TMP("GMRCED",$J,20,ND)) Q:'ND  D
"RTN","GMRCEDT2",35,0)
 .. S ^TMP("GMRCSUB",$J,20,ND)=^TMP("GMRCED",$J,20,ND,0)
"RTN","GMRCEDT2",36,0)
 I $D(^TMP("GMRCED",$J,40)) S ^TMP("GMRCSUB",$J,40)="COMMENT^" D
"RTN","GMRCEDT2",37,0)
 . N ND S ND=0
"RTN","GMRCEDT2",38,0)
 . F  S ND=$O(^TMP("GMRCED",$J,40,ND)) Q:'ND  D
"RTN","GMRCEDT2",39,0)
 .. S ^TMP("GMRCSUB",$J,40,ND)=^TMP("GMRCED",$J,40,ND,0)
"RTN","GMRCEDT2",40,0)
 D FILE^GMRCGUIC(+GMRCO,$NAME(^TMP("GMRCSUB",$J)),1)
"RTN","GMRCEDT2",41,0)
 N GMRCADUZ S GMRCADUZ=""
"RTN","GMRCEDT2",42,0)
 S DFN=$P(^GMR(123,+GMRCO,0),"^",2),GMRCPROV=$P(^(0),"^",14),GMRCTYPE=$P(^(0),"^",17),GMRCTRLC="XX",VISIT="",RMBED=""
"RTN","GMRCEDT2",43,0)
 S DIE="^GMR(123,",DA=+GMRCO,DR="8////^S X=5;9////^S X=11" D ^DIE K DIE,DA,DR
"RTN","GMRCEDT2",44,0)
 S GMRCRSUB=1
"RTN","GMRCEDT2",45,0)
 S GMRCURG=$P(^GMR(123,+GMRCO,0),"^",9)
"RTN","GMRCEDT2",46,0)
 I +$P(^GMR(123,+GMRCO,0),"^",11) S GMRCADUZ($P(^(0),"^",11))=""
"RTN","GMRCEDT2",47,0)
 S GMRCSVC=$P(^GMR(123,+GMRCO,0),"^",5)
"RTN","GMRCEDT2",48,0)
 I +GMRCSVC D
"RTN","GMRCEDT2",49,0)
 . D EN^GMRCT(GMRCSVC)
"RTN","GMRCEDT2",50,0)
 S GMRCORTX="Resubmitted consult "_$$ORTX^GMRCAU(+GMRCO)_$S(+GMRCURG:" ("_$P(^ORD(101,+GMRCURG,0),"^",2)_")",1:"")
"RTN","GMRCEDT2",51,0)
 K GMRCFL,GMRCPROV,GMRCTYPE,GMRCTRLC,VISIT,RMBED,GMRCOM,GMRCURG,GMRCSVC,GMRCORTX
"RTN","GMRCEDT2",52,0)
 Q
"RTN","GMRCEDT3")
0^5^B13304726
"RTN","GMRCEDT3",1,0)
GMRCEDT3 ;SLC/DCM,JFR - For a Cancelled Consult - File edited data for tracking consult ;12/31/98 07:11
"RTN","GMRCEDT3",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCEDT3",3,0)
EN(GMRCDA) ;File tracking Data from array
"RTN","GMRCEDT3",4,0)
 W:'$D(GMRCGUIF) !,"Filing Tracking Data..."
"RTN","GMRCEDT3",5,0)
 N GMRCOUNT
"RTN","GMRCEDT3",6,0)
 S GMRCDT=$$NOW^XLFDT
"RTN","GMRCEDT3",7,0)
 S DIE="^GMR(123,",DA=GMRCDA,DR="8////^S X=5" D ^DIE K DIE,DA,DR
"RTN","GMRCEDT3",8,0)
 I '$D(^GMR(123,GMRCDA,40,0)) S ^GMR(123,GMRCDA,40,0)="123.02^^"
"RTN","GMRCEDT3",9,0)
 S DA=$S(+$P(^GMR(123,GMRCDA,40,0),"^",3):$P(^(0),"^",3)+1,1:1),$P(^(0),"^",3,4)=DA_"^"_DA D
"RTN","GMRCEDT3",10,0)
 .S ^GMR(123,GMRCDA,40,DA,0)=GMRCDT_"^"_$O(^GMR(123.1,"B","EDIT/RESUBMITTED",0))_"^"_GMRCDT_"^"_DUZ_"^"_DUZ D
"RTN","GMRCEDT3",11,0)
 .S ^GMR(123,GMRCDA,40,DA,1,0)="^^^^"_GMRCDT_"^" D
"RTN","GMRCEDT3",12,0)
 ..S GMRCOUNT=1,GMRCND=0,^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=$$REPEAT^XLFSTR("-",21)_" PREVIOUS VALUES OF EDITED FIELDS  "_$$REPEAT^XLFSTR("-",21),GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",13,0)
 ..I '$D(GMRCFLD) S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="No Fields Were Edited Before Resubmission",GMRCOUNT=GMRCOUNT+1 Q
"RTN","GMRCEDT3",14,0)
 ..F  S GMRCND=$O(GMRCFLD(GMRCND)) Q:GMRCND=""  D  S GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",15,0)
 ...I GMRCND=.1 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="DISPLAY TEXT OF ITEM ORDERED: "_$P(GMRCFLD(GMRCND),"^",1),GMRCOUNT=GMRCOUNT+1 Q
"RTN","GMRCEDT3",16,0)
 ...I GMRCND=1 D  S GMRCOUNT=GMRCOUNT+1 Q
"RTN","GMRCEDT3",17,0)
 ....S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="To Service: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value")
"RTN","GMRCEDT3",18,0)
 ....Q
"RTN","GMRCEDT3",19,0)
 ...I GMRCND=4 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Procedure: "_$$GET1^DIQ(101,+GMRCFLD(4),1) Q
"RTN","GMRCEDT3",20,0)
 ...I GMRCND=14 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Performed as Inpt or Outpt: "_$S($L($P(GMRCFLD(GMRCND),"^")):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q
"RTN","GMRCEDT3",21,0)
 ...I $S(GMRCND=5:1,GMRCND=6:1,GMRCND=13:1,1:0) D  Q
"RTN","GMRCEDT3",22,0)
 ....N CAPTION S CAPTION=$S(GMRCND=5:"Urgency: ",GMRCND=6:"Place of Consultation: ",1:"Type of Request: ")
"RTN","GMRCEDT3",23,0)
 ....S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=CAPTION_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value")
"RTN","GMRCEDT3",24,0)
 ...I GMRCND=7 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Attention: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q
"RTN","GMRCEDT3",25,0)
 ...I GMRCND=20 N GMRCND1 S GMRCND1=0,GMRCOUNT=GMRCOUNT+1 D  Q
"RTN","GMRCEDT3",26,0)
 ....S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Reason for Request: "
"RTN","GMRCEDT3",27,0)
 ....S GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",28,0)
 ....F  S GMRCND1=$O(@GMRCFLD(20)@(GMRCND1)) Q:GMRCND1=""  S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=@GMRCFLD(20)@(GMRCND1,0),GMRCOUNT=GMRCOUNT+1
"RTN","GMRCEDT3",29,0)
 ...I GMRCND=30 S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)="Provisional Diagnosis: "_$S($L($P(GMRCFLD(GMRCND),U)):$P(GMRCFLD(GMRCND),U),1:"No Previous Value") Q 
"RTN","GMRCEDT3",30,0)
 ...I GMRCND=40 S ^GMR(123,+GMRCDA,40,DA,1,GMRCOUNT,0)=$P(GMRCFLD(GMRCND),"^",1) Q
"RTN","GMRCEDT3",31,0)
 ...Q
"RTN","GMRCEDT3",32,0)
 ..Q
"RTN","GMRCEDT3",33,0)
 .S ^GMR(123,GMRCDA,40,DA,1,GMRCOUNT,0)=$$REPEAT^XLFSTR("-",75),GMRCOUNT=GMRCOUNT-1,^GMR(123,+GMRCDA,40,"B",GMRCDT,DA)=""
"RTN","GMRCEDT3",34,0)
 .S $P(^GMR(123,GMRCDA,40,DA,1,0),"^",3)=GMRCOUNT-1,$P(^(0),"^",4)=GMRCOUNT-1,^GMR(123,+GMRCDA,40,"B",GMRCDT,DA)=""
"RTN","GMRCEDT3",35,0)
 .Q
"RTN","GMRCEDT3",36,0)
 K GMRCIND,GMRCND
"RTN","GMRCEDT3",37,0)
 Q
"RTN","GMRCEDT4")
0^6^B67546845
"RTN","GMRCEDT4",1,0)
GMRCEDT4 ;SLC/DCM,JFR - UTILITIES FOR EDITING FIELDS ;1/3/99 23:12
"RTN","GMRCEDT4",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCEDT4",3,0)
ADDCM(GMRCO)    ;set up to add comment when none exists or to add a new comment
"RTN","GMRCEDT4",4,0)
 ;returns DA for the entry it sets up
"RTN","GMRCEDT4",5,0)
 N X
"RTN","GMRCEDT4",6,0)
 S:'$D(^GMR(123,+GMRCO,40,0)) ^(0)="^123.02DA^^" S X=$S($P(^GMR(123,GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1),$P(^GMR(123,GMRCO,40,0),"^",3,4)=X_"^"_X
"RTN","GMRCEDT4",7,0)
 Q X
"RTN","GMRCEDT4",8,0)
AUDIT0(DA,GMRCDA)       ;Add the necessary tracking information to word processing fields
"RTN","GMRCEDT4",9,0)
 N DIE
"RTN","GMRCEDT4",10,0)
 S DIE="^GMR(123,"_GMRCDA_",40,",DA(1)=GMRCDA,DR=".01////^S X=DT;1////^S X=GMRCA;2////^S X=DT;3////^S X=DUZ;4////^S X=DUZ"
"RTN","GMRCEDT4",11,0)
 D ^DIE
"RTN","GMRCEDT4",12,0)
 S @(DIE_"""B"","_DT_","_DA_")")=""
"RTN","GMRCEDT4",13,0)
 Q
"RTN","GMRCEDT4",14,0)
EDITFLD(GMRCO)    ;edit field in file 123.
"RTN","GMRCEDT4",15,0)
 ;GMRCO=IEN of consult record in file 123
"RTN","GMRCEDT4",16,0)
 N DIR,X,Y,GMRCSS,GMRCPROC,GMRCPROC,GMRCURG,GMRCPL,GMRCREND,GMRCY,GMRCX
"RTN","GMRCEDT4",17,0)
 N GMRCMSG,GMRCTAG
"RTN","GMRCEDT4",18,0)
 I $S($P(^GMR(123,GMRCO,0),"^",12)'=13:1,$D(GMRCRSUB):1,1:0) D  Q
"RTN","GMRCEDT4",19,0)
 .S GMRCMSG="This consult is no longer editable." D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCEDT4",20,0)
 S DIR(0)="LAO^1:8",DIR("A")="Select the fields to edit: "
"RTN","GMRCEDT4",21,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCEDT4",22,0)
 I $P(Y,",")<1 Q
"RTN","GMRCEDT4",23,0)
 S GMRCY=Y
"RTN","GMRCEDT4",24,0)
 F GMRCX=1:1:8 S GMRCTAG=$P(GMRCY,",",GMRCX) Q:'GMRCTAG  D
"RTN","GMRCEDT4",25,0)
 . D SETUP
"RTN","GMRCEDT4",26,0)
 . D @GMRCTAG
"RTN","GMRCEDT4",27,0)
 . K DIROUT,DIRUT,DTOUT,DUOUT
"RTN","GMRCEDT4",28,0)
 . D EN^GMRCEDT1(+GMRCO),INIT^GMRCEDIT
"RTN","GMRCEDT4",29,0)
 Q
"RTN","GMRCEDT4",30,0)
SETUP   ;get info needed for edit (save global reads)
"RTN","GMRCEDT4",31,0)
 S:$D(GMRCEDT(1)) GMRCSS=GMRCEDT(1)
"RTN","GMRCEDT4",32,0)
 I '$D(GMRCSS) S GMRCSS=$P(^GMR(123,+GMRCO,0),U,5),GMRCSS=GMRCSS_U_$P(^GMR(123.5,GMRCSS,0),U)
"RTN","GMRCEDT4",33,0)
 S:$D(GMRCED(1)) GMRCPROC=GMRCED(1)
"RTN","GMRCEDT4",34,0)
 I '$D(GMRCPROC) S GMRCPROC=+$P(^GMR(123,+GMRCO,0),U,8),GMRCPROC=GMRCPROC_U_$$GET1^DIQ(101,+GMRCPROC,1)
"RTN","GMRCEDT4",35,0)
 S:$D(GMRCED(2)) GMRCREND=GMRCED(2)
"RTN","GMRCEDT4",36,0)
 I '$D(GMRCREND) S GMRCREND=$P(^GMR(123,GMRCO,0),U,18),GMRCREND=GMRCREND_U_$S(GMRCREND="I":"In",1:"Out")_"patient"
"RTN","GMRCEDT4",37,0)
 S:$D(GMRCED(3)) GMRCURG=GMRCED(3)
"RTN","GMRCEDT4",38,0)
 I '$D(GMRCURG) S GMRCURG=$P(^GMR(123,+GMRCO,0),U,9),GMRCURG=GMRCURG_U_$$GET1^DIQ(101,+GMRCURG,1)
"RTN","GMRCEDT4",39,0)
 S:$D(GMRCED(4)) GMRCPL=GMRCED(4)
"RTN","GMRCEDT4",40,0)
 I '$D(GMRCPL) S GMRCPL=$P(^GMR(123,+GMRCO,0),U,10),GMRCPL=GMRCPL_U_$$GET1^DIQ(101,+GMRCPL,1)
"RTN","GMRCEDT4",41,0)
 Q
"RTN","GMRCEDT4",42,0)
01       ;edit TO SERVICE
"RTN","GMRCEDT4",43,0)
 N I,PROCSERV,DIR,X,Y
"RTN","GMRCEDT4",44,0)
 I $G(GMRCPROC) D  Q:'PROCSERV
"RTN","GMRCEDT4",45,0)
 . N I S I=0,PROCSERV=0 F  S I=$O(^GMR(123.5,"APR",+GMRCPROC,I)) Q:'I  D
"RTN","GMRCEDT4",46,0)
 .. S PROCSERV(I)="",PROCSERV=PROCSERV+1
"RTN","GMRCEDT4",47,0)
 . I PROCSERV=1 W !,"Only one SERVICE can perform this procedure.",!
"RTN","GMRCEDT4",48,0)
 S DIR(0)="PA^123.5:EMQ"
"RTN","GMRCEDT4",49,0)
 I $G(PROCSERV) D
"RTN","GMRCEDT4",50,0)
 . I $D(PROCSERV(+GMRCSS)) Q
"RTN","GMRCEDT4",51,0)
 . S DIR("B")=$$GET1^DIQ(123.5,$O(PROCSERV(0)),.01)
"RTN","GMRCEDT4",52,0)
 I '$D(DIR("B")) S DIR("B")=$P(GMRCSS,U,2)
"RTN","GMRCEDT4",53,0)
 S DIR("A")="Select the Service to perform this request: "
"RTN","GMRCEDT4",54,0)
 S DIR("S")="I $P(^(0),U,2)<1"
"RTN","GMRCEDT4",55,0)
 I +$G(GMRCPROC) S DIR("S")=DIR("S")_",$D(PROCSERV(+Y))"
"RTN","GMRCEDT4",56,0)
 S DIR("??")="^D LISTALL^GMRCASV"
"RTN","GMRCEDT4",57,0)
 D ^DIR I $D(DUOUT)!($D(DTOUT)) Q
"RTN","GMRCEDT4",58,0)
 I Y<1!(+Y=+GMRCSS) W !,$$NOCHG,! Q
"RTN","GMRCEDT4",59,0)
 S GMRCEDT(1)=Y,GMRCSS=Y
"RTN","GMRCEDT4",60,0)
 Q
"RTN","GMRCEDT4",61,0)
1 ;edit Procedure
"RTN","GMRCEDT4",62,0)
 I $$GET1^DIQ(101,+$P(^GMR(123,+GMRCO,0),U,17),.01)["CONS" D  Q
"RTN","GMRCEDT4",63,0)
 . W !,"Procedures may only be selected for Procedure requests.",!
"RTN","GMRCEDT4",64,0)
 . H 2
"RTN","GMRCEDT4",65,0)
 N DIC,PROCED,X,Y
"RTN","GMRCEDT4",66,0)
 S DIC=101.43,DIC(0)="AEQZ",D="S.PROC",DIC("B")=$P(GMRCPROC,U,2)
"RTN","GMRCEDT4",67,0)
 S DIC("A")="Select Procedure: "
"RTN","GMRCEDT4",68,0)
 S DIC("S")="I $D(^GMR(123.5,""APR"",+$P(^(0),U,2),+GMRCSS))"
"RTN","GMRCEDT4",69,0)
 D IX^DIC
"RTN","GMRCEDT4",70,0)
 I $D(DUOUT)!($D(DTOUT)) Q
"RTN","GMRCEDT4",71,0)
 I Y<1!(+$P(Y(0),U,3)=$P(GMRCPROC,U,2)) W !,$$NOCHG,! Q
"RTN","GMRCEDT4",72,0)
 S PROCED=+$P(Y(0),U,2)_U_$$UP^XLFSTR($P(Y(0),U))
"RTN","GMRCEDT4",73,0)
 I '$D(^GMR(123.5,"APR",+PROCED,+GMRCSS)) D
"RTN","GMRCEDT4",74,0)
 . ;never executed; service non-editable
"RTN","GMRCEDT4",75,0)
 . N GMRCEDD1,GMRCSSV,GMRCPROC
"RTN","GMRCEDT4",76,0)
 . W !,"The service is no longer appropriate for this procedure.",!
"RTN","GMRCEDT4",77,0)
 . S GMRCSSV=GMRCSS,GMRCPROC=PROCED
"RTN","GMRCEDT4",78,0)
 . S:$D(GMRCEDT(1)) GMRCEDD1=GMRCEDT(1)
"RTN","GMRCEDT4",79,0)
 . D 01
"RTN","GMRCEDT4",80,0)
 . I '$D(^GMR(123.5,"APR",+PROCED,+GMRCSS)) D
"RTN","GMRCEDT4",81,0)
 .. W !,$C(7),"Unable to change procedure.",!
"RTN","GMRCEDT4",82,0)
 .. K PROCED,GMRCEDT(1) S GMRCSS=GMRCSSV
"RTN","GMRCEDT4",83,0)
 .. I $D(GMRCEDD1) S GMRCEDT(1)=GMRCEDD1
"RTN","GMRCEDT4",84,0)
 I $D(PROCED) S (GMRCPROC,GMRCED(1))=PROCED
"RTN","GMRCEDT4",85,0)
 Q
"RTN","GMRCEDT4",86,0)
2       ;edit service rendered
"RTN","GMRCEDT4",87,0)
 N DIR,X,Y,GMRCURSV,GMRCPLSV,GMRCED4,GMRCED5,RENDED
"RTN","GMRCEDT4",88,0)
 S DIR(0)="S:A^I:Inpatient;O:Outpatient",DIR("B")=$P(GMRCREND,U,2)
"RTN","GMRCEDT4",89,0)
 S DIR("A")="Service to be performed Inpatient or Outpatient: "
"RTN","GMRCEDT4",90,0)
 D ^DIR I $D(DUOUT)!($D(DTOUT)) W !,$$NOCHG,! Q
"RTN","GMRCEDT4",91,0)
 I Y'=$P(GMRCREND,U) S RENDED=Y_U_Y(0)
"RTN","GMRCEDT4",92,0)
 I '$D(RENDED) Q
"RTN","GMRCEDT4",93,0)
 I '$$VALIDUR(GMRCURG,RENDED,+$G(GMRCPROC)) D  I '$D(RENDED) Q
"RTN","GMRCEDT4",94,0)
 . N GMRCREND,CHGIO S GMRCREND=RENDED
"RTN","GMRCEDT4",95,0)
 . W $C(7),!!,"The urgency of this request is no longer valid.",!
"RTN","GMRCEDT4",96,0)
 . S GMRCURSV=GMRCURG S:$D(GMRCED(3)) GMRCED3=GMRCED(3)
"RTN","GMRCEDT4",97,0)
 . S CHGREND="" D 3
"RTN","GMRCEDT4",98,0)
 . I '$$VALIDUR(GMRCURG,RENDED,+$G(GMRCPROC)) D  Q
"RTN","GMRCEDT4",99,0)
 .. W !,$C(7),"Unable to change the way service is rendered.",!
"RTN","GMRCEDT4",100,0)
 .. K RENDED S GMRCURG=GMRCURSV S:$D(GMRCED3) GMRCED(3)=GMRCED3
"RTN","GMRCEDT4",101,0)
 I '$$VALIDPL(GMRCPL,RENDED) D  I '$D(RENDED) Q
"RTN","GMRCEDT4",102,0)
 . N GMRCREND,CHGREND S GMRCREND=RENDED
"RTN","GMRCEDT4",103,0)
 . W $C(7),!!,"The Place of Consultation is no longer valid.",!
"RTN","GMRCEDT4",104,0)
 . S GMRCPLSV=GMRCPL S:$D(GMRCED(4)) GMRCED4=GMRCED(4) S CHGREND="" D 4
"RTN","GMRCEDT4",105,0)
 . I '$$VALIDPL(GMRCPL,RENDED) D  Q
"RTN","GMRCEDT4",106,0)
 .. W !,$C(7),"Unable to change the way service is rendered.",!
"RTN","GMRCEDT4",107,0)
 .. K RENDED S GMRCPL=GMRCPLSV S:$D(GMRCED4) GMRCED(4)=GMRCED4
"RTN","GMRCEDT4",108,0)
 .. S:$D(GMRCURSV) GMRCURG=GMRCURSV
"RTN","GMRCEDT4",109,0)
 .. S:$D(GMRCED3) GMRCED(3)=GMRCED3
"RTN","GMRCEDT4",110,0)
 S (GMRCREND,GMRCED(2))=RENDED
"RTN","GMRCEDT4",111,0)
 Q
"RTN","GMRCEDT4",112,0)
3 ;edit urgency
"RTN","GMRCEDT4",113,0)
 N X,Y,XQORM
"RTN","GMRCEDT4",114,0)
 I $P(GMRCREND,U)="O" S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM - OUTPATIENT")
"RTN","GMRCEDT4",115,0)
 I '$D(Y) D  ;inpatient
"RTN","GMRCEDT4",116,0)
 .I '$G(GMRCPROC) S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM CSLT - INPATIENT") Q
"RTN","GMRCEDT4",117,0)
 .S Y=$$FIND1^DIC(101,"","QX","GMRCURGENCYM REQ - INPATIENT")
"RTN","GMRCEDT4",118,0)
 I 'Y W !,$C(7),"Unable to change urgency." Q
"RTN","GMRCEDT4",119,0)
 S XQORM=+Y_";ORD(101,",XQORM(0)="1A\",XQORM("A")="Urgency: "
"RTN","GMRCEDT4",120,0)
 S XQORM("^^NO")=0
"RTN","GMRCEDT4",121,0)
 S:'$D(CHGREND) XQORM("B")=$P($G(GMRCURG),U,2)
"RTN","GMRCEDT4",122,0)
 D EN^XQORM
"RTN","GMRCEDT4",123,0)
 Q:Y'>0
"RTN","GMRCEDT4",124,0)
 I $P(Y(1),U,2)'=+GMRCURG D
"RTN","GMRCEDT4",125,0)
 . S GMRCED(3)=$P(Y(1),U,2)_U_$P(Y(1),U,3),GMRCURG=GMRCED(3)
"RTN","GMRCEDT4",126,0)
 Q
"RTN","GMRCEDT4",127,0)
4 ;edit place of CSLT
"RTN","GMRCEDT4",128,0)
 N X,Y,XQORM
"RTN","GMRCEDT4",129,0)
 S Y=$$FIND1^DIC(101,,"QX","GMRCPLACEM - "_$$UP^XLFSTR($P(GMRCREND,U,2))) Q:'Y
"RTN","GMRCEDT4",130,0)
 S XQORM=Y_";ORD(101,"
"RTN","GMRCEDT4",131,0)
 S XQORM(0)="1AR\",XQORM("A")="Place of Consultation: ",XQORM("NO^^")=""
"RTN","GMRCEDT4",132,0)
 S:'$D(CHGREND) XQORM("B")=$P($G(GMRCPL),U,2)
"RTN","GMRCEDT4",133,0)
 D EN^XQORM
"RTN","GMRCEDT4",134,0)
 Q:Y'>0
"RTN","GMRCEDT4",135,0)
 I $P(Y(1),U,2)'=+GMRCPL D
"RTN","GMRCEDT4",136,0)
 . S GMRCED(4)=$P(Y(1),U,2)_U_$P(Y(1),U,3),GMRCPL=GMRCED(4)
"RTN","GMRCEDT4",137,0)
 Q
"RTN","GMRCEDT4",138,0)
5 ;edit ATTN person
"RTN","GMRCEDT4",139,0)
 N X,Y,DIR
"RTN","GMRCEDT4",140,0)
 S DIR(0)="PAO^200:EQM",DIR("A")="Select ATTENTION person: "
"RTN","GMRCEDT4",141,0)
 S DIR("B")=$$GET1^DIQ(200,+$P(^GMR(123,+GMRCO,0),U,11),.01)
"RTN","GMRCEDT4",142,0)
 S:$D(GMRCED(5)) DIR("B")=$P($G(GMRCED(5)),U,2)
"RTN","GMRCEDT4",143,0)
 K:'$L(DIR("B")) DIR("B")
"RTN","GMRCEDT4",144,0)
 D ^DIR I $D(DTOUT)!($D(DUOUT)) Q
"RTN","GMRCEDT4",145,0)
 I $G(DIR("B"))=$P(Y,U,2) Q
"RTN","GMRCEDT4",146,0)
 S GMRCED(5)=$S(Y=-1:"",1:Y)
"RTN","GMRCEDT4",147,0)
 I GMRCED(5)="" W !,?5,"<DELETED>",!
"RTN","GMRCEDT4",148,0)
 Q
"RTN","GMRCEDT4",149,0)
6 ;edit prov. DX
"RTN","GMRCEDT4",150,0)
 N X,Y,DIR
"RTN","GMRCEDT4",151,0)
 S DIR(0)="FAO^2:180",DIR("A")="Provisional Diagnosis: "
"RTN","GMRCEDT4",152,0)
 S:$D(GMRCED(6)) DIR("B")=GMRCED(6)
"RTN","GMRCEDT4",153,0)
 I '$D(DIR("B")) S DIR("B")=$G(^GMR(123,+GMRCO,30))
"RTN","GMRCEDT4",154,0)
 K:'$L(DIR("B")) DIR("B")
"RTN","GMRCEDT4",155,0)
 D ^DIR Q:$D(DTOUT)!($D(DUOUT))  Q:Y=$G(DIR("B"))
"RTN","GMRCEDT4",156,0)
 I '$L(Y) W !,?5,"<DELETED>",!
"RTN","GMRCEDT4",157,0)
 S GMRCED(6)=Y
"RTN","GMRCEDT4",158,0)
 Q
"RTN","GMRCEDT4",159,0)
7 ;edit Reason for Request
"RTN","GMRCEDT4",160,0)
 N DIC,DIWESUB,DWLW,DWPK
"RTN","GMRCEDT4",161,0)
 I $D(^TMP("GMRCED",$J,20)) M ^TMP("GMRCEDSV",$J,20)=^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",162,0)
 I '$D(^TMP("GMRCED",$J,20)) M ^TMP("GMRCED",$J,20)=^GMR(123,+GMRCO,20)
"RTN","GMRCEDT4",163,0)
 S DIC="^TMP(""GMRCED"",$J,20,",DIWESUB="Reason for Request"
"RTN","GMRCEDT4",164,0)
 W !,"Editing Reason for Request:",!
"RTN","GMRCEDT4",165,0)
 S DWPK=1,DWLW=74 D EN^DIWE
"RTN","GMRCEDT4",166,0)
 I '$$DIFFRFR($D(^TMP("GMRCEDSV",$J,20))) D  Q
"RTN","GMRCEDT4",167,0)
 . I $D(^TMP("GMRCEDSV",$J,20)) K ^TMP("GMRCEDSV",$J,20) Q
"RTN","GMRCEDT4",168,0)
 . K ^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",169,0)
 K ^TMP("GMRCEDSV",$J,20)
"RTN","GMRCEDT4",170,0)
 I '$D(^TMP("GMRCED",$J,20))!('$O(^TMP("GMRCED",$J,20,0))) D
"RTN","GMRCEDT4",171,0)
 . N GMRCMSG
"RTN","GMRCEDT4",172,0)
 . S GMRCMSG="Unable to delete Reason for Request (REQUIRED)"
"RTN","GMRCEDT4",173,0)
 . D EXAC^GMRCADC(GMRCMSG)
"RTN","GMRCEDT4",174,0)
 . K ^TMP("GMRCED",$J,20)
"RTN","GMRCEDT4",175,0)
 Q
"RTN","GMRCEDT4",176,0)
8 ;add comment
"RTN","GMRCEDT4",177,0)
 N DIC,DIWEPSE,DIWESUB,DWLW,DWPK
"RTN","GMRCEDT4",178,0)
 I $D(^TMP("GMRCED",$J,40)) D
"RTN","GMRCEDT4",179,0)
 . W !,"An unsaved comment exists. You may edit this comment.",!
"RTN","GMRCEDT4",180,0)
 . S DIWEPSE=1
"RTN","GMRCEDT4",181,0)
 S DIC="^TMP(""GMRCED"",$J,40,",DIWESUB="New Comment"
"RTN","GMRCEDT4",182,0)
 W !,"Adding new comment:",!
"RTN","GMRCEDT4",183,0)
 S DWPK=1,DWLW=74 D EN^DIWE
"RTN","GMRCEDT4",184,0)
 I '$O(^TMP("GMRCED",$J,40,0)) K ^TMP("GMRCED",$J,40)
"RTN","GMRCEDT4",185,0)
 Q
"RTN","GMRCEDT4",186,0)
DIFFRFR(SAVED) ;edited reason for req same as original?
"RTN","GMRCEDT4",187,0)
 N I,DIFF
"RTN","GMRCEDT4",188,0)
 I SAVED,$P($G(^TMP("GMRCED",$J,20,0)),U,3,4)'=$P($G(^TMP("GMRCEDSV",$J,20,0)),U,3,4) S DIFF=1 Q 1
"RTN","GMRCEDT4",189,0)
 I 'SAVED,$P($G(^TMP("GMRCED",$J,20,0)),U,3,4)'=$P($G(^GMR(123,+GMRCO,20,0)),U,3,4) S DIFF=1 Q 1
"RTN","GMRCEDT4",190,0)
 I SAVED S I=0 F  S I=$O(^TMP("GMRCED",$J,20,I)) Q:'I!($D(DIFF))  D
"RTN","GMRCEDT4",191,0)
 . I ^TMP("GMRCED",$J,20,I,0)=$G(^TMP("GMRCEDSV",$J,20,I,0)) Q
"RTN","GMRCEDT4",192,0)
 . S DIFF=1
"RTN","GMRCEDT4",193,0)
 . Q
"RTN","GMRCEDT4",194,0)
 I 'SAVED S I=0 F  S I=$O(^TMP("GMRCED",$J,20,I)) Q:'I!($D(DIFF))  D
"RTN","GMRCEDT4",195,0)
 . I ^TMP("GMRCED",$J,20,I,0)'=$G(^GMR(123,+GMRCO,20,I,0)) S DIFF=1
"RTN","GMRCEDT4",196,0)
 . Q
"RTN","GMRCEDT4",197,0)
 Q $G(DIFF)
"RTN","GMRCEDT4",198,0)
VALIDPL(PL,REND) ; place still valid?
"RTN","GMRCEDT4",199,0)
 N PLMENU
"RTN","GMRCEDT4",200,0)
 S PLMENU=$S($P(REND,U)="I":"IN",1:"OUT")
"RTN","GMRCEDT4",201,0)
 S PLMENU="GMRCPLACEM - "_PLMENU_"PATIENT"
"RTN","GMRCEDT4",202,0)
 S PLMENU=$$FIND1^DIC(101,,"QX",PLMENU) Q:PLMENU'>1 0
"RTN","GMRCEDT4",203,0)
 Q $D(^ORD(101,PLMENU,10,"B",+PL))
"RTN","GMRCEDT4",204,0)
VALIDUR(URG,REND,PROC) ;urgency still valid?
"RTN","GMRCEDT4",205,0)
 N URMENU
"RTN","GMRCEDT4",206,0)
 I $P(REND,U)="I" D
"RTN","GMRCEDT4",207,0)
 .I 'PROC S URMENU="GMRCURGENCYM CSLT - INPATIENT" Q
"RTN","GMRCEDT4",208,0)
 .S URMENU="GMRCURGENCYM REQ - INPATIENT" Q
"RTN","GMRCEDT4",209,0)
 I '$D(URMENU) S URMENU="GMRCURGENCYM - OUTPATIENT"
"RTN","GMRCEDT4",210,0)
 S URMENU=$$FIND1^DIC(101,,"QX",URMENU) Q:URMENU<0 0
"RTN","GMRCEDT4",211,0)
 Q $D(^ORD(101,URMENU,10,"B",+URG))
"RTN","GMRCEDT4",212,0)
 Q
"RTN","GMRCEDT4",213,0)
NOCHG() ;no changes made
"RTN","GMRCEDT4",214,0)
 Q "No Changes made!"
"RTN","GMRCEDT5")
0^7^B8404659
"RTN","GMRCEDT5",1,0)
GMRCEDT5 ;SLC/DCM - EDIT A CONSULT AND RE-SEND AS NEW ;6/17/98  10:45
"RTN","GMRCEDT5",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**5**;DEC 27, 1997
"RTN","GMRCEDT5",3,0)
WP ;edit comment and request fields
"RTN","GMRCEDT5",4,0)
 N CMDA,DIE,DIC,DWPK,DWLW,DIWESUB,GMRCNOW
"RTN","GMRCEDT5",5,0)
 S DIE="^GMR(123,"
"RTN","GMRCEDT5",6,0)
 S GMRCNOW=$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","GMRCEDT5",7,0)
 S DIC=DIE_+GMRCO_",40,",DWPK=1,DWLW=74
"RTN","GMRCEDT5",8,0)
 I FLDA=40 S GMRCA=20 D  S DIWESUB="COMMENTS"
"RTN","GMRCEDT5",9,0)
 .S CMDA=$$ADDCM^GMRCEDT4(+GMRCO),GMRCFLD(FLDA)="COMMENT ADDED: "_$$FMTE^XLFDT($$NOW^XLFDT)_"^"_CMDA D AUDIT0^GMRCEDT4(CMDA,+GMRCO) S DIC=DIC_CMDA_",1," Q
"RTN","GMRCEDT5",10,0)
 .Q
"RTN","GMRCEDT5",11,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCEDT5",12,0)
 I $D(FLDA),FLDA=20 S DIC=DIE_(+GMRCO)_",20,",DWPK=1,DWLW=74 I '$D(GMRCFLD(FLDA)) S GMRCFLD(FLDA)="REASON FOR REQUEST" M GMRCFLD(FLDA)=^GMR(123,+GMRCO,20)
"RTN","GMRCEDT5",13,0)
 D EN^DIWE
"RTN","GMRCEDT5",14,0)
 I FLDA=40,$D(^GMR(123,+GMRCO,40,CMDA,0)),$P($G(^GMR(123.1,+$P(^GMR(123,+GMRCO,40,CMDA,0),U,2),0)),U)="ADDED COMMENT",'$O(^GMR(123,+GMRCO,40,CMDA,0)) D
"RTN","GMRCEDT5",15,0)
 .I $D(CMDA),'$O(^GMR(123,+GMRCO,40,CMDA,0)) S DA=40,DA(1)=CMDA,DIK="^GMR(123,"_DA(1)_",40," D ^DIK K DIK,GMRCFLD(FLDA)
"RTN","GMRCEDT5",16,0)
 .Q
"RTN","GMRCEDT5",17,0)
 S VALMBCK="R"
"RTN","GMRCEDT5",18,0)
 Q
"RTN","GMRCEDT5",19,0)
SAVED ;These lines were removed from WP+8 to WP+20 to removed the
"RTN","GMRCEDT5",20,0)
 ;ability to edit comments in the Edit Cancelled Consult
"RTN","GMRCEDT5",21,0)
 ;Allert. They were placed here until it is determined that
"RTN","GMRCEDT5",22,0)
 ;they should be permaneltly deleted.
"RTN","GMRCEDT5",23,0)
 I GMRCEDCM>0 D  Q:GMRCQUT
"RTN","GMRCEDT5",24,0)
 .F  W !,"Type The Comment Number To Edit Or Type 0 (Zero) To Add A NEW Comment",!!,"Comment: " R X:DTIME S GMRCQUT=$S('$T:1,X["^":1,X="":1,1:0) Q:GMRCQUT  D  I $D(CMDA),CMDA>0 Q
"RTN","GMRCEDT5",25,0)
 ..I X["?" W !,"Choose from : " D  Q
"RTN","GMRCEDT5",26,0)
 ...S GMRCLX=0 F  S GMRCLX=$O(GMRCED(GMRCLX)) Q:GMRCLX=""  S GMRCNDA=GMRCED(GMRCLX) W !,"COMMENT #",$J(GMRCLX,2)," "
"RTN","GMRCEDT5",27,0)
 ...W "Entered: ",$$FMTE^XLFDT($P(^GMR(123,+GMRCO,40,GMRCNDA,0),"^",1)),"   By: ",$P(^VA(200,$P(^(0),"^",4),0),"^",1),!
"RTN","GMRCEDT5",28,0)
 ...W !
"RTN","GMRCEDT5",29,0)
 ...Q
"RTN","GMRCEDT5",30,0)
 ..I X=0 S CMDA=$$ADDCM^GMRCEDT4(+GMRCO) D AUDIT0^GMRCEDT4(CMDA,+GMRCO) S DIC=DIC_CMDA_",1,",DTOUT=0,Y=$$FMTE^XLFDT(DT,"1D"),GMRCFLD(FLDA)="COMMENT ADDED: "_Y_"^"_CMDA Q
"RTN","GMRCEDT5",31,0)
 ..I $D(GMRCED(X)) S CMDA=GMRCED(X),GMRCFLD(FLDA)="COMMENT EDITED: "_$$FMTE^XLFDT($P(^GMR(123,+GMRCO,40,CMDA,0),"^",1)),DIC=DIC_CMDA_",1," Q
"RTN","GMRCEDT5",32,0)
 ..I '$D(GMRCED(X)) W $C(27)," ??"
"RTN","GMRCEDT5",33,0)
 ..Q
"RTN","GMRCEDT5",34,0)
 .Q
"RTN","GMRCEDT5",35,0)
 Q
"RTN","GMRCHL7")
0^8^B25970884
"RTN","GMRCHL7",1,0)
GMRCHL7 ;SLC/DCM - HL-7 formatting routine for consult information to be passed to OER ;9/8/98  03:52
"RTN","GMRCHL7",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCHL7",3,0)
 ;;Format the HL-7 Message header
"RTN","GMRCHL7",4,0)
 Q
"RTN","GMRCHL7",5,0)
INIT S HLQ=""""""
"RTN","GMRCHL7",6,0)
 S SEP1="|",SEP2="^",SEP3="~",SEP4="\",SEP5="&"
"RTN","GMRCHL7",7,0)
 Q
"RTN","GMRCHL7",8,0)
MSH(X) ;Format MSH segment of HL-7 message.
"RTN","GMRCHL7",9,0)
 ;FROM=GMRC CONSULTS - the sending application
"RTN","GMRCHL7",10,0)
 N X
"RTN","GMRCHL7",11,0)
 I '$D(HLQ) D INIT
"RTN","GMRCHL7",12,0)
 S X="MSH|^~\&|CONSULTS|"_$S(+$G(DUZ(2)):DUZ(2),1:$$SITE^VASITE())_"|||||ORM"
"RTN","GMRCHL7",13,0)
 Q X
"RTN","GMRCHL7",14,0)
PID(GMRCIEN) ;Format the HL-7 PID segment
"RTN","GMRCHL7",15,0)
 ;GMRCIEN=IEN of consult from File 123
"RTN","GMRCHL7",16,0)
 N X
"RTN","GMRCHL7",17,0)
 S GMRCDPT=$P(^GMR(123,GMRCIEN,0),"^",2)
"RTN","GMRCHL7",18,0)
 S GMRCPTN=$P($G(^DPT(GMRCDPT,0)),"^")
"RTN","GMRCHL7",19,0)
 S X="PID|||"_+GMRCDPT_"||"_GMRCPTN
"RTN","GMRCHL7",20,0)
 K GMRCDPT,GMRCPTN
"RTN","GMRCHL7",21,0)
 Q X
"RTN","GMRCHL7",22,0)
PV1(GMRCIEN,RMBED,VISIT) ;Format the HL-7 PV1 segment
"RTN","GMRCHL7",23,0)
 N GMRCSTS,SEP1,X,Y
"RTN","GMRCHL7",24,0)
 S HOSPLOC=$P(^GMR(123,GMRCIEN,0),"^",4)
"RTN","GMRCHL7",25,0)
 S VISIT=$$HL7DT(VISIT),GMRCSTS=$S($P(^GMR(123,GMRCIEN,0),"^",18)]"":$P(^(0),"^",18),HOSPLOC]"":"I",1:"O")
"RTN","GMRCHL7",26,0)
 S X="PV1"_"||"_GMRCSTS_"|"_$S(HOSPLOC]"":HOSPLOC,1:"")_"^"_$S(RMBED]"":RMBED,1:"")_"|"_$S(VISIT]"":VISIT,1:"")
"RTN","GMRCHL7",27,0)
 K Y,HOSPLOC,VISIT,GMRCSTS
"RTN","GMRCHL7",28,0)
 Q X
"RTN","GMRCHL7",29,0)
NTE(NTE,ND) ;Format the HL-7 NTE segment
"RTN","GMRCHL7",30,0)
 Q:'$D(NTE)  Q:'$O(NTE(0))
"RTN","GMRCHL7",31,0)
 S GMRCND=1,GMRCND1=0 D
"RTN","GMRCHL7",32,0)
 .S GMRCND1=$O(NTE(GMRCND1)),@(MSG_"("_ND_")")=NTE(GMRCND1)
"RTN","GMRCHL7",33,0)
 .F  S GMRCND1=$O(NTE(GMRCND1)) Q:GMRCND1=""  I NTE(GMRCND1)]"" S @(MSG_"("_ND_","_GMRCND_")")=NTE(GMRCND1),GMRCND=GMRCND+1
"RTN","GMRCHL7",34,0)
 .Q
"RTN","GMRCHL7",35,0)
 Q
"RTN","GMRCHL7",36,0)
EN(PATID,GMRCIEN,GMRCRTYP,RMBED,ORCTRL,GMRCPLCR,VISIT,GMRCOM,GRPUPD) ;;Main entry point
"RTN","GMRCHL7",37,0)
 ;PATID=DFN - Patients internal entry number from ^DPT(
"RTN","GMRCHL7",38,0)
 ;GMRCIEN=IEN of consult, from File 123
"RTN","GMRCHL7",39,0)
 ;RMBED=Hospital Room/Bed if patient is hospitalized
"RTN","GMRCHL7",40,0)
 ;ORCTRL=Code from HL-7 table 119 (Appendix A) Order Control Codes
"RTN","GMRCHL7",41,0)
 ;VISIT=Visit as a DATE/TIME in Fileman Format.
"RTN","GMRCHL7",42,0)
 ;GMRCPROV=Provider - IEN from file 200
"RTN","GMRCHL7",43,0)
 ;GMRCRTYP=consult type: GMRC REQUEST or GMRC CONSULT
"RTN","GMRCHL7",44,0)
 ;GMRCPLCR=who is entering the order ; usually passed as DUZ for new order, "" for existing order
"RTN","GMRCHL7",45,0)
 ;GMRCOM=comment array flag: 1 if there is comment array, 0 otherwise
"RTN","GMRCHL7",46,0)
 ;GMRCOM(0)=DA of where comment is located: ^GMR(123,IEN,40,DA,
"RTN","GMRCHL7",47,0)
 ;GRPUPD = group update of consults - sends nature as MAINTENANCE
"RTN","GMRCHL7",48,0)
 Q:'$L(ORCTRL)
"RTN","GMRCHL7",49,0)
 K GMRCMSS
"RTN","GMRCHL7",50,0)
 N MSG,MSH,PID,PV1,ORC,NTE,OBR,OBX,GMRCA,GMRCURGI,GMRCPLI,GMRCPR,GMRCSS,GMRCTYPE,ORCPLCR
"RTN","GMRCHL7",51,0)
 S MSH="",MSH=$$MSH(MSH)
"RTN","GMRCHL7",52,0)
 S PID=$$PID(GMRCIEN)
"RTN","GMRCHL7",53,0)
 I ORCTRL'="Z@" S PV1=$$PV1(GMRCIEN,RMBED,VISIT)
"RTN","GMRCHL7",54,0)
 D ORC(GMRCIEN,ORCTRL,GMRCPLCR,$G(GRPUPD)) I ORCTRL="Z@" S ORC=$P(ORC,SEP1,1,4)
"RTN","GMRCHL7",55,0)
 D:ORCTRL'="Z@" OBR^GMRCHL72(GMRCIEN,$G(GMRCAUTH)) ;GMRCAUTH=principle results interpreter
"RTN","GMRCHL7",56,0)
 I $S(ORCTRL="SN":1,ORCTRL="RE":1,ORCTRL="XX":1,1:0) D OBX^GMRCHL72(GMRCIEN)
"RTN","GMRCHL7",57,0)
 I $S(ORCTRL="OC":1,ORCTRL="OD":1,ORCTRL="XX":1,ORCTRL="SC":1,1:0),$G(GMRCOM(0)) D NTE^GMRCHL72(GMRCIEN,.GMRCOM,ORCTRL)
"RTN","GMRCHL7",58,0)
 D BLD(MSH,PID,$G(PV1),$G(ORC),$G(OBR),.OBX,.NTE,ORCTRL)
"RTN","GMRCHL7",59,0)
 ;M GMRCMSS=GMRCMSG ;HL-7 message debugging aid - remove from final version
"RTN","GMRCHL7",60,0)
 D MSG^XQOR("GMRC EVSEND OR",.GMRCMSG)
"RTN","GMRCHL7",61,0)
 K GMRCND,GMRCND1,GMRCMSG,GMRCNOD,GMRCORFN,GMRCPLI,GMRCPRI,HL7DT,HLQ,J,ND,ND1,ND2,NOTIFY,OBXND,OBXNO,ORCACT,ORCDT,ORURG,SEP1,SEP2,SEP3,SEP4,SEP5
"RTN","GMRCHL7",62,0)
 Q
"RTN","GMRCHL7",63,0)
BLD(MSH,PID,PV1,ORC,OBR,OBX,NTE,CTRLCD) ;Build the HL-7 message global to pass to OR
"RTN","GMRCHL7",64,0)
 S MSG="GMRCMSG",ND=1
"RTN","GMRCHL7",65,0)
 K @(MSG)
"RTN","GMRCHL7",66,0)
 F J="MSH","PID","PV1" I @J]"" S @(MSG_"("_ND_")")=@J,ND=ND+1
"RTN","GMRCHL7",67,0)
 I ORC]"" S @(MSG_"("_ND_")")=ORC,ND=ND+1 I CTRLCD="XX",$D(NTE),$O(NTE(0)) D NTE(.NTE,ND) S ND=ND+1
"RTN","GMRCHL7",68,0)
 I OBR]"" S @(MSG_"("_ND_")")=OBR,ND=ND+1
"RTN","GMRCHL7",69,0)
 I $O(OBX("")) S OBXND=0 D
"RTN","GMRCHL7",70,0)
 .S OBXND=$O(OBX(OBXND)) Q:OBXND=""  S @(MSG_"("_ND_")")=OBX(OBXND)
"RTN","GMRCHL7",71,0)
 .S GMRCND1=0 F  S GMRCND1=$O(OBX(OBXND,GMRCND1)) Q:GMRCND1=""  S @(MSG_"("_ND_","_GMRCND1_")")=OBX(OBXND,GMRCND1)
"RTN","GMRCHL7",72,0)
 .S ND=ND+1,OBXND=$O(OBX(OBXND)) I OBXND]"" S @(MSG_"("_ND_")")=OBX(OBXND)
"RTN","GMRCHL7",73,0)
 .Q
"RTN","GMRCHL7",74,0)
 I CTRLCD'="XX",$D(NTE),$O(NTE(0)) D NTE(.NTE,ND) S ND=ND+1
"RTN","GMRCHL7",75,0)
 Q
"RTN","GMRCHL7",76,0)
HL7DT(DATE) ;Convert Fileman Date to HL-7 Date
"RTN","GMRCHL7",77,0)
 N X
"RTN","GMRCHL7",78,0)
 S X="" I DATE S X=17000000+$P(DATE,".",1)_$P(DATE,".",2)
"RTN","GMRCHL7",79,0)
 Q X
"RTN","GMRCHL7",80,0)
FMDATE(DATE) ;Convert HL-7 formatted date to a Fileman formatted date
"RTN","GMRCHL7",81,0)
 N X
"RTN","GMRCHL7",82,0)
 S X="" I DATE S X=($E(DATE,1,8)-17000000)_$S($L($E(DATE,9)):"."_$E(DATE,9,14),1:"")
"RTN","GMRCHL7",83,0)
 Q X
"RTN","GMRCHL7",84,0)
ORC(GMRCIEN,GMRCTRL,ORCPLCR,MAINT) ;Build the ORC segment of the HL-7 message
"RTN","GMRCHL7",85,0)
 ;GMRCTRL=Order Control Code (table 119)
"RTN","GMRCHL7",86,0)
 ;GMRCIEN=File 123 IEN
"RTN","GMRCHL7",87,0)
 ;ORPLCR=GMRCPLCR - the person entering the order
"RTN","GMRCHL7",88,0)
 ;MAINT=1 - group update of requests 
"RTN","GMRCHL7",89,0)
 N GMRCURG,ORCACT,ORCDT,ORCPRV,ORCDT,ORIEN,ORCSTS,STS,ORCNATR
"RTN","GMRCHL7",90,0)
 S ORCDT=$P(^GMR(123,GMRCIEN,0),"^",7),ORCPRV=$P(^GMR(123,GMRCIEN,0),"^",14),ORURG=$P(^(0),"^",9),ORURG=$S(ORURG]"":$P(^ORD(101,ORURG,0),"^",1),1:"") S:ORURG]"" ORURG=$P(ORURG," - ",2)
"RTN","GMRCHL7",91,0)
 S ORURG=$S(ORURG="EMERGENCY":"STAT",ORURG="NOW":"STAT",ORURG="OUTPATIENT":"ROUTINE",1:ORURG)
"RTN","GMRCHL7",92,0)
 S:ORURG="" GMRCURG="" I ORURG]"" S GMRCURG=$O(^ORD(101.42,"B",ORURG,0)),GMRCURG=$S(+GMRCURG:$P(^ORD(101.42,GMRCURG,0),"^",2),1:"")
"RTN","GMRCHL7",93,0)
 S ORCDT=$$HL7DT(ORCDT)
"RTN","GMRCHL7",94,0)
 S STS=$P(^GMR(123,GMRCIEN,0),"^",12)
"RTN","GMRCHL7",95,0)
 S ORCACT=$P($G(^ORD(100.01,+STS,0)),U,1) S:'$L(ORCACT) ORCACT="NO STATUS"
"RTN","GMRCHL7",96,0)
 S ORIEN=$P(^GMR(123,GMRCIEN,0),"^",3)
"RTN","GMRCHL7",97,0)
 S ORCSTS=$S(STS=1:"DC",STS=2:"CM",STS=5:"IP",STS=6:"SC",STS=9:"A",STS=12:"RP",STS=13:"CA",1:"IP")
"RTN","GMRCHL7",98,0)
 S ORCNATR=$S(GMRCTRL="XX":"S^SERVICE CORRECTION^99ORN^^^",1:"")
"RTN","GMRCHL7",99,0)
 I $G(MAINT) S ORCNATR="M^MAINTENANCE^99ORN^^^"
"RTN","GMRCHL7",100,0)
 ;References to GMRCXMF refer to foreign facility sending of messages
"RTN","GMRCHL7",101,0)
 ;Need to work out details of when to use which ien: local or foreign processing
"RTN","GMRCHL7",102,0)
 I $D(GMRCXMF),$P(^GMR(123,GMRCIEN,0),"^",22) S GMRCOFN=GMRCIEN N GMRCIEN S GMRCIEN=$P(^(0),"^",22)
"RTN","GMRCHL7",103,0)
 S ORC="ORC|"_GMRCTRL_"|"_$S(ORIEN]"":ORIEN_";1^OR",1:"")_"|"_GMRCIEN_"^"_"GMRC"_"||"_ORCSTS_"||"_$S(GMRCURG]"":"^^^^^"_GMRCURG,1:"")_"|||"_ORCPLCR_"||"_ORCPRV_"|||"_ORCDT_"|"_ORCNATR
"RTN","GMRCHL7",104,0)
 Q
"RTN","GMRCHL72")
0^9^B11271463
"RTN","GMRCHL72",1,0)
GMRCHL72 ;SLC/DCM - HL-7 formatting routine for consult information to be passed to OER - formates OBX and NTE segments ;9/8/98  03:53
"RTN","GMRCHL72",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCHL72",3,0)
OBX(GMRCIFN) ;Build the OBX segment of the HL-7 message
"RTN","GMRCHL72",4,0)
 ;GMRCIFN=GMRCIEN - the internal file # of the record from file 123
"RTN","GMRCHL72",5,0)
 S OBXSEGNO=0
"RTN","GMRCHL72",6,0)
 I ORCTRL'="RT",$D(^GMR(123,GMRCIFN,20,0)) S GMRCND=0,GMRCND1=0,OBXSEGNO=OBXSEGNO+1 D
"RTN","GMRCHL72",7,0)
 .S GMRCND=$O(^GMR(123,GMRCIFN,20,GMRCND)),OBX(OBXSEGNO)="OBX|"_OBXSEGNO_"|TX|2000.02^REASON FOR REQUEST^AS4||"_^GMR(123,GMRCIFN,20,GMRCND,0),GMRCND1=GMRCND1+1
"RTN","GMRCHL72",8,0)
 .F  S GMRCND=$O(^GMR(123,GMRCIFN,20,GMRCND)) Q:GMRCND=""  S OBX(OBXSEGNO,GMRCND1)=^GMR(123,GMRCIFN,20,GMRCND,0),GMRCND1=GMRCND1+1
"RTN","GMRCHL72",9,0)
 .Q
"RTN","GMRCHL72",10,0)
 I $D(^GMR(123,GMRCIFN,30)) S OBXSEGNO=OBXSEGNO+1,OBX(OBXSEGNO)="OBX|"_OBXSEGNO_"|TX|^PROVISIONAL DIAGNOSIS^||"_$G(^GMR(123,GMRCIFN,30))
"RTN","GMRCHL72",11,0)
 Q
"RTN","GMRCHL72",12,0)
 ;
"RTN","GMRCHL72",13,0)
NTE(GMRCFN,GMRCND,GMRCTRL) ;Build the NTE segment of the HL7 message
"RTN","GMRCHL72",14,0)
 ;GMRCND=GMRCOM, an array. GMRCND = flag that a comment exists.
"RTN","GMRCHL72",15,0)
 ;GMRCND(0)= DA = the internal entry in node 40: ^GMR(123,IEN,40,DA
"RTN","GMRCHL72",16,0)
 ;GMRCTRL=HL7 control code from table 119
"RTN","GMRCHL72",17,0)
 Q:'$D(GMRCND(0))  S ND=GMRCND(0)
"RTN","GMRCHL72",18,0)
 S ND2=1,NTE(ND2)="NTE|16|L|"
"RTN","GMRCHL72",19,0)
 I $S($P(^GMR(123,GMRCFN,40,ND,0),"^",2)=6:1,$P(^(0),"^",2)=20:1,$P(^(0),"^",2)=7:1,$P(^(0),"^",2)=5:1,GMRCTRL="XX":1,1:0) D
"RTN","GMRCHL72",20,0)
 .S ND1=0,ND1=$O(^GMR(123,GMRCFN,40,ND,1,ND1)) Q:ND1=""  S NTE(ND2)=NTE(ND2)_^GMR(123,GMRCFN,40,ND,1,ND1,0),ND2=ND2+1
"RTN","GMRCHL72",21,0)
 .F  S ND1=$O(^GMR(123,GMRCFN,40,ND,1,ND1)) Q:ND1=""  S NTE(ND2)=^GMR(123,GMRCFN,40,ND,1,ND1,0),ND2=ND2+1
"RTN","GMRCHL72",22,0)
 .Q
"RTN","GMRCHL72",23,0)
 I $P(NTE(1),"|",4)="",$S(GMRCTRL="OD":1,GMRCTRL="OC":1,1:0) S $P(NTE(1),"|",4)=$P(^GMR(123.1,$P(^GMR(123,GMRCFN,40,ND,0),"^",2),0),"^",1)_$S($P(^(0),"^",2)]"":" BY SERVICE",1:"")
"RTN","GMRCHL72",24,0)
 I $P(NTE(1),"|",4)="",GMRCTRL="XX" S $P(NTE(1),"|",4)=$P(^GMR(123.1,$P(^GMR(123,GMRCFN,40,ND,0),"^",2),0),"^",1)_" "_$S($P(^GMR(123,GMRCFN,40,ND,0),"^",6)]"":$P(^GMR(123.5,$P(^GMR(123,GMRCFN,40,ND,0),"^",6),0),"^",1),1:GMRCSSNM)
"RTN","GMRCHL72",25,0)
 K N,ND1,ND2
"RTN","GMRCHL72",26,0)
 Q
"RTN","GMRCHL72",27,0)
OBR(GMRCIEN,RESBY) ;Build the OBR segment of the HL-7 message
"RTN","GMRCHL72",28,0)
 ;GMRCIEN=IEN of the consult from file 123
"RTN","GMRCHL72",29,0)
 ;NOTIFY=Person who is notified when consult is ordered/completed
"RTN","GMRCHL72",30,0)
 ;RESBY=Person entering/interpreting result & signing report- GMRCPROV
"RTN","GMRCHL72",31,0)
 N STS,RESTATUS,ORDBLID,ORCDT,CONLOC,CONSVC,HL7DT
"RTN","GMRCHL72",32,0)
 K OBR
"RTN","GMRCHL72",33,0)
 ;I +$P(^GMR(123,GMRCIEN,0),"^",5)'>0,$S($D(GMRCSSNM):1,+GMRCGRP("ROOT"):1,1:0) S $P(^(0),"^",5)=$S(+GMRCGRP("ROOT"):GMRCGRP("ROOT"),1:$O(^GMR(123.5,"B",GMRCSSNM,0)))
"RTN","GMRCHL72",34,0)
 S STS=$P(^GMR(123,GMRCIEN,0),"^",12),RESTATUS=$S(STS=1:"X",STS=2:"F",STS=5:"O",STS=6:"I",STS=8:"S",STS=9:"R",1:"X")
"RTN","GMRCHL72",35,0)
 S ORDBLID=$P(^GMR(123,GMRCIEN,0),"^",8)
"RTN","GMRCHL72",36,0)
 I '$L(ORDBLID) S ORDBLID=$P(^GMR(123,GMRCIEN,0),"^",5)
"RTN","GMRCHL72",37,0)
 S ORCDT=$P(^GMR(123,GMRCIEN,0),"^",7),CONLOC=$P(^(0),"^",10)
"RTN","GMRCHL72",38,0)
 I CONLOC]"" S CONLOC=$S($P(^ORD(101,CONLOC,0),"^",1)["BEDSIDE":"B",$P(^(0),"^",1)["EMERGENCY":"E",1:"OC")
"RTN","GMRCHL72",39,0)
 S NOTIFY=$P(^GMR(123,GMRCIEN,0),"^",11)
"RTN","GMRCHL72",40,0)
 S CONSVC=$$GET1^DIQ(123.5,+$P(^GMR(123,GMRCIEN,0),U,5),.01)
"RTN","GMRCHL72",41,0)
 S HL7DT=$$HL7DT^GMRCHL7(ORCDT)
"RTN","GMRCHL72",42,0)
 S OBR="OBR||||^^^"_+ORDBLID_"^"_CONSVC_"^99"
"RTN","GMRCHL72",43,0)
 S OBR=OBR_$S(ORDBLID[";":"PRO",1:"CON")_"|||"_HL7DT_"|||||||||||"
"RTN","GMRCHL72",44,0)
 S OBR=OBR_CONLOC_"|"_NOTIFY_"|||"_HL7DT_"|||"_RESTATUS
"RTN","GMRCHL72",45,0)
 S OBR=OBR_$S(RESBY]"":"|||||||"_RESBY,1:"")
"RTN","GMRCHL72",46,0)
 K STS,RESTATUS,ORDBLID,ORCDT,CONLOC,CONSVC,HL7DT
"RTN","GMRCHL72",47,0)
 Q
"RTN","GMRCHL7A")
0^10^B26829382
"RTN","GMRCHL7A",1,0)
GMRCHL7A ;SLC/DCM - Receive HL-7 Message form OERR and break it into its components and store it in File 123 ;3/5/99 15:25
"RTN","GMRCHL7A",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCHL7A",3,0)
URG(X) ;Return Urgency give Z-code from HL-7 segment; see ORC+9
"RTN","GMRCHL7A",4,0)
 S X=$S(X="S":"STAT",X="R":"ROUTINE",X="ZT":"TODAY",X="Z24":"WITHIN 24 HOURS",X="Z48":"WITHIN 48 HOURS",X="Z72":"WITHIN 72 HOURS",X="ZW":"WITHIN 1 WEEK",X="ZM":"WITHIN 1 MONTH",X="ZN":"NEXT AVAILABLE",1:X)
"RTN","GMRCHL7A",5,0)
 I $E(X,1)="Z" S X=$S(X="ZT":"TODAY",X="ZE":"EMERGENCY",1:"")
"RTN","GMRCHL7A",6,0)
 Q X
"RTN","GMRCHL7A",7,0)
 ;
"RTN","GMRCHL7A",8,0)
ORC(GMRCORC) ;Get fields from ORC segment and set into GMRC variables
"RTN","GMRCHL7A",9,0)
 ;GMRCTRLC=ORC control code from HL7 Table 119
"RTN","GMRCHL7A",10,0)
 ;GMRCURGI=priority/urgency     GMRCPLCR=who entered the order
"RTN","GMRCHL7A",11,0)
 ;GMRCORNP=provider             GMRCNATO=nature of order
"RTN","GMRCHL7A",12,0)
 ;GMRCAD=date of request        GMRCOCR=order request reason
"RTN","GMRCHL7A",13,0)
 ;GMRCORFN=oe/rr file number    GMRCO=file 123 IEN - if not a new order
"RTN","GMRCHL7A",14,0)
 ;GMRCS38=order status - taken from Table 38, HL7 standard
"RTN","GMRCHL7A",15,0)
 S GMRCTRLC=$P(GMRCORC,SEP1,2),GMRCORFN=$P(GMRCORC,SEP1,3),GMRCORFN=$P($P(GMRCORFN,SEP2,1),";",1),GMRCAPP=$P($P(GMRCORC,SEP1,3),SEP2,2)
"RTN","GMRCHL7A",16,0)
 S GMRCS38=$P(GMRCORC,SEP1,6),GMRCURGI=$P($P(GMRCORC,SEP1,8),SEP2,6),GMRCPLCR=$P(GMRCORC,SEP1,11),GMRCORNP=$P(GMRCORC,SEP1,13)
"RTN","GMRCHL7A",17,0)
 I $L(GMRCURGI) S GMRCURGI="GMRCURGENCY - "_$$URG(GMRCURGI),GMRCURGI=$O(^ORD(101,"B",GMRCURGI,0))
"RTN","GMRCHL7A",18,0)
 S GMRCO=+$P($P(GMRCORC,SEP1,4),SEP2,1)
"RTN","GMRCHL7A",19,0)
 S GMRCODT=$P(GMRCORC,SEP1,16),GMRCAD=$$FMDATE^GMRCHL7(GMRCODT)
"RTN","GMRCHL7A",20,0)
 S GMRCOCR=$P(GMRCORC,SEP1,17),GMRCNATO=$P(GMRCOCR,SEP2,5)
"RTN","GMRCHL7A",21,0)
 Q
"RTN","GMRCHL7A",22,0)
OBR(GMRCOBR) ;Get fields from OBR segment and set into GMRC variables
"RTN","GMRCHL7A",23,0)
 ;GMRCTYPE=GMRC consult or GMRC request  GMRCSS=To Service
"RTN","GMRCHL7A",24,0)
 ;GMRCPLI=place of consultation          GMRCODT=observation date/time
"RTN","GMRCHL7A",25,0)
 ;GMRCATN=person to alert (attention)    GMRCSTDT=status change date/time
"RTN","GMRCHL7A",26,0)
 ;GMRCS123=results status (table 123)    GMRCINTR=results interpreter
"RTN","GMRCHL7A",27,0)
 ;GMRCPRI=procedure from file ^ORD(101,  
"RTN","GMRCHL7A",28,0)
 ;GMRCXMF=foreign consult service
"RTN","GMRCHL7A",29,0)
 ;        a flag that tells the HL7 routine that
"RTN","GMRCHL7A",30,0)
 ;        consults does not need to return CPRS a file
"RTN","GMRCHL7A",31,0)
 ;        IEN for file 123. See routine ^GMRCXMF
"RTN","GMRCHL7A",32,0)
 S GMRCPR=$P($P(GMRCOBR,SEP1,5),SEP2,6)
"RTN","GMRCHL7A",33,0)
 S GMRCTYPE=$S(GMRCPR="99PRO":"GMRCOR REQUEST",1:"GMRCOR CONSULT"),GMRCTYPE=$O(^ORD(101,"B",GMRCTYPE,0))
"RTN","GMRCHL7A",34,0)
 S GMRCPRI="",GMRCSS=""
"RTN","GMRCHL7A",35,0)
 I GMRCPR="99PRO" D
"RTN","GMRCHL7A",36,0)
 . S GMRCPRI=$P($P(GMRCOBR,SEP1,5),SEP2,4)
"RTN","GMRCHL7A",37,0)
 . S GMRCPRI=$S(+GMRCPRI:GMRCPRI_";ORD(101,",1:"")
"RTN","GMRCHL7A",38,0)
 . I +GMRCPRI S GMRCSS=+$P($G(^ORD(101,+GMRCPRI,5)),U,1)
"RTN","GMRCHL7A",39,0)
 . Q
"RTN","GMRCHL7A",40,0)
 E  S GMRCSS=$P($P(GMRCOBR,SEP1,5),SEP2,4)
"RTN","GMRCHL7A",41,0)
 ;
"RTN","GMRCHL7A",42,0)
 S GMRCOTXT=$P($P(GMRCOBR,SEP1,5),SEP2,5)
"RTN","GMRCHL7A",43,0)
 S GMRCODT=$P(GMRCOBR,SEP1,7) I GMRCODT]"" S GMRCODT=$$FMDATE^GMRCHL7(GMRCODT)
"RTN","GMRCHL7A",44,0)
 S GMRCPLI=$P(GMRCOBR,SEP1,19) I GMRCPLI]"" S GMRCPLI="GMRCPLACE - "_$S(GMRCPLI="OC":"ON CALL",GMRCPLI="B":"BEDSIDE",GMRCPLI="E":"EMERGENCY ROOM",1:GMRCPLI),GMRCPLI=$O(^ORD(101,"B",GMRCPLI,0))
"RTN","GMRCHL7A",45,0)
 S GMRCATN=$P(GMRCOBR,SEP1,20),GMRCSTDT=$P(GMRCOBR,SEP1,23),GMRCSTDT=$$FMDATE^GMRCHL7(GMRCSTDT)
"RTN","GMRCHL7A",46,0)
 S GMRCS123=$P(GMRCOBR,SEP1,26),GMRCINTR=$P(GMRCOBR,SEP1,33)
"RTN","GMRCHL7A",47,0)
 Q
"RTN","GMRCHL7A",48,0)
ZSV(GMRCZSV) ;Get service from ZSV segment and set into GMRCSS
"RTN","GMRCHL7A",49,0)
 S GMRCZSS=$P($P(GMRCZSV,SEP1,2),SEP2,4)
"RTN","GMRCHL7A",50,0)
 I +$G(GMRCZSS) S GMRCSS=+$G(GMRCZSS) ;Set the service if ZSV provided
"RTN","GMRCHL7A",51,0)
 Q
"RTN","GMRCHL7A",52,0)
OBX(GMRCOBX) ;Get fields from OBX segment and set into GMRC variables
"RTN","GMRCHL7A",53,0)
 ;GMRCVTYP=Value type from table 123 - i.e. TX(text), ST(string data),etc.
"RTN","GMRCHL7A",54,0)
 ;GMRCOID=observation id identifying value in seg. 5
"RTN","GMRCHL7A",55,0)
 ;GMRCVAL=observation value coded by segment 3
"RTN","GMRCHL7A",56,0)
 ;GMRCPRDG=provisional diagnosis
"RTN","GMRCHL7A",57,0)
 S GMRCMSG=MSG(GMRCOBX)
"RTN","GMRCHL7A",58,0)
 S GMRCVTYP=$P(GMRCMSG,SEP1,3),GMRCOID=$P($P(GMRCMSG,SEP1,4),SEP2,2),GMRCVAL=$P(GMRCOID,SEP2,3)
"RTN","GMRCHL7A",59,0)
 I GMRCOID="REASON FOR REQUEST" D
"RTN","GMRCHL7A",60,0)
 .S GMRCRFQ(1)=$P(GMRCMSG,SEP1,6)
"RTN","GMRCHL7A",61,0)
 .S LN=0 F  S LN=$O(MSG(GMRCOBX,LN)) Q:LN=""  S GMRCRFQ(LN+1)=MSG(GMRCOBX,LN)
"RTN","GMRCHL7A",62,0)
 .Q
"RTN","GMRCHL7A",63,0)
 I GMRCOID="PROVISIONAL DIAGNOSIS" S GMRCPRDG=$P(GMRCMSG,SEP1,6)
"RTN","GMRCHL7A",64,0)
 I GMRCOID["COMMENT" D
"RTN","GMRCHL7A",65,0)
 .S GMRCCMT(1)=$P(GMRCMSG,SEP1,6)
"RTN","GMRCHL7A",66,0)
 .S LN=0 F  S LN=$O(MSG(GMRCOBX,NL)) Q:LN=""  S GMRCCMT(LN+1)=MSG(GMRCOBX,LN)
"RTN","GMRCHL7A",67,0)
 .Q
"RTN","GMRCHL7A",68,0)
 K LN
"RTN","GMRCHL7A",69,0)
 Q
"RTN","GMRCHL7A",70,0)
EN(MSG) ;Entry point to routine
"RTN","GMRCHL7A",71,0)
 ;MSG = local array which contains the HL-7 segments
"RTN","GMRCHL7A",72,0)
 ;GMRCSEND=sending application   GMRCFAC=sending facility
"RTN","GMRCHL7A",73,0)
 ;GMRCMTP=message type
"RTN","GMRCHL7A",74,0)
 N DFN,GMRCACT,GMRCADD,GMRCFAC,GMRCMTP,GMRCPNM,GMRCO,GMRCOCR,GMRCORNP
"RTN","GMRCHL7A",75,0)
 N GMRCORFN,GMRCPLCR,GMRCRB,GMRCSEND,GMRCSTS,GMRCTRLC,GMRCWARD,ORIFN
"RTN","GMRCHL7A",76,0)
 N GMRCTRLC,GMRCAD,ORC,GMRCSBR,GMRCZSS,GMRCSS
"RTN","GMRCHL7A",77,0)
 S GMRCMSG="",GMRCNOD=0 F  S GMRCNOD=$O(MSG(GMRCNOD)) Q:GMRCNOD=""  S GMRCMSG=MSG(GMRCNOD) I $E(GMRCMSG,1,3)="MSH" D INIT^GMRCHL7U(GMRCMSG) D  Q
"RTN","GMRCHL7A",78,0)
 .S GMRCSEND=$P(GMRCMSG,SEP1,3),GMRCFAC=$P(GMRCMSG,SEP1,4),GMRCMTP=$P(GMRCMSG,SEP1,9)
"RTN","GMRCHL7A",79,0)
 .Q
"RTN","GMRCHL7A",80,0)
 S GMRCMSG="",GMRCNOD=0
"RTN","GMRCHL7A",81,0)
 F  S GMRCNOD=$O(MSG(GMRCNOD)) Q:GMRCNOD=""  S GMRCMSG=MSG(GMRCNOD) D
"RTN","GMRCHL7A",82,0)
 .I $E(GMRCMSG,1,3)="PID" D PID^GMRCHL7U(GMRCMSG) Q
"RTN","GMRCHL7A",83,0)
 .I $E(GMRCMSG,1,3)="PV1" D PV1^GMRCHL7U(GMRCMSG) Q
"RTN","GMRCHL7A",84,0)
 .I $E(GMRCMSG,1,3)="ORC" D ORC(GMRCMSG) Q
"RTN","GMRCHL7A",85,0)
 .I $E(GMRCMSG,1,3)="OBR" D OBR(GMRCMSG) Q
"RTN","GMRCHL7A",86,0)
 .I $E(GMRCMSG,1,3)="ZSV" D ZSV(GMRCMSG) Q
"RTN","GMRCHL7A",87,0)
 .I $E(GMRCMSG,1,3)="OBX" D OBX(GMRCNOD) Q
"RTN","GMRCHL7A",88,0)
 .I $E(GMRCMSG,1,3)="NTE" D NTE^GMRCHL7U(.MSG,GMRCNOD,GMRCO,GMRCTRLC) Q
"RTN","GMRCHL7A",89,0)
 .I $E(GMRCMSG,1,3)="ZXX" S GMRCOFN=+$P(GMRCMSG,SEP1,2) K MSG(GMRCNOD) Q 
"RTN","GMRCHL7A",90,0)
 .Q
"RTN","GMRCHL7A",91,0)
 ;Note, ZXX is not used yet; planned for future sharing consults with foreign facilities.
"RTN","GMRCHL7A",92,0)
 I '$D(GMRCTRLC) D EXIT^GMRCHL7U Q
"RTN","GMRCHL7A",93,0)
 I GMRCTRLC="Z@" D CPRSPURG^GMRCPURG(+GMRCO),EXIT^GMRCHL7U Q
"RTN","GMRCHL7A",94,0)
 I GMRCTRLC="NW" D NEW^GMRCHL7B D:'$D(GMRCXMF) RETURN^GMRCHL7U(GMRCO,GMRCTRLC) I $D(GMRCXMF) D
"RTN","GMRCHL7A",95,0)
 .;Set GMRCO=to the file number at this site for a new consult/request before sending HL-7 message to CPRS
"RTN","GMRCHL7A",96,0)
 .S GMRCNOD=0 F  S GMRCNOD=$O(@GMRCMSG(ND)) Q:GMRCNOD=""  I $P(@(GMRCMSG(NOD)),"|",1)="ORC" S $P(@(GMRCMSG(GMRCNOD)),"|",3)=$G(GMRCO) Q
"RTN","GMRCHL7A",97,0)
 .Q
"RTN","GMRCHL7A",98,0)
 I '$D(GMRCO) D EXIT^GMRCHL7U Q
"RTN","GMRCHL7A",99,0)
 I $S(GMRCTRLC="CA":1,GMRCTRLC="DC":1,1:0) D DC^GMRCHL7B(GMRCO,GMRCTRLC),RETURN^GMRCHL7U(GMRCO,GMRCTRLC)
"RTN","GMRCHL7A",100,0)
 I GMRCTRLC="NA" D RTN(GMRCORFN,GMRCO)
"RTN","GMRCHL7A",101,0)
 I GMRCTRLC="XX" D MODIFY^GMRCHL7B ;Not currently returned by CPRS
"RTN","GMRCHL7A",102,0)
 ; If consults sends an XX, CPRS returns an NA.
"RTN","GMRCHL7A",103,0)
 D EXIT^GMRCHL7U
"RTN","GMRCHL7A",104,0)
 Q
"RTN","GMRCHL7A",105,0)
RTN(GMRCORN,DA) ;Put ^OR(100, ien for order into ^GMR(123, 
"RTN","GMRCHL7A",106,0)
 S DIE="^GMR(123,",DR=".03////^S X=GMRCORN"
"RTN","GMRCHL7A",107,0)
 L +^GMR(123,DA) D ^DIE L -^GMR(123,DA)
"RTN","GMRCHL7A",108,0)
 K DIE,DR
"RTN","GMRCHL7A",109,0)
 Q
"RTN","GMRCHL7B")
0^11^B15129415
"RTN","GMRCHL7B",1,0)
GMRCHL7B ;SLC/DCM - Process order parameters from ^GMRCHL7A and place data into ^GMR(123 global ;9/8/98  03:51
"RTN","GMRCHL7B",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCHL7B",3,0)
NEW ;Add new order
"RTN","GMRCHL7B",4,0)
 ;GMRCO=^GMR(123,IFN, the new file number in file ^GMR(123,
"RTN","GMRCHL7B",5,0)
 ;GMRCORFN=OE/RR file number       GMRCWARD=ward patient is on
"RTN","GMRCHL7B",6,0)
 ;GMRCSS=service consult sent to   GMRCAD=date/time of request
"RTN","GMRCHL7B",7,0)
 ;GMRCPRI=procedure/request        GMRCURGI=urgency
"RTN","GMRCHL7B",8,0)
 ;GMRCATN=attention                GMRCSTS=OE/RR order status
"RTN","GMRCHL7B",9,0)
 ;GMRCORNP=patient's provider      GMRCTYPE=request type (request or consult)
"RTN","GMRCHL7B",10,0)
 ;GMRCSBR=service rendered on what basis (Inpatient, or Outpatient)
"RTN","GMRCHL7B",11,0)
 ;GMRCRFQ=reason for request array - word processing fields
"RTN","GMRCHL7B",12,0)
 ;GMRCOTXT=order display text from dialog or orderable item
"RTN","GMRCHL7B",13,0)
 N DIC,DLAYGO,X,DR,DIE,GMRCADUZ
"RTN","GMRCHL7B",14,0)
 S DIC="^GMR(123,",DIC(0)="L",X="""N""",DLAYGO=123 D ^DIC K DLAYGO Q:Y<1
"RTN","GMRCHL7B",15,0)
 S (DA,GMRCO)=+Y,GMRCSTS=5,GMRCA=1,DIE=DIC
"RTN","GMRCHL7B",16,0)
 L +^GMR(123,GMRCO)
"RTN","GMRCHL7B",17,0)
 S DR=".02////^S X=DFN;.03////^S X=GMRCORFN;.04////^S X=GMRCWARD;.05////^S X=GMRCFAC;.06////^S X=$G(GMRCOFN);1////^S X=GMRCSS;2////^S X=$G(GMRCWARD);3////^S X=GMRCAD;4////^S X=GMRCPRI;5////^S X=GMRCURGI;7////^S X=$G(GMRCATN)"
"RTN","GMRCHL7B",18,0)
 D ^DIE
"RTN","GMRCHL7B",19,0)
 ;Added new field .1 to DR on 7/11/98 to save the order text
"RTN","GMRCHL7B",20,0)
 S DR="6////^S X=GMRCPLI;8////^S X=GMRCSTS;9////^S X=GMRCA;10////^S X=GMRCORNP;13////^S X=GMRCTYPE;14////^S X=$G(GMRCSBR);30////^S X=$G(GMRCPRDG);.1////^S X=$G(GMRCOTXT)"
"RTN","GMRCHL7B",21,0)
 D ^DIE
"RTN","GMRCHL7B",22,0)
 I $O(GMRCRFQ(0)) D REASON
"RTN","GMRCHL7B",23,0)
 L -^GMR(123,GMRCO)
"RTN","GMRCHL7B",24,0)
 S GMRCA=1 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",25,0)
 I $D(GMRCXMF),$D(GMRCOFN) S $P(^GMR(123,GMRCO,0),"^",21)=GMRCOFN
"RTN","GMRCHL7B",26,0)
 I $D(GMRCACTN) S GMRCADUZ(GMRCACTN)=""
"RTN","GMRCHL7B",27,0)
 D ALERT^GMRCHL7U(DFN,GMRCSS,GMRCPRI,GMRCO,GMRCURGI,"")
"RTN","GMRCHL7B",28,0)
 D PRNT^GMRCUTL1(GMRCSS,GMRCO) ;contains print audit update
"RTN","GMRCHL7B",29,0)
 D EXIT
"RTN","GMRCHL7B",30,0)
 Q
"RTN","GMRCHL7B",31,0)
DC(GMRCO,ACTRL) ;Discontinue request from OERR
"RTN","GMRCHL7B",32,0)
 ;Denied request also gets this action. Deny request updates status to dc
"RTN","GMRCHL7B",33,0)
 ;GMRCO=IEN of record in file ^GMR(123, i.e., ^GMR(123,DA,
"RTN","GMRCHL7B",34,0)
 ;ACTRL=GMRCCTRL=control code defining action -
"RTN","GMRCHL7B",35,0)
 ;         DC control code = action DC for discontinued 
"RTN","GMRCHL7B",36,0)
 ;         CA control code = action DY for denied
"RTN","GMRCHL7B",37,0)
 ;Update the last action taken, order status, and processing activity
"RTN","GMRCHL7B",38,0)
 Q:'$L(GMRCO)
"RTN","GMRCHL7B",39,0)
 N GMRCSVC,GMRCDFN,GMRCFL,GMRCADUZ,GMRCRQR,DA
"RTN","GMRCHL7B",40,0)
 S GMRCACT=$O(^GMR(123.1,"D",ACTRL,0))
"RTN","GMRCHL7B",41,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",42,0)
 S DIE="^GMR(123,",DA=GMRCO
"RTN","GMRCHL7B",43,0)
 S DR="8////^S X=GMRCSTS;9////^S X=GMRCACT" ; upd status + last action
"RTN","GMRCHL7B",44,0)
 D ^DIE
"RTN","GMRCHL7B",45,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",46,0)
 ; send 513 back through service printer if order DC'd
"RTN","GMRCHL7B",47,0)
 I $G(ACTRL)="DC" D PRNT^GMRCUTL1(+$P(^GMR(123,GMRCO,0),U,5),GMRCO)
"RTN","GMRCHL7B",48,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCHL7B",49,0)
 S GMRCFL=1,GMRCADUZ=""
"RTN","GMRCHL7B",50,0)
 S GMRCRQR=+$P($G(^GMR(123,+GMRCO,0)),"^",14)
"RTN","GMRCHL7B",51,0)
 I +GMRCRQR,GMRCRQR'=DUZ S GMRCADUZ(GMRCRQR)=""
"RTN","GMRCHL7B",52,0)
 S GMRCSVC=$P($G(^GMR(123,+GMRCO,0)),"^",5)
"RTN","GMRCHL7B",53,0)
 I +GMRCSVC S GMRCSVC=$S($D(^GMR(123.5,GMRCSVC,.1)):^(.1),1:$P(^GMR(123.5,GMRCSVC,0),"^",1))
"RTN","GMRCHL7B",54,0)
 E  S GMRCSVC="Unknown Service: Consult # "_GMRCO
"RTN","GMRCHL7B",55,0)
 S GMRCORTX=$S(ACTRL="DC":"Discontinued",1:"Cancelled")_" Consult "_$$ORTX^GMRCAU(GMRCO)
"RTN","GMRCHL7B",56,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,$S(ACTRL="DC":23,1:30),.GMRCADUZ,GMRCFL)
"RTN","GMRCHL7B",57,0)
 D EXIT
"RTN","GMRCHL7B",58,0)
 Q
"RTN","GMRCHL7B",59,0)
MODIFY ;Change an order/request when an HL7 'XX' code is received
"RTN","GMRCHL7B",60,0)
 ;This is currently not used.
"RTN","GMRCHL7B",61,0)
 ;    When Consults sends an XX, CPRS returns NA with a new order ien.
"RTN","GMRCHL7B",62,0)
 ;GMRCACT=processing activity - from file ^GMR(123.1,
"RTN","GMRCHL7B",63,0)
 S DIE="^GMR(123,",DA=+GMRCO
"RTN","GMRCHL7B",64,0)
 S GMRCWARD=$G(GMRCWARD),GMRCPRI=$G(GMRCPRI),GMRCURGI=$G(GMRCURGI),GMRCSTS=$G(GMRCSTS),GMRCTYPE=$G(GMRCTYPE),GMRCSS=$G(GMRCSS)
"RTN","GMRCHL7B",65,0)
 S GMRCACT=$O(^GMR(123.1,"D",GMRCTRLC,0))
"RTN","GMRCHL7B",66,0)
 S GMRCSTS=$P(^GMR(123.1,GMRCACT,0),"^",2)
"RTN","GMRCHL7B",67,0)
 S DIE=123,DR=".04////^S X=$G(GMRCWARD);1////^S X=$G(GMRCSS);4////^S X=$G(GMRCPRI);5////^S X=$G(GMRCURGI);8////^S X=$G(GMRCSTS);9////^S X=GMRCACT"
"RTN","GMRCHL7B",68,0)
 D ^DIE
"RTN","GMRCHL7B",69,0)
 D AUDIT0^GMRCHL7U
"RTN","GMRCHL7B",70,0)
 D EXIT Q
"RTN","GMRCHL7B",71,0)
REASON ;load the reason for request into ^GMR(123,IFN,20
"RTN","GMRCHL7B",72,0)
 S ^GMR(123,GMRCO,20,0)="^^^"_$S($D(GMRCDA):GMRCDA,1:DT)_"^"
"RTN","GMRCHL7B",73,0)
 S L=0,LN=1 F  S L=$O(GMRCRFQ(L)) Q:L=""  S ^GMR(123,GMRCO,20,LN,0)=GMRCRFQ(L),LN=LN+1
"RTN","GMRCHL7B",74,0)
 S LN=LN-1,$P(^GMR(123,GMRCO,20,0),"^",3)=LN
"RTN","GMRCHL7B",75,0)
 K L,LN
"RTN","GMRCHL7B",76,0)
 Q
"RTN","GMRCHL7B",77,0)
COMMENT(GMRCARY) ;add comments to the record.  Add the comment header, then the comment lines, and lastly, the number of comment lines to the header
"RTN","GMRCHL7B",78,0)
 ;GMRCARY= GMRCNTC array
"RTN","GMRCHL7B",79,0)
 S LN=0,^GMR(123,GMRCO,40,DA,1,0)="^^^^"_$P(GMRCDA,".",1)_"^"
"RTN","GMRCHL7B",80,0)
 F  S LN=$O(GMRCARY(LN)) Q:LN=""  S ^GMR(123,+GMRCO,40,DA,1,LN,0)=GMRCARY(LN),LN1=LN
"RTN","GMRCHL7B",81,0)
 S $P(^GMR(123,+GMRCO,40,DA,1,0),"^",3,4)=LN1_"^"_LN1
"RTN","GMRCHL7B",82,0)
 K LN,LN1 Q
"RTN","GMRCHL7B",83,0)
 Q
"RTN","GMRCHL7B",84,0)
EXIT ;kill off all variables
"RTN","GMRCHL7B",85,0)
 K DA,DIC,DIE,DR,GMRCORTX,GMRCADUZ
"RTN","GMRCHL7B",86,0)
 Q
"RTN","GMRCHL7U")
0^12^B17092200
"RTN","GMRCHL7U",1,0)
GMRCHL7U ;SLC/DCM - Utilities associated with HL7 messages ;9/8/98  03:53
"RTN","GMRCHL7U",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCHL7U",3,0)
INIT(MSH) ;break out MSH segment separaters and set other neeed variables
"RTN","GMRCHL7U",4,0)
 ;MSH = MSH segment of the HL-7 message
"RTN","GMRCHL7U",5,0)
 N X
"RTN","GMRCHL7U",6,0)
 S (SEP1,SEP2,SEP3,SEP4,SEP5)=""
"RTN","GMRCHL7U",7,0)
 S SEP1=$E(MSH,4),X=$P(MSH,SEP1,2)
"RTN","GMRCHL7U",8,0)
 S SEP2=$E(X,1),SEP3=$E(X,2),SEP4=$E(X,3),SEP5=$E(X,4)
"RTN","GMRCHL7U",9,0)
 Q
"RTN","GMRCHL7U",10,0)
PID(GMRCPID) ;Get fields from PID segment and set into GMRC variables.
"RTN","GMRCHL7U",11,0)
 S DFN=$P(GMRCPID,SEP1,4),GMRCPNM=$P(GMRCPID,SEP1,6)
"RTN","GMRCHL7U",12,0)
 Q
"RTN","GMRCHL7U",13,0)
NTE(MSG,GMRCNTE,GMRCNODE,CTRLCODE) ;set NTE segments of HL-7 message into variables and globals
"RTN","GMRCHL7U",14,0)
 ;MSG = whole HL-7 array.
"RTN","GMRCHL7U",15,0)
 ;GMRCNTE = Node in array where NTE message begins
"RTN","GMRCHL7U",16,0)
 ;CTRLCODE = segment 1 of the ORC segment of HL-7 message
"RTN","GMRCHL7U",17,0)
 ;GMRCNODE = IEN of entry int file ^GMR(123,
"RTN","GMRCHL7U",18,0)
 N GMRCACT ;not sure why this is newed here
"RTN","GMRCHL7U",19,0)
 S GMRCAD=$G(GMRCAD),GMRCORNP=$G(GMRCORNP),GMRCFF=$G(GMRCFF),GMRCPA=$G(GMRCPA),GMRCDEV=$G(GMRCDEV)
"RTN","GMRCHL7U",20,0)
 S GMRCACT=$S(CTRLCODE="CA":19,CTRLCODE="DC":6,CTRLCODE="NW":1,1:$O(^GMR(123.1,"D",CTRLCODE,0)))
"RTN","GMRCHL7U",21,0)
 S GMRCNTC(1)=$P(MSG(GMRCNTE),SEP1,4)
"RTN","GMRCHL7U",22,0)
 S LN=0,LN1=2 F  S LN=$O(MSG(GMRCNTE,LN)) Q:LN=""  S GMRCNTC(LN1)=MSG(GMRCNTE,LN),LN1=LN1+1
"RTN","GMRCHL7U",23,0)
 K LN,LN1
"RTN","GMRCHL7U",24,0)
 Q
"RTN","GMRCHL7U",25,0)
PV1(GMRCPV1) ;Get fields from PV1 segment of HL-7 message and set into GMRC variables
"RTN","GMRCHL7U",26,0)
 ;GMRCRB  = patients room/bed            GMRCWARD=patients ward
"RTN","GMRCHL7U",27,0)
 ;GMRCSBR = service basis to be rendered (Inpatient or Outpatient)
"RTN","GMRCHL7U",28,0)
 N X
"RTN","GMRCHL7U",29,0)
 S X=$P(GMRCPV1,SEP1,3),GMRCSBR=$S(X]"":X,1:"")
"RTN","GMRCHL7U",30,0)
 S X=$P(GMRCPV1,SEP1,4),GMRCWARD=$S($P(X,SEP2,1)]"":$P(X,SEP2,1),1:""),VISIT=$S($P(GMRCPV1,SEP1,20)]"":$P(GMRCPV1,SEP1,20),1:"")
"RTN","GMRCHL7U",31,0)
 S GMRCRB=$S($P(X,SEP2,2)]"":$P(X,SEP2,2),1:"")
"RTN","GMRCHL7U",32,0)
 S:VISIT]"" GMRCVSIT=$$FMDATE^GMRCHL7(VISIT)
"RTN","GMRCHL7U",33,0)
 Q
"RTN","GMRCHL7U",34,0)
RETURN(GMRCIEN,GMRCTRLC) ;return IEN of record in ^GMR(123,IEN, to OERR
"RTN","GMRCHL7U",35,0)
 ;GMRCIEN = internal record number of record in ^GMR(123,
"RTN","GMRCHL7U",36,0)
 ;GMRCTRLC=Control code from HL-7 Table 119
"RTN","GMRCHL7U",37,0)
 N MSH,PID,ORC
"RTN","GMRCHL7U",38,0)
 S SEP1="|",GMRCORCC=$S(GMRCTRLC="NW":"OK",GMRCTRLC="DC":"DR",1:"OK")
"RTN","GMRCHL7U",39,0)
 S MSH=$$MSH^GMRCHL7($G(X)) S $P(MSH,SEP1,9)="ORR"
"RTN","GMRCHL7U",40,0)
 S PID=$$PID^GMRCHL7(GMRCIEN)
"RTN","GMRCHL7U",41,0)
 D ORC^GMRCHL7(GMRCIEN,GMRCORCC,"") S ORC=$P(ORC,"|",1,4)
"RTN","GMRCHL7U",42,0)
 D BLD^GMRCHL7(MSH,PID,"",ORC,"","","",GMRCTRLC)
"RTN","GMRCHL7U",43,0)
 D MSG^XQOR("GMRC EVSEND OR",.GMRCMSG)
"RTN","GMRCHL7U",44,0)
 K GMRCORCC
"RTN","GMRCHL7U",45,0)
 Q
"RTN","GMRCHL7U",46,0)
FILE(GMRCO,DR) ;File data into ^GMR(123,IEN,40 using ^DIE
"RTN","GMRCHL7U",47,0)
 N DIE,DA
"RTN","GMRCHL7U",48,0)
 ;GMRCO = IEN of record from file ^GMR(123,
"RTN","GMRCHL7U",49,0)
 ;DR = DR string required by ^DIE
"RTN","GMRCHL7U",50,0)
 L +^GMR(123,+GMRCO,40) S:'$D(^GMR(123,+GMRCO,40,0)) ^(0)="^123.02DA^^"
"RTN","GMRCHL7U",51,0)
 S DA=$S($P(^GMR(123,+GMRCO,40,0),"^",3):$P(^(0),"^",3)+1,1:1),DA(1)=+GMRCO
"RTN","GMRCHL7U",52,0)
 S DIE="^GMR(123,"_GMRCO_",40,"
"RTN","GMRCHL7U",53,0)
 S $P(^GMR(123,+GMRCO,40,0),"^",3,4)=DA_"^"_DA
"RTN","GMRCHL7U",54,0)
 D ^DIE
"RTN","GMRCHL7U",55,0)
 I $D(GMRCNTC) D COMMENT^GMRCHL7B(.GMRCNTC)
"RTN","GMRCHL7U",56,0)
 I $D(GMRCCMT) D COMMENT^GMRCHL7B(.GMRCCMT)
"RTN","GMRCHL7U",57,0)
 L -^GMR(123,+GMRCO,40)
"RTN","GMRCHL7U",58,0)
 Q
"RTN","GMRCHL7U",59,0)
EXIT ;Kill variables and exit
"RTN","GMRCHL7U",60,0)
 K HLQ,J,LN,ND,ND1,ND2,SEP1,SEP2,SEP3,SEP4,SEP5
"RTN","GMRCHL7U",61,0)
 K GMRCA,GMRCACT,GMRCAD,GMRCAP,GMRCAPP,GMRCATN,GMRCDA,GMRCDEV,GMRCFAC,GMRCFF,GMRCINTR,GMRCMTP,GMRCMSG,GMRCMSH,GMRCNOD,GMRCNTC,GMRCODT,GMRCOID,GMRCORFN,GMRCPA,GMRCPLCR,GMRCPLI,GMRCPNM,GMRCPR,GMRCPRI,GMRCFQ
"RTN","GMRCHL7U",62,0)
 K GMRCPRDG,GMRCSEND,GMRCSTDT,GMRCSTS,GMRCURGI,GMRCVAL,GMRCVTYP,GMRCWARD,GMRCPRV,GMRCTYPE,GMRCND,GMRCND1,VISIT
"RTN","GMRCHL7U",63,0)
 K GMRCRB,GMRCPRA,GMRCRFQ,MSH,OBXND,PID,GMRCORPV,GMRCOTXT
"RTN","GMRCHL7U",64,0)
 K:'$D(GMRCXMF) GMRCTRLC,GMRCSS,GMRCO,GMRCORNP
"RTN","GMRCHL7U",65,0)
 Q
"RTN","GMRCHL7U",66,0)
AUDIT0 ;place activity audit tracking info into global ^GMR(123,IEN,40,
"RTN","GMRCHL7U",67,0)
 ;GMRCACT=processing activity (from ^GMR(123.1,
"RTN","GMRCHL7U",68,0)
 ;GMRCDA=date/time file entered     GMRCAD=date/time activity took place
"RTN","GMRCHL7U",69,0)
 ;GMRCORNP=name of provider         GMRCFF=forwared from (if forwarded)
"RTN","GMRCHL7U",70,0)
 ;GMRCPA=provider previously assigned
"RTN","GMRCHL7U",71,0)
 ;GMRCDEV=device printed to        GMRCCMT=comment array from OBX segment
"RTN","GMRCHL7U",72,0)
 S X="NOW" D NOW^%DTC S GMRCDA=%
"RTN","GMRCHL7U",73,0)
 L +^GMR(123,+GMRCO,40) S:'$D(^GMR(123,+GMRCO,40,0)) ^GMR(123,+GMRCO,40,0)="^123.02DA^^"
"RTN","GMRCHL7U",74,0)
 S GMRCAD=$S($D(GMRCAD):GMRCAD,1:GMRCDA),GMRCORNP=$G(GMRCORNP),GMRCFF=$G(GMRCFF),GMRCPA=$G(GMRCPA),GMRCDEV=$G(GMRCDEV),GMRCPLCR=$G(GMRCPLCR)
"RTN","GMRCHL7U",75,0)
 ;Use the Control code from CPRS in 123.1 to determine the action.
"RTN","GMRCHL7U",76,0)
 ;If action undefined, then use "ADDED COMMENT", entry 20.
"RTN","GMRCHL7U",77,0)
 S GMRCACT=$O(^GMR(123.1,"D",GMRCTRLC,0))
"RTN","GMRCHL7U",78,0)
 S:'GMRCACT GMRCACT=20
"RTN","GMRCHL7U",79,0)
 S DR=".01////^S X=GMRCDA;1////^S X=GMRCACT;2////^S X=GMRCAD;3////^S X=GMRCORNP;4////^S X=GMRCPLCR;6////^S X=GMRCFF;7////^S X=GMRCPA;8////^S X=GMRCDEV"
"RTN","GMRCHL7U",80,0)
 D FILE(GMRCO,DR)
"RTN","GMRCHL7U",81,0)
 L -^GMR(123,+GMRCO,40)
"RTN","GMRCHL7U",82,0)
 Q
"RTN","GMRCHL7U",83,0)
ALERT(GMRCDFN,GMRCSS,GMRCPR,GMRCFN,GMRCURG,GMRCORA) ;generate an alert when receiving a consult
"RTN","GMRCHL7U",84,0)
 ;GMRCDFN=patient DFN from file 2
"RTN","GMRCHL7U",85,0)
 ;GMRCSS=Service
"RTN","GMRCHL7U",86,0)
 ;GMRCPR=procedure being ordered
"RTN","GMRCHL7U",87,0)
 ;GMRCFN=File 123 IEN
"RTN","GMRCHL7U",88,0)
 ;GMRCURG=urgency of request from protocol file
"RTN","GMRCHL7U",89,0)
 ;GMRCADUZ=array of those who receive alerts
"RTN","GMRCHL7U",90,0)
 ;GMRCORA=action to take on alert: 27 is for new alert
"RTN","GMRCHL7U",91,0)
 N GMRCORTX
"RTN","GMRCHL7U",92,0)
 S GMRCORTX="New consult "_$$ORTX^GMRCAU(+GMRCO)_$S(+GMRCURG:" ("_$P(^ORD(101,+GMRCURG,0),"^",2)_")",1:"")
"RTN","GMRCHL7U",93,0)
 S:'$D(GMRCORA) GMRCORA=27 S:GMRCORA="" GMRCORA=27
"RTN","GMRCHL7U",94,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,GMRCFN,GMRCORA,.GMRCADUZ,1)
"RTN","GMRCHL7U",95,0)
 K GMRCADUZ
"RTN","GMRCHL7U",96,0)
 Q
"RTN","GMRCPR0")
0^13^B15604442
"RTN","GMRCPR0",1,0)
GMRCPR0 ; SLC/DLT - Data Entry Promptint actions ;9/8/98  03:59
"RTN","GMRCPR0",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCPR0",3,0)
ASK ;ASK FOR TO, PROCEDURE,URGENCY, AND PLACE OF CONSULT
"RTN","GMRCPR0",4,0)
 I $D(GMRCPR),'$D(GMRCPRI) S GMRCPRI=+GMRCPR_";ORD(101,",GMRCORSV=$S(+^ORD(101,+GMRCPR,5):+^(5),1:GMRCSS),GMRCSRVC=$P(^GMR(123.5,GMRCORSV,0),"^",1) K GMRCORSV
"RTN","GMRCPR0",5,0)
 I $S('$D(GMRCPR):1,GMRCPR="":1,1:0) D PROC Q:GMRCEND  S GMRCORSV=^ORD(101,+GMRCPRI,5),GMRCORSV=+GMRCORSV,GMRCSRVC=$P(^GMR(123.5,GMRCORSV,0),"^",1) K GMRCORSV
"RTN","GMRCPR0",6,0)
 I '$D(GMRCSRVC) S GMRCSRVC=GMRCSSNM
"RTN","GMRCPR0",7,0)
ASK1 I $L(GMRCWARD) S GMRCIOPT="I"
"RTN","GMRCPR0",8,0)
 E  S GMRCIOPT="O"
"RTN","GMRCPR0",9,0)
 S DIR(0)="123,14",DIR("A")="Service rendered on (I)npatient or (O)utpatient basis?",DIR("B")=GMRCIOPT D ^DIR K DIR I $D(DTOUT)!($D(DUOUT))!($D(DIROUT)) S GMRCEND=1 K DTOUT,DUOUT,DIROUT Q
"RTN","GMRCPR0",10,0)
 S GMRCIOPT=Y
"RTN","GMRCPR0",11,0)
 I GMRCIOPT="I" S X="GMRCURGENCYM REQ - INPATIENT"
"RTN","GMRCPR0",12,0)
 E  S X="GMRCURGENCYM - OUTPATIENT"
"RTN","GMRCPR0",13,0)
 S DIC=101,DIC(0)="X" D ^DIC K DIC Q:Y<0
"RTN","GMRCPR0",14,0)
 S XQORM("??")="D URGHELP^GMRCPH",XQORM=+Y_";ORD(101,",XQORM(0)="1A\"
"RTN","GMRCPR0",15,0)
 S XQORM("A")="URGENCY: ",XQORM("NO^^")=""
"RTN","GMRCPR0",16,0)
 S GMRCURG1=$G(^DISV(DUZ,"XQORM",XQORM,1)) I '$L(GMRCURG1) K GMRCURG1
"RTN","GMRCPR0",17,0)
 I $D(GMRCURG1) S GMRCURG1=$$UP^XLFSTR(GMRCURG1) I $O(^XUTL("XQORM",XQORM,"B",GMRCURG1,0)) S XQORM("B")=^DISV(DUZ,"XQORM",XQORM,1)
"RTN","GMRCPR0",18,0)
 F  D  Q:Y  I $D(GMRCEND),GMRCEND Q
"RTN","GMRCPR0",19,0)
 .K GMRCURG1
"RTN","GMRCPR0",20,0)
 .D EN^XQORM I X="^"!($D(DIROUT)) S GMRCEND=1 K DIROUT,DTOUT,DUOUT Q
"RTN","GMRCPR0",21,0)
 .I Y<0 S GMRCMSG="The URGENCY is a required response." D EXAC^GMRCADC(GMRCMSG) K GMRCMSG
"RTN","GMRCPR0",22,0)
 .Q
"RTN","GMRCPR0",23,0)
 I $D(GMRCEND),GMRCEND Q
"RTN","GMRCPR0",24,0)
 I $D(Y(1)) S GMRCURG=$P(Y(1),"^",3),GMRCURGI=$P(Y(1),"^",2)
"RTN","GMRCPR0",25,0)
 I GMRCIOPT="I" S X="GMRCPLACEM - INPATIENT"
"RTN","GMRCPR0",26,0)
 E  S X="GMRCPLACEM - OUTPATIENT"
"RTN","GMRCPR0",27,0)
 S DIC=101,DIC(0)="X" D ^DIC Q:Y<0
"RTN","GMRCPR0",28,0)
 K XQORM S XQORM("??")="D PLHELP^GMRCPH",XQORM=+Y_";ORD(101,",XQORM(0)="1A\"
"RTN","GMRCPR0",29,0)
 S XQORM("A")="PLACE OF CONSULTATION: "
"RTN","GMRCPR0",30,0)
 S XQORM("B")=$P($G(^XUTL("XQORM",XQORM,1.1,0)),U,3),XQORM("NO^^")=""
"RTN","GMRCPR0",31,0)
 D EN^XQORM I X="^"!($D(DIROUT)) K XQORM,DIROUT,DTOUT,DUOUT S GMRCEND=1 Q
"RTN","GMRCPR0",32,0)
 I Y<0 D  Q:+$G(GMRCEND)
"RTN","GMRCPR0",33,0)
 .W $C(7),!!,"  The PLACE OF CONSULTATION is a required response!",!
"RTN","GMRCPR0",34,0)
 .D EN^XQORM K XQORM I X="^"!($D(DIROUT))!(Y<1) K DIROUT,DTOUT,DUOUT S GMRCEND=1 Q
"RTN","GMRCPR0",35,0)
 K XQORM I $D(Y(1)) S GMRCPL=$P(Y(1),"^",3),GMRCPLI=$P(Y(1),"^",2)
"RTN","GMRCPR0",36,0)
 Q
"RTN","GMRCPR0",37,0)
TO ;Get Service from File Link field
"RTN","GMRCPR0",38,0)
 S GMRCSS=$P($G(^ORD(101,+GMRCPRI,5)),"^")
"RTN","GMRCPR0",39,0)
 I '+GMRCSS D ASKTO Q:GMRCEND
"RTN","GMRCPR0",40,0)
 I +GMRCSS S GMRCSS=+GMRCSS,GMRCSSNM=$P($G(^GMR(123.5,GMRCSS,.1)),"^") I '$L(GMRCSSNM) S GMRCSSNM=$P($G(^GMR(123.5,GMRCSS,0)),"^",1)
"RTN","GMRCPR0",41,0)
 S ORTO=$O(^ORD(100.98,"B","CONSULTS",""))
"RTN","GMRCPR0",42,0)
 Q
"RTN","GMRCPR0",43,0)
ASKTO ;Ask for service when file link not defined in protocol file
"RTN","GMRCPR0",44,0)
 D SERV^GMRCPS I 'GMRCDG S GMRCEND=1 Q
"RTN","GMRCPR0",45,0)
 S GMRCSS=GMRCDG
"RTN","GMRCPR0",46,0)
 Q
"RTN","GMRCPR0",47,0)
PROC ;Use XQORM to select procedure
"RTN","GMRCPR0",48,0)
 S GMRCEND=0 N XQORM
"RTN","GMRCPR0",49,0)
 S DIC=101,X="GMRCRM REQUEST TYPES",DIC(0)="X" D ^DIC Q:Y<0
"RTN","GMRCPR0",50,0)
 S XQORM("??")="D PROCHELP^GMRCPH",XQORM=+Y_";ORD(101,",XQORM(0)="1A\",XQORM("A")="Select PROCEDURE: ",XQORM("NO^^")="" I $D(GMRCPR),$L(GMRCPR) S XQORM("B")=GMRCPR
"RTN","GMRCPR0",51,0)
 D EN^XQORM K XQORM I X="^"!('$L(X))!($D(DIROUT)) S (GMRCQUT,GMRCEND)=1 K DIROUT,DTOUT,DUOUT Q
"RTN","GMRCPR0",52,0)
 I $D(Y(1)) S (GMRCVP,GMRCPRI)=$P(Y(1),"^",2)_";ORD(101,",GMRCPR=$S($D(^ORD(101,$P(Y(1),"^",2),.1)):$P(^(.1),"^"),1:"") I '$L(GMRCPR) S GMRCPR=$P(Y(1),"^",3)
"RTN","GMRCPR0",53,0)
 S X=$S($D(^ORD(101,+GMRCPRI,20)):$P(^(20)," D ",1),1:"") X:X]"" X S GMRCEN=$S($G(GMRCEN)]"":GMRCEN,1:""),GMRCTYPE=$S(GMRCEN="R":"GMRCOR REQUEST",1:"GMRCOR CONSULT")
"RTN","GMRCPR0",54,0)
 Q
"RTN","GMRCPR0",55,0)
 ;
"RTN","GMRCPR0",56,0)
GETSVC(SLIST,PROC) ;Get the services that process a procedure type (GMRCR protocol entry)
"RTN","GMRCPR0",57,0)
 N SVC,SCNT
"RTN","GMRCPR0",58,0)
 I '+$G(PROC) Q
"RTN","GMRCPR0",59,0)
 S SCNT=0,SLIST=SCNT
"RTN","GMRCPR0",60,0)
 S SVC=0
"RTN","GMRCPR0",61,0)
 F  S SVC=$O(^GMR(123.5,"APR",PROC,SVC)) Q:'SVC  D
"RTN","GMRCPR0",62,0)
 . S SCNT=SCNT+1
"RTN","GMRCPR0",63,0)
 . S SLIST(SCNT)=SVC_"^"_$P($G(^GMR(123.5,SVC,0)),U,1)
"RTN","GMRCPR0",64,0)
 . Q
"RTN","GMRCPR0",65,0)
 S SLIST=SCNT
"RTN","GMRCPR0",66,0)
 Q
"RTN","GMRCR")
0^16^B16413390
"RTN","GMRCR",1,0)
GMRCR ;SLC/DLT - Driver for reviewing patient consult/requests - Used by Medicine Package to link Consults to Medicine results ;9/18/98  16:26
"RTN","GMRCR",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCR",3,0)
EN ;Entry point for medicine results entry by procedure or consult type
"RTN","GMRCR",4,0)
 ;Required variables:
"RTN","GMRCR",5,0)
 ;  GMRCPRNM = name of procedure file with results.
"RTN","GMRCR",6,0)
 ;  DFN = patient file (2) ien
"RTN","GMRCR",7,0)
 ;Optional variables:
"RTN","GMRCR",8,0)
 ;  GMRCSR = variable pointer for results
"RTN","GMRCR",9,0)
 ;  ORSTS = order status
"RTN","GMRCR",10,0)
 ;  GMRCI = 0 or undefined, assume interactive
"RTN","GMRCR",11,0)
 ;          1, assume non-interactive - not operational currently
"RTN","GMRCR",12,0)
 ;Returned variables:
"RTN","GMRCR",13,0)
 ;  ORIFN = Pointer to the consult order in file 100
"RTN","GMRCR",14,0)
 ;  GMRCO = Pointer to the Request/Consultation entry in file 123.5
"RTN","GMRCR",15,0)
 ;
"RTN","GMRCR",16,0)
 K DTOUT,DUOUT,ORIFN,GMRCO,GMRCX
"RTN","GMRCR",17,0)
 I '$D(GMRCPNM) D DEM^GMRCU
"RTN","GMRCR",18,0)
 I $D(GMRCPRNM) S GMRC=$O(^ORD(101,"B","GMRCR "_GMRCPRNM,0)),GMRCTYPE="GMRCOR REQUEST"
"RTN","GMRCR",19,0)
 E  I $D(GMRCPR) S GMRC=GMRCPR,GMRCTYPE="GMRCOR REQUEST"
"RTN","GMRCR",20,0)
 I $D(GMRCCT) S GMRC=GMRCCT,GMRCTYPE="GMRCOR CONSULT"
"RTN","GMRCR",21,0)
 I $D(GMRC)=1!($D(GMRC)=11),+GMRC D
"RTN","GMRCR",22,0)
 .S GMRCVP=GMRC_";ORD(101,",GMRCNM=$S($D(^ORD(101,GMRC,0)):$P(^(0),"^",2),1:"")
"RTN","GMRCR",23,0)
 .S GMRCSS=$P($G(^ORD(101,+GMRCVP,5)),"^"),GMRCSS=+GMRCSS
"RTN","GMRCR",24,0)
EN1 ;Entry point for
"RTN","GMRCR",25,0)
 Q  I 'GMRCSS D ASRV^GMRCASV D  Q:GMRCEND  S GMRCSS=+GMRCDG I 'GMRCDG S GMRCEND=1 K GMRCSS Q
"RTN","GMRCR",26,0)
 .I $D(DTOUT)!($D(DIROUT)) S GMRCEND=1 K DTOUT,DIROUT,DIRUT,DUOUT Q
"RTN","GMRCR",27,0)
 .Q
"RTN","GMRCR",28,0)
 E  S GMRCDG=GMRCSS D SERV1^GMRCASV
"RTN","GMRCR",29,0)
 I '$D(ORTKG) S ORTKG=$$PACKAGE I ORTKG="" S GMRCMSG="Missing package entry for CONSULT/REQUEST TRACKING" D EXAC^GMRCADC(GMRCMSG) K GMRCMSG S GMRCEND=1 Q
"RTN","GMRCR",30,0)
 ;old code? D TEAM^GMRCASV
"RTN","GMRCR",31,0)
 S GMRCSSNM=$P(^GMR(123.5,GMRCSS,0),"^",1)
"RTN","GMRCR",32,0)
 ;old codeN GMRCQIT
"RTN","GMRCR",33,0)
 ;old code? S ORVP=DFN_";DPT(",GMRCGRP=0
"RTN","GMRCR",34,0)
 ;old code? K ^TMP("GMRCR",$J)
"RTN","GMRCR",35,0)
 K GMRCOER,GMRCQUT
"RTN","GMRCR",36,0)
 S GMRCEN=1
"RTN","GMRCR",37,0)
 D EN^GMRCMENU ; used to be D EN^GMRCACTM
"RTN","GMRCR",38,0)
 S GMRCOER=0
"RTN","GMRCR",39,0)
 D AD^GMRCSLM1 ; used to be D AD^GMRCRA
"RTN","GMRCR",40,0)
 D EN^VALM("GMRC CONSULT TRACKING")
"RTN","GMRCR",41,0)
 D KILL
"RTN","GMRCR",42,0)
 Q
"RTN","GMRCR",43,0)
KILL ; Kill variables, but don't kill GMRCO and ORIFN if from MC option
"RTN","GMRCR",44,0)
 ;K VALMCNT,VALMBCK,VALMPGE
"RTN","GMRCR",45,0)
 ;K ^TMP("GMRCR",$J,"CS"),^TMP("GMRCS",$J)
"RTN","GMRCR",46,0)
 K X,Y,Z,DTOUT,DUOUT,DIROUT
"RTN","GMRCR",47,0)
 K GMRC,GMRCA,GMRCACT,GMRCACTM,GMRCAGE,GMRCCT,GMRCCTX,GMRCDG,GMRCDGT
"RTN","GMRCR",48,0)
 K GMRCDOB,GMRCDTM,GMRCGRP,GMRCH,GMRCHDR,GMRCIFN,GMRCLFG,GMRCNM,GMRCNPG
"RTN","GMRCR",49,0)
 K GMRCPNM,GMRCRB,GMRCWARD,GMRCSN,GMRCRPG,GMRCNPG,GMRCTITL,GMRCX,GMRCHDR,GMRCH,GMRCDTM
"RTN","GMRCR",50,0)
 K GMRCSTS,GMRCTYPE,GMRCVP,GMRCEND,GMRCTO,GMRCURG,GMRCL,GMRCDT,GMRCDIC
"RTN","GMRCR",51,0)
 K VA,VAIN,VAINDT,VADM,VAEL,VAPA,VAERR,VAROOT
"RTN","GMRCR",52,0)
 K O,OREND,ORINDX,ORNS,POP,SEX,W,XQORSPEW
"RTN","GMRCR",53,0)
 I $D(XQY0),$E(XQY0,1,2)="MC" S:'$D(GMRCO) (ORIFN,GMRCO)="" Q
"RTN","GMRCR",54,0)
 K ORIFN,GMRCO,GMRCSR
"RTN","GMRCR",55,0)
 Q
"RTN","GMRCR",56,0)
RESULT ;Entry point to set up variable pointer to results and update OE/RR status
"RTN","GMRCR",57,0)
 Q
"RTN","GMRCR",58,0)
 Q:'$D(GMRCSR)  Q:'$D(GMRCO)  S (GMRCSS,GMRCSSNM,GMRCNM,GMRC,GMRCVP)=""
"RTN","GMRCR",59,0)
 S GMRCOM=0,GMR(0)=$S($D(^GMR(123,+GMRCO,0)):^(0),1:""),GMRCSS=$P(GMR(0),"^",5) I GMRCSS,$D(^GMR(123.5,GMRCSS,0)) S GMRCSSNM=$S($L($P(^GMR(123.5,GMRCSS,0),"^",9)):$P(^(0),"^",9),1:$P(^(0),"^"))
"RTN","GMRCR",60,0)
 S GMRCVP=$P(GMR(0),"^",8) I +GMRCVP S DIC="^"_$P(GMRCVP,";",2)_$P(GMRCVP,";")_",0)" I $L(DIC),$D(@DIC) S GMRCNM=@(DIC),GMRCNM=$P(GMRCNM,"^",2)
"RTN","GMRCR",61,0)
 I '$D(ORSTS) S ORSTS=6 ;Assume order entry status of active
"RTN","GMRCR",62,0)
 S GMRCA=$O(^GMR(123.1,"AC",+ORSTS,"")) I 'GMRCA S GMRCA=9
"RTN","GMRCR",63,0)
 S DIE=123,DA=GMRCO,DR="11////^S X=GMRCSR;8////^S X=ORSTS;9////^S X=GMRCA"
"RTN","GMRCR",64,0)
 L +^GMR(123,GMRCO) I '$T S GMRCMSG="Consult/Request Is Being Used By Another User.",GMRCMSG(1)="RESULT UPDATE WAS UNSUCCESSFUL!  Try Again Later" D EXAC^GMRCADC(.GMRCMSG) K GMRCO,ORIFN,GMRCMSG D KILL Q
"RTN","GMRCR",65,0)
 D ^DIE K DIE,DA,DR
"RTN","GMRCR",66,0)
 L -^GMR(123,GMRCO) D AUDIT^GMRCP
"RTN","GMRCR",67,0)
 S:'$D(ORIFN) ORIFN=$P(^GMR(123,+GMRCO,0),"^",3)
"RTN","GMRCR",68,0)
 S GMRCORNP=$P(GMR(0),"^",14),GMRCTYPE=$P(GMR(0),"^",17)
"RTN","GMRCR",69,0)
 I $L($P(GMR(0),"^",14)) S GMRCADUZ($P(GMR(0),"^",14))=""
"RTN","GMRCR",70,0)
 I ORIFN D EN^GMRCHL7(DFN,GMRCO,$G(GMRCTYPE),$G(GMRCRB),"RE",GMRCORNP,$G(GMRCVSIT),.GMRCOM)
"RTN","GMRCR",71,0)
 K GMR,GMRCSS,GMRCORVP,GMRCVP,GMRCNM,DIC,GMRCPR
"RTN","GMRCR",72,0)
 Q
"RTN","GMRCR",73,0)
 ;
"RTN","GMRCR",74,0)
PACKAGE() ;  Returns the package entry number for 'CONSULT/REQUEST TRACKING"
"RTN","GMRCR",75,0)
 Q $$FIND1^DIC(9.4,,"QX","CONSULT/REQUEST TRACKING")
"RTN","GMRCR",76,0)
 ;
"RTN","GMRCT")
0^18^B4519174
"RTN","GMRCT",1,0)
GMRCT ;SLC/DLT - Get DUZ's of users for notification to service ;5/20/98  14:21
"RTN","GMRCT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,5**;DEC 27, 1997
"RTN","GMRCT",3,0)
EN(GMRCSS) ;Get who is to be notified for alert action and place them in array GMRCADUZ
"RTN","GMRCT",4,0)
 N GMRCU,GMRCTM,GMRCTMI,GMRCLST,GMRCER,GMRCHL,GMRCSSI,GMRCU,GMRCWL
"RTN","GMRCT",5,0)
 I $D(^GMR(123.5,GMRCSS,123)),$P(^GMR(123.5,GMRCSS,123),"^",8) S GMRCADUZ($P(^(123),"^",8))=""
"RTN","GMRCT",6,0)
 I $D(^GMR(123.5,GMRCSS,123.1)) D TEAM
"RTN","GMRCT",7,0)
 I $D(^GMR(123.5,GMRCSS,123.2)),+$G(GMRCO) D LOC
"RTN","GMRCT",8,0)
 Q
"RTN","GMRCT",9,0)
LOC ;Find the patients location and match to location assignments
"RTN","GMRCT",10,0)
 S GMRCWL="",GMRCHL=""
"RTN","GMRCT",11,0)
 I +$G(GMRCO) S GMRCHL=$P(^GMR(123,+GMRCO,0),"^",4) I GMRCHL S GMRCWL=$G(^SC(GMRCHL,42)) S:GMRCWL GMRCWL=GMRCWL_";DIC(42," S GMRCHL=GMRCHL_";SC("
"RTN","GMRCT",12,0)
 E  S:+$G(GMRCWLI) GMRCWL=GMRCWLI_";DIC(42," S:+$G(GMRCHLI) GMRCHL=GMRCHLI_";SC("
"RTN","GMRCT",13,0)
 I +GMRCWL S GMRCSSI=$O(^GMR(123.5,GMRCSS,123.2,"B",GMRCWL,"")) I GMRCSSI D LOC1
"RTN","GMRCT",14,0)
 I +GMRCHL S GMRCSSI=$O(^GMR(123.5,GMRCSS,123.2,"B",GMRCHL,"")) I GMRCSSI D LOC1
"RTN","GMRCT",15,0)
 Q
"RTN","GMRCT",16,0)
LOC1 ;Get user and/or team assigned to location
"RTN","GMRCT",17,0)
 I $P(^GMR(123.5,GMRCSS,123.2,GMRCSSI,0),"^",2) S GMRCADUZ($P(^(0),"^",2))=""
"RTN","GMRCT",18,0)
 I $P(^GMR(123.5,GMRCSS,123.2,GMRCSSI,0),"^",3) S GMRCTMI=$P(^(0),"^",3) D TEAM1
"RTN","GMRCT",19,0)
 Q
"RTN","GMRCT",20,0)
TEAM ;Loop through Teams to send all users notifications
"RTN","GMRCT",21,0)
 S GMRCTM=0 F  S GMRCTM=$O(^GMR(123.5,GMRCSS,123.1,GMRCTM)) Q:'+GMRCTM  S GMRCTMI=$P($G(^GMR(123.5,GMRCSS,123.1,GMRCTM,0)),"^") I GMRCTMI D TEAM1
"RTN","GMRCT",22,0)
 Q
"RTN","GMRCT",23,0)
TEAM1 ;Get user DUZ's from Team pointed to in File
"RTN","GMRCT",24,0)
 S GMRCLST="" D TEAMPROV^ORQPTQ1(.GMRCLST,GMRCTMI)
"RTN","GMRCT",25,0)
 Q:$S('$O(GMRCLST(0)):1,$P(GMRCLST(1),"^",2)="No providers found.":1,1:0)
"RTN","GMRCT",26,0)
 S GMRCU=0 F  S GMRCU=$O(GMRCLST(GMRCU)) Q:GMRCU=""  S GMRCADUZ($P(GMRCLST(GMRCU),"^",1))=""
"RTN","GMRCT",27,0)
 K GMRCLST
"RTN","GMRCT",28,0)
 Q
"RTN","GMRCYP5")
0^14^B12074052
"RTN","GMRCYP5",1,0)
GMRCYP5 ;SLC/DLT - Consult patch 5 pre-init ;9/8/98  03:52
"RTN","GMRCYP5",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**5**;DEC 27, 1997
"RTN","GMRCYP5",3,0)
 ;
"RTN","GMRCYP5",4,0)
EN ;Load protocols in GMRCR namespace into the PROCEDURE TYPE multiple
"RTN","GMRCYP5",5,0)
 D BMES^XPDUTL("** Begin loading GMRCR Protocols into File 123 PROCEDURE TYPE multiple based on the FILE LINK service **")
"RTN","GMRCYP5",6,0)
 N DA,PNM,PCNT,LCNT,OCNT,SNM,FL,DIC
"RTN","GMRCYP5",7,0)
 S PNM="GMRCR",(LCNT,PCNT,OCNT,BCNT)=0
"RTN","GMRCYP5",8,0)
 S GMRCPKG=$$FIND1^DIC(9.4,,"X","CONSULT/REQUEST TRACKING") I 'GMRCPKG D
"RTN","GMRCYP5",9,0)
 . D BMES^XPDUTL("Unable to find entry for CONSULT/REQUEST TRACKING in PACKAGE (#9.4) file")
"RTN","GMRCYP5",10,0)
 F  S PNM=$O(^ORD(101,"B",PNM)) Q:$E(PNM,1,5)'="GMRCR"  D
"RTN","GMRCYP5",11,0)
 . S PIEN=$O(^ORD(101,"B",PNM,0)) Q:'PIEN  D
"RTN","GMRCYP5",12,0)
 .. D SETFL
"RTN","GMRCYP5",13,0)
 .. D SETPKG
"RTN","GMRCYP5",14,0)
 .. D DISABLD
"RTN","GMRCYP5",15,0)
 D BMES^XPDUTL("Total # of GMRCR protocols reviewed in protocol file: "_PCNT)
"RTN","GMRCYP5",16,0)
 D BMES^XPDUTL("Total # of GMRCR protocols already added to a service in file 123.5: "_OCNT)
"RTN","GMRCYP5",17,0)
 D BMES^XPDUTL("Total # of GMRCR protocols successfully added to a service in file 123.5: "_LCNT)
"RTN","GMRCYP5",18,0)
 D BMES^XPDUTL("** Total # of GMRCR protocols Needing Review: "_BCNT)
"RTN","GMRCYP5",19,0)
 D BMES^XPDUTL("** Finished GMRCR Protocol File Link Processing **")
"RTN","GMRCYP5",20,0)
 D DELDUPS
"RTN","GMRCYP5",21,0)
 Q
"RTN","GMRCYP5",22,0)
SETFL ;Setup the protocol procedures in the service file based on FILE LINK
"RTN","GMRCYP5",23,0)
 S PCNT=PCNT+1
"RTN","GMRCYP5",24,0)
 S FL=$P($G(^ORD(101,+PIEN,5)),U,1)
"RTN","GMRCYP5",25,0)
 I +$O(^GMR(123.5,"APR",+PIEN,+FL,0)) S OCNT=OCNT+1 Q
"RTN","GMRCYP5",26,0)
 I '$D(^GMR(123.5,+FL,0)) D  Q
"RTN","GMRCYP5",27,0)
 . I $E(PNM,1,7)="GMRCRM " D BMES^XPDUTL("Protocol menu "_PNM_" ignored - OK") Q
"RTN","GMRCYP5",28,0)
 . D BMES^XPDUTL("Protocol "_PNM_" contains an invalid service (FILE LINK "_$S($L(FL):FL,1:"not defined")_") - ** needs review") S BCNT=BCNT+1 Q
"RTN","GMRCYP5",29,0)
 S SNM=$P($G(^GMR(123.5,+FL,0)),U,1)
"RTN","GMRCYP5",30,0)
 S Y=$$FILE101(+FL,PIEN)
"RTN","GMRCYP5",31,0)
 I +$G(Y)'>0 D BMES^XPDUTL("Unsuccessful add of Procedure "_PNM_" to file123.5") S BCNT=BCNT+1 Q
"RTN","GMRCYP5",32,0)
 D BMES^XPDUTL("Procedure "_PNM_" successfully added to "_SNM_" service in file 123.5")
"RTN","GMRCYP5",33,0)
 S LCNT=LCNT+1
"RTN","GMRCYP5",34,0)
 Q
"RTN","GMRCYP5",35,0)
FILE101(SVC,X) ;load the protocol entry as a PROCEDURE TYPE for the service
"RTN","GMRCYP5",36,0)
 N DA,DIC,DLAYGO,Y
"RTN","GMRCYP5",37,0)
 K DD,DO
"RTN","GMRCYP5",38,0)
 S DA(1)=+SVC
"RTN","GMRCYP5",39,0)
 S DIC="^GMR(123.5,"_DA(1)_",101,"
"RTN","GMRCYP5",40,0)
 S DIC(0)="FL",X="`"_X
"RTN","GMRCYP5",41,0)
 S DIC("P")=$P(^DD(123.5,101,0),U,2)
"RTN","GMRCYP5",42,0)
 D ^DIC
"RTN","GMRCYP5",43,0)
 Q $G(Y)
"RTN","GMRCYP5",44,0)
 ;
"RTN","GMRCYP5",45,0)
DELPROC ;Delete protocols from 123.5 and start over.
"RTN","GMRCYP5",46,0)
 S PIEN=0
"RTN","GMRCYP5",47,0)
 F  S PIEN=$O(^GMR(123.5,"APR",PIEN)) Q:'PIEN  S DA(1)=0 F  S DA(1)=$O(^GMR(123.5,"APR",PIEN,DA(1))) Q:'DA(1)  D
"RTN","GMRCYP5",48,0)
 . S DA=0
"RTN","GMRCYP5",49,0)
 . F  S DA=$O(^GMR(123.5,"APR",PIEN,DA(1),0)) Q:'DA  D
"RTN","GMRCYP5",50,0)
 . . S DIK="^GMR(123.5,"_DA(1)_",101,"
"RTN","GMRCYP5",51,0)
 . . D ^DIK
"RTN","GMRCYP5",52,0)
 Q
"RTN","GMRCYP5",53,0)
SETPKG ;reset PACKAGE field if not set
"RTN","GMRCYP5",54,0)
 I $D(^ORD(101,PIEN,0)) D
"RTN","GMRCYP5",55,0)
 . Q:$P(^ORD(101,PIEN,0),U,12)=GMRCPKG
"RTN","GMRCYP5",56,0)
 . S $P(^ORD(101,PIEN,0),U,12)=GMRCPKG
"RTN","GMRCYP5",57,0)
 Q
"RTN","GMRCYP5",58,0)
DISABLD ;clear inadvertant DISABLE flag
"RTN","GMRCYP5",59,0)
 I $D(^ORD(101,PIEN,0)) D
"RTN","GMRCYP5",60,0)
 . I $P(^ORD(101,PIEN,0),U,3)=0 S $P(^(0),U,3)=""
"RTN","GMRCYP5",61,0)
 Q
"RTN","GMRCYP5",62,0)
DELDUPS ;clean up duplicate entries in PROCEDURE TYPE multiple
"RTN","GMRCYP5",63,0)
 N SERV,IEN,DUP,PROC
"RTN","GMRCYP5",64,0)
 D BMES^XPDUTL("Checking services for duplicate PROCEDURE TYPES")
"RTN","GMRCYP5",65,0)
 S SERV=0 F  S SERV=$O(^GMR(123.5,SERV)) Q:'SERV  D
"RTN","GMRCYP5",66,0)
 . Q:'$D(^GMR(123.5,SERV,101))
"RTN","GMRCYP5",67,0)
 . S PROC=0 F  S PROC=$O(^GMR(123.5,SERV,101,"B",PROC)) Q:'PROC  D
"RTN","GMRCYP5",68,0)
 .. S IEN=$O(^GMR(123.5,SERV,101,"B",PROC,0)) D
"RTN","GMRCYP5",69,0)
 ... Q:'$O(^GMR(123.5,SERV,101,"B",PROC,IEN))
"RTN","GMRCYP5",70,0)
 ... D BMES^XPDUTL(".")
"RTN","GMRCYP5",71,0)
 ... S DUP=IEN F  S DUP=$O(^GMR(123.5,SERV,101,"B",PROC,DUP)) Q:'DUP  D
"RTN","GMRCYP5",72,0)
 .... N DIK,DA,DA1
"RTN","GMRCYP5",73,0)
 .... S DA(1)=SERV,DA=DUP,DIK="^GMR(123.5,"_DA(1)_",101,"
"RTN","GMRCYP5",74,0)
 .... D ^DIK
"RTN","GMRCYP5",75,0)
 Q
"VER")
8.0^21.0
**END**
**END**
