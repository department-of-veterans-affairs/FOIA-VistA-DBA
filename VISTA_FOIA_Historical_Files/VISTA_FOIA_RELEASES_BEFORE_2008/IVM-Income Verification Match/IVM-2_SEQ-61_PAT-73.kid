Released IVM*2*73 SEQ #61
Extracted from mail message
**KIDS**:IVM*2.0*73^

**INSTALL NAME**
IVM*2.0*73
"BLD",4191,0)
IVM*2.0*73^INCOME VERIFICATION MATCH^0^3030218^y
"BLD",4191,1,0)
^^1^1^3030217^
"BLD",4191,1,1,0)
IVM*2.0*73 Kids Build
"BLD",4191,4,0)
^9.64PA^^
"BLD",4191,"ABPKG")
n
"BLD",4191,"INIT")
IVM273A
"BLD",4191,"KRN",0)
^9.67PA^8989.52^19
"BLD",4191,"KRN",.4,0)
.4
"BLD",4191,"KRN",.401,0)
.401
"BLD",4191,"KRN",.402,0)
.402
"BLD",4191,"KRN",.403,0)
.403
"BLD",4191,"KRN",.5,0)
.5
"BLD",4191,"KRN",.84,0)
.84
"BLD",4191,"KRN",3.6,0)
3.6
"BLD",4191,"KRN",3.8,0)
3.8
"BLD",4191,"KRN",9.2,0)
9.2
"BLD",4191,"KRN",9.8,0)
9.8
"BLD",4191,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",4191,"KRN",9.8,"NM",1,0)
IVMLDEM6^^0^B39353754
"BLD",4191,"KRN",9.8,"NM",2,0)
IVMPREC8^^0^B26857212
"BLD",4191,"KRN",9.8,"NM",3,0)
IVM273A^^0^B11819742
"BLD",4191,"KRN",9.8,"NM",4,0)
IVM273M^^0^B7472556
"BLD",4191,"KRN",9.8,"NM","B","IVM273A",3)

"BLD",4191,"KRN",9.8,"NM","B","IVM273M",4)

"BLD",4191,"KRN",9.8,"NM","B","IVMLDEM6",1)

"BLD",4191,"KRN",9.8,"NM","B","IVMPREC8",2)

"BLD",4191,"KRN",19,0)
19
"BLD",4191,"KRN",19.1,0)
19.1
"BLD",4191,"KRN",101,0)
101
"BLD",4191,"KRN",409.61,0)
409.61
"BLD",4191,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",4191,"KRN",771,0)
771
"BLD",4191,"KRN",870,0)
870
"BLD",4191,"KRN",8989.51,0)
8989.51
"BLD",4191,"KRN",8989.52,0)
8989.52
"BLD",4191,"KRN",8994,0)
8994
"BLD",4191,"KRN","B",.4,.4)

"BLD",4191,"KRN","B",.401,.401)

"BLD",4191,"KRN","B",.402,.402)

"BLD",4191,"KRN","B",.403,.403)

"BLD",4191,"KRN","B",.5,.5)

"BLD",4191,"KRN","B",.84,.84)

"BLD",4191,"KRN","B",3.6,3.6)

"BLD",4191,"KRN","B",3.8,3.8)

"BLD",4191,"KRN","B",9.2,9.2)

"BLD",4191,"KRN","B",9.8,9.8)

"BLD",4191,"KRN","B",19,19)

"BLD",4191,"KRN","B",19.1,19.1)

"BLD",4191,"KRN","B",101,101)

"BLD",4191,"KRN","B",409.61,409.61)

"BLD",4191,"KRN","B",771,771)

"BLD",4191,"KRN","B",870,870)

"BLD",4191,"KRN","B",8989.51,8989.51)

"BLD",4191,"KRN","B",8989.52,8989.52)

"BLD",4191,"KRN","B",8994,8994)

"BLD",4191,"QUES",0)
^9.62^^
"BLD",4191,"REQB",0)
^9.611^1^1
"BLD",4191,"REQB",1,0)
IVM*2.0*58^2
"BLD",4191,"REQB","B","IVM*2.0*58",1)

"INIT")
IVM273A
"MBREQ")
0
"PKG",220,-1)
1^1
"PKG",220,0)
INCOME VERIFICATION MATCH^IVM^IVM Software for interface with the IVM Center
"PKG",220,20,0)
^9.402P^^
"PKG",220,22,0)
^9.49I^1^1
"PKG",220,22,1,0)
2.0^2941021
"PKG",220,22,1,"PAH",1,0)
73^3030218
"PKG",220,22,1,"PAH",1,1,0)
^^1^1^3030218
"PKG",220,22,1,"PAH",1,1,1,0)
IVM*2.0*73 Kids Build
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","IVM273A")
0^3^B11819742
"RTN","IVM273A",1,0)
IVM273A ;ALB/PDJ IVM*2.0*73 - CLEANUP IVM PATIENT FILE;02/07/2003
"RTN","IVM273A",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**73**; 21-OCT-94
"RTN","IVM273A",3,0)
 ;
"RTN","IVM273A",4,0)
EN N DFN,I,R3015,SEG,TEXT,TYPE,X,X1,X2,%,XTPAT,IVMPH,IVMAD
"RTN","IVM273A",5,0)
 ;
"RTN","IVM273A",6,0)
 D BMES^XPDUTL(" ")
"RTN","IVM273A",7,0)
 D BMES^XPDUTL("   The Post Install will now process through the IVM PATIENT")
"RTN","IVM273A",8,0)
 D BMES^XPDUTL(" FILE to remove entries which do not contain any uploadable")
"RTN","IVM273A",9,0)
 D BMES^XPDUTL(" or non-uploadable fields.")
"RTN","IVM273A",10,0)
 D BMES^XPDUTL(" ")
"RTN","IVM273A",11,0)
 ;
"RTN","IVM273A",12,0)
 I $D(XPDNM) D
"RTN","IVM273A",13,0)
 . I $$VERCP^XPDUTL("R3015")'>0 D
"RTN","IVM273A",14,0)
 . . S %=$$NEWCP^XPDUTL("R3015","","0")
"RTN","IVM273A",15,0)
 ;
"RTN","IVM273A",16,0)
 F I="PATREC" D
"RTN","IVM273A",17,0)
 . I $D(^XTMP("IVM*2.0*73-"_I)) Q
"RTN","IVM273A",18,0)
 . S X1=DT
"RTN","IVM273A",19,0)
 . S X2=30
"RTN","IVM273A",20,0)
 . D C^%DTC
"RTN","IVM273A",21,0)
 . S TEXT=X_"^"_$$DT^XLFDT_"^IVM*2.0*73 POST-INSTALL "
"RTN","IVM273A",22,0)
 . S TEXT=TEXT_$S(I="PATREC":"IVM Patient Records",1:"filing errors")
"RTN","IVM273A",23,0)
 . S ^XTMP("IVM*2.0*73-"_I,0)=TEXT
"RTN","IVM273A",24,0)
 ;
"RTN","IVM273A",25,0)
 S XTPAT="IVM*2.0*73-PATREC"
"RTN","IVM273A",26,0)
 ;
"RTN","IVM273A",27,0)
 I '$D(XPDNM) D
"RTN","IVM273A",28,0)
 . S ^XTMP(XTPAT,1)=0
"RTN","IVM273A",29,0)
 I $D(XPDNM)&'$D(^XTMP(XTPAT,1)) S ^XTMP(XTPAT,1)=0
"RTN","IVM273A",30,0)
 I $D(XPDNM) S %=$$VERCP^XPDUTL("R3015")
"RTN","IVM273A",31,0)
 I $G(%)="" S %=0
"RTN","IVM273A",32,0)
 I %=0 D EN1
"RTN","IVM273A",33,0)
 Q
"RTN","IVM273A",34,0)
 ;
"RTN","IVM273A",35,0)
EN1 I '$D(XPDNM) S R3015=0
"RTN","IVM273A",36,0)
 I $D(XPDNM) S R3015=$$PARCP^XPDUTL("R3015")
"RTN","IVM273A",37,0)
 F  S R3015=$O(^IVM(301.5,R3015)) Q:'R3015  D
"RTN","IVM273A",38,0)
 . S SEG="B"
"RTN","IVM273A",39,0)
 . F  S SEG=$O(^IVM(301.5,R3015,"IN",SEG),-1) Q:'SEG  D
"RTN","IVM273A",40,0)
 . . S (IVMAD,IVMPH)=0
"RTN","IVM273A",41,0)
 . . S DFN=+$P($G(^IVM(301.5,R3015,0)),U,1) Q:'DFN
"RTN","IVM273A",42,0)
 . . S TYPE=$P($G(^IVM(301.5,R3015,"IN",SEG,0)),U,2) Q:TYPE'="PID"
"RTN","IVM273A",43,0)
 . . D CHKREC
"RTN","IVM273A",44,0)
 . . S TYPE=$P($G(^IVM(301.5,R3015,"IN",SEG,0)),U,2)
"RTN","IVM273A",45,0)
 . . I TYPE="" D PROCREC
"RTN","IVM273A",46,0)
 . I $D(XPDNM) S %=$$UPCP^XPDUTL("R3015",R3015)
"RTN","IVM273A",47,0)
 ;
"RTN","IVM273A",48,0)
 D MAIL^IVM273M
"RTN","IVM273A",49,0)
 I $D(XPDNM) S %=$$COMCP^XPDUTL("R3015")
"RTN","IVM273A",50,0)
 D BMES^XPDUTL(" Cleanup of IVM PATIENT file is complete.")
"RTN","IVM273A",51,0)
 Q
"RTN","IVM273A",52,0)
 ;
"RTN","IVM273A",53,0)
CHKREC ; Check Demographic fields
"RTN","IVM273A",54,0)
 N DEMO,DATA0,FLDLOC,IVMDATA,PATPH,PH
"RTN","IVM273A",55,0)
 S DEMO=0
"RTN","IVM273A",56,0)
 F  S DEMO=$O(^IVM(301.5,R3015,"IN",SEG,"DEM",DEMO)) Q:'DEMO  D
"RTN","IVM273A",57,0)
 . S DATA0=$G(^IVM(301.5,R3015,"IN",SEG,"DEM",DEMO,0)) Q:DATA0=""
"RTN","IVM273A",58,0)
 . S FLDLOC=$P(DATA0,"^",1),IVMDATA=$P(DATA0,"^",2)
"RTN","IVM273A",59,0)
 . I IVMDATA="" D  Q
"RTN","IVM273A",60,0)
 . . ; only process address fields
"RTN","IVM273A",61,0)
 . . I '$D(^IVM(301.92,"AD",FLDLOC)) Q
"RTN","IVM273A",62,0)
 . . S IVMAD=1 D DELFLD
"RTN","IVM273A",63,0)
 . I FLDLOC=11 D
"RTN","IVM273A",64,0)
 . . S PATPH=$$CONVPH^IVMPREC8($P($G(^DPT(DFN,.13)),"^",1))
"RTN","IVM273A",65,0)
 . . S PH=$$CONVPH^IVMPREC8(IVMDATA)
"RTN","IVM273A",66,0)
 . . ; quit if the phone numbers are the same, otherwise delete
"RTN","IVM273A",67,0)
 . . ;   the field from the IVM PATIENT file
"RTN","IVM273A",68,0)
 . . I PATPH'=PH Q
"RTN","IVM273A",69,0)
 . . S IVMPH=1 D DELFLD
"RTN","IVM273A",70,0)
 ; If no uploadable and no non-uploadable fields delete then entry
"RTN","IVM273A",71,0)
 I '$$DEMO^IVMLDEM5(R3015,SEG,0),'$$DEMO^IVMLDEM5(R3015,SEG,1) D
"RTN","IVM273A",72,0)
 . D DELETE^IVMLDEM5(R3015,SEG,"NAME,DUMMY")
"RTN","IVM273A",73,0)
 Q
"RTN","IVM273A",74,0)
 ;
"RTN","IVM273A",75,0)
DELFLD ; Delete null field
"RTN","IVM273A",76,0)
 N DA,DIE,DR
"RTN","IVM273A",77,0)
 S DA=DEMO,DA(1)=SEG,DA(2)=R3015
"RTN","IVM273A",78,0)
 S DIE="^IVM(301.5,"_DA(2)_",""IN"","_DA(1)_",""DEM"","
"RTN","IVM273A",79,0)
 S DR=".01////@" D ^DIE
"RTN","IVM273A",80,0)
 Q
"RTN","IVM273A",81,0)
 ;
"RTN","IVM273A",82,0)
PROCREC ; Save processed records to the XTMP file
"RTN","IVM273A",83,0)
 N DATA,NAME,SSN
"RTN","IVM273A",84,0)
 S DATA=$G(^DPT(DFN,0)) Q:DATA=""
"RTN","IVM273A",85,0)
 S NAME=$P(DATA,"^",1)
"RTN","IVM273A",86,0)
 S SSN=$P(DATA,"^",9)
"RTN","IVM273A",87,0)
 ;
"RTN","IVM273A",88,0)
 ; Only count the record once even if more than one entry was
"RTN","IVM273A",89,0)
 ;   updated.
"RTN","IVM273A",90,0)
 ;
"RTN","IVM273A",91,0)
 I '$D(^XTMP(XTPAT,"RECS",DFN)) S ^XTMP(XTPAT,1)=$G(^XTMP(XTPAT,1))+1
"RTN","IVM273A",92,0)
 S ^XTMP(XTPAT,"RECS",DFN)=R3015_U_NAME_U_SSN
"RTN","IVM273A",93,0)
 I IVMAD S $P(^XTMP(XTPAT,"RECS",DFN),U,4)=1
"RTN","IVM273A",94,0)
 I IVMPH S $P(^XTMP(XTPAT,"RECS",DFN),U,5)=1
"RTN","IVM273A",95,0)
 Q
"RTN","IVM273A",96,0)
 ;
"RTN","IVM273A",97,0)
CLEANUP ; Used to cleanup XTMP global for testing only
"RTN","IVM273A",98,0)
 S XTPAT="IVM*2.0*73-PATREC"
"RTN","IVM273A",99,0)
 ;
"RTN","IVM273A",100,0)
 K ^XTMP(XTPAT)
"RTN","IVM273A",101,0)
 Q
"RTN","IVM273M")
0^4^B7472556
"RTN","IVM273M",1,0)
IVM273M ;ALB/PDJ IVM*2.0*73 - CLEANUP IVM PATIENT FILE;02/07/2003
"RTN","IVM273M",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**73**; 21-OCT-94
"RTN","IVM273M",3,0)
 ;
"RTN","IVM273M",4,0)
 ; A mail message will be sent to the user when the edit process
"RTN","IVM273M",5,0)
 ; is complete.
"RTN","IVM273M",6,0)
 ;
"RTN","IVM273M",7,0)
 ;
"RTN","IVM273M",8,0)
MAIL ; Send a mailman msg to user with results
"RTN","IVM273M",9,0)
 N DIFROM,%
"RTN","IVM273M",10,0)
 N DATA,NODE,TEXT,XMDUZ,XMSUB,XMTEXT,XMY,Y
"RTN","IVM273M",11,0)
 N XTPAT,NAME
"RTN","IVM273M",12,0)
 N PIEN,R3015,SSN
"RTN","IVM273M",13,0)
 S XTPAT="IVM*2.0*73-PATREC"
"RTN","IVM273M",14,0)
 K ^TMP("IVM2073",$J)
"RTN","IVM273M",15,0)
 S XMSUB="IVM PATIENT file Cleanup"
"RTN","IVM273M",16,0)
 S XMDUZ="IVM Edit Package",XMY(DUZ)="",XMY(.5)=""
"RTN","IVM273M",17,0)
 S XMTEXT="^TMP(""IVM2073"",$J,"
"RTN","IVM273M",18,0)
 D NOW^%DTC S Y=% D DD^%DT
"RTN","IVM273M",19,0)
 S ^TMP("IVM2073",$J,1)="IVM PATIENT file cleanup"
"RTN","IVM273M",20,0)
 S ^TMP("IVM2073",$J,2)="  "
"RTN","IVM273M",21,0)
 S NODE=2
"RTN","IVM273M",22,0)
 S NODE=NODE+1
"RTN","IVM273M",23,0)
 S ^TMP("IVM2073",$J,NODE)=" "
"RTN","IVM273M",24,0)
 ;
"RTN","IVM273M",25,0)
PRTRECS ; Print List of records
"RTN","IVM273M",26,0)
 S NODE=NODE+1
"RTN","IVM273M",27,0)
 S ^TMP("IVM2073",$J,NODE)=" "
"RTN","IVM273M",28,0)
 S TEXT="    Total IVM PATIENT Records Updated: "
"RTN","IVM273M",29,0)
 S TEXT=$$BLDSTR($J(+$G(^XTMP(XTPAT,1)),8,0),TEXT,50,8)
"RTN","IVM273M",30,0)
 S NODE=NODE+1
"RTN","IVM273M",31,0)
 S ^TMP("IVM2073",$J,NODE)=TEXT
"RTN","IVM273M",32,0)
 S NODE=NODE+1
"RTN","IVM273M",33,0)
 S ^TMP("IVM2073",$J,NODE)=" "
"RTN","IVM273M",34,0)
 S NODE=NODE+1
"RTN","IVM273M",35,0)
 S ^TMP("IVM2073",$J,NODE)=" "
"RTN","IVM273M",36,0)
 ;
"RTN","IVM273M",37,0)
 S TEXT=" "
"RTN","IVM273M",38,0)
 S TEXT=$$BLDSTR("DFN",TEXT,3,3)
"RTN","IVM273M",39,0)
 S TEXT=$$BLDSTR("301.5",TEXT,16,5)
"RTN","IVM273M",40,0)
 S TEXT=$$BLDSTR("SSN",TEXT,29,3)
"RTN","IVM273M",41,0)
 S TEXT=$$BLDSTR("Name",TEXT,43,4)
"RTN","IVM273M",42,0)
 S TEXT=$$BLDSTR("Addr?",TEXT,67,5)
"RTN","IVM273M",43,0)
 S TEXT=$$BLDSTR("Ph?",TEXT,75,3)
"RTN","IVM273M",44,0)
 S NODE=NODE+1
"RTN","IVM273M",45,0)
 S ^TMP("IVM2073",$J,NODE)=TEXT
"RTN","IVM273M",46,0)
 S NODE=NODE+1
"RTN","IVM273M",47,0)
 S ^TMP("IVM2073",$J,NODE)=$$REPEAT^XLFSTR("=",79)
"RTN","IVM273M",48,0)
 S PIEN=""
"RTN","IVM273M",49,0)
 F  S PIEN=$O(^XTMP(XTPAT,"RECS",PIEN)) Q:PIEN=""  D
"RTN","IVM273M",50,0)
 . D BLDPAT
"RTN","IVM273M",51,0)
 S NODE=NODE+1
"RTN","IVM273M",52,0)
 S ^TMP("IVM2073",$J,NODE)=$$REPEAT^XLFSTR("=",79)
"RTN","IVM273M",53,0)
 ;
"RTN","IVM273M",54,0)
MAIL1 ;  Send message 
"RTN","IVM273M",55,0)
 S NODE=NODE+1
"RTN","IVM273M",56,0)
 S ^TMP("IVM2073",$J,NODE)=" "
"RTN","IVM273M",57,0)
 S NODE=NODE+1
"RTN","IVM273M",58,0)
 S ^TMP("IVM2073",$J,NODE)=" ******** END OF MESSAGE ********"
"RTN","IVM273M",59,0)
 ;
"RTN","IVM273M",60,0)
 D ^XMD
"RTN","IVM273M",61,0)
 K ^TMP("IVM2073",$J)
"RTN","IVM273M",62,0)
 Q
"RTN","IVM273M",63,0)
 ;
"RTN","IVM273M",64,0)
BLDPAT ; Format Patient line for printing
"RTN","IVM273M",65,0)
 N DATA,NAME,PH,AD
"RTN","IVM273M",66,0)
 S DATA=^XTMP(XTPAT,"RECS",PIEN)
"RTN","IVM273M",67,0)
 S R3015=$P(DATA,"^",1),NAME=$P(DATA,"^",2),SSN=$P(DATA,"^",3)
"RTN","IVM273M",68,0)
 S AD=$P(DATA,"^",4),PH=$P(DATA,"^",5)
"RTN","IVM273M",69,0)
 S TEXT=" "
"RTN","IVM273M",70,0)
 S TEXT=$$BLDSTR(PIEN,TEXT,3,$L(PIEN))
"RTN","IVM273M",71,0)
 S TEXT=$$BLDSTR(R3015,TEXT,16,$L(R3015))
"RTN","IVM273M",72,0)
 S TEXT=$$BLDSTR(SSN,TEXT,29,$L(SSN))
"RTN","IVM273M",73,0)
 S TEXT=$$BLDSTR($E(NAME,1,20),TEXT,43,20)
"RTN","IVM273M",74,0)
 I AD S TEXT=$$BLDSTR("YES",TEXT,68,3)
"RTN","IVM273M",75,0)
 I PH S TEXT=$$BLDSTR("YES",TEXT,75,3)
"RTN","IVM273M",76,0)
 S NODE=NODE+1
"RTN","IVM273M",77,0)
 S ^TMP("IVM2073",$J,NODE)=TEXT
"RTN","IVM273M",78,0)
 Q
"RTN","IVM273M",79,0)
 ;
"RTN","IVM273M",80,0)
BLDSTR(NSTR,STR,COL,NSL) ; build a string
"RTN","IVM273M",81,0)
 ; Input:
"RTN","IVM273M",82,0)
 ;   NSTR = a string to be added to STR
"RTN","IVM273M",83,0)
 ;   STR  = an existing string to which NSTR will be added
"RTN","IVM273M",84,0)
 ;   COL  = column location at which NSTR will be added to STR
"RTN","IVM273M",85,0)
 ;   NSL  = length of new string
"RTN","IVM273M",86,0)
 ; Output:
"RTN","IVM273M",87,0)
 ;   returns STR with NSTR appended at the specified COL
"RTN","IVM273M",88,0)
 ;
"RTN","IVM273M",89,0)
 Q $E(STR_$J("",COL-1),1,COL-1)_$E(NSTR_$J("",NSL),1,NSL)_$E(STR,COL+NSL,999)
"RTN","IVMLDEM6")
0^1^B39353754
"RTN","IVMLDEM6",1,0)
IVMLDEM6 ;ALB/KCL/BRM - IVM DEMOGRAPHIC UPLOAD FILE ADDRESS ; 9/3/02 4:08pm
"RTN","IVMLDEM6",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**10,58,73**; 21-OCT-94
"RTN","IVMLDEM6",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMLDEM6",4,0)
 ;
"RTN","IVMLDEM6",5,0)
 ;
"RTN","IVMLDEM6",6,0)
ADDR(DFN,IVMDA2,IVMDA1,IVMDA,IVMPPICK) ; - function to check if uploadable field
"RTN","IVMLDEM6",7,0)
 ;                          is an address field and return a flag
"RTN","IVMLDEM6",8,0)
 ;
"RTN","IVMLDEM6",9,0)
 ;  Input:      DFN  -  as patient IEN
"RTN","IVMLDEM6",10,0)
 ;           IVMDA2  -  pointer to case record in (#301.5) file
"RTN","IVMLDEM6",11,0)
 ;           IVMDA1  -  pointer to PID msg in (#301.501) sub-file
"RTN","IVMLDEM6",12,0)
 ;            IVMDA  -  pointer to record in (#301.511) sub-file
"RTN","IVMLDEM6",13,0)
 ;         IVMPPICK  -  residence phone number and/or another address
"RTN","IVMLDEM6",14,0)
 ;                        field selected
"RTN","IVMLDEM6",15,0)
 ;                      0 - phone or an address field not selected 
"RTN","IVMLDEM6",16,0)
 ;                      1 - address field(s) selected
"RTN","IVMLDEM6",17,0)
 ;                      2 - phone selected
"RTN","IVMLDEM6",18,0)
 ;                      3 - both address field(s) and phone selected
"RTN","IVMLDEM6",19,0)
 ;
"RTN","IVMLDEM6",20,0)
 ; Output: IVMFLAG   -  1 if address field
"RTN","IVMLDEM6",21,0)
 ;                      0 if not an address field
"RTN","IVMLDEM6",22,0)
 ;
"RTN","IVMLDEM6",23,0)
 ;
"RTN","IVMLDEM6",24,0)
 N IVMFLAG,IVMI,IVMJ,IVMNODE,IVMPTR,Y
"RTN","IVMLDEM6",25,0)
 ;
"RTN","IVMLDEM6",26,0)
 ; - initialize flags
"RTN","IVMLDEM6",27,0)
 S IVMFLAG=0
"RTN","IVMLDEM6",28,0)
 ;
"RTN","IVMLDEM6",29,0)
 ; - check for required parameters
"RTN","IVMLDEM6",30,0)
 I '$G(DFN)!('$G(IVMDA))!('$G(IVMDA1))!'($G(IVMDA2)) G ADDRQ
"RTN","IVMLDEM6",31,0)
 ;
"RTN","IVMLDEM6",32,0)
 ; - get pointer to (#301.92) file from (#301.511) sub-file
"RTN","IVMLDEM6",33,0)
 S IVMPTR=+$G(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM",IVMDA,0)) G ADDRQ:'IVMPTR
"RTN","IVMLDEM6",34,0)
 ;
"RTN","IVMLDEM6",35,0)
ASK I '$D(^IVM(301.92,"AD",+IVMPTR)) G ADDRQ
"RTN","IVMLDEM6",36,0)
 I IVMPPICK=2 G ASK1
"RTN","IVMLDEM6",37,0)
 W ! S DIR("A")="Do you wish to proceed with this action"
"RTN","IVMLDEM6",38,0)
 S DIR("A",1)="You have selected to update an address field."
"RTN","IVMLDEM6",39,0)
 S DIR("A",2)="You will be required to upload the entire address."
"RTN","IVMLDEM6",40,0)
 S DIR("?")="Enter 'YES' to continue or 'NO' to abort."
"RTN","IVMLDEM6",41,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","IVMLDEM6",42,0)
 D ^DIR K DIR
"RTN","IVMLDEM6",43,0)
 S IVMFLAG=1 G ADDRQ:'Y
"RTN","IVMLDEM6",44,0)
 W ! S DIR("A")="Are you sure that you want to update the complete address"
"RTN","IVMLDEM6",45,0)
 S DIR("?",1)="Enter 'YES' to update the complete address that was received from"
"RTN","IVMLDEM6",46,0)
 S DIR("?")="HEC.  Enter 'NO' to quit."
"RTN","IVMLDEM6",47,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","IVMLDEM6",48,0)
 D ^DIR K DIR
"RTN","IVMLDEM6",49,0)
 S IVMFLAG=1 G ADDRQ:'Y
"RTN","IVMLDEM6",50,0)
 W !,"Filing address fields... "
"RTN","IVMLDEM6",51,0)
 ;
"RTN","IVMLDEM6",52,0)
LOOP ; - loop thru fields in ^IVM(301.92,"AD" x-ref
"RTN","IVMLDEM6",53,0)
 S IVMI=0 F  S IVMI=$O(^IVM(301.92,"AD",IVMI)) Q:IVMI']""  D
"RTN","IVMLDEM6",54,0)
 .S IVMJ=0 F  S IVMJ=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IVMI,IVMJ)) Q:IVMJ']""  D
"RTN","IVMLDEM6",55,0)
 ..;
"RTN","IVMLDEM6",56,0)
 ..; - check for data node in (#301.511) sub-file
"RTN","IVMLDEM6",57,0)
 ..S IVMNODE=$G(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM",IVMJ,0)) Q:IVMNODE']""
"RTN","IVMLDEM6",58,0)
 ..Q:'(+IVMNODE)!($P(IVMNODE,"^",2)']"")
"RTN","IVMLDEM6",59,0)
 ..;
"RTN","IVMLDEM6",60,0)
 ..; - check if residence phone number and not selected to upload
"RTN","IVMLDEM6",61,0)
 ..Q:(IVMPPICK=1&(+IVMNODE=$O(^IVM(301.92,"B","PHONE NUMBER [RESIDENCE]",0))))
"RTN","IVMLDEM6",62,0)
 ..; - check if not residence phone number and only phone selected to upload
"RTN","IVMLDEM6",63,0)
 ..Q:(IVMPPICK=2&(+IVMNODE'=$O(^IVM(301.92,"B","PHONE NUMBER [RESIDENCE]",0))))
"RTN","IVMLDEM6",64,0)
 ..;
"RTN","IVMLDEM6",65,0)
 ..; - load addr field rec'd from IVM into DHCP (#2) file
"RTN","IVMLDEM6",66,0)
 ..D UPLOAD(+DFN,$P($G(^IVM(301.92,+IVMNODE,0)),"^",5),$P(IVMNODE,"^",2)) S IVMFLAG=1
"RTN","IVMLDEM6",67,0)
 ..;
"RTN","IVMLDEM6",68,0)
 ..; - remove entry from (#301.511) sub-file
"RTN","IVMLDEM6",69,0)
 ..D DELENT^IVMLDEMU(IVMDA2,IVMDA1,IVMJ)
"RTN","IVMLDEM6",70,0)
 ;
"RTN","IVMLDEM6",71,0)
 I IVMFLAG W "completed.",!
"RTN","IVMLDEM6",72,0)
 ;
"RTN","IVMLDEM6",73,0)
 ; - if addr is uploaded and phone # is not - ask user delete phone
"RTN","IVMLDEM6",74,0)
 I IVMFLAG,$P($G(^DPT(+DFN,.13)),"^")]"",(2>IVMPPICK) D PHONE
"RTN","IVMLDEM6",75,0)
 S VALMBCK="R"
"RTN","IVMLDEM6",76,0)
 ;
"RTN","IVMLDEM6",77,0)
 ;
"RTN","IVMLDEM6",78,0)
ADDRQ ; - return  -->  1 if uploadable field is an address field
"RTN","IVMLDEM6",79,0)
 ;           -->  0 if uploadable field is not an address field
"RTN","IVMLDEM6",80,0)
 ;
"RTN","IVMLDEM6",81,0)
 I IVMFLAG D RESET^IVMLDEMU
"RTN","IVMLDEM6",82,0)
 Q IVMFLAG
"RTN","IVMLDEM6",83,0)
 ;
"RTN","IVMLDEM6",84,0)
 ;
"RTN","IVMLDEM6",85,0)
UPLOAD(DFN,IVMFIELD,IVMVALUE) ; - file address fields received from IVM
"RTN","IVMLDEM6",86,0)
 ;
"RTN","IVMLDEM6",87,0)
 ;  Input:       DFN  -  as patient IEN
"RTN","IVMLDEM6",88,0)
 ;          IVMFIELD  -  as the field number to be updated
"RTN","IVMLDEM6",89,0)
 ;          IVMVALUE  -  as the value of the field
"RTN","IVMLDEM6",90,0)
 ;
"RTN","IVMLDEM6",91,0)
 ; Output: None
"RTN","IVMLDEM6",92,0)
 ;
"RTN","IVMLDEM6",93,0)
 ; - update specified address field in the Patient (#2) file
"RTN","IVMLDEM6",94,0)
 S DIE="^DPT(",DA=DFN,DR=IVMFIELD_"////^S X=IVMVALUE"
"RTN","IVMLDEM6",95,0)
 D ^DIE K DA,DIE,DR
"RTN","IVMLDEM6",96,0)
 Q
"RTN","IVMLDEM6",97,0)
 ;
"RTN","IVMLDEM6",98,0)
 ;
"RTN","IVMLDEM6",99,0)
PHONE ; - ask user to delete phone # [Residence] from Patient (#2) file
"RTN","IVMLDEM6",100,0)
 D FULL^VALM1
"RTN","IVMLDEM6",101,0)
 W ! S DIR("A")="Is it okay to delete the patient's Phone Number [Residence]"
"RTN","IVMLDEM6",102,0)
 W ! S DIR("A",1)="The patient's address has been updated and the phone number"
"RTN","IVMLDEM6",103,0)
 S DIR("A",2)="remains on file."
"RTN","IVMLDEM6",104,0)
 S DIR("A",3)=" "
"RTN","IVMLDEM6",105,0)
 S DIR("A",4)="Patient Name: "_$P($$PT^IVMUFNC4(+DFN),"^")_" ("_$P($$PT^IVMUFNC4(+DFN),"^",3)_")"
"RTN","IVMLDEM6",106,0)
 S DIR("A",5)="Phone Number [Residence]: "_$P($G(^DPT(+DFN,.13)),"^")
"RTN","IVMLDEM6",107,0)
 S DIR("A",6)=" "
"RTN","IVMLDEM6",108,0)
 S DIR("?",1)="Enter 'YES' to delete the patient's Phone Number [Residence] that is"
"RTN","IVMLDEM6",109,0)
 S DIR("?",2)="currently on file.  Enter 'NO' to quit without deleting the patient's"
"RTN","IVMLDEM6",110,0)
 S DIR("?")="Phone Number [Residence]."
"RTN","IVMLDEM6",111,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","IVMLDEM6",112,0)
 D ^DIR K DIR
"RTN","IVMLDEM6",113,0)
 S:Y $P(^DPT(DFN,.13),"^")="" W !!,"Patient's Phone Number [Residence] has ",$S(Y:"",1:"not "),"been deleted."
"RTN","IVMLDEM6",114,0)
 Q
"RTN","IVMLDEM6",115,0)
 ;
"RTN","IVMLDEM6",116,0)
ASK1 ; - phone selected to be uploaded - address fields not selected
"RTN","IVMLDEM6",117,0)
 W ! S DIR("A")="Okay to update the PHONE NUMBER [RESIDENCE] field"
"RTN","IVMLDEM6",118,0)
 S DIR("?",1)="Enter 'YES' to update the patient's Phone Number [Residence] that was"
"RTN","IVMLDEM6",119,0)
 S DIR("?",2)="received from HEC.  Enter 'NO' to quit."
"RTN","IVMLDEM6",120,0)
 S DIR(0)="Y",DIR("B")="YES"
"RTN","IVMLDEM6",121,0)
 D ^DIR K DIR
"RTN","IVMLDEM6",122,0)
 S IVMFLAG=1 G ADDRQ:'Y
"RTN","IVMLDEM6",123,0)
 W !,"Updating PHONE NUMBER [RESIDENCE] field... "
"RTN","IVMLDEM6",124,0)
 G LOOP
"RTN","IVMLDEM6",125,0)
 ;
"RTN","IVMLDEM6",126,0)
AUTOADDR(DFN,IVMPPICK,NOUPDT) ;
"RTN","IVMLDEM6",127,0)
 ; this functionality is copied from above and modified to allow
"RTN","IVMLDEM6",128,0)
 ; an automated upload of patient address information as stipulated
"RTN","IVMLDEM6",129,0)
 ; in the business requirements for Address Indexing to support GMT
"RTN","IVMLDEM6",130,0)
 ;
"RTN","IVMLDEM6",131,0)
 ;  Input:      DFN  -  as patient IEN
"RTN","IVMLDEM6",132,0)
 ;         IVMPPICK  -  residence phone number and/or another address
"RTN","IVMLDEM6",133,0)
 ;                        field selected
"RTN","IVMLDEM6",134,0)
 ;                      1 - address field(s) selected
"RTN","IVMLDEM6",135,0)
 ;                      3 - both address field(s) and phone selected
"RTN","IVMLDEM6",136,0)
 ;           NOUPDT  -  (optional) this flag is set when the incoming
"RTN","IVMLDEM6",137,0)
 ;                      address data is older than the existing
"RTN","IVMLDEM6",138,0)
 ;                      address in the Patient (#2) file
"RTN","IVMLDEM6",139,0)
 ;
"RTN","IVMLDEM6",140,0)
 ; Output: IVMFLAG   -  1 if address fields updated
"RTN","IVMLDEM6",141,0)
 ;                      0 if address fields not updated
"RTN","IVMLDEM6",142,0)
 ;
"RTN","IVMLDEM6",143,0)
 ;
"RTN","IVMLDEM6",144,0)
 ;
"RTN","IVMLDEM6",145,0)
 N IVMFLAG,IVMI,IVMJ,IVMNODE,IVMPTR,Y
"RTN","IVMLDEM6",146,0)
 ;
"RTN","IVMLDEM6",147,0)
 ; - initialize flags
"RTN","IVMLDEM6",148,0)
 S IVMFLAG=0
"RTN","IVMLDEM6",149,0)
 S:'$G(NOUPDT) NOUPDT=0
"RTN","IVMLDEM6",150,0)
 ;
"RTN","IVMLDEM6",151,0)
 ; - check for required parameters
"RTN","IVMLDEM6",152,0)
 Q:'$G(DFN) IVMFLAG
"RTN","IVMLDEM6",153,0)
 ;
"RTN","IVMLDEM6",154,0)
 S IVMDA2=$G(IVM3015)
"RTN","IVMLDEM6",155,0)
 Q:'$G(IVMDA2) IVMFLAG
"RTN","IVMLDEM6",156,0)
 S IVMDA1=$O(^HL(771.3,"B","PID",""))
"RTN","IVMLDEM6",157,0)
 S IVMDA1=$O(^IVM(301.5,IVMDA2,"IN","B",IVMDA1,""),-1)
"RTN","IVMLDEM6",158,0)
 Q:'IVMDA1 IVMFLAG
"RTN","IVMLDEM6",159,0)
 ;
"RTN","IVMLDEM6",160,0)
 S IVMI=0 F  S IVMI=$O(^IVM(301.92,"AD",IVMI)) Q:IVMI']""  D
"RTN","IVMLDEM6",161,0)
 .S IVMJ=0 F  S IVMJ=$O(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM","B",IVMI,IVMJ)) Q:IVMJ']""  D
"RTN","IVMLDEM6",162,0)
 ..;
"RTN","IVMLDEM6",163,0)
 ..; - check for data node in (#301.511) sub-file
"RTN","IVMLDEM6",164,0)
 ..S IVMNODE=$G(^IVM(301.5,IVMDA2,"IN",IVMDA1,"DEM",IVMJ,0))
"RTN","IVMLDEM6",165,0)
 ..I ('+IVMNODE)!($P(IVMNODE,"^",2)']"") Q
"RTN","IVMLDEM6",166,0)
 ..;
"RTN","IVMLDEM6",167,0)
 ..; - check if residence phone number -> do not auto-upload
"RTN","IVMLDEM6",168,0)
 ..I (IVMPPICK=1&(+IVMNODE=$O(^IVM(301.92,"B","PHONE NUMBER [RESIDENCE]",0)))) D DEMBULL^IVMPREC6 Q
"RTN","IVMLDEM6",169,0)
 ..;
"RTN","IVMLDEM6",170,0)
 ..; - load addr field rec'd from IVM into DHCP (#2) file
"RTN","IVMLDEM6",171,0)
 ..I 'NOUPDT D UPLOAD(+DFN,$P($G(^IVM(301.92,+IVMNODE,0)),"^",5),$P(IVMNODE,"^",2)) S IVMFLAG=1
"RTN","IVMLDEM6",172,0)
 ..;
"RTN","IVMLDEM6",173,0)
 ..; - remove entry from (#301.511) sub-file
"RTN","IVMLDEM6",174,0)
 ..D DELENT^IVMLDEMU(IVMDA2,IVMDA1,IVMJ)
"RTN","IVMLDEM6",175,0)
 ..; - if no display or uploadable fields left, then delete the PID
"RTN","IVMLDEM6",176,0)
 ..;   segment
"RTN","IVMLDEM6",177,0)
 ..I '$$DEMO^IVMLDEM5(IVMDA2,IVMDA1,0),'$$DEMO^IVMLDEM5(IVMDA2,IVMDA1,1) D
"RTN","IVMLDEM6",178,0)
 ...D DELETE^IVMLDEM5(IVMDA2,IVMDA1," ") ; Dummy up name parameter
"RTN","IVMLDEM6",179,0)
 Q IVMFLAG
"RTN","IVMLDEM6",180,0)
 ;
"RTN","IVMPREC8")
0^2^B26857212
"RTN","IVMPREC8",1,0)
IVMPREC8 ;ALB/KCL/BRM - PROCESS INCOMING (Z05 EVENT TYPE) HL7 MESSAGES (CON'T) ; 10/25/02 8:32am
"RTN","IVMPREC8",2,0)
 ;;2.0; INCOME VERIFICATION MATCH ;**5,6,12,58,73**; 21-OCT-94
"RTN","IVMPREC8",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMPREC8",4,0)
 ;
"RTN","IVMPREC8",5,0)
 ; This routine is called from IVMPREC6.
"RTN","IVMPREC8",6,0)
 ; This routine will process batch ORU demographic (event type Z05) HL7
"RTN","IVMPREC8",7,0)
 ; messages received from the IVM center.
"RTN","IVMPREC8",8,0)
 ;
"RTN","IVMPREC8",9,0)
 ;
"RTN","IVMPREC8",10,0)
 ;
"RTN","IVMPREC8",11,0)
PID ; - compare PID segment fields with DHCP fields
"RTN","IVMPREC8",12,0)
 N COMPPH1,COMPPH2
"RTN","IVMPREC8",13,0)
 ;
"RTN","IVMPREC8",14,0)
 ; - strip off segment name
"RTN","IVMPREC8",15,0)
 S IVMPIECE=$E(IVMXREF,4,7)
"RTN","IVMPREC8",16,0)
 ;
"RTN","IVMPREC8",17,0)
 I $P(IVMSEG,HLFS,$E(IVMPIECE,1,2))]"" D
"RTN","IVMPREC8",18,0)
 .;
"RTN","IVMPREC8",19,0)
 .; - if PID field is the address field - parse address
"RTN","IVMPREC8",20,0)
 .S IVMADFLG=0
"RTN","IVMPREC8",21,0)
 .I IVMXREF["PID11" D  Q:IVMFLD=""
"RTN","IVMPREC8",22,0)
 ..; - get PID address field containing 5 pieces seperated by HLECH (~)
"RTN","IVMPREC8",23,0)
 ..S IVMADDR=$P(IVMSEG,HLFS,$E(IVMPIECE,1,2))
"RTN","IVMPREC8",24,0)
 ..; - get piece of address field, and set IVMFLD
"RTN","IVMPREC8",25,0)
 ..S IVMPIECE=$E(IVMPIECE,3,4),IVMFLD=$P(IVMADDR,$E(HLECH),IVMPIECE)
"RTN","IVMPREC8",26,0)
 ..Q:IVMFLD=""
"RTN","IVMPREC8",27,0)
 ..; - convert state abbrev. to pointer
"RTN","IVMPREC8",28,0)
 ..I IVMPIECE=4 S (IVMSTPTR,IVMFLD)=+$O(^DIC(5,"C",IVMFLD,0))
"RTN","IVMPREC8",29,0)
 ..I IVMPIECE=5 S X=IVMFLD D ZIPIN^VAFADDR S IVMFLD=X
"RTN","IVMPREC8",30,0)
 ..S IVMADFLG=1
"RTN","IVMPREC8",31,0)
 .;
"RTN","IVMPREC8",32,0)
 .I IVMXREF["PID12" S IVMADFLG=1,IVMFLD=+$O(^DIC(5,IVMSTPTR,1,"C",$P(IVMSEG,HLFS,12),0))
"RTN","IVMPREC8",33,0)
 .; line remove so that the phone number is compared 
"RTN","IVMPREC8",34,0)
 .; before saving to 301.5.
"RTN","IVMPREC8",35,0)
 .;I IVMXREF["PID13" S IVMFLD=$P(IVMSEG,HLFS,13) D STORE^IVMPREC9 S IVMADFLG=1 Q
"RTN","IVMPREC8",36,0)
 .;
"RTN","IVMPREC8",37,0)
 .; - file address fields and quit
"RTN","IVMPREC8",38,0)
 .I IVMADFLG D STORE^IVMPREC9 Q
"RTN","IVMPREC8",39,0)
 .;
"RTN","IVMPREC8",40,0)
 .; - otherwise, set IVMFLD to field rec'd from IVM
"RTN","IVMPREC8",41,0)
 .;   for comparison with DHCP field
"RTN","IVMPREC8",42,0)
 .S IVMFLD=$P(IVMSEG,HLFS,IVMPIECE)
"RTN","IVMPREC8",43,0)
 .;
"RTN","IVMPREC8",44,0)
 .; - if HL7 date convert to FM date and set IVMFLD
"RTN","IVMPREC8",45,0)
 .I IVMXREF["PID07" S IVMFLD=$$FMDATE^HLFNC(IVMFLD)
"RTN","IVMPREC8",46,0)
 .;
"RTN","IVMPREC8",47,0)
 .; - call VADPT routine to return DHCP demographics
"RTN","IVMPREC8",48,0)
 .D DEM^VADPT,ADD^VADPT
"RTN","IVMPREC8",49,0)
 .;
"RTN","IVMPREC8",50,0)
 .; - execute code on the 1 node and get DHCP field for comparison
"RTN","IVMPREC8",51,0)
 .S IVMDHCP="" X:$D(^IVM(301.92,+IVMDEMDA,1)) ^(1) S IVMDHCP=Y
"RTN","IVMPREC8",52,0)
 .;
"RTN","IVMPREC8",53,0)
 .; - special logic for phone number processing
"RTN","IVMPREC8",54,0)
 .; - if different, then store the actual value received, then quit
"RTN","IVMPREC8",55,0)
 .I IVMXREF["PID13",IVMFLD]"" D  Q
"RTN","IVMPREC8",56,0)
 ..S COMPPH1=$$CONVPH(IVMFLD)
"RTN","IVMPREC8",57,0)
 ..S COMPPH2=$$CONVPH(IVMDHCP)
"RTN","IVMPREC8",58,0)
 ..I COMPPH1'=COMPPH2 D STORE^IVMPREC9
"RTN","IVMPREC8",59,0)
 .;
"RTN","IVMPREC8",60,0)
 .; - if field from IVM does not equal DHCP field - store for uploading
"RTN","IVMPREC8",61,0)
 .I IVMFLD]"",(IVMFLD'=IVMDHCP) D STORE^IVMPREC9
"RTN","IVMPREC8",62,0)
 Q
"RTN","IVMPREC8",63,0)
 ;
"RTN","IVMPREC8",64,0)
 ;
"RTN","IVMPREC8",65,0)
ZPD ; - compare ZPD segment fields with DHCP fields
"RTN","IVMPREC8",66,0)
 S IVMPIECE=$E(IVMXREF,4,5)
"RTN","IVMPREC8",67,0)
 I $P(IVMSEG,HLFS,IVMPIECE)]"" D
"RTN","IVMPREC8",68,0)
 .;
"RTN","IVMPREC8",69,0)
 .; - set var to HL7 field
"RTN","IVMPREC8",70,0)
 .S IVMFLD=$P(IVMSEG,HLFS,IVMPIECE)
"RTN","IVMPREC8",71,0)
 .;
"RTN","IVMPREC8",72,0)
 .; - if HL7 date convert to FM date
"RTN","IVMPREC8",73,0)
 .I IVMXREF["ZPD09"!(IVMXREF["ZPD13") S IVMFLD=$$FMDATE^HLFNC(IVMFLD)
"RTN","IVMPREC8",74,0)
 .;
"RTN","IVMPREC8",75,0)
 .; - execute code on the 1 node and get DHCP field
"RTN","IVMPREC8",76,0)
 .S IVMDHCP="" X:$D(^IVM(301.92,+IVMDEMDA,1)) ^(1) S IVMDHCP=Y
"RTN","IVMPREC8",77,0)
 .;
"RTN","IVMPREC8",78,0)
 .; - if field from IVM does not equal DHCP field - store for uploading 
"RTN","IVMPREC8",79,0)
 .I IVMFLD]"",(IVMFLD'=IVMDHCP) D STORE^IVMPREC9
"RTN","IVMPREC8",80,0)
 Q
"RTN","IVMPREC8",81,0)
 ;
"RTN","IVMPREC8",82,0)
 ;
"RTN","IVMPREC8",83,0)
ZGD ; - compare ZGD segment fields with DHCP fields
"RTN","IVMPREC8",84,0)
 S IVMADFLG=0
"RTN","IVMPREC8",85,0)
 S IVMPIECE=$E(IVMXREF,4,7)
"RTN","IVMPREC8",86,0)
 I $P(IVMSEG,HLFS,$E(IVMPIECE,1,2))]"" D
"RTN","IVMPREC8",87,0)
 .;
"RTN","IVMPREC8",88,0)
 .; - set var IVMFLD to incoming HL7 field
"RTN","IVMPREC8",89,0)
 .I 'IVMADFLG S IVMFLD=$P(IVMSEG,HLFS,IVMPIECE)
"RTN","IVMPREC8",90,0)
 .;
"RTN","IVMPREC8",91,0)
 .; - ZGD06 as the ZGD address field containing 5 pieces seperated by HLECH (~)
"RTN","IVMPREC8",92,0)
 .I IVMXREF["ZGD06" D
"RTN","IVMPREC8",93,0)
 ..S IVMADDR=$P(IVMSEG,HLFS,$E(IVMPIECE,1,2)),IVMPIECE=$E(IVMPIECE,3)
"RTN","IVMPREC8",94,0)
 ..S IVMFLD=$P(IVMADDR,$E(HLECH),IVMPIECE),IVMADFLG=1
"RTN","IVMPREC8",95,0)
 ..I IVMFLD]"",IVMPIECE=4 S IVMFLD=$O(^DIC(5,"C",IVMFLD,0))
"RTN","IVMPREC8",96,0)
 ..I IVMFLD]"",IVMPIECE=5 S X=IVMFLD D ZIPIN^VAFADDR S IVMFLD=$G(X)
"RTN","IVMPREC8",97,0)
 .;
"RTN","IVMPREC8",98,0)
 .; - if HL7 date convert to FM date
"RTN","IVMPREC8",99,0)
 .I IVMXREF["ZGD08" S IVMFLD=$$FMDATE^HLFNC(IVMFLD)
"RTN","IVMPREC8",100,0)
 .;
"RTN","IVMPREC8",101,0)
 .; - execute code on the 1 node and get DHCP field
"RTN","IVMPREC8",102,0)
 .S IVMDHCP="" X:$D(^IVM(301.92,+IVMDEMDA,1)) ^(1) S IVMDHCP=Y
"RTN","IVMPREC8",103,0)
 .;
"RTN","IVMPREC8",104,0)
 .; if field from IVM does not equal DHCP field - store for uploading
"RTN","IVMPREC8",105,0)
 .I IVMFLD]"",(IVMFLD'=IVMDHCP) D STORE^IVMPREC9
"RTN","IVMPREC8",106,0)
 Q
"RTN","IVMPREC8",107,0)
 ;
"RTN","IVMPREC8",108,0)
RF1(IVMSEG) ; - compare RF1 segment fields against DHCP and file address
"RTN","IVMPREC8",109,0)
 ;   data into the Patient (#2) file if the address is more recent
"RTN","IVMPREC8",110,0)
 ;   than the one on file.
"RTN","IVMPREC8",111,0)
 ;
"RTN","IVMPREC8",112,0)
 Q:$G(IVMSEG)']""
"RTN","IVMPREC8",113,0)
 N ADDR6,ADDRSIT,ADDRSRC,NOUPDT,ERRMSG,FDA
"RTN","IVMPREC8",114,0)
 S IVMADFLG=1
"RTN","IVMPREC8",115,0)
 ;   sequences 1-5 in RF1 are not currently used
"RTN","IVMPREC8",116,0)
 ;
"RTN","IVMPREC8",117,0)
 ; - get address update site and source
"RTN","IVMPREC8",118,0)
 ;   (4 components) separated by a tilde (~)
"RTN","IVMPREC8",119,0)
 S ADDR6=$P(IVMSEG,HLFS,6)
"RTN","IVMPREC8",120,0)
 S ADDRSIT=$P(ADDR6,"~",1)
"RTN","IVMPREC8",121,0)
 S ADDRSRC=$$ADDRCNV($P(ADDR6,"~",2))
"RTN","IVMPREC8",122,0)
 S:ADDRSRC'="VAMC" ADDRSIT=""
"RTN","IVMPREC8",123,0)
 ;   components 3 and 4 in RF1 sequence 6 are not currently used
"RTN","IVMPREC8",124,0)
 ;
"RTN","IVMPREC8",125,0)
 ; - get Date/Time of Address change
"RTN","IVMPREC8",126,0)
 S ADDR7=$P(IVMSEG,HLFS,7)
"RTN","IVMPREC8",127,0)
 S ADDRDT=$$FMDATE^HLFNC(ADDR7)
"RTN","IVMPREC8",128,0)
 ;
"RTN","IVMPREC8",129,0)
 ; see Address Indexing HL7 Review doc for SEQ 8-10 approval details
"RTN","IVMPREC8",130,0)
 ; - Invalid Address Date (SEQ 8) - not currently used but is approved
"RTN","IVMPREC8",131,0)
 ; - Date Checked by NCOA (SEQ 9) - not currently used but is approved
"RTN","IVMPREC8",132,0)
 ; - Invalid Address Reason (SEQ 10) - not used but has been approved
"RTN","IVMPREC8",133,0)
 ; 
"RTN","IVMPREC8",134,0)
 ; - get address date/time updated from the Patient (#2) file
"RTN","IVMPREC8",135,0)
 S ADDRDT2=$P($G(^DPT(DFN,.11)),"^",13)
"RTN","IVMPREC8",136,0)
 ;
"RTN","IVMPREC8",137,0)
 ; - quit w/o update if incoming address older than existing address
"RTN","IVMPREC8",138,0)
 Q:'ADDRDT
"RTN","IVMPREC8",139,0)
 I ADDRDT'>ADDRDT2 S NOUPDT=1
"RTN","IVMPREC8",140,0)
 ;
"RTN","IVMPREC8",141,0)
 ; - update Patient file address data if necessary
"RTN","IVMPREC8",142,0)
 Q:'$$AUTOADDR^IVMLDEM6(DFN,1,+$G(NOUPDT))
"RTN","IVMPREC8",143,0)
 ;
"RTN","IVMPREC8",144,0)
 ; - set up FDA array for change date, source, and site
"RTN","IVMPREC8",145,0)
 S FDA(2,DFN_",",.118)=$$FMTE^XLFDT($G(ADDRDT))
"RTN","IVMPREC8",146,0)
 S FDA(2,DFN_",",.119)=$G(ADDRSRC)
"RTN","IVMPREC8",147,0)
 S FDA(2,DFN_",",.12)=$G(ADDRSIT)
"RTN","IVMPREC8",148,0)
 D FILE^DIE("E","FDA","ERRMSG")
"RTN","IVMPREC8",149,0)
 Q
"RTN","IVMPREC8",150,0)
ADDRCNV(ADDRSRC) ;convert Address Source from HL7 to DHCP format
"RTN","IVMPREC8",151,0)
 ;
"RTN","IVMPREC8",152,0)
 Q:$G(ADDRSRC)']"" ""
"RTN","IVMPREC8",153,0)
 Q:ADDRSRC="USVAHEC" "HEC"
"RTN","IVMPREC8",154,0)
 Q:ADDRSRC="USVAMC" "VAMC"
"RTN","IVMPREC8",155,0)
 Q:ADDRSRC="USVAHBSC" "HBSC"
"RTN","IVMPREC8",156,0)
 Q:ADDRSRC="USNCOA" "NCOA"
"RTN","IVMPREC8",157,0)
 Q:ADDRSRC="USVABVA" "BVA"
"RTN","IVMPREC8",158,0)
 Q:ADDRSRC="USVAINS" "VAINS"
"RTN","IVMPREC8",159,0)
 Q:ADDRSRC="USPS" "USPS"
"RTN","IVMPREC8",160,0)
 Q ""
"RTN","IVMPREC8",161,0)
CONVPH(PH) ;remove special chars/spaces from Phone number
"RTN","IVMPREC8",162,0)
 Q $TR(PH," )(/#\-","")
"VER")
8.0^22
**END**
**END**
