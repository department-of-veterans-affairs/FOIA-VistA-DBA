EMERGENCY Released XU*8*324 SEQ #262
Extracted from mail message
**KIDS**:XU*8.0*324^

**INSTALL NAME**
XU*8.0*324
"BLD",774,0)
XU*8.0*324^KERNEL^0^3030902^y
"BLD",774,1,0)
^^2^2^3030826^
"BLD",774,1,1,0)
See patch XU*8*324 in the National Patch Module on FORUM for complete
"BLD",774,1,2,0)
information on this patch.
"BLD",774,4,0)
^9.64PA^^
"BLD",774,"INID")
^
"BLD",774,"INIT")
XU8P324
"BLD",774,"KRN",0)
^9.67PA^8989.52^19
"BLD",774,"KRN",.4,0)
.4
"BLD",774,"KRN",.4,"NM",0)
^9.68A^1^1
"BLD",774,"KRN",.4,"NM",1,0)
XU-CLINICAL TRAINEE DB COUNT    FILE #200^200^0
"BLD",774,"KRN",.4,"NM","B","XU-CLINICAL TRAINEE DB COUNT    FILE #200",1)

"BLD",774,"KRN",.401,0)
.401
"BLD",774,"KRN",.401,"NM",0)
^9.68A^1^1
"BLD",774,"KRN",.401,"NM",1,0)
XU-CLINICAL TRAINEE DB COUNT    FILE #200^200^0
"BLD",774,"KRN",.401,"NM","B","XU-CLINICAL TRAINEE DB COUNT    FILE #200",1)

"BLD",774,"KRN",.402,0)
.402
"BLD",774,"KRN",.403,0)
.403
"BLD",774,"KRN",.5,0)
.5
"BLD",774,"KRN",.84,0)
.84
"BLD",774,"KRN",3.6,0)
3.6
"BLD",774,"KRN",3.8,0)
3.8
"BLD",774,"KRN",3.8,"NM",0)
^9.68A^1^1
"BLD",774,"KRN",3.8,"NM",1,0)
XUOAA CLIN TRAINEE TRANS^^0
"BLD",774,"KRN",3.8,"NM","B","XUOAA CLIN TRAINEE TRANS",1)

"BLD",774,"KRN",9.2,0)
9.2
"BLD",774,"KRN",9.8,0)
9.8
"BLD",774,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",774,"KRN",9.8,"NM",1,0)
XUOAAHL7^^0^B32801189
"BLD",774,"KRN",9.8,"NM","B","XUOAAHL7",1)

"BLD",774,"KRN",19,0)
19
"BLD",774,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",774,"KRN",19,"NM",1,0)
XU-CLINICAL TRAINEE COUNT^^0
"BLD",774,"KRN",19,"NM",2,0)
XU-CLINICAL TRAINEE MENU^^2
"BLD",774,"KRN",19,"NM","B","XU-CLINICAL TRAINEE COUNT",1)

"BLD",774,"KRN",19,"NM","B","XU-CLINICAL TRAINEE MENU",2)

"BLD",774,"KRN",19.1,0)
19.1
"BLD",774,"KRN",101,0)
101
"BLD",774,"KRN",409.61,0)
409.61
"BLD",774,"KRN",771,0)
771
"BLD",774,"KRN",870,0)
870
"BLD",774,"KRN",8989.51,0)
8989.51
"BLD",774,"KRN",8989.52,0)
8989.52
"BLD",774,"KRN",8994,0)
8994
"BLD",774,"KRN","B",.4,.4)

"BLD",774,"KRN","B",.401,.401)

"BLD",774,"KRN","B",.402,.402)

"BLD",774,"KRN","B",.403,.403)

"BLD",774,"KRN","B",.5,.5)

"BLD",774,"KRN","B",.84,.84)

"BLD",774,"KRN","B",3.6,3.6)

"BLD",774,"KRN","B",3.8,3.8)

"BLD",774,"KRN","B",9.2,9.2)

"BLD",774,"KRN","B",9.8,9.8)

"BLD",774,"KRN","B",19,19)

"BLD",774,"KRN","B",19.1,19.1)

"BLD",774,"KRN","B",101,101)

"BLD",774,"KRN","B",409.61,409.61)

"BLD",774,"KRN","B",771,771)

"BLD",774,"KRN","B",870,870)

"BLD",774,"KRN","B",8989.51,8989.51)

"BLD",774,"KRN","B",8989.52,8989.52)

"BLD",774,"KRN","B",8994,8994)

"BLD",774,"QUES",0)
^9.62^1^1
"BLD",774,"QUES",1,0)
POS1
"BLD",774,"QUES",1,1)
SB^P:PRODUCTION;T:TEST
"BLD",774,"QUES",1,"A")
In which account is this install taking place?
"BLD",774,"QUES",1,"Q")
Answer in which account so I know whether or not to transmit.
"BLD",774,"QUES","B","POS1",1)

"BLD",774,"REQB",0)
^9.611^1^1
"BLD",774,"REQB",1,0)
XU*8.0*251^2
"BLD",774,"REQB","B","XU*8.0*251",1)

"INIT")
XU8P324
"KRN",.4,97,-1)
0^1
"KRN",.4,97,0)
XU-CLINICAL TRAINEE DB COUNT^3030902.1404^@^200^^@^3030902
"KRN",.4,97,"DCL","200^.01")
!
"KRN",.4,97,"DNP")
1
"KRN",.4,97,"F",2)
.01;X~
"KRN",.4,97,"H")
OAA Clinical Trainee Database Count
"KRN",.401,56,-1)
0^1
"KRN",.401,56,0)
XU-CLINICAL TRAINEE DB COUNT^3030820.1313^@^200^^@^3030902
"KRN",.401,56,2,0)
^.4014^1^1
"KRN",.401,56,2,1,0)
200^^(#12.2)'=""^@"B^;L1^^^^^4
"KRN",.401,56,2,1,"CM")
S Y(1)=$S($D(^VA(200,D0,12)):^(12),1:"") S X=$P($G(^USC(8932.2,+$P(Y(1),U,2),0)),U)'="" I D0>0 S DISX(1)=X
"KRN",.401,56,2,1,"F")
0
"KRN",.401,56,2,1,"GET")
S Y(1)=$S($D(^VA(200,D0,12)):^(12),1:"") S X=$P($G(^USC(8932.2,+$P(Y(1),U,2),0)),U)'="" I D0>0 S DISX(1)=X
"KRN",.401,56,2,1,"QCON")
I (DISX(1)]]0)&(DISX(1)']]1)
"KRN",.401,56,2,1,"T")
1
"KRN",.401,56,2,1,"TXT")
(#12.2)'=""""
"KRN",.401,56,2,"B",200,1)

"KRN",.401,56,"%D",0)
^^2^2^3030820^
"KRN",.401,56,"%D",1,0)
This is the sort that counts the number of entries where field PROGRAM OF 
"KRN",.401,56,"%D",2,0)
STUDY(12.2) is not null.
"KRN",3.8,28,-1)
0^1
"KRN",3.8,28,0)
XUOAA CLIN TRAINEE TRANS^PU^^^^^
"KRN",3.8,28,2,0)
^^2^2^3030820^
"KRN",3.8,28,2,1,0)
When the OAAA HL7 messages are generated a message is generated with the 
"KRN",3.8,28,2,2,0)
number of records that are transmitted to the OAA national database.
"KRN",3.8,28,3)

"KRN",19,926,-1)
2^2
"KRN",19,926,0)
XU-CLINICAL TRAINEE MENU^OAA Clinical Trainee^^M^70^^^^^^^3
"KRN",19,926,10,0)
^19.01IP^3^3
"KRN",19,926,10,3,0)
949
"KRN",19,926,10,3,"^")
XU-CLINICAL TRAINEE COUNT
"KRN",19,926,"U")
OAA CLINICAL TRAINEE
"KRN",19,949,-1)
0^1
"KRN",19,949,0)
XU-CLINICAL TRAINEE COUNT^Count of Clinical Trainee's^^P^^^^^^^^KERNEL
"KRN",19,949,1,0)
^^2^2^3030820^
"KRN",19,949,1,1,0)
This option reports the total number of Clinical Trainee's that have been 
"KRN",19,949,1,2,0)
entered into the New Person(#200) file.
"KRN",19,949,60)
VA(200,
"KRN",19,949,62)
0
"KRN",19,949,63)
[XU-CLINICAL TRAINEE DB COUNT]
"KRN",19,949,64)
[XU-CLINICAL TRAINEE DB COUNT]
"KRN",19,949,65)

"KRN",19,949,66)

"KRN",19,949,"U")
COUNT OF CLINICAL TRAINEE'S
"MBREQ")
0
"ORD",5,.4)
.4;5;;;EDEOUT^DIFROMSO(.4,DA,"",XPDA);FPRE^DIFROMSI(.4,"",XPDA);EPRE^DIFROMSI(.4,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.4,DA,"",XPDA);DEL^DIFROMSK(.4,"",%)
"ORD",5,.4,0)
PRINT TEMPLATE
"ORD",6,.401)
.401;6;;;EDEOUT^DIFROMSO(.401,DA,"",XPDA);FPRE^DIFROMSI(.401,"",XPDA);EPRE^DIFROMSI(.401,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.401,DA,"",XPDA);DEL^DIFROMSK(.401,"",%)
"ORD",6,.401,0)
SORT TEMPLATE
"ORD",11,3.8)
3.8;11;;;MAILG^XPDTA1;MAILGF1^XPDIA1;MAILGE1^XPDIA1;MAILGF2^XPDIA1;;MAILGDEL^XPDIA1(%)
"ORD",11,3.8,0)
MAIL GROUP
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
324^3030902
"PKG",3,22,1,"PAH",1,1,0)
^^2^2^3030902
"PKG",3,22,1,"PAH",1,1,1,0)
See patch XU*8*324 in the National Patch Module on FORUM for complete
"PKG",3,22,1,"PAH",1,1,2,0)
information on this patch.
"QUES","POS1",0)
SB^P:PRODUCTION;T:TEST
"QUES","POS1","?")
Answer in which account so I know whether or not to transmit.
"QUES","POS1","A")
In which account is this install taking place?
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","XU8P324")
0^^B1570824
"RTN","XU8P324",1,0)
XU8P324 ;OOIFO/SO- REINDEX 'ATR' AND RETRANSMIT DATA;6:30 AM  26 Aug 2003
"RTN","XU8P324",2,0)
 ;;8.0;KERNEL;**324**;Jul 10, 1995
"RTN","XU8P324",3,0)
RENDX ;DELETE AND RE-INDEX THE 'ATR' CROSS REFERENCE
"RTN","XU8P324",4,0)
 D MES^XPDUTL("Reindexing ""ATR"" cross reference...")
"RTN","XU8P324",5,0)
 N DIK
"RTN","XU8P324",6,0)
 S DIK="^VA(200,"
"RTN","XU8P324",7,0)
 S DIK(1)="12.2^ATR"
"RTN","XU8P324",8,0)
 D ENALL^DIK ;EXECUTE THE SET LOGIC
"RTN","XU8P324",9,0)
 D MES^XPDUTL("Done reindexing ""ATR"" cross reference.")
"RTN","XU8P324",10,0)
 ;
"RTN","XU8P324",11,0)
RETRANS ;RETRANSMIT ALL OF THE OAA TRAINEES
"RTN","XU8P324",12,0)
 I $G(XPDQUES("POS1"))="T" D MES^XPDUTL("Non-production account.  No transmission of OAA data will take place.") K ^VA(200,"ATR") Q
"RTN","XU8P324",13,0)
 D MES^XPDUTL("Begin transmission of OAA data...")
"RTN","XU8P324",14,0)
 D OAA^XUOAAHL7
"RTN","XU8P324",15,0)
 D MES^XPDUTL("Done with transmission of OAA data.")
"RTN","XU8P324",16,0)
 Q
"RTN","XUOAAHL7")
0^1^B32801189
"RTN","XUOAAHL7",1,0)
XUOAAHL7 ;OAKCIOFO/JLG - Clinical Trainee HL7 Msg Routine;10:32 AM  2 Sep 2003
"RTN","XUOAAHL7",2,0)
 ;;8.0;KERNEL;**251,324**;Jul 10, 1995
"RTN","XUOAAHL7",3,0)
 Q
"RTN","XUOAAHL7",4,0)
OAA ; entry point for the scheduled option [XUOAA SEND HL7 MESSAGE]
"RTN","XUOAAHL7",5,0)
 ; This routine generates an HL7 PMU message, Update Personnel Record,
"RTN","XUOAAHL7",6,0)
 ; based on data pointed by the ^VA(200,"ATR",ien) cross-reference.
"RTN","XUOAAHL7",7,0)
 ; The type of message is PMU~B02 with the following structure:
"RTN","XUOAAHL7",8,0)
 ;      MSH,EVN,STF,PRA,ORG,EDU
"RTN","XUOAAHL7",9,0)
 ; The data generated for the STF,PRA,ORG, and EDU are not repeating.
"RTN","XUOAAHL7",10,0)
 ;
"RTN","XUOAAHL7",11,0)
 ; Input:
"RTN","XUOAAHL7",12,0)
 ;   MSGID       (required) Pass by reference
"RTN","XUOAAHL7",13,0)
 ;   ERROR       (required) Pass by reference
"RTN","XUOAAHL7",14,0)
 ;
"RTN","XUOAAHL7",15,0)
 ; Output:
"RTN","XUOAAHL7",16,0)
 ;   MSGID       The message id assigned to the message when the call
"RTN","XUOAAHL7",17,0)
 ;               succeeds; null when call does not succeed.
"RTN","XUOAAHL7",18,0)
 ;   ERROR       0 if call succeeds.
"RTN","XUOAAHL7",19,0)
 ;               "1^description of error" if call fails
"RTN","XUOAAHL7",20,0)
 ;
"RTN","XUOAAHL7",21,0)
 ; Pre-conditions:
"RTN","XUOAAHL7",22,0)
 ;    - ^VA(200,"ATR") exists
"RTN","XUOAAHL7",23,0)
 ;    - XUOAA PMU event protocol and XUOAA ACK subscriber protocols are
"RTN","XUOAAHL7",24,0)
 ;      active.
"RTN","XUOAAHL7",25,0)
 ; Postcondition:
"RTN","XUOAAHL7",26,0)
 ;    - An HL7 PMU-B02 message is queued for transmission.
"RTN","XUOAAHL7",27,0)
 ;    - the ^VA(200,"ATR") x-reference is killed when queueing is
"RTN","XUOAAHL7",28,0)
 ;      successful; otherwise, it is left intact for next attempt.
"RTN","XUOAAHL7",29,0)
 ;
"RTN","XUOAAHL7",30,0)
 N CNT,CS,ERROR,FS,INDX,RESULT,SS,TOTAL,XUCNT,XUHLDT,XUHLDT1,XUHLMID
"RTN","XUOAAHL7",31,0)
 N XUMTIEN,XUOAA,XUOAAHL
"RTN","XUOAAHL7",32,0)
 S TOTAL=0
"RTN","XUOAAHL7",33,0)
LOOP1 ; Generate batch messages of 100 messages long
"RTN","XUOAAHL7",34,0)
 I '$D(^VA(200,"ATR")) D MAIL Q  ;No "ATR" xref
"RTN","XUOAAHL7",35,0)
 K ^TMP("HLS",$J),XUOAA
"RTN","XUOAAHL7",36,0)
 S (INDX,XUOAA,CNT,ERROR)=0
"RTN","XUOAAHL7",37,0)
 D INIT Q:ERROR
"RTN","XUOAAHL7",38,0)
 D STUB Q:ERROR  ; create msg stub (batch)
"RTN","XUOAAHL7",39,0)
 ; iterate over list of entries (100 max) and build batch message
"RTN","XUOAAHL7",40,0)
 F  S INDX=$O(^VA(200,"ATR",INDX)) Q:'INDX!(XUOAA>99)  D
"RTN","XUOAAHL7",41,0)
 . L +^VA(200,INDX):30 Q:'$T
"RTN","XUOAAHL7",42,0)
 . S XUOAA=XUOAA+1 ; message count in batch
"RTN","XUOAAHL7",43,0)
 . ; temporary array to keep track of entries
"RTN","XUOAAHL7",44,0)
 . S XUOAA(INDX)=$G(^VA(200,"ATR",INDX)) ; date/time recorded
"RTN","XUOAAHL7",45,0)
 . D BLDMSG(INDX) ; build message for this entry
"RTN","XUOAAHL7",46,0)
 . K ^VA(200,"ATR",INDX)
"RTN","XUOAAHL7",47,0)
 . S TOTAL=TOTAL+1
"RTN","XUOAAHL7",48,0)
 . L -^VA(200,INDX)
"RTN","XUOAAHL7",49,0)
 D SEND
"RTN","XUOAAHL7",50,0)
 I ERROR D RESTORE,STORENV Q
"RTN","XUOAAHL7",51,0)
 I XUOAA>99 G LOOP1 ; more than 100 entries, create another batch
"RTN","XUOAAHL7",52,0)
 K ^TMP("HLS",$J),XUOAA
"RTN","XUOAAHL7",53,0)
 D MAIL
"RTN","XUOAAHL7",54,0)
 Q
"RTN","XUOAAHL7",55,0)
 ;
"RTN","XUOAAHL7",56,0)
INIT ; initialize HL variables
"RTN","XUOAAHL7",57,0)
 ; "XUOAA PMU"=event protocol, XUOAAHL=hl variables
"RTN","XUOAAHL7",58,0)
 ; checks for valid event protocol
"RTN","XUOAAHL7",59,0)
 D INIT^HLFNC2("XUOAA PMU",.XUOAAHL)
"RTN","XUOAAHL7",60,0)
 I $G(XUOAAHL) S ERROR="1^"_$P(XUOAAHL,U,2) Q
"RTN","XUOAAHL7",61,0)
 S FS=$G(XUOAAHL("FS")) ;field separator
"RTN","XUOAAHL7",62,0)
 S CS=$E(XUOAAHL("ECH"),1) ;component separator
"RTN","XUOAAHL7",63,0)
 S SS=$E(XUOAAHL("ECH"),4) ;sub-component separator
"RTN","XUOAAHL7",64,0)
 Q
"RTN","XUOAAHL7",65,0)
 ;
"RTN","XUOAAHL7",66,0)
STUB ; create msg stub for batch msg
"RTN","XUOAAHL7",67,0)
 ; XUHLMID=batch msg id, XUMTIEN=file 772 ien
"RTN","XUOAAHL7",68,0)
 ; XUHLDT=FM date/time, XUHLDT1=HL7 date/time
"RTN","XUOAAHL7",69,0)
 D CREATE^HLTF(.XUHLMID,.XUMTIEN,.XUHLDT,.XUHLDT1)
"RTN","XUOAAHL7",70,0)
 I 'XUHLMID S ERROR="1^could not create msg stub" Q
"RTN","XUOAAHL7",71,0)
 Q
"RTN","XUOAAHL7",72,0)
 ;
"RTN","XUOAAHL7",73,0)
BLDMSG(IEN) ;
"RTN","XUOAAHL7",74,0)
 N ADDR,CITY,DEGLEV,DOB,EMAIL,ENTERDT,FACILITY,GEOLOC,IFN
"RTN","XUOAAHL7",75,0)
 N LASTYR,MSHDR,NAME,PROGSTD,RECORDT,SERVICE,SSN,STATE,STREET,TERMDT
"RTN","XUOAAHL7",76,0)
 N TITLE,ZIP,XUNAME
"RTN","XUOAAHL7",77,0)
 Q:'IEN
"RTN","XUOAAHL7",78,0)
 ; extract data from Fileman and transform to HL7 datatype
"RTN","XUOAAHL7",79,0)
 S XUNAME("FILE")=200,XUNAME("FIELD")=.01,XUNAME("IENS")=IEN
"RTN","XUOAAHL7",80,0)
 S NAME=$$HLNAME^XLFNAME(.XUNAME,"S",CS)
"RTN","XUOAAHL7",81,0)
 S STREET=$$GET1^DIQ(200,IEN,"STREET ADDRESS 1")
"RTN","XUOAAHL7",82,0)
 S STREET=STREET_U_$$GET1^DIQ(200,IEN,"STREET ADDRESS 2")
"RTN","XUOAAHL7",83,0)
 S STREET=STREET_U_$$GET1^DIQ(200,IEN,"STREET ADDRESS 3")
"RTN","XUOAAHL7",84,0)
 S CITY=$$GET1^DIQ(200,IEN,"CITY")
"RTN","XUOAAHL7",85,0)
 S STATE=$$GET1^DIQ(200,IEN,"STATE","I")
"RTN","XUOAAHL7",86,0)
 S ZIP=$$GET1^DIQ(200,IEN,"ZIP CODE")
"RTN","XUOAAHL7",87,0)
 S GEOLOC=CITY_U_STATE_U_ZIP_U_"USA"
"RTN","XUOAAHL7",88,0)
 S ADDR=$$HLADDR^HLFNC(STREET,GEOLOC)
"RTN","XUOAAHL7",89,0)
 S SSN=$$GET1^DIQ(200,IEN,"SSN")
"RTN","XUOAAHL7",90,0)
 S SSN=SSN_CS_CS_CS_"USSSA"_CS_"SS"
"RTN","XUOAAHL7",91,0)
 S EMAIL=$$GET1^DIQ(200,IEN,"EMAIL ADDRESS")
"RTN","XUOAAHL7",92,0)
 S DEGLEV=$$GET1^DIQ(200,IEN,"CURRENT DEGREE LEVEL:ABBREVIATION")
"RTN","XUOAAHL7",93,0)
 S PROGSTD=$$GET1^DIQ(200,IEN,"PROGRAM OF STUDY")
"RTN","XUOAAHL7",94,0)
 S LASTYR=$$GET1^DIQ(200,IEN,"LAST TRAINING YEAR")
"RTN","XUOAAHL7",95,0)
 S SERVICE=$$GET1^DIQ(200,IEN,"SERVICE/SECTION")
"RTN","XUOAAHL7",96,0)
 S SERVICE=SERVICE_CS_CS_"SERVICE/SECTION"
"RTN","XUOAAHL7",97,0)
 S TERMDT=$$GET1^DIQ(200,IEN,"TERMINATION DATE","I")
"RTN","XUOAAHL7",98,0)
 S TERMDT=$$FMTHL7^XLFDT(TERMDT)
"RTN","XUOAAHL7",99,0)
 S:'TERMDT TERMDT=""
"RTN","XUOAAHL7",100,0)
 S TITLE=$$GET1^DIQ(200,IEN,"TITLE")
"RTN","XUOAAHL7",101,0)
 S ENTERDT=$$GET1^DIQ(200,IEN,"DATE ENTERED","I")
"RTN","XUOAAHL7",102,0)
 S ENTERDT=$$FMTHL7^XLFDT(ENTERDT)
"RTN","XUOAAHL7",103,0)
 S:'ENTERDT ENTERDT=""
"RTN","XUOAAHL7",104,0)
 ; date recorded
"RTN","XUOAAHL7",105,0)
 S RECORDT=$$FMTHL7^XLFDT($G(XUOAA(IEN)))
"RTN","XUOAAHL7",106,0)
 S FACILITY=$$NS^XUAF4($$KSP^XUPARAM("INST"))
"RTN","XUOAAHL7",107,0)
 S FACILITY=$P(FACILITY,U,2)_CS_$P(FACILITY,U)
"RTN","XUOAAHL7",108,0)
 ; IFN= internal file number
"RTN","XUOAAHL7",109,0)
 S IFN=IEN_CS_"IEN"_CS_"NEW PERSON"
"RTN","XUOAAHL7",110,0)
 S DOB=$$GET1^DIQ(200,IEN,"DOB","I")
"RTN","XUOAAHL7",111,0)
 S DOB=$$FMTHL7^XLFDT(DOB)
"RTN","XUOAAHL7",112,0)
 ; create msg header per entry
"RTN","XUOAAHL7",113,0)
 ; XUOAAHL=hl array from INIT, XUHLMID=batch msg id from STUB
"RTN","XUOAAHL7",114,0)
 ; XUOAA=message count, MSHDR=message header
"RTN","XUOAAHL7",115,0)
 D MSH^HLFNC2(.XUOAAHL,XUHLMID_"-"_XUOAA,.MSHDR)
"RTN","XUOAAHL7",116,0)
 ; build temporary MSG TEXT array
"RTN","XUOAAHL7",117,0)
 S CNT=CNT+1
"RTN","XUOAAHL7",118,0)
 S ^TMP("HLS",$J,CNT)=MSHDR
"RTN","XUOAAHL7",119,0)
 S CNT=CNT+1
"RTN","XUOAAHL7",120,0)
 S ^TMP("HLS",$J,CNT)="EVN"_FS_XUOAAHL("ETN")_FS_RECORDT_FS_FS_FS_FS_FS_FACILITY
"RTN","XUOAAHL7",121,0)
 S CNT=CNT+1
"RTN","XUOAAHL7",122,0)
 S ^TMP("HLS",$J,CNT)="STF"_FS_IFN_FS_SSN_FS_NAME_FS_FS_FS_DOB_FS_FS_FS_SERVICE_FS_FS_ADDR_FS_FS_FS_FS_EMAIL_FS_FS_FS_TITLE
"RTN","XUOAAHL7",123,0)
 S CNT=CNT+1
"RTN","XUOAAHL7",124,0)
 S ^TMP("HLS",$J,CNT)="PRA"_FS_FS_FS_FS_FS_PROGSTD_CS_CS_CS_CS_LASTYR
"RTN","XUOAAHL7",125,0)
 S CNT=CNT+1
"RTN","XUOAAHL7",126,0)
 S ^TMP("HLS",$J,CNT)="ORG"_FS_1_FS_FACILITY_FS_SERVICE_FS_FS_FS_FS_FS_CS_PROGSTD_CS_"PROGRAM OF STUDY"_FS_ENTERDT_CS_TERMDT
"RTN","XUOAAHL7",127,0)
 S CNT=CNT+1
"RTN","XUOAAHL7",128,0)
 S ^TMP("HLS",$J,CNT)="EDU"_FS_"1"_FS_DEGLEV
"RTN","XUOAAHL7",129,0)
 Q
"RTN","XUOAAHL7",130,0)
 ;
"RTN","XUOAAHL7",131,0)
SEND ; send complete batch message
"RTN","XUOAAHL7",132,0)
 ; "XUOAA PMU"=event protocol, LB=batch array type
"RTN","XUOAAHL7",133,0)
 ; RESULT="msgid^error code^error msg" , XUMTIEN=file 772 ien from STUB
"RTN","XUOAAHL7",134,0)
 D GENERATE^HLMA("XUOAA PMU","GB",1,.RESULT,XUMTIEN)
"RTN","XUOAAHL7",135,0)
 I +$P(RESULT,U,2) D  Q
"RTN","XUOAAHL7",136,0)
 . S ERROR="1^"_$P(RESULT,U,3)
"RTN","XUOAAHL7",137,0)
 S MSGID=+RESULT
"RTN","XUOAAHL7",138,0)
 Q
"RTN","XUOAAHL7",139,0)
 ;
"RTN","XUOAAHL7",140,0)
RESTORE ; message could not be sent, restore x-ref
"RTN","XUOAAHL7",141,0)
 S INDX=0 F  S INDX=$O(XUOAA(INDX)) Q:'INDX  D
"RTN","XUOAAHL7",142,0)
 . S ^VA(200,"ATR",INDX)=$G(XUOAA(INDX))
"RTN","XUOAAHL7",143,0)
 Q
"RTN","XUOAAHL7",144,0)
 ;
"RTN","XUOAAHL7",145,0)
RECACK ; receive application acknoledgement from HL7
"RTN","XUOAAHL7",146,0)
 I $G(HL("ACKCD"))'="AA" D
"RTN","XUOAAHL7",147,0)
 . D STORENV("RECACK")
"RTN","XUOAAHL7",148,0)
 Q
"RTN","XUOAAHL7",149,0)
 ;
"RTN","XUOAAHL7",150,0)
STORENV ; store environmental variables for logging purposes
"RTN","XUOAAHL7",151,0)
 N APP,XTMP,X
"RTN","XUOAAHL7",152,0)
 S APP="Clinical Trainee Core Dataset",XTMP="XUOAA"_DT
"RTN","XUOAAHL7",153,0)
 S ^XTMP(XTMP,0)=$$FMADD^XLFDT(DT,14)_U_$$NOW^XLFDT_U_APP
"RTN","XUOAAHL7",154,0)
 S X="^XTMP("""_XTMP_""","
"RTN","XUOAAHL7",155,0)
 D DOLRO^%ZOSV
"RTN","XUOAAHL7",156,0)
 Q
"RTN","XUOAAHL7",157,0)
 ;
"RTN","XUOAAHL7",158,0)
MAIL ;Send mail message to G.XUOAA CLIN TRAINEE TRANS
"RTN","XUOAAHL7",159,0)
 N LN,MTEXT,SUBJ
"RTN","XUOAAHL7",160,0)
 S LN=1
"RTN","XUOAAHL7",161,0)
 S SUBJ="Clinical Trainee Transmission Count"
"RTN","XUOAAHL7",162,0)
 S MTEXT=""
"RTN","XUOAAHL7",163,0)
 S MTEXT(LN)=" ",LN=LN+1
"RTN","XUOAAHL7",164,0)
 S MTEXT(LN)="Number of trainees transmitted to OAA: "_TOTAL
"RTN","XUOAAHL7",165,0)
 ;Check to see if Mail Group has members
"RTN","XUOAAHL7",166,0)
 I '$$GOTLOCAL^XMXAPIG("XUOAA CLIN TRAINEE TRANS") D SENDMSG^XMXAPI(DUZ,SUBJ,"MTEXT",DUZ) Q
"RTN","XUOAAHL7",167,0)
 ; Mail Group Has Memebers so send the message
"RTN","XUOAAHL7",168,0)
 D SENDMSG^XMXAPI(DUZ,SUBJ,"MTEXT","G.XUOAA CLIN TRAINEE TRANS")
"RTN","XUOAAHL7",169,0)
 Q
"VER")
8.0^22.0
**END**
**END**
