Released PSU*4*8 SEQ #5
Extracted from mail message
**KIDS**:PSU*4.0*8^

**INSTALL NAME**
PSU*4.0*8
"BLD",6909,0)
PSU*4.0*8^PHARMACY BENEFITS MANAGEMENT^0^3060724^y
"BLD",6909,1,0)
^^10^10^3060721^
"BLD",6909,1,1,0)
Issue #1: The Provider Summary report is reporting missing data.  When a
"BLD",6909,1,2,0)
Provider has a Service/Section, the Provider will incorrectly show up on
"BLD",6909,1,3,0)
the report as missing specific data.
"BLD",6909,1,4,0)
 
"BLD",6909,1,5,0)
Issue #2:  When running Manual Pharmacy Statistics [PSU PBM MANUAL] 
"BLD",6909,1,6,0)
option, the clinic that appears in a mailman message is not
"BLD",6909,1,7,0)
the same clinic that appears in the PRESCRIPTION file (#52).
"BLD",6909,1,8,0)
 
"BLD",6909,1,9,0)
Issue #3: This patch will clean up routines no longer being used in the 
"BLD",6909,1,10,0)
Pharmacy Benefits Management package.
"BLD",6909,4,0)
^9.64PA^^
"BLD",6909,6)
2^
"BLD",6909,"ABPKG")
n
"BLD",6909,"KRN",0)
^9.67PA^8989.52^19
"BLD",6909,"KRN",.4,0)
.4
"BLD",6909,"KRN",.401,0)
.401
"BLD",6909,"KRN",.402,0)
.402
"BLD",6909,"KRN",.403,0)
.403
"BLD",6909,"KRN",.5,0)
.5
"BLD",6909,"KRN",.84,0)
.84
"BLD",6909,"KRN",3.6,0)
3.6
"BLD",6909,"KRN",3.8,0)
3.8
"BLD",6909,"KRN",9.2,0)
9.2
"BLD",6909,"KRN",9.8,0)
9.8
"BLD",6909,"KRN",9.8,"NM",0)
^9.68A^20^20
"BLD",6909,"KRN",9.8,"NM",1,0)
PSUDEM4^^0^52077577
"BLD",6909,"KRN",9.8,"NM",2,0)
PSUOP2^^0^45028652
"BLD",6909,"KRN",9.8,"NM",3,0)
PSU1^^1^
"BLD",6909,"KRN",9.8,"NM",4,0)
PSU10^^1^
"BLD",6909,"KRN",9.8,"NM",5,0)
PSU2^^1^
"BLD",6909,"KRN",9.8,"NM",6,0)
PSU3^^1^
"BLD",6909,"KRN",9.8,"NM",7,0)
PSU4^^1^
"BLD",6909,"KRN",9.8,"NM",8,0)
PSU5^^1^
"BLD",6909,"KRN",9.8,"NM",9,0)
PSU6^^1^
"BLD",6909,"KRN",9.8,"NM",10,0)
PSU7^^1^
"BLD",6909,"KRN",9.8,"NM",11,0)
PSU8^^1^
"BLD",6909,"KRN",9.8,"NM",12,0)
PSU81^^1^
"BLD",6909,"KRN",9.8,"NM",13,0)
PSU9^^1^
"BLD",6909,"KRN",9.8,"NM",14,0)
PSUIV0^^1^
"BLD",6909,"KRN",9.8,"NM",15,0)
PSUIV1^^1^
"BLD",6909,"KRN",9.8,"NM",16,0)
PSUIV2^^1^
"BLD",6909,"KRN",9.8,"NM",17,0)
PSUIV3^^1^
"BLD",6909,"KRN",9.8,"NM",18,0)
PSUIV4^^1^
"BLD",6909,"KRN",9.8,"NM",19,0)
PSUIV5^^1^
"BLD",6909,"KRN",9.8,"NM",20,0)
PSU^^1^
"BLD",6909,"KRN",9.8,"NM","B","PSU",20)

"BLD",6909,"KRN",9.8,"NM","B","PSU1",3)

"BLD",6909,"KRN",9.8,"NM","B","PSU10",4)

"BLD",6909,"KRN",9.8,"NM","B","PSU2",5)

"BLD",6909,"KRN",9.8,"NM","B","PSU3",6)

"BLD",6909,"KRN",9.8,"NM","B","PSU4",7)

"BLD",6909,"KRN",9.8,"NM","B","PSU5",8)

"BLD",6909,"KRN",9.8,"NM","B","PSU6",9)

"BLD",6909,"KRN",9.8,"NM","B","PSU7",10)

"BLD",6909,"KRN",9.8,"NM","B","PSU8",11)

"BLD",6909,"KRN",9.8,"NM","B","PSU81",12)

"BLD",6909,"KRN",9.8,"NM","B","PSU9",13)

"BLD",6909,"KRN",9.8,"NM","B","PSUDEM4",1)

"BLD",6909,"KRN",9.8,"NM","B","PSUIV0",14)

"BLD",6909,"KRN",9.8,"NM","B","PSUIV1",15)

"BLD",6909,"KRN",9.8,"NM","B","PSUIV2",16)

"BLD",6909,"KRN",9.8,"NM","B","PSUIV3",17)

"BLD",6909,"KRN",9.8,"NM","B","PSUIV4",18)

"BLD",6909,"KRN",9.8,"NM","B","PSUIV5",19)

"BLD",6909,"KRN",9.8,"NM","B","PSUOP2",2)

"BLD",6909,"KRN",19,0)
19
"BLD",6909,"KRN",19.1,0)
19.1
"BLD",6909,"KRN",101,0)
101
"BLD",6909,"KRN",409.61,0)
409.61
"BLD",6909,"KRN",771,0)
771
"BLD",6909,"KRN",870,0)
870
"BLD",6909,"KRN",8989.51,0)
8989.51
"BLD",6909,"KRN",8989.52,0)
8989.52
"BLD",6909,"KRN",8994,0)
8994
"BLD",6909,"KRN","B",.4,.4)

"BLD",6909,"KRN","B",.401,.401)

"BLD",6909,"KRN","B",.402,.402)

"BLD",6909,"KRN","B",.403,.403)

"BLD",6909,"KRN","B",.5,.5)

"BLD",6909,"KRN","B",.84,.84)

"BLD",6909,"KRN","B",3.6,3.6)

"BLD",6909,"KRN","B",3.8,3.8)

"BLD",6909,"KRN","B",9.2,9.2)

"BLD",6909,"KRN","B",9.8,9.8)

"BLD",6909,"KRN","B",19,19)

"BLD",6909,"KRN","B",19.1,19.1)

"BLD",6909,"KRN","B",101,101)

"BLD",6909,"KRN","B",409.61,409.61)

"BLD",6909,"KRN","B",771,771)

"BLD",6909,"KRN","B",870,870)

"BLD",6909,"KRN","B",8989.51,8989.51)

"BLD",6909,"KRN","B",8989.52,8989.52)

"BLD",6909,"KRN","B",8994,8994)

"BLD",6909,"QUES",0)
^9.62^^
"BLD",6909,"REQB",0)
^9.611^1^1
"BLD",6909,"REQB",1,0)
PSU*4.0*6^1
"BLD",6909,"REQB","B","PSU*4.0*6",1)

"MBREQ")
0
"ORD",0,9.8)
9.8;;1;RTNF^XPDTA;RTNE^XPDTA
"ORD",0,9.8,0)
ROUTINE
"PKG",358,-1)
1^1
"PKG",358,0)
PHARMACY BENEFITS MANAGEMENT^PSU^PHARMACY BENEFITS MANAGEMENT
"PKG",358,20,0)
^9.402P^^
"PKG",358,22,0)
^9.49I^1^1
"PKG",358,22,1,0)
4.0^3050622^3050722^33273
"PKG",358,22,1,"PAH",1,0)
8^3060724
"PKG",358,22,1,"PAH",1,1,0)
^^10^10^3060724
"PKG",358,22,1,"PAH",1,1,1,0)
Issue #1: The Provider Summary report is reporting missing data.  When a
"PKG",358,22,1,"PAH",1,1,2,0)
Provider has a Service/Section, the Provider will incorrectly show up on
"PKG",358,22,1,"PAH",1,1,3,0)
the report as missing specific data.
"PKG",358,22,1,"PAH",1,1,4,0)
 
"PKG",358,22,1,"PAH",1,1,5,0)
Issue #2:  When running Manual Pharmacy Statistics [PSU PBM MANUAL] 
"PKG",358,22,1,"PAH",1,1,6,0)
option, the clinic that appears in a mailman message is not
"PKG",358,22,1,"PAH",1,1,7,0)
the same clinic that appears in the PRESCRIPTION file (#52).
"PKG",358,22,1,"PAH",1,1,8,0)
 
"PKG",358,22,1,"PAH",1,1,9,0)
Issue #3: This patch will clean up routines no longer being used in the 
"PKG",358,22,1,"PAH",1,1,10,0)
Pharmacy Benefits Management package.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
20
"RTN","PSU")
1^20^^B26826545
"RTN","PSU1")
1^3^^B14674705
"RTN","PSU10")
1^4^^B8990229
"RTN","PSU2")
1^5^^B7475694
"RTN","PSU3")
1^6^^B13174044
"RTN","PSU4")
1^7^^B22471313
"RTN","PSU5")
1^8^^B22132324
"RTN","PSU6")
1^9^^B8377029
"RTN","PSU7")
1^10^^B10359366
"RTN","PSU8")
1^11^^B19193214
"RTN","PSU81")
1^12^^B8895635
"RTN","PSU9")
1^13^^B21954355
"RTN","PSUDEM4")
0^1^B52077577^B51977123
"RTN","PSUDEM4",1,0)
PSUDEM4 ;BIR/DAM - Provider Extract ; 7/21/06 2:27pm
"RTN","PSUDEM4",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;**8**;MARCH, 2005
"RTN","PSUDEM4",3,0)
 ;
"RTN","PSUDEM4",4,0)
 ;DBIA'S
"RTN","PSUDEM4",5,0)
 ; Reference to file 200    supported by DBIA 10060
"RTN","PSUDEM4",6,0)
 ; Reference to file 7      supported by DBIA 2495
"RTN","PSUDEM4",7,0)
 ; Reference to file 49     supported by DBIA 432
"RTN","PSUDEM4",8,0)
 ; Reference to file 8932.1 supported by DBIA 2091
"RTN","PSUDEM4",9,0)
 ; Reference to file 4.2    supported by DBIA 2496
"RTN","PSUDEM4",10,0)
 ;
"RTN","PSUDEM4",11,0)
EN ;Entry point for gathering all provider information from IV, UD, Rx,
"RTN","PSUDEM4",12,0)
 ;and PD modules.
"RTN","PSUDEM4",13,0)
 ;
"RTN","PSUDEM4",14,0)
 N PSUREC
"RTN","PSUDEM4",15,0)
 S ^XTMP("PSU_"_PSUJOB,"PSUFLAG")=""
"RTN","PSUDEM4",16,0)
 ;
"RTN","PSUDEM4",17,0)
 D PULL^PSUCP
"RTN","PSUDEM4",18,0)
 F I=1:1:$L(PSUOPTS,",") S PSUMOD($P(PSUOPTS,",",I))=""
"RTN","PSUDEM4",19,0)
 ;
"RTN","PSUDEM4",20,0)
 I '$D(PSUMOD(7)) D EN^PSUDEM1
"RTN","PSUDEM4",21,0)
 I '$D(PSUMOD(1)) D EN^PSUV0
"RTN","PSUDEM4",22,0)
 I '$D(PSUMOD(2)) D EN^PSUUD0
"RTN","PSUDEM4",23,0)
 I '$D(PSUMOD(4)) D
"RTN","PSUDEM4",24,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUOPFLG")=""   ;Set flag
"RTN","PSUDEM4",25,0)
 .D EN^PSUOP0
"RTN","PSUDEM4",26,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUPROM")=^XTMP("PSU_"_PSUJOB,"PSUPROV")
"RTN","PSUDEM4",27,0)
 ;
"RTN","PSUDEM4",28,0)
 D XMD
"RTN","PSUDEM4",29,0)
 D EN^PSUSUM1      ;compose provider summary report and mail it.
"RTN","PSUDEM4",30,0)
 K ^XTMP("PSU_"_PSUJOB,"PSUFLAG")
"RTN","PSUDEM4",31,0)
 Q
"RTN","PSUDEM4",32,0)
 ;
"RTN","PSUDEM4",33,0)
PDSSN ;EN  Called from PSUDEM1
"RTN","PSUDEM4",34,0)
 ;Find provider SSN and IEN present in the patient demographics
"RTN","PSUDEM4",35,0)
 ;extract.  Note that this is the primary care provider.
"RTN","PSUDEM4",36,0)
 ;
"RTN","PSUDEM4",37,0)
 S PSUT=0
"RTN","PSUDEM4",38,0)
 F  S PSUT=$O(^XTMP("PSU_"_PSUJOB,"PSUDM",PSUT)) Q:'PSUT  D
"RTN","PSUDEM4",39,0)
 .N PSUIEN,PSUSSN1
"RTN","PSUDEM4",40,0)
 .S PSUIEN=$P($G(^XTMP("PSU_"_PSUJOB,"PSUDM",PSUT)),U,15) I 'PSUIEN S PSUIEN="UNK"
"RTN","PSUDEM4",41,0)
 .D FAC
"RTN","PSUDEM4",42,0)
 .D PNAM
"RTN","PSUDEM4",43,0)
 .S PSUSSN1=$P($G(^XTMP("PSU_"_PSUJOB,"PSUDM",PSUT)),U,14) I 'PSUSSN1 S PSUSSN1=""
"RTN","PSUDEM4",44,0)
 .S PSUREC=PSUSSN1 D REC^PSUDEM2
"RTN","PSUDEM4",45,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,3)=PSUREC              ;Dem Prov SSN
"RTN","PSUDEM4",46,0)
 .S PSUREC=PSUIEN D REC^PSUDEM2
"RTN","PSUDEM4",47,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,4)=PSUREC D              ;Dem Prov ICN
"RTN","PSUDEM4",48,0)
 ..I PSUREC="UNK" K ^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN)
"RTN","PSUDEM4",49,0)
 Q
"RTN","PSUDEM4",50,0)
 ;
"RTN","PSUDEM4",51,0)
UDSSN ;EN  Called from PROV^PSUUD1. Find provider SSN and IEN in the unit 
"RTN","PSUDEM4",52,0)
 ;dose extract
"RTN","PSUDEM4",53,0)
 ;
"RTN","PSUDEM4",54,0)
 S PSUIEN=0,PSUVSSN1=0
"RTN","PSUDEM4",55,0)
 F  S PSUVSSN1=$O(^XTMP("PSU_"_PSUJOB,"PSUPDR",PSUVSSN1)) Q:PSUVSSN1=""  D
"RTN","PSUDEM4",56,0)
 .F  S PSUIEN=$O(^XTMP("PSU_"_PSUJOB,"PSUPDR",PSUVSSN1,PSUIEN)) Q:PSUIEN=""  D
"RTN","PSUDEM4",57,0)
 ..D FAC
"RTN","PSUDEM4",58,0)
 ..S PSUREC=PSUVSSN1 D REC^PSUDEM1 D
"RTN","PSUDEM4",59,0)
 ...I PSUREC=999999999 S PSUREC=""
"RTN","PSUDEM4",60,0)
 ...S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,3)=PSUREC   ;UD Prov SSN
"RTN","PSUDEM4",61,0)
 ..S PSUREC=PSUIEN D REC^PSUDEM2
"RTN","PSUDEM4",62,0)
 ..S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,4)=PSUREC    ;UD Prov IEN
"RTN","PSUDEM4",63,0)
 ..D PNAM
"RTN","PSUDEM4",64,0)
 Q
"RTN","PSUDEM4",65,0)
 ;
"RTN","PSUDEM4",66,0)
IVSSN ;EN Called from PSUIV1. Gives Provider within date range of extract
"RTN","PSUDEM4",67,0)
 ;
"RTN","PSUDEM4",68,0)
 D UDSSN
"RTN","PSUDEM4",69,0)
 Q
"RTN","PSUDEM4",70,0)
 ;
"RTN","PSUDEM4",71,0)
OPSSN ;EN Called from PSUOP0.  Gives prescription Provider
"RTN","PSUDEM4",72,0)
 ;
"RTN","PSUDEM4",73,0)
 D UDSSN
"RTN","PSUDEM4",74,0)
 Q 
"RTN","PSUDEM4",75,0)
FAC ;Find provider station number.  Places that info in each record.
"RTN","PSUDEM4",76,0)
 ;
"RTN","PSUDEM4",77,0)
 ;D INST^PSUDEM1
"RTN","PSUDEM4",78,0)
 S $P(^TMP("PSUPROV",$J),U,2)=PSUSNDR
"RTN","PSUDEM4",79,0)
 M ^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN)=^TMP("PSUPROV",$J)
"RTN","PSUDEM4",80,0)
 Q
"RTN","PSUDEM4",81,0)
 ;
"RTN","PSUDEM4",82,0)
PNAM ;Find the provider's name.
"RTN","PSUDEM4",83,0)
 ;
"RTN","PSUDEM4",84,0)
 N PSUCLP,PSUSS,PSUSP
"RTN","PSUDEM4",85,0)
 ;
"RTN","PSUDEM4",86,0)
 ;Find provider name
"RTN","PSUDEM4",87,0)
 S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,9)=$$GET1^DIQ(200,PSUIEN,.01,"I")
"RTN","PSUDEM4",88,0)
 ;
"RTN","PSUDEM4",89,0)
 S PSUCLP=$$GET1^DIQ(200,PSUIEN,53.5,"I") D CLASS  ;Provider pointer
"RTN","PSUDEM4",90,0)
 S PSUSS=$$GET1^DIQ(200,PSUIEN,29,"I") D SS        ;Service Sctn ptr
"RTN","PSUDEM4",91,0)
 ;
"RTN","PSUDEM4",92,0)
 S PSUD1=999
"RTN","PSUDEM4",93,0)
 S PSUD1=$O(^VA(200,PSUIEN,"USC1",PSUD1),-1)  ;Find last subscript
"RTN","PSUDEM4",94,0)
 I PSUD1'="" D
"RTN","PSUDEM4",95,0)
 .S PSUSP=$$GET1^DIQ(200.05,PSUD1_","_PSUIEN_",",.01,"I")  ;Specialty
"RTN","PSUDEM4",96,0)
 .D SPEC
"RTN","PSUDEM4",97,0)
 I PSUD1="" D
"RTN","PSUDEM4",98,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,7)=""
"RTN","PSUDEM4",99,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,8)=""
"RTN","PSUDEM4",100,0)
 Q
"RTN","PSUDEM4",101,0)
 ;
"RTN","PSUDEM4",102,0)
CLASS ;Find provider class
"RTN","PSUDEM4",103,0)
 ;
"RTN","PSUDEM4",104,0)
 I '$D(PSUCLP) S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,5)=""
"RTN","PSUDEM4",105,0)
 I PSUCLP="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,5)=""
"RTN","PSUDEM4",106,0)
 I PSUCLP'="" D
"RTN","PSUDEM4",107,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,5)=$P($G(^DIC(7,PSUCLP,0)),U,2)  ;Prov class
"RTN","PSUDEM4",108,0)
 Q
"RTN","PSUDEM4",109,0)
 ;
"RTN","PSUDEM4",110,0)
SS ;Find Provider Service/Section
"RTN","PSUDEM4",111,0)
 ;
"RTN","PSUDEM4",112,0)
 N PSUTMP
"RTN","PSUDEM4",113,0)
 ;
"RTN","PSUDEM4",114,0)
 I PSUSS="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,6)=""
"RTN","PSUDEM4",115,0)
 I PSUSS'="" S PSUTMP=1 D
"RTN","PSUDEM4",116,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["AMBU" PSUTMP="AMB"
"RTN","PSUDEM4",117,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["ANESTH" PSUTMP="ANES"
"RTN","PSUDEM4",118,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["CARDIO" PSUTMP="CV"
"RTN","PSUDEM4",119,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["PHARM" PSUTMP="CPHAR"
"RTN","PSUDEM4",120,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["DENT" PSUTMP="DDS"
"RTN","PSUDEM4",121,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["MEDIC" PSUTMP="MED"
"RTN","PSUDEM4",122,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["INTERMED" PSUTMP="IM"
"RTN","PSUDEM4",123,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["NUCLEAR" PSUTMP="NUM"
"RTN","PSUDEM4",124,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["NURSING" PSUTMP="RN"
"RTN","PSUDEM4",125,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["ORTHOPED" PSUTMP="ORTHO"
"RTN","PSUDEM4",126,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["PSYCHIA" PSUTMP="PSY"
"RTN","PSUDEM4",127,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["MENTAL" PSUTMP="PSY"
"RTN","PSUDEM4",128,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["PRIMARY" PSUTMP="AMB"
"RTN","PSUDEM4",129,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["CBOC" PSUTMP="AMB"
"RTN","PSUDEM4",130,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["OPHTH" PSUTMP="OPH"
"RTN","PSUDEM4",131,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["PULM" PSUTMP="PUL"
"RTN","PSUDEM4",132,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["RADIOL" PSUTMP="RAD"
"RTN","PSUDEM4",133,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["SURG" PSUTMP="SUR"
"RTN","PSUDEM4",134,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["UROLOG" PSUTMP="U"
"RTN","PSUDEM4",135,0)
 .S:$P($G(^DIC(49,PSUSS,0)),U)["NEUROL" PSUTMP="NEUR"
"RTN","PSUDEM4",136,0)
 .S PSUREC=$G(PSUTMP) D REC^PSUDEM2
"RTN","PSUDEM4",137,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,6)=$G(PSUREC)       ;Prov Serv/Sec
"RTN","PSUDEM4",138,0)
 Q
"RTN","PSUDEM4",139,0)
 ;
"RTN","PSUDEM4",140,0)
SPEC ;Find provider specialty and sub-specialty
"RTN","PSUDEM4",141,0)
 ;
"RTN","PSUDEM4",142,0)
 I PSUSP="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,7)=""
"RTN","PSUDEM4",143,0)
 I PSUSP="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,8)=""
"RTN","PSUDEM4",144,0)
 I PSUSP'="" D
"RTN","PSUDEM4",145,0)
 .S PSUREC=$P($G(^USC(8932.1,PSUSP,0)),U,2) D REC^PSUDEM2
"RTN","PSUDEM4",146,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,7)=PSUREC D     ;Speclty
"RTN","PSUDEM4",147,0)
 ..I $P(^USC(8932.1,PSUSP,0),U,2)="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,7)=""
"RTN","PSUDEM4",148,0)
 .S PSUREC=$P($G(^USC(8932.1,PSUSP,0)),U,3) D REC^PSUDEM2
"RTN","PSUDEM4",149,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,8)=PSUREC D      ;Subspecl
"RTN","PSUDEM4",150,0)
 ..I $P(^USC(8932.1,PSUSP,0),U,3)="" S $P(^XTMP("PSU_"_PSUJOB,"PSUPROV",PSUIEN),U,8)=""
"RTN","PSUDEM4",151,0)
 ;
"RTN","PSUDEM4",152,0)
 Q
"RTN","PSUDEM4",153,0)
 ;
"RTN","PSUDEM4",154,0)
XMD ;Format mailman message and send.
"RTN","PSUDEM4",155,0)
 ;
"RTN","PSUDEM4",156,0)
 S PSUAA=0
"RTN","PSUDEM4",157,0)
 F  S PSUAA=$O(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAA)) Q:PSUAA=""  D
"RTN","PSUDEM4",158,0)
 .S $P(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAA),U,9)=""      ;Remove provider name
"RTN","PSUDEM4",159,0)
 ;
"RTN","PSUDEM4",160,0)
 ;Remove space in piece 8
"RTN","PSUDEM4",161,0)
 S PSUAB=0
"RTN","PSUDEM4",162,0)
 F  S PSUAB=$O(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAB)) Q:PSUAB=""  D
"RTN","PSUDEM4",163,0)
 .I $P(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAB),U,8)=" " D
"RTN","PSUDEM4",164,0)
 ..S $P(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAB),U,8)=""
"RTN","PSUDEM4",165,0)
 ;
"RTN","PSUDEM4",166,0)
 S PSUAC=0,PSUPL=1
"RTN","PSUDEM4",167,0)
 F  S PSUAC=$O(^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAC)) Q:PSUAC=""  D
"RTN","PSUDEM4",168,0)
 .M ^TMP("PSUPROM",$J,PSUPL)=^XTMP("PSU_"_PSUJOB,"PSUPROM",PSUAC)  ;numerical order
"RTN","PSUDEM4",169,0)
 .S PSUPL=PSUPL+1
"RTN","PSUDEM4",170,0)
 ;
"RTN","PSUDEM4",171,0)
 NEW PSUMAX,PSULC,PSUTMC,PSUTLC,PSUMC
"RTN","PSUDEM4",172,0)
 S PSUMAX=$$VAL^PSUTL(4.3,1,8.3)
"RTN","PSUDEM4",173,0)
 S PSUMAX=$S(PSUMAX="":10000,PSUMAX>10000:10000,1:PSUMAX)
"RTN","PSUDEM4",174,0)
 S PSUMC=1,PSUMLC=0
"RTN","PSUDEM4",175,0)
 F PSULC=1:1 S X=$G(^TMP("PSUPROM",$J,PSULC)) Q:X=""  D
"RTN","PSUDEM4",176,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM4",177,0)
 .I PSUMLC>PSUMAX S PSUMC=PSUMC+1,PSUMLC=0,PSULC=PSULC-1 Q  ; +  message
"RTN","PSUDEM4",178,0)
 .I $L(X)<235 S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=X Q
"RTN","PSUDEM4",179,0)
 .F I=235:-1:1 S Z=$E(X,I) Q:Z="^"
"RTN","PSUDEM4",180,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)=$E(X,1,I)
"RTN","PSUDEM4",181,0)
 .S PSUMLC=PSUMLC+1
"RTN","PSUDEM4",182,0)
 .S ^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUMC,PSUMLC)="*"_$E(X,I+1,999)
"RTN","PSUDEM4",183,0)
 ;
"RTN","PSUDEM4",184,0)
 F PSUM=1:1:PSUMC D PROV^PSUDEM5
"RTN","PSUDEM4",185,0)
 D CONF
"RTN","PSUDEM4",186,0)
 Q
"RTN","PSUDEM4",187,0)
CONF ;Construct globals for confirmation message
"RTN","PSUDEM4",188,0)
 ;
"RTN","PSUDEM4",189,0)
 ;   Count Lines sent
"RTN","PSUDEM4",190,0)
 S PSUTLC=0
"RTN","PSUDEM4",191,0)
 F PSUM=1:1:PSUMC S X=$O(^XTMP("PSU_"_PSUJOB,"PSUXMD",PSUM,""),-1),PSUTLC=PSUTLC+X
"RTN","PSUDEM4",192,0)
 ;
"RTN","PSUDEM4",193,0)
 D INST^PSUDEM1
"RTN","PSUDEM4",194,0)
 N PSUDIVIS
"RTN","PSUDEM4",195,0)
 S PSUDIVIS=$P(^XTMP("PSU_"_PSUJOB,"PSUSITE"),U,1)
"RTN","PSUDEM4",196,0)
 S PSUSUB="PSU_"_PSUJOB
"RTN","PSUDEM4",197,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,10,"M")=PSUMC
"RTN","PSUDEM4",198,0)
 S ^XTMP(PSUSUB,"CONFIRM",PSUDIVIS,10,"L")=PSUTLC
"RTN","PSUDEM4",199,0)
 Q
"RTN","PSUIV0")
1^14^^B3510230
"RTN","PSUIV1")
1^15^^B73473589
"RTN","PSUIV2")
1^16^^B35293917
"RTN","PSUIV3")
1^17^^B8277556
"RTN","PSUIV4")
1^18^^B16302860
"RTN","PSUIV5")
1^19^^B8577319
"RTN","PSUOP2")
0^2^B45028652^B42752697
"RTN","PSUOP2",1,0)
PSUOP2 ;BIR/CFL - PSU PBM Outpatient Pharmacy Data Collection for Version 7.0 ; 7/11/06 4:21pm
"RTN","PSUOP2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;**6,8**;MARCH, 2005
"RTN","PSUOP2",3,0)
 ;
"RTN","PSUOP2",4,0)
 ;DBIAs
"RTN","PSUOP2",5,0)
 ; Reference to ^PSRX( file # 52 supported by DBIAs 465, 2512
"RTN","PSUOP2",6,0)
 ; Reference to EN^PSOORDER      supported by DBIA 1878
"RTN","PSUOP2",7,0)
 ; 
"RTN","PSUOP2",8,0)
 ;
"RTN","PSUOP2",9,0)
EN ;Entry to data collection
"RTN","PSUOP2",10,0)
 D ALLOOP,AMLOOP
"RTN","PSUOP2",11,0)
 K ^TMP("PSOR",$J)
"RTN","PSUOP2",12,0)
 Q
"RTN","PSUOP2",13,0)
ALLOOP ;Loop through the AL cross refererence
"RTN","PSUOP2",14,0)
 N PSUDOC1,PSUCAN,PSUCL,PSUCMP,PSUFP,PSUORDT,PSUCO
"RTN","PSUOP2",15,0)
 S PSUFDT=PSUSDT,PSUEDTM=PSUEDT_".24"
"RTN","PSUOP2",16,0)
 F  S PSUFDT=$O(^PSRX("AL",PSUFDT)) Q:PSUFDT=""!(PSUFDT>PSUEDTM)  D
"RTN","PSUOP2",17,0)
 .S PSURXIEN=""
"RTN","PSUOP2",18,0)
 .F  S PSURXIEN=$O(^PSRX("AL",PSUFDT,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP2",19,0)
 ..Q:$D(^XTMP(PSUOPSUB,"RXIEN",PSURXIEN))  ; already been processed
"RTN","PSUOP2",20,0)
 ..Q:'$D(^PSRX(PSURXIEN,0))  ; watch out for dangling pointers
"RTN","PSUOP2",21,0)
 ..S PSUCAN=$$GET1^DIQ(52,PSURXIEN,26.1,"I")   ;Cancel date
"RTN","PSUOP2",22,0)
 ..D GETS^PSUTL(52,PSURXIEN,"2;21;27","PSUOP","I")
"RTN","PSUOP2",23,0)
 ..D MOVEI^PSUTL("PSUOP")
"RTN","PSUOP2",24,0)
 ..S DFN=PSUOP(2)
"RTN","PSUOP2",25,0)
 ..;
"RTN","PSUOP2",26,0)
 ..Q:$$TESTPAT^PSUTL1(DFN)
"RTN","PSUOP2",27,0)
 ..D PID^VADPT
"RTN","PSUOP2",28,0)
 ..S PSUSSN=$TR(VA("PID"),"^-","")
"RTN","PSUOP2",29,0)
 ..N PSUPSO S PSUPSO=1   ;flag to avoid a PSO error when SIG is too long
"RTN","PSUOP2",30,0)
 ..D EN^PSOORDER(DFN,PSURXIEN)
"RTN","PSUOP2",31,0)
 ..Q:'$D(^TMP("PSOR",$J))
"RTN","PSUOP2",32,0)
 ..D EN^PSUOPAM      ;Gather AMIS data
"RTN","PSUOP2",33,0)
 ..D CMOPA ; set array of CMOP recs
"RTN","PSUOP2",34,0)
 ..D NEW ; check ^TMP to see if New Rx is in time frame, if so create record.
"RTN","PSUOP2",35,0)
 ..D REF ; check ^TMP to see if refills are in time frame, if so create records
"RTN","PSUOP2",36,0)
 ..D PAR ; check ^TMP to see if partials are in time frame, if so create records
"RTN","PSUOP2",37,0)
 Q
"RTN","PSUOP2",38,0)
 ;
"RTN","PSUOP2",39,0)
AMLOOP ; loop through "AM", partials, cross reference to see if any were missed
"RTN","PSUOP2",40,0)
 S X1=PSUSDT,X2=-1
"RTN","PSUOP2",41,0)
 D C^%DTC K %,%H,%T
"RTN","PSUOP2",42,0)
 S PSUFDT=PSUSDT,PSUEDTM=PSUEDT_".24"
"RTN","PSUOP2",43,0)
 F  S PSUFDT=$O(^PSRX("AM",PSUFDT)) Q:PSUFDT=""!(PSUFDT>PSUEDTM)  D
"RTN","PSUOP2",44,0)
 .S PSURXIEN=""
"RTN","PSUOP2",45,0)
 .F  S PSURXIEN=$O(^PSRX("AM",PSUFDT,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP2",46,0)
 ..Q:$D(^XTMP(PSUOPSUB,"RXIEN",PSURXIEN))  ; already been processed
"RTN","PSUOP2",47,0)
 ..Q:'$D(^PSRX(PSURXIEN,0))  ; watch out for dangling pointers
"RTN","PSUOP2",48,0)
 ..D GETS^PSUTL(52,PSURXIEN,"2;27","PSUOP","I")
"RTN","PSUOP2",49,0)
 ..D MOVEI^PSUTL("PSUOP")
"RTN","PSUOP2",50,0)
 ..S DFN=PSUOP(2)
"RTN","PSUOP2",51,0)
 ..; SCREEN OUT TEST PATIENTS
"RTN","PSUOP2",52,0)
 ..Q:$$TESTPAT^PSUTL1(DFN)
"RTN","PSUOP2",53,0)
 ..D PID^VADPT
"RTN","PSUOP2",54,0)
 ..S PSUSSN=$TR(VA("PID"),"^-","")
"RTN","PSUOP2",55,0)
 ..D EN^PSOORDER(DFN,PSURXIEN)
"RTN","PSUOP2",56,0)
 ..D EN^PSUOPAM      ;Gather AMIS data   PSU*4*5 fix
"RTN","PSUOP2",57,0)
 ..D PAR ; check ^TMP to see if partials are in time frame, if so create records
"RTN","PSUOP2",58,0)
 Q
"RTN","PSUOP2",59,0)
 ;
"RTN","PSUOP2",60,0)
NEW ; New Rx
"RTN","PSUOP2",61,0)
 S PSUFD=$P(^TMP("PSOR",$J,PSURXIEN,0),U,2)
"RTN","PSUOP2",62,0)
 D COMVAR
"RTN","PSUOP2",63,0)
 S PSUTYP="N"
"RTN","PSUOP2",64,0)
 S PSUCMOP=$S($D(PSUCMA(0)):"Y",1:"N")
"RTN","PSUOP2",65,0)
 S PSUR0=^TMP("PSOR",$J,PSURXIEN,0)
"RTN","PSUOP2",66,0)
 S PSUORDT=$P(PSUR0,U,17)     ;AMIS Original Login Date
"RTN","PSUOP2",67,0)
 S PSUQTY=+$P(PSUR0,U,6)
"RTN","PSUOP2",68,0)
 ;
"RTN","PSUOP2",69,0)
 ;
"RTN","PSUOP2",70,0)
 S PSUDS=$P(PSUR0,U,7)
"RTN","PSUOP2",71,0)
 S PSUDRCT=$P(PSUR0,U,10)
"RTN","PSUOP2",72,0)
 S PSURELDT=$P($P(PSUR0,U,13),".",1)
"RTN","PSUOP2",73,0)
 Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",74,0)
 S PSUWPC=$E($P(PSUR0,U,15))
"RTN","PSUOP2",75,0)
NEWX1 ;I PSUCMOP="Y" Q:((PSURELDT="")!(PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",76,0)
NEWX2 ;I PSUCMOP="N",((PSUFD<PSUSDT)!(PSUFD\1>PSUEDT)) Q
"RTN","PSUOP2",77,0)
 S PSUR1=^TMP("PSOR",$J,PSURXIEN,1)
"RTN","PSUOP2",78,0)
 S PSUCLN=$P($P(PSUR1,U,4),";",2)          ;AMIS data clinic
"RTN","PSUOP2",79,0)
 S PSUFP=$P($P(PSUR1,U,9),";",1)           ;AMIS finishing person
"RTN","PSUOP2",80,0)
 S PSUPRID=$P($P(PSUR1,U,1),";",1)
"RTN","PSUOP2",81,0)
 S PSURXP=$P($P(PSUR1,U,5),";",1)
"RTN","PSUOP2",82,0)
 S PSUMW=$P($P(PSUR1,U,6),";",1)
"RTN","PSUOP2",83,0)
 S PSUDIVP=$P(PSUR1,U,7)
"RTN","PSUOP2",84,0)
 ;
"RTN","PSUOP2",85,0)
 S PSUNDC=""
"RTN","PSUOP2",86,0)
 I PSUCMOP="Y" S PSUNDC=PSUCMA(0)
"RTN","PSUOP2",87,0)
 I PSUNDC="" S PSUNDC=$S($L(PSUOP(27)):PSUOP(27),$L(PSUDRUG(31)):PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",88,0)
 D PROVDR^PSUOP3
"RTN","PSUOP2",89,0)
 D SETREC^PSUOP3
"RTN","PSUOP2",90,0)
NEWQ Q
"RTN","PSUOP2",91,0)
 ;
"RTN","PSUOP2",92,0)
REF ; Refills
"RTN","PSUOP2",93,0)
 Q:'$D(^TMP("PSOR",$J,PSURXIEN,"REF"))
"RTN","PSUOP2",94,0)
 D COMVAR
"RTN","PSUOP2",95,0)
 S PSUFLN=""
"RTN","PSUOP2",96,0)
 F  S PSUFLN=$O(^TMP("PSOR",$J,PSURXIEN,"REF",PSUFLN)) Q:PSUFLN=""  D
"RTN","PSUOP2",97,0)
 .S PSUTYP="R"
"RTN","PSUOP2",98,0)
 .S PSUCMOP=$S($D(PSUCMA(PSUFLN)):"Y",1:"N")
"RTN","PSUOP2",99,0)
 .S PSUR0=^TMP("PSOR",$J,PSURXIEN,"REF",PSUFLN,0)
"RTN","PSUOP2",100,0)
 .N PSUCLN,PSUR1
"RTN","PSUOP2",101,0)
 .S PSUR1=^TMP("PSOR",$J,PSURXIEN,1)
"RTN","PSUOP2",102,0)
 .S PSUCLN=$P($P(PSUR1,U,4),";",2)
"RTN","PSUOP2",103,0)
 .S PSUWPC="N"
"RTN","PSUOP2",104,0)
 .S PSUFD=$P(PSUR0,U,1)
"RTN","PSUOP2",105,0)
 .S PSUPRID=$P($P(PSUR0,U,2),";",1)
"RTN","PSUOP2",106,0)
 .S PSUQTY=+$P(PSUR0,U,4)
"RTN","PSUOP2",107,0)
 .S PSUDS=$P(PSUR0,U,5)
"RTN","PSUOP2",108,0)
 .S PSUDRCT=$P(PSUR0,U,6)
"RTN","PSUOP2",109,0)
 .S PSURELDT=$P(PSUR0,U,8)
"RTN","PSUOP2",110,0)
 .Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",111,0)
 .S PSUMW=$P($P(PSUR0,U,10),";",1)
"RTN","PSUOP2",112,0)
 .S PSUDIVP=$P(PSUR0,U,11)
"RTN","PSUOP2",113,0)
 .S PSUREDT=$P(PSUR0,U,12)     ;AMIS Refill Login Date
"RTN","PSUOP2",114,0)
 .I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP2",115,0)
 .;I PSUCMOP="Y" Q:((PSURELDT="")!(PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",116,0)
 .;I PSUCMOP="N",((PSUFD<PSUSDT)!(PSUFD\1>PSUEDT)) Q
"RTN","PSUOP2",117,0)
 .S PSUNDC=""
"RTN","PSUOP2",118,0)
 .I PSUCMOP="Y" S PSUNDC=PSUCMA(PSUFLN)
"RTN","PSUOP2",119,0)
 .I PSUNDC="" S PSUNDC=$$VALI^PSUTL(52.1,PSURXIEN,11)
"RTN","PSUOP2",120,0)
 .I PSUNDC="" S PSUNDC=$S(PSUDRUG(31)'="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",121,0)
 .;
"RTN","PSUOP2",122,0)
 .D PROVDR^PSUOP3
"RTN","PSUOP2",123,0)
 .D SETREC^PSUOP3
"RTN","PSUOP2",124,0)
REFQ Q
"RTN","PSUOP2",125,0)
 ;
"RTN","PSUOP2",126,0)
PAR ; Partials
"RTN","PSUOP2",127,0)
 Q:'$D(^TMP("PSOR",$J,PSURXIEN,"RPAR"))
"RTN","PSUOP2",128,0)
 D COMVAR
"RTN","PSUOP2",129,0)
 S PSUFLN=""
"RTN","PSUOP2",130,0)
 F  S PSUFLN=$O(^TMP("PSOR",$J,PSURXIEN,"RPAR",PSUFLN)) Q:PSUFLN=""  D
"RTN","PSUOP2",131,0)
 .S PSUR0=^TMP("PSOR",$J,PSURXIEN,"RPAR",PSUFLN,0)
"RTN","PSUOP2",132,0)
 .N PSUCLN,PSUR1
"RTN","PSUOP2",133,0)
 .S PSUR1=^TMP("PSOR",$J,PSURXIEN,1)
"RTN","PSUOP2",134,0)
 .S PSUCLN=$P($P(PSUR1,U,4),";",2)
"RTN","PSUOP2",135,0)
 .S PSUTYP="P"
"RTN","PSUOP2",136,0)
 .S PSUCMOP="N"
"RTN","PSUOP2",137,0)
 .S PSUWPC="N"
"RTN","PSUOP2",138,0)
 .S PSUFD=$P(PSUR0,U,1)
"RTN","PSUOP2",139,0)
 .;I (PSUFD<PSUSDT)!(PSUFD\1>PSUEDT) Q
"RTN","PSUOP2",140,0)
 .S PSUPRID=$P($P(PSUR0,U,2),";",1)
"RTN","PSUOP2",141,0)
 .S PSUQTY=+$P(PSUR0,U,4)
"RTN","PSUOP2",142,0)
 .S PSUDS=$P(PSUR0,U,5)
"RTN","PSUOP2",143,0)
 .S PSUDRCT=$P(PSUR0,U,6)
"RTN","PSUOP2",144,0)
 .S PSURELDT=$P(PSUR0,U,8)
"RTN","PSUOP2",145,0)
 .S PSUMW=$P($P(PSUR0,U,10),";",1)
"RTN","PSUOP2",146,0)
 .S PSUDIVP=$P(PSUR0,U,11)
"RTN","PSUOP2",147,0)
 .S PSUPDT=$P(PSUR0,U,12)       ;AMIS Partial Login Date
"RTN","PSUOP2",148,0)
 .I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP2",149,0)
 .Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",150,0)
 .S PSUNDC=$$VALI^PSUTL(52.2,PSURXIEN,1)
"RTN","PSUOP2",151,0)
 .I PSUNDC="" S PSUNDC=$S(PSUDRUG(31)'="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",152,0)
 .;
"RTN","PSUOP2",153,0)
 .D PROVDR^PSUOP3
"RTN","PSUOP2",154,0)
 .D SETREC^PSUOP3
"RTN","PSUOP2",155,0)
PARQ Q
"RTN","PSUOP2",156,0)
 ;
"RTN","PSUOP2",157,0)
COMVAR ; set variables that are common between all record types
"RTN","PSUOP2",158,0)
 S PSUDR=$P($P(^TMP("PSOR",$J,PSURXIEN,"DRUG",0),U,1),";",1)
"RTN","PSUOP2",159,0)
 ;S CMOPID=$P($G(^PSDRUG(PSUDR,"ND")),U,10)     ;AMIS CMOP ID
"RTN","PSUOP2",160,0)
 S PSUSIG=$P($G(^TMP("PSOR",$J,PSURXIEN,"SIG",1,0)),U,1)
"RTN","PSUOP2",161,0)
 S PSURXP=$P($P(^TMP("PSOR",$J,PSURXIEN,1),U,5),";",1)
"RTN","PSUOP2",162,0)
 S PSURXN=$P(^TMP("PSOR",$J,PSURXIEN,0),U,5)
"RTN","PSUOP2",163,0)
 D GETDRUG^PSUOP3 ; loads data from file #50 using PSUDR as ien
"RTN","PSUOP2",164,0)
COMVARQ Q
"RTN","PSUOP2",165,0)
 ;
"RTN","PSUOP2",166,0)
CMOPA ; set array of CMOP recs
"RTN","PSUOP2",167,0)
 K PSUCMA
"RTN","PSUOP2",168,0)
 N PSUR1,PSUX,PSUST,PSUFIL,PSUNDC
"RTN","PSUOP2",169,0)
 S PSUX=""
"RTN","PSUOP2",170,0)
 F  S PSUX=$O(^TMP("PSOR",$J,PSURXIEN,"CMOP",PSUX)) Q:PSUX=""  D
"RTN","PSUOP2",171,0)
 .S PSUR1=^TMP("PSOR",$J,PSURXIEN,"CMOP",PSUX,0)
"RTN","PSUOP2",172,0)
 .F X="PSUFIL^3","PSUST^4","PSUNDC^6" D PIECE(X,PSUR1,U)
"RTN","PSUOP2",173,0)
 .S:+PSUST=1 PSUCMA(PSUFIL)=PSUNDC
"RTN","PSUOP2",174,0)
 .K:+PSUST=3 PSUCMA(PSUFIL)
"RTN","PSUOP2",175,0)
 .D:$D(PSUCMA(PSUFIL)) RTSTOCK
"RTN","PSUOP2",176,0)
CMOPAQ Q
"RTN","PSUOP2",177,0)
 ;
"RTN","PSUOP2",178,0)
RTSTOCK ; test for "AR" if none then unmark CMOP
"RTN","PSUOP2",179,0)
 ; needs PSURXIEN, PSUFIL, from CMOPA
"RTN","PSUOP2",180,0)
 N PSURELDT,PSUR0,PSURTSDT
"RTN","PSUOP2",181,0)
 I PSUFIL D  Q
"RTN","PSUOP2",182,0)
 . S PSUR0=$G(^TMP("PSOR",$J,PSURXIEN,"REF",PSUFIL,0))
"RTN","PSUOP2",183,0)
 . F X="PSURELDT^8","PSURTSDT^9" D PIECE(X,PSUR0,U)
"RTN","PSUOP2",184,0)
 . I PSURELDT,$D(^PSRX("AR",PSURELDT,PSURXIEN,PSUFIL)) Q
"RTN","PSUOP2",185,0)
 . K PSUCMA(PSUFIL)
"RTN","PSUOP2",186,0)
 ;
"RTN","PSUOP2",187,0)
 S PSUR0=^TMP("PSOR",$J,PSURXIEN,0)
"RTN","PSUOP2",188,0)
 F X="PSURELDT^13","PSURTSDT^14" D PIECE(X,PSUR0,U)
"RTN","PSUOP2",189,0)
 I PSURELDT,$D(^PSRX("AR",PSURELDT,PSURXIEN,PSUFIL)) Q
"RTN","PSUOP2",190,0)
 I $D(PSUCMA(PSUFIL)) K PSUCMA(PSUFIL)
"RTN","PSUOP2",191,0)
 Q
"RTN","PSUOP2",192,0)
PIECE(%,REC,DLM) ;Piece % from record REC using delimiter DLM
"RTN","PSUOP2",193,0)
 ; %="VARNAME^PIECE",REC=SOURCE,DLM=DELIMITER in REC
"RTN","PSUOP2",194,0)
 N Y,I S Y=$P(%,U,1),I=$P(%,U,2) S @Y=$P(REC,DLM,I)
"RTN","PSUOP2",195,0)
 Q
"RTN","PSUOP2",196,0)
 ;
"VER")
8.0^22.0
"BLD",6909,6)
^5
**END**
**END**
