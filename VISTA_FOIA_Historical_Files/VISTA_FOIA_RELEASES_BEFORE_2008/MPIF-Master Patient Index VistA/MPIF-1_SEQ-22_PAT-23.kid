Released MPIF*1*23 SEQ #22
Extracted from mail message
**KIDS**:MPIF*1.0*23^

**INSTALL NAME**
MPIF*1.0*23
"BLD",1543,0)
MPIF*1.0*23^MASTER PATIENT INDEX VISTA^0^3020719^y
"BLD",1543,1,0)
^^4^4^3020719^
"BLD",1543,1,1,0)
SPI ACTION NAME CHANGE AND TF LIST ERROR IN SPI AND DISPLAY ONLY 
"BLD",1543,1,2,0)
QUERY
"BLD",1543,1,3,0)
Refer to patch MPIF*1.0*23 in the FORUM Patch Module for a complete
"BLD",1543,1,4,0)
description.
"BLD",1543,4,0)
^9.64PA^^
"BLD",1543,"ABNS",0)
^9.66A^^
"BLD",1543,"ABPKG")
n^^
"BLD",1543,"KRN",0)
^9.67PA^8989.52^19
"BLD",1543,"KRN",.4,0)
.4
"BLD",1543,"KRN",.401,0)
.401
"BLD",1543,"KRN",.402,0)
.402
"BLD",1543,"KRN",.403,0)
.403
"BLD",1543,"KRN",.5,0)
.5
"BLD",1543,"KRN",.84,0)
.84
"BLD",1543,"KRN",3.6,0)
3.6
"BLD",1543,"KRN",3.8,0)
3.8
"BLD",1543,"KRN",9.2,0)
9.2
"BLD",1543,"KRN",9.8,0)
9.8
"BLD",1543,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",1543,"KRN",9.8,"NM",1,0)
MPIFQ1^^0^B84837552
"BLD",1543,"KRN",9.8,"NM",2,0)
MPIFSAQ^^0^B84104216
"BLD",1543,"KRN",9.8,"NM",3,0)
MPIFVTQ^^0^B37441639
"BLD",1543,"KRN",9.8,"NM","B","MPIFQ1",1)

"BLD",1543,"KRN",9.8,"NM","B","MPIFSAQ",2)

"BLD",1543,"KRN",9.8,"NM","B","MPIFVTQ",3)

"BLD",1543,"KRN",19,0)
19
"BLD",1543,"KRN",19.1,0)
19.1
"BLD",1543,"KRN",101,0)
101
"BLD",1543,"KRN",101,"NM",0)
^9.68A^6^6
"BLD",1543,"KRN",101,"NM",1,0)
MPIF REAL-TIME QUERY (ADD PATIENT)^^0
"BLD",1543,"KRN",101,"NM",2,0)
MPIF REAL-TIME QUERY (SELECT PATIENT)^^0
"BLD",1543,"KRN",101,"NM",3,0)
MPIF REAL-TIME QUERY MENU^^0
"BLD",1543,"KRN",101,"NM",4,0)
MPIF REAL-TIME QUERY (HELP)^^0
"BLD",1543,"KRN",101,"NM",5,0)
MPIF REAL-TIME QUERY (MPI PDAT)^^0
"BLD",1543,"KRN",101,"NM",6,0)
MPIF REAL-TIME QUERY (CMOR PDAT)^^0
"BLD",1543,"KRN",101,"NM","B","MPIF REAL-TIME QUERY (ADD PATIENT)",1)

"BLD",1543,"KRN",101,"NM","B","MPIF REAL-TIME QUERY (CMOR PDAT)",6)

"BLD",1543,"KRN",101,"NM","B","MPIF REAL-TIME QUERY (HELP)",4)

"BLD",1543,"KRN",101,"NM","B","MPIF REAL-TIME QUERY (MPI PDAT)",5)

"BLD",1543,"KRN",101,"NM","B","MPIF REAL-TIME QUERY (SELECT PATIENT)",2)

"BLD",1543,"KRN",101,"NM","B","MPIF REAL-TIME QUERY MENU",3)

"BLD",1543,"KRN",409.61,0)
409.61
"BLD",1543,"KRN",409.61,"NM",0)
^9.68A^^
"BLD",1543,"KRN",771,0)
771
"BLD",1543,"KRN",870,0)
870
"BLD",1543,"KRN",8989.51,0)
8989.51
"BLD",1543,"KRN",8989.52,0)
8989.52
"BLD",1543,"KRN",8994,0)
8994
"BLD",1543,"KRN","B",.4,.4)

"BLD",1543,"KRN","B",.401,.401)

"BLD",1543,"KRN","B",.402,.402)

"BLD",1543,"KRN","B",.403,.403)

"BLD",1543,"KRN","B",.5,.5)

"BLD",1543,"KRN","B",.84,.84)

"BLD",1543,"KRN","B",3.6,3.6)

"BLD",1543,"KRN","B",3.8,3.8)

"BLD",1543,"KRN","B",9.2,9.2)

"BLD",1543,"KRN","B",9.8,9.8)

"BLD",1543,"KRN","B",19,19)

"BLD",1543,"KRN","B",19.1,19.1)

"BLD",1543,"KRN","B",101,101)

"BLD",1543,"KRN","B",409.61,409.61)

"BLD",1543,"KRN","B",771,771)

"BLD",1543,"KRN","B",870,870)

"BLD",1543,"KRN","B",8989.51,8989.51)

"BLD",1543,"KRN","B",8989.52,8989.52)

"BLD",1543,"KRN","B",8994,8994)

"BLD",1543,"QUES",0)
^9.62^^
"BLD",1543,"REQB",0)
^9.611^2^2
"BLD",1543,"REQB",1,0)
MPIF*1.0*21^1
"BLD",1543,"REQB",2,0)
MPIF*1.0*17^1
"BLD",1543,"REQB","B","MPIF*1.0*17",2)

"BLD",1543,"REQB","B","MPIF*1.0*21",1)

"KRN",101,1199,-1)
0^3
"KRN",101,1199,0)
MPIF REAL-TIME QUERY MENU^actions for real-time query screen^^M^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1199,4)
32^4
"KRN",101,1199,10,0)
^101.01PA^8^8
"KRN",101,1199,10,4,0)
1868^MPI^12^
"KRN",101,1199,10,4,"^")
MPIF REAL-TIME QUERY (MPI PDAT)
"KRN",101,1199,10,5,0)
1867^CMR^22^
"KRN",101,1199,10,5,"^")
MPIF REAL-TIME QUERY (CMOR PDAT)
"KRN",101,1199,10,6,0)
1202^NEW^21^
"KRN",101,1199,10,6,"^")
MPIF REAL-TIME QUERY (ADD PATIENT)
"KRN",101,1199,10,7,0)
1200^SE^11^
"KRN",101,1199,10,7,"^")
MPIF REAL-TIME QUERY (SELECT PATIENT)
"KRN",101,1199,10,8,0)
1205^HLP^13^
"KRN",101,1199,10,8,"^")
MPIF REAL-TIME QUERY (HELP)
"KRN",101,1199,20)

"KRN",101,1199,26)
D SHOW^VALM
"KRN",101,1199,28)
Select Action:
"KRN",101,1199,99)
59002,51015
"KRN",101,1199,770)
^^^^^^^^^^
"KRN",101,1200,-1)
0^2
"KRN",101,1200,0)
MPIF REAL-TIME QUERY (SELECT PATIENT)^Match with Existing Pt on List^^A^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1200,20)
D SELECT^MPIFQ1
"KRN",101,1200,99)
58994,53067
"KRN",101,1200,770)
^^^^^^^^^^
"KRN",101,1202,-1)
0^1
"KRN",101,1202,0)
MPIF REAL-TIME QUERY (ADD PATIENT)^Create NEW National ICN^^A^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1202,20)
D ADD^MPIFQ1
"KRN",101,1202,99)
58994,52939
"KRN",101,1202,770)
^^^^^^^^^^
"KRN",101,1205,-1)
0^4
"KRN",101,1205,0)
MPIF REAL-TIME QUERY (HELP)^HELP^^A^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1205,1,0)
^101.06^2^2^3020717^^^^
"KRN",101,1205,1,1,0)
Help for List Manager screen actions during Single Patient Initialization
"KRN",101,1205,1,2,0)
to MPI option.
"KRN",101,1205,4)
^^^HLP
"KRN",101,1205,20)
D HELP^MPIFQ1
"KRN",101,1205,99)
59002,50785
"KRN",101,1205,770)
^^^^^^^^^^
"KRN",101,1867,-1)
0^6
"KRN",101,1867,0)
MPIF REAL-TIME QUERY (CMOR PDAT)^CMOR's Data View^^A^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1867,1,0)
^101.06^1^1^3011210^^
"KRN",101,1867,1,1,0)
This action will allow the user to request PDAT information from the CMOR.
"KRN",101,1867,4)
^^^CPDAT
"KRN",101,1867,20)
D CMOR^MPIFQ1
"KRN",101,1867,99)
58979,54893
"KRN",101,1868,-1)
0^5
"KRN",101,1868,0)
MPIF REAL-TIME QUERY (MPI PDAT)^MPI Data View^^A^^^^^^^^MASTER PATIENT INDEX VISTA
"KRN",101,1868,1,0)
^^1^1^3011210^
"KRN",101,1868,1,1,0)
This action will allow the user to request PDAT information from the MPI.
"KRN",101,1868,4)
^^^MPDAT
"KRN",101,1868,20)
D MPIPD^MPIFQ1
"KRN",101,1868,99)
58979,54893
"MBREQ")
0
"ORD",15,101)
101;15;;;PRO^XPDTA;PROF1^XPDIA;PROE1^XPDIA;PROF2^XPDIA;;PRODEL^XPDIA
"ORD",15,101,0)
PROTOCOL
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
23^3020719
"PKG",282,22,1,"PAH",1,1,0)
^^4^4^3020719
"PKG",282,22,1,"PAH",1,1,1,0)
SPI ACTION NAME CHANGE AND TF LIST ERROR IN SPI AND DISPLAY ONLY 
"PKG",282,22,1,"PAH",1,1,2,0)
QUERY
"PKG",282,22,1,"PAH",1,1,3,0)
Refer to patch MPIF*1.0*23 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,4,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","MPIFQ1")
0^1^B84837552
"RTN","MPIFQ1",1,0)
MPIFQ1 ;ALB/RJS-CIRN QUERY HANDLER ;JUN 30, 1997
"RTN","MPIFQ1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,8,12,16,17,21,23**;30 Apr 99
"RTN","MPIFQ1",3,0)
 ;
"RTN","MPIFQ1",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFQ1",5,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFQ1",6,0)
 ;   FILE^VAFCTFU - #2988
"RTN","MPIFQ1",7,0)
 ;   ^DPT("AICN" - #2070
"RTN","MPIFQ1",8,0)
 ;   NAME^VAFCPID2 - #3492
"RTN","MPIFQ1",9,0)
 ;   EN1^XWB2HL7 - #3144
"RTN","MPIFQ1",10,0)
 ;   RTNDATA^XWBDRPC - #3149
"RTN","MPIFQ1",11,0)
 ;   VAFC REMOTE PDAT (RPC) - #3496
"RTN","MPIFQ1",12,0)
 ;
"RTN","MPIFQ1",13,0)
INIT ;Entry point for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",14,0)
 Q
"RTN","MPIFQ1",15,0)
HDR ;Header code for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",16,0)
 N SSN,DOB,MPIFQ1,NAME1,SEX
"RTN","MPIFQ1",17,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.03;.09;.02","EI")
"RTN","MPIFQ1",18,0)
 S NAME1=$G(MPIFQ1(2,DFN,.01,"E")),SSN=$G(MPIFQ1(2,DFN,.09,"E"))
"RTN","MPIFQ1",19,0)
 S DOB=$G(MPIFQ1(2,DFN,.03,"I")),SEX=$G(MPIFQ1(2,DFN,.02,"E"))
"RTN","MPIFQ1",20,0)
 I DOB]"" S DOB=$TR($$FMTE^XLFDT(DOB,"5D"),"/","-")
"RTN","MPIFQ1",21,0)
 S VALMHDR(1)=" Possible MPI Matches for Patient: "_IOINHI_NAME1_IOINORM
"RTN","MPIFQ1",22,0)
 S VALMHDR(2)="                              SSN: "_IOINHI_SSN_IOINORM
"RTN","MPIFQ1",23,0)
 S VALMHDR(3)="                              DOB: "_IOINHI_DOB_IOINORM
"RTN","MPIFQ1",24,0)
 S VALMHDR(4)="                              SEX: "_IOINHI_SEX_IOINORM
"RTN","MPIFQ1",25,0)
 S VALMHDR(5)=" "
"RTN","MPIFQ1",26,0)
 Q
"RTN","MPIFQ1",27,0)
START(INDEX) ;Starting entry point for envoking the List Manager Template MPIF Real-time query
"RTN","MPIFQ1",28,0)
 S VALMCNT=INDEX
"RTN","MPIFQ1",29,0)
 D EN^VALM("MPIF REAL-TIME QUERY")
"RTN","MPIFQ1",30,0)
 Q
"RTN","MPIFQ1",31,0)
SELECT N VALMY
"RTN","MPIFQ1",32,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",33,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",34,0)
 N DATA,INDEX,ICN,CHKSUM,NODE2,HERESSN
"RTN","MPIFQ1",35,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",36,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ1",37,0)
 S NODE2=$G(^TMP("MPIFQ0",$J,INDEX,"INDICATOR"))
"RTN","MPIFQ1",38,0)
 S DATA(.01)=$P(DATA,"^",1) I $E(DATA(.01),$L(DATA(.01)))=" " S DATA(.01)=$E(DATA(.01),1,$L(DATA(.01))-1) ;NAME
"RTN","MPIFQ1",39,0)
 S DATA(.03)=$P(DATA,"^",3) ;DOB
"RTN","MPIFQ1",40,0)
 S DATA(.09)=$P(DATA,"^",2) ;SSN
"RTN","MPIFQ1",41,0)
 S DATA(.02)=$P(DATA,"^",8) ;SEX
"RTN","MPIFQ1",42,0)
 S ICN=$P(DATA,"^",4),CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ1",43,0)
 S ICN=$P(ICN,"V",1) ;ICN
"RTN","MPIFQ1",44,0)
 S DATA(991.01)=ICN
"RTN","MPIFQ1",45,0)
 S DATA(991.02)=CHKSUM ;CHKSUM
"RTN","MPIFQ1",46,0)
 S DATA(991.03)=$$LKUP^XUAF4($P(DATA,"^",7)) ;CMOR
"RTN","MPIFQ1",47,0)
 ;
"RTN","MPIFQ1",48,0)
 ;If NODE2["*" it means we got a match on ICN for a patient in our
"RTN","MPIFQ1",49,0)
 ;list, with a patient in our local database. Since we don't allow more 
"RTN","MPIFQ1",50,0)
 ;than one patient to have the same ICN, we log an Exception and assign 
"RTN","MPIFQ1",51,0)
 ;a Local ICN for this patient.
"RTN","MPIFQ1",52,0)
 I NODE2["*",$O(^DPT("AICN",ICN,""))'=DFN D  Q
"RTN","MPIFQ1",53,0)
 .D CLEAR^VALM1,MSG1,START^RGHLLOG()
"RTN","MPIFQ1",54,0)
 .D EXC^RGHLLOG(227,"Attempted to assign same ICN to Patient DFN "_DFN_". ICN is already used for Name: "_DATA(.01)_" SSN: "_DATA(.09)_" DOB: "_DATA(.03)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ1",55,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIFQ1",56,0)
 .W !!,"Assigning Local ICN"
"RTN","MPIFQ1",57,0)
 .D LOCAL^MPIFQ0(DFN),PROMPT
"RTN","MPIFQ1",58,0)
 .S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",59,0)
 ;
"RTN","MPIFQ1",60,0)
 ;User selected one from the list that doesn't exist already in this
"RTN","MPIFQ1",61,0)
 ; Patient file. Does SSN and Name match?  If no - ask if they are sure 
"RTN","MPIFQ1",62,0)
 ; before updating ICN and CMOR fields
"RTN","MPIFQ1",63,0)
 N SSN,NAME,SEX
"RTN","MPIFQ1",64,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.09;.02","EI")
"RTN","MPIFQ1",65,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E")),NAME=$G(MPIFQ1(2,DFN,.01,"E"))
"RTN","MPIFQ1",66,0)
 S SEX=$G(MPIFQ1(2,DFN,.02,"I"))
"RTN","MPIFQ1",67,0)
 ; if sex doesn't match -- not allowed to update ICN
"RTN","MPIFQ1",68,0)
 I DATA(.02)'=SEX W !!,"Sex for these two patients doesn't match -- Can't select this patient until",!,"Sex matches between the MPI and your site.  No action will be taken." D PROMPT S VALMBCK="R" Q
"RTN","MPIFQ1",69,0)
 I SSN["P" S SSN=""
"RTN","MPIFQ1",70,0)
 I DATA(.09)'=SSN W !!,"SSN for these two patients doesn't match -- Can't select this patient until",!,"SSN matches between the MPI and your site.  No action will be taken." D PROMPT S VALMBCK="R" Q
"RTN","MPIFQ1",71,0)
 ;Name, SSN and Sex match on site and MPI -- Update ICN and CMOR
"RTN","MPIFQ1",72,0)
 D NAME^VAFCPID2(0,.NAME,0) ;reformat name into DG 149 format
"RTN","MPIFQ1",73,0)
 N NAME3 S NAME3=DATA(.01)
"RTN","MPIFQ1",74,0)
 D NAME^VAFCPID2(0,.NAME3,0) S DATA(.01)=NAME3 ;reformat name into DG 149 format
"RTN","MPIFQ1",75,0)
 I DATA(.01)=NAME K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") D MSG3,PROMPT,TF(DFN,.DATA) Q
"RTN","MPIFQ1",76,0)
 ;
"RTN","MPIFQ1",77,0)
 ;Name doesn't match exactly - ask if sure
"RTN","MPIFQ1",78,0)
 D CLEAR^VALM1,MSG2
"RTN","MPIFQ1",79,0)
 D MSG(SSN,NAME,DATA(.09),DATA(.01))
"RTN","MPIFQ1",80,0)
 N ANS S ANS=$$PROMPT1()
"RTN","MPIFQ1",81,0)
 I ANS K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") S MPIFRTN="CONTINUE" W !!,"ICN and CMOR Updated" D PROMPT,TF(DFN,.DATA) Q
"RTN","MPIFQ1",82,0)
 D MSG5,PROMPT
"RTN","MPIFQ1",83,0)
 S VALMBCK="R"
"RTN","MPIFQ1",84,0)
 Q
"RTN","MPIFQ1",85,0)
ADD ;Add List Manager Action (MPIF REAL-TIME QUERY (ADD PATIENT)) to add
"RTN","MPIFQ1",86,0)
 ; patient to the MPI Austin.
"RTN","MPIFQ1",87,0)
 D A28^MPIFQ0(DFN)
"RTN","MPIFQ1",88,0)
 D MSG3,PROMPT
"RTN","MPIFQ1",89,0)
 S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",90,0)
 Q
"RTN","MPIFQ1",91,0)
MPIPD ; MPI PDAT CALL
"RTN","MPIFQ1",92,0)
 N VALMY
"RTN","MPIFQ1",93,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",94,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",95,0)
 N DATA,INDEX,ICN,CHKSUM,CMOR,CASE,CMOR3,TTF
"RTN","MPIFQ1",96,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",97,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",98,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"HOLD")
"RTN","MPIFQ1",99,0)
 S CMOR=$P(DATA,HL("FS"),5),CMOR3=CMOR,CMOR=$P($$NS^XUAF4($$LKUP^XUAF4(CMOR)),"^")
"RTN","MPIFQ1",100,0)
 W !,"MPI Data:",!!
"RTN","MPIFQ1",101,0)
 W !,?3,"ICN: ",+$P(DATA,HL("FS"),6),?30,"CMOR: ",CMOR," (",CMOR3,")"
"RTN","MPIFQ1",102,0)
 W !,?2,"NAME: ",$P(DATA,HL("FS"),2)_","_$P(DATA,HL("FS"),7)_" "
"RTN","MPIFQ1",103,0)
 I $P(DATA,HL("FS"),10)'="" W $P(DATA,HL("FS"),10)_" "
"RTN","MPIFQ1",104,0)
 I $P(DATA,HL("FS"),15)'="" W $P(DATA,HL("FS"),15)
"RTN","MPIFQ1",105,0)
 W !,?3,"SSN: ",$P(DATA,HL("FS"),3),?30,"SEX: ",$P(DATA,HL("FS"),11)
"RTN","MPIFQ1",106,0)
 N Y S Y=""
"RTN","MPIFQ1",107,0)
 I $P(DATA,HL("FS"),4)'="" S Y=$$HL7TFM^XLFDT($P(DATA,HL("FS"),4)) D DD^%DT
"RTN","MPIFQ1",108,0)
 W !,?3,"DOB: ",Y
"RTN","MPIFQ1",109,0)
 S Y="" I $P(DATA,HL("FS"),9)'="" S Y=$$HL7TFM^XLFDT($P(DATA,HL("FS"),9)) D DD^%DT
"RTN","MPIFQ1",110,0)
 W ?30,"DOD: ",Y
"RTN","MPIFQ1",111,0)
 I ($P(DATA,HL("FS"),12)='"")&($P(DATA,HL("FS"),13)'="") W !,?2,"PLACE OF BIRTH: ",$P(DATA,HL("FS"),12),", ",$P(DATA,HL("FS"),13)
"RTN","MPIFQ1",112,0)
 I $P(DATA,HL("FS"),12)=""!($P(DATA,HL("FS"),13)="") W !,?2,"PLACE OF BIRTH: ",$P(DATA,HL("FS"),12)," ",$P(DATA,HL("FS"),13)
"RTN","MPIFQ1",113,0)
 W !,?2,"MOTHER'S MAIDEN NAME: ",$P(DATA,HL("FS"),16)
"RTN","MPIFQ1",114,0)
 W !,?2,"CLAIM NUMBER: ",$P(DATA,HL("FS"),17)
"RTN","MPIFQ1",115,0)
 S CASE=$P(DATA,HL("FS"),18)
"RTN","MPIFQ1",116,0)
 I CASE'="" W !,?2,"Open Data Management Case",!,?5,"CASE#: ",$P(CASE,"/")_"   NOIS#: ",$P(CASE,"/",2),!,?5,"CASE WORKER: ",$P(CASE,"/",3)
"RTN","MPIFQ1",117,0)
 S TTF=$P(DATA,HL("FS"),8)
"RTN","MPIFQ1",118,0)
 I TTF'=""&($P(TTF,"~",2)'="") D
"RTN","MPIFQ1",119,0)
 .W !,?2,"TREATING FACILITY LIST:"
"RTN","MPIFQ1",120,0)
 .N XX,TMP F XX=1:1:128 S TMP=$P(TTF,"~",XX) Q:TMP=""  I TMP'=CMOR3 W !?10,"Treating Facility: ",$P($$NS^XUAF4($$LKUP^XUAF4(TMP)),"^")," (",TMP,")"
"RTN","MPIFQ1",121,0)
 .I XX>25 W !!,"There maybe more Treating Facilities, only the first 25 will be displayed."
"RTN","MPIFQ1",122,0)
 D PROMPT
"RTN","MPIFQ1",123,0)
 S VALMBCK="R"
"RTN","MPIFQ1",124,0)
 Q
"RTN","MPIFQ1",125,0)
CMOR ; CMOR PDAT CALL
"RTN","MPIFQ1",126,0)
 N VALMY,DATA,INDEX,ICN,CHKSUM,CMOR
"RTN","MPIFQ1",127,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",128,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",129,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",130,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ1",131,0)
 S ICN=$P(DATA,"^",4),CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ1",132,0)
 S ICN=$P(ICN,"V",1) ;ICN
"RTN","MPIFQ1",133,0)
 S CMOR=$P(DATA,"^",7) ;CMOR
"RTN","MPIFQ1",134,0)
 ;
"RTN","MPIFQ1",135,0)
 I CMOR=$P($$SITE^VASITE(),"^",3) W !!,"CMOR is your site" G END
"RTN","MPIFQ1",136,0)
 ;
"RTN","MPIFQ1",137,0)
 W !,"Please be patient while the data is being retrieved from the CMOR."
"RTN","MPIFQ1",138,0)
 D EN1^XWB2HL7(.RETURN,CMOR,"VAFC REMOTE PDAT",1,ICN,"")  ; Request 
"RTN","MPIFQ1",139,0)
 S ^XTMP("MPIFPDAT"_ICN,0)=$$FMADD^XLFDT(DT,2)_"^"_DT_"^"_"REMOTE PDAT QUERY"
"RTN","MPIFQ1",140,0)
 S ^XTMP("MPIFPDAT"_ICN,1)=RETURN(0)_"^"_$$NOW^XLFDT
"RTN","MPIFQ1",141,0)
 S CNT=0
"RTN","MPIFQ1",142,0)
AGAIN1 H 2 K RES1 D RTNDATA^XWBDRPC(.RES1,RETURN(0)) S CNT=CNT+1
"RTN","MPIFQ1",143,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT<11 G AGAIN1
"RTN","MPIFQ1",144,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT>10 W !,"Unable to get data" G END
"RTN","MPIFQ1",145,0)
 I RES1(0)="0^New" I CNT<11 G AGAIN1
"RTN","MPIFQ1",146,0)
 I RES1(0)="0^New" I CNT>10 W !,"Unable to get data" G END
"RTN","MPIFQ1",147,0)
 I +RES1(0)=-1 W !!,$P(RES1(0),"^",2) G END
"RTN","MPIFQ1",148,0)
 I RES1'="" I CNT<11 G AGAIN1
"RTN","MPIFQ1",149,0)
 I RES1'="" I CNT>10 W !,"Unable to get data" Q
"RTN","MPIFQ1",150,0)
 ;
"RTN","MPIFQ1",151,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",152,0)
 N NUM
"RTN","MPIFQ1",153,0)
 S NUM="",CNT=0
"RTN","MPIFQ1",154,0)
 F  S NUM=$O(RES1(NUM)) Q:NUM=""  D
"RTN","MPIFQ1",155,0)
 .I CNT>20 D PROMPT,CLEAR^VALM1 S CNT=0
"RTN","MPIFQ1",156,0)
 .I RES1(NUM)["Additional" W !! S CNT=CNT+2
"RTN","MPIFQ1",157,0)
 .I CNT<21 W !,RES1(NUM) S CNT=CNT+1
"RTN","MPIFQ1",158,0)
END D PROMPT
"RTN","MPIFQ1",159,0)
 S VALMBCK="R"
"RTN","MPIFQ1",160,0)
 K CNT,RETURN,RES1
"RTN","MPIFQ1",161,0)
 Q
"RTN","MPIFQ1",162,0)
HELP ; Help List Manager Action (MPIF REAL-TIME QUERY (HELP))
"RTN","MPIFQ1",163,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",164,0)
 D MSG4
"RTN","MPIFQ1",165,0)
 D PROMPT
"RTN","MPIFQ1",166,0)
 S VALMBCK="R"
"RTN","MPIFQ1",167,0)
 Q
"RTN","MPIFQ1",168,0)
MSG(LOCSSN,LOCNAME,MPISSN,MPINAME) ;
"RTN","MPIFQ1",169,0)
 W !!!,"Local SSN = "_LOCSSN,?35,"MPI SSN = "_MPISSN
"RTN","MPIFQ1",170,0)
 W !,"Local NAME = "_LOCNAME,?40,"MPI NAME = "_MPINAME
"RTN","MPIFQ1",171,0)
 Q
"RTN","MPIFQ1",172,0)
MSG3 W !!,"Updating ICN and CMOR"
"RTN","MPIFQ1",173,0)
 Q
"RTN","MPIFQ1",174,0)
MSG1 W !!,"You are attempting to assign an ICN that has already been assigned"
"RTN","MPIFQ1",175,0)
 W !,"to another patient in your Patient file."
"RTN","MPIFQ1",176,0)
 W !,"An exception will be recorded noting that these 2 patients "
"RTN","MPIFQ1",177,0)
 W !,"need to be reviewed to determine if they are duplicates."
"RTN","MPIFQ1",178,0)
 Q
"RTN","MPIFQ1",179,0)
MSG2 W !!,"You have selected a patient from the list of potential matches"
"RTN","MPIFQ1",180,0)
 W !," where the Name is different than what the MPI has."
"RTN","MPIFQ1",181,0)
 W !," Are you sure this is the correct patient?"
"RTN","MPIFQ1",182,0)
 Q
"RTN","MPIFQ1",183,0)
MSG5 W !!,"No Action Taken"
"RTN","MPIFQ1",184,0)
 Q
"RTN","MPIFQ1",185,0)
MSG4 W !!,"When you have reached MPI QUERY RESULTS screen, the software has"
"RTN","MPIFQ1",186,0)
 W !,"queried the Master Patient Index, for possible matches to the patient"
"RTN","MPIFQ1",187,0)
 W !,"you are adding, or selected (pre-existing record)."
"RTN","MPIFQ1",188,0)
 W !!,"The MPI has returned a list of possible matches for that patient"
"RTN","MPIFQ1",189,0)
 W !,"An '*' indicates the Integration Control Number of a patient"
"RTN","MPIFQ1",190,0)
 W !,"on the list, matches one in your Patient file already."
"RTN","MPIFQ1",191,0)
 W !,"To select a patient from the list, choose SE."
"RTN","MPIFQ1",192,0)
 W !,"If the patients listed as potential matches aren't the same patient"
"RTN","MPIFQ1",193,0)
 W !,"select NEW to create a new entry on the MPI for this patient."
"RTN","MPIFQ1",194,0)
 W !,"To view all data for a patient in the list of possible matches"
"RTN","MPIFQ1",195,0)
 W !,"from the MPI, select MPI."
"RTN","MPIFQ1",196,0)
 W !,"To view additional data for a patient in the list of possible"
"RTN","MPIFQ1",197,0)
 W !,"matches from the CMOR site, select CMR."
"RTN","MPIFQ1",198,0)
 Q
"RTN","MPIFQ1",199,0)
PROMPT ;
"RTN","MPIFQ1",200,0)
 W !!
"RTN","MPIFQ1",201,0)
 S DIR("A")="Hit the Enter key, to Continue "
"RTN","MPIFQ1",202,0)
 S DIR(0)="EA"
"RTN","MPIFQ1",203,0)
 D ^DIR
"RTN","MPIFQ1",204,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",205,0)
 Q
"RTN","MPIFQ1",206,0)
PROMPT1() ;
"RTN","MPIFQ1",207,0)
 N DIR,X,Y
"RTN","MPIFQ1",208,0)
 W !
"RTN","MPIFQ1",209,0)
 S DIR("A")="Are you sure this is the correct patient? Enter YES or NO "
"RTN","MPIFQ1",210,0)
 S DIR(0)="YA"
"RTN","MPIFQ1",211,0)
 D ^DIR
"RTN","MPIFQ1",212,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",213,0)
 Q Y
"RTN","MPIFQ1",214,0)
HERESSN(SSN) ;
"RTN","MPIFQ1",215,0)
 N DFN
"RTN","MPIFQ1",216,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ1",217,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ1",218,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ1",219,0)
 Q DFN
"RTN","MPIFQ1",220,0)
CHECK(DFN) ;
"RTN","MPIFQ1",221,0)
 N CHECK
"RTN","MPIFQ1",222,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"CHECK",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ1",223,0)
 I $G(CHECK(2,DFN,.01))']"" Q 0
"RTN","MPIFQ1",224,0)
 I $G(CHECK(2,DFN,.02))']"" Q 0
"RTN","MPIFQ1",225,0)
 I $G(CHECK(2,DFN,.03))']"" Q 0
"RTN","MPIFQ1",226,0)
 I $G(CHECK(2,DFN,.09))']"" Q 0
"RTN","MPIFQ1",227,0)
 I $G(CHECK(2,DFN,.301))']"" Q 0
"RTN","MPIFQ1",228,0)
 I $G(CHECK(2,DFN,391))']"" Q 0
"RTN","MPIFQ1",229,0)
 I $G(CHECK(2,DFN,1901))']"" Q 0
"RTN","MPIFQ1",230,0)
 Q 1
"RTN","MPIFQ1",231,0)
EXIT ;Exit for List Manager Template MPIF REAL-TIME QUERY
"RTN","MPIFQ1",232,0)
 K VALMBCK,VALMCNT,VALMHDR
"RTN","MPIFQ1",233,0)
 Q
"RTN","MPIFQ1",234,0)
TF(DFN,ARR) ;Add you to TF list and trigger TF and Sub msgs
"RTN","MPIFQ1",235,0)
 N SITE
"RTN","MPIFQ1",236,0)
 S SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFQ1",237,0)
 I $$PATCH^XPDUTL("DG*5.3*261") D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ1",238,0)
 Q
"RTN","MPIFSAQ")
0^2^B84104216
"RTN","MPIFSAQ",1,0)
MPIFSAQ ;SF/CMC-STAND ALONE QUERY ;JAN 12, 1998
"RTN","MPIFSAQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,13,17,21,23**;30 Apr 99
"RTN","MPIFSAQ",3,0)
 ;
"RTN","MPIFSAQ",4,0)
 ;Integration Agreements:
"RTN","MPIFSAQ",5,0)
 ;  $$SEND^RGJUSITE - #3469
"RTN","MPIFSAQ",6,0)
 ;  $$EN^HLCSAC - #3471
"RTN","MPIFSAQ",7,0)
 ;
"RTN","MPIFSAQ",8,0)
INTACTV ;Interactive standalone query - Display Only!
"RTN","MPIFSAQ",9,0)
 ;patient doesn't have to be in Patient file
"RTN","MPIFSAQ",10,0)
 S FLG=0
"RTN","MPIFSAQ",11,0)
 K DIR,X,Y
"RTN","MPIFSAQ",12,0)
 S DIR(0)="Y",DIR("B")="YES",DIR("A")="Is Patient in the PATIENT file "
"RTN","MPIFSAQ",13,0)
 D ^DIR
"RTN","MPIFSAQ",14,0)
 G:(Y'=1)&(Y'=0) END
"RTN","MPIFSAQ",15,0)
 I Y=1 S FLG=1 D PAT(.MPIVAR)
"RTN","MPIFSAQ",16,0)
 I Y'=1,'$D(MPIVAR) D NOPAT(.MPIVAR)
"RTN","MPIFSAQ",17,0)
 I '$D(MPIVAR("DFN"))&(FLG'=0) G END
"RTN","MPIFSAQ",18,0)
 I +$G(MPIVAR("DOB"))'>0 W !,"DOB is missing - Required field" G END
"RTN","MPIFSAQ",19,0)
 D VTQ(.MPIVAR)
"RTN","MPIFSAQ",20,0)
 K DIR,X,Y,MPIVAR,FLG
"RTN","MPIFSAQ",21,0)
 Q
"RTN","MPIFSAQ",22,0)
END K DIR,X,Y,MPIVAR,DIRUT,DTOUT,DUOUT
"RTN","MPIFSAQ",23,0)
 Q
"RTN","MPIFSAQ",24,0)
CLEAN(NAM) ;
"RTN","MPIFSAQ",25,0)
 ;NAM is the name to be cleaned up
"RTN","MPIFSAQ",26,0)
 ; Returned from this function is a clean name
"RTN","MPIFSAQ",27,0)
 N YY,I
"RTN","MPIFSAQ",28,0)
 ; -- only uppercase
"RTN","MPIFSAQ",29,0)
 I NAM?.E1L.E F I=1:1:$L(NAM) S:$E(NAM,I)?1L NAM=$E(NAM,0,I-1)_$C($A(NAM,I)-32)_$E(NAM,I+1,$L(NAM))
"RTN","MPIFSAQ",30,0)
 ; -- no space after comma and no double spaces
"RTN","MPIFSAQ",31,0)
 F YY=", ","  " F  Q:'$F(NAM,YY)  S NAM=$E(NAM,1,($F(NAM,YY)-2))_$E(NAM,$F(NAM,YY),$L(NAM))
"RTN","MPIFSAQ",32,0)
 ; -- no space at the end
"RTN","MPIFSAQ",33,0)
 F  Q:$E(NAM,$L(NAM))'=" "  S NAM=$E(NAM,1,$L(NAM)-1)
"RTN","MPIFSAQ",34,0)
 Q NAM
"RTN","MPIFSAQ",35,0)
PAT(MPIVAR) ;patient is in local Patient file
"RTN","MPIFSAQ",36,0)
PATA N DIC,X,Y,DIQ,DR,DA,MPIFAR,DFN,DTOUT,DUOUT
"RTN","MPIFSAQ",37,0)
 S DIC="^DPT(",DIC(0)="AEQZM",DIC("A")="Patient Name: "
"RTN","MPIFSAQ",38,0)
 D ^DIC
"RTN","MPIFSAQ",39,0)
 G:$D(DTOUT)!($D(DUOUT))!(Y="^")!(X="") END
"RTN","MPIFSAQ",40,0)
 I +Y=-1 W !,"Patient not found.  Try Again" G PATA
"RTN","MPIFSAQ",41,0)
 S (DFN,MPIVAR("DFN"))=+Y,MPIVAR("NM")=$P(Y(0),"^")
"RTN","MPIFSAQ",42,0)
 S DIQ="MPIFAR",DR=".09;.03",DIC="^DPT(",DA=+Y,DIQ(0)="I"
"RTN","MPIFSAQ",43,0)
 D EN^DIQ1
"RTN","MPIFSAQ",44,0)
 K DA
"RTN","MPIFSAQ",45,0)
 S MPIVAR("DOB")=$G(MPIFAR(2,DFN,.03,"I"))
"RTN","MPIFSAQ",46,0)
 S MPIVAR("SSN")=$G(MPIFAR(2,DFN,.09,"I")) I MPIVAR("SSN")["P" S MPIVAR("SSN")=""
"RTN","MPIFSAQ",47,0)
 Q
"RTN","MPIFSAQ",48,0)
 ;
"RTN","MPIFSAQ",49,0)
NOPAT(MPIVAR) ; patient is not in the local Patient file
"RTN","MPIFSAQ",50,0)
NAME N DTOUT,DUOUT,DIR,X,Y
"RTN","MPIFSAQ",51,0)
 S DIR(0)="FU^::",DIR("A")="PATIENT NAME (last,first middle)"
"RTN","MPIFSAQ",52,0)
 D ^DIR
"RTN","MPIFSAQ",53,0)
 G:$D(DTOUT)!($D(DUOUT))!(Y="^") END
"RTN","MPIFSAQ",54,0)
 I (Y="")!($L(Y)>45)!($L(Y)<3) W !,"Name should be Last,first middle and at least 3 characters and no more than 30" G NAME
"RTN","MPIFSAQ",55,0)
 I (Y?1P.E)!(Y'?1U.ANP)!(Y'[",")!(Y[":")!(Y[";") W !,"Name should be Last,first middle and at least 3 characters and no more than 30" G NAME
"RTN","MPIFSAQ",56,0)
 I Y'?.UNP F %=1:1:$L(Y) I $E(Y,%)?1L S Y=$E(Y,0,%-1)_$C($A(Y,%)-32)_$E(Y,%+1,999)
"RTN","MPIFSAQ",57,0)
 S MPIVAR("NM")=$$CLEAN(Y)
"RTN","MPIFSAQ",58,0)
DOB K DIR,X,Y
"RTN","MPIFSAQ",59,0)
 S DIR(0)="DU^::AE",DIR("A")="Date of Birth"
"RTN","MPIFSAQ",60,0)
 D ^DIR
"RTN","MPIFSAQ",61,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",62,0)
 S MPIVAR("DOB")=Y
"RTN","MPIFSAQ",63,0)
SSN ; ssn is optional
"RTN","MPIFSAQ",64,0)
 K DIR,X,Y
"RTN","MPIFSAQ",65,0)
 S DIR(0)="FUO^9:9:",DIR("A")="9 Digit SSN (No Dashes)"
"RTN","MPIFSAQ",66,0)
 D ^DIR
"RTN","MPIFSAQ",67,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","MPIFSAQ",68,0)
 I Y'="",Y'?9N W !,"SSN should be 9 numbers" G SSN
"RTN","MPIFSAQ",69,0)
 S MPIVAR("SSN")=Y
"RTN","MPIFSAQ",70,0)
 Q
"RTN","MPIFSAQ",71,0)
 ;
"RTN","MPIFSAQ",72,0)
VTQ(MPIVAR) ;
"RTN","MPIFSAQ",73,0)
 I $$SEND^RGJUSITE'>0 W !,"Not in SEND or SUSPEND mode, Try Again Later" G END
"RTN","MPIFSAQ",74,0)
 N TIME,%
"RTN","MPIFSAQ",75,0)
 D NOW^%DTC S TIME=%
"RTN","MPIFSAQ",76,0)
 ;
"RTN","MPIFSAQ",77,0)
 W !!,"Attempting to connect to the Master Patient Index in Austin..."
"RTN","MPIFSAQ",78,0)
 W !,"If DOB is inexact or if SSN is not passed or if common name,",!,"this could take some time - please be patient...."
"RTN","MPIFSAQ",79,0)
 ;
"RTN","MPIFSAQ",80,0)
 N HL,MPIQRYNM,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER
"RTN","MPIFSAQ",81,0)
 N TEST,SITE,MPIDC,MPINM,MPI1NM,MPI2NM,MPIESC,MPIHDOB,MPIRS,MPISCS
"RTN","MPIFSAQ",82,0)
 N QUEDDOB,QUERY,RDF
"RTN","MPIFSAQ",83,0)
 S HLP("ACKTIME")=300,HL("ECH")="^~\&",HL("FS")="|",MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFSAQ",84,0)
 S MPIIN="",MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFSAQ",85,0)
 I '$D(MPIVAR("DFN")) S MPIVAR("DFN")=235
"RTN","MPIFSAQ",86,0)
 S MPIMCNT=MPIVAR("DFN")
"RTN","MPIFSAQ",87,0)
 ;
"RTN","MPIFSAQ",88,0)
 ;SETUP VTQ
"RTN","MPIFSAQ",89,0)
 ;
"RTN","MPIFSAQ",90,0)
 S MPICS=$E(HL("ECH"),1),MPIRS=$E(HL("ECH"),2),MPISCS=$E(HL("ECH"),4),MPIESC=$E(HL("ECH"),3)
"RTN","MPIFSAQ",91,0)
 ;
"RTN","MPIFSAQ",92,0)
 S RDF="RDF"_HL("FS")_16_HL("FS")_"@00108.1"_MPICS_"ST"_MPICS_30_MPIRS_"@00122"_MPICS_"ST"_MPICS_9_MPIRS_"@00110"_MPICS_"TS"_MPICS_8_MPIRS_"@00756"_MPICS_"ST"_MPICS_3
"RTN","MPIFSAQ",93,0)
 S RDF=RDF_MPIRS_"@00105"_MPICS_"ST"_MPICS_19_MPIRS_"@00108.2"_MPICS_"ST"_MPICS_30_MPIRS_"@00169"_MPICS_"ST"_MPICS_99_MPIRS_"@00740"_MPICS_"TS"_MPICS_8
"RTN","MPIFSAQ",94,0)
 S RDF=RDF_MPIRS_"@00108.3"_MPICS_"ST"_MPICS_16_MPIRS_"@00111"_MPICS_"ST"_MPICS_1_MPIRS_"@00126.1"_MPICS_"ST"_MPICS_30_MPIRS_"@00126.2"_MPICS_"ST"_MPICS_3
"RTN","MPIFSAQ",95,0)
 S RDF=RDF_MPIRS_"@00108.5"_MPICS_"ST"_MPICS_15_MPIRS_"@00108.4"_MPICS_"ST"_MPICS_10_MPIRS_"@00109.1"_MPICS_"ST"_MPICS_20_MPIRS_"@ZEL6"_MPICS_"ST"_MPICS_9
"RTN","MPIFSAQ",96,0)
 S RDF=RDF_MPIRS_"@CASE#"_MPICS_"ST"_MPICS_69
"RTN","MPIFSAQ",97,0)
 ; ^ fields to be returned in query response
"RTN","MPIFSAQ",98,0)
 S QUERY="VTQ"_HL("FS")_$G(MPIVAR("DFN"))_HL("FS")_"T"_HL("FS")_MPIQRYNM_HL("FS")_"ICN"_HL("FS")
"RTN","MPIFSAQ",99,0)
 S MPI2NM=$P($G(MPIVAR("NM")),",",1),QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFSAQ",100,0)
 ; ^ sending last name
"RTN","MPIFSAQ",101,0)
 I MPIVAR("SSN")'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_$G(MPIVAR("SSN"))
"RTN","MPIFSAQ",102,0)
 ; ^ sending SSN
"RTN","MPIFSAQ",103,0)
 S MPI1NM=$P($G(MPIVAR("NM")),",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFSAQ",104,0)
 ; ^ sending first name
"RTN","MPIFSAQ",105,0)
 I $G(MPIVAR("DOB"))>0 D
"RTN","MPIFSAQ",106,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIVAR("DOB"))
"RTN","MPIFSAQ",107,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFSAQ",108,0)
 .S QUEDDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFSAQ",109,0)
 .S QUERY=QUERY_QUEDDOB
"RTN","MPIFSAQ",110,0)
 .; ^ sending date of birth
"RTN","MPIFSAQ",111,0)
 ;
"RTN","MPIFSAQ",112,0)
 ;Create MSH
"RTN","MPIFSAQ",113,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1
"RTN","MPIFSAQ",114,0)
 S HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFSAQ",115,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFSAQ",116,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFSAQ",117,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFSAQ",118,0)
 S MPIOUT(3)=RDF
"RTN","MPIFSAQ",119,0)
 ;
"RTN","MPIFSAQ",120,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFSAQ",121,0)
 ;Message is returned in MPIDC array
"RTN","MPIFSAQ",122,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFSAQ",123,0)
 ;Clean up the ack timeout HLP array variable
"RTN","MPIFSAQ",124,0)
 K HLP("ACKTIME")
"RTN","MPIFSAQ",125,0)
 I +TEST<0 W !!,"Could not connect to MPI or Time-out occured, try again later." G EXIT
"RTN","MPIFSAQ",126,0)
 ;
"RTN","MPIFSAQ",127,0)
 ;Kill ^TMP("MPIFSAQ",$J) this is the array the data is parsed into
"RTN","MPIFSAQ",128,0)
 K ^TMP("MPIFSAQ",$J)
"RTN","MPIFSAQ",129,0)
 ;
"RTN","MPIFSAQ",130,0)
INIPARS ;
"RTN","MPIFSAQ",131,0)
 N SEG,INDEX,COUNTER,LASTSSN,SKIP,CHECK,FIRST,FICN
"RTN","MPIFSAQ",132,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFSAQ",133,0)
 K CHECK
"RTN","MPIFSAQ",134,0)
PARSE S SEG=$$SEG^MPIFAPI("RDT",1,"RDT")
"RTN","MPIFSAQ",135,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFSAQ",136,0)
 . N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,NAME,TF,ICN,POBC,POBS,PAST
"RTN","MPIFSAQ",137,0)
 . N HEREICN,HERESSN,MIDDLE,MNAME,SUFFIX,PREFIX,SEX,IEN,CMOR2,TF2,CLAIM
"RTN","MPIFSAQ",138,0)
 . N CASE,NOIS,CUSER,TFN,CMOR3
"RTN","MPIFSAQ",139,0)
 . S FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2)
"RTN","MPIFSAQ",140,0)
 . S MIDDLE=$P(SEG,HL("FS"),10),(LASTSSN,SSN)=$P(SEG,HL("FS"),3)
"RTN","MPIFSAQ",141,0)
 . S NAME=LASTNAME_","_FRSTNAME_" "_MIDDLE
"RTN","MPIFSAQ",142,0)
 . S CMOR=$P(SEG,HL("FS"),5),CMOR2=CMOR,CMOR3=CMOR
"RTN","MPIFSAQ",143,0)
 . S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFSAQ",144,0)
 . I $D(FICN) I FICN'=ICN S FIRST=1,FICN=ICN K CHECK
"RTN","MPIFSAQ",145,0)
 . I FIRST=1 S FICN=ICN
"RTN","MPIFSAQ",146,0)
 . S FIRST=FIRST+1
"RTN","MPIFSAQ",147,0)
 . I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^"),CMOR2=CMOR
"RTN","MPIFSAQ",148,0)
 . S TF=$P(SEG,HL("FS"),8),TF2=TF
"RTN","MPIFSAQ",149,0)
 . ;;Same patient just adding TF's
"RTN","MPIFSAQ",150,0)
 . I TF'="",FICN=ICN,FIRST'=2 S SKIP="Y" Q:CMOR2=TF2!($D(CHECK(TF2)))
"RTN","MPIFSAQ",151,0)
 . ;
"RTN","MPIFSAQ",152,0)
 . I $G(SKIP)="Y" K SKIP Q
"RTN","MPIFSAQ",153,0)
 . S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFSAQ",154,0)
 . I $G(LASTNAME)="" Q
"RTN","MPIFSAQ",155,0)
 . I $G(BIRTHDAY)]"" D
"RTN","MPIFSAQ",156,0)
 . . S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY)
"RTN","MPIFSAQ",157,0)
 . . S BIRTHDAY=$TR($$FMTE^XLFDT(BIRTHDAY,"5D"),"/","-")
"RTN","MPIFSAQ",158,0)
 . S SEX=$P(SEG,HL("FS"),11)
"RTN","MPIFSAQ",159,0)
 . S CLAIM=$P(SEG,HL("FS"),17)
"RTN","MPIFSAQ",160,0)
 . S SUFFIX=$P(SEG,HL("FS"),15)
"RTN","MPIFSAQ",161,0)
 . S PREFIX=$P(SEG,HL("FS"),14)
"RTN","MPIFSAQ",162,0)
 . S MNAME=$P(SEG,HL("FS"),16)
"RTN","MPIFSAQ",163,0)
 . S POBC=$P(SEG,HL("FS"),12)
"RTN","MPIFSAQ",164,0)
 . S POBS=$P(SEG,HL("FS"),13)
"RTN","MPIFSAQ",165,0)
 . S PAST=$P(SEG,HL("FS"),9)
"RTN","MPIFSAQ",166,0)
 . I $G(PAST)]"" D
"RTN","MPIFSAQ",167,0)
 . . S PAST=$$FMDATE^HLFNC(PAST)
"RTN","MPIFSAQ",168,0)
 . . S PAST=$TR($$FMTE^XLFDT(PAST,"5D"),"/","-")
"RTN","MPIFSAQ",169,0)
 . S CASE=$P(SEG,HL("FS"),18),NOIS=$P(CASE,"/",2),CUSER=$P(CASE,"/",3),CASE=$P(CASE,"/")
"RTN","MPIFSAQ",170,0)
 . ;New pt. so incrementing index and resetting counter
"RTN","MPIFSAQ",171,0)
 . S INDEX=INDEX+1
"RTN","MPIFSAQ",172,0)
 . S COUNTER=1
"RTN","MPIFSAQ",173,0)
 . I CMOR2=TF2 S TF=""
"RTN","MPIFSAQ",174,0)
 . S ^TMP("MPIFSAQ",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_SEX_"^"_SUFFIX_"^"_PREFIX_"^"_MNAME_"^"_POBC_"^"_POBS_"^"_PAST_"^"_CLAIM_"^"_CASE_"^"_NOIS_"^"_CUSER_"^"_CMOR3
"RTN","MPIFSAQ",175,0)
 ;
"RTN","MPIFSAQ",176,0)
 ; If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFSAQ",177,0)
 I '$D(^TMP("MPIFSAQ",$J)) W !!,"Patient was not found in the MPI." G EXIT
"RTN","MPIFSAQ",178,0)
DISPLAY ;
"RTN","MPIFSAQ",179,0)
 I INDEX>1 W !!,"Found potential matches"
"RTN","MPIFSAQ",180,0)
 I INDEX=1 W !!,"Found One Match"
"RTN","MPIFSAQ",181,0)
 ; display data returned
"RTN","MPIFSAQ",182,0)
 N CNT1,CNT2,STOP,CNTR2,TTF,CNT3,DIR,X,Y,DATA,PREFIX
"RTN","MPIFSAQ",183,0)
 N NAME,SSN,BIRTHDAY,CMOR,TF,ICN,POBC,POBS,PAST
"RTN","MPIFSAQ",184,0)
 N MNAME,SUFFIX,SEX,IEN,CMOR2,TF2,CLAIM,CASE,NOIS,CUSER,TFN,CMOR3
"RTN","MPIFSAQ",185,0)
 S (CNT1)=0
"RTN","MPIFSAQ",186,0)
 F  S CNT1=$O(^TMP("MPIFSAQ",$J,CNT1)) Q:CNT1'>0!($D(STOP))  D
"RTN","MPIFSAQ",187,0)
 . S CNTR2=0
"RTN","MPIFSAQ",188,0)
 . I CNT1>1 D
"RTN","MPIFSAQ",189,0)
 . . K DIR,X,Y
"RTN","MPIFSAQ",190,0)
 . . S DIR(0)="Y",DIR("B")="YES",DIR("A")="Continue to next Patient? "
"RTN","MPIFSAQ",191,0)
 . . D ^DIR
"RTN","MPIFSAQ",192,0)
 . . I Y'=1 S STOP=""
"RTN","MPIFSAQ",193,0)
 . Q:$D(STOP)
"RTN","MPIFSAQ",194,0)
 . S CNTR2=CNTR2+1
"RTN","MPIFSAQ",195,0)
 . S DATA=$G(^TMP("MPIFSAQ",$J,CNT1,"DATA"))
"RTN","MPIFSAQ",196,0)
 . Q:DATA=""
"RTN","MPIFSAQ",197,0)
 . K TF,CHECK
"RTN","MPIFSAQ",198,0)
 . S NAME=$P(DATA,"^"),SSN=$P(DATA,"^",2),BIRTHDAY=$P(DATA,"^",3)
"RTN","MPIFSAQ",199,0)
 . S ICN=$P(DATA,"^",4),CMOR=$P(DATA,"^",5),TTF=$P(DATA,"^",6)
"RTN","MPIFSAQ",200,0)
 . I TTF'="",CMOR'=TTF S TF(CNTR2)=TTF
"RTN","MPIFSAQ",201,0)
 . S SEX=$P(DATA,"^",7),SUFFIX=$P(DATA,"^",9),PREFIX=$P(DATA,"^",8)
"RTN","MPIFSAQ",202,0)
 . S MNAME=$P(DATA,"^",10),POBC=$P(DATA,"^",11),POBS=$P(DATA,"^",12)
"RTN","MPIFSAQ",203,0)
 . S PAST=$P(DATA,"^",13),CLAIM=$P(DATA,"^",14)
"RTN","MPIFSAQ",204,0)
 . S CASE=$P(DATA,"^",15),NOIS=$P(DATA,"^",16),CUSER=$P(DATA,"^",17)
"RTN","MPIFSAQ",205,0)
 . S CMOR3=$P(DATA,"^",18)
"RTN","MPIFSAQ",206,0)
 . W !!
"RTN","MPIFSAQ",207,0)
 . W:$G(CASE)'="" !,"<<THIS ICN IS ACTIVELY BEING WORKED ON - CASE #",CASE
"RTN","MPIFSAQ",208,0)
 . W:$G(NOIS)'="" " NOIS: ",NOIS
"RTN","MPIFSAQ",209,0)
 . W:$G(CASE)'="" ">>"
"RTN","MPIFSAQ",210,0)
 . W:$G(CUSER)'="" !,?3,"Case Worker: ",CUSER
"RTN","MPIFSAQ",211,0)
 . W !!,"ICN      : ",$P(ICN,"V"),?30,"CMOR: ",CMOR," (",CMOR3,")"
"RTN","MPIFSAQ",212,0)
 . W !,"Name     : ",NAME," ",SUFFIX," ",PREFIX
"RTN","MPIFSAQ",213,0)
 . W !,"SSN      : ",SSN
"RTN","MPIFSAQ",214,0)
 . W !,"DOB      : ",BIRTHDAY,?30,"Date of Death: ",PAST
"RTN","MPIFSAQ",215,0)
 . W !,"Sex      : ",SEX
"RTN","MPIFSAQ",216,0)
 . W:$G(CLAIM)'="" !,"Claim #  : ",CLAIM
"RTN","MPIFSAQ",217,0)
 . W:$G(POBC)'="" !,"Place of Birth: ",POBC,", ",POBS
"RTN","MPIFSAQ",218,0)
 . W:$G(MNAME)'="" !,"Mother's Maiden Name: ",MNAME
"RTN","MPIFSAQ",219,0)
 . S CNT2=""
"RTN","MPIFSAQ",220,0)
 .N XX,TMP F XX=1:1:128 S TMP=$P(TTF,"~",XX) Q:TMP=""  I TMP'=CMOR3 W !?10,"Treating Facility: ",$P($$NS^XUAF4($$LKUP^XUAF4(TMP)),"^")," (",TMP,")"
"RTN","MPIFSAQ",221,0)
 .I XX>25 W !!,"There maybe more Treating Facilities, only the first 25 will be displayed."
"RTN","MPIFSAQ",222,0)
 .W !!
"RTN","MPIFSAQ",223,0)
EXIT K DA,FICN,X,Y W !! Q
"RTN","MPIFVTQ")
0^3^B37441639
"RTN","MPIFVTQ",1,0)
MPIFVTQ ;SLC/ARS-BUILD DATA TO QUERY MPI RESPONSE PROCESS (ADDPAT) ;JUL 16, 1997
"RTN","MPIFVTQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,9,17,21,23**;30 Apr 99
"RTN","MPIFVTQ",3,0)
 ;
"RTN","MPIFVTQ",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFVTQ",5,0)
 ;  ^DPT( -9 node check - #2762
"RTN","MPIFVTQ",6,0)
 ;  ^DPT( "MPI" node - #2070
"RTN","MPIFVTQ",7,0)
 ;  EXC, START, STOP ^RGHLLOG - #2796
"RTN","MPIFVTQ",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFVTQ",9,0)
 ;
"RTN","MPIFVTQ",10,0)
 Q  ;NOT an entry point
"RTN","MPIFVTQ",11,0)
 ;
"RTN","MPIFVTQ",12,0)
VTQ1(MPIIT,MPIOUT,MPIHL,MPIQRYNM,MPISND) ;
"RTN","MPIFVTQ",13,0)
 ;MPIIT=DFN in patient file.
"RTN","MPIFVTQ",14,0)
 ;MPIOUT=Array you want the VTQ/RDF put into.
"RTN","MPIFVTQ",15,0)
 ;MPIHL=Array of encoding characters and Field separator.
"RTN","MPIFVTQ",16,0)
 ;MPIQRYNM=Name of query to put into message.
"RTN","MPIFVTQ",17,0)
 ;MPISND (OPTIONAL) = item #'s separated by ; to be used to query.
"RTN","MPIFVTQ",18,0)
 ;  default is DOB;SSN;LAST NAME;FIRST NAME;SUFFIX OF NAME;SEX;DOD;
"RTN","MPIFVTQ",19,0)
 ;  POB-CITY;POB-STATE;MIDDLE NAME
"RTN","MPIFVTQ",20,0)
 ;
"RTN","MPIFVTQ",21,0)
 ;If invalid DFN, Patient Merged, if ICN already assigned, Test SSN, the VTQ query is not built and -1^'error message' returned in MPIOUT(0).
"RTN","MPIFVTQ",22,0)
 ;
"RTN","MPIFVTQ",23,0)
 ;If DOB does not contain a 7 digit date OR if name is not present, -1^Missing Required fields will be returned in MPIOUT(0).
"RTN","MPIFVTQ",24,0)
 ;
"RTN","MPIFVTQ",25,0)
 ;If patient has a date of death, the VTQ query is built with MPIOUT(0) returned with 0^Patient has date of death.  Programmer to decide if VTQ should be sent.
"RTN","MPIFVTQ",26,0)
 ;
"RTN","MPIFVTQ",27,0)
 N MPITEST,MPISSN,MPIDTH,MPINM,MPIDOB
"RTN","MPIFVTQ",28,0)
 S MPIOUT(0)=""
"RTN","MPIFVTQ",29,0)
 I '$D(MPISND) S MPISND="00122;00108.1;00108.2;00110;00740;00111;00108.4;00126.1;00126.2;00108.3"
"RTN","MPIFVTQ",30,0)
 ;validation check
"RTN","MPIFVTQ",31,0)
 I '$D(MPIHL) S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",32,0)
 I $G(MPIHL("FS"))=""!($G(MPIHL("ECH"))="") S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",33,0)
 I MPIIT="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",34,0)
 I $G(^DPT(MPIIT,-9))'="" S MPIOUT(0)="-1^Patient merged "_^DPT(MPIIT,-9) Q
"RTN","MPIFVTQ",35,0)
 I $P($G(^DPT(MPIIT,0)),"^")["MERGING" S MPIOUT(0)="-1^Patient being merged DFN= "_MPIIT Q
"RTN","MPIFVTQ",36,0)
 S MPIMPI=$G(^DPT(MPIIT,"MPI"))
"RTN","MPIFVTQ",37,0)
 S:MPIMPI'="" MPIZICN=$P(^DPT(MPIIT,"MPI"),"^",1)
"RTN","MPIFVTQ",38,0)
 I '$D(MPIFRES),$G(MPIZICN)'="" S MPIOUT(0)="-1^ICN already assigned "_MPIZICN Q
"RTN","MPIFVTQ",39,0)
 S MPITEST=$G(^DPT(MPIIT,0))
"RTN","MPIFVTQ",40,0)
 I MPITEST="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",41,0)
 S MPISSN=$P(MPITEST,"^",9)
"RTN","MPIFVTQ",42,0)
 I $E(MPISSN,1,5)="00000" S MPIOUT(0)="-1^5 zero SSN" Q
"RTN","MPIFVTQ",43,0)
 I $E($P(MPITEST,"^"),1,2)="ZZ" S MPIOUT(0)="-1^ZZ'd Patient" Q
"RTN","MPIFVTQ",44,0)
 I $E($P(MPITEST,"^"),1,3)="EEE" S MPIOUT(0)="-1^EEE Patient" Q
"RTN","MPIFVTQ",45,0)
 S MPINM=$P(MPITEST,"^") I MPINM=""!($L(MPINM)<3) S MPIOUT(0)="-1^Missing Required Field(s)" D EXC(MPIIT) Q
"RTN","MPIFVTQ",46,0)
 S MPIDOB=$P(MPITEST,"^",3) I MPIDOB'?7N S MPIOUT(0)="-1^Missing Required Field(s)" D EXC(MPIIT) Q
"RTN","MPIFVTQ",47,0)
 S MPIDTH=""
"RTN","MPIFVTQ",48,0)
 S:$G(^DPT(MPIIT,.35))'="" MPIDTH=$P(^DPT(MPIIT,.35),"^",1)
"RTN","MPIFVTQ",49,0)
 I $G(MPIDTH)'="" S MPIOUT(0)="0^Patient has Date of Death "_MPIDTH
"RTN","MPIFVTQ",50,0)
 D VTQC(MPISSN,MPIDTH,MPISND,.MPIHL,MPIQRYNM,.MPIOUT,MPIIT)
"RTN","MPIFVTQ",51,0)
 Q
"RTN","MPIFVTQ",52,0)
EXC(IEN) ;
"RTN","MPIFVTQ",53,0)
 Q:'$D(^DPT(IEN))
"RTN","MPIFVTQ",54,0)
 D LOCAL^MPIFQ0(IEN)
"RTN","MPIFVTQ",55,0)
 D START^RGHLLOG()
"RTN","MPIFVTQ",56,0)
 D EXC^RGHLLOG(209,"DFN= "_IEN_" is Missing Required Field(s)",IEN)
"RTN","MPIFVTQ",57,0)
 D STOP^RGHLLOG()
"RTN","MPIFVTQ",58,0)
 Q
"RTN","MPIFVTQ",59,0)
 ;
"RTN","MPIFVTQ",60,0)
VTQC(MPISSN,MPIDTH,MPISND,MPIHL,MPIQRYNM,MPIOUT,MPIIT) ;
"RTN","MPIFVTQ",61,0)
 N MPIPOB,MPIPOBS,MPINM,MPI2MN,MPI1NM,QUERY,MPIDOB,RDF,MPIMOD
"RTN","MPIFVTQ",62,0)
 N MPIHDTH,MPIZDOB,MPIXDOB,MPIMPI,MPIZICN,QUEDOB,MPI2NM,MPICS,MPIESC,MPIHDOB,MPIMNM,MPIMN
"RTN","MPIFVTQ",63,0)
 N MPINMSFX,MPIRS,MPISCS,MPISEX,MPIZLOC
"RTN","MPIFVTQ",64,0)
 I $G(MPIQRYNM)="" S MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFVTQ",65,0)
 S MPICS=$E(MPIHL("ECH"),1)
"RTN","MPIFVTQ",66,0)
 S MPIRS=$E(MPIHL("ECH"),2)
"RTN","MPIFVTQ",67,0)
 S MPISCS=$E(MPIHL("ECH"),4)
"RTN","MPIFVTQ",68,0)
 S MPIESC=$E(MPIHL("ECH"),3)
"RTN","MPIFVTQ",69,0)
 ;
"RTN","MPIFVTQ",70,0)
 S RDF="RDF"_MPIHL("FS")_"17"_MPIHL("FS")_"@00108.1"_MPICS_"ST"_MPICS_"20"_MPIRS_"@00122"_MPICS_"ST"_MPICS_"9"_MPIRS_"@00110"_MPICS_"ST"_MPICS_8_MPIRS_"@00756"_MPICS_"ST"_MPICS_3
"RTN","MPIFVTQ",71,0)
 S RDF=RDF_MPIRS_"@00105"_MPICS_"ST"_MPICS_19_MPIRS_"@00108.2"_MPICS_"ST"_MPICS_"20"_MPIRS_"@00169"_MPICS_"ST"_MPICS_99_MPIRS_"@00740"_MPICS_"ST"_MPICS_8
"RTN","MPIFVTQ",72,0)
 S RDF=RDF_MPIRS_"@00108.3"_MPICS_"ST"_MPICS_16_MPIRS_"@00111"_MPICS_"ST"_MPICS_1_MPIRS_"@00126.1"_MPICS_"ST"_MPICS_30_MPIRS_"@00126.2"_MPICS_"ST"_MPICS_3
"RTN","MPIFVTQ",73,0)
 S RDF=RDF_MPIRS_"@00108.5"_MPICS_"ST"_MPICS_15_MPIRS_"@00108.4"_MPICS_"ST"_MPICS_10_MPIRS_"@00109.1"_MPICS_"ST"_MPICS_20_MPIRS_"@ZEL6"_MPICS_"ST"_MPICS_9
"RTN","MPIFVTQ",74,0)
 S RDF=RDF_MPIRS_"@CASE#"_MPICS_"ST"_MPICS_69
"RTN","MPIFVTQ",75,0)
 ; ^ fields to be returned in query response
"RTN","MPIFVTQ",76,0)
 S QUERY="VTQ"_MPIHL("FS")_MPIIT_MPIHL("FS")_"T"_MPIHL("FS")_MPIQRYNM_MPIHL("FS")_"ICN"_MPIHL("FS")
"RTN","MPIFVTQ",77,0)
 ;
"RTN","MPIFVTQ",78,0)
 I MPISND["00108" S MPINM=$P(MPITEST,"^") D NAME^VAFCPID2(MPIIT,.MPINM) ;agressive name reformatting
"RTN","MPIFVTQ",79,0)
 ; ^ sending all or part of name
"RTN","MPIFVTQ",80,0)
 I MPISND["00108.1" S MPI2NM=$P(MPINM,",",1) I MPI2NM'="" S QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFVTQ",81,0)
 ; ^ sending last name
"RTN","MPIFVTQ",82,0)
 I MPISND["00122"&(MPISSN'="")&(MPISSN'["P") S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_MPISSN
"RTN","MPIFVTQ",83,0)
 ; ^ sending SSN
"RTN","MPIFVTQ",84,0)
 I MPISND["00108.2" S MPI1NM=$P(MPINM,",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFVTQ",85,0)
 ; ^ sending first name
"RTN","MPIFVTQ",86,0)
 I MPISND["00110" D
"RTN","MPIFVTQ",87,0)
 .S MPIDOB=$P(MPITEST,"^",3)
"RTN","MPIFVTQ",88,0)
 .Q:MPIDOB=""
"RTN","MPIFVTQ",89,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIDOB)
"RTN","MPIFVTQ",90,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFVTQ",91,0)
 .S MPIMOD=MPIDOB#100
"RTN","MPIFVTQ",92,0)
 .I MPIQRYNM'="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"GN"_MPICS_MPIHDOB
"RTN","MPIFVTQ",93,0)
 .I MPIQRYNM="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",94,0)
 .S MPIXDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",95,0)
 .S QUEDOB=$S(MPIMOD>0:MPIXDOB,1:MPIZDOB)
"RTN","MPIFVTQ",96,0)
 .S QUERY=QUERY_QUEDOB
"RTN","MPIFVTQ",97,0)
 ; ^ sending date of birth
"RTN","MPIFVTQ",98,0)
 I $D(MPIDTH),(MPISND["00740")&(MPIDTH'="") S MPIHDTH=$$HLDATE^HLFNC(MPIDTH),QUERY=QUERY_MPICS_"AND"_MPIRS_"@00740"_MPICS_"EQ"_MPICS_MPIHDTH
"RTN","MPIFVTQ",99,0)
 ; ^ sending date of death
"RTN","MPIFVTQ",100,0)
 I MPISND["00111" S:$G(^DPT(MPIIT,0))'="" MPISEX=$P(^DPT(MPIIT,0),"^",2) I MPISEX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00111"_MPICS_"EQ"_MPICS_MPISEX
"RTN","MPIFVTQ",101,0)
 ; ^ sending Sex
"RTN","MPIFVTQ",102,0)
 I MPISND["00108.4" S MPI1NM=$P(MPINM,",",2),MPINMSFX=$P(MPI1NM," ",3) I MPINMSFX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.4"_MPICS_"EQ"_MPICS_MPINMSFX
"RTN","MPIFVTQ",103,0)
 ; ^ sending suffix name
"RTN","MPIFVTQ",104,0)
 I MPISND["00126.1" S MPIPOB=$P(^DPT(MPIIT,0),"^",11) I MPIPOB'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.1"_MPICS_"EQ"_MPICS_MPIPOB
"RTN","MPIFVTQ",105,0)
 ; send place of birth - city
"RTN","MPIFVTQ",106,0)
 I MPISND["00126.2" S MPIPOBS=$P(^DPT(MPIIT,0),"^",12) I MPIPOBS'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.2"_MPICS_"EQ"_MPICS_$P($G(^DIC(5,+MPIPOBS,0)),"^",2)
"RTN","MPIFVTQ",107,0)
 ; send place of birth - state
"RTN","MPIFVTQ",108,0)
 I MPISND["00108.3" S MPIMN=$P($P(MPINM,",",2)," ",2) I MPIMN'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.3"_MPICS_"EQ"_MPICS_MPIMN
"RTN","MPIFVTQ",109,0)
 ; send middle name
"RTN","MPIFVTQ",110,0)
 ;
"RTN","MPIFVTQ",111,0)
 I $G(MPIOUT(0))="" S MPIOUT(0)="1^good data"
"RTN","MPIFVTQ",112,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFVTQ",113,0)
 S MPIOUT(3)=RDF
"RTN","MPIFVTQ",114,0)
 Q
"VER")
8.0^22.0
**END**
**END**
