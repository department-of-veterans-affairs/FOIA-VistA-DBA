Released MPIF*1*31 SEQ #29
Extracted from mail message
**KIDS**:MPIF*1.0*31^

**INSTALL NAME**
MPIF*1.0*31
"BLD",1807,0)
MPIF*1.0*31^MASTER PATIENT INDEX VISTA^0^3031003^y
"BLD",1807,1,0)
^^4^4^3030613^
"BLD",1807,1,1,0)
This patch adds functionality to the Local/Missing ICN Resolution 
"BLD",1807,1,2,0)
Background Job [MPIF LOC/MIS ICN RES] option and the Single Patient 
"BLD",1807,1,3,0)
Initialization to MPI [MPIF IND MPI LOAD] option to add the Treating 
"BLD",1807,1,4,0)
Facility list.
"BLD",1807,4,0)
^9.64PA^^
"BLD",1807,"KRN",0)
^9.67PA^8989.52^19
"BLD",1807,"KRN",.4,0)
.4
"BLD",1807,"KRN",.401,0)
.401
"BLD",1807,"KRN",.402,0)
.402
"BLD",1807,"KRN",.403,0)
.403
"BLD",1807,"KRN",.5,0)
.5
"BLD",1807,"KRN",.84,0)
.84
"BLD",1807,"KRN",3.6,0)
3.6
"BLD",1807,"KRN",3.8,0)
3.8
"BLD",1807,"KRN",9.2,0)
9.2
"BLD",1807,"KRN",9.8,0)
9.8
"BLD",1807,"KRN",9.8,"NM",0)
^9.68A^9^9
"BLD",1807,"KRN",9.8,"NM",1,0)
MPIFBT3^^0^B33302750
"BLD",1807,"KRN",9.8,"NM",2,0)
MPIFQ0^^0^B67191127
"BLD",1807,"KRN",9.8,"NM",3,0)
MPIFQ1^^0^B42346245
"BLD",1807,"KRN",9.8,"NM",4,0)
MPIFA24^^0^B14408336
"BLD",1807,"KRN",9.8,"NM",5,0)
MPIFA24B^^0^B6125424
"BLD",1807,"KRN",9.8,"NM",6,0)
MPIFA28^^0^B4213195
"BLD",1807,"KRN",9.8,"NM",7,0)
MPIFA31B^^0^B5928953
"BLD",1807,"KRN",9.8,"NM",8,0)
MPIFSA3^^0^B25484648
"BLD",1807,"KRN",9.8,"NM",9,0)
MPIFBT2^^0^B48374458
"BLD",1807,"KRN",9.8,"NM","B","MPIFA24",4)

"BLD",1807,"KRN",9.8,"NM","B","MPIFA24B",5)

"BLD",1807,"KRN",9.8,"NM","B","MPIFA28",6)

"BLD",1807,"KRN",9.8,"NM","B","MPIFA31B",7)

"BLD",1807,"KRN",9.8,"NM","B","MPIFBT2",9)

"BLD",1807,"KRN",9.8,"NM","B","MPIFBT3",1)

"BLD",1807,"KRN",9.8,"NM","B","MPIFQ0",2)

"BLD",1807,"KRN",9.8,"NM","B","MPIFQ1",3)

"BLD",1807,"KRN",9.8,"NM","B","MPIFSA3",8)

"BLD",1807,"KRN",19,0)
19
"BLD",1807,"KRN",19.1,0)
19.1
"BLD",1807,"KRN",101,0)
101
"BLD",1807,"KRN",409.61,0)
409.61
"BLD",1807,"KRN",409.61,"NM",0)
^9.68A^1^1
"BLD",1807,"KRN",409.61,"NM",1,0)
MPIF REAL-TIME QUERY^^0
"BLD",1807,"KRN",409.61,"NM","B","MPIF REAL-TIME QUERY",1)

"BLD",1807,"KRN",771,0)
771
"BLD",1807,"KRN",870,0)
870
"BLD",1807,"KRN",8989.51,0)
8989.51
"BLD",1807,"KRN",8989.52,0)
8989.52
"BLD",1807,"KRN",8994,0)
8994
"BLD",1807,"KRN","B",.4,.4)

"BLD",1807,"KRN","B",.401,.401)

"BLD",1807,"KRN","B",.402,.402)

"BLD",1807,"KRN","B",.403,.403)

"BLD",1807,"KRN","B",.5,.5)

"BLD",1807,"KRN","B",.84,.84)

"BLD",1807,"KRN","B",3.6,3.6)

"BLD",1807,"KRN","B",3.8,3.8)

"BLD",1807,"KRN","B",9.2,9.2)

"BLD",1807,"KRN","B",9.8,9.8)

"BLD",1807,"KRN","B",19,19)

"BLD",1807,"KRN","B",19.1,19.1)

"BLD",1807,"KRN","B",101,101)

"BLD",1807,"KRN","B",409.61,409.61)

"BLD",1807,"KRN","B",771,771)

"BLD",1807,"KRN","B",870,870)

"BLD",1807,"KRN","B",8989.51,8989.51)

"BLD",1807,"KRN","B",8989.52,8989.52)

"BLD",1807,"KRN","B",8994,8994)

"BLD",1807,"QUES",0)
^9.62^^
"BLD",1807,"REQB",0)
^9.611^1^1
"BLD",1807,"REQB",1,0)
MPIF*1.0*28^2
"BLD",1807,"REQB","B","MPIF*1.0*28",1)

"KRN",409.61,125,-1)
0^1
"KRN",409.61,125,0)
MPIF REAL-TIME QUERY^1^^80^8^16^1^1^^MPIF REAL-TIME QUERY MENU^MPI QUERY RESULTS^1^^1
"KRN",409.61,125,1)
^VALM HIDDEN ACTIONS
"KRN",409.61,125,"ARRAY")
 ^TMP("MPIFVQQ",$J)
"KRN",409.61,125,"COL",0)
^409.621^4^4
"KRN",409.61,125,"COL",1,0)
PATIENT^6^31^Patient
"KRN",409.61,125,"COL",2,0)
SSN^31^9^SSN^^0
"KRN",409.61,125,"COL",3,0)
Date of Birth^42^11^DOB
"KRN",409.61,125,"COL",4,0)
CMOR^55^20^CMOR
"KRN",409.61,125,"COL","AIDENT",0,2)

"KRN",409.61,125,"COL","B","CMOR",4)

"KRN",409.61,125,"COL","B","Date of Birth",3)

"KRN",409.61,125,"COL","B","PATIENT",1)

"KRN",409.61,125,"COL","B","SSN",2)

"KRN",409.61,125,"FNL")
D EXIT^MPIFQ1
"KRN",409.61,125,"HDR")
D HDR^MPIFQ1
"KRN",409.61,125,"INIT")
D INIT^MPIFQ1
"MBREQ")
0
"ORD",17,409.61)
409.61;17;1;;;;;;;LMDEL^XPDIA1
"ORD",17,409.61,0)
LIST TEMPLATE
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
31^3031003
"PKG",282,22,1,"PAH",1,1,0)
^^4^4^3031003
"PKG",282,22,1,"PAH",1,1,1,0)
This patch adds functionality to the Local/Missing ICN Resolution 
"PKG",282,22,1,"PAH",1,1,2,0)
Background Job [MPIF LOC/MIS ICN RES] option and the Single Patient 
"PKG",282,22,1,"PAH",1,1,3,0)
Initialization to MPI [MPIF IND MPI LOAD] option to add the Treating 
"PKG",282,22,1,"PAH",1,1,4,0)
Facility list.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","MPIFA24")
0^4^B14408336
"RTN","MPIFA24",1,0)
MPIFA24 ;BPOFO/CMC-A24 PROCESSING ROUTINE ;18 Mar 02
"RTN","MPIFA24",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,24,27,31**;30 Apr 99
"RTN","MPIFA24",3,0)
 ;
"RTN","MPIFA24",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA24",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA24",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA24",7,0)
 ;  ^DPT("AICN" - #2070
"RTN","MPIFA24",8,0)
 ;  DELETETF^VAFCTFU, FILE^VAFCTFU - #2988
"RTN","MPIFA24",9,0)
 ;
"RTN","MPIFA24",10,0)
 ;PROCESS A24 RESULTING FROM A28 ADD TO MPI MESSAGE OR FROM A40 MERGE
"RTN","MPIFA24",11,0)
A24 ;
"RTN","MPIFA24",12,0)
 N MPII,MPIJ,ARRY,SEG,CNT,ERR,SITE,MSG,DFN,IEN,LIST
"RTN","MPIFA24",13,0)
 S (CNT,ERR,FIRST)=1
"RTN","MPIFA24",14,0)
 F MPII=1:1 X HLNEXT Q:HLQUIT'>0  S MSG=HLNODE D
"RTN","MPIFA24",15,0)
 .S MPIJ=0 F  S MPIJ=$O(HLNODE(MPIJ)) Q:'MPIJ  S MSG(MPIJ)=HLNODE(MPIJ)
"RTN","MPIFA24",16,0)
 .S SEG=$E(HLNODE,1,3)
"RTN","MPIFA24",17,0)
 .I SEG="MSH" D MSH(.ARRY,.MSG) Q
"RTN","MPIFA24",18,0)
 .I SEG="EVN" D EVN(.ARRY,.MSG) Q
"RTN","MPIFA24",19,0)
 .I SEG="PID" D PID(.ARRY,.MSG,FIRST) S FIRST=2 Q
"RTN","MPIFA24",20,0)
 .I SEG="PD1" D PD1(.ARRY,.MSG) Q
"RTN","MPIFA24",21,0)
 ;
"RTN","MPIFA24",22,0)
 ;UPDATE 991.01, 991.02, 991.03
"RTN","MPIFA24",23,0)
 I $G(ARRY("ICN",2))'="" S DFN=$$GETDFN^MPIF001(ARRY("ICN",2))
"RTN","MPIFA24",24,0)
 I $G(ARRY("ICN",2))=""!(+$G(DFN)'>0) D
"RTN","MPIFA24",25,0)
 . I $G(ARRY("DFN",2))'="" S DFN=ARRY("DFN",2)
"RTN","MPIFA24",26,0)
 . I $G(ARRY("DFN",2))="" S DFN=ARRY("DFN",1)
"RTN","MPIFA24",27,0)
 S ARRY(991.03)=$$LKUP^XUAF4(ARRY(991.03))
"RTN","MPIFA24",28,0)
 I +$G(DFN)'>0 S ERR="-1^Unknown Identifier(s) ICN#"_$G(ARRY("ICN",2))_" and DFN#"_$G(ARRY("DFN",2))
"RTN","MPIFA24",29,0)
 I +$G(DFN)>0 S ERR=$$UPDATE^MPIFAPI(DFN,"ARRY",0) D
"RTN","MPIFA24",30,0)
 .;remove ALL Treating Facilities except your sites and add the CMOR
"RTN","MPIFA24",31,0)
 .D TFL^VAFCTFU1(.LIST,DFN) I $O(LIST(0)) D
"RTN","MPIFA24",32,0)
 .. N LOC,MPINODE,LOCIEN,CMOR,MPIFX,ERROR
"RTN","MPIFA24",33,0)
 .. S (CMOR,MPIFX)=0 F  S MPIFX=$O(LIST(MPIFX)) Q:'MPIFX  I $P(LIST(MPIFX),"^",5)="VAMC" D
"RTN","MPIFA24",34,0)
 ... ;get MPI node
"RTN","MPIFA24",35,0)
 ... S MPINODE=$$MPINODE^MPIFAPI(DFN),LOC=$P(LIST(MPIFX),"^"),LOCIEN=$$IEN^XUAF4(LOC)
"RTN","MPIFA24",36,0)
 ... I LOC=$P($$SITE^VASITE,"^",3) Q  ;do not delete own site
"RTN","MPIFA24",37,0)
 ... I LOCIEN=$P(MPINODE,"^",3) S CMOR=LOCIEN Q  ;do not delete CMOR site
"RTN","MPIFA24",38,0)
 ... S ERROR=$$DELETETF^VAFCTFU($P(MPINODE,"^",1),LOCIEN)
"RTN","MPIFA24",39,0)
 .. ;add CMOR site to TF list if it did not already exist
"RTN","MPIFA24",40,0)
 .. I CMOR'=0 D FILE^VAFCTFU(DFN,CMOR,1)
"RTN","MPIFA24",41,0)
 .; trigger A31 to MPI incase there have been edits since the ICN was created -- tasked off
"RTN","MPIFA24",42,0)
 .S ZTRTN="TA31^MPIFA31B",ZTDESC="A31 triggered from A24"
"RTN","MPIFA24",43,0)
 .S ZTSAVE("DFN")=DFN,ZTIO="",ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFA24",44,0)
 .D ^%ZTLOAD
"RTN","MPIFA24",45,0)
 .K ZTRTN,ZTDESC,ZTIO,ZTSAVE,ZTDTH,ZTREQ
"RTN","MPIFA24",46,0)
 ;
"RTN","MPIFA24",47,0)
 S HLA("HLA",1)="MSA"_HL("FS")_"AA"_HL("FS")_HL("MID")_HL("FS")_$S(+$G(ERR)'>0:$P(ERR,"^",2),1:"")
"RTN","MPIFA24",48,0)
 S $P(HLA("HLA",1),HL("FS"),7)="ICN="_ARRY("ICN",1)
"RTN","MPIFA24",49,0)
 D LINK^HLUTIL3(ARRY("SITE"),.LINK) S IEN=$O(LINK(0)),HLL("LINKS",1)="^"_LINK(IEN)
"RTN","MPIFA24",50,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.MPIFRSLT,"",.HL)
"RTN","MPIFA24",51,0)
 K LINK,MPIFRSLT
"RTN","MPIFA24",52,0)
 Q
"RTN","MPIFA24",53,0)
 ;
"RTN","MPIFA24",54,0)
MSH(ARY,MSG) ;processing MSH fields
"RTN","MPIFA24",55,0)
 N COMP
"RTN","MPIFA24",56,0)
 S COMP=$E(HL("ECH"),1)
"RTN","MPIFA24",57,0)
 S ARY("SITE")=$$LKUP^XUAF4($P($P(MSG,HL("FS"),4),COMP))
"RTN","MPIFA24",58,0)
 Q
"RTN","MPIFA24",59,0)
 ;
"RTN","MPIFA24",60,0)
EVN(ARY,MSG) ;processing EVN fields
"RTN","MPIFA24",61,0)
 S ARY("EVTR")=$P(MSG,HL("FS"),2) ;not currently used
"RTN","MPIFA24",62,0)
 S ARY("DLT")=$$FMDATE^HLFNC($P(MSG,HL("FS"),3))
"RTN","MPIFA24",63,0)
 Q
"RTN","MPIFA24",64,0)
 ;
"RTN","MPIFA24",65,0)
PID(ARY,MSG,FIRST) ;processing PID fields
"RTN","MPIFA24",66,0)
 N REP,PID,COMP,SUBCOMP,MPIDFN,MPISSN,ICN
"RTN","MPIFA24",67,0)
 S REP=$E(HL("ECH"),2),COMP=$E(HL("ECH"),1),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA24",68,0)
 S MPISSN="",MPIDFN=""
"RTN","MPIFA24",69,0)
 D PIDPROC^MPIFA43(.ICN,.MPISSN,.MPIDFN,.PID)
"RTN","MPIFA24",70,0)
 I FIRST=1 S ARY(991.01)=+ICN,ARY(991.02)=$P(ICN,"V",2)
"RTN","MPIFA24",71,0)
 S ARY("ICN",FIRST)=ICN
"RTN","MPIFA24",72,0)
 S ARY("SSN",FIRST)=MPISSN
"RTN","MPIFA24",73,0)
 S ARY("DFN",FIRST)=MPIDFN
"RTN","MPIFA24",74,0)
 Q
"RTN","MPIFA24",75,0)
 ;
"RTN","MPIFA24",76,0)
PD1(ARY,MSG) ;processing PD1 fields
"RTN","MPIFA24",77,0)
 N COMP
"RTN","MPIFA24",78,0)
 S COMP=$E(HL("ECH"),1)
"RTN","MPIFA24",79,0)
 S ARY(991.03)=$P($P(HLNODE,HL("FS"),4),COMP,3)
"RTN","MPIFA24",80,0)
 Q
"RTN","MPIFA24",81,0)
 ;
"RTN","MPIFA24",82,0)
PROC ;
"RTN","MPIFA24",83,0)
 N NXT,DFN
"RTN","MPIFA24",84,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA24",85,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA24",86,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA24",87,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA24",88,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA24",89,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA24",90,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA24",91,0)
 K ^XTMP("MPIFA24%"_DFN)
"RTN","MPIFA24",92,0)
 Q
"RTN","MPIFA24B")
0^5^B6125424
"RTN","MPIFA24B",1,0)
MPIFA24B ;BP/CMC-BUILD A24 ADD ME MSGS ;JULY 22, 2002
"RTN","MPIFA24B",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,28,31**;30 Apr 99
"RTN","MPIFA24B",3,0)
 ;
"RTN","MPIFA24B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA24B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA24B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA24B",7,0)
 ;
"RTN","MPIFA24B",8,0)
A24(DFN) ;BUILD AND SEND A24
"RTN","MPIFA24B",9,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID,PID2
"RTN","MPIFA24B",10,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA24B",11,0)
 S CNT=1
"RTN","MPIFA24B",12,0)
 D INIT^HLFNC2("MPIF ADT-A24 SERVER",.HL)
"RTN","MPIFA24B",13,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA24B",14,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA24B",15,0)
 S ERR="",TCNT=0
"RTN","MPIFA24B",16,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A24",.ERR)
"RTN","MPIFA24B",17,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",18,0)
 D BLDPID^VAFCQRY(DFN,1,"1,3,5,6,7,8,11,29",.PID,.HL,.ERR)
"RTN","MPIFA24B",19,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",20,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA24B",21,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",22,0)
 D BLDPID^VAFCQRY(DFN,2,"1,3,5,6,7,8,11,29",.PID2,.HL,.ERR)
"RTN","MPIFA24B",23,0)
 Q:ERR'="" ERR
"RTN","MPIFA24B",24,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA24B",25,0)
 S HLA("HLS",4)=PD1(1)
"RTN","MPIFA24B",26,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA24B",27,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA24B",28,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA24B",29,0)
 S CNT=0 F  S CNT=$O(PID2(CNT)) Q:CNT=""  D
"RTN","MPIFA24B",30,0)
 .I CNT=1 S HLA("HLS",3)=PID2(CNT)
"RTN","MPIFA24B",31,0)
 .I CNT>1 S HLA("HLS",3,CNT-1)=PID2(CNT)
"RTN","MPIFA24B",32,0)
 K HLL("LINKS")
"RTN","MPIFA24B",33,0)
 D GENERATE^HLMA("MPIF ADT-A24 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA24B",34,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA24B",35,0)
 I '+RESLT S ^XTMP("MPIFA24%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A24 message to MPI for DFN "_DFN,^XTMP("MPIFA24%"_DFN,"MPI",0)="A"
"RTN","MPIFA24B",36,0)
 K HLA,HLEID,HLL("LINKS"),COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA24B",37,0)
 Q RESLT
"RTN","MPIFA24B",38,0)
 ;
"RTN","MPIFA24B",39,0)
RT ;
"RTN","MPIFA24B",40,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA24B",41,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA24B",42,0)
 S HLL("LINKS",1)="MPIF ADT-A24 CLIENT^"_MPI
"RTN","MPIFA24B",43,0)
 Q
"RTN","MPIFA24B",44,0)
RES ;
"RTN","MPIFA24B",45,0)
 N NXT,DFN
"RTN","MPIFA24B",46,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA24B",47,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA24B",48,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA24B",49,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA24B",50,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA24B",51,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA24B",52,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA24B",53,0)
 K ^XTMP("MPIFA24%"_DFN)
"RTN","MPIFA24B",54,0)
 Q
"RTN","MPIFA28")
0^6^B4213195
"RTN","MPIFA28",1,0)
MPIFA28 ;BP/CMC-BUILD A28 ADD ME MSGS ;MARCH 4, 2002
"RTN","MPIFA28",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,31**;30 Apr 99
"RTN","MPIFA28",3,0)
 ;
"RTN","MPIFA28",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA28",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA28",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA28",7,0)
 ;
"RTN","MPIFA28",8,0)
A28(DFN) ;BUILD AND SEND A28
"RTN","MPIFA28",9,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID
"RTN","MPIFA28",10,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA28",11,0)
 S CNT=1
"RTN","MPIFA28",12,0)
 D INIT^HLFNC2("MPIF ADT-A28 SERVER",.HL)
"RTN","MPIFA28",13,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA28",14,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA28",15,0)
 S ERR="",TCNT=0
"RTN","MPIFA28",16,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A28",.ERR)
"RTN","MPIFA28",17,0)
 Q:ERR'="" ERR
"RTN","MPIFA28",18,0)
 D BLDPID^VAFCQRY(DFN,1,"1,3,5,6,7,8,11,29",.PID,.HL,.ERR)
"RTN","MPIFA28",19,0)
 Q:ERR'="" ERR
"RTN","MPIFA28",20,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA28",21,0)
 Q:ERR'="" ERR
"RTN","MPIFA28",22,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA28",23,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA28",24,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA28",25,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA28",26,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA28",27,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA28",28,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA28",29,0)
 S HLL("LINKS",1)="MPIF ADT-A28 CLIENT^"_MPI
"RTN","MPIFA28",30,0)
 D GENERATE^HLMA("MPIF ADT-A28 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA28",31,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA28",32,0)
 I +RESLT S ^XTMP("MPIFA28%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"A28 message to MPI for DFN "_DFN,^XTMP("MPIFA28%"_DFN,"MPI",0)="A"
"RTN","MPIFA28",33,0)
 K HLA,HLEID,HLL("LINKS"),HL,COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA28",34,0)
 Q RESLT
"RTN","MPIFA28",35,0)
 ;
"RTN","MPIFA28",36,0)
RES ;
"RTN","MPIFA28",37,0)
 N NXT,DFN
"RTN","MPIFA28",38,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA28",39,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA28",40,0)
 K ^XTMP("MPIFA28%"_DFN)
"RTN","MPIFA28",41,0)
 Q
"RTN","MPIFA31B")
0^7^B5928953
"RTN","MPIFA31B",1,0)
MPIFA31B ;BP/CMC-BUILD A31 MSGS ;FEB 5, 2002
"RTN","MPIFA31B",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,24,27,28,31**;30 Apr 99
"RTN","MPIFA31B",3,0)
 ;
"RTN","MPIFA31B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA31B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA31B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA31B",7,0)
 ;
"RTN","MPIFA31B",8,0)
TA31 ; Tasked entry point
"RTN","MPIFA31B",9,0)
 N TMP
"RTN","MPIFA31B",10,0)
 S TMP=$$A31(DFN)
"RTN","MPIFA31B",11,0)
 Q
"RTN","MPIFA31B",12,0)
 ;
"RTN","MPIFA31B",13,0)
A31(DFN) ;BUILD AND SEND A31
"RTN","MPIFA31B",14,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID
"RTN","MPIFA31B",15,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA31B",16,0)
 Q:$E($$GETICN^MPIF001(DFN),1,3)=$P($$SITE^VASITE(),"^",3) 0
"RTN","MPIFA31B",17,0)
 ; ^ LOCAL ICN DON'T SEND
"RTN","MPIFA31B",18,0)
 Q:+$$GETICN^MPIF001(DFN)=-1 0
"RTN","MPIFA31B",19,0)
 ; ^ NO ICN DON'T SEND
"RTN","MPIFA31B",20,0)
 S CNT=1
"RTN","MPIFA31B",21,0)
 D INIT^HLFNC2("MPIF ADT-A31 SERVER",.HL)
"RTN","MPIFA31B",22,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA31B",23,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA31B",24,0)
 S ERR="",TCNT=0
"RTN","MPIFA31B",25,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A31",.ERR)
"RTN","MPIFA31B",26,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",27,0)
 D BLDPID^VAFCQRY(DFN,1,"1,3,5,6,7,8,11,29",.PID,.HL,.ERR)
"RTN","MPIFA31B",28,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",29,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA31B",30,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",31,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA31B",32,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA31B",33,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA31B",34,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA31B",35,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA31B",36,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA31B",37,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA31B",38,0)
 S HLL("LINKS",1)="MPIF ADT-A31 CLIENT^"_MPI
"RTN","MPIFA31B",39,0)
 D GENERATE^HLMA("MPIF ADT-A31 SERVER","LM",1,.MPIFRSLT,"","")
"RTN","MPIFA31B",40,0)
 S RESLT=$S(+MPIFRSLT:MPIFRSLT,1:$P(MPIFRSLT,"^",3))
"RTN","MPIFA31B",41,0)
 S ^XTMP("MPIFA31%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"MPIA31 msg to MPI for DFN "_DFN
"RTN","MPIFA31B",42,0)
 I '+RESLT S ^XTMP("MPIFA31%"_DFN,"MPI",0)="A"
"RTN","MPIFA31B",43,0)
 K HLA,HLEID,HLL("LINKS"),COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),MPIFRSLT
"RTN","MPIFA31B",44,0)
 Q RESLT
"RTN","MPIFA31B",45,0)
 ;
"RTN","MPIFA31B",46,0)
RES ;
"RTN","MPIFA31B",47,0)
 N NXT
"RTN","MPIFA31B",48,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA31B",49,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA31B",50,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA31B",51,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA31B",52,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA31B",53,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA31B",54,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA31B",55,0)
 K ^XTMP("MPIFA31%"_DFN)
"RTN","MPIFA31B",56,0)
 Q
"RTN","MPIFBT2")
0^9^B48374458
"RTN","MPIFBT2",1,0)
MPIFBT2 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT2",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,10,17,21,31**;30 Apr 99
"RTN","MPIFBT2",3,0)
 ;
"RTN","MPIFBT2",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFBT2",5,0)
 ;   ^DGCN(391.91 - #2751
"RTN","MPIFBT2",6,0)
 ;   EXC, START, STOP ^RGHLLOG - #2796
"RTN","MPIFBT2",7,0)
 ;   XMITFLAG^VAFCDD01 - #3493
"RTN","MPIFBT2",8,0)
 ;   $$PIVNW^VAFHPIVT - #3494
"RTN","MPIFBT2",9,0)
 ;
"RTN","MPIFBT2",10,0)
ADDPAT ;Called when response from MPI is received for messages sent.
"RTN","MPIFBT2",11,0)
 K ^XTMP($J,"MPIF") D NOW^%DTC S ST=%,X1=ST,X2=20 D C^%DTC
"RTN","MPIFBT2",12,0)
 S STP=X,^XTMP($J,"MPIF","MPIIN",0)=STP_"^"_ST_"^"_"MPI BATCH JOB"
"RTN","MPIFBT2",13,0)
 K %,X,Y,X1,X2,ST,STP N RGLOG,MPIMSG S MPIMSG=HLMTIEN
"RTN","MPIFBT2",14,0)
 D START^RGHLLOG(HLMTIEN,"","ADDPAT^MPIFBT2")
"RTN","MPIFBT2",15,0)
 D PREPMSG,PROCESS(MPIMSG),STOP^RGHLLOG(0)
"RTN","MPIFBT2",16,0)
 K ACK1,ACK2,ACK3,ACK4,HDR,MPICKG,MPIIN,MPIIPPF,MPIIT,MPINUM,MPIPPF,DA
"RTN","MPIFBT2",17,0)
 K CNTR,COM,ENC,ESC,LOCAL,MSHDR,PATID,REP,SCOM,SEP,SITE,MPIDTH,VISTDTH,MPITMP,MPICNTR,MPIFOK,^XTMP($J,"MPIF"),DGSENFLG
"RTN","MPIFBT2",18,0)
 Q
"RTN","MPIFBT2",19,0)
PREPMSG ;prepare for response
"RTN","MPIFBT2",20,0)
 N I,J,X F I=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFBT2",21,0)
 .S ^XTMP($J,"MPIF","MPIIN",I)=HLNODE,J=0
"RTN","MPIFBT2",22,0)
 .F  S J=$O(HLNODE(J))  Q:'J  S ^XTMP($J,"MPIF","MPIIN",I,J)=HLNODE(J)
"RTN","MPIFBT2",23,0)
 Q
"RTN","MPIFBT2",24,0)
PROCESS(MPIMSG) ;Process mesage out of array
"RTN","MPIFBT2",25,0)
 N HDR,MPICNTR S MPICNTR=1,HDR=^XTMP($J,"MPIF","MPIIN",1) ;check hdr here
"RTN","MPIFBT2",26,0)
 D CHDR(HDR,.SEP,MPICNTR,MPIMSG)
"RTN","MPIFBT2",27,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",28,0)
 F  S MPICNTR=$O(^XTMP($J,"MPIF","MPIIN",MPICNTR)) Q:'MPICNTR  D LOOPS(.MPICNTR,SEP,MPIMSG)
"RTN","MPIFBT2",29,0)
 Q
"RTN","MPIFBT2",30,0)
LOOPS(CNTR,SEP,MPIMSG) ;Loop in the batch
"RTN","MPIFBT2",31,0)
 K ^XTMP($J,"MPIF","MSHERR") N MSHDR,ACK1,ACK2,ACK3,ACK4,ACK5,PATID,LOCAL,MPITMP,LICN
"RTN","MPIFBT2",32,0)
 S MSHDR=^XTMP($J,"MPIF","MPIIN",+CNTR)
"RTN","MPIFBT2",33,0)
 D CHKMSH(MSHDR,.SITE,SEP,MPIMSG)
"RTN","MPIFBT2",34,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",35,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",36,0)
 S ACK1=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",37,0)
 I $P(ACK1,SEP)'="MSA" S ^XTMP($J,"MPIF","MSHERR")="NOT AN MSA SEGMENT" D EXC^RGHLLOG(203,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",38,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",39,0)
 I ACK1["AR" S ^XTMP($J,"MPIF","MSHERR")="APP REJECT ERROR" D EXC^RGHLLOG(207,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",40,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",41,0)
 I ACK1["AE" S ^XTMP($J,"MPIF","MSHERR")="APP ERROR" D EXC^RGHLLOG(208,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",42,0)
 ;ACK1 must be an AA
"RTN","MPIFBT2",43,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",44,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",45,0)
 S ACK2=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",46,0)
 I $P(ACK2,SEP)'="QAK" S ^XTMP($J,"MPIF","MSHERR")="NOT A QAK SEGMENT" D EXC^RGHLLOG(202,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".")
"RTN","MPIFBT2",47,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",48,0)
 I ACK2["NO DATA" D
"RTN","MPIFBT2",49,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NO DATA in MPI "
"RTN","MPIFBT2",50,0)
 .I ACK2["POTENTIAL MATCHES" D
"RTN","MPIFBT2",51,0)
 ..D EXC^RGHLLOG(218,"For Patient DFN="_$P(ACK2,SEP,2)_".  Use Single Patient Initialization to MPI option to manually process.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",52,0)
 ..I $D(^DPT($P(ACK2,SEP,2),0)) S LICN=$$ICNLC^MPIF001($P(ACK2,SEP,2))
"RTN","MPIFBT2",53,0)
 ..; ^ create a local ICN
"RTN","MPIFBT2",54,0)
 .I ACK2'["POTENTIAL MATCHES" D
"RTN","MPIFBT2",55,0)
 ..D EXC^RGHLLOG(209,"For Patient DFN="_$P(ACK2,SEP,2)_".  Need required fields before patient can be processed again the MPI.",$P(ACK2,SEP,2))
"RTN","MPIFBT2",56,0)
 ..I $D(^DPT($P(ACK2,SEP,2),0)) S LICN=$$ICNLC^MPIF001($P(ACK2,SEP,2))
"RTN","MPIFBT2",57,0)
 ..; ^ create a local ICN
"RTN","MPIFBT2",58,0)
 .N TACK,TCNTR S TCNTR=CNTR,CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),TACK=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",59,0)
 .I $P(TACK,SEP)="MSH" S CNTR=TCNTR
"RTN","MPIFBT2",60,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",61,0)
 S PATID=$P(ACK2,SEP,2),LOCAL=$G(^DPT(PATID,0)) ;Verify patient is in database
"RTN","MPIFBT2",62,0)
 I LOCAL']"" S ^XTMP($J,"MPIF","MSHERR")="PATIENT DFN NOT IN DATABASE- BAD " D EXC^RGHLLOG(210,"Around line number "_(CNTR*2)_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT2",63,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",64,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",65,0)
 S ACK3=^XTMP($J,"MPIF","MPIIN",CNTR) ;RDF DEFINITION SEGMENT NO-OP
"RTN","MPIFBT2",66,0)
 I $P(ACK3,SEP)'="RDF" S ^XTMP($J,"MPIF","MSHERR")="NOT RDF SEGMENT" D EXC^RGHLLOG(204,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".",PATID)
"RTN","MPIFBT2",67,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",68,0)
 S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:CNTR'>0
"RTN","MPIFBT2",69,0)
 S RDTSEQ=1
"RTN","MPIFBT2",70,0)
 S ACK4(RDTSEQ)=^XTMP($J,"MPIF","MPIIN",CNTR)
"RTN","MPIFBT2",71,0)
 I $P(ACK4(RDTSEQ),SEP)'="RDT" S ^XTMP($J,"MPIF","MSHERR")="NOT RDT SEGMENT" D EXC^RGHLLOG(205,"Around line number "_(CNTR*2)_" of message "_MPIMSG_".",PATID)
"RTN","MPIFBT2",72,0)
 ;
"RTN","MPIFBT2",73,0)
 N RDTSQ S RDTSQ=0
"RTN","MPIFBT2",74,0)
 F  S RDTSQ=$O(^XTMP($J,"MPIF","MPIIN",CNTR,RDTSQ)) Q:'RDTSQ  D
"RTN","MPIFBT2",75,0)
 . S ACK4(RDTSEQ+1)=^XTMP($J,"MPIF","MPIIN",CNTR,RDTSQ),RDTSEQ=RDTSEQ+1
"RTN","MPIFBT2",76,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",77,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",78,0)
 I MPITMP'>0 S:$E($G(^XTMP($J,"MPIF","MPIIN",MPITMP)),1,3)="BTS" CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",79,0)
 Q:CNTR'>0
"RTN","MPIFBT2",80,0)
 D VFYRDT^MPIFBT3(.ACK4,SEP,CNTR,PATID,SITE,MPIMSG)
"RTN","MPIFBT2",81,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR))
"RTN","MPIFBT2",82,0)
 Q:MPITMP'>0
"RTN","MPIFBT2",83,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP)
"RTN","MPIFBT2",84,0)
 I $P(ACK5,SEP)="RDT" D MULT^MPIFBT3(.CNTR,ACK5,SEP,MPIMSG,PATID)
"RTN","MPIFBT2",85,0)
 K RDTSEQ
"RTN","MPIFBT2",86,0)
 Q
"RTN","MPIFBT2",87,0)
TFLIST(TFSITE,PATID) ;adding TFSITE site for patient to Treating Facility List (#391.91)
"RTN","MPIFBT2",88,0)
 I $G(TFSITE)="" S ^XTMP($J,"MPIF","MSHERR")="Treating Facility = null" D EXC^RGHLLOG(212,"DFN = "_PATID_" Treating Facility = Null",PATID) Q
"RTN","MPIFBT2",89,0)
 S TFSITE=$$LKUP^XUAF4(TFSITE)
"RTN","MPIFBT2",90,0)
 Q:+TFSITE'>0
"RTN","MPIFBT2",91,0)
 Q:$D(^DGCN(391.91,"APAT",PATID,TFSITE))
"RTN","MPIFBT2",92,0)
 K DD,DO N DIC,X,Y L +^DGCN(391.91,0):60
"RTN","MPIFBT2",93,0)
 I '$T D EXC^RGHLLOG(212,"Unable to Lock Treating Facility file to add patient DFN="_PATID_" Facility= "_TFSITE,PATID) Q
"RTN","MPIFBT2",94,0)
 S DIC="^DGCN(391.91,",DIC("DR")=".02///`"_TFSITE,X=PATID,DIC(0)="LQZ"
"RTN","MPIFBT2",95,0)
 I $D(^DGCN(391.91,"APAT",PATID,TFSITE)) L -^DGCN(391.91,0) Q
"RTN","MPIFBT2",96,0)
 D FILE^DICN L -^DGCN(391.91,0)
"RTN","MPIFBT2",97,0)
 I +Y=-1,'$D(^DGCN(391.91,"APAT",PATID,TFSITE)) S ^XTMP($J,"MPIF","MSHERR")="Treating Facility Add Failed" D EXC^RGHLLOG(212,"DFN= "_PATID_"  Treating Facility= "_TFSITE_"  failed when adding an entry to the Treating Facility file.",PATID)
"RTN","MPIFBT2",98,0)
 K DD,DO,DIC,X,Y
"RTN","MPIFBT2",99,0)
 Q
"RTN","MPIFBT2",100,0)
TFUPDT(PATID,MPIMSG,CNTR) ;treating facility update message to pivot file
"RTN","MPIFBT2",101,0)
 N ERR,TRANS,EVDT,X,Y,%
"RTN","MPIFBT2",102,0)
 D NOW^%DTC S EVDT=% K %,X,Y
"RTN","MPIFBT2",103,0)
 S ERR=$$PIVNW^VAFHPIVT(PATID,EVDT,5,PATID_";DPT(")
"RTN","MPIFBT2",104,0)
 I +ERR<1 D EXC^RGHLLOG(212,"When trying to add Patient (DFN)"_PATID_"   message# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT2",105,0)
 Q:+ERR<1
"RTN","MPIFBT2",106,0)
 D XMITFLAG^VAFCDD01("",+ERR)
"RTN","MPIFBT2",107,0)
 Q
"RTN","MPIFBT2",108,0)
CHDR(HDR,SEP,CNTR,MPIMSG) ;Only process Batch message responses
"RTN","MPIFBT2",109,0)
 I $P(HDR,"^")'="BHS" S ^XTMP($J,"MPIF","MSHERR")="BHS SEGMENT MISSING" D EXC^RGHLLOG(200,"for message "_MPIMSG_".  The segment contains "_HDR)
"RTN","MPIFBT2",110,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",111,0)
 S SEP=$G(HL("FS")) ;get field sep, and encoding characters
"RTN","MPIFBT2",112,0)
 I SEP="" S ^XTMP($J,"MPIF","MSHERR")="Missing field seperator" D EXC^RGHLLOG(200,"Missing field seperator")
"RTN","MPIFBT2",113,0)
 Q
"RTN","MPIFBT2",114,0)
CHKMSH(MSHDR,SITE,SEP,MPIMSG) ;VERIFY MSH
"RTN","MPIFBT2",115,0)
 I $P(MSHDR,SEP)="BTS" S ^XTMP($J,"MPIF","MSHERR")="BTS FOUND" Q
"RTN","MPIFBT2",116,0)
 S:$P(MSHDR,SEP)'="MSH" ^XTMP($J,"MPIF","MSHERR")="NOT MSH HEADER   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",117,0)
 S:$E(MSHDR,4)'=SEP ^XTMP($J,"MPIF","MSHERR")="FIELD SEPARATOR MISMATCH   MESSAGE# "_MPIMSG
"RTN","MPIFBT2",118,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(201,$G(^XTMP($J,"MPIF","MSHERR")))
"RTN","MPIFBT2",119,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT2",120,0)
 S SITE=$P(MSHDR,SEP,6)
"RTN","MPIFBT2",121,0)
 I SITE="" S ^XTMP($J,"MPIF","MSHERR")="SITE NOT IN MSH"
"RTN","MPIFBT2",122,0)
 I $D(^XTMP($J,"MPIF","MSHERR")) D EXC^RGHLLOG(8,"MSH Doesn't Have SITE as 6th piece.   MESSAGE# "_MPIMSG)
"RTN","MPIFBT2",123,0)
 Q
"RTN","MPIFBT3")
0^1^B33302750
"RTN","MPIFBT3",1,0)
MPIFBT3 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,10,17,21,24,28,31**;30 Apr 99
"RTN","MPIFBT3",3,0)
 ;
"RTN","MPIFBT3",4,0)
 ; Intergration Agreements Utilized:
"RTN","MPIFBT3",5,0)
 ;  ^DPT("AICN", ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFBT3",6,0)
 ;  EXC^RGHLLOG - #2796
"RTN","MPIFBT3",7,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFBT3",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFBT3",9,0)
 ;
"RTN","MPIFBT3",10,0)
MULT(CNTR,ACK5,SEP,MPIMSG,PATID) ;multiple RDT segments
"RTN","MPIFBT3",11,0)
 N NEXTTF,MPITMP S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),NEXTTF=$P(ACK5,SEP,8)
"RTN","MPIFBT3",12,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:MPITMP'>0
"RTN","MPIFBT3",13,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP) K NEXTTF,MPITMP
"RTN","MPIFBT3",14,0)
 I $P(ACK5,SEP)="RDT" D MULT(.CNTR,ACK5,SEP,MPIMSG,PATID) ; ^ add to treating facility list.  If not RDT continue on processing next msh
"RTN","MPIFBT3",15,0)
 Q
"RTN","MPIFBT3",16,0)
VFYRDT(ACK4,SEP,CNTR,PATID,SITE,MPIMSG) ;Here is the meat
"RTN","MPIFBT3",17,0)
 N MPIY,IEN,MPICMOR,MPICOMP S DGSENFLG=""
"RTN","MPIFBT3",18,0)
 S MPICOMP=$E(HL("ECH"),1)
"RTN","MPIFBT3",19,0)
 D RDT^MPIFSA3(.CNTR,.HL,.ACK4)
"RTN","MPIFBT3",20,0)
 D FINDHM(PATID,SEP,.MPIY,MPIMSG,CNTR)
"RTN","MPIFBT3",21,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",22,0)
 N MPINUM,MPICKG,MPIIT,DR,DIE,X,MPIIPPF,MPIPPF,RESLT
"RTN","MPIFBT3",23,0)
 S MPINUM=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",6),MPICKG=$P(MPINUM,"V",2),MPINUM=$P(MPINUM,"V",1)
"RTN","MPIFBT3",24,0)
 ;check if ICN already in use in Patient file
"RTN","MPIFBT3",25,0)
 I $D(^DPT("AICN",MPINUM)) D
"RTN","MPIFBT3",26,0)
 .Q:PATID=$O(^DPT("AICN",MPINUM,""))   ; same patient
"RTN","MPIFBT3",27,0)
 .S ^XTMP($J,"MPIF","MSHERR")="ICN already in use"
"RTN","MPIFBT3",28,0)
 .D EXC^RGHLLOG(227,"Patient dfn "_PATID_" returned ICN "_MPINUM_" that is already in use for Patient dfn "_$O(^DPT("AICN",MPINUM,""))_" Checkout pair to determine if a Duplicate.",PATID)
"RTN","MPIFBT3",29,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",30,0)
 S DIE="^DPT(",DA=$P(MPIY,"^",1),MPIIT=$P(MPIY,"^",1),DR="991.01////^S X=MPINUM;991.02////^S X=MPICKG" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",31,0)
 S IEN=$P(MPIY,"^") ; check if need to kill Local/MISSING ICN field
"RTN","MPIFBT3",32,0)
 I $D(^DPT("AMPIMIS",IEN)) K ^DPT("AMPIMIS",IEN)
"RTN","MPIFBT3",33,0)
 I $D(^DPT("AICNL",1,IEN)) D
"RTN","MPIFBT3",34,0)
 .S DIE="^DPT(",DA=IEN,DR="991.04///@" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",35,0)
 S MPIIPPF=""
"RTN","MPIFBT3",36,0)
 S MPIPPF=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",5),MPICMOR=$$LKUP^XUAF4(MPIPPF)
"RTN","MPIFBT3",37,0)
 I MPICMOR'="" S MPIIPPF=$$CHANGE^MPIF001(MPIIT,MPICMOR)
"RTN","MPIFBT3",38,0)
 I +MPIIPPF<0 D EXC^RGHLLOG(211,"Around line number "_(CNTR*2)_"  CMOR= "_MPIPPF_" DFN= "_MPIIT_"  MESSAGE# "_MPIMSG,MPIIT)
"RTN","MPIFBT3",39,0)
 Q:+MPIIPPF<0
"RTN","MPIFBT3",40,0)
 I $D(^TMP("MPIFVQQ",$J,CNTR,"TF")) D
"RTN","MPIFBT3",41,0)
 . N MPINTFI,MPINTF,TFSTRG,TFIEN
"RTN","MPIFBT3",42,0)
 . S MPINTFI=0,MPINTF="",TFIEN="",TFSTRG=""
"RTN","MPIFBT3",43,0)
 . F  S MPINTFI=$O(^TMP("MPIFVQQ",$J,CNTR,"TF",MPINTFI)) Q:'MPINTFI  D
"RTN","MPIFBT3",44,0)
 .. S MPINTF=^TMP("MPIFVQQ",$J,CNTR,"TF",MPINTFI)
"RTN","MPIFBT3",45,0)
 .. S TFIEN=$$IEN^XUAF4($P(MPINTF,MPICOMP,1))
"RTN","MPIFBT3",46,0)
 .. Q:'TFIEN
"RTN","MPIFBT3",47,0)
 .. S TFSTRG=TFIEN_"^"_$$FMDATE^HLFNC($P(MPINTF,MPICOMP,2))_"^"_$P(MPINTF,MPICOMP,3)
"RTN","MPIFBT3",48,0)
 .. D FILE^VAFCTFU(PATID,TFSTRG,1)
"RTN","MPIFBT3",49,0)
 S RESLT=$$A24^MPIFA24B(PATID)
"RTN","MPIFBT3",50,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_PATID,PATID)
"RTN","MPIFBT3",51,0)
 K RESLT N RESLT
"RTN","MPIFBT3",52,0)
 S RESLT=$$A31^MPIFA31B(PATID)
"RTN","MPIFBT3",53,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A31 for DFN= "_PATID,PATID)
"RTN","MPIFBT3",54,0)
 K ^TMP("MPIFVQQ",$J)
"RTN","MPIFBT3",55,0)
 Q
"RTN","MPIFBT3",56,0)
FINDHM(PATID,SEP,MPIY,MPIMSG,CNTR) ;LOOKUP
"RTN","MPIFBT3",57,0)
 N DIC,X,Y,NM,YTMP,MPIN
"RTN","MPIFBT3",58,0)
 Q:'$D(^TMP("MPIFVQQ",$J,CNTR,"DATA"))
"RTN","MPIFBT3",59,0)
 ;added I to DIC(0) allow processing of sensative patients when DUZ=0
"RTN","MPIFBT3",60,0)
 S DGSENFLG="",DIC="^DPT(",DIC(0)="OISZ",X="`"_PATID D ^DIC K DIC
"RTN","MPIFBT3",61,0)
 S YTMP=Y
"RTN","MPIFBT3",62,0)
 I YTMP=-1 S ^XTMP($J,"MPIF","MSHERR")="LOOKUP FAILED" D EXC^RGHLLOG(210,"SSN = "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",63,0)
 Q:YTMP=-1
"RTN","MPIFBT3",64,0)
 S NM=$P(Y(0),"^"),YTMP=$G(Y(0)),MPIY=Y ; check if ICN already populated
"RTN","MPIFBT3",65,0)
 N ICN S ICN=$$GETICN^MPIF001(PATID)
"RTN","MPIFBT3",66,0)
 I +ICN'=-1,$E(+ICN,1,3)'=$P($$SITE^VASITE,"^",3) S ^XTMP($J,"MPIF","MSHERR")="Patient "_PATID_" Already has an ICN"
"RTN","MPIFBT3",67,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",68,0)
 S Y(0)=$G(YTMP)
"RTN","MPIFBT3",69,0)
 Q:$P(Y(0),"^",9)["P"&($P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)="")
"RTN","MPIFBT3",70,0)
 I $P(Y(0),"^",9)'=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3) D
"RTN","MPIFBT3",71,0)
 .S ^XTMP($J,"MPIF","MSHERR")="SSN MISMATCH"
"RTN","MPIFBT3",72,0)
 .D EXC^RGHLLOG(213,"SSN on File = "_$P(Y(0),"^",9)_" SSN in Message = "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",3)_"    MESSAGE # "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",73,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ; create local ICN
"RTN","MPIFBT3",74,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",75,0)
 D NAME^VAFCPID2(0,.NM,0) ; reformat name in DG 149 fashion for comparison
"RTN","MPIFBT3",76,0)
 S MPIN=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",2)_","_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",7)
"RTN","MPIFBT3",77,0)
 I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",10)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",10)
"RTN","MPIFBT3",78,0)
 I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",15)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",15)
"RTN","MPIFBT3",79,0)
 I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",14)'="" S MPIN=MPIN_" "_$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",14)
"RTN","MPIFBT3",80,0)
 D NAME^VAFCPID2(0,.MPIN,0)
"RTN","MPIFBT3",81,0)
 I NM'=MPIN D
"RTN","MPIFBT3",82,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NAME MISMATCH"
"RTN","MPIFBT3",83,0)
 .D EXC^RGHLLOG(214,"Name on File = "_$P(Y(0),"^")_"  Name in Message = "_MPIN_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",84,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ;create local ICN
"RTN","MPIFBT3",85,0)
 ;check to see if MPI has Date of Death or if VistA has DOD
"RTN","MPIFBT3",86,0)
 N MPIDTH,VISTDTH K %DT
"RTN","MPIFBT3",87,0)
 I $P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",9)'="" S X=$P(^TMP("MPIFVQQ",$J,CNTR,"DATA"),"^",9) D ^%DT S MPIDTH=Y
"RTN","MPIFBT3",88,0)
 I $D(^DPT(PATID,.35)),$P($G(^DPT(PATID,.35)),"^")'="" S VISTDTH=$P($G(^DPT(PATID,.35)),"^")\1
"RTN","MPIFBT3",89,0)
 I $D(MPIDTH)&$D(VISTDTH),MPIDTH'=VISTDTH D
"RTN","MPIFBT3",90,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y,Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",91,0)
 .D EXC^RGHLLOG(217,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",92,0)
 ; ^ BOTH HAVE DOD BUT THEY DON'T MATCH
"RTN","MPIFBT3",93,0)
 I '$D(MPIDTH)&($D(VISTDTH)) D
"RTN","MPIFBT3",94,0)
 .N Y S Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",95,0)
 .D EXC^RGHLLOG(216,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",96,0)
 ; ^ VISTA HAS DOD BUT MPI DOESN'T
"RTN","MPIFBT3",97,0)
 I $D(MPIDTH)&('$D(VISTDTH)) D
"RTN","MPIFBT3",98,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y
"RTN","MPIFBT3",99,0)
 .D EXC^RGHLLOG(215,"Around line "_(CNTR*2)_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",100,0)
 ; ^ MPI HAS DOD BUT VISTA DOESN'T
"RTN","MPIFBT3",101,0)
 Q
"RTN","MPIFQ0")
0^2^B67191127
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,14,13,16,17,21,20,24,26,28,31**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
 ; Integration Agreements utilized:
"RTN","MPIFQ0",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFQ0",6,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFQ0",7,0)
 ;  $$SEND2^VAFCUTL1- #2779
"RTN","MPIFQ0",8,0)
 ;  $$EN^HLCSAS - #3471
"RTN","MPIFQ0",9,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFQ0",10,0)
 ;
"RTN","MPIFQ0",11,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",12,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",13,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",14,0)
 S MPIFRES="",MPIFINT="",DIC="^DPT(",DIC(0)="AEMQ" D ^DIC
"RTN","MPIFQ0",15,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W:'$D(MPIFRPC) !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",16,0)
 S DFN=+Y,HLP("ACKTIME")=300
"RTN","MPIFQ0",17,0)
 W:'$D(MPIFRPC) !
"RTN","MPIFQ0",18,0)
CIRNEXC ; Exception Entry Point
"RTN","MPIFQ0",19,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W:'$D(MPIFRPC) !,"Patient already has an ICN" G END
"RTN","MPIFQ0",20,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",21,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",22,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",23,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N W:'$D(MPIFRPC) !,"Patient is missing Date of Birth -- Required Field" D LOCAL^MPIFQ3(DFN) G END
"RTN","MPIFQ0",24,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",25,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W:'$D(MPIFRPC) !,"Patient already has an ICN" G END
"RTN","MPIFQ0",26,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 W:'$D(MPIFRPC) !,"Patient should not be sent to the MPI -- SSN has 5 leading 0s or name has been ZZ'd" G END
"RTN","MPIFQ0",27,0)
 I $E(LOCDATA(2,DFN,.01),1,3)="EEE" W:'$D(MPIFRPC) !,"Patient should not be sent to the MPI -- EEE patient -- update to actual Patient name" G END
"RTN","MPIFQ0",28,0)
 S HLP("ACKTIME")=300,MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",29,0)
 G JUMP
"RTN","MPIFQ0",30,0)
VTQ G:$G(DFN)']"" END
"RTN","MPIFQ0",31,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",32,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",33,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",34,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S MPIFRTN="MISSING DOB" D EXC^MPIFVTQ(DFN) G END
"RTN","MPIFQ0",35,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",36,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",37,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S MPIFRTN="TEST" G END
"RTN","MPIFQ0",38,0)
JUMP N TIME,% D NOW^%DTC S TIME=%
"RTN","MPIFQ0",39,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,MPIDC,SSN
"RTN","MPIFQ0",40,0)
 I $G(HLP("ACKTIME"))="" S HLP("ACKTIME")=30 ;If the HLP("ACKTIME") is not already set for the D/C
"RTN","MPIFQ0",41,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",42,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",43,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",44,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM,"00108.1;00108.2;00110;00122")
"RTN","MPIFQ0",45,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",46,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0)),MPIFRTN="CONTINUE"
"RTN","MPIFQ0",47,0)
 ;Create MSH
"RTN","MPIFQ0",48,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1,HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",49,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",50,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",51,0)
 I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Attempting to connect to the Master Patient Index in Austin...",!,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFQ0",52,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFQ0",53,0)
 K HLP("ACKTIME") ;kill the HLP array set for the ack timeout
"RTN","MPIFQ0",54,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",55,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",56,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Could not connect to MPI or Timed Out, assigning local ICN (if not already assigned)..."
"RTN","MPIFQ0",57,0)
 .D LOCAL^MPIFQ3(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",58,0)
 K ^TMP("MPIFVQQ",$J),^TMP("MPIFQ0",$J) ;array data is parsed into for display in LM
"RTN","MPIFQ0",59,0)
INIPARS ;
"RTN","MPIFQ0",60,0)
 N SEG,INDEX,SKIP,CHECK,AL,TTF2,TFLL,TF,TF2,MPIREP,MPICOMP
"RTN","MPIFQ0",61,0)
 S INDEX=0 K CHECK
"RTN","MPIFQ0",62,0)
LOOP1 ;
"RTN","MPIFQ0",63,0)
 ;process in ADT type messages
"RTN","MPIFQ0",64,0)
 N MPIX S MPIX=0 N REP,SG,MSG,MPIQUIT,MPINODE
"RTN","MPIFQ0",65,0)
 S MPIQUIT=0
"RTN","MPIFQ0",66,0)
 F MPIX=0:1 X "D LOOP2" D  K MPINODE,MSG Q:MPIQUIT'>0
"RTN","MPIFQ0",67,0)
 . I $D(MPINODE(1)) S SG=$E(MPINODE(1),1,3) S MSG(1)=MPINODE(1) D
"RTN","MPIFQ0",68,0)
 .. S MPIJ=1 F  S MPIJ=$O(MPINODE(MPIJ)) Q:'MPIJ  S MSG(MPIJ)=MPINODE(MPIJ)
"RTN","MPIFQ0",69,0)
 .. D:SG?2A1(1A,1N) @SG
"RTN","MPIFQ0",70,0)
DECIDE ;If no data in ^TMP that means the patient was not found in the MPI w/VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",71,0)
 I '$D(^TMP("MPIFVQQ",$J)) D  G EXIT
"RTN","MPIFQ0",72,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",73,0)
 .D A28^MPIFQ3(DFN) S MPIFRTN="DID A28"
"RTN","MPIFQ0",74,0)
 ;If INDEX=1 it means we got 1 match check SSN see if definitely same pt
"RTN","MPIFQ0",75,0)
 I (INDEX=1)&(TSSN=SSN) D  G EXIT
"RTN","MPIFQ0",76,0)
 .N CCMOR,ICN,DATA,TICN,SNM,SNM2,IEN
"RTN","MPIFQ0",77,0)
 .S DATA=^TMP("MPIFVQQ",$J,INDEX,"DATA"),CMOR=$P(DATA,"^",5),ICN=$P(DATA,"^",6),IEN=$$IEN^XUAF4(CMOR)
"RTN","MPIFQ0",78,0)
 .D START^RGHLLOG(0)
"RTN","MPIFQ0",79,0)
 .S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",80,0)
 .I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ0",81,0)
 .I TICN>0&(DFN'=TICN)
"RTN","MPIFQ0",82,0)
 .; CHECK IF NAME IS SAME - IF NOT POTENTIAL MATCH EXCEPTION
"RTN","MPIFQ0",83,0)
 .S SNM=LOCDATA(2,DFN,.01) D NAME^VAFCPID2(DFN,.SNM,0) ;reformat name to DG 149 standard
"RTN","MPIFQ0",84,0)
 .S SNM2=$P(DATA,"^") D NAME^VAFCPID2(0,.SNM2,0) S $P(DATA,"^")=SNM2
"RTN","MPIFQ0",85,0)
 .I $P(DATA,"^")'=SNM D  Q
"RTN","MPIFQ0",86,0)
 ..I $D(MPIFINT) D START^MPIFQ1(INDEX) Q
"RTN","MPIFQ0",87,0)
 ..I '$D(MPIFINT) D LOC2^MPIFQ3(DFN) Q
"RTN","MPIFQ0",88,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" on MPI",!,"  Updating ICN to "_+ICN_" and CMOR to "_$P($$NS^XUAF4(IEN),"^")_" ("_CMOR_")  - just a minute..."
"RTN","MPIFQ0",89,0)
 .D STOP^RGHLLOG(0),UPDATE(DFN,ICN,CMOR) S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",90,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",91,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",92,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",93,0)
 .D START^RGHLLOG(0),EXC^RGHLLOG(218,"For Patient DFN="_DFN_".  Use Single Patient Initialization to MPI option to manually process.",DFN),STOP^RGHLLOG(0)
"RTN","MPIFQ0",94,0)
 .D LOCAL^MPIFQ3(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",95,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",96,0)
EXIT I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",97,0)
 K VALMCNT,VALMLST,CCMOR,FICN H 3 W:'$D(MPIFRPC) !!
"RTN","MPIFQ0",98,0)
END K ^TMP("MPIFVQQ",$J),^TMP("MPIFQ0",$J) Q
"RTN","MPIFQ0",99,0)
UPDATE(DFN,ICN,CMOR) ;
"RTN","MPIFQ0",100,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG,LOCAL
"RTN","MPIFQ0",101,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",102,0)
 S CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",103,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",104,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",105,0)
 I +SETICN'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0" Q
"RTN","MPIFQ0",106,0)
 S SETLOC=1,LOCAL="N"
"RTN","MPIFQ0",107,0)
 I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3) S LOCAL="Y"
"RTN","MPIFQ0",108,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",109,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",110,0)
 I +SETLOC'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0" Q
"RTN","MPIFQ0",111,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",112,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",113,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",114,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFQ0",115,0)
 I +CHANGE'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0" Q
"RTN","MPIFQ0",116,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",117,0)
 N RESLT S RESLT=$$A24^MPIFA24B(DFN)
"RTN","MPIFQ0",118,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_DFN,DFN)
"RTN","MPIFQ0",119,0)
 ; Added for patch 31, create treating facility list
"RTN","MPIFQ0",120,0)
 I $D(^TMP("MPIFVQQ",$J,INDEX,"TF")) D
"RTN","MPIFQ0",121,0)
 . N MPINTFI,MPINTF,TFSTRG,TFIEN,MPIFMDT
"RTN","MPIFQ0",122,0)
 . S MPINTFI=0
"RTN","MPIFQ0",123,0)
 . F  S MPINTFI=$O(^TMP("MPIFVQQ",$J,INDEX,"TF",MPINTFI)) Q:'MPINTFI  D
"RTN","MPIFQ0",124,0)
 .. S MPINTF=^TMP("MPIFVQQ",$J,INDEX,"TF",MPINTFI)
"RTN","MPIFQ0",125,0)
 .. S TFIEN=$$IEN^XUAF4($P(MPINTF,"^",1))
"RTN","MPIFQ0",126,0)
 .. S MPIFMDT=$$HL7TFM^XLFDT($P(MPINTF,"^",2)) I MPIFMDT<0 S MPIFMDT=""
"RTN","MPIFQ0",127,0)
 .. S TFSTRG=TFIEN_"^"_$G(MPIFMDT)_"^"_$P(MPINTF,"^",3)
"RTN","MPIFQ0",128,0)
 .. D FILE^VAFCTFU(DFN,TFSTRG,1)
"RTN","MPIFQ0",129,0)
 Q
"RTN","MPIFQ0",130,0)
GETDATA(DIC,DA,MPIFAR,DR,EI) ;
"RTN","MPIFQ0",131,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",132,0)
 ;DIC=file reference, DA=IEN in file, ARRAY=array for the values to be stored in, DR=fields requested, EI=external/internal values
"RTN","MPIFQ0",133,0)
 N DIQ S DIQ=MPIFAR
"RTN","MPIFQ0",134,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",135,0)
 D EN^DIQ1
"RTN","MPIFQ0",136,0)
 Q
"RTN","MPIFQ0",137,0)
LOOP2 ;
"RTN","MPIFQ0",138,0)
 N MPIDONE,MPII,MPIJ
"RTN","MPIFQ0",139,0)
 S MPII=0,MPIDONE=0
"RTN","MPIFQ0",140,0)
 F  S MPIQUIT=$O(MPIDC(MPIQUIT)) Q:'MPIQUIT  D  Q:MPIDONE
"RTN","MPIFQ0",141,0)
 . I MPIDC(MPIQUIT)="" S MPIDONE=1 Q
"RTN","MPIFQ0",142,0)
 . S MPII=MPII+1,MPINODE(MPII)=$G(MPIDC(MPIQUIT)) Q
"RTN","MPIFQ0",143,0)
 Q
"RTN","MPIFQ0",144,0)
MSH ;
"RTN","MPIFQ0",145,0)
 S MPIREP=$E(HL("ECH"),2),MPICOMP=$E(HL("ECH"),1)
"RTN","MPIFQ0",146,0)
 Q
"RTN","MPIFQ0",147,0)
MSA ;
"RTN","MPIFQ0",148,0)
 Q
"RTN","MPIFQ0",149,0)
RDF ;
"RTN","MPIFQ0",150,0)
 Q
"RTN","MPIFQ0",151,0)
QAK ;
"RTN","MPIFQ0",152,0)
 Q
"RTN","MPIFQ0",153,0)
RDT ;
"RTN","MPIFQ0",154,0)
 N NAME,ICN,BIRTHDAY,CMOR,IEN,SEG,HEREICN,STRING,LASTNAME,FRSTNAME,MIDDLE,SUFF,SEX
"RTN","MPIFQ0",155,0)
 S STRING="",INDEX=$G(INDEX)+1
"RTN","MPIFQ0",156,0)
 D RDT^MPIFSA3(.INDEX,.HL,.MSG)
"RTN","MPIFQ0",157,0)
 S SEG=^TMP("MPIFVQQ",$J,INDEX,"DATA")
"RTN","MPIFQ0",158,0)
 S FRSTNAME=$P(SEG,"^",7),LASTNAME=$P(SEG,"^",2),MIDDLE=$P(SEG,"^",10),SUFF=$P(SEG,"^",15)
"RTN","MPIFQ0",159,0)
 S SSN=$P(SEG,"^",3),NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFQ0",160,0)
 I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFQ0",161,0)
 I SUFF'="" S NAME=NAME_" "_SUFF
"RTN","MPIFQ0",162,0)
 S SEX=$P(SEG,"^",11)
"RTN","MPIFQ0",163,0)
 S ICN=$P(SEG,"^",6)
"RTN","MPIFQ0",164,0)
 S BIRTHDAY=$P(SEG,"^",4)
"RTN","MPIFQ0",165,0)
 S CMOR=$P(SEG,"^",5),IEN=$$IEN^XUAF4(CMOR)
"RTN","MPIFQ0",166,0)
 S CMOR=$P($$NS^XUAF4(IEN),"^")
"RTN","MPIFQ0",167,0)
 S HEREICN=$$HEREICN^MPIFQ3($P(ICN,"V",1))
"RTN","MPIFQ0",168,0)
 I HEREICN S STRING=$$SETSTR^VALM1("*",STRING,1,1),^TMP("MPIFVQQ",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",169,0)
 S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4),STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",170,0)
 S STRING=$$SETSTR^VALM1(SSN,STRING,30,9),STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",171,0)
 S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",172,0)
 S ^TMP("MPIFVQQ",$J,INDEX,0)=STRING,^TMP("MPIFVQQ",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",173,0)
 Q
"RTN","MPIFQ1")
0^3^B42346245
"RTN","MPIFQ1",1,0)
MPIFQ1 ;ALB/RJS-CIRN QUERY HANDLER ;JUN 30, 1997
"RTN","MPIFQ1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,8,12,16,17,21,23,24,28,31**;30 Apr 99
"RTN","MPIFQ1",3,0)
 ;
"RTN","MPIFQ1",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFQ1",5,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFQ1",6,0)
 ;   FILE^VAFCTFU - #2988
"RTN","MPIFQ1",7,0)
 ;   ^DPT("AICN" - #2070
"RTN","MPIFQ1",8,0)
 ;   NAME^VAFCPID2 - #3492
"RTN","MPIFQ1",9,0)
 ;   EN1^XWB2HL7 - #3144
"RTN","MPIFQ1",10,0)
 ;   RTNDATA^XWBDRPC - #3149
"RTN","MPIFQ1",11,0)
 ;   VAFC REMOTE PDAT (RPC) - #3496
"RTN","MPIFQ1",12,0)
 ;
"RTN","MPIFQ1",13,0)
INIT ;Entry point for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",14,0)
 Q
"RTN","MPIFQ1",15,0)
HDR ;Header code for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",16,0)
 N SSN,DOB,MPIFQ1,NAME1,SEX
"RTN","MPIFQ1",17,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.03;.09;.02","EI")
"RTN","MPIFQ1",18,0)
 S NAME1=$G(MPIFQ1(2,DFN,.01,"E")),SSN=$G(MPIFQ1(2,DFN,.09,"E"))
"RTN","MPIFQ1",19,0)
 S DOB=$G(MPIFQ1(2,DFN,.03,"I")),SEX=$G(MPIFQ1(2,DFN,.02,"E"))
"RTN","MPIFQ1",20,0)
 I DOB]"" S DOB=$TR($$FMTE^XLFDT(DOB,"5D"),"/","-")
"RTN","MPIFQ1",21,0)
 S VALMHDR(1)=" Possible MPI Matches for Patient: "_IOINHI_NAME1_IOINORM
"RTN","MPIFQ1",22,0)
 S VALMHDR(2)="                              SSN: "_IOINHI_SSN_IOINORM
"RTN","MPIFQ1",23,0)
 S VALMHDR(3)="                              DOB: "_IOINHI_DOB_IOINORM
"RTN","MPIFQ1",24,0)
 S VALMHDR(4)="                              SEX: "_IOINHI_SEX_IOINORM,VALMHDR(5)=" "
"RTN","MPIFQ1",25,0)
 Q
"RTN","MPIFQ1",26,0)
START(INDEX) ;Starting entry point for envoking the List Manager Template MPIF Real-time query
"RTN","MPIFQ1",27,0)
 S VALMCNT=INDEX
"RTN","MPIFQ1",28,0)
 D EN^VALM("MPIF REAL-TIME QUERY")
"RTN","MPIFQ1",29,0)
 Q
"RTN","MPIFQ1",30,0)
SELECT N VALMY
"RTN","MPIFQ1",31,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",32,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",33,0)
 N DATA,INDEX,ICN,CHKSUM,NODE2
"RTN","MPIFQ1",34,0)
 S INDEX=$O(VALMY(0)),DATA=^TMP("MPIFVQQ",$J,INDEX,"DATA")
"RTN","MPIFQ1",35,0)
 S NODE2=$G(^TMP("MPIFVQQ",$J,INDEX,"INDICATOR"))
"RTN","MPIFQ1",36,0)
 S DATA(.01)=$P(DATA,"^",1) I $E(DATA(.01),$L(DATA(.01)))=" " S DATA(.01)=$E(DATA(.01),1,$L(DATA(.01))-1) ;NAME
"RTN","MPIFQ1",37,0)
 S DATA(.03)=$P(DATA,"^",4),DATA(.09)=$P(DATA,"^",3),DATA(.02)=$P(DATA,"^",11) ;DOB, SSN, SEX
"RTN","MPIFQ1",38,0)
 S ICN=$P(DATA,"^",6),CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),DATA(991.01)=ICN,DATA(991.02)=CHKSUM,DATA(991.03)=$$LKUP^XUAF4($P(DATA,"^",5))
"RTN","MPIFQ1",39,0)
 ;If NODE2["*" we have a pt in our list whose ICN is already at this site
"RTN","MPIFQ1",40,0)
 I NODE2["*",$O(^DPT("AICN",ICN,""))'=DFN D  Q
"RTN","MPIFQ1",41,0)
 .D CLEAR^VALM1,MSG1^MPIFQ3,START^RGHLLOG()
"RTN","MPIFQ1",42,0)
 .D EXC^RGHLLOG(227,"Attempted to assign same ICN to Patient DFN "_DFN_". ICN is already used for Name: "_DATA(.01)_" SSN: "_DATA(.09)_" DOB: "_DATA(.03)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ1",43,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIFQ1",44,0)
 .W !!,"Assigning Local ICN" D LOCAL^MPIFQ3(DFN),PROMPT^MPIFQ3 S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",45,0)
 ;User selected from list, does SSN & Name match?  no-ask if sure
"RTN","MPIFQ1",46,0)
 N SSN,NAME,SEX
"RTN","MPIFQ1",47,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.09;.02","EI")
"RTN","MPIFQ1",48,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E")),NAME=$G(MPIFQ1(2,DFN,.01,"E")),SEX=$G(MPIFQ1(2,DFN,.02,"I"))
"RTN","MPIFQ1",49,0)
 ; if sex doesn't match -- not allowed to update ICN
"RTN","MPIFQ1",50,0)
 I DATA(.02)'=SEX W !!,"Sex for these two patients doesn't match -- Can't select this patient until",!,"Sex matches between the MPI and your site.  No action will be taken." D PROMPT^MPIFQ3 S VALMBCK="R" Q
"RTN","MPIFQ1",51,0)
 I SSN["P" S SSN=""
"RTN","MPIFQ1",52,0)
 I DATA(.09)'=SSN W !!,"SSN for these two patients doesn't match -- Can't select this patient until",!,"SSN matches between the MPI and your site.  No action will be taken." D PROMPT^MPIFQ3 S VALMBCK="R" Q
"RTN","MPIFQ1",53,0)
 D NAME^VAFCPID2(0,.NAME,0) ;reformat name into DG 149 format
"RTN","MPIFQ1",54,0)
 N NAME3 S NAME3=DATA(.01) D NAME^VAFCPID2(0,.NAME3,0) S DATA(.01)=NAME3 ;reformat name into DG 149 format
"RTN","MPIFQ1",55,0)
 I DATA(.01)=NAME K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") D MSG3^MPIFQ3,PROMPT^MPIFQ3,TF^MPIFQ3(DFN,.DATA) Q  ;Name doesn't match exactly - ask if sure
"RTN","MPIFQ1",56,0)
 D CLEAR^VALM1,MSG2^MPIFQ3,MSG^MPIFQ3(SSN,NAME,DATA(.09),DATA(.01))
"RTN","MPIFQ1",57,0)
 N ANS S ANS=$$PROMPT1^MPIFQ3()
"RTN","MPIFQ1",58,0)
 I ANS K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") S MPIFRTN="CONTINUE" W !!,"ICN and CMOR Updated" D PROMPT^MPIFQ3,TF^MPIFQ3(DFN,.DATA) Q
"RTN","MPIFQ1",59,0)
 D MSG5^MPIFQ3,PROMPT^MPIFQ3 S VALMBCK="R"
"RTN","MPIFQ1",60,0)
 Q
"RTN","MPIFQ1",61,0)
ADD ;Add (MPIF REAL-TIME QUERY (ADD PATIENT)) add pt to MPI Austin.
"RTN","MPIFQ1",62,0)
 D A28^MPIFQ3(DFN),PROMPT^MPIFQ3 S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",63,0)
 Q
"RTN","MPIFQ1",64,0)
MPIPD ; MPI PDAT CALL
"RTN","MPIFQ1",65,0)
 N VALMY,CNT,Y
"RTN","MPIFQ1",66,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",67,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",68,0)
 N DATA,INDEX,ICN,CHKSUM,CMOR,CASE,CMOR3,TTF,ALIAS,POW,TAL,TMP
"RTN","MPIFQ1",69,0)
 S INDEX=$O(VALMY(0)),Y="" D CLEAR^VALM1
"RTN","MPIFQ1",70,0)
 S DATA=^TMP("MPIFVQQ",$J,INDEX,"DATA")
"RTN","MPIFQ1",71,0)
 S CMOR=$P(DATA,"^",5),CMOR3=CMOR,CMOR=$P($$NS^XUAF4($$LKUP^XUAF4(CMOR)),"^")
"RTN","MPIFQ1",72,0)
 W !,"MPI Data:",!!!,?3,"ICN: ",+$P(DATA,"^",6),?30,"CMOR: ",CMOR," (",CMOR3,")"
"RTN","MPIFQ1",73,0)
 W !,?2,"NAME: ",$P(DATA,"^")
"RTN","MPIFQ1",74,0)
 W !,?3,"SSN: ",$P(DATA,"^",3),?30,"SEX: ",$P(DATA,"^",11)
"RTN","MPIFQ1",75,0)
 W !,?3,"DOB: ",$P(DATA,"^",4)
"RTN","MPIFQ1",76,0)
 W ?30,"DOD: ",$P(DATA,"^",9)
"RTN","MPIFQ1",77,0)
 I $P(DATA,"^",20)="Y" W !?3,"Multiple Birth Indicator:  Yes"
"RTN","MPIFQ1",78,0)
 I ($P(DATA,"^",12)='"")&($P(DATA,"^",13)'="") W !,?2,"PLACE OF BIRTH: ",$P(DATA,"^",12),", ",$P(DATA,"^",13)
"RTN","MPIFQ1",79,0)
 I $P(DATA,"^",12)=""!($P(DATA,"^",13)="") W !,?2,"PLACE OF BIRTH: ",$P(DATA,"^",12)," ",$P(DATA,"^",13)
"RTN","MPIFQ1",80,0)
 W !,?2,"MOTHER'S MAIDEN NAME: ",$P(DATA,"^",16)
"RTN","MPIFQ1",81,0)
 W !,?2,"CLAIM NUMBER: ",$P(DATA,"^",17)
"RTN","MPIFQ1",82,0)
 S POW=$P(DATA,"^",19) I POW'="" W !,?2,"POW STATUS: ",POW
"RTN","MPIFQ1",83,0)
 S CASE=$P(DATA,"^",18)
"RTN","MPIFQ1",84,0)
 I CASE'="" W !,?2,"Open Data Management Case",!,?5,"CASE#: ",$P(CASE,"/")_"   NOIS#: ",$P(CASE,"/",2),!,?5,"CASE WORKER: ",$P(CASE,"/",3)
"RTN","MPIFQ1",85,0)
 I $D(^TMP("MPIFVQQ",$J,INDEX,"ALIAS")) W !,?2,"Alias(es): " D
"RTN","MPIFQ1",86,0)
 .N XX S XX=0 F  S XX=$O(^TMP("MPIFVQQ",$J,INDEX,"ALIAS",XX)) Q:'XX  W !?10,^(XX)
"RTN","MPIFQ1",87,0)
 I $D(^TMP("MPIFVQQ",$J,INDEX,"TF"))&($O(^TMP("MPIFVQQ",$J,INDEX,"TF",1))'="") D
"RTN","MPIFQ1",88,0)
 .W !,?2,"TREATING FACILITY LIST:"
"RTN","MPIFQ1",89,0)
 .N XX S XX=0 F  S XX=$O(^TMP("MPIFVQQ",$J,INDEX,"TF",XX)) Q:'XX  S TMP=$P($G(^(XX)),MPICOMP) I TMP'=CMOR3 W !?10,"Treating Facility: ",$P($$NS^XUAF4($$LKUP^XUAF4(TMP)),"^")," (",TMP,")"
"RTN","MPIFQ1",90,0)
 D PROMPT^MPIFQ3
"RTN","MPIFQ1",91,0)
 S VALMBCK="R"
"RTN","MPIFQ1",92,0)
 Q
"RTN","MPIFQ1",93,0)
CMOR ; CMOR PDAT CALL
"RTN","MPIFQ1",94,0)
 N VALMY,DATA,INDEX,ICN,CHKSUM,CMOR
"RTN","MPIFQ1",95,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",96,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",97,0)
 S INDEX=$O(VALMY(0)),DATA=^TMP("MPIFVQQ",$J,INDEX,"DATA")
"RTN","MPIFQ1",98,0)
 S ICN=$P(DATA,"^",6),CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),CMOR=$P(DATA,"^",5)
"RTN","MPIFQ1",99,0)
 I CMOR=$P($$SITE^VASITE(),"^",3) W !!,"CMOR is your site" G END
"RTN","MPIFQ1",100,0)
 W !,"Please be patient while the data is being retrieved from the CMOR."
"RTN","MPIFQ1",101,0)
 D EN1^XWB2HL7(.RETURN,CMOR,"VAFC REMOTE PDAT",1,ICN,"")  ; Request 
"RTN","MPIFQ1",102,0)
 S ^XTMP("MPIFPDAT"_ICN,0)=$$FMADD^XLFDT(DT,2)_"^"_DT_"^"_"REMOTE PDAT QUERY",^XTMP("MPIFPDAT"_ICN,1)=RETURN(0)_"^"_$$NOW^XLFDT
"RTN","MPIFQ1",103,0)
 S CNT=0
"RTN","MPIFQ1",104,0)
AGAIN1 H 2 K RES1 D RTNDATA^XWBDRPC(.RES1,RETURN(0)) S CNT=CNT+1
"RTN","MPIFQ1",105,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT<11 G AGAIN1
"RTN","MPIFQ1",106,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT>10 W !,"Unable to get data" G END
"RTN","MPIFQ1",107,0)
 I RES1(0)="0^New" I CNT<11 G AGAIN1
"RTN","MPIFQ1",108,0)
 I RES1(0)="0^New" I CNT>10 W !,"Unable to get data" G END
"RTN","MPIFQ1",109,0)
 I +RES1(0)=-1 W !!,$P(RES1(0),"^",2) G END
"RTN","MPIFQ1",110,0)
 I RES1'="" I CNT<11 G AGAIN1
"RTN","MPIFQ1",111,0)
 I RES1'="" I CNT>10 W !,"Unable to get data" Q
"RTN","MPIFQ1",112,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",113,0)
 N NUM S NUM="",CNT=0
"RTN","MPIFQ1",114,0)
 F  S NUM=$O(RES1(NUM)) Q:NUM=""  D
"RTN","MPIFQ1",115,0)
 .I CNT>20 D PROMPT^MPIFQ3,CLEAR^VALM1 S CNT=0
"RTN","MPIFQ1",116,0)
 .I RES1(NUM)["Additional" W !! S CNT=CNT+2
"RTN","MPIFQ1",117,0)
 .I CNT<21 W !,RES1(NUM) S CNT=CNT+1
"RTN","MPIFQ1",118,0)
END D PROMPT^MPIFQ3 S VALMBCK="R" K CNT,RETURN,RES1
"RTN","MPIFQ1",119,0)
 Q
"RTN","MPIFQ1",120,0)
HELP ; Help List Manager Action (MPIF REAL-TIME QUERY (HELP))
"RTN","MPIFQ1",121,0)
 D CLEAR^VALM1,MSG4^MPIFQ3,PROMPT^MPIFQ3 S VALMBCK="R"
"RTN","MPIFQ1",122,0)
 Q
"RTN","MPIFQ1",123,0)
EXIT ;Exit for List Manager Template MPIF REAL-TIME QUERY
"RTN","MPIFQ1",124,0)
 K VALMBCK,VALMCNT,VALMHDR
"RTN","MPIFQ1",125,0)
 Q
"RTN","MPIFSA3")
0^8^B25484648
"RTN","MPIFSA3",1,0)
MPIFSA3 ;SF/CMC,DLR-STAND ALONE QUERY PART 2 ;MAY 13, 2003
"RTN","MPIFSA3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**28,31**;30 Apr 99
"RTN","MPIFSA3",3,0)
 ;
"RTN","MPIFSA3",4,0)
RDT(INDEX,HL,MSG) ;
"RTN","MPIFSA3",5,0)
 N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,NAME,ICN,POBC,POBS,PAST,HEREICN,HERESSN,MIDDLE,MNAME,SUFFIX,PREFIX,SEX,IEN,CMOR2,CLAIM,CASE,NOIS,CUSER,TFN,CMOR3,XXX,POW,MBIRTH,Y,LNGTH,SEQ1,SEQ,RDT,NXT,LNGTH2,LNGTH1,MPIREP,MPICOMP,TCASE
"RTN","MPIFSA3",6,0)
 S MPICOMP=$E(HL("ECH"),1),MPIREP=$E(HL("ECH"),2)
"RTN","MPIFSA3",7,0)
 S SEQ1=1,SEQ=0,X=0 F  S X=$O(MSG(X)) Q:'X  S LNGTH=$L(MSG(X),HL("FS")) D
"RTN","MPIFSA3",8,0)
 . F Y=1:1:LNGTH S:Y'=1 SEQ=SEQ+1 D
"RTN","MPIFSA3",9,0)
 .. S NXT=$P(MSG(X),HL("FS"),Y) D
"RTN","MPIFSA3",10,0)
 ... I $L($G(RDT(SEQ)))=245 D  Q
"RTN","MPIFSA3",11,0)
 .... I $L(NXT_$G(RDT(SEQ,SEQ1)))>245 S LNGTH1=$L(RDT(SEQ,SEQ1)) S LNGTH2=245-LNGTH1,RDT(SEQ,SEQ1)=$G(RDT(SEQ,SEQ1))_$E(NXT,1,LNGTH2),LNGTH2=LNGTH2+1,NXT=$E(NXT,LNGTH2,$L(NXT)),SEQ1=SEQ1+1
"RTN","MPIFSA3",12,0)
 .... I $L(NXT_$G(RDT(SEQ,SEQ1)))'>245 S RDT(SEQ,SEQ1)=$G(RDT(SEQ,SEQ1))_NXT
"RTN","MPIFSA3",13,0)
 ... I $L(NXT_$G(RDT(SEQ)))>245 S LNGTH1=$L($G(RDT(SEQ))) S LNGTH2=245-LNGTH1,RDT(SEQ)=$G(RDT(SEQ))_$E(NXT,1,LNGTH2),LNGTH2=LNGTH2+1,NXT=$E(NXT,LNGTH2,$L(NXT)) S RDT(SEQ,SEQ1)=NXT
"RTN","MPIFSA3",14,0)
 ... I $L(NXT_$G(RDT(SEQ)))'>245 S RDT(SEQ)=$G(RDT(SEQ))_NXT Q
"RTN","MPIFSA3",15,0)
RDTAL ;
"RTN","MPIFSA3",16,0)
 S FRSTNAME=RDT(6),LASTNAME=RDT(1),MIDDLE=RDT(9),SSN=RDT(2)
"RTN","MPIFSA3",17,0)
 S SUFFIX=RDT(14),PREFIX=RDT(13)
"RTN","MPIFSA3",18,0)
 S NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFSA3",19,0)
 I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFSA3",20,0)
 I SUFFIX'="" S NAME=NAME_" "_SUFFIX
"RTN","MPIFSA3",21,0)
 I PREFIX'="" S NAME=NAME_" "_PREFIX
"RTN","MPIFSA3",22,0)
 S ICN=RDT(5),CMOR=RDT(4),CMOR2=CMOR,CMOR3=CMOR
"RTN","MPIFSA3",23,0)
 I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR2=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFSA3",24,0)
 I $G(SKIP)="Y" K SKIP Q
"RTN","MPIFSA3",25,0)
 S BIRTHDAY=RDT(3)
"RTN","MPIFSA3",26,0)
 I $G(LASTNAME)="" Q
"RTN","MPIFSA3",27,0)
 I $G(BIRTHDAY)]"" S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY),BIRTHDAY=$TR($$FMTE^XLFDT(BIRTHDAY,"5D"),"/","-")
"RTN","MPIFSA3",28,0)
 S SEX=RDT(10),CLAIM=RDT(16),MNAME=RDT(15),POBC=RDT(11),POBS=RDT(12)
"RTN","MPIFSA3",29,0)
 S PAST=RDT(8) I $G(PAST)]"" S PAST=$$FMDATE^HLFNC(PAST),PAST=$TR($$FMTE^XLFDT(PAST,"5D"),"/","-")
"RTN","MPIFSA3",30,0)
 S CASE=RDT(17),NOIS=$P(CASE,"/",2),CUSER=$P(CASE,"/",3),TCASE=CASE,CASE=$P(CASE,"/")
"RTN","MPIFSA3",31,0)
 S MBIRTH=RDT(19),POW=RDT(18)
"RTN","MPIFSA3",32,0)
 I POW="N" S POW="No"
"RTN","MPIFSA3",33,0)
 I POW="Y" S POW="Yes"
"RTN","MPIFSA3",34,0)
TMP ;New pt. so incrementing index and resetting counter
"RTN","MPIFSA3",35,0)
 S ^TMP("MPIFVQQ",$J,INDEX,"DATA")=NAME_"^"_LASTNAME_"^"_SSN_"^"_BIRTHDAY_"^"_CMOR_"^"_ICN_"^"_FRSTNAME_"^^"_PAST_"^"_MIDDLE_"^"_SEX_"^"_POBC_"^"_POBS_"^"_PREFIX_"^"_SUFFIX_"^"_MNAME_"^"_CLAIM_"^"_TCASE_"^"_POW_"^"_MBIRTH
"RTN","MPIFSA3",36,0)
 ;loop on TF's
"RTN","MPIFSA3",37,0)
 ;I TF2'="" F XXX=1:1 S TTF2=$P(TF2,MPIREP,XXX) Q:TTF2=""  S TFLL(INDEX,XXX)=TTF2
"RTN","MPIFSA3",38,0)
 N LAST,SEQ,ORGLST,TFLL
"RTN","MPIFSA3",39,0)
 I $D(RDT(7)) N LAST,LASTN S SEQ=1 S LAST=$L(RDT(7),MPIREP) S LASTN=LAST-1 D
"RTN","MPIFSA3",40,0)
 .N X F X=1:1:LAST-1 S TFLL(INDEX,X)=$P(RDT(7),MPIREP,X)
"RTN","MPIFSA3",41,0)
 .I '$D(RDT(7,SEQ)) I $P(RDT(7),MPIREP,LAST)'="" S TFLL(INDEX,LAST)=$P($P(RDT(7),MPIREP,LAST),MPICOMP)
"RTN","MPIFSA3",42,0)
 . N LOOP I $D(RDT(7,SEQ)) S LASTVAL=$P(RDT(7),MPIREP,LAST) S LOOP=LASTN+1 F  Q:'$D(RDT(7,SEQ))  N LAST S LAST=$L(RDT(7,SEQ),MPIREP) D
"RTN","MPIFSA3",43,0)
 ..N X F X=1:1:LAST-1 S TFLL(INDEX,(LOOP))=$S($D(LASTVAL):LASTVAL,1:"")_$P(RDT(7,SEQ),MPIREP,X) K LASTVAL S LOOP=LOOP+1
"RTN","MPIFSA3",44,0)
 ..I '$D(RDT(7,SEQ)) I $P(RDT(7),MPIREP,LAST)'="" S TFLL(INDEX,(LASTN+LAST))=$P($P(RDT(7),MPIREP,LAST),MPICOMP) S LOOP=LOOP+1
"RTN","MPIFSA3",45,0)
 ..I $D(RDT(7,SEQ)) S LASTVAL=$P(RDT(7,SEQ),MPIREP,LAST)
"RTN","MPIFSA3",46,0)
 ..S SEQ=SEQ+1
"RTN","MPIFSA3",47,0)
 ;loop on TFLL to build TF LIST nodes
"RTN","MPIFSA3",48,0)
 S X=0 F  S X=$O(TFLL(INDEX,X)) Q:'X  S ^TMP("MPIFVQQ",$J,INDEX,"TF",X)=TFLL(INDEX,X)
"RTN","MPIFSA3",49,0)
ALIAS ;loop on alias last name
"RTN","MPIFSA3",50,0)
 N LAST,SEQ,ORGLST,AL
"RTN","MPIFSA3",51,0)
 I $D(RDT(20)) N LAST S SEQ=1 S LAST=$L(RDT(20),MPIREP) D
"RTN","MPIFSA3",52,0)
 .N X F X=1:1:LAST-1 S AL(INDEX,X)=$P(RDT(20),MPIREP,X)_","_$P($G(RDT(21)),MPIREP,X)_" "_$P($G(RDT(22)),MPIREP,X)_" "_$P($G(RDT(23)),MPIREP,X)_" "_$P($G(RDT(24)),MPIREP,X)
"RTN","MPIFSA3",53,0)
 .I '$D(RDT(20,SEQ)) I $P(RDT(20),MPIREP,LAST)'="" S AL(INDEX,LAST)=$P(RDT(20),MPIREP,LAST)_","_$P($G(RDT(21)),MPIREP,LAST)_" "_$P($G(RDT(22)),MPIREP,LAST)_" "_$P($G(RDT(23)),MPIREP,LAST)_" "_$P($G(RDT(24)),MPIREP,LAST)
"RTN","MPIFSA3",54,0)
 . I $D(RDT(20,SEQ)) S LASTVAL=$P(RDT(20),MPIREP,LAST) F  Q:'$D(RDT(20,SEQ))  N LAST S LAST=$L(RDT(20,SEQ),MPIREP) D
"RTN","MPIFSA3",55,0)
 ..N X F X=1:1:LAST-1 S AL(INDEX,X)=$S($D(LASTVAL):LASTVAL,1:"")_$P(RDT(20,SEQ),MPIREP,X)_","_$P($G(RDT(21)),MPIREP,X)_" "_$P($G(RDT(22)),MPIREP,X)_" "_$P($G(RDT(23)),MPIREP,X)_" "_$P($G(RDT(24)),MPIREP,X) K LASTVAL
"RTN","MPIFSA3",56,0)
 ..I '$D(RDT(20,SEQ)) I $P(RDT(20),MPIREP,LAST)'="" S AL(INDEX,LAST)=$P($P(RDT(20),MPIREP,LAST),MPICOMP)_","_$P($G(RDT(21)),MPIREP,LAST)_" "_$P($G(RDT(22)),MPIREP,LAST)_" "_$P($G(RDT(23)),MPIREP,LAST)_" "_$P($G(RDT(24)),MPIREP,LAST)
"RTN","MPIFSA3",57,0)
 ..I $D(RDT(20,SEQ)) S LASTVAL=$P(RDT(20,SEQ),MPIREP,LAST)
"RTN","MPIFSA3",58,0)
 ..S SEQ=SEQ+1
"RTN","MPIFSA3",59,0)
 S X=0 F  S X=$O(AL(INDEX,X)) Q:'X  S ^TMP("MPIFVQQ",$J,INDEX,"ALIAS",X)=AL(INDEX,X)
"RTN","MPIFSA3",60,0)
 Q
"VER")
8.0^22.0
**END**
**END**
