EMERGENCY Released OR*3*134 SEQ #130
Extracted from mail message
**KIDS**:OR*3.0*134^

**INSTALL NAME**
OR*3.0*134
"BLD",3489,0)
OR*3.0*134^ORDER ENTRY/RESULTS REPORTING^0^3020328^y
"BLD",3489,4,0)
^9.64PA^^
"BLD",3489,"INIT")
ORY134
"BLD",3489,"KRN",0)
^9.67PA^8989.52^19
"BLD",3489,"KRN",.4,0)
.4
"BLD",3489,"KRN",.401,0)
.401
"BLD",3489,"KRN",.402,0)
.402
"BLD",3489,"KRN",.403,0)
.403
"BLD",3489,"KRN",.5,0)
.5
"BLD",3489,"KRN",.84,0)
.84
"BLD",3489,"KRN",3.6,0)
3.6
"BLD",3489,"KRN",3.8,0)
3.8
"BLD",3489,"KRN",9.2,0)
9.2
"BLD",3489,"KRN",9.8,0)
9.8
"BLD",3489,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",3489,"KRN",9.8,"NM",1,0)
ORCACT01^^0^B74432337
"BLD",3489,"KRN",9.8,"NM",2,0)
ORCDPS3^^0^B34895081
"BLD",3489,"KRN",9.8,"NM",3,0)
ORCSIGN^^0^B63663684
"BLD",3489,"KRN",9.8,"NM",4,0)
ORMPS1^^0^B53935388
"BLD",3489,"KRN",9.8,"NM",5,0)
ORMPS2^^0^B30678552
"BLD",3489,"KRN",9.8,"NM",6,0)
ORY134^^0^B22825556
"BLD",3489,"KRN",9.8,"NM",7,0)
ORWDXR^^0^B18380223
"BLD",3489,"KRN",9.8,"NM","B","ORCACT01",1)

"BLD",3489,"KRN",9.8,"NM","B","ORCDPS3",2)

"BLD",3489,"KRN",9.8,"NM","B","ORCSIGN",3)

"BLD",3489,"KRN",9.8,"NM","B","ORMPS1",4)

"BLD",3489,"KRN",9.8,"NM","B","ORMPS2",5)

"BLD",3489,"KRN",9.8,"NM","B","ORWDXR",7)

"BLD",3489,"KRN",9.8,"NM","B","ORY134",6)

"BLD",3489,"KRN",19,0)
19
"BLD",3489,"KRN",19.1,0)
19.1
"BLD",3489,"KRN",101,0)
101
"BLD",3489,"KRN",409.61,0)
409.61
"BLD",3489,"KRN",771,0)
771
"BLD",3489,"KRN",870,0)
870
"BLD",3489,"KRN",8989.51,0)
8989.51
"BLD",3489,"KRN",8989.52,0)
8989.52
"BLD",3489,"KRN",8994,0)
8994
"BLD",3489,"KRN","B",.4,.4)

"BLD",3489,"KRN","B",.401,.401)

"BLD",3489,"KRN","B",.402,.402)

"BLD",3489,"KRN","B",.403,.403)

"BLD",3489,"KRN","B",.5,.5)

"BLD",3489,"KRN","B",.84,.84)

"BLD",3489,"KRN","B",3.6,3.6)

"BLD",3489,"KRN","B",3.8,3.8)

"BLD",3489,"KRN","B",9.2,9.2)

"BLD",3489,"KRN","B",9.8,9.8)

"BLD",3489,"KRN","B",19,19)

"BLD",3489,"KRN","B",19.1,19.1)

"BLD",3489,"KRN","B",101,101)

"BLD",3489,"KRN","B",409.61,409.61)

"BLD",3489,"KRN","B",771,771)

"BLD",3489,"KRN","B",870,870)

"BLD",3489,"KRN","B",8989.51,8989.51)

"BLD",3489,"KRN","B",8989.52,8989.52)

"BLD",3489,"KRN","B",8994,8994)

"BLD",3489,"QUES",0)
^9.62^^
"BLD",3489,"REQB",0)
^9.611^4^4
"BLD",3489,"REQB",1,0)
OR*3.0*110^2
"BLD",3489,"REQB",2,0)
OR*3.0*129^2
"BLD",3489,"REQB",3,0)
PSJ*5.0*70^2
"BLD",3489,"REQB",4,0)
PSO*7.0*100^2
"BLD",3489,"REQB","B","OR*3.0*110",1)

"BLD",3489,"REQB","B","OR*3.0*129",2)

"BLD",3489,"REQB","B","PSJ*5.0*70",3)

"BLD",3489,"REQB","B","PSO*7.0*100",4)

"INIT")
ORY134
"MBREQ")
0
"PKG",110,-1)
1^1
"PKG",110,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",110,20,0)
^9.402P^^
"PKG",110,22,0)
^9.49I^1^1
"PKG",110,22,1,0)
3.0^2971217
"PKG",110,22,1,"PAH",1,0)
134^3020328
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","ORCACT01")
0^1^B74432337
"RTN","ORCACT01",1,0)
ORCACT01        ;SLC/MKB-Validate order actions cont ;3/12/02  13:14
"RTN","ORCACT01",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**94,116,134**;Dec 17, 1997
"RTN","ORCACT01",3,0)
 ;
"RTN","ORCACT01",4,0)
 ; ** Called from ORCACT0:
"RTN","ORCACT01",5,0)
 ;
"RTN","ORCACT01",6,0)
ES ; -- sign [on chart]
"RTN","ORCACT01",7,0)
 I ORDSTS=11,VER<3,PKG'="OR" S ERROR="This order cannot be released and must be discontinued!" Q
"RTN","ORCACT01",8,0)
 N X I ACTSTS=11!(ACTSTS=10) D  Q:$L($G(ERROR))
"RTN","ORCACT01",9,0)
 . I $P(ORA0,U,2)="DC",$$DONE^ORCACT0 D CANCEL^ORCSEND(+IFN),UNOTIF^ORCSIGN S OREBUILD=1 Q
"RTN","ORCACT01",10,0)
 . S X=$$DISABLED^ORCACT0 I X S ERROR=$P(X,U,2) Q
"RTN","ORCACT01",11,0)
 S X=$P(ORA0,U,4) I X=3 S:ACTSTS'=11&(ACTSTS'=10) ERROR="This order does not require a signature!" Q
"RTN","ORCACT01",12,0)
 I X'=2 S ERROR="This order has been signed!" Q
"RTN","ORCACT01",13,0)
 I DG="O RX",ACTION'="ES",$G(NATR)'="I" S ERROR="Outpatient meds may not be released without a clinician's signature!" Q
"RTN","ORCACT01",14,0)
 I ACTION="ES",$D(^XUSEC("ORELSE",DUZ)),$P(OR0,U,16)'<2 S ERROR="You are not privileged to sign this order!" Q
"RTN","ORCACT01",15,0)
 I ACTION="OC" S:MEDPARM<2 ERROR="You are not authorized to release med orders!" Q
"RTN","ORCACT01",16,0)
 I ACTION="RS" D  Q:$D(ERROR)  Q:$G(NATR)'="I"
"RTN","ORCACT01",17,0)
 . Q:ACTSTS=11  Q:ACTSTS=10  ;unreleased - ok
"RTN","ORCACT01",18,0)
 . S ERROR="This order has already been released!"
"RTN","ORCACT01",19,0)
ES1 I PKG="PS" D  ;authorized to write meds?
"RTN","ORCACT01",20,0)
 . N TYPE,OI,PSOI,DEAFLG S X=$G(^VA(200,DUZ,"PS"))
"RTN","ORCACT01",21,0)
 . I '$P(X,U) S ERROR="You are not authorized to sign med orders!" Q
"RTN","ORCACT01",22,0)
 . I $P(X,U,4),$$NOW^XLFDT>$P(X,U,4) S ERROR="You are no longer authorized to sign med orders!" Q
"RTN","ORCACT01",23,0)
 . Q:DG="IV RX"  Q:$P(ORA0,U,2)="DC"  ;don't need to ck DEA#
"RTN","ORCACT01",24,0)
 . S OI=+$$VALUE^ORX8(+IFN,"ORDERABLE")
"RTN","ORCACT01",25,0)
 . S PSOI=+$P($G(^ORD(101.43,OI,0)),U,2) Q:PSOI'>0
"RTN","ORCACT01",26,0)
 . S TYPE=$S($P(DG," ")="O":"O",1:"I"),DEAFLG=$$OIDEA^PSSUTLA1(PSOI,TYPE)
"RTN","ORCACT01",27,0)
 . I DEAFLG>0,'$L($P(X,U,2)),'$L($P(X,U,3)) S ERROR="You must have a DEA# or VA# to sign this order!" Q
"RTN","ORCACT01",28,0)
 Q
"RTN","ORCACT01",29,0)
 ;
"RTN","ORCACT01",30,0)
XFR ; -- transfer to inpt/outpt [IFN=order to be transferred]
"RTN","ORCACT01",31,0)
 N OI,PS I DG="TPN" S ERROR="TPN orders may not be copied!" Q
"RTN","ORCACT01",32,0)
 I $$INACTIVE S ERROR="Orders for inactive orderables may not be transferred; please enter a new order!" Q
"RTN","ORCACT01",33,0)
 S OI=+$O(^OR(100,+IFN,.1,"B",0)),ORPS=$G(^ORD(101.43,OI,"PS"))
"RTN","ORCACT01",34,0)
 I DG="UD RX",'$P(ORPS,U,2) S ERROR="This drug may not be ordered for an outpatient!" Q
"RTN","ORCACT01",35,0)
 I DG="O RX" D  Q:$L($G(ERROR))
"RTN","ORCACT01",36,0)
 . I '$P(ORPS,U) S ERROR="This drug may not be ordered for an inpatient!" Q
"RTN","ORCACT01",37,0)
 . D:$O(^OR(100,+IFN,4.5,"ID","MISC",0)) DOSES(+IFN)
"RTN","ORCACT01",38,0)
 Q
"RTN","ORCACT01",39,0)
 ;
"RTN","ORCACT01",40,0)
RW ; -- rewrite/copy
"RTN","ORCACT01",41,0)
 I ACTSTS=12 S ERROR="Orders that have been dc'd due to editing may not be copied!" Q
"RTN","ORCACT01",42,0)
 I DG="TPN" S ERROR="TPN orders may not be rewritten!" Q
"RTN","ORCACT01",43,0)
 I DG="UD RX",$$NTBG(+IFN) S ERROR="This order has been marked 'Not to be Given' and may not be rewritten!" Q
"RTN","ORCACT01",44,0)
 I $$INACTIVE S ERROR="Orders for inactive orderables may not be copied; please enter a new order!" Q
"RTN","ORCACT01",45,0)
 I DG="O RX",$O(^OR(100,+IFN,4.5,"ID","MISC",0)) D DOSES(+IFN) ;old form
"RTN","ORCACT01",46,0)
 Q
"RTN","ORCACT01",47,0)
 ;
"RTN","ORCACT01",48,0)
RN ; -- renew
"RTN","ORCACT01",49,0)
 I PKG'="PS",PKG'="OR" S ERROR="This order may not be renewed!" Q
"RTN","ORCACT01",50,0)
 I (ORDSTS=11)!(ORDSTS=10) S ERROR="This order has not been released to the service." Q
"RTN","ORCACT01",51,0)
 I ACTSTS=12 S ERROR="Orders that have been dc'd due to editing may not be renewed!" Q
"RTN","ORCACT01",52,0)
 I $P(OR3,U,6) S ERROR="This order has already been "_$S($P($G(^OR(100,+$P(OR3,U,6),3)),U,11)=1:"changed!",1:"renewed!") Q
"RTN","ORCACT01",53,0)
 I PKG="OR" D  Q  ;Generic orders
"RTN","ORCACT01",54,0)
 . I $$INACTIVE S ERROR="Orders for inactive orderables may not be renewed!" Q
"RTN","ORCACT01",55,0)
 . I "^1^2^6^7^"[(U_ORDSTS_U) Q  ;ok
"RTN","ORCACT01",56,0)
 . S ERROR="This order may not be renewed!"
"RTN","ORCACT01",57,0)
RN1 N PSIFN S PSIFN=$G(^OR(100,+IFN,4))
"RTN","ORCACT01",58,0)
 I DG="O RX" D  Q  ;Outpt Meds
"RTN","ORCACT01",59,0)
 . N ORZ,ORD S ORZ=$L($T(RENEW^PSORENW),",")
"RTN","ORCACT01",60,0)
 . I ORZ>1 S ORD=+$$VALUE^ORX8(+IFN,"DRUG"),X=$$RENEW^PSORENW(PSIFN,ORD)
"RTN","ORCACT01",61,0)
 . S:ORZ'>1 X=$$RENEW^PSORENW(PSIFN) I X<1 S ERROR=$P(X,U,2) Q
"RTN","ORCACT01",62,0)
 . S X=+$P(X,U,2) D:X RESET(+IFN,X)
"RTN","ORCACT01",63,0)
 . I $O(^OR(100,+IFN,4.5,"ID","MISC",0)) D DOSES(+IFN) ;old format
"RTN","ORCACT01",64,0)
 I DG="UD RX",$$NTBG(+IFN) S ERROR="This order has been marked 'Not to be Given' and may not be renewed!" Q
"RTN","ORCACT01",65,0)
 I ORDSTS=7,'$$IV,$P(OR0,U,9)<$$FMADD^XLFDT(DT,-4)  S ERROR="Inpatient med orders may not be renewed more than 4 days after expiration!" Q
"RTN","ORCACT01",66,0)
 I ORDSTS'=6,ORDSTS'=7 S ERROR="This order may not be renewed!" Q
"RTN","ORCACT01",67,0)
 I PSIFN'>0 S ERROR=$S($O(^OR(100,+IFN,2,0)):"Complex orders may not be renewed!",1:"Missing or invalid order number!") Q
"RTN","ORCACT01",68,0)
 S X=$$ACTIVE^PSJORREN(+ORVP,PSIFN) Q:+X=1  ;Ok
"RTN","ORCACT01",69,0)
 I +X>1,$P(X,U,2) D RESET(+IFN,+$P(X,U,2)) Q  ;replace OI
"RTN","ORCACT01",70,0)
 ;I +X>1,$P(X,U,2) S $P(X,U,2)="Inactive orderable item(s)"
"RTN","ORCACT01",71,0)
 S ERROR="This order may not be renewed: "_$P(X,U,2)
"RTN","ORCACT01",72,0)
 Q
"RTN","ORCACT01",73,0)
 ;
"RTN","ORCACT01",74,0)
XX ; -- edit/change
"RTN","ORCACT01",75,0)
 I PKG="RA",ORDSTS'=11,ORDSTS'=10 S ERROR="Orders released to Radiology cannot be changed!" Q
"RTN","ORCACT01",76,0)
 I PKG="LR",ORDSTS'=11,ORDSTS'=10 S ERROR="Orders released to Lab cannot be changed!" Q
"RTN","ORCACT01",77,0)
 I PKG="FH",ORDSTS'=11,ORDSTS'=10 S ERROR="Orders released to Dietetics cannot be changed!" Q
"RTN","ORCACT01",78,0)
 I PKG="GMRC",ORDSTS'=11,ORDSTS'=10 S ERROR="Orders released to Consults cannot be changed!" Q
"RTN","ORCACT01",79,0)
 I DG="TPN" S ERROR="TPN orders may not be changed!" Q
"RTN","ORCACT01",80,0)
 I ORDSTS=3 S ERROR="Orders on hold may not be changed!" Q
"RTN","ORCACT01",81,0)
 I DG="UD RX",$$NTBG(+IFN) S ERROR="This order has been marked 'Not to be Given' and may not be changed!" Q
"RTN","ORCACT01",82,0)
 I $O(^OR(100,+IFN,2,0)) S ERROR="Complex orders may not be changed!" Q
"RTN","ORCACT01",83,0)
 I $P(OR3,U,6) S ERROR="This order may not be changed - a "_$S($P($G(^OR(100,+$P(OR3,U,6),3)),U,11)=1:"change",1:"renewal")_" order already exists!" Q
"RTN","ORCACT01",84,0)
 I $P(OR3,U,11)=2 D  Q:$D(ERROR)
"RTN","ORCACT01",85,0)
 . I ORDSTS=10!(ORDSTS=11) S ERROR="Unreleased renewals may not be changed!" Q
"RTN","ORCACT01",86,0)
 . I PKG="PS",ORDSTS=5 S ERROR="Pending renewals may not be changed!" Q
"RTN","ORCACT01",87,0)
 I $$INACTIVE S ERROR="Orders for inactive orderables may not be changed; please enter a new order!" Q
"RTN","ORCACT01",88,0)
 I DG="O RX",$O(^OR(100,+IFN,4.5,"ID","MISC",0)) D DOSES(+IFN) ;old form
"RTN","ORCACT01",89,0)
 Q
"RTN","ORCACT01",90,0)
 ;
"RTN","ORCACT01",91,0)
INACTIVE() ; -- Returns 1 or 0, if OI is now inactive
"RTN","ORCACT01",92,0)
 N I,OI,X,Y,ORNOW,DD,PSOI S Y=0,ORNOW=$$NOW^XLFDT
"RTN","ORCACT01",93,0)
 S I=0 F  S I=+$O(^OR(100,+IFN,4.5,"ID","ORDERABLE",I)) Q:I'>0  D  Q:Y
"RTN","ORCACT01",94,0)
 . S OI=+$G(^OR(100,+IFN,4.5,I,1))
"RTN","ORCACT01",95,0)
 . I OI S X=$G(^ORD(101.43,OI,.1)) I X,X<ORNOW S Y=1
"RTN","ORCACT01",96,0)
 I Y,PKG="PS",DG'="IV RX" D  ;replacement OI?
"RTN","ORCACT01",97,0)
 . S I=+$O(^OR(100,+IFN,4.5,"ID","DRUG",0)) Q:I'>0  ;first
"RTN","ORCACT01",98,0)
 . S DD=+$G(^OR(100,+IFN,4.5,I,1)) Q:DD'>0  Q:$G(OI)'>0
"RTN","ORCACT01",99,0)
 . S PSOI=+$P($G(^ORD(101.43,OI,0)),U,2),X=$$ITEM^PSSUTIL1(PSOI,DD)
"RTN","ORCACT01",100,0)
 . Q:X'>0  S X=+$O(^ORD(101.43,"ID",+$P(X,U,2)_";99PSP",0)) Q:X'>0
"RTN","ORCACT01",101,0)
 . I $G(^ORD(101.43,X,.1)),$G(^(.1))<ORNOW Q  ;make sure new OI is active
"RTN","ORCACT01",102,0)
 . S I=+$O(^OR(100,+IFN,4.5,"ID","ORDERABLE",0))
"RTN","ORCACT01",103,0)
 . S:I ^OR(100,+IFN,4.5,I,1)=X,Y=0 ;reset
"RTN","ORCACT01",104,0)
 Q Y
"RTN","ORCACT01",105,0)
 ;
"RTN","ORCACT01",106,0)
IV() ; -- IV order, either Inpt or Fluid?
"RTN","ORCACT01",107,0)
 I DG="IV RX" Q 1
"RTN","ORCACT01",108,0)
 N I,OI,X S I=+$O(^OR(100,IFN,4.5,"ID","ORDERABLE",0))
"RTN","ORCACT01",109,0)
 S OI=+$G(^OR(100,IFN,4.5,+I,1)),X=$P($G(^ORD(101.43,+OI,"PS")),U)
"RTN","ORCACT01",110,0)
 Q (X>1)
"RTN","ORCACT01",111,0)
 ;
"RTN","ORCACT01",112,0)
NTBG(ORIFN) ; -- Inpt order marked as 'Not to be Given'?
"RTN","ORCACT01",113,0)
 N PSIFN,Y,ORI,ORCH S Y=""
"RTN","ORCACT01",114,0)
 S PSIFN=$G(^OR(100,+ORIFN,4)) I PSIFN>0 Q $$ENNG^PSJORUT2(+ORVP,PSIFN)
"RTN","ORCACT01",115,0)
 S ORI=0 F  S ORI=$O(^OR(100,+ORIFN,2,ORI)) Q:ORI'>0  S ORCH=+$G(^(ORI,0)),PSIFN=$G(^OR(100,ORCH,4)) I PSIFN>0 S Y=$$ENNG^PSJORUT2(+ORVP,PSIFN) Q:Y
"RTN","ORCACT01",116,0)
 Q Y
"RTN","ORCACT01",117,0)
 ;
"RTN","ORCACT01",118,0)
RESET(IFN,NEWOI)   ; -- Update OI if changed before renewing
"RTN","ORCACT01",119,0)
 Q:'$G(IFN)  Q:'$D(^OR(100,+IFN,0))  Q:'$G(NEWOI)
"RTN","ORCACT01",120,0)
 N I,ORIT S ORIT=+$O(^ORD(101.43,"ID",NEWOI_";99PSP",0)) Q:ORIT'>0
"RTN","ORCACT01",121,0)
 S I=$O(^OR(100,+IFN,4.5,"ID","ORDERABLE",0))
"RTN","ORCACT01",122,0)
 S:I ^OR(100,+IFN,4.5,I,1)=ORIT
"RTN","ORCACT01",123,0)
 Q
"RTN","ORCACT01",124,0)
 ;
"RTN","ORCACT01",125,0)
DOSES(IFN) ; -- Convert outpt doses, if needed
"RTN","ORCACT01",126,0)
 N ORIT,ORPSOI,ORDRUG,ORDOSE,CONJ,DOSE,ORP,ORI,ORX,UD,UNT,IDX,X,Y,DA,DIK,MATCH,DRUG,STR,MED
"RTN","ORCACT01",127,0)
 S ORIT=+$$VALUE^ORX8(+IFN,"ORDERABLE"),ORDRUG=+$$VALUE^ORX8(+IFN,"DRUG")
"RTN","ORCACT01",128,0)
 S ORPSOI=+$P($G(^ORD(101.43,ORIT,0)),U,2),DOSE=$$PTR^ORCD("OR GTX DOSE")
"RTN","ORCACT01",129,0)
 D DOSE^PSSORUTL(.ORDOSE,ORPSOI,"O",+ORVP)
"RTN","ORCACT01",130,0)
 S CONJ=$P($G(ORDOSE("MISC")),U,3) S:$L(CONJ) CONJ=" "_CONJ
"RTN","ORCACT01",131,0)
 F ORP="INSTR","MISC" S ORI=0 D  ;setup ORX(instance,ID)=DA ^ value
"RTN","ORCACT01",132,0)
 . F  S ORI=$O(^OR(100,+IFN,4.5,"ID",ORP,ORI)) Q:ORI'>0  D
"RTN","ORCACT01",133,0)
 .. S X=$G(^OR(100,+IFN,4.5,ORI,0)),ORX($P(X,U,3),ORP)=ORI_U_$G(^(1))
"RTN","ORCACT01",134,0)
 ;
"RTN","ORCACT01",135,0)
D1 S ORI=0 F  S ORI=$O(ORX(ORI)) Q:ORI'>0  D
"RTN","ORCACT01",136,0)
 . S UD=$P($G(ORX(ORI,"INSTR")),U,2),UNT=$P($G(ORX(ORI,"MISC")),U,2)
"RTN","ORCACT01",137,0)
 . S:UD="1/2" UD=.5 S:UD="1/3" UD=.33 S:UD="1/4" UD=.25 S:UD="3/4" UD=.75
"RTN","ORCACT01",138,0)
 . S:UNT?1.U1"(S)" UNT=$P(UNT,"(")_$S(UD>1:"S",1:"") ;strip trailing (s)
"RTN","ORCACT01",139,0)
 . K MATCH S MATCH=0,IDX="ORDOSE(0)"
"RTN","ORCACT01",140,0)
 . F  S IDX=$Q(@IDX) Q:IDX'?1"ORDOSE("1.N.",".N1")"  D
"RTN","ORCACT01",141,0)
 .. S Y=@IDX I $P(Y,U,3)?1"0."1.N,UD?1"."1.N S UD="0"_UD ;add leading 0 ;134
"RTN","ORCACT01",142,0)
 .. S X=UD_$S('$L(UNT):"",$P(Y,U,3):U_UNT,1:" "_UNT) S X=$$UP^XLFSTR(X)
"RTN","ORCACT01",143,0)
 .. I $P(Y,U,3,4)'=X,$P(Y,U,5)'=X Q  ;no match
"RTN","ORCACT01",144,0)
 .. I ORDRUG,$P(Y,U,6)'=ORDRUG Q  ;diff disp drug - no match
"RTN","ORCACT01",145,0)
 .. S MATCH=MATCH+1,MATCH(MATCH)=Y
"RTN","ORCACT01",146,0)
 . ;save re-formatted instructions
"RTN","ORCACT01",147,0)
 . I MATCH=1 D  Q
"RTN","ORCACT01",148,0)
 .. S Y=MATCH(1),X=$P(Y,U,5),DRUG=$G(ORDOSE("DD",+$P(Y,U,6)))
"RTN","ORCACT01",149,0)
 .. S:'Y X=X_CONJ_" "_$S($P(DRUG,U,5):$TR($P(DRUG,U,5,6),"^"),1:$P(DRUG,U))
"RTN","ORCACT01",150,0)
 .. S DA=+$G(ORX(ORI,"INSTR")) S:DA ^OR(100,+IFN,4.5,DA,1)=X
"RTN","ORCACT01",151,0)
 .. S Y=$P(Y,U,1,6)_U_$P(DRUG,U,5,6),Y=$TR(Y,"^","&")
"RTN","ORCACT01",152,0)
 .. S DA=+$G(ORX(ORI,"MISC")) Q:'DA  K ^OR(100,+IFN,4.5,"ID","MISC",DA)
"RTN","ORCACT01",153,0)
 .. S ^OR(100,+IFN,4.5,DA,0)="15^"_DOSE_U_ORI_"^DOSE",^(1)=Y
"RTN","ORCACT01",154,0)
 .. S ^OR(100,+IFN,4.5,"ID","DOSE",DA)=""
"RTN","ORCACT01",155,0)
 . S X=UD_$S($L(UNT):" "_UNT,1:""),Y=""
"RTN","ORCACT01",156,0)
 . S DA=+$G(ORX(ORI,"INSTR")) S:DA ^OR(100,+IFN,4.5,DA,1)=X
"RTN","ORCACT01",157,0)
 . S DA=+$G(ORX(ORI,"MISC")),DIK="^OR(100,"_+IFN_",4.5,",DA(1)=+IFN
"RTN","ORCACT01",158,0)
 . D:DA ^DIK ;remove old units prompt
"RTN","ORCACT01",159,0)
D2 ; -- set STR or DRUGNAME, convert DAYS
"RTN","ORCACT01",160,0)
 I ORDRUG D
"RTN","ORCACT01",161,0)
 . S DRUG=$G(ORDOSE("DD",+ORDRUG)),STR=$P(DRUG,U,5)_$P(DRUG,U,6)
"RTN","ORCACT01",162,0)
 . I STR'>0 D:'$G(ORDOSE(1)) ADD("DRUG NAME",18,$P(DRUG,U)) Q
"RTN","ORCACT01",163,0)
 . S MED=$P($G(^ORD(101.43,+$G(ORIT),0)),U)
"RTN","ORCACT01",164,0)
 . I MED'[STR D ADD("STRENGTH",7,STR)
"RTN","ORCACT01",165,0)
 S ORI=+$O(^OR(100,+IFN,4.5,"ID","DAYS",0)),X=$G(^OR(100,+IFN,4.5,ORI,1))
"RTN","ORCACT01",166,0)
 S:+X=X ^OR(100,+IFN,4.5,ORI,1)=+X_" DAYS"
"RTN","ORCACT01",167,0)
 Q
"RTN","ORCACT01",168,0)
 ;
"RTN","ORCACT01",169,0)
ADD(PRMT,DA,VAL)        ; -- Add new value to Responses
"RTN","ORCACT01",170,0)
 N HDR,TOT,I,ID,PTR
"RTN","ORCACT01",171,0)
 S HDR=$G(^OR(100,+IFN,4.5,0)),TOT=+$P(HDR,U,4)+1
"RTN","ORCACT01",172,0)
 S I=+$O(^OR(100,+IFN,4.5,"ID"),-1),I=I+1,$P(HDR,U,3,4)=I_U_TOT
"RTN","ORCACT01",173,0)
 S PTR=+$$PTR^ORCD("OR GTX "_PRMT),ID=$P($G(^ORD(101.41,PTR,1)),U,3)
"RTN","ORCACT01",174,0)
 S ^OR(100,+IFN,4.5,0)=HDR,^(I,0)=DA_U_PTR_"^1^"_ID,^(1)=VAL
"RTN","ORCACT01",175,0)
 S:$L(ID) ^OR(100,+IFN,4.5,"ID",ID,I)=""
"RTN","ORCACT01",176,0)
 Q
"RTN","ORCDPS3")
0^2^B34895081
"RTN","ORCDPS3",1,0)
ORCDPS3 ;SLC/MKB-Pharmacy dialog utilities ;09:14 AM  5 Apr 2001
"RTN","ORCDPS3",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**94,116,134**;Dec 17, 1997
"RTN","ORCDPS3",3,0)
 ;
"RTN","ORCDPS3",4,0)
START ; -- Start Date entry action
"RTN","ORCDPS3",5,0)
 S $P(ORDIALOG(PROMPT,0),":",3)=$S($G(ORCAT)="I":"ETRX",1:"EX")
"RTN","ORCDPS3",6,0)
 I $G(ORCAT)'="I" K ORSD K:$G(ORENEW)!$G(OREWRITE)!$D(OREDIT) ORDIALOG(PROMPT,INST) ;Inpt only
"RTN","ORCDPS3",7,0)
 Q
"RTN","ORCDPS3",8,0)
 ;
"RTN","ORCDPS3",9,0)
ADMIN ; -- Return default admin time for order in ORSD
"RTN","ORCDPS3",10,0)
 ;    Called from EXDOSE^ORCDPS2
"RTN","ORCDPS3",11,0)
 Q:$D(ORSD)  N PSOI,PSIFN,SCH,CNJ,ORI,ORX
"RTN","ORCDPS3",12,0)
 S PSOI=+$P($G(^ORD(101.43,+$G(OROI),0)),U,2)
"RTN","ORCDPS3",13,0)
 S PSIFN=$S($G(ORENEW):$G(^OR(100,+$G(ORIFN),4)),1:"")
"RTN","ORCDPS3",14,0)
 S SCH=$$PTR^ORCD("OR GTX SCHEDULE"),CNJ=$$PTR^ORCD("OR GTX AND/THEN"),ORX=""
"RTN","ORCDPS3",15,0)
 S ORI=0 F  S ORI=$O(ORDIALOG(PROMPT,ORI)) Q:ORI<1  S ORX=ORX_$S($L(ORX):U,1:"")_$G(ORDIALOG(CNJ,ORI))_";"_$G(ORDIALOG(SCH,ORI))
"RTN","ORCDPS3",16,0)
 S ORSD=$$FIRST(+ORVP,+$G(ORWARD),PSOI,ORX,PSIFN)
"RTN","ORCDPS3",17,0)
 S:$P(ORSD,U)="NEXT" ORSD="NEXTA^"_$P(ORSD,U,2,99)
"RTN","ORCDPS3",18,0)
 Q
"RTN","ORCDPS3",19,0)
 ;
"RTN","ORCDPS3",20,0)
FIRST(DFN,WARD,OI,DATA,ORDER)   ; -- Return expected first admin time of order
"RTN","ORCDPS3",21,0)
 N ORCNT,ORI,J,ORZ,Y,SCH,ORX I '$G(DFN)!'$G(OI) Q ""
"RTN","ORCDPS3",22,0)
 S ORCNT=0 F ORI=1:1:$L(DATA,"^") S ORZ=$P(DATA,U,ORI) D  Q:$E(ORZ)="T"
"RTN","ORCDPS3",23,0)
 . S SCH=$P(ORZ,";",2) Q:'$L(SCH)  S ORCNT=ORCNT+1
"RTN","ORCDPS3",24,0)
 . S ORX(ORCNT)=$$STARTSTP^PSJORPOE(DFN,SCH,OI,WARD,$G(ORDER))
"RTN","ORCDPS3",25,0)
 S Y=9999999,J=0
"RTN","ORCDPS3",26,0)
 F ORI=1:1:ORCNT S ORZ=$P(ORX(ORI),U,4) I ORZ<Y S Y=ORZ,J=ORI ;earliest
"RTN","ORCDPS3",27,0)
 S Y=$S(J:ORX(J),1:"")
"RTN","ORCDPS3",28,0)
 Q Y
"RTN","ORCDPS3",29,0)
 ;
"RTN","ORCDPS3",30,0)
NOW ; -- First dose now?
"RTN","ORCDPS3",31,0)
 N X,Y,DIR,SCH
"RTN","ORCDPS3",32,0)
 I $G(ORCAT)="O"!'$D(ORSD)!$L($G(OREVENT))!$G(ORENEW) K ORDIALOG(PROMPT,INST) Q
"RTN","ORCDPS3",33,0)
 ; ask on Copy? Change?
"RTN","ORCDPS3",34,0)
 S X=$$PTR^ORCD("OR GTX SCHEDULE"),Y=+$O(ORDIALOG(X,0))
"RTN","ORCDPS3",35,0)
 S SCH=$G(ORDIALOG(X,Y)),Y=+$O(^PS(51.1,"APPSJ",SCH,0)) ;1st one
"RTN","ORCDPS3",36,0)
 I $P($G(^PS(51.1,Y,0)),U,5)="O" K ORDIALOG(PROMPT,INST) Q
"RTN","ORCDPS3",37,0)
 ; other conditions?
"RTN","ORCDPS3",38,0)
 S DIR(0)="YA",DIR("A")="Give First Dose NOW? "
"RTN","ORCDPS3",39,0)
 S DIR("B")=$S($G(ORDIALOG(PROMPT,INST)):"YES",1:"NO")
"RTN","ORCDPS3",40,0)
 I ORINPT,$P(ORSD,U,4) S DIR("A",1)="Next scheduled administration time: "_$$FMTE^XLFDT($P(ORSD,U,4))
"RTN","ORCDPS3",41,0)
 S DIR("?")="Enter YES if you want a dose given now in addition to the regular administration times for this schedule and ward."
"RTN","ORCDPS3",42,0)
 D ^DIR S:$D(DTOUT)!$D(DUOUT) ORQUIT=1
"RTN","ORCDPS3",43,0)
 I $G(ORQUIT)!(Y'>0) K ORDIALOG(PROMPT,INST) Q
"RTN","ORCDPS3",44,0)
 S ORDIALOG(PROMPT,INST)=1 I $G(ORCOMPLX) D
"RTN","ORCDPS3",45,0)
 . W $C(7),!,"  >> First Dose NOW is in addition to those already entered.    <<"
"RTN","ORCDPS3",46,0)
 . W !,"  >> Please adjust the duration of the first one, if necessary. <<"
"RTN","ORCDPS3",47,0)
 Q
"RTN","ORCDPS3",48,0)
 ;
"RTN","ORCDPS3",49,0)
DEFSTRT ; -- Returns default start date/time in Y
"RTN","ORCDPS3",50,0)
 ;    Expects PROMPT,INST,ORDIALOG,ORSD to be defined
"RTN","ORCDPS3",51,0)
 ;
"RTN","ORCDPS3",52,0)
 Q:$G(ORCAT)="O"  Q:$G(ORTYPE)="Z"  ;skip if outpt or editor
"RTN","ORCDPS3",53,0)
 N LAST,STRT,DUR,D1,D2,OFF,F1,F2,UNT,Y1,Y2,I,J K Y
"RTN","ORCDPS3",54,0)
 S LAST=+$O(ORDIALOG(+$$PTR^ORCD("OR GTX INSTRUCTIONS"),INST),-1)
"RTN","ORCDPS3",55,0)
 S STRT=$G(ORDIALOG(PROMPT,LAST))
"RTN","ORCDPS3",56,0)
 I LAST'>0!'$L(STRT) S:$L($P($G(ORSD),U)) Y=$P(ORSD,U) Q  ;first inst
"RTN","ORCDPS3",57,0)
 S DUR=$G(ORDIALOG(+$$PTR^ORCD("OR GTX DURATION"),LAST))
"RTN","ORCDPS3",58,0)
 I +DUR'>0 S Y=STRT Q  ;no duration = same start
"RTN","ORCDPS3",59,0)
 S DUR=$$FMDUR(DUR) I STRT D  Q  ;FM date/time, so just add
"RTN","ORCDPS3",60,0)
 . N X,%DT S %DT="TX",X=STRT_"+"_DUR D ^%DT
"RTN","ORCDPS3",61,0)
 . I Y'>0 S Y=STRT ;error
"RTN","ORCDPS3",62,0)
 S D1=+DUR,D2=$P(DUR,D1,2) S:(STRT="NEXTA")!(STRT="CLOSEST") STRT="NOW"
"RTN","ORCDPS3",63,0)
 S OFF=$P(STRT,"+",2) I '$L(OFF) S Y=STRT_"+"_DUR Q  ;no prev offset
"RTN","ORCDPS3",64,0)
 S F1=+OFF,F2=$P(OFF,F1,2),UNT=F2,Y=STRT
"RTN","ORCDPS3",65,0)
 I D2=F2 S Y=$P(STRT,"+")_"+"_(D1+F1)_UNT Q  ;same units
"RTN","ORCDPS3",66,0)
 F I="S","'","H","D","W","M" I (F2=I)!(D2=I) S UNT=I D  Q
"RTN","ORCDPS3",67,0)
 . S:D2=UNT Y1=D1,X1=F1,X2=F2 ; Y1=# in UNT
"RTN","ORCDPS3",68,0)
 . S:F2=UNT Y1=F1,X1=D1,X2=D2 ; X1=# in other units X2
"RTN","ORCDPS3",69,0)
 . F J=1:1 S Z=$T(CONV+J) Q:Z["ZZZZ"  I $P(Z,";",3,4)=(X2_";"_UNT) S Y2=+$P(Z,";",5) Q
"RTN","ORCDPS3",70,0)
 . S Y=$P(STRT,"+")_"+"_(Y1+$S(Y2:Y2*X1,1:0))_UNT
"RTN","ORCDPS3",71,0)
 Q
"RTN","ORCDPS3",72,0)
 ;
"RTN","ORCDPS3",73,0)
FMDUR(X)        ; -- convert '# DAYS' to #D
"RTN","ORCDPS3",74,0)
 N X1,X2,Y I +X'>0 Q ""
"RTN","ORCDPS3",75,0)
 S X1=+X,X2=$P(X," ",2) S:'$L(X2) X2="DAYS"
"RTN","ORCDPS3",76,0)
 S Y=X1_$S("MINUTES"[X2:"'",1:$E(X2))
"RTN","ORCDPS3",77,0)
 Q Y
"RTN","ORCDPS3",78,0)
 ;
"RTN","ORCDPS3",79,0)
CONV ;;unit;unit;factor
"RTN","ORCDPS3",80,0)
 ;;';S;60
"RTN","ORCDPS3",81,0)
 ;;H;';60
"RTN","ORCDPS3",82,0)
 ;;H;S;3600
"RTN","ORCDPS3",83,0)
 ;;D;H;24
"RTN","ORCDPS3",84,0)
 ;;D;';1440
"RTN","ORCDPS3",85,0)
 ;;D;S;86400
"RTN","ORCDPS3",86,0)
 ;;W;D;7
"RTN","ORCDPS3",87,0)
 ;;W;H;168
"RTN","ORCDPS3",88,0)
 ;;W;';10080
"RTN","ORCDPS3",89,0)
 ;;W;S;604800
"RTN","ORCDPS3",90,0)
 ;;M;W;4
"RTN","ORCDPS3",91,0)
 ;;M;D;30
"RTN","ORCDPS3",92,0)
 ;;M;H;720
"RTN","ORCDPS3",93,0)
 ;;M;';43200
"RTN","ORCDPS3",94,0)
 ;;M;S;2592000
"RTN","ORCDPS3",95,0)
 ;;ZZZZ
"RTN","ORCDPS3",96,0)
 ;
"RTN","ORCDPS3",97,0)
ASKDUR()        ; -- Returns 1 or 0, if Duration prompt should be asked
"RTN","ORCDPS3",98,0)
 N X,Y I '$G(ORCOMPLX) K ORDIALOG(PROMPT,INST) Q 0
"RTN","ORCDPS3",99,0)
 S Y=1 G:'$L($G(ORSCH)) ADQ ;no schedule
"RTN","ORCDPS3",100,0)
 S X=+$O(^PS(51.1,"APPSJ",ORSCH,0)) G:X'>0 ADQ
"RTN","ORCDPS3",101,0)
 S:$P($G(^PS(51.1,X,0)),U,5)="O" Y=0
"RTN","ORCDPS3",102,0)
ADQ Q Y
"RTN","ORCDPS3",103,0)
 ;
"RTN","ORCDPS3",104,0)
CKDUR(X) ; -- Returns validated form of duration X, or null if invalid
"RTN","ORCDPS3",105,0)
 N X1,X2,Y,Z S Y=""
"RTN","ORCDPS3",106,0)
 S X1=+$G(X),X2=$P($G(X),X1,2) I X1'>0 Q ""
"RTN","ORCDPS3",107,0)
 S X2=$$UP^XLFSTR(X2),X2=$$STRIP^XLFSTR(X2," ") S:'$L(X2) X2="DAYS"
"RTN","ORCDPS3",108,0)
 F Z="MONTHS^&MONTHS&MONS","WEEKS^&WEEKS&WKS","DAYS^&DAYS&DYS","HOURS^&HOURS&HRS","MINUTES^&MINUTES&MINS'","SECONDS^&SECONDS&SECS" I $P(Z,U,2)[("&"_X2) S Y=$P(Z,U) Q
"RTN","ORCDPS3",109,0)
 S:$L(Y) Y=X1_" "_$S(X1=1:$E(Y,1,$L(Y)-1),1:Y) ;strip trailing 's'
"RTN","ORCDPS3",110,0)
 Q Y
"RTN","ORCDPS3",111,0)
 ;
"RTN","ORCDPS3",112,0)
DUR ; -- Process duration [from P-S Action]
"RTN","ORCDPS3",113,0)
 N X S X=$G(ORDIALOG(PROMPT,ORI)),X=$$CKDUR(X)
"RTN","ORCDPS3",114,0)
 I '$L(X) K DONE W $C(7),!,ORDIALOG(PROMPT,"?"),! Q
"RTN","ORCDPS3",115,0)
 S ORDIALOG(PROMPT,ORI)=X D:$G(ORESET)'=X CHANGED^ORCDPS1("QUANTITY")
"RTN","ORCDPS3",116,0)
 Q
"RTN","ORCDPS3",117,0)
 ;
"RTN","ORCDPS3",118,0)
TEST(START,DURTN)       ; -- test DEFSTRT
"RTN","ORCDPS3",119,0)
 N INST,ORSD,ORDIALOG,PROMPT
"RTN","ORCDPS3",120,0)
 S ORDIALOG(136,1)="",INST=2,ORSD="NOW",PROMPT=6
"RTN","ORCDPS3",121,0)
 S:$L($G(START)) ORDIALOG(6,1)=START S:$G(DURTN) ORDIALOG(153,1)=DURTN
"RTN","ORCDPS3",122,0)
 D DEFSTRT W !,Y
"RTN","ORCDPS3",123,0)
 Q
"RTN","ORCDPS3",124,0)
 ;
"RTN","ORCDPS3",125,0)
SC ; -- Dialog validation, to ask SC questions
"RTN","ORCDPS3",126,0)
 ;    Expects ORIFN, ORDA, and ORDER
"RTN","ORCDPS3",127,0)
 ;
"RTN","ORCDPS3",128,0)
 Q:'$L($T(SCNEW^PSOCP))  Q:'$G(ORIFN)  Q:'$G(ORDA)
"RTN","ORCDPS3",129,0)
 Q:$P($G(^OR(100,ORIFN,0)),U,12)'="O"  Q:$P($G(^(8,ORDA,0)),U,2)'="NW"  Q:$P($G(^(0)),U,15)=""
"RTN","ORCDPS3",130,0)
 ;
"RTN","ORCDPS3",131,0)
 N OR3,ORDRUG,PSIFN,ORX,I,J,DIE,DR,DA,X,Y,DTOUT,ORIGVIEW,DFN
"RTN","ORCDPS3",132,0)
 S OR3=$G(^OR(100,ORIFN,3)),X=$P(OR3,U,11) I X>2 Q  ;new, edit, or renew
"RTN","ORCDPS3",133,0)
 I X S Y=$P(OR3,U,5),PSIFN=$G(^OR(100,Y,4)) ;get PS# if edit/renewal
"RTN","ORCDPS3",134,0)
 S ORDRUG=$$VALUE^ORCSAVE2(ORIFN,"DRUG")
"RTN","ORCDPS3",135,0)
 D SCNEW^PSOCP(.ORX,+ORVP,ORDRUG,$G(PSIFN)) Q:'$D(ORX)
"RTN","ORCDPS3",136,0)
 S DIE="^OR(100,",DA=ORIFN,DR="",J=0
"RTN","ORCDPS3",137,0)
 F I="SC","MST","AO","IR","EC","HNC" S J=J+1 S:$D(ORX(I)) X=ORX(I),DR=DR_";5"_J_"R"_$S($L(X):"//"_$S(X:"YES",1:"NO"),1:"")
"RTN","ORCDPS3",138,0)
 S:$E(DR)=";" DR=$E(DR,2,999) Q:'$L(DR)  S ORIGVIEW=1
"RTN","ORCDPS3",139,0)
 I $D(ORX("SC")) S DFN=+ORVP D DIS^DGRPDB ;show current SC data
"RTN","ORCDPS3",140,0)
 W !!,"Is "_$$ORDITEM^ORCACT(ORDER)_" for treatment related to:"
"RTN","ORCDPS3",141,0)
 D ^DIE S:$D(DTOUT)!$D(Y) ORQUIT=1
"RTN","ORCDPS3",142,0)
 Q
"RTN","ORCSIGN")
0^3^B63663684
"RTN","ORCSIGN",1,0)
ORCSIGN ;SLC/MKB-Sign/Release orders ;10/29/01  11:44
"RTN","ORCSIGN",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**7,56,48,79,108,110,134**;Dec 17, 1997
"RTN","ORCSIGN",3,0)
EN ; -- start here
"RTN","ORCSIGN",4,0)
 I '$D(^XUSEC("ORES",DUZ)),'$D(^XUSEC("ORELSE",DUZ)),'$D(^XUSEC("OREMAS",DUZ)) W !,"Insufficient privilege!" H 1 Q
"RTN","ORCSIGN",5,0)
 N ORPTLK,ORI,NMBR,IDX,ORIFN,ORSIG,OREL,ORNATR,ORPRNT,ORPRINT,ORCHART,ORQUIT,ORERR,ORES,ORDER,OROLDSTS,ORACT,X,OR0,ORA0,ORLAB,ORWAIT,ORDA,ORWORK,ORCCNAT,ORCL,ORLR
"RTN","ORCSIGN",6,0)
 S ORPTLK=$$LOCK^ORX2(+ORVP) I 'ORPTLK W !!,$C(7),$P(ORPTLK,U,2) H 2 Q
"RTN","ORCSIGN",7,0)
 I '$G(ORNMBR) S ORNMBR=$$ORDERS^ORCHART("") Q:'ORNMBR
"RTN","ORCSIGN",8,0)
 D FREEZE^ORCMENU S VALMBCK="R" K OREBUILD
"RTN","ORCSIGN",9,0)
 I '$G(ORL) S ORL=$$FINDLOC S:'ORL ORL=$$LOCATION^ORCMENU1 G:ORL="^" ENQ
"RTN","ORCSIGN",10,0)
 S ORACT=$S($D(^XUSEC("ORES",DUZ)):"ES",$D(^XUSEC("OREMAS",DUZ)):"OC",$D(^XUSEC("ORELSE",DUZ)):$$SELSIG,1:"^") G:ORACT="^" ENQ
"RTN","ORCSIGN",11,0)
 S ORNATR=$S(ORACT="RS":$$NATURE,1:"") Q:ORNATR="^"
"RTN","ORCSIGN",12,0)
 S ORLR=+$O(^DIC(9.4,"C","LR",0))
"RTN","ORCSIGN",13,0)
 F ORI=1:1:$L(ORNMBR,",") S NMBR=$P(ORNMBR,",",ORI) I NMBR D
"RTN","ORCSIGN",14,0)
 . S IDX=$G(^TMP("OR",$J,ORTAB,"IDX",NMBR)),ORDER=$P(IDX,U)
"RTN","ORCSIGN",15,0)
 . Q:'ORDER  S:'$P(ORDER,";",2) ORDER=+ORDER_";1"
"RTN","ORCSIGN",16,0)
 . S ORIFN=+ORDER,ORDA=+$P(ORDER,";",2) K ORQUIT
"RTN","ORCSIGN",17,0)
 . D VALID Q:$G(ORQUIT)  S ORES(ORDER)=""
"RTN","ORCSIGN",18,0)
 . S:$P($G(^OR(100,ORIFN,0)),U,14)=ORLR ORES("LAB")=1
"RTN","ORCSIGN",19,0)
 . S:$P($G(^OR(100,ORIFN,8,ORDA,0)),U,4)=2 ORES("ES")=1
"RTN","ORCSIGN",20,0)
EN1 G:'$O(ORES(0)) ENQ K ORQUIT,ORWAIT
"RTN","ORCSIGN",21,0)
 D ORDCHK^ORCMENU1 G:'$O(ORES(0)) ENQ0
"RTN","ORCSIGN",22,0)
 I $G(ORQUIT) D UNLOCK G ENQ ;quit - ^ at override reason
"RTN","ORCSIGN",23,0)
 S ORSIG=$S($G(ORES("ES")):2,1:3),OREL=0
"RTN","ORCSIGN",24,0)
 I ORSIG=3 W !,"These order(s) do not require a signature."
"RTN","ORCSIGN",25,0)
 E  D  I ORSIG=2,'OREL W !,"Nothing signed or released!" D UNLOCK H 2 G ENQ
"RTN","ORCSIGN",26,0)
 . I ORACT="ES" S:$$ESIG ORSIG=1,OREL=1 Q
"RTN","ORCSIGN",27,0)
 . I ORACT="OC" S:$$ONCHART ORSIG=0,OREL=1,ORNATR="W" Q
"RTN","ORCSIGN",28,0)
 . I ORACT="RS" W:ORNATR'="I" !!,"A signature is required to RELEASE these orders; the responsible provider will",!,"be alerted to electronically sign them." S:$$ESIG ORSIG=$S(ORNATR="I":1,1:$$SIGSTS^ORX1(ORNATR)),OREL=1
"RTN","ORCSIGN",29,0)
 S ORPRNT=$$GET^XPAR("ALL","ORPF PRINT CHART COPY WHEN"),ORPRINT=0
"RTN","ORCSIGN",30,0)
 S ORCCNAT=$$CHART^ORX1($S(ORNATR="":"E",1:ORNATR)),ORCHART=0
"RTN","ORCSIGN",31,0)
 S ORLAB=0 I '$D(^XUSEC("ORES",DUZ))!$$GET^XPAR("ALL","ORPF SHOW LAB #") S ORLAB=ORLR ;show Lab# when released
"RTN","ORCSIGN",32,0)
 W !!,"Processing orders ..." D:$G(ORES("LAB")) BHS^ORMBLD(ORVP)
"RTN","ORCSIGN",33,0)
EN2 S ORDER=0 F  S ORDER=$O(ORES(ORDER)) Q:ORDER'>0  D
"RTN","ORCSIGN",34,0)
 . S OROLDSTS=$P($G(^OR(100,+ORDER,3)),U,3),OR0=$G(^(0)),ORA0=$G(^(8,+$P(ORDER,";",2),0))
"RTN","ORCSIGN",35,0)
 . N ORNP S ORNP=$P(ORA0,U,3),ORIFN=+ORDER,ORDA=+$P(ORDER,";",2)
"RTN","ORCSIGN",36,0)
 . S ORNATR=$S($P(ORA0,U,4)=3:"",1:ORNATR) ; reset nature of order for sig not reqd orders --added with patch 110
"RTN","ORCSIGN",37,0)
 . D EN^ORCSEND(ORDER,,ORSIG,OREL,ORNATR,,.ORERR),UNLK1^ORX2(ORIFN)
"RTN","ORCSIGN",38,0)
 . I $D(^TMP("ORNEW",$J,ORIFN,ORDA)) K ^(ORDA) D UNLK1^ORX2(ORIFN)
"RTN","ORCSIGN",39,0)
 . I $G(ORERR) D  S ORWAIT=1 Q
"RTN","ORCSIGN",40,0)
 . . W !!,$$ORDITEM^ORCACT(ORDER)_" "_$$STATUS(ORDER)
"RTN","ORCSIGN",41,0)
 . . W:$L($P($G(ORERR),U,2)) !,"  >> "_$P(ORERR,U,2)
"RTN","ORCSIGN",42,0)
 . I $P(ORA0,U,2)="NW",OROLDSTS=11,$P(OR0,U,14)=ORLAB,$G(^OR(100,ORIFN,4)) W !,$$ORDITEM^ORCACT(ORIFN)_"  (LB #"_+^OR(100,ORIFN,4)_")" S ORWAIT=1
"RTN","ORCSIGN",43,0)
 . I $P(ORA0,U,2)="DC",$P(OR0,U,11)=$O(^ORD(100.98,"B","DO",0)),OROLDSTS=6 D  ;dc'd active NPO
"RTN","ORCSIGN",44,0)
 . . N ORSTRT,ORDATE S ORSTRT=+$E($P($$NOW^XLFDT,".",2)_"0000",1,4)
"RTN","ORCSIGN",45,0)
 . . S ORDATE=DT D LTRAY^ORCDFH ;need late tray for reinstated diet?
"RTN","ORCSIGN",46,0)
 . D SETPRINT W "."
"RTN","ORCSIGN",47,0)
 D:$G(ORES("LAB")) BTS^ORMBLD(ORVP)
"RTN","ORCSIGN",48,0)
EN3 I $O(ORCHART(0))!$O(ORPRINT(0)) S ORCL=$$LOC^ORMEVNT I ORCL,ORCL'=ORL D
"RTN","ORCSIGN",49,0)
 . N X,Y,DIR S DIR(0)="YA",DIR("B")="YES"
"RTN","ORCSIGN",50,0)
 . S DIR("A",1)="This patient's location has been changed to "_$P($G(^SC(+ORCL,0)),U)_"."
"RTN","ORCSIGN",51,0)
 . S DIR("A")="Should the orders be printed using the new location? "
"RTN","ORCSIGN",52,0)
 . S DIR("?")="Enter NO to continue using "_$P($G(^SC(+ORL,0)),U)_" for ordering and printing, or YES to switch to the patient's current location instead"
"RTN","ORCSIGN",53,0)
 . D ^DIR S:Y ORL=ORCL
"RTN","ORCSIGN",54,0)
 D:$O(ORCHART(0)) PRINT^ORPR02(ORVP,.ORCHART,,ORL,"1^0^0^0^0")
"RTN","ORCSIGN",55,0)
 D:$O(ORPRINT(0)) PRINT^ORPR02(ORVP,.ORPRINT,,ORL,"0^1^1^1^"_$$WORK(ORNATR))
"RTN","ORCSIGN",56,0)
ENQ0 D UNOTIF S OREBUILD=1
"RTN","ORCSIGN",57,0)
ENQ D:'$D(^TMP("ORNEW",$J)) UNLOCK^ORX2(+ORVP) D:$G(ORWAIT) READ ;output
"RTN","ORCSIGN",58,0)
 Q
"RTN","ORCSIGN",59,0)
 ;
"RTN","ORCSIGN",60,0)
ESIG() ; -- Get electronic signature
"RTN","ORCSIGN",61,0)
 N CODE,X,X1,Y
"RTN","ORCSIGN",62,0)
 S CODE=$P($G(^VA(200,DUZ,20)),U,4),Y=0 I '$L(CODE) D  Q Y
"RTN","ORCSIGN",63,0)
 . W $C(7),!,"You do not have an electronic signature code."
"RTN","ORCSIGN",64,0)
 . W !,"Please contact your IRM office." ; allow to enter code here?
"RTN","ORCSIGN",65,0)
 D SIG^XUSESIG S Y=(X1'="")
"RTN","ORCSIGN",66,0)
 Q Y
"RTN","ORCSIGN",67,0)
 ;
"RTN","ORCSIGN",68,0)
ONCHART() ; -- Signed on Chart?
"RTN","ORCSIGN",69,0)
 N X,Y,DIR S DIR(0)="YA"
"RTN","ORCSIGN",70,0)
 S DIR("B")=$S($$GET^XPAR("ALL","OR SIGNED ON CHART"):"YES",1:"NO")
"RTN","ORCSIGN",71,0)
 S DIR("A")="Are you sure you want to mark these orders as already Signed on Chart? "
"RTN","ORCSIGN",72,0)
 S DIR("?")="Enter YES only if these orders have already been signed in the patient's paper chart"
"RTN","ORCSIGN",73,0)
 D ^DIR S:$D(DTOUT)!($D(DUOUT)) Y="^"
"RTN","ORCSIGN",74,0)
 Q Y
"RTN","ORCSIGN",75,0)
 ;
"RTN","ORCSIGN",76,0)
SELSIG() ; -- Select type of signature &/or release [ORELSE holders only]
"RTN","ORCSIGN",77,0)
 N X,Y,DIR,ES,ELSE
"RTN","ORCSIGN",78,0)
 D CKAUTH(.ES,.ELSE) I ES,'ELSE Q "ES" ;all may be elec signed
"RTN","ORCSIGN",79,0)
 S DIR("A")="Sign or release: ",DIR(0)="SAOM^"_$S($G(ES):"ES:Electronic Signature;",1:"")_"OC:Signed on Chart;RS:Release w/o MD Signature"
"RTN","ORCSIGN",80,0)
 S DIR("B")=$S($G(ES):"Electronic Signature",$$GET^XPAR("ALL","OR SIGNATURE DEFAULT ACTION")="OC":"Signed on Chart",1:"Release w/o MD Signature")
"RTN","ORCSIGN",81,0)
 S:$G(ES) DIR("?",1)="To electronically sign those orders that you are priviledged to, select ES."
"RTN","ORCSIGN",82,0)
 S DIR("?")="If these orders have already been signed on the paper chart, select OC.  To simply release these orders to the appropriate service for action, select RS; the requesting clinician will receive an alert to sign them."
"RTN","ORCSIGN",83,0)
 W !!,$S($G(ES):"  ES Electronic Signature  ",1:"")_"  OC Signed on Chart    RS Release w/o MD Signature",!
"RTN","ORCSIGN",84,0)
 D ^DIR S:$D(DTOUT)!($D(DUOUT))!(X="") Y="^"
"RTN","ORCSIGN",85,0)
 Q Y
"RTN","ORCSIGN",86,0)
 ;
"RTN","ORCSIGN",87,0)
CKAUTH(SIGN,NOT) ; -- Ck authorization needed
"RTN","ORCSIGN",88,0)
 N I,N,IFN,ACT S (SIGN,NOT)=0
"RTN","ORCSIGN",89,0)
 F I=1:1:$L(ORNMBR,",") S N=$P(ORNMBR,",",I) I N D
"RTN","ORCSIGN",90,0)
 . S IFN=$P($G(^TMP("OR",$J,ORTAB,"IDX",N)),U) Q:'IFN
"RTN","ORCSIGN",91,0)
 . S ACT=$P(IFN,";",2),IFN=+IFN S:ACT'>0 ACT=1
"RTN","ORCSIGN",92,0)
 . I $P($G(^OR(100,IFN,0)),U,16)<2 S SIGN=SIGN+1
"RTN","ORCSIGN",93,0)
 . E  S NOT=NOT+1
"RTN","ORCSIGN",94,0)
 Q
"RTN","ORCSIGN",95,0)
 ;
"RTN","ORCSIGN",96,0)
NATURE() ; -- Returns nature of order/activity
"RTN","ORCSIGN",97,0)
 N X,Y,DIR S DIR("A")="NATURE OF ORDER ACTIVITY: "
"RTN","ORCSIGN",98,0)
 S DIR("B")=$S($G(ORNP)=DUZ:"Policy",1:"Verbal")
"RTN","ORCSIGN",99,0)
 S DIR(0)="SAM^V:Verbal;T:Telephoned;P:Policy;"
"RTN","ORCSIGN",100,0)
 S DIR("?")="Enter how this order was requested or originated."
"RTN","ORCSIGN",101,0)
 D ^DIR S:$D(DTOUT)!($D(DUOUT)) Y="^" S:Y="P" Y="I" S:Y="T" Y="P"
"RTN","ORCSIGN",102,0)
 Q Y
"RTN","ORCSIGN",103,0)
 ;
"RTN","ORCSIGN",104,0)
SETPRINT ; -- Set print arrays
"RTN","ORCSIGN",105,0)
 I $P(^OR(100,ORIFN,3),U,3)=10 Q  ; Still delayed
"RTN","ORCSIGN",106,0)
 N Y S Y=$S($P(ORA0,U,15)=10:1,$P(ORA0,U,15)=11:1,1:0)
"RTN","ORCSIGN",107,0)
 S:Y ORPRINT=ORPRINT+1,ORPRINT(ORPRINT)=ORDER
"RTN","ORCSIGN",108,0)
 I ("R"[ORPRNT&Y)!(ORPRNT="S"&(ORSIG'=2)),ORCCNAT S ORCHART=ORCHART+1,ORCHART(ORCHART)=ORDER
"RTN","ORCSIGN",109,0)
 Q
"RTN","ORCSIGN",110,0)
 ;
"RTN","ORCSIGN",111,0)
WORK(NATR) ; -- Returns 1 or 0, to print work copies for NATR
"RTN","ORCSIGN",112,0)
 S:$G(NATR)="" NATR="E" S:'NATR NATR=+$O(^ORD(100.02,"C",NATR,0))
"RTN","ORCSIGN",113,0)
 Q +$P($G(^ORD(100.02,NATR,1)),U,5)
"RTN","ORCSIGN",114,0)
 ;
"RTN","ORCSIGN",115,0)
CHART ; -- Trigger chart signature notification
"RTN","ORCSIGN",116,0)
 N ORB S ORB=+ORVP_U_+ORIFN_U_ORNP_"^^1"
"RTN","ORCSIGN",117,0)
 D EN^OCXOERR(ORB)
"RTN","ORCSIGN",118,0)
 Q
"RTN","ORCSIGN",119,0)
 ;
"RTN","ORCSIGN",120,0)
NOTIF ; -- Trigger unsigned orders notification
"RTN","ORCSIGN",121,0)
 N ORB S ORB=+ORVP_U_+ORIFN_U_ORNP_"^^^^^1"
"RTN","ORCSIGN",122,0)
 D EN^OCXOERR(ORB)
"RTN","ORCSIGN",123,0)
 Q
"RTN","ORCSIGN",124,0)
 ;
"RTN","ORCSIGN",125,0)
UNOTIF ; -- Undo unsigned orders notification
"RTN","ORCSIGN",126,0)
 Q:$O(^OR(100,"AS",ORVP,0))  ; more left
"RTN","ORCSIGN",127,0)
 N XQAKILL,ORNIFN
"RTN","ORCSIGN",128,0)
 S ORNIFN=$O(^ORD(100.9,"B","ORDER REQUIRES ELEC SIGNATURE",0))
"RTN","ORCSIGN",129,0)
 S XQAKILL=$$XQAKILL^ORB3F1(ORNIFN) ; unsigned orders notif
"RTN","ORCSIGN",130,0)
 I $D(XQAID),$P($P(XQAID,";"),",",3)=ORNIFN D DELETE^XQALERT
"RTN","ORCSIGN",131,0)
 I '$D(XQAID) S XQAID=$P($G(^ORD(100.9,ORNIFN,0)),U,2)_","_+ORVP_","_ORNIFN D DELETEA^XQALERT K XQAID
"RTN","ORCSIGN",132,0)
 Q
"RTN","ORCSIGN",133,0)
 ;
"RTN","ORCSIGN",134,0)
VALID ; -- validate ORDER for signature/release
"RTN","ORCSIGN",135,0)
 N ORLK,ORDIALOG,OROUT,ORPKG
"RTN","ORCSIGN",136,0)
 I '$$VALID^ORCACT0(ORDER,ORACT,.ORERR,ORNATR) W !!,"Cannot sign "_$$ORDITEM^ORCACT(ORDER),!,"  >> "_ORERR S (ORQUIT,ORWAIT)=1 Q
"RTN","ORCSIGN",137,0)
 S ORLK=$$LOCK1^ORX2(ORIFN) I 'ORLK W !!,"Cannot sign "_$$ORDITEM^ORCACT(ORDER),!,"  >> "_$P(ORLK,U,2) S (ORQUIT,ORWAIT)=1 Q  ;order locked
"RTN","ORCSIGN",138,0)
 S ORDIALOG=+$P(^OR(100,ORIFN,0),U,5),ORPKG=+$P(^(0),U,14)
"RTN","ORCSIGN",139,0)
 I $P($G(^OR(100,ORIFN,8,ORDA,0)),U,15)'=11,ORPKG'=$$PKG^ORMPS1("PSO") Q
"RTN","ORCSIGN",140,0)
 S OROUT=$$MSG^ORXD(ORDIALOG) I OROUT W !!,"Cannot release "_$$ORDITEM^ORCACT(ORDER),!,"  >> "_$P(OROUT,U,2) S (ORQUIT,ORWAIT)=1 Q  ;dlg out of order
"RTN","ORCSIGN",141,0)
 I ORDA'>1,$L($G(^ORD(101.41,ORDIALOG,7))) X ^(7) ;validate new orders
"RTN","ORCSIGN",142,0)
 Q
"RTN","ORCSIGN",143,0)
 ;
"RTN","ORCSIGN",144,0)
UNLOCK ; -- Unlock orders in ORES(ORDER)
"RTN","ORCSIGN",145,0)
 N ORIFN S ORIFN=0
"RTN","ORCSIGN",146,0)
 F  S ORIFN=$O(ORES(ORIFN)) Q:ORIFN'>0  D UNLK1^ORX2(+ORIFN)
"RTN","ORCSIGN",147,0)
 Q
"RTN","ORCSIGN",148,0)
 ;
"RTN","ORCSIGN",149,0)
STATUS(ORD) ; -- return [release] status of order ORD
"RTN","ORCSIGN",150,0)
 N STS,X,Y S STS=$P($G(^OR(100,+ORD,8,+$P(ORD,";",2),0)),U,15)
"RTN","ORCSIGN",151,0)
 I STS S Y=$S(STS=10:"delayed",STS=11:"not released",STS=13:"cancelled",1:"")
"RTN","ORCSIGN",152,0)
 E  S X=$P($G(^OR(100,+ORD,3)),U,3),X=$P($G(^ORD(100.01,+X,0)),U),Y=$$LOW^XLFSTR(X)
"RTN","ORCSIGN",153,0)
 Q Y
"RTN","ORCSIGN",154,0)
 ;
"RTN","ORCSIGN",155,0)
READ ; -- Press return to continue
"RTN","ORCSIGN",156,0)
 N X,Y,DIR
"RTN","ORCSIGN",157,0)
 S DIR(0)="EA",DIR("A")="Press <return> to continue ..."
"RTN","ORCSIGN",158,0)
 D ^DIR
"RTN","ORCSIGN",159,0)
 Q
"RTN","ORCSIGN",160,0)
 ;
"RTN","ORCSIGN",161,0)
FINDLOC() ; -- Determine location from selected orders
"RTN","ORCSIGN",162,0)
 N ORI,ORN,ORIFN,ORX,ORY S ORY=""
"RTN","ORCSIGN",163,0)
 F ORI=1:1:$L(ORNMBR,",") S ORN=+$P(ORNMBR,",",ORI) I ORN D  Q:ORY="^"
"RTN","ORCSIGN",164,0)
 . S ORIFN=+$G(^TMP("OR",$J,ORTAB,"IDX",ORN)) Q:'ORIFN
"RTN","ORCSIGN",165,0)
 . S ORX=$P($G(^OR(100,ORIFN,0)),U,10) Q:'ORX  S:ORY="" ORY=ORX
"RTN","ORCSIGN",166,0)
 . I ORY'="",ORY'=ORX S ORY="^" Q  ;different loc's -> prompt
"RTN","ORCSIGN",167,0)
 Q ORY
"RTN","ORMPS1")
0^4^B53935388
"RTN","ORMPS1",1,0)
ORMPS1 ;SLC/MKB - Process Pharmacy ORM msgs cont ;11:25 AM  2 Apr 2001
"RTN","ORMPS1",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**86,92,94,116,134**;Dec 17, 1997
"RTN","ORMPS1",3,0)
UDOSE ; -- new Unit Dose order
"RTN","ORMPS1",4,0)
 N QT,DRUG,INSTR,DOSE,RTE,SCH,OI,URG,WP,DUR,STR,DRGNM,X,PSOI,PSDD,S0,ID,LDOSE,XC,NTE,S0,RXR
"RTN","ORMPS1",5,0)
 S ORDIALOG=+$O(^ORD(101.41,"AB","PSJ OR PAT OE",0))
"RTN","ORMPS1",6,0)
 S ORDG=+$O(^ORD(100.98,"B","UNIT DOSE MEDICATIONS",0))
"RTN","ORMPS1",7,0)
 S ORPKG=+$$PKG("PSJ")
"RTN","ORMPS1",8,0)
 D GETDLG1^ORCD(ORDIALOG) S QT=$G(ORQT(1))
"RTN","ORMPS1",9,0)
 S DRUG=$$PTR("DISPENSE DRUG"),INSTR=$$PTR("INSTRUCTIONS")
"RTN","ORMPS1",10,0)
 S DOSE=$$PTR("DOSE"),RTE=$$PTR("ROUTE"),SCH=$$PTR("SCHEDULE")
"RTN","ORMPS1",11,0)
 S OI=$$PTR("ORDERABLE ITEM"),URG=$$PTR("URGENCY")
"RTN","ORMPS1",12,0)
 S WP=$$PTR("WORD PROCESSING 1"),DUR=$$PTR("DURATION")
"RTN","ORMPS1",13,0)
 S STR=$$PTR("STRENGTH"),DRGNM=$$PTR("DRUG NAME")
"RTN","ORMPS1",14,0)
 ;
"RTN","ORMPS1",15,0)
UD1 S:RXO X=$P(RXO,"|",2),ORDIALOG(OI,1)=$$ORDITEM^ORM(X),PSOI=$P(X,U,4,5)
"RTN","ORMPS1",16,0)
 I '$G(ORDIALOG(OI,1)) S ORERR="Missing or invalid orderable item" Q
"RTN","ORMPS1",17,0)
 S PSDD=$P($$FIND^ORM(+RXE,3),U,4,5),ORDIALOG(DRUG,1)=+PSDD
"RTN","ORMPS1",18,0)
 S S0=$$FIND^ORM(+RXE,26)_"&"_$P($$FIND^ORM(+RXE,27),U,5)
"RTN","ORMPS1",19,0)
 S ID=$P(QT,U),LDOSE=$P(QT,U,8) I 'ID,S0 D
"RTN","ORMPS1",20,0)
 . N UNT,PTRN S UNT=$P(S0,"&",2),PTRN="1.N1"""_UNT_""""
"RTN","ORMPS1",21,0)
 . I LDOSE?@PTRN S $P(ID,"&",1,2)=+LDOSE_"&"_UNT Q  ;pre-POE orders
"RTN","ORMPS1",22,0)
 . S:$P(PSOI,U,2)'[S0 ORDIALOG(STR,1)=$TR(S0,"&")
"RTN","ORMPS1",23,0)
 I 'ID,'S0 S ORDIALOG(DRGNM,1)=$P(PSDD,U,2)
"RTN","ORMPS1",24,0)
 S:$L(ID) ORDIALOG(DOSE,1)=$P(ID,"&",1,4)_"&"_LDOSE_"&"_+PSDD_"&"_S0
"RTN","ORMPS1",25,0)
 I LDOSE="" D  I LDOSE="" S ORERR="Unable to determine instructions" Q
"RTN","ORMPS1",26,0)
 . I $G(RXC)'>0 D  Q  ;look for units/dose
"RTN","ORMPS1",27,0)
 .. S LDOSE=$P(ID,"&",3),X=$P(ID,"&",4) I 'LDOSE S LDOSE="" Q
"RTN","ORMPS1",28,0)
 .. S:'$L(X) X=$P($$FIND^ORM(+RXE,7),U,5) S:$L(X) LDOSE=LDOSE_" "_X
"RTN","ORMPS1",29,0)
 .. S ORDIALOG(DRGNM,1)=$P(PSDD,U,2) ;force use of DD
"RTN","ORMPS1",30,0)
 . F  D  Q:LDOSE'=""  S RXC=$O(@ORMSG@(RXC)) Q:'RXC  Q:$E(@ORMSG@(RXC),1,3)'="RXC"
"RTN","ORMPS1",31,0)
 .. S XC=@ORMSG@(RXC) Q:+$P($P(XC,"|",3),U,4)'=+PSOI
"RTN","ORMPS1",32,0)
 .. S LDOSE=$P(XC,"|",4)_$P($P(XC,"|",5),U,5) ;strength_units
"RTN","ORMPS1",33,0)
 S ORDIALOG(INSTR,1)=LDOSE
"RTN","ORMPS1",34,0)
UD2 S NTE=$$NTE(21) I NTE D
"RTN","ORMPS1",35,0)
 . N CNT,I S CNT=1,^TMP("ORWORD",$J,WP,1,CNT,0)=$P(@ORMSG@(NTE),"|",4)
"RTN","ORMPS1",36,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,WP,1,CNT,0)=@ORMSG@(NTE,I)
"RTN","ORMPS1",37,0)
 . S ^TMP("ORWORD",$J,WP,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",38,0)
 . S ORDIALOG(WP,1)="^TMP(""ORWORD"",$J,"_WP_",1)"
"RTN","ORMPS1",39,0)
 S RXR=$$RXR^ORMPS I 'RXR S ORERR="Missing or invalid RXR segment" Q
"RTN","ORMPS1",40,0)
 S ORDIALOG(RTE,1)=$P($P(RXR,"|",2),U,4),ORDIALOG(URG,1)=ORURG
"RTN","ORMPS1",41,0)
 S ORDIALOG(SCH,1)=$P(QT,U,2),X=$P(QT,U,3)
"RTN","ORMPS1",42,0)
 I $L(X) D  ;set only if previous order had duration
"RTN","ORMPS1",43,0)
 . N IFN S IFN=$S($G(ORIFN):+ORIFN,$P(ZRX,"|",2):+$P(ZRX,"|",2),1:0)
"RTN","ORMPS1",44,0)
 . S:$O(^OR(100,+IFN,4.5,"ID","DAYS",0)) ORDIALOG(DUR,1)=$$DURATION(X)
"RTN","ORMPS1",45,0)
 D DOSETEXT^ORCDPS2 ;reset Instructions text, SIG
"RTN","ORMPS1",46,0)
 Q
"RTN","ORMPS1",47,0)
 ;
"RTN","ORMPS1",48,0)
OUT ; -- new Outpt order
"RTN","ORMPS1",49,0)
 N OI,SIG,INSTR,DOSE,RTE,SCH,DUR,SC,STR,DRUG,PI,CONJ,PSOI,PSDD,S0,X,I,RXR,J,NTE,ZSC
"RTN","ORMPS1",50,0)
 S ORDIALOG=+$O(^ORD(101.41,"AB","PSO OERR",0))
"RTN","ORMPS1",51,0)
 S ORDG=+$O(^ORD(100.98,"B","OUTPATIENT MEDICATIONS",0))
"RTN","ORMPS1",52,0)
 S ORPKG=+$$PKG("PSO") D GETDLG1^ORCD(ORDIALOG)
"RTN","ORMPS1",53,0)
 S OI=$$PTR("ORDERABLE ITEM"),SIG=$$PTR("SIG")
"RTN","ORMPS1",54,0)
 S INSTR=$$PTR("INSTRUCTIONS"),DOSE=$$PTR("DOSE")
"RTN","ORMPS1",55,0)
 S SCH=$$PTR("SCHEDULE"),DUR=$$PTR("DURATION")
"RTN","ORMPS1",56,0)
 S RTE=$$PTR("ROUTE"),SC=$$PTR("SERVICE CONNECTED")
"RTN","ORMPS1",57,0)
 S STR=$$PTR("STRENGTH"),DRUG=$$PTR("DISPENSE DRUG")
"RTN","ORMPS1",58,0)
 S PI=$$PTR("PATIENT INSTRUCTIONS"),CONJ=$$PTR("AND/THEN")
"RTN","ORMPS1",59,0)
 ;
"RTN","ORMPS1",60,0)
 S:RXO X=$P(RXO,"|",2),ORDIALOG(OI,1)=$$ORDITEM^ORM(X),PSOI=$P(X,U,4,5)
"RTN","ORMPS1",61,0)
 I '$G(ORDIALOG(OI,1)) S ORERR="Missing or invalid orderable item" Q
"RTN","ORMPS1",62,0)
 S PSDD=$P($$FIND^ORM(+RXE,3),U,4,5),ORDIALOG(DRUG,1)=+PSDD
"RTN","ORMPS1",63,0)
 S S0=$$FIND^ORM(+RXE,26)_"&"_$P($$FIND^ORM(+RXE,27),U,5)
"RTN","ORMPS1",64,0)
 I S0,$P(PSOI,U,2)'[S0 S ORDIALOG(STR,1)=$TR(S0,"&")
"RTN","ORMPS1",65,0)
 I 'S0,'$G(ORQT(1)) S ORDIALOG($$PTR("DRUG NAME"),1)=$P(PSDD,U,2)
"RTN","ORMPS1",66,0)
OUT1 S ORDIALOG($$PTR("QUANTITY"),1)=$$FIND^ORM(+RXE,11)
"RTN","ORMPS1",67,0)
 S ORDIALOG($$PTR("REFILLS"),1)=$$FIND^ORM(+RXE,13)
"RTN","ORMPS1",68,0)
 S X=$$FIND^ORM(+RXE,23) S:$E(X)="D" X=+$E(X,2,99)
"RTN","ORMPS1",69,0)
 S:X ORDIALOG($$PTR("DAYS SUPPLY"),1)=X
"RTN","ORMPS1",70,0)
 I ZRX S X=$P(ZRX,"|",5) S:$L(X) ORDIALOG($$PTR("ROUTING"),1)=X
"RTN","ORMPS1",71,0)
 S:ORURG ORDIALOG($$PTR("URGENCY"),1)=ORURG F I=1:1:ORQT D
"RTN","ORMPS1",72,0)
 . S ORDIALOG(INSTR,I)=$P(ORQT(I),U,8),X=$P(ORQT(I),U)
"RTN","ORMPS1",73,0)
 . S:$L(X) ORDIALOG(DOSE,I)=$P(X,"&",1,4)_"&"_$P(ORQT(I),U,8)_"&"_+PSDD_"&"_S0
"RTN","ORMPS1",74,0)
 . S X=$P(ORQT(I),U,2) S:$L(X) ORDIALOG(SCH,I)=X
"RTN","ORMPS1",75,0)
 . S X=$P(ORQT(I),U,3) S:$L(X) ORDIALOG(DUR,I)=$$DURATION(X)
"RTN","ORMPS1",76,0)
 . S X=$P(ORQT(I),U,9) S:$L(X) ORDIALOG(CONJ,I)=$S(X="S":"T",1:X)
"RTN","ORMPS1",77,0)
 S RXR=$$RXR^ORMPS I RXR S ORDIALOG(RTE,1)=$P($P(RXR,"|",2),U,4) D
"RTN","ORMPS1",78,0)
 . S I=1,J=+RXR ;look for multiple RXR's
"RTN","ORMPS1",79,0)
 . F  S J=$O(@ORMSG@(J)) Q:J'>0  S RXR=@ORMSG@(J) Q:$E(RXR,1,3)'="RXR"  S I=I+1,ORDIALOG(RTE,I)=$P($P(RXR,"|",2),U,4)
"RTN","ORMPS1",80,0)
OUT2 S NTE=$$NTE(7) I NTE D
"RTN","ORMPS1",81,0)
 . N CNT,I S CNT=1,^TMP("ORWORD",$J,PI,1,CNT,0)=$P(@ORMSG@(NTE),"|",4)
"RTN","ORMPS1",82,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,PI,1,CNT,0)=@ORMSG@(NTE,I)
"RTN","ORMPS1",83,0)
 . S ^TMP("ORWORD",$J,PI,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",84,0)
 . S ORDIALOG(PI,1)="^TMP(""ORWORD"",$J,"_PI_",1)"
"RTN","ORMPS1",85,0)
 S NTE=$$NTE(21) D:NTE
"RTN","ORMPS1",86,0)
 . N CNT,I S CNT=1,^TMP("ORWORD",$J,SIG,1,CNT,0)=$P(@ORMSG@(NTE),"|",4)
"RTN","ORMPS1",87,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,SIG,1,CNT,0)=@ORMSG@(NTE,I)
"RTN","ORMPS1",88,0)
 . S ^TMP("ORWORD",$J,SIG,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",89,0)
 . S ORDIALOG(SIG,1)="^TMP(""ORWORD"",$J,"_SIG_",1)"
"RTN","ORMPS1",90,0)
 . S ORDIALOG(PI,"FORMAT")="@" ;PI already included in Sig
"RTN","ORMPS1",91,0)
 I '$G(ORQT(1))!('NTE) D DOSETEXT^ORCDPS2 ;reset Instructions text, Sig
"RTN","ORMPS1",92,0)
 S ZSC=$$ZSC,X=$P(ZSC,"|",2) I X?2.3U S ORDIALOG(SC,1)=$S(X="SC":1,1:0)
"RTN","ORMPS1",93,0)
 Q
"RTN","ORMPS1",94,0)
 ;
"RTN","ORMPS1",95,0)
IV ; -- new IV order
"RTN","ORMPS1",96,0)
 N IVTYP S IVTYP=$P(ZRX,"|",7) I IVTYP="",$$NUMADDS'>1 G UDOSE
"RTN","ORMPS1",97,0)
 N SOLN,VOL,ADDS,STR,UNITS,RATE,URG,X,X1,X2,I,J,TYPE,OI,WP,NTE,SCH
"RTN","ORMPS1",98,0)
 S ORDIALOG=+$O(^ORD(101.41,"AB","PSJI OR PAT FLUID OE",0))
"RTN","ORMPS1",99,0)
 S ORDG=+$O(^ORD(100.98,"B",$S($P(ZRX,"|",7)="TPN":"TPN",1:"IV RX"),0))
"RTN","ORMPS1",100,0)
 S ORPKG=+$$PKG("PSIV") D GETDLG1^ORCD(ORDIALOG)
"RTN","ORMPS1",101,0)
 S SOLN=$$PTR("ORDERABLE ITEM"),VOL=$$PTR("VOLUME"),SCH=$$PTR("SCHEDULE")
"RTN","ORMPS1",102,0)
 S RATE=$$PTR("INFUSION RATE") S:ORURG ORDIALOG($$PTR("URGENCY"),1)=ORURG
"RTN","ORMPS1",103,0)
 S WP=$$PTR("WORD PROCESSING 1"),ADDS=$$PTR("ADDITIVE")
"RTN","ORMPS1",104,0)
 S STR=$$PTR("STRENGTH PSIV"),UNITS=$$PTR("UNITS")
"RTN","ORMPS1",105,0)
IV1 S NTE=$$NTE(21) I NTE D
"RTN","ORMPS1",106,0)
 . N CNT,I S CNT=1,^TMP("ORWORD",$J,WP,1,CNT,0)=$P(@ORMSG@(NTE),"|",4)
"RTN","ORMPS1",107,0)
 . I $O(@ORMSG@(NTE,0)) S I=0 F  S I=$O(@ORMSG@(NTE,I)) Q:I'>0  S CNT=CNT+1,^TMP("ORWORD",$J,WP,1,CNT,0)=@ORMSG@(NTE,I)
"RTN","ORMPS1",108,0)
 . S ^TMP("ORWORD",$J,WP,1,0)="^^"_CNT_U_CNT_U_DT_U
"RTN","ORMPS1",109,0)
 . S ORDIALOG(WP,1)="^TMP(""ORWORD"",$J,"_WP_",1)"
"RTN","ORMPS1",110,0)
 S ORDIALOG(RATE,1)=$$FIND^ORM(+RXE,24)_" "_$P($$FIND^ORM(+RXE,25),U,5)
"RTN","ORMPS1",111,0)
 S (I,J)=0
"RTN","ORMPS1",112,0)
 F  D  S RXC=$O(@ORMSG@(RXC)) Q:'RXC  Q:$E(@ORMSG@(RXC),1,3)'="RXC"
"RTN","ORMPS1",113,0)
 . S X=@ORMSG@(RXC),TYPE=$P(X,"|",2),OI=$$ORDITEM^ORM($P(X,"|",3)) Q:'OI
"RTN","ORMPS1",114,0)
 . S X1=$P(X,"|",4),X2=$P($P(X,"|",5),U,5)
"RTN","ORMPS1",115,0)
 . I $E(TYPE)="B" S J=J+1,ORDIALOG(SOLN,J)=OI,ORDIALOG(VOL,J)=X1 Q
"RTN","ORMPS1",116,0)
 . S I=I+1,ORDIALOG(ADDS,I)=OI,ORDIALOG(STR,I)=X1,ORDIALOG(UNITS,I)=X2
"RTN","ORMPS1",117,0)
 I IVTYP="" S X=$P($G(ORQT(1)),U,2) S:$L(X) ORDIALOG(SCH,1)=X
"RTN","ORMPS1",118,0)
 Q
"RTN","ORMPS1",119,0)
 ;
"RTN","ORMPS1",120,0)
NTE(ID) ; -- Return subscript of NTE segment for RXE-<ID>
"RTN","ORMPS1",121,0)
 N I,SEG,Y S Y="",I=+RXE S:'$G(ID) ID=21
"RTN","ORMPS1",122,0)
 F  S I=$O(@ORMSG@(I)) Q:I'>0  S SEG=@ORMSG@(I) Q:$E(SEG,1,3)="ORC"  I $P(SEG,"|",1,2)=("NTE|"_ID) S Y=I Q
"RTN","ORMPS1",123,0)
 Q Y
"RTN","ORMPS1",124,0)
 ;
"RTN","ORMPS1",125,0)
ZSC() ; -- Return subscript of ZSC segment
"RTN","ORMPS1",126,0)
 N I,SEG,Y S Y="",I=+RXE
"RTN","ORMPS1",127,0)
 F  S I=$O(@ORMSG@(I)) Q:I'>0  S SEG=$E(@ORMSG@(I),1,3) Q:SEG="ORC"  I SEG="ZSC" S Y=I_U_@ORMSG@(I) Q
"RTN","ORMPS1",128,0)
 Q Y
"RTN","ORMPS1",129,0)
 ;
"RTN","ORMPS1",130,0)
NUMADDS() ; -- count number of additives to determine type
"RTN","ORMPS1",131,0)
 N CNT,I,X S CNT=0,I=+RXE
"RTN","ORMPS1",132,0)
 F  S I=$O(@ORMSG@(I)) Q:I'>0  S X=@ORMSG@(I) Q:$P(X,"|")="ORC"  I $E(X,1,6)="RXC|A|" S CNT=CNT+1
"RTN","ORMPS1",133,0)
 Q CNT
"RTN","ORMPS1",134,0)
 ;
"RTN","ORMPS1",135,0)
PKG(NMSP) ; -- Return Package file ptr for NMSP
"RTN","ORMPS1",136,0)
 N I S I=0
"RTN","ORMPS1",137,0)
 F  S I=+$O(^DIC(9.4,"C",NMSP,I)) Q:I<1  Q:'$O(^(I,0))  ;no Addl Prefs
"RTN","ORMPS1",138,0)
 Q I
"RTN","ORMPS1",139,0)
 ;
"RTN","ORMPS1",140,0)
PTR(NAME) ; -- Returns ien of prompt NAME in Order Dialog file #101.41
"RTN","ORMPS1",141,0)
 Q +$O(^ORD(101.41,"AB",$E("OR GTX "_NAME,1,63),0))
"RTN","ORMPS1",142,0)
 ;
"RTN","ORMPS1",143,0)
DURATION(X) ; -- Returns "# units" from U# format
"RTN","ORMPS1",144,0)
 N Y,Y1,Y2 I X'?.1U1.N Q ""
"RTN","ORMPS1",145,0)
 S Y1=$E(X),Y2=+$E(X,2,$L(X)) I X=+X S Y1="D",Y2=+X
"RTN","ORMPS1",146,0)
 S Y=Y2_" "_$S(Y1="L":"MONTH",Y1="W":"WEEK",Y1="H":"HOUR",Y1="M":"MINUTE",Y1="S":"SECOND",1:"DAY")_$S(Y2>1:"S",1:"")
"RTN","ORMPS1",147,0)
 Q Y
"RTN","ORMPS1",148,0)
 ;
"RTN","ORMPS1",149,0)
QT ; -- Unpiece the Q/T field from RXE
"RTN","ORMPS1",150,0)
 I 'RXE S ORQT(1)=ORQT,ORQT=1 Q  ; nothing to reset
"RTN","ORMPS1",151,0)
 N X,Y,I,J,P,SEG,DONE K ORQT
"RTN","ORMPS1",152,0)
 S SEG=$G(@ORMSG@(+RXE)),X=$P(SEG,"|",2),(I,J,P,DONE)=0
"RTN","ORMPS1",153,0)
 F  D  Q:DONE
"RTN","ORMPS1",154,0)
 . S P=P+1,Y=$P(X,"~",P) I Y="" S DONE=1 Q
"RTN","ORMPS1",155,0)
 . I P<$L(X,"~") S I=I+1,ORQT(I)=Y Q
"RTN","ORMPS1",156,0)
 . I $L(SEG,"|")>2 S I=I+1,ORQT(I)=Y,DONE=1 Q
"RTN","ORMPS1",157,0)
 . S J=+$O(@ORMSG@(+RXE,J)) I J'>0 S I=I+1,ORQT(I)=Y,DONE=1 Q
"RTN","ORMPS1",158,0)
 . S SEG=$G(@ORMSG@(+RXE,J)),X=$P(SEG,"|"),P=1,I=I+1,ORQT(I)=Y_$P(X,"~")
"RTN","ORMPS1",159,0)
 S ORQT=I Q:'ORQT  ; else reset ORSTRT, ORSTOP, ORURG
"RTN","ORMPS1",160,0)
 S ORSTRT=$P(ORQT(1),U,4),ORSTOP=$P(ORQT(ORQT),U,5),ORURG=$P(ORQT(1),U,6)
"RTN","ORMPS1",161,0)
 S:ORSTRT ORSTRT=$$FMDATE^ORM(ORSTRT) S:ORSTOP ORSTOP=$$FMDATE^ORM(ORSTOP) S:$L(ORURG) ORURG=$$URGENCY^ORM(ORURG)
"RTN","ORMPS1",162,0)
 Q
"RTN","ORMPS2")
0^5^B30678552
"RTN","ORMPS2",1,0)
ORMPS2 ;SLC/MKB - Process Pharmacy ORM msgs cont;10:53 AM  16 May 2001 [9/28/01 1:50pm]
"RTN","ORMPS2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**94,116,129,134**;Dec 17, 1997
"RTN","ORMPS2",3,0)
 ;
"RTN","ORMPS2",4,0)
FINISHED()      ; -- new order [SN^ORMPS] due to finishing?
"RTN","ORMPS2",5,0)
 N Y,ORIG,TYPE,ORIG4 S Y=0
"RTN","ORMPS2",6,0)
 S ORIG=+$P(ZRX,"|",2),TYPE=$P(ZRX,"|",4),ORIG4=$G(^OR(100,ORIG,4))
"RTN","ORMPS2",7,0)
 I ORIG,TYPE="E",ORIG4?1.N1"P"!(ORIG4?1.N1"S") S ORIFN=+ORIG,Y=1
"RTN","ORMPS2",8,0)
 Q Y
"RTN","ORMPS2",9,0)
 ;
"RTN","ORMPS2",10,0)
WPX() ; -- Compare comments in @ORMSG@(NTE) with order ORIFN
"RTN","ORMPS2",11,0)
 ;     Returns 1 if different, or 0 if same
"RTN","ORMPS2",12,0)
 N NTE,SPINST,Y,I,J,X,X1 S Y=0
"RTN","ORMPS2",13,0)
 S NTE=+$$NTE^ORMPS1(21),SPINST=$S(NTE:$P(@ORMSG@(NTE),"|",4),1:"")
"RTN","ORMPS2",14,0)
 S I=+$O(^OR(100,+ORIFN,4.5,"ID","COMMENT",0)) I I'>0 S:$L(SPINST) Y=1 G WQ
"RTN","ORMPS2",15,0)
 S X=$G(^OR(100,+ORIFN,4.5,I,2,1,0)) ;1st line
"RTN","ORMPS2",16,0)
 I '$O(^OR(100,+ORIFN,4.5,I,2,1)) S:X'=SPINST Y=1 G WQ
"RTN","ORMPS2",17,0)
 S J=1 F  S J=$O(^OR(100,+ORIFN,4.5,I,2,J)) Q:J'>0  S X1=$G(^(J,0)) D  Q:$L(X)'<240
"RTN","ORMPS2",18,0)
 . I ($L(X)+$L(X1)+1)'>240 S X=X_" "_X1 Q
"RTN","ORMPS2",19,0)
 . S X=X_" "_$E(X1,1,239-$L(X))
"RTN","ORMPS2",20,0)
 S:X'=SPINST Y=1 ;changed
"RTN","ORMPS2",21,0)
WQ Q Y
"RTN","ORMPS2",22,0)
 ;
"RTN","ORMPS2",23,0)
IVX() ; -- Compare ORMSG to Inpt order ORIFN if IV, return 0 if 'diff or 'IV
"RTN","ORMPS2",24,0)
 N Y,RXC,PKG,OI,PSOI,XC,RATE,ORA,ORB,ORX,I,J,OI0,INST,VOL,STR,UNT
"RTN","ORMPS2",25,0)
 S RXC=$$RXC^ORMPS,Y=0 I RXC'>0 Q Y  ;not IV of any kind
"RTN","ORMPS2",26,0)
 S PKG=+$P($G(^OR(100,+ORIFN,0)),U,14)
"RTN","ORMPS2",27,0)
 I $$GET1^DIQ(9.4,PKG_",",1)'="PSIV" D  Q Y  ;not fluid
"RTN","ORMPS2",28,0)
 . I $P(ZRX,"|",7)'="" S Y=1 Q
"RTN","ORMPS2",29,0)
 . I $$NUMADDS^ORMPS1>1 S Y=1 Q
"RTN","ORMPS2",30,0)
 . S OI=$$VALUE("ORDERABLE"),PSOI=+$P($G(^ORD(101.43,+OI,0)),U,2)
"RTN","ORMPS2",31,0)
 . S XC=@ORMSG@(RXC) I PSOI'=$P(XC,U,4) S Y=1 Q
"RTN","ORMPS2",32,0)
 . N X1,X2,X3 S X1=$P(XC,"|",4),X2=$P($P(XC,"|",5),U,5)
"RTN","ORMPS2",33,0)
 . S X3=$$VALUE("INSTR") I (X1_X2)'=X3,(X1_" "_X2)'=X3 S Y=1 Q
"RTN","ORMPS2",34,0)
IV1 S RATE=$$FIND^ORM(+RXE,24),UNT=$P($$FIND^ORM(+RXE,25),U,5)
"RTN","ORMPS2",35,0)
 S:$L(UNT) RATE=RATE_" "_UNT I RATE'=$$VALUE("RATE") S Y=1 Q Y
"RTN","ORMPS2",36,0)
 S ORB=+$$PTR("ORDERABLE ITEM"),ORA=+$$PTR("ADDITIVE"),I=+RXC
"RTN","ORMPS2",37,0)
 F  S XC=@ORMSG@(I) Q:$E(XC,1,3)'="RXC"  D  S I=$O(@ORMSG@(I)) Q:I'>0
"RTN","ORMPS2",38,0)
 . S ORX($P(XC,"|",2),+$P(XC,U,4))=$P(XC,"|",4)_U_$P($P(XC,"|",5),U,5)
"RTN","ORMPS2",39,0)
 . ;ORX("A",PSOI)=str^units or ORX("B",PSOI)=volume^units
"RTN","ORMPS2",40,0)
 F I="STRENGTH","UNITS","VOLUME" D  ;ORX(I,inst)=value
"RTN","ORMPS2",41,0)
 . S J=0 F  S J=$O(^OR(100,+ORIFN,4.5,"ID",I,J)) Q:J'>0  D
"RTN","ORMPS2",42,0)
 .. S INST=+$P($G(^OR(100,+ORIFN,4.5,J,0)),U,3)
"RTN","ORMPS2",43,0)
 .. S:INST ORX(I,INST)=$G(^OR(100,+ORIFN,4.5,J,1))
"RTN","ORMPS2",44,0)
 S I=0 F  S I=$O(^OR(100,+ORIFN,4.5,"ID","ORDERABLE",I)) Q:I'>0  D  Q:Y
"RTN","ORMPS2",45,0)
 . S OI0=$G(^OR(100,+ORIFN,4.5,I,0)),OI=+$G(^(1))
"RTN","ORMPS2",46,0)
 . S PSOI=+$P($G(^ORD(101.43,OI,0)),U,2)
"RTN","ORMPS2",47,0)
 . I $P(OI0,U,2)=ORA,$G(ORX("A",PSOI)) D  Q
"RTN","ORMPS2",48,0)
 .. S INST=$P(OI0,U,3),STR=+ORX("A",PSOI),UNT=$P(ORX("A",PSOI),U,2)
"RTN","ORMPS2",49,0)
 .. I STR'=$G(ORX("STRENGTH",INST)) S Y=1 Q
"RTN","ORMPS2",50,0)
 .. I UNT'=$G(ORX("UNITS",INST)) S Y=1 Q
"RTN","ORMPS2",51,0)
 .. K ORX("A",PSOI) ;same
"RTN","ORMPS2",52,0)
 . I $P(OI0,U,2)=ORB,$G(ORX("B",PSOI)) D  Q
"RTN","ORMPS2",53,0)
 .. S INST=$P(OI0,U,3),VOL=+$G(ORX("B",PSOI))
"RTN","ORMPS2",54,0)
 .. I VOL'=$G(ORX("VOLUME",INST)) S Y=1 Q
"RTN","ORMPS2",55,0)
 .. K ORX("B",PSOI) ;same
"RTN","ORMPS2",56,0)
 . S Y=1
"RTN","ORMPS2",57,0)
 I $O(ORX("A",0))!$O(ORX("B",0)) S Y=1 ;leftover items - changed
"RTN","ORMPS2",58,0)
 Q Y
"RTN","ORMPS2",59,0)
 ;
"RTN","ORMPS2",60,0)
CHANGED()       ; -- Compare ORMSG to order ORIFN, return 1 if different
"RTN","ORMPS2",61,0)
 N X,Y,X1,ZSC,NTE,SIG,PI S Y=0
"RTN","ORMPS2",62,0)
 I $G(ORCAT)="I" D  G CHQ
"RTN","ORMPS2",63,0)
 . I $$WPX S Y=1 Q  ;Special Instructions
"RTN","ORMPS2",64,0)
 . ;S X=$$VALUE("DAYS") ;duration
"RTN","ORMPS2",65,0)
 . ;I X S X1=$$DURATION^ORMPS1($P($G(ORQT(1)),U,3)) I X'=X1 S Y=1 Q
"RTN","ORMPS2",66,0)
 . I $$IVX S Y=1 Q  ;IV fields
"RTN","ORMPS2",67,0)
 S X=$P($P(RXE,"|",3),U,4) I X'=$$VALUE("DRUG") S Y=1 G CHQ
"RTN","ORMPS2",68,0)
 I $P(RXE,"|",11)'=$$VALUE("QTY") S Y=1 G CHQ
"RTN","ORMPS2",69,0)
 I $P(RXE,"|",13)'=$$VALUE("REFILLS") S Y=1 G CHQ
"RTN","ORMPS2",70,0)
 S X=$P(RXE,"|",23) S:$E(X)="D" X=+$E(X,2,99) I X'=$$VALUE("SUPPLY") S Y=1 G CHQ
"RTN","ORMPS2",71,0)
 I $P(ZRX,"|",5)'=$$VALUE("PICKUP") S Y=1 G CHQ
"RTN","ORMPS2",72,0)
 S NTE=$$NTE^ORMPS1(21),SIG=+$O(^OR(100,+ORIFN,4.5,"ID","SIG",0)) ;verb
"RTN","ORMPS2",73,0)
 I NTE,SIG,$P($P(@ORMSG@(NTE),"|",4)," ")'=$P($G(^OR(100,+ORIFN,4.5,SIG,2,1,0))," ") S Y=1 G CHQ
"RTN","ORMPS2",74,0)
 S NTE=$$NTE^ORMPS1(7),PI=+$O(^OR(100,+ORIFN,4.5,"ID","PI",0))
"RTN","ORMPS2",75,0)
 I (NTE&'PI)!('NTE&PI) Q 1 ;added or deleted
"RTN","ORMPS2",76,0)
 I NTE,PI,$P(@ORMSG@(NTE),"|",4)'=$G(^OR(100,+ORIFN,4.5,PI,2,1,0)) S Y=1 G CHQ
"RTN","ORMPS2",77,0)
CHQ Q Y
"RTN","ORMPS2",78,0)
 ;
"RTN","ORMPS2",79,0)
VALUE(ID)       ; -- Return value of ID in ^OR(100,+ORIFN,4.5,"ID")
"RTN","ORMPS2",80,0)
 N I,Y I '$L($G(ID)) Q ""
"RTN","ORMPS2",81,0)
 S I=+$O(^OR(100,+ORIFN,4.5,"ID",ID,0))
"RTN","ORMPS2",82,0)
 S Y=$G(^OR(100,+ORIFN,4.5,I,1))
"RTN","ORMPS2",83,0)
 Q Y
"RTN","ORMPS2",84,0)
 ;
"RTN","ORMPS2",85,0)
PTR(X) ; -- Return ptr to prompt OR GTX X
"RTN","ORMPS2",86,0)
 Q +$O(^ORD(101.41,"AB","OR GTX "_X,0))
"RTN","ORMPS2",87,0)
 ;
"RTN","ORMPS2",88,0)
RO ; -- Replacement order (finished)
"RTN","ORMPS2",89,0)
 ;
"RTN","ORMPS2",90,0)
 N RXO,RXC,ORDIALOG,ORDG,ORPKG,ORDA,ORX,ORSIG,ORP,ZSC K ^TMP("ORWORD",$J)
"RTN","ORMPS2",91,0)
 I '$D(^VA(200,ORNP,0)) S ORERR="Missing or invalid ordering provider" Q
"RTN","ORMPS2",92,0)
 I 'RXE S ORERR="Missing or invalid RXE segment" Q
"RTN","ORMPS2",93,0)
 S RXO=$$RXO^ORMPS,RXC=$$RXC^ORMPS,ORIFN=+$G(ORIFN)
"RTN","ORMPS2",94,0)
 I ORIFN'>0 S ORERR="Missing or invalid order number" Q
"RTN","ORMPS2",95,0)
 D @($S(RXC:"IV",$G(ORCAT)="I":"UDOSE",1:"OUT")_"^ORMPS1") Q:$D(ORERR)
"RTN","ORMPS2",96,0)
 S ORDA=$$ACTION^ORCSAVE("XX",ORIFN,ORNP,"",ORNOW,ORWHO)
"RTN","ORMPS2",97,0)
 I ORDA'>0 S ORERR="Cannot create new order action" Q
"RTN","ORMPS2",98,0)
RO1 ; -Update sts of order to active, last action to dc/edit:
"RTN","ORMPS2",99,0)
 S ORX=ORDA F  S ORX=+$O(^OR(100,ORIFN,8,ORX),-1) Q:ORX'>0  I $D(^(ORX,0)),$P(^(0),U,15)="" Q  ;ORX=last released action
"RTN","ORMPS2",100,0)
 S:ORX $P(^OR(100,ORIFN,8,ORX,0),U,15)=12 ;dc/edit
"RTN","ORMPS2",101,0)
 S $P(^OR(100,ORIFN,3),U,7)=ORDA K ^(6)
"RTN","ORMPS2",102,0)
 D STATUS^ORCSAVE2(ORIFN,ORSTS):$G(ORSTS),SETALL^ORDD100(ORIFN):'$G(ORSTS)
"RTN","ORMPS2",103,0)
 D DATES^ORCSAVE2(ORIFN,ORSTRT,ORSTOP)
"RTN","ORMPS2",104,0)
 D RELEASE^ORCSAVE2(ORIFN,ORDA,ORNOW,ORWHO,ORNATR)
"RTN","ORMPS2",105,0)
 ; -If unsigned edit, leave XX unsigned & mark ORX as Sig Not Req'd
"RTN","ORMPS2",106,0)
 S ORSIG=$S($P($G(^OR(100,ORIFN,8,ORX,0)),U,4)'=2:1,1:0)
"RTN","ORMPS2",107,0)
 D SIGSTS^ORCSAVE2(ORIFN,ORDA):ORSIG,SIGN^ORCSAVE2(ORIFN,,,5,ORX):'ORSIG
"RTN","ORMPS2",108,0)
RO2 ; -Update responses, get/save new order text:
"RTN","ORMPS2",109,0)
 K ^OR(100,ORIFN,4.5) D RESPONSE^ORCSAVE,ORDTEXT^ORCSAVE1(ORIFN_";"_ORDA)
"RTN","ORMPS2",110,0)
 S $P(^OR(100,ORIFN,0),U,5)=ORDIALOG_";ORD(101.41,",$P(^(0),U,14)=ORPKG
"RTN","ORMPS2",111,0)
 I $P(^OR(100,ORIFN,0),U,11)'=ORDG D  ;update DG,xrefs
"RTN","ORMPS2",112,0)
 . N DA,DR,DIE
"RTN","ORMPS2",113,0)
 . S DA=ORIFN,DR="23////"_ORDG,DIE="^OR(100," D ^DIE
"RTN","ORMPS2",114,0)
 S ^OR(100,ORIFN,4)=PKGIFN,$P(^(8,ORDA,0),U,14)=ORDA
"RTN","ORMPS2",115,0)
 S ORIFN=ORIFN_";"_ORDA,ORDCNTRL="SN" ;to send NA msg back
"RTN","ORMPS2",116,0)
 I $G(ORL) S ORP(1)=ORIFN_"^1" D PRINTS^ORWD1(.ORP,+ORL)
"RTN","ORMPS2",117,0)
 I $G(ORCAT)="O" S ZSC=$$ZSC^ORMPS1 I ZSC,$P(ZSC,"|",2)'?2.3U S ^OR(100,+ORIFN,5)=$TR($P(ZSC,"|",2,7),"|","^") ;1 or 0 instead of [N]SC in #100
"RTN","ORMPS2",118,0)
 Q
"RTN","ORWDXR")
0^7^B18380223
"RTN","ORWDXR",1,0)
ORWDXR ; SLC/KCM/JDL - Utilites for Order Actions;05:33 AM  20 May 1998;2/23/98  16:18 [12/31/01 6:36pm];Mar 19 2002 ;3/28/02  07:47
"RTN","ORWDXR",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**10,85,125,131,134**;Dec 17, 1997
"RTN","ORWDXR",3,0)
 ;
"RTN","ORWDXR",4,0)
ISREL(VAL,ORIFN)        ; Return true if an order has been released
"RTN","ORWDXR",5,0)
 N STS S STS=$P(^OR(100,+ORIFN,3),U,3)
"RTN","ORWDXR",6,0)
 S VAL=$S(STS=10:0,STS=11:0,1:1)  ; false if delayed or unreleased order
"RTN","ORWDXR",7,0)
 Q
"RTN","ORWDXR",8,0)
RENEW(REC,ORIFN,ORVP,ORNP,ORL,FLDS) ; Renew an order
"RTN","ORWDXR",9,0)
 N ORDG
"RTN","ORWDXR",10,0)
 N ORDUZ,ORSTS,OREVENT,ORCAT,ORDA,ORTS,ORNEW,ORCHECK,ORLOG,ORPKG
"RTN","ORWDXR",11,0)
 N ORDIALOG,PRMT,X0
"RTN","ORWDXR",12,0)
 S ORVP=ORVP_";DPT(",ORL(2)=ORL_";SC(",ORL=ORL(2)
"RTN","ORWDXR",13,0)
 S X0=^OR(100,+ORIFN,0)
"RTN","ORWDXR",14,0)
 S ORDG=$P(X0,U,11)
"RTN","ORWDXR",15,0)
 S ORPKG=$P(X0,U,14)
"RTN","ORWDXR",16,0)
 I $P(X0,U,5)["101.41," D                        ; version 3
"RTN","ORWDXR",17,0)
 . S ORDIALOG=+$P(X0,U,5),ORCAT=$P(^OR(100,+ORIFN,0),U,12)
"RTN","ORWDXR",18,0)
 . D GETDLG^ORCD(ORDIALOG),GETORDER^ORCD(+ORIFN)
"RTN","ORWDXR",19,0)
 E  D                                            ; version 2.5 generic
"RTN","ORWDXR",20,0)
 . S ORDIALOG=$O(^ORD(101.41,"B","OR GXTEXT WORD PROCESSING ORDE",0))
"RTN","ORWDXR",21,0)
 . D GETDLG^ORCD(ORDIALOG)
"RTN","ORWDXR",22,0)
 . S PRMT=$O(^ORD(101.41,"B","OR GTX WORD PROCESSING 1",0))
"RTN","ORWDXR",23,0)
 . S ORDIALOG(PRMT,1)=$NA(^TMP("ORWORD",$J,PRMT,1))
"RTN","ORWDXR",24,0)
 . M ^TMP("ORWORD",$J,PRMT,1)=^OR(100,+ORIFN,1)
"RTN","ORWDXR",25,0)
 . S PRMT=$O(^ORD(101.41,"B","OR GTX START DATE/TIME",0))
"RTN","ORWDXR",26,0)
 . I $P(X0,U,9) S ORDIALOG(PRMT,1)=$P(X0,U,9)
"RTN","ORWDXR",27,0)
 I +FLDS(1)=999 D  ; generic order
"RTN","ORWDXR",28,0)
 . S ORDIALOG($$PTR^ORCD("OR GTX START DATE/TIME"),1)=$P(FLDS(1),U,2)
"RTN","ORWDXR",29,0)
 . S ORDIALOG($$PTR^ORCD("OR GTX STOP DATE/TIME"),1)=$P(FLDS(1),U,3)
"RTN","ORWDXR",30,0)
 I ($O(^ORD(101.41,"AB","PS MEDS",0))>0),(+FLDS(1)=130)!(+FLDS(1)=135)!(+FLDS(1)=140),'$L($G(ORDIALOG($$PTR^ORCD("OR GTX SIG"),1))) D
"RTN","ORWDXR",31,0)
 . N ORDOSE,ORDRUG,ORCAT,ORWPSOI,PROMPT,DRUG
"RTN","ORWDXR",32,0)
 . S ORCAT=$P($G(^OR(100,+ORIFN,0)),U,12)
"RTN","ORWDXR",33,0)
 . S PROMPT=$$PTR^ORCD("OR GTX INSTRUCTIONS")
"RTN","ORWDXR",34,0)
 . S ORDRUG=$G(ORDIALOG($$PTR^ORCD("OR GTX DISPENSE DRUG"),1))
"RTN","ORWDXR",35,0)
 . S ORWPSOI=+$G(ORDIALOG($$PTR^ORCD("OR GTX ORDERABLE ITEM"),1))
"RTN","ORWDXR",36,0)
 . I ORWPSOI S ORWPSOI=+$P($G(^ORD(101.43,+ORWPSOI,0)),U,2)
"RTN","ORWDXR",37,0)
 . D DOSE^PSSORUTL(.ORDOSE,ORWPSOI,$S(ORCAT="I":"U",1:"O"),ORVP)       ; dflt doses
"RTN","ORWDXR",38,0)
 . D D1^ORCDPS2  ; set up ORDOSE
"RTN","ORWDXR",39,0)
 . S DRUG=$G(ORDOSE("DD",+ORDRUG))
"RTN","ORWDXR",40,0)
 . I DRUG,ORCAT="O" D RESETID^ORCDPS
"RTN","ORWDXR",41,0)
 . D SIG^ORCDPS2
"RTN","ORWDXR",42,0)
 I +FLDS(1)=140 D  ; outpatient meds
"RTN","ORWDXR",43,0)
 . K ORDIALOG($$PTR^ORCD("OR GTX START DATE"),1) ; remove effective dt
"RTN","ORWDXR",44,0)
 . S ORDIALOG($$PTR^ORCD("OR GTX REFILLS"),1)=$P(FLDS(1),U,4)
"RTN","ORWDXR",45,0)
 . S ORDIALOG($$PTR^ORCD("OR GTX ROUTING"),1)=$P(FLDS(1),U,5)
"RTN","ORWDXR",46,0)
 . S PRMT=$$PTR^ORCD("OR GTX WORD PROCESSING 1")
"RTN","ORWDXR",47,0)
 . K ^TMP("ORWORD",$J,PRMT,1)
"RTN","ORWDXR",48,0)
 . S I=1 F  S I=$O(FLDS(I)) Q:'I  S ^TMP("ORWORD",$J,PRMT,1,I-1,0)=FLDS(I)
"RTN","ORWDXR",49,0)
 . S ^TMP("ORWORD",$J,PRMT,1,0)=U_U_(I-1)_U_(I-1)_U_DT_U
"RTN","ORWDXR",50,0)
 . S ORDIALOG(PRMT,1)=$NA(^TMP("ORWORD",$J,PRMT,1))
"RTN","ORWDXR",51,0)
 D RN^ORCSAVE
"RTN","ORWDXR",52,0)
 S REC="" S ORIFN=+ORIFN_";"_ORDA D GETBYIFN^ORWORR(.REC,ORIFN)
"RTN","ORWDXR",53,0)
 Q
"RTN","ORWDXR",54,0)
RNWFLDS(LST,ORIFN)      ; Return fields for renew action
"RTN","ORWDXR",55,0)
 ; LST(0)=RenewType^Start^Stop^Refills^Pickup  LST(n)=Comments
"RTN","ORWDXR",56,0)
 N X0,DG,PKG,RNWTYPE,START,STOP,REFILLS
"RTN","ORWDXR",57,0)
 S ORIFN=+ORIFN,X0=^OR(100,ORIFN,0),DG=$P(X0,U,11),PKG=$P(X0,U,14)
"RTN","ORWDXR",58,0)
 S PKG=$E($P(^DIC(9.4,PKG,0),U,2),1,2),DG=$P(^ORD(100.98,DG,0),U,3)
"RTN","ORWDXR",59,0)
 S LST(0)=$S(PKG="OR":999,PKG="PS"&(DG="O RX"):140,PKG="PS"&(DG="UD RX"):130,1:0)
"RTN","ORWDXR",60,0)
 I +LST(0)=140 D
"RTN","ORWDXR",61,0)
 . S LST(0)=LST(0)_U_U_U_+$$VAL(ORIFN,"REFILLS")_U_$$VAL(ORIFN,"PICKUP")
"RTN","ORWDXR",62,0)
 . D WPVAL(.LST,ORIFN,"COMMENT")
"RTN","ORWDXR",63,0)
 I +LST(0)=999 S LST(0)=LST(0)_U_$$VAL(ORIFN,"START")_U_$$VAL(ORIFN,"STOP")
"RTN","ORWDXR",64,0)
 ; make sure start/stop times are relative times, otherwise use NOW, no Stop
"RTN","ORWDXR",65,0)
 I +$P(LST(0),U,2) S $P(LST(0),U,2)="NOW"
"RTN","ORWDXR",66,0)
 I +$P(LST(0),U,3)!($P(LST(0),U,3)="0") S $P(LST(0),U,3)=""
"RTN","ORWDXR",67,0)
 Q
"RTN","ORWDXR",68,0)
VAL(ORIFN,ID)   ; Return value for order response
"RTN","ORWDXR",69,0)
 N DA S DA=+$O(^OR(100,ORIFN,4.5,"ID",ID,0))
"RTN","ORWDXR",70,0)
 Q $G(^OR(100,ORIFN,4.5,DA,1))
"RTN","ORWDXR",71,0)
WPVAL(TXT,ORIFN,ID)    ; Return word processing value
"RTN","ORWDXR",72,0)
 N DA S DA=+$O(^OR(100,ORIFN,4.5,"ID",ID,0))
"RTN","ORWDXR",73,0)
 S I=0 F  S I=$O(^OR(100,ORIFN,4.5,DA,2,I)) Q:'I  S TXT(I)=^(I,0)
"RTN","ORWDXR",74,0)
 Q
"RTN","ORWDXR",75,0)
CHKACT(ORDERID,ORWSIG,ORWREL,ORWNATR) ; Return error if can't sign/release order
"RTN","ORWDXR",76,0)
 N ORACT,ORWERR
"RTN","ORWDXR",77,0)
 ; begin case
"RTN","ORWDXR",78,0)
 S ORACT=""
"RTN","ORWDXR",79,0)
 I (ORWSIG=1),$D(^XUSEC("ORES",DUZ)) S ORACT="ES" G XC1
"RTN","ORWDXR",80,0)
 I ORWREL,(ORWNATR="W") S ORACT="OC" G XC1
"RTN","ORWDXR",81,0)
 I ORWREL S ORACT="RS" S:$P($G(^OR(100,+ORDERID,0)),U,16)<2 ORACT="ES"
"RTN","ORWDXR",82,0)
XC1 ; end case
"RTN","ORWDXR",83,0)
 S ORWERR=""
"RTN","ORWDXR",84,0)
 I $L(ORACT),$$VALID^ORCACT0(ORDERID,ORACT,.ORWERR,ORWNATR) S ORWERR=""
"RTN","ORWDXR",85,0)
 Q ORWERR
"RTN","ORWDXR",86,0)
GTORITM(Y,ORIFN)        ;-- Get back the orderable item IEN
"RTN","ORWDXR",87,0)
 S ORIFN=+ORIFN
"RTN","ORWDXR",88,0)
 S Y=$$VALUE^ORCSAVE2(ORIFN,"ORDERABLE")
"RTN","ORWDXR",89,0)
 Q
"RTN","ORWDXR",90,0)
GETPKG(Y,IFN) ;Get package for an order
"RTN","ORWDXR",91,0)
 N ORDERID,PKGID
"RTN","ORWDXR",92,0)
 Q:+IFN<1
"RTN","ORWDXR",93,0)
 S ORDERID=+IFN,Y=""
"RTN","ORWDXR",94,0)
 S PKGID=$P(^OR(100,ORDERID,0),U,14)
"RTN","ORWDXR",95,0)
 S:PKGID>0 Y=$P(^DIC(9.4,PKGID,0),U,2)
"RTN","ORWDXR",96,0)
 Q
"RTN","ORY134")
0^6^B22825556
"RTN","ORY134",1,0)
ORY134 ;SLC/DAN ;3/28/02  12:35
"RTN","ORY134",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**134**;Dec 17, 1997
"RTN","ORY134",3,0)
 ;
"RTN","ORY134",4,0)
 ;Finds current orders with incorrect fractional dose entries containing two decimal places.
"RTN","ORY134",5,0)
 ;
"RTN","ORY134",6,0)
 N ORMSG,ZTSK
"RTN","ORY134",7,0)
 S ORMSG(1)=""
"RTN","ORY134",8,0)
 S ORMSG(2)="This patch contains a post-init.  This post-init will"
"RTN","ORY134",9,0)
 S ORMSG(3)="run in the background and will identify potential fractional dose problems."
"RTN","ORY134",10,0)
 S ORMSG(4)="It will then send a mail message to the iniator and holders of the PSNMGR key"
"RTN","ORY134",11,0)
 S ORMSG(5)="indicating which orders need to be reviewed."
"RTN","ORY134",12,0)
 S ORMSG(6)=""
"RTN","ORY134",13,0)
 D MES^XPDUTL(.ORMSG)
"RTN","ORY134",14,0)
 S ZTRTN="DQ^ORY134",ZTDESC="Patch OR*3*134 database review",ZTIO="",ZTSAVE("DUZ")="",ZTDTH=$H
"RTN","ORY134",15,0)
 D ^%ZTLOAD
"RTN","ORY134",16,0)
 I $G(ZTSK) D MES^XPDUTL("Post-init queued to background as task number "_ZTSK_".")
"RTN","ORY134",17,0)
 Q
"RTN","ORY134",18,0)
 ;
"RTN","ORY134",19,0)
DQ ;Enter here for queued task
"RTN","ORY134",20,0)
 K ^TMP("ORFIX",$J)
"RTN","ORY134",21,0)
 D FIX,MAIL
"RTN","ORY134",22,0)
 K ^TMP("ORFIX",$J),^TMP("ORTXT",$J)
"RTN","ORY134",23,0)
 Q
"RTN","ORY134",24,0)
 ;
"RTN","ORY134",25,0)
FIX ;This section will identify active orders with fractional dose problems
"RTN","ORY134",26,0)
 N PAT,DATE,IEN,PTID
"RTN","ORY134",27,0)
 S PAT=""
"RTN","ORY134",28,0)
 F  S PAT=$O(^OR(100,"AC",PAT)) Q:PAT=""  D
"RTN","ORY134",29,0)
 .S DATE=0 F  S DATE=$O(^OR(100,"AC",PAT,DATE)) Q:'+DATE  D
"RTN","ORY134",30,0)
 ..S IEN=0 F  S IEN=$O(^OR(100,"AC",PAT,DATE,IEN)) Q:'+IEN  D
"RTN","ORY134",31,0)
 ...Q:$$NMSP^ORCD($P($G(^OR(100,IEN,0)),U,14))'="PS"  ;quit if not pharmacy
"RTN","ORY134",32,0)
 ...S PTID=$$PTID(PAT) Q:PTID=-1  ;get patient ID quit if referral or couldn't determine name
"RTN","ORY134",33,0)
 ...I $$VALUE^ORX8(IEN,"INSTR")["0.." I '$$UPDT S ^TMP("ORFIX",$J,$P($$STATUS^ORQOR2(IEN),U,2),PTID,IEN)=$$DRUG
"RTN","ORY134",34,0)
 Q
"RTN","ORY134",35,0)
 ;
"RTN","ORY134",36,0)
MAIL ;Send results of review in a mail message to initiator
"RTN","ORY134",37,0)
 N I,XMSUB,XMTEXT,XMDUZ,XMY,STA,IEN,PAT
"RTN","ORY134",38,0)
 S XMSUB="Patch OR*3*134 review completed"
"RTN","ORY134",39,0)
 S XMDUZ="Patch OR*3*134 Post-Init"
"RTN","ORY134",40,0)
 S XMY(.5)="" S:$G(DUZ) XMY(DUZ)="" D PSNMGR(.XMY)
"RTN","ORY134",41,0)
 S XMTEXT="^TMP(""ORTXT"",$J,"
"RTN","ORY134",42,0)
 K ^TMP("ORTXT",$J)
"RTN","ORY134",43,0)
 S I=1
"RTN","ORY134",44,0)
 S ^TMP("ORTXT",$J,I)="The database review for patch OR*3*134 has completed.",I=I+1
"RTN","ORY134",45,0)
 S ^TMP("ORTXT",$J,I)="Below is a listing of patients that need to have",I=I+1
"RTN","ORY134",46,0)
 S ^TMP("ORTXT",$J,I)="their prescriptions reviewed and possibly updated.",I=I+1
"RTN","ORY134",47,0)
 S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY134",48,0)
 S ^TMP("ORTXT",$J,I)="For orders in an active (active, pending, hold, etc) state it is",I=I+1
"RTN","ORY134",49,0)
 S ^TMP("ORTXT",$J,I)="recommended that the order be evaluated and updated according to",I=I+1
"RTN","ORY134",50,0)
 S ^TMP("ORTXT",$J,I)="the following guidelines.",I=I+1
"RTN","ORY134",51,0)
 S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY134",52,0)
 S ^TMP("ORTXT",$J,I)="If the order has refills remaining or if the order can",I=I+1
"RTN","ORY134",53,0)
 S ^TMP("ORTXT",$J,I)="potentially be renewed, edit the invalid dosage which will",I=I+1
"RTN","ORY134",54,0)
 S ^TMP("ORTXT",$J,I)="create a new order with a valid SIG.  The appropriate number",I=I+1
"RTN","ORY134",55,0)
 S ^TMP("ORTXT",$J,I)="of remaining refills must then be added to the new order.",I=I+1
"RTN","ORY134",56,0)
 S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY134",57,0)
 S ^TMP("ORTXT",$J,I)="If the order has no refills remaining and the order will not",I=I+1
"RTN","ORY134",58,0)
 S ^TMP("ORTXT",$J,I)="be renewed then the order should be discontinued.",I=I+1
"RTN","ORY134",59,0)
 S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY134",60,0)
 S ^TMP("ORTXT",$J,I)="Depending on the status of the order the DRUG listed in the report",I=I+1
"RTN","ORY134",61,0)
 S ^TMP("ORTXT",$J,I)="will either be a dispense drug or an orderable item.",I=I+1
"RTN","ORY134",62,0)
 S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY134",63,0)
 I '$D(^TMP("ORFIX",$J)) S ^TMP("ORTXT",$J,I)="No problems were found.  No manual intervention is required.",I=I+1
"RTN","ORY134",64,0)
 S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY134",65,0)
 S STA="" F  S STA=$O(^TMP("ORFIX",$J,STA)) Q:STA=""  D
"RTN","ORY134",66,0)
 .S ^TMP("ORTXT",$J,I)="Order Status - "_STA,I=I+1,^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY134",67,0)
 .S PAT=0 F  S PAT=$O(^TMP("ORFIX",$J,STA,PAT)) Q:PAT=""  D
"RTN","ORY134",68,0)
 ..S IEN=0 F  S IEN=$O(^TMP("ORFIX",$J,STA,PAT,IEN)) Q:'+IEN  D
"RTN","ORY134",69,0)
 ...S ^TMP("ORTXT",$J,I)=PAT_$$REPEAT^XLFSTR(" ",(40-$L(PAT)))_"DRUG = "_^TMP("ORFIX",$J,STA,PAT,IEN),I=I+1
"RTN","ORY134",70,0)
 .S ^TMP("ORTXT",$J,I)="",I=I+1
"RTN","ORY134",71,0)
 D ^XMD ;send results
"RTN","ORY134",72,0)
 Q
"RTN","ORY134",73,0)
 ;
"RTN","ORY134",74,0)
PTID(IEN) ;Return pt name and 1A4U identifiers or -1 if unable to determine
"RTN","ORY134",75,0)
 N DFN,VADM
"RTN","ORY134",76,0)
 I +IEN=0!(IEN'["DPT") Q -1
"RTN","ORY134",77,0)
 S DFN=+IEN
"RTN","ORY134",78,0)
 D ^VADPT
"RTN","ORY134",79,0)
 I $G(VADM(1))="" Q -1
"RTN","ORY134",80,0)
 Q $E(VADM(1),1)_$E(VADM(2),6,9)_"  "_VADM(1)
"RTN","ORY134",81,0)
 ;
"RTN","ORY134",82,0)
UPDT() ;Function to determine if order has been updated yet.
"RTN","ORY134",83,0)
 N TXT,I,UPDT
"RTN","ORY134",84,0)
 S UPDT=1
"RTN","ORY134",85,0)
 D TEXT^ORQ12(.TXT,IEN_";"_$P($G(^OR(100,IEN,3)),U,7),80) ;get current order text
"RTN","ORY134",86,0)
 F I=1:1:TXT I TXT(I)["0.." S UPDT=0 Q
"RTN","ORY134",87,0)
 Q UPDT
"RTN","ORY134",88,0)
 ;
"RTN","ORY134",89,0)
DRUG() ;Get dispense drug or orderable item
"RTN","ORY134",90,0)
 N VALUE
"RTN","ORY134",91,0)
 S VALUE=$$VALUE^ORX8(IEN,"DRUG",,"E")
"RTN","ORY134",92,0)
 I VALUE="" S VALUE=$$VALUE^ORX8(IEN,"ORDERABLE",,"E")
"RTN","ORY134",93,0)
 Q VALUE
"RTN","ORY134",94,0)
 ;
"RTN","ORY134",95,0)
PSNMGR(XMY) ;Add PSNMGR key holders to XMY array
"RTN","ORY134",96,0)
 ;DBIA 10076 allows direct read of XUSEC
"RTN","ORY134",97,0)
 N USER
"RTN","ORY134",98,0)
 S USER=0 F  S USER=$O(^XUSEC("PSNMGR",USER)) Q:'USER  S XMY(USER)=""
"RTN","ORY134",99,0)
 Q
"VER")
8.0^22.0
**END**
**END**
