Released XU*8*286 SEQ #241
Extracted from mail message
**KIDS**:XU*8.0*286^

**INSTALL NAME**
XU*8.0*286
"BLD",661,0)
XU*8.0*286^KERNEL^0^3030408^y
"BLD",661,1,0)
^^1^1^3030212^
"BLD",661,1,1,0)
     See the National Patch Module for a complete description.
"BLD",661,4,0)
^9.64PA^^
"BLD",661,"KRN",0)
^9.67PA^8989.52^19
"BLD",661,"KRN",.4,0)
.4
"BLD",661,"KRN",.401,0)
.401
"BLD",661,"KRN",.402,0)
.402
"BLD",661,"KRN",.403,0)
.403
"BLD",661,"KRN",.5,0)
.5
"BLD",661,"KRN",.84,0)
.84
"BLD",661,"KRN",3.6,0)
3.6
"BLD",661,"KRN",3.8,0)
3.8
"BLD",661,"KRN",9.2,0)
9.2
"BLD",661,"KRN",9.8,0)
9.8
"BLD",661,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",661,"KRN",9.8,"NM",1,0)
XQ83^^0^B32884553
"BLD",661,"KRN",9.8,"NM",2,0)
XQ83R^^0^B29091533
"BLD",661,"KRN",9.8,"NM","B","XQ83",1)

"BLD",661,"KRN",9.8,"NM","B","XQ83R",2)

"BLD",661,"KRN",19,0)
19
"BLD",661,"KRN",19.1,0)
19.1
"BLD",661,"KRN",101,0)
101
"BLD",661,"KRN",409.61,0)
409.61
"BLD",661,"KRN",771,0)
771
"BLD",661,"KRN",870,0)
870
"BLD",661,"KRN",8989.51,0)
8989.51
"BLD",661,"KRN",8989.52,0)
8989.52
"BLD",661,"KRN",8994,0)
8994
"BLD",661,"KRN","B",.4,.4)

"BLD",661,"KRN","B",.401,.401)

"BLD",661,"KRN","B",.402,.402)

"BLD",661,"KRN","B",.403,.403)

"BLD",661,"KRN","B",.5,.5)

"BLD",661,"KRN","B",.84,.84)

"BLD",661,"KRN","B",3.6,3.6)

"BLD",661,"KRN","B",3.8,3.8)

"BLD",661,"KRN","B",9.2,9.2)

"BLD",661,"KRN","B",9.8,9.8)

"BLD",661,"KRN","B",19,19)

"BLD",661,"KRN","B",19.1,19.1)

"BLD",661,"KRN","B",101,101)

"BLD",661,"KRN","B",409.61,409.61)

"BLD",661,"KRN","B",771,771)

"BLD",661,"KRN","B",870,870)

"BLD",661,"KRN","B",8989.51,8989.51)

"BLD",661,"KRN","B",8989.52,8989.52)

"BLD",661,"KRN","B",8994,8994)

"MBREQ")
0
"PKG",3,-1)
1^1
"PKG",3,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",3,20,0)
^9.402P^^0
"PKG",3,22,0)
^9.49I^1^1
"PKG",3,22,1,0)
8.0^2950703^2970507^.5
"PKG",3,22,1,"PAH",1,0)
286^3030408
"PKG",3,22,1,"PAH",1,1,0)
^^1^1^3030408
"PKG",3,22,1,"PAH",1,1,1,0)
     See the National Patch Module for a complete description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","XQ83")
0^1^B32884553
"RTN","XQ83",1,0)
XQ83 ;SF-ISC.SEA/JLI/LUKE - FIND ^XUTL NODES NEEDING SURGERY ;04/08/2003  11:46
"RTN","XQ83",2,0)
 ;;8.0;KERNEL;**60,157,286**;Jul 10, 1995
"RTN","XQ83",3,0)
 Q
"RTN","XQ83",4,0)
DQ ;TaskMan entry fired by CHEK below
"RTN","XQ83",5,0)
 ;
"RTN","XQ83",6,0)
 Q:'$D(^DIC(19,"AT"))  ;Nothing to do
"RTN","XQ83",7,0)
 ;
"RTN","XQ83",8,0)
 I $D(^DIC(19,"AXQ","P0"))=1 D  ;Somebody is rebuilding menus
"RTN","XQ83",9,0)
 .L +^DIC(19,"AXQ","P0"):0 ;If we can lock it the flag is bogus
"RTN","XQ83",10,0)
 .I $T L -^DIC(19,"AXQ","P0") K ^DIC(19,"AXQ","P0")
"RTN","XQ83",11,0)
 .Q
"RTN","XQ83",12,0)
 Q:$D(^DIC(19,"AXQ","P0"))=1
"RTN","XQ83",13,0)
 ;
"RTN","XQ83",14,0)
 I $D(^DIC(19,"AXQ","P0","STOP")) D
"RTN","XQ83",15,0)
 .N X,Y,Z
"RTN","XQ83",16,0)
 .S X=$G(^DIC(19,"AXQ","P0","STOP")) Q:X=""
"RTN","XQ83",17,0)
 .S Y=$H
"RTN","XQ83",18,0)
 .S Z=$$HDIFF^XLFDT(Y,X,1)
"RTN","XQ83",19,0)
 .I Z>0 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag left over from yesterday
"RTN","XQ83",20,0)
 .S Z=$$HDIFF^XLFDT(Y,X,2)
"RTN","XQ83",21,0)
 .I Z>11000 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag is over 2 hours old
"RTN","XQ83",22,0)
 .Q
"RTN","XQ83",23,0)
 Q:$D(^DIC(19,"AXQ","P0","STOP"))  ;Rebuilding - stop micro surgery
"RTN","XQ83",24,0)
 ;
"RTN","XQ83",25,0)
 S ^DIC(19,"AXQ","P0","MICRO")=$H ;Set the 'I am working' flag.
"RTN","XQ83",26,0)
 ;
"RTN","XQ83",27,0)
 D NOW^%DTC ;Returns: %=3010706.131332, %H=58626,47612, X=3010706
"RTN","XQ83",28,0)
 S X=% S %XQT1=X H 2
"RTN","XQ83",29,0)
 S XQSTART=$$HTE^XLFDT($H) ;Returns: Jul 06, 2001@13:19:20
"RTN","XQ83",30,0)
 ;
"RTN","XQ83",31,0)
 S X1=X,X2=-21 D C^%DTC F %K=0:0 S %K=$O(^DIC(19,"AT",%K)) Q:%K'>0!(%K'<X)  K ^(%K) ;Kill of those that are 21 says old
"RTN","XQ83",32,0)
 S X=DT+2 F  S X=$O(^DIC(19,"AT",X)) Q:X'>0  S %K="" F  S %K=$O(^DIC(19,"AT",X,%K)) Q:%K=""  K ^(%K) S ^DIC(19,"AT",$$NOW^XLFDT(),%K)=""
"RTN","XQ83",33,0)
 ;Kill off old "AT" nodes
"RTN","XQ83",34,0)
 ;
"RTN","XQ83",35,0)
LOOP ;Main loop
"RTN","XQ83",36,0)
 ;
"RTN","XQ83",37,0)
 ;I $D(^DIC(19,"AXQ","P0","STOP")) G KILL
"RTN","XQ83",38,0)
 K ^TMP($J) S X=%XQT,%XQX="",N=0 F %K=X:0 S %K=$O(^DIC(19,"AT",%K)) Q:%K'>0!(%K>%XQT1)  S %XQT=%K,%Z="" F %J=0:0 S %Z=$O(^DIC(19,"AT",%K,%Z)) Q:%Z=""  S N=N+1,^TMP($J,N,%Z)="",^TMP($J,"A",%Z,N)=""
"RTN","XQ83",39,0)
 ;$O through "AT" and set up lists in ^TMP, ^TMP($J,"A" is the XREF
"RTN","XQ83",40,0)
 ;
"RTN","XQ83",41,0)
 I '$D(^TMP($J)) S XQN="P0",X=%XQT D H^%DTC S %XQT=%H_","_%T F %K=0:0 S XQN=$O(^XUTL("XQO",XQN)) Q:$E(XQN)'="P"  S ^(XQN,0)=%XQT
"RTN","XQ83",42,0)
 I '$D(^TMP($J)) G KILL
"RTN","XQ83",43,0)
 ;If nothing appears in TMP quit
"RTN","XQ83",44,0)
 ;
"RTN","XQ83",45,0)
 S %Z="" F %K=0:0 S %Z=$O(^TMP($J,"A",%Z)) Q:%Z=""  F N=0:0 S N=$O(^TMP($J,"A",%Z,N)) Q:N'>0  I $O(^(N))>0 K ^TMP($J,N)
"RTN","XQ83",46,0)
 ;F N=0:0 S N=$O(^TMP($J,N)) Q:N'>0  S %Z=$O(^(N,"")),%X1=+%Z,%XC=$E(%Z,$L(%X1)+1,99),%X2=$E(%XC,2,99),XJ=$S(%XC="DIFROM":"DNUL",%XC["I":"DINS",%XC["D":"DDEL",%Z=+%Z:"DREG",%XC["S":"DSYN",%XC["P":"DPRI",1:"DNUL") D @XJ
"RTN","XQ83",47,0)
 F XQXM=0:0 S XQXM=$O(^TMP($J,XQXM)) Q:XQXM'>0  S XQOP=$O(^(XQXM,"")),XQENT=$S(XQOP["S":"SYN",XQOP["I":"INS",XQOP["D":"DEL",XQOP["P":"PRI",1:"REG") D @XQENT
"RTN","XQ83",48,0)
 ;solve the entry for the type of operation needs to be performed and
"RTN","XQ83",49,0)
 ; to that code below.
"RTN","XQ83",50,0)
 ;Remove the "AT" nodes that we processed
"RTN","XQ83",51,0)
 F XQI=0:0 S XQI=$O(^DIC(19,"AT",XQI)) Q:(XQI'<%XQT1)!(XQI<1)  K ^(XQI)
"RTN","XQ83",52,0)
 D NOW^%DTC S %XQT=%XQT1 S:%=0 %="" S %XQT1=X H 2
"RTN","XQ83",53,0)
 G LOOP
"RTN","XQ83",54,0)
 ;
"RTN","XQ83",55,0)
DINS F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"D"_%X2)))!$D(^(%X1))!$D(^(%X2)) K ^TMP($J,N) Q
"RTN","XQ83",56,0)
 I $D(^TMP($J,N)) F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"S"_%X2))) K ^TMP($J,%M)
"RTN","XQ83",57,0)
 Q
"RTN","XQ83",58,0)
DDEL F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"I"_%X2))) K ^TMP($J,N) Q
"RTN","XQ83",59,0)
 I $D(^TMP($J,N)) F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  I $D(^(%M,(%X1_"S"_%X2))) K ^TMP($J,%M)
"RTN","XQ83",60,0)
 Q
"RTN","XQ83",61,0)
DREG F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  S X=$O(^(%M,"")) I X[("I"_%X2)!(X[("S"_%X2)) K ^TMP($J,%M)
"RTN","XQ83",62,0)
 Q
"RTN","XQ83",63,0)
DSYN F %M=N:0 S %M=$O(^TMP($J,%M)) Q:%M'>0  S X=$O(^(%M,"")) I X=%X2!(X=(%X1_"I"_%X2)) K ^TMP($J,N) Q
"RTN","XQ83",64,0)
 Q
"RTN","XQ83",65,0)
DNUL K ^TMP($J,N)
"RTN","XQ83",66,0)
DPRI Q
"RTN","XQ83",67,0)
 ;
"RTN","XQ83",68,0)
DEL S XQC="D" D SPLIT D ^XQ83D Q
"RTN","XQ83",69,0)
 ;
"RTN","XQ83",70,0)
DIFROM S XQH=%XQT D QUE^XQ81
"RTN","XQ83",71,0)
 G KILL
"RTN","XQ83",72,0)
 ;
"RTN","XQ83",73,0)
INS S XQC="I" D SPLIT D ^XQ83A Q
"RTN","XQ83",74,0)
 ;
"RTN","XQ83",75,0)
SYN S XQC="S" D SPLIT D SYN^XQ83R Q
"RTN","XQ83",76,0)
 ;
"RTN","XQ83",77,0)
REG S XQC="" D REG^XQ83R Q
"RTN","XQ83",78,0)
 ;
"RTN","XQ83",79,0)
PRI ; Enter a new Primary menu
"RTN","XQ83",80,0)
 S XQC="P" D SPLIT S (A,XQDIC)="P"_XQOPM,XQVE=0,XQRB=0,XQFG1=1 K XQFG L +^XUTL("XQO",A):0 D PM1^XQ8 S ^XUTL("XQO",XQDIC,0)=%XQT1 L -^XUTL("XQO",XQDIC)
"RTN","XQ83",81,0)
 Q
"RTN","XQ83",82,0)
 ;
"RTN","XQ83",83,0)
SPLIT S XQOPM=+XQOP,XQOPI=+$P(XQOP,XQC,2),XQC1=XQOPM_","_XQOPI_",",XQC2=","_XQC1,XQOPI1=XQOPI_",",XQOPI2=","_XQOPI1 Q
"RTN","XQ83",84,0)
 ;
"RTN","XQ83",85,0)
 ;
"RTN","XQ83",86,0)
CHEKV ;First see if the compiled menus live on this system
"RTN","XQ83",87,0)
 ;If so fall through to CHEK, else quit (called by XQOO*)
"RTN","XQ83",88,0)
 Q:'$D(^XUTL("XQO"))
"RTN","XQ83",89,0)
 ;
"RTN","XQ83",90,0)
CHEK ;See if microsurgery needs to be run here
"RTN","XQ83",91,0)
 ;Called by XUS+25 and XUSG+18
"RTN","XQ83",92,0)
 ;Also kicked off by the option XQKICKMICRO
"RTN","XQ83",93,0)
 ;
"RTN","XQ83",94,0)
 Q:'$D(^DIC(19,"AT"))  ;Nothing to do
"RTN","XQ83",95,0)
 ;
"RTN","XQ83",96,0)
 I $D(^DIC(19,"AXQ","P0"))=1 D  ;Somebody is rebuilding menus
"RTN","XQ83",97,0)
 .L +^DIC(19,"AXQ","P0"):0 ;If we can lock it the flag is bogus
"RTN","XQ83",98,0)
 .I $T L -^DIC(19,"AXQ","P0") K ^DIC(19,"AXQ","P0")
"RTN","XQ83",99,0)
 .Q
"RTN","XQ83",100,0)
 Q:$D(^DIC(19,"AXQ","P0"))=1
"RTN","XQ83",101,0)
 ;
"RTN","XQ83",102,0)
 I $D(^DIC(19,"AXQ","P0","STOP")) D
"RTN","XQ83",103,0)
 .N X,Y,Z
"RTN","XQ83",104,0)
 .S X=$G(^DIC(19,"AXQ","P0","STOP")) Q:X=""
"RTN","XQ83",105,0)
 .S Y=$H
"RTN","XQ83",106,0)
 .S Z=$$HDIFF^XLFDT(Y,X,1)
"RTN","XQ83",107,0)
 .I Z>0 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag left over from yesterday
"RTN","XQ83",108,0)
 .S Z=$$HDIFF^XLFDT(Y,X,2)
"RTN","XQ83",109,0)
 .I Z>11000 K ^DIC(19,"AXQ","P0","STOP") Q  ;Flag is over 2 hours old
"RTN","XQ83",110,0)
 .Q
"RTN","XQ83",111,0)
 Q:$D(^DIC(19,"AXQ","P0","STOP"))  ;Rebuilding - stop micro surgery
"RTN","XQ83",112,0)
 ;
"RTN","XQ83",113,0)
 ;If the compiled menus do not exist on "AXQ" rebuild all of them
"RTN","XQ83",114,0)
 S %XQH=$O(^DIC(19,"AXQ","P")) I %XQH'["P" D  Q
"RTN","XQ83",115,0)
 .;S ^DIC(19,"AXQ","P0")=$H
"RTN","XQ83",116,0)
 .S ZTIO="",ZTDTH=$H,ZTRTN="QUE^XQ81",ZTSAVE("DUZ")=.5
"RTN","XQ83",117,0)
 .D SETVOL
"RTN","XQ83",118,0)
 .D ^%ZTLOAD
"RTN","XQ83",119,0)
 .Q
"RTN","XQ83",120,0)
 ;
"RTN","XQ83",121,0)
 Q:'$D(^XUTL("XQO",%XQH,0))  L ^XUTL("XQO",%XQH,0):0 I '$T K %XQH Q
"RTN","XQ83",122,0)
 ;If the first menu has a 0th node lock it, if it won't lock quit
"RTN","XQ83",123,0)
 N X S %H=$P(^XUTL("XQO",%XQH,0),U,1) D YMD^%DTC S:%>.001 %=%-.001 S:%=0 %="" S %XQT=X_%
"RTN","XQ83",124,0)
 ;Get date off first entry set %XQT (looks like: 3000414.081043)
"RTN","XQ83",125,0)
 S %XQX="",%ZO="" S:'$D(XQM) XQM=+$G(^VA(200,DUZ,201)) I XQM>0,'$D(^XUTL("XQO","P"_XQM)) S %XQX=XQM_"P",^DIC(19,"AT",%XQT+.0001,%XQX)=""
"RTN","XQ83",126,0)
 ;Set Primary menu of this user, if not there flag it in "AT" it looks
"RTN","XQ83",127,0)
 ;  like this: ^DIC(19,"AT",3000414.081143,9P)
"RTN","XQ83",128,0)
 ;I $O(^DIC(19,"AT",%XQT))>0
"RTN","XQ83",129,0)
 ;
"RTN","XQ83",130,0)
 S ^DIC(19,"AXQ","P0","MICRO")=$H,%XQX=1
"RTN","XQ83",131,0)
 S %TIM=$P($H,",")-1_","_$P($H,",",2)
"RTN","XQ83",132,0)
 L -^XUTL("XQO",%XQH,0)
"RTN","XQ83",133,0)
 ;
"RTN","XQ83",134,0)
 ;
"RTN","XQ83",135,0)
 S ZTDESC="MICRO UPDATING XUTL",ZTRTN="DQ^XQ83",ZTSAVE("%XQT")="",ZTSAVE("DUZ")=.5,ZTDTH=%TIM,ZTIO="" D:'$D(ZTCPU) SETVOL D ^%ZTLOAD
"RTN","XQ83",136,0)
 ;Unlock the node and task off DQ above and quit
"RTN","XQ83",137,0)
 ;
"RTN","XQ83",138,0)
 Q
"RTN","XQ83",139,0)
SETVOL ;
"RTN","XQ83",140,0)
 X ^%ZOSF("UCI") S ZTCPU=$P(Y,",",2),ZTUCI=$P(Y,",")
"RTN","XQ83",141,0)
 Q
"RTN","XQ83",142,0)
 ;
"RTN","XQ83",143,0)
KILL D REPORT^XQ84("MICRO")
"RTN","XQ83",144,0)
 K ^DIC(19,"AXQ","P0","MICRO")
"RTN","XQ83",145,0)
 ;
"RTN","XQ83",146,0)
 K %,%H,%J,%K,%M,%X1,%X2,%TIM,%XQT1,%XQH,%I,%T,%XQA,%XQX,%XQT,%XQX1,%XQX2,%XQY,A,B,I,I0,%Z,%ZO
"RTN","XQ83",147,0)
 K J,K,M,N,P,X1,X2,XQA,XQC,XQC1,XQC2,XQE,XQENT,XQK,XQOP,XQOPI,XQOPI1,XQOPI2
"RTN","XQ83",148,0)
 K XQI,XQH,XQFG1,XQM,XQN,XQOPM,XQOPS,XQP,XQRB,XQSTART,XQVE,XQXM,Y
"RTN","XQ83",149,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XQ83",150,0)
 Q
"RTN","XQ83R")
0^2^B29091533
"RTN","XQ83R",1,0)
XQ83R ;SF-ISC.SEA/JLI/LUKE - SURGERY ON ^XUTL("XQO", NODES FOR REGULAR MODIFICATIONS TO OPTIONS ;04/08/2003  12:12
"RTN","XQ83R",2,0)
 ;;8.0;KERNEL;**47,157,286**;Jul 10, 1995
"RTN","XQ83R",3,0)
 Q
"RTN","XQ83R",4,0)
REG S XQOPI=+XQOP,XQC1=XQOPI_",",XQC2=","_XQC1
"RTN","XQ83R",5,0)
 D TABLE^XQ83A
"RTN","XQ83R",6,0)
 N J S J=1
"RTN","XQ83R",7,0)
 S XQ83R="" F I=0:0 S I=$O(^DIC(19,"AD",XQOPI,I)) Q:I'>0  S XQ83R(J)=I,J=J+1 ;S XQ83R=XQ83R_I_","
"RTN","XQ83R",8,0)
 S A="P" F %I=0:0 S XQ83RL=0 S A=$O(^XUTL("XQO",A)) Q:$E(A)'="P"  D
"RTN","XQ83R",9,0)
 . I $D(^XUTL("XQO",A,U,XQOPI)) D  Q
"RTN","XQ83R",10,0)
 . . L +^XUTL("XQO",A):0 K ^(A,0)
"RTN","XQ83R",11,0)
 . . F XQ83RI=1:1 S XQOPM=$O(XQ83R(XQ83RI)) S:XQOPM="" ^XUTL("XQO",A,0)=%XQT1 L:XQOPM="" -^XUTL("XQO",A) Q:XQOPM=""  D ADD^XQ83A
"RTN","XQ83R",12,0)
 . F XQ83RI=1:1 S XQOPM=$O(XQ83R(XQ83RI)) Q:XQOPM=""  D
"RTN","XQ83R",13,0)
 . . I $D(^XUTL("XQO",A,"^",XQOPM)) D
"RTN","XQ83R",14,0)
 . . . I '$D(XQ83LOCK) L +^XUTL("XQO",A):0 S XQ83LOCK=1 K ^XUTL("XQO",A,0)
"RTN","XQ83R",15,0)
 . . . D ADD^XQ83A
"RTN","XQ83R",16,0)
 . I $D(XQ83LOCK) L -^XUTL("XQO",A) K XQ83LOCK S ^XUTL("XQO",A,0)=%XQT1
"RTN","XQ83R",17,0)
 .Q
"RTN","XQ83R",18,0)
 K XQ83R,XQ83RI,XQ83RL
"RTN","XQ83R",19,0)
 Q
"RTN","XQ83R",20,0)
 ;
"RTN","XQ83R",21,0)
A ;
"RTN","XQ83R",22,0)
 S B=0 F J=0:0 S B=$O(^XUTL("XQO",A,B)) Q:B=""!(B=U)  I +^(B)=XQOPI K ^(B)
"RTN","XQ83R",23,0)
 D A1
"RTN","XQ83R",24,0)
 F I=0:0 S I=$O(^XUTL("XQO",A,U,I)) Q:I'>0  D A2
"RTN","XQ83R",25,0)
 Q
"RTN","XQ83R",26,0)
A2 ;
"RTN","XQ83R",27,0)
 S L=0,%XQX=$P(^XUTL("XQO",A,U,I),U,9) I $E(%XQX,1,$L(XQC1))=XQC1!(%XQX[XQC2) S L=1
"RTN","XQ83R",28,0)
 I 'L F J=0:0 S J=$O(^XUTL("XQO",A,U,I,0,J)) Q:J'>0  S %XQX=$P(^(J),U,2) I $E(%XQX,1,$L(XQC1))=XQC1!(%XQX[XQC2) S L=1 Q
"RTN","XQ83R",29,0)
 I L S K=0 D D F J=0:0 S J=$O(^XUTL("XQO",A,U,I,0,J)) Q:J'>0  D D1
"RTN","XQ83R",30,0)
 I L I K=0 K ^XUTL("XQO",A,U,I)
"RTN","XQ83R",31,0)
 K L,K
"RTN","XQ83R",32,0)
 Q
"RTN","XQ83R",33,0)
 ;
"RTN","XQ83R",34,0)
A1 ;
"RTN","XQ83R",35,0)
 Q:$P(^DIC(19,XQOPI,0),U,3)'=""  D:'($D(^("U"))#2) UP S %XQX=^DIC(19,XQOPI,"U"),%XQX2=1 D A11
"RTN","XQ83R",36,0)
 S %XQX2=0 F M=0:0 S M=$O(^DIC(19,"AD",XQOPI,M)) Q:M'>0  S N=$O(^(M,0)) Q:N'>0  S %XQX=$S('($D(^DIC(19,M,10,N,0))#2):"",1:$P(^(0),U,2)) I %XQX'="" D A11
"RTN","XQ83R",37,0)
 Q
"RTN","XQ83R",38,0)
A11 ;
"RTN","XQ83R",39,0)
 S %XQY=%XQX F P=1:1 S %XQY=$O(^XUTL("XQO",A,%XQY)) Q:$P(%XQY,U,1)'=%XQX  Q:+$P(%XQY,U,2)'=(P-1)  I +^(%XQY)=XQOPI S P=0 Q
"RTN","XQ83R",40,0)
 I $P(%XQY,U,1)=%XQX S %XQY=$O(^XUTL("XQO",A,%XQY)) Q:$P(%XQY,U,1)'=%XQX  I +^(%XQY)=XQOPI S P=0 Q
"RTN","XQ83R",41,0)
 I P S ^XUTL("XQO",A,(%XQX_U_$S(P=1:"",1:P-1)))=XQOPI_U_%XQX2
"RTN","XQ83R",42,0)
 Q
"RTN","XQ83R",43,0)
 ;
"RTN","XQ83R",44,0)
D ;
"RTN","XQ83R",45,0)
 S XQA=$P(^XUTL("XQO",A,U,I),U,9) D GET Q:XQA=""  S ^XUTL("XQO",A,U,I)=U_$P(^DIC(19,I,0),U,1,2)_U_$S($P(^(0),U,3)]"":1,1:"")_U_$P(^(0),U,4)_U_XQA_U_XQK_U_$P(^(0),U,7,8)_U_XQP_U_XQE_U_$P(^(0),U,11,15)_U_XQF_U_$P(^(0),U,17,99),K=K+1
"RTN","XQ83R",46,0)
 Q
"RTN","XQ83R",47,0)
D1 ;
"RTN","XQ83R",48,0)
 S XQA=$P(^XUTL("XQO",A,U,I,0,J),U,2) D GET K ^XUTL("XQO",A,U,I,0,J) Q:XQA=""  I K>0 S ^(K)=XQA_U_XQK_U_XQP_U_XQE_U_XQF,K=K+1 Q
"RTN","XQ83R",49,0)
 S ^XUTL("XQO",A,U,I)=U_$P(^DIC(19,I,0),U,1,2)_U_$S($P(^(0),U,3)]"":1,1:"")_U_$P(^(0),U,4)_U_XQA_U_XQK_U_$P(^(0),U,7,8)_U_XQP_U_XQE_U_$P(^(0),U,11,15)_U_XQF_U_$P(^(0),U,17,99),K=K+1
"RTN","XQ83R",50,0)
 Q
"RTN","XQ83R",51,0)
 ;
"RTN","XQ83R",52,0)
GET ;
"RTN","XQ83R",53,0)
 S XQOOO="",(XQK,XQP,XQE,XQF)="" F M=1:1 S %XQA=$P(XQA,",",M) Q:%XQA'>0  D SUM
"RTN","XQ83R",54,0)
 S:XQOOO XQA="" K XQOOO
"RTN","XQ83R",55,0)
 Q
"RTN","XQ83R",56,0)
 ;
"RTN","XQ83R",57,0)
SUM ;
"RTN","XQ83R",58,0)
 S XQK1=$P(^DIC(19,%XQA,0),U,6),XQE1=$P(^(0),U,10),XQF1="" I $D(^(3)) S XQF1=$P(^(3),U)
"RTN","XQ83R",59,0)
 S XQK=$S(XQK'=""&(XQK1'=""):XQK_","_XQK1,1:XQK_XQK1),XQE=$S(XQE'=""&(XQE1'=""):XQE_","_XQE1,1:XQE_XQE1),XQF=$S(XQF'=""&(XQF1'=""):XQF_","_XQF1,1:XQF_XQF1)
"RTN","XQ83R",60,0)
 S XQOOO=$S($P(^DIC(19,%XQA,0),U,3)'="":1,1:XQOOO)
"RTN","XQ83R",61,0)
 S XQP1="" F I=0:0 S I=$O(^DIC(19,%XQA,3.91,I)) Q:I'>0  S XQP1=$S(XQP1'="":XQP1_";",1:"")_$P(^(I,0),U)_$P(^(0),U,2)
"RTN","XQ83R",62,0)
 S:XQP1="" XQP1=$P(^DIC(19,%XQA,0),U,9) S XQP=$S(XQP1'=""&(XQP'=""):XQP_";"_XQP1,1:XQP_XQP1)
"RTN","XQ83R",63,0)
 Q
"RTN","XQ83R",64,0)
 ;
"RTN","XQ83R",65,0)
UP S X=$P(^DIC(19,XQOPI,0),U,2) I X'?.PUN S X=$$UP^XLFSTR(X) ;F Z=1:1 Q:X?.NUP  S W=$A(X,Z) I W<123,W>96 S X=$E(X,1,Z-1)_$C(W-32)_$E(X,Z+1,255)
"RTN","XQ83R",66,0)
 S X=$E(X,1,30),^DIC(19,XQOPI,"U")=X,^DIC(19,"C",X,XQOPI)=""
"RTN","XQ83R",67,0)
 Q
"RTN","XQ83R",68,0)
 ;
"RTN","XQ83R",69,0)
SYN ;
"RTN","XQ83R",70,0)
 S A="P" F S=0:0 S A=$O(^XUTL("XQO",A)) Q:$E(A)'="P"  D SYN1
"RTN","XQ83R",71,0)
 K A,S,T,XQSYN,XQNAM
"RTN","XQ83R",72,0)
 Q
"RTN","XQ83R",73,0)
SYN1 ;
"RTN","XQ83R",74,0)
 S XQNAM="",V=XQOPI_U_"0" F T=0:0 S XQNAM=$O(^XUTL("XQO",A,XQNAM)) Q:XQNAM=""!(XQNAM=U)  I ^(XQNAM)=V K ^(XQNAM)
"RTN","XQ83R",75,0)
 I $S('$D(^DIC(19,XQOPI,0)):1,$P(^(0),U,3)'="":1,1:0) S XQNAM="",V=XQOPI_U_"1" F T=0:0 S XQNAM=$O(^XUTL("XQO",A,XQNAM)) Q:XQNAM=""!(XQNAM=U)  I ^(XQNAM)=V K ^(XQNAM)
"RTN","XQ83R",76,0)
 Q:'$D(^DIC(19,XQOPI,0))  Q:$P(^DIC(19,XQOPI,0),U,3)'=""  F XQOPM=0:0 S XQOPM=$O(^DIC(19,"AD",XQOPI,XQOPM)) Q:XQOPM'>0  S XQ1=$O(^(XQOPM,0)) I $D(^DIC(19,XQOPM,10,XQ1,0)) S XQSYN=$P(^(0),U,2) I XQSYN'="" D SYN2
"RTN","XQ83R",77,0)
 Q
"RTN","XQ83R",78,0)
SYN2 ;
"RTN","XQ83R",79,0)
 Q:'$D(^XUTL("XQO",A,U,XQOPI))  S XQSYN2A=","_XQOPM_","_XQOPI_","
"RTN","XQ83R",80,0)
 S XQSYN2=$S($P(A,"P",2)=XQOPM:1,(","_$P(^XUTL("XQO",A,U,XQOPI),U,9))[XQSYN2A:1,1:0) F T=0:0 Q:XQSYN2  S T=$O(^XUTL("XQO",A,U,XQOPI,0,T)) Q:T'>0  I (","_$P(^(T),U,2))[XQSYN2A S XQSYN2=1
"RTN","XQ83R",81,0)
 K XQSYN2A I 'XQSYN2 K T,XQSYN2 Q
"RTN","XQ83R",82,0)
 S XQLAST=XQOPI,V=XQLAST_U_"0",XQSYNY=XQSYN D SYN3 K XQLAST,V,XQSYNY,XQSYN2
"RTN","XQ83R",83,0)
 Q
"RTN","XQ83R",84,0)
SYN3 S XQNAM=XQSYNY_"]]]]]]]]]]]" F XQ83RT=1:1 S XQNAM=$O(^XUTL("XQO",A,XQNAM)) Q:$P(XQNAM,U,1)'=XQSYNY  I +^(XQNAM)=+V S XQ83RT=0 Q
"RTN","XQ83R",85,0)
 Q:'XQ83RT  I XQ83RT=1 S ^XUTL("XQO",A,(XQSYNY_U))=V Q
"RTN","XQ83R",86,0)
 I XQ83RT>1,$D(^XUTL("XQO",A,XQSYNY_U)) S ^(XQSYNY_U_"1")=^(XQSYNY_U) K ^(XQSYNY_U)
"RTN","XQ83R",87,0)
 F XQ83RT=1:1 I '$D(^XUTL("XQO",A,(XQSYNY_U_XQ83RT))) S ^(XQSYNY_U_XQ83RT)=V Q
"RTN","XQ83R",88,0)
 K XQ83RT
"RTN","XQ83R",89,0)
 Q
"VER")
8.0^22.0
**END**
**END**
