Released GMRV*5*12 SEQ #6
Extracted from mail message
**KIDS**:GMRV*5.0*12^

**INSTALL NAME**
GMRV*5.0*12
"BLD",5696,0)
GMRV*5.0*12^GEN. MED. REC. - VITALS^0^3050705^y
"BLD",5696,1,0)
^^2^2^3050615^^^
"BLD",5696,1,1,0)
Please read the GMRV*5*12 patch description on FORUM for an explanation of
"BLD",5696,1,2,0)
what this patch does.
"BLD",5696,4,0)
^9.64PA^^
"BLD",5696,"ABNS",0)
^9.66A^^
"BLD",5696,"ABPKG")
n^n
"BLD",5696,"INIT")
EN^GMV12PST
"BLD",5696,"KRN",0)
^9.67PA^8989.52^19
"BLD",5696,"KRN",.4,0)
.4
"BLD",5696,"KRN",.4,"NM",0)
^9.68A^^
"BLD",5696,"KRN",.401,0)
.401
"BLD",5696,"KRN",.402,0)
.402
"BLD",5696,"KRN",.403,0)
.403
"BLD",5696,"KRN",.5,0)
.5
"BLD",5696,"KRN",.84,0)
.84
"BLD",5696,"KRN",3.6,0)
3.6
"BLD",5696,"KRN",3.8,0)
3.8
"BLD",5696,"KRN",9.2,0)
9.2
"BLD",5696,"KRN",9.8,0)
9.8
"BLD",5696,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5696,"KRN",9.8,"NM",1,0)
GMV12PST^^0^B15123427
"BLD",5696,"KRN",9.8,"NM",2,0)
GMVVDEF1^^0^B40198875
"BLD",5696,"KRN",9.8,"NM","B","GMV12PST",1)

"BLD",5696,"KRN",9.8,"NM","B","GMVVDEF1",2)

"BLD",5696,"KRN",19,0)
19
"BLD",5696,"KRN",19.1,0)
19.1
"BLD",5696,"KRN",101,0)
101
"BLD",5696,"KRN",409.61,0)
409.61
"BLD",5696,"KRN",771,0)
771
"BLD",5696,"KRN",870,0)
870
"BLD",5696,"KRN",8989.51,0)
8989.51
"BLD",5696,"KRN",8989.52,0)
8989.52
"BLD",5696,"KRN",8994,0)
8994
"BLD",5696,"KRN","B",.4,.4)

"BLD",5696,"KRN","B",.401,.401)

"BLD",5696,"KRN","B",.402,.402)

"BLD",5696,"KRN","B",.403,.403)

"BLD",5696,"KRN","B",.5,.5)

"BLD",5696,"KRN","B",.84,.84)

"BLD",5696,"KRN","B",3.6,3.6)

"BLD",5696,"KRN","B",3.8,3.8)

"BLD",5696,"KRN","B",9.2,9.2)

"BLD",5696,"KRN","B",9.8,9.8)

"BLD",5696,"KRN","B",19,19)

"BLD",5696,"KRN","B",19.1,19.1)

"BLD",5696,"KRN","B",101,101)

"BLD",5696,"KRN","B",409.61,409.61)

"BLD",5696,"KRN","B",771,771)

"BLD",5696,"KRN","B",870,870)

"BLD",5696,"KRN","B",8989.51,8989.51)

"BLD",5696,"KRN","B",8989.52,8989.52)

"BLD",5696,"KRN","B",8994,8994)

"BLD",5696,"QUES",0)
^9.62^^
"BLD",5696,"REQB",0)
^9.611^1^1
"BLD",5696,"REQB",1,0)
GMRV*5.0*8^2
"BLD",5696,"REQB","B","GMRV*5.0*8",1)

"INIT")
EN^GMV12PST
"MBREQ")
0
"PKG",44,-1)
1^1
"PKG",44,0)
GEN. MED. REC. - VITALS^GMRV^Vitals/Measurements Module of General Medical Record.
"PKG",44,20,0)
^9.402P^^
"PKG",44,22,0)
^9.49I^1^1
"PKG",44,22,1,0)
5.0^3021029
"PKG",44,22,1,"PAH",1,0)
12^3050705^547
"PKG",44,22,1,"PAH",1,1,0)
^^2^2^3050705
"PKG",44,22,1,"PAH",1,1,1,0)
Please read the GMRV*5*12 patch description on FORUM for an explanation of
"PKG",44,22,1,"PAH",1,1,2,0)
what this patch does.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","GMV12PST")
0^1^B15123427
"RTN","GMV12PST",1,0)
GMV12PST ;HIOFO/FT-POST-INSTALLATION FOR GMRV*5*12 ;6/16/05  14:16
"RTN","GMV12PST",2,0)
 ;;5.0;GEN. MED. REC. - VITALS;**12**;Oct 31, 2002
"RTN","GMV12PST",3,0)
 ;
"RTN","GMV12PST",4,0)
 ; This routine uses the following IAs:
"RTN","GMV12PST",5,0)
 ; #10141 - ^XPDUTL calls (supported)
"RTN","GMV12PST",6,0)
 ;
"RTN","GMV12PST",7,0)
EN ; Driver subroutine
"RTN","GMV12PST",8,0)
 D AHDRN,AHDRE
"RTN","GMV12PST",9,0)
 Q
"RTN","GMV12PST",10,0)
 ;
"RTN","GMV12PST",11,0)
AHDRN ; Create AHDRNEW Index on GMRV Vital Measurement file (#120.5) for use
"RTN","GMV12PST",12,0)
 ; by Health Data Repository (HDR)
"RTN","GMV12PST",13,0)
 ; Calls HDR API whenever a new entry is made in FILE 120.5
"RTN","GMV12PST",14,0)
 N GMVXR,GMVRES,GMVOUT
"RTN","GMV12PST",15,0)
 S GMVXR("ACTIVITY")=""
"RTN","GMV12PST",16,0)
 S GMVXR("FILE")=120.5
"RTN","GMV12PST",17,0)
 S GMVXR("NAME")="AHDRNEW"
"RTN","GMV12PST",18,0)
 S GMVXR("TYPE")="MU"
"RTN","GMV12PST",19,0)
 S GMVXR("USE")="A"
"RTN","GMV12PST",20,0)
 S GMVXR("EXECUTION")="F"
"RTN","GMV12PST",21,0)
 S GMVXR("SHORT DESCR")="INDEX for HDR"
"RTN","GMV12PST",22,0)
 S GMVXR("DESCR",1)="This cross-reference calls a Health Data Repository (HDR) API whenever a"
"RTN","GMV12PST",23,0)
 S GMVXR("DESCR",2)="new entry is created."
"RTN","GMV12PST",24,0)
 S GMVXR("DESCR",3)=" "
"RTN","GMV12PST",25,0)
 S GMVXR("DESCR",4)="No actual cross-reference nodes are set or killed."
"RTN","GMV12PST",26,0)
 S GMVXR("DESCR",5)=" "
"RTN","GMV12PST",27,0)
 S GMVXR("DESCR",6)="Calls to the VDEFQM routine are covered by Integration Agreement 4253."
"RTN","GMV12PST",28,0)
 S GMVXR("DESCR",7)="Calls to the VADPT routine are covered by Integration Agreement 3744."
"RTN","GMV12PST",29,0)
 S GMVXR("DESCR",8)="Use of the XDRDVALF variable is covered by Integration Agreement 4690."
"RTN","GMV12PST",30,0)
 S GMVXR("SET")="Q:$D(DIU(0))!($$TESTPAT^VADPT($P(^GMR(120.5,DA,0),U,2)))!($G(XDRDVALF)=1)  N ERR,GMVFLAG I $T(QUEUE^VDEFQM)]"""" S GMVFLAG=$$QUEUE^VDEFQM(""ORU^R01"",""SUBTYPE=VTLS^IEN=""_DA,.ERR)"
"RTN","GMV12PST",31,0)
 S GMVXR("KILL")="Q"
"RTN","GMV12PST",32,0)
 S GMVXR("WHOLE KILL")="Q"
"RTN","GMV12PST",33,0)
 S GMVXR("SET CONDITION")="I X1(1)="""",X2(1)'="""" S X=1"
"RTN","GMV12PST",34,0)
 S GMVXR("VAL",1)=.02
"RTN","GMV12PST",35,0)
 D CREIXN^DDMOD(.GMVXR,"k",.GMVRES,"GMVOUT")
"RTN","GMV12PST",36,0)
 I GMVRES="" D
"RTN","GMV12PST",37,0)
 .D BMES^XPDUTL("The AHDRNEW Index was not added to FILE 120.5. Please enter a Remedy ticket.")
"RTN","GMV12PST",38,0)
 .Q
"RTN","GMV12PST",39,0)
 Q
"RTN","GMV12PST",40,0)
 ;
"RTN","GMV12PST",41,0)
AHDRE ; Create AHDRERR Index on GMRV Vital Measurement file (#120.5) for use
"RTN","GMV12PST",42,0)
 ; by Health Data Repository (HDR)
"RTN","GMV12PST",43,0)
 ; Calls HDR API whenever a FILE 120.5 entry is marked as an error
"RTN","GMV12PST",44,0)
 N GMVXR,GMVRES,GMVOUT
"RTN","GMV12PST",45,0)
 S GMVXR("ACTIVITY")=""
"RTN","GMV12PST",46,0)
 S GMVXR("FILE")=120.5
"RTN","GMV12PST",47,0)
 S GMVXR("NAME")="AHDRERR"
"RTN","GMV12PST",48,0)
 S GMVXR("TYPE")="MU"
"RTN","GMV12PST",49,0)
 S GMVXR("USE")="A"
"RTN","GMV12PST",50,0)
 S GMVXR("EXECUTION")="F"
"RTN","GMV12PST",51,0)
 S GMVXR("SHORT DESCR")="INDEX for HDR"
"RTN","GMV12PST",52,0)
 S GMVXR("DESCR",1)="This cross-reference calls a Health Data Repository (HDR) API whenever a"
"RTN","GMV12PST",53,0)
 S GMVXR("DESCR",2)="FILE 120.5 entry is marked as entered-in-error."
"RTN","GMV12PST",54,0)
 S GMVXR("DESCR",3)=" "
"RTN","GMV12PST",55,0)
 S GMVXR("DESCR",4)="No actual cross-reference nodes are set or killed."
"RTN","GMV12PST",56,0)
 S GMVXR("DESCR",5)=" "
"RTN","GMV12PST",57,0)
 S GMVXR("DESCR",6)="Calls to the VDEFQM routine are covered by Integration Agreement 4253."
"RTN","GMV12PST",58,0)
 S GMVXR("DESCR",7)="Calls to the VADPT routine are covered by Integration Agreement 3744."
"RTN","GMV12PST",59,0)
 S GMVXR("DESCR",8)="Use of the XDRDVALF variable is covered by Integration Agreement 4690."
"RTN","GMV12PST",60,0)
 S GMVXR("SET")="Q:$D(DIU(0))!($$TESTPAT^VADPT($P(^GMR(120.5,DA,0),U,2)))!($G(XDRDVALF)=1)  N ERR,GMVFLAG I $T(QUEUE^VDEFQM)]"""" S GMVFLAG=$$QUEUE^VDEFQM(""ORU^R01"",""SUBTYPE=VTLS^IEN=""_DA,.ERR)"
"RTN","GMV12PST",61,0)
 S GMVXR("KILL")="Q"
"RTN","GMV12PST",62,0)
 S GMVXR("WHOLE KILL")="Q"
"RTN","GMV12PST",63,0)
 S GMVXR("SET CONDITION")="I X1(1)="""",X2(1)]"""" S X=1"
"RTN","GMV12PST",64,0)
 S GMVXR("VAL",1)=2
"RTN","GMV12PST",65,0)
 D CREIXN^DDMOD(.GMVXR,"k",.GMVRES,"GMVOUT")
"RTN","GMV12PST",66,0)
 I GMVRES="" D
"RTN","GMV12PST",67,0)
 .D BMES^XPDUTL("The AHDRERR Index was not added to FILE 120.5. Please enter a Remedy ticket.")
"RTN","GMV12PST",68,0)
 .Q
"RTN","GMV12PST",69,0)
 Q
"RTN","GMVVDEF1")
0^2^B40198875
"RTN","GMVVDEF1",1,0)
GMVVDEF1 ;BPOIFO/JG,HIOFO/FT - BUILD HL7 ORU^R01 MESSAGE FOR VITALS ;4/19/05  15:43
"RTN","GMVVDEF1",2,0)
 ;;5.0;GEN. MED. REC. - VITALS;**5,8,12**;Oct 31, 2002
"RTN","GMVVDEF1",3,0)
VALID ;;VDEF HL7 MESSAGE BUILDER
"RTN","GMVVDEF1",4,0)
 ; Creates HL7 V2.4 ORU^R01 message for vitals
"RTN","GMVVDEF1",5,0)
 ;
"RTN","GMVVDEF1",6,0)
 ; This routine uses the following IAs:
"RTN","GMVVDEF1",7,0)
 ;    #93 - FILE 44 references   (controlled)
"RTN","GMVVDEF1",8,0)
 ;   #557 - FILE 40.7 references (controlled)
"RTN","GMVVDEF1",9,0)
 ;  #2432 - FILE 44 references   (controlled)
"RTN","GMVVDEF1",10,0)
 ;  #3630 - VAFCQRY calls        (controlled)
"RTN","GMVVDEF1",11,0)
 ;  #4248 - VDEFEL calls         (controlled)
"RTN","GMVVDEF1",12,0)
 ;  #4571 - VDEFREQ calls        (controlled)
"RTN","GMVVDEF1",13,0)
 ; #10035 - DPT( references      (supported)
"RTN","GMVVDEF1",14,0)
 ; #10040 - FILE 44 references   (supported)
"RTN","GMVVDEF1",15,0)
 ; #10112 - VASITE calls         (supported)
"RTN","GMVVDEF1",16,0)
 ;
"RTN","GMVVDEF1",17,0)
 ; This routine is called at tag EN as a Function by VDEFREQ1
"RTN","GMVVDEF1",18,0)
 ;
"RTN","GMVVDEF1",19,0)
 Q
"RTN","GMVVDEF1",20,0)
 ;
"RTN","GMVVDEF1",21,0)
EN(EVIEN,KEY,VFLAG,OUT,MSHP) ; Entry point
"RTN","GMVVDEF1",22,0)
 ;
"RTN","GMVVDEF1",23,0)
 ; Inputs: EVIEN = IEN of VDEF Event in file 577
"RTN","GMVVDEF1",24,0)
 ;         KEY - IEN of file to create message from
"RTN","GMVVDEF1",25,0)
 ;         VFLAG - "V" for VistA HL7 destination (default)
"RTN","GMVVDEF1",26,0)
 ;         OUT - target array, passed by reference
"RTN","GMVVDEF1",27,0)
 ;         MSHP - Piece 4 contains message subtype
"RTN","GMVVDEF1",28,0)
 ;
"RTN","GMVVDEF1",29,0)
 ; Output: Two part string with parts separated by "^"
"RTN","GMVVDEF1",30,0)
 ;         Part 1: "LM" - output in local array passed in "OUT" parameter
"RTN","GMVVDEF1",31,0)
 ;                 "GM" - output in ^TMP("HLS",$J)
"RTN","GMVVDEF1",32,0)
 ;         Part 2: No longer used
"RTN","GMVVDEF1",33,0)
 ;
"RTN","GMVVDEF1",34,0)
 N DFN,HLFS,HLCM,HLSC,HLRP,HLES,HLQ,VTLDAT,UM,VTLTYP,DTE,DTP
"RTN","GMVVDEF1",35,0)
 N VTLERR,VAL,I,S,X,Y,QUALS,HL7RC,PIDSEG,IEN1,SEQ,STOPCD,EIEVUID
"RTN","GMVVDEF1",36,0)
 N SEPF,SEPC,SEPR,SEPE,SEPS,VTLNAM,ARRAY,O2SUP,OUTX,ADD,VTLVUID
"RTN","GMVVDEF1",37,0)
 ;
"RTN","GMVVDEF1",38,0)
 ; Initialize stuff
"RTN","GMVVDEF1",39,0)
 K ^TMP("HLS",$J) S S=0,ARRAY="OUT("_"""HLS"""_",S)",TARGET="LM^"
"RTN","GMVVDEF1",40,0)
 ;
"RTN","GMVVDEF1",41,0)
 ; Set up HL7 delimiters
"RTN","GMVVDEF1",42,0)
 S HLCM=$E(VDEFHL("ECH")),HLRP=$E(VDEFHL("ECH"),2),HLSC=$E(VDEFHL("ECH"),4),HLES=$E(VDEFHL("ECH"),3)
"RTN","GMVVDEF1",43,0)
 S HLFS=VDEFHL("FS"),HLQ=VDEFHL("Q"),HL7RC=HLES_HLFS_HLCM_HLRP_HLSC
"RTN","GMVVDEF1",44,0)
 D SETDLMS^VDEFEL
"RTN","GMVVDEF1",45,0)
 ;
"RTN","GMVVDEF1",46,0)
 ; Get the vitals measurement record & patient ID
"RTN","GMVVDEF1",47,0)
 S VTLDAT=$$EN^GMVHDR(KEY)
"RTN","GMVVDEF1",48,0)
 I 'VTLDAT D ERR^VDEFREQ("Invalid data in file GMR(120.5) for IEN "_KEY) S ZTSTOP=1 G EXIT
"RTN","GMVVDEF1",49,0)
 S DFN=$P(VTLDAT,U,2),VTLTYP=$P(VTLDAT,U,7)
"RTN","GMVVDEF1",50,0)
 S VTLVUID=$$GET^GMVUID(120.51,.01,+VTLTYP_",") ;vital type vuid
"RTN","GMVVDEF1",51,0)
 S O2SUP=$P(VTLDAT,U,10),VTLERR=$P(VTLDAT,U,11)
"RTN","GMVVDEF1",52,0)
 S X=$P(VTLDAT,U,5) I +X'=X!(X<0) S $P(VTLDAT,U,5)=""
"RTN","GMVVDEF1",53,0)
 S STOPCD=""
"RTN","GMVVDEF1",54,0)
 I $P(VTLDAT,U,5)'="" D
"RTN","GMVVDEF1",55,0)
 . S STOPCD=$P($G(^SC($P(VTLDAT,U,5),0)),U,7) Q:STOPCD=""
"RTN","GMVVDEF1",56,0)
 . S STOPCD=$G(^DIC(40.7,STOPCD,0))
"RTN","GMVVDEF1",57,0)
 . S STOPCD=$P(STOPCD,U,2)_";"_$P(STOPCD,U)
"RTN","GMVVDEF1",58,0)
 ;
"RTN","GMVVDEF1",59,0)
 ; Build segments for message in OUTX, $P # = HL7 field #
"RTN","GMVVDEF1",60,0)
 ;
"RTN","GMVVDEF1",61,0)
 ; PID - Use MPI PID builder
"RTN","GMVVDEF1",62,0)
PID K PIDSEG S OUTX="",S=1,SEQ=""
"RTN","GMVVDEF1",63,0)
 I $G(^DPT(DFN,0))="" D ERR^VDEFREQ("No entry in file DPT for DFN "_DFN) S ZTSTOP=1 G EXIT
"RTN","GMVVDEF1",64,0)
 D BLDPID^VAFCQRY(DFN,1,SEQ,.PIDSEG,.VDEFHL)
"RTN","GMVVDEF1",65,0)
 F I=2:1 Q:$G(PIDSEG(I))=""  S PIDSEG(1,I-1)=PIDSEG(I) K PIDSEG(I)
"RTN","GMVVDEF1",66,0)
 M OUTX=PIDSEG(1) K PIDSEG D SAVE
"RTN","GMVVDEF1",67,0)
 ;
"RTN","GMVVDEF1",68,0)
 ; ORC
"RTN","GMVVDEF1",69,0)
ORC S S=S+1,OUTX="RE"
"RTN","GMVVDEF1",70,0)
 ;
"RTN","GMVVDEF1",71,0)
 ; Filler ID
"RTN","GMVVDEF1",72,0)
 S X=KEY_HLCM_$P(SITEPARM,U,6)_"_120.5",$P(OUTX,HLFS,3)=X
"RTN","GMVVDEF1",73,0)
 ;
"RTN","GMVVDEF1",74,0)
 ; Enterer's location
"RTN","GMVVDEF1",75,0)
 I $P(VTLDAT,U,5)'="" D
"RTN","GMVVDEF1",76,0)
 . S X=$G(^SC($P(VTLDAT,U,5),0)),VAL=$P(X,U,2)
"RTN","GMVVDEF1",77,0)
 . S $P(VAL,HLCM,9)=$P(X,U),$P(OUTX,HLFS,13)=VAL
"RTN","GMVVDEF1",78,0)
 . I +$P(X,U,15) S X=$$SITE^VASITE($P(VTLDAT,U),$P(X,U,15)) S:X=-1 X=""
"RTN","GMVVDEF1",79,0)
 . E  S X=""
"RTN","GMVVDEF1",80,0)
 . S VAL=$P(X,U,3)_HLCM_$P(X,U,2)_HLCM_"L",$P(OUTX,HLFS,17)=VAL
"RTN","GMVVDEF1",81,0)
 S VAL=$P(OUTX,HLFS,3),OUTX="ORC"_HLFS_OUTX D SAVE
"RTN","GMVVDEF1",82,0)
 ;
"RTN","GMVVDEF1",83,0)
 ; OBR
"RTN","GMVVDEF1",84,0)
OBR S S=S+1,OUTX="",VTLNAM=$$HL7RC($P(^GMRD(120.51,VTLTYP,0),U))
"RTN","GMVVDEF1",85,0)
 S X=VTLVUID_HLCM_VTLNAM_HLCM_"99VA120.51"
"RTN","GMVVDEF1",86,0)
 ;
"RTN","GMVVDEF1",87,0)
 ; Add filler ID from ORC-3 & Procedure name
"RTN","GMVVDEF1",88,0)
 S $P(OUTX,HLFS,3)=VAL,$P(OUTX,HLFS,4)=X
"RTN","GMVVDEF1",89,0)
 ;
"RTN","GMVVDEF1",90,0)
 ; Dates/times vital taken & entered
"RTN","GMVVDEF1",91,0)
 S DTP=$$TS^VDEFEL($P(VTLDAT,U)),$P(OUTX,HLFS,7)=DTP
"RTN","GMVVDEF1",92,0)
 S DTE=$$TS^VDEFEL($P(VTLDAT,U,4)),$P(OUTX,HLFS,8)=DTE
"RTN","GMVVDEF1",93,0)
 ;
"RTN","GMVVDEF1",94,0)
 ; Use date/time vital entered for results reported
"RTN","GMVVDEF1",95,0)
 S $P(OUTX,HLFS,22)=DTE,OUTX="OBR"_HLFS_OUTX D SAVE
"RTN","GMVVDEF1",96,0)
 ;
"RTN","GMVVDEF1",97,0)
 ; OBX 1 - Vital name
"RTN","GMVVDEF1",98,0)
OBX1 S S=S+1,OUTX=HLFS_"ST"
"RTN","GMVVDEF1",99,0)
 ;
"RTN","GMVVDEF1",100,0)
 ; Observation ID - Vital name
"RTN","GMVVDEF1",101,0)
 S X=VTLVUID_HLCM_VTLNAM_HLCM_"99VA120.51",$P(OUTX,HLFS,3)=X
"RTN","GMVVDEF1",102,0)
 ;
"RTN","GMVVDEF1",103,0)
 ; Unit of measure
"RTN","GMVVDEF1",104,0)
 ; If vital not performed, set units to null
"RTN","GMVVDEF1",105,0)
 S UM=$P(VTLDAT,U,9) S:$F("Pass Refused Unavailable",$P(VTLDAT,U,8))>0 UM=""
"RTN","GMVVDEF1",106,0)
 S UM=UM_HLCM_UM_HLCM_"L"
"RTN","GMVVDEF1",107,0)
 ;
"RTN","GMVVDEF1",108,0)
 ; Set sub-id if O2 supplements to follow
"RTN","GMVVDEF1",109,0)
 S:O2SUP'="" $P(OUTX,HLFS,4)=1
"RTN","GMVVDEF1",110,0)
 S $P(OUTX,HLFS,5)=$P(VTLDAT,U,8),$P(OUTX,HLFS,6)=UM
"RTN","GMVVDEF1",111,0)
 ;
"RTN","GMVVDEF1",112,0)
 ; Set result status to Final or Wrong if errors entered
"RTN","GMVVDEF1",113,0)
 S $P(OUTX,HLFS,11)=$E("FW",VTLERR'=""+1)
"RTN","GMVVDEF1",114,0)
 S $P(OUTX,HLFS,16)=$$XCN200^VDEFEL($P(VTLDAT,U,6))
"RTN","GMVVDEF1",115,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMVVDEF1",116,0)
 ;
"RTN","GMVVDEF1",117,0)
 ; OBX2 - O2 Supplement
"RTN","GMVVDEF1",118,0)
OBX2 G QUALS:O2SUP="" S (VAL,UM)=""
"RTN","GMVVDEF1",119,0)
 S S=S+1,OUTX=HLFS_"ST"_HLFS_"O2 Supplement" D
"RTN","GMVVDEF1",120,0)
 . I O2SUP["%",O2SUP'["l/min" S VAL=+O2SUP,UM="%" Q
"RTN","GMVVDEF1",121,0)
 . I O2SUP'["%",O2SUP["l/min" S VAL=+O2SUP,UM="l/min"
"RTN","GMVVDEF1",122,0)
 . I O2SUP["%",O2SUP["l/min" S $P(VAL,U)=$P(O2SUP," "),$P(UM,U)="l/min",$P(VAL,U,2)=+$P(O2SUP," ",3),$P(UM,U,2)="%"
"RTN","GMVVDEF1",123,0)
 S X=$P(UM,U),X=X_HLCM_X_HLCM_"L",$P(UM,U)=X
"RTN","GMVVDEF1",124,0)
 I $P(UM,U,2)'="" S X=$P(UM,U,2),X=X_HLCM_X_HLCM_"L",$P(UM,U,2)=X
"RTN","GMVVDEF1",125,0)
 S $P(OUTX,HLFS,4)=2,$P(OUTX,HLFS,5)=$P(VAL,U,1),$P(OUTX,HLFS,6)=$P(UM,U)
"RTN","GMVVDEF1",126,0)
 S $P(OUTX,HLFS,11)="F"
"RTN","GMVVDEF1",127,0)
 S OUTX="OBX"_HLFS_OUTX,X=OUTX D SAVE
"RTN","GMVVDEF1",128,0)
 ; If more than one O2 supplement, add another OBX
"RTN","GMVVDEF1",129,0)
 ; Field offset in OUT is now +1 because OBX has been added
"RTN","GMVVDEF1",130,0)
 S OUTX=X I $P(VAL,U,2)'="" D
"RTN","GMVVDEF1",131,0)
 . S S=S+1,$P(OUTX,HLFS,5)=3,$P(OUTX,HLFS,6)=$P(VAL,U,2),$P(OUTX,HLFS,7)=$P(UM,U,2)
"RTN","GMVVDEF1",132,0)
 . D SAVE
"RTN","GMVVDEF1",133,0)
 ;
"RTN","GMVVDEF1",134,0)
 ; Qualifiers
"RTN","GMVVDEF1",135,0)
QUALS S QUALS="",X=$O(^GMR(120.5,KEY,5,0)) G ERRS:X=""
"RTN","GMVVDEF1",136,0)
 S S=S+1,OUTX=HLFS_"CE"_HLFS_"Qualifiers"_HLFS_HLFS
"RTN","GMVVDEF1",137,0)
 ;
"RTN","GMVVDEF1",138,0)
 ; Get qualifiers
"RTN","GMVVDEF1",139,0)
 S IEN1=0 F  S IEN1=$O(^GMR(120.5,KEY,5,IEN1)) Q:'+IEN1  D
"RTN","GMVVDEF1",140,0)
 . S X=^GMR(120.5,KEY,5,IEN1,0),VAL=$$HL7RC($P(^GMRD(120.52,X,0),U))
"RTN","GMVVDEF1",141,0)
 . S X=$$GET^GMVUID(120.52,.01,+X_",") ;qualifier vuid
"RTN","GMVVDEF1",142,0)
 . S VAL=X_HLCM_VAL_HLCM_"99VA120.52",QUALS=QUALS_VAL_HLRP
"RTN","GMVVDEF1",143,0)
 ;
"RTN","GMVVDEF1",144,0)
 ; Set result and result status
"RTN","GMVVDEF1",145,0)
 S $P(OUTX,HLFS,5)=$E(QUALS,1,$L(QUALS)-1),$P(OUTX,HLFS,11)="F"
"RTN","GMVVDEF1",146,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMVVDEF1",147,0)
 ;
"RTN","GMVVDEF1",148,0)
 ; Entered in Error
"RTN","GMVVDEF1",149,0)
ERRS G ZSC:VTLERR="" S S=S+1,OUTX=HLFS_"CE"_HLFS_"Error Reasons"_HLFS_HLFS
"RTN","GMVVDEF1",150,0)
 ;
"RTN","GMVVDEF1",151,0)
 ; Error data reason(s)
"RTN","GMVVDEF1",152,0)
 S X=$P(VTLDAT,U,13),VAL=""
"RTN","GMVVDEF1",153,0)
 F I=1:1:$L(X,"~") D
"RTN","GMVVDEF1",154,0)
 .S Y=$P(X,"~",I)
"RTN","GMVVDEF1",155,0)
 .S EIEVUID=$$GET^GMVUID(120.506,.01,$P(Y,"-",1)) ;error vuid
"RTN","GMVVDEF1",156,0)
 .S VAL=VAL_EIEVUID_HLCM_$$HL7RC($P(Y,"-",2))_HLCM_"99VA8985.1"_HLRP
"RTN","GMVVDEF1",157,0)
 S VAL=$E(VAL,1,$L(VAL)-1),$P(OUTX,HLFS,5)=VAL,$P(OUTX,HLFS,11)="F"
"RTN","GMVVDEF1",158,0)
 S OUTX="OBX"_HLFS_OUTX D SAVE
"RTN","GMVVDEF1",159,0)
 ;
"RTN","GMVVDEF1",160,0)
 ; Stop Code & Name
"RTN","GMVVDEF1",161,0)
ZSC G EXIT:STOPCD=""
"RTN","GMVVDEF1",162,0)
 S S=S+1,OUTX=HLFS_$P(STOPCD,";")_HLFS_$P(STOPCD,";",2)
"RTN","GMVVDEF1",163,0)
 S OUTX="ZSC"_HLFS_OUTX D SAVE
"RTN","GMVVDEF1",164,0)
 ;
"RTN","GMVVDEF1",165,0)
 ; Done building segments
"RTN","GMVVDEF1",166,0)
EXIT Q TARGET
"RTN","GMVVDEF1",167,0)
 ;
"RTN","GMVVDEF1",168,0)
 ;
"RTN","GMVVDEF1",169,0)
 ; Place current string into message array.
"RTN","GMVVDEF1",170,0)
 ; Turn string into array if length >245.
"RTN","GMVVDEF1",171,0)
 ; Move local array to global if needed.
"RTN","GMVVDEF1",172,0)
SAVE N I
"RTN","GMVVDEF1",173,0)
 I $P(OUTX,HLFS)'="PID",$L(OUTX)>245 D
"RTN","GMVVDEF1",174,0)
 . K ADD S ADD=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX))
"RTN","GMVVDEF1",175,0)
 . F I=1:1 S ADD(I)=$E(OUTX,1,245),OUTX=$E(OUTX,246,$L(OUTX)) Q:OUTX=""
"RTN","GMVVDEF1",176,0)
 . K OUTX M OUTX=ADD
"RTN","GMVVDEF1",177,0)
 M @ARRAY=OUTX
"RTN","GMVVDEF1",178,0)
 ;
"RTN","GMVVDEF1",179,0)
 ; Move local array to global if it's getting big.
"RTN","GMVVDEF1",180,0)
 I $P(TARGET,U)="LM",$S<16000 D
"RTN","GMVVDEF1",181,0)
 . K ^TMP("HLS",$J) M ^TMP("HLS",$J)=OUT("HLS") K OUT("HLS")
"RTN","GMVVDEF1",182,0)
 . S $P(TARGET,U)="GM",ARRAY="^TMP("_"""HLS"""_",$J,S)"
"RTN","GMVVDEF1",183,0)
 K OUTX,ADD
"RTN","GMVVDEF1",184,0)
 Q
"RTN","GMVVDEF1",185,0)
 ;
"RTN","GMVVDEF1",186,0)
 ; Replace any HL7 coding chars. in strings with HL7 escape sequence
"RTN","GMVVDEF1",187,0)
 ; Input: X = data string
"RTN","GMVVDEF1",188,0)
HL7RC(X) N OCHR,RCHR,RCHRI,TYPE,I F TYPE="E","F","C","R","S" D
"RTN","GMVVDEF1",189,0)
 . S RCHRI=$S(TYPE="E":1,TYPE="F":2,TYPE="C":3,TYPE="R":4,TYPE="S":5)
"RTN","GMVVDEF1",190,0)
 . S OCHR=$E(HL7RC,RCHRI),RCHR=$E("EFSRT",RCHRI)
"RTN","GMVVDEF1",191,0)
 . Q:'$F(X,OCHR)
"RTN","GMVVDEF1",192,0)
 . F I=1:1 Q:$E(X,I)=""  I $E(X,I)=OCHR S X=$E(X,1,I-1)_HLES_RCHR_HLES_$E(X,I+1,999),I=I+2
"RTN","GMVVDEF1",193,0)
 Q X
"VER")
8.0^22.0
"BLD",5696,6)
^SEQ #6
**END**
**END**
