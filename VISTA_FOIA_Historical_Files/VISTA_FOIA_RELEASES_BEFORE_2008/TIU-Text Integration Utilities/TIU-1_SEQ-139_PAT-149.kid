Released TIU*1*149 SEQ #139
Extracted from mail message
**KIDS**:TIU*1.0*149^

**INSTALL NAME**
TIU*1.0*149
"BLD",3981,0)
TIU*1.0*149^TEXT INTEGRATION UTILITIES^0^3030224^y
"BLD",3981,1,0)
^^2^2^3021022^
"BLD",3981,1,1,0)
The description of this patch may be found in the National Patch Module 
"BLD",3981,1,2,0)
under TIU*1*149.
"BLD",3981,4,0)
^9.64PA^^
"BLD",3981,"KRN",0)
^9.67PA^8989.52^19
"BLD",3981,"KRN",.4,0)
.4
"BLD",3981,"KRN",.401,0)
.401
"BLD",3981,"KRN",.402,0)
.402
"BLD",3981,"KRN",.403,0)
.403
"BLD",3981,"KRN",.5,0)
.5
"BLD",3981,"KRN",.84,0)
.84
"BLD",3981,"KRN",3.6,0)
3.6
"BLD",3981,"KRN",3.8,0)
3.8
"BLD",3981,"KRN",9.2,0)
9.2
"BLD",3981,"KRN",9.8,0)
9.8
"BLD",3981,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",3981,"KRN",9.8,"NM",1,0)
TIUPXAP1^^0^B25890136
"BLD",3981,"KRN",9.8,"NM",2,0)
TIUP149^^0^B53382886
"BLD",3981,"KRN",9.8,"NM",3,0)
TIUP149P^^0^B26475337
"BLD",3981,"KRN",9.8,"NM",4,0)
TIUPXAP2^^0^B32251106
"BLD",3981,"KRN",9.8,"NM","B","TIUP149",2)

"BLD",3981,"KRN",9.8,"NM","B","TIUP149P",3)

"BLD",3981,"KRN",9.8,"NM","B","TIUPXAP1",1)

"BLD",3981,"KRN",9.8,"NM","B","TIUPXAP2",4)

"BLD",3981,"KRN",19,0)
19
"BLD",3981,"KRN",19.1,0)
19.1
"BLD",3981,"KRN",101,0)
101
"BLD",3981,"KRN",409.61,0)
409.61
"BLD",3981,"KRN",771,0)
771
"BLD",3981,"KRN",870,0)
870
"BLD",3981,"KRN",8989.51,0)
8989.51
"BLD",3981,"KRN",8989.52,0)
8989.52
"BLD",3981,"KRN",8994,0)
8994
"BLD",3981,"KRN","B",.4,.4)

"BLD",3981,"KRN","B",.401,.401)

"BLD",3981,"KRN","B",.402,.402)

"BLD",3981,"KRN","B",.403,.403)

"BLD",3981,"KRN","B",.5,.5)

"BLD",3981,"KRN","B",.84,.84)

"BLD",3981,"KRN","B",3.6,3.6)

"BLD",3981,"KRN","B",3.8,3.8)

"BLD",3981,"KRN","B",9.2,9.2)

"BLD",3981,"KRN","B",9.8,9.8)

"BLD",3981,"KRN","B",19,19)

"BLD",3981,"KRN","B",19.1,19.1)

"BLD",3981,"KRN","B",101,101)

"BLD",3981,"KRN","B",409.61,409.61)

"BLD",3981,"KRN","B",771,771)

"BLD",3981,"KRN","B",870,870)

"BLD",3981,"KRN","B",8989.51,8989.51)

"BLD",3981,"KRN","B",8989.52,8989.52)

"BLD",3981,"KRN","B",8994,8994)

"BLD",3981,"QUES",0)
^9.62^^
"BLD",3981,"REQB",0)
^9.611^3^3
"BLD",3981,"REQB",1,0)
TEXT INTEGRATION UTILITIES 1.0^2
"BLD",3981,"REQB",2,0)
TIU*1.0*124^2
"BLD",3981,"REQB",3,0)
TIU*1.0*146^2
"BLD",3981,"REQB","B","TEXT INTEGRATION UTILITIES 1.0",1)

"BLD",3981,"REQB","B","TIU*1.0*124",2)

"BLD",3981,"REQB","B","TIU*1.0*146",3)

"MBREQ")
0
"PKG",193,-1)
1^1
"PKG",193,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",193,20,0)
^9.402P^^
"PKG",193,22,0)
^9.49I^1^1
"PKG",193,22,1,0)
1.0^3010321^3010321^11
"PKG",193,22,1,"PAH",1,0)
149^3030224
"PKG",193,22,1,"PAH",1,1,0)
^^2^2^3030224
"PKG",193,22,1,"PAH",1,1,1,0)
The description of this patch may be found in the National Patch Module 
"PKG",193,22,1,"PAH",1,1,2,0)
under TIU*1*149.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","TIUP149")
0^2^B53382886
"RTN","TIUP149",1,0)
TIUP149 ;SLC/RMO - Post-Install for TIU*1*149 ;10/28/02@09:51:20
"RTN","TIUP149",2,0)
 ;;1.0;Text Integration Utilities;**149**;Jun 20, 1997
"RTN","TIUP149",3,0)
 ;
"RTN","TIUP149",4,0)
EN ;Entry point to queue a job to clean up certain documents
"RTN","TIUP149",5,0)
 ;linked to a different patient's visit
"RTN","TIUP149",6,0)
 N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTSK
"RTN","TIUP149",7,0)
 ;
"RTN","TIUP149",8,0)
 W !!,"PATCH TIU*1*149"
"RTN","TIUP149",9,0)
 W !!,"Search ALL entries in the TIU Document file (#8925) to link or"
"RTN","TIUP149",10,0)
 W !,"unlink documents associated with a different patient's visit that"
"RTN","TIUP149",11,0)
 W !,"meet the following criteria:"
"RTN","TIUP149",12,0)
 W !!,"- Addenda or components where the parent points to the correct visit will"
"RTN","TIUP149",13,0)
 W !,"  be linked, otherwise the addenda or components will be unlinked if they"
"RTN","TIUP149",14,0)
 W !,"  are associated with an incorrect visit different than the parent."
"RTN","TIUP149",15,0)
 W !!,"- Documents where the capture method is converted and a visit"
"RTN","TIUP149",16,0)
 W !,"  exists will be linked, otherwise the document will be unlinked"
"RTN","TIUP149",17,0)
 W !,"  from the incorrect visit."
"RTN","TIUP149",18,0)
 W !!,"- Documents where the reference date is prior to 10/1/98 will"
"RTN","TIUP149",19,0)
 W !,"  be unlinked from the incorrect visit."
"RTN","TIUP149",20,0)
 W !!,"- Documents that are Discharge Summaries will be unlinked"
"RTN","TIUP149",21,0)
 W !,"  from the incorrect visit."
"RTN","TIUP149",22,0)
 W !
"RTN","TIUP149",23,0)
 ;
"RTN","TIUP149",24,0)
 ;Set variables
"RTN","TIUP149",25,0)
 S ZTRTN="CLNUP^TIUP149",ZTIO="",ZTSAVE("DUZ")=""
"RTN","TIUP149",26,0)
 S ZTDESC="Clean up TIU Documents Different Patient's Visit - Patch 149"
"RTN","TIUP149",27,0)
 D ^%ZTLOAD
"RTN","TIUP149",28,0)
 I $G(ZTSK) D
"RTN","TIUP149",29,0)
 . W !!,"A task has been queued in the background and a bulletin will be sent"
"RTN","TIUP149",30,0)
 . W !,"to you upon completion of the task or if the task is stopped."
"RTN","TIUP149",31,0)
 . W !!,"The task number is "_$G(ZTSK)_"."
"RTN","TIUP149",32,0)
 Q
"RTN","TIUP149",33,0)
 ;
"RTN","TIUP149",34,0)
CLNUP ;Entry point to clean up documents pointing to a different patient's
"RTN","TIUP149",35,0)
 ;visit
"RTN","TIUP149",36,0)
 ; Input  -- None
"RTN","TIUP149",37,0)
 ; Output -- ^XTMP("TIUP149", Global
"RTN","TIUP149",38,0)
 N NDBIF,TIUDA,TIUS,TIURSTDA
"RTN","TIUP149",39,0)
 ;
"RTN","TIUP149",40,0)
 ;Initialize re-start if check point exists
"RTN","TIUP149",41,0)
 I +$G(^XTMP("TIUP149","CHKPT")) D
"RTN","TIUP149",42,0)
 . S TIURSTDA=+$G(^XTMP("TIUP149","CHKPT"))
"RTN","TIUP149",43,0)
 ELSE  D
"RTN","TIUP149",44,0)
 . ;Clean up ^XTMP("TIUP149")
"RTN","TIUP149",45,0)
 . K ^XTMP("TIUP149"),^XTMP("TIU/PXAPI")
"RTN","TIUP149",46,0)
 . ;Initialize ^XTMP("TIUP149" if not re-start
"RTN","TIUP149",47,0)
 . S ^XTMP("TIUP149",0)=$$FMADD^XLFDT(DT,90)_U_DT
"RTN","TIUP149",48,0)
 . S ^XTMP("TIUP149","CNT","EX")=0 F TIUS=1:1:3 S ^XTMP("TIUP149","CNT","EX",TIUS)=0
"RTN","TIUP149",49,0)
 . S ^XTMP("TIUP149","CNT","LNK")=0
"RTN","TIUP149",50,0)
 . S ^XTMP("TIUP149","CNT","TOT")=0
"RTN","TIUP149",51,0)
 . S ^XTMP("TIUP149","CHKPT")=""
"RTN","TIUP149",52,0)
 K ^XTMP("TIUP149","STOP")
"RTN","TIUP149",53,0)
 S ^XTMP("TIUP149","T0")=$$NOW^XLFDT
"RTN","TIUP149",54,0)
 ;
"RTN","TIUP149",55,0)
 ;Set integrated facility NDBI flag
"RTN","TIUP149",56,0)
 S NDBIF=$$CHKINF
"RTN","TIUP149",57,0)
 ;
"RTN","TIUP149",58,0)
 ;Loop through documents
"RTN","TIUP149",59,0)
 S TIUDA=$S($G(TIURSTDA):TIURSTDA,1:0)
"RTN","TIUP149",60,0)
 F  S TIUDA=$O(^TIU(8925,TIUDA)) Q:+TIUDA'>0!($G(ZTSTOP))  I $D(^(TIUDA,0)) D
"RTN","TIUP149",61,0)
 . ;Clean up visit for one document
"RTN","TIUP149",62,0)
 . D CLNONE(TIUDA,$G(NDBIF))
"RTN","TIUP149",63,0)
 . ;
"RTN","TIUP149",64,0)
 . ;Set check point for Document IEN
"RTN","TIUP149",65,0)
 . S ^XTMP("TIUP149","CHKPT")=TIUDA
"RTN","TIUP149",66,0)
 . ;
"RTN","TIUP149",67,0)
 . ;Check if user requested to stop task
"RTN","TIUP149",68,0)
 . I $$S^%ZTLOAD S ZTSTOP=1
"RTN","TIUP149",69,0)
 ;
"RTN","TIUP149",70,0)
 ;Send bulletin, re-set check point and clean up variables
"RTN","TIUP149",71,0)
 I $G(ZTSTOP) S ^XTMP("TIUP149","STOP")=$$NOW^XLFDT
"RTN","TIUP149",72,0)
 S ^XTMP("TIUP149","T1")=$$NOW^XLFDT
"RTN","TIUP149",73,0)
 ;
"RTN","TIUP149",74,0)
 D MAIL^TIUP149P
"RTN","TIUP149",75,0)
 ;
"RTN","TIUP149",76,0)
 I '$G(ZTSTOP) S ^XTMP("TIUP149","CHKPT")=""
"RTN","TIUP149",77,0)
 K TIURSTDA
"RTN","TIUP149",78,0)
 Q
"RTN","TIUP149",79,0)
 ;
"RTN","TIUP149",80,0)
CHKINF() ;Check if Integrated Facility
"RTN","TIUP149",81,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUP149",82,0)
 ; Output -- 1=Yes and 0=No
"RTN","TIUP149",83,0)
 N Y
"RTN","TIUP149",84,0)
 S Y=0
"RTN","TIUP149",85,0)
 I $$VERSION^XPDUTL("NDBI PRIMARY SYSTEM") S Y=1
"RTN","TIUP149",86,0)
 Q +$G(Y)
"RTN","TIUP149",87,0)
 ;
"RTN","TIUP149",88,0)
CLNONE(TIUDA,NDBIF) ;Entry point to clean up visit for one document
"RTN","TIUP149",89,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUP149",90,0)
 ;           NDBIF    Integrated Facility Flag  (Optional)
"RTN","TIUP149",91,0)
 ; Output -- None
"RTN","TIUP149",92,0)
 N TIUD0,TIUDFN,TIUMVSTF,TIUVSIT,VSIT
"RTN","TIUP149",93,0)
 ;
"RTN","TIUP149",94,0)
 ;Set variables
"RTN","TIUP149",95,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0))
"RTN","TIUP149",96,0)
 S TIUDFN=$P(TIUD0,U,2)
"RTN","TIUP149",97,0)
 S TIUVSIT=$P(TIUD0,U,3)
"RTN","TIUP149",98,0)
 ;
"RTN","TIUP149",99,0)
 ;Check if document linked to a different patient's visit can be
"RTN","TIUP149",100,0)
 ;cleaned up
"RTN","TIUP149",101,0)
 I TIUVSIT>0,TIUDFN>0,+$G(^AUPNVSIT(+TIUVSIT,0)),$P(^(0),U,5)'=TIUDFN,$$CHKDOC(TIUDA,+$P(TIUD0,U,6),+TIUD0) D
"RTN","TIUP149",102,0)
 . ;Exclude NDBI records
"RTN","TIUP149",103,0)
 . I TIUVSIT=1,$G(NDBIF) D SETXTMP(TIUDA,3) Q
"RTN","TIUP149",104,0)
 . ;Get correct visit to associate with document
"RTN","TIUP149",105,0)
 . D GETVST(TIUDA,TIUDFN,+$P(TIUD0,U,6),.VSIT,.TIUMVSTF)
"RTN","TIUP149",106,0)
 . ;If only one visit update the document with the visit
"RTN","TIUP149",107,0)
 . I $G(VSIT)>0,'$G(TIUMVSTF) D
"RTN","TIUP149",108,0)
 . . I $G(VSIT),$$UPDVST^TIUPXAP2(TIUDA,VSIT) D
"RTN","TIUP149",109,0)
 . . . ;Document linked to visit
"RTN","TIUP149",110,0)
 . . . D SETXTMP(TIUDA,,VSIT)
"RTN","TIUP149",111,0)
 . . . ;Update kids that are addenda or components
"RTN","TIUP149",112,0)
 . . . D UPDKIDS(TIUDA,VSIT)
"RTN","TIUP149",113,0)
 . . ELSE  D
"RTN","TIUP149",114,0)
 . . . ;Unable to correct - entry in use
"RTN","TIUP149",115,0)
 . . . D SETXTMP(TIUDA,1)
"RTN","TIUP149",116,0)
 . ELSE  D
"RTN","TIUP149",117,0)
 . . ;Unlink document from visit
"RTN","TIUP149",118,0)
 . . I $$DELVST(TIUDA) D
"RTN","TIUP149",119,0)
 . . . D SETXTMP(TIUDA,2)
"RTN","TIUP149",120,0)
 . . . ;Update kids that are addenda or components
"RTN","TIUP149",121,0)
 . . . D UPDKIDS(TIUDA)
"RTN","TIUP149",122,0)
 . . ELSE  D
"RTN","TIUP149",123,0)
 . . . ;Unable to correct - entry in use
"RTN","TIUP149",124,0)
 . . . D SETXTMP(TIUDA,1)
"RTN","TIUP149",125,0)
 S ^XTMP("TIUP149","CNT","TOT")=+$G(^XTMP("TIUP149","CNT","TOT"))+1
"RTN","TIUP149",126,0)
 Q
"RTN","TIUP149",127,0)
 ;
"RTN","TIUP149",128,0)
CHKDOC(TIUDA,TIUDAD,TITLE) ;Check if document can be cleaned up
"RTN","TIUP149",129,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUP149",130,0)
 ;           TIUDAD   TIU document file (#8925) Parent's IEN
"RTN","TIUP149",131,0)
 ;           TITLE    TIU Document Definition file (#8925.1) IEN
"RTN","TIUP149",132,0)
 ; Output -- 1=Can be cleaned up and 0=Cannot be cleaned up
"RTN","TIUP149",133,0)
 N TIUD13,Y
"RTN","TIUP149",134,0)
 ;
"RTN","TIUP149",135,0)
 ;Set variables
"RTN","TIUP149",136,0)
 S Y=0
"RTN","TIUP149",137,0)
 S TIUD13=$G(^TIU(8925,TIUDA,13))
"RTN","TIUP149",138,0)
 ;
"RTN","TIUP149",139,0)
 ;If document is an addendum or component and the parent and child visit fields
"RTN","TIUP149",140,0)
 ;are different, set clean-up flag to yes
"RTN","TIUP149",141,0)
 I +$$ISADDNDM^TIULC1(TIUDA)!(+$$ISCOMP^TIUBR(TIUDA)) D  G CHKDOCQ
"RTN","TIUP149",142,0)
 . I $P($G(^TIU(8925,+TIUDAD,0)),U,3)'=$P($G(^TIU(8925,TIUDA,0)),U,3) S Y=1
"RTN","TIUP149",143,0)
 ;
"RTN","TIUP149",144,0)
 ;If capture method is converted or reference date is before 10/1/98 or
"RTN","TIUP149",145,0)
 ;document is a discharge summary, set clean up flag to yes
"RTN","TIUP149",146,0)
 I ("^C^")[(U_$P(TIUD13,U,3)_U)!(+TIUD13&(+TIUD13<2981001))!(+$$ISDS^TIULX(TITLE)) S Y=1
"RTN","TIUP149",147,0)
 ;
"RTN","TIUP149",148,0)
CHKDOCQ Q +$G(Y)
"RTN","TIUP149",149,0)
 ;
"RTN","TIUP149",150,0)
GETVST(TIUDA,TIUDFN,TIUDAD,VSIT,TIUMVSTF) ;Get visit to associate with document
"RTN","TIUP149",151,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUP149",152,0)
 ;           TIUDFN   Patient file (#2) IEN
"RTN","TIUP149",153,0)
 ;           TIUDAD   TIU document file (#8925) Parent's IEN
"RTN","TIUP149",154,0)
 ; Output -- VSIT     Visit file (#9000010) IEN
"RTN","TIUP149",155,0)
 ;           TIUMVSTF Multiple Visit Flag
"RTN","TIUP149",156,0)
 ;           1=Multiple Visits
"RTN","TIUP149",157,0)
 ;
"RTN","TIUP149",158,0)
 N TIUD13,TIUDTM,TIUHL,VSITS
"RTN","TIUP149",159,0)
 ;
"RTN","TIUP149",160,0)
 ;Set variables
"RTN","TIUP149",161,0)
 S TIUD13=$G(^TIU(8925,TIUDA,13))
"RTN","TIUP149",162,0)
 S TIUHL=$P($G(^TIU(8925,TIUDA,12)),U,11)
"RTN","TIUP149",163,0)
 ;
"RTN","TIUP149",164,0)
 ;Check if document is an addendum or component, if it is use visit of parent
"RTN","TIUP149",165,0)
 I +$$ISADDNDM^TIULC1(TIUDA)!(+$$ISCOMP^TIUBR(TIUDA)) D  G GETVSTQ
"RTN","TIUP149",166,0)
 . I $D(^TIU(8925,+TIUDAD,0)),$P(^(0),U,3)>0 S VSIT=$P(^(0),U,3) D
"RTN","TIUP149",167,0)
 . . I $P($G(^AUPNVSIT(+VSIT,0)),U,5)'=TIUDFN S VSIT=""
"RTN","TIUP149",168,0)
 ;
"RTN","TIUP149",169,0)
 ;If document is converted, check PCE for a visit
"RTN","TIUP149",170,0)
 I (("^C^")[(U_$P(TIUD13,U,3)_U)) D
"RTN","TIUP149",171,0)
 . ;For DS use patient movement date/time, otherwise use reference date/time
"RTN","TIUP149",172,0)
 . I +$$ISDS^TIULX(+$G(^TIU(8925,TIUDA,0))) D
"RTN","TIUP149",173,0)
 . . I +$G(^TIU(8925,TIUDA,14))>0,+$G(^DGPM(+^(14),0))>0 S TIUDTM=+^(0)
"RTN","TIUP149",174,0)
 . ELSE  D
"RTN","TIUP149",175,0)
 . . I +TIUD13>0 S TIUDTM=+TIUD13
"RTN","TIUP149",176,0)
 . ;Check PCE for a visit
"RTN","TIUP149",177,0)
 . I $G(TIUDTM) D
"RTN","TIUP149",178,0)
 . . S VSITS=$$GETENC^PXAPI(TIUDFN,TIUDTM,TIUHL)
"RTN","TIUP149",179,0)
 . . I VSITS>0 S VSIT=+VSITS
"RTN","TIUP149",180,0)
 . . ;Set a flag if multiple visits
"RTN","TIUP149",181,0)
 . . I $P(VSITS,U,2)'="" S TIUMVSTF=1
"RTN","TIUP149",182,0)
GETVSTQ Q
"RTN","TIUP149",183,0)
 ;
"RTN","TIUP149",184,0)
SETXTMP(TIUDA,TIUEX,VSIT) ;Set ^XTMP for entries processed
"RTN","TIUP149",185,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUP149",186,0)
 ;           TIUEX    Unable to correct Exception types:  (Optional)
"RTN","TIUP149",187,0)
 ;                    1=Entry in Use
"RTN","TIUP149",188,0)
 ;                    2=Unlink Visit
"RTN","TIUP149",189,0)
 ;                    3=NDBI Fix Needed
"RTN","TIUP149",190,0)
 ;           VSIT     Visit file (#9000010) IEN  (Optional)
"RTN","TIUP149",191,0)
 ; Output -- Set ^XTMP("TIUP149","LNK",TIUDA)=
"RTN","TIUP149",192,0)
 ;               1st piece= 1=Linked and 0=Not Linked
"RTN","TIUP149",193,0)
 ;               2nd piece= Exception type if not linked
"RTN","TIUP149",194,0)
 ;               3rd piece= Visit file (#9000010) IEN if linked
"RTN","TIUP149",195,0)
 I $G(TIUEX) D
"RTN","TIUP149",196,0)
 . S ^XTMP("TIUP149","LNK",TIUDA)=0_U_$G(TIUEX)
"RTN","TIUP149",197,0)
 . S ^XTMP("TIUP149","CNT","EX",TIUEX)=+$G(^XTMP("TIUP149","CNT","EX",TIUEX))+1
"RTN","TIUP149",198,0)
 . S ^XTMP("TIUP149","CNT","EX")=+$G(^XTMP("TIUP149","CNT","EX"))+1
"RTN","TIUP149",199,0)
 ELSE  D
"RTN","TIUP149",200,0)
 . S ^XTMP("TIUP149","LNK",TIUDA)=1_U_U_$G(VSIT)
"RTN","TIUP149",201,0)
 . S ^XTMP("TIUP149","CNT","LNK")=+$G(^XTMP("TIUP149","CNT","LNK"))+1
"RTN","TIUP149",202,0)
 Q
"RTN","TIUP149",203,0)
 ;
"RTN","TIUP149",204,0)
DELVST(TIUDA,ERROR) ;Delete Visit in TIU Document file #8925
"RTN","TIUP149",205,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUP149",206,0)
 ; Output -- 1=Successful and 0=Failure
"RTN","TIUP149",207,0)
 ;           ERROR    Error Message  (Optional)
"RTN","TIUP149",208,0)
 N DIERR,OKF,TIUFDA
"RTN","TIUP149",209,0)
 ;
"RTN","TIUP149",210,0)
 ;Update document with visit
"RTN","TIUP149",211,0)
 S TIUFDA(8925,TIUDA_",",.03)="@"
"RTN","TIUP149",212,0)
 L +^TIU(8925,TIUDA):1 I $T D
"RTN","TIUP149",213,0)
 . D FILE^DIE("","TIUFDA","") L -^TIU(8925,TIUDA)
"RTN","TIUP149",214,0)
 . S ERROR=$G(DIERR)
"RTN","TIUP149",215,0)
 . S OKF=$S(+$G(ERROR):0,1:1)
"RTN","TIUP149",216,0)
 ELSE  D
"RTN","TIUP149",217,0)
 . S OKF=0
"RTN","TIUP149",218,0)
DELVSTQ Q +$G(OKF)
"RTN","TIUP149",219,0)
 ;
"RTN","TIUP149",220,0)
UPDKIDS(TIUDA,VSIT) ;Update Visit for kids that are addenda or components
"RTN","TIUP149",221,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUP149",222,0)
 ;           VSIT     Visit file (#9000010) IEN  (Optional)
"RTN","TIUP149",223,0)
 ; Output -- None
"RTN","TIUP149",224,0)
 N TIUKID
"RTN","TIUP149",225,0)
 S TIUKID=0
"RTN","TIUP149",226,0)
 F  S TIUKID=$O(^TIU(8925,"DAD",TIUDA,TIUKID)) Q:'TIUKID  D
"RTN","TIUP149",227,0)
 . ;If document is an addendum or component and visit of parent is different than visit of kid
"RTN","TIUP149",228,0)
 . I (+$$ISADDNDM^TIULC1(TIUKID)!(+$$ISCOMP^TIUBR(TIUKID))),$G(VSIT)'=$P($G(^TIU(8925,TIUKID,0)),U,3) D
"RTN","TIUP149",229,0)
 . . ;Link kid to visit
"RTN","TIUP149",230,0)
 . . I $G(VSIT)>0 D
"RTN","TIUP149",231,0)
 . . . I $$UPDVST^TIUPXAP2(TIUKID,VSIT) D
"RTN","TIUP149",232,0)
 . . . . D SETXTMP(TIUKID,,VSIT)
"RTN","TIUP149",233,0)
 . . . ELSE  D
"RTN","TIUP149",234,0)
 . . . . D SETXTMP(TIUKID,1)
"RTN","TIUP149",235,0)
 . . ELSE  D
"RTN","TIUP149",236,0)
 . . . ;Unlink kid from visit
"RTN","TIUP149",237,0)
 . . . I $$DELVST(TIUKID) D
"RTN","TIUP149",238,0)
 . . . . D SETXTMP(TIUKID,2)
"RTN","TIUP149",239,0)
 . . . ELSE  D
"RTN","TIUP149",240,0)
 . . . . D SETXTMP(TIUKID,1)
"RTN","TIUP149",241,0)
 Q
"RTN","TIUP149P")
0^3^B26475337
"RTN","TIUP149P",1,0)
TIUP149P ; SLC/JAK,RMO - Post-Install for TIU*1*149 Cont.;10/30/02@09:27:47
"RTN","TIUP149P",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**149**;Jun 20, 1997
"RTN","TIUP149P",3,0)
PRINT ; -- Device Selection
"RTN","TIUP149P",4,0)
 N EXNDBIF,TIUOUT
"RTN","TIUP149P",5,0)
 W !!,"This routine will print the results of the clean up routine in patch"
"RTN","TIUP149P",6,0)
 W !,"TIU*1*149 which provides a clean up for documents pointing to a different"
"RTN","TIUP149P",7,0)
 W !,"patient's visit in the TIU DOCUMENT file (#8925)."
"RTN","TIUP149P",8,0)
 ;
"RTN","TIUP149P",9,0)
 ;If integrated facility, ask about excluding NDBI fix needed records
"RTN","TIUP149P",10,0)
 I $$CHKINF^TIUP149,$$ASKEX(.TIUOUT) S EXNDBIF=1
"RTN","TIUP149P",11,0)
 G PRINTQ:$G(TIUOUT)
"RTN","TIUP149P",12,0)
 ;
"RTN","TIUP149P",13,0)
 W !!,*7,"This report requires a column width of 132.",!
"RTN","TIUP149P",14,0)
 S %ZIS="Q" D ^%ZIS I POP K POP G PRINTQ
"RTN","TIUP149P",15,0)
 I $D(IO("Q")) K IO("Q") D  Q
"RTN","TIUP149P",16,0)
 . I $G(EXNDBIF) S ZTSAVE("EXNDBIF")=""
"RTN","TIUP149P",17,0)
 . S ZTRTN="LIST^TIUP149P"
"RTN","TIUP149P",18,0)
 . S ZTDESC="TIU*1*149 - PRINT CLEAN-UP RESULTS"
"RTN","TIUP149P",19,0)
 . D ^%ZTLOAD W !,$S($D(ZTSK):"Request queued",1:"Request Cancelled!")
"RTN","TIUP149P",20,0)
 . K ZTSK,ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE,%ZIS
"RTN","TIUP149P",21,0)
 . D HOME^%ZIS
"RTN","TIUP149P",22,0)
 U IO D LIST,^%ZISC
"RTN","TIUP149P",23,0)
PRINTQ Q
"RTN","TIUP149P",24,0)
 ;
"RTN","TIUP149P",25,0)
ASKEX(TIUOUT) ;Ask if user would like to exclude NDBI fix needed records
"RTN","TIUP149P",26,0)
 ; Input  -- None
"RTN","TIUP149P",27,0)
 ; Output -- 1=Yes and 0=No
"RTN","TIUP149P",28,0)
 ;           TIUOUT   Timeout or up-arow flag
"RTN","TIUP149P",29,0)
 N DIR,DTOUT,DUOUT,Y
"RTN","TIUP149P",30,0)
 S DIR("A")="Do you want to exclude 'NDBI Fix Needed' records from the report"
"RTN","TIUP149P",31,0)
 S DIR("B")="YES",DIR(0)="Y"
"RTN","TIUP149P",32,0)
 W ! D ^DIR
"RTN","TIUP149P",33,0)
 I $D(DTOUT)!($D(DUOUT)) S TIUOUT=1
"RTN","TIUP149P",34,0)
 Q +$G(Y)
"RTN","TIUP149P",35,0)
 ;
"RTN","TIUP149P",36,0)
LIST ; -- Entry point to generate list
"RTN","TIUP149P",37,0)
 N TIUDA,TIULNK,TIUOUT S TIUOUT=0
"RTN","TIUP149P",38,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","TIUP149P",39,0)
 D HDR
"RTN","TIUP149P",40,0)
 I +$O(^XTMP("TIUP149","LNK",0))'>0 W !?4,"No records in list." G LISTQ
"RTN","TIUP149P",41,0)
 S TIUDA=0
"RTN","TIUP149P",42,0)
 F  S TIUDA=$O(^XTMP("TIUP149","LNK",TIUDA)) Q:'TIUDA!(TIUOUT)  S TIULNK=$G(^(TIUDA)) D LISTONE(TIUDA,TIULNK,$G(EXNDBIF))
"RTN","TIUP149P",43,0)
LISTQ K EXNDBIF
"RTN","TIUP149P",44,0)
 Q
"RTN","TIUP149P",45,0)
 ;
"RTN","TIUP149P",46,0)
LISTONE(TIUDA,TIULNK,EXNDBIF) ;Entry point to list one record
"RTN","TIUP149P",47,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUP149P",48,0)
 ;           TIULNK   1st piece= 1=Linked and 0=Not Linked
"RTN","TIUP149P",49,0)
 ;                    2nd piece= Exception type if not linked
"RTN","TIUP149P",50,0)
 ;                    3rd piece= Visit file (#9000010) IEN if linked
"RTN","TIUP149P",51,0)
 ;           EXNDBIF  Exclude "NDBI Fix Needed" records flag  (Optional) 
"RTN","TIUP149P",52,0)
 ; Output -- None
"RTN","TIUP149P",53,0)
 N DFN,TIUEX,VADM,VAIP,VAIN,VA
"RTN","TIUP149P",54,0)
 I $Y>(IOSL-4) D ASK G LISTONEQ:TIUOUT  D HDR
"RTN","TIUP149P",55,0)
 S DFN=+$P($G(^TIU(8925,+TIUDA,0)),U,2)
"RTN","TIUP149P",56,0)
 S TIUEX=+$P($G(TIULNK),U,2)
"RTN","TIUP149P",57,0)
 ;
"RTN","TIUP149P",58,0)
 ;If exclude NDBI record flag set and NDBI record, exit
"RTN","TIUP149P",59,0)
 I $G(EXNDBIF),TIUEX=3 G LISTONEQ
"RTN","TIUP149P",60,0)
 D OERR^VADPT
"RTN","TIUP149P",61,0)
 W !,$E($G(VADM(1)),1,20)_" ("_$G(VA("BID"))_")"
"RTN","TIUP149P",62,0)
 W ?30,TIUDA
"RTN","TIUP149P",63,0)
 W ?42,$E($P($G(^TIU(8925.1,+$G(^TIU(8925,+TIUDA,0)),0)),U,1),1,15)
"RTN","TIUP149P",64,0)
 I +$G(TIULNK),$P(TIULNK,U,3) D
"RTN","TIUP149P",65,0)
 . N DA,DIC,DIQ,DR,TIUVISIT
"RTN","TIUP149P",66,0)
 . S DIC="^AUPNVSIT(",DIQ="TIUVISIT",DIQ(0)="E",DA=+$P(TIULNK,U,3)
"RTN","TIUP149P",67,0)
 . S DR=".01;.22" D EN^DIQ1
"RTN","TIUP149P",68,0)
 . W ?60,$G(TIUVISIT(9000010,DA,.01,"E"))
"RTN","TIUP149P",69,0)
 . W ?84,$E($G(TIUVISIT(9000010,DA,.22,"E")),1,20)
"RTN","TIUP149P",70,0)
 . W ?106,"Yes - Visit #"_$P(TIULNK,U,3)
"RTN","TIUP149P",71,0)
 ELSE  D
"RTN","TIUP149P",72,0)
 . W ?106,"No  - "
"RTN","TIUP149P",73,0)
 . W $S(TIUEX=1:"Entry in Use",TIUEX=2:"Unlinked Visit",TIUEX=3:"NDBI Fix Needed",1:"")
"RTN","TIUP149P",74,0)
LISTONEQ Q
"RTN","TIUP149P",75,0)
 ;
"RTN","TIUP149P",76,0)
ASK ; -- End of Page
"RTN","TIUP149P",77,0)
 I IO=IO(0),$E(IOST)="C" D
"RTN","TIUP149P",78,0)
 . W ! N DIR,X,Y S DIR(0)="E"
"RTN","TIUP149P",79,0)
 . D ^DIR I $D(DUOUT)!$D(DTOUT) S TIUOUT=1
"RTN","TIUP149P",80,0)
 Q
"RTN","TIUP149P",81,0)
 ;
"RTN","TIUP149P",82,0)
HDR ; -- Header for report
"RTN","TIUP149P",83,0)
 N LNE,TIUNOW
"RTN","TIUP149P",84,0)
 D NOW^%DTC S Y=% X ^DD("DD") S TIUNOW=Y
"RTN","TIUP149P",85,0)
 W @IOF,"TIU*1*149 TIU DOCUMENTS LINKED TO A DIFFERENT PATIENT'S VISIT CLEAN-UP - Printed: ",TIUNOW
"RTN","TIUP149P",86,0)
 W !,"Patient",?30,"Document #",?42,"Title",?60,"Visit Date/Time",?84,"Hospital Location",?106,"Linked"
"RTN","TIUP149P",87,0)
 W ! S LNE="",$P(LNE,"-",(IOM-1))="" W LNE
"RTN","TIUP149P",88,0)
 Q
"RTN","TIUP149P",89,0)
 ;
"RTN","TIUP149P",90,0)
MAIL ;Send completion message to user who initiated post-install
"RTN","TIUP149P",91,0)
 N XMSUB,XMTEXT,XMDUZ,XMY,XMZ,XMMG
"RTN","TIUP149P",92,0)
 N TIURNG,TIUTXT
"RTN","TIUP149P",93,0)
 S XMDUZ="PATCH TIU*1*149 TIU DOCUMENT CLEAN-UP RESULTS",XMY(.5)=""
"RTN","TIUP149P",94,0)
 S:$G(DUZ) XMY(DUZ)=""
"RTN","TIUP149P",95,0)
 S XMY("G.PATIENT SAFETY NOTIFICATIONS")=""
"RTN","TIUP149P",96,0)
 S TIUTXT(1)="Clean up TIU Documents linked to a different patient's visit."
"RTN","TIUP149P",97,0)
 S TIUTXT(2)=""
"RTN","TIUP149P",98,0)
 S TIUTXT(3)="Task Started: "_$$FMTE^XLFDT($G(^XTMP("TIUP149","T0")))
"RTN","TIUP149P",99,0)
 S TIUTXT(4)="Task   Ended: "_$$FMTE^XLFDT($G(^XTMP("TIUP149","T1")))
"RTN","TIUP149P",100,0)
 S TIUTXT(5)=""
"RTN","TIUP149P",101,0)
 ;
"RTN","TIUP149P",102,0)
 S TIUTXT(6)="Number of entries linked to Correct Visit: "_+$G(^XTMP("TIUP149","CNT","LNK"))
"RTN","TIUP149P",103,0)
 S TIUTXT(7)=""
"RTN","TIUP149P",104,0)
 S TIUTXT(8)="Number of entries not corrected because Entry in Use: "_+$G(^XTMP("TIUP149","CNT","EX",1))
"RTN","TIUP149P",105,0)
 S TIUTXT(9)=""
"RTN","TIUP149P",106,0)
 S TIUTXT(10)="Number of entries unlinked from Incorrect Visit: "_+$G(^XTMP("TIUP149","CNT","EX",2))
"RTN","TIUP149P",107,0)
 S TIUTXT(11)=""
"RTN","TIUP149P",108,0)
 S TIUTXT(12)="TOTAL Number of entries processed: "_+$G(^XTMP("TIUP149","CNT","TOT"))
"RTN","TIUP149P",109,0)
 S TIUTXT(13)=""
"RTN","TIUP149P",110,0)
 I $G(^XTMP("TIUP149","STOP")) D
"RTN","TIUP149P",111,0)
 . S TIUTXT(14)="Task STOPPED: "_$$FMTE^XLFDT($G(^XTMP("TIUP149","STOP")))_"."
"RTN","TIUP149P",112,0)
 ELSE  D
"RTN","TIUP149P",113,0)
 . S TIUTXT(14)="Task COMPLETED successfully."
"RTN","TIUP149P",114,0)
 . S TIUTXT(15)=""
"RTN","TIUP149P",115,0)
 . S TIUTXT(16)="To print a detailed listing of the clean up invoke D PRINT^TIUP149P."
"RTN","TIUP149P",116,0)
 ;
"RTN","TIUP149P",117,0)
 I $G(NDBIF) D
"RTN","TIUP149P",118,0)
 . S TIUTXT(17)=""
"RTN","TIUP149P",119,0)
 . S TIUTXT(18)="SPECIAL NOTE FOR INTEGRATED FACILITIES:"
"RTN","TIUP149P",120,0)
 . S TIUTXT(19)=""
"RTN","TIUP149P",121,0)
 . S TIUTXT(20)="- Number of entries not corrected because NDBI Fix Needed: "_+$G(^XTMP("TIUP149","CNT","EX",3))
"RTN","TIUP149P",122,0)
 S XMTEXT="TIUTXT(",XMSUB="TIU*1*149 TIU Document Clean up for Different Patient's Visit"
"RTN","TIUP149P",123,0)
 D ^XMD
"RTN","TIUP149P",124,0)
 Q
"RTN","TIUPXAP1")
0^1^B25890136
"RTN","TIUPXAP1",1,0)
TIUPXAP1 ; SLC/JER - Interface w/PCE/Visit Tracking ;21-OCT-2002 16:45:37
"RTN","TIUPXAP1",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**15,29,20,89,82,107,117,126,124,149**;Jun 20, 1997
"RTN","TIUPXAP1",3,0)
QUE ; Use a RESOURCE to post visit tracking information in background
"RTN","TIUPXAP1",4,0)
 N ZTDTH,ZTIO,ZTSAVE,ZTSK,ZTRTN,ZTDESC
"RTN","TIUPXAP1",5,0)
 ; if there is already a visit, and no workload data quit
"RTN","TIUPXAP1",6,0)
 I +$P($G(TIUDPRM(0)),U,16),(+$P($G(^TIU(8925,$S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)),0)),U,11)=0),+$$WORKOK($S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA))) D  Q:'$$BROKER^XWBLIB
"RTN","TIUPXAP1",7,0)
 . D DEFER($S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)))
"RTN","TIUPXAP1",8,0)
 I +$G(TIU("VISIT")),($D(CPT)'>9) Q
"RTN","TIUPXAP1",9,0)
 I +$P($G(^TIU(8925,$S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)),0)),U,3),($D(CPT)'>9) Q
"RTN","TIUPXAP1",10,0)
 S (ZTSAVE("TIU("),ZTSAVE("DFN"),ZTSAVE("TIUDA"),ZTSAVE("DA"))=""
"RTN","TIUPXAP1",11,0)
 S (ZTSAVE("DUZ("),ZTSAVE("ICD("),ZTSAVE("CPT("),ZTSAVE("SC("))=""
"RTN","TIUPXAP1",12,0)
 S (ZTSAVE("TIUPRLST("),ZTSAVE("XWBOS"))=""
"RTN","TIUPXAP1",13,0)
 S ZTDTH=$H,ZTIO="TIU/PXAPI RESOURCE",ZTRTN="ENQ^TIUPXAP1"
"RTN","TIUPXAP1",14,0)
 S ZTDESC="TIU/PCE/AmbCare API Call" D ^%ZTLOAD
"RTN","TIUPXAP1",15,0)
 I '$D(ZTSK) D ENQ ; If can't get Resource, Run PXAPI call in foreground
"RTN","TIUPXAP1",16,0)
 Q
"RTN","TIUPXAP1",17,0)
WORKOK(DA) ; Evaluate whether workload collection is appropriate
"RTN","TIUPXAP1",18,0)
 N TIUD0 S TIUD0=$G(^TIU(8925,DA,0))
"RTN","TIUPXAP1",19,0)
 Q $S($P(TIUD0,U,13)="A":1,$P(TIUD0,U,13)="I":1,$P(TIUD0,U,13)="T":1,1:0)
"RTN","TIUPXAP1",20,0)
ENQ ; Entry point for Resource
"RTN","TIUPXAP1",21,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","TIUPXAP1",22,0)
 D POST(.TIU,DFN,$S(+$G(TIUDA):+$G(TIUDA),1:$G(DA)),.ICD,.CPT,.SC)
"RTN","TIUPXAP1",23,0)
 Q
"RTN","TIUPXAP1",24,0)
POST(TIUX,DFN,TIUDA,ICD,CPT,SC) ; Call on commitment to post data to PCE/AmbCare
"RTN","TIUPXAP1",25,0)
 N TIULOC,TIUVDT,TIUSTOP,TIUVCAT,TIUVSIT,TIUD0
"RTN","TIUPXAP1",26,0)
 S TIULOC=$P($G(TIUX("VSTR")),";"),TIUVDT=+$P($G(TIUX("VSTR")),";",2)
"RTN","TIUPXAP1",27,0)
 S TIUVCAT=$P($G(TIUX("VSTR")),";",3),TIUSTOP=$P($G(^SC(+TIULOC,0)),U,7)
"RTN","TIUPXAP1",28,0)
 D PXAPI(.TIUVSIT,DFN,TIULOC,TIUVDT,TIUVCAT,TIUSTOP,.ICD,.CPT,.SC,TIUDA)
"RTN","TIUPXAP1",29,0)
 I +$G(TIUVSIT)>0,+$G(TIUDA)>0,$D(^TIU(8925,+TIUDA,0)) S TIUD0=^(0) D
"RTN","TIUPXAP1",30,0)
 . I $P(TIUD0,U,2)=DFN,$P(TIUD0,U,7)=TIUVDT,$P($G(^TIU(8925,+TIUDA,12)),U,11)=TIULOC D
"RTN","TIUPXAP1",31,0)
 . . N DIE,DR,DA S DA=+$G(TIUDA)
"RTN","TIUPXAP1",32,0)
 . . S DIE=8925,DR=".03////^S X="_+$G(TIUVSIT)
"RTN","TIUPXAP1",33,0)
 . . D ^DIE
"RTN","TIUPXAP1",34,0)
 . . S TIUX("VISIT")=+$G(TIUVSIT)_U_TIUVDT
"RTN","TIUPXAP1",35,0)
 Q
"RTN","TIUPXAP1",36,0)
PXAPI(VSIT,DFN,VLOC,VDT,VCAT,VSTOP,ICD,CPT,SC,TIUDA) ; Build input root
"RTN","TIUPXAP1",37,0)
 N TIUPXAPI,SUCCESS,TIUI,TIUPROV,DA,TIUAUTH
"RTN","TIUPXAP1",38,0)
 K ^TMP("TIUPXAPI",$J) S TIUPXAPI=$NA(^TMP("TIUPXAPI",$J))
"RTN","TIUPXAP1",39,0)
 S:+$G(VDT) @TIUPXAPI@("ENCOUNTER",1,"ENC D/T")=+$G(VDT)
"RTN","TIUPXAP1",40,0)
 S:+$G(DFN) @TIUPXAPI@("ENCOUNTER",1,"PATIENT")=+$G(DFN)
"RTN","TIUPXAP1",41,0)
 S:+$G(VLOC) @TIUPXAPI@("ENCOUNTER",1,"HOS LOC")=+$G(VLOC)
"RTN","TIUPXAP1",42,0)
 I $D(SC)>9 D
"RTN","TIUPXAP1",43,0)
 . S @TIUPXAPI@("ENCOUNTER",1,"SC")=$P($G(SC("SC")),U)
"RTN","TIUPXAP1",44,0)
 . I $G(SC("AO"))]"" S @TIUPXAPI@("ENCOUNTER",1,"AO")=$P($G(SC("AO")),U)
"RTN","TIUPXAP1",45,0)
 . I $G(SC("IR"))]"" S @TIUPXAPI@("ENCOUNTER",1,"IR")=$P($G(SC("IR")),U)
"RTN","TIUPXAP1",46,0)
 . I $G(SC("EC"))]"" S @TIUPXAPI@("ENCOUNTER",1,"EC")=$P($G(SC("EC")),U)
"RTN","TIUPXAP1",47,0)
 . I $G(SC("MST"))]"" S @TIUPXAPI@("ENCOUNTER",1,"MST")=$P($G(SC("MST")),U)
"RTN","TIUPXAP1",48,0)
 . I $G(SC("HNC"))]"" S @TIUPXAPI@("ENCOUNTER",1,"HNC")=$P($G(SC("HNC")),U)
"RTN","TIUPXAP1",49,0)
 I $D(CPT) S @TIUPXAPI@("ENCOUNTER",1,"CHECKOUT D/T")=$E($$NOW^XLFDT,1,12)
"RTN","TIUPXAP1",50,0)
 S:$G(VCAT)]"" @TIUPXAPI@("ENCOUNTER",1,"SERVICE CATEGORY")=$G(VCAT)
"RTN","TIUPXAP1",51,0)
 S:+$G(VSTOP) @TIUPXAPI@("ENCOUNTER",1,"DSS ID")=+$G(VSTOP)
"RTN","TIUPXAP1",52,0)
 S @TIUPXAPI@("ENCOUNTER",1,"APPT")=9
"RTN","TIUPXAP1",53,0)
 S @TIUPXAPI@("ENCOUNTER",1,"ENCOUNTER TYPE")="P"
"RTN","TIUPXAP1",54,0)
 I $D(TIUPRLST) D
"RTN","TIUPXAP1",55,0)
 . M @TIUPXAPI@("PROVIDER")=TIUPRLST
"RTN","TIUPXAP1",56,0)
 . S TIUPROV=$S($G(TIUPRLST(1,"PRIMARY")):$G(TIUPRLST(1,"NAME")),1:$G(TIUPRLST(2,"NAME")))
"RTN","TIUPXAP1",57,0)
 E  D
"RTN","TIUPXAP1",58,0)
 . N TIUDDOC
"RTN","TIUPXAP1",59,0)
 . I +$G(TIUDA) D
"RTN","TIUPXAP1",60,0)
 . . S TIUAUTH=$P($G(^TIU(8925,+$G(TIUDA),12)),U,2) Q:+TIUAUTH'>0
"RTN","TIUPXAP1",61,0)
 . . I +$$PROVIDER(TIUAUTH,$G(VDT))'>0 S TIUAUTH=0
"RTN","TIUPXAP1",62,0)
 . S TIUDDOC=+$$DFLTDOC^TIUPXAPI(+$G(VLOC))
"RTN","TIUPXAP1",63,0)
 . D:'$D(TIUPRM0) SETPARM^TIULE
"RTN","TIUPXAP1",64,0)
 . S TIUPROV=$S(+$G(TIUAUTH):+$G(TIUAUTH),+$$PROVIDER(DUZ,$G(VDT)):+$G(DUZ),1:"")
"RTN","TIUPXAP1",65,0)
 . I +TIUPROV>0,'$D(XWBOS) D
"RTN","TIUPXAP1",66,0)
 . . I +TIUDDOC'=+TIUPROV,(+$P(TIUPRM0,U,8)=1) D
"RTN","TIUPXAP1",67,0)
 . . . S @TIUPXAPI@("PROVIDER",1,"NAME")=+TIUDDOC
"RTN","TIUPXAP1",68,0)
 . . . S @TIUPXAPI@("PROVIDER",1,"PRIMARY")=1
"RTN","TIUPXAP1",69,0)
 . . . S @TIUPXAPI@("PROVIDER",2,"NAME")=+TIUPROV
"RTN","TIUPXAP1",70,0)
 . . . S @TIUPXAPI@("PROVIDER",2,"PRIMARY")=0
"RTN","TIUPXAP1",71,0)
 . . E  D
"RTN","TIUPXAP1",72,0)
 . . . S @TIUPXAPI@("PROVIDER",1,"NAME")=+TIUPROV
"RTN","TIUPXAP1",73,0)
 I $D(ICD)>9 S TIUI=0 F  S TIUI=$O(ICD(TIUI)) Q:+TIUI'>0  D
"RTN","TIUPXAP1",74,0)
 . S @TIUPXAPI@("DX/PL",TIUI,"ENC PROVIDER")=$G(TIUPROV)
"RTN","TIUPXAP1",75,0)
 . S @TIUPXAPI@("DX/PL",TIUI,"DIAGNOSIS")=$P(ICD(TIUI),U)
"RTN","TIUPXAP1",76,0)
 . S @TIUPXAPI@("DX/PL",TIUI,"NARRATIVE")=$P(ICD(TIUI),U,3)
"RTN","TIUPXAP1",77,0)
 . S:$P(ICD(TIUI),U,4)]"" @TIUPXAPI@("DX/PL",TIUI,"CATEGORY")=$P(ICD(TIUI),U,4)
"RTN","TIUPXAP1",78,0)
 . S:+$G(ICD(TIUI,"PRIMARY")) @TIUPXAPI@("DX/PL",TIUI,"PRIMARY")=$G(ICD(TIUI,"PRIMARY"))
"RTN","TIUPXAP1",79,0)
 I $D(CPT)>9 S TIUI=0 F  S TIUI=$O(CPT(TIUI)) Q:+TIUI'>0  D
"RTN","TIUPXAP1",80,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"PROCEDURE")=$P(CPT(TIUI),U)
"RTN","TIUPXAP1",81,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"QTY")=$S(+$G(CPT(TIUI,"QTY")):+$G(CPT(TIUI,"QTY")),1:1)
"RTN","TIUPXAP1",82,0)
 . ;Set CPT Modifiers in Array for PCE
"RTN","TIUPXAP1",83,0)
 . N MODCNT,MODATA
"RTN","TIUPXAP1",84,0)
 . S MODCNT=0
"RTN","TIUPXAP1",85,0)
 . F  S MODCNT=$O(CPT(TIUI,"MOD",MODCNT)) Q:'MODCNT  D
"RTN","TIUPXAP1",86,0)
 . . S MODATA=$G(CPT(TIUI,"MOD",MODCNT))
"RTN","TIUPXAP1",87,0)
 . . S:$P(MODATA,U,2)'="" @TIUPXAPI@("PROCEDURE",TIUI,"MODIFIERS",$P(MODATA,U,2))=""
"RTN","TIUPXAP1",88,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"ENC PROVIDER")=$G(TIUPROV)
"RTN","TIUPXAP1",89,0)
 . S @TIUPXAPI@("PROCEDURE",TIUI,"NARRATIVE")=$P(CPT(TIUI),U,2)
"RTN","TIUPXAP1",90,0)
 . S:$P(CPT(TIUI),U,3)]"" @TIUPXAPI@("PROCEDURE",TIUI,"CATEGORY")=$P(CPT(TIUI),U,3)
"RTN","TIUPXAP1",91,0)
 S SUCCESS=$$DATA2PCE^PXAPI(TIUPXAPI,"TIU","TEXT INTEGRATION UTILITIES",.VSIT,DUZ,0)
"RTN","TIUPXAP1",92,0)
 K @TIUPXAPI
"RTN","TIUPXAP1",93,0)
 Q
"RTN","TIUPXAP1",94,0)
PROVIDER(USER,DATE) ; Was USER a PROVIDER on DATE?
"RTN","TIUPXAP1",95,0)
 N TIUY,PRVCL,EXCL S TIUY=0
"RTN","TIUPXAP1",96,0)
 S EXCL="V0802V0805V0806V0808V0809V0812V0813"
"RTN","TIUPXAP1",97,0)
 I +$$ISA^USRLM(USER,"PROVIDER") S TIUY=1 G PROVIDEX
"RTN","TIUPXAP1",98,0)
 S PRVCL=$$PRVCLASS^PXAPI(USER,DATE) I PRVCL'>0 G PROVIDEX
"RTN","TIUPXAP1",99,0)
 I $P(PRVCL,U,7)]"",(EXCL'[$E($P(PRVCL,U,7),1,5)) S TIUY=1
"RTN","TIUPXAP1",100,0)
PROVIDEX Q TIUY
"RTN","TIUPXAP1",101,0)
DEFER(DA) ; Mark record to defer workload collection
"RTN","TIUPXAP1",102,0)
 N DIE,DR
"RTN","TIUPXAP1",103,0)
 I +$P($G(^TIU(8925,$S(+$G(TIUDA):+$G(TIUDA),1:+$G(DA)),0)),U,11)=1 Q
"RTN","TIUPXAP1",104,0)
 S DIE=8925,DR=".11////1" D ^DIE
"RTN","TIUPXAP1",105,0)
 Q
"RTN","TIUPXAP2")
0^4^B32251106
"RTN","TIUPXAP2",1,0)
TIUPXAP2 ; SLC/JER - More code for the workload capture ;12/4/02@07:54:52
"RTN","TIUPXAP2",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**20,67,82,107,126,124,149**;Jun 20, 1997
"RTN","TIUPXAP2",3,0)
TEST ; Test the PXAPI Data Capture dialogs
"RTN","TIUPXAP2",4,0)
 N CPT,DFN,ICD,ICDARR,CPTARR,SC,DTOUT,TIU,TIUOK
"RTN","TIUPXAP2",5,0)
 S DFN=+$$PATIENT^TIULA
"RTN","TIUPXAP2",6,0)
 S TIU("LOC")=$$SELLOC^TIUVSIT
"RTN","TIUPXAP2",7,0)
 D GETICD^TIUPXAPI(TIU("LOC"),.ICDARR)
"RTN","TIUPXAP2",8,0)
 D ICD^TIUPXAPI(.ICD,.ICDARR)
"RTN","TIUPXAP2",9,0)
 D GETCPT^TIUPXAPC(TIU("LOC"),.CPTARR)
"RTN","TIUPXAP2",10,0)
CPTCALL D CPT^TIUPXAPC(.CPT,.CPTARR)
"RTN","TIUPXAP2",11,0)
 I '$D(CPT),'$D(DTOUT) W !!,$C(7),"You MUST enter one or more Procedures." G CPTCALL
"RTN","TIUPXAP2",12,0)
 D SCASK^TIUPXAPS(.SC,+DFN,.TIU)
"RTN","TIUPXAP2",13,0)
 I $D(DTOUT)!(+$O(ICD(0))'>0)&(+$O(CPT(0))'>0)&(+$O(SC(0))'>0) D  Q
"RTN","TIUPXAP2",14,0)
 . W !,$C(7),"Insufficient information for Workload Credit."
"RTN","TIUPXAP2",15,0)
 . W !,"Missing information will have to be captured by another method."
"RTN","TIUPXAP2",16,0)
 S TIUOK=$$CONFIRM^TIUPXAPI(.ICD,.CPT,.SC)
"RTN","TIUPXAP2",17,0)
 I '+TIUOK D  G TEST
"RTN","TIUPXAP2",18,0)
 . W !!,"Changes Discarded. Please Enter Corrected Workload Data..." H 3
"RTN","TIUPXAP2",19,0)
 . K ICD,CPT,SC,ICDARR,CPTARR
"RTN","TIUPXAP2",20,0)
 K CPTARR,ICDARR
"RTN","TIUPXAP2",21,0)
 W "Done."
"RTN","TIUPXAP2",22,0)
 Q
"RTN","TIUPXAP2",23,0)
CMBLST(EMCODES,CPTCODES) ; Combine E/M and other CPT codes
"RTN","TIUPXAP2",24,0)
 N TIUI,TIUJ,TMPARRY S (TIUI,TIUJ)=0
"RTN","TIUPXAP2",25,0)
 M TMPARRY=EMCODES S TIUI=EMCODES(0)
"RTN","TIUPXAP2",26,0)
 F  S TIUJ=$O(CPTCODES(TIUJ)) Q:+TIUJ'>0  D
"RTN","TIUPXAP2",27,0)
 . S TIUI=+$G(TIUI)+1,TMPARRY(TIUI)=CPTCODES(TIUJ),TMPARRY(0)=TIUI
"RTN","TIUPXAP2",28,0)
 . ;Merge CPT Modifiers
"RTN","TIUPXAP2",29,0)
 . M TMPARRY(TIUI,"MODIFIER")=CPTCODES(TIUJ,"MODIFIER")
"RTN","TIUPXAP2",30,0)
 K CPTCODES
"RTN","TIUPXAP2",31,0)
 M CPTCODES=TMPARRY
"RTN","TIUPXAP2",32,0)
 Q
"RTN","TIUPXAP2",33,0)
PICK(LOW,HIGH,PROMPT,TYPE) ; List selection
"RTN","TIUPXAP2",34,0)
 N X,Y S PROMPT=$G(PROMPT,"Select Item"),TYPE=$G(TYPE,"LO")
"RTN","TIUPXAP2",35,0)
 W !
"RTN","TIUPXAP2",36,0)
 S Y=$$READ^TIUU(TYPE_U_LOW_":"_HIGH,PROMPT)
"RTN","TIUPXAP2",37,0)
 Q Y
"RTN","TIUPXAP2",38,0)
EDTENC(TIUDA,CHNG) ; Edit the encounter for a given note
"RTN","TIUPXAP2",39,0)
 N TIUD0,TIUD12,TIUDFN,TIUI,TIUVSIT,TIUHL,TIUEDT,TIUPAUSE,TIUERR,TIUWHAT
"RTN","TIUPXAP2",40,0)
 N TIUCONT,DA
"RTN","TIUPXAP2",41,0)
 Q:$D(XWBOS)
"RTN","TIUPXAP2",42,0)
 Q:+$P($G(TIUDPRM(0)),U,14)
"RTN","TIUPXAP2",43,0)
 D FULL^VALM1
"RTN","TIUPXAP2",44,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD12=$G(^(12))
"RTN","TIUPXAP2",45,0)
 S TIUHL=$P(TIUD12,U,11)
"RTN","TIUPXAP2",46,0)
 I $P($G(^SC(+TIUHL,0)),U,3)'="C" Q
"RTN","TIUPXAP2",47,0)
 ;
"RTN","TIUPXAP2",48,0)
 ;If not ok to ask workload, quit
"RTN","TIUPXAP2",49,0)
 I '$$WORKOK^TIUPXAP1(+TIUDA) Q
"RTN","TIUPXAP2",50,0)
 ;
"RTN","TIUPXAP2",51,0)
 S TIUDFN=$P(TIUD0,U,2),TIUEDT=$P(TIUD0,U,7),TIUVSIT=$P(TIUD0,U,3)
"RTN","TIUPXAP2",52,0)
 N TIUMVSTF,TIUVSITS
"RTN","TIUPXAP2",53,0)
 ;If no visit has been filed with the document
"RTN","TIUPXAP2",54,0)
 I $G(TIUVSIT)'>0 D
"RTN","TIUPXAP2",55,0)
 . ;Check for the visit
"RTN","TIUPXAP2",56,0)
 . S TIUVSITS=$$GETENC^PXAPI(TIUDFN,TIUEDT,TIUHL)
"RTN","TIUPXAP2",57,0)
 . I TIUVSITS>0 S TIUVSIT=+TIUVSITS
"RTN","TIUPXAP2",58,0)
 . ;Set a flag if multiple visits
"RTN","TIUPXAP2",59,0)
 . I $P(TIUVSITS,U,2)'="" S TIUMVSTF=1
"RTN","TIUPXAP2",60,0)
 . ;If only one visit update the document
"RTN","TIUPXAP2",61,0)
 . I $G(TIUVSIT)>0,'$G(TIUMVSTF) D
"RTN","TIUPXAP2",62,0)
 . . S TIUERR=$$UPDVST(TIUDA,TIUVSIT)
"RTN","TIUPXAP2",63,0)
 W !!
"RTN","TIUPXAP2",64,0)
 ;Ask the user if they wish to enter workload if the parameter is defined
"RTN","TIUPXAP2",65,0)
 ;and the multiple visit flag is not set
"RTN","TIUPXAP2",66,0)
 I $D(TIUDPRM(0)),'$G(TIUMVSTF),$G(TIUVSIT)>0 D  Q:'+TIUCONT
"RTN","TIUPXAP2",67,0)
 . S TIUCONT=$$READ^TIUU("Y","Do you wish to enter workload data at this time","YES")
"RTN","TIUPXAP2",68,0)
 I $G(VALMAR)="^TMP(""TIUR"",$J)" D
"RTN","TIUPXAP2",69,0)
 . N TIU D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUPXAP2",70,0)
 . W !!,"For ",$G(TIU("PNM"))," ",$G(TIU("PID"))," Visit on "
"RTN","TIUPXAP2",71,0)
 . W $P($G(TIU("EDT")),U,2),"...",!
"RTN","TIUPXAP2",72,0)
 I $P($P(TIUD0,U,7),".")>DT D  Q
"RTN","TIUPXAP2",73,0)
 . W !!,$C(7),"ACRP will not accept data for future Encounters.",!
"RTN","TIUPXAP2",74,0)
 . W !,"Workload questions won't be asked for this note.",!
"RTN","TIUPXAP2",75,0)
 . S TIUPAUSE=$$READ^TIUU("EA","Press RETURN to continue...")
"RTN","TIUPXAP2",76,0)
 I $G(VALMAR)'="^TMP(""TIUR"",$J)" W !!,"Editing Encounter Data...",!
"RTN","TIUPXAP2",77,0)
 S TIUWHAT=$S($$CHKAPPT(TIUVSIT,TIUDFN,TIUEDT,TIUHL):"INTV",1:"ADDEDIT")
"RTN","TIUPXAP2",78,0)
 S TIUERR=$$INTV^PXAPI(TIUWHAT,"TIU","TEXT INTEGRATION UTILITIES",.TIUVSIT,$S(+$G(TIUVSIT):"",1:TIUHL),TIUDFN,$S(+$G(TIUVSIT):"",1:TIUEDT))
"RTN","TIUPXAP2",79,0)
 ;
"RTN","TIUPXAP2",80,0)
 ;If an error is returned prompt to continue otherwise if a Visit
"RTN","TIUPXAP2",81,0)
 ;IEN is returned and one is not already defined update the document
"RTN","TIUPXAP2",82,0)
 I +TIUERR<0 D
"RTN","TIUPXAP2",83,0)
 . W ! S TIUPAUSE=$$READ^TIUU("EA","Press RETURN to continue...")
"RTN","TIUPXAP2",84,0)
 ELSE  D
"RTN","TIUPXAP2",85,0)
 . I $G(TIUVSIT)>0,'$P($G(^TIU(8925,+TIUDA,0)),U,3) S TIUERR=$$UPDVST(TIUDA,TIUVSIT)
"RTN","TIUPXAP2",86,0)
 S CHNG=1
"RTN","TIUPXAP2",87,0)
 Q
"RTN","TIUPXAP2",88,0)
 ;
"RTN","TIUPXAP2",89,0)
CHKVST(TIUDA) ;Check the visit associated with the document for key workload
"RTN","TIUPXAP2",90,0)
 ;data elements.  Key data elements include provider, diagnosis,
"RTN","TIUPXAP2",91,0)
 ;procedure and classifications.
"RTN","TIUPXAP2",92,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUPXAP2",93,0)
 ; Output -- 0=No Key Workload Data Elements Exist
"RTN","TIUPXAP2",94,0)
 ;           1=Key Workload Data Elements Exist
"RTN","TIUPXAP2",95,0)
 ;           2=Unable to Determine if Key Workload Data Elements Exist
"RTN","TIUPXAP2",96,0)
 N I,TIUCHKF,TIUD0,TIUDFN,TIUEDT,TIUHL,TIUVSIT,TIUVSITS,X
"RTN","TIUPXAP2",97,0)
 ;
"RTN","TIUPXAP2",98,0)
 ;Set variables, if the 0th node of the document is not defined quit
"RTN","TIUPXAP2",99,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)) I TIUD0="" S TIUCHKF=2 G CHKVSTQ
"RTN","TIUPXAP2",100,0)
 S TIUDFN=$P(TIUD0,U,2),TIUVSIT=$P(TIUD0,U,3),TIUEDT=$P(TIUD0,U,7)
"RTN","TIUPXAP2",101,0)
 S TIUHL=$P($G(^TIU(8925,+TIUDA,12)),U,11)
"RTN","TIUPXAP2",102,0)
 ;
"RTN","TIUPXAP2",103,0)
 ;Get data associated with the visit
"RTN","TIUPXAP2",104,0)
 I $G(TIUVSIT)>0 D
"RTN","TIUPXAP2",105,0)
 . D ENCEVENT^PXKENC(TIUVSIT)
"RTN","TIUPXAP2",106,0)
 ELSE  D
"RTN","TIUPXAP2",107,0)
 . S TIUVSITS=$$GETENC^PXAPI(TIUDFN,TIUEDT,TIUHL)
"RTN","TIUPXAP2",108,0)
 . I TIUVSITS>0 S TIUVSIT=+TIUVSITS
"RTN","TIUPXAP2",109,0)
 . I $P(TIUVSITS,U,2)'="" S TIUCHKF=2 ;multiple visits
"RTN","TIUPXAP2",110,0)
 ;
"RTN","TIUPXAP2",111,0)
 ;If a visit is not defined or multiple visits exist, quit
"RTN","TIUPXAP2",112,0)
 I $G(TIUVSIT)'>0!($G(TIUCHKF)=2) G CHKVSTQ
"RTN","TIUPXAP2",113,0)
 ;
"RTN","TIUPXAP2",114,0)
 ;If a provider or diagnosis or procedure exists for the visit, set flag
"RTN","TIUPXAP2",115,0)
 ;and quit
"RTN","TIUPXAP2",116,0)
 I $D(^TMP("PXKENC",$J,TIUVSIT,"PRV"))!($D(^("CPT")))!($D(^("POV"))) S TIUCHKF=1 G CHKVSTQ
"RTN","TIUPXAP2",117,0)
 ;
"RTN","TIUPXAP2",118,0)
 ;If a classification exists for the visit, set flag and quit
"RTN","TIUPXAP2",119,0)
 I $D(^TMP("PXKENC",$J,TIUVSIT,"VST",TIUVSIT,800)) S X=^(800) D
"RTN","TIUPXAP2",120,0)
 . F I=1:1:6 I $P(X,U,I)'="" S TIUCHKF=1 Q
"RTN","TIUPXAP2",121,0)
 ;
"RTN","TIUPXAP2",122,0)
CHKVSTQ K ^TMP("PXKENC",$J)
"RTN","TIUPXAP2",123,0)
 Q +$G(TIUCHKF)
"RTN","TIUPXAP2",124,0)
 ;
"RTN","TIUPXAP2",125,0)
UPDVST(TIUDA,TIUVSIT,ERROR) ;Update Visit in TIU Document file #8925
"RTN","TIUPXAP2",126,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUPXAP2",127,0)
 ;           TIUVSIT  Visit file (#9000010) IEN
"RTN","TIUPXAP2",128,0)
 ; Output -- 1=Successful and 0=Failure
"RTN","TIUPXAP2",129,0)
 ;           ERROR    Error Message  (Optional)
"RTN","TIUPXAP2",130,0)
 N DIERR,OKF,TIUFDA
"RTN","TIUPXAP2",131,0)
 ;
"RTN","TIUPXAP2",132,0)
 ;Quit if a visit is not defined
"RTN","TIUPXAP2",133,0)
 G UPDVSTQ:$G(TIUVSIT)'>0
"RTN","TIUPXAP2",134,0)
 ;
"RTN","TIUPXAP2",135,0)
 ;Update document with visit
"RTN","TIUPXAP2",136,0)
 S TIUFDA(8925,TIUDA_",",.03)=TIUVSIT
"RTN","TIUPXAP2",137,0)
 L +^TIU(8925,TIUDA):1 I $T D
"RTN","TIUPXAP2",138,0)
 . D FILE^DIE("","TIUFDA","") L -^TIU(8925,TIUDA)
"RTN","TIUPXAP2",139,0)
 . S ERROR=$G(DIERR)
"RTN","TIUPXAP2",140,0)
 . S OKF=$S(+$G(ERROR):0,1:1)
"RTN","TIUPXAP2",141,0)
 ELSE  D
"RTN","TIUPXAP2",142,0)
 . S OKF=0
"RTN","TIUPXAP2",143,0)
UPDVSTQ Q +$G(OKF)
"RTN","TIUPXAP2",144,0)
 ;
"RTN","TIUPXAP2",145,0)
CHKWKL(TIUDA,TIUDPRM) ;Check if workload data should be entered
"RTN","TIUPXAP2",146,0)
 ; Input  -- TIUDA    TIU Document file (#8925) IEN
"RTN","TIUPXAP2",147,0)
 ;           TIUDPRM  TIU Document Parameters file (#8925.95) Array
"RTN","TIUPXAP2",148,0)
 ; Output -- 1=Enter Workload and 0=Do Not Enter Workload
"RTN","TIUPXAP2",149,0)
 N STATUS,TIUAPPTF,TIUD0,TIUDFN,TIUEDT,TIUHL,TIUVSIT,TIUWKLF
"RTN","TIUPXAP2",150,0)
 ;
"RTN","TIUPXAP2",151,0)
 ;Set variables, if the 0th node of the document is not defined quit
"RTN","TIUPXAP2",152,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)) G CHKWKLQ:TIUD0=""
"RTN","TIUPXAP2",153,0)
 S TIUDFN=$P(TIUD0,U,2),TIUVSIT=$P(TIUD0,U,3),TIUEDT=$P(TIUD0,U,7)
"RTN","TIUPXAP2",154,0)
 S TIUHL=$P($G(^TIU(8925,+TIUDA,12)),U,11)
"RTN","TIUPXAP2",155,0)
 ;
"RTN","TIUPXAP2",156,0)
 ;Check if an appointment is associated with the visit
"RTN","TIUPXAP2",157,0)
 S:$$CHKAPPT(TIUVSIT,TIUDFN,TIUEDT,TIUHL)>0 TIUAPPTF=1
"RTN","TIUPXAP2",158,0)
 ;
"RTN","TIUPXAP2",159,0)
 ;If an appointment is not associated with the visit, assume
"RTN","TIUPXAP2",160,0)
 ;the visit is new, set flag to enter workload and quit
"RTN","TIUPXAP2",161,0)
 I '$G(TIUAPPTF) S TIUWKLF=1 G CHKWKLQ
"RTN","TIUPXAP2",162,0)
 ;
"RTN","TIUPXAP2",163,0)
 ;Check the parameter 'Ask Dx/CPT on All Opt Visits'.  If it is set to
"RTN","TIUPXAP2",164,0)
 ;No, workload should not be entered for the appointment.
"RTN","TIUPXAP2",165,0)
 I '$P($G(TIUDPRM(0)),U,16) G CHKWKLQ
"RTN","TIUPXAP2",166,0)
 ;
"RTN","TIUPXAP2",167,0)
 ;Get the status of the appointment
"RTN","TIUPXAP2",168,0)
 S STATUS=+$$STATUS^SDAM1(TIUDFN,TIUEDT,TIUHL,$G(^DPT(TIUDFN,"S",TIUEDT,0)))
"RTN","TIUPXAP2",169,0)
 ;
"RTN","TIUPXAP2",170,0)
 ;Check the status of the appointment.  If the appointment can be
"RTN","TIUPXAP2",171,0)
 ;checked-out, workload can be entered.
"RTN","TIUPXAP2",172,0)
 I $D(^SD(409.63,"ACO",1,STATUS)) S TIUWKLF=1
"RTN","TIUPXAP2",173,0)
 ;
"RTN","TIUPXAP2",174,0)
CHKWKLQ Q +$G(TIUWKLF)
"RTN","TIUPXAP2",175,0)
 ;
"RTN","TIUPXAP2",176,0)
CHKAPPT(TIUVSIT,TIUDFN,TIUEDT,TIUHL) ;Check if an appointment is associated with the Visit
"RTN","TIUPXAP2",177,0)
 ; Input  -- TIUVSIT  Visit file (#9000010) IEN
"RTN","TIUPXAP2",178,0)
 ;           TIUDFN   Patient file (#2) IEN
"RTN","TIUPXAP2",179,0)
 ;           TIUEDT   Episode Begin Date/Time
"RTN","TIUPXAP2",180,0)
 ;           TIUHL    Hospital Location file (#44) IEN
"RTN","TIUPXAP2",181,0)
 ; Output -- 0=Appointment is not associated with the Visit
"RTN","TIUPXAP2",182,0)
 ;           1=Appointment is associated with the Visit
"RTN","TIUPXAP2",183,0)
 N TIUAPPTF
"RTN","TIUPXAP2",184,0)
 I $G(TIUVSIT) D
"RTN","TIUPXAP2",185,0)
 . S:$$VST2APPT^PXAPI(TIUVSIT)>0 TIUAPPTF=1
"RTN","TIUPXAP2",186,0)
 ELSE  D
"RTN","TIUPXAP2",187,0)
 . S:$$APPOINT^PXUTL1(TIUDFN,TIUEDT,TIUHL)>0 TIUAPPTF=1
"RTN","TIUPXAP2",188,0)
 Q +$G(TIUAPPTF)
"VER")
8.0^22.0
**END**
**END**
