Released MPIF*1*18 SEQ #16
Extracted from mail message
**KIDS**:MPIF*1.0*18^

**INSTALL NAME**
MPIF*1.0*18
"BLD",2032,0)
MPIF*1.0*18^MASTER PATIENT INDEX VISTA^0^3010814^y
"BLD",2032,4,0)
^9.64PA^^
"BLD",2032,"ABNS",0)
^9.66A^^
"BLD",2032,"ABPKG")
n^n^
"BLD",2032,"KRN",0)
^9.67PA^19^17
"BLD",2032,"KRN",.4,0)
.4
"BLD",2032,"KRN",.401,0)
.401
"BLD",2032,"KRN",.402,0)
.402
"BLD",2032,"KRN",.403,0)
.403
"BLD",2032,"KRN",.5,0)
.5
"BLD",2032,"KRN",.84,0)
.84
"BLD",2032,"KRN",3.6,0)
3.6
"BLD",2032,"KRN",3.8,0)
3.8
"BLD",2032,"KRN",9.2,0)
9.2
"BLD",2032,"KRN",9.8,0)
9.8
"BLD",2032,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",2032,"KRN",9.8,"NM",1,0)
MPIF001^^0^B48799914
"BLD",2032,"KRN",9.8,"NM","B","MPIF001",1)

"BLD",2032,"KRN",19,0)
19
"BLD",2032,"KRN",19.1,0)
19.1
"BLD",2032,"KRN",101,0)
101
"BLD",2032,"KRN",409.61,0)
409.61
"BLD",2032,"KRN",771,0)
771
"BLD",2032,"KRN",870,0)
870
"BLD",2032,"KRN",8994,0)
8994
"BLD",2032,"KRN","B",.4,.4)

"BLD",2032,"KRN","B",.401,.401)

"BLD",2032,"KRN","B",.402,.402)

"BLD",2032,"KRN","B",.403,.403)

"BLD",2032,"KRN","B",.5,.5)

"BLD",2032,"KRN","B",.84,.84)

"BLD",2032,"KRN","B",3.6,3.6)

"BLD",2032,"KRN","B",3.8,3.8)

"BLD",2032,"KRN","B",9.2,9.2)

"BLD",2032,"KRN","B",9.8,9.8)

"BLD",2032,"KRN","B",19,19)

"BLD",2032,"KRN","B",19.1,19.1)

"BLD",2032,"KRN","B",101,101)

"BLD",2032,"KRN","B",409.61,409.61)

"BLD",2032,"KRN","B",771,771)

"BLD",2032,"KRN","B",870,870)

"BLD",2032,"KRN","B",8994,8994)

"BLD",2032,"QUES",0)
^9.62^^
"BLD",2032,"REQB",0)
^9.611^4^4
"BLD",2032,"REQB",1,0)
MPIF*1.0*1^1
"BLD",2032,"REQB",2,0)
MPIF*1.0*3^1
"BLD",2032,"REQB",3,0)
MPIF*1.0*9^1
"BLD",2032,"REQB",4,0)
MPIF*1.0*16^1
"BLD",2032,"REQB","B","MPIF*1.0*1",1)

"BLD",2032,"REQB","B","MPIF*1.0*16",4)

"BLD",2032,"REQB","B","MPIF*1.0*3",2)

"BLD",2032,"REQB","B","MPIF*1.0*9",3)

"MBREQ")
0
"PKG",474,-1)
1^1
"PKG",474,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",474,20,0)
^9.402P^^
"PKG",474,22,0)
^9.49I^1^1
"PKG",474,22,1,0)
1.0^2990428^2990603^9139
"PKG",474,22,1,"PAH",1,0)
18^3010814
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
1
"RTN","MPIF001")
0^1^B48799914
"RTN","MPIF001",1,0)
MPIF001 ;ALB/RJS/CMC-UTILITY ROUTINE OF APIS ;JUL 12, 1996
"RTN","MPIF001",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,9,16,18**;30 Apr 99
"RTN","MPIF001",3,0)
GETICN(DFN) ;
"RTN","MPIF001",4,0)
 ; This function returns the ICN, including checksum for a given DFN
"RTN","MPIF001",5,0)
 ; or -1^error message
"RTN","MPIF001",6,0)
 ; DFN - ien in Patient file
"RTN","MPIF001",7,0)
 ;
"RTN","MPIF001",8,0)
 N RETURN,NODE
"RTN","MPIF001",9,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT1
"RTN","MPIF001",10,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT1
"RTN","MPIF001",11,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT1
"RTN","MPIF001",12,0)
 S NODE=^DPT(DFN,"MPI")
"RTN","MPIF001",13,0)
 I $P(NODE,"^",1)'>0 S RETURN="-1^NO ICN" G EXIT1
"RTN","MPIF001",14,0)
 S RETURN=$P(NODE,"^",1)_"V"_$P(NODE,"^",2)
"RTN","MPIF001",15,0)
EXIT1 ;
"RTN","MPIF001",16,0)
 Q RETURN
"RTN","MPIF001",17,0)
 ;
"RTN","MPIF001",18,0)
GETDFN(ICN) ;
"RTN","MPIF001",19,0)
 ; Returns DFN (ien Patient file) or -1^error message for a given ICN
"RTN","MPIF001",20,0)
 ; ICN - ICN for a given Patient in the Patient file
"RTN","MPIF001",21,0)
 N RETURN,DFN
"RTN","MPIF001",22,0)
 I $G(ICN)'>0 S RETURN="-1^NO ICN" G EXIT2
"RTN","MPIF001",23,0)
 I '$D(^DPT("AICN",ICN)) S RETURN="-1^ICN NOT IN DATABASE" G EXIT2
"RTN","MPIF001",24,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIF001",25,0)
 I $G(DFN)'>0 S RETURN="-1^BAD ICN CROSS-REFERENCE" G EXIT2
"RTN","MPIF001",26,0)
 S RETURN=DFN
"RTN","MPIF001",27,0)
EXIT2 ;
"RTN","MPIF001",28,0)
 Q RETURN
"RTN","MPIF001",29,0)
 ;
"RTN","MPIF001",30,0)
ICNLC(DFN) ;This API will return an ICN if one exists or create and return
"RTN","MPIF001",31,0)
 ; a Local ICN and update the appropriate fields if a Local was created
"RTN","MPIF001",32,0)
 ; DFN= Patient IEN
"RTN","MPIF001",33,0)
 ; Returns ICN (local or National including checksum)
"RTN","MPIF001",34,0)
 ; can also return -1^Problem creating Local ICN or -1^ZZd or 5 leading 0s
"RTN","MPIF001",35,0)
 N ICN,TMP,CHKSUM,ICNX
"RTN","MPIF001",36,0)
 I $G(DFN)'>0 Q "-1^No DFN Passed"
"RTN","MPIF001",37,0)
 D LOCK
"RTN","MPIF001",38,0)
 S ICN=$$GETICN(DFN)
"RTN","MPIF001",39,0)
 I +ICN=-1&(+$$SEND2^VAFCUTL1(DFN,"T")=0) D
"RTN","MPIF001",40,0)
 .;no icn create a Local ICN
"RTN","MPIF001",41,0)
 .; don't create Local if ZZ'd or 5 leading 0s
"RTN","MPIF001",42,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIF001",43,0)
 .S CHKSUM=$P(ICN,"V",2),ICNX=$P(ICN,"V")
"RTN","MPIF001",44,0)
 .S NOLOCK=""
"RTN","MPIF001",45,0)
 .I ICNX="" K NOLOCK S ICN="-1^PROBLEM CREATING LOCAL ICN" Q
"RTN","MPIF001",46,0)
 .S TMP=$$SETICN(DFN,ICNX,CHKSUM)
"RTN","MPIF001",47,0)
 .S TMP=$$SETLOC(DFN,1)
"RTN","MPIF001",48,0)
 .S TMP=$$CHANGE(DFN,$P($$SITE^VASITE(),"^"))
"RTN","MPIF001",49,0)
 .K NOLOCK
"RTN","MPIF001",50,0)
 D UNLOCK
"RTN","MPIF001",51,0)
 I +ICN=-1 S ICN="-1^ZZd or 5 leading 0s"
"RTN","MPIF001",52,0)
 Q ICN
"RTN","MPIF001",53,0)
 ;
"RTN","MPIF001",54,0)
CMOR2(DFN) ;
"RTN","MPIF001",55,0)
 ; Returns CMOR Site Name or -1^error message
"RTN","MPIF001",56,0)
 ; DFN = Patient IEN
"RTN","MPIF001",57,0)
 I $G(DFN)'>0 Q "-1^No DFN Passed"
"RTN","MPIF001",58,0)
 N NODE
"RTN","MPIF001",59,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",60,0)
 Q:$P(NODE,"^",3)="" "-1^No CMOR"
"RTN","MPIF001",61,0)
 Q $$CMORNAME($P(NODE,"^",3))
"RTN","MPIF001",62,0)
 ;
"RTN","MPIF001",63,0)
CMORNAME(CIEN) ;
"RTN","MPIF001",64,0)
 ; Returns CMOR site name or -1^error message
"RTN","MPIF001",65,0)
 ; CIEN - ien from Institution file
"RTN","MPIF001",66,0)
 ;
"RTN","MPIF001",67,0)
 Q:CIEN="" "-1^No Institution parameter"
"RTN","MPIF001",68,0)
 N INST
"RTN","MPIF001",69,0)
 S INST=$$NNT^XUAF4(CIEN)
"RTN","MPIF001",70,0)
 Q:INST="" "-1^No Institution for that IEN"
"RTN","MPIF001",71,0)
 Q:$P(INST,"^")="" "-1^No Name for this Institution"
"RTN","MPIF001",72,0)
 Q $P(INST,"^")
"RTN","MPIF001",73,0)
 ;
"RTN","MPIF001",74,0)
GETVCCI(DFN) ;
"RTN","MPIF001",75,0)
 ; Returns CMOR or -1^error message for a given patient
"RTN","MPIF001",76,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",77,0)
 N RETURN,NODE,PTR,STANUM
"RTN","MPIF001",78,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT3
"RTN","MPIF001",79,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT3
"RTN","MPIF001",80,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT3
"RTN","MPIF001",81,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",82,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",83,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT3
"RTN","MPIF001",84,0)
 S STANUM=$P($$NNT^XUAF4(PTR),"^",2)
"RTN","MPIF001",85,0)
 I STANUM'>0 S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT3
"RTN","MPIF001",86,0)
 S RETURN=STANUM
"RTN","MPIF001",87,0)
EXIT3 ;
"RTN","MPIF001",88,0)
 Q RETURN
"RTN","MPIF001",89,0)
 ;
"RTN","MPIF001",90,0)
CHANGE(DFN,VCCI) ;
"RTN","MPIF001",91,0)
 ; ** This function is only to be used by approved packages **
"RTN","MPIF001",92,0)
 ;
"RTN","MPIF001",93,0)
 ; This function updates the CMOR field in the Patient file
"RTN","MPIF001",94,0)
 ; DFN = ien in Patient file
"RTN","MPIF001",95,0)
 ; VCCI = CMOR ien from the institution file
"RTN","MPIF001",96,0)
 ; returned:  -1^error message - problem
"RTN","MPIF001",97,0)
 ;             1 - successful
"RTN","MPIF001",98,0)
 ; Exception will be generated if Update to File Fails only
"RTN","MPIF001",99,0)
 N RETURN,DIQUIET,DIE,DA,DR,Y,X,DIC
"RTN","MPIF001",100,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",101,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT4
"RTN","MPIF001",102,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT4
"RTN","MPIF001",103,0)
 I $G(VCCI)="" S RETURN="-1^NO CMOR PASSED" G EXIT4
"RTN","MPIF001",104,0)
 I $E($$GETICN(DFN),1,3)=$P($$SITE^VASITE(),"^",3) S VCCI=$P($$SITE^VASITE(),"^")
"RTN","MPIF001",105,0)
 ; ^ to be sure site is self for a local icn
"RTN","MPIF001",106,0)
 S VCCI="`"_VCCI
"RTN","MPIF001",107,0)
 ; ^ Have ien stuff added to use ien instead of station number
"RTN","MPIF001",108,0)
 N CNT,TIEN S DIQUIET=1,CNT=0
"RTN","MPIF001",109,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",110,0)
REP S DIE="^DPT(",DA=DFN,DR="991.03///^S X=VCCI"
"RTN","MPIF001",111,0)
 D ^DIE
"RTN","MPIF001",112,0)
 S CNT=CNT+1
"RTN","MPIF001",113,0)
 S TIEN=$P($$MPINODE^MPIFAPI(DFN),"^",3)
"RTN","MPIF001",114,0)
 I "`"_TIEN'=VCCI&(CNT<4) G REP
"RTN","MPIF001",115,0)
 I "`"_TIEN'=VCCI&(CNT>3) D
"RTN","MPIF001",116,0)
 .S RETURN="-1^Couldn't Update CMOR"
"RTN","MPIF001",117,0)
 .D START^RGHLLOG(0)
"RTN","MPIF001",118,0)
 .D EXC^RGHLLOG(221,"Unable to update CMOR to "_$P(^DIC(4,TIEN,0),"^")_" for patient DFN= "_DFN,DFN)
"RTN","MPIF001",119,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIF001",120,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",121,0)
EXIT4 ;
"RTN","MPIF001",122,0)
 Q RETURN
"RTN","MPIF001",123,0)
 ;
"RTN","MPIF001",124,0)
SETICN(DFN,ICN,CHKSUM) ;
"RTN","MPIF001",125,0)
 ; ** this function is to only be used by approved packages **
"RTN","MPIF001",126,0)
 ;
"RTN","MPIF001",127,0)
 ; This function updates the ICN and ICN Checksum fields in the Patient 
"RTN","MPIF001",128,0)
 ; file for a given patient.
"RTN","MPIF001",129,0)
 ; DFN - ien in the Patient file to be updated
"RTN","MPIF001",130,0)
 ; ICN - ICN (without checksum) to be updated
"RTN","MPIF001",131,0)
 ; CHKSUM - ICN checksum
"RTN","MPIF001",132,0)
 ; return:  -1^error message - problem
"RTN","MPIF001",133,0)
 ;          1 - successful
"RTN","MPIF001",134,0)
 N RETURN,DIQUIET,DIE,DA,DR,RGRSICN,Y,ERR
"RTN","MPIF001",135,0)
 S (RETURN,DIQUIET,RGRSICN)=1
"RTN","MPIF001",136,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT5
"RTN","MPIF001",137,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT5
"RTN","MPIF001",138,0)
 I $G(ICN)="" S RETURN="-1^NO ICN PASSED" G EXIT5
"RTN","MPIF001",139,0)
 I $G(CHKSUM)="" S RETURN="-1^NO CHKSUM PASSED" G EXIT5
"RTN","MPIF001",140,0)
 I +$$GETICN(DFN)>0 I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3),$E($$GETICN(DFN),1,3)'=$E(ICN,1,3) G EXIT5
"RTN","MPIF001",141,0)
 ; ^ stop local from overwriting a national ICN
"RTN","MPIF001",142,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S RETURN="-1^ZZ'd or 5 leading 0s" G EXIT5
"RTN","MPIF001",143,0)
 I $D(^DPT("AICN",ICN)) D
"RTN","MPIF001",144,0)
 .Q:DFN=$O(^DPT("AICN",ICN,""))
"RTN","MPIF001",145,0)
 .N RGLOG D START^RGHLLOG(0)
"RTN","MPIF001",146,0)
 .I DFN'=($O(^DPT("AICN",ICN,""))) D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_ICN_" that is already in use for Patient dfn "_$O(^DPT("AICN",ICN,""))_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIF001",147,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIF001",148,0)
 .S RETURN="-1^ICN ALREADY IN USE"
"RTN","MPIF001",149,0)
 G:+RETURN=-1 EXIT5
"RTN","MPIF001",150,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",151,0)
 S DIQUIET=1
"RTN","MPIF001",152,0)
 S DIE="^DPT(",DA=DFN,DR="991.01///^S X=ICN;991.02///^S X=CHKSUM"
"RTN","MPIF001",153,0)
 D ^DIE
"RTN","MPIF001",154,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",155,0)
 I +RETURN>0 D
"RTN","MPIF001",156,0)
 .K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",157,0)
 .I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,1)
"RTN","MPIF001",158,0)
 .I $E(ICN,1,3)'=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,0)
"RTN","MPIF001",159,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",160,0)
EXIT5 ;
"RTN","MPIF001",161,0)
 Q RETURN
"RTN","MPIF001",162,0)
 ;
"RTN","MPIF001",163,0)
SETLOC(DFN,DELFLAG) ;
"RTN","MPIF001",164,0)
 ; ** This function should be only used by approved packages **
"RTN","MPIF001",165,0)
 ;
"RTN","MPIF001",166,0)
 ; This function updates the LOCALLY ASSIGNED ICN field in the Patient
"RTN","MPIF001",167,0)
 ; for the given patient
"RTN","MPIF001",168,0)
 ;DFN - ien from Patient file of patient to be updated
"RTN","MPIF001",169,0)
 ;DELFLAG - 1 is to turn the flag on
"RTN","MPIF001",170,0)
 ;        - 0 is to turn off the flag
"RTN","MPIF001",171,0)
 ;
"RTN","MPIF001",172,0)
 N RETURN,DIQUIET,DIE,DA,DR,VALUE,Y
"RTN","MPIF001",173,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",174,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT6
"RTN","MPIF001",175,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT6
"RTN","MPIF001",176,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",177,0)
 S DIQUIET=1,VALUE=$S($G(DELFLAG)=0:"@",1:1)
"RTN","MPIF001",178,0)
 S DIE="^DPT(",DA=DFN,DR="991.04///^S X=VALUE"
"RTN","MPIF001",179,0)
 D ^DIE
"RTN","MPIF001",180,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",181,0)
 I +RETURN>0 K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",182,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",183,0)
EXIT6 ;
"RTN","MPIF001",184,0)
 Q RETURN
"RTN","MPIF001",185,0)
 ;
"RTN","MPIF001",186,0)
IFLOCAL(DFN) ;
"RTN","MPIF001",187,0)
 ; This function is used to see if a patient has a local ICN
"RTN","MPIF001",188,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",189,0)
 ; returned:  0 = patient does not exist, dfn is not defined or no MPI node OR Patient does not have a local ICN
"RTN","MPIF001",190,0)
 ;            1 = patient has a Local ICN assigned
"RTN","MPIF001",191,0)
 Q:$G(DFN)="" 0
"RTN","MPIF001",192,0)
 Q:$G(^DPT(DFN,0))="" 0
"RTN","MPIF001",193,0)
 Q:'$D(^DPT(DFN,"MPI")) 0
"RTN","MPIF001",194,0)
 Q:$E($$GETICN(DFN),1,3)=$P($$SITE^VASITE,"^",3) 1
"RTN","MPIF001",195,0)
 Q 0
"RTN","MPIF001",196,0)
 ;
"RTN","MPIF001",197,0)
IFVCCI(DFN) ;
"RTN","MPIF001",198,0)
 ; this function returns 1 if your facility is the CMOR for the given pt
"RTN","MPIF001",199,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",200,0)
 ; returns: 1 = your site in the CMOR for this patient
"RTN","MPIF001",201,0)
 ;          -1 = your site is not the CMOR for this patient
"RTN","MPIF001",202,0)
 ;          0^ERROR MSG
"RTN","MPIF001",203,0)
 N VCCI,SITE
"RTN","MPIF001",204,0)
 I $G(DFN)'>0 Q "0^No DFN Passed"
"RTN","MPIF001",205,0)
 S VCCI=$P($$GETVCCI(DFN),"^",1)
"RTN","MPIF001",206,0)
 S SITE=$P($$SITE^VASITE,"^",3)\1
"RTN","MPIF001",207,0)
 I $P(VCCI,"^",1)=-1 Q -1
"RTN","MPIF001",208,0)
 I VCCI'=SITE Q -1
"RTN","MPIF001",209,0)
 Q 1
"RTN","MPIF001",210,0)
 ;
"RTN","MPIF001",211,0)
HL7CMOR(DFN,SEP) ;
"RTN","MPIF001",212,0)
 ; This function returns the CMOR station number and institution name for
"RTN","MPIF001",213,0)
 ; the given patient.
"RTN","MPIF001",214,0)
 ; DFN = ien for patient in Patient file
"RTN","MPIF001",215,0)
 ; SEP = delimiter to separate station number and name
"RTN","MPIF001",216,0)
 ; returned:  Station Number <sep> Institution name
"RTN","MPIF001",217,0)
 ;            -1^error message
"RTN","MPIF001",218,0)
 N RETURN,NODE,PTR,STAT
"RTN","MPIF001",219,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT7
"RTN","MPIF001",220,0)
 I $G(SEP)="" S RETURN="-1^NO FIELD SEPERATOR" G EXIT7
"RTN","MPIF001",221,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT7
"RTN","MPIF001",222,0)
 I $$MPINODE^MPIFAPI(DFN)<1 S RETURN="-1^NO MPI NODE" G EXIT7
"RTN","MPIF001",223,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",224,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",225,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT7
"RTN","MPIF001",226,0)
 S STAT=$$NNT^XUAF4(PTR)
"RTN","MPIF001",227,0)
 I STAT="" S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT7
"RTN","MPIF001",228,0)
 I $P(STAT,"^")="" S RETURN="-1^NO INSTITUTION NAME" G EXIT7
"RTN","MPIF001",229,0)
 S RETURN=$P(STAT,"^",2)_SEP_$P(STAT,"^")
"RTN","MPIF001",230,0)
EXIT7 ;
"RTN","MPIF001",231,0)
 Q RETURN
"RTN","MPIF001",232,0)
 ;
"RTN","MPIF001",233,0)
LOCK ;
"RTN","MPIF001",234,0)
 F  L +^DPT(DFN,"MPI"):10 Q:$T
"RTN","MPIF001",235,0)
 Q
"RTN","MPIF001",236,0)
 ;
"RTN","MPIF001",237,0)
UNLOCK ;
"RTN","MPIF001",238,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",239,0)
 Q
"VER")
8.0^22.0
**END**
**END**
