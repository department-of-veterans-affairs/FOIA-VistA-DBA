EMERGENCY Released PRCA*4.5*206 SEQ #186
Extracted from mail message
**KIDS**:PRCA*4.5*206^

**INSTALL NAME**
PRCA*4.5*206
"BLD",5127,0)
PRCA*4.5*206^ACCOUNTS RECEIVABLE^0^3040519^y
"BLD",5127,1,0)
^^4^4^3040512^^
"BLD",5127,1,1,0)
This patch modifies Patient Statements that are transmitted from the
"BLD",5127,1,2,0)
sites to the Austin Automation Center (AAC).  The account number on
"BLD",5127,1,3,0)
these statements currently contains the patient's SSN.  The patch
"BLD",5127,1,4,0)
replaces the SSN portion of the account number with the patient's DNF.
"BLD",5127,4,0)
^9.64PA^^
"BLD",5127,"KRN",0)
^9.67PA^8989.52^19
"BLD",5127,"KRN",.4,0)
.4
"BLD",5127,"KRN",.401,0)
.401
"BLD",5127,"KRN",.402,0)
.402
"BLD",5127,"KRN",.403,0)
.403
"BLD",5127,"KRN",.5,0)
.5
"BLD",5127,"KRN",.84,0)
.84
"BLD",5127,"KRN",3.6,0)
3.6
"BLD",5127,"KRN",3.8,0)
3.8
"BLD",5127,"KRN",9.2,0)
9.2
"BLD",5127,"KRN",9.8,0)
9.8
"BLD",5127,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",5127,"KRN",9.8,"NM",1,0)
RCCPCML^^0^B41728934
"BLD",5127,"KRN",9.8,"NM",2,0)
RCDPXPAP^^0^B46255466
"BLD",5127,"KRN",9.8,"NM",3,0)
PRCAAPR1^^0^B28556509
"BLD",5127,"KRN",9.8,"NM","B","PRCAAPR1",3)

"BLD",5127,"KRN",9.8,"NM","B","RCCPCML",1)

"BLD",5127,"KRN",9.8,"NM","B","RCDPXPAP",2)

"BLD",5127,"KRN",19,0)
19
"BLD",5127,"KRN",19,"NM",0)
^9.68A^^
"BLD",5127,"KRN",19.1,0)
19.1
"BLD",5127,"KRN",101,0)
101
"BLD",5127,"KRN",409.61,0)
409.61
"BLD",5127,"KRN",771,0)
771
"BLD",5127,"KRN",870,0)
870
"BLD",5127,"KRN",8989.51,0)
8989.51
"BLD",5127,"KRN",8989.52,0)
8989.52
"BLD",5127,"KRN",8994,0)
8994
"BLD",5127,"KRN","B",.4,.4)

"BLD",5127,"KRN","B",.401,.401)

"BLD",5127,"KRN","B",.402,.402)

"BLD",5127,"KRN","B",.403,.403)

"BLD",5127,"KRN","B",.5,.5)

"BLD",5127,"KRN","B",.84,.84)

"BLD",5127,"KRN","B",3.6,3.6)

"BLD",5127,"KRN","B",3.8,3.8)

"BLD",5127,"KRN","B",9.2,9.2)

"BLD",5127,"KRN","B",9.8,9.8)

"BLD",5127,"KRN","B",19,19)

"BLD",5127,"KRN","B",19.1,19.1)

"BLD",5127,"KRN","B",101,101)

"BLD",5127,"KRN","B",409.61,409.61)

"BLD",5127,"KRN","B",771,771)

"BLD",5127,"KRN","B",870,870)

"BLD",5127,"KRN","B",8989.51,8989.51)

"BLD",5127,"KRN","B",8989.52,8989.52)

"BLD",5127,"KRN","B",8994,8994)

"BLD",5127,"QUES",0)
^9.62^^
"BLD",5127,"REQB",0)
^9.611^3^3
"BLD",5127,"REQB",1,0)
PRCA*4.5*150^1
"BLD",5127,"REQB",2,0)
PRCA*4.5*195^1
"BLD",5127,"REQB",3,0)
PRCA*4.5*143^1
"BLD",5127,"REQB","B","PRCA*4.5*143",3)

"BLD",5127,"REQB","B","PRCA*4.5*150",1)

"BLD",5127,"REQB","B","PRCA*4.5*195",2)

"MBREQ")
0
"PKG",142,-1)
1^1
"PKG",142,0)
ACCOUNTS RECEIVABLE^PRCA^BILL COLLECTIONS
"PKG",142,20,0)
^9.402P^1^1
"PKG",142,20,1,0)
2^^PRCAMRG
"PKG",142,20,1,1)

"PKG",142,20,"B",2,1)

"PKG",142,22,0)
^9.49I^1^1
"PKG",142,22,1,0)
4.5^^2950320
"PKG",142,22,1,"PAH",1,0)
206^3040519
"PKG",142,22,1,"PAH",1,1,0)
^^4^4^3040519
"PKG",142,22,1,"PAH",1,1,1,0)
This patch modifies Patient Statements that are transmitted from the
"PKG",142,22,1,"PAH",1,1,2,0)
sites to the Austin Automation Center (AAC).  The account number on
"PKG",142,22,1,"PAH",1,1,3,0)
these statements currently contains the patient's SSN.  The patch
"PKG",142,22,1,"PAH",1,1,4,0)
replaces the SSN portion of the account number with the patient's DNF.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PRCAAPR1")
0^3^B28556509
"RTN","PRCAAPR1",1,0)
PRCAAPR1 ;WASH-ISC@ALTOONA,PA/RGY-PATIENT ACCOUNT PROFILE ;2/12/97  11:48 AM
"RTN","PRCAAPR1",2,0)
V ;;4.5;Accounts Receivable;**34,45,108,143,141,206**;Mar 20, 1995
"RTN","PRCAAPR1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCAAPR1",4,0)
HDR ;Head for Account profile
"RTN","PRCAAPR1",5,0)
 S X="",$P(X,"=",23)="" W @IOF,!,X,"   A c c o u n t   P r o f i l e   ",X
"RTN","PRCAAPR1",6,0)
HDR1 N DMC,IBRX,RSN,TOP4,TOP6,DPTFLG,ACCTNUM
"RTN","PRCAAPR1",7,0)
 S IBRX=0,DPTFLG=0
"RTN","PRCAAPR1",8,0)
 ;
"RTN","PRCAAPR1",9,0)
 ;Display new 'Statement Account Number" (Patch 206)
"RTN","PRCAAPR1",10,0)
 I PRCADB["DPT(" S DPTFLG=1,ACCTNUM=$$ACCT(PRCADB)
"RTN","PRCAAPR1",11,0)
 ;
"RTN","PRCAAPR1",12,0)
 W !,$P(DEBT,"^",2) I DPTFLG!(PRCADB["VA(200,") S X=$S(PRCADB["DPT(":$P(^DPT(+PRCADB,0),"^",9),1:$P($G(^VA(200,+PRCADB,1)),"^",9)) W " (",$E(X,1,3),"-",$E(X,4,5),"-",$E(X,6,9),")"
"RTN","PRCAAPR1",13,0)
 W ?53,"Statement Day: ",$S($$PST^RCAMFN01(+DEBT)>0:$$PST^RCAMFN01(+DEBT),1:"N/A")
"RTN","PRCAAPR1",14,0)
 K Y S X("ADD")=$$DADD^RCAMADD(PRCADB)
"RTN","PRCAAPR1",15,0)
 ;
"RTN","PRCAAPR1",16,0)
 ;Display new 'Statement Account Number" (Patch 206)
"RTN","PRCAAPR1",17,0)
 I DPTFLG W !,"Statement Account #: ",ACCTNUM,?52,"Last Statement: "
"RTN","PRCAAPR1",18,0)
 E  W !?52,"Last Statement: "
"RTN","PRCAAPR1",19,0)
 ;
"RTN","PRCAAPR1",20,0)
 S Y=+$$LST^RCFN01(PRCADB,2)
"RTN","PRCAAPR1",21,0)
 I Y>0 S Y("CCPC")=$$FPS^RCCPCFN(+DEBT) S:Y("CCPC") Y=+$P(Y("CCPC"),"^")
"RTN","PRCAAPR1",22,0)
 W $S(Y=-1:"N/A",1:$$SLH^RCFN01(Y))
"RTN","PRCAAPR1",23,0)
 W !,$P(X("ADD"),"^")
"RTN","PRCAAPR1",24,0)
 W:+$G(Y("CCPC")) ?52,"Activity as of: ",$$SLH^RCFN01($$ASOF^RCCPCFN($P(Y("CCPC"),"^",2)))
"RTN","PRCAAPR1",25,0)
 W:$P(X("ADD"),"^",2)]"" !,$P(X("ADD"),"^",2) W:$P(X("ADD"),"^",3)]"" !,$P(X("ADD"),"^",3)
"RTN","PRCAAPR1",26,0)
 W ! W:$P(X("ADD"),"^",4)]"" $P(X("ADD"),"^",4),", ",$P(X("ADD"),"^",5),"  ",$S($P(X("ADD"),"^",6):$P(X("ADD"),"^",6),1:$P(X("ADD"),"^",8))
"RTN","PRCAAPR1",27,0)
 W ?55,"Amount Owed: ",?69,$J(+$G(^TMP("PRCAAPR",$J,"C")),9,2)
"RTN","PRCAAPR1",28,0)
 W !,"Phone #: ",$S($P(X("ADD"),"^",7)]"":$P(X("ADD"),"^",7),1:"N/A")
"RTN","PRCAAPR1",29,0)
 I PRCADB["DPT(" W ?51,"RX Copay Exempt: " S IBRX=$$RXST^IBARXEU(+PRCADB,DT) W $S($P(IBRX,U)=1:"YES",$P(IBRX,U)=0:"NO",1:"N/A")
"RTN","PRCAAPR1",30,0)
 ; *108 add exemption reason/dmc info
"RTN","PRCAAPR1",31,0)
 I IBRX>0,($P(IBRX,U)=1) S DIC="^IBE(354.2,",DIC(0)="M",X=+$P(IBRX,"^",3) D ^DIC I Y>0 W !,?54,"(",$P(Y,"^",2),")"
"RTN","PRCAAPR1",32,0)
 I $D(^RCD(340,"DMC",1,+DEBT)) S DMC=$G(^RCD(340,+DEBT,3)) D
"RTN","PRCAAPR1",33,0)
 .I $P(DMC,"^",2) W !,"** Account forwarded to DMC: ",$$SLH^RCFN01($P(DMC,"^",2)),?50,"Total DMC Amount: ",?69,$J($P(DMC,"^",5),9,2)
"RTN","PRCAAPR1",34,0)
 .I $P(DMC,"^",9)'="" W !,?49,"Lesser Amt to DMC: ",?69,$J($P(DMC,"^",9),9,2)
"RTN","PRCAAPR1",35,0)
 .Q
"RTN","PRCAAPR1",36,0)
 I $D(^RCD(340,"TOP",+DEBT)) S TOP4=$G(^RCD(340,+DEBT,4)),TOP6=$G(^(6)) D
"RTN","PRCAAPR1",37,0)
 .I +TOP6 W !,"** Account forwarded to TOP: ",$$SLH^RCFN01($P(TOP6,"^")),?45,"Total TOP Amount: ",?65,$J($P(TOP4,"^",3),13,2)
"RTN","PRCAAPR1",38,0)
 .I $P(TOP6,"^",6) W !,?45,"TOP HOLD DATE: ",$$SLH^RCFN01($P(TOP6,"^",6))
"RTN","PRCAAPR1",39,0)
 .Q
"RTN","PRCAAPR1",40,0)
 I $O(^RCD(340,+DEBT,2,0)) D
"RTN","PRCAAPR1",41,0)
 .S Y=0 F X=0:0 S X=$O(^RCD(340,+DEBT,2,X)) Q:'X  W:'Y ! W !,$G(^(X,0)) S Y=Y+1 W:Y=3&$O(^RCD(340,+DEBT,2,X)) "..." Q:Y=3
"RTN","PRCAAPR1",42,0)
 .Q
"RTN","PRCAAPR1",43,0)
 Q
"RTN","PRCAAPR1",44,0)
HDR2 W !!,"#",?4,"Bill #",?16,"Est",?28,"Type",?37,"Paid",?46,"Prin",?55,"Int",?63,"Adm",?72,"Balance"
"RTN","PRCAAPR1",45,0)
 Q
"RTN","PRCAAPR1",46,0)
DIS ;Display bill line items
"RTN","PRCAAPR1",47,0)
 NEW STAT1
"RTN","PRCAAPR1",48,0)
 I '$O(^TMP("PRCAAPR",$J,"C",0)) S X="",$P(X,"*",22)="" W !!,X,"  NO ACCOUNT INFORMATION AVAILABLE  ",X G Q1
"RTN","PRCAAPR1",49,0)
 F STAT1=0:0 S STAT1=$O(^TMP("PRCAAPR",$J,"C",STAT1)) Q:'STAT1!$D(OUT)  D BHDR S BILL=0 F  S BILL=$O(^TMP("PRCAAPR",$J,"C",STAT1,BILL)) Q:BILL=""!$D(OUT)  D BLN
"RTN","PRCAAPR1",50,0)
 I '$D(OUT) D READ
"RTN","PRCAAPR1",51,0)
Q1 Q
"RTN","PRCAAPR1",52,0)
BHDR ;Display status line
"RTN","PRCAAPR1",53,0)
 S X=$S(+$P(^TMP("PRCAAPR",$J,"C",STAT1),"^",2)=99:"PAYMENTS",1:$P($G(^PRCA(430.3,+$O(^PRCA(430.3,"AC",+$P(^TMP("PRCAAPR",$J,"C",STAT1),"^",2),0)),0)),"^"))
"RTN","PRCAAPR1",54,0)
 S Y=" "_X_" ("_$J(+^TMP("PRCAAPR",$J,"C",STAT1),0,2)_") " W ! F X=1:1:80-$L(Y)/2 W "-"
"RTN","PRCAAPR1",55,0)
 W Y F X=1:1:IOM-$X-1 W "-"
"RTN","PRCAAPR1",56,0)
 Q
"RTN","PRCAAPR1",57,0)
BLN ;
"RTN","PRCAAPR1",58,0)
 I $Y+5>IOSL,COUNT D READ G:$D(OUT) Q2 D HDR,HDR2,BHDR
"RTN","PRCAAPR1",59,0)
 S:STAT1'=99 COUNT=COUNT+1,^TMP("PRCAAPR",$J,"O",COUNT)=BILL S X=$S(STAT1=99:BILL,1:$G(^PRCA(430,BILL,0)))
"RTN","PRCAAPR1",60,0)
 W !,$S(STAT1'=99:COUNT,1:"*"),?4,$P(X,"^") W:STAT1'=99 ?16,$$SLH^RCFN01($P(X,"^",10))
"RTN","PRCAAPR1",61,0)
 W:STAT1'=99 ?28,$S($P(X,"^",2)=31:"CHMP PT",1:$E($P($G(^PRCA(430.2,$S($O(^PRCA(430.2,"AC",24,0))=$P(X,"^",2):+$P(X,"^",16),1:+$P(X,"^",2)),0)),"^"),1,7))
"RTN","PRCAAPR1",62,0)
 W:STAT1=99 ?28,"PAYMENT"
"RTN","PRCAAPR1",63,0)
 S X=$S(STAT1=99:"^^^^^^"_^TMP("PRCAAPR",$J,"C",STAT1,BILL),1:$G(^PRCA(430,BILL,7))) W ?37 W:STAT1=99 "-" W $J($P(X,"^",7)+$P(X,"^",8)+$P(X,"^",9)+$P(X,"^",10)+$P(X,"^",11),0,2)
"RTN","PRCAAPR1",64,0)
 W ?45 W:STAT1=99 " " W:STAT1'=99 $S($P(^PRCA(430,BILL,0),"^",2)=$O(^PRCA(430.2,"AC",33,0)):"-",1:" ")
"RTN","PRCAAPR1",65,0)
 W $J($P(X,"^"),0,2),?55,$J($P(X,"^",2),1,2),?63,$J($P(X,"^",3),0,2),?69,$S(STAT1=99:"-",$P(^PRCA(430,BILL,0),"^",2)=$O(^PRCA(430.2,"AC",33,0)):"-",1:" ")
"RTN","PRCAAPR1",66,0)
 W $S(STAT1=99:$J(^TMP("PRCAAPR",$J,"C",STAT1,BILL),0,2),1:$J($P(X,"^")+$P(X,"^",2)+$P(X,"^",3)+$P(X,"^",4)+$P(X,"^",5),9,2))
"RTN","PRCAAPR1",67,0)
 K ^TMP("PRCAAPR",$J,"C",STAT1,BILL) K:$O(^TMP("PRCAAPR",$J,"C",STAT1,""))="" ^TMP("PRCAAPR",$J,"C",STAT1)
"RTN","PRCAAPR1",68,0)
Q2 Q
"RTN","PRCAAPR1",69,0)
READ ;Read bill number
"RTN","PRCAAPR1",70,0)
 W !!,"Select 1-",COUNT W:$O(^TMP("PRCAAPR",$J,"C","")) " or return to continue" R ": ",X:DTIME I X["^"!'$T S:'$T DTOUT=1 S OUT=1 G Q3
"RTN","PRCAAPR1",71,0)
 I X["?" W !!,"To see detailed information for a bill number, enter the corresponding '#'",!,"next to the bill.  (Ex: 1 or 1,3)" G READ
"RTN","PRCAAPR1",72,0)
 I X="",'$O(^TMP("PRCAAPR",$J,"C","")) S OUT=1 G Q3
"RTN","PRCAAPR1",73,0)
 G:X="" Q3 S SEL=X
"RTN","PRCAAPR1",74,0)
 F X=1:1:$L(SEL,",") S Y=$P(SEL,",",X) I Y'?1N.N!'$D(^TMP("PRCAAPR",$J,"O",+Y)) W *7," ??" G READ
"RTN","PRCAAPR1",75,0)
 S OUT=1 F X=1:1:$L(SEL,",") S Y=$P(SEL,",",X) D EN1^PRCAATR($G(^TMP("PRCAAPR",$J,"O",+Y)))
"RTN","PRCAAPR1",76,0)
Q3 Q
"RTN","PRCAAPR1",77,0)
 ;
"RTN","PRCAAPR1",78,0)
ACCT(DFN) ;Get account number. Join station with DFN (Patch 206)
"RTN","PRCAAPR1",79,0)
 N SITE,ACCT,ACCT1,LEN
"RTN","PRCAAPR1",80,0)
 S DFN=+DFN
"RTN","PRCAAPR1",81,0)
 S LEN=$L(DFN)-1
"RTN","PRCAAPR1",82,0)
 S SITE=$$SITE^RCMSITE                          ;station number
"RTN","PRCAAPR1",83,0)
 S ACCT=$$RJ^XLFSTR(DFN,13,0)                   ;add leading zeroes
"RTN","PRCAAPR1",84,0)
 S ACCT1=SITE_"-"_$E(ACCT,1,$L(ACCT)-$L(DFN))   ;add hyphen
"RTN","PRCAAPR1",85,0)
 S ACCT1=ACCT1_"-"_$E(ACCT,$L(ACCT)-LEN,99)     ;add hyphen
"RTN","PRCAAPR1",86,0)
 S ACCT1=ACCT1_"-"_$E($P($P(DEBT,U,2),","),1,5) ;add last name
"RTN","PRCAAPR1",87,0)
 Q ACCT1
"RTN","RCCPCML")
0^1^B41728934
"RTN","RCCPCML",1,0)
RCCPCML ;WASH-ISC@ALTOONA,PA/LDB-Send CCPC transmission ;12/19/96  4:16 PM
"RTN","RCCPCML",2,0)
V ;;4.5;Accounts Receivable;**34,80,93,118,133,140,160,165,187,195,206**;Mar 20, 1995
"RTN","RCCPCML",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","RCCPCML",4,0)
TRAN ;called from RCCPC TRANSMIT option to interactively allow transmission of CCPC mesages
"RTN","RCCPCML",5,0)
 N %DT,DTOUT,SDT,X,Y,ZTRTN,ZTSAVE,ZTDESC,ZTIO
"RTN","RCCPCML",6,0)
 I '$D(^XUSEC("RCCPC TRANSMIT",DUZ)) W *7,*7,!,"You do not have access to do this." Q
"RTN","RCCPCML",7,0)
 S %DT="AEXP"
"RTN","RCCPCML",8,0)
 S %DT("A")="Enter statement date as it will appear on these statements: "
"RTN","RCCPCML",9,0)
 S SDT=$O(^RCPS(349.2,0)) I 'SDT W !,"You need to build the CCPC file." Q
"RTN","RCCPCML",10,0)
 S SDT=$P($P($G(^RCPS(349.2,SDT,0)),"^",10),".") I 'SDT W !,"Your CCPC statement file (349.2) is corrupted. Please rebuild it." Q
"RTN","RCCPCML",11,0)
 S SDT=$E(SDT,1,5)_$$STDY^RCCPCFN
"RTN","RCCPCML",12,0)
 S %DT("B")=$$FMTE^XLFDT(SDT)
"RTN","RCCPCML",13,0)
 D ^%DT Q:(X="^")!($D(DTOUT))!(Y=-1)
"RTN","RCCPCML",14,0)
 S SDT=$E(Y,1,5)_$$STDY^RCCPCFN,SDT=$$STDT^RCCPCFN(SDT)
"RTN","RCCPCML",15,0)
 S ZTSAVE("SDT")="",ZTRTN="RETRAN^RCCPCML",ZTIO="",ZTDESC="Re-transmit CCPC patient statements -user activated"
"RTN","RCCPCML",16,0)
 D ^%ZTLOAD
"RTN","RCCPCML",17,0)
 Q
"RTN","RCCPCML",18,0)
 ;
"RTN","RCCPCML",19,0)
EN ;called from background job
"RTN","RCCPCML",20,0)
 N DA,DIK
"RTN","RCCPCML",21,0)
 S SDT=$$STDT^RCCPCFN("")
"RTN","RCCPCML",22,0)
RETRAN N DA,DIK,ERROR,RCT,X
"RTN","RCCPCML",23,0)
 S (ERROR,X)=0 F  S X=$O(^RCPS(349.2,X)) Q:'X  I $G(^(X,6)) S ERROR=1,NM=0 D ERROR Q
"RTN","RCCPCML",24,0)
 I $G(ERROR) D EXIT Q
"RTN","RCCPCML",25,0)
 K ^TMP($J)
"RTN","RCCPCML",26,0)
 S X=0 F  S X=$O(^RCT(349,"B",X)) Q:X=""  I $P(X,".")="PS" S DA=$O(^RCT(349,"B",X,0)),DIK="^RCT(349," D ^DIK
"RTN","RCCPCML",27,0)
 F X="PA","IS","IT" S RCT=$O(^RCT(349.1,"B",X,0)) I RCT K ^RCT(349.1,+RCT,4)
"RTN","RCCPCML",28,0)
 N %,ADD,AMT,ERROR,L,LN,M,MSG,MCT,MPT1,MTOT,NM,P,PD,PD0,PSN,PT,PT0,PHCT,RCM,RTY,TAMT,TMSG,SZ
"RTN","RCCPCML",29,0)
 D DT^DICRW
"RTN","RCCPCML",30,0)
 S (ERROR,RTY)=0
"RTN","RCCPCML",31,0)
 S X=$O(^RCT(349.1,"B","PS",0))
"RTN","RCCPCML",32,0)
 I X,$P($G(^RCT(349.1,+X,0)),"^",3) S X=$P($G(^RCT(349.1,+X,3)),"^",3)
"RTN","RCCPCML",33,0)
 I X']"" S ERROR=6,NM=0 D ERROR,EXIT Q
"RTN","RCCPCML",34,0)
 D PHCT I 'PHCT S ERROR=1,NM=0 D ERROR,EXIT Q
"RTN","RCCPCML",35,0)
 S MTOT=$O(^TMP($J,"MCT",""),-1)
"RTN","RCCPCML",36,0)
 S MCT=0 F  S MCT=$O(^TMP($J,"MCT",MCT)) Q:'MCT  D PS
"RTN","RCCPCML",37,0)
EXIT D ERRML^RCCPCML1
"RTN","RCCPCML",38,0)
 K SDT,^TMP($J)
"RTN","RCCPCML",39,0)
 Q
"RTN","RCCPCML",40,0)
 ;
"RTN","RCCPCML",41,0)
F349 ;Get PS segment entry
"RTN","RCCPCML",42,0)
 N DA,D0,DIC,DLAYGO,X
"RTN","RCCPCML",43,0)
 S ERROR=0 K DD,DO S DIC="^RCT(349,",DIC(0)="L",DLAYGO=349,X="PS."_$TR($$FMTE^XLFDT(DT,"2D"),"/",".")_"."_RCM D FILE^DICN
"RTN","RCCPCML",44,0)
 I Y<0 S RTY=RTY+1 G F349:RTY<4 S ERROR=2,NM=0 D ERROR Q
"RTN","RCCPCML",45,0)
 S PSN=+Y
"RTN","RCCPCML",46,0)
 Q
"RTN","RCCPCML",47,0)
 ;
"RTN","RCCPCML",48,0)
PS ;Build PS,PH,PD segments and messages
"RTN","RCCPCML",49,0)
 S PSN=$O(^TMP($J,"MCT",MCT,0))
"RTN","RCCPCML",50,0)
 S $P(^RCT(349,+PSN,0),"^",3,10)=MCT_"^"_MTOT_"^"_$$SITE^RCMSITE()_"^"_$$FP^RCCPCFN_"^"_+^TMP($J,"MCT",MCT)_"^"_$P(^TMP($J,"MCT",MCT),"^",2)_"^"_SDT_"^"_$$STM^RCCPCFN
"RTN","RCCPCML",51,0)
 S LN=+PSN,^TMP($J,"MSG",LN)=$P($G(^RCT(349,+PSN,0)),"^",2,10)_"^|"
"RTN","RCCPCML",52,0)
 S MPT1=$P(^TMP($J,"MCT",MCT),"^",3)
"RTN","RCCPCML",53,0)
 S PT=$S(MCT=1:0,1:$P(^TMP($J,"MCT",MCT-1),"^",3))
"RTN","RCCPCML",54,0)
 F  S PT=$O(^RCPS(349.2,PT)) Q:PT=$O(^RCPS(349.2,+($P(^TMP($J,"MCT",MCT),"^",3))))  D
"RTN","RCCPCML",55,0)
 .Q:$D(^TMP($J,"ERRPT",+PT))
"RTN","RCCPCML",56,0)
 .S PT0=^RCPS(349.2,+PT,0)
"RTN","RCCPCML",57,0)
 .S LN=LN+1 S ^TMP($J,"MSG",LN)="PH^"_$$SITE^RCMSITE_$$KEY^RCCPCFN(+PT)_"^"_$$NM^RCCPCFN(+PT)_"^"
"RTN","RCCPCML",58,0)
 .S ADD=$G(^RCPS(349.2,+PT,1))
"RTN","RCCPCML",59,0)
 .F P=1:1:7 S $P(^TMP($J,"MSG",LN),"^",P+5)=$S($P(ADD,"^",P)]"":$P(ADD,"^",P),1:"")
"RTN","RCCPCML",60,0)
 .S ^TMP($J,"MSG",LN)=^TMP($J,"MSG",LN)_"^"
"RTN","RCCPCML",61,0)
 .S LN=LN+1
"RTN","RCCPCML",62,0)
 .F X=4:1:8 S $P(AMT,"^",X-3)=$$HEX^RCCPCFN($P(PT0,"^",X))
"RTN","RCCPCML",63,0)
 .;S ^TMP($J,"MSG",LN)=AMT_"^"_$G(^RCPS(349.2,+PT,3))_"^"_$G(^RCPS(349.2,+PT,4))_"^"_$P(^RCPS(349.2,+PT,2,0),"^",4)_"^|"
"RTN","RCCPCML",64,0)
 .S ^TMP($J,"MSG",LN)=AMT_"^"_$G(^RCPS(349.2,+PT,3))_"^"_$G(^RCPS(349.2,+PT,4))_"^"_$O(^RCPS(349.2,+PT,2,""),-1)
"RTN","RCCPCML",65,0)
 .S LN=LN+1 I $P($G(^RCD(340,+PT,0)),";") S ^TMP($J,"MSG",LN)="^"_$$SITE^RCMSITE_$$RJ^XLFSTR($TR($P(^RCD(340,+PT,0),";"),".",""),13,0)
"RTN","RCCPCML",66,0)
 .S ^TMP($J,"MSG",LN)=$G(^TMP($J,"MSG",LN))_"^|"
"RTN","RCCPCML",67,0)
 .S $P(^RCPS(349.2,+PT,0),"^",11)=+PSN
"RTN","RCCPCML",68,0)
 .S PD=0 F  S PD=$O(^RCPS(349.2,+PT,2,PD)) Q:'PD  I $D(^(PD,0)) S PD0=^(0) D
"RTN","RCCPCML",69,0)
 ..S AMT(0)=$$HEX^RCCPCFN($P(PD0,"^",3))
"RTN","RCCPCML",70,0)
 ..S LN=LN+1,^TMP($J,"MSG",LN)="PD^"_$$DAT^RCCPCFN(+PD0)_"^"_$P(PD0,"^",2)_"^"_AMT(0)_"^"_$P(PD0,"^",4)_"^|"
"RTN","RCCPCML",71,0)
 S LN=LN+1,^TMP($J,"MSG",LN)="~"
"RTN","RCCPCML",72,0)
 ;
"RTN","RCCPCML",73,0)
MAIL ;set up mail message
"RTN","RCCPCML",74,0)
 N L,XMDUZ,XMSUB,XMY,XMZ,Z
"RTN","RCCPCML",75,0)
 S XMSUB=$$SITE^RCMSITE()_" CCPC TRANSMISSION "_SDT
"RTN","RCCPCML",76,0)
 S XMDUZ="AR PACKAGE"
"RTN","RCCPCML",77,0)
 I $O(^XMB(3.8,"B","RCCPC STATEMENTS","")),$P($G(^RC(342,1,0)),"^",12) S XMY("G.RCCPC STATEMENTS")=""
"RTN","RCCPCML",78,0)
 S X=$O(^RCT(349.1,"B","PS",0))
"RTN","RCCPCML",79,0)
 I X,$P($G(^RCT(349.1,+X,0)),"^",3) S X=$P($G(^RCT(349.1,+X,3)),"^")_"@"_$P($G(^RCT(349.1,+X,3)),"^",3) S:$P(X,"@",2)]"" XMY(X)=""
"RTN","RCCPCML",80,0)
 I $P(X,"@",2)']"" D  Q
"RTN","RCCPCML",81,0)
 .S ERROR=6,NM=0 D ERROR
"RTN","RCCPCML",82,0)
 S XMDUZ="AR PACKAGE"
"RTN","RCCPCML",83,0)
 D XMZ^XMA2
"RTN","RCCPCML",84,0)
 I XMZ<1 S RTY=RTY+1 G MAIL:RTY<4 S ERROR=5,NM=0 D ERROR Q
"RTN","RCCPCML",85,0)
 S $P(^RCT(349,+PSN,0),"^",11,12)=DT_"^"_XMZ
"RTN","RCCPCML",86,0)
 S (L,L(1))=0 F  S L(1)=$O(^TMP($J,"MSG",L(1))) Q:'L(1)  S L=L+1,^XMB(3.9,+XMZ,2,L,0)=^TMP($J,"MSG",L(1))
"RTN","RCCPCML",87,0)
 ;S L=$O(^TMP($J,"MSG",""),-1)
"RTN","RCCPCML",88,0)
 S ^XMB(3.9,XMZ,2,0)="^3.92A^"_L_"^"_L_"^"_DT
"RTN","RCCPCML",89,0)
 D ENT1^XMD
"RTN","RCCPCML",90,0)
 D NOW^%DTC
"RTN","RCCPCML",91,0)
 S $P(^RCT(349,+PSN,0),"^",11,12)=%_"^"_XMZ
"RTN","RCCPCML",92,0)
 K ^TMP($J,"MSG")
"RTN","RCCPCML",93,0)
 ;D KILL^XM
"RTN","RCCPCML",94,0)
 Q
"RTN","RCCPCML",95,0)
 ;
"RTN","RCCPCML",96,0)
PHCT ;PH count
"RTN","RCCPCML",97,0)
 S (ERROR,PT,PHCT,TAMT,SZ)=0,RCM=1
"RTN","RCCPCML",98,0)
 F  S PT=$O(^RCPS(349.2,PT)) Q:'PT  S ERROR=0 D  I ERROR,(ERROR<3) Q
"RTN","RCCPCML",99,0)
 .S SZ(1)=0 D ERRCHK Q:ERROR
"RTN","RCCPCML",100,0)
 .S PT0=^RCPS(349.2,+PT,0)
"RTN","RCCPCML",101,0)
 .S PHCT=PHCT+1
"RTN","RCCPCML",102,0)
 .S SZ=550+SZ,SZ(1)=550
"RTN","RCCPCML",103,0)
 .S:$G(^RCPS(349.2,+PT,1))]"" SZ=SZ+$L(^(1)),SZ(1)=SZ(1)+$L(^(1))
"RTN","RCCPCML",104,0)
 .S:$G(^RCPS(349.2,+PT,3))]"" SZ=SZ+$L(^(3))+1,SZ(1)=SZ(1)+$L(^(3))+1
"RTN","RCCPCML",105,0)
 .S:$G(^RCPS(349.2,+PT,4))]"" SZ=SZ+$L(^(4))+1,SZ(1)=SZ(1)+$L(^(4))+1
"RTN","RCCPCML",106,0)
 .S X=0 F  S X=$O(^RCPS(349.2,+PT,2,X)) Q:'X  I $D(^(X,0)) S SZ=$L(^(0))+SZ,SZ(1)=SZ(1)+$L(^(0))
"RTN","RCCPCML",107,0)
 .S TAMT=TAMT+$P(^RCPS(349.2,+PT,0),"^",8)
"RTN","RCCPCML",108,0)
 .I SZ>27000 D
"RTN","RCCPCML",109,0)
 ..S RTY=0 D F349 Q:ERROR
"RTN","RCCPCML",110,0)
 ..S TAMT=TAMT-$P(PT0,"^",8)
"RTN","RCCPCML",111,0)
 ..S TAMT=$$HEX^RCCPCFN(TAMT)
"RTN","RCCPCML",112,0)
 ..S ^TMP($J,"MCT",RCM)=(PHCT-1)_"^"_TAMT_"^"_$O(^RCPS(349.2,PT),-1)_"^"_(SZ-SZ(1))
"RTN","RCCPCML",113,0)
 ..S ^TMP($J,"MCT",RCM,+PSN)=""
"RTN","RCCPCML",114,0)
 ..S RCM=RCM+1,PHCT=1
"RTN","RCCPCML",115,0)
 ..S SZ=SZ(1)
"RTN","RCCPCML",116,0)
 ..S TAMT=$P(PT0,"^",8)
"RTN","RCCPCML",117,0)
 I 'PT,$O(^RCPS(349.2,0)) D
"RTN","RCCPCML",118,0)
 .S RTY=0 D F349 Q:ERROR  S ^TMP($J,"MCT",RCM)=PHCT_"^"_$$HEX^RCCPCFN(TAMT)_"^"_$O(^RCPS(349.2,PT),-1)
"RTN","RCCPCML",119,0)
 .S ^TMP($J,"MCT",RCM,+PSN)=""
"RTN","RCCPCML",120,0)
 Q
"RTN","RCCPCML",121,0)
 ;
"RTN","RCCPCML",122,0)
ERROR ;ERROR FILE
"RTN","RCCPCML",123,0)
 I NM=0 S ^TMP($J,"ERROR",ERROR,NM)="" Q
"RTN","RCCPCML",124,0)
 S ^TMP($J,"ERROR",ERROR,NM,$$SSN^RCFN01(+PT))=""
"RTN","RCCPCML",125,0)
 Q
"RTN","RCCPCML",126,0)
 ;
"RTN","RCCPCML",127,0)
ERRCHK ;Error check
"RTN","RCCPCML",128,0)
 I '$D(^RCPS(349.2,+PT,0)) S ERROR=1,NM=0 D ERROR Q
"RTN","RCCPCML",129,0)
 S PT(1)=PT,PT=$O(^RCPS(349.2,0)) I '$P(^RCPS(349.2,PT,0),"^",18) S ERROR=1,NM=0 D ERROR S PT=PT(1) Q
"RTN","RCCPCML",130,0)
 S PT=PT(1)
"RTN","RCCPCML",131,0)
 I $$KEY^RCCPCFN(+PT)']"" S ERROR=4,NM=$$NAM^RCFN01(+PT) D ERROR S ^TMP($J,"ERRPT",+PT)="" Q
"RTN","RCCPCML",132,0)
 I '$D(^RCPS(349.2,"AKEY",$$KEY^RCCPCFN(+PT))) S ERROR=4,NM=$$NAM^RCFN01(+PT) D ERROR S ^TMP($J,"ERRPT",+PT)="" Q
"RTN","RCCPCML",133,0)
 S ADD=$G(^RCPS(349.2,+PT,1))
"RTN","RCCPCML",134,0)
 F P=1:1:7 S ADD(P)=$S($P(ADD,"^",P)]"":$P(ADD,"^",P),1:"")
"RTN","RCCPCML",135,0)
 I ADD(1)="",ADD(2)="",ADD(3)="",ADD(4)="",ADD(5)="",ADD(6)="" S ERROR=8,NM=$$NAM^RCFN01(+PT) D ERROR S ^TMP($J,"ERRPT",+PT)="" Q
"RTN","RCCPCML",136,0)
 I ADD(1)="",(ADD(2)=""),(ADD(3)=""),(ADD(6)="") S ERROR=8,NM=$$NAM^RCFN01(+PT) D ERROR S ^TMP($J,"ERRPT",+PT)="" Q
"RTN","RCCPCML",137,0)
 I ADD(4)=""!(ADD(5)="")!(ADD(6)="") S ERROR=8,NM=$$NAM^RCFN01(+PT) D ERROR S ^TMP($J,"ERRPT",+PT)=""
"RTN","RCCPCML",138,0)
 F ADD=1:1:6 I ADD(ADD)'?.ANP S ERROR=10,NM=$$NAM^RCFN01(+PT),^TMP($J,"ERRPT",+PT)="" D ERROR Q
"RTN","RCCPCML",139,0)
 I $P($G(^RCD(340,+PT,1)),"^",9) S ^TMP($J,"ERRPT",+PT)="",ERROR=9,NM=$$NAM^RCFN01(+PT) D ERROR
"RTN","RCCPCML",140,0)
 Q
"RTN","RCDPXPAP")
0^2^B46255466
"RTN","RCDPXPAP",1,0)
RCDPXPAP ;WISC/RFJ-automatically process the deposits  ;1 Jun 99
"RTN","RCDPXPAP",2,0)
 ;;4.5;Accounts Receivable;**114,150,206**;Mar 20, 1995
"RTN","RCDPXPAP",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","RCDPXPAP",4,0)
 Q
"RTN","RCDPXPAP",5,0)
 ;
"RTN","RCDPXPAP",6,0)
 ;
"RTN","RCDPXPAP",7,0)
PROCESS(RCDPDATE,RCPAYDA) ;  process the deposits
"RTN","RCDPXPAP",8,0)
 ;  rcdpdate is the transmission date;  rcpayda is ien for the payment
"RTN","RCDPXPAP",9,0)
 ;  type found in ^rc(341.1,rcpayda)
"RTN","RCDPXPAP",10,0)
 N DR,PAYDESC,RCDEPDAT,RCDEPOSI,RCDEPTDA,RCDFN,RCDPDATA,RCLINE,RCRECTDA,RCTRANDA,STATUS
"RTN","RCDPXPAP",11,0)
 K ^TMP($J,"RCDPXPAP")
"RTN","RCDPXPAP",12,0)
 ;
"RTN","RCDPXPAP",13,0)
 ;  file the data in the payment files 344 and 344.1
"RTN","RCDPXPAP",14,0)
 ;  tmp global = acct number(1) ^ amount(2) ^ batch#(3) ^ sequence#(4) ^
"RTN","RCDPXPAP",15,0)
 ;               pay type(5)    ^ pay desc fields(6)
"RTN","RCDPXPAP",16,0)
 S RCDEPOSI="" F  S RCDEPOSI=$O(^TMP($J,"RCDPXPAY","DEPOSIT",RCDEPOSI)) Q:RCDEPOSI=""  D
"RTN","RCDPXPAP",17,0)
 .   S RCDEPDAT=$G(^TMP($J,"RCDPXPAY","DEPDATE",RCDEPOSI))
"RTN","RCDPXPAP",18,0)
 .   ;  add the deposit if not already in file
"RTN","RCDPXPAP",19,0)
 .   ;  make sure deposit is 6 characters in length
"RTN","RCDPXPAP",20,0)
 .   S X=$E("000000",1,6-$L(RCDEPOSI))_RCDEPOSI
"RTN","RCDPXPAP",21,0)
 .   S RCDEPTDA=$$ADDDEPT^RCDPUDEP(X,RCDEPDAT)
"RTN","RCDPXPAP",22,0)
 .   I 'RCDEPTDA D ERROR^RCDPXPAM(RCDPDATE,RCDPXMZ,"Unable to ADD deposit "_RCDEPOSI_" to the AR DEPOSIT file #344.1") Q
"RTN","RCDPXPAP",23,0)
 .   ;
"RTN","RCDPXPAP",24,0)
 .   ;  lock deposit
"RTN","RCDPXPAP",25,0)
 .   L +^RCY(344.1,RCDEPTDA)
"RTN","RCDPXPAP",26,0)
 .   ;  confirm deposit (close it to prevent modifications to it)
"RTN","RCDPXPAP",27,0)
 .   D CONFIRM^RCDPUDEP(RCDEPTDA)
"RTN","RCDPXPAP",28,0)
 .   ;  store the deposit for unlocking below
"RTN","RCDPXPAP",29,0)
 .   S ^TMP($J,"RCDPXPAP","DEPOSITLOCK",RCDEPTDA)=""
"RTN","RCDPXPAP",30,0)
 .   ;
"RTN","RCDPXPAP",31,0)
 .   ;  create receipt for transmission date and deposit
"RTN","RCDPXPAP",32,0)
 .   S RCRECTDA=$$ADDRECT^RCDPUREC(RCDPDATE,RCDEPTDA,RCPAYDA)
"RTN","RCDPXPAP",33,0)
 .   I 'RCRECTDA D ERROR^RCDPXPAM(RCDPDATE,RCDPXMZ,"Unable to ADD receipt "_RCDPDATE_" to the AR BATCH PAYMENT file #344") Q
"RTN","RCDPXPAP",34,0)
 .   ;
"RTN","RCDPXPAP",35,0)
 .   ;  lock receipt
"RTN","RCDPXPAP",36,0)
 .   L +^RCY(344,RCRECTDA)
"RTN","RCDPXPAP",37,0)
 .   ;  check to see if receipt has been processed (fms document)
"RTN","RCDPXPAP",38,0)
 .   D DIQ344^RCDPRPLM(RCRECTDA,"200;")
"RTN","RCDPXPAP",39,0)
 .   ;  code sheet already sent once, this is a retransmission, check it
"RTN","RCDPXPAP",40,0)
 .   I RCDPDATA(344,RCRECTDA,200,"E")'="" D
"RTN","RCDPXPAP",41,0)
 .   .   S STATUS=$$STATUS^GECSSGET(RCDPDATA(344,RCRECTDA,200,"E"))
"RTN","RCDPXPAP",42,0)
 .   .   ;  okay to continue if status is Error, Rejected, or not defined (-1)
"RTN","RCDPXPAP",43,0)
 .   .   I $E(STATUS)="E"!($E(STATUS)="R")!(STATUS=-1) Q
"RTN","RCDPXPAP",44,0)
 .   .   S ^TMP($J,"RCDPXPAP","DUPLICATE",RCRECTDA)="Receipt Not Changed^1"
"RTN","RCDPXPAP",45,0)
 .   I $D(^TMP($J,"RCDPXPAP","DUPLICATE",RCRECTDA)) L -^RCY(344,RCRECTDA) Q
"RTN","RCDPXPAP",46,0)
 .   ;
"RTN","RCDPXPAP",47,0)
 .   ;  mark receipt as processed (closed) to prevent editing
"RTN","RCDPXPAP",48,0)
 .   D MARKPROC^RCDPUREC(RCRECTDA,"")
"RTN","RCDPXPAP",49,0)
 .   ;  store the receipt for automatic processing (and unlock) below
"RTN","RCDPXPAP",50,0)
 .   ;  the 0 is the count of unlinked accts displayed in mail message
"RTN","RCDPXPAP",51,0)
 .   S ^TMP($J,"RCDPXPAP","PROCESS",RCRECTDA)=0
"RTN","RCDPXPAP",52,0)
 .   ;
"RTN","RCDPXPAP",53,0)
 .   ;  build a list of the current stored payments by batch_sequence
"RTN","RCDPXPAP",54,0)
 .   ;  number to prevent adding duplicates
"RTN","RCDPXPAP",55,0)
 .   K ^TMP($J,"RCDPXPAP",RCRECTDA)
"RTN","RCDPXPAP",56,0)
 .   S RCLINE=0 F  S RCLINE=$O(^RCY(344,RCRECTDA,1,RCLINE)) Q:'RCLINE  D
"RTN","RCDPXPAP",57,0)
 .   .   S RCDPDATA=$G(^RCY(344,RCRECTDA,1,RCLINE,2))
"RTN","RCDPXPAP",58,0)
 .   .   I '$P(RCDPDATA,"^",2)!('$P(RCDPDATA,"^",3)) Q
"RTN","RCDPXPAP",59,0)
 .   .   S ^TMP($J,"RCDPXPAP",RCRECTDA,$P(RCDPDATA,"^",2),$P(RCDPDATA,"^",3))=RCLINE
"RTN","RCDPXPAP",60,0)
 .   ;
"RTN","RCDPXPAP",61,0)
 .   ;  loop transactions and add them to the receipt
"RTN","RCDPXPAP",62,0)
 .   S RCLINE=0 F  S RCLINE=$O(^TMP($J,"RCDPXPAY","DEPOSIT",RCDEPOSI,RCLINE)) Q:'RCLINE  D
"RTN","RCDPXPAP",63,0)
 .   .   ;  data in the form:
"RTN","RCDPXPAP",64,0)
 .   .   ;  acct lookup(1)  ^ amount(2) ^ batch(3) ^ sequence(4) ^
"RTN","RCDPXPAP",65,0)
 .   .   ;  payment type(5) ^ payment description(6)
"RTN","RCDPXPAP",66,0)
 .   .   S RCDPDATA=^TMP($J,"RCDPXPAY","DEPOSIT",RCDEPOSI,RCLINE)
"RTN","RCDPXPAP",67,0)
 .   .   ;  if batch and sequence number already stored get current entry
"RTN","RCDPXPAP",68,0)
 .   .   ;  and do not add a new one
"RTN","RCDPXPAP",69,0)
 .   .   S RCTRANDA=0
"RTN","RCDPXPAP",70,0)
 .   .   I $P(RCDPDATA,"^",3),$P(RCDPDATA,"^",4) S RCTRANDA=+$G(^TMP($J,"RCDPXPAP",RCRECTDA,+$P(RCDPDATA,"^",3),+$P(RCDPDATA,"^",4)))
"RTN","RCDPXPAP",71,0)
 .   .   I 'RCTRANDA S RCTRANDA=+$$ADDTRAN^RCDPURET(RCRECTDA)
"RTN","RCDPXPAP",72,0)
 .   .   I 'RCTRANDA D ERROR^RCDPXPAM(RCDPDATE,RCDPXMZ,"Unable to ADD a new transaction to the AR BATCH PAYMENT file #344") Q
"RTN","RCDPXPAP",73,0)
 .   .   ;
"RTN","RCDPXPAP",74,0)
 .   .   ;  if the entry has already been processed, do not make any changes
"RTN","RCDPXPAP",75,0)
 .   .   I $P(^RCY(344,RCRECTDA,1,RCTRANDA,0),"^",5) S:'$D(^TMP($J,"RCDPXPAP","DUPLICATE",RCRECTDA)) ^(RCRECTDA)="Receipt Not Changed" Q
"RTN","RCDPXPAP",76,0)
 .   .   I $D(^TMP($J,"RCDPXPAP","DUPLICATE",RCRECTDA)) S ^(RCRECTDA)="Receipt Updated"
"RTN","RCDPXPAP",77,0)
 .   .   ;
"RTN","RCDPXPAP",78,0)
 .   .   ;  lookup account
"RTN","RCDPXPAP",79,0)
 .   .   S RCDFN=$$FINDACCT($P(RCDPDATA,"^"))_";DPT("
"RTN","RCDPXPAP",80,0)
 .   .   ;  acct not found, count as unlinked for mail message
"RTN","RCDPXPAP",81,0)
 .   .   I 'RCDFN S ^TMP($J,"RCDPXPAP","PROCESS",RCRECTDA)=^TMP($J,"RCDPXPAP","PROCESS",RCRECTDA)+1
"RTN","RCDPXPAP",82,0)
 .   .   ;
"RTN","RCDPXPAP",83,0)
 .   .   ;  build dr string to store the data
"RTN","RCDPXPAP",84,0)
 .   .   S DR=".21////"_$P(RCDPDATA,"^")_";"       ;account
"RTN","RCDPXPAP",85,0)
 .   .   I RCDFN S DR=DR_".03////^S X=RCDFN;.09////^S X=RCDFN;"
"RTN","RCDPXPAP",86,0)
 .   .   S DR=DR_".22////"_+$P(RCDPDATA,"^",3)_";" ;batch number
"RTN","RCDPXPAP",87,0)
 .   .   S DR=DR_".23////"_+$P(RCDPDATA,"^",4)_";" ;sequence number
"RTN","RCDPXPAP",88,0)
 .   .   S DR=DR_".24////"_$P(RCDPDATA,"^",5)_";"  ;payment type
"RTN","RCDPXPAP",89,0)
 .   .   S DR=DR_".04////"_($P(RCDPDATA,"^",2)/100)_";" ;payment amount
"RTN","RCDPXPAP",90,0)
 .   .   S DR=DR_".06////"_RCDEPDAT_";"            ;payment date = deposit date
"RTN","RCDPXPAP",91,0)
 .   .   ;
"RTN","RCDPXPAP",92,0)
 .   .   S PAYDESC=$P(RCDPDATA,"^",6)
"RTN","RCDPXPAP",93,0)
 .   .   ;  payment type check
"RTN","RCDPXPAP",94,0)
 .   .   I $P(RCDPDATA,"^",5)=2 D
"RTN","RCDPXPAP",95,0)
 .   .   .   ;  check number : account number : bank routing number
"RTN","RCDPXPAP",96,0)
 .   .   .   I $P(PAYDESC,":")'="" S DR=DR_".07////"_$P(PAYDESC,":")_";"
"RTN","RCDPXPAP",97,0)
 .   .   .   I $P(PAYDESC,":",2)'="" S DR=DR_".13////"_$P(PAYDESC,":",2)_";"
"RTN","RCDPXPAP",98,0)
 .   .   .   I $P(PAYDESC,":",3)'="" S DR=DR_".08////"_$P(PAYDESC,":",3)_";"
"RTN","RCDPXPAP",99,0)
 .   .   ;  payment type credit, store credit card number
"RTN","RCDPXPAP",100,0)
 .   .   I $P(RCDPDATA,"^",5)=3,$P(PAYDESC,":")'="" S DR=DR_".11////"_$P(PAYDESC,":")_";"
"RTN","RCDPXPAP",101,0)
 .   .   ;
"RTN","RCDPXPAP",102,0)
 .   .   ;  store the payment under the receipt
"RTN","RCDPXPAP",103,0)
 .   .   D FILETRAN(RCRECTDA,RCTRANDA,DR)
"RTN","RCDPXPAP",104,0)
 ;
"RTN","RCDPXPAP",105,0)
 ;  automatically process the receipts added
"RTN","RCDPXPAP",106,0)
 ;  ^tmp($j,"rcdpxpap","process",receiptda)=""
"RTN","RCDPXPAP",107,0)
 S RCRECTDA=0 F  S RCRECTDA=$O(^TMP($J,"RCDPXPAP","PROCESS",RCRECTDA)) Q:'RCRECTDA  D
"RTN","RCDPXPAP",108,0)
 .   D PROCESS^RCDPURE1(RCRECTDA,0)
"RTN","RCDPXPAP",109,0)
 .   ;  clear the lock (set above)
"RTN","RCDPXPAP",110,0)
 .   L -^RCY(344,RCRECTDA)
"RTN","RCDPXPAP",111,0)
 ;
"RTN","RCDPXPAP",112,0)
 ;  clear all locked deposits
"RTN","RCDPXPAP",113,0)
 S RCDEPTDA=0 F  S RCDEPTDA=$O(^TMP($J,"RCDPXPAP","DEPOSITLOCK",RCDEPTDA)) Q:'RCDEPTDA  D
"RTN","RCDPXPAP",114,0)
 .   ;  confirm deposit (recalc totals)
"RTN","RCDPXPAP",115,0)
 .   D CONFIRM^RCDPUDEP(RCDEPTDA)
"RTN","RCDPXPAP",116,0)
 .   L -^RCY(344.1,RCDEPTDA)
"RTN","RCDPXPAP",117,0)
 ;
"RTN","RCDPXPAP",118,0)
 ;  send a message to the users showing what was processed
"RTN","RCDPXPAP",119,0)
 D PROCMSG^RCDPXPAM
"RTN","RCDPXPAP",120,0)
 ;
"RTN","RCDPXPAP",121,0)
 ;  need to delete the 344.2 entry
"RTN","RCDPXPAP",122,0)
 D DELETRAN^RCDPXPA1(RCDPDATE)
"RTN","RCDPXPAP",123,0)
 ;
"RTN","RCDPXPAP",124,0)
 K ^TMP($J,"RCDPXPAP")
"RTN","RCDPXPAP",125,0)
 Q
"RTN","RCDPXPAP",126,0)
 ;
"RTN","RCDPXPAP",127,0)
 ;
"RTN","RCDPXPAP",128,0)
FINDACCT(ACCT) ;  lookup the patient and return the dfn
"RTN","RCDPXPAP",129,0)
 ;  if more than one patient matches acct, return null
"RTN","RCDPXPAP",130,0)
 ;  acct in the form 123456789ABCDE
"RTN","RCDPXPAP",131,0)
 I ACCT'?9N1.5A  D  Q DFN
"RTN","RCDPXPAP",132,0)
 . S DFN=+ACCT I $G(^DPT(DFN,0))'="" Q
"RTN","RCDPXPAP",133,0)
 . S DFN=$E(DFN,1,10)_"."_$E(DFN,11,99) I $G(^DPT(DFN,0))'="" Q 
"RTN","RCDPXPAP",134,0)
 . S DFN=0
"RTN","RCDPXPAP",135,0)
 . ;
"RTN","RCDPXPAP",136,0)
 N COUNT,DFN,FOUND,NAME,SSN
"RTN","RCDPXPAP",137,0)
 S SSN=$E(ACCT,1,9),NAME=$E(ACCT,10,99)
"RTN","RCDPXPAP",138,0)
 I SSN="" Q 0
"RTN","RCDPXPAP",139,0)
 S NAME=$TR(NAME,"/","'")
"RTN","RCDPXPAP",140,0)
 S COUNT=0  ;used to count number of matches
"RTN","RCDPXPAP",141,0)
 S FOUND=0  ;used to store matching acct's DFN number
"RTN","RCDPXPAP",142,0)
 S DFN=0 F  S DFN=$O(^DPT("SSN",SSN,DFN)) Q:'DFN  I $E($TR($P($G(^DPT(DFN,0)),"^")," "),1,$L(NAME))=NAME S COUNT=COUNT+1,FOUND=DFN
"RTN","RCDPXPAP",143,0)
 ;  multiple acct matches, return null
"RTN","RCDPXPAP",144,0)
 I COUNT>1 Q 0
"RTN","RCDPXPAP",145,0)
 ;  acct found, return dfn of account which matches
"RTN","RCDPXPAP",146,0)
 I FOUND Q FOUND
"RTN","RCDPXPAP",147,0)
 ;  try looking up the name without the apostrophe
"RTN","RCDPXPAP",148,0)
 S NAME=$TR(NAME,"'")
"RTN","RCDPXPAP",149,0)
 S DFN=0 F  S DFN=$O(^DPT("SSN",SSN,DFN)) Q:'DFN  I $E($TR($P($G(^DPT(DFN,0)),"^")," "),1,$L(NAME))=NAME S COUNT=COUNT+1,FOUND=DFN
"RTN","RCDPXPAP",150,0)
 ;  multiple acct matches, return null
"RTN","RCDPXPAP",151,0)
 I COUNT>1 Q 0
"RTN","RCDPXPAP",152,0)
 ;  return dfn of account which matches, or 0 if not found
"RTN","RCDPXPAP",153,0)
 Q +FOUND
"RTN","RCDPXPAP",154,0)
 ;
"RTN","RCDPXPAP",155,0)
 ;
"RTN","RCDPXPAP",156,0)
FILETRAN(RECTDA,TRANDA,DR) ;  file the payment transaction
"RTN","RCDPXPAP",157,0)
 N %,D,D0,D1,DA,DI,DIC,DICR,DIE,DIG,DIH,DIU,DIV,DIW,DQ,X,Y
"RTN","RCDPXPAP",158,0)
 S (DIC,DIE)="^RCY(344,"_RECTDA_",1,"
"RTN","RCDPXPAP",159,0)
 S DA=TRANDA,DA(1)=RECTDA
"RTN","RCDPXPAP",160,0)
 D ^DIE
"RTN","RCDPXPAP",161,0)
 Q
"VER")
8.0^22
**END**
**END**
