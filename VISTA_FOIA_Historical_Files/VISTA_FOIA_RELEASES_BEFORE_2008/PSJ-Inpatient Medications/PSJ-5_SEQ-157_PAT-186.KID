EMERGENCY Released PSJ*5*186 SEQ #157
Extracted from mail message
**KIDS**:PSJ*5.0*186^

**INSTALL NAME**
PSJ*5.0*186
"BLD",6991,0)
PSJ*5.0*186^INPATIENT MEDICATIONS^0^3060915^y
"BLD",6991,1,0)
^^13^13^3060915^^
"BLD",6991,1,1,0)
This patch addresses Remedy ticket HD158508 (PSI 06 125) and its 
"BLD",6991,1,2,0)
duplicate tickets.  An order with Special Instructions was entered, and 
"BLD",6991,1,3,0)
when prompted, the order was finished so that the BCMA Message Box flag 
"BLD",6991,1,4,0)
was set.  Therefore, when the medication was to be administered in BCMA, 
"BLD",6991,1,5,0)
a pop-up box was to display to show the nurse the Special Instructions.  
"BLD",6991,1,6,0)
The order was renewed via CPRS, and the order was FINISHED backdoor and 
"BLD",6991,1,7,0)
then had the Special Instructions were deleted before accepting the order 
"BLD",6991,1,8,0)
and verifying.  When the nurse entered BCMA to administer the medication 
"BLD",6991,1,9,0)
on the renewed order, BCMA behaved as though the medication was given, 
"BLD",6991,1,10,0)
but no pop-up box appeared, and the medication was not marked as given on 
"BLD",6991,1,11,0)
the VDL.  The underlying issue was that while the order had the Special 
"BLD",6991,1,12,0)
Instructions deleted, the flag to display/not display the message box in 
"BLD",6991,1,13,0)
BCMA was not cleared.
"BLD",6991,4,0)
^9.64PA^^
"BLD",6991,"KRN",0)
^9.67PA^8989.52^19
"BLD",6991,"KRN",.4,0)
.4
"BLD",6991,"KRN",.401,0)
.401
"BLD",6991,"KRN",.402,0)
.402
"BLD",6991,"KRN",.403,0)
.403
"BLD",6991,"KRN",.5,0)
.5
"BLD",6991,"KRN",.84,0)
.84
"BLD",6991,"KRN",3.6,0)
3.6
"BLD",6991,"KRN",3.8,0)
3.8
"BLD",6991,"KRN",9.2,0)
9.2
"BLD",6991,"KRN",9.8,0)
9.8
"BLD",6991,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",6991,"KRN",9.8,"NM",1,0)
PSGOEF1^^0^29654971
"BLD",6991,"KRN",9.8,"NM",2,0)
PSJBCMA^^0^63223587
"BLD",6991,"KRN",9.8,"NM",3,0)
PSJBCMA1^^0^59316594
"BLD",6991,"KRN",9.8,"NM",4,0)
PSJCOM^^0^38929893
"BLD",6991,"KRN",9.8,"NM",5,0)
PSJ0186^^0^13531411
"BLD",6991,"KRN",9.8,"NM","B","PSGOEF1",1)

"BLD",6991,"KRN",9.8,"NM","B","PSJ0186",5)

"BLD",6991,"KRN",9.8,"NM","B","PSJBCMA",2)

"BLD",6991,"KRN",9.8,"NM","B","PSJBCMA1",3)

"BLD",6991,"KRN",9.8,"NM","B","PSJCOM",4)

"BLD",6991,"KRN",19,0)
19
"BLD",6991,"KRN",19,"NM",0)
^9.68A^1^1
"BLD",6991,"KRN",19,"NM",1,0)
PSJU SI SEARCH^^0
"BLD",6991,"KRN",19,"NM","B","PSJU SI SEARCH",1)

"BLD",6991,"KRN",19.1,0)
19.1
"BLD",6991,"KRN",101,0)
101
"BLD",6991,"KRN",409.61,0)
409.61
"BLD",6991,"KRN",771,0)
771
"BLD",6991,"KRN",870,0)
870
"BLD",6991,"KRN",8989.51,0)
8989.51
"BLD",6991,"KRN",8989.52,0)
8989.52
"BLD",6991,"KRN",8994,0)
8994
"BLD",6991,"KRN","B",.4,.4)

"BLD",6991,"KRN","B",.401,.401)

"BLD",6991,"KRN","B",.402,.402)

"BLD",6991,"KRN","B",.403,.403)

"BLD",6991,"KRN","B",.5,.5)

"BLD",6991,"KRN","B",.84,.84)

"BLD",6991,"KRN","B",3.6,3.6)

"BLD",6991,"KRN","B",3.8,3.8)

"BLD",6991,"KRN","B",9.2,9.2)

"BLD",6991,"KRN","B",9.8,9.8)

"BLD",6991,"KRN","B",19,19)

"BLD",6991,"KRN","B",19.1,19.1)

"BLD",6991,"KRN","B",101,101)

"BLD",6991,"KRN","B",409.61,409.61)

"BLD",6991,"KRN","B",771,771)

"BLD",6991,"KRN","B",870,870)

"BLD",6991,"KRN","B",8989.51,8989.51)

"BLD",6991,"KRN","B",8989.52,8989.52)

"BLD",6991,"KRN","B",8994,8994)

"BLD",6991,"QUES",0)
^9.62^^
"BLD",6991,"REQB",0)
^9.611^1^1
"BLD",6991,"REQB",1,0)
PSJ*5.0*112^1
"BLD",6991,"REQB","B","PSJ*5.0*112",1)

"KRN",19,17155,-1)
0^1
"KRN",19,17155,0)
PSJU SI SEARCH^Search for problematic special instructions.^^R^^^^^^^^INPATIENT MEDICATIONS
"KRN",19,17155,25)
PSJ0186
"KRN",19,17155,"U")
SEARCH FOR PROBLEMATIC SPECIAL
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",203,-1)
1^1
"PKG",203,0)
INPATIENT MEDICATIONS^PSJ^UNIT DOSE AND IVS
"PKG",203,20,0)
^9.402P^^
"PKG",203,22,0)
^9.49I^1^1
"PKG",203,22,1,0)
5.0^2971215^2980417^1271
"PKG",203,22,1,"PAH",1,0)
186^3060915^33234
"PKG",203,22,1,"PAH",1,1,0)
^^13^13^3060915
"PKG",203,22,1,"PAH",1,1,1,0)
This patch addresses Remedy ticket HD158508 (PSI 06 125) and its 
"PKG",203,22,1,"PAH",1,1,2,0)
duplicate tickets.  An order with Special Instructions was entered, and 
"PKG",203,22,1,"PAH",1,1,3,0)
when prompted, the order was finished so that the BCMA Message Box flag 
"PKG",203,22,1,"PAH",1,1,4,0)
was set.  Therefore, when the medication was to be administered in BCMA, 
"PKG",203,22,1,"PAH",1,1,5,0)
a pop-up box was to display to show the nurse the Special Instructions.  
"PKG",203,22,1,"PAH",1,1,6,0)
The order was renewed via CPRS, and the order was FINISHED backdoor and 
"PKG",203,22,1,"PAH",1,1,7,0)
then had the Special Instructions were deleted before accepting the order 
"PKG",203,22,1,"PAH",1,1,8,0)
and verifying.  When the nurse entered BCMA to administer the medication 
"PKG",203,22,1,"PAH",1,1,9,0)
on the renewed order, BCMA behaved as though the medication was given, 
"PKG",203,22,1,"PAH",1,1,10,0)
but no pop-up box appeared, and the medication was not marked as given on 
"PKG",203,22,1,"PAH",1,1,11,0)
the VDL.  The underlying issue was that while the order had the Special 
"PKG",203,22,1,"PAH",1,1,12,0)
Instructions deleted, the flag to display/not display the message box in 
"PKG",203,22,1,"PAH",1,1,13,0)
BCMA was not cleared.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSGOEF1")
0^1^B29654971^B29279351
"RTN","PSGOEF1",1,0)
PSGOEF1 ;BIR/CML3-FINISH ORDERS ENTERED THROUGH OE/RR (CONT) ;02 Feb 2001  12:20 PM
"RTN","PSGOEF1",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**2,7,35,39,45,47,50,63,67,58,95,110,186**;16 DEC 97
"RTN","PSGOEF1",3,0)
 ;
"RTN","PSGOEF1",4,0)
 ; Reference to ^VALM1 is supported by DBIA# 10116.
"RTN","PSGOEF1",5,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSGOEF1",6,0)
 ; Reference to ^PSDRUG( is supported by DBIA 2192.
"RTN","PSGOEF1",7,0)
 ; Reference to ^%DTC is supported by DBIA 10000.
"RTN","PSGOEF1",8,0)
 ; Reference to ^%RCR is supported by DBIA 10022.
"RTN","PSGOEF1",9,0)
 ; Reference to ^DIE is supported by DBIA 10018.
"RTN","PSGOEF1",10,0)
 ; Reference to ^DIR is supported by DBIA 10026.
"RTN","PSGOEF1",11,0)
 ;
"RTN","PSGOEF1",12,0)
UPD ;
"RTN","PSGOEF1",13,0)
 W !!,"...accepting order..."
"RTN","PSGOEF1",14,0)
 I PSGST="",(PSGSCH="NOW"!(PSGSCH="ONCE")) S PSGST="O"
"RTN","PSGOEF1",15,0)
 I PSJCOM D UPD^PSJCOM Q
"RTN","PSGOEF1",16,0)
 K DA,DR S DA=+PSGORD,DIE="^PS(53.1,",DR="28////N;4////U"_";7////"_PSGST_";10////"_PSGSD_";25////"_PSGFD
"RTN","PSGOEF1",17,0)
 I $D(PSGSI),$P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" S ^PS(53.1,DA,6)=PSGSI
"RTN","PSGOEF1",18,0)
 I $D(PSGSI),$P($G(^PS(53.1,+PSGORD,0)),U,24)="R" S $P(^PS(53.1,DA,6),U)=$P(PSGSI,U) I $P(^PS(53.1,DA,6),U)="" S $P(^PS(53.1,DA,6),U,2)=""
"RTN","PSGOEF1",19,0)
 S:PSGOEFF#2 DR=DR_";26////"_PSGSCH
"RTN","PSGOEF1",20,0)
 I PSGSM,PSGOHSM'=PSGHSM S DR=DR_";5////"_PSGSM_";6////"_PSGHSM
"RTN","PSGOEF1",21,0)
 D ^DIE W "."
"RTN","PSGOEF1",22,0)
 F Q=1,3 K @(PSGOEEWF_Q_")") S %X="^PS(53.45,"_PSJSYSP_","_$S(Q=1:2,1:1)_",",%Y=PSGOEEWF_Q_"," K @(PSGOEEWF_Q_")") D %XY^%RCR W "."  ;MOU-0100-30945
"RTN","PSGOEF1",23,0)
 ;;I $O(^PS(53.45,PSJSYSP,2,0)) S %X="^PS(53.45,"_PSJSYSP_",2,",%Y="^PS(53.1,"_+PSGORD_",1," D %XY^%RCR W "." S $P(^PS(53.1,+PSGORD,1,0),"^",2)=53.11
"RTN","PSGOEF1",24,0)
 S PSGND=$G(^PS(53.1,+PSGORD,0)),X=$P(PSGND,U,24)
"RTN","PSGOEF1",25,0)
 I $S(X="R":1,+$G(^PS(55,PSGP,5.1))>PSGDT:0,1:X'="E") S X=$G(^PS(53.1,DA,2)) D ENWALL^PSGNE3(+$P(X,U,2),+$P(X,U,4),PSGP)
"RTN","PSGOEF1",26,0)
 I $P(PSGND,U,24)="R",$P(PSGND,U,25),PSGSD<$P($G(^PS(55,PSGP,5,+$P(PSGND,U,25),2)),U,4) D
"RTN","PSGOEF1",27,0)
 .K DA,DR S DA(1)=PSGP,DA=+$P(PSGND,U,25),DIE="^PS(55,"_PSGP_",5,",DR="34////"_PSGFD_";25////"_$P($G(^PS(55,PSGP,5,+$P(PSGND,U,25),2)),U,4)
"RTN","PSGOEF1",28,0)
 .D ^DIE,EN1^PSJHL2(PSGP,"XX",$P(PSGND,U,25))
"RTN","PSGOEF1",29,0)
 S $P(^PS(53.1,+PSGORD,.2),U,2)=PSGDO,$P(^PS(53.1,+PSGORD,2),U,5)=PSGAT S:$G(PSGS0XT) $P(^(2),U,6)=PSGS0XT
"RTN","PSGOEF1",30,0)
 I 'PSGOEAV D NEWNVAL^PSGAL5(PSGORD,$S(+PSJSYSU=3:22005,1:22000))
"RTN","PSGOEF1",31,0)
 I PSGOEAV,+PSJSYSU=3 D VFY^PSGOEV Q
"RTN","PSGOEF1",32,0)
 I PSGOEAV,$G(PSJRNF) D VFY^PSGOEV
"RTN","PSGOEF1",33,0)
 Q
"RTN","PSGOEF1",34,0)
 ;
"RTN","PSGOEF1",35,0)
ENDRG(PSGPDRG,DRGDA) ; enter dispense drug for order w/o one
"RTN","PSGOEF1",36,0)
 D NOW^%DTC K DRG S (DRG,Q)=0 F  S Q=$O(^PSDRUG("ASP",+PSGPDRG,Q)) Q:'Q  I $D(^PSDRUG(Q,0)),$P($G(^(2)),U,3)["U" S X=+$G(^("I")) I 'X!(X>%) S DRG=DRG+1,DRG(DRG)=Q_"^"_^(0)
"RTN","PSGOEF1",37,0)
 I 'DRG W $C(7),!!,"No dispense drugs were found for this order's Orderable Item." K DIR S DIR(0)="E" D ^DIR K DIR S CHK=-1 Q
"RTN","PSGOEF1",38,0)
 S:DRG=1 Y(0)=1
"RTN","PSGOEF1",39,0)
 I DRG>1 D  I 'Y S DRG=0,CHK=-1 Q
"RTN","PSGOEF1",40,0)
 .W !!,"CHOOSE FROM:" F Q=1:1:DRG W !?3,$J(Q,3),". ",$P(DRG(Q),"^",2)
"RTN","PSGOEF1",41,0)
 .N DIR S DIR(0)="LAO^1:"_DRG_U_"I X#1!(X[""."") K X",DIR("A")="Select DISPENSE DRUG(S) for this order: " S:DRG=1 DIR("B")=1 S DIR("?")="^D DRGH^PSGOEF1" W ! D ^DIR
"RTN","PSGOEF1",42,0)
 ;
"RTN","PSGOEF1",43,0)
 I 'DRGDA S ^PS(53.45,PSJSYSP,2,0)="^53.4502P"
"RTN","PSGOEF1",44,0)
 S DRG=Y(0) F Q1=1:1 S Q2=$P(DRG,",",Q1) Q:'Q2  D
"RTN","PSGOEF1",45,0)
 .I '$$ENCKDD(PSGP,+DRG(Q2),Q1) S DRGDA=DRGDA+1,^PS(53.45,PSJSYSP,2,DRGDA,0)=+DRG(Q2),^PS(53.45,PSJSYSP,2,"B",+DRG(Q2),DRGDA)="",DA(1)=PSJSYSP,DA=DRGDA,DIE="^PS(53.45,"_PSJSYSP_",2,",DR=".02//1" W !!,$P(DRG(Q2),U,2) D ^DIE
"RTN","PSGOEF1",46,0)
 .;I DRGDA=0,'$$ENCKDD(PSGP,+DRG(Q2)) S DRGDA=DRGDA+1,^PS(53.45,PSJSYSP,2,DRGDA,0)=+DRG(Q2),^PS(53.45,PSJSYSP,2,"B",+DRG(Q2),DRGDA)="",DA(1)=PSJSYSP,DA=DRGDA,DIE="^PS(53.45,"_PSJSYSP_",2,",DR=.02 W !!,$P(DRG(Q2),U,2) D ^DIE
"RTN","PSGOEF1",47,0)
 S PSGDI=0
"RTN","PSGOEF1",48,0)
 S:DRGDA>0 $P(^PS(53.45,PSJSYSP,2,0),"^",3,4)=DRGDA_"^"_DRGDA,CHK=0 Q
"RTN","PSGOEF1",49,0)
 Q
"RTN","PSGOEF1",50,0)
 ;
"RTN","PSGOEF1",51,0)
DRGH ;
"RTN","PSGOEF1",52,0)
 W !!?2,"This order must have at least one dispense drug before it can be completed.",!,"Select one or more items listed.  For each item selected, you will be",!,"prompted for the UNITS PER DOSE for the item."
"RTN","PSGOEF1",53,0)
 Q
"RTN","PSGOEF1",54,0)
ENIVUD(PSJORD)     ;
"RTN","PSGOEF1",55,0)
 ;Determine if user should be prompted to transfer the order to IV.
"RTN","PSGOEF1",56,0)
 ;  INPUT: PSJORD - IEN in 53.1_order location code.
"RTN","PSGOEF1",57,0)
 ; OUTPUT: 1 - Order not transferred, process as always.
"RTN","PSGOEF1",58,0)
 ;         0 - User selected to transfer order and quit upon return.
"RTN","PSGOEF1",59,0)
 ;
"RTN","PSGOEF1",60,0)
 NEW DIR,DIRUT,PSJCOI,PSJND0,Y
"RTN","PSGOEF1",61,0)
 S PSJND0=$G(^PS(53.1,+PSJORD,0)),PSJCOI=+$G(^PS(53.1,+PSJORD,.2))
"RTN","PSGOEF1",62,0)
 I $P(PSJND0,U,4)="F" Q 1
"RTN","PSGOEF1",63,0)
 D FULL^VALM1
"RTN","PSGOEF1",64,0)
 I $S($P(PSJND0,U,24)="R":1,1:'$P(PSJND0,U,13)) Q 1
"RTN","PSGOEF1",65,0)
 S DIR(0)="SAB^I:IV;U:UNIT DOSE",DIR("A")="COMPLETE THIS ORDER AS IV OR UNIT DOSE? ",DIR("B")=$S($P(PSJND0,U,4)="I":"IV",1:"UNIT DOSE")
"RTN","PSGOEF1",66,0)
 S DIR("??")="^D THELP^PSGOEF1("""_$S(DIR("B")="IV":"UNIT DOSE",1:"IV")_""","_PSJCOI_")"
"RTN","PSGOEF1",67,0)
 D ^DIR K DIR
"RTN","PSGOEF1",68,0)
 I $D(DTOUT)!$D(DUOUT) Q 0
"RTN","PSGOEF1",69,0)
 I Y="I" D  Q 0
"RTN","PSGOEF1",70,0)
 . I +PSJSYSU=1,'$G(PSJIRNF) W !!!!,"You need the PSJI RNFINISH key to finish this order as IV!" D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSGOEF1",71,0)
 . D IV^PSJLIFNI(PSJORD,PSJCOI)
"RTN","PSGOEF1",72,0)
 I Y="U" D  Q 0
"RTN","PSGOEF1",73,0)
 . I +PSJSYSU=1,'$G(PSJRNF) W !!!!,"You need the PSJ RNFINISH key to finish this order as Unit Dose!" D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSGOEF1",74,0)
 . I $G(PSJITECH),($P(PSJSYSU,";",3)'=3) W !!!!,"You may not finish this order as Unit Dose!" D PAUSE^VALM1 S VALMBCK="R" Q
"RTN","PSGOEF1",75,0)
 . D ENUD^PSGOEF1(PSJORD,PSJCOI)
"RTN","PSGOEF1",76,0)
 Q 1
"RTN","PSGOEF1",77,0)
 ;
"RTN","PSGOEF1",78,0)
ENUD(PSJORD,PSGPD)       ;
"RTN","PSGOEF1",79,0)
 N PSJTUD S PSJTUD=1,DFN=$P($G(^PS(53.1,+PSJORD,0)),U,15)
"RTN","PSGOEF1",80,0)
 K DRG,DRGOC,DRGT,DRGTMP,ERR,ON,ON55,P,PSJSTAR,PSJTIM,UL80
"RTN","PSGOEF1",81,0)
 D DISACTIO^PSJOE(DFN,PSJORD,$G(PSJPNV)) S VALMBCK="Q"
"RTN","PSGOEF1",82,0)
 Q
"RTN","PSGOEF1",83,0)
THELP(PKG,COI) ;
"RTN","PSGOEF1",84,0)
 W !,"Choose the package this order should be completed as a IV or Unit Dose order",!
"RTN","PSGOEF1",85,0)
 Q
"RTN","PSGOEF1",86,0)
 ;
"RTN","PSGOEF1",87,0)
ENCKDD(PSGP,PSJDRG,Q1) ;
"RTN","PSGOEF1",88,0)
 N DRG
"RTN","PSGOEF1",89,0)
 S PSGORQF=0
"RTN","PSGOEF1",90,0)
 I Q1=1 D ENDDC^PSGSICHK(PSGP,PSJDRG) Q PSGORQF
"RTN","PSGOEF1",91,0)
 N INTERVEN,PSJDDI,PSJIREQ,PSJRXREQ,PSJDD,PSGORQF,PSJDD
"RTN","PSGOEF1",92,0)
 S Y=1,(PSJIREQ,PSJRXREQ,INTERVEN,X)="",PSJDD=PSJDRG
"RTN","PSGOEF1",93,0)
 D IVSOL^PSGSICHK
"RTN","PSGOEF1",94,0)
 Q $G(PSGORQF)
"RTN","PSJ0186")
0^5^B13531411^n/a
"RTN","PSJ0186",1,0)
PSJ0186 ;BIR/JLC - FIND ORDERS WITH NULL SI / OPI ;09/14/2006
"RTN","PSJ0186",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**186**;16 DE7 97
"RTN","PSJ0186",3,0)
 ;
"RTN","PSJ0186",4,0)
 ;Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSJ0186",5,0)
 ;Reference to ^PS(55 supported by DBIA 2191.
"RTN","PSJ0186",6,0)
 ;Reference to ^XPD(9.7 supported by DBIA 2197.
"RTN","PSJ0186",7,0)
 ;
"RTN","PSJ0186",8,0)
EN ; Select device and determine format
"RTN","PSJ0186",9,0)
 I $G(DUZ)="" W !,"Your DUZ is not defined.  It must be defined to run this routine." Q
"RTN","PSJ0186",10,0)
 N F1,F2,ZTDESC,XSAVE,ZTRTN
"RTN","PSJ0186",11,0)
 Q:$$SELDEV^PSJMUTL
"RTN","PSJ0186",12,0)
 W:'$D(IO("Q")) !,"this may take a while..."
"RTN","PSJ0186",13,0)
F1 ;determine whether print format or comma-delimited
"RTN","PSJ0186",14,0)
 W !!,"(P)rint format or (C)omma-delimited output: " R F1:60 W "  " I F1="" G EN
"RTN","PSJ0186",15,0)
 I F1="^" G EXIT
"RTN","PSJ0186",16,0)
 I F1'="P",F1'="C" W "Enter P or C" G F1
"RTN","PSJ0186",17,0)
F2 W !!,"(O)nly active or (A)ll orders: " R F2:60 W "  " I F2="" G F1
"RTN","PSJ0186",18,0)
 I F2="^" G EXIT
"RTN","PSJ0186",19,0)
 I F2'="O",F2'="A" D  G F2
"RTN","PSJ0186",20,0)
 . W "Enter O for a list of active or recently expired orders only"
"RTN","PSJ0186",21,0)
 . W !?10,"Enter A for all orders since PSB*3*13 was installed."
"RTN","PSJ0186",22,0)
 I $D(IO("Q")) D  G EXIT
"RTN","PSJ0186",23,0)
 . N I,A
"RTN","PSJ0186",24,0)
 . S ZTDESC="Search for Special Instruction / Other Print Info Isses (Sort)"
"RTN","PSJ0186",25,0)
 . S XSAVE="F1;F2"
"RTN","PSJ0186",26,0)
 . S ZTRTN="START^PSJ0186"
"RTN","PSJ0186",27,0)
 . F I=1:1 S A=$P(XSAVE,";",I) Q:A=""  S ZTSAVE(A)=""
"RTN","PSJ0186",28,0)
 . D ^%ZTLOAD
"RTN","PSJ0186",29,0)
 D START
"RTN","PSJ0186",30,0)
 Q
"RTN","PSJ0186",31,0)
START ;find potential problem orders
"RTN","PSJ0186",32,0)
 K ^TMP("PSJ0186",$J) N START,S1,DFN,ORDER,A,B,A0,A2,AD2,I,B,RDT,%,FIRST,PG,Y,ZTSAVE
"RTN","PSJ0186",33,0)
 D NOW^%DTC S RDT=$E(%,4,5)_"/"_$E(%,6,7)_"/"_($E(%,1,3)+1700),FIRST=%
"RTN","PSJ0186",34,0)
 I F2="A" S A=$O(^XPD(9.7,"B","PSB*3.0*13","")) I A]"" S FIRST=$P($G(^XPD(9.7,A,1)),"^") I FIRST="" S FIRST=%
"RTN","PSJ0186",35,0)
 S S1=FIRST-8
"RTN","PSJ0186",36,0)
 F  S S1=$O(^PS(55,"AUD",S1)) Q:'S1  D
"RTN","PSJ0186",37,0)
 . S DFN=0
"RTN","PSJ0186",38,0)
 . F  S DFN=$O(^PS(55,"AUD",S1,DFN)) Q:'DFN  D
"RTN","PSJ0186",39,0)
 .. S ORDER=0
"RTN","PSJ0186",40,0)
 .. F  S ORDER=$O(^PS(55,"AUD",S1,DFN,ORDER)) Q:'ORDER  D
"RTN","PSJ0186",41,0)
 ... Q:'$D(^PS(55,DFN,5,ORDER,6))  S A=$G(^(6)) Q:$P(A,"^",2)'=1
"RTN","PSJ0186",42,0)
 ... S B=$P(A,"^") I B=""!(B?1." ") D
"RTN","PSJ0186",43,0)
 .... S A0=$G(^PS(55,DFN,5,ORDER,0)),AD2=$G(^(.2)),A2=$G(^(2))
"RTN","PSJ0186",44,0)
 .... S ^TMP("PSJ0186",$J,DFN,"UD",ORDER)=$P(A2,"^",2)_"^"_$P(A2,"^",4)_"^"_$P(AD2,"^")_"^"_$P(A0,"^",9)
"RTN","PSJ0186",45,0)
 S S1=FIRST-8 F  S S1=$O(^PS(55,"AIV",S1)) Q:'S1  D
"RTN","PSJ0186",46,0)
 . S DFN=0
"RTN","PSJ0186",47,0)
 . F  S DFN=$O(^PS(55,"AIV",S1,DFN)) Q:'DFN  D
"RTN","PSJ0186",48,0)
 .. S ORDER=0
"RTN","PSJ0186",49,0)
 .. F  S ORDER=$O(^PS(55,"AIV",S1,DFN,ORDER)) Q:'ORDER  D
"RTN","PSJ0186",50,0)
 ... Q:'$D(^PS(55,DFN,"IV",ORDER,3))  S A=$G(^(3)) Q:$P(A,"^",2)'=1
"RTN","PSJ0186",51,0)
 ... S B=$P(A,"^") I B=""!(B?1." ") D
"RTN","PSJ0186",52,0)
 .... S A0=$G(^PS(55,DFN,"IV",ORDER,0)),AD2=$G(^(.2))
"RTN","PSJ0186",53,0)
 .... S ^TMP("PSJ0186",$J,DFN,"IV",ORDER)=$P(A0,"^",2)_"^"_$P(A0,"^",3)_"^"_$P(AD2,"^")_"^"_$P(A0,"^",17)
"RTN","PSJ0186",54,0)
 S (DFN,PG)=0 U IO I F1'="C" D HDR
"RTN","PSJ0186",55,0)
 F  S DFN=$O(^TMP("PSJ0186",$J,DFN)) Q:'DFN  D
"RTN","PSJ0186",56,0)
 . F I="UD","IV" D
"RTN","PSJ0186",57,0)
 .. S ORDER=0
"RTN","PSJ0186",58,0)
 .. F  S ORDER=$O(^TMP("PSJ0186",$J,DFN,I,ORDER)) Q:ORDER=""  S A=^(ORDER) D
"RTN","PSJ0186",59,0)
 ... S B=^DPT(DFN,0)
"RTN","PSJ0186",60,0)
 ... I F1="P" D
"RTN","PSJ0186",61,0)
 .... W $E($P(B,"^"),1,25),?28,$E($P(B,"^",9),6,9),?34,$E($G(^DPT(DFN,.1)),1,10),?45
"RTN","PSJ0186",62,0)
 .... S B=$P(A,"^") W $E(B,4,5),"/",$E(B,6,7),"/",$E(B,1,3)+1700,?57
"RTN","PSJ0186",63,0)
 .... S B=$P(A,"^",2) W $E(B,4,5),"/",$E(B,6,7),"/",$E(B,1,3)+1700,"  "
"RTN","PSJ0186",64,0)
 .... I $Y+1>IOSL D HDR
"RTN","PSJ0186",65,0)
 .... W $P(A,"^",4)," (",$S(I="UD":"UD",1:"IV"),") ",$P($G(^PS(50.7,$P(A,"^",3),0)),"^"),!
"RTN","PSJ0186",66,0)
 ... I F1="C" D
"RTN","PSJ0186",67,0)
 .... W $P(B,"^"),",",$E($P(B,"^",9),6,9),",",$G(^DPT(DFN,.1)),","
"RTN","PSJ0186",68,0)
 .... S B=$P(A,"^") W $E(B,4,5),"/",$E(B,6,7),"/",$E(B,1,3)+1700,","
"RTN","PSJ0186",69,0)
 .... S B=$P(A,"^",2) W $E(B,4,5),"/",$E(B,6,7),"/",$E(B,1,3)+1700,","
"RTN","PSJ0186",70,0)
 .... W $P(A,"^",4),",(",$S(I="UD":"UD",1:"IV"),"),",$P($G(^PS(50.7,$P(A,"^",3),0)),"^"),!
"RTN","PSJ0186",71,0)
 I '$D(^TMP("PSJ0186",$J)) W "Nothing to print",!
"RTN","PSJ0186",72,0)
EXIT D ^%ZISC Q
"RTN","PSJ0186",73,0)
HDR S PG=PG+1 W:$Y @IOF W RDT,?32,"SI/OPI RESEARCH",?83,"PAGE: ",PG,!!
"RTN","PSJ0186",74,0)
 W "PATIENT NAME",?28,"SSN",?34,"WARD",?45,"START DATE",?57,"STOP DATE",?69,"ORDER INFO",!!
"RTN","PSJ0186",75,0)
 Q
"RTN","PSJBCMA")
0^2^B63223587^B62444725
"RTN","PSJBCMA",1,0)
PSJBCMA ;BIR/MV-RETURN INPATIENT ACTIVE MEDS (CONDENSED) ;16 Mar 99 / 10:13 AM
"RTN","PSJBCMA",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**32,41,46,57,63,66,56,69,58,81,91,104,111,112,186**;16 DEC 97
"RTN","PSJBCMA",3,0)
 ;
"RTN","PSJBCMA",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSJBCMA",5,0)
 ; Reference to ^PS(51 is supported by DBIA 2176.
"RTN","PSJBCMA",6,0)
 ; Reference to ^PS(51.1 is supported by DIBA 2177.
"RTN","PSJBCMA",7,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSJBCMA",8,0)
 ; Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSJBCMA",9,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSJBCMA",10,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBCMA",11,0)
 ; Reference to ^PSDRUG is supported by DBIA 2192.
"RTN","PSJBCMA",12,0)
 ; Usage of this routine by BCMA is supported by DBIA 2828.
"RTN","PSJBCMA",13,0)
 ;
"RTN","PSJBCMA",14,0)
EN(DFN,BDT,OTDATE)         ; return condensed list of inpat meds
"RTN","PSJBCMA",15,0)
 NEW CNT,DN,F,FON,ON,PST,WBDT,X,X1,X2,Y,%
"RTN","PSJBCMA",16,0)
 D:+$G(DFN) ORDER
"RTN","PSJBCMA",17,0)
 I '$D(^TMP("PSJ",$J,1,0)) S ^(0)=-1
"RTN","PSJBCMA",18,0)
 K PSJINX
"RTN","PSJBCMA",19,0)
 Q
"RTN","PSJBCMA",20,0)
ORDER ;Loop thru the orders.
"RTN","PSJBCMA",21,0)
 I '+$G(BDT) D NOW^%DTC S BDT=%
"RTN","PSJBCMA",22,0)
 I BDT'["." S BDT=BDT_".0001"
"RTN","PSJBCMA",23,0)
 S PSJINX=0
"RTN","PSJBCMA",24,0)
 ;* U/D orders
"RTN","PSJBCMA",25,0)
 S F="^PS(55,DFN,5,",WBDT=BDT
"RTN","PSJBCMA",26,0)
 F  S WBDT=$O(^PS(55,DFN,5,"AUS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",27,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,5,"AUS",WBDT,ON)) Q:'ON  S FON=ON_"U",PSJON(FON)="" D UDVAR
"RTN","PSJBCMA",28,0)
 ;* IV orders
"RTN","PSJBCMA",29,0)
 S F="^PS(55,DFN,""IV"",",WBDT=BDT
"RTN","PSJBCMA",30,0)
 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",31,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  S FON=ON_"V",PSJON(FON)="" D IVVAR
"RTN","PSJBCMA",32,0)
 ;* Pending orders
"RTN","PSJBCMA",33,0)
 S F="^PS(53.1,"
"RTN","PSJBCMA",34,0)
 F PST="P","N" F ON=0:0 S ON=$O(^PS(53.1,"AS",PST,DFN,ON)) Q:'ON  D
"RTN","PSJBCMA",35,0)
 . S FON=ON_"P"
"RTN","PSJBCMA",36,0)
 . S X=$P($G(^PS(53.1,+ON,0)),U,4) D @$S(X="F":"IVVAR",1:"UDVAR")
"RTN","PSJBCMA",37,0)
 ;* One-time orders
"RTN","PSJBCMA",38,0)
 ;* When a one-time order is found, check against PSJON(FON) array to
"RTN","PSJBCMA",39,0)
 ;* make sure no duplicate orders is return on ^TMP.
"RTN","PSJBCMA",40,0)
 I '+$G(OTDATE) D NOW^%DTC S X1=$E(%,1,12),X2=-30 D C^%DTC S OTDATE=X
"RTN","PSJBCMA",41,0)
 I OTDATE'["." S OTDATE=OTDATE_".0001"
"RTN","PSJBCMA",42,0)
 Q:BDT'>OTDATE
"RTN","PSJBCMA",43,0)
 S F="^PS(55,DFN,5,",WBDT=OTDATE
"RTN","PSJBCMA",44,0)
 F  S WBDT=$O(^PS(55,DFN,5,"AU","O",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",45,0)
 .  F ON=0:0 S ON=$O(^PS(55,DFN,5,"AU","O",WBDT,ON)) Q:'ON  D
"RTN","PSJBCMA",46,0)
 .. S FON=ON_"U" D:'$D(PSJON(FON)) UDVAR
"RTN","PSJBCMA",47,0)
 S F="^PS(55,DFN,""IV"",",WBDT=OTDATE
"RTN","PSJBCMA",48,0)
 F  S WBDT=$O(^PS(55,DFN,"IV","AIS",WBDT)) Q:'WBDT  D
"RTN","PSJBCMA",49,0)
 . F ON=0:0 S ON=$O(^PS(55,DFN,"IV","AIS",WBDT,ON)) Q:'ON  D
"RTN","PSJBCMA",50,0)
 .. S X=$P($G(^PS(55,DFN,"IV",ON,0)),U,9)
"RTN","PSJBCMA",51,0)
 .. I X]"",$$ONE(DFN,ON_"V",X,$P(X,"^",2),$P(X,"^",3))="O" D
"RTN","PSJBCMA",52,0)
 ... S FON=ON_"V" D:'$D(PSJON(FON)) IVVAR
"RTN","PSJBCMA",53,0)
 K PSJON
"RTN","PSJBCMA",54,0)
 Q
"RTN","PSJBCMA",55,0)
 ;
"RTN","PSJBCMA",56,0)
UDVAR ;* Set ^TMP for Unit dose & Pending orders
"RTN","PSJBCMA",57,0)
 D UDPEND Q:'$$CLINICS($G(CLINIC)) 
"RTN","PSJBCMA",58,0)
 D TMP
"RTN","PSJBCMA",59,0)
 ;* Setup Dispense drug for ^TMP
"RTN","PSJBCMA",60,0)
 S CNT=0 D NOW^%DTC
"RTN","PSJBCMA",61,0)
 F X=0:0 S X=$O(@(F_ON_",1,"_X_")")) Q:'X  D
"RTN","PSJBCMA",62,0)
 . S PSJDD=@(F_ON_",1,"_X_",0)") I $P(PSJDD,"^",3)]"",$P(PSJDD,"^",3)'>% Q
"RTN","PSJBCMA",63,0)
 . S CNT=CNT+1
"RTN","PSJBCMA",64,0)
 . S ^TMP("PSJ",$J,PSJINX,700,CNT,0)=+PSJDD_U_$P($G(^PSDRUG(+PSJDD,0)),U)_U_$S((FON["U")&($P(PSJDD,U,2)=""):1,(FON["U")&($E($P(PSJDD,U,2))="."):"0"_$P(PSJDD,U,2),1:$P(PSJDD,U,2))_U_$P(PSJDD,U,3)
"RTN","PSJBCMA",65,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,700,0)=CNT
"RTN","PSJBCMA",66,0)
 K PSJ,PSJDD
"RTN","PSJBCMA",67,0)
 Q
"RTN","PSJBCMA",68,0)
IVVAR ;* Set variables for IV and pending orders
"RTN","PSJBCMA",69,0)
 NEW ND,X,Y
"RTN","PSJBCMA",70,0)
 I FON["P" D UDPEND Q:'$$CLINICS(CLINIC)  S PSJ("INFRATE")=$P($G(^PS(53.1,ON,8)),U,5)
"RTN","PSJBCMA",71,0)
 I FON["V" D  Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",72,0)
 . S X=$G(^PS(55,DFN,"IV",ON,0)),CLINIC=$G(^("DSS")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",73,0)
 . S PSJ("STARTDT")=$P(X,U,2),PSJ("STOPDT")=$P(X,U,3)
"RTN","PSJBCMA",74,0)
 . S PSJ("INFRATE")=$P(X,U,8),PSJ("SCHD")=$P(X,U,9)
"RTN","PSJBCMA",75,0)
 . S PSJ("ADM")=$P(X,U,11),PSJ("AUTO")=$P(X,U,12),PSJ("STATUS")=$P(X,U,17)
"RTN","PSJBCMA",76,0)
 . S PSJ("IVTYPE")=$P(X,U,4),PSJ("INSYR")=$P(X,U,5)
"RTN","PSJBCMA",77,0)
 . S PSJ("CPRS")=$P(X,U,21),PSJ("CHEMO")=$P(X,U,23)
"RTN","PSJBCMA",78,0)
 . S X=$G(^PS(55,DFN,"IV",ON,.2))
"RTN","PSJBCMA",79,0)
 . S PSJ("DO")="",PSJ("MR")=$P(X,U,3)
"RTN","PSJBCMA",80,0)
 . S PSJ("OI")=+X
"RTN","PSJBCMA",81,0)
 . S X=$G(^PS(55,DFN,"IV",ON,2))
"RTN","PSJBCMA",82,0)
 . S PSJ("PREV")=$P(X,U,5) I PSJ("PREV")["V",(+PSJ("PREV")=+ON) S PSJ("PREV")=""
"RTN","PSJBCMA",83,0)
 . S PSJ("FOLLOW")=$P(X,U,6),PSJ("RFO")=$P(X,U,9) I PSJ("FOLLOW")["V",(+PSJ("FOLLOW")=+ON) S (PSJ("FOLLOW"),PSJ("RFO"))=""
"RTN","PSJBCMA",84,0)
 . S PSJ("SIOPI")=$S($P($G(^PS(55,DFN,"IV",+ON,3)),"^",2)&($P($G(^PS(55,DFN,"IV",+ON,3)),"^")'=""):"!",1:"")_$P($G(^(3)),"^")
"RTN","PSJBCMA",85,0)
 . N SCHD S SCHD=PSJ("SCHD")
"RTN","PSJBCMA",86,0)
 . S PSJ("STC")=$$ONE(DFN,ON_"V",SCHD,PSJ("STARTDT"),PSJ("STOPDT"))
"RTN","PSJBCMA",87,0)
 . I PSJ("STC")=""!(PSJ("STC")="C") S PSJ("STC")=$S(SCHD["PRN":"P",1:"C")
"RTN","PSJBCMA",88,0)
 . I PSJ("STC")="C" S PSJ("STC")=$S(SCHD["ON CALL":"OC",SCHD["ON-CALL":"OC",SCHD["ONCALL":"OC",1:"C")
"RTN","PSJBCMA",89,0)
 D TMP
"RTN","PSJBCMA",90,0)
 S CNT=0
"RTN","PSJBCMA",91,0)
 F X=0:0 S X=$O(@(F_ON_",""AD"","_X_")")) Q:'X  D
"RTN","PSJBCMA",92,0)
 . S ND=$G(@(F_ON_",""AD"","_X_",0)")),DN=$G(^PS(52.6,+ND,0)) ;,AOINAME=$$OIDF^PSJLMUT1(+$P(DN,U,11)) I AOINAME["NOTFOUND" S AOINAME=""
"RTN","PSJBCMA",93,0)
 . ;S AOIDF=$$GET1^DIQ(50.7,+$P(DN,U,11),.02) I AOINAME="" S AOIDF=""
"RTN","PSJBCMA",94,0)
 . S CNT=CNT+1,^TMP("PSJ",$J,PSJINX,850,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(ND,U,3) ;_U_U_$P(DN,U,11)_U_AOINAME_U_AOIDF
"RTN","PSJBCMA",95,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,850,0)=CNT,CNT=0
"RTN","PSJBCMA",96,0)
 F X=0:0 S X=$O(@(F_ON_",""SOL"","_X_")")) Q:'X  D
"RTN","PSJBCMA",97,0)
 . S ND=$G(@(F_ON_",""SOL"","_X_",0)")),DN=$G(^PS(52.7,+ND,0)) ;,SOINAME=$$OIDF^PSJLMUT1(+$P(DN,U,11)) I SOINAME["NOTFOUND" S SOINAME=""
"RTN","PSJBCMA",98,0)
 . ;S SOIDF=$$GET1^DIQ(50.7,+$P(DN,U,11),.02) I SOINAME="" S SOIDF=""
"RTN","PSJBCMA",99,0)
 . S CNT=CNT+1,^TMP("PSJ",$J,PSJINX,950,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(DN,U,4) ;_U_U_$P(DN,U,11)_U_SOINAME_U_SOIDF
"RTN","PSJBCMA",100,0)
 S:CNT ^TMP("PSJ",$J,PSJINX,950,0)=CNT
"RTN","PSJBCMA",101,0)
 K PSJ
"RTN","PSJBCMA",102,0)
 S X1=0
"RTN","PSJBCMA",103,0)
 F  S X1=$O(^PS(55,DFN,"IVBCMA",X1)) Q:'X1  D
"RTN","PSJBCMA",104,0)
 . S XX=$G(^PS(55,DFN,"IVBCMA",X1,0)) Q:ON'=$P(XX,"^",2)  S PSJBCID=$P(XX,"^"),X2=0
"RTN","PSJBCMA",105,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"AD",X2)) Q:'X2  S X=^(X2,0),^TMP("PSJ",$J,PSJINX,800,PSJBCID,I)=+X_"^"_$S($D(^PS(52.6,+X,0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA",106,0)
 . I I>1 S ^TMP("PSJ",$J,PSJINX,800,PSJBCID,0)=I-1
"RTN","PSJBCMA",107,0)
 . S X2=0
"RTN","PSJBCMA",108,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"SOL",X2)) Q:'X2  S X=^(X2,0),^TMP("PSJ",$J,PSJINX,900,PSJBCID,I)=$P(X,"^")_"^"_$S($D(^PS(52.7,$P(X,"^"),0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA",109,0)
 . I I>1 S ^TMP("PSJ",$J,PSJINX,900,PSJBCID,0)=I-1
"RTN","PSJBCMA",110,0)
 Q
"RTN","PSJBCMA",111,0)
UDPEND ;
"RTN","PSJBCMA",112,0)
 S X=$G(@(F_ON_",0)")) I $P(F,",")[53.1 S CLINIC=$G(@(F_ON_",""DSS"")")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",113,0)
 I $P(F,",")[55 S CLINIC=$G(@(F_ON_",8)")) Q:'$$CLINICS(CLINIC)
"RTN","PSJBCMA",114,0)
 S PSJ("MR")=$P(X,U,3),PSJ("SM")=$P(X,U,5),PSJ("HSM")=$P(X,U,6)
"RTN","PSJBCMA",115,0)
 S PSJ("ST")=$P(X,U,7),PSJ("STATUS")=$P(X,U,9)
"RTN","PSJBCMA",116,0)
 S PSJ("CPRS")=$P(X,U,21),PSJ("PREV")=$P(X,U,25),PSJ("FOLLOW")=$P(X,U,26),PSJ("RFO")=$P(X,U,27)
"RTN","PSJBCMA",117,0)
 S:FON["U" PSJ("NGIVEN")=$P(X,U,22)
"RTN","PSJBCMA",118,0)
 S X=$G(@(F_ON_",.2)"))
"RTN","PSJBCMA",119,0)
 S PSJ("DO")=$P(X,U,2)
"RTN","PSJBCMA",120,0)
 S PSJ("OI")=+X
"RTN","PSJBCMA",121,0)
 S X=$G(@(F_ON_",2)"))
"RTN","PSJBCMA",122,0)
 S PSJ("SCHD")=$P(X,U),PSJ("STARTDT")=$P(X,U,2)
"RTN","PSJBCMA",123,0)
 S PSJ("STOPDT")=$P(X,U,4),PSJ("ADM")=$P(X,U,5)
"RTN","PSJBCMA",124,0)
 S X=$G(@(F_ON_",4)"))
"RTN","PSJBCMA",125,0)
 S PSJ("AUTO")=$P(X,U,11)
"RTN","PSJBCMA",126,0)
 ;the naked reference on the line below refers to the full reference created by indirect reference to F_ON, where F may refer to ^PS(53.1 or the IV or UD multiple ^PS(55
"RTN","PSJBCMA",127,0)
 S PSJ("SIOPI")=$S($P($G(@(F_ON_",6)")),"^",2)&($P($G(@(F_ON_",6)")),"^")'=""):"!",1:"")_$$ENSET($P($G(^(6)),"^"))
"RTN","PSJBCMA",128,0)
 D SIOPI
"RTN","PSJBCMA",129,0)
 S PSJ("STC")=PSJ("ST")
"RTN","PSJBCMA",130,0)
 I PSJ("ST")="R"!(PSJ("ST")="C") S PSJ("STC")=$S(PSJ("SCHD")["PRN":"P","^ONCALL^ON-CALL^ON CALL^"[("^"_PSJ("SCHD")_"^"):"OC",$$ONE(DFN,FON,PSJ("SCHD"))="O":"O",1:"C")
"RTN","PSJBCMA",131,0)
 Q 
"RTN","PSJBCMA",132,0)
TMP ;* Setup ^TMP that have common fields between IV and U/D
"RTN","PSJBCMA",133,0)
 S PSJINX=PSJINX+1
"RTN","PSJBCMA",134,0)
 S PSJ("OINAME")=$$OIDF^PSJLMUT1(+PSJ("OI")) I PSJ("OINAME")["NOT FOUND" S PSJ("OINAME")=""
"RTN","PSJBCMA",135,0)
 S PSJ("OIDF")=$$GET1^DIQ(50.7,+PSJ("OI"),.02)
"RTN","PSJBCMA",136,0)
 I PSJ("OINAME")="" S PSJ("OIDF")=""
"RTN","PSJBCMA",137,0)
 S PSJ("MRABB")=$P($G(^PS(51.2,+PSJ("MR"),0)),U,3)
"RTN","PSJBCMA",138,0)
 S ^TMP("PSJ",$J,PSJINX,0)=DFN_U_+ON_U_FON_U_PSJ("PREV")_U_PSJ("FOLLOW")_U_$G(PSJ("IVTYPE"))_U_$G(PSJ("INSYR"))_U_$G(PSJ("CHEMO"))_U_PSJ("CPRS")_U_$G(PSJ("RFO"))
"RTN","PSJBCMA",139,0)
 S ^TMP("PSJ",$J,PSJINX,1)=PSJ("MRABB")_U_PSJ("STC")_U_$G(PSJ("SCHD"))_U_PSJ("STARTDT")_U_PSJ("STOPDT")_U_PSJ("ADM")_U_PSJ("STATUS")_U_$G(PSJ("NGIVEN"))_U_$G(PSJ("ST"))_U_$G(PSJ("AUTO"))
"RTN","PSJBCMA",140,0)
 S ^TMP("PSJ",$J,PSJINX,2)=PSJ("DO")_U_$G(PSJ("INFRATE"))_U_$G(PSJ("SM"))_U_$G(PSJ("HSM"))
"RTN","PSJBCMA",141,0)
 S ^TMP("PSJ",$J,PSJINX,3)=PSJ("OI")_U_PSJ("OINAME")_U_PSJ("OIDF")
"RTN","PSJBCMA",142,0)
 S ^TMP("PSJ",$J,PSJINX,4)=PSJ("SIOPI")
"RTN","PSJBCMA",143,0)
 Q
"RTN","PSJBCMA",144,0)
SIOPI ; Use provider comments if order is pending and there is no SI
"RTN","PSJBCMA",145,0)
 NEW X,Y,Z
"RTN","PSJBCMA",146,0)
 I FON["P",(PSJ("SIOPI")=""),$O(^PS(53.1,+ON,12,0)) D
"RTN","PSJBCMA",147,0)
 . F X=0:0 S X=$O(^PS(53.1,+ON,12,X)) Q:'X  S Z=$G(^(X,0)) D
"RTN","PSJBCMA",148,0)
 .. S Y=$L(PSJ("SIOPI"))
"RTN","PSJBCMA",149,0)
 .. S:Y+$L(Z)'>179 PSJ("SIOPI")=PSJ("SIOPI")_Z_""
"RTN","PSJBCMA",150,0)
 . I Y+$L(Z)>179 S PSJ("SIOPI")="SEE PROVIDER COMMENTS"
"RTN","PSJBCMA",151,0)
 Q
"RTN","PSJBCMA",152,0)
ENSET(X) ; expands the SPECIAL INSTRUCTIONS field contained in X into Y
"RTN","PSJBCMA",153,0)
 N X1,X2,Y S Y=""
"RTN","PSJBCMA",154,0)
 F X1=1:1:$L(X," ") S X2=$P(X," ",X1) I X2]"" S Y=Y_$S($L(X2)>30:X2,'$D(^PS(51,+$O(^PS(51,"B",X2,0)),0)):X2,$P(^(0),"^",2)]""&$P(^(0),"^",4):$P(^(0),"^",2),1:X2)_" "
"RTN","PSJBCMA",155,0)
 S Y=$E(Y,1,$L(Y)-1)
"RTN","PSJBCMA",156,0)
 Q Y
"RTN","PSJBCMA",157,0)
ONE(DFN,ORD,SCH,START,STOP) ;determine if order is a one-time
"RTN","PSJBCMA",158,0)
 ; Input:  DFN - patient's internal entry number
"RTN","PSJBCMA",159,0)
 ;         ORD - order number to check (must contain U or V)
"RTN","PSJBCMA",160,0)
 ;         SCH - schedule text (required)
"RTN","PSJBCMA",161,0)
 ;         START - order start date (optional)
"RTN","PSJBCMA",162,0)
 ;         STOP - order stop date (optional)
"RTN","PSJBCMA",163,0)
 N X
"RTN","PSJBCMA",164,0)
 I $G(PSJ("PREV")),$G(PSJ("FOLLOW")) I +PSJ("PREV")=+PSJ("FOLLOW") S (PSJ("PREV"),PSJ("FOLLOW"))=""
"RTN","PSJBCMA",165,0)
 I $G(DFN)]"",$G(ORD)]"",ORD["U",$P(^PS(55,DFN,5,+ORD,0),"^",7)'="R" Q $P(^PS(55,DFN,5,+ORD,0),"^",7)
"RTN","PSJBCMA",166,0)
 I $G(SCH)="" Q ""
"RTN","PSJBCMA",167,0)
 I SCH="TODAY"!(SCH="ONCE")!(SCH="NOW")!(SCH="ONE TIME")!(SCH="ONETIME")!(SCH="ONE-TIME")!(SCH="1TIME")!(SCH="1 TIME")!(SCH="1-TIME")!(SCH="STAT") Q "O"
"RTN","PSJBCMA",168,0)
 I $D(^PS(51.1,"AC","PSJ",SCH)) S X=$O(^(SCH,"")) S X=$P(^PS(51.1,X,0),"^",5) Q $S(X="D":"C",1:X)
"RTN","PSJBCMA",169,0)
 I $G(START)]"",$G(STOP)]"",START=STOP Q "O"
"RTN","PSJBCMA",170,0)
 Q ""
"RTN","PSJBCMA",171,0)
CLINIC(CL) ;
"RTN","PSJBCMA",172,0)
 I $P(CL,"^",2)?7N!($P(CL,"^",2)?7N1".".N) Q 1
"RTN","PSJBCMA",173,0)
 Q 0
"RTN","PSJBCMA",174,0)
CLINICS(CL) ;
"RTN","PSJBCMA",175,0)
 Q:'$$CLINIC(CL) 1
"RTN","PSJBCMA",176,0)
 Q:'$D(^PS(53.46,"B",+CL)) 1
"RTN","PSJBCMA",177,0)
 N A
"RTN","PSJBCMA",178,0)
 S A=$O(^PS(53.46,"B",+CL,"")) Q:'A 1
"RTN","PSJBCMA",179,0)
 Q $P(^PS(53.46,A,0),"^",4)
"RTN","PSJBCMA1")
0^3^B59316594^B58665814
"RTN","PSJBCMA1",1,0)
PSJBCMA1 ;BIR/MV-RETURN INFORMATION FOR AN ORDER ;16 Mar 99 / 10:59 AM
"RTN","PSJBCMA1",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**32,41,46,57,63,66,56,58,81,91,104,186**;16 DEC 97
"RTN","PSJBCMA1",3,0)
 ;
"RTN","PSJBCMA1",4,0)
 ; Reference to ^PS(50.7 is supported by DBIA 2180.
"RTN","PSJBCMA1",5,0)
 ; Reference to ^PS(51.2 is supported by DBIA 2178.
"RTN","PSJBCMA1",6,0)
 ; Reference to ^PS(52.6 is supported by DBIA 1231.
"RTN","PSJBCMA1",7,0)
 ; Reference to ^PS(52.7 is supported by DBIA 2173.
"RTN","PSJBCMA1",8,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJBCMA1",9,0)
 ; Reference to ^PSDRUG is supported by DBIA 2192.
"RTN","PSJBCMA1",10,0)
 ; Reference to ^DIC is supported by DBIA 10006.
"RTN","PSJBCMA1",11,0)
 ; Reference to ^DIQ is supported by DBIA 2056.
"RTN","PSJBCMA1",12,0)
 ; Usage of this routine by BCMA is supported by DBIA 2829.
"RTN","PSJBCMA1",13,0)
 ;
"RTN","PSJBCMA1",14,0)
EN(DFN,ON,PSJTMP)         ; return detail data for Inpatient Meds.
"RTN","PSJBCMA1",15,0)
 NEW F,A
"RTN","PSJBCMA1",16,0)
 S PSJTMP=$S($G(PSJTMP)=1:"PSJ1",1:"PSJ")
"RTN","PSJBCMA1",17,0)
 I $G(ON)["U" S F="^PS(55,+$G(DFN),5,+ON" D:$D(@(F_")")) UDVAR
"RTN","PSJBCMA1",18,0)
 I $G(ON)["V" S F="^PS(55,+$G(DFN),""IV"",+ON" D:$D(@(F_")")) IVVAR
"RTN","PSJBCMA1",19,0)
 I $G(ON)["P" S F="^PS(53.1,+ON",X=$P($G(^PS(53.1,+ON,0)),U,4) D:$D(@(F_")")) @$S(X="F":"IVVAR",1:"UDVAR")
"RTN","PSJBCMA1",20,0)
 I '$D(^TMP(PSJTMP,$J,0)) S ^(0)=-1
"RTN","PSJBCMA1",21,0)
 Q
"RTN","PSJBCMA1",22,0)
 ;
"RTN","PSJBCMA1",23,0)
UDVAR ;* Set ^TMP for Unit dose & Pending orders
"RTN","PSJBCMA1",24,0)
 NEW CNT,X
"RTN","PSJBCMA1",25,0)
 D UDPEND
"RTN","PSJBCMA1",26,0)
 D TMP
"RTN","PSJBCMA1",27,0)
 ;* Setup Dispense drug for ^TMP
"RTN","PSJBCMA1",28,0)
 S CNT=0 D NOW^%DTC
"RTN","PSJBCMA1",29,0)
 F X=0:0 S X=$O(@(F_",1,"_X_")")) Q:'X  D
"RTN","PSJBCMA1",30,0)
 . S PSJDD=@(F_",1,"_X_",0)") I $P(PSJDD,"^",3)]"",$P(PSJDD,"^",3)'>% Q
"RTN","PSJBCMA1",31,0)
 . S CNT=CNT+1
"RTN","PSJBCMA1",32,0)
 . S ^TMP(PSJTMP,$J,700,CNT,0)=+PSJDD_U_$P($G(^PSDRUG(+PSJDD,0)),U)_U_$S((ON["U")&($P(PSJDD,U,2)=""):1,(ON["U")&($E($P(PSJDD,U,2))="."):"0"_$P(PSJDD,U,2),1:$P(PSJDD,U,2))_U_$P(PSJDD,U,3)
"RTN","PSJBCMA1",33,0)
 S:CNT ^TMP(PSJTMP,$J,700,0)=CNT
"RTN","PSJBCMA1",34,0)
 K PSJ,PSJDD,PSJDN
"RTN","PSJBCMA1",35,0)
 Q
"RTN","PSJBCMA1",36,0)
IVVAR ;* Set variables for IV and pending orders
"RTN","PSJBCMA1",37,0)
 NEW CNT,DN,ND,X,Y
"RTN","PSJBCMA1",38,0)
 I ON["P" D UDPEND S PSJ("INFRATE")=$P($G(^PS(53.1,ON,8)),U,5)
"RTN","PSJBCMA1",39,0)
 I ON["V" D
"RTN","PSJBCMA1",40,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,0))
"RTN","PSJBCMA1",41,0)
 . S PSJ("STARTDT")=$P(X,U,2),PSJ("STOPDT")=$P(X,U,3)
"RTN","PSJBCMA1",42,0)
 . S PSJ("PROVIDER")=$P(X,U,6)
"RTN","PSJBCMA1",43,0)
 . S PSJ("INFRATE")=$P(X,U,8),PSJ("SCHD")=$P(X,U,9)
"RTN","PSJBCMA1",44,0)
 . S PSJ("ADM")=$P(X,U,11),PSJ("AUTO")=$P(X,U,12),PSJ("STATUS")=$P(X,U,17)
"RTN","PSJBCMA1",45,0)
 . S PSJ("FREQ")=$P(X,U,15),PSJ("IVTYPE")=$P(X,U,4)
"RTN","PSJBCMA1",46,0)
 . S PSJ("INSYR")=$P(X,U,5),PSJ("CPRS")=$P(X,U,21),PSJ("CHEMO")=$P(X,U,23)
"RTN","PSJBCMA1",47,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,.2))
"RTN","PSJBCMA1",48,0)
 . S PSJ("OI")=$P(X,U),PSJ("DO")=""
"RTN","PSJBCMA1",49,0)
 . S PSJ("MR")=$P(X,U,3)
"RTN","PSJBCMA1",50,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,4))
"RTN","PSJBCMA1",51,0)
 . S PSJ("NURSE")=$P(X,U)
"RTN","PSJBCMA1",52,0)
 . S PSJ("PHARM")=$P(X,U,4)
"RTN","PSJBCMA1",53,0)
 . S X=$G(^PS(55,DFN,"IV",+ON,2))
"RTN","PSJBCMA1",54,0)
 . S PSJ("LDT")=$P(X,U)
"RTN","PSJBCMA1",55,0)
 . S PSJ("PREV")=$P(X,U,5),PSJ("FOLLOW")=$P(X,U,6)
"RTN","PSJBCMA1",56,0)
 . S PSJ("SIOPI")=$S($P($G(^PS(55,DFN,"IV",+ON,3)),"^",2)&($P($G(^PS(55,DFN,"IV",+ON,3)),"^")'=""):"!",1:"")_$P($G(^(3)),"^")
"RTN","PSJBCMA1",57,0)
 . N SCHD S SCHD=PSJ("SCHD")  ; SCHD var required to shorten $Select
"RTN","PSJBCMA1",58,0)
 . S PSJ("STC")=$$ONE^PSJBCMA(DFN,ON,SCHD,PSJ("STARTDT"),PSJ("STOPDT"))
"RTN","PSJBCMA1",59,0)
 . I PSJ("STC")=""!(PSJ("STC")="C") S PSJ("STC")=$S(SCHD["PRN":"P",1:"C")
"RTN","PSJBCMA1",60,0)
 . I PSJ("STC")="C" S PSJ("STC")=$S(SCHD["ON CALL":"OC",SCHD["ON-CALL":"OC",SCHD["ONCALL":"OC",1:"C")
"RTN","PSJBCMA1",61,0)
 . S PSJ("NURSE")=$P($G(^PS(55,DFN,"IV",+ON,4)),U)
"RTN","PSJBCMA1",62,0)
 D TMP
"RTN","PSJBCMA1",63,0)
 S X=$P($G(^PS(55,DFN,"IV",+ON,1)),U) S:X]"" ^TMP(PSJTMP,$J,6)=X
"RTN","PSJBCMA1",64,0)
 S CNT=0
"RTN","PSJBCMA1",65,0)
 F X=0:0 S X=$O(@(F_",""AD"","_X_")")) Q:'X  D
"RTN","PSJBCMA1",66,0)
 . S ND=$G(@(F_",""AD"","_X_",0)")),DN=$G(^PS(52.6,+ND,0)) ;,AOINAME=$$OIDF^PSJLMUT1(+$P(DN,U,11)) I AOINAME["NOTFOUND" S AOINAME=""
"RTN","PSJBCMA1",67,0)
 . ;S AOIDF=$$GET1^DIQ(50.7,+$P(DN,U,11),.02) I AOINAME="" S AOIDF=""
"RTN","PSJBCMA1",68,0)
 . S CNT=CNT+1,^TMP(PSJTMP,$J,850,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(ND,U,3) ;_U_U_$P(DN,U,11)_U_AOINAME_U_AOIDF
"RTN","PSJBCMA1",69,0)
 S:CNT ^TMP(PSJTMP,$J,850,0)=CNT,CNT=0
"RTN","PSJBCMA1",70,0)
 F X=0:0 S X=$O(@(F_",""SOL"","_X_")")) Q:'X  D
"RTN","PSJBCMA1",71,0)
 . S ND=$G(@(F_",""SOL"","_X_",0)")),DN=$G(^PS(52.7,+ND,0)) ;,SOINAME=$$OIDF^PSJLMUT1(+$P(DN,U,11)) I SOINAME["NOTFOUND" S SOINAME=""
"RTN","PSJBCMA1",72,0)
 . ;S SOIDF=$$GET1^DIQ(50.7,+$P(DN,U,11),.02) I SOINAME="" S SOIDF=""
"RTN","PSJBCMA1",73,0)
 . S CNT=CNT+1,^TMP(PSJTMP,$J,950,CNT,0)=+ND_U_$P(DN,U)_U_$P(ND,U,2)_U_$P(DN,U,4) ;_U_U_$P(DN,U,11)_U_SOINAME_U_SOIDF
"RTN","PSJBCMA1",74,0)
 S:CNT ^TMP(PSJTMP,$J,950,0)=CNT
"RTN","PSJBCMA1",75,0)
 K PSJ
"RTN","PSJBCMA1",76,0)
 S X1=0
"RTN","PSJBCMA1",77,0)
 F  S X1=$O(^PS(55,DFN,"IVBCMA",X1)) Q:'X1  D
"RTN","PSJBCMA1",78,0)
 . S XX=$G(^PS(55,DFN,"IVBCMA",X1,0)) Q:$P(XX,"^",2)'=+ON  S PSJBCID=$P(XX,"^"),X2=0
"RTN","PSJBCMA1",79,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"AD",X2)) Q:'X2  S X=^(X2,0),^TMP(PSJTMP,$J,800,PSJBCID,I)=+X_"^"_$S($D(^PS(52.6,+X,0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA1",80,0)
 . I I>1 S ^TMP(PSJTMP,$J,800,PSJBCID,0)=I-1
"RTN","PSJBCMA1",81,0)
 . S X2=0
"RTN","PSJBCMA1",82,0)
 . F I=1:1 S X2=$O(^PS(55,DFN,"IVBCMA",X1,"SOL",X2)) Q:'X2  S X=^(X2,0),^TMP(PSJTMP,$J,900,PSJBCID,I)=$P(X,"^")_"^"_$S($D(^PS(52.7,$P(X,"^"),0)):$P(^(0),"^"),1:"*****")_"^"_$P(X,"^",2,99)
"RTN","PSJBCMA1",83,0)
 . I I>1 S ^TMP(PSJTMP,$J,900,PSJBCID,0)=I-1
"RTN","PSJBCMA1",84,0)
 . S ^TMP(PSJTMP,$J,1000,PSJBCID)=$P(XX,"^",6)_"^"_$P(XX,"^",8)_"^"_$P(XX,"^",7)
"RTN","PSJBCMA1",85,0)
 Q
"RTN","PSJBCMA1",86,0)
UDPEND ;
"RTN","PSJBCMA1",87,0)
 S X=$G(@(F_",0)"))
"RTN","PSJBCMA1",88,0)
 S PSJ("PROVIDER")=$P(X,U,2)
"RTN","PSJBCMA1",89,0)
 S PSJ("MR")=$P(X,U,3),PSJ("SM")=$P(X,U,5),PSJ("HSM")=$P(X,U,6)
"RTN","PSJBCMA1",90,0)
 S PSJ("ST")=$P(X,U,7),PSJ("STATUS")=$P(X,U,9)
"RTN","PSJBCMA1",91,0)
 S PSJ("LDT")=$P(X,U,16)
"RTN","PSJBCMA1",92,0)
 S:ON["U" PSJ("NGIVEN")=$P(X,U,22)
"RTN","PSJBCMA1",93,0)
 S PSJ("SMYN")=$S(+PSJ("SM"):"YES",1:"NO")
"RTN","PSJBCMA1",94,0)
 S PSJ("HSMYN")=$S(+PSJ("HSM"):"YES",1:"NO")
"RTN","PSJBCMA1",95,0)
 S PSJ("CPRS")=$P(X,U,21),PSJ("PREV")=$P(X,U,25),PSJ("FOLLOW")=$P(X,U,26)
"RTN","PSJBCMA1",96,0)
 S X=$G(@(F_",.2)"))
"RTN","PSJBCMA1",97,0)
 S PSJ("OI")=$P(X,U),PSJ("DO")=$P(X,U,2)
"RTN","PSJBCMA1",98,0)
 S X=$G(@(F_",2)"))
"RTN","PSJBCMA1",99,0)
 S PSJ("SCHD")=$P(X,U),PSJ("STARTDT")=$P(X,U,2)
"RTN","PSJBCMA1",100,0)
 S PSJ("STC")=PSJ("ST")
"RTN","PSJBCMA1",101,0)
 I PSJ("ST")="R"!(PSJ("ST")="C") S PSJ("STC")=$S(PSJ("SCHD")["PRN":"P","^ONCALL^ON-CALL^ON CALL^"[("^"_PSJ("SCHD")_"^"):"OC",$$ONE^PSJBCMA(DFN,ON,PSJ("SCHD"))="O":"O",1:"C")
"RTN","PSJBCMA1",102,0)
 I PSJ("STC")="O" S PSJ("ST")="O"
"RTN","PSJBCMA1",103,0)
 S PSJ("STOPDT")=$P(X,U,4),PSJ("ADM")=$P(X,U,5)
"RTN","PSJBCMA1",104,0)
 S PSJ("FREQ")=$P(X,U,6)
"RTN","PSJBCMA1",105,0)
 S X=$G(@(F_",4)"))
"RTN","PSJBCMA1",106,0)
 S PSJ("NURSE")=$P(X,U),PSJ("AUTO")=$P(X,U,11)
"RTN","PSJBCMA1",107,0)
 S:ON["U" PSJ("PHARM")=+$P(X,U,3)
"RTN","PSJBCMA1",108,0)
 ; the naked reference on the line below refers to the full reference created by indirect reference to F, where F may refer to ^PS(53.1 or the IV or UD multiple ^PS(55
"RTN","PSJBCMA1",109,0)
 S PSJ("SIOPI")=$S($P($G(@(F_",6)")),"^",2)&($P($G(@(F_",6)")),"^")'=""):"!",1:"")_$$ENSET^PSJBCMA($P($G(^(6)),"^"))
"RTN","PSJBCMA1",110,0)
 NEW FON S FON=ON D SIOPI^PSJBCMA
"RTN","PSJBCMA1",111,0)
 Q 
"RTN","PSJBCMA1",112,0)
 ;
"RTN","PSJBCMA1",113,0)
TMP ;* Setup ^TMP that have common fields between IV and U/D
"RTN","PSJBCMA1",114,0)
 D NAME(PSJ("PROVIDER"),.PSJNAME,"","")
"RTN","PSJBCMA1",115,0)
 S PSJ("PRONAME")=PSJNAME K PSJNAME
"RTN","PSJBCMA1",116,0)
 I $D(PSJ("PHARM")) D
"RTN","PSJBCMA1",117,0)
 . D NAME(PSJ("PHARM"),.PSJNAME,.PSJINIT,.PSJPIEN)
"RTN","PSJBCMA1",118,0)
 . S PSJ("PHARM")=PSJPIEN,PSJ("PNAME")=PSJNAME,PSJ("PINIT")=PSJINIT K PSJNAME,PSJINIT,PSJPIEN
"RTN","PSJBCMA1",119,0)
 I +PSJ("NURSE") D
"RTN","PSJBCMA1",120,0)
 . D NAME(PSJ("NURSE"),.PSJNAME,.PSJINIT,"")
"RTN","PSJBCMA1",121,0)
 . S PSJ("NNAME")=PSJNAME,PSJ("NINIT")=PSJINIT K PSJNAME,PSJINIT
"RTN","PSJBCMA1",122,0)
 S A=$G(^PS(51.2,+PSJ("MR"),0)),PSJ("MRNM")=$P(A,U),PSJ("MRABB")=$P(A,U,3)
"RTN","PSJBCMA1",123,0)
 S PSJ("OINAME")=$$OIDF^PSJLMUT1(+PSJ("OI")) I PSJ("OINAME")["NOT FOUND" S PSJ("OINAME")=""
"RTN","PSJBCMA1",124,0)
 S PSJ("OIDF")=$$GET1^DIQ(50.7,+PSJ("OI"),.02)
"RTN","PSJBCMA1",125,0)
 I PSJ("OINAME")="" S PSJ("OIDF")=""
"RTN","PSJBCMA1",126,0)
 S PSJ("LDTN")=$$DATE(PSJ("LDT"))
"RTN","PSJBCMA1",127,0)
 S PSJ("STARTDTN")=$$DATE(PSJ("STARTDT"))
"RTN","PSJBCMA1",128,0)
 S PSJ("STOPDTN")=$$DATE(PSJ("STOPDT"))
"RTN","PSJBCMA1",129,0)
 S X=$S(ON["V":PSJ("STC"),1:PSJ("ST"))
"RTN","PSJBCMA1",130,0)
 S PSJ("STNAME")=$S(X="C":"CONTINUOUS",X="O":"ONE TIME",X="P":"PRN",X="R":"FILL ON REQUEST",X="OC":"ON CALL",1:"NOT FOUND")
"RTN","PSJBCMA1",131,0)
 ;
"RTN","PSJBCMA1",132,0)
 S ^TMP(PSJTMP,$J,0)=DFN_U_+ON_U_ON_U_PSJ("PREV")_U_PSJ("FOLLOW")_U_$G(PSJ("IVTYPE"))_U_$G(PSJ("INSYR"))_U_$G(PSJ("CHEMO"))_U_PSJ("CPRS")
"RTN","PSJBCMA1",133,0)
 S ^TMP(PSJTMP,$J,1)=PSJ("PROVIDER")_U_PSJ("PRONAME")_U_PSJ("MR")_U_PSJ("MRABB")_U_$G(PSJ("SM"))_U_$G(PSJ("SMYN"))_U_$G(PSJ("HSM"))_U_$G(PSJ("HSMYN"))_U_$G(PSJ("NGIVEN"))_U_PSJ("STATUS")
"RTN","PSJBCMA1",134,0)
 S ^TMP(PSJTMP,$J,1)=^TMP(PSJTMP,$J,1)_U_$$STATUS(ON,PSJ("STATUS"))_U_$G(PSJ("AUTO"))_U_$G(PSJ("MRNM"))
"RTN","PSJBCMA1",135,0)
 S ^TMP(PSJTMP,$J,2)=PSJ("OI")_U_PSJ("OINAME")_U_PSJ("DO")_U_$G(PSJ("INFRATE"))_U_$G(PSJ("SCHD"))_U_PSJ("OIDF")
"RTN","PSJBCMA1",136,0)
 S ^TMP(PSJTMP,$J,3)=PSJ("SIOPI")
"RTN","PSJBCMA1",137,0)
 S ^TMP(PSJTMP,$J,4)=PSJ("STC")_U_$G(PSJ("STNAME"))_U_PSJ("LDT")_U_PSJ("LDTN")_U_PSJ("STARTDT")_U_PSJ("STARTDTN")_U_PSJ("STOPDT")_U_PSJ("STOPDTN")_U_$$ADMIN(PSJ("ADM"))_U_$G(PSJ("ST"))_U_$G(PSJ("FREQ"))
"RTN","PSJBCMA1",138,0)
 S ^TMP(PSJTMP,$J,5)=$G(PSJ("NURSE"))_U_$G(PSJ("NNAME"))_U_$G(PSJ("NINIT"))_U_$G(PSJ("PHARM"))_U_$G(PSJ("PNAME"))_U_$G(PSJ("PINIT"))
"RTN","PSJBCMA1",139,0)
 Q
"RTN","PSJBCMA1",140,0)
 ;
"RTN","PSJBCMA1",141,0)
NAME(X,NAME,INIT,IEN)  ;Lookup in ^VA(200.
"RTN","PSJBCMA1",142,0)
 ;X = IEN or Name in ^VA(200
"RTN","PSJBCMA1",143,0)
 ;IEN = Return IEN in ^VA(200
"RTN","PSJBCMA1",144,0)
 ;NAME = Return the name in 200
"RTN","PSJBCMA1",145,0)
 ;INIT = Return the initial
"RTN","PSJBCMA1",146,0)
 NEW DIC,Y
"RTN","PSJBCMA1",147,0)
 S DIC="^VA(200,",DIC(0)="NZ" D ^DIC
"RTN","PSJBCMA1",148,0)
 S IEN=+Y
"RTN","PSJBCMA1",149,0)
 S NAME=$G(Y(0,0))
"RTN","PSJBCMA1",150,0)
 S INIT=$P($G(Y(0)),U,2)
"RTN","PSJBCMA1",151,0)
 Q
"RTN","PSJBCMA1",152,0)
 ;
"RTN","PSJBCMA1",153,0)
DATE(Y) ; FM internal date/time to user readable, 4 digit year
"RTN","PSJBCMA1",154,0)
 ; Y - date in FileMan internal format
"RTN","PSJBCMA1",155,0)
 I $G(Y) S Y=Y_$E(".",Y'[".")_"0000" Q $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_($E(Y,1,3)+1700)_"  "_$E(Y,9,10)_":"_$E(Y,11,12)
"RTN","PSJBCMA1",156,0)
 Q "********"
"RTN","PSJBCMA1",157,0)
 ;
"RTN","PSJBCMA1",158,0)
STATUS(ON,X)          ;
"RTN","PSJBCMA1",159,0)
 ; ON = IEN_"I/U/P"
"RTN","PSJBCMA1",160,0)
 ; X  = STATUS
"RTN","PSJBCMA1",161,0)
 I X="P" Q $S(ON["P":"PENDING",ON["V":"PURGE",1:"NOT FOUND")
"RTN","PSJBCMA1",162,0)
 Q $S(X="A":"ACTIVE",X="D":"DISCONTINUED",X="E":"EXPIRED",X="H":"HOLD",X="R":"RENEWED",X="RE":"REINSTATED",X="N":"NON-VERFIED",X="DE":"DISCONTINUED (EDIT)",X="O":"ON CALL",1:"NOT FOUND")
"RTN","PSJBCMA1",163,0)
 ;
"RTN","PSJBCMA1",164,0)
ADMIN(X) ;
"RTN","PSJBCMA1",165,0)
 NEW Y,PSJADM,PSJX S PSJADM=""
"RTN","PSJBCMA1",166,0)
 I X="" Q ""
"RTN","PSJBCMA1",167,0)
 F Y=1:1:$L(X,"-") S PSJX=$E($P(X,"-",Y)_"0000",1,4) D
"RTN","PSJBCMA1",168,0)
 . S PSJADM=PSJADM_$S(PSJADM]"":"-",1:"")_PSJX
"RTN","PSJBCMA1",169,0)
 Q PSJADM
"RTN","PSJBCMA1",170,0)
 ;
"RTN","PSJCOM")
0^4^B38929893^B38439683
"RTN","PSJCOM",1,0)
PSJCOM ;BIR/CML3-FINISH COMPLEX UNIT DOSE ORDERS ENTERED THROUGH OE/RR ;02 Feb 2001  12:20 PM
"RTN","PSJCOM",2,0)
 ;;5.0; INPATIENT MEDICATIONS ;**110,186**;16 DEC 97
"RTN","PSJCOM",3,0)
 ;
"RTN","PSJCOM",4,0)
 ; Reference to ^VALM1 is supported by DBIA 10116.
"RTN","PSJCOM",5,0)
 ; Reference to ^PS(55 is supported by DBIA 2191.
"RTN","PSJCOM",6,0)
 ; Reference to ^%DTC is supported by DBIA 10000.
"RTN","PSJCOM",7,0)
 ; Reference to ^%RCR is supported by DBIA 10022.
"RTN","PSJCOM",8,0)
 ; Reference to ^DIR is supported by DBIA 10026.
"RTN","PSJCOM",9,0)
 ; Reference to ^TIUEDIT is supported by DBIA 2410.
"RTN","PSJCOM",10,0)
 ;
"RTN","PSJCOM",11,0)
UPD ;
"RTN","PSJCOM",12,0)
 Q:'PSJCOM
"RTN","PSJCOM",13,0)
 M ^TMP("PSJCOM",$J,+PSGORD)=^PS(53.1,+PSGORD)
"RTN","PSJCOM",14,0)
 I PSGST="",(PSGSCH="NOW"!(PSGSCH="ONCE")) S PSGST="O"
"RTN","PSJCOM",15,0)
 S $P(^TMP("PSJCOM",$J,+PSGORD,0),"^",9)="N",$P(^(0),"^",4)="U",$P(^(0),"^",7)=PSGST,$P(^TMP("PSJCOM",$J,+PSGORD,2),"^",2)=PSGSD,$P(^(2),"^",4)=PSGFD
"RTN","PSJCOM",16,0)
 I $D(PSGSI),$P($G(^PS(53.1,+PSGORD,0)),U,24)'="R" S ^TMP("PSJCOM",$J,+PSGORD,6)=PSGSI
"RTN","PSJCOM",17,0)
 I $D(PSGSI),$P($G(^PS(53.1,+PSGORD,0)),U,24)="R" S $P(^TMP("PSJCOM",$J,+PSGORD,6),U)=$P(PSGSI,U) I $P(PSGSI,U)="" S $P(^TMP("PSJCOM",$J,+PSGORD,6),U,2)=""
"RTN","PSJCOM",18,0)
 S:$D(PSGSCH) $P(^TMP("PSJCOM",$J,+PSGORD,2),"^")=PSGSCH
"RTN","PSJCOM",19,0)
 I PSGSM,PSGOHSM'=PSGHSM S $P(^TMP("PSJCOM",$J,+PSGORD,0),"^",5)=PSGSM,$P(^TMP("PSJCOM",$J,+PSGORD,0),"^",6)=PSGHSM
"RTN","PSJCOM",20,0)
 W "."
"RTN","PSJCOM",21,0)
 S PSGOEEWF="^TMP(""PSJCOM"",$J,+PSGORD,"
"RTN","PSJCOM",22,0)
 F Q=1,3 K @(PSGOEEWF_Q_")") S %X="^PS(53.45,"_PSJSYSP_","_$S(Q=1:2,1:1)_",",%Y=PSGOEEWF_Q_"," K @(PSGOEEWF_Q_")") D %XY^%RCR W "."  ;MOU-0100-30945
"RTN","PSJCOM",23,0)
 S PSGND=$G(^TMP("PSJCOM",$J,+PSGORD,0)),X=$P(PSGND,U,24)
"RTN","PSJCOM",24,0)
 S PSJOWALL=+$G(^PS(55,PSGP,5.1))
"RTN","PSJCOM",25,0)
 I $S(X="R":1,+$G(^PS(55,PSGP,5.1))>PSGDT:0,1:X'="E") S X=$G(^TMP("PSJCOM",$J,+PSGORD,2)) D ENWALL^PSGNE3(+$P(X,U,2),+$P(X,U,4),PSGP)
"RTN","PSJCOM",26,0)
 S $P(^TMP("PSJCOM",$J,+PSGORD,.2),U,2)=PSGDO,$P(^TMP("PSJCOM",$J,+PSGORD,2),U,5)=PSGAT S:$G(PSGS0XT) $P(^(2),U,6)=PSGS0XT
"RTN","PSJCOM",27,0)
 I 'PSGOEAV D NEWNVAL(PSGORD,$S(+PSJSYSU=3:22005,1:22000))
"RTN","PSJCOM",28,0)
 I PSGOEAV,+PSJSYSU=3 D VFY Q
"RTN","PSJCOM",29,0)
 I PSGOEAV,$G(PSJRNF) D VFY
"RTN","PSJCOM",30,0)
 Q
"RTN","PSJCOM",31,0)
VFY ; change status, move to 55, and change label record
"RTN","PSJCOM",32,0)
 Q:'PSJCOM
"RTN","PSJCOM",33,0)
 I '$D(^TMP("PSJCOM",$J,+PSGORD)) M ^TMP("PSJCOM",$J,+PSGORD)=^PS(53.1,+PSGORD)
"RTN","PSJCOM",34,0)
 NEW PSJDOSE,PSJDSFLG
"RTN","PSJCOM",35,0)
 D DOSECHK^PSJDOSE
"RTN","PSJCOM",36,0)
 I +$G(PSJDSFLG) D SETVAR^PSJDOSE W !!,PSJDOSE("WARN"),!,PSJDOSE("WARN1") I '$$CONT() W !,"...order was not verified..." D PAUSE^VALM1 D  Q:'$G(PSJACEPT)
"RTN","PSJCOM",37,0)
 . S PSGOEEF(109)=1
"RTN","PSJCOM",38,0)
 . S PSJACEPT=0
"RTN","PSJCOM",39,0)
 D DDCHK G:CHK DONE
"RTN","PSJCOM",40,0)
 W !,"...a few moments, please..."
"RTN","PSJCOM",41,0)
 I PSGORD["P" D
"RTN","PSJCOM",42,0)
 . S PSGORDP=PSGORD ;Used in ACTLOG to update activity log in ^TMP
"RTN","PSJCOM",43,0)
 . I '$D(^TMP("PSJCOM2",$J,+PSGORD)) D  Q
"RTN","PSJCOM",44,0)
 .. NEW PSGX S PSGX=$G(^TMP("PSJCOM",$J,+PSGORD,2.5)),PSGRSD=$P(PSGX,U),PSGRFD=$P(PSGX,U,3)
"RTN","PSJCOM",45,0)
 .. S $P(^TMP("PSJCOM",$J,+PSGORD,0),"^",9)="A" W "." ;D ^PSGOT
"RTN","PSJCOM",46,0)
 .  NEW PSGX S PSGX=$G(^TMP("PSJCOM2",$J,+PSGORD,2.5)),PSGRSD=$P(PSGX,U),PSGRFD=$P(PSGX,U,3)
"RTN","PSJCOM",47,0)
 .  S $P(^TMP("PSJCOM2",$J,+PSGORD,0),"^",9)="A" W "." ;D ^PSGOT
"RTN","PSJCOM",48,0)
 D NEWNVAL(+PSGORD,(PSJSYSU*10+22000)) W "."
"RTN","PSJCOM",49,0)
 S VND4=$S('$D(^TMP("PSJCOM2",$J,+PSGORD)):$G(^TMP("PSJCOM",$J,+PSGORD,4)),1:$G(^TMP("PSJCOM2",$J,+PSGORD,4)))
"RTN","PSJCOM",50,0)
 I $G(PSGRSD) D
"RTN","PSJCOM",51,0)
 . S PSGRSD=$$ENDTC^PSGMI(PSGRSD) D NEWNVAL(PSGORD,6090,"Requested Start Date",PSGRSD)
"RTN","PSJCOM",52,0)
 . S PSGRFD=$$ENDTC^PSGMI(PSGRFD) D NEWNVAL(PSGORD,6090,"Requested Stop Date",PSGRFD)
"RTN","PSJCOM",53,0)
 N DUR,DURORD S DURON=$S($G(ON)&($G(PSGORD)["U"):ON,$G(PSGORD):PSGORD,1:"") Q:'DURON  D
"RTN","PSJCOM",54,0)
 . S DUR=$S($P($G(PSGRDTX),U,2)]"":$P($G(PSGRDTX),U,2),1:$$GETDUR^PSJLIVMD(PSGP,+DURON,$S($G(DURON)["P":"P",$G(DURON)["V":"IV",1:5),1),1:"")
"RTN","PSJCOM",55,0)
 I DUR]"" S $P(^TMP("PSJCOM2",$J,+PSGORD,2.5),"^",2)=DUR
"RTN","PSJCOM",56,0)
 ;D:$D(PSGORDP) ACTLOG(PSGORDP,PSGP,PSGORD)
"RTN","PSJCOM",57,0)
 K PSGRSD,PSGRFD,PSGALFN
"RTN","PSJCOM",58,0)
 NEW X S X=0 I $G(PSGONF),(+$G(PSGODDD(1))'<+$G(PSGONF)) S X=1
"RTN","PSJCOM",59,0)
 I +PSJSYSU=3,PSGORD'["O",$S(X:0,'$P(VND4,"^",16):1,1:$P(VND4,"^",15)) ;D EN^PSGPEN(+PSGORD)
"RTN","PSJCOM",60,0)
 S:'$P(VND4,U,+PSJSYSU=3+9) $P(VND4,U,+PSJSYSU=3+9)=+$P(VND4,U,+PSJSYSU=3+9)
"RTN","PSJCOM",61,0)
 ;S $P(VND4,"^",+PSJSYSU=1+9)=1,$P(VND4,U,+PSJSYSU=3+9)=0
"RTN","PSJCOM",62,0)
 S:$P(VND4,"^",15)&'$P(VND4,"^",16) $P(VND4,"^",15)="" S:$P(VND4,"^",18)&'$P(VND4,"^",19) $P(VND4,"^",18)="" S:$P(VND4,"^",22)&'$P(VND4,"^",23) $P(VND4,"^",22)=""
"RTN","PSJCOM",63,0)
 S $P(VND4,"^",PSJSYSU,PSJSYSU+1)=DUZ_"^"_PSGDT
"RTN","PSJCOM",64,0)
 S:'$D(^TMP("PSJCOM2",$J,+PSGORD)) ^TMP("PSJCOM",$J,+PSGORD,4)=VND4 S:$D(^TMP("PSJCOM2",$J,+PSGORD)) ^TMP("PSJCOM2",$J,+PSGORD,4)=VND4
"RTN","PSJCOM",65,0)
 W:'$D(PSJSPEED) ! W !,"ORDER VERIFIED.",!
"RTN","PSJCOM",66,0)
 I '$D(PSJSPEED) K DIR S DIR(0)="E" D ^DIR K DIR
"RTN","PSJCOM",67,0)
 S VALMBCK="Q"
"RTN","PSJCOM",68,0)
 S ^TMP("PSJCOM",$J)="A" S:$D(^TMP("PSJCOM2",$J,+PSGORD)) ^TMP("PSJCOM2",$J)="A"
"RTN","PSJCOM",69,0)
 ;
"RTN","PSJCOM",70,0)
DONE ;
"RTN","PSJCOM",71,0)
 W:CHK !!,"...order NOT verified..."
"RTN","PSJCOM",72,0)
 I '$D(PSJSPEED),'CHK,+PSJSYSU=3,$G(PSJPRI)="D" D
"RTN","PSJCOM",73,0)
 .N DIR W ! S DIR(0)="S^Y:Yes;N:No",DIR("A")="Do you want to enter a Progress Note",DIR("B")="No" D ^DIR
"RTN","PSJCOM",74,0)
 .Q:Y="N"
"RTN","PSJCOM",75,0)
 .D MAIN^TIUEDIT(3,.TIUDA,PSGP,"","","","",1)
"RTN","PSJCOM",76,0)
 S VALMBCK="Q" K CHK,DA,DIE,F,DP,DR,ND,PSGAL,PSGODA,PSJDOSE,PSJVAR,VND4,X Q
"RTN","PSJCOM",77,0)
 ;
"RTN","PSJCOM",78,0)
DDCHK ; dispense drug check
"RTN","PSJCOM",79,0)
 S DRGF=$S('$D(^TMP("PSJCOM2",$J,+PSGORD)):"^TMP(""PSJCOM"","_$J_","_+PSGORD_",",1:"^TMP(""PSJCOM2"","_$J_","_+PSGORD_","),CHK=$S('$O(@(DRGF_"1,0)")):7,1:0)
"RTN","PSJCOM",80,0)
 S PSGPD=$G(@(DRGF_".2)"))
"RTN","PSJCOM",81,0)
 S CHK=$S('$$DDOK^PSGOE2(DRGF_"1,",PSGPD):7,1:0)
"RTN","PSJCOM",82,0)
 Q:CHK=0
"RTN","PSJCOM",83,0)
 W $C(7),!!,"This order must have at least one valid, active dispense drug to be verified."
"RTN","PSJCOM",84,0)
 ;
"RTN","PSJCOM",85,0)
CONT() ;
"RTN","PSJCOM",86,0)
 NEW DIR,DIRUT,Y
"RTN","PSJCOM",87,0)
 W ! K DIR,DIRUT
"RTN","PSJCOM",88,0)
 S DIR(0)="Y",DIR("A")="Would you like to continue verifying the order",DIR("B")="Yes"
"RTN","PSJCOM",89,0)
 D ^DIR
"RTN","PSJCOM",90,0)
 Q Y
"RTN","PSJCOM",91,0)
 ;
"RTN","PSJCOM",92,0)
NEWNVAL(PSGALORD,PSGALC,PSGFLD,PSGOLD)  ;
"RTN","PSJCOM",93,0)
 ;
"RTN","PSJCOM",94,0)
 ;Where  PSGALORD = PSGORD (Required)
"RTN","PSJCOM",95,0)
 ;       PSGALC   = ACTIVITY CODE FROM #53.3 (Required)
"RTN","PSJCOM",96,0)
 ;       PSGFLD   = FIELD THAT CHANGED (Free text, optional)
"RTN","PSJCOM",97,0)
 ;       PSGOLD   = THE FIELDS OLD DATA VALUE (Free text, optional)
"RTN","PSJCOM",98,0)
 ;
"RTN","PSJCOM",99,0)
 ;N PSGALORD,PSGALC,PSGFLD,PSGOLD
"RTN","PSJCOM",100,0)
 ;
"RTN","PSJCOM",101,0)
 ; Create 0 node activity log for order if none exists, and get next entry number
"RTN","PSJCOM",102,0)
 I '$D(^TMP("PSJCOM2",$J,+PSGALORD)) D  Q
"RTN","PSJCOM",103,0)
 . S QQ=$G(^TMP("PSJCOM",$J,+PSGALORD,"A",0)) S:QQ="" QQ="^53.1119D" F Q=$P(QQ,"^",3)+1:1 I '$D(^(Q)) S $P(QQ,"^",3,4)=Q_"^"_Q,^(0)=QQ,PSGAL("N")=Q Q
"RTN","PSJCOM",104,0)
 . ;Set up data to be held in activity log record
"RTN","PSJCOM",105,0)
 . D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSJCOM",106,0)
 . I $L($G(PSGOLD))>170 S PSGOLD=$E(PSGOLD,1,167)_"..." ; Use of ... indicates old data field was greater than 170 characters
"RTN","PSJCOM",107,0)
 . S Q=%_"^"_$S(PSGALC=6010:"AUTO CANCEL",$D(DUZ)[0:"UNKNOWN",DUZ]"":DUZ,1:"UNKNOWN")_"^"_PSGALC_"^"_$S($D(PSGFLD):PSGFLD,1:"")_"^"_$S($D(PSGOLD):PSGOLD,1:"")
"RTN","PSJCOM",108,0)
 . ; Create activity log entry
"RTN","PSJCOM",109,0)
 . S ^TMP("PSJCOM",$J,+PSGALORD,"A",PSGAL("N"),0)=Q
"RTN","PSJCOM",110,0)
 S QQ=$G(^TMP("PSJCOM2",$J,+PSGALORD,"A",0)) S:QQ="" QQ="^53.1119D" F Q=$P(QQ,"^",3)+1:1 I '$D(^(Q)) S $P(QQ,"^",3,4)=Q_"^"_Q,^(0)=QQ,PSGAL("N")=Q Q
"RTN","PSJCOM",111,0)
 ;Set up data to be held in activity log record
"RTN","PSJCOM",112,0)
 D NOW^%DTC S PSGDT=+$E(%,1,12)
"RTN","PSJCOM",113,0)
 I $L($G(PSGOLD))>170 S PSGOLD=$E(PSGOLD,1,167)_"..." ; Use of ... indicates old data field was greater than 170 characters
"RTN","PSJCOM",114,0)
 S Q=%_"^"_$S(PSGALC=6010:"AUTO CANCEL",$D(DUZ)[0:"UNKNOWN",DUZ]"":DUZ,1:"UNKNOWN")_"^"_PSGALC_"^"_$S($D(PSGFLD):PSGFLD,1:"")_"^"_$S($D(PSGOLD):PSGOLD,1:"")
"RTN","PSJCOM",115,0)
 ; Create activity log entry
"RTN","PSJCOM",116,0)
 S ^TMP("PSJCOM2",$J,+PSGALORD,"A",PSGAL("N"),0)=Q
"RTN","PSJCOM",117,0)
 Q
"VER")
8.0^22.0
"BLD",6991,6)
^157
**END**
**END**
