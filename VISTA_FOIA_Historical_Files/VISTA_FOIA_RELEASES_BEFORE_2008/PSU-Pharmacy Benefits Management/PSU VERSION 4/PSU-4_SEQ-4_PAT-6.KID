Released PSU*4*6 SEQ #4
Extracted from mail message
**KIDS**:PSU*4.0*6^

**INSTALL NAME**
PSU*4.0*6
"BLD",5546,0)
PSU*4.0*6^PHARMACY BENEFITS MANAGEMENT^0^3051109^y
"BLD",5546,1,0)
^^6^6^3051108^
"BLD",5546,1,1,0)
This patch corrects the AR/WS AMIS Summary report for the Pharmacy
"BLD",5546,1,2,0)
Benefits Management (PBM) Version 4.0 extract in cases where there is no
"BLD",5546,1,3,0)
AR/WS data available for the date range of an AR/WS extract.
"BLD",5546,1,4,0)
 
"BLD",5546,1,5,0)
This patch also corrects the Prescription Extract MailMan messages
"BLD",5546,1,6,0)
containing mismatched data elements for partial fill prescriptions.
"BLD",5546,4,0)
^9.64PA^^
"BLD",5546,"ABPKG")
n
"BLD",5546,"KRN",0)
^9.67PA^8989.52^19
"BLD",5546,"KRN",.4,0)
.4
"BLD",5546,"KRN",.401,0)
.401
"BLD",5546,"KRN",.402,0)
.402
"BLD",5546,"KRN",.403,0)
.403
"BLD",5546,"KRN",.5,0)
.5
"BLD",5546,"KRN",.84,0)
.84
"BLD",5546,"KRN",3.6,0)
3.6
"BLD",5546,"KRN",3.8,0)
3.8
"BLD",5546,"KRN",9.2,0)
9.2
"BLD",5546,"KRN",9.8,0)
9.8
"BLD",5546,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5546,"KRN",9.8,"NM",1,0)
PSUAR6^^0^B98140520
"BLD",5546,"KRN",9.8,"NM",2,0)
PSUOP2^^0^B42752697
"BLD",5546,"KRN",9.8,"NM","B","PSUAR6",1)

"BLD",5546,"KRN",9.8,"NM","B","PSUOP2",2)

"BLD",5546,"KRN",19,0)
19
"BLD",5546,"KRN",19.1,0)
19.1
"BLD",5546,"KRN",101,0)
101
"BLD",5546,"KRN",409.61,0)
409.61
"BLD",5546,"KRN",771,0)
771
"BLD",5546,"KRN",870,0)
870
"BLD",5546,"KRN",8989.51,0)
8989.51
"BLD",5546,"KRN",8989.52,0)
8989.52
"BLD",5546,"KRN",8994,0)
8994
"BLD",5546,"KRN","B",.4,.4)

"BLD",5546,"KRN","B",.401,.401)

"BLD",5546,"KRN","B",.402,.402)

"BLD",5546,"KRN","B",.403,.403)

"BLD",5546,"KRN","B",.5,.5)

"BLD",5546,"KRN","B",.84,.84)

"BLD",5546,"KRN","B",3.6,3.6)

"BLD",5546,"KRN","B",3.8,3.8)

"BLD",5546,"KRN","B",9.2,9.2)

"BLD",5546,"KRN","B",9.8,9.8)

"BLD",5546,"KRN","B",19,19)

"BLD",5546,"KRN","B",19.1,19.1)

"BLD",5546,"KRN","B",101,101)

"BLD",5546,"KRN","B",409.61,409.61)

"BLD",5546,"KRN","B",771,771)

"BLD",5546,"KRN","B",870,870)

"BLD",5546,"KRN","B",8989.51,8989.51)

"BLD",5546,"KRN","B",8989.52,8989.52)

"BLD",5546,"KRN","B",8994,8994)

"BLD",5546,"QUES",0)
^9.62^^
"BLD",5546,"REQB",0)
^9.611^1^1
"BLD",5546,"REQB",1,0)
PSU 4.0^2
"BLD",5546,"REQB","B","PSU 4.0",1)

"MBREQ")
0
"PKG",367,-1)
1^1
"PKG",367,0)
PHARMACY BENEFITS MANAGEMENT^PSU^PHARMACY BENEFITS MANAGEMENT
"PKG",367,20,0)
^9.402P^^
"PKG",367,22,0)
^9.49I^1^1
"PKG",367,22,1,0)
4.0^3050620^3050831^10000000012
"PKG",367,22,1,"PAH",1,0)
6^3051109
"PKG",367,22,1,"PAH",1,1,0)
^^6^6^3051109
"PKG",367,22,1,"PAH",1,1,1,0)
This patch corrects the AR/WS AMIS Summary report for the Pharmacy
"PKG",367,22,1,"PAH",1,1,2,0)
Benefits Management (PBM) Version 4.0 extract in cases where there is no
"PKG",367,22,1,"PAH",1,1,3,0)
AR/WS data available for the date range of an AR/WS extract.
"PKG",367,22,1,"PAH",1,1,4,0)
 
"PKG",367,22,1,"PAH",1,1,5,0)
This patch also corrects the Prescription Extract MailMan messages
"PKG",367,22,1,"PAH",1,1,6,0)
containing mismatched data elements for partial fill prescriptions.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSUAR6")
0^1^B98140520^B100733277
"RTN","PSUAR6",1,0)
PSUAR6 ;BIR/DAM - AR/WS AMIS Summary Data;11 March 2004
"RTN","PSUAR6",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;**6**;MARCH, 2005
"RTN","PSUAR6",3,0)
 ;
"RTN","PSUAR6",4,0)
 ;This routine gathers AR/WS DOSES AMIS Summary data
"RTN","PSUAR6",5,0)
 ;No DBIA's needed
"RTN","PSUAR6",6,0)
 ;
"RTN","PSUAR6",7,0)
EN ;Entry point to gather AMIS data.  Called from PSUAR0
"RTN","PSUAR6",8,0)
 K PSUAR  ;Arrays to hold temporary data
"RTN","PSUAR6",9,0)
 N TRUNC,TOT,NET
"RTN","PSUAR6",10,0)
 S PSUDV=0
"RTN","PSUAR6",11,0)
 F  S PSUDV=$O(^XTMP(PSUARSUB,"RECORDS",PSUDV)) Q:PSUDV=""  D
"RTN","PSUAR6",12,0)
 .S PSUCT=0
"RTN","PSUAR6",13,0)
 .F  S PSUCT=$O(^XTMP(PSUARSUB,"RECORDS",PSUDV,PSUCT)) Q:PSUCT=""  D
"RTN","PSUAR6",14,0)
 ..K PSUAMIS
"RTN","PSUAR6",15,0)
 ..M PSUAMIS(PSUDV,PSUCT)=^XTMP(PSUARSUB,"RECORDS",PSUDV,PSUCT)
"RTN","PSUAR6",16,0)
 ..S PSUCAT=""
"RTN","PSUAR6",17,0)
 ..S PSUCAT=$P($G(PSUAMIS(PSUDV,PSUCT)),U,14)   ;AMIS Category
"RTN","PSUAR6",18,0)
 ..D DSP
"RTN","PSUAR6",19,0)
 ..D RET
"RTN","PSUAR6",20,0)
 ..D NET
"RTN","PSUAR6",21,0)
 ..D TCOST
"RTN","PSUAR6",22,0)
 .D AVE
"RTN","PSUAR6",23,0)
 D TOTAL
"RTN","PSUAR6",24,0)
 D EN^PSUAR7  ;Compose and send MailMan message
"RTN","PSUAR6",25,0)
 Q
"RTN","PSUAR6",26,0)
DSP ;Calculate AR/WS  dispensed data
"RTN","PSUAR6",27,0)
 N DSP,DUNT,DFLD,DBLD
"RTN","PSUAR6",28,0)
 I PSUCAT="03 or 04" D     ;Doses Data
"RTN","PSUAR6",29,0)
 .S DSP=$P($G(PSUAMIS(PSUDV,PSUCT)),U,19)
"RTN","PSUAR6",30,0)
 .I DSP="" S DSP=0
"RTN","PSUAR6",31,0)
 .S $P(PSUAR("DSP",PSUDV),U,1)=$P($G(PSUAR("DSP",PSUDV)),U,1)+DSP
"RTN","PSUAR6",32,0)
 ;
"RTN","PSUAR6",33,0)
 I PSUCAT="06 or 07" D     ;Units Data
"RTN","PSUAR6",34,0)
 .S DUNT=$P($G(PSUAMIS(PSUDV,PSUCT)),U,19)
"RTN","PSUAR6",35,0)
 .S:DUNT="" DUNT=0
"RTN","PSUAR6",36,0)
 .S $P(PSUAR("UNIT",PSUDV),U,1)=$P($G(PSUAR("UNIT",PSUDV)),U,1)+DUNT
"RTN","PSUAR6",37,0)
 ;
"RTN","PSUAR6",38,0)
 I PSUCAT=17 D          ;Fluids/sets data
"RTN","PSUAR6",39,0)
 .S DFLD=$P($G(PSUAMIS(PSUDV,PSUCT)),U,19)
"RTN","PSUAR6",40,0)
 .S:DFLD="" DFLD=0
"RTN","PSUAR6",41,0)
 .S $P(PSUAR("FLD",PSUDV),U,1)=$P($G(PSUAR("FLD",PSUDV)),U,1)+DFLD
"RTN","PSUAR6",42,0)
 ;
"RTN","PSUAR6",43,0)
 I PSUCAT=22 D          ;Blood products data
"RTN","PSUAR6",44,0)
 .S DBLD=$P($G(PSUAMIS(PSUDV,PSUCT)),U,19)
"RTN","PSUAR6",45,0)
 .S:DBLD="" DBLD=0
"RTN","PSUAR6",46,0)
 .S $P(PSUAR("BLD",PSUDV),U,1)=$P($G(PSUAR("BLD",PSUDV)),U,1)+DBLD
"RTN","PSUAR6",47,0)
 Q
"RTN","PSUAR6",48,0)
RET ;Calculate AR/WS returned data
"RTN","PSUAR6",49,0)
 N RET,RUNT,RFLD,RBLD
"RTN","PSUAR6",50,0)
 I PSUCAT="03 or 04" D   ;Doses data
"RTN","PSUAR6",51,0)
 .S RET=$P($G(PSUAMIS(PSUDV,PSUCT)),U,20)
"RTN","PSUAR6",52,0)
 .I RET="" S RET=0
"RTN","PSUAR6",53,0)
 .S $P(PSUAR("DSP",PSUDV),U,2)=$P($G(PSUAR("DSP",PSUDV)),U,2)+RET
"RTN","PSUAR6",54,0)
 ;
"RTN","PSUAR6",55,0)
 I PSUCAT="06 or 07" D    ;Unit data
"RTN","PSUAR6",56,0)
 .S RUNT=$P($G(PSUAMIS(PSUDV,PSUCT)),U,20)
"RTN","PSUAR6",57,0)
 .I RUNT="" S RUNT=0
"RTN","PSUAR6",58,0)
 .S $P(PSUAR("UNIT",PSUDV),U,2)=$P($G(PSUAR("UNIT",PSUDV)),U,2)+RUNT
"RTN","PSUAR6",59,0)
 ;
"RTN","PSUAR6",60,0)
 I PSUCAT=17 D          ;Fluids/sets data
"RTN","PSUAR6",61,0)
 .S RFLD=$P($G(PSUAMIS(PSUDV,PSUCT)),U,20)
"RTN","PSUAR6",62,0)
 .I RFLD="" S RFLD=0
"RTN","PSUAR6",63,0)
 .S $P(PSUAR("FLD",PSUDV),U,2)=$P($G(PSUAR("FLD",PSUDV)),U,2)+RFLD
"RTN","PSUAR6",64,0)
 ;
"RTN","PSUAR6",65,0)
 I PSUCAT=22 D          ;Blood products data
"RTN","PSUAR6",66,0)
 .S RBLD=$P($G(PSUAMIS(PSUDV,PSUCT)),U,20)
"RTN","PSUAR6",67,0)
 .I RBLD="" S RBLD=0
"RTN","PSUAR6",68,0)
 .S $P(PSUAR("BLD",PSUDV),U,2)=$P($G(PSUAR("BLD",PSUDV)),U,2)+RBLD
"RTN","PSUAR6",69,0)
 Q
"RTN","PSUAR6",70,0)
NET ;Calculate Net dispensed data
"RTN","PSUAR6",71,0)
 I PSUCAT="03 or 04" D    ;Doses data
"RTN","PSUAR6",72,0)
 .S $P(PSUAR("DSP",PSUDV),U,3)=$P(PSUAR("DSP",PSUDV),U,1)-$P(PSUAR("DSP",PSUDV),U,2)
"RTN","PSUAR6",73,0)
 ;
"RTN","PSUAR6",74,0)
 I PSUCAT="06 or 07" D    ;Unit data
"RTN","PSUAR6",75,0)
 .S $P(PSUAR("UNIT",PSUDV),U,3)=$P(PSUAR("UNIT",PSUDV),U,1)-$P(PSUAR("UNIT",PSUDV),U,2)
"RTN","PSUAR6",76,0)
 ;
"RTN","PSUAR6",77,0)
 I PSUCAT=17 D            ;Fluids/sets data
"RTN","PSUAR6",78,0)
 .S $P(PSUAR("FLD",PSUDV),U,3)=$P(PSUAR("FLD",PSUDV),U,1)-$P(PSUAR("FLD",PSUDV),U,2)
"RTN","PSUAR6",79,0)
 ;
"RTN","PSUAR6",80,0)
 I PSUCAT=22 D            ;Blood products data
"RTN","PSUAR6",81,0)
 .S $P(PSUAR("BLD",PSUDV),U,3)=$P(PSUAR("BLD",PSUDV),U,1)-$P(PSUAR("BLD",PSUDV),U,2)
"RTN","PSUAR6",82,0)
 Q
"RTN","PSUAR6",83,0)
TCOST ;Calculate total cost
"RTN","PSUAR6",84,0)
 N T1,T2
"RTN","PSUAR6",85,0)
 S PSUCA=0
"RTN","PSUAR6",86,0)
 F  S PSUCA=$O(^XTMP("PSUTCST",PSUDV,PSUCA)) Q:PSUCA=""  D
"RTN","PSUAR6",87,0)
 .I (PSUCA="03")!(PSUCA="04") D
"RTN","PSUAR6",88,0)
 ..S T1=$G(^XTMP("PSUTCST",PSUDV,"03"))
"RTN","PSUAR6",89,0)
 ..S T2=$G(^XTMP("PSUTCST",PSUDV,"04"))
"RTN","PSUAR6",90,0)
 ..S $P(PSUAR("DSP",PSUDV),U,4)=T1+T2
"RTN","PSUAR6",91,0)
 ..K T1,T2
"RTN","PSUAR6",92,0)
 .I (PSUCA="06")!(PSUCA="07") D
"RTN","PSUAR6",93,0)
 ..S T1=$G(^XTMP("PSUTCST",PSUDV,"06"))
"RTN","PSUAR6",94,0)
 ..S T2=$G(^XTMP("PSUTCST",PSUDV,"07"))
"RTN","PSUAR6",95,0)
 ..S $P(PSUAR("UNIT",PSUDV),U,4)=T1+T2
"RTN","PSUAR6",96,0)
 ..K T1,T2
"RTN","PSUAR6",97,0)
 .I PSUCA=17 D
"RTN","PSUAR6",98,0)
 ..S $P(PSUAR("FLD",PSUDV),U,4)=^XTMP("PSUTCST",PSUDV,PSUCA)
"RTN","PSUAR6",99,0)
 .I PSUCA=22 D
"RTN","PSUAR6",100,0)
 ..Q:$P($G(PSUAR("BLD",PSUDV)),U,1)=""
"RTN","PSUAR6",101,0)
 ..S $P(PSUAR("BLD",PSUDV),U,4)=^XTMP("PSUTCST",PSUDV,PSUCA)
"RTN","PSUAR6",102,0)
 Q
"RTN","PSUAR6",103,0)
AVE ;Calculate Average cost per dose
"RTN","PSUAR6",104,0)
 N NET,TOT
"RTN","PSUAR6",105,0)
 S NET=$P($G(PSUAR("DSP",PSUDV)),U,3)
"RTN","PSUAR6",106,0)
 I $G(NET)'>0 S NET=1
"RTN","PSUAR6",107,0)
 S TOT=$P($G(PSUAR("DSP",PSUDV)),U,4)
"RTN","PSUAR6",108,0)
 S $P(PSUAR("DSP",PSUDV),U,5)=TOT/NET D
"RTN","PSUAR6",109,0)
 .S TRUNC=PSUAR("DSP",PSUDV)  ;transfer node to variable
"RTN","PSUAR6",110,0)
 .D TRUNC
"RTN","PSUAR6",111,0)
 .S PSUAR("DSP",PSUDV)=TRUNC  ;transfer node back to array
"RTN","PSUAR6",112,0)
 .K TRUNC
"RTN","PSUAR6",113,0)
 .K TOT,NET
"RTN","PSUAR6",114,0)
 ;
"RTN","PSUAR6",115,0)
 I $D(PSUAR("UNIT",PSUDV)) D
"RTN","PSUAR6",116,0)
 .S NET=$P(PSUAR("UNIT",PSUDV),U,3)
"RTN","PSUAR6",117,0)
 .I $G(NET)'>0 S NET=1
"RTN","PSUAR6",118,0)
 .S TOT=$P($G(PSUAR("UNIT",PSUDV)),U,4)
"RTN","PSUAR6",119,0)
 .S $P(PSUAR("UNIT",PSUDV),U,5)=TOT/NET D
"RTN","PSUAR6",120,0)
 ..S TRUNC=PSUAR("UNIT",PSUDV)  ;transfer node to variable
"RTN","PSUAR6",121,0)
 ..D TRUNC
"RTN","PSUAR6",122,0)
 ..S PSUAR("UNIT",PSUDV)=TRUNC  ;transfer node back to array
"RTN","PSUAR6",123,0)
 ..K TRUNC
"RTN","PSUAR6",124,0)
 ..K TOT,NET
"RTN","PSUAR6",125,0)
 I '$D(PSUAR("UNIT",PSUDV)) D
"RTN","PSUAR6",126,0)
 .S PSUAR("UNIT",PSUDV)="0.00"_U_"0.00"_U_"0.00"_U_"0.00"_U_"0.00"
"RTN","PSUAR6",127,0)
 ;
"RTN","PSUAR6",128,0)
 I $D(PSUAR("FLD",PSUDV)) D
"RTN","PSUAR6",129,0)
 .S NET=$P($G(PSUAR("FLD",PSUDV)),U,3)
"RTN","PSUAR6",130,0)
 .I $G(NET)'>0 S NET=1
"RTN","PSUAR6",131,0)
 .S TOT=$P($G(PSUAR("FLD",PSUDV)),U,4)
"RTN","PSUAR6",132,0)
 .S $P(PSUAR("FLD",PSUDV),U,5)=TOT/NET D
"RTN","PSUAR6",133,0)
 ..S TRUNC=PSUAR("FLD",PSUDV)  ;transfer node to variable
"RTN","PSUAR6",134,0)
 ..D TRUNC
"RTN","PSUAR6",135,0)
 ..S PSUAR("FLD",PSUDV)=TRUNC  ;transfer node back to array
"RTN","PSUAR6",136,0)
 ..K TRUNC
"RTN","PSUAR6",137,0)
 ..K TOT,NET
"RTN","PSUAR6",138,0)
 I '$D(PSUAR("FLD",PSUDV)) D
"RTN","PSUAR6",139,0)
 .S PSUAR("FLD",PSUDV)="0.00"_U_"0.00"_U_"0.00"_U_"0.00"_U_"0.00"
"RTN","PSUAR6",140,0)
 ;
"RTN","PSUAR6",141,0)
 I $D(PSUAR("BLD",PSUDV)),$G(PSUDIV) D
"RTN","PSUAR6",142,0)
 .S NET=$P(PSUAR("BLD",PSUDV),U,3)
"RTN","PSUAR6",143,0)
 .I $G(NET)'>0 S NET=1
"RTN","PSUAR6",144,0)
 .S TOT=$P($G(PSUAR("BLD",PSUDV)),U,4)
"RTN","PSUAR6",145,0)
 .S $P(PSUAR("BLD",PSUDV),U,5)=TOT/NET D
"RTN","PSUAR6",146,0)
 ..S TRUNC=PSUAR("BLD",PSUDV)  ;transfer node to variable
"RTN","PSUAR6",147,0)
 ..D TRUNC
"RTN","PSUAR6",148,0)
 ..S PSUAR("BLD",PSUDV)=TRUNC  ;transfer node back to array
"RTN","PSUAR6",149,0)
 ..K TRUNC
"RTN","PSUAR6",150,0)
 ..K TOT,NET
"RTN","PSUAR6",151,0)
 I '$D(PSUAR("BLD",PSUDV)) D
"RTN","PSUAR6",152,0)
 .S PSUAR("BLD",PSUDV)="0.00"_U_"0.00"_U_"0.00"_U_"0.00"_U_"0.00"
"RTN","PSUAR6",153,0)
 Q
"RTN","PSUAR6",154,0)
TRUNC ;Truncate pieces with dollar values to 2 decimal places
"RTN","PSUAR6",155,0)
 ;
"RTN","PSUAR6",156,0)
 F I=1:1:5 D
"RTN","PSUAR6",157,0)
 .N A,B,C
"RTN","PSUAR6",158,0)
 .I $P(TRUNC,U,I)'["." D  Q
"RTN","PSUAR6",159,0)
 ..S $P(TRUNC,U,I)=$P(TRUNC,U,I)_".00"
"RTN","PSUAR6",160,0)
 .S A=$F($P(TRUNC,U,I),".")  ;Find first position after decimal
"RTN","PSUAR6",161,0)
 .S B=$E($P(TRUNC,U,I),1,(A-1))  ;Extract dollars and decimal
"RTN","PSUAR6",162,0)
 .S C=$E($P(TRUNC,U,I),A,(A+1))  ;Extract cents after decimal
"RTN","PSUAR6",163,0)
 .I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUAR6",164,0)
 .S $P(TRUNC,U,I)=B_C
"RTN","PSUAR6",165,0)
 Q
"RTN","PSUAR6",166,0)
TOTAL ;Calculate column totals for each division
"RTN","PSUAR6",167,0)
 ;
"RTN","PSUAR6",168,0)
 I $D(PSUAR("DSP")) D
"RTN","PSUAR6",169,0)
 .N TDSP,TRET,TNET,TCST,TAVE
"RTN","PSUAR6",170,0)
 .S PSUDIV=0                                    ;Doses data
"RTN","PSUAR6",171,0)
 .F  S PSUDIV=$O(PSUAR("DSP",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR6",172,0)
 ..S TDSP=$G(TDSP)+$P(PSUAR("DSP",PSUDIV),U,1)  ;Total dispensed
"RTN","PSUAR6",173,0)
 ..S TRET=$G(TRET)+$P(PSUAR("DSP",PSUDIV),U,2)  ;Total returned
"RTN","PSUAR6",174,0)
 ..S TNET=$G(TNET)+$P(PSUAR("DSP",PSUDIV),U,3)  ;Total of Net
"RTN","PSUAR6",175,0)
 ..S TCST=$G(TCST)+$P(PSUAR("DSP",PSUDIV),U,4)  ;Total of total costs
"RTN","PSUAR6",176,0)
 ..I $G(TNET) S TAVE=$G(TCST)/TNET D
"RTN","PSUAR6",177,0)
 ...I TAVE'["." S TAVE=TAVE_".00" Q
"RTN","PSUAR6",178,0)
 ...N A,B,C
"RTN","PSUAR6",179,0)
 ...S A=$F(TAVE,".")  ;Find 1st position after decimal
"RTN","PSUAR6",180,0)
 ...S B=$E(TAVE,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUAR6",181,0)
 ...S C=$E(TAVE,A,(A+1))   ;Extract cents after decimal
"RTN","PSUAR6",182,0)
 ...I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUAR6",183,0)
 ...S TAVE=B_C
"RTN","PSUAR6",184,0)
 ..I '$D(TAVE) S TAVE="0.00"
"RTN","PSUAR6",185,0)
 .;
"RTN","PSUAR6",186,0)
 .S TOTAL("DSP")=TDSP_U_TRET_U_TNET_U_TCST_U_TAVE D
"RTN","PSUAR6",187,0)
 ..S TRUNC=TOTAL("DSP")                         ;Transfer to variable
"RTN","PSUAR6",188,0)
 ..D TRUNC
"RTN","PSUAR6",189,0)
 ..S TOTAL("DSP")=TRUNC                         ;Transfer back to array
"RTN","PSUAR6",190,0)
 ..K TRUNC
"RTN","PSUAR6",191,0)
 ;
"RTN","PSUAR6",192,0)
 I $D(PSUAR("UNIT")) D
"RTN","PSUAR6",193,0)
 .N TDSP,TRET,TNET,TCST,TAVE
"RTN","PSUAR6",194,0)
 .S PSUDIV=0                                    ;Unit data
"RTN","PSUAR6",195,0)
 .F  S PSUDIV=$O(PSUAR("UNIT",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR6",196,0)
 ..S TDSP=$G(TDSP)+$P(PSUAR("UNIT",PSUDIV),U,1)  ;Total dispensed
"RTN","PSUAR6",197,0)
 ..S TRET=$G(TRET)+$P(PSUAR("UNIT",PSUDIV),U,2)  ;Total returned
"RTN","PSUAR6",198,0)
 ..S TNET=$G(TNET)+$P(PSUAR("UNIT",PSUDIV),U,3)  ;Total of Net
"RTN","PSUAR6",199,0)
 ..S TCST=$G(TCST)+$P(PSUAR("UNIT",PSUDIV),U,4)  ;Total of total costs
"RTN","PSUAR6",200,0)
 ..I $G(TNET) S TAVE=$G(TCST)/TNET D
"RTN","PSUAR6",201,0)
 ...I TAVE'["." S TAVE=TAVE_".00" Q
"RTN","PSUAR6",202,0)
 ...N A,B,C
"RTN","PSUAR6",203,0)
 ...S A=$F(TAVE,".")  ;Find 1st position after decimal
"RTN","PSUAR6",204,0)
 ...S B=$E(TAVE,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUAR6",205,0)
 ...S C=$E(TAVE,A,(A+1))   ;Extract cents after decimal
"RTN","PSUAR6",206,0)
 ...I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUAR6",207,0)
 ...S TAVE=B_C
"RTN","PSUAR6",208,0)
 ..I '$D(TAVE) S TAVE="0.00"
"RTN","PSUAR6",209,0)
 .S TOTAL("UNIT")=TDSP_U_TRET_U_TNET_U_TCST_U_TAVE D
"RTN","PSUAR6",210,0)
 ..S TRUNC=TOTAL("UNIT")                         ;Transfer to variable
"RTN","PSUAR6",211,0)
 ..D TRUNC
"RTN","PSUAR6",212,0)
 ..S TOTAL("UNIT")=TRUNC                         ;Transfer back to array
"RTN","PSUAR6",213,0)
 ..K TRUNC
"RTN","PSUAR6",214,0)
 ;
"RTN","PSUAR6",215,0)
 I $D(PSUAR("FLD")) D
"RTN","PSUAR6",216,0)
 .N TDSP,TRET,TNET,TCST,TAVE
"RTN","PSUAR6",217,0)
 .S PSUDIV=0                                    ;Fluid/sets data
"RTN","PSUAR6",218,0)
 .F  S PSUDIV=$O(PSUAR("FLD",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR6",219,0)
 ..S TDSP=$G(TDSP)+$P(PSUAR("FLD",PSUDIV),U,1)  ;Total dispensed
"RTN","PSUAR6",220,0)
 ..S TRET=$G(TRET)+$P(PSUAR("FLD",PSUDIV),U,2)  ;Total returned
"RTN","PSUAR6",221,0)
 ..S TNET=$G(TNET)+$P(PSUAR("FLD",PSUDIV),U,3)  ;Total of Net
"RTN","PSUAR6",222,0)
 ..S TCST=$G(TCST)+$P(PSUAR("FLD",PSUDIV),U,4)  ;Total of total costs
"RTN","PSUAR6",223,0)
 ..I $G(TNET) S TAVE=$G(TCST)/TNET D
"RTN","PSUAR6",224,0)
 ...I TAVE'["." S TAVE=TAVE_".00" Q
"RTN","PSUAR6",225,0)
 ...N A,B,C
"RTN","PSUAR6",226,0)
 ...S A=$F(TAVE,".")  ;Find 1st position after decimal
"RTN","PSUAR6",227,0)
 ...S B=$E(TAVE,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUAR6",228,0)
 ...S C=$E(TAVE,A,(A+1))   ;Extract cents after decimal
"RTN","PSUAR6",229,0)
 ...I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUAR6",230,0)
 ...S TAVE=B_C
"RTN","PSUAR6",231,0)
 ..I '$D(TAVE) S TAVE="0.00"
"RTN","PSUAR6",232,0)
 .S TOTAL("FLD")=TDSP_U_TRET_U_TNET_U_TCST_U_TAVE D
"RTN","PSUAR6",233,0)
 ..S TRUNC=TOTAL("FLD")                         ;Transfer to variable
"RTN","PSUAR6",234,0)
 ..D TRUNC
"RTN","PSUAR6",235,0)
 ..S TOTAL("FLD")=TRUNC                         ;Transfer back to array
"RTN","PSUAR6",236,0)
 ..K TRUNC
"RTN","PSUAR6",237,0)
 I '$D(PSUAR("FLD")) D
"RTN","PSUAR6",238,0)
 .S TOTAL("FLD")="0.00"_U_"0.00"_U_"0.00"_U_"0.00"_U_"0.00"
"RTN","PSUAR6",239,0)
 ;
"RTN","PSUAR6",240,0)
 ;
"RTN","PSUAR6",241,0)
 I $D(PSUAR("BLD")) D
"RTN","PSUAR6",242,0)
 .N TDSP,TRET,TNET,TCST,TAVE
"RTN","PSUAR6",243,0)
 .S PSUDIV=0                                    ;Blood data
"RTN","PSUAR6",244,0)
 .F  S PSUDIV=$O(PSUAR("BLD",PSUDIV)) Q:PSUDIV=""  D
"RTN","PSUAR6",245,0)
 ..S TDSP=$G(TDSP)+$P(PSUAR("BLD",PSUDIV),U,1)  ;Total dispensed
"RTN","PSUAR6",246,0)
 ..S TRET=$G(TRET)+$P(PSUAR("BLD",PSUDIV),U,2)  ;Total returned
"RTN","PSUAR6",247,0)
 ..S TNET=$G(TNET)+$P(PSUAR("BLD",PSUDIV),U,3)  ;Total of Net
"RTN","PSUAR6",248,0)
 ..S TCST=$G(TCST)+$P(PSUAR("BLD",PSUDIV),U,4)  ;Total of total costs
"RTN","PSUAR6",249,0)
 ..I $G(TNET) S TAVE=$G(TCST)/TNET D
"RTN","PSUAR6",250,0)
 ...I TAVE'["." S TAVE=TAVE_".00" Q
"RTN","PSUAR6",251,0)
 ...N A,B,C
"RTN","PSUAR6",252,0)
 ...S A=$F(TAVE,".")  ;Find 1st position after decimal
"RTN","PSUAR6",253,0)
 ...S B=$E(TAVE,1,(A-1))   ;Extract dollars and decimal
"RTN","PSUAR6",254,0)
 ...S C=$E(TAVE,A,(A+1))   ;Extract cents after decimal
"RTN","PSUAR6",255,0)
 ...I $L(C)'=2 S C=$E(C,1)_0
"RTN","PSUAR6",256,0)
 ...S TAVE=B_C
"RTN","PSUAR6",257,0)
 ..I '$D(TAVE) S TAVE="0.00"
"RTN","PSUAR6",258,0)
 .S TOTAL("BLD")=TDSP_U_TRET_U_TNET_U_TCST_U_TAVE D
"RTN","PSUAR6",259,0)
 ..S TRUNC=TOTAL("BLD")                         ;Transfer to variable
"RTN","PSUAR6",260,0)
 ..D TRUNC
"RTN","PSUAR6",261,0)
 ..S TOTAL("BLD")=TRUNC                         ;Transfer back to array
"RTN","PSUAR6",262,0)
 ..K TRUNC
"RTN","PSUAR6",263,0)
 I '$D(PSUAR("BLD")) D
"RTN","PSUAR6",264,0)
 .S TOTAL("BLD")="0.00"_U_"0.00"_U_"0.00"_U_"0.00"_U_"0.00"
"RTN","PSUAR6",265,0)
 Q
"RTN","PSUOP2")
0^2^B42752697^B42214911
"RTN","PSUOP2",1,0)
PSUOP2 ;BIR/CFL - PSU PBM Outpatient Pharmacy Data Collection for Version 7.0 ; 01 May 2001  10:57 AM
"RTN","PSUOP2",2,0)
 ;;4.0;PHARMACY BENEFITS MANAGEMENT;**6**;MARCH, 2005
"RTN","PSUOP2",3,0)
 ;
"RTN","PSUOP2",4,0)
 ;DBIAs
"RTN","PSUOP2",5,0)
 ; Reference to ^PSRX( file # 52 supported by DBIAs 465, 2512
"RTN","PSUOP2",6,0)
 ; Reference to EN^PSOORDER      supported by DBIA 1878
"RTN","PSUOP2",7,0)
 ; 
"RTN","PSUOP2",8,0)
 ;
"RTN","PSUOP2",9,0)
EN ;Entry to data collection
"RTN","PSUOP2",10,0)
 D ALLOOP,AMLOOP
"RTN","PSUOP2",11,0)
 K ^TMP("PSOR",$J)
"RTN","PSUOP2",12,0)
 Q
"RTN","PSUOP2",13,0)
ALLOOP ;Loop through the AL cross refererence
"RTN","PSUOP2",14,0)
 N PSUDOC1,PSUCAN,PSUCL,PSUCMP,PSUFP,PSUORDT,PSUCO
"RTN","PSUOP2",15,0)
 S PSUFDT=PSUSDT,PSUEDTM=PSUEDT_".24"
"RTN","PSUOP2",16,0)
 F  S PSUFDT=$O(^PSRX("AL",PSUFDT)) Q:PSUFDT=""!(PSUFDT>PSUEDTM)  D
"RTN","PSUOP2",17,0)
 .S PSURXIEN=""
"RTN","PSUOP2",18,0)
 .F  S PSURXIEN=$O(^PSRX("AL",PSUFDT,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP2",19,0)
 ..Q:$D(^XTMP(PSUOPSUB,"RXIEN",PSURXIEN))  ; already been processed
"RTN","PSUOP2",20,0)
 ..Q:'$D(^PSRX(PSURXIEN,0))  ; watch out for dangling pointers
"RTN","PSUOP2",21,0)
 ..S PSUCAN=$$GET1^DIQ(52,PSURXIEN,26.1,"I")   ;Cancel date
"RTN","PSUOP2",22,0)
 ..D GETS^PSUTL(52,PSURXIEN,"2;21;27","PSUOP","I")
"RTN","PSUOP2",23,0)
 ..D MOVEI^PSUTL("PSUOP")
"RTN","PSUOP2",24,0)
 ..S DFN=PSUOP(2)
"RTN","PSUOP2",25,0)
 ..;
"RTN","PSUOP2",26,0)
 ..Q:$$TESTPAT^PSUTL1(DFN)
"RTN","PSUOP2",27,0)
 ..D PID^VADPT
"RTN","PSUOP2",28,0)
 ..S PSUSSN=$TR(VA("PID"),"^-","")
"RTN","PSUOP2",29,0)
 ..N PSUPSO S PSUPSO=1   ;flag to avoid a PSO error when SIG is too long
"RTN","PSUOP2",30,0)
 ..D EN^PSOORDER(DFN,PSURXIEN)
"RTN","PSUOP2",31,0)
 ..Q:'$D(^TMP("PSOR",$J))
"RTN","PSUOP2",32,0)
 ..D EN^PSUOPAM      ;Gather AMIS data
"RTN","PSUOP2",33,0)
 ..D CMOPA ; set array of CMOP recs
"RTN","PSUOP2",34,0)
 ..D NEW ; check ^TMP to see if New Rx is in time frame, if so create record.
"RTN","PSUOP2",35,0)
 ..D REF ; check ^TMP to see if refills are in time frame, if so create records
"RTN","PSUOP2",36,0)
 ..D PAR ; check ^TMP to see if partials are in time frame, if so create records
"RTN","PSUOP2",37,0)
 Q
"RTN","PSUOP2",38,0)
 ;
"RTN","PSUOP2",39,0)
AMLOOP ; loop through "AM", partials, cross reference to see if any were missed
"RTN","PSUOP2",40,0)
 S X1=PSUSDT,X2=-1
"RTN","PSUOP2",41,0)
 D C^%DTC K %,%H,%T
"RTN","PSUOP2",42,0)
 S PSUFDT=PSUSDT,PSUEDTM=PSUEDT_".24"
"RTN","PSUOP2",43,0)
 F  S PSUFDT=$O(^PSRX("AM",PSUFDT)) Q:PSUFDT=""!(PSUFDT>PSUEDTM)  D
"RTN","PSUOP2",44,0)
 .S PSURXIEN=""
"RTN","PSUOP2",45,0)
 .F  S PSURXIEN=$O(^PSRX("AM",PSUFDT,PSURXIEN)) Q:PSURXIEN=""  D
"RTN","PSUOP2",46,0)
 ..Q:$D(^XTMP(PSUOPSUB,"RXIEN",PSURXIEN))  ; already been processed
"RTN","PSUOP2",47,0)
 ..Q:'$D(^PSRX(PSURXIEN,0))  ; watch out for dangling pointers
"RTN","PSUOP2",48,0)
 ..D GETS^PSUTL(52,PSURXIEN,"2;27","PSUOP","I")
"RTN","PSUOP2",49,0)
 ..D MOVEI^PSUTL("PSUOP")
"RTN","PSUOP2",50,0)
 ..S DFN=PSUOP(2)
"RTN","PSUOP2",51,0)
 ..; SCREEN OUT TEST PATIENTS
"RTN","PSUOP2",52,0)
 ..Q:$$TESTPAT^PSUTL1(DFN)
"RTN","PSUOP2",53,0)
 ..D PID^VADPT
"RTN","PSUOP2",54,0)
 ..S PSUSSN=$TR(VA("PID"),"^-","")
"RTN","PSUOP2",55,0)
 ..D EN^PSOORDER(DFN,PSURXIEN)
"RTN","PSUOP2",56,0)
 ..D EN^PSUOPAM      ;Gather AMIS data   PSU*4*5 fix
"RTN","PSUOP2",57,0)
 ..D PAR ; check ^TMP to see if partials are in time frame, if so create records
"RTN","PSUOP2",58,0)
 Q
"RTN","PSUOP2",59,0)
 ;
"RTN","PSUOP2",60,0)
NEW ; New Rx
"RTN","PSUOP2",61,0)
 S PSUFD=$P(^TMP("PSOR",$J,PSURXIEN,0),U,2)
"RTN","PSUOP2",62,0)
 D COMVAR
"RTN","PSUOP2",63,0)
 S PSUTYP="N"
"RTN","PSUOP2",64,0)
 S PSUCMOP=$S($D(PSUCMA(0)):"Y",1:"N")
"RTN","PSUOP2",65,0)
 S PSUR0=^TMP("PSOR",$J,PSURXIEN,0)
"RTN","PSUOP2",66,0)
 S PSUORDT=$P(PSUR0,U,17)     ;AMIS Original Login Date
"RTN","PSUOP2",67,0)
 S PSUQTY=+$P(PSUR0,U,6)
"RTN","PSUOP2",68,0)
 ;
"RTN","PSUOP2",69,0)
 ;
"RTN","PSUOP2",70,0)
 S PSUDS=$P(PSUR0,U,7)
"RTN","PSUOP2",71,0)
 S PSUDRCT=$P(PSUR0,U,10)
"RTN","PSUOP2",72,0)
 S PSURELDT=$P($P(PSUR0,U,13),".",1)
"RTN","PSUOP2",73,0)
 Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",74,0)
 S PSUWPC=$E($P(PSUR0,U,15))
"RTN","PSUOP2",75,0)
NEWX1 ;I PSUCMOP="Y" Q:((PSURELDT="")!(PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",76,0)
NEWX2 ;I PSUCMOP="N",((PSUFD<PSUSDT)!(PSUFD\1>PSUEDT)) Q
"RTN","PSUOP2",77,0)
 S PSUR1=^TMP("PSOR",$J,PSURXIEN,1)
"RTN","PSUOP2",78,0)
 S PSUCLN=$P($P(PSUR1,U,4),";",2)          ;AMIS data clinic
"RTN","PSUOP2",79,0)
 S PSUFP=$P($P(PSUR1,U,9),";",1)           ;AMIS finishing person
"RTN","PSUOP2",80,0)
 S PSUPRID=$P($P(PSUR1,U,1),";",1)
"RTN","PSUOP2",81,0)
 S PSURXP=$P($P(PSUR1,U,5),";",1)
"RTN","PSUOP2",82,0)
 S PSUMW=$P($P(PSUR1,U,6),";",1)
"RTN","PSUOP2",83,0)
 S PSUDIVP=$P(PSUR1,U,7)
"RTN","PSUOP2",84,0)
 ;
"RTN","PSUOP2",85,0)
 S PSUNDC=""
"RTN","PSUOP2",86,0)
 I PSUCMOP="Y" S PSUNDC=PSUCMA(0)
"RTN","PSUOP2",87,0)
 I PSUNDC="" S PSUNDC=$S($L(PSUOP(27)):PSUOP(27),$L(PSUDRUG(31)):PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",88,0)
 D PROVDR^PSUOP3
"RTN","PSUOP2",89,0)
 D SETREC^PSUOP3
"RTN","PSUOP2",90,0)
NEWQ Q
"RTN","PSUOP2",91,0)
 ;
"RTN","PSUOP2",92,0)
REF ; Refills
"RTN","PSUOP2",93,0)
 Q:'$D(^TMP("PSOR",$J,PSURXIEN,"REF"))
"RTN","PSUOP2",94,0)
 D COMVAR
"RTN","PSUOP2",95,0)
 S PSUFLN=""
"RTN","PSUOP2",96,0)
 F  S PSUFLN=$O(^TMP("PSOR",$J,PSURXIEN,"REF",PSUFLN)) Q:PSUFLN=""  D
"RTN","PSUOP2",97,0)
 .S PSUTYP="R"
"RTN","PSUOP2",98,0)
 .S PSUCMOP=$S($D(PSUCMA(PSUFLN)):"Y",1:"N")
"RTN","PSUOP2",99,0)
 .S PSUR0=^TMP("PSOR",$J,PSURXIEN,"REF",PSUFLN,0)
"RTN","PSUOP2",100,0)
 .S PSUWPC="N"
"RTN","PSUOP2",101,0)
 .S PSUFD=$P(PSUR0,U,1)
"RTN","PSUOP2",102,0)
 .S PSUPRID=$P($P(PSUR0,U,2),";",1)
"RTN","PSUOP2",103,0)
 .S PSUQTY=+$P(PSUR0,U,4)
"RTN","PSUOP2",104,0)
 .S PSUDS=$P(PSUR0,U,5)
"RTN","PSUOP2",105,0)
 .S PSUDRCT=$P(PSUR0,U,6)
"RTN","PSUOP2",106,0)
 .S PSURELDT=$P(PSUR0,U,8)
"RTN","PSUOP2",107,0)
 .Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",108,0)
 .S PSUMW=$P($P(PSUR0,U,10),";",1)
"RTN","PSUOP2",109,0)
 .S PSUDIVP=$P(PSUR0,U,11)
"RTN","PSUOP2",110,0)
 .S PSUREDT=$P(PSUR0,U,12)     ;AMIS Refill Login Date
"RTN","PSUOP2",111,0)
 .I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP2",112,0)
 .;I PSUCMOP="Y" Q:((PSURELDT="")!(PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",113,0)
 .;I PSUCMOP="N",((PSUFD<PSUSDT)!(PSUFD\1>PSUEDT)) Q
"RTN","PSUOP2",114,0)
 .S PSUNDC=""
"RTN","PSUOP2",115,0)
 .I PSUCMOP="Y" S PSUNDC=PSUCMA(PSUFLN)
"RTN","PSUOP2",116,0)
 .I PSUNDC="" S PSUNDC=$$VALI^PSUTL(52.1,PSURXIEN,11)
"RTN","PSUOP2",117,0)
 .I PSUNDC="" S PSUNDC=$S(PSUDRUG(31)'="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",118,0)
 .;
"RTN","PSUOP2",119,0)
 .D PROVDR^PSUOP3
"RTN","PSUOP2",120,0)
 .D SETREC^PSUOP3
"RTN","PSUOP2",121,0)
REFQ Q
"RTN","PSUOP2",122,0)
 ;
"RTN","PSUOP2",123,0)
PAR ; Partials
"RTN","PSUOP2",124,0)
 Q:'$D(^TMP("PSOR",$J,PSURXIEN,"RPAR"))
"RTN","PSUOP2",125,0)
 D COMVAR
"RTN","PSUOP2",126,0)
 S PSUFLN=""
"RTN","PSUOP2",127,0)
 F  S PSUFLN=$O(^TMP("PSOR",$J,PSURXIEN,"RPAR",PSUFLN)) Q:PSUFLN=""  D
"RTN","PSUOP2",128,0)
 .S PSUR0=^TMP("PSOR",$J,PSURXIEN,"RPAR",PSUFLN,0)
"RTN","PSUOP2",129,0)
 .S PSUTYP="P"
"RTN","PSUOP2",130,0)
 .S PSUCMOP="N"
"RTN","PSUOP2",131,0)
 .S PSUWPC="N"
"RTN","PSUOP2",132,0)
 .S PSUFD=$P(PSUR0,U,1)
"RTN","PSUOP2",133,0)
 .;I (PSUFD<PSUSDT)!(PSUFD\1>PSUEDT) Q
"RTN","PSUOP2",134,0)
 .S PSUPRID=$P($P(PSUR0,U,2),";",1)
"RTN","PSUOP2",135,0)
 .S PSUQTY=+$P(PSUR0,U,4)
"RTN","PSUOP2",136,0)
 .S PSUDS=$P(PSUR0,U,5)
"RTN","PSUOP2",137,0)
 .S PSUDRCT=$P(PSUR0,U,6)
"RTN","PSUOP2",138,0)
 .S PSURELDT=$P(PSUR0,U,8)
"RTN","PSUOP2",139,0)
 .S PSUMW=$P($P(PSUR0,U,10),";",1)
"RTN","PSUOP2",140,0)
 .S PSUDIVP=$P(PSUR0,U,11)
"RTN","PSUOP2",141,0)
 .S PSUPDT=$P(PSUR0,U,12)       ;AMIS Partial Login Date
"RTN","PSUOP2",142,0)
 .I PSURELDT'="" S PSURELDT=PSURELDT\1
"RTN","PSUOP2",143,0)
 .Q:((PSURELDT<PSUSDT)!(PSURELDT>PSUEDTM))
"RTN","PSUOP2",144,0)
 .S PSUNDC=$$VALI^PSUTL(52.2,PSURXIEN,1)
"RTN","PSUOP2",145,0)
 .I PSUNDC="" S PSUNDC=$S(PSUDRUG(31)'="":PSUDRUG(31),1:"No NDC")
"RTN","PSUOP2",146,0)
 .;
"RTN","PSUOP2",147,0)
 .D PROVDR^PSUOP3
"RTN","PSUOP2",148,0)
 .D SETREC^PSUOP3
"RTN","PSUOP2",149,0)
PARQ Q
"RTN","PSUOP2",150,0)
 ;
"RTN","PSUOP2",151,0)
COMVAR ; set variables that are common between all record types
"RTN","PSUOP2",152,0)
 S PSUDR=$P($P(^TMP("PSOR",$J,PSURXIEN,"DRUG",0),U,1),";",1)
"RTN","PSUOP2",153,0)
 ;S CMOPID=$P($G(^PSDRUG(PSUDR,"ND")),U,10)     ;AMIS CMOP ID
"RTN","PSUOP2",154,0)
 S PSUSIG=$P($G(^TMP("PSOR",$J,PSURXIEN,"SIG",1,0)),U,1)
"RTN","PSUOP2",155,0)
 S PSURXP=$P($P(^TMP("PSOR",$J,PSURXIEN,1),U,5),";",1)
"RTN","PSUOP2",156,0)
 S PSURXN=$P(^TMP("PSOR",$J,PSURXIEN,0),U,5)
"RTN","PSUOP2",157,0)
 D GETDRUG^PSUOP3 ; loads data from file #50 using PSUDR as ien
"RTN","PSUOP2",158,0)
COMVARQ Q
"RTN","PSUOP2",159,0)
 ;
"RTN","PSUOP2",160,0)
CMOPA ; set array of CMOP recs
"RTN","PSUOP2",161,0)
 K PSUCMA
"RTN","PSUOP2",162,0)
 N PSUR1,PSUX,PSUST,PSUFIL,PSUNDC
"RTN","PSUOP2",163,0)
 S PSUX=""
"RTN","PSUOP2",164,0)
 F  S PSUX=$O(^TMP("PSOR",$J,PSURXIEN,"CMOP",PSUX)) Q:PSUX=""  D
"RTN","PSUOP2",165,0)
 .S PSUR1=^TMP("PSOR",$J,PSURXIEN,"CMOP",PSUX,0)
"RTN","PSUOP2",166,0)
 .F X="PSUFIL^3","PSUST^4","PSUNDC^6" D PIECE(X,PSUR1,U)
"RTN","PSUOP2",167,0)
 .S:+PSUST=1 PSUCMA(PSUFIL)=PSUNDC
"RTN","PSUOP2",168,0)
 .K:+PSUST=3 PSUCMA(PSUFIL)
"RTN","PSUOP2",169,0)
 .D:$D(PSUCMA(PSUFIL)) RTSTOCK
"RTN","PSUOP2",170,0)
CMOPAQ Q
"RTN","PSUOP2",171,0)
 ;
"RTN","PSUOP2",172,0)
RTSTOCK ; test for "AR" if none then unmark CMOP
"RTN","PSUOP2",173,0)
 ; needs PSURXIEN, PSUFIL, from CMOPA
"RTN","PSUOP2",174,0)
 N PSURELDT,PSUR0,PSURTSDT
"RTN","PSUOP2",175,0)
 I PSUFIL D  Q
"RTN","PSUOP2",176,0)
 . S PSUR0=$G(^TMP("PSOR",$J,PSURXIEN,"REF",PSUFIL,0))
"RTN","PSUOP2",177,0)
 . F X="PSURELDT^8","PSURTSDT^9" D PIECE(X,PSUR0,U)
"RTN","PSUOP2",178,0)
 . I PSURELDT,$D(^PSRX("AR",PSURELDT,PSURXIEN,PSUFIL)) Q
"RTN","PSUOP2",179,0)
 . K PSUCMA(PSUFIL)
"RTN","PSUOP2",180,0)
 ;
"RTN","PSUOP2",181,0)
 S PSUR0=^TMP("PSOR",$J,PSURXIEN,0)
"RTN","PSUOP2",182,0)
 F X="PSURELDT^13","PSURTSDT^14" D PIECE(X,PSUR0,U)
"RTN","PSUOP2",183,0)
 I PSURELDT,$D(^PSRX("AR",PSURELDT,PSURXIEN,PSUFIL)) Q
"RTN","PSUOP2",184,0)
 I $D(PSUCMA(PSUFIL)) K PSUCMA(PSUFIL)
"RTN","PSUOP2",185,0)
 Q
"RTN","PSUOP2",186,0)
PIECE(%,REC,DLM) ;Piece % from record REC using delimiter DLM
"RTN","PSUOP2",187,0)
 ; %="VARNAME^PIECE",REC=SOURCE,DLM=DELIMITER in REC
"RTN","PSUOP2",188,0)
 N Y,I S Y=$P(%,U,1),I=$P(%,U,2) S @Y=$P(REC,DLM,I)
"RTN","PSUOP2",189,0)
 Q
"RTN","PSUOP2",190,0)
 ;
"VER")
8.0^22.0
"BLD",5546,6)
^4
**END**
**END**
