Released DG*5.3*520 SEQ #532
Extracted from mail message
**KIDS**:DG*5.3*520^

**INSTALL NAME**
DG*5.3*520
"BLD",1777,0)
DG*5.3*520^REGISTRATION^0^3040914^y
"BLD",1777,1,0)
^^3^3^3040709^
"BLD",1777,1,1,0)
SUPPORT FOR HDR
"BLD",1777,1,2,0)
Refer to patch DG*5.3*520 in the FORUM Patch Module for a complete
"BLD",1777,1,3,0)
description.
"BLD",1777,4,0)
^9.64PA^^0
"BLD",1777,"ABNS",0)
^9.66A^^
"BLD",1777,"ABPKG")
n^n^
"BLD",1777,"INID")
^
"BLD",1777,"INIT")

"BLD",1777,"KRN",0)
^9.67PA^8989.52^19
"BLD",1777,"KRN",.4,0)
.4
"BLD",1777,"KRN",.4,"NM",0)
^9.68A^^
"BLD",1777,"KRN",.401,0)
.401
"BLD",1777,"KRN",.402,0)
.402
"BLD",1777,"KRN",.403,0)
.403
"BLD",1777,"KRN",.5,0)
.5
"BLD",1777,"KRN",.84,0)
.84
"BLD",1777,"KRN",3.6,0)
3.6
"BLD",1777,"KRN",3.8,0)
3.8
"BLD",1777,"KRN",9.2,0)
9.2
"BLD",1777,"KRN",9.8,0)
9.8
"BLD",1777,"KRN",9.8,"NM",0)
^9.68A^5^3
"BLD",1777,"KRN",9.8,"NM",3,0)
VAFCTFIN^^0^B24477543
"BLD",1777,"KRN",9.8,"NM",4,0)
VAFCTFPR^^0^B22416094
"BLD",1777,"KRN",9.8,"NM",5,0)
VAFCTFU^^0^B59884823
"BLD",1777,"KRN",9.8,"NM","B","VAFCTFIN",3)

"BLD",1777,"KRN",9.8,"NM","B","VAFCTFPR",4)

"BLD",1777,"KRN",9.8,"NM","B","VAFCTFU",5)

"BLD",1777,"KRN",19,0)
19
"BLD",1777,"KRN",19.1,0)
19.1
"BLD",1777,"KRN",101,0)
101
"BLD",1777,"KRN",101,"NM",0)
^9.68A^^0
"BLD",1777,"KRN",409.61,0)
409.61
"BLD",1777,"KRN",771,0)
771
"BLD",1777,"KRN",870,0)
870
"BLD",1777,"KRN",8989.51,0)
8989.51
"BLD",1777,"KRN",8989.52,0)
8989.52
"BLD",1777,"KRN",8994,0)
8994
"BLD",1777,"KRN","B",.4,.4)

"BLD",1777,"KRN","B",.401,.401)

"BLD",1777,"KRN","B",.402,.402)

"BLD",1777,"KRN","B",.403,.403)

"BLD",1777,"KRN","B",.5,.5)

"BLD",1777,"KRN","B",.84,.84)

"BLD",1777,"KRN","B",3.6,3.6)

"BLD",1777,"KRN","B",3.8,3.8)

"BLD",1777,"KRN","B",9.2,9.2)

"BLD",1777,"KRN","B",9.8,9.8)

"BLD",1777,"KRN","B",19,19)

"BLD",1777,"KRN","B",19.1,19.1)

"BLD",1777,"KRN","B",101,101)

"BLD",1777,"KRN","B",409.61,409.61)

"BLD",1777,"KRN","B",771,771)

"BLD",1777,"KRN","B",870,870)

"BLD",1777,"KRN","B",8989.51,8989.51)

"BLD",1777,"KRN","B",8989.52,8989.52)

"BLD",1777,"KRN","B",8994,8994)

"BLD",1777,"QUES",0)
^9.62^^
"BLD",1777,"REQB",0)
^9.611^1^1
"BLD",1777,"REQB",1,0)
DG*5.3*474^1
"BLD",1777,"REQB","B","DG*5.3*474",1)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813^2970721^12541
"PKG",5,22,1,"PAH",1,0)
520^3040914
"PKG",5,22,1,"PAH",1,1,0)
^^3^3^3040914
"PKG",5,22,1,"PAH",1,1,1,0)
SUPPORT FOR HDR
"PKG",5,22,1,"PAH",1,1,2,0)
Refer to patch DG*5.3*520 in the FORUM Patch Module for a complete
"PKG",5,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","VAFCTFIN")
0^3^B24477543
"RTN","VAFCTFIN",1,0)
VAFCTFIN ;BIR/DR-TREATING FACILTIY MFU PROCESSING ROUTINE ;11/09/01
"RTN","VAFCTFIN",2,0)
 ;;5.3;Registration;**428,474,520**;Aug 13, 1993
"RTN","VAFCTFIN",3,0)
 ;Reference to EXC, START, and STOP^RGHLLOG supported by IA #2796
"RTN","VAFCTFIN",4,0)
 ;
"RTN","VAFCTFIN",5,0)
IN ;This entry point is used to process the Treating Facility Master File Update Message.
"RTN","VAFCTFIN",6,0)
 ;It is called by the VAFC MFN-M05 CLIENT processing routine when a MFN
"RTN","VAFCTFIN",7,0)
 ;message is received.
"RTN","VAFCTFIN",8,0)
 ;There are no inputs or outputs
"RTN","VAFCTFIN",9,0)
 ;
"RTN","VAFCTFIN",10,0)
 I HL("MTN")="MFK" D RSP Q
"RTN","VAFCTFIN",11,0)
 N VAFC,STATN,VAFCI,MSG,SG,VAFCARR,PDFN,INST,MFUPT,PDLT,TFIEN
"RTN","VAFCTFIN",12,0)
 N ICN,MFI,MFE,MFA,HLCOMP,CNT,X,VAFCERR,VAFCX
"RTN","VAFCTFIN",13,0)
 ;quit if Master Patient Index (MPI) is not installed
"RTN","VAFCTFIN",14,0)
 S X="MPIF001" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFIN",15,0)
 S X="MPIFQ0" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFIN",16,0)
 S X="RGRSBUL1" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFIN",17,0)
 S X="RGRSBULL" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFIN",18,0)
INIT ;Process in the Treating Facility MFN msg
"RTN","VAFCTFIN",19,0)
 F VAFCI=1:1 X HLNEXT Q:HLQUIT'>0  S (MSG,VAFC(VAFCI))=HLNODE,SG=$E(HLNODE,1,3) D:SG?2A1(1A,1N) PICK
"RTN","VAFCTFIN",20,0)
 ;reconcil the inbound TF list from the MPI to the local TF list
"RTN","VAFCTFIN",21,0)
 D RECONCIL
"RTN","VAFCTFIN",22,0)
 ;create response message
"RTN","VAFCTFIN",23,0)
 S CNT=1
"RTN","VAFCTFIN",24,0)
 S HLA("HLA",1)="MSA"_HL("FS")_"AA"_HL("FS")_HL("MID")_HL("FS") S CNT=CNT+1
"RTN","VAFCTFIN",25,0)
 S HLA("HLA",CNT)=MFI S CNT=CNT+1
"RTN","VAFCTFIN",26,0)
 S VAFCX=0 F  S VAFCX=$O(MFE(VAFCX)) Q:'VAFCX  S HLA("HLA",CNT)=MFE(VAFCX),CNT=CNT+1,HLA("HLA",CNT)=MFA(VAFCX),CNT=CNT+1
"RTN","VAFCTFIN",27,0)
 ;generate an application level ack (MFK) identifying the status of the adds/edits/deletes of TF's passed in
"RTN","VAFCTFIN",28,0)
 D ROUTE
"RTN","VAFCTFIN",29,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.VAFCERR,"",.HLP)
"RTN","VAFCTFIN",30,0)
 Q
"RTN","VAFCTFIN",31,0)
PICK ;check routine for segment entry point
"RTN","VAFCTFIN",32,0)
 I $T(@SG)]"" D @SG
"RTN","VAFCTFIN",33,0)
 I $T(@SG)="" Q
"RTN","VAFCTFIN",34,0)
 Q
"RTN","VAFCTFIN",35,0)
MSH ;;MSH
"RTN","VAFCTFIN",36,0)
 ;process the MSH segment
"RTN","VAFCTFIN",37,0)
 S (HLFS,HL("FS"))=$E(MSG,4),(HLECH,HL("ECH"))=$E(MSG,5,8)
"RTN","VAFCTFIN",38,0)
 S HLCOMP=$E(HL("ECH"),1)
"RTN","VAFCTFIN",39,0)
 S VAFCARR("SENDING SITE")=$P(MSG,HL("FS"),4)
"RTN","VAFCTFIN",40,0)
 Q
"RTN","VAFCTFIN",41,0)
EVN ;;EVN
"RTN","VAFCTFIN",42,0)
 ;process the EVN segment
"RTN","VAFCTFIN",43,0)
 S STATN=+$$SITE^VASITE()_"^"_$$FMDATE^HLFNC($P(MSG,HL("FS"),3))
"RTN","VAFCTFIN",44,0)
 Q
"RTN","VAFCTFIN",45,0)
PID ;;PID
"RTN","VAFCTFIN",46,0)
 ;process the PID segment
"RTN","VAFCTFIN",47,0)
 S PDFN=+$P(MSG,HL("FS"),4)
"RTN","VAFCTFIN",48,0)
 Q
"RTN","VAFCTFIN",49,0)
MFI ;;MFI
"RTN","VAFCTFIN",50,0)
 ;process the MFI segment
"RTN","VAFCTFIN",51,0)
 S MFI=MSG
"RTN","VAFCTFIN",52,0)
 S MFUPT=$P(MSG,HL("FS"),2)
"RTN","VAFCTFIN",53,0)
 S VAFCARR("CMOR")=$P($P(MSG,HL("FS"),8),$E(HL("ECH"),1))
"RTN","VAFCTFIN",54,0)
 Q
"RTN","VAFCTFIN",55,0)
MFE ;;MFE
"RTN","VAFCTFIN",56,0)
 ;process the MFE segment
"RTN","VAFCTFIN",57,0)
 N HLCOMP,NXTSGMT,TYPE
"RTN","VAFCTFIN",58,0)
 S HLCOMP=$E(HL("ECH"),1)
"RTN","VAFCTFIN",59,0)
 S PDLT=$$FMDATE^HLFNC($P(MSG,HL("FS"),4))
"RTN","VAFCTFIN",60,0)
 S ICN=$P($P(MSG,HL("FS"),5),HLCOMP,4)
"RTN","VAFCTFIN",61,0)
 S INST=$P($P(MSG,HL("FS"),5),HLCOMP)
"RTN","VAFCTFIN",62,0)
 S TYPE=$P(MSG,HL("FS"),2)
"RTN","VAFCTFIN",63,0)
 S MFE(INST)=MSG
"RTN","VAFCTFIN",64,0)
 S MFI(ICN,INST)=PDLT_"^^"_TYPE
"RTN","VAFCTFIN",65,0)
 Q
"RTN","VAFCTFIN",66,0)
ZET ;;ZET
"RTN","VAFCTFIN",67,0)
 ;process Patient's Date Last Treated Event Type, ZET segment
"RTN","VAFCTFIN",68,0)
 N PDLTET
"RTN","VAFCTFIN",69,0)
 S PDLTET=$P(MSG,HL("FS"),2)
"RTN","VAFCTFIN",70,0)
 S $P(MFI(ICN,INST),"^",2)=PDLTET
"RTN","VAFCTFIN",71,0)
 Q
"RTN","VAFCTFIN",72,0)
RSP ;response process logic entry point
"RTN","VAFCTFIN",73,0)
 Q
"RTN","VAFCTFIN",74,0)
ROUTE ;routing logic entry point
"RTN","VAFCTFIN",75,0)
 N MPI
"RTN","VAFCTFIN",76,0)
 S MPI=$$MPILINK^MPIFAPI() D
"RTN","VAFCTFIN",77,0)
 .I $P($G(MPI),U)'=-1 S HLL("LINKS",1)="VAFC MFN-M05 CLIENT"_"^"_MPI
"RTN","VAFCTFIN",78,0)
 .I $P($G(MPI),U)=-1 D
"RTN","VAFCTFIN",79,0)
 .. N RGLOG D START^RGHLLOG(HLMTIEN,"","")
"RTN","VAFCTFIN",80,0)
 .. D EXC^RGHLLOG(224,"No MPI link identified in CIRN SITE PARAMETER file (#991.8)",$G(PDFN))
"RTN","VAFCTFIN",81,0)
 .. D STOP^RGHLLOG(0)
"RTN","VAFCTFIN",82,0)
 Q
"RTN","VAFCTFIN",83,0)
TEST ;
"RTN","VAFCTFIN",84,0)
 W $$REPROC^HLUTIL(39266,"D IN^VAFCTFIN")
"RTN","VAFCTFIN",85,0)
 Q
"RTN","VAFCTFIN",86,0)
RECONCIL ;
"RTN","VAFCTFIN",87,0)
 N DFN,MFIC,VAFCX,VAFCY,TFL,CNFLT,LOCCMOR,VAFCTYPE
"RTN","VAFCTFIN",88,0)
 S CNFLT=0
"RTN","VAFCTFIN",89,0)
 S DFN=$$GETDFN^MPIF001(ICN)
"RTN","VAFCTFIN",90,0)
 I DFN'>0 S CNFLT=1_"^"_$P($G(DFN),"^",2)
"RTN","VAFCTFIN",91,0)
 I +CNFLT=0 S LOCCMOR=$$GETVCCI^MPIF001(DFN) I VAFCARR("CMOR")'=LOCCMOR S CNFLT=1_"^"_"CMOR conflict MPI CMOR="_VAFCARR("CMOR")_" LOC CMOR="_LOCCMOR
"RTN","VAFCTFIN",92,0)
 I MFUPT="REP" I +CNFLT=0 D TFL^VAFCTFU1(.TFL,DFN) S VAFCX=0 F  S VAFCX=$O(TFL(VAFCX)) Q:'VAFCX  D
"RTN","VAFCTFIN",93,0)
 . S MFIC($P(TFL(VAFCX),"^"))=TFL(VAFCX) I '$D(MFI(ICN,$P(TFL(VAFCX),"^"))) D DEL(ICN,$P(TFL(VAFCX),"^"))
"RTN","VAFCTFIN",94,0)
 ;VAFCX=ICN and VAFCY=INSTITUTION
"RTN","VAFCTFIN",95,0)
 S VAFCX=0 F  S VAFCX=$O(MFI(VAFCX)) Q:'VAFCX  D
"RTN","VAFCTFIN",96,0)
 . S VAFCY=0 F  S VAFCY=$O(MFI(VAFCX,VAFCY)) Q:'VAFCY  D
"RTN","VAFCTFIN",97,0)
 ..S VAFCTYPE=$P(MFI(VAFCX,VAFCY),"^",3)
"RTN","VAFCTFIN",98,0)
 ..I +CNFLT=1 S MFA(VAFCY)="MFA"_HL("FS")_VAFCTYPE_HL("FS")_VAFCY_HL("FS")_$$HLDATE^HLFNC($$NOW^XLFDT)_HL("FS")_"U"_HLCOMP_$S(VAFCTYPE="MDL":"Delete of ",1:"Update of ")_VAFCY_" Failed at "_$P($$SITE^VASITE,"^",3)_" due to "_$P(CNFLT,"^",2)
"RTN","VAFCTFIN",99,0)
 ..I +CNFLT=0 I VAFCTYPE="MAD"!(VAFCTYPE="MUP") D ADDUPD(DFN,VAFCY,$P(MFI(VAFCX,VAFCY),"^"),$P(MFI(VAFCX,VAFCY),"^",2))
"RTN","VAFCTFIN",100,0)
 ..I +CNFLT=0 I VAFCTYPE="MDL" D DEL(ICN,VAFCY)
"RTN","VAFCTFIN",101,0)
 Q
"RTN","VAFCTFIN",102,0)
ADDUPD(DFN,INST,PDLT,PDLRTET) ;add or update TF entry
"RTN","VAFCTFIN",103,0)
 N ERROR,STA
"RTN","VAFCTFIN",104,0)
 S STA=INST
"RTN","VAFCTFIN",105,0)
 S INST=$$LKUP^XUAF4(INST)
"RTN","VAFCTFIN",106,0)
 D FILE^VAFCTFU(DFN,INST_"^"_$G(PDLT)_"^"_$G(PDLRTET),1,1,.ERROR)
"RTN","VAFCTFIN",107,0)
 S MFA(STA)="MFA"_HL("FS")_"MUP"_HL("FS")_STA_HL("FS")_$$HLDATE^HLFNC($$NOW^XLFDT)_HL("FS")
"RTN","VAFCTFIN",108,0)
 I '$D(ERROR(STA)) S MFA(STA)=MFA(STA)_"S"
"RTN","VAFCTFIN",109,0)
 I $D(ERROR(STA)) S MFA(STA)=MFA(STA)_"U"_HLCOMP_ERROR(STA)_HL("FS")
"RTN","VAFCTFIN",110,0)
 Q
"RTN","VAFCTFIN",111,0)
DEL(ICN,INST) ;delete a TF entry
"RTN","VAFCTFIN",112,0)
 N ERROR,STA
"RTN","VAFCTFIN",113,0)
 S STA=INST
"RTN","VAFCTFIN",114,0)
 S INST=$$LKUP^XUAF4(INST)
"RTN","VAFCTFIN",115,0)
 S ERROR=$$DELETETF^VAFCTFU(ICN,INST)
"RTN","VAFCTFIN",116,0)
 S MFA(STA)="MFA"_HL("FS")_"MDL"_HL("FS")_STA_HL("FS")_$$HLDATE^HLFNC($$NOW^XLFDT)_HL("FS")
"RTN","VAFCTFIN",117,0)
 I +ERROR'=1 S MFA(STA)=MFA(STA)_"S"
"RTN","VAFCTFIN",118,0)
 I +ERROR=1 S MFA(STA)=MFA(STA)_"U"_HLCOMP_"Delete Failed: "_$P(ERROR,"^",2)
"RTN","VAFCTFIN",119,0)
 Q
"RTN","VAFCTFPR")
0^4^B22416094
"RTN","VAFCTFPR",1,0)
VAFCTFPR ;ALB/JLU,CML-MFU PROCESSING ROUTINE ;06/25/98
"RTN","VAFCTFPR",2,0)
 ;;5.3;Registration;**149,261,255,307,414,474,520**;Aug 13, 1993
"RTN","VAFCTFPR",3,0)
 ;Reference to EXC^RGHLLOG and START^RGHLLOG supported by IA #2796
"RTN","VAFCTFPR",4,0)
 ;
"RTN","VAFCTFPR",5,0)
EN ;This entry point is used to process the Master File Update Message.
"RTN","VAFCTFPR",6,0)
 ;It is called by the VAFC MFU-TFL ClIENT when a MFU message is received
"RTN","VAFCTFPR",7,0)
 ;There are no inputs or outputs
"RTN","VAFCTFPR",8,0)
 ;
"RTN","VAFCTFPR",9,0)
 ;quit if Master Patient Index (MPI) is not installed
"RTN","VAFCTFPR",10,0)
 S X="MPIF001" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFPR",11,0)
 S X="MPIFQ0" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFPR",12,0)
 S X="RGRSBUL1" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFPR",13,0)
 S X="RGRSBULL" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFPR",14,0)
 K X N ICN,PDFN,TYPE,VAFCER,VAFCARR,SG
"RTN","VAFCTFPR",15,0)
 N VAFC,MFNQUIT,VAFCI,MSG,MFUPT,INST,PDLT,VAFCTFT
"RTN","VAFCTFPR",16,0)
MFN ;Read Treating Facility MFN M05 (PROCESS LOGIC) msg into VAFC()
"RTN","VAFCTFPR",17,0)
 F VAFCI=1:1 X HLNEXT Q:HLQUIT'>0  S VAFC(VAFCI)=HLNODE
"RTN","VAFCTFPR",18,0)
MFNP ;Process in the TF updates messages
"RTN","VAFCTFPR",19,0)
 S VAFCI="" F  S VAFCI=$O(VAFC(VAFCI)) Q:'VAFCI!($G(MFNQUIT)=1)  S MSG=VAFC(VAFCI),SG=$E(MSG,1,3) D:SG?2A1(1A,1N) PICK
"RTN","VAFCTFPR",20,0)
 Q
"RTN","VAFCTFPR",21,0)
INIT ;Process in the ADT A04/A08 (routing logic)
"RTN","VAFCTFPR",22,0)
 F VAFCI=1:1 X HLNEXT Q:HLQUIT'>0  S (MSG,VAFC(VAFCI))=HLNODE,SG=$E(HLNODE,1,3) D:SG?2A1(1A,1N) PICK
"RTN","VAFCTFPR",23,0)
 Q
"RTN","VAFCTFPR",24,0)
PICK ;check routine for segment entry point
"RTN","VAFCTFPR",25,0)
 I $T(@SG)]"" D @SG
"RTN","VAFCTFPR",26,0)
 I $T(@SG)="" Q
"RTN","VAFCTFPR",27,0)
 Q
"RTN","VAFCTFPR",28,0)
MSH ;;MSH
"RTN","VAFCTFPR",29,0)
 ;process the MSH segment
"RTN","VAFCTFPR",30,0)
 D START^RGHLLOG($G(HLMTIENS))
"RTN","VAFCTFPR",31,0)
 S (HLFS,HL("FS"))=$E(MSG,4),(HLECH,HL("ECH"))=$E(MSG,5,8)
"RTN","VAFCTFPR",32,0)
 S VAFCARR("SENDING SITE")=$P(MSG,HL("FS"),4)
"RTN","VAFCTFPR",33,0)
 Q
"RTN","VAFCTFPR",34,0)
EVN ;;EVN
"RTN","VAFCTFPR",35,0)
 ;process the EVN segment
"RTN","VAFCTFPR",36,0)
 S STATN=+$$SITE^VASITE()_"^"_$$FMDATE^HLFNC($P(MSG,HL("FS"),3))
"RTN","VAFCTFPR",37,0)
 Q
"RTN","VAFCTFPR",38,0)
PID ;;PID
"RTN","VAFCTFPR",39,0)
 ;process the PID segment
"RTN","VAFCTFPR",40,0)
 S PDFN=+$P(MSG,HL("FS"),4)
"RTN","VAFCTFPR",41,0)
 Q
"RTN","VAFCTFPR",42,0)
MFI ;;MFI
"RTN","VAFCTFPR",43,0)
 ;process the MFI segment
"RTN","VAFCTFPR",44,0)
 N NXTSGMT,VAFCMPI
"RTN","VAFCTFPR",45,0)
 S MFUPT=$P(MSG,HL("FS"),2)
"RTN","VAFCTFPR",46,0)
 ;master file update type is not TFL SET quit flag
"RTN","VAFCTFPR",47,0)
 I MFUPT'="TFL" S MFNQUIT=1 Q
"RTN","VAFCTFPR",48,0)
 N HLCOMP
"RTN","VAFCTFPR",49,0)
 S HLCOMP=$E(HL("ECH"),1)
"RTN","VAFCTFPR",50,0)
 S TYPE=$P(MSG,HL("FS"),4)
"RTN","VAFCTFPR",51,0)
 ;is this coming from the CMOR if so pass a '1' to FILE to end transmission
"RTN","VAFCTFPR",52,0)
 S VAFCTFT=0 I TYPE="REP" S VAFCTFT=1
"RTN","VAFCTFPR",53,0)
 S VAFCARR("CMOR")=$P($P(MSG,HL("FS"),8),HLCOMP,1)
"RTN","VAFCTFPR",54,0)
 S NXTSGMT=$G(VAFC(+$O(VAFC(VAFCI))))
"RTN","VAFCTFPR",55,0)
 I $P(NXTSGMT,HL("FS"))="MFE" S ICN=$P($P(NXTSGMT,HL("FS"),5),HLCOMP,4) I $G(ICN)="" S MFNQUIT=1 D EXC^RGHLLOG(210,"Msg#"_$G(HL("MID"))_" failed to Update TF from "_$G(VAFCARR("SENDING SITE"))_".  ICN not sent.",$G(PDFN)) Q
"RTN","VAFCTFPR",56,0)
 ;check for CMOR mismatch
"RTN","VAFCTFPR",57,0)
 S PDFN=$$GETDFN^MPIF001(ICN)
"RTN","VAFCTFPR",58,0)
 I +$G(PDFN)<0 S MFNQUIT=1 D EXC^RGHLLOG(210,"Msg#"_$G(HL("MID"))_" failed to update TF from "_$G(VAFCARR("SENDING SITE"))_" for ICN#"_$G(ICN)) Q
"RTN","VAFCTFPR",59,0)
 S VAFCMPI=$$MPINODE^MPIFAPI(PDFN)
"RTN","VAFCTFPR",60,0)
 ;if from CMOR delete all TF's and replace with CMOR's list (need to log exception if problems deleting TF's)
"RTN","VAFCTFPR",61,0)
 I TYPE="REP" D
"RTN","VAFCTFPR",62,0)
 . ;if CMOR mismatch quit the exception will be logged in MFE subroutine
"RTN","VAFCTFPR",63,0)
 . I $P($G(VAFCMPI),"^",3)'=$G(VAFCARR("CMOR")) Q
"RTN","VAFCTFPR",64,0)
 . S VAFCER=$$DELALLTF^VAFCTFU(ICN) I VAFCER S MFNQUIT=1 D EXC^RGHLLOG(212,"Msg#"_$G(HL("MID"))_" failed to Delete ALL TF's for ICN#"_$G(ICN),$G(PDFN)) Q
"RTN","VAFCTFPR",65,0)
 Q
"RTN","VAFCTFPR",66,0)
MFE ;;MFE
"RTN","VAFCTFPR",67,0)
 ;process the MFE segment
"RTN","VAFCTFPR",68,0)
 N HLCOMP,NXTSGMT
"RTN","VAFCTFPR",69,0)
 S HLCOMP=$E(HL("ECH"),1)
"RTN","VAFCTFPR",70,0)
 S PDLT=$$FMDATE^HLFNC($P(MSG,HL("FS"),4))
"RTN","VAFCTFPR",71,0)
 S INST=$P($P(MSG,HL("FS"),5),HLCOMP) ; **520 REMOVE + AND GET PIECE
"RTN","VAFCTFPR",72,0)
 S INST=$$LKUP^XUAF4(INST) ; **520 REMOVE +
"RTN","VAFCTFPR",73,0)
 I INST="" S MFNQUIT=1 Q  ; log exception, set MFNQUIT flag and quit
"RTN","VAFCTFPR",74,0)
 S PDFN=$$GETDFN^MPIF001(ICN)
"RTN","VAFCTFPR",75,0)
 D  Q:$G(MFNQUIT)=1
"RTN","VAFCTFPR",76,0)
 .;if unable to get DFN from ICN set MFNQUIT flag and quit
"RTN","VAFCTFPR",77,0)
 .I +$G(PDFN)<0 S MFNQUIT=1 D EXC^RGHLLOG(210,"Msg#"_$G(HL("MID"))_" failed to update TF from "_$G(VAFCARR("SENDING SITE"))_" for ICN#"_$G(ICN)) Q
"RTN","VAFCTFPR",78,0)
 .N VAFCDATA,LOCNAME,LASTNAME,LOCSSN,LOCICN,LOCCMOR
"RTN","VAFCTFPR",79,0)
 .S LOCNAME=$$GET1^DIQ(2,+PDFN_",",.01)
"RTN","VAFCTFPR",80,0)
 .S LASTNAME=$P(LOCNAME,",",1)
"RTN","VAFCTFPR",81,0)
 .S LOCSSN=$$GET1^DIQ(2,+PDFN_",",.09)
"RTN","VAFCTFPR",82,0)
 .S LOCICN=+$$GETICN^MPIF001(PDFN)
"RTN","VAFCTFPR",83,0)
 .S LOCCMOR=$$GETVCCI^MPIF001(PDFN)
"RTN","VAFCTFPR",84,0)
 .;CMOR MISMATCH or CMOR = null log exception, set MFNQUIT flag and quit
"RTN","VAFCTFPR",85,0)
 .I LOCCMOR'=VAFCARR("CMOR")!(VAFCARR("CMOR")="") D  Q
"RTN","VAFCTFPR",86,0)
 ..D EXC^RGHLLOG(211,"Msg#"_$G(HL("MID"))_" failed to update from "_$G(VAFCARR("SENDING SITE"))_" for "_$G(LOCNAME)_" ICN#"_$G(ICN)_" due to mismatch CMOR "_$G(VAFCARR("CMOR"))_"/"_$G(LOCCMOR)_" (local)",$G(PDFN)) S MFNQUIT=1
"RTN","VAFCTFPR",87,0)
 ;check next segment, if it exist and it is a ZET segment quit and let the ZET module add the TF
"RTN","VAFCTFPR",88,0)
 S NXTSGMT=$G(VAFC(+$O(VAFC(VAFCI)))) I $P($G(NXTSGMT),HL("FS"))="ZET" Q
"RTN","VAFCTFPR",89,0)
 D FILE^VAFCTFU(PDFN,INST_"^"_$G(PDLT),$G(VAFCTFT))
"RTN","VAFCTFPR",90,0)
 Q
"RTN","VAFCTFPR",91,0)
ZET ;;ZET
"RTN","VAFCTFPR",92,0)
 ;process Patient's Date Last Treated Event Type, ZET segment
"RTN","VAFCTFPR",93,0)
 K PDLTET
"RTN","VAFCTFPR",94,0)
 S PDLTET=$P(MSG,HL("FS"),2)
"RTN","VAFCTFPR",95,0)
 D FILE^VAFCTFU(PDFN,INST_"^"_PDLT_"^"_PDLTET,$G(VAFCTFT))
"RTN","VAFCTFPR",96,0)
 Q
"RTN","VAFCTFPR",97,0)
TFPRQ Q
"RTN","VAFCTFPR",98,0)
 ;
"RTN","VAFCTFPR",99,0)
POPQ Q
"RTN","VAFCTFPR",100,0)
 ;
"RTN","VAFCTFPR",101,0)
UP ;entry point to process local A04 messages.
"RTN","VAFCTFPR",102,0)
 ;This is call by the VAFC TFL-UPDATE CLIENT
"RTN","VAFCTFPR",103,0)
 N STATN,PDFN,VAFCARR,HLFS,HLECH,SG,VAFCI
"RTN","VAFCTFPR",104,0)
 N VAFC
"RTN","VAFCTFPR",105,0)
 D INIT
"RTN","VAFCTFPR",106,0)
 ;file the TF and trigger the TF update
"RTN","VAFCTFPR",107,0)
 D FILE^VAFCTFU(PDFN,+$$SITE^VASITE,1)
"RTN","VAFCTFPR",108,0)
UPQ Q
"RTN","VAFCTFU")
0^5^B59884823
"RTN","VAFCTFU",1,0)
VAFCTFU ;ALB/JLU-UTILITIES FOR THE TREATING FACILITY FILE 391.91 ;10/10/02  15:55
"RTN","VAFCTFU",2,0)
 ;;5.3;Registration;**149,240,261,255,316,392,440,428,474,520**;Aug 13, 1993
"RTN","VAFCTFU",3,0)
 ;
"RTN","VAFCTFU",4,0)
 ;Reference to EXC^RGHLLOG and STOP^RGHLLOG supported by IA #2796
"RTN","VAFCTFU",5,0)
 ;Reference to $$UPDATE^ MPIFAPI supported by IA #2706
"RTN","VAFCTFU",6,0)
 ;
"RTN","VAFCTFU",7,0)
FILETF(PAT,INST) ;programmer entry point.
"RTN","VAFCTFU",8,0)
 ;INPUT   PAT - This is the patient's ICN
"RTN","VAFCTFU",9,0)
 ;       INST - This is the IEN of the institution or Treating Facility
"RTN","VAFCTFU",10,0)
 ;it also contains the date of treatment in FM format.  It is to be
"RTN","VAFCTFU",11,0)
 ;stored in an array structure to allow for multiple treating
"RTN","VAFCTFU",12,0)
 ;facilities.
"RTN","VAFCTFU",13,0)
 ;  EX.   X(1)=500^2960101
"RTN","VAFCTFU",14,0)
 ;        x(2)=425^2960202
"RTN","VAFCTFU",15,0)
 ;
"RTN","VAFCTFU",16,0)
 ;OUTPUT  0 (ZERO) If no errors
"RTN","VAFCTFU",17,0)
 ;        1^error description if there was an error.
"RTN","VAFCTFU",18,0)
 ;
"RTN","VAFCTFU",19,0)
 N PDFN,LP,VAFCER,X
"RTN","VAFCTFU",20,0)
 S VAFCER=0
"RTN","VAFCTFU",21,0)
 I '$G(PAT)!('$D(INST)) S VAFCER="1^Parameter missing." G FILETFQ
"RTN","VAFCTFU",22,0)
 I $D(@INST)<10 S VAFCER="1^Institution array not populated." G FILETFQ
"RTN","VAFCTFU",23,0)
 S X="MPIF001" X ^%ZOSF("TEST") I '$T G FILETFQ
"RTN","VAFCTFU",24,0)
 S PDFN=$$GETDFN^MPIF001(PAT)
"RTN","VAFCTFU",25,0)
 I PDFN<0 S VAFCER="1^No patient DFN." G FILETFQ
"RTN","VAFCTFU",26,0)
 N FSTRG
"RTN","VAFCTFU",27,0)
 F LP=0:0 S LP=$O(@INST@(LP)) Q:'LP  D FILE(PDFN,@INST@(LP))
"RTN","VAFCTFU",28,0)
 ;
"RTN","VAFCTFU",29,0)
FILETFQ Q VAFCER
"RTN","VAFCTFU",30,0)
 ;
"RTN","VAFCTFU",31,0)
 ; both the SET & QUERYTF subroutines have been moved to VAFCTFU1 as
"RTN","VAFCTFU",32,0)
 ; the result of DG*5.3*261  *261 gjc@120899
"RTN","VAFCTFU",33,0)
 ;
"RTN","VAFCTFU",34,0)
FILE(PDFN,FSTRG,TICN,VAFCSLT,ERROR) ;this module files the individual entry
"RTN","VAFCTFU",35,0)
 ;PDFN is the patient's DFN
"RTN","VAFCTFU",36,0)
 ;FSTRG = institution or treating facility^Date of treatment^Event reason
"RTN","VAFCTFU",37,0)
 ;TICN - if 1 suppress add entries to ADT HL7 PIVOT (#391.71) file
"RTN","VAFCTFU",38,0)
 ;VAFCSLT - (optional) if 1 suppress exception logging and return error in the ERROR array
"RTN","VAFCTFU",39,0)
 ;ERROR - (optional) 
"RTN","VAFCTFU",40,0)
 ;Ex  500^2960202^A1
"RTN","VAFCTFU",41,0)
 ;
"RTN","VAFCTFU",42,0)
 N X,Y
"RTN","VAFCTFU",43,0)
 I $G(VAFCSLT)="" S VAFCSLT=0
"RTN","VAFCTFU",44,0)
 S X="MPIF001" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFU",45,0)
 S X="MPIFQ0" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFU",46,0)
 N TFIEN,PDLT,FAC,EVNTR,VAFCER,CMOR,ICN,STA,ECNT
"RTN","VAFCTFU",47,0)
 S ECNT=1
"RTN","VAFCTFU",48,0)
 S FAC=$P(FSTRG,U,1),PDLT=$P(FSTRG,U,2),EVNTR=$P(FSTRG,U,3)
"RTN","VAFCTFU",49,0)
 S STA=$$STA^XUAF4(FAC)
"RTN","VAFCTFU",50,0)
 ;
"RTN","VAFCTFU",51,0)
 I '$$FIND1^DIC(4,"","MX","`"_FAC) D  Q
"RTN","VAFCTFU",52,0)
 . I 'VAFCSLT D EXC^RGHLLOG(212,"Msg#"_$G(HL("MID"))_" unknown Institution IEN "_FAC_" passed into TF update.",PDFN) D STOP^RGHLLOG(1) Q
"RTN","VAFCTFU",53,0)
 . I VAFCSLT S ERROR(STA)="Update of "_STA_" Failed at "_$P($$SITE^VASITE,"^",3)_" due to unknown Institution IEN "_FAC_" passed into TF update."
"RTN","VAFCTFU",54,0)
 I PDLT'="" K %DT S %DT="T" S X=PDLT D ^%DT K %DT I Y<0 S VAFCER="1^Not a FM date." D  Q
"RTN","VAFCTFU",55,0)
 .I 'VAFCSLT D EXC^RGHLLOG(212,"TF updated in msg#"_$G(HL("MID"))_" for Institution IEN "_FAC_" but with invalid date "_PDLT_" for DFN "_PDFN,PDFN)
"RTN","VAFCTFU",56,0)
 .I VAFCSLT S ERROR(STA)="Update of "_STA_" Failed at "_$P($$SITE^VASITE,"^",3)_" due to invalid date "_PDLT_" for DFN "_PDFN
"RTN","VAFCTFU",57,0)
 ;removed code for adding local ICN's
"RTN","VAFCTFU",58,0)
 S ICN=+$$MPINODE^MPIFAPI(PDFN)
"RTN","VAFCTFU",59,0)
 S TFIEN=$O(^DGCN(391.91,"APAT",PDFN,FAC,0)) D
"RTN","VAFCTFU",60,0)
 .;TFIEN is used in other places so quit after adding new entry
"RTN","VAFCTFU",61,0)
 .I 'TFIEN D FILENEW(PDFN,FAC,PDLT,EVNTR,VAFCSLT,.ERROR) Q
"RTN","VAFCTFU",62,0)
 .I TFIEN D FILEDIT(TFIEN,PDLT,PDFN,FAC,EVNTR,VAFCSLT,.ERROR)
"RTN","VAFCTFU",63,0)
 ;look to see if CMOR is in TF list if not add
"RTN","VAFCTFU",64,0)
 S CMOR=$$GETVCCI^MPIF001(PDFN)
"RTN","VAFCTFU",65,0)
 S CMOR=$$LKUP^XUAF4(CMOR) ; **520 REMOVED +
"RTN","VAFCTFU",66,0)
 ;check to see if CMOR exist if not add it
"RTN","VAFCTFU",67,0)
 I +$G(CMOR)>0 D:'$D(^DGCN(391.91,"APAT",PDFN,CMOR)) FILENEW^VAFCTFU(PDFN,CMOR)
"RTN","VAFCTFU",68,0)
 ;create the entry in the pivot to broadcast the MFU.
"RTN","VAFCTFU",69,0)
 ; Note: we will not broadcast to the MFU if the TFL record
"RTN","VAFCTFU",70,0)
 ; has an event reason. See comments in FILEDIT. *261 gjc@120199
"RTN","VAFCTFU",71,0)
 I $G(TICN)'=1,$P($$SEND^VAFHUTL,"^",2)>0 D SETSND(PDFN)
"RTN","VAFCTFU",72,0)
FILEQ Q
"RTN","VAFCTFU",73,0)
 ;
"RTN","VAFCTFU",74,0)
FILENEW(PDFN,FAC,PDLT,EVNTR,VAFCSLT,ERROR) ;
"RTN","VAFCTFU",75,0)
 N DGSENFLG ;**240 added y
"RTN","VAFCTFU",76,0)
 K DD,DO,DIC,DA,RESULT
"RTN","VAFCTFU",77,0)
 S DGSENFLG=""
"RTN","VAFCTFU",78,0)
 N FDA,FDAIEN,ERR S ERR=""
"RTN","VAFCTFU",79,0)
 I $G(EVNTR)'="" D CHK^DIE(391.91,.07,"",EVNTR,.RESULT) I +RESULT>0 S EVNTR=RESULT
"RTN","VAFCTFU",80,0)
 S FDA(1,391.91,"+1,",.01)=PDFN
"RTN","VAFCTFU",81,0)
 S FDA(1,391.91,"+1,",.02)=FAC
"RTN","VAFCTFU",82,0)
 S FDA(1,391.91,"+1,",.03)=$G(PDLT)
"RTN","VAFCTFU",83,0)
 S FDA(1,391.91,"+1,",.07)=$G(EVNTR)
"RTN","VAFCTFU",84,0)
 L +^DGCN(391.91,0):30
"RTN","VAFCTFU",85,0)
 I '$D(^DGCN(391.91,"APAT",PDFN,FAC)) D UPDATE^DIE("","FDA(1)","FDAIEN","ERR") I $D(ERR("DIERR",1)) S ERROR(STA)="Add of "_STA_" Failed at "_$P($$SITE^VASITE,"^",3)_" due to "_$G(ERR("DIERR",1,"TEXT",1))
"RTN","VAFCTFU",86,0)
 ;check to see if TF exist as a subscription if not add it, but only if call from old entry point without the VAFCSLT parameter
"RTN","VAFCTFU",87,0)
 I '$D(ERROR(STA)) I FAC'=+$$SITE^VASITE I $G(VAFCSLT)'=1 D CHKSUB(PDFN,FAC)
"RTN","VAFCTFU",88,0)
 L -^DGCN(391.91,0)
"RTN","VAFCTFU",89,0)
 K DIC,DD,DO,DA
"RTN","VAFCTFU",90,0)
 Q
"RTN","VAFCTFU",91,0)
 ;
"RTN","VAFCTFU",92,0)
SETSND(PDFN) ;sets the pivot file entry to send MFU
"RTN","VAFCTFU",93,0)
 ;
"RTN","VAFCTFU",94,0)
 N ANS,X
"RTN","VAFCTFU",95,0)
 S X="MPIF001" X ^%ZOSF("TEST") Q:'$T
"RTN","VAFCTFU",96,0)
 ; check if other facilities other than CMOR in TF list
"RTN","VAFCTFU",97,0)
 N SIT,CMOR,STOP
"RTN","VAFCTFU",98,0)
 S CMOR=$$GETVCCI^MPIF001(PDFN)
"RTN","VAFCTFU",99,0)
 S CMOR=$$LKUP^XUAF4(CMOR) ; **520 REMOVED +
"RTN","VAFCTFU",100,0)
 I CMOR=$P($$SITE^VASITE,"^") D
"RTN","VAFCTFU",101,0)
 .S SIT=0
"RTN","VAFCTFU",102,0)
 .S SIT=$O(^DGCN(391.91,"APAT",PDFN,SIT))
"RTN","VAFCTFU",103,0)
 .I SIT=CMOR S SIT=$O(^DGCN(391.91,"APAT",PDFN,SIT)) I SIT="" S STOP=""
"RTN","VAFCTFU",104,0)
 I $D(STOP) QUIT
"RTN","VAFCTFU",105,0)
 S ANS=$$PIVNW^VAFHPIVT(PDFN,DT,5,PDFN_";DPT(")
"RTN","VAFCTFU",106,0)
 I 'ANS QUIT
"RTN","VAFCTFU",107,0)
 D XMITFLAG^VAFCDD01(0,+ANS,0)
"RTN","VAFCTFU",108,0)
SETSNDQ Q
"RTN","VAFCTFU",109,0)
 ;
"RTN","VAFCTFU",110,0)
FILEDIT(TFIEN,PDLT,PDFN,FAC,EVNTR,VAFCSLT,ERROR) ;
"RTN","VAFCTFU",111,0)
 N DGSENFLG,FDA,FDAIEN,ERR,RESULT S DGSENFLG="",ERR=""
"RTN","VAFCTFU",112,0)
 I $G(PDLT)'="" D
"RTN","VAFCTFU",113,0)
 .S TFIEN(0)=$G(^DGCN(391.91,TFIEN,0))
"RTN","VAFCTFU",114,0)
 .I $G(EVNTR)'="" D CHK^DIE(391.91,.07,"",EVNTR,.RESULT) I +RESULT>0 S EVNTR=RESULT
"RTN","VAFCTFU",115,0)
 .S FDA(1,391.91,+TFIEN_",",.03)=$G(PDLT)
"RTN","VAFCTFU",116,0)
 .S FDA(1,391.91,+TFIEN_",",.07)=$G(EVNTR)
"RTN","VAFCTFU",117,0)
 .D FILE^DIE("K","FDA(1)","ERR") I VAFCSLT I $D(ERR("DIERR",1)) S ERROR(STA)="Edit of "_STA_" Failed at "_$P($$SITE^VASITE,"^",3)_" due to "_$G(ERR("DIERR",1,"TEXT",1))
"RTN","VAFCTFU",118,0)
 ;check to see if TF exist as a subscription if not add it, but only if call from old entry point without the VAFCSLT parameter
"RTN","VAFCTFU",119,0)
 I $G(VAFCSLT)'=1 I FAC'=+$$SITE^VASITE D CHKSUB(PDFN,FAC)
"RTN","VAFCTFU",120,0)
 Q
"RTN","VAFCTFU",121,0)
 ;
"RTN","VAFCTFU",122,0)
DELETETF(PAT,INST) ;deletion entry point
"RTN","VAFCTFU",123,0)
 ;This entry point is used to delete a single Treating Facility from
"RTN","VAFCTFU",124,0)
 ;the Treating Facility list.
"RTN","VAFCTFU",125,0)
 ;INPUT  PAT - the ICN of the patient.
"RTN","VAFCTFU",126,0)
 ;       INST - the IEN of the institution to be deleted.
"RTN","VAFCTFU",127,0)
 ;
"RTN","VAFCTFU",128,0)
 ;OUTPUT  0 (zero) - If no errors
"RTN","VAFCTFU",129,0)
 ;        1^error description if there was a problem
"RTN","VAFCTFU",130,0)
 ;
"RTN","VAFCTFU",131,0)
 N VAFCER,PDFN,TFIEN,X,VAFCSCN,LINK,VAFCLLN,IEN
"RTN","VAFCTFU",132,0)
 S VAFCER=0
"RTN","VAFCTFU",133,0)
 I '$G(PAT)!('$G(INST)) S VAFCER="1^Parameter missing." S ERROR(INST)="212"_"^"_$G(HL("MID"))_"^"_"Delete Failed: "_$P(VAFCER,"^") G DELTFQ
"RTN","VAFCTFU",134,0)
 S X="MPIF001" X ^%ZOSF("TEST") I '$T G FILETFQ
"RTN","VAFCTFU",135,0)
 S PDFN=$$GETDFN^MPIF001(+PAT)
"RTN","VAFCTFU",136,0)
 I PDFN<0 S VAFCER="1^No patient DFN." G FILETFQ
"RTN","VAFCTFU",137,0)
 I '$$FIND1^DIC(4,"","MX","`"_INST) S VAFCER="1^Not an Institution IEN." G DELTFQ
"RTN","VAFCTFU",138,0)
 S TFIEN=$O(^DGCN(391.91,"APAT",PDFN,INST,0))
"RTN","VAFCTFU",139,0)
 I 'TFIEN S VAFCER="1^Could not find Treating Facility." G DELTFQ
"RTN","VAFCTFU",140,0)
 D DELETE(TFIEN)
"RTN","VAFCTFU",141,0)
 S TFIEN=$O(^DGCN(391.91,"APAT",PDFN,INST,0))
"RTN","VAFCTFU",142,0)
 I TFIEN S VAFCER="1^DIK failed to delete entry" G DELTFQ
"RTN","VAFCTFU",143,0)
 ;terminate the subscription if there is one
"RTN","VAFCTFU",144,0)
 S VAFCSCN=+$P($$MPINODE^MPIFAPI(PDFN),"^",5) I +$G(VAFCSCN)>0 D
"RTN","VAFCTFU",145,0)
 .;get logical link
"RTN","VAFCTFU",146,0)
 . D LINK^HLUTIL3(INST,.LINK) S VAFCLLN=$O(LINK(0)) I +$G(VAFCLLN)>0 S VAFCLLN=LINK(VAFCLLN) D UPD^HLSUB(VAFCSCN,VAFCLLN,0,,$$NOW^XLFDT,,.HLER)
"RTN","VAFCTFU",147,0)
 D RETPDR^VAFCEHU2(PDFN,INST) ;**474 retire pdr when deleting tf
"RTN","VAFCTFU",148,0)
DELTFQ Q VAFCER
"RTN","VAFCTFU",149,0)
 ;
"RTN","VAFCTFU",150,0)
DELETE(TFIEN) ;the actual deletion code
"RTN","VAFCTFU",151,0)
 ;
"RTN","VAFCTFU",152,0)
 K DIK,DA
"RTN","VAFCTFU",153,0)
 S DIK="^DGCN(391.91,"
"RTN","VAFCTFU",154,0)
 S DA=TFIEN
"RTN","VAFCTFU",155,0)
 D ^DIK K DIK,DA
"RTN","VAFCTFU",156,0)
 Q
"RTN","VAFCTFU",157,0)
 ;
"RTN","VAFCTFU",158,0)
DELALLTF(PAT) ;Entry point to delete all Treating Facilities for a single
"RTN","VAFCTFU",159,0)
 ;patient.
"RTN","VAFCTFU",160,0)
 ;INPUT  PAT - The patient's ICN
"RTN","VAFCTFU",161,0)
 ;OUTPUT 0 (zero) - If no errors
"RTN","VAFCTFU",162,0)
 ;       1^error description if an error
"RTN","VAFCTFU",163,0)
 ;
"RTN","VAFCTFU",164,0)
 N VAFCER,PDFN,LP,TFIEN,X
"RTN","VAFCTFU",165,0)
 S VAFCER=0
"RTN","VAFCTFU",166,0)
 I '$G(PAT) Q "1^Parameter missing."
"RTN","VAFCTFU",167,0)
 S X="MPIF001" X ^%ZOSF("TEST") I '$T Q 0
"RTN","VAFCTFU",168,0)
 S PDFN=$$GETDFN^MPIF001(PAT)
"RTN","VAFCTFU",169,0)
 I PDFN<0 Q "1^No patient DFN."
"RTN","VAFCTFU",170,0)
 F LP=0:0 S LP=$O(^DGCN(391.91,"APAT",PDFN,LP)) Q:LP'>0  D
"RTN","VAFCTFU",171,0)
 . S TFIEN=0
"RTN","VAFCTFU",172,0)
 . F  S TFIEN=$O(^DGCN(391.91,"APAT",PDFN,LP,TFIEN)) Q:TFIEN'>0  D DELETE(TFIEN)
"RTN","VAFCTFU",173,0)
 ;
"RTN","VAFCTFU",174,0)
 Q VAFCER
"RTN","VAFCTFU",175,0)
 Q
"RTN","VAFCTFU",176,0)
CHKSUB(DFN,FAC) ;check for an existing subscription if one does not exist add it
"RTN","VAFCTFU",177,0)
 N VAFCSCN,VAFC,VAFCLL,VAFCLLI,VAFCLLN,FLAG,LOOP,HLER,ERR
"RTN","VAFCTFU",178,0)
 Q:FAC=""
"RTN","VAFCTFU",179,0)
 Q:DFN=""
"RTN","VAFCTFU",180,0)
 S VAFCSCN=$$GETSCN(DFN)
"RTN","VAFCTFU",181,0)
 D GET^HLSUB(VAFCSCN,0,"VAFC MFU-TFL CLIENT",.VAFCLL)
"RTN","VAFCTFU",182,0)
 D LINK^HLUTIL3("`"_FAC,.VAFC,"I") S VAFCLLI=$O(VAFC(0)) I $G(VAFCLLI)="" S ERR="Msg#"_$G(HL("MID"))_" Unknown Logical link for facility IEN#"_$G(FAC)_"  unable to add SC for DFN#"_$G(DFN) D EXC^RGHLLOG(224,$G(ERR),DFN) D STOP^RGHLLOG(1) Q
"RTN","VAFCTFU",183,0)
 S VAFCLLN=VAFC(VAFCLLI)
"RTN","VAFCTFU",184,0)
 S FLAG=0,LOOP=0 F  S LOOP=$O(VAFCLL("LINKS",LOOP)) Q:'LOOP  I $P(VAFCLL("LINKS",LOOP),"^",2)=VAFCLLN S FLAG=1
"RTN","VAFCTFU",185,0)
 ;if TF Logical Link is not in subscription list add it
"RTN","VAFCTFU",186,0)
 I FLAG=0 D UPD^HLSUB(VAFCSCN,VAFCLLN,0,$$NOW^XLFDT,"@",,.HLER)
"RTN","VAFCTFU",187,0)
 ;if TF logical link is there make sure its does not have a termination date
"RTN","VAFCTFU",188,0)
 I FLAG=1 D UPD^HLSUB(VAFCSCN,VAFCLLN,0,,"@",,.HLER)
"RTN","VAFCTFU",189,0)
 I $D(HLER) D EXC^RGHLLOG(224,"Msg#"_$G(HL("MID"))_" Unable to add/update SC for facility IEN "_FAC_", Link "_$G(VAFCLLN)_", SUBSCRIPTION #"_$G(VAFCSCN),DFN) D STOP^RGHLLOG(1) Q  ; log exception **307
"RTN","VAFCTFU",190,0)
 Q
"RTN","VAFCTFU",191,0)
GETSCN(DFN) ;Return existing SCN or Activate a new subscription
"RTN","VAFCTFU",192,0)
 ;DFN - PATIENT (#2) file ien
"RTN","VAFCTFU",193,0)
 N VAFCAR,VAFCAN
"RTN","VAFCTFU",194,0)
 ;get subscription control #
"RTN","VAFCTFU",195,0)
 S VAFCSCN=+$P($$MPINODE^MPIFAPI(DFN),"^",5)
"RTN","VAFCTFU",196,0)
 ;if no SCN, create new and update 991.05, then return result
"RTN","VAFCTFU",197,0)
 I 'VAFCSCN S VAFCSCN=$$ACT^HLSUB S VAFCAR(991.05)=VAFCSCN S VAFCAN=$$UPDATE^MPIFAPI(DFN,"VAFCAR") I VAFCAN=-1 S VAFCSCN=""
"RTN","VAFCTFU",198,0)
 Q VAFCSCN
"VER")
8.0^22.0
**END**
**END**
