Released PSD*3*40 SEQ #34
Extracted from mail message
**KIDS**:PSD*3.0*40^

**INSTALL NAME**
PSD*3.0*40
"BLD",3937,0)
PSD*3.0*40^CONTROLLED SUBSTANCES^0^3030523^y
"BLD",3937,1,0)
^^21^21^3030523^
"BLD",3937,1,1,0)
Pharmacy Benefits Management (PBM) Strategic Healthcare Group in
"BLD",3937,1,2,0)
collaboration with the Drug Enforcement Administration (DEA), requested
"BLD",3937,1,3,0)
the development of the first Public Key Infrastructure (PKI) VistA pilot
"BLD",3937,1,4,0)
project, named Electronic Prescription Order Entry for Schedule II
"BLD",3937,1,5,0)
Controlled Substances. The objective is to develop an electronic order
"BLD",3937,1,6,0)
entry system for Schedule II controlled substances using digital
"BLD",3937,1,7,0)
signatures. To make this project viable, modifications to the following
"BLD",3937,1,8,0)
packages were identified:
"BLD",3937,1,9,0)
National Drug File (NDF) V. 4.0
"BLD",3937,1,10,0)
Computerized Patient Record System (CPRS) V. 1.0
"BLD",3937,1,11,0)
Pharmacy Data Management (PDM) V. 1.0
"BLD",3937,1,12,0)
Outpatient Pharmacy (OP) V. 7.0
"BLD",3937,1,13,0)
Controlled Substances (CS) V. 3.0
"BLD",3937,1,14,0)
 
"BLD",3937,1,15,0)
This is the CS patch, which provides two new options entitled Digitally
"BLD",3937,1,16,0)
Signed CS Orders Report [PSD DIGITALLY SIGNED ORDERS] and Digitally Signed
"BLD",3937,1,17,0)
OP Released Rx Report [PSD DIG. SIGNED RELEASED RX] that will be added to
"BLD",3937,1,18,0)
the Production Reports [PSD PRODUCTION REPORTS] menu. Once DEA's
"BLD",3937,1,19,0)
regulations are revised and PKI can be fully implemented nationally, sites
"BLD",3937,1,20,0)
that choose to activate the PKI functionality can use this option to
"BLD",3937,1,21,0)
retrieve digitally signed orders for controlled substances.
"BLD",3937,4,0)
^9.64PA^^
"BLD",3937,"KRN",0)
^9.67PA^19^17
"BLD",3937,"KRN",.4,0)
.4
"BLD",3937,"KRN",.401,0)
.401
"BLD",3937,"KRN",.402,0)
.402
"BLD",3937,"KRN",.403,0)
.403
"BLD",3937,"KRN",.5,0)
.5
"BLD",3937,"KRN",.84,0)
.84
"BLD",3937,"KRN",3.6,0)
3.6
"BLD",3937,"KRN",3.8,0)
3.8
"BLD",3937,"KRN",9.2,0)
9.2
"BLD",3937,"KRN",9.8,0)
9.8
"BLD",3937,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",3937,"KRN",9.8,"NM",1,0)
PSDDSOR^^0^B74602772
"BLD",3937,"KRN",9.8,"NM",2,0)
PSDDSOR1^^0^B8766491
"BLD",3937,"KRN",9.8,"NM",3,0)
PSDDSOR2^^0^B21366672
"BLD",3937,"KRN",9.8,"NM","B","PSDDSOR",1)

"BLD",3937,"KRN",9.8,"NM","B","PSDDSOR1",2)

"BLD",3937,"KRN",9.8,"NM","B","PSDDSOR2",3)

"BLD",3937,"KRN",19,0)
19
"BLD",3937,"KRN",19,"NM",0)
^9.68A^3^3
"BLD",3937,"KRN",19,"NM",1,0)
PSD PRODUCTION REPORTS^^2
"BLD",3937,"KRN",19,"NM",2,0)
PSD DIGITALLY SIGNED ORDERS^^0
"BLD",3937,"KRN",19,"NM",3,0)
PSD DIG. SIGNED RELEASED RX^^0
"BLD",3937,"KRN",19,"NM","B","PSD DIG. SIGNED RELEASED RX",3)

"BLD",3937,"KRN",19,"NM","B","PSD DIGITALLY SIGNED ORDERS",2)

"BLD",3937,"KRN",19,"NM","B","PSD PRODUCTION REPORTS",1)

"BLD",3937,"KRN",19.1,0)
19.1
"BLD",3937,"KRN",101,0)
101
"BLD",3937,"KRN",409.61,0)
409.61
"BLD",3937,"KRN",771,0)
771
"BLD",3937,"KRN",870,0)
870
"BLD",3937,"KRN",8994,0)
8994
"BLD",3937,"KRN","B",.4,.4)

"BLD",3937,"KRN","B",.401,.401)

"BLD",3937,"KRN","B",.402,.402)

"BLD",3937,"KRN","B",.403,.403)

"BLD",3937,"KRN","B",.5,.5)

"BLD",3937,"KRN","B",.84,.84)

"BLD",3937,"KRN","B",3.6,3.6)

"BLD",3937,"KRN","B",3.8,3.8)

"BLD",3937,"KRN","B",9.2,9.2)

"BLD",3937,"KRN","B",9.8,9.8)

"BLD",3937,"KRN","B",19,19)

"BLD",3937,"KRN","B",19.1,19.1)

"BLD",3937,"KRN","B",101,101)

"BLD",3937,"KRN","B",409.61,409.61)

"BLD",3937,"KRN","B",771,771)

"BLD",3937,"KRN","B",870,870)

"BLD",3937,"KRN","B",8994,8994)

"BLD",3937,"QUES",0)
^9.62^^
"BLD",3937,"REQB",0)
^9.611^^0
"KRN",19,6722,-1)
2^1
"KRN",19,6722,0)
PSD PRODUCTION REPORTS^Production Reports^^M^11595^^^^^^^276
"KRN",19,6722,10,0)
^19.01IP^22^22
"KRN",19,6722,10,21,0)
12175
"KRN",19,6722,10,21,"^")
PSD DIGITALLY SIGNED ORDERS
"KRN",19,6722,10,22,0)
12275
"KRN",19,6722,10,22,"^")
PSD DIG. SIGNED RELEASED RX
"KRN",19,6722,"U")
PRODUCTION REPORTS
"KRN",19,12175,-1)
0^2
"KRN",19,12175,0)
PSD DIGITALLY SIGNED ORDERS^Digitally Signed CS Orders Report^^R^^^^^^^^CONTROLLED SUBSTANCES
"KRN",19,12175,1,0)
^^6^6^3020903^
"KRN",19,12175,1,1,0)
This will provide a report of digitally signed orders for Schedule II
"KRN",19,12175,1,2,0)
controlled substances. 
"KRN",19,12175,1,3,0)
The report will be for a date range with the option of including 
"KRN",19,12175,1,4,0)
discontinued and/or expired orders and various sort criteria, like by 
"KRN",19,12175,1,5,0)
patient, by provider, by drug and by schedule etc.
"KRN",19,12175,1,6,0)
It will be an 80-column report and will be queued to a printer.
"KRN",19,12175,25)
PSDDSOR
"KRN",19,12175,99)
59129,34023
"KRN",19,12175,"U")
DIGITALLY SIGNED CS ORDERS REP
"KRN",19,12275,-1)
0^3
"KRN",19,12275,0)
PSD DIG. SIGNED RELEASED RX^Digitally Signed OP Released Rx Report^^R^^^^^^^^CONTROLLED SUBSTANCES
"KRN",19,12275,1,0)
^^5^5^3030522^
"KRN",19,12275,1,1,0)
This will provide a list of digitally signed released prescriptions, 
"KRN",19,12275,1,2,0)
sorted by released date, by drug and by Prescription file (#52) IEN.
"KRN",19,12275,1,3,0)
The report will be for a given date range with the option of selecting a
"KRN",19,12275,1,4,0)
single drug, several drugs or all drugs. It will generate an 80-column
"KRN",19,12275,1,5,0)
report that can be viewed on the screen or queued to a printer.
"KRN",19,12275,25)
PSDDSOR2
"KRN",19,12275,"U")
DIGITALLY SIGNED OP RELEASED R
"MBREQ")
0
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",276,-1)
1^1
"PKG",276,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",276,22,0)
^9.49I^1^1
"PKG",276,22,1,0)
3.0^2970213^2970430^11595
"PKG",276,22,1,"PAH",1,0)
40^3030523^11863
"PKG",276,22,1,"PAH",1,1,0)
^^21^21^3030523
"PKG",276,22,1,"PAH",1,1,1,0)
Pharmacy Benefits Management (PBM) Strategic Healthcare Group in
"PKG",276,22,1,"PAH",1,1,2,0)
collaboration with the Drug Enforcement Administration (DEA), requested
"PKG",276,22,1,"PAH",1,1,3,0)
the development of the first Public Key Infrastructure (PKI) VistA pilot
"PKG",276,22,1,"PAH",1,1,4,0)
project, named Electronic Prescription Order Entry for Schedule II
"PKG",276,22,1,"PAH",1,1,5,0)
Controlled Substances. The objective is to develop an electronic order
"PKG",276,22,1,"PAH",1,1,6,0)
entry system for Schedule II controlled substances using digital
"PKG",276,22,1,"PAH",1,1,7,0)
signatures. To make this project viable, modifications to the following
"PKG",276,22,1,"PAH",1,1,8,0)
packages were identified:
"PKG",276,22,1,"PAH",1,1,9,0)
National Drug File (NDF) V. 4.0
"PKG",276,22,1,"PAH",1,1,10,0)
Computerized Patient Record System (CPRS) V. 1.0
"PKG",276,22,1,"PAH",1,1,11,0)
Pharmacy Data Management (PDM) V. 1.0
"PKG",276,22,1,"PAH",1,1,12,0)
Outpatient Pharmacy (OP) V. 7.0
"PKG",276,22,1,"PAH",1,1,13,0)
Controlled Substances (CS) V. 3.0
"PKG",276,22,1,"PAH",1,1,14,0)
 
"PKG",276,22,1,"PAH",1,1,15,0)
This is the CS patch, which provides two new options entitled Digitally
"PKG",276,22,1,"PAH",1,1,16,0)
Signed CS Orders Report [PSD DIGITALLY SIGNED ORDERS] and Digitally Signed
"PKG",276,22,1,"PAH",1,1,17,0)
OP Released Rx Report [PSD DIG. SIGNED RELEASED RX] that will be added to
"PKG",276,22,1,"PAH",1,1,18,0)
the Production Reports [PSD PRODUCTION REPORTS] menu. Once DEA's
"PKG",276,22,1,"PAH",1,1,19,0)
regulations are revised and PKI can be fully implemented nationally, sites
"PKG",276,22,1,"PAH",1,1,20,0)
that choose to activate the PKI functionality can use this option to
"PKG",276,22,1,"PAH",1,1,21,0)
retrieve digitally signed orders for controlled substances.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSDDSOR")
0^1^B74602772
"RTN","PSDDSOR",1,0)
PSDDSOR ;BHM/MHA - Digitally signed CS Orders Report; 08/30/02
"RTN","PSDDSOR",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**40**;13 Feb 97
"RTN","PSDDSOR",3,0)
 ;Ref. to ^PSRX( supp. by IA 1977
"RTN","PSDDSOR",4,0)
 ;Ref. to ^PS(52.41, supp. by IA 3848
"RTN","PSDDSOR",5,0)
 ;Ref. to ^PS(59, supp. by IA 212
"RTN","PSDDSOR",6,0)
 ;Ref. ^PSDRUG( supp. by IA 221
"RTN","PSDDSOR",7,0)
 ;Ref. to GETDATA^ORWOR1 supp. by IA 3750
"RTN","PSDDSOR",8,0)
 ;
"RTN","PSDDSOR",9,0)
 N AC,BDT,CT,DFN,DP,DRG,DRUG,DV,DVN,EDT,FI,NS,OP,ORD,ORS,PAT,PG,POS,PL,PL1,PRO,PROV
"RTN","PSDDSOR",10,0)
 N PSDBD,PSDDF,PSDDV,PSDED,PSDIO,PSDPO,PSDPR,PSDPT,PSDRG,PSDSC,PSDSD
"RTN","PSDDSOR",11,0)
 N PSDXF,RX,RX0,RX2,S1,S2,S3,S4,S5,S6,SCH,SR,SRT,TDT,TY,I,J,O,X,Y,Z
"RTN","PSDDSOR",12,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDDSOR",13,0)
SITE I '$D(PSOSITE) D  Q:$D(DUOUT)!($D(DTOUT))  G:'$D(PSOSITE) SITE
"RTN","PSDDSOR",14,0)
 .W ! S DIC("A")="Division: ",DIC=59,DIC(0)="AEMQ"
"RTN","PSDDSOR",15,0)
 .S DIC("S")="I $S('$D(^PS(59,+Y,""I"")):1,'^(""I""):1,DT'>^(""I""):1,1:0)"
"RTN","PSDDSOR",16,0)
 .D ^DIC K DIC Q:$D(DUOUT)!($D(DTOUT))  I +Y>0 S PSOSITE=+Y Q
"RTN","PSDDSOR",17,0)
 .W !!,"A 'DIVISION' must be selected!  or Enter '^' to exit."
"RTN","PSDDSOR",18,0)
 S PSDDV=PSOSITE
"RTN","PSDDSOR",19,0)
 W !!?10,"You are logged on under the ",$P(^PS(59,PSDDV,0),"^")," division.",!
"RTN","PSDDSOR",20,0)
DATE ;ask date range
"RTN","PSDDSOR",21,0)
 W ! K %DT S %DT(0)=-DT,%DT="AEP",%DT("A")="Start Date: " D ^%DT
"RTN","PSDDSOR",22,0)
 I Y<0!($D(DTOUT)) G END
"RTN","PSDDSOR",23,0)
 S (%DT(0),PSDBD)=Y,%DT("A")="End Date: "
"RTN","PSDDSOR",24,0)
 W ! D ^%DT I Y<0!($D(DTOUT)) G END
"RTN","PSDDSOR",25,0)
 S PSDED=Y,PSDSD=PSDBD-.000001
"RTN","PSDDSOR",26,0)
 W ! D KV S DIR("A")="Include discontinued orders",DIR(0)="Y",DIR("B")="NO"
"RTN","PSDDSOR",27,0)
 D ^DIR K DIR G:$D(DIRUT) END S PSDDF=Y
"RTN","PSDDSOR",28,0)
 W ! S DIR("A")="Include expired orders",DIR(0)="Y",DIR("B")="NO" D ^DIR
"RTN","PSDDSOR",29,0)
 K DIR G:$D(DIRUT) END S PSDXF=Y
"RTN","PSDDSOR",30,0)
 W ! S DIR("A")="Include pending orders",DIR(0)="Y",DIR("B")="NO" D ^DIR
"RTN","PSDDSOR",31,0)
 K DIR G:$D(DIRUT) END S PSDPO=Y
"RTN","PSDDSOR",32,0)
SL S (CT,PSDRG,PSDPR,PSDPT,PSDSC)=1,DP="Within ",DIR("B")="Drug" K SRT,SR
"RTN","PSDDSOR",33,0)
 S OP="D:Drug;PR:Provider;PA:Patient;S:Schedule"
"RTN","PSDDSOR",34,0)
 F  D KV S DIR(0)="SAO^"_OP D  Q:OP=""!($D(DUOUT))!($D(DTOUT))!($D(DIRUT))
"RTN","PSDDSOR",35,0)
 .S:CT=1 DIR("B")="Drug" K:CT>1 DIR("B")
"RTN","PSDDSOR",36,0)
 .S DIR("A")=$S(CT>1:DP,1:"")_"Sort By: " D ^DIR
"RTN","PSDDSOR",37,0)
 .Q:$D(DIRUT)
"RTN","PSDDSOR",38,0)
 .S O="" F I=1:1:$L(OP,";") S J=$P(OP,";",I) I J'[Y(0) S O=O_$S(O="":"",1:";")_J
"RTN","PSDDSOR",39,0)
 .S OP=O
"RTN","PSDDSOR",40,0)
 .S SRT(CT)=Y,SR(Y)=CT S CT=CT+1,DP=DP_$S(Y="D":"Drug, ",Y="PR":"Provider, ",Y="PA":"Patient, ",1:"Schedule, ")
"RTN","PSDDSOR",41,0)
 .D @Y
"RTN","PSDDSOR",42,0)
 G:$D(DUOUT)!($D(DTOUT)) END
"RTN","PSDDSOR",43,0)
 I $D(SRT) K SR S I="" D  G:$D(DIRUT) END G:'Y SL
"RTN","PSDDSOR",44,0)
 .W !!,"You have selected the following:",!
"RTN","PSDDSOR",45,0)
 .F  S I=$O(SRT(I)) Q:I=""  D
"RTN","PSDDSOR",46,0)
 ..S J=SRT(I),SR(I)=$S(J="D":"DRUG",J="PR":"PROV",J="PA":"PAT",1:"SCH")
"RTN","PSDDSOR",47,0)
 ..W !?5,$S(J="D":"Drug",J="PR":"Provider",J="PA":"Patient",1:"Schedule")
"RTN","PSDDSOR",48,0)
 .W ! D KV S DIR("A")="Continue to print:",DIR("B")="Y",DIR(0)="YN" D ^DIR
"RTN","PSDDSOR",49,0)
 G DEV Q
"RTN","PSDDSOR",50,0)
D ;ask drug(s)
"RTN","PSDDSOR",51,0)
 W !!,?5,"You may select a single drug, several drugs,",!,?5,"or enter ^ALL to select all drugs.",!!
"RTN","PSDDSOR",52,0)
 K DRG,DIC S PSDRG=0,DIC("A")="Select DRUG: ",DIC=50,DIC(0)="QEAM"
"RTN","PSDDSOR",53,0)
 S DIC("S")="I $S('$D(^(""I"")):1,'^(""I""):1,DT'>+^(""I""):1,1:0),$P($G(^(2)),""^"",3)[""O"",$D(^PSDRUG(""ASP"",+$G(^(2)),+Y)),+$P(^PSDRUG(+Y,0),""^"",3)&(+$P(^PSDRUG(+Y,0),""^"",3)<6)"
"RTN","PSDDSOR",54,0)
 F  D ^DIC Q:Y<0  S DRG(+Y)=""
"RTN","PSDDSOR",55,0)
 K DIC I X="^ALL" S PSDRG=1 K DUOUT Q
"RTN","PSDDSOR",56,0)
 Q:($D(DUOUT))!($D(DTOUT))
"RTN","PSDDSOR",57,0)
 I '$D(DRG)&(Y<0) G D
"RTN","PSDDSOR",58,0)
 Q
"RTN","PSDDSOR",59,0)
PR ;ask provider(s)
"RTN","PSDDSOR",60,0)
 W !!,?5,"You may select a single provider, several providers,",!,?5,"or enter ^ALL to select all providers.",!!
"RTN","PSDDSOR",61,0)
 K PRO,DIC S PSDPR=0,DIC="^VA(200,",DIC(0)="QEAM",DIC("A")="Select Provider: "
"RTN","PSDDSOR",62,0)
 F  D ^DIC Q:Y<0  S PRO(+Y)=""
"RTN","PSDDSOR",63,0)
 K DIC I X="^ALL" S PSDPR=1 K DUOUT Q
"RTN","PSDDSOR",64,0)
 Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSDDSOR",65,0)
 I '$D(PRO)&(Y<0) G PR
"RTN","PSDDSOR",66,0)
 Q
"RTN","PSDDSOR",67,0)
PA ;ask provider(s)
"RTN","PSDDSOR",68,0)
 W !!,?5,"You may select a single patient, several patients,",!,?5,"or enter ^ALL to select all patients.",!!
"RTN","PSDDSOR",69,0)
 K PAT,DIC S PSDPT=0,DIC=2,DIC(0)="QEAM",DIC("A")="Select Patient: "
"RTN","PSDDSOR",70,0)
 F  D ^DIC Q:Y<0  S PAT(+Y)=""
"RTN","PSDDSOR",71,0)
 K DIC I X="^ALL" S PSDPT=1 K DUOUT Q
"RTN","PSDDSOR",72,0)
 Q:$D(DUOUT)!($D(DTOUT))
"RTN","PSDDSOR",73,0)
 I '$D(PAT)&(Y<0) G PA
"RTN","PSDDSOR",74,0)
 Q
"RTN","PSDDSOR",75,0)
S ;
"RTN","PSDDSOR",76,0)
 W !! K SCH,PSDSC D KV S DIR("A")="Include All CS Schedules: ",DIR("B")="Y",DIR(0)="YN" D ^DIR
"RTN","PSDDSOR",77,0)
 Q:$D(DIRUT)
"RTN","PSDDSOR",78,0)
 I Y S PSDSC=1 Q
"RTN","PSDDSOR",79,0)
 F I=1:1:7 W !,?5,$S(I=1:"1 - SCHEDULE I",I=2:"2 - SCHEDULE II",I=3:"3 - SCHEDULE II NON-NARCOTICS",I=4:"4 - SCHEDULE III",I=5:"5 - SCHEDULE III NON-NARCOTICS",I=6:"6 - SCHEDULE IV NARCOTICS",1:"7 - SCHEDULE V NARCOTICS")
"RTN","PSDDSOR",80,0)
 W ! D KV
"RTN","PSDDSOR",81,0)
 S DIR(0)="L^1:7" D ^DIR Q:$D(DIRUT)
"RTN","PSDDSOR",82,0)
 I Y,$L(Y,",")-1=1 S Y=+Y,SCH($S(Y<3:Y,Y=3:"2n",Y=4:3,Y=5:"3n",1:Y-2))="" Q
"RTN","PSDDSOR",83,0)
 F I=1:1:$L(Y,",")-1 S J=+$P(Y,",",I) S SCH($S(J<3:J,J=3:"2n",J=4:3,J=5:"3n",1:J-2))=""
"RTN","PSDDSOR",84,0)
 Q
"RTN","PSDDSOR",85,0)
DEV K %ZIS,IOP,POP,ZTSK S PSDIO=ION,%ZIS="QM" D ^%ZIS K %ZIS
"RTN","PSDDSOR",86,0)
 I POP S IOP=PSDIO D ^%ZIS K IOP,PSDIO W !,"Please try later!" G END
"RTN","PSDDSOR",87,0)
 K PSDIO I $D(IO("Q")) K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK D  G END
"RTN","PSDDSOR",88,0)
 .S ZTRTN="EN^PSDDSOR",ZTDESC="Digitally Signed CS Orders Report"
"RTN","PSDDSOR",89,0)
 .F G="PSDDV","PSDSD","PSDBD","PSDED","PSDDF","PSDXF","PSDPO","PSDRG","PSDPR","PSDPT","PSDSC" S:$D(@G) ZTSAVE(G)=""
"RTN","PSDDSOR",90,0)
 .S ZTSAVE("SRT(")="",ZTSAVE("SR(")="" S:$D(PRO) ZTSAVE("PRO(")="" S:$D(DRG) ZTSAVE("DRG(")="" S:$D(PAT) ZTSAVE("PAT(")="" S:$D(SCH) ZTSAVE("SCH(")=""
"RTN","PSDDSOR",91,0)
 .D ^%ZTLOAD W:$D(ZTSK) !,"Report is Queued to print !!" K ZTSK
"RTN","PSDDSOR",92,0)
EN ;
"RTN","PSDDSOR",93,0)
 K ^TMP($J) S (I,NS)=0 F  S I=$O(SR(I)) Q:'I  S NS=I
"RTN","PSDDSOR",94,0)
 S PND=0,TY="APKI",POS=PSDSD F  S PSDSD=$O(^PSRX(TY,PSDSD)) Q:'PSDSD!(PSDSD>PSDED)  D EN1
"RTN","PSDDSOR",95,0)
 D:PSDPO EN2 D PSTR G END
"RTN","PSDDSOR",96,0)
 Q
"RTN","PSDDSOR",97,0)
EN1 S RX=0 F  S RX=$O(^PSRX(TY,PSDSD,RX)) Q:'RX  D
"RTN","PSDDSOR",98,0)
 .Q:'$D(^PSRX(RX,0))  Q:$P(^(2),"^",9)'=PSDDV  S RX0=^(0),ORD=$P($G(^("OR1")),"^",2)
"RTN","PSDDSOR",99,0)
 .Q:'$P(RX0,"^",2)!('$P(RX0,"^",4))!('$P(RX0,"^",6))!('ORD)
"RTN","PSDDSOR",100,0)
 .D GETD
"RTN","PSDDSOR",101,0)
 Q
"RTN","PSDDSOR",102,0)
EN2 S DV=0,FI=52.41,PND=1
"RTN","PSDDSOR",103,0)
 F  S POS=$O(^PS(FI,TY,POS)) Q:'POS!(POS>(PSDED_".999999"))  S DV=0 F  S DV=$O(^PS(FI,TY,POS,DV)) Q:'DV  D
"RTN","PSDDSOR",104,0)
 .S RX=0 F  S RX=$O(^PS(FI,TY,POS,DV,RX)) Q:'RX  D
"RTN","PSDDSOR",105,0)
 ..Q:'$D(^PS(FI,RX,0))  S RX0=^(0)
"RTN","PSDDSOR",106,0)
 ..I $P(RX0,"^",3)["NW"!($P(RX0,"^",3)="DC") I $P(RX0,"^",24) S ORD=$P(RX0,"^") D GETD
"RTN","PSDDSOR",107,0)
 Q
"RTN","PSDDSOR",108,0)
GETD ;
"RTN","PSDDSOR",109,0)
 I $G(PSDPT) G GETD1
"RTN","PSDDSOR",110,0)
 Q:'$D(PAT($P(RX0,"^",2)))
"RTN","PSDDSOR",111,0)
GETD1 ;
"RTN","PSDDSOR",112,0)
 D GETDATA^ORWOR1(.Y,ORD,$P(RX0,"^",2)) Q:Y<0  D:$G(PND)
"RTN","PSDDSOR",113,0)
 .S Y=Y_"^"_$P(RX0,"^",3)
"RTN","PSDDSOR",114,0)
 .I $P(RX0,"^",3)="DC",$G(^PS(52.41,RX,4))]"" D
"RTN","PSDDSOR",115,0)
 ..S Y=Y_"^"_$TR(^PS(52.41,RX,4),":",","),$P(Y,"^",4)="5;DISCONTINUED"
"RTN","PSDDSOR",116,0)
 D CONT
"RTN","PSDDSOR",117,0)
 Q
"RTN","PSDDSOR",118,0)
CONT ;
"RTN","PSDDSOR",119,0)
 S ORS=+$P(Y,"^",4) Q:'ORS!('PSDXF&(ORS=7))
"RTN","PSDDSOR",120,0)
 Q:'PSDDF&(",1,12,13,"[(","_ORS_","))
"RTN","PSDDSOR",121,0)
 S S1=$S(ORS=5:4,ORS=7:3,",1,12,13,"[(","_ORS_","):2,1:1)
"RTN","PSDDSOR",122,0)
 S PAT=$P($G(Y(1)),"^") Q:PAT=""
"RTN","PSDDSOR",123,0)
 S DRUG=$S($P($G(Y(2)),"^")]"":$P(Y(2),"^"),$P($G(Y(6)),"^")]"":$P(Y(6),"^"),1:"")
"RTN","PSDDSOR",124,0)
 G:$G(PSDRG) CT1
"RTN","PSDDSOR",125,0)
 Q:'$D(DRG($P(Y(2),"^",2)))
"RTN","PSDDSOR",126,0)
CT1 S PROV=$P($G(Y(4)),"^") Q:PROV=""
"RTN","PSDDSOR",127,0)
 G:$G(PSDPR) CT2
"RTN","PSDDSOR",128,0)
 Q:'$D(PRO($P(Y(4),"^",2)))
"RTN","PSDDSOR",129,0)
CT2 S SCH=$P($G(Y(2)),"^",5) Q:SCH=""
"RTN","PSDDSOR",130,0)
 G:$G(PSDSC) CT3
"RTN","PSDDSOR",131,0)
 Q:'$D(SCH($P(Y(2),"^",5)))
"RTN","PSDDSOR",132,0)
CT3 I NS=4 D  Q
"RTN","PSDDSOR",133,0)
 .S ^TMP($J,S1,@(SR(1)),@(SR(2)),@(SR(3)),@(SR(4)),RX,0)=Y,I=0
"RTN","PSDDSOR",134,0)
 .F  S I=$O(Y(I)) Q:'I  S ^TMP($J,S1,@(SR(1)),@(SR(2)),@(SR(3)),@(SR(4)),RX,I)=Y(I)
"RTN","PSDDSOR",135,0)
 I NS=3 D  Q
"RTN","PSDDSOR",136,0)
 .S ^TMP($J,S1,@(SR(1)),@(SR(2)),@(SR(3)),RX,0)=Y,I=0
"RTN","PSDDSOR",137,0)
 .F  S I=$O(Y(I)) Q:'I  S ^TMP($J,S1,@(SR(1)),@(SR(2)),@(SR(3)),RX,I)=Y(I)
"RTN","PSDDSOR",138,0)
 I NS=2 D  Q
"RTN","PSDDSOR",139,0)
 .S ^TMP($J,S1,@(SR(1)),@(SR(2)),RX,0)=Y,I=0
"RTN","PSDDSOR",140,0)
 .F  S I=$O(Y(I)) Q:'I  S ^TMP($J,S1,@(SR(1)),@(SR(2)),RX,I)=Y(I)
"RTN","PSDDSOR",141,0)
 S ^TMP($J,S1,@(SR(1)),RX,0)=Y,I=0
"RTN","PSDDSOR",142,0)
 F  S I=$O(Y(I)) Q:'I  S ^TMP($J,S1,@(SR(1)),RX,I)=Y(I)
"RTN","PSDDSOR",143,0)
 Q
"RTN","PSDDSOR",144,0)
 ;
"RTN","PSDDSOR",145,0)
PSTR D NOW^%DTC S TDT=$E(%,4,5)_"/"_$E(%,6,7)_"/"_$E(%,2,3)_"@"_$E(%,9,10)_":"_$E(%,11,12)
"RTN","PSDDSOR",146,0)
 N P1,P2 S $E(P1,42)="",$E(P2,12)="",PG=1,Y=PSDBD D D^DIQ S BDT=Y,Y=PSDED D D^DIQ S EDT=Y
"RTN","PSDDSOR",147,0)
 S DVN=$$GET1^DIQ(59,PSDDV,.01) S:DVN]"" DVN=$E(DVN,1,20) S:DVN="" DVN="N/A"
"RTN","PSDDSOR",148,0)
 U IO I '$D(^TMP($J)) D HD W !!,"**********    NO DATA TO PRINT   **********",!! Q
"RTN","PSDDSOR",149,0)
 D @("N"_NS)
"RTN","PSDDSOR",150,0)
 Q
"RTN","PSDDSOR",151,0)
IN K Y0,Y1,Y2,Y3,Y4,Y5,Y6 S S6=""
"RTN","PSDDSOR",152,0)
 Q
"RTN","PSDDSOR",153,0)
WR S PG=1 D HD W !,$S(AC=1:"Processed",AC=2:"Discontinued",AC=3:"Expired",1:"Pending")_" Orders:",! Q
"RTN","PSDDSOR",154,0)
N4 S AC="" F  S AC=$O(^TMP($J,AC)) Q:'AC  D WR D  Q:$D(DIRUT)  D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR",155,0)
 .S S1="" F  S S1=$O(^TMP($J,AC,S1)) Q:S1=""  S S2="" F  S S2=$O(^TMP($J,AC,S1,S2)) Q:S2=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",156,0)
 ..S S3="" F  S S3=$O(^TMP($J,AC,S1,S2,S3)) Q:S3=""  S S4="" F  S S4=$O(^TMP($J,AC,S1,S2,S3,S4)) Q:S4=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",157,0)
 ...S S5="" F  S S5=$O(^TMP($J,AC,S1,S2,S3,S4,S5)) Q:S5=""  D STR4 Q:$D(DIRUT)
"RTN","PSDDSOR",158,0)
 Q
"RTN","PSDDSOR",159,0)
STR4 ;
"RTN","PSDDSOR",160,0)
 D IN F  S S6=$O(^TMP($J,AC,S1,S2,S3,S4,S5,S6)) Q:S6=""  S Z="Y"_S6,@Z=^TMP($J,AC,S1,S2,S3,S4,S5,S6)
"RTN","PSDDSOR",161,0)
 D PRT Q
"RTN","PSDDSOR",162,0)
N3 S AC="" F  S AC=$O(^TMP($J,AC)) Q:'AC  D WR D  Q:$D(DIRUT)  D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR",163,0)
 .S S1="" F  S S1=$O(^TMP($J,AC,S1)) Q:S1=""  S S2="" F  S S2=$O(^TMP($J,AC,S1,S2)) Q:S2=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",164,0)
 ..S S3="" F  S S3=$O(^TMP($J,AC,S1,S2,S3)) Q:S3=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",165,0)
 ...S S5="" F  S S5=$O(^TMP($J,AC,S1,S2,S3,S5)) Q:S5=""  D STR3 Q:$D(DIRUT)
"RTN","PSDDSOR",166,0)
 Q
"RTN","PSDDSOR",167,0)
STR3 D IN F  S S6=$O(^TMP($J,AC,S1,S2,S3,S5,S6)) Q:S6=""  S Z="Y"_S6,@Z=^TMP($J,AC,S1,S2,S3,S5,S6)
"RTN","PSDDSOR",168,0)
 D PRT Q
"RTN","PSDDSOR",169,0)
N2 S AC="" F  S AC=$O(^TMP($J,AC)) Q:'AC  D WR D  Q:$D(DIRUT)  D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR",170,0)
 .S S1="" F  S S1=$O(^TMP($J,AC,S1)) Q:S1=""  S S2="" F  S S2=$O(^TMP($J,AC,S1,S2)) Q:S2=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",171,0)
 ..S S5="" F  S S5=$O(^TMP($J,AC,S1,S2,S5)) Q:S5=""  D STR2 Q:$D(DIRUT)
"RTN","PSDDSOR",172,0)
 Q
"RTN","PSDDSOR",173,0)
STR2 D IN F  S S6=$O(^TMP($J,AC,S1,S2,S5,S6)) Q:S6=""  S Z="Y"_S6,@Z=^TMP($J,AC,S1,S2,S5,S6)
"RTN","PSDDSOR",174,0)
 D PRT Q
"RTN","PSDDSOR",175,0)
N1 S AC="" F  S AC=$O(^TMP($J,AC)) Q:'AC  D WR D  Q:$D(DIRUT)  D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR",176,0)
 .S S1="" F  S S1=$O(^TMP($J,AC,S1)) Q:S1=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR",177,0)
 ..S S5="" F  S S5=$O(^TMP($J,AC,S1,S5)) Q:S5=""  D STR1 Q:$D(DIRUT)
"RTN","PSDDSOR",178,0)
 Q
"RTN","PSDDSOR",179,0)
STR1 D IN F  S S6=$O(^TMP($J,AC,S1,S5,S6)) Q:S6=""  S Z="Y"_S6,@Z=^TMP($J,AC,S1,S5,S6)
"RTN","PSDDSOR",180,0)
 D PRT
"RTN","PSDDSOR",181,0)
 Q
"RTN","PSDDSOR",182,0)
PRT D:($Y+4)>IOSL HD Q:$D(DIRUT)  D PRT^PSDDSOR1
"RTN","PSDDSOR",183,0)
 Q
"RTN","PSDDSOR",184,0)
HD D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR",185,0)
 W @IOF,!?2,"Digitally Signed CS Orders Report for Division "_DVN,?70,"Page: ",PG
"RTN","PSDDSOR",186,0)
 W !,?8,"Date Range: "_BDT_" - "_EDT,?53,"Printed on: "_TDT,!
"RTN","PSDDSOR",187,0)
 S PG=PG+1
"RTN","PSDDSOR",188,0)
 Q
"RTN","PSDDSOR",189,0)
HD1 I PG>1,$E(IOST)="C" K DIR S DIR(0)="E",DIR("A")=" Press Return to Continue or ^ to Exit" D ^DIR K DIR
"RTN","PSDDSOR",190,0)
 Q
"RTN","PSDDSOR",191,0)
END W ! D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDDSOR",192,0)
 K ^TMP($J),PSDDV,PSDSD,PSDED,PSDDF,PSDXF,DRG,PRO,PAT,PND,SCH,SRT,PSDRG,PSDPR,PSDPT,PSDSC,VA,Y0,Y1,Y2,Y3,Y4,Y5,Y6
"RTN","PSDDSOR",193,0)
KV K DIR,DIRUT,DTOUT,DUOUT
"RTN","PSDDSOR",194,0)
 Q
"RTN","PSDDSOR1")
0^2^B8766491
"RTN","PSDDSOR1",1,0)
PSDDSOR1 ;BHM/MHA - Digitally signed CS Orders Report; 08/30/02
"RTN","PSDDSOR1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**40**;13 Feb 97
"RTN","PSDDSOR1",3,0)
 ;Ref. to ^PSRX( supported by DBIA 1977
"RTN","PSDDSOR1",4,0)
 ;Ref. to ^PS(52.41, supported by DBIA 3848
"RTN","PSDDSOR1",5,0)
 ;
"RTN","PSDDSOR1",6,0)
 Q
"RTN","PSDDSOR1",7,0)
PRT I ($Y+13)>IOSL D:AC HD^PSDDSOR D:'AC HD^PSDDSOR2 Q:$D(DIRUT)
"RTN","PSDDSOR1",8,0)
 S I=0,PL=""
"RTN","PSDDSOR1",9,0)
 I $P($G(Y2),"^")]"" S PL=$E($P(Y2,"^"),1,30)
"RTN","PSDDSOR1",10,0)
 E  S PL=$E($P($G(Y6),"^"),1,30),I=1
"RTN","PSDDSOR1",11,0)
 W !?1," DRUG"_$S($G(I):" (OI)",1:"")_": "_PL,?50,"CS Federal Schedule: "_$P(Y2,"^",5)
"RTN","PSDDSOR1",12,0)
 W !?2,"Provider: "_$E($P(Y4,"^")_P1,1,30),?50,"DEA #: "_$S($P(Y4,"^",3)]"":$P(Y4,"^",3),$P(Y4,"^",2):$$DEA^XUSER(,$P(Y4,"^",2)),1:"")
"RTN","PSDDSOR1",13,0)
 S PL=$P(Y5,"^"),PL1="" F I=2:1:6 S J=$P(Y5,"^",I) D:J]""
"RTN","PSDDSOR1",14,0)
 .I $L(J)+$L(PL)<60 S PL=PL_", "_J
"RTN","PSDDSOR1",15,0)
 .E  S PL1=PL1_$S(PL1]"":", ",1:"")_J
"RTN","PSDDSOR1",16,0)
 W !?2,"Provider Address: "_PL W:PL1]"" !?23,PL1
"RTN","PSDDSOR1",17,0)
 W !?2,"CPRS Order #: "_$P(Y0,"^",2),?50,"Date Order Written: " S Y=$P(Y0,"^",5) I Y W $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)
"RTN","PSDDSOR1",18,0)
 W !?2,"Patient Name: "_$E($P(Y1,"^")_P1,1,30),?50,"PATIENT ID: "
"RTN","PSDDSOR1",19,0)
 S DFN=$S($D(^PSRX(S5,0)):$P(^PSRX(S5,0),"^",2),1:$P($G(^PS(52.41,S5,0)),"^",2)) D PID^VADPT W $E($P(Y1,"^"))_VA("BID")
"RTN","PSDDSOR1",20,0)
 S PL=$P(Y1,"^",2),PL1="" F I=3:1:7 S J=$P(Y1,"^",I) D:J]""
"RTN","PSDDSOR1",21,0)
 .I $L(J)+$L(PL)<60 S PL=PL_", "_J
"RTN","PSDDSOR1",22,0)
 .E  S PL1=PL1_$S(PL1]"":", ",1:"")_J
"RTN","PSDDSOR1",23,0)
 W !?2,"Patient Address: "_PL W:PL1]"" !?19,PL1
"RTN","PSDDSOR1",24,0)
 W !?2,"Rx #: "_$S($D(^PSRX(S5,0)):$P(^PSRX(S5,0),"^"),1:""),?50,"Qty: "_$P(Y2,"^",3)
"RTN","PSDDSOR1",25,0)
 W !?2,"SIG: "
"RTN","PSDDSOR1",26,0)
 S PL=0 I AC'=4,$D(^PSRX(S5,"SIG1")) D  G P1
"RTN","PSDDSOR1",27,0)
 .F  S PL=$O(^PSRX(S5,"SIG1",PL)) Q:'PL  W:PL>1 ! W ?7,^PSRX(S5,"SIG1",PL,0)
"RTN","PSDDSOR1",28,0)
 I AC=4,$D(^PS(52.41,S5,"SIG")) D  G P1
"RTN","PSDDSOR1",29,0)
 .F  S PL=$O(^PS(52.41,S5,"SIG",PL)) Q:'PL  W:PL>1 ! W ?7,^PS(52.41,S5,"SIG",PL,0)
"RTN","PSDDSOR1",30,0)
 W ?7,$P(Y3,"^")
"RTN","PSDDSOR1",31,0)
P1 S RX2=$S($D(^PSRX(S5,2)):^PSRX(S5,2),1:"")
"RTN","PSDDSOR1",32,0)
 W !?2,"Date Filled: " S Y=$P(RX2,"^",2) I Y W $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)
"RTN","PSDDSOR1",33,0)
 W ?50,"Date Released: " S Y=$P(RX2,"^",13) I Y W $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)
"RTN","PSDDSOR1",34,0)
 W !?2,"Releasing Pharmacist: "_$S($P(RX2,"^",3):$P(^VA(200,$P(RX2,"^",3),0),"^"),1:"")
"RTN","PSDDSOR1",35,0)
 W ?50,"Valid PKI Certificate?: "
"RTN","PSDDSOR1",36,0)
 N FL0 S FL0="Yes",Y=$P(RX2,"^",2)
"RTN","PSDDSOR1",37,0)
 I $D(^PSRX(S5,"A")) N FL S FL=0 F  S FL=$O(^PSRX(S5,"A",FL)) Q:'FL!(FL0="No")  I $P(^PSRX(S5,"A",FL,0),"^",2)="K" S FL0="No",Y=$P($P(^(0),"^"),".")
"RTN","PSDDSOR1",38,0)
 W FL0
"RTN","PSDDSOR1",39,0)
 W !?2,"Date Signature Validation Attempted by Pharmacy: "
"RTN","PSDDSOR1",40,0)
 I Y W $E(Y,4,5)_"/"_$E(Y,6,7)_"/"_$E(Y,2,3)
"RTN","PSDDSOR1",41,0)
 W !?2,"CPRS Nature of Order: "_$P(Y0,"^",3),?50,"CPRS Status: "_$P($P(Y0,"^",4),";",2)
"RTN","PSDDSOR1",42,0)
 S PL=$S($P(Y0,"^",7)]"":$P(Y0,"^",7),$P(Y0,"^"):"Digitally Signed",1:"")
"RTN","PSDDSOR1",43,0)
 W !?2,"Signature Status: "_$E(PL,1,60) W:$L(PL)>60 !,?20,$E(PL,61,200) W !
"RTN","PSDDSOR1",44,0)
 Q
"RTN","PSDDSOR2")
0^3^B21366672
"RTN","PSDDSOR2",1,0)
PSDDSOR2 ;BIR/MHA-Digitally Signed OP Released Rx Report; 05/09/03
"RTN","PSDDSOR2",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**40**;13 Feb 97
"RTN","PSDDSOR2",3,0)
 ;Ref. ^PSD(58.8 supp. by IA 2711
"RTN","PSDDSOR2",4,0)
 ;Ref. ^PSD(58.81 supp. by IA 2808
"RTN","PSDDSOR2",5,0)
 ;Ref. ^PSRX( supp. by IA 1977
"RTN","PSDDSOR2",6,0)
 ;Ref. ^PS(59 supp. by IA 212
"RTN","PSDDSOR2",7,0)
 ;Ref. ^PSDRUG( supp. by IA 221
"RTN","PSDDSOR2",8,0)
BEG I '$D(PSDSITE) D ^PSDSET G:'$D(PSDSITE) END
"RTN","PSDDSOR2",9,0)
 N PSDV,PSDL,PSDLN,PSDB,PSDS,PSDE,PSDRG,DRG
"RTN","PSDDSOR2",10,0)
 D DT^DICRW
"RTN","PSDDSOR2",11,0)
 S PSDL=$P(PSDSITE,U,3),PSDLN=$P(PSDSITE,U,4)
"RTN","PSDDSOR2",12,0)
 S DIC="^PSD(58.8,",DIC(0)="AEQ",DIC("A")="Select Dispensing Site: "
"RTN","PSDDSOR2",13,0)
 S DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$S($P($G(^(0)),U,2)[""M"":1,$P($G(^(0)),U,2)[""S"":1,1:0),($S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0))"
"RTN","PSDDSOR2",14,0)
 S DIC("B")=$P(PSDSITE,U,4)
"RTN","PSDDSOR2",15,0)
 W ! D ^DIC K DIC G:Y<0 END
"RTN","PSDDSOR2",16,0)
 S $P(PSDSITE,U,3)=+Y,PSDL=+Y,$P(PSDSITE,U,4)=$P(Y,U,2),PSDLN=$P(Y,U,2),PSDV=PSDSITE
"RTN","PSDDSOR2",17,0)
 W ! K %DT S %DT(0)=-DT,%DT="AEP",%DT("A")="Start Date: " D ^%DT
"RTN","PSDDSOR2",18,0)
 G:Y<0 END
"RTN","PSDDSOR2",19,0)
 S (%DT(0),PSDB)=Y,%DT("A")="End Date: "
"RTN","PSDDSOR2",20,0)
 W ! D ^%DT G:Y<0 END
"RTN","PSDDSOR2",21,0)
 S PSDE=Y,PSDS=PSDB-.000001
"RTN","PSDDSOR2",22,0)
D ;ask drug(s)
"RTN","PSDDSOR2",23,0)
 W !!,?5,"You may select a single drug, several drugs,",!,?5,"or enter ^ALL to select all drugs.",!!
"RTN","PSDDSOR2",24,0)
 K DRG,DIC S PSDRG=0,DIC="^PSD(58.8,PSDL,1,",DIC(0)="AEQM"
"RTN","PSDDSOR2",25,0)
 S DIC("A")="Please Select "_PSDLN_"'s Drug: ",DIC("S")="I $S($G(^(""I"")):$G(^(""I""))>DT,1:1)"
"RTN","PSDDSOR2",26,0)
 F  D ^DIC Q:Y<0  D
"RTN","PSDDSOR2",27,0)
 .I '$O(^PSD(58.81,"F",+Y,0)) W !!,"There have been no transactions for this drug.",!! Q
"RTN","PSDDSOR2",28,0)
 .S DRG(+Y)=""
"RTN","PSDDSOR2",29,0)
 K DIC I X="^ALL" S PSDRG=1 G DEV
"RTN","PSDDSOR2",30,0)
 G:$D(DTOUT)!($D(DUOUT)) END
"RTN","PSDDSOR2",31,0)
 I '$D(DRG)&(Y<0) G D
"RTN","PSDDSOR2",32,0)
DEV K %ZIS,IOP,POP,ZTSK S PSDIO=ION,%ZIS="QM" D ^%ZIS K %ZIS
"RTN","PSDDSOR2",33,0)
 I POP S IOP=PSDIO D ^%ZIS K IOP,PSDIO W !,"Please try later!" G END
"RTN","PSDDSOR2",34,0)
 K PSDIO I $D(IO("Q")) K IO("Q"),ZTIO,ZTSAVE,ZTDTH,ZTSK D  G END
"RTN","PSDDSOR2",35,0)
 .S ZTRTN="EN^PSDDSOR2",ZTDESC="Digitally Signed OP Released Rx Report"
"RTN","PSDDSOR2",36,0)
 .F G="PSDL","PSDLN","PSDV","PSDS","PSDB","PSDE","PSDRG" S:$D(@G) ZTSAVE(G)=""
"RTN","PSDDSOR2",37,0)
 .S:$D(DRG) ZTSAVE("DRG(")=""
"RTN","PSDDSOR2",38,0)
 .D ^%ZTLOAD W:$D(ZTSK) !,"Report is Queued to print !!" K ZTSK
"RTN","PSDDSOR2",39,0)
EN ;
"RTN","PSDDSOR2",40,0)
 K ^TMP($J)
"RTN","PSDDSOR2",41,0)
 N RX,RX0,RX2,ORD,DR,TDT,BDT,EDT,DFN,PL,PL1,P1,P2,PG,AC,S1,S2,S5,S6,Y0,Y1,Y2,Y3,Y4,Y5,Y6
"RTN","PSDDSOR2",42,0)
 N ST,STD,PR,DRN,DV,DVD,I,J,Z,RC
"RTN","PSDDSOR2",43,0)
 F  S PSDS=$O(^PSRX("AL",PSDS)) Q:'PSDS!(PSDS>(PSDE_".99999"))  D
"RTN","PSDDSOR2",44,0)
 .S RX=0 F  S RX=$O(^PSRX("AL",PSDS,RX)) Q:'RX  I $D(^PSRX(RX,"PKI")),$O(^PSD(58.81,"AOP",RX,0)) D
"RTN","PSDDSOR2",45,0)
 ..S RC=$O(^PSD(58.81,"AOP",RX,0)) Q:'$D(^PSD(58.81,RC))
"RTN","PSDDSOR2",46,0)
 ..Q:RX'=$P(^PSD(58.81,RC,6),U)
"RTN","PSDDSOR2",47,0)
 ..Q:PSDL'=$P(^PSD(58.81,RC,0),U,3)
"RTN","PSDDSOR2",48,0)
 ..Q:'$D(^PSRX(RX,0))  S RX0=^(0),DR=$P(RX0,U,6)
"RTN","PSDDSOR2",49,0)
 ..Q:DR'=$P(^PSD(58.81,RC,0),U,5)
"RTN","PSDDSOR2",50,0)
 ..D:$G(PSDRG)!($D(DRG(DR))) GD
"RTN","PSDDSOR2",51,0)
 D NOW^%DTC S TDT=$E(%,4,5)_"/"_$E(%,6,7)_"/"_$E(%,2,3)_"@"_$E(%,9,10)_":"_$E(%,11,12)
"RTN","PSDDSOR2",52,0)
 S AC=0,$E(P1,42)="",$E(P2,12)="",PG=1,Y=PSDB D D^DIQ S BDT=Y,Y=PSDE D D^DIQ S EDT=Y
"RTN","PSDDSOR2",53,0)
 U IO D HD I '$D(^TMP($J)) W !!,"**********    NO DATA TO PRINT   **********",!! G END
"RTN","PSDDSOR2",54,0)
 D PRD
"RTN","PSDDSOR2",55,0)
END ;
"RTN","PSDDSOR2",56,0)
 W ! D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDDSOR2",57,0)
 K ^TMP($J)
"RTN","PSDDSOR2",58,0)
 Q
"RTN","PSDDSOR2",59,0)
GD ;
"RTN","PSDDSOR2",60,0)
 S DFN=$P(RX0,U,2),RX2=^PSRX(RX,2),PR=$P(RX0,U,4),ORD=$P($G(^("OR1")),U,2),ST=+$P($G(^("STA")),U) Q:'$D(^("PKI"))
"RTN","PSDDSOR2",61,0)
 Q:'DFN!('PR)!('DR)!('ORD)
"RTN","PSDDSOR2",62,0)
 S DRN=$P($G(^PSDRUG(DR,0)),U),DRN=$S(DRN]"":DRN,1:"UNKNOWN DRUG")
"RTN","PSDDSOR2",63,0)
 S STD=$P("ERROR^ACTIVE^NON-VERIFIED^REFILL FILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^DONE^EXPIRED^DISCONTINUED^DISCONTINUED^DISCONTINUED^DISCONTINUED(EDIT)^HOLD^","^",ST+2)
"RTN","PSDDSOR2",64,0)
 S ST=ST_";"_STD D ADD^VADPT
"RTN","PSDDSOR2",65,0)
 S ^TMP($J,PSDS,DRN,RX,0)="1"_U_ORD_U_U_ST_U_$P(RX2,U)
"RTN","PSDDSOR2",66,0)
 S ^TMP($J,PSDS,DRN,RX,1)=$P(^DPT(DFN,0),U)_U_VAPA(1)_U_VAPA(2)_U_VAPA(3)_U_VAPA(4)_U_$P(VAPA(5),U,2)_U_VAPA(6)
"RTN","PSDDSOR2",67,0)
 S ^TMP($J,PSDS,DRN,RX,2)=DRN_U_DR_U_$P(RX0,U,7)_U_U_$P($G(^PSDRUG(DR,0)),U,3)
"RTN","PSDDSOR2",68,0)
 S ^TMP($J,PSDS,DRN,RX,3)=""
"RTN","PSDDSOR2",69,0)
 S ^TMP($J,PSDS,DRN,RX,4)=$P($G(^VA(200,PR,0)),U)_U_PR_U_$$DEA^XUSER(,PR)
"RTN","PSDDSOR2",70,0)
 S DV=+$P(RX2,U,9),DVD=$G(^PS(59,DV,0))
"RTN","PSDDSOR2",71,0)
 S ^TMP($J,PSDS,DRN,RX,5)=$P(DVD,U,1,2)_U_U_$P(DVD,U,7)_U_$P(^DIC(5,+$P(DVD,U,8),0),U)_U_$P(DVD,U,5)
"RTN","PSDDSOR2",72,0)
 Q
"RTN","PSDDSOR2",73,0)
PRD S S1=0 F  S S1=$O(^TMP($J,S1)) Q:'S1  D  Q:$D(DIRUT)
"RTN","PSDDSOR2",74,0)
 .S S2="" F  S S2=$O(^TMP($J,S1,S2)) Q:S2=""  D  Q:$D(DIRUT)
"RTN","PSDDSOR2",75,0)
 ..S S5=0 F  S S5=$O(^TMP($J,S1,S2,S5)) Q:'S5  D PR  Q:$D(DIRUT)
"RTN","PSDDSOR2",76,0)
 Q
"RTN","PSDDSOR2",77,0)
PR K Y0,Y1,Y2,Y3,Y4,Y5,Y6 S S6=""
"RTN","PSDDSOR2",78,0)
 F  S S6=$O(^TMP($J,S1,S2,S5,S6)) Q:S6=""  S Z="Y"_S6,@Z=^TMP($J,S1,S2,S5,S6)
"RTN","PSDDSOR2",79,0)
 D:($Y+4)>IOSL HD Q:$D(DIRUT)  S Y6="" D PRT^PSDDSOR1
"RTN","PSDDSOR2",80,0)
 Q
"RTN","PSDDSOR2",81,0)
HD D HD1 Q:$D(DIRUT)
"RTN","PSDDSOR2",82,0)
 W @IOF,!?2,"Digitally Signed OP Released Rx Report for Vault "_PSDLN,?70,"Page: ",PG
"RTN","PSDDSOR2",83,0)
 W !,?8,"Date Range: "_BDT_" - "_EDT,?53,"Printed on: "_TDT,!
"RTN","PSDDSOR2",84,0)
 S PG=PG+1
"RTN","PSDDSOR2",85,0)
 Q
"RTN","PSDDSOR2",86,0)
HD1 I PG>1,$E(IOST)="C" K DIR S DIR(0)="E",DIR("A")=" Press Return to Continue or ^ to Exit" D ^DIR K DIR
"RTN","PSDDSOR2",87,0)
 Q
"VER")
8.0^22.0
**END**
**END**
