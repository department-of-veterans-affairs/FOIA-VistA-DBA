Released RG*1*18 SEQ #17
Extracted from mail message
**KIDS**:RG*1.0*18^

**INSTALL NAME**
RG*1.0*18
"BLD",1273,0)
RG*1.0*18^CLINICAL INFO RESOURCE NETWORK^0^3010531^y
"BLD",1273,1,0)
^^3^3^3010531^
"BLD",1273,1,1,0)
REMOVE REFERENCES TO EXTENSIBLE EDITOR
"BLD",1273,1,2,0)
Refer to patch RG*1*18 in the FORUM Patch Module for a complete
"BLD",1273,1,3,0)
description.
"BLD",1273,4,0)
^9.64PA^^
"BLD",1273,"ABNS",0)
^9.66A^^
"BLD",1273,"ABPKG")
^^
"BLD",1273,"KRN",0)
^9.67PA^19^17
"BLD",1273,"KRN",.4,0)
.4
"BLD",1273,"KRN",.401,0)
.401
"BLD",1273,"KRN",.402,0)
.402
"BLD",1273,"KRN",.403,0)
.403
"BLD",1273,"KRN",.5,0)
.5
"BLD",1273,"KRN",.84,0)
.84
"BLD",1273,"KRN",3.6,0)
3.6
"BLD",1273,"KRN",3.8,0)
3.8
"BLD",1273,"KRN",9.2,0)
9.2
"BLD",1273,"KRN",9.8,0)
9.8
"BLD",1273,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",1273,"KRN",9.8,"NM",1,0)
RGHLEXC^^1^
"BLD",1273,"KRN",9.8,"NM",2,0)
RGHLLOG^^0^B22052038
"BLD",1273,"KRN",9.8,"NM",3,0)
RGHLLOG1^^0^B15708363
"BLD",1273,"KRN",9.8,"NM","B","RGHLEXC",1)

"BLD",1273,"KRN",9.8,"NM","B","RGHLLOG",2)

"BLD",1273,"KRN",9.8,"NM","B","RGHLLOG1",3)

"BLD",1273,"KRN",19,0)
19
"BLD",1273,"KRN",19,"NM",0)
^9.68A^2^2
"BLD",1273,"KRN",19,"NM",1,0)
RGHL EXCEPTION^^1^
"BLD",1273,"KRN",19,"NM",2,0)
RG IRM MENU^^2
"BLD",1273,"KRN",19,"NM","B","RG IRM MENU",2)

"BLD",1273,"KRN",19,"NM","B","RGHL EXCEPTION",1)

"BLD",1273,"KRN",19.1,0)
19.1
"BLD",1273,"KRN",101,0)
101
"BLD",1273,"KRN",409.61,0)
409.61
"BLD",1273,"KRN",771,0)
771
"BLD",1273,"KRN",870,0)
870
"BLD",1273,"KRN",8994,0)
8994
"BLD",1273,"KRN","B",.4,.4)

"BLD",1273,"KRN","B",.401,.401)

"BLD",1273,"KRN","B",.402,.402)

"BLD",1273,"KRN","B",.403,.403)

"BLD",1273,"KRN","B",.5,.5)

"BLD",1273,"KRN","B",.84,.84)

"BLD",1273,"KRN","B",3.6,3.6)

"BLD",1273,"KRN","B",3.8,3.8)

"BLD",1273,"KRN","B",9.2,9.2)

"BLD",1273,"KRN","B",9.8,9.8)

"BLD",1273,"KRN","B",19,19)

"BLD",1273,"KRN","B",19.1,19.1)

"BLD",1273,"KRN","B",101,101)

"BLD",1273,"KRN","B",409.61,409.61)

"BLD",1273,"KRN","B",771,771)

"BLD",1273,"KRN","B",870,870)

"BLD",1273,"KRN","B",8994,8994)

"BLD",1273,"QUES",0)
^9.62^^
"BLD",1273,"REQB",0)
^9.611^1^1
"BLD",1273,"REQB",1,0)
RG*1.0*13^2
"BLD",1273,"REQB","B","RG*1.0*13",1)

"KRN",19,5662,-1)
2^2
"KRN",19,5662,0)
RG IRM MENU^CIRN IRM Menu^^M^^^^^^^^272
"KRN",19,5662,10,0)
^19.01IP^2^2
"KRN",19,5662,10,2,0)
5482^^10
"KRN",19,5662,10,2,"^")
RGHL EXCEPTION
"KRN",19,5662,"U")
CIRN IRM MENU
"KRN",19,6731,-1)
1^1
"KRN",19,6731,0)
RGHL EXCEPTION
"MBREQ")
0
"ORD",0,9.8)
9.8;;1;RTNF^XPDTA;RTNE^XPDTA
"ORD",0,9.8,0)
ROUTINE
"ORD",18,19)
19;18;;;OPT^XPDTA;OPTF1^XPDIA;OPTE1^XPDIA;OPTF2^XPDIA;;OPTDEL^XPDIA
"ORD",18,19,0)
OPTION
"PKG",272,-1)
1^1
"PKG",272,0)
CLINICAL INFO RESOURCE NETWORK^RG^CIRN
"PKG",272,20,0)
^9.402P^^0
"PKG",272,22,0)
^9.49I^1^1
"PKG",272,22,1,0)
1.0^2990430^2990601^12555
"PKG",272,22,1,"PAH",1,0)
18^3010531
"PKG",272,22,1,"PAH",1,1,0)
^^3^3^3010531
"PKG",272,22,1,"PAH",1,1,1,0)
REMOVE REFERENCES TO EXTENSIBLE EDITOR
"PKG",272,22,1,"PAH",1,1,2,0)
Refer to patch RG*1*18 in the FORUM Patch Module for a complete
"PKG",272,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","RGHLEXC")
1^1
"RTN","RGHLLOG")
0^2^B22052038
"RTN","RGHLLOG",1,0)
RGHLLOG ;CAIRO/DKM-LOG MESSAGE PROCESSING INFO ;09/04/98
"RTN","RGHLLOG",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**1,3,11,13,18**;30 Apr 99
"RTN","RGHLLOG",3,0)
 ;=================================================================
"RTN","RGHLLOG",4,0)
 ; Log information about message processing and exceptions
"RTN","RGHLLOG",5,0)
 ; in CIRN HL7 Exception Log file.
"RTN","RGHLLOG",6,0)
 ;=================================================================
"RTN","RGHLLOG",7,0)
 ; Start time for run log
"RTN","RGHLLOG",8,0)
START(RGMSG,RGDC,RGPARAM) ;
"RTN","RGHLLOG",9,0)
 ;This entry point starts the log process in the CIRN HL7 EXCEPTION LOG
"RTN","RGHLLOG",10,0)
 ;file (#991.1), if the (#6) MINIMAL EXCEPTION LOGGING? field in
"RTN","RGHLLOG",11,0)
 ;File #990.8 is set to 0.
"RTN","RGHLLOG",12,0)
 ; Input: Required
"RTN","RGHLLOG",13,0)
 ;   RGMSG - IEN of message entry in File #773, usually HLMTIEN
"RTN","RGHLLOG",14,0)
 ;        Optional
"RTN","RGHLLOG",15,0)
 ;   RGDC - Event Class, associated with an entry in File #
"RTN","RGHLLOG",16,0)
 ;   RGPARAM - reprocessing routine
"RTN","RGHLLOG",17,0)
 S U="^"
"RTN","RGHLLOG",18,0)
 K RGLOG
"RTN","RGHLLOG",19,0)
 S RGLOG(3)=$G(RGMSG),RGLOG(5)=$G(RGDC),RGLOG(4)=$G(RGPARAM),RGLOG(1)=$$NOW^XLFDT
"RTN","RGHLLOG",20,0)
 I '$P(^RGSITE("COR",1,0),U,8) S RGLOG=$$CREATE
"RTN","RGHLLOG",21,0)
 Q
"RTN","RGHLLOG",22,0)
 ; Create a log entry
"RTN","RGHLLOG",23,0)
CREATE() Q:$G(RGLOG) RGLOG
"RTN","RGHLLOG",24,0)
 L +^RGHL7(991.1,0):10
"RTN","RGHLLOG",25,0)
 S RGLOG=$O(^RGHL7(991.1,$C(32)),-1)+1
"RTN","RGHLLOG",26,0)
 S:$G(RGLOG(1))="" RGLOG(1)=$$NOW^XLFDT
"RTN","RGHLLOG",27,0)
 S RGLOG(3)=$S($G(RGLOG(3))=0:0,$G(HL("MID"))="":"",1:$$IEN773($G(HL("MID"))))
"RTN","RGHLLOG",28,0)
 S (DA,X)=RGLOG,DIC="^RGHL7(991.1,",DIC(0)="L",DLAYGO=991.1,DIC("DR")="1///"_$G(RGLOG(1))_";3////"_$G(RGLOG(3))_";5///"_$G(RGLOG(5))_";4////"_$G(RGLOG(4)) K DD,DO D FILE^DICN K DIC,DA,X,DLAYGO
"RTN","RGHLLOG",29,0)
 L -^RGHL7(991.1,0)
"RTN","RGHLLOG",30,0)
 Q RGLOG
"RTN","RGHLLOG",31,0)
 ; Log time run completed
"RTN","RGHLLOG",32,0)
STOP(RGQUIT) ;
"RTN","RGHLLOG",33,0)
 ;This entry point completes the logging process
"RTN","RGHLLOG",34,0)
 ; Input: required
"RTN","RGHLLOG",35,0)
 ;    RGQUIT - 0 for success and 1 for failure
"RTN","RGHLLOG",36,0)
 ;
"RTN","RGHLLOG",37,0)
 Q:'$G(RGLOG)
"RTN","RGHLLOG",38,0)
 L +^RGHL7(991.1,RGLOG):10
"RTN","RGHLLOG",39,0)
 S DIE="^RGHL7(991.1,",DR="1.5///NOW;1.6///^S X=$G(RGQUIT)",DA=RGLOG D ^DIE K DIE,DA,DR
"RTN","RGHLLOG",40,0)
 L -^RGHL7(991.1,RGLOG)
"RTN","RGHLLOG",41,0)
 K RGLOG,RGQUIT,X,Y,DIC,DIE
"RTN","RGHLLOG",42,0)
 Q
"RTN","RGHLLOG",43,0)
 ; Log unclassified exception (old entry point)
"RTN","RGHLLOG",44,0)
ERR(RGERR,RGSEV) ;
"RTN","RGHLLOG",45,0)
 D EXC(18,RGERR)
"RTN","RGHLLOG",46,0)
 S RGQUIT=$G(RGQUIT)!$G(RGSEV)
"RTN","RGHLLOG",47,0)
 Q
"RTN","RGHLLOG",48,0)
 ; Log an exception
"RTN","RGHLLOG",49,0)
EXC(RGEXC,RGERR,RGDFN,MSGID,STATNUM) ;
"RTN","RGHLLOG",50,0)
 ;This entry point logs exceptions in the CIRN HL7 EXCEPTION LOG
"RTN","RGHLLOG",51,0)
 ;file (#991.1)
"RTN","RGHLLOG",52,0)
 ; Input: Required
"RTN","RGHLLOG",53,0)
 ;   RGEXC - Exception type in File #991.11
"RTN","RGHLLOG",54,0)
 ;   RGERR - Supplemental text
"RTN","RGHLLOG",55,0)
 ;        Optional
"RTN","RGHLLOG",56,0)
 ;   RGDFN - IEN in the PATIENT file (#2)
"RTN","RGHLLOG",57,0)
 ;   MSGID - message id of the HL7 message where the exception was encountered (optional)
"RTN","RGHLLOG",58,0)
 ;   STATNUM - station # of site that encountered the error (optional) - if not defined then the local site is assumed, using $$SITE^VASITE
"RTN","RGHLLOG",59,0)
 ;
"RTN","RGHLLOG",60,0)
 I $L($G(HL("MID"))) Q:$$INVEXC(HL("MID"))  ; is the exception valid?
"RTN","RGHLLOG",61,0)
 N RGI,RGZ
"RTN","RGHLLOG",62,0)
 S U="^"
"RTN","RGHLLOG",63,0)
 S:RGEXC[U RGERR=$P(RGEXC,U,2,999),RGEXC=+RGEXC
"RTN","RGHLLOG",64,0)
 S:RGEXC'=+RGEXC RGERR=RGEXC,RGEXC=18
"RTN","RGHLLOG",65,0)
 S:'$D(^RGHL7(991.11,RGEXC)) RGEXC=18
"RTN","RGHLLOG",66,0)
 L +^RGHL7(991.11,RGEXC):10
"RTN","RGHLLOG",67,0)
 S RGZ=$G(^RGHL7(991.11,RGEXC,0))
"RTN","RGHLLOG",68,0)
 S:$L(RGZ) $P(^RGHL7(991.11,RGEXC,0),U,5)=$P(RGZ,U,5)+1
"RTN","RGHLLOG",69,0)
 S:$P(RGZ,U,2)>1 RGQUIT=1
"RTN","RGHLLOG",70,0)
 L -^RGHL7(991.11,RGEXC)
"RTN","RGHLLOG",71,0)
 S RGLOG=$$CREATE
"RTN","RGHLLOG",72,0)
 L +^RGHL7(991.1,RGLOG):10
"RTN","RGHLLOG",73,0)
 S RGI=$O(^RGHL7(991.1,RGLOG,1,$C(32)),-1)+1
"RTN","RGHLLOG",74,0)
 S RGERR=$E($G(RGERR),1,250)
"RTN","RGHLLOG",75,0)
 S DIC="^RGHL7(991.1,"_RGLOG_",1,"
"RTN","RGHLLOG",76,0)
 S X=RGI,DA(1)=RGLOG,DIC(0)="FL",DLAYGO=991.12,DIC("P")=$P(^DD(991.1,2,0),"^",2)
"RTN","RGHLLOG",77,0)
 D ^DIC
"RTN","RGHLLOG",78,0)
 S DIE=DIC
"RTN","RGHLLOG",79,0)
 K DIC,DA,DR,DLAYGO
"RTN","RGHLLOG",80,0)
 S STAT=0
"RTN","RGHLLOG",81,0)
 S DIC="3.8",DIC(0)="Z",X="MPIF EXCEPTIONS" D ^DIC K DIC
"RTN","RGHLLOG",82,0)
 S RGMG=$P($G(Y),"^",1)
"RTN","RGHLLOG",83,0)
 I $P(^RGHL7(991.11,RGEXC,0),U,4)=RGMG S STAT=1
"RTN","RGHLLOG",84,0)
 S DA(1)=RGLOG,DA=RGI,DR="2///"_$G(RGEXC)_";3///"_$G(RGDFN)_";6///"_$G(STAT)_";10///"_$G(RGERR)
"RTN","RGHLLOG",85,0)
 D ^DIE K DIE,DA,DR
"RTN","RGHLLOG",86,0)
 L -^RGHL7(991.1,RGLOG)
"RTN","RGHLLOG",87,0)
 S RGI=$P(RGZ,U,3),RGZ=$P(RGZ,U,4)
"RTN","RGHLLOG",88,0)
 ;
"RTN","RGHLLOG",89,0)
 ;If the action type is for the MPI Exception Handler, send exception to the handler and quit
"RTN","RGHLLOG",90,0)
 I (RGI=3) D SENDMPI^RGHLLOG1($G(RGEXC),$G(RGERR),$G(RGDFN),$G(MSGID),$G(STATNUM)) Q
"RTN","RGHLLOG",91,0)
 ;
"RTN","RGHLLOG",92,0)
 Q:'RGI!'RGZ
"RTN","RGHLLOG",93,0)
 ;quit and don't send messages for exception types that are now being
"RTN","RGHLLOG",94,0)
 ;handled through the CIRN Exception Handling option.
"RTN","RGHLLOG",95,0)
 Q:RGEXC=209!((RGEXC>212)&(RGEXC<219))
"RTN","RGHLLOG",96,0)
 S DIC="^XMB(3.8,",DIC(0)="NZ",X="`"_RGZ D ^DIC K DIC Q:+Y<1  S RGZ=$P(Y,U,2) K Y
"RTN","RGHLLOG",97,0)
 Q:RGZ=""!$P($G(^RGSITE("COR",1,0)),U,7)
"RTN","RGHLLOG",98,0)
 S RGERR=$$SHORT(RGEXC,RGERR),RGZ="G."_RGZ
"RTN","RGHLLOG",99,0)
 I RGI=2 D ALERT^RGRSUTL2(RGERR,RGZ) Q
"RTN","RGHLLOG",100,0)
 D MAIL^RGRSUTL2(RGERR,RGZ,"CIRN Exception: "_$$SHORT(RGEXC),"MPI/PD exception notification")
"RTN","RGHLLOG",101,0)
 Q
"RTN","RGHLLOG",102,0)
 ;
"RTN","RGHLLOG",103,0)
INVEXC(RGMID) ; determine if this exception needs to be sent to MPI/PD
"RTN","RGHLLOG",104,0)
 ; personnel via FORUM. Return 1 to avoid messaging to FORUM, else 0.
"RTN","RGHLLOG",105,0)
 ; IA#:3244 is applied in this functionality
"RTN","RGHLLOG",106,0)
 N RGFLG,RGIEN S RGFLG=1
"RTN","RGHLLOG",107,0)
 S RGIEN=$$IEN773(RGMID) Q:'RGIEN RGFLG
"RTN","RGHLLOG",108,0)
 S RGIEN("SND")=$$GET1^DIQ(773,RGIEN_",",13)
"RTN","RGHLLOG",109,0)
 S RGIEN("REC")=$$GET1^DIQ(773,RGIEN_",",14)
"RTN","RGHLLOG",110,0)
 ; check the sending application (fld:13, 0;11) & the receiving
"RTN","RGHLLOG",111,0)
 ; application (fld:14, 0;12) to see if they are related to the MPI/PD
"RTN","RGHLLOG",112,0)
 ; project.
"RTN","RGHLLOG",113,0)
 I RGIEN("SND")]""!(RGIEN("REC")]"") D  Q RGFLG
"RTN","RGHLLOG",114,0)
 .S RGFLG=$$APP(RGIEN("SND")) Q:'RGFLG
"RTN","RGHLLOG",115,0)
 .S RGFLG=$$APP(RGIEN("REC"))
"RTN","RGHLLOG",116,0)
 .Q
"RTN","RGHLLOG",117,0)
 ; Only if the sending/receiving applications cannot be determined from
"RTN","RGHLLOG",118,0)
 ; the data in their respective fields, do I check the MSH multiple for
"RTN","RGHLLOG",119,0)
 ; the MSH segment. I identify the sending/receiving application from
"RTN","RGHLLOG",120,0)
 ; this segment. 
"RTN","RGHLLOG",121,0)
 E  D
"RTN","RGHLLOG",122,0)
 .N RG,RG1,RGMSH,RGFS
"RTN","RGHLLOG",123,0)
 .D GETS^DIQ(773,RGIEN_",",200,,"RGMSH") ;check MSH mult for snd/rec app
"RTN","RGHLLOG",124,0)
 .Q:'($D(RGMSH)\10)  ; no data in "MSH" multiple for file 773
"RTN","RGHLLOG",125,0)
 .S RGIEN=RGIEN_",",RG="RGMSH(773,"""_RGIEN_""","_200_")"
"RTN","RGHLLOG",126,0)
 .S RG1=0 F  S RG1=$O(@RG@(RG1)) Q:RG1'>0  D  Q:$E($G(@RG@(RG1)),1,3)="MSH"
"RTN","RGHLLOG",127,0)
 ..I $E($G(@RG@(RG1)),1,3)="MSH" D
"RTN","RGHLLOG",128,0)
 ...S RG(0)=$G(@RG@(RG1)),RGFS=$E(RG(0),4)
"RTN","RGHLLOG",129,0)
 ...S:$P(RG(0),RGFS,3)]"" RGFLG=$$APP($P(RG(0),RGFS,3)) Q:'RGFLG
"RTN","RGHLLOG",130,0)
 ...S:$P(RG(0),RGFS,5)]"" RGFLG=$$APP($P(RG(0),RGFS,5))
"RTN","RGHLLOG",131,0)
 ...Q
"RTN","RGHLLOG",132,0)
 ..Q
"RTN","RGHLLOG",133,0)
 .Q
"RTN","RGHLLOG",134,0)
 Q RGFLG
"RTN","RGHLLOG",135,0)
APP(X) ; check if the sending/receiving application is relevant to the
"RTN","RGHLLOG",136,0)
 ; MPI/PD team.  Returns 1 if a non-relevant namespace, else 0
"RTN","RGHLLOG",137,0)
 I $E(X,1,2)="RG"!($E(X,1,2)="VA")!($E(X,1,3)="MPI") Q 0
"RTN","RGHLLOG",138,0)
 Q 1
"RTN","RGHLLOG",139,0)
 ;
"RTN","RGHLLOG",140,0)
IEN773(RGMID) ; find the ien of the record in the HL7 MESSAGE ADMINISTRATION
"RTN","RGHLLOG",141,0)
 ; (#773) file based on the Message ID.  Input: Message ID
"RTN","RGHLLOG",142,0)
 ; Output: null, no record in 773, else 773 record ien.  IA#: 3244
"RTN","RGHLLOG",143,0)
 Q:$G(RGMID)="" ""
"RTN","RGHLLOG",144,0)
 Q $O(^HLMA("C",RGMID,0))
"RTN","RGHLLOG",145,0)
 ;
"RTN","RGHLLOG",146,0)
SHORT(RGEXC,RGTXT) ;
"RTN","RGHLLOG",147,0)
 ; Retrieve short text description of exception
"RTN","RGHLLOG",148,0)
 Q $G(^RGHL7(991.11,+RGEXC,10))_$S($G(RGTXT)="":"",1:": "_RGTXT)
"RTN","RGHLLOG",149,0)
 ;
"RTN","RGHLLOG1")
0^3^B15708363
"RTN","RGHLLOG1",1,0)
RGHLLOG1 ;ALB/CJM-SEND EXCEPTION TO MPI EXCEPTION HANDLER ;11/25/2000
"RTN","RGHLLOG1",2,0)
 ;;1.0;CLINICAL INFO RESOURCE NETWORK;**13,18**;30 Apr 99
"RTN","RGHLLOG1",3,0)
 ;
"RTN","RGHLLOG1",4,0)
 ;Reference to file 870 supported by IA #3335
"RTN","RGHLLOG1",5,0)
 ;Reference to file 391.72 supported by IA #3037
"RTN","RGHLLOG1",6,0)
 ;References to file 773 supported by IA #3244 and 3273
"RTN","RGHLLOG1",7,0)
 ;
"RTN","RGHLLOG1",8,0)
SENDMPI(RGEXC,RGERR,RGDFN,MSGID,STATNUM) ;
"RTN","RGHLLOG1",9,0)
 ;Description: Sends the exception to the MPI Exception Handler.
"RTN","RGHLLOG1",10,0)
 ;Input: Required
"RTN","RGHLLOG1",11,0)
 ;  RGEXC - Exception type in File #991.11
"RTN","RGHLLOG1",12,0)
 ;  RGERR - Supplemental text
"RTN","RGHLLOG1",13,0)
 ;       Optional
"RTN","RGHLLOG1",14,0)
 ;  RGDFN - IEN in the PATIENT file (#2)
"RTN","RGHLLOG1",15,0)
 ;  MSGID - message id of message being processed when the exception occurred (optional), uses RGLOG(3) or HL("MID") if not defined
"RTN","RGHLLOG1",16,0)
 ;  STATNUM - station # of site that encountered the error (optional)
"RTN","RGHLLOG1",17,0)
 ;         If not defined then local site is assumed, using $$SITE^VASITE
"RTN","RGHLLOG1",18,0)
 ;Output: none
"RTN","RGHLLOG1",19,0)
 ;
"RTN","RGHLLOG1",20,0)
 ;Variables:
"RTN","RGHLLOG1",21,0)
 ;  @RGMSG is the location for the message text
"RTN","RGHLLOG1",22,0)
 ;
"RTN","RGHLLOG1",23,0)
 N RGMSG
"RTN","RGHLLOG1",24,0)
 S RGMSG="^TMP($J,""RG MPI SERVER EXCEPTION"")"
"RTN","RGHLLOG1",25,0)
 K @RGMSG
"RTN","RGHLLOG1",26,0)
 ;
"RTN","RGHLLOG1",27,0)
 D ADDLINE("**MPI/PD EXCEPTION**")
"RTN","RGHLLOG1",28,0)
 D ADDDATA("EXCEPTION TYPE",$G(RGEXC))
"RTN","RGHLLOG1",29,0)
 D ADDDATA("OPTIONAL TEXT",$G(RGERR))
"RTN","RGHLLOG1",30,0)
 D ADDDATA("SITE OF OCCURRENCE",$S($D(STATNUM):STATNUM,1:$P($$SITE^VASITE(),"^",3)))
"RTN","RGHLLOG1",31,0)
 D ADDDATA("SITE REPORTING",$P($$SITE^VASITE(),"^",3))
"RTN","RGHLLOG1",32,0)
 D ADDDATA("DATE/TIME REPORTED",$$NOW^XLFDT)
"RTN","RGHLLOG1",33,0)
 I $G(RGDFN) D
"RTN","RGHLLOG1",34,0)
 .N OUT,SITE
"RTN","RGHLLOG1",35,0)
 .D GETALL^RGFIU(RGDFN,.OUT)
"RTN","RGHLLOG1",36,0)
 .D ADDLINE("**PATIENT DATA**")
"RTN","RGHLLOG1",37,0)
 .D ADDDATA("ICN",OUT("ICN"))
"RTN","RGHLLOG1",38,0)
 .D ADDDATA("NAME",$$NAME^RGFIU(RGDFN))
"RTN","RGHLLOG1",39,0)
 .D ADDDATA("SSN",$$SSN^RGFIU(RGDFN))
"RTN","RGHLLOG1",40,0)
 .D ADDDATA("CMOR",OUT("CMOR"))
"RTN","RGHLLOG1",41,0)
 .S SITE=""
"RTN","RGHLLOG1",42,0)
 .F  S SITE=$O(OUT("TF",SITE)) Q:(SITE="")  D ADDLINE("**"),ADDDATA("TREATING FACILITY",SITE),ADDDATA("DATE LAST TREATED",OUT("TF",SITE,"LASTDATE")),ADDDATA("EVENT REASON",$$GETFIELD^RGFIU(391.72,.01,OUT("TF",SITE,"EVENT")))
"RTN","RGHLLOG1",43,0)
 K OUT
"RTN","RGHLLOG1",44,0)
 I $$GETMSG($G(MSGID),.OUT) D
"RTN","RGHLLOG1",45,0)
 .N SUB
"RTN","RGHLLOG1",46,0)
 .D ADDLINE("**HL7 MESSAGE**")
"RTN","RGHLLOG1",47,0)
 .S SUB=""
"RTN","RGHLLOG1",48,0)
 .F  S SUB=$O(OUT(SUB)) Q:(SUB="")  D ADDDATA(SUB,OUT(SUB))
"RTN","RGHLLOG1",49,0)
 D ADDLINE("**END**")
"RTN","RGHLLOG1",50,0)
 I $$MAIL
"RTN","RGHLLOG1",51,0)
 K @RGMSG
"RTN","RGHLLOG1",52,0)
 ;
"RTN","RGHLLOG1",53,0)
 Q
"RTN","RGHLLOG1",54,0)
 ;
"RTN","RGHLLOG1",55,0)
SERVER() ;
"RTN","RGHLLOG1",56,0)
 ;Description: Returns the <server name>@<server domain>. This entry
"RTN","RGHLLOG1",57,0)
 ;returns the Servers location either at the test MPI or Production MPI.
"RTN","RGHLLOG1",58,0)
 ;If a null is returned the MAIL subroutine will default to the MPIF
"RTN","RGHLLOG1",59,0)
 ;EXCEPTIONS mail group
"RTN","RGHLLOG1",60,0)
 ;
"RTN","RGHLLOG1",61,0)
 ;Input: none
"RTN","RGHLLOG1",62,0)
 ;Output: Where to send the exception.Returns the <server name>@<server domain> or Null
"RTN","RGHLLOG1",63,0)
 ;
"RTN","RGHLLOG1",64,0)
 N TO,IEN
"RTN","RGHLLOG1",65,0)
 S TO=""
"RTN","RGHLLOG1",66,0)
 ; get MPI logical link
"RTN","RGHLLOG1",67,0)
 D LINK^HLUTIL3("200M",.HLL,"I")
"RTN","RGHLLOG1",68,0)
 ; get MPI domain DBIA 3335
"RTN","RGHLLOG1",69,0)
 S IEN=$O(HLL(0)) I +IEN>0 S TO=$$GET1^DIQ(870,+IEN_",",.03) I TO'="" S TO="S.MPI EXCEPTION SERVER@"_TO
"RTN","RGHLLOG1",70,0)
 Q TO
"RTN","RGHLLOG1",71,0)
 ;
"RTN","RGHLLOG1",72,0)
ADDDATA(LABEL,DATA) ;
"RTN","RGHLLOG1",73,0)
 ;Description: Adds one formated line to the message text containing the label and data value
"RTN","RGHLLOG1",74,0)
 ;Input:
"RTN","RGHLLOG1",75,0)
 ;  LABEL - text label that identifies the type of data
"RTN","RGHLLOG1",76,0)
 ;  DATA - data value
"RTN","RGHLLOG1",77,0)
 ;Output:none
"RTN","RGHLLOG1",78,0)
 ; 
"RTN","RGHLLOG1",79,0)
 D ADDLINE(LABEL_":"_DATA)
"RTN","RGHLLOG1",80,0)
 Q
"RTN","RGHLLOG1",81,0)
ADDLINE(LINE) ;
"RTN","RGHLLOG1",82,0)
 ;Description: adds one one to the message text
"RTN","RGHLLOG1",83,0)
 ;Inputs:
"RTN","RGHLLOG1",84,0)
 ;  LINE - the line of text to be added
"RTN","RGHLLOG1",85,0)
 ;  RGMSG - @RGMSG is the location for the message text
"RTN","RGHLLOG1",86,0)
 ;Output: none
"RTN","RGHLLOG1",87,0)
 S @RGMSG@(($O(@RGMSG@(9999),-1)+1))=LINE
"RTN","RGHLLOG1",88,0)
 Q
"RTN","RGHLLOG1",89,0)
MAIL() ;
"RTN","RGHLLOG1",90,0)
 ;Description: Sends the message located at @RGMSG to the MPI Exception Handler
"RTN","RGHLLOG1",91,0)
 ;Input: message at @RGMSG
"RTN","RGHLLOG1",92,0)
 ;Output: If succssful, the function returns the mailman message number, otherwise, "" is returned
"RTN","RGHLLOG1",93,0)
 ;
"RTN","RGHLLOG1",94,0)
 N XMY,XMSUB,XMDUZ,XMTEXT,XMZ,XMDUN,DIFROM,SERVER
"RTN","RGHLLOG1",95,0)
 Q:'$D(@RGMSG) ""
"RTN","RGHLLOG1",96,0)
 S SERVER=$$SERVER
"RTN","RGHLLOG1",97,0)
 ;if the MPI server isn't returned default to the old MPIF EXCEPTIONS mail group
"RTN","RGHLLOG1",98,0)
 I SERVER="" S SERVER="MPIF EXCEPTIONS"
"RTN","RGHLLOG1",99,0)
 S XMDUZ="MPI/PD at "_$P($$SITE^VASITE(),"^",2)
"RTN","RGHLLOG1",100,0)
 S XMY(.5)=""
"RTN","RGHLLOG1",101,0)
 S XMY(SERVER)=""
"RTN","RGHLLOG1",102,0)
 S XMTEXT=$P(RGMSG,")")_","
"RTN","RGHLLOG1",103,0)
 S XMSUB="MPI/PD EXCEPTION"
"RTN","RGHLLOG1",104,0)
 D ^XMD
"RTN","RGHLLOG1",105,0)
 Q $G(XMZ)
"RTN","RGHLLOG1",106,0)
 ;
"RTN","RGHLLOG1",107,0)
GETMSG(MSGID,MSGARRAY) ;
"RTN","RGHLLOG1",108,0)
 ;Description: Retrieves data from the HL7 Message Administration file (#773) related to the message
"RTN","RGHLLOG1",109,0)
 ;Input:
"RTN","RGHLLOG1",110,0)
 ;  MSGID - the message id (optional)
"RTN","RGHLLOG1",111,0)
 ;  RGLOG(3) - if MSGID is not passed then RGLOG(3) is used to determine the message
"RTN","RGHLLOG1",112,0)
 ;  HL("MID") - if MSGID and RGLOG(3) are not defined then HL("MID") is used to determine the message
"RTN","RGHLLOG1",113,0)
 ;
"RTN","RGHLLOG1",114,0)
 ;Output:
"RTN","RGHLLOG1",115,0)
 ;  Function Value - 1 on success, 0 on failure
"RTN","RGHLLOG1",116,0)
 ;  MSGARRAY() - (pass by reference) - returns the data
"RTN","RGHLLOG1",117,0)
 ;          ("MESSAGE ID") - the HL7 message id
"RTN","RGHLLOG1",118,0)
 ;          ("MESSAGE TYPE") - the HL7 message type
"RTN","RGHLLOG1",119,0)
 ;          ("EVENT TYPE") - the HL7 event type
"RTN","RGHLLOG1",120,0)
 ;          ("SENDING APPLICATION") - the name of the sending application
"RTN","RGHLLOG1",121,0)
 ;          ("LOGICAL LINK") - the name of the HL Logical Link overwhich the message was received
"RTN","RGHLLOG1",122,0)
 ;
"RTN","RGHLLOG1",123,0)
 N MSGIEN
"RTN","RGHLLOG1",124,0)
 K MSGARRAY
"RTN","RGHLLOG1",125,0)
 I '$G(MSGID) D
"RTN","RGHLLOG1",126,0)
 .I $G(RGLOG(3)) S MSGID=$$GETFIELD^RGFIU(773,2,RGLOG(3)) Q:MSGID
"RTN","RGHLLOG1",127,0)
 .S MSGID=$G(HL("MID"))
"RTN","RGHLLOG1",128,0)
 Q:'MSGID 0
"RTN","RGHLLOG1",129,0)
 ;
"RTN","RGHLLOG1",130,0)
 S MSGIEN=$$IEN773^RGHLLOG(MSGID)
"RTN","RGHLLOG1",131,0)
 ;
"RTN","RGHLLOG1",132,0)
 S MSGARRAY("MESSAGE ID")=MSGID
"RTN","RGHLLOG1",133,0)
 S MSGARRAY("LOGICAL LINK")=$$GETFIELD^RGFIU(773,7,MSGIEN,,1)
"RTN","RGHLLOG1",134,0)
 S MSGARRAY("SENDING APPLICATION")=$$GETFIELD^RGFIU(773,13,MSGIEN,,1)
"RTN","RGHLLOG1",135,0)
 S MSGARRAY("MESSAGE TYPE")=$$GETFIELD^RGFIU(773,15,MSGIEN,,1)
"RTN","RGHLLOG1",136,0)
 S MSGARRAY("EVENT TYPE")=$$GETFIELD^RGFIU(773,16,MSGIEN,,1)
"RTN","RGHLLOG1",137,0)
 ;
"RTN","RGHLLOG1",138,0)
 ;this compensates for a bug in the HL7 package - the external form rather than the pointer values are being stored in file 773
"RTN","RGHLLOG1",139,0)
 I MSGID,'$L(MSGARRAY("MESSAGE TYPE")) S MSGARRAY("MESSAGE TYPE")=$$GETFIELD^RGFIU(773,15,MSGIEN)
"RTN","RGHLLOG1",140,0)
 I MSGID,'$L(MSGARRAY("EVENT TYPE")) S MSGARRAY("EVENT TYPE")=$$GETFIELD^RGFIU(773,16,MSGIEN)
"RTN","RGHLLOG1",141,0)
 ;
"RTN","RGHLLOG1",142,0)
 Q 1
"VER")
8.0^22.0
**END**
**END**
