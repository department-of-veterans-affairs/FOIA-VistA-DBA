Released MPIF*1*9 SEQ #13
Extracted from mail message
**KIDS**:MPIF*1.0*9^

**INSTALL NAME**
MPIF*1.0*9
"BLD",1784,0)
MPIF*1.0*9^MASTER PATIENT INDEX VISTA^0^3010522^y
"BLD",1784,4,0)
^9.64PA^^0
"BLD",1784,"ABNS",0)
^9.66A^^
"BLD",1784,"ABPKG")
n^^
"BLD",1784,"INID")
^y
"BLD",1784,"INIT")
MPIF109P
"BLD",1784,"KRN",0)
^9.67PA^19^17
"BLD",1784,"KRN",.4,0)
.4
"BLD",1784,"KRN",.401,0)
.401
"BLD",1784,"KRN",.402,0)
.402
"BLD",1784,"KRN",.403,0)
.403
"BLD",1784,"KRN",.5,0)
.5
"BLD",1784,"KRN",.84,0)
.84
"BLD",1784,"KRN",3.6,0)
3.6
"BLD",1784,"KRN",3.8,0)
3.8
"BLD",1784,"KRN",3.8,"NM",0)
^9.68A^^0
"BLD",1784,"KRN",9.2,0)
9.2
"BLD",1784,"KRN",9.8,0)
9.8
"BLD",1784,"KRN",9.8,"NM",0)
^9.68A^5^4
"BLD",1784,"KRN",9.8,"NM",1,0)
MPIFDEL^^0^B15234200
"BLD",1784,"KRN",9.8,"NM",3,0)
MPIFMER^^0^B12487290
"BLD",1784,"KRN",9.8,"NM",4,0)
MPIFVTQ^^0^B41794552
"BLD",1784,"KRN",9.8,"NM",5,0)
MPIF001^^0^B44166604
"BLD",1784,"KRN",9.8,"NM","B","MPIF001",5)
 
"BLD",1784,"KRN",9.8,"NM","B","MPIFDEL",1)
 
"BLD",1784,"KRN",9.8,"NM","B","MPIFMER",3)
 
"BLD",1784,"KRN",9.8,"NM","B","MPIFVTQ",4)
 
"BLD",1784,"KRN",19,0)
19
"BLD",1784,"KRN",19,"NM",0)
^9.68A^^0
"BLD",1784,"KRN",19.1,0)
19.1
"BLD",1784,"KRN",101,0)
101
"BLD",1784,"KRN",101,"NM",0)
^9.68A^^0
"BLD",1784,"KRN",409.61,0)
409.61
"BLD",1784,"KRN",771,0)
771
"BLD",1784,"KRN",771,"NM",0)
^9.68A^^0
"BLD",1784,"KRN",870,0)
870
"BLD",1784,"KRN",870,"NM",0)
^9.68A^^0
"BLD",1784,"KRN",8994,0)
8994
"BLD",1784,"KRN",8994,"NM",0)
^9.68A^^
"BLD",1784,"KRN","B",.4,.4)
 
"BLD",1784,"KRN","B",.401,.401)
 
"BLD",1784,"KRN","B",.402,.402)
 
"BLD",1784,"KRN","B",.403,.403)
 
"BLD",1784,"KRN","B",.5,.5)
 
"BLD",1784,"KRN","B",.84,.84)
 
"BLD",1784,"KRN","B",3.6,3.6)
 
"BLD",1784,"KRN","B",3.8,3.8)
 
"BLD",1784,"KRN","B",9.2,9.2)
 
"BLD",1784,"KRN","B",9.8,9.8)
 
"BLD",1784,"KRN","B",19,19)
 
"BLD",1784,"KRN","B",19.1,19.1)
 
"BLD",1784,"KRN","B",101,101)
 
"BLD",1784,"KRN","B",409.61,409.61)
 
"BLD",1784,"KRN","B",771,771)
 
"BLD",1784,"KRN","B",870,870)
 
"BLD",1784,"KRN","B",8994,8994)
 
"BLD",1784,"PRET")
 
"BLD",1784,"QUES",0)
^9.62^^
"BLD",1784,"REQB",0)
^9.611^6^3
"BLD",1784,"REQB",1,0)
MPIF*1.0*1^2
"BLD",1784,"REQB",5,0)
MPIF*1.0*3^2
"BLD",1784,"REQB",6,0)
RG*1.0*18^1
"BLD",1784,"REQB","B","MPIF*1.0*1",1)
 
"BLD",1784,"REQB","B","MPIF*1.0*3",5)
 
"BLD",1784,"REQB","B","RG*1.0*18",6)
 
"INIT")
MPIF109P
"MBREQ")
0
"PKG",474,-1)
1^1
"PKG",474,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",474,20,0)
^9.402P^^
"PKG",474,22,0)
^9.49I^1^1
"PKG",474,22,1,0)
1.0^2990428^2990603^9139
"PKG",474,22,1,"PAH",1,0)
9^3010522^9139
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")
 
"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","MPIF001")
0^5^B44166604
"RTN","MPIF001",1,0)
MPIF001 ;ALB/RJS/CMC-UTILITY ROUTINE OF APIS ;JUL 12, 1996
"RTN","MPIF001",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,9**;30 Apr 99
"RTN","MPIF001",3,0)
GETICN(DFN) ;
"RTN","MPIF001",4,0)
 ; This function returns the ICN, including checksum for a given DFN
"RTN","MPIF001",5,0)
 ; or -1^error message
"RTN","MPIF001",6,0)
 ; DFN - ien in Patient file
"RTN","MPIF001",7,0)
 ;
"RTN","MPIF001",8,0)
 N RETURN,NODE
"RTN","MPIF001",9,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT1
"RTN","MPIF001",10,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT1
"RTN","MPIF001",11,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT1
"RTN","MPIF001",12,0)
 S NODE=^DPT(DFN,"MPI")
"RTN","MPIF001",13,0)
 I $P(NODE,"^",1)'>0 S RETURN="-1^NO ICN" G EXIT1
"RTN","MPIF001",14,0)
 S RETURN=$P(NODE,"^",1)_"V"_$P(NODE,"^",2)
"RTN","MPIF001",15,0)
EXIT1 ;
"RTN","MPIF001",16,0)
 Q RETURN
"RTN","MPIF001",17,0)
 ;
"RTN","MPIF001",18,0)
GETDFN(ICN) ;
"RTN","MPIF001",19,0)
 ; Returns DFN (ien Patient file) or -1^error message for a given ICN
"RTN","MPIF001",20,0)
 ; ICN - ICN for a given Patient in the Patient file
"RTN","MPIF001",21,0)
 N RETURN,DFN
"RTN","MPIF001",22,0)
 I $G(ICN)'>0 S RETURN="-1^NO ICN" G EXIT2
"RTN","MPIF001",23,0)
 I '$D(^DPT("AICN",ICN)) S RETURN="-1^ICN NOT IN DATABASE" G EXIT2
"RTN","MPIF001",24,0)
 S DFN=$O(^DPT("AICN",ICN,0))
"RTN","MPIF001",25,0)
 I $G(DFN)'>0 S RETURN="-1^BAD ICN CROSS-REFERENCE" G EXIT2
"RTN","MPIF001",26,0)
 S RETURN=DFN
"RTN","MPIF001",27,0)
EXIT2 ;
"RTN","MPIF001",28,0)
 Q RETURN
"RTN","MPIF001",29,0)
 ;
"RTN","MPIF001",30,0)
ICNLC(DFN) ;This API will return an ICN if one exists or create and return
"RTN","MPIF001",31,0)
 ; a Local ICN and updating the appropriate fileds if a Local was created
"RTN","MPIF001",32,0)
 ; DFN= Patient IEN
"RTN","MPIF001",33,0)
 ; Returns ICN (local or National including checksum)
"RTN","MPIF001",34,0)
 ; can also return -1^Problem creating Local ICN or -1^ZZd or 5 leading 0s
"RTN","MPIF001",35,0)
 N ICN,TMP,CHKSUM,ICNX
"RTN","MPIF001",36,0)
 F  L +^DPT(DFN,"MPI"):10 Q:$T
"RTN","MPIF001",37,0)
 I '$D(ICN) S ICN=$$GETICN(DFN)
"RTN","MPIF001",38,0)
 I +ICN=-1&(+$$SEND2^VAFCUTL1(DFN,"T")=0) D
"RTN","MPIF001",39,0)
 .;no icn create a Local ICN
"RTN","MPIF001",40,0)
 .; don't create Local if ZZ'd or 5 leading 0s
"RTN","MPIF001",41,0)
 .S ICN=$$EN2^MPIFAPI()
"RTN","MPIF001",42,0)
 .S CHKSUM=$P(ICN,"V",2),ICNX=$P(ICN,"V")
"RTN","MPIF001",43,0)
 .S NOLOCK=""
"RTN","MPIF001",44,0)
 .I ICNX="" K NOLOCK S ICN="-1^PROBLEM CREATING LOCAL ICN" Q
"RTN","MPIF001",45,0)
 .S TMP=$$SETICN(DFN,ICNX,CHKSUM)
"RTN","MPIF001",46,0)
 .S TMP=$$SETLOC(DFN,1)
"RTN","MPIF001",47,0)
 .S TMP=$$CHANGE(DFN,$P($$SITE^VASITE(),"^"))
"RTN","MPIF001",48,0)
 .K NOLOCK
"RTN","MPIF001",49,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",50,0)
 I +ICN=-1 S ICN="-1^ZZd or 5 leading 0s"
"RTN","MPIF001",51,0)
 Q ICN
"RTN","MPIF001",52,0)
 ;
"RTN","MPIF001",53,0)
CMOR2(DFN) ;
"RTN","MPIF001",54,0)
 ; Returns CMOR Site Name or -1^error message
"RTN","MPIF001",55,0)
 ; DFN = Patient IEN
"RTN","MPIF001",56,0)
 N NODE
"RTN","MPIF001",57,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",58,0)
 Q:$P(NODE,"^",3)="" "-1^No CMOR"
"RTN","MPIF001",59,0)
 Q $$CMORNAME($P(NODE,"^",3))
"RTN","MPIF001",60,0)
 ;
"RTN","MPIF001",61,0)
CMORNAME(CIEN) ;
"RTN","MPIF001",62,0)
 ; Returns CMOR site name or -1^error message
"RTN","MPIF001",63,0)
 ; CIEN - ien from Institution file
"RTN","MPIF001",64,0)
 ;
"RTN","MPIF001",65,0)
 Q:CIEN="" "-1^No Institution parameter"
"RTN","MPIF001",66,0)
 N INST
"RTN","MPIF001",67,0)
 S INST=$$NNT^XUAF4(CIEN)
"RTN","MPIF001",68,0)
 Q:INST="" "-1^No Institution for that IEN"
"RTN","MPIF001",69,0)
 Q:$P(INST,"^")="" "-1^No Name for this Institution"
"RTN","MPIF001",70,0)
 Q $P(INST,"^")
"RTN","MPIF001",71,0)
 ;
"RTN","MPIF001",72,0)
GETVCCI(DFN) ;
"RTN","MPIF001",73,0)
 ; Returns CMOR or -1^error message for a given patient
"RTN","MPIF001",74,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",75,0)
 N RETURN,NODE,PTR,STANUM
"RTN","MPIF001",76,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT3
"RTN","MPIF001",77,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT3
"RTN","MPIF001",78,0)
 I '$D(^DPT(DFN,"MPI")) S RETURN="-1^NO MPI NODE" G EXIT3
"RTN","MPIF001",79,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",80,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",81,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT3
"RTN","MPIF001",82,0)
 S STANUM=$P($$NNT^XUAF4(PTR),"^",2)
"RTN","MPIF001",83,0)
 I STANUM'>0 S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT3
"RTN","MPIF001",84,0)
 S RETURN=STANUM
"RTN","MPIF001",85,0)
EXIT3 ;
"RTN","MPIF001",86,0)
 Q RETURN
"RTN","MPIF001",87,0)
 ;
"RTN","MPIF001",88,0)
CHANGE(DFN,VCCI) ;
"RTN","MPIF001",89,0)
 ; ** This function is only to be used by approved packages **
"RTN","MPIF001",90,0)
 ;
"RTN","MPIF001",91,0)
 ; This function updates the CMOR field in the Patient file
"RTN","MPIF001",92,0)
 ; DFN = ien in Patient file
"RTN","MPIF001",93,0)
 ; VCCI = CMOR ien from the institution file
"RTN","MPIF001",94,0)
 ; returned:  -1^error message - problem
"RTN","MPIF001",95,0)
 ;             1 - successful
"RTN","MPIF001",96,0)
 N RETURN,DIQUIET,DIE,DA,DR,IEN,Y,X,DIC
"RTN","MPIF001",97,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",98,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT4
"RTN","MPIF001",99,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT4
"RTN","MPIF001",100,0)
 I $G(VCCI)=""!(VCCI'?.N) S RETURN="-1^NO CMOR PASSED OR CMOR WASN'T IEN" G EXIT4
"RTN","MPIF001",101,0)
 I $E($$GETICN(DFN),1,3)=$P($$SITE^VASITE(),"^",3) S VCCI=$P($$SITE^VASITE(),"^")
"RTN","MPIF001",102,0)
 ; ^ to be sure site is self for a local icn
"RTN","MPIF001",103,0)
 S VCCI="`"_VCCI
"RTN","MPIF001",104,0)
 ; ^ Have ien stuff added to use ien instead of station number
"RTN","MPIF001",105,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",106,0)
 S DIQUIET=1
"RTN","MPIF001",107,0)
REP S DIE="^DPT(",DA=DFN,DR="991.03///^S X=VCCI"
"RTN","MPIF001",108,0)
 D ^DIE
"RTN","MPIF001",109,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",110,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",111,0)
EXIT4 ;
"RTN","MPIF001",112,0)
 Q RETURN
"RTN","MPIF001",113,0)
 ;
"RTN","MPIF001",114,0)
SETICN(DFN,ICN,CHKSUM) ;
"RTN","MPIF001",115,0)
 ; ** this function is to only be used by approved packages **
"RTN","MPIF001",116,0)
 ;
"RTN","MPIF001",117,0)
 ; This function updates the ICN and ICN Checksum fields in the Patient 
"RTN","MPIF001",118,0)
 ; file for a given patient.
"RTN","MPIF001",119,0)
 ; DFN - ien in the Patient file to be updated
"RTN","MPIF001",120,0)
 ; ICN - ICN (without checksum) to be updated
"RTN","MPIF001",121,0)
 ; CHKSUM - ICN checksum
"RTN","MPIF001",122,0)
 ; return:  -1^error message - problem
"RTN","MPIF001",123,0)
 ;          1 - successful
"RTN","MPIF001",124,0)
 N RETURN,DIQUIET,DIE,DA,DR,RGRSICN,Y,ERR
"RTN","MPIF001",125,0)
 S (RETURN,DIQUIET,RGRSICN)=1
"RTN","MPIF001",126,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT5
"RTN","MPIF001",127,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT5
"RTN","MPIF001",128,0)
 I $G(ICN)="" S RETURN="-1^NO ICN PASSED" G EXIT5
"RTN","MPIF001",129,0)
 I $G(CHKSUM)="" S RETURN="-1^NO CHKSUM PASSED" G EXIT5
"RTN","MPIF001",130,0)
 I +$$GETICN(DFN)>0 I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3),$E($$GETICN(DFN),1,3)'=$E(ICN,1,3) G EXIT5
"RTN","MPIF001",131,0)
 ; ^ stop local from overwriting a national ICN
"RTN","MPIF001",132,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S RETURN="-1^ZZ'd or 5 leading 0s" G EXIT5
"RTN","MPIF001",133,0)
 I $D(^DPT("AICN",ICN)) D
"RTN","MPIF001",134,0)
 .Q:DFN=$O(^DPT("AICN",ICN,""))
"RTN","MPIF001",135,0)
 .N RGLOG D START^RGHLLOG(0)
"RTN","MPIF001",136,0)
 .I DFN'=($O(^DPT("AICN",ICN,""))) D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_ICN_" that is already in use for Patient dfn "_$O(^DPT("AICN",ICN,""))_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIF001",137,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIF001",138,0)
 .S RETURN="-1^ICN ALREADY IN USE"
"RTN","MPIF001",139,0)
 G:+RETURN=-1 EXIT5
"RTN","MPIF001",140,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",141,0)
 S DIQUIET=1
"RTN","MPIF001",142,0)
 S DIE="^DPT(",DA=DFN,DR="991.01///^S X=ICN;991.02///^S X=CHKSUM"
"RTN","MPIF001",143,0)
 D ^DIE
"RTN","MPIF001",144,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",145,0)
 I +RETURN>0 D
"RTN","MPIF001",146,0)
 .K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",147,0)
 .I $E(ICN,1,3)=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,1)
"RTN","MPIF001",148,0)
 .I $E(ICN,1,3)'=$P($$SITE^VASITE(),"^",3) S ERR=$$SETLOC(DFN,0)
"RTN","MPIF001",149,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",150,0)
EXIT5 ;
"RTN","MPIF001",151,0)
 Q RETURN
"RTN","MPIF001",152,0)
 ;
"RTN","MPIF001",153,0)
SETLOC(DFN,DELFLAG) ;
"RTN","MPIF001",154,0)
 ; ** This function should be only used by approved packages **
"RTN","MPIF001",155,0)
 ;
"RTN","MPIF001",156,0)
 ; This function updates the LOCALLY ASSIGNED ICN field in the Patient
"RTN","MPIF001",157,0)
 ; for the given patient
"RTN","MPIF001",158,0)
 ;DFN - ien from Patient file of patient to be updated
"RTN","MPIF001",159,0)
 ;DELFLAG - 1 is to turn the flag on
"RTN","MPIF001",160,0)
 ;        - 0 is to turn off the flag
"RTN","MPIF001",161,0)
 ;
"RTN","MPIF001",162,0)
 N RETURN,DIQUIET,DIE,DA,DR,VALUE,Y
"RTN","MPIF001",163,0)
 S (RETURN,DIQUIET)=1
"RTN","MPIF001",164,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN PASSED" G EXIT6
"RTN","MPIF001",165,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT6
"RTN","MPIF001",166,0)
 I '$D(NOLOCK) D LOCK
"RTN","MPIF001",167,0)
 S DIQUIET=1,VALUE=$S($G(DELFLAG)=0:"@",1:1)
"RTN","MPIF001",168,0)
 S DIE="^DPT(",DA=DFN,DR="991.04///^S X=VALUE"
"RTN","MPIF001",169,0)
 D ^DIE
"RTN","MPIF001",170,0)
 I +$G(Y)=-1 S RETURN="-1^UNSUCCESSFUL DIE CALL"
"RTN","MPIF001",171,0)
 I +RETURN>0 K ^DPT("AMPIMIS",DFN)
"RTN","MPIF001",172,0)
 I '$D(NOLOCK) D UNLOCK
"RTN","MPIF001",173,0)
EXIT6 ;
"RTN","MPIF001",174,0)
 Q RETURN
"RTN","MPIF001",175,0)
 ;
"RTN","MPIF001",176,0)
IFLOCAL(DFN) ;
"RTN","MPIF001",177,0)
 ; This function is used to see if a patient has a local ICN
"RTN","MPIF001",178,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",179,0)
 ; returned:  0 = patient does not exist, dfn is not defined or no MPI node OR Patient does not have a local ICN
"RTN","MPIF001",180,0)
 ;            1 = patient has a Local ICN assigned
"RTN","MPIF001",181,0)
 Q:$G(DFN)="" 0
"RTN","MPIF001",182,0)
 Q:$G(^DPT(DFN,0))="" 0
"RTN","MPIF001",183,0)
 Q:'$D(^DPT(DFN,"MPI")) 0
"RTN","MPIF001",184,0)
 Q:$E($$GETICN(DFN),1,3)=$P($$SITE^VASITE,"^",3) 1
"RTN","MPIF001",185,0)
 Q 0
"RTN","MPIF001",186,0)
 ;
"RTN","MPIF001",187,0)
IFVCCI(DFN) ;
"RTN","MPIF001",188,0)
 ; this function returns 1 if your facility is the CMOR for the given pt
"RTN","MPIF001",189,0)
 ; DFN - ien of patient in Patient file
"RTN","MPIF001",190,0)
 ; returns: 1 = your site in the CMOR for this patient
"RTN","MPIF001",191,0)
 ;          -1 = your site is not the CMOR for this patient
"RTN","MPIF001",192,0)
 N VCCI,SITE
"RTN","MPIF001",193,0)
 S VCCI=$P($$GETVCCI(DFN),"^",1)
"RTN","MPIF001",194,0)
 S SITE=$P($$SITE^VASITE,"^",3)\1
"RTN","MPIF001",195,0)
 I $P(VCCI,"^",1)=-1 Q -1
"RTN","MPIF001",196,0)
 I VCCI'=SITE Q -1
"RTN","MPIF001",197,0)
 Q 1
"RTN","MPIF001",198,0)
 ;
"RTN","MPIF001",199,0)
HL7CMOR(DFN,SEP) ;
"RTN","MPIF001",200,0)
 ; This function returns the CMOR station number and institution name for
"RTN","MPIF001",201,0)
 ; the given patient.
"RTN","MPIF001",202,0)
 ; DFN = ien for patient in Patient file
"RTN","MPIF001",203,0)
 ; SEP = delimeter to separate station number and name
"RTN","MPIF001",204,0)
 ; returned:  Station Number <sep> Institution name
"RTN","MPIF001",205,0)
 ;            -1^error message
"RTN","MPIF001",206,0)
 N RETURN,NODE,PTR,STAT
"RTN","MPIF001",207,0)
 I $G(DFN)'>0 S RETURN="-1^NO DFN" G EXIT7
"RTN","MPIF001",208,0)
 I $G(SEP)="" S RETURN="-1^NO FIELD SEPERATOR" G EXIT7
"RTN","MPIF001",209,0)
 I '$D(^DPT(DFN,0)) S RETURN="-1^PATIENT NOT IN DATABASE" G EXIT7
"RTN","MPIF001",210,0)
 I $$MPINODE^MPIFAPI(DFN)<1 S RETURN="-1^NO MPI NODE" G EXIT7
"RTN","MPIF001",211,0)
 S NODE=$$MPINODE^MPIFAPI(DFN)
"RTN","MPIF001",212,0)
 S PTR=$P(NODE,"^",3)
"RTN","MPIF001",213,0)
 I PTR'>0 S RETURN="-1^NO CMOR DEFINED FOR PT" G EXIT7
"RTN","MPIF001",214,0)
 S STAT=$$NNT^XUAF4(PTR)
"RTN","MPIF001",215,0)
 I STAT="" S RETURN="-1^PTS CMOR IS DANGLING PTR" G EXIT7
"RTN","MPIF001",216,0)
 I $P(STAT,"^")="" S RETURN="-1^NO INSTITUTION NAME" G EXIT7
"RTN","MPIF001",217,0)
 S RETURN=$P(STAT,"^",2)_SEP_$P(STAT,"^")
"RTN","MPIF001",218,0)
EXIT7 ;
"RTN","MPIF001",219,0)
 Q RETURN
"RTN","MPIF001",220,0)
 ;
"RTN","MPIF001",221,0)
LOCK ;
"RTN","MPIF001",222,0)
 L +^DPT(DFN,"MPI"):10 I '$T G LOCK
"RTN","MPIF001",223,0)
 Q
"RTN","MPIF001",224,0)
 ;
"RTN","MPIF001",225,0)
UNLOCK ;
"RTN","MPIF001",226,0)
 L -^DPT(DFN,"MPI")
"RTN","MPIF001",227,0)
 Q
"RTN","MPIF109P")
0^^B841925
"RTN","MPIF109P",1,0)
MPIF109P ;BPCIO/CMC Post Init for MPIF*1.0*9 ;11/15/00
"RTN","MPIF109P",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**9**;30 Apr 99
"RTN","MPIF109P",3,0)
 ;
"RTN","MPIF109P",4,0)
 ;This Post Init will loop through the Patient file "B" x-ref
"RTN","MPIF109P",5,0)
 ; for patients whose last name starts with at least two Z's
"RTN","MPIF109P",6,0)
 ; to inactivate these patients from the MPI, including retiring
"RTN","MPIF109P",7,0)
 ; Local ICNs
"RTN","MPIF109P",8,0)
 ;
"RTN","MPIF109P",9,0)
POST ;
"RTN","MPIF109P",10,0)
 D BMES^XPDUTL("Inactivating ZZ'd Patients (Local ICN and National")
"RTN","MPIF109P",11,0)
 D BMES^XPDUTL("Please be patient this may take some time")
"RTN","MPIF109P",12,0)
 N NAME,DFN
"RTN","MPIF109P",13,0)
 Q:'$D(^DPT("AICN"))
"RTN","MPIF109P",14,0)
 ; ^ NO ICNs
"RTN","MPIF109P",15,0)
 S NAME="ZYZ"
"RTN","MPIF109P",16,0)
 F  S NAME=$O(^DPT("B",NAME)) Q:NAME=""  D
"RTN","MPIF109P",17,0)
 .Q:$E(NAME,1,2)'="ZZ"
"RTN","MPIF109P",18,0)
 .S DFN=$O(^DPT("B",NAME,""))
"RTN","MPIF109P",19,0)
 .Q:$O(^DPT("B",NAME,DFN,""))'=""
"RTN","MPIF109P",20,0)
 .D ZZKILL^MPIFDEL(DFN,NAME)
"RTN","MPIF109P",21,0)
 Q
"RTN","MPIFDEL")
0^1^B15234200
"RTN","MPIFDEL",1,0)
MPIFDEL ;SF/MJM,CMC-DELETE PATIENT FROM MPI ;JUL 14, 1998
"RTN","MPIFDEL",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,9**;30 Apr 99
"RTN","MPIFDEL",3,0)
 ;
"RTN","MPIFDEL",4,0)
 ;
"RTN","MPIFDEL",5,0)
INTER ;
"RTN","MPIFDEL",6,0)
 ;Entry point for Inactivate Patient from MPI option [MPIF PAT INACT]
"RTN","MPIFDEL",7,0)
 ;No input or output variables ^DPT
"RTN","MPIFDEL",8,0)
 N DIC,DA,DFN,HL,ERROR,CNT,HLRST,ICN,DATE,MPIFCMOR
"RTN","MPIFDEL",9,0)
 S ERROR=""
"RTN","MPIFDEL",10,0)
 S DIC=2,DIC(0)="QEAM" D ^DIC Q:+Y<0  S DFN=+Y
"RTN","MPIFDEL",11,0)
 S ICN=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFDEL",12,0)
 I ICN=""!(ICN=-1) W !,"** Patient Does NOT have an ICN **" Q
"RTN","MPIFDEL",13,0)
 S MPIFCMOR=+$$LKUP^XUAF4(+$$GETVCCI^MPIF001(DFN))
"RTN","MPIFDEL",14,0)
 I MPIFCMOR=0 W !,"*** Could NOT Inactivate Patient from MPI: CIRN Master of Record is Not Defined ***" Q
"RTN","MPIFDEL",15,0)
 I $$PAT^MPIFNQ(DFN)'=+$P($$SITE^VASITE,"^",3) W !,"*** Could NOT Inactivate Patient from MPI: CIRN Master of record site is '"_$$CMOR2^MPIF001(DFN)_"'. You MUST be the CMOR ***" Q
"RTN","MPIFDEL",16,0)
 S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFDEL",17,0)
 ;ask user if they are sure
"RTN","MPIFDEL",18,0)
 N DIR,Y S DIR(0)="Y",DIR("B")="No"
"RTN","MPIFDEL",19,0)
 S DIR("A")="Are you sure you want to Inactivate this Patient?"
"RTN","MPIFDEL",20,0)
 D ^DIR
"RTN","MPIFDEL",21,0)
 K DIR
"RTN","MPIFDEL",22,0)
 Q:$D(DTOUT)!($D(DUTOUT))!('Y)
"RTN","MPIFDEL",23,0)
 D HL7(DFN,.ERROR)
"RTN","MPIFDEL",24,0)
 I ERROR="" D DELETE(DFN) S ERROR=$$DELALLTF^VAFCTFU(+ICN),ERROR=""
"RTN","MPIFDEL",25,0)
 I ERROR=""!(ERROR=0) W !,"*** Inactivated on YOUR system, message sent to MPI to Inactivate ***"
"RTN","MPIFDEL",26,0)
 I ERROR'="" W !,"Error Occurred - "_ERROR
"RTN","MPIFDEL",27,0)
 Q
"RTN","MPIFDEL",28,0)
 ;
"RTN","MPIFDEL",29,0)
HL7(DFN,ERROR) ; create HL7 message
"RTN","MPIFDEL",30,0)
 ; check if no subscribers
"RTN","MPIFDEL",31,0)
 N SUB,HL,CNT,ICN,%,HLDATE
"RTN","MPIFDEL",32,0)
 K HLL
"RTN","MPIFDEL",33,0)
 Q:$E($$GETICN^MPIF001(DFN),1,3)=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFDEL",34,0)
 ; ^ don't generate HL7 message if local ICN
"RTN","MPIFDEL",35,0)
 S SUB=$P($G(^DPT(DFN,"MPI")),"^",5)
"RTN","MPIFDEL",36,0)
 I SUB'="" D GET^HLSUB(SUB,"","MPIF A29 SERVER",.HLL) I $D(HLL) S ERROR="Attempted to Inactivate an ICN and Patient is Shared.  Can't Inactivate patient DFN= "_DFN Q
"RTN","MPIFDEL",37,0)
 S ICN=+$$ICN^MPIFNQ(DFN)
"RTN","MPIFDEL",38,0)
 D NOW^%DTC S HLDATE=$$HLDATE^HLFNC(%,"DT")
"RTN","MPIFDEL",39,0)
 S HL=0,CNT=0
"RTN","MPIFDEL",40,0)
 D INIT^HLFNC2("MPIF A29 SERVER",.HL)
"RTN","MPIFDEL",41,0)
 I HL S ERROR="ERROR = "_HL_" During INIT^HLFNC2 for MPIF A29 Server for Patient DFN= "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",42,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A29"_HL("FS")_HLDATE_HL("FS")_HL("FS")_""_HL("FS")
"RTN","MPIFDEL",43,0)
 S CNT=CNT+1,HLA("HLS",CNT)=$$EN^VAFCPID(DFN,"2,3,5")
"RTN","MPIFDEL",44,0)
 ; message only goes to MPI Link
"RTN","MPIFDEL",45,0)
 D GENERATE^HLMA("MPIF A29 SERVER","LM",1,.HLRST,"",.HL)
"RTN","MPIFDEL",46,0)
 I 'HLRST S ERROR="Error During Generate for MPIF A29 Server Error= "_HLRST_" for dfn "_DFN D EXC(DFN,ERROR,220)
"RTN","MPIFDEL",47,0)
 Q
"RTN","MPIFDEL",48,0)
 ;
"RTN","MPIFDEL",49,0)
PAT1 ;entry point for tasked job from .01 in Patient file for ZZ patients
"RTN","MPIFDEL",50,0)
 N ERR
"RTN","MPIFDEL",51,0)
 S ERR=""
"RTN","MPIFDEL",52,0)
 D PAT(DA,.ERR)
"RTN","MPIFDEL",53,0)
 Q
"RTN","MPIFDEL",54,0)
 ;
"RTN","MPIFDEL",55,0)
PAT(DFN,ERROR) ;Programmer API to Delete MPI entry and remove ICN data from DPT
"RTN","MPIFDEL",56,0)
 S ERROR=""
"RTN","MPIFDEL",57,0)
 I $G(DFN)="" S ERROR="DFN not defined" Q
"RTN","MPIFDEL",58,0)
 I +$$PAT^MPIFNQ(DFN)'=+$$SITE^VASITE S ERROR="Attempt to Inactivate Patient, DFN= "_DFN_" this site is not the CMOR for this patient" D EXC(DFN,ERROR,226) Q
"RTN","MPIFDEL",59,0)
 D HL7(DFN,.ERROR)
"RTN","MPIFDEL",60,0)
 I ERROR="" S ERROR=$$DELALLTF^VAFCTFU(+$$GETICN^MPIF001(DFN)),ERROR="" D DELETE(DFN)
"RTN","MPIFDEL",61,0)
 Q
"RTN","MPIFDEL",62,0)
DELETE(DFN) ;
"RTN","MPIFDEL",63,0)
 N DA,DIE,X,Y,DR
"RTN","MPIFDEL",64,0)
 Q:DFN=""
"RTN","MPIFDEL",65,0)
 S DA=DFN,DIE="^DPT(",DR="991.01///@;991.02///@;991.03///@;991.04///@"
"RTN","MPIFDEL",66,0)
 D ^DIE
"RTN","MPIFDEL",67,0)
 Q
"RTN","MPIFDEL",68,0)
 ;
"RTN","MPIFDEL",69,0)
EXC(DFN,ERROR,TYPE) ; subscribers, log exception
"RTN","MPIFDEL",70,0)
 D START^RGHLLOG(0)
"RTN","MPIFDEL",71,0)
 D EXC^RGHLLOG(TYPE,ERROR)
"RTN","MPIFDEL",72,0)
 D STOP^RGHLLOG(0)
"RTN","MPIFDEL",73,0)
 Q
"RTN","MPIFDEL",74,0)
 ;
"RTN","MPIFDEL",75,0)
ZZSET(DA,NAME) ;this entry point checks to see if .01 of Patient file entry
"RTN","MPIFDEL",76,0)
 ;starts with at least two Zs
"RTN","MPIFDEL",77,0)
 ;if it does and an ICN is present, it will be inactivated
"RTN","MPIFDEL",78,0)
 ;
"RTN","MPIFDEL",79,0)
 Q:$E(NAME,1,2)'="ZZ"
"RTN","MPIFDEL",80,0)
 ;task inactivation off
"RTN","MPIFDEL",81,0)
 I +$$GETICN^MPIF001(DA)>0 D
"RTN","MPIFDEL",82,0)
 .S ZTRTN="PAT1^MPIFDEL",ZTDESC="Inactivate ICN for 'ZZ'd patient"
"RTN","MPIFDEL",83,0)
 .S ZTIO="",ZTSAVE("DA")=DA,ZTSAVE("NAME")=NAME
"RTN","MPIFDEL",84,0)
 .S ZTDTH=$$FMADD^XLFDT($$NOW^XLFDT,0,0,1,0)
"RTN","MPIFDEL",85,0)
 .D ^%ZTLOAD
"RTN","MPIFDEL",86,0)
 .K ZTRTN,ZTDESC,ZTIO,ZTSAVE,ZTDTH
"RTN","MPIFDEL",87,0)
 Q
"RTN","MPIFDEL",88,0)
ZZKILL(DA,NAME) ;This entry point checks if there is an ICN present, if so
"RTN","MPIFDEL",89,0)
 ;if will be inactivated, following the inactivate rules
"RTN","MPIFDEL",90,0)
 N ERR S ERR=""
"RTN","MPIFDEL",91,0)
 I +$$GETICN^MPIF001(DA)>0 D PAT(DA,.ERR)
"RTN","MPIFDEL",92,0)
 Q
"RTN","MPIFMER")
0^3^B12487290
"RTN","MPIFMER",1,0)
MPIFMER ;SF/MJM,CMC-Merge patient ICN ;JUL 14, 1998
"RTN","MPIFMER",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**9**;30 Apr 99
"RTN","MPIFMER",3,0)
 ;
"RTN","MPIFMER",4,0)
 ;Notify MPI and other TF of change to patient's ICN
"RTN","MPIFMER",5,0)
 ;
"RTN","MPIFMER",6,0)
MER(PDFN,OLD,ERROR,FLG) ;
"RTN","MPIFMER",7,0)
 Q:$D(MPIFMER)
"RTN","MPIFMER",8,0)
 Q:$E(OLD,1,3)=$E($P($$SITE^VASITE,"^",3),1,3)
"RTN","MPIFMER",9,0)
 ; ^ LOCAL ICN being resolved don't send to CIRN sites OR MPI
"RTN","MPIFMER",10,0)
 ; but others may want to know Local Resolved, 
"RTN","MPIFMER",11,0)
 ;If other want to know resolved look at x-ref on 991.01 field in file 2
"RTN","MPIFMER",12,0)
 I '$G(PDFN) S ERROR="DFN VARIABLE UNDEFINED" Q
"RTN","MPIFMER",13,0)
 Q:OLD=""
"RTN","MPIFMER",14,0)
 I '$D(FLG) S FLG=""
"RTN","MPIFMER",15,0)
 I '$D(ERROR) S ERROR=""
"RTN","MPIFMER",16,0)
 S ZTRTN="MER2^MPIFMER",ZTDESC="MERGE ICN JOB",ZTIO=""
"RTN","MPIFMER",17,0)
 D NOW^%DTC S ZTDTH=% K %,X
"RTN","MPIFMER",18,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFMER",19,0)
 S ZTSAVE("PDFN")=PDFN,ZTSAVE("OLD")=OLD,ZTSAVE("ERROR")=ERROR,ZTSAVE("FLG")=FLG
"RTN","MPIFMER",20,0)
 D ^%ZTLOAD
"RTN","MPIFMER",21,0)
 K ZTDESC,ZTDTH,ZTIO,ZTRTN,ZTSAVE
"RTN","MPIFMER",22,0)
 Q
"RTN","MPIFMER",23,0)
MER2 ;
"RTN","MPIFMER",24,0)
 N RGLOG,CNT,HLA,HL,RGLINK,HOME,SUB,ICN,TMP,PARENT,RGL,CLIENT,I,TD,X,CMOR,HERE,%
"RTN","MPIFMER",25,0)
 Q:$E(OLD,1,3)=$E($P($$SITE^VASITE,"^",3),1,3)
"RTN","MPIFMER",26,0)
 ; ^ LOCAL ICN being resolved don't send to CIRN sites or MPI
"RTN","MPIFMER",27,0)
 ; though others may want to know Local has been resolved.
"RTN","MPIFMER",28,0)
 ;If other want to know resolved look at x-ref on 991.01 field in file 2
"RTN","MPIFMER",29,0)
 Q:'$G(PDFN)
"RTN","MPIFMER",30,0)
 Q:+$$GETICN^MPIF001(PDFN)<0
"RTN","MPIFMER",31,0)
 ; ^ If no ICN currently don't send mesg
"RTN","MPIFMER",32,0)
 S CNT=0,HL=0,ERROR="",CLIENT="MPIF A30 SERVER"
"RTN","MPIFMER",33,0)
 D NOW^%DTC S TD=$$HLDATE^HLFNC(%,"DT")
"RTN","MPIFMER",34,0)
 S CMOR=+$$PAT^MPIFNQ(PDFN),HERE=+$$SITE^VASITE()
"RTN","MPIFMER",35,0)
 I CMOR'=HERE,FLG="" S ERROR="PATIENT'S CMOR MUST BE THIS FACILITY" D EXC^MPIFDEL(PDFN,ERROR,226) Q
"RTN","MPIFMER",36,0)
 D INIT^HLFNC2(CLIENT,.HL)
"RTN","MPIFMER",37,0)
 I HL S ERROR=HL D EXC^MPIFDEL(PDFN,ERROR,220) Q
"RTN","MPIFMER",38,0)
 S CNT=CNT+1,HLA("HLS",CNT)="EVN"_HL("FS")_"A30"_HL("FS")_TD_HL("FS")_HL("FS")_HL("FS")
"RTN","MPIFMER",39,0)
 S CNT=CNT+1,HLA("HLS",CNT)=$$EN^VAFCPID(PDFN,"1,2,3,4,5,6,7,8,10,13,14,17,19,11")
"RTN","MPIFMER",40,0)
 S CNT=CNT+1,HLA("HLS",CNT)="MRG"_HL("FS")_OLD
"RTN","MPIFMER",41,0)
 D GENERATE^HLMA(CLIENT,"LM",1,.HLRST,"",.HL)
"RTN","MPIFMER",42,0)
 I 'HLRST S ERROR=HLRST D EXC^MPIFDEL(PDFN,ERROR,220)
"RTN","MPIFMER",43,0)
 Q
"RTN","MPIFMER",44,0)
LINKS ; gets links to send messages to, including mpi
"RTN","MPIFMER",45,0)
 ; Currently only the MPI will get Change ICN msgs.
"RTN","MPIFMER",46,0)
 N SUB,MPI
"RTN","MPIFMER",47,0)
 Q:$P($$GETICN^MPIF001(PDFN),1,3)=$P($$SITE^VASITE(),3)
"RTN","MPIFMER",48,0)
 S SUB=$P($G(^DPT(PDFN,"MPI")),"^",5)
"RTN","MPIFMER",49,0)
 I SUB'="" D GET^HLSUB(SUB,0,"MPIF A30",.HLL)
"RTN","MPIFMER",50,0)
 S MPI=$$MPILINK^MPIFAPI() D
"RTN","MPIFMER",51,0)
 .I $P($G(MPI),U)'=-1 S HLL("LINKS",999)="MPIF A30"_"^"_MPI
"RTN","MPIFMER",52,0)
 .I $P($G(MPI),U)=-1 N RGLOG D START^RGHLLOG(HLMTIEN,"","") D EXC^RGHLLOG(224,"No MPI link defined in CIRN Site Parameter file") D STOP^RGHLLOG(0)
"RTN","MPIFMER",53,0)
 Q
"RTN","MPIFMER",54,0)
 ;
"RTN","MPIFMER",55,0)
IN ;process inbound Merge ICN Message - currently not used.
"RTN","MPIFMER",56,0)
 N I,CNT,NODE,SENDER,NEWICN,OLDICN,PDFN,CMOR,ERR,DA,DIE,DR,SEP,CHK
"RTN","MPIFMER",57,0)
 K ^XTMP($J,"MPIFMER")
"RTN","MPIFMER",58,0)
 ; get message
"RTN","MPIFMER",59,0)
 F I=1:1 X HLNEXT Q:HLQUIT'>0  S ^XTMP($J,"MPIFMER","IN",I)=HLNODE
"RTN","MPIFMER",60,0)
 ; ^XTMP($J,"MPIFMER","IN",I look for data
"RTN","MPIFMER",61,0)
 S CNT=0
"RTN","MPIFMER",62,0)
 F  S CNT=$O(^XTMP($J,"MPIFMER","IN",CNT)) Q:CNT=""  D
"RTN","MPIFMER",63,0)
 .S NODE=$G(^XTMP($J,"MPIFMER","IN",CNT))
"RTN","MPIFMER",64,0)
 .I $E(NODE,1,3)="MSH" S SEP=$E(NODE,4),SENDER=$P(NODE,SEP,4) Q:'$D(SEP)
"RTN","MPIFMER",65,0)
 .I $P(NODE,SEP)="EVN" Q:$P(NODE,SEP,2)'="A30"
"RTN","MPIFMER",66,0)
 .I $P(NODE,SEP)="PID" S NEWICN=+$P(NODE,SEP,3),CHK=$P($P(NODE,SEP,3),"V",2) Q:NEWICN=""
"RTN","MPIFMER",67,0)
 .I $P(NODE,SEP)="MRG" S OLDICN=+$P(NODE,SEP,2) Q:OLDICN=""
"RTN","MPIFMER",68,0)
 ;
"RTN","MPIFMER",69,0)
 Q:'$D(OLDICN)
"RTN","MPIFMER",70,0)
 Q:'$D(^DPT("AICN",OLDICN))
"RTN","MPIFMER",71,0)
 ; ^ old icn not at site
"RTN","MPIFMER",72,0)
 S PDFN=""
"RTN","MPIFMER",73,0)
 F  S PDFN=$O(^DPT("AICN",OLDICN,PDFN)) Q:PDFN=""  D
"RTN","MPIFMER",74,0)
 .; incase have multiple OLD-ICNs
"RTN","MPIFMER",75,0)
 .S CMOR=$$PAT^MPIFNQ(PDFN)
"RTN","MPIFMER",76,0)
 .I CMOR'=SENDER S ERR="MERGE ICN MESSAGE DID NOT COME FROM CMOR for Patient dfn="_PDFN D EXC^MPIFDEL(PDFN,ERR,226) Q
"RTN","MPIFMER",77,0)
 .K DA,DIE,DR
"RTN","MPIFMER",78,0)
 .S DA=PDFN,DIE="^DPT(",DR="991.01////"_NEWICN_";991.02////"_CHK,MPIFMER=""
"RTN","MPIFMER",79,0)
 .D ^DIE K MPIFMER
"RTN","MPIFMER",80,0)
 Q
"RTN","MPIFVTQ")
0^4^B41794552
"RTN","MPIFVTQ",1,0)
MPIFVTQ ;SLC/ARS-BUILD DATA TO QUERY MPI RESPONSE PROCESS (ADDPAT) ;JUL 16, 1997
"RTN","MPIFVTQ",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,9**;30 Apr 99
"RTN","MPIFVTQ",3,0)
 ;
"RTN","MPIFVTQ",4,0)
 Q  ;NOT an entry point
"RTN","MPIFVTQ",5,0)
HLRDF D INIT^HLFNC2("MPIF-STARTUP",.MPIHL)
"RTN","MPIFVTQ",6,0)
 S SITE=$$KSP^XUPARAM("INST")
"RTN","MPIFVTQ",7,0)
 Q
"RTN","MPIFVTQ",8,0)
VTQ2(MPIIT,MPIOUT,MPIHL,MPIQRYNM,MPISND) ;
"RTN","MPIFVTQ",9,0)
 ;MPIIT=DFN in patient file.
"RTN","MPIFVTQ",10,0)
 ;MPIOUT=Array you want the VTQ/RDF put into.
"RTN","MPIFVTQ",11,0)
 ;MPIHL=Array of encoding characters and Field separator.
"RTN","MPIFVTQ",12,0)
 ;MPIQRYNM=Name of query to put into message.
"RTN","MPIFVTQ",13,0)
 ;MPISND (OPTIONAL) = item #'s separated by ; to be used to query.
"RTN","MPIFVTQ",14,0)
 ;  default is DOB;SSN;LAST NAME;FIRST NAME;SUFFIX OF NAME;SEX;DOD;
"RTN","MPIFVTQ",15,0)
 ;  POB-CITY;POB-STATE
"RTN","MPIFVTQ",16,0)
 ;
"RTN","MPIFVTQ",17,0)
 ;If invalid DFN, Patient Merged, if ICN (NOT LOCAL) already assigned, Test SSN, the VTQ query is not built and -1^'error message' returned in MPIOUT(0).
"RTN","MPIFVTQ",18,0)
 ;
"RTN","MPIFVTQ",19,0)
 ;If patient has a date of death, the VTQ query is built with MPIOUT(0) returned with 0^Patient has date of death.  Programmer to decide if VTQ should be sent.
"RTN","MPIFVTQ",20,0)
 ;
"RTN","MPIFVTQ",21,0)
 ; allows VTQ to be created for Local ICN patients.
"RTN","MPIFVTQ",22,0)
 ;
"RTN","MPIFVTQ",23,0)
 N MPITEST,MPISSN,MPIDTH
"RTN","MPIFVTQ",24,0)
 S MPIOUT(0)=""
"RTN","MPIFVTQ",25,0)
 I '$D(MPISND) S MPISND="00122;00108.1;00108.2;00110;00740;00111;00180.4;00126.1;00126.2"
"RTN","MPIFVTQ",26,0)
 ;validation check
"RTN","MPIFVTQ",27,0)
 I '$D(MPIHL) S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",28,0)
 I $G(MPIHL("FS"))=""!($G(MPIHL("ECH"))="") S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",29,0)
 I MPIIT="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",30,0)
 I $G(^DPT(MPIIT,-9))'="" S MPIOUT(0)="-1^Patient merged "_^DPT(MPIIT,-9) Q
"RTN","MPIFVTQ",31,0)
 I $P($G(^DPT(MPIIT,0)),"^")["MERGING" S MPIOUT(0)="-1^Patient being merged DFN= "_MPIIT Q
"RTN","MPIFVTQ",32,0)
 S MPIMPI=$G(^DPT(MPIIT,"MPI"))
"RTN","MPIFVTQ",33,0)
 S:MPIMPI'="" MPIZICN=$P(^DPT(MPIIT,"MPI"),"^",1),MPIZLOC=$P(^DPT(MPIIT,"MPI"),"^",4)
"RTN","MPIFVTQ",34,0)
 I $G(MPIZICN)'="",$G(MPIZLOC)'=1 S MPIOUT(0)="-1^ICN already assigned "_MPIZICN Q
"RTN","MPIFVTQ",35,0)
 S MPITEST=$G(^DPT(MPIIT,0))
"RTN","MPIFVTQ",36,0)
 I MPITEST="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",37,0)
 S MPISSN=$P(MPITEST,"^",9)
"RTN","MPIFVTQ",38,0)
 I $E(MPISSN,1,5)="00000" S MPIOUT(0)="-1^5 zero SSN" Q
"RTN","MPIFVTQ",39,0)
 S MPIDTH=""
"RTN","MPIFVTQ",40,0)
 S:$G(^DPT(MPIIT,.35))'="" MPIDTH=$P(^DPT(MPIIT,.35),"^",1)
"RTN","MPIFVTQ",41,0)
 I $G(MPIDTH)'="" S MPIOUT(0)="0^Patient has Date of Death "_MPIDTH
"RTN","MPIFVTQ",42,0)
 D VTQC(MPISSN,MPIDTH,MPISND,.MPIHL,MPIQRYNM,.MPIOUT,MPIIT)
"RTN","MPIFVTQ",43,0)
 Q
"RTN","MPIFVTQ",44,0)
 ;
"RTN","MPIFVTQ",45,0)
VTQ1(MPIIT,MPIOUT,MPIHL,MPIQRYNM,MPISND) ;
"RTN","MPIFVTQ",46,0)
 ;MPIIT=DFN in patient file.
"RTN","MPIFVTQ",47,0)
 ;MPIOUT=Array you want the VTQ/RDF put into.
"RTN","MPIFVTQ",48,0)
 ;MPIHL=Array of encoding characters and Field separator.
"RTN","MPIFVTQ",49,0)
 ;MPIQRYNM=Name of query to put into message.
"RTN","MPIFVTQ",50,0)
 ;MPISND (OPTIONAL) = item #'s separated by ; to be used to query.
"RTN","MPIFVTQ",51,0)
 ;  default is DOB;SSN;LAST NAME;FIRST NAME;SUFFIX OF NAME;SEX;DOD;
"RTN","MPIFVTQ",52,0)
 ;  POB-CITY;POB-STATE
"RTN","MPIFVTQ",53,0)
 ;
"RTN","MPIFVTQ",54,0)
 ;If invalid DFN, Patient Merged, if ICN already assigned, Test SSN, the VTQ query is not built and -1^'error message' returned in MPIOUT(0).
"RTN","MPIFVTQ",55,0)
 ;
"RTN","MPIFVTQ",56,0)
 ;If patient has a date of death, the VTQ query is built with MPIOUT(0) returned with 0^Patient has date of death.  Programmer to decide if VTQ should be sent.
"RTN","MPIFVTQ",57,0)
 ;
"RTN","MPIFVTQ",58,0)
 N MPITEST,MPISSN,MPIDTH
"RTN","MPIFVTQ",59,0)
 S MPIOUT(0)=""
"RTN","MPIFVTQ",60,0)
 I '$D(MPISND) S MPISND="00122;00108.1;00108.2;00110;00740;00111;00180.4;00126.1;00126.2"
"RTN","MPIFVTQ",61,0)
 ;validation check
"RTN","MPIFVTQ",62,0)
 I '$D(MPIHL) S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",63,0)
 I $G(MPIHL("FS"))=""!($G(MPIHL("ECH"))="") S MPIOUT(0)="-1^no encoding characters" Q
"RTN","MPIFVTQ",64,0)
 I MPIIT="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",65,0)
 I $G(^DPT(MPIIT,-9))'="" S MPIOUT(0)="-1^Patient merged "_^DPT(MPIIT,-9) Q
"RTN","MPIFVTQ",66,0)
 I $P($G(^DPT(MPIIT,0)),"^")["MERGING" S MPIOUT(0)="-1^Patient being merged DFN= "_MPIIT Q
"RTN","MPIFVTQ",67,0)
 S MPIMPI=$G(^DPT(MPIIT,"MPI"))
"RTN","MPIFVTQ",68,0)
 S:MPIMPI'="" MPIZICN=$P(^DPT(MPIIT,"MPI"),"^",1)
"RTN","MPIFVTQ",69,0)
 I '$D(MPIFRES),$G(MPIZICN)'="" S MPIOUT(0)="-1^ICN already assigned "_MPIZICN Q
"RTN","MPIFVTQ",70,0)
 S MPITEST=$G(^DPT(MPIIT,0))
"RTN","MPIFVTQ",71,0)
 I MPITEST="" S MPIOUT(0)="-1^invalid DFN" Q
"RTN","MPIFVTQ",72,0)
 S MPISSN=$P(MPITEST,"^",9)
"RTN","MPIFVTQ",73,0)
 I $E(MPISSN,1,5)="00000" S MPIOUT(0)="-1^5 zero SSN" Q
"RTN","MPIFVTQ",74,0)
 I $E($P(MPITEST,"^"),1,2)="ZZ" S MPIOUT(0)="-1^ZZ'd Patient" Q
"RTN","MPIFVTQ",75,0)
 S MPIDTH=""
"RTN","MPIFVTQ",76,0)
 S:$G(^DPT(MPIIT,.35))'="" MPIDTH=$P(^DPT(MPIIT,.35),"^",1)
"RTN","MPIFVTQ",77,0)
 I $G(MPIDTH)'="" S MPIOUT(0)="0^Patient has Date of Death "_MPIDTH
"RTN","MPIFVTQ",78,0)
 D VTQC(MPISSN,MPIDTH,MPISND,.MPIHL,MPIQRYNM,.MPIOUT,MPIIT)
"RTN","MPIFVTQ",79,0)
 Q
"RTN","MPIFVTQ",80,0)
 ;
"RTN","MPIFVTQ",81,0)
VTQC(MPISSN,MPIDTH,MPISND,MPIHL,MPIQRYNM,MPIOUT,MPIIT) ;
"RTN","MPIFVTQ",82,0)
 N MPIPOB,MPIPOBS,MPINM,MPI2MN,MPI1NM,QUERY,MPIDOB,RDF,MPIMOD
"RTN","MPIFVTQ",83,0)
 N MPIHDTH,MPIZDOB,MPIXDOB,MPIMPI,MPIZICN,QUEDOB,MPI2NM,MPICS,MPIESC,MPIHDOB,MPIMNM
"RTN","MPIFVTQ",84,0)
 N MPINMSFX,MPIRS,MPISCS,MPISEX,MPIZLOC
"RTN","MPIFVTQ",85,0)
 I $G(MPIQRYNM)="" S MPIQRYNM="VTQ_PID_ICN_LOAD_1"
"RTN","MPIFVTQ",86,0)
 S MPICS=$E(MPIHL("ECH"),1)
"RTN","MPIFVTQ",87,0)
 S MPIRS=$E(MPIHL("ECH"),2)
"RTN","MPIFVTQ",88,0)
 S MPISCS=$E(MPIHL("ECH"),4)
"RTN","MPIFVTQ",89,0)
 S MPIESC=$E(MPIHL("ECH"),3)
"RTN","MPIFVTQ",90,0)
 ;
"RTN","MPIFVTQ",91,0)
 S RDF="RDF"_MPIHL("FS")_"10"_MPIHL("FS")_"@00108.1"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00122"_MPICS_"ST"_MPICS_"9"_MPIRS_"@00110"_MPICS_"TS"_MPICS_8_MPIRS_"@00756"_MPICS_"ST"_MPICS_30_MPIRS_"@00105"_MPICS_"ST"_MPICS_19
"RTN","MPIFVTQ",92,0)
 S RDF=RDF_MPIRS_"@00108.2"_MPICS_"ST"_MPICS_"16"_MPIRS_"@00169"_MPICS_"ST"_MPICS_30_MPIRS_"@00740"_MPICS_"TS"_MPICS_8_MPIRS_"@00108.3"_MPICS_"ST"_MPICS_16_MPIRS_"@00108.4"_MPICS_"ST"_MPICS_20
"RTN","MPIFVTQ",93,0)
 ; ^ fields to be returned in query response
"RTN","MPIFVTQ",94,0)
 ;
"RTN","MPIFVTQ",95,0)
 S QUERY="VTQ"_MPIHL("FS")_MPIIT_MPIHL("FS")_"T"_MPIHL("FS")_MPIQRYNM_MPIHL("FS")_"ICN"_MPIHL("FS")
"RTN","MPIFVTQ",96,0)
 ;
"RTN","MPIFVTQ",97,0)
 I MPISND["00108" S MPINM=$P(MPITEST,"^",1),VAFHA08=1,VAFHCA08=1 D NAME^VAFCPID2(MPIIT,.MPINM) K VAFHA08,VAFHCA08 ;agressive name reformatting
"RTN","MPIFVTQ",98,0)
 ; ^ sending all or part of name
"RTN","MPIFVTQ",99,0)
 I MPISND["00108.1" S MPI2NM=$P(MPINM,",",1) I MPI2NM'="" S QUERY=QUERY_"@00108.1"_MPICS_"EQ"_MPICS_MPI2NM
"RTN","MPIFVTQ",100,0)
 ; ^ sending last name
"RTN","MPIFVTQ",101,0)
 I MPISND["00122"&(MPISSN'="")&(MPISSN'["P") S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00122"_MPICS_"EQ"_MPICS_MPISSN
"RTN","MPIFVTQ",102,0)
 ; ^ sending SSN
"RTN","MPIFVTQ",103,0)
 I MPISND["00108.2" S MPI1NM=$P(MPINM,",",2),MPI1NM=$P(MPI1NM," ",1) I MPI1NM'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.2"_MPICS_"EQ"_MPICS_MPI1NM
"RTN","MPIFVTQ",104,0)
 ; ^ sending first name
"RTN","MPIFVTQ",105,0)
 I MPISND["00110" D
"RTN","MPIFVTQ",106,0)
 .S MPIDOB=$P(MPITEST,"^",3)
"RTN","MPIFVTQ",107,0)
 .Q:MPIDOB=""
"RTN","MPIFVTQ",108,0)
 .S MPIHDOB=$$HLDATE^HLFNC(MPIDOB)
"RTN","MPIFVTQ",109,0)
 .; send date of birth (convert to hl7 date format)
"RTN","MPIFVTQ",110,0)
 .S MPIMOD=MPIDOB#100
"RTN","MPIFVTQ",111,0)
 .I MPIQRYNM'="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"GN"_MPICS_MPIHDOB
"RTN","MPIFVTQ",112,0)
 .I MPIQRYNM="VTQ_PID_ICN_LOAD_1" S MPIZDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",113,0)
 .S MPIXDOB=MPICS_"AND"_MPIRS_"@00110"_MPICS_"EQ"_MPICS_MPIHDOB
"RTN","MPIFVTQ",114,0)
 .S QUEDOB=$S(MPIMOD>0:MPIXDOB,1:MPIZDOB)
"RTN","MPIFVTQ",115,0)
 .S QUERY=QUERY_QUEDOB
"RTN","MPIFVTQ",116,0)
 ; ^ sending date of birth
"RTN","MPIFVTQ",117,0)
 I $D(MPIDTH),(MPISND["00740")&(MPIDTH'="") S MPIHDTH=$$HLDATE^HLFNC(MPIDTH),QUERY=QUERY_MPICS_"AND"_MPIRS_"@00740"_MPICS_"EQ"_MPICS_MPIHDTH
"RTN","MPIFVTQ",118,0)
 ; ^ sending date of death
"RTN","MPIFVTQ",119,0)
 I MPISND["00111" S:$G(^DPT(MPIIT,0))'="" MPISEX=$P(^DPT(MPIIT,0),"^",2) I MPISEX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00111"_MPICS_"EQ"_MPICS_MPISEX
"RTN","MPIFVTQ",120,0)
 ; ^ sending Sex
"RTN","MPIFVTQ",121,0)
 I MPISND["00108.4" S MPIMNM=$P(MPI1NM," ",2),MPINMSFX=$P(MPI1NM," ",3) I MPINMSFX'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00108.4"_MPICS_"EQ"_MPICS_MPINMSFX
"RTN","MPIFVTQ",122,0)
 ; ^ sending suffix name
"RTN","MPIFVTQ",123,0)
 I MPISND["00126.1" S MPIPOB=$P(^DPT(MPIIT,0),"^",11) I MPIPOB'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.1"_MPICS_"EQ"_MPICS_MPIPOB
"RTN","MPIFVTQ",124,0)
 ; send place of birth - city
"RTN","MPIFVTQ",125,0)
 I MPISND["00126.2" S MPIPOBS=$P(^DPT(MPIIT,0),"^",12) I MPIPOBS'="" S QUERY=QUERY_MPICS_"AND"_MPIRS_"@00126.2"_MPICS_"EQ"_MPICS_MPIPOBS
"RTN","MPIFVTQ",126,0)
 ; send place of birth - state
"RTN","MPIFVTQ",127,0)
 ;
"RTN","MPIFVTQ",128,0)
 I $G(MPIOUT(0))="" S MPIOUT(0)="1^good data"
"RTN","MPIFVTQ",129,0)
 S MPIOUT(2)=QUERY
"RTN","MPIFVTQ",130,0)
 S MPIOUT(3)=RDF
"RTN","MPIFVTQ",131,0)
 ;W !,QUERY
"RTN","MPIFVTQ",132,0)
 Q
"VER")
8.0^22.0
**END**
**END**
