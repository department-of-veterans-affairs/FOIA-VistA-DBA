Released DG*5.3*578 SEQ #505
Extracted from mail message
**KIDS**:DG*5.3*578^

**INSTALL NAME**
DG*5.3*578
"BLD",5358,0)
DG*5.3*578^REGISTRATION^0^3040302^y
"BLD",5358,4,0)
^9.64PA^^
"BLD",5358,"KRN",0)
^9.67PA^8989.52^19
"BLD",5358,"KRN",.4,0)
.4
"BLD",5358,"KRN",.401,0)
.401
"BLD",5358,"KRN",.402,0)
.402
"BLD",5358,"KRN",.403,0)
.403
"BLD",5358,"KRN",.5,0)
.5
"BLD",5358,"KRN",.84,0)
.84
"BLD",5358,"KRN",3.6,0)
3.6
"BLD",5358,"KRN",3.8,0)
3.8
"BLD",5358,"KRN",9.2,0)
9.2
"BLD",5358,"KRN",9.8,0)
9.8
"BLD",5358,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5358,"KRN",9.8,"NM",1,0)
DPTLK2^^0^B26882224
"BLD",5358,"KRN",9.8,"NM",2,0)
VAFCMSG^^0^B18003001
"BLD",5358,"KRN",9.8,"NM","B","DPTLK2",1)

"BLD",5358,"KRN",9.8,"NM","B","VAFCMSG",2)

"BLD",5358,"KRN",19,0)
19
"BLD",5358,"KRN",19.1,0)
19.1
"BLD",5358,"KRN",101,0)
101
"BLD",5358,"KRN",409.61,0)
409.61
"BLD",5358,"KRN",771,0)
771
"BLD",5358,"KRN",870,0)
870
"BLD",5358,"KRN",8989.51,0)
8989.51
"BLD",5358,"KRN",8989.52,0)
8989.52
"BLD",5358,"KRN",8994,0)
8994
"BLD",5358,"KRN","B",.4,.4)

"BLD",5358,"KRN","B",.401,.401)

"BLD",5358,"KRN","B",.402,.402)

"BLD",5358,"KRN","B",.403,.403)

"BLD",5358,"KRN","B",.5,.5)

"BLD",5358,"KRN","B",.84,.84)

"BLD",5358,"KRN","B",3.6,3.6)

"BLD",5358,"KRN","B",3.8,3.8)

"BLD",5358,"KRN","B",9.2,9.2)

"BLD",5358,"KRN","B",9.8,9.8)

"BLD",5358,"KRN","B",19,19)

"BLD",5358,"KRN","B",19.1,19.1)

"BLD",5358,"KRN","B",101,101)

"BLD",5358,"KRN","B",409.61,409.61)

"BLD",5358,"KRN","B",771,771)

"BLD",5358,"KRN","B",870,870)

"BLD",5358,"KRN","B",8989.51,8989.51)

"BLD",5358,"KRN","B",8989.52,8989.52)

"BLD",5358,"KRN","B",8994,8994)

"BLD",5358,"QUES",0)
^9.62^^
"BLD",5358,"REQB",0)
^9.611^2^2
"BLD",5358,"REQB",1,0)
DG*5.3*530^1
"BLD",5358,"REQB",2,0)
DG*5.3*532^1
"BLD",5358,"REQB","B","DG*5.3*530",1)

"BLD",5358,"REQB","B","DG*5.3*532",2)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
578^3040302^100850
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","DPTLK2")
0^1^B26882224
"RTN","DPTLK2",1,0)
DPTLK2 ;ALB/RMO - MAS Patient Look-up Add New Patient ; 3/2/04 2:40pm
"RTN","DPTLK2",2,0)
 ;;5.3;Registration;**32,197,214,244,532,578**;Aug 13, 1993
"RTN","DPTLK2",3,0)
 N DPTCT,DGVV,DPTLIDR
"RTN","DPTLK2",4,0)
 I $D(DDS) D CLRMSG^DDS S DX=0,DY=DDSHBX+1 X DDXY
"RTN","DPTLK2",5,0)
 I '$D(DUZ(0)) W:DIC(0)["Q" !?3,*7,"Unable to Add Patient. Your Fileman Access Code is undefined." S DPTDFN=-1 G Q
"RTN","DPTLK2",6,0)
 I $S($D(DLAYGO):2\1-(DLAYGO\1),1:1),DUZ(0)'="@",$D(^DIC(2,0,"LAYGO")) F I=1:1 I DUZ(0)[$E(^("LAYGO"),I) Q:I'>$L(^("LAYGO"))  S DPTDFN=-1 W:DIC(0)["Q" *7," ??" G Q
"RTN","DPTLK2",7,0)
 N DG20NAME S DG20NAME=DPTX,DPTX=$$FORMAT^DPTNAME(.DG20NAME,3,30,,1)
"RTN","DPTLK2",8,0)
 S DPTX=$S($E(DPTX)[""""&($E(DPTX,$L(DPTX))[""""):$P(DPTX,"""",2),$E(DPTX)["""":$P(DPTX,"""",2),$E(DPTX,$L(DPTX))["""":$P(DPTX,"""",1),1:DPTX)
"RTN","DPTLK2",9,0)
 I $L(DPTX)<3!($L(DPTX)>30)!(DPTX?1P.E)!(DPTX'[",")!(DPTX'?1U.ANP) W:DIC(0)["Q" *7," ??" S DPTDFN=-1 G Q
"RTN","DPTLK2",10,0)
 K DPTLID I DIC(0)["E" D ASKADD D  G Q:DPTDFN<0 I '$D(DIC("DR")) D CHKID G Q:DPTDFN<0 D ^DPTLK3 G Q:DPTDFN<0 W !!?3,"...adding new patient",!?3
"RTN","DPTLK2",11,0)
 .S:DPTDFN<1&('$D(DTOUT)) DUOUT=1
"RTN","DPTLK2",12,0)
 S X=DPTX,DPT("NO^")=$G(DIE("NO^")) K DD,DO,DPTX N DPTZNV
"RTN","DPTLK2",13,0)
 S:$D(DPT("DR")) DIC("DR")="S DIE(""NO^"")=""BACK"";.01///^S (X,DPTZNV)=$$NCEDIT^DPTNAME(DA,1,.DG20NAME);"_DPT("DR")
"RTN","DPTLK2",14,0)
 D FILE^DICN K:$D(DPT("DR")) DIC("DR")
"RTN","DPTLK2",15,0)
 W !!?3,"...new patient added"
"RTN","DPTLK2",16,0)
 S DPTDFN=Y S:$L(DPT("NO^")) DIE("NO^")=DPT("NO^")
"RTN","DPTLK2",17,0)
 ;look for other (local) identifiers
"RTN","DPTLK2",18,0)
 I '$D(DIC("DR")),DIC(0)["E" D
"RTN","DPTLK2",19,0)
 .F DPTID=0:0 S DPTID=$O(^DD(2,0,"ID",DPTID)) Q:'DPTID  D
"RTN","DPTLK2",20,0)
 ..I $F(DPTGID,U_DPTID_U) Q
"RTN","DPTLK2",21,0)
 ..I '$D(^DD(2,DPTID,0)) Q
"RTN","DPTLK2",22,0)
 ..S DPTLID=""
"RTN","DPTLK2",23,0)
 ..S DPTLIDR=$S('$D(DPTLIDR):DPTID,1:DPTLIDR_";"_DPTID)
"RTN","DPTLK2",24,0)
 I $D(DPTLID) W !!?3,"Please enter the following additional information:",!?3 S DIE="^DPT(",DA=+DPTDFN,DIE("NO^")="BACK",DR=DPTLIDR D ^DIE K DIE,DA,DR
"RTN","DPTLK2",25,0)
 ;
"RTN","DPTLK2",26,0)
Q K DFN,DPT("DR"),DPTLID,DPTGID,DPTID,DPTID0,DPTIDS
"RTN","DPTLK2",27,0)
 Q
"RTN","DPTLK2",28,0)
 ;
"RTN","DPTLK2",29,0)
ASKADD I $D(DDS) I $Y>21 D CLRMSG^DDS S DX=0,DY=DDSHBX+1 X DDXY
"RTN","DPTLK2",30,0)
 S Y=+$P(^DPT(0),U,4)+1 W !?3,*7,"ARE YOU ADDING ",$S(DPTX'?.N:"'"_DPTX_"' AS ",1:""),"A NEW PATIENT (THE ",Y,$S(Y#10=1&(Y#100-11):"ST",Y#10=2&(Y#100-12):"ND",Y#10=3&(Y#100-13):"RD",1:"TH"),")"
"RTN","DPTLK2",31,0)
 S %=2 D YN^DICN S DPTDFN=$S(%<0!(%=2):-1,%=1:1,1:0) I 'DPTDFN W !?6,"Enter 'YES' to add a new applicant, or 'NO' not to." G ASKADD
"RTN","DPTLK2",32,0)
 I %=1 S:$$CONF1^DPTNAME(DPTX)'=1 DPTDFN=-1
"RTN","DPTLK2",33,0)
 Q
"RTN","DPTLK2",34,0)
 ;
"RTN","DPTLK2",35,0)
CHKID K DFN S DPTDFN=1,DPTGID="^.02^.03^.09^391^1901^.301^994^" F DPTCT=2:1:8 S DPTID=$P(DPTGID,U,DPTCT) Q:'DPTID!(DPTDFN<0)  D CHKID1
"RTN","DPTLK2",36,0)
 Q
"RTN","DPTLK2",37,0)
 ;
"RTN","DPTLK2",38,0)
CHKID1 I $D(^DD(2,DPTID,0)) S DPT("DR")=$S('$D(DPT("DR")):DPTID,1:DPT("DR")_";"_DPTID),DPTID0=^DD(2,DPTID,0) D ASKID S:'$D(X) DPTDFN=-1
"RTN","DPTLK2",39,0)
 Q
"RTN","DPTLK2",40,0)
 ;
"RTN","DPTLK2",41,0)
ASKID N DGREC W !?3,"PATIENT ",$P(DPTID0,U),": " R X:DTIME D  I $D(DTOUT)!$G(DUOUT)!($G(DGREC)=1) W !?6,*7,"<'",DPTX,"'> NOT ADDED" K X Q
"RTN","DPTLK2",42,0)
 .S:'$T DTOUT=U
"RTN","DPTLK2",43,0)
 .S:X="^" DUOUT=1
"RTN","DPTLK2",44,0)
 .Q:$D(DTOUT)!($G(DUOUT))
"RTN","DPTLK2",45,0)
 .I DPTID=.09 D
"RTN","DPTLK2",46,0)
 ..N DGNEWPT
"RTN","DPTLK2",47,0)
 ..S DGNEWPT=1
"RTN","DPTLK2",48,0)
 ..D REC^DGSEC
"RTN","DPTLK2",49,0)
 I X["^" W:$E(X)["^" !?6,*7,"Sorry, '^' not allowed!" W " ??" G ASKID
"RTN","DPTLK2",50,0)
 ; field 994 is not a required field
"RTN","DPTLK2",51,0)
 I DPTID=994 I X["?" D HLPID G ASKID
"RTN","DPTLK2",52,0)
 I DPTID=994 I X="" G SKIP
"RTN","DPTLK2",53,0)
 I X["?"!(X="") W:X="" *7," ??" D HLPID G ASKID
"RTN","DPTLK2",54,0)
 I $P(DPTID0,U,2)["S" F I=1:1 S Y=$P($P(DPTID0,U,3),";",I) K:Y="" X Q:Y=""  I $P(Y,":",1)=X!($E($P(Y,":",2),1,$L(X))=X) S X=$P(Y,":",1),DPTSET=$P(Y,":",2) Q
"RTN","DPTLK2",55,0)
SKIP I $P(DPTID0,U,2)["P" D P1 G ASKID:Y'>0 S DPTIDS(DPTID)=X,DPT("DR")=DPT("DR")_"///"_X K DPTSET Q
"RTN","DPTLK2",56,0)
 I DPTID=.301,$D(X) D CHKIT Q:'$D(X)  I $D(X) W:$D(DPTSET) " ",DPTSET S DPTIDS(DPTID)=X,DPT("DR")=DPT("DR")_"///"_X K DPTSET Q
"RTN","DPTLK2",57,0)
 I DPTID'=.301 X $P(DPTID0,U,5,99) I $D(X) W:$D(DPTSET) " ",DPTSET S DPTIDS(DPTID)=X,DPT("DR")=DPT("DR")_"///"_X K DPTSET Q
"RTN","DPTLK2",58,0)
 W:'$D(X)&($P(DPTID0,U,2)'["D") *7," ??" D HLPID G ASKID
"RTN","DPTLK2",59,0)
 ;
"RTN","DPTLK2",60,0)
HLPID W:$D(^DD(2,DPTID,.1)) !?5,^(.1) W:$D(^DD(2,DPTID,3)) !?5,^(3) I $D(X),X["?" F I=0:0 S I=$O(^DD(2,DPTID,21,I)) Q:'I!(I>3&(X?1"?"))  I $D(^(I,0)) W !?5,^(0) I I>2,X?1"?" W !?5,"..."
"RTN","DPTLK2",61,0)
 X:$D(^DD(2,DPTID,4)) ^(4) I $P(DPTID0,U,2)["D" S X="?",%DT="E" D ^%DT
"RTN","DPTLK2",62,0)
 I $P(DPTID0,U,2)["S" W !?7,"CHOOSE FROM: " F I=1:1 S Y=$P($P(DPTID0,U,3),";",I) Q:Y=""  W !?7,$P(Y,":",1),?15," ",$P(Y,":",2)
"RTN","DPTLK2",63,0)
 I $P(DPTID0,U,2)["P" D P1
"RTN","DPTLK2",64,0)
 Q
"RTN","DPTLK2",65,0)
P1 S DPTDIC=$G(DIC),DPTDIC(0)=$G(DIC(0)) S:$D(DIC("S")) DPTDIC("S")=DIC("S") S:$D(DIC("W")) DPTDIC("W")=DIC("W") S DIC="^"_$P(DPTID0,"^",3),DIC(0)="QEMZ",D="B" D IX^DIC
"RTN","DPTLK2",66,0)
 S DIC=DPTDIC,DIC(0)=DPTDIC(0) S:$D(DPTDIC("S")) DIC("S")=DPTDIC("S") S:$D(DPTDIC("W")) DIC("W")=DPTDIC("W") K DPTDIC D DO^DIC1 S:X["^" DPTDFN=-1 I X'["^",X'["?",Y'>0 S X="?" G P1
"RTN","DPTLK2",67,0)
 Q
"RTN","DPTLK2",68,0)
CHKIT ; do input transform for .301
"RTN","DPTLK2",69,0)
 I X'="Y" Q
"RTN","DPTLK2",70,0)
 S DGVV=DPTIDS(391),DGVV=$O(^DG(391,"B",DGVV,0))
"RTN","DPTLK2",71,0)
 S DGVV=$S($D(^DG(391,+DGVV,0)):$P(^(0),"^",2),1:"")
"RTN","DPTLK2",72,0)
 I DPTIDS(1901)'="Y",'DGVV D EN^DDIOL("Applicant is NOT a veteran!!","","!?4") K X W !?6,*7,"<'",DPTX,"'> NOT ADDED"
"RTN","DPTLK2",73,0)
 Q
"RTN","DPTLK2",74,0)
DEL ;Delete logic
"RTN","DPTLK2",75,0)
 N I,J,A,G,Q,ERR S Q="""",ERR=0 F I=0:0 S I=$O(^DD(2,0,"PT",I)) Q:'I  F J=0:0 S J=$O(^DD(2,0,"PT",I,J)) Q:'J  D
"RTN","DPTLK2",76,0)
  .F K=0:0 S K=$O(^DD(I,+J,1,K)) Q:'K  S A=$G(^(K,0)) I $L($P(A,U,2)),'$L($P(A,U,3)) D
"RTN","DPTLK2",77,0)
 ..S G=$G(^DIC(+I,0,"GL")) Q:'$L(G)  I $D(@(G_Q_$P(A,U,2)_Q_","_DA_")")) W !,"Entry in "_$P($G(^DIC(I,0)),U)_" ("_I_") refers to this patient" S ERR=1 Q
"RTN","DPTLK2",78,0)
 I ERR
"RTN","VAFCMSG")
0^2^B18003001
"RTN","VAFCMSG",1,0)
VAFCMSG ;ALB/JRP-BACKGROUND JOB TO TRANSMIT ENTRIES IN PIVOT FILE ; 3/2/04 12:54pm
"RTN","VAFCMSG",2,0)
 ;;5.3;Registration;**91,149,530,578**;Jun 06, 1996
"RTN","VAFCMSG",3,0)
 ;
"RTN","VAFCMSG",4,0)
MAIN ;Main entry point for background job
"RTN","VAFCMSG",5,0)
 ;
"RTN","VAFCMSG",6,0)
 ;attempt to lock non existant global.
"RTN","VAFCMSG",7,0)
 L +^VAT(391.71,"VAFC BATCH UPDATE ADT/HL7"):1 I '$T Q
"RTN","VAFCMSG",8,0)
 ;Send messages ? 0=STOP,2=SUSPEND
"RTN","VAFCMSG",9,0)
 N SEND
"RTN","VAFCMSG",10,0)
 S SEND=$P($$SEND^VAFHUTL(),"^",2)
"RTN","VAFCMSG",11,0)
 I (SEND=0)!(SEND=2) L -^VAT(391.71,"VAFC BATCH UPDATE ADT/HL7") Q
"RTN","VAFCMSG",12,0)
 ;Send Registration messages
"RTN","VAFCMSG",13,0)
 D BCSTA04
"RTN","VAFCMSG",14,0)
 ;Send changes to patient's demographical data (ADT-A08)
"RTN","VAFCMSG",15,0)
 D BCSTA08
"RTN","VAFCMSG",16,0)
 ;Send changes to patient's treating facility list (MFU-M05)
"RTN","VAFCMSG",17,0)
 D BCKTFMFU^VAFCTFMF
"RTN","VAFCMSG",18,0)
 ;unlock global
"RTN","VAFCMSG",19,0)
 L -^VAT(391.71,"VAFC BATCH UPDATE ADT/HL7")
"RTN","VAFCMSG",20,0)
 ;K DIC,X,Y
"RTN","VAFCMSG",21,0)
 Q
"RTN","VAFCMSG",22,0)
 ;
"RTN","VAFCMSG",23,0)
BCSTA08 ;Broadcast ADT-A08 messages for all entries in ADT/HL PIVOT file
"RTN","VAFCMSG",24,0)
 ;(#391.71) that have been marked for transmission
"RTN","VAFCMSG",25,0)
 ;
"RTN","VAFCMSG",26,0)
 ;Input  : None
"RTN","VAFCMSG",27,0)
 ;Output : None
"RTN","VAFCMSG",28,0)
 ;
"RTN","VAFCMSG",29,0)
 ;Declare variables
"RTN","VAFCMSG",30,0)
 N PIVOTPTR,NODE,DFN,EDITDATE,TMP,INFOARR
"RTN","VAFCMSG",31,0)
 S INFOARR="^TMP(""VAFCMSG"","_$J_",""EVNTINFO"")"
"RTN","VAFCMSG",32,0)
 K @INFOARR
"RTN","VAFCMSG",33,0)
 ;Loop through pivot file based on demographic updates
"RTN","VAFCMSG",34,0)
 S PIVOTPTR=0
"RTN","VAFCMSG",35,0)
 F  S PIVOTPTR=+$O(^VAT(391.71,"AXMIT",4,PIVOTPTR)) Q:('PIVOTPTR)  D
"RTN","VAFCMSG",36,0)
 .;Bad entry in cross reference - delete it and quit
"RTN","VAFCMSG",37,0)
 .I ('$D(^VAT(391.71,PIVOTPTR))) K ^VAT(391.71,"AXMIT",4,PIVOTPTR) Q
"RTN","VAFCMSG",38,0)
 .;Get event date and pointer to patient
"RTN","VAFCMSG",39,0)
 .S NODE=$G(^VAT(391.71,PIVOTPTR,0))
"RTN","VAFCMSG",40,0)
 .S EDITDATE=+NODE
"RTN","VAFCMSG",41,0)
 .S DFN=+$P(NODE,"^",3)
"RTN","VAFCMSG",42,0)
 .;PATCH 530 check global for lock status - quit if locked.
"RTN","VAFCMSG",43,0)
 .L +^DPT(DFN):1 I '$T Q
"RTN","VAFCMSG",44,0)
 .;Bad pointer to patient - mark entry as transmitted and quit
"RTN","VAFCMSG",45,0)
 .I ('$D(^DPT(DFN,0)))!($G(^DPT(DFN,-9))) D XMITFLAG^VAFCDD01(PIVOTPTR,"",1) Q
"RTN","VAFCMSG",46,0)
 .I $P(^DPT(DFN,0),U)="" D XMITFLAG^VAFCDD01(PIVOTPTR,"",1) Q
"RTN","VAFCMSG",47,0)
 .I '$D(^DPT("B",$P(^DPT(DFN,0),U),DFN)) D XMITFLAG^VAFCDD01(PIVOTPTR,"",1) Q
"RTN","VAFCMSG",48,0)
 .;Store info into event information array
"RTN","VAFCMSG",49,0)
 .K @INFOARR
"RTN","VAFCMSG",50,0)
 .S @INFOARR@("PIVOT")=PIVOTPTR
"RTN","VAFCMSG",51,0)
 .;Event reason code
"RTN","VAFCMSG",52,0)
 .;  99 = Death     98 = Resurrection   97=Sensitivity Update
"RTN","VAFCMSG",53,0)
 .;  Death will overwrite any other reason code. It is the 
"RTN","VAFCMSG",54,0)
 .;  dominant reason code.
"RTN","VAFCMSG",55,0)
 .S @INFOARR@("REASON",1)=""
"RTN","VAFCMSG",56,0)
 .S @INFOARR@("REASON",1)=$P($G(^VAT(391.71,PIVOTPTR,0)),"^",10)
"RTN","VAFCMSG",57,0)
 .I (+$G(^DPT(DFN,.35))) S @INFOARR@("REASON",1)=99
"RTN","VAFCMSG",58,0)
 .;
"RTN","VAFCMSG",59,0)
 .; user/operator name from duz
"RTN","VAFCMSG",60,0)
 .S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(NODE,"^",9) D ^DIC
"RTN","VAFCMSG",61,0)
 .S @INFOARR@("USER")=$P($G(Y),"^",2)
"RTN","VAFCMSG",62,0)
 .;
"RTN","VAFCMSG",63,0)
 .S @INFOARR@("EVENT-NUM")=$P(NODE,"^",2)
"RTN","VAFCMSG",64,0)
 .S @INFOARR@("VAR-PTR")=$P(NODE,"^",5)
"RTN","VAFCMSG",65,0)
 .;
"RTN","VAFCMSG",66,0)
 .;Broadcast ADT-A08 message
"RTN","VAFCMSG",67,0)
 .S TMP=$$BCSTADT^VAFCMSG0(DFN,"A08",EDITDATE,INFOARR)
"RTN","VAFCMSG",68,0)
 .;Store result in pivot file
"RTN","VAFCMSG",69,0)
 .S:$P(TMP,U,2)]"" TMP=$P(TMP,U,2) D FILERM^VAFCUTL(PIVOTPTR,TMP)
"RTN","VAFCMSG",70,0)
 .;Error broadcasting message
"RTN","VAFCMSG",71,0)
 .Q:(TMP<0)
"RTN","VAFCMSG",72,0)
 .;Mark entry in pivot file as transmitted
"RTN","VAFCMSG",73,0)
 .D XMITFLAG^VAFCDD01(PIVOTPTR,"",1)
"RTN","VAFCMSG",74,0)
 .;PATCH 530 if locked by check unlock.
"RTN","VAFCMSG",75,0)
 .L -^DPT(DFN)
"RTN","VAFCMSG",76,0)
 ;Done - clean up and quit
"RTN","VAFCMSG",77,0)
 K @INFOARR
"RTN","VAFCMSG",78,0)
 Q
"RTN","VAFCMSG",79,0)
 ;
"RTN","VAFCMSG",80,0)
BCSTA04 ;Broadcast ADT-A04 messages for all entries in ADT/HL PIVOT file
"RTN","VAFCMSG",81,0)
 ;(#391.71) that have been marked for transmission
"RTN","VAFCMSG",82,0)
 ;
"RTN","VAFCMSG",83,0)
 ;Input  : None
"RTN","VAFCMSG",84,0)
 ;Output : None
"RTN","VAFCMSG",85,0)
 ;
"RTN","VAFCMSG",86,0)
 ;Declare variables
"RTN","VAFCMSG",87,0)
 N PIVOTPTR,NODE,DFN,EDITDATE,FIELDS,RESULT
"RTN","VAFCMSG",88,0)
 S PIVOTPTR=0
"RTN","VAFCMSG",89,0)
 F  S PIVOTPTR=+$O(^VAT(391.71,"AXMIT",3,PIVOTPTR)) Q:('PIVOTPTR)  D
"RTN","VAFCMSG",90,0)
 .;Bad entry in cross reference - delete it and quit
"RTN","VAFCMSG",91,0)
 .I ('$D(^VAT(391.71,PIVOTPTR))) K ^VAT(391.71,"AXMIT",3,PIVOTPTR) Q
"RTN","VAFCMSG",92,0)
 .;Get event date and pointer to patient
"RTN","VAFCMSG",93,0)
 .S NODE=$G(^VAT(391.71,PIVOTPTR,0))
"RTN","VAFCMSG",94,0)
 .S FIELDS=$G(^VAT(391.71,PIVOTPTR,2))
"RTN","VAFCMSG",95,0)
 .S USER=+$P(NODE,"^",9)
"RTN","VAFCMSG",96,0)
 .S EDITDATE=+NODE
"RTN","VAFCMSG",97,0)
 .S DFN=+$P(NODE,"^",3)
"RTN","VAFCMSG",98,0)
 .;PATCH 530 check for locked record - quit if locked.
"RTN","VAFCMSG",99,0)
 .L +^DPT(DFN):1 I '$T Q
"RTN","VAFCMSG",100,0)
 .;Bad pointer to patient - mark entry as transmitted and quit
"RTN","VAFCMSG",101,0)
 .I ('$D(^DPT(DFN,0)))!($G(^DPT(DFN,-9))) D XMITFLAG^VAFCDD01(PIVOTPTR,"",1) Q
"RTN","VAFCMSG",102,0)
 .I $P(^DPT(DFN,0),U)="" D XMITFLAG^VAFCDD01(PIVOTPTR,"",1) Q
"RTN","VAFCMSG",103,0)
 .I '$D(^DPT("B",$P(^DPT(DFN,0),U),DFN)) D XMITFLAG^VAFCDD01(PIVOTPTR,"",1) Q
"RTN","VAFCMSG",104,0)
 .;Broadcast ADT-A04 message
"RTN","VAFCMSG",105,0)
 .S RESULT=$$EN^VAFCA04(DFN,EDITDATE,USER,PIVOTPTR)
"RTN","VAFCMSG",106,0)
 .D XMITFLAG^VAFCDD01(PIVOTPTR,"",1)
"RTN","VAFCMSG",107,0)
 .L -^DPT(DFN)
"RTN","VAFCMSG",108,0)
 ;Done - quit
"RTN","VAFCMSG",109,0)
 Q
"VER")
8.0^22
**END**
**END**
