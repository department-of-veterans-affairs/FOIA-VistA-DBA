Released XM*7.1*55 SEQ #51
Extracted from mail message
**KIDS**:XM*7.1*55^

**INSTALL NAME**
XM*7.1*55
"BLD",36,0)
XM*7.1*55^MAILMAN^0^2980219^y
"BLD",36,1,0)
^^44^44^2980219^^^^
"BLD",36,1,1,0)
MailMan patch XM*7.1*55 addresses Y2K preparedness.
"BLD",36,1,2,0)

"BLD",36,1,3,0)
===========================================================================
"BLD",36,1,4,0)
This patch should be installed after-hours, when user activity is at a
"BLD",36,1,5,0)
minimum.  You should put the XMUSER option out of order. The filers should
"BLD",36,1,6,0)
be shut down.
"BLD",36,1,7,0)
===========================================================================
"BLD",36,1,8,0)

"BLD",36,1,9,0)
INSTALLATION:
"BLD",36,1,10,0)
1.  DSM Sites: If any of these routines is mapped, disable mapping for the 
"BLD",36,1,11,0)
    affected routine(s).  
"BLD",36,1,12,0)
2.  On the PackMan menu, use the 'INSTALL/CHECK MESSAGE' option.  This loads 
"BLD",36,1,13,0)
    the patch into a Transport Global on your system.  
"BLD",36,1,14,0)
3.  On the KIDS:Installation menu, use the following options to install the 
"BLD",36,1,15,0)
    Transport Global: 
"BLD",36,1,16,0)
       Verify Checksums in Transport Global 
"BLD",36,1,17,0)
       Print Transport Global 
"BLD",36,1,18,0)
       Compare Transport Global to Current System 
"BLD",36,1,19,0)
       Backup a Transport Global 
"BLD",36,1,20,0)
       Install Package(s) 
"BLD",36,1,21,0)
4.  DSM Sites: After patch has installed, rebuild your map set.  
"BLD",36,1,22,0)

"BLD",36,1,23,0)
============================================================================ 
"BLD",36,1,24,0)
  
"BLD",36,1,25,0)
ROUTINES:
"BLD",36,1,26,0)
The second line of the routine now looks like:
"BLD",36,1,27,0)
       ;;7.1;MailMan;**[patch list]**;Jun 02, 1994
"BLD",36,1,28,0)
 
"BLD",36,1,29,0)
              Before          After
"BLD",36,1,30,0)
Name          Checksum        Checksum        Patch List
"BLD",36,1,31,0)
----------------------------------------------------------
"BLD",36,1,32,0)
XMA32A        10911370        10902381        27,37,44,55
"BLD",36,1,33,0)
XMDIR1        10096361         9721400        27,55
"BLD",36,1,34,0)
XMRPCTS0       6044236         5929098        6,12,31,55
"BLD",36,1,35,0)
XMRTCPGO       2862153         2857890        8,55
"BLD",36,1,36,0)
XMS0           9445201         9233148        13,8,20,23,27,34,55
"BLD",36,1,37,0)
XMS0A          8601934         8144942        2,13,55
"BLD",36,1,38,0)
XMS5          12968983        12887076        13,8,23,27,55
"BLD",36,1,39,0)
XMS5A          4118857         3624422        55
"BLD",36,1,40,0)
XMUT4A         4382977         4424419        34,55
"BLD",36,1,41,0)
XMUT5R1        2850555         2356802        55
"BLD",36,1,42,0)

"BLD",36,1,43,0)
* Checksums produced by CHECK^XTSUMBLD
"BLD",36,1,44,0)
============================================================================
"BLD",36,4,0)
^9.64PA^^0
"BLD",36,"INI")

"BLD",36,"INIT")

"BLD",36,"KRN",0)
^9.67PA^19^12
"BLD",36,"KRN",.4,0)
.4
"BLD",36,"KRN",.401,0)
.401
"BLD",36,"KRN",.402,0)
.402
"BLD",36,"KRN",.403,0)
.403
"BLD",36,"KRN",.5,0)
.5
"BLD",36,"KRN",.84,0)
.84
"BLD",36,"KRN",3.6,0)
3.6
"BLD",36,"KRN",3.8,0)
3.8
"BLD",36,"KRN",9.2,0)
9.2
"BLD",36,"KRN",9.8,0)
9.8
"BLD",36,"KRN",9.8,"NM",0)
^9.68A^11^10
"BLD",36,"KRN",9.8,"NM",1,0)
XMA32A^^0^B51277093
"BLD",36,"KRN",9.8,"NM",2,0)
XMDIR1^^0^B23347452
"BLD",36,"KRN",9.8,"NM",3,0)
XMRPCTS0^^0^B14041293
"BLD",36,"KRN",9.8,"NM",4,0)
XMRTCPGO^^0^B3838958
"BLD",36,"KRN",9.8,"NM",5,0)
XMS0^^0^B22938679
"BLD",36,"KRN",9.8,"NM",6,0)
XMS0A^^0^B14345792
"BLD",36,"KRN",9.8,"NM",8,0)
XMS5^^0^B27972276
"BLD",36,"KRN",9.8,"NM",9,0)
XMS5A^^0^B4960674
"BLD",36,"KRN",9.8,"NM",10,0)
XMUT4A^^0^B8301630
"BLD",36,"KRN",9.8,"NM",11,0)
XMUT5R1^^0^B4386528
"BLD",36,"KRN",9.8,"NM","B","XMA32A",1)

"BLD",36,"KRN",9.8,"NM","B","XMDIR1",2)

"BLD",36,"KRN",9.8,"NM","B","XMRPCTS0",3)

"BLD",36,"KRN",9.8,"NM","B","XMRTCPGO",4)

"BLD",36,"KRN",9.8,"NM","B","XMS0",5)

"BLD",36,"KRN",9.8,"NM","B","XMS0A",6)

"BLD",36,"KRN",9.8,"NM","B","XMS5",8)

"BLD",36,"KRN",9.8,"NM","B","XMS5A",9)

"BLD",36,"KRN",9.8,"NM","B","XMUT4A",10)

"BLD",36,"KRN",9.8,"NM","B","XMUT5R1",11)

"BLD",36,"KRN",19,0)
19
"BLD",36,"KRN",19,"NM",0)
^9.68A^^0
"BLD",36,"KRN",19.1,0)
19.1
"BLD",36,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",36,"KRN","B",.4,.4)

"BLD",36,"KRN","B",.401,.401)

"BLD",36,"KRN","B",.402,.402)

"BLD",36,"KRN","B",.403,.403)

"BLD",36,"KRN","B",.5,.5)

"BLD",36,"KRN","B",.84,.84)

"BLD",36,"KRN","B",3.6,3.6)

"BLD",36,"KRN","B",3.8,3.8)

"BLD",36,"KRN","B",9.2,9.2)

"BLD",36,"KRN","B",9.8,9.8)

"BLD",36,"KRN","B",19,19)

"BLD",36,"KRN","B",19.1,19.1)

"BLD",36,"QUES",0)
^9.62^^
"BLD",36,"REQB",0)
^9.611^^
"PKG",6,-1)
1^1
"PKG",6,0)
MAILMAN^XM^Electronic Mail, both local and networked
"PKG",6,22,0)
^9.49I^1^1
"PKG",6,22,1,0)
7.1^2940602^2950925
"PKG",6,22,1,"PAH",1,0)
55^2980219
"PKG",6,22,1,"PAH",1,1,0)
^^44^44^2980219
"PKG",6,22,1,"PAH",1,1,1,0)
MailMan patch XM*7.1*55 addresses Y2K preparedness.
"PKG",6,22,1,"PAH",1,1,2,0)

"PKG",6,22,1,"PAH",1,1,3,0)
===========================================================================
"PKG",6,22,1,"PAH",1,1,4,0)
This patch should be installed after-hours, when user activity is at a
"PKG",6,22,1,"PAH",1,1,5,0)
minimum.  You should put the XMUSER option out of order. The filers should
"PKG",6,22,1,"PAH",1,1,6,0)
be shut down.
"PKG",6,22,1,"PAH",1,1,7,0)
===========================================================================
"PKG",6,22,1,"PAH",1,1,8,0)

"PKG",6,22,1,"PAH",1,1,9,0)
INSTALLATION:
"PKG",6,22,1,"PAH",1,1,10,0)
1.  DSM Sites: If any of these routines is mapped, disable mapping for the 
"PKG",6,22,1,"PAH",1,1,11,0)
    affected routine(s).  
"PKG",6,22,1,"PAH",1,1,12,0)
2.  On the PackMan menu, use the 'INSTALL/CHECK MESSAGE' option.  This loads 
"PKG",6,22,1,"PAH",1,1,13,0)
    the patch into a Transport Global on your system.  
"PKG",6,22,1,"PAH",1,1,14,0)
3.  On the KIDS:Installation menu, use the following options to install the 
"PKG",6,22,1,"PAH",1,1,15,0)
    Transport Global: 
"PKG",6,22,1,"PAH",1,1,16,0)
       Verify Checksums in Transport Global 
"PKG",6,22,1,"PAH",1,1,17,0)
       Print Transport Global 
"PKG",6,22,1,"PAH",1,1,18,0)
       Compare Transport Global to Current System 
"PKG",6,22,1,"PAH",1,1,19,0)
       Backup a Transport Global 
"PKG",6,22,1,"PAH",1,1,20,0)
       Install Package(s) 
"PKG",6,22,1,"PAH",1,1,21,0)
4.  DSM Sites: After patch has installed, rebuild your map set.  
"PKG",6,22,1,"PAH",1,1,22,0)

"PKG",6,22,1,"PAH",1,1,23,0)
============================================================================ 
"PKG",6,22,1,"PAH",1,1,24,0)
  
"PKG",6,22,1,"PAH",1,1,25,0)
ROUTINES:
"PKG",6,22,1,"PAH",1,1,26,0)
The second line of the routine now looks like:
"PKG",6,22,1,"PAH",1,1,27,0)
       ;;7.1;MailMan;**[patch list]**;Jun 02, 1994
"PKG",6,22,1,"PAH",1,1,28,0)
 
"PKG",6,22,1,"PAH",1,1,29,0)
              Before          After
"PKG",6,22,1,"PAH",1,1,30,0)
Name          Checksum        Checksum        Patch List
"PKG",6,22,1,"PAH",1,1,31,0)
----------------------------------------------------------
"PKG",6,22,1,"PAH",1,1,32,0)
XMA32A        10911370        10902381        27,37,44,55
"PKG",6,22,1,"PAH",1,1,33,0)
XMDIR1        10096361         9721400        27,55
"PKG",6,22,1,"PAH",1,1,34,0)
XMRPCTS0       6044236         5929098        6,12,31,55
"PKG",6,22,1,"PAH",1,1,35,0)
XMRTCPGO       2862153         2857890        8,55
"PKG",6,22,1,"PAH",1,1,36,0)
XMS0           9445201         9233148        13,8,20,23,27,34,55
"PKG",6,22,1,"PAH",1,1,37,0)
XMS0A          8601934         8144942        2,13,55
"PKG",6,22,1,"PAH",1,1,38,0)
XMS5          12968983        12887076        13,8,23,27,55
"PKG",6,22,1,"PAH",1,1,39,0)
XMS5A          4118857         3624422        55
"PKG",6,22,1,"PAH",1,1,40,0)
XMUT4A         4382977         4424419        34,55
"PKG",6,22,1,"PAH",1,1,41,0)
XMUT5R1        2850555         2356802        55
"PKG",6,22,1,"PAH",1,1,42,0)

"PKG",6,22,1,"PAH",1,1,43,0)
* Checksums produced by CHECK^XTSUMBLD
"PKG",6,22,1,"PAH",1,1,44,0)
============================================================================
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","XMA32A")
0^1^B51277093
"RTN","XMA32A",1,0)
XMA32A ;(WASH ISC)/CAP - PURGE MESSAGES BY DATE ;01/28/98  07:01
"RTN","XMA32A",2,0)
 ;;7.1;MailMan;**27,37,44,55**;Jun 02, 1994
"RTN","XMA32A",3,0)
 ; XMPARM("PDATE") Purge all messages older than this date
"RTN","XMA32A",4,0)
 ; XMPARM("START") First message to process
"RTN","XMA32A",5,0)
 ; XMPARM("END")   Last message to process
"RTN","XMA32A",6,0)
 ; XMPARM("STOP ON DATE") =0 Don't stop when we hit the first message
"RTN","XMA32A",7,0)
 ;                           with a date greater than XMPARM("PDATE");
"RTN","XMA32A",8,0)
 ;                           Rather, continue through message number
"RTN","XMA32A",9,0)
 ;                           XMPARM("END")
"RTN","XMA32A",10,0)
 ;                        =1 Stop when we hit the first message with a
"RTN","XMA32A",11,0)
 ;                           date greater than XMPARM("PDATE").
"RTN","XMA32A",12,0)
 ;                           But, don't go past message number XMPARM("END")
"RTN","XMA32A",13,0)
 ; XMCNT           Total messages processed
"RTN","XMA32A",14,0)
 ; XMKILL("MSG")   Messages purged
"RTN","XMA32A",15,0)
 ; XMKILL("RESP")  Responses killed
"RTN","XMA32A",16,0)
 ; XMDUZ           Pointer to mailbox
"RTN","XMA32A",17,0)
 ; XMZTMP          Holder for XMZ
"RTN","XMA32A",18,0)
 ; XMZ             Current message being processed
"RTN","XMA32A",19,0)
 ; XMDATERR        Count of messages with bad dates
"RTN","XMA32A",20,0)
ENT ;
"RTN","XMA32A",21,0)
 N XMIEN,XMPDATE,XMCNT,XMKILL,XMZ,XMNOW,XMABORT,XMFDA,XMPAGE,XMDATERR
"RTN","XMA32A",22,0)
 D INIT
"RTN","XMA32A",23,0)
 D PROCESS
"RTN","XMA32A",24,0)
 D FINISH
"RTN","XMA32A",25,0)
 Q
"RTN","XMA32A",26,0)
INIT ;
"RTN","XMA32A",27,0)
 S (XMPAGE,XMCNT,XMKILL("MSG"),XMKILL("RESP"),XMDATERR,XMABORT)=0
"RTN","XMA32A",28,0)
 D INITAUDT(.XMPARM,.XMIEN,.XMNOW)
"RTN","XMA32A",29,0)
 S XMPDATE=$E(XMPARM("PDATE"),4,5)_"/"_$E(XMPARM("PDATE"),6,7)_"/"_$E(XMPARM("PDATE"),2,3)
"RTN","XMA32A",30,0)
 S XMNOW=$$DOW^XLFDT(XMNOW)_", "_$$FMTE^XLFDT(XMNOW,1)
"RTN","XMA32A",31,0)
 W:IOST["C-" @IOF D PRTHDR
"RTN","XMA32A",32,0)
 Q
"RTN","XMA32A",33,0)
INITAUDT(XMPARM,XMIEN,XMNOW) ;
"RTN","XMA32A",34,0)
 S XMNOW=$$NOW^XLFDT
"RTN","XMA32A",35,0)
 S XMFDA(4.302,"+1,1,",.01)=XMNOW
"RTN","XMA32A",36,0)
 S XMFDA(4.302,"+1,1,",3)=XMPARM("START")
"RTN","XMA32A",37,0)
 S XMFDA(4.302,"+1,1,",4)=XMPARM("END")
"RTN","XMA32A",38,0)
 S XMFDA(4.302,"+1,1,",5)=$S(XMPARM("TYPE")=2:"1TEST",1:XMPARM("TYPE"))
"RTN","XMA32A",39,0)
 S XMFDA(4.302,"+1,1,",6)=XMPARM("PDATE")
"RTN","XMA32A",40,0)
 D UPDATE^DIE("","XMFDA","XMIEN")
"RTN","XMA32A",41,0)
 S XMIEN=XMIEN(1)
"RTN","XMA32A",42,0)
 Q
"RTN","XMA32A",43,0)
PROCESS ;
"RTN","XMA32A",44,0)
 N XMDATE,XMR,XMZO
"RTN","XMA32A",45,0)
 S XMDATE=0
"RTN","XMA32A",46,0)
 S XMZ=XMPARM("START")-1
"RTN","XMA32A",47,0)
 F  S XMZ=$O(^XMB(3.9,XMZ)) Q:XMZ'>0!(XMZ>XMPARM("END"))!XMABORT  D  I XMPARM("STOP ON DATE"),XMDATE'<XMPARM("PDATE") Q
"RTN","XMA32A",48,0)
 . S XMCNT=XMCNT+1 I XMCNT#5000=0 D CHK
"RTN","XMA32A",49,0)
 . S XMR=$G(^XMB(3.9,XMZ,0)) I XMR="" D KILL(XMZ,.XMKILL,.XMPARM) Q
"RTN","XMA32A",50,0)
 . Q:$D(^XMB(3.7,"M",XMZ,.6))  ; Do nothing if owned by SHARED,MAIL
"RTN","XMA32A",51,0)
 . S XMDATE=$P(XMR,U,3) ; Date sent
"RTN","XMA32A",52,0)
 . I XMDATE'?7N1".".N,XMDATE'?7N S XMDATE=$$CONVERT(XMDATE)
"RTN","XMA32A",53,0)
 . I XMDATE<2000000 D  Q
"RTN","XMA32A",54,0)
 . . S XMDATERR=XMDATERR+1
"RTN","XMA32A",55,0)
 . . D HDR(2) Q:XMABORT
"RTN","XMA32A",56,0)
 . . W !,XMZ,?15,"*** Bad date: ",$P(XMR,U,3),?79
"RTN","XMA32A",57,0)
 . ;S XMDATE=$P(XMDATE,".")
"RTN","XMA32A",58,0)
 . Q:XMDATE'<XMPARM("PDATE")
"RTN","XMA32A",59,0)
 . S XMZO=$S($P(XMR,U,8):$P(XMR,U,8),$P(XMR,U)?1"R"1.N:+$E(XMR,2,99),1:"")
"RTN","XMA32A",60,0)
 . I XMZO,XMZO<XMZ,$D(^XMB(3.9,XMZO,0)) Q  ; Response with existing original msg
"RTN","XMA32A",61,0)
 . D KILL(XMZ,.XMKILL,.XMPARM)  ; Old msg; old response without original msg; old msg which thinks it's also a response; old response which thinks it's also the original msg.
"RTN","XMA32A",62,0)
 Q
"RTN","XMA32A",63,0)
KILL(XMZ,XMKILL,XMPARM) ;
"RTN","XMA32A",64,0)
 I $G(XMPARM("TEST")) D  Q:XMABORT
"RTN","XMA32A",65,0)
 . D HDR(2) Q:XMABORT
"RTN","XMA32A",66,0)
 . N X
"RTN","XMA32A",67,0)
 . S X=$P($P(XMR,U,3),".")
"RTN","XMA32A",68,0)
 . W !,XMZ,?20," <<< Purge!  Date = ",$S(X?7N.E:$E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3),1:X)
"RTN","XMA32A",69,0)
 D KBASKETS Q:XMABORT
"RTN","XMA32A",70,0)
 D KMSG Q:XMABORT
"RTN","XMA32A",71,0)
 D KLATER
"RTN","XMA32A",72,0)
 Q
"RTN","XMA32A",73,0)
KBASKETS ;
"RTN","XMA32A",74,0)
 N XMDUZ,XMK
"RTN","XMA32A",75,0)
 S XMDUZ="",XMKILL("MSG")=XMKILL("MSG")+1
"RTN","XMA32A",76,0)
 F  S XMDUZ=$O(^XMB(3.7,"M",XMZ,XMDUZ)) Q:XMDUZ=""!XMABORT  D
"RTN","XMA32A",77,0)
 . S XMK=$O(^XMB(3.7,"M",XMZ,XMDUZ,0))
"RTN","XMA32A",78,0)
 . Q:'XMK
"RTN","XMA32A",79,0)
 . Q:'$D(^XMB(3.7,XMDUZ,2,XMK,1,XMZ))
"RTN","XMA32A",80,0)
 . I $G(XMPARM("TEST")) D  Q
"RTN","XMA32A",81,0)
 . . D HDR(2) Q:XMABORT
"RTN","XMA32A",82,0)
 . . W !?25,"Message deleted for DUZ:",?50,$J(XMDUZ,12),?79
"RTN","XMA32A",83,0)
 . D KL^XMA1B ; Delete from user's basket
"RTN","XMA32A",84,0)
 Q
"RTN","XMA32A",85,0)
KMSG ;
"RTN","XMA32A",86,0)
 N XMZTMP,XMZO,X
"RTN","XMA32A",87,0)
 S XMZTMP=XMZ,XMZO=0
"RTN","XMA32A",88,0)
 F  S XMZO=$O(^XMB(3.9,XMZTMP,3,XMZO)) Q:XMZO'>0!XMABORT  D
"RTN","XMA32A",89,0)
 . S XMZ=$P($G(^XMB(3.9,XMZTMP,3,XMZO,0)),U)
"RTN","XMA32A",90,0)
 . S XMKILL("RESP")=XMKILL("RESP")+1
"RTN","XMA32A",91,0)
 . I $G(XMPARM("TEST")) D  Q
"RTN","XMA32A",92,0)
 . . D HDR(2) Q:XMABORT
"RTN","XMA32A",93,0)
 . . W !?25,"Response deleted:",?50,$J(XMZ,12),?79
"RTN","XMA32A",94,0)
 . D KILL^XMA3  ; Kill response
"RTN","XMA32A",95,0)
 S XMZ=XMZTMP
"RTN","XMA32A",96,0)
 D:'$G(XMPARM("TEST")) KILL^XMA3  ; Kill original message
"RTN","XMA32A",97,0)
 Q
"RTN","XMA32A",98,0)
KLATER ;
"RTN","XMA32A",99,0)
 Q:$G(XMPARM("TEST"))
"RTN","XMA32A",100,0)
 N DIK,DA,XMDUZ
"RTN","XMA32A",101,0)
 S DIK="^XMB(3.73,"
"RTN","XMA32A",102,0)
 S (XMDUZ,DA)=""
"RTN","XMA32A",103,0)
 F  S XMDUZ=$O(^XMB(3.73,"AC",XMZ,XMDUZ)) Q:'XMDUZ  D
"RTN","XMA32A",104,0)
 . F  S DA=$O(^XMB(3.73,"AC",XMZ,XMDUZ,DA)) Q:'DA  D ^DIK
"RTN","XMA32A",105,0)
 Q
"RTN","XMA32A",106,0)
HDR(XMLINES) ;
"RTN","XMA32A",107,0)
 Q:$Y+XMLINES<IOSL
"RTN","XMA32A",108,0)
 I IOST["C-" D  Q:XMABORT
"RTN","XMA32A",109,0)
 . N DIR
"RTN","XMA32A",110,0)
 . S DIR(0)="E"
"RTN","XMA32A",111,0)
 . D ^DIR S:$D(DIRUT) XMABORT=1
"RTN","XMA32A",112,0)
 W @IOF D PRTHDR
"RTN","XMA32A",113,0)
 Q
"RTN","XMA32A",114,0)
PRTHDR ;
"RTN","XMA32A",115,0)
 S XMPAGE=XMPAGE+1
"RTN","XMA32A",116,0)
 W "Message purge, Origination date < ",XMPDATE
"RTN","XMA32A",117,0)
 W "      From: ",$J(XMPARM("START"),$L(XMPARM("END"))),"   Page: ",XMPAGE
"RTN","XMA32A",118,0)
 W !,"Started: ",XMNOW,?50,"To: ",XMPARM("END"),$S(XMPARM("TEST"):"  *TEST RUN*",1:""),!
"RTN","XMA32A",119,0)
 Q
"RTN","XMA32A",120,0)
FINISH ;
"RTN","XMA32A",121,0)
 I XMABORT W @IOF D PRTHDR
"RTN","XMA32A",122,0)
 D CHK
"RTN","XMA32A",123,0)
 D HDR(5+(2*$G(ZTSTOP)))
"RTN","XMA32A",124,0)
 Q:'XMCNT
"RTN","XMA32A",125,0)
 I $G(ZTSTOP) W !!,"*** Stopping prematurely per user request ***"
"RTN","XMA32A",126,0)
 W !!,"Message purge finished on ",$$FMTE^XLFDT($$NOW^XLFDT,1)
"RTN","XMA32A",127,0)
 W !,XMCNT," messages processed."
"RTN","XMA32A",128,0)
 W !,XMKILL("MSG")," original messages and ",XMKILL("RESP")," responses purged."
"RTN","XMA32A",129,0)
 W !,XMDATERR," messages had indecipherable dates."
"RTN","XMA32A",130,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","XMA32A",131,0)
 Q:XMPARM("TEST")
"RTN","XMA32A",132,0)
 S $P(^(0),U,4)=$P(^XMB(3.9,0),U,4)-XMKILL("MSG")-XMKILL("RESP")
"RTN","XMA32A",133,0)
 Q
"RTN","XMA32A",134,0)
CHK ;
"RTN","XMA32A",135,0)
 D CHKAUDT(XMIEN,XMZ,.XMKILL)
"RTN","XMA32A",136,0)
 I $D(ZTQUEUED),$$S^%ZTLOAD S (XMABORT,ZTSTOP)=1  Q  ; User has asked the task to stop
"RTN","XMA32A",137,0)
 Q:IOST'["C-"
"RTN","XMA32A",138,0)
 I $X+$L(XMCNT)+1>IOM D
"RTN","XMA32A",139,0)
 . D HDR(2)
"RTN","XMA32A",140,0)
 . W !
"RTN","XMA32A",141,0)
 E  W " "
"RTN","XMA32A",142,0)
 W XMCNT
"RTN","XMA32A",143,0)
 Q
"RTN","XMA32A",144,0)
CHKAUDT(XMIEN,XMZ,XMKILL) ;
"RTN","XMA32A",145,0)
 S XMFDA(4.302,XMIEN_",1,",1)=$P(^XMB(3.9,0),U,4)-XMKILL("MSG")-XMKILL("RESP")
"RTN","XMA32A",146,0)
 S XMFDA(4.302,XMIEN_",1,",2)=XMKILL("MSG")+XMKILL("RESP")
"RTN","XMA32A",147,0)
 S XMFDA(4.302,XMIEN_",1,",7)=$$NOW^XLFDT
"RTN","XMA32A",148,0)
 S XMFDA(4.302,XMIEN_",1,",8)=XMZ-1
"RTN","XMA32A",149,0)
 D FILE^DIE("","XMFDA")
"RTN","XMA32A",150,0)
 Q
"RTN","XMA32A",151,0)
 ; Formats:  Tuesday, 28 June 1955 17:30:45 PDT
"RTN","XMA32A",152,0)
 ;           Tue, 28 Jun 1955 17:30:45 PDT
"RTN","XMA32A",153,0)
 ;           Tue 28 Jun 1955 17:30:45 PDT
"RTN","XMA32A",154,0)
 ;           28 Jun 1955 17:30 PST          <== MailMan standard
"RTN","XMA32A",155,0)
 ;           28 Jun 55 17:30 PST            <== Previous MailMan standard
"RTN","XMA32A",156,0)
 ;           Tue Jun 28 17:30:45 PDT 1955
"RTN","XMA32A",157,0)
 ;           28-JUN-1955 17:30:45 -0400
"RTN","XMA32A",158,0)
 ;           6/28/55 17:30
"RTN","XMA32A",159,0)
 ;           JUN 28 17:30 1955
"RTN","XMA32A",160,0)
CONVERT(X,XMTIME) ; Function to convert Internet dates to FM (returns -1 if error)
"RTN","XMA32A",161,0)
 ; X      Internet date
"RTN","XMA32A",162,0)
 ; XMTIME =1 Convert time, too; =0 convert date only
"RTN","XMA32A",163,0)
 N %DT,Y
"RTN","XMA32A",164,0)
 I $E(X)=" "!($E(X)=$C(9)) F  S X=$E(X,2,99) Q:$E(X)'=$C(9)&($E(X)'=" ")  ; remove leading blanks or tabs
"RTN","XMA32A",165,0)
 I X?.E2" ".E D  ; reduce all consecutive blanks to 1 blank
"RTN","XMA32A",166,0)
 . N I S I=1
"RTN","XMA32A",167,0)
 . F  S I=$F(X,"  ",I) Q:I=0  S X=$E(X,1,I-2)_$E(X,I,99),I=I-1
"RTN","XMA32A",168,0)
 I X?3.A.E D
"RTN","XMA32A",169,0)
 . I X?3.A1", ".E!(X?3.A1" "3.A.E)!(X?3.A1" "1.2N1" "3.A.E) S X=$P(X," ",2,99) ; remove leading day of week
"RTN","XMA32A",170,0)
 I $P(X," ",3)[":" D
"RTN","XMA32A",171,0)
 . S XMD=$P(X," ",1,2)_" "_$P(X," ",$L(X," ")) ; time is before year
"RTN","XMA32A",172,0)
 . S XMT=$P(X," ",3,$L(X," ")-1)
"RTN","XMA32A",173,0)
 E  D
"RTN","XMA32A",174,0)
 . S XMD=$P(X," ",1,3) ; year is before time
"RTN","XMA32A",175,0)
 . I XMD[":" D
"RTN","XMA32A",176,0)
 . . S XMD=$P(X," ",1) ; "28-JUN-1955 17:30:45 -0400" or "6/28/55 17:30"
"RTN","XMA32A",177,0)
 . . S XMT=$P(X," ",2,99)
"RTN","XMA32A",178,0)
 . E  S XMT=$P(X," ",4,99)
"RTN","XMA32A",179,0)
 I $G(XMTIME) Q $$TIMETOO(XMD,XMT)
"RTN","XMA32A",180,0)
 S X=XMD
"RTN","XMA32A",181,0)
 D ^%DT
"RTN","XMA32A",182,0)
 Q Y
"RTN","XMA32A",183,0)
TIMETOO(XMD,XMT) ; Combine date and time, adjusting for difference from GMT.
"RTN","XMA32A",184,0)
 N XMHH,XMMM,X,Y
"RTN","XMA32A",185,0)
 Q:$L(XMT," ")'=2 -1
"RTN","XMA32A",186,0)
 S XMYT=$P(XMT," ",2)
"RTN","XMA32A",187,0)
 D ZONEDIFF(XMYT,.XMHH,.XMMM) Q:XMHH=-1 -1
"RTN","XMA32A",188,0)
 S XMT=$P(XMT," ",1)
"RTN","XMA32A",189,0)
 S:$P(XMT,":")=0 XMT="0"_XMT
"RTN","XMA32A",190,0)
 S XMT=$E(XMT,1,5)  ; FM will only handle hh:mm, not :ss
"RTN","XMA32A",191,0)
 S:XMT="00:00" XMT="00:01" ; if midnight, add a minute
"RTN","XMA32A",192,0)
 S X=XMD_"@"_XMT
"RTN","XMA32A",193,0)
 S %DT="T" D ^%DT Q:Y=-1 -1
"RTN","XMA32A",194,0)
 I 'XMHH,'XMMM Q Y
"RTN","XMA32A",195,0)
 Q $$FMADD^XLFDT(Y,"",XMHH,XMMM)
"RTN","XMA32A",196,0)
ZONEDIFF(XMYT,XMHH,XMMM) ;
"RTN","XMA32A",197,0)
 ; XMYT  ; Your Time difference from GMT
"RTN","XMA32A",198,0)
 ; XMHH  ; Your Time difference from GMT in hours
"RTN","XMA32A",199,0)
 ; XMTD  ; Time Difference between the two time zones
"RTN","XMA32A",200,0)
 ; XMMM  ; Your Time difference from GMT in minutes
"RTN","XMA32A",201,0)
 ; XMMT  ; My Time difference from GMT
"RTN","XMA32A",202,0)
 N XMMT,XMTD
"RTN","XMA32A",203,0)
 S XMMT=$G(^XMB("GMT"))
"RTN","XMA32A",204,0)
 I XMMT="" D
"RTN","XMA32A",205,0)
 . I '$D(^XMB("TIMEZONE")) S ^XMB("TIMEZONE")=$P(^XMB(1,1,0),U,2)
"RTN","XMA32A",206,0)
 . S XMMT=$P(^XMB(4.4,$O(^XMB(4.4,"B",^XMB("TIMEZONE"),0)),0),U,3)*100
"RTN","XMA32A",207,0)
 I XMYT=^XMB("TIMEZONE")!(+XMYT=XMMT) S (XMHH,XMMM)=0 Q
"RTN","XMA32A",208,0)
 I XMYT?3A D  I XMYT="" S XMHH=-1 Q
"RTN","XMA32A",209,0)
 . S XMYT=$P($G(^XMB(4.4,+$O(^XMB(4.4,"B",XMYT,0)),0)),U,3)*100
"RTN","XMA32A",210,0)
 S XMTD=XMMT-XMYT
"RTN","XMA32A",211,0)
 S XMHH=XMTD\100
"RTN","XMA32A",212,0)
 S XMMM=XMTD-(XMHH*100)
"RTN","XMA32A",213,0)
 Q
"RTN","XMA32A",214,0)
 ; Also, remember, FM will not handle a 1-digit year
"RTN","XMA32A",215,0)
 ; If this becomes a problem:
"RTN","XMA32A",216,0)
 I $L($P(X," ",3))=1 S $P(X," ",3)="0"_$P(X," ",3)
"RTN","XMA32A",217,0)
 ; *****************************************************
"RTN","XMDIR1")
0^2^B23347452
"RTN","XMDIR1",1,0)
XMDIR1 ;(WASH ISC)/CAP- LOAD... VACO DIRECTORIES ;01/28/98  06:48
"RTN","XMDIR1",2,0)
 ;;7.1;MailMan;**27,55**;Jun 02, 1994
"RTN","XMDIR1",3,0)
 Q
"RTN","XMDIR1",4,0)
ENT ;Batch Entry point (TaskMan)
"RTN","XMDIR1",5,0)
 K ZTREQ,^TMP("XMDIR1",$J) S XMA=0
"RTN","XMDIR1",6,0)
 ;
"RTN","XMDIR1",7,0)
 ;LOCK to indicate to XMA5 that MailLink in being updated
"RTN","XMDIR1",8,0)
 L +^XMD("XMDIR1"):1 E  G RES:$D(ZTQUEUED) W !!,*7,"<<< This task seems to be running already !",!,"(It cannot be run multiple times concurrently.) >>>" G Q
"RTN","XMDIR1",9,0)
 ;
"RTN","XMDIR1",10,0)
 U IO(0) S XMDIR1A("CODE")=$S($G(XMDIR1A)=1:"1A",1:"1B")
"RTN","XMDIR1",11,0)
 I '$D(ZTQUEUED) W !!,"Killing off old AUTOMATIC entries for this code ("_XMDIR1A("CODE")_").",!!
"RTN","XMDIR1",12,0)
 N DIK
"RTN","XMDIR1",13,0)
 S DA=0,DIK="^XMD(4.2997,"
"RTN","XMDIR1",14,0)
 F XMA0=1:1 S DA=$O(^XMD(4.2997,"E",XMDIR1A("CODE"),DA)) Q:+DA'=DA  D ^DIK I '$D(ZTQUEUED),XMA0#10=0 W "."
"RTN","XMDIR1",15,0)
 ;
"RTN","XMDIR1",16,0)
 ;Kill off very old manual entries that haven't been used
"RTN","XMDIR1",17,0)
 S DA=0,XMDIR1=$E(DT,1,5)-200,XMDIR1("CNT")=0
"RTN","XMDIR1",18,0)
 F XMA0=XMA0:1 S DA=$O(^XMD(4.2997,"AC",DA)) Q:$S(DA>XMDIR1:1,DA="":1,1:0)  D ^DIK I '$D(ZTQUEUED),XMA0#10=0 W "."
"RTN","XMDIR1",19,0)
 ;
"RTN","XMDIR1",20,0)
 I '$D(ZTQUEUED) W !!,"Starting load",!!
"RTN","XMDIR1",21,0)
 U IO
"RTN","XMDIR1",22,0)
 ;Load WANG directory
"RTN","XMDIR1",23,0)
 I $G(XMDIR1A("CODE"))="1A" D ^XMDIR1A
"RTN","XMDIR1",24,0)
 ;
"RTN","XMDIR1",25,0)
 ;Load NOAVA directory
"RTN","XMDIR1",26,0)
 I $G(XMDIR1A("CODE"))="1B" D ^XMDIR1B
"RTN","XMDIR1",27,0)
 ;
"RTN","XMDIR1",28,0)
 K XMDIR1A,XMDIR1B
"RTN","XMDIR1",29,0)
 I '$D(ZTQUEUED) W !!!,"Task Completed"
"RTN","XMDIR1",30,0)
 ;
"RTN","XMDIR1",31,0)
 S ^TMP("XMDIR1",$J,.0001)="Remote Directories summary:"
"RTN","XMDIR1",32,0)
 S ^TMP("XMDIR1",$J,.0002)=""
"RTN","XMDIR1",33,0)
 I $D(XMDIR1("W")) S ^TMP("XMDIR1",$J,.0003)=XMDIR1("W")_" Wang system records processed."
"RTN","XMDIR1",34,0)
 I $D(XMDIR1("N")) S ^TMP("XMDIR1",$J,.0003)=XMDIR1("N")_" NOAVA system records processed."
"RTN","XMDIR1",35,0)
 S XMSUB="REMOTE DIRECTORY AUTOMATIC UPDATE",XMTEXT="^TMP(""XMDIR1"",$J,"
"RTN","XMDIR1",36,0)
 N XMDUZ S XMDUZ="|XMDIR1_REMOTE_DIRECTORY_UPDATE|",XMY("G.POSTMASTER@"_^XMB("NETNAME"))=""
"RTN","XMDIR1",37,0)
 I $D(DUZ) S XMY(DUZ)=""
"RTN","XMDIR1",38,0)
 I $O(XMY(0))="" S XMY(.5)=""
"RTN","XMDIR1",39,0)
 D ^XMD K A
"RTN","XMDIR1",40,0)
Q L -^XMD("XMDIR1") K ^TMP("XMDIR1",$J)
"RTN","XMDIR1",41,0)
 Q
"RTN","XMDIR1",42,0)
 ;
"RTN","XMDIR1",43,0)
 ;Menu option to schedule task
"RTN","XMDIR1",44,0)
OPTION G ENT:$D(ZTQUEUED)
"RTN","XMDIR1",45,0)
 N %,%0,%1,%6,D,DA,I,J,X,Y,XMA0,XMB0,XMC0,XMDUZ,XMDIR1,XMSUB,XMY,XMTEXT
"RTN","XMDIR1",46,0)
 W !!,"You are about to load a file containing a list of names and"
"RTN","XMDIR1",47,0)
 W !,"addresses into you Remote User Directory (file 4.2997).  This"
"RTN","XMDIR1",48,0)
 W !,"file originated either from a NOAVA system or a WANG system."
"RTN","XMDIR1",49,0)
 W !,"Choose the correct file.  We will check it some for format.",!!
"RTN","XMDIR1",50,0)
 S %ZIS("S")="I $P($G(^(""TYPE"")),U)[""HFS"""
"RTN","XMDIR1",51,0)
 S %ZIS("A")="Enter either HFS-WANG-DIR or HFS-NOAVA-DIR: "
"RTN","XMDIR1",52,0)
 S %ZIS("B")="HFS-NOAVA-DIR"
"RTN","XMDIR1",53,0)
 S %ZIS="Q" D ^%ZIS Q:POP
"RTN","XMDIR1",54,0)
 S XMF=IO,XMDIR1A=$S(ION="HFS-NOAVA-DIR":2,1:1)
"RTN","XMDIR1",55,0)
 R !!,"Do you want your job queued? (Answer YES or NO)  NO// ",X:DTIME
"RTN","XMDIR1",56,0)
 K D S:X="" X="NO" S X=$TR(X,"noyes","NOYES") I $E("YES",1,$L(X))=X S D=1
"RTN","XMDIR1",57,0)
 W !!,"Before the update occurs entries older than 90 days in the directory"
"RTN","XMDIR1",58,0)
 W !,"are deleted if they were automatically filed by this procedure."
"RTN","XMDIR1",59,0)
 W !,"Manually entered entries are deleted if they haven't been used"
"RTN","XMDIR1",60,0)
 W !,"for at least 2 years."
"RTN","XMDIR1",61,0)
 W !!,"Users are informed that an update is occuring if they are using"
"RTN","XMDIR1",62,0)
 W !,"MailLink help options.  But are allowed to continue.",!!
"RTN","XMDIR1",63,0)
 R !!,"Are you sure you want to do this (Answer 'YES/NO'): NO//",X:DTIME
"RTN","XMDIR1",64,0)
 S:X="" X="NO" S X=$TR(X,"noyes","NOYES") I $E("YES",1,$L(X))'=X W !!,"Nothing done.",*7,!! Q
"RTN","XMDIR1",65,0)
 I '$G(D) G INT
"RTN","XMDIR1",66,0)
 D ZTSK W !!,*7,"Task #"_ZTSK_" scheduled.",!!
"RTN","XMDIR1",67,0)
 D ^%ZISC K ZTSK,ZTRTN,ZTDTH,XMDUZ,ZTDESC,IO("Q"),XMDIR1A,XMDIR1B
"RTN","XMDIR1",68,0)
 Q
"RTN","XMDIR1",69,0)
ER ;Display error
"RTN","XMDIR1",70,0)
 S XMDIR1("CNT")=XMDIR1("CNT")+1,^TMP("XMDIR1",$J,XMDIR1("CNT"))=XME_":"_XMY Q
"RTN","XMDIR1",71,0)
ZTSK ;Schedule to run in the evening
"RTN","XMDIR1",72,0)
 S XMDUZ="[XMDIR1_DIRECTORY_CONVERSION]",ZTRTN="ENT^XMDIR1",ZTDTH=+$H_",64800",ZTSAVE("*")="",ZTDESC="Convert MailLink list"
"RTN","XMDIR1",73,0)
 S ZTDTH="" D ^%ZTLOAD Q
"RTN","XMDIR1",74,0)
 ;Job out this process from here
"RTN","XMDIR1",75,0)
JOB S ZTQUEUED=1,U="^",(IO,IO(0))="" D DT^DICRW G XMDIR1
"RTN","XMDIR1",76,0)
 ;Reschedule job to run later
"RTN","XMDIR1",77,0)
RES S ZTREQ=$$HADD^XLFDT($H,,,5)_"^^MailLink Conversion Restart @ "_$H_"^XMZWANG" Q
"RTN","XMDIR1",78,0)
HFSFILE S DIC="^%ZIS(1,",DIC(0)="AZQME",DIC("S")="I $P($G(^%ZIS(1,Y,""TYPE"")),U)[""HFS"""
"RTN","XMDIR1",79,0)
 D ^DIC Q:Y<0
"RTN","XMDIR1",80,0)
 S IOP=X D ^%ZIS Q:POP
"RTN","XMDIR1",81,0)
 S XMF=$P(^%ZIS(1,IOS,0),U,2) Q
"RTN","XMDIR1",82,0)
INT ;Interactive processing begins here
"RTN","XMDIR1",83,0)
 S XMF=$P(^%ZIS(1,IOS,0),U,2)
"RTN","XMDIR1",84,0)
 W !!,"Answer 'YES' if you mean 'YES'.  All other response mean 'NO'."
"RTN","XMDIR1",85,0)
 W !,"The first file to be processed is for the "_XMF_"."
"RTN","XMDIR1",86,0)
 W !,"Enter '^' to skip this portion of the process.",!!
"RTN","XMDIR1",87,0)
 I $$NEWERR^%ZTER N $ETRAP,$ESTACK S $ETRAP=""
"RTN","XMDIR1",88,0)
 S X="NOWANG^XMDIR1B",@^%ZOSF("TRAP")
"RTN","XMDIR1",89,0)
 U IO R Y:1 U IO(0)
"RTN","XMDIR1",90,0)
 W !!,"The following string was read from the first line of "_XMF_"."
"RTN","XMDIR1",91,0)
 W !!,Y,!!,"Is this correct ? NO// " R %:DTIME
"RTN","XMDIR1",92,0)
 S:%="" %="NO" S %=$TR(%,"noyes","NOYES")
"RTN","XMDIR1",93,0)
 I $E("YES",1,$L(%))'=% D ^%ZISC Q
"RTN","XMDIR1",94,0)
 W ! G ENT
"RTN","XMRPCTS0")
0^3^B14041293
"RTN","XMRPCTS0",1,0)
XMRPCTS0 ;(KC-VAMC)/XXX-Send TWIX's to PCTS Host [XMTR] ;01/28/98  08:16
"RTN","XMRPCTS0",2,0)
 ;;7.1;MailMan;**6,12,31,55**;Jun 02, 1994
"RTN","XMRPCTS0",3,0)
 ;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
"RTN","XMRPCTS0",4,0)
 ; Walk through this Domains Transmit Basket and send them.
"RTN","XMRPCTS0",5,0)
 ; If there is an error, record the error message, copy of
"RTN","XMRPCTS0",6,0)
 ; the message, and drop to PCTS Mailgroup.
"RTN","XMRPCTS0",7,0)
 ;-------------------------------------------------------------
"RTN","XMRPCTS0",8,0)
 S %=$$DSP^XMRPCTS("==>Checking for PCTS Messages to Transmit<==")
"RTN","XMRPCTS0",9,0)
 ;Get domain # for the PCTS domain
"RTN","XMRPCTS0",10,0)
 S XMINST=$O(^DIC(4.2,"B","VHA.DMIA",0))
"RTN","XMRPCTS0",11,0)
 S XMK=XMINST+1000,XMDUZ=.5,XMZ=0,U="^" D INIT^XMRPCTSA S XMRPCTS("S")=0
"RTN","XMRPCTS0",12,0)
WALK S %=$$DSP("==>Checking for messages in basket # "_XMK_"<==")
"RTN","XMRPCTS0",13,0)
 S XMZ=$O(^XMB(3.7,.5,2,XMK,1,XMZ)) G EXIT:XMZ<1
"RTN","XMRPCTS0",14,0)
 I '$D(^XMB(3.9,XMZ,0)) D KL^XMA1B G WALK ;Message is Gone?
"RTN","XMRPCTS0",15,0)
 S %=$$DSP("<==MREQ for local "_XMZ) W "MREQ",!,XMZ,!,"PCTS",!,"AMS",!,"TAB",!,XMET,XMCR S %=0
"RTN","XMRPCTS0",16,0)
 ;
"RTN","XMRPCTS0",17,0)
MREQ F I=1:1:3 R X:5 Q:$T
"RTN","XMRPCTS0",18,0)
 I X["MAK1" R X:3 S XMMN=$P(X,XMLF,2) G:X[XMET!(XMMN'=XMZ) EXIT G REM
"RTN","XMRPCTS0",19,0)
 I X["MEND"!(X[XMET) S %=$$DSP("==>MENDing<==") G EXIT
"RTN","XMRPCTS0",20,0)
 S %=%+1 G MREQ:%<3,EXIT
"RTN","XMRPCTS0",21,0)
REM R X:3 S XMMN=$P(X,XMLF,2) G:X[XMET!(XMMN'?1N.N) EXIT
"RTN","XMRPCTS0",22,0)
 S %=$$DSP("==>MAK1 for REMOTE "_XMMN)
"RTN","XMRPCTS0",23,0)
MDTA ;
"RTN","XMRPCTS0",24,0)
 S %=$$DSP("<==MDTA, Now Sending Message #"_XMZ)
"RTN","XMRPCTS0",25,0)
 S ^XMBS(4.2999,XMINST,3)=$H_"^"_XMZ_"^^^^DMI/MM-SSP" ; mailman status
"RTN","XMRPCTS0",26,0)
 W "MDTA",!,XMZ,!,XMMN,!,XMSH S XMLPC=0 ;Here we go!
"RTN","XMRPCTS0",27,0)
 F X=0:0 S X=$O(^XMB(3.9,XMZ,2,X)) Q:X<1  I $D(^(X,0)) S Z=^(0) D  Q:$E(Z,1,6)["NNNN"
"RTN","XMRPCTS0",28,0)
 . N X,Y S X=$C(XMLPC)_Z_XMCR_XMLF X ^%ZOSF("LPC") S XMLPC=Y W Z,!
"RTN","XMRPCTS0",29,0)
 ;S X=$C(XMLPC)_XMLF) X ^%ZOSF("LPC") S XMLPC=Y ;We like that extra lf calculated
"RTN","XMRPCTS0",30,0)
 S XMLPC=$E(XMDH,XMLPC\16+1)_$E(XMDH,XMLPC#16+1) ;The Magic Code
"RTN","XMRPCTS0",31,0)
 W $C(25),XMLPC,XMET,XMCR S %=1 ;Write the checksum
"RTN","XMRPCTS0",32,0)
MAK2 F I=1:1:3 R X:5 Q:$T  ;Look for the status of the one we just sent
"RTN","XMRPCTS0",33,0)
 I X["MAK2" S XMSTAT="Sent-> AMS Msg# "_XMMN R X:3 R X:3 D STAT S XMRPCTS("S")=XMRPCTS("S")+1 G WALK
"RTN","XMRPCTS0",34,0)
 I $E(X["MN") R X:3 R X:3 S XMSTAT="Error: "_$P(X,XMLF,2) D STAT,ERR G WALK
"RTN","XMRPCTS0",35,0)
 S %=%+1 G MAK2:%<3
"RTN","XMRPCTS0",36,0)
 ;
"RTN","XMRPCTS0",37,0)
 S %=$$DSP("==>INVALID RESPONSE from RCVR, Expecting MAK2, Closing up")
"RTN","XMRPCTS0",38,0)
 G EXIT
"RTN","XMRPCTS0",39,0)
 ;
"RTN","XMRPCTS0",40,0)
 Q
"RTN","XMRPCTS0",41,0)
JD() ; Returns today's Julian date
"RTN","XMRPCTS0",42,0)
 N XMDDD,XMHHMM,XMNOW,XMDT
"RTN","XMRPCTS0",43,0)
 S XMNOW=$$NOW^XLFDT
"RTN","XMRPCTS0",44,0)
 S XMDT=$E(XMNOW,1,7)
"RTN","XMRPCTS0",45,0)
 S XMDDD=$$RJ^XLFSTR($$FMDIFF^XLFDT(XMDT,$E(XMDT,1,3)_"0101",1)+1,3,"0")
"RTN","XMRPCTS0",46,0)
 S XMHHMM=$$LJ^XLFSTR($E(XMNOW,9,12),4,"0")
"RTN","XMRPCTS0",47,0)
 Q XMDDD_XMHHMM
"RTN","XMRPCTS0",48,0)
 ;
"RTN","XMRPCTS0",49,0)
DSP(XMTRAN) D TRAN^XMC1
"RTN","XMRPCTS0",50,0)
 Q "" ;Show us what is going on
"RTN","XMRPCTS0",51,0)
 ;
"RTN","XMRPCTS0",52,0)
STAT ;Update the Mailman Status
"RTN","XMRPCTS0",53,0)
 S X=$O(^XMB(3.9,XMZ,1,"C","XXX@"_$P(^DIC(4.2,+XMINST,0),U),0))
"RTN","XMRPCTS0",54,0)
 I X>0 S $P(^XMB(3.9,XMZ,1,X,0),U,5,6)=$$DT_U_XMSTAT
"RTN","XMRPCTS0",55,0)
 S ^XMBS(4.2999,XMINST,3)="" ;Mailman Status
"RTN","XMRPCTS0",56,0)
 D KL^XMA1B ;Remove it from the Domains Basket
"RTN","XMRPCTS0",57,0)
 Q
"RTN","XMRPCTS0",58,0)
ERR N %,X,XMSUB,XMTEXT,XMY,Y
"RTN","XMRPCTS0",59,0)
 S %=$$DSP("==>Recording Rejected Message #"_XMZ_"  "_XMSTAT),XMTEXT="^XMB(3.9,"_XMZ_",2,"
"RTN","XMRPCTS0",60,0)
 N XMZ,DIC,XMDF
"RTN","XMRPCTS0",61,0)
 S XMSUB="PCTS Message Returned "_XMSTAT,XMDF=1
"RTN","XMRPCTS0",62,0)
 S XMY("G.PCTS")="" ; Mail group PCTS must be created on the system
"RTN","XMRPCTS0",63,0)
 S XMY(.5)="" D ^XMD Q  ;Send it to the PostMaster anyway
"RTN","XMRPCTS0",64,0)
 ;
"RTN","XMRPCTS0",65,0)
DT() N X,Y,%DT S %DT="T",X="N" D ^%DT Q (Y)
"RTN","XMRPCTS0",66,0)
EXIT S %=$$DSP("==>Quitting<==")
"RTN","XMRPCTS0",67,0)
 W "MEND",! Q
"RTN","XMRPCTS0",68,0)
RQ ;Force this domain to play it's script, it plays regardless...
"RTN","XMRPCTS0",69,0)
 ;Queue this puppy to run at regular intervals.
"RTN","XMRPCTS0",70,0)
 S:'$D(ZTQUEUED) XM="D" ;For Debugging
"RTN","XMRPCTS0",71,0)
 S ZTREQ="@"
"RTN","XMRPCTS0",72,0)
 S (Y,XMSCR)=$O(^DIC(4.2,"B","VHA.DMIA",0)),XMSCRN="VHA.DMIA",XMDUZ=.5
"RTN","XMRPCTS0",73,0)
 S %=$O(^DIC(4.2,XMSCR,1,0))
"RTN","XMRPCTS0",74,0)
 I %<1 K % S %="No script found!"_% G QQ ;FORCE ERROR FOR DEBUGGING
"RTN","XMRPCTS0",75,0)
 S XMDIC="^DIC(4.2,XMSCR,1,"_%_",1,"
"RTN","XMRPCTS0",76,0)
 I '$D(DT) D NOW^%DTC S DT=X,U="^"
"RTN","XMRPCTS0",77,0)
 S %=$S($D(^XMBS(4.2999,+Y,3))#10:$P(^(3),U,7),1:0)
"RTN","XMRPCTS0",78,0)
 I '%!'$$CHK^XMS5(%,XMSCR) S XMSITE=XMSCRN,XMINST=XMSCR D ^XMC1
"RTN","XMRPCTS0",79,0)
QQ S %=$$DSP("Quitting from sending TWIX's") ;D KL1^XMC
"RTN","XMRPCTS0",80,0)
 L  K DIC,X,Y,XMDT,ZTPAR Q:'$G(XMRPCTS0)  S XMCI=XMRPCTS0 Q
"RTN","XMRTCPGO")
0^4^B3838958
"RTN","XMRTCPGO",1,0)
XMRTCPGO ;(WASH ISC)/THM/CAP-Start XMRTCP ;02/19/98  14:32
"RTN","XMRTCPGO",2,0)
 ;;7.1;MailMan;**8,55**;Jun 02, 1994
"RTN","XMRTCPGO",3,0)
JOB ;Job itself out for TCPQUE.COM to use for polling TCPFLAG'd sites
"RTN","XMRTCPGO",4,0)
 ;
"RTN","XMRTCPGO",5,0)
 ;XMRTCP must have VMS context
"RTN","XMRTCPGO",6,0)
 ;The following code starts job w/o VMS context
"RTN","XMRTCPGO",7,0)
 ;N % S %="MM-TCP-Poller" I $G(XMINST) S ^TMP("XMRTCP",0)=XMINST
"RTN","XMRTCPGO",8,0)
 ;J POLL^XMRTCP:(NAME=%) Q
"RTN","XMRTCPGO",9,0)
 ;
"RTN","XMRTCPGO",10,0)
 ;Start job with VMS CONTEXT
"RTN","XMRTCPGO",11,0)
 G START^XMRTCPGO
"RTN","XMRTCPGO",12,0)
 Q
"RTN","XMRTCPGO",13,0)
START ;Start XMRTCP w/DCL context
"RTN","XMRTCPGO",14,0)
 I $G(XMINST) S ^TMP("XMRTCP",0)=XMINST
"RTN","XMRTCPGO",15,0)
 I ^%ZOSF("OS")["MSM" J POLL^XMRTCP Q
"RTN","XMRTCPGO",16,0)
 D SPN("XMRTCP","POLL^XMRTCP")
"RTN","XMRTCPGO",17,0)
 Q
"RTN","XMRTCPGO",18,0)
 ;Spawn out from VMS / run w/DCL context
"RTN","XMRTCPGO",19,0)
SPN(X,Y) ;X=Filename right-hand side / Y=Entry point
"RTN","XMRTCPGO",20,0)
 D DEL N % S F=X_".COM" O F:NEW U F S F=$ZIO
"RTN","XMRTCPGO",21,0)
 W "$DSM/UCI="_$P($ZU(0),",")_"/ENVIRONMENT="_$$OPTION^%SYSUTL("ENVIRONMENT")_" "_Y,!
"RTN","XMRTCPGO",22,0)
 S %="$run sys$system:loginout/input="_F_"/output=XMRTCP.log/detach/ast=300/buffer=40960/enqueu=300/file=99/io_buf=64/io_dir=64/job_tab=1024/maximum_work=1864/page=10240/queue_lim=10/work=900/subprocess=30/process=MM-TCP-Poller"
"RTN","XMRTCPGO",23,0)
 C F S %=$ZC(%SPAWN,%) I 1
"RTN","XMRTCPGO",24,0)
 Q
"RTN","XMRTCPGO",25,0)
DEL N %,X S X="DELER^XMRTCPGO",@^%ZOSF("TRAP")
"RTN","XMRTCPGO",26,0)
 S %=$ZC(%SPAWN,"DELETE XMRTCP.COM.*")
"RTN","XMRTCPGO",27,0)
 S %=$ZC(%SPAWN,"DELETE XMRTCP.LOG.*")
"RTN","XMRTCPGO",28,0)
DELER Q
"RTN","XMS0")
0^5^B22938679
"RTN","XMS0",1,0)
XMS0 ;(WASH ISC)/THM/CAP-SEND DATA ;01/28/98  13:58
"RTN","XMS0",2,0)
 ;;7.1;MailMan;**13,8,20,23,27,34,55**;Jun 02, 1994
"RTN","XMS0",3,0)
GO ;
"RTN","XMS0",4,0)
 ;If VERSION 3.12 or later of VA MailMan:
"RTN","XMS0",5,0)
 ;  1. Send LOCAL ID of sender
"RTN","XMS0",6,0)
 ;  2. Process reply accordingly
"RTN","XMS0",7,0)
 ;
"RTN","XMS0",8,0)
 ;Send other Body parts
"RTN","XMS0",9,0)
 I $O(^XMB(3.9,XMZ,2005,0)) S XMBLOBER=0 D ^XMS0BLOB I XMBLOBER D RESET^XMS K XMBLOBER Q
"RTN","XMS0",10,0)
 ;
"RTN","XMS0",11,0)
 G Q:'$G(XMVA) I '$D(XMSLOCAL) G CHECK
"RTN","XMS0",12,0)
CONT G A:'$D(^XMB(3.9,XMZ,5)) S %=^(5) I %="" G ENTM^XMSM
"RTN","XMS0",13,0)
 G C:%?1.N.E,C:$P(%,"@")'?.E1".VA.GOV" S %=$P(%,"@",2)_"@"_$P(%,"@") G C
"RTN","XMS0",14,0)
A S %=$S($L($G(^XMB(3.9,XMZ,5))):^(5),1:XMZ_"@"_^XMB("NETNAME"))
"RTN","XMS0",15,0)
C S XMSG="MESS ID:"_% X XMSEN Q:ER  X XMREC Q:ER  G H:$E(XMRG,1,4)'="RSET"
"RTN","XMS0",16,0)
 S XMRZ=$P(XMRG,":",2),XMBT=0,XMSBT=$H*86400+$P($H,",",2),XMSG="DATA" X XMSEN Q:ER
"RTN","XMS0",17,0)
 I 'XMBT X XMREC Q:ER
"RTN","XMS0",18,0)
 S XMSG="" X XMSEN Q:ER
"RTN","XMS0",19,0)
 G D2^XMS0A
"RTN","XMS0",20,0)
 ;
"RTN","XMS0",21,0)
 ;SPECIAL MESSAGE CHARACTERISTICS
"RTN","XMS0",22,0)
H G Q:$G(XMR)="",Q:XMR=0
"RTN","XMS0",23,0)
 F J=6,7 D I:$P(XMR,U,J)'="" Q:ER
"RTN","XMS0",24,0)
 F J=5,9,11,12 D I:"Yy"[$E($P(XMR,U,J)_" ") Q:ER
"RTN","XMS0",25,0)
 Q:ER  G Q
"RTN","XMS0",26,0)
 ;
"RTN","XMS0",27,0)
I S ER=0,XMSG="MESS "_$P("^^^^CONFIRMATION^PRIORITY^TYPE^^CLOSED^^CONFIDENTIAL^INFO",U,J)_":"_$P(XMR,U,J)
"RTN","XMS0",28,0)
 X XMSEN Q:ER  X XMREC
"RTN","XMS0",29,0)
 Q
"RTN","XMS0",30,0)
Q G ^XMS0A
"RTN","XMS0",31,0)
 ;
"RTN","XMS0",32,0)
TURN ;TURN AROUND CHANNEL
"RTN","XMS0",33,0)
 K XMBLOCK,XMFROM,XMR,XMBCK
"RTN","XMS0",34,0)
 I $G(XMSDOM) S XMINST=XMSDOM
"RTN","XMS0",35,0)
 G Q:'$D(XMINST),Q:'$L(XMINST)
"RTN","XMS0",36,0)
 G QUIT:'($D(^XMBS(4.2999,XMINST,3))#10) S $P(^(3),U,1,6)="^^^^^"
"RTN","XMS0",37,0)
 S X=$P(^DIC(4.2,XMINST,0),U,16)
"RTN","XMS0",38,0)
 I $F("Yy",X)<2,'XMBT S XMSG="TURN" X XMSEN Q:ER  X XMREC Q:ER  I $E(XMRG)="2" S XMTRAN="Turning around receiver" D TRAN^XMC1 G INT^XMR
"RTN","XMS0",39,0)
 G QUIT
"RTN","XMS0",40,0)
ZTSK0 N XMDT,ZTSK S XMDT=ZTDTH D ZTSK0^XMBPOST
"RTN","XMS0",41,0)
 Q
"RTN","XMS0",42,0)
ZTSK ;TASK MANAGER COMES HERE TO SEND MESSAGE
"RTN","XMS0",43,0)
 K XMRDOM,XMSDOM
"RTN","XMS0",44,0)
 ;I $L(ION) S IOP=ION D ^%ZIS G REQ:POP S ZTIO(1)="D",ZTIO=ION D REQ^%ZTLOAD
"RTN","XMS0",45,0)
 S XM="",(XMINST,XMSCR)=XMB("XMSCR"),XMSCRN=XMB("XMSCRN"),XMZ=0
"RTN","XMS0",46,0)
 ;
"RTN","XMS0",47,0)
 ;Use correct script
"RTN","XMS0",48,0)
 S %=$G(XMB("SCRIPT",0))
"RTN","XMS0",49,0)
 S XMDIC="^DIC(4.2,XMSCR,1,"_$S(%:%,1:1)_",1,"
"RTN","XMS0",50,0)
 ;
"RTN","XMS0",51,0)
 S $P(^XMBS(4.2999,XMSCR,3),U,7)=ZTSK
"RTN","XMS0",52,0)
 I ZTSK'=$P(^XMBS(4.2999,XMSCR,0),U,2) N J S J=$P(^XMBS(4.2999,XMSCR,0),U,2) I J Q:$$CHK^XMS5(J,XMSCR)
"RTN","XMS0",53,0)
 I $D(XMB("XMIO")),XMIO="" S XMIO=XMB("XMIO")
"RTN","XMS0",54,0)
 D NEXT G:'$D(XMPOLL) KILL^XMB:XMZ'>0 ;DON'T PROCESS IF NOTHING IN QUEUE
"RTN","XMS0",55,0)
 I $D(XMB("SCRIPT")),$G(XMB("TRIES"))'<$P(XMB("SCRIPT"),U,3) S XMS0C=1
"RTN","XMS0",56,0)
 D ENT^XMC1 I $G(XMER) G:$G(XMPOLL)'="NOREQUE" REQ
"RTN","XMS0",57,0)
 G KILL^XMB:'$O(^XMB(3.7,.5,2,XMINST+1000,1,0))
"RTN","XMS0",58,0)
 G:$G(XMPOLL)'="NOREQUE" REQ
"RTN","XMS0",59,0)
 Q
"RTN","XMS0",60,0)
NEXT ;GET NEXT MESSAGE IN QUEUE
"RTN","XMS0",61,0)
 I $G(XMSDOM) S XMINST=XMSDOM
"RTN","XMS0",62,0)
 S I=$O(^XMB(3.7,.5,2,"AC",1,XMINST+1000,0))
"RTN","XMS0",63,0)
 I I,'$D(^XMB(3.7,.5,2,XMINST+1000,1,I)) K ^XMB(3.7,.5,2,"AC",1,XMINST+1000,I) S I="" G NEXT
"RTN","XMS0",64,0)
 S XMZ=$S(I:I,1:$O(^XMB(3.7,.5,2,XMINST+1000,1,XMZ))) G KILL^XMB:+XMZ=0
"RTN","XMS0",65,0)
 Q:$D(^XMB(3.9,XMZ,0))
"RTN","XMS0",66,0)
 S (XMKD,XMK)=XMINST+1000 D KL^XMA1B K XMKD G NEXT
"RTN","XMS0",67,0)
POST ;APPLY POSTAGE
"RTN","XMS0",68,0)
 Q:XMPOST=0
"RTN","XMS0",69,0)
 ;Set Postage here
"RTN","XMS0",70,0)
 Q
"RTN","XMS0",71,0)
REQ I '$D(ZTSK) G KILL^XMB
"RTN","XMS0",72,0)
 D KILL^%ZTLOAD
"RTN","XMS0",73,0)
 I '$D(XMB("TRIES")) S XMB("TRIES")=1
"RTN","XMS0",74,0)
 S XMB("TRIES",XMB("TRIES"))=$S($L($G(XMERMSG)):XMERMSG_" : ",1:"")_$S($D(XMB(4)):$E(XMB(4),1,245-$L($G(XMERMSG))),1:"UNKNOWN")
"RTN","XMS0",75,0)
 S ZTDTH=$$HADD^XLFDT($H,,,,$S(XMB("TRIES")<4:300*XMB("TRIES"),1:600+$R(600)))
"RTN","XMS0",76,0)
 I $P($G(XMB("SCRIPT")),U,8)#$S($G(^XMB(1,1,"NETWORK")):^XMB(1,1,"NETWORK"),1:10)=0 D ENTE^XMSM
"RTN","XMS0",77,0)
 I $G(XMSDOM) S XMINST=XMSDOM K XMSDOM D ZTSK0 I $D(XMSITE) S XMTRAN=$S(XMSITE="":XMSCRN,1:XMSITE)_" Requeued" G TRAN^XMC1
"RTN","XMS0",78,0)
 S ZTREQ="" Q
"RTN","XMS0",79,0)
QUIT S XMSG="QUIT" X XMSEN Q:ER  X XMREC Q
"RTN","XMS0",80,0)
DATANO ;
"RTN","XMS0",81,0)
 I +XMRG=554 G R ;No Bulletin if 554 reject (duplicate)
"RTN","XMS0",82,0)
 I +XMRG=551 S XMRZ="Rejected - TOO LONG !" D ENT^XMSM1 G R
"RTN","XMS0",83,0)
 ;
"RTN","XMS0",84,0)
 ;BULLETIN - INTERFERES WITH PROPER SETTING OF RECIPIENT CHAIN STATUSES
"RTN","XMS0",85,0)
 ;
"RTN","XMS0",86,0)
ER S XMB="XMDATANO",XMB(1)=$P(^DIC(4.2,XMINST,0),U),XMB(2)=$P(^XMB(3.9,XMZ,0),U)_" ["_XMZ_"]"_$S($G(XMY)'="":"Recipient: "_XMY,1:""),XMB(3)=XMRG
"RTN","XMS0",87,0)
 S XMZHOLD=XMZ D TRASH^XMS,^XMB S XMZ=XMZHOLD K XMZHOLD
"RTN","XMS0",88,0)
R S XMTRAN=XMRG D TRAN^XMC1 G RESET^XMS
"RTN","XMS0",89,0)
 ;
"RTN","XMS0",90,0)
CHECK ;IF REMOTE SYSTEM CANNOT PASS MESSAGE QUALIFIERS
"RTN","XMS0",91,0)
 ;
"RTN","XMS0",92,0)
 I '$D(XMR) S XMR=^XMB(3.9,XMZ,0)
"RTN","XMS0",93,0)
 F I=5,9,11,12 I "Yy"[$E($P(XMR,U,I)_" ") G CQ
"RTN","XMS0",94,0)
 F I=6 I $P(XMR,U,I)'="" G CQ
"RTN","XMS0",95,0)
 G CONT:$D(XMSLOCAL),Q
"RTN","XMS0",96,0)
CQ S XMRG="Unable to accept messages with "_$P("^^^^CONFIRMATION REQUEST^PRIORITY^TYPE^^CLOSED status^^CONFIDENTIAL status^INFO status",U,I)_"."
"RTN","XMS0",97,0)
 S I=0 K XMY,XMY0,^TMP("XMY",$J),^TMP("XMY0",$J) D S G ER
"RTN","XMS0",98,0)
 ;
"RTN","XMS0",99,0)
S F I=0:0 S I=$O(XMJ(I)) Q:'I  D T K XMJ(I)
"RTN","XMS0",100,0)
 Q
"RTN","XMS0",101,0)
T Q:'$D(^XMB(3.9,XMZ,1,I,0))  N % S $P(^(0),U,6,7)=XMRG_U,%=$S('$D(^("F")):"",$L($P(^("F"),U,2)):$P(^("F"),U,2),1:"") I $L(%),%'["@",$O(^TMP("XMY",$J,""))="" S ^TMP("XMY",$J,%)=""
"RTN","XMS0",102,0)
 Q:$O(^TMP("XMY",$J,""))'=""  S X=$P(XMR,U,2) I +X=X S ^TMP("XMY",$J,X)=""
"RTN","XMS0",103,0)
 E  D WHOXM^XMA21
"RTN","XMS0",104,0)
 Q
"RTN","XMS0A")
0^6^B14345792
"RTN","XMS0A",1,0)
XMS0A ;(WASH ISC)/THM/CAP-DATA (CONT) ;01/28/98  08:08
"RTN","XMS0A",2,0)
 ;;7.1;MailMan;**2,13,55**;Jun 02, 1994
"RTN","XMS0A",3,0)
DATA ;SEND BODY OF TEXT
"RTN","XMS0A",4,0)
 S XMSG="DATA" X XMSEN Q:ER
"RTN","XMS0A",5,0)
 I 'XMBT X XMREC Q:ER
"RTN","XMS0A",6,0)
 S:XMBT XMRG=300 S XMSBT=$H*86400+$P($H,",",2)
"RTN","XMS0A",7,0)
 I $E(XMRG)'=3 G DATANO^XMSERR
"RTN","XMS0A",8,0)
 S XMR=^XMB(3.9,XMZ,0) I $D(^(2,.001)) G D6
"RTN","XMS0A",9,0)
 S XMSUB="Subject:"_$P(XMR,U)
"RTN","XMS0A",10,0)
 S XMSG=XMSUB X XMSEN Q:ER
"RTN","XMS0A",11,0)
 ; Convert "Jun 28, 1955@10:10" to "28 Jun 1955 10:10"
"RTN","XMS0A",12,0)
 S X=$$FMTE^XLFDT($P(XMR,U,3),1)
"RTN","XMS0A",13,0)
 S Y=+$P(X," ",2)_" "_$P(X," ",1)_" "_+$P(X," ",3)_" "_$S(X["@":$E($P(X,"@",2),1,5),1:"00:00")
"RTN","XMS0A",14,0)
 S XMSG="Date:"_Y_" "_$G(^XMB("TIMEZONE"))
"RTN","XMS0A",15,0)
 X XMSEN Q:ER
"RTN","XMS0A",16,0)
 S XMSG="Message-ID:<"_$S($L($G(^XMB(3.9,XMZ,5))):^(5),1:XMZ_"@"_^XMB("NAME"))_">" X XMSEN Q:ER
"RTN","XMS0A",17,0)
 I $D(^XMB(3.9,XMZ,"IN")) S J=^("IN") S:$S('+$E(J):1,$P(J,"@")[".VA.GOV":1,1:0) J=$P(J,"@",2)_"@"_$P(J,"@") S XMSG="In-reply-to:<"_J_">" X XMSEN Q:ER
"RTN","XMS0A",18,0)
 I $D(^XMB(3.9,XMZ,"K")) S XMSG="Encrypted:"_$P(XMR,U,10)_U_^("K") X XMSEN Q:ER
"RTN","XMS0A",19,0)
 S X1=$P(XMR,U,4) I X1'="" S XMS0A=1 D USER^XMA K XMS0A S XMSG="Sender:<"_X1_"@"_^XMB("NAME")_">" X XMSEN Q:ER
"RTN","XMS0A",20,0)
 S XMSG="From:"_XMFROM X XMSEN Q:ER
"RTN","XMS0A",21,0)
 S J=0,J(0)=0,J("N")=^XMB("NETNAME"),XMSG=""
"RTN","XMS0A",22,0)
 F J=0:0 S J=$O(^XMB(3.9,XMZ,6,J)) G D5:+J'=J S I=$P(^(J,0),U) D D4,SEND:$L(XMSG)>80 G Q:ER I J(0)>50 S XMSG="(Too many recipients to list...)" X XMSEN G Q:ER G D5
"RTN","XMS0A",23,0)
D4 S J(0)=J(0)+1 I XMSG="" S XMSG=$S(J(0)=1:"To: ",1:"    ")
"RTN","XMS0A",24,0)
 S:$P(I,"@")["," I=$TR($P(I,"@"),", .","._+")_"@"_$S($P(I,"@",2)'="":$P(I,"@",2),1:J("N"))
"RTN","XMS0A",25,0)
 I I'["@" S I=I_"@"_J("N")
"RTN","XMS0A",26,0)
D S XMSG=XMSG_$S(J(0)>1&(XMSG'?1." "):", ",1:"")_I
"RTN","XMS0A",27,0)
 Q
"RTN","XMS0A",28,0)
SEND S:+$O(^XMB(3.9,XMZ,1,J))>0 XMSG=XMSG_"," X XMSEN S XMSG=""
"RTN","XMS0A",29,0)
 Q
"RTN","XMS0A",30,0)
D5 ;START TRANSMISSION OF HEADER/BODY OF TEXT
"RTN","XMS0A",31,0)
 ;
"RTN","XMS0A",32,0)
 ;1st send last line in the "To list"
"RTN","XMS0A",33,0)
 I $L(XMSG)>9 X XMSEN
"RTN","XMS0A",34,0)
 K J S XMSG="" X XMSEN Q:ER
"RTN","XMS0A",35,0)
D6 S XMBLOCK=1,(XMS0AJ,J,I)=0 D D1 K XMS0AJ Q:ER  G D2
"RTN","XMS0A",36,0)
D1 S XMS0AJ=$O(^XMB(3.9,XMZ,2,XMS0AJ)) Q:+XMS0AJ'>0  S XMSG=^(XMS0AJ,0),I=I+1,J=J+1
"RTN","XMS0A",37,0)
 I $E(XMSG)="." S XMSG="."_XMSG
"RTN","XMS0A",38,0)
 I $E(XMSG,1,4)="~*~^" S XMSG=" "_XMSG
"RTN","XMS0A",39,0)
 X XMSEN
"RTN","XMS0A",40,0)
 I ER S XMB(4)=$S($D(XMCHAN):XMCHAN_":  ",1:"")_"Message "_XMZ_", Node "_XMS0AJ Q
"RTN","XMS0A",41,0)
 G D1
"RTN","XMS0A",42,0)
D2 ;SET POSTAGE ?? HERE
"RTN","XMS0A",43,0)
 I $D(XMBLOCK) D KILL^XML4CRC
"RTN","XMS0A",44,0)
 S XMSG=".",XMCJ=0 X XMSEN I 'XMBT S XMSTIME=300 X XMREC K XMSTIME Q:ER
"RTN","XMS0A",45,0)
 S:XMBT XMRG="250 OK" I $E(XMRG)'=2 D DATANO^XMS0
"RTN","XMS0A",46,0)
D2X S XMCNT("S")=$S($D(XMCNT("S")):XMCNT("S"),1:0)+1
"RTN","XMS0A",47,0)
 F XMCJ=0:0 S XMCJ=$O(XMJ(XMCJ)) Q:XMCJ=""  D D3
"RTN","XMS0A",48,0)
 S X=$G(^XMBS(4.2999,XMINST,0)) I X="" S X=XMINST,^XMBS(4.2999,"B",X,X)=""
"RTN","XMS0A",49,0)
 S $P(X,U,5)=$P(X,U,5)+1,Y(0)=$P($G(^XMB(3.9,XMZ,2,0)),U,3),^XMBS(4.2999,XMINST,0)=X S Y=$P($G(^(3)),U,9) I Y S $P(^(3),U,9)=0
"RTN","XMS0A",50,0)
 S:Y<1 Y=200 D STATS
"RTN","XMS0A",51,0)
 K XMLCT G TRASH^XMS ; POSTAGE WOULD GO HERE
"RTN","XMS0A",52,0)
D3 Q:XMJ(XMCJ)'=""
"RTN","XMS0A",53,0)
 S X=^XMB(3.9,XMZ,1,XMCJ,0),X=$P(X_"^^^",U,1,3)_U_XMRZ_U_XMD_U_U_$P(X,U,7)_":"_$G(XMSDOM)_U_($H*86400+$P($H,",",2)-XMSBT) S:XMBT $P(X,U,6)="In transit" S ^(0)=X
"RTN","XMS0A",54,0)
 K ^XMB(3.9,XMZ,1,"AQUEUE",XMINST,XMCJ)
"RTN","XMS0A",55,0)
Q Q
"RTN","XMS0A",56,0)
STATS S %=1 G STAT
"RTN","XMS0A",57,0)
STATR S %=2
"RTN","XMS0A",58,0)
STAT ;UPDATE MONTHLY STATS [%=1 (SENT) OR 2 (REC'D), Y=#CHARS, Y(0)=#LINES]
"RTN","XMS0A",59,0)
 S I=$E(DT,1,5),X=$S($D(^XMBS(4.2999,XMINST,100,I,0)):^(0),1:"") I X'="" S $P(X,U,1+%)=$P(X,U,1+%)+1,$P(X,U,3+%)=$P(X,U,3+%)+Y,$P(X,U,5+%)=$P(X,U,5+%)+Y(0),^(0)=X Q
"RTN","XMS0A",60,0)
 S %0=I_"00",^XMBS(4.2999,XMINST,100,0)="^4.25D^"_%0_"^1",$P(%0,U,1+%)=1,$P(%0,U,3+%)=Y,$P(%0,U,5+%)=Y(0),^(I,0)=%0,^XMBS(4.2999,XMINST,100,"B",+%0,I)="" Q
"RTN","XMS0A",61,0)
 K I,X,Y,% Q
"RTN","XMS0A",62,0)
LOCKER S XMTRAN="Queue being delivered by another Job - Aborting transmission !" D TRAN^XMC1 Q
"RTN","XMS5")
0^8^B27972276
"RTN","XMS5",1,0)
XMS5 ;(WASH ISC)/CAP/RM/AML-DISPLAY/TRANSMIT QUEUES ;01/28/98  10:59
"RTN","XMS5",2,0)
 ;;7.1;MailMan;**13,8,23,27,55**;Jun 02, 1994
"RTN","XMS5",3,0)
 ;ACTIVE
"RTN","XMS5",4,0)
ENT N XMDUZ K XMA
"RTN","XMS5",5,0)
 F Z=999:0 S Z=$O(^XMB(3.7,.5,2,Z)) Q:+Z'=Z  Q:Z>9999  I $P($G(^(Z,0)),U,5)>0  S XMK=Z,XMDUZ=.5 W:'$D(ZTQUEUED) "." S %=$$REN^XMA03(.5,Z)
"RTN","XMS5",6,0)
ENT1 S XMLROU="ZTSK^XMS5",ZTSAVE("XMA")=""
"RTN","XMS5",7,0)
 D ENT^XMA30 I POP K POP,ZTSAVE Q
"RTN","XMS5",8,0)
ZTSK K DIR S XMB0="",(XME0,XMD0)=0,DIR(0)="E",XM="D"
"RTN","XMS5",9,0)
 D NOW^%DTC K %I,%H S A=$E(%,6,7)_" "_$P("Jan^Feb^Mar^Apr^May^Jun^Jul^Aug^Sep^Oct^Nov^Dec",U,$E(%,4,5))_" "_$E(%,2,3)
"RTN","XMS5",10,0)
 I %\1'=% S %=$P(%,".",2)_"0000",A=A_" "_$E(%,1,2)_":"_$E(%,3,4)
"RTN","XMS5",11,0)
 S XMC0=A,XMC0("D")=0,XMC0("M")=0
"RTN","XMS5",12,0)
Q S XMB0=$O(^DIC(4.2,"B",$P(XMB0,U))) G END:XMB0="" S K=$O(^(XMB0,0))+1000 I $D(XMA) S XMB=$G(^XMBS(4.2999,K-1000,3)) G Q:XMB="" S X=$P(XMB,U),Y=$$HDIFF^XLFDT($H,X,2) G Q:Y>599
"RTN","XMS5",13,0)
 S XMF0="",J=$S($D(^XMB(3.7,.5,2,K,0)):$P(^(0),U,5),1:0)
"RTN","XMS5",14,0)
 G:'$D(XMA) Q:J<1 S XMG0=J
"RTN","XMS5",15,0)
 I '$D(XMA) S $P(XMB,U,6)=$P(^DIC(4.2,K-1000,0),U,17) G W
"RTN","XMS5",16,0)
 G Q:$P(XMB,U,1,6)?.P S %H=$P(XMB,U) D YMD^%DTC
"RTN","XMS5",17,0)
 G W:$D(XMA) S %=$P(%H,",",2),%=%#3600\60/100+(%\3600)/100
"RTN","XMS5",18,0)
 S XMF0=$E(X,4,5)_"/"_$E(X,6,7)_"/"_$E(X,2,3) I % S XMF0=XMF0_" @ "_%
"RTN","XMS5",19,0)
W I XME0 G X:XMD0+5'>IOSL
"RTN","XMS5",20,0)
 I '$D(ZTQUEUED),IOST?1"C-".E I XME0 U IO(0) D ^DIR K DIRUT G END:X["^" U IO
"RTN","XMS5",21,0)
 D HD
"RTN","XMS5",22,0)
X S XMD0=XMD0+1,XMC0("D")=XMC0("D")+1 W !,$E($P(XMB0,U),1,18) G:$D(XMA) Q:'$D(XMB)
"RTN","XMS5",23,0)
 W ?19,$J(XMG0,4),?27,$P(XMB,U,6)
"RTN","XMS5",24,0)
 G M:'$D(XMA) I Y>180 S XMD0=XMD0+2 W ?42," == Appears Inactive - ",Y\60," Minutes",!,?42," == Analysis of device indicated." G M
"RTN","XMS5",25,0)
 I $P(XMB,U,4)<0 S $P(XMB,U,4)=""
"RTN","XMS5",26,0)
 I '$P(XMB,U,2) W ?44,"Connecting/Disconnecting"
"RTN","XMS5",27,0)
 E  W ?44,$P(XMB,U,2),?52," ",$P(XMB,U,3),?58," ",$P(XMB,U,7),?63,$J($P(XMB,U,4),6),?70,$J($P(XMB,U,5),8)
"RTN","XMS5",28,0)
M S XMC0("M")=XMC0("M")+XMG0 G Q
"RTN","XMS5",29,0)
HD S XMD0=5,XME0=XME0+1 W @IOF,!
"RTN","XMS5",30,0)
 I '$D(XMA) W "QUEUES WITH MESSAGES TO GO OUT"
"RTN","XMS5",31,0)
 E  W "QUEUES ACTIVELY TRANSMITTING MESSAGES"
"RTN","XMS5",32,0)
 W ?79-$L(XMC0),XMC0,!,"At "_^XMB("NETNAME"),?71,"Page: ",XME0,!
"RTN","XMS5",33,0)
 W !,"Domain",?16,"# Que'd" I '$D(XMA) W "    Physical Link"
"RTN","XMS5",34,0)
 I $D(XMA) W ?21,"  Device/Protocol",?44,"Msg #",?51,"Line  ZTSK  Errors  Rate C/S"
"RTN","XMS5",35,0)
 W ! Q
"RTN","XMS5",36,0)
END I 'XME0 D HD:IOST'?1"C".E W !,"No messages ",$P("queued^actively transmitting",U,$D(XMA)+1),!
"RTN","XMS5",37,0)
 E  W !!,"Total Domains: ",XMC0("D"),", Total Messages Queued: ",XMC0("M"),!!,"<<< END OF REPORT >>>"
"RTN","XMS5",38,0)
 K %,%H,%I,DIR,I,XMC0,K,XMB0,XMD0,XME0,XMF0,XMG0
"RTN","XMS5",39,0)
 I $D(IO(0)),IO(0)'=IO W @IOF
"RTN","XMS5",40,0)
 I $D(ZTQUEUED),$L(ZTSK) S ZTREQ="@" W @IOF Q
"RTN","XMS5",41,0)
 D ^%ZISC
"RTN","XMS5",42,0)
 Q
"RTN","XMS5",43,0)
GO ;DSP ALL
"RTN","XMS5",44,0)
 S XMA=1 G ENT1
"RTN","XMS5",45,0)
 ;;n/a;
"RTN","XMS5",46,0)
 ;
"RTN","XMS5",47,0)
TASK ;
"RTN","XMS5",48,0)
REQUE ;
"RTN","XMS5",49,0)
 K ^TMP($J,"ZTMKZ") S %=$G(XMDUZ)
"RTN","XMS5",50,0)
 N DIR,DIRUT,DTOUT,DUOUT,I,J,K,X,XMDUZ,Y,ZTD,ZTI,ZTQ,ZTS
"RTN","XMS5",51,0)
 S XMDUZ=$S($G(%):%,1:DUZ)
"RTN","XMS5",52,0)
 S I=999 F  D  Q:I=""
"RTN","XMS5",53,0)
 . S I=$O(^XMB(3.7,.5,2,I)) I $S(I'=+I:1,I>9999:1,I<1001:1,1:0) S I="" Q
"RTN","XMS5",54,0)
 . W:'$D(ZTQUEUED) "." I $O(^XMB(3.7,.5,2,I,1,0)) S K=I-1000 D
"RTN","XMS5",55,0)
 . . S J=$P($G(^XMBS(4.2999,K,0)),U,2) S:J J=$$CHK(J,K) I 'J S ^TMP($J,"ZTMKZ",$P(^DIC(4.2,K,0),U))=K
"RTN","XMS5",56,0)
 . Q
"RTN","XMS5",57,0)
 ;
"RTN","XMS5",58,0)
 ;W/Tasks
"RTN","XMS5",59,0)
 ;W:'$D(ZTQUEUED) !,"Wait for %ZTLOAD",!
"RTN","XMS5",60,0)
 ;D H F ZTS=0:0 S ZTS=$O(^%ZTSK(ZTS)) Q:'ZTS  S %=$S($D(^%ZTSK(ZTS,.1)):^(.1),1:"") I $S($L(%)'=1:1,"12345AG"[%:1,1:0),$D(^(.3,"XMB","XMSCRN"))#2 S ZTD=^("XMSCRN") K ^TMP($J,"ZTMKZ",ZTD)
"RTN","XMS5",61,0)
 ;
"RTN","XMS5",62,0)
 I '$D(ZTQUEUED) W !,"Some queues have no messages.",!
"RTN","XMS5",63,0)
 D H S ZTD="" F ZTI=2:1 S ZTD=$O(^TMP($J,"ZTMKZ",ZTD)) Q:ZTD=""  I '$O(^XMB(3.7,.5,2,^(ZTD)+1000,1,0)) K ^TMP($J,"ZTMKZ",ZTD)
"RTN","XMS5",64,0)
 I $O(^TMP($J,"ZTMKZ",""))="" W:'$D(ZTQUEUED) !!!,"<<<<  NO domains lack tasks !!! >>>",!!! Q
"RTN","XMS5",65,0)
 I '$D(ZTQUEUED) W !!,"These domains lack tasks."
"RTN","XMS5",66,0)
 I  S ZTD="" F ZTI=2:1 S ZTD=$O(^TMP($J,"ZTMKZ",ZTD)) Q:ZTD=""  S X=^(ZTD) W !?5,ZTD W:$P(^DIC(4.2,X,0),U,2)'["S" " << No Send Flag" I ZTI#20=0 S DIR(0)="E" D ^DIR K DIR,DIRUT
"RTN","XMS5",67,0)
 ;
"RTN","XMS5",68,0)
 ;
"RTN","XMS5",69,0)
 I '$D(ZTQUEUED) S DIR(0)="YO",DIR("A")="Requeue the missing tasks",DIR("B")="NO",DIR("?")="Answer YES to transmit these domains." D ^DIR K DIR,DIRUT I 'Y W !!,"Tasks not requeued." K ^TMP($J,"ZTMKZ") Q
"RTN","XMS5",70,0)
 ;
"RTN","XMS5",71,0)
 ;
"RTN","XMS5",72,0)
 S XMDUZ=$S($D(XMDUZ)[0:.5,'XMDUZ:.5,1:XMDUZ)
"RTN","XMS5",73,0)
 S XMS5="",XMS5("RETURN_TASK#")=1 F XMS5Z=0:0 S XMS5=$O(^TMP($J,"ZTMKZ",XMS5)) Q:XMS5=""  S XMSITE=XMS5,(XMINST,XMSCR)=^TMP($J,"ZTMKZ",XMS5) D Z
"RTN","XMS5",74,0)
 W:'$D(ZTQUEUED) !,"Done !" K XMS5,XMS5Z,^TMP($J,"ZTMKZ"),ZTD,ZTS Q
"RTN","XMS5",75,0)
H F I=1:1:9 H 1 W:'$D(ZTQUEUED) "."
"RTN","XMS5",76,0)
 Q
"RTN","XMS5",77,0)
CHK(ZTSK,XMINST) ;Is Task scheduled ? (0=no,.5=pending,1=running)
"RTN","XMS5",78,0)
 Q:'ZTSK 0
"RTN","XMS5",79,0)
 N % D STAT^%ZTLOAD
"RTN","XMS5",80,0)
 Q:ZTSK(1)=0 0  ; "Undefined"
"RTN","XMS5",81,0)
 Q:ZTSK(1)=1 .5  ; "Active: Pending"
"RTN","XMS5",82,0)
 I ZTSK(1)=2 N %1 D  L -^DIC(4.2,+$G(XMINST),"XMNETSEND") Q %1
"RTN","XMS5",83,0)
 . ; "Active: Running"
"RTN","XMS5",84,0)
 . L +^DIC(4.2,+$G(XMINST),"XMNETSEND"):2 ; Is it really running?
"RTN","XMS5",85,0)
 . I $T D KILL(XMINST,ZTSK) S %1=0 Q  ; Nope
"RTN","XMS5",86,0)
 . S %1=1  ; Yep
"RTN","XMS5",87,0)
 Q:ZTSK(1)=3 0  ; "Inactive: Finished"
"RTN","XMS5",88,0)
 I ZTSK(1)=4 D KILL(XMINST,ZTSK) Q 0  ; "Inactive: Available"
"RTN","XMS5",89,0)
 I ZTSK(1)=5 D KILL(XMINST,ZTSK) Q 0  ; "Interrupted"
"RTN","XMS5",90,0)
 Q
"RTN","XMS5",91,0)
KILL(XMINST,ZTSK) ;
"RTN","XMS5",92,0)
 D KILL^%ZTLOAD
"RTN","XMS5",93,0)
 S $P(^XMBS(4.2999,XMINST,0),U,2)=""  ; Task number
"RTN","XMS5",94,0)
 K ^XMBS(4.2999,XMINST,3)  ; Progress report
"RTN","XMS5",95,0)
 K ^XMBS(4.2999,XMINST,4)  ; Transmission data
"RTN","XMS5",96,0)
 K ^XMBS(4.2999,XMINST,5)  ; Transmission script
"RTN","XMS5",97,0)
 K ^XMBS(4.2999,XMINST,6)  ; Transmission audit
"RTN","XMS5",98,0)
 Q
"RTN","XMS5",99,0)
Z N % S %=$P(^DIC(4.2,XMINST,0),U,2)
"RTN","XMS5",100,0)
 I %["C"!(%["c")!(%["P")!(%["p") W:'$D(ZTQUEUED) !!,"Domain ",XMS5," has no send flag." Q
"RTN","XMS5",101,0)
 N XMB,ZTSK D ENQ^XMS1
"RTN","XMS5",102,0)
 I $G(ZTSK) W:'$D(ZTQUEUED) !!,"Task "_ZTSK_" queued for domain "_XMS5,! Q
"RTN","XMS5",103,0)
 I '$D(ZTQUEUED) W !!,"NO task queued for domain "_XMS5_"."
"RTN","XMS5",104,0)
 Q
"RTN","XMS5A")
0^9^B4960674
"RTN","XMS5A",1,0)
XMS5A ;(WASH ISC)/CAP/AML/RJ-Query into message queues ;01/28/98  11:16
"RTN","XMS5A",2,0)
 ;;7.1;MailMan;**55**;Jun 02, 1994
"RTN","XMS5A",3,0)
 D ^%ZIS Q:POP  U IO
"RTN","XMS5A",4,0)
 D NOW^%DTC K %I S A=$E(%,6,7)_" "_$P("Jan^Feb^Mar^Apr^May^Jun^Jul^Aug^Sep^Oct^Nov^Dec",U,$E(%,4,5))_" "_$E(%,2,3)
"RTN","XMS5A",5,0)
 I %\1'=% S %=$P(%,".",2)_"0000",A=A_" "_$E(%,1,2)_":"_$E(%,3,4)
"RTN","XMS5A",6,0)
 S XMD0=A K DIR S (XMF0,XMF0("PG"),XMC0,XME0)=0,DIR(0)="E"
"RTN","XMS5A",7,0)
Q S XMF0=$O(^DIC(4.2,"B",XMF0)) I XMF0="" G END
"RTN","XMS5A",8,0)
 S XMG0=$O(^DIC(4.2,"B",XMF0,0)) I '$D(^XMBS(4.2999,XMG0)) G Q
"RTN","XMS5A",9,0)
 S XMB0=$S($D(^XMBS(4.2999,XMG0,3))#2:^(3),1:""),XMB=$E(XMF0,1,16)
"RTN","XMS5A",10,0)
 S XMA=0 D M G:XMA<1 Q:XMB0=""
"RTN","XMS5A",11,0)
 I +XMB0=0 S XMA0="" G W
"RTN","XMS5A",12,0)
 S Y=$$HTE^XLFDT($P(XMB0,U,1),1)
"RTN","XMS5A",13,0)
 S Y=$P(Y,",",1)_" "_$E($P(Y,"@",2),1,5)
"RTN","XMS5A",14,0)
 S XMA0=Y_"^"_$P(XMB0,"^",2,6)
"RTN","XMS5A",15,0)
W ;write results
"RTN","XMS5A",16,0)
 I $Y+5>IOSL!'XMF0("PG") S X="" D:'$D(ZTQUEUED)&XMF0("PG") ^DIR:IOST?1"C-".E K DIRUT D HD G END:X=U
"RTN","XMS5A",17,0)
 S XMC0=XMC0+1 I $P(XMA0,U,4)<0 S $P(XMA0,U,4)=0
"RTN","XMS5A",18,0)
 W !,XMB,?18,$J(XMA,6),?25,$P(XMA0,"^",1),?40,$P(XMA0,"^",2),?48,$P(XMA0,"^",3),?54,$J($P(XMA0,"^",4),4),?59,$J($P(XMA0,"^",5)\1,4),?64,$P(XMA0,"^",6)
"RTN","XMS5A",19,0)
 G Q
"RTN","XMS5A",20,0)
M ;number in queue
"RTN","XMS5A",21,0)
 S XMA=$S($D(^XMB(3.7,.5,2,XMG0+1000,0)):$P(^(0),U,5),1:0) Q
"RTN","XMS5A",22,0)
HD S XMF0("PG")=XMF0("PG")+1 W @IOF,!,"TRANSMISSION QUEUE STATUS REPORT",?79-$L(XMD0),XMD0,!,"At "_^XMB("NETNAME"),?70,"Page: "_XMF0("PG"),!
"RTN","XMS5A",23,0)
 W !,"Domain",?18,"Queued",?25,"Updated",?40,"Msg #   Line  Errors  Rate   IO",!
"RTN","XMS5A",24,0)
 Q
"RTN","XMS5A",25,0)
END I $D(XMC0),XMC0<1 D HD:IOST'?1"C".E&'XMF0("PG") W !,"No messages queued or in active transmission.",!
"RTN","XMS5A",26,0)
 K %,%I,DIR,I,X,XMC0,XMB,XME0,XMB0,XMA0,XMA,XMG0,XMF0,Y
"RTN","XMS5A",27,0)
 D ^%ZISC
"RTN","XMS5A",28,0)
 Q
"RTN","XMS5A",29,0)
CONT ;CONTINUOUS DISPLAY
"RTN","XMS5A",30,0)
 D XMS5A R !,X:10 Q:$T  G CONT
"RTN","XMS5A",31,0)
GO W !! G XMS5A
"RTN","XMUT4A")
0^10^B8301630
"RTN","XMUT4A",1,0)
XMUT4A ;(WASH ISC)/CAP-MAILMAN FILE CHECKER FRONT END ;01/28/98  11:31
"RTN","XMUT4A",2,0)
 ;;7.1;MailMan;**34,55**;Jun 02, 1994
"RTN","XMUT4A",3,0)
 I $D(ZTQUEUED) G ENT^XMUT4
"RTN","XMUT4A",4,0)
 W !!,"The MailMan file checker may take some time to process."
"RTN","XMUT4A",5,0)
 W !,"If you have not tried it,  PLEASE try it when"
"RTN","XMUT4A",6,0)
 W !,"the system will be quiescent for a LONG period of time."
"RTN","XMUT4A",7,0)
 W !!,"ERRORS LISTED ARE GENERALLY NOT FATAL."
"RTN","XMUT4A",8,0)
 W !,"(Please contact your ISC if there are many errors.)"
"RTN","XMUT4A",9,0)
 W !!,"SOME ERRORS ARE CORRECTED:  New message, basket counts...",!!
"RTN","XMUT4A",10,0)
 W !,"Keep list generated for future reference.  If you see errors in"
"RTN","XMUT4A",11,0)
 W !,"MailMan, the list may help to resolve them.",!!
"RTN","XMUT4A",12,0)
 K DIR S DIR(0)="Y",DIR("A")="DO YOU WISH TO PROCEED",DIR("B")="NO"
"RTN","XMUT4A",13,0)
 S DIR("?")="  Enter 'Y' to proceed, 'N' or '^' to stop." D ^DIR
"RTN","XMUT4A",14,0)
 K DIR,X1,X2,DIRUT I "Yy"'[$E(X_" ") G EXIT
"RTN","XMUT4A",15,0)
 S XMLROU="ZTSK^XMUT4A" D ENT^XMA30 I POP Q
"RTN","XMUT4A",16,0)
ZTSK K ^TMP("XMUT4") G ENT^XMUT4
"RTN","XMUT4A",17,0)
QQ W !!,"<< TRY AGAIN LATER !!!"
"RTN","XMUT4A",18,0)
Q ;
"RTN","XMUT4A",19,0)
 W !!,%1," MESSAGES PROCESSED" I %1=$P(^XMB(3.9,0),U,4) W " = 3.9 FILE TOTAL IS OKAY"
"RTN","XMUT4A",20,0)
 E  W ".  I RESET THE 3.9 FILE TOTAL." L +^XMB(3.9,0) S $P(^XMB(3.9,0),U,4)=%1 L -^XMB(3.9,0)
"RTN","XMUT4A",21,0)
 W !! F I=0:0 S I=$O(I(I)) Q:'I  I I(I) W !,"TYPE ",I," ERRORS=",I(I)
"RTN","XMUT4A",22,0)
EXIT K XMDUZO S:$D(XMDUZ) XMDUZO=XMDUZ S XMDUZ=.5,XMK=.95,XMZ=0 I '$D(DT) D DT^DICRW
"RTN","XMUT4A",23,0)
X S XMZ=$O(^XMB(3.7,.5,2,.95,1,XMZ)) I +XMZ'=XMZ G Y:'$D(XMDUZO) S XMDUZ=XMDUZO K XMDUZO G Y
"RTN","XMUT4A",24,0)
 S X=$S($D(^XMB(3.9,XMZ,0)):^(0),1:"") I '$P(X,U,3) S $P(X,U,3)=$P(DT,"."),^(0)=X G X
"RTN","XMUT4A",25,0)
 I $$FMDIFF^XLFDT(DT,$P(X,U,3),1)>2 D KL^XMA1B
"RTN","XMUT4A",26,0)
 G X
"RTN","XMUT4A",27,0)
Y G E:$O(^TMP("XMUT4",""))']""
"RTN","XMUT4A",28,0)
 W !!,"FIXING INCOMPLETE TRANSACTIONS !!!",!!
"RTN","XMUT4A",29,0)
 ;
"RTN","XMUT4A",30,0)
 ;J CAN VARY FROM 1 THRU 3 (SEE XMUT4A)
"RTN","XMUT4A",31,0)
 ;J=^TMP("XMUT4",BASKET,MESSAGE,USER)
"RTN","XMUT4A",32,0)
 ;
"RTN","XMUT4A",33,0)
 ;J#2=1 MEANS NO ^XMB(3.9,XMZ)
"RTN","XMUT4A",34,0)
 ;J#2=0 MEANS MESSAGE NOT FILED IN USER MAIL BASKET
"RTN","XMUT4A",35,0)
 ;
"RTN","XMUT4A",36,0)
 S XMA0="",XMDUZO=$S($D(XMDUZ):XMDUZ,$D(DUZ):DUZ,1:0)
"RTN","XMUT4A",37,0)
A S XMA0=$O(^TMP("XMUT4",XMA0)) I +XMA0 S J=^(XMA0)
"RTN","XMUT4A",38,0)
 E  S XMDUZ=XMDUZO K XMDUZO G E
"RTN","XMUT4A",39,0)
 S I=XMA0,XMZ=$P(I,":",2),XMDUZ=$P(I,":",3),XMKM=$P(I,":")
"RTN","XMUT4A",40,0)
 I J=3,$D(^XMB(3.7,XMDUZ,2,XMKM,1,XMZ)) D KL^XMA1B
"RTN","XMUT4A",41,0)
B K ^XMB(3.7,"M",XMZ,XMDUZ,XMKM)
"RTN","XMUT4A",42,0)
 G A
"RTN","XMUT4A",43,0)
E K %1,%2,%3,%,%0,XMA0,XMB0,XMC0,XMD0,XME0,XMF0,XMKM,XMZ,I,%I,%H
"RTN","XMUT4A",44,0)
 K ^TMP("XMUT4")
"RTN","XMUT4A",45,0)
 W @IOF I $D(ZTQUEUED) S ZTREQ="@" Q
"RTN","XMUT4A",46,0)
 D ^%ZISC
"RTN","XMUT4A",47,0)
 Q
"RTN","XMUT4A",48,0)
ENT13 ;
"RTN","XMUT4A",49,0)
 W !,"MESS # ",A," RECPT ",I,"/",J," IN 'C' REF / NO RECPT,0 NODE"
"RTN","XMUT4A",50,0)
 Q
"RTN","XMUT4A",51,0)
ENT12 ;
"RTN","XMUT4A",52,0)
 W !,"RECPT ",I," OF ",A," W/NO OR BAD ZERO NODE"
"RTN","XMUT4A",53,0)
 Q
"RTN","XMUT4A",54,0)
RES ;RENUMBER Mail Basket
"RTN","XMUT4A",55,0)
 W:'$D(ZTQUEUED) ! S %=0,Y=0,XMKS=1 K ^XMB(3.7,XMDUZ,2,XMK,1,"C")
"RTN","XMUT4A",56,0)
O S %=$O(^XMB(3.7,XMDUZ,2,XMK,1,%)) G P:'% S Y=Y+1,$P(^(%,0),U,2)=Y
"RTN","XMUT4A",57,0)
 S ^XMB(3.7,XMDUZ,2,XMK,1,"C",Y,%)=""
"RTN","XMUT4A",58,0)
 I '$D(ZTQUEUED),Y#20=0 W "."
"RTN","XMUT4A",59,0)
 G O
"RTN","XMUT4A",60,0)
P S $P(^XMB(3.7,XMDUZ,2,XMK,0),U,3,5)=Y_U_Y_U_Y
"RTN","XMUT4A",61,0)
 Q
"RTN","XMUT4A",62,0)
ENT ;FOR PRE-XMAUTOPURGE
"RTN","XMUT4A",63,0)
 D SET G B^XMUT4
"RTN","XMUT4A",64,0)
SET ;SET UP
"RTN","XMUT4A",65,0)
 K ^TMP("XMUT4"),I F I=1:1:30 S I(I)=""
"RTN","XMUT4A",66,0)
 Q
"RTN","XMUT5R1")
0^11^B4386528
"RTN","XMUT5R1",1,0)
XMUT5R1 ;(WASH ISC)/CAP - MAIL STATISTICS RPT ;01/28/98  08:11
"RTN","XMUT5R1",2,0)
 ;;7.1;MailMan;**55**;Jun 02, 1994
"RTN","XMUT5R1",3,0)
ENTRY ;
"RTN","XMUT5R1",4,0)
 N XMEND,XMSTART,XMABORT
"RTN","XMUT5R1",5,0)
 S XMABORT=0
"RTN","XMUT5R1",6,0)
 D INIT(.XMSTART,.XMEND,.XMABORT) Q:XMABORT
"RTN","XMUT5R1",7,0)
 D REPORT(XMSTART,XMEND)
"RTN","XMUT5R1",8,0)
 Q
"RTN","XMUT5R1",9,0)
INIT(XMSTART,XMEND,XMABORT) ;
"RTN","XMUT5R1",10,0)
 N DIR,X,Y,DIRUT
"RTN","XMUT5R1",11,0)
 S XMEND=$$FMADD^XLFDT($E(DT,1,5)_"01",-1)  ; last day of last month
"RTN","XMUT5R1",12,0)
 S XMSTART=$E(XMEND,1,5)_"01"  ; first day of last month
"RTN","XMUT5R1",13,0)
 Q:$D(ZTQUEUED)
"RTN","XMUT5R1",14,0)
 S DIR("A")="START Date"
"RTN","XMUT5R1",15,0)
 S DIR("B")=$$FMTE^XLFDT(XMSTART,"2D")   ; MM/DD/YY
"RTN","XMUT5R1",16,0)
 S DIR(0)="D^:"_$$FMADD^XLFDT(DT,-1)_":EX"
"RTN","XMUT5R1",17,0)
 D ^DIR I $D(DIRUT) S XMABORT=1 Q
"RTN","XMUT5R1",18,0)
 S XMSTART=Y
"RTN","XMUT5R1",19,0)
 K X,Y,DIR,DIRUT
"RTN","XMUT5R1",20,0)
 S XMEND=$$FMADD^XLFDT(XMSTART,-1)
"RTN","XMUT5R1",21,0)
 S XMEND=$$SCH^XLFDT("1M",XMEND)       ; 1 month from XMSTART
"RTN","XMUT5R1",22,0)
 S DIR("A")="END Date"
"RTN","XMUT5R1",23,0)
 S DIR("B")=$$FMTE^XLFDT($$MIN^XLFMTH(XMEND,DT),"2D")   ; MM/DD/YY
"RTN","XMUT5R1",24,0)
 S DIR(0)="D^"_$$FMADD^XLFDT(XMSTART,+1)_":DT:EX"
"RTN","XMUT5R1",25,0)
 D ^DIR I $D(DIRUT) S XMABORT=1 Q
"RTN","XMUT5R1",26,0)
 S XMEND=Y
"RTN","XMUT5R1",27,0)
 Q
"RTN","XMUT5R1",28,0)
REPORT(XMA,XMB) ;
"RTN","XMUT5R1",29,0)
ZTSK ;Entry for Tasked report
"RTN","XMUT5R1",30,0)
 ;XMA=Start Date FM format
"RTN","XMUT5R1",31,0)
 ;XMAH=Start Date $H format
"RTN","XMUT5R1",32,0)
 ;XMB=End Date FM format
"RTN","XMUT5R1",33,0)
 ;XMBH=End Date $H format
"RTN","XMUT5R1",34,0)
 N XMC,XMD,XMV,BY,DIC,FLDS,FR,TO,L
"RTN","XMUT5R1",35,0)
 I '$D(ZTQUEUED) W !!,"Calling FileMan template ..."
"RTN","XMUT5R1",36,0)
 S XMD=$$FMTE^XLFDT(DT,"1D")  ; mmm dd, yyyy
"RTN","XMUT5R1",37,0)
 S XMC=$P(^XMB("NETNAME"),".")_" MailMan Activity Report"
"RTN","XMUT5R1",38,0)
 S XMV=^%ZOSF("PROD")
"RTN","XMUT5R1",39,0)
 S BY="[XMMGR-BKFILER-DAY@23:30]",FLDS="[XMMGR-BKFILER-LONGTERM-STATS]",FR=XMA,TO=XMB_".2359",DIC="^XMBX(4.2998,",L="Report on Statistics"
"RTN","XMUT5R1",40,0)
 S:$D(ZTQUEUED) IOP=ZTIO
"RTN","XMUT5R1",41,0)
 D EN1^DIP
"RTN","XMUT5R1",42,0)
 K DIS,XMA,XMB,XMAH,XMBH,X,Y,Z,%ZIS,ZTRTN,ZTSAVE,ZTDTH
"RTN","XMUT5R1",43,0)
 I '$D(ZTQUEUED) K ZTSK
"RTN","XMUT5R1",44,0)
 Q
"VER")
8.0^21.0
**END**
**END**
