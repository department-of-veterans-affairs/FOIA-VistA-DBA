Released PSD*3*53 SEQ #48
Extracted from mail message
**KIDS**:PSD*3.0*53^

**INSTALL NAME**
PSD*3.0*53
"BLD",5399,0)
PSD*3.0*53^CONTROLLED SUBSTANCES^0^3050401^y
"BLD",5399,1,0)
^^7^7^3041207^
"BLD",5399,1,1,0)
This patch will modify the Controlled Substance Balances report created 
"BLD",5399,1,2,0)
with menu option Verify Count [PSD NURSE ONLINE COUNT].  This report 
"BLD",5399,1,3,0)
errors out if all the drugs in the NAOU have a balance of zero.  This 
"BLD",5399,1,4,0)
patch will also modify menu options Record Delayed Wastage [PSD NURSE
"BLD",5399,1,5,0)
WASTE] and Not Given, Return to Stock [PSD NURSE NOT GIVEN].  These two
"BLD",5399,1,6,0)
options are calling code in each other's routines which is creating an
"BLD",5399,1,7,0)
infinite loop.
"BLD",5399,4,0)
^9.64PA^^
"BLD",5399,"KRN",0)
^9.67PA^8989.52^19
"BLD",5399,"KRN",.4,0)
.4
"BLD",5399,"KRN",.401,0)
.401
"BLD",5399,"KRN",.402,0)
.402
"BLD",5399,"KRN",.403,0)
.403
"BLD",5399,"KRN",.5,0)
.5
"BLD",5399,"KRN",.84,0)
.84
"BLD",5399,"KRN",3.6,0)
3.6
"BLD",5399,"KRN",3.8,0)
3.8
"BLD",5399,"KRN",9.2,0)
9.2
"BLD",5399,"KRN",9.8,0)
9.8
"BLD",5399,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",5399,"KRN",9.8,"NM",1,0)
PSDADJC^^0^B20793346
"BLD",5399,"KRN",9.8,"NM",2,0)
PSDRFW^^0^B23766867
"BLD",5399,"KRN",9.8,"NM",3,0)
PSDRFR^^0^B23996028
"BLD",5399,"KRN",9.8,"NM","B","PSDADJC",1)

"BLD",5399,"KRN",9.8,"NM","B","PSDRFR",3)

"BLD",5399,"KRN",9.8,"NM","B","PSDRFW",2)

"BLD",5399,"KRN",19,0)
19
"BLD",5399,"KRN",19.1,0)
19.1
"BLD",5399,"KRN",101,0)
101
"BLD",5399,"KRN",409.61,0)
409.61
"BLD",5399,"KRN",771,0)
771
"BLD",5399,"KRN",870,0)
870
"BLD",5399,"KRN",8989.51,0)
8989.51
"BLD",5399,"KRN",8989.52,0)
8989.52
"BLD",5399,"KRN",8994,0)
8994
"BLD",5399,"KRN","B",.4,.4)

"BLD",5399,"KRN","B",.401,.401)

"BLD",5399,"KRN","B",.402,.402)

"BLD",5399,"KRN","B",.403,.403)

"BLD",5399,"KRN","B",.5,.5)

"BLD",5399,"KRN","B",.84,.84)

"BLD",5399,"KRN","B",3.6,3.6)

"BLD",5399,"KRN","B",3.8,3.8)

"BLD",5399,"KRN","B",9.2,9.2)

"BLD",5399,"KRN","B",9.8,9.8)

"BLD",5399,"KRN","B",19,19)

"BLD",5399,"KRN","B",19.1,19.1)

"BLD",5399,"KRN","B",101,101)

"BLD",5399,"KRN","B",409.61,409.61)

"BLD",5399,"KRN","B",771,771)

"BLD",5399,"KRN","B",870,870)

"BLD",5399,"KRN","B",8989.51,8989.51)

"BLD",5399,"KRN","B",8989.52,8989.52)

"BLD",5399,"KRN","B",8994,8994)

"BLD",5399,"QUES",0)
^9.62^^
"BLD",5399,"REQB",0)
^9.611^1^1
"BLD",5399,"REQB",1,0)
PSD*3.0*25^2
"BLD",5399,"REQB","B","PSD*3.0*25",1)

"MBREQ")
0
"PKG",113,-1)
1^1
"PKG",113,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",113,20,0)
^9.402P^^
"PKG",113,22,0)
^9.49I^1^1
"PKG",113,22,1,0)
3.0^2970213^2970403^24
"PKG",113,22,1,"PAH",1,0)
53^3050401
"PKG",113,22,1,"PAH",1,1,0)
^^7^7^3050401
"PKG",113,22,1,"PAH",1,1,1,0)
This patch will modify the Controlled Substance Balances report created 
"PKG",113,22,1,"PAH",1,1,2,0)
with menu option Verify Count [PSD NURSE ONLINE COUNT].  This report 
"PKG",113,22,1,"PAH",1,1,3,0)
errors out if all the drugs in the NAOU have a balance of zero.  This 
"PKG",113,22,1,"PAH",1,1,4,0)
patch will also modify menu options Record Delayed Wastage [PSD NURSE
"PKG",113,22,1,"PAH",1,1,5,0)
WASTE] and Not Given, Return to Stock [PSD NURSE NOT GIVEN].  These two
"PKG",113,22,1,"PAH",1,1,6,0)
options are calling code in each other's routines which is creating an
"PKG",113,22,1,"PAH",1,1,7,0)
infinite loop.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSDADJC")
0^1^B20793346
"RTN","PSDADJC",1,0)
PSDADJC ;B'ham ISC/LTL,JPW - Balance Shift Checker for NAOU ; 16 Feb 94
"RTN","PSDADJC",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**53**;13 Feb 97
"RTN","PSDADJC",3,0)
 I '$D(PSDSITE) D ^PSDSET G:'$D(PSDSITE) QUIT
"RTN","PSDADJC",4,0)
 N D1,D2,DIC,DIE,DINUM,D0,D1,DLAYGO,DR,DIR,DIRUT,DTOUT,DUOUT,NODE,PSAC,PSDAT,PSDLOC,PSDOUT,PSDLOCN,DA,PSDRUG,PSDRUGN,PSDS,PSDPKG,PSDBKU,PSAQ,PSDR,PSDREC,PSDT,X,Y,%,%H,%I
"RTN","PSDADJC",5,0)
LOOK S DIC="^PSD(58.8,",DIC(0)="AEMQZ",DIC("A")="Select NAOU: ",DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$P($G(^(0)),U,2)[""N"",'$P(^(0),""^"",7),$S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0)"
"RTN","PSDADJC",6,0)
 W ! D ^DIC K DIC G:$D(DTOUT)!($D(DUOUT))!(Y<1) QUIT
"RTN","PSDADJC",7,0)
 ;VMP OIFO BAY PINES;VGF;PSD*3.0*53;ADDED SET OF VARIABLE NAOU
"RTN","PSDADJC",8,0)
 S (NAOU,PSDLOC)=+Y,(NAOUN,PSDLOCN)=$P(Y,U,2),PSDS=+$P(Y(0),"^",4)
"RTN","PSDADJC",9,0)
 I '+$P($G(^PSD(58.8,PSDLOC,2)),"^",5) W !!,"This NAOU does not maintain a perpetual inventory balance to check.",!! K PSDLOC,PSDLOCN,PSDS G LOOK
"RTN","PSDADJC",10,0)
CHKD I '$O(^PSD(58.8,PSDLOC,1,0)) W !!,"There are no drugs in ",PSDLOCN G QUIT
"RTN","PSDADJC",11,0)
WIT W ! S NUR2=$$WITNESS^XUVERIFY("WITNESS")
"RTN","PSDADJC",12,0)
 I NUR2=DUZ W !!,"Wait a second, you can't witness yourself!",$C(7) G WIT
"RTN","PSDADJC",13,0)
 G:NUR2'>0 QUIT
"RTN","PSDADJC",14,0)
 W !!,"Thank you, ",$S($P($G(^VA(200,NUR2,.1)),U,4)]"":$P($G(^(.1)),U,4),1:$P($G(^VA(200,NUR2,0)),U))
"RTN","PSDADJC",15,0)
 W !!,"Give me a second to alphabetize.",!
"RTN","PSDADJC",16,0)
 S PSDRUG=0,PSDRUGN=""
"RTN","PSDADJC",17,0)
 F  S PSDRUG=$O(^PSD(58.8,PSDLOC,1,PSDRUG)) Q:'PSDRUG  D
"RTN","PSDADJC",18,0)
 .Q:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,0))!($P($G(^PSDRUG(+PSDRUG,0)),"^")']"")!('$P($G(^PSD(58.8,+PSDLOC,1,PSDRUG,0)),U,4))
"RTN","PSDADJC",19,0)
 .S PSDPKG=$P($G(^PSD(58.8,+PSDS,1,+PSDRUG,0)),"^",9),PSDBKU=$P($G(^(0)),"^",8)
"RTN","PSDADJC",20,0)
 .S ^TMP("PSDB",$J,$P($G(^PSDRUG(+PSDRUG,0)),U),PSDRUG)=PSDPKG_"^"_PSDBKU K Y
"RTN","PSDADJC",21,0)
 W @IOF S (PSDRUG,PSDRUGN)=0
"RTN","PSDADJC",22,0)
 F  S PSDRUGN=$O(^TMP("PSDB",$J,PSDRUGN)) Q:PSDRUGN']""  F  S PSDRUG=$O(^TMP("PSDB",$J,PSDRUGN,PSDRUG)) Q:'PSDRUG  D  G:$D(DIRUT)!($G(PSDOUT)) QUIT
"RTN","PSDADJC",23,0)
 .Q:'$G(^PSD(58.8,PSDLOC,1,PSDRUG,0))
"RTN","PSDADJC",24,0)
 .S NODE=$G(^TMP("PSDB",$J,PSDRUGN,PSDRUG))
"RTN","PSDADJC",25,0)
BAL .W !!,PSDRUGN,!!,"Balance:  "
"RTN","PSDADJC",26,0)
 .S (PSDREC,PSDREC(1),PSDREC(2))=$P($G(^PSD(58.8,PSDLOC,1,PSDRUG,0)),U,4)
"RTN","PSDADJC",27,0)
 .W PSDREC," ",$P(NODE,U,2)
"RTN","PSDADJC",28,0)
 .S DIR(0)="Y",DIR("A")="Count Correct",DIR("B")="Yes"
"RTN","PSDADJC",29,0)
 .W ! D ^DIR K DIR Q:$D(DIRUT)
"RTN","PSDADJC",30,0)
 .G:Y=1 INV
"RTN","PSDADJC",31,0)
 .F  L +^PSD(58.8,+PSDLOC,1,+PSDRUG,0):0 I  Q
"RTN","PSDADJC",32,0)
 .S PSDREC(1)=$P($G(^PSD(58.8,PSDLOC,1,PSDRUG,0)),U,4)
"RTN","PSDADJC",33,0)
 .D NOW^%DTC S PSDAT=+%
"RTN","PSDADJC",34,0)
 .W !!,"Package Size: ",$P($G(NODE),"^"),"  Breakdown Unit: ",$P($G(NODE),"^",2),!
"RTN","PSDADJC",35,0)
 .S DIR(0)="NA^0:999999:2",DIR("A")="Correct Count: "
"RTN","PSDADJC",36,0)
 .S DIR("B")=PSDREC D ^DIR K DIR Q:$D(DIRUT)  S PSDREC(1)=Y
"RTN","PSDADJC",37,0)
 .I Y=PSDREC W !!,"That's no change." G INV
"RTN","PSDADJC",38,0)
 .I Y>PSDREC S NAOU(1)=0 D ^PSDORSU G:$G(NAOU(1)) BAL I $G(PSDOUT) L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0) Q
"RTN","PSDADJC",39,0)
 .S DIR(0)="58.81,15" W ! D ^DIR K DIR Q:$D(DIRUT)  S PSDRE=Y
"RTN","PSDADJC",40,0)
 .S DIE="^PSD(58.8,+PSDLOC,1,",DA(1)=PSDLOC,DA=PSDRUG
"RTN","PSDADJC",41,0)
 .S DR="3////"_$G(PSDREC(1)) D ^DIE
"RTN","PSDADJC",42,0)
 .S $P(^PSD(58.8,PSDLOC,1,PSDRUG,0),"^",17)=1
"RTN","PSDADJC",43,0)
 .L -^PSD(58.8,+PSDLOC,1,+PSDRUG,0)
"RTN","PSDADJC",44,0)
INV .I '$G(PSDAT) D NOW^%DTC S PSDAT=%
"RTN","PSDADJC",45,0)
 .S PSDREC=$G(PSDREC(1))-PSDREC G:'PSDREC TRA
"RTN","PSDADJC",46,0)
MON .S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,0)) ^(0)="^58.801A^^"
"RTN","PSDADJC",47,0)
 .I '$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,5,$E(DT,1,5)*100,0)) S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DIC(0)="LM",DLAYGO=58.8,(X,DINUM)=$E(DT,1,5)*100,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DLAYGO
"RTN","PSDADJC",48,0)
 .S DIE="^PSD(58.8,+PSDLOC,1,+PSDRUG,5,",DA(2)=PSDLOC,DA(1)=PSDRUG,DA=$E(DT,1,5)*100,DR="1////0;7////^S X=PSDREC" D ^DIE
"RTN","PSDADJC",49,0)
TRA .W !!,"Recording ",$S(PSDREC:"adjustment",1:"inventory")," in transaction history.",!
"RTN","PSDADJC",50,0)
TR .F  L +^PSD(58.81,0):0 I  Q
"RTN","PSDADJC",51,0)
FIND .S PSDT=$P(^PSD(58.81,0),U,3)+1 I $D(^PSD(58.81,PSDT)) S $P(^PSD(58.81,0),U,3)=$P(^PSD(58.81,0),U,3)+1 G FIND
"RTN","PSDADJC",52,0)
 .S DIC="^PSD(58.81,",DIC(0)="L",DLAYGO=58.81,(DINUM,X)=PSDT D ^DIC K DIC,DLAYGO L -^PSD(58.81,0)
"RTN","PSDADJC",53,0)
 .S DIE="^PSD(58.81,",DA=PSDT,DR="1////"_$S(PSDREC:9,1:23)_";2////"_PSDLOC_";3////"_PSDAT_";4////"_PSDRUG_";5////"_PSDREC_";6////"_DUZ_";9////"_PSDREC(2)_";15////"_$G(PSDRE)_";74////"_DUZ_";78////"_NUR2_";100////1" D ^DIE K DIE
"RTN","PSDADJC",54,0)
 .S:'$D(^PSD(58.8,+PSDLOC,1,+PSDRUG,4,0)) ^(0)="^58.800119PA^^"
"RTN","PSDADJC",55,0)
 .S DIC="^PSD(58.8,+PSDLOC,1,+PSDRUG,4,",DIC(0)="L",DLAYGO=58.8
"RTN","PSDADJC",56,0)
 .S (X,DINUM)=PSDT,DA(2)=PSDLOC,DA(1)=PSDRUG D ^DIC K DIC,DA,DLAYGO,Y
"RTN","PSDADJC",57,0)
 .S NAOU=PSDLOC,NAOUN=PSDLOCN
"RTN","PSDADJC",58,0)
MM .I PSDREC S PHARM1=DUZ,PSDT=PSDAT,PSDR=PSDRUG,PSDRE=$G(PSDRE),QTY=-PSDREC D ^PSDRFM
"RTN","PSDADJC",59,0)
REP S DIR(0)="Y",DIR("A")="Would you like a report of current balances"
"RTN","PSDADJC",60,0)
 S DIR("B")="No" D ^DIR K DIR D:Y=1 DEV^PSDBAN
"RTN","PSDADJC",61,0)
QUIT K ^TMP("PSDB",$J) Q
"RTN","PSDRFR")
0^3^B23996028
"RTN","PSDRFR",1,0)
PSDRFR ;BIR/JPW,LTL,BJW-Nurse RF Return to stock ; 11 May 98
"RTN","PSDRFR",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**5,7,25,53**;13 Feb 97
"RTN","PSDRFR",3,0)
 ;modified to set variables psdret,psdar for return date
"RTN","PSDRFR",4,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDRFR",5,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDRFR",6,0)
 ;Reference to ^PSDRUG( are covered by DBIA #221
"RTN","PSDRFR",7,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRFR",8,0)
 ;S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,1:0) I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to order",!,?12,"narcotic supplies.",! K OK Q
"RTN","PSDRFR",9,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDRFR",10,0)
 S PSDUZ=DUZ,(MSG,MSG1)=0,Y=DT X ^DD("DD") S REQD=Y
"RTN","PSDRFR",11,0)
NURSE N X,X1 D SIG^XUSESIG I X1="" G END
"RTN","PSDRFR",12,0)
NAOU ;select NAOU to dispense from
"RTN","PSDRFR",13,0)
 I $G(NAOU) S PSDS=+$P(^PSD(58.8,NAOU,0),U,4) G PATIENT
"RTN","PSDRFR",14,0)
 W !!,"Please enter the ward from which the drug(s) was signed out."
"RTN","PSDRFR",15,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Ward: "
"RTN","PSDRFR",16,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDRFR",17,0)
 W ! D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDRFR",18,0)
 I '$D(^PSD(58.8,NAOU,0)) S MSG=1 D MSG G END
"RTN","PSDRFR",19,0)
 I '$O(^PSD(58.8,NAOU,1,0)) S MSG=1,MSG1=2 D MSG G END
"RTN","PSDRFR",20,0)
 I '$P(^PSD(58.8,NAOU,0),U,4) S MSG=2 D MSG G END
"RTN","PSDRFR",21,0)
 S PSDS=+$P(^PSD(58.8,NAOU,0),"^",4),PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5) I '+PSDS S (MSG,MSG1)=1 D MSG G END
"RTN","PSDRFR",22,0)
 I '$D(^PSD(58.8,+PSDS,0)) S MSG=2 D MSG G END
"RTN","PSDRFR",23,0)
 I '$O(^PSD(58.8,+PSDS,1,0)) S MSG=2,MSG1=2 D MSG G END
"RTN","PSDRFR",24,0)
 ;S TYPE=$P(^PSD(58.8,+PSDS,0),"^",2),OKTYP=$S(TYPE="M":1,TYPE="S":1,1:0) I 'OKTYP W !!,"Contact your Pharmacy Coordinator.",!,"The Pharmacy Dispensing Site is invalid for this NAOU." G END
"RTN","PSDRFR",25,0)
PATIENT W !!,"Returns can only be recorded within "
"RTN","PSDRFR",26,0)
 S NAOU(1)=$S($P($G(^PSD(58.8,NAOU,6)),U,2):$P(^(6),U,2),1:12)
"RTN","PSDRFR",27,0)
 W NAOU(1)," hours after signing out a dose."
"RTN","PSDRFR",28,0)
 N DIC,DTOUT,DUOUT,X,Y,PSDOUT S DIC="^DPT(",DIC(0)="AEMQ"
"RTN","PSDRFR",29,0)
 S DIC("A")="Scan/Enter Patient: "
"RTN","PSDRFR",30,0)
 W ! D ^DIC K DIC G:Y<1 END S PAT=+Y
"RTN","PSDRFR",31,0)
DRUG ;select drug
"RTN","PSDRFR",32,0)
 N DIR,PSD,PSDR,PSDQ
"RTN","PSDRFR",33,0)
 S DIR(0)="FAO^1:40",DIR("A")="Scan Drug Label or Enter Label # or Drug: "
"RTN","PSDRFR",34,0)
 W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRFR",35,0)
MM ;
"RTN","PSDRFR",36,0)
 I $L(Y)=1,Y'=" " W $C(7),!!,"Please enter more than one character.",! G DRUG
"RTN","PSDRFR",37,0)
 I $O(^PSD(58.81,"D",Y,0)) D  I '$G(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRFR",38,0)
 .S PSD=0
"RTN","PSDRFR",39,0)
 .F  S PSD=$O(^PSD(58.81,"D",Y,PSD)) Q:'PSD  S PSD(1)=$G(^PSD(58.81,PSD,0)) I $P(PSD(1),U,11)>3,$P(PSD(1),U,18)=NAOU S PSDR=$P(PSD(1),U,5),PSDPN=$P(PSD(1),U,17),PSDTYP=17 Q
"RTN","PSDRFR",40,0)
 W:$G(PSDR) !!,$P($G(^PSDRUG(PSDR,0)),U)
"RTN","PSDRFR",41,0)
 D:'$G(PSDR)  G:$D(DTOUT)!($D(DUOUT)) END G:Y<1 PATIENT
"RTN","PSDRFR",42,0)
 .S DIC="^PSD(58.8,NAOU,1,",DIC(0)="EMQSZ",DA(1)=NAOU
"RTN","PSDRFR",43,0)
 .W ! D ^DIC K DIC Q:$D(DTOUT)!($D(DUOUT))!(Y<1)
"RTN","PSDRFR",44,0)
 .S PSDR=+Y,PSDTYP=17
"RTN","PSDRFR",45,0)
BAL S PSDR(1)=$G(^PSD(58.8,NAOU,1,PSDR,0)),OQTY=$P(PSDR(1),U,4)
"RTN","PSDRFR",46,0)
 ;PSD*3*25 (DAVE B)
"RTN","PSDRFR",47,0)
 K PSDDAVE D ^PSDRFV I $G(PSDDAVE)=1 K PSDDAVE S PSDOUT=1 G END
"RTN","PSDRFR",48,0)
 I '$G(PSDA(1)) W !!,"No doses signed out",!! G END
"RTN","PSDRFR",49,0)
 S OQTY=$P($G(^PSD(58.81,PSDA(1),0)),U,6)
"RTN","PSDRFR",50,0)
 I $$FMADD^XLFDT(PSDA(3),"",NAOU(1))<$$NOW^XLFDT W !!,"The last dose was signed out at ",PSDA(2),", over ",NAOU(1)," hours ago.",!!,"It is too late to return to stock.",!! G END
"RTN","PSDRFR",51,0)
 I PSDA(4)'=DUZ W !!,"Sorry, only the person who signed out the dose can return to stock.",!! G END
"RTN","PSDRFR",52,0)
 W !!,"Starting Balance:  "_$P(PSDR(1),U,4)_" "_$P(PSDR(1),U,8)
"RTN","PSDRFR",53,0)
QTY S DIR(0)="NA^0:"_OQTY_":2"
"RTN","PSDRFR",54,0)
 S DIR("A")="Amount actually given at "_PSDA(2)_": "
"RTN","PSDRFR",55,0)
 W ! D ^DIR K DIR I $D(DIRUT)!(Y=OQTY) S PSDOUT=1 G END
"RTN","PSDRFR",56,0)
 S PSDQ=Y
"RTN","PSDRFR",57,0)
 S PSDRET=$$FMADD^XLFDT($$NOW^XLFDT,0)
"RTN","PSDRFR",58,0)
 S PSDAR(1)=$$FMTE^XLFDT(PSDRET,"2P")
"RTN","PSDRFR",59,0)
WASTE I PSDQ'=OQTY D  G:$G(PSDOUT) END
"RTN","PSDRFR",60,0)
 .S:'$D(PSDAR(1)) PSDAR(1)=""
"RTN","PSDRFR",61,0)
 .I (OQTY-PSDQ)>1 D  Q:$G(PSDOUT)  G REA
"RTN","PSDRFR",62,0)
 ..S DIR(0)="N^1:"_(OQTY-PSDQ)_":2",DIR("A")="Amount returned at "_PSDAR(1)
"RTN","PSDRFR",63,0)
 ..S DIR("B")=OQTY-PSDQ D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDRFR",64,0)
 ..S WQTY=Y S:OQTY-WQTY PSDQ(1)=OQTY-WQTY
"RTN","PSDRFR",65,0)
 .S WQTY=$S('$G(PSDQ(2)):OQTY-PSDQ,1:OQTY-WQTY)
"RTN","PSDRFR",66,0)
 .W ?55,"Amount returned: ",WQTY,!
"RTN","PSDRFR",67,0)
REA .S DIR(0)="58.81,15",DIR("B")="Not given, returned to stock"
"RTN","PSDRFR",68,0)
 .D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDRFR",69,0)
 .S PSDRE(1)=Y
"RTN","PSDRFR",70,0)
 ;VMP OIFO BAY PINES;PSD*3.0*53;DISPLAY CORRECT BALANCE
"RTN","PSDRFR",71,0)
 N PSDRETQ
"RTN","PSDRFR",72,0)
 S PSDRETQ=WQTY,PSDQ=+$G(PSDQ(1))
"RTN","PSDRFR",73,0)
 D UPDATE^PSDRFX W !!,"Balance:  ",$P(PSDR(1),U,4)+PSDRETQ," ",$P(PSDR(1),U,8),!!
"RTN","PSDRFR",74,0)
 ;VMP OIFO BAY PINES;PSD*3.0*53;REMOVED CALL TO WASTE^PSDRFW
"RTN","PSDRFR",75,0)
END I $G(PSDQ(2)),$G(PSDOUT) S $P(^PSD(58.81,PSDA(1),0),U,6)=PSDQ
"RTN","PSDRFR",76,0)
 W:$G(PSDOUT) !!,"No return recorded.",$C(7),!! K %,%DT,%H,%I,CNT,CNT1,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,LN,MSG,MSG1
"RTN","PSDRFR",77,0)
 K NAOU,NAOUN,NBKU,NPKG,OK,OKTYP,ORD,PAT,PSDA,PSDAR,PSDEM,PSDOUT,PSDQTY,PSDRD,PSDR,PSDRE,PSDRET,PSDRN,PSDS,PSDT,PSDUZ,PSDUZN,REQD,TEXT,TYPE,WQTY,OQTY,PSDQ,WORD,X,Y,PSDRETQ
"RTN","PSDRFR",78,0)
 Q
"RTN","PSDRFR",79,0)
MSG ;display error message
"RTN","PSDRFR",80,0)
 W $C(7),!!,?10,"Contact your Pharmacy Coordinator.",!,?10,"This "_$S(MSG=2:"Dispensing Site",MSG=1:"NAOU",1:"Drug")_" is missing "
"RTN","PSDRFR",81,0)
 W $S(MSG1=1:"Primary Disp. Site",MSG1=2:"stocked drugs",MSG1=3:"narcotic breakdown unit",MSG1=4:"narcotic package size",1:"data")_".",!
"RTN","PSDRFR",82,0)
 Q
"RTN","PSDRFW")
0^2^B23766867
"RTN","PSDRFW",1,0)
PSDRFW ;BIR/JPW,LTL-Nurse RF Dispensing ; 8 Aug 94
"RTN","PSDRFW",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**25,53**;13 Feb 97
"RTN","PSDRFW",3,0)
 ;Reference to $$WITNESS^XUVERIFY are covered by DBIA #1513
"RTN","PSDRFW",4,0)
 ;Reference to ^PSD(58.8 are covered by DBIA #2711
"RTN","PSDRFW",5,0)
 ;Reference to ^PSD(58.81 are covered by DBIA #2808
"RTN","PSDRFW",6,0)
 ;Reference to ^PSDRUG( are covered by DBIA #221
"RTN","PSDRFW",7,0)
 I '$D(PSDSITE) D ^PSDSET Q:'$D(PSDSITE)
"RTN","PSDRFW",8,0)
 ;S OK=$S($D(^XUSEC("PSJ RNURSE",DUZ)):1,1:0) I 'OK W $C(7),!!,?9,"** Please contact your Pharmacy Coordinator for access to order",!,?12,"narcotic supplies.",! K OK Q
"RTN","PSDRFW",9,0)
 I $P($G(^VA(200,DUZ,20)),U,4)']"" N XQH S XQH="PSD ESIG" D EN^XQH G END
"RTN","PSDRFW",10,0)
 S PSDUZ=DUZ,(MSG,MSG1)=0,Y=DT X ^DD("DD") S REQD=Y
"RTN","PSDRFW",11,0)
NURSE N X,X1 D SIG^XUSESIG I X1="" G END
"RTN","PSDRFW",12,0)
NAOU ;select NAOU to dispense from
"RTN","PSDRFW",13,0)
 I $G(NAOU) S PSDS=+$P(^PSD(58.8,NAOU,0),U,4) G PATIENT
"RTN","PSDRFW",14,0)
 W !!,"Please enter the ward from which the drug(s) will be signed out."
"RTN","PSDRFW",15,0)
 K DA,DIC S DIC=58.8,DIC(0)="QEA",DIC("A")="Select Ward: "
"RTN","PSDRFW",16,0)
 S DIC("S")="I $P(^(0),""^"",3)=+PSDSITE,$S('$D(^(""I"")):1,'^(""I""):1,+^(""I"")>DT:1,1:0),$P(^(0),""^"",2)=""N"",'$P(^(0),""^"",7)"
"RTN","PSDRFW",17,0)
 W ! D ^DIC K DIC G:Y<0 END S NAOU=+Y,NAOUN=$P(Y,"^",2)
"RTN","PSDRFW",18,0)
 I '$D(^PSD(58.8,NAOU,0)) S MSG=1 D MSG G END
"RTN","PSDRFW",19,0)
 I '$O(^PSD(58.8,NAOU,1,0)) S MSG=1,MSG1=2 D MSG G END
"RTN","PSDRFW",20,0)
 I '$P(^PSD(58.8,NAOU,0),U,4) S MSG=2 D MSG G END
"RTN","PSDRFW",21,0)
 S PSDS=+$P(^PSD(58.8,NAOU,0),"^",4),PSDS=PSDS_"^"_+$P(^PSD(58.8,+PSDS,0),"^",5) I '+PSDS S (MSG,MSG1)=1 D MSG G END
"RTN","PSDRFW",22,0)
 I '$D(^PSD(58.8,+PSDS,0)) S MSG=2 D MSG G END
"RTN","PSDRFW",23,0)
 I '$O(^PSD(58.8,+PSDS,1,0)) S MSG=2,MSG1=2 D MSG G END
"RTN","PSDRFW",24,0)
 ;S TYPE=$P(^PSD(58.8,+PSDS,0),"^",2),OKTYP=$S(TYPE="M":1,TYPE="S":1,1:0) I 'OKTYP W !!,"Contact your Pharmacy Coordinator.",!,"The Pharmacy Dispensing Site is invalid for this NAOU." G END
"RTN","PSDRFW",25,0)
PATIENT W !!,"Wastage can only be recorded within "
"RTN","PSDRFW",26,0)
 S NAOU(1)=$S($P($G(^PSD(58.8,NAOU,6)),U,2):$P(^(6),U,2),1:12)
"RTN","PSDRFW",27,0)
 W NAOU(1)," hours after signing out a dose.",!!
"RTN","PSDRFW",28,0)
 W "(except for PCA syringes and Infusions)"
"RTN","PSDRFW",29,0)
 N DIC,DTOUT,DUOUT,X,Y,PSDOUT S DIC="^DPT(",DIC(0)="AEMQ"
"RTN","PSDRFW",30,0)
 S DIC("A")="Scan/Enter Patient: "
"RTN","PSDRFW",31,0)
 W ! D ^DIC K DIC G:Y<1 END S PAT=+Y
"RTN","PSDRFW",32,0)
DRUG ;select drug
"RTN","PSDRFW",33,0)
 N DIR,PSD,PSDA,PSDR,PSDQ
"RTN","PSDRFW",34,0)
 S DIR(0)="FAO^1:40",DIR("A")="Scan Drug Label or Enter Label # or Drug: "
"RTN","PSDRFW",35,0)
 W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRFW",36,0)
 I $L(Y)=1,Y'=" " W $C(7),!!,"Please enter more than one character.",! G DRUG
"RTN","PSDRFW",37,0)
 I $O(^PSD(58.81,"D",Y,0)) D  I '$G(PSDR) W $C(7),!!,"This is not a valid Pharmacy Dispensing number for this ward.",!! G END
"RTN","PSDRFW",38,0)
 .S PSD=0
"RTN","PSDRFW",39,0)
 .F  S PSD=$O(^PSD(58.81,"D",Y,PSD)) Q:'PSD  S PSD(1)=$G(^PSD(58.81,PSD,0)) I $P(PSD(1),U,11)>3,$P(PSD(1),U,18)=NAOU S PSDR=$P(PSD(1),U,5),PSDPN=$P(PSD(1),U,17),PSDTYP=17 Q
"RTN","PSDRFW",40,0)
 W:$G(PSDR) !!,$P($G(^PSDRUG(PSDR,0)),U)
"RTN","PSDRFW",41,0)
 D:'$G(PSDR)  G:$D(DTOUT)!($D(DUOUT)) END G:Y<1 PATIENT
"RTN","PSDRFW",42,0)
 .S DIC="^PSD(58.8,NAOU,1,",DIC(0)="EMQSZ",DA(1)=NAOU
"RTN","PSDRFW",43,0)
 .W ! D ^DIC K DIC Q:$D(DTOUT)!($D(DUOUT))!(Y<1)
"RTN","PSDRFW",44,0)
 .S PSDR=+Y,PSDTYP=17
"RTN","PSDRFW",45,0)
BAL S PSDR(1)=$G(^PSD(58.8,NAOU,1,PSDR,0)),OQTY=$P(PSDR(1),U,4)
"RTN","PSDRFW",46,0)
 ;PSD*3*25 (DAVE B)
"RTN","PSDRFW",47,0)
 K PSDDAVE D ^PSDRFV I $G(PSDDAVE)=1 K PSDDAVE S PSDOUT=1 G END
"RTN","PSDRFW",48,0)
 I '$G(PSDA(1)) W !!,"No doses signed out",!! G END
"RTN","PSDRFW",49,0)
 S OQTY=$P($G(^PSD(58.81,PSDA(1),0)),U,6)
"RTN","PSDRFW",50,0)
 I $$FMADD^XLFDT(PSDA(3),"",NAOU(1))<$$NOW^XLFDT W !!,"The last dose was signed out at ",PSDA(2),", over ",NAOU(1)," hours ago.",!!,"It is too late to record wastage.",!! G END
"RTN","PSDRFW",51,0)
 I PSDA(4)'=DUZ W !!,"Sorry, only the person that signed out the dose can record delayed wastage.",!! G END
"RTN","PSDRFW",52,0)
 ;S DIR(0)="Y",DIR("A")="Starting Balance:  "_OQTY_" "_$P(PSDR(1),U,8)_"     Correct count"
"RTN","PSDRFW",53,0)
 ;S DIR("B")="Yes",NUR1=DUZ
"RTN","PSDRFW",54,0)
 ;S DIR("?")="Answer Yes if the amount on hand equals the starting balance."
"RTN","PSDRFW",55,0)
 ;W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDRFW",56,0)
 ;I Y=0 D ^PSDRF2 G:$G(PSDOUT) END S $P(PSDR(1),U,4)=PSDQ(1),OQTY=PSDQ(1)
"RTN","PSDRFW",57,0)
QTY S DIR(0)="NA^0:"_OQTY_":2"
"RTN","PSDRFW",58,0)
 S DIR("A")="Amount actually given at "_PSDA(2)_": "
"RTN","PSDRFW",59,0)
 W ! D ^DIR K DIR I $D(DIRUT)!(Y=OQTY) S PSDOUT=1 G END
"RTN","PSDRFW",60,0)
 S PSDQ=Y
"RTN","PSDRFW",61,0)
WASTE I PSDQ'=OQTY D  G:$G(PSDOUT) END
"RTN","PSDRFW",62,0)
 .I (OQTY-PSDQ)>1 D  Q:$G(PSDOUT)  G REA
"RTN","PSDRFW",63,0)
 ..S DIR(0)="N^1:"_(OQTY-PSDQ)_":2",DIR("A")="Amount wasted"
"RTN","PSDRFW",64,0)
 ..S DIR("B")=OQTY-PSDQ D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDRFW",65,0)
 ..S WQTY=Y S:OQTY-WQTY PSDQ(2)=OQTY-WQTY
"RTN","PSDRFW",66,0)
 .S WQTY=$S('$G(PSDQ(1)):OQTY-PSDQ,1:PSDQ)
"RTN","PSDRFW",67,0)
 .W ?55,"Amount wasted: ",WQTY,!
"RTN","PSDRFW",68,0)
REA .S DIR(0)="58.81,15" D ^DIR K DIR I $D(DIRUT) S PSDOUT=1 Q
"RTN","PSDRFW",69,0)
 .S PSDRE=Y
"RTN","PSDRFW",70,0)
WIT .W ! S NUR2=$$WITNESS^XUVERIFY("WITNESS")
"RTN","PSDRFW",71,0)
 .I NUR2=DUZ W !!,"Wait a minute, you can't witness yourself!",$C(7) G WIT
"RTN","PSDRFW",72,0)
 .I NUR2'>0 S PSDOUT=1 Q
"RTN","PSDRFW",73,0)
 .W !!,"Thank you, ",$S($P($G(^VA(200,NUR2,.1)),U,4)]"":$P($G(^(.1)),U,4),1:$P($G(^VA(200,NUR2,0)),U))
"RTN","PSDRFW",74,0)
 ;VMP OIFO BAY PINES;VGF;PSD*3.0*53;REMOVED CALL TO WASTE^PSDRFR
"RTN","PSDRFW",75,0)
 D EDIT^PSDRFX
"RTN","PSDRFW",76,0)
END I $G(PSDQ(1)),$G(PSDOUT) S $P(^PSD(58.81,PSDA(1),0),U,6)=PSDQ
"RTN","PSDRFW",77,0)
 W:$G(PSDOUT) !!,"No wastage recorded.",$C(7),!! K %,%DT,%H,%I,CNT,CNT1,DA,DIC,DIE,DINUM,DIR,DIROUT,DIRUT,DIWF,DIWL,DIWR,DR,DTOUT,DUOUT,LN,MSG,MSG1
"RTN","PSDRFW",78,0)
 K NAOU,NAOUN,NBKU,NPKG,OK,OKTYP,ORD,PAT,PSDA,PSDEM,PSDOUT,PSDQTY,PSDRD,PSDR,PSDRE,PSDRN,PSDS,PSDT,PSDUZ,PSDUZN,REQD,TEXT,TYPE,WQTY,OQTY,PSDQ,WORD,X,Y
"RTN","PSDRFW",79,0)
 Q
"RTN","PSDRFW",80,0)
MSG ;display error message
"RTN","PSDRFW",81,0)
 W $C(7),!!,?10,"Contact your Pharmacy Coordinator.",!,?10,"This "_$S(MSG=2:"Dispensing Site",MSG=1:"NAOU",1:"Drug")_" is missing "
"RTN","PSDRFW",82,0)
 W $S(MSG1=1:"Primary Disp. Site",MSG1=2:"stocked drugs",MSG1=3:"narcotic breakdown unit",MSG1=4:"narcotic package size",1:"data")_".",!
"RTN","PSDRFW",83,0)
 Q
"VER")
8.0^22
"BLD",5399,6)
^SEQ #48
**END**
**END**
