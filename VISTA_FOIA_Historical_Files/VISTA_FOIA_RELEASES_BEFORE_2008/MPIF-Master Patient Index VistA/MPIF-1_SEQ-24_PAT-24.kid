Released MPIF*1*24 SEQ #24
Extracted from mail message
**KIDS**:MPIF*1.0*24^

**INSTALL NAME**
MPIF*1.0*24
"BLD",1558,0)
MPIF*1.0*24^MASTER PATIENT INDEX VISTA^0^3021121^y
"BLD",1558,1,0)
^^3^3^3021022^
"BLD",1558,1,1,0)
NEW MESSSAGE STRUCTURE - PHASE 2
"BLD",1558,1,2,0)
Refer to patch MPIF*1*24 in the FORUM Patch Module for a complete
"BLD",1558,1,3,0)
description.
"BLD",1558,4,0)
^9.64PA^^
"BLD",1558,"ABNS",0)
^9.66A^^
"BLD",1558,"ABPKG")
^^
"BLD",1558,"KRN",0)
^9.67PA^8989.52^19
"BLD",1558,"KRN",.4,0)
.4
"BLD",1558,"KRN",.401,0)
.401
"BLD",1558,"KRN",.402,0)
.402
"BLD",1558,"KRN",.403,0)
.403
"BLD",1558,"KRN",.5,0)
.5
"BLD",1558,"KRN",.84,0)
.84
"BLD",1558,"KRN",3.6,0)
3.6
"BLD",1558,"KRN",3.8,0)
3.8
"BLD",1558,"KRN",9.2,0)
9.2
"BLD",1558,"KRN",9.2,"NM",0)
^9.68A^^
"BLD",1558,"KRN",9.8,0)
9.8
"BLD",1558,"KRN",9.8,"NM",0)
^9.68A^10^8
"BLD",1558,"KRN",9.8,"NM",1,0)
MPIFQ0^^0^B75016214
"BLD",1558,"KRN",9.8,"NM",3,0)
MPIFRPC2^^0^B14636916
"BLD",1558,"KRN",9.8,"NM",5,0)
MPIFBT3^^0^B23491720
"BLD",1558,"KRN",9.8,"NM",6,0)
MPIFQUE4^^0^B58373314
"BLD",1558,"KRN",9.8,"NM",7,0)
MPIFSEED^^0^B7593746
"BLD",1558,"KRN",9.8,"NM",8,0)
MPIFA31B^^0^B5415101
"BLD",1558,"KRN",9.8,"NM",9,0)
MPIFA24^^0^B12382428
"BLD",1558,"KRN",9.8,"NM",10,0)
MPIFQ1^^0^B87066805
"BLD",1558,"KRN",9.8,"NM","B","MPIFA24",9)

"BLD",1558,"KRN",9.8,"NM","B","MPIFA31B",8)

"BLD",1558,"KRN",9.8,"NM","B","MPIFBT3",5)

"BLD",1558,"KRN",9.8,"NM","B","MPIFQ0",1)

"BLD",1558,"KRN",9.8,"NM","B","MPIFQ1",10)

"BLD",1558,"KRN",9.8,"NM","B","MPIFQUE4",6)

"BLD",1558,"KRN",9.8,"NM","B","MPIFRPC2",3)

"BLD",1558,"KRN",9.8,"NM","B","MPIFSEED",7)

"BLD",1558,"KRN",19,0)
19
"BLD",1558,"KRN",19.1,0)
19.1
"BLD",1558,"KRN",101,0)
101
"BLD",1558,"KRN",101,"NM",0)
^9.68A^^0
"BLD",1558,"KRN",409.61,0)
409.61
"BLD",1558,"KRN",771,0)
771
"BLD",1558,"KRN",870,0)
870
"BLD",1558,"KRN",8989.51,0)
8989.51
"BLD",1558,"KRN",8989.52,0)
8989.52
"BLD",1558,"KRN",8994,0)
8994
"BLD",1558,"KRN","B",.4,.4)

"BLD",1558,"KRN","B",.401,.401)

"BLD",1558,"KRN","B",.402,.402)

"BLD",1558,"KRN","B",.403,.403)

"BLD",1558,"KRN","B",.5,.5)

"BLD",1558,"KRN","B",.84,.84)

"BLD",1558,"KRN","B",3.6,3.6)

"BLD",1558,"KRN","B",3.8,3.8)

"BLD",1558,"KRN","B",9.2,9.2)

"BLD",1558,"KRN","B",9.8,9.8)

"BLD",1558,"KRN","B",19,19)

"BLD",1558,"KRN","B",19.1,19.1)

"BLD",1558,"KRN","B",101,101)

"BLD",1558,"KRN","B",409.61,409.61)

"BLD",1558,"KRN","B",771,771)

"BLD",1558,"KRN","B",870,870)

"BLD",1558,"KRN","B",8989.51,8989.51)

"BLD",1558,"KRN","B",8989.52,8989.52)

"BLD",1558,"KRN","B",8994,8994)

"BLD",1558,"QUES",0)
^9.62^^
"BLD",1558,"REQB",0)
^9.611^4^4
"BLD",1558,"REQB",1,0)
DG*5.3*474^2
"BLD",1558,"REQB",2,0)
MPIF*1.0*22^2
"BLD",1558,"REQB",3,0)
MPIF*1.0*21^2
"BLD",1558,"REQB",4,0)
MPIF*1.0*20^2
"BLD",1558,"REQB","B","DG*5.3*474",1)

"BLD",1558,"REQB","B","MPIF*1.0*20",4)

"BLD",1558,"REQB","B","MPIF*1.0*21",3)

"BLD",1558,"REQB","B","MPIF*1.0*22",2)

"MBREQ")
0
"PKG",282,-1)
1^1
"PKG",282,0)
MASTER PATIENT INDEX VISTA^MPIF^Master Patient Index VistA side
"PKG",282,20,0)
^9.402P^^
"PKG",282,22,0)
^9.49I^1^1
"PKG",282,22,1,0)
1.0^2990428
"PKG",282,22,1,"PAH",1,0)
24^3021121
"PKG",282,22,1,"PAH",1,1,0)
^^3^3^3021121
"PKG",282,22,1,"PAH",1,1,1,0)
NEW MESSSAGE STRUCTURE - PHASE 2
"PKG",282,22,1,"PAH",1,1,2,0)
Refer to patch MPIF*1*24 in the FORUM Patch Module for a complete
"PKG",282,22,1,"PAH",1,1,3,0)
description.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","MPIFA24")
0^9^B12382428
"RTN","MPIFA24",1,0)
MPIFA24 ;BPOFO/CMC-A24 PROCESSING ROUTINE ;18 Mar 02
"RTN","MPIFA24",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,24**;30 Apr 99
"RTN","MPIFA24",3,0)
 ;
"RTN","MPIFA24",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA24",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA24",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA24",7,0)
 ;  ^DPT("AICN" - #2070
"RTN","MPIFA24",8,0)
 ;  DELETETF^VAFCTFU, FILE^VAFCTFU - #2988
"RTN","MPIFA24",9,0)
 ;
"RTN","MPIFA24",10,0)
 ;PROCESS A24 RESULTING FROM A28 ADD TO MPI MESSAGE OR FROM A40 MERGE
"RTN","MPIFA24",11,0)
A24 ;
"RTN","MPIFA24",12,0)
 N MPII,MPIJ,ARRY,SEG,CNT,ERR,SITE,MSG,DFN,IEN,LIST
"RTN","MPIFA24",13,0)
 S (CNT,ERR,FIRST)=1
"RTN","MPIFA24",14,0)
 F MPII=1:1 X HLNEXT Q:HLQUIT'>0  S MSG=HLNODE D
"RTN","MPIFA24",15,0)
 .S MPIJ=0 F  S MPIJ=$O(HLNODE(MPIJ)) Q:'MPIJ  S MSG(MPIJ)=HLNODE(MPIJ)
"RTN","MPIFA24",16,0)
 .S SEG=$E(HLNODE,1,3)
"RTN","MPIFA24",17,0)
 .I SEG="MSH" D MSH(.ARRY,.MSG) Q
"RTN","MPIFA24",18,0)
 .I SEG="EVN" D EVN(.ARRY,.MSG) Q
"RTN","MPIFA24",19,0)
 .I SEG="PID" D PID(.ARRY,.MSG,FIRST) S FIRST=2 Q
"RTN","MPIFA24",20,0)
 .I SEG="PD1" D PD1(.ARRY,.MSG) Q
"RTN","MPIFA24",21,0)
 ;
"RTN","MPIFA24",22,0)
 ;UPDATE 991.01, 991.02, 991.03
"RTN","MPIFA24",23,0)
 I $G(ARRY("ICN",2))'="" S DFN=$$GETDFN^MPIF001(ARRY("ICN",2))
"RTN","MPIFA24",24,0)
 I $G(ARRY("ICN",2))=""!(+$G(DFN)'>0) D
"RTN","MPIFA24",25,0)
 . I $G(ARRY("DFN",2))'="" S DFN=ARRY("DFN",2)
"RTN","MPIFA24",26,0)
 . I $G(ARRY("DFN",2))="" S DFN=ARRY("DFN",1)
"RTN","MPIFA24",27,0)
 S ARRY(991.03)=$$LKUP^XUAF4(ARRY(991.03))
"RTN","MPIFA24",28,0)
 I +$G(DFN)'>0 S ERR="Unknown Identifier(s) ICN#"_$G(ARRY("ICN",2))_" and DFN#"_$G(ARRY("DFN",2))
"RTN","MPIFA24",29,0)
 I +$G(DFN)>0 S ERR=$$UPDATE^MPIFAPI(DFN,"ARRY",0) D
"RTN","MPIFA24",30,0)
 .;remove ALL Treating Facilities except your sites and add the CMOR
"RTN","MPIFA24",31,0)
 .D TFL^VAFCTFU1(.LIST,DFN) I $O(LIST(0)) D
"RTN","MPIFA24",32,0)
 .. N LOC,MPINODE,LOCIEN,CMOR,MPIFX,ERROR
"RTN","MPIFA24",33,0)
 .. S (CMOR,MPIFX)=0 F  S MPIFX=$O(LIST(MPIFX)) Q:'MPIFX  I $P(LIST(MPIFX),"^",5)="VAMC" D
"RTN","MPIFA24",34,0)
 ... ;get MPI node
"RTN","MPIFA24",35,0)
 ... S MPINODE=$$MPINODE^MPIFAPI(DFN),LOC=$P(LIST(MPIFX),"^"),LOCIEN=$$IEN^XUAF4(LOC)
"RTN","MPIFA24",36,0)
 ... I LOC=$P($$SITE^VASITE,"^",3) Q  ;do not delete own site
"RTN","MPIFA24",37,0)
 ... I LOCIEN=$P(MPINODE,"^",3) S CMOR=LOCIEN Q  ;do not delete CMOR site
"RTN","MPIFA24",38,0)
 ... S ERROR=$$DELETETF^VAFCTFU($P(MPINODE,"^",1),LOCIEN)
"RTN","MPIFA24",39,0)
 .. ;add CMOR site to TF list if it did not already exist
"RTN","MPIFA24",40,0)
 .. I CMOR'=0 D FILE^VAFCTFU(DFN,CMOR,1)
"RTN","MPIFA24",41,0)
 ;
"RTN","MPIFA24",42,0)
 S HLA("HLA",1)="MSA"_HL("FS")_"AA"_HL("FS")_HL("MID")_HL("FS")_$S(+$G(ERR)'>0:$P(ERR,"^",2),1:"")
"RTN","MPIFA24",43,0)
 S $P(HLA("HLA",1),HL("FS"),7)="ICN="_ARRY("ICN",1)
"RTN","MPIFA24",44,0)
 D LINK^HLUTIL3(ARRY("SITE"),.LINK) S IEN=$O(LINK(0)),HLL("LINKS",1)="^"_LINK(IEN)
"RTN","MPIFA24",45,0)
 D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"LM",1,.HLRESLTA,"",.HL)
"RTN","MPIFA24",46,0)
 K LINK
"RTN","MPIFA24",47,0)
 Q
"RTN","MPIFA24",48,0)
 ;
"RTN","MPIFA24",49,0)
MSH(ARY,MSG) ;processing MSH fields
"RTN","MPIFA24",50,0)
 N COMP
"RTN","MPIFA24",51,0)
 S COMP=$E(HL("ECH"),1)
"RTN","MPIFA24",52,0)
 S ARY("SITE")=$$LKUP^XUAF4($P($P(MSG,HL("FS"),4),COMP))
"RTN","MPIFA24",53,0)
 Q
"RTN","MPIFA24",54,0)
 ;
"RTN","MPIFA24",55,0)
EVN(ARY,MSG) ;processing EVN fields
"RTN","MPIFA24",56,0)
 S ARY("EVTR")=$P(MSG,HL("FS"),2) ;not currently used
"RTN","MPIFA24",57,0)
 S ARY("DLT")=$$FMDATE^HLFNC($P(MSG,HL("FS"),3))
"RTN","MPIFA24",58,0)
 Q
"RTN","MPIFA24",59,0)
 ;
"RTN","MPIFA24",60,0)
PID(ARY,MSG,FIRST) ;processing PID fields
"RTN","MPIFA24",61,0)
 N REP,PID,COMP,SUBCOMP,MPIDFN,MPISSN,ICN
"RTN","MPIFA24",62,0)
 S REP=$E(HL("ECH"),2),COMP=$E(HL("ECH"),1),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA24",63,0)
 S MPISSN="",MPIDFN=""
"RTN","MPIFA24",64,0)
 D PIDPROC^MPIFA43(.ICN,.MPISSN,.MPIDFN,.PID)
"RTN","MPIFA24",65,0)
 I FIRST=1 S ARY(991.01)=+ICN,ARY(991.02)=$P(ICN,"V",2)
"RTN","MPIFA24",66,0)
 S ARY("ICN",FIRST)=ICN
"RTN","MPIFA24",67,0)
 S ARY("SSN",FIRST)=MPISSN
"RTN","MPIFA24",68,0)
 S ARY("DFN",FIRST)=MPIDFN
"RTN","MPIFA24",69,0)
 Q
"RTN","MPIFA24",70,0)
 ;
"RTN","MPIFA24",71,0)
PD1(ARY,MSG) ;processing PD1 fields
"RTN","MPIFA24",72,0)
 N COMP
"RTN","MPIFA24",73,0)
 S COMP=$E(HL("ECH"),1)
"RTN","MPIFA24",74,0)
 S ARY(991.03)=$P($P(HLNODE,HL("FS"),4),COMP,3)
"RTN","MPIFA24",75,0)
 Q
"RTN","MPIFA24",76,0)
 ;
"RTN","MPIFA24",77,0)
PROC ;
"RTN","MPIFA24",78,0)
 N NXT,DFN
"RTN","MPIFA24",79,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA24",80,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA24",81,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA24",82,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA24",83,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA24",84,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA24",85,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA24",86,0)
 K ^XTMP("MPIFA24%"_DFN)
"RTN","MPIFA24",87,0)
 Q
"RTN","MPIFA31B")
0^8^B5415101
"RTN","MPIFA31B",1,0)
MPIFA31B ;BP/CMC-BUILD A31 MSGS ;FEB 5, 2002
"RTN","MPIFA31B",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,24**;30 Apr 99
"RTN","MPIFA31B",3,0)
 ;
"RTN","MPIFA31B",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFA31B",5,0)
 ;  START, EXC, STOP^RGHLLOG - #2796
"RTN","MPIFA31B",6,0)
 ;  BLDEVN, BLDPD1, BLDPID^VAFCQRY - #3630
"RTN","MPIFA31B",7,0)
 ;
"RTN","MPIFA31B",8,0)
A31(DFN) ;BUILD AND SEND A31
"RTN","MPIFA31B",9,0)
 N RESLT,CNT,MPI,EVN,TCNT,ERR,PD1,PID
"RTN","MPIFA31B",10,0)
 K HLA("HLA"),HLA("HLS")
"RTN","MPIFA31B",11,0)
 Q:$E($$GETICN^MPIF001(DFN),1,3)=$P($$SITE^VASITE(),"^",3) 0
"RTN","MPIFA31B",12,0)
 ; ^ LOCAL ICN DON'T SEND
"RTN","MPIFA31B",13,0)
 Q:+$$GETICN^MPIF001(DFN)=-1 0
"RTN","MPIFA31B",14,0)
 ; ^ NO ICN DON'T SEND
"RTN","MPIFA31B",15,0)
 S CNT=1
"RTN","MPIFA31B",16,0)
 D INIT^HLFNC2("MPIF ADT-A31 SERVER",.HL)
"RTN","MPIFA31B",17,0)
 I $O(HL(""))="" Q "-1^"_$P(HL,"^",2)
"RTN","MPIFA31B",18,0)
 S HLECH=HL("ECH"),HLFS=HL("FS"),COMP=$E(HL("ECH"),1),REP=$E(HL("ECH"),2),SUBCOMP=$E(HL("ECH"),4)
"RTN","MPIFA31B",19,0)
 S ERR="",TCNT=0
"RTN","MPIFA31B",20,0)
 D BLDEVN^VAFCQRY(DFN,"1,2",.EVN,.HL,"A31",.ERR)
"RTN","MPIFA31B",21,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",22,0)
 D BLDPID^VAFCQRY(DFN,1,"1,3,5,6,7,8,11,29",.PID,.HL,.ERR)
"RTN","MPIFA31B",23,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",24,0)
 D BLDPD1^VAFCQRY(DFN,"3",.PD1,.HL,.ERR)
"RTN","MPIFA31B",25,0)
 Q:ERR'="" ERR
"RTN","MPIFA31B",26,0)
 S HLA("HLS",1)=EVN(1)
"RTN","MPIFA31B",27,0)
 S HLA("HLS",3)=PD1(1)
"RTN","MPIFA31B",28,0)
 S CNT=0 F  S CNT=$O(PID(CNT)) Q:CNT=""  D
"RTN","MPIFA31B",29,0)
 .I CNT=1 S HLA("HLS",2)=PID(CNT)
"RTN","MPIFA31B",30,0)
 .I CNT>1 S HLA("HLS",2,CNT-1)=PID(CNT)
"RTN","MPIFA31B",31,0)
 S MPI=$$MPILINK^MPIFAPI()
"RTN","MPIFA31B",32,0)
 Q:$P($G(MPI),"^")=-1 "-1^No logical link defined for the MPI"
"RTN","MPIFA31B",33,0)
 S HLL("LINKS",1)="MPIF ADT-A31 CLIENT^"_MPI
"RTN","MPIFA31B",34,0)
 D GENERATE^HLMA("MPIF ADT-A31 SERVER","LM",1,.HLRESLT,"","")
"RTN","MPIFA31B",35,0)
 S RESLT=$S(+HLRESLT:HLRESLT,1:$P(HLRESLT,"^",3))
"RTN","MPIFA31B",36,0)
 S ^XTMP("MPIFA31%"_DFN,0)=$$FMADD^XLFDT(DT,5)_"^"_DT_"^"_"MPIA31 msg to MPI for DFN "_DFN
"RTN","MPIFA31B",37,0)
 I '+RESLT S ^XTMP("MPIFA31%"_DFN,"MPI",0)="A"
"RTN","MPIFA31B",38,0)
 K HLA,HLEID,HLL("LINKS"),HL,COMP,REP,SUBCOMP,HLECH,HLFS,HLA("HLA"),HLA("HLS"),HLRESLT
"RTN","MPIFA31B",39,0)
 Q RESLT
"RTN","MPIFA31B",40,0)
 ;
"RTN","MPIFA31B",41,0)
RES ;
"RTN","MPIFA31B",42,0)
 N NXT
"RTN","MPIFA31B",43,0)
 F NXT=1:1 X HLNEXT Q:HLQUIT'>0  D
"RTN","MPIFA31B",44,0)
 .I $E(HLNODE,1,3)="MSA" S DFN=$P($P(HLNODE,HL("FS"),7),"=",2)
"RTN","MPIFA31B",45,0)
 .I $E(HLNODE,1,3)="MSA"&($P(HLNODE,HL("FS"),4)'="") D
"RTN","MPIFA31B",46,0)
 ..; ERROR RETURNED IN MSA - LOG EXCEPTION
"RTN","MPIFA31B",47,0)
 ..D START^RGHLLOG(HLMTIEN,"","")
"RTN","MPIFA31B",48,0)
 ..D EXC^RGHLLOG(208,$P(HLNODE,HL("FS"),4)_" for HL msg# "_HLMTIEN,DFN)
"RTN","MPIFA31B",49,0)
 ..D STOP^RGHLLOG(0)
"RTN","MPIFA31B",50,0)
 K ^XTMP("MPIFA31%"_DFN)
"RTN","MPIFA31B",51,0)
 Q
"RTN","MPIFBT3")
0^5^B23491720
"RTN","MPIFBT3",1,0)
MPIFBT3 ;SLC/ARS-BATCH RESPONSE FROM MPI ;FEB 4, 1997
"RTN","MPIFBT3",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,10,17,21,24**;30 Apr 99
"RTN","MPIFBT3",3,0)
 ;
"RTN","MPIFBT3",4,0)
 ; Intergration Agreements Utilized:
"RTN","MPIFBT3",5,0)
 ;  ^DPT("AICN", ^DPT("AICNL", ^DPT("AMPIMIS" - #2070
"RTN","MPIFBT3",6,0)
 ;  EXC^RGHLLOG - #2796
"RTN","MPIFBT3",7,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFBT3",8,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFBT3",9,0)
 ;
"RTN","MPIFBT3",10,0)
MULT(CNTR,ACK5,SEP,MPIMSG,PATID) ;multiple RDT segments
"RTN","MPIFBT3",11,0)
 N NEXTTF,MPITMP S CNTR=$O(^XTMP($J,"MPIF","MPIIN",CNTR)),NEXTTF=$P(ACK5,SEP,8)
"RTN","MPIFBT3",12,0)
 S MPITMP=$O(^XTMP($J,"MPIF","MPIIN",CNTR)) Q:MPITMP'>0
"RTN","MPIFBT3",13,0)
 S ACK5=^XTMP($J,"MPIF","MPIIN",MPITMP) K NEXTTF,MPITMP
"RTN","MPIFBT3",14,0)
 I $P(ACK5,SEP)="RDT" D MULT(.CNTR,ACK5,SEP,MPIMSG,PATID) ; ^ add to treating facility list.  If not RDT continue on processing next msh
"RTN","MPIFBT3",15,0)
 Q
"RTN","MPIFBT3",16,0)
VFYRDT(ACK4,SEP,CNTR,PATID,SITE,MPIMSG) ;Here is the meat
"RTN","MPIFBT3",17,0)
 N MPIY,IEN,MPICMOR S DGSENFLG=""
"RTN","MPIFBT3",18,0)
 D FINDHM(PATID,ACK4,SEP,.MPIY,MPIMSG,CNTR)
"RTN","MPIFBT3",19,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",20,0)
 N MPINUM,MPICKG,MPIIT,DR,DIE,X,MPIIPPF,MPIPPF,RESLT
"RTN","MPIFBT3",21,0)
 S MPINUM=$P(ACK4,SEP,6),MPICKG=$P(MPINUM,"V",2),MPINUM=$P(MPINUM,"V",1)
"RTN","MPIFBT3",22,0)
 ;check if ICN already in use in Patient file
"RTN","MPIFBT3",23,0)
 I $D(^DPT("AICN",MPINUM)) D
"RTN","MPIFBT3",24,0)
 .Q:PATID=$O(^DPT("AICN",MPINUM,""))   ; same patient
"RTN","MPIFBT3",25,0)
 .S ^XTMP($J,"MPIF","MSHERR")="ICN already in use"
"RTN","MPIFBT3",26,0)
 .D EXC^RGHLLOG(227,"Patient dfn "_PATID_" returned ICN "_MPINUM_" that is already in use for Patient dfn "_$O(^DPT("AICN",MPINUM,""))_" Checkout pair to determine if a Duplicate.",PATID)
"RTN","MPIFBT3",27,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",28,0)
 S DIE="^DPT(",DA=$P(MPIY,"^",1),MPIIT=$P(MPIY,"^",1),DR="991.01////^S X=MPINUM;991.02////^S X=MPICKG" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",29,0)
 S IEN=$P(MPIY,"^") ; check if need to kill Local/MISSING ICN field
"RTN","MPIFBT3",30,0)
 I $D(^DPT("AMPIMIS",IEN)) K ^DPT("AMPIMIS",IEN)
"RTN","MPIFBT3",31,0)
 I $D(^DPT("AICNL",1,IEN)) D
"RTN","MPIFBT3",32,0)
 .S DIE="^DPT(",DA=IEN,DR="991.04///@" D ^DIE K DR,DIE,DA
"RTN","MPIFBT3",33,0)
 S MPIIPPF=""
"RTN","MPIFBT3",34,0)
 S MPIPPF=$P(ACK4,SEP,5),MPICMOR=$$LKUP^XUAF4(MPIPPF)
"RTN","MPIFBT3",35,0)
 I MPICMOR'="" S MPIIPPF=$$CHANGE^MPIF001(MPIIT,MPICMOR)
"RTN","MPIFBT3",36,0)
 I +MPIIPPF<0 D EXC^RGHLLOG(211,"Around line number "_(CNTR*2)_"  CMOR= "_MPIPPF_" DFN= "_MPIIT_"  MESSAGE# "_MPIMSG,MPIIT)
"RTN","MPIFBT3",37,0)
 Q:+MPIIPPF<0
"RTN","MPIFBT3",38,0)
 ;;D FILE^VAFCTFU(PATID,+$$SITE^VASITE)
"RTN","MPIFBT3",39,0)
 S RESLT=$$A24^MPIFA24B(PATID)
"RTN","MPIFBT3",40,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_DFN,DFN)
"RTN","MPIFBT3",41,0)
 Q
"RTN","MPIFBT3",42,0)
FINDHM(PATID,ACK4,SEP,MPIY,MPIMSG,CNTR) ;LOOKUP
"RTN","MPIFBT3",43,0)
 N DIC,X,Y,NM,YTMP,MPIN
"RTN","MPIFBT3",44,0)
 ;added I to DIC(0) allow processing of sensative patients when DUZ=0
"RTN","MPIFBT3",45,0)
 S DGSENFLG="",DIC="^DPT(",DIC(0)="OISZ",X="`"_PATID D ^DIC K DIC
"RTN","MPIFBT3",46,0)
 S YTMP=Y
"RTN","MPIFBT3",47,0)
 I YTMP=-1 S ^XTMP($J,"MPIF","MSHERR")="LOOKUP FAILED" D EXC^RGHLLOG(210,"SSN = "_$P(ACK4,SEP,3)_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",48,0)
 Q:YTMP=-1
"RTN","MPIFBT3",49,0)
 S NM=$P(Y(0),"^"),YTMP=$G(Y(0)),MPIY=Y ; check if ICN already populated
"RTN","MPIFBT3",50,0)
 N ICN S ICN=$$GETICN^MPIF001(PATID)
"RTN","MPIFBT3",51,0)
 I +ICN'=-1,$E(+ICN,1,3)'=$P($$SITE^VASITE,"^",3) S ^XTMP($J,"MPIF","MSHERR")="Patient "_PATID_" Already has an ICN"
"RTN","MPIFBT3",52,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",53,0)
 S Y(0)=$G(YTMP)
"RTN","MPIFBT3",54,0)
 Q:$P(Y(0),"^",9)["P"&($P(ACK4,SEP,3)="")
"RTN","MPIFBT3",55,0)
 I $P(Y(0),"^",9)'=$P(ACK4,SEP,3) D
"RTN","MPIFBT3",56,0)
 .S ^XTMP($J,"MPIF","MSHERR")="SSN MISMATCH"
"RTN","MPIFBT3",57,0)
 .D EXC^RGHLLOG(213,"SSN on File = "_$P(Y(0),"^",9)_" SSN in Message = "_$P(ACK4,SEP,3)_"    MESSAGE # "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",58,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ; create local ICN
"RTN","MPIFBT3",59,0)
 Q:$D(^XTMP($J,"MPIF","MSHERR"))
"RTN","MPIFBT3",60,0)
 D NAME^VAFCPID2(0,.NM,0) ; reformat name in DG 149 fashion for comparison
"RTN","MPIFBT3",61,0)
 S MPIN=$P(ACK4,SEP,2)_","_$P(ACK4,SEP,7)
"RTN","MPIFBT3",62,0)
 I $P(ACK4,SEP,10)'="" S MPIN=MPIN_" "_$P(ACK4,SEP,10)
"RTN","MPIFBT3",63,0)
 D NAME^VAFCPID2(0,.MPIN,0)
"RTN","MPIFBT3",64,0)
 I NM'=MPIN D
"RTN","MPIFBT3",65,0)
 .S ^XTMP($J,"MPIF","MSHERR")="NAME MISMATCH"
"RTN","MPIFBT3",66,0)
 .D EXC^RGHLLOG(214,"Name on File = "_$P(Y(0),"^")_"  Name in Message = "_MPIN_"  MESSAGE# "_MPIMSG_" around line number "_(CNTR*2),PATID)
"RTN","MPIFBT3",67,0)
 .N LICN S LICN=$$ICNLC^MPIF001(PATID) ;create local ICN
"RTN","MPIFBT3",68,0)
 ;check to see if MPI has Date of Death or if VistA has DOD
"RTN","MPIFBT3",69,0)
 N MPIDTH,VISTDTH
"RTN","MPIFBT3",70,0)
 I $P(ACK4,SEP,9)'="" S MPIDTH=$P(ACK4,SEP,9),MPIDTH=$$FMDATE^HLFNC(MPIDTH)\1
"RTN","MPIFBT3",71,0)
 I $D(^DPT(PATID,.35)),$P($G(^DPT(PATID,.35)),"^")'="" S VISTDTH=$P($G(^DPT(PATID,.35)),"^")\1
"RTN","MPIFBT3",72,0)
 I $D(MPIDTH)&$D(VISTDTH),MPIDTH'=VISTDTH D
"RTN","MPIFBT3",73,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y,Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",74,0)
 .D EXC^RGHLLOG(217,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",75,0)
 ; ^ BOTH HAVE DOD BUT THEY DON'T MATCH
"RTN","MPIFBT3",76,0)
 I '$D(MPIDTH)&($D(VISTDTH)) D
"RTN","MPIFBT3",77,0)
 .N Y S Y=VISTDTH D DD^%DT S VISTDTH=Y
"RTN","MPIFBT3",78,0)
 .D EXC^RGHLLOG(216,"Around line "_(CNTR*2)_" VISTA DOD= "_VISTDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",79,0)
 ; ^ VISTA HAS DOD BUT MPI DOESN'T
"RTN","MPIFBT3",80,0)
 I $D(MPIDTH)&('$D(VISTDTH)) D
"RTN","MPIFBT3",81,0)
 .N Y S Y=MPIDTH D DD^%DT S MPIDTH=Y
"RTN","MPIFBT3",82,0)
 .D EXC^RGHLLOG(215,"Around line "_(CNTR*2)_" MPI DOD= "_MPIDTH_"  DFN= "_PATID_"  MESSAGE# "_MPIMSG,PATID)
"RTN","MPIFBT3",83,0)
 ; ^ MPI HAS DOD BUT VISTA DOESN'T
"RTN","MPIFBT3",84,0)
 Q
"RTN","MPIFQ0")
0^1^B75016214
"RTN","MPIFQ0",1,0)
MPIFQ0 ;ALB/RJS-QUERY HANDLER TOP LEVEL ;JUL 11, 1997
"RTN","MPIFQ0",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,8,14,13,16,17,21,20,24**;30 Apr 99
"RTN","MPIFQ0",3,0)
 ;
"RTN","MPIFQ0",4,0)
 ; Integration Agreements utilized:
"RTN","MPIFQ0",5,0)
 ;  EXC, START and STOP^RGHLLOG - #2796
"RTN","MPIFQ0",6,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFQ0",7,0)
 ;  $$SEND2^VAFCUTL1- #2779
"RTN","MPIFQ0",8,0)
 ;  $$SEND^RGJUSITE - #3469
"RTN","MPIFQ0",9,0)
 ;  $$EN^HLCSAS - #3471
"RTN","MPIFQ0",10,0)
 ;  NAME^VAFCPID2 - #3492
"RTN","MPIFQ0",11,0)
 ;
"RTN","MPIFQ0",12,0)
INTACTV ;Interactive standalone query
"RTN","MPIFQ0",13,0)
 N DFN,NAME1,MPIFLL
"RTN","MPIFQ0",14,0)
 K DTOUT,DUOUT,X,Y,DIC
"RTN","MPIFQ0",15,0)
 S MPIFRES="",MPIFINT="",DIC="^DPT(",DIC(0)="AEMQ" D ^DIC
"RTN","MPIFQ0",16,0)
 I ($D(DTOUT))!($D(DUOUT))!((+$G(Y))<0) W:'$D(MPIFRPC) !,"TRY AGAIN LATER" G END
"RTN","MPIFQ0",17,0)
 S DFN=+Y,HLP("ACKTIME")=300
"RTN","MPIFQ0",18,0)
 W:'$D(MPIFRPC) !
"RTN","MPIFQ0",19,0)
CIRNEXC ; Exception Entry Point
"RTN","MPIFQ0",20,0)
 I $$SEND^RGJUSITE'>0 W:'$D(MPIFRPC) !,"MPI/PD Messaging Parameter Not Enabled" G END
"RTN","MPIFQ0",21,0)
 I +$$GETICN^MPIF001(DFN)>0,$$IFLOCAL^MPIF001(DFN)'=1 W:'$D(MPIFRPC) !,"Patient already has an ICN" G END
"RTN","MPIFQ0",22,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",23,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",24,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",25,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N W:'$D(MPIFRPC) !,"Patient is missing Date of Birth -- Required Field" D LOCAL(DFN) G END
"RTN","MPIFQ0",26,0)
 I $$IFLOCAL^MPIF001(DFN)=1 S MPIFLL=""
"RTN","MPIFQ0",27,0)
 I $G(LOCDATA(2,DFN,991.01))>0&('$D(MPIFLL)) W:'$D(MPIFRPC) !,"Patient already has an ICN" G END
"RTN","MPIFQ0",28,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 W:'$D(MPIFRPC) !,"Patient should not be sent to the MPI -- SSN has 5 leading 0s or name has been ZZ'd" G END
"RTN","MPIFQ0",29,0)
 I $E(LOCDATA(2,DFN,.01),1,3)="EEE" W:'$D(MPIFRPC) !,"Patient should not be sent to the MPI -- EEE patient -- update to actual Patient name" G END
"RTN","MPIFQ0",30,0)
 S HLP("ACKTIME")=300,MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",31,0)
 G JUMP
"RTN","MPIFQ0",32,0)
VTQ G:$G(DFN)']"" END
"RTN","MPIFQ0",33,0)
 I $$SEND^RGJUSITE'>0 S MPIFRTN="STOP/SUSPEND" G END
"RTN","MPIFQ0",34,0)
 N LOCDATA ;Data Returned from GETDATA in ICN array
"RTN","MPIFQ0",35,0)
 D GETDATA("^DPT(",DFN,"LOCDATA",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ0",36,0)
 S LOCDATA(2,DFN,991.01)=$P($$MPINODE^MPIFAPI(DFN),"^"),TSSN=LOCDATA(2,DFN,.09)
"RTN","MPIFQ0",37,0)
 I LOCDATA(2,DFN,.03)'?2N1"/"2N1"/"4N S MPIFRTN="MISSING DOB" D EXC^MPIFVTQ(DFN) G END
"RTN","MPIFQ0",38,0)
 S MPIQRYNM="VTQ_PID_ICN_NO_LOAD"
"RTN","MPIFQ0",39,0)
 I $G(LOCDATA(2,DFN,991.01))>0 S MPIFRTN="ALREADY HAS ICN" G END ;If Pt already has ICN don't connect to MPI
"RTN","MPIFQ0",40,0)
 I +$$SEND2^VAFCUTL1(DFN,"T")=1 S MPIFRTN="TEST" G END
"RTN","MPIFQ0",41,0)
JUMP N TIME,% D NOW^%DTC S TIME=%
"RTN","MPIFQ0",42,0)
 ;Initialization for call to MPIVTQ
"RTN","MPIFQ0",43,0)
 N HL,MPIINM,MPIOUT,MPIIN,MPIMCNT,MPICNT,MPICS,HEADER,TEST,SITE,MPIDC
"RTN","MPIFQ0",44,0)
 I $G(HLP("ACKTIME"))="" S HLP("ACKTIME")=30 ;If the HLP("ACKTIME") is not already set for the D/C
"RTN","MPIFQ0",45,0)
 S HL("ECH")="^~\&",HL("FS")="|"
"RTN","MPIFQ0",46,0)
 I '$D(MPIQRYNM) S MPIQRYNM="VTQ_PID_ICN"
"RTN","MPIFQ0",47,0)
 S MPIIN="",MPIMCNT=DFN,MPICNT=1,MPICS=$E(HL("ECH"),1)
"RTN","MPIFQ0",48,0)
 D VTQ1^MPIFVTQ(DFN,.MPIOUT,.HL,.MPIQRYNM,"00108.1;00108.2;00110;00122")
"RTN","MPIFQ0",49,0)
 ;If call to VTQ1^MPIFVTQ returns '-1^error code', log error and exit
"RTN","MPIFQ0",50,0)
 I +MPIOUT(0)=-1 D  G EXIT
"RTN","MPIFQ0",51,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=$G(MPIOUT(0)),MPIFRTN="CONTINUE"
"RTN","MPIFQ0",52,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Patient should NOT be sent to the MPI for ICN assignment"
"RTN","MPIFQ0",53,0)
 ;Create MSH
"RTN","MPIFQ0",54,0)
 S SITE=$$SITE^VASITE,SITE=$P(SITE,"^",3),SITE=SITE\1,HEADER="MSH"_HL("FS")_HL("ECH")_HL("FS")_"MPI_LOAD"_HL("FS")_SITE_HL("FS")
"RTN","MPIFQ0",55,0)
 S HEADER=HEADER_"MPI-ICN"_HL("FS")_HL("FS")_HL("FS")_HL("FS")_"VTQ"_MPICS_"Q02"_HL("FS")_MPIMCNT_"-"_MPICNT_HL("FS")
"RTN","MPIFQ0",56,0)
 S MPIOUT(1)=HEADER K MPIOUT(0)
"RTN","MPIFQ0",57,0)
 ;Attempt to connect to MPI and send message,receive message.
"RTN","MPIFQ0",58,0)
 I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Attempting to connect to the Master Patient Index in Austin...",!,"If no SSN or inexact DOB or common name, this request",!,"may take some time, please be patient...",!
"RTN","MPIFQ0",59,0)
 S TEST=$$EN^HLCSAC("MPIVA DIR","MPIOUT","MPIDC")
"RTN","MPIFQ0",60,0)
 K HLP("ACKTIME") ;kill the HLP array set for the ack timeout
"RTN","MPIFQ0",61,0)
 ;Can't connect to MPI, assign a local ICN, this site as CMOR, and continue with Registration
"RTN","MPIFQ0",62,0)
 I +TEST=-1 D  G EXIT
"RTN","MPIFQ0",63,0)
 .S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)=TEST
"RTN","MPIFQ0",64,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Could not connect to MPI or Timed Out, assigning local ICN (if not already assigned)..."
"RTN","MPIFQ0",65,0)
 .D LOCAL(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",66,0)
 K ^TMP("MPIFQ0",$J) ;array data is parsed into for display in LM
"RTN","MPIFQ0",67,0)
INIPARS N SEG,INDEX,COUNTER,LASTSSN,FIRST
"RTN","MPIFQ0",68,0)
 S INDEX=0,COUNTER=1,FIRST=1
"RTN","MPIFQ0",69,0)
PARSE S SEG=$$SEG^MPIFAPI("RDT",1,"RDT")
"RTN","MPIFQ0",70,0)
 I $G(SEG)'="" D  G PARSE
"RTN","MPIFQ0",71,0)
 .N LASTNAME,FRSTNAME,SSN,BIRTHDAY,CMOR,STRING,NAME,TF,ICN,HEREICN,HERESSN,MIDDLE,IEN,F,SUFF,SEX
"RTN","MPIFQ0",72,0)
 .S STRING="",FRSTNAME=$P(SEG,HL("FS"),7),LASTNAME=$P(SEG,HL("FS"),2),MIDDLE=$P(SEG,HL("FS"),10),SUFF=$P(SEG,HL("FS"),15)
"RTN","MPIFQ0",73,0)
 .S (LASTSSN,SSN)=$P(SEG,HL("FS"),3),NAME=LASTNAME_","_FRSTNAME
"RTN","MPIFQ0",74,0)
 .I MIDDLE'="" S NAME=NAME_" "_MIDDLE
"RTN","MPIFQ0",75,0)
 .I SUFF'="" S NAME=NAME_" "_SUFF
"RTN","MPIFQ0",76,0)
 .S SEX=$P(SEG,HL("FS"),11)
"RTN","MPIFQ0",77,0)
 .S ICN=$P(SEG,HL("FS"),6)
"RTN","MPIFQ0",78,0)
 .I $D(FICN) I FICN'=ICN S FIRST=1,FICN=ICN
"RTN","MPIFQ0",79,0)
 .I FIRST=1 S FICN=ICN
"RTN","MPIFQ0",80,0)
 .S FIRST=FIRST+1,CMOR=$P(SEG,HL("FS"),5),CCMOR=CMOR
"RTN","MPIFQ0",81,0)
 .I $G(CMOR)'="" S IEN=$$LKUP^XUAF4(CMOR) I IEN'="" S CMOR=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",82,0)
 .S TF=$P(SEG,HL("FS"),8)
"RTN","MPIFQ0",83,0)
 .I $G(TF)'="" S IEN=$$LKUP^XUAF4(TF) I IEN>0 S TF=$P($$NS^XUAF4(+IEN),"^")
"RTN","MPIFQ0",84,0)
 .;Same patient just adding TF's
"RTN","MPIFQ0",85,0)
 .I TF'="",ICN=FICN,FIRST'=2 S COUNTER=COUNTER+1,^TMP("MPIFQ0",$J,INDEX,COUNTER)=TF_"^"_IEN
"RTN","MPIFQ0",86,0)
 .Q:(ICN=FICN)&(FIRST>2)
"RTN","MPIFQ0",87,0)
 .S BIRTHDAY=$P(SEG,HL("FS"),4)
"RTN","MPIFQ0",88,0)
 .I $G(LASTNAME)="" Q
"RTN","MPIFQ0",89,0)
 .I $G(BIRTHDAY)]"" S BIRTHDAY=$$FMDATE^HLFNC(BIRTHDAY),BIRTHDAY=$TR($$FMTE^XLFDT(BIRTHDAY,"5D"),"/","-")
"RTN","MPIFQ0",90,0)
 .;New pt. so incrementing index and resetting counter
"RTN","MPIFQ0",91,0)
 .S INDEX=INDEX+1,COUNTER=1,HEREICN=$$HEREICN($P(ICN,"V",1))
"RTN","MPIFQ0",92,0)
 .I HEREICN S STRING=$$SETSTR^VALM1("*",STRING,1,1),^TMP("MPIFQ0",$J,INDEX,"INDICATOR")="*"_"^"_HEREICN
"RTN","MPIFQ0",93,0)
 .S STRING=$$SETSTR^VALM1(INDEX,STRING,2,4),STRING=$$SETSTR^VALM1($E(NAME,1,23),STRING,6,23)
"RTN","MPIFQ0",94,0)
 .S STRING=$$SETSTR^VALM1(SSN,STRING,30,9),STRING=$$SETSTR^VALM1(BIRTHDAY,STRING,41,10)
"RTN","MPIFQ0",95,0)
 .S STRING=$$SETSTR^VALM1(CMOR,STRING,54,20)
"RTN","MPIFQ0",96,0)
 .S ^TMP("MPIFQ0",$J,INDEX,0)=STRING,^TMP("MPIFQ0",$J,"IDX",INDEX,INDEX)=""
"RTN","MPIFQ0",97,0)
 .S ^TMP("MPIFQ0",$J,INDEX,"DATA")=NAME_"^"_SSN_"^"_BIRTHDAY_"^"_ICN_"^"_CMOR_"^"_TF_"^"_CCMOR_"^"_SEX
"RTN","MPIFQ0",98,0)
 .S (VALMCNT,VALMLST)=INDEX
"RTN","MPIFQ0",99,0)
 .S ^TMP("MPIFQ0",$J,INDEX,"HOLD")=SEG
"RTN","MPIFQ0",100,0)
DECIDE ;If no data in ^TMP that means the patient was not found in the MPI
"RTN","MPIFQ0",101,0)
 ;with the VTQ Query. So we go to A28 to add the patient to the MPI.
"RTN","MPIFQ0",102,0)
 I '$D(^TMP("MPIFQ0",$J)) D  G EXIT
"RTN","MPIFQ0",103,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Patient was not found in the MPI..."
"RTN","MPIFQ0",104,0)
 .D A28(DFN) S MPIFRTN="DID A28"
"RTN","MPIFQ0",105,0)
 ;If INDEX=1 it means we got 1 match. So we check the SSN to see if it's definitely the same patient.
"RTN","MPIFQ0",106,0)
 I (INDEX=1)&(TSSN=LASTSSN) D  G EXIT
"RTN","MPIFQ0",107,0)
 .N CMOR,ICN,DATA,TICN,SNM,SNM2
"RTN","MPIFQ0",108,0)
 .S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA"),CMOR=CCMOR,ICN=$P(DATA,"^",4)
"RTN","MPIFQ0",109,0)
 .D START^RGHLLOG(0)
"RTN","MPIFQ0",110,0)
 .S TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",111,0)
 .I TICN>0,DFN'=TICN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_$$GETDFN^MPIF001(+ICN)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ0",112,0)
 .I TICN>0&(DFN'=TICN)
"RTN","MPIFQ0",113,0)
 .; CHECK IF NAME IS SAME - IF NOT POTENTIAL MATCH EXCEPTION
"RTN","MPIFQ0",114,0)
 .S SNM=LOCDATA(2,DFN,.01) D NAME^VAFCPID2(DFN,.SNM,0) ;reformat name to DG 149 standard
"RTN","MPIFQ0",115,0)
 .S SNM2=$P(DATA,"^") D NAME^VAFCPID2(0,.SNM2,0) S $P(DATA,"^")=SNM2
"RTN","MPIFQ0",116,0)
 .I $P(DATA,"^")'=SNM D  Q
"RTN","MPIFQ0",117,0)
 ..I $D(MPIFINT) D START^MPIFQ1(INDEX) Q
"RTN","MPIFQ0",118,0)
 ..I '$D(MPIFINT) D LOC2(DFN) Q
"RTN","MPIFQ0",119,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Found Patient "_$G(LOCDATA(2,DFN,.01))_" in MPI, updating ICN and CMOR..."
"RTN","MPIFQ0",120,0)
 .D STOP^RGHLLOG(0),UPDATE(DFN,ICN,CMOR)
"RTN","MPIFQ0",121,0)
 .S MPIFRTN="GOT 1 HIT FROM MPI"
"RTN","MPIFQ0",122,0)
 I '$D(MPIFINT) D  G EXIT
"RTN","MPIFQ0",123,0)
 .; came in via PIMS options to d/c with MPI
"RTN","MPIFQ0",124,0)
 .I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Potential Matches Found, Assigning Local ICN..."
"RTN","MPIFQ0",125,0)
 .D START^RGHLLOG(0),EXC^RGHLLOG(218,"For Patient DFN="_DFN_".  Use Single Patient Initialization to MPI option to manually process.",DFN),STOP^RGHLLOG(0)
"RTN","MPIFQ0",126,0)
 .D LOCAL(DFN) S MPIFRTN="ASSIGNING LOCAL"
"RTN","MPIFQ0",127,0)
 D START^MPIFQ1(INDEX) G END
"RTN","MPIFQ0",128,0)
EXIT I $D(MPIFINT) K MPIFINT,MPIFRES,MPIQRYNM,TSSN
"RTN","MPIFQ0",129,0)
 K VALMCNT,VALMLST
"RTN","MPIFQ0",130,0)
 K CCMOR,FICN H 3 W:'$D(MPIFRPC) !!
"RTN","MPIFQ0",131,0)
END Q
"RTN","MPIFQ0",132,0)
A28(DFN) ; *** CHANGED FOR PATCH 24 TO USE NEW MESSAGING
"RTN","MPIFQ0",133,0)
 S ICN=$$A28^MPIFA28(DFN)
"RTN","MPIFQ0",134,0)
 I +ICN>0 I '$D(MPIFS) W:'$D(MPIFRPC) !!,"Message sent to MPI requesting Patient to be added." Q
"RTN","MPIFQ0",135,0)
 Q
"RTN","MPIFQ0",136,0)
UPDATE(DFN,ICN,CMOR) ;
"RTN","MPIFQ0",137,0)
 N TICN,CHKSUM,SETICN,SETLOC,CHANGE,RGLOG,LOCAL
"RTN","MPIFQ0",138,0)
 D START^RGHLLOG(0)
"RTN","MPIFQ0",139,0)
 S CHKSUM=$P(ICN,"V",2),ICN=$P(ICN,"V",1),TICN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",140,0)
 I TICN>0,TICN'=DFN D EXC^RGHLLOG(227,"Patient dfn "_DFN_" returned ICN "_+ICN_" that is already in use for Patient dfn "_TICN_" Checkout pair to determine if a Duplicate.",DFN) D STOP^RGHLLOG(0) Q
"RTN","MPIFQ0",141,0)
 S SETICN=$$SETICN^MPIF001(DFN,ICN,CHKSUM)
"RTN","MPIFQ0",142,0)
 I +SETICN'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET ICN IN MPIFQ0" Q
"RTN","MPIFQ0",143,0)
 S SETLOC=1,LOCAL="N"
"RTN","MPIFQ0",144,0)
 I $G(LOCAL)="Y" S SETLOC=$$SETLOC^MPIF001(DFN,1)
"RTN","MPIFQ0",145,0)
 I $G(LOCAL)'="Y" S SETLOC=$$SETLOC^MPIF001(DFN,0)
"RTN","MPIFQ0",146,0)
 I +SETLOC'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SETLOC IN MPIFQ0" Q
"RTN","MPIFQ0",147,0)
 N CMOR1 S CMOR1=$$LKUP^XUAF4(CMOR)
"RTN","MPIFQ0",148,0)
 I CMOR1'="" S CHANGE=$$CHANGE^MPIF001(DFN,CMOR1)
"RTN","MPIFQ0",149,0)
 I CMOR1="" S CHANGE=-1
"RTN","MPIFQ0",150,0)
 I $G(LOCAL)="Y" S CHANGE=$$CHANGE^MPIF001(DFN,$P($$SITE^VASITE,"^"))
"RTN","MPIFQ0",151,0)
 I +CHANGE'>0 S ^TMP($J,"MPIFQ0-ERROR-LOG",DFN,TIME)="COULD NOT SET CMOR IN MPIFQ0" Q
"RTN","MPIFQ0",152,0)
 Q:$G(LOCAL)="Y"
"RTN","MPIFQ0",153,0)
 ;;;N HERE S HERE=+$P($$SITE^VASITE,"^",3) D FILE^VAFCTFU(DFN,+$$SITE^VASITE)
"RTN","MPIFQ0",154,0)
 N RESLT S RESLT=$$A24^MPIFA24B(DFN)
"RTN","MPIFQ0",155,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_DFN,DFN)
"RTN","MPIFQ0",156,0)
 Q
"RTN","MPIFQ0",157,0)
LOCAL(DFN) ;
"RTN","MPIFQ0",158,0)
 Q:+$$GETICN^MPIF001(DFN)>0
"RTN","MPIFQ0",159,0)
 N ICN S ICN=$$ICNLC^MPIF001(DFN) ;don't assign local if exists
"RTN","MPIFQ0",160,0)
 Q
"RTN","MPIFQ0",161,0)
HEREICN(ICN) ;
"RTN","MPIFQ0",162,0)
 Q:$G(ICN)="" 0
"RTN","MPIFQ0",163,0)
 N DFN S DFN=$$GETDFN^MPIF001(+ICN)
"RTN","MPIFQ0",164,0)
 Q:$G(DFN)'>0 0
"RTN","MPIFQ0",165,0)
 Q DFN
"RTN","MPIFQ0",166,0)
GETDATA(DIC,DA,MPIFAR,DR,EI) ;
"RTN","MPIFQ0",167,0)
 ;This function returns the values stored in the fields via FM call DIQ1
"RTN","MPIFQ0",168,0)
 ;DIC is the file reference, DA is the file entry IEN, ARRAY is the
"RTN","MPIFQ0",169,0)
 ;storage array for the values to be stored in, DR are the fields
"RTN","MPIFQ0",170,0)
 ;requested, EI is external/internal values of the fields or don't
"RTN","MPIFQ0",171,0)
 ;return null values
"RTN","MPIFQ0",172,0)
 N DIQ S DIQ=MPIFAR
"RTN","MPIFQ0",173,0)
 I $G(EI)]"" S DIQ(0)=EI
"RTN","MPIFQ0",174,0)
 D EN^DIQ1
"RTN","MPIFQ0",175,0)
 Q
"RTN","MPIFQ0",176,0)
LOC2(DFN) ;
"RTN","MPIFQ0",177,0)
 W:'$D(MPIFRPC) !!,"Potential Match Found Assigning Local ICN"
"RTN","MPIFQ0",178,0)
 D START^RGHLLOG(),EXC^RGHLLOG(218,"For Patient DFN="_DFN_" Use Single Patient Initialization to MPI option to manually process",DFN),STOP^RGHLLOG()
"RTN","MPIFQ0",179,0)
 D LOCAL(DFN)
"RTN","MPIFQ0",180,0)
 Q
"RTN","MPIFQ1")
0^10^B87066805
"RTN","MPIFQ1",1,0)
MPIFQ1 ;ALB/RJS-CIRN QUERY HANDLER ;JUN 30, 1997
"RTN","MPIFQ1",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,8,12,16,17,21,23,24**;30 Apr 99
"RTN","MPIFQ1",3,0)
 ;
"RTN","MPIFQ1",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFQ1",5,0)
 ;   EXC, START, STOP^RGHLLOG - #2796
"RTN","MPIFQ1",6,0)
 ;   FILE^VAFCTFU - #2988
"RTN","MPIFQ1",7,0)
 ;   ^DPT("AICN" - #2070
"RTN","MPIFQ1",8,0)
 ;   NAME^VAFCPID2 - #3492
"RTN","MPIFQ1",9,0)
 ;   EN1^XWB2HL7 - #3144
"RTN","MPIFQ1",10,0)
 ;   RTNDATA^XWBDRPC - #3149
"RTN","MPIFQ1",11,0)
 ;   VAFC REMOTE PDAT (RPC) - #3496
"RTN","MPIFQ1",12,0)
 ;
"RTN","MPIFQ1",13,0)
INIT ;Entry point for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",14,0)
 Q
"RTN","MPIFQ1",15,0)
HDR ;Header code for List Manager Template - MPIF REAL-TIME QUERY
"RTN","MPIFQ1",16,0)
 N SSN,DOB,MPIFQ1,NAME1,SEX
"RTN","MPIFQ1",17,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.03;.09;.02","EI")
"RTN","MPIFQ1",18,0)
 S NAME1=$G(MPIFQ1(2,DFN,.01,"E")),SSN=$G(MPIFQ1(2,DFN,.09,"E"))
"RTN","MPIFQ1",19,0)
 S DOB=$G(MPIFQ1(2,DFN,.03,"I")),SEX=$G(MPIFQ1(2,DFN,.02,"E"))
"RTN","MPIFQ1",20,0)
 I DOB]"" S DOB=$TR($$FMTE^XLFDT(DOB,"5D"),"/","-")
"RTN","MPIFQ1",21,0)
 S VALMHDR(1)=" Possible MPI Matches for Patient: "_IOINHI_NAME1_IOINORM
"RTN","MPIFQ1",22,0)
 S VALMHDR(2)="                              SSN: "_IOINHI_SSN_IOINORM
"RTN","MPIFQ1",23,0)
 S VALMHDR(3)="                              DOB: "_IOINHI_DOB_IOINORM
"RTN","MPIFQ1",24,0)
 S VALMHDR(4)="                              SEX: "_IOINHI_SEX_IOINORM
"RTN","MPIFQ1",25,0)
 S VALMHDR(5)=" "
"RTN","MPIFQ1",26,0)
 Q
"RTN","MPIFQ1",27,0)
START(INDEX) ;Starting entry point for envoking the List Manager Template MPIF Real-time query
"RTN","MPIFQ1",28,0)
 S VALMCNT=INDEX
"RTN","MPIFQ1",29,0)
 D EN^VALM("MPIF REAL-TIME QUERY")
"RTN","MPIFQ1",30,0)
 Q
"RTN","MPIFQ1",31,0)
SELECT N VALMY
"RTN","MPIFQ1",32,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",33,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",34,0)
 N DATA,INDEX,ICN,CHKSUM,NODE2,HERESSN
"RTN","MPIFQ1",35,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",36,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ1",37,0)
 S NODE2=$G(^TMP("MPIFQ0",$J,INDEX,"INDICATOR"))
"RTN","MPIFQ1",38,0)
 S DATA(.01)=$P(DATA,"^",1) I $E(DATA(.01),$L(DATA(.01)))=" " S DATA(.01)=$E(DATA(.01),1,$L(DATA(.01))-1) ;NAME
"RTN","MPIFQ1",39,0)
 S DATA(.03)=$P(DATA,"^",3) ;DOB
"RTN","MPIFQ1",40,0)
 S DATA(.09)=$P(DATA,"^",2) ;SSN
"RTN","MPIFQ1",41,0)
 S DATA(.02)=$P(DATA,"^",8) ;SEX
"RTN","MPIFQ1",42,0)
 S ICN=$P(DATA,"^",4),CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ1",43,0)
 S ICN=$P(ICN,"V",1) ;ICN
"RTN","MPIFQ1",44,0)
 S DATA(991.01)=ICN
"RTN","MPIFQ1",45,0)
 S DATA(991.02)=CHKSUM ;CHKSUM
"RTN","MPIFQ1",46,0)
 S DATA(991.03)=$$LKUP^XUAF4($P(DATA,"^",7)) ;CMOR
"RTN","MPIFQ1",47,0)
 ;
"RTN","MPIFQ1",48,0)
 ;If NODE2["*" it means we got a match on ICN for a patient in our
"RTN","MPIFQ1",49,0)
 ;list, with a patient in our local database. Since we don't allow more 
"RTN","MPIFQ1",50,0)
 ;than one patient to have the same ICN, we log an Exception and assign 
"RTN","MPIFQ1",51,0)
 ;a Local ICN for this patient.
"RTN","MPIFQ1",52,0)
 I NODE2["*",$O(^DPT("AICN",ICN,""))'=DFN D  Q
"RTN","MPIFQ1",53,0)
 .D CLEAR^VALM1,MSG1,START^RGHLLOG()
"RTN","MPIFQ1",54,0)
 .D EXC^RGHLLOG(227,"Attempted to assign same ICN to Patient DFN "_DFN_". ICN is already used for Name: "_DATA(.01)_" SSN: "_DATA(.09)_" DOB: "_DATA(.03)_" Checkout pair to determine if a Duplicate.",DFN)
"RTN","MPIFQ1",55,0)
 .D STOP^RGHLLOG(0)
"RTN","MPIFQ1",56,0)
 .W !!,"Assigning Local ICN"
"RTN","MPIFQ1",57,0)
 .D LOCAL^MPIFQ0(DFN),PROMPT
"RTN","MPIFQ1",58,0)
 .S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",59,0)
 ;
"RTN","MPIFQ1",60,0)
 ;User selected one from the list that doesn't exist already in this
"RTN","MPIFQ1",61,0)
 ; Patient file. Does SSN and Name match?  If no - ask if they are sure 
"RTN","MPIFQ1",62,0)
 ; before updating ICN and CMOR fields
"RTN","MPIFQ1",63,0)
 N SSN,NAME,SEX
"RTN","MPIFQ1",64,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"MPIFQ1",".01;.09;.02","EI")
"RTN","MPIFQ1",65,0)
 S SSN=$G(MPIFQ1(2,DFN,.09,"E")),NAME=$G(MPIFQ1(2,DFN,.01,"E"))
"RTN","MPIFQ1",66,0)
 S SEX=$G(MPIFQ1(2,DFN,.02,"I"))
"RTN","MPIFQ1",67,0)
 ; if sex doesn't match -- not allowed to update ICN
"RTN","MPIFQ1",68,0)
 I DATA(.02)'=SEX W !!,"Sex for these two patients doesn't match -- Can't select this patient until",!,"Sex matches between the MPI and your site.  No action will be taken." D PROMPT S VALMBCK="R" Q
"RTN","MPIFQ1",69,0)
 I SSN["P" S SSN=""
"RTN","MPIFQ1",70,0)
 I DATA(.09)'=SSN W !!,"SSN for these two patients doesn't match -- Can't select this patient until",!,"SSN matches between the MPI and your site.  No action will be taken." D PROMPT S VALMBCK="R" Q
"RTN","MPIFQ1",71,0)
 ;Name, SSN and Sex match on site and MPI -- Update ICN and CMOR
"RTN","MPIFQ1",72,0)
 D NAME^VAFCPID2(0,.NAME,0) ;reformat name into DG 149 format
"RTN","MPIFQ1",73,0)
 N NAME3 S NAME3=DATA(.01)
"RTN","MPIFQ1",74,0)
 D NAME^VAFCPID2(0,.NAME3,0) S DATA(.01)=NAME3 ;reformat name into DG 149 format
"RTN","MPIFQ1",75,0)
 I DATA(.01)=NAME K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") D MSG3,PROMPT,TF(DFN,.DATA) Q
"RTN","MPIFQ1",76,0)
 ;
"RTN","MPIFQ1",77,0)
 ;Name doesn't match exactly - ask if sure
"RTN","MPIFQ1",78,0)
 D CLEAR^VALM1,MSG2
"RTN","MPIFQ1",79,0)
 D MSG(SSN,NAME,DATA(.09),DATA(.01))
"RTN","MPIFQ1",80,0)
 N ANS S ANS=$$PROMPT1()
"RTN","MPIFQ1",81,0)
 I ANS K DATA(.09),DATA(.01),DATA(.03) D EDIT^MPIFQED(DFN,"DATA") S MPIFRTN="CONTINUE" W !!,"ICN and CMOR Updated" D PROMPT,TF(DFN,.DATA) Q
"RTN","MPIFQ1",82,0)
 D MSG5,PROMPT
"RTN","MPIFQ1",83,0)
 S VALMBCK="R"
"RTN","MPIFQ1",84,0)
 Q
"RTN","MPIFQ1",85,0)
ADD ;Add List Manager Action (MPIF REAL-TIME QUERY (ADD PATIENT)) to add
"RTN","MPIFQ1",86,0)
 ; patient to the MPI Austin.
"RTN","MPIFQ1",87,0)
 D A28^MPIFQ0(DFN)
"RTN","MPIFQ1",88,0)
 D PROMPT
"RTN","MPIFQ1",89,0)
 S MPIFRTN="CONTINUE"
"RTN","MPIFQ1",90,0)
 Q
"RTN","MPIFQ1",91,0)
MPIPD ; MPI PDAT CALL
"RTN","MPIFQ1",92,0)
 N VALMY
"RTN","MPIFQ1",93,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",94,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",95,0)
 N DATA,INDEX,ICN,CHKSUM,CMOR,CASE,CMOR3,TTF
"RTN","MPIFQ1",96,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",97,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",98,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"HOLD")
"RTN","MPIFQ1",99,0)
 S CMOR=$P(DATA,HL("FS"),5),CMOR3=CMOR,CMOR=$P($$NS^XUAF4($$LKUP^XUAF4(CMOR)),"^")
"RTN","MPIFQ1",100,0)
 W !,"MPI Data:",!!
"RTN","MPIFQ1",101,0)
 W !,?3,"ICN: ",+$P(DATA,HL("FS"),6),?30,"CMOR: ",CMOR," (",CMOR3,")"
"RTN","MPIFQ1",102,0)
 W !,?2,"NAME: ",$P(DATA,HL("FS"),2)_","_$P(DATA,HL("FS"),7)_" "
"RTN","MPIFQ1",103,0)
 I $P(DATA,HL("FS"),10)'="" W $P(DATA,HL("FS"),10)_" "
"RTN","MPIFQ1",104,0)
 I $P(DATA,HL("FS"),15)'="" W $P(DATA,HL("FS"),15)
"RTN","MPIFQ1",105,0)
 W !,?3,"SSN: ",$P(DATA,HL("FS"),3),?30,"SEX: ",$P(DATA,HL("FS"),11)
"RTN","MPIFQ1",106,0)
 N Y S Y=""
"RTN","MPIFQ1",107,0)
 I $P(DATA,HL("FS"),4)'="" S Y=$$HL7TFM^XLFDT($P(DATA,HL("FS"),4)) D DD^%DT
"RTN","MPIFQ1",108,0)
 W !,?3,"DOB: ",Y
"RTN","MPIFQ1",109,0)
 S Y="" I $P(DATA,HL("FS"),9)'="" S Y=$$HL7TFM^XLFDT($P(DATA,HL("FS"),9)) D DD^%DT
"RTN","MPIFQ1",110,0)
 W ?30,"DOD: ",Y
"RTN","MPIFQ1",111,0)
 I ($P(DATA,HL("FS"),12)='"")&($P(DATA,HL("FS"),13)'="") W !,?2,"PLACE OF BIRTH: ",$P(DATA,HL("FS"),12),", ",$P(DATA,HL("FS"),13)
"RTN","MPIFQ1",112,0)
 I $P(DATA,HL("FS"),12)=""!($P(DATA,HL("FS"),13)="") W !,?2,"PLACE OF BIRTH: ",$P(DATA,HL("FS"),12)," ",$P(DATA,HL("FS"),13)
"RTN","MPIFQ1",113,0)
 W !,?2,"MOTHER'S MAIDEN NAME: ",$P(DATA,HL("FS"),16)
"RTN","MPIFQ1",114,0)
 W !,?2,"CLAIM NUMBER: ",$P(DATA,HL("FS"),17)
"RTN","MPIFQ1",115,0)
 S CASE=$P(DATA,HL("FS"),18)
"RTN","MPIFQ1",116,0)
 I CASE'="" W !,?2,"Open Data Management Case",!,?5,"CASE#: ",$P(CASE,"/")_"   NOIS#: ",$P(CASE,"/",2),!,?5,"CASE WORKER: ",$P(CASE,"/",3)
"RTN","MPIFQ1",117,0)
 S TTF=$P(DATA,HL("FS"),8)
"RTN","MPIFQ1",118,0)
 I TTF'=""&($P(TTF,"~",2)'="") D
"RTN","MPIFQ1",119,0)
 .W !,?2,"TREATING FACILITY LIST:"
"RTN","MPIFQ1",120,0)
 .N XX,TMP F XX=1:1:128 S TMP=$P(TTF,"~",XX) Q:TMP=""  I TMP'=CMOR3 W !?10,"Treating Facility: ",$P($$NS^XUAF4($$LKUP^XUAF4(TMP)),"^")," (",TMP,")"
"RTN","MPIFQ1",121,0)
 .I XX>25 W !!,"There maybe more Treating Facilities, only the first 25 will be displayed."
"RTN","MPIFQ1",122,0)
 D PROMPT
"RTN","MPIFQ1",123,0)
 S VALMBCK="R"
"RTN","MPIFQ1",124,0)
 Q
"RTN","MPIFQ1",125,0)
CMOR ; CMOR PDAT CALL
"RTN","MPIFQ1",126,0)
 N VALMY,DATA,INDEX,ICN,CHKSUM,CMOR
"RTN","MPIFQ1",127,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","MPIFQ1",128,0)
 I '$D(VALMY) Q
"RTN","MPIFQ1",129,0)
 S INDEX=$O(VALMY(0))
"RTN","MPIFQ1",130,0)
 S DATA=^TMP("MPIFQ0",$J,INDEX,"DATA")
"RTN","MPIFQ1",131,0)
 S ICN=$P(DATA,"^",4),CHKSUM=$P(ICN,"V",2)
"RTN","MPIFQ1",132,0)
 S ICN=$P(ICN,"V",1) ;ICN
"RTN","MPIFQ1",133,0)
 S CMOR=$P(DATA,"^",7) ;CMOR
"RTN","MPIFQ1",134,0)
 ;
"RTN","MPIFQ1",135,0)
 I CMOR=$P($$SITE^VASITE(),"^",3) W !!,"CMOR is your site" G END
"RTN","MPIFQ1",136,0)
 ;
"RTN","MPIFQ1",137,0)
 W !,"Please be patient while the data is being retrieved from the CMOR."
"RTN","MPIFQ1",138,0)
 D EN1^XWB2HL7(.RETURN,CMOR,"VAFC REMOTE PDAT",1,ICN,"")  ; Request 
"RTN","MPIFQ1",139,0)
 S ^XTMP("MPIFPDAT"_ICN,0)=$$FMADD^XLFDT(DT,2)_"^"_DT_"^"_"REMOTE PDAT QUERY"
"RTN","MPIFQ1",140,0)
 S ^XTMP("MPIFPDAT"_ICN,1)=RETURN(0)_"^"_$$NOW^XLFDT
"RTN","MPIFQ1",141,0)
 S CNT=0
"RTN","MPIFQ1",142,0)
AGAIN1 H 2 K RES1 D RTNDATA^XWBDRPC(.RES1,RETURN(0)) S CNT=CNT+1
"RTN","MPIFQ1",143,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT<11 G AGAIN1
"RTN","MPIFQ1",144,0)
 I +RES1(0)=-1&(RES1(0)["Not DONE") I CNT>10 W !,"Unable to get data" G END
"RTN","MPIFQ1",145,0)
 I RES1(0)="0^New" I CNT<11 G AGAIN1
"RTN","MPIFQ1",146,0)
 I RES1(0)="0^New" I CNT>10 W !,"Unable to get data" G END
"RTN","MPIFQ1",147,0)
 I +RES1(0)=-1 W !!,$P(RES1(0),"^",2) G END
"RTN","MPIFQ1",148,0)
 I RES1'="" I CNT<11 G AGAIN1
"RTN","MPIFQ1",149,0)
 I RES1'="" I CNT>10 W !,"Unable to get data" Q
"RTN","MPIFQ1",150,0)
 ;
"RTN","MPIFQ1",151,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",152,0)
 N NUM
"RTN","MPIFQ1",153,0)
 S NUM="",CNT=0
"RTN","MPIFQ1",154,0)
 F  S NUM=$O(RES1(NUM)) Q:NUM=""  D
"RTN","MPIFQ1",155,0)
 .I CNT>20 D PROMPT,CLEAR^VALM1 S CNT=0
"RTN","MPIFQ1",156,0)
 .I RES1(NUM)["Additional" W !! S CNT=CNT+2
"RTN","MPIFQ1",157,0)
 .I CNT<21 W !,RES1(NUM) S CNT=CNT+1
"RTN","MPIFQ1",158,0)
END D PROMPT
"RTN","MPIFQ1",159,0)
 S VALMBCK="R"
"RTN","MPIFQ1",160,0)
 K CNT,RETURN,RES1
"RTN","MPIFQ1",161,0)
 Q
"RTN","MPIFQ1",162,0)
HELP ; Help List Manager Action (MPIF REAL-TIME QUERY (HELP))
"RTN","MPIFQ1",163,0)
 D CLEAR^VALM1
"RTN","MPIFQ1",164,0)
 D MSG4
"RTN","MPIFQ1",165,0)
 D PROMPT
"RTN","MPIFQ1",166,0)
 S VALMBCK="R"
"RTN","MPIFQ1",167,0)
 Q
"RTN","MPIFQ1",168,0)
MSG(LOCSSN,LOCNAME,MPISSN,MPINAME) ;
"RTN","MPIFQ1",169,0)
 W !!!,"Local SSN = "_LOCSSN,?35,"MPI SSN = "_MPISSN
"RTN","MPIFQ1",170,0)
 W !,"Local NAME = "_LOCNAME,?40,"MPI NAME = "_MPINAME
"RTN","MPIFQ1",171,0)
 Q
"RTN","MPIFQ1",172,0)
MSG3 W !!,"Updating ICN and CMOR"
"RTN","MPIFQ1",173,0)
 Q
"RTN","MPIFQ1",174,0)
MSG1 W !!,"You are attempting to assign an ICN that has already been assigned"
"RTN","MPIFQ1",175,0)
 W !,"to another patient in your Patient file."
"RTN","MPIFQ1",176,0)
 W !,"An exception will be recorded noting that these 2 patients "
"RTN","MPIFQ1",177,0)
 W !,"need to be reviewed to determine if they are duplicates."
"RTN","MPIFQ1",178,0)
 Q
"RTN","MPIFQ1",179,0)
MSG2 W !!,"You have selected a patient from the list of potential matches"
"RTN","MPIFQ1",180,0)
 W !," where the Name is different than what the MPI has."
"RTN","MPIFQ1",181,0)
 W !," Are you sure this is the correct patient?"
"RTN","MPIFQ1",182,0)
 Q
"RTN","MPIFQ1",183,0)
MSG5 W !!,"No Action Taken"
"RTN","MPIFQ1",184,0)
 Q
"RTN","MPIFQ1",185,0)
MSG4 W !!,"When you have reached MPI QUERY RESULTS screen, the software has"
"RTN","MPIFQ1",186,0)
 W !,"queried the Master Patient Index, for possible matches to the patient"
"RTN","MPIFQ1",187,0)
 W !,"you are adding, or selected (pre-existing record)."
"RTN","MPIFQ1",188,0)
 W !!,"The MPI has returned a list of possible matches for that patient"
"RTN","MPIFQ1",189,0)
 W !,"An '*' indicates the Integration Control Number of a patient"
"RTN","MPIFQ1",190,0)
 W !,"on the list, matches one in your Patient file already."
"RTN","MPIFQ1",191,0)
 W !,"To select a patient from the list, choose SE."
"RTN","MPIFQ1",192,0)
 W !,"If the patients listed as potential matches aren't the same patient"
"RTN","MPIFQ1",193,0)
 W !,"select NEW to create a new entry on the MPI for this patient."
"RTN","MPIFQ1",194,0)
 W !,"To view all data for a patient in the list of possible matches"
"RTN","MPIFQ1",195,0)
 W !,"from the MPI, select MPI."
"RTN","MPIFQ1",196,0)
 W !,"To view additional data for a patient in the list of possible"
"RTN","MPIFQ1",197,0)
 W !,"matches from the CMOR site, select CMR."
"RTN","MPIFQ1",198,0)
 Q
"RTN","MPIFQ1",199,0)
PROMPT ;
"RTN","MPIFQ1",200,0)
 W !!
"RTN","MPIFQ1",201,0)
 S DIR("A")="Hit the Enter key, to Continue "
"RTN","MPIFQ1",202,0)
 S DIR(0)="EA"
"RTN","MPIFQ1",203,0)
 D ^DIR
"RTN","MPIFQ1",204,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",205,0)
 Q
"RTN","MPIFQ1",206,0)
PROMPT1() ;
"RTN","MPIFQ1",207,0)
 N DIR,X,Y
"RTN","MPIFQ1",208,0)
 W !
"RTN","MPIFQ1",209,0)
 S DIR("A")="Are you sure this is the correct patient? Enter YES or NO "
"RTN","MPIFQ1",210,0)
 S DIR(0)="YA"
"RTN","MPIFQ1",211,0)
 D ^DIR
"RTN","MPIFQ1",212,0)
 K DIR(0),DIR("A")
"RTN","MPIFQ1",213,0)
 Q Y
"RTN","MPIFQ1",214,0)
HERESSN(SSN) ;
"RTN","MPIFQ1",215,0)
 N DFN
"RTN","MPIFQ1",216,0)
 I $G(SSN)="" Q 0
"RTN","MPIFQ1",217,0)
 S DFN=$O(^DPT("SSN",SSN,0))
"RTN","MPIFQ1",218,0)
 Q:$G(DFN)']"" 0
"RTN","MPIFQ1",219,0)
 Q DFN
"RTN","MPIFQ1",220,0)
CHECK(DFN) ;
"RTN","MPIFQ1",221,0)
 N CHECK
"RTN","MPIFQ1",222,0)
 D GETDATA^MPIFQ0("^DPT(",DFN,"CHECK",".01;.02;.03;.09;.301;391;1901")
"RTN","MPIFQ1",223,0)
 I $G(CHECK(2,DFN,.01))']"" Q 0
"RTN","MPIFQ1",224,0)
 I $G(CHECK(2,DFN,.02))']"" Q 0
"RTN","MPIFQ1",225,0)
 I $G(CHECK(2,DFN,.03))']"" Q 0
"RTN","MPIFQ1",226,0)
 I $G(CHECK(2,DFN,.09))']"" Q 0
"RTN","MPIFQ1",227,0)
 I $G(CHECK(2,DFN,.301))']"" Q 0
"RTN","MPIFQ1",228,0)
 I $G(CHECK(2,DFN,391))']"" Q 0
"RTN","MPIFQ1",229,0)
 I $G(CHECK(2,DFN,1901))']"" Q 0
"RTN","MPIFQ1",230,0)
 Q 1
"RTN","MPIFQ1",231,0)
EXIT ;Exit for List Manager Template MPIF REAL-TIME QUERY
"RTN","MPIFQ1",232,0)
 K VALMBCK,VALMCNT,VALMHDR
"RTN","MPIFQ1",233,0)
 Q
"RTN","MPIFQ1",234,0)
TF(DFN,ARR) ;Add you to TF list and trigger TF and Sub msgs
"RTN","MPIFQ1",235,0)
 ;;;N SITE
"RTN","MPIFQ1",236,0)
 ;;;S SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFQ1",237,0)
 I $$PATCH^XPDUTL("DG*5.3*261") D FILE^VAFCTFU(DFN,+$$SITE^VASITE,1)
"RTN","MPIFQ1",238,0)
 N RESLT
"RTN","MPIFQ1",239,0)
 S RESLT=$$A24^MPIFA24B(DFN)
"RTN","MPIFQ1",240,0)
 I +RESLT<0 D EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_DFN,DFN)
"RTN","MPIFQ1",241,0)
 Q
"RTN","MPIFQUE4")
0^6^B58373314
"RTN","MPIFQUE4",1,0)
MPIFQUE4 ;SF/TNV-Process the CMOR COMPARISON request ;FEB 25, 1998
"RTN","MPIFQUE4",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**1,3,11,24**;30 Apr 99
"RTN","MPIFQUE4",3,0)
 ;
"RTN","MPIFQUE4",4,0)
 ; Integration Agreements Utilized:
"RTN","MPIFQUE4",5,0)
 ;
"RTN","MPIFQUE4",6,0)
 ;   EXC^RGHLLOG     IA #2796
"RTN","MPIFQUE4",7,0)
 ;   START^RGHLLOG   IA #2796
"RTN","MPIFQUE4",8,0)
 ;   STOP^RGHLLOG    IA #2796
"RTN","MPIFQUE4",9,0)
 ;   CALC^RGVCCMR2   IA #2710
"RTN","MPIFQUE4",10,0)
 ;   $$EN^VAFCPID    IA #3015
"RTN","MPIFQUE4",11,0)
 ;
"RTN","MPIFQUE4",12,0)
 ; 
"RTN","MPIFQUE4",13,0)
 ; This routine will process the batch message from the sending CMOR
"RTN","MPIFQUE4",14,0)
 ; who wished to change the patient CMOR from you to their own.
"RTN","MPIFQUE4",15,0)
 ; PLEASE NOTE THAT THIS PROCESS WILL NOT BE TRACKED AS CMOR REQUEST
"RTN","MPIFQUE4",16,0)
 ; EVENT. SO NOTHING WILL BE RECORDED IN THAT FILE. (PER SRS 9-18-97)
"RTN","MPIFQUE4",17,0)
 ; Approving process:
"RTN","MPIFQUE4",18,0)
 ; The sender will give the CMOR score and the date for a patient
"RTN","MPIFQUE4",19,0)
 ; The receiver will look into the CMOR score on the system and compare
"RTN","MPIFQUE4",20,0)
 ; the date if the date is less than 90 days. Go and use the Current
"RTN","MPIFQUE4",21,0)
 ; CMOR score and compare. If the incoming CMOR score is 80% or more than
"RTN","MPIFQUE4",22,0)
 ; the system CMOR score. CMOR site will be changed to the requesting CMOR
"RTN","MPIFQUE4",23,0)
 ; site. An approved HL7 message will be send to ALL SITES in the
"RTN","MPIFQUE4",24,0)
 ; subscriber list and notify them the new CMOR site. MPI is included.
"RTN","MPIFQUE4",25,0)
 ; If the score is equal or greater than 90 days. CMOR score will be
"RTN","MPIFQUE4",26,0)
 ; recalulated for this patient and compare. Same process as above.
"RTN","MPIFQUE4",27,0)
 ; If the incoming CMOR score is not higher than 80% nothing will happen.
"RTN","MPIFQUE4",28,0)
BEGIN ; Entry point for CMOR COMPARISON request to process.
"RTN","MPIFQUE4",29,0)
 ; NO input or output variables
"RTN","MPIFQUE4",30,0)
 N IEN,RGLOG
"RTN","MPIFQUE4",31,0)
 K RGL
"RTN","MPIFQUE4",32,0)
 D NOW^%DTC
"RTN","MPIFQUE4",33,0)
 S ZTIO="",ZTDTH=%,ZTRTN="EN^MPIFQUE4"
"RTN","MPIFQUE4",34,0)
 S ZTDESC="BACKGROUND CMOR COMPARISON"
"RTN","MPIFQUE4",35,0)
 S ZTSAVE("HL*")=""
"RTN","MPIFQUE4",36,0)
 D ^%ZTLOAD,CLEAN
"RTN","MPIFQUE4",37,0)
 K COUNT,RGL,%,ZTIO,ZTDTH,ZTRTN,ZTDESC,ZTSAVE
"RTN","MPIFQUE4",38,0)
 Q
"RTN","MPIFQUE4",39,0)
 ;
"RTN","MPIFQUE4",40,0)
EN ; Background job to run for cmor comparison
"RTN","MPIFQUE4",41,0)
 K ERROR,MPICNT
"RTN","MPIFQUE4",42,0)
 N MPII,U,LINE,PARENT,COUNT,NDATE,IKI,MPIFFS,MPIFSFS,MPIFREAP,RGLOG
"RTN","MPIFQUE4",43,0)
 S MPIFFS=HL("FS"),MPIFSFS=$E(HL("ECH"),1),MPIFREAP=$E(HL("ECH"),2)
"RTN","MPIFQUE4",44,0)
 D START^RGHLLOG()
"RTN","MPIFQUE4",45,0)
 S U="^",(COUNT,MPICNT)=0
"RTN","MPIFQUE4",46,0)
 F MPII=1:1 X HLNEXT Q:HLQUIT'>0!($D(ERROR))  G:$$S^%ZTLOAD CLEAN D
"RTN","MPIFQUE4",47,0)
 . S LINE=HLNODE
"RTN","MPIFQUE4",48,0)
 . I $P(LINE,MPIFFS)["MSH" D MSH
"RTN","MPIFQUE4",49,0)
 . I $P(LINE,MPIFFS)["NTE" D NTE
"RTN","MPIFQUE4",50,0)
 . I $P(LINE,MPIFFS)["PID" D PID
"RTN","MPIFQUE4",51,0)
 . I $P(LINE,MPIFFS)["EVN" D EVN
"RTN","MPIFQUE4",52,0)
 . I COUNT=4,'$D(ERROR) D PROCES
"RTN","MPIFQUE4",53,0)
 K SERVER,CLIENT,ERROR
"RTN","MPIFQUE4",54,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE4",55,0)
 S ZTREQ="@"
"RTN","MPIFQUE4",56,0)
 Q
"RTN","MPIFQUE4",57,0)
 ;
"RTN","MPIFQUE4",58,0)
MSH ; Process MSH segment
"RTN","MPIFQUE4",59,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",60,0)
 Q
"RTN","MPIFQUE4",61,0)
 ;
"RTN","MPIFQUE4",62,0)
NTE ; Process NTE segment
"RTN","MPIFQUE4",63,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",64,0)
 S SITE=$P(LINE,MPIFFS,3)
"RTN","MPIFQUE4",65,0)
 I SITE="" S ERROR="HL7 Msg# "_$G(HL("MID"))_" is missing CMOR for ICN# "_$G(ICN) D EXC^RGHLLOG(221,ERROR) Q
"RTN","MPIFQUE4",66,0)
 S REASON=$P(LINE,MPIFFS,2)
"RTN","MPIFQUE4",67,0)
 I REASON'="COMPARISON" S ERROR="HL7 Msg# "_$G(HL("MID"))_" contained a unknown request reason for ICN# "_$G(ICN) D EXC^RGHLLOG(222,ERROR)
"RTN","MPIFQUE4",68,0)
 Q
"RTN","MPIFQUE4",69,0)
 ;
"RTN","MPIFQUE4",70,0)
PID ; Process PID segment
"RTN","MPIFQUE4",71,0)
 N NODE
"RTN","MPIFQUE4",72,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",73,0)
 S ICN=+$P(LINE,MPIFFS,3)   ; get ICN out.
"RTN","MPIFQUE4",74,0)
 I ICN="" S ERROR="HL7 Msg# "_$G(HL("MID"))_" contains a null ICN in a PID segment." D EXC^RGHLLOG(219,ERROR) Q
"RTN","MPIFQUE4",75,0)
 S DFN=$$IEN^MPIFNQ(ICN)                  ; get DFN of this patient
"RTN","MPIFQUE4",76,0)
 I DFN="" S ERROR="Can't Process CMOR Compare for Patient with ICN "_ICN_". ICN not at this site. HL7 Message#: "_HLMTIEN D EXC^RGHLLOG(219,ERROR) Q
"RTN","MPIFQUE4",77,0)
 S NODE=$$MPINODE^MPIFAPI(+DFN)
"RTN","MPIFQUE4",78,0)
 S CMOR=$P(NODE,"^",3)               ; get the CMOR of this patient
"RTN","MPIFQUE4",79,0)
 S SCORE=$P(NODE,"^",6),NDATE=$P(NODE,"^",7)
"RTN","MPIFQUE4",80,0)
 ; if no score or score date recalc score and reset variables
"RTN","MPIFQUE4",81,0)
 I SCORE=""!(NDATE="") N RGDFN S RGDFN=DFN D CALC^RGVCCMR2
"RTN","MPIFQUE4",82,0)
 S NODE=$$MPINODE^MPIFAPI(+DFN),SCORE=$P(NODE,"^",6),NDATE=$P(NODE,"^",7)
"RTN","MPIFQUE4",83,0)
 Q
"RTN","MPIFQUE4",84,0)
 ;
"RTN","MPIFQUE4",85,0)
EVN ; Process EVN segment
"RTN","MPIFQUE4",86,0)
 S COUNT=COUNT+1
"RTN","MPIFQUE4",87,0)
 S X=$P(LINE,MPIFFS,3) D ^%DT S INDATE=Y
"RTN","MPIFQUE4",88,0)
 I INDATE=-1 S ERROR="CMOR score Date was missing for DFN "_DFN_" in CMOR Compare Inbound Message" Q
"RTN","MPIFQUE4",89,0)
 S INSCORE=$P($G(LINE),MPIFFS,4)
"RTN","MPIFQUE4",90,0)
 I INSCORE="" S INSCORE=0
"RTN","MPIFQUE4",91,0)
 Q
"RTN","MPIFQUE4",92,0)
 ;
"RTN","MPIFQUE4",93,0)
PROCES ; Process one complete message (MSH,PID,EVN,NTE)
"RTN","MPIFQUE4",94,0)
 N LIMIT
"RTN","MPIFQUE4",95,0)
 I $G(ERROR)]"" D CLEAN Q                ; Don't do anything if there is an error
"RTN","MPIFQUE4",96,0)
 S X="T-90" D ^%DT                       ; get the target date
"RTN","MPIFQUE4",97,0)
 I NDATE>Y D  Q                           ; RECORDED DATE is less than 90 days
"RTN","MPIFQUE4",98,0)
 . S LIMIT=$$PERCENT(INSCORE,SCORE)      ; Incoming CMOR score is above 80%
"RTN","MPIFQUE4",99,0)
 . I (LIMIT>80.5)&(INSCORE>SCORE) D CHANGE                 ; Incoming CMOR score is greater
"RTN","MPIFQUE4",100,0)
 . D CLEAN                               ; Incoming CMOR score is LESS
"RTN","MPIFQUE4",101,0)
 N RGDFN S RGDFN=DFN D CALC^RGVCCMR2                         ; Last calculation was greater than 90 days
"RTN","MPIFQUE4",102,0)
 S SCORE=$P($$MPINODE^MPIFAPI(DFN),"^",6)    ; Get the latest score
"RTN","MPIFQUE4",103,0)
 S LIMIT=$$PERCENT(INSCORE,SCORE)        ; Incoming CMOR score is above 80%
"RTN","MPIFQUE4",104,0)
 I (LIMIT>80.5)&(INSCORE>SCORE) D CHANGE                   ; Incoming CMOR score is greater
"RTN","MPIFQUE4",105,0)
 D CLEAN                                 ; Incoming CMOR score is LESS than the latest score
"RTN","MPIFQUE4",106,0)
 Q
"RTN","MPIFQUE4",107,0)
 ;
"RTN","MPIFQUE4",108,0)
PERCENT(NUM1,NUM2) ; Calculate the percent difference 80% or more need for change
"RTN","MPIFQUE4",109,0)
 ; of CMOR number
"RTN","MPIFQUE4",110,0)
 N DIF
"RTN","MPIFQUE4",111,0)
 I NUM1="" S NUM1=0
"RTN","MPIFQUE4",112,0)
 I NUM2="" S NUM2=0
"RTN","MPIFQUE4",113,0)
 Q:$$MAX^XLFMTH(NUM1,NUM2)=0 0
"RTN","MPIFQUE4",114,0)
 S DIF=(100-(($$MIN^XLFMTH(NUM1,NUM2))/($$MAX^XLFMTH(NUM1,NUM2))*100))
"RTN","MPIFQUE4",115,0)
 Q DIF
"RTN","MPIFQUE4",116,0)
 ;
"RTN","MPIFQUE4",117,0)
CHANGE ; Process the change CMOR request to the new CMOR site and Send out 
"RTN","MPIFQUE4",118,0)
 ; notification to the Subscriber list and MPI.
"RTN","MPIFQUE4",119,0)
 N CHANGE,MPIFSITE S MPIFSITE=$$LKUP^XUAF4(SITE)  ;get INSTITUTION (#4) IEN
"RTN","MPIFQUE4",120,0)
 I MPIFSITE=-1 S ERROR="HL7 Msg#"_$G(HL("MID"))_" contained an invalid STATION#"_$G(SITE)_" for ICN#"_$G(ICN) D EXC^RGHLLOG(211,ERROR,+DFN) Q
"RTN","MPIFQUE4",121,0)
 S CHANGE=$$CHANGE^MPIF001(+DFN,MPIFSITE)
"RTN","MPIFQUE4",122,0)
 I +CHANGE<1 S ERROR="Unable to change CMOR in HL7 Msg#"_$G(HL("MID"))_" from "_$P($$SITE^VASITE,"^",3)_" To "_$G(SITE)_" due to "_$P(CHANGE,"^",2) D EXC^RGHLLOG(211,ERROR,DFN) Q
"RTN","MPIFQUE4",123,0)
 S SERVER="MPIF CMOR RESULT SERVER",CLIENT="MPIF CMOR RESULT CLIENT"
"RTN","MPIFQUE4",124,0)
 D INIT^HLFNC2(SERVER,.HL)
"RTN","MPIFQUE4",125,0)
 I $G(HL) S ERROR=HL D EXC^RGHLLOG(220,ERROR,DFN) Q
"RTN","MPIFQUE4",126,0)
 D LINK
"RTN","MPIFQUE4",127,0)
 I $G(RESULT)=0 K RESULT Q
"RTN","MPIFQUE4",128,0)
 S HLA("HLS",1)=$$EN^VAFCPID(+DFN,"2,3,4,5,6,7,8,9,10")
"RTN","MPIFQUE4",129,0)
 S HLA("HLS",2)="EVN"_HL("FS")_"A31"_HL("FS")_INDATE_HL("FS")_INSCORE_HL("FS")_"POSTMASTER"
"RTN","MPIFQUE4",130,0)
 ;actually change the cmor
"RTN","MPIFQUE4",131,0)
 S HLA("HLS",3)="PV1"_HL("FS")_HL("FS")_HL("FS")_SITE_HL("FS")_HL("FS")_HL("FS")_$P($$NNT^XUAF4(CMOR),"^",2)
"RTN","MPIFQUE4",132,0)
 N RESLT
"RTN","MPIFQUE4",133,0)
 D GENERATE^HLMA(SERVER,"LM",1,.RESLT)
"RTN","MPIFQUE4",134,0)
 I $P(RESLT,U,2)'="" D EXC^RGHLLOG(220,"Error returned in GENERATE^HLMA  "_$P(RESLT,U,2),DFN)
"RTN","MPIFQUE4",135,0)
 K RESULT
"RTN","MPIFQUE4",136,0)
 S MPICNT=MPICNT+1 ;counting changes in CMOR
"RTN","MPIFQUE4",137,0)
 Q
"RTN","MPIFQUE4",138,0)
 ;
"RTN","MPIFQUE4",139,0)
LINK ; Give back the TF list in HLL(LINKS") array for this patient
"RTN","MPIFQUE4",140,0)
 N SUB,IEN,MPILINK,MPITF
"RTN","MPIFQUE4",141,0)
 K RGL
"RTN","MPIFQUE4",142,0)
 S RGL(0)=""
"RTN","MPIFQUE4",143,0)
 S X=$$QUERYTF^VAFCTFU1($G(ICN),"MPITF")
"RTN","MPIFQUE4",144,0)
 ;LOOP THOUGH TF LIST AND GET LINK FOR EACH
"RTN","MPIFQUE4",145,0)
 N LP,CNT,STN,MPIFHL S CNT=1,LP=0 K ERROR
"RTN","MPIFQUE4",146,0)
 F  S LP=$O(MPITF(LP)) Q:LP=""  D
"RTN","MPIFQUE4",147,0)
 .S STN=$$STA^XUAF4($G(MPITF(LP)))
"RTN","MPIFQUE4",148,0)
 .Q:$P($$SITE^VASITE(),"^",3)=STN
"RTN","MPIFQUE4",149,0)
 .K MPIFHL D LINK^HLUTIL3(+$G(MPITF(LP)),.MPIFHL)
"RTN","MPIFQUE4",150,0)
 .I '$O(MPIFHL(0)) S ERROR="-1^Unknown Logical Link for Station # "_STN_" Unable to notify of Change of CMOR for patient "_DFN
"RTN","MPIFQUE4",151,0)
 .I $D(ERROR) D EXC^RGHLLOG(224,ERROR,DFN) K ERROR Q
"RTN","MPIFQUE4",152,0)
 .S HLL("LINKS",CNT)=CLIENT_"^"_$P(MPIFHL($O(MPIFHL(0))),"^"),CNT=CNT+1
"RTN","MPIFQUE4",153,0)
 S MPILINK=$$MPILINK^MPIFAPI()
"RTN","MPIFQUE4",154,0)
 I +MPILINK=-1 D EXC^RGHLLOG(224,"No MPI Link defined",DFN) Q
"RTN","MPIFQUE4",155,0)
 S HLL("LINKS",9999)=CLIENT_U_MPILINK
"RTN","MPIFQUE4",156,0)
 Q
"RTN","MPIFQUE4",157,0)
CLEAN ; Clean up the partition and ready for the next message
"RTN","MPIFQUE4",158,0)
 D STOP^RGHLLOG()
"RTN","MPIFQUE4",159,0)
 K RGL,EVENT,SITE,REASON,ICN,DFN,CMOR,SCORE,X,Y,INDATE,INSCORE
"RTN","MPIFQUE4",160,0)
 S COUNT=0
"RTN","MPIFQUE4",161,0)
 Q
"RTN","MPIFQUE4",162,0)
CHKSUB(DFN,FAC) ;check for an existing subscription if one does not exist add it
"RTN","MPIFQUE4",163,0)
 Q
"RTN","MPIFQUE4",164,0)
 ;;^ NO LONGER TO BE USED
"RTN","MPIFQUE4",165,0)
 N MPIFSCN,MPIF,MPIFLL,MPIFLLI,MPIFLLN,FLAG,LOOP,HLER
"RTN","MPIFQUE4",166,0)
 Q:FAC=""
"RTN","MPIFQUE4",167,0)
 Q:DFN=""
"RTN","MPIFQUE4",168,0)
 Q:FAC=+$$SITE^VASITE  ;don't add subscription for yourself
"RTN","MPIFQUE4",169,0)
 S MPIFSCN=$$GETSCN(DFN)
"RTN","MPIFQUE4",170,0)
 D GET^HLSUB(MPIFSCN,0,"MPIF CMOR RESULT CLIENT",.MPIFLL)
"RTN","MPIFQUE4",171,0)
 D LINK^HLUTIL3("`"_FAC,.MPIF,"I") S MPIFLLI=$O(MPIF(0)) S MPIFLLN=MPIF(MPIFLLI)
"RTN","MPIFQUE4",172,0)
 S FLAG=0,LOOP=0 F  S LOOP=$O(MPIFLL("LINKS",LOOP)) Q:'LOOP  I $P(MPIFLL("LINKS",LOOP),"^",2)=MPIFLLN S FLAG=1
"RTN","MPIFQUE4",173,0)
 I FLAG=0 D UPD^HLSUB(MPIFSCN,MPIFLLN,0,$$NOW^XLFDT,,,.HLER)
"RTN","MPIFQUE4",174,0)
 I $D(HLER) D EXC^RGHLLOG(224,"Msg#"_$G(HL("MID"))_" Unable to add/update SC for facility IEN "_FAC_", Link "_$G(MPIFLLN)_", for patient "_DFN_" SUB#"_$G(MPIFSCN),DFN) D STOP^RGHLLOG(1) Q  ; log exception
"RTN","MPIFQUE4",175,0)
 Q
"RTN","MPIFQUE4",176,0)
GETSCN(DFN) ;Return existing SCN or Activate a new subscription
"RTN","MPIFQUE4",177,0)
 ;DFN - PATIENT (#2) file ien
"RTN","MPIFQUE4",178,0)
 N MPIFAR,MPIFAN
"RTN","MPIFQUE4",179,0)
 ;get subscription control #
"RTN","MPIFQUE4",180,0)
 S MPIFSCN=+$P($$MPINODE^MPIFAPI(DFN),"^",5)
"RTN","MPIFQUE4",181,0)
 ;if no SCN, create new and update 991.05, then return result
"RTN","MPIFQUE4",182,0)
 I 'MPIFSCN S MPIFSCN=$$ACT^HLSUB S MPIFAR(991.05)=MPIFSCN S MPIFAN=$$UPDATE^MPIFAPI(DFN,"MPIFAR") I MPIFAN=-1 S MPIFSCN=""
"RTN","MPIFQUE4",183,0)
 Q MPIFSCN
"RTN","MPIFRPC2")
0^3^B14636916
"RTN","MPIFRPC2",1,0)
MPIFRPC2 ;SFCIO/CMC-MPIF RPC APIS ;24 OCT 01
"RTN","MPIFRPC2",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**20,24**;30 Apr 99
"RTN","MPIFRPC2",3,0)
 ;
"RTN","MPIFRPC2",4,0)
 ;Integration Agreements Utilized:
"RTN","MPIFRPC2",5,0)
 ;  ^DPT( - #2070
"RTN","MPIFRPC2",6,0)
 ;  FILE^VAFCTFU - #2988
"RTN","MPIFRPC2",7,0)
 ;  AVAFC^VAFCDD01 - #3493
"RTN","MPIFRPC2",8,0)
 ;  $$SEND2^VAFCUTL1 - #2779    
"RTN","MPIFRPC2",9,0)
 ;  START, STOP, EXC^RGHLLOG - #2070
"RTN","MPIFRPC2",10,0)
 ;
"RTN","MPIFRPC2",11,0)
SPI(RETURN,SSN,DFN1) ;
"RTN","MPIFRPC2",12,0)
 ;RPC to Single Patient Initialization on patient with SSN
"RTN","MPIFRPC2",13,0)
 ; RETURN - 1 for successful inactivation or -1^error msg
"RTN","MPIFRPC2",14,0)
 ; SSN = is the SSN for the patient that is to be SPI'd
"RTN","MPIFRPC2",15,0)
 ; DFN1 = is the IEN for the patient that is to be SPI'd
"RTN","MPIFRPC2",16,0)
 ;
"RTN","MPIFRPC2",17,0)
 N RES,XX,DFN,ICN,TICN,MPIFA
"RTN","MPIFRPC2",18,0)
 I SSN=""&($G(DFN1)="") S RETURN="-1^No SSN or DFN Passed" Q
"RTN","MPIFRPC2",19,0)
 I SSN'="",SSN'?9N S RETURN="-1^Invalid SSN" Q
"RTN","MPIFRPC2",20,0)
 I SSN'="",'$D(^DPT("SSN",SSN)) S RETURN="-1^No such SSN" Q
"RTN","MPIFRPC2",21,0)
 I SSN'="" D
"RTN","MPIFRPC2",22,0)
 .S RETURN(0)="SSN USED "_SSN
"RTN","MPIFRPC2",23,0)
 .S RES=$$GETDFNS^MPIF002(SSN)
"RTN","MPIFRPC2",24,0)
 I SSN="",DFN1'?1N.N S RETURN="-1^Invalid DFN" Q
"RTN","MPIFRPC2",25,0)
 I SSN="",'$D(^DPT(DFN1,0)) S RETURN="-1^No such DFN" Q
"RTN","MPIFRPC2",26,0)
 I SSN="" D
"RTN","MPIFRPC2",27,0)
 .S RETURN(0)="DFN USED "_DFN1
"RTN","MPIFRPC2",28,0)
 .S RES=DFN1
"RTN","MPIFRPC2",29,0)
 I +RES=-1 S RETURN=RES Q
"RTN","MPIFRPC2",30,0)
 F XX=1:1 S DFN=$P(RES,"^",XX) Q:DFN=""  D
"RTN","MPIFRPC2",31,0)
 .; can be multiple entries with same SSN
"RTN","MPIFRPC2",32,0)
 .S TICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFRPC2",33,0)
 .I +TICN'=-1&($P($$SITE^VASITE,"^",3)'=$E(TICN,1,3)) S RETURN(XX,0)="DFN= "_DFN_" already has an ICN, ICN="_TICN Q
"RTN","MPIFRPC2",34,0)
 .S MPIFS=1,HLP("ACKTIME")=300,MPIFRES=1,MPIFRPC=1
"RTN","MPIFRPC2",35,0)
 .I +$$SEND2^VAFCUTL1(DFN,"T")=1 S RETURN(XX,0)="DFN "_DFN_" Patient should not be sent to the MPI -- SSN has 5 leading 0s or name has been ZZ'd" Q
"RTN","MPIFRPC2",36,0)
 .D GETS^DIQ(2,DFN_",",".01","IE","MPIFA")
"RTN","MPIFRPC2",37,0)
 .I $E(MPIFA(2,DFN_",",.01,"E"),1,3)="EEE" S RETURN(XX,0)="DFN "_DFN_" Patient should not be sent to the MPI -- EEE patient -- update to actual Patient name" Q
"RTN","MPIFRPC2",38,0)
 .D CIRNEXC^MPIFQ0
"RTN","MPIFRPC2",39,0)
 .K MPIFS,MPIFRES,MPIFRPC
"RTN","MPIFRPC2",40,0)
 .S ICN=$$GETICN^MPIF001(DFN)
"RTN","MPIFRPC2",41,0)
 .I +ICN=-1 S RETURN(XX,0)="DFN "_DFN_" problem getting ICN assinged "_$P(ICN,"^",2),RETURN="-1^Unable to get ICN" Q
"RTN","MPIFRPC2",42,0)
 .K RET S RET=""
"RTN","MPIFRPC2",43,0)
 .I $P($$SITE^VASITE,"^",3)=$E(+ICN,1,3) D  Q
"RTN","MPIFRPC2",44,0)
 ..D EXC^MPIFRPC(DFN,.RET,XX)
"RTN","MPIFRPC2",45,0)
 ..S RET(XX,"EXCEPTIONS")=$TR($G(RET(XX,"EXCEPTIONS")),"""","")
"RTN","MPIFRPC2",46,0)
 ..S RETURN(XX,0)="DFN "_DFN_" Local ICN assigned "_ICN_" EXCEPTIONS: "_$G(RET(XX,"EXCEPTIONS")),RETURN="-1^Local ICN assigned" Q
"RTN","MPIFRPC2",47,0)
 .S RETURN(XX)=ICN
"RTN","MPIFRPC2",48,0)
 Q
"RTN","MPIFRPC2",49,0)
 ;
"RTN","MPIFRPC2",50,0)
UPDATE(RET,SSN,ICN,CHK,CMOR,A08) ;
"RTN","MPIFRPC2",51,0)
 ; update fields 991.01,991.02 and 991.03 remotely
"RTN","MPIFRPC2",52,0)
 I SSN=""!(ICN="")!(CHK="")!(CMOR="") S RET="-1^Missing required parameter" Q
"RTN","MPIFRPC2",53,0)
 I '$D(^DPT("SSN",SSN)) S RET="-1^No patient has that SSN at this site" Q
"RTN","MPIFRPC2",54,0)
 N DFN,MPIFA,TMP,RESLT
"RTN","MPIFRPC2",55,0)
 S DFN=$O(^DPT("SSN",SSN,""))
"RTN","MPIFRPC2",56,0)
 I $O(^DPT("SSN",SSN,DFN))'="" S RET="-1^More than one patient has that SSN at this site" Q
"RTN","MPIFRPC2",57,0)
 S TMP=$P($$MPINODE^MPIFAPI(DFN),"^")
"RTN","MPIFRPC2",58,0)
 I +TMP'=-1,$E(TMP,1,3)'=$P($$SITE^VASITE(),"^",3) S RET="-1^Patient has a national ICN, ICN="_TMP Q
"RTN","MPIFRPC2",59,0)
 S MPIFA(991.01)=ICN,MPIFA(991.02)=CHK,MPIFA(991.03)=$$LKUP^XUAF4(CMOR)
"RTN","MPIFRPC2",60,0)
 S RET=$$UPDATE^MPIFAPI(DFN,"MPIFA")
"RTN","MPIFRPC2",61,0)
 ;;;D FILE^VAFCTFU(DFN,+$$SITE^VASITE) ; update tf list
"RTN","MPIFRPC2",62,0)
 S RESLT=$$A24^MPIFA24B(DFN)
"RTN","MPIFRPC2",63,0)
 I +RESLT<0 D START^RGHLLOG(),EXC^RGHLLOG(208,"Problem building A24 (ADD TF) for DFN= "_DFN,DFN),STOP^RGHLLOG() S RET="-1^Problem building A24 (ADD TF) for Pt" Q
"RTN","MPIFRPC2",64,0)
 I A08=1 D AVAFC^VAFCDD01(DFN) ; trigger A08 msg
"RTN","MPIFRPC2",65,0)
 I A08=1 S RET=RET_"^and A08 triggered"
"RTN","MPIFRPC2",66,0)
 Q
"RTN","MPIFSEED")
0^7^B7593746
"RTN","MPIFSEED",1,0)
MPIFSEED ;BP/CMC-SEEDING OF A31s TO MPI AND SUB CLEANUP ;FEB 5, 2002
"RTN","MPIFSEED",2,0)
 ;;1.0; MASTER PATIENT INDEX VISTA ;**22,24**;30 Apr 99
"RTN","MPIFSEED",3,0)
 ;
"RTN","MPIFSEED",4,0)
 ; Intregration Agreement Utilized:
"RTN","MPIFSEED",5,0)
 ;
"RTN","MPIFSEED",6,0)
 ;   ^DPT("AICNL", ^DPT("AICN", ^DPT("AMPIMIS", ^DPT("ASCN2" - #2070
"RTN","MPIFSEED",7,0)
 ;   ^DPT( - #2070
"RTN","MPIFSEED",8,0)
 ;
"RTN","MPIFSEED",9,0)
 ; $O through Patient file (#2) Sending A31 message for any patients
"RTN","MPIFSEED",10,0)
 ; with an active National ICN.
"RTN","MPIFSEED",11,0)
 ; 
"RTN","MPIFSEED",12,0)
EN ;
"RTN","MPIFSEED",13,0)
 I $D(^XTMP("MPIF_SEEDING"))&('$D(^XTMP("MPIF_SEEDING","STOPPED"))) W !,"Seeding job is already running" Q
"RTN","MPIFSEED",14,0)
 I $D(^XTMP("MPIF_SEEDING"))&($D(^XTMP("MPIF_SEEDING","STOPPED"))) W !,"Seeding job has already been run at this site" Q
"RTN","MPIFSEED",15,0)
 D START
"RTN","MPIFSEED",16,0)
 Q
"RTN","MPIFSEED",17,0)
QUEUE ;
"RTN","MPIFSEED",18,0)
 I $D(^XTMP("MPIF_SEEDING"))&('$D(^XTMP("MPIF_SEEDING","STOPPED"))) W !,"Seeding job is already running" Q
"RTN","MPIFSEED",19,0)
 I $D(^XTMP("MPIF_SEEDING"))&($D(^XTMP("MPIF_SEEDING","STOPPED"))) W !,"Seeding job has already been run at this site" Q
"RTN","MPIFSEED",20,0)
 S ZTRTN="START^MPIFSEED",ZTDESC="A31 SEEDING FOR SITE"
"RTN","MPIFSEED",21,0)
 D NOW^%DTC
"RTN","MPIFSEED",22,0)
 S ZTIO="",ZTDTH=%
"RTN","MPIFSEED",23,0)
 I $D(DUZ) S ZTSAVE("DUZ")=DUZ
"RTN","MPIFSEED",24,0)
 D ^%ZTLOAD
"RTN","MPIFSEED",25,0)
 D HOME^%ZIS K IO("Q")
"RTN","MPIFSEED",26,0)
 K ZTDESC,ZTDTH,ZTIO,ZTQUEUED,ZTREQ,ZTRTN,ZTSAVE,ZTSK,%
"RTN","MPIFSEED",27,0)
 Q
"RTN","MPIFSEED",28,0)
 ;
"RTN","MPIFSEED",29,0)
START N ICN,DFN,SSN,CNT,XICN,SITE,ARRAY,ARR,SUB,A31,A31E,NODE
"RTN","MPIFSEED",30,0)
 I $D(ZTQUEUED) S ZTREQ="@"
"RTN","MPIFSEED",31,0)
 S (DFN,CNT,XICN,A31E)=0,ARR="ARRAY"
"RTN","MPIFSEED",32,0)
 K ^XTMP("MPIF_SEEDING")
"RTN","MPIFSEED",33,0)
 D NOW^%DTC
"RTN","MPIFSEED",34,0)
 S ^XTMP("MPIF_SEEDING",0)=%+10_"^"_%_"^Seeding MPI w/A31s"
"RTN","MPIFSEED",35,0)
 S ^XTMP("MPIF_SEEDING","STARTED")=%
"RTN","MPIFSEED",36,0)
 I '$D(^DPT("AICN")) G DONE
"RTN","MPIFSEED",37,0)
 ; ^ No ICNs
"RTN","MPIFSEED",38,0)
 S ICN="",SITE=$P($$SITE^VASITE(),"^",3)
"RTN","MPIFSEED",39,0)
 F  S ICN=$O(^DPT("AICN",ICN)) Q:ICN=""  D
"RTN","MPIFSEED",40,0)
 .Q:$E(ICN,1,3)=SITE
"RTN","MPIFSEED",41,0)
 .; ^LOCAL ICN
"RTN","MPIFSEED",42,0)
 .S CNT=CNT+1
"RTN","MPIFSEED",43,0)
 .I '(CNT#10000) W:$E(IOST)="C" !,ICN S ^XTMP("MPIF_SEEDING","LAST")="CNT="_CNT_"^ICN="_ICN_"^SENT="_XICN
"RTN","MPIFSEED",44,0)
 .S DFN=$O(^DPT("AICN",ICN,""))
"RTN","MPIFSEED",45,0)
 .Q:+DFN<1
"RTN","MPIFSEED",46,0)
 .Q:'$D(^DPT(DFN,"MPI"))
"RTN","MPIFSEED",47,0)
 .I $P($G(^DPT(DFN,"MPI")),"^")=ICN S A31=$$A31^MPIFA31B(DFN) S:A31>0 XICN=XICN+1 S:+A31<1 ^XTMP("MPIF_SEEDING","A31 ERR",DFN)=A31,A31E=A31E+1
"RTN","MPIFSEED",48,0)
 .; ^ generate A31 message to MPI
"RTN","MPIFSEED",49,0)
DONE S ^XTMP("MPIF_SEEDING","TOTAL","PROCESSED")=CNT
"RTN","MPIFSEED",50,0)
 S ^XTMP("MPIF_SEEDING","TOTAL","A31 SENT")=XICN
"RTN","MPIFSEED",51,0)
 S ^XTMP("MPIF_SEEDING","TOTAL","A31 ERR")=A31E
"RTN","MPIFSEED",52,0)
 D NOW^%DTC
"RTN","MPIFSEED",53,0)
 S ^XTMP("MPIF_SEEDING","STOPPED")=%
"RTN","MPIFSEED",54,0)
 K %
"RTN","MPIFSEED",55,0)
 Q
"VER")
8.0^22.0
**END**
**END**
