Released PSO*7*239 SEQ #219
Extracted from mail message
**KIDS**:PSO*7.0*239^

**INSTALL NAME**
PSO*7.0*239
"BLD",5960,0)
PSO*7.0*239^OUTPATIENT PHARMACY^0^3060918^y
"BLD",5960,1,0)
^^295^295^3060825^
"BLD",5960,1,1,0)
The following describes all of the changes included in this patch:
"BLD",5960,1,2,0)
 
"BLD",5960,1,3,0)
1.  For Remedy Ticket 130112:
"BLD",5960,1,4,0)
 
"BLD",5960,1,5,0)
After installation of patch PSO*7*226, it was reported that the activity
"BLD",5960,1,6,0)
log entries generated by the patch were confusing. A large part of patch
"BLD",5960,1,7,0)
PSO*7*226 was to cancel any erroneously billed copays and to define any
"BLD",5960,1,8,0)
missing IBQ nodes on the prescription using the SC/EI answers stored on
"BLD",5960,1,9,0)
the ICD node.  For those prescriptions where the IBQ node was defined, an
"BLD",5960,1,10,0)
activity log entry was created with a reason of "RETURNED".  For those
"BLD",5960,1,11,0)
prescriptions where copay was cancelled, a copay activity log was
"BLD",5960,1,12,0)
generated. The following are examples of those types of entries made by
"BLD",5960,1,13,0)
PSO*7*226.
"BLD",5960,1,14,0)
 
"BLD",5960,1,15,0)
Activity Log Example:
"BLD",5960,1,16,0)
 
"BLD",5960,1,17,0)
  1   11/28/05    X-INTERFACE    ORIGINAL       PHARMACIST,ONE
"BLD",5960,1,18,0)
    Comments: Prescription sent to external interface.
"BLD",5960,1,19,0)
  2   11/28/05    RETURNED       ORIGINAL       POSTMASTER
"BLD",5960,1,20,0)
    Comments:  BKGD CIDC UPDATE
"BLD",5960,1,21,0)
  3   11/29/05    X-INTERFACE    REFILL 1       PHARMACIST,TWO
"BLD",5960,1,22,0)
    Comments: Prescription sent to external interface.
"BLD",5960,1,23,0)
 
"BLD",5960,1,24,0)
Copay Activity Log Example:
"BLD",5960,1,25,0)
 
"BLD",5960,1,26,0)
  1   02/01/06    COPAY RESET          ORIGINAL       PHARMACIST,ONE
"BLD",5960,1,27,0)
    Comment:-BKGD CIDC COPAY CANCEL  Old value=Copay   New value=No Copay
"BLD",5960,1,28,0)
  2   02/01/06    REMOVE COPAY CHARGE  ORIGINAL       PHARMACIST,ONE
"BLD",5960,1,29,0)
    Comment: RX EDITED -BKGD CIDC COPAY CANCEL
"BLD",5960,1,30,0)
 
"BLD",5960,1,31,0)
To eliminate any confusion, patch PSO*7*239 provides an Activity Log 
"BLD",5960,1,32,0)
Correction process/Clean-up routine.  This routine will take the activity
"BLD",5960,1,33,0)
log entries created by patch PSO*7*226, move them to the copay activity
"BLD",5960,1,34,0)
log, and then subsequently will delete the activity log entries.  Also,
"BLD",5960,1,35,0)
the comment on the copay activity log entries where copay was cancelled as
"BLD",5960,1,36,0)
well as those entries moved to the copay activity log will be changed to
"BLD",5960,1,37,0)
"CIDC CLEANUP".  The activity log will be resequenced to eliminate any
"BLD",5960,1,38,0)
missing nodes, and the copay activity log will be resequenced to insert
"BLD",5960,1,39,0)
the new entries by date and time.  The following are examples of the
"BLD",5960,1,40,0)
updated entries:
"BLD",5960,1,41,0)
 
"BLD",5960,1,42,0)
  -Note that sequence two from the above example was removed and the
"BLD",5960,1,43,0)
   third sequence was moved up.
"BLD",5960,1,44,0)
 
"BLD",5960,1,45,0)
  1   11/28/05    X-INTERFACE    ORIGINAL       PHARMACIST,ONE
"BLD",5960,1,46,0)
    Comments: Prescription sent to external interface.
"BLD",5960,1,47,0)
  2   11/28/05    X-INTERFACE    REFILL 1       PHARMACIST,TWO
"BLD",5960,1,48,0)
    Comments: Prescription sent to external interface.
"BLD",5960,1,49,0)
 
"BLD",5960,1,50,0)
  -The next entry shows an Activity log entry moved to Copay Activity log:
"BLD",5960,1,51,0)
 
"BLD",5960,1,52,0)
  1   11/28/05    COPAY RESET       ORIGINAL         POSTMASTER
"BLD",5960,1,53,0)
    Comment: CIDC CLEANUP
"BLD",5960,1,54,0)
 
"BLD",5960,1,55,0)
  -The following shows a cancelled Copay Activity Log entry comment
"BLD",5960,1,56,0)
  updated to "CIDC CLEANUP:
"BLD",5960,1,57,0)
 
"BLD",5960,1,58,0)
  1   02/01/06    COPAY RESET          ORIGINAL       POSTMASTER
"BLD",5960,1,59,0)
    Comment: CIDC CLEANUP  Old value=Copay   New value=No Copay
"BLD",5960,1,60,0)
  2   02/01/06    REMOVE COPAY CHARGE  ORIGINAL       POSTMASTER
"BLD",5960,1,61,0)
    Comment: CIDC CLEANUP  
"BLD",5960,1,62,0)
 
"BLD",5960,1,63,0)
This patch provides a listing of all prescriptions where the activity log
"BLD",5960,1,64,0)
was updated by the Clean-up routine, a means of checking the status of the
"BLD",5960,1,65,0)
Clean-up routine, and a means of stopping the Clean-up job if needed.  A
"BLD",5960,1,66,0)
detailed description of these functions is located in the Technical
"BLD",5960,1,67,0)
description.
"BLD",5960,1,68,0)
 
"BLD",5960,1,69,0)
When installing this patch, the activity log Clean-up portion of this
"BLD",5960,1,70,0)
patch is optional.  However, it is highly recommended that it be run for 
"BLD",5960,1,71,0)
consistency and maintainability.
"BLD",5960,1,72,0)
 
"BLD",5960,1,73,0)
Once the Clean-up routine has completed a mailman message will be sent to 
"BLD",5960,1,74,0)
the user who installed the patch.  The following is an example:
"BLD",5960,1,75,0)
 
"BLD",5960,1,76,0)
    Subj: Outpatient Pharmacy PSO*7*239 CIDC ACTIVITY LOGS CORRECTION  
"BLD",5960,1,77,0)
    [#200121] 03/06/06@13:56  4 lines
"BLD",5960,1,78,0)
    From: PSO*7*239 CIDC ACTIVITY LOGS CORRECTION  In 'IN' basket.   Page
"BLD",5960,1,79,0)
    1 *New*
"BLD",5960,1,80,0)
    
"BLD",5960,1,81,0)
-------------------------------------------------------------------------
"BLD",5960,1,82,0)
    The CIDC ACTIVITY LOGS CORRECTION job for the Outpatient Pharmacy
"BLD",5960,1,83,0)
    patch (PSO*7*239) started MAR 06, 2006@13:56:04
"BLD",5960,1,84,0)
    and completed MAR 06, 2006@13:56:04.
"BLD",5960,1,85,0)
 
"BLD",5960,1,86,0)
    Enter message action (in IN basket): Ignore//
"BLD",5960,1,87,0)
 
"BLD",5960,1,88,0)
2. The following issues were found during unit testing for backdoor 
"BLD",5960,1,89,0)
Outpatient Pharmacy orders, and the corrections are included in this
"BLD",5960,1,90,0)
patch. 
"BLD",5960,1,91,0)
 
"BLD",5960,1,92,0)
A.  When a prescriptions with an exempt patient status is renewed and the
"BLD",5960,1,93,0)
user changes the value of service connected (SC), the default value was
"BLD",5960,1,94,0)
stored instead of the changed value.  This only occurred for the SC
"BLD",5960,1,95,0)
prompt.  The renew process has been modified to store the changed value.
"BLD",5960,1,96,0)
 
"BLD",5960,1,97,0)
B.  When prescription information was stored when the RX Patient Status 
"BLD",5960,1,98,0)
was exempt from copay, the IBQ node was being stored needlessly.  This
"BLD",5960,1,99,0)
patch will remove the functionality that stored this node.
"BLD",5960,1,100,0)
                                           
"BLD",5960,1,101,0)
C.  For a patient defined as SC<50 but had a null SC percentage value 
"BLD",5960,1,102,0)
defined, backdoor Outpatient Pharmacy was asking the SC prompt but not
"BLD",5960,1,103,0)
storing the answers. The SC prompt is only displayed for those
"BLD",5960,1,104,0)
prescriptions that the Scheduling DBIA #1579 and/or the Integrated 
"BLD",5960,1,105,0)
Billing (IB) DBIA #125 determines that it should be asked.  Upon release
"BLD",5960,1,106,0)
of the fill, a "PRESCRIPTION QUESTIONS REVIEW NEEDED" mailman message
"BLD",5960,1,107,0)
requesting entry of the SC field was sent to holders of the PSO COPAY
"BLD",5960,1,108,0)
key.  Because this functionality uses the same checking mechanism as
"BLD",5960,1,109,0)
non-exempt new orders, the following functions were affected by this
"BLD",5960,1,110,0)
change:  copies, renews and edits that create a new order. This patch will
"BLD",5960,1,111,0)
store the SC answer for null SC percentage values.
"BLD",5960,1,112,0)
 
"BLD",5960,1,113,0)
D.  The SC prompt was not asked in Computerized Patient Record System 
"BLD",5960,1,114,0)
(CPRS), but was asked in backdoor Outpatient Pharmacy. No default answer
"BLD",5960,1,115,0)
was shown in backdoor due to the question not being asked in CRPS.  This
"BLD",5960,1,116,0)
occurred for any SC percentage that the SDCO22 API (#1579) returned a
"BLD",5960,1,117,0)
value that indicated to not ask the SC question but IB returned a flag
"BLD",5960,1,118,0)
that indicated that the SC question should be asked.  This problem occurs
"BLD",5960,1,119,0)
for a variety of SC percentages based on how the patient's eligibility is
"BLD",5960,1,120,0)
defined in enrollment.  This patch will tell CPRS to ask SC for this
"BLD",5960,1,121,0)
scenario.
"BLD",5960,1,122,0)
 
"BLD",5960,1,123,0)
E.  It was found that edits made to SC and/or EI's during COMPLETE ORDERS
"BLD",5960,1,124,0)
FROM OERR [PSO LMOE FINISH] option and the finish function in the PATIENT
"BLD",5960,1,125,0)
PRESCRIPTION PROCESSING [PSO LM BACKDOOR ORDERS] option were not reflected
"BLD",5960,1,126,0)
in CPRS.  With the CIDC patches, a new standardized segment was created to
"BLD",5960,1,127,0)
pass SC, EI's and ICD-9 diagnosis codes and use of the old segment was
"BLD",5960,1,128,0)
discontinued. When the CPRS CIDC switch is off, CPRS is looking at the old
"BLD",5960,1,129,0)
segment for updated orders. This patch adds the functionality to send both
"BLD",5960,1,130,0)
ZSC and ZCL segments.
"BLD",5960,1,131,0)
 
"BLD",5960,1,132,0)
F.  When using the edit function in the PATIENT PRESCRIPTION PROCESSING
"BLD",5960,1,133,0)
option [PSO LM BACKDOOR ORDERS], the total number of entries in the ICD
"BLD",5960,1,134,0)
DIAGNOSIS multiple (#52311) was being defined as one number less than it
"BLD",5960,1,135,0)
should have been.  For example, eight diagnosis codes entered but the 
"BLD",5960,1,136,0)
multiple shows seven as the total number of entries for the multiple.  The
"BLD",5960,1,137,0)
diagnosis codes were displayed correctly to the user.  This patch will
"BLD",5960,1,138,0)
store the correct number of entries when edits are performed.
"BLD",5960,1,139,0)
 
"BLD",5960,1,140,0)
G.  The PSOHLNE3 API IA (#4666) was defining an activity log entry that 
"BLD",5960,1,141,0)
stated "Clinical Indicators and SC/EI's were updated from a CPRS e-sig 
"BLD",5960,1,142,0)
edit..." for all prescriptions passed through the API.  Also, it was 
"BLD",5960,1,143,0)
needlessly defining a copay activity log entry for supply items and
"BLD",5960,1,144,0)
investigational drugs.   Last, it was storing a copay activity log entry
"BLD",5960,1,145,0)
(copay to no copay) that was set erroneously when the provider edits
"BLD",5960,1,146,0)
SC/EI's during sign of a verbal/telephone order leaving the prescription
"BLD",5960,1,147,0)
as no copay.  This API is used to pass data from CPRS to OP when a verbal
"BLD",5960,1,148,0)
or telephone order is signed in CPRS when the CPRS CIDC Switch is on.  
"BLD",5960,1,149,0)
This patch limits the setting of the activity log to only those
"BLD",5960,1,150,0)
prescriptions where SC, EI's and/or ICD's were changed during sign order.
"BLD",5960,1,151,0)
And, it eliminates setting the copay activity log for supply items and
"BLD",5960,1,152,0)
investigational drugs as well as eliminating the erroneous "copay to no 
"BLD",5960,1,153,0)
copay" activity log entry.
"BLD",5960,1,154,0)
 
"BLD",5960,1,155,0)
H.  The RESET COPAY STATUS/CANCEL CHARGES option [PSOCP RESET COPAY 
"BLD",5960,1,156,0)
STATUS] was overlaying the previously stored diagnosis code when storing
"BLD",5960,1,157,0)
updated information.  Also, the default answer for SC was not being
"BLD",5960,1,158,0)
displayed for SC<50% patients.  This patch corrects these issues.
"BLD",5960,1,159,0)
 
"BLD",5960,1,160,0)
I.  When the CPRS CIDC switch is turned on, the B cross reference was 
"BLD",5960,1,161,0)
not being defined in the ICD DIAGNOSIS field (#311) in PENDING OUTPATIENT
"BLD",5960,1,162,0)
ORDERS file (#52.41).  For telephone/verbal orders signed in CPRS and 
"BLD",5960,1,163,0)
CPRS renewals, the B cross reference was not being defined in the ICD
"BLD",5960,1,164,0)
DIAGNOSIS field (#52311) in PRESCRIPTION file (#52).  This was not
"BLD",5960,1,165,0)
reported as an issue, but the correction is being made in this patch.
"BLD",5960,1,166,0)
 
"BLD",5960,1,167,0)
 
"BLD",5960,1,168,0)
Technical Descriptions:
"BLD",5960,1,169,0)
=======================
"BLD",5960,1,170,0)
1.  For Remedy Ticket 130112:
"BLD",5960,1,171,0)
 
"BLD",5960,1,172,0)
A.  A snapshot of the ACTIVITY LOG sub-file (#40) and the COPAY 
"BLD",5960,1,173,0)
ACTIVITY LOG sub-file (#107) will be stored in ^XTMP("PSOCIDC7") node,
"BLD",5960,1,174,0)
and will be available for 90 days.
"BLD",5960,1,175,0)
 
"BLD",5960,1,176,0)
B.  The "BKGD CIDC UPDATE" activity log entry will be removed and the 
"BLD",5960,1,177,0)
ACTIVITY LOG sub-file (#40) will be re-subscripted to eliminate the
"BLD",5960,1,178,0)
missing node. The removed entry will be inserted in the COPAY ACTIVITY LOG
"BLD",5960,1,179,0)
sub-file (#107).  The date given in the old activity log entry will be
"BLD",5960,1,180,0)
used as the COPAY ACTIVITY LOG field (#.01) for the new entry. The copay
"BLD",5960,1,181,0)
activity log will be sorted by dates within the existing entries and
"BLD",5960,1,182,0)
including the new entry, then they will be stored back into the COPAY
"BLD",5960,1,183,0)
ACTIVITY LOG sub-file (#107). The comment for the new copay activity log
"BLD",5960,1,184,0)
entry as well as any existing copay activity log entries will be changed
"BLD",5960,1,185,0)
to state "CIDC CLEANUP" instead of "BKGD CIDC UPDATE".
"BLD",5960,1,186,0)
 
"BLD",5960,1,187,0)
C.  Because the copay to no copay or vice versa information was not 
"BLD",5960,1,188,0)
recorded in the old Activity log entry, those values can only reflect the 
"BLD",5960,1,189,0)
current state of the prescription, and it's thought that they should not
"BLD",5960,1,190,0)
be stored on the new entry.
"BLD",5960,1,191,0)
 
"BLD",5960,1,192,0)
D.  To print the report of all prescriptions updated by the Clean-up 
"BLD",5960,1,193,0)
routine, type the following from the programmer's prompt using the print 
"BLD",5960,1,194,0)
device that you prefer.
"BLD",5960,1,195,0)
 
"BLD",5960,1,196,0)
     >D RPT^PSOCIDC9
"BLD",5960,1,197,0)
      DEVICE: HOME//     UCX/TELNET     RIGHT MARGIN:80//
"BLD",5960,1,198,0)
 
"BLD",5960,1,199,0)
    Patch PSO*7*239 - Corrected Activity and Copay Activity logs
"BLD",5960,1,200,0)
 
"BLD",5960,1,201,0)
     Note that this report reflects all prescriptions where the activity
"BLD",5960,1,202,0)
     and/or copay activity logs were corrected. For detailed information,
"BLD",5960,1,203,0)
     please view the activity and copay activity log on the prescription.
"BLD",5960,1,204,0)
 
"BLD",5960,1,205,0)
     Date printed: MAR 6,2006@14:09:25                       Page: 1
"BLD",5960,1,206,0)
     ===============================================================
"BLD",5960,1,207,0)
     PATIENT NAME     (SSN)       DIV          RX# 
"BLD",5960,1,208,0)
     ---------------  -------  --------------  ------------
"BLD",5960,1,209,0)
     PATIENT,ONE      (B3453)  TROY, NY        200037
"BLD",5960,1,210,0)
     BPATIENT,TWO     (B0033)  TROY, NY        200049
"BLD",5960,1,211,0)
     BPATIENT,TWO     (B0033)  TROY, NY        200050
"BLD",5960,1,212,0)
 
"BLD",5960,1,213,0)
E.  The following is an example of a status query for the Clean-up 
"BLD",5960,1,214,0)
routine, and it must be run from programmer's mode:
"BLD",5960,1,215,0)
 
"BLD",5960,1,216,0)
     >D STATUS^PSOCIDC7
"BLD",5960,1,217,0)
    
"BLD",5960,1,218,0)
      Currently processing:
"BLD",5960,1,219,0)
            Date being processed > Nov 3, 2005
"BLD",5960,1,220,0)
                            RX # > 1375666
"BLD",5960,1,221,0)
 
"BLD",5960,1,222,0)
F.  A stop function has been provided in case the system needs to be
"BLD",5960,1,223,0)
shut down for an emergency or other reason.  Then when the system is back
"BLD",5960,1,224,0)
up and you are ready you may restart the job, it will resume where it
"BLD",5960,1,225,0)
left off.  You may restart by entering D ^PSOCIDC7 at the programmer's
"BLD",5960,1,226,0)
prompt.  The following is an example:
"BLD",5960,1,227,0)
 
"BLD",5960,1,228,0)
     >D STOP^PSOCIDC7
"BLD",5960,1,229,0)
 
"BLD",5960,1,230,0)
      Outpatient Activity Logs Correction Job - set to STOP Soon
"BLD",5960,1,231,0)
 
"BLD",5960,1,232,0)
      Check Status to be sure it has stopped and is not running...
"BLD",5960,1,233,0)
        
"BLD",5960,1,234,0)
                   (D STATUS^PSOCIDC7)
"BLD",5960,1,235,0)
 
"BLD",5960,1,236,0)
G.  The Clean-up routine can be executed from the programmer's 
"BLD",5960,1,237,0)
prompt instead of through the patch installation.  Also, restarting the
"BLD",5960,1,238,0)
Clean-up routine after using the stop function described above is 
"BLD",5960,1,239,0)
performed in the same manner.  Below is an example how to perform this 
"BLD",5960,1,240,0)
function:
"BLD",5960,1,241,0)
 
"BLD",5960,1,242,0)
     >D ^PSOCIDC7
"BLD",5960,1,243,0)
 
"BLD",5960,1,244,0)
     ****************** SELECT RUN OPTION ******************
"BLD",5960,1,245,0)
     Do you want to run the activity logs correction process? Y or N// YES
"BLD",5960,1,246,0)
     Enter when to Queue the CIDC ACTIVITY LOGS CORRECTION job to run in 
"BLD",5960,1,247,0)
     date@time format:  NOW//
"BLD",5960,1,248,0)
 
"BLD",5960,1,249,0)
     ===================================================
"BLD",5960,1,250,0)
     Queuing background job for CIDC ACTIVITY LOGS CORRECTION...
"BLD",5960,1,251,0)
     Start time: Month day, year@time
"BLD",5960,1,252,0)
     ===================================================
"BLD",5960,1,253,0)
     *** Task #NNNNN Queued! ***
"BLD",5960,1,254,0)
 
"BLD",5960,1,255,0)
 
"BLD",5960,1,256,0)
2. The following correlates to the items described in number two in the
"BLD",5960,1,257,0)
Functional Description section:
"BLD",5960,1,258,0)
 
"BLD",5960,1,259,0)
A. The renew process has been modified to store the changed value
"BLD",5960,1,260,0)
for SC in the PRESCRIPTION file (#52).
"BLD",5960,1,261,0)
 
"BLD",5960,1,262,0)
B. This patch will remove all of the functionality that stored the
"BLD",5960,1,263,0)
unnecessary IBQ node.
"BLD",5960,1,264,0)
 
"BLD",5960,1,265,0)
C.  Outpatient was modified to store the SC value for patients with a null
"BLD",5960,1,266,0)
SC percentage which eliminates the sending of a "PRESCRIPTION QUESTIONS
"BLD",5960,1,267,0)
REVIEW NEEDED" Mailman message.
"BLD",5960,1,268,0)
 
"BLD",5960,1,269,0)
D.  The check for the PSOSCMX variable was restored to the PSOCP
"BLD",5960,1,270,0)
routine.  
"BLD",5960,1,271,0)
 
"BLD",5960,1,272,0)
E.  This patch adds the functionality to send both ZSC and ZCL segments to
"BLD",5960,1,273,0)
CPRS. The ZSC passes SC/EI's only.  The ZCL node passes SC, EI's, and
"BLD",5960,1,274,0)
ICD-9 Diagnosis codes.
"BLD",5960,1,275,0)
 
"BLD",5960,1,276,0)
F.  This patch will correctly store the third and fourth piece of the zero
"BLD",5960,1,277,0)
node of the ICD DIAGNOSIS multiple (#52311) of PRESCRIPTION file (#52).
"BLD",5960,1,278,0)
 
"BLD",5960,1,279,0)
G.  The PSOHLNE3 API IA (#4666) was changed to only store entries in the 
"BLD",5960,1,280,0)
ACTIVITY LOG multiple (#40) when SC, EI's, and/or ICD's were edited.  
"BLD",5960,1,281,0)
For supply items and investigational drugs, no copay activity log entries 
"BLD",5960,1,282,0)
will be stored.  Also, it was modified to prevent storage of a copay
"BLD",5960,1,283,0)
activity log entry (copay to no copay) that was set erroneously when the
"BLD",5960,1,284,0)
provider edits SC/EI's during sign of a verbal/telephone order leaving the
"BLD",5960,1,285,0)
prescription as no copay.
"BLD",5960,1,286,0)
 
"BLD",5960,1,287,0)
H.  The RESET COPAY STATUS/CANCEL CHARGES [PSOCP RESET COPAY STATUS] 
"BLD",5960,1,288,0)
option has been modified to not overlay the previously stored 
"BLD",5960,1,289,0)
ICD-9 Diagnosis code with a null value and to display previously entered
"BLD",5960,1,290,0)
SC values as a default answer.
"BLD",5960,1,291,0)
 
"BLD",5960,1,292,0)
I.  The B cross reference will be set for the ICD DIAGNOSIS field (#311)
"BLD",5960,1,293,0)
in PENDING OUTPATIENT ORDERS file (#52.41) and in the ICD DIAGNOSIS field
"BLD",5960,1,294,0)
(#52311) in PRESCRIPTION file (#52) for CPRS renewals/verbal/telephone 
"BLD",5960,1,295,0)
orders.
"BLD",5960,4,0)
^9.64PA^^
"BLD",5960,6)
10^
"BLD",5960,"ABPKG")
n
"BLD",5960,"INID")
^n
"BLD",5960,"INIT")
PSOCIDC7
"BLD",5960,"KRN",0)
^9.67PA^8989.52^19
"BLD",5960,"KRN",.4,0)
.4
"BLD",5960,"KRN",.401,0)
.401
"BLD",5960,"KRN",.402,0)
.402
"BLD",5960,"KRN",.403,0)
.403
"BLD",5960,"KRN",.5,0)
.5
"BLD",5960,"KRN",.84,0)
.84
"BLD",5960,"KRN",3.6,0)
3.6
"BLD",5960,"KRN",3.8,0)
3.8
"BLD",5960,"KRN",9.2,0)
9.2
"BLD",5960,"KRN",9.8,0)
9.8
"BLD",5960,"KRN",9.8,"NM",0)
^9.68A^23^21
"BLD",5960,"KRN",9.8,"NM",2,0)
PSOCIDC7^^0^B43535396
"BLD",5960,"KRN",9.8,"NM",3,0)
PSOCIDC9^^0^B14993294
"BLD",5960,"KRN",9.8,"NM",4,0)
PSOCIDC8^^0^B28837769
"BLD",5960,"KRN",9.8,"NM",5,0)
PSON52^^0^B58876503
"BLD",5960,"KRN",9.8,"NM",7,0)
PSODIAG^^0^B62418422
"BLD",5960,"KRN",9.8,"NM",8,0)
PSONEW2^^0^B31577282
"BLD",5960,"KRN",9.8,"NM",9,0)
PSONEWF^^0^B35718015
"BLD",5960,"KRN",9.8,"NM",10,0)
PSONEWG^^0^B23242345
"BLD",5960,"KRN",9.8,"NM",11,0)
PSOHLNE3^^0^B55635403
"BLD",5960,"KRN",9.8,"NM",12,0)
PSOCP^^0^B68323456
"BLD",5960,"KRN",9.8,"NM",13,0)
PSOCPB^^0^B78420405
"BLD",5960,"KRN",9.8,"NM",14,0)
PSOHLNE1^^0^B72518246
"BLD",5960,"KRN",9.8,"NM",15,0)
PSOMLLD2^^0^B18734428
"BLD",5960,"KRN",9.8,"NM",16,0)
PSORN52^^0^B42247336
"BLD",5960,"KRN",9.8,"NM",17,0)
PSORN52D^^0^B30768895
"BLD",5960,"KRN",9.8,"NM",18,0)
PSORENW1^^0^B64596305
"BLD",5960,"KRN",9.8,"NM",19,0)
PSOHLSN1^^0^B81359124
"BLD",5960,"KRN",9.8,"NM",20,0)
PSOHLSN2^^0^B9304423
"BLD",5960,"KRN",9.8,"NM",21,0)
PSOCP1^^0^B5020940
"BLD",5960,"KRN",9.8,"NM",22,0)
PSOCPC^^0^B67206155
"BLD",5960,"KRN",9.8,"NM",23,0)
PSOHLNEW^^0^B77391528
"BLD",5960,"KRN",9.8,"NM","B","PSOCIDC7",2)

"BLD",5960,"KRN",9.8,"NM","B","PSOCIDC8",4)

"BLD",5960,"KRN",9.8,"NM","B","PSOCIDC9",3)

"BLD",5960,"KRN",9.8,"NM","B","PSOCP",12)

"BLD",5960,"KRN",9.8,"NM","B","PSOCP1",21)

"BLD",5960,"KRN",9.8,"NM","B","PSOCPB",13)

"BLD",5960,"KRN",9.8,"NM","B","PSOCPC",22)

"BLD",5960,"KRN",9.8,"NM","B","PSODIAG",7)

"BLD",5960,"KRN",9.8,"NM","B","PSOHLNE1",14)

"BLD",5960,"KRN",9.8,"NM","B","PSOHLNE3",11)

"BLD",5960,"KRN",9.8,"NM","B","PSOHLNEW",23)

"BLD",5960,"KRN",9.8,"NM","B","PSOHLSN1",19)

"BLD",5960,"KRN",9.8,"NM","B","PSOHLSN2",20)

"BLD",5960,"KRN",9.8,"NM","B","PSOMLLD2",15)

"BLD",5960,"KRN",9.8,"NM","B","PSON52",5)

"BLD",5960,"KRN",9.8,"NM","B","PSONEW2",8)

"BLD",5960,"KRN",9.8,"NM","B","PSONEWF",9)

"BLD",5960,"KRN",9.8,"NM","B","PSONEWG",10)

"BLD",5960,"KRN",9.8,"NM","B","PSORENW1",18)

"BLD",5960,"KRN",9.8,"NM","B","PSORN52",16)

"BLD",5960,"KRN",9.8,"NM","B","PSORN52D",17)

"BLD",5960,"KRN",19,0)
19
"BLD",5960,"KRN",19,"NM",0)
^9.68A^^
"BLD",5960,"KRN",19.1,0)
19.1
"BLD",5960,"KRN",101,0)
101
"BLD",5960,"KRN",409.61,0)
409.61
"BLD",5960,"KRN",771,0)
771
"BLD",5960,"KRN",870,0)
870
"BLD",5960,"KRN",8989.51,0)
8989.51
"BLD",5960,"KRN",8989.52,0)
8989.52
"BLD",5960,"KRN",8994,0)
8994
"BLD",5960,"KRN","B",.4,.4)

"BLD",5960,"KRN","B",.401,.401)

"BLD",5960,"KRN","B",.402,.402)

"BLD",5960,"KRN","B",.403,.403)

"BLD",5960,"KRN","B",.5,.5)

"BLD",5960,"KRN","B",.84,.84)

"BLD",5960,"KRN","B",3.6,3.6)

"BLD",5960,"KRN","B",3.8,3.8)

"BLD",5960,"KRN","B",9.2,9.2)

"BLD",5960,"KRN","B",9.8,9.8)

"BLD",5960,"KRN","B",19,19)

"BLD",5960,"KRN","B",19.1,19.1)

"BLD",5960,"KRN","B",101,101)

"BLD",5960,"KRN","B",409.61,409.61)

"BLD",5960,"KRN","B",771,771)

"BLD",5960,"KRN","B",870,870)

"BLD",5960,"KRN","B",8989.51,8989.51)

"BLD",5960,"KRN","B",8989.52,8989.52)

"BLD",5960,"KRN","B",8994,8994)

"BLD",5960,"QUES",0)
^9.62^2^2
"BLD",5960,"QUES",1,0)
POS1
"BLD",5960,"QUES",1,1)
YA^^
"BLD",5960,"QUES",1,"A")
Do you want to Run the activity log correction process? Y or N//
"BLD",5960,"QUES",1,"Q")
Enter Y for Yes to run the activity logs correction or N to just install the patch.
"BLD",5960,"QUES",2,0)
POS2
"BLD",5960,"QUES",2,1)
D^::%DT
"BLD",5960,"QUES",2,"A")
Enter when to Queue the Job to run in date@time format
"BLD",5960,"QUES",2,"B")
NOW
"BLD",5960,"QUES",2,"M")
I XPDQUES("POS1")=0 K DIR
"BLD",5960,"QUES",2,"Q")
Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 030106@3:30p.
"BLD",5960,"QUES","B","POS1",1)

"BLD",5960,"QUES","B","POS2",2)

"BLD",5960,"REQB",0)
^9.611^4^4
"BLD",5960,"REQB",1,0)
PSO*7.0*226^2
"BLD",5960,"REQB",2,0)
PSO*7.0*235^2
"BLD",5960,"REQB",3,0)
PSO*7.0*237^2
"BLD",5960,"REQB",4,0)
PSO*7.0*148^2
"BLD",5960,"REQB","B","PSO*7.0*148",4)

"BLD",5960,"REQB","B","PSO*7.0*226",1)

"BLD",5960,"REQB","B","PSO*7.0*235",2)

"BLD",5960,"REQB","B","PSO*7.0*237",3)

"INIT")
PSOCIDC7
"MBREQ")
0
"PKG",206,-1)
1^1
"PKG",206,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",206,20,0)
^9.402P^^
"PKG",206,22,0)
^9.49I^1^1
"PKG",206,22,1,0)
7.0^2971216^2990510^66476
"PKG",206,22,1,"PAH",1,0)
239^3060918^123457145
"PKG",206,22,1,"PAH",1,1,0)
^^295^295^3060918
"PKG",206,22,1,"PAH",1,1,1,0)
The following describes all of the changes included in this patch:
"PKG",206,22,1,"PAH",1,1,2,0)
 
"PKG",206,22,1,"PAH",1,1,3,0)
1.  For Remedy Ticket 130112:
"PKG",206,22,1,"PAH",1,1,4,0)
 
"PKG",206,22,1,"PAH",1,1,5,0)
After installation of patch PSO*7*226, it was reported that the activity
"PKG",206,22,1,"PAH",1,1,6,0)
log entries generated by the patch were confusing. A large part of patch
"PKG",206,22,1,"PAH",1,1,7,0)
PSO*7*226 was to cancel any erroneously billed copays and to define any
"PKG",206,22,1,"PAH",1,1,8,0)
missing IBQ nodes on the prescription using the SC/EI answers stored on
"PKG",206,22,1,"PAH",1,1,9,0)
the ICD node.  For those prescriptions where the IBQ node was defined, an
"PKG",206,22,1,"PAH",1,1,10,0)
activity log entry was created with a reason of "RETURNED".  For those
"PKG",206,22,1,"PAH",1,1,11,0)
prescriptions where copay was cancelled, a copay activity log was
"PKG",206,22,1,"PAH",1,1,12,0)
generated. The following are examples of those types of entries made by
"PKG",206,22,1,"PAH",1,1,13,0)
PSO*7*226.
"PKG",206,22,1,"PAH",1,1,14,0)
 
"PKG",206,22,1,"PAH",1,1,15,0)
Activity Log Example:
"PKG",206,22,1,"PAH",1,1,16,0)
 
"PKG",206,22,1,"PAH",1,1,17,0)
  1   11/28/05    X-INTERFACE    ORIGINAL       PHARMACIST,ONE
"PKG",206,22,1,"PAH",1,1,18,0)
    Comments: Prescription sent to external interface.
"PKG",206,22,1,"PAH",1,1,19,0)
  2   11/28/05    RETURNED       ORIGINAL       POSTMASTER
"PKG",206,22,1,"PAH",1,1,20,0)
    Comments:  BKGD CIDC UPDATE
"PKG",206,22,1,"PAH",1,1,21,0)
  3   11/29/05    X-INTERFACE    REFILL 1       PHARMACIST,TWO
"PKG",206,22,1,"PAH",1,1,22,0)
    Comments: Prescription sent to external interface.
"PKG",206,22,1,"PAH",1,1,23,0)
 
"PKG",206,22,1,"PAH",1,1,24,0)
Copay Activity Log Example:
"PKG",206,22,1,"PAH",1,1,25,0)
 
"PKG",206,22,1,"PAH",1,1,26,0)
  1   02/01/06    COPAY RESET          ORIGINAL       PHARMACIST,ONE
"PKG",206,22,1,"PAH",1,1,27,0)
    Comment:-BKGD CIDC COPAY CANCEL  Old value=Copay   New value=No Copay
"PKG",206,22,1,"PAH",1,1,28,0)
  2   02/01/06    REMOVE COPAY CHARGE  ORIGINAL       PHARMACIST,ONE
"PKG",206,22,1,"PAH",1,1,29,0)
    Comment: RX EDITED -BKGD CIDC COPAY CANCEL
"PKG",206,22,1,"PAH",1,1,30,0)
 
"PKG",206,22,1,"PAH",1,1,31,0)
To eliminate any confusion, patch PSO*7*239 provides an Activity Log 
"PKG",206,22,1,"PAH",1,1,32,0)
Correction process/Clean-up routine.  This routine will take the activity
"PKG",206,22,1,"PAH",1,1,33,0)
log entries created by patch PSO*7*226, move them to the copay activity
"PKG",206,22,1,"PAH",1,1,34,0)
log, and then subsequently will delete the activity log entries.  Also,
"PKG",206,22,1,"PAH",1,1,35,0)
the comment on the copay activity log entries where copay was cancelled as
"PKG",206,22,1,"PAH",1,1,36,0)
well as those entries moved to the copay activity log will be changed to
"PKG",206,22,1,"PAH",1,1,37,0)
"CIDC CLEANUP".  The activity log will be resequenced to eliminate any
"PKG",206,22,1,"PAH",1,1,38,0)
missing nodes, and the copay activity log will be resequenced to insert
"PKG",206,22,1,"PAH",1,1,39,0)
the new entries by date and time.  The following are examples of the
"PKG",206,22,1,"PAH",1,1,40,0)
updated entries:
"PKG",206,22,1,"PAH",1,1,41,0)
 
"PKG",206,22,1,"PAH",1,1,42,0)
  -Note that sequence two from the above example was removed and the
"PKG",206,22,1,"PAH",1,1,43,0)
   third sequence was moved up.
"PKG",206,22,1,"PAH",1,1,44,0)
 
"PKG",206,22,1,"PAH",1,1,45,0)
  1   11/28/05    X-INTERFACE    ORIGINAL       PHARMACIST,ONE
"PKG",206,22,1,"PAH",1,1,46,0)
    Comments: Prescription sent to external interface.
"PKG",206,22,1,"PAH",1,1,47,0)
  2   11/28/05    X-INTERFACE    REFILL 1       PHARMACIST,TWO
"PKG",206,22,1,"PAH",1,1,48,0)
    Comments: Prescription sent to external interface.
"PKG",206,22,1,"PAH",1,1,49,0)
 
"PKG",206,22,1,"PAH",1,1,50,0)
  -The next entry shows an Activity log entry moved to Copay Activity log:
"PKG",206,22,1,"PAH",1,1,51,0)
 
"PKG",206,22,1,"PAH",1,1,52,0)
  1   11/28/05    COPAY RESET       ORIGINAL         POSTMASTER
"PKG",206,22,1,"PAH",1,1,53,0)
    Comment: CIDC CLEANUP
"PKG",206,22,1,"PAH",1,1,54,0)
 
"PKG",206,22,1,"PAH",1,1,55,0)
  -The following shows a cancelled Copay Activity Log entry comment
"PKG",206,22,1,"PAH",1,1,56,0)
  updated to "CIDC CLEANUP:
"PKG",206,22,1,"PAH",1,1,57,0)
 
"PKG",206,22,1,"PAH",1,1,58,0)
  1   02/01/06    COPAY RESET          ORIGINAL       POSTMASTER
"PKG",206,22,1,"PAH",1,1,59,0)
    Comment: CIDC CLEANUP  Old value=Copay   New value=No Copay
"PKG",206,22,1,"PAH",1,1,60,0)
  2   02/01/06    REMOVE COPAY CHARGE  ORIGINAL       POSTMASTER
"PKG",206,22,1,"PAH",1,1,61,0)
    Comment: CIDC CLEANUP  
"PKG",206,22,1,"PAH",1,1,62,0)
 
"PKG",206,22,1,"PAH",1,1,63,0)
This patch provides a listing of all prescriptions where the activity log
"PKG",206,22,1,"PAH",1,1,64,0)
was updated by the Clean-up routine, a means of checking the status of the
"PKG",206,22,1,"PAH",1,1,65,0)
Clean-up routine, and a means of stopping the Clean-up job if needed.  A
"PKG",206,22,1,"PAH",1,1,66,0)
detailed description of these functions is located in the Technical
"PKG",206,22,1,"PAH",1,1,67,0)
description.
"PKG",206,22,1,"PAH",1,1,68,0)
 
"PKG",206,22,1,"PAH",1,1,69,0)
When installing this patch, the activity log Clean-up portion of this
"PKG",206,22,1,"PAH",1,1,70,0)
patch is optional.  However, it is highly recommended that it be run for 
"PKG",206,22,1,"PAH",1,1,71,0)
consistency and maintainability.
"PKG",206,22,1,"PAH",1,1,72,0)
 
"PKG",206,22,1,"PAH",1,1,73,0)
Once the Clean-up routine has completed a mailman message will be sent to 
"PKG",206,22,1,"PAH",1,1,74,0)
the user who installed the patch.  The following is an example:
"PKG",206,22,1,"PAH",1,1,75,0)
 
"PKG",206,22,1,"PAH",1,1,76,0)
    Subj: Outpatient Pharmacy PSO*7*239 CIDC ACTIVITY LOGS CORRECTION  
"PKG",206,22,1,"PAH",1,1,77,0)
    [#200121] 03/06/06@13:56  4 lines
"PKG",206,22,1,"PAH",1,1,78,0)
    From: PSO*7*239 CIDC ACTIVITY LOGS CORRECTION  In 'IN' basket.   Page
"PKG",206,22,1,"PAH",1,1,79,0)
    1 *New*
"PKG",206,22,1,"PAH",1,1,80,0)
    
"PKG",206,22,1,"PAH",1,1,81,0)
-------------------------------------------------------------------------
"PKG",206,22,1,"PAH",1,1,82,0)
    The CIDC ACTIVITY LOGS CORRECTION job for the Outpatient Pharmacy
"PKG",206,22,1,"PAH",1,1,83,0)
    patch (PSO*7*239) started MAR 06, 2006@13:56:04
"PKG",206,22,1,"PAH",1,1,84,0)
    and completed MAR 06, 2006@13:56:04.
"PKG",206,22,1,"PAH",1,1,85,0)
 
"PKG",206,22,1,"PAH",1,1,86,0)
    Enter message action (in IN basket): Ignore//
"PKG",206,22,1,"PAH",1,1,87,0)
 
"PKG",206,22,1,"PAH",1,1,88,0)
2. The following issues were found during unit testing for backdoor 
"PKG",206,22,1,"PAH",1,1,89,0)
Outpatient Pharmacy orders, and the corrections are included in this
"PKG",206,22,1,"PAH",1,1,90,0)
patch. 
"PKG",206,22,1,"PAH",1,1,91,0)
 
"PKG",206,22,1,"PAH",1,1,92,0)
A.  When a prescriptions with an exempt patient status is renewed and the
"PKG",206,22,1,"PAH",1,1,93,0)
user changes the value of service connected (SC), the default value was
"PKG",206,22,1,"PAH",1,1,94,0)
stored instead of the changed value.  This only occurred for the SC
"PKG",206,22,1,"PAH",1,1,95,0)
prompt.  The renew process has been modified to store the changed value.
"PKG",206,22,1,"PAH",1,1,96,0)
 
"PKG",206,22,1,"PAH",1,1,97,0)
B.  When prescription information was stored when the RX Patient Status 
"PKG",206,22,1,"PAH",1,1,98,0)
was exempt from copay, the IBQ node was being stored needlessly.  This
"PKG",206,22,1,"PAH",1,1,99,0)
patch will remove the functionality that stored this node.
"PKG",206,22,1,"PAH",1,1,100,0)
                                           
"PKG",206,22,1,"PAH",1,1,101,0)
C.  For a patient defined as SC<50 but had a null SC percentage value 
"PKG",206,22,1,"PAH",1,1,102,0)
defined, backdoor Outpatient Pharmacy was asking the SC prompt but not
"PKG",206,22,1,"PAH",1,1,103,0)
storing the answers. The SC prompt is only displayed for those
"PKG",206,22,1,"PAH",1,1,104,0)
prescriptions that the Scheduling DBIA #1579 and/or the Integrated 
"PKG",206,22,1,"PAH",1,1,105,0)
Billing (IB) DBIA #125 determines that it should be asked.  Upon release
"PKG",206,22,1,"PAH",1,1,106,0)
of the fill, a "PRESCRIPTION QUESTIONS REVIEW NEEDED" mailman message
"PKG",206,22,1,"PAH",1,1,107,0)
requesting entry of the SC field was sent to holders of the PSO COPAY
"PKG",206,22,1,"PAH",1,1,108,0)
key.  Because this functionality uses the same checking mechanism as
"PKG",206,22,1,"PAH",1,1,109,0)
non-exempt new orders, the following functions were affected by this
"PKG",206,22,1,"PAH",1,1,110,0)
change:  copies, renews and edits that create a new order. This patch will
"PKG",206,22,1,"PAH",1,1,111,0)
store the SC answer for null SC percentage values.
"PKG",206,22,1,"PAH",1,1,112,0)
 
"PKG",206,22,1,"PAH",1,1,113,0)
D.  The SC prompt was not asked in Computerized Patient Record System 
"PKG",206,22,1,"PAH",1,1,114,0)
(CPRS), but was asked in backdoor Outpatient Pharmacy. No default answer
"PKG",206,22,1,"PAH",1,1,115,0)
was shown in backdoor due to the question not being asked in CRPS.  This
"PKG",206,22,1,"PAH",1,1,116,0)
occurred for any SC percentage that the SDCO22 API (#1579) returned a
"PKG",206,22,1,"PAH",1,1,117,0)
value that indicated to not ask the SC question but IB returned a flag
"PKG",206,22,1,"PAH",1,1,118,0)
that indicated that the SC question should be asked.  This problem occurs
"PKG",206,22,1,"PAH",1,1,119,0)
for a variety of SC percentages based on how the patient's eligibility is
"PKG",206,22,1,"PAH",1,1,120,0)
defined in enrollment.  This patch will tell CPRS to ask SC for this
"PKG",206,22,1,"PAH",1,1,121,0)
scenario.
"PKG",206,22,1,"PAH",1,1,122,0)
 
"PKG",206,22,1,"PAH",1,1,123,0)
E.  It was found that edits made to SC and/or EI's during COMPLETE ORDERS
"PKG",206,22,1,"PAH",1,1,124,0)
FROM OERR [PSO LMOE FINISH] option and the finish function in the PATIENT
"PKG",206,22,1,"PAH",1,1,125,0)
PRESCRIPTION PROCESSING [PSO LM BACKDOOR ORDERS] option were not reflected
"PKG",206,22,1,"PAH",1,1,126,0)
in CPRS.  With the CIDC patches, a new standardized segment was created to
"PKG",206,22,1,"PAH",1,1,127,0)
pass SC, EI's and ICD-9 diagnosis codes and use of the old segment was
"PKG",206,22,1,"PAH",1,1,128,0)
discontinued. When the CPRS CIDC switch is off, CPRS is looking at the old
"PKG",206,22,1,"PAH",1,1,129,0)
segment for updated orders. This patch adds the functionality to send both
"PKG",206,22,1,"PAH",1,1,130,0)
ZSC and ZCL segments.
"PKG",206,22,1,"PAH",1,1,131,0)
 
"PKG",206,22,1,"PAH",1,1,132,0)
F.  When using the edit function in the PATIENT PRESCRIPTION PROCESSING
"PKG",206,22,1,"PAH",1,1,133,0)
option [PSO LM BACKDOOR ORDERS], the total number of entries in the ICD
"PKG",206,22,1,"PAH",1,1,134,0)
DIAGNOSIS multiple (#52311) was being defined as one number less than it
"PKG",206,22,1,"PAH",1,1,135,0)
should have been.  For example, eight diagnosis codes entered but the 
"PKG",206,22,1,"PAH",1,1,136,0)
multiple shows seven as the total number of entries for the multiple.  The
"PKG",206,22,1,"PAH",1,1,137,0)
diagnosis codes were displayed correctly to the user.  This patch will
"PKG",206,22,1,"PAH",1,1,138,0)
store the correct number of entries when edits are performed.
"PKG",206,22,1,"PAH",1,1,139,0)
 
"PKG",206,22,1,"PAH",1,1,140,0)
G.  The PSOHLNE3 API IA (#4666) was defining an activity log entry that 
"PKG",206,22,1,"PAH",1,1,141,0)
stated "Clinical Indicators and SC/EI's were updated from a CPRS e-sig 
"PKG",206,22,1,"PAH",1,1,142,0)
edit..." for all prescriptions passed through the API.  Also, it was 
"PKG",206,22,1,"PAH",1,1,143,0)
needlessly defining a copay activity log entry for supply items and
"PKG",206,22,1,"PAH",1,1,144,0)
investigational drugs.   Last, it was storing a copay activity log entry
"PKG",206,22,1,"PAH",1,1,145,0)
(copay to no copay) that was set erroneously when the provider edits
"PKG",206,22,1,"PAH",1,1,146,0)
SC/EI's during sign of a verbal/telephone order leaving the prescription
"PKG",206,22,1,"PAH",1,1,147,0)
as no copay.  This API is used to pass data from CPRS to OP when a verbal
"PKG",206,22,1,"PAH",1,1,148,0)
or telephone order is signed in CPRS when the CPRS CIDC Switch is on.  
"PKG",206,22,1,"PAH",1,1,149,0)
This patch limits the setting of the activity log to only those
"PKG",206,22,1,"PAH",1,1,150,0)
prescriptions where SC, EI's and/or ICD's were changed during sign order.
"PKG",206,22,1,"PAH",1,1,151,0)
And, it eliminates setting the copay activity log for supply items and
"PKG",206,22,1,"PAH",1,1,152,0)
investigational drugs as well as eliminating the erroneous "copay to no 
"PKG",206,22,1,"PAH",1,1,153,0)
copay" activity log entry.
"PKG",206,22,1,"PAH",1,1,154,0)
 
"PKG",206,22,1,"PAH",1,1,155,0)
H.  The RESET COPAY STATUS/CANCEL CHARGES option [PSOCP RESET COPAY 
"PKG",206,22,1,"PAH",1,1,156,0)
STATUS] was overlaying the previously stored diagnosis code when storing
"PKG",206,22,1,"PAH",1,1,157,0)
updated information.  Also, the default answer for SC was not being
"PKG",206,22,1,"PAH",1,1,158,0)
displayed for SC<50% patients.  This patch corrects these issues.
"PKG",206,22,1,"PAH",1,1,159,0)
 
"PKG",206,22,1,"PAH",1,1,160,0)
I.  When the CPRS CIDC switch is turned on, the B cross reference was 
"PKG",206,22,1,"PAH",1,1,161,0)
not being defined in the ICD DIAGNOSIS field (#311) in PENDING OUTPATIENT
"PKG",206,22,1,"PAH",1,1,162,0)
ORDERS file (#52.41).  For telephone/verbal orders signed in CPRS and 
"PKG",206,22,1,"PAH",1,1,163,0)
CPRS renewals, the B cross reference was not being defined in the ICD
"PKG",206,22,1,"PAH",1,1,164,0)
DIAGNOSIS field (#52311) in PRESCRIPTION file (#52).  This was not
"PKG",206,22,1,"PAH",1,1,165,0)
reported as an issue, but the correction is being made in this patch.
"PKG",206,22,1,"PAH",1,1,166,0)
 
"PKG",206,22,1,"PAH",1,1,167,0)
 
"PKG",206,22,1,"PAH",1,1,168,0)
Technical Descriptions:
"PKG",206,22,1,"PAH",1,1,169,0)
=======================
"PKG",206,22,1,"PAH",1,1,170,0)
1.  For Remedy Ticket 130112:
"PKG",206,22,1,"PAH",1,1,171,0)
 
"PKG",206,22,1,"PAH",1,1,172,0)
A.  A snapshot of the ACTIVITY LOG sub-file (#40) and the COPAY 
"PKG",206,22,1,"PAH",1,1,173,0)
ACTIVITY LOG sub-file (#107) will be stored in ^XTMP("PSOCIDC7") node,
"PKG",206,22,1,"PAH",1,1,174,0)
and will be available for 90 days.
"PKG",206,22,1,"PAH",1,1,175,0)
 
"PKG",206,22,1,"PAH",1,1,176,0)
B.  The "BKGD CIDC UPDATE" activity log entry will be removed and the 
"PKG",206,22,1,"PAH",1,1,177,0)
ACTIVITY LOG sub-file (#40) will be re-subscripted to eliminate the
"PKG",206,22,1,"PAH",1,1,178,0)
missing node. The removed entry will be inserted in the COPAY ACTIVITY LOG
"PKG",206,22,1,"PAH",1,1,179,0)
sub-file (#107).  The date given in the old activity log entry will be
"PKG",206,22,1,"PAH",1,1,180,0)
used as the COPAY ACTIVITY LOG field (#.01) for the new entry. The copay
"PKG",206,22,1,"PAH",1,1,181,0)
activity log will be sorted by dates within the existing entries and
"PKG",206,22,1,"PAH",1,1,182,0)
including the new entry, then they will be stored back into the COPAY
"PKG",206,22,1,"PAH",1,1,183,0)
ACTIVITY LOG sub-file (#107). The comment for the new copay activity log
"PKG",206,22,1,"PAH",1,1,184,0)
entry as well as any existing copay activity log entries will be changed
"PKG",206,22,1,"PAH",1,1,185,0)
to state "CIDC CLEANUP" instead of "BKGD CIDC UPDATE".
"PKG",206,22,1,"PAH",1,1,186,0)
 
"PKG",206,22,1,"PAH",1,1,187,0)
C.  Because the copay to no copay or vice versa information was not 
"PKG",206,22,1,"PAH",1,1,188,0)
recorded in the old Activity log entry, those values can only reflect the 
"PKG",206,22,1,"PAH",1,1,189,0)
current state of the prescription, and it's thought that they should not
"PKG",206,22,1,"PAH",1,1,190,0)
be stored on the new entry.
"PKG",206,22,1,"PAH",1,1,191,0)
 
"PKG",206,22,1,"PAH",1,1,192,0)
D.  To print the report of all prescriptions updated by the Clean-up 
"PKG",206,22,1,"PAH",1,1,193,0)
routine, type the following from the programmer's prompt using the print 
"PKG",206,22,1,"PAH",1,1,194,0)
device that you prefer.
"PKG",206,22,1,"PAH",1,1,195,0)
 
"PKG",206,22,1,"PAH",1,1,196,0)
     >D RPT^PSOCIDC9
"PKG",206,22,1,"PAH",1,1,197,0)
      DEVICE: HOME//     UCX/TELNET     RIGHT MARGIN:80//
"PKG",206,22,1,"PAH",1,1,198,0)
 
"PKG",206,22,1,"PAH",1,1,199,0)
    Patch PSO*7*239 - Corrected Activity and Copay Activity logs
"PKG",206,22,1,"PAH",1,1,200,0)
 
"PKG",206,22,1,"PAH",1,1,201,0)
     Note that this report reflects all prescriptions where the activity
"PKG",206,22,1,"PAH",1,1,202,0)
     and/or copay activity logs were corrected. For detailed information,
"PKG",206,22,1,"PAH",1,1,203,0)
     please view the activity and copay activity log on the prescription.
"PKG",206,22,1,"PAH",1,1,204,0)
 
"PKG",206,22,1,"PAH",1,1,205,0)
     Date printed: MAR 6,2006@14:09:25                       Page: 1
"PKG",206,22,1,"PAH",1,1,206,0)
     ===============================================================
"PKG",206,22,1,"PAH",1,1,207,0)
     PATIENT NAME     (SSN)       DIV          RX# 
"PKG",206,22,1,"PAH",1,1,208,0)
     ---------------  -------  --------------  ------------
"PKG",206,22,1,"PAH",1,1,209,0)
     PATIENT,ONE      (B3453)  TROY, NY        200037
"PKG",206,22,1,"PAH",1,1,210,0)
     BPATIENT,TWO     (B0033)  TROY, NY        200049
"PKG",206,22,1,"PAH",1,1,211,0)
     BPATIENT,TWO     (B0033)  TROY, NY        200050
"PKG",206,22,1,"PAH",1,1,212,0)
 
"PKG",206,22,1,"PAH",1,1,213,0)
E.  The following is an example of a status query for the Clean-up 
"PKG",206,22,1,"PAH",1,1,214,0)
routine, and it must be run from programmer's mode:
"PKG",206,22,1,"PAH",1,1,215,0)
 
"PKG",206,22,1,"PAH",1,1,216,0)
     >D STATUS^PSOCIDC7
"PKG",206,22,1,"PAH",1,1,217,0)
    
"PKG",206,22,1,"PAH",1,1,218,0)
      Currently processing:
"PKG",206,22,1,"PAH",1,1,219,0)
            Date being processed > Nov 3, 2005
"PKG",206,22,1,"PAH",1,1,220,0)
                            RX # > 1375666
"PKG",206,22,1,"PAH",1,1,221,0)
 
"PKG",206,22,1,"PAH",1,1,222,0)
F.  A stop function has been provided in case the system needs to be
"PKG",206,22,1,"PAH",1,1,223,0)
shut down for an emergency or other reason.  Then when the system is back
"PKG",206,22,1,"PAH",1,1,224,0)
up and you are ready you may restart the job, it will resume where it
"PKG",206,22,1,"PAH",1,1,225,0)
left off.  You may restart by entering D ^PSOCIDC7 at the programmer's
"PKG",206,22,1,"PAH",1,1,226,0)
prompt.  The following is an example:
"PKG",206,22,1,"PAH",1,1,227,0)
 
"PKG",206,22,1,"PAH",1,1,228,0)
     >D STOP^PSOCIDC7
"PKG",206,22,1,"PAH",1,1,229,0)
 
"PKG",206,22,1,"PAH",1,1,230,0)
      Outpatient Activity Logs Correction Job - set to STOP Soon
"PKG",206,22,1,"PAH",1,1,231,0)
 
"PKG",206,22,1,"PAH",1,1,232,0)
      Check Status to be sure it has stopped and is not running...
"PKG",206,22,1,"PAH",1,1,233,0)
        
"PKG",206,22,1,"PAH",1,1,234,0)
                   (D STATUS^PSOCIDC7)
"PKG",206,22,1,"PAH",1,1,235,0)
 
"PKG",206,22,1,"PAH",1,1,236,0)
G.  The Clean-up routine can be executed from the programmer's 
"PKG",206,22,1,"PAH",1,1,237,0)
prompt instead of through the patch installation.  Also, restarting the
"PKG",206,22,1,"PAH",1,1,238,0)
Clean-up routine after using the stop function described above is 
"PKG",206,22,1,"PAH",1,1,239,0)
performed in the same manner.  Below is an example how to perform this 
"PKG",206,22,1,"PAH",1,1,240,0)
function:
"PKG",206,22,1,"PAH",1,1,241,0)
 
"PKG",206,22,1,"PAH",1,1,242,0)
     >D ^PSOCIDC7
"PKG",206,22,1,"PAH",1,1,243,0)
 
"PKG",206,22,1,"PAH",1,1,244,0)
     ****************** SELECT RUN OPTION ******************
"PKG",206,22,1,"PAH",1,1,245,0)
     Do you want to run the activity logs correction process? Y or N// YES
"PKG",206,22,1,"PAH",1,1,246,0)
     Enter when to Queue the CIDC ACTIVITY LOGS CORRECTION job to run in 
"PKG",206,22,1,"PAH",1,1,247,0)
     date@time format:  NOW//
"PKG",206,22,1,"PAH",1,1,248,0)
 
"PKG",206,22,1,"PAH",1,1,249,0)
     ===================================================
"PKG",206,22,1,"PAH",1,1,250,0)
     Queuing background job for CIDC ACTIVITY LOGS CORRECTION...
"PKG",206,22,1,"PAH",1,1,251,0)
     Start time: Month day, year@time
"PKG",206,22,1,"PAH",1,1,252,0)
     ===================================================
"PKG",206,22,1,"PAH",1,1,253,0)
     *** Task #NNNNN Queued! ***
"PKG",206,22,1,"PAH",1,1,254,0)
 
"PKG",206,22,1,"PAH",1,1,255,0)
 
"PKG",206,22,1,"PAH",1,1,256,0)
2. The following correlates to the items described in number two in the
"PKG",206,22,1,"PAH",1,1,257,0)
Functional Description section:
"PKG",206,22,1,"PAH",1,1,258,0)
 
"PKG",206,22,1,"PAH",1,1,259,0)
A. The renew process has been modified to store the changed value
"PKG",206,22,1,"PAH",1,1,260,0)
for SC in the PRESCRIPTION file (#52).
"PKG",206,22,1,"PAH",1,1,261,0)
 
"PKG",206,22,1,"PAH",1,1,262,0)
B. This patch will remove all of the functionality that stored the
"PKG",206,22,1,"PAH",1,1,263,0)
unnecessary IBQ node.
"PKG",206,22,1,"PAH",1,1,264,0)
 
"PKG",206,22,1,"PAH",1,1,265,0)
C.  Outpatient was modified to store the SC value for patients with a null
"PKG",206,22,1,"PAH",1,1,266,0)
SC percentage which eliminates the sending of a "PRESCRIPTION QUESTIONS
"PKG",206,22,1,"PAH",1,1,267,0)
REVIEW NEEDED" Mailman message.
"PKG",206,22,1,"PAH",1,1,268,0)
 
"PKG",206,22,1,"PAH",1,1,269,0)
D.  The check for the PSOSCMX variable was restored to the PSOCP
"PKG",206,22,1,"PAH",1,1,270,0)
routine.  
"PKG",206,22,1,"PAH",1,1,271,0)
 
"PKG",206,22,1,"PAH",1,1,272,0)
E.  This patch adds the functionality to send both ZSC and ZCL segments to
"PKG",206,22,1,"PAH",1,1,273,0)
CPRS. The ZSC passes SC/EI's only.  The ZCL node passes SC, EI's, and
"PKG",206,22,1,"PAH",1,1,274,0)
ICD-9 Diagnosis codes.
"PKG",206,22,1,"PAH",1,1,275,0)
 
"PKG",206,22,1,"PAH",1,1,276,0)
F.  This patch will correctly store the third and fourth piece of the zero
"PKG",206,22,1,"PAH",1,1,277,0)
node of the ICD DIAGNOSIS multiple (#52311) of PRESCRIPTION file (#52).
"PKG",206,22,1,"PAH",1,1,278,0)
 
"PKG",206,22,1,"PAH",1,1,279,0)
G.  The PSOHLNE3 API IA (#4666) was changed to only store entries in the 
"PKG",206,22,1,"PAH",1,1,280,0)
ACTIVITY LOG multiple (#40) when SC, EI's, and/or ICD's were edited.  
"PKG",206,22,1,"PAH",1,1,281,0)
For supply items and investigational drugs, no copay activity log entries 
"PKG",206,22,1,"PAH",1,1,282,0)
will be stored.  Also, it was modified to prevent storage of a copay
"PKG",206,22,1,"PAH",1,1,283,0)
activity log entry (copay to no copay) that was set erroneously when the
"PKG",206,22,1,"PAH",1,1,284,0)
provider edits SC/EI's during sign of a verbal/telephone order leaving the
"PKG",206,22,1,"PAH",1,1,285,0)
prescription as no copay.
"PKG",206,22,1,"PAH",1,1,286,0)
 
"PKG",206,22,1,"PAH",1,1,287,0)
H.  The RESET COPAY STATUS/CANCEL CHARGES [PSOCP RESET COPAY STATUS] 
"PKG",206,22,1,"PAH",1,1,288,0)
option has been modified to not overlay the previously stored 
"PKG",206,22,1,"PAH",1,1,289,0)
ICD-9 Diagnosis code with a null value and to display previously entered
"PKG",206,22,1,"PAH",1,1,290,0)
SC values as a default answer.
"PKG",206,22,1,"PAH",1,1,291,0)
 
"PKG",206,22,1,"PAH",1,1,292,0)
I.  The B cross reference will be set for the ICD DIAGNOSIS field (#311)
"PKG",206,22,1,"PAH",1,1,293,0)
in PENDING OUTPATIENT ORDERS file (#52.41) and in the ICD DIAGNOSIS field
"PKG",206,22,1,"PAH",1,1,294,0)
(#52311) in PRESCRIPTION file (#52) for CPRS renewals/verbal/telephone 
"PKG",206,22,1,"PAH",1,1,295,0)
orders.
"QUES","POS1",0)
YA^^
"QUES","POS1","?")
Enter Y for Yes to run the activity logs correction or N to just install the patch.
"QUES","POS1","A")
Do you want to Run the activity log correction process? Y or N//
"QUES","POS2",0)
D^::%DT
"QUES","POS2","?")
Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 030106@3:30p.
"QUES","POS2","A")
Enter when to Queue the Job to run in date@time format
"QUES","POS2","B")
NOW
"QUES","POS2","M")
I XPDQUES("POS1")=0 K DIR
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
21
"RTN","PSOCIDC7")
0^2^B43535396^n/a
"RTN","PSOCIDC7",1,0)
PSOCIDC7 ;BIR/LE-CIDC Activity logs correction ;2/28/05 12:50pm
"RTN","PSOCIDC7",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**239**;DEC 1997
"RTN","PSOCIDC7",3,0)
 ;
"RTN","PSOCIDC7",4,0)
 N NAMSP,DTOUT,DUOUT,ZTSK,ZTRTN,ZTIO,ZTDTH,ZTDESC,QUIT,RUNOPT,JOBN,Y
"RTN","PSOCIDC7",5,0)
 S NAMSP=$$NAMSP
"RTN","PSOCIDC7",6,0)
 S JOBN="CIDC ACTIVITY LOGS CORRECTION"
"RTN","PSOCIDC7",7,0)
 ;
"RTN","PSOCIDC7",8,0)
 L +^XTMP(NAMSP):0 I '$T D  Q
"RTN","PSOCIDC7",9,0)
 . D BMES^XPDUTL(JOBN_" job is already running.  Halting...")
"RTN","PSOCIDC7",10,0)
 . D MES^XPDUTL("")
"RTN","PSOCIDC7",11,0)
 . D QUIT
"RTN","PSOCIDC7",12,0)
 ;
"RTN","PSOCIDC7",13,0)
 I '$D(^XTMP(NAMSP)) D INITXTMP(NAMSP,"Correct CIDC created activity logs, PSO*7*239",90)        ;90 day life
"RTN","PSOCIDC7",14,0)
 S QUIT=0
"RTN","PSOCIDC7",15,0)
 ;
"RTN","PSOCIDC7",16,0)
 ;ques 1, if running from mumps prompt
"RTN","PSOCIDC7",17,0)
 I '$D(XPDQUES("POS1")) D  I QUIT D QUIT Q
"RTN","PSOCIDC7",18,0)
 . ;selected cancel run at last install, dont allow to run manually
"RTN","PSOCIDC7",19,0)
 . I $G(^XTMP(NAMSP,0,"LAST"))["CANCEL" D  Q
"RTN","PSOCIDC7",20,0)
 . . S QUIT=1
"RTN","PSOCIDC7",21,0)
 . . W !!,*7,"The last install of this patch you selected to NOT Run the Activity Logs Correction process."
"RTN","PSOCIDC7",22,0)
 . . W !,"If you have changed your mind, you must re-install the patch to run",!!
"RTN","PSOCIDC7",23,0)
 . K DIR
"RTN","PSOCIDC7",24,0)
 . S DIR("A",1)="****************** SELECT RUN OPTION ******************"
"RTN","PSOCIDC7",25,0)
 . S DIR("A")="Do you want to run the activity logs correction process? Y or N// "
"RTN","PSOCIDC7",26,0)
 . S DIR(0)="YA^^"
"RTN","PSOCIDC7",27,0)
 . D ^DIR I $D(DTOUT)!($D(DUOUT)) W !,"Halting..." S QUIT=1 Q
"RTN","PSOCIDC7",28,0)
 . S RUNOPT=Y
"RTN","PSOCIDC7",29,0)
 . S:'RUNOPT QUIT=1
"RTN","PSOCIDC7",30,0)
 ;
"RTN","PSOCIDC7",31,0)
 ;ques 1, if running from kids install
"RTN","PSOCIDC7",32,0)
 I $D(XPDQUES("POS1")) D  I 'RUNOPT D QUIT Q
"RTN","PSOCIDC7",33,0)
 . S RUNOPT=XPDQUES("POS1")
"RTN","PSOCIDC7",34,0)
 . S:'RUNOPT ^XTMP(NAMSP,0,"LAST")="CANCEL RUN^"_$$NOW^XLFDT_"^^^"
"RTN","PSOCIDC7",35,0)
 . D BMES^XPDUTL("***** SELECTED "_$S('RUNOPT:"NOT ",1:"")_"TO RUN THE ACTIVITY LOGS CORRECTION PROCESS *****")
"RTN","PSOCIDC7",36,0)
 ;
"RTN","PSOCIDC7",37,0)
 I $G(^XTMP(NAMSP,0,"LAST"))["COMPLETED" D  Q
"RTN","PSOCIDC7",38,0)
 . W !!,*7,"This job has been run before to completion on "
"RTN","PSOCIDC7",39,0)
 . W $$FMTE^XLFDT($P($G(^XTMP(NAMSP,0,"LAST")),"^",2)),!!
"RTN","PSOCIDC7",40,0)
 . D QUIT
"RTN","PSOCIDC7",41,0)
 ;
"RTN","PSOCIDC7",42,0)
 ;ques 2, if running from mumps prompt
"RTN","PSOCIDC7",43,0)
 I '$D(XPDQUES("POS2")) D  I 'ZTDTH D QUIT Q
"RTN","PSOCIDC7",44,0)
 . K DIR
"RTN","PSOCIDC7",45,0)
 . S DIR("A")="  Enter when to Queue the "_JOBN_" job to run in date@time   format "
"RTN","PSOCIDC7",46,0)
 . S DIR("B")="NOW"
"RTN","PSOCIDC7",47,0)
 . S DIR(0)="D^::%DT"
"RTN","PSOCIDC7",48,0)
 . S DIR("?")="Enter when to start the job. The default is Now. You can enter a date and time in the format like this: 021506@3:30p"
"RTN","PSOCIDC7",49,0)
 . D ^DIR I $D(DUOUT) W !,"Halting..." S ZTDTH="" Q
"RTN","PSOCIDC7",50,0)
 . S:$D(DTOUT) Y=$$NOW^XLFDT S ZTDTH=$$FMTH^XLFDT(Y)
"RTN","PSOCIDC7",51,0)
 ;
"RTN","PSOCIDC7",52,0)
 ;ques 2, if running from kids install
"RTN","PSOCIDC7",53,0)
 I $D(XPDQUES("POS2")) S ZTDTH=$$FMTH^XLFDT(XPDQUES("POS2"))
"RTN","PSOCIDC7",54,0)
 ;
"RTN","PSOCIDC7",55,0)
 D BMES^XPDUTL("===================================================")
"RTN","PSOCIDC7",56,0)
 D MES^XPDUTL("Queuing background job for "_JOBN_"...")
"RTN","PSOCIDC7",57,0)
 D MES^XPDUTL("Start time: "_$$HTE^XLFDT(ZTDTH))
"RTN","PSOCIDC7",58,0)
 D MES^XPDUTL("===================================================")
"RTN","PSOCIDC7",59,0)
 I ZTDTH="" D BMES^XPDUTL(JOBN_" NOT QUEUED") D QUIT Q
"RTN","PSOCIDC7",60,0)
 ;
"RTN","PSOCIDC7",61,0)
 S:$D(^XTMP(NAMSP,0,"LAST")) ^XTMP(NAMSP,0,"ZAUDIT",$H)="RE-STARTED ON"_"^"_$$NOW^XLFDT_"^"_$P(^XTMP(NAMSP,0,"LAST"),"^",2,5)
"RTN","PSOCIDC7",62,0)
 ;
"RTN","PSOCIDC7",63,0)
 I $P($G(^XTMP(NAMSP,0,"LAST")),"^")="STOP" D
"RTN","PSOCIDC7",64,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="RUN^"_$$NOW^XLFDT
"RTN","PSOCIDC7",65,0)
 E  D
"RTN","PSOCIDC7",66,0)
 . S ^XTMP(NAMSP,0,"LAST")="RUN^"_$$NOW^XLFDT_"^^^"
"RTN","PSOCIDC7",67,0)
 ;
"RTN","PSOCIDC7",68,0)
 S ZTRTN="EN^PSOCIDC7",ZTIO=""
"RTN","PSOCIDC7",69,0)
 S ZTDESC="Background job for "_JOBN_" on prescriptions updated via PSO*7*239"
"RTN","PSOCIDC7",70,0)
 S ZTSAVE("JOBN")=""
"RTN","PSOCIDC7",71,0)
 L -^XTMP(NAMSP)
"RTN","PSOCIDC7",72,0)
 D ^%ZTLOAD
"RTN","PSOCIDC7",73,0)
 D:$D(ZTSK)
"RTN","PSOCIDC7",74,0)
 . D MES^XPDUTL("*** Task #"_ZTSK_" Queued! ***")
"RTN","PSOCIDC7",75,0)
 . D BMES^XPDUTL("")
"RTN","PSOCIDC7",76,0)
 D BMES^XPDUTL("")
"RTN","PSOCIDC7",77,0)
 K XPDQUES
"RTN","PSOCIDC7",78,0)
 Q
"RTN","PSOCIDC7",79,0)
QUIT ;
"RTN","PSOCIDC7",80,0)
 L -^XTMP(NAMSP)
"RTN","PSOCIDC7",81,0)
 Q
"RTN","PSOCIDC7",82,0)
EN ;
"RTN","PSOCIDC7",83,0)
 N NAMSP S NAMSP=$$NAMSP
"RTN","PSOCIDC7",84,0)
 ;if can't get Lock, then already running.
"RTN","PSOCIDC7",85,0)
 L +^XTMP(NAMSP):3 I '$T D  Q
"RTN","PSOCIDC7",86,0)
 . S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCIDC7",87,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="LOCKED^"_$$NOW^XLFDT
"RTN","PSOCIDC7",88,0)
 ;
"RTN","PSOCIDC7",89,0)
 N DFN,PSODT,RXP,PSOTEXT,XX,YY,PSOCNT,PSOUCNT,PSOCCNT,PSOSTART,PSOEND,PSOVETS,PSOCVETS,PSOUVETS,PSOTRX,XIEN
"RTN","PSOCIDC7",90,0)
 N PSOSCMX,PSODFN,PSOUDFN,PSOREL,PSOAMT,PSOCAMT,PSOUAMT,FOUND,PSOTRF,PSOEND2,PSOSTRT2,CC
"RTN","PSOCIDC7",91,0)
 N PSOTIME,PSOSTNM,PSOS1,PSOINST,I,PSOTC,PSOCNTS,PSOUCNTS,PSOCCNTS,LIN,%,X1,XMY,STO,PSOSCP
"RTN","PSOCIDC7",92,0)
 D NOW^%DTC S (Y,PSOS1)=% D DD^%DT S PSOSTART=Y
"RTN","PSOCIDC7",93,0)
 S PSOSTRT2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCIDC7",94,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOCIDC7",95,0)
 S PSODT=+$P($G(^XTMP(NAMSP,0,"LAST")),"^",3)
"RTN","PSOCIDC7",96,0)
 S RXP=+$P($G(^XTMP(NAMSP,0,"LAST")),"^",4)
"RTN","PSOCIDC7",97,0)
 ;
"RTN","PSOCIDC7",98,0)
 ;get 1st occurence of install date of patch PSO*7*143 (CIDC)
"RTN","PSOCIDC7",99,0)
 S XIEN=+$O(^XPD(9.7,"B","PSO*7.0*143",0))
"RTN","PSOCIDC7",100,0)
 S:'PSODT PSODT=+$P($G(^XPD(9.7,XIEN,1)),"^",3)
"RTN","PSOCIDC7",101,0)
 I 'PSODT D  Q
"RTN","PSOCIDC7",102,0)
 . S ^XTMP(NAMSP,0,.1)="CIDC PATCH PSO*7*143 IS NOT INSTALLED"
"RTN","PSOCIDC7",103,0)
 . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="COMPLETED^"_$$NOW^XLFDT
"RTN","PSOCIDC7",104,0)
 . D MAIL3^PSOCIDC8(^XTMP(NAMSP,0,.1))
"RTN","PSOCIDC7",105,0)
 ;
"RTN","PSOCIDC7",106,0)
 S (PSOTRX,PSOTRF)=1
"RTN","PSOCIDC7",107,0)
 N STOP K ^XTMP(NAMSP,0,"STOP") S STOP=0          ;init stop flag to 0
"RTN","PSOCIDC7",108,0)
 F CC=1:1 S PSODT=$O(^PSRX("AD",PSODT)) Q:'PSODT  D  Q:STOP  ;FINISH DATE
"RTN","PSOCIDC7",109,0)
 . I $D(^XTMP(NAMSP,0,"STOP")) D  Q
"RTN","PSOCIDC7",110,0)
 . . S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="STOP^"_$$NOW^XLFDT,STOP=1
"RTN","PSOCIDC7",111,0)
 . F PSOTRX=PSOTRX+1:1 S RXP=$O(^PSRX("AD",PSODT,RXP)) Q:'RXP  D  Q:STOP
"RTN","PSOCIDC7",112,0)
 .. I $D(^XTMP(NAMSP,0,"STOP")) D  Q
"RTN","PSOCIDC7",113,0)
 ... S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="STOP^"_$$NOW^XLFDT,STOP=1
"RTN","PSOCIDC7",114,0)
 ..; S RXP=392 D  Q:RXP=392  ;FOR TESTING INDIVIDUAL
"RTN","PSOCIDC7",115,0)
 .. Q:'$D(^PSRX(RXP,"ICD",0))
"RTN","PSOCIDC7",116,0)
 .. ;save last date & fill info
"RTN","PSOCIDC7",117,0)
 .. S $P(^XTMP(NAMSP,0,"LAST"),"^",3,5)=PSODT_"^"_RXP_"^"_PSOTRX
"RTN","PSOCIDC7",118,0)
 .. S (DFN,PSODFN)=$P($G(^PSRX(RXP,0)),"^",2)
"RTN","PSOCIDC7",119,0)
 .. S PSONAM=$P($G(^DPT(PSODFN,0)),"^"),PSONAM=$P(PSONAM,",")
"RTN","PSOCIDC7",120,0)
 .. Q:('PSODFN)!('$D(^DPT(PSODFN,0)))        ;quit, no valid DFN info 
"RTN","PSOCIDC7",121,0)
 .. D:$D(^PSRX(RXP,"A",0))!($D(^PSRX(RXP,"COPAY",0))) CHECK^PSOCIDC8
"RTN","PSOCIDC7",122,0)
 G STP:STOP
"RTN","PSOCIDC7",123,0)
 ;
"RTN","PSOCIDC7",124,0)
 S (PSOUCNT,PSOCNT,PSOCCNT)=0
"RTN","PSOCIDC7",125,0)
 S $P(^XTMP(NAMSP,0,"LAST"),"^",1,2)="COMPLETED^"_$$NOW^XLFDT
"RTN","PSOCIDC7",126,0)
 D MAIL^PSOCIDC8
"RTN","PSOCIDC7",127,0)
STP ;
"RTN","PSOCIDC7",128,0)
 L -^XTMP(NAMSP)
"RTN","PSOCIDC7",129,0)
 I $D(^XTMP(NAMSP,0,"STOP")) S ^XTMP(NAMSP,0,"ZAUDIT",$H)="STOPPED ON"_"^"_$P(^XTMP(NAMSP,0,"LAST"),"^",2,5)
"RTN","PSOCIDC7",130,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCIDC7",131,0)
 K JOBN
"RTN","PSOCIDC7",132,0)
 Q
"RTN","PSOCIDC7",133,0)
 ;
"RTN","PSOCIDC7",134,0)
 ;
"RTN","PSOCIDC7",135,0)
STATUS ;show status of job running
"RTN","PSOCIDC7",136,0)
 I $$ST D
"RTN","PSOCIDC7",137,0)
 . W !,"Currently processing:"
"RTN","PSOCIDC7",138,0)
 . I $G(^XTMP($$NAMSP,0,"LAST"))["COMPLETED" D
"RTN","PSOCIDC7",139,0)
 . . W !,"COMPLETED ON ",$$FMTE^XLFDT($P($G(^XTMP($$NAMSP,0,"LAST")),"^",2)),!
"RTN","PSOCIDC7",140,0)
 . W !?5,"Date being processed > ",$$FMTE^XLFDT($P(^XTMP($$NAMSP,0,"LAST"),"^",3))
"RTN","PSOCIDC7",141,0)
 . W !?5,"                RX # > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",4)
"RTN","PSOCIDC7",142,0)
 . ;W !?5,"          TOTAL RX's > ",$P(^XTMP($$NAMSP,0,"LAST"),"^",5),!
"RTN","PSOCIDC7",143,0)
 E  D
"RTN","PSOCIDC7",144,0)
 .I $G(^XTMP($$NAMSP,0,"LAST"))["COMPLETED" D
"RTN","PSOCIDC7",145,0)
 .. W !,"COMPLETED ON ",$$FMTE^XLFDT($P($G(^XTMP($$NAMSP,0,"LAST")),"^",2)),!
"RTN","PSOCIDC7",146,0)
 Q
"RTN","PSOCIDC7",147,0)
 ;
"RTN","PSOCIDC7",148,0)
STOP ;stop job command
"RTN","PSOCIDC7",149,0)
 I $$ST S ^XTMP($$NAMSP,0,"STOP")="" D
"RTN","PSOCIDC7",150,0)
 . W !,"Outpatient Activity Logs Correction Job - set to STOP Soon"
"RTN","PSOCIDC7",151,0)
 . W !!,"Check Status to be sure it has stopped and is not running..."
"RTN","PSOCIDC7",152,0)
 . W !,"     (D STATUS^PSOCIDC7)"
"RTN","PSOCIDC7",153,0)
 Q
"RTN","PSOCIDC7",154,0)
ST() ;status
"RTN","PSOCIDC7",155,0)
 L +^XTMP($$NAMSP):3 I $T D  Q 0
"RTN","PSOCIDC7",156,0)
 . L -^XTMP($$NAMSP)
"RTN","PSOCIDC7",157,0)
 . W !,"*** NOT CURRENTLY RUNNING! ***",!
"RTN","PSOCIDC7",158,0)
 Q 1
"RTN","PSOCIDC7",159,0)
INITXTMP(NAMSP,TITLE,LIFE) ;create ^Xtmp according to SAC std
"RTN","PSOCIDC7",160,0)
 N BEGDT,PURGDT
"RTN","PSOCIDC7",161,0)
 S BEGDT=$$NOW^XLFDT()
"RTN","PSOCIDC7",162,0)
 S PURGDT=$$FMADD^XLFDT(BEGDT,LIFE)
"RTN","PSOCIDC7",163,0)
 S ^XTMP(NAMSP,0)=PURGDT_"^"_BEGDT_"^"_TITLE
"RTN","PSOCIDC7",164,0)
 Q
"RTN","PSOCIDC7",165,0)
NAMSP() ;
"RTN","PSOCIDC7",166,0)
 Q $T(+0)
"RTN","PSOCIDC8")
0^4^B28837769^n/a
"RTN","PSOCIDC8",1,0)
PSOCIDC8 ;BIR/LE - continuation of activity log corrections ;2/28/05 12:50pm
"RTN","PSOCIDC8",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**239**;DEC 1997
"RTN","PSOCIDC8",3,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSOCIDC8",4,0)
 ;External reference to $$PROD^XUPROD(1) supported by DBIA 4440
"RTN","PSOCIDC8",5,0)
 ;External references L and UL^PSSLOCK supported by DBIA 2789
"RTN","PSOCIDC8",6,0)
 ;
"RTN","PSOCIDC8",7,0)
CHECK ;
"RTN","PSOCIDC8",8,0)
 N PSOMSG,PSOSTOP D PSOL^PSSLOCK(RXP) I '$G(PSOMSG) D  Q:$G(PSOSTOP)  D CHECK
"RTN","PSOCIDC8",9,0)
 . I $D(^XTMP(NAMSP,0,"STOP")) S PSOSTOP=1,$P(^XTMP(NAMSP,0,"LAST"),"^",3)=$O(^PSRX("AD",PSODT),-1),$P(^XTMP(NAMSP,0,"LAST"),"^",4)=$O(^PSRX(RXP),-1)
"RTN","PSOCIDC8",10,0)
 ;
"RTN","PSOCIDC8",11,0)
 I $D(^XTMP(NAMSP,0,"STOP")) S $P(^XTMP(NAMSP,0,"LAST"),"^",3)=$O(^PSRX("AD",PSODT),-1),$P(^XTMP(NAMSP,0,"LAST"),"^",4)=$O(^PSRX(RXP),-1) Q
"RTN","PSOCIDC8",12,0)
 N AFLG,CFLG,CDAT,CHSEQ,ADATA,CDATA,DATA,ENTRY,EDAT,EFILL,ESEQ,MDATA,NEXT,SEQ
"RTN","PSOCIDC8",13,0)
 ;
"RTN","PSOCIDC8",14,0)
 I $D(^PSRX(RXP,"A",0)) D
"RTN","PSOCIDC8",15,0)
 . S SEQ=0 F  S SEQ=$O(^PSRX(RXP,"A",SEQ)) Q:SEQ=""  I $G(^PSRX(RXP,"A",SEQ,0))["BKGD CIDC" D  Q:AFLG
"RTN","PSOCIDC8",16,0)
 .. M ^XTMP(NAMSP,"A",PSODFN,RXP,"A")=^PSRX(RXP,"A") S AFLG=1
"RTN","PSOCIDC8",17,0)
 .. I $D(^PSRX(RXP,"COPAY")) M ^XTMP(NAMSP,"C",PSODFN,RXP,"COPAY")=^PSRX(RXP,"COPAY")
"RTN","PSOCIDC8",18,0)
 .. E  S ^XTMP(NAMSP,"C",PSODFN,RXP)="No previous copay activity log in file 52"
"RTN","PSOCIDC8",19,0)
 D:$G(AFLG) ACTLOG
"RTN","PSOCIDC8",20,0)
 ;
"RTN","PSOCIDC8",21,0)
 K CDATA S CFLG=0
"RTN","PSOCIDC8",22,0)
 I $D(^PSRX(RXP,"COPAY",0)) D
"RTN","PSOCIDC8",23,0)
 . S CSEQ=0 F  S CSEQ=$O(^PSRX(RXP,"COPAY",CSEQ)) Q:CSEQ=""  I $G(^PSRX(RXP,"COPAY",CSEQ,0))["BKGD CIDC" D  Q:CFLG
"RTN","PSOCIDC8",24,0)
 .. I '$D(^XTMP(NAMSP,"C",PSODFN,RXP))&(^PSRX(RXP,"COPAY",CSEQ,0)'["CIDC CLEANUP") M ^XTMP(NAMSP,"C",PSODFN,RXP,"COPAY")=^PSRX(RXP,"COPAY")
"RTN","PSOCIDC8",25,0)
 .. S CFLG=1
"RTN","PSOCIDC8",26,0)
 D:$G(CFLG)!$G(AFLG) CPLOG
"RTN","PSOCIDC8",27,0)
 D PSOUL^PSSLOCK(RXP)
"RTN","PSOCIDC8",28,0)
 Q
"RTN","PSOCIDC8",29,0)
 ;
"RTN","PSOCIDC8",30,0)
ACTLOG ;ACTIVITY LOG
"RTN","PSOCIDC8",31,0)
 S (CHSEQ,SEQ)=0
"RTN","PSOCIDC8",32,0)
 F  S SEQ=$O(^PSRX(RXP,"A",SEQ)) Q:SEQ=""  S ENTRY=$G(^PSRX(RXP,"A",SEQ,0)) I ENTRY'="" D
"RTN","PSOCIDC8",33,0)
 . I ENTRY'["BKGD CIDC" S CHSEQ=CHSEQ+1,CDATA(CHSEQ)=ENTRY Q
"RTN","PSOCIDC8",34,0)
 . S MDATA($P(ENTRY,"^"),$P(ENTRY,"^",4),SEQ)=""
"RTN","PSOCIDC8",35,0)
 ;
"RTN","PSOCIDC8",36,0)
 ;Q:'$D(CDATA)&('$D(MDATA))
"RTN","PSOCIDC8",37,0)
 ;
"RTN","PSOCIDC8",38,0)
 ;***************************** FOR LIVE RUN
"RTN","PSOCIDC8",39,0)
 I $D(CDATA)!($D(MDATA)) D
"RTN","PSOCIDC8",40,0)
 .I $D(^PSRX(RXP,"A")) K ^PSRX(RXP,"A")
"RTN","PSOCIDC8",41,0)
 .Q:'$D(CDATA)
"RTN","PSOCIDC8",42,0)
 .S (CHSEQ,SEQ)=0 F  S SEQ=$O(CDATA(SEQ)) Q:SEQ=""  S ^PSRX(RXP,"A",SEQ,0)=CDATA(SEQ),CHSEQ=SEQ
"RTN","PSOCIDC8",43,0)
 .S ^PSRX(RXP,"A",0)="^52.3DA^"_CHSEQ_"^"_CHSEQ
"RTN","PSOCIDC8",44,0)
 .S ^XTMP(NAMSP,"LOG",PSONAM,PSODFN,RXP)=""
"RTN","PSOCIDC8",45,0)
 ;*****************************
"RTN","PSOCIDC8",46,0)
 ;***---------------------------------------->>>>>>>>>>  UN-COMMENT NEXT 3 LINES FOR TESTING ONLY AND COMMENT LIVE RUN
"RTN","PSOCIDC8",47,0)
 ;S (CHSEQ,SEQ)=0 F  S SEQ=$O(CDATA(SEQ)) Q:SEQ=""  S ^XTMP("TST "_NAMSP,RXP,"A",SEQ,0)=CDATA(SEQ),CHSEQ=SEQ
"RTN","PSOCIDC8",48,0)
 ;S ^XTMP("TST "_NAMSP,RXP,"A",0)="^52.3DA^"_CHSEQ_"^"_CHSEQ
"RTN","PSOCIDC8",49,0)
 ;S ^XTMP("TST "_NAMSP,"LOG",PSONAM,PSODFN,RXP)=""
"RTN","PSOCIDC8",50,0)
 ;
"RTN","PSOCIDC8",51,0)
 Q
"RTN","PSOCIDC8",52,0)
 ;
"RTN","PSOCIDC8",53,0)
CPLOG ;COPAY ACTIVITY LOG
"RTN","PSOCIDC8",54,0)
 S (EDAT,EFILL,ESEQ)="",(CHSEQ,CSEQ2)=0,ACNT=99999
"RTN","PSOCIDC8",55,0)
 I '$D(^PSRX(RXP,"COPAY"))&($D(MDATA)) D  G SKP2
"RTN","PSOCIDC8",56,0)
 . F  S EDAT=$O(MDATA(EDAT)) Q:EDAT=""  F  S EFILL=$O(MDATA(EDAT,EFILL)) Q:EFILL=""  F  S ESEQ=$O(MDATA(EDAT,EFILL,ESEQ)) Q:ESEQ=""  D
"RTN","PSOCIDC8",57,0)
 .. S CHSEQ=CHSEQ+1,CDATA(CHSEQ)=EDAT_"^R^.5^"_EFILL_"^CIDC CLEANUP"
"RTN","PSOCIDC8",58,0)
 ;
"RTN","PSOCIDC8",59,0)
 F  S CSEQ2=$O(^PSRX(RXP,"COPAY",CSEQ2)) Q:CSEQ2=""  D
"RTN","PSOCIDC8",60,0)
 . S DATA=^PSRX(RXP,"COPAY",CSEQ2,0),CDAT=$P(DATA,"^")
"RTN","PSOCIDC8",61,0)
 . I DATA["-BKGD CIDC" S $P(DATA,"^",5)="CIDC CLEANUP"
"RTN","PSOCIDC8",62,0)
SKP .;
"RTN","PSOCIDC8",63,0)
 . I '$G(EDAT)&($D(MDATA)) S (EDAT,EFILL,ESEQ)="",EDAT=$O(MDATA(EDAT)),EFILL=$O(MDATA(EDAT,EFILL)),ESEQ=$O(MDATA(EDAT,EFILL,ESEQ))
"RTN","PSOCIDC8",64,0)
 . I EDAT<CDAT&(EDAT'="") S CHSEQ=CHSEQ+1,CDATA(CHSEQ)=EDAT_"^R^.5^"_EFILL_"^CIDC CLEANUP" K MDATA(EDAT,EFILL,ESEQ) S EDAT="" G SKP
"RTN","PSOCIDC8",65,0)
 . S CHSEQ=CHSEQ+1,CDATA(CHSEQ)=^PSRX(RXP,"COPAY",CSEQ2,0)
"RTN","PSOCIDC8",66,0)
 . I CDATA(CHSEQ)["BKGD CIDC" S $P(CDATA(CHSEQ),"^",5)="CIDC CLEANUP"
"RTN","PSOCIDC8",67,0)
 ;
"RTN","PSOCIDC8",68,0)
 I $D(MDATA) S (EDAT,EFILL,ESEQ)=""  F  S EDAT=$O(MDATA(EDAT)) Q:EDAT=""  F  S EFILL=$O(MDATA(EDAT,EFILL)) Q:EFILL=""  F  S ESEQ=$O(MDATA(EDAT,EFILL,ESEQ)) Q:ESEQ=""  D
"RTN","PSOCIDC8",69,0)
 . S CHSEQ=CHSEQ+1,CDATA(CHSEQ)=EDAT_"^R^.5^"_EFILL_"^CIDC CLEANUP"
"RTN","PSOCIDC8",70,0)
SKP2 ;
"RTN","PSOCIDC8",71,0)
 Q:'$D(CDATA)
"RTN","PSOCIDC8",72,0)
 ;
"RTN","PSOCIDC8",73,0)
 ;***************************** FOR LIVE RUN
"RTN","PSOCIDC8",74,0)
 I $D(^PSRX(RXP,"COPAY")) K ^PSRX(RXP,"COPAY")
"RTN","PSOCIDC8",75,0)
 S (CSEQ2,CHSEQ)=0 F  S CSEQ2=$O(CDATA(CSEQ2)) Q:CSEQ2=""  S ^PSRX(RXP,"COPAY",CSEQ2,0)=CDATA(CSEQ2),CHSEQ=CSEQ2
"RTN","PSOCIDC8",76,0)
 S ^PSRX(RXP,"COPAY",0)="^52.0107DA^"_CHSEQ_"^"_CHSEQ
"RTN","PSOCIDC8",77,0)
 S ^XTMP(NAMSP,"LOG",PSONAM,PSODFN,RXP)=""
"RTN","PSOCIDC8",78,0)
 ;*****************************
"RTN","PSOCIDC8",79,0)
 ;***---------------------------------------->>>>>>>>>>> UN-COMMENT NEXT 3 LINES FOR TESTING ONLY AND COMMENT LIVE RUN
"RTN","PSOCIDC8",80,0)
 ;S (CSEQ2,CHSEQ)=0 F  S CSEQ2=$O(CDATA(CSEQ2)) Q:CSEQ2=""  S ^XTMP("TST "_NAMSP,RXP,"COPAY",CSEQ2,0)=CDATA(CSEQ2),CHSEQ=CSEQ2
"RTN","PSOCIDC8",81,0)
 ;S ^XTMP("TST "_NAMSP,RXP,"COPAY",0)="^52.0107DA^"_CHSEQ_"^"_CHSEQ
"RTN","PSOCIDC8",82,0)
 ;S ^XTMP("TST "_NAMSP,"LOG",PSONAM,PSODFN,RXP)=""
"RTN","PSOCIDC8",83,0)
 ;
"RTN","PSOCIDC8",84,0)
 Q
"RTN","PSOCIDC8",85,0)
 ;
"RTN","PSOCIDC8",86,0)
SITE ; SET UP VARIABLES NEEDED BY BILLING
"RTN","PSOCIDC8",87,0)
 S PSOSITE=$S(YY=0:$P(^PSRX(RXP,2),"^",9),1:$P($G(^PSRX(RXP,1,YY,0)),"^",9))
"RTN","PSOCIDC8",88,0)
 Q:PSOSITE=""
"RTN","PSOCIDC8",89,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1))
"RTN","PSOCIDC8",90,0)
 S PSOPAR7=$G(^PS(59,PSOSITE,"IB"))
"RTN","PSOCIDC8",91,0)
 S PSOSITE7=$P($G(^PS(59,PSOSITE,"IB")),"^")
"RTN","PSOCIDC8",92,0)
 Q
"RTN","PSOCIDC8",93,0)
 ;
"RTN","PSOCIDC8",94,0)
MAIL3(MSG) ;management mail message
"RTN","PSOCIDC8",95,0)
 S PSOINST=$P($G(^DIC(4,+$P($G(^XMB(1,1,"XUS")),"^",17),99)),"^")
"RTN","PSOCIDC8",96,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCIDC8",97,0)
 K PSOTEXT
"RTN","PSOCIDC8",98,0)
 S:$G(DUZ) XMY(DUZ)=""
"RTN","PSOCIDC8",99,0)
 ;S XMY("ELLZEY.LINDA@FORUM.VA.GOV")=""
"RTN","PSOCIDC8",100,0)
 S:$$PROD^XUPROD(1) XMY("ELLZEY.LINDA@FORUM.VA.GOV")=""
"RTN","PSOCIDC8",101,0)
 S XMDUZ="PSO*7*239 "_JOBN
"RTN","PSOCIDC8",102,0)
 S XMSUB="STATION "_$G(PSOINST)
"RTN","PSOCIDC8",103,0)
 S XMSUB=XMSUB_$S($$PROD^XUPROD(1):" (Prod)",1:" (Test)")
"RTN","PSOCIDC8",104,0)
 S XMSUB=XMSUB_" Activity log and Copay Activity log correction "
"RTN","PSOCIDC8",105,0)
 S PSOTEXT(1)=""
"RTN","PSOCIDC8",106,0)
 S PSOTEXT(2)="Started "_PSOSTART
"RTN","PSOCIDC8",107,0)
 S PSOTEXT(3)=""
"RTN","PSOCIDC8",108,0)
 S PSOTEXT(4)="   "_MSG
"RTN","PSOCIDC8",109,0)
 S PSOTEXT(5)=""
"RTN","PSOCIDC8",110,0)
 S PSOTEXT(6)="NO FURTHER ACTION REQUIRED."
"RTN","PSOCIDC8",111,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCIDC8",112,0)
 Q
"RTN","PSOCIDC8",113,0)
 ;
"RTN","PSOCIDC8",114,0)
MAIL ;
"RTN","PSOCIDC8",115,0)
 D NOW^%DTC S Y=% D DD^%DT S PSOEND=Y
"RTN","PSOCIDC8",116,0)
 S PSOEND2=$$FMTE^XLFDT(%,"1PS")
"RTN","PSOCIDC8",117,0)
 I $G(DUZ) S XMY(DUZ)=""
"RTN","PSOCIDC8",118,0)
 S XMDUZ="PSO*7*239 "_JOBN
"RTN","PSOCIDC8",119,0)
 S XMSUB="Outpatient Pharmacy PSO*7*239 "_JOBN
"RTN","PSOCIDC8",120,0)
 ;S XMY("ELLZEY.LINDA@FORUM.VA.GOV")=""
"RTN","PSOCIDC8",121,0)
 F PSOCXPDA=0:0 S PSOCXPDA=$O(^XUSEC("PSO COPAY",PSOCXPDA)) Q:'PSOCXPDA  S XMY(PSOCXPDA)=""
"RTN","PSOCIDC8",122,0)
 I $O(XMY(""))="" Q  ; no recipients for mail message
"RTN","PSOCIDC8",123,0)
 S PSOTEXT(1)="The "_JOBN_" job for the Outpatient Pharmacy"
"RTN","PSOCIDC8",124,0)
 S PSOTEXT(2)="patch (PSO*7*239) started "_PSOSTART
"RTN","PSOCIDC8",125,0)
 S PSOTEXT(3)="and completed "_PSOEND_"."
"RTN","PSOCIDC8",126,0)
 S PSOTEXT(4)=" "
"RTN","PSOCIDC8",127,0)
 ;
"RTN","PSOCIDC8",128,0)
 S XMTEXT="PSOTEXT(" N DIFROM D ^XMD K XMDUZ,XMTEXT,XMSUB
"RTN","PSOCIDC8",129,0)
 Q
"RTN","PSOCIDC9")
0^3^B14993294^n/a
"RTN","PSOCIDC9",1,0)
PSOCIDC9 ;BIR/LE - continuation of activity log corrections ;2/28/05 12:50pm
"RTN","PSOCIDC9",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**239**;DEC 1997
"RTN","PSOCIDC9",3,0)
 ;
"RTN","PSOCIDC9",4,0)
RPT ;
"RTN","PSOCIDC9",5,0)
 N JOBN,NAMSP,ZTDESC,ZTRTN
"RTN","PSOCIDC9",6,0)
 S NAMSP=$$NAMSP^PSOCIDC7
"RTN","PSOCIDC9",7,0)
 S JOBN="CIDC ACTIVITY LOG CORRECTION"
"RTN","PSOCIDC9",8,0)
 L +^XTMP(NAMSP):0 I '$T D  Q
"RTN","PSOCIDC9",9,0)
 .W !,JOBN_" job for PSO*7*239 is still running.  Halting..."
"RTN","PSOCIDC9",10,0)
 L -^XTMP(NAMSP)
"RTN","PSOCIDC9",11,0)
 W !!,"This report reflects all prescriptions where the activity and"
"RTN","PSOCIDC9",12,0)
 W !,"copay activity logs were corrected.  For detailed information,"
"RTN","PSOCIDC9",13,0)
 W !,"please view the activity and copay logs on the prescriptions."
"RTN","PSOCIDC9",14,0)
 ;
"RTN","PSOCIDC9",15,0)
 W !!,"You may queue the report to print, if you wish.",!
"RTN","PSOCIDC9",16,0)
 ;
"RTN","PSOCIDC9",17,0)
DVC K %ZIS,POP,IOP S %ZIS="QM" D ^%ZIS I $G(POP) W !!,"Nothing queued to print.",! G DONE
"RTN","PSOCIDC9",18,0)
QUEUE I $D(IO("Q")) S ZTRTN="START^PSOCIDC7",ZTDESC=JOBN_" CIDC Activity Logs Corrections" D ^%ZTLOAD K %ZSI W !,"Report queued to print.",! G DONE
"RTN","PSOCIDC9",19,0)
START ;
"RTN","PSOCIDC9",20,0)
 U IO
"RTN","PSOCIDC9",21,0)
 N BLDT,RXO,NAMSP,PSOFILL,PSODFN,PSONAM,PSOOUT,PSODV,RXP,SSN,PSODIV,PSODV
"RTN","PSOCIDC9",22,0)
 N CANCEL,JOBN,PSOPATID,PSOTOT,PSOTOTC
"RTN","PSOCIDC9",23,0)
 S NAMSP=$$NAMSP^PSOCIDC7
"RTN","PSOCIDC9",24,0)
 ;****************************************************** for testing only - next line
"RTN","PSOCIDC9",25,0)
 S JOBN="CIDC ACTIVITY LOGS CORRECTION"
"RTN","PSOCIDC9",26,0)
 S PSOOUT=0,PSODV=$S($E(IOST)="C":"C",1:"P")
"RTN","PSOCIDC9",27,0)
 S PSOPGCT=0,PSOPGLN=IOSL-7,PSOPGCT=1
"RTN","PSOCIDC9",28,0)
 S BLDT=$P($G(^XTMP(NAMSP,0,"LAST")),"^",2)
"RTN","PSOCIDC9",29,0)
 I '$D(DT) S DT=$$NOW^XLFDT
"RTN","PSOCIDC9",30,0)
 D TITLE
"RTN","PSOCIDC9",31,0)
 S (PSOTOT,PSOTOTC,PSONAM)=""
"RTN","PSOCIDC9",32,0)
 F  S PSONAM=$O(^XTMP(NAMSP,"LOG",PSONAM)) Q:PSONAM=""  D
"RTN","PSOCIDC9",33,0)
 .S PSODFN=""
"RTN","PSOCIDC9",34,0)
 .F  S PSODFN=$O(^XTMP(NAMSP,"LOG",PSONAM,PSODFN)) Q:PSODFN=""  D
"RTN","PSOCIDC9",35,0)
 ..S RXP=""
"RTN","PSOCIDC9",36,0)
 ..F  S RXP=$O(^XTMP(NAMSP,"LOG",PSONAM,PSODFN,RXP)) Q:RXP=""  D
"RTN","PSOCIDC9",37,0)
 ...D FULL Q:$G(PSOOUT)  S PSONAME=$P($G(^DPT(PSODFN,0)),"^")
"RTN","PSOCIDC9",38,0)
 ...S CONLY="" I '$D(^XTMP(NAMSP,RXP,"A"))&($D(^XTMP(NAMSP,RXP,"COPAY"))) S CONLY=1
"RTN","PSOCIDC9",39,0)
 ...I CONLY S PSOTOTC=PSOTOTC+1
"RTN","PSOCIDC9",40,0)
 ...W !,$E(PSONAME,1,14)
"RTN","PSOCIDC9",41,0)
 ...D PRTSSN
"RTN","PSOCIDC9",42,0)
 ...S RXO=$P($G(^PSRX(RXP,0)),"^")
"RTN","PSOCIDC9",43,0)
 ...W ?41," ",RXO  ;," (",PSOFILL,")"
"RTN","PSOCIDC9",44,0)
 W:PSOTOT'="" !,"Total number of prescriptions modified: ",PSOTOT
"RTN","PSOCIDC9",45,0)
 G END
"RTN","PSOCIDC9",46,0)
 ;
"RTN","PSOCIDC9",47,0)
FULL ;
"RTN","PSOCIDC9",48,0)
 I ($Y+7)>IOSL&('$G(PSOOUT)) D TITLE
"RTN","PSOCIDC9",49,0)
 Q
"RTN","PSOCIDC9",50,0)
 ;
"RTN","PSOCIDC9",51,0)
TITLE ;
"RTN","PSOCIDC9",52,0)
 I $G(PSODV)="C",$G(PSOPGCT)'=1 W ! K DIR S DIR(0)="E" D ^DIR K DIR I 'Y S PSOOUT=1 Q
"RTN","PSOCIDC9",53,0)
 ;
"RTN","PSOCIDC9",54,0)
 W @IOF D
"RTN","PSOCIDC9",55,0)
 . W !,"Patch PSO*7*239 - Corrected Activity and Copay Activity logs",!!
"RTN","PSOCIDC9",56,0)
 . W "Note that this report reflects all prescriptions where the activity and/or",!
"RTN","PSOCIDC9",57,0)
 . W "copay activity logs were corrected. For detailed information, please view",!
"RTN","PSOCIDC9",58,0)
 . W "the activity and copay activity log on the prescription.",!
"RTN","PSOCIDC9",59,0)
 ;
"RTN","PSOCIDC9",60,0)
 S Y=DT X ^DD("DD") W !,"Date printed: ",Y,?70,"Page: ",PSOPGCT,!
"RTN","PSOCIDC9",61,0)
 F MJT=1:1:79 W "="
"RTN","PSOCIDC9",62,0)
 ;W !?55,"Updated",?67,"Updated"
"RTN","PSOCIDC9",63,0)
 ;W !,?55,"Activity",?67,"COPAY"
"RTN","PSOCIDC9",64,0)
 W !,"PATIENT NAME     (SSN)       DIV",?42,"RX# " ;,?55,"Log",?67,"Activity Log"   ;,?55,"RELEASE DATE",?69,"REL   BILL"
"RTN","PSOCIDC9",65,0)
 W !,"---------------  -------  --------------",?42,"------------"
"RTN","PSOCIDC9",66,0)
 ;W ?55,"------------",?67,"-----------"
"RTN","PSOCIDC9",67,0)
 S PSOPGCT=PSOPGCT+1
"RTN","PSOCIDC9",68,0)
 Q
"RTN","PSOCIDC9",69,0)
 ;
"RTN","PSOCIDC9",70,0)
END ;
"RTN","PSOCIDC9",71,0)
 I '$G(PSOOUT),$G(PSODV)="C" W !!,"** End of Report **" K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOCIDC9",72,0)
 I $G(PSODV)="C" W !
"RTN","PSOCIDC9",73,0)
 E  W @IOF
"RTN","PSOCIDC9",74,0)
DONE ;
"RTN","PSOCIDC9",75,0)
 K MJT,PSOPGCT,PSOPGLN,Y,DIR,X,IOP,POP,IO("Q"),DIRUT,DUOUT,DTOUT
"RTN","PSOCIDC9",76,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSOCIDC9",77,0)
 Q
"RTN","PSOCIDC9",78,0)
 ;
"RTN","PSOCIDC9",79,0)
PRTSSN ;
"RTN","PSOCIDC9",80,0)
 S SSN=$P(^DPT(PSODFN,0),"^",9),SSN=$E(SSN,$L(SSN)-3,$L(SSN))
"RTN","PSOCIDC9",81,0)
 S PSOPATID=$E(PSONAM,1)_SSN
"RTN","PSOCIDC9",82,0)
 S PSODIV=$P($G(^PSRX(RXP,2)),"^",9)
"RTN","PSOCIDC9",83,0)
 S:PSODIV'="" PSODIV=$P($G(^PS(59,PSODIV,0)),"^",1)
"RTN","PSOCIDC9",84,0)
 W ?17,"("_PSOPATID_")"_"  "_$E(PSODIV,1,15)
"RTN","PSOCIDC9",85,0)
 Q
"RTN","PSOCIDC9",86,0)
 ;
"RTN","PSOCP")
0^12^B68323456^B75128860
"RTN","PSOCP",1,0)
PSOCP ;BIR/BAB - Pharmacy CO-PAY Application Utilities for IB ;02/06/92
"RTN","PSOCP",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,46,71,85,137,157,143,219,239**;DEC 1997
"RTN","PSOCP",3,0)
 ;
"RTN","PSOCP",4,0)
 ;REF/IA
"RTN","PSOCP",5,0)
 ;IBARX/125
"RTN","PSOCP",6,0)
 ;SDCO22/1579
"RTN","PSOCP",7,0)
 ;PS(55/2228
"RTN","PSOCP",8,0)
 ;PSDRUG(/221
"RTN","PSOCP",9,0)
 ;VADPT/10061
"RTN","PSOCP",10,0)
 ;DGMSTAPI/2716
"RTN","PSOCP",11,0)
CP ;Check if COPAY-Requires RXP,PSOSITE7
"RTN","PSOCP",12,0)
 I '$D(PSOPAR) D ^PSOLSET G CP
"RTN","PSOCP",13,0)
 K PSOCP
"RTN","PSOCP",14,0)
 S PSOCPN=$P(^PSRX(RXP,0),"^",2) ; Set COPAY dfn PTR TO PATIENT
"RTN","PSOCP",15,0)
 S PSOCP=$P($G(^PSRX(RXP,"IB")),"^") ; IB action type
"RTN","PSOCP",16,0)
 S PSOSAVE=$S(PSOCP:1,1:"") ; save current copay status
"RTN","PSOCP",17,0)
 ;   Set x=service^dfn^actiontype^user duz
"RTN","PSOCP",18,0)
 I +$G(PSOSITE7)'>0 S PSOSITE7=$P(^PS(59,PSOSITE,"IB"),"^")
"RTN","PSOCP",19,0)
 S X=PSOSITE7_"^"_PSOCPN_"^"_PSOCP_"^"_$P(^PSRX(RXP,0),"^",16)
"RTN","PSOCP",20,0)
 ;
"RTN","PSOCP",21,0)
RX ;Determine Orig or Refill for RX
"RTN","PSOCP",22,0)
 N PSOIB
"RTN","PSOCP",23,0)
 S PSOIB=0
"RTN","PSOCP",24,0)
 S PSOREF=0
"RTN","PSOCP",25,0)
 I $G(^PSRX(RXP,1,+$G(YY),0))]"" S PSOREF=YY
"RTN","PSOCP",26,0)
 ; Check if bill # already exists for this RX or Refill
"RTN","PSOCP",27,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",2)>0 D CHKIB^PSOCP1 I PSOIB G QUIT
"RTN","PSOCP",28,0)
 I 'PSOREF,+$P($G(^PSRX(RXP,"IB")),"^",4)>0 G QUIT ; 'POTENTIAL BILL' - ALREADY ATTEMPTED TO BILL, BUT EXCEEDED ANNUAL COPAY CAP
"RTN","PSOCP",29,0)
 I PSOREF,+$G(^PSRX(RXP,1,PSOREF,"IB")) D CHKIB^PSOCP1 I PSOIB G QUIT
"RTN","PSOCP",30,0)
 I PSOREF,+$P($G(^PSRX(RXP,1,PSOREF,"IB")),"^",2) G QUIT ; POTENTIAL BILL
"RTN","PSOCP",31,0)
 S PSOCHG=1 ; set tem variable to copay and then look for exceptions
"RTN","PSOCP",32,0)
 N MAILMSG
"RTN","PSOCP",33,0)
 D COPAYREL
"RTN","PSOCP",34,0)
 I 'PSOCHG D  G QUIT
"RTN","PSOCP",35,0)
 . I PSOSAVE S PSODA=RXP,PREA="R" D ACTLOG^PSOCPA S $P(^PSRX(RXP,"IB"),"^",1)=""
"RTN","PSOCP",36,0)
 I PSOCHG=2 D  I 'PSOCP G QUIT ; IF 'SC' QUESTION APPLIES, BUT HAS NOT BEEN ANSWERED, SEND MAIL MSG AND KEEP COPAY STATUS AS IT WAS
"RTN","PSOCP",37,0)
 . D MAIL2^PSOCPE ; SEND MAIL TO PHARMACIST, PROVIDER, AND HOLDERS OF THE PSO COPAY KEY
"RTN","PSOCP",38,0)
 I PSOCHG=1,PSOSAVE="" D  I PSOREF S PSOCOMM="",PSOOLD="No Copay",PSONW="Copay" S PSODA=RXP,PREA="R" D ACTLOG^PSOCPA
"RTN","PSOCP",39,0)
 . I '$D(^PSRX(RXP,"IB")),'PSOREF S $P(^PSRX(RXP,"IB"),"^",1)=1 Q
"RTN","PSOCP",40,0)
 . S $P(^PSRX(RXP,"IB"),"^",1)=1
"RTN","PSOCP",41,0)
 . S PSOCP=1,$P(X,"^",3)=PSOCP
"RTN","PSOCP",42,0)
 I PSOCHG'=2 I $G(MAILMSG) D MAIL2^PSOCPE ; SEND MAIL TO PHARMACIST, PROVIDER, AND HOLDERS OF PSO COPAY KEY
"RTN","PSOCP",43,0)
 ;         Units for COPAY
"RTN","PSOCP",44,0)
 S PSOCPUN=$P(($P(^PSRX(RXP,0),"^",8)+29)/30,".",1)
"RTN","PSOCP",45,0)
 ;         Build softlink for x(n)=softlink^units
"RTN","PSOCP",46,0)
 S X(1)="52:"_RXP S:PSOREF>0 X(1)=X(1)_";1:"_PSOREF S X(1)=X(1)_"^"_PSOCPUN
"RTN","PSOCP",47,0)
 ;   Set correct user duz if refill
"RTN","PSOCP",48,0)
 I PSOREF S:+$P(^PSRX(RXP,1,PSOREF,0),"^",7)>0 $P(X,"^",4)=$P(^PSRX(RXP,1,PSOREF,0),"^",7)
"RTN","PSOCP",49,0)
 ;
"RTN","PSOCP",50,0)
IBNEW ;  Load ^TMP global for IB call
"RTN","PSOCP",51,0)
 Q:$G(RXP)'>0
"RTN","PSOCP",52,0)
 N D0
"RTN","PSOCP",53,0)
 G QUIT:'$D(X)
"RTN","PSOCP",54,0)
 S XTMP=X,XTMP(1)=X(1)
"RTN","PSOCP",55,0)
 ;
"RTN","PSOCP",56,0)
 ;   Requires x=service^dfn^action type^user duz
"RTN","PSOCP",57,0)
 ;        x(n)=softlink^units 
"RTN","PSOCP",58,0)
 I $P(X,"^",3)="" S $P(X,"^",3)=$P(^PSRX(RXP,"IB"),"^",1)
"RTN","PSOCP",59,0)
 D NEW^IBARX
"RTN","PSOCP",60,0)
 ;         Returns y=1^total charges for this group or Y=-1^error code
"RTN","PSOCP",61,0)
 ;              y(n)=IB number^charge for this Rx^AR bill #^Cap met^Partial or Full charge^Copay Exempt^Number from file 354.71
"RTN","PSOCP",62,0)
 ;                   Cap met ('1' - If patient has met cap amount or 
"RTN","PSOCP",63,0)
 ;                     reached cap with this charge or '0' if not)
"RTN","PSOCP",64,0)
 ;                   Partial or Full ('P' for partial billing, 'F' for
"RTN","PSOCP",65,0)
 ;                     full billing, null for no billing)
"RTN","PSOCP",66,0)
 ;                   Copay Exempt - ('1' for exempt, '0' for non-exempt,
"RTN","PSOCP",67,0)
 ;                     '-1' for copay off (manila))
"RTN","PSOCP",68,0)
 ;                   ('1' - If patient has met cap amount or reach cap with this charge
"RTN","PSOCP",69,0)
 ;                  Entry from file 354.71 will only be saved for fills that met the annual cap and could not be fully billed
"RTN","PSOCP",70,0)
 ;
"RTN","PSOCP",71,0)
 G QUIT:+Y=-1
"RTN","PSOCP",72,0)
 S XTMP=XTMP_"^"_Y,XTMP(1)=XTMP(1)_"^"_Y(1)
"RTN","PSOCP",73,0)
 ;
"RTN","PSOCP",74,0)
 ; see if exempt or copay cap was met for this fill
"RTN","PSOCP",75,0)
 I $P(Y(1),"^",6) D  G QUIT
"RTN","PSOCP",76,0)
 . S PREA="R",PSOOLD="Copay",PSONW="No Copay"
"RTN","PSOCP",77,0)
 . S PSOCOMM="RX COPAY INCOME EXEMPTION" S PSODA=RXP D ACTLOG^PSOCPA
"RTN","PSOCP",78,0)
 . S $P(^PSRX(RXP,"IB"),"^",1)=""
"RTN","PSOCP",79,0)
 I $P(Y(1),"^",4) D
"RTN","PSOCP",80,0)
 . S PSOCOMM=$S($P(Y(1),"^",5)="F":" FULL BILLING FOR THIS FILL",$P(Y(1),"^",5)="P":" PARTIAL BILLING FOR THIS FILL ",1:" NO BILLING FOR THIS FILL")
"RTN","PSOCP",81,0)
 . S PREA="A"
"RTN","PSOCP",82,0)
 . S PSODA=RXP D ACTLOG^PSOCPA
"RTN","PSOCP",83,0)
 . I $P(Y(1),"^",5)'="F" D
"RTN","PSOCP",84,0)
 . . I PSOREF S $P(^PSRX(RXP,1,PSOREF,"IB"),"^",2)=$P(Y(1),"^",7) Q
"RTN","PSOCP",85,0)
 . . S $P(^PSRX(RXP,"IB"),"^",4)=$P(Y(1),"^",7)
"RTN","PSOCP",86,0)
 I $P(Y(1),"^",1)="" G QUIT
"RTN","PSOCP",87,0)
 ;
"RTN","PSOCP",88,0)
FILE ;         File IB number in ^PSRX
"RTN","PSOCP",89,0)
 S PSOCP2=0
"RTN","PSOCP",90,0)
 S PSOCP2=+$P(XTMP(1),":",3)
"RTN","PSOCP",91,0)
 S:PSOCP2>0 ^PSRX(RXP,1,PSOCP2,"IB")=$P(XTMP(1),U,3) ;  Filing in refill node
"RTN","PSOCP",92,0)
 I PSOCP2>0,'$D(^PSRX(RXP,"IB")) S ^PSRX(RXP,"IB")="1^^" ;  If refill "IB" exists, need "IB" entry on original fill node
"RTN","PSOCP",93,0)
 S:PSOCP2=0 $P(^PSRX(RXP,"IB"),"^",2)=$P(XTMP(1),U,3) ;Filing in original fill (zero node)
"RTN","PSOCP",94,0)
QUIT ;
"RTN","PSOCP",95,0)
 K Y,PSOCP1,PSOCP2,QQ,PSOCPN,X,X2,XTMP,PSOCPUN,PSOREF,PSOCHG,PSOSAVE,PSOCOMM,PSOOLD,PSONW,PREA,PSORSN
"RTN","PSOCP",96,0)
 Q
"RTN","PSOCP",97,0)
EN D ^PSOLSET
"RTN","PSOCP",98,0)
EN1 S DIR(0)="NO",DIR("A")="Enter PRESCRIPTION number" D ^DIR K DIR G:$D(DIRUT) EXIT S RXP=X I +$G(^PSRX(RXP,0))'>0!+$P($G(^PSRX(RXP,"IB")),"^",0)>0 W !,?10,"RE-CHECK PRESCRIPTION NUMBER AND RE-ENTER " G EN1
"RTN","PSOCP",99,0)
 S PSOSITE7=$P(^PS(59,PSOSITE,"IB"),"^")
"RTN","PSOCP",100,0)
 S PSODFN=$P(^PSRX(RXP,0),"^",2)
"RTN","PSOCP",101,0)
 D CP G EN1
"RTN","PSOCP",102,0)
EXIT K RXP D FINAL^PSOLSET Q
"RTN","PSOCP",103,0)
 ;
"RTN","PSOCP",104,0)
SC(PSODFN,PSODD) ;supported reference for CPRS, Pre-Copay enhancement
"RTN","PSOCP",105,0)
 N PSOSC
"RTN","PSOCP",106,0)
 I $$DT^PSOMLLDT S PSOSC="" G SCQ
"RTN","PSOCP",107,0)
 I $G(PSODD),($P($G(^PSDRUG(PSODD,0)),"^",3)["S")!($P($G(^(0)),"^",3)["I") S PSOSC=1 G SCQ
"RTN","PSOCP",108,0)
 I $P($G(^PS(55,+$G(PSODFN),"PS")),"^"),$P($G(^PS(53,+$P(^("PS"),"^"),0)),"^",7) S PSOSC=1 G SCQ
"RTN","PSOCP",109,0)
 N I,J,X S (X,PSOSC)=""
"RTN","PSOCP",110,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCP",111,0)
 G:'X SCQ
"RTN","PSOCP",112,0)
 S X=X_"^"_PSODFN D XTYPE^IBARX
"RTN","PSOCP",113,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSC=I
"RTN","PSOCP",114,0)
SCQ Q $S($G(PSOSC)=2:0,1:1)
"RTN","PSOCP",115,0)
 ;
"RTN","PSOCP",116,0)
COPAYREL ; Recheck copay status at release
"RTN","PSOCP",117,0)
 ;
"RTN","PSOCP",118,0)
 ; check Rx patient status
"RTN","PSOCP",119,0)
 I $P(^PSRX(RXP,0),"^",3)'="",$P($G(^PS(53,$P(^PSRX(RXP,0),"^",3),0)),"^",7)=1 S PSOCHG=0,PSOCOMM="Rx Patient Status Change",PSOOLD="Copay",PSONW="No Copay" Q
"RTN","PSOCP",120,0)
 ; see if drug is investigational or supply
"RTN","PSOCP",121,0)
 N DRG,DRGTYP,X
"RTN","PSOCP",122,0)
 S DRG=+$P(^PSRX(RXP,0),"^",6),DRGTYP=$P($G(^PSDRUG(DRG,0)),"^",3)
"RTN","PSOCP",123,0)
 I DRGTYP["I" S PSOCOMM="Investigational Drug",PSOCHG=0,PSOOLD="Copay",PSONW="No Copay",PSOCHG=0
"RTN","PSOCP",124,0)
 I DRGTYP["S" S PSOCOMM="Supply Item",PSOCHG=0,PSOOLD="Copay",PSONW="No Copay",PSOCHG=0
"RTN","PSOCP",125,0)
 K PSOTG,CHKXTYPE
"RTN","PSOCP",126,0)
 I +$G(^PSRX(RXP,"IBQ")) D XTYPE1^PSOCP1
"RTN","PSOCP",127,0)
 I $G(^PSRX(RXP,"IBQ"))["1" D  S PSOCHG=0,PSOOLD="Copay",PSONW="No Copay" Q  ; COPAY EXEMPT
"RTN","PSOCP",128,0)
 . N EXMT,II,PSOCIBQ
"RTN","PSOCP",129,0)
 . S PSOCIBQ=$G(^PSRX(RXP,"IBQ"))
"RTN","PSOCP",130,0)
 . F II=1,7,3,4,5,6,2 I $P(PSOCIBQ,"^",II)=1 S EXMT=$S(II=1:"SC",II=7:"CV",II=3:"AO",II=4:"IR",II=5:"EC",II=2:"MST",II=6:"HNC",1:"") D:EXMT'="" SETCOMM Q
"RTN","PSOCP",131,0)
 D SCNEW(.PSOTG,PSOCPN,DRG,RXP)
"RTN","PSOCP",132,0)
 N EXMT
"RTN","PSOCP",133,0)
 I '$D(CHKXTYPE) D XTYPE
"RTN","PSOCP",134,0)
 F EXMT="SC","CV","AO","IR","EC","MST","HNC" I $D(PSOTG(EXMT)) D  I 'PSOCHG Q
"RTN","PSOCP",135,0)
 . I PSOTG(EXMT)=1 S PSOCHG=0 D SETCOMM
"RTN","PSOCP",136,0)
 I 'PSOCHG S PSOOLD="Copay",PSONW="No Copay" Q
"RTN","PSOCP",137,0)
 ;
"RTN","PSOCP",138,0)
 ; If any of the applicable exemption questions have never been answered, generate a mail message with all of the questions
"RTN","PSOCP",139,0)
 S EXMT="",MAILMSG=0 F  S EXMT=$O(PSOTG(EXMT)) Q:EXMT=""  I PSOTG(EXMT)="" S MAILMSG=1 Q
"RTN","PSOCP",140,0)
 I MAILMSG,$D(PSOTG("SC")) I $G(PSOTG("SC"))="" S PSOCHG=2 ; 'SC' question not answered, don't reset copay status to 'copay'
"RTN","PSOCP",141,0)
 Q
"RTN","PSOCP",142,0)
 ;
"RTN","PSOCP",143,0)
SCNEW(PSOTG,PSOPT,PSODR,PSORN) ;CPRS supported reference
"RTN","PSOCP",144,0)
 I '$$DT^PSOMLLDT Q
"RTN","PSOCP",145,0)
 I '$G(PSOPT) Q
"RTN","PSOCP",146,0)
 ;I $G(PSODR),($P($G(^PSDRUG(PSODR,0)),"^",3)["S")!($P($G(^(0)),"^",3)["I") Q ;CIDC ALWAYS ASK
"RTN","PSOCP",147,0)
 N PSOCIBQ,PSOQMSH,PSOQVEH,PSOQRQD,PSOQHNC,PSOQPGW,DFN,PSOSCA,ZXX
"RTN","PSOCP",148,0)
 K PSOANSQ("SC>50")
"RTN","PSOCP",149,0)
 S DFN=PSOPT
"RTN","PSOCP",150,0)
 D SCP^PSORN52D S:PSOSCP>49&(PSOSCA) PSOANSQ("SC>50")=1
"RTN","PSOCP",151,0)
 I $G(PSORN) D
"RTN","PSOCP",152,0)
 . S PSOCIBQ=$G(^PSRX(PSORN,"IBQ"))
"RTN","PSOCP",153,0)
 . I $TR(PSOCIBQ,"^")="" S ZXX=$G(^PSRX(PSORN,"ICD",1,0)) D ICD:ZXX'=""
"RTN","PSOCP",154,0)
 I '$G(PSORN) S PSOCIBQ=""
"RTN","PSOCP",155,0)
 ;Rx Patient Status check is not being done here
"RTN","PSOCP",156,0)
 N PSOSCMX,Y,I,J,X S (X,PSOSCMX)=""
"RTN","PSOCP",157,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCP",158,0)
 G:'X SKIP
"RTN","PSOCP",159,0)
 S X=X_"^"_PSOPT D XTYPE^IBARX
"RTN","PSOCP",160,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCP",161,0)
SKIP ;
"RTN","PSOCP",162,0)
 I $G(PSOSCA)!($G(PSOSCMX)=2) S PSOTG("SC")=$S($P(PSOCIBQ,"^")=1:1,$P(PSOCIBQ,"^")=0:0,$G(PSORN)&($P($G(^PSRX(+$G(PSORN),"IB")),"^")):0,1:"")
"RTN","PSOCP",163,0)
 S:$$AO^SDCO22(PSOPT) PSOTG("AO")=$S($P(PSOCIBQ,"^",3)=1:1,$P(PSOCIBQ,"^",3)=0:0,1:"")
"RTN","PSOCP",164,0)
 S:$$IR^SDCO22(PSOPT) PSOTG("IR")=$S($P(PSOCIBQ,"^",4)=1:1,$P(PSOCIBQ,"^",4)=0:0,1:"")
"RTN","PSOCP",165,0)
 S:$$EC^SDCO22(PSOPT) PSOTG("EC")=$S($P(PSOCIBQ,"^",5)=1:1,$P(PSOCIBQ,"^",5)=0:0,1:"")
"RTN","PSOCP",166,0)
 S:$P($$GETSTAT^DGMSTAPI(PSOPT),"^",2)="Y" PSOTG("MST")=$S($P(PSOCIBQ,"^",2)=1:1,$P(PSOCIBQ,"^",2)=0:0,1:"")
"RTN","PSOCP",167,0)
 I $T(GETCUR^DGNTAPI)]"" N PSONC,PSONCX S PSONCX=$$GETCUR^DGNTAPI(PSOPT,"PSONC") I $P($G(PSONC("IND")),"^")="Y" S PSOTG("HNC")=$S($P(PSOCIBQ,"^",6)=1:1,$P(PSOCIBQ,"^",6)=0:0,1:"")
"RTN","PSOCP",168,0)
 S:$P($$CVEDT^DGCV(PSOPT),"^",3) PSOTG("CV")=$S($P(PSOCIBQ,"^",7)=1:1,$P(PSOCIBQ,"^",7)=0:0,1:"")
"RTN","PSOCP",169,0)
 Q
"RTN","PSOCP",170,0)
 ;
"RTN","PSOCP",171,0)
ICD ;
"RTN","PSOCP",172,0)
 D ICD^PSOCP1
"RTN","PSOCP",173,0)
 Q
"RTN","PSOCP",174,0)
XTYPE ;
"RTN","PSOCP",175,0)
 N PSOCIBQ,PSOSCMX,Y,I,J,X,SAVY,ZXX
"RTN","PSOCP",176,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCP",177,0)
 S PSOCIBQ=$G(^PSRX(RXP,"IBQ")) I $TR(PSOCIBQ,"^")="" S ZXX=$G(^PSRX(RXP,"ICD",1,0)) D ICD:ZXX'=""
"RTN","PSOCP",178,0)
 I $P(PSOCIBQ,"^",1)'="" S PSOTG("SC")=$P(PSOCIBQ,"^",1)
"RTN","PSOCP",179,0)
 I $D(PSOTG("SC")),$P(PSOCIBQ,"^",1)="" S PSOTG("SC")="" ; USE "CURRENT" SETTING AS ANSWER TO SERVICE CONNECTED QUESTION IF IT APPLIES
"RTN","PSOCP",180,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCP",181,0)
 I 'X Q
"RTN","PSOCP",182,0)
 S X=X_"^"_PSOCPN D XTYPE^IBARX
"RTN","PSOCP",183,0)
 I $G(Y)'=1 Q
"RTN","PSOCP",184,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCP",185,0)
 I PSOSCMX="",SAVY=0 S PSOCHG=0 S PSOCOMM="Exempt from copayment" Q  ; INCOME EXEMPT OR SERVICE-CONNECTED
"RTN","PSOCP",186,0)
 I PSOSCMX=2,'$D(PSOTG("SC")) S PSOTG("SC")=$S(($G(RXP)&($P($G(^PSRX(+$G(RXP),"IB")),"^")))!($P(PSOCIBQ,"^")=0):0,$P(PSOCIBQ,"^")=1:1,1:"") Q
"RTN","PSOCP",187,0)
 Q
"RTN","PSOCP",188,0)
 ;
"RTN","PSOCP",189,0)
SETCOMM ;
"RTN","PSOCP",190,0)
 D SETCOMM^PSOCP1
"RTN","PSOCP",191,0)
 Q
"RTN","PSOCP",192,0)
 ;
"RTN","PSOCP1")
0^21^B5020940^B2595305
"RTN","PSOCP1",1,0)
PSOCP1 ;BHAM ISC/EJW-PHARMACY CO-PAY APPLICATION UTILITIES FOR IB (CONT'D) ;12/12/02
"RTN","PSOCP1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**137,239**;DEC 1997
"RTN","PSOCP1",3,0)
 ;
"RTN","PSOCP1",4,0)
 ;REF/IA
"RTN","PSOCP1",5,0)
 ;IBARX/125
"RTN","PSOCP1",6,0)
CHKIB ; SEE IF BILL # IS A CHARGE OR CANCELLATION #
"RTN","PSOCP1",7,0)
 N IBN,XX
"RTN","PSOCP1",8,0)
 I PSOREF=0 S XX=$G(^PSRX(RXP,"IB")) I $P(XX,"^",4)'="" S PSOIB=1 Q  ;ALREADY BILLED
"RTN","PSOCP1",9,0)
 I PSOREF=0 S IBN=$P(XX,"^",2)
"RTN","PSOCP1",10,0)
 I PSOREF'=0 S XX=$G(^PSRX(RXP,1,PSOREF,"IB")) I $P(XX,"^",2)'="" S PSOIB=1 Q  ;ALREADY BILLED
"RTN","PSOCP1",11,0)
 I PSOREF'=0 S IBN=$P(XX,"^",1)
"RTN","PSOCP1",12,0)
 I IBN'="" D STATUS
"RTN","PSOCP1",13,0)
 Q
"RTN","PSOCP1",14,0)
 ;
"RTN","PSOCP1",15,0)
STATUS ;
"RTN","PSOCP1",16,0)
 N XX
"RTN","PSOCP1",17,0)
 S XX=$$STATUS^IBARX(IBN)
"RTN","PSOCP1",18,0)
 I XX'=1,XX'=3 Q
"RTN","PSOCP1",19,0)
 S PSOIB=1 ; ALREADY BILLED
"RTN","PSOCP1",20,0)
 Q
"RTN","PSOCP1",21,0)
 ;
"RTN","PSOCP1",22,0)
XTYPE1 ;
"RTN","PSOCP1",23,0)
 N PSOCIBQ,PSOSCMX,Y,I,J,X,SAVY
"RTN","PSOCP1",24,0)
 S (X,PSOSCMX,SAVY)=""
"RTN","PSOCP1",25,0)
 S PSOCIBQ=$G(^PSRX(RXP,"IBQ"))
"RTN","PSOCP1",26,0)
 I $P(PSOCIBQ,"^",1)'=1 Q
"RTN","PSOCP1",27,0)
 S J=0 F  S J=$O(^PS(59,J)) Q:'J  I +$G(^(J,"IB")) S X=+^("IB") Q
"RTN","PSOCP1",28,0)
 I 'X Q
"RTN","PSOCP1",29,0)
 S X=X_"^"_PSOCPN D XTYPE^IBARX
"RTN","PSOCP1",30,0)
 I $G(Y)'=1 Q
"RTN","PSOCP1",31,0)
 S J="" F  S J=$O(Y(J)) Q:'J  S I="" F  S SAVY=I,I=$O(Y(J,I)) Q:I=""  S:I>0 PSOSCMX=I
"RTN","PSOCP1",32,0)
 I PSOSCMX="",SAVY=0 Q  ; INCOME EXEMPT OR SERVICE-CONNECTED
"RTN","PSOCP1",33,0)
 I PSOSCMX=2 Q  ; NEED TO ASK SC QUESTION
"RTN","PSOCP1",34,0)
 ; If get to here, service-connected question does not apply for this patient anymore.  Update "IBQ" and CPRS
"RTN","PSOCP1",35,0)
 S $P(^PSRX(RXP,"IBQ"),"^",1)="",CHKXTYPE=1
"RTN","PSOCP1",36,0)
 D EN^PSOHLSN1(RXP,"XX","","Order edited")
"RTN","PSOCP1",37,0)
 Q
"RTN","PSOCP1",38,0)
 ;
"RTN","PSOCP1",39,0)
SETCOMM ;
"RTN","PSOCP1",40,0)
 I EXMT="SC" S PSOCOMM="Service Connected" Q
"RTN","PSOCP1",41,0)
 I EXMT="CV" S PSOCOMM="COMBAT VETERAN" Q
"RTN","PSOCP1",42,0)
 I EXMT="AO" S PSOCOMM="AGENT ORANGE RELATED" Q
"RTN","PSOCP1",43,0)
 I EXMT="IR" S PSOCOMM="IONIZING RAD RELATED" Q
"RTN","PSOCP1",44,0)
 I EXMT="EC" S PSOCOMM="ENV CONTAMINANTS RELATED" Q
"RTN","PSOCP1",45,0)
 I EXMT="MST" S PSOCOMM="MILITARY SEXUAL TRAUMA" Q
"RTN","PSOCP1",46,0)
 I EXMT="HNC" S PSOCOMM="Head and/or Neck Cancer" Q
"RTN","PSOCP1",47,0)
 Q
"RTN","PSOCP1",48,0)
 ;
"RTN","PSOCP1",49,0)
ICD ;
"RTN","PSOCP1",50,0)
 S PSOCIBQ=$P(ZXX,U,4)_"^"_$P(ZXX,U,6)_"^"_$P(ZXX,U,2)_"^"_$P(ZXX,U,3)_"^"_$P(ZXX,U,5)_"^"_$P(ZXX,U,7)_"^"_$P(ZXX,U,8)
"RTN","PSOCP1",51,0)
 Q
"RTN","PSOCP1",52,0)
 ;
"RTN","PSOCPB")
0^13^B78420405^B82075464
"RTN","PSOCPB",1,0)
PSOCPB ;BIR/BaB - pharmacy co-pay application cont'd ;9/20/96 11:47
"RTN","PSOCPB",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**72,71,85,185,143,219,239**;DEC 1997
"RTN","PSOCPB",3,0)
 ;
"RTN","PSOCPB",4,0)
 ;REF/IA
"RTN","PSOCPB",5,0)
 ;DIS^SDROUT2/112
"RTN","PSOCPB",6,0)
 ;^IBARX/125
"RTN","PSOCPB",7,0)
 ;VADPT/10061
"RTN","PSOCPB",8,0)
COPAY ;
"RTN","PSOCPB",9,0)
 ; Called by PSON52,PSORN52...Requires PSOCPAY,PSOBILL,DEA=PSDEA,PSOFLAG
"RTN","PSOCPB",10,0)
 ;PSOFLAG=1 NEW, PSOFLAG=0 RENEW
"RTN","PSOCPB",11,0)
 S PSOSAVE=PSOCPAY ; Save original status of PSOCPAY
"RTN","PSOCPB",12,0)
 I '$G(PSOSCP)!('$G(PSOSCA)) D SCP^PSORN52D  ;CIDC-must ask sc if flagged for it in enrollment
"RTN","PSOCPB",13,0)
 I $G(PSODRUG("DEA"))["S"!($G(PSODRUG("DEA"))["I") S PSOCPAY=0
"RTN","PSOCPB",14,0)
 G:+PSOBILL'=2&('$G(PSOSCA)) COPAY2
"RTN","PSOCPB",15,0)
 D FULL^VALM1
"RTN","PSOCPB",16,0)
 I $G(PSOMESOI)=1,$G(PSORXED) W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESOI=2
"RTN","PSOCPB",17,0)
 I $G(PSOMESFI)=1 W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESFI=2
"RTN","PSOCPB",18,0)
 S DFN=+$G(PSODFN) D DIS^SDROUT2
"RTN","PSOCPB",19,0)
ASK ;
"RTN","PSOCPB",20,0)
 N PSOUFLAG S PSOUFLAG=0
"RTN","PSOCPB",21,0)
 K PSOCPZ("DFLG"),PSONEW("NEWCOPAY")
"RTN","PSOCPB",22,0)
 W ! K DIR,DTOUT,DIRUT,DUOUT
"RTN","PSOCPB",23,0)
 I $G(PSORX("SC"))="SC"!($G(PSORX("SC"))="NSC")!($G(PSOSCOTH)) D
"RTN","PSOCPB",24,0)
 . W:PSOSCP<50&($G(PSODRUG("DEA"))'["S")&($G(PSODRUG("DEA"))'["I") !,"This Rx has been flagged by the provider as: "_$S($G(PSOSCOTH):"NO COPAY",$G(PSORX("SC"))="SC":"NO COPAY",1:"COPAY"),! I $G(PSOSCOTX) S PSOSCOTX=2
"RTN","PSOCPB",25,0)
 S DIR("A")="Was treatment for Service Connected condition",DIR(0)="Y"
"RTN","PSOCPB",26,0)
 S DIR("?")="Enter 'Yes' if this prescription is for a Service Connected condition"
"RTN","PSOCPB",27,0)
 I $G(PSORX("SC"))]""!($G(PSORX(+$G(PSORENW("OIRXN")),"SC"))'="") S DIR("B")=$S($G(PSORX("SC"))="SC":"YES",$G(PSORX("SC"))="NSC":"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=1:"YES",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=0:"NO",1:"")
"RTN","PSOCPB",28,0)
 I $G(PSONEWFF),$G(PSOFLAG) I $G(PSOANSQD("SC"))=0!($G(PSOANSQD("SC"))=1) S DIR("B")=$S($G(PSOANSQD("SC"))=1:"YES",1:"NO")
"RTN","PSOCPB",29,0)
 I $G(DIR("B"))="YES"!($G(DIR("B"))="NO") S PSOUFLAG=$G(DIR("B"))
"RTN","PSOCPB",30,0)
 I $G(DIR("B"))="" K DIR("B")
"RTN","PSOCPB",31,0)
 D ^DIR
"RTN","PSOCPB",32,0)
 I $G(Y)=1!($G(Y)=0) S PSOANSQ("SC")=$G(Y) I $G(PSONEWFF),$G(PSOFLAG) S PSOANSQD("SC")=$G(Y)
"RTN","PSOCPB",33,0)
 I PSOFLAG I Y["^"!($D(DTOUT))!($D(DUOUT)) S PSOCPZ("DFLG")=1
"RTN","PSOCPB",34,0)
 S:Y=0 Y=2
"RTN","PSOCPB",35,0)
 S PSOANSR=+Y I 'PSOANSR,'PSOFLAG D  S $P(PSOCPAY,"^")=$S($G(PSOUFLAG)="NO":1,1:0) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR G COPAY2
"RTN","PSOCPB",36,0)
 .W !!,"This Renewal has been designated as "_$S($G(PSOUFLAG)="YES":"SERVICE CONNECTED",1:"NON-SERVICE CONNECTED.")
"RTN","PSOCPB",37,0)
 .W:PSOSCP<50&($G(PSODRUG("DEA"))'["S")&($G(PSODRUG("DEA"))'["I") !,"Please use the 'Reset Copay Status/Cancel Charges' option to make corrections."
"RTN","PSOCPB",38,0)
 .S PSOANSQ("SC")=$S($G(PSOUFLAG)="YES":1,1:0)
"RTN","PSOCPB",39,0)
 I $G(PSOFLAG),$G(PSOCPZ("DFLG")) G EXIT
"RTN","PSOCPB",40,0)
 S:PSOANSR=1 PSOCPAY=0 S:PSOANSR=2 $P(PSOCPAY,"^")=1
"RTN","PSOCPB",41,0)
 G COPAY2
"RTN","PSOCPB",42,0)
HELP ;
"RTN","PSOCPB",43,0)
 ;W !!,"You must answer YES or NO to this question to continue."
"RTN","PSOCPB",44,0)
 ;G ASK
"RTN","PSOCPB",45,0)
COPAY2 ;
"RTN","PSOCPB",46,0)
 I +PSOCPAY=1,($P(PSOCPAY,"^",2)=1)!($P(PSOCPAY,"^",2)=2) D
"RTN","PSOCPB",47,0)
 .;set IB node in ^PSRX for copay if xactn type is 1 or 2
"RTN","PSOCPB",48,0)
 .S PSONEW("NEWCOPAY")=$P($G(PSOCPAY),"^",2)_"^^"_$P($G(PSOCPAY),"^",2)
"RTN","PSOCPB",49,0)
EXIT ;
"RTN","PSOCPB",50,0)
 S PSOCPAY=PSOSAVE ; Restore value of PSOCPAY
"RTN","PSOCPB",51,0)
 K PSOSAVE,PSOANSR,DIR,DUOUT,DIRUT,DTOUT,Y,X
"RTN","PSOCPB",52,0)
 Q
"RTN","PSOCPB",53,0)
RESET ; RESET COPAY STATUS
"RTN","PSOCPB",54,0)
 K PSOSUMM
"RTN","PSOCPB",55,0)
 I '$D(PSOPAR) D ^PSOLSET G RESET
"RTN","PSOCPB",56,0)
 W ! S DIC="^PSRX(",DIC(0)="AEQMZ" D ^DIC K DIC G:Y<0 EXT S PSODA=+Y
"RTN","PSOCPB",57,0)
 W !,?17,"PATIENT: ",$P($G(^DPT($P(^PSRX(PSODA,0),"^",2),0)),"^")
"RTN","PSOCPB",58,0)
 D ICN^PSODPT($P(^PSRX(PSODA,0),"^",2))
"RTN","PSOCPB",59,0)
 S PSORXN=$P(^PSRX(PSODA,0),"^"),PREA="R"
"RTN","PSOCPB",60,0)
 S PCOPAY=$G(^PSRX(PSODA,"IB"))
"RTN","PSOCPB",61,0)
 W !!,"Rx # ",PSORXN," is a ",$S(+PCOPAY:"Copay",1:"No Copay")," prescription"
"RTN","PSOCPB",62,0)
 D EXEMCHK^PSOCPC ; CHECK/CHANGE EXEMPTION FLAGS
"RTN","PSOCPB",63,0)
 ;
"RTN","PSOCPB",64,0)
 S PSOIBQ=$G(^PSRX(PSODA,"IBQ"))
"RTN","PSOCPB",65,0)
 I '$G(^PSRX(PSODA,"IB")),PSOIBQ'["1" D  G ASKCAN
"RTN","PSOCPB",66,0)
 . K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to reset the status to COPAY" D ^DIR K DIR
"RTN","PSOCPB",67,0)
 . I Y'=1 Q
"RTN","PSOCPB",68,0)
 . S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset : " D ^DIC K DIC I Y'<0 S PSORSN=+Y
"RTN","PSOCPB",69,0)
 . S PREA="R",PSOOLD="No Copay",PSONW="Copay",PSOCOMM="" D ACTLOG^PSOCPA
"RTN","PSOCPB",70,0)
 . S PSI=0,PSOCOMM="Copay status of this Rx has been reset to COPAY." D SETSUMM^PSOCPC
"RTN","PSOCPB",71,0)
 . S $P(^PSRX(PSODA,"IB"),"^")=1 ; Reset flag to COPAY
"RTN","PSOCPB",72,0)
 ;
"RTN","PSOCPB",73,0)
 I $G(^PSRX(PSODA,"IB")) D  G ASKCAN
"RTN","PSOCPB",74,0)
 . K DIR S DIR(0)="Y",DIR("B")="N",DIR("A")="Do you want to reset the status to NO COPAYMENT" D ^DIR K DIR
"RTN","PSOCPB",75,0)
 . I Y'=1 Q
"RTN","PSOCPB",76,0)
 . S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset : " D ^DIC K DIC I Y'<0 S PSORSN=+Y
"RTN","PSOCPB",77,0)
 . S PREA="R",PSOOLD="Copay",PSONW="No Copay",PSOCOMM="" D ACTLOG^PSOCPA
"RTN","PSOCPB",78,0)
 . S PSI=0,PSOCOMM="Copay status of this Rx has been reset to NO COPAY." D SETSUMM^PSOCPC
"RTN","PSOCPB",79,0)
 . S $P(^PSRX(PSODA,"IB"),"^")="" ; Reset flag to NO COPAY
"RTN","PSOCPB",80,0)
ASKCAN D ASKCAN^PSOCPD
"RTN","PSOCPB",81,0)
 I '$D(PSOSUMM) S PSI=0,PSOCOMM="No action taken" D SETSUMM^PSOCPC
"RTN","PSOCPB",82,0)
 D PRTSUMM
"RTN","PSOCPB",83,0)
RESETE K PSODA,PSORXN,PSORSN,PSOREF,X,Y,PCOPAY,PREA,PSOCOMM,PSI
"RTN","PSOCPB",84,0)
 G RESET
"RTN","PSOCPB",85,0)
EXT K PSODA,PSORXN,PSORSN,PSOREF,X,Y,PCOPAY,PREA,PSOCOPAY
"RTN","PSOCPB",86,0)
 Q
"RTN","PSOCPB",87,0)
BILLED ; Collect IB numbers,cancel chrgs,reset flag.
"RTN","PSOCPB",88,0)
 W !!,"**********Charges are on file for this Rx.**********"
"RTN","PSOCPB",89,0)
 Q
"RTN","PSOCPB",90,0)
BILL2 ;
"RTN","PSOCPB",91,0)
 N PSOPREV ; VARIABLE FOR PREVIOUSLY CANCELLED
"RTN","PSOCPB",92,0)
 S PSOPREV=0
"RTN","PSOCPB",93,0)
 S DIC="^IBE(350.3,",DIC("S")="I $P(^(0),U,3)'=2",DIC(0)="AEQMZ",DIC("A")="Select Reason for Reset or Charge Cancellation : " D ^DIC K DIC G ENDMSG:Y<0 S PSORSN=+Y
"RTN","PSOCPB",94,0)
 S X=PSOPAR7_"^"_+$P(^PSRX(PSODA,0),"^",2)_"^^"_DUZ
"RTN","PSOCPB",95,0)
 S SAVX=X
"RTN","PSOCPB",96,0)
 D POTBILL2
"RTN","PSOCPB",97,0)
 I '$D(PSOCAN) G BILL2END
"RTN","PSOCPB",98,0)
 I $G(CANTYPE) D PREVCAN I $O(X(""))="" Q
"RTN","PSOCPB",99,0)
 I '$G(CANTYPE) S I="" F  S I=$O(PSOCAN(I)) Q:I=""  S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN
"RTN","PSOCPB",100,0)
 D CANCEL^IBARX
"RTN","PSOCPB",101,0)
 I $G(CANTYPE) D MSG
"RTN","PSOCPB",102,0)
 I '$D(Y) Q
"RTN","PSOCPB",103,0)
 I +Y=-1 Q
"RTN","PSOCPB",104,0)
 I $D(Y(PSORXN)),+Y(PSORXN)'=-1 S $P(^PSRX(PSODA,"IB"),"^",2)=+Y(PSORXN) K Y(PSORXN) S PREA="C",PSOREF=0,PSOOLD="",PSONW="" D ACTLOG^PSOCPA I '$G(CANTYPE) D MSG
"RTN","PSOCPB",105,0)
 F PSOREF=0:0 S PSOREF=$O(Y(PSOREF)) Q:PSOREF=""  I +Y(PSOREF)'=-1 S ^PSRX(PSODA,1,PSOREF,"IB")=+Y(PSOREF) S PREA="C",PSOOLD="",PSONW="" D ACTLOG^PSOCPA I '$G(CANTYPE) D MSG
"RTN","PSOCPB",106,0)
BILL2END K X,Y,SAVX,PSOREF,PSOCAN
"RTN","PSOCPB",107,0)
 Q
"RTN","PSOCPB",108,0)
 ;
"RTN","PSOCPB",109,0)
POTBILL2 ; see if any potential charges (entries from file 354.71 -- bills that exceeded cap previously) to be cancelled before cancelling regular charges
"RTN","PSOCPB",110,0)
 N X,I
"RTN","PSOCPB",111,0)
 S X=SAVX
"RTN","PSOCPB",112,0)
 I $T(CANIBAM^IBARX)="" Q
"RTN","PSOCPB",113,0)
 S I="" F  S I=$O(PSOCAN(I)) Q:I=""  I PSOCAN(I)["^CAP" S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN K PSOCAN(I)
"RTN","PSOCPB",114,0)
 I $O(X(""))="" Q
"RTN","PSOCPB",115,0)
 S PSOPREV=1
"RTN","PSOCPB",116,0)
 D CANIBAM^IBARX
"RTN","PSOCPB",117,0)
 I $D(X(PSORXN)) S $P(^PSRX(PSODA,"IB"),"^",4)="" S PREA="C",PSOREF=0,PSOCOMM="Potential charge cancelled",PSOOLD="",PSONW="" D ACTLOG^PSOCPA D POTMSG K X(PSORXN)
"RTN","PSOCPB",118,0)
 F PSOREF=0:0 S PSOREF=$O(X(PSOREF)) Q:PSOREF=""  Q:PSOREF>11  S $P(^PSRX(PSODA,1,PSOREF,"IB"),"^",2)="" S PREA="C",PSOCOMM="Potential charge cancelled",PSOOLD="",PSONW="" D ACTLOG^PSOCPA D POTMSG
"RTN","PSOCPB",119,0)
 K PSOREF,PREA,PSOCOMM
"RTN","PSOCPB",120,0)
 Q
"RTN","PSOCPB",121,0)
 ;
"RTN","PSOCPB",122,0)
REFILL S PSOREF=0
"RTN","PSOCPB",123,0)
 F  S PSOREF=$O(^PSRX(PSODA,1,PSOREF)) Q:PSOREF'?1N.N  I $D(^PSRX(PSODA,1,PSOREF,"IB")),+^("IB")>0 S X(PSOREF)=+^PSRX(PSODA,1,PSOREF,"IB")_"^"_$G(PSORSN)
"RTN","PSOCPB",124,0)
 S PSOREF=0 F  S PSOREF=$O(^PSRX(PSODA,1,PSOREF)) Q:PSOREF'?1N.N  I '$D(X(PSOREF)),+$P($G(^PSRX(PSODA,1,PSOREF,"IB")),"^",2) S XX(PSOREF)=+$P(^PSRX(PSODA,1,PSOREF,"IB"),"^",2)_"^"_$G(PSORSN) ; IF ONLY ENTRY FROM 354.71 SAVE IT
"RTN","PSOCPB",125,0)
 Q
"RTN","PSOCPB",126,0)
SETCP ; IF NOT COPAY MAKE ELIG CALL/SET FLAG FOR FUTURE
"RTN","PSOCPB",127,0)
 W ! S X=PSOPAR7_"^"_+$P(^PSRX(PSODA,0),"^",2)
"RTN","PSOCPB",128,0)
 D XTYPE^IBARX
"RTN","PSOCPB",129,0)
 I +Y=-1 W !!,"Error in processing Copay eligibility, no action taken." Q
"RTN","PSOCPB",130,0)
 S (ACTYP,BL)="",(PSOBILL,PSOCPAY)=0
"RTN","PSOCPB",131,0)
CP ;
"RTN","PSOCPB",132,0)
 S ACTYP=$O(Y(ACTYP)) G:'ACTYP CP1
"RTN","PSOCPB",133,0)
 F I=0:0 S BL=$O(Y(ACTYP,BL)) Q:BL=""  I BL>0 S PSOBILL=BL,PSOCPAY=ACTYP
"RTN","PSOCPB",134,0)
 G CP
"RTN","PSOCPB",135,0)
CP1 K ACTYP,BL,I
"RTN","PSOCPB",136,0)
 I (PSOBILL'>0)!(PSOCPAY=0) G INELIG
"RTN","PSOCPB",137,0)
 S $P(^PSRX(PSODA,"IB"),"^")=PSOCPAY
"RTN","PSOCPB",138,0)
 W !,"COPAY status on this Rx has been reset.",!,"*** Future refills will be classified as COPAY."
"RTN","PSOCPB",139,0)
 S PREA="R",PSOOLD="No Copay",PSONW="Copay"
"RTN","PSOCPB",140,0)
 D ACTLOG^PSOCPA
"RTN","PSOCPB",141,0)
 Q
"RTN","PSOCPB",142,0)
INELIG W !,"This Rx does not meet patient eligibility requirement for Copay.",!,"****** Status unchanged *******"
"RTN","PSOCPB",143,0)
 S Y=-1
"RTN","PSOCPB",144,0)
 ; K PSOCPAY,PSOBILL,PSODA,PSORXN,PSORSN
"RTN","PSOCPB",145,0)
 Q
"RTN","PSOCPB",146,0)
ENDMSG K X W !,"Unable to process CHARGE REMOVAL without REASON for Reset."
"RTN","PSOCPB",147,0)
 R !,"ENTER a REASON now?  (Y/N) ",X:DTIME Q:'$T
"RTN","PSOCPB",148,0)
 I ($E(X)["?")!("YyNn^"'[$E(X)) W !,"Enter YES to select REASON and RESET STATUS." G ENDMSG
"RTN","PSOCPB",149,0)
 I "Yy"[$E(X) G BILL2
"RTN","PSOCPB",150,0)
 Q
"RTN","PSOCPB",151,0)
 ;
"RTN","PSOCPB",152,0)
MSG ;
"RTN","PSOCPB",153,0)
 S PSI=0
"RTN","PSOCPB",154,0)
 I $G(CANTYPE) S PSOCOMM="Rx # "_PSORXN_" - All copay charges cancelled" D SETSUMM^PSOCPC K PSOCOMM Q
"RTN","PSOCPB",155,0)
 S PSOCOMM="Rx # "_PSORXN_" - "_$S(PSOREF=0:"Original fill",1:"Refill "_PSOREF)_" copay charge cancelled"
"RTN","PSOCPB",156,0)
 D SETSUMM^PSOCPC
"RTN","PSOCPB",157,0)
 K PSOCOMM
"RTN","PSOCPB",158,0)
 Q
"RTN","PSOCPB",159,0)
 ;
"RTN","PSOCPB",160,0)
POTMSG ;
"RTN","PSOCPB",161,0)
 S PSI=0
"RTN","PSOCPB",162,0)
 I $G(CANTYPE) Q  ; (MESSAGE WILL GET SET LATER)
"RTN","PSOCPB",163,0)
 S PSOCOMM="Rx # "_PSORXN_" - "_$S(PSOREF=0:"Original fill",1:"Refill "_PSOREF)_" potential copay charge cancelled"
"RTN","PSOCPB",164,0)
 D SETSUMM^PSOCPC
"RTN","PSOCPB",165,0)
 K PSOCOMM
"RTN","PSOCPB",166,0)
 Q
"RTN","PSOCPB",167,0)
 ;
"RTN","PSOCPB",168,0)
MSGNOCAN ;
"RTN","PSOCPB",169,0)
 S PSI=0
"RTN","PSOCPB",170,0)
 S PSOCOMM="Rx # "_PSORXN_" - All copay charges have already been cancelled." D SETSUMM^PSOCPC K PSOCOMM
"RTN","PSOCPB",171,0)
 Q
"RTN","PSOCPB",172,0)
 ;
"RTN","PSOCPB",173,0)
PRTSUMM ; print summary of actions in reset/cancel
"RTN","PSOCPB",174,0)
 I '$D(PSOSUMM) Q
"RTN","PSOCPB",175,0)
 W !
"RTN","PSOCPB",176,0)
 S PSI=""
"RTN","PSOCPB",177,0)
 F  S PSI=$O(PSOSUMM(PSI)) Q:PSI=""  W !,PSOSUMM(PSI)
"RTN","PSOCPB",178,0)
 K PSOSUMM
"RTN","PSOCPB",179,0)
 Q
"RTN","PSOCPB",180,0)
 ;
"RTN","PSOCPB",181,0)
PREVCAN ; PREVIEW CANCELS IF "ALL" IS SELECTED
"RTN","PSOCPB",182,0)
 N I,PSOBILL
"RTN","PSOCPB",183,0)
 S I="" F  S I=$O(PSOCAN(I)) Q:I=""  D  I PSOBILL S X($P(PSOCAN(I),"^",1))=$P(PSOCAN(I),"^",2)_"^"_PSORSN
"RTN","PSOCPB",184,0)
 . S PSOBILL=1 I $T(STATUS^IBARX)'="" I PSOCAN(I)'["CAP" S PSOBILL=$$STATUS^IBARX($P(PSOCAN(I),"^",2)) S:PSOBILL=2 PSOBILL=0 ; PREVIOUSLY CANCELLED
"RTN","PSOCPB",185,0)
 I $O(X(""))="" D
"RTN","PSOCPB",186,0)
 . I PSOPREV D MSG Q
"RTN","PSOCPB",187,0)
 . D MSGNOCAN
"RTN","PSOCPB",188,0)
 Q
"RTN","PSOCPB",189,0)
 ;
"RTN","PSOCPC")
0^22^B67206155^B66994025
"RTN","PSOCPC",1,0)
PSOCPC ;BHAM ISC/BAB - PHARMACY CO-PAY APPLICATION ;06/09/92
"RTN","PSOCPC",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**10,9,71,85,114,157,143,239**;DEC 1997
"RTN","PSOCPC",3,0)
 ;
"RTN","PSOCPC",4,0)
 ;REF/IA
"RTN","PSOCPC",5,0)
 ;piece 9 of zero node of File 350 and APDT cross reference of File 350/2215
"RTN","PSOCPC",6,0)
 ;$$STATUS^IBARX/125
"RTN","PSOCPC",7,0)
 ;File 350.1/592 (DBIA125-B)
"RTN","PSOCPC",8,0)
WARN ; Message when attempt is made to delete a refill date on COPAY
"RTN","PSOCPC",9,0)
 N PSOIB,PSOIBST
"RTN","PSOCPC",10,0)
 S PSOFLG=0
"RTN","PSOCPC",11,0)
 G:'$D(^PSRX(DA(1),1,DA,"IB")) ENDW
"RTN","PSOCPC",12,0)
 S PSOIB=^PSRX(DA(1),1,DA,"IB")
"RTN","PSOCPC",13,0)
 I +PSOIB'>0 G ENDW
"RTN","PSOCPC",14,0)
 S PSOIBST=$$STATUS^IBARX(+PSOIB) I PSOIBST=2!(PSOIBST=0) G ENDW
"RTN","PSOCPC",15,0)
 I +PSOIB>0 D CANCEL G ENDW:PSOFLG=0
"RTN","PSOCPC",16,0)
 I '$G(PSOXXDEL) D EN^DDIOL("This REFILL has COPAY charges, which MUST be removed","","$C(7),!!"),EN^DDIOL("BEFORE the refill date is deleted.","","!")
"RTN","PSOCPC",17,0)
 I '$G(PSOXXDEL) D EN^DDIOL("Use option RESET COPAY STATUS/CANCEL CHARGES, return to EDIT A PRESCRIPTION,","","!!"),EN^DDIOL("and delete the refill date.","","!"),EN^DDIOL(" ","","!!")
"RTN","PSOCPC",18,0)
 S PSOFLG=1
"RTN","PSOCPC",19,0)
ENDW ;
"RTN","PSOCPC",20,0)
 I PSOFLG
"RTN","PSOCPC",21,0)
 K PSOFLG
"RTN","PSOCPC",22,0)
 Q
"RTN","PSOCPC",23,0)
CANCEL ;Check if charge is cancelled for this Refill date
"RTN","PSOCPC",24,0)
 S PSOFLG=1 ;indicates a charge not cancelled
"RTN","PSOCPC",25,0)
 S PSOX=+^PSRX(DA(1),1,DA,"IB")
"RTN","PSOCPC",26,0)
 D LAST I PSOLAST'=PSOPARNT,$D(^IB(PSOLAST,0)),$P(^IBE(350.1,$P(^IB(PSOLAST,0),"^",3),0),"^",5)=2 S PSOFLG=0
"RTN","PSOCPC",27,0)
 K PSOLAST,PSOPARNT,PSOX,PSOL,PSOLDT
"RTN","PSOCPC",28,0)
 Q
"RTN","PSOCPC",29,0)
LAST ;find last entry
"RTN","PSOCPC",30,0)
 S PSOLAST=""
"RTN","PSOCPC",31,0)
 S PSOPARNT=$P(^IB(+PSOX,0),"^",9) I 'PSOPARNT S PSOPARNT=+PSOX
"RTN","PSOCPC",32,0)
 S PSOLDT=$O(^IB("APDT",PSOPARNT,"")) I +PSOLDT F PSOL=0:0 S PSOL=$O(^IB("APDT",PSOPARNT,PSOLDT,PSOL)) Q:'PSOL  S PSOLAST=PSOL
"RTN","PSOCPC",33,0)
 I PSOLAST="" S PSOLAST=PSOPARNT
"RTN","PSOCPC",34,0)
 Q
"RTN","PSOCPC",35,0)
 ;
"RTN","PSOCPC",36,0)
EXEMCHK ; Allow reset of exemption answers
"RTN","PSOCPC",37,0)
 N PSOTG,PSOCPN,PSOEXMT,PSOANS,OLDIBQ,PSOSCP,PSOSCA
"RTN","PSOCPC",38,0)
 S PSOANS=0 D SCP^PSORN52D
"RTN","PSOCPC",39,0)
 S OLDIBQ=$G(^PSRX(PSODA,"IBQ"))
"RTN","PSOCPC",40,0)
 I OLDIBQ[0!(OLDIBQ)[1 D
"RTN","PSOCPC",41,0)
 . S PSOANS=1
"RTN","PSOCPC",42,0)
 . I $P(OLDIBQ,"^",1)'="" S PSOTG("SC")=$P(OLDIBQ,"^",1)
"RTN","PSOCPC",43,0)
 . I $P(OLDIBQ,"^",2)'="" S PSOTG("MST")=$P(OLDIBQ,"^",2)
"RTN","PSOCPC",44,0)
 . I $P(OLDIBQ,"^",3)'="" S PSOTG("AO")=$P(OLDIBQ,"^",3)
"RTN","PSOCPC",45,0)
 . I $P(OLDIBQ,"^",4)'="" S PSOTG("IR")=$P(OLDIBQ,"^",4)
"RTN","PSOCPC",46,0)
 . I $P(OLDIBQ,"^",5)'="" S PSOTG("EC")=$P(OLDIBQ,"^",5)
"RTN","PSOCPC",47,0)
 . I $P(OLDIBQ,"^",6)'="" S PSOTG("HNC")=$P(OLDIBQ,"^",6)
"RTN","PSOCPC",48,0)
 . I $P(OLDIBQ,"^",7)'="" S PSOTG("CV")=$P(OLDIBQ,"^",7)
"RTN","PSOCPC",49,0)
 S PSOCPN=$P(^PSRX(PSODA,0),"^",2)
"RTN","PSOCPC",50,0)
 S RXP=PSODA
"RTN","PSOCPC",51,0)
 D SCNEW^PSOCP(.PSOTG,PSOCPN,"",PSODA)
"RTN","PSOCPC",52,0)
 N EXMT
"RTN","PSOCPC",53,0)
 D XTYPE^PSOCP ; KEEP THIS CALL IN HERE TO SEE IF SC QUESTION APPLIES
"RTN","PSOCPC",54,0)
 ;I $D(PSOTG("SC")) S PSOTG("SC")=$P(OLDIBQ,"^",1) ; CHANGED TO JUST USE IBQ SETTING IF SC QUESTION APPLIES - DON'T RE-CALCULATE SERVICE-CONNECTED
"RTN","PSOCPC",55,0)
 S EXMT="" F  S EXMT=$O(PSOTG(EXMT)) Q:EXMT=""  I PSOTG(EXMT)'="" S PSOANS=1 Q
"RTN","PSOCPC",56,0)
 I $O(PSOTG(""))="" Q
"RTN","PSOCPC",57,0)
 I PSOANS W !!,"The following exemption flags have been set:"
"RTN","PSOCPC",58,0)
 F EXMT="SC","CV","AO","IR","EC","MST","HNC" I $G(PSOTG(EXMT))'="" W !,EXMT,": ",?6,$S(PSOTG(EXMT)=1:"Yes",PSOTG(EXMT)=0:"No",1:"")
"RTN","PSOCPC",59,0)
 W !
"RTN","PSOCPC",60,0)
 W ! K DIR S DIR(0)="Y",DIR("B")="N" D  S DIR("A")="Do you want to enter/edit any copay exemption flags"
"RTN","PSOCPC",61,0)
 . S EXMT="" F  S EXMT=$O(PSOTG(EXMT)) Q:EXMT=""  I PSOTG(EXMT)="" S DIR("B")="Y" Q
"RTN","PSOCPC",62,0)
 S DIR("?")="Enter 'Y' for Yes if you want to edit any applicable medication exemption flags."
"RTN","PSOCPC",63,0)
 S DIR("??")="^D HELPEXEM^PSOCPC"
"RTN","PSOCPC",64,0)
 D ^DIR K DIR S PSOEXMT=Y I Y'=1 Q
"RTN","PSOCPC",65,0)
 ; PRESENT ALL APPLICABLE EXEMPTIONS AND SAVE NEW ANSWERS
"RTN","PSOCPC",66,0)
 N PSOIBQ,PSOSUBS,PSOQUES,PSOLTAG,OLDIBQ,II,PSOCHG,PSOPATST
"RTN","PSOCPC",67,0)
 S PSOPATST=$$GET1^DIQ(52,PSODA_",",3,"I")
"RTN","PSOCPC",68,0)
 S PSOIBQ=""
"RTN","PSOCPC",69,0)
 S OLDIBQ=$G(^PSRX(PSODA,"IBQ"))
"RTN","PSOCPC",70,0)
 I '$D(^PSRX(PSODA,"IBQ")),+($G(^PSRX(PSODA,"IB")))=2 S $P(OLDIBQ,"^",1)=0 ; SC QUESTION WAS PREVIOUSLY ANSWERED AS N
"RTN","PSOCPC",71,0)
 S PSOCOMM="",PSOOLD="",PSONW=""
"RTN","PSOCPC",72,0)
 S II=0
"RTN","PSOCPC",73,0)
 F EXMT="SC","CV","AO","IR","EC","MST","HNC" I $D(PSOTG(EXMT)) D
"RTN","PSOCPC",74,0)
 . S PSOLTAG="REL"_EXMT_"^PSOCPE"
"RTN","PSOCPC",75,0)
 . S HELPTAG="HELP"_EXMT
"RTN","PSOCPC",76,0)
 . S PSOQUES=$P($T(@PSOLTAG),";",2) I PSOQUES="" Q
"RTN","PSOCPC",77,0)
 . S PSOQUES=$P(PSOQUES,"?")
"RTN","PSOCPC",78,0)
 . S PSOSUBS=$P($T(@PSOLTAG),";",3) I PSOSUBS="" Q
"RTN","PSOCPC",79,0)
 . D ASKEXEM
"RTN","PSOCPC",80,0)
 I $D(PSOCHG) D
"RTN","PSOCPC",81,0)
 . S:PSOSCP<50&($TR(PSOIBQ,"^")'="")&($P($G(^PS(53,+$G(PSOPATST),0)),"^",7)'=1) ^PSRX(PSODA,"IBQ")=PSOIBQ
"RTN","PSOCPC",82,0)
 . D RESET^PSORN52D  ;set SC/EI on ICD node
"RTN","PSOCPC",83,0)
 . D EN^PSOHLSN1(PSODA,"XX","","Order edited")
"RTN","PSOCPC",84,0)
 . I PCOPAY,PSOIBQ["1" D  ; RESET TO NO COPAY
"RTN","PSOCPC",85,0)
 . . W !,"Editing of exemption flag(s) has resulted in a copay status change.",!,"The status for this Rx will be reset to NO COPAY."
"RTN","PSOCPC",86,0)
 . . S $P(^PSRX(PSODA,"IB"),"^",1)=""
"RTN","PSOCPC",87,0)
 . . S PSOREF="",PSOOLD="Copay",PSONW="No Copay",PREA="R" D ACTLOG^PSOCPA
"RTN","PSOCPC",88,0)
 . . S PSOCOMM="Copay status reset due to exemption flag(s)"
"RTN","PSOCPC",89,0)
 . . S PSI=0 D SETSUMM
"RTN","PSOCPC",90,0)
 . I $G(II)>0 D
"RTN","PSOCPC",91,0)
 . . S PSOCOMM="The following exemption flags have been changed: ",PSI=0 D SETSUMM
"RTN","PSOCPC",92,0)
 . . S II="" F  S II=$O(PSOCHG(II)) Q:II=""  S PSOCOMM=PSOCHG(II),PSI=0 D SETSUMM
"RTN","PSOCPC",93,0)
 Q
"RTN","PSOCPC",94,0)
 ;
"RTN","PSOCPC",95,0)
ASKEXEM ; ASK THE EXEMPTION QUESTIONS
"RTN","PSOCPC",96,0)
 K DIR S DIR("A")=PSOQUES,DIR(0)="YO" S:PSOTG(EXMT)=1 DIR("B")="Y" S:PSOTG(EXMT)=0 DIR("B")="N" D @HELPTAG
"RTN","PSOCPC",97,0)
ASKEXEM1 D ^DIR I X="@" R !,"  Are you sure you want to delete this answer? ",X:DTIME I $E(X)'="Y",$E(X)'="y" G ASKEXEM1
"RTN","PSOCPC",98,0)
 I X="^" S X=$G(DIR("B")) S Y=$S(X="Y":1,X="N":0,1:"")
"RTN","PSOCPC",99,0)
 S $P(PSOIBQ,"^",PSOSUBS)=$S(Y=1:1,Y=0:0,1:"")
"RTN","PSOCPC",100,0)
 I $P(PSOIBQ,"^",PSOSUBS)'=$P(OLDIBQ,"^",PSOSUBS) S II=II+1,PSOCHG(II)=EXMT_": "_$S($P(PSOIBQ,"^",PSOSUBS)=1:"Yes",$P(PSOIBQ,"^",PSOSUBS)=0:"No",1:"")
"RTN","PSOCPC",101,0)
 I Y=1 D
"RTN","PSOCPC",102,0)
 . I PSOCOMM'="" Q
"RTN","PSOCPC",103,0)
 . D SETCOMM^PSOCP
"RTN","PSOCPC",104,0)
 Q
"RTN","PSOCPC",105,0)
 ;
"RTN","PSOCPC",106,0)
HELPEXEM ; help text for exemption edit question
"RTN","PSOCPC",107,0)
 W !,"Enter 'Y' for Yes if you want to edit any applicable exemption flags such as"
"RTN","PSOCPC",108,0)
 W !,"Service Connected (SC), Combat Veteran(CV), Agent Orange (AO), Ionizing Radiation (IR),"
"RTN","PSOCPC",109,0)
 W !,"Environmental Contaminants (EC), Military Sexual Trauma (MST), or"
"RTN","PSOCPC",110,0)
 W !,"Head and/or Neck Cancer (HNC)."
"RTN","PSOCPC",111,0)
 Q
"RTN","PSOCPC",112,0)
 ;
"RTN","PSOCPC",113,0)
HELPSC ;
"RTN","PSOCPC",114,0)
 S DIR("?")=" ",DIR("?",1)="Enter 'Yes' if this prescription is for a Service Connected condition."
"RTN","PSOCPC",115,0)
 S DIR("?",2)="This response will be used to determine whether or not a copay should be"
"RTN","PSOCPC",116,0)
 S DIR("?",3)="applied to the prescription."
"RTN","PSOCPC",117,0)
 Q
"RTN","PSOCPC",118,0)
 ;
"RTN","PSOCPC",119,0)
HELPAO ;
"RTN","PSOCPC",120,0)
 S DIR("?")=" ",DIR("?",1)="Enter 'Yes' if this prescription is being used to treat a condition due to",DIR("?",2)="Vietnam-Era Herbicide (Agent Orange) exposure. This response will be used to"
"RTN","PSOCPC",121,0)
 S DIR("?",3)="determine whether or not a copay should be applied to the prescription."
"RTN","PSOCPC",122,0)
 Q
"RTN","PSOCPC",123,0)
 ;
"RTN","PSOCPC",124,0)
HELPIR ;
"RTN","PSOCPC",125,0)
 S DIR("?")=" ",DIR("?",1)="Enter 'Yes' if this prescription is being used to treat a condition due to",DIR("?",2)="ionizing radiation exposure during military service. This response will be used"
"RTN","PSOCPC",126,0)
 S DIR("?",3)="to determine whether or not a copay should be applied to the prescription."
"RTN","PSOCPC",127,0)
 Q
"RTN","PSOCPC",128,0)
 ;
"RTN","PSOCPC",129,0)
HELPEC ;
"RTN","PSOCPC",130,0)
 S DIR("?")=" ",DIR("?",1)="Enter 'Yes' if this prescription is being used to treat a condition due to",DIR("?",2)="environmental contaminant exposure during the Persian Gulf War. This response"
"RTN","PSOCPC",131,0)
 S DIR("?",3)="will be used to determine whether or not a copay should be applied to the",DIR("?",4)="prescription."
"RTN","PSOCPC",132,0)
 Q
"RTN","PSOCPC",133,0)
 ;
"RTN","PSOCPC",134,0)
HELPMST ;
"RTN","PSOCPC",135,0)
 S DIR("?")=" ",DIR("?",1)="Enter 'Yes' if this prescription is being used to treat a condition related",DIR("?",2)="to Military Sexual Trauma. This response will be used to determine whether or"
"RTN","PSOCPC",136,0)
 S DIR("?",3)="not a copay should be applied to the prescription."
"RTN","PSOCPC",137,0)
 Q
"RTN","PSOCPC",138,0)
 ;
"RTN","PSOCPC",139,0)
HELPHNC ;
"RTN","PSOCPC",140,0)
 S DIR("?")=" ",DIR("?",1)="Enter 'Yes' if this prescription is being used to treat Head and/or Neck Cancer",DIR("?",2)="due to nose or throat radium treatments while in the military. This response"
"RTN","PSOCPC",141,0)
 S DIR("?",3)="will be used to determine whether or not a copay should be applied to the",DIR("?",4)="prescription."
"RTN","PSOCPC",142,0)
 Q
"RTN","PSOCPC",143,0)
 ;
"RTN","PSOCPC",144,0)
HELPCV ;
"RTN","PSOCPC",145,0)
 S DIR("?")=" "
"RTN","PSOCPC",146,0)
 S DIR("?",1)="Enter 'Yes' if this prescription is being used to treat a condition related"
"RTN","PSOCPC",147,0)
 S DIR("?",2)="to Combat Services. This response will be used to determine whether or"
"RTN","PSOCPC",148,0)
 S DIR("?",3)="not a copay should be applied to the prescription."
"RTN","PSOCPC",149,0)
 Q
"RTN","PSOCPC",150,0)
 ;
"RTN","PSOCPC",151,0)
SETSUMM ; SET MESSAGE INTO SUMMARY
"RTN","PSOCPC",152,0)
 S PSI=$O(PSOSUMM(PSI)) G:$O(PSOSUMM(PSI)) SETSUMM
"RTN","PSOCPC",153,0)
 S PSI=PSI+1,PSOSUMM(PSI)=PSOCOMM
"RTN","PSOCPC",154,0)
 K PSOCOMM
"RTN","PSOCPC",155,0)
 Q
"RTN","PSOCPC",156,0)
 ;
"RTN","PSODIAG")
0^7^B62418422^B63400905
"RTN","PSODIAG",1,0)
PSODIAG ;BIR/LE - Diagnosis code prompts ;02/27/04
"RTN","PSODIAG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,219,239**;DEC 1997
"RTN","PSODIAG",3,0)
 ;Ext ref to ^XUSEC sup by DBIA 10076
"RTN","PSODIAG",4,0)
 ;Ext ref to $$ICDDX^ICDCODE sup DBIA 3990
"RTN","PSODIAG",5,0)
 ;Ext ref to $$STATCHK^ICDAPIU sup DBIA 3991
"RTN","PSODIAG",6,0)
EN ;
"RTN","PSODIAG",7,0)
 ;don't ask icd's if user doesn't hold provider key
"RTN","PSODIAG",8,0)
 Q:$T(CIDC^IBBAPI)']""
"RTN","PSODIAG",9,0)
 Q:'$D(^XUSEC("PROVIDER",DUZ))
"RTN","PSODIAG",10,0)
 N PSODDFN S PSODDFN=$S($D(DFN):DFN,$D(PSODFN):PSODFN,1:"")  ;need to do this since PU patient update deletes DFN and in case some other function does
"RTN","PSODIAG",11,0)
 I PSODDFN'="" Q:'$$CIDC^IBBAPI(PSODDFN)  ;is CIDC activated; does patient have insurance
"RTN","PSODIAG",12,0)
 ;new variables and initialize variables based on CPRS or backdoor order.
"RTN","PSODIAG",13,0)
 N DX,POP,I,J,X,Y,Z,OLD,OLDI,SOLDI,NEW,TNEW,RAR,CPRS,FILDAT,STATCHK,STATCHK2
"RTN","PSODIAG",14,0)
 I '$G(PSOX("IRXN")) N PSOX S:$G(PSORXED("IRXN")) PSOX("IRXN")=PSORXED("IRXN")
"RTN","PSODIAG",15,0)
 K DIC
"RTN","PSODIAG",16,0)
 S CPRS=0
"RTN","PSODIAG",17,0)
 I $G(PSORXED) S RAR="PSORXED",@RAR@("DFLG")=0,PSORXED("FLD",39.3)=""
"RTN","PSODIAG",18,0)
 E  S RAR="PSONEW",@RAR@("DFLG")=0 I $G(ORD) D
"RTN","PSODIAG",19,0)
 . I $D(^PS(52.41,ORD)) S CPRS=1 M PSONEW("ICD")=PSORXED("ICD") K PSORXED("ICD"),PSORXED("FLD",39.3)
"RTN","PSODIAG",20,0)
 ;
"RTN","PSODIAG",21,0)
 S FILDAT="",FILDAT=DT I $G(PSOX("IRXN")) S FILDAT=$$GET1^DIQ(52,PSOX("IRXN")_",","22","I")
"RTN","PSODIAG",22,0)
 ;display any previously entered ICD's
"RTN","PSODIAG",23,0)
 W !!,"Previously entered ICD-9 diagnosis codes: "
"RTN","PSODIAG",24,0)
 I 'CPRS D  ;&(RAR="PSORXED"!(RAR="PSONEW")) D
"RTN","PSODIAG",25,0)
 . I $D(PSOX("IRXN")) I '$D(PSORXED("ICD")) I $D(^PSRX(PSOX("IRXN"),"ICD")) F I=1:1:8 Q:'$D(^PSRX(PSOX("IRXN"),"ICD",I,0))  D
"RTN","PSODIAG",26,0)
 .. S OLD(I)=$$GET1^DIQ(52.052311,I_","_PSOX("IRXN")_",",".01")
"RTN","PSODIAG",27,0)
 .. S OLDI(I)=$$GET1^DIQ(52.052311,I_","_PSOX("IRXN")_",",".01","I")
"RTN","PSODIAG",28,0)
 . I ($D(@RAR@("ICD"))&('$D(OLD)))!($G(PSOCOPY)) D
"RTN","PSODIAG",29,0)
 .. F I=1:1:8 Q:'$D(@RAR@("ICD",I))  I @RAR@("ICD",I)'="" S OLDI(I)=@RAR@("ICD",I) D
"RTN","PSODIAG",30,0)
 ... S OLD(I)=$P(^ICD9(OLDI(I),0),"^",1)
"RTN","PSODIAG",31,0)
 ... S J=I-1 I I=1 W OLD(I) Q
"RTN","PSODIAG",32,0)
 . F I=1:1:8 Q:'$D(OLD(I))  D WRITE
"RTN","PSODIAG",33,0)
 E  I CPRS D
"RTN","PSODIAG",34,0)
 . I '$G(PSONEW("ICD")) F I=1:1:8 Q:'$D(^PS(52.41,ORD,"ICD",I,0))  D
"RTN","PSODIAG",35,0)
 .. S OLD(I)=$$GET1^DIQ(52.41311,I_","_ORD_",",".01")
"RTN","PSODIAG",36,0)
 .. S OLDI(I)=$$GET1^DIQ(52.41311,I_","_ORD_",",".01","I")
"RTN","PSODIAG",37,0)
 . I $D(PSONEW("ICD")) K OLD,OLDI D
"RTN","PSODIAG",38,0)
 .. F I=1:1:8 Q:'$D(PSONEW("ICD",I))  S OLDI(I)=PSONEW("ICD",I) D
"RTN","PSODIAG",39,0)
 ... S OLD(I)=$P(^ICD9(OLDI(I),0),"^",1)
"RTN","PSODIAG",40,0)
 . F I=1:1:8 Q:'$D(OLD(I))  D WRITE
"RTN","PSODIAG",41,0)
 M SOLDI=OLDI
"RTN","PSODIAG",42,0)
 ;
"RTN","PSODIAG",43,0)
EN2 ;ask for ICD's or display previously entered ones for editing
"RTN","PSODIAG",44,0)
 ;note: because ICD's are not longer required, could not use standard
"RTN","PSODIAG",45,0)
 ;       FileMan calls everywhere because of need to control deleted
"RTN","PSODIAG",46,0)
 ;       entries and cross-references.
"RTN","PSODIAG",47,0)
 W !
"RTN","PSODIAG",48,0)
 F I=1:1:8 D  Q:+$G(Y)=-1!(@RAR@("DFLG")) 
"RTN","PSODIAG",49,0)
 . I '$G(PSORXED)&('$G(CPRS)) S RAR="PSONEW"
"RTN","PSODIAG",50,0)
 .K DIC S DIC("A")=$S(I=1:"Select Primary ICD-9 Code: ",1:"Select Secondary ICD-9 Code: ")
"RTN","PSODIAG",51,0)
 . I $D(OLD(I)),(OLD(I)'="") S DIC("B")=OLD(I)
"RTN","PSODIAG",52,0)
 . S X="" W !,DIC("A") D  R X:60   ;did this so that I have control of the deletes
"RTN","PSODIAG",53,0)
 .. I $D(OLD(I)),(OLD(I)'="") W OLD(I)_"// "
"RTN","PSODIAG",54,0)
 . I $D(OLD(I)) S:X="" X=OLD(I)
"RTN","PSODIAG",55,0)
 . I X="" S Y=-1 Q
"RTN","PSODIAG",56,0)
 . I X["?" W !,"Enter a valid ICD-9 diagnosis code." S I=1-1 Q
"RTN","PSODIAG",57,0)
 . I X="@" D DELETE Q
"RTN","PSODIAG",58,0)
 . I X="^" S Y=-1 Q
"RTN","PSODIAG",59,0)
 . K DIC S DIC=80,DIC(0)="EMZQ"
"RTN","PSODIAG",60,0)
 . ;S DIC("S")="I $P($$ICDDX^ICDCODE(Y,FILDAT),U,10)&($P($$ICDDX^ICDCODE(Y,FILDAT),U,17)>$P($$ICDDX^ICDCODE(Y,FILDAT),U,12))"
"RTN","PSODIAG",61,0)
 . S DIC("S")="I $$STATCHK^PSODIAG(Y,FILDAT)"
"RTN","PSODIAG",62,0)
 . K DTOUT,DUOUT D ^DIC K DIC
"RTN","PSODIAG",63,0)
 . I X="^" S I=I-1,Y="" Q
"RTN","PSODIAG",64,0)
 . I $G(DUOUT)!($G(DTOUT)) S Y=-1,X="^" Q
"RTN","PSODIAG",65,0)
 . I +Y=-1&(X'=""!(X'="^")) I $D(^ICD9("BA",X)) S I=I-1,(X,Y)="" Q  ;user said No to are you sure ?.
"RTN","PSODIAG",66,0)
 . I Y=-1&(X?1A.A) S I=I-1,Y="" Q  ;user said not to Yes? question.
"RTN","PSODIAG",67,0)
 . I Y'=-1 D  I STATCHK2=1 S I=I-1,Y="" Q
"RTN","PSODIAG",68,0)
 .. S (STATCHK,STATCHK2)="",STATCHK=$$STATCHK^ICDAPIU($P(Y,U,2),FILDAT) D
"RTN","PSODIAG",69,0)
 ... I $P(STATCHK,"^",2)=-1 W !!,"Invalid ICD-9 diagnosis code.  Please choose another.",! S STATCHK2=1 Q
"RTN","PSODIAG",70,0)
 ... I +STATCHK=0 W !!,"Inactivated ICD-9 Diagnosis Code.  Please choose another.",! S STATCHK2=1 Q
"RTN","PSODIAG",71,0)
 . I +Y=-1 S I=I-1,Y="" W !!,"Invalid or inactivated ICD-9 diagnosis code.  Please choose another.",! Q
"RTN","PSODIAG",72,0)
 . S (POP,J)=0 F J=1:1:I D
"RTN","PSODIAG",73,0)
 ..I $G(DX(J))=+Y W $C(7),!," Duplicate entry.  Please select a different ICD-9 diagnosis code.",! S I=I-1,(Y,X)="",POP=1
"RTN","PSODIAG",74,0)
 . Q:POP
"RTN","PSODIAG",75,0)
 . S NEW("ICD",I)=$P(Y,U,1),DX(I)=+Y
"RTN","PSODIAG",76,0)
 ;
"RTN","PSODIAG",77,0)
 ;resequence entered ICD's and removed deleted ones from file
"RTN","PSODIAG",78,0)
 ;I X="^"&(RAR="PSONEW")&('CPRS) S @RAR@("DFLG")=0 K DUOUT,DTOUT,Y,X Q
"RTN","PSODIAG",79,0)
 ;
"RTN","PSODIAG",80,0)
 I '$D(NEW("ICD")) I $D(OLDI) M NEW("ICD")=OLDI ;if user ^ out on first icd
"RTN","PSODIAG",81,0)
 K PSOICDD I '$D(NEW("ICD"))&($G(PSOCOPY)) S PSOICDD=1
"RTN","PSODIAG",82,0)
 ;
"RTN","PSODIAG",83,0)
 S J=0 F I=1:1:8 Q:'$D(NEW("ICD",I))  I NEW("ICD",I)'="" S J=J+1,@RAR@("ICD",J)=NEW("ICD",I)
"RTN","PSODIAG",84,0)
 S TNEW=I
"RTN","PSODIAG",85,0)
 I X="^" D  ;if up arrow out, set all icd's past ^ point into array
"RTN","PSODIAG",86,0)
 . ;S Y=TNEW-1 F  S Y=$O(OLDI(Y)) Q:Y=""  S J=J+1,@RAR@("ICD",J)=OLDI(Y)
"RTN","PSODIAG",87,0)
 . K @RAR@("ICD") S Y="" F  S Y=$O(SOLDI(Y)) Q:Y=""  S @RAR@("ICD",Y)=SOLDI(Y)
"RTN","PSODIAG",88,0)
 . K PSORXED("FLD",39.3)  ;7/12/04
"RTN","PSODIAG",89,0)
 I $G(CPRS) K PSORX("ICD") M PSORXED("ICD")=@RAR@("ICD"),PSORX("ICD")=@RAR@("ICD")
"RTN","PSODIAG",90,0)
 I $G(PSORXED) K PSORX("ICD") M PSORX("ICD")=@RAR@("ICD")
"RTN","PSODIAG",91,0)
 I '$D(@RAR@("ICD"))&(CPRS) S PSONEW("IDFLG")=1 ;user deleted all in finish/complete order
"RTN","PSODIAG",92,0)
 Q:(RAR="PSONEW")
"RTN","PSODIAG",93,0)
 I '$D(@RAR@("ICD"))&('CPRS)&($D(^PSRX(PSOX("IRXN"),"ICD",1,0))) S PSORXED("IDFLG")=1  ;user deleted all
"RTN","PSODIAG",94,0)
 Q
"RTN","PSODIAG",95,0)
 ;
"RTN","PSODIAG",96,0)
 ;called from above to write previously entered ICD's to screen.
"RTN","PSODIAG",97,0)
WRITE S J=I-1 I I=1 W !,?10,"Primary: ",OLD(I),?30,$P($$ICDDX^ICDCODE(OLD(I),FILDAT),U,4) Q
"RTN","PSODIAG",98,0)
WRITE2 I I=2 W !,?3,"Secondaries #"_J_": ",OLD(I),?30,$P($$ICDDX^ICDCODE(OLD(I),FILDAT),U,4) Q
"RTN","PSODIAG",99,0)
 I I>2 W !,?15,"#"_J_": ",OLD(I),?30,$P($$ICDDX^ICDCODE(OLD(I),FILDAT),U,4)
"RTN","PSODIAG",100,0)
 Q
"RTN","PSODIAG",101,0)
STATCHK(ICDIEN,FILDAT) ;called from above to check active/inactive date during FileMan call.
"RTN","PSODIAG",102,0)
 N X S X=""
"RTN","PSODIAG",103,0)
 S ICDIEN=$P(^ICD9(ICDIEN,0),"^",1) S X=$$STATCHK^ICDAPIU(ICDIEN,FILDAT)
"RTN","PSODIAG",104,0)
 Q +X
"RTN","PSODIAG",105,0)
DELETE ;called from above to verify delete with user and to delete said entries
"RTN","PSODIAG",106,0)
 W !,"SURE YOU WANT TO DELETE? " S X="" R X:30 S X=$TR(X,"yn","YN")
"RTN","PSODIAG",107,0)
 I X'="Y"&(X'="N") W !,"Enter Y or N" G DELETE
"RTN","PSODIAG",108,0)
 I X="N" S I=I-1 Q
"RTN","PSODIAG",109,0)
 F J=I:1:8 Q:'$D(OLDI(J))  D
"RTN","PSODIAG",110,0)
 . I $D(OLDI(J+1)) S OLDI(J)=OLDI(J+1),OLD(J)=OLD(J+1) D
"RTN","PSODIAG",111,0)
 .. I CPRS&($D(PSONEW("ICD",J+1))) S PSONEW("ICD",J)=PSONEW("ICD",J+1)
"RTN","PSODIAG",112,0)
 .. E  I CPRS&('$D(PSONEW("ICD",J+1))) S PSONEW("ICD",J)=OLDI(J+1)
"RTN","PSODIAG",113,0)
 .. I $G(PSOCOPY) D
"RTN","PSODIAG",114,0)
 ... I ($D(PSONEW("ICD",J+1))) S PSONEW("ICD",J)=PSONEW("ICD",J+1)
"RTN","PSODIAG",115,0)
 ... I ($D(PSORXED("ICD",J+1))) S PSORXED("ICD",J)=PSORXED("ICD",J+1)
"RTN","PSODIAG",116,0)
 . E  K OLD(J),OLDI(J),PSONEW("ICD",J),PSORXED("ICD",J)
"RTN","PSODIAG",117,0)
 . ;I CPRS!($G(PSOCOPY)) K PSONEW("ICD",J),PSORXED("ICD",J)
"RTN","PSODIAG",118,0)
 S I=I-1,(X,Y)=""
"RTN","PSODIAG",119,0)
 Q
"RTN","PSODIAG",120,0)
 ;
"RTN","PSODIAG",121,0)
ICD ;called from PSON52 cause PSON52'S too large.  Stores ICD info for new Rx's (CPRS and backdoor) using variables from copy function and new order functions.
"RTN","PSODIAG",122,0)
 N D,DDATA,ICD,II
"RTN","PSODIAG",123,0)
 I $G(PSOCOPY)&('$D(PSOX("ICD")))&('$G(PSOICDD)) D
"RTN","PSODIAG",124,0)
 . S D=0 F D=1:1 Q:'$D(PSOX("ICD",D))
"RTN","PSODIAG",125,0)
 . F D=D:1:8 K ^PSRX(PSOX("IRXN"),"ICD",D,0)  ;remove any icd's del
"RTN","PSODIAG",126,0)
 . I $D(^PSRX(PSOX("OIRXN"),"ICD",0)) F D=1:1:8 Q:'$D(^PSRX(PSOX("OIRXN"),"ICD",D,0))  S PSOX("ICD",D)=$P(^PSRX(PSOX("OIRXN"),"ICD",D,0),U,1)
"RTN","PSODIAG",127,0)
 I $G(ORD) I $D(^PS(52.41,ORD,0))&($D(PSORX("ICD"))) M PSOX("ICD")=PSONEW("ICD")
"RTN","PSODIAG",128,0)
 I $D(PSOX("ICD")) F D=1:1:8 Q:'$D(PSOX("ICD",D))  S ICD=$G(PSOX("ICD",D)) D
"RTN","PSODIAG",129,0)
 . S DDATA="",DDATA=ICD_"^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$S(PSOSCP>49:$G(PSOANSQ("SC>50")),PSOSCP<50&(PSOSCP'=""):$G(PSOANSQ("SC")),1:"")_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))
"RTN","PSODIAG",130,0)
 . I $P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1 I PSOSCP<50&($D(PSOANSQ("SC>50"))) S $P(DDATA,"^",4)=PSOANSQ("SC>50")  ;for times when sc has no % defined.
"RTN","PSODIAG",131,0)
 . S ^PSRX(PSOX("IRXN"),"ICD",D,0)=DDATA,II=D
"RTN","PSODIAG",132,0)
 E  S D=1 D
"RTN","PSODIAG",133,0)
 . S DDATA="",DDATA="^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$S(PSOSCP>49:$G(PSOANSQ("SC>50")),PSOSCP<50&(PSOSCP'=""):$G(PSOANSQ("SC")),1:"")
"RTN","PSODIAG",134,0)
 . S DDATA=DDATA_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))
"RTN","PSODIAG",135,0)
 . S ^PSRX(PSOX("IRXN"),"ICD",D,0)=DDATA,II=D
"RTN","PSODIAG",136,0)
 . I $P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1 I PSOSCP<50&($D(PSOANSQ("SC>50"))) S $P(^PSRX(PSOX("IRXN"),"ICD",D,0),"^",4)=PSOANSQ("SC>50")
"RTN","PSODIAG",137,0)
 S ^PSRX(PSOX("IRXN"),"ICD",0)="^52.052311P^"_II_"^"_II
"RTN","PSODIAG",138,0)
 K PSOX("ICD"),PSORXED("ICD"),PSONEW("ICD"),PSORX("ICD")
"RTN","PSODIAG",139,0)
 Q
"RTN","PSODIAG",140,0)
 ;
"RTN","PSODIAG",141,0)
UPDATE ;was in PSOORED6; now called from PSOORED6; removes deletes for edits and stores data.
"RTN","PSODIAG",142,0)
 ;
"RTN","PSODIAG",143,0)
 N TNEW,DA,DIK,SCEI,I,II
"RTN","PSODIAG",144,0)
 S DA=PSORXED("IRXN")
"RTN","PSODIAG",145,0)
 I '$D(PSORXED("ICD"))&($G(PSORXED("IDFLG"))) D  K PSORXED("IDFLG") Q
"RTN","PSODIAG",146,0)
 . I $D(^PSRX(PSORXED("IRXN"),"ICD",1,0)) D
"RTN","PSODIAG",147,0)
 .. S TNEW=2 K ^PSRX(PSORXED("IRXN"),"ICD","B") S $P(^PSRX(PSORXED("IRXN"),"ICD",1,0),U,1)=""
"RTN","PSODIAG",148,0)
 .. F I=TNEW:1:8 Q:'$D(^PSRX(PSORXED("IRXN"),"ICD",I,0))  S DIK="^PSRX("_PSORXED("IRXN")_","_$C(34)_"ICD"_$C(34)_",",DA=I,DA(1)=PSORXED("IRXN") D ^DIK K DA,DIK
"RTN","PSODIAG",149,0)
 ;
"RTN","PSODIAG",150,0)
 I $D(PSORXED("ICD")) D
"RTN","PSODIAG",151,0)
 . S SCEI=$G(^PSRX(DA,"ICD",1,0)),$P(SCEI,"^")=""
"RTN","PSODIAG",152,0)
 . K ^PSRX(DA,"ICD")
"RTN","PSODIAG",153,0)
 . F I=1:1:8 Q:'$D(PSORXED("ICD",I))  S $P(SCEI,"^")=PSORXED("ICD",I),^PSRX(DA,"ICD",I,0)=SCEI,^PSRX(DA,"ICD","B",$P(SCEI,"^"),I)="",II=I
"RTN","PSODIAG",154,0)
 . S ^PSRX(DA,"ICD",0)="^52.052311P^"_II_U_II
"RTN","PSODIAG",155,0)
 Q
"RTN","PSODIAG",156,0)
 ;
"RTN","PSODIAG",157,0)
CSET ;Called from PSOHLNEW due to it's routine size.  Requires PSOICD & PENDING variable.  Sets ICD node for orders passed from CPRS.
"RTN","PSODIAG",158,0)
 N EE,EEE
"RTN","PSODIAG",159,0)
 S (EE,EEE)=0 F  S EE=$O(PSOICD(EE)) Q:EE=""  D
"RTN","PSODIAG",160,0)
 .S EEE=EEE+1,^PS(52.41,PENDING,"ICD",EEE,0)=PSOICD(EE) S:$P(PSOICD(EE),"^")'="" ^PS(52.41,PENDING,"ICD","B",$P(PSOICD(EE),"^"),EEE)=""
"RTN","PSODIAG",161,0)
 .S ^PS(52.41,PENDING,"ICD",0)="^52.41311PA"_U_EEE_U_EEE
"RTN","PSODIAG",162,0)
 Q
"RTN","PSOHLNE1")
0^14^B72518246^B72765875
"RTN","PSOHLNE1",1,0)
PSOHLNE1 ;BIR/RTR-Parsing out segments from OERR ;01/20/95
"RTN","PSOHLNE1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,9,46,71,98,111,117,131,157,181,143,235,239**;DEC 1997
"RTN","PSOHLNE1",3,0)
 ;External reference to EN^ORERR supported by DBIA 2187
"RTN","PSOHLNE1",4,0)
 ;External reference to PS(50.607 supported by DBIA 2221
"RTN","PSOHLNE1",5,0)
 ;External reference to OR(100 supported by DBIA 2219
"RTN","PSOHLNE1",6,0)
 ;External reference to PSDRUG( supported by DBIA 221
"RTN","PSOHLNE1",7,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSOHLNE1",8,0)
 ;
"RTN","PSOHLNE1",9,0)
EN ;ORC segment
"RTN","PSOHLNE1",10,0)
 N Q1,Q2,Q3,Q4,Q5,Q6,Q7,PSOPOSSD
"RTN","PSOHLNE1",11,0)
 K PSOLQ1I,PSOLQ1II,PSOLQ1IX
"RTN","PSOHLNE1",12,0)
 I '$O(MSG(ZZ,0)) D
"RTN","PSOHLNE1",13,0)
 .S PSOOC="NW",PLACER=+$P(PSOSEG,"|",2),PLACERXX=+$P($P(PSOSEG,"|",2),";",2),ENTERED=$P(PSOSEG,"|",10),PROV=$P(PSOSEG,"|",12)
"RTN","PSOHLNE1",14,0)
 .S X=$P(PSOSEG,"|",15) S EFFECT=$$HL7TFM^XLFDT(X) K X
"RTN","PSOHLNE1",15,0)
 .D NOW^%DTC S PSOLOG=% K %
"RTN","PSOHLNE1",16,0)
 .;S RSN=$P(PSOSEG,"|",16)
"RTN","PSOHLNE1",17,0)
 .S ORCSEG=$P(PSOSEG,"|",7),QCOUNT=1 Q:$G(ORCSEG)'["~"
"RTN","PSOHLNE1",18,0)
 .F JJ=1:1:$L(ORCSEG) S:$E(ORCSEG,JJ)="~" QCOUNT=QCOUNT+1
"RTN","PSOHLNE1",19,0)
 I '$O(MSG(ZZ,0)) D  Q
"RTN","PSOHLNE1",20,0)
 .F JJJ=1:1:QCOUNT S QQQ=$P(ORCSEG,"~",JJJ) D:QQQ'=""
"RTN","PSOHLNE1",21,0)
 ..S PSOPOSSD=$S($P($P(QQQ,"^"),"&"):1,1:0) ;PSOPOSSD=1 if possible dose
"RTN","PSOHLNE1",22,0)
 ..S Q1I(JJJ)=$S(PSOPOSSD:$P(QQQ,"^"),1:$P(QQQ,"^",8)),PSOLQ1IX(JJJ)=$P($P(QQQ,"^"),"&",5) S PSOLQ1I(JJJ)=$P(QQQ,"^",8),PSOLQ1II(JJJ)=PSOPOSSD ;ORC piece 1 if Possible Dosage, ORC piece 8 if Local Possible Dosage
"RTN","PSOHLNE1",23,0)
 ..S Q1(JJJ)=$P(QQQ,"^",2) ;schedule
"RTN","PSOHLNE1",24,0)
 ..S Q2(JJJ)=$P(QQQ,"^",3) ;duration
"RTN","PSOHLNE1",25,0)
 ..S Q3(JJJ)=$P(QQQ,"^",4) I Q3(JJJ) S X=Q3(JJJ) S Q3(JJJ)=$$HL7TFM^XLFDT(X) K X ;start date
"RTN","PSOHLNE1",26,0)
 ..S Q4(JJJ)=$P(QQQ,"^",5) ;end date
"RTN","PSOHLNE1",27,0)
 ..S:$G(PRIOR)="" PRIOR=$P(QQQ,"^",6)
"RTN","PSOHLNE1",28,0)
 ..S Q6(JJJ)=$P(QQQ,"^",9) ;conjunction
"RTN","PSOHLNE1",29,0)
 ..S Q7(JJJ)=$P(QQQ,"^",10) ;sequencing
"RTN","PSOHLNE1",30,0)
 ..S QTARRAY(JJJ)=Q1(JJJ)_"^"_Q2(JJJ)_"^"_Q3(JJJ)_"^"_Q4(JJJ)_"^^"_Q6(JJJ)_"^"_Q7(JJJ)
"RTN","PSOHLNE1",31,0)
 ..S QTARRAY2(JJJ)=$S(PSOPOSSD:$P(Q1I(JJJ),"&"),1:Q1I(JJJ))_"^"_$S(PSOPOSSD:$P(Q1I(JJJ),"&",3),1:"")
"RTN","PSOHLNE1",32,0)
 ..I PSOPOSSD S $P(QTARRAY(JJJ),"^",5)=$P(Q1I(JJJ),"&",4)
"RTN","PSOHLNE1",33,0)
 ..I PSOPOSSD S PSOUNN=$P(Q1I(JJJ),"&",2) I PSOUNN'="" S PSOUNN=$O(^PS(50.607,"B",PSOUNN,0)) S $P(QTARRAY(JJJ),"^",9)=$G(PSOUNN)
"RTN","PSOHLNE1",34,0)
 ..K PSOUNN
"RTN","PSOHLNE1",35,0)
 ;For multiple ORC subscripts
"RTN","PSOHLNE1",36,0)
 S (POVAR,POVAR1)="",(NNCK,NNN,NNNN)=0,PSOIII=1,MSG(ZZ,0)=$E(MSG(ZZ),5,$L(MSG(ZZ)))
"RTN","PSOHLNE1",37,0)
 S AAA="" F  S AAA=$O(MSG(ZZ,AAA)) Q:AAA=""  S NNN=0 F OOO=1:1:$L(MSG(ZZ,AAA)) S NNN=NNN+1 D  D:$G(POVAR1)="~"&(NNNN=6) PARSE D:$G(POVAR1)="|" PARSE
"RTN","PSOHLNE1",38,0)
 .I $E(MSG(ZZ,AAA),OOO)="|" S NNNN=NNNN+1
"RTN","PSOHLNE1",39,0)
 .S POVAR1=$E(MSG(ZZ,AAA),OOO)
"RTN","PSOHLNE1",40,0)
 .S POLIM=POVAR
"RTN","PSOHLNE1",41,0)
 .S POVAR=$S(POVAR="":POVAR1,1:POVAR_POVAR1)
"RTN","PSOHLNE1",42,0)
 .;I NNNN=6 I $G(POVAR1)="~"!($G(POVAR1)="|")
"RTN","PSOHLNE1",43,0)
END ;16 OF ORC?
"RTN","PSOHLNE1",44,0)
 ;I $G(POVAR)'="" I NNNN=14!(NNNN=15) S EFFECT=$G(POVAR)
"RTN","PSOHLNE1",45,0)
 S QCOUNT=0 F JJJ=0:0 S JJJ=$O(QTVAR(JJJ)) Q:'JJJ  I $L($G(QTVAR(JJJ))) S QCOUNT=QCOUNT+1 D
"RTN","PSOHLNE1",46,0)
 .S PSOPOSSD=$S($P($P(QTVAR(JJJ),"^"),"&"):1,1:0) ;PSOPOSSD =1 if possible dose
"RTN","PSOHLNE1",47,0)
 .S Q1I(JJJ)=$S(PSOPOSSD:$P(QTVAR(JJJ),"^"),1:$P(QTVAR(JJJ),"^",8)),PSOLQ1IX(JJJ)=$P($P(QTVAR(JJJ),"^"),"&",5) S PSOLQ1I(JJJ)=$P(QTVAR(JJJ),"^",8),PSOLQ1II(JJJ)=PSOPOSSD ;piece 1 if possible dose, piece 8 if not
"RTN","PSOHLNE1",48,0)
 .S Q1(JJJ)=$P(QTVAR(JJJ),"^",2)
"RTN","PSOHLNE1",49,0)
 .S Q2(JJJ)=$P(QTVAR(JJJ),"^",3)
"RTN","PSOHLNE1",50,0)
 .;S Q2(JJJ)=$S($E($P(QTVAR(JJJ),"^",3)):"D"_$P(QTVAR(JJJ),"^",3),$E($P(QTVAR(JJJ),"^",3))=0:"D"_$P(QTVAR(JJJ),"^",3),1:$P(QTVAR(JJJ),"^",3))
"RTN","PSOHLNE1",51,0)
 .S Q3(JJJ)=$P(QTVAR(JJJ),"^",4) I Q3(JJJ) S X=Q3(JJJ) S Q3(JJJ)=$$HL7TFM^XLFDT(X) K X
"RTN","PSOHLNE1",52,0)
 .S Q4(JJJ)=$P(QTVAR(JJJ),"^",5)
"RTN","PSOHLNE1",53,0)
 .S:$G(PRIOR)="" PRIOR=$P(QTVAR(JJJ),"^",6)
"RTN","PSOHLNE1",54,0)
 .S Q6(JJJ)=$P(QTVAR(JJJ),"^",9)
"RTN","PSOHLNE1",55,0)
 .S Q7(JJJ)=$P(QTVAR(JJJ),"^",10)
"RTN","PSOHLNE1",56,0)
 .S QTARRAY(JJJ)=Q1(JJJ)_"^"_Q2(JJJ)_"^"_Q3(JJJ)_"^"_Q4(JJJ)_"^^"_Q6(JJJ)_"^"_Q7(JJJ)
"RTN","PSOHLNE1",57,0)
 .S QTARRAY2(JJJ)=$S(PSOPOSSD:$P(Q1I(JJJ),"&"),1:Q1I(JJJ))_"^"_$S(PSOPOSSD:$P(Q1I(JJJ),"&",3),1:"")
"RTN","PSOHLNE1",58,0)
 .I PSOPOSSD S $P(QTARRAY(JJJ),"^",5)=$P(Q1I(JJJ),"&",4)
"RTN","PSOHLNE1",59,0)
 .I PSOPOSSD S PSOUNN=$P(Q1I(JJJ),"&",2) I PSOUNN'="" S PSOUNN=$O(^PS(50.607,"B",PSOUNN,0)) S $P(QTARRAY(JJJ),"^",9)=$G(PSOUNN)
"RTN","PSOHLNE1",60,0)
 .K PSOUNN
"RTN","PSOHLNE1",61,0)
 I $G(EFFECT) S X=EFFECT S EFFECT=$$HL7TFM^XLFDT(X) K X
"RTN","PSOHLNE1",62,0)
 D NOW^%DTC S PSOLOG=% S:'$G(EFFECT) EFFECT=% K %
"RTN","PSOHLNE1",63,0)
 K MSG(ZZ,0)
"RTN","PSOHLNE1",64,0)
 Q
"RTN","PSOHLNE1",65,0)
PARSE I NNNN=1 S PSOOC="NW" G SET
"RTN","PSOHLNE1",66,0)
 I NNNN=2 S PLACER=+$G(POLIM),PLACERXX=+$P($G(POLIM),";",2) G SET
"RTN","PSOHLNE1",67,0)
 I NNNN=3!(NNNN=4)!(NNNN=5) G SET
"RTN","PSOHLNE1",68,0)
 I NNNN=6,$G(POVAR1)="~" S NNCK=NNCK+1,QTVAR(NNCK)=$G(POLIM) G SET
"RTN","PSOHLNE1",69,0)
 I NNNN=7 S NNCK=NNCK+1 S QTVAR(NNCK)=$G(POLIM) G SET
"RTN","PSOHLNE1",70,0)
 I NNNN=8!(NNNN=9) G SET
"RTN","PSOHLNE1",71,0)
 I NNNN=10 S ENTERED=$G(POLIM) G SET
"RTN","PSOHLNE1",72,0)
 I NNNN=11 G SET
"RTN","PSOHLNE1",73,0)
 I NNNN=12 S PROV=$G(POLIM) G SET
"RTN","PSOHLNE1",74,0)
 I NNNN=13!(NNNN=14) G SET
"RTN","PSOHLNE1",75,0)
 I NNNN=15 S EFFECT=$G(POLIM)
"RTN","PSOHLNE1",76,0)
SET S (POVAR,POLIM)="" Q
"RTN","PSOHLNE1",77,0)
 ;
"RTN","PSOHLNE1",78,0)
EXP ;
"RTN","PSOHLNE1",79,0)
 ;Q:'$G(OR("PLACE"))
"RTN","PSOHLNE1",80,0)
 Q:'$G(PSOFILNM)
"RTN","PSOHLNE1",81,0)
 S PSOMSORR=1
"RTN","PSOHLNE1",82,0)
 N PSOSSMES S PSOSSMES="CPRSUP"
"RTN","PSOHLNE1",83,0)
 I $G(PSOFILNM),$G(PSOFILNM)["S" S LL=+$G(PSOFILNM) I $D(^PS(52.41,LL,0)),$P($G(^(0)),"^",3)'="RF" G EXPEN
"RTN","PSOHLNE1",84,0)
 S LL=$G(PSOFILNM) I 'LL!('$D(^PSRX(+$G(LL),0))) S COMM="Order was not located by Pharmacy" D EN^ORERR(COMM,.MSG) D  G EXPQ
"RTN","PSOHLNE1",85,0)
 .F EER=0:0 S EER=$O(MSG(EER)) Q:'EER  S:$P(MSG(EER),"|")="PV1" PSERRPV1=MSG(EER) S:$P(MSG(EER),"|")="PID" PSERRPID=MSG(EER) S:$P(MSG(EER),"|")="ORC"&($G(PSERRORC)="") PSERRORC=MSG(EER)
"RTN","PSOHLNE1",86,0)
 .N MSG,PSOHINST D INIT^PSOHLSN S MSG(2)=$G(PSERRPID),MSG(3)=$G(PSERRPV1),MSG(4)="ORC|DE|"_$G(OR("PLACE"))_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"_"|"_$S($P($G(PSERRORC),"|",4)'="":$P(PSERRORC,"|",4),1:"") S:$G(COMM)'="" MSG(5)="NTE|16||"_COMM
"RTN","PSOHLNE1",87,0)
 .D SEND^PSOHLSN
"RTN","PSOHLNE1",88,0)
 Q:'$D(^PSRX(LL,0))
"RTN","PSOHLNE1",89,0)
 I +$P($G(^PSRX(LL,2)),"^",6)<DT D
"RTN","PSOHLNE1",90,0)
 .;Reset PSOSSMES if status changes, so HDR gets updated in PSOHLSN1
"RTN","PSOHLNE1",91,0)
 .I +$P($G(^PSRX(LL,"STA")),"^")<12!($P($G(^("STA")),"^")=16) S $P(^PSRX(LL,"STA"),"^")=11 D ECAN^PSOUTL(LL) S PSOSSMES="CPRSVDEF"
"RTN","PSOHLNE1",92,0)
 S GG=+$P($G(^PSRX(LL,"STA")),"^")
"RTN","PSOHLNE1",93,0)
 ;S AA=$S(GG=3:"OH",GG=12:"OD",GG=13:"OC",GG=14:"OD",GG=15:"OD",GG=16:"OH",1:"SC"),AAA=$S(GG=0:"CM",GG=1:"IP",GG=4:"IP",GG=5:"ZS",GG=11:"ZE",1:"")
"RTN","PSOHLNE1",94,0)
 S AA="SC",AAA=$S(GG=0:"CM",GG=2:"CM",GG=1:"IP",GG=4:"IP",GG=5:"ZS",GG=3:"HD",GG=16:"HD",GG=11:"ZE",1:"DC")
"RTN","PSOHLNE1",95,0)
 D EN^PSOHLSN1(LL,AA,AAA,"")
"RTN","PSOHLNE1",96,0)
 K PSOSSMES
"RTN","PSOHLNE1",97,0)
EXPQ K LL,GG,AA,AAA,PSOMSORR Q
"RTN","PSOHLNE1",98,0)
EXPEN ;SS on Pending orders
"RTN","PSOHLNE1",99,0)
 S AA=$P($G(^PS(52.41,LL,0)),"^",3)
"RTN","PSOHLNE1",100,0)
 S AAA=$S(AA="DC"!(AA="DE"):"DC",AA="HD":"HD",1:"IP")
"RTN","PSOHLNE1",101,0)
 D EN^PSOHLSN(OR("PLACE"),"SC",AAA)
"RTN","PSOHLNE1",102,0)
 G EXPQ
"RTN","PSOHLNE1",103,0)
 ;
"RTN","PSOHLNE1",104,0)
OID ;Check for 1 to 1 match from Dispense Drug to Orderable Item
"RTN","PSOHLNE1",105,0)
 N PSOCDD,PSOCDDI,PSOCDDIZ
"RTN","PSOHLNE1",106,0)
 Q:'$G(PSORDITE)
"RTN","PSOHLNE1",107,0)
 K PSOCDDIZ
"RTN","PSOHLNE1",108,0)
 S (PSOCDD,PSOCDDI)=0
"RTN","PSOHLNE1",109,0)
 F  S PSOCDD=$O(^PSDRUG("ASP",PSORDITE,PSOCDD)) Q:'PSOCDD  I $S('$P($G(^PSDRUG(PSOCDD,"I")),"^"):1,DT'>$P($G(^("I")),"^"):1,1:0),$P($G(^PSDRUG(PSOCDD,2)),"^",3)["O" S PSOCDDI=PSOCDDI+1,PSOCDDIZ=PSOCDD
"RTN","PSOHLNE1",110,0)
 I PSOCDDI'=1 Q
"RTN","PSOHLNE1",111,0)
 S PSOQWX=$G(PSOCDDIZ)
"RTN","PSOHLNE1",112,0)
 Q
"RTN","PSOHLNE1",113,0)
CP ;ZSC segment (replaced by ZCL segment)
"RTN","PSOHLNE1",114,0)
 S SERV=$S($P(PSOSEG,"|")=1:"SC",$P(PSOSEG,"|")=0:"NSC",1:$P(PSOSEG,"|"))
"RTN","PSOHLNE1",115,0)
 S PSOIBY=$P(PSOSEG,"|",2)_"^"_$P(PSOSEG,"|",3)_"^"_$P(PSOSEG,"|",4)_"^"_$P(PSOSEG,"|",5)_"^"_$P(PSOSEG,"|",6)_"^"_$P(PSOSEG,"|",7)
"RTN","PSOHLNE1",116,0)
 Q
"RTN","PSOHLNE1",117,0)
 ;
"RTN","PSOHLNE1",118,0)
ZCL ;ZCL segment - SC/EI related to ICDs
"RTN","PSOHLNE1",119,0)
 N SEQ,SEQ2,SEQ3 S SEQ3=$P(PSOSEG,"|",2),SEQ2=$P(PSOSEG,"|",1)
"RTN","PSOHLNE1",120,0)
 S:'$D(PSOICD(SEQ2)) PSOICD(SEQ2)=""
"RTN","PSOHLNE1",121,0)
 S $P(PSOICD(SEQ2),"^",(SEQ3+1))=$P(PSOSEG,"|",3)  ;set sc/ei for ICD node
"RTN","PSOHLNE1",122,0)
 D SCP^PSORN52D K PSOSCA
"RTN","PSOHLNE1",123,0)
 S:'$D(PSOIBY) PSOIBY=""
"RTN","PSOHLNE1",124,0)
 I PSOSCP<50 D  ;set IBQ node variables if <50% SC
"RTN","PSOHLNE1",125,0)
 . Q:$P(PSOIBY,U,$S(SEQ3=1:2,SEQ3=2:3,SEQ3=4:4,SEQ3=5:1,SEQ3=6:5,SEQ3=7:6,1:""))>0
"RTN","PSOHLNE1",126,0)
 . S:SEQ3=1 $P(PSOIBY,U,2)=$P(PSOSEG,"|",3) ;AO
"RTN","PSOHLNE1",127,0)
 . S:SEQ3=2 $P(PSOIBY,U,3)=$P(PSOSEG,"|",3) ;IR
"RTN","PSOHLNE1",128,0)
 . S:SEQ3=3 SERV=$S($P(PSOSEG,"|",3)=1:"SC",$P(PSOSEG,"|",3)=0:"NSC",1:$P(PSOSEG,"|",3))           ;SC
"RTN","PSOHLNE1",129,0)
 . S:SEQ3=4 $P(PSOIBY,U,4)=$P(PSOSEG,"|",3) ;EC
"RTN","PSOHLNE1",130,0)
 . S:SEQ3=5 $P(PSOIBY,U,1)=$P(PSOSEG,"|",3) ;MST
"RTN","PSOHLNE1",131,0)
 . S:SEQ3=6 $P(PSOIBY,U,5)=$P(PSOSEG,"|",3) ;HNC
"RTN","PSOHLNE1",132,0)
 . S:SEQ3=7 $P(PSOIBY,U,6)=$P(PSOSEG,"|",3) ;CV
"RTN","PSOHLNE1",133,0)
 ;E  D
"RTN","PSOHLNE1",134,0)
 ;. S PSOIBY="^^^^^^",SERV=""
"RTN","PSOHLNE1",135,0)
 Q
"RTN","PSOHLNE1",136,0)
MISX ;Mismatch patient on CPRS New Order
"RTN","PSOHLNE1",137,0)
 S RCOMM="Patient mismatch on New Order from CPRS." D EN^ORERR(RCOMM,.MSG) S NWFLAG=1 D RERROR^PSOHLSN D KL^PSOHLSIH
"RTN","PSOHLNE1",138,0)
 Q
"RTN","PSOHLNE1",139,0)
MISRN ;Mismatch on CPRS renewal
"RTN","PSOHLNE1",140,0)
 N PSOCINV
"RTN","PSOHLNE1",141,0)
 I $G(PDFN)'=$P($G(^PSRX(+$G(PREV),0)),"^",2) D  S PSOMO=1 Q
"RTN","PSOHLNE1",142,0)
 .S RCOMM="Patient mismatch on CPRS Renewal." D EN^ORERR(RCOMM,.MSG) S PSOXRP=1 D RERROR^PSOHLSN D KL^PSOHLSIH
"RTN","PSOHLNE1",143,0)
 S PSOCINV=+$P($G(^OR(100,+$G(PLACER),3)),"^",5)
"RTN","PSOHLNE1",144,0)
 I PSOCINV'=$P($G(^PSRX(+$G(PREV),"OR1")),"^",2) D  S PSOMO=1 Q
"RTN","PSOHLNE1",145,0)
 .S RCOMM="Order mismatch on CPRS Renewal." D EN^ORERR(RCOMM,.MSG) S PSOCVI=1 D RERROR^PSOHLSN D KL^PSOHLSIH
"RTN","PSOHLNE1",146,0)
 Q
"RTN","PSOHLNE1",147,0)
ZRX ;Process ZRX segment
"RTN","PSOHLNE1",148,0)
 I $P(PSOSEG,"|",3)="R" S PSOOC="RNW",PSRNFLAG=1
"RTN","PSOHLNE1",149,0)
 S PREV=$S(+$P(PSOSEG,"|"):+$P(PSOSEG,"|"),1:"")
"RTN","PSOHLNE1",150,0)
 I $P(PSOSEG,"|")["P"!($P(PSOSEG,"|")["S") S PFLAG=1
"RTN","PSOHLNE1",151,0)
 S NATURE=$P(PSOSEG,"|",2)
"RTN","PSOHLNE1",152,0)
 S PSORSO=$P(PSOSEG,"|",3)
"RTN","PSOHLNE1",153,0)
 S ROUTING=$P(PSOSEG,"|",4)
"RTN","PSOHLNE1",154,0)
 I ROUTING="" S ROUTING="M"
"RTN","PSOHLNE1",155,0)
 I $P(PSOSEG,"|",7) S DSIG=1
"RTN","PSOHLNE1",156,0)
 Q
"RTN","PSOHLNE1",157,0)
CHCS ;Replace CHCS number with CPRS number in .01 field
"RTN","PSOHLNE1",158,0)
 N PSOHTMP
"RTN","PSOHLNE1",159,0)
 I $G(PDFN),PDFN'=+$P($G(^PS(52.41,+$G(PSOCHFFL),0)),"^",2) S COMM="Patient does not match" D EN^ORERR(COMM,.MSG) K PSOPLC,PSOFFL,PSOSND Q
"RTN","PSOHLNE1",160,0)
 I '$D(^PS(52.41,+$G(PSOCHFFL),0)) S COMM="Order was not located by Pharmacy" D EN^ORERR(COMM,.MSG) K PSOPLC,PSOFFL,PSOSND Q
"RTN","PSOHLNE1",161,0)
 S PSOHTMP=$P($G(^PS(52.41,+$G(PSOCHFFL),0)),"^")
"RTN","PSOHLNE1",162,0)
 I PSOHTMP'="" K ^PS(52.41,"B",PSOHTMP,+$G(PSOCHFFL))
"RTN","PSOHLNE1",163,0)
 S $P(^PS(52.41,+$G(PSOCHFFL),0),"^")=PSOPLC,^PS(52.41,"B",PSOPLC,+$G(PSOCHFFL))=""
"RTN","PSOHLNE1",164,0)
 S $P(^PS(52.41,+$G(PSOCHFFL),"EXT"),"^",2)=1
"RTN","PSOHLNE1",165,0)
 Q
"RTN","PSOHLNE1",166,0)
CNT ;
"RTN","PSOHLNE1",167,0)
 S TAC=0 F TACA=0:0 S TACA=$O(^PSRX(PREV,"A",TACA)) Q:'TACA  S TAC=TACA
"RTN","PSOHLNE1",168,0)
 S PAC=0 F PACA=0:0 S PACA=$O(^PSRX(PREV,1,PACA)) Q:'PACA  S PAC=PACA
"RTN","PSOHLNE1",169,0)
 D NOW^%DTC S TAC=TAC+1,^PSRX(PREV,"A",0)="^52.3DA^"_TAC_"^"_TAC,^PSRX(PREV,"A",TAC,0)=%_"^"_"C"_"^"_$S(+$G(PROV):$G(PROV),1:+$G(ENTERED))_"^"_PAC_"^"_"Discontinued due to CPRS edit"
"RTN","PSOHLNE1",170,0)
 K TAC,PAC,TACA,PACA
"RTN","PSOHLNE1",171,0)
 Q
"RTN","PSOHLNE1",172,0)
NTE ;
"RTN","PSOHLNE1",173,0)
 S WPCT=1,WORDP=$S($P(MSG(LL),"|",2):$P(MSG(LL),"|",2),1:$P(MSG(LL),"|",3)) S:$P(MSG(LL),"|",4)'="" WPARRAY(WORDP,WPCT)=$P(MSG(LL),"|",4) S:$P(MSG(LL),"|",4)'="" WPCT=WPCT+1 F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNE1",174,0)
 .I $G(MSG(LL,LLL))'="" S WPARRAY(WORDP,WPCT)=$G(MSG(LL,LLL)),WPCT=WPCT+1
"RTN","PSOHLNE1",175,0)
 Q
"RTN","PSOHLNE3")
0^11^B55635403^B58436703
"RTN","PSOHLNE3",1,0)
PSOHLNE3 ;BIR/LE - Process Edit Information from CPRS ;02/27/04
"RTN","PSOHLNE3",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,239**;DEC 1997
"RTN","PSOHLNE3",3,0)
 ;External reference to ^OR(100 private DBIA 2219
"RTN","PSOHLNE3",4,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSOHLNE3",5,0)
 ;This API is used to update the prescription file when ICD-9 diagnosis and SC/EI's are updated as a result of an e-sig in CPRS.  
"RTN","PSOHLNE3",6,0)
 ;
"RTN","PSOHLNE3",7,0)
EN(DFN,ORITEM,ORIEN,ORDX,ORSCEI) ;DBIA 4666
"RTN","PSOHLNE3",8,0)
 ;DFN = Patient IEN
"RTN","PSOHLNE3",9,0)
 ;ORITEM = Package reference number from file 100
"RTN","PSOHLNE3",10,0)
 ;ORIEN = ien from file 100
"RTN","PSOHLNE3",11,0)
 ;ORDX(1)= (pointer to file 80) up to 8 accepted and first is primary ICD
"RTN","PSOHLNE3",12,0)
 ;ORDX(2)= (pointer to file 80)
"RTN","PSOHLNE3",13,0)
 ;ORSCEI=  seven pieces - where 1=yes, 0=no, null or ? =not asked
"RTN","PSOHLNE3",14,0)
 ;ORSCEI=AO^IR^SC^EC^MST^HNC^CV
"RTN","PSOHLNE3",15,0)
 N DX,DX2,DX3,RXN,PSOSCP,PSOX,ORDPROV,PSOSCP2,DA,RET,PSOANSQ,PSORX,PTSTATUS,ARRAY,PSOOI,ORITEM2,ORID,OICHK,PSORENW
"RTN","PSOHLNE3",16,0)
 N PSODCPY,PSONEW,PSOOIBQ,PSOFLD,PSODCZ,PSOSTAZ,PREA,PSOPIBQ,PSOIBQC,PSOSCA,PSOPICD,PSOCICD,PSODGUP,PSOOICD
"RTN","PSOHLNE3",17,0)
 N PSODD,PSOSI
"RTN","PSOHLNE3",18,0)
 S:'$D(ORIEN) ORIEN="" S:'$D(ORSCEI) ORSCEI="" S:'$D(ORITEM) ORITEM=""
"RTN","PSOHLNE3",19,0)
 ;
"RTN","PSOHLNE3",20,0)
 ;validate prescription IEN with DFN, ord item, and placer#
"RTN","PSOHLNE3",21,0)
 S RET=1,PSODCZ=",12,14,15,"
"RTN","PSOHLNE3",22,0)
 S RXN=ORITEM I '$D(^PSRX(RXN)) S RET="0^1" Q RET  ;invalid RX ien
"RTN","PSOHLNE3",23,0)
 I $D(^PSRX(RXN,"STA")) S PSOSTAZ=^PSRX(RXN,"STA")
"RTN","PSOHLNE3",24,0)
 ; get prescription file patient ien, drug, and placer order #
"RTN","PSOHLNE3",25,0)
 D GETS^DIQ(52,RXN_",","2;6;39.3","I","ARRAY")
"RTN","PSOHLNE3",26,0)
 I '$D(ARRAY(52,RXN_",",2,"I")) S RET="0^3" Q RET  ;quit if you don't have a patient ien
"RTN","PSOHLNE3",27,0)
 I ARRAY(52,RXN_",",2,"I")'=DFN S RET="0^3" Q RET  ;quit if patient dfn is differnt
"RTN","PSOHLNE3",28,0)
 I '$D(ARRAY(52,RXN_",",39.3,"I")) S ARRAY(52,RXN_",",39.3,"I")=""  ;if don't have it; treat is as null
"RTN","PSOHLNE3",29,0)
 I ARRAY(52,RXN_",",39.3,"I")'="" I ARRAY(52,RXN_",",39.3,"I")'=ORIEN S RET="0^5" Q RET  ;placer # is different
"RTN","PSOHLNE3",30,0)
 I ARRAY(52,RXN_",",39.3,"I")="" S OICHK=0 D CHKOI I OICHK S RET="0^4" Q RET  ;quit if placer # is null and orderable item is different or null.
"RTN","PSOHLNE3",31,0)
 ;end of validation process
"RTN","PSOHLNE3",32,0)
 ;
"RTN","PSOHLNE3",33,0)
 S PSODD=$$GET1^DIQ(52,RXN_",",6,"I") S:($P($G(^PSDRUG(PSODD,0)),"^",3)["S")!($P($G(^(0)),"^",3)["I") PSOSI=1
"RTN","PSOHLNE3",34,0)
 S PSOPIBQ=$G(^PSRX(RXN,"IBQ")),PSOPICD=$P($G(^PSRX(RXN,"ICD",1,0)),"^",2,7)
"RTN","PSOHLNE3",35,0)
 S PSOX("IRXN")=RXN,PSORENW("IRXN")=RXN
"RTN","PSOHLNE3",36,0)
 S (PSONEW("PATIENT STATUS"),PTSTATUS)=$$GET1^DIQ(52,RXN_",","3","I")
"RTN","PSOHLNE3",37,0)
 I '$D(PTSTATUS) S (PSONEW("PATIENT STATUS"),PTSTATUS)=""
"RTN","PSOHLNE3",38,0)
 ;if patient status is null, treat same as PSONEW2, PSORN52, PSONEWG, AND PSONEWF.  If piece 7 of ^PS(53 doesn't equal 1, it's not exempt from copay.
"RTN","PSOHLNE3",39,0)
 I ORSCEI["?" S ORSCEI=$TR(ORSCEI,"?","")
"RTN","PSOHLNE3",40,0)
 D SCP^PSORN52D
"RTN","PSOHLNE3",41,0)
 S PSOANSQ(PSOX("IRXN"),"VEH")=$P(ORSCEI,U,1)
"RTN","PSOHLNE3",42,0)
 S PSOANSQ(PSOX("IRXN"),"RAD")=$P(ORSCEI,U,2)
"RTN","PSOHLNE3",43,0)
 I PSOSCP<50&($P($G(^PS(53,+$G(PTSTATUS),0)),"^",7)'=1) S PSOANSQ(PSOX("IRXN"),"SC")=$P(ORSCEI,U,3),PSOANSQ("SC")=$P(ORSCEI,U,3)
"RTN","PSOHLNE3",44,0)
 I PSOSCP>49!($P($G(^PS(53,+$G(PTSTATUS),0)),"^",7)=1) S PSOANSQ(PSOX("IRXN"),"SC>50")=$P(ORSCEI,U,3),PSOANSQ("SC>50")=$P(ORSCEI,U,3)
"RTN","PSOHLNE3",45,0)
 I PSOSCP=""&('$D(PSOANSQ("SC")))&($D(^PSRX(RXN,"ICD",1))) S PSOANSQ("SC")=$P(^PSRX(RXN,"ICD",1,0),"^",4),PSOANSQ(PSOX("IRXN"),"SC")=PSOANSQ("SC")  ;for SC with no percentage defined/ legacy
"RTN","PSOHLNE3",46,0)
 S PSOANSQ(PSOX("IRXN"),"PGW")=$P(ORSCEI,U,4)
"RTN","PSOHLNE3",47,0)
 S PSOANSQ(PSOX("IRXN"),"MST")=$P(ORSCEI,U,5)
"RTN","PSOHLNE3",48,0)
 S PSOANSQ(PSOX("IRXN"),"HNC")=$P(ORSCEI,U,6)
"RTN","PSOHLNE3",49,0)
 S PSOANSQ(PSOX("IRXN"),"CV")=$P(ORSCEI,U,7)
"RTN","PSOHLNE3",50,0)
 ; 
"RTN","PSOHLNE3",51,0)
 S DX="",DX2=0 F  S DX=$O(ORDX(DX)) Q:DX=""  S DX2=DX2+1,PSORX("ICD",DX2)=ORDX(DX)  ;Multi signed Rx's come in consecutively and the diagnosis subscript doesn't start with 1 for each Rx
"RTN","PSOHLNE3",52,0)
 S PSOSCP2=1
"RTN","PSOHLNE3",53,0)
 ;
"RTN","PSOHLNE3",54,0)
ICD2 ;Check to see if SC/EI changed during CPRS sign order
"RTN","PSOHLNE3",55,0)
 D GETS^DIQ(52,PSOX("IRXN")_",","52311*","I","PSOOICD")
"RTN","PSOHLNE3",56,0)
 S PSODCPY=0,PSOFLD=""
"RTN","PSOHLNE3",57,0)
 F TYPE="VEH","RAD","SC>50","PGW","MST","HNC","CV" Q:PSODCPY  F PSOFLD=1:1:7 D  Q:PSODCPY
"RTN","PSOHLNE3",58,0)
 . I TYPE="VEH"&(PSOFLD=1) D CHOC
"RTN","PSOHLNE3",59,0)
 . I TYPE="RAD"&(PSOFLD=2) D CHOC
"RTN","PSOHLNE3",60,0)
 . I TYPE="SC>50"&(PSOFLD=3)&($D(PSOANSQ(PSOX("IRXN"),TYPE))) D CHOC
"RTN","PSOHLNE3",61,0)
 . I TYPE="PGW"&(PSOFLD=4) D CHOC
"RTN","PSOHLNE3",62,0)
 . I TYPE="MST"&(PSOFLD=5) D CHOC
"RTN","PSOHLNE3",63,0)
 . I TYPE="HNC"&(PSOFLD=6) D CHOC
"RTN","PSOHLNE3",64,0)
 . I TYPE="CV"&(PSOFLD=7) D CHOC
"RTN","PSOHLNE3",65,0)
 I $D(PSOANSQ("SC")) S PSOFLD=3 S:PSOANSQ("SC")'=PSOOICD(52.052311,1_","_PSOX("IRXN")_",",PSOFLD,"I") PSODCPY=1,PSOFLD=""
"RTN","PSOHLNE3",66,0)
 ; IF NO SC/EI DIFFERENCES, CHECK FOR ICD CHANGES.  If there were SC/EI difference, don't need to check ICD because they are sent anyway when copay update is done.
"RTN","PSOHLNE3",67,0)
 I '$G(PSODCPY) D
"RTN","PSOHLNE3",68,0)
 .I '$D(PSORX("ICD"))&($G(PSOOICD(52.052311,1_","_RXN_",",.01,"I"))) S PSODGUP=1 Q  ;if no ICD's passed and ICD's defined in 52, CPRS overrides OP
"RTN","PSOHLNE3",69,0)
 .S (DX3,DX2,DX)="" F  S DX=$O(PSOOICD(52.052311,DX)) Q:DX=""  S DX2=+DX  ;get last entry for file 52
"RTN","PSOHLNE3",70,0)
 .S DX="" F  S DX=$O(PSORX("ICD",DX)) Q:DX=""  S DX3=DX D  ;get last entry for new ICD's from CPRS
"RTN","PSOHLNE3",71,0)
 .. I $G(PSOOICD(52.052311,DX_","_PSOX("IRXN")_",",.01,"I"))'=PSORX("ICD",DX) S PSODGUP=1  ;if ICD'S changed or more new ICD's than old ones.
"RTN","PSOHLNE3",72,0)
 .I DX2>DX3 S PSODGUP=1  ;if more old ICD's than new ones
"RTN","PSOHLNE3",73,0)
 Q:'$G(PSODCPY)&('$G(PSODGUP)) 1
"RTN","PSOHLNE3",74,0)
 D FILE2^PSORN52D  ;file SC/EI/ICD'S into Rx file
"RTN","PSOHLNE3",75,0)
 S PSOCIDC=$P($G(^PSRX(RXN,"ICD",1,0)),"^",2,7)
"RTN","PSOHLNE3",76,0)
 ;only do copay if SC/EI changed and SC is less than 50%.
"RTN","PSOHLNE3",77,0)
 I PSODCZ[(","_$G(PSOSTAZ)_",") S RET="0^6" Q RET  ;discontinue's no copay changes allowed.
"RTN","PSOHLNE3",78,0)
 S PSOIBQC=$G(^PSRX(RXN,"IBQ"))
"RTN","PSOHLNE3",79,0)
 I PSOPIBQ[1&(PSOIBQC'[1)&(PSOSCP<50) S $P(^PSRX(RXN,"IB"),"^",1)=1 D  Q RET  ;don't do no copay to copay bills, but update status
"RTN","PSOHLNE3",80,0)
 . D ALOG
"RTN","PSOHLNE3",81,0)
 . Q:($P($G(^PS(53,+$G(PTSTATUS),0)),"^",7)=1)
"RTN","PSOHLNE3",82,0)
 . S PSOOLD="No Copay",PSONW="Copay",PREA="R",PSODA=RXN D:'$G(PSOSI) ACTLOG^PSOCPA
"RTN","PSOHLNE3",83,0)
 I $G(PSODCPY)&(PSOSCP<50) D COPAY
"RTN","PSOHLNE3",84,0)
 I ($G(PSODCPY)!($G(PSODGUP))) D ALOG
"RTN","PSOHLNE3",85,0)
 Q RET
"RTN","PSOHLNE3",86,0)
CHOC ;check outpatient classifications
"RTN","PSOHLNE3",87,0)
 S:PSOANSQ(PSOX("IRXN"),TYPE)'=PSOOICD(52.052311,1_","_PSOX("IRXN")_",",PSOFLD,"I") PSODCPY=1
"RTN","PSOHLNE3",88,0)
 Q
"RTN","PSOHLNE3",89,0)
ALOG ;set activity log with edit info from cprs
"RTN","PSOHLNE3",90,0)
 N ACNT,SUB,RF,RFCNT
"RTN","PSOHLNE3",91,0)
 S ACNT=0 F SUB=0:0 S SUB=$O(^PSRX(RXN,"A",SUB)) Q:'SUB  S ACNT=SUB
"RTN","PSOHLNE3",92,0)
 S RFCNT=0 F RF=0:0 S RF=$O(^PSRX(RXN,1,RF)) Q:'RF  S RFCNT=RF S:RF>5 RFCNT=RF+1
"RTN","PSOHLNE3",93,0)
 D NOW^%DTC S ACNT=ACNT+1
"RTN","PSOHLNE3",94,0)
 S ^PSRX(RXN,"A",0)="^52.3DA^"_ACNT_"^"_ACNT S ^PSRX(RXN,"A",ACNT,0)=%_"^"_"E"_"^^"_RFCNT_"^Clinical Indicators and SC/EI's were updated from a CPRS e-sig edit at "_$E($P(%,".",2),1,2)_":"_$E($P(%,".",2),3,4)_"."
"RTN","PSOHLNE3",95,0)
 Q
"RTN","PSOHLNE3",96,0)
COPAY ;cancel copay charges if SC<50% and SC/EI changed and released
"RTN","PSOHLNE3",97,0)
 ;  must have PSODA,PSO,PSODAYS,PSOFLAG,PSOREF,PSOIB,PSOPAR7,PSOOLD,PSONW before call to PSOCPA
"RTN","PSOHLNE3",98,0)
 Q:($P($G(^PS(53,+$G(PTSTATUS),0)),"^",7)=1)
"RTN","PSOHLNE3",99,0)
 N PSODA,PSO,PSODAYS,PSOFLAG,PSOREF,PSOIB,PSZ,PSOPAR7,PSOCSEQ,PSZ1,PSZ2,RELDAT,PSOOLD,PSONW,PSOSITE
"RTN","PSOHLNE3",100,0)
 S PSODA=RXN,PSO=3,PSODAYS=$$GET1^DIQ(52,PSODA_",","8")
"RTN","PSOHLNE3",101,0)
 S PSOOLD="Copay"
"RTN","PSOHLNE3",102,0)
 S PSONW="No Copay"
"RTN","PSOHLNE3",103,0)
 S PSOSITE=$P(^PSRX(PSODA,2),"^",9)
"RTN","PSOHLNE3",104,0)
 S PSOPAR7=$G(^PS(59,PSOSITE,"IB"))
"RTN","PSOHLNE3",105,0)
 S PSOFLAG=1  ;1 used here to eliminate display/print of messages.
"RTN","PSOHLNE3",106,0)
CSORT ; get orig fill copay info if released.
"RTN","PSOHLNE3",107,0)
 S RELDAT=$$GET1^DIQ(52,PSODA_",","31","I")
"RTN","PSOHLNE3",108,0)
 I RELDAT'="" S PSOCSEQ("A",0)=$G(^PSRX(PSODA,"IB"))
"RTN","PSOHLNE3",109,0)
 I RELDAT="" S PREA="R" D:(PSOIBQC[1&(PSOPIBQ'[1)) ACTLOG^PSOCPA G SET ;set act log when unreleased, but SC/EI changed copay
"RTN","PSOHLNE3",110,0)
 ; get copay info for all released refills; if any
"RTN","PSOHLNE3",111,0)
 F PSZ=0:0 S PSZ=$O(^PSRX(PSODA,1,PSZ)) Q:PSZ'>0  D
"RTN","PSOHLNE3",112,0)
 . S RELDAT="",RELDAT=$$GET1^DIQ(52.1,PSZ_","_PSODA_",","17","I")
"RTN","PSOHLNE3",113,0)
 . Q:RELDAT=""
"RTN","PSOHLNE3",114,0)
 . S PSOCSEQ("A",PSZ)=$G(^PSRX(PSODA,1,PSZ,"IB"))
"RTN","PSOHLNE3",115,0)
 ; Sort potential refills to be cancelled first starting with last fill
"RTN","PSOHLNE3",116,0)
 ;    then orig fill then the rest of the entries.
"RTN","PSOHLNE3",117,0)
 S (PSZ1,PSZ2,PSZ)="" F  S PSZ=$O(PSOCSEQ("A",PSZ),-1) Q:PSZ=""  D
"RTN","PSOHLNE3",118,0)
 . I PSZ>0&($P(PSOCSEQ("A",PSZ),"^",2)'="") S PSZ1=PSZ1+1,PSOCSEQ("B",PSZ1,PSZ)="" Q
"RTN","PSOHLNE3",119,0)
 . I PSZ>0&($P(PSOCSEQ("A",PSZ),"^",2)="") S PSZ2=PSZ2+1000,PSOCSEQ("B",PSZ2,PSZ)="" Q
"RTN","PSOHLNE3",120,0)
 . I PSZ=0&($P(PSOCSEQ("A",PSZ),"^",4)'="") S PSZ1=PSZ1+1,PSOCSEQ("B",PSZ1,PSZ)="" Q
"RTN","PSOHLNE3",121,0)
 . I PSZ=0&($P(PSOCSEQ("A",PSZ),"^",4)="") S PSZ2=PSZ2+1000,PSOCSEQ("B",PSZ2,PSZ)="" Q
"RTN","PSOHLNE3",122,0)
 ;
"RTN","PSOHLNE3",123,0)
 S (PSZ,PSZ1)="",PREA="R" D:'$G(PSOSI)&(PSOIBQC[1&(PSOPIBQ'[1)) ACTLOG^PSOCPA F  S PSZ1=$O(PSOCSEQ("B",PSZ1)) Q:PSZ1=""  D
"RTN","PSOHLNE3",124,0)
 . F  S PSZ=$O(PSOCSEQ("B",PSZ1,PSZ)) Q:PSZ=""  D
"RTN","PSOHLNE3",125,0)
 .. S (PSOREF,PSOIB)="",PREA="C",(PSOOLD,PSONW)=""
"RTN","PSOHLNE3",126,0)
 .. S PSOREF=PSZ,PSOIB=PSOCSEQ("A",PSZ) D RXED^PSOCPA
"RTN","PSOHLNE3",127,0)
SET S:$D(^PSRX(PSODA,"IB"))&($TR($G(^PSRX(PSODA,"IBQ")),"^")[1) $P(^PSRX(PSODA,"IB"),"^",1)=""
"RTN","PSOHLNE3",128,0)
 Q
"RTN","PSOHLNE3",129,0)
CHKOI ;get and compare orderable items in file #100 and #52; don't process
"RTN","PSOHLNE3",130,0)
 ;  if it's different and the placer # is null.
"RTN","PSOHLNE3",131,0)
 I '$D(ARRAY(52,RXN_",",6,"I")) S OICHK=1 Q
"RTN","PSOHLNE3",132,0)
 D GETS^DIQ(50,ARRAY(52,RXN_",",6,"I")_",","2.1","I","PSOOI")
"RTN","PSOHLNE3",133,0)
 S ORITEM2=$$GET1^DIQ(100.001,"1,"_ORIEN_",",".01","I")
"RTN","PSOHLNE3",134,0)
 S ORID=$$GET1^DIQ(101.43,ORITEM2_",","2","I") S ORID=$P(ORID,";",1)
"RTN","PSOHLNE3",135,0)
 I PSOOI(50,ARRAY(52,RXN_",",6,"I")_",",2.1,"I")'="" I PSOOI(50,ARRAY(52,RXN_",",6,"I")_",",2.1,"I")'=ORID S OICHK=1
"RTN","PSOHLNE3",136,0)
 Q
"RTN","PSOHLNE3",137,0)
TEST(ORIEN) ;manually test an individual order record
"RTN","PSOHLNE3",138,0)
 N I,X,ORSCEIS,ORSCEI,ORDX,EDFLG,ORITEM,DFN,JJ
"RTN","PSOHLNE3",139,0)
 S (JJ,I)=0 F  S I=$O(^OR(100,ORIEN,5.1,I)) Q:I=""!(I'?1N.NN)  S JJ=JJ+1,ORDX(JJ)=$G(^OR(100,ORIEN,5.1,I,0))
"RTN","PSOHLNE3",140,0)
 S ORSCEIS=^OR(100,ORIEN,5.2),ORITEM=$P($G(^OR(100,ORIEN,4)),"^",1)
"RTN","PSOHLNE3",141,0)
 S ORSCEI="" F I=3,4,1,5,2,6,7 S ORSCEI=ORSCEI_"^"_$P(ORSCEIS,"^",I)
"RTN","PSOHLNE3",142,0)
 S ORSCEI=$E(ORSCEI,2,99)
"RTN","PSOHLNE3",143,0)
 S RXN=ORITEM,DFN=$P($P(^OR(100,ORIEN,0),"^",2),";",1)
"RTN","PSOHLNE3",144,0)
 D EN^PSOHLNE3(DFN,ORITEM,ORIEN,.ORDX,ORSCEI)
"RTN","PSOHLNE3",145,0)
 Q
"RTN","PSOHLNEW")
0^23^B77391528^B78866487
"RTN","PSOHLNEW",1,0)
PSOHLNEW ;BIR/RTR - CPRS orders ;07/21/96
"RTN","PSOHLNEW",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,7,15,46,71,98,111,124,117,131,146,132,143,223,235,148,239**;DEC 1997
"RTN","PSOHLNEW",3,0)
 ;40.8-728,50-221,SC-2675,100-2219,50.7-2223,EN^ORERR-2187
"RTN","PSOHLNEW",4,0)
EN(MSG) ;
"RTN","PSOHLNEW",5,0)
 N PSODDRUG,ENTERED,LOCATION,PLACER,PSOOC,ROUTE,NATURE,PREV,ROUTING,OO,OR,STAT,ZZ,DFN,COMM,QCOUNT,OCOUNT,Q1I,QTARRAY,QTARRAY2,EE,PP,XOFLAG,PSODYSPL,PSOFILNM
"RTN","PSOHLNEW",6,0)
 N ONEFLAG,SERV,WPCT,EFFECT,PROV,PENDING,RRX,PSOLQ1I,PSOLQ1II,PSOQWX,PSOLQ1IX,PSONVA,PSOICD,PSOSCP,EEE
"RTN","PSOHLNEW",7,0)
 N OBXAR,AA,II,SIG1,FILLER,COMM,GG,FF,JJ,JJJ,CT,LIM,VAR,VAR1,QQQ,PSRNFLAG,PSRNQFLG,RCOMM,XOFLAGZ,NWFLAG,PFLAG,PSINPTR,INPTRX,PSOIBN,PSOIBY
"RTN","PSOHLNEW",8,0)
 N DSIG,PSOCHFFL,PSOCVI,PSOMO,PSOXRP,NN,LL,LLL,WPARRAY,QTVAR,POVAR,POVAR1,ORCSEG,NNN,OOO,AAA,NNNN,POLIM,NNCK,PRIOR,IPPLACER,PLACERXX,EER,PSERRPID,PSERRPV1,PSERRORC,PSOEXFLG,PSOMSORR,PDFN
"RTN","PSOHLNEW",9,0)
 S (SEND,PSOSND,OCOUNT)=0 K PSOPLC,PSOFFL,PSORSO,PSOSUSZ
"RTN","PSOHLNEW",10,0)
 F OO=0:0 S OO=$O(MSG(OO)) Q:'OO!(SEND)!(PSOSND)  D:$P(MSG(OO),"|")="PID" SPDFN I $P(MSG(OO),"|")="ORC",$P(MSG(OO),"|",2)'="NW",$P(MSG(OO),"|",2)'="XO" D
"RTN","PSOHLNEW",11,0)
 .S OR("STAT")=$P(MSG(OO),"|",2),OR("PLACE")=+$P(MSG(OO),"|",3),PLACERXX=+$P($P(MSG(OO),"|",3),";",2),OR("COMM")=$P(MSG(OO),"|",17),OR("USER")=$P(MSG(OO),"|",11) I $P(MSG(OO),"|",2)'="DE",$P(MSG(OO),"|",2)'="NA" S SEND=1 D FILL Q
"RTN","PSOHLNEW",12,0)
 .S PSOPLC=+$P(MSG(OO),"|",3),PSOFFL=+$P(MSG(OO),"|",4),PSOSND=1,PSOCHFFL=$P($P(MSG(OO),"|",4),"^")
"RTN","PSOHLNEW",13,0)
 I $G(OR("COMM"))["^" S OR("COMM")=$P(OR("COMM"),"^",5)
"RTN","PSOHLNEW",14,0)
 I PSOSND,$G(PSOCHFFL)["S",$G(OR("STAT"))="NA" D CHCS^PSOHLNE1 Q
"RTN","PSOHLNEW",15,0)
 I PSOSND,'$D(^PSRX(+$G(PSOFFL),0)) S COMM="Order was not located by Pharmacy" D EN^ORERR(COMM,.MSG) D KL Q
"RTN","PSOHLNEW",16,0)
 I PSOSND,$G(PDFN),PDFN'=+$P($G(^PSRX(+$G(PSOFFL),0)),"^",2) S COMM="Patient does not match" D EN^ORERR(COMM,.MSG) D KL Q
"RTN","PSOHLNEW",17,0)
 I PSOSND,$G(OR("STAT"))'="DE" N PSONAS S PSONAS=$S($P($G(^PSRX(PSOFFL,"OR1")),"^",2)="":1,1:0) S $P(^PSRX(PSOFFL,"OR1"),"^",2)=PSOPLC,^PSRX("APL",PSOPLC,PSOFFL)="" D:PSONAS EN^PSOHDR("PRES",PSOFFL) D KL Q
"RTN","PSOHLNEW",18,0)
 D KL
"RTN","PSOHLNEW",19,0)
 I SEND,$G(OR("STAT"))="Z@" G PURGE^PSOHLNE2
"RTN","PSOHLNEW",20,0)
 I SEND,$G(OR("STAT"))="ZF" G REF^PSOHLNE2
"RTN","PSOHLNEW",21,0)
 I SEND,$G(OR("STAT"))'="CA",$G(OR("STAT"))'="DC",$G(OR("STAT"))'="HD",$G(OR("STAT"))'="RL",$G(OR("STAT"))'="SS" S RCOMM="Invalid Order Control Code" D EN^ORERR(RCOMM,.MSG) Q
"RTN","PSOHLNEW",22,0)
 I SEND K SEND G:$G(OR("STAT"))="SS" ESTAT D EN^PSOORUTL(.OR) S PLACER=OR("PLACE"),STAT=OR("STAT"),COMM=OR("COMM") S PSOMSORR=1 D  K PSOMSORR Q
"RTN","PSOHLNEW",23,0)
 .I $G(OR("FILLER"))="" D  D ERROR^PSOHLSN Q
"RTN","PSOHLNEW",24,0)
 ..F EER=0:0 S EER=$O(MSG(EER)) Q:'EER  S:$P(MSG(EER),"|")="PV1" PSERRPV1=MSG(EER) S:$P(MSG(EER),"|")="PID" PSERRPID=MSG(EER) S:$P(MSG(EER),"|")="ORC"&($G(PSERRORC)="") PSERRORC=MSG(EER)
"RTN","PSOHLNEW",25,0)
 .I $P(OR("FILLER"),"^",2)="R" S FILLER=$P(OR("FILLER"),"^") D EN^PSOHLSN1(FILLER,STAT,$G(OR("PHARMST")),COMM) K:$G(PSOEXFLG) PSOMSORR,PLACERXX D:$G(PSOEXFLG) EN^PSOHLSN1(FILLER,"SC","ZE","") D:$G(PSOSUSZ) SUS^PSOORUT1 K PSOSUSZ Q
"RTN","PSOHLNEW",26,0)
 .D EN^PSOHLSN(PLACER,STAT,COMM) Q
"RTN","PSOHLNEW",27,0)
 D KL^PSOHLSIH S RRX=1 F ZZ=0:0 S ZZ=$O(MSG(ZZ)) Q:'ZZ  S PSOSEG=$G(MSG(ZZ)),PSOTYPE=$P(PSOSEG,"|") S PSOSEG=$E(PSOSEG,5,$L(PSOSEG)) I PSOTYPE'="NTE" D @PSOTYPE
"RTN","PSOHLNEW",28,0)
 I $G(PSRNFLAG) S PSOMO=0 D MISRN^PSOHLNE1 I $G(PSOMO) Q
"RTN","PSOHLNEW",29,0)
 S PSRNQFLG=0 I $G(PSRNFLAG),$G(PREV) D  I $G(PSRNQFLG) S RCOMM="Duplicate Renewal Request. Order rejected by Pharmacy." D EN^ORERR(RCOMM,.MSG) D RERROR^PSOHLSN D KL^PSOHLSIH Q
"RTN","PSOHLNEW",30,0)
 .I $P($G(^PSRX(PREV,"OR1")),"^",4) S PSRNQFLG=1 Q
"RTN","PSOHLNEW",31,0)
 .I $O(^PS(52.41,"AQ",PREV,0)) S PSRNQFLG=1
"RTN","PSOHLNEW",32,0)
 .I $G(XOFLAG),$G(DFN)'=$S($G(PFLAG):$P($G(^PS(52.41,+$G(PREV),0)),"^",2),1:$P($G(^PSRX(+$G(PREV),0)),"^",2)) S RCOMM="Patient mismatch on previous order." D EN^ORERR(RCOMM,.MSG) S XOFLAGZ=1 D RERROR^PSOHLSN D KL^PSOHLSIH Q
"RTN","PSOHLNEW",33,0)
 I $G(DFN)'=+$P($G(^OR(100,+$G(PLACER),0)),"^",2) G MISX^PSOHLNE1
"RTN","PSOHLNEW",34,0)
 I $G(PLACER) D NFILE
"RTN","PSOHLNEW",35,0)
 D KL^PSOHLSIH
"RTN","PSOHLNEW",36,0)
 Q
"RTN","PSOHLNEW",37,0)
ESTAT ;
"RTN","PSOHLNEW",38,0)
 D EXP^PSOHLNE1
"RTN","PSOHLNEW",39,0)
 Q
"RTN","PSOHLNEW",40,0)
MSH Q
"RTN","PSOHLNEW",41,0)
PID S DFN=+$P(PSOSEG,"|",3)
"RTN","PSOHLNEW",42,0)
 Q
"RTN","PSOHLNEW",43,0)
PV1 S LOCATION=+$P(+$P(PSOSEG,"|",3),"^")
"RTN","PSOHLNEW",44,0)
 S:'$D(^SC(LOCATION,0)) LOCATION=""
"RTN","PSOHLNEW",45,0)
 S INPTRX=0 I $G(LOCATION) S PSINPTR=$P($G(^SC(LOCATION,0)),"^",4) I PSINPTR Q
"RTN","PSOHLNEW",46,0)
 I $G(LOCATION) S INPTRX=$P($G(^SC(LOCATION,0)),"^",15)
"RTN","PSOHLNEW",47,0)
 I '$G(INPTRX) S INPTRX=$O(^DG(40.8,0))
"RTN","PSOHLNEW",48,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLNEW",49,0)
 S PSINPTR=+$$SITE^VASITE(DT,INPTRX)
"RTN","PSOHLNEW",50,0)
 Q
"RTN","PSOHLNEW",51,0)
DG1 S $P(PSOICD($P(PSOSEG,"|",1)),"^")=$P($P(PSOSEG,"|",3),"^")
"RTN","PSOHLNEW",52,0)
 Q
"RTN","PSOHLNEW",53,0)
ORC ;
"RTN","PSOHLNEW",54,0)
 Q:$P(PSOSEG,"|")="DE"
"RTN","PSOHLNEW",55,0)
 S:$P(PSOSEG,"|")="XO" XOFLAG=1 D ^PSOHLNE1 S:$G(PRIOR)="A" PRIOR="E" S:$G(PRIOR)="" PRIOR="R"
"RTN","PSOHLNEW",56,0)
 Q
"RTN","PSOHLNEW",57,0)
 ;
"RTN","PSOHLNEW",58,0)
RXO I $O(MSG(ZZ,0)) D ^PSOHLNE2 G RXOPS
"RTN","PSOHLNEW",59,0)
 S PSORDITE=$P($P(PSOSEG,"|"),"^",4)
"RTN","PSOHLNEW",60,0)
 S PSODDRUG=$P($P(PSOSEG,"|",10),"^",4) I $G(PSODDRUG) S:'$D(^PSDRUG(PSODDRUG,0)) PSODDRUG=""
"RTN","PSOHLNEW",61,0)
 S PSOXQTY=$P(PSOSEG,"|",11)
"RTN","PSOHLNEW",62,0)
 S PSOREFIL=$P(PSOSEG,"|",13)
"RTN","PSOHLNEW",63,0)
 S PSODYSPL=$P(PSOSEG,"|",17)
"RTN","PSOHLNEW",64,0)
RXOPS S ONEFLAG=0,WPCT=1,LL=ZZ+1
"RTN","PSOHLNEW",65,0)
 I $P($G(MSG(LL)),"|")="NTE" D
"RTN","PSOHLNEW",66,0)
 .S ONEFLAG=1,WORDP=$S($P(MSG(LL),"|",2):$P(MSG(LL),"|",2),1:$P(MSG(LL),"|",3)) S:$P(MSG(LL),"|",4)'="" WPARRAY(WORDP,WPCT)=$P(MSG(LL),"|",4) S:$P(MSG(LL),"|",4)'="" WPCT=WPCT+1 F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNEW",67,0)
 ..I $G(MSG(LL,LLL))'="" S WPARRAY(WORDP,WPCT)=$G(MSG(LL,LLL)),WPCT=WPCT+1
"RTN","PSOHLNEW",68,0)
 I ONEFLAG S LL=LL+1 I $P($G(MSG(LL)),"|")="NTE" D NTE^PSOHLNE1
"RTN","PSOHLNEW",69,0)
 K WORDP
"RTN","PSOHLNEW",70,0)
 Q
"RTN","PSOHLNEW",71,0)
RXR I $P($P(PSOSEG,"|"),"^",4) S ROUTE(RRX)=$P($P(PSOSEG,"|"),"^",4) S RRX=RRX+1
"RTN","PSOHLNEW",72,0)
 Q
"RTN","PSOHLNEW",73,0)
OBX I $O(MSG(ZZ,0)) D OBXX^PSOHLNE2 G OBXNTE
"RTN","PSOHLNEW",74,0)
 S OCOUNT=OCOUNT+1
"RTN","PSOHLNEW",75,0)
 S OBXAR(OCOUNT,1)=$P(PSOSEG,"|",5)
"RTN","PSOHLNEW",76,0)
OBXNTE ;
"RTN","PSOHLNEW",77,0)
 S LL=ZZ+1,PSOBCT=2
"RTN","PSOHLNEW",78,0)
 I $P($G(MSG(LL)),"|")="NTE" D
"RTN","PSOHLNEW",79,0)
 .I $P(MSG(LL),"|",4)'="" S PSOBCT=3,OBXAR(OCOUNT,2)=$P(MSG(LL),"|",4)
"RTN","PSOHLNEW",80,0)
 .F LLL=0:0 S LLL=$O(MSG(LL,LLL)) Q:'LLL  D
"RTN","PSOHLNEW",81,0)
 ..I $P($G(MSG(LL,LLL)),"|",4)'="" S OBXAR(OCOUNT,PSOBCT)=$P(MSG(LL,LLL),"|",4),PSOBCT=PSOBCT+1
"RTN","PSOHLNEW",82,0)
 Q
"RTN","PSOHLNEW",83,0)
ZRN S PSODSC=1_"^"_$P(PSOSEG,"|",2)
"RTN","PSOHLNEW",84,0)
 I $O(MSG(ZZ,0)) F T=0:0 S T=$O(MSG(ZZ,T)) Q:'T  S PSODSC(T)=MSG(ZZ,T)
"RTN","PSOHLNEW",85,0)
 K T
"RTN","PSOHLNEW",86,0)
 Q
"RTN","PSOHLNEW",87,0)
 ;
"RTN","PSOHLNEW",88,0)
ZRX D ZRX^PSOHLNE1
"RTN","PSOHLNEW",89,0)
 Q
"RTN","PSOHLNEW",90,0)
 ;
"RTN","PSOHLNEW",91,0)
ZCL D ZCL^PSOHLNE1
"RTN","PSOHLNEW",92,0)
 Q
"RTN","PSOHLNEW",93,0)
ZSC D CP^PSOHLNE1
"RTN","PSOHLNEW",94,0)
 Q
"RTN","PSOHLNEW",95,0)
NFILE ;
"RTN","PSOHLNEW",96,0)
 I $G(PSODSC) D ^PSONVNEW Q  ;adds non-va med to #55
"RTN","PSOHLNEW",97,0)
 ;
"RTN","PSOHLNEW",98,0)
 K DD,DO,DIC S DLAYGO="52.41",DIC="^PS(52.41,",DIC(0)="L",X=PLACER,DIC("DR")="1////"_DFN_";2////"_PSOOC_";6////"_$G(EFFECT)_";12////"_$G(PSOXQTY)_";25////"_$G(PRIOR)
"RTN","PSOHLNEW",99,0)
 S DIC("DR")=DIC("DR")_";22////"_$G(PSORSO)_";22.1////"_$G(PREV)_";19////"_$G(ROUTING)_";17////"_$G(SERV)_";7////"_$G(NATURE)_";13////"_$G(PSOREFIL)_";1.1////"_$G(LOCATION)_";117////"_$G(DSIG)
"RTN","PSOHLNEW",100,0)
 D FILE^DICN K DIC,DR I Y<0 Q
"RTN","PSOHLNEW",101,0)
 S PENDING=+Y
"RTN","PSOHLNEW",102,0)
 S $P(^PS(52.41,PENDING,0),"^",4)=$S($G(ENTERED):+$G(ENTERED),1:""),$P(^(0),"^",5)=$S($G(PROV):+$G(PROV),1:""),$P(^(0),"^",8)=$S($G(PSORDITE):+$G(PSORDITE),1:""),$P(^(0),"^",9)=$S($G(PSODDRUG):+$G(PSODDRUG),1:""),$P(^(0),"^",15)=$G(ROUTE)
"RTN","PSOHLNEW",103,0)
 S ^PS(52.41,PENDING,"IBQ")=$G(PSOIBY)
"RTN","PSOHLNEW",104,0)
 I $G(PSODYSPL)'="",$E(PSODYSPL)?1A S PSODYSPL=$E(PSODYSPL,2,$L(PSODYSPL))
"RTN","PSOHLNEW",105,0)
 S $P(^PS(52.41,PENDING,"INI"),"^")=$G(PSINPTR),$P(^(0),"^",12)=$G(PSOLOG),$P(^(0),"^",22)=$G(PSODYSPL)
"RTN","PSOHLNEW",106,0)
 I $G(QCOUNT) S ^PS(52.41,PENDING,1,0)="^52.413^"_QCOUNT_"^"_QCOUNT
"RTN","PSOHLNEW",107,0)
 S PSOQWX=$G(PSODDRUG) D:'$G(PSOQWX) OID^PSOHLNE1
"RTN","PSOHLNEW",108,0)
 F PP=0:0 S PP=$O(Q1I(PP)) Q:'PP  S ^PS(52.41,PENDING,1,PP,0)=$S($G(PSOQWX)&($G(PSOLQ1II(PP))):Q1I(PP),$G(PSOQWX)&($G(PSOLQ1IX(PP))'="")&('$G(PSOLQ1II(PP))):PSOLQ1IX(PP),1:PSOLQ1I(PP))
"RTN","PSOHLNEW",109,0)
 F EE=0:0 S EE=$O(QTARRAY(EE)) Q:'EE  S ^PS(52.41,PENDING,1,EE,1)=QTARRAY(EE),^PS(52.41,PENDING,1,EE,2)=$S($G(PSOQWX)&($G(PSOLQ1II(EE))):$G(QTARRAY2(EE)),$G(PSOQWX)&($G(PSOLQ1IX(EE))'="")&('$G(PSOLQ1II(EE))):PSOLQ1IX(EE),1:$G(PSOLQ1I(EE))) D
"RTN","PSOHLNEW",110,0)
 .S $P(^PS(52.41,PENDING,1,EE,1),"^",8)=+$G(ROUTE(EE))
"RTN","PSOHLNEW",111,0)
 S:$P($G(^PS(52.41,PENDING,1,1,1)),"^",3) $P(^PS(52.41,PENDING,0),"^",18)=$E($P($G(^PS(52.41,PENDING,1,1,1)),"^",3),1,7)
"RTN","PSOHLNEW",112,0)
 D STUFF^PSOHLNE2
"RTN","PSOHLNEW",113,0)
 D ^PSOHLPII
"RTN","PSOHLNEW",114,0)
 S LL=0 I $O(WPARRAY(6,0)) F LLL=0:0 S LLL=$O(WPARRAY(6,LLL)) Q:'LLL  S LL=LL+1 S ^PS(52.41,PENDING,3,LL,0)=$G(WPARRAY(6,LLL))
"RTN","PSOHLNEW",115,0)
 I LL S ^PS(52.41,PENDING,3,0)="^52.42^"_LL_"^"_LL
"RTN","PSOHLNEW",116,0)
 S LL=0 I $O(WPARRAY(7,0)) F LLL=0:0 S LLL=$O(WPARRAY(7,LLL)) Q:'LLL  S LL=LL+1 S ^PS(52.41,PENDING,"INS1",LL,0)=$G(WPARRAY(7,LLL))
"RTN","PSOHLNEW",117,0)
 I LL S ^PS(52.41,PENDING,"INS1",0)="^^"_LL_"^"_LL_"^"_$G(DT)_"^"
"RTN","PSOHLNEW",118,0)
 I $P($G(^PS(50.7,+$G(PSORDITE),"INS")),"^")'="" S $P(^PS(52.41,PENDING,"INS"),"^",2)=$S($O(^PS(52.41,PENDING,"INS1",0)):1,1:0)
"RTN","PSOHLNEW",119,0)
 I $G(OCOUNT) S ^PS(52.41,PENDING,"OBX",0)="^52.4118A^"_OCOUNT_"^"_OCOUNT F OCOUNT=1:1:OCOUNT D
"RTN","PSOHLNEW",120,0)
 .S ^PS(52.41,PENDING,"OBX",OCOUNT,0)=$G(OBXAR(OCOUNT,1))
"RTN","PSOHLNEW",121,0)
 .D USER^PSOORFI2(+$G(PROV)) S ^PS(52.41,PENDING,"OBX",OCOUNT,1)=USER1 K USER1
"RTN","PSOHLNEW",122,0)
 .S PSOBCT=1 F LLL=2:1 Q:'$D(OBXAR(OCOUNT,LLL))  S ^PS(52.41,PENDING,"OBX",OCOUNT,2,PSOBCT,0)=OBXAR(OCOUNT,LLL),^PS(52.41,PENDING,"OBX",OCOUNT,2,0)="^^"_PSOBCT_"^"_PSOBCT_"^"_$G(DT)_"^"
"RTN","PSOHLNEW",123,0)
 D ^PSOHLPIS
"RTN","PSOHLNEW",124,0)
 K DIK S DIK="^PS(52.41,",DA=PENDING D IX^DIK
"RTN","PSOHLNEW",125,0)
 I $G(PSOOC)="RNW",$G(PREV),$D(^PSRX(+$G(PREV),0)) D EN^PSOHLSN1(PREV,"SC","ZZ","")
"RTN","PSOHLNEW",126,0)
 S PSOMSORR=1,IPPLACER=$P($G(^PS(52.41,PENDING,0)),"^") I IPPLACER D
"RTN","PSOHLNEW",127,0)
 .I '$G(XOFLAG) D EN^PSOHLSN(IPPLACER,"OK","IP") Q
"RTN","PSOHLNEW",128,0)
 .D EN^PSOHLSN(IPPLACER,"XR","IP") I $G(PFLAG) D DCP^PSOHLSN Q
"RTN","PSOHLNEW",129,0)
 .K PSOMSORR I $D(^PSRX(+$G(PREV),0)) D  D EN^PSOHLSN1(PREV,"RP","","","A")
"RTN","PSOHLNEW",130,0)
 ..S $P(^PSRX(PREV,"STA"),"^")=15,$P(^PSRX(PREV,3),"^",5)=$S($P($G(^PSRX(PREV,3)),"^"):$P(^(3),"^"),1:DT)
"RTN","PSOHLNEW",131,0)
 ..D REVERSE^PSOBPSU1(PREV,,"DC",7),CAN^PSOTPCAN(PREV),CAN^PSOUTL(PREV)
"RTN","PSOHLNEW",132,0)
 ..D CNT^PSOHLNE1
"RTN","PSOHLNEW",133,0)
 ..D:$G(^PS(52.41,PENDING,1,1,0))=""&($P($G(^PS(52.41,PENDING,1,1,1)),"^")="")&($G(^PS(52.41,PENDING,"SIG",1,0))="")
"RTN","PSOHLNEW",134,0)
 ...N FSIG,BSIG
"RTN","PSOHLNEW",135,0)
 ...I '$P($G(^PSRX(PREV,"SIG")),"^",2),$P($G(^("SIG")),"^")'="" D
"RTN","PSOHLNEW",136,0)
 ....D EN3^PSOUTLA1(PREV,70)
"RTN","PSOHLNEW",137,0)
 ....I $G(BSIG(1))'="" S ^PS(52.41,PENDING,"SIG",1,0)=$G(BSIG(1)) I $O(BSIG(1)) F EE=1:0 S EE=$O(BSIG(EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",EE,0)=$G(BSIG(EE))
"RTN","PSOHLNEW",138,0)
 ...I $P($G(^PSRX(PREV,"SIG")),"^",2),$G(^PSRX(PREV,"SIG1",1,0))'="" D
"RTN","PSOHLNEW",139,0)
 ....D FSIG^PSOUTLA("R",PREV,70)
"RTN","PSOHLNEW",140,0)
 ....I $G(FSIG(1))'="" S ^PS(52.41,PENDING,"SIG",1,0)=$G(FSIG(1)) I $O(FSIG(1)) F EE=1:0 S EE=$O(FSIG(EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",EE,0)=$G(FSIG(EE))
"RTN","PSOHLNEW",141,0)
 ...F EE=0:0 S EE=$O(^PS(52.41,PENDING,"SIG",EE)) Q:'EE  S ^PS(52.41,PENDING,"SIG",0)="^52.4124A^"_EE_"^"_EE
"RTN","PSOHLNEW",142,0)
 D CSET^PSODIAG
"RTN","PSOHLNEW",143,0)
 Q
"RTN","PSOHLNEW",144,0)
SPDFN S PDFN=$P($G(MSG(OO)),"|",4) Q
"RTN","PSOHLNEW",145,0)
KL K PSOPLC,PSOFFL,PSOSND
"RTN","PSOHLNEW",146,0)
 Q
"RTN","PSOHLNEW",147,0)
FILL ;
"RTN","PSOHLNEW",148,0)
 S (PSOFILNM,OR("PSOFILNM"))=$P($P(MSG(OO),"|",4),"^")
"RTN","PSOHLNEW",149,0)
 Q
"RTN","PSOHLSN1")
0^19^B81359124^B86702182
"RTN","PSOHLSN1",1,0)
PSOHLSN1 ;BIR/RTR - Send order info to OERR from file 52 ;10/10/94
"RTN","PSOHLSN1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,10,24,27,55,46,71,101,99,121,139,157,181,143,235,239**;DEC 1997
"RTN","PSOHLSN1",3,0)
 ;Ref #50.606-DBIA 2174
"RTN","PSOHLSN1",4,0)
 ;#50.607-2221
"RTN","PSOHLSN1",5,0)
 ;#50.7-2223
"RTN","PSOHLSN1",6,0)
 ;#51.2-2226
"RTN","PSOHLSN1",7,0)
 ;#50-221
"RTN","PSOHLSN1",8,0)
 ;PSNDF-2195
"RTN","PSOHLSN1",9,0)
 ;EN^PSSUTIL1-3179
"RTN","PSOHLSN1",10,0)
 ;
"RTN","PSOHLSN1",11,0)
EN(PSRXIEN,STAT,PSSTAT,COMM,PSNOO) ;
"RTN","PSOHLSN1",12,0)
 N COUNT,DFN,J,LIMIT,NAME,NULLFLDS,PSDIEN,PSFLAG,PSND1,PSND2,PSND3,PRODUCT,UNIT,POIPTR,PSOHINST,PODOSE,PODOSENM,PSROUTE,RTNAME,SEGMENT,CCC,BBB,CSCOUNT,PPTR,MSG,PSOHSTRT,PSOHSTOP,PSOHISSD,PSORTLP,ZRXFLAG,RXE2FLAG,RXE2ONLY,PSODFN,EDUZ
"RTN","PSOHLSN1",13,0)
 N PSOCDDUZ,DA,FSIG,BSIG,PSHRX,PSHORX,PSNOOTX,ZPRE,PSOZSTAT,CCCX,PSOCPS,PSOICD
"RTN","PSOHLSN1",14,0)
 K FIELD
"RTN","PSOHLSN1",15,0)
 I $G(STAT)="" Q
"RTN","PSOHLSN1",16,0)
 I STAT="CR"!(STAT="DR")!(STAT="HR")!(STAT="OC")!(STAT="OD")!(STAT="OH")!(STAT="Z@")!(STAT="RP") S PSOZSTAT=STAT D DELP^PSOHLSN S STAT=PSOZSTAT G SKIP
"RTN","PSOHLSN1",17,0)
 I STAT="SC" I $G(PSSTAT)="ZE"!($G(PSSTAT)="HD")!($G(PSSTAT)="DC") S PSOZSTAT=STAT D DELP^PSOHLSN S STAT=PSOZSTAT
"RTN","PSOHLSN1",18,0)
SKIP ;
"RTN","PSOHLSN1",19,0)
 I $G(STAT)="SC",$G(PSSTAT)="ZE",$P($G(^PSRX(+$G(PSRXIEN),0)),"^",19)=2 Q
"RTN","PSOHLSN1",20,0)
 I $G(STAT)="RP" S STAT="OD",PSSTAT="RP"
"RTN","PSOHLSN1",21,0)
 S COUNT=0,NULLFLDS="F JJ=0:1:LIMIT S FIELD(JJ)="""""
"RTN","PSOHLSN1",22,0)
 I '$D(^PSRX(PSRXIEN,0)) Q
"RTN","PSOHLSN1",23,0)
 I STAT'="SN",STAT'="ZC",'$P($G(^PSRX(PSRXIEN,"OR1")),"^",2) Q
"RTN","PSOHLSN1",24,0)
 I $G(STAT)="SC",$G(PSSTAT)="ZE" S $P(^PSRX(PSRXIEN,0),"^",19)=2
"RTN","PSOHLSN1",25,0)
 D INIT
"RTN","PSOHLSN1",26,0)
 S COUNT=1,(ZRXFLAG,RXE2FLAG,RXE2ONLY)=0 D PID,PV1,ORC
"RTN","PSOHLSN1",27,0)
 I $G(STAT)="Z@" G NCM
"RTN","PSOHLSN1",28,0)
 I $G(STAT)="OK"!($G(STAT)="SN")!($G(STAT)="ZC")!($G(STAT)="XX")!($G(STAT)="SC")!($G(STAT)="RO") D RXO,RXE,RXR,ZRX,DG1,ZSC,ZCL G NCM
"RTN","PSOHLSN1",29,0)
 I $G(STAT)="SC",$G(PSSTAT)="CM" D RXO,RXE,RXR,ZRX,DG1,ZSC,ZCL
"RTN","PSOHLSN1",30,0)
 I '$G(RXE2FLAG) S RXE2ONLY=1 D RXE,SEGPARX^PSOHLSN
"RTN","PSOHLSN1",31,0)
 I '$G(ZRXFLAG) D ZRX
"RTN","PSOHLSN1",32,0)
NCM D SEND
"RTN","PSOHLSN1",33,0)
 K PSRXIEN Q
"RTN","PSOHLSN1",34,0)
INIT K ^UTILITY("DIQ1",$J),DIQ S DA=$P($$SITE^VASITE(),"^") I $G(DA) S DIC=4,DIQ(0)="I",DR="99" D EN^DIQ1 S PSOHINST=$G(^UTILITY("DIQ1",$J,4,DA,99,"I")) K ^UTILITY("DIQ1",$J),DA,DR,DIQ,DIC
"RTN","PSOHLSN1",35,0)
 S MSG(1)="MSH|^~\&|PHARMACY|"_$G(PSOHINST)_"|||||"_$S($G(PSOMSORR):"ORR",1:"ORM")
"RTN","PSOHLSN1",36,0)
 Q
"RTN","PSOHLSN1",37,0)
PID S LIMIT=5 X NULLFLDS
"RTN","PSOHLSN1",38,0)
 S DFN=+$P(^PSRX(PSRXIEN,0),"^",2) D DEM^VADPT S NAME=$G(VADM(1)) K VADM
"RTN","PSOHLSN1",39,0)
 S FIELD(0)="PID"
"RTN","PSOHLSN1",40,0)
 S FIELD(3)=DFN
"RTN","PSOHLSN1",41,0)
 S FIELD(5)=NAME
"RTN","PSOHLSN1",42,0)
 D SEG Q
"RTN","PSOHLSN1",43,0)
DG1 D DG1^PSOHLSN2
"RTN","PSOHLSN1",44,0)
 Q
"RTN","PSOHLSN1",45,0)
PV1 ;
"RTN","PSOHLSN1",46,0)
 S LIMIT=19 X NULLFLDS
"RTN","PSOHLSN1",47,0)
 S FIELD(0)="PV1"
"RTN","PSOHLSN1",48,0)
 S FIELD(2)="O"
"RTN","PSOHLSN1",49,0)
 S:$P(^PSRX(PSRXIEN,0),"^",5) FIELD(3)=$P(^(0),"^",5)
"RTN","PSOHLSN1",50,0)
 D SEG Q
"RTN","PSOHLSN1",51,0)
ORC ;
"RTN","PSOHLSN1",52,0)
 S LIMIT=15 X NULLFLDS
"RTN","PSOHLSN1",53,0)
 S FIELD(0)="ORC"
"RTN","PSOHLSN1",54,0)
 S FIELD(1)=$G(STAT)
"RTN","PSOHLSN1",55,0)
 I $G(STAT)'="SN",$G(STAT)'="ZC" S FIELD(2)=$P($G(^PSRX(PSRXIEN,"OR1")),"^",2)
"RTN","PSOHLSN1",56,0)
 S:FIELD(2)'="" FIELD(2)=FIELD(2)_$S($G(PLACERXX):";"_PLACERXX,1:"")_"^OR"
"RTN","PSOHLSN1",57,0)
 S FIELD(3)=PSRXIEN_"^PS"
"RTN","PSOHLSN1",58,0)
 S FIELD(5)=$G(PSSTAT)
"RTN","PSOHLSN1",59,0)
 I $G(STAT)="RO",$G(PSOROPCH)'="PATCH" S FIELD(5)="CM"
"RTN","PSOHLSN1",60,0)
 I $G(FIELD(5))="" I $G(STAT)="OR"!($G(STAT)="OE") S FIELD(5)="CM"
"RTN","PSOHLSN1",61,0)
 S X=$P($G(^PSRX(PSRXIEN,2)),"^") I X S FIELD(9)=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",62,0)
 S EDUZ=$P($G(^PSRX(PSRXIEN,0)),"^",16) I EDUZ S FIELD(10)=EDUZ_"^"_$P($G(^VA(200,EDUZ,0)),"^")
"RTN","PSOHLSN1",63,0)
 I $G(PSOCANRC),$G(PSOCANRN)'="" I $G(STAT)="OD"!($G(STAT)="OC") S FIELD(12)=$G(PSOCANRC)_"^"_$G(PSOCANRN)
"RTN","PSOHLSN1",64,0)
 I '$G(FIELD(12)) S FIELD(12)=$P($G(^PSRX(PSRXIEN,0)),"^",4)_"^"_$P($G(^VA(200,+$P($G(^PSRX(PSRXIEN,0)),"^",4),0)),"^")
"RTN","PSOHLSN1",65,0)
 S PSOHISSD="",X=$P($G(^PSRX(PSRXIEN,0)),"^",13) I X S PSOHISSD=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",66,0)
 S FIELD(15)=$G(PSOHISSD) K X
"RTN","PSOHLSN1",67,0)
 D SEG
"RTN","PSOHLSN1",68,0)
 I $G(COMM)'=""!($G(PSNOO)'="") D
"RTN","PSOHLSN1",69,0)
 .I $G(PSNOO)'="" D NOO
"RTN","PSOHLSN1",70,0)
 .I $L($G(COMM))+($L(MSG(COUNT)))+($L($G(PSNOOTX)))+($S($G(PSNOO)'="":11,1:5))<245 S MSG(COUNT)=MSG(COUNT)_"|"_$G(PSNOO)_"^"_$G(PSNOOTX)_"^"_$S($G(PSNOO)'="":"99ORN",1:"")_"^^"_$G(COMM)_"^" Q
"RTN","PSOHLSN1",71,0)
 .S MSG(COUNT,1)="|"_$G(PSNOO)_"^"_$G(PSNOOTX)_"^"_$S($G(PSNOO)'="":"99ORN",1:"")_"^^"_$G(COMM)_"^"
"RTN","PSOHLSN1",72,0)
 Q
"RTN","PSOHLSN1",73,0)
 ;
"RTN","PSOHLSN1",74,0)
RXO ;
"RTN","PSOHLSN1",75,0)
 S LIMIT=1 X NULLFLDS
"RTN","PSOHLSN1",76,0)
 S FIELD(0)="RXO"
"RTN","PSOHLSN1",77,0)
 S PPTR=+$P($G(^PSRX(PSRXIEN,"OR1")),"^")
"RTN","PSOHLSN1",78,0)
 S FIELD(1)=$S('PPTR:"^^^^^",1:"^^^"_PPTR_"^"_$P($G(^PS(50.7,PPTR,0)),"^")_" "_$P($G(^PS(50.606,+$P($G(^(0)),"^",2),0)),"^")_"^99PSP")
"RTN","PSOHLSN1",79,0)
 D SEG Q
"RTN","PSOHLSN1",80,0)
 ;
"RTN","PSOHLSN1",81,0)
RXE ;
"RTN","PSOHLSN1",82,0)
 S RXE2FLAG=1
"RTN","PSOHLSN1",83,0)
 S LIMIT=$S('$G(RXE2ONLY):26,1:2) X NULLFLDS
"RTN","PSOHLSN1",84,0)
 S FIELD(0)="RXE"
"RTN","PSOHLSN1",85,0)
 S (PSOHSTRT,PSOHSTOP)="" S X=$P($G(^PSRX(PSRXIEN,2)),"^",2) I X S PSOHSTRT=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",86,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOHLSN1",87,0)
 S X=$S($P($G(^PSRX(PSRXIEN,3)),"^",5):$P($G(^(3)),"^",5),$G(STAT)="OD"!($G(STAT)="OC"):$G(DT),$P($G(^(2)),"^",6):$P($G(^(2)),"^",6),1:$G(DT)) I X S PSOHSTOP=$$FMTHL7^XLFDT(X)
"RTN","PSOHLSN1",88,0)
 K X N PSOMZT,MMZZ,MMZZT S MMZZT=1 F MMZZ=0:0 S MMZZ=$O(^PSRX(PSRXIEN,6,MMZZ)) Q:'MMZZ  D:$D(^(MMZZ,0))
"RTN","PSOHLSN1",89,0)
 .S FIELD(1,MMZZT)=$S($P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",2):$P($G(^(0)),"^")_"&"_$P($G(^PS(50.607,+$P($G(^(0)),"^",3),0)),"^")_"&"_$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",2)_"&"_$P($G(^(0)),"^",4),1:"")_"^"_$P($G(^(0)),"^",8)
"RTN","PSOHLSN1",90,0)
 .I $P($G(FIELD(1,MMZZT)),"^")'="" F PSOMZT=1,3 I $E($P(FIELD(1,MMZZT),"&",PSOMZT),1)="." S $P(FIELD(1,MMZZT),"&",PSOMZT)="0"_$P(FIELD(1,MMZZT),"&",PSOMZT)
"RTN","PSOHLSN1",91,0)
 .S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"^"_$$DUR(PSRXIEN,MMZZ)_"^^^^^"_$S($P($G(FIELD(1,MMZZT)),"^")'="":$P($G(FIELD(1,MMZZT)),"&")_$P($G(FIELD(1,MMZZT)),"&",2),1:$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^"))
"RTN","PSOHLSN1",92,0)
 .S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"^"_$P($G(^PSRX(PSRXIEN,6,MMZZ,0)),"^",6)
"RTN","PSOHLSN1",93,0)
 .I $O(^PSRX(PSRXIEN,6,MMZZ)) S FIELD(1,MMZZT)=$G(FIELD(1,MMZZT))_"~"
"RTN","PSOHLSN1",94,0)
 .S MMZZT=MMZZT+1
"RTN","PSOHLSN1",95,0)
 S $P(FIELD(1,1),"^",4)=$G(PSOHSTRT),$P(FIELD(1,1),"^",5)=$G(PSOHSTOP)
"RTN","PSOHLSN1",96,0)
 S PSFLAG=0,PSDIEN=+$P(^PSRX(PSRXIEN,0),"^",6),PSND1=$P($G(^PSDRUG(PSDIEN,"ND")),"^"),PSND2=$P($G(^("ND")),"^",2),PSND3=$P($G(^("ND")),"^",3) I PSND1,PSND3 S PSFLAG=1
"RTN","PSOHLSN1",97,0)
 S FIELD(2)=$S(PSFLAG:PSND1_"."_PSND3_"^"_PSND2_"^"_"99NDF",1:"^^")_"^"_PSDIEN_"^"_$P($G(^PSDRUG(PSDIEN,0)),"^")_"^"_"99PSD"
"RTN","PSOHLSN1",98,0)
 Q:$G(RXE2ONLY)
"RTN","PSOHLSN1",99,0)
 I PSFLAG D
"RTN","PSOHLSN1",100,0)
 .I $T(^PSNAPIS)]"" S PSOXN=$$DFSU^PSNAPIS(PSND1,PSND3) S FIELD(5)="^^^"_$P($G(PSOXN),"^",5)_"^"_$P($G(PSOXN),"^",6)_"^"_"99PSU" K PSOXN Q
"RTN","PSOHLSN1",101,0)
 .S PRODUCT=$G(^PSNDF(PSND1,5,PSND3,0)) S UNIT=$P($G(^PSNDF(PSND1,2,+$P(PRODUCT,"^",2),3,+$P(PRODUCT,"^",3),4,+$P(PRODUCT,"^",4),0)),"^")
"RTN","PSOHLSN1",102,0)
 .S FIELD(5)="^^^"_UNIT_"^"_$P($G(^PS(50.607,+UNIT,0)),"^")_"^"_"99PSU"
"RTN","PSOHLSN1",103,0)
 S POIPTR=$P($G(^PSRX(PSRXIEN,"OR1")),"^") I POIPTR S PODOSE=$P($G(^PS(50.7,POIPTR,0)),"^",2),PODOSENM=$P($G(^PS(50.606,+PODOSE,0)),"^")
"RTN","PSOHLSN1",104,0)
 I POIPTR S FIELD(6)="^^^"_$G(PODOSE)_"^"_$G(PODOSENM)_"^"_"99PSF"
"RTN","PSOHLSN1",105,0)
 S FIELD(10)=$P(^PSRX(PSRXIEN,0),"^",7)
"RTN","PSOHLSN1",106,0)
 S FIELD(12)=$P(^PSRX(PSRXIEN,0),"^",9)
"RTN","PSOHLSN1",107,0)
 S FIELD(14)=$P(^PSRX(PSRXIEN,0),"^",4)
"RTN","PSOHLSN1",108,0)
 S FIELD(15)=$P(^PSRX(PSRXIEN,0),"^")
"RTN","PSOHLSN1",109,0)
 S FIELD(22)=$P(^PSRX(PSRXIEN,0),"^",8)
"RTN","PSOHLSN1",110,0)
 K MMZZ S MMZZ=$$EN^PSSUTIL1(PSDIEN) S FIELD(25)=$S($E($P(MMZZ,"|"),1)=".":"0",1:"")_$P(MMZZ,"|"),FIELD(26)=$P(MMZZ,"|",2)
"RTN","PSOHLSN1",111,0)
 N PLIM,PVAR,PVAR1,SUBCOUNT D SEGPARX^PSOHLSN
"RTN","PSOHLSN1",112,0)
 ;
"RTN","PSOHLSN1",113,0)
 I $O(^PSRX(PSRXIEN,"PRC",0)) D
"RTN","PSOHLSN1",114,0)
 .S COUNT=COUNT+1,CCC=$O(^PSRX(PSRXIEN,"PRC",0))
"RTN","PSOHLSN1",115,0)
 .S MSG(COUNT)="NTE|6||"_$G(^PSRX(PSRXIEN,"PRC",CCC,0))
"RTN","PSOHLSN1",116,0)
 .S CSCOUNT=1 F CCC=CCC:0 S CCC=$O(^PSRX(PSRXIEN,"PRC",CCC)) Q:'CCC  S MSG(COUNT,CSCOUNT)=$G(^PSRX(PSRXIEN,"PRC",CCC,0)),CSCOUNT=CSCOUNT+1
"RTN","PSOHLSN1",117,0)
 I $O(^PSRX(PSRXIEN,"INS1",0)) D
"RTN","PSOHLSN1",118,0)
 .S COUNT=COUNT+1,CCC=$O(^PSRX(PSRXIEN,"INS1",0))
"RTN","PSOHLSN1",119,0)
 .S MSG(COUNT)="NTE|7|L|"_$G(^PSRX(PSRXIEN,"INS1",CCC,0))
"RTN","PSOHLSN1",120,0)
 .S CCCX=1 F CCC=CCC:0 S CCC=$O(^PSRX(PSRXIEN,"INS1",CCC,0)) Q:'CCC  I $D(^(0)) S MSG(COUNT,CCCX)=$G(^(0)) S CCCX=CCCX+1
"RTN","PSOHLSN1",121,0)
 S COUNT=COUNT+1
"RTN","PSOHLSN1",122,0)
 I $P($G(^PSRX(PSRXIEN,"SIG")),"^",2) D  Q
"RTN","PSOHLSN1",123,0)
 .D FSIG^PSOUTLA("R",PSRXIEN,238) S MSG(COUNT)="NTE|21||"_$S($G(FSIG(1))'="":$G(FSIG(1)),1:"No SIG available") I $O(FSIG(1)) F CCC=1:0 S CCC=$O(FSIG(CCC)) Q:'CCC  S MSG(COUNT,(CCC-1))=$G(FSIG(CCC))
"RTN","PSOHLSN1",124,0)
 I '$P($G(^PSRX(PSRXIEN,"SIG")),"^",2) D  Q
"RTN","PSOHLSN1",125,0)
 .D EN3^PSOUTLA1(PSRXIEN,238) S MSG(COUNT)="NTE|21||"_$S($G(BSIG(1))'="":$G(BSIG(1)),1:"No SIG available") I $O(BSIG(1)) F CCC=1:0 S CCC=$O(BSIG(CCC)) Q:'CCC  S MSG(COUNT,(CCC-1))=$G(BSIG(CCC))
"RTN","PSOHLSN1",126,0)
 Q
"RTN","PSOHLSN1",127,0)
 ;
"RTN","PSOHLSN1",128,0)
RXR ;
"RTN","PSOHLSN1",129,0)
 F PSORTLP=0:0 S PSORTLP=$O(^PSRX(PSRXIEN,6,PSORTLP)) Q:'PSORTLP  D
"RTN","PSOHLSN1",130,0)
 .S LIMIT=1 X NULLFLDS
"RTN","PSOHLSN1",131,0)
 .S FIELD(0)="RXR"
"RTN","PSOHLSN1",132,0)
 .S PSROUTE=$P($G(^PSRX(PSRXIEN,6,PSORTLP,0)),"^",7) I PSROUTE,$D(^PS(51.2,PSROUTE,0))  S RTNAME=$P(^PS(51.2,PSROUTE,0),"^")
"RTN","PSOHLSN1",133,0)
 .S FIELD(1)="^^^"_$G(PSROUTE)_"^"_$G(RTNAME)_"^"_"99PSR"
"RTN","PSOHLSN1",134,0)
 .D SEG
"RTN","PSOHLSN1",135,0)
 Q
"RTN","PSOHLSN1",136,0)
 ;
"RTN","PSOHLSN1",137,0)
ZCL D ZCL^PSOHLSN2
"RTN","PSOHLSN1",138,0)
 Q
"RTN","PSOHLSN1",139,0)
ZSC D ZSC^PSOHLSN2
"RTN","PSOHLSN1",140,0)
 Q
"RTN","PSOHLSN1",141,0)
 ;
"RTN","PSOHLSN1",142,0)
ZRX ;
"RTN","PSOHLSN1",143,0)
 S ZRXFLAG=1
"RTN","PSOHLSN1",144,0)
 S LIMIT=6 X NULLFLDS
"RTN","PSOHLSN1",145,0)
 S FIELD(0)="ZRX"
"RTN","PSOHLSN1",146,0)
 S ZPRE=$P($G(^PSRX(PSRXIEN,"OR1")),"^",3) I ZPRE S FIELD(1)=$P($G(^PSRX(ZPRE,"OR1")),"^",2)
"RTN","PSOHLSN1",147,0)
 I '$G(FIELD(1)),$G(PSORDEDT) S FIELD(1)=$P($G(^PS(52.41,$G(PSORDEDT),0)),"^")
"RTN","PSOHLSN1",148,0)
 S FIELD(2)=$G(PSNOO)
"RTN","PSOHLSN1",149,0)
 I $G(STAT)="SN"!($G(STAT)="RO") S FIELD(3)=$S($G(STAT)="RO"!($G(PSOEDIT)):"E",$G(PSOOPT)=3:"R",1:"N")
"RTN","PSOHLSN1",150,0)
 S FIELD(4)=$P(^PSRX(PSRXIEN,0),"^",11)
"RTN","PSOHLSN1",151,0)
 S PSOCDDUZ=$S($G(PSOROPCH)="PATCH":$P($G(^PSRX(PSRXIEN,"OR1")),"^",5),$G(PSOHUIOR)&($P($G(^PSRX(PSRXIEN,"EXT")),"^")'=""):+$G(PSOCANRC),1:$G(DUZ))
"RTN","PSOHLSN1",152,0)
 I $G(PSOCDDUZ) S FIELD(5)=PSOCDDUZ_"^"_$P($G(^VA(200,PSOCDDUZ,0)),"^")_"^"_"99NP"
"RTN","PSOHLSN1",153,0)
 I $G(STAT)="ZD",$G(PSODISPP) S FIELD(6)="P"
"RTN","PSOHLSN1",154,0)
 D SEG Q
"RTN","PSOHLSN1",155,0)
SEG S SEGMENT="" F J=0:1:LIMIT S SEGMENT=$S(SEGMENT="":FIELD(J),1:SEGMENT_"|"_FIELD(J))
"RTN","PSOHLSN1",156,0)
 S COUNT=COUNT+1,MSG(COUNT)=SEGMENT
"RTN","PSOHLSN1",157,0)
 Q
"RTN","PSOHLSN1",158,0)
SEND D:$G(PSRXIEN)&($T(EN^PSOHDR)]"")&($G(PSOSSMES)'="CPRSUP")  K FIELD D MSG^XQOR("PS EVSEND OR",.MSG) Q
"RTN","PSOHLSN1",159,0)
 .I $G(STAT)="ZC"!($G(STAT)="UC")!($G(STAT)="UD")!($G(STAT)="UH")!($G(STAT)="UR")!($G(STAT)="DE")!($G(STAT)="ZD")!($G(STAT)="SN")!($G(STAT)="Z@") Q
"RTN","PSOHLSN1",160,0)
 .I $G(STAT)="SC",$G(PSSTAT)="ZZ" Q
"RTN","PSOHLSN1",161,0)
 .D EN^PSOHDR("PRES",PSRXIEN)
"RTN","PSOHLSN1",162,0)
 ;
"RTN","PSOHLSN1",163,0)
NOO ;
"RTN","PSOHLSN1",164,0)
 I $G(PSNOO)="" S PSNOOTX="" Q
"RTN","PSOHLSN1",165,0)
 S PSNOOTX=$S(PSNOO="W":"Written",PSNOO="V":"Verbal",PSNOO="P":"Telephoned",PSNOO="S":"Service Correction",PSNOO="X":"Rejected",PSNOO="D":"Duplicate",PSNOO="I":"Policy",PSNOO="E":"Physician Entered",PSNOO="A":"Auto DC",1:"") Q
"RTN","PSOHLSN1",166,0)
 Q
"RTN","PSOHLSN1",167,0)
 ;
"RTN","PSOHLSN1",168,0)
DUR(PSODX1,PSODX2) ;
"RTN","PSOHLSN1",169,0)
 N PSODX,PSODX4,PSODX5,PSODX6,PSODX7 S PSODX=$P($G(^PSRX(PSODX1,6,PSODX2,0)),"^",5)
"RTN","PSOHLSN1",170,0)
 I 'PSODX Q PSODX
"RTN","PSOHLSN1",171,0)
 S PSODX4=$L(PSODX),PSODX5=$E(PSODX,PSODX4)
"RTN","PSOHLSN1",172,0)
 S PSODX=$S(PSODX5?1A:PSODX,1:PSODX_"D")
"RTN","PSOHLSN1",173,0)
 S PSODX6=$L(PSODX)
"RTN","PSOHLSN1",174,0)
 S PSODX7=$E(PSODX,PSODX6)_$E(PSODX,1,(PSODX6-1))
"RTN","PSOHLSN1",175,0)
 Q PSODX7
"RTN","PSOHLSN1",176,0)
 Q
"RTN","PSOHLSN2")
0^20^B9304423^B4326292
"RTN","PSOHLSN2",1,0)
PSOHLSN2 ;BIR/LE - Utilities for PSOHLSN1 ;02/27/04
"RTN","PSOHLSN2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,226,239**;DEC 1997
"RTN","PSOHLSN2",3,0)
 ;
"RTN","PSOHLSN2",4,0)
DG1 ;this section builds both DG1 segments 
"RTN","PSOHLSN2",5,0)
 Q:'$D(^PSRX(PSRXIEN,"ICD",1,0))
"RTN","PSOHLSN2",6,0)
 N LP,DG,DXDESC,I
"RTN","PSOHLSN2",7,0)
 S LIMIT=4,FIELD(0)="DG1",FIELD(4)=""
"RTN","PSOHLSN2",8,0)
 ;I '$D(^PSRX(PSRXIEN,"ICD",1,0)) S FIELD(1)=1,FIELD(2)="",FIELD(3)="^^^^^" D SEG^PSOHLSN1 Q
"RTN","PSOHLSN2",9,0)
 I $P(^PSRX(PSRXIEN,"ICD",1,0),"^",1)="" Q  ;S FIELD(1)=1,FIELD(2)="",FIELD(3)="^^^^^" D SEG^PSOHLSN1 Q
"RTN","PSOHLSN2",10,0)
 F I=1:1:8 D
"RTN","PSOHLSN2",11,0)
 . Q:'$D(^PSRX(PSRXIEN,"ICD",I,0))
"RTN","PSOHLSN2",12,0)
 . S PSOICD="",PSOICD=^PSRX(PSRXIEN,"ICD",I,0) Q:$P(PSOICD,U,1)=""
"RTN","PSOHLSN2",13,0)
 . S (DG,DXDESC)=""
"RTN","PSOHLSN2",14,0)
 . I $P(PSOICD,U,1)'="" D
"RTN","PSOHLSN2",15,0)
 .. S DXDESC=$$GET1^DIQ(80,$P(PSOICD,U,1)_",",10),FIELD(1)=I,FIELD(2)=""
"RTN","PSOHLSN2",16,0)
 .. S FIELD(3)=$P(PSOICD,U,1)_U_DXDESC_U_"80"_U_$$GET1^DIQ(80,$P(PSOICD,U,1)_",",.01)_U_DXDESC_U_"ICD9"
"RTN","PSOHLSN2",17,0)
 .. D SEG^PSOHLSN1
"RTN","PSOHLSN2",18,0)
 K PSOICD("K")
"RTN","PSOHLSN2",19,0)
 Q
"RTN","PSOHLSN2",20,0)
ZCL N STOP,IBQ,ICD,I,JJJ,EI
"RTN","PSOHLSN2",21,0)
 S LIMIT=3,FIELD(0)="ZCL"
"RTN","PSOHLSN2",22,0)
 I '$D(^PSRX(PSRXIEN,"ICD"))&($D(^PSRX(PSRXIEN,"IBQ"))) D    ;For edits; currently CPRS doesn't update SC/EI for edits, but just in case they start
"RTN","PSOHLSN2",23,0)
 . S FIELD(1)=1,FIELD(2)=3
"RTN","PSOHLSN2",24,0)
 . S EI="",EI=^PSRX(PSRXIEN,"IBQ")
"RTN","PSOHLSN2",25,0)
 . S JJJ=0 F I=3,4,1,5,2,6,7 S JJJ=JJJ+1,FIELD(3)=$P(EI,U,I) S FIELD(1)=1,FIELD(2)=JJJ D SEG^PSOHLSN1
"RTN","PSOHLSN2",26,0)
 E  F I=1:1:8 D
"RTN","PSOHLSN2",27,0)
 . Q:'$D(^PSRX(PSRXIEN,"ICD",I,0))
"RTN","PSOHLSN2",28,0)
 . S PSOICD=^PSRX(PSRXIEN,"ICD",I,0),ICD=$P(PSOICD,"^",1)
"RTN","PSOHLSN2",29,0)
 . Q:ICD=""&(I>1)
"RTN","PSOHLSN2",30,0)
 . F JJJ=2:1:8 S EI=$P(PSOICD,U,JJJ),FIELD(2)=JJJ-1 D
"RTN","PSOHLSN2",31,0)
 .. S FIELD(1)=$S(ICD="":1,1:I)
"RTN","PSOHLSN2",32,0)
 .. ;S FIELD(3)=$S(EI=1:EI,1:0)
"RTN","PSOHLSN2",33,0)
 .. S FIELD(3)=$S(EI=1:EI,EI=0:EI,1:"")
"RTN","PSOHLSN2",34,0)
 .. D SEG^PSOHLSN1
"RTN","PSOHLSN2",35,0)
 K PSOICD
"RTN","PSOHLSN2",36,0)
 Q
"RTN","PSOHLSN2",37,0)
 ;CPRS doesn't look at the ZCL segment when thier CIDC switch is off.  Always send both ZCL and ZSC for consistency
"RTN","PSOHLSN2",38,0)
ZSC S PSOCPS=$$DT^PSOMLLDT S LIMIT=$S($G(PSOCPS):7,1:1) X NULLFLDS
"RTN","PSOHLSN2",39,0)
 S FIELD(0)="ZSC"
"RTN","PSOHLSN2",40,0)
 I '$D(^PSRX(PSRXIEN,"ICD",1,0)) D
"RTN","PSOHLSN2",41,0)
 . I '$G(PSOCPS) S FIELD(1)=$S($P($G(^PSRX(PSRXIEN,"IB")),"^"):"NSC",1:"SC")
"RTN","PSOHLSN2",42,0)
 . I $G(PSOCPS) D
"RTN","PSOHLSN2",43,0)
 .. S FIELD(1)=$P($G(^PSRX(PSRXIEN,"IBQ")),"^"),FIELD(2)=$P($G(^("IBQ")),"^",2),FIELD(3)=$P($G(^("IBQ")),"^",3),FIELD(4)=$P($G(^("IBQ")),"^",4),FIELD(5)=$P($G(^("IBQ")),"^",5),FIELD(6)=$P($G(^("IBQ")),"^",6),FIELD(7)=$P($G(^("IBQ")),"^",7)
"RTN","PSOHLSN2",44,0)
 .D SEG^PSOHLSN1
"RTN","PSOHLSN2",45,0)
 N JJJ,PSOICD
"RTN","PSOHLSN2",46,0)
 I $D(^PSRX(PSRXIEN,"ICD",1,0)) D
"RTN","PSOHLSN2",47,0)
 . S PSOICD=$G(^PSRX(PSRXIEN,"ICD",1,0))
"RTN","PSOHLSN2",48,0)
 . F JJJ=2:1:8 D
"RTN","PSOHLSN2",49,0)
 .. I JJJ=2 S FIELD(3)=$P(PSOICD,"^",JJJ)  ;AO
"RTN","PSOHLSN2",50,0)
 .. I JJJ=3 S FIELD(4)=$P(PSOICD,"^",JJJ)  ;IR
"RTN","PSOHLSN2",51,0)
 .. I JJJ=4 S FIELD(1)=$P(PSOICD,"^",JJJ)  ;SC
"RTN","PSOHLSN2",52,0)
 .. I JJJ=5 S FIELD(5)=$P(PSOICD,"^",JJJ)  ;EC
"RTN","PSOHLSN2",53,0)
 .. I JJJ=6 S FIELD(2)=$P(PSOICD,"^",JJJ)  ;MST
"RTN","PSOHLSN2",54,0)
 .. I JJJ=7 S FIELD(6)=$P(PSOICD,"^",JJJ)  ;HNC
"RTN","PSOHLSN2",55,0)
 .. I JJJ=8 S FIELD(7)=$P(PSOICD,"^",JJJ)  ;CV
"RTN","PSOHLSN2",56,0)
 . D SEG^PSOHLSN1
"RTN","PSOHLSN2",57,0)
 Q
"RTN","PSOMLLD2")
0^15^B18734428^B22361376
"RTN","PSOMLLD2",1,0)
PSOMLLD2 ;BIR/LE - Service Connection Check for SC>50% ;02/27/04
"RTN","PSOMLLD2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,219,239**;DEC 1997
"RTN","PSOMLLD2",3,0)
 ;External reference SDC022 supported by DBIA 1579
"RTN","PSOMLLD2",4,0)
 ;External reference DIS^SDROUT2 private by DBIA 112
"RTN","PSOMLLD2",5,0)
SC ;This routine is used for SC>50% - OUTSIDE OF COPAY - DFN AND PSOSCP VARIABLES ARE EXPECTED TO BE PRESENT WHEN CALLED
"RTN","PSOMLLD2",6,0)
 ; Requires: DFN, PSOSCP, PSOSCA 
"RTN","PSOMLLD2",7,0)
 I '$G(DFN) N DFN S DFN=+$G(PSODFN)
"RTN","PSOMLLD2",8,0)
 ;I $G(DFN) I '$$SC^SDCO22(DFN) D  Q  ;if SC>49 don't ask if api says not to
"RTN","PSOMLLD2",9,0)
 ;. K PSOANSQ("SC>50"),PSOANSQD("SC>50") I $G(PSOX("IRXN")) K PSOANSQ(PSOX("IRXN"),"SC>50")
"RTN","PSOMLLD2",10,0)
SC2 I $G(PSOMESOI)=1,$G(PSORXED) W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESOI=2
"RTN","PSOMLLD2",11,0)
 I $G(PSOMESFI)=1 W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESFI=2
"RTN","PSOMLLD2",12,0)
 D DIS^SDROUT2
"RTN","PSOMLLD2",13,0)
 N PSOUFLAG S PSOUFLAG=0 K DIR S DIR(0)="Y"
"RTN","PSOMLLD2",14,0)
 S DIR("A")="Was treatment for a Service Connected condition"
"RTN","PSOMLLD2",15,0)
 S DIR("?")=" ",DIR("?",1)="Enter 'Yes' if this prescription is being used to treat a condition related",DIR("?",2)="to Service Connected."
"RTN","PSOMLLD2",16,0)
 I '$G(PSOFLAG) D
"RTN","PSOMLLD2",17,0)
 . I PSOSCP<50 S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=1:"YES",1:"") I DIR("B")="" K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",18,0)
 . I PSOSCP<50&($D(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))) S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=1:"YES",1:"") I DIR("B")=""  K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",19,0)
 . I PSOSCP>49 S (DIR("B"),PSOUFLAG)=$S($G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=0:"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC>50"))=1:"YES",1:"") I DIR("B")=""  K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",20,0)
 . I '$D(DIR("B"))&($D(PSOANSQD("SC>50"))!($D(PSOANSQD("SC")))) D  I '$D(DIR("B")) K DIR("B") S PSOUFLAG=0
"RTN","PSOMLLD2",21,0)
 .. I $D(PSOANSQD("SC>50")) I $G(PSOANSQD("SC>50"))=0!($G(PSOANSQD("SC>50"))=1) S (PSOUFLAG,DIR("B"))=$S($G(PSOANSQD("SC>50"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",22,0)
 .. I $D(PSOANSQD("SC")) I $G(PSOANSQD("SC"))=0!($G(PSOANSQD("SC"))=1) S (PSOUFLAG,DIR("B"))=$S($G(PSOANSQD("SC"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",23,0)
 I $G(PSORX("SC"))]""!($G(PSORX(+$G(PSORENW("OIRXN")),"SC"))'="") S DIR("B")=$S($G(PSORX("SC"))="SC":"YES",$G(PSORX("SC"))="NSC":"NO",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=1:"YES",$G(PSORX(+$G(PSORENW("OIRXN")),"SC"))=0:"NO",1:"")
"RTN","PSOMLLD2",24,0)
 ;
"RTN","PSOMLLD2",25,0)
 I $G(PSOFLAG),$G(PSONEWFF) I $G(PSOANSQD("SC>50"))=0!($G(PSOANSQD("SC>50"))=1) S DIR("B")=$S($G(PSOANSQD("SC>50"))=1:"YES",1:"NO")
"RTN","PSOMLLD2",26,0)
 I $G(DIR("B"))="YES"!($G(DIR("B"))="NO") S PSOUFLAG=$G(DIR("B"))
"RTN","PSOMLLD2",27,0)
 I $G(DIR("B"))="" K DIR("B")
"RTN","PSOMLLD2",28,0)
 W ! D ^DIR K DIR
"RTN","PSOMLLD2",29,0)
 I $G(Y)=1!($G(Y)=0) D  I $G(PSONEWFF),$G(PSOFLAG) S PSOANSQD("SC>50")=$G(Y)
"RTN","PSOMLLD2",30,0)
 . I $G(PSOX("IRXN")) S PSOANSQ(PSOX("IRXN"),"SC>50")=+Y
"RTN","PSOMLLD2",31,0)
 . S PSOANSQ("SC>50")=+Y
"RTN","PSOMLLD2",32,0)
 I PSOFLAG I Y["^"!($D(DTOUT))!($D(DUOUT)) S PSOCPZ("DFLG")=1
"RTN","PSOMLLD2",33,0)
 S:Y=0 Y=2
"RTN","PSOMLLD2",34,0)
 S PSOANSR=+Y I 'PSOANSR,'PSOFLAG D  S $P(PSOCPAY,"^")=$S($G(PSOUFLAG)="NO":1,1:0) W ! K DIR S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR Q
"RTN","PSOMLLD2",35,0)
 .W !!,"This Renewal has been designated as "_$S($G(PSOUFLAG)="YES":"SERVICE CONNECTED",1:"NON-SERVICE CONNECTED.")
"RTN","PSOMLLD2",36,0)
 .;W !,"Please use the 'Reset Copay Status/Cancel Charges' option to make  corrections."
"RTN","PSOMLLD2",37,0)
 .S PSOANSQ("SC>50")=$S($G(PSOUFLAG)="YES":1,1:0)
"RTN","PSOMLLD2",38,0)
 I $G(PSOFLAG),$G(PSOCPZ("DFLG")) G EXIT
"RTN","PSOMLLD2",39,0)
 S:PSOANSR=1 PSOCPAY=0 S:PSOANSR=2 $P(PSOCPAY,"^")=1
"RTN","PSOMLLD2",40,0)
EXIT ;
"RTN","PSOMLLD2",41,0)
 K PSOANSR,DIR,DUOUT,DIRUT,DTOUT,Y,X,PSOSCA
"RTN","PSOMLLD2",42,0)
 Q
"RTN","PSOMLLD2",43,0)
 ;
"RTN","PSOMLLD2",44,0)
PAUSE K DIR W ! S DIR(0)="E",DIR("A")="Press Return to continue" D ^DIR K DIR
"RTN","PSOMLLD2",45,0)
 Q
"RTN","PSOMLLD2",46,0)
 ;
"RTN","PSON52")
0^5^B58876503^B59165642
"RTN","PSON52",1,0)
PSON52 ;BIR/DSD - files new entries in prescription file ;08/09/93
"RTN","PSON52",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,16,23,27,32,46,71,111,124,117,131,139,157,143,219,148,239**;DEC 1997
"RTN","PSON52",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSON52",4,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSON52",5,0)
 ;External reference to ^XUSEC supported by DBIA 10076
"RTN","PSON52",6,0)
EN(PSOX) ;Entry Point
"RTN","PSON52",7,0)
START ;
"RTN","PSON52",8,0)
 D:$D(XRTL) T0^%ZOSV ; Start RT Monitor
"RTN","PSON52",9,0)
 D INIT G:PSON52("QFLG") END D NFILE Q:$G(PSONEW("DFLG"))  D PS55,DIK
"RTN","PSON52",10,0)
 S:$D(XRT0) XRTN=$T(+0) D:$D(XRT0) T1^%ZOSV ; Stop RT Monitor
"RTN","PSON52",11,0)
 D FINISH
"RTN","PSON52",12,0)
 I $P(^PSRX(PSOX("IRXN"),0),"^",11)="W",$G(^("IB")) S ^PSRX("ACP",$P(^PSRX(PSOX("IRXN"),0),"^",2),$P(^(2),"^",2),0,PSOX("IRXN"))=""
"RTN","PSON52",13,0)
END D EOJ
"RTN","PSON52",14,0)
 Q
"RTN","PSON52",15,0)
INIT ;
"RTN","PSON52",16,0)
 K X,%DT S:$G(PSOID) PSOX("ISSUE DATE")=PSOID
"RTN","PSON52",17,0)
 S PSOX("CS")=0
"RTN","PSON52",18,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S $P(PSOX("CS"),"^")=1 S:$E(+PSODRUG("DEA"),DEA)=2 $P(PSOX("CS"),"^",2)=1
"RTN","PSON52",19,0)
 S PSON52("QFLG")=0,X1=PSOX("ISSUE DATE"),X2=PSOX("DAYS SUPPLY")*(PSOX("# OF REFILLS")+1)\1
"RTN","PSON52",20,0)
 I $D(CLOZPAT) S X2=$S(X2=14:14,X2=7:7,1:X2) G DT
"RTN","PSON52",21,0)
 S X2=$S(PSOX("DAYS SUPPLY")=X2:X2,+$G(PSOX("CS")):184,+$G(DEA("CS")):184,1:366)
"RTN","PSON52",22,0)
 I X2<30 D
"RTN","PSON52",23,0)
 . N % S %=$P($G(PSORX("PATIENT STATUS")),"^"),X2=30
"RTN","PSON52",24,0)
 . S:%?.N %=$P($G(^PS(53,+%,0)),"^") I %["AUTH ABS" S X2=5
"RTN","PSON52",25,0)
DT D C^%DTC S PSOX("STOP DATE")=$P(X,".") K X
"RTN","PSON52",26,0)
 I PSOX("# OF REFILLS")>0 S X1=PSOX("FILL DATE"),X2=$S((PSOX("DAYS SUPPLY")-10\1)<1:1,1:PSOX("DAYS SUPPLY")-10\1) D C^%DTC S PSOX("NEXT POSSIBLE REFILL")=$P(X,".") K X
"RTN","PSON52",27,0)
 S PSOX("TYPE OF RX")=0,PSOX("DISPENSED DATE")=PSOX("FILL DATE") D NOW^%DTC S PSOX("LOGIN DATE")=$S($P($G(OR0),"^",12):$P($G(OR0),"^",12),1:%) K %,X
"RTN","PSON52",28,0)
 S PSOX("STATUS")=$S($G(PSOX("STATUS"))]"":PSOX("STATUS"),$D(PSORX("VERIFY")):1,1:0)
"RTN","PSON52",29,0)
 S PSOX("COPIES")=$S($G(PSOX("COPIES"))]"":PSOX("COPIES"),1:1)
"RTN","PSON52",30,0)
 I $G(PSORX("PHARM"))]"" S PSOX("PHARMACIST")=PSORX("PHARM") K PSORX("PHARM")
"RTN","PSON52",31,0)
INITX Q
"RTN","PSON52",32,0)
 ;
"RTN","PSON52",33,0)
NFILE I $G(OR0) D  Q:$G(PSONEW("DFLG"))
"RTN","PSON52",34,0)
 .D NOOR^PSONEW Q:$G(PSONEW("DFLG"))
"RTN","PSON52",35,0)
 .I $G(PSOSIGFL)!($G(PSODRUG("OI"))'=$P(OR0,"^",8)) S PSONEW("CLERK CODE")=DUZ,PSONEW("REMARKS")=$G(PSONEW("REMARKS"))_" CPRS Order #"_$P(OR0,"^")_" Edited."
"RTN","PSON52",36,0)
 S DIC="^PSRX(",DLAYGO=52,DIC(0)="L",X=PSOX("RX #") K DD,DO D FILE^DICN S PSOX("IRXN")=+Y K DLAYGO,X,Y,DIC,DD,DO D:+$G(DGI) TECH^PSODGDGI
"RTN","PSON52",37,0)
 F PSOX1=0:1 S PSON52=$P($T(DD+PSOX1),";;",2,4) Q:PSON52=""  K PSOY S PSOY=$P(PSON52,";;") I $G(@PSOY)]"" S $P(PSON52(PSOX("IRXN"),$P(PSON52,";;",2)),"^",$P(PSON52,";;",3))=@PSOY
"RTN","PSON52",38,0)
 F I=1:1:PSOX("ENT") S ^PSRX(PSOX("IRXN"),6,I,0)=PSOX("DOSE",I)_"^"_$G(PSOX("DOSE ORDERED",I))_"^"_$G(PSOX("UNITS",I))_"^"_$G(PSOX("NOUN",I))_"^" D
"RTN","PSON52",39,0)
 .S ^PSRX(PSOX("IRXN"),6,I,0)=^PSRX(PSOX("IRXN"),6,I,0)_$G(PSOX("DURATION",I))_"^"_$G(PSOX("CONJUNCTION",I))_"^"_$G(PSOX("ROUTE",I))_"^"_$G(PSOX("SCHEDULE",I))_"^"_$G(PSOX("VERB",I))
"RTN","PSON52",40,0)
 .I $G(PSOX("ODOSE",I))]"" S ^PSRX(PSOX("IRXN"),6,I,1)=PSOX("ODOSE",I)
"RTN","PSON52",41,0)
 S ^PSRX(PSOX("IRXN"),6,0)="^52.0113^"_PSOX("ENT")_"^"_PSOX("ENT")
"RTN","PSON52",42,0)
 K PSOX1,PSOY
"RTN","PSON52",43,0)
 S PSOX1="" F  S PSOX1=$O(PSON52(PSOX("IRXN"),PSOX1)) Q:PSOX1=""  S ^PSRX(PSOX("IRXN"),PSOX1)=$G(PSON52(PSOX("IRXN"),PSOX1))
"RTN","PSON52",44,0)
 I $O(PSOX("SIG",0)) D
"RTN","PSON52",45,0)
 .S D=0 F  S D=$O(PSOX("SIG",D)) Q:'D  S ^PSRX(PSOX("IRXN"),"INS1",D,0)=PSOX("SIG",D),TP=$G(TP)+1
"RTN","PSON52",46,0)
 .S ^PSRX(PSOX("IRXN"),"INS1",0)="^52.0115^"_TP_"^"_TP_"^"_DT_"^^" K TP,D
"RTN","PSON52",47,0)
 I $G(PSOX("SINS"))]"" S ^PSRX(PSOX("IRXN"),"INSS")=PSOX("SINS")
"RTN","PSON52",48,0)
 I $G(SIGOK) D
"RTN","PSON52",49,0)
 .S $P(^PSRX(PSOX("IRXN"),"SIG"),"^",2)=1,^PSRX(PSOX("IRXN"),"SIG1",0)="^52.04A^^"
"RTN","PSON52",50,0)
 .S D=0 F  S D=$O(SIG(D)) Q:'D  S ^PSRX(PSOX("IRXN"),"SIG1",D,0)=SIG(D),$P(^PSRX(PSOX("IRXN"),"SIG1",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"SIG1",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1 Q:'$O(SIG(D))
"RTN","PSON52",51,0)
 .K SIG
"RTN","PSON52",52,0)
 I $D(PSOINSFL) S ^PSRX(PSOX("IRXN"),"A",0)="^52.3DA^1^1",^PSRX(PSOX("IRXN"),"A",1,0)=DT_"^G^^0^Patient Instructions "_$S(PSOINSFL=1:"",1:"Not ")_"Sent By Provider."
"RTN","PSON52",53,0)
 I $G(OR0) S:$P(OR0,"^",24) ^PSRX(PSOX("IRXN"),"PKI")=1
"RTN","PSON52",54,0)
 K PSOX1,PSOFINFL,HLDSIG,D,PSOINSFL,D
"RTN","PSON52",55,0)
 D:$G(^TMP("PSODAI",$J,0))
"RTN","PSON52",56,0)
 .S $P(^PSRX(PSOX("IRXN"),3),"^",6)=1
"RTN","PSON52",57,0)
 .I $O(^TMP("PSODAI",$J,0)) S DAI=0 F  S DAI=$O(^TMP("PSODAI",$J,DAI)) Q:'DAI  D
"RTN","PSON52",58,0)
 ..S:'$D(^PSRX(PSOX("IRXN"),"DAI",0)) ^PSRX(PSOX("IRXN"),"DAI",0)="^52.03^^" S ^PSRX(PSOX("IRXN"),"DAI",DAI,0)=^TMP("PSODAI",$J,DAI,0)
"RTN","PSON52",59,0)
 ..S $P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)=+$P(^PSRX(PSOX("IRXN"),"DAI",0),"^",3)+1,$P(^(0),"^",4)=+$P(^(0),"^",4)+1
"RTN","PSON52",60,0)
 .K ^TMP("PSODAI",$J),DAI
"RTN","PSON52",61,0)
 I $G(PSOX("CHCS NUMBER"))'="" S $P(^PSRX(PSOX("IRXN"),"EXT"),"^")=$G(PSOX("CHCS NUMBER"))
"RTN","PSON52",62,0)
 I $G(PSOX("EXTERNAL SYSTEM"))'="" S $P(^PSRX(PSOX("IRXN"),"EXT"),"^",2)=$G(PSOX("EXTERNAL SYSTEM"))
"RTN","PSON52",63,0)
 I $G(PSOX("NEWCOPAY")) S ^PSRX(PSOX("IRXN"),"IB")=$G(PSOX("NEWCOPAY"))
"RTN","PSON52",64,0)
 ;Next line, set SC question based on Copay status?
"RTN","PSON52",65,0)
IBQ ;I $G(PSOBILL)=2 S ^PSRX(PSOX("IRXN"),"IBQ")=$S($G(PSOX("NEWCOPAY")):0,1:1)
"RTN","PSON52",66,0)
 N PSOSCFLD S PSOSCFLD=$S(PSOSCP'="":$G(PSOANSQ("SC")),1:"")_"^"_$G(PSOANSQ("MST"))_"^"_$G(PSOANSQ("VEH"))_"^"_$G(PSOANSQ("RAD"))_"^"_$G(PSOANSQ("PGW"))_"^"_$G(PSOANSQ("HNC"))_"^"_$G(PSOANSQ("CV"))
"RTN","PSON52",67,0)
 I PSOSCP<50&($TR(PSOSCFLD,"^")'="")&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1) D
"RTN","PSON52",68,0)
 . S ^PSRX(PSOX("IRXN"),"IBQ")=PSOSCFLD K PSOSCFLD  ;don't set if SC % is null or 0, just set it in ICD node
"RTN","PSON52",69,0)
 D ICD^PSODIAG
"RTN","PSON52",70,0)
 K PSOANSQ,PSOANSQD,PSOX("NEWCOPAY")
"RTN","PSON52",71,0)
 L -^PSRX("B",PSOX("IRXN"))
"RTN","PSON52",72,0)
 Q
"RTN","PSON52",73,0)
 ;
"RTN","PSON52",74,0)
PS55 ;
"RTN","PSON52",75,0)
 L +^PS(55,PSODFN,"P"):0
"RTN","PSON52",76,0)
 S:'$D(^PS(55,PSODFN,"P",0)) ^(0)="^55.03PA^^"
"RTN","PSON52",77,0)
 F PSOX1=$P(^PS(55,PSODFN,"P",0),"^",3):1 Q:'$D(^PS(55,PSODFN,"P",PSOX1))
"RTN","PSON52",78,0)
 S PSOX("55 IEN")=PSOX1
"RTN","PSON52",79,0)
 S ^PS(55,PSODFN,"P",PSOX1,0)=PSOX("IRXN"),$P(^PS(55,PSODFN,"P",0),"^",3,4)=PSOX1_"^"_($P(^PS(55,PSODFN,"P",0),"^",4)+1)
"RTN","PSON52",80,0)
 S ^PS(55,PSODFN,"P","A",PSONEW("STOP DATE"),PSOX("IRXN"))=""
"RTN","PSON52",81,0)
PS55X L -^PS(55,PSODFN,"P")
"RTN","PSON52",82,0)
 K PSOX1
"RTN","PSON52",83,0)
 Q
"RTN","PSON52",84,0)
DIK ;
"RTN","PSON52",85,0)
 I $D(^XUSEC("PSORPH",DUZ)) S DA=PSOX("IRXN"),DIE=52,DR="41////"_PSOCOU_";S:'X Y=""@1"";42////"_PSOCOUU_";@1" D ^DIE K DIE,DR
"RTN","PSON52",86,0)
 K DIK,DA S DIK="^PSRX(",DA=PSOX("IRXN") D IX1^DIK K DIK
"RTN","PSON52",87,0)
 S DA=PSOX("IRXN") D ORC^PSORN52C
"RTN","PSON52",88,0)
 Q
"RTN","PSON52",89,0)
FINISH ;
"RTN","PSON52",90,0)
ANQ I $G(ANQDATA)]"" D NOW^%DTC G:$D(^PS(52.52,"B",%)) ANQ D
"RTN","PSON52",91,0)
 .K DD,DO S DIC="^PS(52.52,",DIC(0)="L",DLAYGO=52.52,X=% D FILE^DICN K DIC,DLAYGO,DD,DO
"RTN","PSON52",92,0)
 .S ^PS(52.52,+Y,0)=$P(Y,"^",2)_"^"_PSOX("IRXN")_"^"_ANQDATA,^PS(52.52,"A",PSOX("IRXN"),+Y)="" K ANQDATA,X,Y,%,ANQREM
"RTN","PSON52",93,0)
 G:PSOX("STATUS")=4 FINISHP
"RTN","PSON52",94,0)
 I $D(PSORX("VERIFY")) D  G FINISHX
"RTN","PSON52",95,0)
 .K DIC,DLAYGO,DINUM,DIADD,X,DD,DO S DIC="^PS(52.4,",DLAYGO=52.4,DINUM=PSOX("IRXN"),DIC(0)="ML",X=PSOX("IRXN")
"RTN","PSON52",96,0)
 .D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM S ^PS(52.4,PSOX("IRXN"),0)=PSOX("IRXN")_"^"_PSODFN_"^"_DUZ_"^"_"^"_$E(PSOX("LOGIN DATE"),1,7)_"^"_PSOX("IRXN")_"^"_PSOX("STOP DATE")
"RTN","PSON52",97,0)
 .K DIK,DA S DIK="^PS(52.4,",DA=PSOX("IRXN") D IX^DIK K DIK,DA
"RTN","PSON52",98,0)
 ;
"RTN","PSON52",99,0)
 I PSOX("FILL DATE")>DT,$P(PSOPAR,"^",6) S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=0 D SUS^PSORXL K DA G FINISHX
"RTN","PSON52",100,0)
 ;
"RTN","PSON52",101,0)
 ; - Calling ECME for claims generation and transmission / REJECT handling
"RTN","PSON52",102,0)
 N ACTION
"RTN","PSON52",103,0)
 I $$SUBMIT^PSOBPSUT(PSOX("IRXN"),0) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSON52",104,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSOX("IRXN"),0,PSOX("FILL DATE"),"OF")
"RTN","PSON52",105,0)
 . I $$FIND^PSOREJUT(PSOX("IRXN"),0) D
"RTN","PSON52",106,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSOX("IRXN"),0,"79,88","OF","IOQ","I")
"RTN","PSON52",107,0)
 ;
"RTN","PSON52",108,0)
FINISHP ;
"RTN","PSON52",109,0)
 I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSOX("IRXN")_",",RXFL(PSOX("IRXN"))=0 G FINISHX
"RTN","PSON52",110,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSON52",111,0)
 I $L(PSORX("PSOL",PSOX2))+$L(PSOX("IRXN"))<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSOX("IRXN")_","
"RTN","PSON52",112,0)
 E  S PSORX("PSOL",PSOX2+1)=PSOX("IRXN")_","
"RTN","PSON52",113,0)
 S RXFL(PSOX("IRXN"))=0
"RTN","PSON52",114,0)
FINISHX ; 
"RTN","PSON52",115,0)
 ;call to build Rx array for bingo board
"RTN","PSON52",116,0)
 I $G(PSORX("MAIL/WINDOW"))["W" S BINGCRT=1,BINGRTE="W",BBFLG=1 D BBRX^PSORN52C
"RTN","PSON52",117,0)
 K PSOX1,PSOX2
"RTN","PSON52",118,0)
 Q
"RTN","PSON52",119,0)
EOJ ;
"RTN","PSON52",120,0)
 ;B xref locked in routine PSONRXN
"RTN","PSON52",121,0)
 L -^PSRX("B",PSOX("IRXN")) K OTHDOS,DA,PSON52,PSOPRC,RTE,SCH,PSOX("INS"),PSONEW("INS"),PSORXED("INS"),PSONEW("ENT"),PSORXED("ENT"),OLENT
"RTN","PSON52",122,0)
 D PSOUL^PSSLOCK(PSOX("IRXN"))
"RTN","PSON52",123,0)
 Q
"RTN","PSON52",124,0)
 ;
"RTN","PSON52",125,0)
 ;;PSOX("SIG");;SIG;;1
"RTN","PSON52",126,0)
DD ;;PSOX("RX #");;0;;1
"RTN","PSON52",127,0)
 ;;PSOX("ISSUE DATE");;0;;13
"RTN","PSON52",128,0)
 ;;PSODFN;;0;;2
"RTN","PSON52",129,0)
 ;;PSOX("PATIENT STATUS");;0;;3
"RTN","PSON52",130,0)
 ;;PSOX("PROVIDER");;0;;4
"RTN","PSON52",131,0)
 ;;PSOX("CLINIC");;0;;5
"RTN","PSON52",132,0)
 ;;PSODRUG("IEN");;0;;6
"RTN","PSON52",133,0)
 ;;PSODRUG("TRADE NAME");;TN;;1
"RTN","PSON52",134,0)
 ;;PSOX("QTY");;0;;7
"RTN","PSON52",135,0)
 ;;PSOX("DAYS SUPPLY");;0;;8
"RTN","PSON52",136,0)
 ;;PSOX("# OF REFILLS");;0;;9
"RTN","PSON52",137,0)
 ;;PSOX("COPIES");;0;;18
"RTN","PSON52",138,0)
 ;;PSOX("MAIL/WINDOW");;0;;11
"RTN","PSON52",139,0)
 ;;PSOX("REMARKS");;3;;7
"RTN","PSON52",140,0)
 ;;PSOX("CLERK CODE");;0;;16
"RTN","PSON52",141,0)
 ;;PSODRUG("COST");;0;;17
"RTN","PSON52",142,0)
 ;;PSOSITE;;2;;9
"RTN","PSON52",143,0)
 ;;PSOX("LOGIN DATE");;2;;1
"RTN","PSON52",144,0)
 ;;PSOX("FILL DATE");;2;;2
"RTN","PSON52",145,0)
 ;;PSOX("PHARMACIST");;2;;3
"RTN","PSON52",146,0)
 ;;PSOX("LOT #");;2;;4
"RTN","PSON52",147,0)
 ;;PSOX("DISPENSED DATE");;2;;5
"RTN","PSON52",148,0)
 ;;PSOX("STOP DATE");;2;;6
"RTN","PSON52",149,0)
 ;;PSODRUG("NDC");;2;;7
"RTN","PSON52",150,0)
 ;;PSODRUG("DAW");;EPH;;1
"RTN","PSON52",151,0)
 ;;PSODRUG("MANUFACTURER");;2;;8
"RTN","PSON52",152,0)
 ;;PSOX("EXPIRATION DATE");;2;;11
"RTN","PSON52",153,0)
 ;;PSOX("GENERIC PROVIDER");;2;;12
"RTN","PSON52",154,0)
 ;;PSOX("RELEASED DATE/TIME");;2;;13
"RTN","PSON52",155,0)
 ;;PSOX("METHOD OF PICK-UP");;MP;;1
"RTN","PSON52",156,0)
 ;;PSOX("STATUS");;STA;;1
"RTN","PSON52",157,0)
 ;;PSOX("LAST DISPENSED DATE");;3;;1
"RTN","PSON52",158,0)
 ;;PSOX("NEXT POSSIBLE REFILL");;3;;2
"RTN","PSON52",159,0)
 ;;PSOX("COSIGNING PROVIDER");;3;;3
"RTN","PSON52",160,0)
 ;;PSOX("TYPE OF RX");;TYPE;;1
"RTN","PSON52",161,0)
 ;;PSOX("SAND");;SAND;;1
"RTN","PSON52",162,0)
 ;;PSOX("POE");;POE;;1
"RTN","PSON52",163,0)
 ;;PSOX("INS");;INS;;1
"RTN","PSONEW2")
0^8^B31577282^B31175329
"RTN","PSONEW2",1,0)
PSONEW2 ;BIR/DSD - displays new rx information for edit ;7/17/06 6:59pm
"RTN","PSONEW2",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**32,37,46,71,94,124,139,157,143,226,237,239**;DEC 1997
"RTN","PSONEW2",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSONEW2",4,0)
 ;External reference to ^DPT supported by DBIA 10035
"RTN","PSONEW2",5,0)
 ;External reference to PSOUL^PSSLOCK supported by DBIA 2789
"RTN","PSONEW2",6,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSONEW2",7,0)
 ; This routine displays the entered new rx information and
"RTN","PSONEW2",8,0)
 ; asks if correct, if not allows editing of the data.
"RTN","PSONEW2",9,0)
 ;------------------------------------------------------------
"RTN","PSONEW2",10,0)
 ;PSO*237 issue expired error message
"RTN","PSONEW2",11,0)
 ;
"RTN","PSONEW2",12,0)
START ;
"RTN","PSONEW2",13,0)
 S (PSONEW("DFLG"),PSONEW2("QFLG"))=0
"RTN","PSONEW2",14,0)
 D STOP
"RTN","PSONEW2",15,0)
 D DISPLAY ; Displays information
"RTN","PSONEW2",16,0)
 ;Copay exemption checks
"RTN","PSONEW2",17,0)
 D SCP^PSORN52D
"RTN","PSONEW2",18,0)
 S PSONEWFF=1,PSOFLAG=1 K PSOANSQ,PSOANSQD S PSOCPZ("DFLG")=0,PSONEW("NEWCOPAY")=0
"RTN","PSONEW2",19,0)
 ;can't check PSOSCA for <50 here because of PSOBILL check in PSOCPB
"RTN","PSONEW2",20,0)
 I (PSOSCP<50&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1)),$G(DUZ("AG"))="V" D COPAY^PSOCPB W !
"RTN","PSONEW2",21,0)
 I PSOSCA&(PSOSCP>49)!((PSOSCA!(PSOBILL=2))&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1))!(PSOSCP>49&(PSOBILL=2)) D SC^PSOMLLD2
"RTN","PSONEW2",22,0)
 I $G(PSOCPZ("DFLG")) K PSONEWFF,PSOANSQD,PSOCPZ("DFLG"),PSONEW("NEWCOPAY") S DIRUT="",PSONEW("DFLG")=1 D ASKX G END
"RTN","PSONEW2",23,0)
 ;IF MILL BILL, AND COPAY (*******TEST THE COPAY CHECK)
"RTN","PSONEW2",24,0)
 I $$DT^PSOMLLDT D  I $G(PSOCPZ("DFLG")) K PSONEWFF,PSOANSQD,PSOANSQ,PSOCPZ("DFLG"),PSONEW("NEWCOPAY") S DIRUT="",PSONEW("DFLG")=1 D ASKX G END
"RTN","PSONEW2",25,0)
 .;New prompts Quit after first '^'
"RTN","PSONEW2",26,0)
 .I $D(PSOIBQS(PSODFN,"CV")) D CV^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("CV"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",27,0)
 .I $D(PSOIBQS(PSODFN,"VEH")) D VEH^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("VEH"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",28,0)
 .I $D(PSOIBQS(PSODFN,"RAD")) D RAD^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("RAD"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",29,0)
 .I $D(PSOIBQS(PSODFN,"PGW")) D PGW^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("PGW"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",30,0)
 .I $D(PSOIBQS(PSODFN,"MST")) D MST^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("MST"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",31,0)
 .I $D(PSOIBQS(PSODFN,"HNC")) D HNC^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("HNC"))) K PSONEW("NEWCOPAY")
"RTN","PSONEW2",32,0)
 K PSOCPZ("DFLG"),PSONEWFF
"RTN","PSONEW2",33,0)
 D ASK K:$G(PSONEW("DFLG")) PSOANSQ G:PSONEW2("QFLG")!PSONEW("DFLG") END
"RTN","PSONEW2",34,0)
 S PSORX("EDIT")=1 D EN^PSOORNE1(.PSONEW),FULL^VALM1 G:$G(PSORX("FN")) END  I '$G(PSORX("FN")) S PSONEW("DFLG")=1 K PSOANSQ G END ;D EDIT
"RTN","PSONEW2",35,0)
 G:'$G(PSONEW("DFLG")) START
"RTN","PSONEW2",36,0)
 S PSONEW("QFLG")=1,PSONEW("DFLG")=0
"RTN","PSONEW2",37,0)
END D EOJ
"RTN","PSONEW2",38,0)
 Q
"RTN","PSONEW2",39,0)
 ;------------------------------------------------------------
"RTN","PSONEW2",40,0)
STOP K PSEXDT,X,%DT S PSON52("QFLG")=0
"RTN","PSONEW2",41,0)
 S X1=PSOID,X2=PSONEW("DAYS SUPPLY")*(PSONEW("# OF REFILLS")+1)\1
"RTN","PSONEW2",42,0)
 S X2=$S(PSONEW("DAYS SUPPLY")=X2:X2,+$G(PSONEW("CS")):184,1:366)
"RTN","PSONEW2",43,0)
 I X2<30 D
"RTN","PSONEW2",44,0)
 . N % S %=$P($G(PSORX("PATIENT STATUS")),"^"),X2=30
"RTN","PSONEW2",45,0)
 . S:%?.N %=$P($G(^PS(53,+%,0)),"^") I %["AUTH ABS" S X2=5
"RTN","PSONEW2",46,0)
 D C^%DTC I PSONEW("FILL DATE")>$P(X,".") S PSEXDT=1_"^"_$P(X,".")
"RTN","PSONEW2",47,0)
 K X1,X2,X,%DT
"RTN","PSONEW2",48,0)
 Q
"RTN","PSONEW2",49,0)
DISPLAY ;
"RTN","PSONEW2",50,0)
 W !!,"Rx # ",PSONEW("RX #")
"RTN","PSONEW2",51,0)
 W ?23,$E(PSONEW("FILL DATE"),4,5),"/",$E(PSONEW("FILL DATE"),6,7),"/",$E(PSONEW("FILL DATE"),2,3),!,$G(PSORX("NAME")),?30,"#",PSONEW("QTY")
"RTN","PSONEW2",52,0)
 I $G(SIGOK),$O(SIG(0)) D  K D G TRN
"RTN","PSONEW2",53,0)
 .F D=0:0 S D=$O(SIG(D)) W !,SIG(D) Q:'$O(SIG(D))
"RTN","PSONEW2",54,0)
 E  S X=PSONEW("SIG") D SIGONE^PSOHELP W !,$G(INS1)
"RTN","PSONEW2",55,0)
TRN ;I $G(PSOPRC) F I=0:0 S I=$O(PRC(I)) Q:'I  W !,PRC(I)
"RTN","PSONEW2",56,0)
 W !!,$S($G(PSODRUG("TRADE NAME"))]"":PSODRUG("TRADE NAME"),1:PSODRUG("NAME"))
"RTN","PSONEW2",57,0)
 W !,PSONEW("PROVIDER NAME"),?25,PSORX("CLERK CODE"),!,"# of Refills: ",PSONEW("# OF REFILLS"),!
"RTN","PSONEW2",58,0)
 Q
"RTN","PSONEW2",59,0)
 ;
"RTN","PSONEW2",60,0)
ASK ;
"RTN","PSONEW2",61,0)
 K DIR,X,Y S DIR("A")="Is this correct"
"RTN","PSONEW2",62,0)
 S DIR(0)="Y",DIR("B")="YES" D ^DIR K DIR I $D(DIRUT) S PSONEW("DFLG")=1 G ASKX
"RTN","PSONEW2",63,0)
ASK1 I Y D  S PSONEW2("QFLG")=1
"RTN","PSONEW2",64,0)
 .S:$G(PSONEW("MAIL/WINDOW"))["W" BINGCRT=Y,BINGRTE="W"
"RTN","PSONEW2",65,0)
 .D:+$G(PSEXDT)
"RTN","PSONEW2",66,0)
 ..S Y=PSONEW("FILL DATE") X ^DD("DD") W !!,$C(7),Y_" fill date is greater than possible expiration date of " S Y=$P(PSEXDT,"^",2) X ^DD("DD") W Y_"."
"RTN","PSONEW2",67,0)
 .D DCORD K RORD,^TMP("PSORXDC",$J)
"RTN","PSONEW2",68,0)
ASKX I $D(DIRUT) D
"RTN","PSONEW2",69,0)
 .I +$G(PSEXDT) K DIRUT S (PSONEW2("QFLG"),PSONEW2("DFLG"),PSONEW("DFLG"),Y)=1
"RTN","PSONEW2",70,0)
 K X,Y,DIRUT,DTOUT,DUOUT
"RTN","PSONEW2",71,0)
 D:+$G(PSEXDT) PAUSE^VALM1
"RTN","PSONEW2",72,0)
 Q
"RTN","PSONEW2",73,0)
DCORD ;dc rxs and pending orders after new order is entered
"RTN","PSONEW2",74,0)
 F RORD=0:0 S RORD=$O(^TMP("PSORXDC",$J,RORD)) Q:'RORD  D @$S($P(^TMP("PSORXDC",$J,RORD,0),"^")="P":"PEN",1:"RX52")
"RTN","PSONEW2",75,0)
 K RORD
"RTN","PSONEW2",76,0)
 Q
"RTN","PSONEW2",77,0)
PEN ;pending ^tmp("psorxdc",$j,rord,0)="p^"_rord_"^"_msg
"RTN","PSONEW2",78,0)
 S $P(^PS(52.41,RORD,0),"^",3)="DC",^PS(52.41,RORD,4)=$P(^TMP("PSORXDC",$J,RORD,0),"^",3)
"RTN","PSONEW2",79,0)
 K ^PS(52.41,"AOR",PSODFN,+$P($G(^PS(52.41,RORD,"INI")),"^"),RORD)
"RTN","PSONEW2",80,0)
 D EN^PSOHLSN($P(^PS(52.41,RORD,0),"^"),"OC",$P(^TMP("PSORXDC",$J,RORD,0),"^",3),"D") W $C(7),!," -Pending Order was discontinued..."
"RTN","PSONEW2",81,0)
 D PSOUL^PSSLOCK(RORD_"S") K ^TMP("PSORXDC",$J,RORD,0)
"RTN","PSONEW2",82,0)
 Q
"RTN","PSONEW2",83,0)
RX52 ;rxs in file 52 ^tmp("psorxdc",$j,rord,0)=52^rord^msg^rea^act^sta^dnm
"RTN","PSONEW2",84,0)
 S PSCAN($P(^PSRX(RORD,0),"^"))=RORD_"^"_$P(^TMP("PSORXDC",$J,RORD,0),"^",4)
"RTN","PSONEW2",85,0)
 S MSG=$P(^TMP("PSORXDC",$J,RORD,0),"^",3),REA=$P(^(0),"^",4),ACT=$P(^(0),"^",5)
"RTN","PSONEW2",86,0)
 N PSONOOR S PSONOOR="D",DUP=1,DA=RORD D CAN^PSOCAN K PSONOOR
"RTN","PSONEW2",87,0)
 W !," -Rx "_$P(^PSRX(RORD,0),"^")_" has been discontinued...",!
"RTN","PSONEW2",88,0)
 K PSOSD($P(^TMP("PSORXDC",$J,RORD,0),"^",6),$P(^TMP("PSORXDC",$J,RORD,0),"^",7))
"RTN","PSONEW2",89,0)
 D PSOUL^PSSLOCK(RORD) K ^TMP("PSORXDC",$J,RORD,0)
"RTN","PSONEW2",90,0)
 Q
"RTN","PSONEW2",91,0)
 ;
"RTN","PSONEW2",92,0)
EDIT ;
"RTN","PSONEW2",93,0)
 S PSORX("EDIT")=1
"RTN","PSONEW2",94,0)
 D ^PSONEW3
"RTN","PSONEW2",95,0)
 S PSONEW("DFLG")=$S($G(PSORX("DFLG")):1,1:0)
"RTN","PSONEW2",96,0)
 Q
"RTN","PSONEW2",97,0)
 ;
"RTN","PSONEW2",98,0)
EOJ ;
"RTN","PSONEW2",99,0)
 K PSONEW2,PSORX("EDIT"),PSORX("DFLG"),PSOEDIT,PSOSCA
"RTN","PSONEW2",100,0)
 Q
"RTN","PSONEW2",101,0)
 ;
"RTN","PSONEW2",102,0)
EN1(PSONEW2) ; Entry point to just display and ask if okay
"RTN","PSONEW2",103,0)
 S PSONEW("DFLG")=0
"RTN","PSONEW2",104,0)
 I $G(^PSRX(PSONEW2("IRXN"),0))']"" S PSONEW("DFLG")=1 G EN1X
"RTN","PSONEW2",105,0)
 S PSOX=^PSRX(PSONEW2("IRXN"),0),PSONEW("TRADE NAME")=$G(^("TN")),PSONEW("FILL DATE")=$P($G(^(2)),"^",2)
"RTN","PSONEW2",106,0)
 S PSONEW("RX #")=$P(PSOX,"^"),PSORX("NAME")=$P(^DPT($P(PSOX,"^",2),0),"^")
"RTN","PSONEW2",107,0)
 S PSONEW("QTY")=$P(PSOX,"^",7),PSODRUG("NAME")=$P(^PSDRUG($P(PSOX,"^",6),0),"^"),PSONEW("# OF REFILLS")=$P(PSOX,"^",9)
"RTN","PSONEW2",108,0)
 S PSORX("CLERK CODE")=$P(^VA(200,$P(PSOX,"^",16),0),"^")
"RTN","PSONEW2",109,0)
 S:$G(PSONEW("PROVIDER NAME"))="" PSONEW("PROVIDER NAME")=$P(^VA(200,$P(PSOX,"^",4),0),"^")
"RTN","PSONEW2",110,0)
 S PSONEW("SIG")=$P($G(^PSRX(PSONEW2("IRXN"),"SIG")),"^")
"RTN","PSONEW2",111,0)
 D DISPLAY
"RTN","PSONEW2",112,0)
 D ASK
"RTN","PSONEW2",113,0)
 I PSONEW("DFLG")=1 S PSONEW2("DFLG")=1
"RTN","PSONEW2",114,0)
EN1X ;
"RTN","PSONEW2",115,0)
 Q
"RTN","PSONEW2",116,0)
 ;
"RTN","PSONEW2",117,0)
EXPR ;Display Expired error message                               ;PSO*237
"RTN","PSONEW2",118,0)
 S PSONEW("DFLG")=1
"RTN","PSONEW2",119,0)
 W $C(7)
"RTN","PSONEW2",120,0)
 S VALMSG="Order is older than 365 days and can't be finished"
"RTN","PSONEW2",121,0)
 S XQORM("B")="DC"
"RTN","PSONEW2",122,0)
 Q
"RTN","PSONEWF")
0^9^B35718015^B45034725
"RTN","PSONEWF",1,0)
PSONEWF ;BIR/RTR - Copay finish questions ;07/26/96
"RTN","PSONEWF",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**71,157,143,219,226,239**;DEC 1997
"RTN","PSONEWF",3,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSONEWF",4,0)
START ;
"RTN","PSONEWF",5,0)
 N PSOPENIB,PSOSCOTH,PSOSCOTX,PSOMESFI
"RTN","PSONEWF",6,0)
 S PSOPENIB=$S($G(ORD):$G(^PS(52.41,+$G(ORD),"IBQ")),1:"")
"RTN","PSONEWF",7,0)
 ;set PSOSCOTH for display of Provider Copay intent, used with PSORX(SC)
"RTN","PSONEWF",8,0)
 S PSOSCOTH=0 I $P(PSOPENIB,"^")=1!($P(PSOPENIB,"^",2)=1)!($P(PSOPENIB,"^",3)=1)!($P(PSOPENIB,"^",4)=1)!($P(PSOPENIB,"^",5)=1)!($P(PSOPENIB,"^",6)=1) S PSOSCOTH=1
"RTN","PSONEWF",9,0)
 S PSOSCOTX=0 I $G(PSOSCOTH)!($G(PSORX("SC"))="SC")!($G(PSORX("SC"))="NSC") S PSOSCOTX=1
"RTN","PSONEWF",10,0)
 ;Check for Orderable Item change to display message
"RTN","PSONEWF",11,0)
 S PSOMESFI=0 I $G(OR0),$G(PSODRUG("OI")) D
"RTN","PSONEWF",12,0)
 .I $G(PSODRUG("OI"))'=$P($G(OR0),"^",8) S PSOMESFI=1
"RTN","PSONEWF",13,0)
 S PSONEWFF=1,PSOFLAG=1
"RTN","PSONEWF",14,0)
 ;Copay exemption checks
"RTN","PSONEWF",15,0)
 D SCP^PSORN52D
"RTN","PSONEWF",16,0)
 K PSOANSQ D SET S PSOCPZ("DFLG")=0,PSONEW("NEWCOPAY")=0
"RTN","PSONEWF",17,0)
 I (PSOSCP<50)&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1),$G(DUZ("AG"))="V" D COPAY^PSOCPB W !
"RTN","PSONEWF",18,0)
 I $P(PSOPENIB,"^",6)=0!($P(PSOPENIB,"^",6)=1) S PSOANSQ("CV")=$P(PSOPENIB,"^",6)
"RTN","PSONEWF",19,0)
 I $G(PSOCPZ("DFLG")) K PSONEW("NEWCOPAY"),PSONEWFF,PSOSCOTH,PSOSCOTX,PSOMESFI Q
"RTN","PSONEWF",20,0)
 ;
"RTN","PSONEWF",21,0)
 I PSOSCA&(PSOSCP>49)!((PSOSCA!(PSOBILL=2))&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1))!(PSOSCP>49&(PSOBILL=2)) D  I $G(PSOCPZ("DFLG")) K PSOANSQ,PSONEW("NEWCOPAY"),PSONEWFF,PSOSCOTH,PSOSCOTX,PSOMESFI Q
"RTN","PSONEWF",22,0)
 . I PSOSCP<50 D MESS S:PSOSCP<50 PSOANSQD("SC>50")=$G(PSOANSQD("SC"))
"RTN","PSONEWF",23,0)
 . D SC^PSOMLLD2
"RTN","PSONEWF",24,0)
 . I PSOSCP<50&($D(PSOANSQD("SC"))) S PSOANSQD("SC")=PSOANSQD("SC>50") K PSOANSQD("SC")
"RTN","PSONEWF",25,0)
 ;IF MILL BILL, AND COPAY (*******TEST THE COPAY CHECK)
"RTN","PSONEWF",26,0)
 I $$DT^PSOMLLDT D  I $G(PSOCPZ("DFLG")) K PSOANSQ,PSONEW("NEWCOPAY"),PSONEWFF,PSOSCOTH,PSOSCOTX,PSOMESFI Q
"RTN","PSONEWF",27,0)
 .;New prompts Quit after first '^'
"RTN","PSONEWF",28,0)
 .I $D(PSOIBQS(PSODFN,"CV")) D  D MESSOI,MESS D CV^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("CV"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",29,0)
 ..I '$D(PSOANSQD("CV")),($P(PSOPENIB,"^",6)=0!($P(PSOPENIB,"^",6)=1)) S PSOANSQD("CV")=$P(PSOPENIB,"^",6)
"RTN","PSONEWF",30,0)
 .I $D(PSOIBQS(PSODFN,"VEH")) D  D MESSOI,MESS D VEH^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("VEH"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",31,0)
 ..I '$D(PSOANSQD("VEH")),($P(PSOPENIB,"^",2)=0!($P(PSOPENIB,"^",2)=1)) S PSOANSQD("VEH")=$P(PSOPENIB,"^",2)
"RTN","PSONEWF",32,0)
 .I $D(PSOIBQS(PSODFN,"RAD")) D  D MESSOI,MESS D RAD^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("RAD"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",33,0)
 ..I '$D(PSOANSQD("RAD")),($P(PSOPENIB,"^",3)=0!($P(PSOPENIB,"^",3)=1)) S PSOANSQD("RAD")=$P(PSOPENIB,"^",3)
"RTN","PSONEWF",34,0)
 .I $D(PSOIBQS(PSODFN,"PGW")) D  D MESSOI,MESS D PGW^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("PGW"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",35,0)
 ..I '$D(PSOANSQD("PGW")),($P(PSOPENIB,"^",4)=0!($P(PSOPENIB,"^",4)=1)) S PSOANSQD("PGW")=$P(PSOPENIB,"^",4)
"RTN","PSONEWF",36,0)
 .I $D(PSOIBQS(PSODFN,"MST")) D  D MESSOI,MESS D MST^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("MST"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",37,0)
 ..I '$D(PSOANSQD("MST")),($P(PSOPENIB,"^")=0!($P(PSOPENIB,"^")=1)) S PSOANSQD("MST")=$P(PSOPENIB,"^")
"RTN","PSONEWF",38,0)
 .I $D(PSOIBQS(PSODFN,"HNC")) D  D MESSOI,MESS D HNC^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("HNC"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWF",39,0)
 ..I '$D(PSOANSQD("HNC")),($P(PSOPENIB,"^",5)=0!($P(PSOPENIB,"^",5)=1)) S PSOANSQD("HNC")=$P(PSOPENIB,"^",5)
"RTN","PSONEWF",40,0)
 K PSONEWFF,PSOSCOTH,PSOSCOTX,PSOMESFI,PSOSCA
"RTN","PSONEWF",41,0)
 Q
"RTN","PSONEWF",42,0)
SET ;Set original answers that were passed from CPRS
"RTN","PSONEWF",43,0)
 Q:'$G(ORD)
"RTN","PSONEWF",44,0)
 Q:'$G(PSOFDR)
"RTN","PSONEWF",45,0)
 I $P($G(^PS(52.41,ORD,0)),"^",16)="SC"!($P($G(^(0)),"^",16)="NSC") D
"RTN","PSONEWF",46,0)
 . I PSOSCP<50 S PSOANSQ("SC")=$S($P($G(^(0)),"^",16)="SC":1,1:0),PSOANSQD("SC")=PSOANSQ("SC") S:PSOANSQ("SC")'="" PSOIBQS(PSODFN,"SC")=PSOANSQ("SC")
"RTN","PSONEWF",47,0)
 . I PSOSCP>49 S PSOANSQ("SC>50")=$S($P($G(^(0)),"^",16)="SC":1,1:0),PSOANSQD("SC>50")=PSOANSQ("SC>50") S:PSOANSQ("SC>50")'="" PSOIBQS(PSODFN,"SC>50")=PSOANSQ("SC>50")
"RTN","PSONEWF",48,0)
 I $G(PSOPENIB)="" G SET2
"RTN","PSONEWF",49,0)
 I '$$DT^PSOMLLDT Q
"RTN","PSONEWF",50,0)
 I $P(PSOPENIB,"^")=0!($P(PSOPENIB,"^")=1) S PSOANSQ("MST")=$P(PSOPENIB,"^")
"RTN","PSONEWF",51,0)
 I $P(PSOPENIB,"^",2)=0!($P(PSOPENIB,"^",2)=1) S PSOANSQ("VEH")=$P(PSOPENIB,"^",2)
"RTN","PSONEWF",52,0)
 I $P(PSOPENIB,"^",3)=0!($P(PSOPENIB,"^",3)=1) S PSOANSQ("RAD")=$P(PSOPENIB,"^",3)
"RTN","PSONEWF",53,0)
 I $P(PSOPENIB,"^",4)=0!($P(PSOPENIB,"^",4)=1) S PSOANSQ("PGW")=$P(PSOPENIB,"^",4)
"RTN","PSONEWF",54,0)
 I $P(PSOPENIB,"^",5)=0!($P(PSOPENIB,"^",5)=1) S PSOANSQ("HNC")=$P(PSOPENIB,"^",5)
"RTN","PSONEWF",55,0)
 I $P(PSOPENIB,"^",6)=0!($P(PSOPENIB,"^",6)=1) S PSOANSQ("CV")=$P(PSOPENIB,"^",6)
"RTN","PSONEWF",56,0)
 ;
"RTN","PSONEWF",57,0)
SET2 ;for when patient status is exempt, null IBQ node was set for exempts or SC>50 - data is in ICD node
"RTN","PSONEWF",58,0)
 N PSOOICD
"RTN","PSONEWF",59,0)
 I $TR($G(^PS(52.41,+$G(ORD),"IBQ")),"^")="" S PSOOICD=$G(^PS(52.41,ORD,"ICD",1,0)) D SET3:PSOOICD'=""
"RTN","PSONEWF",60,0)
 ;
"RTN","PSONEWF",61,0)
ICD1 ;
"RTN","PSONEWF",62,0)
 N PSONOCHG S PSONOCHG=0
"RTN","PSONEWF",63,0)
 I ('$D(PSORXED("ICD"))) S PSONOCHG=1
"RTN","PSONEWF",64,0)
 I $D(^PS(52.41,ORD,"ICD",0)) D
"RTN","PSONEWF",65,0)
 . N JJ,ICD,II,FLD,RXN S RXN=ORD
"RTN","PSONEWF",66,0)
 . S II=0 F  S II=$O(^PS(52.41,ORD,"ICD",II)) Q:II=""!(II'?1N.N)  D
"RTN","PSONEWF",67,0)
 .. S ICD=^PS(52.41,ORD,"ICD",II,0),FLD=$P(ICD,U) S:$G(PSONEW("IDFLG")) FLD=""  D ICD
"RTN","PSONEWF",68,0)
 Q
"RTN","PSONEWF",69,0)
 ;
"RTN","PSONEWF",70,0)
SET3 ; called from PSONEWF and PSONEWG; must have PSOOICD.  For SC>50, exempt patient status, etc.
"RTN","PSONEWF",71,0)
 N JJJ
"RTN","PSONEWF",72,0)
 F JJJ=2:1:8 I $P(PSOOICD,"^",JJJ)=0!($P(PSOOICD,"^",JJJ)=1) D
"RTN","PSONEWF",73,0)
 . I JJJ=2 S (PSOANSQD("VEH"),PSOANSQ("VEH"))=$P(PSOOICD,"^",JJJ)
"RTN","PSONEWF",74,0)
 . I JJJ=3 S (PSOANSQD("RAD"),PSOANSQ("RAD"))=$P(PSOOICD,"^",JJJ)
"RTN","PSONEWF",75,0)
 . I JJJ=4 D
"RTN","PSONEWF",76,0)
 .. S:PSOSCP<50 (PSOANSQD("SC"),PSOANSQ("SC"))=$P(PSOOICD,"^",JJJ)
"RTN","PSONEWF",77,0)
 .. S:PSOSCP>49!($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1) (PSOANSQD("SC>50"),PSOANSQ("SC>50"))=$P(PSOOICD,"^",JJJ)
"RTN","PSONEWF",78,0)
 . I JJJ=5 S (PSOANSQD("PGW"),PSOANSQ("PGW"))=$P(PSOOICD,"^",JJJ)
"RTN","PSONEWF",79,0)
 . I JJJ=6 S (PSOANSQD("MST"),PSOANSQ("MST"))=$P(PSOOICD,"^",JJJ)
"RTN","PSONEWF",80,0)
 . I JJJ=7 S (PSOANSQD("HNC"),PSOANSQ("HNC"))=$P(PSOOICD,"^",JJJ)
"RTN","PSONEWF",81,0)
 . I JJJ=8 S (PSOANSQD("CV"),PSOANSQ("CV"))=$P(PSOOICD,"^",JJJ)
"RTN","PSONEWF",82,0)
 K PSOOICD
"RTN","PSONEWF",83,0)
 Q
"RTN","PSONEWF",84,0)
MESS ;
"RTN","PSONEWF",85,0)
 I $G(PSOSCOTX)=1&(PSOSCP<50) W:$G(PSODRUG("DEA"))'["S"&($G(PSODRUG("DEA"))'["I") !,"This Rx has been flagged by the provider as: "_$S($G(PSOSCOTH):"NO COPAY",$G(PSORX("SC"))="SC":"NO COPAY",1:"COPAY"),! S PSOSCOTX=2
"RTN","PSONEWF",86,0)
 Q
"RTN","PSONEWF",87,0)
MESSOI ;
"RTN","PSONEWF",88,0)
 I $G(PSOMESFI)=1 W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESFI=2
"RTN","PSONEWF",89,0)
 Q
"RTN","PSONEWF",90,0)
 ;
"RTN","PSONEWF",91,0)
ICD ;called from PSONEWG,PSORENW1 and used by PSONEWF
"RTN","PSONEWF",92,0)
 I $G(PSOCOPY)&($D(PSORXED("ICD")))&($D(PSONEW("IDFLG"))) Q:'$D(PSORXED("ICD",II))
"RTN","PSONEWF",93,0)
 I $G(PSOCOPY)&($D(PSORXED("ICD",II))) S PSONEW("ICD",II)=PSORXED("ICD",II) Q
"RTN","PSONEWF",94,0)
 Q:'$G(PSOCOPY)&('$D(PSORXED("ICD",II)))&('$G(PSONOCHG))  ;don't set deleted ones
"RTN","PSONEWF",95,0)
 Q:$G(PSONEW("IDFLG"))
"RTN","PSONEWF",96,0)
 I $D(PSORX("ICD",II)) S PSONEW("ICD",II)=PSORX("ICD",II) Q
"RTN","PSONEWF",97,0)
 S PSONEW("ICD",II)=FLD
"RTN","PSONEWF",98,0)
 Q
"RTN","PSONEWF",99,0)
 ;
"RTN","PSONEWG")
0^10^B23242345^B22698688
"RTN","PSONEWG",1,0)
PSONEWG ;BIR/RTR - Copay copy and edit questions ;07/26/96
"RTN","PSONEWG",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**71,157,143,219,226,239**;DEC 1997
"RTN","PSONEWG",3,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSONEWG",4,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSONEWG",5,0)
START ;
"RTN","PSONEWG",6,0)
 N PSOPENIB,PSOMESOI
"RTN","PSONEWG",7,0)
 S PSOPENIB="" I $G(PSORXED)!($G(PSOCOPY)) I $G(PSORXED("IRXN")) S PSOPENIB=$G(^PSRX(PSORXED("IRXN"),"IBQ"))
"RTN","PSONEWG",8,0)
 S PSOMESOI=0 I $G(PSORXED) D
"RTN","PSONEWG",9,0)
 .I $G(PSODRUG("OI")),$P($G(PSORXED("RX0")),"^",6) D
"RTN","PSONEWG",10,0)
 ..I $G(PSODRUG("OI"))'=$P($G(^PSDRUG(+$P($G(PSORXED("RX0")),"^",6),2)),"^") S PSOMESOI=1
"RTN","PSONEWG",11,0)
 S PSONEWFF=1,PSOFLAG=1
"RTN","PSONEWG",12,0)
 ;Copay exemption checks
"RTN","PSONEWG",13,0)
 D SCP^PSORN52D
"RTN","PSONEWG",14,0)
 K PSOANSQ D SET S PSOCPZ("DFLG")=0,PSONEW("NEWCOPAY")=0
"RTN","PSONEWG",15,0)
 I PSOSCP<50&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)'=1),$G(DUZ("AG"))="V" D  D COPAY^PSOCPB W !
"RTN","PSONEWG",16,0)
 .;I $G(PSOANSQD("SC"))=0!($G(PSOANSQD("SC"))=1) Q
"RTN","PSONEWG",17,0)
 .I $G(PSOANSQ("SC"))=0!($G(PSOANSQ("SC"))=1) S PSOANSQD("SC")=$G(PSOANSQ("SC"))
"RTN","PSONEWG",18,0)
 I PSOSCA&(PSOSCP>49)!((PSOSCA!(PSOBILL=2))&($P($G(^PS(53,+$G(PSONEW("PATIENT STATUS")),0)),"^",7)=1))!(PSOSCP>49&(PSOBILL=2)) D SC^PSOMLLD2 I $G(PSOCPZ("DFLG")) K PSOANSQ,PSONEW("NEWCOPAY"),PSONEWFF,PSOMESOI Q
"RTN","PSONEWG",19,0)
 I $G(PSOCPZ("DFLG")) K PSONEW("NEWCOPAY"),PSONEWFF,PSOMESOI Q
"RTN","PSONEWG",20,0)
 ;IF MILL BILL, AND COPAY (*******TEST THE COPAY CHECK)
"RTN","PSONEWG",21,0)
 I $$DT^PSOMLLDT D  I $G(PSOCPZ("DFLG")) K PSOANSQ,PSONEW("NEWCOPAY"),PSONEWFF,PSOMESOI Q
"RTN","PSONEWG",22,0)
 .;New prompts Quit after first '^'
"RTN","PSONEWG",23,0)
 .I $D(PSOIBQS(PSODFN,"CV")) D  D MESS D CV^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("CV"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",24,0)
 ..I '$D(PSOANSQD("CV")),($P(PSOPENIB,"^",7)=0!($P(PSOPENIB,"^",7)=1)) S PSOANSQD("CV")=$P(PSOPENIB,"^",7)
"RTN","PSONEWG",25,0)
 .I $D(PSOIBQS(PSODFN,"VEH")) D  D MESS D VEH^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("VEH"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",26,0)
 ..I '$D(PSOANSQD("VEH")),($P(PSOPENIB,"^",3)=0!($P(PSOPENIB,"^",3)=1)) S PSOANSQD("VEH")=$P(PSOPENIB,"^",3)
"RTN","PSONEWG",27,0)
 .I $D(PSOIBQS(PSODFN,"RAD")) D  D MESS D RAD^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("RAD"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",28,0)
 ..I '$D(PSOANSQD("RAD")),($P(PSOPENIB,"^",4)=0!($P(PSOPENIB,"^",4)=1)) S PSOANSQD("RAD")=$P(PSOPENIB,"^",4)
"RTN","PSONEWG",29,0)
 .I $D(PSOIBQS(PSODFN,"PGW")) D  D MESS D PGW^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("PGW"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",30,0)
 ..I '$D(PSOANSQD("PGW")),($P(PSOPENIB,"^",5)=0!($P(PSOPENIB,"^",5)=1)) S PSOANSQD("PGW")=$P(PSOPENIB,"^",5)
"RTN","PSONEWG",31,0)
 .I $D(PSOIBQS(PSODFN,"MST")) D  D MESS D MST^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("MST"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",32,0)
 ..I '$D(PSOANSQD("MST")),($P(PSOPENIB,"^",2)=0!($P(PSOPENIB,"^",2)=1)) S PSOANSQD("MST")=$P(PSOPENIB,"^",2)
"RTN","PSONEWG",33,0)
 .I $D(PSOIBQS(PSODFN,"HNC")) D  D MESS D HNC^PSOMLLDT I $G(PSOCPZ("DFLG"))!($G(PSOANSQ("HNC"))) K PSONEW("NEWCOPAY")
"RTN","PSONEWG",34,0)
 ..I '$D(PSOANSQD("HNC")),($P(PSOPENIB,"^",6)=0!($P(PSOPENIB,"^",6)=1)) S PSOANSQD("HNC")=$P(PSOPENIB,"^",6)
"RTN","PSONEWG",35,0)
 K PSONEWFF,PSOMESOI,PSOSCA
"RTN","PSONEWG",36,0)
 Q
"RTN","PSONEWG",37,0)
SET ;Set original answers that were passed from CPRS
"RTN","PSONEWG",38,0)
 Q:'$G(PSORXED("IRXN"))
"RTN","PSONEWG",39,0)
 S PSOANSQ("SC")=$S($P($G(^PSRX(PSORXED("IRXN"),"IBQ")),"^")'="":$P($G(^("IBQ")),"^"),$P($G(^PSRX(PSORXED("IRXN"),"IB")),"^"):0,1:"")
"RTN","PSONEWG",40,0)
 I $G(PSOANSQ("SC"))="" K PSOANSQ("SC")
"RTN","PSONEWG",41,0)
 I $G(PSOPENIB)="" G SET2
"RTN","PSONEWG",42,0)
 I '$$DT^PSOMLLDT Q
"RTN","PSONEWG",43,0)
 I $P(PSOPENIB,"^",2)=0!($P(PSOPENIB,"^",2)=1) S PSOANSQ("MST")=$P(PSOPENIB,"^",2)
"RTN","PSONEWG",44,0)
 I $P(PSOPENIB,"^",3)=0!($P(PSOPENIB,"^",3)=1) S PSOANSQ("VEH")=$P(PSOPENIB,"^",3)
"RTN","PSONEWG",45,0)
 I $P(PSOPENIB,"^",4)=0!($P(PSOPENIB,"^",4)=1) S PSOANSQ("RAD")=$P(PSOPENIB,"^",4)
"RTN","PSONEWG",46,0)
 I $P(PSOPENIB,"^",5)=0!($P(PSOPENIB,"^",5)=1) S PSOANSQ("PGW")=$P(PSOPENIB,"^",5)
"RTN","PSONEWG",47,0)
 I $P(PSOPENIB,"^",6)=0!($P(PSOPENIB,"^",6)=1) S PSOANSQ("HNC")=$P(PSOPENIB,"^",6)
"RTN","PSONEWG",48,0)
 I $P(PSOPENIB,"^",7)=0!($P(PSOPENIB,"^",7)=1) S PSOANSQ("CV")=$P(PSOPENIB,"^",7)
"RTN","PSONEWG",49,0)
 ;
"RTN","PSONEWG",50,0)
SET2 ;for when patient status is exempt, null IBQ node was set for exempts or SC>50 - data is in ICD node
"RTN","PSONEWG",51,0)
 N PSOOICD,JJJ
"RTN","PSONEWG",52,0)
 I $TR($G(^PSRX(PSODFN,"IBQ")),"^")="" S PSOOICD=$G(^PSRX(PSORXED("IRXN"),"ICD",1,0)) D SET3^PSONEWF:PSOOICD'=""
"RTN","PSONEWG",53,0)
 ;
"RTN","PSONEWG",54,0)
ICD ;
"RTN","PSONEWG",55,0)
 N JJ,ICD,II,FLD,RXN,TNEW,PSONOCHG S PSONOCHG=0
"RTN","PSONEWG",56,0)
 S RXN=PSORXED("IRXN")
"RTN","PSONEWG",57,0)
 I '$D(PSONEW("ICD"))&('$D(PSORXED("ICD"))) S PSONOCHG=1
"RTN","PSONEWG",58,0)
 I $D(^PSRX(RXN,"ICD",0)) D
"RTN","PSONEWG",59,0)
 . S II=0 F  S II=$O(^PSRX(RXN,"ICD",II)) Q:II=""!(II'?1N.N)!($G(PSOCOPY)&(II>1)&('PSONOCHG))  D
"RTN","PSONEWG",60,0)
 .. S ICD=^PSRX(RXN,"ICD",II,0),FLD=$P(ICD,U) S:$G(PSONEW("IDFLG")) FLD="" D ICD^PSONEWF
"RTN","PSONEWG",61,0)
 E  I $G(PSONEW("IDFLG")) K ^PSRX(RXN,"ICD","B") S $P(^PSRX(RXN,"ICD",1,0),"^",1)="",TNEW=2 D
"RTN","PSONEWG",62,0)
 . F TNEW=TNEW:1:8 Q:'$D(^PSRX(RXN,"ICD",TNEW,0))  S DIK="^PSRX("_RXN_","_$C(34)_"ICD"_$C(34)_",",DA=TNEW,DA(1)=RXN D ^DIK K DA,DIK ;user deleted all
"RTN","PSONEWG",63,0)
 K PSONEW("IDFLG"),PSORXED("IDFLG")
"RTN","PSONEWG",64,0)
 Q
"RTN","PSONEWG",65,0)
MESS ;
"RTN","PSONEWG",66,0)
 I $G(PSOMESOI)=1,$G(PSORXED) W !!,"The Pharmacy Orderable Item has changed for this order. Please review any",!,"existing SC or Environmental Indicator defaults carefully for appropriateness.",! S PSOMESOI=2
"RTN","PSONEWG",67,0)
 Q
"RTN","PSORENW1")
0^18^B64596305^B55639962
"RTN","PSORENW1",1,0)
PSORENW1 ;BIR/DSD - Renew Main Driver Continuation ;03/29/93
"RTN","PSORENW1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**20,37,51,46,71,117,157,143,219,239**;DEC 1997
"RTN","PSORENW1",3,0)
 ;External reference ^VA(200 supported by DBIA 10060
"RTN","PSORENW1",4,0)
 ;
"RTN","PSORENW1",5,0)
START ;
"RTN","PSORENW1",6,0)
 S PSORENW("RX0")=^PSRX(PSORENW("OIRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN")),SIGOK=+$P($G(^("SIG")),"^",2)
"RTN","PSORENW1",7,0)
 S PSOIBOLD=$G(PSORENW("OIRXN"))
"RTN","PSORENW1",8,0)
 D SETIB
"RTN","PSORENW1",9,0)
 S PSORENW("PROVIDER")=$P(PSORENW("RX0"),"^",4)
"RTN","PSORENW1",10,0)
 S PSORX("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW1",11,0)
 S PSORENW("CLINIC")=$P(PSORENW("RX0"),"^",5),PSORENW("COPIES")=$P(PSORENW("RX0"),"^",18)
"RTN","PSORENW1",12,0)
 I $G(PSOFDR),$P($G(OR0),"^",13) S PSORENW("CLINIC")=$P($G(OR0),"^",13)
"RTN","PSORENW1",13,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")
"RTN","PSORENW1",14,0)
 S PSORENW("SIG")=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^")
"RTN","PSORENW1",15,0)
 S:$P(PSORENW("RX3"),"^",3) PSORENW("COSIGNING PROVIDER")=$P(PSORENW("RX3"),"^",3)
"RTN","PSORENW1",16,0)
 S (PSODFN,PSORENW("PSODFN"))=$P(PSORENW("RX0"),"^",2)
"RTN","PSORENW1",17,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSORENW1",18,0)
 S PSORENW("DRUG IEN")=$P(PSORENW("RX0"),"^",6)
"RTN","PSORENW1",19,0)
 S PSORENW("INS")=$S($G(PSORENW("INS"))]"":PSORENW("INS"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW1",20,0)
 S D=0 F  S D=$O(^PSRX(PSORENW("OIRXN"),"INS1",D)) Q:'D  S PSORENW("SIG",D)=^PSRX(PSORENW("OIRXN"),"INS1",D,0)
"RTN","PSORENW1",21,0)
 I '$O(PSORENW("SIG",0)),$G(PSORENW("INS"))]"" S PSORENW("SIG",1)=PSORENW("INS")
"RTN","PSORENW1",22,0)
 G:$G(PSORENW("ENT")) FDR
"RTN","PSORENW1",23,0)
 I $G(PSORENW("ENT"))'>0,'$O(^PSRX(PSORENW("OIRXN"),6,0)) S PSORENW("ENT")=0 G FDR
"RTN","PSORENW1",24,0)
 F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW1",25,0)
 .S PSORENW("ENT")=$G(PSORENW("ENT"))+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW1",26,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW1",27,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW1",28,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW1",29,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW1",30,0)
 .K DOSE
"RTN","PSORENW1",31,0)
FDR I $G(PSOFDR) D
"RTN","PSORENW1",32,0)
 .F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",I)=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW1",33,0)
 .S $P(PSORENW("RX0"),"^",7)=$P(OR0,"^",10),$P(PSORENW("RX0"),"^",11)=$P(OR0,"^",17)
"RTN","PSORENW1",34,0)
 .S (PSORX("PROVIDER NAME"),PSORENW("PROVIDER NAME"))=$P(^VA(200,$P(OR0,"^",5),0),"^"),PSORENW("PROVIDER")=$P(OR0,"^",5)
"RTN","PSORENW1",35,0)
 .K PSORENW("COSIGNING PROVIDER")
"RTN","PSORENW1",36,0)
 .I $G(PSORENW("PROVIDER")),$P($G(^VA(200,PSORENW("PROVIDER"),"PS")),"^",7),$P($G(^("PS")),"^",8) S PSORENW("COSIGNING PROVIDER")=$P($G(^("PS")),"^",8)
"RTN","PSORENW1",37,0)
 .S (PSDY,PSORENW("DAYS SUPPLY"))=$P(PSORENW("RX0"),"^",8)
"RTN","PSORENW1",38,0)
 .S POERR=1,DREN=$P(PSORENW("RX0"),"^",6) D DRG^PSOORDRG K POERR S PSODIR("CS")=0
"RTN","PSORENW1",39,0)
 .F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S PSODIR("CS")=1
"RTN","PSORENW1",40,0)
 .I PSODIR("CS") S RFMX=$S(PSDY<60:5,PSDY'<60&(PSDY'>89):2,PSDY=90:1,1:0)
"RTN","PSORENW1",41,0)
 .E  S RFMX=$S(PSDY<60:11,PSDY'<60&(PSDY'>89):5,PSDY=90:3,1:0)
"RTN","PSORENW1",42,0)
 .S $P(PSORENW("RX0"),"^",9)=$S($P(OR0,"^",11)'>RFMX:$P(OR0,"^",11),1:RFMX),$P(OR0,"^",11)=$P(PSORENW("RX0"),"^",9)
"RTN","PSORENW1",43,0)
 .K RFMX,PSODIR("CS"),PSDY
"RTN","PSORENW1",44,0)
END Q
"RTN","PSORENW1",45,0)
STOP K PSEXDT,X,%DT S PSON52("QFLG")=0,DAYS=$S($G(PSORENW("DAYS SUPPLY")):PSORENW("DAYS SUPPLY"),1:$P(PSORENW("RX0"),"^",8))
"RTN","PSORENW1",46,0)
 S DEA("CS")=0 K DIR,DIC
"RTN","PSORENW1",47,0)
 F DEA=1:1 Q:$E(PSODRUG("DEA"),DEA)=""  I $E(+PSODRUG("DEA"),DEA)>1,$E(+PSODRUG("DEA"),DEA)<6 S DEA("CS")=1
"RTN","PSORENW1",48,0)
 S X1=$S($G(PSORENW("ISSUE DATE")):$G(PSORENW("ISSUE DATE")),1:DT),X2=DAYS*($P(PSORENW("RX0"),"^",9)+1)\1
"RTN","PSORENW1",49,0)
 S X2=$S(DAYS=X2&('DEA("CS")):X2,DEA("CS"):184,1:366) D C^%DTC
"RTN","PSORENW1",50,0)
 I PSORENW("FILL DATE")>$P(X,".") S PSEXDT=1_"^"_$P(X,".")
"RTN","PSORENW1",51,0)
 K X1,X2,X,%DT
"RTN","PSORENW1",52,0)
 Q
"RTN","PSORENW1",53,0)
OERR ;renewal finish from oe/rr
"RTN","PSORENW1",54,0)
 S PSORENW("RX0")=^PSRX(PSORENW("OIRXN"),0),PSORENW("RX2")=^(2),PSORENW("RX3")=^(3),PSORENW("STA")=^("STA"),PSORENW("TN")=$G(^("TN"))
"RTN","PSORENW1",55,0)
 S $P(PSORENW("RX0"),"^",4)=$P(OR0,"^",5)
"RTN","PSORENW1",56,0)
 S PSORENW("PROVIDER")=$P(OR0,"^",5)
"RTN","PSORENW1",57,0)
 S PSORX("PROVIDER NAME")=$P($G(^VA(200,PSORENW("PROVIDER"),0)),"^")
"RTN","PSORENW1",58,0)
 S $P(PSORENW("RX0"),"^",5)=$P(OR0,"^",13)
"RTN","PSORENW1",59,0)
 S PSORENW("CLINIC")=$P(OR0,"^",13)
"RTN","PSORENW1",60,0)
 S PSORENW("REMARKS")="RENEWED FROM RX # "_$P(PSORENW("RX0"),"^")_"."_$S($P(OR0,"^",17)="C":" Administered in Clinic.",1:"")
"RTN","PSORENW1",61,0)
 S PSORENW("SIG")=$P($G(^PSRX(PSORENW("OIRXN"),"SIG")),"^"),SIGOK=$P(^("SIG"),"^",2) I SIGOK D
"RTN","PSORENW1",62,0)
 .F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),"SIG1",I)) Q:'I  S SIG(I)=^PSRX(PSORENW("OIRXN"),"SIG1",I,0)
"RTN","PSORENW1",63,0)
 S:$P(PSORENW("RX3"),"^",3) PSORENW("COSIGNING PROVIDER")=$P(PSORENW("RX3"),"^",3)
"RTN","PSORENW1",64,0)
 S PSORENW("PSODFN")=$P(PSORENW("RX0"),"^",2)
"RTN","PSORENW1",65,0)
 S PSORENW("ORX #")=$P(PSORENW("RX0"),"^")
"RTN","PSORENW1",66,0)
 S PSORENW("DRUG IEN")=$P(PSORENW("RX0"),"^",6),$P(PSORENW("RX0"),"^",11)=$P(OR0,"^",17)
"RTN","PSORENW1",67,0)
 S PSORENW("INS")=$S($G(PSORENW("INS"))]"":PSORENW("INS"),1:$G(^PSRX(PSORENW("OIRXN"),"INS")))
"RTN","PSORENW1",68,0)
 Q:$G(PSORENW("ENT"))>0
"RTN","PSORENW1",69,0)
 F I=0:0 S I=$O(^PSRX(PSORENW("OIRXN"),6,I)) Q:'I  S DOSE=^PSRX(PSORENW("OIRXN"),6,I,0) D
"RTN","PSORENW1",70,0)
 .S PSORENW("ENT")=PSORENW("ENT")+1,PSORENW("DOSE",PSORENW("ENT"))=$P(DOSE,"^")
"RTN","PSORENW1",71,0)
 .S PSORENW("UNITS",PSORENW("ENT"))=$P(DOSE,"^",3),PSORENW("DOSE ORDERED",PSORENW("ENT"))=$P(DOSE,"^",2),PSORENW("ROUTE",PSORENW("ENT"))=$P(DOSE,"^",7)
"RTN","PSORENW1",72,0)
 .S PSORENW("SCHEDULE",PSORENW("ENT"))=$P(DOSE,"^",8),PSORENW("DURATION",PSORENW("ENT"))=$P(DOSE,"^",5),PSORENW("CONJUNCTION",PSORENW("ENT"))=$P(DOSE,"^",6)
"RTN","PSORENW1",73,0)
 .S PSORENW("NOUN",PSORENW("ENT"))=$P(DOSE,"^",4),PSORENW("VERB",PSORENW("ENT"))=$P(DOSE,"^",9)
"RTN","PSORENW1",74,0)
 .I $G(^PSRX(PSORENW("OIRXN"),6,I,1))]"" S PSORENW("ODOSE",PSORENW("ENT"))=^PSRX(PSORENW("OIRXN"),6,I,1)
"RTN","PSORENW1",75,0)
 .K DOSE
"RTN","PSORENW1",76,0)
 Q
"RTN","PSORENW1",77,0)
SETIB ;Set defaults on Renewals with Copay information
"RTN","PSORENW1",78,0)
 ;If answer is in Pending File, use that, else look in Prescription file
"RTN","PSORENW1",79,0)
 N PSOOICD,JJJ
"RTN","PSORENW1",80,0)
 K PSOSCP,PSOANSQ("SC>50") D SCP^PSORN52D S PSOANSQ("SC>50")="" K PSOSCA
"RTN","PSORENW1",81,0)
 I '$G(PSOIBOLD) Q
"RTN","PSORENW1",82,0)
 I $G(PSOFDR),$G(ORD) D SETIBP Q
"RTN","PSORENW1",83,0)
 ;I '$$DT^PSOMLLDT Q
"RTN","PSORENW1",84,0)
 I $G(PSORX(PSOIBOLD,"SC"))'=0,$G(PSORX(PSOIBOLD,"SC"))'=1 S PSORX(PSOIBOLD,"SC")=$S($P($G(^PSRX(PSOIBOLD,"IBQ")),"^")'="":$P($G(^("IBQ")),"^"),$P($G(^PSRX(PSOIBOLD,"IB")),"^"):0,1:"")
"RTN","PSORENW1",85,0)
 I $G(PSORX(PSOIBOLD,"SC"))="" K PSORX(PSOIBOLD,"SC")
"RTN","PSORENW1",86,0)
 I '$$DT^PSOMLLDT Q
"RTN","PSORENW1",87,0)
 I $G(PSORX(PSOIBOLD,"MST"))'=0,$G(PSORX(PSOIBOLD,"MST"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",2)'="" S PSORX(PSOIBOLD,"MST")=$P($G(^("IBQ")),"^",2)
"RTN","PSORENW1",88,0)
 I $G(PSORX(PSOIBOLD,"VEH"))'=0,$G(PSORX(PSOIBOLD,"VEH"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",3)'="" S PSORX(PSOIBOLD,"VEH")=$P($G(^("IBQ")),"^",3)
"RTN","PSORENW1",89,0)
 I $G(PSORX(PSOIBOLD,"RAD"))'=0,$G(PSORX(PSOIBOLD,"RAD"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",4)'="" S PSORX(PSOIBOLD,"RAD")=$P($G(^("IBQ")),"^",4)
"RTN","PSORENW1",90,0)
 I $G(PSORX(PSOIBOLD,"PGW"))'=0,$G(PSORX(PSOIBOLD,"PGW"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",5)'="" S PSORX(PSOIBOLD,"PGW")=$P($G(^("IBQ")),"^",5)
"RTN","PSORENW1",91,0)
 I $G(PSORX(PSOIBOLD,"HNC"))'=0,$G(PSORX(PSOIBOLD,"HNC"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",6)'="" S PSORX(PSOIBOLD,"HNC")=$P($G(^("IBQ")),"^",6)
"RTN","PSORENW1",92,0)
 I $G(PSORX(PSOIBOLD,"CV"))'=0,$G(PSORX(PSOIBOLD,"CV"))'=1,$P($G(^PSRX(PSOIBOLD,"IBQ")),"^",7)'="" S PSORX(PSOIBOLD,"CV")=$P($G(^("IBQ")),"^",7)
"RTN","PSORENW1",93,0)
 ;
"RTN","PSORENW1",94,0)
SET2 ;for when patient status is exempt or SC>50
"RTN","PSORENW1",95,0)
 I $TR($G(^PSRX(PSOIBOLD,"IBQ")),"^")="" S PSOOICD=$G(^PSRX(PSOIBOLD,"ICD",1,0)) D SET3:PSOOICD'=""
"RTN","PSORENW1",96,0)
 ;
"RTN","PSORENW1",97,0)
ICD I $D(^PSRX(PSORENW("OIRXN"),"ICD",0)) D
"RTN","PSORENW1",98,0)
 . N JJ,ICD,II,FLD,RXN S RXN=PSOIBOLD
"RTN","PSORENW1",99,0)
 . S II=0 F  S II=$O(^PSRX(PSORENW("OIRXN"),"ICD",II)) Q:II=""!(II'?1N.N)  D
"RTN","PSORENW1",100,0)
 .. S ICD=^PSRX(PSORENW("OIRXN"),"ICD",II,0),FLD=$P(ICD,U) D ICD^PSONEWF
"RTN","PSORENW1",101,0)
 Q
"RTN","PSORENW1",102,0)
SET3 ;for when patient status is exempt or SC>50
"RTN","PSORENW1",103,0)
 N PSOPATST S PSOPATST=PSORX("PATIENT STATUS")
"RTN","PSORENW1",104,0)
 I PSORX("PATIENT STATUS")'?1N.N S PSOPATST="",PSOPATST=$O(^PS(53,"B",PSORX("PATIENT STATUS"),PSOPATST))
"RTN","PSORENW1",105,0)
 F JJJ=2:1:8 I $P(PSOOICD,"^",JJJ)=0!($P(PSOOICD,"^",JJJ)=1) D
"RTN","PSORENW1",106,0)
 . I JJJ=2 S PSORX(PSOIBOLD,"VEH")=$P(PSOOICD,"^",JJJ)
"RTN","PSORENW1",107,0)
 . I JJJ=3 S PSORX(PSOIBOLD,"RAD")=$P(PSOOICD,"^",JJJ)
"RTN","PSORENW1",108,0)
 . I JJJ=4 D
"RTN","PSORENW1",109,0)
 .. S:PSOSCP<50 PSORX(PSOIBOLD,"SC")=$P(PSOOICD,"^",JJJ)
"RTN","PSORENW1",110,0)
 .. S:PSOSCP>49!($P($G(^PS(53,+$G(PSOPATST),0)),"^",7)=1) PSORX(PSOIBOLD,"SC>50")=$P(PSOOICD,"^",JJJ)
"RTN","PSORENW1",111,0)
 . I JJJ=5 S PSORX(PSOIBOLD,"PGW")=$P(PSOOICD,"^",JJJ)
"RTN","PSORENW1",112,0)
 . I JJJ=6 S PSORX(PSOIBOLD,"MST")=$P(PSOOICD,"^",JJJ)
"RTN","PSORENW1",113,0)
 . I JJJ=7 S PSORX(PSOIBOLD,"HNC")=$P(PSOOICD,"^",JJJ)
"RTN","PSORENW1",114,0)
 . I JJJ=8 S PSORX(PSOIBOLD,"CV")=$P(PSOOICD,"^",JJJ)
"RTN","PSORENW1",115,0)
 K JJJ,PSOOICD
"RTN","PSORENW1",116,0)
 Q
"RTN","PSORENW1",117,0)
SETIBP ;
"RTN","PSORENW1",118,0)
 I $P($G(^PS(52.41,ORD,0)),"^",16)="SC"!($P($G(^(0)),"^",16)="NSC") S PSORX(PSOIBOLD,"SC")=$S($P($G(^(0)),"^",16)="SC":1,1:0)
"RTN","PSORENW1",119,0)
 I $G(PSORX(PSOIBOLD,"SC"))="" K PSORX(PSOIBOLD,"SC")
"RTN","PSORENW1",120,0)
 I '$$DT^PSOMLLDT Q
"RTN","PSORENW1",121,0)
 N PSOIBQFN S PSOIBQFN=$G(^PS(52.41,ORD,"IBQ"))
"RTN","PSORENW1",122,0)
 I $P(PSOIBQFN,"^",1)=0!($P(PSOIBQFN,"^",1)=1) S PSORX(PSOIBOLD,"MST")=$P(PSOIBQFN,"^")
"RTN","PSORENW1",123,0)
 I $P(PSOIBQFN,"^",2)=0!($P(PSOIBQFN,"^",2)=1) S PSORX(PSOIBOLD,"VEH")=$P(PSOIBQFN,"^",2)
"RTN","PSORENW1",124,0)
 I $P(PSOIBQFN,"^",3)=0!($P(PSOIBQFN,"^",3)=1) S PSORX(PSOIBOLD,"RAD")=$P(PSOIBQFN,"^",3)
"RTN","PSORENW1",125,0)
 I $P(PSOIBQFN,"^",4)=0!($P(PSOIBQFN,"^",4)=1) S PSORX(PSOIBOLD,"PGW")=$P(PSOIBQFN,"^",4)
"RTN","PSORENW1",126,0)
 I $P(PSOIBQFN,"^",5)=0!($P(PSOIBQFN,"^",5)=1) S PSORX(PSOIBOLD,"HNC")=$P(PSOIBQFN,"^",5)
"RTN","PSORENW1",127,0)
 I $P(PSOIBQFN,"^",6)=0!($P(PSOIBQFN,"^",6)=1) S PSORX(PSOIBOLD,"CV")=$P(PSOIBQFN,"^",6)
"RTN","PSORENW1",128,0)
 ;for when patient status is exempt, null IBQ node was set for exempts or SC>50 - data is in ICD node
"RTN","PSORENW1",129,0)
 I $TR($G(^PS(52.41,ORD,"IBQ")),"^")="" S PSOOICD=$G(^PS(52.41,ORD,"ICD",1,0)) D SET3:PSOOICD'=""
"RTN","PSORENW1",130,0)
 ;
"RTN","PSORENW1",131,0)
ICD2 ;
"RTN","PSORENW1",132,0)
 I $D(^PS(52.41,ORD,"ICD",0)) D
"RTN","PSORENW1",133,0)
 . N JJ,ICD,II,FLD,RXN S RXN=ORD
"RTN","PSORENW1",134,0)
 . S II=0 F  S II=$O(^PS(52.41,ORD,"ICD",II)) Q:II=""!(II'?1N.N)  D
"RTN","PSORENW1",135,0)
 .. S ICD="",ICD=^PS(52.41,ORD,"ICD",II,0)
"RTN","PSORENW1",136,0)
 .. I $G(PSOSCP)>49&(II=1) S PSORX(PSOIBOLD,"SC>50")=$P(ICD,"^",4)
"RTN","PSORENW1",137,0)
 .. S JJ="" F JJ=1:1:8 S FLD=$P(ICD,U,JJ) D ICD^PSONEWF
"RTN","PSORENW1",138,0)
 ;
"RTN","PSORENW1",139,0)
 K PSOIBQFN
"RTN","PSORENW1",140,0)
 Q
"RTN","PSORENW1",141,0)
KLIB ;Kill renewal IB array
"RTN","PSORENW1",142,0)
 I '$G(PSOIBOLD) Q
"RTN","PSORENW1",143,0)
 K PSORX(PSOIBOLD,"SC"),PSORX(PSOIBOLD,"MST"),PSORX(PSOIBOLD,"VEH"),PSORX(PSOIBOLD,"RAD"),PSORX(PSOIBOLD,"PGW"),PSORX(PSOIBOLD,"HNC"),PSORX(PSOIBOLD,"CV")
"RTN","PSORENW1",144,0)
 K PSOIBOLD
"RTN","PSORENW1",145,0)
 Q
"RTN","PSORN52")
0^16^B42247336^B41220096
"RTN","PSORN52",1,0)
PSORN52 ;BIR/DSD - files renewal entries in prescription file ;08/09/93
"RTN","PSORN52",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**1,11,27,37,46,79,71,100,117,157,143,219,148,239**;DEC 1997
"RTN","PSORN52",3,0)
 ;Ext ref to ^PS(55 sup by DBIA 2228
"RTN","PSORN52",4,0)
 ;Ext ref to PSOUL^PSSLOCK sup by DBIA 2789
"RTN","PSORN52",5,0)
 ;Ext ref to ^VA(200 sup by DBIA 10060
"RTN","PSORN52",6,0)
EN(PSOX) ;EP
"RTN","PSORN52",7,0)
START ;
"RTN","PSORN52",8,0)
 D:$D(XRTL) T0^%ZOSV ; Start RT Mon
"RTN","PSORN52",9,0)
 N PSOIBHLD,PSOSCOTH,PSOSCOTX S (PSOSCOTH,PSOSCOTX)=0 S PSOIBHLD="" I $G(PSOFDR),$G(ORD) D
"RTN","PSORN52",10,0)
 .S PSOIBHLD=$S($P($G(^PS(52.41,ORD,0)),"^",16)="SC":1,$P($G(^(0)),"^",16)="NSC":0,1:"")
"RTN","PSORN52",11,0)
 .I '$$DT^PSOMLLDT Q
"RTN","PSORN52",12,0)
 .N PSOIBHLX S PSOIBHLX=$G(^PS(52.41,ORD,"IBQ"))
"RTN","PSORN52",13,0)
 .S PSOIBHLD=PSOIBHLD_"^"_$S($P(PSOIBHLX,"^")=1:1,$P(PSOIBHLX,"^")=0:0,1:"")_"^"_$S($P(PSOIBHLX,"^",2)=1:1,$P(PSOIBHLX,"^",2)=0:0,1:"")_"^"_$S($P(PSOIBHLX,"^",3)=1:1,$P(PSOIBHLX,"^",3)=0:0,1:"")
"RTN","PSORN52",14,0)
 .S PSOIBHLD=PSOIBHLD_"^"_$S($P(PSOIBHLX,"^",4)=1:1,$P(PSOIBHLX,"^",4)=0:0,1:"")_"^"_$S($P(PSOIBHLX,"^",5)=1:1,$P(PSOIBHLX,"^",5)=0:0,1:"")_"^"_$S($P(PSOIBHLX,"^",6)=1:1,$P(PSOIBHLX,"^",6)=0:0,1:"")
"RTN","PSORN52",15,0)
 .I $P(PSOIBHLX,"^")=1!($P(PSOIBHLX,"^",2)=1)!($P(PSOIBHLX,"^",3)=1)!($P(PSOIBHLX,"^",4)=1)!($P(PSOIBHLX,"^",5)=1)!($P(PSOIBHLX,"^",6)=1) S PSOSCOTH=1
"RTN","PSORN52",16,0)
 I $G(PSOSCOTH)!($G(PSORX("SC"))="SC")!($G(PSORX("SC"))="NSC") S PSOSCOTX=1
"RTN","PSORN52",17,0)
 S PSOANSQ("SC>50")="" D SCP^PSORN52D
"RTN","PSORN52",18,0)
 I $G(PSOFDR),$G(ORD) I $D(^PS(52.41,ORD,"ICD")) S FILE=52.41 D GET^PSORN52D
"RTN","PSORN52",19,0)
 ;Set ans to renew from Rx, only if no ans from Pend file
"RTN","PSORN52",20,0)
 I $G(PSORENW("OIRXN")) D
"RTN","PSORN52",21,0)
 .N PSOLDIBQ S PSOLDIBQ=$G(^PSRX(PSORENW("OIRXN"),"IBQ"))
"RTN","PSORN52",22,0)
 .I $P(PSOIBHLD,"^")="" D
"RTN","PSORN52",23,0)
 ..I $P($G(^PSRX(PSORENW("OIRXN"),"IB")),"^")=2 S $P(PSOIBHLD,"^")=0
"RTN","PSORN52",24,0)
 .I '$$DT^PSOMLLDT Q
"RTN","PSORN52",25,0)
 .I PSOLDIBQ="" Q
"RTN","PSORN52",26,0)
 .D IBHLD^PSORN52A
"RTN","PSORN52",27,0)
 D INIT G:PSORN52("QFLG") END D FILE^PSORN52A
"RTN","PSORN52",28,0)
 S:$D(XRT0) XRTN=$T(+0) D:$D(XRT0) T1^%ZOSV ; Stop RT Mon
"RTN","PSORN52",29,0)
 K PSOANSQ,PSOANSQD,PSONEWFF
"RTN","PSORN52",30,0)
 I $G(PSOIBHLD)'="" D
"RTN","PSORN52",31,0)
 .;Set answers based on Pend Renew, prior to Phar call
"RTN","PSORN52",32,0)
 .Q:'$G(PSOX("IRXN"))
"RTN","PSORN52",33,0)
 .I $P(PSOIBHLD,"^")=1!($P(PSOIBHLD,"^")=0) S PSOANSQ("SC")=$P(PSOIBHLD,"^")
"RTN","PSORN52",34,0)
 .I '$$DT^PSOMLLDT Q
"RTN","PSORN52",35,0)
 .I $P(PSOIBHLD,"^",2)=1!($P(PSOIBHLD,"^",2)=0) S PSOANSQ(PSOX("IRXN"),"MST")=$P(PSOIBHLD,"^",2)
"RTN","PSORN52",36,0)
 .I $P(PSOIBHLD,"^",3)=1!($P(PSOIBHLD,"^",3)=0) S PSOANSQ(PSOX("IRXN"),"VEH")=$P(PSOIBHLD,"^",3)
"RTN","PSORN52",37,0)
 .I $P(PSOIBHLD,"^",4)=1!($P(PSOIBHLD,"^",4)=0) S PSOANSQ(PSOX("IRXN"),"RAD")=$P(PSOIBHLD,"^",4)
"RTN","PSORN52",38,0)
 .I $P(PSOIBHLD,"^",5)=1!($P(PSOIBHLD,"^",5)=0) S PSOANSQ(PSOX("IRXN"),"PGW")=$P(PSOIBHLD,"^",5)
"RTN","PSORN52",39,0)
 .I $P(PSOIBHLD,"^",6)=1!($P(PSOIBHLD,"^",6)=0) S PSOANSQ(PSOX("IRXN"),"HNC")=$P(PSOIBHLD,"^",6)
"RTN","PSORN52",40,0)
 .I $P(PSOIBHLD,"^",7)=1!($P(PSOIBHLD,"^",7)=0) S PSOANSQ(PSOX("IRXN"),"CV")=$P(PSOIBHLD,"^",7)
"RTN","PSORN52",41,0)
 K PSOIBHLD
"RTN","PSORN52",42,0)
 I '$G(PSOFDR) I $G(PSORENW("OIRXN")) S FILE=52 D GET^PSORN52D
"RTN","PSORN52",43,0)
 S PSONEW("NEWCOPAY")=""
"RTN","PSORN52",44,0)
 I (PSOSCP<50&('$P($G(^PS(53,+$P(^PSRX(PSOX("IRXN"),0),"^",3),0)),"^",7))),$G(DUZ("AG"))="V" S PSOFLAG=0 D COPAY^PSOCPB
"RTN","PSORN52",45,0)
 ;I PSOSCP>49!($P($G(^PS(53,+$P(^PSRX(PSOX("IRXN"),0),"^",3),0)),"^",7)=1) S PSOFLAG=0 D SC^PSOMLLD2
"RTN","PSORN52",46,0)
 I PSOSCA&(PSOSCP>49)!((PSOSCA!(PSOBILL=2))&($P($G(^PS(53,+$P(^PSRX(PSOX("IRXN"),0),"^",3),0)),"^",7)=1)) S PSOFLAG=0 D SC^PSOMLLD2
"RTN","PSORN52",47,0)
 I $$DT^PSOMLLDT D
"RTN","PSORN52",48,0)
 .I $D(PSOIBQS(PSODFN,"CV")) D MESS D CV^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"CV")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",49,0)
 .I $D(PSOIBQS(PSODFN,"VEH")) D MESS D VEH^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"VEH")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",50,0)
 .I $D(PSOIBQS(PSODFN,"RAD")) D MESS D RAD^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"RAD")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",51,0)
 .I $D(PSOIBQS(PSODFN,"PGW")) D MESS D PGW^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"PGW")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",52,0)
 .I $D(PSOIBQS(PSODFN,"MST")) D MESS D MST^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"MST")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",53,0)
 .I $D(PSOIBQS(PSODFN,"HNC")) D MESS D HNC^PSOMLLDT I $G(PSOANSQ(PSOX("IRXN"),"HNC")) K PSONEW("NEWCOPAY")
"RTN","PSORN52",54,0)
 K PSOSCOTH,PSOSCOTX
"RTN","PSORN52",55,0)
 I $G(PSONEW("NEWCOPAY")) S ^PSRX(PSOX("IRXN"),"IB")=PSONEW("NEWCOPAY")
"RTN","PSORN52",56,0)
 ;
"RTN","PSORN52",57,0)
 D FINISH,ACP^PSOUTIL
"RTN","PSORN52",58,0)
 ;
"RTN","PSORN52",59,0)
 N PSOSCFLD S PSOSCFLD=$S(PSOSCP'="":$G(PSOANSQ("SC")),1:"")_"^"_$G(PSOANSQ(PSOX("IRXN"),"MST"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"VEH"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"RAD"))
"RTN","PSORN52",60,0)
 S PSOSCFLD=PSOSCFLD_"^"_$G(PSOANSQ(PSOX("IRXN"),"PGW"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"HNC"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"CV"))
"RTN","PSORN52",61,0)
 I PSOSCP<50&($TR(PSOSCFLD,"^")'="")&('$P($G(^PS(53,+$P(^PSRX(PSOX("IRXN"),0),"^",3),0)),"^",7)) S ^PSRX(PSOX("IRXN"),"IBQ")=PSOSCFLD K PSOSCFLD
"RTN","PSORN52",62,0)
 ;
"RTN","PSORN52",63,0)
 D FILE2^PSORN52D
"RTN","PSORN52",64,0)
 K PSONEW("NEWCOPAY"),PSOANSQ
"RTN","PSORN52",65,0)
END D EOJ
"RTN","PSORN52",66,0)
 Q
"RTN","PSORN52",67,0)
INIT S PSORN52("QFLG")=0 S:'$D(PSOX("DAYS SUPPLY")) PSOX("DAYS SUPPLY")=$P(PSOX("RX0"),"^",8)
"RTN","PSORN52",68,0)
 S:'$D(PSOX("# OF REFILLS")) PSOX("# OF REFILLS")=$P(PSOX("RX0"),"^",9) S:'$D(PSOX("ISSUE DATE")) PSOX("ISSUE DATE")=DT
"RTN","PSORN52",69,0)
 D INIT^PSON52 K PSON52
"RTN","PSORN52",70,0)
 Q
"RTN","PSORN52",71,0)
 ;
"RTN","PSORN52",72,0)
FINISH ;
"RTN","PSORN52",73,0)
 G:PSOX("STATUS")=4 FINISHP
"RTN","PSORN52",74,0)
 I $D(PSORX("VERIFY")) D  G FINISHX
"RTN","PSORN52",75,0)
 .K DIC,DLAYGO,DINUM,DIADD,X,DD,DO S DIC="^PS(52.4,",DLAYGO=52.4,DINUM=PSOX("IRXN"),DIC(0)="ML"
"RTN","PSORN52",76,0)
 .S X=PSOX("IRXN") D FILE^DICN K DD,DO,DIC,DLAYGO,DINUM,X
"RTN","PSORN52",77,0)
 .S ^PS(52.4,PSOX("IRXN"),0)=PSOX("IRXN")_"^"_$P(PSOX("NRX0"),"^",2)_"^"_DUZ_"^"_$G(PSOX("OIRXN"))_"^"_$E(PSOX("LOGIN DATE"),1,7)_"^"_PSOX("IRXN")_"^"_PSOX("STOP DATE")
"RTN","PSORN52",78,0)
 .K DIK,DA S DIK="^PS(52.4,",DA=PSOX("IRXN") D IX^DIK K DIK,DA
"RTN","PSORN52",79,0)
 ;
"RTN","PSORN52",80,0)
 I $G(PSOX("QS"))="S",$G(PSOBARCD) S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=0 D SUS^PSORXL K DA G FINISHX
"RTN","PSORN52",81,0)
 ;
"RTN","PSORN52",82,0)
 I PSOX("FILL DATE")>DT,$P(PSOPAR,"^",6) S DA=PSOX("IRXN"),RXFL(PSOX("IRXN"))=0 D SUS^PSORXL K DA G FINISHX
"RTN","PSORN52",83,0)
 ;
"RTN","PSORN52",84,0)
 ; - Submitting Rx to ECME for 3rd Party Billing
"RTN","PSORN52",85,0)
 N ACTION
"RTN","PSORN52",86,0)
 I $$SUBMIT^PSOBPSUT(PSOX("IRXN"),0) D  I ACTION="Q"!(ACTION="^") Q
"RTN","PSORN52",87,0)
 . S ACTION="" D ECMESND^PSOBPSU1(PSOX("IRXN"),0,PSOX("FILL DATE"),"RN")
"RTN","PSORN52",88,0)
 . I $$FIND^PSOREJUT(PSOX("IRXN"),0) D
"RTN","PSORN52",89,0)
 . . S ACTION=$$HDLG^PSOREJU1(PSOX("IRXN"),0,"79,88","RN","IOQ","I")
"RTN","PSORN52",90,0)
 ;
"RTN","PSORN52",91,0)
 I $G(PSOX("QS"))="Q",$G(PSOBARCD) D  G FINISHX
"RTN","PSORN52",92,0)
 . N PSOFROM S PSOFROM="BATCH" I $G(PPL),$L(PPL_PSOX("IRXN")_",")>240 D TRI^PSOBBC D Q^PSORXL K PPL,RXFL
"RTN","PSORN52",93,0)
 .S RXFL(PSOX("IRXN"))=0
"RTN","PSORN52",94,0)
 . I $G(PPL) S PPL=PPL_PSOX("IRXN")_","
"RTN","PSORN52",95,0)
 . E  S PPL=PSOX("IRXN")_","
"RTN","PSORN52",96,0)
 . Q
"RTN","PSORN52",97,0)
FINISHP I $G(PSORX("PSOL",1))']"" S PSORX("PSOL",1)=PSOX("IRXN")_",",RXFL(PSOX("IRXN"))=0 G FINISHX
"RTN","PSORN52",98,0)
 F PSOX1=0:0 S PSOX1=$O(PSORX("PSOL",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSORN52",99,0)
 I $L(PSORX("PSOL",PSOX2))+$L(PSOX("IRXN"))<220 S PSORX("PSOL",PSOX2)=PSORX("PSOL",PSOX2)_PSOX("IRXN")_","
"RTN","PSORN52",100,0)
 E  S PSORX("PSOL",PSOX2+1)=PSOX("IRXN")_","
"RTN","PSORN52",101,0)
 S RXFL(PSOX("IRXN"))=0
"RTN","PSORN52",102,0)
FINISHX ;
"RTN","PSORN52",103,0)
 ;call to build bingo board Rx array
"RTN","PSORN52",104,0)
 S:'$G(PSORX("MAIL/WINDOW")) PSORX("MAIL/WINDOW")=$P(PSORENW("NRX0"),"^",11)
"RTN","PSORN52",105,0)
 I $G(PSORX("MAIL/WINDOW"))["W" S BINGCRT=1,BINGRTE="W",BBFLG=1 D BBRX^PSORN52C
"RTN","PSORN52",106,0)
 K PSOX1,PSOX2
"RTN","PSORN52",107,0)
 Q
"RTN","PSORN52",108,0)
EOJ ;
"RTN","PSORN52",109,0)
 L -^PSRX("B",PSOX("IRXN")) K PSORN52,PSOX("INS"),PSORENW("INS"),PSORXED("INS"),PSONEW("ENT"),PSORXED("ENT"),OLENT,PSOIBHLD,PSOX("SINS"),PSORENW("SINS"),PSORXED("SINS"),FILE
"RTN","PSORN52",110,0)
 D PSOUL^PSSLOCK(PSOX("IRXN")) D PSOUL^PSSLOCK(PSOX("OIRXN"))
"RTN","PSORN52",111,0)
 Q
"RTN","PSORN52",112,0)
MESS ;
"RTN","PSORN52",113,0)
 I $G(PSOSCOTX)=1&(PSOSCP<50) W:$G(PSODRUG("DEA"))'["S"&($G(PSODRUG("DEA"))'["I") !!,"This Rx has been flagged by the provider as: "_$S($G(PSOSCOTH):"NO COPAY",$G(PSORX("SC"))="SC":"NO COPAY",1:"COPAY"),! S PSOSCOTX=2
"RTN","PSORN52",114,0)
 Q
"RTN","PSORN52D")
0^17^B30768895^B45252333
"RTN","PSORN52D",1,0)
PSORN52D ;BIR/LE - files new and renewal entries con't ;02/27/04
"RTN","PSORN52D",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**143,219,239**;DEC 1997
"RTN","PSORN52D",3,0)
 ;External reference VADPT supported by DBIA 10061
"RTN","PSORN52D",4,0)
 Q
"RTN","PSORN52D",5,0)
GET ;must have FILE and PSORENW variables to pull default data for ICD and SC/EI for SC>50% Rx's from file 52
"RTN","PSORN52D",6,0)
 N ARRAY,ERR,SUBF,RXN,II,JJ,ORXN,SUBFLD,PENDSC,PSOPATST,PSOIBQF
"RTN","PSORN52D",7,0)
 I FILE=52 S SUBF=52.052311,SUBFLD=52311,RXN=PSORENW("IRXN"),(SRXN,ORXN)=PSORENW("OIRXN") S:($TR($G(^PSRX(SRXN,"IBQ")),"^")'="") PSOIBQF=1
"RTN","PSORN52D",8,0)
 ;            $TR checks for when patient status is exempt, null IBQ node was set for exempts, or SC>50 - data is in ICD node
"RTN","PSORN52D",9,0)
 I FILE=52.41 S SUBF=52.41311,SUBFLD=311,(SRXN,RXN)=ORD,ORXN=PSORENW("OIRXN") S:($TR($G(^PS(52.41,SRXN,"IBQ")),"^")'="") PSOIBQF=1
"RTN","PSORN52D",10,0)
 D GETS^DIQ(FILE,SRXN,SUBFLD_"*","I","ARRAY","ERR")
"RTN","PSORN52D",11,0)
 K PSORX("ICD"),PSOX("ICD")
"RTN","PSORN52D",12,0)
 Q:'$D(ARRAY)
"RTN","PSORN52D",13,0)
 I FILE=52.41 S PENDSC=$$GET1^DIQ(52.41,ORD,"17"),PENDSC=$S(PENDSC="SC":1,PENDSC="NSC":0,1:"")
"RTN","PSORN52D",14,0)
 S PSOPATST=$$GET1^DIQ(52,RXN_",",3,"I")
"RTN","PSORN52D",15,0)
 ;
"RTN","PSORN52D",16,0)
G1 ;get ICD, if no IBQ node get SC/EI's
"RTN","PSORN52D",17,0)
 F II=1:1:8 Q:'$D(ARRAY(SUBF,(II_","_SRXN_",")))  D
"RTN","PSORN52D",18,0)
 . S PSORX("ICD",II)=ARRAY(SUBF,(II_","_SRXN_","),.01,"I") S:FILE=52.41 PSONEW("ICD",II)=PSORX("ICD",II)
"RTN","PSORN52D",19,0)
 . Q:II>1!($G(PSOIBQF))  ;only need ei's from 1st node; all nodes same for SC/EI
"RTN","PSORN52D",20,0)
 . F JJ=1:1:7 I ARRAY(SUBF,(II_","_SRXN_","),JJ,"I")=1!(ARRAY(SUBF,(II_","_SRXN_","),JJ,"I")=0) D
"RTN","PSORN52D",21,0)
 .. I JJ=1 S (PSOANSQ(RXN,"VEH"),PSORX(ORXN,"VEH"))=ARRAY(SUBF,(II_","_SRXN_","),JJ,"I") Q
"RTN","PSORN52D",22,0)
 .. I JJ=2 S (PSOANSQ(RXN,"RAD"),PSORX(ORXN,"RAD"))=ARRAY(SUBF,(II_","_SRXN_","),JJ,"I") Q
"RTN","PSORN52D",23,0)
 .. I JJ=4 S (PSOANSQ(RXN,"PGW"),PSORX(ORXN,"PGW"))=ARRAY(SUBF,(II_","_SRXN_","),JJ,"I") Q
"RTN","PSORN52D",24,0)
 .. I JJ=5 S (PSOANSQ(RXN,"MST"),PSORX(ORXN,"MST"))=ARRAY(SUBF,(II_","_SRXN_","),JJ,"I") Q
"RTN","PSORN52D",25,0)
 .. I JJ=6 S (PSOANSQ(RXN,"HNC"),PSORX(ORXN,"HNC"))=ARRAY(SUBF,(II_","_SRXN_","),JJ,"I") Q
"RTN","PSORN52D",26,0)
 .. I JJ=7 S (PSOANSQ(RXN,"CV"),PSORX(ORXN,"CV"))=ARRAY(SUBF,(II_","_SRXN_","),JJ,"I") Q
"RTN","PSORN52D",27,0)
 ;
"RTN","PSORN52D",28,0)
 I '$G(PSOIBQF) S II=1,JJ=3 D
"RTN","PSORN52D",29,0)
 . I PSOSCP>49&(FILE=52.41) S (PSOANSQ(RXN,"SC>50"),PSORX(ORXN,"SC>50"),PSOANSQ("SC>50"))=PENDSC Q
"RTN","PSORN52D",30,0)
 . I PSOSCP>49&(FILE'=52.41) S:$D(ARRAY(SUBF,(II_","_SRXN_","),JJ,"I")) (PSOANSQ(RXN,"SC>50"),PSOANSQ("SC>50"),PSORX(ORXN,"SC>50"))=ARRAY(SUBF,(II_","_SRXN_","),JJ,"I") Q
"RTN","PSORN52D",31,0)
 . ; when patient status is exempt use SC>50 variable to differenciate regular SC<50 and exempt SC<50
"RTN","PSORN52D",32,0)
 . I PSOSCP<50&($P($G(^PS(53,+$G(PSOPATST),0)),"^",7)=1) D
"RTN","PSORN52D",33,0)
 .. I FILE=52.41 S (PSOANSQ(RXN,"SC>50"),PSORX(ORXN,"SC>50"),PSOANSQ("SC>50"))=PENDSC Q
"RTN","PSORN52D",34,0)
 .. S:$G(ARRAY(SUBF,(II_","_SRXN_","),JJ,"I")) (PSOANSQ(RXN,"SC>50"),PSORX(ORXN,"SC>50"),PSOANSQ("SC>50"))=ARRAY(SUBF,(II_","_SRXN_","),JJ,"I")
"RTN","PSORN52D",35,0)
 . I PSOSCP<50&($P($G(^PS(53,+$G(PSOPATST),0)),"^",7)'=1) D
"RTN","PSORN52D",36,0)
 .. I FILE=52.41 S (PSOANSQ(RXN,"SC"),PSORX(ORXN,"SC"),PSOANSQ("SC"))=PENDSC Q
"RTN","PSORN52D",37,0)
 .. S:$D(ARRAY(SUBF,(II_","_SRXN_","),JJ,"I")) (PSOANSQ(RXN,"SC"),PSORX(ORXN,"SC"),PSOANSQ("SC"))=ARRAY(SUBF,(II_","_SRXN_","),JJ,"I")
"RTN","PSORN52D",38,0)
 ;
"RTN","PSORN52D",39,0)
 Q
"RTN","PSORN52D",40,0)
 ;
"RTN","PSORN52D",41,0)
FILE ;
"RTN","PSORN52D",42,0)
 Q:'$D(^PSRX(PSOX("OIRXN"),"ICD"))
"RTN","PSORN52D",43,0)
 N II F II=1:1:8 Q:$G(^PSRX(PSOX("OIRXN"),"ICD",II,0))=""  D
"RTN","PSORN52D",44,0)
 . S ^PSRX(PSOX("IRXN"),"ICD",II,0)=$G(^PSRX(PSOX("OIRXN"),"ICD",II,0))
"RTN","PSORN52D",45,0)
 . S:$P(^PSRX(PSOX("IRXN"),"ICD",II,0),"^",1)'="" ^PSRX(PSOX("IRXN"),"ICD","B",$P(^PSRX(PSOX("IRXN"),"ICD",II,0),"^",1),II)=""
"RTN","PSORN52D",46,0)
 I II>1 S ^PSRX(PSOX("IRXN"),"ICD",0)="^52.052311^"_(II-1)_"^"_(II-1)
"RTN","PSORN52D",47,0)
 Q
"RTN","PSORN52D",48,0)
FILE2 ;file ICD's on existing node or build new nodes
"RTN","PSORN52D",49,0)
 ;note: variable PSOSCP2 is only available from CPRS Edit API and MISS
"RTN","PSORN52D",50,0)
 ;        sub-routine below.
"RTN","PSORN52D",51,0)
 N D,RXN,II,TYPE,DATA,DATA1,PSOPATST
"RTN","PSORN52D",52,0)
 I $G(PSOX("IRXN")) S PSOPATST=$$GET1^DIQ(52,PSOX("IRXN")_",",3,"I")
"RTN","PSORN52D",53,0)
 ;I '$G(PSONEW("PATIENT STATUS")) I $G(PSOX("IRXN")) S PSONEW("PATIENT STATUS")=$$GET1^DIQ(52,PSOX("IRXN")_",",3,"I")
"RTN","PSORN52D",54,0)
 I $G(PSOSCP2)!($G(PSOFDR)&($G(ORD))) D
"RTN","PSORN52D",55,0)
 .;if RX edited in CPRS delete all but what is sent from CPRS
"RTN","PSORN52D",56,0)
 . K ^PSRX(PSOX("IRXN"),"ICD"),^PSRX(PSOX("IRXN"),"IBQ")
"RTN","PSORN52D",57,0)
 ;
"RTN","PSORN52D",58,0)
 S DATA="^^^^^^^",(DATA1,TYPE)=""
"RTN","PSORN52D",59,0)
 S $P(DATA,U,4)=$S(PSOSCP>49:$G(PSOANSQ("SC>50")),PSOSCP<50&($P($G(^PS(53,+$G(PSOPATST),0)),"^",7)=1):$G(PSOANSQ("SC>50")),PSOSCP<50&(PSOSCP'=""):$G(PSOANSQ("SC")),1:"")
"RTN","PSORN52D",60,0)
 ;
"RTN","PSORN52D",61,0)
 F  S TYPE=$O(PSOANSQ(PSOX("IRXN"),TYPE)) Q:TYPE=""  D
"RTN","PSORN52D",62,0)
 . I TYPE="VEH" S $P(DATA,U,2)=PSOANSQ(PSOX("IRXN"),"VEH")
"RTN","PSORN52D",63,0)
 . I TYPE="RAD" S $P(DATA,U,3)=PSOANSQ(PSOX("IRXN"),"RAD")
"RTN","PSORN52D",64,0)
 . I TYPE="PGW" S $P(DATA,U,5)=PSOANSQ(PSOX("IRXN"),"PGW")
"RTN","PSORN52D",65,0)
 . I TYPE="MST" S $P(DATA,U,6)=PSOANSQ(PSOX("IRXN"),"MST")
"RTN","PSORN52D",66,0)
 . I TYPE="HNC" S $P(DATA,U,7)=PSOANSQ(PSOX("IRXN"),"HNC")
"RTN","PSORN52D",67,0)
 . I TYPE="CV" S $P(DATA,U,8)=PSOANSQ(PSOX("IRXN"),"CV")
"RTN","PSORN52D",68,0)
 ;
"RTN","PSORN52D",69,0)
 I $O(PSORX("ICD","")) F D=1:1:8 Q:'$D(PSORX("ICD",D))  S $P(DATA,"^")=PSORX("ICD",D) D
"RTN","PSORN52D",70,0)
 . S ^PSRX(PSOX("IRXN"),"ICD",D,0)=DATA,$P(DATA,"^")="",^PSRX(PSOX("IRXN"),"ICD",0)="^52.052311P^"_D_"^"_D
"RTN","PSORN52D",71,0)
 . S:PSORX("ICD",D)'="" ^PSRX(PSOX("IRXN"),"ICD","B",PSORX("ICD",D),D)=""
"RTN","PSORN52D",72,0)
 E  S ^PSRX(PSOX("IRXN"),"ICD",0)="^52.052311P^1^1",^PSRX(PSOX("IRXN"),"ICD",1,0)=$G(DATA)
"RTN","PSORN52D",73,0)
 ;
"RTN","PSORN52D",74,0)
 I PSOSCP<50&(($TR(DATA,"^")'=""))&(($P($G(^PS(53,+$G(PSOPATST),0)),"^",7)'=1)) D
"RTN","PSORN52D",75,0)
 .S DATA1=$G(PSOANSQ("SC"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"MST"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"VEH"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"RAD"))
"RTN","PSORN52D",76,0)
 .S DATA1=DATA1_"^"_$G(PSOANSQ(PSOX("IRXN"),"PGW"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"HNC"))_"^"_$G(PSOANSQ(PSOX("IRXN"),"CV"))
"RTN","PSORN52D",77,0)
 .S:($TR(DATA1,"^")'="") ^PSRX(PSOX("IRXN"),"IBQ")=DATA1
"RTN","PSORN52D",78,0)
 K PSORX("ICD")
"RTN","PSORN52D",79,0)
 Q
"RTN","PSORN52D",80,0)
 ;
"RTN","PSORN52D",81,0)
RESET ;called from reset copay status PSOCPC
"RTN","PSORN52D",82,0)
 ;Must be available at this point:  PSODA, PSOIBQ=SC^MST^AO^IR^EC^HNC^CV
"RTN","PSORN52D",83,0)
 Q:'$D(PSODA)!('$D(PSOIBQ))
"RTN","PSORN52D",84,0)
 Q:'$D(^PSRX(PSODA))
"RTN","PSORN52D",85,0)
 ;Q:'$D(^PSRX(PSODA,"ICD"))  ;if old Rx and no ICD's defined; don't set
"RTN","PSORN52D",86,0)
 N I,DATA,PSOICD
"RTN","PSORN52D",87,0)
 S:$D(^PSRX(PSODA,"ICD")) PSOICD=1
"RTN","PSORN52D",88,0)
 I '$G(DFN) S DFN=$$GET1^DIQ(52,PSODA_",",2,"I")
"RTN","PSORN52D",89,0)
 S DATA="^^^^^^^"
"RTN","PSORN52D",90,0)
 F I=1:1:7 D
"RTN","PSORN52D",91,0)
 . I I=1 S $P(DATA,"^",4)=$P(PSOIBQ,"^",I)
"RTN","PSORN52D",92,0)
 . I I=2 S $P(DATA,"^",6)=$P(PSOIBQ,"^",I)
"RTN","PSORN52D",93,0)
 . I I=3 S $P(DATA,"^",2)=$P(PSOIBQ,"^",I)
"RTN","PSORN52D",94,0)
 . I I=4 S $P(DATA,"^",3)=$P(PSOIBQ,"^",I)
"RTN","PSORN52D",95,0)
 . I I=5 S $P(DATA,"^",5)=$P(PSOIBQ,"^",I)
"RTN","PSORN52D",96,0)
 . I I=6 S $P(DATA,"^",7)=$P(PSOIBQ,"^",I)
"RTN","PSORN52D",97,0)
 . I I=7 S $P(DATA,"^",8)=$P(PSOIBQ,"^",I)
"RTN","PSORN52D",98,0)
 ;
"RTN","PSORN52D",99,0)
 I $G(PSOICD) S I=0 F  S I=$O(^PSRX(PSODA,"ICD",I)) Q:I=""!(I'?1N.NN)  D
"RTN","PSORN52D",100,0)
 . Q:'$D(^PSRX(PSODA,"ICD",I,0))
"RTN","PSORN52D",101,0)
 . S $P(^PSRX(PSODA,"ICD",I,0),"^",2,8)=$P(DATA,"^",2,8)
"RTN","PSORN52D",102,0)
 ; for pre-cidc RX
"RTN","PSORN52D",103,0)
 I '$G(PSOICD) S ^PSRX(PSODA,"ICD",1,0)="^"_$P(DATA,"^",2,8),^PSRX(PSODA,"ICD",0)="^52.052311P^1^1"
"RTN","PSORN52D",104,0)
 Q
"RTN","PSORN52D",105,0)
 ;
"RTN","PSORN52D",106,0)
SCP ;Called from multiple routines - DFN or PSODFN variable must be available to call this subroutine.
"RTN","PSORN52D",107,0)
 I '$G(DFN) S DFN=+$G(PSODFN)
"RTN","PSORN52D",108,0)
 D ELIG^VADPT S PSOANSQ("SC>50")="",(PSOSCA,PSOSCP)="",PSOSCP=$P(VAEL(3),U,2)
"RTN","PSORN52D",109,0)
 S:PSOSCP=""&($P(VAEL(3),U)=1) PSOSCP=0
"RTN","PSORN52D",110,0)
 S PSOSCA=$$SC^SDCO22(DFN)
"RTN","PSORN52D",111,0)
 K VAEL
"RTN","PSORN52D",112,0)
 Q
"VER")
8.0^22.0
"BLD",5960,6)
^219
**END**
**END**
