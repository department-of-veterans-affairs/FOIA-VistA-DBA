Released TIU*1*175 SEQ #174
Extracted from mail message
**KIDS**:TIU*1.0*175^

**INSTALL NAME**
TIU*1.0*175
"BLD",16438,0)
TIU*1.0*175^TEXT INTEGRATION UTILITIES^0^3041013^y
"BLD",16438,1,0)
^^2^2^3040720^^^^
"BLD",16438,1,1,0)
The description of this patch may be found under the National Patch Module 
"BLD",16438,1,2,0)
under TIU*1.0*175.
"BLD",16438,4,0)
^9.64PA^^
"BLD",16438,"KRN",0)
^9.67PA^8989.52^19
"BLD",16438,"KRN",.4,0)
.4
"BLD",16438,"KRN",.401,0)
.401
"BLD",16438,"KRN",.402,0)
.402
"BLD",16438,"KRN",.402,"NM",0)
^9.68A^1^1
"BLD",16438,"KRN",.402,"NM",1,0)
TIU ENTER/EDIT PROGRESS NOTE    FILE #8925^8925^0
"BLD",16438,"KRN",.402,"NM","B","TIU ENTER/EDIT PROGRESS NOTE    FILE #8925",1)

"BLD",16438,"KRN",.403,0)
.403
"BLD",16438,"KRN",.5,0)
.5
"BLD",16438,"KRN",.84,0)
.84
"BLD",16438,"KRN",3.6,0)
3.6
"BLD",16438,"KRN",3.8,0)
3.8
"BLD",16438,"KRN",9.2,0)
9.2
"BLD",16438,"KRN",9.8,0)
9.8
"BLD",16438,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",16438,"KRN",9.8,"NM",1,0)
TIULP^^0^B38748228
"BLD",16438,"KRN",9.8,"NM",2,0)
TIUALRT^^0^B46526341
"BLD",16438,"KRN",9.8,"NM",3,0)
TIUSRVPT^^0^B9630268
"BLD",16438,"KRN",9.8,"NM",4,0)
TIUPNAPI^^0^B17381647
"BLD",16438,"KRN",9.8,"NM",5,0)
TIUSRVA^^0^B21607396
"BLD",16438,"KRN",9.8,"NM",6,0)
TIUSRVP^^0^B72721912
"BLD",16438,"KRN",9.8,"NM",7,0)
TIULADR^^0^B1108615
"BLD",16438,"KRN",9.8,"NM","B","TIUALRT",2)

"BLD",16438,"KRN",9.8,"NM","B","TIULADR",7)

"BLD",16438,"KRN",9.8,"NM","B","TIULP",1)

"BLD",16438,"KRN",9.8,"NM","B","TIUPNAPI",4)

"BLD",16438,"KRN",9.8,"NM","B","TIUSRVA",5)

"BLD",16438,"KRN",9.8,"NM","B","TIUSRVP",6)

"BLD",16438,"KRN",9.8,"NM","B","TIUSRVPT",3)

"BLD",16438,"KRN",19,0)
19
"BLD",16438,"KRN",19.1,0)
19.1
"BLD",16438,"KRN",101,0)
101
"BLD",16438,"KRN",409.61,0)
409.61
"BLD",16438,"KRN",771,0)
771
"BLD",16438,"KRN",870,0)
870
"BLD",16438,"KRN",8989.51,0)
8989.51
"BLD",16438,"KRN",8989.52,0)
8989.52
"BLD",16438,"KRN",8994,0)
8994
"BLD",16438,"KRN","B",.4,.4)

"BLD",16438,"KRN","B",.401,.401)

"BLD",16438,"KRN","B",.402,.402)

"BLD",16438,"KRN","B",.403,.403)

"BLD",16438,"KRN","B",.5,.5)

"BLD",16438,"KRN","B",.84,.84)

"BLD",16438,"KRN","B",3.6,3.6)

"BLD",16438,"KRN","B",3.8,3.8)

"BLD",16438,"KRN","B",9.2,9.2)

"BLD",16438,"KRN","B",9.8,9.8)

"BLD",16438,"KRN","B",19,19)

"BLD",16438,"KRN","B",19.1,19.1)

"BLD",16438,"KRN","B",101,101)

"BLD",16438,"KRN","B",409.61,409.61)

"BLD",16438,"KRN","B",771,771)

"BLD",16438,"KRN","B",870,870)

"BLD",16438,"KRN","B",8989.51,8989.51)

"BLD",16438,"KRN","B",8989.52,8989.52)

"BLD",16438,"KRN","B",8994,8994)

"BLD",16438,"QUES",0)
^9.62^^
"BLD",16438,"REQB",0)
^9.611^8^8
"BLD",16438,"REQB",1,0)
TIU*1.0*46^2
"BLD",16438,"REQB",2,0)
TIU*1.0*112^2
"BLD",16438,"REQB",3,0)
TIU*1.0*122^2
"BLD",16438,"REQB",4,0)
TIU*1.0*140^2
"BLD",16438,"REQB",5,0)
TIU*1.0*158^2
"BLD",16438,"REQB",6,0)
TIU*1.0*160^2
"BLD",16438,"REQB",7,0)
USR*1.0*25^2
"BLD",16438,"REQB",8,0)
TIU*1.0*178^2
"BLD",16438,"REQB","B","TIU*1.0*112",2)

"BLD",16438,"REQB","B","TIU*1.0*122",3)

"BLD",16438,"REQB","B","TIU*1.0*140",4)

"BLD",16438,"REQB","B","TIU*1.0*158",5)

"BLD",16438,"REQB","B","TIU*1.0*160",6)

"BLD",16438,"REQB","B","TIU*1.0*178",8)

"BLD",16438,"REQB","B","TIU*1.0*46",1)

"BLD",16438,"REQB","B","USR*1.0*25",7)

"KRN",.402,1864,-1)
0^1
"KRN",.402,1864,0)
TIU ENTER/EDIT PROGRESS NOTE^3040405.1119^^8925^^^3040917
"KRN",.402,1864,"DIAB",2,0,8925,3)
AUTHOR/DICTATOR//^S X=$$PERSNAME^TIULC1($S($D(TIUAUTH):+TIUAUTH,1:+DUZ));T;REQ
"KRN",.402,1864,"DIAB",3,0,8925,7)
EXPECTED COSIGNER//^S X=$G(TIUDCSNR);REQ
"KRN",.402,1864,"DIAB",7,0,8925,2)
REFERENCE DATE//^S X=$$DATE^TIULS($$NOW^XLFDT,"MM/DD/YY@HR:MIN");T
"KRN",.402,1864,"DIAB",7,0,8925,7)
EXPECTED COSIGNER;REQ
"KRN",.402,1864,"DR",1,8925)
.02////^S X=DFN;.03////^S X=$P($G(TIU("VISIT")),U);.07////^S X=$P($G(TIU("EDT")),U);.08////^S X=$P($G(TIU("LDT")),U);1401////^S X=$P($G(TIU("AD#")),U);I '+$G(TIUBY) S Y="@1";I +$P($G(^TIU(8925,+DA,12)),U,5) S Y="@13";
"KRN",.402,1864,"DR",1,8925,1)
1205////^S X=$P($G(TIU("LOC")),U);@13;I +$G(^TIU(8925,+DA,13)) S Y="@14";1301////^S X=$$NOW^TIULC;@14;I +$P($G(^TIU(8925,+DA,12)),U,2) S Y="@1";1202////^S X=$S($D(TIUAUTH):+TIUAUTH,1:+$G(DUZ));@1;I +$G(TIUBY) S Y="@2";
"KRN",.402,1864,"DR",1,8925,2)
I $P($G(^SC(+$G(TIU("LOC")),0)),U,3)="W" S Y="@3";1205////^S X=$P($G(TIU("LOC")),U);S Y="@4";@3;1205//^S X=$P($G(TIU("LOC")),U,2);@4;1301T~//^S X=$$DATE^TIULS($$NOW^XLFDT,"MM/DD/YY@HR:MIN");
"KRN",.402,1864,"DR",1,8925,3)
I +$$DATENOTE^TIULA3($$DATE^TIULS(X,"MM/DD/YY@HR:MIN:SEC"))'>0 S Y="@4";1202R~T~//^S X=$$PERSNAME^TIULC1($S($D(TIUAUTH):+TIUAUTH,1:+DUZ));
"KRN",.402,1864,"DR",1,8925,4)
I +$G(TIUAUTH),(+$P(^TIU(8925,+DA,12),U,2)'=+$G(TIUAUTH)) S TIU("SVC")=$$PROVSVC^TIULV(+$P(^(12),U,2)),TIUAUTH=+$P(^TIU(8925,+DA,12),U,2);@2;1204////^S X=$P($G(^TIU(8925,+DA,12)),U,2);S TIUESNR=X;
"KRN",.402,1864,"DR",1,8925,5)
I +$P($G(^TIU(8925,+DA,13)),U,2) S Y="@5";1302////^S X=DUZ;@5;I +$P($G(^TIU(8925,+DA,12)),U) S Y="@6";1201////^S X=$$NOW^TIULC;@6;S TIURQCS=+$$REQCOSIG^TIULP(+$G(TIUTYP),+DA,+$G(TIUESNR));
"KRN",.402,1864,"DR",1,8925,6)
I 'TIURQCS,($L($P($G(^TIU(8925,+DA,12)),U,8))'>0) S Y="@7";I +TIURQCS S Y="@15";W !!,"No cosignature is required for this author.",!;1208///@;1506///@;S Y="@7";@15;I +$$ISA^USRLM(DUZ,"TRANSCRIPTIONIST") S Y="@8";
"KRN",.402,1864,"DR",1,8925,7)
S TIUDCSNR=$$PERSNAME^TIULC1(+$P($G(TIUPREF),U,9));I TIUDCSNR="UNKNOWN" S Y="@11";1208R~//^S X=$G(TIUDCSNR);K TIUDCSNR;S Y="@9";@11;1208R~;S Y="@9";@8;1208;@9;1506////1;@7;
"KRN",.402,1864,"DR",1,8925,8)
I +$P($G(TIUPREF),U,8)'>0,($G(^TIU(8925,+DA,17))']"") S Y="@10";1701;@10;K TIUESNR,TIURQCS;I $P($G(^TIU(8925,+DA,13)),U,3)]"" S Y="@12";1303////^S X="D";@12;
"KRN",.402,1864,"ROUOLD")
TIUEPN
"MBREQ")
0
"ORD",7,.402)
.402;7;;;EDEOUT^DIFROMSO(.402,DA,"",XPDA);FPRE^DIFROMSI(.402,"",XPDA);EPRE^DIFROMSI(.402,DA,$E("N",$G(XPDNEW)),XPDA,"",OLDA);;EPOST^DIFROMSI(.402,DA,"",XPDA);DEL^DIFROMSK(.402,"",%)
"ORD",7,.402,0)
INPUT TEMPLATE
"PKG",362,-1)
1^1
"PKG",362,0)
TEXT INTEGRATION UTILITIES^TIU^Text Integration Utilities 
"PKG",362,20,0)
^9.402P^^
"PKG",362,22,0)
^9.49I^1^1
"PKG",362,22,1,0)
1.0^2970620^2970819^64
"PKG",362,22,1,"PAH",1,0)
175^3041013^1380
"PKG",362,22,1,"PAH",1,1,0)
^^2^2^3041013
"PKG",362,22,1,"PAH",1,1,1,0)
The description of this patch may be found under the National Patch Module 
"PKG",362,22,1,"PAH",1,1,2,0)
under TIU*1.0*175.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","TIUALRT")
0^2^B46526341
"RTN","TIUALRT",1,0)
TIUALRT ; SLC/JER,AJB - Notify Author and Attending. ; Mar 17, 2003
"RTN","TIUALRT",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**21,84,79,88,58,61,151,158,175**;Jun 20, 1997
"RTN","TIUALRT",3,0)
SEND(DA,OVERDUE) ; Generate "available for signature" alert
"RTN","TIUALRT",4,0)
 N TIU0,TIU12,TIU13,TIU14,TIU15,TIUESNR,TIUPNM,TIUECSNR,TIUSIG,TIUDPRM
"RTN","TIUALRT",5,0)
 N TIUCOSG,TIUEDT,TIUSSN,TIU,TIUTYP,XQA,XQAKILL,XQAMSG,XQAROU,XQAID
"RTN","TIUALRT",6,0)
 N XQAFLG,STATUS,SIGACT,ECSNRFLG
"RTN","TIUALRT",7,0)
 I '$D(TIUPRM0)!'$D(TIUPRM1) D SETPARM^TIULE
"RTN","TIUALRT",8,0)
 I '$D(TIUTMP("NODEL")) D ALERTDEL(DA)
"RTN","TIUALRT",9,0)
 S TIU0=$G(^TIU(8925,+DA,0)),TIU12=$G(^(12)),TIU13=$G(^(13))
"RTN","TIUALRT",10,0)
 S TIU14=$G(^TIU(8925,+DA,14)),TIU15=$G(^(15))
"RTN","TIUALRT",11,0)
 D DOCPRM^TIULC1(+TIU0,.TIUDPRM,DA)
"RTN","TIUALRT",12,0)
 ; Quit if notifications not enabled
"RTN","TIUALRT",13,0)
 I '$D(TIUDPRM(0)) Q
"RTN","TIUALRT",14,0)
 ; If document is an addendum, and the original is incomplete, quit
"RTN","TIUALRT",15,0)
 ; per NOIS DUR-0101-32087
"RTN","TIUALRT",16,0)
 ; I +$$ISADDNDM^TIULC1(DA),($P($G(^TIU(8925,+$P(TIU0,U,6),0)),U,5)<7) Q
"RTN","TIUALRT",17,0)
 I '+$P(TIUPRM1,U,7)!(+$P(TIU12,U)<+$P(TIUPRM1,U,7)) Q
"RTN","TIUALRT",18,0)
 ; If third party alert from TIUALFUN **158**
"RTN","TIUALRT",19,0)
 I $D(TIUTMP("THIRD PARTY ALERTS")) G THIRD
"RTN","TIUALRT",20,0)
 ; If document is completed, jump to additional signers
"RTN","TIUALRT",21,0)
 I (+$P(TIU0,U,5)'<7) G ADDSNR
"RTN","TIUALRT",22,0)
 I +$P(TIU0,U,5)=3,+$P($G(TIUDPRM(0)),U,2),'+$P(TIU13,U,4) Q  ; not released **175**
"RTN","TIUALRT",23,0)
 ; If Verification required, and not verified, don't send
"RTN","TIUALRT",24,0)
 I +$P(TIU0,U,5)=4,+$$REQVER^TIULC(DA,+$P($G(TIUDPRM(0)),U,3)),'+$P(TIU13,U,5) Q  ; **175**
"RTN","TIUALRT",25,0)
 ; Set up for call to XQALERT
"RTN","TIUALRT",26,0)
 S TIUEDT=$$DATE^TIULS($P(TIU0,U,7))
"RTN","TIUALRT",27,0)
 S TIUESNR=$P(TIU12,U,4)
"RTN","TIUALRT",28,0)
 S TIUSIG=$P(TIU15,U)
"RTN","TIUALRT",29,0)
 S TIUECSNR=$P(TIU12,U,8),TIUCOSG=$P(TIU15,U,7)
"RTN","TIUALRT",30,0)
 ; If author has been identified, but not Expected Signer, make
"RTN","TIUALRT",31,0)
 ; author the expected signer
"RTN","TIUALRT",32,0)
 I +TIUESNR'>0,(+$P(TIU12,U,2)>0) D
"RTN","TIUALRT",33,0)
 . N DIE,DR
"RTN","TIUALRT",34,0)
 . S TIUESNR=$P(TIU12,U,2)
"RTN","TIUALRT",35,0)
 . S DIE=8925,DR="1204////^S X=TIUESNR" D ^DIE
"RTN","TIUALRT",36,0)
 ; If attending has been identified, but not Expected Cosigner, make
"RTN","TIUALRT",37,0)
 ; attending the expected cosigner
"RTN","TIUALRT",38,0)
 I +TIUECSNR'>0,(+$P(TIU12,U,9)>0) D
"RTN","TIUALRT",39,0)
 . N DIE,DR
"RTN","TIUALRT",40,0)
 . S TIUECSNR=$P(TIU12,U,9)
"RTN","TIUALRT",41,0)
 . S DIE=8925,DR="1208////^S X=TIUECSNR" D ^DIE
"RTN","TIUALRT",42,0)
 ; If first signature required and the expected signer is authorized
"RTN","TIUALRT",43,0)
 ; to sign this record, and the record is not yet signed
"RTN","TIUALRT",44,0)
 ; ** Set AUTHOR as recipient
"RTN","TIUALRT",45,0)
 I '+$G(TIUSIG),(+TIUESNR>0),(+$P(TIUDPRM(0),U,4)>0) S XQA(TIUESNR)=""
"RTN","TIUALRT",46,0)
 ; If the record requires cosignature, and is not yet cosigned
"RTN","TIUALRT",47,0)
 ; ** Set Expected Cosigner as recipient
"RTN","TIUALRT",48,0)
 I TIUECSNR]"",(+$P(TIU0,U,5)<7),(+$G(TIUCOSG)'>0) D
"RTN","TIUALRT",49,0)
 . N TIUDA S TIUDA=DA
"RTN","TIUALRT",50,0)
 . ; For documents other than Discharge Summaries, defer alerting
"RTN","TIUALRT",51,0)
 . ; Expected Cosigner 'til AUTHOR has signed
"RTN","TIUALRT",52,0)
 . ; If current document is an addendum apply test to its parent
"RTN","TIUALRT",53,0)
 . I +$$ISADDNDM^TIULC1(DA) S TIUDA=$P(^TIU(8925,DA,0),U,6)
"RTN","TIUALRT",54,0)
 . ; If cosigner alerts are to be deferred until signature, quit
"RTN","TIUALRT",55,0)
 . I '+$P(TIUDPRM(0),U,20),'+$G(TIUSIG),+$P(TIUDPRM(0),U,4) Q  ; **84,112/151**
"RTN","TIUALRT",56,0)
 . S XQA(TIUECSNR)="",ECSNRFLG=1 ; **151**
"RTN","TIUALRT",57,0)
ADDSNR ; Send addendum alerts, check for additional signers
"RTN","TIUALRT",58,0)
 I +$$ISADDNDM^TIULC1(DA) D SENDADD(DA)
"RTN","TIUALRT",59,0)
 ; If additional signers have been designated, alert them too
"RTN","TIUALRT",60,0)
 I +$O(^TIU(8925.7,"B",DA,0)),(+$P(TIU0,U,5)>5) D
"RTN","TIUALRT",61,0)
 . N TIUXTRA,TIUI D XTRASGNR^TIULG(.TIUXTRA,DA) Q:+$D(TIUXTRA)'>9
"RTN","TIUALRT",62,0)
 . S TIUI=0 F  S TIUI=$O(TIUXTRA(TIUI)) Q:+TIUI'>0  S XQA(TIUI)=""
"RTN","TIUALRT",63,0)
 Q:$D(XQA)'>9
"RTN","TIUALRT",64,0)
THIRD ; **158**
"RTN","TIUALRT",65,0)
 I $D(TIUTMP("THIRD PARTY ALERTS")) D
"RTN","TIUALRT",66,0)
 . N TIUX
"RTN","TIUALRT",67,0)
 . S TIUX="" F  S TIUX=$O(TIUXQA(TIUX)) Q:TIUX=""  S XQA(TIUX)=""
"RTN","TIUALRT",68,0)
 ; Get demographics for alert message
"RTN","TIUALRT",69,0)
 S TIUPNM=$E($P($G(^DPT(+$P(TIU0,U,2),0)),U),1,9)
"RTN","TIUALRT",70,0)
 S TIUTYP=$$PNAME^TIULC1(+$G(TIU0))
"RTN","TIUALRT",71,0)
 D PATVADPT^TIULV(.TIU,+$P(TIU0,U,2))
"RTN","TIUALRT",72,0)
 S TIUSSN=$E(TIUPNM,1)_$P($G(TIU("SSN")),"-",3)
"RTN","TIUALRT",73,0)
 S XQAID="TIU"_+DA,STATUS=$$UP^XLFSTR($$GET1^DIQ(8925,DA,.05)) ; **175** $$STATUS^TIULC(DA))
"RTN","TIUALRT",74,0)
 S SIGACT=$S(STATUS="UNSIGNED":"SIGNATURE",STATUS="UNCOSIGNED":"COSIGNATURE",1:"ADD'L SIGNATURE")
"RTN","TIUALRT",75,0)
 I $G(ECSNRFLG),$P(TIU0,U,5)=5 S STATUS="UNSIG/UNCOS'D" ; **151**
"RTN","TIUALRT",76,0)
 S XQAMSG=TIUPNM_" ("_TIUSSN_"): "_STATUS_" "_$S($P(TIU0,U,9)="P":"STAT ",1:"")_TIUTYP
"RTN","TIUALRT",77,0)
 I +$G(OVERDUE) S XQAMSG=XQAMSG_" OVERDUE for "_SIGACT_"." G ENDMSG
"RTN","TIUALRT",78,0)
 S XQAMSG=XQAMSG_" available for "_SIGACT_"."
"RTN","TIUALRT",79,0)
ENDMSG ;
"RTN","TIUALRT",80,0)
 S XQAROU="ACT^TIUALRT",XQADATA=+DA_U
"RTN","TIUALRT",81,0)
 D SETUP^XQALERT
"RTN","TIUALRT",82,0)
 Q
"RTN","TIUALRT",83,0)
ACT ; Act on alerts
"RTN","TIUALRT",84,0)
 N TIUQUIK,TIUDA,TIUPRM0,TIUPRM1,TIUPRM3,RSTOK S TIUQUIK=1 K XQAKILL
"RTN","TIUALRT",85,0)
 S TIUDA=$P(XQADATA,U)
"RTN","TIUALRT",86,0)
 I '$D(^TIU(8925,+TIUDA,0)) D ALERTDEL(TIUDA) Q
"RTN","TIUALRT",87,0)
 S RSTOK=$$DOCCHK^TIULRR(TIUDA)
"RTN","TIUALRT",88,0)
 I RSTOK'>0 D  Q
"RTN","TIUALRT",89,0)
 . W !!,$C(7),"Ok, no harm done...",! ; Echo denial message
"RTN","TIUALRT",90,0)
 . I $$READ^TIUU("EA","RETURN to continue...") ; pause
"RTN","TIUALRT",91,0)
 I $P(^TIU(8925,+TIUDA,0),U,5)'<7,'+$$ISSIGNR(TIUDA,DUZ) S XQAKILL=1
"RTN","TIUALRT",92,0)
 D:'$D(TIUPRM0)!'$D(TIUPRM1) SETPARM^TIULE
"RTN","TIUALRT",93,0)
 D EN^VALM("TIU BROWSE FOR CLINICIAN")
"RTN","TIUALRT",94,0)
 Q
"RTN","TIUALRT",95,0)
SENDTRAN(DA) ; Generate "Send back to transcription" alert
"RTN","TIUALRT",96,0)
 N TIUEDT,TIU0,TIUPNM,TIUSSN,TIUTRAN,TIU,XQA,XQAMSG,TIUMSG
"RTN","TIUALRT",97,0)
 N TIUESNR,TIU12,TIU13,TIU14,TIU15,TIUTYP
"RTN","TIUALRT",98,0)
 I '$D(TIUPRM0)!'$D(TIUPRM1) D SETPARM^TIULE
"RTN","TIUALRT",99,0)
 D ALERTDEL(DA)
"RTN","TIUALRT",100,0)
 ; Don't send if notifications not enabled
"RTN","TIUALRT",101,0)
 I '+$P(TIUPRM1,U,7) Q
"RTN","TIUALRT",102,0)
 S TIU0=$G(^TIU(8925,+DA,0)),TIU12=$G(^(12)),TIU13=$G(^(13))
"RTN","TIUALRT",103,0)
 S TIU14=$G(^TIU(8925,+DA,14)),TIU15=$G(^(15))
"RTN","TIUALRT",104,0)
 S TIUPNM=$E($P($G(^DPT(+$P(TIU0,U,2),0)),U),1,9)
"RTN","TIUALRT",105,0)
 S TIUEDT=$$DATE^TIULS($P(TIU0,U,7))
"RTN","TIUALRT",106,0)
 S TIUTYP=$$PNAME^TIULC1(+$G(TIU0))
"RTN","TIUALRT",107,0)
 S TIUTRAN=$P(TIU13,U,2),TIUESNR=$P(TIU12,U,2) ; **175**
"RTN","TIUALRT",108,0)
 D PATVADPT^TIULV(.TIU,+$P(TIU0,U,2)) ;Used to get SSN. Date not important.
"RTN","TIUALRT",109,0)
 S TIUSSN=$E(TIUPNM,1)_$P($G(TIU("SSN")),"-",3)
"RTN","TIUALRT",110,0)
 I $D(^VA(200,+TIUTRAN,0)) S XQA(TIUTRAN)=""
"RTN","TIUALRT",111,0)
 Q:$D(XQA)'>9
"RTN","TIUALRT",112,0)
 S TIUMSG=$S(TIUTRAN=TIUESNR:" needs editing",1:" needs retranscription.")
"RTN","TIUALRT",113,0)
 S XQAID="TIU"_+DA
"RTN","TIUALRT",114,0)
 S XQAMSG=TIUPNM_" ("_TIUSSN_"): "_TIUTYP_TIUMSG
"RTN","TIUALRT",115,0)
 D SETUP^XQALERT
"RTN","TIUALRT",116,0)
 Q
"RTN","TIUALRT",117,0)
SENDADD(DA) ; Generates "Addendum added" alert
"RTN","TIUALRT",118,0)
 N TIU12,TIU13,TIU14,TIU15,TIU0,TIUPNM,TIUSSN,TIUTRAN,TIU,TIUTITLE,TIUDPRM
"RTN","TIUALRT",119,0)
 N XQA,XQAMSG,XQAFLG,XQADATA,XQAROU,TIUESNR,TIUDATE,TIUESNM,TIUO0,TIUO12,TIUO13
"RTN","TIUALRT",120,0)
 I '$D(TIUPRM0)!'$D(TIUPRM1) D SETPARM^TIULE
"RTN","TIUALRT",121,0)
 D ADDENDEL(DA)
"RTN","TIUALRT",122,0)
 ; Don't send if notifications not enabled
"RTN","TIUALRT",123,0)
 I '+$P(TIUPRM1,U,7) Q
"RTN","TIUALRT",124,0)
 S TIU0=$G(^TIU(8925,+DA,0))
"RTN","TIUALRT",125,0)
 ; Only send upon completion
"RTN","TIUALRT",126,0)
 Q:+$P(TIU0,U,5)'>6
"RTN","TIUALRT",127,0)
 D DOCPRM^TIULC1(+TIU0,.TIUDPRM,DA) Q:'+$P(TIUDPRM(0),U,17)
"RTN","TIUALRT",128,0)
 S TIU12=$G(^TIU(8925,+DA,12)),TIU13=$G(^(13)),TIU14=$G(^(14)),TIU15=$G(^(15))
"RTN","TIUALRT",129,0)
 S TIUO0=$G(^TIU(8925,$P(TIU0,U,6),0)),TIUO12=$G(^(12)),TIUO13=$G(^(13))
"RTN","TIUALRT",130,0)
 S TIUPNM=$E($$PTNAME^TIULC1(+$P(TIU0,U,2)),1,9)
"RTN","TIUALRT",131,0)
 S TIUESNM=$$NAME^TIULS($$PERSNAME^TIULC1(+$P(TIU12,U,2)),"LAST,FI MI")
"RTN","TIUALRT",132,0)
 S TIUTITLE=$E($$PNAME^TIULC1(+TIUO0),1,20)
"RTN","TIUALRT",133,0)
 S TIUDATE=$S(+$P(TIUO13,U):$P(TIUO13,U),1:$G(DT))
"RTN","TIUALRT",134,0)
 S TIUDATE=$$DATE^TIULS(TIUDATE)
"RTN","TIUALRT",135,0)
 D PATVADPT^TIULV(.TIU,+$P(TIU0,U,2)) ;Used to get SSN. Date not important.
"RTN","TIUALRT",136,0)
 S TIUSSN=$E(TIUPNM,1)_$P($G(TIU("SSN")),"-",3)
"RTN","TIUALRT",137,0)
 S TIUTRAN=$P(TIU13,U,2)
"RTN","TIUALRT",138,0)
 ;Expected Cosigner and Author of original document
"RTN","TIUALRT",139,0)
 S TIUECSNR=$P($G(^TIU(8925,$P(TIU0,U,6),12)),U,8),TIUESNR=$P($G(^(12)),U,4)
"RTN","TIUALRT",140,0)
 ; Not entered by Expected Signer: SET Expected Signer as recipient
"RTN","TIUALRT",141,0)
 I TIUESNR'=TIUTRAN,$D(^VA(200,+TIUESNR,0)) S XQA(TIUESNR)=""
"RTN","TIUALRT",142,0)
 ; Not entered by Expected Cosigner: SET Expected Cosigner as recipient
"RTN","TIUALRT",143,0)
 I +TIUECSNR>0,(TIUECSNR'=TIUTRAN),$D(^VA(200,+TIUECSNR,0)) S XQA(TIUECSNR)=""
"RTN","TIUALRT",144,0)
 Q:$D(XQA)'>9
"RTN","TIUALRT",145,0)
 S XQAID="TIUADD"_+DA,XQADATA=+DA_U,XQAROU="ACTADD^TIUALRT"
"RTN","TIUALRT",146,0)
 S XQAMSG=TIUPNM_" ("_TIUSSN_"): ADDENDUM to "_TIUTITLE_" of "_TIUDATE_" by "_TIUESNM
"RTN","TIUALRT",147,0)
 D SETUP^XQALERT
"RTN","TIUALRT",148,0)
 Q
"RTN","TIUALRT",149,0)
ACTADD ; Act on ADDENDUM alerts
"RTN","TIUALRT",150,0)
 N TIUQUIK,TIUDA,TIUPRM0,TIUPRM1,TIUPRM3 S TIUQUIK=1 K XQAKILL
"RTN","TIUALRT",151,0)
 S TIUDA=$P(XQADATA,U),XQAKILL=1
"RTN","TIUALRT",152,0)
 I '$D(^TIU(8925,+TIUDA,0)) D ADDENDEL(TIUDA) Q
"RTN","TIUALRT",153,0)
 W !!,"A NEW Addendum has been added to your document...",!
"RTN","TIUALRT",154,0)
 W:$L($P($G(XQX),U,3)) !,$P($G(XQX),U,3),!
"RTN","TIUALRT",155,0)
 I '+$$READ^TIUU("YAO","Do you wish to Browse the Addendum now? ","NO") Q
"RTN","TIUALRT",156,0)
 D:'$D(TIUPRM0)!'$D(TIUPRM1) SETPARM^TIULE
"RTN","TIUALRT",157,0)
 D EN^VALM("TIU BROWSE FOR CLINICIAN")
"RTN","TIUALRT",158,0)
 Q
"RTN","TIUALRT",159,0)
ALERTDEL(DA) ; Delete alerts associated with a given document
"RTN","TIUALRT",160,0)
 N XQA,XQAID,XQAKILL S XQAID="TIU"_DA
"RTN","TIUALRT",161,0)
 D DELETEA^XQALERT
"RTN","TIUALRT",162,0)
 Q
"RTN","TIUALRT",163,0)
ADDENDEL(DA) ; Delete alert associated with a Addendum added
"RTN","TIUALRT",164,0)
 N XQA,XQAID,XQAKILL S XQAID="TIUADD"_DA
"RTN","TIUALRT",165,0)
 D DELETEA^XQALERT
"RTN","TIUALRT",166,0)
 Q
"RTN","TIUALRT",167,0)
ISSIGNR(DA,USER) ; Is USER an additional signer of document DA?
"RTN","TIUALRT",168,0)
 N TIUY,TIUSDA,TIUSD0 S (TIUY,TIUSDA)=0
"RTN","TIUALRT",169,0)
 S TIUSDA=+$O(^TIU(8925.7,"AE",DA,USER,0)) G:'TIUSDA ISSIGNX
"RTN","TIUALRT",170,0)
 S TIUSD0=$G(^TIU(8925.7,TIUSDA,0)) G:'$L(TIUSD0) ISSIGNX
"RTN","TIUALRT",171,0)
 I +$P(TIUSD0,U,4)'>0 S TIUY=1
"RTN","TIUALRT",172,0)
ISSIGNX Q TIUY
"RTN","TIULADR")
0^7^B1108615
"RTN","TIULADR",1,0)
TIULADR ; SLC/JER - Adverse Reactions/Allergies ;01/29/04
"RTN","TIULADR",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**46,175**;Jun 20, 1997
"RTN","TIULADR",3,0)
MAIN(DFN,DISPLAY,TARGET,LINE) ; Control branching
"RTN","TIULADR",4,0)
 N TIUI,TIUJ,GMRAL,TIUY
"RTN","TIULADR",5,0)
 I +$G(DISPLAY) W !,"Gathering Allergy Data."
"RTN","TIULADR",6,0)
 D EN1^GMRADPT ; DBIA #10099
"RTN","TIULADR",7,0)
 I $D(GMRAL)'>9 D  G ADRX
"RTN","TIULADR",8,0)
 . S LINE=+$G(LINE)+1
"RTN","TIULADR",9,0)
 . I $D(GMRAL),GMRAL=0 S @TARGET@(LINE,0)="Patient has answered NKA"
"RTN","TIULADR",10,0)
 . E  S @TARGET@(LINE,0)="No Allergy Assessment" ; **175**
"RTN","TIULADR",11,0)
 S TIUI=0,TIUY=""
"RTN","TIULADR",12,0)
 F  S TIUI=$O(GMRAL(TIUI)) Q:+TIUI'>0  D
"RTN","TIULADR",13,0)
 . N X,Y,TIUX
"RTN","TIULADR",14,0)
 . S TIUX=$P($G(GMRAL(TIUI)),U,2)
"RTN","TIULADR",15,0)
 . S TIUY=$$FILL^TIULS(TIUX,TIUY,79)
"RTN","TIULADR",16,0)
 . I TIUY=TIUX S LINE=+$G(LINE)+1
"RTN","TIULADR",17,0)
 . S @TARGET@(LINE,0)=TIUY
"RTN","TIULADR",18,0)
 . I +$G(DISPLAY) W "."
"RTN","TIULADR",19,0)
ADRX Q "~@"_$NA(@TARGET)
"RTN","TIULP")
0^1^B38748228
"RTN","TIULP",1,0)
TIULP ; SLC/JER - Functions determining privilege ; Jan 1, 2004
"RTN","TIULP",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**98,100,116,109,138,152,175**;Jun 20, 1997
"RTN","TIULP",3,0)
CANDO(TIUDA,TIUACT,PERSON) ; Can PERSON perform action now
"RTN","TIULP",4,0)
 ; Receives: TIUDA=Record number in file 8925
"RTN","TIULP",5,0)
 ;           TIUACT=Name of user action in 8930.8 (USR ACTION)
"RTN","TIULP",6,0)
 ;           PERSON=New Person file IFN.
"RTN","TIULP",7,0)
 ;                  Assumed to be DUZ if not received.
"RTN","TIULP",8,0)
 ;                  New **100** ID param, backward compatible.
"RTN","TIULP",9,0)
 ;  Returns:   TIUY=1:yes,0:no_"^"_why not message
"RTN","TIULP",10,0)
 N TIUI,TIUTYP,TIUROLE,STATUS,TIUY,TIUATYP,MSG,WHO,MODIFIER
"RTN","TIULP",11,0)
 S TIUY=0 I '$G(PERSON) S PERSON=DUZ
"RTN","TIULP",12,0)
 ;**100** was I +TIUACT'>0 S TIUACT etc.
"RTN","TIULP",13,0)
 S TIUACT=$$USREVNT(TIUACT) I +TIUACT'>0 S TIUY=0 G CANDOX
"RTN","TIULP",14,0)
 ; **152 Get status to evaluate for completed document.
"RTN","TIULP",15,0)
 S STATUS=+$P($G(^TIU(8925,+TIUDA,0)),U,5)
"RTN","TIULP",16,0)
 ; **152 prevents editing or sending back a completed document.
"RTN","TIULP",17,0)
 I STATUS>6,(+TIUACT=9)!(+TIUACT=17) D  G CANDOX
"RTN","TIULP",18,0)
 .; **152 Displays message to user
"RTN","TIULP",19,0)
 . I +TIUACT=9 S TIUY="0^ You may not edit a completed document."
"RTN","TIULP",20,0)
 . I +TIUACT=17 S TIUY="0^You may not send back this completed document."
"RTN","TIULP",21,0)
 ; -- In case business rules have changed, & children already existed:
"RTN","TIULP",22,0)
 I +TIUACT=24,$D(^TIU(8925,"GDAD",TIUDA)) D  G CANDOX
"RTN","TIULP",23,0)
 . S TIUY="0^ This note cannot be attached; it has its own children."
"RTN","TIULP",24,0)
 I +TIUACT=25,+$G(^TIU(8925,TIUDA,21)) D  G CANDOX
"RTN","TIULP",25,0)
 . S TIUY="0^ This note cannot receive interdisciplinary children; it is itself a child."
"RTN","TIULP",26,0)
 I +TIUACT=4!(+TIUACT=5),+$$BLANK^TIULC(TIUDA) D  G CANDOX
"RTN","TIULP",27,0)
 . S TIUY="0^ Contains blanks ("_$P(TIUPRM1,U,6)_") which must be filled before "_$P(TIUACT,U,2)_"ATURE."
"RTN","TIULP",28,0)
 S TIUROLE=$$USRROLE(TIUDA,PERSON)
"RTN","TIULP",29,0)
 S TIUTYP=+$G(^TIU(8925,+TIUDA,0))
"RTN","TIULP",30,0)
 I $$ISADDNDM^TIULC1(+TIUDA) S TIUATYP=TIUTYP,TIUTYP=+$G(^TIU(8925,+$P($G(^TIU(8925,+TIUDA,0)),U,6),0))
"RTN","TIULP",31,0)
 I TIUROLE']"" S TIUY=$$CANDO^USRLA(TIUTYP,STATUS,+TIUACT,PERSON)
"RTN","TIULP",32,0)
 F TIUI=1:1:($L(TIUROLE,U)-1) D  Q:+$G(TIUY)>0
"RTN","TIULP",33,0)
 . S TIUY=$$CANDO^USRLA(TIUTYP,STATUS,+TIUACT,PERSON,$P(TIUROLE,U,TIUI))
"RTN","TIULP",34,0)
 I +$G(TIUATYP) S TIUTYP=+$G(TIUATYP)
"RTN","TIULP",35,0)
 ;**100** update for PERSON param; update for verb modifier:
"RTN","TIULP",36,0)
 I +TIUY'>0 D  G CANDOX
"RTN","TIULP",37,0)
 . S WHO=" You"
"RTN","TIULP",38,0)
 . I PERSON'=DUZ S WHO=$P(^VA(200,PERSON,0),U),WHO=$$NAME^TIULS(WHO,"FIRST LAST")
"RTN","TIULP",39,0)
 . S MODIFIER=$P(TIUACT,U,3) I $L(MODIFIER) S MODIFIER=" "_MODIFIER
"RTN","TIULP",40,0)
 . ;e.g. "You may not ATTACH this UNSIGNED TELEPHONE NOTE TO AN ID NOTE."
"RTN","TIULP",41,0)
 . S MSG=WHO_" may not "_$P(TIUACT,U,2)_" this "_$P($G(^TIU(8925.6,+STATUS,0)),U)_" "_$$PNAME^TIULC1(TIUTYP)_MODIFIER_"."
"RTN","TIULP",42,0)
 . S TIUY=TIUY_U_MSG
"RTN","TIULP",43,0)
 I +TIUACT=15,$$HASIMG^TIURB2(+TIUDA) D  G CANDOX
"RTN","TIULP",44,0)
 . S TIUY="0^ This document contains linked images. You must ""delete"" the Images using the Imaging package before proceeding."
"RTN","TIULP",45,0)
CANDOX Q TIUY
"RTN","TIULP",46,0)
 ;
"RTN","TIULP",47,0)
CANLINK(TIUTYP) ; Can user (DUZ) link (attach) a document of a particular type
"RTN","TIULP",48,0)
 ;to an ID note.
"RTN","TIULP",49,0)
 ; For use in ADD NEW ID NOTE, where docmt is not entered yet.
"RTN","TIULP",50,0)
 ; Assume most favorable circumstances (user will complete
"RTN","TIULP",51,0)
 ;the note, so if user still can't attach, can tell them no,
"RTN","TIULP",52,0)
 ;when they first select title for the new entry.
"RTN","TIULP",53,0)
 ; Rule out if TIUTYP can be an ID parent, since ID parent
"RTN","TIULP",54,0)
 ;and ID kid function as mutually exclusive, (regardless of
"RTN","TIULP",55,0)
 ;business rules).
"RTN","TIULP",56,0)
 N TIUACT,STATUS,USRROLE,TIUY
"RTN","TIULP",57,0)
 S TIUACT=$$USREVNT("ATTACH TO ID NOTE"),STATUS=7 ; complete
"RTN","TIULP",58,0)
 S USRROLE=+$O(^USR(8930.2,"B","COMPLETER",0))
"RTN","TIULP",59,0)
 S TIUY=$$CANDO^USRLA(TIUTYP,STATUS,+TIUACT,DUZ,USRROLE)
"RTN","TIULP",60,0)
 I '$G(TIUY) S TIUY="0^ You may not use this title for interdisciplinary child entries." Q TIUY
"RTN","TIULP",61,0)
 ; -- If user can attach a certain note, but note can also receive
"RTN","TIULP",62,0)
 ;    ID entries, don't let user attach it. --
"RTN","TIULP",63,0)
 I $$POSSPRNT^TIULP(TIUTYP) S TIUY="0^ This interdisciplinary PARENT title cannot be used for CHILD entries."
"RTN","TIULP",64,0)
 ; -- If selected type is a CWAD, don't let user attach it: --
"RTN","TIULP",65,0)
 I $$ISCWAD^TIULX(TIUTYP) S TIUY="0^ CWAD titles cannot be used for interdisciplinary entries."
"RTN","TIULP",66,0)
 ; -- If selected type is a consult, don't let user attach it: --
"RTN","TIULP",67,0)
 I $$ISA^TIULX(TIUTYP,+$$CLASS^TIUCNSLT) S TIUY="0^ Consult titles cannot be used for interdisciplinary entries."
"RTN","TIULP",68,0)
 Q TIUY
"RTN","TIULP",69,0)
 ;
"RTN","TIULP",70,0)
POSSPRNT(TIUTYP) ; Is a docmt intended as a possible ID parent?
"RTN","TIULP",71,0)
 ;Returns 1^WHYCAN'TATTACH if there are business rules permitting ANYONE
"RTN","TIULP",72,0)
 ;to attach ID entries to notes of type TIUTYP.
"RTN","TIULP",73,0)
 ;Else returns 0.
"RTN","TIULP",74,0)
 N TIUACT,STATUS,TIUY,DADTYP
"RTN","TIULP",75,0)
 S TIUY=0,TIUACT=+$$USREVNT("ATTACH ID ENTRY")
"RTN","TIULP",76,0)
 F STATUS=6,7,8 D  G:TIUY POSSX
"RTN","TIULP",77,0)
 . I $O(^USR(8930.1,"AR",TIUTYP,STATUS,TIUACT,0)) S TIUY=1 Q
"RTN","TIULP",78,0)
 . I $O(^USR(8930.1,"AC",TIUTYP,STATUS,TIUACT,0)) S TIUY=1
"RTN","TIULP",79,0)
 ; -- If no rules for TIUTYP, try its parent: --
"RTN","TIULP",80,0)
 S DADTYP=$O(^TIU(8925.1,"AD",TIUTYP,0)) G:DADTYP'>0 POSSX
"RTN","TIULP",81,0)
 S TIUY=$$POSSPRNT(DADTYP)
"RTN","TIULP",82,0)
POSSX I TIUY S TIUY="1^ Interdisciplinary PARENT notes cannot be attached as CHILD entries."
"RTN","TIULP",83,0)
 Q TIUY
"RTN","TIULP",84,0)
 ;
"RTN","TIULP",85,0)
CANENTR(TIUTYP) ; Evaluate privilege to enter a document of a particular type
"RTN","TIULP",86,0)
 N TIUACT,STATUS,USRROLE,TIUY
"RTN","TIULP",87,0)
 S TIUACT=$$USREVNT("ENTRY"),STATUS=2 ; untranscribed
"RTN","TIULP",88,0)
 S USRROLE=3 ; transcriber
"RTN","TIULP",89,0)
 S TIUY=$$CANDO^USRLA(TIUTYP,STATUS,+TIUACT,DUZ,USRROLE)
"RTN","TIULP",90,0)
 Q TIUY
"RTN","TIULP",91,0)
USRROLE(TIUDA,PERSON) ; Identify the user's role with respect to the document
"RTN","TIULP",92,0)
 ; 3/20/00 **100** Added role COMPLETER
"RTN","TIULP",93,0)
 ; 3/20/00 **100** Added PERSON param
"RTN","TIULP",94,0)
 N TIU0,TIU12,TIU13,TIUY,TIU15,COMPLTR,STATUS
"RTN","TIULP",95,0)
 S PERSON=$G(PERSON,DUZ)
"RTN","TIULP",96,0)
 S TIU0=$G(^TIU(8925,+TIUDA,0)),STATUS=$P(TIU0,U,5)
"RTN","TIULP",97,0)
 S TIU12=$G(^TIU(8925,+TIUDA,12))
"RTN","TIULP",98,0)
 S TIU13=$G(^TIU(8925,+TIUDA,13)),TIU15=$G(^TIU(8925,+TIUDA,15))
"RTN","TIULP",99,0)
 I PERSON=+$P(TIU13,U,2) S TIUY=+$O(^USR(8930.2,"B","TRANSCRIBER",0))_U
"RTN","TIULP",100,0)
 I PERSON=+$P(TIU12,U,2) S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","AUTHOR/DICTATOR",0))_U
"RTN","TIULP",101,0)
 I PERSON=+$P(TIU12,U,9) S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","ATTENDING PHYSICIAN",0))_U
"RTN","TIULP",102,0)
 I PERSON=+$P(TIU12,U,4) S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","EXPECTED SIGNER",0))_U
"RTN","TIULP",103,0)
 I PERSON=+$P(TIU12,U,8) S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","EXPECTED COSIGNER",0))_U
"RTN","TIULP",104,0)
 ;Check if the person can be an Interpreter for this document via a Consult API
"RTN","TIULP",105,0)
 I $$CPINTERP^GMRCCP(+TIUDA,PERSON) S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","INTERPRETER",0))_U
"RTN","TIULP",106,0)
 I STATUS>6 D  I COMPLTR S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","COMPLETER",0))_U
"RTN","TIULP",107,0)
 . S COMPLTR=0
"RTN","TIULP",108,0)
 . I PERSON=+$P(TIU15,U,8) S COMPLTR=1 Q
"RTN","TIULP",109,0)
 . I '$P(TIU15,U,8),PERSON=+$P(TIU15,U,2) S COMPLTR=1
"RTN","TIULP",110,0)
 I +$O(^TIU(8925.7,"AE",+TIUDA,+PERSON,0)) D
"RTN","TIULP",111,0)
 . N TIUXTRA S TIUXTRA=+$O(^TIU(8925.7,"AE",+TIUDA,+PERSON,0))
"RTN","TIULP",112,0)
 . I +$P($G(^TIU(8925.7,+TIUXTRA,0)),U,4) Q
"RTN","TIULP",113,0)
 . S TIUY=$G(TIUY)_+$O(^USR(8930.2,"B","ADDITIONAL SIGNER",0))_U
"RTN","TIULP",114,0)
 Q $G(TIUY)
"RTN","TIULP",115,0)
USREVNT(EVENT) ; Given event name, return:
"RTN","TIULP",116,0)
 ;EVENT = event pointer^user verb^verb modifier
"RTN","TIULP",117,0)
 ; **100** added verb modifier piece (.07)
"RTN","TIULP",118,0)
 N TIUY,TIUDA,NODE0
"RTN","TIULP",119,0)
 S TIUDA=+$O(^USR(8930.8,"B",EVENT,0))
"RTN","TIULP",120,0)
 S NODE0=$G(^USR(8930.8,TIUDA,0))
"RTN","TIULP",121,0)
 S TIUY=TIUDA_U_$P(NODE0,U,5)_U_$P(NODE0,U,7)
"RTN","TIULP",122,0)
 Q TIUY
"RTN","TIULP",123,0)
CANPICK(TIUTYP) ; Screens selection of title by title status and
"RTN","TIULP",124,0)
 ;(for status TEST), by owner.
"RTN","TIULP",125,0)
 N TIUPOWN,TIUCOWN,TIUT0,TIUTSTAT,TIUY S TIUY=0
"RTN","TIULP",126,0)
 S TIUT0=$G(^TIU(8925.1,+TIUTYP,0)),TIUTSTAT=$P(TIUT0,U,7)
"RTN","TIULP",127,0)
 I TIUTSTAT']"" S TIUY=0 G CANPIX
"RTN","TIULP",128,0)
 I TIUTSTAT=13 S TIUY=0 G CANPIX
"RTN","TIULP",129,0)
 I TIUTSTAT=11 S TIUY=1 G CANPIX
"RTN","TIULP",130,0)
 S TIUPOWN=$P(TIUT0,U,5),TIUCOWN=+$P(TIUT0,U,6)
"RTN","TIULP",131,0)
 I TIUTSTAT=10 S TIUY=$S(TIUPOWN=DUZ:1,+$$ISA^USRLM(DUZ,TIUCOWN):1,1:0)
"RTN","TIULP",132,0)
CANPIX Q +$G(TIUY)
"RTN","TIULP",133,0)
REQCOSIG(TIUTYP,TIUDA,USER,TIUDT) ; Evaluate whether user requires cosignature
"RTN","TIULP",134,0)
 N TIUI,TIUY,TIUDPRM S USER=$S(+$G(USER):+$G(USER),1:+$G(DUZ))
"RTN","TIULP",135,0)
 D DOCPRM^TIULC1(TIUTYP,.TIUDPRM,+$G(TIUDA))
"RTN","TIULP",136,0)
 I $G(TIUDPRM(5))="" G REQCOSX
"RTN","TIULP",137,0)
 I +$G(TIUDT)'>0 S TIUDT=+$P($P(+$G(^TIU(8925,+$G(TIUDA),13)),U),".")
"RTN","TIULP",138,0)
 F TIUI=1:1:$L(TIUDPRM(5),U) D  Q:+TIUY>0
"RTN","TIULP",139,0)
 . S TIUY=+$$ISA^USRLM(+USER,+$P(TIUDPRM(5),U,TIUI),,+$G(TIUDT))
"RTN","TIULP",140,0)
REQCOSX Q +$G(TIUY)
"RTN","TIULP",141,0)
 ;
"RTN","TIULP",142,0)
REQCPF(TIUCDA) ;Check if clinical procedure fields are required
"RTN","TIULP",143,0)
 ; Input  -- TIUCDA   Request/Consult File (#123) IEN
"RTN","TIULP",144,0)
 ; Output -- 1=Required and 0=Not Required
"RTN","TIULP",145,0)
 N TIUCPACT,REQF
"RTN","TIULP",146,0)
 I '$G(TIUCDA) G REQCPFQ
"RTN","TIULP",147,0)
 S TIUCPACT=$$CPACTM^GMRCCP(TIUCDA)
"RTN","TIULP",148,0)
 I TIUCPACT=1!(TIUCPACT=3) S REQF=1
"RTN","TIULP",149,0)
REQCPFQ Q +$G(REQF)
"RTN","TIUPNAPI")
0^4^B17381647
"RTN","TIUPNAPI",1,0)
TIUPNAPI ; SLC/JER - API to Replace GMRPAPI ; 3/17/04
"RTN","TIUPNAPI",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**57,140,175**;Jun 20, 1997
"RTN","TIUPNAPI",3,0)
NEW(TIUIFN,DFN,TIUAUTH,TIURDT,TIUTITLE,TIULOC,TIUES,TIUPRT,TIUESBY,TIUASKVS,TIUADEL) ;
"RTN","TIUPNAPI",4,0)
 ; -- Create new note
"RTN","TIUPNAPI",5,0)
 ; Return variable (must pass by reference):
"RTN","TIUPNAPI",6,0)
 ;      TIUIFN (pass by ref) = New note IFN in file 8925, -1 if error,
"RTN","TIUPNAPI",7,0)
 ;                           = IFN^0 if note filed, w/o signature when
"RTN","TIUPNAPI",8,0)
 ;                             TIUES=1
"RTN","TIUPNAPI",9,0)
 ; Required Input parameters:
"RTN","TIUPNAPI",10,0)
 ;      DFN                  = Patient IFN in file #2
"RTN","TIUPNAPI",11,0)
 ;      TIUAUTH              = Author IFN in file #200
"RTN","TIUPNAPI",12,0)
 ;      TIURDT               = Date/time of note in FM format
"RTN","TIUPNAPI",13,0)
 ;      TIUTITLE             = Title IFN in file 8925.1
"RTN","TIUPNAPI",14,0)
 ; Required global variable:
"RTN","TIUPNAPI",15,0)
 ;      ^TMP("TIUP",$J)      = Array root for text in format compatible
"RTN","TIUPNAPI",16,0)
 ;                             w/FM Word-processing fields. e.g.,
"RTN","TIUPNAPI",17,0)
 ;                             ^TMP("TIUP",$J,0)=^^1^1^2961216^
"RTN","TIUPNAPI",18,0)
 ;                             ^TMP("TIUP",$J,1,0)=Testing the TIUPNAPI.
"RTN","TIUPNAPI",19,0)
 ; 
"RTN","TIUPNAPI",20,0)
 ;                             NOTE: you no longer need to use the
"RTN","TIUPNAPI",21,0)
 ;                             additional subscript to designate where
"RTN","TIUPNAPI",22,0)
 ;                             the text should go (e.g., 10 for Admission
"RTN","TIUPNAPI",23,0)
 ;                             Note).
"RTN","TIUPNAPI",24,0)
 ; Optional Input variables:
"RTN","TIUPNAPI",25,0)
 ;      TIULOC              = Patient Location IFN in file #44
"RTN","TIUPNAPI",26,0)
 ;      TIUES               = 1 if TIU should prompt/process E-SIG
"RTN","TIUPNAPI",27,0)
 ;      TIUPRT              = 1 if TIU should prompt user to print note
"RTN","TIUPNAPI",28,0)
 ;      TIUESBY             = Signer IFN in file #200:  Calling App is
"RTN","TIUPNAPI",29,0)
 ;                            resonsible for Electronic Signature
"RTN","TIUPNAPI",30,0)
 ;      TIUASKVS            = BOOLEAN flag indicating whether to ask for visit
"RTN","TIUPNAPI",31,0)
 ;      NOTE: If TIUESBY is passed, the document will be marked as
"RTN","TIUPNAPI",32,0)
 ;            signed at the time the encrypted signature block name
"RTN","TIUPNAPI",33,0)
 ;            and title are filed...It is NOT necessary to pass a
"RTN","TIUPNAPI",34,0)
 ;            signature date/time, as GNEW^GMRPAPI permitted
"RTN","TIUPNAPI",35,0)
 ;      TIUADEL             = BOOLEAN flag for automatic delete if TIUESBY>0 and
"RTN","TIUPNAPI",36,0)
 ;                            signature fails instead of leaving UNSIGNED doc.
"RTN","TIUPNAPI",37,0)
 ;
"RTN","TIUPNAPI",38,0)
 N TIUX,TIUCHNG,TIUHIT,TIUPRM0,TIUPRM1,TIUTYP,TIUOUT,TIUDPRM,TIUVSTR
"RTN","TIUPNAPI",39,0)
 S TIUIFN=-1
"RTN","TIUPNAPI",40,0)
 I $D(^TMP("TIUP",$J))'>9 Q  ; If no text, quit
"RTN","TIUPNAPI",41,0)
 I '$D(^DPT(+$G(DFN),0)) G EXIT ; if not valid patient, clean-up & quit
"RTN","TIUPNAPI",42,0)
 I '$D(^VA(200,+$G(TIUAUTH),0)) G EXIT ; if not valid author, clean-up & quit
"RTN","TIUPNAPI",43,0)
 I '$D(^TIU(8925.1,+$G(TIUTITLE),0)) G EXIT ; if not valid title, clean-up & quit
"RTN","TIUPNAPI",44,0)
 I $S(+$G(TIURDT)'>0:1,+$G(TIURDT)>+$$NOW^XLFDT:1,+$$FMTH^XLFDT(TIURDT)'>0:1,1:0) G EXIT
"RTN","TIUPNAPI",45,0)
 I $S('$D(DUZ)#2:1,'$D(^VA(200,DUZ,0)):1,1:0) G EXIT
"RTN","TIUPNAPI",46,0)
 S TIUASKVS=+$G(TIUASKVS)
"RTN","TIUPNAPI",47,0)
 ; -- Okay, create new note
"RTN","TIUPNAPI",48,0)
 S TIUX(1202)=TIUAUTH,TIUX(1301)=TIURDT
"RTN","TIUPNAPI",49,0)
 ; get doc parameters
"RTN","TIUPNAPI",50,0)
 D DOCPRM^TIULC1(TIUTITLE,.TIUDPRM)
"RTN","TIUPNAPI",51,0)
 I +$$REQCOSIG^TIULP(TIUTITLE,"",TIUAUTH) D  G:+$G(TIUOUT) EXIT
"RTN","TIUPNAPI",52,0)
 . Q:$D(ZTQUEUED)  ; If called from a task, don't go interactive
"RTN","TIUPNAPI",53,0)
 . Q:$D(XWBOS)  ; If called from RPCBroker app, don't go interactive
"RTN","TIUPNAPI",54,0)
 . S TIUX(1506)=1
"RTN","TIUPNAPI",55,0)
 . S TIUX(1208)=$$GETCOSNR
"RTN","TIUPNAPI",56,0)
 . I TIUX(1208)'>0 S TIUOUT=1,TIUIFN=-1
"RTN","TIUPNAPI",57,0)
 I +TIUASKVS D  G:+$G(TIUOUT) EXIT
"RTN","TIUPNAPI",58,0)
 . N TIUBY,TIU,TIUY
"RTN","TIUPNAPI",59,0)
 . D ENPN^TIUVSIT(.TIU,DFN,1)
"RTN","TIUPNAPI",60,0)
 . I '$D(TIU) S TIUOUT=1,TIUIFN=-1 Q
"RTN","TIUPNAPI",61,0)
 . S TIUY=$$CHEKPN^TIULD(.TIU,.TIUBY)
"RTN","TIUPNAPI",62,0)
 . I '+TIUY S TIUOUT=1,TIUIFN=-1 Q
"RTN","TIUPNAPI",63,0)
 . I '$L($G(TIU("VSTR"))) S TIUOUT=1,TIUIFN=-1 Q
"RTN","TIUPNAPI",64,0)
 . S TIUVSTR=$G(TIU("VSTR")),TIULOC=+$G(TIU("LOC"))
"RTN","TIUPNAPI",65,0)
 . I +$G(TIU("STOP")),(+$P(TIUDPRM(0),U,14)'=1) S TIUX(.11)=1
"RTN","TIUPNAPI",66,0)
 M TIUX("TEXT")=^TMP("TIUP",$J)
"RTN","TIUPNAPI",67,0)
 D MAKE^TIUSRVP(.TIUIFN,DFN,TIUTITLE,TIURDT,$G(TIULOC),"",.TIUX,$G(TIUVSTR))
"RTN","TIUPNAPI",68,0)
 I +TIUIFN'>0 S TIUIFN=-1 G EXIT
"RTN","TIUPNAPI",69,0)
 I '+$G(TIUESBY),(+$G(TIUES)>0) D  Q:'$D(^TIU(8925,+TIUIFN,0))
"RTN","TIUPNAPI",70,0)
 . N VALMBCK
"RTN","TIUPNAPI",71,0)
 . D EXSTNOTE^TIUBR1(DFN,TIUIFN) Q:'$D(^TIU(8925,+TIUIFN,0))
"RTN","TIUPNAPI",72,0)
 . I +$P(^TIU(8925,+TIUIFN,0),U,5)<6 S TIUIFN=TIUIFN_"^-1"
"RTN","TIUPNAPI",73,0)
 I +$G(TIUESBY) D MARKSIGN(.TIUIFN,+$G(TIUESBY))
"RTN","TIUPNAPI",74,0)
 I +$G(TIUESBY),+$G(TIUADEL),+$P(^TIU(8925,+TIUIFN,0),U,5)<6 D DELETE^TIUSRVP("",+TIUIFN,"",1) S TIUIFN="-1^-1" G EXIT
"RTN","TIUPNAPI",75,0)
 D SEND^TIUALRT(+TIUIFN)
"RTN","TIUPNAPI",76,0)
EXIT K ^TMP("TIUP",$J)
"RTN","TIUPNAPI",77,0)
 Q
"RTN","TIUPNAPI",78,0)
WHATITLE(X) ; -- Given a freetext title, return pointer to file 8925.1
"RTN","TIUPNAPI",79,0)
 Q $$WHATITLE^TIUPUTU(X)
"RTN","TIUPNAPI",80,0)
GETCOSNR() ; Ask Expected Cosigner
"RTN","TIUPNAPI",81,0)
 N TIUY
"RTN","TIUPNAPI",82,0)
 S TIUY=$$READ^TIUU("P^200:AEMQ","EXPECTED COSIGNER")
"RTN","TIUPNAPI",83,0)
 Q +$G(TIUY)
"RTN","TIUPNAPI",84,0)
MARKSIGN(TIUDA,TIUESBY) ; Mark note as electronically signed
"RTN","TIUPNAPI",85,0)
 N ESNAME,ESTITLE,ESBLOCK
"RTN","TIUPNAPI",86,0)
 I $S(+$G(TIUESBY)'>0:1,'$D(^VA(200,+TIUESBY,0)):1,+$$CANDO^TIULP(TIUDA,"SIGNATURE",$G(TIUESBY))'>0:1,1:0) S TIUDA=TIUDA_U_-1 Q
"RTN","TIUPNAPI",87,0)
 S ESNAME=$P($G(^VA(200,TIUESBY,20)),U,2),ESTITLE=$P($G(^(20)),U,3)
"RTN","TIUPNAPI",88,0)
 S ESBLOCK="1^"_ESNAME_U_ESTITLE
"RTN","TIUPNAPI",89,0)
 D ES^TIURS(TIUDA,ESBLOCK)
"RTN","TIUPNAPI",90,0)
 I +$P(^TIU(8925,+TIUIFN,0),U,5)<6 S TIUDA=TIUDA_"^-1"
"RTN","TIUPNAPI",91,0)
 Q
"RTN","TIUPNAPI",92,0)
TEST ; Interactive Test
"RTN","TIUPNAPI",93,0)
 N DUOUT,DFN,TITLE,TIUTYP,TIURDT,TIUDA,DIC K ^TMP("TIUP",$J)
"RTN","TIUPNAPI",94,0)
 W !,"First, collect the data to pass to the API...",!
"RTN","TIUPNAPI",95,0)
 S DFN=+$$PATIENT^TIULA Q:+DFN'>0
"RTN","TIUPNAPI",96,0)
 D DOCSPICK^TIULA2(.TIUTYP,3,"1A","","","+$$CANPICK^TIULP(+Y),+$$CANENTR^TIULP(+Y)")
"RTN","TIUPNAPI",97,0)
 S TITLE=$P($G(TIUTYP(1)),U,2) Q:+TITLE'>0
"RTN","TIUPNAPI",98,0)
 S TIURDT=+$$NOW^XLFDT
"RTN","TIUPNAPI",99,0)
 S DIC="^TMP(""TIUP"",$J," D EN^DIWE
"RTN","TIUPNAPI",100,0)
 W !,"NOW, call the API!",!
"RTN","TIUPNAPI",101,0)
 D NEW(.TIUDA,DFN,DUZ,TIURDT,TITLE,"",1,1,"",1)
"RTN","TIUPNAPI",102,0)
 Q
"RTN","TIUSRVA")
0^5^B21607396
"RTN","TIUSRVA",1,0)
TIUSRVA ; SLC/JER,AJB - API's for Authorization ; 03/18/04
"RTN","TIUSRVA",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**19,28,47,80,100,116,152,160,178,175**;Jun 20, 1997
"RTN","TIUSRVA",3,0)
 ;
"RTN","TIUSRVA",4,0)
 ;External reference to File ^AUPNVSIT supported by DBIA 3580
"RTN","TIUSRVA",5,0)
REQCOS(TIUY,TIUTYP,TIUDA,TIUSER,TIUDT) ; Evaluate cosignature requirement
"RTN","TIUSRVA",6,0)
 ; Initialize return value
"RTN","TIUSRVA",7,0)
 N TIUDPRM
"RTN","TIUSRVA",8,0)
 S TIUY=0
"RTN","TIUSRVA",9,0)
 I +$G(TIUTYP)'>0,'+$G(TIUDA) Q
"RTN","TIUSRVA",10,0)
 I +$G(TIUDA) S TIUTYP=+$G(^TIU(8925,+$G(TIUDA),0))
"RTN","TIUSRVA",11,0)
 S:'+$G(TIUSER) TIUSER=+$G(DUZ)
"RTN","TIUSRVA",12,0)
 S TIUY=+$$REQCOSIG^TIULP(TIUTYP,+$G(TIUDA),+$G(TIUSER),+$G(TIUDT))
"RTN","TIUSRVA",13,0)
 Q
"RTN","TIUSRVA",14,0)
URGENCY(Y) ; -- retrieve set values from dd for discharge summary urgency
"RTN","TIUSRVA",15,0)
 N TIUDD,I,X
"RTN","TIUSRVA",16,0)
 D FIELD^DID(8925,.09,"","POINTER","TIUDD")
"RTN","TIUSRVA",17,0)
 F I=1:1 S X=$P(TIUDD("POINTER"),";",I) Q:X=""   S Y(I)=$TR(X,":","^")
"RTN","TIUSRVA",18,0)
 Q
"RTN","TIUSRVA",19,0)
CANDO(Y,TIUDA,TIUACT) ; Boolean function to evaluate privilege
"RTN","TIUSRVA",20,0)
 N TIUPOP,TIUDPRM S TIUPOP=0
"RTN","TIUSRVA",21,0)
 ; **152** code added to prevent editing a completed document.
"RTN","TIUSRVA",22,0)
 I $P($G(^TIU(8925,TIUDA,0)),U,5)>6,(TIUACT="EDIT RECORD") S Y="0^ You may not edit a completed document" Q
"RTN","TIUSRVA",23,0)
 I $S(TIUACT["SIGN":1,TIUACT="EDIT RECORD":1,TIUACT="DELETE RECORD":1,1:0) D  Q:+TIUPOP=1
"RTN","TIUSRVA",24,0)
 . L +^TIU(8925,+TIUDA):1
"RTN","TIUSRVA",25,0)
 . E  S Y="0^ Another session is editing this entry.",TIUPOP=1
"RTN","TIUSRVA",26,0)
 . L -^TIU(8925,+TIUDA)
"RTN","TIUSRVA",27,0)
 I TIUACT["SIGN",+$$NEEDCS(TIUDA) S Y="0^ You must name a cosigner before signing this document." Q
"RTN","TIUSRVA",28,0)
 S Y=$$CANDO^TIULP(TIUDA,TIUACT)
"RTN","TIUSRVA",29,0)
 Q
"RTN","TIUSRVA",30,0)
NEEDCS(TIUDA) ; Does user need a cosigner?
"RTN","TIUSRVA",31,0)
 N TIUD0,TIUD12,TIUY,SIGNER,COSIGNER,XTRASGNR
"RTN","TIUSRVA",32,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUD12=$G(^(12))
"RTN","TIUSRVA",33,0)
 S SIGNER=$P(TIUD12,U,4),COSIGNER=$P(TIUD12,U,8),XTRASGNR=0
"RTN","TIUSRVA",34,0)
 I (DUZ'=SIGNER),(DUZ'=COSIGNER) S XTRASGNR=+$O(^TIU(8925.7,"AE",+TIUDA,+DUZ,0))
"RTN","TIUSRVA",35,0)
 I +XTRASGNR S TIUY=0
"RTN","TIUSRVA",36,0)
 E  I +$$REQCOSIG^TIULP(+TIUD0,TIUDA,DUZ),(+$P(TIUD12,U,8)'>0) S TIUY=1
"RTN","TIUSRVA",37,0)
 Q +$G(TIUY)
"RTN","TIUSRVA",38,0)
USRINACT(TIUY,TIUDA) ; Is user inactive?
"RTN","TIUSRVA",39,0)
 S TIUY=+$$GET1^DIQ(200,TIUDA_",",7,"I")
"RTN","TIUSRVA",40,0)
 Q
"RTN","TIUSRVA",41,0)
AUTHSIGN(TIUY,TIUDA,TIUUSR) ; Has Author signed?
"RTN","TIUSRVA",42,0)
 ; if TIUY = 
"RTN","TIUSRVA",43,0)
 ; 0 = Author has NOT signed & TIUUSR = Expected Cosigner
"RTN","TIUSRVA",44,0)
 ; 1 = Author HAS signed or TIUUSR '= Expected Cosigner
"RTN","TIUSRVA",45,0)
 ;
"RTN","TIUSRVA",46,0)
 N TIUD12,TIUD15
"RTN","TIUSRVA",47,0)
 S TIUD12=$G(^TIU(8925,TIUDA,12)),TIUD15=$G(^(15))
"RTN","TIUSRVA",48,0)
 S TIUY=1
"RTN","TIUSRVA",49,0)
 D:$P(TIUD12,U,8)=TIUUSR  Q
"RTN","TIUSRVA",50,0)
 . S:$P(TIUD12,U,2)'=$P(TIUD15,U,2) TIUY=0
"RTN","TIUSRVA",51,0)
 Q
"RTN","TIUSRVA",52,0)
TIUVISIT(TIUY,DOCTYP,DFN,VISIT) ;  Check for a 1 time only doc
"RTN","TIUSRVA",53,0)
 ;  TIUY    =    return value
"RTN","TIUSRVA",54,0)
 ;          = 0 if can add more than one or none already exist
"RTN","TIUSRVA",55,0)
 ;          = 1 if cannot add more than one and one already exists
"RTN","TIUSRVA",56,0)
 ;  DOCTYP  =    Pointer to ^TUI(8925.1,   TIU DOCUMENT DEFINITION
"RTN","TIUSRVA",57,0)
 ;  DFN     =    Patient IEN
"RTN","TIUSRVA",58,0)
 ;  VISIT   =    Visit String "LOC;VDATE;VTYP"
"RTN","TIUSRVA",59,0)
 I $$PATCH^XPDUTL("OR*3.0*195") D
"RTN","TIUSRVA",60,0)
 . Q:($G(DOCTYP)="")!($G(DFN)="")!($G(VISIT)="")
"RTN","TIUSRVA",61,0)
 . N TIUDPRM,TIUTEST
"RTN","TIUSRVA",62,0)
 . D DOCPRM^TIULC1(DOCTYP,.TIUDPRM)
"RTN","TIUSRVA",63,0)
 . S TIUY=$S($P(TIUDPRM(0),U,10)="":1,1:$P(TIUDPRM(0),U,10))
"RTN","TIUSRVA",64,0)
 . I TIUY=1 S TIUY=0 Q
"RTN","TIUSRVA",65,0)
 . I $L(VISIT,";")=3 D
"RTN","TIUSRVA",66,0)
 . . S TIUTEST=$$EXIST^TIUEDI3(DFN,DOCTYP,VISIT)
"RTN","TIUSRVA",67,0)
 . . I TIUTEST S TIUY=1
"RTN","TIUSRVA",68,0)
 . . I 'TIUTEST S TIUY=0
"RTN","TIUSRVA",69,0)
 I '$$PATCH^XPDUTL("OR*3.0*195") D
"RTN","TIUSRVA",70,0)
 . Q:($G(DOCTYP)="")!($G(DFN)="")!($G(VISIT)="")
"RTN","TIUSRVA",71,0)
 . N X3
"RTN","TIUSRVA",72,0)
 . S X3=+$O(^TIU(8925.95,"B",DOCTYP,""))
"RTN","TIUSRVA",73,0)
 . S TIUY=$P($G(^TIU(8925.95,X3,0)),U,10) S TIUY=$S(TIUY=0:1,1:0)
"RTN","TIUSRVA",74,0)
 . Q:'TIUY
"RTN","TIUSRVA",75,0)
 . S VISIT=((9999999-$P(VISIT,"."))_"."_$P(VISIT,".",2))
"RTN","TIUSRVA",76,0)
 . S VISIT=+$O(^AUPNVSIT("AA",DFN,VISIT,""))
"RTN","TIUSRVA",77,0)
 . S TIUY=$S($D(^TIU(8925,"AV",DFN,DOCTYP,VISIT)):0,1:1)
"RTN","TIUSRVA",78,0)
 . S TIUY=$S(TIUY=0:1,1:0)
"RTN","TIUSRVA",79,0)
 Q
"RTN","TIUSRVA",80,0)
WHATACT(Y,TIUDA) ; Evaluate/return whether signature or cosignature
"RTN","TIUSRVA",81,0)
 N TIUD0,TIUD12,TIUSTAT,SIGNER,COSIGNER,XTRASGNR
"RTN","TIUSRVA",82,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD12=$G(^TIU(8925,+TIUDA,12))
"RTN","TIUSRVA",83,0)
 S SIGNER=$P(TIUD12,U,4),COSIGNER=$P(TIUD12,U,8)
"RTN","TIUSRVA",84,0)
 I (DUZ'=SIGNER),(DUZ'=COSIGNER) S XTRASGNR=+$O(^TIU(8925.7,"AE",+TIUDA,+DUZ,0))
"RTN","TIUSRVA",85,0)
 S TIUSTAT=+$P(TIUD0,U,5)
"RTN","TIUSRVA",86,0)
 S Y=$S(TIUSTAT'>5:"SIGNATURE",+$G(XTRASGNR):"SIGNATURE",1:"COSIGNATURE")
"RTN","TIUSRVA",87,0)
 Q
"RTN","TIUSRVA",88,0)
CANCHCOS(Y,TIUDA) ; Evaluate/return whether user can change cosigner
"RTN","TIUSRVA",89,0)
 S Y=$$MAYCHNG^TIURA1(TIUDA)
"RTN","TIUSRVA",90,0)
 Q
"RTN","TIUSRVA",91,0)
NEEDJUST(Y,TIUDA) ; Is justification required for deletion?
"RTN","TIUSRVA",92,0)
 N TIUD0 S TIUD0=$G(^TIU(8925,+TIUDA,0)),Y=0
"RTN","TIUSRVA",93,0)
 I +$P(TIUD0,U,5)'<6 S Y=1
"RTN","TIUSRVA",94,0)
 Q
"RTN","TIUSRVA",95,0)
GETTITLE(Y,TIUDA) ; Get the title from a TIU Document Record
"RTN","TIUSRVA",96,0)
 S Y=+$G(^TIU(8925,+TIUDA,0))
"RTN","TIUSRVA",97,0)
 Q
"RTN","TIUSRVA",98,0)
CANATTCH(Y,TIUDA) ; Can this document be attached as an ID Child
"RTN","TIUSRVA",99,0)
 N TITLEDA,PARENTDA
"RTN","TIUSRVA",100,0)
 S TITLEDA=+$G(^TIU(8925,TIUDA,0))
"RTN","TIUSRVA",101,0)
 I TITLEDA'>0 S Y="0^Document #"_TIUDA_" does not exist." Q
"RTN","TIUSRVA",102,0)
 S PARENTDA=+$G(^TIU(8925,TIUDA,21))
"RTN","TIUSRVA",103,0)
 S Y=$$POSSPRNT^TIULP(TITLEDA)
"RTN","TIUSRVA",104,0)
 I +Y S Y="-1"_U_$P(Y,U,2) Q
"RTN","TIUSRVA",105,0)
 I +$$ISCWAD^TIULX(TITLEDA) D  Q
"RTN","TIUSRVA",106,0)
 . S Y="0^ CWAD Documents may not be Attached as Interdisciplinary Entries."
"RTN","TIUSRVA",107,0)
 I +$$ISA^TIULX(TITLEDA,+$$CLASS^TIUCNSLT) D  Q
"RTN","TIUSRVA",108,0)
 . S Y="0^ Consult Results may not be Attached as Interdisciplinary Entries."
"RTN","TIUSRVA",109,0)
 S Y=$$CANDO^TIULP(TIUDA,"ATTACH TO ID NOTE")
"RTN","TIUSRVA",110,0)
 I PARENTDA D  ; action must be "detach"
"RTN","TIUSRVA",111,0)
 . I 'Y S Y="0^ You may not detach this note from an interdisciplinary note." Q
"RTN","TIUSRVA",112,0)
 . S Y=$$CANDO^TIULP(PARENTDA,"ATTACH ID ENTRY")
"RTN","TIUSRVA",113,0)
 . I 'Y S Y="0^ You may not detach this note from its interdisciplinary note."
"RTN","TIUSRVA",114,0)
 Q
"RTN","TIUSRVA",115,0)
CANRCV(Y,TIUDA) ; Can this document receive an ID Child?
"RTN","TIUSRVA",116,0)
 S Y=$$CANDO^TIULP(TIUDA,"ATTACH ID ENTRY")
"RTN","TIUSRVA",117,0)
 Q
"RTN","TIUSRVP")
0^6^B72721912
"RTN","TIUSRVP",1,0)
TIUSRVP ; SLC/JER - RPCs for CREATE & UPDATE ;11/01/03
"RTN","TIUSRVP",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**1,7,19,28,47,89,104,100,115,109,167,113,112,175**;Jun 20, 1997
"RTN","TIUSRVP",3,0)
MAKE(SUCCESS,DFN,TITLE,VDT,VLOC,VSIT,TIUX,VSTR,SUPPRESS,NOASF) ; New Document
"RTN","TIUSRVP",4,0)
 ; SUCCESS = (by ref) TIU DOCUMENT # (PTR to 8925)
"RTN","TIUSRVP",5,0)
 ;         = 0^Explanatory message if no SUCCESS
"RTN","TIUSRVP",6,0)
 ; DFN     = Patient (#2)
"RTN","TIUSRVP",7,0)
 ; TITLE   = TIU Document Definition (#8925.1)
"RTN","TIUSRVP",8,0)
 ; [VDT]   = Date(/Time) of Visit
"RTN","TIUSRVP",9,0)
 ; [VLOC]  = Visit Location (HOSPITAL LOCATION)
"RTN","TIUSRVP",10,0)
 ; [VSIT]  = Visit file ien (#9000010)
"RTN","TIUSRVP",11,0)
 ; [VSTR]  = Visit string (i.e., VLOC;VDT;VTYPE)
"RTN","TIUSRVP",12,0)
 ; [NOASF] = if 1=Do Not Set ASAVE cross-reference
"RTN","TIUSRVP",13,0)
 ; TIUX    = (by ref) array containing field data and document body
"RTN","TIUSRVP",14,0)
 ;
"RTN","TIUSRVP",15,0)
 N TIU,TIUDA,LDT,NEWREC
"RTN","TIUSRVP",16,0)
 S SUCCESS=0
"RTN","TIUSRVP",17,0)
 I +$G(VSIT) S VSTR=$$VSTRBLD(+VSIT)
"RTN","TIUSRVP",18,0)
 I $L($G(VSTR)) D
"RTN","TIUSRVP",19,0)
 . S VDT=$S(+$G(VDT):+$G(VDT),1:$P(VSTR,";",2))
"RTN","TIUSRVP",20,0)
 . S LDT=$S(+$G(VDT):$$FMADD^XLFDT(VDT,"","",1),1:"")
"RTN","TIUSRVP",21,0)
 . S VLOC=$S(+$G(VLOC):+$G(VLOC),1:$P(VSTR,";"))
"RTN","TIUSRVP",22,0)
 . ; If note is for Ward Location, call MAIN^TIUMOVE
"RTN","TIUSRVP",23,0)
 . I $P($G(^SC(+VLOC,0)),U,3)="W" D MAIN^TIUMOVE(.TIU,DFN,"",VDT,LDT,1,"LAST",0,+VLOC) Q
"RTN","TIUSRVP",24,0)
 . ; Otherwise, call PATVADPT^TIULV
"RTN","TIUSRVP",25,0)
 . D PATVADPT^TIULV(.TIU,DFN,"",VSTR)
"RTN","TIUSRVP",26,0)
 I '+$G(VSIT),'$L($G(VSTR)),+$G(VDT),+$G(VLOC) D
"RTN","TIUSRVP",27,0)
 . S VDT=$G(VDT),LDT=$S(+$G(VDT):$$FMADD^XLFDT(VDT,"","",1),1:"")
"RTN","TIUSRVP",28,0)
 . ; If note is for Ward Location, call MAIN^TIUMOVE
"RTN","TIUSRVP",29,0)
 . I $P($G(^SC(+VLOC,0)),U,3)="W" D MAIN^TIUMOVE(.TIU,DFN,"",VDT,LDT,1,"LAST",0,+VLOC) Q
"RTN","TIUSRVP",30,0)
 . ; Otherwise, call MAIN^TIUVSIT
"RTN","TIUSRVP",31,0)
 . D MAIN^TIUVSIT(.TIU,DFN,"",VDT,LDT,"LAST",0,VLOC)
"RTN","TIUSRVP",32,0)
 I '+$G(TIU("VSTR")) D
"RTN","TIUSRVP",33,0)
 . D EVENT^TIUSRVP1(.TIU,DFN)
"RTN","TIUSRVP",34,0)
 S TIU("INST")=$$DIVISION^TIULC1(+TIU("LOC"))
"RTN","TIUSRVP",35,0)
 I $S($D(TIU)'>9:1,+$G(DFN)'>0:1,1:0) S SUCCESS="0^"_$$EZBLD^DIALOG(89250001) Q
"RTN","TIUSRVP",36,0)
 ;
"RTN","TIUSRVP",37,0)
 S TIUDA=$$GETREC(DFN,.TIU,TITLE,.NEWREC)
"RTN","TIUSRVP",38,0)
 I +TIUDA'>0 S SUCCESS="0^"_$$EZBLD^DIALOG(89250002) Q
"RTN","TIUSRVP",39,0)
 S SUCCESS=+TIUDA
"RTN","TIUSRVP",40,0)
 ;
"RTN","TIUSRVP",41,0)
 D STUFREC^TIUSRVP1(+TIUDA,.TIUX,DFN,,TITLE,.TIU)
"RTN","TIUSRVP",42,0)
 S:'+$G(NOASF) ^TIU(8925,"ASAVE",DUZ,TIUDA)=""
"RTN","TIUSRVP",43,0)
 K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",44,0)
 M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUSRVP",45,0)
 D SETXT0(TIUDA)
"RTN","TIUSRVP",46,0)
 D FILE(.SUCCESS,+TIUDA,.TIUX,+$G(SUPPRESS))
"RTN","TIUSRVP",47,0)
 I +SUCCESS'>0 D DIK^TIURB2(TIUDA) Q
"RTN","TIUSRVP",48,0)
 I +$O(^TIU(8925,+TIUDA,"TEMP",0)) D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVP",49,0)
 I +$G(TIU("STOP")) D DEFER^TIUVSIT(TIUDA,TIU("STOP")) I 1
"RTN","TIUSRVP",50,0)
 E  D QUE^TIUPXAP1
"RTN","TIUSRVP",51,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",52,0)
 . D RELEASE^TIUT(TIUDA,1)
"RTN","TIUSRVP",53,0)
 . D UPDTIRT^TIUDIRT(.TIU,TIUDA)
"RTN","TIUSRVP",54,0)
 K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",55,0)
 Q
"RTN","TIUSRVP",56,0)
VSTRBLD(VSIT) ; Given Visit ien, build Visit-Descriptor String
"RTN","TIUSRVP",57,0)
 N TIUY,VSIT0,VLOC,VDT,VSVCAT
"RTN","TIUSRVP",58,0)
 S VSIT0=$G(^AUPNVSIT(+VSIT,0)),VDT=+$P(VSIT0,U),VLOC=+$P(VSIT0,U,22)
"RTN","TIUSRVP",59,0)
 S VSVCAT=$P(VSIT0,U,7)
"RTN","TIUSRVP",60,0)
 S TIUY=VLOC_";"_VDT_";"_VSVCAT
"RTN","TIUSRVP",61,0)
 Q TIUY
"RTN","TIUSRVP",62,0)
SETXT0(TIUDA) ; Set root node of "TEMP" WP-field
"RTN","TIUSRVP",63,0)
 N TIUC,TIUI S (TIUC,TIUI)=0
"RTN","TIUSRVP",64,0)
 F  S TIUI=$O(^TIU(8925,TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVP",65,0)
 . S:$D(^TIU(8925,TIUDA,"TEMP",TIUI,0)) TIUC=TIUC+1
"RTN","TIUSRVP",66,0)
 S ^TIU(8925,TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVP",67,0)
 Q
"RTN","TIUSRVP",68,0)
MAKEADD(TIUDADD,TIUDA,TIUX,SUPPRESS) ; Create addendum
"RTN","TIUSRVP",69,0)
 N DIE,DR,DA,DIC,X,Y,DLAYGO,TIUATYP,TIUCAN,TIUFPRIV,TIU S TIUFPRIV=1
"RTN","TIUSRVP",70,0)
 S TIUCAN=$$CANDO^TIULP(TIUDA,"MAKE ADDENDUM")
"RTN","TIUSRVP",71,0)
 I TIUCAN'>0 S TIUDADD="0^You may not MAKE AN ADDENDUM for this "_$$STATUS^TIULC(TIUDA)_" "_$$PNAME^TIULC1(+$G(^TIU(8925,+TIUDA,0))) Q
"RTN","TIUSRVP",72,0)
 S TIUATYP=+$$WHATITLE^TIUPUTU("ADDENDUM")
"RTN","TIUSRVP",73,0)
 S (DIC,DLAYGO)=8925,DIC(0)="L",X=""""_"`"_TIUATYP_""""
"RTN","TIUSRVP",74,0)
 D ^DIC
"RTN","TIUSRVP",75,0)
 S TIUDADD=+Y
"RTN","TIUSRVP",76,0)
 I +Y'>0 S TIUDADD=TIUDADD_"^Could not create addendum." Q
"RTN","TIUSRVP",77,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUSRVP",78,0)
 S TIU("DOCTYP")=TIUATYP_U_$$PNAME^TIULC1(TIUATYP)
"RTN","TIUSRVP",79,0)
 D STUFREC^TIUSRVP1(+TIUDADD,.TIUX,DFN,+$G(TIUDA),TIUATYP,.TIU)
"RTN","TIUSRVP",80,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUSRVP",81,0)
 M ^TIU(8925,+TIUDADD,"TEMP")=TIUX("TEXT") K TIUX("TEXT")
"RTN","TIUSRVP",82,0)
 D SETXT0(+TIUDADD)
"RTN","TIUSRVP",83,0)
 D FILE(.SUCCESS,+TIUDADD,.TIUX,+$G(SUPPRESS))
"RTN","TIUSRVP",84,0)
 I +SUCCESS'>0 D DIK^TIURB2(TIUDADD) Q
"RTN","TIUSRVP",85,0)
 I +$O(^TIU(8925,+TIUDADD,"TEMP",0)) D MERGTEXT^TIUEDI1(+TIUDADD,.TIU)
"RTN","TIUSRVP",86,0)
 I '+$G(SUPPRESS) D RELEASE^TIUT(+TIUDADD,1)
"RTN","TIUSRVP",87,0)
 K ^TIU(8925,+TIUDADD,"TEMP")
"RTN","TIUSRVP",88,0)
 Q
"RTN","TIUSRVP",89,0)
UPDATE(SUCCESS,TIUDA,TIUX,SUPPRESS) ; Update existing Document
"RTN","TIUSRVP",90,0)
 N TIU,TIUI,TIUC,TIUD0,TIUD12,TIUD15,TIUCPF,TITLE
"RTN","TIUSRVP",91,0)
 I $S(+$G(TIUDA)'>0:1,'$D(^TIU(8925,+TIUDA,0)):1,1:0) D  Q
"RTN","TIUSRVP",92,0)
 . S SUCCESS="0^ Cannot update a non-existent document..."
"RTN","TIUSRVP",93,0)
 I +$P($G(^TIU(8925,+TIUDA,0)),U,5)>6 D  Q
"RTN","TIUSRVP",94,0)
 . S SUCCESS="0^ TIU Document #"_TIUDA_" is already signed..."
"RTN","TIUSRVP",95,0)
 I $D(TIUX("TEXT")) D
"RTN","TIUSRVP",96,0)
 . K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",97,0)
 . M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT")
"RTN","TIUSRVP",98,0)
 . S (TIUC,TIUI)=0
"RTN","TIUSRVP",99,0)
 . F  S TIUI=$O(^TIU(8925,+TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVP",100,0)
 . . S TIUC=TIUC+1
"RTN","TIUSRVP",101,0)
 . I +TIUC>0 S ^TIU(8925,+TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVP",102,0)
 . K TIUX("TEXT")
"RTN","TIUSRVP",103,0)
 I +$O(TIUX(""))'>0 S:+$G(SUPPRESS) SUCCESS=+TIUDA Q
"RTN","TIUSRVP",104,0)
 S TIUD0=$G(^TIU(8925,TIUDA,0)),TIUD12=$G(^(12)),TITLE=+TIUD0
"RTN","TIUSRVP",105,0)
 ;Set a flag to indicate whether or not a Title is a member of the
"RTN","TIUSRVP",106,0)
 ;Clinical Procedures Class (1=Yes and 0=No)
"RTN","TIUSRVP",107,0)
 S TIUCPF=+$$ISA^TIULX(TITLE,+$$CLASS^TIUCP)
"RTN","TIUSRVP",108,0)
 D SETCOS(TIUDA,.TIUX,TIUD0,TIUD12)
"RTN","TIUSRVP",109,0)
 ; Title changed? Refile DC
"RTN","TIUSRVP",110,0)
 I +$G(TIUX(.01))>0,(+$G(TIUX(.01))'=+TIUD0) D
"RTN","TIUSRVP",111,0)
 . S TIUX(.04)=$$DOCCLASS^TIULC1(+$G(TIUX(.01)))
"RTN","TIUSRVP",112,0)
 D FILE(.SUCCESS,+TIUDA,.TIUX,+$G(SUPPRESS),TIUCPF)
"RTN","TIUSRVP",113,0)
 I +SUCCESS'>0 K ^TIU(8925,+TIUDA,"TEMP") Q
"RTN","TIUSRVP",114,0)
 D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUSRVP",115,0)
 I $D(^TIU(8925,+TIUDA,"TEMP")) D
"RTN","TIUSRVP",116,0)
 . K ^TIU(8925,+TIUDA,"TEXT")
"RTN","TIUSRVP",117,0)
 . D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVP",118,0)
 . K ^TIU(8925,+TIUDA,"TEMP")
"RTN","TIUSRVP",119,0)
 . S:'+$G(SUCCESS) SUCCESS=+TIUDA
"RTN","TIUSRVP",120,0)
 ; If signed, re-file /ES/
"RTN","TIUSRVP",121,0)
 S TIUD15=$G(^TIU(8925,+TIUDA,15))
"RTN","TIUSRVP",122,0)
 I +TIUD15 D
"RTN","TIUSRVP",123,0)
 . N TIUBY,DR,DIE,DA,X,Y S TIUBY=$P(TIUD15,U,2) Q:+TIUBY'>0
"RTN","TIUSRVP",124,0)
 . S DR="1503///^S X=$$SIGNAME^TIULS("_TIUBY_");1504///^S X=$$SIGTITL^TIULS("_TIUBY_")"
"RTN","TIUSRVP",125,0)
 . S DA=TIUDA,DIE=8925 D ^DIE
"RTN","TIUSRVP",126,0)
 ; send alerts
"RTN","TIUSRVP",127,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",128,0)
 . I +$P(TIUD0,U,5)<5,'$D(TIUX(.05)) D UPDSTAT(TIUDA,+$G(TIUD0))
"RTN","TIUSRVP",129,0)
 . D SEND^TIUALRT(TIUDA),SENDID^TIUALRT1(TIUDA):+$G(^TIU(8925,+TIUDA,21))
"RTN","TIUSRVP",130,0)
 . D UPDTIRT^TIUDIRT(.TIU,TIUDA)
"RTN","TIUSRVP",131,0)
 Q
"RTN","TIUSRVP",132,0)
SETCOS(TIUDA,TIUX,TIUD0,TIUD12) ; set cosig req
"RTN","TIUSRVP",133,0)
 N TIUDAD,TIUEXS,TIUNCS,TIUEXCS,TIURCS,TIUATT,TIUTTL,TIUDAD0
"RTN","TIUSRVP",134,0)
 S TIUEXS=$S(+$G(TIUX(1202)):+$G(TIUX(1202)),1:$P(TIUD12,U,4))
"RTN","TIUSRVP",135,0)
 S TIUNCS=$S(+$G(TIUX(1208)):+$G(TIUX(1208)),+$G(TIUX(1209)):+$G(TIUX(1209)),1:0)
"RTN","TIUSRVP",136,0)
 I TIUNCS S TIUX(1506)=$S(TIUNCS=TIUEXS:0,1:1) G SETCOSX
"RTN","TIUSRVP",137,0)
 S TIUEXCS=$P(TIUD12,U,8),TIUATT=$P(TIUD12,U,9)
"RTN","TIUSRVP",138,0)
 S TIUDAD=+$P(TIUD0,U,6),TIUDAD0=$G(^TIU(8925,+TIUDAD,0))
"RTN","TIUSRVP",139,0)
 I +$$ISDS^TIULX($S(+TIUDAD:+TIUDAD0,1:+TIUD0)) D  G SETCOSX
"RTN","TIUSRVP",140,0)
 . S TIUX(1506)=$S(TIUEXS=TIUEXCS:0,1:1)
"RTN","TIUSRVP",141,0)
 S TIUTTL=$S(+$G(TIUX(.01)):+$G(TIUX(.01)),1:+TIUD0)
"RTN","TIUSRVP",142,0)
 S TIUX(1506)=+$$REQCOSIG^TIULP(TIUTTL,TIUDA,TIUEXS)
"RTN","TIUSRVP",143,0)
SETCOSX S:'TIUX(1506) TIUX(1208)="@"
"RTN","TIUSRVP",144,0)
 Q
"RTN","TIUSRVP",145,0)
UPDSTAT(DA,TITLE) ; Update status on commit
"RTN","TIUSRVP",146,0)
 N DR,DIE S DR=".05////"_$$STATUS^TIUSRVP1(DA,0,TITLE)
"RTN","TIUSRVP",147,0)
 I '+$P($G(^TIU(8925,DA,13)),U,4) S DR=DR_";1304////^S X=$$NOW^XLFDT"
"RTN","TIUSRVP",148,0)
 S DIE=8925
"RTN","TIUSRVP",149,0)
 D ^DIE
"RTN","TIUSRVP",150,0)
 Q
"RTN","TIUSRVP",151,0)
GETREC(DFN,TIU,TITLE,TIUNEW) ; Get/create document record
"RTN","TIUSRVP",152,0)
 N DA,DIC,DIE,DLAYGO,DR,X,Y,TIUDPRM,TIUFPRIV,TIUHIT,TIUSCAT
"RTN","TIUSRVP",153,0)
 S (TIUHIT,DA)=0,TIUFPRIV=1
"RTN","TIUSRVP",154,0)
 S (DIC,DLAYGO)=8925,DIC(0)="FL"
"RTN","TIUSRVP",155,0)
 S X=""""_"`"_+TITLE_"""" D ^DIC K DIC("S")
"RTN","TIUSRVP",156,0)
 I +Y'>0 Q Y_U_" Insufficient data to create a new record."
"RTN","TIUSRVP",157,0)
 S DA=+Y,TIUNEW=+$P(Y,U,3)
"RTN","TIUSRVP",158,0)
 N DIE,DR,TIUVISIT S DIE=8925
"RTN","TIUSRVP",159,0)
 S TIUVISIT=$S(+$G(TIU("VISIT")):+$G(TIU("VISIT")),1:"")
"RTN","TIUSRVP",160,0)
 S TIUSCAT=$S(+$L($P($G(TIU("CAT")),U)):$P($G(TIU("CAT")),U),+$L($P($G(TIU("VSTR")),";",3)):$P($G(TIU("VSTR")),";",3),1:"")
"RTN","TIUSRVP",161,0)
 S DR=".04////"_$$DOCCLASS^TIULC1(+$P(Y,U,2))_";.13////"_TIUSCAT_";1205////"_$P($G(TIU("LOC")),U)_";1211////"_$P($G(TIU("VLOC")),U)_";1212////"_$P($G(TIU("INST")),U)
"RTN","TIUSRVP",162,0)
 D ^DIE
"RTN","TIUSRVP",163,0)
 Q +$G(DA)
"RTN","TIUSRVP",164,0)
FILE(SUCCESS,TIUDA,TIUX,SUPPRESS,TIUCPF) ; Call FM Filer & commit
"RTN","TIUSRVP",165,0)
 N FDA,FDARR,IENS,FLAGS,TIUMSG,TIUCMMTX
"RTN","TIUSRVP",166,0)
 S IENS=""""_TIUDA_",""",FDARR="FDA(8925,"_IENS_")",FLAGS=""
"RTN","TIUSRVP",167,0)
 I +$G(TIUX(1202)) S TIUX(1204)=+$G(TIUX(1202))
"RTN","TIUSRVP",168,0)
 I +$G(TIUX(1209)) S TIUX(1208)=+$G(TIUX(1209))
"RTN","TIUSRVP",169,0)
 ;If the document is a member of the Clinical Procedures Class, set the
"RTN","TIUSRVP",170,0)
 ;Entered By field to the Author/Dictator field
"RTN","TIUSRVP",171,0)
 I $G(TIUCPF),+$G(TIUX(1202)) S TIUX(1302)=+$G(TIUX(1202))
"RTN","TIUSRVP",172,0)
 M @FDARR=TIUX
"RTN","TIUSRVP",173,0)
 D FILE^DIE(FLAGS,"FDA","TIUMSG") ; File record
"RTN","TIUSRVP",174,0)
 I $D(TIUMSG)>9 S SUCCESS=0_U_$G(TIUMSG("DIERR",1,"TEXT",1)) Q
"RTN","TIUSRVP",175,0)
 S SUCCESS=TIUDA
"RTN","TIUSRVP",176,0)
 I '+$G(SUPPRESS) D
"RTN","TIUSRVP",177,0)
 . N DA
"RTN","TIUSRVP",178,0)
 . S DA=TIUDA
"RTN","TIUSRVP",179,0)
 . S TIUCMMTX=$$COMMIT^TIULC1(+$G(^TIU(8925,+TIUDA,0)))
"RTN","TIUSRVP",180,0)
 . I TIUCMMTX]"" X TIUCMMTX
"RTN","TIUSRVP",181,0)
 . K ^TIU(8925,"ASAVE",DUZ,TIUDA)
"RTN","TIUSRVP",182,0)
 Q
"RTN","TIUSRVP",183,0)
SIGN(ERR,TIUDA,TIUX) ; API for /es/
"RTN","TIUSRVP",184,0)
 N X,TIUACT,TIUSIGN,TIUD0,TIUD12,TIUSTAT,SIGNER,COSIGNER,VALID,XTRASGNR
"RTN","TIUSRVP",185,0)
 N TIUES S ERR=0
"RTN","TIUSRVP",186,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0)),TIUD12=$G(^TIU(8925,+TIUDA,12))
"RTN","TIUSRVP",187,0)
 S SIGNER=$P(TIUD12,U,4),COSIGNER=$P(TIUD12,U,8)
"RTN","TIUSRVP",188,0)
 I (DUZ'=SIGNER),(DUZ'=COSIGNER) S XTRASGNR=+$O(^TIU(8925.7,"AE",+TIUDA,+DUZ,0))
"RTN","TIUSRVP",189,0)
 S TIUSTAT=+$P(TIUD0,U,5)
"RTN","TIUSRVP",190,0)
 S TIUACT=$S(TIUSTAT'>5:"SIGNATURE",+$G(XTRASGNR):"SIGNATURE",1:"COSIGNATURE")
"RTN","TIUSRVP",191,0)
 S TIUSIGN=$$CANDO^TIULP(TIUDA,TIUACT)
"RTN","TIUSRVP",192,0)
 I +TIUSIGN'>0 S ERR="89250004^"_$P(TIUSIGN,U,2) Q
"RTN","TIUSRVP",193,0)
 S VALID=$$VALIDATE($$DECRYP^XUSRB1(TIUX))
"RTN","TIUSRVP",194,0)
 I +VALID'>0 S ERR="89250005^"_$$EZBLD^DIALOG(89250005) Q
"RTN","TIUSRVP",195,0)
 S TIUES=1_U_$P($G(^VA(200,+DUZ,20)),U,2,3)
"RTN","TIUSRVP",196,0)
 I '+$G(XTRASGNR) D ES^TIURS(TIUDA,TIUES)
"RTN","TIUSRVP",197,0)
 I +$G(XTRASGNR) D ADDSIG^TIURS1(TIUDA,XTRASGNR)
"RTN","TIUSRVP",198,0)
 I +$G(^TIU(8925,TIUDA,21)),(TIUACT="SIGNATURE") D AUDLINK^TIUGR1(TIUDA,"a",+$G(^(21)))
"RTN","TIUSRVP",199,0)
 Q
"RTN","TIUSRVP",200,0)
VALIDATE(X) ; Validate /es/-code
"RTN","TIUSRVP",201,0)
 N TIUY S TIUY=0
"RTN","TIUSRVP",202,0)
 D HASH^XUSHSHP I X]"",(X=$P($G(^VA(200,+DUZ,20)),U,4)) S TIUY=1
"RTN","TIUSRVP",203,0)
 Q TIUY
"RTN","TIUSRVP",204,0)
DELETE(ERR,TIUDA,TIURSN,OVRRIDE) ; delete document
"RTN","TIUSRVP",205,0)
 N TIUDEL,TIUD0 S ERR=0
"RTN","TIUSRVP",206,0)
 I '+$G(OVRRIDE) D  Q:+$G(TIUDEL)'>0
"RTN","TIUSRVP",207,0)
 . S TIUDEL=$$CANDO^TIULP(TIUDA,"DELETE RECORD")
"RTN","TIUSRVP",208,0)
 . I TIUDEL'>0 S ERR="89250003^"_$$EZBLD^DIALOG(89250003)
"RTN","TIUSRVP",209,0)
 S TIUD0=$G(^TIU(8925,+TIUDA,0))
"RTN","TIUSRVP",210,0)
 I +$P(TIUD0,U,5)'<6 D  Q
"RTN","TIUSRVP",211,0)
 . S TIURSN=$G(TIURSN,"A")
"RTN","TIUSRVP",212,0)
 . D DELTEXT^TIURB2(TIUDA,TIURSN)
"RTN","TIUSRVP",213,0)
 D DIK^TIURB2(TIUDA)
"RTN","TIUSRVP",214,0)
 D DELAUDIT^TIUEDI1(TIUDA)
"RTN","TIUSRVP",215,0)
 Q
"RTN","TIUSRVP",216,0)
LOCK(ERR,TIUDA) ; Bid for lock on a TIU Document record
"RTN","TIUSRVP",217,0)
 L +^TIU(8925,+TIUDA):1 I  S ERR=0
"RTN","TIUSRVP",218,0)
 E  S ERR="1^ Another session has this record locked."
"RTN","TIUSRVP",219,0)
 Q
"RTN","TIUSRVP",220,0)
UNLOCK(ERR,TIUDA) ; Decrement Lock on a TIU Document record
"RTN","TIUSRVP",221,0)
 L -^TIU(8925,+TIUDA) S ERR=0
"RTN","TIUSRVP",222,0)
 Q
"RTN","TIUSRVPT")
0^3^B9630268
"RTN","TIUSRVPT",1,0)
TIUSRVPT ; SLC/JER - Set Methods for Documents ; 03/31/04
"RTN","TIUSRVPT",2,0)
 ;;1.0;TEXT INTEGRATION UTILITIES;**122,175**;Jun 20, 1997
"RTN","TIUSRVPT",3,0)
SETTEXT(TIUY,TIUDA,TIUX,SUPPRESS) ; Save Text - use Buffered I/O
"RTN","TIUSRVPT",4,0)
 N PAGES,PAGE S TIUY=0,SUPPRESS=$G(SUPPRESS,0)
"RTN","TIUSRVPT",5,0)
 I $S(+$G(TIUDA)'>0:1,'$D(^TIU(8925,+TIUDA,0)):1,1:0) D  Q
"RTN","TIUSRVPT",6,0)
 . S TIUY="0^0^0^Attempt to file data in a Nonexistent Entry."
"RTN","TIUSRVPT",7,0)
 . D ERROR(TIUY)
"RTN","TIUSRVPT",8,0)
 S PAGE=$P($G(TIUX("HDR")),U),PAGES=$P($G(TIUX("HDR")),U,2)
"RTN","TIUSRVPT",9,0)
 I $S('PAGE:1,'PAGES:1,1:0) D  Q
"RTN","TIUSRVPT",10,0)
 . S TIUY="0^0^0^Invalid text block header"
"RTN","TIUSRVPT",11,0)
 . D ERROR(TIUY)
"RTN","TIUSRVPT",12,0)
 I PAGE=1 D MERGTEMP^TIUEDI1(TIUDA) K ^TIU(8925,+TIUDA,"TEMP"),^("TEXT")
"RTN","TIUSRVPT",13,0)
 M ^TIU(8925,+TIUDA,"TEMP")=TIUX("TEXT")
"RTN","TIUSRVPT",14,0)
 ;if done, commit changes
"RTN","TIUSRVPT",15,0)
 I 'SUPPRESS,(PAGE=PAGES),$D(^TIU(8925,TIUDA,"TEMP")) D
"RTN","TIUSRVPT",16,0)
 . N TIUC,TIUI,TIU S (TIUC,TIUI)=0
"RTN","TIUSRVPT",17,0)
 . F  S TIUI=$O(^TIU(8925,TIUDA,"TEMP",TIUI)) Q:+TIUI'>0  D
"RTN","TIUSRVPT",18,0)
 . . S TIUC=TIUC+1
"RTN","TIUSRVPT",19,0)
 . I TIUC>0 S ^TIU(8925,TIUDA,"TEMP",0)="^^"_TIUC_U_TIUC_U_DT_"^^"
"RTN","TIUSRVPT",20,0)
 . D GETTIU^TIULD(.TIU,TIUDA)
"RTN","TIUSRVPT",21,0)
 . K ^TIU(8925,TIUDA,"TEXT")
"RTN","TIUSRVPT",22,0)
 . D MERGTEXT^TIUEDI1(+TIUDA,.TIU)
"RTN","TIUSRVPT",23,0)
 . K ^TIU(8925,TIUDA,"TEMP")
"RTN","TIUSRVPT",24,0)
 ; Acknowledge success / ask for next page
"RTN","TIUSRVPT",25,0)
 S TIUY=TIUDA_U_PAGE_U_PAGES
"RTN","TIUSRVPT",26,0)
 Q
"RTN","TIUSRVPT",27,0)
ADMNCLOS(TIUY,TIUDA,MODE,PERSON) ; Post Administrative Closure Information
"RTN","TIUSRVPT",28,0)
 N TIUX,TIUI,TIUCLBY,TIUCLTTL
"RTN","TIUSRVPT",29,0)
 I '$D(^TIU(8925,TIUDA)) S TIUY="0^Attempt to file data in a Nonexistent Entry." Q
"RTN","TIUSRVPT",30,0)
 S MODE=$G(MODE,"S")
"RTN","TIUSRVPT",31,0)
 S PERSON=$G(PERSON,DUZ)
"RTN","TIUSRVPT",32,0)
 S TIUCLBY=$$SIGNAME^TIULS(PERSON)
"RTN","TIUSRVPT",33,0)
 S TIUCLTTL=$$SIGTITL^TIULS(PERSON)
"RTN","TIUSRVPT",34,0)
 S TIUX(.05)=7
"RTN","TIUSRVPT",35,0)
 S TIUX(1606)=$G(DT)
"RTN","TIUSRVPT",36,0)
 S TIUX(1607)=TIUCLBY
"RTN","TIUSRVPT",37,0)
 S TIUX(1608)=TIUCLTTL
"RTN","TIUSRVPT",38,0)
 S TIUX(1613)=MODE
"RTN","TIUSRVPT",39,0)
 D FILE^TIUSRVP(.TIUY,TIUDA,.TIUX)
"RTN","TIUSRVPT",40,0)
 S TIUI=$P($G(^TIU(8925,TIUDA,"TEXT",0)),U,3)+1
"RTN","TIUSRVPT",41,0)
 ;If scanned document set document body to informational text
"RTN","TIUSRVPT",42,0)
 I MODE="S" D
"RTN","TIUSRVPT",43,0)
 . S ^TIU(8925,+TIUDA,"TEXT",TIUI,0)=" ",TIUI=TIUI+1
"RTN","TIUSRVPT",44,0)
 . S ^TIU(8925,+TIUDA,"TEXT",TIUI,0)="                           *** SCANNED DOCUMENT ***",TIUI=TIUI+1
"RTN","TIUSRVPT",45,0)
 . S ^TIU(8925,+TIUDA,"TEXT",TIUI,0)="                            SIGNATURE NOT REQUIRED",TIUI=TIUI+1
"RTN","TIUSRVPT",46,0)
 . S ^TIU(8925,+TIUDA,"TEXT",TIUI,0)=" ",TIUI=TIUI+1
"RTN","TIUSRVPT",47,0)
 S ^TIU(8925,TIUDA,"TEXT",TIUI,0)=" ",TIUI=TIUI+1
"RTN","TIUSRVPT",48,0)
 S ^TIU(8925,TIUDA,"TEXT",TIUI,0)="Administrative Closure: "_$$DATE^TIULS(DT,"MM/DD/CCYY"),TIUI=TIUI+1
"RTN","TIUSRVPT",49,0)
 S ^TIU(8925,TIUDA,"TEXT",TIUI,0)="                    by: "_TIUCLBY,TIUI=TIUI+1
"RTN","TIUSRVPT",50,0)
 S ^TIU(8925,TIUDA,"TEXT",TIUI,0)="                        "_TIUCLTTL
"RTN","TIUSRVPT",51,0)
 S ^TIU(8925,+TIUDA,"TEXT",0)="^^"_TIUI_U_TIUI_U_DT_"^^"
"RTN","TIUSRVPT",52,0)
 D ALERTDEL^TIUALRT(TIUDA)
"RTN","TIUSRVPT",53,0)
 Q
"RTN","TIUSRVPT",54,0)
ERROR(ECODE) ; Register AUTOSAVE Error
"RTN","TIUSRVPT",55,0)
 N ERRDT S ERRDT=+$$NOW^XLFDT
"RTN","TIUSRVPT",56,0)
 Q:+$G(^XTMP("TIUERR","COUNT"))'<100
"RTN","TIUSRVPT",57,0)
 I '$D(^XTMP("TIUERR",0)) D
"RTN","TIUSRVPT",58,0)
 . S ^XTMP("TIUERR",0)=$$FMADD^XLFDT(DT,90)_U_DT
"RTN","TIUSRVPT",59,0)
 S ^XTMP("TIUERR",ERRDT,"ECODE")=ECODE
"RTN","TIUSRVPT",60,0)
 S ^XTMP("TIUERR",ERRDT,"USER")=DUZ
"RTN","TIUSRVPT",61,0)
 S ^XTMP("TIUERR",ERRDT,"TIUDA")=TIUDA
"RTN","TIUSRVPT",62,0)
 S ^XTMP("TIUERR",ERRDT,"TIUHDR")=$G(TIUX("HDR"))
"RTN","TIUSRVPT",63,0)
 S ^XTMP("TIUERR",ERRDT,"XWBHDR")=$G(XWBS1("HDR"))
"RTN","TIUSRVPT",64,0)
 S ^XTMP("TIUERR","COUNT")=$G(^XTMP("TIUERR","COUNT"))+1
"RTN","TIUSRVPT",65,0)
 Q
"VER")
8.0^22.0
**END**
**END**
