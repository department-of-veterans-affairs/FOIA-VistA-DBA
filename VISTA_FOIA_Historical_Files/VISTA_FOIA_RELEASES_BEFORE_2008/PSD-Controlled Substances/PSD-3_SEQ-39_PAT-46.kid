Released PSD*3*46 SEQ #39
Extracted from mail message
**KIDS**:PSD*3.0*46^

**INSTALL NAME**
PSD*3.0*46
"BLD",4902,0)
PSD*3.0*46^CONTROLLED SUBSTANCES^0^3040618^y
"BLD",4902,1,0)
^^1^1^3040616^
"BLD",4902,1,1,0)
Drug Receipt History reporting issue, Green Sheet Printing issues
"BLD",4902,4,0)
^9.64PA^^
"BLD",4902,"KRN",0)
^9.67PA^8989.52^19
"BLD",4902,"KRN",.4,0)
.4
"BLD",4902,"KRN",.401,0)
.401
"BLD",4902,"KRN",.402,0)
.402
"BLD",4902,"KRN",.403,0)
.403
"BLD",4902,"KRN",.5,0)
.5
"BLD",4902,"KRN",.84,0)
.84
"BLD",4902,"KRN",3.6,0)
3.6
"BLD",4902,"KRN",3.8,0)
3.8
"BLD",4902,"KRN",9.2,0)
9.2
"BLD",4902,"KRN",9.8,0)
9.8
"BLD",4902,"KRN",9.8,"NM",0)
^9.68A^5^3
"BLD",4902,"KRN",9.8,"NM",1,0)
PSDREVD^^0^B18261845
"BLD",4902,"KRN",9.8,"NM",4,0)
PSDPGS1^^0^B26458290
"BLD",4902,"KRN",9.8,"NM",5,0)
PSDRPGS2^^0^B21170791
"BLD",4902,"KRN",9.8,"NM","B","PSDPGS1",4)

"BLD",4902,"KRN",9.8,"NM","B","PSDREVD",1)

"BLD",4902,"KRN",9.8,"NM","B","PSDRPGS2",5)

"BLD",4902,"KRN",19,0)
19
"BLD",4902,"KRN",19.1,0)
19.1
"BLD",4902,"KRN",101,0)
101
"BLD",4902,"KRN",409.61,0)
409.61
"BLD",4902,"KRN",771,0)
771
"BLD",4902,"KRN",870,0)
870
"BLD",4902,"KRN",8989.51,0)
8989.51
"BLD",4902,"KRN",8989.52,0)
8989.52
"BLD",4902,"KRN",8994,0)
8994
"BLD",4902,"KRN","B",.4,.4)

"BLD",4902,"KRN","B",.401,.401)

"BLD",4902,"KRN","B",.402,.402)

"BLD",4902,"KRN","B",.403,.403)

"BLD",4902,"KRN","B",.5,.5)

"BLD",4902,"KRN","B",.84,.84)

"BLD",4902,"KRN","B",3.6,3.6)

"BLD",4902,"KRN","B",3.8,3.8)

"BLD",4902,"KRN","B",9.2,9.2)

"BLD",4902,"KRN","B",9.8,9.8)

"BLD",4902,"KRN","B",19,19)

"BLD",4902,"KRN","B",19.1,19.1)

"BLD",4902,"KRN","B",101,101)

"BLD",4902,"KRN","B",409.61,409.61)

"BLD",4902,"KRN","B",771,771)

"BLD",4902,"KRN","B",870,870)

"BLD",4902,"KRN","B",8989.51,8989.51)

"BLD",4902,"KRN","B",8989.52,8989.52)

"BLD",4902,"KRN","B",8994,8994)

"BLD",4902,"PRE")
PSDP346
"BLD",4902,"QUES",0)
^9.62^^
"BLD",4902,"REQB",0)
^9.611^2^2
"BLD",4902,"REQB",1,0)
PSD*3.0*8^1
"BLD",4902,"REQB",2,0)
PSD*3.0*18^1
"BLD",4902,"REQB","B","PSD*3.0*18",2)

"BLD",4902,"REQB","B","PSD*3.0*8",1)

"MBREQ")
0
"PKG",113,-1)
1^1
"PKG",113,0)
CONTROLLED SUBSTANCES^PSD^Controlled Substances Inventory and Tracking module.
"PKG",113,20,0)
^9.402P^^
"PKG",113,22,0)
^9.49I^1^1
"PKG",113,22,1,0)
3.0^2970213^2970403^24
"PKG",113,22,1,"PAH",1,0)
46^3040618
"PKG",113,22,1,"PAH",1,1,0)
^^1^1^3040618
"PKG",113,22,1,"PAH",1,1,1,0)
Drug Receipt History reporting issue, Green Sheet Printing issues
"PRE")
PSDP346
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","PSDP346")
0^^B6674631
"RTN","PSDP346",1,0)
PSDP346 ; BAY/KAM - Patch PSD*3*46 Install Utility Routine ;5/3/04 12:17pm
"RTN","PSDP346",2,0)
 ;;3.0; CONTROLLED SUBSTANCES;**46**;AUG 13, 1993
"RTN","PSDP346",3,0)
 ;
"RTN","PSDP346",4,0)
ENV ;Main Entry point for Environment Check
"RTN","PSDP346",5,0)
 S XPDABORT=""
"RTN","PSDP346",6,0)
 D PROGCHK(.XPDABORT) ;checks programmer variables
"RTN","PSDP346",7,0)
 I XPDABORT="" K XPDABORT Q
"RTN","PSDP346",8,0)
 D COREFLS
"RTN","PSDP346",9,0)
 Q
"RTN","PSDP346",10,0)
PROGCHK(XPDABORT) ; checks for necessary programmer variables
"RTN","PSDP346",11,0)
 ;
"RTN","PSDP346",12,0)
 I '$G(DUZ)!($G(DUZ(0))'="@")!('$G(DT))!($G(U)'="^")  D
"RTN","PSDP346",13,0)
 . D BMES^XPDUTL("****")
"RTN","PSDP346",14,0)
 . D MES^XPDUTL("Your programming variables are not set up properly.")
"RTN","PSDP346",15,0)
 . D MES^XPDUTL("Installation aborted.")
"RTN","PSDP346",16,0)
 . D MES^XPDUTL("*****")
"RTN","PSDP346",17,0)
 . S XPDABORT=2
"RTN","PSDP346",18,0)
 Q
"RTN","PSDP346",19,0)
COREFLS ; this is the environment check for CoreFLS
"RTN","PSDP346",20,0)
 I $$PATCH^XPDUTL("PSD*3.0*38")!($$PATCH^XPDUTL("PSA*3.0*32")) D
"RTN","PSDP346",21,0)
 . W !,"You are a test site for a CoreFLS version (Patch PSD*3*38 and/or PSA*3*32)",!,"of Controlled Substance or Drug Accountability"
"RTN","PSDP346",22,0)
 . W !,"Instructions are in PSD*3*38 and PSA*3*32 on how to flip the switch to CoreFLS."
"RTN","PSDP346",23,0)
 . W !,"This patch has a conflict with the FB-CoreFLS test software."
"RTN","PSDP346",24,0)
 . W !,"It must NOT be installed unless an accompanying update is made to the"
"RTN","PSDP346",25,0)
 . W !,"FB-CoreFLS software immediately after installation of this patch."
"RTN","PSDP346",26,0)
 . W !
"RTN","PSDP346",27,0)
 . K DIR S DIR(0)="YA"
"RTN","PSDP346",28,0)
 . S DIR("A")="Do you have the corresponding update to the FB-CoreFLS software that is         associated with this patch? (Note:Entering ""No"" here will stop the installation of this patch) Y/N//"
"RTN","PSDP346",29,0)
 . D ^DIR K DIR
"RTN","PSDP346",30,0)
 . I $D(DTOUT)!$D(DUOUT)!(Y'=1) W !,"Installation of this patch has been stopped!" S XPDABORT=2 Q
"RTN","PSDP346",31,0)
 . W !,"OK to install"
"RTN","PSDP346",32,0)
 Q
"RTN","PSDPGS1")
0^4^B26458290
"RTN","PSDPGS1",1,0)
PSDPGS1 ;BIR/JPW-Print Green Sheet (VA FORM 10-2638 ) (cont'd) ; 3 Mar 98
"RTN","PSDPGS1",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,46**;13 Feb 97
"RTN","PSDPGS1",3,0)
 ;Y2K compliance** display 4 digit year on va forms
"RTN","PSDPGS1",4,0)
START ;loop through transactions
"RTN","PSDPGS1",5,0)
 ;second call to %ZIS to restore variables for open execute
"RTN","PSDPGS1",6,0)
 I $D(ZTQUEUED) S IOP=ION D ^%ZIS U IO
"RTN","PSDPGS1",7,0)
 ;get ready for bar codes and formatting
"RTN","PSDPGS1",8,0)
 N PSD10,PSD12,PSDL,A7BAR0,A7BAR1
"RTN","PSDPGS1",9,0)
 D A7BAR
"RTN","PSDPGS1",10,0)
 S PSD10=$P($G(^%ZIS(2,+$G(IOST(0)),5)),U),PSD12=$P($G(^(5)),U,2)
"RTN","PSDPGS1",11,0)
 S PSDL=$P($G(^%ZIS(2,+$G(IOST(0)),12.16)),U)
"RTN","PSDPGS1",12,0)
 S PSDL(1)=$P($G(^%ZIS(2,+$G(IOST(0)),12.15)),U)
"RTN","PSDPGS1",13,0)
 I PSD12']""!(PSD10']"")!(PSDL']"")!(PSDL(1)']"") W !!,"The device you selected is not set up for green sheets, please contact IRM.",!! Q
"RTN","PSDPGS1",14,0)
 K ^TMP("PSDPGS",$J)
"RTN","PSDPGS1",15,0)
 S PSDCNT=1
"RTN","PSDPGS1",16,0)
 I ANS="R" S PSD1="" F  S PSD1=$O(PSD1(PSD1)) Q:PSD1=""  D LOOP
"RTN","PSDPGS1",17,0)
 I ANS="R" G PRINT
"RTN","PSDPGS1",18,0)
 I ANS="N",$D(PSDG) F PSD=0:0 S PSD=$O(PSDG(PSD)) Q:'PSD  F PSDN=0:0 S PSDN=$O(^PSI(58.2,PSD,3,PSDN)) Q:'PSDN  I $D(^PSD(58.8,PSDN,0)),'$P(^(0),"^",7),$P(^(0),"^",3)=+PSDSITE S NAOU(PSDN)="",CNT=CNT+1
"RTN","PSDPGS1",19,0)
 I ANS="N",$D(ALL) F PSD=0:0 S PSD=$O(^PSD(58.8,PSD)) Q:'PSD  I $D(^PSD(58.8,PSD,0)),$P(^(0),"^",2)="N",$P(^(0),"^",3)=+PSDSITE S NAOU(+PSD)=""
"RTN","PSDPGS1",20,0)
 S LOOP=$S(PRT:2,1:3)
"RTN","PSDPGS1",21,0)
 F STAT=LOOP-.99:0 S STAT=$O(^PSD(58.81,"AD",STAT)) Q:'STAT!(STAT>3)  F PSD=0:0 S PSD=$O(^PSD(58.81,"AD",STAT,PSD)) Q:'PSD  F PSDA=0:0 S PSDA=$O(^PSD(58.81,"AD",STAT,PSD,PSDA)) Q:'PSDA  D SET
"RTN","PSDPGS1",22,0)
PRINT ;print green sheet
"RTN","PSDPGS1",23,0)
 I '$D(^TMP("PSDPGS",$J)) W !,"*** SORRY NO GREEN SHEETS TO PRINT ***",! G END
"RTN","PSDPGS1",24,0)
 S PSDPN="" F  S PSDPN=$O(^TMP("PSDPGS",$J,PSDPN)) Q:PSDPN=""  D
"RTN","PSDPGS1",25,0)
 .S NODE=^TMP("PSDPGS",$J,PSDPN),NAOUN=$P(NODE,"^"),PSDBYN=$P(NODE,"^",5),PSDT=$P(NODE,"^",6),ORDN=$P(NODE,"^",7)
"RTN","PSDPGS1",26,0)
 .I ORDN]"",ORDN'="UNKNOWN" S ORDN=$P(ORDN,",")_","_$E($P(ORDN,",",2))
"RTN","PSDPGS1",27,0)
 .I PSDBYN]"",PSDBYN'="UNKNOWN" S PSDBYN=$P(PSDBYN,",")_","_$E($P(PSDBYN,",",2))
"RTN","PSDPGS1",28,0)
 .S PSDDT="" I PSDT S Y=PSDT X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4) S PSDDT=$E(PSDT,4,5)_"/"_$E(PSDT,6,7)_"/"_PSDYR
"RTN","PSDPGS1",29,0)
 .W:$Y @IOF,@PSD12 W ?33,NAOUN,"  ",$P($G(^DPT(+$P(NODE,U,9),0)),U)
"RTN","PSDPGS1",30,0)
 .I $D(A7PRT) W $C(13),?70,@A7BAR1,@PSD10,PSDPN,@A7BAR0,@PSD12
"RTN","PSDPGS1",31,0)
 .W @PSDL,!?6,"CONTROLLED SUBSTANCE ADMINISTRATION RECORD",?54
"RTN","PSDPGS1",32,0)
 .W "Pharmacy Dispensing # ",@PSD10,PSDPN,@PSD12,!?6
"RTN","PSDPGS1",33,0)
 .W "Drug: ",@PSD10,$P(NODE,U,2),@PSD12,?60,"Exp: ",$P(NODE,U,4),?78
"RTN","PSDPGS1",34,0)
 .W "Qty: ",@PSD10,$P(NODE,U,3),@PSD12,!?6
"RTN","PSDPGS1",35,0)
 .W "Lot#",$P(NODE,U,8),?21,"Ord by: ",$E(ORDN,1,20)
"RTN","PSDPGS1",36,0)
 .W ?45,"Disp by: ",$E(PSDBYN,1,20),?70,"Date: ",PSDDT,@PSDL(1),!?7
"RTN","PSDPGS1",37,0)
 .S $P(LN,"_",80)="" W LN,@PSDL,!?6
"RTN","PSDPGS1",38,0)
 .W "| DATE   TIME     NAME OF PATIENT      DOSE  BALANCE  ADMINISTERED BY           |"
"RTN","PSDPGS1",39,0)
 .F LINE=1:1:30 W !?6,"|________|_____|_______________________|_____|______|___________________________|"
"RTN","PSDPGS1",40,0)
 .W !?6,"Above Drug Received:      Date__________ R.N. Sign_______________________________"
"RTN","PSDPGS1",41,0)
 .W !?6,"Above Drug Administered:  Date__________ R.N. Sign_______________________________"
"RTN","PSDPGS1",42,0)
 .W !?6,"Entries Reviewed:         Date__________ R.PH. Sign______________________________",!?6
"RTN","PSDPGS1",43,0)
 .W @PSDL(1),"Drug: ",@PSD10,$P(NODE,U,2),@PSD12,?60
"RTN","PSDPGS1",44,0)
 .W "Pharmacy Dispensing # ",@PSD10,PSDPN,@PSD12,!?6
"RTN","PSDPGS1",45,0)
 .W "Automated VA FORM 10-2638"
"RTN","PSDPGS1",46,0)
END K %ZIS,ALL,ANS,ASK,C,CNT,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXPD,IOP,JJ,LINE,LOOP,LOT,NAOU,NAOUN,NODE,NODE1
"RTN","PSDPGS1",47,0)
 K OK,ORD,ORDN,POP,PRT,PSD,PSD1,PSDA,PSDBY,PSDBYN,PSDCPI,PSDCNT,PSDDT,PSDEV,PSDG,PSDN,PSDOUT,PSDPN,PSDR,PSDRN,PSDS,PSDSN,PSDT,PSDYR
"RTN","PSDPGS1",48,0)
 K QTY,SEL,SITE,STAT,X,Y,ZTDESC,ZTDTH,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDPGS1",49,0)
 K ^TMP("PSDPGS",$J)
"RTN","PSDPGS1",50,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDPGS1",51,0)
 Q
"RTN","PSDPGS1",52,0)
LOOP S PSDPN=$P(PSD1(PSD1),",",PSDCNT),PSDCNT=PSDCNT+1 I PSDPN="" S PSDCNT=1 Q
"RTN","PSDPGS1",53,0)
 S PSDA=$O(^PSD(58.81,"D",PSDPN,0)),PSD=+$P($G(^PSD(58.81,+PSDA,0)),"^",18) D SET
"RTN","PSDPGS1",54,0)
 G LOOP
"RTN","PSDPGS1",55,0)
 Q
"RTN","PSDPGS1",56,0)
SET ;set data for printing
"RTN","PSDPGS1",57,0)
 Q:'$D(^PSD(58.81,+PSDA,0))  Q:+$P($G(^PSD(58.81,+PSDA,0)),"^",3)'=+PSDS
"RTN","PSDPGS1",58,0)
 Q:+$P($G(^PSD(58.8,+PSD,2)),"^",5)&('$P($G(^PSD(58.8,+PSDS,1,+$P($G(^PSD(58.81,+PSDA,0)),U,5),7)),U,3))&('$P($G(^PSD(58.81,+PSDA,9)),U))
"RTN","PSDPGS1",59,0)
 Q:+$P($G(^PSD(58.81,+PSDA,"CS")),"^",4)
"RTN","PSDPGS1",60,0)
 I ANS="N" Q:'$D(NAOU(+PSD))
"RTN","PSDPGS1",61,0)
 S NODE=^PSD(58.81,+PSDA,0) Q:+$P(NODE,"^",11)>3
"RTN","PSDPGS1",62,0)
 S NAOUN=$S($P($G(^PSD(58.8,+PSD,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDPGS1",63,0)
 S PSDR=+$P(NODE,"^",5),PSDRN=$S($P($G(^PSDRUG(PSDR,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDPGS1",64,0)
 S PSDPN=$S($P(NODE,"^",17)]"":$P(NODE,"^",17),1:"UNKNOWN"),PSDT=$P(NODE,"^",4)
"RTN","PSDPGS1",65,0)
 S QTY=$P(NODE,"^",6) I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=$P(^(4),"^",3)
"RTN","PSDPGS1",66,0)
 S LOT=$P(NODE,"^",14),EXP=$P(NODE,"^",15),EXPD="" I EXP S Y=$E(EXP,1,7) X ^DD("DD") S EXPD=Y
"RTN","PSDPGS1",67,0)
 S (PSDBY,PSDBYN,ORD,ORDN)=""
"RTN","PSDPGS1",68,0)
 I $D(^PSD(58.81,PSDA,1)) S NODE1=^(1),PSDBY=$P(NODE1,"^"),ORD=$P(NODE1,"^",7)
"RTN","PSDPGS1",69,0)
 S:ORD ORDN=$S($P($G(^VA(200,ORD,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDPGS1",70,0)
 S:PSDBY PSDBYN=$S($P($G(^VA(200,PSDBY,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDPGS1",71,0)
 S ^TMP("PSDPGS",$J,PSDPN)=NAOUN_"^"_PSDRN_"^"_QTY_"^"_EXPD_"^"_PSDBYN_"^"_PSDT_"^"_ORDN_"^"_LOT_U_$P($G(^PSD(58.81,PSDA,9)),U)
"RTN","PSDPGS1",72,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81,DR="103////1" D ^DIE K DA,DIE,DR
"RTN","PSDPGS1",73,0)
 Q
"RTN","PSDPGS1",74,0)
A7BAR ;DALISC/JRR set up vars to print barcode on green sheet
"RTN","PSDPGS1",75,0)
 ;This subroutine added by James Reed, Dallas ISC, 9/8/95
"RTN","PSDPGS1",76,0)
 K A7PRT ;Var will be defined if bar code logic was set up in device file
"RTN","PSDPGS1",77,0)
 F JJ=0,1 S @("A7BAR"_JJ)="" I $D(^%ZIS(2,^%ZIS(1,IOS,"SUBTYPE"),"BAR"_JJ)) S @("A7BAR"_JJ)=^("BAR"_JJ)
"RTN","PSDPGS1",78,0)
 I A7BAR1]"",A7BAR0]"" S A7PRT=1 ;okay to print bar code
"RTN","PSDREVD")
0^1^B18261845
"RTN","PSDREVD",1,0)
PSDREVD ;BIR/LTL-Review Receipt Transactions for a Drug ; 29 Aug 94
"RTN","PSDREVD",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**18,46**;13 Feb 97
"RTN","PSDREVD",3,0)
 ;
"RTN","PSDREVD",4,0)
 ;References to ^PSD(58.8, covered by DBIA2711
"RTN","PSDREVD",5,0)
 ;References to ^PSD(58.81 are covered by DBIA2808
"RTN","PSDREVD",6,0)
 ;References to ^PSDRUG( are covered by DBIA221
"RTN","PSDREVD",7,0)
 ;References to ^PRC(442 are covered by DBIA#682
"RTN","PSDREVD",8,0)
 ;References to ^PRCS(410 are covered by DBIA#198
"RTN","PSDREVD",9,0)
 N PSDOUT I '$D(PSDSITE) D ^PSDSET I '$D(PSDSITE) S PSDOUT=1 G END
"RTN","PSDREVD",10,0)
 N C,CNT,DIC,DIR,DIRUT,DTOUT,DUOUT,PSD,PSDEV,PSDR,PSDU,PSDLOC,PSDLOCN,PSDT,X,Y S PSDOUT=1,PSDU=0
"RTN","PSDREVD",11,0)
 D DT^DICRW
"RTN","PSDREVD",12,0)
 S PSDLOC=$P(PSDSITE,U,3),PSDLOCN=$P(PSDSITE,U,4)
"RTN","PSDREVD",13,0)
 S CNT=0 G:$P(PSDSITE,U,5) CHKD
"RTN","PSDREVD",14,0)
LOOK S DIC="^PSD(58.8,",DIC(0)="AEQ",DIC("A")="Select Dispensing Site: "
"RTN","PSDREVD",15,0)
 S DIC("S")="I $P($G(^(0)),U,3)=+PSDSITE,$P($G(^(0)),U,2)[""M""&($S('$D(^(""I"")):1,+^(""I"")>DT:1,'^(""I""):1,1:0))"
"RTN","PSDREVD",16,0)
 S:$P($G(^PSD(58.8,+PSDLOC,0)),U,2)["M" DIC("B")=PSDLOCN
"RTN","PSDREVD",17,0)
 W ! D ^DIC K DIC G:Y<0 END S PSDLOC=+Y,PSDLOCN=$P(Y,U,2)
"RTN","PSDREVD",18,0)
 S $P(PSDSITE,U,3)=+Y,$P(PSDSITE,U,4)=PSDLOCN
"RTN","PSDREVD",19,0)
 S CNT=0 W !!,"You may select one, several, or ^ALL drugs.",!
"RTN","PSDREVD",20,0)
CHKD F  S DIC="^PSD(58.8,+PSDLOC,1,",DIC(0)="AEMQ",DIC("A")="Please Select "_PSDLOCN_"'s Drug: ",DIC("S")="I $S($G(^(""I"")):$G(^(""I""))>DT,1:1)" W ! D ^DIC K DIC G:X'="^ALL"&(Y<1)&('CNT) END Q:Y<0  S PSD(+Y)="",CNT=CNT+1
"RTN","PSDREVD",21,0)
 I CNT=1&('$O(^PSD(58.81,"F",+$O(PSD(0)),""))) W !!,"There have been no receipts for this drug.",!! G END
"RTN","PSDREVD",22,0)
 I X="^ALL" F  S PSDU=$O(^PSD(58.8,+PSDLOC,1,PSDU)) Q:'PSDU  S PSD(PSDU)=""
"RTN","PSDREVD",23,0)
 S DIR(0)="D:AEP",DIR("A")="How far back in time do you want to go? ",DIR("B")="T-6M",DIR("?")="I will list receipts for your selected drug(s) within the last six months if you press return" W ! D ^DIR K DIR G:$D(DIRUT) END
"RTN","PSDREVD",24,0)
 S PSDT=Y
"RTN","PSDREVD",25,0)
 S Y=$P($G(^PSD(58.8,+PSDLOC,2)),"^",9),C=$P(^DD(58.8,24,0),"^",2) D Y^DIQ S PSDEV=Y
"RTN","PSDREVD",26,0)
DEV ;asks device and queueing info
"RTN","PSDREVD",27,0)
 K IO("Q") N %ZIS,IOP,POP S %ZIS="Q",%ZIS("B")=PSDEV W ! D ^%ZIS I POP W !,"NO DEVICE SELECTED OR OUTPUT PRINTED!" Q
"RTN","PSDREVD",28,0)
 I $D(IO("Q")) N ZTDESC,ZTIO,ZTRTN,ZTSAVE,ZTDTH,ZTSK S ZTRTN="START^PSDREVD",ZTDESC="Drug receipt transaction review",ZTSAVE("PSD*")="" D ^%ZTLOAD,HOME^%ZIS S PSDOUT=1 G END
"RTN","PSDREVD",29,0)
START ;compiles and prints output
"RTN","PSDREVD",30,0)
 N %DT,LN,PSDR,PG,RPDT S (PG,PSDOUT)=0,Y=DT,PSDR="" X ^DD("DD") S RPDT=Y,PSDU(1)=$O(PSD(0)) D HEADER S PSDU=0
"RTN","PSDREVD",31,0)
 F  S PSDU=$O(PSD(PSDU)) Q:'PSDU  K PSDR(1) D  G:PSDOUT END I 'PSDR,$O(PSD(PSDU)) S PSDU(1)=$O(PSD(PSDU))
"RTN","PSDREVD",32,0)
LOOP .F  S PSDR=$O(^PSD(58.81,"F",PSDU,PSDR)) Q:'PSDR  D:$Y+6>IOSL HEADER Q:PSDOUT  S PSDR(2)=$G(^PSD(58.81,+PSDR,0)) D:$P(PSDR(2),U,4)'<PSDT&($P(PSDR(2),U,2)=1)
"RTN","PSDREVD",33,0)
 ..I $G(PSDLOC)'=$P(PSDR(2),U,3) Q  ;PSD*3*46
"RTN","PSDREVD",34,0)
 ..S PSDR(1)=$G(PSDR(1))+1 W:PSDR(1)=1 $P($G(^PSDRUG(+PSDU,0)),U),!
"RTN","PSDREVD",35,0)
 ..W:PSDR(1)=1 !,"Receiving Site: ",$P($G(^PSD(58.8,+PSDLOC,0)),U),!  ; PSD*3*46
"RTN","PSDREVD",36,0)
 ..; PSD*3*46 Commented out the next two lines
"RTN","PSDREVD",37,0)
 ..;I '$D(PSDLOC) S PSDLOC=$P(PSDR(2),U,3) W !,"Receiving Site: ",$P($G(^PSD(58.8,+PSDLOC,0)),U),!
"RTN","PSDREVD",38,0)
 ..;I $G(PSDLOC)'=$P(PSDR(2),U,3) S PSDLOC=$P(PSDR(2),U,3) W !,"Receiving site: ",$P($G(^PSD(58.8,+PSDLOC,0)),U),!
"RTN","PSDREVD",39,0)
 ..S Y=$E($P(PSDR(2),U,4),1,12) X ^DD("DD") W !,Y,"  "," -> "
"RTN","PSDREVD",40,0)
 ..W $P(PSDR(2),U,6)," received by ",$P($G(^VA(200,+$P(PSDR(2),U,7),0)),U),!!
"RTN","PSDREVD",41,0)
 ..W:$P($G(^PRC(442,+$P(PSDR(2),U,9),0)),U) "P.O.#:  "_$P($G(^(0)),U),?20
"RTN","PSDREVD",42,0)
 ..W:$P($G(^PRCS(410,+$P(PSDR(2),U,8),0)),U) "TR#:  ",$P($G(^(0)),U),"  "
"RTN","PSDREVD",43,0)
 ..W:$P($G(^PSD(58.81,+PSDR,8)),U)]"" "INV#:  ",$P($G(^(8)),U)
"RTN","PSDREVD",44,0)
 ..W !,LN,!
"RTN","PSDREVD",45,0)
END W:$E(IOST)'="C" @IOF
"RTN","PSDREVD",46,0)
 I $E(IOST)="C",'PSDOUT S DIR(0)="EA",DIR("A")="END OF REPORT!  Press <RET> to return to the menu." D ^DIR
"RTN","PSDREVD",47,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@" K IO("Q")
"RTN","PSDREVD",48,0)
 Q
"RTN","PSDREVD",49,0)
HEADER ;prints header info
"RTN","PSDREVD",50,0)
 I $E(IOST,1,2)'="P-",PG S DIR(0)="E" D ^DIR K DIR I 'Y S PSDOUT=1 Q
"RTN","PSDREVD",51,0)
 I $$S^%ZTLOAD W !!,"Task #",$G(ZTSK),", ",$G(ZTDESC)," was stopped by ",$P($G(^VA(200,+$G(DUZ),0)),U),"." S PSDOUT=1
"RTN","PSDREVD",52,0)
 W:$Y @IOF S $P(LN,"-",81)="",PG=PG+1 W !?2,"History of Drug Receipts",?50,RPDT,?70,"PAGE: ",PG,!,LN,!
"RTN","PSDRPGS2")
0^5^B21170791
"RTN","PSDRPGS2",1,0)
PSDRPGS2 ;BIR/JPW,LTL,BJW-Reprint Green Sheet (VA FORM 10-2638) cont'd ; 3 Mar 98
"RTN","PSDRPGS2",2,0)
 ;;3.0; CONTROLLED SUBSTANCES ;**8,46**;13 Feb 97
"RTN","PSDRPGS2",3,0)
 ;**Y2K compliance** display 4 digit year on va forms
"RTN","PSDRPGS2",4,0)
START ;loop through transactions
"RTN","PSDRPGS2",5,0)
 ;second call to %ZIS to restore varibles for open execute
"RTN","PSDRPGS2",6,0)
 I $D(ZTQUEUED) S IOP=ION D ^%ZIS U IO
"RTN","PSDRPGS2",7,0)
 ;get ready for bar codes and formatting
"RTN","PSDRPGS2",8,0)
 N PSD10,PSD12,PSDL,A7BAR0,A7BAR1
"RTN","PSDRPGS2",9,0)
 D A7BAR^PSDPGS1
"RTN","PSDRPGS2",10,0)
 S PSD10=$P($G(^%ZIS(2,+$G(IOST(0)),5)),U),PSD12=$P($G(^(5)),U,2)
"RTN","PSDRPGS2",11,0)
 S PSDL=$P($G(^%ZIS(2,+$G(IOST(0)),12.16)),U)
"RTN","PSDRPGS2",12,0)
 S PSDL(1)=$P($G(^%ZIS(2,+$G(IOST(0)),12.15)),U)
"RTN","PSDRPGS2",13,0)
 I PSD12']""!(PSD10']"")!(PSDL']"")!(PSDL(1)']"") W !!,"The device you selected is not set up for green sheets, please contact IRM.",!! Q
"RTN","PSDRPGS2",14,0)
 S PSD=$P(PSDS,"^",2),PSDCNT=1
"RTN","PSDRPGS2",15,0)
 S PSD1="" F  S PSD1=$O(PSD1(PSD1)) Q:PSD1=""  D LOOP
"RTN","PSDRPGS2",16,0)
END K %ZIS,ANS,ASK,C,CNT,D,DA,DIC,DIE,DIR,DIROUT,DIRUT,DR,DTOUT,DUOUT,EXP,EXPD,LINE,LOT,NAOU,NAOUN,NODE,NODE1
"RTN","PSDRPGS2",17,0)
 K OK,ORD,ORDN,POP,PRT,PSD,PSD1,PSDA,PSDBY,PSDBYN,PSDCNT,PSDDT,PSDEV,PSDOUT,PSDCPI,PSDPN,PSDR,PSDRN,PSDS,PSDSN,PSDT,PSDTR,PSDTRN,PSDYR,REPRINT,QTY,SITE,STAT,TRANS,Y,ZTDESC,ZTDTH,ZTRTN,ZTSAVE,ZTSK
"RTN","PSDRPGS2",18,0)
 D ^%ZISC S:$D(ZTQUEUED) ZTREQ="@"
"RTN","PSDRPGS2",19,0)
 Q
"RTN","PSDRPGS2",20,0)
LOOP S PSDPN=$P(PSD1(PSD1),",",PSDCNT),PSDCNT=PSDCNT+1 I PSDPN="" S PSDCNT=1 Q
"RTN","PSDRPGS2",21,0)
 S PSDA=$O(^PSD(58.81,"D",PSDPN,0)) D SET
"RTN","PSDRPGS2",22,0)
 G LOOP
"RTN","PSDRPGS2",23,0)
 Q
"RTN","PSDRPGS2",24,0)
SET ;set data for printing
"RTN","PSDRPGS2",25,0)
 K TRANS,PSDTR S PSDOUT=0
"RTN","PSDRPGS2",26,0)
 Q:'$D(^PSD(58.81,+PSDA,0))  S NODE=^PSD(58.81,+PSDA,0)
"RTN","PSDRPGS2",27,0)
 Q:+$P(NODE,"^",3)'=+PSDS  I (+$P(NODE,"^",11)>4)&(+$P(NODE,"^",11)'=10)&(+$P(NODE,U,11)'=13) Q
"RTN","PSDRPGS2",28,0)
 I +$P($G(^PSD(58.81,PSDA,"CS")),"^",4)  S REPRINT=1
"RTN","PSDRPGS2",29,0)
 S PSD=+$P(NODE,"^",18)
"RTN","PSDRPGS2",30,0)
 S NAOUN=$S($P($G(^PSD(58.8,+PSD,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDRPGS2",31,0)
 S PSDR=$P(NODE,"^",5),PSDRN=$S($P($G(^PSDRUG(PSDR,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDRPGS2",32,0)
 S PSDT=$P(NODE,"^",4)
"RTN","PSDRPGS2",33,0)
 S QTY=$P(NODE,"^",6) I $D(^PSD(58.81,PSDA,4)),+$P(^(4),"^",3) S QTY=$P(^(4),"^",3)
"RTN","PSDRPGS2",34,0)
 S LOT=$P(NODE,"^",14),EXP=$P(NODE,"^",15),EXPD="" I EXP S Y=$E(EXP,1,7) X ^DD("DD") S EXPD=Y
"RTN","PSDRPGS2",35,0)
 S (PSDBY,PSDBYN,ORD,ORDN)=""
"RTN","PSDRPGS2",36,0)
 I $D(^PSD(58.81,PSDA,1)) S NODE1=^(1),PSDBY=$P(NODE1,"^"),ORD=$P(NODE1,"^",7)
"RTN","PSDRPGS2",37,0)
 S:ORD ORDN=$S($P($G(^VA(200,ORD,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDRPGS2",38,0)
 S:PSDBY PSDBYN=$S($P($G(^VA(200,PSDBY,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDRPGS2",39,0)
 S CNT=1,PSDTR(CNT)=+$O(^PSD(58.81,"AE",PSDA,0)) D:PSDTR(CNT)  G:PSDOUT PRINT
"RTN","PSDRPGS2",40,0)
 .S TRANS=1
"RTN","PSDRPGS2",41,0)
 .D SETT Q:PSDOUT
"RTN","PSDRPGS2",42,0)
 .S NAOU=+$P($G(^PSD(58.81,PSDTR(CNT),0)),"^",18)
"RTN","PSDRPGS2",43,0)
 .S:NAOU $P(PSDTR(CNT),"^",2)=$S($P($G(^PSD(58.8,+NAOU,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDRPGS2",44,0)
PRINT ;print green sheet
"RTN","PSDRPGS2",45,0)
 I ORDN]"",ORDN'="UNKNOWN" S ORDN=$P(ORDN,",")_","_$E($P(ORDN,",",2))
"RTN","PSDRPGS2",46,0)
 I PSDBYN]"",PSDBYN'="UNKNOWN" S PSDBYN=$P(PSDBYN,",")_","_$E($P(PSDBYN,",",2))
"RTN","PSDRPGS2",47,0)
 S PSDDT="" I PSDT S Y=PSDT X ^DD("DD") S PSDYR=$P(Y,",",2),PSDYR=$E(PSDYR,1,4) S PSDDT=$E(PSDT,4,5)_"/"_$E(PSDT,6,7)_"/"_PSDYR
"RTN","PSDRPGS2",48,0)
 W:$Y @IOF,@PSD12
"RTN","PSDRPGS2",49,0)
 W:$D(REPRINT) $C(13),?10,"* REPRINT *",$P($G(^DPT(+$P($G(^PSD(58.81,PSDA,9)),U),0)),U) I '$D(TRANS) W ?33,NAOUN
"RTN","PSDRPGS2",50,0)
 W:$D(TRANS) "* Transferred to: ",$S($P(PSDTR(CNT),"^",2)]"":$P(PSDTR(CNT),"^",2),1:$P(PSDTR(CNT-1),"^",2))," *"
"RTN","PSDRPGS2",51,0)
 I $D(A7PRT) W $C(13),?70,@A7BAR1,@PSD10,PSDPN,@A7BAR0,@PSD12
"RTN","PSDRPGS2",52,0)
 W @PSDL,!?6,"CONTROLLED SUBSTANCE ADMINISTRATION RECORD",?54
"RTN","PSDRPGS2",53,0)
 W "Pharmacy Dispensing # ",@PSD10,PSDPN,@PSD12,!?6
"RTN","PSDRPGS2",54,0)
 W "Drug: ",@PSD10,PSDRN,@PSD12,?60,"Exp: ",EXPD,?78
"RTN","PSDRPGS2",55,0)
 W "Qty: ",@PSD10,QTY,@PSD12,!?6
"RTN","PSDRPGS2",56,0)
 W "Lot#",LOT,?21,"Ord by: ",$E(ORDN,1,20)
"RTN","PSDRPGS2",57,0)
 W ?45,"Disp by: ",$E(PSDBYN,1,20),?70,"Date: ",PSDDT,@PSDL(1),!?7
"RTN","PSDRPGS2",58,0)
 S $P(LN,"_",79)="" W LN,@PSDL,!?6
"RTN","PSDRPGS2",59,0)
 W "| DATE   TIME     NAME OF PATIENT      DOSE  BALANCE  ADMINISTERED BY          |"
"RTN","PSDRPGS2",60,0)
 F LINE=1:1:30 W !?6,"|_______|_____|_______________________|_____|______|___________________________|"
"RTN","PSDRPGS2",61,0)
 ;W:ASK !
"RTN","PSDRPGS2",62,0)
 W !?6,"Above Drug Received:      Date__________  R.N. Sign_____________________________"
"RTN","PSDRPGS2",63,0)
 W !?6,"Above Drug Administered:  Date__________  R.N. Sign_____________________________"
"RTN","PSDRPGS2",64,0)
 W !?6,"Entries Reviewed:         Date__________  R.PH. Sign____________________________",!?6
"RTN","PSDRPGS2",65,0)
 W @PSDL(1),"Drug: ",@PSD10,PSDRN,@PSD12,?60
"RTN","PSDRPGS2",66,0)
 W "Pharmacy Dispensing # ",@PSD10,PSDPN,@PSD12,!?6
"RTN","PSDRPGS2",67,0)
 W "Automated VA FORM 10-2638"
"RTN","PSDRPGS2",68,0)
 ;W @PSDL(1),"Drug: ",@PSD10,PSDRN,@PSD12,!?6
"RTN","PSDRPGS2",69,0)
 ;W "Automated VA FORM 10-2638",?54,"Pharmacy Dispensing # ",@PSD10,PSDPN
"RTN","PSDRPGS2",70,0)
 K DA,DIE,DR S DA=PSDA,DIE=58.81,DR="103////1" D ^DIE K DA,DIE,DR
"RTN","PSDRPGS2",71,0)
 Q
"RTN","PSDRPGS2",72,0)
SETT ;set trans naous
"RTN","PSDRPGS2",73,0)
 S PSDTRN=+$O(^PSD(58.81,"AE",+PSDTR(CNT),0)) Q:'PSDTRN
"RTN","PSDRPGS2",74,0)
 S NAOU=$P($G(^PSD(58.81,+PSDTRN,0)),"^",18) I 'NAOU S PSDOUT=1 Q
"RTN","PSDRPGS2",75,0)
 S:NAOU $P(PSDTR(CNT),"^",2)=$S($P($G(^PSD(58.8,+NAOU,0)),"^")]"":$P(^(0),"^"),1:"UNKNOWN")
"RTN","PSDRPGS2",76,0)
 I $O(^PSD(58.81,"AE",+PSDTRN,0)) S CNT=CNT+1,PSDTR(CNT)=$O(^PSD(58.81,"AE",+PSDTRN,0)) G SETT
"RTN","PSDRPGS2",77,0)
 Q
"VER")
8.0^22
**END**
**END**
