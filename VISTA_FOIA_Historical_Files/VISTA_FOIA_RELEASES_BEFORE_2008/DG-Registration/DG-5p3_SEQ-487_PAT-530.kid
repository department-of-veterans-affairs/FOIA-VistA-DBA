Released DG*5.3*530 SEQ #487
Extracted from mail message
**KIDS**:DG*5.3*530^

**INSTALL NAME**
DG*5.3*530
"BLD",4817,0)
DG*5.3*530^REGISTRATION^0^3031120^y
"BLD",4817,1,0)
^^3^3^3031105^
"BLD",4817,1,1,0)
THIS PATCH CORRECTS A LOCK PROBLEM WHEN MULTIPLE PATIENTS ARE EDITTED, 
"BLD",4817,1,2,0)
A NULL SUBSCRIPT ERROR REPORTED IN ROUTINE VAFHPURG, AND A PTF 
"BLD",4817,1,3,0)
TRANSMISSION PROBLEM WHICH FAILED TO INITIALIZE THE LINE COUNT VARIABLE.
"BLD",4817,4,0)
^9.64PA^^
"BLD",4817,"ABPKG")
n
"BLD",4817,"KRN",0)
^9.67PA^8989.52^19
"BLD",4817,"KRN",.4,0)
.4
"BLD",4817,"KRN",.401,0)
.401
"BLD",4817,"KRN",.402,0)
.402
"BLD",4817,"KRN",.403,0)
.403
"BLD",4817,"KRN",.5,0)
.5
"BLD",4817,"KRN",.84,0)
.84
"BLD",4817,"KRN",3.6,0)
3.6
"BLD",4817,"KRN",3.8,0)
3.8
"BLD",4817,"KRN",9.2,0)
9.2
"BLD",4817,"KRN",9.8,0)
9.8
"BLD",4817,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",4817,"KRN",9.8,"NM",1,0)
VAFHPURG^^0^B7822443
"BLD",4817,"KRN",9.8,"NM",2,0)
VAFCMSG^^0^B15865055
"BLD",4817,"KRN",9.8,"NM",3,0)
DGPTFTR^^0^B18741370
"BLD",4817,"KRN",9.8,"NM","B","DGPTFTR",3)

"BLD",4817,"KRN",9.8,"NM","B","VAFCMSG",2)

"BLD",4817,"KRN",9.8,"NM","B","VAFHPURG",1)

"BLD",4817,"KRN",19,0)
19
"BLD",4817,"KRN",19.1,0)
19.1
"BLD",4817,"KRN",101,0)
101
"BLD",4817,"KRN",409.61,0)
409.61
"BLD",4817,"KRN",771,0)
771
"BLD",4817,"KRN",870,0)
870
"BLD",4817,"KRN",8989.51,0)
8989.51
"BLD",4817,"KRN",8989.52,0)
8989.52
"BLD",4817,"KRN",8994,0)
8994
"BLD",4817,"KRN","B",.4,.4)

"BLD",4817,"KRN","B",.401,.401)

"BLD",4817,"KRN","B",.402,.402)

"BLD",4817,"KRN","B",.403,.403)

"BLD",4817,"KRN","B",.5,.5)

"BLD",4817,"KRN","B",.84,.84)

"BLD",4817,"KRN","B",3.6,3.6)

"BLD",4817,"KRN","B",3.8,3.8)

"BLD",4817,"KRN","B",9.2,9.2)

"BLD",4817,"KRN","B",9.8,9.8)

"BLD",4817,"KRN","B",19,19)

"BLD",4817,"KRN","B",19.1,19.1)

"BLD",4817,"KRN","B",101,101)

"BLD",4817,"KRN","B",409.61,409.61)

"BLD",4817,"KRN","B",771,771)

"BLD",4817,"KRN","B",870,870)

"BLD",4817,"KRN","B",8989.51,8989.51)

"BLD",4817,"KRN","B",8989.52,8989.52)

"BLD",4817,"KRN","B",8994,8994)

"BLD",4817,"QUES",0)
^9.62^^
"BLD",4817,"REQB",0)
^9.611^6^4
"BLD",4817,"REQB",3,0)
DG*5.3*415^1
"BLD",4817,"REQB",4,0)
DG*5.3*425^1
"BLD",4817,"REQB",5,0)
DG*5.3*149^1
"BLD",4817,"REQB",6,0)
DG*5.3*219^1
"BLD",4817,"REQB","B","DG*5.3*149",5)

"BLD",4817,"REQB","B","DG*5.3*219",6)

"BLD",4817,"REQB","B","DG*5.3*415",3)

"BLD",4817,"REQB","B","DG*5.3*425",4)

"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
530^3031120
"PKG",5,22,1,"PAH",1,1,0)
^^3^3^3031120
"PKG",5,22,1,"PAH",1,1,1,0)
THIS PATCH CORRECTS A LOCK PROBLEM WHEN MULTIPLE PATIENTS ARE EDITTED, 
"PKG",5,22,1,"PAH",1,1,2,0)
A NULL SUBSCRIPT ERROR REPORTED IN ROUTINE VAFHPURG, AND A PTF 
"PKG",5,22,1,"PAH",1,1,3,0)
TRANSMISSION PROBLEM WHICH FAILED TO INITIALIZE THE LINE COUNT VARIABLE.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","DGPTFTR")
0^3^B18741370
"RTN","DGPTFTR",1,0)
DGPTFTR ;ALB/JDS - TRANSMISSION OF PTF ; 01 DEC 87 @0800
"RTN","DGPTFTR",2,0)
 ;;5.3;Registration;**37,415,530**;Aug 13, 1993
"RTN","DGPTFTR",3,0)
 ;
"RTN","DGPTFTR",4,0)
ENN L ^DGP(45.83):5 I '$T W !,"Already transmitting" Q
"RTN","DGPTFTR",5,0)
 D CEN^DGPTUTL
"RTN","DGPTFTR",6,0)
 I '$D(DGRTY) S Y=1 D RTY^DGPTUTL
"RTN","DGPTFTR",7,0)
 D FDT^DGPTUTL S DGFMTDT=Y
"RTN","DGPTFTR",8,0)
 ;
"RTN","DGPTFTR",9,0)
EN5 K DIC S DIC=45.83,DIC(0)="AMZEQ",DIC("A")="Enter Start Date: "
"RTN","DGPTFTR",10,0)
 S DIC("S")="I $O(^DGP(45.83,+Y,""P"",0)) F DGX=0:0 S DGX=$O(^DGP(45.83,+Y,""P"",DGX)) Q:'DGX  I '$P(^DGP(45.83,+Y,""P"",DGX,0),U,2),$D(^DGPT(DGX,0)),$D(^(70)),+^(70)>2901000,$P(^(0),U,11)=+DGRTY Q"
"RTN","DGPTFTR",11,0)
 S D="ANT" D IX^DIC G ENQ1:X["^"!(X=""),EN5:Y'>0
"RTN","DGPTFTR",12,0)
 S DGSD=+Y(0),DIC(0)="EAMZQ",DIC("S")="I Y'<DGSD"_" "_DIC("S"),DIC("A")="Enter Through Date: TODAY//  ",D="ANT" D IX^DIC K DIC,D
"RTN","DGPTFTR",13,0)
 ;
"RTN","DGPTFTR",14,0)
 G ENQ1:X["^" S DGED=$S(Y>0:+Y(0),1:DT)
"RTN","DGPTFTR",15,0)
 ; -- 125 cols
"RTN","DGPTFTR",16,0)
 S VATNAME="PTF125" D ^VATRAN I VATERR K VATNAME,VATERR,VAT L  G ENQ
"RTN","DGPTFTR",17,0)
 S DGFMT=2 D SCAN G:DGOUTX ENQ1
"RTN","DGPTFTR",18,0)
ENQ D SCAN^DGPTFTR3
"RTN","DGPTFTR",19,0)
ENQ1 L  K DGACNT,DGXM,XMDUN,XMY,DGOUTX,DGSTCNT,DIC,DGX,DGRTY,DGRTY0,DGCN,DGCN0,DGPTFMT,DGFMT,DGFMTDT,DGLOGIC,VAT,VATERR,VATNAME,DGSD,DGED
"RTN","DGPTFTR",20,0)
 Q
"RTN","DGPTFTR",21,0)
 ;
"RTN","DGPTFTR",22,0)
SCAN K DGERR S DGPTFMT=2 D LOG S DGCNT=1,DGD=DGSD-.01,DGTR=0,DGID=1
"RTN","DGPTFTR",23,0)
 W !!,"Now transmitting 125 column ",$P(DGRTY0,U)," records..."
"RTN","DGPTFTR",24,0)
 W !,"Includes records of "
"RTN","DGPTFTR",25,0)
 ;
"RTN","DGPTFTR",26,0)
DAT D:DGCNT>1 XMIT S DGD=$O(^DGP(45.83,DGD))
"RTN","DGPTFTR",27,0)
 I DGD>0,DGD'>DGED D SETTRAN^DGPTUTL1 Q:DGOUTX
"RTN","DGPTFTR",28,0)
 I DGD'>0!(DGD>DGED) D BULL^DGPTFTR3 G DATQ
"RTN","DGPTFTR",29,0)
 S J=0 G PWR
"RTN","DGPTFTR",30,0)
DATQ Q
"RTN","DGPTFTR",31,0)
 ;
"RTN","DGPTFTR",32,0)
PWR S P=J,J=$O(^DGP(45.83,DGD,"P",J)) G DAT:J'>0,PWR:$P(^(J,0),U,2)
"RTN","DGPTFTR",33,0)
 I $D(^DGPT(J,0)),$P(^(0),U,11)'=+DGRTY G PWR
"RTN","DGPTFTR",34,0)
 I $P(DGCN0,U,3)>DT,DGRTY=1 D CEN^DGPTFTR3 G PWR:'Y
"RTN","DGPTFTR",35,0)
 S Y=$S($D(^DGPT(J,70)):+^(70),1:0) D FMT^DGPTUTL G PWR:DGPTFMT'=DGFMT
"RTN","DGPTFTR",36,0)
 S T1=0,T2=9999999,Y=J,X=0 S:DGRTY=2 T2=+DGCN0_".9",T1=+$P(DGCN0,U,5) D LINES^DGPTFVC2 I (DGCNT+X)>VAT("F") D  S J=P G XMIT
"RTN","DGPTFTR",37,0)
 .;OIFO BAY PINES;TEH;PATCH 530
"RTN","DGPTFTR",38,0)
 .I '$D(DGSTCNT("P",J)) S DGSTCNT("P",J)=DGCNT Q
"RTN","DGPTFTR",39,0)
 K DICR S DGERR=0,DGSTCNT("P",J)=DGCNT
"RTN","DGPTFTR",40,0)
 W !,$E($P(^DPT(+^DGPT(J,0),0),U),1,25),?27,"(#",J,")" S X=^DGPT(J,0) D WR^DGPTF
"RTN","DGPTFTR",41,0)
 K ^TMP("AEDIT",$J),^TMP("AERROR",$J) S DGACNT=0
"RTN","DGPTFTR",42,0)
 I DGRTY=1 D COM
"RTN","DGPTFTR",43,0)
 I DGRTY=2 S T2=+DGCN0_".9",T1=+$P(DGCN0,U,5),(PTF,DGCI)=J D COM1
"RTN","DGPTFTR",44,0)
 I DGERR D OPEN^DGPTFTR3
"RTN","DGPTFTR",45,0)
 K ^TMP("AEDIT",$J)
"RTN","DGPTFTR",46,0)
 I 'DGERR W ?70," Okay" S DGTR=DGTR+1 G XMIT:DGCNT>VAT("F")
"RTN","DGPTFTR",47,0)
 G PWR
"RTN","DGPTFTR",48,0)
 Q
"RTN","DGPTFTR",49,0)
 ;
"RTN","DGPTFTR",50,0)
XMIT K XMY D ROUTER
"RTN","DGPTFTR",51,0)
 S XMZ=DGXMZ,^XMB(3.9,XMZ,2,0)="^3.92A^"_(DGCNT-1)_"^"_(DGCNT-1)_"^"_DT,DGJ=J
"RTN","DGPTFTR",52,0)
 S XMDUZ=.5,XMDUN=$P(^VA(200,DUZ,0),U) D ENT1^XMD
"RTN","DGPTFTR",53,0)
 W !,"Transmission Queued" S DGIDN(DGID)=XMZ
"RTN","DGPTFTR",54,0)
 F DGK=0:0 S DGK=$O(DGSTCNT("P",DGK)) Q:DGK'>0  D REC
"RTN","DGPTFTR",55,0)
 K DGK S DGCNT=1,DGID=DGID+1,J=DGJ Q:J'>0  D SETTRAN^DGPTUTL1 G:'DGOUTX PWR
"RTN","DGPTFTR",56,0)
 Q
"RTN","DGPTFTR",57,0)
 ;
"RTN","DGPTFTR",58,0)
REC ;
"RTN","DGPTFTR",59,0)
 S DGSENFLG=""
"RTN","DGPTFTR",60,0)
 S DIE="^DGP(45.83,",DA=DGD,DR="10///"_DGK,DR(2,45.831)="1///TODAY;2///"_XMZ D ^DIE K DA,DR,DIE
"RTN","DGPTFTR",61,0)
 S DIE="^DGPT(",DR="6///3",DA=DGK D ^DIE K DA,DR,DIE
"RTN","DGPTFTR",62,0)
 K DGSENFLG
"RTN","DGPTFTR",63,0)
 Q
"RTN","DGPTFTR",64,0)
 ;
"RTN","DGPTFTR",65,0)
COM S T1=0,T2=9999999 S:'$D(PTF) PTF=J S:PTF'=J PTF=J
"RTN","DGPTFTR",66,0)
COM1 F K=0,70,101,"401P" S @("DG"_K)=$S($D(^DGPT(J,K)):^(K),1:"")
"RTN","DGPTFTR",67,0)
 F K=10,.11,.3,.32,.321,.52,57 S @("DG"_$S(K[".":$E(K,2,99),1:K))=$S($D(^DGP(45.84,J,K)):^(K),$D(^DPT(+^DGPT(J,0),$S(K'=10:K,1:0))):$S(K'=10:^(K),1:^(0)),1:"")
"RTN","DGPTFTR",68,0)
 F K=.02,.06 M @("DG"_$S(K[".":$E(K,2,99),1:K))=^DPT(+^DGPT(J,0),K)
"RTN","DGPTFTR",69,0)
 D ^DGPTFTR0:DGPTFMT=1,^DGPTR0:DGPTFMT=2
"RTN","DGPTFTR",70,0)
 ;
"RTN","DGPTFTR",71,0)
Q L  F K=0,10,701,"401P",101,11,3,32,41,52,57,70,321,502,702,"02","06" K @("DG"_K)
"RTN","DGPTFTR",72,0)
 K DGCDR,DGT,DIC,DGADM,DGAO,DGDOB,DGHEAD,DGJ,DGK,DGL,DGM,DGNAM,DGNT,DGO,DGSSN,DGSUD,DGSUR,DGTD,DGX,DGXLS,E,ERR,F,G,H,I,K,L,T,W,Z,DGPROC,DGPROCD ;** NOTE: do not kill variables needed by PTF load/edit option!!!
"RTN","DGPTFTR",73,0)
 I $D(DGERR),DGERR<1 D ^DGPTFVC1 D:'T1 ^DGPTFVC3
"RTN","DGPTFTR",74,0)
 I $D(DGERR),DGERR<1 D EN^DGPTFVC2
"RTN","DGPTFTR",75,0)
 Q
"RTN","DGPTFTR",76,0)
 ;
"RTN","DGPTFTR",77,0)
LOG ;called from PRINT+1^DGPTF2,CLS+1^DGPTF2,EN^DGPTFVC
"RTN","DGPTFTR",78,0)
 D LOG^DGPTFTR1:DGPTFMT=1,LOG^DGPTR1:DGPTFMT=2,COM:$D(DGERR)
"RTN","DGPTFTR",79,0)
 Q
"RTN","DGPTFTR",80,0)
 ;
"RTN","DGPTFTR",81,0)
 ;-- check for real queue if census should be removed for national rel
"RTN","DGPTFTR",82,0)
ROUTER S XMDUZ=.5 F DGSDI=0:0 S DGSDI=$O(VAT(DGSDI)) Q:'DGSDI  S X=VAT(DGSDI),XMN=0,XMDF="" D INST^XMA21 K XMN,XMDF
"RTN","DGPTFTR",83,0)
 S XMY(DUZ)=""
"RTN","DGPTFTR",84,0)
 Q
"RTN","VAFCMSG")
0^2^B15865055
"RTN","VAFCMSG",1,0)
VAFCMSG ;ALB/JRP-BACKGROUND JOB TO TRANSMIT ENTRIES IN PIVOT FILE ; 11/20/03 12:54pm
"RTN","VAFCMSG",2,0)
 ;;5.3;Registration;**91,149,530**;Jun 06, 1996
"RTN","VAFCMSG",3,0)
 ;
"RTN","VAFCMSG",4,0)
MAIN ;Main entry point for background job
"RTN","VAFCMSG",5,0)
 ;
"RTN","VAFCMSG",6,0)
 ;attempt to lock non existant global.
"RTN","VAFCMSG",7,0)
 L +^VAT(391.71,"VAFC BATCH UPDATE ADT/HL7"):1 I '$T Q
"RTN","VAFCMSG",8,0)
 ;Send messages ? 0=STOP,2=SUSPEND
"RTN","VAFCMSG",9,0)
 N SEND
"RTN","VAFCMSG",10,0)
 S SEND=$P($$SEND^VAFHUTL(),"^",2)
"RTN","VAFCMSG",11,0)
 I (SEND=0)!(SEND=2) L -^VAT(391.71,"VAFC BATCH UPDATE ADT/HL7") Q
"RTN","VAFCMSG",12,0)
 ;Send Registration messages
"RTN","VAFCMSG",13,0)
 D BCSTA04
"RTN","VAFCMSG",14,0)
 ;Send changes to patient's demographical data (ADT-A08)
"RTN","VAFCMSG",15,0)
 D BCSTA08
"RTN","VAFCMSG",16,0)
 ;Send changes to patient's treating facility list (MFU-M05)
"RTN","VAFCMSG",17,0)
 D BCKTFMFU^VAFCTFMF
"RTN","VAFCMSG",18,0)
 ;unlock global
"RTN","VAFCMSG",19,0)
 L -^VAT(391.71,"VAFC BATCH UPDATE ADT/HL7")
"RTN","VAFCMSG",20,0)
 ;K DIC,X,Y
"RTN","VAFCMSG",21,0)
 Q
"RTN","VAFCMSG",22,0)
 ;
"RTN","VAFCMSG",23,0)
BCSTA08 ;Broadcast ADT-A08 messages for all entries in ADT/HL PIVOT file
"RTN","VAFCMSG",24,0)
 ;(#391.71) that have been marked for transmission
"RTN","VAFCMSG",25,0)
 ;
"RTN","VAFCMSG",26,0)
 ;Input  : None
"RTN","VAFCMSG",27,0)
 ;Output : None
"RTN","VAFCMSG",28,0)
 ;
"RTN","VAFCMSG",29,0)
 ;Declare variables
"RTN","VAFCMSG",30,0)
 N PIVOTPTR,NODE,DFN,EDITDATE,TMP,INFOARR
"RTN","VAFCMSG",31,0)
 S INFOARR="^TMP(""VAFCMSG"","_$J_",""EVNTINFO"")"
"RTN","VAFCMSG",32,0)
 K @INFOARR
"RTN","VAFCMSG",33,0)
 ;Loop through pivot file based on demographic updates
"RTN","VAFCMSG",34,0)
 S PIVOTPTR=0
"RTN","VAFCMSG",35,0)
 F  S PIVOTPTR=+$O(^VAT(391.71,"AXMIT",4,PIVOTPTR)) Q:('PIVOTPTR)  D
"RTN","VAFCMSG",36,0)
 .;Bad entry in cross reference - delete it and quit
"RTN","VAFCMSG",37,0)
 .I ('$D(^VAT(391.71,PIVOTPTR))) K ^VAT(391.71,"AXMIT",4,PIVOTPTR) Q
"RTN","VAFCMSG",38,0)
 .;Get event date and pointer to patient
"RTN","VAFCMSG",39,0)
 .S NODE=$G(^VAT(391.71,PIVOTPTR,0))
"RTN","VAFCMSG",40,0)
 .S EDITDATE=+NODE
"RTN","VAFCMSG",41,0)
 .S DFN=+$P(NODE,"^",3)
"RTN","VAFCMSG",42,0)
 .;PATCH 530 check global for lock status - quit if locked.
"RTN","VAFCMSG",43,0)
 .L +^DPT(DFN):1 I '$T Q
"RTN","VAFCMSG",44,0)
 .;Bad pointer to patient - mark entry as transmitted and quit
"RTN","VAFCMSG",45,0)
 .I ('$D(^DPT(DFN,0)))!($G(^DPT(DFN,-9))) D XMITFLAG^VAFCDD01(PIVOTPTR,"",1) Q
"RTN","VAFCMSG",46,0)
 .;Store info into event information array
"RTN","VAFCMSG",47,0)
 .K @INFOARR
"RTN","VAFCMSG",48,0)
 .S @INFOARR@("PIVOT")=PIVOTPTR
"RTN","VAFCMSG",49,0)
 .;Event reason code
"RTN","VAFCMSG",50,0)
 .;  99 = Death     98 = Resurrection   97=Sensitivity Update
"RTN","VAFCMSG",51,0)
 .;  Death will overwrite any other reason code. It is the 
"RTN","VAFCMSG",52,0)
 .;  dominant reason code.
"RTN","VAFCMSG",53,0)
 .S @INFOARR@("REASON",1)=""
"RTN","VAFCMSG",54,0)
 .S @INFOARR@("REASON",1)=$P($G(^VAT(391.71,PIVOTPTR,0)),"^",10)
"RTN","VAFCMSG",55,0)
 .I (+$G(^DPT(DFN,.35))) S @INFOARR@("REASON",1)=99
"RTN","VAFCMSG",56,0)
 .;
"RTN","VAFCMSG",57,0)
 .; user/operator name from duz
"RTN","VAFCMSG",58,0)
 .S DIC="^VA(200,",DIC(0)="MZO",X="`"_+$P(NODE,"^",9) D ^DIC
"RTN","VAFCMSG",59,0)
 .S @INFOARR@("USER")=$P($G(Y),"^",2)
"RTN","VAFCMSG",60,0)
 .;
"RTN","VAFCMSG",61,0)
 .S @INFOARR@("EVENT-NUM")=$P(NODE,"^",2)
"RTN","VAFCMSG",62,0)
 .S @INFOARR@("VAR-PTR")=$P(NODE,"^",5)
"RTN","VAFCMSG",63,0)
 .;
"RTN","VAFCMSG",64,0)
 .;Broadcast ADT-A08 message
"RTN","VAFCMSG",65,0)
 .S TMP=$$BCSTADT^VAFCMSG0(DFN,"A08",EDITDATE,INFOARR)
"RTN","VAFCMSG",66,0)
 .;Store result in pivot file
"RTN","VAFCMSG",67,0)
 .S:$P(TMP,U,2)]"" TMP=$P(TMP,U,2) D FILERM^VAFCUTL(PIVOTPTR,TMP)
"RTN","VAFCMSG",68,0)
 .;Error broadcasting message
"RTN","VAFCMSG",69,0)
 .Q:(TMP<0)
"RTN","VAFCMSG",70,0)
 .;Mark entry in pivot file as transmitted
"RTN","VAFCMSG",71,0)
 .D XMITFLAG^VAFCDD01(PIVOTPTR,"",1)
"RTN","VAFCMSG",72,0)
 .;PATCH 530 if locked by check unlock.
"RTN","VAFCMSG",73,0)
 .L -^DPT(DFN)
"RTN","VAFCMSG",74,0)
 ;Done - clean up and quit
"RTN","VAFCMSG",75,0)
 K @INFOARR
"RTN","VAFCMSG",76,0)
 Q
"RTN","VAFCMSG",77,0)
 ;
"RTN","VAFCMSG",78,0)
BCSTA04 ;Broadcast ADT-A04 messages for all entries in ADT/HL PIVOT file
"RTN","VAFCMSG",79,0)
 ;(#391.71) that have been marked for transmission
"RTN","VAFCMSG",80,0)
 ;
"RTN","VAFCMSG",81,0)
 ;Input  : None
"RTN","VAFCMSG",82,0)
 ;Output : None
"RTN","VAFCMSG",83,0)
 ;
"RTN","VAFCMSG",84,0)
 ;Declare variables
"RTN","VAFCMSG",85,0)
 N PIVOTPTR,NODE,DFN,EDITDATE,FIELDS,RESULT
"RTN","VAFCMSG",86,0)
 S PIVOTPTR=0
"RTN","VAFCMSG",87,0)
 F  S PIVOTPTR=+$O(^VAT(391.71,"AXMIT",3,PIVOTPTR)) Q:('PIVOTPTR)  D
"RTN","VAFCMSG",88,0)
 .;Bad entry in cross reference - delete it and quit
"RTN","VAFCMSG",89,0)
 .I ('$D(^VAT(391.71,PIVOTPTR))) K ^VAT(391.71,"AXMIT",3,PIVOTPTR) Q
"RTN","VAFCMSG",90,0)
 .;Get event date and pointer to patient
"RTN","VAFCMSG",91,0)
 .S NODE=$G(^VAT(391.71,PIVOTPTR,0))
"RTN","VAFCMSG",92,0)
 .S FIELDS=$G(^VAT(391.71,PIVOTPTR,2))
"RTN","VAFCMSG",93,0)
 .S USER=+$P(NODE,"^",9)
"RTN","VAFCMSG",94,0)
 .S EDITDATE=+NODE
"RTN","VAFCMSG",95,0)
 .S DFN=+$P(NODE,"^",3)
"RTN","VAFCMSG",96,0)
 .;PATCH 530 check for locked record - quit if locked.
"RTN","VAFCMSG",97,0)
 .L +^DPT(DFN):1 I '$T Q
"RTN","VAFCMSG",98,0)
 .;Bad pointer to patient - mark entry as transmitted and quit
"RTN","VAFCMSG",99,0)
 .I ('$D(^DPT(DFN,0)))!($G(^DPT(DFN,-9))) D XMITFLAG^VAFCDD01(PIVOTPTR,"",1) Q
"RTN","VAFCMSG",100,0)
 .;Broadcast ADT-A04 message
"RTN","VAFCMSG",101,0)
 .S RESULT=$$EN^VAFCA04(DFN,EDITDATE,USER,PIVOTPTR)
"RTN","VAFCMSG",102,0)
 .D XMITFLAG^VAFCDD01(PIVOTPTR,"",1)
"RTN","VAFCMSG",103,0)
 .L -^DPT(DFN)
"RTN","VAFCMSG",104,0)
 ;Done - quit
"RTN","VAFCMSG",105,0)
 Q
"RTN","VAFHPURG")
0^1^B7822443
"RTN","VAFHPURG",1,0)
VAFHPURG ;ALB/JLU;Purging routine.
"RTN","VAFHPURG",2,0)
 ;;5.3;Registration;**91,219,530**;Jun 06, 1996
"RTN","VAFHPURG",3,0)
 ;
"RTN","VAFHPURG",4,0)
 ;This routine will delete all entries from the ADT/HL7 PIVOT
"RTN","VAFHPURG",5,0)
 ;(#391.71) file that are older than number of days specified
"RTN","VAFHPURG",6,0)
 ;in field #391.702 of file #43.
"RTN","VAFHPURG",7,0)
 ;
"RTN","VAFHPURG",8,0)
EN ;entry point
"RTN","VAFHPURG",9,0)
 N DA,DIC,DIQ,DR,VAR1,VARA,DAYS,X1,X2
"RTN","VAFHPURG",10,0)
 ;find number of days worth of file entries to be retained
"RTN","VAFHPURG",11,0)
 S VAR1=$O(^DG(43,0))
"RTN","VAFHPURG",12,0)
 S DIC="^DG(43,",DA=VAR1,DIQ="VARA",DIQ(0)="I",DR="391.702;"
"RTN","VAFHPURG",13,0)
 D EN^DIQ1
"RTN","VAFHPURG",14,0)
 ;use 547 days (18 months) unless otherwise specified
"RTN","VAFHPURG",15,0)
 S DAYS=VARA(43,VAR1,391.702,"I") S:+DAYS=0 DAYS=547
"RTN","VAFHPURG",16,0)
 D DT^DICRW
"RTN","VAFHPURG",17,0)
 S X1=DT
"RTN","VAFHPURG",18,0)
 S X2=-DAYS
"RTN","VAFHPURG",19,0)
 D C^%DTC
"RTN","VAFHPURG",20,0)
 S (Y,VAFHEDT)=X
"RTN","VAFHPURG",21,0)
 D DD^%DT
"RTN","VAFHPURG",22,0)
 W:'$D(ZTQUEUED) !!,"All ADT/HL7 PIVOT entries older than ",Y," will be deleted!",!
"RTN","VAFHPURG",23,0)
 D KIL1
"RTN","VAFHPURG",24,0)
 ;iofo-bay pines;vmp;teh; modification to quit logical to prevent null subscript.
"RTN","VAFHPURG",25,0)
 F VAFHX=0:0 S VAFHX=$O(^VAT(391.71,"B",VAFHX)) Q:VAFHX>VAFHEDT!(VAFHX="")  D DELETE
"RTN","VAFHPURG",26,0)
 D EXIT
"RTN","VAFHPURG",27,0)
 ;D CLEAN
"RTN","VAFHPURG",28,0)
 ;D EXIT
"RTN","VAFHPURG",29,0)
 Q
"RTN","VAFHPURG",30,0)
 ;
"RTN","VAFHPURG",31,0)
DELETE ;this will do that actual deletion.
"RTN","VAFHPURG",32,0)
 ;
"RTN","VAFHPURG",33,0)
 N DA,DIK,EVENT,MOVE,OUT
"RTN","VAFHPURG",34,0)
 S DA=0
"RTN","VAFHPURG",35,0)
 F  S DA=+$O(^VAT(391.71,"B",VAFHX,DA)) Q:('DA)  D
"RTN","VAFHPURG",36,0)
 .;don't delete inpatient event records before discharge
"RTN","VAFHPURG",37,0)
 .S EVENT=+$P(^VAT(391.71,DA,0),U,4)
"RTN","VAFHPURG",38,0)
 .I EVENT=1 D  Q:OUT
"RTN","VAFHPURG",39,0)
 ..S OUT=0
"RTN","VAFHPURG",40,0)
 ..S MOVE=$P(^VAT(391.71,DA,0),U,5)
"RTN","VAFHPURG",41,0)
 ..Q:MOVE'["DGPM"
"RTN","VAFHPURG",42,0)
 ..I $P($G(^DGPM(+MOVE,0)),U,17)="" S OUT=1
"RTN","VAFHPURG",43,0)
 .;don't delete if requires transmission
"RTN","VAFHPURG",44,0)
 .Q:$D(^VAT(391.71,"AXMIT",EVENT,DA))
"RTN","VAFHPURG",45,0)
 .;delete
"RTN","VAFHPURG",46,0)
 .S DIK="^VAT(391.71,"
"RTN","VAFHPURG",47,0)
 .D ^DIK
"RTN","VAFHPURG",48,0)
 .W:'$D(ZTQUEUED) "."
"RTN","VAFHPURG",49,0)
 Q
"RTN","VAFHPURG",50,0)
 ;
"RTN","VAFHPURG",51,0)
EXIT ;kills variables
"RTN","VAFHPURG",52,0)
 K VAFHX,VAFHEDT,X,Y
"RTN","VAFHPURG",53,0)
 Q
"RTN","VAFHPURG",54,0)
 ;
"RTN","VAFHPURG",55,0)
KIL1 K X,Y,%DT
"RTN","VAFHPURG",56,0)
 Q
"RTN","VAFHPURG",57,0)
 ;
"RTN","VAFHPURG",58,0)
CLEAN ; delete entries with invalid event pointer, ie doesn't exist 
"RTN","VAFHPURG",59,0)
 ; CLEAN^VAFHPURG may be run directly from programmer mode
"RTN","VAFHPURG",60,0)
 ;
"RTN","VAFHPURG",61,0)
 I '$D(ZTQUEUED) W !!,"All ADT/HL7 PIVOT entries with invalid EVENT POINTERS will be deleted",!
"RTN","VAFHPURG",62,0)
 D DT^DICRW
"RTN","VAFHPURG",63,0)
 N EVENTVP,GLOBAL,GLOBALR,NODE
"RTN","VAFHPURG",64,0)
 S VAFHX=0
"RTN","VAFHPURG",65,0)
 F  S VAFHX=$O(^VAT(391.71,VAFHX)) Q:'VAFHX  S NODE=$G(^(VAFHX,0)) DO
"RTN","VAFHPURG",66,0)
 .;  if no .01 date/time 
"RTN","VAFHPURG",67,0)
 . I 'NODE D REMOVE Q
"RTN","VAFHPURG",68,0)
 . S EVENTVP=$P(NODE,"^",5)
"RTN","VAFHPURG",69,0)
 .;  if event pointer has no pointer
"RTN","VAFHPURG",70,0)
 . I 'EVENTVP D REMOVE Q
"RTN","VAFHPURG",71,0)
 . S GLOBAL=$P(EVENTVP,";",2)
"RTN","VAFHPURG",72,0)
 .;  if event pointer has no variable
"RTN","VAFHPURG",73,0)
 . I GLOBAL="" D REMOVE Q
"RTN","VAFHPURG",74,0)
 .;  if variable not distributed
"RTN","VAFHPURG",75,0)
 . I "DPT(DGPM(SCE("'[GLOBAL D REMOVE Q
"RTN","VAFHPURG",76,0)
 . S GLOBALR="^"_GLOBAL_+EVENTVP_")"
"RTN","VAFHPURG",77,0)
 .;
"RTN","VAFHPURG",78,0)
 . I $D(@GLOBALR) Q
"RTN","VAFHPURG",79,0)
 .;  if no pointed to eentr delete this oney 
"RTN","VAFHPURG",80,0)
 . D REMOVE Q
"RTN","VAFHPURG",81,0)
 Q
"RTN","VAFHPURG",82,0)
 ;
"RTN","VAFHPURG",83,0)
 ;either the pointed to entry doesn't exist or the VP entry is invalid
"RTN","VAFHPURG",84,0)
 ;so delete it
"RTN","VAFHPURG",85,0)
REMOVE S DA=VAFHX
"RTN","VAFHPURG",86,0)
 S DIK="^VAT(391.71,"
"RTN","VAFHPURG",87,0)
 D ^DIK
"RTN","VAFHPURG",88,0)
 I '$D(ZTQUEUED) W ","
"RTN","VAFHPURG",89,0)
 K DIK,DA
"RTN","VAFHPURG",90,0)
 Q
"VER")
8.0^22
**END**
**END**
