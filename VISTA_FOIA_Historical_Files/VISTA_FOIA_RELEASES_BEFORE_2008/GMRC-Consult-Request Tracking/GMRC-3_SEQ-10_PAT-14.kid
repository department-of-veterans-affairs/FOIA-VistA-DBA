Released GMRC*3*14 SEQ #10
Extracted from mail message
**KIDS**:GMRC*3.0*14^

**INSTALL NAME**
GMRC*3.0*14
"BLD",2040,0)
GMRC*3.0*14^CONSULT/REQUEST TRACKING^0^3000130^y
"BLD",2040,1,0)
^^1^1^3000127^
"BLD",2040,1,1,0)
See National Patch Module for complete details of enhancements.
"BLD",2040,4,0)
^9.64PA^^
"BLD",2040,"ABPKG")
n
"BLD",2040,"KRN",0)
^9.67PA^19^18
"BLD",2040,"KRN",.4,0)
.4
"BLD",2040,"KRN",.401,0)
.401
"BLD",2040,"KRN",.402,0)
.402
"BLD",2040,"KRN",.403,0)
.403
"BLD",2040,"KRN",.5,0)
.5
"BLD",2040,"KRN",.84,0)
.84
"BLD",2040,"KRN",3.6,0)
3.6
"BLD",2040,"KRN",3.8,0)
3.8
"BLD",2040,"KRN",9.2,0)
9.2
"BLD",2040,"KRN",9.8,0)
9.8
"BLD",2040,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",2040,"KRN",9.8,"NM",1,0)
GMRCSPD^^0^B2365789
"BLD",2040,"KRN",9.8,"NM",2,0)
GMRCSLM^^0^B34407521
"BLD",2040,"KRN",9.8,"NM",3,0)
GMRCASF^^0^B11953606
"BLD",2040,"KRN",9.8,"NM",4,0)
GMRCACMT^^0^B21830196
"BLD",2040,"KRN",9.8,"NM",5,0)
GMRCTIUE^^0^B32513033
"BLD",2040,"KRN",9.8,"NM",6,0)
GMRCTIUL^^0^B15878994
"BLD",2040,"KRN",9.8,"NM",7,0)
GMRCAU^^0^B51274084
"BLD",2040,"KRN",9.8,"NM","B","GMRCACMT",4)

"BLD",2040,"KRN",9.8,"NM","B","GMRCASF",3)

"BLD",2040,"KRN",9.8,"NM","B","GMRCAU",7)

"BLD",2040,"KRN",9.8,"NM","B","GMRCSLM",2)

"BLD",2040,"KRN",9.8,"NM","B","GMRCSPD",1)

"BLD",2040,"KRN",9.8,"NM","B","GMRCTIUE",5)

"BLD",2040,"KRN",9.8,"NM","B","GMRCTIUL",6)

"BLD",2040,"KRN",19,0)
19
"BLD",2040,"KRN",19,"NM",0)
^9.68A^^
"BLD",2040,"KRN",19.1,0)
19.1
"BLD",2040,"KRN",101,0)
101
"BLD",2040,"KRN",409.61,0)
409.61
"BLD",2040,"KRN",771,0)
771
"BLD",2040,"KRN",869.2,0)
869.2
"BLD",2040,"KRN",870,0)
870
"BLD",2040,"KRN",8994,0)
8994
"BLD",2040,"KRN","B",.4,.4)

"BLD",2040,"KRN","B",.401,.401)

"BLD",2040,"KRN","B",.402,.402)

"BLD",2040,"KRN","B",.403,.403)

"BLD",2040,"KRN","B",.5,.5)

"BLD",2040,"KRN","B",.84,.84)

"BLD",2040,"KRN","B",3.6,3.6)

"BLD",2040,"KRN","B",3.8,3.8)

"BLD",2040,"KRN","B",9.2,9.2)

"BLD",2040,"KRN","B",9.8,9.8)

"BLD",2040,"KRN","B",19,19)

"BLD",2040,"KRN","B",19.1,19.1)

"BLD",2040,"KRN","B",101,101)

"BLD",2040,"KRN","B",409.61,409.61)

"BLD",2040,"KRN","B",771,771)

"BLD",2040,"KRN","B",869.2,869.2)

"BLD",2040,"KRN","B",870,870)

"BLD",2040,"KRN","B",8994,8994)

"BLD",2040,"QUES",0)
^9.62^^
"BLD",2040,"REQB",0)
^9.611^4^4
"BLD",2040,"REQB",1,0)
GMRC*3.0*1^2
"BLD",2040,"REQB",2,0)
GMRC*3.0*4^2
"BLD",2040,"REQB",3,0)
GMRC*3.0*10^2
"BLD",2040,"REQB",4,0)
GMRC*3.0*11^2
"BLD",2040,"REQB","B","GMRC*3.0*1",1)

"BLD",2040,"REQB","B","GMRC*3.0*10",3)

"BLD",2040,"REQB","B","GMRC*3.0*11",4)

"BLD",2040,"REQB","B","GMRC*3.0*4",2)

"MBREQ")
0
"PKG",128,-1)
1^1
"PKG",128,0)
CONSULT/REQUEST TRACKING^GMRC^CONSULTS/REQUESTS
"PKG",128,20,0)
^9.402P^^
"PKG",128,22,0)
^9.49I^1^1
"PKG",128,22,1,0)
3.0^2980101
"PKG",128,22,1,"PAH",1,0)
14^3000130
"PKG",128,22,1,"PAH",1,1,0)
^^1^1^3000130
"PKG",128,22,1,"PAH",1,1,1,0)
See National Patch Module for complete details of enhancements.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","GMRCACMT")
0^4^B21830196
"RTN","GMRCACMT",1,0)
GMRCACMT ;SLC/DLT,DCM - Comment Action and alerting ;6/2/98  12:12
"RTN","GMRCACMT",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,14**;DEC 27, 1997
"RTN","GMRCACMT",3,0)
COMMENT(GMRCO) ;Add a comment without changing the status
"RTN","GMRCACMT",4,0)
 K GMRCQIT,GMRCQUT N GMRCA
"RTN","GMRCACMT",5,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCACMT",6,0)
 S GMRCNOW=$$NOW^XLFDT,GMRCAD=GMRCNOW
"RTN","GMRCACMT",7,0)
 S GMRCOM=1,GMRCA=20,GMRCPROV=$P(^GMR(123,GMRCO,0),"^",14) D AUDIT^GMRCP
"RTN","GMRCACMT",8,0)
 ;GMRCOM=1 defined the variable and tells AUDIT^GMRCP that the word-processing logic should be executed. If an actual comment is added, $P(GMRCOM,"^",2)=1 (send alert), if not GMRCOM=1 and no '^' exists (do not send alert)
"RTN","GMRCACMT",9,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCACMT",10,0)
 ;continue if no lock problems occurred
"RTN","GMRCACMT",11,0)
 I $P(GMRCOM,"^",2) D PROCALRT("",1,20,GMRCO)
"RTN","GMRCACMT",12,0)
 D END
"RTN","GMRCACMT",13,0)
 Q
"RTN","GMRCACMT",14,0)
 ;
"RTN","GMRCACMT",15,0)
PROCALRT(GMRCORTX,GMRCDELR,ACTION,GMRCO) ;Process alert for comments
"RTN","GMRCACMT",16,0)
 ;If GMRCDELR=1, the ordering provider can be deleted from the list.
"RTN","GMRCACMT",17,0)
 N GMRCADUZ,GMRCANS,NOTIF,GMRCQIT
"RTN","GMRCACMT",18,0)
 S GMRCANS=$$READ("Y","Do You Wish To Send An Alert With This Comment","N","Enter Y to continue with recipient prompts. Otherwise, enter N.",1)
"RTN","GMRCACMT",19,0)
 I (GMRCANS[U)!(GMRCANS=0) D END Q
"RTN","GMRCACMT",20,0)
 ;
"RTN","GMRCACMT",21,0)
 D WHOTO
"RTN","GMRCACMT",22,0)
 I $G(GMRCQIT) D END Q  ;User "^" at requesting provider.
"RTN","GMRCACMT",23,0)
 S NOTIF=$S(ACTION=20:27,1:23)
"RTN","GMRCACMT",24,0)
 ; Use NEW SERVICE CONSULT/REQUEST (27) for the ADD COMMENT action to
"RTN","GMRCACMT",25,0)
 ;     prevent the forced PAO entries that occur with the
"RTN","GMRCACMT",26,0)
 ;     CONSULT/REQUEST RESOLUTION (23) notification.
"RTN","GMRCACMT",27,0)
 D SENDMSG(NOTIF,+GMRCO)
"RTN","GMRCACMT",28,0)
 Q
"RTN","GMRCACMT",29,0)
 ;
"RTN","GMRCACMT",30,0)
SENDMSG(NOTIF,GMRCO) ;Send the alert
"RTN","GMRCACMT",31,0)
 N GMRCDFN
"RTN","GMRCACMT",32,0)
 I '$D(GMRCADUZ) S GMRCADUZ=""
"RTN","GMRCACMT",33,0)
 W !,"Processing Alerts..."
"RTN","GMRCACMT",34,0)
 S GMRCDFN=$P($G(^GMR(123,+GMRCO,0)),"^",2)
"RTN","GMRCACMT",35,0)
 S GMRCORTX=$S($L(GMRCORTX):GMRCORTX,1:"Comment Added to Consult ")_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCACMT",36,0)
 D MSG^GMRCP(GMRCDFN,GMRCORTX,+GMRCO,NOTIF,.GMRCADUZ,0)
"RTN","GMRCACMT",37,0)
 Q
"RTN","GMRCACMT",38,0)
 ;
"RTN","GMRCACMT",39,0)
END ;kill off variables and exit
"RTN","GMRCACMT",40,0)
 K GMRC,GMRCA,GMRCMSG,GMRCOM,GMRCO,GMRCORTX,GMRCERR,GMRCERMS,GMRCQUT,GMRCUT
"RTN","GMRCACMT",41,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCACMT",42,0)
 K DTOUT,DIROUT,DUOUT,DIRUT
"RTN","GMRCACMT",43,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCACMT",44,0)
 Q
"RTN","GMRCACMT",45,0)
 ;
"RTN","GMRCACMT",46,0)
WHOTO ;Get the users who should receive an alert
"RTN","GMRCACMT",47,0)
 ;Asks about requesting provider first, then prompts for additional users
"RTN","GMRCACMT",48,0)
 ;Returns GMRCADUZ array of users to send an alert to and GMRCQIT if "^"
"RTN","GMRCACMT",49,0)
 N GMRCRP,GMRCANS
"RTN","GMRCACMT",50,0)
 S GMRCRP=$P($G(^GMR(123,+GMRCO,0)),U,14) ;requesting provider entry
"RTN","GMRCACMT",51,0)
 I +GMRCRP S GMRCRP=$P($G(^VA(200,+GMRCRP,0)),U,1) ;provider name
"RTN","GMRCACMT",52,0)
 ;GMRCRP is now the requestor name or null
"RTN","GMRCACMT",53,0)
 I $L(GMRCRP) D  I GMRCANS[U S GMRCQIT=1 Q
"RTN","GMRCACMT",54,0)
 . S GMRCANS=$$READ("Y","Send Alert To Requesting Provider "_GMRCRP,"N","Enter Y to send an alert to the ordering provider, otherwise enter N.",1)
"RTN","GMRCACMT",55,0)
 . S:GMRCANS=1 GMRCADUZ($P(^GMR(123,+GMRCO,0),"^",14))=""
"RTN","GMRCACMT",56,0)
 . Q
"RTN","GMRCACMT",57,0)
 ;
"RTN","GMRCACMT",58,0)
ANDTO ;Ask for additional recipients
"RTN","GMRCACMT",59,0)
 D NAMELIST("Send Alert to: ",.GMRCADUZ,GMRCDELR)
"RTN","GMRCACMT",60,0)
 Q
"RTN","GMRCACMT",61,0)
 ;
"RTN","GMRCACMT",62,0)
NAMELIST(GMRCP,GMRCOLD,GMRCDELR) ;manage the list of recipients
"RTN","GMRCACMT",63,0)
 ;
"RTN","GMRCACMT",64,0)
 ; GMRCP - Prompt
"RTN","GMRCACMT",65,0)
 ; GMRCOLD - Original list with ordering provider.
"RTN","GMRCACMT",66,0)
 ; GMRCDELR - 1 means the original list may have names deleted
"RTN","GMRCACMT",67,0)
 ; Returns final list in GMRCOLD array
"RTN","GMRCACMT",68,0)
 ;
"RTN","GMRCACMT",69,0)
 N GMRCNEW,GMRCNT,GMRCDUZ,GMRCUSER,GMRCQ,GMRCADD,DIC,X,Y
"RTN","GMRCACMT",70,0)
 ;
"RTN","GMRCACMT",71,0)
 M GMRCNEW=GMRCOLD
"RTN","GMRCACMT",72,0)
 I GMRCDELR=1 K GMRCOLD S GMRCOLD="" ;Remove mandatory users from GMRCOLD
"RTN","GMRCACMT",73,0)
 S GMRCNT=0 F  D  Q:(GMRCUSER[U)
"RTN","GMRCACMT",74,0)
 .S GMRCUSER=$$READ("FAO;3;46",$S(GMRCNT:"And ",1:"")_GMRCP,"","^D NAMEHELP^GMRCACMT")
"RTN","GMRCACMT",75,0)
 .S:'$L(GMRCUSER) GMRCUSER=U Q:(GMRCUSER[U)
"RTN","GMRCACMT",76,0)
 .I ($E(GMRCUSER,1)="-") S GMRCADD=0,GMRCUSER=$E(GMRCUSER,2,$L(GMRCUSER))
"RTN","GMRCACMT",77,0)
 .E  S GMRCADD=1
"RTN","GMRCACMT",78,0)
 .;
"RTN","GMRCACMT",79,0)
 .S X=GMRCUSER,DIC=200,DIC(0)="EMQ" D ^DIC
"RTN","GMRCACMT",80,0)
 .;
"RTN","GMRCACMT",81,0)
 .I (Y>0) D  I 1
"RTN","GMRCACMT",82,0)
 ..;W $E($P(Y,U,2),$L(GMRCUSER)+1,$L($P(Y,U,2)))
"RTN","GMRCACMT",83,0)
 ..;
"RTN","GMRCACMT",84,0)
 ..I GMRCADD D
"RTN","GMRCACMT",85,0)
 ...I $D(GMRCNEW(+Y)) W " already in the list." Q
"RTN","GMRCACMT",86,0)
 ...S GMRCNEW(+Y)="" W " added to the list." S GMRCNT=GMRCNT+1
"RTN","GMRCACMT",87,0)
 ..;
"RTN","GMRCACMT",88,0)
 ..I 'GMRCADD D
"RTN","GMRCACMT",89,0)
 ...I $D(GMRCOLD(+Y)) W " can't delete this name from the list." Q
"RTN","GMRCACMT",90,0)
 ...I '$D(GMRCNEW(+Y)) W " not currently in the list." Q
"RTN","GMRCACMT",91,0)
 ...K GMRCNEW(+Y) S GMRCNT=GMRCNT-1 W " deleted from the list."
"RTN","GMRCACMT",92,0)
 .;
"RTN","GMRCACMT",93,0)
 .E  I $L(GMRCUSER) W "  Name not found."
"RTN","GMRCACMT",94,0)
 ;
"RTN","GMRCACMT",95,0)
 M GMRCOLD=GMRCNEW
"RTN","GMRCACMT",96,0)
 Q
"RTN","GMRCACMT",97,0)
 ;
"RTN","GMRCACMT",98,0)
READ(GMRC0,GMRCA,GMRCB,GMRCH,GMRCL) ;read logic
"RTN","GMRCACMT",99,0)
 ;
"RTN","GMRCACMT",100,0)
 ;  GMRC0 -> DIR(0) --- Type of read
"RTN","GMRCACMT",101,0)
 ;  GMRCA -> DIR("A") - Prompt
"RTN","GMRCACMT",102,0)
 ;  GMRCB -> DIR("B") - Default Answer
"RTN","GMRCACMT",103,0)
 ;  GMRCH -> DIR("?") - Help text or ^Execute code
"RTN","GMRCACMT",104,0)
 ;  GMRCL -> Number of blank lines to put before Prompt
"RTN","GMRCACMT",105,0)
 ;
"RTN","GMRCACMT",106,0)
 ;  Returns "^" or answer
"RTN","GMRCACMT",107,0)
 ;
"RTN","GMRCACMT",108,0)
 N GMRCLINE,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCACMT",109,0)
 Q:'$L($G(GMRC0)) U
"RTN","GMRCACMT",110,0)
 S DIR(0)=GMRC0
"RTN","GMRCACMT",111,0)
 S:$L($G(GMRCA)) DIR("A")=GMRCA
"RTN","GMRCACMT",112,0)
 S:$L($G(GMRCB)) DIR("B")=GMRCB
"RTN","GMRCACMT",113,0)
 S:$L($G(GMRCH)) DIR("?")=GMRCH
"RTN","GMRCACMT",114,0)
 F GMRCLINE=1:1:($G(GMRCL)-1) W !
"RTN","GMRCACMT",115,0)
 D ^DIR
"RTN","GMRCACMT",116,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q U
"RTN","GMRCACMT",117,0)
 Q Y
"RTN","GMRCACMT",118,0)
 ;
"RTN","GMRCACMT",119,0)
 ;
"RTN","GMRCACMT",120,0)
NAMEHELP ;Help for the recipient list logic
"RTN","GMRCACMT",121,0)
 N GMRCDUZ
"RTN","GMRCACMT",122,0)
 W !,"Enter the name of the user to send the alert to,"
"RTN","GMRCACMT",123,0)
 W !," or put a '-' in front of a name to delete from the list."
"RTN","GMRCACMT",124,0)
 W !
"RTN","GMRCACMT",125,0)
 W !,"  Example:"
"RTN","GMRCACMT",126,0)
 W !,"     SMITH,FRED  ->  to add Fred to the list."
"RTN","GMRCACMT",127,0)
 W !,"     -SMITH,FRED ->  to delete Fred from the list."
"RTN","GMRCACMT",128,0)
 W !,"Already selected: "
"RTN","GMRCACMT",129,0)
 W !
"RTN","GMRCACMT",130,0)
 S GMRCDUZ=0 F  S GMRCDUZ=$O(GMRCNEW(GMRCDUZ)) Q:'GMRCDUZ  D
"RTN","GMRCACMT",131,0)
 .W !,?5,$P(^VA(200,GMRCDUZ,0),U,1)
"RTN","GMRCACMT",132,0)
 .W:$D(GMRCOLD(GMRCDUZ)) "  <mandatory>"
"RTN","GMRCACMT",133,0)
 W !
"RTN","GMRCACMT",134,0)
 Q
"RTN","GMRCACMT",135,0)
 ;
"RTN","GMRCASF")
0^3^B11953606
"RTN","GMRCASF",1,0)
GMRCASF ;SLC/DLT - Significant Findings Action ;9/8/98  03:40
"RTN","GMRCASF",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,10,14**;DEC 27, 1997
"RTN","GMRCASF",3,0)
SF(GMRCO) ;Evaluate Significant Findings and update accordingly
"RTN","GMRCASF",4,0)
 ;GMRCO is the selected consult
"RTN","GMRCASF",5,0)
 N GMRCQIT,GMRCLCK
"RTN","GMRCASF",6,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)  I $D(GMRCQUT) D END Q
"RTN","GMRCASF",7,0)
 I '+($G(GMRCO)) D END Q
"RTN","GMRCASF",8,0)
 I '$$LOCK^GMRCA1(GMRCO) D END Q  ;JFR
"RTN","GMRCASF",9,0)
 S GMRCLCK=1
"RTN","GMRCASF",10,0)
 ;
"RTN","GMRCASF",11,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCASF",12,0)
 N GMRC,GMRCSTS,GMRCSF,GMRCSFO,GMRCORTX,GMRCDR
"RTN","GMRCASF",13,0)
 S GMRC(0)=$G(^GMR(123,+GMRCO,0)) Q:GMRC(0)=""
"RTN","GMRCASF",14,0)
 ;
"RTN","GMRCASF",15,0)
 S GMRCSFO=$P(GMRC(0),"^",19)
"RTN","GMRCASF",16,0)
 W !!,"Current Significant Findings = "_$S(GMRCSFO="U":"Unknown",GMRCSFO="Y":"Yes",GMRCSFO="N":"No",1:"not entered yet"),!!
"RTN","GMRCASF",17,0)
 S GMRCSF=$$GETSIGF(GMRCSFO)
"RTN","GMRCASF",18,0)
 I GMRCSF=0 D END Q
"RTN","GMRCASF",19,0)
 ; If no change in old and new value ask if should continue
"RTN","GMRCASF",20,0)
 I GMRCSF=GMRCSFO D  I 'Y D END Q
"RTN","GMRCASF",21,0)
 . W !,"The old and new Significant Findings are the same."
"RTN","GMRCASF",22,0)
 . N DIR,DA,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCASF",23,0)
 . S DIR("A")="Do you want to proceed with this action"
"RTN","GMRCASF",24,0)
 . S DIR(0)="Y"
"RTN","GMRCASF",25,0)
 . S DIR("B")="NO"
"RTN","GMRCASF",26,0)
 . D ^DIR
"RTN","GMRCASF",27,0)
 . I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) S Y=0 Q
"RTN","GMRCASF",28,0)
 . I Y=0 Q
"RTN","GMRCASF",29,0)
 ;
"RTN","GMRCASF",30,0)
 ;Update last action and sig findings but don't change the status
"RTN","GMRCASF",31,0)
 S GMRCSTS=$P(GMRC(0),"^",12),GMRCA=4
"RTN","GMRCASF",32,0)
 S GMRCDR="8////^S X=GMRCSTS;9////^S X=GMRCA;15////^S X=GMRCSF"
"RTN","GMRCASF",33,0)
 D STATUS^GMRCP
"RTN","GMRCASF",34,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCASF",35,0)
 ;
"RTN","GMRCASF",36,0)
 S GMRCOM=1 D AUDIT^GMRCP
"RTN","GMRCASF",37,0)
 I $G(GMRCERR)=1 S GMRCMSG=GMRCERMS D EXAC^GMRCADC(GMRCMSG),END Q
"RTN","GMRCASF",38,0)
 ;
"RTN","GMRCASF",39,0)
 ;GMRCOM=1 tells AUDIT^GMRCP to do the word-processing logic
"RTN","GMRCASF",40,0)
 ;If an actual comment is added, $P(GMRCOM,"^",2)=1 (send alert),
"RTN","GMRCASF",41,0)
 ; if not GMRCOM=1 and no '^' exists (do not send alert)
"RTN","GMRCASF",42,0)
 D SETORTX
"RTN","GMRCASF",43,0)
 I GMRCSTS=2 D SENDALRT(GMRCORTX) Q
"RTN","GMRCASF",44,0)
 I +$P(GMRCOM,"^",2) D
"RTN","GMRCASF",45,0)
 . W !,"An alert with the following text will be sent if recipients are selected: "
"RTN","GMRCASF",46,0)
 . W !,"     "_GMRCORTX_$$ORTX^GMRCAU(+GMRCO)
"RTN","GMRCASF",47,0)
 . W !
"RTN","GMRCASF",48,0)
 . I GMRCSTS'=2 W !,"or the alert will be sent when the order is completed.",!
"RTN","GMRCASF",49,0)
 . D PROCALRT^GMRCACMT(GMRCORTX,1,4,GMRCO)
"RTN","GMRCASF",50,0)
 . ;For consults not completed, the original provider may be deleted from
"RTN","GMRCASF",51,0)
 . ;the recipient list for the alert.
"RTN","GMRCASF",52,0)
 D END
"RTN","GMRCASF",53,0)
 Q
"RTN","GMRCASF",54,0)
 ;
"RTN","GMRCASF",55,0)
SETORTX ;Set prefix text for the alert
"RTN","GMRCASF",56,0)
 S GMRCORTX=$S(GMRCSF="N":"No ",GMRCSF="Y":"",1:"Unknown ")
"RTN","GMRCASF",57,0)
 S GMRCORTX=GMRCORTX_"Sig Findings for "_$P($G(^ORD(100.01,+GMRCSTS,0)),"^",2)_" consult " Q
"RTN","GMRCASF",58,0)
 Q
"RTN","GMRCASF",59,0)
 ;
"RTN","GMRCASF",60,0)
SENDALRT(GMRCORTX) ;Send to the requesting provider
"RTN","GMRCASF",61,0)
 N GMRCRP,GMRCADUZ,GMRCDELR
"RTN","GMRCASF",62,0)
 S GMRCRP=$P($G(^GMR(123,+GMRCO,0)),U,14) ;requesting clinician
"RTN","GMRCASF",63,0)
 I +GMRCRP S GMRCADUZ(+GMRCRP)=""
"RTN","GMRCASF",64,0)
 W !,"Alert will be sent to Requesting Provider: "_$P($G(^VA(200,+GMRCRP,0)),U,1)
"RTN","GMRCASF",65,0)
 S GMRCDELR=0
"RTN","GMRCASF",66,0)
 D ANDTO^GMRCACMT
"RTN","GMRCASF",67,0)
 D SENDMSG^GMRCACMT(23,+GMRCO)
"RTN","GMRCASF",68,0)
 ;Sig Findings uses the CONSULT/REQUEST RESOLUTION (23) notification
"RTN","GMRCASF",69,0)
 Q
"RTN","GMRCASF",70,0)
 ;
"RTN","GMRCASF",71,0)
GETSIGF(GMRCSFO) ;Get the significant findings
"RTN","GMRCASF",72,0)
 ;GMRCSFO is the old significant findings value
"RTN","GMRCASF",73,0)
 N DIR,DA,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCASF",74,0)
 S DIR(0)="123,15"
"RTN","GMRCASF",75,0)
 S DIR("B")=GMRCSFO
"RTN","GMRCASF",76,0)
 S:DIR("B")="" DIR("B")="unknown"
"RTN","GMRCASF",77,0)
 S DIR("A")="Are there significant findings? (Y/N/U)"
"RTN","GMRCASF",78,0)
 D ^DIR
"RTN","GMRCASF",79,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) Q 0
"RTN","GMRCASF",80,0)
 Q Y
"RTN","GMRCASF",81,0)
 ;
"RTN","GMRCASF",82,0)
END ;cleanup variables
"RTN","GMRCASF",83,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO) ;JFR
"RTN","GMRCASF",84,0)
 K GMRCO,GMRCA,GMRCMSG,GMRCOM,GMRCSEL,GMRCERR,GMRCERMS
"RTN","GMRCASF",85,0)
 I $D(DTOUT)!$D(DIROUT) S GMRCQIT=""
"RTN","GMRCASF",86,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCASF",87,0)
 Q
"RTN","GMRCAU")
0^7^B51274084
"RTN","GMRCAU",1,0)
GMRCAU ;SLC/DLT,JFR - Action Utilities  ;9/8/98  03:33
"RTN","GMRCAU",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,11,14**;DEC 27, 1997
"RTN","GMRCAU",3,0)
GETPROV K GMRCORNP N DIR S DIR(0)="123.02,3"
"RTN","GMRCAU",4,0)
 S DIR("A")=$S($D(GETPROV):GETPROV,1:"Responsible Clinician")
"RTN","GMRCAU",5,0)
 D ^DIR K DIR I $D(DTOUT)!$D(DIROUT)!(X="^") S GMRCQIT="Q" Q
"RTN","GMRCAU",6,0)
 G:Y<1 GETPROV S GMRCORNP=+Y
"RTN","GMRCAU",7,0)
 Q
"RTN","GMRCAU",8,0)
GETDT ;Get actual activity date
"RTN","GMRCAU",9,0)
 K GMRCQIT
"RTN","GMRCAU",10,0)
 D NOW^%DTC S (X,GMRCDT)=% D REGDTM^GMRCU S GMRCAD=X
"RTN","GMRCAU",11,0)
 S DIR(0)="123.02,2",DIR("A")=$S($D(GETDT):GETDT,1:"Date/Time of Actual Activity"),DIR("B")="NOW" D ^DIR K DIR I $D(DIRUT) S GMRCQIT="Q" Q
"RTN","GMRCAU",12,0)
 I X="NOW" K GMRCAD,Y Q
"RTN","GMRCAU",13,0)
 S GMRCAD=Y K X,Y,DIRUT,DUOUT
"RTN","GMRCAU",14,0)
 Q
"RTN","GMRCAU",15,0)
ORTX(GMRCO) ;Get the abbreviated text for alert displays
"RTN","GMRCAU",16,0)
 ;GMRCO is the consult entry from 123
"RTN","GMRCAU",17,0)
 N GMRCSVC,GMRCSSNM,GMRCPROC,GMRCORTX
"RTN","GMRCAU",18,0)
 S GMRCSSNM=$$SVC(GMRCO)
"RTN","GMRCAU",19,0)
 S GMRCPROC=$$PROC(GMRCO)
"RTN","GMRCAU",20,0)
 S GMRCORTX=$S($L(GMRCPROC):($E(GMRCSSNM,1,10)_" "_$E(GMRCPROC,1,10)),1:$E(GMRCSSNM,1,20))
"RTN","GMRCAU",21,0)
 Q GMRCORTX
"RTN","GMRCAU",22,0)
 ;
"RTN","GMRCAU",23,0)
SVC(GMRCO) ;Get abbreviated service text
"RTN","GMRCAU",24,0)
 S GMRCSVC=$P(^GMR(123,+GMRCO,0),"^",5),GMRCSSNM=""
"RTN","GMRCAU",25,0)
 I +GMRCSVC S GMRCSSNM=$S($L($G(^GMR(123.5,+GMRCSVC,.1))):^(.1),1:$P($G(^GMR(123.5,+GMRCSVC,0)),U,1))
"RTN","GMRCAU",26,0)
 Q GMRCSSNM
"RTN","GMRCAU",27,0)
PROC(GMRCO) ;Get abbreviated procedure text
"RTN","GMRCAU",28,0)
 S GMRCPROC=$P(^GMR(123,+GMRCO,0),"^",8)
"RTN","GMRCAU",29,0)
 I +GMRCPROC S GMRCPROC=$S($L($G(^ORD(101,+GMRCPROC,.1))):^(.1),1:$P($G(^ORD(101,+GMRCPROC,0)),"^",2))
"RTN","GMRCAU",30,0)
 Q GMRCPROC
"RTN","GMRCAU",31,0)
 ;
"RTN","GMRCAU",32,0)
LMTX(GMRCO) ;Get the text for list manager displays
"RTN","GMRCAU",33,0)
 ;GMRCO is the consult entry from 123
"RTN","GMRCAU",34,0)
 N GMRCSVC,GMRCSSNM,GMRCREQ,GMRCORTX
"RTN","GMRCAU",35,0)
 S GMRCSVC=$P(^GMR(123,+GMRCO,0),"^",5),GMRCSSNM=""
"RTN","GMRCAU",36,0)
 I +GMRCSVC S GMRCSSNM=$P($G(^GMR(123.5,+GMRCSVC,0)),U,1)
"RTN","GMRCAU",37,0)
 S GMRCREQ=$P(^GMR(123,+GMRCO,0),"^",8)
"RTN","GMRCAU",38,0)
 I +GMRCREQ S GMRCREQ=$S($L($G(^ORD(101,+GMRCREQ,.1))):^(.1),1:$P($G(^ORD(101,+GMRCPROC,0)),"^",2))
"RTN","GMRCAU",39,0)
 S GMRCORTX=$S($L(GMRCPROC):($E(GMRCSSNM,1,10)_" "_$E(GMRCREQ,1,10)),1:$E(GMRCSSNM,1,20))
"RTN","GMRCAU",40,0)
 Q GMRCORTX
"RTN","GMRCAU",41,0)
 ;
"RTN","GMRCAU",42,0)
 ;
"RTN","GMRCAU",43,0)
VALID(GMRCSER,GMRCO,GMRCUSER,GMRCTST) ;Get users update authority
"RTN","GMRCAU",44,0)
 ; check GMRCSS and all parents for authority
"RTN","GMRCAU",45,0)
 ; codes returned are same as $$VALIDU
"RTN","GMRCAU",46,0)
 N GMRCUPDL,GMRCLIS,GMRCHKD,GMRCNT,GMRCLP,GMRCQUIT
"RTN","GMRCAU",47,0)
 I '$G(GMRCUSER) S GMRCUSER=DUZ
"RTN","GMRCAU",48,0)
 ; check initial service first
"RTN","GMRCAU",49,0)
 S GMRCUPDL=$$VALIDU(GMRCSER,GMRCUSER) I +GMRCUPDL D  G VALEX
"RTN","GMRCAU",50,0)
 . I $G(GMRCTST) S $P(GMRCUPDL,U,3)=$P($G(^GMR(123.5,+GMRCSER,0)),U)
"RTN","GMRCAU",51,0)
 S GMRCHKD(GMRCSER)="",GMRCNT=1
"RTN","GMRCAU",52,0)
 ; find parents if set to process, quit if none
"RTN","GMRCAU",53,0)
 I '$P($G(^GMR(123.5,+GMRCSER,0)),U,7) G VALEX ;process parents = 0
"RTN","GMRCAU",54,0)
 D FINDPAR(GMRCSER,.GMRCNT) I '$D(GMRCLIS) S GMRCUPDL=0 G VALEX
"RTN","GMRCAU",55,0)
 S GMRCLP=0
"RTN","GMRCAU",56,0)
 F  S GMRCLP=$O(GMRCLIS(GMRCLP)) Q:'GMRCLP!($D(GMRCQUIT))  D  I +GMRCUPDL G VALEX
"RTN","GMRCAU",57,0)
 . I +$P(GMRCLIS(GMRCLP),U,2) K GMRCLIS(GMRCLP) Q  ;been checked
"RTN","GMRCAU",58,0)
 . I '$D(GMRCHKD(+GMRCLIS(GMRCLP))) D
"RTN","GMRCAU",59,0)
 .. ; check parent 
"RTN","GMRCAU",60,0)
 .. S GMRCUPDL=$$VALIDU(+GMRCLIS(GMRCLP),GMRCUSER)
"RTN","GMRCAU",61,0)
 .. S GMRCHKD(+GMRCLIS(GMRCLP))=""
"RTN","GMRCAU",62,0)
 . S $P(GMRCLIS(GMRCLP),U,2)=1
"RTN","GMRCAU",63,0)
 . I +GMRCUPDL D  Q  ;got one
"RTN","GMRCAU",64,0)
 .. S:$G(GMRCTST) $P(GMRCUPDL,U,3)=$P($G(^GMR(123.5,+GMRCLIS(GMRCLP),0)),U)
"RTN","GMRCAU",65,0)
 . I $P(^GMR(123.5,+GMRCLIS(GMRCLP),0),U,7) D  ;process parents
"RTN","GMRCAU",66,0)
 .. D FINDPAR(+GMRCLIS(GMRCLP),.GMRCNT)
"RTN","GMRCAU",67,0)
 . S GMRCLP=0 ;start back at top and don't miss any
"RTN","GMRCAU",68,0)
VALEX Q GMRCUPDL
"RTN","GMRCAU",69,0)
FINDPAR(SERV,ARCNT)     ;find parents of SERV
"RTN","GMRCAU",70,0)
 ; SERV = service to find parents of
"RTN","GMRCAU",71,0)
 ; ARCNT = next array element
"RTN","GMRCAU",72,0)
 N PARENT
"RTN","GMRCAU",73,0)
 S PARENT=0
"RTN","GMRCAU",74,0)
 F  S PARENT=$O(^GMR(123.5,"APC",SERV,PARENT)) Q:'PARENT  D
"RTN","GMRCAU",75,0)
 . S GMRCLIS(ARCNT)=PARENT
"RTN","GMRCAU",76,0)
 . S ARCNT=ARCNT+1
"RTN","GMRCAU",77,0)
 Q
"RTN","GMRCAU",78,0)
 ;
"RTN","GMRCAU",79,0)
VALIDU(GMRCSS,GMRCUSR) ;Check to see if user is an update user
"RTN","GMRCAU",80,0)
 ;The value returned is the equivalent of this set of codes:
"RTN","GMRCAU",81,0)
 ;    0 = not an update user
"RTN","GMRCAU",82,0)
 ;    2 = update user
"RTN","GMRCAU",83,0)
 ;    3 = administrative update user
"RTN","GMRCAU",84,0)
 N GMRCUPD
"RTN","GMRCAU",85,0)
 I '$G(GMRCUSR) S GMRCUSR=DUZ
"RTN","GMRCAU",86,0)
 I '+$G(GMRCSS) Q 0
"RTN","GMRCAU",87,0)
 I +$P($G(^GMR(123.5,GMRCSS,0)),U,6) Q 2_$$FIELD(.06)
"RTN","GMRCAU",88,0)
 I $D(^GMR(123.5,+GMRCSS,123.3,"B",GMRCUSR)) Q 2_$$FIELD(123.3)
"RTN","GMRCAU",89,0)
 I GMRCUSR=$P($G(^GMR(123.5,+GMRCSS,123)),"^",8) Q 2_$$FIELD(123.08)
"RTN","GMRCAU",90,0)
 I $D(^GMR(123.5,+GMRCSS,123.33,"B",GMRCUSR)) Q 3_$$FIELD(123.33)
"RTN","GMRCAU",91,0)
 ;
"RTN","GMRCAU",92,0)
 S GMRCUPD=0
"RTN","GMRCAU",93,0)
 ; check service teams to notify, update teams w/o and admin teams w/o
"RTN","GMRCAU",94,0)
 N NODE F NODE=123.1,123.31,123.34 D  I +GMRCUPD Q
"RTN","GMRCAU",95,0)
 . I '$D(^GMR(123.5,+GMRCSS,NODE)) Q
"RTN","GMRCAU",96,0)
 . D TEAM(.GMRCUPD,NODE,GMRCUSR)
"RTN","GMRCAU",97,0)
 I +GMRCUPD Q GMRCUPD
"RTN","GMRCAU",98,0)
 ;
"RTN","GMRCAU",99,0)
 ; check ASU user classes in field 123.35
"RTN","GMRCAU",100,0)
 S GMRCUPD=$$USR(GMRCSS,GMRCUSR)
"RTN","GMRCAU",101,0)
 I +GMRCUPD Q GMRCUPD
"RTN","GMRCAU",102,0)
 ;
"RTN","GMRCAU",103,0)
 I $D(^GMR(123.5,+GMRCSS,123.2)) D LOC(.GMRCUPD) Q:+GMRCUPD GMRCUPD
"RTN","GMRCAU",104,0)
 Q 0
"RTN","GMRCAU",105,0)
 ;
"RTN","GMRCAU",106,0)
LOC(GMRCUPD) ;Check for the DUZ in the NOTIFICATION BY PT LOCATION multiple
"RTN","GMRCAU",107,0)
 N GMRCL,GMRCTM
"RTN","GMRCAU",108,0)
 S GMRCL=0 ;Check if DUZ is associated with any location/ward
"RTN","GMRCAU",109,0)
 F  S GMRCL=$O(^GMR(123.5,+GMRCSS,123.2,GMRCL))  Q:'GMRCL!+GMRCUPD  D  Q:+GMRCUPD
"RTN","GMRCAU",110,0)
 . ;Get user and/or team assigned to location
"RTN","GMRCAU",111,0)
 . S GMRCL(0)=$G(^GMR(123.5,+GMRCSS,123.2,+GMRCL,0))
"RTN","GMRCAU",112,0)
 . I $P(GMRCL(0),"^",2)=DUZ S GMRCUPD=2 Q
"RTN","GMRCAU",113,0)
 . I $P(GMRCL(0),"^",3) S GMRCTM=$P(GMRCL(0),"^",3) ;D CHKTM
"RTN","GMRCAU",114,0)
 Q
"RTN","GMRCAU",115,0)
 ;
"RTN","GMRCAU",116,0)
TEAM(TYPE,SUBSC,USER) ;Check for the DUZ in the multiple of SUBSC
"RTN","GMRCAU",117,0)
 N GMRCTM,GMRCHIT
"RTN","GMRCAU",118,0)
 S GMRCTM=""
"RTN","GMRCAU",119,0)
 I '$G(USER) S USER=DUZ
"RTN","GMRCAU",120,0)
 F  S GMRCTM=$O(^GMR(123.5,GMRCSS,SUBSC,"B",GMRCTM)) Q:'GMRCTM!+TYPE  D
"RTN","GMRCAU",121,0)
 . S GMRCHIT=$$CHKTM(GMRCTM,USER) Q:'GMRCHIT
"RTN","GMRCAU",122,0)
 . S TYPE=$S(SUBSC=123.34:3,1:2)_$$FIELD(SUBSC)
"RTN","GMRCAU",123,0)
 Q
"RTN","GMRCAU",124,0)
 ;
"RTN","GMRCAU",125,0)
CHKTM(TEAM,PERS) ;checks for PERS in list of users on TEAM
"RTN","GMRCAU",126,0)
 ;Input:  TEAM must be set to the Order Team entry number
"RTN","GMRCAU",127,0)
 ;Output: 1 will be returned PERS is on TEAM
"RTN","GMRCAU",128,0)
 N ND,GMRCLST,FOUND
"RTN","GMRCAU",129,0)
 S GMRCLST=""
"RTN","GMRCAU",130,0)
 D TEAMPROV^ORQPTQ1(.GMRCLST,TEAM)
"RTN","GMRCAU",131,0)
 I $P(GMRCLST(1),"^",2)="No providers found." Q 0
"RTN","GMRCAU",132,0)
 S ND=0
"RTN","GMRCAU",133,0)
 F  S ND=$O(GMRCLST(ND)) Q:ND=""  I +GMRCLST(ND)=PERS S FOUND=1 Q
"RTN","GMRCAU",134,0)
 Q $S($G(FOUND):1,1:0)
"RTN","GMRCAU",135,0)
 ;
"RTN","GMRCAU",136,0)
USR(SERV,USER) ; check USR classes for user
"RTN","GMRCAU",137,0)
 N UCLS,UPD
"RTN","GMRCAU",138,0)
 I '$O(^GMR(123.5,+SERV,123.35,0)) Q 0
"RTN","GMRCAU",139,0)
 S UCLS=0,UPD=0
"RTN","GMRCAU",140,0)
 F  S UCLS=$O(^GMR(123.5,+SERV,123.35,"B",UCLS)) Q:'UCLS!(+UPD)  D
"RTN","GMRCAU",141,0)
 . Q:'UCLS
"RTN","GMRCAU",142,0)
 . S UPD=$$ISA^USRLM(USER,UCLS)
"RTN","GMRCAU",143,0)
 . I +UPD S UPD=2_$$FIELD(123.35)
"RTN","GMRCAU",144,0)
 . Q
"RTN","GMRCAU",145,0)
 Q UPD
"RTN","GMRCAU",146,0)
FIELD(GMRCFLD) ;return field name where became update user
"RTN","GMRCAU",147,0)
 I '$G(GMRCTST) Q ""
"RTN","GMRCAU",148,0)
 D FIELD^DID(123.5,GMRCFLD,,"LABEL","GMRCFLD")
"RTN","GMRCAU",149,0)
 Q "^"_$G(GMRCFLD("LABEL"))
"RTN","GMRCAU",150,0)
COMPLETE(GMRCA) ;Determine if the action is a complete action (10,13,14)
"RTN","GMRCAU",151,0)
 S GMRCA=$G(GMRCA)
"RTN","GMRCAU",152,0)
 Q $S(GMRCA=13:1,GMRCA=14:1,GMRCA=10:1,1:0)
"RTN","GMRCAU",153,0)
 ;   10=administrative complete, 13=ADDENDUM ADDED, 14=New Note
"RTN","GMRCAU",154,0)
 ;
"RTN","GMRCAU",155,0)
RESOLUA(GMRCA) ;Determine if action has resolution info for clinician
"RTN","GMRCAU",156,0)
 ;Action value is based on value in ^ORD(100.01,"
"RTN","GMRCAU",157,0)
 ;Returns 1 for consult resolution, 0 for pending resolution
"RTN","GMRCAU",158,0)
 S GMRCA=$G(GMRCA)
"RTN","GMRCAU",159,0)
 Q $S(GMRCA=4:1,GMRCA=6:1,GMRCA=10:1,GMRCA=11:1,GMRCA=12:1,GMRCA=13:1,GMRCA=14:1,GMRCA=19:1,1:0)
"RTN","GMRCAU",160,0)
 ;    4=Sig Findings, 6=discontinued, 10=administrative complete
"RTN","GMRCAU",161,0)
 ;    11=Edit/resubmit
"RTN","GMRCAU",162,0)
 ;    12=Disassociate result, 13=Addendum Added, 14=New Note
"RTN","GMRCAU",163,0)
 ;    19=cancelled
"RTN","GMRCAU",164,0)
 ;
"RTN","GMRCAU",165,0)
RESOLUS(GMRCSTS) ;Determine status indicates the consult has a resolution
"RTN","GMRCAU",166,0)
 ;Status value is based on values in ^ORD(100.01,"
"RTN","GMRCAU",167,0)
 ;Returns 1 for consult resolution, 0 for pending resolution
"RTN","GMRCAU",168,0)
 S GMRCSTS=$G(GMRCSTS)
"RTN","GMRCAU",169,0)
 Q $S(GMRCSTS:1,GMRCSTS=2:1,GMRCSTS=13:1,1:0)
"RTN","GMRCAU",170,0)
 ;    1=dc,2=comp,13=canc
"RTN","GMRCAU",171,0)
 ;
"RTN","GMRCAU",172,0)
TEST ;called from GMRC UPDATE AUTHORITY
"RTN","GMRCAU",173,0)
 ; determines how a user gets update authority for a service 
"RTN","GMRCAU",174,0)
 W !
"RTN","GMRCAU",175,0)
 N GMRCSRV,GMRCUSR,UPD,GMRCDG,GMRC1
"RTN","GMRCAU",176,0)
 N DIR,DIROUT,DIRUT,DUOUT,DTOUT,X,Y
"RTN","GMRCAU",177,0)
 S DIR(0)="PO^123.5:EM",DIR("A")="Select Consult Service"
"RTN","GMRCAU",178,0)
 S DIR("?")="Choose the consult service to check update status of user"
"RTN","GMRCAU",179,0)
 S DIR("??")="^D TESTHELP^GMRCAU(""ALL SERVICES"")" D ^DIR
"RTN","GMRCAU",180,0)
 I $D(DIRUT) Q
"RTN","GMRCAU",181,0)
 S GMRCSRV=+Y
"RTN","GMRCAU",182,0)
 N DIR
"RTN","GMRCAU",183,0)
 S DIR(0)="PO^200:EM",DIR("A")="Choose user to check for update status"
"RTN","GMRCAU",184,0)
 D ^DIR I $D(DIRUT) Q
"RTN","GMRCAU",185,0)
 S GMRCUSR=+Y
"RTN","GMRCAU",186,0)
 S UPD=$$VALID(GMRCSRV,,GMRCUSR,1)
"RTN","GMRCAU",187,0)
 I +UPD=0 W !!,"This user has no update authority"
"RTN","GMRCAU",188,0)
 I +UPD D
"RTN","GMRCAU",189,0)
 . I +UPD=2 W !!,"This user is an update user for: ",$P(UPD,U,3)
"RTN","GMRCAU",190,0)
 . I +UPD=3 W !!,"This user is an administrative user for: ",$P(UPD,U,3)
"RTN","GMRCAU",191,0)
 . W !,"via the ",$P(UPD,U,2)," field."
"RTN","GMRCAU",192,0)
 . W ! I $L($P(UPD,U,3)) D
"RTN","GMRCAU",193,0)
 .. I $P(UPD,U,3)'=$P(^GMR(123.5,+GMRCSRV,0),U) D HIER^GMRCT($P(UPD,U,3))
"RTN","GMRCAU",194,0)
 W !!
"RTN","GMRCAU",195,0)
 K GMRCSRV,GMRCUSR,UPD
"RTN","GMRCAU",196,0)
 K DIR,DIROUT,DIRUT,DUOUT,DTOUT,X,Y
"RTN","GMRCAU",197,0)
 G TEST
"RTN","GMRCAU",198,0)
TESTHELP(GMRCSVNM) ;wrapper for LISTSRV^GMRCASV
"RTN","GMRCAU",199,0)
 N DIR,GMRC1,GMRCDG
"RTN","GMRCAU",200,0)
 D LISTSRV^GMRCASV
"RTN","GMRCAU",201,0)
 Q
"RTN","GMRCAU",202,0)
TSTINTRO ;entry action of GMRC UPDATE AUTHORITY option
"RTN","GMRCAU",203,0)
 W !!,"This option will allow you to check a user's update authority for any given"
"RTN","GMRCAU",204,0)
 W !,"service in the consults hierarchy.  If the PROCESS PARENTS FOR UPDATES field"
"RTN","GMRCAU",205,0)
 W !,"is set to YES, all ancestors of the selected service will be checked."
"RTN","GMRCAU",206,0)
 W !,"The type of update authority and the service to which they are assigned will"
"RTN","GMRCAU",207,0)
 W !,"be displayed.",!!
"RTN","GMRCAU",208,0)
 Q
"RTN","GMRCSLM")
0^2^B34407521
"RTN","GMRCSLM",1,0)
GMRCSLM ;SLC/DCM,JFR - List Mgr routine for consult tracking list ;9/8/99 14:52
"RTN","GMRCSLM",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,4,14**;DEC 27, 1997
"RTN","GMRCSLM",3,0)
EN ; -- main entry point for GMRC CONSULT TRACKING
"RTN","GMRCSLM",4,0)
 K GMRCOER
"RTN","GMRCSLM",5,0)
 S GMRCEN=1 K GMRCQUT
"RTN","GMRCSLM",6,0)
 D SP K GMRCEN I $D(GMRCQUT) K GMRCQUT Q
"RTN","GMRCSLM",7,0)
 D EN^VALM("GMRC CONSULT TRACKING")
"RTN","GMRCSLM",8,0)
 Q
"RTN","GMRCSLM",9,0)
 ;
"RTN","GMRCSLM",10,0)
HDR ; -- header code
"RTN","GMRCSLM",11,0)
 D HDR1 ;format line 1 of header
"RTN","GMRCSLM",12,0)
 D:$L(GMRCWT) HDR2("")
"RTN","GMRCSLM",13,0)
 Q
"RTN","GMRCSLM",14,0)
 ;
"RTN","GMRCSLM",15,0)
HDR1 ;format VALMHDR(1) with patient information
"RTN","GMRCSLM",16,0)
 N GMRCX,GMRCX1,GMRCX2,GMRCX3,TIUCWAD,GMRVSTR,X
"RTN","GMRCSLM",17,0)
 ;Expects DFN
"RTN","GMRCSLM",18,0)
 S GMRVSTR="WT" D EN6^GMRVUTL
"RTN","GMRCSLM",19,0)
 S GMRCWT="Wt.(lb): "_$S($L($P(X,U,8)):$P(X,U,8),1:"No Entry")
"RTN","GMRCSLM",20,0)
 D DEM^GMRCU ;returns GMRCPNM,GMRCSN,GMRCAGE,SEX,GMRCWARD,GMRCRB,GMRCDOB,GMRCWLI
"RTN","GMRCSLM",21,0)
 S GMRCX1=GMRCPNM_"   "_GMRCSN
"RTN","GMRCSLM",22,0)
 ;
"RTN","GMRCSLM",23,0)
 S GMRCLOC=+$G(^DIC(42,+GMRCWLI,44))_";SC(" I 'GMRCLOC,'$D(XQAID) S GMRCLOC=""
"RTN","GMRCSLM",24,0)
 S GMRCX2="" I +$G(GMRCLOC) D
"RTN","GMRCSLM",25,0)
 . N L S L=$G(^SC(+GMRCLOC,0)),GMRCX2=$P(L,U,2)
"RTN","GMRCSLM",26,0)
 . S:'$L(GMRCX2) GMRCX2=$E($P(L,U),1,4)
"RTN","GMRCSLM",27,0)
 S:$L($G(GMRCRB)) GMRCX2=GMRCX2_"/"_GMRCRB
"RTN","GMRCSLM",28,0)
 ;
"RTN","GMRCSLM",29,0)
 S GMRCX=GMRCX1_$J(GMRCX2,40+($L(GMRCX2)\2)-$L(GMRCX1))
"RTN","GMRCSLM",30,0)
 S GMRCX3=" "_GMRCDOB_" ("_GMRCAGE_")"
"RTN","GMRCSLM",31,0)
 S TIUCWAD=$$CWAD^ORQPT2(+DFN) S:TIUCWAD]"" GMRCX3=GMRCX3_"   <"_TIUCWAD_">"
"RTN","GMRCSLM",32,0)
 S VALMHDR(1)=GMRCX_$J(GMRCX3,79-$L(GMRCX))
"RTN","GMRCSLM",33,0)
 K VALMHDR(2)
"RTN","GMRCSLM",34,0)
 Q
"RTN","GMRCSLM",35,0)
HDR2(GMRCX) ;format VALMHDR(2) with patient weight
"RTN","GMRCSLM",36,0)
 S VALMHDR(2)=$G(GMRCX)_$J($G(GMRCWT),79-$L($G(GMRCX)))
"RTN","GMRCSLM",37,0)
 Q
"RTN","GMRCSLM",38,0)
 ;
"RTN","GMRCSLM",39,0)
INIT ; -- init variables and list array
"RTN","GMRCSLM",40,0)
 K ^TMP("GMRCR",$J,"LIST")
"RTN","GMRCSLM",41,0)
 S DSPLINE=0,DATA="",VALMAR="^TMP(""GMRCR"",$J,""LIST"")"
"RTN","GMRCSLM",42,0)
 F LINE=1:1:LNCT S DSPLINE=$O(^TMP("GMRCR",$J,"CS",DSPLINE)) Q:DSPLINE=""!(DSPLINE?1A.E)  S DATA=^(DSPLINE,0) D SET^VALM10(LINE,DATA)
"RTN","GMRCSLM",43,0)
 S VALMCNT=LNCT,VALMPGE=1,XQORM("A")="Select Action: "
"RTN","GMRCSLM",44,0)
 K DSPLINE,DATA,LINE
"RTN","GMRCSLM",45,0)
 S:$D(^TMP("GMRC",$J,"CURRENT","MENU")) XQORM("HIJACK")=^("MENU")
"RTN","GMRCSLM",46,0)
 Q
"RTN","GMRCSLM",47,0)
 ;
"RTN","GMRCSLM",48,0)
HELP ; -- help code
"RTN","GMRCSLM",49,0)
 N X,DX,DY D FULL^VALM1
"RTN","GMRCSLM",50,0)
 W !!,"Enter the display number of the item you wish to act on, or select an action."
"RTN","GMRCSLM",51,0)
 W !!,"If you'd like another view of the consults, enter CV."
"RTN","GMRCSLM",52,0)
 W !!,"Status key:",!?5,"'a' - active",?27,"'c' - complete",?50,"'dc' - discontinued",!?5,"'p' - pending",?27,"'x' - cancelled",?50,"'pr' - partial results",!?5,"'s' - scheduled",?27,"'e' - expired"
"RTN","GMRCSLM",53,0)
 W !!,"Enter ?? to see a list of actions available for navigating the list."
"RTN","GMRCSLM",54,0)
 W !!,"Press <return> to continue ..." R X:DTIME
"RTN","GMRCSLM",55,0)
 S VALMBCK="R"
"RTN","GMRCSLM",56,0)
 ; S VALMSG=$$MSG
"RTN","GMRCSLM",57,0)
 S (DX,DY)=0 X ^%ZOSF("XY")
"RTN","GMRCSLM",58,0)
 D EXIT^GMRCSLMA("R")
"RTN","GMRCSLM",59,0)
 Q
"RTN","GMRCSLM",60,0)
 ;
"RTN","GMRCSLM",61,0)
EXIT ; -- exit code
"RTN","GMRCSLM",62,0)
 K ^TMP("GMRCR",$J,"LIST")
"RTN","GMRCSLM",63,0)
 K VALMCNT,VALMBCK,VALMPGE
"RTN","GMRCSLM",64,0)
 D ^GMRCREXT
"RTN","GMRCSLM",65,0)
 Q
"RTN","GMRCSLM",66,0)
 ;
"RTN","GMRCSLM",67,0)
PHYEN ;Entry Point When Provider's service is known and only needs to look at consults for that service
"RTN","GMRCSLM",68,0)
 Q:'$D(DUZ)  Q:'$D(^VA(200,DUZ,5))  Q:'$L(^VA(200,DUZ,5))
"RTN","GMRCSLM",69,0)
 S DIC="^DIC(49,",DIC(0)="MNO",X=^VA(200,DUZ,5) D ^DIC K DIC S GMRCSSNM=$S($L($P(Y,"^",2)):$P(Y,"^",2),1:"") I $L(GMRCSSNM) S GMRCSS=$O(^GMR(123.5,"B",GMRCSSNM,0))
"RTN","GMRCSLM",70,0)
 S GMRCFL=1 D SP I $D(GMRCQUT),GMRCQUT=1 Q
"RTN","GMRCSLM",71,0)
 D SPD I $D(GMRCQUT) D END,EXIT Q
"RTN","GMRCSLM",72,0)
 K GMRCFL
"RTN","GMRCSLM",73,0)
 D AD^GMRCSLM1
"RTN","GMRCSLM",74,0)
 I GMRCSSNM'["MEDICINE" D EN^VALM("GMRC CONSULT TRACKING"),END,EXIT Q
"RTN","GMRCSLM",75,0)
 D EN^VALM("GMRC TRK MEDICINE CONSULTS"),END,EXIT Q
"RTN","GMRCSLM",76,0)
 Q
"RTN","GMRCSLM",77,0)
SP ;;Select a new patient and return DFN and GMRCSSNM to display consults and requested Service.
"RTN","GMRCSLM",78,0)
 I $D(VALM) D FULL^VALM1
"RTN","GMRCSLM",79,0)
 K GMRCQUT S GMRCDFN1=$S($D(DFN):DFN,1:0)
"RTN","GMRCSLM",80,0)
 D SELPT^GMRCS I $S($D(GMRCQUT):1,'$D(DFN):1,1:0) S GMRCQUT=1,DFN=GMRCDFN1 G SPK
"RTN","GMRCSLM",81,0)
 I $D(Y),Y<0&(X["^") S GMRCQUT=1 G SPK
"RTN","GMRCSLM",82,0)
 I $D(Y),Y<0 S DFN=GMRCDFN1 S GMRCQUT=1 G SPK
"RTN","GMRCSLM",83,0)
 I $D(GMRC("NMBR")) D RESET^GMRCSLMV(GMRC("NMBR")) K GMRC("NMBR")
"RTN","GMRCSLM",84,0)
 S GMRCWRD=GMRCWARD
"RTN","GMRCSLM",85,0)
 I $D(GMRCFL) D SPK Q
"RTN","GMRCSLM",86,0)
 D ASRV^GMRCASV I $S($D(GMRCQUT):1,$D(DTOUT):1,$D(DUOUT):1,1:0) K DTOUT,DIROUT,DUOUT S (GMRCQUT,GMRCQIT)=1 Q
"RTN","GMRCSLM",87,0)
 S GMRCSS=GMRCDG,GMRCSSNM=$P(^GMR(123.5,GMRCSS,0),"^",1) S GMRCSTCK=""
"RTN","GMRCSLM",88,0)
 D EN^GMRCMENU
"RTN","GMRCSLM",89,0)
SPD ;Enter a date range for serching consults;  null entry selects all consults and does not exclude by date
"RTN","GMRCSLM",90,0)
 D ^GMRCSPD Q:$D(GMRCQUT)
"RTN","GMRCSLM",91,0)
 I $D(GMRCEN) D SPK Q  ;GMRCEN defined if branched to here from EN^GMRCSLM
"RTN","GMRCSLM",92,0)
 S GMRCOER=0
"RTN","GMRCSLM",93,0)
 D AD^GMRCSLM1 ;Do not delete. Needed to get new Pt. data into ^TMP("GMRCR",
"RTN","GMRCSLM",94,0)
 S VALMCNT=LNCT,VALMBCK="R",VALMPGE=1 K GMRCDFN1
"RTN","GMRCSLM",95,0)
 Q
"RTN","GMRCSLM",96,0)
SPQ ;New patient has not been selected - keep current patient
"RTN","GMRCSLM",97,0)
 I '$D(DFN),GMRCDFN1<1 S GMRCQUT=1 K GMRCDFN1 Q
"RTN","GMRCSLM",98,0)
 S DFN=GMRCDFN1 Q:DFN<1  W " "_GMRCPNM K GMRCDFN1
"RTN","GMRCSLM",99,0)
 S VALMBCK="R",GMRCQUT=1 K GMRCDFN1
"RTN","GMRCSLM",100,0)
SPK ;Kill variables
"RTN","GMRCSLM",101,0)
 ;I $D(GMRCTM),$D(GMRCBM),$D(IOSTBM) S IOTM=GMRCTM,IOBM=IOSTBM
"RTN","GMRCSLM",102,0)
 K GMRCDFN1,GMRCBM,GMRCTM
"RTN","GMRCSLM",103,0)
 Q
"RTN","GMRCSLM",104,0)
SS ;Select A New Service or ALL SERVICES to Display Patient Consults
"RTN","GMRCSLM",105,0)
 K GMRCQUT,GMRCVP S GMRCOER=0
"RTN","GMRCSLM",106,0)
 D FULL^VALM1
"RTN","GMRCSLM",107,0)
 D ASRV^GMRCASV I $D(GMRCQUT),GMRCQUT=1 Q
"RTN","GMRCSLM",108,0)
 S GMRCSS=GMRCDG,GMRCSSNM=$P(^GMR(123.5,GMRCSS,0),"^",1)
"RTN","GMRCSLM",109,0)
 D AD^GMRCSLM1,INIT,HDR
"RTN","GMRCSLM",110,0)
 S VALMBCK="R",VALMCNT=LNCT
"RTN","GMRCSLM",111,0)
 D EN^GMRCACTM,EN^GMRCMENU
"RTN","GMRCSLM",112,0)
 I $D(GMRC("NMBR")) D RESET^GMRCSLMV(GMRC("NMBR")) K GMRC("NMBR")
"RTN","GMRCSLM",113,0)
 Q
"RTN","GMRCSLM",114,0)
STS ;Select a status for view. i.e., only active, pendings, DC'd, etc.
"RTN","GMRCSLM",115,0)
 I $D(IOTM),$D(IOBM),$D(IOSTBM) D FULL^VALM1
"RTN","GMRCSLM",116,0)
 S GMRCERR=0
"RTN","GMRCSLM",117,0)
 N DIR,X,Y
"RTN","GMRCSLM",118,0)
 S DIR(0)="SAOM^dc:Discontinued;c:Complete;p:Pending;a:Active;pr:Partial Results;x:Cancelled"
"RTN","GMRCSLM",119,0)
 S $P(DIR(0),U,2)="al:All Status's;"_$P(DIR(0),U,2)
"RTN","GMRCSLM",120,0)
 S DIR("A")="Only Display Consults With Status of: "
"RTN","GMRCSLM",121,0)
 S DIR("B")="All Status's"
"RTN","GMRCSLM",122,0)
 I $G(GMRCSTCK) D
"RTN","GMRCSLM",123,0)
 . S DIR("A")="Another Status to display: "
"RTN","GMRCSLM",124,0)
 . K DIR("B")
"RTN","GMRCSLM",125,0)
 D ^DIR
"RTN","GMRCSLM",126,0)
 I $D(DUOUT)!($D(DTOUT))!('$L(Y)) G END
"RTN","GMRCSLM",127,0)
 D STCK($$LOW^XLFSTR(Y)) I $G(GMRCSTCK)="" D:$D(GMRC("NMBR"))  G END
"RTN","GMRCSLM",128,0)
 . D RESET^GMRCSLMV(GMRC("NMBR"))
"RTN","GMRCSLM",129,0)
 . K GMRC("NMBR")
"RTN","GMRCSLM",130,0)
 . Q
"RTN","GMRCSLM",131,0)
 I $D(GMRC("NMBR")) D RESET^GMRCSLMV(GMRC("NMBR")) K GMRC("NMBR")
"RTN","GMRCSLM",132,0)
 G STS
"RTN","GMRCSLM",133,0)
STCK(RES)     ;change code to status
"RTN","GMRCSLM",134,0)
 N CODE
"RTN","GMRCSLM",135,0)
 I RES="al" S GMRCSTCK="" Q
"RTN","GMRCSLM",136,0)
 I RES="dc" S CODE=1
"RTN","GMRCSLM",137,0)
 I RES="c" S CODE=2
"RTN","GMRCSLM",138,0)
 I RES="p" S CODE=5
"RTN","GMRCSLM",139,0)
 I RES="a" S CODE=6
"RTN","GMRCSLM",140,0)
 I RES="pr" S CODE=9
"RTN","GMRCSLM",141,0)
 I RES="x" S CODE=13
"RTN","GMRCSLM",142,0)
 I $D(GMRCSTCK)  I $$FND(CODE) W $C(7),!,"Already selected" Q
"RTN","GMRCSLM",143,0)
 I +$G(GMRCSTCK) S GMRCSTCK=GMRCSTCK_","_CODE Q
"RTN","GMRCSLM",144,0)
 S GMRCSTCK=CODE
"RTN","GMRCSLM",145,0)
 Q
"RTN","GMRCSLM",146,0)
FND(CD) ;status already selected?
"RTN","GMRCSLM",147,0)
 I GMRCSTCK=CD Q 1
"RTN","GMRCSLM",148,0)
 I $F(GMRCSTCK,(CD_",")) Q 1
"RTN","GMRCSLM",149,0)
 I $E(GMRCSTCK,$L(GMRCSTCK))=CD Q 1
"RTN","GMRCSLM",150,0)
 Q 0
"RTN","GMRCSLM",151,0)
END K DIR,GMRCERR,Y
"RTN","GMRCSLM",152,0)
 Q
"RTN","GMRCSPD")
0^1^B2365789
"RTN","GMRCSPD",1,0)
GMRCSPD ;SLC/DCM,JFR - Change Date Range in CSLT Tracking Module ;9/20/99  14:21
"RTN","GMRCSPD",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**1,14**;DEC 27, 1997
"RTN","GMRCSPD",3,0)
EN ;START HERE
"RTN","GMRCSPD",4,0)
 N DTOUT,DIR,DUOUT,DIRUT,X,Y,GMRCDTS1,GMRCDTS2
"RTN","GMRCSPD",5,0)
 I $D(GMRCDT1)&($D(GMRCDT2)) D DTSAV
"RTN","GMRCSPD",6,0)
EN1 S DIR(0)="FA^1:45",DIR("A")="List From Starting Date: "
"RTN","GMRCSPD",7,0)
 S DIR("B")="ALL DATES" D ^DIR
"RTN","GMRCSPD",8,0)
 I $D(DUOUT)!($D(DTOUT)) D DTRES S GMRCQUT=1 Q
"RTN","GMRCSPD",9,0)
 S GMRCDT1=$$CHECK(X) I 'GMRCDT1,GMRCDT1'="ALL" G EN1
"RTN","GMRCSPD",10,0)
 I GMRCDT1="ALL" S GMRCDT2=0 Q
"RTN","GMRCSPD",11,0)
 K DIR
"RTN","GMRCSPD",12,0)
 S DIR(0)="DA^::E",DIR("A")="List To This Ending Date: " D ^DIR
"RTN","GMRCSPD",13,0)
 I $D(DTOUT)!($D(DUOUT)) K GMRCDT1 D DTRES S GMRCQUT=1 Q
"RTN","GMRCSPD",14,0)
 I +Y<GMRCDT1 S GMRCDT2=GMRCDT1,GMRCDT1=+Y
"RTN","GMRCSPD",15,0)
 S:'$D(GMRCDT2) GMRCDT2=+Y
"RTN","GMRCSPD",16,0)
 I $D(GMRC("NMBR")) D RESET^GMRCSLMV(GMRC("NMBR")) K GMRC("NMBR")
"RTN","GMRCSPD",17,0)
 Q
"RTN","GMRCSPD",18,0)
DTSAV ;Save old dates in case user '^'s out.
"RTN","GMRCSPD",19,0)
 I $D(GMRCDT1),$S(GMRCDT1>0:1,GMRCDT1="ALL":1,1:0) S GMRCDTS1=GMRCDT1,GMRCDT1=""
"RTN","GMRCSPD",20,0)
 I $D(GMRCDT2),GMRCDT2>0 S GMRCDTS2=GMRCDT2
"RTN","GMRCSPD",21,0)
 Q
"RTN","GMRCSPD",22,0)
DTRES ;Restore old date in case user '^' out.
"RTN","GMRCSPD",23,0)
 I $D(GMRCDTS1) S GMRCDT1=GMRCDTS1
"RTN","GMRCSPD",24,0)
 I $D(GMRCDTS2) S GMRCDT2=GMRCDTS2
"RTN","GMRCSPD",25,0)
 K GMRCDTS1,GMRCDTS2 Q
"RTN","GMRCSPD",26,0)
CHECK(GMRCDAT) ;CHECK FREE TEXT INPUT 
"RTN","GMRCSPD",27,0)
 N %DT,X,Y
"RTN","GMRCSPD",28,0)
 ;I "ALL DATES"[$$UP^XLFSTR(GMRCDAT) Q "ALL"
"RTN","GMRCSPD",29,0)
 I $E("ALL DATES",1,$L(GMRCDAT))=$$UP^XLFSTR(GMRCDAT) Q "ALL"
"RTN","GMRCSPD",30,0)
 S %DT="E",X=GMRCDAT D ^%DT I Y<1 Q 0
"RTN","GMRCSPD",31,0)
 Q +Y
"RTN","GMRCTIUE")
0^5^B32513033
"RTN","GMRCTIUE",1,0)
GMRCTIUE ;SLC/DCM,DLT - Complete/Update TIU notes ;7/16/98  02:10
"RTN","GMRCTIUE",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,10,14**;DEC 27, 1997
"RTN","GMRCTIUE",3,0)
ENTER(GMRCO) ; Enter a note in TIU for the consult result
"RTN","GMRCTIUE",4,0)
 ;If consult from list is defined in GMRCO, than use it.
"RTN","GMRCTIUE",5,0)
 K GMRCQUT N TIUDA,TIUCLASS,GMRCLCK
"RTN","GMRCTIUE",6,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)
"RTN","GMRCTIUE",7,0)
 Q:$D(GMRCQUT)!'$L($G(GMRCO))
"RTN","GMRCTIUE",8,0)
 I '$$LOCK^GMRCA1(GMRCO) D EDEX Q  ;JFR
"RTN","GMRCTIUE",9,0)
 S GMRCLCK=1
"RTN","GMRCTIUE",10,0)
 D CHKSTS I $G(GMRCQUT) D EDEX Q
"RTN","GMRCTIUE",11,0)
 I $D(VALM) D FULL^VALM1
"RTN","GMRCTIUE",12,0)
 ;
"RTN","GMRCTIUE",13,0)
 ;If service administrative user, then use administrative complete logic
"RTN","GMRCTIUE",14,0)
 I $$VALID^GMRCAU($P(^GMR(123,GMRCO,0),U,5))=3 D  Q
"RTN","GMRCTIUE",15,0)
 . D COMP^GMRCAAC(+GMRCO)
"RTN","GMRCTIUE",16,0)
 . D EDEX
"RTN","GMRCTIUE",17,0)
 ;
"RTN","GMRCTIUE",18,0)
 ;Assume the user is a clinical user
"RTN","GMRCTIUE",19,0)
 ;Get list of notes If no new notes, add new then quit
"RTN","GMRCTIUE",20,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCTIUE",21,0)
 I '$$GETLIST(GMRCDFN,GMRCO,.GMRCTIUC) D NEW,EDEX Q
"RTN","GMRCTIUE",22,0)
 ;
"RTN","GMRCTIUE",23,0)
 ;If single TIU doc. exists, use single record edit/add new, and quit
"RTN","GMRCTIUE",24,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",25,0)
 I GMRCTIUC(GMRCVF)=1 D  Q
"RTN","GMRCTIUE",26,0)
 . N DIR,X,Y,DTOUT,DUOUT
"RTN","GMRCTIUE",27,0)
 . D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",28,0)
 . S DIR(0)="YA",DIR("B")="Yes",DIR("A")="Edit/Review this note? "
"RTN","GMRCTIUE",29,0)
 . D ^DIR I Y>0 D
"RTN","GMRCTIUE",30,0)
 .. S GMRCTUFN=$$SINGLE(GMRCVF)
"RTN","GMRCTIUE",31,0)
 .. I +GMRCTUFN D EDITNOTE(GMRCTUFN)
"RTN","GMRCTIUE",32,0)
 . S DIR("B")="No",DIR("A")="Would you like to enter a new note? "
"RTN","GMRCTIUE",33,0)
 . W ! D ^DIR I Y>0 D NEW
"RTN","GMRCTIUE",34,0)
 . D EDEX
"RTN","GMRCTIUE",35,0)
 . Q
"RTN","GMRCTIUE",36,0)
 ;
"RTN","GMRCTIUE",37,0)
 ;Show the list of multiple tiu results for selection
"RTN","GMRCTIUE",38,0)
 D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",39,0)
 ;
"RTN","GMRCTIUE",40,0)
 ;Select a note from the list and then get the TIU internal entry
"RTN","GMRCTIUE",41,0)
 S GMRCSELR=$$SELR^GMRCTIUL(.GMRCTIUC)
"RTN","GMRCTIUE",42,0)
 I $D(GMRCQUT) D EDEX Q
"RTN","GMRCTIUE",43,0)
 I '+(GMRCSELR) D  D EDEX Q
"RTN","GMRCTIUE",44,0)
 . ;didn't select existing note, allow a new entry
"RTN","GMRCTIUE",45,0)
 . N DIR,X,Y
"RTN","GMRCTIUE",46,0)
 . S DIR(0)="Y",DIR("A")="Would you like to enter a new note"
"RTN","GMRCTIUE",47,0)
 . S DIR("B")="N" D ^DIR
"RTN","GMRCTIUE",48,0)
 . I Y<1 K DTOUT,DUOUT,X,Y Q
"RTN","GMRCTIUE",49,0)
 . D NEW
"RTN","GMRCTIUE",50,0)
 S GMRCTUFN=$$GETTUFN(GMRCSELR)
"RTN","GMRCTIUE",51,0)
 ;
"RTN","GMRCTIUE",52,0)
 I +GMRCTUFN D EDITNOTE(GMRCTUFN)
"RTN","GMRCTIUE",53,0)
 ;
"RTN","GMRCTIUE",54,0)
 D EDEX
"RTN","GMRCTIUE",55,0)
 Q
"RTN","GMRCTIUE",56,0)
 ;
"RTN","GMRCTIUE",57,0)
SAUSER() ; admin user?
"RTN","GMRCTIUE",58,0)
 N GMRCSS,GMRCADUS
"RTN","GMRCTIUE",59,0)
 S GMRCSS=+$P($G(^GMR(123,+GMRCO,0)),"^",5) Q:'+GMRCSS 0
"RTN","GMRCTIUE",60,0)
 I $D(^GMR(123.5,+$P($G(^GMR(123,+GMRCO,0)),"^",5),123.33,"B",DUZ)) Q 1
"RTN","GMRCTIUE",61,0)
 I '$L($TEXT(VALIDU^GMRCAU)) Q 0
"RTN","GMRCTIUE",62,0)
 S GMRCADUS=0
"RTN","GMRCTIUE",63,0)
 I $L($TEXT(VALIDU^GMRCAU)) D TEAM^GMRCAU(.GMRCADUS,123.34,DUZ)
"RTN","GMRCTIUE",64,0)
 Q +GMRCADUS
"RTN","GMRCTIUE",65,0)
 ;
"RTN","GMRCTIUE",66,0)
CHKSTS ;Check the order status before allowing entry of a note
"RTN","GMRCTIUE",67,0)
 N STATUS S STATUS=$P($G(^GMR(123,+GMRCO,0)),"^",12)
"RTN","GMRCTIUE",68,0)
 I $S(STATUS=1:1,STATUS=13:1,1:0) D
"RTN","GMRCTIUE",69,0)
 . W !,"This order has been "
"RTN","GMRCTIUE",70,0)
 . W $S(STATUS=1:"DISCONTINUED",1:"CANCELLED")
"RTN","GMRCTIUE",71,0)
 . W ".  A note cannot be entered."
"RTN","GMRCTIUE",72,0)
 . D PAUSE S GMRCQUT=1
"RTN","GMRCTIUE",73,0)
 Q
"RTN","GMRCTIUE",74,0)
 ;
"RTN","GMRCTIUE",75,0)
EDITNOTE(GMRCTUFN) ;use TIU LM for an existing note
"RTN","GMRCTIUE",76,0)
 I +$D(^TIU(8925,+GMRCTUFN,0)) D  Q
"RTN","GMRCTIUE",77,0)
 . D EXSTNOTE^TIUBR1(+GMRCDFN,+GMRCTUFN)
"RTN","GMRCTIUE",78,0)
 ;
"RTN","GMRCTIUE",79,0)
 ; link is missing
"RTN","GMRCTIUE",80,0)
 W !,"A note #"_+GMRCTUFN_" is linked to the consult,"
"RTN","GMRCTIUE",81,0)
 W !,"  but the note is no longer in TIU!"
"RTN","GMRCTIUE",82,0)
 D PAUSE
"RTN","GMRCTIUE",83,0)
 Q
"RTN","GMRCTIUE",84,0)
 ;
"RTN","GMRCTIUE",85,0)
SINGLE(GMRCVF) ;Get the single result entry from the list for the file type
"RTN","GMRCTIUE",86,0)
 N RSLT,GMRCVP
"RTN","GMRCTIUE",87,0)
 S RSLT="",GMRCVP=0
"RTN","GMRCTIUE",88,0)
 F  S RSLT=$O(^TMP("GMRC50",$J,RSLT)) Q:RSLT=""  D  Q:+GMRCVP
"RTN","GMRCTIUE",89,0)
 . I $P(RSLT,";",2)=GMRCVF S GMRCVP=RSLT
"RTN","GMRCTIUE",90,0)
 Q +GMRCVP
"RTN","GMRCTIUE",91,0)
 ;
"RTN","GMRCTIUE",92,0)
GETTUFN(GMRCSELR) ;Get the result entry from the selected entry
"RTN","GMRCTIUE",93,0)
 N RSLT
"RTN","GMRCTIUE",94,0)
 S RSLT=$O(^TMP("GMRC50R",$J,GMRCSELR,""))
"RTN","GMRCTIUE",95,0)
 Q RSLT
"RTN","GMRCTIUE",96,0)
 ;
"RTN","GMRCTIUE",97,0)
NEW ;Enter a new result through TIU if implemented or old Completion logic
"RTN","GMRCTIUE",98,0)
 S TIUCLASS=+$$CLASS
"RTN","GMRCTIUE",99,0)
 I TIUCLASS'>0 D  Q
"RTN","GMRCTIUE",100,0)
 . W !!,$C(7),"Consult Resulting through TIU is not yet implemented."
"RTN","GMRCTIUE",101,0)
 . W !,"Proceeding with Administrative Complete."
"RTN","GMRCTIUE",102,0)
 . D COMP^GMRCAAC(+GMRCO)
"RTN","GMRCTIUE",103,0)
 ;
"RTN","GMRCTIUE",104,0)
 D MAIN^TIUEDIT(TIUCLASS,.GMRCTIDA,GMRCDFN,"","","","",1)
"RTN","GMRCTIUE",105,0)
 ;
"RTN","GMRCTIUE",106,0)
 ;If TIU returns TIUDA, than update file 123
"RTN","GMRCTIUE",107,0)
 ;I +$G(TIUDA),$D(^TIU(8925,+$G(TIUDA),0)) D ADD^GMRCTIUA(+TIUDA,GMRCO)
"RTN","GMRCTIUE",108,0)
 Q
"RTN","GMRCTIUE",109,0)
 ;
"RTN","GMRCTIUE",110,0)
CLASS() ; What is the TIU Class (or Document Class) for CONSULTS
"RTN","GMRCTIUE",111,0)
 N GMRCY
"RTN","GMRCTIUE",112,0)
 S GMRCY=+$O(^TIU(8925.1,"B","CONSULTS",0))
"RTN","GMRCTIUE",113,0)
 I +GMRCY>0,$S($P($G(^TIU(8925.1,+GMRCY,0)),U,4)="CL":0,$P($G(^(0)),U,4)="DC":0,1:1) S GMRCY=0
"RTN","GMRCTIUE",114,0)
 Q GMRCY
"RTN","GMRCTIUE",115,0)
 ;
"RTN","GMRCTIUE",116,0)
GETLIST(GMRCDFN,GMRCO,GMRCLIST) ;
"RTN","GMRCTIUE",117,0)
 ;
"RTN","GMRCTIUE",118,0)
 N GMRCVF
"RTN","GMRCTIUE",119,0)
 ;
"RTN","GMRCTIUE",120,0)
 D GETLIST^GMRCTIUL(GMRCO,2,1,.GMRCTIUC)
"RTN","GMRCTIUE",121,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",122,0)
 Q +$G(GMRCTIUC(GMRCVF))
"RTN","GMRCTIUE",123,0)
 ;
"RTN","GMRCTIUE",124,0)
ADDEND(GMRCO) ; Make an addendum action for a selected consult
"RTN","GMRCTIUE",125,0)
 N TIUDA,GMRCTX,GMRCDFN,GMRCADUZ,RSLTINFO,GMRCACT,GMRCTIUC,GMRCLCK
"RTN","GMRCTIUE",126,0)
 K GMRCQUT
"RTN","GMRCTIUE",127,0)
 I '$L($G(GMRCO)) D SELECT^GMRCA2(.GMRCO)
"RTN","GMRCTIUE",128,0)
 Q:$D(GMRCQUT)!'+($G(GMRCO))
"RTN","GMRCTIUE",129,0)
 ;
"RTN","GMRCTIUE",130,0)
 ;If service administrative user, then QUIT.
"RTN","GMRCTIUE",131,0)
 I $$VALID^GMRCAU($P(^GMR(123,+GMRCO,0),U,5))=3 D  Q
"RTN","GMRCTIUE",132,0)
 . D EXAC^GMRCADC("You do not have the ability to edit this note.")
"RTN","GMRCTIUE",133,0)
 ;
"RTN","GMRCTIUE",134,0)
 ;Assume the user is a clinical user
"RTN","GMRCTIUE",135,0)
 ;
"RTN","GMRCTIUE",136,0)
 ;Get list of notes for this consult. if no notes, then quit.
"RTN","GMRCTIUE",137,0)
 S GMRCDFN=$P(^GMR(123,+GMRCO,0),"^",2)
"RTN","GMRCTIUE",138,0)
 I '$$GETLIST(GMRCDFN,+GMRCO,.GMRCTIUC) D  Q
"RTN","GMRCTIUE",139,0)
 . W !,"This consult does not yet have an associated note."
"RTN","GMRCTIUE",140,0)
 . W !,"  Use the Complete action to enter a new note."
"RTN","GMRCTIUE",141,0)
 . D PAUSE,EDEX
"RTN","GMRCTIUE",142,0)
 ;
"RTN","GMRCTIUE",143,0)
 I '$$LOCK^GMRCA1(GMRCO) D EDEX Q  ;JFR
"RTN","GMRCTIUE",144,0)
 S GMRCLCK=1
"RTN","GMRCTIUE",145,0)
 ;If TIU Document already exists, use single record edit, and quit
"RTN","GMRCTIUE",146,0)
 S GMRCVF="TIU(8925,"
"RTN","GMRCTIUE",147,0)
 I GMRCTIUC(GMRCVF)=1 D  D EDEX Q
"RTN","GMRCTIUE",148,0)
 . S GMRCTUFN=$$SINGLE(GMRCVF)
"RTN","GMRCTIUE",149,0)
 . Q:'+GMRCTUFN
"RTN","GMRCTIUE",150,0)
 . D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",151,0)
 . N GMRCVP,RSLTINFO,AUTHOR
"RTN","GMRCTIUE",152,0)
 . S GMRCVP=+GMRCTUFN_";"_GMRCVF
"RTN","GMRCTIUE",153,0)
 . S RSLTIEN=$O(^TMP("GMRC50",$J,GMRCVP,0))
"RTN","GMRCTIUE",154,0)
 . S RSLTINFO=$G(^TMP("GMRC50",$J,GMRCVP,RSLTIEN))
"RTN","GMRCTIUE",155,0)
 . I $P(RSLTINFO,"^",6)="completed" D ADDEND1(+GMRCTUFN) Q
"RTN","GMRCTIUE",156,0)
 . I (DUZ=+$P(RSLTINFO,"^",4)) D EDITNOTE(+GMRCTUFN) Q
"RTN","GMRCTIUE",157,0)
 . W !,"You may not addend to the incomplete associated note."
"RTN","GMRCTIUE",158,0)
 . W !,"You are not the author of the existing note."
"RTN","GMRCTIUE",159,0)
 . I $$READ^GMRCACMT("Y","Do you want to add a new note ","YES") D NEW
"RTN","GMRCTIUE",160,0)
 . Q
"RTN","GMRCTIUE",161,0)
 ;
"RTN","GMRCTIUE",162,0)
 ;Show the list of multiple tiu results for selection
"RTN","GMRCTIUE",163,0)
 D SHOWTIU^GMRCTIUL
"RTN","GMRCTIUE",164,0)
 ;
"RTN","GMRCTIUE",165,0)
 ;Select a note from the list and then get the TIU internal entry
"RTN","GMRCTIUE",166,0)
 S GMRCSELR=$$SELR^GMRCTIUL(.GMRCTIUC)
"RTN","GMRCTIUE",167,0)
 I $D(GMRCQUT)!'+(GMRCSELR) D EDEX Q
"RTN","GMRCTIUE",168,0)
 S GMRCTUFN=$$GETTUFN(GMRCSELR)
"RTN","GMRCTIUE",169,0)
 ;
"RTN","GMRCTIUE",170,0)
 I +GMRCTUFN D ADDEND1(+GMRCTUFN),EDEX Q  ;JFR
"RTN","GMRCTIUE",171,0)
 ;
"RTN","GMRCTIUE",172,0)
 D EDEX
"RTN","GMRCTIUE",173,0)
 Q
"RTN","GMRCTIUE",174,0)
ADDEND1(TIUDA) ;Add an addendum
"RTN","GMRCTIUE",175,0)
 ;
"RTN","GMRCTIUE",176,0)
 D FULL^VALM1,ADDEND1^TIURA1
"RTN","GMRCTIUE",177,0)
 Q
"RTN","GMRCTIUE",178,0)
 ;
"RTN","GMRCTIUE",179,0)
EDEX ;
"RTN","GMRCTIUE",180,0)
 I $G(GMRCLCK) D UNLOCK^GMRCA1(GMRCO) ;JFR
"RTN","GMRCTIUE",181,0)
 K GMRCDFN,GMRCO,GMRCQUT,GMRCTUFN,GMRCSEL
"RTN","GMRCTIUE",182,0)
 Q
"RTN","GMRCTIUE",183,0)
 ;
"RTN","GMRCTIUE",184,0)
PAUSE ; Pause for user
"RTN","GMRCTIUE",185,0)
 ;
"RTN","GMRCTIUE",186,0)
 N X W !,"Press <RETURN> to continue: " R X:DTIME E  W " (timeout)"
"RTN","GMRCTIUE",187,0)
 Q
"RTN","GMRCTIUE",188,0)
 ;
"RTN","GMRCTIUL")
0^6^B15878994
"RTN","GMRCTIUL",1,0)
GMRCTIUL ;SLC/DCM,DLT - Get list of existing results for consults ;5/01/98  10:09
"RTN","GMRCTIUL",2,0)
 ;;3.0;CONSULT/REQUEST TRACKING;**4,14**;DEC 27, 1997
"RTN","GMRCTIUL",3,0)
GETLIST(GMRCO,GETWHAT,TYPE,GMRCNT) ;Get the count and list of results
"RTN","GMRCTIUL",4,0)
 ;Input variables:
"RTN","GMRCTIUL",5,0)
 ;GMRCO=consult entry from 123
"RTN","GMRCTIUL",6,0)
 ;GETWHAT=how much to return
"RTN","GMRCTIUL",7,0)
 ;       0 = count only returned
"RTN","GMRCTIUL",8,0)
 ;       1 = count + ^TMP internal values from TIU
"RTN","GMRCTIUL",9,0)
 ;       2 = count + ^TMP internal values from TIU
"RTN","GMRCTIUL",10,0)
 ;                 + ^TMP display format array
"RTN","GMRCTIUL",11,0)
 ;TYPE=what type of results to return
"RTN","GMRCTIUL",12,0)
 ;       0=all types
"RTN","GMRCTIUL",13,0)
 ;       1=TIU only
"RTN","GMRCTIUL",14,0)
 ;       2=Medicine results only
"RTN","GMRCTIUL",15,0)
 ;returns GMRCNT() = result count
"RTN","GMRCTIUL",16,0)
 ;        ^TMP("GMRC50",$J,GMRCRVP,GMRCRIEN)=summary data from source
"RTN","GMRCTIUL",17,0)
 ;             where GMRCRVP is the variable pointer value
"RTN","GMRCTIUL",18,0)
 ;             where GMRCRIEN is the entry in the 50th node
"RTN","GMRCTIUL",19,0)
 ;        ^TMP("GMRC50R",$J,GMRCRIEN)= external list for review
"RTN","GMRCTIUL",20,0)
 N COUNT,GMRCRIEN,TAB
"RTN","GMRCTIUL",21,0)
 K ^TMP("GMRC50",$J),^TMP("GMRC50R",$J),GMRCNT
"RTN","GMRCTIUL",22,0)
 S (COUNT,GMRCRIEN)=0,GMRCNT(0)=COUNT
"RTN","GMRCTIUL",23,0)
 S TAB="",$P(TAB," ",30)=""
"RTN","GMRCTIUL",24,0)
 ;Get results from the result multiple
"RTN","GMRCTIUL",25,0)
 F  S GMRCRIEN=$O(^GMR(123,+GMRCO,50,GMRCRIEN)) Q:'GMRCRIEN  D  I $G(GMRCQUT) K GMRCQUT Q
"RTN","GMRCTIUL",26,0)
 . S GMRCRVP=$P($G(^GMR(123,+GMRCO,50,+GMRCRIEN,0)),"^",1) I GMRCRVP="" S GMRCQUT=1 Q
"RTN","GMRCTIUL",27,0)
 . D UPDCNT
"RTN","GMRCTIUL",28,0)
 . Q
"RTN","GMRCTIUL",29,0)
 ;Get TIU NARRATIVE RESULT if the result multiple is not loaded yet
"RTN","GMRCTIUL",30,0)
 I COUNT=0,'$D(^GMR(123,+GMRCO,50)),+$P(^GMR(123,+GMRCO,0),"^",20) D
"RTN","GMRCTIUL",31,0)
 . S GMRCRVP=$P($G(^GMR(123,+GMRCO,0)),"^",20)_";TIU(8925,"
"RTN","GMRCTIUL",32,0)
 . D UPDCNT
"RTN","GMRCTIUL",33,0)
 . Q
"RTN","GMRCTIUL",34,0)
 S GMRCNT(0)=COUNT
"RTN","GMRCTIUL",35,0)
 Q
"RTN","GMRCTIUL",36,0)
 ;
"RTN","GMRCTIUL",37,0)
UPDCNT ;Update count of existing results for the consult and build array
"RTN","GMRCTIUL",38,0)
 S GMRCVF=$P(GMRCRVP,";",2)
"RTN","GMRCTIUL",39,0)
 I '$G(GMRCNT(GMRCVF)) S GMRCNT(GMRCVF)=0
"RTN","GMRCTIUL",40,0)
 S COUNT=COUNT+1
"RTN","GMRCTIUL",41,0)
 S GMRCNT(GMRCVF)=GMRCNT(GMRCVF)+1
"RTN","GMRCTIUL",42,0)
 I +GETWHAT,TYPE=1 D TIUTMP(+GETWHAT)
"RTN","GMRCTIUL",43,0)
 Q
"RTN","GMRCTIUL",44,0)
 ;
"RTN","GMRCTIUL",45,0)
TIUTMP(GETWHAT) ;build ^TMP array for results based on TIU when type=1
"RTN","GMRCTIUL",46,0)
 I '$D(^TIU(8925,+$G(GMRCRVP),0)) D  Q
"RTN","GMRCTIUL",47,0)
 .W !,"Associated note ",+$G(GMRCRVP)," is no longer defined in TIU."
"RTN","GMRCTIUL",48,0)
 .S COUNT=COUNT-1
"RTN","GMRCTIUL",49,0)
 .S GMRCNT(GMRCVF)=GMRCNT(GMRCVF)-1
"RTN","GMRCTIUL",50,0)
 S ^TMP("GMRC50",$J,GMRCRVP,COUNT)=$$RESOLVE^TIUSRVLO(+GMRCRVP)
"RTN","GMRCTIUL",51,0)
 Q:GETWHAT=1  ;get internal value global
"RTN","GMRCTIUL",52,0)
 N GMRCRDAT,GMRCDOCT,GMRCEDT,GMRCAUTH,GMRCSTS,GMRCTX
"RTN","GMRCTIUL",53,0)
 S GMRCRDAT=^TMP("GMRC50",$J,GMRCRVP,COUNT)
"RTN","GMRCTIUL",54,0)
 S GMRCDOCT=$E($P(GMRCRDAT,"^",1),1,19)
"RTN","GMRCTIUL",55,0)
 S GMRCEDT=$$FMTE^XLFDT($P(GMRCRDAT,U,2),"D")
"RTN","GMRCTIUL",56,0)
 S GMRCAUTH=$E($P($G(^VA(200,+$P(GMRCRDAT,"^",4),0)),U,1),1,12)
"RTN","GMRCTIUL",57,0)
 S GMRCSTS=$E($P(GMRCRDAT,"^",6),1,5)
"RTN","GMRCTIUL",58,0)
 S GMRCTX=$J(COUNT,3)_"> "_$E(GMRCDOCT_TAB,1,20)_$E("#"_+GMRCRVP_TAB,1,9)_$E(GMRCEDT_TAB,1,13)_$E(GMRCAUTH_TAB,1,14)_$E(GMRCSTS_TAB,1,6)_$E("#"_+$P(GMRCRDAT,"^",9)_TAB,1,10)
"RTN","GMRCTIUL",59,0)
 S ^TMP("GMRC50R",$J,COUNT,GMRCRVP)=GMRCTX
"RTN","GMRCTIUL",60,0)
 Q
"RTN","GMRCTIUL",61,0)
 ;
"RTN","GMRCTIUL",62,0)
PROCTMP ;build ^TMP array for procedure results when type note=1
"RTN","GMRCTIUL",63,0)
 Q:TYPE=1
"RTN","GMRCTIUL",64,0)
 Q
"RTN","GMRCTIUL",65,0)
 ;
"RTN","GMRCTIUL",66,0)
SHOWTIU ;Display the current TIU results available
"RTN","GMRCTIUL",67,0)
 N GMRCVP,GMRCRCT
"RTN","GMRCTIUL",68,0)
 W !,"Notes associated with this consult:",!
"RTN","GMRCTIUL",69,0)
 W !," No.  Document Title       TIU    Entered      Author        Sts  Consult"
"RTN","GMRCTIUL",70,0)
 S GMRCRCT=0
"RTN","GMRCTIUL",71,0)
 F  S GMRCRCT=$O(^TMP("GMRC50R",$J,GMRCRCT)) Q:'+GMRCRCT  D
"RTN","GMRCTIUL",72,0)
 . S GMRCRVP=$O(^TMP("GMRC50R",$J,GMRCRCT,""))
"RTN","GMRCTIUL",73,0)
 . W !,^TMP("GMRC50R",$J,GMRCRCT,GMRCRVP)
"RTN","GMRCTIUL",74,0)
 Q
"RTN","GMRCTIUL",75,0)
SELR(GMRCRCT) ;Select a note from the list
"RTN","GMRCTIUL",76,0)
 ;Input GMRCNT=array with the count of TIU notes
"RTN","GMRCTIUL",77,0)
 I '+$G(GMRCRCT("TIU(8925,")),'+$O(^TMP("GMRC50R",$J,0)) S GMRCMSG="No results available" D EXAC^GMRCADC(GMRCMSG) K GMRCMSG Q 0
"RTN","GMRCTIUL",78,0)
 ;Select a note
"RTN","GMRCTIUL",79,0)
 N DIR,Y,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","GMRCTIUL",80,0)
 S DIR("A")="Select an existing note"
"RTN","GMRCTIUL",81,0)
 S DIR(0)="NO^1:"_GMRCRCT("TIU(8925,")
"RTN","GMRCTIUL",82,0)
 D ^DIR
"RTN","GMRCTIUL",83,0)
 Q +Y
"RTN","GMRCTIUL",84,0)
LN1 ;Used by filemanager print template to format line
"RTN","GMRCTIUL",85,0)
 S:'$G(COUNT) COUNT=1
"RTN","GMRCTIUL",86,0)
 S GMRCVF="TIU(8925,",GMRCNT(GMRCVF)=1,TAB=" "
"RTN","GMRCTIUL",87,0)
 S GMRCRVP=+($G(^GMR(123,D0,50,D1,0)))
"RTN","GMRCTIUL",88,0)
 Q:'GMRCRVP
"RTN","GMRCTIUL",89,0)
 N GMRCDOCT,GMRCEDT
"RTN","GMRCTIUL",90,0)
 S GMRCRDAT=$$RESOLVE^TIUSRVLO(+GMRCRVP)
"RTN","GMRCTIUL",91,0)
 S GMRCDOCT=$E($P(GMRCRDAT,"^",1),1,19)
"RTN","GMRCTIUL",92,0)
 S GMRCEDT=$$FMTE^XLFDT(GMRCRDAT,"D")
"RTN","GMRCTIUL",93,0)
 S GMRCTX=$E("#"_+GMRCRVP_TAB,1,9)_$E(GMRCDOCT_TAB,1,22)_$E(GMRCEDT_TAB,1,13)_$P(GMRCRDAT,U,3)
"RTN","GMRCTIUL",94,0)
 W GMRCTX
"RTN","GMRCTIUL",95,0)
 Q
"RTN","GMRCTIUL",96,0)
LN2 ;Used by Fileman to write second line
"RTN","GMRCTIUL",97,0)
 N GMRCAUTH,GMRCSTS
"RTN","GMRCTIUL",98,0)
 S GMRCAUTH=$E($P($G(^VA(200,+$P(GMRCRDAT,"^",4),0)),U,1),1,12)
"RTN","GMRCTIUL",99,0)
 S GMRCSTS=$E($P(GMRCRDAT,"^",6),1,5)
"RTN","GMRCTIUL",100,0)
 S GMRCTX=$E(TAB,1,5)_$E("Author: "_GMRCAUTH_TAB,1,16)_$E(GMRCSTS_TAB,1,8)_$E("#"_+$P(GMRCRDAT,"^",9)_TAB,1,10)
"RTN","GMRCTIUL",101,0)
 W GMRCTX
"RTN","GMRCTIUL",102,0)
 Q
"RTN","GMRCTIUL",103,0)
 ;
"VER")
8.0^22.0
**END**
**END**
