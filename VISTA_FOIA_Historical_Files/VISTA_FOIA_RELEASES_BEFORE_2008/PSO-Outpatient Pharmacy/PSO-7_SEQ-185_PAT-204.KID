Released PSO*7*204 SEQ #185
Extracted from mail message
**KIDS**:PSO*7.0*204^

**INSTALL NAME**
PSO*7.0*204
"BLD",5357,0)
PSO*7.0*204^OUTPATIENT PHARMACY^0^3050802^y
"BLD",5357,1,0)
^^56^56^3050614^
"BLD",5357,1,1,0)
1. My HealtheVet team in preparation for the My HealtyVet V. 1.0
"BLD",5357,1,2,0)
    package (Internet Prescription Refill project), requested an
"BLD",5357,1,3,0)
    additional Outpatient Pharmacy V. 7.0 Application Program Interface
"BLD",5357,1,4,0)
    (API) #4687, to provide details of all (active, verified, on hold,
"BLD",5357,1,5,0)
    suspended, discontinued, pending and expired), prescriptions for a
"BLD",5357,1,6,0)
    patient within a given date.
"BLD",5357,1,7,0)
 
"BLD",5357,1,8,0)
 2. Also the existing API #3768 has been modified to provide the following
"BLD",5357,1,9,0)
    status for Internet refill requests (used internally):
"BLD",5357,1,10,0)
 
"BLD",5357,1,11,0)
    Calling AP1 component will return the following status:
"BLD",5357,1,12,0)
 
"BLD",5357,1,13,0)
   -5      DFN does not match RX
"BLD",5357,1,14,0)
   -4      Unable to resolve patient
"BLD",5357,1,15,0)
   -3      Unable to resolve prescription
"BLD",5357,1,16,0)
   -2      Status is pending
"BLD",5357,1,17,0)
   -1      Result is back but not picked up
"BLD",5357,1,18,0)
    0      Other error
"BLD",5357,1,19,0)
    1      Filed in PRESCRIPTION REFILL REQUEST file (#52.43)
"BLD",5357,1,20,0)
 
"BLD",5357,1,21,0)
    Calling AP2 component will return the following status:
"BLD",5357,1,22,0)
 
"BLD",5357,1,23,0)
    -6     RX not in file #52.43
"BLD",5357,1,24,0)
    -5     DFN does not match RX
"BLD",5357,1,25,0)
    -4     Unable to resolve patient
"BLD",5357,1,26,0)
    -3     Unable to resolve prescription
"BLD",5357,1,27,0)
    -2     Status is pending
"BLD",5357,1,28,0)
    -1     Result is back but not picked up
"BLD",5357,1,29,0)
     1     Filled
"BLD",5357,1,30,0)
     2     Not Filled
"BLD",5357,1,31,0)
     n^x   n - Date the refill request was processed.
"BLD",5357,1,32,0)
           x - The result of the processing. This will be either FILLED or
"BLD",5357,1,33,0)
               NOT FILLED.
"BLD",5357,1,34,0)
 
"BLD",5357,1,35,0)
     Calling AP5 component will return the following status:
"BLD",5357,1,36,0)
 
"BLD",5357,1,37,0)
     -6     RX not in file #52.43
"BLD",5357,1,38,0)
     -4     Unable to resolve patient
"BLD",5357,1,39,0)
     -3     Unable to resolve prescription
"BLD",5357,1,40,0)
     -2     Status is pending
"BLD",5357,1,41,0)
      0     The update was not successful. This will occur if any of the
"BLD",5357,1,42,0)
            information provided (DFN, RX #) are invalid.
"BLD",5357,1,43,0)
      1     The update was successful.
"BLD",5357,1,44,0)
 
"BLD",5357,1,45,0)
 3. A new PATIENT field (#9) was added to the PRESCRIPTION REFILL REQUEST
"BLD",5357,1,46,0)
    file (#52.43) that is a pointer to the PAITENT file (#2).  A new
"BLD",5357,1,47,0)
    "AC" cross reference was added, to index the file by PATIENT field
"BLD",5357,1,48,0)
    (#9) and PRESCRIPTION IEN field (#8). The existing "AA", and "AB"
"BLD",5357,1,49,0)
    cross references were removed.
"BLD",5357,1,50,0)
 
"BLD",5357,1,51,0)
 Note: This patch carries a Pre-install routine that will delete the
"BLD",5357,1,52,0)
 Data Dictionary (DD) of the PRESCRIPTION REFILL REQUEST file (#52.43)
"BLD",5357,1,53,0)
 before the install of the new DD. This file is not in use currently,
"BLD",5357,1,54,0)
 however, it will not destroy any data in the test systems.
"BLD",5357,1,55,0)
 For more details, please refer to the installation guide or the technical
"BLD",5357,1,56,0)
 manual of the My HealthyVet V. 1.0 package.
"BLD",5357,4,0)
^9.64PA^52.43^1
"BLD",5357,4,52.43,0)
52.43
"BLD",5357,4,52.43,222)
y^y^f^^^^n
"BLD",5357,4,"B",52.43,52.43)

"BLD",5357,"INI")
PRE^PSOP204
"BLD",5357,"INID")
^^y
"BLD",5357,"KRN",0)
^9.67PA^8989.52^19
"BLD",5357,"KRN",.4,0)
.4
"BLD",5357,"KRN",.401,0)
.401
"BLD",5357,"KRN",.402,0)
.402
"BLD",5357,"KRN",.403,0)
.403
"BLD",5357,"KRN",.5,0)
.5
"BLD",5357,"KRN",.84,0)
.84
"BLD",5357,"KRN",3.6,0)
3.6
"BLD",5357,"KRN",3.8,0)
3.8
"BLD",5357,"KRN",9.2,0)
9.2
"BLD",5357,"KRN",9.8,0)
9.8
"BLD",5357,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",5357,"KRN",9.8,"NM",1,0)
PSOPRA^^0^B11988419
"BLD",5357,"KRN",9.8,"NM",2,0)
PSOMHV1^^0^B72939156
"BLD",5357,"KRN",9.8,"NM",3,0)
PSOPRI^^0^B22681827
"BLD",5357,"KRN",9.8,"NM",4,0)
PSOP204^^0^B76917
"BLD",5357,"KRN",9.8,"NM",5,0)
PSOREF0^^0^B36318781
"BLD",5357,"KRN",9.8,"NM","B","PSOMHV1",2)

"BLD",5357,"KRN",9.8,"NM","B","PSOP204",4)

"BLD",5357,"KRN",9.8,"NM","B","PSOPRA",1)

"BLD",5357,"KRN",9.8,"NM","B","PSOPRI",3)

"BLD",5357,"KRN",9.8,"NM","B","PSOREF0",5)

"BLD",5357,"KRN",19,0)
19
"BLD",5357,"KRN",19.1,0)
19.1
"BLD",5357,"KRN",101,0)
101
"BLD",5357,"KRN",409.61,0)
409.61
"BLD",5357,"KRN",771,0)
771
"BLD",5357,"KRN",870,0)
870
"BLD",5357,"KRN",8989.51,0)
8989.51
"BLD",5357,"KRN",8989.52,0)
8989.52
"BLD",5357,"KRN",8994,0)
8994
"BLD",5357,"KRN","B",.4,.4)

"BLD",5357,"KRN","B",.401,.401)

"BLD",5357,"KRN","B",.402,.402)

"BLD",5357,"KRN","B",.403,.403)

"BLD",5357,"KRN","B",.5,.5)

"BLD",5357,"KRN","B",.84,.84)

"BLD",5357,"KRN","B",3.6,3.6)

"BLD",5357,"KRN","B",3.8,3.8)

"BLD",5357,"KRN","B",9.2,9.2)

"BLD",5357,"KRN","B",9.8,9.8)

"BLD",5357,"KRN","B",19,19)

"BLD",5357,"KRN","B",19.1,19.1)

"BLD",5357,"KRN","B",101,101)

"BLD",5357,"KRN","B",409.61,409.61)

"BLD",5357,"KRN","B",771,771)

"BLD",5357,"KRN","B",870,870)

"BLD",5357,"KRN","B",8989.51,8989.51)

"BLD",5357,"KRN","B",8989.52,8989.52)

"BLD",5357,"KRN","B",8994,8994)

"BLD",5357,"QUES",0)
^9.62^^
"BLD",5357,"REQB",0)
^9.611^2^2
"BLD",5357,"REQB",1,0)
PSO*7.0*151^2
"BLD",5357,"REQB",2,0)
PSO*7.0*186^2
"BLD",5357,"REQB","B","PSO*7.0*151",1)

"BLD",5357,"REQB","B","PSO*7.0*186",2)

"FIA",52.43)
PRESCRIPTION REFILL REQUEST
"FIA",52.43,0)
^PS(52.43,
"FIA",52.43,0,0)
52.43
"FIA",52.43,0,1)
y^y^f^^^^n
"FIA",52.43,0,10)

"FIA",52.43,0,11)

"FIA",52.43,0,"RLRO")

"FIA",52.43,0,"VR")
7.0^PSO
"FIA",52.43,52.43)
0
"INI")
PRE^PSOP204
"IX",52.43,52.43,"AC",0)
52.43^AC^XREF OF REFILL REQUESTS BY PATIENT & RX^MU^^R^IR^I^52.43^^^^^A
"IX",52.43,52.43,"AC",1)
S ^PS(52.43,"AC",X(1),X(2),DA)=""
"IX",52.43,52.43,"AC",2)
K ^PS(52.43,"AC",X(1),X(2),DA)
"IX",52.43,52.43,"AC",11.1,0)
^.114IA^2^2
"IX",52.43,52.43,"AC",11.1,1,0)
1^F^52.43^9^11^1^F
"IX",52.43,52.43,"AC",11.1,1,3)

"IX",52.43,52.43,"AC",11.1,2,0)
2^F^52.43^3^20^2^F
"IX",52.43,52.43,"AC",11.1,2,3)

"IX",52.43,52.43,"AINST",0)
52.43^AINST^QUEUE FOR PROCESSING REFILL REQUESTS^MU^^R^IR^I^52.43^^^^^A
"IX",52.43,52.43,"AINST",1)
S ^PS(52.43,"AINST",X(1),X(2),DA)=""
"IX",52.43,52.43,"AINST",2)
K ^PS(52.43,"AINST",X(1),X(2),DA)
"IX",52.43,52.43,"AINST",11.1,0)
^.114IA^2^2
"IX",52.43,52.43,"AINST",11.1,1,0)
1^F^52.43^4^^1^F
"IX",52.43,52.43,"AINST",11.1,2,0)
2^F^52.43^8^30^2^F
"IX",52.43,52.43,"AINST",11.1,2,3)

"MBREQ")
0
"PKG",141,-1)
1^1
"PKG",141,0)
OUTPATIENT PHARMACY^PSO^OUTPATIENT LABELS, PROFILE, INVENTORY, PRESCRIPTIONS
"PKG",141,20,0)
^9.402P^^
"PKG",141,22,0)
^9.49I^1^1
"PKG",141,22,1,0)
7.0^2971216^2980917^11712
"PKG",141,22,1,"PAH",1,0)
204^3050802^11863
"PKG",141,22,1,"PAH",1,1,0)
^^56^56^3050802
"PKG",141,22,1,"PAH",1,1,1,0)
1. My HealtheVet team in preparation for the My HealtyVet V. 1.0
"PKG",141,22,1,"PAH",1,1,2,0)
    package (Internet Prescription Refill project), requested an
"PKG",141,22,1,"PAH",1,1,3,0)
    additional Outpatient Pharmacy V. 7.0 Application Program Interface
"PKG",141,22,1,"PAH",1,1,4,0)
    (API) #4687, to provide details of all (active, verified, on hold,
"PKG",141,22,1,"PAH",1,1,5,0)
    suspended, discontinued, pending and expired), prescriptions for a
"PKG",141,22,1,"PAH",1,1,6,0)
    patient within a given date.
"PKG",141,22,1,"PAH",1,1,7,0)
 
"PKG",141,22,1,"PAH",1,1,8,0)
 2. Also the existing API #3768 has been modified to provide the following
"PKG",141,22,1,"PAH",1,1,9,0)
    status for Internet refill requests (used internally):
"PKG",141,22,1,"PAH",1,1,10,0)
 
"PKG",141,22,1,"PAH",1,1,11,0)
    Calling AP1 component will return the following status:
"PKG",141,22,1,"PAH",1,1,12,0)
 
"PKG",141,22,1,"PAH",1,1,13,0)
   -5      DFN does not match RX
"PKG",141,22,1,"PAH",1,1,14,0)
   -4      Unable to resolve patient
"PKG",141,22,1,"PAH",1,1,15,0)
   -3      Unable to resolve prescription
"PKG",141,22,1,"PAH",1,1,16,0)
   -2      Status is pending
"PKG",141,22,1,"PAH",1,1,17,0)
   -1      Result is back but not picked up
"PKG",141,22,1,"PAH",1,1,18,0)
    0      Other error
"PKG",141,22,1,"PAH",1,1,19,0)
    1      Filed in PRESCRIPTION REFILL REQUEST file (#52.43)
"PKG",141,22,1,"PAH",1,1,20,0)
 
"PKG",141,22,1,"PAH",1,1,21,0)
    Calling AP2 component will return the following status:
"PKG",141,22,1,"PAH",1,1,22,0)
 
"PKG",141,22,1,"PAH",1,1,23,0)
    -6     RX not in file #52.43
"PKG",141,22,1,"PAH",1,1,24,0)
    -5     DFN does not match RX
"PKG",141,22,1,"PAH",1,1,25,0)
    -4     Unable to resolve patient
"PKG",141,22,1,"PAH",1,1,26,0)
    -3     Unable to resolve prescription
"PKG",141,22,1,"PAH",1,1,27,0)
    -2     Status is pending
"PKG",141,22,1,"PAH",1,1,28,0)
    -1     Result is back but not picked up
"PKG",141,22,1,"PAH",1,1,29,0)
     1     Filled
"PKG",141,22,1,"PAH",1,1,30,0)
     2     Not Filled
"PKG",141,22,1,"PAH",1,1,31,0)
     n^x   n - Date the refill request was processed.
"PKG",141,22,1,"PAH",1,1,32,0)
           x - The result of the processing. This will be either FILLED or
"PKG",141,22,1,"PAH",1,1,33,0)
               NOT FILLED.
"PKG",141,22,1,"PAH",1,1,34,0)
 
"PKG",141,22,1,"PAH",1,1,35,0)
     Calling AP5 component will return the following status:
"PKG",141,22,1,"PAH",1,1,36,0)
 
"PKG",141,22,1,"PAH",1,1,37,0)
     -6     RX not in file #52.43
"PKG",141,22,1,"PAH",1,1,38,0)
     -4     Unable to resolve patient
"PKG",141,22,1,"PAH",1,1,39,0)
     -3     Unable to resolve prescription
"PKG",141,22,1,"PAH",1,1,40,0)
     -2     Status is pending
"PKG",141,22,1,"PAH",1,1,41,0)
      0     The update was not successful. This will occur if any of the
"PKG",141,22,1,"PAH",1,1,42,0)
            information provided (DFN, RX #) are invalid.
"PKG",141,22,1,"PAH",1,1,43,0)
      1     The update was successful.
"PKG",141,22,1,"PAH",1,1,44,0)
 
"PKG",141,22,1,"PAH",1,1,45,0)
 3. A new PATIENT field (#9) was added to the PRESCRIPTION REFILL REQUEST
"PKG",141,22,1,"PAH",1,1,46,0)
    file (#52.43) that is a pointer to the PAITENT file (#2).  A new
"PKG",141,22,1,"PAH",1,1,47,0)
    "AC" cross reference was added, to index the file by PATIENT field
"PKG",141,22,1,"PAH",1,1,48,0)
    (#9) and PRESCRIPTION IEN field (#8). The existing "AA", and "AB"
"PKG",141,22,1,"PAH",1,1,49,0)
    cross references were removed.
"PKG",141,22,1,"PAH",1,1,50,0)
 
"PKG",141,22,1,"PAH",1,1,51,0)
 Note: This patch carries a Pre-install routine that will delete the
"PKG",141,22,1,"PAH",1,1,52,0)
 Data Dictionary (DD) of the PRESCRIPTION REFILL REQUEST file (#52.43)
"PKG",141,22,1,"PAH",1,1,53,0)
 before the install of the new DD. This file is not in use currently,
"PKG",141,22,1,"PAH",1,1,54,0)
 however, it will not destroy any data in the test systems.
"PKG",141,22,1,"PAH",1,1,55,0)
 For more details, please refer to the installation guide or the technical
"PKG",141,22,1,"PAH",1,1,56,0)
 manual of the My HealthyVet V. 1.0 package.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","PSOMHV1")
0^2^B72939156
"RTN","PSOMHV1",1,0)
PSOMHV1 ;BIR/MHA - MHV API, Build patient medication ; 4/20/05 8:54am
"RTN","PSOMHV1",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**204**;DEC 1997
"RTN","PSOMHV1",3,0)
 ;External reference ^PS(55 supported by DBIA 2228
"RTN","PSOMHV1",4,0)
 ;External reference ^PSDRUG( supported by DBIA 221
"RTN","PSOMHV1",5,0)
 ;External reference to ^PS(51 supported by DBIA 2224
"RTN","PSOMHV1",6,0)
 ;External reference to ^PS(51.2 supported by DBIA 2226
"RTN","PSOMHV1",7,0)
 ;External reference to ^PS(50.7 supported by DBIA 2223
"RTN","PSOMHV1",8,0)
 ;External reference to ^PS(50.606 supported by DBIA 2174
"RTN","PSOMHV1",9,0)
 ; Input variables: dfn, start date, cut off date
"RTN","PSOMHV1",10,0)
EN(DFN,BDT,EDT) ;entry point to return medication list
"RTN","PSOMHV1",11,0)
 Q:'$G(DFN)
"RTN","PSOMHV1",12,0)
 N DRG,DRGN,EXD,I,IFN,MIG,LSTFD,ORD,PEN,PSOBD,PSOED,PSODD,PSOOI,PSOSD,RX,RX0,RX2,RX3,TFN,TD,TR,TRM,SC,SCH,ST0,STA,PSODIV
"RTN","PSOMHV1",13,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOMHV1",14,0)
 K ^TMP("PSO",$J) S PSOBD=$G(BDT),PSOED=$G(EDT)
"RTN","PSOMHV1",15,0)
 I +$G(PSOBD)<1 S X1=DT,X2=-120 D C^%DTC S PSOBD=X
"RTN","PSOMHV1",16,0)
 S EXD=PSOBD-1
"RTN","PSOMHV1",17,0)
 I PSOED="" S PSOED=9999999
"RTN","PSOMHV1",18,0)
 F  S EXD=$O(^PS(55,DFN,"P","A",EXD)) Q:'EXD  Q:EXD>PSOED  D
"RTN","PSOMHV1",19,0)
 .S RX=0 F  S RX=$O(^PS(55,DFN,"P","A",EXD,RX)) Q:'RX  D:$D(^PSRX(RX,0)) GET
"RTN","PSOMHV1",20,0)
 S STA="ACT^NVR^REF^HLD^NVR^SUS^^^^^^EXP^DCD^DEL^DCD^DCD^HLD"
"RTN","PSOMHV1",21,0)
 S DRG="" F  S DRG=$O(PSOSD(DRG)) Q:DRG=""  D:$G(PSOSD(DRG))]"" 
"RTN","PSOMHV1",22,0)
 .S PSOSD($P(STA,"^",$P(PSOSD(DRG),"^",2)+1),DRG)=PSOSD(DRG) K PSOSD(DRG)
"RTN","PSOMHV1",23,0)
 D PEN D:$D(PSOSD) BLD
"RTN","PSOMHV1",24,0)
 Q
"RTN","PSOMHV1",25,0)
EN2(DFN,RXLIST) ;Entry point to return data for specified RX #s
"RTN","PSOMHV1",26,0)
 Q:DFN<1
"RTN","PSOMHV1",27,0)
 Q:'RXLIST
"RTN","PSOMHV1",28,0)
 N DRG,DRGN,EXD,I,IFN,MIG,LSTFD,ORD,PEN,PSOBD,PSOED,PSODD,PSOOI,PSOSD,RX,RX0,RX2,RX3,TFN,TD,TR,TRM,SC,SCH,ST0,STA,PSORX,J,PSOERR,RX,PSRXD,PSODIV,PSOSTA
"RTN","PSOMHV1",29,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOMHV1",30,0)
 K ^TMP("PSO",$J)
"RTN","PSOMHV1",31,0)
 S PSOSTA="ACT^NVR^REF^HLD^NVR^SUS^^^^^^EXP^DCD^DEL^DCD^DCD^HLD"
"RTN","PSOMHV1",32,0)
 F J=1:1 S PSORX=$P(RXLIST,"^",J) Q:PSORX=""  D
"RTN","PSOMHV1",33,0)
 . I '$D(^PSRX("B",PSORX)) Q
"RTN","PSOMHV1",34,0)
 . I $O(^PSRX("B",PSORX,""))="" Q
"RTN","PSOMHV1",35,0)
 . S RX=$O(^PSRX("B",PSORX,"")),PSRXD=$G(^PSRX(RX,0))
"RTN","PSOMHV1",36,0)
 . Q:PSRXD=""
"RTN","PSOMHV1",37,0)
 . Q:$P(PSRXD,"^",2)'=DFN
"RTN","PSOMHV1",38,0)
 . Q:$P($G(^PSRX(RX,"STA")),"^")=13
"RTN","PSOMHV1",39,0)
 . Q:$P($G(^PSRX(RX,"STA")),"^")=15
"RTN","PSOMHV1",40,0)
 . Q:'$D(^PSDRUG($P(PSRXD,"^",6),0))
"RTN","PSOMHV1",41,0)
 . S IFN=RX,TR=$P(PSOSTA,"^",$P($G(^PSRX(RX,"STA")),"^")+1)
"RTN","PSOMHV1",42,0)
 . S TD=$P(^PSDRUG($P(PSRXD,"^",6),0),"^")
"RTN","PSOMHV1",43,0)
 . D RXD
"RTN","PSOMHV1",44,0)
 . Q
"RTN","PSOMHV1",45,0)
 Q
"RTN","PSOMHV1",46,0)
 ;
"RTN","PSOMHV1",47,0)
EN3(DFN,BDT,EDT) ;entry point to return prescription history
"RTN","PSOMHV1",48,0)
 Q:'$G(DFN)
"RTN","PSOMHV1",49,0)
 N DRG,DRGN,EXD,I,IFN,MIG,LSTFD,ORD,PEN,PSOBD,PSOED,PSODD,PSOOI,PSOSD,RX,RX0,RX2,RX3,TFN,TD,TR,TRM,SC,SCH,ST0,STA,PSODIV
"RTN","PSOMHV1",50,0)
 I '$G(DT) S DT=$$DT^XLFDT
"RTN","PSOMHV1",51,0)
 K ^TMP("PSO",$J) S PSOBD=$G(BDT),PSOED=$G(EDT)
"RTN","PSOMHV1",52,0)
 I +$G(PSOBD)<1 S X1=DT,X2=-120 D C^%DTC S PSOBD=X
"RTN","PSOMHV1",53,0)
 S EXD=PSOBD-1
"RTN","PSOMHV1",54,0)
 I PSOED="" S PSOED=9999999
"RTN","PSOMHV1",55,0)
 F  S EXD=$O(^PS(55,DFN,"P","A",EXD)) Q:'EXD  Q:EXD>PSOED  D
"RTN","PSOMHV1",56,0)
 .S RX=0 F  S RX=$O(^PS(55,DFN,"P","A",EXD,RX)) Q:'RX  D:$D(^PSRX(RX,0)) GET1
"RTN","PSOMHV1",57,0)
 S STA="ACT^NVR^REF^HLD^NVR^SUS^^^^^^EXP^DCD^DEL^DCD^DCD^HLD"
"RTN","PSOMHV1",58,0)
 ; Uses RX (Rx IEN) instead of DRUG as a subscript in PSOSD and thus
"RTN","PSOMHV1",59,0)
 ; in ^TMP("PSO",$J).  Other entry points use DRUG
"RTN","PSOMHV1",60,0)
 S RX="" F  S RX=$O(PSOSD(RX)) Q:RX=""  D:$G(PSOSD(RX))]""
"RTN","PSOMHV1",61,0)
 .S PSOSD($P(STA,"^",$P(PSOSD(RX),"^",2)+1),RX)=PSOSD(RX) K PSOSD(RX)
"RTN","PSOMHV1",62,0)
 D:$D(PSOSD) BLD
"RTN","PSOMHV1",63,0)
 Q
"RTN","PSOMHV1",64,0)
 ;
"RTN","PSOMHV1",65,0)
PEN F PEN=0:0 S PEN=$O(^PS(52.41,"P",DFN,PEN)) Q:'PEN  D
"RTN","PSOMHV1",66,0)
 .S ORD=^PS(52.41,PEN,0) Q:$P(ORD,"^",2)'=DFN  S DRG=""
"RTN","PSOMHV1",67,0)
 .Q:$P(ORD,"^",3)="DC"!($P(ORD,"^",3)="DE")!($P(ORD,"^",3)="")!($P(ORD,"^",3)="RF")
"RTN","PSOMHV1",68,0)
 .S PSOOI=$P(ORD,"^",8),PSODD=+$P(ORD,"^",9)
"RTN","PSOMHV1",69,0)
 .S DRG=$S(PSODD:$P($G(^PSDRUG(PSODD,0)),"^"),+PSOOI&('PSODD):$P(^PS(50.7,+PSOOI,0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,+PSOOI,0),"^",2),0),"^"),1:"")
"RTN","PSOMHV1",70,0)
 .Q:DRG']""
"RTN","PSOMHV1",71,0)
 .I $D(PSOSD("PEN",DRG)) S DRG=DRG_"^"_PEN
"RTN","PSOMHV1",72,0)
 .S PSOSD("PEN",DRG)=PEN
"RTN","PSOMHV1",73,0)
 Q
"RTN","PSOMHV1",74,0)
GET ;
"RTN","PSOMHV1",75,0)
 Q:$P($G(^PSRX(RX,"STA")),"^")=13
"RTN","PSOMHV1",76,0)
 Q:$P($G(^PSRX(RX,"STA")),"^")=15
"RTN","PSOMHV1",77,0)
 Q:'$P(^PSRX(RX,0),"^",2)
"RTN","PSOMHV1",78,0)
 Q:$P(^PSRX(RX,0),"^",2)'=DFN
"RTN","PSOMHV1",79,0)
 S RX0=^PSRX(RX,0),RX2=^PSRX(RX,2)
"RTN","PSOMHV1",80,0)
 S DRG=$P(^PSRX(RX,0),"^",6),STA=+^("STA") Q:'$D(^PSDRUG(DRG,0))
"RTN","PSOMHV1",81,0)
 S DRGN=$P(^PSDRUG(DRG,0),"^"),ST0=$S(STA<12&($P(RX2,"^",6)<DT):11,1:STA)
"RTN","PSOMHV1",82,0)
 I $D(PSOSD(DRGN)),ST0>10 Q:$P(PSOSD(DRGN),"^",2)<11  Q:$P(PSOSD(DRGN),"^",2)>10&($P(RX0,"^",13)<$P(^PSRX(+$P(PSOSD(DRGN),"^"),0),"^",13))
"RTN","PSOMHV1",83,0)
 I $D(PSOSD(DRGN)),$P(PSOSD(DRGN),"^",2)<10,ST0<10 S PSOSD(DRGN_"^"_RX)=RX_"^"_ST0
"RTN","PSOMHV1",84,0)
 E  S PSOSD(DRGN)=RX_"^"_ST0
"RTN","PSOMHV1",85,0)
 Q
"RTN","PSOMHV1",86,0)
GET1 ;
"RTN","PSOMHV1",87,0)
 Q:'$P(^PSRX(RX,0),"^",2)
"RTN","PSOMHV1",88,0)
 Q:$P(^PSRX(RX,0),"^",2)'=DFN
"RTN","PSOMHV1",89,0)
 S RX0=^PSRX(RX,0),RX2=^PSRX(RX,2)
"RTN","PSOMHV1",90,0)
 S DRG=$P(^PSRX(RX,0),"^",6),STA=+^("STA") Q:'$D(^PSDRUG(DRG,0))
"RTN","PSOMHV1",91,0)
 S DRGN=$P(^PSDRUG(DRG,0),"^"),ST0=$S(STA<12&($P(RX2,"^",6)<DT):11,1:STA)
"RTN","PSOMHV1",92,0)
 S PSOSD(RX)=RX_"^"_ST0
"RTN","PSOMHV1",93,0)
 Q
"RTN","PSOMHV1",94,0)
BLD ;
"RTN","PSOMHV1",95,0)
 S TR="" F  S TR=$O(PSOSD(TR)) Q:TR=""  D
"RTN","PSOMHV1",96,0)
 .S TFN=0,TD="" F  S TD=$O(PSOSD(TR,TD)) Q:TD=""  S IFN=+PSOSD(TR,TD) D @$S(TR="PEN":"PND",1:"RXD")
"RTN","PSOMHV1",97,0)
 Q
"RTN","PSOMHV1",98,0)
RXD ;
"RTN","PSOMHV1",99,0)
 Q:'$D(^PSRX(IFN,0))
"RTN","PSOMHV1",100,0)
 S RX0=^PSRX(IFN,0),RX2=$G(^(2)),RX3=$G(^(3)),STA=+$G(^("STA")),TRM=0,LSTFD=$P(RX2,"^",2)
"RTN","PSOMHV1",101,0)
 S ^TMP("PSO",$J,TR,TD,"RXN",0)=$P(RX0,"^")_"^"_$E($P(RX2,"^",13),1,7)_"^"_$S($P(RX0,"^",11)="W":"W",1:"M")_"^"_$P(RX3,"^",7)
"RTN","PSOMHV1",102,0)
 S ^TMP("PSO",$J,TR,TD,"RXN",0)=^TMP("PSO",$J,TR,TD,"RXN",0)_"^"_$S($P($G(^PSRX(IFN,"OR1")),"^",5):$P(^PSRX(IFN,"OR1"),"^",5),1:"")_"^"_$E($P(RX2,"^",2),1,7)_"^"_$E($P(RX2,"^",13),1,7)_"^^"_IFN
"RTN","PSOMHV1",103,0)
 S I=0 F  S I=$O(^PSRX(IFN,1,I)) Q:'I  S TRM=TRM+1,LSTFD=$P(^PSRX(IFN,1,I,0),"^") D
"RTN","PSOMHV1",104,0)
 .S ^TMP("PSO",$J,TR,TD,"REF",I,0)=$P(^PSRX(IFN,1,I,0),"^")_"^"_$P(^(0),"^",10)_"^"_$P(^(0),"^",4)_"^"_$E($P(^(0),"^",18),1,7)_"^"_$S($P(^(0),"^",2)="W":"W",1:"M")_"^"_$P(^(0),"^",3)
"RTN","PSOMHV1",105,0)
 .I $P(^PSRX(IFN,1,I,0),"^",18) S $P(^TMP("PSO",$J,TR,TD,"RXN",0),"^",2)=$E($P(^PSRX(IFN,1,I,0),"^",18),1,7)
"RTN","PSOMHV1",106,0)
 .S ^TMP("PSO",$J,TR,TD,"REF",0)=$G(^TMP("PSO",$J,TR,TD,"REF",0))+1
"RTN","PSOMHV1",107,0)
 S I=0 F  S I=$O(^PSRX(IFN,"P",I)) Q:'I  D
"RTN","PSOMHV1",108,0)
 .S ^TMP("PSO",$J,TR,TD,"PAR",I,0)=$P(^PSRX(IFN,"P",I,0),"^")_"^"_$P(^(0),"^",10)_"^"_$P(^(0),"^",4)_"^"_$E($P(^(0),"^",19),1,7)_"^"_$S($P(^(0),"^",2)="W":"W",1:"M")_"^"_$P(^(0),"^",3)
"RTN","PSOMHV1",109,0)
 .S ^TMP("PSO",$J,TR,TD,"PAR",0)=$G(^TMP("PSO",$J,TR,TD,"PAR",0))+1
"RTN","PSOMHV1",110,0)
 S ^TMP("PSO",$J,TR,TD,0)=$P($G(^PSDRUG(+$P(RX0,"^",6),0)),"^")_"^^"_$P(RX2,"^",6)
"RTN","PSOMHV1",111,0)
 S ^TMP("PSO",$J,TR,TD,"P",0)=$P(RX0,"^",4)_"^"_$P($G(^VA(200,+$P(RX0,"^",4),0)),"^")
"RTN","PSOMHV1",112,0)
 S ST0=$S(STA<12&($P(RX2,"^",6)<DT):11,1:STA)
"RTN","PSOMHV1",113,0)
 S SC=$P("ERROR^ACTIVE^NON-VERIFIED^REFILL FILL^HOLD^NON-VERIFIED^SUSPENDED^^^^^DONE^EXPIRED^DISCONTINUED^DELETED^DISCONTINUED^DISCONTINUED (EDIT)^HOLD^","^",ST0+2)
"RTN","PSOMHV1",114,0)
 S ^TMP("PSO",$J,TR,TD,0)=^TMP("PSO",$J,TR,TD,0)_"^"_($P(RX0,"^",9)-TRM)_"^"_$P(RX0,"^",13)_"^"_SC_"^"_$P(RX0,"^",8)_"^"_$P(RX0,"^",7)_"^^^"_$P($G(^PSRX(IFN,"OR1")),"^",2)_"^"_LSTFD_"^^"
"RTN","PSOMHV1",115,0)
 S ^TMP("PSO",$J,TR,TD,"DD",0)=1,^TMP("PSO",$J,TR,TD,"DD",1,0)=$P(RX0,"^",6)_"^^"
"RTN","PSOMHV1",116,0)
 S (SCH,SC)=0
"RTN","PSOMHV1",117,0)
 F  S SC=$O(^PSRX(IFN,"SCH",SC)) Q:'SC  S SCH=SCH+1,^TMP("PSO",$J,TR,TD,"SCH",SCH,0)=$P(^PSRX(IFN,"SCH",SC,0),"^") D
"RTN","PSOMHV1",118,0)
 .S ^TMP("PSO",$J,TR,TD,"SCH",0)=$G(^TMP("PSO",$J,TR,TD,"SCH",0))+1
"RTN","PSOMHV1",119,0)
 D MDR
"RTN","PSOMHV1",120,0)
 S SC=0 I $D(^PSRX(IFN,"SIG")),'$P(^PSRX(IFN,"SIG"),"^",2) S SC=1 S X=$P(^PSRX(IFN,"SIG"),"^") D SIG
"RTN","PSOMHV1",121,0)
 I '$G(SC) S SCH=1 D
"RTN","PSOMHV1",122,0)
 .S ^TMP("PSO",$J,TR,TD,"SIG",SCH,0)=$G(^PSRX(IFN,"SIG1",1,0)),^TMP("PSO",$J,TR,TD,"SIG",0)=SCH
"RTN","PSOMHV1",123,0)
 .F I=1:0 S I=$O(^PSRX(IFN,"SIG1",I)) Q:'I  S SCH=SCH+1,^TMP("PSO",$J,TR,TD,"SIG",SCH,0)=^PSRX(IFN,"SIG1",I,0),^TMP("PSO",$J,TR,TD,"SIG",0)=SCH
"RTN","PSOMHV1",124,0)
 S (I,SC)=0
"RTN","PSOMHV1",125,0)
 F  S I=$O(^PSRX(IFN,"PRC",I)) Q:'I  S SC=SC+1 D
"RTN","PSOMHV1",126,0)
 .S ^TMP("PSO",$J,TR,TD,"PC",SC,0)=^PSRX(IFN,"PRC",I,0),^TMP("PSO",$J,TR,TD,"PC",0)=SC
"RTN","PSOMHV1",127,0)
 S PSODIV=$P(RX2,"^",9)
"RTN","PSOMHV1",128,0)
 I PSODIV'="",$D(^PS(59,PSODIV,0)) S ^TMP("PSO",$J,TR,TD,"DIV",0)=PSODIV_"^"_^PS(59,PSODIV,0)
"RTN","PSOMHV1",129,0)
 Q
"RTN","PSOMHV1",130,0)
MDR ;
"RTN","PSOMHV1",131,0)
 S (SCH,SC)=0
"RTN","PSOMHV1",132,0)
 F  S SC=$O(^PSRX(IFN,"MEDR",SC)) Q:'SC  D
"RTN","PSOMHV1",133,0)
 .Q:'$D(^PS(51.2,+^PSRX(IFN,"MEDR",SC,0),0))  S SCH=SCH+1
"RTN","PSOMHV1",134,0)
 .S ^TMP("PSO",$J,TR,TD,"MDR",SCH,0)=$S($P(^PS(51.2,+^PSRX(IFN,"MEDR",SC,0),0),"^",3)]"":$P(^(0),"^",3),1:$P(^(0),"^"))
"RTN","PSOMHV1",135,0)
 .S ^TMP("PSO",$J,TR,TD,"MDR",0)=SCH
"RTN","PSOMHV1",136,0)
 Q
"RTN","PSOMHV1",137,0)
PND Q:'$D(^PS(52.41,IFN,0))
"RTN","PSOMHV1",138,0)
 S ORD=^PS(52.41,IFN,0) Q:$P(ORD,"^",2)'=DFN
"RTN","PSOMHV1",139,0)
 Q:$P(ORD,"^",3)="DC"!($P(ORD,"^",3)="DE")
"RTN","PSOMHV1",140,0)
 S PSOOI=+$P(ORD,"^",8),PSODD=+$P(ORD,"^",9)
"RTN","PSOMHV1",141,0)
 S DRG=$S(PSODD:$P($G(^PSDRUG(PSODD,0)),"^"),1:$P(^PS(50.7,PSOOI,0),"^")_" "_$P(^PS(50.606,$P(^PS(50.7,PSOOI,0),"^",2),0),"^"))
"RTN","PSOMHV1",142,0)
 S ^TMP("PSO",$J,TR,TD,0)=DRG
"RTN","PSOMHV1",143,0)
 S:PSODD ^TMP("PSO",$J,TR,TD,"DD",0)=1,^TMP("PSO",$J,TR,TD,"DD",1,0)=PSODD_"^^"
"RTN","PSOMHV1",144,0)
 S ^TMP("PSO",$J,TR,TD,0)=^TMP("PSO",$J,TR,TD,0)_"^"_$S($G(^PS(51.2,+$P(ORD,"^",15),0))]"":$P(^PS(51.2,+$P(ORD,"^",15),0),"^",3),1:"")
"RTN","PSOMHV1",145,0)
 S ^TMP("PSO",$J,TR,TD,0)=^TMP("PSO",$J,TR,TD,0)_"^^"_$P(ORD,"^",11)_"^"_$P($P(ORD,"^",6),".")_"^"_$S($P(ORD,"^",3)'="HD":"PENDING",1:" ONHOLD")_"^^"_$P(ORD,"^",10)
"RTN","PSOMHV1",146,0)
 S $P(^TMP("PSO",$J,TR,TD,0),"^",11)=$P(ORD,"^")
"RTN","PSOMHV1",147,0)
 S (SC,SCH)=0 F  S SC=$O(^PS(52.41,IFN,1,SC)) Q:'SC  D
"RTN","PSOMHV1",148,0)
 .S SCH=SCH+1,^TMP("PSO",$J,TR,TD,"SCH",SCH,0)=$P(^PS(52.41,IFN,1,SC,1),"^"),^TMP("PSO",$J,TR,TD,"SCH",0)=SCH
"RTN","PSOMHV1",149,0)
 S (SC,SCH)=0 F  S SC=$O(^PS(52.41,IFN,"SIG",SC)) Q:'SC  D
"RTN","PSOMHV1",150,0)
 .S SCH=SCH+1,^TMP("PSO",$J,TR,TD,"SIG",SCH,0)=$P(^PS(52.41,IFN,"SIG",SC,0),"^"),^TMP("PSO",$J,TR,TD,"SIG",0)=SCH
"RTN","PSOMHV1",151,0)
 S SC=1,PEN="" F  S PEN=$O(^PS(52.41,IFN,2,PEN)) Q:'PEN  D
"RTN","PSOMHV1",152,0)
 .S MIG=^PS(52.41,IFN,2,PEN,0),^TMP("PSO",$J,TR,TD,"SIO",0)=SC D
"RTN","PSOMHV1",153,0)
 ..F SCH=1:1:$L(MIG," ") S:$L($G(^TMP("PSO",$J,TR,TD,"SIO",SC,0))_" "_$P(MIG,"",SCH))>80 SC=SC+1,^TMP("PSO",$J,TR,TD,"SIO",0)=SC D
"RTN","PSOMHV1",154,0)
 ...S ^TMP("PSO",$J,TR,TD,"SIO",SC,0)=$G(^TMP("PSO",$J,TR,TD,"SIO",SC,0))_" "_$P(MIG," ",SCH)
"RTN","PSOMHV1",155,0)
 Q
"RTN","PSOMHV1",156,0)
SIG ;
"RTN","PSOMHV1",157,0)
 N Z0,Z1,PSOX1,PSOX2 F Z0=1:1:$L(X," ") Q:Z0=""  S Z1=$P(X," ",Z0) D
"RTN","PSOMHV1",158,0)
 .D:$D(X)&($G(Z1)]"")
"RTN","PSOMHV1",159,0)
 ..S Y=$O(^PS(51,"B",Z1,0)) Q:'Y!($P($G(^PS(51,+Y,0)),"^",4)>1)  S Z1=$P(^PS(51,Y,0),"^",2) Q:'$D(^(9))  S Y=$P(X," ",Z0-1),Y=$E(Y,$L(Y)) S:Y>1 Z1=^(9)
"RTN","PSOMHV1",160,0)
 .I $G(^TMP("PSO",$J,TR,TD,"SIG",1,0))']"" S ^TMP("PSO",$J,TR,TD,"SIG",1,0)=Z1,^TMP("PSO",$J,TR,TD,"SIG",0)=1 Q
"RTN","PSOMHV1",161,0)
 .F PSOX1=0:0 S PSOX1=$O(^TMP("PSO",$J,TR,TD,"SIG",PSOX1)) Q:'PSOX1  S PSOX2=PSOX1
"RTN","PSOMHV1",162,0)
 .I $L(^TMP("PSO",$J,TR,TD,"SIG",PSOX2,0))+$L(Z1)<245 S ^TMP("PSO",$J,TR,TD,"SIG",PSOX2,0)=^TMP("PSO",$J,TR,TD,"SIG",PSOX2,0)_" "_Z1
"RTN","PSOMHV1",163,0)
 .E  S PSOX2=PSOX2+1,^TMP("PSO",$J,TR,TD,"SIG",PSOX2,0)=Z1
"RTN","PSOMHV1",164,0)
 Q
"RTN","PSOP204")
0^4^B76917
"RTN","PSOP204",1,0)
PSOP204 ;BIR/MHA - Pre-Install Routine ; 4/20/05 7:38am
"RTN","PSOP204",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**204**;DEC 1997
"RTN","PSOP204",3,0)
 ;
"RTN","PSOP204",4,0)
 Q
"RTN","PSOP204",5,0)
 ;
"RTN","PSOP204",6,0)
PRE ; Deletes the Data dictionary for file 52.43
"RTN","PSOP204",7,0)
 ; The "AA", and "AB" cross references need to be deleted
"RTN","PSOP204",8,0)
 ; This will clean up the file before the install of the new DD
"RTN","PSOP204",9,0)
 ; for 52.43, but will not destroy any data in test systems.
"RTN","PSOP204",10,0)
 ;  File is not currently in use.
"RTN","PSOP204",11,0)
 S DIU="^PS(52.43,",DIU(0)="" D EN^DIU2
"RTN","PSOP204",12,0)
 Q
"RTN","PSOP204",13,0)
 ;
"RTN","PSOPRA")
0^1^B11988419
"RTN","PSOPRA",1,0)
PSOPRA ;BIR/JLC - INTERNET PRESCRIPTION REFILL APIS ; 4/14/05 4:51pm
"RTN","PSOPRA",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**116,151,204**;DEC 1997
"RTN","PSOPRA",3,0)
 ;
"RTN","PSOPRA",4,0)
 Q
"RTN","PSOPRA",5,0)
AP1(PSODFN,PSORX) ;ACCEPT REQUEST
"RTN","PSOPRA",6,0)
 ; Input:  PSODFN (required) - Patient IEN Number
"RTN","PSOPRA",7,0)
 ;         PSORX  (required) - Prescription Number
"RTN","PSOPRA",8,0)
 ; Output: PSORET - Return Value
"RTN","PSOPRA",9,0)
 ;         See IA ... for description and values
"RTN","PSOPRA",10,0)
 ;
"RTN","PSOPRA",11,0)
 N PSORET,PSRX,PSRXD,IEN,PSORR,PSOICN,SITE,PSOSITE
"RTN","PSOPRA",12,0)
 I $G(PSODFN)="" S PSORET=-4 G QUITAP1
"RTN","PSOPRA",13,0)
 S PSOICN=+$$GETICN^MPIF001(PSODFN)
"RTN","PSOPRA",14,0)
 I +$G(PSOICN)=-1 S PSORET=-4 G QUITAP1
"RTN","PSOPRA",15,0)
 I $G(PSORX)="" S PSORET=-3 G QUITAP1
"RTN","PSOPRA",16,0)
 I $O(^PSRX("B",PSORX,""))="" S PSORET=-3 G QUITAP1
"RTN","PSOPRA",17,0)
 I '$D(^PSRX("B",PSORX)) S PSORET=-3 G QUITAP1
"RTN","PSOPRA",18,0)
 S PSRX=$O(^PSRX("B",PSORX,"")),PSRXD=$G(^PSRX(PSRX,0))
"RTN","PSOPRA",19,0)
 I PSRXD="" S PSORET=-3 G QUITAP1
"RTN","PSOPRA",20,0)
 I $P(PSRXD,"^",2)'=PSODFN S PSORET=-5 G QUITAP1
"RTN","PSOPRA",21,0)
 S (SITE,DA)=$P(^XMB(1,1,"XUS"),"^",17),DIC="4",DIQ(0)="IE",DR=".01;99",DIQ="PSXUTIL" D EN^DIQ1 S PSOSITE=$G(PSXUTIL(4,SITE,99,"I"))
"RTN","PSOPRA",22,0)
 I '$D(^PS(52.43,"AC",PSODFN,PSORX)) G FILEAP1
"RTN","PSOPRA",23,0)
 S IEN=$O(^PS(52.43,"AC",PSODFN,PSORX,""))
"RTN","PSOPRA",24,0)
 I '$D(^PS(52.43,IEN,0)) G FILEAP1
"RTN","PSOPRA",25,0)
 S PSORR=$G(^PS(52.43,IEN,0))
"RTN","PSOPRA",26,0)
 I $P(PSORR,"^",5)="" S PSORET=-2 G QUITAP1
"RTN","PSOPRA",27,0)
 S PSORET=-1 G QUITAP1
"RTN","PSOPRA",28,0)
FILEAP1 K DO,DIC,DD S DIC(0)="L",DIC=52.43,X=PSOICN D FILE^DICN I Y=-1 S PSORET=0 G QUITAP1
"RTN","PSOPRA",29,0)
 K DA,DR,DIE S DA=+Y,DIE=DIC,DR="3///"_PSORX_";7///0;8///"_PSRX_";4///"_PSOSITE_";9////"_PSODFN D ^DIE
"RTN","PSOPRA",30,0)
 S PSORET=1
"RTN","PSOPRA",31,0)
QUITAP1 Q PSORET
"RTN","PSOPRA",32,0)
 ;
"RTN","PSOPRA",33,0)
AP2(PSODFN,PSORX) ;STATUS OF REQUEST
"RTN","PSOPRA",34,0)
 ; Input:  PSODFN (required) - Patient IEN Number
"RTN","PSOPRA",35,0)
 ;         PSORX  (required) - Prescription Number
"RTN","PSOPRA",36,0)
 ; Output: PSORET - Return Value
"RTN","PSOPRA",37,0)
 ;         See IA ... for description and values
"RTN","PSOPRA",38,0)
 ;
"RTN","PSOPRA",39,0)
 N PSORET,PSORR,IEN
"RTN","PSOPRA",40,0)
 I $G(PSODFN)="" S PSORET=-4 G QUITAP2
"RTN","PSOPRA",41,0)
 I $G(PSORX)="" S PSORET=-3 G QUITAP2
"RTN","PSOPRA",42,0)
 I '$D(^PS(52.43,"AC",PSODFN,PSORX)) S PSORET=-6 G QUITAP2
"RTN","PSOPRA",43,0)
 S IEN=$O(^PS(52.43,"AC",PSODFN,PSORX,""))
"RTN","PSOPRA",44,0)
 I '$D(^PS(52.43,IEN,0)) K ^PS(52.43,"AC",PSODFN,PSORX) S PSORET=-6 G QUITAP2
"RTN","PSOPRA",45,0)
 S PSORR=$G(^PS(52.43,IEN,0))
"RTN","PSOPRA",46,0)
 I $P(PSORR,"^",5)="" S PSORET=-2 G QUITAP2
"RTN","PSOPRA",47,0)
 S PSORET=$P(PSORR,"^",6)_"^"_$P(PSORR,"^",5)
"RTN","PSOPRA",48,0)
QUITAP2 Q PSORET
"RTN","PSOPRA",49,0)
 ;
"RTN","PSOPRA",50,0)
AP5(PSODFN,PSORX) ;PROCESS MHEV UPDATE
"RTN","PSOPRA",51,0)
 ; Input:  PSODFN (required) - Patient IEN Number
"RTN","PSOPRA",52,0)
 ;         PSORX  (required) - Prescription Number
"RTN","PSOPRA",53,0)
 ; Output: PSORET - Return Value
"RTN","PSOPRA",54,0)
 ;         See IA ... for description and values
"RTN","PSOPRA",55,0)
 ;
"RTN","PSOPRA",56,0)
 N PSORET,PSORR,IEN,PSOIN
"RTN","PSOPRA",57,0)
 I $G(PSODFN)="" S PSORET=-4 G ENDAP5
"RTN","PSOPRA",58,0)
 I $G(PSORX)="" S PSORET=-3 G ENDAP5
"RTN","PSOPRA",59,0)
 I '$D(^PS(52.43,"AC",PSODFN,PSORX)) S PSORET=-6 G ENDAP5
"RTN","PSOPRA",60,0)
 S IEN=$O(^PS(52.43,"AC",PSODFN,PSORX,""))
"RTN","PSOPRA",61,0)
 I '$D(^PS(52.43,IEN,0)) K ^PS(52.43,"AC",PSODFN,PSORX) S PSORET=-6 G ENDAP5
"RTN","PSOPRA",62,0)
 S PSORR=$G(^PS(52.43,IEN,0))
"RTN","PSOPRA",63,0)
 I $P(PSORR,"^",5)="" S PSORET=-2 G ENDAP5
"RTN","PSOPRA",64,0)
 S PSOIN=$P(PSORR,"^",4)
"RTN","PSOPRA",65,0)
 K DA,DR,DIE
"RTN","PSOPRA",66,0)
 S DA=IEN
"RTN","PSOPRA",67,0)
 S DIE="^PS(52.43,",DR="7///1" D ^DIE S PSORET=1
"RTN","PSOPRA",68,0)
 K ^PS(52.43,"AC",PSODFN,PSORX)
"RTN","PSOPRA",69,0)
ENDAP5 Q PSORET
"RTN","PSOPRA",70,0)
 ;
"RTN","PSOPRA",71,0)
AP6(PSODIEN,PSOAP6) ;OUTPATIENT PHARMACY DIVISION LOOKUP
"RTN","PSOPRA",72,0)
 ; Input:  PSODIEN  (required) - Outpatient Pharmacy Division IEN.
"RTN","PSOPRA",73,0)
 ;                  1. Single Division IEN.
"RTN","PSOPRA",74,0)
 ;                  2. Delimited list of Division IEN's (IEN1,IEN2,IEN3).
"RTN","PSOPRA",75,0)
 ;                  3. Text word "ALL".
"RTN","PSOPRA",76,0)
 ;         PSOAP6   (required) - Information return Array.
"RTN","PSOPRA",77,0)
 ; Output: PSOAP6 - Information return Array.
"RTN","PSOPRA",78,0)
 ;                  PSOAP6(DIV)=Active(0)/Inactive(1)
"RTN","PSOPRA",79,0)
 ;                  PSOAP6(DIV,1)=Division Name^Area Code^Phone Number
"RTN","PSOPRA",80,0)
 ;                  PSOAP6(DIV,2,1)=Narrative text 1st line.
"RTN","PSOPRA",81,0)
 ;                  PSOAP6(DIV,2,n)=Narrative text nth line.
"RTN","PSOPRA",82,0)
 ;         PSORET - 0 (Process failure).
"RTN","PSOPRA",83,0)
 ;                  1 (Process success).
"RTN","PSOPRA",84,0)
 ;
"RTN","PSOPRA",85,0)
 N DIEN,TEMP,NAME,AREACODE,PHONENUM,INACTIVE
"RTN","PSOPRA",86,0)
 Q:$G(PSODIEN)="" 0
"RTN","PSOPRA",87,0)
 I PSODIEN="ALL" S ZS2=$O(^PS(59,0)),PSODIEN=ZS2 Q:'+ZS2 0 F  S ZS2=$O(^PS(59,ZS2)) Q:'+ZS2  S PSODIEN=PSODIEN_","_ZS2
"RTN","PSOPRA",88,0)
 F XX=1:1:$L(PSODIEN,",") S DIEN=$P(PSODIEN,",",XX) D
"RTN","PSOPRA",89,0)
 .S NAME=$$GET1^DIQ(59,DIEN,".01")
"RTN","PSOPRA",90,0)
 .Q:NAME=""
"RTN","PSOPRA",91,0)
 .S AREACODE=$$GET1^DIQ(59,DIEN,".03")
"RTN","PSOPRA",92,0)
 .S PHONENUM=$$GET1^DIQ(59,DIEN,".04")
"RTN","PSOPRA",93,0)
 .S INACTIVE=$$GET1^DIQ(59,DIEN,2004,"I")
"RTN","PSOPRA",94,0)
 .S PSOAP6(DIEN)=0 I INACTIVE S PSOAP6(DIEN)=1
"RTN","PSOPRA",95,0)
 .S PSOAP6(DIEN,1)=NAME_"^"_AREACODE_"^"_PHONENUM
"RTN","PSOPRA",96,0)
 .S TEMP=$$GET1^DIQ(59,DIEN,1005,"","PSOAP6("_DIEN_",2)")
"RTN","PSOPRA",97,0)
 ;
"RTN","PSOPRA",98,0)
ENDAP6 Q 1
"RTN","PSOPRI")
0^3^B22681827
"RTN","PSOPRI",1,0)
PSOPRI ;BIR/JLC - INTERNET PRESCRIPTION REFILL PROCESSOR ; 4/16/05 3:20pm
"RTN","PSOPRI",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**116,204**;DEC 1997
"RTN","PSOPRI",3,0)
 ;
"RTN","PSOPRI",4,0)
 ;Reference to ^PPPPDA1 supported by DBIA 1374
"RTN","PSOPRI",5,0)
 ;Reference to ^PSSLOCK supported by DBIA 2789
"RTN","PSOPRI",6,0)
 ;
"RTN","PSOPRI",7,0)
START S PSOVEX=1
"RTN","PSOPRI",8,0)
 K PSOVEXI,PSOISITE,PSOVEXFL,PSONOF
"RTN","PSOPRI",9,0)
 S PSOVX=0 F  S PSOVX=$O(^PS(59,PSOVX)) Q:'PSOVX  I $P($G(^PS(59,PSOVX,"I")),"^"),DT>$P($G(^("I")),"^") S PSOVEXI(PSOVX)=""
"RTN","PSOPRI",10,0)
 I $O(PSOVEXI(0)) W !,"Looking for refill requests for inactive Outpatient divisions..." D
"RTN","PSOPRI",11,0)
 . S PSOVIN=0 F  S PSOVIN=$O(^PS(52.43,"AINST",PSOVIN)) Q:'PSOVIN  S PSOVXLP="" F  S PSOVXLP=$O(^PS(52.43,"AINST",PSOVIN,PSOVXLP)) Q:PSOVXLP=""  D
"RTN","PSOPRI",12,0)
 .. S PSOIEN=$O(^PS(52.43,"AINST",PSOVIN,PSOVXLP,""))
"RTN","PSOPRI",13,0)
 .. S PSOISITE=$P($G(^PSRX(PSOVXLP,2)),"^",9) Q:$G(PSOVEXI(+$G(PSOISITE)))
"RTN","PSOPRI",14,0)
 .. I PSOISITE,$D(PSOVEXI(PSOISITE)),$P($G(^PS(52.43,PSOIEN,0)),"^",5)="" S PSOVEXI(PSOISITE)=1,PSOVEXFL=1
"RTN","PSOPRI",15,0)
 . I '$G(PSOVEXFL) W ".none found.",!
"RTN","PSOPRI",16,0)
 I $G(PSOVEXFL) W !!,"The following Inactive Outpatient sites have refill requests:",! D  I Y'=1 G END
"RTN","PSOPRI",17,0)
 . S PSOVX=0 F  S PSOVX=$O(PSOVEXI(PSOVX)) Q:'PSOVX  I $G(PSOVEXI(PSOVX)) W !?5,$P($G(^PS(59,+$G(PSOVX),0)),"^")
"RTN","PSOPRI",18,0)
 . K DIR W ! S DIR(0)="E",DIR("A")="Press Return to Continue, '^' to exit" D ^DIR W ! I Y'=1 Q
"RTN","PSOPRI",19,0)
 D:'$D(PSOPAR) ^PSOLSET G:'$D(PSOPAR) END
"RTN","PSOPRI",20,0)
 W !!!?20,"Division: "_$P(^PS(59,PSOSITE,0),"^"),!!
"RTN","PSOPRI",21,0)
 S PSOBBC1("FROM")="REFILL",PSOBBC("QFLG")=0,PSOBBC("DFLG")=0
"RTN","PSOPRI",22,0)
 I '$D(^PS(52.43,"AINST",PSOINST)) S PSOANS="N" W !!?7,$C(7),"There are no internet refills to process." G END
"RTN","PSOPRI",23,0)
 D ASK^PSOBBC W:PSOBBC("QFLG")=1 !?7,$C(7),"No internet refills were processed." G:PSOBBC("QFLG")=1 END
"RTN","PSOPRI",24,0)
IPR W ! S DIR("B")="YES",DIR("A")="Process internet refill requests at this time",DIR(0)="Y" D ^DIR K DIR S PSOANS="N" I $G(DIRUT) S PSOPTRX="" G END
"RTN","PSOPRI",25,0)
 G:Y=0 END S PSOPTRX="" I Y=1 S PSOANS="Y"
"RTN","PSOPRI",26,0)
 I PSOANS["Y" S DIR("B")="NO",DIR("A")="Process internet refills for all divisions",DIR(0)="Y" D ^DIR K DIR S PSOANS2="S" S:Y=1 PSOANS2="M" I $G(DIRUT) S PSOANS="N" G END
"RTN","PSOPRI",27,0)
IPR6 K PSODFN I PSOANS["Y",$G(PSOPTRX),'$G(PSOMHV) D IPR5 ;MARK PROCESSED NODES
"RTN","PSOPRI",28,0)
 D IPR3 I $G(PSOANS)="N" D ULK G END
"RTN","PSOPRI",29,0)
 ;I $P(X,"-")'=PSOINST W !?7,$C(7),$C(7),$C(7),"Not from this institution.",! D ULK G IPR6
"RTN","PSOPRI",30,0)
 S (PSOBBC("IRXN"),PSOBBC("OIRXN"))=$P(X,"-",2)
"RTN","PSOPRI",31,0)
 I $G(^PSRX(PSOBBC("IRXN"),0))']"" W !,$C(7),"Rx data is not on file!",! D ULK G IPR6
"RTN","PSOPRI",32,0)
 I $P($G(^PSRX(PSOBBC("IRXN"),"STA")),"^")=13 W !,$C(7),"Rx has already been deleted." D ULK G IPR6
"RTN","PSOPRI",33,0)
 I $G(PSOBBC("DONE"))[PSOBBC("IRXN")_"," W !,$C(7),"Rx has already been entered." D ULK G IPR6
"RTN","PSOPRI",34,0)
 K X,Y D:PSOBBC("QFLG") PROCESSX^PSOBBC
"RTN","PSOPRI",35,0)
 S PSOSELSE=0 I $G(PSODFN)'=$P(^PSRX(PSOBBC("IRXN"),0),"^",2) S PSOSELSE=1 D PT^PSOBBC I $G(PSOBBC("DFLG")) K PSOSELSE D ULK G IPR6
"RTN","PSOPRI",36,0)
 I '$G(PSOSELSE) D PTC^PSOBBC I $G(PSOBBC("DFLG")) K PSOSELSE D ULK G IPR6
"RTN","PSOPRI",37,0)
 K PSOSELSE D PROFILE^PSORX1 S X="PPPPDA1" X ^%ZOSF("TEST") I  S X=$$PDA^PPPPDA1(PSODFN) W !!
"RTN","PSOPRI",38,0)
 S PSOBBC("DONE")=PSOBBC("IRXN")_",",PSOMHV=0 D REFILL^PSOBBC D ULK G IPR6
"RTN","PSOPRI",39,0)
 Q
"RTN","PSOPRI",40,0)
IPR3 K PSOBBC("IRXN"),PSOXFLAG F  S PSOPTRX=$O(^PS(52.43,"AINST",PSOINST,PSOPTRX)) D  Q:PSOANS="N"!($G(PSOXFLAG))
"RTN","PSOPRI",41,0)
 .I PSOPTRX="" S PSOANS="N" Q
"RTN","PSOPRI",42,0)
 .S PSOIEN=$O(^PS(52.43,"AINST",PSOINST,PSOPTRX,""))
"RTN","PSOPRI",43,0)
 .I '$D(^PSRX(+PSOPTRX,0)),$P(^PS(52.43,PSOIEN,0),"^",5)="" S PSONOF=1 D IPR5 K PSONOF Q  ;SKIPS ERRONEOUS ENTRIES
"RTN","PSOPRI",44,0)
IPR4 .I PSOANS["Y" Q:$P(^PS(52.43,PSOIEN,0),"^",5)'=""  S X=PSOINST_"-"_PSOPTRX,PSODFN=$P(^PS(52.43,PSOIEN,0),"^",9)  ;SKIPS ENTRIES ALREADY PROCESSED AND FORMATS VARIABLE X
"RTN","PSOPRI",45,0)
IPR10 .I PSOANS2["S",$D(^PSRX(+PSOPTRX,0)),PSOSITE'=$P($G(^PSRX(+PSOPTRX,2)),"^",9) Q
"RTN","PSOPRI",46,0)
 .S PSOPSORX=+$G(PSOPTRX) I PSOPSORX D PSOL^PSSLOCK(PSOPSORX) I '$G(PSOMSG) K PSOPSORX,PSOMSG Q
"RTN","PSOPRI",47,0)
 .K PSOMSG S PSOXFLAG=1
"RTN","PSOPRI",48,0)
 Q
"RTN","PSOPRI",49,0)
 ;LINES CALLED TO MARK PROCESSED NODES
"RTN","PSOPRI",50,0)
IPR5 K DA,DR,DIE S DA=$O(^PS(52.43,"AINST",PSOINST,PSOPTRX,""))
"RTN","PSOPRI",51,0)
 S DIE="^PS(52.43,",DR="5////"_DT_";6///"_$S($G(PSOBBC("DFLG"))=1:"NOT FILLED",$G(PSONOF)=1:"NOT FILLED",1:"FILLED") D ^DIE ; MARKS NODE AS PROCESSED
"RTN","PSOPRI",52,0)
 K ^PS(52.43,"AINST",PSOINST,PSOPTRX,DA)
"RTN","PSOPRI",53,0)
 Q
"RTN","PSOPRI",54,0)
END D PROCESSX^PSOBBC
"RTN","PSOPRI",55,0)
 I $P($G(^PS(59,+$G(PSOSITE),"I")),"^"),DT>$P($G(^("I")),"^") D FINAL^PSOLSET W !!,"Your Outpatient Site parameters have been deleted because you selected an",!,"inactive Outpatient Site!",!
"RTN","PSOPRI",56,0)
 K DIR,PSOBBC,PSOBBC1,PSOVIN,PSOISITE,PSOVEXFL,PSOVXLP,PSOVEX,PSOVX,PSOVEXI,PSOANS,PSOANS2,PSOPTRX,PSOXFLAG,PSOPSORX,X,Y,PSODFN,PSOMHV
"RTN","PSOPRI",57,0)
 Q
"RTN","PSOPRI",58,0)
ULK ;
"RTN","PSOPRI",59,0)
 I '$G(PSOPSORX) Q
"RTN","PSOPRI",60,0)
 D PSOUL^PSSLOCK(PSOPSORX)
"RTN","PSOPRI",61,0)
 K PSOPSORX
"RTN","PSOPRI",62,0)
 Q
"RTN","PSOREF0")
0^5^B36318781
"RTN","PSOREF0",1,0)
PSOREF0 ;IHS/JCM - REFILL CON'T ; 1/18/05 8:23am
"RTN","PSOREF0",2,0)
 ;;7.0;OUTPATIENT PHARMACY;**14,152,180,186,204**;DEC 1997
"RTN","PSOREF0",3,0)
 ;External reference to ^PSDRUG supported by DBIA 221
"RTN","PSOREF0",4,0)
 ;
"RTN","PSOREF0",5,0)
 ;PSO*186 add check for DEA Special handling field refill restrictions
"RTN","PSOREF0",6,0)
PROCESS ;
"RTN","PSOREF0",7,0)
 K PSODF S PSOREF("RX0")=^PSRX(PSOREF("IRXN"),0),PSOREF("RX2")=^(2),PSOREF("RX3")=^(3),PSOREF("STA")=+$G(^("STA")),PSOREF("SIG")=$P($G(^("SIG")),"^"),PSOREF("PSODFN")=$P(PSOREF("RX0"),"^",2)
"RTN","PSOREF0",8,0)
 S PSOREF("DAYS SUPPLY")=$P(PSOREF("RX0"),"^",8)
"RTN","PSOREF0",9,0)
 I $D(PSORX("BAR CODE")),PSODFN'=PSOREF("PSODFN") D NEWPT
"RTN","PSOREF0",10,0)
 W !,"Now refilling Rx# ",$P(PSOREF("RX0"),"^")_"   Drug: "_$P(^PSDRUG($P(PSOREF("RX0"),"^",6),0),"^")
"RTN","PSOREF0",11,0)
 S PSOREF("DFLG")=0 D DSPLY G:PSOREF("DFLG") PROCESSX
"RTN","PSOREF0",12,0)
 D CHECK G:$G(PSODF) PROCESS G:PSOREF("DFLG") PROCESSX D EN^PSOR52(.PSOREF)
"RTN","PSOREF0",13,0)
 S:$G(PSOREF("MAIL/WINDOW"))["W" BINGRTE="W",BINGCRT=1
"RTN","PSOREF0",14,0)
PROCESSX D:$G(PSOREF("OLD FILL DATE"))]"" SUSDATEK^PSOUTIL(.PSOREF)
"RTN","PSOREF0",15,0)
 Q
"RTN","PSOREF0",16,0)
DSPLY ;W !!,$P(PSOREF("RX0"),"^"),?12," ",$P(^PSDRUG($P(PSOREF("RX0"),"^",6),0),"^"),?45," SIG: "_PSOREF("SIG"),?60," QTY: ",$P(PSOREF("RX0"),"^",7)
"RTN","PSOREF0",17,0)
 K FSIG,BSIG I $P($G(^PSRX(PSOREF("IRXN"),"SIG")),"^",2) D FSIG^PSOUTLA("R",PSOREF("IRXN"),54) F PSREV=1:1 Q:'$D(FSIG(PSREV))  S BSIG(PSREV)=FSIG(PSREV)
"RTN","PSOREF0",18,0)
 K FSIG,PSREV I '$P($G(^PSRX(PSOREF("IRXN"),"SIG")),"^",2) D EN2^PSOUTLA1(PSOREF("IRXN"),54)
"RTN","PSOREF0",19,0)
 W !!,"Qty: ",$P(PSOREF("RX0"),"^",7),?19,"Sig: ",$G(BSIG(1))
"RTN","PSOREF0",20,0)
 I $O(BSIG(1)) F PSREV=1:0 S PSREV=$O(BSIG(PSREV)) Q:'PSREV  W !?24,$G(BSIG(PSREV))
"RTN","PSOREF0",21,0)
 K BSIG,PSREV
"RTN","PSOREF0",22,0)
DSPLYX Q
"RTN","PSOREF0",23,0)
CHECK ;
"RTN","PSOREF0",24,0)
 I '$P(PSOPAR,"^",11),$G(^PSDRUG($P(PSOREF("RX0"),"^",6),"I"))]"",DT>$G(^("I")) D  G CKQ
"RTN","PSOREF0",25,0)
 .W $C(7),!!," *** Drug is inactive for Rx # "_$P(PSOREF("RX0"),"^")_" cannot be refilled ***",!
"RTN","PSOREF0",26,0)
 I '$D(PSORX("BAR CODE")),PSOREF("PSODFN")'=PSODFN W !!,?5,$C(7),"Can't refill Rx # "_$P(PSOREF("RX0"),"^")_", it is not for this patient." G CKQ
"RTN","PSOREF0",27,0)
 S (PSOX,PSOY,STA)=""
"RTN","PSOREF0",28,0)
 I $G(PSOSD) F  S STA=$O(PSOSD(STA)) Q:STA=""  F  S PSOX=$O(PSOSD(STA,PSOX)) Q:PSOX']""!(PSOREF("DFLG"))  I PSOREF("IRXN")=+PSOSD(STA,PSOX) S PSOY=PSOSD(STA,PSOX) I $P(PSOY,"^",4)]"" D
"RTN","PSOREF0",29,0)
 . S PSOREF("DFLG")=1 W:'$G(PSOERR) !,$C(7),"Cannot refill Rx # "_$P(PSOREF("RX0"),"^") S PSOREA=$P(PSOY,"^",4),PSOSTAT=PSOREF("STA")
"RTN","PSOREF0",30,0)
 . D STATUS^PSOUTIL(PSOREA,PSOSTAT) K PSOREA,PSOSTAT
"RTN","PSOREF0",31,0)
 . Q
"RTN","PSOREF0",32,0)
 I PSOY="" W !,$C(7),"Cannot refill, Rx is discontinued or expired.  Later Rx may exist.",! D  I $G(PSODF) Q
"RTN","PSOREF0",33,0)
 .D LOOK^PSOREF2 I $G(PSODF) Q
"RTN","PSOREF0",34,0)
 .S PSOREF("DFLG")=1
"RTN","PSOREF0",35,0)
 K PSOX,PSOY G:PSOREF("DFLG") CHECKX
"RTN","PSOREF0",36,0)
 I $O(^PS(52.5,"B",PSOREF("IRXN"),0)),'$G(^PS(52.5,+$O(^PS(52.5,"B",PSOREF("IRXN"),0)),"P")) W !,$C(7),"Rx is in suspense and cannot be refilled" S PSOREF("DFLG")=1 G CHECKX
"RTN","PSOREF0",37,0)
 ;
"RTN","PSOREF0",38,0)
 S PSOREF("RXSTATUS")=PSOREF("STA")
"RTN","PSOREF0",39,0)
 I PSOREF("RXSTATUS"),PSOREF("RXSTATUS")'=6 D  G CHECKX
"RTN","PSOREF0",40,0)
 . S PSOY=";"_PSOREF("RXSTATUS"),PSOX=$P(^DD(52,100,0),"^",3),PSOY=$F(PSOX,PSOY),PSOY=$P($E(PSOX,PSOY,999),";",1)
"RTN","PSOREF0",41,0)
 . W !,$C(7),"Rx is in "_PSOY_" status, cannot be refilled" S PSOREF("DFLG")=1
"RTN","PSOREF0",42,0)
 D CHKDIV G:PSOREF("DFLG") CHECKX
"RTN","PSOREF0",43,0)
 D NUMBER I PSOREF("NUMBER")>$P(PSOREF("RX0"),"^",9) W !?5,"Can't refill, no refills remaining." S PSOREF("DFLG")=1 G CHECKX
"RTN","PSOREF0",44,0)
 ;
"RTN","PSOREF0",45,0)
 ;PSO*7*186  check DEA, SPEC HNDLG field, in case changed, and apply
"RTN","PSOREF0",46,0)
 N PSODRG,PSODEA,PSODAY
"RTN","PSOREF0",47,0)
 S PSODRG=$G(^PSDRUG($P(PSOREF("RX0"),U,6),0)),PSODEA=$P(PSODRG,U,3)
"RTN","PSOREF0",48,0)
 S PSODAY=$P(PSOREF("RX0"),U,8)
"RTN","PSOREF0",49,0)
 I $$DEACHK^PSOUTLA1(PSOREF("IRXN"),PSODEA,PSODAY) D  G CHECKX
"RTN","PSOREF0",50,0)
 . W $C(7),!!,"This drug has been changed, No refills allowed",!
"RTN","PSOREF0",51,0)
 . S PSOREF("DFLG")=1
"RTN","PSOREF0",52,0)
 ;
"RTN","PSOREF0",53,0)
 D DATES
"RTN","PSOREF0",54,0)
CHECKX Q
"RTN","PSOREF0",55,0)
CKQ ;
"RTN","PSOREF0",56,0)
 S PSOREF("DFLG")=1 D PAUSE^VALM1 G CHECKX
"RTN","PSOREF0",57,0)
 Q
"RTN","PSOREF0",58,0)
 ;
"RTN","PSOREF0",59,0)
CHKDIV G:$P(PSOREF("RX2"),"^",9)=+PSOSITE CHKDIVX
"RTN","PSOREF0",60,0)
 W !?5,$C(7),"RX # ",$P(PSOREF("RX0"),"^")," is for (",$P(^PS(59,$P(PSOREF("RX2"),"^",9),0),"^"),") division."
"RTN","PSOREF0",61,0)
 I '$P($G(PSOSYS),"^",2) S (PSOREF("DFLG"),PSOMHV)=1 W !,"********* Not Refilled *********" G CHKDIVX
"RTN","PSOREF0",62,0)
 D:$P($G(PSOSYS),"^",3) DIR
"RTN","PSOREF0",63,0)
CHKDIVX Q
"RTN","PSOREF0",64,0)
 ;
"RTN","PSOREF0",65,0)
NUMBER K PSOX,PSOY S PSOREF("# OF REFILLS")=0
"RTN","PSOREF0",66,0)
 I $G(^PSRX(PSOREF("IRXN"),1,0))]"" F PSOX=0:0 S PSOX=$O(^PSRX(PSOREF("IRXN"),1,PSOX)) Q:'PSOX  S PSOREF("# OF REFILLS")=PSOX
"RTN","PSOREF0",67,0)
 S PSOREF("NUMBER")=PSOREF("# OF REFILLS")+1
"RTN","PSOREF0",68,0)
 Q
"RTN","PSOREF0",69,0)
 ;
"RTN","PSOREF0",70,0)
DATES S PSOREF("STOP DATE")=$P(PSOREF("RX2"),"^",6) D NEXT^PSOUTIL(.PSOREF)
"RTN","PSOREF0",71,0)
 D:$G(PSOBBC("QFLG"))&($P(PSOPAR,"^",6)) EDATE Q:$G(PSOREF("DFLG"))
"RTN","PSOREF0",72,0)
 S PSOREF("FILL DATE")=$S($G(PSOREF("FILL DATE")):PSOREF("FILL DATE"),1:DT)
"RTN","PSOREF0",73,0)
 I $P(PSOPAR,"^",6),PSOREF("FILL DATE")<$P(PSOREF("RX3"),"^",2) D SUSDATE^PSOUTIL(.PSOREF)
"RTN","PSOREF0",74,0)
 ;
"RTN","PSOREF0",75,0)
 I PSOREF("FILL DATE")>PSOREF("STOP DATE") D
"RTN","PSOREF0",76,0)
 . W !!?5,$C(7),"Can't refill, Refill Date ",$E(PSOREF("FILL DATE"),4,5),"/",$E(PSOREF("FILL DATE"),6,7),"/"
"RTN","PSOREF0",77,0)
 . W $E(PSOREF("FILL DATE"),2,3)," is past Expiration Date ",$E(PSOREF("STOP DATE"),4,5),"/",$E(PSOREF("STOP DATE"),6,7),"/"
"RTN","PSOREF0",78,0)
 . W $E(PSOREF("STOP DATE"),2,3) S PSOREF("DFLG")=1
"RTN","PSOREF0",79,0)
EDATE S PSOREF("LAST REFILL DATE")=$P(PSOREF("RX3"),"^",1)
"RTN","PSOREF0",80,0)
 I PSOREF("LAST REFILL DATE"),PSOREF("FILL DATE")=PSOREF("LAST REFILL DATE") D  G DATESX
"RTN","PSOREF0",81,0)
 . W !?5,"Can't refill, Fill Date already exists for ",$E(PSOREF("FILL DATE"),4,5),"/",$E(PSOREF("FILL DATE"),6,7),"/",$E(PSOREF("FILL DATE"),2,3)
"RTN","PSOREF0",82,0)
 . S PSOREF("DFLG")=1
"RTN","PSOREF0",83,0)
 I PSOREF("LAST REFILL DATE"),PSOREF("FILL DATE")<PSOREF("LAST REFILL DATE") D  G DATESX
"RTN","PSOREF0",84,0)
 . W !?5,"Can't refill, later Refill Date already exists for ",$E(PSOREF("LAST REFILL DATE"),4,5),"/",$E(PSOREF("LAST REFILL DATE"),6,7),"/",$E(PSOREF("LAST REFILL DATE"),2,3)
"RTN","PSOREF0",85,0)
 . S PSOREF("DFLG")=1
"RTN","PSOREF0",86,0)
 I '$P(PSOPAR,"^",6),'$D(PSOREF("EAOK")),$P(PSOREF("RX3"),"^",2)>PSOREF("FILL DATE") D
"RTN","PSOREF0",87,0)
 . S PSOX1=(PSOREF("NUMBER")+1)*PSOREF("DAYS SUPPLY")-10
"RTN","PSOREF0",88,0)
 . W !?5,$C(7),"LESS THAN ",PSOX1," DAYS FOR ",PSOREF("NUMBER")+1," FILLS",! D DIR K PSOX1
"RTN","PSOREF0",89,0)
 I '$P(PSOPAR,"^",6),$G(PSOREF("EAOK"))=0,$P(PSOREF("RX3"),"^",2)>PSOREF("FILL DATE") D
"RTN","PSOREF0",90,0)
 . S Y=$P(PSOREF("RX3"),"^",2) D DD^%DT W !!,$C(7),"Cannot be refilled until "_Y_"." S (PSOREF("DFLG"),PSOMHV)=1 K Y
"RTN","PSOREF0",91,0)
DATESX Q
"RTN","PSOREF0",92,0)
DIR K DIR,X,Y S DIR(0)="Y",DIR("A")="Continue ",DIR("B")="N",DIR("?")="Answer YES to Refill, NO to bypass"
"RTN","PSOREF0",93,0)
 D ^DIR K DIR S:$D(DIRUT)!('Y) (PSOREF("DFLG"),PSOMHV)=1 K DIRUT,DTOUT,DUOUT,X,Y
"RTN","PSOREF0",94,0)
 Q
"RTN","PSOREF0",95,0)
NEWPT S PSOQFLG=0,(DFN,PSODFN)=PSOREF("PSODFN") D ^PSOPTPST I PSOQFLG S PSOREF("DFLG")=1,PSOQFLG=0 G NEWPTX
"RTN","PSOREF0",96,0)
 D PROFILE^PSOREF1
"RTN","PSOREF0",97,0)
NEWPTX Q
"RTN","PSOREF0",98,0)
 ;
"RTN","PSOREF0",99,0)
EN(PSOREF)         ; Entry Point for Batch Barcode Option
"RTN","PSOREF0",100,0)
 D PROCESS K DRUG,PSODF
"RTN","PSOREF0",101,0)
 Q
"SEC","^DIC",52.43,52.43,0,"AUDIT")
@
"SEC","^DIC",52.43,52.43,0,"DD")
@
"SEC","^DIC",52.43,52.43,0,"DEL")
@
"SEC","^DIC",52.43,52.43,0,"LAYGO")
@
"SEC","^DIC",52.43,52.43,0,"RD")
@
"SEC","^DIC",52.43,52.43,0,"WR")
@
"VER")
8.0^22.0
"^DD",52.43,52.43,0)
FIELD^^9^9
"^DD",52.43,52.43,0,"DDA")
N
"^DD",52.43,52.43,0,"DT")
3050202
"^DD",52.43,52.43,0,"IX","B",52.43,.01)

"^DD",52.43,52.43,0,"NM","PRESCRIPTION REFILL REQUEST")

"^DD",52.43,52.43,0,"VRPK")
PSO
"^DD",52.43,52.43,.01,0)
PATIENT ICN^RNJ12,0^^0;1^K:+X'=X!(X>999999999999)!(X<1)!(X?.E1"."1.N) X
"^DD",52.43,52.43,.01,1,0)
^.1^^0
"^DD",52.43,52.43,.01,3)
Type a number between 1 and 999999999999, 0 Decimal Digits
"^DD",52.43,52.43,.01,21,0)
^^2^2^3030207^
"^DD",52.43,52.43,.01,21,1,0)
This is a machine-to-machine identifier for a patient. The number may 
"^DD",52.43,52.43,.01,21,2,0)
only be edited by MPI/PD.
"^DD",52.43,52.43,.01,"DT")
3050416
"^DD",52.43,52.43,2,0)
PATIENT SSN^F^^0;2^K:$L(X)>9!($L(X)<1) X
"^DD",52.43,52.43,2,3)
Answer must be 1-9 characters in length
"^DD",52.43,52.43,2,21,0)
^^3^3^3030207^
"^DD",52.43,52.43,2,21,1,0)
This is the social security number associated with this patient. In 
"^DD",52.43,52.43,2,21,2,0)
combination with the Integration Control Number, it is used to validate 
"^DD",52.43,52.43,2,21,3,0)
the patient's identification.
"^DD",52.43,52.43,2,"DT")
3050416
"^DD",52.43,52.43,3,0)
RX #^F^^0;3^K:$L(X)>25!($L(X)<1) X
"^DD",52.43,52.43,3,3)
Answer must be 1-25 characters in length
"^DD",52.43,52.43,3,21,0)
^^2^2^3030207^
"^DD",52.43,52.43,3,21,1,0)
This is the external representation of the prescription number for the
"^DD",52.43,52.43,3,21,2,0)
refill to be processed.
"^DD",52.43,52.43,3,"DT")
3050416
"^DD",52.43,52.43,4,0)
INSTITUTION^F^^0;4^K:$L(X)>10!($L(X)<1) X
"^DD",52.43,52.43,4,3)
Answer must be 1-10 characters in length
"^DD",52.43,52.43,4,21,0)
^^2^2^3030207^
"^DD",52.43,52.43,4,21,1,0)
The VA facility or institution that will be processing the refill for 
"^DD",52.43,52.43,4,21,2,0)
this prescription.
"^DD",52.43,52.43,4,"DT")
3030207
"^DD",52.43,52.43,5,0)
DATE PROCESSED^D^^0;5^S %DT="E" D ^%DT S X=Y K:3020101>X X
"^DD",52.43,52.43,5,3)
TYPE A DATE NOT EARLIER THAN JAN 01, 2002
"^DD",52.43,52.43,5,21,0)
^^1^1^3030207^
"^DD",52.43,52.43,5,21,1,0)
This is the date the pharmacy processed the refill request.
"^DD",52.43,52.43,5,"DT")
3030207
"^DD",52.43,52.43,6,0)
RESULT^S^0:NOT PROCESSED;1:FILLED;2:NOT FILLED;^0;6^Q
"^DD",52.43,52.43,6,21,0)
^^2^2^3030207^
"^DD",52.43,52.43,6,21,1,0)
The result of the pharmacy staff processing the refill request. The 
"^DD",52.43,52.43,6,21,2,0)
result may be either FILLED or NOT FILLED.
"^DD",52.43,52.43,6,"DT")
3030207
"^DD",52.43,52.43,7,0)
MHEV UPDATE^S^0:NO;1:YES;^0;7^Q
"^DD",52.43,52.43,7,21,0)
^^2^2^3030210^
"^DD",52.43,52.43,7,21,1,0)
Indicates whether or not a status update for this refill request has been 
"^DD",52.43,52.43,7,21,2,0)
sent to the My HealtheVet system.
"^DD",52.43,52.43,7,"DT")
3030210
"^DD",52.43,52.43,8,0)
PRESCRIPTION IEN^F^^0;8^K:$L(X)>20!($L(X)<1) X
"^DD",52.43,52.43,8,3)
This is the internal entry number from 52.
"^DD",52.43,52.43,8,21,0)
^^2^2^3030207^
"^DD",52.43,52.43,8,21,1,0)
This is the internal entry number of the prescription associated with 
"^DD",52.43,52.43,8,21,2,0)
this refill request.
"^DD",52.43,52.43,8,"DT")
3050203
"^DD",52.43,52.43,9,0)
PATIENT^RP2'^DPT(^0;9^Q
"^DD",52.43,52.43,9,21,0)
^^1^1^3050202^
"^DD",52.43,52.43,9,21,1,0)
The patient receiving treatment.
"^DD",52.43,52.43,9,23,0)
^^1^1^3050202^
"^DD",52.43,52.43,9,23,1,0)
(Required) Pointer to Patient File (#2).
"^DD",52.43,52.43,9,"DT")
3050203
"^DIC",52.43,52.43,0)
PRESCRIPTION REFILL REQUEST^52.43
"^DIC",52.43,52.43,0,"GL")
^PS(52.43,
"^DIC",52.43,52.43,"%",0)
^1.005^^0
"^DIC",52.43,52.43,"%D",0)
^^3^3^3030210^
"^DIC",52.43,52.43,"%D",1,0)
The purpose of this file is to hold the refill requests that are 
"^DIC",52.43,52.43,"%D",2,0)
generated from the web interface in the My HealtheVet package. Requests 
"^DIC",52.43,52.43,"%D",3,0)
are filed here, to be processed by pharmacy.
"^DIC",52.43,"B","PRESCRIPTION REFILL REQUEST",52.43)

"BLD",5357,6)
^SEQ #185
**END**
**END**
