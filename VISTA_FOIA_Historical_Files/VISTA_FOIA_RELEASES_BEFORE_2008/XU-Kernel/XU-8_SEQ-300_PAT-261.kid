Released XU*8*261 SEQ #300
Extracted from mail message
**KIDS**:XU*8.0*261^

**INSTALL NAME**
XU*8.0*261
"BLD",1531,0)
XU*8.0*261^KERNEL^0^3040310^y
"BLD",1531,4,0)
^9.64PA^^0
"BLD",1531,"ABPKG")
n
"BLD",1531,"INID")
^y
"BLD",1531,"INIT")
POST^XUMF261P
"BLD",1531,"KRN",0)
^9.67PA^8989.52^19
"BLD",1531,"KRN",.4,0)
.4
"BLD",1531,"KRN",.401,0)
.401
"BLD",1531,"KRN",.402,0)
.402
"BLD",1531,"KRN",.403,0)
.403
"BLD",1531,"KRN",.5,0)
.5
"BLD",1531,"KRN",.84,0)
.84
"BLD",1531,"KRN",3.6,0)
3.6
"BLD",1531,"KRN",3.8,0)
3.8
"BLD",1531,"KRN",3.8,"NM",0)
^9.68A^^0
"BLD",1531,"KRN",9.2,0)
9.2
"BLD",1531,"KRN",9.8,0)
9.8
"BLD",1531,"KRN",9.8,"NM",0)
^9.68A^11^8
"BLD",1531,"KRN",9.8,"NM",2,0)
XUMF4^^0^B71300214
"BLD",1531,"KRN",9.8,"NM",5,0)
XUMFI^^0^B79789892
"BLD",1531,"KRN",9.8,"NM",6,0)
XUMFH^^0^B76492031
"BLD",1531,"KRN",9.8,"NM",7,0)
XUMF261P^^0^B1259314
"BLD",1531,"KRN",9.8,"NM",8,0)
XUAF4^^0^B37047359
"BLD",1531,"KRN",9.8,"NM",9,0)
XUMF218A^^0^B2270158
"BLD",1531,"KRN",9.8,"NM",10,0)
XUMF4A^^0^B55636961
"BLD",1531,"KRN",9.8,"NM",11,0)
XUMF4L1^^0^B34916115
"BLD",1531,"KRN",9.8,"NM","B","XUAF4",8)

"BLD",1531,"KRN",9.8,"NM","B","XUMF218A",9)

"BLD",1531,"KRN",9.8,"NM","B","XUMF261P",7)

"BLD",1531,"KRN",9.8,"NM","B","XUMF4",2)

"BLD",1531,"KRN",9.8,"NM","B","XUMF4A",10)

"BLD",1531,"KRN",9.8,"NM","B","XUMF4L1",11)

"BLD",1531,"KRN",9.8,"NM","B","XUMFH",6)

"BLD",1531,"KRN",9.8,"NM","B","XUMFI",5)

"BLD",1531,"KRN",19,0)
19
"BLD",1531,"KRN",19.1,0)
19.1
"BLD",1531,"KRN",101,0)
101
"BLD",1531,"KRN",409.61,0)
409.61
"BLD",1531,"KRN",771,0)
771
"BLD",1531,"KRN",870,0)
870
"BLD",1531,"KRN",870,"NM",0)
^9.68A^^0
"BLD",1531,"KRN",8989.51,0)
8989.51
"BLD",1531,"KRN",8989.52,0)
8989.52
"BLD",1531,"KRN",8994,0)
8994
"BLD",1531,"KRN","B",.4,.4)

"BLD",1531,"KRN","B",.401,.401)

"BLD",1531,"KRN","B",.402,.402)

"BLD",1531,"KRN","B",.403,.403)

"BLD",1531,"KRN","B",.5,.5)

"BLD",1531,"KRN","B",.84,.84)

"BLD",1531,"KRN","B",3.6,3.6)

"BLD",1531,"KRN","B",3.8,3.8)

"BLD",1531,"KRN","B",9.2,9.2)

"BLD",1531,"KRN","B",9.8,9.8)

"BLD",1531,"KRN","B",19,19)

"BLD",1531,"KRN","B",19.1,19.1)

"BLD",1531,"KRN","B",101,101)

"BLD",1531,"KRN","B",409.61,409.61)

"BLD",1531,"KRN","B",771,771)

"BLD",1531,"KRN","B",870,870)

"BLD",1531,"KRN","B",8989.51,8989.51)

"BLD",1531,"KRN","B",8989.52,8989.52)

"BLD",1531,"KRN","B",8994,8994)

"BLD",1531,"QUES",0)
^9.62^^
"BLD",1531,"REQB",0)
^9.611^11^6
"BLD",1531,"REQB",6,0)
XU*8.0*262^0
"BLD",1531,"REQB",7,0)
XU*8.0*270^0
"BLD",1531,"REQB",8,0)
XU*8.0*294^0
"BLD",1531,"REQB",9,0)
XU*8.0*335^0
"BLD",1531,"REQB",10,0)
XU*8.0*217^0
"BLD",1531,"REQB",11,0)
XU*8.0*218^0
"BLD",1531,"REQB","B","XU*8.0*217",10)

"BLD",1531,"REQB","B","XU*8.0*218",11)

"BLD",1531,"REQB","B","XU*8.0*262",6)

"BLD",1531,"REQB","B","XU*8.0*270",7)

"BLD",1531,"REQB","B","XU*8.0*294",8)

"BLD",1531,"REQB","B","XU*8.0*335",9)

"INIT")
POST^XUMF261P
"MBREQ")
0
"PKG",113,-1)
1^1
"PKG",113,0)
KERNEL^XU^SIGN-ON, SECURITY, MENU DRIVER, DEVICES, TASKMAN^
"PKG",113,20,0)
^9.402P^^
"PKG",113,22,0)
^9.49I^1^1
"PKG",113,22,1,0)
8.0^2950703^2960322^648
"PKG",113,22,1,"PAH",1,0)
261^3040310^9146
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
8
"RTN","XUAF4")
0^8^B37047359
"RTN","XUAF4",1,0)
XUAF4 ;ISC-SF/RWF/RAM - Institution file access. ;04/01/99  08:07
"RTN","XUAF4",2,0)
 ;;8.0;KERNEL;**43,112,206,209,232,217,261**;Jul 10, 1995
"RTN","XUAF4",3,0)
 Q  ;No access from the top.
"RTN","XUAF4",4,0)
 ;
"RTN","XUAF4",5,0)
PARENT(ROOT,CHILD,ASSO) ;sr. Return array of IEN's of parents
"RTN","XUAF4",6,0)
 N %,%0
"RTN","XUAF4",7,0)
 S CHILD=$$LKUP(CHILD),ASSO=$$ASSO($G(ASSO)),%=0
"RTN","XUAF4",8,0)
 F  S %=$O(^DIC(4,CHILD,7,%)) Q:%'>0  S %0=+$P(^(%,0),U,2) D
"RTN","XUAF4",9,0)
 . Q:+%'=ASSO
"RTN","XUAF4",10,0)
 . S @ROOT@("P",+%0)=$$NS(+%0)
"RTN","XUAF4",11,0)
 Q
"RTN","XUAF4",12,0)
CHILDREN(ROOT,PAR,ASSO,XUAC) ;sr. Return the children
"RTN","XUAF4",13,0)
 N %,%1 S %=0,PAR=$$LKUP(PAR),ASSO=$$ASSO($G(ASSO)),XUAC=$G(XUAC)
"RTN","XUAF4",14,0)
 Q:ASSO'>0
"RTN","XUAF4",15,0)
 F  S %=$O(^DIC(4,"AC",ASSO,PAR,%)) Q:%'>0  D
"RTN","XUAF4",16,0)
 . I XUAC,$$STATUS(%)="I" Q
"RTN","XUAF4",17,0)
 . S @ROOT@("C",%)=$$NS(%)
"RTN","XUAF4",18,0)
 Q
"RTN","XUAF4",19,0)
SIBLING(ROOT,CHILD,ASSO) ;sr. Return the siblings
"RTN","XUAF4",20,0)
 N % S %=0,ASSO=$$ASSO($G(ASSO))
"RTN","XUAF4",21,0)
 D PARENT(ROOT,CHILD,ASSO)
"RTN","XUAF4",22,0)
 F  S %=$O(@ROOT@("P",%)) Q:%'>0  D CHILDREN($NA(@ROOT@("P",%)),"`"_%,ASSO)
"RTN","XUAF4",23,0)
 Q
"RTN","XUAF4",24,0)
NNT(%) ;ef.sr. Return Name, Station Number, ASSO
"RTN","XUAF4",25,0)
 I %'>0 Q ""
"RTN","XUAF4",26,0)
 Q $$NS(%)_"^"_$$WHAT(%,13)
"RTN","XUAF4",27,0)
 ;
"RTN","XUAF4",28,0)
LKUP(%) ;ef.sr. Resolve a value into IEN
"RTN","XUAF4",29,0)
 I $E(%)="`" S %=+$E(%,2,99) Q:$D(^DIC(4,%,0))#2 % Q 0
"RTN","XUAF4",30,0)
 ;Q $$FIND1^DIC(4,,"MX",%)
"RTN","XUAF4",31,0)
 Q $$FIND1^DIC(4,,"MX",%,,"I $P(^(0),U,11)'=""I""") ;To screen Inactive
"RTN","XUAF4",32,0)
 ;
"RTN","XUAF4",33,0)
STATUS(%) ;Get the status of a IEN
"RTN","XUAF4",34,0)
 Q $P($G(^DIC(4,%,0)),U,11)
"RTN","XUAF4",35,0)
 ;
"RTN","XUAF4",36,0)
TYPE(%) ;Lookup a Faclity TYPE in file 4.1
"RTN","XUAF4",37,0)
 I %="" Q %
"RTN","XUAF4",38,0)
 I $D(^DIC(4.1,"B",%))>9 Q %
"RTN","XUAF4",39,0)
 S %=$$FIND1^DIC(4.1,,"MX",%)
"RTN","XUAF4",40,0)
 Q $P($G(^DIC(4.1,+%,0)),U)
"RTN","XUAF4",41,0)
 ;
"RTN","XUAF4",42,0)
ASSO(%) ;Lookup an Asso
"RTN","XUAF4",43,0)
 Q:+%=% % S:%="" %="VISN"
"RTN","XUAF4",44,0)
 S %=$$FIND1^DIC(4.05,,"MX",%)
"RTN","XUAF4",45,0)
 Q +%
"RTN","XUAF4",46,0)
 ;
"RTN","XUAF4",47,0)
NS(IEN) ;ef.sr. Return name and station #
"RTN","XUAF4",48,0)
 Q $P($G(^DIC(4,IEN,0)),U,1)_U_$P($G(^DIC(4,+IEN,99)),U,1)
"RTN","XUAF4",49,0)
 ;
"RTN","XUAF4",50,0)
WHAT(IEN,FLD) ;ef.sr. Field to return
"RTN","XUAF4",51,0)
 Q $$GET1^DIQ(4,IEN_",",FLD,"")
"RTN","XUAF4",52,0)
 ;
"RTN","XUAF4",53,0)
CIRN(%1,%2) ;ef.sr. Is this a CIRN Enables inst.
"RTN","XUAF4",54,0)
 N % S %1=+$G(%1)
"RTN","XUAF4",55,0)
 Q:'$D(^DIC(4,%1,0)) -1
"RTN","XUAF4",56,0)
 I $G(%2)]"" N DIE,DR,DA S DA=%1,DR="990.1///"_%2,DIE="^DIC(4," D ^DIE
"RTN","XUAF4",57,0)
 Q $$WHAT(%1,990.1)
"RTN","XUAF4",58,0)
 ;
"RTN","XUAF4",59,0)
IEN(STA) ;return IEN for a station number
"RTN","XUAF4",60,0)
 S STA=$G(STA) Q:STA="" STA
"RTN","XUAF4",61,0)
 Q $O(^DIC(4,"D",STA,0))
"RTN","XUAF4",62,0)
 ;
"RTN","XUAF4",63,0)
STA(IEN) ;return station number for an IEN
"RTN","XUAF4",64,0)
 Q $P($G(^DIC(4,+IEN,99)),U)
"RTN","XUAF4",65,0)
 ;
"RTN","XUAF4",66,0)
TF(IEN) ;active treating facility? (1=YES,0=NO)
"RTN","XUAF4",67,0)
 N ARRAY Q:'$G(IEN) 0
"RTN","XUAF4",68,0)
 D F4($$STA(IEN),.ARRAY,"AM")
"RTN","XUAF4",69,0)
 Q $S(ARRAY:1,1:0)
"RTN","XUAF4",70,0)
 ;
"RTN","XUAF4",71,0)
RT(IEN) ;realigned to
"RTN","XUAF4",72,0)
 N ARRAY Q:'$G(IEN) 0
"RTN","XUAF4",73,0)
 D F4($$STA(IEN),.ARRAY)
"RTN","XUAF4",74,0)
 Q $G(ARRAY("REALIGNED TO"))
"RTN","XUAF4",75,0)
 ;
"RTN","XUAF4",76,0)
RF(IEN) ;realigned from
"RTN","XUAF4",77,0)
 N ARRAY Q:'$G(IEN) 0
"RTN","XUAF4",78,0)
 D F4($$STA(IEN),.ARRAY)
"RTN","XUAF4",79,0)
 Q $G(ARRAY("REALIGNED FROM"))
"RTN","XUAF4",80,0)
 ;
"RTN","XUAF4",81,0)
O99(IEN) ;returns pointer to new station number IEN
"RTN","XUAF4",82,0)
 Q:$O(^DIC(4,"AOLD99",+$G(IEN),""))="" ""
"RTN","XUAF4",83,0)
 Q $O(^DIC(4,"D",$O(^DIC(4,"AOLD99",+$G(IEN),"")),0))
"RTN","XUAF4",84,0)
 ;
"RTN","XUAF4",85,0)
LEGACY(STA) ; -- legacy station number (1=yes; 0=no)
"RTN","XUAF4",86,0)
 Q $S($$RT^XUAF4(+$$IEN^XUAF4(STA)):1,1:0)
"RTN","XUAF4",87,0)
 ;
"RTN","XUAF4",88,0)
PRNT(STA) ; -- parent facility
"RTN","XUAF4",89,0)
 N X S STA=$G(STA) Q:STA="" "0^no station number passed"
"RTN","XUAF4",90,0)
 D PARENT("X",STA,"PARENT FACILITY") S X=$O(X("P",0))
"RTN","XUAF4",91,0)
 Q:'X "0^no parent associated with input station number"
"RTN","XUAF4",92,0)
 Q X_U_$P($G(X("P",+X)),U,2)_U_$P($G(X("P",+X)),U)
"RTN","XUAF4",93,0)
 ;
"RTN","XUAF4",94,0)
NAME(IEN) ; -- Official Name
"RTN","XUAF4",95,0)
 Q:$P($G(^DIC(4,+IEN,99)),U,3)'="" $P($G(^DIC(4,+IEN,99)),U,3)
"RTN","XUAF4",96,0)
 Q $P($G(^DIC(4,+IEN,0)),U)
"RTN","XUAF4",97,0)
 ;
"RTN","XUAF4",98,0)
ACTIVE(IEN) ; -- active facility (1=active, 0=inactive)
"RTN","XUAF4",99,0)
 ;
"RTN","XUAF4",100,0)
 Q '$P($G(^DIC(4,+IEN,99)),U,4)
"RTN","XUAF4",101,0)
 ;
"RTN","XUAF4",102,0)
PADD(IEN) ; -- physical address (street addr^city^state^zip)
"RTN","XUAF4",103,0)
 ;
"RTN","XUAF4",104,0)
 N X,STATE
"RTN","XUAF4",105,0)
 ;
"RTN","XUAF4",106,0)
 S X=$P($G(^DIC(4,+IEN,0)),U,2)
"RTN","XUAF4",107,0)
 S STATE=$P($G(^DIC(5,+X,0)),U,2)
"RTN","XUAF4",108,0)
 S X=$G(^DIC(4,+IEN,1)) Q:X="" X
"RTN","XUAF4",109,0)
 ;
"RTN","XUAF4",110,0)
 Q $P(X,U)_U_$P(X,U,3)_U_STATE_U_$P(X,U,4)
"RTN","XUAF4",111,0)
 ;
"RTN","XUAF4",112,0)
MADD(IEN) ; -- mailing address (street addr^city^state^zip)
"RTN","XUAF4",113,0)
 ;
"RTN","XUAF4",114,0)
 N X,STATE
"RTN","XUAF4",115,0)
 ;
"RTN","XUAF4",116,0)
 S X=$G(^DIC(4,+IEN,4)) Q:X="" X
"RTN","XUAF4",117,0)
 S STATE=$P($G(^DIC(5,+$P(X,U,4),0)),U,2)
"RTN","XUAF4",118,0)
 ;
"RTN","XUAF4",119,0)
 Q $P(X,U)_U_$P(X,U,3)_U_STATE_U_$P(X,U,5)
"RTN","XUAF4",120,0)
 ;
"RTN","XUAF4",121,0)
F4(STA,ARRAY,FLAG,ONDT) ;File #4 multipurpose API
"RTN","XUAF4",122,0)
 ;
"RTN","XUAF4",123,0)
 ;INPUT
"RTN","XUAF4",124,0)
 ;       STA     Station number (required)
"RTN","XUAF4",125,0)
 ;
"RTN","XUAF4",126,0)
 ;    [.]ARRAY   $NAME reference for return values.  (required)
"RTN","XUAF4",127,0)
 ;
"RTN","XUAF4",128,0)
 ;       FLAG    A = Active entries only.  (optional)
"RTN","XUAF4",129,0)
 ;               M = Medical treating facilities only.
"RTN","XUAF4",130,0)
 ;
"RTN","XUAF4",131,0)
 ;       ONDT    Return name on this FM internal date.  (optional);
"RTN","XUAF4",132,0)
 ;
"RTN","XUAF4",133,0)
 ;OUTPUT
"RTN","XUAF4",134,0)
 ;       ARRAY                     IEN or '0^error message'
"RTN","XUAF4",135,0)
 ;       ARRAY("NAME")             name
"RTN","XUAF4",136,0)
 ;       ARRAY("VA NAME")          offical va name
"RTN","XUAF4",137,0)
 ;       ARRAY("STATION NUMBER")   station number
"RTN","XUAF4",138,0)
 ;       ARRAY("TYPE")             facilty type name
"RTN","XUAF4",139,0)
 ;       ARRAY("INACTIVE")         inactive date (0=not inactive)
"RTN","XUAF4",140,0)
 ;       note: if inactive date not available but entry inactive then 1
"RTN","XUAF4",141,0)
 ;
"RTN","XUAF4",142,0)
 ;       ARRAY("REALIGNED TO")     IEN^station number^date
"RTN","XUAF4",143,0)
 ;       ARRAY("REALIGNED FROM")   IEN^station number^date
"RTN","XUAF4",144,0)
 ;
"RTN","XUAF4",145,0)
 K ARRAY
"RTN","XUAF4",146,0)
 S STA=$G(STA),FLAG=$G(FLAG),ONDT=$G(ONDT)
"RTN","XUAF4",147,0)
 I STA="" S ARRAY="0^invalid input STA - required" Q
"RTN","XUAF4",148,0)
 ;
"RTN","XUAF4",149,0)
 N IEN,N99,TO,FM,I,RDT,NAME,VANAME,HDT
"RTN","XUAF4",150,0)
 ;
"RTN","XUAF4",151,0)
 S IEN=$$IEN(STA)
"RTN","XUAF4",152,0)
 I 'IEN S ARRAY="0^station number does not exist" Q
"RTN","XUAF4",153,0)
 S N99=$G(^DIC(4,+IEN,99))
"RTN","XUAF4",154,0)
 S ARRAY=$$SCRN() Q:'ARRAY
"RTN","XUAF4",155,0)
 ;
"RTN","XUAF4",156,0)
 S ARRAY("NAME")=$P(^DIC(4,IEN,0),U)
"RTN","XUAF4",157,0)
 S ARRAY("VA NAME")=$P(N99,U,3)
"RTN","XUAF4",158,0)
 S ARRAY("STATION NUMBER")=STA
"RTN","XUAF4",159,0)
 S ARRAY("TYPE")=$P($G(^DIC(4.1,+$G(^DIC(4,IEN,3)),0)),U)
"RTN","XUAF4",160,0)
 ;
"RTN","XUAF4",161,0)
 ;realignments
"RTN","XUAF4",162,0)
 S TO=$O(^DIC(4,"ARTO",IEN,0)) D:TO
"RTN","XUAF4",163,0)
 .S RDT=$O(^DIC(4,"ART",TO,IEN,0))
"RTN","XUAF4",164,0)
 .S ARRAY("REALIGNED TO")=TO_U_$$STA(TO)_U_RDT
"RTN","XUAF4",165,0)
 S FM=$O(^DIC(4,"ARFM",IEN,0)) D:FM
"RTN","XUAF4",166,0)
 .S ARRAY("REALIGNED FROM")=FM_U_$$STA(FM)_U_$O(^DIC(4,"ARF",FM,IEN,0))
"RTN","XUAF4",167,0)
 ;
"RTN","XUAF4",168,0)
 S I=$O(^DIC(4,"AI",IEN,0)),I=$S(I:I,$G(RDT):RDT,1:+$P(N99,U,4))
"RTN","XUAF4",169,0)
 S ARRAY("INACTIVE")=I
"RTN","XUAF4",170,0)
 ;
"RTN","XUAF4",171,0)
 Q:'ONDT
"RTN","XUAF4",172,0)
 ;
"RTN","XUAF4",173,0)
 ;get name for date
"RTN","XUAF4",174,0)
 S NAME=ARRAY("NAME")
"RTN","XUAF4",175,0)
 S VANAME=ARRAY("VA NAME")
"RTN","XUAF4",176,0)
 S HDT=DT
"RTN","XUAF4",177,0)
 F  S HDT=$O(^DIC(4,IEN,999,HDT),-1) Q:('HDT!(HDT<ONDT))  D
"RTN","XUAF4",178,0)
 .N X S X=$G(^DIC(4,IEN,999,HDT,0)) Q:X=""
"RTN","XUAF4",179,0)
 .S:$P(X,U,2)'="" NAME=$P(X,U,2)
"RTN","XUAF4",180,0)
 .S:$P(X,U,3)'="" VANAME=$P(X,U,3)
"RTN","XUAF4",181,0)
 S ARRAY("NAME")=NAME
"RTN","XUAF4",182,0)
 S ARRAY("VA NAME")=VANAME
"RTN","XUAF4",183,0)
 ;
"RTN","XUAF4",184,0)
 Q
"RTN","XUAF4",185,0)
 ;
"RTN","XUAF4",186,0)
IDT(IEN) ; inactive date
"RTN","XUAF4",187,0)
 N IDT,ND,XDT
"RTN","XUAF4",188,0)
 S IEN=$G(IEN) Q:'IEN IEN
"RTN","XUAF4",189,0)
 S XDT=9999999,IDT=""
"RTN","XUAF4",190,0)
 F  S XDT=$O(^DIC(4,+IEN,999,XDT),-1) Q:'XDT  D  Q:IDT
"RTN","XUAF4",191,0)
 .S ND=$G(^DIC(4,+IEN,999,XDT,0)) Q:ND="" ND
"RTN","XUAF4",192,0)
 .S IDT=$S($P(ND,U,5):XDT,$P(ND,U,7):XDT,1:IDT)
"RTN","XUAF4",193,0)
 Q IDT
"RTN","XUAF4",194,0)
 ;
"RTN","XUAF4",195,0)
SCRN() ;sreen IEN
"RTN","XUAF4",196,0)
 N X S X=$E(N99,1,3)
"RTN","XUAF4",197,0)
 I FLAG["A",$P(N99,U,4) Q "0^inactive facility"
"RTN","XUAF4",198,0)
 I FLAG["M",$S(X<400:1,X>759:1,X<700:0,X<750:1,1:0) Q "0^not a treating facility"
"RTN","XUAF4",199,0)
 Q IEN
"RTN","XUAF4",200,0)
 ;
"RTN","XUAF4",201,0)
LOOKUP ; -- lookup an enty by coding system / ID pair
"RTN","XUAF4",202,0)
 ;
"RTN","XUAF4",203,0)
 N DIC,D
"RTN","XUAF4",204,0)
 ;
"RTN","XUAF4",205,0)
 S DIC="^DIC(4,",DIC(0)="QEA",D="XUMFIDX" D IX^DIC
"RTN","XUAF4",206,0)
 ;
"RTN","XUAF4",207,0)
 Q
"RTN","XUAF4",208,0)
 ;
"RTN","XUAF4",209,0)
IDX(CDSYS,ID) ; -- return IEN for a given coding system / ID pair
"RTN","XUAF4",210,0)
 ;
"RTN","XUAF4",211,0)
 ;INPUT
"RTN","XUAF4",212,0)
 ;       CDSYS   coding system (required)
"RTN","XUAF4",213,0)
 ;       ID      identifier (required)
"RTN","XUAF4",214,0)
 ;OUTPUT
"RTN","XUAF4",215,0)
 ;       $$      Internal Entry Number
"RTN","XUAF4",216,0)
 ;
"RTN","XUAF4",217,0)
 N IEN
"RTN","XUAF4",218,0)
 ;
"RTN","XUAF4",219,0)
 S CDSYS=$G(CDSYS),ID=$G(ID)
"RTN","XUAF4",220,0)
 ;
"RTN","XUAF4",221,0)
 Q:CDSYS="" "0^CDSYS required"
"RTN","XUAF4",222,0)
 Q:ID="" "0^ID required"
"RTN","XUAF4",223,0)
 ;
"RTN","XUAF4",224,0)
 S IEN=$O(^DIC(4,"XUMFIDX",CDSYS,ID,0))
"RTN","XUAF4",225,0)
 ;
"RTN","XUAF4",226,0)
 Q $S(IEN:IEN,1:"0^not found")
"RTN","XUAF4",227,0)
 ;
"RTN","XUAF4",228,0)
ID(CDSYS,IEN) ; returns the ID for a given coding system / IEN
"RTN","XUAF4",229,0)
 ;
"RTN","XUAF4",230,0)
 ;INPUT
"RTN","XUAF4",231,0)
 ;       CDSYS   coding system (required)
"RTN","XUAF4",232,0)
 ;       IEN     Internal Entry Number (required)
"RTN","XUAF4",233,0)
 ;OUTPUT
"RTN","XUAF4",234,0)
 ;       $$      Identifier
"RTN","XUAF4",235,0)
 ;
"RTN","XUAF4",236,0)
 N ID,IDX
"RTN","XUAF4",237,0)
 ;
"RTN","XUAF4",238,0)
 S CDSYS=$G(CDSYS),IEN=$G(IEN)
"RTN","XUAF4",239,0)
 Q:CDSYS="" "" Q:'IEN "" Q:'$D(^DIC(4,IEN)) ""
"RTN","XUAF4",240,0)
 ;
"RTN","XUAF4",241,0)
 S IDX=$O(^DIC(4,IEN,9999,"B",CDSYS,0)) Q:'IDX ""
"RTN","XUAF4",242,0)
 ;
"RTN","XUAF4",243,0)
 Q $P($G(^DIC(4,IEN,9999,IDX,0)),U,2)
"RTN","XUAF4",244,0)
 ;
"RTN","XUAF4",245,0)
CDSYS(Y) ; coding systems
"RTN","XUAF4",246,0)
 ;
"RTN","XUAF4",247,0)
 ;INPUT/OUTPUT
"RTN","XUAF4",248,0)
 ;       .Y     Y(CDSYS) = $D local system ^ coding system name
"RTN","XUAF4",249,0)
 ;
"RTN","XUAF4",250,0)
 S Y("DMIS")=$D(^DIC(4,"XUMFIDX","DMIS"))_U_"DoD DMIS ID"
"RTN","XUAF4",251,0)
 S Y("VASTANUM")=$D(^DIC(4,"XUMFIDX","VASTANUM"))_U_"VA Station Number"
"RTN","XUAF4",252,0)
 ;
"RTN","XUAF4",253,0)
 Q
"RTN","XUAF4",254,0)
 ;
"RTN","XUMF218A")
0^9^B2270158
"RTN","XUMF218A",1,0)
XUMF218A ;OIFO-OAK/RAM - Load DMIS ID's;04/15/02
"RTN","XUMF218A",2,0)
 ;;8.0;KERNEL;**218,261**;Jul 10, 1995
"RTN","XUMF218A",3,0)
 ;
"RTN","XUMF218A",4,0)
 ;
"RTN","XUMF218A",5,0)
EN ; -- entry point
"RTN","XUMF218A",6,0)
 ;
"RTN","XUMF218A",7,0)
 N ID,NAME,FDA,ERROR,IEN,IENS,X,XUMF,STANUM,OFNME,AGENCY
"RTN","XUMF218A",8,0)
 ;
"RTN","XUMF218A",9,0)
 S XUMF=1
"RTN","XUMF218A",10,0)
 ;
"RTN","XUMF218A",11,0)
 S ID=""
"RTN","XUMF218A",12,0)
 F  S ID=$O(^TMP("XUMF ARRAY",$J,ID)) Q:ID=""  D
"RTN","XUMF218A",13,0)
 .S X=^TMP("XUMF ARRAY",$J,ID)
"RTN","XUMF218A",14,0)
 .S STANUM=$P(X,U,3)
"RTN","XUMF218A",15,0)
 .S IEN=$$IEN^XUMF(4,"DMIS",ID)
"RTN","XUMF218A",16,0)
 .I 'IEN,$G(STANUM)'="" S IEN=$O(^DIC(4,"D",STANUM,0))
"RTN","XUMF218A",17,0)
 .S IENS=$S(IEN:IEN_",",1:"+1,")
"RTN","XUMF218A",18,0)
 .S NAME=$P(X,U,2)
"RTN","XUMF218A",19,0)
 .S OFNME=$P(X,U,6)
"RTN","XUMF218A",20,0)
 .S AGENCY=$P(X,U,17)
"RTN","XUMF218A",21,0)
 .K FDA,IEN1
"RTN","XUMF218A",22,0)
 .S FDA(4,IENS,.01)=NAME
"RTN","XUMF218A",23,0)
 .S FDA(4,IENS,100)=OFNME
"RTN","XUMF218A",24,0)
 .S FDA(4,IENS,95)=$P(AGENCY,"~")
"RTN","XUMF218A",25,0)
 .D UPDATE^DIE("E","FDA","IEN1")
"RTN","XUMF218A",26,0)
 .I 'IEN S IEN=$G(IEN1(1))
"RTN","XUMF218A",27,0)
 .Q:'IEN
"RTN","XUMF218A",28,0)
 .S IENS="?+1,"_IEN_","
"RTN","XUMF218A",29,0)
 .K FDA
"RTN","XUMF218A",30,0)
 .S FDA(4.9999,IENS,.01)="DMIS"
"RTN","XUMF218A",31,0)
 .S FDA(4.9999,IENS,.02)=ID
"RTN","XUMF218A",32,0)
 .D UPDATE^DIE("E","FDA")
"RTN","XUMF218A",33,0)
 ;
"RTN","XUMF218A",34,0)
 Q
"RTN","XUMF218A",35,0)
 ;
"RTN","XUMF218A",36,0)
FTCLEAN ; -- add missing facility types
"RTN","XUMF218A",37,0)
 ;
"RTN","XUMF218A",38,0)
 N NAME,FULL,FDA
"RTN","XUMF218A",39,0)
 ;
"RTN","XUMF218A",40,0)
 S NAME=""
"RTN","XUMF218A",41,0)
 F  S NAME=$O(^TMP("XUMF ARRAY",$J,NAME)) Q:NAME=""  D
"RTN","XUMF218A",42,0)
 .S FULL=$P(^TMP("XUMF ARRAY",$J,NAME),U,3)
"RTN","XUMF218A",43,0)
 .D
"RTN","XUMF218A",44,0)
 ..K FDA
"RTN","XUMF218A",45,0)
 ..S FDA(4.1,"?+1,",.01)=NAME
"RTN","XUMF218A",46,0)
 ..S FDA(4.1,"?+1,",1)=FULL
"RTN","XUMF218A",47,0)
 ..S FDA(4.1,"?+1,",3)="N"
"RTN","XUMF218A",48,0)
 ..N NAME
"RTN","XUMF218A",49,0)
 ..D UPDATE^DIE("E","FDA",,"ERR")
"RTN","XUMF218A",50,0)
 ;
"RTN","XUMF218A",51,0)
 Q
"RTN","XUMF218A",52,0)
 ;
"RTN","XUMF261P")
0^7^B1259314
"RTN","XUMF261P",1,0)
XUMF261P ;OIFO-OAK/RAM - XUMF *261 post init;04/15/02
"RTN","XUMF261P",2,0)
 ;;8.0;KERNEL;**261**;Jul 10, 1995
"RTN","XUMF261P",3,0)
 ;
"RTN","XUMF261P",4,0)
 Q
"RTN","XUMF261P",5,0)
 ;
"RTN","XUMF261P",6,0)
POST ; -- post init
"RTN","XUMF261P",7,0)
 ;
"RTN","XUMF261P",8,0)
 N DIK,DA,STA,IEN,IENS,FDA,FTYP,XUMF
"RTN","XUMF261P",9,0)
 ;
"RTN","XUMF261P",10,0)
 ; delete existing traditional x-ref on IDENTIFIER .02
"RTN","XUMF261P",11,0)
 D DELIX^DDMOD(4.9999,.02,1)
"RTN","XUMF261P",12,0)
 D DELIX^DDMOD(4.9999,.02,2)
"RTN","XUMF261P",13,0)
 ;
"RTN","XUMF261P",14,0)
 K ^DIC(4,"A XUMF ID")
"RTN","XUMF261P",15,0)
 K ^DIC(4,"A XUMF IEN")
"RTN","XUMF261P",16,0)
 ;
"RTN","XUMF261P",17,0)
 S XUMF=1
"RTN","XUMF261P",18,0)
 ;
"RTN","XUMF261P",19,0)
 ; populate VA station number in IDENTIFIER
"RTN","XUMF261P",20,0)
 S STA=""
"RTN","XUMF261P",21,0)
 F  S STA=$O(^DIC(4,"D",STA)) Q:STA=""  D
"RTN","XUMF261P",22,0)
 .S IEN=$O(^DIC(4,"D",STA,0))
"RTN","XUMF261P",23,0)
 .S IENS="?+1,"_IEN_","
"RTN","XUMF261P",24,0)
 .K FDA
"RTN","XUMF261P",25,0)
 .S FDA(4.9999,IENS,.01)="VASTANUM"
"RTN","XUMF261P",26,0)
 .S FDA(4.9999,IENS,.02)=STA
"RTN","XUMF261P",27,0)
 .D
"RTN","XUMF261P",28,0)
 ..N IEN,STA
"RTN","XUMF261P",29,0)
 ..D UPDATE^DIE("E","FDA")
"RTN","XUMF261P",30,0)
 ;
"RTN","XUMF261P",31,0)
 ; re-index IDENTIFIER .02 (XUMFID and XUMFIDX)
"RTN","XUMF261P",32,0)
 S IEN=0
"RTN","XUMF261P",33,0)
 F  S IEN=$O(^DIC(4,IEN)) Q:'IEN  D
"RTN","XUMF261P",34,0)
 .S DIK="^DIC(4,"_IEN_",9999,"
"RTN","XUMF261P",35,0)
 .S DA(1)=IEN,DIK(1)=".02"
"RTN","XUMF261P",36,0)
 .D ENALL^DIK
"RTN","XUMF261P",37,0)
 ;
"RTN","XUMF261P",38,0)
 K ^DIC(4,"XUMFID","DMIS")
"RTN","XUMF261P",39,0)
 K ^DIC(4,"XUMFID","VASTANUM")
"RTN","XUMF261P",40,0)
 ;
"RTN","XUMF261P",41,0)
 ; task job to load DMIS IDs
"RTN","XUMF261P",42,0)
 D BG^XUMF218
"RTN","XUMF261P",43,0)
 ;
"RTN","XUMF261P",44,0)
 Q
"RTN","XUMF261P",45,0)
 ;
"RTN","XUMF4")
0^2^B71300214
"RTN","XUMF4",1,0)
XUMF4 ;OIFO-OAK/RAM - Institution File Clean Up; 06/28/00
"RTN","XUMF4",2,0)
 ;;8.0;KERNEL;**206,209,212,261**;Jul 10, 1995
"RTN","XUMF4",3,0)
 ;
"RTN","XUMF4",4,0)
 ;
"RTN","XUMF4",5,0)
EN ; -- entry point
"RTN","XUMF4",6,0)
 ;
"RTN","XUMF4",7,0)
 K ^TMP("XUMF ARRAY",$J)
"RTN","XUMF4",8,0)
 ;
"RTN","XUMF4",9,0)
 N PARAM,XUMFLAG,ERROR,TEST,ERR
"RTN","XUMF4",10,0)
 ;
"RTN","XUMF4",11,0)
 S (ERROR,XUMFLAG,TEST)=0
"RTN","XUMF4",12,0)
 ;
"RTN","XUMF4",13,0)
 I $P($$PARAM^HLCS2,U,3)="T" S TEST=1
"RTN","XUMF4",14,0)
 ;
"RTN","XUMF4",15,0)
 L +^TMP("XUMF ARRAY",$J):0 D:'$T
"RTN","XUMF4",16,0)
 .S ERROR="1^another process is using the Master File Server"
"RTN","XUMF4",17,0)
 ;
"RTN","XUMF4",18,0)
 I ERROR D EXIT1 Q
"RTN","XUMF4",19,0)
 ;
"RTN","XUMF4",20,0)
 I '$D(^TMP("XUMF ARRAY",$J)) D
"RTN","XUMF4",21,0)
 .W !!,"...connecting with master file server..."
"RTN","XUMF4",22,0)
 .D MFS0
"RTN","XUMF4",23,0)
 ;
"RTN","XUMF4",24,0)
 I ERROR D EXIT1 Q
"RTN","XUMF4",25,0)
 ;
"RTN","XUMF4",26,0)
 I '$D(^TMP("XUMF ARRAY",$J)) D  D EXIT1 Q
"RTN","XUMF4",27,0)
 .S ERROR="1^Connection to master file server failed!"
"RTN","XUMF4",28,0)
 ;
"RTN","XUMF4",29,0)
 D FTCLEAN^XUMF4A I ERROR D EXIT1 Q
"RTN","XUMF4",30,0)
 ;
"RTN","XUMF4",31,0)
 K ^TMP("XUMF ARRAY",$J),^TMP("XUMF MFS",$J)
"RTN","XUMF4",32,0)
 ;
"RTN","XUMF4",33,0)
 W !!,"...connecting with master file server..."
"RTN","XUMF4",34,0)
 D MFS1
"RTN","XUMF4",35,0)
 ;
"RTN","XUMF4",36,0)
 I ERROR D EXIT1 Q
"RTN","XUMF4",37,0)
 ;
"RTN","XUMF4",38,0)
 I '$D(^TMP("XUMF ARRAY",$J)) D  Q
"RTN","XUMF4",39,0)
 .S ERROR="1^Connection to master file server failed!"
"RTN","XUMF4",40,0)
 .D EXIT1
"RTN","XUMF4",41,0)
 ;
"RTN","XUMF4",42,0)
 D EN^VALM("XUMF NAME")
"RTN","XUMF4",43,0)
 ;
"RTN","XUMF4",44,0)
 D EXIT1
"RTN","XUMF4",45,0)
 ;
"RTN","XUMF4",46,0)
 Q
"RTN","XUMF4",47,0)
 ;
"RTN","XUMF4",48,0)
RDSN ; - resolve duplicate station number
"RTN","XUMF4",49,0)
 ;
"RTN","XUMF4",50,0)
 I '$O(@VALMAR@("INDEX",0)) D  Q
"RTN","XUMF4",51,0)
 .W !!,"No duplicates to select from!",!
"RTN","XUMF4",52,0)
 .S VALMBCK="R" H 2
"RTN","XUMF4",53,0)
 ;
"RTN","XUMF4",54,0)
 N ENTRY,VALMY,DA,DR,DIE,STA,MERGED,FROM
"RTN","XUMF4",55,0)
 ;
"RTN","XUMF4",56,0)
 D EN^VALM2(XQORNOD(0),"OS")
"RTN","XUMF4",57,0)
 Q:'$D(VALMY)  Q:'$D(VALMAR)
"RTN","XUMF4",58,0)
 ;
"RTN","XUMF4",59,0)
 S DA=@VALMAR@("INDEX",+$O(VALMY(0)))
"RTN","XUMF4",60,0)
 S DR="99///@",DIE=4
"RTN","XUMF4",61,0)
 I DA D
"RTN","XUMF4",62,0)
 .I $O(^HLCS(870,"C",DA,0)) D  Q
"RTN","XUMF4",63,0)
 ..W !!?20,"Pointed to by HL7 Logical Link"
"RTN","XUMF4",64,0)
 ..W !?22,"*select other entry*",!!
"RTN","XUMF4",65,0)
 .D ^DIE
"RTN","XUMF4",66,0)
 ;
"RTN","XUMF4",67,0)
 D @($E($P(VALMAR,"XUMF ",2),1,4)_"^XUMF4")
"RTN","XUMF4",68,0)
 S VALMBCK="R"
"RTN","XUMF4",69,0)
 ;
"RTN","XUMF4",70,0)
 Q
"RTN","XUMF4",71,0)
 ;
"RTN","XUMF4",72,0)
 ;
"RTN","XUMF4",73,0)
DSTA ; -- duplicate station #s
"RTN","XUMF4",74,0)
 ;
"RTN","XUMF4",75,0)
 K ^TMP("XUMF DSTA",$J),^TMP("XUMF TMP",$J)
"RTN","XUMF4",76,0)
 ;
"RTN","XUMF4",77,0)
 I 'XUMFLAG D LOCAL
"RTN","XUMF4",78,0)
 ;
"RTN","XUMF4",79,0)
 S STA="",IEN=0
"RTN","XUMF4",80,0)
 F  S STA=$O(^DIC(4,"D",STA)) Q:STA=""  D
"RTN","XUMF4",81,0)
 .F  S IEN=$O(^DIC(4,"D",STA,IEN)) Q:'IEN  D
"RTN","XUMF4",82,0)
 ..Q:'$D(^TMP("XUMF ARRAY",$J,STA))
"RTN","XUMF4",83,0)
 ..S ^TMP("XUMF TMP",$J,STA,IEN)=$P(^DIC(4,IEN,0),U)
"RTN","XUMF4",84,0)
 ;
"RTN","XUMF4",85,0)
 S STA="",(VALMCNT,IEN)=0
"RTN","XUMF4",86,0)
 F  S STA=$O(^TMP("XUMF TMP",$J,STA)) Q:STA=""  D
"RTN","XUMF4",87,0)
 .Q:'$O(^TMP("XUMF TMP",$J,STA,+$O(^TMP("XUMF TMP",$J,STA,0))))
"RTN","XUMF4",88,0)
 .F  S IEN=$O(^TMP("XUMF TMP",$J,STA,IEN)) Q:'IEN  D
"RTN","XUMF4",89,0)
 ..S VALMCNT=VALMCNT+1
"RTN","XUMF4",90,0)
 ..S VAR="",NAME=$P(^TMP("XUMF TMP",$J,STA,IEN),U)
"RTN","XUMF4",91,0)
 ..S VAR=$$SETFLD^VALM1(VALMCNT,VAR,"ENTRY NUMBER")
"RTN","XUMF4",92,0)
 ..S VAR=$$SETFLD^VALM1(STA,VAR,"STATION NUMBER")
"RTN","XUMF4",93,0)
 ..S VAR=$$SETFLD^VALM1(NAME,VAR,"INSTITUTION NAME")
"RTN","XUMF4",94,0)
 ..S VAR=$$SETFLD^VALM1(IEN,VAR,"IEN")
"RTN","XUMF4",95,0)
 ..D SET^VALM10(VALMCNT,VAR,VALMCNT)
"RTN","XUMF4",96,0)
 ..S @VALMAR@("INDEX",VALMCNT)=IEN
"RTN","XUMF4",97,0)
 ;
"RTN","XUMF4",98,0)
 D:'VALMCNT
"RTN","XUMF4",99,0)
 .S VAR="",VAR=$$SETFLD^VALM1("***No duplicates***",VAR,"INSTITUTION NAME")
"RTN","XUMF4",100,0)
 .S VALMCNT=1
"RTN","XUMF4",101,0)
 .D SET^VALM10(VALMCNT,VAR,VALMCNT)
"RTN","XUMF4",102,0)
 ;
"RTN","XUMF4",103,0)
 K ^TMP("XUMF TMP",$J)
"RTN","XUMF4",104,0)
 ;
"RTN","XUMF4",105,0)
 Q
"RTN","XUMF4",106,0)
 ;
"RTN","XUMF4",107,0)
LOCAL ; -- auto-delete local/duplicate station numbers
"RTN","XUMF4",108,0)
 ;
"RTN","XUMF4",109,0)
 W !!,"This action will auto-delete local/duplicate station numbers."
"RTN","XUMF4",110,0)
 N Y S DIR(0)="Y",DIR("B")="YES" W !
"RTN","XUMF4",111,0)
 S DIR("A")="Do you wish to proceed"
"RTN","XUMF4",112,0)
 D ^DIR K DIR I 'Y Q
"RTN","XUMF4",113,0)
 ;
"RTN","XUMF4",114,0)
 S XUMFLAG=1
"RTN","XUMF4",115,0)
 D DXRF
"RTN","XUMF4",116,0)
 ;
"RTN","XUMF4",117,0)
 N IEN,STA,STANUM,VAR,NAME,FLAG,CNT
"RTN","XUMF4",118,0)
 ;
"RTN","XUMF4",119,0)
 S STA="",(IEN,CNT)=0
"RTN","XUMF4",120,0)
 F  S STA=$O(^DIC(4,"D",STA)) Q:STA=""  D
"RTN","XUMF4",121,0)
 .Q:'$O(^DIC(4,"D",STA,+$O(^DIC(4,"D",STA,0))))
"RTN","XUMF4",122,0)
 .S FLAG=0
"RTN","XUMF4",123,0)
 .F  S IEN=$O(^DIC(4,"D",STA,IEN)) Q:'IEN  D
"RTN","XUMF4",124,0)
 ..S:$O(^HLCS(870,"C",IEN,0)) FLAG=1
"RTN","XUMF4",125,0)
 .Q:'FLAG
"RTN","XUMF4",126,0)
 .F  S IEN=$O(^DIC(4,"D",STA,IEN)) Q:'IEN  D
"RTN","XUMF4",127,0)
 ..Q:$O(^HLCS(870,"C",IEN,0))
"RTN","XUMF4",128,0)
 ..W !?5,"deleting duplicate station number ",STA," from IEN: ",IEN
"RTN","XUMF4",129,0)
 ..H 1
"RTN","XUMF4",130,0)
 ..S DR="99///@",DIE=4,DA=IEN,CNT=CNT+1
"RTN","XUMF4",131,0)
 ..N IEN,STA,FLAG D ^DIE
"RTN","XUMF4",132,0)
 I CNT D EOP S CNT=0
"RTN","XUMF4",133,0)
 ;
"RTN","XUMF4",134,0)
 S STA="",IEN=0
"RTN","XUMF4",135,0)
 F  S STA=$O(^DIC(4,"D",STA)) Q:STA=""  D
"RTN","XUMF4",136,0)
 .Q:$D(^TMP("XUMF ARRAY",$J,STA))
"RTN","XUMF4",137,0)
 .Q:'$D(^TMP("XUMF ARRAY",$J))
"RTN","XUMF4",138,0)
 .F  S IEN=$O(^DIC(4,"D",STA,IEN)) Q:'IEN  D
"RTN","XUMF4",139,0)
 ..S DR="99///@",DIE=4,DA=IEN,CNT=CNT+1
"RTN","XUMF4",140,0)
 ..W !?5,"deleting local station number ",STA," from IEN: ",IEN
"RTN","XUMF4",141,0)
 ..H 1
"RTN","XUMF4",142,0)
 ..N IEN,STA D ^DIE
"RTN","XUMF4",143,0)
 I CNT D EOP S CNT=0
"RTN","XUMF4",144,0)
 ;
"RTN","XUMF4",145,0)
 Q
"RTN","XUMF4",146,0)
 ;
"RTN","XUMF4",147,0)
 ;
"RTN","XUMF4",148,0)
DXRF ; -- re-index "D" cross-reference
"RTN","XUMF4",149,0)
 ;
"RTN","XUMF4",150,0)
 N DIK
"RTN","XUMF4",151,0)
 ;
"RTN","XUMF4",152,0)
 K ^DIC(4,"D")
"RTN","XUMF4",153,0)
 ;
"RTN","XUMF4",154,0)
 S DIK="^DIC(4,",DIK(1)="99^D" D ENALL^DIK
"RTN","XUMF4",155,0)
 ;
"RTN","XUMF4",156,0)
 Q
"RTN","XUMF4",157,0)
 ;
"RTN","XUMF4",158,0)
 ;
"RTN","XUMF4",159,0)
LLCL ; -- local data
"RTN","XUMF4",160,0)
 ;
"RTN","XUMF4",161,0)
 K ^TMP("XUMF LLCL",$J)
"RTN","XUMF4",162,0)
 ;
"RTN","XUMF4",163,0)
 N STA,IEN,STANUM,VAR,NAME,FTYP
"RTN","XUMF4",164,0)
 ;
"RTN","XUMF4",165,0)
 S STA="",VALMCNT=0
"RTN","XUMF4",166,0)
 F  S STA=$O(^DIC(4,"D",STA)) Q:STA=""  D
"RTN","XUMF4",167,0)
 .S IEN=$O(^DIC(4,"D",STA,0))
"RTN","XUMF4",168,0)
 .S FTYP=$P($G(^DIC(4.1,+$G(^DIC(4,+IEN,3)),0)),U)
"RTN","XUMF4",169,0)
 .Q:$D(^TMP("XUMF ARRAY",$J,STA))
"RTN","XUMF4",170,0)
 .S VALMCNT=VALMCNT+1
"RTN","XUMF4",171,0)
 .S VAR="",NAME=$P(^DIC(4,IEN,0),U)
"RTN","XUMF4",172,0)
 .S VAR=$$SETFLD^VALM1(STA,VAR,"STATION NUMBER")
"RTN","XUMF4",173,0)
 .S VAR=$$SETFLD^VALM1(NAME,VAR,"INSTITUTION NAME")
"RTN","XUMF4",174,0)
 .S VAR=$$SETFLD^VALM1(IEN,VAR,"IEN")
"RTN","XUMF4",175,0)
 .S VAR=$$SETFLD^VALM1(FTYP,VAR,"FACILITY TYPE")
"RTN","XUMF4",176,0)
 .D SET^VALM10(VALMCNT,VAR,VALMCNT)
"RTN","XUMF4",177,0)
 .S @VALMAR@("INDEX",VALMCNT)=IEN
"RTN","XUMF4",178,0)
 ;
"RTN","XUMF4",179,0)
 D:'VALMCNT
"RTN","XUMF4",180,0)
 .S VAR="",VAR=$$SETFLD^VALM1("***None found***",VAR,"INSTITUTION NAME")
"RTN","XUMF4",181,0)
 .D SET^VALM10(1,VAR,1)
"RTN","XUMF4",182,0)
 ;
"RTN","XUMF4",183,0)
 Q
"RTN","XUMF4",184,0)
 ;
"RTN","XUMF4",185,0)
 ;
"RTN","XUMF4",186,0)
NATL ; -- national data to merge
"RTN","XUMF4",187,0)
 ;
"RTN","XUMF4",188,0)
 K ^TMP("XUMF NATL",$J)
"RTN","XUMF4",189,0)
 ;
"RTN","XUMF4",190,0)
 N STA,VAR,NAME,TYPE,STATE
"RTN","XUMF4",191,0)
 ;
"RTN","XUMF4",192,0)
 S STA="",VALMCNT=0
"RTN","XUMF4",193,0)
 F  S STA=$O(^TMP("XUMF ARRAY",$J,STA)) Q:STA=""  D
"RTN","XUMF4",194,0)
 .Q:$D(^DIC(4,"D",STA))
"RTN","XUMF4",195,0)
 .S VALMCNT=VALMCNT+1
"RTN","XUMF4",196,0)
 .S VAR="",NAME=$P(^TMP("XUMF ARRAY",$J,STA),U,2)
"RTN","XUMF4",197,0)
 .S TYPE=$P($P(^TMP("XUMF ARRAY",$J,STA),U,5),"~")
"RTN","XUMF4",198,0)
 .S STATE=$P(^TMP("XUMF ARRAY",$J,STA),U,8)
"RTN","XUMF4",199,0)
 .S VAR=$$SETFLD^VALM1(STA,VAR,"STATION NUMBER")
"RTN","XUMF4",200,0)
 .S VAR=$$SETFLD^VALM1(NAME,VAR,"NATIONAL NAME")
"RTN","XUMF4",201,0)
 .S VAR=$$SETFLD^VALM1(STATE,VAR,"STATE")
"RTN","XUMF4",202,0)
 .S VAR=$$SETFLD^VALM1(TYPE,VAR,"TYPE")
"RTN","XUMF4",203,0)
 .D SET^VALM10(VALMCNT,VAR,VALMCNT)
"RTN","XUMF4",204,0)
 ;
"RTN","XUMF4",205,0)
 D:'VALMCNT
"RTN","XUMF4",206,0)
 .S VAR="",VAR=$$SETFLD^VALM1("***None found***",VAR,"NATIONAL NAME")
"RTN","XUMF4",207,0)
 .D SET^VALM10(1,VAR,1)
"RTN","XUMF4",208,0)
 ;
"RTN","XUMF4",209,0)
 Q
"RTN","XUMF4",210,0)
 ;
"RTN","XUMF4",211,0)
 ;
"RTN","XUMF4",212,0)
NAME ; -- compare INSTITUTION name vs national name
"RTN","XUMF4",213,0)
 ;
"RTN","XUMF4",214,0)
 K ^TMP("XUMF NAME",$J),^TMP("XUMF TABLE",$J)
"RTN","XUMF4",215,0)
 ;
"RTN","XUMF4",216,0)
 N STA,IEN,NAME,GOLD,NAME,VAR,ARRAY
"RTN","XUMF4",217,0)
 ;
"RTN","XUMF4",218,0)
 D DXRF
"RTN","XUMF4",219,0)
 ;
"RTN","XUMF4",220,0)
 S STA="",(IEN,VALMCNT)=0
"RTN","XUMF4",221,0)
 F  S STA=$O(^DIC(4,"D",STA)) Q:STA=""  D
"RTN","XUMF4",222,0)
 .S IEN=$O(^DIC(4,"D",STA,0))
"RTN","XUMF4",223,0)
 .S GOLD=$P($G(^TMP("XUMF ARRAY",$J,STA)),U,2)
"RTN","XUMF4",224,0)
 .S NAME=$P(^DIC(4,IEN,0),U)
"RTN","XUMF4",225,0)
 .S ^TMP("XUMF TABLE",$J,STA,IEN)=NAME_U_GOLD
"RTN","XUMF4",226,0)
 ;
"RTN","XUMF4",227,0)
 F  S STA=$O(^TMP("XUMF ARRAY",$J,STA)) Q:STA=""  D
"RTN","XUMF4",228,0)
 .Q:$D(^TMP("XUMF TABLE",$J,STA))
"RTN","XUMF4",229,0)
 .S NAME=$P(^TMP("XUMF ARRAY",$J,STA),U,2)
"RTN","XUMF4",230,0)
 .S ^TMP("XUMF TABLE",$J,STA,9999)="^"_NAME
"RTN","XUMF4",231,0)
 ;
"RTN","XUMF4",232,0)
 S (IEN,VALMCNT)=0
"RTN","XUMF4",233,0)
 F  S STA=$O(^TMP("XUMF TABLE",$J,STA)) Q:STA=""  D
"RTN","XUMF4",234,0)
 .F  S IEN=$O(^TMP("XUMF TABLE",$J,STA,IEN)) Q:'IEN  D
"RTN","XUMF4",235,0)
 ..S GOLD=$P(^TMP("XUMF TABLE",$J,STA,IEN),U,2)
"RTN","XUMF4",236,0)
 ..S NAME=$P(^TMP("XUMF TABLE",$J,STA,IEN),U)
"RTN","XUMF4",237,0)
 ..S VALMCNT=VALMCNT+1,VAR=""
"RTN","XUMF4",238,0)
 ..S VAR=$$SETFLD^VALM1(STA,VAR,"STATION NUMBER")
"RTN","XUMF4",239,0)
 ..S VAR=$$SETFLD^VALM1(NAME,VAR,"INSTITUTION NAME")
"RTN","XUMF4",240,0)
 ..S VAR=$$SETFLD^VALM1(GOLD,VAR,"GOLD NAME")
"RTN","XUMF4",241,0)
 ..D SET^VALM10(VALMCNT,VAR,VALMCNT)
"RTN","XUMF4",242,0)
 ;
"RTN","XUMF4",243,0)
 D:'VALMCNT
"RTN","XUMF4",244,0)
 .S VAR="",VAR=$$SETFLD^VALM1("***None found***",VAR,"INSTITUTION NAME")
"RTN","XUMF4",245,0)
 .D SET^VALM10(1,VAR,1)
"RTN","XUMF4",246,0)
 ;
"RTN","XUMF4",247,0)
 K ^TMP("XUMF TABLE",$J)
"RTN","XUMF4",248,0)
 ;
"RTN","XUMF4",249,0)
 Q
"RTN","XUMF4",250,0)
 ;
"RTN","XUMF4",251,0)
 ;
"RTN","XUMF4",252,0)
MFS0 ; -- get national facility type file from Master File Server
"RTN","XUMF4",253,0)
 ;
"RTN","XUMF4",254,0)
 D FACTYP^XUMF4A
"RTN","XUMF4",255,0)
 D STATE^XUMF4A
"RTN","XUMF4",256,0)
 ;
"RTN","XUMF4",257,0)
 S PARAM("LLNK")="XUMF MFR^XUMF "_$S('TEST:"FORUM",1:"TEST")
"RTN","XUMF4",258,0)
 S PARAM("PROTOCOL")=$O(^ORD(101,"B","XUMF MFQ",0))
"RTN","XUMF4",259,0)
 ;
"RTN","XUMF4",260,0)
 W !!,"...getting FACILITY TYPE file..."
"RTN","XUMF4",261,0)
 D MAIN^XUMFP(4.1,"ALL",7,.PARAM,.ERROR) Q:ERROR
"RTN","XUMF4",262,0)
 D MAIN^XUMFI(4.1,"ALL",7,.PARAM,.ERROR) Q:ERROR
"RTN","XUMF4",263,0)
 D MAIN^XUMFH
"RTN","XUMF4",264,0)
 ;
"RTN","XUMF4",265,0)
 Q
"RTN","XUMF4",266,0)
 ;
"RTN","XUMF4",267,0)
MFS1 ; -- get national facility type file from Master File Server
"RTN","XUMF4",268,0)
 ;
"RTN","XUMF4",269,0)
 S PARAM("LLNK")="XUMF MFR^XUMF "_$S('TEST:"FORUM",1:"TEST")
"RTN","XUMF4",270,0)
 S PARAM("PROTOCOL")=$O(^ORD(101,"B","XUMF MFQ",0))
"RTN","XUMF4",271,0)
 ;
"RTN","XUMF4",272,0)
 W !!,"...getting INSTITUTION file..."
"RTN","XUMF4",273,0)
 W !,"...please wait...(approx. 5 minutes)..."
"RTN","XUMF4",274,0)
 D MAIN^XUMFP(4,"ALL",7,.PARAM,.ERROR) Q:ERROR
"RTN","XUMF4",275,0)
 D MAIN^XUMFI(4,"ALL",7,.PARAM,.ERROR) Q:ERROR
"RTN","XUMF4",276,0)
 D MAIN^XUMFH
"RTN","XUMF4",277,0)
 ;
"RTN","XUMF4",278,0)
 Q
"RTN","XUMF4",279,0)
 ;
"RTN","XUMF4",280,0)
EXIT ; -- cleanup and quit
"RTN","XUMF4",281,0)
 ;
"RTN","XUMF4",282,0)
 K:$D(VALMAR) @VALMAR
"RTN","XUMF4",283,0)
 ;
"RTN","XUMF4",284,0)
 Q
"RTN","XUMF4",285,0)
 ;
"RTN","XUMF4",286,0)
EXIT1 ;
"RTN","XUMF4",287,0)
 ;
"RTN","XUMF4",288,0)
 K ^TMP("XUMF ARRAY",$J),^TMP("XUMF MFS",$J)
"RTN","XUMF4",289,0)
 K ^TMP("DIERR",$J)
"RTN","XUMF4",290,0)
 ;
"RTN","XUMF4",291,0)
 L -^TMP("XUMF ARRAY",$J)
"RTN","XUMF4",292,0)
 ;
"RTN","XUMF4",293,0)
 I ERROR D
"RTN","XUMF4",294,0)
 .N XMY S XMY("G.XUMF INSTITUTION")=""
"RTN","XUMF4",295,0)
 .D EM^XUMFH(ERROR,.ERR,"IFR CLEANUP",.XMY)
"RTN","XUMF4",296,0)
 .W !!,ERROR,!,$G(ERR),!
"RTN","XUMF4",297,0)
 ;
"RTN","XUMF4",298,0)
 Q
"RTN","XUMF4",299,0)
 ;
"RTN","XUMF4",300,0)
EOP ; -- End-of-Page
"RTN","XUMF4",301,0)
 ;
"RTN","XUMF4",302,0)
 S DIR(0)="E"
"RTN","XUMF4",303,0)
 D ^DIR,CLEAR^VALM1
"RTN","XUMF4",304,0)
 S VALMBCK="R"
"RTN","XUMF4",305,0)
 ;
"RTN","XUMF4",306,0)
 Q
"RTN","XUMF4",307,0)
 ;
"RTN","XUMF4A")
0^10^B55636961
"RTN","XUMF4A",1,0)
XUMF4A ;CIOFO-SF/RAM - Institution File Clean Up; 06/28/99
"RTN","XUMF4A",2,0)
 ;;8.0;KERNEL;**206,209,212,261**;Jul 10, 1995
"RTN","XUMF4A",3,0)
 ;
"RTN","XUMF4A",4,0)
 ;
"RTN","XUMF4A",5,0)
EN ; -- entry point
"RTN","XUMF4A",6,0)
 ;
"RTN","XUMF4A",7,0)
 I $$CDSN D  Q
"RTN","XUMF4A",8,0)
 .D MSG^VALM10("Duplicates sta #s exist! -- NOTHING UPDATED!!!")
"RTN","XUMF4A",9,0)
 .H 5
"RTN","XUMF4A",10,0)
 .S VALMBCK="R"
"RTN","XUMF4A",11,0)
 ;
"RTN","XUMF4A",12,0)
 W "...working",!
"RTN","XUMF4A",13,0)
 D DSN,CSN,GOLD,ASSC,HIST
"RTN","XUMF4A",14,0)
 ;
"RTN","XUMF4A",15,0)
 K ^TMP("XUMF NAME",$J)
"RTN","XUMF4A",16,0)
 D NAME^XUMF4
"RTN","XUMF4A",17,0)
 S VALMBG=1
"RTN","XUMF4A",18,0)
 S VALMBCK="R"
"RTN","XUMF4A",19,0)
 ;
"RTN","XUMF4A",20,0)
 Q
"RTN","XUMF4A",21,0)
 ;
"RTN","XUMF4A",22,0)
DSN ; -- clean out local station numbers
"RTN","XUMF4A",23,0)
 ;
"RTN","XUMF4A",24,0)
 N IEN,DIE,DR,DA,XUMF,DIK
"RTN","XUMF4A",25,0)
 ;
"RTN","XUMF4A",26,0)
 S XUMF=7
"RTN","XUMF4A",27,0)
 ;
"RTN","XUMF4A",28,0)
 S IEN=0
"RTN","XUMF4A",29,0)
 F  S IEN=$O(^DIC(4,IEN)) Q:'IEN  D
"RTN","XUMF4A",30,0)
 .S STA=$P($G(^DIC(4,+IEN,99)),U) Q:STA=""
"RTN","XUMF4A",31,0)
 .Q:$D(^TMP("XUMF ARRAY",$J,STA))
"RTN","XUMF4A",32,0)
 .S DR="99///@",DIE=4,DA=IEN
"RTN","XUMF4A",33,0)
 .D
"RTN","XUMF4A",34,0)
 ..N IEN D ^DIE
"RTN","XUMF4A",35,0)
 ;
"RTN","XUMF4A",36,0)
 S STA="",IEN=0
"RTN","XUMF4A",37,0)
 F  S STA=$O(^DIC(4,"D",STA)) Q:STA=""  D
"RTN","XUMF4A",38,0)
 .F  S IEN=$O(^DIC(4,"D",STA,IEN)) Q:'IEN  D
"RTN","XUMF4A",39,0)
 ..Q:$P($G(^DIC(4,+IEN,99)),U)=STA
"RTN","XUMF4A",40,0)
 ..K ^DIC(4,"D",STA,IEN)
"RTN","XUMF4A",41,0)
 ;
"RTN","XUMF4A",42,0)
 S DIK="^DIC(4,",DIK(1)="99^D" D ENALL^DIK
"RTN","XUMF4A",43,0)
 ;
"RTN","XUMF4A",44,0)
 Q
"RTN","XUMF4A",45,0)
 ;
"RTN","XUMF4A",46,0)
CSN ; -- check/update status
"RTN","XUMF4A",47,0)
 ;
"RTN","XUMF4A",48,0)
 N IEN,DIE,DR,DA,XUMF,STATUS,STA
"RTN","XUMF4A",49,0)
 ;
"RTN","XUMF4A",50,0)
 S XUMF=7
"RTN","XUMF4A",51,0)
 ;
"RTN","XUMF4A",52,0)
 S IEN=0
"RTN","XUMF4A",53,0)
 F  S IEN=$O(^DIC(4,IEN)) Q:'IEN  D
"RTN","XUMF4A",54,0)
 .S STA=$P($G(^DIC(4,+IEN,99)),U)
"RTN","XUMF4A",55,0)
 .I STA S DR="11///N",DIE=4,DA=IEN D  Q
"RTN","XUMF4A",56,0)
 ..N IEN D ^DIE
"RTN","XUMF4A",57,0)
 .S STATUS=$P(^DIC(4,IEN,0),U,11)
"RTN","XUMF4A",58,0)
 .I STATUS="I" S DR="101///I",DIE=4,DA=IEN D
"RTN","XUMF4A",59,0)
 ..N IEN D ^DIE
"RTN","XUMF4A",60,0)
 .S DR="11///L",DIE=4,DA=IEN D
"RTN","XUMF4A",61,0)
 ..N IEN D ^DIE
"RTN","XUMF4A",62,0)
 ;
"RTN","XUMF4A",63,0)
 Q
"RTN","XUMF4A",64,0)
 ;
"RTN","XUMF4A",65,0)
GOLD ; -- add missing national data from standard table
"RTN","XUMF4A",66,0)
 ;
"RTN","XUMF4A",67,0)
 N STA,NAME,FDA,ERROR,IEN,IENS,X,FLAG,CNT
"RTN","XUMF4A",68,0)
 N OLDNAME,OLDVANM,STATE,FACTYP,XUMF,STATE,AGENCY
"RTN","XUMF4A",69,0)
 ;
"RTN","XUMF4A",70,0)
 S XUMF=7
"RTN","XUMF4A",71,0)
 ;
"RTN","XUMF4A",72,0)
 S STA="",CNT=0
"RTN","XUMF4A",73,0)
 F  S STA=$O(^TMP("XUMF ARRAY",$J,STA)) Q:STA=""  D
"RTN","XUMF4A",74,0)
 .S X=^TMP("XUMF ARRAY",$J,STA)
"RTN","XUMF4A",75,0)
 .S IEN=$O(^DIC(4,"D",STA,0))
"RTN","XUMF4A",76,0)
 .S OLDNAME=$P($G(^DIC(4,+IEN,0)),U,1)
"RTN","XUMF4A",77,0)
 .S OLDVANM=$P($G(^DIC(4,+IEN,99)),U,3)
"RTN","XUMF4A",78,0)
 .S IENS=$S(IEN:IEN_",",1:"+1,")
"RTN","XUMF4A",79,0)
 .S NAME=$P(X,U,2)
"RTN","XUMF4A",80,0)
 .S FACTYP=$P(X,U,5)
"RTN","XUMF4A",81,0)
 .S VANAME=$P(X,U,6)
"RTN","XUMF4A",82,0)
 .S FLAG=$P(X,U,7)
"RTN","XUMF4A",83,0)
 .S STATE=$P(X,U,8)
"RTN","XUMF4A",84,0)
 .S AGENCY=$P(X,U,17)
"RTN","XUMF4A",85,0)
 .K FDA
"RTN","XUMF4A",86,0)
 .S FDA(4,IENS,.01)=NAME
"RTN","XUMF4A",87,0)
 .S FDA(4,IENS,.02)=STATE
"RTN","XUMF4A",88,0)
 .S FDA(4,IENS,99)=STA
"RTN","XUMF4A",89,0)
 .S FDA(4,IENS,11)="NATIONAL"
"RTN","XUMF4A",90,0)
 .S FDA(4,IENS,13)=$P(FACTYP,"~")
"RTN","XUMF4A",91,0)
 .S FDA(4,IENS,100)=VANAME
"RTN","XUMF4A",92,0)
 .S FDA(4,IENS,101)=FLAG
"RTN","XUMF4A",93,0)
 .S FDA(4,IENS,95)=$P(AGENCY,"~")
"RTN","XUMF4A",94,0)
 .D
"RTN","XUMF4A",95,0)
 ..N IEN,STA,NAME,VANAME,OLDNAME,OLDVANM
"RTN","XUMF4A",96,0)
 ..D UPDATE^DIE("E","FDA",,"ERR")
"RTN","XUMF4A",97,0)
 .I 'IEN S IEN=$O(^DIC(4,"D",STA,0))
"RTN","XUMF4A",98,0)
 .Q:'IEN
"RTN","XUMF4A",99,0)
 .I OLDNAME="" Q
"RTN","XUMF4A",100,0)
 .I OLDNAME=NAME,VANAME=OLDVANM Q
"RTN","XUMF4A",101,0)
 .S IENS="?+"_DT_","_IEN_","
"RTN","XUMF4A",102,0)
 .K FDA
"RTN","XUMF4A",103,0)
 .S FDA(4.999,IENS,.01)=DT
"RTN","XUMF4A",104,0)
 .S:NAME'=OLDNAME FDA(4.999,IENS,.02)=OLDNAME
"RTN","XUMF4A",105,0)
 .S:VANAME'=OLDVANM FDA(4.999,IENS,.03)=OLDVANM
"RTN","XUMF4A",106,0)
 .D
"RTN","XUMF4A",107,0)
 ..N STA
"RTN","XUMF4A",108,0)
 ..D UPDATE^DIE("E","FDA",,"ERR")
"RTN","XUMF4A",109,0)
 ..S CNT=CNT+1 I '(CNT#10) W "."
"RTN","XUMF4A",110,0)
 ;
"RTN","XUMF4A",111,0)
 Q
"RTN","XUMF4A",112,0)
 ;
"RTN","XUMF4A",113,0)
ASSC ; -- populate associations (parent facility and VISN)
"RTN","XUMF4A",114,0)
 ;
"RTN","XUMF4A",115,0)
 N IEN,STA,VISN,PARENT,FDA,XUMF,CNT
"RTN","XUMF4A",116,0)
 ;
"RTN","XUMF4A",117,0)
 S XUMF=7
"RTN","XUMF4A",118,0)
 ;
"RTN","XUMF4A",119,0)
 S STA="",CNT=0
"RTN","XUMF4A",120,0)
 F  S STA=$O(^TMP("XUMF ARRAY",$J,STA)) Q:STA=""  D
"RTN","XUMF4A",121,0)
 .S IEN=$O(^DIC(4,"D",STA,0)) Q:'IEN
"RTN","XUMF4A",122,0)
 .S VISN=$P(^TMP("XUMF ARRAY",$J,STA),U,9)
"RTN","XUMF4A",123,0)
 .I VISN'="" D
"RTN","XUMF4A",124,0)
 ..K FDA
"RTN","XUMF4A",125,0)
 ..S IENS="?+1,"_IEN_","
"RTN","XUMF4A",126,0)
 ..S FDA(4.014,IENS,.01)="VISN"
"RTN","XUMF4A",127,0)
 ..S FDA(4.014,IENS,1)=$P(VISN,"~")
"RTN","XUMF4A",128,0)
 ..D
"RTN","XUMF4A",129,0)
 ...N IEN,STA
"RTN","XUMF4A",130,0)
 ...D UPDATE^DIE("E","FDA")
"RTN","XUMF4A",131,0)
 .S PARENT=$P(^TMP("XUMF ARRAY",$J,STA),U,10)
"RTN","XUMF4A",132,0)
 .I PARENT'="" D
"RTN","XUMF4A",133,0)
 ..K FDA
"RTN","XUMF4A",134,0)
 ..S IENS="?+2,"_IEN_","
"RTN","XUMF4A",135,0)
 ..S FDA(4.014,IENS,.01)="PARENT FACILITY"
"RTN","XUMF4A",136,0)
 ..S FDA(4.014,IENS,1)=PARENT
"RTN","XUMF4A",137,0)
 ..D
"RTN","XUMF4A",138,0)
 ...N IEN,STA
"RTN","XUMF4A",139,0)
 ...D UPDATE^DIE("E","FDA")
"RTN","XUMF4A",140,0)
 ...S CNT=CNT+1 I '(CNT#10) W "."
"RTN","XUMF4A",141,0)
 ;
"RTN","XUMF4A",142,0)
 Q
"RTN","XUMF4A",143,0)
 ;
"RTN","XUMF4A",144,0)
HIST ; -- history
"RTN","XUMF4A",145,0)
 ;
"RTN","XUMF4A",146,0)
 N IEN,STA,EFFDT,FDA,XUMF,CNT
"RTN","XUMF4A",147,0)
 ;
"RTN","XUMF4A",148,0)
 S XUMF=7
"RTN","XUMF4A",149,0)
 ;
"RTN","XUMF4A",150,0)
 S STA="",CNT=0
"RTN","XUMF4A",151,0)
 F  S STA=$O(^TMP("XUMF ARRAY",$J,STA)) Q:STA=""  D
"RTN","XUMF4A",152,0)
 .S IEN=$O(^DIC(4,"D",STA,0)) Q:'IEN
"RTN","XUMF4A",153,0)
 .S EFFDT=$P(^TMP("XUMF ARRAY",$J,STA),U,11)
"RTN","XUMF4A",154,0)
 .S EFFDT=$$FMDATE^HLFNC(+EFFDT)
"RTN","XUMF4A",155,0)
 .I EFFDT D
"RTN","XUMF4A",156,0)
 ..S IENS="?+"_EFFDT_","_IEN_","
"RTN","XUMF4A",157,0)
 ..K FDA
"RTN","XUMF4A",158,0)
 ..S FDA(4.999,IENS,.01)=EFFDT
"RTN","XUMF4A",159,0)
 ..S FDA(4.999,IENS,.06)=$P(^TMP("XUMF ARRAY",$J,STA),U,12)
"RTN","XUMF4A",160,0)
 ..D
"RTN","XUMF4A",161,0)
 ...N IEN,STA
"RTN","XUMF4A",162,0)
 ...D UPDATE^DIE("E","FDA")
"RTN","XUMF4A",163,0)
 .S EFFDT=$P(^TMP("XUMF ARRAY",$J,STA),U,13)
"RTN","XUMF4A",164,0)
 .S EFFDT=$$FMDATE^HLFNC(+EFFDT)
"RTN","XUMF4A",165,0)
 .I EFFDT D
"RTN","XUMF4A",166,0)
 ..S IENS="?+"_EFFDT_","_IEN_","
"RTN","XUMF4A",167,0)
 ..K FDA
"RTN","XUMF4A",168,0)
 ..S FDA(4.999,IENS,.01)=EFFDT
"RTN","XUMF4A",169,0)
 ..S FDA(4.999,IENS,.05)=$P(^TMP("XUMF ARRAY",$J,STA),U,14)
"RTN","XUMF4A",170,0)
 ..D
"RTN","XUMF4A",171,0)
 ...N IEN,STA
"RTN","XUMF4A",172,0)
 ...D UPDATE^DIE("E","FDA")
"RTN","XUMF4A",173,0)
 ...S CNT=CNT+1 I '(CNT#10) W "."
"RTN","XUMF4A",174,0)
 ;
"RTN","XUMF4A",175,0)
 Q
"RTN","XUMF4A",176,0)
 ;
"RTN","XUMF4A",177,0)
CDSN() ; -- check for duplicate sta # (true=duplicates, false=none)
"RTN","XUMF4A",178,0)
 ;
"RTN","XUMF4A",179,0)
 K ^TMP("XUMF TMP",$J)
"RTN","XUMF4A",180,0)
 ;
"RTN","XUMF4A",181,0)
 N IEN,STA,CNT
"RTN","XUMF4A",182,0)
 ;
"RTN","XUMF4A",183,0)
 S STA="",IEN=0
"RTN","XUMF4A",184,0)
 F  S STA=$O(^DIC(4,"D",STA)) Q:STA=""  D
"RTN","XUMF4A",185,0)
 .F  S IEN=$O(^DIC(4,"D",STA,IEN)) Q:'IEN  D
"RTN","XUMF4A",186,0)
 ..S ^TMP("XUMF TMP",$J,STA,IEN)=$P(^DIC(4,IEN,0),U)
"RTN","XUMF4A",187,0)
 ;
"RTN","XUMF4A",188,0)
 S STA="",(CNT,IEN)=0
"RTN","XUMF4A",189,0)
 F  S STA=$O(^TMP("XUMF TMP",$J,STA)) Q:STA=""  D
"RTN","XUMF4A",190,0)
 .Q:'$O(^TMP("XUMF TMP",$J,STA,+$O(^TMP("XUMF TMP",$J,STA,0))))
"RTN","XUMF4A",191,0)
 .F  S IEN=$O(^TMP("XUMF TMP",$J,STA,IEN)) Q:'IEN  D
"RTN","XUMF4A",192,0)
 ..S CNT=CNT+1
"RTN","XUMF4A",193,0)
 ;
"RTN","XUMF4A",194,0)
 K ^TMP("XUMF TMP",$J)
"RTN","XUMF4A",195,0)
 ;
"RTN","XUMF4A",196,0)
 Q CNT
"RTN","XUMF4A",197,0)
 ;
"RTN","XUMF4A",198,0)
CMVD() ; -- check for missing national data
"RTN","XUMF4A",199,0)
 ;
"RTN","XUMF4A",200,0)
 N STA,CNT
"RTN","XUMF4A",201,0)
 ;
"RTN","XUMF4A",202,0)
 S CNT=0
"RTN","XUMF4A",203,0)
 ;
"RTN","XUMF4A",204,0)
 S STA=""
"RTN","XUMF4A",205,0)
 F  S STA=$O(^TMP("XUMF ARRAY",$J,STA)) Q:STA=""  D
"RTN","XUMF4A",206,0)
 .Q:$D(^DIC(4,"D",STA))
"RTN","XUMF4A",207,0)
 .S CNT=CNT+1
"RTN","XUMF4A",208,0)
 ;
"RTN","XUMF4A",209,0)
 Q CNT
"RTN","XUMF4A",210,0)
 ;
"RTN","XUMF4A",211,0)
CHCK ; -- check if clean up is complete
"RTN","XUMF4A",212,0)
 ;
"RTN","XUMF4A",213,0)
 N VAR,FLD
"RTN","XUMF4A",214,0)
 ;
"RTN","XUMF4A",215,0)
 K ^TMP("XUMF CHCK",$J)
"RTN","XUMF4A",216,0)
 ;
"RTN","XUMF4A",217,0)
 S VALMCNT=0
"RTN","XUMF4A",218,0)
 ;
"RTN","XUMF4A",219,0)
 I $$CDSN D
"RTN","XUMF4A",220,0)
 .S VALMCNT=VALMCNT+1,VAR=""
"RTN","XUMF4A",221,0)
 .S FLD="Local/Duplicate station #s exist -- use DSTA"
"RTN","XUMF4A",222,0)
 .S VAR=$$SETFLD^VALM1(FLD,VAR,"MSG")
"RTN","XUMF4A",223,0)
 .D SET^VALM10(VALMCNT,VAR,VALMCNT)
"RTN","XUMF4A",224,0)
 ;
"RTN","XUMF4A",225,0)
 I $$CMVD D
"RTN","XUMF4A",226,0)
 .S VALMCNT=VALMCNT+1,VAR=""
"RTN","XUMF4A",227,0)
 .S FLD="INSTITUTION file not updated with NATIONAL data -- use AUTO"
"RTN","XUMF4A",228,0)
 .S VAR=$$SETFLD^VALM1(FLD,VAR,"MSG")
"RTN","XUMF4A",229,0)
 .D SET^VALM10(VALMCNT,VAR,VALMCNT)
"RTN","XUMF4A",230,0)
 ;
"RTN","XUMF4A",231,0)
 D:'VALMCNT
"RTN","XUMF4A",232,0)
 .S VAR="",FLD="CONGRATULATIONS!!!  Update complete!"
"RTN","XUMF4A",233,0)
 .S VAR=$$SETFLD^VALM1(FLD,VAR,"MSG")
"RTN","XUMF4A",234,0)
 .D SET^VALM10(1,VAR,1)
"RTN","XUMF4A",235,0)
 ;
"RTN","XUMF4A",236,0)
 Q
"RTN","XUMF4A",237,0)
 ;
"RTN","XUMF4A",238,0)
FACTYP ;resolve duplicate facility types
"RTN","XUMF4A",239,0)
 ;
"RTN","XUMF4A",240,0)
 N FT,CNT,IEN,DA,DIE,DR
"RTN","XUMF4A",241,0)
 ;
"RTN","XUMF4A",242,0)
 S FT="",(CNT,IEN)=0
"RTN","XUMF4A",243,0)
 F  S FT=$O(^DIC(4.1,"B",FT)) Q:FT=""  D
"RTN","XUMF4A",244,0)
 .F  S IEN=$O(^DIC(4.1,"B",FT,IEN)) Q:'IEN  D
"RTN","XUMF4A",245,0)
 ..Q:$E(FT,1,2)="ZZ"
"RTN","XUMF4A",246,0)
 ..S CNT=CNT+1
"RTN","XUMF4A",247,0)
 ..Q:CNT<2
"RTN","XUMF4A",248,0)
 ..S DA=IEN,DIE=4.1
"RTN","XUMF4A",249,0)
 ..S DR=".01///ZZ"_$P($G(^DIC(4.1,+IEN,0)),U)
"RTN","XUMF4A",250,0)
 ..D ^DIE
"RTN","XUMF4A",251,0)
 .S CNT=0
"RTN","XUMF4A",252,0)
 ;
"RTN","XUMF4A",253,0)
 Q
"RTN","XUMF4A",254,0)
 ;
"RTN","XUMF4A",255,0)
STATE ;resolve duplicate states
"RTN","XUMF4A",256,0)
 ;
"RTN","XUMF4A",257,0)
 N STATE,CNT,IEN,DA,DIE,DR
"RTN","XUMF4A",258,0)
 ;
"RTN","XUMF4A",259,0)
 ;name
"RTN","XUMF4A",260,0)
 S STATE="",(CNT,IEN)=0
"RTN","XUMF4A",261,0)
 F  S STATE=$O(^DIC(5,"B",STATE)) Q:STATE=""  D
"RTN","XUMF4A",262,0)
 .F  S IEN=$O(^DIC(5,"B",STATE,IEN)) Q:'IEN  D
"RTN","XUMF4A",263,0)
 ..Q:$E(STATE,1,2)="ZZ"
"RTN","XUMF4A",264,0)
 ..S CNT=CNT+1
"RTN","XUMF4A",265,0)
 ..Q:CNT<2
"RTN","XUMF4A",266,0)
 ..S DA=IEN,DIE=5
"RTN","XUMF4A",267,0)
 ..S DR=".01///ZZ"_$P($G(^DIC(5,+IEN,0)),U)
"RTN","XUMF4A",268,0)
 ..D ^DIE
"RTN","XUMF4A",269,0)
 .S CNT=0
"RTN","XUMF4A",270,0)
 ;
"RTN","XUMF4A",271,0)
 ;abbreviation
"RTN","XUMF4A",272,0)
 S STATE="",(CNT,IEN)=0
"RTN","XUMF4A",273,0)
 F  S STATE=$O(^DIC(5,"C",STATE)) Q:STATE=""  Q:STATE  D
"RTN","XUMF4A",274,0)
 .F  S IEN=$O(^DIC(5,"C",STATE,IEN)) Q:'IEN  D
"RTN","XUMF4A",275,0)
 ..Q:$E(STATE,1,2)="ZZ"
"RTN","XUMF4A",276,0)
 ..S CNT=CNT+1
"RTN","XUMF4A",277,0)
 ..Q:CNT<2
"RTN","XUMF4A",278,0)
 ..S DA=IEN,DIE=5
"RTN","XUMF4A",279,0)
 ..S DR="1///ZZ"_$P($G(^DIC(5,+IEN,0)),U,2)
"RTN","XUMF4A",280,0)
 ..D ^DIE
"RTN","XUMF4A",281,0)
 .S CNT=0
"RTN","XUMF4A",282,0)
 ;
"RTN","XUMF4A",283,0)
 Q
"RTN","XUMF4A",284,0)
 ;
"RTN","XUMF4A",285,0)
FTCLEAN ; -- add missing facility types
"RTN","XUMF4A",286,0)
 ;
"RTN","XUMF4A",287,0)
 N NAME,FULL,FDA
"RTN","XUMF4A",288,0)
 ;
"RTN","XUMF4A",289,0)
 S NAME=""
"RTN","XUMF4A",290,0)
 F  S NAME=$O(^TMP("XUMF ARRAY",$J,NAME)) Q:NAME=""  D
"RTN","XUMF4A",291,0)
 .S FULL=$P(^TMP("XUMF ARRAY",$J,NAME),U,3)
"RTN","XUMF4A",292,0)
 .D
"RTN","XUMF4A",293,0)
 ..K FDA
"RTN","XUMF4A",294,0)
 ..S FDA(4.1,"?+1,",.01)=NAME
"RTN","XUMF4A",295,0)
 ..S FDA(4.1,"?+1,",1)=FULL
"RTN","XUMF4A",296,0)
 ..S FDA(4.1,"?+1,",3)="N"
"RTN","XUMF4A",297,0)
 ..N NAME
"RTN","XUMF4A",298,0)
 ..D UPDATE^DIE("E","FDA",,"ERR")
"RTN","XUMF4A",299,0)
 ;
"RTN","XUMF4A",300,0)
 Q
"RTN","XUMF4A",301,0)
 ;
"RTN","XUMF4L1")
0^11^B34916115
"RTN","XUMF4L1",1,0)
XUMF4L1 ;OIFO-OAK/RAM - Load IMF ;02/21/02
"RTN","XUMF4L1",2,0)
 ;;8.0;KERNEL;**217,261**;Jul 10, 1995
"RTN","XUMF4L1",3,0)
 ;
"RTN","XUMF4L1",4,0)
 ;
"RTN","XUMF4L1",5,0)
EN ; -- entry point
"RTN","XUMF4L1",6,0)
 ;
"RTN","XUMF4L1",7,0)
 K ^TMP("XUMF ADD",$J),^TMP("XUMF MOD",$J),^TMP("XUMF DEL",$J)
"RTN","XUMF4L1",8,0)
 ;
"RTN","XUMF4L1",9,0)
 D DSN,GOLD,ASSC,HIST
"RTN","XUMF4L1",10,0)
 ;
"RTN","XUMF4L1",11,0)
 Q
"RTN","XUMF4L1",12,0)
 ;
"RTN","XUMF4L1",13,0)
DSN ; -- clean out local station numbers
"RTN","XUMF4L1",14,0)
 ;
"RTN","XUMF4L1",15,0)
 N IEN,DIE,DR,DA,XUMF,DIK
"RTN","XUMF4L1",16,0)
 ;
"RTN","XUMF4L1",17,0)
 S XUMF=1
"RTN","XUMF4L1",18,0)
 ;
"RTN","XUMF4L1",19,0)
 S IEN=0
"RTN","XUMF4L1",20,0)
 F  S IEN=$O(^DIC(4,IEN)) Q:'IEN  D
"RTN","XUMF4L1",21,0)
 .S STA=$P($G(^DIC(4,+IEN,99)),U) Q:STA=""
"RTN","XUMF4L1",22,0)
 .Q:$D(^TMP("XUMF ARRAY",$J,STA))
"RTN","XUMF4L1",23,0)
 .S ^TMP("XUMF DEL",$J,STA,IEN)=""
"RTN","XUMF4L1",24,0)
 .S DR="99///@",DIE=4,DA=IEN
"RTN","XUMF4L1",25,0)
 .D
"RTN","XUMF4L1",26,0)
 ..N IEN D ^DIE
"RTN","XUMF4L1",27,0)
 ;
"RTN","XUMF4L1",28,0)
 S STA="",IEN=0
"RTN","XUMF4L1",29,0)
 F  S STA=$O(^DIC(4,"D",STA)) Q:STA=""  D
"RTN","XUMF4L1",30,0)
 .F  S IEN=$O(^DIC(4,"D",STA,IEN)) Q:'IEN  D
"RTN","XUMF4L1",31,0)
 ..Q:$P($G(^DIC(4,+IEN,99)),U)=STA
"RTN","XUMF4L1",32,0)
 ..K ^DIC(4,"D",STA,IEN)
"RTN","XUMF4L1",33,0)
 ;
"RTN","XUMF4L1",34,0)
 S DIK="^DIC(4,",DIK(1)="99^D" D ENALL^DIK
"RTN","XUMF4L1",35,0)
 ;
"RTN","XUMF4L1",36,0)
 Q
"RTN","XUMF4L1",37,0)
 ;
"RTN","XUMF4L1",38,0)
GOLD ; -- add missing national data from standard table
"RTN","XUMF4L1",39,0)
 ;
"RTN","XUMF4L1",40,0)
 N STA,NAME,FDA,ERROR,IEN,IENS,X,FLAG,CNT
"RTN","XUMF4L1",41,0)
 N OLDNAME,OLDVANM,STATE,FACTYP,XUMF,AGENCY
"RTN","XUMF4L1",42,0)
 ;
"RTN","XUMF4L1",43,0)
 S XUMF=1
"RTN","XUMF4L1",44,0)
 ;
"RTN","XUMF4L1",45,0)
 S STA="",CNT=0
"RTN","XUMF4L1",46,0)
 F  S STA=$O(^TMP("XUMF ARRAY",$J,STA)) Q:STA=""  D
"RTN","XUMF4L1",47,0)
 .S X=^TMP("XUMF ARRAY",$J,STA)
"RTN","XUMF4L1",48,0)
 .S IEN=$O(^DIC(4,"D",STA,0))
"RTN","XUMF4L1",49,0)
 .S:'IEN ^TMP("XUMF ADD",$J,STA)=^TMP("XUMF ARRAY",$J,STA)
"RTN","XUMF4L1",50,0)
 .D:IEN MOD
"RTN","XUMF4L1",51,0)
 .S OLDNAME=$P($G(^DIC(4,+IEN,0)),U,1)
"RTN","XUMF4L1",52,0)
 .S OLDVANM=$P($G(^DIC(4,+IEN,99)),U,3)
"RTN","XUMF4L1",53,0)
 .S IENS=$S(IEN:IEN_",",1:"+1,")
"RTN","XUMF4L1",54,0)
 .S NAME=$P(X,U,2)
"RTN","XUMF4L1",55,0)
 .S FACTYP=$P(X,U,5)
"RTN","XUMF4L1",56,0)
 .S VANAME=$P(X,U,6)
"RTN","XUMF4L1",57,0)
 .S FLAG=$P(X,U,7)
"RTN","XUMF4L1",58,0)
 .S STATE=$P(X,U,8)
"RTN","XUMF4L1",59,0)
 .S AGENCY=$P(X,U,17)
"RTN","XUMF4L1",60,0)
 .K FDA
"RTN","XUMF4L1",61,0)
 .S FDA(4,IENS,.01)=NAME
"RTN","XUMF4L1",62,0)
 .S FDA(4,IENS,.02)=STATE
"RTN","XUMF4L1",63,0)
 .S FDA(4,IENS,99)=STA
"RTN","XUMF4L1",64,0)
 .S FDA(4,IENS,11)="National"
"RTN","XUMF4L1",65,0)
 .S FDA(4,IENS,13)=$P(FACTYP,"~")
"RTN","XUMF4L1",66,0)
 .S FDA(4,IENS,100)=VANAME
"RTN","XUMF4L1",67,0)
 .S FDA(4,IENS,101)=FLAG
"RTN","XUMF4L1",68,0)
 .S FDA(4,IENS,95)=$P(AGENCY,"~")
"RTN","XUMF4L1",69,0)
 .D
"RTN","XUMF4L1",70,0)
 ..N IEN,STA,NAME,VANAME,OLDNAME,OLDVANM
"RTN","XUMF4L1",71,0)
 ..D UPDATE^DIE("E","FDA",,"ERR")
"RTN","XUMF4L1",72,0)
 .I 'IEN S IEN=$O(^DIC(4,"D",STA,0))
"RTN","XUMF4L1",73,0)
 .Q:'IEN
"RTN","XUMF4L1",74,0)
 .I OLDNAME="" Q
"RTN","XUMF4L1",75,0)
 .I OLDNAME=NAME,VANAME=OLDVANM Q
"RTN","XUMF4L1",76,0)
 .S IENS="?+"_DT_","_IEN_","
"RTN","XUMF4L1",77,0)
 .K FDA
"RTN","XUMF4L1",78,0)
 .S FDA(4.999,IENS,.01)=DT
"RTN","XUMF4L1",79,0)
 .S:NAME'=OLDNAME FDA(4.999,IENS,.02)=OLDNAME
"RTN","XUMF4L1",80,0)
 .S:VANAME'=OLDVANM FDA(4.999,IENS,.03)=OLDVANM
"RTN","XUMF4L1",81,0)
 .D
"RTN","XUMF4L1",82,0)
 ..N STA
"RTN","XUMF4L1",83,0)
 ..D UPDATE^DIE("E","FDA")
"RTN","XUMF4L1",84,0)
 ..S CNT=CNT+1
"RTN","XUMF4L1",85,0)
 ;
"RTN","XUMF4L1",86,0)
 Q
"RTN","XUMF4L1",87,0)
 ;
"RTN","XUMF4L1",88,0)
ASSC ; -- populate associations (parent facility and VISN)
"RTN","XUMF4L1",89,0)
 ;
"RTN","XUMF4L1",90,0)
 N IEN,STA,VISN,PARENT,FDA,XUMF,CNT
"RTN","XUMF4L1",91,0)
 ;
"RTN","XUMF4L1",92,0)
 S XUMF=1
"RTN","XUMF4L1",93,0)
 ;
"RTN","XUMF4L1",94,0)
 S STA="",CNT=0
"RTN","XUMF4L1",95,0)
 F  S STA=$O(^TMP("XUMF ARRAY",$J,STA)) Q:STA=""  D
"RTN","XUMF4L1",96,0)
 .S IEN=$O(^DIC(4,"D",STA,0)) Q:'IEN
"RTN","XUMF4L1",97,0)
 .S VISN=$P(^TMP("XUMF ARRAY",$J,STA),U,9)
"RTN","XUMF4L1",98,0)
 .I VISN'="" D
"RTN","XUMF4L1",99,0)
 ..K FDA
"RTN","XUMF4L1",100,0)
 ..S IENS="?+1,"_IEN_","
"RTN","XUMF4L1",101,0)
 ..S FDA(4.014,IENS,.01)="VISN"
"RTN","XUMF4L1",102,0)
 ..S FDA(4.014,IENS,1)=$P(VISN,"~")
"RTN","XUMF4L1",103,0)
 ..D
"RTN","XUMF4L1",104,0)
 ...N IEN,STA
"RTN","XUMF4L1",105,0)
 ...D UPDATE^DIE("E","FDA")
"RTN","XUMF4L1",106,0)
 .S PARENT=$P(^TMP("XUMF ARRAY",$J,STA),U,10)
"RTN","XUMF4L1",107,0)
 .I PARENT'="" D
"RTN","XUMF4L1",108,0)
 ..K FDA
"RTN","XUMF4L1",109,0)
 ..S IENS="?+2,"_IEN_","
"RTN","XUMF4L1",110,0)
 ..S FDA(4.014,IENS,.01)="PARENT FACILITY"
"RTN","XUMF4L1",111,0)
 ..S FDA(4.014,IENS,1)=PARENT
"RTN","XUMF4L1",112,0)
 ..D
"RTN","XUMF4L1",113,0)
 ...N IEN,STA
"RTN","XUMF4L1",114,0)
 ...D UPDATE^DIE("E","FDA")
"RTN","XUMF4L1",115,0)
 ...S CNT=CNT+1
"RTN","XUMF4L1",116,0)
 ;
"RTN","XUMF4L1",117,0)
 Q
"RTN","XUMF4L1",118,0)
 ;
"RTN","XUMF4L1",119,0)
HIST ; -- history
"RTN","XUMF4L1",120,0)
 ;
"RTN","XUMF4L1",121,0)
 N IEN,STA,EFFDT,FDA,XUMF,CNT
"RTN","XUMF4L1",122,0)
 ;
"RTN","XUMF4L1",123,0)
 S XUMF=1
"RTN","XUMF4L1",124,0)
 ;
"RTN","XUMF4L1",125,0)
 S STA="",CNT=0
"RTN","XUMF4L1",126,0)
 F  S STA=$O(^TMP("XUMF ARRAY",$J,STA)) Q:STA=""  D
"RTN","XUMF4L1",127,0)
 .S IEN=$O(^DIC(4,"D",STA,0)) Q:'IEN
"RTN","XUMF4L1",128,0)
 .S EFFDT=$P(^TMP("XUMF ARRAY",$J,STA),U,11)
"RTN","XUMF4L1",129,0)
 .S EFFDT=$$FMDATE^HLFNC(+EFFDT)
"RTN","XUMF4L1",130,0)
 .I EFFDT D
"RTN","XUMF4L1",131,0)
 ..S IENS="?+"_EFFDT_","_IEN_","
"RTN","XUMF4L1",132,0)
 ..K FDA
"RTN","XUMF4L1",133,0)
 ..S FDA(4.999,IENS,.01)=EFFDT
"RTN","XUMF4L1",134,0)
 ..S FDA(4.999,IENS,.06)=$P(^TMP("XUMF ARRAY",$J,STA),U,12)
"RTN","XUMF4L1",135,0)
 ..D
"RTN","XUMF4L1",136,0)
 ...N IEN,STA
"RTN","XUMF4L1",137,0)
 ...D UPDATE^DIE("E","FDA")
"RTN","XUMF4L1",138,0)
 .S EFFDT=$P(^TMP("XUMF ARRAY",$J,STA),U,13)
"RTN","XUMF4L1",139,0)
 .S EFFDT=$$FMDATE^HLFNC(+EFFDT)
"RTN","XUMF4L1",140,0)
 .I EFFDT D
"RTN","XUMF4L1",141,0)
 ..S IENS="?+"_EFFDT_","_IEN_","
"RTN","XUMF4L1",142,0)
 ..K FDA
"RTN","XUMF4L1",143,0)
 ..S FDA(4.999,IENS,.01)=EFFDT
"RTN","XUMF4L1",144,0)
 ..S FDA(4.999,IENS,.05)=$P(^TMP("XUMF ARRAY",$J,STA),U,14)
"RTN","XUMF4L1",145,0)
 ..D
"RTN","XUMF4L1",146,0)
 ...N IEN,STA
"RTN","XUMF4L1",147,0)
 ...D UPDATE^DIE("E","FDA")
"RTN","XUMF4L1",148,0)
 ...S CNT=CNT+1
"RTN","XUMF4L1",149,0)
 ;
"RTN","XUMF4L1",150,0)
 Q
"RTN","XUMF4L1",151,0)
 ;
"RTN","XUMF4L1",152,0)
CDSN() ; -- check for duplicate sta # (true=duplicates, false=none)
"RTN","XUMF4L1",153,0)
 ;
"RTN","XUMF4L1",154,0)
 K ^TMP("XUMF TMP",$J)
"RTN","XUMF4L1",155,0)
 ;
"RTN","XUMF4L1",156,0)
 N IEN,STA,CNT
"RTN","XUMF4L1",157,0)
 ;
"RTN","XUMF4L1",158,0)
 S STA="",IEN=0
"RTN","XUMF4L1",159,0)
 F  S STA=$O(^DIC(4,"D",STA)) Q:STA=""  D
"RTN","XUMF4L1",160,0)
 .F  S IEN=$O(^DIC(4,"D",STA,IEN)) Q:'IEN  D
"RTN","XUMF4L1",161,0)
 ..S ^TMP("XUMF TMP",$J,STA,IEN)=$P(^DIC(4,IEN,0),U)
"RTN","XUMF4L1",162,0)
 ;
"RTN","XUMF4L1",163,0)
 S STA="",(CNT,IEN)=0
"RTN","XUMF4L1",164,0)
 F  S STA=$O(^TMP("XUMF TMP",$J,STA)) Q:STA=""  D
"RTN","XUMF4L1",165,0)
 .Q:'$O(^TMP("XUMF TMP",$J,STA,+$O(^TMP("XUMF TMP",$J,STA,0))))
"RTN","XUMF4L1",166,0)
 .F  S IEN=$O(^TMP("XUMF TMP",$J,STA,IEN)) Q:'IEN  D
"RTN","XUMF4L1",167,0)
 ..S CNT=CNT+1
"RTN","XUMF4L1",168,0)
 ;
"RTN","XUMF4L1",169,0)
 K ^TMP("XUMF TMP",$J)
"RTN","XUMF4L1",170,0)
 ;
"RTN","XUMF4L1",171,0)
 Q CNT
"RTN","XUMF4L1",172,0)
 ;
"RTN","XUMF4L1",173,0)
MOD ; if entry modified set TMP
"RTN","XUMF4L1",174,0)
 ;
"RTN","XUMF4L1",175,0)
 N NAME,FACTYP,VANAME,STANUM,FLAG,PRNT,VISN,STATE,X,Y
"RTN","XUMF4L1",176,0)
 ;
"RTN","XUMF4L1",177,0)
 Q:'$D(^DIC(4,+IEN,0))
"RTN","XUMF4L1",178,0)
 ;
"RTN","XUMF4L1",179,0)
 S X=$P(^TMP("XUMF ARRAY",$J,STA),U,2,10)
"RTN","XUMF4L1",180,0)
 ;
"RTN","XUMF4L1",181,0)
 S NAME=$P($G(^DIC(4,+IEN,0)),U)
"RTN","XUMF4L1",182,0)
 S FACTYP=$P($G(^DIC(4.1,+$G(^DIC(4,+IEN,3)),0)),U)
"RTN","XUMF4L1",183,0)
 S:FACTYP'="" FACTYP=FACTYP_"~FACILITY TYPE~VA"
"RTN","XUMF4L1",184,0)
 S VANAME=$P($G(^DIC(4,+IEN,99)),U,3)
"RTN","XUMF4L1",185,0)
 S STANUM=$P($G(^DIC(4,+IEN,99)),U)
"RTN","XUMF4L1",186,0)
 S FLAG=$S(+$P($G(^DIC(4,+IEN,99)),U,4):"INACTIVE",1:"")
"RTN","XUMF4L1",187,0)
 S PRNT=$P($G(^DIC(4,+$P($G(^DIC(4,+IEN,7,2,0)),U,2),99)),U)
"RTN","XUMF4L1",188,0)
 S VISN=$P($G(^DIC(4,+$P($G(^DIC(4,+IEN,7,1,0)),U,2),0)),U)
"RTN","XUMF4L1",189,0)
 S:VISN'="" VISN=VISN_"~VISN~VA"
"RTN","XUMF4L1",190,0)
 S STATE=$P($G(^DIC(5,+$P($G(^DIC(4,+IEN,0)),U,2),0)),U)
"RTN","XUMF4L1",191,0)
 ;
"RTN","XUMF4L1",192,0)
 S Y=NAME_U_STANUM_U_"National"_U_FACTYP_U_VANAME_U_FLAG_U_STATE
"RTN","XUMF4L1",193,0)
 S Y=Y_U_VISN_U_PRNT
"RTN","XUMF4L1",194,0)
 ;
"RTN","XUMF4L1",195,0)
 Q:Y=X
"RTN","XUMF4L1",196,0)
 ;
"RTN","XUMF4L1",197,0)
 S ^TMP("XUMF MOD",$J,STA,"NEW")=X
"RTN","XUMF4L1",198,0)
 S ^TMP("XUMF MOD",$J,STA,"OLD")=Y
"RTN","XUMF4L1",199,0)
 ;
"RTN","XUMF4L1",200,0)
 Q
"RTN","XUMF4L1",201,0)
 ;
"RTN","XUMF4L1",202,0)
FTCLEAN ; -- add missing facility types
"RTN","XUMF4L1",203,0)
 ;
"RTN","XUMF4L1",204,0)
 N NAME,FULL,FDA
"RTN","XUMF4L1",205,0)
 ;
"RTN","XUMF4L1",206,0)
 S NAME=""
"RTN","XUMF4L1",207,0)
 F  S NAME=$O(^TMP("XUMF ARRAY",$J,NAME)) Q:NAME=""  D
"RTN","XUMF4L1",208,0)
 .S FULL=$P(^TMP("XUMF ARRAY",$J,NAME),U,3)
"RTN","XUMF4L1",209,0)
 .D
"RTN","XUMF4L1",210,0)
 ..K FDA
"RTN","XUMF4L1",211,0)
 ..S FDA(4.1,"?+1,",.01)=NAME
"RTN","XUMF4L1",212,0)
 ..S FDA(4.1,"?+1,",1)=FULL
"RTN","XUMF4L1",213,0)
 ..S FDA(4.1,"?+1,",3)="N"
"RTN","XUMF4L1",214,0)
 ..N NAME
"RTN","XUMF4L1",215,0)
 ..D UPDATE^DIE("E","FDA",,"ERR")
"RTN","XUMF4L1",216,0)
 ;
"RTN","XUMF4L1",217,0)
 Q
"RTN","XUMF4L1",218,0)
 ;
"RTN","XUMFH")
0^6^B76492031
"RTN","XUMFH",1,0)
XUMFH ;CIOFO-SF/RAM - Master File HL7 Msg Handler ;06/28/00
"RTN","XUMFH",2,0)
 ;;8.0;KERNEL;**206,209,217,218,262,335,261**;Jul 10, 1995
"RTN","XUMFH",3,0)
 ;
"RTN","XUMFH",4,0)
 ; This routine handles Master File HL7 messages.
"RTN","XUMFH",5,0)
 ;
"RTN","XUMFH",6,0)
MAIN ; -- entry point
"RTN","XUMFH",7,0)
 ;
"RTN","XUMFH",8,0)
 N CNT,ERR,I,X,HLFS,HLCS,ERROR,HLRESLTA,IFN,IEN,MTPE,TYPE,ARRAY
"RTN","XUMFH",9,0)
 N HDT,KEY,MID,REASON,VALUE,XREF,ALL,GROUP,PARAM,ROOT,SEG,QRD
"RTN","XUMFH",10,0)
 N QID,WHAT,WHO,HLSCS,CDSYS
"RTN","XUMFH",11,0)
 ;
"RTN","XUMFH",12,0)
 D INIT,PROCESS,REPLY,EXIT
"RTN","XUMFH",13,0)
 ;
"RTN","XUMFH",14,0)
 Q
"RTN","XUMFH",15,0)
 ;
"RTN","XUMFH",16,0)
INIT ; -- initialize
"RTN","XUMFH",17,0)
 ;
"RTN","XUMFH",18,0)
 K ^TMP("DILIST",$J),^TMP("DIERR",$J)
"RTN","XUMFH",19,0)
 K ^TMP("HLS",$J),^TMP("HLA",$J)
"RTN","XUMFH",20,0)
 ;
"RTN","XUMFH",21,0)
 S (ERROR,CNT,TYPE,ARRAY)=0
"RTN","XUMFH",22,0)
 S HLFS=HL("FS"),HLCS=$E(HL("ECH")),HLSCS=$E(HL("ECH"),4)
"RTN","XUMFH",23,0)
 ;
"RTN","XUMFH",24,0)
 Q
"RTN","XUMFH",25,0)
 ;
"RTN","XUMFH",26,0)
PROCESS ; -- pull message text
"RTN","XUMFH",27,0)
 ;
"RTN","XUMFH",28,0)
 F  X HLNEXT Q:HLQUIT'>0  D
"RTN","XUMFH",29,0)
 .Q:$P(HLNODE,HLFS)=""
"RTN","XUMFH",30,0)
 .D @($P(HLNODE,HLFS))
"RTN","XUMFH",31,0)
 ;
"RTN","XUMFH",32,0)
 Q
"RTN","XUMFH",33,0)
 ;
"RTN","XUMFH",34,0)
MSH ; -- MSH segment
"RTN","XUMFH",35,0)
 ;
"RTN","XUMFH",36,0)
 Q
"RTN","XUMFH",37,0)
 ;
"RTN","XUMFH",38,0)
MSA ; -- MSA segment
"RTN","XUMFH",39,0)
 ;
"RTN","XUMFH",40,0)
 N CODE
"RTN","XUMFH",41,0)
 ;
"RTN","XUMFH",42,0)
 S CODE=$P(HLNODE,HLFS,2)
"RTN","XUMFH",43,0)
 ;
"RTN","XUMFH",44,0)
 I CODE="AE"!(CODE="AR") D
"RTN","XUMFH",45,0)
 .S ERROR=ERROR_U_$P(HLNODE,HLFS,4)_U_$G(ERR)
"RTN","XUMFH",46,0)
 .D EM(ERROR,.ERR)
"RTN","XUMFH",47,0)
 ;
"RTN","XUMFH",48,0)
 Q
"RTN","XUMFH",49,0)
 ;
"RTN","XUMFH",50,0)
QRD ; -- QRD segment
"RTN","XUMFH",51,0)
 ;
"RTN","XUMFH",52,0)
 Q:ERROR
"RTN","XUMFH",53,0)
 ;
"RTN","XUMFH",54,0)
 S QRD="QRD,QDT,QFC,QP,QID,DRT,DRDT,QLR,WHO,WHAT,WDDC,WDCVQ,QRL"
"RTN","XUMFH",55,0)
 ;
"RTN","XUMFH",56,0)
 F I=2:1:13 S PARAM($P(QRD,",",I))=$P(HLNODE,HLFS,I)
"RTN","XUMFH",57,0)
 S QID=$P(HLNODE,HLFS,5)
"RTN","XUMFH",58,0)
 S WHO=$P(HLNODE,HLFS,9)
"RTN","XUMFH",59,0)
 I WHO="" D  Q
"RTN","XUMFH",60,0)
 .S ERROR="1^QRD segment has null missing WHO parameter"
"RTN","XUMFH",61,0)
 .D EM(ERROR,.ERR)
"RTN","XUMFH",62,0)
 S WHAT=$P(HLNODE,HLFS,10)
"RTN","XUMFH",63,0)
 I WHAT="" D  Q
"RTN","XUMFH",64,0)
 .S ERROR="1^QRD segment has null missing WHAT parameter"
"RTN","XUMFH",65,0)
 .D EM(ERROR,.ERR)
"RTN","XUMFH",66,0)
 ;
"RTN","XUMFH",67,0)
 S ARRAY=$S(QID["ARRAY":1,1:0)
"RTN","XUMFH",68,0)
 S ALL=$S(WHO["ALL":1,1:0)
"RTN","XUMFH",69,0)
 S GROUP=$S(ALL:1,(WHO["IEN"):1,1:0)
"RTN","XUMFH",70,0)
 ;
"RTN","XUMFH",71,0)
 S:ARRAY TYPE=$S(GROUP:7,1:3)
"RTN","XUMFH",72,0)
 S:'ARRAY TYPE=$S(GROUP:5,1:1)
"RTN","XUMFH",73,0)
 S:HL("MTN")="MFR" TYPE=TYPE+10
"RTN","XUMFH",74,0)
 ;
"RTN","XUMFH",75,0)
 S IFN=+WHAT
"RTN","XUMFH",76,0)
 S XREF=$P(WHO,HLCS,9),ROOT=$$ROOT^DILFD(IFN,,1)
"RTN","XUMFH",77,0)
 S IEN=$O(@ROOT@(XREF,$P(WHO,HLCS),0))
"RTN","XUMFH",78,0)
 S IEN=$S(IEN:IEN,1:$P(WHO,HLCS))
"RTN","XUMFH",79,0)
 S:$L(XREF)>1 PARAM("CDSYS")=XREF
"RTN","XUMFH",80,0)
 ;
"RTN","XUMFH",81,0)
 K:ARRAY ^TMP("XUMF ARRAY",$J)
"RTN","XUMFH",82,0)
 ;
"RTN","XUMFH",83,0)
 Q
"RTN","XUMFH",84,0)
 ;
"RTN","XUMFH",85,0)
MFI ; -- MFI segment
"RTN","XUMFH",86,0)
 ;
"RTN","XUMFH",87,0)
 Q:ERROR
"RTN","XUMFH",88,0)
 Q:$G(IFN)
"RTN","XUMFH",89,0)
 ;
"RTN","XUMFH",90,0)
 I $P(HLNODE,HLFS,2)="" D  Q
"RTN","XUMFH",91,0)
 .S ERROR="1^MFI segment missing Master File Identifier"
"RTN","XUMFH",92,0)
 .D EM(ERROR,.ERR)
"RTN","XUMFH",93,0)
 S IFN=$$MFI^XUMFP($P(HLNODE,HLFS,2))
"RTN","XUMFH",94,0)
 I 'IFN D  Q
"RTN","XUMFH",95,0)
 .S ERROR="1^IFN in MFI could not be resolved"
"RTN","XUMFH",96,0)
 .D EM(ERROR,.ERR)
"RTN","XUMFH",97,0)
 ;
"RTN","XUMFH",98,0)
 Q
"RTN","XUMFH",99,0)
 ;
"RTN","XUMFH",100,0)
MFE ; -- MFE segment
"RTN","XUMFH",101,0)
 ;
"RTN","XUMFH",102,0)
 Q:ERROR
"RTN","XUMFH",103,0)
 ;Q:$G(IEN)
"RTN","XUMFH",104,0)
 ;
"RTN","XUMFH",105,0)
 S KEY=$P(HLNODE,HLFS,5) Q:ARRAY
"RTN","XUMFH",106,0)
 ;
"RTN","XUMFH",107,0)
 I $P(KEY,HLCS)="" D  Q
"RTN","XUMFH",108,0)
 .D EM("MFE segment NULL key "_$E(HLNODE,1,80),.ERR)
"RTN","XUMFH",109,0)
 .
"RTN","XUMFH",110,0)
 S XREF=$P(KEY,HLCS,3)
"RTN","XUMFH",111,0)
 S IEN=$$FIND1^DIC(IFN,,"BX",$P(KEY,HLCS),XREF,,"ERR")
"RTN","XUMFH",112,0)
 S IEN=$S(IEN:IEN,KEY["ALL":"ALL",$G(ERR)'="":"ERROR",1:"NEW")
"RTN","XUMFH",113,0)
 I IEN="ERROR" D  Q
"RTN","XUMFH",114,0)
 .D EM("MFE segment couldn't resolve IEN",.ERR)
"RTN","XUMFH",115,0)
 .K ERR
"RTN","XUMFH",116,0)
 D MAIN^XUMFP(IFN,IEN,TYPE,.PARAM,.ERROR)
"RTN","XUMFH",117,0)
 ;
"RTN","XUMFH",118,0)
 Q
"RTN","XUMFH",119,0)
 ;
"RTN","XUMFH",120,0)
ZL7 ; -- Generic Master File
"RTN","XUMFH",121,0)
ZIN ; -- VHA Institution segment
"RTN","XUMFH",122,0)
ZFT ; -- VHA Facility Type segment
"RTN","XUMFH",123,0)
LOC ; -- Location Identification segment
"RTN","XUMFH",124,0)
ZZZ ; -- get [Z...] segment(s)
"RTN","XUMFH",125,0)
 ;
"RTN","XUMFH",126,0)
 Q:ERROR
"RTN","XUMFH",127,0)
 Q:IEN="ERROR"
"RTN","XUMFH",128,0)
 ;
"RTN","XUMFH",129,0)
 I $G(ARRAY) D ARRAY Q
"RTN","XUMFH",130,0)
 ;
"RTN","XUMFH",131,0)
 N FDA,IENS,FIELD,ERR,PRE,POST,XUMF,MULT,FDA1,SEQ,SEQ1,SEQ2,SEQ3
"RTN","XUMFH",132,0)
 ;
"RTN","XUMFH",133,0)
 S PRE=$G(^TMP("XUMF MFS",$J,"PARAM","PRE"))
"RTN","XUMFH",134,0)
 D:PRE'="" @(PRE)
"RTN","XUMFH",135,0)
 ;
"RTN","XUMFH",136,0)
 S XUMF=7
"RTN","XUMFH",137,0)
 ;
"RTN","XUMFH",138,0)
 S SEG=$P(HLNODE,HLFS)
"RTN","XUMFH",139,0)
 S IENS=$S(IEN:IEN,1:"+1")_","
"RTN","XUMFH",140,0)
 S SEQ=0
"RTN","XUMFH",141,0)
 F  S SEQ=$O(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ)) Q:'SEQ  D
"RTN","XUMFH",142,0)
 .S SEQ1=$P(SEQ,"."),SEQ2=$P(SEQ,".",2)
"RTN","XUMFH",143,0)
 .S SEQ3=$O(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"HLSCS",0))
"RTN","XUMFH",144,0)
 .I SEQ3 D SUBCOMP Q
"RTN","XUMFH",145,0)
 .S FIELD=$O(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,0))
"RTN","XUMFH",146,0)
 .I FIELD=".01" D
"RTN","XUMFH",147,0)
 ..N FDA,IEN1
"RTN","XUMFH",148,0)
 ..S TYP=$G(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,FIELD))
"RTN","XUMFH",149,0)
 ..S VALUE=$$VALUE(.HLNODE,SEQ1)
"RTN","XUMFH",150,0)
 ..S:SEQ2 VALUE=$P(VALUE,HLCS,SEQ2)
"RTN","XUMFH",151,0)
 ..S VALUE=$$DTYP^XUMFP(VALUE,TYP,HLCS,0)
"RTN","XUMFH",152,0)
 ..S FDA(IFN,IENS,FIELD)=VALUE
"RTN","XUMFH",153,0)
 ..D UPDATE^DIE("E","FDA","IEN1","ERR")
"RTN","XUMFH",154,0)
 ..I $D(ERR) D
"RTN","XUMFH",155,0)
 ...D EM("update DIE call error message in ZZZ",.ERR)
"RTN","XUMFH",156,0)
 ...K ERR
"RTN","XUMFH",157,0)
 ..I $D(IEN1) S IENS=IEN1(1)_","
"RTN","XUMFH",158,0)
 .I 'FIELD D SUBFILE Q
"RTN","XUMFH",159,0)
 .S TYP=$G(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,FIELD))
"RTN","XUMFH",160,0)
 .S VALUE=$$VALUE(.HLNODE,SEQ)
"RTN","XUMFH",161,0)
 .S:SEQ2 VALUE=$P(VALUE,HLCS,SEQ2)
"RTN","XUMFH",162,0)
 .S VALUE=$$DTYP^XUMFP(VALUE,TYP,HLCS,0)
"RTN","XUMFH",163,0)
 .S FDA(IFN,IENS,FIELD)=VALUE
"RTN","XUMFH",164,0)
 ;
"RTN","XUMFH",165,0)
 M FDA=FDA1
"RTN","XUMFH",166,0)
 ;
"RTN","XUMFH",167,0)
 D FILE^DIE("E","FDA","ERR")
"RTN","XUMFH",168,0)
 I $D(ERR) D
"RTN","XUMFH",169,0)
 .D EM("file DIE call error message in ZZZ",.ERR)
"RTN","XUMFH",170,0)
 .K ERR
"RTN","XUMFH",171,0)
 ;
"RTN","XUMFH",172,0)
 S POST=$G(^TMP("XUMF MFS",$J,"PARAM","POST"))
"RTN","XUMFH",173,0)
 D:POST'="" @(POST)
"RTN","XUMFH",174,0)
 ;
"RTN","XUMFH",175,0)
 K IEN
"RTN","XUMFH",176,0)
 ;
"RTN","XUMFH",177,0)
 Q
"RTN","XUMFH",178,0)
 ;
"RTN","XUMFH",179,0)
SUBFILE ; -- process subfile record
"RTN","XUMFH",180,0)
 ;
"RTN","XUMFH",181,0)
 N IFN,IENS1,KEY1,FIELD,TYP,MKEY,ERR
"RTN","XUMFH",182,0)
 ;
"RTN","XUMFH",183,0)
 S IFN=^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"FILE")
"RTN","XUMFH",184,0)
 S FIELD=^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"FIELD")
"RTN","XUMFH",185,0)
 S TYP=^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"DTYP")
"RTN","XUMFH",186,0)
 S VALUE=$$VALUE(.HLNODE,SEQ)
"RTN","XUMFH",187,0)
 S:SEQ2 VALUE=$P(VALUE,HLCS,SEQ2)
"RTN","XUMFH",188,0)
 S VALUE=$$DTYP^XUMFP(VALUE,TYP,HLCS,0)
"RTN","XUMFH",189,0)
 ;
"RTN","XUMFH",190,0)
 S MULT=$G(^TMP("XUMF MFS",$J,"PARAM","MULT","ZIN",SEQ))
"RTN","XUMFH",191,0)
 S MKEY=$G(^TMP("XUMF MFS",$J,"PARAM","MKEY","ZIN",SEQ))
"RTN","XUMFH",192,0)
 I MULT=SEQ Q:VALUE=""  D
"RTN","XUMFH",193,0)
 .N FDA,IEN
"RTN","XUMFH",194,0)
 .S FDA(IFN,"?+1,"_IENS,.01)=VALUE
"RTN","XUMFH",195,0)
 .D UPDATE^DIE("E","FDA","IEN","ERR")
"RTN","XUMFH",196,0)
 .I $D(ERR) D
"RTN","XUMFH",197,0)
 ..D EM("update DIE call error message in SUBFILE",.ERR)
"RTN","XUMFH",198,0)
 ..K ERR
"RTN","XUMFH",199,0)
 .S IENS1=IEN(1)_","_IENS,MULT(SEQ)=IENS1
"RTN","XUMFH",200,0)
 I 'MULT D
"RTN","XUMFH",201,0)
 .N FDA,IEN
"RTN","XUMFH",202,0)
 .S FDA(IFN,"?+1,"_IENS,.01)=MKEY
"RTN","XUMFH",203,0)
 .D UPDATE^DIE("E","FDA","IEN","ERR")
"RTN","XUMFH",204,0)
 .I $D(ERR) D
"RTN","XUMFH",205,0)
 ..D EM("update DIE call error message in SUBFILE",.ERR)
"RTN","XUMFH",206,0)
 ..K ERR
"RTN","XUMFH",207,0)
 .S IENS1=IEN(1)_","_IENS,MULT(SEQ)=IENS1
"RTN","XUMFH",208,0)
 .S FDA1(IFN,IENS1,.01)=MKEY
"RTN","XUMFH",209,0)
 I MULT,MULT'=SEQ S IENS1=$G(MULT(+MULT)) Q:IENS1=""
"RTN","XUMFH",210,0)
 S FDA1(IFN,IENS1,FIELD)=VALUE
"RTN","XUMFH",211,0)
 ;
"RTN","XUMFH",212,0)
 Q
"RTN","XUMFH",213,0)
 ;
"RTN","XUMFH",214,0)
VALUE(HLNODE,SEQ) ; -- handle HL7 continuation nodes
"RTN","XUMFH",215,0)
 ;
"RTN","XUMFH",216,0)
 N I,X,Y,N,T,Z,NODE
"RTN","XUMFH",217,0)
 ;
"RTN","XUMFH",218,0)
 S SEQ=$P($G(SEQ),".") Q:'SEQ ""
"RTN","XUMFH",219,0)
 ;
"RTN","XUMFH",220,0)
 M Z=HLNODE
"RTN","XUMFH",221,0)
 S Z(0)=HLNODE
"RTN","XUMFH",222,0)
 ;
"RTN","XUMFH",223,0)
 S I=0
"RTN","XUMFH",224,0)
 F  S I=$O(Z(I)) Q:'I  D
"RTN","XUMFH",225,0)
 .Q:$E(Z(I),1)=HLFS
"RTN","XUMFH",226,0)
 .S X=$P(Z(I),HLFS)
"RTN","XUMFH",227,0)
 .S Y=$O(Z(I),-1)
"RTN","XUMFH",228,0)
 .S Z(Y)=Z(Y)_X
"RTN","XUMFH",229,0)
 .S:$L(Z(I),HLFS)'="" Z(I)=HLFS_$P(Z(I),HLFS,2,999)
"RTN","XUMFH",230,0)
 .K:$L(Z(I),HLFS)="" Z(I)
"RTN","XUMFH",231,0)
 ;
"RTN","XUMFH",232,0)
 S X=0
"RTN","XUMFH",233,0)
 F  S X=$O(Z(X)) Q:'X  D
"RTN","XUMFH",234,0)
 .S X(X)=$L(Z(X),HLFS)-1
"RTN","XUMFH",235,0)
 S X(0)=$L(Z,HLFS)-1
"RTN","XUMFH",236,0)
 ;
"RTN","XUMFH",237,0)
 S (X,N,T)=""
"RTN","XUMFH",238,0)
 F  S X=$O(X(X)) Q:X=""  D
"RTN","XUMFH",239,0)
 .S T=T+$P(X(X),U),N(T+1)=X
"RTN","XUMFH",240,0)
 ;
"RTN","XUMFH",241,0)
 S (X,Y)=""
"RTN","XUMFH",242,0)
 F  S X=$O(X(X)) Q:X=""  D
"RTN","XUMFH",243,0)
 .S $P(X(X),U,2)=Y
"RTN","XUMFH",244,0)
 .S Y=+X(X)+Y
"RTN","XUMFH",245,0)
 ;
"RTN","XUMFH",246,0)
 S NODE=$G(N(+$O(N(SEQ)))) Q:NODE="" ""
"RTN","XUMFH",247,0)
 ;
"RTN","XUMFH",248,0)
 Q $P(Z(NODE),HLFS,(SEQ-($P(X(NODE),U,2))+1))
"RTN","XUMFH",249,0)
 ;
"RTN","XUMFH",250,0)
SUBCOMP ; -- subcomponents
"RTN","XUMFH",251,0)
 ;
"RTN","XUMFH",252,0)
 S SEQ3=0
"RTN","XUMFH",253,0)
 F  S SEQ3=$O(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"HLSCS",SEQ3)) Q:'SEQ3  D
"RTN","XUMFH",254,0)
 .S FIELD=$O(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"HLSCS",SEQ3,0))
"RTN","XUMFH",255,0)
 .S TYP=$G(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"HLSCS",SEQ3,FIELD))
"RTN","XUMFH",256,0)
 .S VALUE=$$VALUE(.HLNODE,SEQ)
"RTN","XUMFH",257,0)
 .S VALUE=$P(VALUE,HLCS,SEQ2)
"RTN","XUMFH",258,0)
 .S VALUE=$P(VALUE,HLSCS,SEQ3)
"RTN","XUMFH",259,0)
 .S VALUE=$$DTYP^XUMFP(VALUE,TYP,HLSCS,0)
"RTN","XUMFH",260,0)
 .S FDA(IFN,IENS,FIELD)=VALUE
"RTN","XUMFH",261,0)
 ;
"RTN","XUMFH",262,0)
 Q
"RTN","XUMFH",263,0)
 ;
"RTN","XUMFH",264,0)
ARRAY ; -- query data stored in array (not filed)
"RTN","XUMFH",265,0)
 ;
"RTN","XUMFH",266,0)
 I $P($G(KEY),HLCS)="" D  Q
"RTN","XUMFH",267,0)
 .D EM("Null KEY found in the following segment: "_$E(HLNODE,1,80),.ERR)
"RTN","XUMFH",268,0)
 .S ERROR=ERROR_U_$G(ERR)
"RTN","XUMFH",269,0)
 ;
"RTN","XUMFH",270,0)
 M ^TMP("XUMF ARRAY",$J,$P(KEY,HLCS))=HLNODE
"RTN","XUMFH",271,0)
 ;
"RTN","XUMFH",272,0)
 Q
"RTN","XUMFH",273,0)
 ;
"RTN","XUMFH",274,0)
REPLY ; -- master file response
"RTN","XUMFH",275,0)
 ;
"RTN","XUMFH",276,0)
 Q:HL("MTN")="MFR"
"RTN","XUMFH",277,0)
 Q:HL("MTN")="MFK"
"RTN","XUMFH",278,0)
 Q:HL("MTN")="ACK"
"RTN","XUMFH",279,0)
 ;
"RTN","XUMFH",280,0)
 S:(TYPE<10) TYPE=(TYPE+10)
"RTN","XUMFH",281,0)
 ;
"RTN","XUMFH",282,0)
 I HL("MTN")="MFQ" D
"RTN","XUMFH",283,0)
 .S IFN=+$G(WHAT) I 'IFN D  Q
"RTN","XUMFH",284,0)
 ..S ERROR="1^REPLY MFQ couldn't resolve IFN"
"RTN","XUMFH",285,0)
 ..D EM(ERROR,.ERR)
"RTN","XUMFH",286,0)
 .S XREF=$P(WHO,HLCS,9),ROOT=$$ROOT^DILFD(IFN,,1)
"RTN","XUMFH",287,0)
 .S IEN=$O(@ROOT@(XREF,$P(WHO,HLCS),0))
"RTN","XUMFH",288,0)
 .S IEN=$S(IEN:IEN,1:$P(WHO,HLCS))
"RTN","XUMFH",289,0)
 ;
"RTN","XUMFH",290,0)
 S IFN=$G(IFN),IEN=$G(IEN)
"RTN","XUMFH",291,0)
 ;
"RTN","XUMFH",292,0)
 D MAIN^XUMFP(IFN,IEN,TYPE,.PARAM,.ERROR)
"RTN","XUMFH",293,0)
 D MAIN^XUMFI(IFN,IEN,TYPE,.PARAM,.ERROR)
"RTN","XUMFH",294,0)
 ;
"RTN","XUMFH",295,0)
 Q
"RTN","XUMFH",296,0)
 ;
"RTN","XUMFH",297,0)
EXIT ; -- cleanup, and quit
"RTN","XUMFH",298,0)
 ;
"RTN","XUMFH",299,0)
 K ^TMP("DILIST",$J),^TMP("DIERR",$J),^TMP("HLS",$J),^TMP("HLA",$J)
"RTN","XUMFH",300,0)
 ;
"RTN","XUMFH",301,0)
 Q
"RTN","XUMFH",302,0)
 ;
"RTN","XUMFH",303,0)
EM(ERROR,ERR,XMSUB,XMY) ; -- error message
"RTN","XUMFH",304,0)
 ;
"RTN","XUMFH",305,0)
 N X,XMTEXT,FLG
"RTN","XUMFH",306,0)
 ;
"RTN","XUMFH",307,0)
 S FLG=0
"RTN","XUMFH",308,0)
 ;
"RTN","XUMFH",309,0)
 D MSG^DIALOG("AM",.X,80,,"ERR")
"RTN","XUMFH",310,0)
 ;
"RTN","XUMFH",311,0)
 S X(.1)="HL7 message ID: "_$G(HL("MID"))
"RTN","XUMFH",312,0)
 S X(.2)="",X(.3)=$G(ERROR),X(.4)=""
"RTN","XUMFH",313,0)
 S:$G(XMSUB)="" XMSUB="MFS ERROR"
"RTN","XUMFH",314,0)
 S XMY("G.XUMF ERROR")=""
"RTN","XUMFH",315,0)
 S XMTEXT="X("
"RTN","XUMFH",316,0)
 ;
"RTN","XUMFH",317,0)
 S X=.9 F  S X=$O(X(X)) Q:'X  D
"RTN","XUMFH",318,0)
 .I X(X)="" K X(X) Q
"RTN","XUMFH",319,0)
 .I X(X)["DINUMed field cannot" S FLG=1 K X(X) Q
"RTN","XUMFH",320,0)
 .I X(X)["ASSOCIATION" S FLG=1 K X(X) Q
"RTN","XUMFH",321,0)
 .I X(X)["INSTITUTION" S FLG=1 K X(X) Q
"RTN","XUMFH",322,0)
 ;
"RTN","XUMFH",323,0)
 I FLG Q:'$O(X(.9))
"RTN","XUMFH",324,0)
 ;
"RTN","XUMFH",325,0)
 D ^XMD
"RTN","XUMFH",326,0)
 ;
"RTN","XUMFH",327,0)
 Q
"RTN","XUMFH",328,0)
 ;
"RTN","XUMFI")
0^5^B79789892
"RTN","XUMFI",1,0)
XUMFI ;CIOFO-SF/RAM - Master File Interface ;06/28/00
"RTN","XUMFI",2,0)
 ;;8.0;KERNEL;**206,217,218,335,261**;Jul 10, 1995
"RTN","XUMFI",3,0)
 ;
"RTN","XUMFI",4,0)
 ; This routine is the Master File Server HL7 message builder API.
"RTN","XUMFI",5,0)
 ; The routine will generate messages for both trigger events and
"RTN","XUMFI",6,0)
 ; queries.
"RTN","XUMFI",7,0)
 ;
"RTN","XUMFI",8,0)
 ; Use the routine XUMFP to initialize the PARAM array.
"RTN","XUMFI",9,0)
 ; See XUMFP for a full description of the parameters.
"RTN","XUMFI",10,0)
 ;
"RTN","XUMFI",11,0)
 ; use of $O(^HLCS(870,"C",institution_ptr)) supported by IA# 3550
"RTN","XUMFI",12,0)
 ;
"RTN","XUMFI",13,0)
MAIN(IFN,IEN,TYPE,PARAM,ERROR) ;  -- entry point
"RTN","XUMFI",14,0)
 ;
"RTN","XUMFI",15,0)
 ;
"RTN","XUMFI",16,0)
 N HLFS,HLCS,HLRESLT,QUERY,UPDATE,ALL,CNT,ROOT,PROTOCOL,MFR,MFQ,MTYP,I
"RTN","XUMFI",17,0)
 N ARRAY,GROUP,MFK,CDSYS,J,HLSCS
"RTN","XUMFI",18,0)
 ;
"RTN","XUMFI",19,0)
 M ^TMP("XUMF MFS",$J,"PARAM")=PARAM K PARAM
"RTN","XUMFI",20,0)
 ;
"RTN","XUMFI",21,0)
 D INIT,BUILD,LLNK,SEND,EXIT
"RTN","XUMFI",22,0)
 ;
"RTN","XUMFI",23,0)
 ;
"RTN","XUMFI",24,0)
 Q
"RTN","XUMFI",25,0)
 ;
"RTN","XUMFI",26,0)
INIT ; -- initialize
"RTN","XUMFI",27,0)
 ;
"RTN","XUMFI",28,0)
 K ^TMP("DILIST",$J),^TMP("DIERR",$J)
"RTN","XUMFI",29,0)
 K ^TMP("HLS",$J),^TMP("HLA",$J)
"RTN","XUMFI",30,0)
 ;
"RTN","XUMFI",31,0)
 S IEN=$G(IEN),IFN=$G(IFN)
"RTN","XUMFI",32,0)
 S TYPE=$G(TYPE),ERROR=$G(ERROR),CNT=1
"RTN","XUMFI",33,0)
 S UPDATE=$S(TYPE#2:0,1:1)
"RTN","XUMFI",34,0)
 S QUERY='UPDATE
"RTN","XUMFI",35,0)
 S GROUP=$S(UPDATE:0,TYPE[5:1,TYPE[7:1,1:0)
"RTN","XUMFI",36,0)
 S ARRAY=$S(UPDATE:0,TYPE[3:1,TYPE[7:1,1:0)
"RTN","XUMFI",37,0)
 S ALL=$S(IEN["ALL":1,1:0)
"RTN","XUMFI",38,0)
 S PROTOCOL=$G(^TMP("XUMF MFS",$J,"PARAM","PROTOCOL"))
"RTN","XUMFI",39,0)
 S MFR=$S(UPDATE:0,TYPE>10:1,1:0)
"RTN","XUMFI",40,0)
 S MFQ=$S(UPDATE:0,'MFR:1,1:0)
"RTN","XUMFI",41,0)
 S MFK=$S(TYPE=10:1,1:0)
"RTN","XUMFI",42,0)
 S MTYP=$S(MFR:"HLA",MFK:"HLA",1:"HLS")
"RTN","XUMFI",43,0)
 ;
"RTN","XUMFI",44,0)
 ; -- get variables from HL7 package
"RTN","XUMFI",45,0)
 I $O(HL(""))="" D INIT^HLFNC2(PROTOCOL,.HL)
"RTN","XUMFI",46,0)
 I $O(HL(""))="" S ERROR="1^"_$P(HL,"^",2) Q
"RTN","XUMFI",47,0)
 S HLFS=HL("FS"),HLCS=$E(HL("ECH")),HLSCS=$E(HL("ECH"),4)
"RTN","XUMFI",48,0)
 ;
"RTN","XUMFI",49,0)
 Q:ERROR
"RTN","XUMFI",50,0)
 ;
"RTN","XUMFI",51,0)
 ; -- check parameters
"RTN","XUMFI",52,0)
 I 'QUERY,'UPDATE S ERROR="1^invalid message type" Q
"RTN","XUMFI",53,0)
 I 'IFN S ERROR="1^invalid file number" Q
"RTN","XUMFI",54,0)
 I 'IEN,'ALL,'MFK S ERROR="1^invalid IEN" Q
"RTN","XUMFI",55,0)
 I '$$VFILE^DILFD(IFN) S ERROR="1^invalid file number" Q
"RTN","XUMFI",56,0)
 I UPDATE,'IEN S ERROR="1^update message requires an IEN" Q
"RTN","XUMFI",57,0)
 ;
"RTN","XUMFI",58,0)
 ; -- get root of file
"RTN","XUMFI",59,0)
 S ROOT=$$ROOT^DILFD(IFN,,1)
"RTN","XUMFI",60,0)
 ;
"RTN","XUMFI",61,0)
 ; -- if IEN array input, merge with param
"RTN","XUMFI",62,0)
 I 'ALL,'IEN,$O(IEN(0)) M ^TMP("XUMF MFS",$J,"PARAM","IEN")=IEN
"RTN","XUMFI",63,0)
 ;
"RTN","XUMFI",64,0)
 ; -- if CDSYS and ALL get entries
"RTN","XUMFI",65,0)
 S CDSYS=$G(^TMP("XUMF MFS",$J,"PARAM","CDSYS"))
"RTN","XUMFI",66,0)
 I ALL,CDSYS'="" D
"RTN","XUMFI",67,0)
 .S I=0 F  S I=$O(@ROOT@("XUMFIDX",CDSYS,I)) Q:'I  D
"RTN","XUMFI",68,0)
 ..S J=$O(@ROOT@("XUMFIDX",CDSYS,I,0))
"RTN","XUMFI",69,0)
 ..S ^TMP("XUMF MFS",$J,"PARAM","IEN",J)=""
"RTN","XUMFI",70,0)
 ;
"RTN","XUMFI",71,0)
 ; -- get ALL file 'national' entries
"RTN","XUMFI",72,0)
 I ALL,'$D(^TMP("XUMF MFS",$J,"PARAM","IEN")) D
"RTN","XUMFI",73,0)
 .S I=0 F  S I=$O(@ROOT@("XUMF","N",I)) Q:'I  D
"RTN","XUMFI",74,0)
 ..S ^TMP("XUMF MFS",$J,"PARAM","IEN",I)=""
"RTN","XUMFI",75,0)
 ;
"RTN","XUMFI",76,0)
 Q
"RTN","XUMFI",77,0)
 ;
"RTN","XUMFI",78,0)
BUILD ; -- build message
"RTN","XUMFI",79,0)
 ;
"RTN","XUMFI",80,0)
 I MFK D MFK Q
"RTN","XUMFI",81,0)
 ;
"RTN","XUMFI",82,0)
 Q:ERROR
"RTN","XUMFI",83,0)
 ;
"RTN","XUMFI",84,0)
 N ID,APP,EVENT,ENDT,EFFDT,RESP,MFI,MFN,EDT,CODE,MFE
"RTN","XUMFI",85,0)
 ;
"RTN","XUMFI",86,0)
 I QUERY D QRD Q:MFQ
"RTN","XUMFI",87,0)
 ;
"RTN","XUMFI",88,0)
 D MFI
"RTN","XUMFI",89,0)
 ;
"RTN","XUMFI",90,0)
 I GROUP D GROUP Q
"RTN","XUMFI",91,0)
 ;
"RTN","XUMFI",92,0)
 D MFE,ZZZ
"RTN","XUMFI",93,0)
 ;
"RTN","XUMFI",94,0)
 Q
"RTN","XUMFI",95,0)
 ;
"RTN","XUMFI",96,0)
MFK ; -- master file acknowledgement
"RTN","XUMFI",97,0)
 ;
"RTN","XUMFI",98,0)
 N X
"RTN","XUMFI",99,0)
 S X="MSA"_HLFS_$S(ERROR:"AE",1:"AA")_HLFS_HL("MID")_HLFS_$P(ERROR,U,2)
"RTN","XUMFI",100,0)
 S ^TMP(MTYP,$J,CNT)=X
"RTN","XUMFI",101,0)
 S CNT=CNT+1
"RTN","XUMFI",102,0)
 ;
"RTN","XUMFI",103,0)
 Q
"RTN","XUMFI",104,0)
 ;
"RTN","XUMFI",105,0)
QRD ; -- query definition segment
"RTN","XUMFI",106,0)
 ;
"RTN","XUMFI",107,0)
 I TYPE>10 D
"RTN","XUMFI",108,0)
 .S ^TMP(MTYP,$J,CNT)="MSA"_HLFS_$S(ERROR:"AE",1:"AA")_HLFS_HL("MID")
"RTN","XUMFI",109,0)
 .S CNT=CNT+1
"RTN","XUMFI",110,0)
 ;
"RTN","XUMFI",111,0)
 Q:ERROR
"RTN","XUMFI",112,0)
 ;
"RTN","XUMFI",113,0)
 N QDT,QFC,QP,QID,ZDRT,ZDRDT,QLR,WHO,WHAT,WDDC,WDCVQ,QRL,QRD
"RTN","XUMFI",114,0)
 ;
"RTN","XUMFI",115,0)
 S QDT=$G(^TMP("XUMF MFS",$J,"PARAM","QDT"))
"RTN","XUMFI",116,0)
 S QFC=$G(^TMP("XUMF MFS",$J,"PARAM","QFC"))
"RTN","XUMFI",117,0)
 S QP=$G(^TMP("XUMF MFS",$J,"PARAM","QP"))
"RTN","XUMFI",118,0)
 S QID=$G(^TMP("XUMF MFS",$J,"PARAM","QID"))
"RTN","XUMFI",119,0)
 S ZDRT=$G(^TMP("XUMF MFS",$J,"PARAM","DRT"))
"RTN","XUMFI",120,0)
 S ZDRDT=$G(^TMP("XUMF MFS",$J,"PARAM","DRDT"))
"RTN","XUMFI",121,0)
 S QLR=$G(^TMP("XUMF MFS",$J,"PARAM","QLR"))
"RTN","XUMFI",122,0)
 S WHO=$G(^TMP("XUMF MFS",$J,"PARAM","WHO"))
"RTN","XUMFI",123,0)
 S WHAT=$G(^TMP("XUMF MFS",$J,"PARAM","WHAT"))
"RTN","XUMFI",124,0)
 S WDDC=$G(^TMP("XUMF MFS",$J,"PARAM","WDDC"))
"RTN","XUMFI",125,0)
 S WDCVQ=$G(^TMP("XUMF MFS",$J,"PARAM","WDCVQ"))
"RTN","XUMFI",126,0)
 S QRL=$G(^TMP("XUMF MFS",$J,"PARAM","QRL"))
"RTN","XUMFI",127,0)
 S QRD="QRD"_HLFS_QDT_HLFS_QFC_HLFS_QP_HLFS_QID_HLFS_ZDRT_HLFS_ZDRDT
"RTN","XUMFI",128,0)
 S QRD=QRD_HLFS_QLR_HLFS_WHO_HLFS_WHAT_HLFS_WDDC_HLFS_WDCVQ_HLFS_QRL
"RTN","XUMFI",129,0)
 S ^TMP(MTYP,$J,CNT)=QRD
"RTN","XUMFI",130,0)
 S CNT=CNT+1
"RTN","XUMFI",131,0)
 ;
"RTN","XUMFI",132,0)
 Q
"RTN","XUMFI",133,0)
 ;
"RTN","XUMFI",134,0)
MFI ; master file identifier segment
"RTN","XUMFI",135,0)
 ;
"RTN","XUMFI",136,0)
 Q:ERROR
"RTN","XUMFI",137,0)
 ;
"RTN","XUMFI",138,0)
 N ID,APP,EVENT,ENDT,EFFDT,RESP,MFI
"RTN","XUMFI",139,0)
 ;
"RTN","XUMFI",140,0)
 S ID=$G(^TMP("XUMF MFS",$J,"PARAM","MFI"))
"RTN","XUMFI",141,0)
 S APP=$G(^TMP("XUMF MFS",$J,"PARAM","MFAI"))
"RTN","XUMFI",142,0)
 S EVENT=$G(^TMP("XUMF MFS",$J,"PARAM","FLEV"))
"RTN","XUMFI",143,0)
 S ENDT=$G(^TMP("XUMF MFS",$J,"PARAM","ENDT"))
"RTN","XUMFI",144,0)
 S EFFDT=$G(^TMP("XUMF MFS",$J,"PARAM","MFIEDT"))
"RTN","XUMFI",145,0)
 S RESP=$G(^TMP("XUMF MFS",$J,"PARAM","RLC"))
"RTN","XUMFI",146,0)
 S:APP="" APP="MFS" S:EVENT="" EVENT="REP" S:RESP="" RESP="NE"
"RTN","XUMFI",147,0)
 S:ENDT="" ENDT=$$NOW^XLFDT S:EFFDT="" EFFDT=$$NOW^XLFDT
"RTN","XUMFI",148,0)
 S MFI=$$MFI^XUMFMFI(ID,APP,EVENT,ENDT,EFFDT,RESP)
"RTN","XUMFI",149,0)
 I $E(MFI)="-" S ERROR=MFI Q
"RTN","XUMFI",150,0)
 S ^TMP(MTYP,$J,CNT)=MFI
"RTN","XUMFI",151,0)
 S CNT=CNT+1
"RTN","XUMFI",152,0)
 ;
"RTN","XUMFI",153,0)
 Q
"RTN","XUMFI",154,0)
 ;
"RTN","XUMFI",155,0)
MFE ; master file entry segment
"RTN","XUMFI",156,0)
 ;
"RTN","XUMFI",157,0)
 Q:ERROR
"RTN","XUMFI",158,0)
 ;
"RTN","XUMFI",159,0)
 N EVENT,MFN,EDT,CODE,MFE
"RTN","XUMFI",160,0)
 ;
"RTN","XUMFI",161,0)
 S EVENT=$G(^TMP("XUMF MFS",$J,"PARAM","RLEC"))
"RTN","XUMFI",162,0)
 S MFN=$G(^TMP("XUMF MFS",$J,"PARAM","MFNCID"))
"RTN","XUMFI",163,0)
 S EDT=$G(^TMP("XUMF MFS",$J,"PARAM","MFEEDT"))
"RTN","XUMFI",164,0)
 S CODE=$G(^TMP("XUMF MFS",$J,"PARAM","PKV"))
"RTN","XUMFI",165,0)
 S:EDT="" EDT=$$NOW^XLFDT S:EVENT="" EVENT="MAD"
"RTN","XUMFI",166,0)
 S MFE=$$MFE^XUMFMFE(EVENT,MFN,EDT,CODE)
"RTN","XUMFI",167,0)
 I $E(MFE)="-" S ERROR=MFE Q
"RTN","XUMFI",168,0)
 S ^TMP(MTYP,$J,CNT)=MFE
"RTN","XUMFI",169,0)
 S CNT=CNT+1
"RTN","XUMFI",170,0)
 ;
"RTN","XUMFI",171,0)
 Q
"RTN","XUMFI",172,0)
 ;
"RTN","XUMFI",173,0)
ZZZ ; [Z...] segment
"RTN","XUMFI",174,0)
 ;
"RTN","XUMFI",175,0)
 Q:ERROR
"RTN","XUMFI",176,0)
 ;
"RTN","XUMFI",177,0)
 N SEG,SEQ,ZZZ,FLD,FILE,IENS,VALUE,ERR,ZDTYP,FIELD,SEQ1,SEQ2,SEQ3
"RTN","XUMFI",178,0)
 N SEQ0,SEQ9,CNT1,CNT2,NODE,XXX
"RTN","XUMFI",179,0)
 ;
"RTN","XUMFI",180,0)
 S SEG="",SEQ=0
"RTN","XUMFI",181,0)
 F  S SEG=$O(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG)) Q:SEG=""  D
"RTN","XUMFI",182,0)
 .S ZZZ=SEG
"RTN","XUMFI",183,0)
 .F  S SEQ=$O(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ)) Q:'SEQ  D
"RTN","XUMFI",184,0)
 ..;
"RTN","XUMFI",185,0)
 ..S SEQ1=$P(SEQ,"."),SEQ2=$P(SEQ,".",2)
"RTN","XUMFI",186,0)
 ..S SEQ3=$O(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"HLSCS",0))
"RTN","XUMFI",187,0)
 ..;
"RTN","XUMFI",188,0)
 ..I SEQ3 D SUBCOMP Q
"RTN","XUMFI",189,0)
 ..;
"RTN","XUMFI",190,0)
 ..S FLD=$O(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,0))
"RTN","XUMFI",191,0)
 ..;
"RTN","XUMFI",192,0)
 ..I 'FLD D
"RTN","XUMFI",193,0)
 ...S FILE=^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"FILE")
"RTN","XUMFI",194,0)
 ...S IENS=$G(^TMP("XUMF MFS",$J,"PARAM","IENS",SEG,SEQ))
"RTN","XUMFI",195,0)
 ...S FIELD=^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"FIELD")
"RTN","XUMFI",196,0)
 ...S ZDTYP=^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"DTYP")
"RTN","XUMFI",197,0)
 ...I $P(ZDTYP,U,3)[":" S FIELD=FIELD_$P(ZDTYP,U,3)
"RTN","XUMFI",198,0)
 ...S VALUE=$$GET1^DIQ(FILE,IENS,FIELD)
"RTN","XUMFI",199,0)
 ...S VALUE=$$DTYP^XUMFP(VALUE,ZDTYP,HLCS,1)
"RTN","XUMFI",200,0)
 ..I FLD D
"RTN","XUMFI",201,0)
 ...S ZDTYP=$G(^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,FLD))
"RTN","XUMFI",202,0)
 ...I $P(ZDTYP,U,3)[":" S FLD=FLD_$P(ZDTYP,U,3)
"RTN","XUMFI",203,0)
 ...S VALUE=$$GET1^DIQ(IFN,IEN_",",FLD)
"RTN","XUMFI",204,0)
 ...S VALUE=$$DTYP^XUMFP(VALUE,ZDTYP,HLCS,1)
"RTN","XUMFI",205,0)
 ..;
"RTN","XUMFI",206,0)
 ..S ZZZ(SEQ)=VALUE
"RTN","XUMFI",207,0)
 .;
"RTN","XUMFI",208,0)
 .S X=0
"RTN","XUMFI",209,0)
 .F  S X=$O(ZZZ(X)) Q:'X  D
"RTN","XUMFI",210,0)
 ..S SEQ1=$P(X,"."),SEQ2=+$P(X,".",2)
"RTN","XUMFI",211,0)
 ..S XXX(SEQ1,SEQ2)=ZZZ(X)
"RTN","XUMFI",212,0)
 .K ZZZ
"RTN","XUMFI",213,0)
 .M ZZZ=XXX
"RTN","XUMFI",214,0)
 .;
"RTN","XUMFI",215,0)
 .K NODE
"RTN","XUMFI",216,0)
 .S (SEQ,SEQ0,SEQ9,SEQ1,CNT1,CNT2)=0,NODE=""
"RTN","XUMFI",217,0)
 .F  S SEQ1=$O(ZZZ(SEQ1)) Q:'SEQ1  D
"RTN","XUMFI",218,0)
 ..S SEQ2=0,VALUE=$G(ZZZ(SEQ1,SEQ2))
"RTN","XUMFI",219,0)
 ..F  S SEQ2=$O(ZZZ(SEQ1,SEQ2)) Q:'SEQ2  D
"RTN","XUMFI",220,0)
 ...S $P(VALUE,HLCS,SEQ2)=ZZZ(SEQ1,SEQ2)
"RTN","XUMFI",221,0)
 ..S NODE(CNT1)=$G(NODE(CNT1))
"RTN","XUMFI",222,0)
 ..I NODE(CNT1)'="",$L(NODE(CNT1)_VALUE)>200 D
"RTN","XUMFI",223,0)
 ...S CNT1=CNT1+1,SEQ9=SEQ0+SEQ9
"RTN","XUMFI",224,0)
 ..S SEQ=$S('CNT1:SEQ1,1:SEQ1-SEQ9)
"RTN","XUMFI",225,0)
 ..S $P(NODE(CNT1),HLFS,SEQ)=VALUE
"RTN","XUMFI",226,0)
 ..S SEQ0=SEQ-1
"RTN","XUMFI",227,0)
 .;
"RTN","XUMFI",228,0)
 .S NODE=SEG_HLFS_$G(NODE(0)) K NODE(0)
"RTN","XUMFI",229,0)
 .;
"RTN","XUMFI",230,0)
 .M ^TMP(MTYP,$J,CNT)=NODE
"RTN","XUMFI",231,0)
 .S CNT=CNT+1
"RTN","XUMFI",232,0)
 ;
"RTN","XUMFI",233,0)
 Q
"RTN","XUMFI",234,0)
 ;
"RTN","XUMFI",235,0)
SUBCOMP ; -- subcomponents
"RTN","XUMFI",236,0)
 ;
"RTN","XUMFI",237,0)
 N A,YYY
"RTN","XUMFI",238,0)
 ;
"RTN","XUMFI",239,0)
 M A=^TMP("XUMF MFS",$J,"PARAM","SEG",SEG,"SEQ",SEQ,"HLSCS")
"RTN","XUMFI",240,0)
 S YYY=""
"RTN","XUMFI",241,0)
 ;
"RTN","XUMFI",242,0)
 S SEQ3=0
"RTN","XUMFI",243,0)
 F  S SEQ3=$O(A(SEQ3)) Q:'SEQ3  D
"RTN","XUMFI",244,0)
 .S FLD=$O(A(SEQ3,0))
"RTN","XUMFI",245,0)
 .S ZDTYP=$G(A(SEQ3,FLD))
"RTN","XUMFI",246,0)
 .I $P(ZDTYP,U,3)[":" S FLD=FLD_$P(ZDTYP,U,3)
"RTN","XUMFI",247,0)
 .S VALUE=$$GET1^DIQ(IFN,IEN_",",FLD)
"RTN","XUMFI",248,0)
 .S VALUE=$$DTYP^XUMFP(VALUE,ZDTYP,HLSCS,1)
"RTN","XUMFI",249,0)
 .S $P(YYY,HLSCS,SEQ3)=VALUE
"RTN","XUMFI",250,0)
 ;
"RTN","XUMFI",251,0)
 S ZZZ(SEQ)=YYY
"RTN","XUMFI",252,0)
 ;
"RTN","XUMFI",253,0)
 Q
"RTN","XUMFI",254,0)
 ;
"RTN","XUMFI",255,0)
GROUP ; -- query group records
"RTN","XUMFI",256,0)
 ;
"RTN","XUMFI",257,0)
 Q:ERROR
"RTN","XUMFI",258,0)
 ;
"RTN","XUMFI",259,0)
 S IEN=0
"RTN","XUMFI",260,0)
 F  S IEN=$O(^TMP("XUMF MFS",$J,"PARAM","IEN",IEN)) Q:'IEN  D
"RTN","XUMFI",261,0)
 .K ^TMP("XUMF MFS",$J,"PARAM","PKV")
"RTN","XUMFI",262,0)
 .K ^TMP("XUMF MFS",$J,"PARAM","IENS")
"RTN","XUMFI",263,0)
 .S ^TMP("XUMF MFS",$J,"PARAM","PKV")=^TMP("XUMF MFS",$J,"PARAM",IEN,"PKV")
"RTN","XUMFI",264,0)
 .M ^TMP("XUMF MFS",$J,"PARAM","IENS")=^TMP("XUMF MFS",$J,"PARAM",IEN,"IENS")
"RTN","XUMFI",265,0)
 .D MFE,ZZZ
"RTN","XUMFI",266,0)
 ;
"RTN","XUMFI",267,0)
 Q
"RTN","XUMFI",268,0)
 ;
"RTN","XUMFI",269,0)
SEND ; -- send HL7 message
"RTN","XUMFI",270,0)
 ;
"RTN","XUMFI",271,0)
 I 'MFK,ERROR Q
"RTN","XUMFI",272,0)
 ;
"RTN","XUMFI",273,0)
 S HLP("PRIORITY")="I"
"RTN","XUMFI",274,0)
 ;
"RTN","XUMFI",275,0)
 I 'TYPE D GENERATE^HLMA(PROTOCOL,"GM",1,.HLRESLT,"",.HLP)
"RTN","XUMFI",276,0)
 I TYPE,(TYPE<10) D DIRECT^HLMA(PROTOCOL,"GM",1,.HLRESLT,"",.HLP)
"RTN","XUMFI",277,0)
 I (TYPE>9),$G(HLMTIENS) D
"RTN","XUMFI",278,0)
 .D GENACK^HLMA1(HL("EID"),HLMTIENS,HL("EIDS"),"GM",1,.HLRESLT)
"RTN","XUMFI",279,0)
 ;
"RTN","XUMFI",280,0)
 ; check for error
"RTN","XUMFI",281,0)
 I ($P($G(HLRESLT),U,3)'="") D  Q
"RTN","XUMFI",282,0)
 .S ERROR=1_U_$P(HLRESLT,HLFS,3)_U_$P(HLRESLT,HLFS,2)_U_$P(HLRESLT,U)
"RTN","XUMFI",283,0)
 ;
"RTN","XUMFI",284,0)
 ; successful call, message ID returned
"RTN","XUMFI",285,0)
 S ERROR="0^"_$P($G(HLRESLT),U,1)
"RTN","XUMFI",286,0)
 ;
"RTN","XUMFI",287,0)
 Q
"RTN","XUMFI",288,0)
 ;
"RTN","XUMFI",289,0)
EXIT ; -- exit
"RTN","XUMFI",290,0)
 ;
"RTN","XUMFI",291,0)
 D CLEAN^DILF
"RTN","XUMFI",292,0)
 ;
"RTN","XUMFI",293,0)
 K ^TMP("HLS",$J),^TMP("HLA",$J)
"RTN","XUMFI",294,0)
 K ^TMP("XUMF MFS",$J)
"RTN","XUMFI",295,0)
 ;
"RTN","XUMFI",296,0)
 Q
"RTN","XUMFI",297,0)
 ;
"RTN","XUMFI",298,0)
LLNK ; -- dynamic addressing BROADCAST
"RTN","XUMFI",299,0)
 ;
"RTN","XUMFI",300,0)
 Q:TYPE>9
"RTN","XUMFI",301,0)
 ;
"RTN","XUMFI",302,0)
 I $G(^TMP("XUMF MFS",$J,"PARAM","LLNK"))'="" D  Q
"RTN","XUMFI",303,0)
 .S HLL("LINKS",1)=^TMP("XUMF MFS",$J,"PARAM","LLNK")
"RTN","XUMFI",304,0)
 ;
"RTN","XUMFI",305,0)
 Q:'$$SERVER()
"RTN","XUMFI",306,0)
 ;
"RTN","XUMFI",307,0)
 Q:TYPE
"RTN","XUMFI",308,0)
 Q:'$G(^TMP("XUMF MFS",$J,"PARAM","BROADCAST"))
"RTN","XUMFI",309,0)
 ;
"RTN","XUMFI",310,0)
 N I,J,LLNK
"RTN","XUMFI",311,0)
 ;
"RTN","XUMFI",312,0)
 S (I,J)=0
"RTN","XUMFI",313,0)
 F  S I=$O(^HLCS(870,"C",I)) Q:'I  D
"RTN","XUMFI",314,0)
 .S J=$O(^HLCS(870,"C",I,0)) Q:'J
"RTN","XUMFI",315,0)
 .S LLNK=$P($G(^HLCS(870,J,0)),U)
"RTN","XUMFI",316,0)
 .S HLL("LINKS",I)="XUMF MFK^"_LLNK
"RTN","XUMFI",317,0)
 ;
"RTN","XUMFI",318,0)
 Q
"RTN","XUMFI",319,0)
 ;
"RTN","XUMFI",320,0)
SERVER() ; -- servers
"RTN","XUMFI",321,0)
 ;
"RTN","XUMFI",322,0)
 N I
"RTN","XUMFI",323,0)
 ;
"RTN","XUMFI",324,0)
 S I=$$KSP^XUPARAM("INST") Q:'I 0
"RTN","XUMFI",325,0)
 ;
"RTN","XUMFI",326,0)
 Q:I=442 1  ;BP TEST
"RTN","XUMFI",327,0)
 Q:I=12000 1  ;FORUM
"RTN","XUMFI",328,0)
 Q:I=100002 1  ;HEC
"RTN","XUMFI",329,0)
 ;
"RTN","XUMFI",330,0)
 Q 0
"RTN","XUMFI",331,0)
 ;
"VER")
8.0^22.0
**END**
**END**
