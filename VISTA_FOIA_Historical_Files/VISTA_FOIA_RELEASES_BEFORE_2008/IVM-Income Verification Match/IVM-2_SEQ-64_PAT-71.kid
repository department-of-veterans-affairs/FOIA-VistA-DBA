Released IVM*2*71 SEQ #64
Extracted from mail message
**KIDS**:IVM*2.0*71^

**INSTALL NAME**
IVM*2.0*71
"BLD",4438,0)
IVM*2.0*71^INCOME VERIFICATION MATCH^0^3030515^y
"BLD",4438,1,0)
^^11^11^3021213^
"BLD",4438,1,1,0)
The problem is that when the Means Test Signature (Z06) is transmitted to 
"BLD",4438,1,2,0)
the site that performed the Means Test, and the test did not upload for 
"BLD",4438,1,3,0)
any reason, the "IVM - MEANS TEST UPLOAD" Bulletin gives the following 
"BLD",4438,1,4,0)
message:
"BLD",4438,1,5,0)
 
"BLD",4438,1,6,0)
The following error occured when an Income Verification Match
"BLD",4438,1,7,0)
verified Means Test was being uploaded for the following patient:
"BLD",4438,1,8,0)
 
"BLD",4438,1,9,0)
    NAME:     Xxxxxxx,Xxxxxxx
"BLD",4438,1,10,0)
    ID:       XXX-XX-XXXX
"BLD",4438,1,11,0)
    ERROR:    Means Test of NOV 28,2002 not in DHCP.
"BLD",4438,4,0)
^9.64PA^^0
"BLD",4438,"INIT")
EN^IVM2071A
"BLD",4438,"KRN",0)
^9.67PA^8989.52^19
"BLD",4438,"KRN",.4,0)
.4
"BLD",4438,"KRN",.401,0)
.401
"BLD",4438,"KRN",.402,0)
.402
"BLD",4438,"KRN",.403,0)
.403
"BLD",4438,"KRN",.5,0)
.5
"BLD",4438,"KRN",.84,0)
.84
"BLD",4438,"KRN",3.6,0)
3.6
"BLD",4438,"KRN",3.8,0)
3.8
"BLD",4438,"KRN",9.2,0)
9.2
"BLD",4438,"KRN",9.8,0)
9.8
"BLD",4438,"KRN",9.8,"NM",0)
^9.68A^10^9
"BLD",4438,"KRN",9.8,"NM",1,0)
IVMPRECZ^^0^B24331457
"BLD",4438,"KRN",9.8,"NM",3,0)
IVMCM1^^0^B34913494
"BLD",4438,"KRN",9.8,"NM",4,0)
IVM2071A^^0^B30985074
"BLD",4438,"KRN",9.8,"NM",5,0)
IVM2071M^^0^B3788857
"BLD",4438,"KRN",9.8,"NM",6,0)
IVMCMF^^0^B7737872
"BLD",4438,"KRN",9.8,"NM",7,0)
IVMCMF1^^0^B33813451
"BLD",4438,"KRN",9.8,"NM",8,0)
IVMCMF2^^0^B37381276
"BLD",4438,"KRN",9.8,"NM",9,0)
IVMCMF3^^0^B36992687
"BLD",4438,"KRN",9.8,"NM",10,0)
IVMCMFB^^0^B12146323
"BLD",4438,"KRN",9.8,"NM","B","IVM2071A",4)

"BLD",4438,"KRN",9.8,"NM","B","IVM2071M",5)

"BLD",4438,"KRN",9.8,"NM","B","IVMCM1",3)

"BLD",4438,"KRN",9.8,"NM","B","IVMCMF",6)

"BLD",4438,"KRN",9.8,"NM","B","IVMCMF1",7)

"BLD",4438,"KRN",9.8,"NM","B","IVMCMF2",8)

"BLD",4438,"KRN",9.8,"NM","B","IVMCMF3",9)

"BLD",4438,"KRN",9.8,"NM","B","IVMCMFB",10)

"BLD",4438,"KRN",9.8,"NM","B","IVMPRECZ",1)

"BLD",4438,"KRN",19,0)
19
"BLD",4438,"KRN",19,"NM",0)
^9.68A^^
"BLD",4438,"KRN",19.1,0)
19.1
"BLD",4438,"KRN",101,0)
101
"BLD",4438,"KRN",409.61,0)
409.61
"BLD",4438,"KRN",771,0)
771
"BLD",4438,"KRN",870,0)
870
"BLD",4438,"KRN",8989.51,0)
8989.51
"BLD",4438,"KRN",8989.52,0)
8989.52
"BLD",4438,"KRN",8994,0)
8994
"BLD",4438,"KRN","B",.4,.4)

"BLD",4438,"KRN","B",.401,.401)

"BLD",4438,"KRN","B",.402,.402)

"BLD",4438,"KRN","B",.403,.403)

"BLD",4438,"KRN","B",.5,.5)

"BLD",4438,"KRN","B",.84,.84)

"BLD",4438,"KRN","B",3.6,3.6)

"BLD",4438,"KRN","B",3.8,3.8)

"BLD",4438,"KRN","B",9.2,9.2)

"BLD",4438,"KRN","B",9.8,9.8)

"BLD",4438,"KRN","B",19,19)

"BLD",4438,"KRN","B",19.1,19.1)

"BLD",4438,"KRN","B",101,101)

"BLD",4438,"KRN","B",409.61,409.61)

"BLD",4438,"KRN","B",771,771)

"BLD",4438,"KRN","B",870,870)

"BLD",4438,"KRN","B",8989.51,8989.51)

"BLD",4438,"KRN","B",8989.52,8989.52)

"BLD",4438,"KRN","B",8994,8994)

"BLD",4438,"QUES",0)
^9.62^^
"BLD",4438,"REQB",0)
^9.611^2^2
"BLD",4438,"REQB",1,0)
IVM*2.0*64^2
"BLD",4438,"REQB",2,0)
IVM*2.0*49^2
"BLD",4438,"REQB","B","IVM*2.0*49",2)

"BLD",4438,"REQB","B","IVM*2.0*64",1)

"INIT")
EN^IVM2071A
"MBREQ")
0
"PKG",220,-1)
1^1
"PKG",220,0)
INCOME VERIFICATION MATCH^IVM^IVM Software for interface with the IVM Center
"PKG",220,20,0)
^9.402P^^
"PKG",220,22,0)
^9.49I^1^1
"PKG",220,22,1,0)
2.0^2941021
"PKG",220,22,1,"PAH",1,0)
71^3030515
"PKG",220,22,1,"PAH",1,1,0)
^^11^11^3030515
"PKG",220,22,1,"PAH",1,1,1,0)
The problem is that when the Means Test Signature (Z06) is transmitted to 
"PKG",220,22,1,"PAH",1,1,2,0)
the site that performed the Means Test, and the test did not upload for 
"PKG",220,22,1,"PAH",1,1,3,0)
any reason, the "IVM - MEANS TEST UPLOAD" Bulletin gives the following 
"PKG",220,22,1,"PAH",1,1,4,0)
message:
"PKG",220,22,1,"PAH",1,1,5,0)
 
"PKG",220,22,1,"PAH",1,1,6,0)
The following error occured when an Income Verification Match
"PKG",220,22,1,"PAH",1,1,7,0)
verified Means Test was being uploaded for the following patient:
"PKG",220,22,1,"PAH",1,1,8,0)
 
"PKG",220,22,1,"PAH",1,1,9,0)
    NAME:     Xxxxxxx,Xxxxxxx
"PKG",220,22,1,"PAH",1,1,10,0)
    ID:       XXX-XX-XXXX
"PKG",220,22,1,"PAH",1,1,11,0)
    ERROR:    Means Test of NOV 28,2002 not in DHCP.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
9
"RTN","IVM2071A")
0^4^B30985074
"RTN","IVM2071A",1,0)
IVM2071A ;ALB/RMM - Means Test Cleanup Utility ; 23 DEC 2002
"RTN","IVM2071A",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**71**;21-OCT-94
"RTN","IVM2071A",3,0)
 ;
"RTN","IVM2071A",4,0)
 ; This Distribution/Cleanup will check every record in the Patient
"RTN","IVM2071A",5,0)
 ; File #2, for a corresponding entry in the Annual Means Test File
"RTN","IVM2071A",6,0)
 ; #408.31.
"RTN","IVM2071A",7,0)
 ;
"RTN","IVM2071A",8,0)
 ; An IVM Financial Query (QRY) Message will be sent when the veteran's
"RTN","IVM2071A",9,0)
 ; Income Test meets the following criteria:
"RTN","IVM2071A",10,0)
 ;     There must be a current Primary Test (no earlier than income 
"RTN","IVM2071A",11,0)
 ;       year 2001)
"RTN","IVM2071A",12,0)
 ;     The test must have been entered early (before the CAD)
"RTN","IVM2071A",13,0)
 ;     There must have been a similar test in the previous income year
"RTN","IVM2071A",14,0)
 ;       (both Means Tests or both Copay Test) or last year had a Copay 
"RTN","IVM2071A",15,0)
 ;       and this year has a Means Test.
"RTN","IVM2071A",16,0)
 ;     The test's status must not have been an improvement over the 
"RTN","IVM2071A",17,0)
 ;        prior income year's test
"RTN","IVM2071A",18,0)
 ;---------------------------------------------------------------------  
"RTN","IVM2071A",19,0)
 ; Temporary Storage/Tracking Global Details:
"RTN","IVM2071A",20,0)
 ;     ^XTMP("IVM71",1) - Number of records processed
"RTN","IVM2071A",21,0)
 ;     ^XTMP("IVM71",2) - Number of queries transmitted
"RTN","IVM2071A",22,0)
 ;---------------------------------------------------------------------  
"RTN","IVM2071A",23,0)
 ;
"RTN","IVM2071A",24,0)
EN ; Begin Processing...
"RTN","IVM2071A",25,0)
 ; Write message to installation device and to INSTALL file (#9.7)
"RTN","IVM2071A",26,0)
 D BMES^XPDUTL("Future MT Distribution/Cleanup")
"RTN","IVM2071A",27,0)
 D MES^XPDUTL("Once the distribution/cleanup has completed, a MailMan ")
"RTN","IVM2071A",28,0)
 D MES^XPDUTL("message will be sent that will report the number of")
"RTN","IVM2071A",29,0)
 D MES^XPDUTL("records, that were changed.")
"RTN","IVM2071A",30,0)
 D BMES^XPDUTL("Beginning cleanup process "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","IVM2071A",31,0)
 ;
"RTN","IVM2071A",32,0)
INIT ;
"RTN","IVM2071A",33,0)
 ; Initialize tracking global (See text above for description)
"RTN","IVM2071A",34,0)
 N X,X1,X2
"RTN","IVM2071A",35,0)
 I '$D(^XTMP("IVM71",0)) D
"RTN","IVM2071A",36,0)
 .S X1=DT,X2=30 D C^%DTC
"RTN","IVM2071A",37,0)
 .S ^XTMP("IVM71",0)=X_"^"_$$DT^XLFDT_"^IVM*2*71 FUTURE MT CLEANUP UPLOAD ERRORS"
"RTN","IVM2071A",38,0)
 .S (^XTMP("IVM71",1),^XTMP("IVM71",2))=0
"RTN","IVM2071A",39,0)
 ;
"RTN","IVM2071A",40,0)
 I $D(^XTMP("IVM71",0)) S (^XTMP("IVM71",1),^XTMP("IVM71",2))=0
"RTN","IVM2071A",41,0)
 ;
"RTN","IVM2071A",42,0)
 ;Task job using TaskMan
"RTN","IVM2071A",43,0)
 N ZTDESC,ZTIO,ZTRTN,ZTSK,ZTDTH
"RTN","IVM2071A",44,0)
 S ZTDTH=$$NOW^XLFDT
"RTN","IVM2071A",45,0)
 S ZTIO="",ZTRTN="EN1^IVM2071A",ZTDESC="IVM*2*71 FUTURE MT CLEANUP UPLOAD ERRORS"
"RTN","IVM2071A",46,0)
 D ^%ZTLOAD
"RTN","IVM2071A",47,0)
 I '$D(ZTSK) D BMES^XPDUTL("Task failed!")
"RTN","IVM2071A",48,0)
 E  D BMES^XPDUTL("Task# "_ZTSK_" queued ")
"RTN","IVM2071A",49,0)
 Q
"RTN","IVM2071A",50,0)
EN1 ; Process Control Body
"RTN","IVM2071A",51,0)
 ;
"RTN","IVM2071A",52,0)
 N DFN,CURMT,LSTMT,TTYPE,LTYPE,CURST,LSTST,CURDT,LSTDT,IMP,PRINYR
"RTN","IVM2071A",53,0)
 S DFN=0 F  S DFN=$O(^DPT(DFN)) Q:'DFN  D
"RTN","IVM2071A",54,0)
 .;
"RTN","IVM2071A",55,0)
 .; If there is no Primary in this income year (or 2001), Quit
"RTN","IVM2071A",56,0)
 .S CURMT="",TTYPE=1,CURMT=$$LST^DGMTU(DFN,,TTYPE)
"RTN","IVM2071A",57,0)
 .S:'CURMT TTYPE=2,CURMT=$$LST^DGMTU(DFN,,TTYPE)
"RTN","IVM2071A",58,0)
 .I $E($P(CURMT,U,2),1,3)<301 Q
"RTN","IVM2071A",59,0)
 .S ^XTMP("IVM71",1)=^XTMP("IVM71",1)+1
"RTN","IVM2071A",60,0)
 .;
"RTN","IVM2071A",61,0)
 .; If there is no test for the Prior Income Year, Quit
"RTN","IVM2071A",62,0)
 .S PRINYR=($E($P(CURMT,U,2),1,3)-1)_1231
"RTN","IVM2071A",63,0)
 .S LSTMT="",LTYPE=1,LSTMT=$$LST^DGMTU(DFN,PRINYR,LTYPE)
"RTN","IVM2071A",64,0)
 .S:'LSTMT LTYPE=2,LSTMT=$$LST^DGMTU(DFN,PRINYR,LTYPE)
"RTN","IVM2071A",65,0)
 .Q:'LSTMT
"RTN","IVM2071A",66,0)
 .;
"RTN","IVM2071A",67,0)
 .; If this years test wasn't entered early, Quit
"RTN","IVM2071A",68,0)
 .I ($E($P(CURMT,U,2),4,7)+1)>($E($P(LSTMT,U,2),4,7)) Q
"RTN","IVM2071A",69,0)
 .;
"RTN","IVM2071A",70,0)
 .; If this year's test was a CP and last year's test was a MT, Quit 
"RTN","IVM2071A",71,0)
 .I TTYPE=2,LTYPE=1 Q
"RTN","IVM2071A",72,0)
 .;
"RTN","IVM2071A",73,0)
 .; If the Income Test's status was improved, Quit
"RTN","IVM2071A",74,0)
 .S CURST=$P(CURMT,U,4),LSTST=$P(LSTMT,U,4),IMP=1
"RTN","IVM2071A",75,0)
 .I TTYPE=LTYPE D
"RTN","IVM2071A",76,0)
 ..I CURST=LSTST S IMP=0 Q
"RTN","IVM2071A",77,0)
 ..I TTYPE=1,CURST="C",LSTST="A" S IMP=0 Q
"RTN","IVM2071A",78,0)
 ..I TTYPE=1,CURST="G",LSTST="A" S IMP=0 Q
"RTN","IVM2071A",79,0)
 ..I TTYPE=1,CURST="C",LSTST="G" S IMP=0 Q
"RTN","IVM2071A",80,0)
 ..I TTYPE=2,CURST="M",LSTST="E" S IMP=0 Q
"RTN","IVM2071A",81,0)
 .;
"RTN","IVM2071A",82,0)
 .Q:IMP
"RTN","IVM2071A",83,0)
 .;
"RTN","IVM2071A",84,0)
 .; The test met the criteria, send Query to HEC and increment counter
"RTN","IVM2071A",85,0)
 .I $$QUERY(DFN) S ^XTMP("IVM71",2)=^XTMP("IVM71",2)+1
"RTN","IVM2071A",86,0)
 .;
"RTN","IVM2071A",87,0)
 ;
"RTN","IVM2071A",88,0)
 ; Send a mailman msg to the user with the results
"RTN","IVM2071A",89,0)
 D MAIL^IVM2071M
"RTN","IVM2071A",90,0)
 D MES^XPDUTL(" >>Distribution/Cleanup process completed: "_$$FMTE^XLFDT($$NOW^XLFDT))
"RTN","IVM2071A",91,0)
 ;
"RTN","IVM2071A",92,0)
 Q
"RTN","IVM2071A",93,0)
 ;
"RTN","IVM2071A",94,0)
QUERY(DFN) ;
"RTN","IVM2071A",95,0)
 N SUCCESS,DATA,IVMIEN,IVMPAT,IVMCID,DGENDA,USER,NOTIFY,OPTION,ERROR
"RTN","IVM2071A",96,0)
 N HLMTN,HLDAP,HLEID,HL,HLERR,HLEVN,HLSDT,HLARYTYP,HLFORMAT,HLRESLT,HLFS
"RTN","IVM2071A",97,0)
 ;
"RTN","IVM2071A",98,0)
 ; Adding an entry in the IVM FINANCIAL QUERY LOG
"RTN","IVM2071A",99,0)
 S SUCCESS=0,DATA(.01)=DFN,DATA(.02)=$$NOW^XLFDT
"RTN","IVM2071A",100,0)
 S IVMIEN=$$ADD^DGENDBS(301.62,,.DATA)
"RTN","IVM2071A",101,0)
 K DATA,^TMP("HLS",$J)
"RTN","IVM2071A",102,0)
 ;
"RTN","IVM2071A",103,0)
 ; Initialize the HL7 Variables
"RTN","IVM2071A",104,0)
 S HLMTN="QRY",HLDAP="IVM"
"RTN","IVM2071A",105,0)
 S HLEID="VAMC "_$P($$SITE^VASITE,"^",3)_" QRY-Z10 SERVER"
"RTN","IVM2071A",106,0)
 S HLEID=$O(^ORD(101,"B",HLEID,0))
"RTN","IVM2071A",107,0)
 D INIT^HLFNC2(HLEID,.HL)
"RTN","IVM2071A",108,0)
 I $G(HL)]"" S HLERR=$P(HL,"^",2)
"RTN","IVM2071A",109,0)
 S HLEVN=0,HLSDT=$$NOW^XLFDT
"RTN","IVM2071A",110,0)
 I $D(HLERR) S ERROR="HL7 INITIALIZATION ERROR - "_HLERR G QUERYQ
"RTN","IVM2071A",111,0)
 ;
"RTN","IVM2071A",112,0)
 ; Get the Patient Identifiers
"RTN","IVM2071A",113,0)
 I '$$GETPAT^IVMUFNC(DFN,.IVMPAT) S ERROR="PATIENT NOT FOUND" G QUERYQ
"RTN","IVM2071A",114,0)
 I (IVMPAT("DOB")="") S ERROR="PATIENT DATE OF BIRTH IS REQUIRED" G QUERYQ
"RTN","IVM2071A",115,0)
 I (IVMPAT("SSN")="") S ERROR="PATIENT SSN IS REQUIRED" G QUERYQ
"RTN","IVM2071A",116,0)
 I (IVMPAT("SEX")="") S ERROR="PATIENT SEX IS REQUIRED" G QUERYQ
"RTN","IVM2071A",117,0)
 I "MF"'[IVMPAT("SEX") S ERROR="PATIENT SEX IS NOT VALID" G QUERYQ
"RTN","IVM2071A",118,0)
 ;
"RTN","IVM2071A",119,0)
 ; Build HL7 Financial Query (QRY) Message Components...
"RTN","IVM2071A",120,0)
 D QRD,QRF
"RTN","IVM2071A",121,0)
 ;
"RTN","IVM2071A",122,0)
 ; Send the HL7 Financial Query (QRY) Message...
"RTN","IVM2071A",123,0)
 S HLARYTYP="GM",HLFORMAT=1
"RTN","IVM2071A",124,0)
 D GENERATE^HLMA(HLEID,HLARYTYP,HLFORMAT,.HLRESLT)
"RTN","IVM2071A",125,0)
 I $P($G(HLRESLT),"^",2)]"" S HLERR=$P(HLRESLT,"^",3)
"RTN","IVM2071A",126,0)
 I $D(HLERR) S ERROR="HL7 TRANSMISSION ERROR - "_HLERR G QUERYQ
"RTN","IVM2071A",127,0)
 S IVMCID=+HLRESLT
"RTN","IVM2071A",128,0)
 ;
"RTN","IVM2071A",129,0)
 ; Update the Record in the LOG file...
"RTN","IVM2071A",130,0)
 S DGENDA=IVMIEN,DATA(.03)=0,DATA(.04)=$G(USER),DATA(.05)=IVMCID
"RTN","IVM2071A",131,0)
 S DATA(.06)="",DATA(.07)=$G(OPTION),DATA(.08)=$S($G(NOTIFY):1,1:0)
"RTN","IVM2071A",132,0)
 I '$$UPD^DGENDBS(301.62,.DGENDA,.DATA) S ERROR="UPDATE OF RECORD "_IVMIEN_" IN 301.62 FAILED!" G QUERYQ
"RTN","IVM2071A",133,0)
 S SUCCESS=1
"RTN","IVM2071A",134,0)
QUERYQ ; exit and clean-up
"RTN","IVM2071A",135,0)
 D KILL^HLTRANS
"RTN","IVM2071A",136,0)
 K ^TMP("HLS",$J)
"RTN","IVM2071A",137,0)
 Q SUCCESS
"RTN","IVM2071A",138,0)
 ;
"RTN","IVM2071A",139,0)
QRD ; Build (HL7) QRD segment for patient
"RTN","IVM2071A",140,0)
 N IVMQRD
"RTN","IVM2071A",141,0)
 S $P(IVMQRD,HLFS,1)=$$HLDATE^HLFNC(HLSDT),$P(IVMQRD,HLFS,2)="R"
"RTN","IVM2071A",142,0)
 S $P(IVMQRD,HLFS,3)="I",$P(IVMQRD,HLFS,4)=DFN,$P(IVMQRD,HLFS,7)="1~RD"
"RTN","IVM2071A",143,0)
 S $P(IVMQRD,HLFS,8)=IVMPAT("SSN"),$P(IVMQRD,HLFS,9)="FIN"
"RTN","IVM2071A",144,0)
 S $P(IVMQRD,HLFS,10)=$$HLDATE^HLFNC($$LYR^DGMTSCU1(DT)),$P(IVMQRD,HLFS,12)="T"
"RTN","IVM2071A",145,0)
 S ^TMP("HLS",$J,1)="QRD"_HLFS_IVMQRD
"RTN","IVM2071A",146,0)
 Q
"RTN","IVM2071A",147,0)
 ;
"RTN","IVM2071A",148,0)
QRF ; Build HL7 (QRF) segment for patient
"RTN","IVM2071A",149,0)
 N IVMQRF
"RTN","IVM2071A",150,0)
 S $P(IVMQRF,HLFS,1)="IVM"
"RTN","IVM2071A",151,0)
 S $P(IVMQRF,HLFS,4)=$$HLDATE^HLFNC(IVMPAT("DOB"))
"RTN","IVM2071A",152,0)
 S $P(IVMQRF,HLFS,5)=IVMPAT("SEX")
"RTN","IVM2071A",153,0)
 S ^TMP("HLS",$J,2)="QRF"_HLFS_IVMQRF
"RTN","IVM2071A",154,0)
 Q
"RTN","IVM2071M")
0^5^B3788857
"RTN","IVM2071M",1,0)
IVM2071M ;ALB/RMM MT Cleanup Mailman Msg ; 23 DEC 2002
"RTN","IVM2071M",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**71**;21-OCT-94
"RTN","IVM2071M",3,0)
 ;
"RTN","IVM2071M",4,0)
 ; A MailMan message will be sent to the user when the cleanup process
"RTN","IVM2071M",5,0)
 ; is complete.
"RTN","IVM2071M",6,0)
 ;
"RTN","IVM2071M",7,0)
 ;
"RTN","IVM2071M",8,0)
MAIL ; Send a mailman msg to user with results
"RTN","IVM2071M",9,0)
 N DIFROM,NODE,MSG,XMDUZ,XMSUB,XMTEXT,XMY
"RTN","IVM2071M",10,0)
 S XMSUB="Future Dated MT Distribution/Cleanup"
"RTN","IVM2071M",11,0)
 S XMDUZ="IVM*2.0*71 Distribution/Cleanup",XMY(DUZ)=""
"RTN","IVM2071M",12,0)
 S XMY("richard.muller@med.va.gov")=""
"RTN","IVM2071M",13,0)
 S XMTEXT="MSG(",NODE=0
"RTN","IVM2071M",14,0)
 S NODE=NODE+1,MSG(NODE)="Income Test Data (Z10) transmissions may not have"
"RTN","IVM2071M",15,0)
 S NODE=NODE+1,MSG(NODE)="been successfully received/uploaded for Income Tests"
"RTN","IVM2071M",16,0)
 S NODE=NODE+1,MSG(NODE)="where the effective date of the test has been updated"
"RTN","IVM2071M",17,0)
 S NODE=NODE+1,MSG(NODE)="at the HEC."
"RTN","IVM2071M",18,0)
 S NODE=NODE+1,MSG(NODE)=""
"RTN","IVM2071M",19,0)
 S NODE=NODE+1,MSG(NODE)="An IVM FINANCIAL QUERY has been transmitted to the HEC"
"RTN","IVM2071M",20,0)
 S NODE=NODE+1,MSG(NODE)="for each of these records."
"RTN","IVM2071M",21,0)
 S NODE=NODE+1,MSG(NODE)=""
"RTN","IVM2071M",22,0)
 S NODE=NODE+1,MSG(NODE)=$$REPEAT^XLFSTR("=",50)
"RTN","IVM2071M",23,0)
 S NODE=NODE+1,MSG(NODE)="Number of records processed:   "_$$RJ^XLFSTR(+$G(^XTMP("IVM71",1)),12)
"RTN","IVM2071M",24,0)
 S NODE=NODE+1,MSG(NODE)="Number of queries transmitted: "_$$RJ^XLFSTR(+$G(^XTMP("IVM71",2)),12)
"RTN","IVM2071M",25,0)
 S NODE=NODE+1,MSG(NODE)=$$REPEAT^XLFSTR("=",50)
"RTN","IVM2071M",26,0)
 S NODE=NODE+1,MSG(NODE)=""
"RTN","IVM2071M",27,0)
 ;
"RTN","IVM2071M",28,0)
 D ^XMD
"RTN","IVM2071M",29,0)
 ;
"RTN","IVM2071M",30,0)
 Q
"RTN","IVMCM1")
0^3^B34913494
"RTN","IVMCM1",1,0)
IVMCM1 ;ALB/SEK,BRM - DCD INCOME TESTS UPLOAD DRIVER ; 1/24/03
"RTN","IVMCM1",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**17,49,71**;21-OCT-94
"RTN","IVMCM1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMCM1",4,0)
 ;
"RTN","IVMCM1",5,0)
EN ; this routine will call routines to upload means/copay/LTC test and
"RTN","IVMCM1",6,0)
 ; income screening sent by the IVM Center (DCD).  the calling routine
"RTN","IVMCM1",7,0)
 ; validated segment sequence.  entries will be added/modified in the
"RTN","IVMCM1",8,0)
 ; following means test and patient files:
"RTN","IVMCM1",9,0)
 ;
"RTN","IVMCM1",10,0)
 ;       PATIENT RELATION (#408.12)
"RTN","IVMCM1",11,0)
 ;       INCOME PERSON (#408.13)
"RTN","IVMCM1",12,0)
 ;       INDIVIDUAL ANNUAL INCOME (#408.21)
"RTN","IVMCM1",13,0)
 ;       INCOME RELATION (#408.22)
"RTN","IVMCM1",14,0)
 ;       ANNUAL MEANS TEST (#408.31)
"RTN","IVMCM1",15,0)
 ;       MEANS TEST CHANGES (#408.41)
"RTN","IVMCM1",16,0)
 ;       PATIENT (#2)
"RTN","IVMCM1",17,0)
 ;
"RTN","IVMCM1",18,0)
 ; input:
"RTN","IVMCM1",19,0)
 ;
"RTN","IVMCM1",20,0)
 ; IVMTYPE test type 1-means 2-copay 3-income screening 4-LTC
"RTN","IVMCM1",21,0)
 ; IVMMTIEN IEN of replaced test (408.31)
"RTN","IVMCM1",22,0)
 ; IVMFLGC  # of dependent children
"RTN","IVMCM1",23,0)
 ; IVMMTDT  dt of test
"RTN","IVMCM1",24,0)
 ; DGLY income year
"RTN","IVMCM1",25,0)
 ;
"RTN","IVMCM1",26,0)
 ; ^TMP($J,"IVMCM",  contains data sent by IVM Center
"RTN","IVMCM1",27,0)
 ;   3rd node "PIDV"
"RTN","IVMCM1",28,0)
 ;            "ZICV"
"RTN","IVMCM1",29,0)
 ;            "ZIRV"
"RTN","IVMCM1",30,0)
 ;            "ZDPS"
"RTN","IVMCM1",31,0)
 ;            "ZICS"
"RTN","IVMCM1",32,0)
 ;            "ZIRS"
"RTN","IVMCM1",33,0)
 ;           {"ZDPC",N
"RTN","IVMCM1",34,0)
 ;            "ZICC",N
"RTN","IVMCM1",35,0)
 ;            "ZIRC",N
"RTN","IVMCM1",36,0)
 ;           }
"RTN","IVMCM1",37,0)
 ;            "ZMT1"
"RTN","IVMCM1",38,0)
 ;            "ZMT2"
"RTN","IVMCM1",39,0)
 ;            "ZMT4"
"RTN","IVMCM1",40,0)
 ;            "ZBT"  
"RTN","IVMCM1",41,0)
 ;
"RTN","IVMCM1",42,0)
 S:'$D(DUZ) DUZ=.5
"RTN","IVMCM1",43,0)
 ;
"RTN","IVMCM1",44,0)
 ; subscript of array IVMAR is 408.12 ien transmitted by IVM Center
"RTN","IVMCM1",45,0)
 ; or created by upload. IVMAR2 is the array used to check for dup SSNs
"RTN","IVMCM1",46,0)
 K IVMAR,IVMAR2
"RTN","IVMCM1",47,0)
 ;
"RTN","IVMCM1",48,0)
 ; New Edit Checks
"RTN","IVMCM1",49,0)
 N IVMERR,OK2UPLD S IVMERR="",OK2UPLD=1
"RTN","IVMCM1",50,0)
 D EN^IVMCMF(.IVMERR),PROB^IVMCMFB(,.IVMERR,0) Q:'OK2UPLD
"RTN","IVMCM1",51,0)
 ;
"RTN","IVMCM1",52,0)
 ; IVMHADJ indicates means test hardship/adjudication
"RTN","IVMCM1",53,0)
 ; 1-adj 2-hardship 3-pending adj 0-not adj/hard
"RTN","IVMCM1",54,0)
 I IVMTYPE=1 D
"RTN","IVMCM1",55,0)
 .S IVMSEG=$G(^TMP($J,"IVMCM","ZMT1"))
"RTN","IVMCM1",56,0)
 .S IVMHADJ=$S($P(IVMSEG,"^",13):2,$P(IVMSEG,"^",6)]"":1,$P(IVMSEG,"^",3)="P":3,1:0)
"RTN","IVMCM1",57,0)
 ;
"RTN","IVMCM1",58,0)
 S:IVMTYPE=3 DGMTI=""
"RTN","IVMCM1",59,0)
 ;
"RTN","IVMCM1",60,0)
 ; add new annual means test file (408.31) stub for Means test,
"RTN","IVMCM1",61,0)
 ; RX Copay test, or Long Term Care test
"RTN","IVMCM1",62,0)
 I "^1^2^4^"[("^"_IVMTYPE_"^") D
"RTN","IVMCM1",63,0)
 .;
"RTN","IVMCM1",64,0)
 .; input   DGMTDT (.01) dt of test
"RTN","IVMCM1",65,0)
 .;         DFN (.02) Patient IEN
"RTN","IVMCM1",66,0)
 .;         DGMTYPT (.19) type of test
"RTN","IVMCM1",67,0)
 .; output  DGMTI annual means test IEN
"RTN","IVMCM1",68,0)
 .S DGMTDT=IVMMTDT,DGMTYPT=IVMTYPE
"RTN","IVMCM1",69,0)
 .D ADD^DGMTA
"RTN","IVMCM1",70,0)
 .;
"RTN","IVMCM1",71,0)
 .; change primary income test for year?
"RTN","IVMCM1",72,0)
 .S DA=DGMTI,DIE="^DGMT(408.31,",DR="2////0"
"RTN","IVMCM1",73,0)
 .D ^DIE K DA,DIE,DR
"RTN","IVMCM1",74,0)
 ;
"RTN","IVMCM1",75,0)
 D NEWVET^IVMCM3 Q:$D(IVMFERR)  ; if no entry in patient relation file for vet add
"RTN","IVMCM1",76,0)
 ;
"RTN","IVMCM1",77,0)
 ; get patient relation ien (#408.12) for vet, spouse, & child
"RTN","IVMCM1",78,0)
 S IVMREQU=$P($G(^DG(408.32,+$P($G(^DGMT(408.31,IVMMTIEN,0)),"^",3),0)),"^",2)
"RTN","IVMCM1",79,0)
 D GETREL^DGMTU11(DFN,"VSC",DGLY,$S($G(IVMMTIEN)&(IVMREQU'="R"):IVMMTIEN,1:0))
"RTN","IVMCM1",80,0)
 ;
"RTN","IVMCM1",81,0)
 ; add dependent(s) to income person file (408.13)
"RTN","IVMCM1",82,0)
 ;
"RTN","IVMCM1",83,0)
 ; add spouse if not in 408.13
"RTN","IVMCM1",84,0)
 S IVMSPCHV="S" ; spouse/child/vet indicator
"RTN","IVMCM1",85,0)
 S IVMSEG=$G(^TMP($J,"IVMCM","ZDPS")) ; spouse ZDP segment
"RTN","IVMCM1",86,0)
 D INPIEN^IVMCM2
"RTN","IVMCM1",87,0)
 Q:$D(IVMFERR)
"RTN","IVMCM1",88,0)
 ;
"RTN","IVMCM1",89,0)
 I IVMFLG5 G ADDCHILD ; entry not added - goto add children
"RTN","IVMCM1",90,0)
 ;
"RTN","IVMCM1",91,0)
 ; add entry to patient relation file (408.12)
"RTN","IVMCM1",92,0)
 D EN^IVMCM3
"RTN","IVMCM1",93,0)
 Q:$D(IVMFERR)
"RTN","IVMCM1",94,0)
 ;
"RTN","IVMCM1",95,0)
ADDS21 ; add spouse entry to individual annual income file (408.21)
"RTN","IVMCM1",96,0)
 S IVMSEG=$G(^TMP($J,"IVMCM","ZICS")) ; spouse ZIC segment
"RTN","IVMCM1",97,0)
 D EN^IVMCM4
"RTN","IVMCM1",98,0)
 Q:$D(IVMFERR)
"RTN","IVMCM1",99,0)
 ;
"RTN","IVMCM1",100,0)
 ; add spouse entry to income relation file (408.22)
"RTN","IVMCM1",101,0)
 S IVMSEG=$G(^TMP($J,"IVMCM","ZIRS")) ; spouse ZIR segment
"RTN","IVMCM1",102,0)
 D EN^IVMCM5
"RTN","IVMCM1",103,0)
 Q:$D(IVMFERR)
"RTN","IVMCM1",104,0)
 ;
"RTN","IVMCM1",105,0)
ADDCHILD ; add children if not in 408.13
"RTN","IVMCM1",106,0)
 S IVMSPCHV="C" ; spouse/child/vet indicator
"RTN","IVMCM1",107,0)
 I 'IVMFLGC G ADDV21 ; no dependent children 
"RTN","IVMCM1",108,0)
 F IVMCTR3=1:1:IVMFLGC D  Q:$D(IVMFERR)
"RTN","IVMCM1",109,0)
 .S IVMSEG=$G(^TMP($J,"IVMCM","ZDPC",IVMCTR3)) ; child ZDP segment
"RTN","IVMCM1",110,0)
 .D INPIEN^IVMCM2
"RTN","IVMCM1",111,0)
 .Q:$D(IVMFERR)
"RTN","IVMCM1",112,0)
 .;
"RTN","IVMCM1",113,0)
 .; add child entry to patient relation file (408.12)
"RTN","IVMCM1",114,0)
 .D EN^IVMCM3
"RTN","IVMCM1",115,0)
 .Q:$D(IVMFERR)
"RTN","IVMCM1",116,0)
 .;
"RTN","IVMCM1",117,0)
ADDC21 .; add child entry to individual annual income file (408.21)
"RTN","IVMCM1",118,0)
 .S IVMSEG=$G(^TMP($J,"IVMCM","ZICC",IVMCTR3)) ; child ZIC segment
"RTN","IVMCM1",119,0)
 .D EN^IVMCM4
"RTN","IVMCM1",120,0)
 .Q:$D(IVMFERR)
"RTN","IVMCM1",121,0)
 .;
"RTN","IVMCM1",122,0)
 .; add entry to income relation file (408.22)
"RTN","IVMCM1",123,0)
 .S IVMSEG=$G(^TMP($J,"IVMCM","ZIRC",IVMCTR3)) ; child ZIR segment
"RTN","IVMCM1",124,0)
 .D EN^IVMCM5
"RTN","IVMCM1",125,0)
 .Q:$D(IVMFERR)
"RTN","IVMCM1",126,0)
 .Q
"RTN","IVMCM1",127,0)
 Q:$D(IVMFERR)
"RTN","IVMCM1",128,0)
 ;
"RTN","IVMCM1",129,0)
ADDV21 ; add vet entry to individual annual income file (408.21)
"RTN","IVMCM1",130,0)
 ; get vet patient relation ien
"RTN","IVMCM1",131,0)
 S DGPRI=+$G(DGREL("V"))
"RTN","IVMCM1",132,0)
 S IVMSEG=$G(^TMP($J,"IVMCM","ZICV")) ; vet ZIC segment
"RTN","IVMCM1",133,0)
 S IVMSPCHV="V" ; spouse/child/vet indicator
"RTN","IVMCM1",134,0)
 D EN^IVMCM4
"RTN","IVMCM1",135,0)
 Q:$D(IVMFERR)
"RTN","IVMCM1",136,0)
 S DGVINI=DGINI ; vet individual annual income ien
"RTN","IVMCM1",137,0)
 ;
"RTN","IVMCM1",138,0)
 ; add vet entry to income relation file (408.22)
"RTN","IVMCM1",139,0)
 S IVMSEG=$G(^TMP($J,"IVMCM","ZIRV")) ; vet ZIR segment
"RTN","IVMCM1",140,0)
 D EN^IVMCM5
"RTN","IVMCM1",141,0)
 Q:$D(IVMFERR)
"RTN","IVMCM1",142,0)
 S DGVIRI=DGIRI ; vet income relation ien
"RTN","IVMCM1",143,0)
 ;
"RTN","IVMCM1",144,0)
COMPLETE ; complete means test, copay test, or Long Term Care test
"RTN","IVMCM1",145,0)
 ;
"RTN","IVMCM1",146,0)
 D EN^IVMCM6
"RTN","IVMCM1",147,0)
 ;
"RTN","IVMCM1",148,0)
 ; cleanup
"RTN","IVMCM1",149,0)
 K DGINI,DGIRI,DGMTDT,DGMTI,DGMTYPT,DGPRI,DGREL,DGVINI,DGVIRI
"RTN","IVMCM1",150,0)
 K IVMAR,IVMCEB,IVMCTR3,IVMFERR,IVMFLG1
"RTN","IVMCM1",151,0)
 K IVMFLG2,IVMFLG5,IVMHADJ,IVMMTB,IVMPRN
"RTN","IVMCM1",152,0)
 K IVMRELN,IVMRELO,IVMREQU,IVMSEG,IVMSPCHV,IVMX
"RTN","IVMCM1",153,0)
 Q
"RTN","IVMCM1",154,0)
 ;
"RTN","IVMCM1",155,0)
LTC ; transmission contains a long term care test (type 4)
"RTN","IVMCM1",156,0)
 ;
"RTN","IVMCM1",157,0)
 Q:'$P($G(^TMP($J,"IVMCM","ZMT4")),HLFS,2)
"RTN","IVMCM1",158,0)
 I "^1^2^"[("^"_$G(IVMTYPE)_"^") N IVMTYPE
"RTN","IVMCM1",159,0)
 S IVMTYPE=4,IVMFUTR=0
"RTN","IVMCM1",160,0)
 S IVMMTDT=$$FMDATE^HLFNC($P($G(^TMP($J,"IVMCM","ZMT4")),HLFS,2))
"RTN","IVMCM1",161,0)
 S TMSTAMP=$$FMDATE^HLFNC($P($G(^TMP($J,"IVMCM","ZMT4")),HLFS,25))
"RTN","IVMCM1",162,0)
 S SOURCE=$P($G(^TMP($J,"IVMCM","ZMT4")),HLFS,22)
"RTN","IVMCM1",163,0)
 S IVMLAST=$$LST^DGMTU(DFN,$E(IVMMTDT,1,3)_1231,4)
"RTN","IVMCM1",164,0)
 S IVMMTIEN=+IVMLAST  ;last LTC test
"RTN","IVMCM1",165,0)
 ;deletion indicator sent?
"RTN","IVMCM1",166,0)
 I $P($G(^TMP($J,"IVMCM","ZMT4")),HLFS,3)=HLQ D  Q
"RTN","IVMCM1",167,0)
 .Q:('IVMMTIEN)
"RTN","IVMCM1",168,0)
 .S NODE0=$G(^DGMT(408.31,IVMMTIEN,0))
"RTN","IVMCM1",169,0)
 .I $$EN^IVMCMD(IVMMTIEN) D
"RTN","IVMCM1",170,0)
 ..S RET=$$LST^DGMTU(DFN,DT,IVMTYPE)
"RTN","IVMCM1",171,0)
 ..S CODE=$S(($E($P(RET,"^",2),1,3)=$E(DT,1,3)):$P(RET,"^",4),1:"")
"RTN","IVMCM1",172,0)
 ..D ADD^IVMCMB(DFN,IVMTYPE,"DELETE LONG TERM CARE TEST",+$G(NODE0),$$GETCODE^DGMTH($P(NODE0,"^",3)),CODE)
"RTN","IVMCM1",173,0)
 ;
"RTN","IVMCM1",174,0)
 ;check date/time last edited, test date and source - if they match current test then this is a duplicate and does not need to be uploaded
"RTN","IVMCM1",175,0)
 N NODE0,NODE2
"RTN","IVMCM1",176,0)
 S NODE2=$G(^DGMT(408.31,IVMMTIEN,2)),NODE0=$G(^(0))
"RTN","IVMCM1",177,0)
 I TMSTAMP,TMSTAMP=$P(NODE2,"^",2),IVMMTDT=$P(NODE0,"^"),SOURCE=$P(NODE2,"^",5) Q
"RTN","IVMCM1",178,0)
 ;
"RTN","IVMCM1",179,0)
 D DELTYPE^IVMCMD(DFN,IVMMTDT,4)
"RTN","IVMCM1",180,0)
 I $P($G(^TMP($J,"IVMCM","ZMT1")),HLFS,2)!($P($G(^TMP($J,"IVMCM","ZMT2")),HLFS,2)) D  Q
"RTN","IVMCM1",181,0)
 .S DGMTDT=IVMMTDT,DGMTYPT=IVMTYPE
"RTN","IVMCM1",182,0)
 .D ADD^DGMTA
"RTN","IVMCM1",183,0)
 .D COMPLETE^IVMCM1
"RTN","IVMCM1",184,0)
 D EN^IVMCM1
"RTN","IVMCM1",185,0)
 Q
"RTN","IVMCMF")
0^6^B7737872
"RTN","IVMCMF",1,0)
IVMCMF ;ALB/RMM - INCOME TEST EDIT CHECK DRIVER ; 01/02/03 10:22am
"RTN","IVMCMF",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**71**;21-OCT-94
"RTN","IVMCMF",3,0)
 ;
"RTN","IVMCMF",4,0)
 ; This routine will perform edit checks to validate income tests which
"RTN","IVMCMF",5,0)
 ; are transmitted to VistA from the IVM Center. Any errors will be 
"RTN","IVMCMF",6,0)
 ; recorded and will be added to the record in the ANNUAL MEANS TEST 
"RTN","IVMCMF",7,0)
 ; File #408.31.
"RTN","IVMCMF",8,0)
 ;
"RTN","IVMCMF",9,0)
 ; This routine is called from IVMCM1.
"RTN","IVMCMF",10,0)
 ;
"RTN","IVMCMF",11,0)
 ; Required Input:
"RTN","IVMCMF",12,0)
 ;   The global array ^TMP($J,"IVMCM" which contains the income test
"RTN","IVMCMF",13,0)
 ;   The local variable IVMTYPE, which may be:
"RTN","IVMCMF",14,0)
 ;       1 - Means Test
"RTN","IVMCMF",15,0)
 ;       2 - Copay Test
"RTN","IVMCMF",16,0)
 ;       3 - Income Screening information only
"RTN","IVMCMF",17,0)
 ;       4 - Long Term Care Test
"RTN","IVMCMF",18,0)
 ;
"RTN","IVMCMF",19,0)
 ; Output:
"RTN","IVMCMF",20,0)
 ;   Array IVMERR as a list of error condition(s) found (free text)
"RTN","IVMCMF",21,0)
 ;
"RTN","IVMCMF",22,0)
EN(IVMERR) ; Entry point to begin edit checks.
"RTN","IVMCMF",23,0)
 ;
"RTN","IVMCMF",24,0)
 N ARRAY,DEP,I,IEN,SPOUSE,STRING,TYPE,X,CNT
"RTN","IVMCMF",25,0)
 S CNT=1
"RTN","IVMCMF",26,0)
 I +$G(IVMTYPE)'>0 S CNT=CNT+1,IVMERR(CNT)="Income Test Type not Specified"
"RTN","IVMCMF",27,0)
 ;
"RTN","IVMCMF",28,0)
 ; Build strings for the veteran
"RTN","IVMCMF",29,0)
 S SPOUSE=0,DEP=1
"RTN","IVMCMF",30,0)
 S ARRAY("PID")=$$CLEAR($G(^TMP($J,"IVMCM","PIDV")))
"RTN","IVMCMF",31,0)
 S ARRAY("ZIC")=$$CLEAR($G(^TMP($J,"IVMCM","ZICV"))),$P(ARRAY("ZIC"),HLFS,21)=$$TOTAL^IVMCME(ARRAY("ZIC"))
"RTN","IVMCMF",32,0)
 S ARRAY("ZIR")=$$CLEAR($G(^TMP($J,"IVMCM","ZIRV")))
"RTN","IVMCMF",33,0)
 ;
"RTN","IVMCMF",34,0)
 ; Build strings for spouse as dependent
"RTN","IVMCMF",35,0)
 S ARRAY(DEP,"ZDP")=$$CLEAR($G(^TMP($J,"IVMCM","ZDPS")))
"RTN","IVMCMF",36,0)
 S ARRAY(DEP,"ZIC")=$$CLEAR($G(^TMP($J,"IVMCM","ZICS")))
"RTN","IVMCMF",37,0)
 S ARRAY(DEP,"ZIR")=$$CLEAR($G(^TMP($J,"IVMCM","ZIRS")))
"RTN","IVMCMF",38,0)
 D ADJ^IVMCME
"RTN","IVMCMF",39,0)
 ;
"RTN","IVMCMF",40,0)
 ; Build strings for children as dependents
"RTN","IVMCMF",41,0)
 S IEN=0 F  S IEN=$O(^TMP($J,"IVMCM","ZDPC",IEN)) Q:'IEN  D
"RTN","IVMCMF",42,0)
 . S DEP=DEP+1
"RTN","IVMCMF",43,0)
 . S ARRAY(DEP,"ZDP")=$$CLEAR($G(^TMP($J,"IVMCM","ZDPC",IEN)))
"RTN","IVMCMF",44,0)
 . S ARRAY(DEP,"ZIC")=$$CLEAR($G(^TMP($J,"IVMCM","ZICC",IEN)))
"RTN","IVMCMF",45,0)
 . S ARRAY(DEP,"ZIR")=$$CLEAR($G(^TMP($J,"IVMCM","ZIRC",IEN)))
"RTN","IVMCMF",46,0)
 . D ADJ^IVMCME
"RTN","IVMCMF",47,0)
 ;
"RTN","IVMCMF",48,0)
 ; - build income test string and check for errors
"RTN","IVMCMF",49,0)
 S ARRAY("ZMT")=$$CLEAR($G(^TMP($J,"IVMCM","ZMT"_IVMTYPE)))
"RTN","IVMCMF",50,0)
 ;
"RTN","IVMCMF",51,0)
 I '$$UPLDOK() S IVMERR(2)="Income Test not Uploaded",OK2UPLD=0 Q
"RTN","IVMCMF",52,0)
 ;
"RTN","IVMCMF",53,0)
 D CHECK
"RTN","IVMCMF",54,0)
ENQ Q
"RTN","IVMCMF",55,0)
 ;
"RTN","IVMCMF",56,0)
CLEAR(NODE) ; Convert HLQ to NULL
"RTN","IVMCMF",57,0)
 N I
"RTN","IVMCMF",58,0)
 F I=1:1:$L(NODE,HLFS) I $P(NODE,HLFS,I)=HLQ S $P(NODE,HLFS,I)=""
"RTN","IVMCMF",59,0)
 Q NODE
"RTN","IVMCMF",60,0)
 ;
"RTN","IVMCMF",61,0)
CHECK ; Check validity of transmission data
"RTN","IVMCMF",62,0)
 N IEN
"RTN","IVMCMF",63,0)
 D ZIC^IVMCMF1(ARRAY("ZIC"))
"RTN","IVMCMF",64,0)
 D ZIR^IVMCMF1(ARRAY("ZIR"))
"RTN","IVMCMF",65,0)
 I "^1^2^4^"[("^"_IVMTYPE_"^") D ZMT^IVMCMF2(ARRAY("ZMT"))
"RTN","IVMCMF",66,0)
 F IEN=0:0 S IEN=$O(ARRAY(IEN)) Q:'IEN  D
"RTN","IVMCMF",67,0)
 . D ZDP^IVMCMF2(ARRAY(IEN,"ZDP"),IEN)
"RTN","IVMCMF",68,0)
 . D ZIC^IVMCMF1(ARRAY(IEN,"ZIC"),IEN)
"RTN","IVMCMF",69,0)
 . D ZIR^IVMCMF1(ARRAY(IEN,"ZIR"),IEN)
"RTN","IVMCMF",70,0)
CHECKQ Q
"RTN","IVMCMF",71,0)
 ;
"RTN","IVMCMF",72,0)
UPLDOK() ; Check if the test is complete and OK to upload
"RTN","IVMCMF",73,0)
 ; Quit if not a valid test type
"RTN","IVMCMF",74,0)
 I "^1^2^3^4^"'[(U_IVMTYPE_U) Q 0
"RTN","IVMCMF",75,0)
 ;
"RTN","IVMCMF",76,0)
 ; Check the Income Test Status
"RTN","IVMCMF",77,0)
 N DGSTAT S DGSTAT=$P(ARRAY("ZMT"),U,3)
"RTN","IVMCMF",78,0)
 I IVMTYPE=1,"^C^A^G^N^P^"'[(U_DGSTAT_U) Q 0
"RTN","IVMCMF",79,0)
 I IVMTYPE=2,"^M^E^L^"'[(U_DGSTAT_U) Q 0
"RTN","IVMCMF",80,0)
 I IVMTYPE=4,"^0^1^"'[(U_DGSTAT_U) Q 0
"RTN","IVMCMF",81,0)
 ;
"RTN","IVMCMF",82,0)
 ; Check if the test has been completed
"RTN","IVMCMF",83,0)
 I IVMTYPE'=3,+$P(ARRAY("ZMT"),U,10)'>0 Q 0
"RTN","IVMCMF",84,0)
 Q 1
"RTN","IVMCMF1")
0^7^B33813451
"RTN","IVMCMF1",1,0)
IVMCMF1 ;ALB/RMM - CHECK ANNUAL INCOME DATA ; 01/02/03 2:19pm
"RTN","IVMCMF1",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**71**;21-OCT-94
"RTN","IVMCMF1",3,0)
 ;
"RTN","IVMCMF1",4,0)
 ; This routine is called from IVMCMF.
"RTN","IVMCMF1",5,0)
 ;
"RTN","IVMCMF1",6,0)
 ;
"RTN","IVMCMF1",7,0)
ZIC(STRING,DEPIEN) ; Check validity of ZIC segment
"RTN","IVMCMF1",8,0)
 ;
"RTN","IVMCMF1",9,0)
 ; Input:  STRING as ZIC segment
"RTN","IVMCMF1",10,0)
 ;         DEPIEN as the IEN of the dependent in the array, if applicable
"RTN","IVMCMF1",11,0)
 ;
"RTN","IVMCMF1",12,0)
 N FLAG,I,X,Y,FND1
"RTN","IVMCMF1",13,0)
 S (FND1,FLAG)=0,X=$P(STRING,HLFS,2)
"RTN","IVMCMF1",14,0)
 I $E(X,1,4)<1992!($E(X,5,8)'="0000") S CNT=CNT+1,IVMERR(CNT)="Invalid Income Year in ZIC"
"RTN","IVMCMF1",15,0)
 F I=3:1:20 I $$NUM^IVMCME2($P(STRING,HLFS,I),7,2) S CNT=CNT+1,IVMERR(CNT)=$P($T(ZICFLD+I),";;",2)_" field content/length error"
"RTN","IVMCMF1",16,0)
 I $G(DEPIEN) D
"RTN","IVMCMF1",17,0)
 . F I=13,14 Q:FND1  I $P(STRING,HLFS,I)>0 S FND1=1,CNT=CNT+1,IVMERR(CNT)="Dependents can't have medical or funeral expenses"
"RTN","IVMCMF1",18,0)
 . I DEPIEN=SPOUSE,($P(STRING,HLFS,15)>0) S CNT=CNT+1,IVMERR(CNT)="No educational expenses for spouse"
"RTN","IVMCMF1",19,0)
 . I DEPIEN'=SPOUSE D
"RTN","IVMCMF1",20,0)
 . . I $P(STRING,HLFS,15)&('$P(ARRAY(DEPIEN,"ZIR"),U,9)) S CNT=CNT+1,IVMERR(CNT)="Dependent Educational Exp. error-income not avail. to vet"
"RTN","IVMCMF1",21,0)
 . . S X=$E($P(STRING,HLFS,2),1,4),FND1=0 D ^%DT S X=Y
"RTN","IVMCMF1",22,0)
 . . I $P(STRING,HLFS,15)>0 S X=$P(^DG(43,1,"MT",X,0),U,17) I X'<$P(STRING,HLFS,9) S CNT=CNT+1,IVMERR(CNT)="Income does not exceed child exclusion amount-educational expense not allowed"
"RTN","IVMCMF1",23,0)
 . . F I=16:1:20 Q:FND1  I +$P(STRING,HLFS,I)>0 S FND1=1,CNT=CNT+1,IVMERR(CNT)="No net worth figures allowed for dependent children" Q
"RTN","IVMCMF1",24,0)
 I $P(STRING,HLFS,20)>$P(STRING,HLFS,19) S CNT=CNT+1,IVMERR(CNT)="Debts can't be greater than Other Property or Assets"
"RTN","IVMCMF1",25,0)
 I '$G(DEPIEN) D
"RTN","IVMCMF1",26,0)
 . I IVMTYPE'=1 Q
"RTN","IVMCMF1",27,0)
 . I $P(ARRAY("ZMT"),HLFS,3)="C" Q
"RTN","IVMCMF1",28,0)
 . S FLAG=0 F I=16:1:20 I $P(STRING,HLFS,I)]"" S FLAG=1 Q
"RTN","IVMCMF1",29,0)
 . I 'FLAG,SPOUSE F I=16:1:20 I $P(ARRAY(SPOUSE,"ZIC"),HLFS,I)]"" S FLAG=1 Q
"RTN","IVMCMF1",30,0)
ZICQ Q
"RTN","IVMCMF1",31,0)
 ;
"RTN","IVMCMF1",32,0)
ZIR(STRING,DEPIEN) ; Check validity of ZIR segment
"RTN","IVMCMF1",33,0)
 ;
"RTN","IVMCMF1",34,0)
 ; Input:  STRING as ZIR segment
"RTN","IVMCMF1",35,0)
 ;         DEPIEN as the IEN of the dependent in the array, if applicable
"RTN","IVMCMF1",36,0)
 ;
"RTN","IVMCMF1",37,0)
 N I,X,FND1
"RTN","IVMCMF1",38,0)
 F I=2,3,5:1:9 D
"RTN","IVMCMF1",39,0)
 . S X=$P(STRING,HLFS,I)
"RTN","IVMCMF1",40,0)
 . I X]"",(X'=0),(X'=1) S CNT=CNT+1,IVMERR(CNT)=$P($T(ZIRFLD+I),";;",2)_" contains unacceptable value"
"RTN","IVMCMF1",41,0)
 I $$NUM^IVMCME2($P(STRING,HLFS,4),5,2) S CNT=CNT+1,IVMERR(CNT)="Invalid number for Amount Contributed to Spouse"
"RTN","IVMCMF1",42,0)
 S X=$P(STRING,HLFS,10) I X]""&((X>30)!(X<0)!(+X'=X)) S CNT=CNT+1,IVMERR(CNT)="Invalid number in Number of Dependent Children field"
"RTN","IVMCMF1",43,0)
 I X]"",(X'=DEP-SPOUSE) S CNT=CNT+1,IVMERR(CNT)="Number of Dependent Children does not match dependents transmitted"
"RTN","IVMCMF1",44,0)
 I '$G(DEPIEN) D
"RTN","IVMCMF1",45,0)
 . I $P(STRING,HLFS,2)']"" S CNT=CNT+1,IVMERR(CNT)="Must have Married Last Calendar Year for veteran"
"RTN","IVMCMF1",46,0)
 . I SPOUSE,'$P(STRING,HLFS,2) S CNT=CNT+1,IVMERR(CNT)="Spouse transmitted, but Married Last Calendar Year is NO"
"RTN","IVMCMF1",47,0)
 . I 'SPOUSE,$P(STRING,HLFS,2)=1 S CNT=CNT+1,IVMERR(CNT)="No spouse transmitted, but Married Last Calendar Year is YES"
"RTN","IVMCMF1",48,0)
 . I '$P(STRING,HLFS,2),(+$P(STRING,HLFS,3)) S CNT=CNT+1,IVMERR(CNT)="Can't have Lived with Patient if not Married"
"RTN","IVMCMF1",49,0)
 . I $P(STRING,HLFS,2)=1,('+$P(STRING,HLFS,3)) S CNT=CNT+1,IVMERR(CNT)="Must have Living with Patient if Married"
"RTN","IVMCMF1",50,0)
 . I $P(STRING,HLFS,3)=1,(+$P(STRING,HLFS,4)>0) S CNT=CNT+1,IVMERR(CNT)="Should not have Amount contributed to spouse if living w/patient"
"RTN","IVMCMF1",51,0)
 . I $P(STRING,HLFS,3)=0,(+$P(STRING,HLFS,4)'>0) S CNT=CNT+1,IVMERR(CNT)="Need amount contributed to spouse if not living w/patient"
"RTN","IVMCMF1",52,0)
 . F I=6:1:9 I $P(STRING,HLFS,I)]"" S CNT=CNT+1,IVMERR(CNT)=$P($T(ZIRFLD+I),";;",2)_" should not be filled in for veteran"
"RTN","IVMCMF1",53,0)
 . I '$P(STRING,HLFS,3),SPOUSE,($P(STRING,HLFS,4)<600) S FND1=0 F I=3:1:20 Q:FND1  I $P(ARRAY(SPOUSE,"ZIC"),HLFS,I) S FND1=1,CNT=CNT+1,IVMERR(CNT)="No income data allowed if spouse didn't live w/vet & amt contributed <$600"
"RTN","IVMCMF1",54,0)
 I $G(DEPIEN)=SPOUSE D
"RTN","IVMCMF1",55,0)
 . F I=2:1:10 I $P(STRING,HLFS,I)]"" S CNT=CNT+1,IVMERR(CNT)=$P($T(ZIRFLD+I),";;",2)_" should not be filled in for spouse ZIR"
"RTN","IVMCMF1",56,0)
 I $G(DEPIEN),(DEPIEN'=SPOUSE) D
"RTN","IVMCMF1",57,0)
 . I $P(STRING,HLFS,3)'=1 S CNT=CNT+1,IVMERR(CNT)="Dependents must have Lived With Patient field"
"RTN","IVMCMF1",58,0)
 . I '$P(STRING,HLFS,8),($P(STRING,HLFS,9)]"") S CNT=CNT+1,IVMERR(CNT)="Shouldn't have Income Available answered if Child had no income"
"RTN","IVMCMF1",59,0)
 . I $P(STRING,HLFS,3),($P(STRING,HLFS,7)]"") S CNT=CNT+1,IVMERR(CNT)="Shouldn't have Contributed to Support if living w/patient"
"RTN","IVMCMF1",60,0)
 . I '$P(STRING,HLFS,8) S FND1=0 F I=3:1:20 Q:FND1  I $P(ARRAY(DEPIEN,"ZIC"),HLFS,I) S CNT=CNT+1,IVMERR(CNT)="Shouldn't have income data if Child Had Income is NO",FND1=1
"RTN","IVMCMF1",61,0)
ZIRQ Q
"RTN","IVMCMF1",62,0)
 ;
"RTN","IVMCMF1",63,0)
ZICFLD ; ZIC field names
"RTN","IVMCMF1",64,0)
 ;;
"RTN","IVMCMF1",65,0)
 ;;INCOME YEAR
"RTN","IVMCMF1",66,0)
 ;;SOCIAL SECURITY
"RTN","IVMCMF1",67,0)
 ;;US CIVIL SERVICE
"RTN","IVMCMF1",68,0)
 ;;US RAILROAD RETIREMENT
"RTN","IVMCMF1",69,0)
 ;;MILITARY RETIREMENT
"RTN","IVMCMF1",70,0)
 ;;UNEMPLOYMENT COMPENSATION
"RTN","IVMCMF1",71,0)
 ;;OTHER RETIREMENT
"RTN","IVMCMF1",72,0)
 ;;EMPLOYMENT INCOME
"RTN","IVMCMF1",73,0)
 ;;INTEREST, DIVIDEND, ANNUITY
"RTN","IVMCMF1",74,0)
 ;;WORKERS COMP/BLACK LUNG
"RTN","IVMCMF1",75,0)
 ;;OTHER INCOME
"RTN","IVMCMF1",76,0)
 ;;MEDICAL EXPENSES
"RTN","IVMCMF1",77,0)
 ;;FUNERAL AND BURIAL EXPENSES
"RTN","IVMCMF1",78,0)
 ;;EDUCATIONAL EXPENSES
"RTN","IVMCMF1",79,0)
 ;;CASH AMOUNT IN BANK ACCOUNTS
"RTN","IVMCMF1",80,0)
 ;;STOCKS AND BONDS
"RTN","IVMCMF1",81,0)
 ;;REAL PROPERTY
"RTN","IVMCMF1",82,0)
 ;;OTHER PROPERTY OR ASSETS
"RTN","IVMCMF1",83,0)
 ;;DEBTS
"RTN","IVMCMF1",84,0)
 ;
"RTN","IVMCMF1",85,0)
ZIRFLD ; ZIR field names
"RTN","IVMCMF1",86,0)
 ;;
"RTN","IVMCMF1",87,0)
 ;;MARRIED LAST CALENDAR YEAR
"RTN","IVMCMF1",88,0)
 ;;LIVED WITH PATIENT
"RTN","IVMCMF1",89,0)
 ;;AMOUNT CONTRIBUTED TO SPOUSE
"RTN","IVMCMF1",90,0)
 ;;DEPENDENT CHILDREN
"RTN","IVMCMF1",91,0)
 ;;INCAPABLE OF SELF SUPPORT
"RTN","IVMCMF1",92,0)
 ;;CONTRIBUTED TO SUPPORT
"RTN","IVMCMF1",93,0)
 ;;CHILD HAD INCOME
"RTN","IVMCMF1",94,0)
 ;;INCOME AVAILABLE TO YOU
"RTN","IVMCMF1",95,0)
 ;;NUMBER OF DEPENDENT CHILDREN
"RTN","IVMCMF2")
0^8^B37381276
"RTN","IVMCMF2",1,0)
IVMCMF2 ;ALB/SEK - CHECK INCOME DEPENDENT DATA ; 01/02/03
"RTN","IVMCMF2",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**71**;21-OCT-94
"RTN","IVMCMF2",3,0)
 ;
"RTN","IVMCMF2",4,0)
 ; This routine is a called from IVMCMF.
"RTN","IVMCMF2",5,0)
 ;
"RTN","IVMCMF2",6,0)
ZMT(STRING) ; check ZMT segment
"RTN","IVMCMF2",7,0)
 ;
"RTN","IVMCMF2",8,0)
 ; Input:  STRING as ZMT segment
"RTN","IVMCMF2",9,0)
 ;
"RTN","IVMCMF2",10,0)
 N I,X,Y
"RTN","IVMCMF2",11,0)
 S X=$P(STRING,HLFS,2) I $E(X,1,4)<1993 S CNT=CNT+1,IVMERR(CNT)="Invalid Date of Test"
"RTN","IVMCMF2",12,0)
 S X=$$FMDATE^HLFNC(X),%DT="X" D ^%DT I Y<0 S CNT=CNT+1,IVMERR(CNT)="Invalid Date of Test"
"RTN","IVMCMF2",13,0)
 ;
"RTN","IVMCMF2",14,0)
 ; Means Test Status Checks
"RTN","IVMCMF2",15,0)
 I IVMTYPE=1,$P(STRING,HLFS,3)'="G" D MT^IVMCMF3(STRING,ARRAY("ZIC"))
"RTN","IVMCMF2",16,0)
 ;
"RTN","IVMCMF2",17,0)
 ; Copay Test Status Checks
"RTN","IVMCMF2",18,0)
 I IVMTYPE=2 D CO^IVMCMF3(STRING)
"RTN","IVMCMF2",19,0)
 ;
"RTN","IVMCMF2",20,0)
 ; Long Term Care Status Checks
"RTN","IVMCMF2",21,0)
 I IVMTYPE=4 D LTC^IVMCMF3(STRING)
"RTN","IVMCMF2",22,0)
 ;
"RTN","IVMCMF2",23,0)
 ; Field Content/Length
"RTN","IVMCMF2",24,0)
 F I=4,5 I $$NUM^IVMCME2($P(STRING,HLFS,I),10,2) S CNT=CNT+1,IVMERR(CNT)=$S(I=4:"INCOME",1:"NET WORTH")_" field content/length error"
"RTN","IVMCMF2",25,0)
 ;
"RTN","IVMCMF2",26,0)
 ; Gather Income Totals
"RTN","IVMCMF2",27,0)
 D INC^IVMCMF3
"RTN","IVMCMF2",28,0)
 ;
"RTN","IVMCMF2",29,0)
 ; Adjudicate Date/Time
"RTN","IVMCMF2",30,0)
 S X=$P(STRING,HLFS,6) I X]"" D
"RTN","IVMCMF2",31,0)
 . I $E(X,1,4)<1993!($E(X,1,4)>($E(DT,1,3)+1700)) S CNT=CNT+1,IVMERR(CNT)="Invalid Adjudication Date/Time" Q
"RTN","IVMCMF2",32,0)
 . S X=$$FMDATE^HLFNC(X),%DT="TX" D ^%DT I Y<0 S CNT=CNT+1,IVMERR(CNT)="Invalid Adjudication Date/Time"
"RTN","IVMCMF2",33,0)
 ;
"RTN","IVMCMF2",34,0)
 ; Agree to Pay Deductible
"RTN","IVMCMF2",35,0)
 S X=$P(STRING,HLFS,7) I X]"",(X'=0),(X'=1) S CNT=CNT+1,IVMERR(CNT)="Invalid Agreed To Pay Deductible Value"
"RTN","IVMCMF2",36,0)
 I $P(STRING,HLFS,26)="A",X'="" S CNT=CNT+1,IVMERR(CNT)="MT Copay Exempt veteran-Agree to Pay Deductible should be null"
"RTN","IVMCMF2",37,0)
 ;
"RTN","IVMCMF2",38,0)
 ; Threshold A value
"RTN","IVMCMF2",39,0)
 I IVMTYPE=1 D
"RTN","IVMCMF2",40,0)
 .S X=$P(STRING,HLFS,8)
"RTN","IVMCMF2",41,0)
 .I (X']"")!(X'>0)!(X'<99001) S CNT=CNT+1,IVMERR(CNT)="Invalid Threshold A value"
"RTN","IVMCMF2",42,0)
 ;
"RTN","IVMCMF2",43,0)
 ; GMT Threshold Value
"RTN","IVMCMF2",44,0)
 I IVMTYPE=1 D
"RTN","IVMCMF2",45,0)
 .S X=$P(STRING,HLFS,28)
"RTN","IVMCMF2",46,0)
 .I ((X'="")&(X'=0))&((X'>0)!(X'<100000)) S CNT=CNT+1,IVMERR(CNT)="Invalid GMT Threshold"
"RTN","IVMCMF2",47,0)
 ;
"RTN","IVMCMF2",48,0)
 ; Deductibe Expenses
"RTN","IVMCMF2",49,0)
 I $$NUM^IVMCME2($P(STRING,HLFS,9),10,2) S CNT=CNT+1,IVMERR(CNT)="Deductible Expenses field content/length error"
"RTN","IVMCMF2",50,0)
 I $P(STRING,HLFS,4)<($P(STRING,HLFS,9)) S CNT=CNT+1,IVMERR(CNT)="Deductible Expenses cannot exceed income"
"RTN","IVMCMF2",51,0)
 ;
"RTN","IVMCMF2",52,0)
 ; Means Test Completion Date/Time
"RTN","IVMCMF2",53,0)
 S X=$P(STRING,HLFS,10)
"RTN","IVMCMF2",54,0)
 I $E(X,1,4)<1992 S CNT=CNT+1,IVMERR(CNT)="Invalid Completion Date/Time"
"RTN","IVMCMF2",55,0)
 E  S X=$$FMDATE^HLFNC(X),%DT="TX" D ^%DT I Y<0 S CNT=CNT+1,IVMERR(CNT)="Invalid Completion Date/Time" G ZMTQ
"RTN","IVMCMF2",56,0)
 ;
"RTN","IVMCMF2",57,0)
 ; Hardship consistency checks
"RTN","IVMCMF2",58,0)
 N HARDSHIP K HARDSHIP
"RTN","IVMCMF2",59,0)
 S HARDSHIP("Y/N")=$P(STRING,HLFS,13)
"RTN","IVMCMF2",60,0)
 S HARDSHIP("SITE")=$P(STRING,HLFS,23)
"RTN","IVMCMF2",61,0)
 S HARDSHIP("EFFDATE")=$P(STRING,HLFS,24)
"RTN","IVMCMF2",62,0)
 ;
"RTN","IVMCMF2",63,0)
 I (IVMTYPE'=4),(HARDSHIP("Y/N"))!(+HARDSHIP("SITE"))!(HARDSHIP("EFFDATE")) D
"RTN","IVMCMF2",64,0)
 .I HARDSHIP("Y/N")="" S CNT=CNT+1,IVMERR(CNT)="Missing Hardship Indicator"
"RTN","IVMCMF2",65,0)
 .I HARDSHIP("SITE")="" S CNT=CNT+1,IVMERR(CNT)="Missing Site Granting Hardship"
"RTN","IVMCMF2",66,0)
 .;starting in year 2000, all hardships should have an effective date
"RTN","IVMCMF2",67,0)
 .I $E($P(STRING,HLFS,2),1,4)'<2000,(HARDSHIP("EFFDATE")="") S CNT=CNT+1,IVMERR(CNT)="Missing Hardship Effective Date"
"RTN","IVMCMF2",68,0)
 .I $L(HARDSHIP("EFFDATE")) S X=$$FMDATE^HLFNC(HARDSHIP("EFFDATE")),%DT=X D ^%DT I Y<0 S CNT=CNT+1,IVMERR(CNT)="Invalid Hardship Effective Date"
"RTN","IVMCMF2",69,0)
 .I HARDSHIP("EFFDATE"),(HARDSHIP("EFFDATE")<$P(STRING,HLFS,2)) S CNT=CNT+1,IVMERR(CNT)="Hardship Effective Date earlier than Means Test Date"
"RTN","IVMCMF2",70,0)
 ;
"RTN","IVMCMF2",71,0)
 ; Date Veteran Signed/Refused to Sign
"RTN","IVMCMF2",72,0)
 D SIGN^IVMCMF3
"RTN","IVMCMF2",73,0)
 ;
"RTN","IVMCMF2",74,0)
 ; Source of Test
"RTN","IVMCMF2",75,0)
 S X=$P(STRING,HLFS,18)
"RTN","IVMCMF2",76,0)
 I X'=1,X'=2,X'=3,X'=4 S CNT=CNT+1,IVMERR(CNT)="Source of Test must be identified"
"RTN","IVMCMF2",77,0)
 I X=4,$P(STRING,HLFS,22)="" S CNT=CNT+1,IVMERR(CNT)="Site Conducting Test must be identified"
"RTN","IVMCMF2",78,0)
 ;
"RTN","IVMCMF2",79,0)
ZMTQ Q
"RTN","IVMCMF2",80,0)
 ;
"RTN","IVMCMF2",81,0)
ZDP(STRING,DEPIEN) ; Check validity of ZDP segment
"RTN","IVMCMF2",82,0)
 ;
"RTN","IVMCMF2",83,0)
 ; Input:  STRING as ZDP segment
"RTN","IVMCMF2",84,0)
 ;         DEPIEN as the IEN of the dependent in the array
"RTN","IVMCMF2",85,0)
 ;
"RTN","IVMCMF2",86,0)
 N RELAT,IVMZDP5,IVMZDP7,X,Y
"RTN","IVMCMF2",87,0)
 S X=$P(STRING,HLFS,2) I $L(X)>30!($L(X)<3)!(X?.N)!(X?1P.E)!(X'?1U.ANP)!(X[",")!(X?.L)!(X?." ") S CNT=CNT+1,IVMERR(CNT)="Invalid dependent name content/length"
"RTN","IVMCMF2",88,0)
 S X=$P(STRING,HLFS,3) I X'="M",(X'="F") S CNT=CNT+1,IVMERR(CNT)="Invalid sex transmitted for dependent"
"RTN","IVMCMF2",89,0)
 D
"RTN","IVMCMF2",90,0)
 .S X=$$FMDATE^HLFNC($P(STRING,HLFS,4)),%DT="P" D ^%DT I Y<0!(1701231>Y) S CNT=CNT+1,IVMERR(CNT)="Unacceptable DOB for dependent" Q
"RTN","IVMCMF2",91,0)
 .I IVMTYPE'=3,(($E($P(ARRAY("ZMT"),HLFS,2),1,4)-1_1231)<$P(STRING,HLFS,4)) S CNT=CNT+1,IVMERR(CNT)="Unacceptable DOB for dependent"
"RTN","IVMCMF2",92,0)
 S X=$P(STRING,HLFS,5) I X]"",(X'?9N),(X'?3N1"-"2N1"-"4N),(X'?9N1"P"),(X'?3N1"-"2N1"-"4N1"P") S CNT=CNT+1,IVMERR(CNT)="Invalid dependent SSN transmitted"
"RTN","IVMCMF2",93,0)
 I $E(X)=9!($E(X,1,3)="000") S CNT=CNT+1,IVMERR(CNT)="SSA-invalid SSN transmitted for a dependent"
"RTN","IVMCMF2",94,0)
 S X=$G(^DG(408.11,$P(STRING,HLFS,6),0))
"RTN","IVMCMF2",95,0)
 I '$P(X,"^",4) S CNT=CNT+1,IVMERR(CNT)="Invalid relationship for means test dependent"
"RTN","IVMCMF2",96,0)
 I $P(X,"^",3)'="E",($P(X,"^",3)'=$P(STRING,HLFS,3)) S CNT=CNT+1,IVMERR(CNT)="Dependent relationship/sex are inconsistent"
"RTN","IVMCMF2",97,0)
 I IVMTYPE'=3,($P(STRING,HLFS,9)>($E($P(ARRAY("ZMT"),HLFS,2),1,4)-1_1231)) S CNT=CNT+1,IVMERR(CNT)="Invalid Dependent Date...must be before MT year"
"RTN","IVMCMF2",98,0)
 S IVMZDP5=$P(STRING,HLFS,5)
"RTN","IVMCMF2",99,0)
 I +IVMZDP5'>0 D  G ZDPQ
"RTN","IVMCMF2",100,0)
 .S RELAT=$P(STRING,HLFS,6),RELAT=$S($D(^DG(408.11,RELAT,0)):$P(^DG(408.11,RELAT,0),HLFS),1:"OTHER")
"RTN","IVMCMF2",101,0)
 .S CNT=CNT+1,IVMERR(CNT)="Dependent ("_RELAT_") transmitted without SSN"
"RTN","IVMCMF2",102,0)
 I $D(IVMAR2(IVMZDP5)) S CNT=CNT+1,IVMERR(CNT)="Two dependents transmitted with same SSN"
"RTN","IVMCMF2",103,0)
 S IVMAR2(IVMZDP5)=""
"RTN","IVMCMF2",104,0)
ZDP7 S IVMZDP7=$P(STRING,HLFS,7) I +IVMZDP7'>0 G ZDPQ
"RTN","IVMCMF2",105,0)
 I $D(IVMAR(IVMZDP7)) S CNT=CNT+1,IVMERR(CNT)="Two dependents transmitted with same 408.12 IEN"
"RTN","IVMCMF2",106,0)
 S IVMAR(IVMZDP7)=""
"RTN","IVMCMF2",107,0)
ZDPQ Q
"RTN","IVMCMF3")
0^9^B36992687
"RTN","IVMCMF3",1,0)
IVMCMF3 ;ALB/RMM - CHECK INCOME TEST DATA (CON'T.) ; 01/02/03
"RTN","IVMCMF3",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**71**;21-OCT-94
"RTN","IVMCMF3",3,0)
 ;
"RTN","IVMCMF3",4,0)
 ;
"RTN","IVMCMF3",5,0)
 ; This routine is called from IVMCMF2.
"RTN","IVMCMF3",6,0)
 ;
"RTN","IVMCMF3",7,0)
MT(STRING,INCOME) ; Calculate means test status
"RTN","IVMCMF3",8,0)
 ; DGMTBS - BASE THRESHOLD VALUE FOR SITE
"RTN","IVMCMF3",9,0)
 ; DGMTBH - BASE THRESHOLD VALUE SENT FROM HEC
"RTN","IVMCMF3",10,0)
 ; DGTDEP - TOTAL # OF DEPENDENTS SENT BY HEC.
"RTN","IVMCMF3",11,0)
 ;
"RTN","IVMCMF3",12,0)
 N X,Y,ADJ,HAR,INC,NET,THRESH,THRESHA,THRESHT,IVMTEXT,XMSUB,CAT,CAT1
"RTN","IVMCMF3",13,0)
 N VADM,DGMTBS,THRESHV,DGMTBH,DGTDEP,ECODE,DGMTICY,DGMTCMP
"RTN","IVMCMF3",14,0)
 ;
"RTN","IVMCMF3",15,0)
 ; Perform initial error checking
"RTN","IVMCMF3",16,0)
 S CAT1=$P(STRING,HLFS,3)
"RTN","IVMCMF3",17,0)
 I '$$GETSTAT^DGMTH(CAT1,1) S CNT=CNT+1,IVMERR(CNT)="Invalid Means Test Status"
"RTN","IVMCMF3",18,0)
 ;
"RTN","IVMCMF3",19,0)
 S CAT=$P(STRING,HLFS,26) I CAT="" S CAT=CAT1
"RTN","IVMCMF3",20,0)
 I CAT'="A",CAT'="C",CAT'="P",CAT'="G" S CNT=CNT+1,IVMERR(CNT)="Invalid Means Test Status for Test-Determined Status"
"RTN","IVMCMF3",21,0)
 ;
"RTN","IVMCMF3",22,0)
 ; If previous yr mt threshold flag is set use date of prev year
"RTN","IVMCMF3",23,0)
 S X=$S($P(STRING,HLFS,11):($E($P(STRING,HLFS,2),1,4)-1),1:$E($P(STRING,HLFS,2),1,4)),DGMTICY=$P($G(STRING),HLFS,2)
"RTN","IVMCMF3",24,0)
 N Y S Y=$$HL7TFM^XLFDT(DGMTICY,"1D") X ^DD("DD") S DGMTICY=Y
"RTN","IVMCMF3",25,0)
 S %DT="" D ^%DT S X=Y K %DT
"RTN","IVMCMF3",26,0)
 S THRESH=$G(^DG(43,1,"MT",X,0)),THRESHT=$P(THRESH,U,2),DGMTBS=THRESHT
"RTN","IVMCMF3",27,0)
 I $P(STRING,HLFS,12) S THRESHT=THRESHT+$P(THRESH,U,3)+(($P(STRING,HLFS,12)-1)*$P(THRESH,U,4)),DGTDEP=$P($G(STRING),HLFS,12)
"RTN","IVMCMF3",28,0)
 ;
"RTN","IVMCMF3",29,0)
 S INC=$P(STRING,HLFS,4)-$P(STRING,HLFS,9),NET=$P(STRING,HLFS,5)
"RTN","IVMCMF3",30,0)
 S ADJ=$P(STRING,HLFS,6),THRESHA=$P(STRING,HLFS,8),DGMTBH=THRESHA
"RTN","IVMCMF3",31,0)
 I $P(STRING,HLFS,12),(THRESHA'=THRESHT) S THRESHA=THRESHA+$P(THRESH,U,3)+(($P(STRING,HLFS,12)-1)*$P(THRESH,U,4))
"RTN","IVMCMF3",32,0)
 S DECLINE=$P(STRING,HLFS,16),HAR=$P(STRING,HLFS,13),DGMTCMP=+$P(STRING,HLFS,10)
"RTN","IVMCMF3",33,0)
 S DGMTICYR=$$LYR^DGMTSCU1($$HL7TFM^XLFDT($P(STRING,HLFS,2)))
"RTN","IVMCMF3",34,0)
 S THRESHV=$$GMTT(DFN,DGMTICYR,$G(DGTDEP))
"RTN","IVMCMF3",35,0)
 ;
"RTN","IVMCMF3",36,0)
 ; Perform error checking
"RTN","IVMCMF3",37,0)
 I DECLINE,CAT="A" S CNT=CNT+1,IVMERR(CNT)="Declines to give income info-must be CAT C"
"RTN","IVMCMF3",38,0)
 I DECLINE,CAT="C" G MTQ
"RTN","IVMCMF3",39,0)
 ;
"RTN","IVMCMF3",40,0)
 ; If threshold A is incorrect, send message to sites's IVM MESSAGE
"RTN","IVMCMF3",41,0)
 ; mail group and continue to process
"RTN","IVMCMF3",42,0)
 I +DGMTBH>0,DGMTCMP>0,(CAT'="G"&(THRESHT'=THRESHA)) D
"RTN","IVMCMF3",43,0)
 .D:$G(DFN)'=""
"RTN","IVMCMF3",44,0)
 ..N VAHOW,VAROOT,VAPTYP
"RTN","IVMCMF3",45,0)
 ..D DEM^VADPT
"RTN","IVMCMF3",46,0)
 .S XMSUB="MT threshold discrepancy - "_"PID - "_$P($G(VADM(2)),U,2)
"RTN","IVMCMF3",47,0)
 .S IVMTEXT(1)="While uploading the following income test from HEC a"
"RTN","IVMCMF3",48,0)
 .S IVMTEXT(2)="discrepancy was found with the threshold A values."
"RTN","IVMCMF3",49,0)
 .S IVMTEXT(3)="  ",IVMTEXT(4)="   NAME: "_$G(VADM(1))
"RTN","IVMCMF3",50,0)
 .S IVMTEXT(5)="  ",IVMTEXT(6)="   PID : "_$P($G(VADM(2)),"^",2)
"RTN","IVMCMF3",51,0)
 .S IVMTEXT(8)="  ",IVMTEXT(9)="Date of Test sent from HEC: "_DGMTICY
"RTN","IVMCMF3",52,0)
 .S IVMTEXT(10)="  "
"RTN","IVMCMF3",53,0)
 .S IVMTEXT(11)="Site MT Threshold value: "_$J($FN($G(THRESHT),",",0),6)
"RTN","IVMCMF3",54,0)
 .S IVMTEXT(12)="  "
"RTN","IVMCMF3",55,0)
 .S IVMTEXT(13)="HEC Transmitted MT Threshold value: "_$J($FN($G(DGMTBH),",",0),6)
"RTN","IVMCMF3",56,0)
 .S IVMTEXT(14)="  ",IVMTEXT(16)="Total number of dependents: "_$G(DGTDEP)
"RTN","IVMCMF3",57,0)
 .S IVMTEXT(17)="  "
"RTN","IVMCMF3",58,0)
 .D MAIL^IVMUFNC("DGMT MT/CT UPLOAD ALERTS")
"RTN","IVMCMF3",59,0)
 .Q
"RTN","IVMCMF3",60,0)
 ;
"RTN","IVMCMF3",61,0)
 I INC'>THRESHA D
"RTN","IVMCMF3",62,0)
 .I NET']"" S CNT=CNT+1,IVMERR(CNT)="This veteran requires net worth"
"RTN","IVMCMF3",63,0)
 .I ((INC+NET)'>$P(THRESH,U,8))&(CAT="C") S CNT=CNT+1,IVMERR(CNT)="Income plus net worth not greater than threshold value-incorrect status"
"RTN","IVMCMF3",64,0)
 .I ((INC+NET)>$P(THRESH,U,8))&(CAT="A"),'$P(STRING,HLFS,6) S CNT=CNT+1,IVMERR(CNT)="Patient should be adjudicated-no adjudicated date/time"
"RTN","IVMCMF3",65,0)
 I INC>THRESHA,CAT'="C",'HAR,'ADJ,CAT'="P" S CNT=CNT+1,IVMERR(CNT)="Incorrect means test status for Test-Determined Status"
"RTN","IVMCMF3",66,0)
MTQ Q
"RTN","IVMCMF3",67,0)
 ;
"RTN","IVMCMF3",68,0)
 ;
"RTN","IVMCMF3",69,0)
CO(STRING) ; Calculate copay test status
"RTN","IVMCMF3",70,0)
 ;
"RTN","IVMCMF3",71,0)
 N CAT,CAT1,COPDT,DECLINE,DEDEX,DEP,DGCAT,DGCOPS,DGCOST,INC
"RTN","IVMCMF3",72,0)
 ;
"RTN","IVMCMF3",73,0)
 ; Variables containing ZMT fields
"RTN","IVMCMF3",74,0)
 S COPDT=$$FMDATE^HLFNC($P(STRING,HLFS,2)),CAT1=$P(STRING,HLFS,3)
"RTN","IVMCMF3",75,0)
 I '$$GETSTAT^DGMTH(CAT1,2) S CNT=CNT+1,IVMERR(CNT)="Invalid Copay Test Status"
"RTN","IVMCMF3",76,0)
 ;
"RTN","IVMCMF3",77,0)
 ; For the Test-Determined Status only
"RTN","IVMCMF3",78,0)
 ; - a status of E or M or P should be transmitted
"RTN","IVMCMF3",79,0)
 ; - P only is networth is used to determine exemption
"RTN","IVMCMF3",80,0)
 S CAT=$P(STRING,HLFS,26) I CAT="" S CAT=CAT1
"RTN","IVMCMF3",81,0)
 I CAT'="E",CAT'="M",CAT'="P" S CNT=CNT+1,IVMERR(CNT)="Invalid Copay Test Status for Test-Determined Status"
"RTN","IVMCMF3",82,0)
 I CAT="P",'$$NETW^IBARXEU1 S CNT=CNT+1,IVMERR(CNT)="Invalid Copay Test Status for Test-Determined Status"
"RTN","IVMCMF3",83,0)
 ;
"RTN","IVMCMF3",84,0)
 S INC=$P(STRING,HLFS,4),DEDEX=$P(STRING,HLFS,9),DEP=$P(STRING,HLFS,12)
"RTN","IVMCMF3",85,0)
 S DECLINE=$P(STRING,HLFS,16),DGCOST=COPDT_U_DFN_U_U_INC,$P(DGCOST,U,14)=DECLINE
"RTN","IVMCMF3",86,0)
 S $P(DGCOST,U,15)=DEDEX,$P(DGCOST,U,18)=DEP,$P(DGCOST,U,19)=2
"RTN","IVMCMF3",87,0)
 S DGCOPS=$$INCDT^IBARXEU1(DGCOST)
"RTN","IVMCMF3",88,0)
 S DGCAT=$S(+DGCOPS=1:"E",+DGCOPS=2:"M",+DGCOPS=3:"P",1:"I")
"RTN","IVMCMF3",89,0)
 I CAT'=DGCAT S CNT=CNT+1,IVMERR(CNT)="Copay Test Status should be "_DGCAT
"RTN","IVMCMF3",90,0)
COQ Q
"RTN","IVMCMF3",91,0)
 ;
"RTN","IVMCMF3",92,0)
INC ; Gather income totals
"RTN","IVMCMF3",93,0)
 ;
"RTN","IVMCMF3",94,0)
 N DEBD,DEB,DEBT,DGX,EXCL,INC,INCYR,NET,X,Y
"RTN","IVMCMF3",95,0)
 ;
"RTN","IVMCMF3",96,0)
 S X=$E($P(ARRAY("ZMT"),U,2),1,4),%DT="" D ^%DT S INCYR=Y
"RTN","IVMCMF3",97,0)
 I $P(STRING,HLFS,4)']"",'$$IS^IVMCUC(DFN,INCYR),'$P(STRING,HLFS,16) S CNT=CNT+1,IVMERR(CNT)="No Income transmitted"
"RTN","IVMCMF3",98,0)
 S INC=$P(ARRAY("ZIC"),HLFS,21),DEBT=$P(ARRAY("ZIC"),HLFS,22),NET=$P(ARRAY("ZIC"),HLFS,23)
"RTN","IVMCMF3",99,0)
 S DGX=0 F  S DGX=$O(ARRAY(DGX)) Q:'DGX  D
"RTN","IVMCMF3",100,0)
 .S INC=INC+($P(ARRAY(DGX,"ZIC"),HLFS,21))
"RTN","IVMCMF3",101,0)
 .S NET=NET+($P(ARRAY(DGX,"ZIC"),HLFS,23))
"RTN","IVMCMF3",102,0)
 .I $P(ARRAY(DGX,"ZDP"),U,6)'=2 D  Q
"RTN","IVMCMF3",103,0)
 ..S EXCL=$P($G(^DG(43,1,"MT",INCYR,0)),U,17)
"RTN","IVMCMF3",104,0)
 ..S DEBD=($P(ARRAY(DGX,"ZIC"),HLFS,9)-EXCL-$P(ARRAY(DGX,"ZIC"),HLFS,15))
"RTN","IVMCMF3",105,0)
 ..S DEBD=$S(DEBD>0:DEBD,1:0)
"RTN","IVMCMF3",106,0)
 ..S DEB=($P(ARRAY(DGX,"ZIC"),HLFS,9)-DEBD)
"RTN","IVMCMF3",107,0)
 ..S DEBT=DEBT+DEB
"RTN","IVMCMF3",108,0)
 .S DEBT=DEBT+($P(ARRAY(DGX,"ZIC"),HLFS,22))
"RTN","IVMCMF3",109,0)
INCQ Q
"RTN","IVMCMF3",110,0)
 ;
"RTN","IVMCMF3",111,0)
 ;
"RTN","IVMCMF3",112,0)
SIGN ; Date Veteran Signed/Refused to Sign
"RTN","IVMCMF3",113,0)
 I $P(STRING,HLFS,15)]"" D
"RTN","IVMCMF3",114,0)
 .S X=$P(STRING,HLFS,15) I $E(X,1,4)<1994!($E(X,1,4)>($E(DT,1,3)+1700)) S CNT=CNT+1,IVMERR(CNT)="Invalid Date Veteran Signed Test" Q
"RTN","IVMCMF3",115,0)
 .S X=$$FMDATE^HLFNC($P(STRING,HLFS,15)),%DT="X" D ^%DT I Y<0 S CNT=CNT+1,IVMERR(CNT)="Invalid Date Veteran Signed Test" Q
"RTN","IVMCMF3",116,0)
SIGNQ Q
"RTN","IVMCMF3",117,0)
 ;
"RTN","IVMCMF3",118,0)
LTC(STRING) ;calculate LTC test status
"RTN","IVMCMF3",119,0)
 ;
"RTN","IVMCMF3",120,0)
 N CAT1
"RTN","IVMCMF3",121,0)
 S CAT1=$P(STRING,HLFS,3)
"RTN","IVMCMF3",122,0)
 I '$$GETSTAT^DGMTH(CAT1,4) S CNT=CNT+1,IVMERR(CNT)="Invalid LTC Test Status"
"RTN","IVMCMF3",123,0)
 Q
"RTN","IVMCMF3",124,0)
 ;
"RTN","IVMCMF3",125,0)
GMTT(DFN,DGMTICY,DGTDEP) ;Get GMT Threshold values for veteran
"RTN","IVMCMF3",126,0)
 ; Input:      DFN = Patient IEN
"RTN","IVMCMF3",127,0)
 ;         DGMTICY = Last Income year
"RTN","IVMCMF3",128,0)
 ;          DGTDEP = Total number of dependents
"RTN","IVMCMF3",129,0)
 ;Output:     GMTT = GMT Thresholds for Veteran
"RTN","IVMCMF3",130,0)
 ;
"RTN","IVMCMF3",131,0)
 N DGMTGMT,GMT,GMTT,PCT
"RTN","IVMCMF3",132,0)
 S GMTT=0
"RTN","IVMCMF3",133,0)
 D GETFIPS^EASAILK(DFN,DGMTICY,.GMT)
"RTN","IVMCMF3",134,0)
 I '$G(GMT("GMTIEN")) Q GMTT
"RTN","IVMCMF3",135,0)
 S DGMTGMT=$G(^EAS(712.5,GMT("GMTIEN"),1))
"RTN","IVMCMF3",136,0)
 I (DGTDEP+1)<9 S GMTT=$P(DGMTGMT,"^",(DGTDEP+1)) Q GMTT
"RTN","IVMCMF3",137,0)
 S PCT=((DGTDEP+1)-8)*8+132,GMTT=$P(DGMTGMT,"^",4)*PCT/100
"RTN","IVMCMF3",138,0)
 S GMTT=$S(GMTT#50=0:GMTT,1:GMTT+(50-(GMTT#50)))
"RTN","IVMCMF3",139,0)
 Q GMTT
"RTN","IVMCMFB")
0^10^B12146323
"RTN","IVMCMFB",1,0)
IVMCMFB ;ALB/RMM - SEND INCOME TEST TRANSMISSION BULLETIN ; 01/23/03
"RTN","IVMCMFB",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**71**;21-OCT-94
"RTN","IVMCMFB",3,0)
 ;
"RTN","IVMCMFB",4,0)
BULL(DFN,DGMTDT,IVMERR) ;
"RTN","IVMCMFB",5,0)
 ; Send mail message notifying site of an income test that was completed
"RTN","IVMCMFB",6,0)
 ; containing data inconsistencies.
"RTN","IVMCMFB",7,0)
 ;
"RTN","IVMCMFB",8,0)
 ;  Input array required:
"RTN","IVMCMFB",9,0)
 ;    "IVMERR("  --  contains lists of inconsistencies from tests 
"RTN","IVMCMFB",10,0)
 ;                   which were uploaded (ORU~Z10 and ORF~Z10)
"RTN","IVMCMFB",11,0)
 ;
"RTN","IVMCMFB",12,0)
 N DIFROM,XMDUZ,XMTEXT,XMSTRIP,XMROU,XMY,XMZ,XMDF,IVMGRP,IVMPAT
"RTN","IVMCMFB",13,0)
 S XMDF=""
"RTN","IVMCMFB",14,0)
 S XMDUZ=""
"RTN","IVMCMFB",15,0)
 S XMTEXT="IVMTXT("
"RTN","IVMCMFB",16,0)
 S XMY(DUZ)=""
"RTN","IVMCMFB",17,0)
 S IVMGRP="MT INCONSISTENCIES"
"RTN","IVMCMFB",18,0)
 S XMY("G."_IVMGRP_"@"_^XMB("NETNAME"))=""
"RTN","IVMCMFB",19,0)
 S IVMPAT=$$PT^IVMUFNC4(DFN)
"RTN","IVMCMFB",20,0)
 S XMSUB="MT INCONSISTENCIES - "_$E($P(IVMPAT,"^"),1)_$P(IVMPAT,"^",3)
"RTN","IVMCMFB",21,0)
 ;
"RTN","IVMCMFB",22,0)
 S IVMTXT(1)="An Income Test was edited/completed on "_$$FMTE^XLFDT($$NOW^XLFDT,"1D")
"RTN","IVMCMFB",23,0)
 S IVMTXT(2)="containing "_($O(IVMERR(""),-1)-1)_" data inconsistencie(s)."
"RTN","IVMCMFB",24,0)
 S IVMTXT(3)=" "
"RTN","IVMCMFB",25,0)
 S IVMTXT(4)="    NAME:        "_$P(IVMPAT,"^")
"RTN","IVMCMFB",26,0)
 S IVMTXT(5)="    ID:          "_$P(IVMPAT,"^",2)
"RTN","IVMCMFB",27,0)
 S IVMTXT(6)="    TEST DATE:   "_$$FMTE^XLFDT(DGMTDT)
"RTN","IVMCMFB",28,0)
 S IVMTXT(7)=" "
"RTN","IVMCMFB",29,0)
 S IVMTXT(8)="The inconsistencies are listed in the comment section of"
"RTN","IVMCMFB",30,0)
 S IVMTXT(9)="the income test for this veteran."
"RTN","IVMCMFB",31,0)
 ;
"RTN","IVMCMFB",32,0)
 D ^XMD
"RTN","IVMCMFB",33,0)
 K IVMTXT,XMDUZ,XMSUB,XMTEXT,XMY
"RTN","IVMCMFB",34,0)
 Q
"RTN","IVMCMFB",35,0)
 ;
"RTN","IVMCMFB",36,0)
PROB(DGMTDT,IVMERR,BULLRQ) ;
"RTN","IVMCMFB",37,0)
 ;  IVMERR - Contains lists of inconsistencies from tests which were
"RTN","IVMCMFB",38,0)
 ;           uploaded (ORU~Z10 and ORF~Z10) or created during data
"RTN","IVMCMFB",39,0)
 ;            entry (Required)
"RTN","IVMCMFB",40,0)
 ;
"RTN","IVMCMFB",41,0)
 ;  BULLRQ - MT INCONSISTENCIES Bulletin Required? flag (Optional)
"RTN","IVMCMFB",42,0)
 ;
"RTN","IVMCMFB",43,0)
 S BULLRQ=+$G(BULLRQ)
"RTN","IVMCMFB",44,0)
 ; Send either a positive (AA) or a negative (AE) acknowledgement 
"RTN","IVMCMFB",45,0)
 ; (ACK) message to the HEC during Z10 upload only.
"RTN","IVMCMFB",46,0)
 I 'BULLRQ I $D(IVMERR(2)) S HLERR=IVMERR(2) D ACK^IVMPREC
"RTN","IVMCMFB",47,0)
 ;
"RTN","IVMCMFB",48,0)
 ; If the test wasn't completed during data entry quit
"RTN","IVMCMFB",49,0)
 N MTCOMP,DGMTI,TYPE
"RTN","IVMCMFB",50,0)
 S TYPE=$S($D(IVMTYPE):IVMTYPE,$D(DGMTYPT):DGMTYPT,1:"")
"RTN","IVMCMFB",51,0)
 S:'$D(DGMTI) DGMTI=+$$LST^DGMTU(DFN,,TYPE)
"RTN","IVMCMFB",52,0)
 S MTCOMP=$P($G(^DGMT(408.31,+$G(DGMTI),0)),U,7)
"RTN","IVMCMFB",53,0)
 I BULLRQ,MTCOMP'>0 Q
"RTN","IVMCMFB",54,0)
 ;
"RTN","IVMCMFB",55,0)
 ; If errors were found during data entry, send bulletin 
"RTN","IVMCMFB",56,0)
 I BULLRQ,$D(IVMERR(2)) D BULL(DFN,DGMTDT,.IVMERR)
"RTN","IVMCMFB",57,0)
 ;
"RTN","IVMCMFB",58,0)
 ; If inconsistent data was found update the comment field with the list
"RTN","IVMCMFB",59,0)
 ; of errors.
"RTN","IVMCMFB",60,0)
 D INCON(DGMTI,.IVMERR)
"RTN","IVMCMFB",61,0)
 Q
"RTN","IVMCMFB",62,0)
 ;
"RTN","IVMCMFB",63,0)
INCON(DGMTI,IVMERR,TFLG) ;
"RTN","IVMCMFB",64,0)
 ; Append the current comments (if any) with the list of inconsistencies
"RTN","IVMCMFB",65,0)
 ; found during data entry or upload of ORU/ORF Z10
"RTN","IVMCMFB",66,0)
 N CNT,INCNT,COMM,TTYPE,TAB,ERR,LNCNT,TFLG
"RTN","IVMCMFB",67,0)
 I $D(IVMERR(2)),BULLRQ D
"RTN","IVMCMFB",68,0)
 .S TTYPE=^DG(408.33,+$P($G(^DGMT(408.31,DGMTI,0)),U,19),0)
"RTN","IVMCMFB",69,0)
 .S IVMERR(1)=":A "_TTYPE_" was edited on "_$$FMTE^XLFDT($$NOW^XLFDT,"1P")_" with data inconsistencies."
"RTN","IVMCMFB",70,0)
 I $D(IVMERR(2)),'BULLRQ D
"RTN","IVMCMFB",71,0)
 .S IVMERR(1)=":Received/Uploaded Test on "_$$FMTE^XLFDT($$NOW^XLFDT,"1P")_" with data inconsistencies."
"RTN","IVMCMFB",72,0)
 ;
"RTN","IVMCMFB",73,0)
 ; Check for exisiting non-inconsistency messages
"RTN","IVMCMFB",74,0)
 S TFLG=2
"RTN","IVMCMFB",75,0)
 D CHECK(DGMTI,.TFLG)
"RTN","IVMCMFB",76,0)
 ;
"RTN","IVMCMFB",77,0)
 ; If nothing to add to the  COMMENT field, delete all existing msgs
"RTN","IVMCMFB",78,0)
 I '$D(IVMERR(1)) D INCONR(DGMTI) Q
"RTN","IVMCMFB",79,0)
 ;
"RTN","IVMCMFB",80,0)
 ; Overwrite the comments for inconsistencies found during Z10 upload
"RTN","IVMCMFB",81,0)
 S TAB=": "
"RTN","IVMCMFB",82,0)
 F LNCNT=TFLG:1 Q:'$D(IVMERR(LNCNT))  S IVMERR(LNCNT)=TAB_IVMERR(LNCNT)
"RTN","IVMCMFB",83,0)
 D WP^DIE(408.31,DGMTI_",",50,,"IVMERR",.ERR)
"RTN","IVMCMFB",84,0)
 Q
"RTN","IVMCMFB",85,0)
 ;
"RTN","IVMCMFB",86,0)
CHECK(DGMTI,TFLG) ;
"RTN","IVMCMFB",87,0)
 ; Check for exisiting non-inconsistency messages, and keep all 
"RTN","IVMCMFB",88,0)
 ; non-inconsistency (user entered) messages.
"RTN","IVMCMFB",89,0)
 ;
"RTN","IVMCMFB",90,0)
 ; Quit if no comments were entered
"RTN","IVMCMFB",91,0)
 Q:'$D(^DGMT(408.31,DGMTI,"C",1,0))
"RTN","IVMCMFB",92,0)
 ;
"RTN","IVMCMFB",93,0)
 ; Quit if all current comments are for inconsistencies
"RTN","IVMCMFB",94,0)
 S INCNT=0
"RTN","IVMCMFB",95,0)
 F CNT=1:1 Q:'$D(^DGMT(408.31,DGMTI,"C",CNT,0))  D
"RTN","IVMCMFB",96,0)
 .Q:$E(^DGMT(408.31,DGMTI,"C",CNT,0),1)=":"
"RTN","IVMCMFB",97,0)
 .Q:^DGMT(408.31,DGMTI,"C",CNT,0)']""
"RTN","IVMCMFB",98,0)
 .S INCNT=INCNT+1,COMM(INCNT)=^DGMT(408.31,DGMTI,"C",CNT,0)
"RTN","IVMCMFB",99,0)
 Q:INCNT'>0
"RTN","IVMCMFB",100,0)
 ;
"RTN","IVMCMFB",101,0)
 ; Re-Build Comment array with user comments
"RTN","IVMCMFB",102,0)
 S TFLG=INCNT+2
"RTN","IVMCMFB",103,0)
 F CNT=1:1 Q:'$D(IVMERR(CNT))  S INCNT=INCNT+1,COMM(INCNT)=IVMERR(CNT)
"RTN","IVMCMFB",104,0)
 M IVMERR=COMM
"RTN","IVMCMFB",105,0)
 Q
"RTN","IVMCMFB",106,0)
 ;
"RTN","IVMCMFB",107,0)
INCONR(DGMTI) ;
"RTN","IVMCMFB",108,0)
 ; When no inconsistent data and no user comments were found, 
"RTN","IVMCMFB",109,0)
 ; remove everything from the COMMENT Word Procesing field.
"RTN","IVMCMFB",110,0)
 ;
"RTN","IVMCMFB",111,0)
 ; Quit if no comments exist
"RTN","IVMCMFB",112,0)
 Q:'$D(^DGMT(408.31,DGMTI,"C",1,0))
"RTN","IVMCMFB",113,0)
 ;
"RTN","IVMCMFB",114,0)
 ; Delete all, when no comments and no inconsistencies
"RTN","IVMCMFB",115,0)
 D WP^DIE(408.31,DGMTI_",",50,,"@",.ERR)
"RTN","IVMCMFB",116,0)
 ;
"RTN","IVMCMFB",117,0)
 Q
"RTN","IVMPRECZ")
0^1^B24331457
"RTN","IVMPRECZ",1,0)
IVMPRECZ ;ALB/SEK,RTK - ROUTINE TO PROCESS V1.5 ORF-Z06 INCOMING HL7 MESSAGES ; 01/02/03 10:01am
"RTN","IVMPRECZ",2,0)
 ;;2.0;INCOME VERIFICATION MATCH;**34,64,71**;21-OCT-94
"RTN","IVMPRECZ",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","IVMPRECZ",4,0)
 ;
"RTN","IVMPRECZ",5,0)
 ;
"RTN","IVMPRECZ",6,0)
GET ; get HL7 segment from ^HL
"RTN","IVMPRECZ",7,0)
 S IVMDA=$O(^HL(772,HLDA,"IN",+IVMDA)),IVMSEG=$G(^(+IVMDA,0))
"RTN","IVMPRECZ",8,0)
 S IVMSEG1=$E(IVMSEG,1,3)
"RTN","IVMPRECZ",9,0)
 Q
"RTN","IVMPRECZ",10,0)
 ;
"RTN","IVMPRECZ",11,0)
ACK ; - prepare acknowledgment (ACK) message
"RTN","IVMPRECZ",12,0)
 S IVMCT=$G(IVMCT)+1
"RTN","IVMPRECZ",13,0)
 S HLSDT="IVMQ",^TMP("HLS",$J,HLSDT,IVMCT)=HLSDATA(1),IVMCT=IVMCT+1
"RTN","IVMPRECZ",14,0)
 S ^TMP("HLS",$J,HLSDT,IVMCT)="MSA"_HLFS_$S($D(HLERR):"AE",1:"AA")_HLFS_HLMID_$S($D(HLERR):HLFS_HLERR_" - SSN "_$S($G(DFN):$P($$PT^IVMUFNC4(DFN),"^",2),1:"NOT FOUND"),1:"")
"RTN","IVMPRECZ",15,0)
 I $D(HLERR) S HLEVN=HLEVN+1,IVMERROR=1
"RTN","IVMPRECZ",16,0)
 Q
"RTN","IVMPRECZ",17,0)
 ;
"RTN","IVMPRECZ",18,0)
NXTSEG(MSGIEN,CURLINE,SEG) ;
"RTN","IVMPRECZ",19,0)
 ;Description: Returns the next segment
"RTN","IVMPRECZ",20,0)
 ;
"RTN","IVMPRECZ",21,0)
 ;Input:
"RTN","IVMPRECZ",22,0)
 ;  MSGIEN - IEN in HL7 MESSAGE TEXT file
"RTN","IVMPRECZ",23,0)
 ;  CURLINE - subscript of the current segment
"RTN","IVMPRECZ",24,0)
 ;
"RTN","IVMPRECZ",25,0)
 ;Output:
"RTN","IVMPRECZ",26,0)
 ;  SEG - an array with the fields of the segment (pass by reference)
"RTN","IVMPRECZ",27,0)
 ;  CURLINE - upone exiting, will be the subscript of the next segment
"RTN","IVMPRECZ",28,0)
 ;
"RTN","IVMPRECZ",29,0)
 S CURLINE=CURLINE+1
"RTN","IVMPRECZ",30,0)
 S SEGMENT=$G(^HL(772,MSGIEN,"IN",CURLINE,0))
"RTN","IVMPRECZ",31,0)
 S SEG("TYPE")=$E(SEGMENT,1,3)
"RTN","IVMPRECZ",32,0)
 ;
"RTN","IVMPRECZ",33,0)
 ; MSH & BHS segs first piece is the field separator, which makes breaking the segment into fields a bit different
"RTN","IVMPRECZ",34,0)
 I (SEG("TYPE")="MSH")!(SEG("TYPE")="BHS") D
"RTN","IVMPRECZ",35,0)
 . S SEG(1)=$E(SEGMENT,4)
"RTN","IVMPRECZ",36,0)
 . F I=2:1:30 S SEG(I)=$P(SEGMENT,HLFS,I)
"RTN","IVMPRECZ",37,0)
 E  D
"RTN","IVMPRECZ",38,0)
 . F I=2:1:31 S SEG(I-1)=$P(SEGMENT,HLFS,I)
"RTN","IVMPRECZ",39,0)
 Q
"RTN","IVMPRECZ",40,0)
 ;
"RTN","IVMPRECZ",41,0)
ERRBULL ; build mail message for transmission to IVM mail group notifying site
"RTN","IVMPRECZ",42,0)
 ; of upload error.
"RTN","IVMPRECZ",43,0)
 S IVMPAT=$$PT^IVMUFNC4(DFN)
"RTN","IVMPRECZ",44,0)
 S XMSUB="MT SIGNATURE UPLOAD "_$E($P(IVMPAT,"^"),1)_$P(IVMPAT,"^",3)
"RTN","IVMPRECZ",45,0)
 S IVMTEXT(1)="Unable to upload a MT Signature.  A Means Test was not found that"
"RTN","IVMPRECZ",46,0)
 S IVMTEXT(2)="matches the Centralized Anniversary Date (CAD) on file at the HEC."
"RTN","IVMPRECZ",47,0)
 S IVMTEXT(3)=" "
"RTN","IVMPRECZ",48,0)
 S IVMTEXT(4)="    NAME:     "_$P(IVMPAT,"^")
"RTN","IVMPRECZ",49,0)
 S IVMTEXT(5)="    ID:       "_$P(IVMPAT,"^",2)
"RTN","IVMPRECZ",50,0)
 S IVMTEXT(6)="    ERROR:    "_IVMTEXT(6)
"RTN","IVMPRECZ",51,0)
 Q
"RTN","IVMPRECZ",52,0)
ORF ;entry point for Means Test Signature Z06 msgs.
"RTN","IVMPRECZ",53,0)
 N SEG,EVENT,MSGID
"RTN","IVMPRECZ",54,0)
 S:'$D(HLEVN) HLEVN=0
"RTN","IVMPRECZ",55,0)
 D NXTSEG(HLDA,0,.SEG)
"RTN","IVMPRECZ",56,0)
 Q:(SEG("TYPE")'="MSH")  ;wouldn't have reached here if this happened!
"RTN","IVMPRECZ",57,0)
 S EVENT=$P(SEG(9),$E(HLECH),2)
"RTN","IVMPRECZ",58,0)
 I EVENT'="Z06" G ORF^IVMCM
"RTN","IVMPRECZ",59,0)
 I $G(HLFS)="" S HLFS="^"
"RTN","IVMPRECZ",60,0)
 I $G(HLECH)="" S HLECH="~"
"RTN","IVMPRECZ",61,0)
 F IVMDA=0:0 S IVMDA=$O(^HL(772,HLDA,"IN",IVMDA)) Q:'IVMDA  S IVMSEG=$G(^(IVMDA,0)) I $E(IVMSEG,1,3)="MSH" D  Q:'IVMDA
"RTN","IVMPRECZ",62,0)
 .K HLERR
"RTN","IVMPRECZ",63,0)
 .S HLMID=$P(IVMSEG,HLFS,10) ; message control id from MSH
"RTN","IVMPRECZ",64,0)
 .S IVMFLGC=0
"RTN","IVMPRECZ",65,0)
 .D GET I IVMSEG1'="PID" D  Q
"RTN","IVMPRECZ",66,0)
 ..S HLERR="Missing PID segment" D ACK
"RTN","IVMPRECZ",67,0)
 .S DFN=$P($P(IVMSEG,HLFS,4),$E(HLECH))
"RTN","IVMPRECZ",68,0)
 .I ('DFN!(DFN'=+DFN)!('$D(^DPT(+DFN,0)))) D  Q
"RTN","IVMPRECZ",69,0)
 ..S HLERR="Invalid DFN" D ACK
"RTN","IVMPRECZ",70,0)
 .I $P(IVMSEG,HLFS,20)'=$P(^DPT(DFN,0),"^",9) S HLERR="Couldn't match IVMSSN with DHCP SSN" D ACK Q
"RTN","IVMPRECZ",71,0)
 .S IVMDAP=IVMDA ; save IVMDA for veteran PID segment
"RTN","IVMPRECZ",72,0)
 .D GET I IVMSEG1'="ZMT" D  Q
"RTN","IVMPRECZ",73,0)
 ..S HLERR="Missing ZMT segment" D ACK
"RTN","IVMPRECZ",74,0)
 .; IVMMTDT - means test date
"RTN","IVMPRECZ",75,0)
 .; DGLY - income year
"RTN","IVMPRECZ",76,0)
 .; if Means Test not in DHCP don't upload IVM Means Test
"RTN","IVMPRECZ",77,0)
 .S IVMMTDT=$$FMDATE^HLFNC($P(IVMSEG,HLFS,3)) ; means test date from ZMT  segment
"RTN","IVMPRECZ",78,0)
 .S DGLY=$$LYR^DGMTSCU1(IVMMTDT)
"RTN","IVMPRECZ",79,0)
 .; get means test to be updated
"RTN","IVMPRECZ",80,0)
 .N UPMTS
"RTN","IVMPRECZ",81,0)
 .S MTDATE=-IVMMTDT,IVMMTIEN="",(UPMTS,MTFND)=0
"RTN","IVMPRECZ",82,0)
 .F  S IVMMTIEN=$O(^DGMT(408.31,"AID",1,DFN,MTDATE,IVMMTIEN),-1) Q:MTFND!(IVMMTIEN="")  D
"RTN","IVMPRECZ",83,0)
 ..; match site completing in case multiple tests for same date
"RTN","IVMPRECZ",84,0)
 ..I $P(IVMSEG,HLFS,23)=$P(^DGMT(408.31,IVMMTIEN,2),HLFS,5) S UPMTS=IVMMTIEN,MTFND=1 Q
"RTN","IVMPRECZ",85,0)
 .S (IVMMT31,DGMTP)=$G(^DGMT(408.31,UPMTS,0)) ; DGMTP is event driver  variable
"RTN","IVMPRECZ",86,0)
 .I $P(IVMMT31,"^")'=IVMMTDT D  Q
"RTN","IVMPRECZ",87,0)
 ..S Y=IVMMTDT X ^DD("DD")
"RTN","IVMPRECZ",88,0)
 ..S IVMTEXT(6)="Means Test of "_Y_" not found in VistA."
"RTN","IVMPRECZ",89,0)
 ..D ERRBULL,MAIL^IVMUFNC()
"RTN","IVMPRECZ",90,0)
 ..S HLERR="Means test not in VistA" D ACK
"RTN","IVMPRECZ",91,0)
 ..Q
"RTN","IVMPRECZ",92,0)
 .I $P(IVMMT31,"^",23)=2 S Y=IVMMTDT X ^DD("DD") S HLERR="2nd means test  sent for "_Y D ACK Q
"RTN","IVMPRECZ",93,0)
 .; do not upload IVM means test if primary means test status is
"RTN","IVMPRECZ",94,0)
 .; 3-no longer required
"RTN","IVMPRECZ",95,0)
 .; or if hardship case
"RTN","IVMPRECZ",96,0)
 .S IVMSTAT=$P(IVMMT31,"^",3)
"RTN","IVMPRECZ",97,0)
 .I IVMSTAT=3 S HLERR="NOT UPLOADED no longer required" D ACK Q
"RTN","IVMPRECZ",98,0)
 .I $P(IVMMT31,"^",20)=1 S HLERR="NOT UPLOADED hardship case" D ACK Q
"RTN","IVMPRECZ",99,0)
 .;get MT signature and date/time edited info, update means test
"RTN","IVMPRECZ",100,0)
 .N DATA
"RTN","IVMPRECZ",101,0)
 .S DATA(.29)=$P(IVMSEG,HLFS,28),DATA(2.02)=$$FMDATE^HLFNC($P(IVMSEG,HLFS,26)) I $D(DATA(.29)) D
"RTN","IVMPRECZ",102,0)
 ..I $$UPD^DGENDBS(408.31,UPMTS,.DATA)
"RTN","IVMPRECZ",103,0)
 .I '$D(HLERR) D ACK
"RTN","IVMPRECZ",104,0)
 .;
"RTN","IVMPRECZ",105,0)
 .; cleanup
"RTN","IVMPRECZ",106,0)
 .K DGLY,DGMTP,IVMDAP,IVMDAS,IVMDAZ,IVMDGLY,IVMFLG7,IVMFLGC,IVMMT31,IVMMTDT,IVMMTIEN,IVMSEG,IVMSEG1,IVMSTAT,IVMTEXT,XMSUB,FMDATE,MTDATE
"RTN","IVMPRECZ",107,0)
 .Q
"RTN","IVMPRECZ",108,0)
 Q
"VER")
8.0^22
**END**
**END**
