Released DG*5.3*579 SEQ #523
Extracted from mail message
**KIDS**:DG*5.3*579^

**INSTALL NAME**
DG*5.3*579
"BLD",5353,0)
DG*5.3*579^REGISTRATION^0^3040718^y
"BLD",5353,1,0)
^^5^5^3040204^
"BLD",5353,1,1,0)
This patch will prevent the DG MEANS TEST SUPERVISOR MENU's Purge 
"BLD",5353,1,2,0)
Duplicates option from purging IVM Converted Tests that appear to be bad
"BLD",5353,1,3,0)
duplicates.  These tests were flipped to NOT PRIMARY and this utility
"BLD",5353,1,4,0)
will flip them back to PRIMARY prior to purging any duplicate Income 
"BLD",5353,1,5,0)
tests.
"BLD",5353,4,0)
^9.64PA^^
"BLD",5353,"ABPKG")
n
"BLD",5353,"INID")
^n
"BLD",5353,"INIT")
POST^DG53558
"BLD",5353,"KRN",0)
^9.67PA^8989.52^19
"BLD",5353,"KRN",.4,0)
.4
"BLD",5353,"KRN",.401,0)
.401
"BLD",5353,"KRN",.402,0)
.402
"BLD",5353,"KRN",.403,0)
.403
"BLD",5353,"KRN",.5,0)
.5
"BLD",5353,"KRN",.84,0)
.84
"BLD",5353,"KRN",3.6,0)
3.6
"BLD",5353,"KRN",3.8,0)
3.8
"BLD",5353,"KRN",9.2,0)
9.2
"BLD",5353,"KRN",9.8,0)
9.8
"BLD",5353,"KRN",9.8,"NM",0)
^9.68A^2^2
"BLD",5353,"KRN",9.8,"NM",1,0)
DG53558^^0^B82762269
"BLD",5353,"KRN",9.8,"NM",2,0)
DG53558M^^0^B64120227
"BLD",5353,"KRN",9.8,"NM","B","DG53558",1)

"BLD",5353,"KRN",9.8,"NM","B","DG53558M",2)

"BLD",5353,"KRN",19,0)
19
"BLD",5353,"KRN",19.1,0)
19.1
"BLD",5353,"KRN",101,0)
101
"BLD",5353,"KRN",409.61,0)
409.61
"BLD",5353,"KRN",771,0)
771
"BLD",5353,"KRN",870,0)
870
"BLD",5353,"KRN",8989.51,0)
8989.51
"BLD",5353,"KRN",8989.52,0)
8989.52
"BLD",5353,"KRN",8994,0)
8994
"BLD",5353,"KRN","B",.4,.4)

"BLD",5353,"KRN","B",.401,.401)

"BLD",5353,"KRN","B",.402,.402)

"BLD",5353,"KRN","B",.403,.403)

"BLD",5353,"KRN","B",.5,.5)

"BLD",5353,"KRN","B",.84,.84)

"BLD",5353,"KRN","B",3.6,3.6)

"BLD",5353,"KRN","B",3.8,3.8)

"BLD",5353,"KRN","B",9.2,9.2)

"BLD",5353,"KRN","B",9.8,9.8)

"BLD",5353,"KRN","B",19,19)

"BLD",5353,"KRN","B",19.1,19.1)

"BLD",5353,"KRN","B",101,101)

"BLD",5353,"KRN","B",409.61,409.61)

"BLD",5353,"KRN","B",771,771)

"BLD",5353,"KRN","B",870,870)

"BLD",5353,"KRN","B",8989.51,8989.51)

"BLD",5353,"KRN","B",8989.52,8989.52)

"BLD",5353,"KRN","B",8994,8994)

"BLD",5353,"QUES",0)
^9.62^^
"BLD",5353,"REQB",0)
^9.611^1^1
"BLD",5353,"REQB",1,0)
DG*5.3*558^1
"BLD",5353,"REQB","B","DG*5.3*558",1)

"INIT")
POST^DG53558
"MBREQ")
0
"PKG",5,-1)
1^1
"PKG",5,0)
REGISTRATION^DG^PATIENT REGISTRATION, ADMISSION, DISCHARGE, EMBOSSER 
"PKG",5,20,0)
^9.402P^^
"PKG",5,22,0)
^9.49I^1^1
"PKG",5,22,1,0)
5.3^2930813
"PKG",5,22,1,"PAH",1,0)
579^3040718
"PKG",5,22,1,"PAH",1,1,0)
^^5^5^3040718
"PKG",5,22,1,"PAH",1,1,1,0)
This patch will prevent the DG MEANS TEST SUPERVISOR MENU's Purge 
"PKG",5,22,1,"PAH",1,1,2,0)
Duplicates option from purging IVM Converted Tests that appear to be bad
"PKG",5,22,1,"PAH",1,1,3,0)
duplicates.  These tests were flipped to NOT PRIMARY and this utility
"PKG",5,22,1,"PAH",1,1,4,0)
will flip them back to PRIMARY prior to purging any duplicate Income 
"PKG",5,22,1,"PAH",1,1,5,0)
tests.
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","DG53558")
0^1^B82762269
"RTN","DG53558",1,0)
DG53558 ;ALB/GN - DG*5.3*558 CLEANUP FOR DUPE MEANS TEST FILE ; 7/16/04 11:17am
"RTN","DG53558",2,0)
 ;;5.3;Registration;**558,579**;Aug 13, 1993
"RTN","DG53558",3,0)
 ;
"RTN","DG53558",4,0)
 ; Read through the Mean Test file (#408.31) via the "C" xref.
"RTN","DG53558",5,0)
 ; Search for duplicate & Bad tests and delete them.  Duplicates are
"RTN","DG53558",6,0)
 ; defined as more than one test for the same patient for the same day
"RTN","DG53558",7,0)
 ; and the same status.  All dupes but the primary test will be
"RTN","DG53558",8,0)
 ; deleted and when no primary test on a given day then the last
"RTN","DG53558",9,0)
 ; transmission for that day will be kept
"RTN","DG53558",10,0)
 ;
"RTN","DG53558",11,0)
 ; Bad tests are defined as those that have a NULL status code in
"RTN","DG53558",12,0)
 ; the 0 node of file 408.31.
"RTN","DG53558",13,0)
 ;
"RTN","DG53558",14,0)
 ; DG*5.3*579 - changes were made to fix a problem when future dated
"RTN","DG53558",15,0)
 ; tests come in and flip a test from Primary to Non-Primary.  This
"RTN","DG53558",16,0)
 ; should not be done for IVM converted cases.  This patch will
"RTN","DG53558",17,0)
 ; find those IVM tests and flip them back to Priamry and flip the
"RTN","DG53558",18,0)
 ; future test that caused this back to Non-Primary.
"RTN","DG53558",19,0)
 Q
"RTN","DG53558",20,0)
TEST ; Entry point for testing this routine
"RTN","DG53558",21,0)
 S TESTING=1
"RTN","DG53558",22,0)
EN ;  Entry point for purging Duplicate Means Tests
"RTN","DG53558",23,0)
 ;
"RTN","DG53558",24,0)
 N QUIT,ZTDESC,ZTIO,ZTRTN,ZTSK,ZTQUEUED,ZTSAVE,CHKPNT
"RTN","DG53558",25,0)
 S CHKPNT=5
"RTN","DG53558",26,0)
 W !,"Do you want to process a group of "_CHKPNT_" duplicates and stop? "
"RTN","DG53558",27,0)
 K DIR
"RTN","DG53558",28,0)
 S DIR("?",1)="  Enter Y to process at least "_CHKPNT_" dupes and stop the utility.  This will "
"RTN","DG53558",29,0)
 S DIR("?",2)="  allow you to verify the cleanup in small steps.  Enter N to process the "
"RTN","DG53558",30,0)
 S DIR("?")="  remainder of the file to completion."
"RTN","DG53558",31,0)
 S DIR(0)="Y" D ^DIR
"RTN","DG53558",32,0)
 I $D(DTOUT)!$D(DUOUT) W !,"Cancelled...",! Q
"RTN","DG53558",33,0)
 ;
"RTN","DG53558",34,0)
 S:'Y CHKPNT=0                               ;do not use check points
"RTN","DG53558",35,0)
 ;
"RTN","DG53558",36,0)
 ; setup TM variables and Load 
"RTN","DG53558",37,0)
 S ZTRTN=$S($G(TESTING):"QUET^DG53558",1:"QUE^DG53558")
"RTN","DG53558",38,0)
 S ZTDESC="Cleanup Duplicates in the Means Test file"
"RTN","DG53558",39,0)
 S ZTIO=""
"RTN","DG53558",40,0)
 S ZTSAVE("CHKPNT")=""
"RTN","DG53558",41,0)
 ;
"RTN","DG53558",42,0)
 W !!,ZTDESC,!
"RTN","DG53558",43,0)
 ;check if already running or completed.
"RTN","DG53558",44,0)
 S QUIT=$$CHKSTAT(0)
"RTN","DG53558",45,0)
 Q:QUIT
"RTN","DG53558",46,0)
 D ^%ZTLOAD
"RTN","DG53558",47,0)
 L -^XTMP($$NAMSPC)
"RTN","DG53558",48,0)
 I $D(ZTSK) D
"RTN","DG53558",49,0)
 . W !,"This request queued as Task # ",ZTSK,!
"RTN","DG53558",50,0)
 Q
"RTN","DG53558",51,0)
 ;
"RTN","DG53558",52,0)
POST ;
"RTN","DG53558",53,0)
 N ZTDTH,ZTDESC,ZTIO,ZTRTN,ZTSK,ZTQUEUED,ZTSAVE,CHKPNT
"RTN","DG53558",54,0)
 D MES^XPDUTL("")
"RTN","DG53558",55,0)
 D MES^XPDUTL("=====================================================")
"RTN","DG53558",56,0)
 D MES^XPDUTL("Queuing Dupe Income Test Purge Utility.....")
"RTN","DG53558",57,0)
 I $$CHKSTAT(1) D  Q
"RTN","DG53558",58,0)
 . D BMES^XPDUTL("ABORTING  Post Install Utility Queuing")
"RTN","DG53558",59,0)
 . D MES^XPDUTL("=====================================================")
"RTN","DG53558",60,0)
 S ZTRTN="QUE^DG53558"
"RTN","DG53558",61,0)
 S ZTDESC="Cleanup Duplicates in the Means Test file"
"RTN","DG53558",62,0)
 S ZTIO="",ZTDTH=$H
"RTN","DG53558",63,0)
 S CHKPNT=0,ZTSAVE("CHKPNT")=""
"RTN","DG53558",64,0)
 D ^%ZTLOAD
"RTN","DG53558",65,0)
 L -^XTMP($$NAMSPC)
"RTN","DG53558",66,0)
 D MES^XPDUTL("This request queued as Task # "_ZTSK)
"RTN","DG53558",67,0)
 D MES^XPDUTL("=====================================================")
"RTN","DG53558",68,0)
 D MES^XPDUTL("")
"RTN","DG53558",69,0)
 Q
"RTN","DG53558",70,0)
 ;
"RTN","DG53558",71,0)
QUET ; Entry point for taskman (testing mode)
"RTN","DG53558",72,0)
 S TESTING=1
"RTN","DG53558",73,0)
QUE ; Entry point for taskman (live mode)
"RTN","DG53558",74,0)
 N NAMSPC S NAMSPC=$$NAMSPC^DG53558
"RTN","DG53558",75,0)
 L +^XTMP(NAMSPC):10 I '$T D  Q   ;quit if can't get a lock
"RTN","DG53558",76,0)
 . S $P(^XTMP(NAMSPC,0,0),U,5)="NO LOCK GAINED"
"RTN","DG53558",77,0)
 N QQ,ZTSTOP,XREC,MTIEN,DIK,DA,IVMTOT,IVMPUR,BEGTIME,PURGDT,IVMBAD
"RTN","DG53558",78,0)
 N DFN,TMP,ICDT,MTST,IVMDUPE,COUNT,PRI,TYPE,TYPNAM,DELETED,IVMIEN,PRIM
"RTN","DG53558",79,0)
 N SRCE,TMPIVM,XX,IVMCV,MAX,IVMIEND,IVMPFL,LINK,LTYP,LTNAM
"RTN","DG53558",80,0)
 S TESTING=+$G(TESTING)
"RTN","DG53558",81,0)
 ;
"RTN","DG53558",82,0)
 ;get last run info if exists
"RTN","DG53558",83,0)
 S XREC=$G(^XTMP(NAMSPC,0,0))
"RTN","DG53558",84,0)
 S DFN=$P(XREC,U,1)         ;last REC processed
"RTN","DG53558",85,0)
 S IVMTOT=+$P(XREC,U,2)          ;total records processed
"RTN","DG53558",86,0)
 S IVMPUR=+$P(XREC,U,3)          ;total dupe records purged
"RTN","DG53558",87,0)
 S IVMBAD=+$P(XREC,U,7)          ;total bad records purged
"RTN","DG53558",88,0)
 S IVMPFL=+$P(XREC,U,8)          ;total PRIM records fliped
"RTN","DG53558",89,0)
 S IVMDUPE=IVMPUR
"RTN","DG53558",90,0)
 ;
"RTN","DG53558",91,0)
 ;setup XTMP according to stds. & for 60 day expiration
"RTN","DG53558",92,0)
 D SETUPX^DG53558M(60)
"RTN","DG53558",93,0)
 ;
"RTN","DG53558",94,0)
 ;init status field and start date & time if null
"RTN","DG53558",95,0)
 S $P(^XTMP(NAMSPC,0,0),U,5,6)="RUNNING^"
"RTN","DG53558",96,0)
 S:$P(^XTMP(NAMSPC,0,0),U,4)="" $P(^XTMP(NAMSPC,0,0),U,4)=$$NOW^XLFDT
"RTN","DG53558",97,0)
 ;
"RTN","DG53558",98,0)
 ;drive through "C" XREF level of  MT  file
"RTN","DG53558",99,0)
 S ZTSTOP=0,DELETED=0
"RTN","DG53558",100,0)
 F QQ=1:1 S DFN=$O(^DGMT(408.31,"C",DFN)) Q:'DFN  D  Q:ZTSTOP
"RTN","DG53558",101,0)
 . I $G(CHKPNT)>1,IVMPUR>IVMDUPE,IVMPUR-CHKPNT>IVMDUPE S ZTSTOP=1 Q
"RTN","DG53558",102,0)
 . K TMP,TMPIVM
"RTN","DG53558",103,0)
 . S IVMTOT=IVMTOT+1
"RTN","DG53558",104,0)
 . ;
"RTN","DG53558",105,0)
 . ;build local TMP and prioritize dupes
"RTN","DG53558",106,0)
 . S MTIEN=0
"RTN","DG53558",107,0)
 . F  S MTIEN=$O(^DGMT(408.31,"C",DFN,MTIEN)) Q:'MTIEN  D
"RTN","DG53558",108,0)
 . . I '$D(^DGMT(408.31,MTIEN,0)) K ^DGMT(408.31,"C",DFN,MTIEN) Q
"RTN","DG53558",109,0)
 . . S ICDT=$P(^DGMT(408.31,MTIEN,0),"^",1)
"RTN","DG53558",110,0)
 . . S MTST=$P(^DGMT(408.31,MTIEN,0),"^",3)
"RTN","DG53558",111,0)
 . . S PRI=+$G(^DGMT(408.31,MTIEN,"PRIM"))
"RTN","DG53558",112,0)
 . . S SRCE=+$P(^DGMT(408.31,MTIEN,0),"^",23)
"RTN","DG53558",113,0)
 . . S MAX=0
"RTN","DG53558",114,0)
 . . S:$D(^DGMT(408.31,MTIEN,"C")) MAX=$O(^DGMT(408.31,MTIEN,"C",""),-1)
"RTN","DG53558",115,0)
 . . S IVMCV=0               ;init IVM converted flag to no DG*5.3*579
"RTN","DG53558",116,0)
 . . F XX=1:1:MAX D  Q:IVMCV
"RTN","DG53558",117,0)
 . . . S:^DGMT(408.31,MTIEN,"C",XX,0)["Z06 MT via Edb" IVMCV=1
"RTN","DG53558",118,0)
 . . I SRCE=2,IVMCV D                     ;IVM converted test from EDB
"RTN","DG53558",119,0)
 . . . S TMPIVM(DFN,ICDT,MTST)=MTIEN,TMPIVM(DFN,ICDT)=MTIEN
"RTN","DG53558",120,0)
 . . . S PRI=1                            ;set as PRIMARY
"RTN","DG53558",121,0)
 . . ;
"RTN","DG53558",122,0)
 . . ;test for null MT status & flag as BAD and delete
"RTN","DG53558",123,0)
 . . I MTST="" D  Q
"RTN","DG53558",124,0)
 . . . S TYPE=$P($G(^DGMT(408.31,MTIEN,0)),"^",19),TYPNAM=""
"RTN","DG53558",125,0)
 . . . S:TYPE]"" TYPNAM=$G(^DG(408.33,TYPE,0))
"RTN","DG53558",126,0)
 . . . D DELBAD(MTIEN,DFN,.IVMBAD,.DELETED)
"RTN","DG53558",127,0)
 . . . Q:'DELETED
"RTN","DG53558",128,0)
 . . . S ^XTMP(NAMSPC,DFN,ICDT,999999,MTIEN,"BAD")=TYPE
"RTN","DG53558",129,0)
 . . . S ^XTMP(NAMSPC_".DET",DFN,ICDT,MTIEN,"BAD")=TYPNAM
"RTN","DG53558",130,0)
 . . . S $P(^XTMP(NAMSPC,0,0),U,7)=IVMBAD
"RTN","DG53558",131,0)
 . . ;
"RTN","DG53558",132,0)
 . . S COUNT=+$G(TMP(DFN,ICDT,MTST))+1
"RTN","DG53558",133,0)
 . . S TMP(DFN,ICDT,MTST)=COUNT
"RTN","DG53558",134,0)
 . . S TMP(DFN,ICDT,MTST,MTIEN)=PRI
"RTN","DG53558",135,0)
 . . S:PRI TMP(DFN,ICDT,MTST,"P")=MTIEN
"RTN","DG53558",136,0)
 . ;
"RTN","DG53558",137,0)
 . ;drive thru TMP and delete all dupes, but last one per day per sts
"RTN","DG53558",138,0)
 . S ICDT=""
"RTN","DG53558",139,0)
 . F  S ICDT=$O(TMP(DFN,ICDT)) Q:ICDT=""  D
"RTN","DG53558",140,0)
 . . S MTST=""
"RTN","DG53558",141,0)
 . . ;
"RTN","DG53558",142,0)
 . . ;if this is the IVM test that is set to not prim, then flip it
"RTN","DG53558",143,0)
 . . S IVMIEND=$G(TMPIVM(DFN,ICDT))                        ;DG*5.3*579
"RTN","DG53558",144,0)
 . . I IVMIEND D
"RTN","DG53558",145,0)
 . . . D SETPRIM(IVMIEND,1,.IVMPFL)
"RTN","DG53558",146,0)
 . . . S LINK=$P($G(^DGMT(408.31,IVMIEND,2)),"^",6)
"RTN","DG53558",147,0)
 . . . D:LINK SETPRIM(LINK,1,.IVMPFL)     ;set any linked test to PRIM
"RTN","DG53558",148,0)
 . . ;
"RTN","DG53558",149,0)
 . . F  S MTST=$O(TMP(DFN,ICDT,MTST)) Q:MTST=""  D
"RTN","DG53558",150,0)
 . . . ;keep at least one test per day per status, even if not PRIM
"RTN","DG53558",151,0)
 . . . D:'$D(TMP(DFN,ICDT,MTST,"P")) SETPRI(.TMP)
"RTN","DG53558",152,0)
 . . . ;    drive thru ien's and del dupes
"RTN","DG53558",153,0)
 . . . S MTIEN=0
"RTN","DG53558",154,0)
 . . . F  S MTIEN=$O(TMP(DFN,ICDT,MTST,MTIEN)) Q:'MTIEN  D
"RTN","DG53558",155,0)
 . . . . S PRIM=$G(^DGMT(408.31,MTIEN,"PRIM"))
"RTN","DG53558",156,0)
 . . . . S LINK=$P($G(^DGMT(408.31,MTIEN,2)),"^",6)
"RTN","DG53558",157,0)
 . . . . ;
"RTN","DG53558",158,0)
 . . . . ;if this ien is primary & it is not the IVM test or Linked to
"RTN","DG53558",159,0)
 . . . . ;the IVM test, then it should be flipped back to Not Primary
"RTN","DG53558",160,0)
 . . . . I IVMIEND,PRIM,MTIEN'=IVMIEND,LINK'=IVMIEND D     ;DG*5.3*579
"RTN","DG53558",161,0)
 . . . . . D SETPRIM(MTIEN,0,.IVMPFL)
"RTN","DG53558",162,0)
 . . . . . S TMP(DFN,ICDT,MTST,MTIEN)=0
"RTN","DG53558",163,0)
 . . . . ;
"RTN","DG53558",164,0)
 . . . . I TMP(DFN,ICDT,MTST,"P")'=MTIEN D
"RTN","DG53558",165,0)
 . . . . . S TYPE=$P($G(^DGMT(408.31,MTIEN,0)),"^",19),TYPNAM=""
"RTN","DG53558",166,0)
 . . . . . S:TYPE]"" TYPNAM=$G(^DG(408.33,TYPE,0))
"RTN","DG53558",167,0)
 . . . . . D DELMT^DG53558M(MTIEN,DFN,.IVMPUR,.DELETED,.LINK)
"RTN","DG53558",168,0)
 . . . . . Q:'DELETED
"RTN","DG53558",169,0)
 . . . . . S ^XTMP(NAMSPC_".DET",DFN,ICDT,MTIEN)=TYPNAM
"RTN","DG53558",170,0)
 . . . . . I LINK,'$D(^DGMT(408.31,LINK,0)) S LINK=0
"RTN","DG53558",171,0)
 . . . . . Q:'LINK
"RTN","DG53558",172,0)
 . . . . . S LTYP=$P($G(^DGMT(408.31,LINK,0)),"^",19),LTNAM=""
"RTN","DG53558",173,0)
 . . . . . S:LTYP LTNAM=$G(^DG(408.33,LTYP,0))
"RTN","DG53558",174,0)
 . . . . . S ^XTMP(NAMSPC_".DET",DFN,ICDT,LINK)=LTNAM
"RTN","DG53558",175,0)
 . . . . M ^XTMP(NAMSPC,DFN,ICDT,MTST)=TMP(DFN,ICDT,MTST)
"RTN","DG53558",176,0)
 . ;
"RTN","DG53558",177,0)
 . ;update last processed info
"RTN","DG53558",178,0)
 . S $P(^XTMP(NAMSPC,0,0),U,1,3)=DFN_U_IVMTOT_U_IVMPUR
"RTN","DG53558",179,0)
 . S $P(^XTMP(NAMSPC,0,0),U,7,8)=IVMBAD_U_IVMPFL
"RTN","DG53558",180,0)
 . ;
"RTN","DG53558",181,0)
 . ;check for stop request after every 100 processed DFN recs
"RTN","DG53558",182,0)
 . I QQ#100=0 D
"RTN","DG53558",183,0)
 . . S:$$S^%ZTLOAD ZTSTOP=1
"RTN","DG53558",184,0)
 . . I $D(^XTMP(NAMSPC,0,"STOP")) S ZTSTOP=1 K ^XTMP(NAMSPC,0,"STOP")
"RTN","DG53558",185,0)
 ;
"RTN","DG53558",186,0)
 ;set status and mail stats
"RTN","DG53558",187,0)
 I ZTSTOP S $P(^XTMP(NAMSPC,0,0),U,5,6)="STOPPED"_U_$$NOW^XLFDT
"RTN","DG53558",188,0)
 E  S $P(^XTMP(NAMSPC,0,0),U,5,6)="COMPLETED"_U_$$NOW^XLFDT
"RTN","DG53558",189,0)
 D MAIL^DG53558M
"RTN","DG53558",190,0)
 K TESTING
"RTN","DG53558",191,0)
 L -^XTMP($$NAMSPC)
"RTN","DG53558",192,0)
 Q
"RTN","DG53558",193,0)
 ;
"RTN","DG53558",194,0)
 ;DG*5.3*579
"RTN","DG53558",195,0)
SETPRIM(DA,PR,IVMP) ; set an Income Test (in #408.31) to either Prim or Not
"RTN","DG53558",196,0)
 Q:'$D(DA)!'$D(PR)
"RTN","DG53558",197,0)
 N DR,DIE,DGDATA,DGPRI
"RTN","DG53558",198,0)
 S DGPRI=$G(^DGMT(408.31,DA,"PRIM"))
"RTN","DG53558",199,0)
 Q:DGPRI=PR                               ;quit if already at that sts
"RTN","DG53558",200,0)
 S IVMP=$G(IVMP)+1
"RTN","DG53558",201,0)
 S DGDATA="FLIPPED TO "_$S(PR=0:"NOT PRIMARY",1:"PRIMARY")
"RTN","DG53558",202,0)
 S:$D(NAMSPC) ^XTMP(NAMSPC_".DET",DFN,ICDT,DA)=DGDATA
"RTN","DG53558",203,0)
 S DR="2////"_PR,DIE="^DGMT(408.31,"
"RTN","DG53558",204,0)
 D:'$G(TESTING) ^DIE
"RTN","DG53558",205,0)
 Q
"RTN","DG53558",206,0)
 ;
"RTN","DG53558",207,0)
SETPRI(TMP) ;indicate like a primary (in TMP) to avoid it from being deleted
"RTN","DG53558",208,0)
 N IEN
"RTN","DG53558",209,0)
 S IEN=$O(TMP(DFN,ICDT,MTST,""),-1)
"RTN","DG53558",210,0)
 S TMP(DFN,ICDT,MTST,IEN)=1
"RTN","DG53558",211,0)
 S TMP(DFN,ICDT,MTST,"P")=IEN
"RTN","DG53558",212,0)
 Q
"RTN","DG53558",213,0)
 ;
"RTN","DG53558",214,0)
DELBAD(IEN,DFN,PUR,DELETED) ; Kill Bad test
"RTN","DG53558",215,0)
 S DELETED=0
"RTN","DG53558",216,0)
 Q:'$G(IEN)
"RTN","DG53558",217,0)
 S TESTING=+$G(TESTING,1),DFN=$G(DFN)
"RTN","DG53558",218,0)
 I 'TESTING S DELETED=$$DEL^DG53558M(IEN,.LINK,DFN)
"RTN","DG53558",219,0)
 S:TESTING DELETED=1
"RTN","DG53558",220,0)
 Q:'DELETED
"RTN","DG53558",221,0)
 S IVMBAD=IVMBAD+1
"RTN","DG53558",222,0)
 I '$D(ZTQUEUED) W !,"Deleting BAD IEN in 408.31 > ",IEN," for DFN > ",DFN
"RTN","DG53558",223,0)
 Q
"RTN","DG53558",224,0)
 ;
"RTN","DG53558",225,0)
CHKSTAT(POST) ;check if job is running, stopped, or completed
"RTN","DG53558",226,0)
 N Y,DUOUT,DTOUT,QUIT,STAT,STIME,NAMSPC
"RTN","DG53558",227,0)
 S QUIT=0
"RTN","DG53558",228,0)
 S NAMSPC=$$NAMSPC
"RTN","DG53558",229,0)
 L +^XTMP(NAMSPC):1
"RTN","DG53558",230,0)
 I '$T D BMES^XPDUTL("*** ALREADY RUNNING ***") Q 1
"RTN","DG53558",231,0)
 ;
"RTN","DG53558",232,0)
 ; get job status
"RTN","DG53558",233,0)
 S STAT=$P($G(^XTMP(NAMSPC,0,0)),U,5)
"RTN","DG53558",234,0)
 S STIME=$P($G(^XTMP(NAMSPC,0,0)),U,6)
"RTN","DG53558",235,0)
 ;
"RTN","DG53558",236,0)
 I POST D KILIT Q 0                                     ;DG*5.3*579
"RTN","DG53558",237,0)
 ;
"RTN","DG53558",238,0)
 ;if job Completed and run from menu opt, ask to Re-Run
"RTN","DG53558",239,0)
 I STAT="COMPLETED" D
"RTN","DG53558",240,0)
 . W " was Completed on "_$$FMTE^XLFDT(STIME)
"RTN","DG53558",241,0)
 . W !,"  Do you want to Re-Run again?"
"RTN","DG53558",242,0)
 . K DIR
"RTN","DG53558",243,0)
 . S DIR("?",1)="  Entering Y, will delete the XTMP global where the previous cleanup"
"RTN","DG53558",244,0)
 . S DIR("?")="  information was stored and begin a new job, or N to cancel request"
"RTN","DG53558",245,0)
 . S DIR(0)="Y" D ^DIR
"RTN","DG53558",246,0)
 . I 'Y S QUIT=1 Q
"RTN","DG53558",247,0)
 . W !," ARE YOU SURE?"
"RTN","DG53558",248,0)
 . K DIR
"RTN","DG53558",249,0)
 . S DIR("?")="Enter Y to begin a new Job or N to cancel request"
"RTN","DG53558",250,0)
 . S DIR(0)="Y" D ^DIR
"RTN","DG53558",251,0)
 . I 'Y S QUIT=1 Q
"RTN","DG53558",252,0)
 . ;fall thru to re-run mode, kill ^XTMPs
"RTN","DG53558",253,0)
 . D KILIT
"RTN","DG53558",254,0)
 Q QUIT
"RTN","DG53558",255,0)
 ;
"RTN","DG53558",256,0)
KILIT ; kill Xtmp work files for a re-run
"RTN","DG53558",257,0)
 S:'$D(NAMSPC) NAMSPC=$$NAMSPC^DG53558
"RTN","DG53558",258,0)
 K ^XTMP(NAMSPC),^XTMP(NAMSPC_".DET")
"RTN","DG53558",259,0)
 Q
"RTN","DG53558",260,0)
 ;
"RTN","DG53558",261,0)
STOP ; alternate stop method
"RTN","DG53558",262,0)
 S ^XTMP($$NAMSPC,0,"STOP")=""
"RTN","DG53558",263,0)
 Q
"RTN","DG53558",264,0)
 ;
"RTN","DG53558",265,0)
NAMSPC() ; Return a consistent name space variable
"RTN","DG53558",266,0)
 Q "DG53558"
"RTN","DG53558M")
0^2^B64120227
"RTN","DG53558M",1,0)
DG53558M ;ALB/GN - DG*5.3*558 CLEANUP UTILITES ; 7/16/04 11:14am
"RTN","DG53558M",2,0)
 ;;5.3;Registration;**558,579**;Aug 13, 1993
"RTN","DG53558M",3,0)
 ;
"RTN","DG53558M",4,0)
 ;DG*53.*579 - add line for records modified vs. deleted ones
"RTN","DG53558M",5,0)
 ; Misc cleanup utilities
"RTN","DG53558M",6,0)
 ;
"RTN","DG53558M",7,0)
DELMT(IEN,DFN,PUR,DELETED,LINK) ; Kill duplicate MT
"RTN","DG53558M",8,0)
 S DELETED=0
"RTN","DG53558M",9,0)
 Q:'$G(IEN)
"RTN","DG53558M",10,0)
 S TESTING=+$G(TESTING,1),DFN=$G(DFN)
"RTN","DG53558M",11,0)
 S DELETED=$$DEL^DG53558M(IEN,.LINK,DFN)
"RTN","DG53558M",12,0)
 Q:'DELETED
"RTN","DG53558M",13,0)
 S PUR=PUR+1
"RTN","DG53558M",14,0)
 I '$D(ZTQUEUED) W !,"Deleting Dupe IEN in 408.31 > ",IEN," for DFN > ",DFN
"RTN","DG53558M",15,0)
 Q
"RTN","DG53558M",16,0)
 ;
"RTN","DG53558M",17,0)
DEL(IVMMTIEN,IVMLINK,DFN) ; delete 408.31 ien only, no income related files killed here
"RTN","DG53558M",18,0)
 ; input: ien to be deleted
"RTN","DG53558M",19,0)
 ; output: 1 = was deleted
"RTN","DG53558M",20,0)
 ;         0 = was not deleted
"RTN","DG53558M",21,0)
 N DA,DIK,IVMTYP
"RTN","DG53558M",22,0)
 S DFN=$G(DFN)
"RTN","DG53558M",23,0)
 S IVMTYP=$P($G(^DGMT(408.31,IVMMTIEN,0)),"^",19)           ;test type
"RTN","DG53558M",24,0)
 S IVMLINK=$P($G(^DGMT(408.31,IVMMTIEN,2)),"^",6)
"RTN","DG53558M",25,0)
 ;don't delete copay test linked to valid means test directly
"RTN","DG53558M",26,0)
 I IVMTYP=2,IVMLINK,$D(^DGMT(408.31,IVMLINK,0)) Q 0
"RTN","DG53558M",27,0)
 ;
"RTN","DG53558M",28,0)
 S DA=IVMMTIEN,DIK="^DGMT(408.31," D:'$G(TESTING) ^DIK    ;del MT here
"RTN","DG53558M",29,0)
 D:DFN D4081275(DFN)
"RTN","DG53558M",30,0)
 ;
"RTN","DG53558M",31,0)
 ;delete linked RXCT here after above delete of the MT
"RTN","DG53558M",32,0)
 I IVMTYP=1,IVMLINK D
"RTN","DG53558M",33,0)
 . S DA=IVMLINK,DIK="^DGMT(408.31," D:'$G(TESTING) ^DIK
"RTN","DG53558M",34,0)
 . D:DFN D4081275(DFN)
"RTN","DG53558M",35,0)
 ;
"RTN","DG53558M",36,0)
 Q 1
"RTN","DG53558M",37,0)
 ;
"RTN","DG53558M",38,0)
D4081275(DFN) ; Deletes SPOUSE Effective date multiple entries that may exist
"RTN","DG53558M",39,0)
 ;      and point to the MT just deleted.
"RTN","DG53558M",40,0)
 ;
"RTN","DG53558M",41,0)
 Q:'$D(^DPT(DFN,0))
"RTN","DG53558M",42,0)
 N R12,EIEN,ENODE,QUIT,DA,DIK
"RTN","DG53558M",43,0)
 S R12=0
"RTN","DG53558M",44,0)
 F  S R12=$O(^DGPR(408.12,"B",DFN,R12)) Q:'R12  D
"RTN","DG53558M",45,0)
 . Q:$P($G(^DGPR(408.12,R12,0)),"^",2)'=2         ;only process spouse
"RTN","DG53558M",46,0)
 . ; drive through the Effective Date Multiple in ien reverse order
"RTN","DG53558M",47,0)
 . S EIEN="A",QUIT=0
"RTN","DG53558M",48,0)
 . F  S EIEN=$O(^DGPR(408.12,R12,"E",EIEN),-1) Q:'EIEN  D  Q:QUIT
"RTN","DG53558M",49,0)
 . . S ENODE=$G(^DGPR(408.12,R12,"E",EIEN,0))
"RTN","DG53558M",50,0)
 . . Q:+$P(ENODE,"^",2)                           ;active flag
"RTN","DG53558M",51,0)
 . . Q:'+$P(ENODE,"^",4)                          ;no MT ien
"RTN","DG53558M",52,0)
 . . Q:$D(^DGMT(408.31,$P(ENODE,"^",4),0))        ;points to valid MT
"RTN","DG53558M",53,0)
 . . ; if inactive and does not point to a valid MT, delete this
"RTN","DG53558M",54,0)
 . . ; effective date multiple rec from 408.1275
"RTN","DG53558M",55,0)
 . . S DA=EIEN,DA(1)=R12,DIK="^DGPR(408.12,"_DA(1)_",""E"","
"RTN","DG53558M",56,0)
 . . D:'$G(TESTING) ^DIK
"RTN","DG53558M",57,0)
 . . I '$D(ZTQUEUED) W !,"Deleting BAD 408.1275 > ",R12,",",EIEN
"RTN","DG53558M",58,0)
 . . S QUIT=1
"RTN","DG53558M",59,0)
 Q
"RTN","DG53558M",60,0)
 ;
"RTN","DG53558M",61,0)
MAIL ; mail stats
"RTN","DG53558M",62,0)
 N BTIME,HTEXT,TEXT,NAMSPC,LIN,TYPNAM,MSGNO,IVMBAD,IVMPUR,IVMTOT,IVMPFL
"RTN","DG53558M",63,0)
 S MSGNO=0
"RTN","DG53558M",64,0)
 S NAMSPC=$$NAMSPC^DG53558
"RTN","DG53558M",65,0)
 S IVMTOT=$P($G(^XTMP(NAMSPC,0,0)),U,2)
"RTN","DG53558M",66,0)
 S IVMPUR=$P($G(^XTMP(NAMSPC,0,0)),U,3)
"RTN","DG53558M",67,0)
 S BTIME=$P($G(^XTMP(NAMSPC,0,0)),U,4)
"RTN","DG53558M",68,0)
 S STAT=$P($G(^XTMP(NAMSPC,0,0)),U,5)
"RTN","DG53558M",69,0)
 S STIME=$P($G(^XTMP(NAMSPC,0,0)),U,6)
"RTN","DG53558M",70,0)
 S IVMBAD=$P($G(^XTMP(NAMSPC,0,0)),U,7)
"RTN","DG53558M",71,0)
 S IVMPFL=$P($G(^XTMP(NAMSPC,0,0)),U,8)
"RTN","DG53558M",72,0)
 ;
"RTN","DG53558M",73,0)
 D HDNG(.HTEXT,.MSGNO,.LIN)
"RTN","DG53558M",74,0)
 D SUMRY(.LIN)
"RTN","DG53558M",75,0)
 D MAILIT(HTEXT)
"RTN","DG53558M",76,0)
 ;
"RTN","DG53558M",77,0)
 D SNDDET
"RTN","DG53558M",78,0)
 Q
"RTN","DG53558M",79,0)
 ;
"RTN","DG53558M",80,0)
HDNG(HTEXT,MSGNO,LIN) ;build heading lines for mail message
"RTN","DG53558M",81,0)
 K ^TMP(NAMSPC,$J,"MSG")
"RTN","DG53558M",82,0)
 S LIN=0
"RTN","DG53558M",83,0)
 S HTEXT="Cleanup Dupes in the Means Test file "_STAT_" on "
"RTN","DG53558M",84,0)
 S HTEXT=HTEXT_$$FMTE^XLFDT(STIME)
"RTN","DG53558M",85,0)
 D BLDLINE(HTEXT,.LIN)
"RTN","DG53558M",86,0)
 D BLDLINE("",.LIN)
"RTN","DG53558M",87,0)
 I TESTING S TEXT="** TESTING **" D BLDLINE(TEXT,.LIN)
"RTN","DG53558M",88,0)
 I MSGNO S TEXT="Message number: "_MSGNO D BLDLINE(TEXT,.LIN)
"RTN","DG53558M",89,0)
 D BLDLINE("",.LIN)
"RTN","DG53558M",90,0)
 I MSGNO D
"RTN","DG53558M",91,0)
 . S TEXT="* = modified due to IVM Converted Test scenario"
"RTN","DG53558M",92,0)
 . D BLDLINE(TEXT,.LIN)                                    ;DG*5.3*579
"RTN","DG53558M",93,0)
 S MSGNO=MSGNO+1
"RTN","DG53558M",94,0)
 Q
"RTN","DG53558M",95,0)
 ;
"RTN","DG53558M",96,0)
SUMRY(LIN) ;build summary lines for mail message
"RTN","DG53558M",97,0)
 S TEXT="     Records Processed: "_$J($FN(IVMTOT,","),11)
"RTN","DG53558M",98,0)
 D BLDLINE(TEXT,.LIN)
"RTN","DG53558M",99,0)
 S TEXT="Duplicate Tests Purged: "_$J($FN(IVMPUR,","),11)
"RTN","DG53558M",100,0)
 D BLDLINE(TEXT,.LIN)
"RTN","DG53558M",101,0)
 S TEXT="     Null Tests Purged: "_$J($FN(IVMBAD,","),11)
"RTN","DG53558M",102,0)
 D BLDLINE(TEXT,.LIN)
"RTN","DG53558M",103,0)
 S TEXT="Primary status changed: "_$J($FN(IVMPFL,","),11)
"RTN","DG53558M",104,0)
 D BLDLINE(TEXT,.LIN)
"RTN","DG53558M",105,0)
 D BLDLINE("",.LIN)
"RTN","DG53558M",106,0)
 D BLDLINE("",.LIN)
"RTN","DG53558M",107,0)
 D BLDLINE("",.LIN)
"RTN","DG53558M",108,0)
 ;
"RTN","DG53558M",109,0)
 I (IVMPUR+IVMBAD+IVMPFL) D
"RTN","DG53558M",110,0)
 . D BLDLINE("Detail changes to follow in subsequent mail messages.",.LIN)
"RTN","DG53558M",111,0)
 Q
"RTN","DG53558M",112,0)
 ;
"RTN","DG53558M",113,0)
SNDDET ;build and send detail messages limit under 2000 lines each
"RTN","DG53558M",114,0)
 N BAD,DATE,GL,MAXLIN,MORE,NAME,SSN
"RTN","DG53558M",115,0)
 S MAXLIN=1995,MORE=0
"RTN","DG53558M",116,0)
 D HDNG(.HTEXT,.MSGNO,.LIN)
"RTN","DG53558M",117,0)
 ;
"RTN","DG53558M",118,0)
 S GL=$NA(^XTMP(NAMSPC_".DET",1)),TYPNAM=""
"RTN","DG53558M",119,0)
 F  S GL=$Q(@GL) Q:GL=""  Q:$QS(GL,1)'=(NAMSPC_".DET")  D
"RTN","DG53558M",120,0)
 . S MORE=1                             ;at least 1 more line to send
"RTN","DG53558M",121,0)
 . S DFN=$QS(GL,2)
"RTN","DG53558M",122,0)
 . S ICDT=$QS(GL,3)
"RTN","DG53558M",123,0)
 . S MTIEN=$QS(GL,4)
"RTN","DG53558M",124,0)
 . S BAD=$QS(GL,5)
"RTN","DG53558M",125,0)
 . S SSN=$P($G(^DPT(DFN,0)),"^",9),NAME=$P($G(^DPT(DFN,0)),"^")
"RTN","DG53558M",126,0)
 . S DATE=$$FMTE^XLFDT(ICDT)
"RTN","DG53558M",127,0)
 . S TYPNAM=$G(@GL)
"RTN","DG53558M",128,0)
 . S TEXT=$S(TYPNAM["PRIMARY":"* Prim> ",1:"  Dupe> ")
"RTN","DG53558M",129,0)
 . S:BAD="BAD" TEXT="  Null> "
"RTN","DG53558M",130,0)
 . S TEXT=TEXT_"ssn: "_SSN_" "_$J(TYPNAM,22)_"  date: "_DATE_"  ien: "_MTIEN
"RTN","DG53558M",131,0)
 . D BLDLINE(TEXT,.LIN)
"RTN","DG53558M",132,0)
 . ;max lines reached, print a msg
"RTN","DG53558M",133,0)
 . I LIN>MAXLIN D MAILIT(HTEXT),HDNG(.HTEXT,.MSGNO,.LIN) S MORE=0
"RTN","DG53558M",134,0)
 ;
"RTN","DG53558M",135,0)
 ;print final message if any to print
"RTN","DG53558M",136,0)
 D MAILIT(HTEXT):MORE
"RTN","DG53558M",137,0)
 Q
"RTN","DG53558M",138,0)
 ;
"RTN","DG53558M",139,0)
BLDLINE(TEXT,LIN) ;build a single line into TMP message global
"RTN","DG53558M",140,0)
 S LIN=LIN+1
"RTN","DG53558M",141,0)
 S ^TMP(NAMSPC,$J,"MSG",LIN)=TEXT
"RTN","DG53558M",142,0)
 Q
"RTN","DG53558M",143,0)
MAILIT(HTEXT) ; send the mail message
"RTN","DG53558M",144,0)
 N XMY,XMDUZ,XMSUB,XMTEXT
"RTN","DG53558M",145,0)
 S XMY(DUZ)="",XMDUZ=.5
"RTN","DG53558M",146,0)
 S XMSUB=HTEXT_" Results"
"RTN","DG53558M",147,0)
 S XMTEXT="^TMP(NAMSPC,$J,""MSG"","
"RTN","DG53558M",148,0)
 D ^XMD
"RTN","DG53558M",149,0)
 Q
"RTN","DG53558M",150,0)
 ;
"RTN","DG53558M",151,0)
MONITOR ; Monitor job while running
"RTN","DG53558M",152,0)
 N IOINORM,IOINHI,IOUON,IOUOFF,IOBON,IOBOFF,IORVON,IORVOFF,IOHOME
"RTN","DG53558M",153,0)
 N IOELEOL,NAMSPC,REC,IVMTOT,IVMPUR,STIME,IVMEND,RUN,IVMTOTAL,IVMLST
"RTN","DG53558M",154,0)
 N STAT,IVMLINE,IVMBLNK,NOWTIM,%H,DTOUT,I,IVMLEN,IVMQUIT,TITLE,TLEN,X
"RTN","DG53558M",155,0)
 N NOWTIME,PCT,TMP
"RTN","DG53558M",156,0)
 S:'$D(U) U="^"
"RTN","DG53558M",157,0)
 S NAMSPC=$$NAMSPC^DG53558
"RTN","DG53558M",158,0)
 S TMP=0 F IVMTOTAL=0:1 S TMP=$O(^DGMT(408.31,"C",TMP)) Q:'TMP
"RTN","DG53558M",159,0)
 S IVMQUIT=0
"RTN","DG53558M",160,0)
 D SCRNSET
"RTN","DG53558M",161,0)
 ;
"RTN","DG53558M",162,0)
 F  D  Q:IVMQUIT
"RTN","DG53558M",163,0)
 . ;check lock status
"RTN","DG53558M",164,0)
 . L +^XTMP(NAMSPC):0
"RTN","DG53558M",165,0)
 . I '$T S RUN=1
"RTN","DG53558M",166,0)
 . E  S RUN=0
"RTN","DG53558M",167,0)
 . L -^XTMP(NAMSPC)
"RTN","DG53558M",168,0)
 . S REC=$G(^XTMP(NAMSPC,0,0))
"RTN","DG53558M",169,0)
 . S STAT=$P(REC,U,5) S:STAT="" STAT="NOT RUNNING"
"RTN","DG53558M",170,0)
 . S IVMLST=$P(REC,U,1),IVMTOT=$P(REC,U,2),IVMPUR=$P(REC,U,3)
"RTN","DG53558M",171,0)
 . S STIME=$P(REC,U,6),IVMBAD=$P(REC,U,7)
"RTN","DG53558M",172,0)
 . S:IVMTOTAL>0 PCT=IVMTOT/IVMTOTAL
"RTN","DG53558M",173,0)
 . S PCT=PCT*100
"RTN","DG53558M",174,0)
 . S NOWTIME=$$NOW^XLFDT
"RTN","DG53558M",175,0)
 . I (RUN&(STAT'="RUNNING"))!('RUN&(STAT="RUNNING")) D
"RTN","DG53558M",176,0)
 . . S STAT="ERRORED"
"RTN","DG53558M",177,0)
 . D CLRSCR
"RTN","DG53558M",178,0)
 . S $P(IVMBLNK," ",81)=""
"RTN","DG53558M",179,0)
 . S IVMLINE=IVMBLNK
"RTN","DG53558M",180,0)
 . S TITLE="Cleanup Duplicates in the Means Test file"
"RTN","DG53558M",181,0)
 . S TLEN=(80-$L(TITLE)\2)
"RTN","DG53558M",182,0)
 . W $$FMTE^XLFDT($$NOW^XLFDT,"2P")
"RTN","DG53558M",183,0)
 . W ?65,"Completed ",$FN(PCT,"",0),"%",!!
"RTN","DG53558M",184,0)
 . W ?TLEN,IOINHI,IOUON,TITLE,IOUOFF,IOINORM,!
"RTN","DG53558M",185,0)
 . S IVMLINE=IVMBLNK
"RTN","DG53558M",186,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,4,"Status")
"RTN","DG53558M",187,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,12,"Total recs")
"RTN","DG53558M",188,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,24,"Dupes Purged")
"RTN","DG53558M",189,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,38,"Nulls Purged")
"RTN","DG53558M",190,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,52,"Last DFN")
"RTN","DG53558M",191,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,66,"Completed Time")
"RTN","DG53558M",192,0)
 . W !!,IORVON,IVMLINE,IORVOFF
"RTN","DG53558M",193,0)
 . S IVMLINE=IVMBLNK
"RTN","DG53558M",194,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,2,STAT)
"RTN","DG53558M",195,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,15,IVMTOT)
"RTN","DG53558M",196,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,28,IVMPUR)
"RTN","DG53558M",197,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,40,IVMBAD)
"RTN","DG53558M",198,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,52,IVMLST)
"RTN","DG53558M",199,0)
 . S IVMLINE=$$FMTLINE(IVMLINE,64,$$FMTE^XLFDT(STIME,2))
"RTN","DG53558M",200,0)
 . W !,IVMLINE
"RTN","DG53558M",201,0)
 . S IVMLINE=IVMBLNK
"RTN","DG53558M",202,0)
 . W !,IVMLINE,!!!!!!
"RTN","DG53558M",203,0)
 . K DIR
"RTN","DG53558M",204,0)
 . S DIR("T")=5
"RTN","DG53558M",205,0)
 . W ?13,"screen refreshes automatically every "_DIR("T")_" seconds",!
"RTN","DG53558M",206,0)
 . W !!,"Press "_IORVON_"<Enter>"_IORVOFF_" to Stop Monitor...",!
"RTN","DG53558M",207,0)
 . S DIR(0)="EA"
"RTN","DG53558M",208,0)
 . D ^DIR
"RTN","DG53558M",209,0)
 . I '$D(DTOUT) S IVMQUIT=1
"RTN","DG53558M",210,0)
 . I STAT'="RUNNING" S IVMQUIT=1
"RTN","DG53558M",211,0)
 W @IOF
"RTN","DG53558M",212,0)
 Q
"RTN","DG53558M",213,0)
 ;
"RTN","DG53558M",214,0)
FMTLINE(IVMLINE,IVMTB,IVMTX) ; format a line
"RTN","DG53558M",215,0)
 S IVMLEN=$L(IVMTX)
"RTN","DG53558M",216,0)
 S IVMEND=IVMTB+IVMLEN-1
"RTN","DG53558M",217,0)
 S $E(IVMLINE,IVMTB,IVMEND)=IVMTX
"RTN","DG53558M",218,0)
 Q IVMLINE
"RTN","DG53558M",219,0)
 ;
"RTN","DG53558M",220,0)
SCRNSET ; setup screen variables
"RTN","DG53558M",221,0)
 S:'$D(IOST(0)) IOST(0)="C-VT320"
"RTN","DG53558M",222,0)
 S X="IOINORM;IOINHI;IOUON;IOUOFF;IOBON;IOBOFF;IORVON;IORVOFF;IOHOME"
"RTN","DG53558M",223,0)
 S X=X_";IOELEOL" D ENDR^%ZISS
"RTN","DG53558M",224,0)
 Q
"RTN","DG53558M",225,0)
 ;
"RTN","DG53558M",226,0)
CLRSCR ; clear screen and return to normal
"RTN","DG53558M",227,0)
 W IOHOME,IORVOFF,IOBOFF,IOUOFF,IOINORM,@IOF
"RTN","DG53558M",228,0)
 S $X=0,$Y=0
"RTN","DG53558M",229,0)
 Q
"RTN","DG53558M",230,0)
 ;
"RTN","DG53558M",231,0)
SETUPX(EXPDAY) ;Setup XTMP's according to standards and set expiration days
"RTN","DG53558M",232,0)
 N BEGTIME,PURGDT,NAMSPC
"RTN","DG53558M",233,0)
 S NAMSPC=$$NAMSPC^DG53558
"RTN","DG53558M",234,0)
 S BEGTIME=$$NOW^XLFDT()
"RTN","DG53558M",235,0)
 S PURGDT=$$FMADD^XLFDT(BEGTIME,EXPDAY)
"RTN","DG53558M",236,0)
 S ^XTMP(NAMSPC,0)=PURGDT_U_BEGTIME
"RTN","DG53558M",237,0)
 S $P(^XTMP(NAMSPC,0),U,3)="Cleanup Duplicate Means Test File"
"RTN","DG53558M",238,0)
 S ^XTMP(NAMSPC_".DET",0)=PURGDT_U_BEGTIME
"RTN","DG53558M",239,0)
 S $P(^XTMP(NAMSPC_".DET",0),U,3)="Cleanup Duplicate Means Test File detail"
"RTN","DG53558M",240,0)
 Q
"VER")
8.0^22
**END**
**END**
