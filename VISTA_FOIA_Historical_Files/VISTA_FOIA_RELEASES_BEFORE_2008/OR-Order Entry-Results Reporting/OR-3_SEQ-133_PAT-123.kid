Released OR*3*123 SEQ #133
Extracted from mail message
**KIDS**:OR*3.0*123^

**INSTALL NAME**
OR*3.0*123
"BLD",3318,0)
OR*3.0*123^ORDER ENTRY/RESULTS REPORTING^0^3020513^y
"BLD",3318,4,0)
^9.64PA^^
"BLD",3318,"ABPKG")
n
"BLD",3318,"KRN",0)
^9.67PA^8989.52^19
"BLD",3318,"KRN",.4,0)
.4
"BLD",3318,"KRN",.401,0)
.401
"BLD",3318,"KRN",.402,0)
.402
"BLD",3318,"KRN",.403,0)
.403
"BLD",3318,"KRN",.5,0)
.5
"BLD",3318,"KRN",.84,0)
.84
"BLD",3318,"KRN",3.6,0)
3.6
"BLD",3318,"KRN",3.8,0)
3.8
"BLD",3318,"KRN",9.2,0)
9.2
"BLD",3318,"KRN",9.8,0)
9.8
"BLD",3318,"KRN",9.8,"NM",0)
^9.68A^6^6
"BLD",3318,"KRN",9.8,"NM",1,0)
ORKCHK6^^0^B26709108
"BLD",3318,"KRN",9.8,"NM",2,0)
ORKCHK5^^0^B20855689
"BLD",3318,"KRN",9.8,"NM",3,0)
ORKCHK4^^0^B26167816
"BLD",3318,"KRN",9.8,"NM",4,0)
ORKCHK2^^0^B4748185
"BLD",3318,"KRN",9.8,"NM",5,0)
ORKCHK^^0^B32357006
"BLD",3318,"KRN",9.8,"NM",6,0)
ORKPS^^0^B68389235
"BLD",3318,"KRN",9.8,"NM","B","ORKCHK",5)

"BLD",3318,"KRN",9.8,"NM","B","ORKCHK2",4)

"BLD",3318,"KRN",9.8,"NM","B","ORKCHK4",3)

"BLD",3318,"KRN",9.8,"NM","B","ORKCHK5",2)

"BLD",3318,"KRN",9.8,"NM","B","ORKCHK6",1)

"BLD",3318,"KRN",9.8,"NM","B","ORKPS",6)

"BLD",3318,"KRN",19,0)
19
"BLD",3318,"KRN",19.1,0)
19.1
"BLD",3318,"KRN",101,0)
101
"BLD",3318,"KRN",409.61,0)
409.61
"BLD",3318,"KRN",771,0)
771
"BLD",3318,"KRN",870,0)
870
"BLD",3318,"KRN",8989.51,0)
8989.51
"BLD",3318,"KRN",8989.52,0)
8989.52
"BLD",3318,"KRN",8994,0)
8994
"BLD",3318,"KRN","B",.4,.4)

"BLD",3318,"KRN","B",.401,.401)

"BLD",3318,"KRN","B",.402,.402)

"BLD",3318,"KRN","B",.403,.403)

"BLD",3318,"KRN","B",.5,.5)

"BLD",3318,"KRN","B",.84,.84)

"BLD",3318,"KRN","B",3.6,3.6)

"BLD",3318,"KRN","B",3.8,3.8)

"BLD",3318,"KRN","B",9.2,9.2)

"BLD",3318,"KRN","B",9.8,9.8)

"BLD",3318,"KRN","B",19,19)

"BLD",3318,"KRN","B",19.1,19.1)

"BLD",3318,"KRN","B",101,101)

"BLD",3318,"KRN","B",409.61,409.61)

"BLD",3318,"KRN","B",771,771)

"BLD",3318,"KRN","B",870,870)

"BLD",3318,"KRN","B",8989.51,8989.51)

"BLD",3318,"KRN","B",8989.52,8989.52)

"BLD",3318,"KRN","B",8994,8994)

"BLD",3318,"QUES",0)
^9.62^^
"BLD",3318,"REQB",0)
^9.611^2^2
"BLD",3318,"REQB",1,0)
OR*3.0*105^2
"BLD",3318,"REQB",2,0)
PSO*7.0*81^2
"BLD",3318,"REQB","B","OR*3.0*105",1)

"BLD",3318,"REQB","B","PSO*7.0*81",2)

"MBREQ")
0
"PKG",110,-1)
1^1
"PKG",110,0)
ORDER ENTRY/RESULTS REPORTING^OR^Order Entry/Results Reporting
"PKG",110,20,0)
^9.402P^^
"PKG",110,22,0)
^9.49I^1^1
"PKG",110,22,1,0)
3.0^2971217
"PKG",110,22,1,"PAH",1,0)
123^3020513
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","ORKCHK")
0^5^B32357006
"RTN","ORKCHK",1,0)
ORKCHK ; slc/CLA - Main routine called by OE/RR to initiate order checks ;7/24/96  17:55
"RTN","ORKCHK",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,94,105,123**;Dec 17, 1997
"RTN","ORKCHK",3,0)
EN(ORKY,ORKDFN,ORKA,ORKMODE) ;initiate order checking
"RTN","ORKCHK",4,0)
 ;ORKY: array of returned msgs in format: ornum^orderchk ien^clin danger^msg
"RTN","ORKCHK",5,0)
 ;ORKDFN: patient dfn
"RTN","ORKCHK",6,0)
 ;ORKA: array of order information in the format:
"RTN","ORKCHK",7,0)
 ; orderable item ien|
"RTN","ORKCHK",8,0)
 ; display group-filler app|
"RTN","ORKCHK",9,0)
 ; nat'l id^nat'l text^nat'l code sys^local id^local text^local code sys|
"RTN","ORKCHK",10,0)
 ; effective d/t|
"RTN","ORKCHK",11,0)
 ; order number|
"RTN","ORKCHK",12,0)
 ; filler data (LR: specimen ien, PS: meds prev ordered during this session in format med1^med2^...)
"RTN","ORKCHK",13,0)
 ;ORKMODE: mode/event trigger (DISPLAY,SELECT,ACCEPT,SESSION,ALL,NOTIF)
"RTN","ORKCHK",14,0)
 ; PS: meds previously ordered during this session med1^med2^...
"RTN","ORKCHK",15,0)
 ;
"RTN","ORKCHK",16,0)
 N ORKQ,ORKN S ORKQ=0,ORKN=1
"RTN","ORKCHK",17,0)
 S:+$G(ORKDFN)<1 ORKY(ORKN)="^^^Order Checking Unavailable - invalid patient id",ORKQ=1,ORKN=ORKN+1
"RTN","ORKCHK",18,0)
 S:'$L($G(ORKMODE)) ORKY(ORKN)="^^^Order Checking Unavailable - invalid mode/event",ORKQ=1,ORKN=ORKN+1
"RTN","ORKCHK",19,0)
 Q:$G(ORKQ)=1
"RTN","ORKCHK",20,0)
 Q:+$G(ORKA)<1
"RTN","ORKCHK",21,0)
 N ORKX,ORKS,DNGR,ORENT,ORKENT,ORKNENT,ORNUM,ORKOFF,ORKTMODE
"RTN","ORKCHK",22,0)
 N ORKADUZ,ORKNDUZ,ORKI,ORKPRIM,ORKNMSG,ORKMSG,ORKLOG,ORKLD,ORKLI,ORKOI
"RTN","ORKCHK",23,0)
 N ORKDG,ORKLPS,ORKPSA,ORKCNT,ORKDGI
"RTN","ORKCHK",24,0)
 ;
"RTN","ORKCHK",25,0)
 ;save array of orders for use in session processing:
"RTN","ORKCHK",26,0)
 M ^TMP("ORKA",$J)=ORKA
"RTN","ORKCHK",27,0)
 ;
"RTN","ORKCHK",28,0)
 ;get patient's location flag (INPATIENT ONLY - outpt locations cannot be
"RTN","ORKCHK",29,0)
 ;reliably determined, and many simultaneous outpt locations can occur):
"RTN","ORKCHK",30,0)
 N DFN,ORKLOC
"RTN","ORKCHK",31,0)
 S DFN=ORKDFN,VA200="" D OERR^VADPT
"RTN","ORKCHK",32,0)
 S ORKLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKCHK",33,0)
 K VA200,VAIN
"RTN","ORKCHK",34,0)
 ;
"RTN","ORKCHK",35,0)
 ;get user's service/section flag:
"RTN","ORKCHK",36,0)
 N ORKSRV
"RTN","ORKCHK",37,0)
 S ORKSRV=$G(^VA(200,DUZ,5)) I +ORKSRV>0 S ORKSRV=$P(ORKSRV,U)
"RTN","ORKCHK",38,0)
 ;
"RTN","ORKCHK",39,0)
 ;log order check debug messages (or not)
"RTN","ORKCHK",40,0)
 S ORKLOG=$$GET^XPAR("DIV^SYS^PKG","ORK DEBUG ENABLE/DISABLE",1,"I")
"RTN","ORKCHK",41,0)
 I $G(ORKLOG)="D" K ^XTMP("ORKLOG") S ^XTMP("ORKLOG",0)=""
"RTN","ORKCHK",42,0)
 I +$P($G(^XTMP("ORKLOG",0)),U,3)>5000 K ^XTMP("ORKLOG")
"RTN","ORKCHK",43,0)
 ;
"RTN","ORKCHK",44,0)
 ;if SESSION mode & pharmacy order occurred in session get unsigned med orders
"RTN","ORKCHK",45,0)
 I ORKMODE="SESSION" D
"RTN","ORKCHK",46,0)
 .S ORKDG=$P(ORKA(1),"|",2)
"RTN","ORKCHK",47,0)
 .I $E($G(ORKDG),1,2)="PS" D
"RTN","ORKCHK",48,0)
 ..S ORKDGI=0,ORKDGI=$O(^ORD(100.98,"B","PHARMACY",ORKDGI))
"RTN","ORKCHK",49,0)
 ..K ^TMP("ORR",$J)
"RTN","ORKCHK",50,0)
 ..D EN^ORQ1(DFN_";DPT(",ORKDGI,11,"","","",0,0)
"RTN","ORKCHK",51,0)
 ..;store unsigned med orders in ^TMP("ORR",$J for processing in ORKPS
"RTN","ORKCHK",52,0)
 ;
"RTN","ORKCHK",53,0)
 ;main processing loop:
"RTN","ORKCHK",54,0)
 S ORKX="" F  S ORKX=$O(ORKA(ORKX)) Q:ORKX=""  D
"RTN","ORKCHK",55,0)
 .S ORKOI=$P(ORKA(ORKX),"|")
"RTN","ORKCHK",56,0)
 .;
"RTN","ORKCHK",57,0)
 .;log debug msgs if parameter is enabled:
"RTN","ORKCHK",58,0)
 .I $G(ORKLOG)="E" D
"RTN","ORKCHK",59,0)
 ..S ORKLD=$$NOW^XLFDT
"RTN","ORKCHK",60,0)
 ..S ORKLI=0
"RTN","ORKCHK",61,0)
 ..I +$P($G(^XTMP("ORKLOG",0)),U,3)<1 S $P(^XTMP("ORKLOG",0),U,3)=0
"RTN","ORKCHK",62,0)
 ..S ORKCNT=$P(^XTMP("ORKLOG",0),U,3)+1
"RTN","ORKCHK",63,0)
 ..S ^XTMP("ORKLOG",0)=$$FMADD^XLFDT(ORKLD,3,"","","")_U_ORKLD_U_ORKCNT
"RTN","ORKCHK",64,0)
 ..S ^XTMP("ORKLOG",ORKLD,ORKDFN,+$G(ORKOI),ORKMODE,DUZ,ORKLI)=ORKA(ORKX)
"RTN","ORKCHK",65,0)
 .;
"RTN","ORKCHK",66,0)
 .S ORKDG=$P(ORKA(ORKX),"|",2),ORKTMODE=""
"RTN","ORKCHK",67,0)
 .S ORKENT="USR^LOC.`"_+$G(ORKLOC)_"^SRV.`"_+$G(ORKSRV)_"^DIV^SYS^PKG"
"RTN","ORKCHK",68,0)
 .Q:'$L($G(ORKDG))
"RTN","ORKCHK",69,0)
 .;
"RTN","ORKCHK",70,0)
 .;if pharmacy order and multiple pharmacy orders in session add data node:
"RTN","ORKCHK",71,0)
 .I $E(ORKDG,1,2)="PS",($L($G(ORKPSA))) D
"RTN","ORKCHK",72,0)
 ..S $P(ORKA(ORKX),"|",6)=ORKPSA
"RTN","ORKCHK",73,0)
 .;
"RTN","ORKCHK",74,0)
 .S ORNUM=$P(ORKA(ORKX),"|",5)
"RTN","ORKCHK",75,0)
 .; get correct DUZ for notification processing if in NOTIF mode:
"RTN","ORKCHK",76,0)
 .I ORKMODE="NOTIF" D
"RTN","ORKCHK",77,0)
 ..S:+$G(ORNUM)>0 ORKNDUZ=$$ORDERER^ORQOR2(ORNUM) ;ordering provider
"RTN","ORKCHK",78,0)
 ..S:+$G(ORNUM)<1 ORKNDUZ=$P($$PRIM^ORQPTQ4(ORKDFN),U) ;prim provider
"RTN","ORKCHK",79,0)
 ..I +$G(ORKNDUZ)>0 D
"RTN","ORKCHK",80,0)
 ...S ORKSRV=$G(^VA(200,ORKNDUZ,5)) I +ORKSRV>0 S ORKSRV=$P(ORKSRV,U)
"RTN","ORKCHK",81,0)
 ...S ORKNENT="USR.`"_+ORKNDUZ_"^LOC.`"_+$G(ORKLOC)_"^SRV.`"_+$G(ORKSRV)_"^DIV^SYS^PKG"
"RTN","ORKCHK",82,0)
 ..S:+$G(ORKNDUZ)<1 ORKNENT="LOC.`"_+$G(ORKLOC)_"^DIV^SYS^PKG"
"RTN","ORKCHK",83,0)
 .S ORENT=$S(ORKMODE="NOTIF":ORKNENT,1:ORKENT)
"RTN","ORKCHK",84,0)
 .;
"RTN","ORKCHK",85,0)
 .;If the order is a delayed release order (NOTIF) process all nodes.
"RTN","ORKCHK",86,0)
 .;If it is a renewal, edit or delayed signature order (ALL) process all
"RTN","ORKCHK",87,0)
 .;modes except SESSION which gets processed just before signature:
"RTN","ORKCHK",88,0)
 .I ORKMODE="NOTIF"!(ORKMODE="ALL") S ORKTMODE=ORKMODE D
"RTN","ORKCHK",89,0)
 ..D EN^ORKCHK3(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)  ;DISPLAY
"RTN","ORKCHK",90,0)
 ..D EN^ORKCHK4(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)  ;SELECT
"RTN","ORKCHK",91,0)
 ..D EN^ORKCHK5(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)  ;ACCEPT
"RTN","ORKCHK",92,0)
 ..I ORKMODE="NOTIF" D EN^ORKCHK6(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)  ;SESSION
"RTN","ORKCHK",93,0)
 ..S ORKMODE=ORKTMODE
"RTN","ORKCHK",94,0)
 .;
"RTN","ORKCHK",95,0)
 .;Process regular orders/modes:
"RTN","ORKCHK",96,0)
 .I '$L($G(ORKTMODE)) D
"RTN","ORKCHK",97,0)
 ..I ORKMODE="DISPLAY" D EN^ORKCHK3(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)
"RTN","ORKCHK",98,0)
 ..I ORKMODE="SELECT" D EN^ORKCHK4(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)
"RTN","ORKCHK",99,0)
 ..I ORKMODE="ACCEPT" D EN^ORKCHK5(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)
"RTN","ORKCHK",100,0)
 ..I ORKMODE="SESSION" D EN^ORKCHK6(.ORKS,ORKDFN,ORKA(ORKX),ORENT,ORKTMODE)
"RTN","ORKCHK",101,0)
 ;
"RTN","ORKCHK",102,0)
 ;set messages into sorting array then into ORKY ORKS("ORK",clinical danger level,oi,msg)=ornum^order check ien^clin danger level^message
"RTN","ORKCHK",103,0)
 S ORKX="",ORKI=1
"RTN","ORKCHK",104,0)
 F  S ORKX=$O(ORKS("ORK",ORKX)) Q:ORKX=""  D
"RTN","ORKCHK",105,0)
 .S ORKY(ORKI)=$E(ORKS("ORK",ORKX),1,250)
"RTN","ORKCHK",106,0)
 .;
"RTN","ORKCHK",107,0)
 .;log debug msgs if parameter is enabled:
"RTN","ORKCHK",108,0)
 .I $G(ORKLOG)="E" D
"RTN","ORKCHK",109,0)
 ..S ORKLI=$G(ORKLI)+1
"RTN","ORKCHK",110,0)
 ..S ^XTMP("ORKLOG",$$NOW^XLFDT,ORKDFN,+$G(ORKOI),ORKMODE,DUZ,ORKLI)=ORKY(ORKI)
"RTN","ORKCHK",111,0)
 ..S $P(^XTMP("ORKLOG",0),U,3)=$P($G(^XTMP("ORKLOG",0)),U,3)+1
"RTN","ORKCHK",112,0)
 .;
"RTN","ORKCHK",113,0)
 .;send moderate and high danger order checks for delayed orders as notifications:
"RTN","ORKCHK",114,0)
 .I ORKMODE="NOTIF" S DNGR=$P(ORKY(ORKI),U,3) I $G(DNGR)<3 D
"RTN","ORKCHK",115,0)
 ..S ORKADUZ="",ORNUM=$P(ORKY(ORKI),U)
"RTN","ORKCHK",116,0)
 ..S:+$G(ORKNDUZ)>0 ORKADUZ(ORKNDUZ)=""
"RTN","ORKCHK",117,0)
 ..S ORKNMSG="Order check: "_$P(ORKY(ORKI),U,4)
"RTN","ORKCHK",118,0)
 ..D EN^ORB3(54,ORKDFN,$G(ORNUM),.ORKADUZ,ORKNMSG,"")
"RTN","ORKCHK",119,0)
 .S ORKI=ORKI+1
"RTN","ORKCHK",120,0)
 ;
"RTN","ORKCHK",121,0)
 K ^TMP("ORKA",$J),^TMP("ORR",$J)
"RTN","ORKCHK",122,0)
 I $G(ORKLOG)="E" D
"RTN","ORKCHK",123,0)
 .S ORKLI=$G(ORKLI)+1
"RTN","ORKCHK",124,0)
 .S ^XTMP("ORKLOG",$$NOW^XLFDT,ORKDFN,+$G(ORKOI),ORKMODE,DUZ,ORKLI)="LEAVING ORDER CHECKING"
"RTN","ORKCHK",125,0)
 .S $P(^XTMP("ORKLOG",0),U,3)=$P($G(^XTMP("ORKLOG",0)),U,3)+1
"RTN","ORKCHK",126,0)
 Q
"RTN","ORKCHK",127,0)
 ;
"RTN","ORKCHK",128,0)
OI2DD(ORPSA,OROI,ORPSPKG)       ;rtn dispense drugs for a PS OI
"RTN","ORKCHK",129,0)
 N PSOI
"RTN","ORKCHK",130,0)
 Q:'$D(^ORD(101.43,OROI,0))
"RTN","ORKCHK",131,0)
 S PSOI=$P($P(^ORD(101.43,OROI,0),U,2),";")
"RTN","ORKCHK",132,0)
 Q:+$G(PSOI)<1
"RTN","ORKCHK",133,0)
 D DRG^PSSUTIL1(.ORPSA,PSOI,ORPSPKG)
"RTN","ORKCHK",134,0)
 Q
"RTN","ORKCHK2")
0^4^B4748185
"RTN","ORKCHK2",1,0)
ORKCHK2 ; slc/CLA - Order Checking support routine to do OCX-related order checks ;8/8/96 [ 04/02/97  1:08 PM ]
"RTN","ORKCHK2",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,123**;Dec 17, 1997
"RTN","ORKCHK2",3,0)
 Q
"RTN","ORKCHK2",4,0)
 ;
"RTN","ORKCHK2",5,0)
MLM(ORKS,ORKDFN,ORKA,ENT,ORKMODE) ;perform expert system-based order checking
"RTN","ORKCHK2",6,0)
 ;ORKS - return sort array of order checks
"RTN","ORKCHK2",7,0)
 ;ORKDFN - patient id
"RTN","ORKCHK2",8,0)
 ;ORKA - order information
"RTN","ORKCHK2",9,0)
 ;ENT - entity for parameter calls
"RTN","ORKCHK2",10,0)
 ;ORKMODE - ordering mode
"RTN","ORKCHK2",11,0)
 N ORKRTN,OCN,DNGR,ORKMSG,ORKTENT,ORNUM
"RTN","ORKCHK2",12,0)
 S ORKTENT=ENT
"RTN","ORKCHK2",13,0)
 S ORNUM=$P(ORKA,"|",5)
"RTN","ORKCHK2",14,0)
 D EN^OCXOEPS(.ORKRTN,ORKDFN,ORKA,ORKMODE)
"RTN","ORKCHK2",15,0)
 N ORKJ S ORKJ=""
"RTN","ORKCHK2",16,0)
 F  S ORKJ=$O(ORKRTN(ORKJ)) Q:ORKJ=""  D
"RTN","ORKCHK2",17,0)
 .S OCN=$P(ORKRTN(ORKJ),U,2)
"RTN","ORKCHK2",18,0)
 .Q:+$G(OCN)<1
"RTN","ORKCHK2",19,0)
 .S ENT=ORKTENT
"RTN","ORKCHK2",20,0)
 .I $$GET^XPAR(ENT,"ORK PROCESSING FLAG",OCN,"I")'="D" D
"RTN","ORKCHK2",21,0)
 ..I ORKMODE="DISPLAY" S DNGR=""
"RTN","ORKCHK2",22,0)
 ..E  S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK2",23,0)
 ..I ($P($G(^ORD(100.8,OCN,0)),U)="ERROR MESSAGE"),(ORKMODE="DISPLAY") D
"RTN","ORKCHK2",24,0)
 ...S ORKMSG="CPRS Expert System disabled. Some order checks cannot be performed."
"RTN","ORKCHK2",25,0)
 ..I $P($G(^ORD(100.8,OCN,0)),U)'="ERROR MESSAGE" S ORKMSG=$P(ORKRTN(ORKJ),U,4)
"RTN","ORKCHK2",26,0)
 ..Q:'$L($G(ORKMSG))
"RTN","ORKCHK2",27,0)
 ..S ORKS("ORK",DNGR_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG
"RTN","ORKCHK2",28,0)
 Q
"RTN","ORKCHK2",29,0)
 ;
"RTN","ORKCHK2",30,0)
OISESS(OI) ;check for Lab OI match in order array (ORA)
"RTN","ORKCHK2",31,0)
 N ORI,LRID,LRIDX,LRIDY,LROI,ORQ,X
"RTN","ORKCHK2",32,0)
 S ORQ=""
"RTN","ORKCHK2",33,0)
 ;get lab id from orderable item (OI):
"RTN","ORKCHK2",34,0)
 S LRID=$G(^ORD(101.43,OI,0)) Q:'$L(LRID) ORQ
"RTN","ORKCHK2",35,0)
 S LRID=$P(LRID,U,2),LRID=$P(LRID,";")
"RTN","ORKCHK2",36,0)
 S X=0 F  S X=$O(^TMP("ORKA",$J,X)) Q:X=""  D
"RTN","ORKCHK2",37,0)
 .S ORI=^TMP("ORKA",$J,X)
"RTN","ORKCHK2",38,0)
 .I $P(ORI,"|",2)="LR" D  ;lab order
"RTN","ORKCHK2",39,0)
 ..S LRIDX=$P($P(ORI,"|",3),U,4) I LRIDX=LRID S ORQ=1 Q  ;match
"RTN","ORKCHK2",40,0)
 ..S LROI=$P(ORI,"|")
"RTN","ORKCHK2",41,0)
 ..;get children lab ids and check against ordered array  ORL
"RTN","ORKCHK2",42,0)
 ..S LRIDY="" F  S LRIDY=$O(^ORD(101.43,LROI,10,"AID",LRIDY)) Q:LRIDY=""  D
"RTN","ORKCHK2",43,0)
 ...S LRIDX=$P(LRIDY,";") I LRIDX=LRID S ORQ=1 Q  ;match
"RTN","ORKCHK2",44,0)
 Q ORQ
"RTN","ORKCHK4")
0^3^B26167816
"RTN","ORKCHK4",1,0)
ORKCHK4 ; slc/CLA - Support routine called by ORKCHK to do SELECT mode order checks ;3/6/97  9:35
"RTN","ORKCHK4",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,87,94,123**;Dec 17, 1997
"RTN","ORKCHK4",3,0)
 Q
"RTN","ORKCHK4",4,0)
 ;
"RTN","ORKCHK4",5,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE) ;perform order checking for orderable item selection
"RTN","ORKCHK4",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK4",7,0)
 ;
"RTN","ORKCHK4",8,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK4",9,0)
 N ORKMSG,ORKT,ORKTXT
"RTN","ORKCHK4",10,0)
 ;
"RTN","ORKCHK4",11,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2)
"RTN","ORKCHK4",12,0)
 S HL7=$P(ORKA,"|",3),ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5)
"RTN","ORKCHK4",13,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK4",14,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK4",15,0)
 ;
"RTN","ORKCHK4",16,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK4",17,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SELECT")
"RTN","ORKCHK4",18,0)
 Q
"RTN","ORKCHK4",19,0)
 ;
"RTN","ORKCHK4",20,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK4",21,0)
 N ORPSPKG,ORPSA,ORKDD
"RTN","ORKCHK4",22,0)
 N ORCRITN,ORCRITF,ORCRITD,ORSIGN,ORSIGF,ORSIGD,ORDUPN,ORDUPF,ORDUPD,ORDUPCN,ORDUPCF,ORDUPCD
"RTN","ORKCHK4",23,0)
 ;
"RTN","ORKCHK4",24,0)
 D PARAMS("CRITICAL DRUG INTERACTION",.ORCRITN,.ORCRITF,.ORCRITD)
"RTN","ORKCHK4",25,0)
 D PARAMS("SIGNIFICANT DRUG INTERACTION",.ORSIGN,.ORSIGF,.ORSIGD)
"RTN","ORKCHK4",26,0)
 D PARAMS("DUPLICATE DRUG ORDER",.ORDUPN,.ORDUPF,.ORDUPD)
"RTN","ORKCHK4",27,0)
 D PARAMS("DUPLICATE DRUG CLASS ORDER",.ORDUPCN,.ORDUPCF,.ORDUPCD)
"RTN","ORKCHK4",28,0)
 ;
"RTN","ORKCHK4",29,0)
 ;dispense drug selected:
"RTN","ORKCHK4",30,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK4",31,0)
 .D RXOCS
"RTN","ORKCHK4",32,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SELECT")
"RTN","ORKCHK4",33,0)
 ;
"RTN","ORKCHK4",34,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK4",35,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK4",36,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK4",37,0)
 .I "IO"[ORPSPKG D OI2DD(.ORPSA,OI,ORPSPKG)
"RTN","ORKCHK4",38,0)
 .S ORKDD=0 F  S ORKDD=$O(ORPSA(ORKDD)) Q:'ORKDD  D
"RTN","ORKCHK4",39,0)
 ..S HL7LTXT=ORPSA(ORKDD)
"RTN","ORKCHK4",40,0)
 ..S HL7NPTR=$P(ORKDD,";",2)
"RTN","ORKCHK4",41,0)
 ..S HL7LPTR=+ORKDD
"RTN","ORKCHK4",42,0)
 ..S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK4",43,0)
 ..S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK4",44,0)
 ..S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK4",45,0)
 ..S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK4",46,0)
 ..D RXOCS
"RTN","ORKCHK4",47,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SELECT")
"RTN","ORKCHK4",48,0)
 Q
"RTN","ORKCHK4",49,0)
 ;
"RTN","ORKCHK4",50,0)
RXOCS ;drug-drug interaction, duplicate drug order, duplicate drug class
"RTN","ORKCHK4",51,0)
 Q:ORCRITF_ORSIGF_ORDUPF_ORDUPCF'["E"  ;quit if none are "E"nabled
"RTN","ORKCHK4",52,0)
 N ORKRX,ORPSNUM
"RTN","ORKCHK4",53,0)
 D CHECK^ORKPS(.ORKRX,ORKDFN,HL7LPTR,OI,ORKDG)
"RTN","ORKCHK4",54,0)
 N CHK,XX S CHK=0,XX=""
"RTN","ORKCHK4",55,0)
 F  S CHK=$O(ORKRX(CHK)) Q:'CHK  D
"RTN","ORKCHK4",56,0)
 .S XX=ORKRX(CHK)
"RTN","ORKCHK4",57,0)
 .;
"RTN","ORKCHK4",58,0)
 .;critical drug interaction:
"RTN","ORKCHK4",59,0)
 .I $P(XX,U)="DI",$P(XX,U,5)="CRITICAL" D  ;,(ORKTMODE'="ALL") D
"RTN","ORKCHK4",60,0)
 ..Q:ORCRITF="D"
"RTN","ORKCHK4",61,0)
 ..S ORPSNUM=$P(XX,U,8)  ;get the associated order number
"RTN","ORKCHK4",62,0)
 ..I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) S ORKT=$$TEXTSTAT^ORQOR1(+ORPSNUM),ORKTXT=$P(ORKT,U)_" ["_$P(ORKT,U,2)_"]"
"RTN","ORKCHK4",63,0)
 ..E  S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK4",64,0)
 ..S ORKMSG=$P(XX,U,5)_" drug-drug interaction: "_$P(XX,U,6)_" & "_$P(XX,U,7)
"RTN","ORKCHK4",65,0)
 ..S ORKS("ORK",ORCRITD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORCRITN_U_ORCRITD_U_ORKMSG_" ("_ORKTXT_")"_U_$G(ORPSNUM)
"RTN","ORKCHK4",66,0)
 .;
"RTN","ORKCHK4",67,0)
 .;significant drug interaction:
"RTN","ORKCHK4",68,0)
 .I $P(XX,U)="DI",$P(XX,U,5)="SIGNIFICANT" D  ;,(ORKTMODE'="ALL") D
"RTN","ORKCHK4",69,0)
 ..Q:ORSIGF="D"
"RTN","ORKCHK4",70,0)
 ..S ORPSNUM=$P(XX,U,8)  ;get the associated order number
"RTN","ORKCHK4",71,0)
 ..I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) S ORKT=$$TEXTSTAT^ORQOR1(+ORPSNUM),ORKTXT=$P(ORKT,U)_" ["_$P(ORKT,U,2)_"]"
"RTN","ORKCHK4",72,0)
 ..E  S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK4",73,0)
 ..S ORKMSG=$P(XX,U,5)_" drug-drug interaction: "_$P(XX,U,6)_" & "_$P(XX,U,7)
"RTN","ORKCHK4",74,0)
 ..S ORKS("ORK",ORSIGD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORSIGN_U_ORSIGD_U_ORKMSG_" ("_ORKTXT_")"_U_$G(ORPSNUM)
"RTN","ORKCHK4",75,0)
 .;
"RTN","ORKCHK4",76,0)
 .;duplicate drug:
"RTN","ORKCHK4",77,0)
 .I $P(XX,U)="DD" D  ;,(ORKTMODE'="ALL") D
"RTN","ORKCHK4",78,0)
 ..Q:ORDUPF="D"
"RTN","ORKCHK4",79,0)
 ..S ORPSNUM=$P(XX,U,4)  ;get the associated order number
"RTN","ORKCHK4",80,0)
 ..I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) S ORKT=$$TEXTSTAT^ORQOR1(+ORPSNUM),ORKTXT=$P(ORKT,U)_" ["_$P(ORKT,U,2)_"]"
"RTN","ORKCHK4",81,0)
 ..E  S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK4",82,0)
 ..S ORKMSG="Duplicate order: "_ORKTXT
"RTN","ORKCHK4",83,0)
 ..S ORKS("ORK",ORDUPD_","_$G(ORNUM)_","_ORPSNUM_",Duplicate order: "_$P(XX,U,3))=ORNUM_U_ORDUPN_U_ORDUPD_U_ORKMSG_U_$G(ORPSNUM)
"RTN","ORKCHK4",84,0)
 .;
"RTN","ORKCHK4",85,0)
 .;duplicate class:
"RTN","ORKCHK4",86,0)
 .I $P(XX,U)="DC" D  ;,(ORKTMODE'="ALL") D
"RTN","ORKCHK4",87,0)
 ..Q:ORDUPCF="D"
"RTN","ORKCHK4",88,0)
 ..S ORPSNUM=$P(XX,U,6)  ;get the associated order number
"RTN","ORKCHK4",89,0)
 ..I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) S ORKT=$$TEXTSTAT^ORQOR1(+ORPSNUM),ORKTXT=$P(ORKT,U)_" ["_$P(ORKT,U,2)_"]"
"RTN","ORKCHK4",90,0)
 ..E  S ORKTXT=$P(XX,U,5)
"RTN","ORKCHK4",91,0)
 ..S ORKMSG="Duplicate drug class order: "_$P(XX,U,3)
"RTN","ORKCHK4",92,0)
 ..S ORKS("ORK",ORDUPCD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORDUPCN_U_ORDUPCD_U_ORKMSG_" ("_ORKTXT_")"_U_$G(ORPSNUM)
"RTN","ORKCHK4",93,0)
 Q
"RTN","ORKCHK4",94,0)
 ;
"RTN","ORKCHK4",95,0)
OI2DD(ORPSA,OROI,ORPSPKG)       ;rtn dispense drugs for a PS OI
"RTN","ORKCHK4",96,0)
 N PSOI
"RTN","ORKCHK4",97,0)
 Q:'$D(^ORD(101.43,OROI,0))
"RTN","ORKCHK4",98,0)
 S PSOI=$P($P(^ORD(101.43,OROI,0),U,2),";")
"RTN","ORKCHK4",99,0)
 Q:+$G(PSOI)<1
"RTN","ORKCHK4",100,0)
 D DRG^PSSUTIL1(.ORPSA,PSOI,ORPSPKG)
"RTN","ORKCHK4",101,0)
 Q
"RTN","ORKCHK4",102,0)
 ;
"RTN","ORKCHK4",103,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK4",104,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK4",105,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK4",106,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK4",107,0)
 Q
"RTN","ORKCHK5")
0^2^B20855689
"RTN","ORKCHK5",1,0)
ORKCHK5 ; slc/CLA - Support routine called by ORKCHK to do ACCEPT mode order checks ;3/6/97  9:35
"RTN","ORKCHK5",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,94,123**;Dec 17, 1997
"RTN","ORKCHK5",3,0)
 Q
"RTN","ORKCHK5",4,0)
 ;
"RTN","ORKCHK5",5,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE) ;perform order checking for orderable item acceptance
"RTN","ORKCHK5",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK5",7,0)
 ;
"RTN","ORKCHK5",8,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK5",9,0)
 N OCN,DNGR,ORKMSG,ORKPDATA,ORKOCNUM
"RTN","ORKCHK5",10,0)
 ;
"RTN","ORKCHK5",11,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2),HL7=$P(ORKA,"|",3)
"RTN","ORKCHK5",12,0)
 S ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5),ORKPDATA=$P(ORKA,"|",6)
"RTN","ORKCHK5",13,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK5",14,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK5",15,0)
 I ORKDG="GMRC",'$L(ODT) S ODT=$$NOW^XLFDT  ;def consult order d/t is now
"RTN","ORKCHK5",16,0)
 ;
"RTN","ORKCHK5",17,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK5",18,0)
 I $E(ORKDG,1,2)'="PS",($E(ORKDG,1,2)'="LR"),($L($G(OI))),($L($G(ODT))),(ORKTMODE'="ALL") D DUPOR
"RTN","ORKCHK5",19,0)
 I $E(ORKDG,1,2)="LR",($L($G(OI))),($L($G(ODT))),(ORKTMODE'="ALL") D
"RTN","ORKCHK5",20,0)
 .D DUPLAB
"RTN","ORKCHK5",21,0)
 .D LABFREQ
"RTN","ORKCHK5",22,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",23,0)
 Q
"RTN","ORKCHK5",24,0)
 ;
"RTN","ORKCHK5",25,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK5",26,0)
 N ORPSPKG,ORPSA,ORKDD
"RTN","ORKCHK5",27,0)
 N ORALLRN,ORALLRF,ORALLRD
"RTN","ORKCHK5",28,0)
 D PARAMS("ALLERGY-DRUG INTERACTION",.ORALLRN,.ORALLRF,.ORALLRD)
"RTN","ORKCHK5",29,0)
 ;
"RTN","ORKCHK5",30,0)
 ;dispense drug selected:
"RTN","ORKCHK5",31,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK5",32,0)
 .D RXOCS
"RTN","ORKCHK5",33,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",34,0)
 ;
"RTN","ORKCHK5",35,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK5",36,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK5",37,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK5",38,0)
 .I "IO"[ORPSPKG D OI2DD(.ORPSA,OI,ORPSPKG)
"RTN","ORKCHK5",39,0)
 .S ORKDD=0 F  S ORKDD=$O(ORPSA(ORKDD)) Q:'ORKDD  D
"RTN","ORKCHK5",40,0)
 ..S HL7LTXT=ORPSA(ORKDD)
"RTN","ORKCHK5",41,0)
 ..S HL7NPTR=$P(ORKDD,";",2)
"RTN","ORKCHK5",42,0)
 ..S HL7LPTR=+ORKDD
"RTN","ORKCHK5",43,0)
 ..S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK5",44,0)
 ..S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK5",45,0)
 ..S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK5",46,0)
 ..S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK5",47,0)
 ..D RXOCS
"RTN","ORKCHK5",48,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"ACCEPT")
"RTN","ORKCHK5",49,0)
 Q
"RTN","ORKCHK5",50,0)
 ;
"RTN","ORKCHK5",51,0)
RXOCS ;drug-allergy interaction
"RTN","ORKCHK5",52,0)
 Q:ORALLRF="D"
"RTN","ORKCHK5",53,0)
 N ORKAL
"RTN","ORKCHK5",54,0)
 I $L($G(HL7NPTR)),($G(HL7NCOD)="99NDF") D
"RTN","ORKCHK5",55,0)
 .D RXN^ORQQAL(.ORKAL,ORKDFN,"DR",HL7NPTR,$G(HL7LPTR)) I (ORKAL>0) D
"RTN","ORKCHK5",56,0)
 ..S ORKMSG="Previous adverse reaction to: "_$P(ORKAL,U,2)
"RTN","ORKCHK5",57,0)
 ..S ORKS("ORK",ORALLRD_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_ORALLRN_U_ORALLRD_U_ORKMSG
"RTN","ORKCHK5",58,0)
 Q
"RTN","ORKCHK5",59,0)
 ;
"RTN","ORKCHK5",60,0)
OI2DD(ORPSA,OROI,ORPSPKG)       ;rtn dispense drugs for a PS OI
"RTN","ORKCHK5",61,0)
 N PSOI
"RTN","ORKCHK5",62,0)
 Q:'$D(^ORD(101.43,OROI,0))
"RTN","ORKCHK5",63,0)
 S PSOI=$P($P(^ORD(101.43,OROI,0),U,2),";")
"RTN","ORKCHK5",64,0)
 Q:+$G(PSOI)<1
"RTN","ORKCHK5",65,0)
 D DRG^PSSUTIL1(.ORPSA,PSOI,ORPSPKG)
"RTN","ORKCHK5",66,0)
 Q
"RTN","ORKCHK5",67,0)
 ;
"RTN","ORKCHK5",68,0)
DUPOR ;duplicate orders for non-pharmacy and non-lab:
"RTN","ORKCHK5",69,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","DUPLICATE ORDER",OCN))
"RTN","ORKCHK5",70,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",71,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",72,0)
 N ORKOR S ORKOR=0
"RTN","ORKCHK5",73,0)
 D DUP^ORKOR(.ORKOR,ORKDFN,OI,ODT,ORKDG) I (ORKOR>0) D
"RTN","ORKCHK5",74,0)
 .S ORKOCNUM=+$P(ORKOR,U)
"RTN","ORKCHK5",75,0)
 .S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",76,0)
 .S ORKMSG="Duplicate order: "_$P(ORKOR,U,2)
"RTN","ORKCHK5",77,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_ORKOCNUM_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG_U_ORKOCNUM
"RTN","ORKCHK5",78,0)
 Q
"RTN","ORKCHK5",79,0)
 ;
"RTN","ORKCHK5",80,0)
DUPLAB ;duplicate laboratory orders:
"RTN","ORKCHK5",81,0)
 N ORKLR,OCI
"RTN","ORKCHK5",82,0)
 S ORKLR=0,OCI=""
"RTN","ORKCHK5",83,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","DUPLICATE ORDER",OCN))
"RTN","ORKCHK5",84,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",85,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",86,0)
 S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",87,0)
 D DUP^ORKLR(.ORKLR,OI,ORKDFN,ODT,ORKPDATA)
"RTN","ORKCHK5",88,0)
 F  S OCI=$O(ORKLR(OCI)) Q:OCI=""  D
"RTN","ORKCHK5",89,0)
 .S ORKOCNUM=+$P(ORKLR(OCI),U)
"RTN","ORKCHK5",90,0)
 .S ORKMSG="Duplicate order: "_$P(ORKLR(OCI),U,2)
"RTN","ORKCHK5",91,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_ORKOCNUM_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG_U_ORKOCNUM
"RTN","ORKCHK5",92,0)
 Q
"RTN","ORKCHK5",93,0)
 ;
"RTN","ORKCHK5",94,0)
LABFREQ ;lab order frequency restrictions:
"RTN","ORKCHK5",95,0)
 N ORKLR,OCI
"RTN","ORKCHK5",96,0)
 S ORKLR=0,OCI=""
"RTN","ORKCHK5",97,0)
 S OCN=0,OCN=$O(^ORD(100.8,"B","LAB ORDER FREQ RESTRICTIONS",OCN))
"RTN","ORKCHK5",98,0)
 Q:+$G(OCN)<1
"RTN","ORKCHK5",99,0)
 Q:$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",OCN,"I")="D"
"RTN","ORKCHK5",100,0)
 S DNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",OCN,"I")
"RTN","ORKCHK5",101,0)
 D ORFREQ^ORKLR2(.ORKLR,OI,ORKDFN_";DPT(",ODT,ORKPDATA)
"RTN","ORKCHK5",102,0)
 S OCI="" F  S OCI=$O(ORKLR(OCI)) Q:OCI=""  D
"RTN","ORKCHK5",103,0)
 .S ORKMSG=$P(ORKLR(OCI),U,2)
"RTN","ORKCHK5",104,0)
 .S ORKS("ORK",DNGR_","_$G(ORNUM)_","_$E(ORKMSG,1,225))=ORNUM_U_OCN_U_DNGR_U_ORKMSG
"RTN","ORKCHK5",105,0)
 Q
"RTN","ORKCHK5",106,0)
 ;
"RTN","ORKCHK5",107,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK5",108,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK5",109,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK5",110,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK5",111,0)
 Q
"RTN","ORKCHK6")
0^1^B26709108
"RTN","ORKCHK6",1,0)
ORKCHK6 ; slc/CLA - Support routine called by ORKCHK to do SESSION mode order checks ;3/6/97  9:35
"RTN","ORKCHK6",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,87,94,123**;Dec 17, 1997
"RTN","ORKCHK6",3,0)
 Q
"RTN","ORKCHK6",4,0)
 ;
"RTN","ORKCHK6",5,0)
EN(ORKS,ORKDFN,ORKA,ORENT,ORKTMODE) ;perform order checking for entire ordering session
"RTN","ORKCHK6",6,0)
 Q:$$GET^XPAR("DIV^SYS^PKG","ORK SYSTEM ENABLE/DISABLE",1,"I")="D"
"RTN","ORKCHK6",7,0)
 ;
"RTN","ORKCHK6",8,0)
 N OI,ORKDG,HL7,ODT,ORNUM,HL7NPTR,HL7NTXT,HL7NCOD,HL7LPTR,HL7LTXT,HL7LCOD
"RTN","ORKCHK6",9,0)
 N ORKMSG,ORKDGI,ORKT,ORKTXT,ORKPDATA
"RTN","ORKCHK6",10,0)
 ;
"RTN","ORKCHK6",11,0)
 S OI=$P(ORKA,"|"),ORKDG=$P(ORKA,"|",2),HL7=$P(ORKA,"|",3)
"RTN","ORKCHK6",12,0)
 S ODT=$P(ORKA,"|",4),ORNUM=$P(ORKA,"|",5),ORKPDATA=$P(ORKA,"|",6)
"RTN","ORKCHK6",13,0)
 S HL7NPTR=$P(HL7,U),HL7NTXT=$P(HL7,U,2),HL7NCOD=$P(HL7,U,3)
"RTN","ORKCHK6",14,0)
 S HL7LPTR=$P(HL7,U,4),HL7LTXT=$P(HL7,U,5),HL7LCOD=$P(HL7,U,6)
"RTN","ORKCHK6",15,0)
 ;
"RTN","ORKCHK6",16,0)
 S:ORKDG="PSJ" ORKDG="PSI"
"RTN","ORKCHK6",17,0)
 I $E(ORKDG,1,2)="PS" D PHARM
"RTN","ORKCHK6",18,0)
 I $E(ORKDG,1,2)'="PS" D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",19,0)
 Q
"RTN","ORKCHK6",20,0)
 ;
"RTN","ORKCHK6",21,0)
PHARM ;process pharmacy order checks:
"RTN","ORKCHK6",22,0)
 N ORPSPKG,ORPSA,ORKDD
"RTN","ORKCHK6",23,0)
 N ORCRITN,ORCRITF,ORCRITD,ORSIGN,ORSIGF,ORSIGD,ORDUPN,ORDUPF,ORDUPD,ORDUPC,ORDUPCF,ORDUPCD
"RTN","ORKCHK6",24,0)
 ;
"RTN","ORKCHK6",25,0)
 D PARAMS("CRITICAL DRUG INTERACTION",.ORCRITN,.ORCRITF,.ORCRITD)
"RTN","ORKCHK6",26,0)
 D PARAMS("SIGNIFICANT DRUG INTERACTION",.ORSIGN,.ORSIGF,.ORSIGD)
"RTN","ORKCHK6",27,0)
 D PARAMS("DUPLICATE DRUG ORDER",.ORDUPN,.ORDUPF,.ORDUPD)
"RTN","ORKCHK6",28,0)
 D PARAMS("DUPLICATE DRUG CLASS ORDER",.ORDUPCN,.ORDUPCF,.ORDUPCD)
"RTN","ORKCHK6",29,0)
 ;
"RTN","ORKCHK6",30,0)
 ;dispense drug selected:
"RTN","ORKCHK6",31,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",32,0)
 .D RXOCS
"RTN","ORKCHK6",33,0)
 .D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",34,0)
 ;
"RTN","ORKCHK6",35,0)
 ;dispense drug NOT selected, split OI into dispense drugs:
"RTN","ORKCHK6",36,0)
 I '$L($G(HL7LPTR)) D
"RTN","ORKCHK6",37,0)
 .S ORPSPKG=$E(ORKDG,3)
"RTN","ORKCHK6",38,0)
 .I "IO"[ORPSPKG D OI2DD(.ORPSA,OI,ORPSPKG)
"RTN","ORKCHK6",39,0)
 .S ORKDD=0 F  S ORKDD=$O(ORPSA(ORKDD)) Q:'ORKDD  D
"RTN","ORKCHK6",40,0)
 ..S HL7LTXT=ORPSA(ORKDD)
"RTN","ORKCHK6",41,0)
 ..S HL7NPTR=$P(ORKDD,";",2)
"RTN","ORKCHK6",42,0)
 ..S HL7LPTR=+ORKDD
"RTN","ORKCHK6",43,0)
 ..S HL7LCOD="99PSD",HL7NCOD="99NDF"
"RTN","ORKCHK6",44,0)
 ..S $P(HL7,U)=HL7NPTR,$P(HL7,U,3)=HL7NCOD
"RTN","ORKCHK6",45,0)
 ..S $P(HL7,U,4)=HL7LPTR,$P(HL7,U,5)=HL7LTXT,$P(HL7,U,6)=HL7LCOD
"RTN","ORKCHK6",46,0)
 ..S $P(ORKA,"|",3)=HL7  ;set these for MLM OCX call
"RTN","ORKCHK6",47,0)
 ..D RXOCS
"RTN","ORKCHK6",48,0)
 ..D MLM^ORKCHK2(.ORKS,ORKDFN,ORKA,ORENT,"SESSION")
"RTN","ORKCHK6",49,0)
 Q
"RTN","ORKCHK6",50,0)
 ;
"RTN","ORKCHK6",51,0)
RXOCS ;drug-drug interaction, duplicate drug order, duplicate drug class
"RTN","ORKCHK6",52,0)
 Q:ORCRITF_ORSIGF_ORDUPF_ORDUPCF'["E"  ;quit if none are "E"nabled
"RTN","ORKCHK6",53,0)
 N ORKRX,ORPSNUM
"RTN","ORKCHK6",54,0)
 I $L($G(HL7LPTR)),($G(HL7LCOD)="99PSD") D
"RTN","ORKCHK6",55,0)
 .D CHKSESS^ORKPS(.ORKRX,ORKDFN,HL7LPTR,OI,ORKPDATA,ORKDG)
"RTN","ORKCHK6",56,0)
 .N CHK,XX S CHK=0,XX=""
"RTN","ORKCHK6",57,0)
 .F  S CHK=$O(ORKRX(CHK)) Q:'CHK  D
"RTN","ORKCHK6",58,0)
 ..S XX=ORKRX(CHK)
"RTN","ORKCHK6",59,0)
 ..;
"RTN","ORKCHK6",60,0)
 ..;critical drug interaction:
"RTN","ORKCHK6",61,0)
 ..I $P(XX,U)="DI",$P(XX,U,5)="CRITICAL" D
"RTN","ORKCHK6",62,0)
 ...Q:ORCRITF="D"
"RTN","ORKCHK6",63,0)
 ...S ORPSNUM=$P(XX,U,8)  ;get the associated order number
"RTN","ORKCHK6",64,0)
 ...I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) S ORKT=$$TEXTSTAT^ORQOR1(+ORPSNUM),ORKTXT=$P(ORKT,U)_" ["_$P(ORKT,U,2)_"]"
"RTN","ORKCHK6",65,0)
 ...E  S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK6",66,0)
 ...S ORKMSG=$P(XX,U,5)_" drug-drug interaction: "_$P(XX,U,6)_" & "_$P(XX,U,7)
"RTN","ORKCHK6",67,0)
 ...S ORKS("ORK",ORCRITD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORCRITN_U_ORCRITD_U_ORKMSG_" ("_ORKTXT_")"_U_$G(ORPSNUM)
"RTN","ORKCHK6",68,0)
 ..;
"RTN","ORKCHK6",69,0)
 ..;significant drug interaction:
"RTN","ORKCHK6",70,0)
 ..I $P(XX,U)="DI",$P(XX,U,5)="SIGNIFICANT" D
"RTN","ORKCHK6",71,0)
 ...Q:ORSIGF="D"
"RTN","ORKCHK6",72,0)
 ...S ORPSNUM=$P(XX,U,8)  ;get the associated order number
"RTN","ORKCHK6",73,0)
 ...I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) S ORKT=$$TEXTSTAT^ORQOR1(+ORPSNUM),ORKTXT=$P(ORKT,U)_" ["_$P(ORKT,U,2)_"]"
"RTN","ORKCHK6",74,0)
 ...E  S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK6",75,0)
 ...S ORKMSG=$P(XX,U,5)_" drug-drug interaction: "_$P(XX,U,6)_" & "_$P(XX,U,7)
"RTN","ORKCHK6",76,0)
 ...S ORKS("ORK",ORSIGD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORSIGN_U_ORSIGD_U_ORKMSG_" ("_ORKTXT_")"_U_$G(ORPSNUM)
"RTN","ORKCHK6",77,0)
 ..;
"RTN","ORKCHK6",78,0)
 ..;duplicate drug:
"RTN","ORKCHK6",79,0)
 ..I $P(XX,U)="DD" D
"RTN","ORKCHK6",80,0)
 ...Q:ORDUPF="D"
"RTN","ORKCHK6",81,0)
 ...S ORPSNUM=$P(XX,U,4)  ;get the associated order number
"RTN","ORKCHK6",82,0)
 ...I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) S ORKT=$$TEXTSTAT^ORQOR1(+ORPSNUM),ORKTXT=$P(ORKT,U)_" ["_$P(ORKT,U,2)_"]"
"RTN","ORKCHK6",83,0)
 ...E  S ORKTXT=$P(XX,U,3)
"RTN","ORKCHK6",84,0)
 ...S ORKMSG="Duplicate order: "_ORKTXT
"RTN","ORKCHK6",85,0)
 ...S ORKS("ORK",ORDUPD_","_$G(ORNUM)_","_ORPSNUM_",Duplicate order: "_$P(XX,U,3))=ORNUM_U_ORDUPN_U_ORDUPD_U_ORKMSG_U_$G(ORPSNUM)
"RTN","ORKCHK6",86,0)
 ..;
"RTN","ORKCHK6",87,0)
 ..;duplicate class:
"RTN","ORKCHK6",88,0)
 ..I $P(XX,U)="DC" D
"RTN","ORKCHK6",89,0)
 ...Q:ORDUPCF="D"
"RTN","ORKCHK6",90,0)
 ...S ORPSNUM=$P(XX,U,6)  ;get the associated order number
"RTN","ORKCHK6",91,0)
 ...I $L(ORPSNUM),$G(^OR(100,+ORPSNUM,0)) S ORKT=$$TEXTSTAT^ORQOR1(+ORPSNUM),ORKTXT=$P(ORKT,U)_" ["_$P(ORKT,U,2)_"]"
"RTN","ORKCHK6",92,0)
 ...E  S ORKTXT=$P(XX,U,5)
"RTN","ORKCHK6",93,0)
 ...S ORKMSG="Duplicate drug class order: "_$P(XX,U,3)
"RTN","ORKCHK6",94,0)
 ...S ORKS("ORK",ORDUPCD_","_$G(ORNUM)_","_ORPSNUM_","_$E(ORKMSG,1,225))=ORNUM_U_ORDUPCN_U_ORDUPCD_U_ORKMSG_" ("_ORKTXT_")"_U_$G(ORPSNUM)
"RTN","ORKCHK6",95,0)
 Q
"RTN","ORKCHK6",96,0)
 ;
"RTN","ORKCHK6",97,0)
OI2DD(ORPSA,OROI,ORPSPKG)       ;rtn dispense drugs for a PS OI
"RTN","ORKCHK6",98,0)
 N PSOI
"RTN","ORKCHK6",99,0)
 Q:'$D(^ORD(101.43,OROI,0))
"RTN","ORKCHK6",100,0)
 S PSOI=$P($P(^ORD(101.43,OROI,0),U,2),";")
"RTN","ORKCHK6",101,0)
 Q:+$G(PSOI)<1
"RTN","ORKCHK6",102,0)
 D DRG^PSSUTIL1(.ORPSA,PSOI,ORPSPKG)
"RTN","ORKCHK6",103,0)
 Q
"RTN","ORKCHK6",104,0)
 ;
"RTN","ORKCHK6",105,0)
PARAMS(ORKNAME,ORKNUM,ORKFLAG,ORKDNGR) ; get parameter values for an order chk
"RTN","ORKCHK6",106,0)
 S ORKNUM=0,ORKNUM=$O(^ORD(100.8,"B",ORKNAME,ORKNUM))
"RTN","ORKCHK6",107,0)
 S ORKFLAG=$$GET^XPAR(ORENT,"ORK PROCESSING FLAG",ORKNUM,"I")
"RTN","ORKCHK6",108,0)
 S ORKDNGR=$$GET^XPAR("DIV^SYS^PKG","ORK CLINICAL DANGER LEVEL",ORKNUM,"I")
"RTN","ORKCHK6",109,0)
 Q
"RTN","ORKPS")
0^6^B68389235
"RTN","ORKPS",1,0)
ORKPS ; slc/CLA - Order checking support procedures for medications ;12/15/97
"RTN","ORKPS",2,0)
 ;;3.0;ORDER ENTRY/RESULTS REPORTING;**6,32,74,94,123**;Dec 17, 1997
"RTN","ORKPS",3,0)
 Q
"RTN","ORKPS",4,0)
CHECK(YY,DFN,MED,OI,ORKDG) ; return drug order checks: drug-drug interactions,
"RTN","ORKPS",5,0)
 ; duplicate drug, duplicate class
"RTN","ORKPS",6,0)
 ;YY:    returned array of data
"RTN","ORKPS",7,0)
 ;DFN:   patient id
"RTN","ORKPS",8,0)
 ;MED:   drug ien [file #50]
"RTN","ORKPS",9,0)
 ;OI:    orderable item ien [file #101.43
"RTN","ORKPS",10,0)
 ;ORKDG: display group (should be PSI, PSIV or PSO)
"RTN","ORKPS",11,0)
 ; returned info: varies for ^TMP($J x-ref - refer to listings below
"RTN","ORKPS",12,0)
 K ^TMP($J,"DI"),^TMP($J,"DD"),^TMP($J,"DC")
"RTN","ORKPS",13,0)
 N ORDFN S ORDFN=DFN
"RTN","ORKPS",14,0)
 D EN^PSOORDRG(DFN,MED)
"RTN","ORKPS",15,0)
 D PROCESS(OI,ORDFN,ORKDG)
"RTN","ORKPS",16,0)
 K ^TMP($J,"DI"),^TMP($J,"DD"),^TMP($J,"DC")
"RTN","ORKPS",17,0)
 Q
"RTN","ORKPS",18,0)
CHKSESS(YY,DFN,MED,OI,ORKPDATA,ORKDG) ; return drug order checks for a session
"RTN","ORKPS",19,0)
 N ORKDGI,ORKDRUG,ORKDRUGA,ORKORN,HOR,SEQ,CNT,CNTX,ORKOI
"RTN","ORKPS",20,0)
 N ORKFLG,ORSESS,ORPSPKG,ORPSA,ORKDD,ORSNUM,ORNUM
"RTN","ORKPS",21,0)
 N ORDFN S ORDFN=DFN
"RTN","ORKPS",22,0)
 S ORKFLG=0
"RTN","ORKPS",23,0)
 S ORNUM=$P(ORKA,"|",5)
"RTN","ORKPS",24,0)
 ;
"RTN","ORKPS",25,0)
 ;get other med orders in current session:
"RTN","ORKPS",26,0)
 I $D(^TMP("ORKA",$J)) D
"RTN","ORKPS",27,0)
 .S CNT=^TMP("ORKA",$J) F CNTX=1:1:CNT D
"RTN","ORKPS",28,0)
 ..S ORSESS=$G(^TMP("ORKA",$J,CNTX))
"RTN","ORKPS",29,0)
 ..Q:'$L(ORSESS)
"RTN","ORKPS",30,0)
 ..S ORPSPKG=$P(ORSESS,"|",2)
"RTN","ORKPS",31,0)
 ..Q:'$L(ORPSPKG)
"RTN","ORKPS",32,0)
 ..Q:$E(ORPSPKG,1,2)'="PS"
"RTN","ORKPS",33,0)
 ..S ORSNUM=$P(ORSESS,"|",5)
"RTN","ORKPS",34,0)
 ..S ORKOI=$P(ORSESS,"|")
"RTN","ORKPS",35,0)
 ..;quit if same order/oi (IV additives have same order num but diff ois)
"RTN","ORKPS",36,0)
 ..Q:((+$G(ORNUM)=+$G(ORSNUM))&(+$G(OI)=+$G(ORKOI)))
"RTN","ORKPS",37,0)
 ..S:ORPSPKG="PSJ" ORPSPKG="PSI"
"RTN","ORKPS",38,0)
 ..S ORKDRUG=$P($P(ORSESS,"|",3),U,4)
"RTN","ORKPS",39,0)
 ..;
"RTN","ORKPS",40,0)
 ..;if no disp drug selected get disp drug(s) from OI (ORKOI)
"RTN","ORKPS",41,0)
 ..I +$G(ORKDRUG)<1,$L(ORKOI) D
"RTN","ORKPS",42,0)
 ...I "IO"[$E(ORPSPKG,3) D OI2DD(.ORPSA,ORKOI,$E(ORPSPKG,3)) D
"RTN","ORKPS",43,0)
 ....S ORKDD=0 F  S ORKDD=$O(ORPSA(ORKDD)) Q:'ORKDD  D
"RTN","ORKPS",44,0)
 .....S ORKDRUG=+ORKDD
"RTN","ORKPS",45,0)
 .....S:+$G(ORKDRUG)>0 ORKDRUGA(ORKDRUG_";"_ORPSPKG)=ORSNUM
"RTN","ORKPS",46,0)
 ...K ORPSA  ;need to clean out between calls to OI2DD
"RTN","ORKPS",47,0)
 ..;
"RTN","ORKPS",48,0)
 ..Q:+$G(ORKDRUG)<1
"RTN","ORKPS",49,0)
 ..;if dispense drug selected add it to the array:
"RTN","ORKPS",50,0)
 ..S ORKDRUGA(ORKDRUG_";"_ORPSPKG)=ORSNUM
"RTN","ORKPS",51,0)
 ..;I (+$G(ORKOI)'=OI)!(ORKFLG=1) S ORKDRUGA(ORKDRUG)=""
"RTN","ORKPS",52,0)
 ..;I +$G(ORKDRUG)=MED S ORKFLG=1  ;MED has been processed once
"RTN","ORKPS",53,0)
 ;
"RTN","ORKPS",54,0)
 ;get all unsigned medication orders:
"RTN","ORKPS",55,0)
 S HOR=0,SEQ=0
"RTN","ORKPS",56,0)
 S HOR=$O(^TMP("ORR",$J,HOR)) I +$G(HOR)>0 D
"RTN","ORKPS",57,0)
 .F  S SEQ=$O(^TMP("ORR",$J,HOR,SEQ)) Q:+SEQ<1  D
"RTN","ORKPS",58,0)
 ..S ORKORN=+$P(^TMP("ORR",$J,HOR,SEQ),U)
"RTN","ORKPS",59,0)
 ..Q:+$G(ORKORN)<1
"RTN","ORKPS",60,0)
 ..Q:+ORKORN=+ORNUM
"RTN","ORKPS",61,0)
 ..Q:$P(^OR(100,+ORKORN,8,$P(^OR(100,+ORKORN,8,0),U,3),0),U,2)="DC"
"RTN","ORKPS",62,0)
 ..S ORKDRUG=$$VALUE^ORCSAVE2(+ORKORN,"DRUG") ;get disp drug for order
"RTN","ORKPS",63,0)
 ..;only process against unsigned med order if disp drug is assoc w/order:
"RTN","ORKPS",64,0)
 ..Q:+$G(ORKDRUG)<1
"RTN","ORKPS",65,0)
 ..S ORPSPKG=$$DGRX^ORQOR2(+ORKORN)
"RTN","ORKPS",66,0)
 ..S ORPSPKG=$S(ORPSPKG="UNIT DOSE MEDICATIONS":"PSI",ORPSPKG="OUTPATIENT MEDICATIONS":"PSO",ORPSPKG="IV MEDICATIONS":"PSIV",1:"")
"RTN","ORKPS",67,0)
 ..Q:$D(ORKDRUGA(+ORKDRUG_";"_ORPSPKG))  ;quit if already processed drug
"RTN","ORKPS",68,0)
 ..S ORKDRUGA(+ORKDRUG_";"_ORPSPKG)=ORKORN
"RTN","ORKPS",69,0)
 ;
"RTN","ORKPS",70,0)
 K ^TMP($J,"DI"),^TMP($J,"DD"),^TMP($J,"DC")
"RTN","ORKPS",71,0)
 ;S MED=MED_";"_ORKDG
"RTN","ORKPS",72,0)
 I $D(ORKDRUGA) D DRGCHK^PSOORDRG(DFN,MED,.ORKDRUGA)
"RTN","ORKPS",73,0)
 D PROCESS(OI,ORDFN,ORKDG)
"RTN","ORKPS",74,0)
 K ^TMP($J,"DI"),^TMP($J,"DD"),^TMP($J,"DC")
"RTN","ORKPS",75,0)
 Q
"RTN","ORKPS",76,0)
PROCESS(OI,DFN,ORKDG) ;process data returned from pharmacy order check API
"RTN","ORKPS",77,0)
 Q:'$D(^TMP($J))
"RTN","ORKPS",78,0)
 N II,XX,ZZ,ZZD,ORTYPE,ORMTYPE,ORN,ORZ,ORNDUP
"RTN","ORKPS",79,0)
 S II=1,XX=0,ZZ="",ZZD=""
"RTN","ORKPS",80,0)
 ;
"RTN","ORKPS",81,0)
 ;check to determine if inpatient or outpatient:
"RTN","ORKPS",82,0)
 I $L(ORKDG) S ORTYPE=$S($G(ORKDG)="PSI":"I",$G(ORKDG)="PSO":"O",$G(ORKDG)="PSIV":"I",1:"")
"RTN","ORKPS",83,0)
 I '$L(ORTYPE) D  ;if no display group
"RTN","ORKPS",84,0)
 .D ADM^VADPT2
"RTN","ORKPS",85,0)
 .S ORTYPE=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS",86,0)
 .K VADMVT
"RTN","ORKPS",87,0)
 ;
"RTN","ORKPS",88,0)
 ; drug-drug interactions:
"RTN","ORKPS",89,0)
 F  S XX=$O(^TMP($J,"DI",XX)) Q:XX<1  D
"RTN","ORKPS",90,0)
 .S ZZ=$G(^TMP($J,"DI",XX,0))
"RTN","ORKPS",91,0)
 .S ORN=$P($P(ZZ,U,7),";"),ORZ=""
"RTN","ORKPS",92,0)
 .I $L(ORN),$D(^OR(100,ORN,8,0)) S ORZ=^OR(100,ORN,8,0)
"RTN","ORKPS",93,0)
 .I $L($G(ORZ)),($P(^OR(100,ORN,8,$P(ORZ,U,3),0),U,2)="DC") Q
"RTN","ORKPS",94,0)
 .I ZZ'="" S YY(II)="DI^"_ZZ,II=II+1
"RTN","ORKPS",95,0)
 ;
"RTN","ORKPS",96,0)
 ; duplicate drugs:
"RTN","ORKPS",97,0)
 Q:$$SOLUT(OI)  ;quit if the orderable item is a solution (RX EP specs
"RTN","ORKPS",98,0)
 ;require that we do not perform dup drug/class OCs for solutions)
"RTN","ORKPS",99,0)
 S XX=0,ZZ=""
"RTN","ORKPS",100,0)
 F  S XX=$O(^TMP($J,"DD",XX)) Q:XX<1  D
"RTN","ORKPS",101,0)
 .S ZZ=$G(^TMP($J,"DD",XX,0)),ORMTYPE=$P($P(ZZ,U,4),";",2)
"RTN","ORKPS",102,0)
 .Q:$G(ORTYPE)'=$G(ORMTYPE)  ;QUIT if med type isn't order or pt type
"RTN","ORKPS",103,0)
 .S ORN=$P($P(ZZ,U,3),";"),ORZ=""
"RTN","ORKPS",104,0)
 .I +$G(ORIFN),(+$G(ORN)=+$G(ORIFN)) S ORNDUP=1 ;dup med order # = current order #
"RTN","ORKPS",105,0)
 .Q:$G(ORNDUP)=1
"RTN","ORKPS",106,0)
 .I $L(ORN),$D(^OR(100,ORN,8,0)) S ORZ=^OR(100,ORN,8,0)
"RTN","ORKPS",107,0)
 .I $L($G(ORZ)),($P(^OR(100,ORN,8,$P(ORZ,U,3),0),U,2)="DC") Q
"RTN","ORKPS",108,0)
 .I ZZ'="" S YY(II)="DD^"_ZZ,II=II+1
"RTN","ORKPS",109,0)
 ;
"RTN","ORKPS",110,0)
 ; duplicate classes:
"RTN","ORKPS",111,0)
 Q:$$SUPPLY(OI)  ;quit if the orderable item is a supply
"RTN","ORKPS",112,0)
 S XX=0,ZZ=""
"RTN","ORKPS",113,0)
 F  S XX=$O(^TMP($J,"DC",XX)) Q:XX<1  D
"RTN","ORKPS",114,0)
 .S ZZ=$G(^TMP($J,"DC",XX,0)),ORMTYPE=$P($P(ZZ,U,6),";",2)
"RTN","ORKPS",115,0)
 .Q:$G(ORTYPE)'=$G(ORMTYPE)  ;QUIT if med type isn't order or pt type
"RTN","ORKPS",116,0)
 .S ORN=$P($P(ZZ,U,5),";"),ORZ=""
"RTN","ORKPS",117,0)
 .I $L(ORN),$D(^OR(100,ORN,8,0)) S ORZ=^OR(100,ORN,8,0)
"RTN","ORKPS",118,0)
 .I $L($G(ORZ)),($P(^OR(100,ORN,8,$P(ORZ,U,3),0),U,2)="DC") Q
"RTN","ORKPS",119,0)
 .I ZZ'="" S YY(II)="DC^"_ZZ,II=II+1
"RTN","ORKPS",120,0)
 Q
"RTN","ORKPS",121,0)
TAKEMED(ORKDFN,ORKMED) ;extrinsic function returns med orderable item if any
"RTN","ORKPS",122,0)
 ;active med patient is taking contains any piece of ORKMED
"RTN","ORKPS",123,0)
 ;ORKDFN   patient DFN
"RTN","ORKPS",124,0)
 ;ORKMED   meds to check vs. active med list in format MED1^MED2^MED3...
"RTN","ORKPS",125,0)
 Q:'$L($G(ORKDFN)) "0^Patient not identified."
"RTN","ORKPS",126,0)
 Q:'$L($G(ORKMED)) "0^Medication not identified."
"RTN","ORKPS",127,0)
 N ORKARX,ORKY,ORI,ORJ,ORCNT,ORKMEDP,ORKRSLT
"RTN","ORKPS",128,0)
 D LIST^ORQQPS(.ORKY,ORKDFN,"","")
"RTN","ORKPS",129,0)
 Q:$P(ORKY(1),U)="" "0^No active meds found."
"RTN","ORKPS",130,0)
 S ORKRSLT="0^No matching meds found."
"RTN","ORKPS",131,0)
 S ORCNT=$L(ORKMED,U)
"RTN","ORKPS",132,0)
 S ORI=0 F  S ORI=$O(ORKY(ORI)) Q:ORI<1  D
"RTN","ORKPS",133,0)
 .S ORKARX=$P(ORKY(ORI),U,2)
"RTN","ORKPS",134,0)
 .F ORJ=1:1:ORCNT S ORKMEDP=$P(ORKMED,U,ORJ) D
"RTN","ORKPS",135,0)
 ..I $L(ORKMEDP),(ORKARX[ORKMEDP) S ORKRSLT="1^"_ORKARX
"RTN","ORKPS",136,0)
 Q ORKRSLT
"RTN","ORKPS",137,0)
SOLUT(OI) ;extrinsic function returns 1 (true) if the orderable item is
"RTN","ORKPS",138,0)
 ; a solution (IV Base)
"RTN","ORKPS",139,0)
 Q:+$G(OI)<1 ""
"RTN","ORKPS",140,0)
 N OITEXT
"RTN","ORKPS",141,0)
 S OITEXT=$G(^ORD(101.43,OI,0))
"RTN","ORKPS",142,0)
 Q:'$L(OITEXT) ""
"RTN","ORKPS",143,0)
 S OITEXT=$P(OITEXT,U)
"RTN","ORKPS",144,0)
 Q:$D(^ORD(101.43,"S.IVB RX",OITEXT)) 1
"RTN","ORKPS",145,0)
 Q ""
"RTN","ORKPS",146,0)
POLYRX(DFN) ;extrins funct rtns 1 if patient exceeds polypharmacy, 0 if not
"RTN","ORKPS",147,0)
 N ORSLT,ORENT,ORLOC,ORPAR,ORMEDS
"RTN","ORKPS",148,0)
 S ORSLT=0
"RTN","ORKPS",149,0)
 Q:'$L(DFN) ORSLT
"RTN","ORKPS",150,0)
 ;get patient's location flag (INPATIENT ONLY - outpt locations cannot be
"RTN","ORKPS",151,0)
 ;reliably determined, and many simultaneous outpt locations can occur):
"RTN","ORKPS",152,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",153,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",154,0)
 K VA200,VAIN
"RTN","ORKPS",155,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",156,0)
 S ORPAR=$$GET^XPAR(ORENT,"ORK POLYPHARMACY",1,"I")
"RTN","ORKPS",157,0)
 S ORMEDS=$$NUMRX(DFN)
"RTN","ORKPS",158,0)
 I $G(ORMEDS)>$G(ORPAR) S ORSLT=1
"RTN","ORKPS",159,0)
 Q ORSLT
"RTN","ORKPS",160,0)
GLCREAT(DFN) ;extrinsic function returns patient's (DFN) most recent serum
"RTN","ORKPS",161,0)
 ; creatinine within # of days from parameter ORK GLUCOPHAGE CREATININE
"RTN","ORKPS",162,0)
 ; results format: test id^result units flag ref range collect d/t^result
"RTN","ORKPS",163,0)
 ; used by order check GLUCOPHAGE-LAB RESULTS
"RTN","ORKPS",164,0)
 N ORLOC,ORPAR,ORDAYS
"RTN","ORKPS",165,0)
 N BDT,CDT,ORY,ORX,ORZ,TEST,ORI,ORJ,CREARSLT,LABFILE,SPECFILE,SPECIMEN
"RTN","ORKPS",166,0)
 Q:'$L(DFN) "0^"
"RTN","ORKPS",167,0)
 S ORDAYS=$$GCDAYS(DFN)
"RTN","ORKPS",168,0)
 Q:'$L(ORDAYS) "0^"
"RTN","ORKPS",169,0)
 D NOW^%DTC
"RTN","ORKPS",170,0)
 S BDT=$$FMADD^XLFDT(%,"-"_ORDAYS,"","","")
"RTN","ORKPS",171,0)
 K %
"RTN","ORKPS",172,0)
 Q:'$L($G(BDT)) "0^"
"RTN","ORKPS",173,0)
 S LABFILE=$$TERMLKUP^ORB31(.ORY,"SERUM CREATININE")
"RTN","ORKPS",174,0)
 Q:'$D(ORY) "0^" ;no link between SERUM CREATININE and local lab test
"RTN","ORKPS",175,0)
 Q:$G(LABFILE)'=60 "0^"
"RTN","ORKPS",176,0)
 S SPECFILE=$$TERMLKUP^ORB31(.ORX,"SERUM SPECIMEN")
"RTN","ORKPS",177,0)
 Q:'$D(ORX) "0^" ;no link between SERUM SPECIMEN and local specimen
"RTN","ORKPS",178,0)
 Q:$G(SPECFILE)'=61 "0^"
"RTN","ORKPS",179,0)
 F ORI=1:1:ORY I +$G(CREARSLT)<1 D
"RTN","ORKPS",180,0)
 .S TEST=$P(ORY(ORI),U)
"RTN","ORKPS",181,0)
 .Q:+$G(TEST)<1
"RTN","ORKPS",182,0)
 .F ORJ=1:1:ORX I +$G(CREARSLT)<1 D
"RTN","ORKPS",183,0)
 ..S SPECIMEN=$P(ORX(ORJ),U)
"RTN","ORKPS",184,0)
 ..Q:+$G(SPECIMEN)<1
"RTN","ORKPS",185,0)
 ..S ORZ=$$LOCL^ORQQLR1(DFN,TEST,SPECIMEN)
"RTN","ORKPS",186,0)
 ..Q:'$L($G(ORZ))
"RTN","ORKPS",187,0)
 ..S CDT=$P(ORZ,U,7)
"RTN","ORKPS",188,0)
 ..I CDT'<BDT S CREARSLT=1
"RTN","ORKPS",189,0)
 Q:+$G(CREARSLT)<1 "0^"
"RTN","ORKPS",190,0)
 Q $P(ORZ,U)_U_$P(ORZ,U,3)_" "_$P(ORZ,U,4)_" "_$P(ORZ,U,5)_" ("_$P(ORZ,U,6)_")  "_$$FMTE^XLFDT(CDT,"2P")_U_$P(ORZ,U,3)
"RTN","ORKPS",191,0)
GCDAYS(DFN) ;extrinsic function to return number of days to look for 
"RTN","ORKPS",192,0)
 ; glucophage serum creatinine result
"RTN","ORKPS",193,0)
 Q:'$L(DFN) ""
"RTN","ORKPS",194,0)
 N ORLOC,ORENT,ORDAYS
"RTN","ORKPS",195,0)
 ;get patient's location flag (INPATIENT ONLY - outpt locations cannot be
"RTN","ORKPS",196,0)
 ;reliably determined, and many simultaneous outpt locations can occur):
"RTN","ORKPS",197,0)
 S VA200="" D OERR^VADPT
"RTN","ORKPS",198,0)
 S ORLOC=+$G(^DIC(42,+VAIN(4),44))
"RTN","ORKPS",199,0)
 K VA200,VAIN
"RTN","ORKPS",200,0)
 S ORENT=+$G(ORLOC)_";SC(^DIV^SYS^PKG"
"RTN","ORKPS",201,0)
 S ORDAYS=$$GET^XPAR(ORENT,"ORK GLUCOPHAGE CREATININE",1,"I")
"RTN","ORKPS",202,0)
 Q:$L(ORDAYS) ORDAYS
"RTN","ORKPS",203,0)
 Q ""
"RTN","ORKPS",204,0)
SUPPLY(OI) ;extrinsic function returns 1 (true) if the orderable item is
"RTN","ORKPS",205,0)
 ; a supply
"RTN","ORKPS",206,0)
 Q:+$G(OI)<1 ""
"RTN","ORKPS",207,0)
 N OITEXT
"RTN","ORKPS",208,0)
 S OITEXT=$G(^ORD(101.43,OI,0))
"RTN","ORKPS",209,0)
 Q:'$L(OITEXT) ""
"RTN","ORKPS",210,0)
 S OITEXT=$P(OITEXT,U)
"RTN","ORKPS",211,0)
 Q:$D(^ORD(101.43,"S.SPLY",OITEXT)) 1
"RTN","ORKPS",212,0)
 Q ""
"RTN","ORKPS",213,0)
NUMRX(DFN) ;extrinsic funct returns number of active meds patient is taking
"RTN","ORKPS",214,0)
 N NUMRX,ORPTYPE,ORX,ORY,ORS,ORNUM,ORPRENEW
"RTN","ORKPS",215,0)
 S NUMRX=0
"RTN","ORKPS",216,0)
 Q:+$G(DFN)<1 NUMRX
"RTN","ORKPS",217,0)
 ;
"RTN","ORKPS",218,0)
 ;check to determine if inpatient or outpatient:
"RTN","ORKPS",219,0)
 D ADM^VADPT2
"RTN","ORKPS",220,0)
 S ORPTYPE=$S(+$G(VADMVT)>0:"I",1:"O")
"RTN","ORKPS",221,0)
 ;
"RTN","ORKPS",222,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",223,0)
 D OCL^PSOORRL(DFN,"","")  ;if no date range, returns active meds for pt
"RTN","ORKPS",224,0)
 N X
"RTN","ORKPS",225,0)
 S X=0
"RTN","ORKPS",226,0)
 F  S X=$O(^TMP("PS",$J,X)) Q:X<1  D
"RTN","ORKPS",227,0)
 .S ORX=$G(^TMP("PS",$J,X,0))
"RTN","ORKPS",228,0)
 .S ORY=$P(ORX,U)
"RTN","ORKPS",229,0)
 .S ORNUM=$P(ORX,U,8) ;order entry order number
"RTN","ORKPS",230,0)
 .S ORS=$P(ORX,U,9) ;medication status from pharmacy
"RTN","ORKPS",231,0)
 .S ORPRENEW=$P(ORX,U,14)  ;pending renewal flag (1: pending renewal)
"RTN","ORKPS",232,0)
 .Q:+ORX<1
"RTN","ORKPS",233,0)
 .Q:$P(ORY,";",2)'=ORPTYPE  ;quit if med is not pt type (inpt/outpt)
"RTN","ORKPS",234,0)
 .;quit if status is a non-active type:
"RTN","ORKPS",235,0)
 .Q:$G(ORS)="EXPIRED"
"RTN","ORKPS",236,0)
 .Q:$G(ORS)["DISCONTINUE"
"RTN","ORKPS",237,0)
 .Q:$G(ORS)="DELETED"
"RTN","ORKPS",238,0)
 .Q:+$G(ORPRENEW)>0
"RTN","ORKPS",239,0)
 .Q:$$SUPPLY($$OI^ORQOR2(ORNUM))=1  ;quit if a supply
"RTN","ORKPS",240,0)
 .S NUMRX=NUMRX+1
"RTN","ORKPS",241,0)
 K ^TMP("PS",$J)
"RTN","ORKPS",242,0)
 Q NUMRX
"RTN","ORKPS",243,0)
OI2DD(ORPSA,OROI,ORPSPKG)       ;rtn dispense drugs for a PS OI
"RTN","ORKPS",244,0)
 N PSOI
"RTN","ORKPS",245,0)
 Q:'$D(^ORD(101.43,OROI,0))
"RTN","ORKPS",246,0)
 S PSOI=$P($P(^ORD(101.43,OROI,0),U,2),";")
"RTN","ORKPS",247,0)
 Q:+$G(PSOI)<1
"RTN","ORKPS",248,0)
 D DRG^PSSUTIL1(.ORPSA,PSOI,ORPSPKG)
"RTN","ORKPS",249,0)
 Q
"VER")
8.0^22.0
**END**
**END**
