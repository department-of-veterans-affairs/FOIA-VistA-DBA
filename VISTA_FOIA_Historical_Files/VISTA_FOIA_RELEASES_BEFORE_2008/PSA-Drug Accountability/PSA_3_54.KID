KIDS Distribution saved on Aug 01, 2006@12:47:06
PSA*3*54 08/01/06
**KIDS**:PSA*3.0*54^

**INSTALL NAME**
PSA*3.0*54
"BLD",6618,0)
PSA*3.0*54^DRUG ACCOUNTABILITY^0^3060801^y
"BLD",6618,1,0)
^^43^43^3060322^
"BLD",6618,1,1,0)
This patch is addressing the following problems:
"BLD",6618,1,2,0)
 
"BLD",6618,1,3,0)
1. HD 112456 Reinstate the display of vendor item Dispense Units per 
"BLD",6618,1,4,0)
Order Unit (DUOU) during processing. PSA*3*48 initiated a temporary plan 
"BLD",6618,1,5,0)
to aid sites in starting Drug Accountability by shipping in a side file 
"BLD",6618,1,6,0)
from the vendor and display DUOU for matching drugs when possible during 
"BLD",6618,1,7,0)
processing. It has been requested that the vendor drug description also 
"BLD",6618,1,8,0)
be included to aid in matching items to drugs.
"BLD",6618,1,9,0)
 
"BLD",6618,1,10,0)
2. HD 118113. The sites have requested that the verification screens also 
"BLD",6618,1,11,0)
display the vendor DUOU and drug description.
"BLD",6618,1,12,0)
Both processing and verification screens will have the following 
"BLD",6618,1,13,0)
information line displayed. The information displayed depends on the 
"BLD",6618,1,14,0)
availability of vendor information uploaded.
"BLD",6618,1,15,0)
 
"BLD",6618,1,16,0)
========================= 
"BLD",6618,1,17,0)
SAMPLE OF THE ADDED LINE: 
"BLD",6618,1,18,0)
========================= 
"BLD",6618,1,19,0)
There are two versions of the display line added.
"BLD",6618,1,20,0)
1)      The line if the drug information is available
"BLD",6618,1,21,0)
 PV-Drug-Descrip:    ACETAM? TB #4    ROX RN4X25        PV-DUOU: 100
"BLD",6618,1,22,0)
 
"BLD",6618,1,23,0)
2)      The line if the drug information is not available.
"BLD",6618,1,24,0)
PV-Drug-Descrip:    Not available. Item is OTC or new after February 2006.
"BLD",6618,1,25,0)
 
"BLD",6618,1,26,0)
===========================
"BLD",6618,1,27,0)
SAMPLE of modified screen:
"BLD",6618,1,28,0)
===========================
"BLD",6618,1,29,0)
The same line of information is presented in both processing and 
"BLD",6618,1,30,0)
verifying screens.
"BLD",6618,1,31,0)
 
"BLD",6618,1,32,0)
Order#: C563685000  Invoice#: 7246433050  Invoice Date: Sep 07, 2005
"BLD",6618,1,33,0)
-----------------------------------------------------------------------
"BLD",6618,1,34,0)
 
"BLD",6618,1,35,0)
1  ACETAMINOPHEN, CODEINE 60MG TAB (Controlled Substance)
"BLD",6618,1,36,0)
Qty Invoiced: 10                      UPC: 300054802324
"BLD",6618,1,37,0)
Order Unit  : TU                      NDC: 00054-8023-24
"BLD",6618,1,38,0)
Unit Price  : $9.60                   VSN: 1334150
"BLD",6618,1,39,0)
 
"BLD",6618,1,40,0)
PV-Drug-Descrip:    ACETAM? TB #4    ROX RN4X25        PV-DUOU: 100
"BLD",6618,1,41,0)
 
"BLD",6618,1,42,0)
Dispense Units: TAB
"BLD",6618,1,43,0)
Dispense Units Per Order Unit: 2000
"BLD",6618,4,0)
^9.64PA^^
"BLD",6618,6)
4^
"BLD",6618,"INID")
^n
"BLD",6618,"INIT")
POSINIT^PSAP54
"BLD",6618,"KRN",0)
^9.67PA^8989.52^19
"BLD",6618,"KRN",.4,0)
.4
"BLD",6618,"KRN",.401,0)
.401
"BLD",6618,"KRN",.402,0)
.402
"BLD",6618,"KRN",.403,0)
.403
"BLD",6618,"KRN",.5,0)
.5
"BLD",6618,"KRN",.84,0)
.84
"BLD",6618,"KRN",3.6,0)
3.6
"BLD",6618,"KRN",3.8,0)
3.8
"BLD",6618,"KRN",9.2,0)
9.2
"BLD",6618,"KRN",9.8,0)
9.8
"BLD",6618,"KRN",9.8,"NM",0)
^9.68A^3^3
"BLD",6618,"KRN",9.8,"NM",1,0)
PSAUTL1^^0^B58194382
"BLD",6618,"KRN",9.8,"NM",2,0)
PSAUTL4^^0^B26771267
"BLD",6618,"KRN",9.8,"NM",3,0)
PSAP54^^0^B24435101
"BLD",6618,"KRN",9.8,"NM","B","PSAP54",3)

"BLD",6618,"KRN",9.8,"NM","B","PSAUTL1",1)

"BLD",6618,"KRN",9.8,"NM","B","PSAUTL4",2)

"BLD",6618,"KRN",19,0)
19
"BLD",6618,"KRN",19.1,0)
19.1
"BLD",6618,"KRN",101,0)
101
"BLD",6618,"KRN",409.61,0)
409.61
"BLD",6618,"KRN",771,0)
771
"BLD",6618,"KRN",870,0)
870
"BLD",6618,"KRN",8989.51,0)
8989.51
"BLD",6618,"KRN",8989.52,0)
8989.52
"BLD",6618,"KRN",8994,0)
8994
"BLD",6618,"KRN","B",.4,.4)

"BLD",6618,"KRN","B",.401,.401)

"BLD",6618,"KRN","B",.402,.402)

"BLD",6618,"KRN","B",.403,.403)

"BLD",6618,"KRN","B",.5,.5)

"BLD",6618,"KRN","B",.84,.84)

"BLD",6618,"KRN","B",3.6,3.6)

"BLD",6618,"KRN","B",3.8,3.8)

"BLD",6618,"KRN","B",9.2,9.2)

"BLD",6618,"KRN","B",9.8,9.8)

"BLD",6618,"KRN","B",19,19)

"BLD",6618,"KRN","B",19.1,19.1)

"BLD",6618,"KRN","B",101,101)

"BLD",6618,"KRN","B",409.61,409.61)

"BLD",6618,"KRN","B",771,771)

"BLD",6618,"KRN","B",870,870)

"BLD",6618,"KRN","B",8989.51,8989.51)

"BLD",6618,"KRN","B",8989.52,8989.52)

"BLD",6618,"KRN","B",8994,8994)

"BLD",6618,"QUES",0)
^9.62^3^2
"BLD",6618,"QUES",2,0)
POSPSADIR
"BLD",6618,"QUES",2,1)
F^3:30
"BLD",6618,"QUES",2,"A")
HOST DIRECTORY
"BLD",6618,"QUES",2,"A1",0)
^^17^17^3060316^
"BLD",6618,"QUES",2,"A1",1,0)
           Build McKesson
"BLD",6618,"QUES",2,"A1",2,0)
 VSN to Dispense Units Per Order Unit 
"BLD",6618,"QUES",2,"A1",3,0)
      and Drug Description Data
"BLD",6618,"QUES",2,"A1",4,0)
 
"BLD",6618,"QUES",2,"A1",5,0)
This Utility is used to build the ^XTMP(""PSAVSN"" global with then 
"BLD",6618,"QUES",2,"A1",6,0)
McKesson VSN DUOU & Description. Please follow these steps prior to
"BLD",6618,"QUES",2,"A1",7,0)
running this utility:
"BLD",6618,"QUES",2,"A1",8,0)
 
"BLD",6618,"QUES",2,"A1",9,0)
1) Retrieve the MCKESSON_UPDATE.DAT in ASCII format directly from
"BLD",6618,"QUES",2,"A1",10,0)
one of these FTP servers:
"BLD",6618,"QUES",2,"A1",11,0)
 
"BLD",6618,"QUES",2,"A1",12,0)
The preferred FTP server retrieve the file from   
"BLD",6618,"QUES",2,"A1",13,0)
download.vista.med.va.gov
"BLD",6618,"QUES",2,"A1",14,0)
which will transmit the files from the first available FTP server
"BLD",6618,"QUES",2,"A1",15,0)
Albany          ftp.fo-albany.med.va.gov
"BLD",6618,"QUES",2,"A1",16,0)
Hines           ftp.fo-hines.med.va.gov
"BLD",6618,"QUES",2,"A1",17,0)
Salt Lake City  ftp.fo-slc.med.va.gov
"BLD",6618,"QUES",2,"Q")
Valid VMS Directory strudture is USER$:[TEMP]
"BLD",6618,"QUES",3,0)
POSPSAFILE
"BLD",6618,"QUES",3,1)
F^3:30
"BLD",6618,"QUES",3,"A")
HOST FILENAME
"BLD",6618,"QUES",3,"B")
MCKESSON_UPDATE.DAT
"BLD",6618,"QUES","B","POSPSADIR",2)

"BLD",6618,"QUES","B","POSPSAFILE",3)

"BLD",6618,"REQB",0)
^9.611^2^2
"BLD",6618,"REQB",1,0)
PSA*3.0*49^1
"BLD",6618,"REQB",2,0)
PSA*3.0*48^1
"BLD",6618,"REQB","B","PSA*3.0*48",2)

"BLD",6618,"REQB","B","PSA*3.0*49",1)

"INIT")
POSINIT^PSAP54
"MBREQ")
0
"PKG",487,-1)
1^1
"PKG",487,0)
DRUG ACCOUNTABILITY^PSA^Drug Accountability Inventory and Tracking module.
"PKG",487,20,0)
^9.402P^^
"PKG",487,22,0)
^9.49I^1^1
"PKG",487,22,1,0)
3.0^2971024^2981028^66481
"PKG",487,22,1,"PAH",1,0)
54^3060801^100104
"PKG",487,22,1,"PAH",1,1,0)
^^43^43^3060801
"PKG",487,22,1,"PAH",1,1,1,0)
This patch is addressing the following problems:
"PKG",487,22,1,"PAH",1,1,2,0)
 
"PKG",487,22,1,"PAH",1,1,3,0)
1. HD 112456 Reinstate the display of vendor item Dispense Units per 
"PKG",487,22,1,"PAH",1,1,4,0)
Order Unit (DUOU) during processing. PSA*3*48 initiated a temporary plan 
"PKG",487,22,1,"PAH",1,1,5,0)
to aid sites in starting Drug Accountability by shipping in a side file 
"PKG",487,22,1,"PAH",1,1,6,0)
from the vendor and display DUOU for matching drugs when possible during 
"PKG",487,22,1,"PAH",1,1,7,0)
processing. It has been requested that the vendor drug description also 
"PKG",487,22,1,"PAH",1,1,8,0)
be included to aid in matching items to drugs.
"PKG",487,22,1,"PAH",1,1,9,0)
 
"PKG",487,22,1,"PAH",1,1,10,0)
2. HD 118113. The sites have requested that the verification screens also 
"PKG",487,22,1,"PAH",1,1,11,0)
display the vendor DUOU and drug description.
"PKG",487,22,1,"PAH",1,1,12,0)
Both processing and verification screens will have the following 
"PKG",487,22,1,"PAH",1,1,13,0)
information line displayed. The information displayed depends on the 
"PKG",487,22,1,"PAH",1,1,14,0)
availability of vendor information uploaded.
"PKG",487,22,1,"PAH",1,1,15,0)
 
"PKG",487,22,1,"PAH",1,1,16,0)
========================= 
"PKG",487,22,1,"PAH",1,1,17,0)
SAMPLE OF THE ADDED LINE: 
"PKG",487,22,1,"PAH",1,1,18,0)
========================= 
"PKG",487,22,1,"PAH",1,1,19,0)
There are two versions of the display line added.
"PKG",487,22,1,"PAH",1,1,20,0)
1)      The line if the drug information is available
"PKG",487,22,1,"PAH",1,1,21,0)
 PV-Drug-Descrip:    ACETAM? TB #4    ROX RN4X25        PV-DUOU: 100
"PKG",487,22,1,"PAH",1,1,22,0)
 
"PKG",487,22,1,"PAH",1,1,23,0)
2)      The line if the drug information is not available.
"PKG",487,22,1,"PAH",1,1,24,0)
PV-Drug-Descrip:    Not available. Item is OTC or new after February 2006.
"PKG",487,22,1,"PAH",1,1,25,0)
 
"PKG",487,22,1,"PAH",1,1,26,0)
===========================
"PKG",487,22,1,"PAH",1,1,27,0)
SAMPLE of modified screen:
"PKG",487,22,1,"PAH",1,1,28,0)
===========================
"PKG",487,22,1,"PAH",1,1,29,0)
The same line of information is presented in both processing and 
"PKG",487,22,1,"PAH",1,1,30,0)
verifying screens.
"PKG",487,22,1,"PAH",1,1,31,0)
 
"PKG",487,22,1,"PAH",1,1,32,0)
Order#: C563685000  Invoice#: 7246433050  Invoice Date: Sep 07, 2005
"PKG",487,22,1,"PAH",1,1,33,0)
-----------------------------------------------------------------------
"PKG",487,22,1,"PAH",1,1,34,0)
 
"PKG",487,22,1,"PAH",1,1,35,0)
1  ACETAMINOPHEN, CODEINE 60MG TAB (Controlled Substance)
"PKG",487,22,1,"PAH",1,1,36,0)
Qty Invoiced: 10                      UPC: 300054802324
"PKG",487,22,1,"PAH",1,1,37,0)
Order Unit  : TU                      NDC: 00054-8023-24
"PKG",487,22,1,"PAH",1,1,38,0)
Unit Price  : $9.60                   VSN: 1334150
"PKG",487,22,1,"PAH",1,1,39,0)
 
"PKG",487,22,1,"PAH",1,1,40,0)
PV-Drug-Descrip:    ACETAM? TB #4    ROX RN4X25        PV-DUOU: 100
"PKG",487,22,1,"PAH",1,1,41,0)
 
"PKG",487,22,1,"PAH",1,1,42,0)
Dispense Units: TAB
"PKG",487,22,1,"PAH",1,1,43,0)
Dispense Units Per Order Unit: 2000
"QUES","POSPSADIR",0)
F^3:30
"QUES","POSPSADIR","?")
Valid VMS Directory strudture is USER$:[TEMP]
"QUES","POSPSADIR","A")
HOST DIRECTORY
"QUES","POSPSADIR","A",1)
           Build McKesson
"QUES","POSPSADIR","A",2)
 VSN to Dispense Units Per Order Unit 
"QUES","POSPSADIR","A",3)
      and Drug Description Data
"QUES","POSPSADIR","A",4)
 
"QUES","POSPSADIR","A",5)
This Utility is used to build the ^XTMP(""PSAVSN"" global with then 
"QUES","POSPSADIR","A",6)
McKesson VSN DUOU & Description. Please follow these steps prior to
"QUES","POSPSADIR","A",7)
running this utility:
"QUES","POSPSADIR","A",8)
 
"QUES","POSPSADIR","A",9)
1) Retrieve the MCKESSON_UPDATE.DAT in ASCII format directly from
"QUES","POSPSADIR","A",10)
one of these FTP servers:
"QUES","POSPSADIR","A",11)
 
"QUES","POSPSADIR","A",12)
The preferred FTP server retrieve the file from   
"QUES","POSPSADIR","A",13)
download.vista.med.va.gov
"QUES","POSPSADIR","A",14)
which will transmit the files from the first available FTP server
"QUES","POSPSADIR","A",15)
Albany          ftp.fo-albany.med.va.gov
"QUES","POSPSADIR","A",16)
Hines           ftp.fo-hines.med.va.gov
"QUES","POSPSADIR","A",17)
Salt Lake City  ftp.fo-slc.med.va.gov
"QUES","POSPSAFILE",0)
F^3:30
"QUES","POSPSAFILE","A")
HOST FILENAME
"QUES","POSPSAFILE","B")
MCKESSON_UPDATE.DAT
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
3
"RTN","PSAP54")
0^3^B24435101
"RTN","PSAP54",1,0)
PSAP54 ;VMP/RJS BUILD XTMP("PSAVSN" FROM A FLAT FILE ; 14MAR06
"RTN","PSAP54",2,0)
 ;;3.0;DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**54**;10/24/97
"RTN","PSAP54",3,0)
 ;  Reference to %ZISH supported by DBIA # 2320
"RTN","PSAP54",4,0)
 ;  Reference to XPDUTL supported by DBIA #10141
"RTN","PSAP54",5,0)
 ;  
"RTN","PSAP54",6,0)
 W:$D(IOF) @IOF
"RTN","PSAP54",7,0)
 W !," Build McKesson VSN to Dispense Units Per Order Unit and Drug Description Data"
"RTN","PSAP54",8,0)
 W !!,"This Utility is used to build the ^XTMP(""PSAVSN"" global with then McKesson VSN,",!,"DUOU & Description. Please follow these steps prior to running this utility:",!
"RTN","PSAP54",9,0)
 W !,"1) Retrieve the MCKESSON_UPDATE.DAT in ASCII format directly from one of these",!,?5,"FTP servers:"
"RTN","PSAP54",10,0)
 W !,?5,"Albany          ftp.fo-albany.med.va.gov",!,?5,"Hines           ftp.fo-hines.med.va.gov",!,?5,"Salt Lake City  ftp.fo-slc.med.va.gov"
"RTN","PSAP54",11,0)
 W !," The preferred FTP server retrieve the file from   download.vista.med.va.gov",!," which will transmit the files from the first available FTP server."
"RTN","PSAP54",12,0)
 W !!,"2) At the HOST DIRECTORY: prompt enter the name of the directory that you",!,"   placed the file in.  i.e. USER$:[TEMP]"
"RTN","PSAP54",13,0)
 W !!,?5,"If you enter an invalid directory this utility will return you to the",!,?5,"HOST DIRECTORY: prompt:     Enter ^ to Quit:",!!
"RTN","PSAP54",14,0)
 N DUOUT,X,Y
"RTN","PSAP54",15,0)
DIR S DIR(0)="F^3:30",DIR("A")="HOST DIRECTORY" D ^DIR Q:$D(DUOUT)  K DIR
"RTN","PSAP54",16,0)
 S PSADIR=X
"RTN","PSAP54",17,0)
 S DIR(0)="F^3:30",DIR("A")="HOST FILENAME",DIR("B")="MCKESSON_UPDATE.DAT" D ^DIR Q:$D(DUOUT)  K DIR
"RTN","PSAP54",18,0)
 S PSAFILE=X
"RTN","PSAP54",19,0)
 S Y=$$FTG^%ZISH(PSADIR,PSAFILE,$NA(^TMP("PSAVSN",1,0)),2)
"RTN","PSAP54",20,0)
 I Y'>0 W !,?5,"INVALID DIRECTORY NAME OR FILE DOES NOT EXIST",!,?5,"PLEASE ENTER THE DIRECTORY AGAIN" G DIR
"RTN","PSAP54",21,0)
 S PSADATA=$G(^TMP("PSAVSN",1,0))
"RTN","PSAP54",22,0)
 G:$L(PSADATA)>100 ERRMSG
"RTN","PSAP54",23,0)
 S PSAFLDT=$P(PSADATA,"^",5),PSADESC=$P(PSADATA,"^",4)
"RTN","PSAP54",24,0)
 I $G(^XTMP("PSAVSN",0)),$P(^XTMP("PSAVSN",0),"^",4)=PSAFLDT W !,"The McKesson Update for ",PSAFLDT," has already been installed",!,"Please try downloading the file again."  K ^TMP("PSAVSN") G END
"RTN","PSAP54",25,0)
 W !!,"PROCESSING PLEASE WAIT "
"RTN","PSAP54",26,0)
EN S PSADT=$$FMADD^XLFDT(DT,360)
"RTN","PSAP54",27,0)
 S ^XTMP("PSAVSN",0)=PSADT_"^"_DT_"^"_PSADESC_"^"_PSAFLDT
"RTN","PSAP54",28,0)
 S PSAREC=1,PSACNTR=0
"RTN","PSAP54",29,0)
 F  S PSAREC=$O(^TMP("PSAVSN",PSAREC)) Q:PSAREC=""  D
"RTN","PSAP54",30,0)
 .S PSACNTR=PSACNTR+1
"RTN","PSAP54",31,0)
 .I '$D(XPDQUES),PSACNTR=1000 S PSACNTR=0 W "."
"RTN","PSAP54",32,0)
 .S PSADATA=$G(^TMP("PSAVSN",PSAREC,0))
"RTN","PSAP54",33,0)
 .Q:PSADATA=""
"RTN","PSAP54",34,0)
 .S PSAVSN=$P(PSADATA,"^",1),PSADUOU=$P(PSADATA,"^",2),PSADESC=$P(PSADATA,"^",3)
"RTN","PSAP54",35,0)
 .S ^XTMP("PSAVSN",PSAVSN)=PSADUOU_"~"_PSADESC
"RTN","PSAP54",36,0)
 I '$D(XPDQUES) W !!,"PROCESSING COMPLETE.    The ^XTMP(""PSAVSN"" global has been updated"
"RTN","PSAP54",37,0)
END K ^TMP("PSAVSN"),PSAREC,PSADATA,PSAVSN,PSADUOU,PSADESC,PSACNTR,PSADT,PSADIR,PSAFILE,PSAFLDT
"RTN","PSAP54",38,0)
 Q
"RTN","PSAP54",39,0)
 ;
"RTN","PSAP54",40,0)
ERRMSG ; ERROR MESSAGE IF FILE WAS DOWNLOAD IN BINARY FORMAT
"RTN","PSAP54",41,0)
 K ^TMP("PSAVSN"),PSAREC,PSADATA,PSAVSN,PSADUOU,PSADESC,PSACNTR,PSADT,PSADIR,PSAFILE,PSAFLDT
"RTN","PSAP54",42,0)
 W !!,?10,"There was a problem with the input file."
"RTN","PSAP54",43,0)
 W !,?9,"It may have been downloaded in BINARY mode."
"RTN","PSAP54",44,0)
 W !,?6,"Please try downloading it again using ASCII mode.",!!
"RTN","PSAP54",45,0)
 Q
"RTN","PSAP54",46,0)
 ;
"RTN","PSAP54",47,0)
POSINIT ; PATCH POST INSTALL 
"RTN","PSAP54",48,0)
 S PSADIR=XPDQUES("POSPSADIR"),PSAFILE=XPDQUES("POSPSAFILE")
"RTN","PSAP54",49,0)
 S Y=$$FTG^%ZISH(PSADIR,PSAFILE,$NA(^TMP("PSAVSN",1,0)),2)
"RTN","PSAP54",50,0)
 I Y'>0 G POSERR1
"RTN","PSAP54",51,0)
 S PSADATA=$G(^TMP("PSAVSN",1,0))
"RTN","PSAP54",52,0)
 G:$L(PSADATA)>100 POSERR3
"RTN","PSAP54",53,0)
 S PSAFLDT=$P(PSADATA,"^",5),PSADESC=$P(PSADATA,"^",4)
"RTN","PSAP54",54,0)
 I $G(^XTMP("PSAVSN",0)),$P(^XTMP("PSAVSN",0),"^",4)=PSAFLDT G POSERR2
"RTN","PSAP54",55,0)
 G:$L($G(^TMP("PSAVSN",1,0)))>100 POSERR3
"RTN","PSAP54",56,0)
 D MES^XPDUTL("PROCESSING PLEASE WAIT")
"RTN","PSAP54",57,0)
 D EN
"RTN","PSAP54",58,0)
 D MES^XPDUTL("PROCESSING COMPLETE.    The ^XTMP(""PSAVSN"" global has been updated")
"RTN","PSAP54",59,0)
 Q
"RTN","PSAP54",60,0)
 ;
"RTN","PSAP54",61,0)
POSERR1 ; ERROR MESSAGE IF FILE COULD NOT BE OPENED
"RTN","PSAP54",62,0)
 S MSG="DIRECTORY = "_PSADIR_" FILENAME = "_PSAFILE
"RTN","PSAP54",63,0)
 D BMES^XPDUTL(MSG)
"RTN","PSAP54",64,0)
 D MES^XPDUTL("INVALID DIRECTORY NAME/FILENAME OR FILE DOES NOT EXIST")
"RTN","PSAP54",65,0)
 D MES^XPDUTL("Please verify that the DIRECTORY is correct and that the")
"RTN","PSAP54",66,0)
 D MES^XPDUTL("MCKESSON_UPDATE.DAT file is present")
"RTN","PSAP54",67,0)
 D BMES^XPDUTL("Once you have verified that the DIRECTORY name is correct and/or")
"RTN","PSAP54",68,0)
 D MES^XPDUTL("the file is present, Please run ^PSAP54 from the programmers prompt.")
"RTN","PSAP54",69,0)
 K PSADIR,PSAFILE
"RTN","PSAP54",70,0)
 Q
"RTN","PSAP54",71,0)
 ;
"RTN","PSAP54",72,0)
POSERR2 ; ERROR MESSAGE IF FILE WAS FUOUND BUT HAS ALREADY BEEN INSTALLED
"RTN","PSAP54",73,0)
 S MSG="The McKesson Update for "_PSAFLDT_" has already been installed"
"RTN","PSAP54",74,0)
 D BMES^XPDUTL(MSG)
"RTN","PSAP54",75,0)
 D MES^XPDUTL("Please try downloading the file again.")
"RTN","PSAP54",76,0)
 D MES^XPDUTL("Then run ^PSAP54 from the programmers prompt.")
"RTN","PSAP54",77,0)
 K ^TMP("PSAVSN"),MSG,PSADIR,PSAFILE
"RTN","PSAP54",78,0)
 Q
"RTN","PSAP54",79,0)
 ;
"RTN","PSAP54",80,0)
POSERR3 ; ERROR MESSAGE IF THE FLAT FILE WAS DOWNLOADED IN BINARY FORMAT
"RTN","PSAP54",81,0)
 D BMES^XPDUTL("There was a problem with the MCKESSON_UPDATE.DAT file")
"RTN","PSAP54",82,0)
 D MES^XPDUTL("Please download it again using ASCII format and")
"RTN","PSAP54",83,0)
 D MES^XPDUTL("run ^PSAP54 from the programmers prompt")
"RTN","PSAP54",84,0)
 K ^TMP("PSAVSN"),PSADIR,PSAFILE
"RTN","PSAP54",85,0)
 Q
"RTN","PSAUTL1")
0^1^B58194382
"RTN","PSAUTL1",1,0)
PSAUTL1 ;BIR/JMB-Prime Vendor Invoice Data Utility ;9/19/97
"RTN","PSAUTL1",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,12,15,21,48,49,54**; 10/24/97
"RTN","PSAUTL1",3,0)
 ;This routine contains utilities to get the location name, display an
"RTN","PSAUTL1",4,0)
 ;error-free item, display an item with errors, and display a line ready
"RTN","PSAUTL1",5,0)
 ;for verification.
"RTN","PSAUTL1",6,0)
 ;References to global ^PS(59.4, are covered under IA #2505
"RTN","PSAUTL1",7,0)
 ;References to global ^DIC(51.5, are covered under IA #1931
"RTN","PSAUTL1",8,0)
 ;References to global ^PS(59, are covered under IA #212
"RTN","PSAUTL1",9,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAUTL1",10,0)
 ;
"RTN","PSAUTL1",11,0)
SITES ;Gets the combined IP/OP's IP & OP site names
"RTN","PSAUTL1",12,0)
 ;PSA*3*22 (DAVE B) no location defined
"RTN","PSAUTL1",13,0)
 I $G(PSALOC)'>0 S (PSAISITN,PSAOSITN)="Unknown",PSACOMB=" No location identified" Q
"RTN","PSAUTL1",14,0)
 ;End PSA*3*22
"RTN","PSAUTL1",15,0)
 S PSAISIT=+$P($G(^PSD(58.8,PSALOC,0)),"^",3) D OPSITE
"RTN","PSAUTL1",16,0)
 I $G(PSAOSIT)="" S PSAOSIT=0
"RTN","PSAUTL1",17,0)
 S PSAISITN=$S($P($G(^PS(59.4,PSAISIT,0)),"^")'="":$P($G(^PS(59.4,PSAISIT,0)),"^"),1:"UNKNOWN")
"RTN","PSAUTL1",18,0)
 I PSAISIT,PSAOSIT S PSACOMB=": "_PSAISITN_" (IP) "_PSAOSITN_" (OP)" Q
"RTN","PSAUTL1",19,0)
 I PSAISIT S PSACOMB=": "_PSAISITN_" (IP)" Q
"RTN","PSAUTL1",20,0)
 I PSAOSIT S PSACOMB=": "_PSAOSITN_" (OP)" Q
"RTN","PSAUTL1",21,0)
 ;DAVE B (PSA*3*12) no DA sites defined
"RTN","PSAUTL1",22,0)
 S PSACOMB="No Inpatient or Outpatient Sites defined"
"RTN","PSAUTL1",23,0)
 Q
"RTN","PSAUTL1",24,0)
OPSITE ;PSA*3*25 - check for multiple OP sites
"RTN","PSAUTL1",25,0)
 ;VMP OIFO BAY PINES;ELR;PSA*3*49  ADDED THE FOLLOWING LINE
"RTN","PSAUTL1",26,0)
 S (PSAOSIT,PSAOSITN)=""
"RTN","PSAUTL1",27,0)
 K PSAOSITC
"RTN","PSAUTL1",28,0)
 Q:'$D(PSALOC)
"RTN","PSAUTL1",29,0)
 I '$D(^PSD(58.8,+PSALOC,7)),$P(^PSD(58.8,+PSALOC,0),"^",10)'="" S PSAOSIT=$P(^PSD(58.8,+PSALOC,0),"^",10),PSAOSITN=$P($G(^PS(59,PSAOSIT,0)),"^"),PSAOSITN=$S($G(PSAOSITN)="":"Unknown",1:PSAOSITN)
"RTN","PSAUTL1",30,0)
 S XX=0 F  S XX=$O(^PSD(58.8,+PSALOC,7,XX)) Q:XX'>0  S PSAOSIT=XX,PSAOSITC=$G(PSAOSITC)+1,SN=$P($G(^PS(59,XX,0)),"^") D
"RTN","PSAUTL1",31,0)
 .I PSAOSITC=1 S PSAOSITN=SN Q
"RTN","PSAUTL1",32,0)
 .S PSAOSITN=PSAOSITN_" & "_SN
"RTN","PSAUTL1",33,0)
 I $G(PSAOSITN)="",$P(^PSD(58.8,+PSALOC,0),"^",10)'="" S PSAOSIT=$P(^PSD(58.8,+PSALOC,0),"^",10),PSAOSITN=$P($G(^PS(59,+PSAOSIT,0)),"^")
"RTN","PSAUTL1",34,0)
 S PSAOSITN=$S($G(PSAOSITN)="":"unknown",1:PSAOSITN)
"RTN","PSAUTL1",35,0)
 Q
"RTN","PSAUTL1",36,0)
 ;
"RTN","PSAUTL1",37,0)
DISPLAY ;Displays an error-free line item
"RTN","PSAUTL1",38,0)
 S PSADISP=1
"RTN","PSAUTL1",39,0)
 S PSAIEN=$P(PSADATA,"^",6),PSASUB=$P($P(PSADATA,"^",7),"~"),PSANDC=$P($P(PSADATA,"^",4),"~"),PSAVSN=$P($P(PSADATA,"^",5),"~")
"RTN","PSAUTL1",40,0)
 W !,PSALINE_"  "_$S($P($G(^PSDRUG(PSAIEN,0)),"^")'="":$P(^PSDRUG(PSAIEN,0),"^"),1:"UNKNOWN")
"RTN","PSAUTL1",41,0)
 I PSAIEN D
"RTN","PSAUTL1",42,0)
 .I $P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" W " (Controlled Substance)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN MASTER VAULT **" Q
"RTN","PSAUTL1",43,0)
 .I $P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN PHARMACY LOCATION **"
"RTN","PSAUTL1",44,0)
 .I $D(^PSDRUG(PSAIEN,"I")) W !?5,"** INACTIVE IN DRUG FILE **"
"RTN","PSAUTL1",45,0)
 W !,"Qty Invoiced: "_+$P(PSADATA,"^")
"RTN","PSAUTL1",46,0)
 W:$P($P(PSADATA,"^",26),"~")'="" ?38,"UPC: "_$P($P(PSADATA,"^",26),"~")
"RTN","PSAUTL1",47,0)
 W !,"Order Unit  : "
"RTN","PSAUTL1",48,0)
 S PSAOU=$S(+$P(PSADATA,"^",12):+$P(PSADATA,"^",12),+$P($P(PSADATA,"^",2),"~",2):+$P($P(PSADATA,"^",2),"~",2),PSAIEN&(PSASUB)&(+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",5)):+$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",5),1:0)
"RTN","PSAUTL1",49,0)
 W $S(PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"UNKNOWN")
"RTN","PSAUTL1",50,0)
 W:$E(PSANDC)'="S" ?38,"NDC: " D PSANDC1^PSAHELP W PSANDCX K PSANDCX
"RTN","PSAUTL1",51,0)
 W !,"Unit Price  : $"_$P(PSADATA,"^",3),?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAUTL1",52,0)
 I $P(PSADATA,U,13)=.5 D  ;*48 AUTO OU UPDATE FOR MCKESSON
"RTN","PSAUTL1",53,0)
 . W !,"*****>",!,"Note: The order unit was changed from EACH to ",$P($G(^DIC(51.5,+PSAOU,0)),"^")," by Drug Accountability"
"RTN","PSAUTL1",54,0)
 . W !,"      during the upload of the invoiced data. Adjustments may be necessary.",!,"*****<"
"RTN","PSAUTL1",55,0)
 ;*54 display VSN XTMP Drug Description and DUOU >==>
"RTN","PSAUTL1",56,0)
 N PSAFLDT S PSAFLDT="February 2006"
"RTN","PSAUTL1",57,0)
 N XXX S XXX=$G(^XTMP("PSAVSN",PSAVSN)) D
"RTN","PSAUTL1",58,0)
 . I $G(^XTMP("PSAVSN",0)) S PSAFLDT=$P(^XTMP("PSAVSN",0),"^",4)
"RTN","PSAUTL1",59,0)
 . W !,"PV-Drug-Descrip: "
"RTN","PSAUTL1",60,0)
 . I '$L(XXX) W "Not Available. Item is OTC or new after ",PSAFLDT,! Q
"RTN","PSAUTL1",61,0)
 . W ?20,$P(XXX,"~",2),?55,"PV-DUOU: ",+XXX,!
"RTN","PSAUTL1",62,0)
 ;*54 display VSN XTMP Drug Description and DUOU <==<
"RTN","PSAUTL1",63,0)
 W !,"Dispense Units: "_$S(+PSAIEN&($P($G(^PSDRUG(+PSAIEN,660)),"^",8)'=""):$P($G(^PSDRUG(+PSAIEN,660)),"^",8),1:"Blank")
"RTN","PSAUTL1",64,0)
 W !,"Dispense Units Per Order Unit: "_$S($P(PSADATA,"^",20):+$P(PSADATA,"^",20),+PSASUB&(+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7),1:"Blank")
"RTN","PSAUTL1",65,0)
 S PSALOC=$S($P(PSADATA,"^",19)="":+$P(PSAIN,"^",7),1:+$P(PSAIN,"^",12))
"RTN","PSAUTL1",66,0)
 Q:'+$P($G(^PSD(58.8,+PSALOC,0)),"^",14)!('$G(PSAIEN))
"RTN","PSAUTL1",67,0)
 S PSASTOCK=$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3),1:"Blank")
"RTN","PSAUTL1",68,0)
 W !,"Stock Level   : "_PSASTOCK
"RTN","PSAUTL1",69,0)
 S PSAREORD=$S(+$P(PSADATA,"^",21):+$P(PSADATA,"^",21),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5),1:"Blank") ;*48
"RTN","PSAUTL1",70,0)
 W !,"Reorder Level : "_PSAREORD,!
"RTN","PSAUTL1",71,0)
 Q
"RTN","PSAUTL1",72,0)
 ;
"RTN","PSAUTL1",73,0)
EDITDISP ;Displays a line item with errors.
"RTN","PSAUTL1",74,0)
 W @IOF,!?23,"<<< PROCESS LINE ITEM SCREEN >>>",!,"Order#: "_$P(PSAIN,"^",4)_"  Invoice#: "_$P(PSAIN,"^",2)_"  Invoice Date: "_$$FMTE^XLFDT(+PSAIN),!,PSASLN
"RTN","PSAUTL1",75,0)
EDIT1 S PSADATA=$G(^XTMP("PSAPV",PSACTRL,"IT",PSALINE))
"RTN","PSAUTL1",76,0)
 S PSASUB=+$P(PSADATA,"^",7) ;*54
"RTN","PSAUTL1",77,0)
 S PSAIEN=+$P(PSADATA,"^",15) I PSAIEN ;*54
"RTN","PSAUTL1",78,0)
 E  S PSAIEN=+$P(PSADATA,"^",6) ;*54
"RTN","PSAUTL1",79,0)
 S PSALOC=$S($P(PSADATA,"^",19)="":+$P(PSAIN,"^",7),1:+$P(PSAIN,"^",12))
"RTN","PSAUTL1",80,0)
 W !,PSALINE_"  "_$S($D(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP")):$P(^XTMP("PSAPV",PSACTRL,"IT",PSALINE,"SUP"),"^",3),PSAIEN&($P($G(^PSDRUG(PSAIEN,0)),"^")'=""):$P(^PSDRUG(PSAIEN,0),"^"),1:"UNKNOWN ITEM")
"RTN","PSAUTL1",81,0)
 I PSAIEN D
"RTN","PSAUTL1",82,0)
 .I $P($G(^PSDRUG(PSAIEN,2)),"^",3)["N" W " (Controlled Substance)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN MASTER VAULT **" Q
"RTN","PSAUTL1",83,0)
 .I $P($G(^PSD(58.8,+$P(PSAIN,"^",7),1,PSAIEN,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN PHARMACY LOCATION **"
"RTN","PSAUTL1",84,0)
 ;
"RTN","PSAUTL1",85,0)
 W !,"Qty Invoiced: "
"RTN","PSAUTL1",86,0)
 I $P(PSADATA,"^",8)'="" W $P(PSADATA,"^",8)_" ("_$S(+PSADATA:+PSADATA,$P(PSADATA,"^")=0:0,1:"Blank")_")"
"RTN","PSAUTL1",87,0)
 I $P(PSADATA,"^",8)="" W $S(+PSADATA:+PSADATA,$P(PSADATA,"^")=0:0,1:"Blank")
"RTN","PSAUTL1",88,0)
 W:$P($P(PSADATA,"^",26),"~")'="" ?38,"UPC: "_$P($P(PSADATA,"^",26),"~")
"RTN","PSAUTL1",89,0)
 ;
"RTN","PSAUTL1",90,0)
 W !,"Order Unit  : "
"RTN","PSAUTL1",91,0)
 I +$P(PSADATA,"^",12) D
"RTN","PSAUTL1",92,0)
 .W $P($G(^DIC(51.5,+$P(PSADATA,"^",12),0)),"^")
"RTN","PSAUTL1",93,0)
 .W " ("_$S($P($P(PSADATA,"^",2),"~")'="":$P($P(PSADATA,"^",2),"~"),$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",3),0)),"^")'="":$P($G(^DIC(51.5,+$P($P(PSADATA,"^",2),"~",3),0)),"^"),1:"Blank")_")"
"RTN","PSAUTL1",94,0)
 I '+$P(PSADATA,"^",12) D
"RTN","PSAUTL1",95,0)
 .W $S(+$P($P(PSADATA,"^",2),"~",2):$P($P(PSADATA,"^",2),"~"),PSAIEN&(PSASUB)&(+$P($G(^PSDRUG(PSAIEN,1,PSASUB,0)),"^",5)):$P($G(^DIC(51.5,+$P(^PSDRUG(PSAIEN,1,PSASUB,0),"^",5),0)),"^"),1:"Blank")
"RTN","PSAUTL1",96,0)
 ;
"RTN","PSAUTL1",97,0)
 W:$E(PSANDC)'="S" ?38,"NDC: " D PSANDC1^PSAHELP W PSANDCX K PSANDCX
"RTN","PSAUTL1",98,0)
 S PSAPRICE=$P(PSADATA,"^",3)
"RTN","PSAUTL1",99,0)
 I +PSAPRICE,$L($P(PSAPRICE,".",2))<2 S PSAPRICE=$P(PSAPRICE,".")_"."_$P(PSAPRICE,".",2)_$E("00",1,(2-$L($P(PSAPRICE,".",2))))
"RTN","PSAUTL1",100,0)
 W !,"Unit Price  : $"_$S($G(PSAPRICE):PSAPRICE,PSAPRICE=0:0,1:"Blank"),?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAUTL1",101,0)
 I $P(PSADATA,U,13)=.5 D  ;*48 AUTO OU UPDATE FOR MCKESSON
"RTN","PSAUTL1",102,0)
 . N PSAOU S PSAOU=$P(PSADATA,U,12)
"RTN","PSAUTL1",103,0)
 . W !,"*****>",!,"Note: The order unit was changed from EACH to ",$P($G(^DIC(51.5,+PSAOU,0)),"^")," by Drug Accountability"
"RTN","PSAUTL1",104,0)
 . W !,"      during the upload of the invoiced data. Adjustments may be necessary.",!,"*****<"
"RTN","PSAUTL1",105,0)
 N PSAFLDT S PSAFLDT="February 2006"
"RTN","PSAUTL1",106,0)
 N XXX S XXX=$G(^XTMP("PSAVSN",PSAVSN)) D
"RTN","PSAUTL1",107,0)
 .I $G(^XTMP("PSAVSN",0)) S PSAFLDT=$P(^XTMP("PSAVSN",0),"^",4)
"RTN","PSAUTL1",108,0)
 . W !,"PV-Drug-Descrip: "
"RTN","PSAUTL1",109,0)
 . I '$L(XXX) W "Not Available. Item is OTC or new after ",PSAFLDT,! Q
"RTN","PSAUTL1",110,0)
 . W ?20,$P(XXX,"~",2),?55,"PV-DUOU: ",+XXX,!
"RTN","PSAUTL1",111,0)
 ;*54 display VSN XTMP Drug Description and DUOU <==<
"RTN","PSAUTL1",112,0)
 S PSAIN=^XTMP("PSAPV",PSACTRL,"IN"),PSALOC=$S($P(PSADATA,"^",19)="CS":+$P(PSAIN,"^",12),1:+$P(PSAIN,"^",7))
"RTN","PSAUTL1",113,0)
DU W !,"Dispense Units: "_$S(+PSAIEN&($P($G(^PSDRUG(+PSAIEN,660)),"^",8)'=""):$P($G(^PSDRUG(+PSAIEN,660)),"^",8),1:"Blank")
"RTN","PSAUTL1",114,0)
DUOU W !,"Dispense Units Per Order Unit: "_$S($P(PSADATA,"^",20):+$P(PSADATA,"^",20),+PSASUB&(+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(+PSAIEN,1,PSASUB,0)),"^",7),1:"Blank"),!
"RTN","PSAUTL1",115,0)
 ;
"RTN","PSAUTL1",116,0)
 Q:'+$P($G(^PSD(58.8,+PSALOC,0)),"^",14)
"RTN","PSAUTL1",117,0)
 ;
"RTN","PSAUTL1",118,0)
 S PSASTOCK=$S(+$P(PSADATA,"^",27):+$P(PSADATA,"^",27),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",3),1:"Blank")
"RTN","PSAUTL1",119,0)
 W "Stock Level   : "_PSASTOCK
"RTN","PSAUTL1",120,0)
 S PSAREORD=$S(+$P(PSADATA,"^",21):+$P(PSADATA,"^",21),+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSAIEN,0)),"^",5),1:"Blank")
"RTN","PSAUTL1",121,0)
 W !,"Reorder Level : "_PSAREORD,!
"RTN","PSAUTL1",122,0)
 Q
"RTN","PSAUTL4")
0^2^B26771267
"RTN","PSAUTL4",1,0)
PSAUTL4 ;BIR ISC/JMB-Verify Invoices Utility ; 8/19/97
"RTN","PSAUTL4",2,0)
 ;;3.0; DRUG ACCOUNTABILITY/INVENTORY INTERFACE;**3,21,48,54**; 10/24/97
"RTN","PSAUTL4",3,0)
 ;
"RTN","PSAUTL4",4,0)
 ;References to ^DIC(51.5 are covered by IA #1931
"RTN","PSAUTL4",5,0)
 ;References to ^PSDRUG( are covered by IA #2095
"RTN","PSAUTL4",6,0)
 I $G(PSADICW)=1 S PSALINE=Y
"RTN","PSAUTL4",7,0)
 ;This routine contains a utility to display a line item ready for
"RTN","PSAUTL4",8,0)
 ;verification. It is called by PSAVER1 and PSAVER2.
"RTN","PSAUTL4",9,0)
 ;
"RTN","PSAUTL4",10,0)
VERDISP ;Displays a line item on a processed or verified invoice
"RTN","PSAUTL4",11,0)
 W PSALINEN_"  "
"RTN","PSAUTL4",12,0)
DRUG S PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","D",0))
"RTN","PSAUTL4",13,0)
 I $G(PSADJ) D
"RTN","PSAUTL4",14,0)
 .S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0))
"RTN","PSAUTL4",15,0)
 .S PSADJD=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL4",16,0)
 .I PSADJD'?1.N S PSASUP=1
"RTN","PSAUTL4",17,0)
 .S PSADRG=$S(PSADJ&('PSASUP):$G(PSADJD),PSADJ&(PSASUP):0,1:+$P(PSADATA,"^",2))
"RTN","PSAUTL4",18,0)
 .I $G(PSADJD),$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")'="" W "*"_$P($G(^PSDRUG(+PSADJD,0)),"^") S (PSADRG,PSA50IEN)=+PSADJD Q
"RTN","PSAUTL4",19,0)
 .I $G(PSADJD),$L(PSADJD)=+$L(PSADJD),$P($G(^PSDRUG(+PSADJD,0)),"^")="" S (PSADJ,PSADRG)=0 Q
"RTN","PSAUTL4",20,0)
 .W ?7,"**"_PSADJD S PSADJSUP=1,(PSADRG,PSA50IEN)=PSADJD
"RTN","PSAUTL4",21,0)
 I '$G(PSADJ) D
"RTN","PSAUTL4",22,0)
 .S (PSA50IEN,PSADRG)=$S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):+$P(PSADATA,"^",2),1:0)
"RTN","PSAUTL4",23,0)
 .W $S(+$P(PSADATA,"^",2)&($P($G(^PSDRUG(+$P(PSADATA,"^",2),0)),"^")'=""):$P(^PSDRUG(+$P(PSADATA,"^",2),0),"^"),1:"DRUG UNKNOWN")
"RTN","PSAUTL4",24,0)
 I PSADRG D
"RTN","PSAUTL4",25,0)
 .I $P($G(^PSDRUG(PSADRG,2)),"^",3)["N" W " (Controlled Substance)" I $P($G(^PSD(58.8,+$P(PSAIN,"^",12),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN MASTER VAULT **"
"RTN","PSAUTL4",26,0)
 .I $D(^PSDRUG(PSADRG,"I")) W !?5,"** INACTIVE IN DRUG FILE **" Q
"RTN","PSAUTL4",27,0)
 .I $P($G(^PSD(58.8,+$P(PSAIN,"^",5),1,PSADRG,0)),"^",14),$P($G(^(0)),"^",14)'>DT W !,$C(7),$C(7),"** INACTIVE IN PHARMACY LOCATION **"
"RTN","PSAUTL4",28,0)
QTY W !,"Qty Invoiced: "
"RTN","PSAUTL4",29,0)
 ;No Adj. Qty
"RTN","PSAUTL4",30,0)
 S PSADJQ="",PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","Q",0))
"RTN","PSAUTL4",31,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJQ=$S($P(PSANODE,"^",6)'="":+$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL4",32,0)
 ;Adj. Qty
"RTN","PSAUTL4",33,0)
 I $G(PSADJQ) S PSAQTY=PSADJQ W PSAQTY_" ("_$S($P(PSADATA,"^",3):$P(PSADATA,"^",3),$P(PSADATA,"^",3)=0:0,1:"Blank")_")"
"RTN","PSAUTL4",34,0)
 I '$G(PSADJQ) W $P(PSADATA,"^",3) S PSAQTY=$P(PSADATA,"^",3)
"RTN","PSAUTL4",35,0)
UPC W:$P(PSADATA,"^",13)'="" ?38,"UPC: "_$P(PSADATA,"^",13)
"RTN","PSAUTL4",36,0)
OU W !,"Order Unit  : "
"RTN","PSAUTL4",37,0)
 S PSAOU=$S(+$P(PSADATA,"^",4)&($P($G(^DIC(51.5,+$P(PSADATA,"^",4),0)),"^")'=""):+$P(PSADATA,"^",4),1:"")
"RTN","PSAUTL4",38,0)
 S PSATEMP=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,2))
"RTN","PSAUTL4",39,0)
 I +$P(PSATEMP,"^",3),PSADRG,+$P($G(^PSDRUG(PSADRG,1,+$P(PSATEMP,"^",3),0)),"^",5) S PSAOU=+$P(^PSDRUG(PSADRG,1,+$P(PSATEMP,"^",3),0),"^",5)
"RTN","PSAUTL4",40,0)
 S PSADJO="",PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","O",0))
"RTN","PSAUTL4",41,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJO=$S($P(PSANODE,"^",6)'="":$P(PSANODE,"^",6),1:$P(PSANODE,"^",2))
"RTN","PSAUTL4",42,0)
 ;Adj. Order Unit
"RTN","PSAUTL4",43,0)
 I PSADJO'="" W $S(+PSADJO&($P($G(^DIC(51.5,+PSADJO,0)),"^")'=""):$P($G(^DIC(51.5,+PSADJO,0)),"^"),1:"UNKNOWN")_" ("_$S(PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"Blank")_")" S PSAOU=+PSADJO
"RTN","PSAUTL4",44,0)
 I PSADJO="" W $S(+PSAOU:$P($G(^DIC(51.5,+PSAOU,0)),"^"),1:"Blank")
"RTN","PSAUTL4",45,0)
 ;
"RTN","PSAUTL4",46,0)
NDC S PSANDC=$P(PSADATA,"^",11)
"RTN","PSAUTL4",47,0)
 I $E(PSANDC)'="S" W ?38,"NDC: " D PSANDC1^PSAHELP W PSANDCX K PSANDCX
"RTN","PSAUTL4",48,0)
 ;
"RTN","PSAUTL4",49,0)
PRICE W !,"Unit Price  : $"
"RTN","PSAUTL4",50,0)
 S PSADJP=0,PSADJ=+$O(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,"B","P",0))
"RTN","PSAUTL4",51,0)
 I $G(PSADJ) S PSANODE=$G(^PSD(58.811,PSAIEN,1,PSAIEN1,1,PSALINE,1,PSADJ,0)),PSADJP=$S(+$P(PSANODE,"^",6):+$P(PSANODE,"^",6),1:+$P(PSANODE,"^",2))
"RTN","PSAUTL4",52,0)
 ;Adj. Unit Price
"RTN","PSAUTL4",53,0)
 I $G(PSADJP) D
"RTN","PSAUTL4",54,0)
 .I $L($P(PSADJP,".",2))<2 S PSADJP=$P(PSADJP,".")_"."_$P(PSADJP,".",2)_$E("00",1,(2-$L($P(PSADJP,".",2))))
"RTN","PSAUTL4",55,0)
 .W $FN(PSADJP,",")_" ($"_$S(+$P(PSADATA,"^",5):$FN($P(PSADATA,"^",5),","),$P(PSADATA,"^",5)=0:"0.00",1:"")_")"
"RTN","PSAUTL4",56,0)
 .S PSAPRICE=PSADJP
"RTN","PSAUTL4",57,0)
 I '$G(PSADJP) D
"RTN","PSAUTL4",58,0)
 .S PSAPRICE=+$P(PSADATA,"^",5)
"RTN","PSAUTL4",59,0)
 .I $G(PSAPRICE)!(PSAPRICE=0) W $S($G(PSAPRICE):PSAPRICE,1:"0.00") Q
"RTN","PSAUTL4",60,0)
 .W "Blank"
"RTN","PSAUTL4",61,0)
 ;
"RTN","PSAUTL4",62,0)
VSN S:$D(PSADATA) PSAVSN=$P(PSADATA,"^",12) ;*48
"RTN","PSAUTL4",63,0)
 W ?38,"VSN: "_$S(PSAVSN'="":PSAVSN,1:"Blank"),!
"RTN","PSAUTL4",64,0)
 ;*54 display VSN XTMP Drug Description and DUOU |==>
"RTN","PSAUTL4",65,0)
 N PSAFLDT S PSAFLDT="February 2006"
"RTN","PSAUTL4",66,0)
 N XXX I PSAVSN'="" S XXX=$G(^XTMP("PSAVSN",PSAVSN)) D
"RTN","PSAUTL4",67,0)
 . I $G(^XTMP("PSAVSN",0)) S PSAFLDT=$P(^XTMP("PSAVSN",0),"^",4)
"RTN","PSAUTL4",68,0)
 . W !,"PV-Drug-Descrip: "
"RTN","PSAUTL4",69,0)
 . I '$L(XXX) W "Not Available. Item is OTC or new after ",PSAFLDT,! Q
"RTN","PSAUTL4",70,0)
 . W ?20,$P(XXX,"~",2),?55,"PV-DUOU: ",+XXX,!
"RTN","PSAUTL4",71,0)
 ;*54 display VSN XTMP Drug Description and DUOU <==|
"RTN","PSAUTL4",72,0)
VDU S PSADUOU=+$P(PSATEMP,"^"),PSAREORD=+$P(PSATEMP,"^",2),PSASUB=+$P(PSATEMP,"^",3),PSASTOCK=+$P(PSATEMP,"^",4)
"RTN","PSAUTL4",73,0)
 W !,"Dispense Units: "_$S($P($G(^PSDRUG(+PSADRG,660)),"^",8)'="":$P($G(^PSDRUG(+PSADRG,660)),"^",8),1:"Blank")
"RTN","PSAUTL4",74,0)
VDUOU W !,"Dispense Units Per Order Unit: "_$S(+PSADUOU:+PSADUOU,+PSASUB&(+$P($G(^PSDRUG(+PSADRG,1,PSASUB,0)),"^",7)):+$P($G(^PSDRUG(+PSADRG,1,PSASUB,0)),"^",7),1:"Blank"),!
"RTN","PSAUTL4",75,0)
 ;
"RTN","PSAUTL4",76,0)
 Q:'+$P($G(^PSD(58.8,+PSALOC,0)),"^",14)
"RTN","PSAUTL4",77,0)
 ;
"RTN","PSAUTL4",78,0)
STOCK S PSASTOCK=$S(+PSASTOCK:+PSASTOCK,+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",3):+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",3),1:"Blank")
"RTN","PSAUTL4",79,0)
 W "Stock Level   : "_PSASTOCK
"RTN","PSAUTL4",80,0)
REORDER S PSAREORD=$S(+PSAREORD:+PSAREORD,+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",5):+$P($G(^PSD(58.8,+PSALOC,1,+PSADRG,0)),"^",5),1:"Blank")
"RTN","PSAUTL4",81,0)
 W !,"Reorder Level : "_PSAREORD,!
"RTN","PSAUTL4",82,0)
 Q
"VER")
8.0^22.0
**END**
**END**
