Released PRCA*4.5*214 SEQ #183
Extracted from mail message
**KIDS**:PRCA*4.5*214^

**INSTALL NAME**
PRCA*4.5*214
"BLD",5360,0)
PRCA*4.5*214^ACCOUNTS RECEIVABLE^0^3040203^y
"BLD",5360,1,0)
^^6^6^3040129^
"BLD",5360,1,1,0)
This patch addresses two issues.  The first issue is regarding the payment
"BLD",5360,1,2,0)
amount listed in the Electronic Remittance Advices (ERA) messages that is
"BLD",5360,1,3,0)
not equal to the amount for the Electronic Funds Transfer (EFT). The EFT
"BLD",5360,1,4,0)
can be referenced for the ERA payment that the payer has paid for a bill.
"BLD",5360,1,5,0)
The second issue concerns an undefined error when processing an EDI
"BLD",5360,1,6,0)
LOCKBOX receipt.
"BLD",5360,4,0)
^9.64PA^344.3^1
"BLD",5360,4,344.3,0)
344.3
"BLD",5360,4,344.3,2,0)
^9.641^344.3^1
"BLD",5360,4,344.3,2,344.3,0)
EDI LOCKBOX DEPOSIT  (File-top level)
"BLD",5360,4,344.3,2,344.3,1,0)
^9.6411^.01^1
"BLD",5360,4,344.3,2,344.3,1,.01,0)
NUMBER
"BLD",5360,4,344.3,222)
y^n^p^^^^n^^n
"BLD",5360,4,344.3,224)

"BLD",5360,4,"APDD",344.3,344.3)

"BLD",5360,4,"APDD",344.3,344.3,.01)

"BLD",5360,4,"B",344.3,344.3)

"BLD",5360,"ABPKG")

"BLD",5360,"INI")
PRE^PRCAP214
"BLD",5360,"INIT")
POST^PRCAP214
"BLD",5360,"KRN",0)
^9.67PA^8989.52^19
"BLD",5360,"KRN",.4,0)
.4
"BLD",5360,"KRN",.4,"NM",0)
^9.68A^^
"BLD",5360,"KRN",.401,0)
.401
"BLD",5360,"KRN",.402,0)
.402
"BLD",5360,"KRN",.403,0)
.403
"BLD",5360,"KRN",.5,0)
.5
"BLD",5360,"KRN",.84,0)
.84
"BLD",5360,"KRN",3.6,0)
3.6
"BLD",5360,"KRN",3.8,0)
3.8
"BLD",5360,"KRN",9.2,0)
9.2
"BLD",5360,"KRN",9.8,0)
9.8
"BLD",5360,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",5360,"KRN",9.8,"NM",1,0)
RCDPESR1^^0^B44231944
"BLD",5360,"KRN",9.8,"NM",2,0)
RCDPESR3^^0^B44453222
"BLD",5360,"KRN",9.8,"NM",3,0)
RCDPESR6^^0^B25707820
"BLD",5360,"KRN",9.8,"NM",4,0)
RCDPURE1^^0^B55128405
"BLD",5360,"KRN",9.8,"NM","B","RCDPESR1",1)

"BLD",5360,"KRN",9.8,"NM","B","RCDPESR3",2)

"BLD",5360,"KRN",9.8,"NM","B","RCDPESR6",3)

"BLD",5360,"KRN",9.8,"NM","B","RCDPURE1",4)

"BLD",5360,"KRN",19,0)
19
"BLD",5360,"KRN",19,"NM",0)
^9.68A^^
"BLD",5360,"KRN",19.1,0)
19.1
"BLD",5360,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",5360,"KRN",101,0)
101
"BLD",5360,"KRN",101,"NM",0)
^9.68A^^
"BLD",5360,"KRN",409.61,0)
409.61
"BLD",5360,"KRN",409.61,"NM",0)
^9.68A^^0
"BLD",5360,"KRN",771,0)
771
"BLD",5360,"KRN",771,"NM",0)
^9.68A^^
"BLD",5360,"KRN",870,0)
870
"BLD",5360,"KRN",870,"NM",0)
^9.68A^^
"BLD",5360,"KRN",8989.51,0)
8989.51
"BLD",5360,"KRN",8989.51,"NM",0)
^9.68A^^
"BLD",5360,"KRN",8989.52,0)
8989.52
"BLD",5360,"KRN",8989.52,"NM",0)
^9.68A^^
"BLD",5360,"KRN",8994,0)
8994
"BLD",5360,"KRN",8994,"NM",0)
^9.68A^^
"BLD",5360,"KRN","B",.4,.4)

"BLD",5360,"KRN","B",.401,.401)

"BLD",5360,"KRN","B",.402,.402)

"BLD",5360,"KRN","B",.403,.403)

"BLD",5360,"KRN","B",.5,.5)

"BLD",5360,"KRN","B",.84,.84)

"BLD",5360,"KRN","B",3.6,3.6)

"BLD",5360,"KRN","B",3.8,3.8)

"BLD",5360,"KRN","B",9.2,9.2)

"BLD",5360,"KRN","B",9.8,9.8)

"BLD",5360,"KRN","B",19,19)

"BLD",5360,"KRN","B",19.1,19.1)

"BLD",5360,"KRN","B",101,101)

"BLD",5360,"KRN","B",409.61,409.61)

"BLD",5360,"KRN","B",771,771)

"BLD",5360,"KRN","B",870,870)

"BLD",5360,"KRN","B",8989.51,8989.51)

"BLD",5360,"KRN","B",8989.52,8989.52)

"BLD",5360,"KRN","B",8994,8994)

"BLD",5360,"PRE")
PRCAP211
"BLD",5360,"QUES",0)
^9.62^^
"BLD",5360,"REQB",0)
^9.611^3^1
"BLD",5360,"REQB",3,0)
PRCA*4.5*173^2
"BLD",5360,"REQB","B","PRCA*4.5*173",3)

"FIA",344.3)
EDI LOCKBOX DEPOSIT
"FIA",344.3,0)
^RCY(344.3,
"FIA",344.3,0,0)
344.3I
"FIA",344.3,0,1)
y^n^p^^^^n^^n
"FIA",344.3,0,10)

"FIA",344.3,0,11)

"FIA",344.3,0,"RLRO")

"FIA",344.3,0,"VR")
4.5^PRCA
"FIA",344.3,344.3)
1
"FIA",344.3,344.3,.01)

"INI")
PRE^PRCAP214
"INIT")
POST^PRCAP214
"MBREQ")
0
"PKG",142,-1)
1^1
"PKG",142,0)
ACCOUNTS RECEIVABLE^PRCA^BILL COLLECTIONS
"PKG",142,20,0)
^9.402P^^0
"PKG",142,22,0)
^9.49I^1^1
"PKG",142,22,1,0)
4.5^^2950320
"PKG",142,22,1,"PAH",1,0)
214^3040203
"PKG",142,22,1,"PAH",1,1,0)
^^6^6^3040203
"PKG",142,22,1,"PAH",1,1,1,0)
This patch addresses two issues.  The first issue is regarding the payment
"PKG",142,22,1,"PAH",1,1,2,0)
amount listed in the Electronic Remittance Advices (ERA) messages that is
"PKG",142,22,1,"PAH",1,1,3,0)
not equal to the amount for the Electronic Funds Transfer (EFT). The EFT
"PKG",142,22,1,"PAH",1,1,4,0)
can be referenced for the ERA payment that the payer has paid for a bill.
"PKG",142,22,1,"PAH",1,1,5,0)
The second issue concerns an undefined error when processing an EDI
"PKG",142,22,1,"PAH",1,1,6,0)
LOCKBOX receipt.
"PRE")
PRCAP211
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
YES
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
YES
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
YES
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
6
"RTN","PRCAP211")
0^^B4000932
"RTN","PRCAP211",1,0)
PRCAP211 ;ALB/CXW - PATCH PRCA*4.5*211 ENVIRONMENT CHECK
"RTN","PRCAP211",2,0)
 ;;4.5;Accounts Receivable;**211,196,214**;Mar 20, 1995
"RTN","PRCAP211",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","PRCAP211",4,0)
ENV ;
"RTN","PRCAP211",5,0)
 ;this is the environment check routine
"RTN","PRCAP211",6,0)
 I $$PATCH^XPDUTL("PRCA*4.5*175") D
"RTN","PRCAP211",7,0)
 . W "You are a test site for a CoreFLS version (patch PRCA*4.5*175) of Accounts",!
"RTN","PRCAP211",8,0)
 . W "Receivable. This patch has a conflict with the AR-CoreFLS test software.",!
"RTN","PRCAP211",9,0)
 . W "It must NOT be installed unless an accompanying update is made to the",!
"RTN","PRCAP211",10,0)
 . W "AR-CoreFLS software immediately after installation of this patch.",!!
"RTN","PRCAP211",11,0)
 . N DIR,DTOUT,DUOUT,Y
"RTN","PRCAP211",12,0)
 . S DIR(0)="YA"
"RTN","PRCAP211",13,0)
 . S DIR("A")="Do you have the corresponding update to the AR-CoreFLS software that is associated with this patch? (Note: Entering ""No"" here will stop the installation of this patch) Y/N//"
"RTN","PRCAP211",14,0)
 . D ^DIR
"RTN","PRCAP211",15,0)
 . I $D(DTOUT)!$D(DUOUT)!(Y'=1) W !,"Installation of this patch has been stopped!" S XPDQUIT=1 Q
"RTN","PRCAP211",16,0)
 . W !,"OK to install!"
"RTN","PRCAP211",17,0)
 Q
"RTN","PRCAP214")
0^^B2536079
"RTN","PRCAP214",1,0)
PRCAP214 ;ALB/CXW - PATCH PRCA*4.5*214 PRE/POST-INIT
"RTN","PRCAP214",2,0)
 ;;4.5;Accounts Receivable;**214**;Mar 20, 1995
"RTN","PRCAP214",3,0)
 Q
"RTN","PRCAP214",4,0)
PRE ;pre-init to ensure all entries for the EFTs are DINUMED 
"RTN","PRCAP214",5,0)
 N Z,DA,DIE,DR,X,Y
"RTN","PRCAP214",6,0)
 S Z=0 F  S Z=$O(^RCY(344.3,Z)) Q:'Z  I Z'=+$G(^(Z,0)) S DA=Z,DR=".01////"_Z,DIE="^RCY(344.3," D ^DIE
"RTN","PRCAP214",7,0)
 Q
"RTN","PRCAP214",8,0)
POST ;post-init to build a list of the ERAs with invalid payment adjustments
"RTN","PRCAP214",9,0)
 N RC,RC0,RCSEQ,RCIFN,RCOLD,RCT
"RTN","PRCAP214",10,0)
 ;
"RTN","PRCAP214",11,0)
 D MES^XPDUTL("LIST OF ERA's WITH INVALID PAYMENT ADJUSTMENTS")
"RTN","PRCAP214",12,0)
 ;
"RTN","PRCAP214",13,0)
 S RCOLD=-1,RC=0,RCT=0,RCIFN=""
"RTN","PRCAP214",14,0)
 F  S RC=$O(^RCY(344.4,RC)) Q:'RC  F RCSEQ=1:1 S RCIFN=+$O(^RCY(344.4,RC,1,"B",RCSEQ,RCIFN)) D  Q:'RCIFN
"RTN","PRCAP214",15,0)
 . I 'RCIFN Q:RCOLD'<0  S RC0=$G(^RCY(344.4,RC,0)) D MES^XPDUTL("  ERA #:"_RC_"  TRACE #:"_$P(RC0,U,2)_"  REC'D:"_$$FMTE^XLFDT($P(RC0,U,7),"2D")_"  MSG #:"_$P(RC0,U,12)) S RCT=RCT+1 Q
"RTN","PRCAP214",16,0)
 . S RCOLD=$P($G(^RCY(344.4,RC,1,RCIFN,0)),U,3)
"RTN","PRCAP214",17,0)
 ;
"RTN","PRCAP214",18,0)
 D MES^XPDUTL("THERE WERE "_$S(RCT=0:"NO",1:RCT)_" ERA(s) FOUND")
"RTN","PRCAP214",19,0)
 Q
"RTN","RCDPESR1")
0^1^B44231944
"RTN","RCDPESR1",1,0)
RCDPESR1 ;ALB/TMP - Server interface to AR from Austin ;06/03/02
"RTN","RCDPESR1",2,0)
 ;;4.5;Accounts Receivable;**173,214**;Mar 20, 1995
"RTN","RCDPESR1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","RCDPESR1",4,0)
 Q
"RTN","RCDPESR1",5,0)
 ;
"RTN","RCDPESR1",6,0)
PERROR(RCERR,RCEMG,RCXMZ) ; Process Errors - Send bulletin to mail group
"RTN","RCDPESR1",7,0)
 ; RCERR = Error text array
"RTN","RCDPESR1",8,0)
 ; RCEMG = name of the mail group to which these errors should be sent
"RTN","RCDPESR1",9,0)
 ; RCXMZ = internal entry # of the mailman msg
"RTN","RCDPESR1",10,0)
 ; RCTYPE = msg type, if known
"RTN","RCDPESR1",11,0)
 N CT,XMDUZ,XMSUBJ,XMBODY,XMB,XMINSTR,XMTYPE,XMFULL,XMTO,RCXM,XMZ,XMERR,Z
"RTN","RCDPESR1",12,0)
 ;
"RTN","RCDPESR1",13,0)
 S CT=0
"RTN","RCDPESR1",14,0)
 ;
"RTN","RCDPESR1",15,0)
 I $G(RCEMG)="" S CT=CT+1,RCXM(CT)=$P($T(ERROR+2),";;",2),XMTO(.5)=""
"RTN","RCDPESR1",16,0)
 ;
"RTN","RCDPESR1",17,0)
 I $D(RCEMG) D
"RTN","RCDPESR1",18,0)
 . S:RCEMG="" RCEMG="RCDPE PAYMENTS EXCEPTIONS"
"RTN","RCDPESR1",19,0)
 . S:$E(RCEMG,1,2)'="G." RCEMG="G."_RCEMG
"RTN","RCDPESR1",20,0)
 . S XMTO("I:"_RCEMG)=""
"RTN","RCDPESR1",21,0)
 ;
"RTN","RCDPESR1",22,0)
 S Z=$O(XMTO("")) I Z=.5,'$O(XMTO(.5)) S XMTO("I:G.RCDPE PAYMENTS EXCEPTIONS")=""
"RTN","RCDPESR1",23,0)
 D EMFORM(CT,.RCERR,.RCXM,RCXMZ)
"RTN","RCDPESR1",24,0)
 ;
"RTN","RCDPESR1",25,0)
 S XMDUZ=""
"RTN","RCDPESR1",26,0)
 S XMSUBJ="EDI LBOX SERVER OPTION ERROR",XMBODY="RCXM"
"RTN","RCDPESR1",27,0)
 D
"RTN","RCDPESR1",28,0)
 . N DUZ S DUZ=.5,DUZ(0)="@"
"RTN","RCDPESR1",29,0)
 . D SENDMSG^XMXAPI(.5,XMSUBJ,XMBODY,.XMTO,,.XMZ)
"RTN","RCDPESR1",30,0)
 K ^TMP("RCRAW",$J)
"RTN","RCDPESR1",31,0)
 Q
"RTN","RCDPESR1",32,0)
 ;
"RTN","RCDPESR1",33,0)
EMFORM(CT,RCERR,RCXM,RCXMZ) ; Format error msgs
"RTN","RCDPESR1",34,0)
 ; INPUT:
"RTN","RCDPESR1",35,0)
 ;   CT = # of lines previously populated in error msg
"RTN","RCDPESR1",36,0)
 ;   RCERR = array of errors
"RTN","RCDPESR1",37,0)
 ;   RCXMZ = internal entry # of mailman msg
"RTN","RCDPESR1",38,0)
 ;
"RTN","RCDPESR1",39,0)
 ; OUTPUT:
"RTN","RCDPESR1",40,0)
 ;   RCXM = array containing the complete error msg text
"RTN","RCDPESR1",41,0)
 ;
"RTN","RCDPESR1",42,0)
 N TTYPE,TDATE,TTIME,Z
"RTN","RCDPESR1",43,0)
 ;
"RTN","RCDPESR1",44,0)
 S TDATE=$G(^TMP("RCERR",$J,"DATE")),TTIME=$P(TDATE,".",2)_"000000",TDATE=$$FMTE^XLFDT($P(TDATE,"."),"2D")
"RTN","RCDPESR1",45,0)
 S TTYPE=$G(^TMP("RCMSG",$J))
"RTN","RCDPESR1",46,0)
 ;
"RTN","RCDPESR1",47,0)
 S CT=CT+1
"RTN","RCDPESR1",48,0)
 S RCXM(CT)="** AN EXCEPTION HAS BEEN DETECTED FOR AN EDI LOCKBOX RETURN MESSAGE **",CT=CT+1,RCXM(CT)=" "
"RTN","RCDPESR1",49,0)
 S CT=CT+1
"RTN","RCDPESR1",50,0)
 S RCXM(CT)="             Return Message Code: "_$S(TTYPE="":$S($G(^TMP("RCERR",$J,"TYPE"))'="":^("TYPE"),1:"Cannot be determined"),1:TTYPE)
"RTN","RCDPESR1",51,0)
 ;
"RTN","RCDPESR1",52,0)
 S CT=CT+2
"RTN","RCDPESR1",53,0)
 S RCXM(CT-1)=" ",RCXM(CT)=$J("",13)_"Return Message Date: "_TDATE_"    Message Time: "_$E(TTIME,1,2)_":"_$E(TTIME,3,4)_":"_$E(TTIME,5,6),CT=CT+1
"RTN","RCDPESR1",54,0)
 ;
"RTN","RCDPESR1",55,0)
 S CT=CT+2,RCXM(CT-1)=" ",RCXM(CT)=$J("",15)_"Mailman Message #: "_$G(RCXMZ)
"RTN","RCDPESR1",56,0)
 ;
"RTN","RCDPESR1",57,0)
 I $G(RCERR)'="",RCERR?1A.E S CT=CT+2,RCXM(CT-1)=" ",RCXM(CT)=RCERR
"RTN","RCDPESR1",58,0)
 I $G(^TMP("RCERR",$J,"TEXT"))'="" S CT=CT+2,RCXM(CT)=^("TEXT"),RCXM(CT-1)=" "
"RTN","RCDPESR1",59,0)
 ;
"RTN","RCDPESR1",60,0)
 S Z="" F  S Z=$O(RCERR(Z)) Q:Z=""  S:$G(^TMP("RCERR",$J,"TEXT"))="" CT=CT+1,RCXM(CT)=" " I $G(RCERR(Z))'="",RCERR(Z)'=" " S CT=CT+1,RCXM(CT)=RCERR(Z)
"RTN","RCDPESR1",61,0)
 S Z=0 F  S Z=$O(^TMP("RCERR",$J,"MSG",Z)) Q:'Z  S CT=CT+1,RCXM(CT)=^(Z)
"RTN","RCDPESR1",62,0)
 ;
"RTN","RCDPESR1",63,0)
 Q
"RTN","RCDPESR1",64,0)
 ;
"RTN","RCDPESR1",65,0)
EXTERR(RCERR,RCE) ; Put error into error array
"RTN","RCDPESR1",66,0)
 ; Returns: (must be passed by reference)
"RTN","RCDPESR1",67,0)
 ;   RCERR = specific error encountered, returned as 4
"RTN","RCDPESR1",68,0)
 ;   RCE = error text from the word processing field update error global
"RTN","RCDPESR1",69,0)
 N RCZ,Q
"RTN","RCDPESR1",70,0)
 S RCE="",RCERR=4 ; error reported as 'record was partially stored'
"RTN","RCDPESR1",71,0)
 S RCZ=0 F  S RCZ=$O(RCE("DIERR",RCZ)) Q:'RCZ  S Q=$G(RCE("DIERR",RCZ,"TEXT",1)) I $L(Q),$L(Q)+$L(RCE)<99 S RCE=RCE_Q_";;"
"RTN","RCDPESR1",72,0)
 Q
"RTN","RCDPESR1",73,0)
 ;
"RTN","RCDPESR1",74,0)
ERRUPD(RCGBL,RCD,RCTYPE,RCERR) ; Set up global array to hold msg data
"RTN","RCDPESR1",75,0)
 ; RCGBL = name of the global or array where msg data is found
"RTN","RCDPESR1",76,0)
 ; RCD = array containing mail header data for the msg
"RTN","RCDPESR1",77,0)
 ; RCTYPE = type of msg (835ERA/835XFR/etc)
"RTN","RCDPESR1",78,0)
 ; RCERR = error array - text or reference to error tables below
"RTN","RCDPESR1",79,0)
 ;
"RTN","RCDPESR1",80,0)
 ; Returns ^TMP("RCERR",$J,"MSG" array with formatted error text
"RTN","RCDPESR1",81,0)
 ;
"RTN","RCDPESR1",82,0)
 N Z,Z0,Z1,Z2,CT,RCE
"RTN","RCDPESR1",83,0)
 ;
"RTN","RCDPESR1",84,0)
 Q:$G(RCERR)<0
"RTN","RCDPESR1",85,0)
 K ^TMP("RCERR",$J)
"RTN","RCDPESR1",86,0)
 S CT=0
"RTN","RCDPESR1",87,0)
 ;
"RTN","RCDPESR1",88,0)
 S ^TMP("RCERR",$J,"DATE")=$G(RCD("DATE"))
"RTN","RCDPESR1",89,0)
 S ^TMP("RCERR",$J,"TYPE")=$G(RCTYPE)
"RTN","RCDPESR1",90,0)
 S ^TMP("RCERR",$J,"SUBJ")=$G(RCD("SUBJ"))
"RTN","RCDPESR1",91,0)
 ;
"RTN","RCDPESR1",92,0)
 I $G(RCERR)>0,RCERR<20 D
"RTN","RCDPESR1",93,0)
 . S Z="ERROR2+"_RCERR
"RTN","RCDPESR1",94,0)
 . S RCE=$P($T(@Z),";;",2)
"RTN","RCDPESR1",95,0)
 . I RCE'="" S ^TMP("RCERR",$J,"TEXT")=RCE
"RTN","RCDPESR1",96,0)
 ;
"RTN","RCDPESR1",97,0)
 S Z="" F  S Z=$O(RCERR(Z)) Q:Z=""  S Z0="" F  S Z0=$O(RCERR(Z,Z0)) Q:Z0=""  S RCE=$G(RCERR(Z,Z0)) D
"RTN","RCDPESR1",98,0)
 . I $L(RCE) S CT=CT+1,^TMP("RCERR",$J,"MSG",CT)=$S(RCE:$P($T(ERROR+RCE),";;",2),1:RCE)
"RTN","RCDPESR1",99,0)
 . S RCTYPE=$P($G(@RCGBL@(0)),U)
"RTN","RCDPESR1",100,0)
 . S:$G(^TMP("RCERR",$J,"TYPE"))="" ^("TYPE")=RCTYPE
"RTN","RCDPESR1",101,0)
 . S Z1=""
"RTN","RCDPESR1",102,0)
 . F  S Z1=$O(@RCGBL@(1,"D",Z1)) Q:Z1=""  S CT=CT+1,^TMP("RCERR",$J,"MSG",CT)=$G(@RCGBL@(1,"D",Z1))
"RTN","RCDPESR1",103,0)
 ;
"RTN","RCDPESR1",104,0)
 I $D(@RCGBL@(2,"D")) D
"RTN","RCDPESR1",105,0)
 . S CT=CT+2,^TMP("RCERR",$J,"MSG",CT-1)=" ",^TMP("RCERR",$J,"MSG",CT)="**** RAW MESSAGE DATA ****:"
"RTN","RCDPESR1",106,0)
 . I $G(^TMP("RCMSGH",$J,0))'="" S CT=CT+1,^TMP("RCERR",$J,"MSG",CT)=^TMP("RCMSGH",$J,0)
"RTN","RCDPESR1",107,0)
 . S Z2="" F  S Z2=$O(@RCGBL@(2,"D",Z2)) Q:Z2=""  S CT=CT+1,^TMP("RCERR",$J,"MSG",CT)=$G(@RCGBL@(2,"D",Z2))
"RTN","RCDPESR1",108,0)
 E  D
"RTN","RCDPESR1",109,0)
 . Q:'$D(^TMP("RCRAW",$J))
"RTN","RCDPESR1",110,0)
 . S CT=CT+2,^TMP("RCERR",$J,"MSG",CT-1)=" ",^TMP("RCERR",$J,"MSG",CT)="**** RAW MESSAGE DATA ****:"
"RTN","RCDPESR1",111,0)
 . I $G(^TMP("RCMSGH",$J,0))'="" S CT=CT+1,^TMP("RCERR",$J,"MSG",CT)=^TMP("RCMSGH",$J,0)
"RTN","RCDPESR1",112,0)
 . S Z2="" F  S Z2=$O(^TMP("RCRAW",$J,Z2)) Q:Z2=""  S CT=CT+1,^TMP("RCERR",$J,"MSG",CT)=$G(^TMP("RCRAW",$J,Z2))
"RTN","RCDPESR1",113,0)
 ;
"RTN","RCDPESR1",114,0)
 Q
"RTN","RCDPESR1",115,0)
 ;
"RTN","RCDPESR1",116,0)
DKILL(RCXMZ) ; Delete server mail msg from postmaster mailbox
"RTN","RCDPESR1",117,0)
 ; RCXMZ = ien of mailman msg
"RTN","RCDPESR1",118,0)
 ;
"RTN","RCDPESR1",119,0)
 D ZAPSERV^XMXAPI("S.RCDPE EDI LOCKBOX SERVER",RCXMZ)
"RTN","RCDPESR1",120,0)
 Q
"RTN","RCDPESR1",121,0)
 ;
"RTN","RCDPESR1",122,0)
TEMPDEL(DA) ; Delete msg from temporary msg file
"RTN","RCDPESR1",123,0)
 ; DA = ien of the entry in file 344.5
"RTN","RCDPESR1",124,0)
 ;
"RTN","RCDPESR1",125,0)
 N DIK,Y,X
"RTN","RCDPESR1",126,0)
 S DIK="^RCY(344.5," D ^DIK
"RTN","RCDPESR1",127,0)
 L -^RCY(344.5,DA,0)
"RTN","RCDPESR1",128,0)
 Q
"RTN","RCDPESR1",129,0)
 ;
"RTN","RCDPESR1",130,0)
RESTMSG(RCD,RCARRAY,XMZ) ; Read rest of msg, store in array
"RTN","RCDPESR1",131,0)
 ; RCD = last line # already in the msg
"RTN","RCDPESR1",132,0)
 ; RCARRAY = name of the array to store the data in
"RTN","RCDPESR1",133,0)
 ; XMZ = ien of the mailman msg
"RTN","RCDPESR1",134,0)
 ;
"RTN","RCDPESR1",135,0)
 F  X XMREC Q:XMER<0  S RCD=RCD+1,@RCARRAY@(RCD)=XMRG
"RTN","RCDPESR1",136,0)
 Q
"RTN","RCDPESR1",137,0)
 ;
"RTN","RCDPESR1",138,0)
TAXERR(RCTYPE,RCINS,RCTID,RCCHG) ; Send a bulletin for a bad tax id
"RTN","RCDPESR1",139,0)
 ; RCTYPE = "ERA" for an ERA record,  "EFT" for an EFT record
"RTN","RCDPESR1",140,0)
 ; RCINS = name and id to identify the ins co
"RTN","RCDPESR1",141,0)
 ; RCTID = tax id sent in error
"RTN","RCDPESR1",142,0)
 ; RCCHG = code describing how correction was made
"RTN","RCDPESR1",143,0)
 ;         'E'=EPHRA, 'C'=Changed by looking at claim #'s
"RTN","RCDPESR1",144,0)
 ;
"RTN","RCDPESR1",145,0)
 N XMBODY,XMB,XMINSTR,XMTYPE,XMFULL,XMTO,RCDXM,XMZ,XMERR,RCCT,RCDXM,RCCT
"RTN","RCDPESR1",146,0)
 S RCCT=0
"RTN","RCDPESR1",147,0)
 S RCCT=RCCT+1,RCDXM(RCCT)="An "_RCTYPE_" was received at your site "_$$FMTE^XLFDT($$NOW^XLFDT(),2)_" with an invalid tax id.",RCCT=RCCT+1,RCDXM(RCCT)=" From: "_RCINS
"RTN","RCDPESR1",148,0)
 S RCCT=RCCT+1,RCDXM(RCCT)=" The tax id sent was: "_RCTID_" and it was corrected by: "
"RTN","RCDPESR1",149,0)
 S RCCT=RCCT+1,RCDXM(RCCT)=" "_$S(RCCHG="E":"EPHRA",1:"Extracting it based on bill numbers in the ERA")
"RTN","RCDPESR1",150,0)
 S RCCT=RCCT+2,RCDXM(RCCT-1)=" ",RCDXM(RCCT)="If your site continues to receive these bulletins for this payer,",RCCT=RCCT+1,RCDXM(RCCT)="contact the payer and request they correct their tax id for your site"
"RTN","RCDPESR1",151,0)
 ;
"RTN","RCDPESR1",152,0)
 S XMTO("I:G.RCDPE PAYMENTS")="",XMBODY="RCDXM"
"RTN","RCDPESR1",153,0)
 D
"RTN","RCDPESR1",154,0)
 . N DUZ S DUZ=.5,DUZ(0)="@"
"RTN","RCDPESR1",155,0)
 . D SENDMSG^XMXAPI(.5,"EDI LBOX ERRONEOUS TAX ID ON "_RCTYPE,XMBODY,.XMTO,,.XMZ)
"RTN","RCDPESR1",156,0)
 Q
"RTN","RCDPESR1",157,0)
 ;
"RTN","RCDPESR1",158,0)
BILL(X,RCIB) ; Returns ien of bill in X or -1 if not valid
"RTN","RCDPESR1",159,0)
 ; and, if passed by reference, RCIB = 1 if an insurance bill
"RTN","RCDPESR1",160,0)
 N DIC,Y
"RTN","RCDPESR1",161,0)
 S RCIB=0
"RTN","RCDPESR1",162,0)
 I X'["-",$E(X,4)=" " S $E(X,4)="-"
"RTN","RCDPESR1",163,0)
 S DIC="^PRCA(430,",DIC(0)="MZ" D ^DIC
"RTN","RCDPESR1",164,0)
 I Y>0 S RCIB=($P($G(^RCD(340,+$P(Y(0),U,9),0)),U)["DIC(36,")
"RTN","RCDPESR1",165,0)
 Q +Y
"RTN","RCDPESR1",166,0)
 ;
"RTN","RCDPESR1",167,0)
FMDT(X) ; Format date (X) in YYYYMMDD to Fileman format
"RTN","RCDPESR1",168,0)
 I $L(X)=8 D
"RTN","RCDPESR1",169,0)
 . S X=$E(X,1,4)-1700_$E(X,5,8)
"RTN","RCDPESR1",170,0)
 Q X
"RTN","RCDPESR1",171,0)
 ;
"RTN","RCDPESR1",172,0)
ERROR ; Top level error msgs for msgs
"RTN","RCDPESR1",173,0)
 ;;Invalid mailgroup designated for EDI Lockbox errors
"RTN","RCDPESR1",174,0)
 ;;Message header error
"RTN","RCDPESR1",175,0)
 ;
"RTN","RCDPESR1",176,0)
ERROR2 ; Error condition msgs for msgs
"RTN","RCDPESR1",177,0)
 ;;Message code is invalid for EDI Lockbox.
"RTN","RCDPESR1",178,0)
 ;;This message has no ending $ or 99 record.
"RTN","RCDPESR1",179,0)
 ;;Message file problem - no message stored.
"RTN","RCDPESR1",180,0)
 ;;Message file problem - message partially stored.
"RTN","RCDPESR1",181,0)
 ;
"RTN","RCDPESR3")
0^2^B44453222
"RTN","RCDPESR3",1,0)
RCDPESR3 ;ALB/TMK - Server auto-update utilities - EDI Lockbox ;06/06/02
"RTN","RCDPESR3",2,0)
 ;;4.5;Accounts Receivable;**173,214**;Mar 20, 1995
"RTN","RCDPESR3",3,0)
 Q
"RTN","RCDPESR3",4,0)
 ;
"RTN","RCDPESR3",5,0)
EFTIN(RCTXN,RCD,XMZ,RCGBL,RCEFLG) ; Adds a new EFT record to AR file 344.3
"RTN","RCDPESR3",6,0)
 ;  from Lockbox EFT msg
"RTN","RCDPESR3",7,0)
 ; RCTXN = the data on the header record of the message text
"RTN","RCDPESR3",8,0)
 ; RCD = array containing formatted mail message header data
"RTN","RCDPESR3",9,0)
 ; XMZ = the mail message number
"RTN","RCDPESR3",10,0)
 ; RCGBL = the name of the array or global where the message is stored
"RTN","RCDPESR3",11,0)
 ; RCEFLG = error flag returned if passed by reference
"RTN","RCDPESR3",12,0)
 ;
"RTN","RCDPESR3",13,0)
 N CT,RC,RC1,RCLAST,RCEFT,RCTDA,RCERR,RCTYP1,DA,DIK,RCZ,Z,Z0,DLAYGO
"RTN","RCDPESR3",14,0)
 ;
"RTN","RCDPESR3",15,0)
 ; Take data out of mail message
"RTN","RCDPESR3",16,0)
 S (RCEFLG,RCLAST)=0,CT=0,RCTYP1="835EFT"
"RTN","RCDPESR3",17,0)
 F  X XMREC Q:XMER<0  D  Q:RCLAST
"RTN","RCDPESR3",18,0)
 . I +XMRG=99,$P(XMRG,U,2)="$" S RCLAST=1 Q
"RTN","RCDPESR3",19,0)
 . S:XMRG'="" CT=CT+1,@RCGBL@(2,"D",CT)=XMRG
"RTN","RCDPESR3",20,0)
 ;
"RTN","RCDPESR3",21,0)
 I 'RCLAST,'$G(RCERR) K @RCGBL S RCERR=2 ;No $ as last character of msg
"RTN","RCDPESR3",22,0)
 ;
"RTN","RCDPESR3",23,0)
 I $G(RCERR)>0 D  G EFTQ
"RTN","RCDPESR3",24,0)
 . D ERRUPD^RCDPESR1(RCGBL,.RCD,RCTYP1,.RCERR)
"RTN","RCDPESR3",25,0)
 . S RCEFLG=1
"RTN","RCDPESR3",26,0)
 ;
"RTN","RCDPESR3",27,0)
 ; Add top-level entry to file 344.3
"RTN","RCDPESR3",28,0)
 S RCEFT=$$ADDEFT(RCTXN,XMZ,RCGBL,.RCERR)
"RTN","RCDPESR3",29,0)
 ;
"RTN","RCDPESR3",30,0)
 I $G(RCERR) D  G EFTQ ; 'BAD' EFT's
"RTN","RCDPESR3",31,0)
 . D ERRUPD^RCDPESR1(RCGBL,.RCD,RCTYP1,.RCERR)
"RTN","RCDPESR3",32,0)
 . S RCEFLG=1
"RTN","RCDPESR3",33,0)
 ;
"RTN","RCDPESR3",34,0)
 G:'RCEFT EFTQ
"RTN","RCDPESR3",35,0)
 ;
"RTN","RCDPESR3",36,0)
 ; Add the detail data to file 344.31 for this EFT record
"RTN","RCDPESR3",37,0)
 S Z=0 F  S Z=$O(^RCY(344.31,"B",RCEFT,Z)) Q:'Z  S DA=Z,DIK="^RCY(344.31," D ^DIK ; Delete any detail data already there
"RTN","RCDPESR3",38,0)
 ;
"RTN","RCDPESR3",39,0)
 S (RC,RC1,RCZ)=0
"RTN","RCDPESR3",40,0)
 F  S RCZ=$O(@RCGBL@(2,"D",RCZ)) Q:'RCZ  S Z0=$G(^(RCZ)) I Z0'="" D  Q:$G(RCERR)
"RTN","RCDPESR3",41,0)
 . I $P(Z0,U)="01" D  ; Each payer's data
"RTN","RCDPESR3",42,0)
 .. N DA,DIE,DR,X,Y,DO,DD,DIC
"RTN","RCDPESR3",43,0)
 .. S X=RCEFT
"RTN","RCDPESR3",44,0)
 .. S DIC("DR")=".11////0;.04////"_$P(Z0,U,2)_";.08////0"_$S($P(Z0,U,5)'="":";.02////"_$P(Z0,U,5),1:"")_$S($P(Z0,U,6)'="":";.03////"_$P(Z0,U,6),1:"")_";.07////"_$J(+$P(Z0,U,4)/100,"",2)_";.06////"_$S($P(Z0,U,8)'="":1,1:0)
"RTN","RCDPESR3",45,0)
 .. S DIC("DR")=DIC("DR")_";.12///"_$$FDT^RCDPESR9($P(Z0,U,3))_";.13////"_DT_$S($P(Z0,U,7)'="":";.05////"_$P(Z0,U,7),1:"")_$S($P(Z0,U,9)'="":";.15////"_$P(Z0,U,9),1:"")
"RTN","RCDPESR3",46,0)
 .. ;
"RTN","RCDPESR3",47,0)
 .. I $P(Z0,U,8)'="" D  ; tax id error
"RTN","RCDPESR3",48,0)
 ... D TAXERR^RCDPESR1("EFT",$P(Z0,U,5)_"  Payer ID: "_$P(RCTXN,U,6),$P(RCTXN,U,7),$P(RCTXN,U,8)) ; Send bad tax id bulletin
"RTN","RCDPESR3",49,0)
 .. ;
"RTN","RCDPESR3",50,0)
 .. S DIC(0)="L",DIC="^RCY(344.31,",DLAYGO=344.31 D FILE^DICN K DIC,DLAYGO,DO,DD
"RTN","RCDPESR3",51,0)
 .. I Y'>0 D  ; Error filing data
"RTN","RCDPESR3",52,0)
 ... S DIK="^RCY(344.3,",DA=RCEFT D ^DIK
"RTN","RCDPESR3",53,0)
 ... S Z=0 F  S Z=$O(^RCY(344.31,"B",RCEFT,Z)) Q:'Z  S DIK="^RCY(344.31,",DA=Z D ^DIK
"RTN","RCDPESR3",54,0)
 ... S RCEFLG=1,RCERR=3
"RTN","RCDPESR3",55,0)
 ... D ERRUPD^RCDPESR1(RCGBL,.RCD,RCTYP1,RCERR)
"RTN","RCDPESR3",56,0)
 ;
"RTN","RCDPESR3",57,0)
 I '$G(RCEFLG) D
"RTN","RCDPESR3",58,0)
 . S DIE="^RCY(344.3,",DA=RCEFT,DR=".09////"_$$CHKSUM(RCEFT) D ^DIE
"RTN","RCDPESR3",59,0)
 ;
"RTN","RCDPESR3",60,0)
EFTQ ;
"RTN","RCDPESR3",61,0)
 D CLEAN^DILF
"RTN","RCDPESR3",62,0)
 Q
"RTN","RCDPESR3",63,0)
 ;
"RTN","RCDPESR3",64,0)
ADDEFT(RCTXN,RCXMZ,RCGBL,RCERR) ; File EFT TOTAL record in file 344.3
"RTN","RCDPESR3",65,0)
 ; RCTXN = the data on the header record of the message text
"RTN","RCDPESR3",66,0)
 ; RCXMZ = the mail message number
"RTN","RCDPESR3",67,0)
 ; RCGBL = the name of the array or global where the message is stored
"RTN","RCDPESR3",68,0)
 ; Function returns the ien of the total record found/added
"RTN","RCDPESR3",69,0)
 ;    and also returns RCERR if passed by reference
"RTN","RCDPESR3",70,0)
 ;
"RTN","RCDPESR3",71,0)
 N RCTDA,RCRCPT,RCDUP,RCHAC,Z,Z0
"RTN","RCDPESR3",72,0)
 S (RCERR,RCTDA)=""
"RTN","RCDPESR3",73,0)
 ;
"RTN","RCDPESR3",74,0)
 I $E($P(RCTXN,U,6),1,3)'="469",$E($P(RCTXN,U,6),1,3)'="HAC" D  G ADDQ ; Invalid EFT deposit number
"RTN","RCDPESR3",75,0)
 . N RCDXM,RCCT
"RTN","RCDPESR3",76,0)
 . S RCCT=0
"RTN","RCDPESR3",77,0)
 . S RCCT=RCCT+1,RCDXM(RCCT)="This EFT has an invalid deposit number for EDI Lockbox and has been rejected.",RCCT=RCCT+1,RCDXM(RCCT)=" "
"RTN","RCDPESR3",78,0)
 . S RCCT=RCCT+1,RCDXM(RCCT)=" ",RCCT=RCCT+1,RCDXM(RCCT)="Here are the contents of this message:"
"RTN","RCDPESR3",79,0)
 . D DISP("EDI LBOX INVALID EFT DEPOSIT #",RCCT,.RCDXM,RCXMZ)
"RTN","RCDPESR3",80,0)
 ;
"RTN","RCDPESR3",81,0)
 ; Make sure it's not already there or if so, it has no ptr to a deposit
"RTN","RCDPESR3",82,0)
 ; or if a deposit exists, that the deposit does not yet have a receipt
"RTN","RCDPESR3",83,0)
 S RCDUP=0,RCHAC=$E($P(RCTXN,U,6),1,3)="HAC" ; This is a HAC deposit
"RTN","RCDPESR3",84,0)
 I $P(RCTXN,U,6)'="" D
"RTN","RCDPESR3",85,0)
 . S Z=0 ; Lookup deposit by deposit #
"RTN","RCDPESR3",86,0)
 . F  S Z=$O(^RCY(344.3,"C",$P(RCTXN,U,6),Z)) Q:'Z  S Z0=$G(^RCY(344.3,Z,0)) S:'$P(Z0,U,3) RCTDA=Z Q:RCTDA  D  Q
"RTN","RCDPESR3",87,0)
 .. ; Deposit found - find receipt
"RTN","RCDPESR3",88,0)
 .. I $O(^RCY(344,"AD",$P(Z0,U,3),0)) S RCDUP=Z Q
"RTN","RCDPESR3",89,0)
 .. S RCTDA=Z
"RTN","RCDPESR3",90,0)
 ;
"RTN","RCDPESR3",91,0)
 I RCDUP D  ; Send bulletin that duplicate EFT received
"RTN","RCDPESR3",92,0)
 . N RCDXM,RCCT
"RTN","RCDPESR3",93,0)
 . S RCCT=0
"RTN","RCDPESR3",94,0)
 . S RCCT=RCCT+1,RCDXM(RCCT)="This EFT appears to be a duplicate transaction and has been rejected.",RCCT=RCCT+1,RCDXM(RCCT)=" "
"RTN","RCDPESR3",95,0)
 . S RCCT=RCCT+1,RCDXM(RCCT)=" ",RCCT=RCCT+1,RCDXM(RCCT)="Here are the contents of this message:"
"RTN","RCDPESR3",96,0)
 . D DISP("EDI LBOX DUP EFT DEPOSIT RECEIVED",RCCT,.RCDXM,RCXMZ)
"RTN","RCDPESR3",97,0)
 ;
"RTN","RCDPESR3",98,0)
 I 'RCDUP D  ; Add or update the record
"RTN","RCDPESR3",99,0)
 . N RCX,RCDTTM,DIE,DIC,DLAYGO,DD,DA,DO,DR,X,Y,%DT,DINUM
"RTN","RCDPESR3",100,0)
 . ;
"RTN","RCDPESR3",101,0)
 . S X=$$FDT^RCDPESR9($P(RCTXN,U,3))_"@"_$P(RCTXN,U,4)
"RTN","RCDPESR3",102,0)
 . S %DT="XTS" D ^%DT S:Y>0 RCDTTM=Y
"RTN","RCDPESR3",103,0)
 . ;
"RTN","RCDPESR3",104,0)
 . S DIC("DR")=""
"RTN","RCDPESR3",105,0)
 . S DIC("DR")=$S(RCDTTM'="":".02////"_RCDTTM,1:"")
"RTN","RCDPESR3",106,0)
 . S DIC("DR")=DIC("DR")_$S(DIC("DR")'="":";",1:"")_".06////"_$P(RCTXN,U,6)_";.07///"_$$FDT^RCDPESR9($P(RCTXN,U,7))
"RTN","RCDPESR3",107,0)
 . S DIC("DR")=DIC("DR")_";.08////"_$$ZERO^RCDPESR9($P(RCTXN,U,8),1)_";.13////"_$$NOW^XLFDT()_";.05////"_RCXMZ_";.14////0;.12////0"
"RTN","RCDPESR3",108,0)
 . ;
"RTN","RCDPESR3",109,0)
 . I RCTDA D  ; Overwrite the data already there
"RTN","RCDPESR3",110,0)
 .. L +^RCY(344.3,RCTDA):1 I '$T S RCTDA=-1 Q
"RTN","RCDPESR3",111,0)
 .. S DIE="^RCY(344.3,",DA=RCTDA,DR=DIC("DR") K DIC D ^DIE
"RTN","RCDPESR3",112,0)
 .. L -^RCY(344.3,RCTDA)
"RTN","RCDPESR3",113,0)
 . ;
"RTN","RCDPESR3",114,0)
 . I 'RCTDA D
"RTN","RCDPESR3",115,0)
 .. S RCX=+$O(^RCY(344.3," "),-1)
"RTN","RCDPESR3",116,0)
 .. F RCX=RCX+1:1 I '$D(^RCY(344.3,RCX,0)) L +^RCY(344.3,RCX,0):1 I $T S X=RCX Q
"RTN","RCDPESR3",117,0)
 .. S DIC(0)="L",DIC="^RCY(344.3,",DLAYGO=344.3,DINUM=RCX
"RTN","RCDPESR3",118,0)
 .. D FILE^DICN K DO,DD,DLAYGO,DIC,DINUM
"RTN","RCDPESR3",119,0)
 .. L -^RCY(344.3,RCX,0)
"RTN","RCDPESR3",120,0)
 .. S RCTDA=$S(Y<0:"",1:+Y)
"RTN","RCDPESR3",121,0)
 . ;
"RTN","RCDPESR3",122,0)
 . I 'RCTDA S RCERR=3 ; Error in add of EFT record to file 344.3 
"RTN","RCDPESR3",123,0)
 ;
"RTN","RCDPESR3",124,0)
ADDQ Q $S(RCTDA>0:RCTDA,1:"")
"RTN","RCDPESR3",125,0)
 ;
"RTN","RCDPESR3",126,0)
CHKSUM(RCTDA) ; Calc the checksum for EFT record stored in RCTDA in 344.3
"RTN","RCDPESR3",127,0)
 ;
"RTN","RCDPESR3",128,0)
 N RCDPCSUM,RCDPDATA,X,Y,Z,Z0
"RTN","RCDPESR3",129,0)
 ;
"RTN","RCDPESR3",130,0)
 S (RCDPCSUM,X)=0,Z0=$G(^RCY(344.3,RCTDA,0))
"RTN","RCDPESR3",131,0)
 ; Use pcs 1-8, leaving out piece 3
"RTN","RCDPESR3",132,0)
 S RCDPDATA=$P(Z0,U,1,8),$P(RCDPDATA,U,3)=""
"RTN","RCDPESR3",133,0)
 S X=RCDPCSUM_RCDPDATA X $S($G(^%ZOSF("LPC"))'="":^("LPC"),1:"S Y=""""") S RCDPCSUM=Y
"RTN","RCDPESR3",134,0)
 ; Use detail iens and pieces 3,4,7 to complete the checksum
"RTN","RCDPESR3",135,0)
 S Z=0 F  S Z=$O(^RCY(344.31,"B",RCTDA,Z)) Q:'Z  S Z0=$G(^RCY(344.31,Z,0)),RCDPDATA=Z_U_$P(Z0,U,3,4)_U_$P(Z0,U,7),X=RCDPCSUM_RCDPDATA X $S($G(^%ZOSF("LPC"))'="":^("LPC"),1:"S Y=""""") S RCDPCSUM=Y
"RTN","RCDPESR3",136,0)
 Q RCDPCSUM
"RTN","RCDPESR3",137,0)
 ;
"RTN","RCDPESR3",138,0)
DISP(RCTIT,RCCT,RCDXM,RCXMZ) ; Sends bulletin with formatted data from message
"RTN","RCDPESR3",139,0)
 ; RCTIT = title of bulletin
"RTN","RCDPESR3",140,0)
 ; RCCT = # of lines previously populated
"RTN","RCDPESR3",141,0)
 ; RCXDM = array containing the text of the bulletin
"RTN","RCDPESR3",142,0)
 N RC,Z
"RTN","RCDPESR3",143,0)
 K ^TMP("RC1",$J),^TMP("RC",$J),^TMP("RCTEMP",$J)
"RTN","RCDPESR3",144,0)
 S RC=1,^TMP("RCTEMP",$J,RC)=$G(^TMP("RCMSGH",$J,0))
"RTN","RCDPESR3",145,0)
 S Z=0 F  S Z=$O(^TMP("RCMSG",$J,2,"D",Z)) Q:'Z  S RC=RC+1,^TMP("RCTEMP",$J,RC)=$G(^TMP("RCMSG",$J,2,"D",Z))
"RTN","RCDPESR3",146,0)
 D DISP^RCDPESR8("^TMP(""RCTEMP"",$J)","^TMP(""RC1"",$J)",1,"^TMP(""RC"",$J)",75)
"RTN","RCDPESR3",147,0)
 S Z=0 F  S Z=$O(^TMP("RC",$J,Z)) Q:'Z  S RCCT=RCCT+1,RCDXM(RCCT)=$G(^TMP("RC",$J,Z))
"RTN","RCDPESR3",148,0)
 D BULLEFT^RCDPESR0("",RCXMZ,RCTIT,.RCDXM)
"RTN","RCDPESR3",149,0)
 K ^TMP("RC1",$J),^TMP("RC",$J),^TMP("RCTEMP",$J)
"RTN","RCDPESR3",150,0)
 Q
"RTN","RCDPESR3",151,0)
 ;
"RTN","RCDPESR3",152,0)
DUP(RCM,RCIFN,RCAMT,RCAMT1) ; EOB in mail message already stored in 361.1?
"RTN","RCDPESR3",153,0)
 ; RCM = msg # EOB was received in
"RTN","RCDPESR3",154,0)
 ; RCIFN = bill ien
"RTN","RCDPESR3",155,0)
 ; RCAMT = amt pd
"RTN","RCDPESR3",156,0)
 ; RCAMT1 = amt reported billed
"RTN","RCDPESR3",157,0)
 ; Returns 0 if none found, entry #^message checksum on file if found
"RTN","RCDPESR3",158,0)
 N Z,DUP,DUP1
"RTN","RCDPESR3",159,0)
 S (DUP,DUP1,Z)=0
"RTN","RCDPESR3",160,0)
 F  S Z=$O(^IBM(361.1,"AC",RCM,Z)) Q:'Z  I +$G(^IBM(361.1,Z,0))=RCIFN D  Q:DUP
"RTN","RCDPESR3",161,0)
 . I '$P($G(^IBM(361.1,Z,100)),U,5) S DUP1=Z Q  ; Partially filed before
"RTN","RCDPESR3",162,0)
 . I +$G(^IBM(361.1,Z,1))=+RCAMT,+$P($G(^IBM(361.1,1,Z,2)),U,4)=+RCAMT1 S DUP=Z_U_+$P($G(^IBM(361.1,Z,100)),U,5) Q
"RTN","RCDPESR3",163,0)
 I 'DUP,DUP1 S DUP=DUP1_"^0"
"RTN","RCDPESR3",164,0)
 Q DUP
"RTN","RCDPESR3",165,0)
 ;
"RTN","RCDPESR6")
0^3^B25707820
"RTN","RCDPESR6",1,0)
RCDPESR6 ;ALB/TMK - Server auto-update file 344.4 - EDI Lockbox ;10/29/02
"RTN","RCDPESR6",2,0)
 ;;4.5;Accounts Receivable;**173,214**;Mar 20, 1995
"RTN","RCDPESR6",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","RCDPESR6",4,0)
 ;
"RTN","RCDPESR6",5,0)
UPD3444(RCRTOT) ; Add EOB detail to list in 344.41 for file 344.4 entry RCRTOT
"RTN","RCDPESR6",6,0)
 ; If passed by reference, RCRTOT is returned = "" if errors
"RTN","RCDPESR6",7,0)
 ;
"RTN","RCDPESR6",8,0)
 N RC,RCCT,RC1,RC2,RCEOB,DA,DR,DO,DD,DLAYGO,DIC,DIK,X,Y,Z
"RTN","RCDPESR6",9,0)
 S RC=0 F  S RC=$O(^TMP($J,"RCDPEOB",RC)) Q:'RC  S RC1=$G(^(RC)),RC2=$G(^(RC,"EOB")),RCEOB=+RC2 D  Q:'RCRTOT
"RTN","RCDPESR6",10,0)
 . ; Upd 344.41 with reference to this record if it doesn't already exist
"RTN","RCDPESR6",11,0)
 . I RCEOB>0 Q:$D(^RCY(344.4,RCRTOT,1,"AC",RCEOB,RC))
"RTN","RCDPESR6",12,0)
 . I RCEOB'>0,$S($P(RC1,U,2)'="":$D(^RCY(344.4,RCRTOT,1,"AD",$P(RC1,U,2),RC)),1:0) Q
"RTN","RCDPESR6",13,0)
 . S DA(1)=RCRTOT,X=RC,DIC="^RCY(344.4,"_DA(1)_",1,",DIC(0)="L",DLAYGO=344.41
"RTN","RCDPESR6",14,0)
 . S DIC("DR")=$S($G(RCEOB)>0:".02////"_RCEOB,1:".05////"_$P(RC1,U,2)_";.07////1")
"RTN","RCDPESR6",15,0)
 . I $P(RC2,U,2)'="" S DIC("DR")=DIC("DR")_$S($L(DIC("DR")):";",1:"")_".03///"_$P(RC2,U,2) ; amt
"RTN","RCDPESR6",16,0)
 . I $P(RC2,U,3)'="" S DIC("DR")=DIC("DR")_$S($L(DIC("DR")):";",1:"")_".04////"_$P(RC2,U,3) ;ins co
"RTN","RCDPESR6",17,0)
 . I $P(RC2,U,4) S DIC("DR")=DIC("DR")_$S($L(DIC("DR")):";",1:"")_".14////1" ;reversal
"RTN","RCDPESR6",18,0)
 . I $P(RC2,U,5)'="" S DIC("DR")=DIC("DR")_$S($L(DIC("DR")):";",1:"")_".15////^S X=$E($P(RC2,U,5),1,30)" ; Patient name
"RTN","RCDPESR6",19,0)
 . D FILE^DICN K DO,DD,DLAYGO,DIC,DIK
"RTN","RCDPESR6",20,0)
 . S RCCT=+Y
"RTN","RCDPESR6",21,0)
 . I RCCT<0 D  Q
"RTN","RCDPESR6",22,0)
 .. S DA=RCRTOT,DIK="^RCY(344.4," D ^DIK
"RTN","RCDPESR6",23,0)
 .. S RCRTOT=0
"RTN","RCDPESR6",24,0)
 . ; If there is no IB EOB record, store the raw data in 344.411
"RTN","RCDPESR6",25,0)
 . I RC1'>0!(RCEOB'>0) D
"RTN","RCDPESR6",26,0)
 .. N RCDATA,RCC,RCDA
"RTN","RCDPESR6",27,0)
 .. S RCC=2,RCDATA(1)=$G(^TMP($J,"RCDPEOB","HDR"))
"RTN","RCDPESR6",28,0)
 .. S Z=0 F  S Z=$O(^TMP($J,"RCDPEOB",RCCT,Z)) Q:'Z  S RCC=RCC+1,RCDATA(RCC)=$G(^TMP($J,"RCDPEOB",RCCT,Z))
"RTN","RCDPESR6",29,0)
 .. S RCDA(1)=RCRTOT,RCDA=RCCT
"RTN","RCDPESR6",30,0)
 .. D WP^DIE(344.41,$$IENS^DILF(.RCDA),1,"A","RCDATA")
"RTN","RCDPESR6",31,0)
 Q
"RTN","RCDPESR6",32,0)
 ;
"RTN","RCDPESR6",33,0)
ERATOT(RCTDA,RCERR) ; File ERA TOTAL rec in 344.4 from entry RCTDA in 344.5
"RTN","RCDPESR6",34,0)
 ; RCTDA = ien file 344.5
"RTN","RCDPESR6",35,0)
 ; Returns: the ien file 344.4
"RTN","RCDPESR6",36,0)
 ;          RCERR if passed by reference, with error text
"RTN","RCDPESR6",37,0)
 ;          RCERR(1)=duplicated message
"RTN","RCDPESR6",38,0)
 N RCTYPE,RCDA,RCMETH,RCTRACE,RCID,RCDT,RCAMT,RCDUP,RCZ,RCX,RCPAYER,DIE,DIK,DIC,DLAYGO,DD,DO,DR,DA,X,Y,Z0,Z1
"RTN","RCDPESR6",39,0)
 S (RCERR,RCDA)=""
"RTN","RCDPESR6",40,0)
 S RCZ=$G(^RCY(344.5,RCTDA,2,1,0))
"RTN","RCDPESR6",41,0)
 S RCTYPE=$P(RCZ,U),RCTRACE=$P(RCZ,U,8),RCID=$P(RCZ,U,7),RCPAYER=$P(RCZ,U,6),RCMETH=$P(RCZ,U,17)
"RTN","RCDPESR6",42,0)
 ; Need header record as first entry in field
"RTN","RCDPESR6",43,0)
 I RCTYPE'["835ERA" S RCERR="No header record found in message.  An EEOB exception record was created" G ERATOTQ
"RTN","RCDPESR6",44,0)
 ;
"RTN","RCDPESR6",45,0)
 S RCDT=$$FMDT^RCDPESR1($P(RCZ,U,9)),RCAMT=$J(($P(RCZ,U,10)/100),0,2)
"RTN","RCDPESR6",46,0)
 ;Elec ERA's must have a trace # and an ins co id
"RTN","RCDPESR6",47,0)
 I RCTRACE=""!(RCID="") S RCERR="Trace # or ins ID missing on ERA transaction.  An EEOB exception record was created." G ERATOTQ
"RTN","RCDPESR6",48,0)
 ; Make sure it's not already there
"RTN","RCDPESR6",49,0)
 S (RCDUP,Z1)=0
"RTN","RCDPESR6",50,0)
 F  S Z1=$O(^RCY(344.4,"ATRID",RCTRACE,RCID,Z1)) Q:'Z1  S Z0=$G(^RCY(344.4,Z1,0)) I $P(Z0,U,4)=RCDT,+$P(Z0,U,5)=+RCAMT S RCDUP=1 Q
"RTN","RCDPESR6",51,0)
 ;
"RTN","RCDPESR6",52,0)
 I RCDUP S RCERR="DUP",RCERR(1)=$S($P(Z0,U,12)'=$P($G(^RCY(344.5,RCTDA,0)),U,11):$P(Z0,U,12),1:-1) G ERATOTQ
"RTN","RCDPESR6",53,0)
 ;
"RTN","RCDPESR6",54,0)
 S RCX=+$O(^RCY(344.4," "),-1)
"RTN","RCDPESR6",55,0)
 S DIC(0)="L",DIC="^RCY(344.4,",DLAYGO=344.4
"RTN","RCDPESR6",56,0)
 S DIC("DR")=".02////"_RCTRACE_";.03////"_RCID_";.04////"_RCDT_";.05////"_RCAMT_";.06////"_$P(RCZ,U,6)_";.09////0;.12////"_$P($G(^RCY(344.5,RCTDA,0)),U,11)_";.07////"_$$NOW^XLFDT()_";.1////1"
"RTN","RCDPESR6",57,0)
 I RCMETH'="" S DIC("DR")=DIC("DR")_";.15////"_RCMETH
"RTN","RCDPESR6",58,0)
 F RCX=RCX+1:1 L +^RCY(344.4,RCX,0):1 I $T,'$D(^RCY(344.4,RCX,0)) S X=RCX Q
"RTN","RCDPESR6",59,0)
 D FILE^DICN K DO,DLAYGO,DD,DIC
"RTN","RCDPESR6",60,0)
 L -^RCY(344.4,RCX,0)
"RTN","RCDPESR6",61,0)
 S RCDA=$S(Y<0:"",1:+Y)
"RTN","RCDPESR6",62,0)
 I 'RCDA D
"RTN","RCDPESR6",63,0)
 . S RCERR="An error was encountered that prevented the adding of an ERA totals record.  An EEOB exception record was created."
"RTN","RCDPESR6",64,0)
 ;
"RTN","RCDPESR6",65,0)
ERATOTQ Q RCDA
"RTN","RCDPESR6",66,0)
 ;
"RTN","RCDPESR6",67,0)
UPDCON(RCRTOT) ; Add contact information to file 344.4 for an ERA
"RTN","RCDPESR6",68,0)
 N DIE,DA,DR,Z,Q,X,Y
"RTN","RCDPESR6",69,0)
 S Z=$G(^TMP($J,"RCDPEOB","CONTACT"))
"RTN","RCDPESR6",70,0)
 Q:$TR($P(Z,U,3,9),U)=""
"RTN","RCDPESR6",71,0)
 S DA=RCRTOT,DIE="^RCY(344.4,",DR=""
"RTN","RCDPESR6",72,0)
 F Q=3:1:9 S DR=DR_$S(DR'="":";3.0",1:"3.0")_(Q-2)_"///"_$S($P(Z,U,Q)="":"@",1:"/"_$P(Z,U,Q))
"RTN","RCDPESR6",73,0)
 D ^DIE
"RTN","RCDPESR6",74,0)
 Q
"RTN","RCDPESR6",75,0)
 ;
"RTN","RCDPESR6",76,0)
UPDADJ(RCRTOT) ; Add ERA level adj data to file 344.4
"RTN","RCDPESR6",77,0)
 N Z,Z0,DA,DIC,DLAYGO,DR,X,Y,DO,DD
"RTN","RCDPESR6",78,0)
 ; Remove any already there
"RTN","RCDPESR6",79,0)
 S Z=0 F  S Z=$O(^RCY(344.4,RCRTOT,2,Z)) Q:'Z  S DA(1)=RCRTOT,DA=Z D ^DIK
"RTN","RCDPESR6",80,0)
 ;
"RTN","RCDPESR6",81,0)
 S Z=0 F  S Z=$O(^TMP($J,"RCDPEOB","ADJ",Z)) Q:'Z  S Z0=$G(^(Z)) D
"RTN","RCDPESR6",82,0)
 . S DIC(0)="L",X=$P(Z0,U,3)_" ",DA(1)=RCRTOT,DIC="^RCY(344.4,"_DA(1)_",2,",DIC("DR")=$S($P(Z0,U,2)'="":".02////"_$P(Z0,U,2),1:"")
"RTN","RCDPESR6",83,0)
 . S DIC("DR")=DIC("DR")_$S(DIC("DR")'="":";",1:"")_$S($P(Z0,U,4)'="":".03////"_$J(-$P(Z0,U,4)/100,"",2),1:"")
"RTN","RCDPESR6",84,0)
 . S DIC("DR")=DIC("DR")_$S(DIC("DR")'="":";",1:"")_$S($P(Z0,U,5)'="":".04////"_$P(Z0,U,5),1:""),DLAYGO=344.42
"RTN","RCDPESR6",85,0)
 . S:$O(^RCY(344.4,RCRTOT,2,"B",X,0)) X=""""_X_""""
"RTN","RCDPESR6",86,0)
 . D FILE^DICN K DIC,DO,DD
"RTN","RCDPESR6",87,0)
 Q
"RTN","RCDPESR6",88,0)
 ;
"RTN","RCDPESR6",89,0)
DUPREC(RCET,RCCT,RCSTAR,RCFILE,RCALLDUP,RCEOB,RCBILL,RCDUPEOB) ; Overflow from RCDPESR2
"RTN","RCDPESR6",90,0)
 S ^TMP("RCERR1",$J,RCCT)=" ",^TMP("RCERR1",$J,RCCT,1)=RCET_RCCT_RCSTAR
"RTN","RCDPESR6",91,0)
 S ^TMP("RCERR1",$J,RCCT,2)="(Warning): EEOB detail already filed for "_RCBILL_" - "_$S(RCALLDUP:"Duplicate not stored",1:"EEOB updated"),^TMP("RCERR1",$J,RCCT,3)=" " S:RCFILE=5 ^TMP("RCERR1",$J,RCCT,"*")=^TMP("RCERR1",$J,RCCT,2)
"RTN","RCDPESR6",92,0)
 I RCALLDUP S RCEOB="",RCDUPEOB=-1 Q
"RTN","RCDPESR6",93,0)
 S $P(^TMP($J,"RCDPEOB",RCCT,"EOB"),U)=RCEOB
"RTN","RCDPESR6",94,0)
 Q
"RTN","RCDPESR6",95,0)
 ;
"RTN","RCDPURE1")
0^4^B55128405
"RTN","RCDPURE1",1,0)
RCDPURE1 ;WISC/RFJ-process a receipt ;1 Jun 99
"RTN","RCDPURE1",2,0)
 ;;4.5;Accounts Receivable;**114,148,153,169,204,173,214**;Mar 20, 1995
"RTN","RCDPURE1",3,0)
 ;;Per VHA Directive 10-93-142, this routine should not be modified.
"RTN","RCDPURE1",4,0)
 Q
"RTN","RCDPURE1",5,0)
 ;
"RTN","RCDPURE1",6,0)
 ;
"RTN","RCDPURE1",7,0)
PROCESS(RCRECTDA,RCSCREEN) ;  process a receipt, update ar, generate cr/tr documents to fms
"RTN","RCDPURE1",8,0)
 ;  the receipt and deposit must be locked before calling this label
"RTN","RCDPURE1",9,0)
 ;  if $g(rcscreen) = 1 show messages during processing
"RTN","RCDPURE1",10,0)
 ;  if $g(rcscreen) = 2 store messages during processing
"RTN","RCDPURE1",11,0)
 N RCPAYDA,RCDPFPAY,RCERROR,RCMSG,RCEFT,RCERA
"RTN","RCDPURE1",12,0)
 K ^TMP($J,"RCDPEMSG")
"RTN","RCDPURE1",13,0)
 ;
"RTN","RCDPURE1",14,0)
 ;  first mark the receipt as processed/closed to prevent changing the
"RTN","RCDPURE1",15,0)
 ;  data if the receipt does not fully process.  this will lock the
"RTN","RCDPURE1",16,0)
 ;  cancel payment, edit payment, etc. options.  once a receipt is
"RTN","RCDPURE1",17,0)
 ;  processed, even partially, it should not be changed.
"RTN","RCDPURE1",18,0)
 D MARKPROC^RCDPUREC(RCRECTDA,"")
"RTN","RCDPURE1",19,0)
 ;
"RTN","RCDPURE1",20,0)
 ; Special processing needed for EFT-related receipts
"RTN","RCDPURE1",21,0)
 ; RCEFT = 1 if EFT deposit, = 2 if receipt detail transfer, 0 if no EFT
"RTN","RCDPURE1",22,0)
 S RCEFT=+$$EDILB^RCDPEU(RCRECTDA)
"RTN","RCDPURE1",23,0)
 S RCERA=$P($G(^RCY(344,RCRECTDA,0)),U,18)
"RTN","RCDPURE1",24,0)
 ;
"RTN","RCDPURE1",25,0)
 ;  === no payments ===
"RTN","RCDPURE1",26,0)
 ;  if there are no payments for the receipt, quit
"RTN","RCDPURE1",27,0)
 I '$O(^RCY(344,RCRECTDA,1,0)) D  Q
"RTN","RCDPURE1",28,0)
 .   I $G(RCSCREEN) S RCMSG="Receipt does not have any payments and has been marked as processed/closed." D MSG(RCMSG,RCSCREEN,"!!")
"RTN","RCDPURE1",29,0)
 .   I RCERA D UPDERA(RCERA)
"RTN","RCDPURE1",30,0)
 ;
"RTN","RCDPURE1",31,0)
 ;  check to see if the payments have dollar amounts
"RTN","RCDPURE1",32,0)
 S RCPAYDA=0 F  S RCPAYDA=$O(^RCY(344,RCRECTDA,1,RCPAYDA)) Q:'RCPAYDA  I $P($G(^(RCPAYDA,0)),"^",4) S RCDPFPAY=1 Q
"RTN","RCDPURE1",33,0)
 I '$G(RCDPFPAY) D  Q
"RTN","RCDPURE1",34,0)
 .   I $G(RCSCREEN)  S RCMSG="Receipt does not have any payments and has been marked as processed/closed." D MSG(RCMSG,RCSCREEN,"!!")
"RTN","RCDPURE1",35,0)
 .   I RCERA D UPDERA(RCERA)
"RTN","RCDPURE1",36,0)
 ;
"RTN","RCDPURE1",37,0)
 ;  === update AR accounts ===
"RTN","RCDPURE1",38,0)
 I $G(RCSCREEN) S RCMSG="Updating AR accounts..." D MSG(RCMSG,RCSCREEN,"!!")
"RTN","RCDPURE1",39,0)
 ;
"RTN","RCDPURE1",40,0)
 ;  loop payments and apply to account in AR
"RTN","RCDPURE1",41,0)
 S RCPAYDA=0 F  S RCPAYDA=$O(^RCY(344,RCRECTDA,1,RCPAYDA)) Q:'RCPAYDA  D  I RCERROR Q
"RTN","RCDPURE1",42,0)
 .   S RCERROR=$$PROCESS^RCBEPAY(RCRECTDA,RCPAYDA)
"RTN","RCDPURE1",43,0)
 ;
"RTN","RCDPURE1",44,0)
 ;  an error occurred during processing a payment
"RTN","RCDPURE1",45,0)
 I $G(RCERROR) D  Q
"RTN","RCDPURE1",46,0)
 .   I '$G(RCSCREEN) Q
"RTN","RCDPURE1",47,0)
 .   S RCMSG="+-----------------------------------------------------------------------------+" D MSG(RCMSG,RCSCREEN,"!!")
"RTN","RCDPURE1",48,0)
 .   S RCMSG="|  An ERROR has occurred when processing payment "_RCPAYDA_" on receipt "_$P(^RCY(344,RCRECTDA,0),"^")_".",RCMSG=$E(RCMSG_$J("",77),1,77)_"|" D MSG(RCMSG,RCSCREEN,"!")
"RTN","RCDPURE1",49,0)
 .   S RCMSG="|  The error message returned during processing is:",RCMSG=$E(RCMSG_$J("",77),1,77)_"|" D MSG(RCMSG,RCSCREEN,"!")
"RTN","RCDPURE1",50,0)
 .   S RCMSG="|"_$J("",77)_"|" D MSG(RCMSG,RCSCREEN,"!")
"RTN","RCDPURE1",51,0)
 .   S RCMSG=$E("|  "_$P(RCERROR,"^",2)_$J("",77),1,77)_"|" D MSG(RCMSG,RCSCREEN,"!")
"RTN","RCDPURE1",52,0)
 .   S RCMSG="|"_$J("",77)_"|" D MSG(RCMSG,RCSCREEN,"!")
"RTN","RCDPURE1",53,0)
 .   S RCMSG=$E("|  You will need to correct the error before you can completely process the"_$J("",77),1,77)_"|" D MSG(RCMSG,RCSCREEN,"!")
"RTN","RCDPURE1",54,0)
 .   S RCMSG=$E("|  receipt.  Once the receipt is completely processed, the FMS "_$S(RCEFT'=2:"Cash Receipt",1:"'TR'")_$J("",77),1,77)_"|" D MSG(RCMSG,RCSCREEN,"!")
"RTN","RCDPURE1",55,0)
 .   S RCMSG=$E("|  document will be generated."_$J("",77),1,77)_"|" D MSG(RCMSG,RCSCREEN,"!")
"RTN","RCDPURE1",56,0)
 .   S RCMSG="+-----------------------------------------------------------------------------+" D MSG(RCMSG,RCSCREEN,"!")
"RTN","RCDPURE1",57,0)
 ;
"RTN","RCDPURE1",58,0)
 ;  all payments processed correctly
"RTN","RCDPURE1",59,0)
 I RCERA D UPDERA(RCERA)
"RTN","RCDPURE1",60,0)
 I $G(RCSCREEN) D MSG(" Done.",RCSCREEN)
"RTN","RCDPURE1",61,0)
 ;
"RTN","RCDPURE1",62,0)
 ;  if no deposit ticket and not related to EFT or is a HAC payment, do not send to fms
"RTN","RCDPURE1",63,0)
 I '$P(^RCY(344,RCRECTDA,0),"^",6),$S('RCEFT:1,1:$$HACEFT^RCDPEU(+$P(^RCY(344,RCRECTDA,0),U,17))) D  Q
"RTN","RCDPURE1",64,0)
 .   D 215
"RTN","RCDPURE1",65,0)
 .   I $G(RCSCREEN) S RCMSG="Receipt does not have a deposit ticket and will NOT be sent to FMS." D MSG(RCMSG,RCSCREEN,"!!")
"RTN","RCDPURE1",66,0)
 ;
"RTN","RCDPURE1",67,0)
 ;  === send fms cash receipt document ===
"RTN","RCDPURE1",68,0)
 N GECSDATA,FMSDOCNO,RESULT,REFMS
"RTN","RCDPURE1",69,0)
 ;  lookup fms document number to see if the receipt has been
"RTN","RCDPURE1",70,0)
 ;  sent to fms (field 200 in file 344)
"RTN","RCDPURE1",71,0)
 S FMSDOCNO=$P($G(^RCY(344,RCRECTDA,2)),"^")
"RTN","RCDPURE1",72,0)
 ;  if there is an entry, find the code sheet in gcs to rebuild
"RTN","RCDPURE1",73,0)
 ;  gecsdata will be the ien for file 2100.1
"RTN","RCDPURE1",74,0)
 I FMSDOCNO'="" S REFMS=1 N DIQ2 D DATA^GECSSGET(FMSDOCNO,0)
"RTN","RCDPURE1",75,0)
 ;
"RTN","RCDPURE1",76,0)
 I $G(RCSCREEN)&$G(GECSDATA) S RCMSG="Re-Transmitting CR document to FMS... " D MSG(RCMSG,RCSCREEN,"!!")
"RTN","RCDPURE1",77,0)
 I $G(RCSCREEN)&'$G(GECSDATA) S RCMSG="Transmitting CR document to FMS... " D MSG(RCMSG,RCSCREEN,"!!")
"RTN","RCDPURE1",78,0)
 ;
"RTN","RCDPURE1",79,0)
 ;  build and send the tr/cr document to fms
"RTN","RCDPURE1",80,0)
 I RCEFT'=2 D  ; Send CR doc
"RTN","RCDPURE1",81,0)
 . S RESULT=$$BUILDCR^RCXFMSCR(RCRECTDA,+$G(GECSDATA),RCEFT)
"RTN","RCDPURE1",82,0)
 E  D  ; Send TR doc
"RTN","RCDPURE1",83,0)
 . S RESULT=$$GETTR^RCXFMST1(RCRECTDA,+$G(GECSDATA))
"RTN","RCDPURE1",84,0)
 ;  error in building code sheet
"RTN","RCDPURE1",85,0)
 I 'RESULT D:$G(RCSCREEN) MSG("ERROR - "_$P(RESULT,"^",2),RCSCREEN,"!!") Q
"RTN","RCDPURE1",86,0)
 ;
"RTN","RCDPURE1",87,0)
 ;  no document to send
"RTN","RCDPURE1",88,0)
 I $P(RESULT,"^")=-1,$G(RCSCREEN) S RCMSG="NOTE - "_$P(RESULT,"^",2) S $P(RESULT,"^",2)="" D MSG(RCMSG,RCSCREEN,"!!")
"RTN","RCDPURE1",89,0)
 ;  document built and sent
"RTN","RCDPURE1",90,0)
 I $P(RESULT,"^")=1,$G(RCSCREEN) D
"RTN","RCDPURE1",91,0)
 . N Z,DIE,DR,DA
"RTN","RCDPURE1",92,0)
 . D MSG("Done. FMS document number "_$P(RESULT,"^",2),RCSCREEN,"!!")
"RTN","RCDPURE1",93,0)
 . I +$O(^RCY(344.4,"ARCT",RCRECTDA,0)) S DIE="^RCY(344.4,",DR=".14////1",DA=+$O(^RCY(344.4,"ARCT",RCRECTDA,0)) D ^DIE
"RTN","RCDPURE1",94,0)
 . I $P($G(^RCY(344,RCRECTDA,0)),U,17) S Z=$P($G(^RCY(344.31,+$P(^RCY(344,RCRECTDA,0),U,17),0)),U,15) I Z'="" S DA=RCRECTDA,DIE="^RCY(344,",DR=".16////"_Z D ^DIE
"RTN","RCDPURE1",95,0)
 I $G(RCSCREEN) D
"RTN","RCDPURE1",96,0)
 . I '$G(REFMS)&(DT>$$LDATE^RCRJR(DT)) S Y=$E($$FPS^RCAMFN01(DT,1),1,5)_"01" D DD^%DT W !! S RCMSG="   * * * * Transmission will be held until "_Y_" * * * *" D MSG(RCMSG,RCSCREEN,"!!")
"RTN","RCDPURE1",97,0)
 ;
"RTN","RCDPURE1",98,0)
 ;
"RTN","RCDPURE1",99,0)
 ;  store the fms document number (receipt already marked processed/
"RTN","RCDPURE1",100,0)
 ;  closed at the top of the routine just before posting the dollars.
"RTN","RCDPURE1",101,0)
 D MARKPROC^RCDPUREC(RCRECTDA,$P(RESULT,"^",2))
"RTN","RCDPURE1",102,0)
 I RCEFT=2 D MSG("No 215 report generated for this receipt",RCSCREEN,"!!") G Q215
"RTN","RCDPURE1",103,0)
 ;
"RTN","RCDPURE1",104,0)
 ;
"RTN","RCDPURE1",105,0)
215 ;  === print 215 report ===
"RTN","RCDPURE1",106,0)
 I $G(RCSCREEN) D MSG("Queuing 215 report...",RCSCREEN,"!!")
"RTN","RCDPURE1",107,0)
 N DEVICE
"RTN","RCDPURE1",108,0)
 S DEVICE=$G(^DISV(DUZ,"RCDPRPLM","215REPORT"))
"RTN","RCDPURE1",109,0)
 I DEVICE="" D:$G(RCSCREEN) MSG(" Use Customize Option to set up the default printer.",RCSCREEN) Q
"RTN","RCDPURE1",110,0)
 ;
"RTN","RCDPURE1",111,0)
 S ZTIO=DEVICE,ZTDTH=$H,ZTRTN="DQ^RCDPR215",ZTSAVE("RECEIPDA")=RCRECTDA,ZTSAVE("RCTYPE")="A"
"RTN","RCDPURE1",112,0)
 D ^%ZTLOAD,^%ZISC
"RTN","RCDPURE1",113,0)
Q215 I $G(RCSCREEN) D MSG(" Done.",RCSCREEN)
"RTN","RCDPURE1",114,0)
 Q
"RTN","RCDPURE1",115,0)
 ;
"RTN","RCDPURE1",116,0)
UPDERA(RCERA) ; Update detail posted status for ERA entry RCERA
"RTN","RCDPURE1",117,0)
 ;
"RTN","RCDPURE1",118,0)
 N DA,DIE,DR
"RTN","RCDPURE1",119,0)
 S DA=+$G(RCERA),DR=".14////1",DIE="^RCY(344.4," D:DA ^DIE
"RTN","RCDPURE1",120,0)
 Q
"RTN","RCDPURE1",121,0)
 ;
"RTN","RCDPURE1",122,0)
MSG(RCMSG,RCSCREEN,PRELINE,POSTLINE) ; Write message or set into msg array
"RTN","RCDPURE1",123,0)
 ; RCMSG = text to write  RCSCREEN = screen flag
"RTN","RCDPURE1",124,0)
 ; PRELINE = the line feeds to print before the text
"RTN","RCDPURE1",125,0)
 ; POSTLINE = the line feeds to print after the text
"RTN","RCDPURE1",126,0)
 Q:'RCSCREEN
"RTN","RCDPURE1",127,0)
 N RCPRE,RCPOST,Z
"RTN","RCDPURE1",128,0)
 S RCPRE=$L($G(PRELINE),"!")-1,RCPOST=$L($G(POSTLINE),"!")-1
"RTN","RCDPURE1",129,0)
 I RCSCREEN=1 D  G MSGQ
"RTN","RCDPURE1",130,0)
 . F Z=1:1:RCPRE W !
"RTN","RCDPURE1",131,0)
 . W RCMSG
"RTN","RCDPURE1",132,0)
 . F Z=1:1:RCPOST W !
"RTN","RCDPURE1",133,0)
 F Z=1:1:RCPRE S ^TMP($J,"RCDPEMSG",+$O(^TMP("RCDPEMSG",""),-1)+1)=""
"RTN","RCDPURE1",134,0)
 S ^TMP($J,"RCDPEMSG",+$O(^TMP("RCDPEMSG",""),-1)+1)=RCMSG
"RTN","RCDPURE1",135,0)
 F Z=1:1:RCPOST S ^TMP($J,"RCDPEMSG",+$O(^TMP("RCDPEMSG",""),-1)+1)=""
"RTN","RCDPURE1",136,0)
MSGQ Q
"RTN","RCDPURE1",137,0)
 ;
"RTN","RCDPURE1",138,0)
EDIT4(DA,DR,RCDR1,RCDR2,RCDR3) ; Modify DR string for type of payment edit
"RTN","RCDPURE1",139,0)
 ;   for EDI Lockbox
"RTN","RCDPURE1",140,0)
 ; Input: DA,DR   Output: RCDR1,RCDR2,RCDR3
"RTN","RCDPURE1",141,0)
 ; If type unchanged, or neither old/new are EDI Lockbox, no chk needed
"RTN","RCDPURE1",142,0)
 ; If old type is EDI Lockbox and scratch pad exists, no change allowed
"RTN","RCDPURE1",143,0)
 ; If changed to EDI Lockbox and detail already exists, no chg allowed
"RTN","RCDPURE1",144,0)
 ; If changed to EDI Lockbox, ask for related EFT
"RTN","RCDPURE1",145,0)
 N Z,Z0,RCSTRT,RCLST,RCDR,RCOE,RCNE,RCNO,RCM,RCM1,RCM2,RCM3,RCO4,RCN4,RCP,DIPA
"RTN","RCDPURE1",146,0)
 S (RCDR1,RCDR2,RCDR3)=""
"RTN","RCDPURE1",147,0)
 ;
"RTN","RCDPURE1",148,0)
 S RCP=10 F Z=2:1 Q:DR'[("@"_RCP)&(DR'[("@"_(RCP+1)))&(DR'[("@"_(RCP+2)))&(DR'[("@"_(RCP+3)))&(DR'[("@"_(RCP+4)))  S RCP=RCP*Z
"RTN","RCDPURE1",149,0)
 ;
"RTN","RCDPURE1",150,0)
 S Z=$L(DR,".04;"),RCSTRT=1,RCLST=Z
"RTN","RCDPURE1",151,0)
 I Z>2 D  ; Find .04, not n.04
"RTN","RCDPURE1",152,0)
 . F  S Z0=$P(DR,".04;",RCSTRT) Q:Z0=""!'$E(Z0,$L(Z0))  S RCSTRT=RCSTRT+1
"RTN","RCDPURE1",153,0)
 ;
"RTN","RCDPURE1",154,0)
 ; If unchanged/changed from/to other than EDI Lockbox, jump over edits
"RTN","RCDPURE1",155,0)
 S RCDR1="S RCP="_RCP_" D SETV^RCDPURE1;"_$P(DR,".04;",1,RCSTRT)
"RTN","RCDPURE1",156,0)
 S RCDR2="@"_RCP_";.04;S RCNO=0,RCN4=X D TYP^RCDPUREC(.Y);.17////^S X=RCNE;S Y=""@"_(RCP+2)_""""
"RTN","RCDPURE1",157,0)
 ; Reset field .04 and .17 if not a valid type change
"RTN","RCDPURE1",158,0)
 S RCDR2=RCDR2_";@"_(RCP+1)_";.04////^S X=RCO4;I RCOE="""" S Y=""@"_(RCP+3)_""";.17////^S X=RCOE;@"_(RCP+3)_";W !,*7,$S(RCO4=14:$S('RCNO:RCM1,1:RCM2),1:RCM) S Y=""@"_RCP_""";@"_(RCP+2)
"RTN","RCDPURE1",159,0)
 S RCDR3=$P(DR,".04;",RCSTRT+1,RCLST)
"RTN","RCDPURE1",160,0)
 Q
"RTN","RCDPURE1",161,0)
 ;
"RTN","RCDPURE1",162,0)
SETV ; Set up variables needed to edit change of receipt type
"RTN","RCDPURE1",163,0)
 S DIPA("RCPT")=$G(^RCY(344,DA,0)),RCO4=$P(DIPA("RCPT"),U,4),RCOE=$P(DIPA("RCPT"),U,17)
"RTN","RCDPURE1",164,0)
 S RCM="EDI Lockbox payment type is invalid for this receipt",RCM1="Payment type can't be changed once detail has been loaded from the ERA",RCM2="Must have an EFT for an EFT Lockbox payment type"
"RTN","RCDPURE1",165,0)
 S RCM3=">>If receipt is for an ERA and a paper check, select the ERA now"
"RTN","RCDPURE1",166,0)
 Q
"RTN","RCDPURE1",167,0)
 ;
"RTN","RCDPURE1",168,0)
WL(DA) ; Function returns 0 if the worklist did not create the receipt
"RTN","RCDPURE1",169,0)
 ;  or the ien of the worklist entry if it did (344.4 and 344.49 are DINUMED)
"RTN","RCDPURE1",170,0)
 N Z
"RTN","RCDPURE1",171,0)
 S Z=+$O(^RCY(344.4,"AREC",DA,0))
"RTN","RCDPURE1",172,0)
 Q Z
"RTN","RCDPURE1",173,0)
 ;
"RTN","RCDPURE1",174,0)
HAC(RC) ; Returns 1 if the receipt in RC is related to a HAC EFT
"RTN","RCDPURE1",175,0)
 N Z,HAC
"RTN","RCDPURE1",176,0)
 S HAC=0
"RTN","RCDPURE1",177,0)
 ; ERA related to an EFT detail record
"RTN","RCDPURE1",178,0)
 S Z=+$G(^RCY(344.31,+$P($G(^RCY(344,RC,0)),U,17),0))
"RTN","RCDPURE1",179,0)
 ; Deposit # in EFT transmission starts with HAC
"RTN","RCDPURE1",180,0)
 I Z S Z=$P($G(^RCY(344.3,+Z,0)),U,6) I $E(Z,1,3)="HAC" S HAC=1
"RTN","RCDPURE1",181,0)
 Q HAC
"RTN","RCDPURE1",182,0)
 ;
"VER")
8.0^22
"^DD",344.3,344.3,.01,0)
NUMBER^RNJ10,0X^^0;1^K:+X'=X!(X>9999999999)!(X<1)!(X?.E1"."1N.N) X I $D(X) S DINUM=X
"^DD",344.3,344.3,.01,1,0)
^.1
"^DD",344.3,344.3,.01,1,1,0)
344.3^B
"^DD",344.3,344.3,.01,1,1,1)
S ^RCY(344.3,"B",$E(X,1,30),DA)=""
"^DD",344.3,344.3,.01,1,1,2)
K ^RCY(344.3,"B",$E(X,1,30),DA)
"^DD",344.3,344.3,.01,1,2,0)
344.3^ALOCK^MUMPS
"^DD",344.3,344.3,.01,1,2,1)
I '$D(^RCY(344.3,"ALOCK")) S ^RCY(344.3,"ALOCK")=""
"^DD",344.3,344.3,.01,1,2,2)
Q
"^DD",344.3,344.3,.01,1,2,3)
Do not delete
"^DD",344.3,344.3,.01,1,2,"%D",0)
^^3^3^3021106^
"^DD",344.3,344.3,.01,1,2,"%D",1,0)
This xref is set to allow a lock to be placed on the file so only one job
"^DD",344.3,344.3,.01,1,2,"%D",2,0)
that tries to match EFTs to ERAs is run at a time.
"^DD",344.3,344.3,.01,1,2,"%D",3,0)
This xref is set the first time an entry is added to the file.
"^DD",344.3,344.3,.01,1,2,"DT")
3021106
"^DD",344.3,344.3,.01,3)
Type a Number between 1 and 9999999999, 0 Decimal Digits
"^DD",344.3,344.3,.01,21,0)
^.001^3^3^3021206^^^^
"^DD",344.3,344.3,.01,21,1,0)
This field contains a sequential number generated at the time a record
"^DD",344.3,344.3,.01,21,2,0)
is stored in the file.  It only serves to create an entry in the file
"^DD",344.3,344.3,.01,21,3,0)
and has no other special meaning.
"^DD",344.3,344.3,.01,"DT")
3040120
**END**
**END**
